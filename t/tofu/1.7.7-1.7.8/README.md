# Comparing `tmp/tofu-1.7.7.tar.gz` & `tmp/tofu-1.7.8.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "tofu-1.7.7.tar", last modified: Tue Feb 27 17:24:10 2024, max compression
+gzip compressed data, was "tofu-1.7.8.tar", last modified: Fri May 31 16:09:39 2024, max compression
```

## Comparing `tofu-1.7.7.tar` & `tofu-1.7.8.tar`

### file list

```diff
@@ -1,628 +1,633 @@
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-02-27 17:24:10.263434 tofu-1.7.7/
--rw-r--r--   0 runner    (1001) docker     (127)     1071 2024-02-27 17:23:41.000000 tofu-1.7.7/LICENSE.txt
--rw-r--r--   0 runner    (1001) docker     (127)      665 2024-02-27 17:23:41.000000 tofu-1.7.7/MANIFEST.in
--rw-r--r--   0 runner    (1001) docker     (127)    12222 2024-02-27 17:24:10.263434 tofu-1.7.7/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)    11453 2024-02-27 17:23:41.000000 tofu-1.7.7/README.md
--rw-r--r--   0 runner    (1001) docker     (127)      966 2024-02-27 17:23:41.000000 tofu-1.7.7/_updateversion.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-02-27 17:24:10.139434 tofu-1.7.7/inputs_temp/
--rw-r--r--   0 runner    (1001) docker     (127)   119375 2024-02-27 17:23:42.000000 tofu-1.7.7/inputs_temp/XICS_allshots_C34.py
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-02-27 17:23:43.000000 tofu-1.7.7/inputs_temp/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    37619 2024-02-27 17:23:43.000000 tofu-1.7.7/inputs_temp/dlines.py
--rw-r--r--   0 runner    (1001) docker     (127)       97 2024-02-27 17:23:43.000000 tofu-1.7.7/pyproject.toml
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-02-27 17:24:10.143434 tofu-1.7.7/scripts/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-02-27 17:23:43.000000 tofu-1.7.7/scripts/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    19395 2024-02-27 17:23:43.000000 tofu-1.7.7/scripts/_dparser.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     3731 2024-02-27 17:23:43.000000 tofu-1.7.7/scripts/tofu_bash.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     2794 2024-02-27 17:23:43.000000 tofu-1.7.7/scripts/tofucustom.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     3643 2024-02-27 17:23:43.000000 tofu-1.7.7/scripts/tofuversion.py
--rw-r--r--   0 runner    (1001) docker     (127)       38 2024-02-27 17:24:10.263434 tofu-1.7.7/setup.cfg
--rw-r--r--   0 runner    (1001) docker     (127)    13035 2024-02-27 17:23:43.000000 tofu-1.7.7/setup.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-02-27 17:24:10.143434 tofu-1.7.7/tofu/
--rw-r--r--   0 runner    (1001) docker     (127)     3486 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     1513 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/_physics.py
--rw-r--r--   0 runner    (1001) docker     (127)    12571 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/_plot.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-02-27 17:24:10.143434 tofu-1.7.7/tofu/benchmarks/
--rw-r--r--   0 runner    (1001) docker     (127)      306 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/benchmarks/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     5642 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/benchmarks/benchmarks_00_Geometry_peakmem.py
--rw-r--r--   0 runner    (1001) docker     (127)     5615 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/benchmarks/benchmarks_00_Geometry_time.py
--rw-r--r--   0 runner    (1001) docker     (127)     3032 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/benchmarks/benchmarks_01_Mesh2D_peakmem.py
--rw-r--r--   0 runner    (1001) docker     (127)     3023 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/benchmarks/benchmarks_01_Mesh2D_time.py
--rw-r--r--   0 runner    (1001) docker     (127)     6733 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/benchmarks/benchmarks_02_spectralfit_peakmem.py
--rw-r--r--   0 runner    (1001) docker     (127)     6724 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/benchmarks/benchmarks_02_spectralfit_time.py
--rw-r--r--   0 runner    (1001) docker     (127)     3385 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/benchmarks/benchmarks_03_solidangles.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-02-27 17:24:10.159434 tofu-1.7.7/tofu/data/
--rw-r--r--   0 runner    (1001) docker     (127)    48563 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_DataCollection_check_inputs.py
--rw-r--r--   0 runner    (1001) docker     (127)       86 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_DataCollection_class.py
--rw-r--r--   0 runner    (1001) docker     (127)    38199 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_DataCollection_class0_Base.py
--rw-r--r--   0 runner    (1001) docker     (127)    40664 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_DataCollection_class1_interactivity.py
--rw-r--r--   0 runner    (1001) docker     (127)    13459 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_DataCollection_comp.py
--rw-r--r--   0 runner    (1001) docker     (127)     4798 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_DataCollection_interactivity.py
--rw-r--r--   0 runner    (1001) docker     (127)    40405 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_DataCollection_plot_as_array.py
--rw-r--r--   0 runner    (1001) docker     (127)    10419 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_DataCollection_plot_misc.py
--rw-r--r--   0 runner    (1001) docker     (127)     3114 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_DataCollection_plot_text.py
--rw-r--r--   0 runner    (1001) docker     (127)      414 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      679 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class00_Config.py
--rw-r--r--   0 runner    (1001) docker     (127)     8674 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class01_Plasma2D.py
--rw-r--r--   0 runner    (1001) docker     (127)      945 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class01_compute.py
--rw-r--r--   0 runner    (1001) docker     (127)     8832 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class01_eqdsk.py
--rw-r--r--   0 runner    (1001) docker     (127)    12471 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class02_Rays.py
--rw-r--r--   0 runner    (1001) docker     (127)    28598 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class02_save2stp.py
--rw-r--r--   0 runner    (1001) docker     (127)     2994 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class03_Aperture.py
--rw-r--r--   0 runner    (1001) docker     (127)     2222 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class04_Filter.py
--rw-r--r--   0 runner    (1001) docker     (127)     7856 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class05_Crystal.py
--rw-r--r--   0 runner    (1001) docker     (127)     5263 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class05_legacy.py
--rw-r--r--   0 runner    (1001) docker     (127)     2376 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class06_Grating.py
--rw-r--r--   0 runner    (1001) docker     (127)     1483 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class06_compute.py
--rw-r--r--   0 runner    (1001) docker     (127)     9512 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class07_Camera.py
--rw-r--r--   0 runner    (1001) docker     (127)     4951 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class07_legacy.py
--rw-r--r--   0 runner    (1001) docker     (127)    34768 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class08_Diagnostic.py
--rw-r--r--   0 runner    (1001) docker     (127)    27872 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class08_save2stp.py
--rw-r--r--   0 runner    (1001) docker     (127)     3240 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class09_GeometryMatrix.py
--rw-r--r--   0 runner    (1001) docker     (127)    10207 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class09_compute_broadband.py
--rw-r--r--   0 runner    (1001) docker     (127)     4658 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class10_Inversion.py
--rw-r--r--   0 runner    (1001) docker     (127)    26452 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class10_algos.py
--rw-r--r--   0 runner    (1001) docker     (127)    35239 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class10_checks.py
--rw-r--r--   0 runner    (1001) docker     (127)    36571 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class10_compute.py
--rw-r--r--   0 runner    (1001) docker     (127)    23823 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class10_plot.py
--rw-r--r--   0 runner    (1001) docker     (127)     5543 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class10_refs.py
--rw-r--r--   0 runner    (1001) docker     (127)    24921 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class2_check.py
--rw-r--r--   0 runner    (1001) docker     (127)    24365 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class2_compute.py
--rw-r--r--   0 runner    (1001) docker     (127)     5653 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class2_plot.py
--rw-r--r--   0 runner    (1001) docker     (127)    21556 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class2_sinogram.py
--rw-r--r--   0 runner    (1001) docker     (127)     7106 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class3_check.py
--rw-r--r--   0 runner    (1001) docker     (127)     4038 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class4_check.py
--rw-r--r--   0 runner    (1001) docker     (127)    12799 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class5_check.py
--rw-r--r--   0 runner    (1001) docker     (127)    20261 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class5_compute.py
--rw-r--r--   0 runner    (1001) docker     (127)     3625 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class5_coordinates.py
--rw-r--r--   0 runner    (1001) docker     (127)     6393 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class5_plot.py
--rw-r--r--   0 runner    (1001) docker     (127)     5260 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class5_projections.py
--rw-r--r--   0 runner    (1001) docker     (127)    34012 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class5_reflections_pts2pt.py
--rw-r--r--   0 runner    (1001) docker     (127)    23746 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class5_reflections_ptsvect.py
--rw-r--r--   0 runner    (1001) docker     (127)    26074 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class7_check.py
--rw-r--r--   0 runner    (1001) docker     (127)    11080 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class7_compute.py
--rw-r--r--   0 runner    (1001) docker     (127)    19103 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class8_check.py
--rw-r--r--   0 runner    (1001) docker     (127)    53679 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class8_compute.py
--rw-r--r--   0 runner    (1001) docker     (127)    39439 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class8_compute_signal.py
--rw-r--r--   0 runner    (1001) docker     (127)     9846 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class8_compute_signal_moments.py
--rw-r--r--   0 runner    (1001) docker     (127)    30866 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class8_equivalent_apertures.py
--rw-r--r--   0 runner    (1001) docker     (127)    33697 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class8_etendue_los.py
--rw-r--r--   0 runner    (1001) docker     (127)    16608 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class8_los_angles.py
--rw-r--r--   0 runner    (1001) docker     (127)    20790 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class8_los_data.py
--rw-r--r--   0 runner    (1001) docker     (127)    12110 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class8_move.py
--rw-r--r--   0 runner    (1001) docker     (127)    36679 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class8_plane_perp_to_los.py
--rw-r--r--   0 runner    (1001) docker     (127)    33260 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class8_plot.py
--rw-r--r--   0 runner    (1001) docker     (127)     9096 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class8_plot_coverage.py
--rw-r--r--   0 runner    (1001) docker     (127)    27301 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class8_plot_vos.py
--rw-r--r--   0 runner    (1001) docker     (127)    26808 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class8_plot_vos_spectro.py
--rw-r--r--   0 runner    (1001) docker     (127)    45196 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class8_reverse_ray_tracing.py
--rw-r--r--   0 runner    (1001) docker     (127)    26128 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class8_vos.py
--rw-r--r--   0 runner    (1001) docker     (127)    28491 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class8_vos_broadband.py
--rw-r--r--   0 runner    (1001) docker     (127)    24963 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class8_vos_spectro.py
--rw-r--r--   0 runner    (1001) docker     (127)    26686 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class8_vos_spectro_nobin_at_lamb.py
--rw-r--r--   0 runner    (1001) docker     (127)     9218 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class8_vos_utilities.py
--rw-r--r--   0 runner    (1001) docker     (127)    13035 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class9_compute.py
--rw-r--r--   0 runner    (1001) docker     (127)    16432 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_class9_plot.py
--rw-r--r--   0 runner    (1001) docker     (127)    26948 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_comp.py
--rw-r--r--   0 runner    (1001) docker     (127)   178556 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_core.py
--rw-r--r--   0 runner    (1001) docker     (127)    11590 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_core_plot.py
--rw-r--r--   0 runner    (1001) docker     (127)      357 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_def.py
--rw-r--r--   0 runner    (1001) docker     (127)     1732 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_generic_check.py
--rw-r--r--   0 runner    (1001) docker     (127)    11367 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_generic_plot.py
--rw-r--r--   0 runner    (1001) docker     (127)   145086 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_plot.py
--rw-r--r--   0 runner    (1001) docker     (127)      958 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_saveload.py
--rw-r--r--   0 runner    (1001) docker     (127)     9349 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_spectrallines_checks.py
--rw-r--r--   0 runner    (1001) docker     (127)    18874 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_spectrallines_class.py
--rw-r--r--   0 runner    (1001) docker     (127)    14730 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_spectrallines_compute.py
--rw-r--r--   0 runner    (1001) docker     (127)    14023 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_spectrallines_plot.py
--rw-r--r--   0 runner    (1001) docker     (127)     4802 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_spectralunits.py
--rw-r--r--   0 runner    (1001) docker     (127)    12968 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_utils_bsplines.py
--rw-r--r--   0 runner    (1001) docker     (127)    11627 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/data/_utils_surface3d.py
--rw-r--r--   0 runner    (1001) docker     (127)    58540 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/defaults.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-02-27 17:24:10.159434 tofu-1.7.7/tofu/dumpro/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/dumpro/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)       56 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/dumpro/_comp.py
--rw-r--r--   0 runner    (1001) docker     (127)       50 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/dumpro/_comp_clusters.py
--rw-r--r--   0 runner    (1001) docker     (127)      553 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/dumpro/_core.py
--rw-r--r--   0 runner    (1001) docker     (127)       21 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/dumpro/_def.py
--rw-r--r--   0 runner    (1001) docker     (127)       31 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/dumpro/_draft.py
--rw-r--r--   0 runner    (1001) docker     (127)       58 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/dumpro/_plot.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-02-27 17:24:10.159434 tofu-1.7.7/tofu/dust/
--rw-r--r--   0 runner    (1001) docker     (127)      123 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/dust/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     1950 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/dust/_comp.py
--rw-r--r--   0 runner    (1001) docker     (127)     5472 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/dust/_core.py
--rw-r--r--   0 runner    (1001) docker     (127)      906 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/dust/_plot.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-02-27 17:24:10.159434 tofu-1.7.7/tofu/entrypoints/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/entrypoints/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)      913 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/entrypoints/_def.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     3237 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/entrypoints/tofucalc.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     3096 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/entrypoints/tofuplot.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-02-27 17:24:10.163434 tofu-1.7.7/tofu/geom/
--rw-r--r--   0 runner    (1001) docker     (127)   259307 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/_GG.pyx
--rw-r--r--   0 runner    (1001) docker     (127)      508 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4611 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/_basic_geom_tools.pxd
--rw-r--r--   0 runner    (1001) docker     (127)    13775 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/_basic_geom_tools.pyx
--rw-r--r--   0 runner    (1001) docker     (127)      502 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/_chained_list.pxd
--rw-r--r--   0 runner    (1001) docker     (127)     2449 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/_chained_list.pyx
--rw-r--r--   0 runner    (1001) docker     (127)    24082 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/_check_optics.py
--rw-r--r--   0 runner    (1001) docker     (127)    45525 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/_comp.py
--rw-r--r--   0 runner    (1001) docker     (127)    40687 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/_comp_optics.py
--rw-r--r--   0 runner    (1001) docker     (127)    44245 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/_comp_solidangles.py
--rw-r--r--   0 runner    (1001) docker     (127)   290682 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/_core.py
--rw-r--r--   0 runner    (1001) docker     (127)   148251 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/_core_optics.py
--rw-r--r--   0 runner    (1001) docker     (127)    25215 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/_def.py
--rw-r--r--   0 runner    (1001) docker     (127)    11128 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/_def_config.py
--rw-r--r--   0 runner    (1001) docker     (127)     7563 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/_distance_tools.pxd
--rw-r--r--   0 runner    (1001) docker     (127)    62742 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/_distance_tools.pyx
--rw-r--r--   0 runner    (1001) docker     (127)    28576 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/_etendue.py
--rw-r--r--   0 runner    (1001) docker     (127)     2167 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/_openmp_tools.pyx
--rw-r--r--   0 runner    (1001) docker     (127)    69100 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/_plot.py
--rw-r--r--   0 runner    (1001) docker     (127)    62488 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/_plot_optics.py
--rw-r--r--   0 runner    (1001) docker     (127)    18069 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/_raytracing_tools.pxd
--rw-r--r--   0 runner    (1001) docker     (127)   118812 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/_raytracing_tools.pyx
--rw-r--r--   0 runner    (1001) docker     (127)    14136 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/_sampling_tools.pxd
--rw-r--r--   0 runner    (1001) docker     (127)   115724 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/_sampling_tools.pyx
--rw-r--r--   0 runner    (1001) docker     (127)      371 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/_sorted_set.pxd
--rw-r--r--   0 runner    (1001) docker     (127)     2262 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/_sorted_set.pyx
--rw-r--r--   0 runner    (1001) docker     (127)     4156 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/_vignetting_tools.pxd
--rw-r--r--   0 runner    (1001) docker     (127)    26377 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/_vignetting_tools.pyx
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-02-27 17:24:10.203434 tofu-1.7.7/tofu/geom/inputs/
--rw-r--r--   0 runner    (1001) docker     (127)     1609 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/AUG_V0_from_V1.py
--rw-r--r--   0 runner    (1001) docker     (127)      296 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilCS_ExpITER_CS1L.txt
--rw-r--r--   0 runner    (1001) docker     (127)      292 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilCS_ExpITER_CS1U.txt
--rw-r--r--   0 runner    (1001) docker     (127)      296 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilCS_ExpITER_CS2L.txt
--rw-r--r--   0 runner    (1001) docker     (127)      292 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilCS_ExpITER_CS2U.txt
--rw-r--r--   0 runner    (1001) docker     (127)      296 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilCS_ExpITER_CS3L.txt
--rw-r--r--   0 runner    (1001) docker     (127)      292 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilCS_ExpITER_CS3U.txt
--rw-r--r--   0 runner    (1001) docker     (127)      301 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilCS_ExpSPARC_CS1lower.txt
--rw-r--r--   0 runner    (1001) docker     (127)      297 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilCS_ExpSPARC_CS1upper.txt
--rw-r--r--   0 runner    (1001) docker     (127)      301 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilCS_ExpSPARC_CS2lower.txt
--rw-r--r--   0 runner    (1001) docker     (127)      297 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilCS_ExpSPARC_CS2upper.txt
--rw-r--r--   0 runner    (1001) docker     (127)      301 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilCS_ExpSPARC_CS3lower.txt
--rw-r--r--   0 runner    (1001) docker     (127)      297 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilCS_ExpSPARC_CS3upper.txt
--rw-r--r--   0 runner    (1001) docker     (127)      291 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpITER_PF1.txt
--rw-r--r--   0 runner    (1001) docker     (127)      291 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpITER_PF2.txt
--rw-r--r--   0 runner    (1001) docker     (127)      291 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpITER_PF3.txt
--rw-r--r--   0 runner    (1001) docker     (127)      295 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpITER_PF4.txt
--rw-r--r--   0 runner    (1001) docker     (127)      295 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpITER_PF5.txt
--rw-r--r--   0 runner    (1001) docker     (127)      295 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpITER_PF6.txt
--rw-r--r--   0 runner    (1001) docker     (127)      303 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_CentralSolenoid.txt
--rw-r--r--   0 runner    (1001) docker     (127)      296 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil01.txt
--rw-r--r--   0 runner    (1001) docker     (127)      346 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil02.txt
--rw-r--r--   0 runner    (1001) docker     (127)      296 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil03.txt
--rw-r--r--   0 runner    (1001) docker     (127)      296 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil04.txt
--rw-r--r--   0 runner    (1001) docker     (127)      396 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil05.txt
--rw-r--r--   0 runner    (1001) docker     (127)      396 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil06.txt
--rw-r--r--   0 runner    (1001) docker     (127)      396 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil07.txt
--rw-r--r--   0 runner    (1001) docker     (127)      296 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil08.txt
--rw-r--r--   0 runner    (1001) docker     (127)      296 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil09.txt
--rw-r--r--   0 runner    (1001) docker     (127)      296 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil10.txt
--rw-r--r--   0 runner    (1001) docker     (127)      296 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil11.txt
--rw-r--r--   0 runner    (1001) docker     (127)      296 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil12.txt
--rw-r--r--   0 runner    (1001) docker     (127)      296 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil13.txt
--rw-r--r--   0 runner    (1001) docker     (127)      396 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil14.txt
--rw-r--r--   0 runner    (1001) docker     (127)      396 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil16.txt
--rw-r--r--   0 runner    (1001) docker     (127)      396 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil17.txt
--rw-r--r--   0 runner    (1001) docker     (127)      296 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil18.txt
--rw-r--r--   0 runner    (1001) docker     (127)      296 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil19.txt
--rw-r--r--   0 runner    (1001) docker     (127)      296 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil20.txt
--rw-r--r--   0 runner    (1001) docker     (127)      296 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil21.txt
--rw-r--r--   0 runner    (1001) docker     (127)      296 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil22.txt
--rw-r--r--   0 runner    (1001) docker     (127)      302 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_Div1lower.txt
--rw-r--r--   0 runner    (1001) docker     (127)      298 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_Div1upper.txt
--rw-r--r--   0 runner    (1001) docker     (127)      302 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_Div2lower.txt
--rw-r--r--   0 runner    (1001) docker     (127)      298 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_Div2upper.txt
--rw-r--r--   0 runner    (1001) docker     (127)      302 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_EFClower0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      302 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_EFClower1.txt
--rw-r--r--   0 runner    (1001) docker     (127)      296 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_EFCmed0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      300 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_EFCmed1.txt
--rw-r--r--   0 runner    (1001) docker     (127)     2448 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_EFCupper0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      298 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_EFCupper1.txt
--rw-r--r--   0 runner    (1001) docker     (127)      301 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_PF1lower.txt
--rw-r--r--   0 runner    (1001) docker     (127)      297 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_PF1upper.txt
--rw-r--r--   0 runner    (1001) docker     (127)      301 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_PF2lower.txt
--rw-r--r--   0 runner    (1001) docker     (127)      297 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_PF2upper.txt
--rw-r--r--   0 runner    (1001) docker     (127)      301 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_PF3lower.txt
--rw-r--r--   0 runner    (1001) docker     (127)      297 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_PF3upper.txt
--rw-r--r--   0 runner    (1001) docker     (127)      301 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_PF4lower.txt
--rw-r--r--   0 runner    (1001) docker     (127)      297 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_PF4upper.txt
--rw-r--r--   0 runner    (1001) docker     (127)      301 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_VS1lower.txt
--rw-r--r--   0 runner    (1001) docker     (127)      297 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_VS1upper.txt
--rw-r--r--   0 runner    (1001) docker     (127)      665 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_VStabPlatelower.txt
--rw-r--r--   0 runner    (1001) docker     (127)      654 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_VStabPlateupper.txt
--rw-r--r--   0 runner    (1001) docker     (127)      293 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_A001.txt
--rw-r--r--   0 runner    (1001) docker     (127)      295 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_B001.txt
--rw-r--r--   0 runner    (1001) docker     (127)      291 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_B002.txt
--rw-r--r--   0 runner    (1001) docker     (127)      959 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_B03A1.txt
--rw-r--r--   0 runner    (1001) docker     (127)      908 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_B03A2.txt
--rw-r--r--   0 runner    (1001) docker     (127)      908 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_B03A3.txt
--rw-r--r--   0 runner    (1001) docker     (127)      295 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_C001.txt
--rw-r--r--   0 runner    (1001) docker     (127)      291 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_C002.txt
--rw-r--r--   0 runner    (1001) docker     (127)      295 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_D001.txt
--rw-r--r--   0 runner    (1001) docker     (127)      291 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_D002.txt
--rw-r--r--   0 runner    (1001) docker     (127)      295 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_E001.txt
--rw-r--r--   0 runner    (1001) docker     (127)      295 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_E002.txt
--rw-r--r--   0 runner    (1001) docker     (127)      295 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_E003.txt
--rw-r--r--   0 runner    (1001) docker     (127)      295 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_E004.txt
--rw-r--r--   0 runner    (1001) docker     (127)      291 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_E005.txt
--rw-r--r--   0 runner    (1001) docker     (127)      291 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_E006.txt
--rw-r--r--   0 runner    (1001) docker     (127)      291 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_E007.txt
--rw-r--r--   0 runner    (1001) docker     (127)      291 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_E008.txt
--rw-r--r--   0 runner    (1001) docker     (127)     1520 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_E03A1.txt
--rw-r--r--   0 runner    (1001) docker     (127)      294 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_E03A2.txt
--rw-r--r--   0 runner    (1001) docker     (127)     1542 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_E03A3.txt
--rw-r--r--   0 runner    (1001) docker     (127)      295 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_F001.txt
--rw-r--r--   0 runner    (1001) docker     (127)      295 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_F002.txt
--rw-r--r--   0 runner    (1001) docker     (127)      295 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_F003.txt
--rw-r--r--   0 runner    (1001) docker     (127)      295 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_F004.txt
--rw-r--r--   0 runner    (1001) docker     (127)      291 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_F005.txt
--rw-r--r--   0 runner    (1001) docker     (127)      291 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_F006.txt
--rw-r--r--   0 runner    (1001) docker     (127)      291 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_F007.txt
--rw-r--r--   0 runner    (1001) docker     (127)      291 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_F008.txt
--rw-r--r--   0 runner    (1001) docker     (127)      942 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_T03A1.txt
--rw-r--r--   0 runner    (1001) docker     (127)      892 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_T03A2.txt
--rw-r--r--   0 runner    (1001) docker     (127)      892 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_T03A3.txt
--rw-r--r--   0 runner    (1001) docker     (127)      293 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpWEST_BlV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      289 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpWEST_BuV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      291 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpWEST_CSV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      604 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpWEST_DivLow1V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      604 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpWEST_DivLow2V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      593 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpWEST_DivUp1V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      593 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpWEST_DivUp2V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      293 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpWEST_DlV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      289 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpWEST_DuV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      293 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpWEST_ElV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      289 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpWEST_EuV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      293 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpWEST_FlV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      289 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpWEST_FuV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      319 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpAUG_D2cTPi.txt
--rw-r--r--   0 runner    (1001) docker     (127)      395 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpAUG_D2cTPib.txt
--rw-r--r--   0 runner    (1001) docker     (127)      230 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpAUG_D2cTPic.txt
--rw-r--r--   0 runner    (1001) docker     (127)      260 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpAUG_D2cdomL.txt
--rw-r--r--   0 runner    (1001) docker     (127)      260 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpAUG_D2cdomR.txt
--rw-r--r--   0 runner    (1001) docker     (127)      260 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpAUG_D2cdome.txt
--rw-r--r--   0 runner    (1001) docker     (127)      228 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpAUG_D2ci1.txt
--rw-r--r--   0 runner    (1001) docker     (127)      198 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpAUG_D2ci2.txt
--rw-r--r--   0 runner    (1001) docker     (127)      469 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpAUG_D2dBG2.txt
--rw-r--r--   0 runner    (1001) docker     (127)      244 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpAUG_D2dBl1.txt
--rw-r--r--   0 runner    (1001) docker     (127)      259 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpAUG_D2dBl2.txt
--rw-r--r--   0 runner    (1001) docker     (127)      244 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpAUG_D2dBl3.txt
--rw-r--r--   0 runner    (1001) docker     (127)      379 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpAUG_D2dBu1.txt
--rw-r--r--   0 runner    (1001) docker     (127)      214 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpAUG_D2dBu2.txt
--rw-r--r--   0 runner    (1001) docker     (127)      214 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpAUG_D2dBu3.txt
--rw-r--r--   0 runner    (1001) docker     (127)      168 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpAUG_D2dBu4.txt
--rw-r--r--   0 runner    (1001) docker     (127)      348 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpAUG_D3BG1.txt
--rw-r--r--   0 runner    (1001) docker     (127)      334 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpAUG_D3BG10.txt
--rw-r--r--   0 runner    (1001) docker     (127)      963 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpAUG_ICRHa.txt
--rw-r--r--   0 runner    (1001) docker     (127)      167 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpAUG_LIM09.txt
--rw-r--r--   0 runner    (1001) docker     (127)      137 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpAUG_PClow.txt
--rw-r--r--   0 runner    (1001) docker     (127)      136 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpAUG_PCup.txt
--rw-r--r--   0 runner    (1001) docker     (127)      675 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpAUG_SBi.txt
--rw-r--r--   0 runner    (1001) docker     (127)      303 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpAUG_TPLT1.txt
--rw-r--r--   0 runner    (1001) docker     (127)      228 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpAUG_TPLT2.txt
--rw-r--r--   0 runner    (1001) docker     (127)      273 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpAUG_TPLT3.txt
--rw-r--r--   0 runner    (1001) docker     (127)      393 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpAUG_TPLT4.txt
--rw-r--r--   0 runner    (1001) docker     (127)      378 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpAUG_TPLT5.txt
--rw-r--r--   0 runner    (1001) docker     (127)      483 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpAUG_TPRT2.txt
--rw-r--r--   0 runner    (1001) docker     (127)      258 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpAUG_TPRT3.txt
--rw-r--r--   0 runner    (1001) docker     (127)      228 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpAUG_TPRT4.txt
--rw-r--r--   0 runner    (1001) docker     (127)      288 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpAUG_TPRT5.txt
--rw-r--r--   0 runner    (1001) docker     (127)     2819 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpCOMPASS_inner.txt
--rw-r--r--   0 runner    (1001) docker     (127)     3969 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpCOMPASS_lower.txt
--rw-r--r--   0 runner    (1001) docker     (127)     4183 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpCOMPASS_outer.txt
--rw-r--r--   0 runner    (1001) docker     (127)     1693 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpCOMPASS_upper.txt
--rw-r--r--   0 runner    (1001) docker     (127)    42519 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpDEMO2019_BlanketInnerV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)    73640 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpDEMO2019_BlanketOuterV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)    35568 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpDEMO2019_DivertorV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)    26260 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpDEMO2019_LimiterEquatV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)    26204 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpDEMO2019_LimiterUpperV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)     1305 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_BLK01.txt
--rw-r--r--   0 runner    (1001) docker     (127)     1305 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_BLK02.txt
--rw-r--r--   0 runner    (1001) docker     (127)     1302 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_BLK03.txt
--rw-r--r--   0 runner    (1001) docker     (127)     1299 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_BLK04.txt
--rw-r--r--   0 runner    (1001) docker     (127)     1299 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_BLK05.txt
--rw-r--r--   0 runner    (1001) docker     (127)     1299 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_BLK06.txt
--rw-r--r--   0 runner    (1001) docker     (127)     1399 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_BLK07.txt
--rw-r--r--   0 runner    (1001) docker     (127)     1499 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_BLK08.txt
--rw-r--r--   0 runner    (1001) docker     (127)     1449 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_BLK09.txt
--rw-r--r--   0 runner    (1001) docker     (127)     1248 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_BLK10.txt
--rw-r--r--   0 runner    (1001) docker     (127)     2107 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_BLK11.txt
--rw-r--r--   0 runner    (1001) docker     (127)     2107 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_BLK12.txt
--rw-r--r--   0 runner    (1001) docker     (127)     2107 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_BLK13.txt
--rw-r--r--   0 runner    (1001) docker     (127)     1198 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_BLK14.txt
--rw-r--r--   0 runner    (1001) docker     (127)     1200 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_BLK15.txt
--rw-r--r--   0 runner    (1001) docker     (127)     2111 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_BLK16.txt
--rw-r--r--   0 runner    (1001) docker     (127)     2111 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_BLK17.txt
--rw-r--r--   0 runner    (1001) docker     (127)     2111 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_BLK18.txt
--rw-r--r--   0 runner    (1001) docker     (127)     6691 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_Div1.txt
--rw-r--r--   0 runner    (1001) docker     (127)     3376 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_Div2.txt
--rw-r--r--   0 runner    (1001) docker     (127)     5875 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_Div3.txt
--rw-r--r--   0 runner    (1001) docker     (127)     3325 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_Div4.txt
--rw-r--r--   0 runner    (1001) docker     (127)     5875 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_Div5.txt
--rw-r--r--   0 runner    (1001) docker     (127)     5468 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_Div6.txt
--rw-r--r--   0 runner    (1001) docker     (127)     5468 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_Div7.txt
--rw-r--r--   0 runner    (1001) docker     (127)     2349 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpNSTX_BumperOutter01.txt
--rw-r--r--   0 runner    (1001) docker     (127)     2299 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpNSTX_BumperOutter02.txt
--rw-r--r--   0 runner    (1001) docker     (127)     2299 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpNSTX_BumperOutter03.txt
--rw-r--r--   0 runner    (1001) docker     (127)     2249 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpNSTX_BumperOutter04.txt
--rw-r--r--   0 runner    (1001) docker     (127)     2248 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpNSTX_DivertorLower.txt
--rw-r--r--   0 runner    (1001) docker     (127)     2298 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpNSTX_DivertorUpper.txt
--rw-r--r--   0 runner    (1001) docker     (127)      546 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpNSTX_ICRFAntenna.txt
--rw-r--r--   0 runner    (1001) docker     (127)    21699 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpNSTX_VesselOutter01.txt
--rw-r--r--   0 runner    (1001) docker     (127)     4149 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpNSTX_VesselOutter02.txt
--rw-r--r--   0 runner    (1001) docker     (127)      344 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpNSTX_path69778.txt
--rw-r--r--   0 runner    (1001) docker     (127)      294 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpNSTX_path69912.txt
--rw-r--r--   0 runner    (1001) docker     (127)      444 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpNSTX_path69980.txt
--rw-r--r--   0 runner    (1001) docker     (127)      794 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpNSTX_path70015.txt
--rw-r--r--   0 runner    (1001) docker     (127)      694 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpNSTX_path70085.txt
--rw-r--r--   0 runner    (1001) docker     (127)      394 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpNSTX_path70153.txt
--rw-r--r--   0 runner    (1001) docker     (127)      697 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpSPARC_ICRH0.txt
--rw-r--r--   0 runner    (1001) docker     (127)     3173 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpTOMAS_AntennaV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)     3224 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpTOMAS_LimiterV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      756 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_BaffleV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)     1674 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_BaffleV1.txt
--rw-r--r--   0 runner    (1001) docker     (127)    13188 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_BaffleV2.txt
--rw-r--r--   0 runner    (1001) docker     (127)     1158 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_BumperInnerV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)     2067 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_BumperInnerV1.txt
--rw-r--r--   0 runner    (1001) docker     (127)     5298 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_BumperInnerV2.txt
--rw-r--r--   0 runner    (1001) docker     (127)     5904 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_BumperInnerV3.txt
--rw-r--r--   0 runner    (1001) docker     (127)      956 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_BumperOuterV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)     1764 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_BumperOuterV1.txt
--rw-r--r--   0 runner    (1001) docker     (127)     4793 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_BumperOuterV2.txt
--rw-r--r--   0 runner    (1001) docker     (127)     4943 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_BumperOuterV3.txt
--rw-r--r--   0 runner    (1001) docker     (127)     1479 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_CasingCoverLDivV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)     1402 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_CasingCoverUDivV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)     4018 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_CasingLDivV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      564 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_CasingPFUPlateLDivV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      555 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_CasingPFUPlateUDivV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)     4530 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_CasingPJLDivV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)     4455 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_CasingPJUDivV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)     4053 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_CasingUDivV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      299 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_DivLowGCV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      452 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_DivLowGCV1.txt
--rw-r--r--   0 runner    (1001) docker     (127)      911 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_DivLowGCV2.txt
--rw-r--r--   0 runner    (1001) docker     (127)    23939 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_DivLowGCV3.txt
--rw-r--r--   0 runner    (1001) docker     (127)      709 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_DivLowITERV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)     2443 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_DivLowITERV1.txt
--rw-r--r--   0 runner    (1001) docker     (127)     7696 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_DivLowITERV2.txt
--rw-r--r--   0 runner    (1001) docker     (127)    30724 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_DivLowITERV3.txt
--rw-r--r--   0 runner    (1001) docker     (127)      292 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_DivUpV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      342 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_DivUpV1.txt
--rw-r--r--   0 runner    (1001) docker     (127)      492 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_DivUpV2.txt
--rw-r--r--   0 runner    (1001) docker     (127)    23520 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_DivUpV3.txt
--rw-r--r--   0 runner    (1001) docker     (127)     2159 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_IC1V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)     6553 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_IC1V1.txt
--rw-r--r--   0 runner    (1001) docker     (127)     2159 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_IC2V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)     6553 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_IC2V1.txt
--rw-r--r--   0 runner    (1001) docker     (127)     2161 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_IC3V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)     6555 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_IC3V1.txt
--rw-r--r--   0 runner    (1001) docker     (127)     2161 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_LH1V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)     6555 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_LH1V1.txt
--rw-r--r--   0 runner    (1001) docker     (127)     2161 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_LH2V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)     6555 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_LH2V1.txt
--rw-r--r--   0 runner    (1001) docker     (127)      645 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_RippleV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      795 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_RippleV1.txt
--rw-r--r--   0 runner    (1001) docker     (127)     1819 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_ThermalShieldHFSV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)     6424 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_ThermalShieldLFSLowV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)    20508 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_ThermalShieldLFSSlimV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)     6311 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_ThermalShieldLFSUpV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)    20508 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_ThermalShieldLFSWideV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)     1502 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_VDEV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)    50500 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_PlasmaDomain_ExpWEST_Sep.txt
--rw-r--r--   0 runner    (1001) docker     (127)    15855 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpAUG_V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      588 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpAUG_VESiR.txt
--rw-r--r--   0 runner    (1001) docker     (127)     8374 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpCOMPASS2_V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)     2720 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpCOMPASS_InnerV1.txt
--rw-r--r--   0 runner    (1001) docker     (127)    11775 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpCOMPASS_V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)    84216 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpDEMO2019_V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      897 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpITER_Cryostat.txt
--rw-r--r--   0 runner    (1001) docker     (127)     6909 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpITER_InnerV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)     7717 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpITER_OuterV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)    28016 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpITER_V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)     5235 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpITER_V1.txt
--rw-r--r--   0 runner    (1001) docker     (127)    12614 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpJET_V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)     1401 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpKSTAR_V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      542 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpMAST_V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)     6905 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpNSTX_V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)     1296 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpNSTX_VesselInner.txt
--rw-r--r--   0 runner    (1001) docker     (127)     3278 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpSPARC_CoilTFInner.txt
--rw-r--r--   0 runner    (1001) docker     (127)     3782 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpSPARC_CoilTFOuter.txt
--rw-r--r--   0 runner    (1001) docker     (127)     2521 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpSPARC_FirstWallV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      902 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpSPARC_VesInner.txt
--rw-r--r--   0 runner    (1001) docker     (127)      801 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpSPARC_VesOuter.txt
--rw-r--r--   0 runner    (1001) docker     (127)     2973 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpTCV_t.txt
--rw-r--r--   0 runner    (1001) docker     (127)    12964 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpTCV_vIn.txt
--rw-r--r--   0 runner    (1001) docker     (127)    12966 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpTCV_vOut.txt
--rw-r--r--   0 runner    (1001) docker     (127)    10192 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpTOMAS_V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)    29937 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpWEST_InnerV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)    31654 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpWEST_OuterV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)     2670 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpWEST_StandardV0.txt
--rw-r--r--   0 runner    (1001) docker     (127)     3227 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpWEST_StandardV1.txt
--rw-r--r--   0 runner    (1001) docker     (127)     3071 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpWEST_StandardV2.txt
--rw-r--r--   0 runner    (1001) docker     (127)    11599 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/WEST_get_details_from_excel.py
--rwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     2491 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/inputs/get_geom_TCV.py
--rw-r--r--   0 runner    (1001) docker     (127)      181 2024-02-27 17:24:10.000000 tofu-1.7.7/tofu/geom/openmp_enabled.py
--rw-r--r--   0 runner    (1001) docker     (127)    46718 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/geom/utils.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-02-27 17:24:10.203434 tofu-1.7.7/tofu/imas2tofu/
--rw-r--r--   0 runner    (1001) docker     (127)     3301 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/imas2tofu/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    26569 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/imas2tofu/_comp.py
--rw-r--r--   0 runner    (1001) docker     (127)     7109 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/imas2tofu/_comp_mesh.py
--rw-r--r--   0 runner    (1001) docker     (127)    48077 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/imas2tofu/_comp_toobjects.py
--rw-r--r--   0 runner    (1001) docker     (127)   138425 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/imas2tofu/_core.py
--rw-r--r--   0 runner    (1001) docker     (127)    42334 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/imas2tofu/_def.py
--rw-r--r--   0 runner    (1001) docker     (127)     7691 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/imas2tofu/_mat2ids2calc.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-02-27 17:24:10.207434 tofu-1.7.7/tofu/mag/
--rw-r--r--   0 runner    (1001) docker     (127)     1160 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/mag/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    29557 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/mag/equimap.py
--rw-r--r--   0 runner    (1001) docker     (127)    23137 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/mag/magFieldLines.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-02-27 17:24:10.207434 tofu-1.7.7/tofu/mag/mag_ripple/
--rw-r--r--   0 runner    (1001) docker     (127)      475 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/mag/mag_ripple/__init__.py
--rwxr-xr-x   0 runner    (1001) docker     (127)      520 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/mag/mag_ripple/compile_f2py.sh
--rwxr-xr-x   0 runner    (1001) docker     (127)     3482 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/mag/mag_ripple/mag_ripple.f
--rw-r--r--   0 runner    (1001) docker     (127)    11158 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/mag/regression_test.py
--rw-r--r--   0 runner    (1001) docker     (127)    11334 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/mag/test_equimap.py
--rw-r--r--   0 runner    (1001) docker     (127)      588 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/mag/test_magFieldLines.py
--rw-r--r--   0 runner    (1001) docker     (127)    15899 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/mag/test_ripple.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-02-27 17:24:10.207434 tofu-1.7.7/tofu/nist2tofu/
--rw-r--r--   0 runner    (1001) docker     (127)      388 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/nist2tofu/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    27722 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/nist2tofu/_requests.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-02-27 17:24:10.207434 tofu-1.7.7/tofu/openadas2tofu/
--rw-r--r--   0 runner    (1001) docker     (127)      503 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/openadas2tofu/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    35701 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/openadas2tofu/_read_files.py
--rw-r--r--   0 runner    (1001) docker     (127)    24831 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/openadas2tofu/_requests.py
--rw-r--r--   0 runner    (1001) docker     (127)    72466 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/pathfile.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-02-27 17:24:10.207434 tofu-1.7.7/tofu/spectro/
--rw-r--r--   0 runner    (1001) docker     (127)    12730 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/spectro/Ge_AtomicScatteringFactors_LBL.txt
--rw-r--r--   0 runner    (1001) docker     (127)    46941 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/spectro/Ge_AtomicScatteringFactors_NIST.txt
--rw-r--r--   0 runner    (1001) docker     (127)      273 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/spectro/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    18789 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/spectro/_analysis_tools.py
--rw-r--r--   0 runner    (1001) docker     (127)    52853 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/spectro/_fit12d.py
--rw-r--r--   0 runner    (1001) docker     (127)    29573 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/spectro/_fit12d_dextract.py
--rw-r--r--   0 runner    (1001) docker     (127)   100333 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/spectro/_fit12d_dinput.py
--rw-r--r--   0 runner    (1001) docker     (127)    25979 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/spectro/_fit12d_funccostjac.py
--rw-r--r--   0 runner    (1001) docker     (127)    73924 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/spectro/_plot.py
--rw-r--r--   0 runner    (1001) docker     (127)    76274 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/spectro/_rockingcurve.py
--rw-r--r--   0 runner    (1001) docker     (127)    22149 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/spectro/_rockingcurve_def.py
--rw-r--r--   0 runner    (1001) docker     (127)     6587 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/spectro/_rockingcurve_tools.py
--rw-r--r--   0 runner    (1001) docker     (127)    16081 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/spectro/_spectralrange2d.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-02-27 17:24:10.207434 tofu-1.7.7/tofu/tests/
--rw-r--r--   0 runner    (1001) docker     (127)      297 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/__init__.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-02-27 17:24:10.211434 tofu-1.7.7/tofu/tests/tests00_root/
--rw-r--r--   0 runner    (1001) docker     (127)       29 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests00_root/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4570 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests00_root/test_03_plot.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-02-27 17:24:10.211434 tofu-1.7.7/tofu/tests/tests01_geom/
--rw-r--r--   0 runner    (1001) docker     (127)      184 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    76941 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_01_GG.py
--rw-r--r--   0 runner    (1001) docker     (127)     5832 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_02_compute.py
--rw-r--r--   0 runner    (1001) docker     (127)   125415 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_03_core.py
--rw-r--r--   0 runner    (1001) docker     (127)    14230 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_04_core_optics.py
--rw-r--r--   0 runner    (1001) docker     (127)    16675 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_04_sampling.py
--rw-r--r--   0 runner    (1001) docker     (127)    19047 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_05_solid_angles.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-02-27 17:24:10.219434 tofu-1.7.7/tofu/tests/tests01_geom/test_data/
--rw-r--r--   0 runner    (1001) docker     (127)   218404 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/Inkscape.svg
--rw-r--r--   0 runner    (1001) docker     (127)      202 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_CoilCS_V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      204 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_CoilPF_Bl_V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      200 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_CoilPF_Bu_V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      510 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_CoilPF_DivLow1_V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      510 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_CoilPF_DivLow2_V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      500 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_CoilPF_DivUp1_V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      500 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_CoilPF_DivUp2_V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      204 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_CoilPF_Dl_V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      200 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_CoilPF_Du_V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      204 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_CoilPF_El_V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      200 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_CoilPF_Eu_V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      204 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_CoilPF_Fl_V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      200 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_CoilPF_Fu_V0.txt
--rwxr-xr-x   0 runner    (1001) docker     (127)    12294 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_CoilPF_Notes.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     3641 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_Baffle_Notes.py
--rw-r--r--   0 runner    (1001) docker     (127)      663 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_Baffle_V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)     1581 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_Baffle_V1.txt
--rwxr-xr-x   0 runner    (1001) docker     (127)     8466 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_BumperInner_Notes.py
--rw-r--r--   0 runner    (1001) docker     (127)      758 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_BumperInner_V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)     1667 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_BumperInner_V1.txt
--rw-r--r--   0 runner    (1001) docker     (127)     4898 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_BumperInner_V2.txt
--rwxr-xr-x   0 runner    (1001) docker     (127)     9724 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_BumperOuter_Notes.py
--rw-r--r--   0 runner    (1001) docker     (127)      808 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_BumperOuter_V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)     1616 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_BumperOuter_V1.txt
--rw-r--r--   0 runner    (1001) docker     (127)     4645 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_BumperOuter_V2.txt
--rwxr-xr-x   0 runner    (1001) docker     (127)     4369 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_DivLowGC_Notes.py
--rw-r--r--   0 runner    (1001) docker     (127)      204 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_DivLowGC_V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      357 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_DivLowGC_V1.txt
--rw-r--r--   0 runner    (1001) docker     (127)      816 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_DivLowGC_V2.txt
--rwxr-xr-x   0 runner    (1001) docker     (127)     5741 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_DivLowITER_Notes.py
--rw-r--r--   0 runner    (1001) docker     (127)      612 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_DivLowITER_V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)     2346 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_DivLowITER_V1.txt
--rw-r--r--   0 runner    (1001) docker     (127)     7599 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_DivLowITER_V2.txt
--rwxr-xr-x   0 runner    (1001) docker     (127)     2639 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_DivUp_Notes.py
--rw-r--r--   0 runner    (1001) docker     (127)      200 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_DivUp_V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      250 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_DivUp_V1.txt
--rw-r--r--   0 runner    (1001) docker     (127)      400 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_DivUp_V2.txt
--rwxr-xr-x   0 runner    (1001) docker     (127)     9803 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_IC1_Notes.py
--rw-r--r--   0 runner    (1001) docker     (127)     1969 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_IC1_V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)     6363 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_IC1_V1.txt
--rwxr-xr-x   0 runner    (1001) docker     (127)     9824 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_IC2_Notes.py
--rw-r--r--   0 runner    (1001) docker     (127)     1969 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_IC2_V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)     6363 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_IC2_V1.txt
--rwxr-xr-x   0 runner    (1001) docker     (127)     9822 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_IC3_Notes.py
--rw-r--r--   0 runner    (1001) docker     (127)     1969 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_IC3_V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)     6363 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_IC3_V1.txt
--rwxr-xr-x   0 runner    (1001) docker     (127)    11884 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_LH1_Notes.py
--rw-r--r--   0 runner    (1001) docker     (127)     1969 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_LH1_V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)     6363 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_LH1_V1.txt
--rwxr-xr-x   0 runner    (1001) docker     (127)    12106 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_LH2_Notes.py
--rw-r--r--   0 runner    (1001) docker     (127)     1969 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_LH2_V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)     6363 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_LH2_V1.txt
--rwxr-xr-x   0 runner    (1001) docker     (127)     2335 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_Ripple_Notes.py
--rw-r--r--   0 runner    (1001) docker     (127)      250 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_Ripple_V0.txt
--rw-r--r--   0 runner    (1001) docker     (127)      400 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_Ripple_V1.txt
--rwxr-xr-x   0 runner    (1001) docker     (127)     8060 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PlasmaDomain_Standard_Notes.py
--rwxr-xr-x   0 runner    (1001) docker     (127)     1358 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_Ves_VesIn_Notes.py
--rw-r--r--   0 runner    (1001) docker     (127)     5050 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_Ves_VesIn_V0.txt
--rwxr-xr-x   0 runner    (1001) docker     (127)     1355 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_Ves_VesOut_Notes.py
--rw-r--r--   0 runner    (1001) docker     (127)     5050 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_Ves_VesOut_V0.txt
--rwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     1396 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/test_data/det37_CTVD_incC4_New.npz
--rw-r--r--   0 runner    (1001) docker     (127)      534 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests01_geom/testing_tools.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-02-27 17:24:10.219434 tofu-1.7.7/tofu/tests/tests02_data/
--rw-r--r--   0 runner    (1001) docker     (127)       65 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests02_data/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    21607 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests02_data/test_03_core.py
--rw-r--r--   0 runner    (1001) docker     (127)     4831 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests02_data/test_04_spectrallines.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-02-27 17:24:10.219434 tofu-1.7.7/tofu/tests/tests03_openadas/
--rw-r--r--   0 runner    (1001) docker     (127)       29 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests03_openadas/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4764 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests03_openadas/test_03_core.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-02-27 17:24:10.223434 tofu-1.7.7/tofu/tests/tests04_spectro/
--rw-r--r--   0 runner    (1001) docker     (127)       67 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests04_spectro/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    29371 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests04_spectro/test_01_fit12d.py
--rw-r--r--   0 runner    (1001) docker     (127)     3383 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests04_spectro/test_02_analysistools.py
--rw-r--r--   0 runner    (1001) docker     (127)     3303 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests04_spectro/test_03_rockingcurve.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-02-27 17:24:10.231434 tofu-1.7.7/tofu/tests/tests04_spectro/test_data/
--rw-r--r--   0 runner    (1001) docker     (127)    54707 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests04_spectro/test_data/TFG_CrystalBragg_ExpWEST_DgXICS_ArXVII_sh00000_Vers1.5.0.npz
--rw-r--r--   0 runner    (1001) docker     (127)  1592000 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests04_spectro/test_data/UV_spectra_sh55506.npz
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests04_spectro/test_data/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    38498 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests04_spectro/test_data/_lines_database.py
--rw-r--r--   0 runner    (1001) docker     (127)  4287706 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests04_spectro/test_data/_mask_54041.npz
--rw-r--r--   0 runner    (1001) docker     (127)     5561 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests04_spectro/test_data/_spectral_constraints.py
--rw-r--r--   0 runner    (1001) docker     (127)     1396 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests04_spectro/test_data/det37_CTVD_incC4_New.npz
--rw-r--r--   0 runner    (1001) docker     (127)    43500 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests04_spectro/test_data/spectral_fit.npz
--rw-r--r--   0 runner    (1001) docker     (127) 23594389 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests04_spectro/test_data/west_54046_xics.npz
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-02-27 17:24:10.259434 tofu-1.7.7/tofu/tests/tests05_nist/
--rw-r--r--   0 runner    (1001) docker     (127)       29 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests05_nist/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     2804 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests05_nist/test_03_core.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-02-27 17:24:10.259434 tofu-1.7.7/tofu/tests/tests06_mesh/
--rw-r--r--   0 runner    (1001) docker     (127)       31 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests06_mesh/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    25579 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests06_mesh/test_01_checks.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-02-27 17:24:10.259434 tofu-1.7.7/tofu/tests/tests06_mesh/test_data/
--rw-r--r--   0 runner    (1001) docker     (127)   163954 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests06_mesh/test_data/ITER_JINTRAC_sh134000_run30_public_edgesources_quadtrimesh.npz
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests06_mesh/test_data/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)  1584667 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests06_mesh/test_data/mesh_triangular_WEST_eq.txt
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-02-27 17:24:10.263434 tofu-1.7.7/tofu/tests/tests07_inversions/
--rw-r--r--   0 runner    (1001) docker     (127)       34 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests07_inversions/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     7436 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests07_inversions/test_01_isotropic.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-02-27 17:24:10.263434 tofu-1.7.7/tofu/tests/tests08_diagnostics/
--rw-r--r--   0 runner    (1001) docker     (127)       36 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests08_diagnostics/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)    14862 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests08_diagnostics/test_01_diagnostics.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-02-27 17:24:10.263434 tofu-1.7.7/tofu/tests/tests09_tutorials/
--rw-r--r--   0 runner    (1001) docker     (127)       27 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests09_tutorials/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     4938 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests09_tutorials/test_01_runall.py
--rw-r--r--   0 runner    (1001) docker     (127)     2199 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests09_tutorials/tuto_plot_basic.py
--rw-r--r--   0 runner    (1001) docker     (127)     6540 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests09_tutorials/tuto_plot_create_geometry.py
--rw-r--r--   0 runner    (1001) docker     (127)     3030 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests09_tutorials/tuto_plot_create_geometry_from_svg.py
--rw-r--r--   0 runner    (1001) docker     (127)     3175 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests09_tutorials/tuto_plot_custom_emissivity.py
--rw-r--r--   0 runner    (1001) docker     (127)     1503 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests09_tutorials/tuto_plot_gallery_fusion_machines.py
--rw-r--r--   0 runner    (1001) docker     (127)     3835 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests09_tutorials/tuto_plot_solid_angles.py
--rw-r--r--   0 runner    (1001) docker     (127)    18672 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tests/tests09_tutorials/tuto_real0.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-02-27 17:24:10.263434 tofu-1.7.7/tofu/tomotok2tofu/
--rw-r--r--   0 runner    (1001) docker     (127)      480 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tomotok2tofu/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     5497 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/tomotok2tofu/_core.py
--rw-r--r--   0 runner    (1001) docker     (127)   157477 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu/utils.py
--rw-r--r--   0 runner    (1001) docker     (127)       79 2024-02-27 17:24:09.000000 tofu-1.7.7/tofu/version.py
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-02-27 17:24:10.143434 tofu-1.7.7/tofu.egg-info/
--rw-r--r--   0 runner    (1001) docker     (127)    12222 2024-02-27 17:24:10.000000 tofu-1.7.7/tofu.egg-info/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (127)    24734 2024-02-27 17:24:10.000000 tofu-1.7.7/tofu.egg-info/SOURCES.txt
--rw-r--r--   0 runner    (1001) docker     (127)        1 2024-02-27 17:24:10.000000 tofu-1.7.7/tofu.egg-info/dependency_links.txt
--rw-r--r--   0 runner    (1001) docker     (127)      211 2024-02-27 17:24:10.000000 tofu-1.7.7/tofu.egg-info/entry_points.txt
--rw-r--r--   0 runner    (1001) docker     (127)      175 2024-02-27 17:24:10.000000 tofu-1.7.7/tofu.egg-info/requires.txt
--rw-r--r--   0 runner    (1001) docker     (127)       53 2024-02-27 17:24:10.000000 tofu-1.7.7/tofu.egg-info/top_level.txt
-drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-02-27 17:24:10.263434 tofu-1.7.7/tofu_helpers/
--rw-r--r--   0 runner    (1001) docker     (127)        0 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu_helpers/__init__.py
--rw-r--r--   0 runner    (1001) docker     (127)     5064 2024-02-27 17:23:43.000000 tofu-1.7.7/tofu_helpers/openmp_helpers.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:39.601701 tofu-1.7.8/
+-rw-r--r--   0 runner    (1001) docker     (127)     1071 2024-05-31 16:09:11.000000 tofu-1.7.8/LICENSE.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      665 2024-05-31 16:09:11.000000 tofu-1.7.8/MANIFEST.in
+-rw-r--r--   0 runner    (1001) docker     (127)    12222 2024-05-31 16:09:39.601701 tofu-1.7.8/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)    11453 2024-05-31 16:09:11.000000 tofu-1.7.8/README.md
+-rw-r--r--   0 runner    (1001) docker     (127)      966 2024-05-31 16:09:11.000000 tofu-1.7.8/_updateversion.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:39.465701 tofu-1.7.8/inputs_temp/
+-rw-r--r--   0 runner    (1001) docker     (127)   119375 2024-05-31 16:09:12.000000 tofu-1.7.8/inputs_temp/XICS_allshots_C34.py
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:13.000000 tofu-1.7.8/inputs_temp/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    37619 2024-05-31 16:09:13.000000 tofu-1.7.8/inputs_temp/dlines.py
+-rw-r--r--   0 runner    (1001) docker     (127)       97 2024-05-31 16:09:13.000000 tofu-1.7.8/pyproject.toml
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:39.465701 tofu-1.7.8/scripts/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:13.000000 tofu-1.7.8/scripts/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    19395 2024-05-31 16:09:13.000000 tofu-1.7.8/scripts/_dparser.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     3731 2024-05-31 16:09:13.000000 tofu-1.7.8/scripts/tofu_bash.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     2794 2024-05-31 16:09:13.000000 tofu-1.7.8/scripts/tofucustom.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     3643 2024-05-31 16:09:13.000000 tofu-1.7.8/scripts/tofuversion.py
+-rw-r--r--   0 runner    (1001) docker     (127)       38 2024-05-31 16:09:39.601701 tofu-1.7.8/setup.cfg
+-rw-r--r--   0 runner    (1001) docker     (127)    13035 2024-05-31 16:09:13.000000 tofu-1.7.8/setup.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:39.465701 tofu-1.7.8/tofu/
+-rw-r--r--   0 runner    (1001) docker     (127)     3486 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1513 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/_physics.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12571 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/_plot.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:39.469701 tofu-1.7.8/tofu/benchmarks/
+-rw-r--r--   0 runner    (1001) docker     (127)      306 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/benchmarks/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5642 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/benchmarks/benchmarks_00_Geometry_peakmem.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5615 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/benchmarks/benchmarks_00_Geometry_time.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3032 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/benchmarks/benchmarks_01_Mesh2D_peakmem.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3023 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/benchmarks/benchmarks_01_Mesh2D_time.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6733 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/benchmarks/benchmarks_02_spectralfit_peakmem.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6724 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/benchmarks/benchmarks_02_spectralfit_time.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3385 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/benchmarks/benchmarks_03_solidangles.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:39.485701 tofu-1.7.8/tofu/data/
+-rw-r--r--   0 runner    (1001) docker     (127)    48563 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_DataCollection_check_inputs.py
+-rw-r--r--   0 runner    (1001) docker     (127)       86 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_DataCollection_class.py
+-rw-r--r--   0 runner    (1001) docker     (127)    38199 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_DataCollection_class0_Base.py
+-rw-r--r--   0 runner    (1001) docker     (127)    40664 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_DataCollection_class1_interactivity.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13459 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_DataCollection_comp.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4798 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_DataCollection_interactivity.py
+-rw-r--r--   0 runner    (1001) docker     (127)    40405 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_DataCollection_plot_as_array.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10419 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_DataCollection_plot_misc.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3114 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_DataCollection_plot_text.py
+-rw-r--r--   0 runner    (1001) docker     (127)      414 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      679 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class00_Config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8674 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class01_Plasma2D.py
+-rw-r--r--   0 runner    (1001) docker     (127)      945 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class01_compute.py
+-rw-r--r--   0 runner    (1001) docker     (127)     8832 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class01_eqdsk.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12471 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class02_Rays.py
+-rw-r--r--   0 runner    (1001) docker     (127)    28598 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class02_save2stp.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2994 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class03_Aperture.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2222 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class04_Filter.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7856 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class05_Crystal.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5263 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class05_legacy.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2376 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class06_Grating.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1483 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class06_compute.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9512 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class07_Camera.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4951 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class07_legacy.py
+-rw-r--r--   0 runner    (1001) docker     (127)    35271 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class08_Diagnostic.py
+-rw-r--r--   0 runner    (1001) docker     (127)    16598 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class08_concatenate_data.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13450 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class08_get_data.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5260 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class08_get_data_def.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2203 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class08_get_data_vos_broadband.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2089 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class08_get_data_vos_spectro.py
+-rw-r--r--   0 runner    (1001) docker     (127)    27872 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class08_save2stp.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3240 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class09_GeometryMatrix.py
+-rw-r--r--   0 runner    (1001) docker     (127)    10207 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class09_compute_broadband.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4658 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class10_Inversion.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26452 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class10_algos.py
+-rw-r--r--   0 runner    (1001) docker     (127)    35239 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class10_checks.py
+-rw-r--r--   0 runner    (1001) docker     (127)    36571 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class10_compute.py
+-rw-r--r--   0 runner    (1001) docker     (127)    23823 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class10_plot.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5543 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class10_refs.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24999 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class2_check.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24364 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class2_compute.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5653 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class2_plot.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21556 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class2_sinogram.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7106 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class3_check.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4038 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class4_check.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13090 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class5_check.py
+-rw-r--r--   0 runner    (1001) docker     (127)    20262 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class5_compute.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3625 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class5_coordinates.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6632 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class5_plot.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5260 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class5_projections.py
+-rw-r--r--   0 runner    (1001) docker     (127)    34012 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class5_reflections_pts2pt.py
+-rw-r--r--   0 runner    (1001) docker     (127)    23746 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class5_reflections_ptsvect.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26074 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class7_check.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11080 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class7_compute.py
+-rw-r--r--   0 runner    (1001) docker     (127)    19103 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class8_check.py
+-rw-r--r--   0 runner    (1001) docker     (127)    27718 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class8_compute.py
+-rw-r--r--   0 runner    (1001) docker     (127)    39882 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class8_compute_signal.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9846 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class8_compute_signal_moments.py
+-rw-r--r--   0 runner    (1001) docker     (127)    30866 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class8_equivalent_apertures.py
+-rw-r--r--   0 runner    (1001) docker     (127)    33828 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class8_etendue_los.py
+-rw-r--r--   0 runner    (1001) docker     (127)    16608 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class8_los_angles.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22245 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class8_los_data.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12110 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class8_move.py
+-rw-r--r--   0 runner    (1001) docker     (127)    36679 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class8_plane_perp_to_los.py
+-rw-r--r--   0 runner    (1001) docker     (127)    33310 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class8_plot.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11331 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class8_plot_coverage.py
+-rw-r--r--   0 runner    (1001) docker     (127)    27306 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class8_plot_vos.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26808 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class8_plot_vos_spectro.py
+-rw-r--r--   0 runner    (1001) docker     (127)    45065 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class8_reverse_ray_tracing.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26202 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class8_vos.py
+-rw-r--r--   0 runner    (1001) docker     (127)    30949 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class8_vos_broadband.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25024 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class8_vos_spectro.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26686 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class8_vos_spectro_nobin_at_lamb.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9218 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class8_vos_utilities.py
+-rw-r--r--   0 runner    (1001) docker     (127)    13045 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class9_compute.py
+-rw-r--r--   0 runner    (1001) docker     (127)    16432 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_class9_plot.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26948 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_comp.py
+-rw-r--r--   0 runner    (1001) docker     (127)   178556 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_core.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11590 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_core_plot.py
+-rw-r--r--   0 runner    (1001) docker     (127)      357 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_def.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1732 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_generic_check.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11367 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_generic_plot.py
+-rw-r--r--   0 runner    (1001) docker     (127)   145086 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_plot.py
+-rw-r--r--   0 runner    (1001) docker     (127)      958 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_saveload.py
+-rw-r--r--   0 runner    (1001) docker     (127)     9349 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_spectrallines_checks.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18874 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_spectrallines_class.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14730 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_spectrallines_compute.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14023 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_spectrallines_plot.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4802 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_spectralunits.py
+-rw-r--r--   0 runner    (1001) docker     (127)    12968 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_utils_bsplines.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11627 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/data/_utils_surface3d.py
+-rw-r--r--   0 runner    (1001) docker     (127)    58540 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/defaults.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:39.489701 tofu-1.7.8/tofu/dumpro/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/dumpro/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)       56 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/dumpro/_comp.py
+-rw-r--r--   0 runner    (1001) docker     (127)       50 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/dumpro/_comp_clusters.py
+-rw-r--r--   0 runner    (1001) docker     (127)      553 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/dumpro/_core.py
+-rw-r--r--   0 runner    (1001) docker     (127)       21 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/dumpro/_def.py
+-rw-r--r--   0 runner    (1001) docker     (127)       31 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/dumpro/_draft.py
+-rw-r--r--   0 runner    (1001) docker     (127)       58 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/dumpro/_plot.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:39.489701 tofu-1.7.8/tofu/dust/
+-rw-r--r--   0 runner    (1001) docker     (127)      123 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/dust/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1950 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/dust/_comp.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5472 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/dust/_core.py
+-rw-r--r--   0 runner    (1001) docker     (127)      906 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/dust/_plot.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:39.489701 tofu-1.7.8/tofu/entrypoints/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/entrypoints/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)      913 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/entrypoints/_def.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     3237 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/entrypoints/tofucalc.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     3096 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/entrypoints/tofuplot.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:39.497701 tofu-1.7.8/tofu/geom/
+-rw-r--r--   0 runner    (1001) docker     (127)   259423 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/_GG.pyx
+-rw-r--r--   0 runner    (1001) docker     (127)      508 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4611 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/_basic_geom_tools.pxd
+-rw-r--r--   0 runner    (1001) docker     (127)    13775 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/_basic_geom_tools.pyx
+-rw-r--r--   0 runner    (1001) docker     (127)      502 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/_chained_list.pxd
+-rw-r--r--   0 runner    (1001) docker     (127)     2449 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/_chained_list.pyx
+-rw-r--r--   0 runner    (1001) docker     (127)    24082 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/_check_optics.py
+-rw-r--r--   0 runner    (1001) docker     (127)    45525 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/_comp.py
+-rw-r--r--   0 runner    (1001) docker     (127)    40687 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/_comp_optics.py
+-rw-r--r--   0 runner    (1001) docker     (127)    44245 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/_comp_solidangles.py
+-rw-r--r--   0 runner    (1001) docker     (127)   290682 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/_core.py
+-rw-r--r--   0 runner    (1001) docker     (127)   148251 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/_core_optics.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25215 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/_def.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11128 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/_def_config.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7563 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/_distance_tools.pxd
+-rw-r--r--   0 runner    (1001) docker     (127)    63047 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/_distance_tools.pyx
+-rw-r--r--   0 runner    (1001) docker     (127)    28576 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/_etendue.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2167 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/_openmp_tools.pyx
+-rw-r--r--   0 runner    (1001) docker     (127)    69100 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/_plot.py
+-rw-r--r--   0 runner    (1001) docker     (127)    62488 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/_plot_optics.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18069 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/_raytracing_tools.pxd
+-rw-r--r--   0 runner    (1001) docker     (127)   118812 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/_raytracing_tools.pyx
+-rw-r--r--   0 runner    (1001) docker     (127)    14136 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/_sampling_tools.pxd
+-rw-r--r--   0 runner    (1001) docker     (127)   115724 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/_sampling_tools.pyx
+-rw-r--r--   0 runner    (1001) docker     (127)      371 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/_sorted_set.pxd
+-rw-r--r--   0 runner    (1001) docker     (127)     2262 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/_sorted_set.pyx
+-rw-r--r--   0 runner    (1001) docker     (127)     4156 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/_vignetting_tools.pxd
+-rw-r--r--   0 runner    (1001) docker     (127)    26377 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/_vignetting_tools.pyx
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:39.537701 tofu-1.7.8/tofu/geom/inputs/
+-rw-r--r--   0 runner    (1001) docker     (127)     1609 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/AUG_V0_from_V1.py
+-rw-r--r--   0 runner    (1001) docker     (127)      296 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilCS_ExpITER_CS1L.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      292 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilCS_ExpITER_CS1U.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      296 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilCS_ExpITER_CS2L.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      292 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilCS_ExpITER_CS2U.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      296 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilCS_ExpITER_CS3L.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      292 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilCS_ExpITER_CS3U.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      301 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilCS_ExpSPARC_CS1lower.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      297 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilCS_ExpSPARC_CS1upper.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      301 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilCS_ExpSPARC_CS2lower.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      297 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilCS_ExpSPARC_CS2upper.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      301 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilCS_ExpSPARC_CS3lower.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      297 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilCS_ExpSPARC_CS3upper.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      291 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpITER_PF1.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      291 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpITER_PF2.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      291 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpITER_PF3.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      295 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpITER_PF4.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      295 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpITER_PF5.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      295 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpITER_PF6.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      303 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_CentralSolenoid.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      296 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil01.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      346 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil02.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      296 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil03.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      296 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil04.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      396 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil05.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      396 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil06.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      396 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil07.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      296 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil08.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      296 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil09.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      296 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil10.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      296 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil11.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      296 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil12.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      296 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil13.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      396 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil14.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      396 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil16.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      396 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil17.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      296 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil18.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      296 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil19.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      296 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil20.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      296 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil21.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      296 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpNSTX_PFCoil22.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      302 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_Div1lower.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      298 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_Div1upper.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      302 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_Div2lower.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      298 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_Div2upper.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      302 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_EFClower0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      302 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_EFClower1.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      296 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_EFCmed0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      300 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_EFCmed1.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     2448 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_EFCupper0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      298 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_EFCupper1.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      301 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_PF1lower.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      297 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_PF1upper.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      301 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_PF2lower.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      297 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_PF2upper.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      301 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_PF3lower.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      297 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_PF3upper.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      301 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_PF4lower.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      297 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_PF4upper.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      301 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_VS1lower.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      297 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_VS1upper.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      665 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_VStabPlatelower.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      654 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_VStabPlateupper.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      293 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_A001.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      295 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_B001.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      291 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_B002.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      959 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_B03A1.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      908 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_B03A2.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      908 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_B03A3.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      295 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_C001.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      291 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_C002.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      295 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_D001.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      291 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_D002.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      295 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_E001.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      295 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_E002.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      295 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_E003.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      295 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_E004.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      291 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_E005.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      291 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_E006.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      291 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_E007.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      291 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_E008.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     1520 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_E03A1.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      294 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_E03A2.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     1542 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_E03A3.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      295 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_F001.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      295 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_F002.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      295 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_F003.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      295 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_F004.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      291 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_F005.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      291 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_F006.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      291 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_F007.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      291 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_F008.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      942 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_T03A1.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      892 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_T03A2.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      892 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_T03A3.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      293 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpWEST_BlV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      289 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpWEST_BuV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      291 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpWEST_CSV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      604 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpWEST_DivLow1V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      604 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpWEST_DivLow2V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      593 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpWEST_DivUp1V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      593 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpWEST_DivUp2V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      293 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpWEST_DlV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      289 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpWEST_DuV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      293 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpWEST_ElV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      289 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpWEST_EuV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      293 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpWEST_FlV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      289 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpWEST_FuV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      319 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpAUG_D2cTPi.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      395 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpAUG_D2cTPib.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      230 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpAUG_D2cTPic.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      260 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpAUG_D2cdomL.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      260 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpAUG_D2cdomR.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      260 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpAUG_D2cdome.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      228 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpAUG_D2ci1.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      198 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpAUG_D2ci2.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      469 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpAUG_D2dBG2.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      244 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpAUG_D2dBl1.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      259 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpAUG_D2dBl2.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      244 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpAUG_D2dBl3.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      379 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpAUG_D2dBu1.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      214 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpAUG_D2dBu2.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      214 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpAUG_D2dBu3.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      168 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpAUG_D2dBu4.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      348 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpAUG_D3BG1.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      334 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpAUG_D3BG10.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      963 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpAUG_ICRHa.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      167 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpAUG_LIM09.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      137 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpAUG_PClow.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      136 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpAUG_PCup.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      675 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpAUG_SBi.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      303 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpAUG_TPLT1.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      228 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpAUG_TPLT2.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      273 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpAUG_TPLT3.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      393 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpAUG_TPLT4.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      378 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpAUG_TPLT5.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      483 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpAUG_TPRT2.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      258 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpAUG_TPRT3.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      228 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpAUG_TPRT4.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      288 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpAUG_TPRT5.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     2819 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpCOMPASS_inner.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     3969 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpCOMPASS_lower.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     4183 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpCOMPASS_outer.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     1693 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpCOMPASS_upper.txt
+-rw-r--r--   0 runner    (1001) docker     (127)    42519 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpDEMO2019_BlanketInnerV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)    73640 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpDEMO2019_BlanketOuterV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)    35568 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpDEMO2019_DivertorV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)    26260 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpDEMO2019_LimiterEquatV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)    26204 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpDEMO2019_LimiterUpperV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     1305 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_BLK01.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     1305 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_BLK02.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     1302 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_BLK03.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     1299 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_BLK04.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     1299 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_BLK05.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     1299 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_BLK06.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     1399 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_BLK07.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     1499 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_BLK08.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     1449 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_BLK09.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     1248 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_BLK10.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     2107 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_BLK11.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     2107 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_BLK12.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     2107 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_BLK13.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     1198 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_BLK14.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     1200 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_BLK15.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     2111 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_BLK16.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     2111 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_BLK17.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     2111 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_BLK18.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     6691 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_Div1.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     3376 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_Div2.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     5875 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_Div3.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     3325 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_Div4.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     5875 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_Div5.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     5468 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_Div6.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     5468 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_Div7.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     2349 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpNSTX_BumperOutter01.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     2299 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpNSTX_BumperOutter02.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     2299 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpNSTX_BumperOutter03.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     2249 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpNSTX_BumperOutter04.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     2248 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpNSTX_DivertorLower.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     2298 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpNSTX_DivertorUpper.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      546 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpNSTX_ICRFAntenna.txt
+-rw-r--r--   0 runner    (1001) docker     (127)    21699 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpNSTX_VesselOutter01.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     4149 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpNSTX_VesselOutter02.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      344 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpNSTX_path69778.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      294 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpNSTX_path69912.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      444 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpNSTX_path69980.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      794 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpNSTX_path70015.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      694 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpNSTX_path70085.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      394 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpNSTX_path70153.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      697 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpSPARC_ICRH0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     3173 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpTOMAS_AntennaV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     3224 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpTOMAS_LimiterV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      756 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_BaffleV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     1674 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_BaffleV1.txt
+-rw-r--r--   0 runner    (1001) docker     (127)    13188 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_BaffleV2.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     1158 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_BumperInnerV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     2067 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_BumperInnerV1.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     5298 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_BumperInnerV2.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     5904 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_BumperInnerV3.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      956 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_BumperOuterV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     1764 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_BumperOuterV1.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     4793 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_BumperOuterV2.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     4943 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_BumperOuterV3.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     1479 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_CasingCoverLDivV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     1402 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_CasingCoverUDivV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     4018 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_CasingLDivV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      564 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_CasingPFUPlateLDivV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      555 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_CasingPFUPlateUDivV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     4530 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_CasingPJLDivV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     4455 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_CasingPJUDivV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     4053 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_CasingUDivV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      299 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_DivLowGCV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      452 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_DivLowGCV1.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      911 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_DivLowGCV2.txt
+-rw-r--r--   0 runner    (1001) docker     (127)    23939 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_DivLowGCV3.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      709 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_DivLowITERV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     2443 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_DivLowITERV1.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     7696 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_DivLowITERV2.txt
+-rw-r--r--   0 runner    (1001) docker     (127)    30724 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_DivLowITERV3.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      292 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_DivUpV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      342 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_DivUpV1.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      492 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_DivUpV2.txt
+-rw-r--r--   0 runner    (1001) docker     (127)    23520 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_DivUpV3.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     2159 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_IC1V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     6553 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_IC1V1.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     2159 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_IC2V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     6553 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_IC2V1.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     2161 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_IC3V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     6555 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_IC3V1.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     2161 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_LH1V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     6555 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_LH1V1.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     2161 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_LH2V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     6555 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_LH2V1.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      645 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_RippleV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      795 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_RippleV1.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     1819 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_ThermalShieldHFSV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     6424 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_ThermalShieldLFSLowV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)    20508 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_ThermalShieldLFSSlimV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     6311 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_ThermalShieldLFSUpV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)    20508 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_ThermalShieldLFSWideV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     1502 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_VDEV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)    50500 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_PlasmaDomain_ExpWEST_Sep.txt
+-rw-r--r--   0 runner    (1001) docker     (127)    15855 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpAUG_V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      588 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpAUG_VESiR.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     8374 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpCOMPASS2_V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     2720 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpCOMPASS_InnerV1.txt
+-rw-r--r--   0 runner    (1001) docker     (127)    11775 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpCOMPASS_V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)    84216 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpDEMO2019_V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      897 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpITER_Cryostat.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     6909 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpITER_InnerV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     7717 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpITER_OuterV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)    28016 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpITER_V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     5235 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpITER_V1.txt
+-rw-r--r--   0 runner    (1001) docker     (127)    12614 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpJET_V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     1401 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpKSTAR_V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      542 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpMAST_V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     6905 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpNSTX_V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     1296 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpNSTX_VesselInner.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     3278 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpSPARC_CoilTFInner.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     3782 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpSPARC_CoilTFOuter.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     2521 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpSPARC_FirstWallV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      902 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpSPARC_VesInner.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      801 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpSPARC_VesOuter.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     2973 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpTCV_t.txt
+-rw-r--r--   0 runner    (1001) docker     (127)    12964 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpTCV_vIn.txt
+-rw-r--r--   0 runner    (1001) docker     (127)    12966 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpTCV_vOut.txt
+-rw-r--r--   0 runner    (1001) docker     (127)    10192 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpTOMAS_V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)    29937 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpWEST_InnerV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)    31654 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpWEST_OuterV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     2670 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpWEST_StandardV0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     3227 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpWEST_StandardV1.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     3071 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpWEST_StandardV2.txt
+-rw-r--r--   0 runner    (1001) docker     (127)    11599 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/WEST_get_details_from_excel.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2491 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/inputs/get_geom_TCV.py
+-rw-r--r--   0 runner    (1001) docker     (127)      181 2024-05-31 16:09:39.000000 tofu-1.7.8/tofu/geom/openmp_enabled.py
+-rw-r--r--   0 runner    (1001) docker     (127)    46718 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/geom/utils.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:39.537701 tofu-1.7.8/tofu/imas2tofu/
+-rw-r--r--   0 runner    (1001) docker     (127)     3301 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/imas2tofu/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    26569 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/imas2tofu/_comp.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7109 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/imas2tofu/_comp_mesh.py
+-rw-r--r--   0 runner    (1001) docker     (127)    48077 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/imas2tofu/_comp_toobjects.py
+-rw-r--r--   0 runner    (1001) docker     (127)   138425 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/imas2tofu/_core.py
+-rw-r--r--   0 runner    (1001) docker     (127)    42334 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/imas2tofu/_def.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7691 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/imas2tofu/_mat2ids2calc.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:39.541701 tofu-1.7.8/tofu/mag/
+-rw-r--r--   0 runner    (1001) docker     (127)     1160 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/mag/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    29557 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/mag/equimap.py
+-rw-r--r--   0 runner    (1001) docker     (127)    23137 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/mag/magFieldLines.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:39.541701 tofu-1.7.8/tofu/mag/mag_ripple/
+-rw-r--r--   0 runner    (1001) docker     (127)      475 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/mag/mag_ripple/__init__.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)      520 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/mag/mag_ripple/compile_f2py.sh
+-rwxr-xr-x   0 runner    (1001) docker     (127)     3482 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/mag/mag_ripple/mag_ripple.f
+-rw-r--r--   0 runner    (1001) docker     (127)    11158 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/mag/regression_test.py
+-rw-r--r--   0 runner    (1001) docker     (127)    11334 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/mag/test_equimap.py
+-rw-r--r--   0 runner    (1001) docker     (127)      588 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/mag/test_magFieldLines.py
+-rw-r--r--   0 runner    (1001) docker     (127)    15899 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/mag/test_ripple.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:39.541701 tofu-1.7.8/tofu/nist2tofu/
+-rw-r--r--   0 runner    (1001) docker     (127)      388 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/nist2tofu/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    27722 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/nist2tofu/_requests.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:39.541701 tofu-1.7.8/tofu/openadas2tofu/
+-rw-r--r--   0 runner    (1001) docker     (127)      503 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/openadas2tofu/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    35701 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/openadas2tofu/_read_files.py
+-rw-r--r--   0 runner    (1001) docker     (127)    24831 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/openadas2tofu/_requests.py
+-rw-r--r--   0 runner    (1001) docker     (127)    72466 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/pathfile.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:39.541701 tofu-1.7.8/tofu/spectro/
+-rw-r--r--   0 runner    (1001) docker     (127)    12730 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/spectro/Ge_AtomicScatteringFactors_LBL.txt
+-rw-r--r--   0 runner    (1001) docker     (127)    46941 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/spectro/Ge_AtomicScatteringFactors_NIST.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      273 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/spectro/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18789 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/spectro/_analysis_tools.py
+-rw-r--r--   0 runner    (1001) docker     (127)    52853 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/spectro/_fit12d.py
+-rw-r--r--   0 runner    (1001) docker     (127)    29573 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/spectro/_fit12d_dextract.py
+-rw-r--r--   0 runner    (1001) docker     (127)   100333 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/spectro/_fit12d_dinput.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25979 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/spectro/_fit12d_funccostjac.py
+-rw-r--r--   0 runner    (1001) docker     (127)    73924 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/spectro/_plot.py
+-rw-r--r--   0 runner    (1001) docker     (127)    76274 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/spectro/_rockingcurve.py
+-rw-r--r--   0 runner    (1001) docker     (127)    22149 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/spectro/_rockingcurve_def.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6587 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/spectro/_rockingcurve_tools.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18616 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/spectro/_spectralrange2d.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:39.541701 tofu-1.7.8/tofu/tests/
+-rw-r--r--   0 runner    (1001) docker     (127)      297 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/__init__.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:39.545701 tofu-1.7.8/tofu/tests/tests00_root/
+-rw-r--r--   0 runner    (1001) docker     (127)       29 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests00_root/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4570 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests00_root/test_03_plot.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:39.545701 tofu-1.7.8/tofu/tests/tests01_geom/
+-rw-r--r--   0 runner    (1001) docker     (127)      184 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    78793 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_01_GG.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5832 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_02_compute.py
+-rw-r--r--   0 runner    (1001) docker     (127)   125415 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_03_core.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14230 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_04_core_optics.py
+-rw-r--r--   0 runner    (1001) docker     (127)    16675 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_04_sampling.py
+-rw-r--r--   0 runner    (1001) docker     (127)    19047 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_05_solid_angles.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:39.557701 tofu-1.7.8/tofu/tests/tests01_geom/test_data/
+-rw-r--r--   0 runner    (1001) docker     (127)   218404 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/Inkscape.svg
+-rw-r--r--   0 runner    (1001) docker     (127)      202 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_CoilCS_V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      204 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_CoilPF_Bl_V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      200 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_CoilPF_Bu_V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      510 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_CoilPF_DivLow1_V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      510 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_CoilPF_DivLow2_V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      500 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_CoilPF_DivUp1_V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      500 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_CoilPF_DivUp2_V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      204 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_CoilPF_Dl_V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      200 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_CoilPF_Du_V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      204 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_CoilPF_El_V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      200 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_CoilPF_Eu_V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      204 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_CoilPF_Fl_V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      200 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_CoilPF_Fu_V0.txt
+-rwxr-xr-x   0 runner    (1001) docker     (127)    12294 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_CoilPF_Notes.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     3641 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_Baffle_Notes.py
+-rw-r--r--   0 runner    (1001) docker     (127)      663 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_Baffle_V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     1581 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_Baffle_V1.txt
+-rwxr-xr-x   0 runner    (1001) docker     (127)     8466 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_BumperInner_Notes.py
+-rw-r--r--   0 runner    (1001) docker     (127)      758 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_BumperInner_V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     1667 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_BumperInner_V1.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     4898 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_BumperInner_V2.txt
+-rwxr-xr-x   0 runner    (1001) docker     (127)     9724 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_BumperOuter_Notes.py
+-rw-r--r--   0 runner    (1001) docker     (127)      808 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_BumperOuter_V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     1616 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_BumperOuter_V1.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     4645 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_BumperOuter_V2.txt
+-rwxr-xr-x   0 runner    (1001) docker     (127)     4369 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_DivLowGC_Notes.py
+-rw-r--r--   0 runner    (1001) docker     (127)      204 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_DivLowGC_V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      357 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_DivLowGC_V1.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      816 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_DivLowGC_V2.txt
+-rwxr-xr-x   0 runner    (1001) docker     (127)     5741 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_DivLowITER_Notes.py
+-rw-r--r--   0 runner    (1001) docker     (127)      612 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_DivLowITER_V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     2346 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_DivLowITER_V1.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     7599 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_DivLowITER_V2.txt
+-rwxr-xr-x   0 runner    (1001) docker     (127)     2639 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_DivUp_Notes.py
+-rw-r--r--   0 runner    (1001) docker     (127)      200 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_DivUp_V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      250 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_DivUp_V1.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      400 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_DivUp_V2.txt
+-rwxr-xr-x   0 runner    (1001) docker     (127)     9803 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_IC1_Notes.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1969 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_IC1_V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     6363 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_IC1_V1.txt
+-rwxr-xr-x   0 runner    (1001) docker     (127)     9824 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_IC2_Notes.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1969 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_IC2_V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     6363 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_IC2_V1.txt
+-rwxr-xr-x   0 runner    (1001) docker     (127)     9822 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_IC3_Notes.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1969 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_IC3_V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     6363 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_IC3_V1.txt
+-rwxr-xr-x   0 runner    (1001) docker     (127)    11884 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_LH1_Notes.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1969 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_LH1_V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     6363 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_LH1_V1.txt
+-rwxr-xr-x   0 runner    (1001) docker     (127)    12106 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_LH2_Notes.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1969 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_LH2_V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)     6363 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_LH2_V1.txt
+-rwxr-xr-x   0 runner    (1001) docker     (127)     2335 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_Ripple_Notes.py
+-rw-r--r--   0 runner    (1001) docker     (127)      250 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_Ripple_V0.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      400 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_Ripple_V1.txt
+-rwxr-xr-x   0 runner    (1001) docker     (127)     8060 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PlasmaDomain_Standard_Notes.py
+-rwxr-xr-x   0 runner    (1001) docker     (127)     1358 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_Ves_VesIn_Notes.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5050 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_Ves_VesIn_V0.txt
+-rwxr-xr-x   0 runner    (1001) docker     (127)     1355 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_Ves_VesOut_Notes.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5050 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_Ves_VesOut_V0.txt
+-rwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1396 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/test_data/det37_CTVD_incC4_New.npz
+-rw-r--r--   0 runner    (1001) docker     (127)      534 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests01_geom/testing_tools.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:39.557701 tofu-1.7.8/tofu/tests/tests02_data/
+-rw-r--r--   0 runner    (1001) docker     (127)       65 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests02_data/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    21607 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests02_data/test_03_core.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4831 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests02_data/test_04_spectrallines.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:39.557701 tofu-1.7.8/tofu/tests/tests03_openadas/
+-rw-r--r--   0 runner    (1001) docker     (127)       29 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests03_openadas/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4764 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests03_openadas/test_03_core.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:39.557701 tofu-1.7.8/tofu/tests/tests04_spectro/
+-rw-r--r--   0 runner    (1001) docker     (127)       67 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests04_spectro/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    29371 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests04_spectro/test_01_fit12d.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3383 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests04_spectro/test_02_analysistools.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3303 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests04_spectro/test_03_rockingcurve.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:39.569701 tofu-1.7.8/tofu/tests/tests04_spectro/test_data/
+-rw-r--r--   0 runner    (1001) docker     (127)    54707 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests04_spectro/test_data/TFG_CrystalBragg_ExpWEST_DgXICS_ArXVII_sh00000_Vers1.5.0.npz
+-rw-r--r--   0 runner    (1001) docker     (127)  1592000 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests04_spectro/test_data/UV_spectra_sh55506.npz
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests04_spectro/test_data/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    38498 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests04_spectro/test_data/_lines_database.py
+-rw-r--r--   0 runner    (1001) docker     (127)  4287706 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests04_spectro/test_data/_mask_54041.npz
+-rw-r--r--   0 runner    (1001) docker     (127)     5561 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests04_spectro/test_data/_spectral_constraints.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1396 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests04_spectro/test_data/det37_CTVD_incC4_New.npz
+-rw-r--r--   0 runner    (1001) docker     (127)    43500 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests04_spectro/test_data/spectral_fit.npz
+-rw-r--r--   0 runner    (1001) docker     (127) 23594389 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests04_spectro/test_data/west_54046_xics.npz
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:39.597701 tofu-1.7.8/tofu/tests/tests05_nist/
+-rw-r--r--   0 runner    (1001) docker     (127)       29 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests05_nist/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2804 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests05_nist/test_03_core.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:39.597701 tofu-1.7.8/tofu/tests/tests06_mesh/
+-rw-r--r--   0 runner    (1001) docker     (127)       31 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests06_mesh/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    25579 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests06_mesh/test_01_checks.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:39.597701 tofu-1.7.8/tofu/tests/tests06_mesh/test_data/
+-rw-r--r--   0 runner    (1001) docker     (127)   163954 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests06_mesh/test_data/ITER_JINTRAC_sh134000_run30_public_edgesources_quadtrimesh.npz
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests06_mesh/test_data/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)  1584667 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests06_mesh/test_data/mesh_triangular_WEST_eq.txt
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:39.597701 tofu-1.7.8/tofu/tests/tests07_inversions/
+-rw-r--r--   0 runner    (1001) docker     (127)       34 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests07_inversions/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     7436 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests07_inversions/test_01_isotropic.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:39.597701 tofu-1.7.8/tofu/tests/tests08_diagnostics/
+-rw-r--r--   0 runner    (1001) docker     (127)       36 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests08_diagnostics/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)    14892 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests08_diagnostics/test_01_diagnostics.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:39.601701 tofu-1.7.8/tofu/tests/tests09_tutorials/
+-rw-r--r--   0 runner    (1001) docker     (127)       27 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests09_tutorials/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     4938 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests09_tutorials/test_01_runall.py
+-rw-r--r--   0 runner    (1001) docker     (127)     2199 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests09_tutorials/tuto_plot_basic.py
+-rw-r--r--   0 runner    (1001) docker     (127)     6540 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests09_tutorials/tuto_plot_create_geometry.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3030 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests09_tutorials/tuto_plot_create_geometry_from_svg.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3175 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests09_tutorials/tuto_plot_custom_emissivity.py
+-rw-r--r--   0 runner    (1001) docker     (127)     1503 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests09_tutorials/tuto_plot_gallery_fusion_machines.py
+-rw-r--r--   0 runner    (1001) docker     (127)     3835 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests09_tutorials/tuto_plot_solid_angles.py
+-rw-r--r--   0 runner    (1001) docker     (127)    18672 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tests/tests09_tutorials/tuto_real0.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:39.601701 tofu-1.7.8/tofu/tomotok2tofu/
+-rw-r--r--   0 runner    (1001) docker     (127)      480 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tomotok2tofu/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5497 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/tomotok2tofu/_core.py
+-rw-r--r--   0 runner    (1001) docker     (127)   157477 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu/utils.py
+-rw-r--r--   0 runner    (1001) docker     (127)       79 2024-05-31 16:09:39.000000 tofu-1.7.8/tofu/version.py
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:39.465701 tofu-1.7.8/tofu.egg-info/
+-rw-r--r--   0 runner    (1001) docker     (127)    12222 2024-05-31 16:09:39.000000 tofu-1.7.8/tofu.egg-info/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (127)    24927 2024-05-31 16:09:39.000000 tofu-1.7.8/tofu.egg-info/SOURCES.txt
+-rw-r--r--   0 runner    (1001) docker     (127)        1 2024-05-31 16:09:39.000000 tofu-1.7.8/tofu.egg-info/dependency_links.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      211 2024-05-31 16:09:39.000000 tofu-1.7.8/tofu.egg-info/entry_points.txt
+-rw-r--r--   0 runner    (1001) docker     (127)      175 2024-05-31 16:09:39.000000 tofu-1.7.8/tofu.egg-info/requires.txt
+-rw-r--r--   0 runner    (1001) docker     (127)       53 2024-05-31 16:09:39.000000 tofu-1.7.8/tofu.egg-info/top_level.txt
+drwxr-xr-x   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:39.601701 tofu-1.7.8/tofu_helpers/
+-rw-r--r--   0 runner    (1001) docker     (127)        0 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu_helpers/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (127)     5064 2024-05-31 16:09:13.000000 tofu-1.7.8/tofu_helpers/openmp_helpers.py
```

### Comparing `tofu-1.7.7/LICENSE.txt` & `tofu-1.7.8/LICENSE.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/MANIFEST.in` & `tofu-1.7.8/MANIFEST.in`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/PKG-INFO` & `tofu-1.7.8/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: tofu
-Version: 1.7.7
+Version: 1.7.8
 Summary: A python library for Tomography for Fusion
 Home-page: https://github.com/ToFuProject/tofu
 Author: Didier VEZINET and Laura MENDOZA
 Author-email: didier.vezinet@gmail.com
 License: MIT
 Keywords: tomography geometry 3D inversion synthetic fusion
 Platform: UNKNOWN
```

### Comparing `tofu-1.7.7/README.md` & `tofu-1.7.8/README.md`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/_updateversion.py` & `tofu-1.7.8/_updateversion.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/inputs_temp/XICS_allshots_C34.py` & `tofu-1.7.8/inputs_temp/XICS_allshots_C34.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/inputs_temp/dlines.py` & `tofu-1.7.8/inputs_temp/dlines.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/scripts/_dparser.py` & `tofu-1.7.8/scripts/_dparser.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/scripts/tofu_bash.py` & `tofu-1.7.8/scripts/tofu_bash.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/scripts/tofucustom.py` & `tofu-1.7.8/scripts/tofucustom.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/scripts/tofuversion.py` & `tofu-1.7.8/scripts/tofuversion.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/setup.py` & `tofu-1.7.8/setup.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/__init__.py` & `tofu-1.7.8/tofu/__init__.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/_physics.py` & `tofu-1.7.8/tofu/_physics.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/_plot.py` & `tofu-1.7.8/tofu/_plot.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/benchmarks/benchmarks_00_Geometry_peakmem.py` & `tofu-1.7.8/tofu/benchmarks/benchmarks_00_Geometry_peakmem.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/benchmarks/benchmarks_00_Geometry_time.py` & `tofu-1.7.8/tofu/benchmarks/benchmarks_00_Geometry_time.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/benchmarks/benchmarks_01_Mesh2D_peakmem.py` & `tofu-1.7.8/tofu/benchmarks/benchmarks_01_Mesh2D_peakmem.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/benchmarks/benchmarks_01_Mesh2D_time.py` & `tofu-1.7.8/tofu/benchmarks/benchmarks_01_Mesh2D_time.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/benchmarks/benchmarks_02_spectralfit_peakmem.py` & `tofu-1.7.8/tofu/benchmarks/benchmarks_02_spectralfit_peakmem.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/benchmarks/benchmarks_02_spectralfit_time.py` & `tofu-1.7.8/tofu/benchmarks/benchmarks_02_spectralfit_time.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/benchmarks/benchmarks_03_solidangles.py` & `tofu-1.7.8/tofu/benchmarks/benchmarks_03_solidangles.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_DataCollection_check_inputs.py` & `tofu-1.7.8/tofu/data/_DataCollection_check_inputs.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_DataCollection_class0_Base.py` & `tofu-1.7.8/tofu/data/_DataCollection_class0_Base.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_DataCollection_class1_interactivity.py` & `tofu-1.7.8/tofu/data/_DataCollection_class1_interactivity.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_DataCollection_comp.py` & `tofu-1.7.8/tofu/data/_DataCollection_comp.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_DataCollection_interactivity.py` & `tofu-1.7.8/tofu/data/_DataCollection_interactivity.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_DataCollection_plot_as_array.py` & `tofu-1.7.8/tofu/data/_DataCollection_plot_as_array.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_DataCollection_plot_misc.py` & `tofu-1.7.8/tofu/data/_DataCollection_plot_misc.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_DataCollection_plot_text.py` & `tofu-1.7.8/tofu/data/_DataCollection_plot_text.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class00_Config.py` & `tofu-1.7.8/tofu/data/_class00_Config.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class01_Plasma2D.py` & `tofu-1.7.8/tofu/data/_class01_Plasma2D.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class01_compute.py` & `tofu-1.7.8/tofu/data/_class01_compute.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class01_eqdsk.py` & `tofu-1.7.8/tofu/data/_class01_eqdsk.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class02_Rays.py` & `tofu-1.7.8/tofu/data/_class02_Rays.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class02_save2stp.py` & `tofu-1.7.8/tofu/data/_class02_save2stp.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class03_Aperture.py` & `tofu-1.7.8/tofu/data/_class03_Aperture.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class04_Filter.py` & `tofu-1.7.8/tofu/data/_class04_Filter.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class05_Crystal.py` & `tofu-1.7.8/tofu/data/_class05_Crystal.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class05_legacy.py` & `tofu-1.7.8/tofu/data/_class05_legacy.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class06_Grating.py` & `tofu-1.7.8/tofu/data/_class06_Grating.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class06_compute.py` & `tofu-1.7.8/tofu/data/_class06_compute.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class07_Camera.py` & `tofu-1.7.8/tofu/data/_class07_Camera.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class07_legacy.py` & `tofu-1.7.8/tofu/data/_class07_legacy.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class08_Diagnostic.py` & `tofu-1.7.8/tofu/data/_class08_Diagnostic.py`

 * *Files 2% similar despite different names*

```diff
@@ -9,14 +9,16 @@
 import numpy as np
 
 
 # tofu
 from ._class07_Camera import Camera as Previous
 from . import _class8_check as _check
 from . import _class8_compute as _compute
+from . import _class08_get_data as _get_data
+from . import _class08_concatenate_data as _concatenate
 from . import _class8_move as _move
 from . import _class8_los_data as _los_data
 from . import _class8_equivalent_apertures as _equivalent_apertures
 from . import _class8_etendue_los as _etendue_los
 from . import _class8_vos as _vos
 from . import _class8_vos_spectro_nobin_at_lamb as _vos_nobin_at_lamb
 from . import _class8_los_angles as _los_angles
@@ -153,14 +155,15 @@
         self,
         key=None,
         key_cam=None,
         data=None,
         rocking_curve=None,
         units=None,
         default=None,
+        print_full_doc=None,
         **kwdargs,
         ):
         """ Return dict of data for chosen cameras
 
         data can be:
             'etendue'
             'amin'
@@ -168,37 +171,38 @@
             'tangency radius'
             'lamb'
             'lambmin'
             'lambmax'
             'res'
 
         """
-        return _compute._get_data(
+        return _get_data._get_data(
             coll=self,
             key=key,
             key_cam=key_cam,
             data=data,
             rocking_curve=rocking_curve,
             units=units,
             default=default,
+            print_full_doc=print_full_doc,
             **kwdargs,
         )
 
     def get_diagnostic_data_concatenated(
         self,
         key=None,
         key_data=None,
         key_cam=None,
         flat=None,
-        ):
+    ):
         """ Return concatenated data for chosen cameras
 
 
         """
-        return _compute._concatenate_data(
+        return _concatenate._concatenate_data(
             coll=self,
             key=key,
             key_data=key_data,
             key_cam=key_cam,
             flat=flat,
         )
 
@@ -268,15 +272,15 @@
             debug=debug,
         )
 
         # compute los angles
         c0 = (
             any([np.any(np.isfinite(v0['los_x'])) for v0 in dcompute.values()])
             and store
-            )
+        )
         if c0:
             _los_angles.compute_los_angles(
                 coll=self,
                 key=key,
                 # los
                 config=config,
                 length=length,
@@ -1318,17 +1322,25 @@
 
     def plot_diagnostic_geometrical_coverage(
         self,
         key=None,
         # mesh sampling
         key_mesh=None,
         res_RZ=None,
+        nan0=None,
         # plotting options
         plot_config=None,
         dcolor=None,
+        dax=None,
+        fs=None,
+        dmargin=None,
+        tit=None,
+        cmap=None,
+        vmin=None,
+        vmax=None,
     ):
         """ Plot the geometrical coverage of a diagnostic, in a cross-section
 
 
         Parameters
         ----------
         key : str, optional
@@ -1351,17 +1363,25 @@
 
         return _plot_coverage.main(
             coll=self,
             key=key,
             # mesh sampling
             key_mesh=key_mesh,
             res_RZ=res_RZ,
+            nan0=nan0,
             # plotting options
             config=plot_config,
             dcolor=dcolor,
+            cmap=cmap,
+            vmin=vmin,
+            vmax=vmax,
+            dax=dax,
+            fs=fs,
+            dmargin=dmargin,
+            tit=tit,
         )
 
     # --------------------------
     # save to stp
     # --------------------------
 
     def save_diagnostic_to_stp(
```

### Comparing `tofu-1.7.7/tofu/data/_class08_save2stp.py` & `tofu-1.7.8/tofu/data/_class08_save2stp.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class09_GeometryMatrix.py` & `tofu-1.7.8/tofu/data/_class09_GeometryMatrix.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class09_compute_broadband.py` & `tofu-1.7.8/tofu/data/_class09_compute_broadband.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class10_Inversion.py` & `tofu-1.7.8/tofu/data/_class10_Inversion.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class10_algos.py` & `tofu-1.7.8/tofu/data/_class10_algos.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class10_checks.py` & `tofu-1.7.8/tofu/data/_class10_checks.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class10_compute.py` & `tofu-1.7.8/tofu/data/_class10_compute.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class10_plot.py` & `tofu-1.7.8/tofu/data/_class10_plot.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class10_refs.py` & `tofu-1.7.8/tofu/data/_class10_refs.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class2_check.py` & `tofu-1.7.8/tofu/data/_class2_check.py`

 * *Files 1% similar despite different names*

```diff
@@ -197,15 +197,17 @@
         vect_y = vect_y / norm
         vect_z = vect_z / norm
 
         if shref is None:
             shref = vect_x.shape
         elif vect_x.shape not in [(1,), shref]:
             msg = (
-                f"Arg vect_x has inconsistent shape {pts_x.shape} vs {shref}"
+                "Arg vect_x has inconsistent shape:\n"
+                f"\t- vect_x.shape = {vect_x.shape}\n"
+                f"\t- vs shape ref: {shref}\n"
             )
             raise Exception(msg)
 
     # ----------
     # config
 
     # ---------
@@ -1009,8 +1011,8 @@
     # remove data
 
     coll.remove_data(ld, propagate=True)
 
     # -----------
     # remove rays
 
-    del coll._dobj['rays'][key]
+    del coll._dobj['rays'][key]
```

### Comparing `tofu-1.7.7/tofu/data/_class2_compute.py` & `tofu-1.7.8/tofu/data/_class2_compute.py`

 * *Files 2% similar despite different names*

```diff
@@ -503,16 +503,16 @@
     # key
     key = _check._check_key(coll=coll, key=key, key_cam=key_cam)
 
     # quantity
     quantity = ds._generic_check._check_var(
         quantity, 'quantity',
         types=str,
-        default='tangency radius',
-        allowed=['alpha', 'tangency radius', 'length'],
+        default='tangency_radius',
+        allowed=['alpha', 'tangency_radius', 'length'],
     )
 
     # lim_to_segments
     lim_to_segments = ds._generic_check._check_var(
         lim_to_segments, 'lim_to_segments',
         types=bool,
         default=False,
@@ -521,15 +521,15 @@
     # segment
     if segment is not None:
         segment = np.atleast_1d(segment).astype(int).ravel()
 
     # --------
     # tangency radius-specific
 
-    if quantity == 'tangency radius':
+    if quantity == 'tangency_radius':
         # axis_pt
         if axis_pt is None:
             axis_pt = [0., 0., 0.]
 
         axis_pt = ds._generic_check._check_flat1darray(
             axis_pt, 'axis_pt',
             dtype=float,
@@ -577,15 +577,15 @@
 
 
     # define vectors
     ABx = np.diff(pts_x, axis=0)
     ABy = np.diff(pts_y, axis=0)
     ABz = np.diff(pts_z, axis=0)
 
-    if quantity == 'tangency radius':
+    if quantity == 'tangency_radius':
         AOx = axis_pt[0] - pts_x[:-1, ...]
         AOy = axis_pt[1] - pts_y[:-1, ...]
         AOz = axis_pt[2] - pts_z[:-1, ...]
 
         # --------
         # get kk
 
@@ -676,15 +676,15 @@
          axis_pt=axis_pt,
          axis_vect=axis_vect,
     )
 
     # --------
     # radius
 
-    if quantity == 'tangency radius':
+    if quantity == 'tangency_radius':
         kk = np.zeros(ABx.shape, dtype=float)
         iok = ABvn2 > 0.
         kk[iok] = -B[iok] / ABvn2[iok]
 
         # ------------------------
         # lim_to_segments
 
@@ -744,15 +744,15 @@
 
     (
      key, quantity, segment, lim_to_segments, axis_pt, axis_vect,
      ) = _tangency_radius_check(
          coll=coll,
          key=key,
          key_cam=key_cam,
-         quantity='tangency radius',
+         quantity='tangency_radius',
          axis_pt=axis_pt,
          axis_vect=axis_vect,
          segment=segment,
          lim_to_segments=lim_to_segments,
     )
 
     # axis_radius
@@ -898,8 +898,8 @@
     if return_pts is True and return_itot is True:
         return k0, k1, iok, px, py, pz, itot
     elif return_pts is True:
         return k0, k1, iok, px, py, pz
     elif return_itot is True:
         return k0, k1, iok, itot
     else:
-        return k0, k1, iok
+        return k0, k1, iok
```

### Comparing `tofu-1.7.7/tofu/data/_class2_plot.py` & `tofu-1.7.8/tofu/data/_class2_plot.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class2_sinogram.py` & `tofu-1.7.8/tofu/data/_class2_sinogram.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class3_check.py` & `tofu-1.7.8/tofu/data/_class3_check.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class4_check.py` & `tofu-1.7.8/tofu/data/_class4_check.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class5_check.py` & `tofu-1.7.8/tofu/data/_class5_check.py`

 * *Files 2% similar despite different names*

```diff
@@ -49,26 +49,26 @@
 
     # not mat
     if dmat is None:
         return dmat
 
     # If using hardcoded known crystal
     err = False
+    lk = ['name', 'material', 'miller', 'target']
+    lrockkey = sorted(_rockingcurve_def._DCRYST.keys())
     if isinstance(dmat, str):
-        if dmat not in _rockingcurve_def._DCRYST.keys():
+        if dmat not in lrockkey:
             msg = (
                 f"Arg dmat points to an unknown crystal: '{dmat}'"
             )
             raise Exception(msg)
         dmat = _rockingcurve_def._DCRYST[dmat]
         ready_to_compute = True
 
     elif isinstance(dmat, dict):
-        lk = ['name', 'material', 'miller', 'target']
-
         if isinstance(dmat.get('drock'), dict):
             if not isinstance(dmat.get('d_hkl'), float):
                 msg = (
                     "If dmat is provided as a dict with 'drock' "
                     "(user-provided rocking curve), "
                     "it must also have:\n"
                     "\t- 'd_hkl': float\n"
@@ -85,15 +85,23 @@
             err = True
 
     else:
         err = True
 
     # Raise error
     if err is True:
-        msg = f"Don't know how to interpret dmat for crystal '{key}':\n{dmat}"
+        lstr = [f"\t\t. {k0}" for k0 in lk]
+        msg = (
+            f"Don't know how to interpret dmat for crystal '{key}':\n"
+            "Expected:\n"
+            "\t- str: key to an existing known rocking curve: {lrockkey}\n"
+            "\t- dict with:\n"
+            + "\n".join(lstr)
+            + f"\nProvided:\n{dmat}\n"
+        )
         raise Exception(msg)
 
     dmat['ready_to_compute'] = ready_to_compute
 
     # ---------------------
     # check dict integrity
     # ---------------------
```

### Comparing `tofu-1.7.7/tofu/data/_class5_compute.py` & `tofu-1.7.8/tofu/data/_class5_compute.py`

 * *Files 0% similar despite different names*

```diff
@@ -87,15 +87,15 @@
     # rocking_curve
     dmat = coll.dobj['crystal'][key]['dmat']
     lok = [False]
     if dmat is None or dmat.get('drock', {}).get('delta_bragg') is None:
         defrock = False
         lok = (False,)
     else:
-        defrock = True
+        defrock = False
         lok = (False, True)
 
     rocking_curve = ds._generic_check._check_var(
         rocking_curve, 'rocking_curve',
         types=bool,
         default=defrock,
         allowed=lok,
```

### Comparing `tofu-1.7.7/tofu/data/_class5_coordinates.py` & `tofu-1.7.8/tofu/data/_class5_coordinates.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class5_plot.py` & `tofu-1.7.8/tofu/data/_class5_plot.py`

 * *Files 8% similar despite different names*

```diff
@@ -46,29 +46,32 @@
     drock = coll.dobj['crystal'][key]['dmat']['drock']
     is2d = drock.get('Tref') is not None
 
     # color
     if color is None:
         color = 'k'
 
-    # T
-    if T is not None:
-        T = ds._generic_check._check_var(
-            T, 'T',
-            types=(int, float),
-            sign='>0',
-        )
-
     # -----------
     # plot
 
     # is2d
     if is2d:
 
-        if T is not None:
+        if T is False:
+            T = drock['Tref']
+            bragg = None
+            is2d = False
+
+        elif T is not None:
+            T = ds._generic_check._check_var(
+                T, 'T',
+                types=(int, float),
+                sign='>0',
+            )
+
             T0 = coll.ddata[drock['T']]['data']
             braggT = coll.ddata[drock['braggT']]['data']
             indT = np.argmin(np.abs(T0 - T))
             bragg = braggT[indT]
             is2d = False
 
         else:
@@ -83,18 +86,19 @@
 
     else:
         T = None
 
     # not is2d
     if is2d is False:
 
-        bragg = coll.get_crystal_bragglamb(
-            key=key,
-            rocking_curve=False,
-        )[0][0]
+        if bragg is None:
+            bragg = coll.get_crystal_bragglamb(
+                key=key,
+                rocking_curve=False,
+            )[0][0]
 
         return _plot_rc_1d(
             key=key,
             coll=coll,
             drock=drock,
             bragg=bragg,
             T=None,
@@ -125,14 +129,17 @@
 
     # -------
     # check
 
     if plot_FW is None:
         plot_FW = True
 
+    if issubclass(dax.__class__, plt.Axes):
+        dax = {'rc': {'handle': dax, 'type': 'matrix'}}
+
     # ----------
     # prepare
 
     lamb = coll.dobj['crystal'][key]['dmat']['target']['lamb']
     angle_rel = coll.ddata[drock['angle_rel']]['data']
     power_ratio = coll.ddata[drock['power_ratio']]['data']
     delta_bragg = drock['delta_bragg']
```

### Comparing `tofu-1.7.7/tofu/data/_class5_projections.py` & `tofu-1.7.8/tofu/data/_class5_projections.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class5_reflections_pts2pt.py` & `tofu-1.7.8/tofu/data/_class5_reflections_pts2pt.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class5_reflections_ptsvect.py` & `tofu-1.7.8/tofu/data/_class5_reflections_ptsvect.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class7_check.py` & `tofu-1.7.8/tofu/data/_class7_check.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class7_compute.py` & `tofu-1.7.8/tofu/data/_class7_compute.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class8_check.py` & `tofu-1.7.8/tofu/data/_class8_check.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class8_compute.py` & `tofu-1.7.8/tofu/data/_class8_reverse_ray_tracing.py`

 * *Files 22% similar despite different names*

```diff
@@ -1,1973 +1,1834 @@
-# -*- coding: utf-8 -*-
-
-
-import copy
-import itertools as itt
 
 
 import numpy as np
 import scipy.interpolate as scpinterp
+import scipy.stats as scpstats
+import Polygon as plg
+from matplotlib.path import Path
 import matplotlib.pyplot as plt
-import matplotlib.colors as mcolors
-
-
+import matplotlib.gridspec as gridspec
+from mpl_toolkits.mplot3d import Axes3D
 import datastock as ds
 
 
-from . import _utils_surface3d
-from . import _spectralunits
+from . import _class8_equivalent_apertures as _equivalent_apertures
+from . import _class8_plot
+from . import _generic_check
+from . import _class8_vos_utilities as _utilities
 
 
-# ##################################################################
-# ##################################################################
-#                   optics outline
-# ##################################################################
+# ################################################
+# ################################################
+#               main
+# ################################################
 
 
-def get_optics_outline(
+def _from_pts(
     coll=None,
+    # diag
     key=None,
-    add_points=None,
+    key_cam=None,
+    # mesh sampling
+    key_mesh=None,
+    res_RZ=None,
+    res_phi=None,
+    # pts coordinates
+    ptsx=None,
+    ptsy=None,
+    ptsz=None,
+    # res
+    n0=None,
+    n1=None,
     min_threshold=None,
-    mode=None,
-    closed=None,
-    ravel=None,
-    total=None,
+    # optional lamb
+    lamb0=None,
+    res_lamb=None,
+    rocking_curve=None,
+    res_rock_curve=None,
+    # options
+    append=None,
+    plot=None,
+    plot_pixels=None,
+    plot_config=None,
+    plot_rays=None,
+    vmin=None,
+    vmax=None,
+    aspect3d=None,
+    elements=None,
+    colorbar=None,
+    # options
+    dax=None,
+    fs=None,
+    dmargin=None,
+    wintit=None,
 ):
 
-    # ------------
+    # -------------
     # check inputs
 
-    # key, cls
-    key, cls = coll.get_optics_cls(optics=key)
-    key, cls = key[0], cls[0]
-    dgeom = coll.dobj[cls][key]['dgeom']
-
-    # total
-    total = ds._generic_check._check_var(
-        total, 'total',
-        types=bool,
-        default=(cls == 'camera' and dgeom['nd'] == '2d'),
+    (
+        key, key_cam, key_mesh,
+        dsamp, res_phi,
+        shape, iok,
+        ptsx, ptsy, ptsz, phi,
+        lamb0, rocking_curve,
+        append, plot, plot_pixels, colorbar,
+    ) = _check(
+        coll=coll,
+        # diag
+        key=key,
+        key_cam=key_cam,
+        # mesh sampling
+        key_mesh=key_mesh,
+        res_RZ=res_RZ,
+        res_phi=res_phi,
+        # pts coordinates
+        ptsx=ptsx,
+        ptsy=ptsy,
+        ptsz=ptsz,
+        # optional lamb
+        lamb0=lamb0,
+        rocking_curve=rocking_curve,
+        # options
+        append=append,
+        plot=plot,
+        plot_pixels=plot_pixels,
+        colorbar=colorbar,
     )
-    if cls == 'camera' and dgeom['nd'] != '2d':
-        total = False
 
-    # --------
-    # compute
-
-    if dgeom['type'] == '3d':
-        return None, None
-
-    if cls == 'camera' and total:
-        # get centers
-        cx0, cx1 = dgeom['cents']
-        cx0 = coll.ddata[cx0]['data']
-        cx1 = coll.ddata[cx1]['data']
-
-        k0, k1 = dgeom['outline']
-
-        # derive half-spacing
-        if cx0.size == 1:
-            dx0 = coll.ddata[k0]['data'].max() - coll.ddata[k0]['data'].min()
-        else:
-            dx0 = np.mean(np.diff(cx0))
-
-        if cx1.size == 1:
-            dx1 = coll.ddata[k1]['data'].max() - coll.ddata[k1]['data'].min()
-        else:
-            dx1 = np.mean(np.diff(cx1))
+    # ----------------------
+    # prepare optics, camera
 
-        # half
-        dx0, dx1 = 0.5*dx0, 0.5*dx1
-
-        # derive global outline (not pixel outline)
-        p0 = np.r_[
-            cx0[0] - dx0, cx0[-1] + dx0,
-            cx0[-1] + dx0, cx0[0] - dx0,
-        ]
-        p1 = np.r_[
-            cx1[0] - dx1, cx1[0] - dx1,
-            cx1[-1] + dx1, cx1[-1] + dx1,
-        ]
-
-    else:
-        out = dgeom['outline']
-        p0 = coll.ddata[out[0]]['data']
-        p1 = coll.ddata[out[1]]['data']
-
-    # -----------
-    # add_points
-
-    if add_points is None:
-        if cls == 'camera':
-            add_points = 0
-        else:
-            if dgeom['type'] == 'planar':
-                add_points = 0
-            else:
-                add_points = 3
-
-    return _interp_poly(
-        lp=[p0, p1],
-        add_points=add_points,
-        mode=mode,
-        isclosed=False,
-        closed=closed,
-        ravel=ravel,
-        min_threshold=min_threshold,
-        debug=None,
+    (
+        kspectro,
+        lpoly_post,
+        p0x, p0y, p0z,
+        nin, e0, e1,
+        ptsvect_plane,
+        ptsvect_spectro,
+        ptsvect_cam,
+        coords_x01toxyz_plane,
+        cent,
+        cent_cam,
+        dist_to_cam,
+        pix_size,
+        cbin0, cbin1,
+    ) = _prepare_optics(
+        coll=coll,
+        key=key,
+        key_cam=key_cam,
     )
+    shape_cam = coll.dobj['camera'][key_cam]['dgeom']['shape']
 
+    # -------------------------------------
+    # prepare lambda, angles, rocking_curve
 
-# ################################################################
-# ################################################################
-#                   optics poly
-# ################################################################
-
-
-def get_optics_poly(
-    coll=None,
-    key=None,
-    add_points=None,
-    min_threshold=None,
-    mode=None,
-    closed=None,
-    ravel=None,
-    total=None,
-    return_outline=None,
-):
-
-    # ------------
-    # check inputs
-
-    key, cls = coll.get_optics_cls(optics=key)
-    key, cls = key[0], cls[0]
+    (
+        nlamb,
+        lamb,
+        dlamb,
+        pow_interp,
+        ang_rel,
+        dang,
+        bragg,
+    ) = _prepare_lamb(
+        coll=coll,
+        key_diag=key,
+        key_cam=key_cam,
+        kspectro=kspectro,
+        lamb=lamb0,
+        res_lamb=res_lamb,
+        rocking_curve=rocking_curve,
+        res_rock_curve=res_rock_curve,
+        verb=False,
+    )
+
+    # -------------------
+    # wavelength specific
+
+    if lamb is not None:
+
+        # -------
+        # prepare lamb per pixel
+
+        lamb_per_pix = coll.get_diagnostic_data(
+            key,
+            key_cam=key_cam,
+            data='lamb',
+        )[0][key_cam]
+
+        bragg_per_pix = coll.get_crystal_bragglamb(
+            key=kspectro,
+            lamb=lamb_per_pix,
+        )[0]
 
-    return_outline = ds._generic_check._check_var(
-        return_outline, 'return_outline',
-        types=bool,
-        default=False,
-    )
+    # --------------
+    # prepare output
 
-    ravel = ds._generic_check._check_var(
-        ravel, 'ravel',
-        default=False,
-        types=bool,
-    )
+    if key_mesh is None:
+        func = _loop0
+    else:
+        func = _loop1
 
-    # --------
+    # -------------
     # compute
 
-    dgeom = coll.dobj[cls][key]['dgeom']
-    if cls in ['aperture', 'filter', 'crystal', 'grating']:
-
-        if dgeom['type'] != '3d':
-            p0, p1 = coll.get_optics_outline(
-                key=key,
-                add_points=add_points,
-                min_threshold=min_threshold,
-                mode=mode,
-                closed=closed,
-                ravel=ravel,
-                total=total,
-            )
+    dout = func(**locals())
+    dout['rocking_curve'] = rocking_curve
 
-            px, py, pz = _utils_surface3d._get_curved_poly(
-                gtype=dgeom['type'],
-                outline_x0=p0,
-                outline_x1=p1,
-                curve_r=dgeom['curve_r'],
-                cent=dgeom['cent'],
-                nin=dgeom['nin'],
-                e0=dgeom['e0'],
-                e1=dgeom['e1'],
-            )
+    # -------
+    # reshape
 
-        else:
-            px, py, pz = dgeom['poly']
-            px = coll.ddata[px]['data']
-            py = coll.ddata[py]['data']
-            pz = coll.ddata[pz]['data']
+    if len(shape) > 1:
+        shape_new = tuple(np.r_[shape_cam, shape])
+        for k0 in ['sang']:
+            dout[k0] = dout[k0].reshape(shape_new)
+        for k0 in ['sang0']:
+            dout[k0] = dout[k0].reshape(shape_new)
 
-    elif cls == 'camera':
+    # -------
+    # plot
 
-        p0, p1 = coll.get_optics_outline(
+    if plot is True:
+        _plot(
+            coll=coll,
             key=key,
-            add_points=add_points,
-            min_threshold=min_threshold,
-            mode=mode,
-            closed=closed,
-            ravel=ravel,
-            total=total,
+            key_cam=key_cam,
+            dout=dout,
+            cbin0=cbin0,
+            cbin1=cbin1,
+            # options
+            plot_config=plot_config,
+            plot_pixels=plot_pixels,
+            vmin=vmin,
+            vmax=vmax,
+            aspect3d=aspect3d,
+            elements=elements,
+            colorbar=colorbar,
+            # options
+            dax=dax,
+            fs=fs,
+            dmargin=dmargin,
+            wintit=wintit,
         )
 
-        # vectors
-        dv = coll.get_camera_unit_vectors(key)
-        lv = ['e0_x', 'e0_y', 'e0_z', 'e1_x', 'e1_y', 'e1_z']
-        e0x, e0y, e0z, e1x, e1y, e1z = [dv[k0] for k0 in lv]
-        if not np.isscalar(e0x):
-            e0x = e0x[:, None]
-            e0y = e0y[:, None]
-            e0z = e0z[:, None]
-            e1x = e1x[:, None]
-            e1y = e1y[:, None]
-            e1z = e1z[:, None]
-
-        if dgeom['nd'] == '2d' and total:
-            cx, cy, cz = dgeom['cent']
-            p02, p12 = p0, p1
-        else:
-            cx, cy, cz = coll.get_camera_cents_xyz(key)
-            shape = [1 for ii in range(cx.ndim)] + [p0.size]
-            cx, cy, cz = cx[..., None], cy[..., None], cz[..., None]
-            p02 = p0.reshape(shape)
-            p12 = p1.reshape(shape)
-
-        # make 3d
-        px = cx + p02 * e0x + p12 * e1x
-        py = cy + p02 * e0y + p12 * e1y
-        pz = cz + p02 * e0z + p12 * e1z
-
-    # ----------
-    # ravel
-
-    if ravel is True and px.ndim > 1:
-        nan = np.full(tuple(np.r_[px.shape[:-1], 1]), np.nan)
-        px = np.concatenate((px, nan), axis=-1).ravel()
-        py = np.concatenate((py, nan), axis=-1).ravel()
-        pz = np.concatenate((pz, nan), axis=-1).ravel()
-
-    # return
-    if return_outline is True:
-        return p0, p1, px, py, pz
-    else:
-        return px, py, pz
+    return dout
 
 
-# ##################################################################
-# ##################################################################
-#           optics as input dict for solid angle computation
-# ##################################################################
+# ################################################
+# ################################################
+#               check
+# ################################################
 
 
-def get_optics_as_input_solid_angle(
+def _check(
     coll=None,
-    keys=None,
+    # diag
+    key=None,
+    key_cam=None,
+    # mesh sampling
+    key_mesh=None,
+    res_RZ=None,
+    res_phi=None,
+    # pts coordinates
+    ptsx=None,
+    ptsy=None,
+    ptsz=None,
+    # optional lamb
+    lamb0=None,
+    rocking_curve=None,
+    # bool
+    append=None,
+    plot=None,
+    plot_pixels=None,
+    colorbar=None,
 ):
 
-    # ------------
-    # check inputs
+    # --------
+    # key
 
-    if isinstance(keys, str):
-        keys = [keys]
+    # key
+    lok = [
+        k0 for k0, v0 in coll._dobj.get('diagnostic', {}).items()
+        if v0['spectro'] is True
+    ]
+    key = ds._generic_check._check_var(
+        key, 'key',
+        types=str,
+        allowed=lok,
+    )
 
-    lap = list(coll.dobj.get('aperture', {}).keys())
-    lfilt = list(coll.dobj.get('filter', {}).keys())
-    lcryst = list(coll.dobj.get('crystal', {}).keys())
-    lgrat = list(coll.dobj.get('grating', {}).keys())
-
-    lok = lap + lfilt + lcryst + lgrat
-
-    keys = ds._generic_check._check_var_iter(
-        keys, 'keys',
-        types=(list, tuple),
-        types_iter=str,
+    # key_cam
+    lok = list(coll.dobj['diagnostic'][key]['doptics'].keys())
+    key_cam = ds._generic_check._check_var(
+        key_cam, 'key_cam',
+        types=str,
         allowed=lok,
     )
 
-    # -----------
-    # prepare
+    # ----------------------------
+    # coordinates vs mesh sampling
 
-    # get classes
-    lcls = coll.get_optics_cls(keys)[1]
+    lc = [
+        key_mesh is not None,
+        ptsx is not None
+    ]
+    if np.sum(lc) != 1:
+        msg = "Please provide key_mesh xor (ptsx, ptsy, ptsz)\n"
+        raise Exception(msg)
 
-    # ------------------
-    # build list of dict
+    if lc[0]:
 
-    dap = {}
-    for ii, k0 in enumerate(keys):
+        lok = list(coll.dobj.get('mesh', {}).keys())
+        key_mesh = ds._generic_check._check_var(
+            key_mesh, 'key_mesh',
+            types=str,
+            allowed=lok,
+        )
 
-        poly_x, poly_y, poly_z = coll.get_optics_poly(k0)
+        dsamp = coll.get_sample_mesh(
+            key=key_mesh,
+            res=res_RZ,
+            mode='abs',
+            grid=True,
+            in_mesh=True,
+            # non-used
+            x0=None,
+            x1=None,
+            Dx0=None,
+            Dx1=None,
+            imshow=False,
+            store=False,
+            kx0=None,
+            kx1=None,
+        )
 
-        dap[k0] = {
-            'poly_x': poly_x,
-            'poly_y': poly_y,
-            'poly_z': poly_z,
-            'nin': coll.dobj[lcls[ii]][k0]['dgeom']['nin'],
-        }
+        # res_RZ
+        if res_RZ is None:
+            res_RZ = 0.01
+
+        # res_phi
+        if res_phi is None:
+            res_phi = 0.01
 
-    return dap
+        iok, shape, phi = None, None, None
 
+    else:
 
-# ##################################################################
-# ##################################################################
-#                   Poly interpolation utilities
-# ##################################################################
+        ptsx = np.atleast_1d(ptsx)
+        ptsy = np.atleast_1d(ptsy)
+        ptsz = np.atleast_1d(ptsz)
+
+        # check shapes
+        dshape = {
+            'ptsx': ptsx.shape,
+            'ptsy': ptsy.shape,
+            'ptsz': ptsz.shape,
+        }
+        maxsize = np.max([np.prod(v0) for v0 in dshape.values()])
+        shape = [v0 for v0 in dshape.values() if np.prod(v0) == maxsize][0]
 
+        lout = [
+            k0 for k0, v0 in dshape.items()
+            if v0 not in [(1,), shape]
+        ]
+        if len(lout) > 0:
+            lstr = [f"\t-{k0}.shape: {v0}" for k0, v0 in dshape.items()]
+            msg = (
+                "All coordinates arrays must be of same shape:\n"
+                + "\n".join(lstr)
+            )
+            raise Exception(msg)
 
-def _interp_poly_check(
-    add_points=None,
-    mode=None,
-    closed=None,
-    ravel=None,
-    min_threshold=None,
-):
+        # uniformize shapes
+        if shape != (1,):
+            if ptsx.shape == (1,):
+                ptsx = np.full(shape, ptsx[0])
+            if ptsy.shape == (1,):
+                ptsy = np.full(shape, ptsy[0])
+            if ptsz.shape == (1,):
+                ptsz = np.full(shape, ptsz[0])
 
-    # -------
-    # mode
+        dsamp = None
 
-    mode = ds._generic_check._check_var(
-        mode, 'mode',
-        default=None,
-        allowed=[None, 'mean', 'min', 'thr'],
-    )
+    # -------
+    # lamb
 
-    # ----------
-    # add_points
+    if lamb0 is not None:
+        lamb0 = np.atleast_1d(lamb0)
 
-    defadd = 1 if mode == 'min' else 0
-    add_points = ds._generic_check._check_var(
-        add_points, 'add_points',
-        types=int,
-        default=defadd,
-        sign='>= 0',
-    )
+        if lc[0]:
+            if lamb0.shape != (1,):
+                msg = "With mesh sampling, lamb0 must be a scalar!"
+                raise Exception(msg)
 
-    # -------
-    # closed
+        else:
+            if lamb0.shape == (1,):
+                lamb0 = np.full(ptsx.shape, lamb0[0])
 
-    closed = ds._generic_check._check_var(
-        closed, 'closed',
-        default=False,
-        types=bool,
-    )
+            elif lamb0.shape != ptsx.shape:
+                msg = (
+                    "Arg lamb0 must be the same shape as coordinates\n"
+                    f"\t- ptsx.shape = {ptsx.shape}\n"
+                    f"\t- lamb0.shape = {lamb0.shape}\n"
+                )
+                raise Exception(msg)
 
-    # -------
-    # ravel
+    # --------------
+    # rocking_curve
 
-    ravel = ds._generic_check._check_var(
-        ravel, 'ravel',
-        default=False,
+    rocking_curve = ds._generic_check._check_var(
+        rocking_curve, 'rocking_curve',
+        default=True,
         types=bool,
     )
 
-    # -------
-    # min_threshold
+    if lamb0 is None:
+        rocking_curve = False
 
-    min_threshold = ds._generic_check._check_var(
-        min_threshold, 'min_threshold',
-        default=100e-6,
-        types=float,
-        sign='>=0',
-    )
+    # -----------------------
+    # store shape and flatten
 
-    return add_points, mode, closed, ravel, min_threshold
+    if lc[0]:
+        pass
 
+    else:
+        if len(shape) > 1:
+            ptsx = ptsx.ravel()
+            ptsy = ptsy.ravel()
+            ptsz = ptsz.ravel()
+            if lamb0 is not None:
+                lamb0 = lamb0.ravel()
+
+        iok = np.isfinite(ptsx) & np.isfinite(ptsy) & np.isfinite(ptsz)
+        phi = np.arctan2(ptsy, ptsx)
+
+    # ---------
+    # options
+
+    # plot
+    plot = ds._generic_check._check_var(
+        plot, 'plot',
+        types=bool,
+        default=True,
+    )
 
-def _interp_poly(
-    lp=None,
-    add_points=None,
-    mode=None,
-    isclosed=None,
-    closed=None,
-    ravel=None,
-    min_threshold=None,
-    debug=None,
-):
-    """ Interpolate list of polygons by adding points ons segments
+    # plot_pixel
+    plot_pixels = ds._generic_check._check_var(
+        plot_pixels, 'plot_pixels',
+        types=bool,
+        default=False,
+    )
 
-    lp = list of coordinates arrays describing polygons
-        - [px, py]
-        - [px, py, pz]
-    Each coordinate array can be 1d or 2d
+    # append
+    append = ds._generic_check._check_var(
+        append, 'append',
+        types=bool,
+        default=lc[1] and ptsx.size < 100,  #  and plot is True,
+    )
 
-    modes: determine a multiplicative factor to add_points
-        - None: 1
-        - min: determined by minimum segment length
-        - mean: determined by mean segment length
+    # colorbar
+    colorbar = ds._generic_check._check_var(
+        colorbar, 'colorbar',
+        types=bool,
+        default=False,
+    )
 
-    """
+    return  (
+        key, key_cam, key_mesh,
+        dsamp, res_phi,
+        shape, iok,
+        ptsx, ptsy, ptsz, phi,
+        lamb0, rocking_curve,
+        append, plot, plot_pixels, colorbar,
+    )
 
-    # ------------
-    # check inputs
 
-    add_points, mode, closed, ravel, min_threshold = _interp_poly_check(
-        add_points=add_points,
-        mode=mode,
-        closed=closed,
-        ravel=ravel,
-        min_threshold=min_threshold,
-    )
-
-    # ------------
-    # trivial case
-
-    if add_points == 0:
-
-        if isclosed is False and closed is True:
-            for ii, pp in enumerate(lp):
-                if pp is None:
-                    continue
+# ################################################
+# ################################################
+#               prepare optics
+# ################################################
 
-                if pp.ndim == 2:
-                    lp[ii] = np.concatenate((pp, pp[:, 0:1]), axis=1)
-                else:
-                    lp[ii] = np.r_[pp, pp[0]]
 
-        elif isclosed is True and closed is False:
-            for ii, pp in enumerate(lp):
-                if pp is None:
-                    continue
+def _prepare_optics(
+    coll=None,
+    key=None,
+    key_cam=None,
+):
 
-                if pp.ndim == 2:
-                    lp[ii] = pp[:, :-1]
-                else:
-                    lp[ii] = pp[:-1]
-        return lp
+    doptics = coll.dobj['diagnostic'][key]['doptics']
+    lop = doptics[key_cam]['optics']
+    lop, lcls = coll.get_optics_cls(lop)
+
+    cls_spectro = 'crystal'
+    kspectro = lop[lcls.index(cls_spectro)]
+    ispectro = lop.index(kspectro)
+    if len(lop[:ispectro]) > 1:
+        msg = "Not yet implemented optics between crystal and camera!"
+        raise NotImplementedError(msg)
+
+    # lpoly_post = []
+    lpoly_post = [
+        coll.get_optics_poly(
+            key=k0,
+            add_points=None,
+            return_outline=False,
+        )
+        for k0 in lop[ispectro+1:]
+    ]
 
-    # ------------
-    # compute
+    # get initial polygon
+    p0x, p0y, p0z = coll.get_optics_poly(key=kspectro, add_points=None)
 
-    # close for interpolation
-    if isclosed is not True:
-        for ii, pp in enumerate(lp):
+    # unit vectors
+    nin = coll.dobj[cls_spectro][kspectro]['dgeom']['nin']
+    e0 = coll.dobj[cls_spectro][kspectro]['dgeom']['e0']
+    e1 = coll.dobj[cls_spectro][kspectro]['dgeom']['e1']
+
+    # get functions
+    ptsvect_plane = coll.get_optics_reflect_ptsvect(key=kspectro, asplane=True)
+    ptsvect_spectro = coll.get_optics_reflect_ptsvect(key=kspectro, isnorm=True)
+    ptsvect_cam = coll.get_optics_reflect_ptsvect(key=key_cam, fast=True)
+
+    coords_x01toxyz_plane = coll.get_optics_x01toxyz(
+        key=kspectro,
+        asplane=True,
+    )
+
+    # Get centers of crystal and camera to estimate distance
+    cent_spectro = coll.dobj[cls_spectro][kspectro]['dgeom']['cent']
+    cent_cam = coll.dobj['camera'][key_cam]['dgeom']['cent']
+    dist_to_cam = np.linalg.norm(cent_spectro - cent_cam)
+    pix_size = np.sqrt(coll.dobj['camera'][key_cam]['dgeom']['pix_area'])
+
+    # prepare camera bin edges
+    kcc = coll.dobj['camera'][key_cam]['dgeom']['cents']
+    cc0 = coll.ddata[kcc[0]]['data']
+    cc1 = coll.ddata[kcc[1]]['data']
+    cout0, cout1 = coll.get_optics_outline(key_cam, total=False)
+    cbin0 = np.r_[cc0 + np.min(cout0), cc0[-1] + np.max(cout0)]
+    cbin1 = np.r_[cc1 + np.min(cout1), cc1[-1] + np.max(cout1)]
 
-            if pp is None:
-                continue
+    return (
+        kspectro,
+        lpoly_post,
+        p0x, p0y, p0z,
+        nin, e0, e1,
+        ptsvect_plane,
+        ptsvect_spectro,
+        ptsvect_cam,
+        coords_x01toxyz_plane,
+        cent_spectro,
+        cent_cam,
+        dist_to_cam,
+        pix_size,
+        cbin0, cbin1,
+    )
 
-            if pp.ndim == 2:
-                lp[ii] = np.concatenate((pp, pp[:, 0:1]), axis=1)
-            else:
-                lp[ii] = np.append(pp, pp[0])
-
-    # -----------
-    # mode
-
-    if mode is not None:
-        if len(lp) == 3:
-            dist = np.sqrt(
-                np.diff(lp[0], axis=-1)**2
-                + np.diff(lp[1], axis=-1)**2
-                + np.diff(lp[2], axis=-1)**2
-            )
-        elif len(lp) == 2:
-            dist = np.sqrt(
-                np.diff(lp[0], axis=-1)**2
-                + np.diff(lp[1], axis=-1)**2
-            )
 
-        if dist.ndim == 2:
-            import pdb; pdb.set_trace()     # DB
+# ################################################
+# ################################################
+#           Prepare lambda
+# ################################################
 
-        if mode == 'thr':
-            mindist = min_threshold
-            add_points = np.ceil(dist / mindist).astype(int) - 1
-        else:
-            min_threshold = min(min_threshold, np.max(dist)/3.)
-            if mode == 'min':
-                mindist = np.min(dist[dist > min_threshold])
-            elif mode == 'mean':
-                mindist = np.mean(dist[dist > min_threshold])
-
-            add_points = add_points * np.ceil(dist / mindist).astype(int) - 1
-
-    # -----------
-    # add_points
-
-    shape = [pp for pp in lp if pp is not None][0].shape
-    nb = shape[-1]
-    if np.isscalar(add_points):
-        add_points = np.full((nb-1,), add_points, dtype=int)
-
-    # -----------
-    # indices
-
-    ind0 = np.arange(0, nb)
-    ind = np.concatenate(tuple([
-        np.linspace(
-            ind0[ii],
-            ind0[ii+1],
-            2 + add_points[ii],
-            endpoint=True,
-        )[:-1]
-        for ii in range(nb-1)
-    ] + [[ind0[-1]]]))
 
-    # -----------
-    # interpolate
+def _prepare_lamb(
+    coll=None,
+    key_diag=None,
+    key_cam=None,
+    kspectro=None,
+    lamb=None,
+    res_lamb=None,
+    rocking_curve=None,
+    rocking_curve_step_width=None,
+    res_rock_curve=None,
+    verb=None,
+):
 
-    for ii, pp in enumerate(lp):
+    # ------------------
+    # get lamb
+    # ------------------
 
-        if pp is None:
-            continue
+    if res_lamb is not None:
+        lamb = coll.get_diagnostic_data(
+            key=key_diag,
+            key_cam=key_cam,
+            data='lamb',
+        )[0][key_cam]
+
+        lambmin = np.nanmin(lamb)
+        lambmax = np.nanmax(lamb)
+        Dlamb = (lambmax - lambmin) * 1.1
+        nlamb = int(np.ceil(Dlamb / res_lamb)) + 2
+        lamb = np.linspace(lambmin - 0.2*Dlamb, lambmax + 0.2*Dlamb, nlamb)
+        dlamb = lamb[1] - lamb[0]
+
+        bragg = coll.get_crystal_bragglamb(
+            key=kspectro,
+            lamb=lamb,
+            rocking_curve=False,
+        )[0]
+
+    elif lamb is not None:
+
+        lamb = ds._generic_check._check_flat1darray(
+            lamb, 'lamb',
+            dtype=float,
+            sign='>0',
+            unique=True,
+        )
+        nlamb = lamb.size
+        dlamb = None
+        bragg = coll.get_crystal_bragglamb(
+            key=kspectro,
+            lamb=lamb,
+            rocking_curve=False,
+        )[0]
 
-        lp[ii] = scpinterp.interp1d(
-            ind0, pp, kind='linear', axis=-1,
-        )(ind)
+    # ----------------
+    # get power ratio
+    # ----------------
 
-    # ------------
-    # closed
+    # angle relative
+    cls_spectro = 'crystal'
+    kang_rel = coll.dobj[cls_spectro][kspectro]['dmat']['drock']['angle_rel']
+    ang_rel = coll.ddata[kang_rel]['data']
+
+    # power ratio
+    if rocking_curve is False:
+        if rocking_curve_step_width is None:
+            rocking_curve_step_width = np.mean(np.diff(ang_rel))
 
-    if closed is False:
+        ang_rel = 0.5 * rocking_curve_step_width * np.r_[-1, 1]
+        pow_ratio = np.r_[1, 1]
 
-        for ii, pp in enumerate(lp):
-            if pp is None:
-                continue
+    else:
+        kpow = coll.dobj[cls_spectro][kspectro]['dmat']['drock']['power_ratio']
+        pow_ratio = coll.ddata[kpow]['data']
 
-            if pp.ndim == 2:
-                lp[ii] = pp[:, :-1]
-            else:
-                lp[ii] = pp[:-1]
-
-    # ------------
-    # ravel
-
-    if ravel and len(shape) == 2:
-        nan = np.full((pp.shape[0], 1), np.nan)
-        for ii, pp in enumerate(lp[2:]):
-            lp[ii+2] = np.concatenate((pp, nan), axis=1).ravel()
-
-    return lp
-
-
-def _harmonize_polygon_sizes(
-    lp0=None,
-    lp1=None,
-    nmin=0,
-):
-    """ From a list of polygons return an array
+    # --------------
+    # interpolation
+    # ---------------
 
-    """
+    pow_interp = scpinterp.interp1d(
+        ang_rel,
+        pow_ratio,
+        kind='linear',
+        bounds_error=False,
+        fill_value=0.,
+    )
+
+    dang = np.mean(np.diff(ang_rel))
+
+    # --------------------------------------
+    # overall bragg angle with rocking curve
+    # --------------------------------------
 
-    # prepare
-    npoly = len(lp0)
-    ln = [p0.size if p0 is not None else 0 for p0 in lp0]
-    nmax = max(np.max(ln), nmin)
-    nan = np.full((nmax,), np.nan)
+    if res_lamb is None and lamb is None:
+        nlamb, lamb, dlamb, bragg = None, None, None, None
 
-    # prepare output
-    x0 = np.full((npoly, nmax), np.nan)
-    x1 = np.full((npoly, nmax), np.nan)
+    else:
 
-    for ii, p0 in enumerate(lp0):
+        # ------------
+        # safety check
 
-        if p0 is None:
-            continue
+        FW = coll.dobj[cls_spectro][kspectro]['dmat']['drock']['FW']
+        dd0 = bragg[0] + np.r_[0, ang_rel[-1] - ang_rel[0]]
+        dd1 = bragg[0] + np.r_[0, FW]
+        dd2 = bragg[0] + np.r_[0, ang_rel[1] - ang_rel[0]]
+
+        dlamb_max = np.diff(coll.get_crystal_bragglamb(key=kspectro, bragg=dd0)[1])
+        dlamb_mh = np.diff(coll.get_crystal_bragglamb(key=kspectro, bragg=dd1)[1])
+        dlamb_res = np.diff(coll.get_crystal_bragglamb(key=kspectro, bragg=dd2)[1])
+
+        if verb is True and res_lamb is not None:
+            msg = (
+                "Recommended res_lamb to ensure rocking curve overlap:\n"
+                f"\t- edge-edge: \t{dlamb_max[0]:.2e}\n"
+                f"\t- MH-to-MH: \t{dlamb_mh[0]:.2e}\n"
+                f"\t- resolution: \t{dlamb_res[0]:.2e}\n"
+                f"\tProvided: \t{dlamb:.2e}\n"
+            )
+            print(msg)
 
-        elif ln[ii] < nmax:
+    return (
+        nlamb,
+        lamb,
+        dlamb,
+        pow_interp,
+        ang_rel,
+        dang,
+        bragg,
+    )
 
-            ndif = nmax - ln[ii]
-            ind0 = np.arange(0, ln[ii] + 1)
 
-            # create imax
-            iseg = np.arange(0, ndif) % ln[ii]
-            npts = np.unique(iseg, return_counts=True)[1]
-            if npts.size < ln[ii]:
-                npts = np.r_[
-                    npts, np.zeros((ln[ii] - npts.size,))
-                ].astype(int)
-
-            imax = np.concatenate(tuple([
-                np.linspace(
-                    ind0[ii],
-                    ind0[ii+1],
-                    2 + npts[ii],
-                    endpoint=True,
-                )[:-1]
-                for ii in range(ln[ii])
-            ]))
+# ################################################
+# ################################################
+#           Loops
+# ################################################
+
+
+def _loop0(
+    iok=None,
+    ptsx=None,
+    ptsy=None,
+    ptsz=None,
+    lpoly_post=None,
+    min_threshold=None,
+    # ref
+    cent=None,
+    nin=None,
+    e0=None,
+    e1=None,
+    # p0
+    p0x=None,
+    p0y=None,
+    p0z=None,
+    # dang
+    pix_size=None,
+    dist_to_cam=None,
+    dang=None,
+    phi=None,
+    shape_cam=None,
+    # lamb
+    lamb=None,
+    dlamb=None,
+    rocking_curve=None,
+    bragg_per_pix=None,
+    ang_rel=None,
+    pow_interp=None,
+    bragg=None,
+    # optional
+    n0=None,
+    n1=None,
+    # functions
+    ptsvect_plane=None,
+    coords_x01toxyz_plane=None,
+    ptsvect_spectro=None,
+    ptsvect_cam=None,
+    # others
+    ncounts=None,
+    cbin0=None,
+    cbin1=None,
+    append=None,
+    verb=True,
+    **kwdargs,
+):
 
-            # interpolate
-            x0[ii, :] = scpinterp.interp1d(
-                ind0,
-                np.r_[p0, p0[0]],
-                kind='linear',
-            )(imax)
-            x1[ii, :] = scpinterp.interp1d(
-                ind0,
-                np.r_[lp1[ii], lp1[ii][0]],
-                kind='linear',
-            )(imax)
+    # ----------
+    # prepare
 
+    # counts, ph_count
+    ncounts = np.full(shape_cam, 0.)
+    sang = np.full(tuple(np.r_[shape_cam, ptsx.size]), 0.)
+    sang0 = np.full(tuple(np.r_[shape_cam, ptsx.size]), 0.)
+    sang_lamb = np.full(shape_cam, 0.)
+
+    lsang = None
+    if append is True:
+        lp0, lp1 = [], []
+        lpx, lpy, lpz = [], [], []
+        lsang = []
+        if lamb is None:
+            dpow = None
         else:
-            x0[ii, :] = p0
-            x1[ii, :] = lp1[ii]
+            dpow = {ll: [] for ll in lamb}
+    else:
+        lp0, lp1 = None, None
+        lpx, lpy, lpz = None, None, None
+        dpow = None
+        lsang = None
 
-    return x0, x1
+    # ----------
+    # loop
 
+    pti = np.full((3,), np.nan)
+    npts0 = iok.sum()
+    for ii, i0 in enumerate(iok.nonzero()[0]):
+
+        pti[:] = np.r_[ptsx[i0], ptsy[i0], ptsz[i0]]
+
+        # ------------------------------------------
+        # initial polygon (crystal on its own plane)
+
+        p0, p1 = ptsvect_plane(
+            pts_x=ptsx[i0],
+            pts_y=ptsy[i0],
+            pts_z=ptsz[i0],
+            vect_x=p0x - ptsx[i0],
+            vect_y=p0y - ptsy[i0],
+            vect_z=p0z - ptsz[i0],
+            strict=True,
+            return_x01=True,
+        )[-2:]
+        p_a = plg.Polygon(np.array([p0, p1]).T)
+
+        if len(lpoly_post) > 0:
+
+            # get equivalent aperture
+            p0, p1 = _equivalent_apertures._get_equivalent_aperture(
+                p_a=p_a,
+                pt=pti,
+                nop_pre=len(lpoly_post),
+                lpoly_pre=lpoly_post,
+                ptsvect=ptsvect_plane,
+                min_threshold=min_threshold,
+                # debug
+                debug=False,
+            )
 
+            # skip if no intersection
+            if p0 is None or p0.size == 0:
+                continue
 
-# ###############################################################
-# ###############################################################
-#                       dplot
-# ###############################################################
+        # compute image
+        (
+            x0c, x1c, angles, dsang, cosi, iok,
+            dangmin_str, x0if, x1if,
+            ptsx1, ptsy1, ptsz1,
+            ptsx2, ptsy2, ptsz2,
+        ) = _get_points_on_camera_from_pts(
+            p0=p0,
+            p1=p1,
+            pti=pti,
+            # ref
+            cent=cent,
+            nin=nin,
+            e0=e0,
+            e1=e1,
+            # dang
+            pix_size=pix_size,
+            dist_to_cam=dist_to_cam,
+            dang=dang,
+            phi=phi[ii],
+            # optional
+            n0=n0,
+            n1=n1,
+            # functions
+            coords_x01toxyz_plane=coords_x01toxyz_plane,
+            ptsvect_spectro=ptsvect_spectro,
+            ptsvect_cam=ptsvect_cam,
+            # debug
+            debug=npts0 == 1,
+        )
 
+        if verb is True:
+            msg = (
+                f"\t\t{ii} / {npts0} pts \t dangmin: {dangmin_str}"
+            )
+            print(msg, end='\r')
 
-def _dplot_check(
-    coll=None,
-    key=None,
-    key_cam=None,
-    optics=None,
-    elements=None,
-    vect_length=None,
-    axis_length=None,
-    dx0=None,
-    dx1=None,
-    default=None,
-):
-    # -----
-    # key
+        # stack coordinates
+        if append is True:
+            npts = iok.sum()
+            lpx.append(np.array([
+                np.full((npts,), ptsx[i0]),
+                ptsx1[iok],
+                ptsx2[iok],
+            ]))
+            lpy.append(np.array([
+                np.full((npts,), ptsy[i0]),
+                ptsy1[iok],
+                ptsy2[iok],
+            ]))
+            lpz.append(np.array([
+                np.full((npts,), ptsz[i0]),
+                ptsz1[iok],
+                ptsz2[iok],
+            ]))
 
-    key, key_cam = coll.get_diagnostic_cam(
-        key,
-        key_cam,
-        default=default,
-    )
-
-    # ------
-    # optics
-
-    if isinstance(optics, str):
-        optics = [optics]
-
-    lok = list(itt.chain.from_iterable([
-        [k0] + v0['optics']
-        for k0, v0 in coll.dobj['diagnostic'][key]['doptics'].items()
-        if k0 in key_cam
-    ]))
-    optics = ds._generic_check._check_var_iter(
-        optics, 'optics',
-        default=lok,
-        allowed=lok,
-    )
+            # p0, p1
+            lp0.append(x0c[iok])
+            lp1.append(x1c[iok])
+
+            # pow
+            if lamb is not None:
+                for kk, ll in enumerate(lamb):
+                    dpow[ll].append(pow_interp(angles[iok] - bragg[kk]))
+
+        # safety check
+        iok2 = (
+            (x0c[iok] >= cbin0[0])
+            & (x0c[iok] <= cbin0[-1])
+            & (x1c[iok] >= cbin1[0])
+            & (x1c[iok] <= cbin1[-1])
+        )
 
-    # -------
-    # elements
+        if not np.any(iok2):
+            continue
 
-    lok = ['o', 'c', 'v', 'r']
-    elements = ds._generic_check._check_var_iter(
-        elements, 'elements',
-        types=str,
-        types_iter=str,
-        default=''.join(lok),
-        allowed=lok,
-    )
+        # update index
+        iok[iok] = iok2
 
-    # -----------
-    # vect_length
+        # 2d pixel by binning
+        out = scpstats.binned_statistic_2d(
+            x0c[iok],
+            x1c[iok],
+            None,
+            statistic='count',
+            bins=(cbin0, cbin1),
+            expand_binnumbers=True,
+        )
 
-    vect_length = ds._generic_check._check_var(
-        vect_length, 'vect_length',
-        default=0.2,
-        types=(float, int),
-        sign='>= 0.'
-    )
-
-    # -----------
-    # axis_length
-
-    axis_length = ds._generic_check._check_var(
-        axis_length, 'axis_length',
-        default=1.,
-        types=(float, int),
-        sign='>= 0.'
-    )
+        ipixok = out.statistic > 0
+        ncounts[ipixok] += out.statistic[ipixok]
 
-    # ---------------
-    # dx0, dx1
+        sang0[ipixok, i0] += scpstats.binned_statistic_2d(
+            x0c[iok],
+            x1c[iok],
+            dsang[iok],
+            statistic='sum',
+            bins=(cbin0, cbin1),
+            expand_binnumbers=True,
+        ).statistic[ipixok]
+
+        # taking into account rocking curve
+        angles = angles[iok]
+        dsang = dsang[iok]
+
+        ip0, ip1 = ipixok.nonzero()
+        indi = np.zeros((out.binnumber.shape[1],), dtype=bool)
+        indj = np.zeros((out.binnumber.shape[1],), dtype=bool)
+        for ii in np.unique(ip0):
+            indi[:] = (out.binnumber[0, :] == (ii + 1))
+            for jj in np.unique(ip1[ip0 == ii]):
+
+                # indices
+                indj[:] = indi & (out.binnumber[1, :] == jj + 1)
+
+                if lamb is None:
+                    # solid angle
+                    sang[ii, jj, i0] += np.sum(dsang[indj])
 
-    # dx0
-    dx0 = float(ds._generic_check._check_var(
-        dx0, 'dx0',
-        types=(int, float),
-        default=0.,
-    ))
-
-    # dx1
-    dx1 = float(ds._generic_check._check_var(
-        dx1, 'dx1',
-        types=(int, float),
-        default=0.,
-    ))
+                else:
+                    # lambref
+                    arelj = angles[indj] - bragg_per_pix[ii, jj]
 
+                    # solid angle
+                    sang[ii, jj, i0] += np.sum(
+                        pow_interp(arelj)
+                        * dsang[indj]
+                    )
+
+                    # ----------
+                    # sang_lamb
+
+                    angj = angles[indj]
+                    ilamb = (
+                        (angj[:, None] - bragg >= ang_rel[0])
+                        & (angj[:, None] - bragg < ang_rel[-1])
+                    )
+
+                    if not np.any(ilamb):
+                        continue
+
+                    ilamb_n = np.any(ilamb, axis=0).nonzero()[0]
+
+                    # binning of angles
+                    for kk in ilamb_n:
+                        sang_lamb[ii, jj] += np.sum(
+                            pow_interp(angj[ilamb[:, kk]] - bragg[kk])
+                            * dsang[indj][ilamb[:, kk]]
+                        )
+
+    # adjust sang_lamb
+    if lamb is None:
+        sang_lamb = np.nansum(sang0, axis=-1)
 
-    return (
-        key, key_cam, optics, elements,
-        vect_length, axis_length,
-        dx0, dx1,
-    )
+    return {
+        'ncounts': {'data': ncounts, 'units': ''},
+        'sang0': {'data': sang0, 'units': 'sr'},
+        'sang': {'data': sang, 'units': 'sr'},    # not really useful?
+        'sang_lamb': {'data': sang_lamb, 'units': 'sr'},
+        'lamb': {'data': lamb, 'units': 'm'},
+        'dlamb': {'data': dlamb, 'units': 'm'},
+        'lp0': {'data': lp0, 'units': 'm'},
+        'lp1': {'data': lp1, 'units': 'm'},
+        'lpx': {'data': lpx, 'units': 'm'},
+        'lpy': {'data': lpy, 'units': 'm'},
+        'lpz': {'data': lpz, 'units': 'm'},
+        'dpow': {'data': dpow, 'units': ''},
+        'lsang': {'data': lsang, 'units': 'sr'},
+    }
 
 
-def _dplot(
+def _loop1(
+    # specific
     coll=None,
     key=None,
     key_cam=None,
-    optics=None,
-    elements=None,
-    vect_length=None,
-    axis_length=None,
-    dx0=None,
-    dx1=None,
-    default=None,
+    key_mesh=None,
+    margin_poly=None,
+    res_phi=None,
+    dsamp=None,
+    # common
+    iok=None,
+    ptsx=None,
+    ptsy=None,
+    ptsz=None,
+    lpoly_post=None,
+    min_threshold=None,
+    # ref
+    cent=None,
+    nin=None,
+    e0=None,
+    e1=None,
+    # p0
+    p0x=None,
+    p0y=None,
+    p0z=None,
+    # dang
+    pix_size=None,
+    dist_to_cam=None,
+    dang=None,
+    phi=None,
+    shape_cam=None,
+    # optional
+    n0=None,
+    n1=None,
+    # functions
+    ptsvect_plane=None,
+    coords_x01toxyz_plane=None,
+    ptsvect_spectro=None,
+    ptsvect_cam=None,
+    # others
+    ncounts=None,
+    cbin0=None,
+    cbin1=None,
+    # others
+    verb=True,
+    **kwdargs,
 ):
 
-    # ------------
-    # check inputs
+    # --------------------------
+    # get overall polygons
 
-    (
-        key, key_cam, optics, elements,
-        vect_length, axis_length,
-        dx0, dx1,
-    ) = _dplot_check(
+    pcross0, pcross1 = _utilities._get_overall_polygons(
         coll=coll,
-        key=key,
+        doptics=coll.dobj['diagnostic'][key]['doptics'],
         key_cam=key_cam,
-        optics=optics,
-        elements=elements,
-        vect_length=vect_length,
-        axis_length=axis_length,
-        dx0=dx0,
-        dx1=dx1,
-        default=default,
-    )
-
-    # ------------
-    # build dict
-
-    dlw = {
-        'camera': 2,
-        'aperture': 1.,
-        'filter': 1.,
-        'crystal': 1.,
-        'grating': 1.,
-    }
-    dplot = {k0: {} for k0 in optics}
-    for k0 in optics:
+        poly='pcross',
+    )
 
-        if k0 in coll.dobj.get('camera', []):
-            cls = 'camera'
-        elif k0 in coll.dobj.get('aperture', []):
-            cls = 'aperture'
-        elif k0 in coll.dobj.get('filter', []):
-            cls = 'filter'
-        elif k0 in coll.dobj.get('crystal', []):
-            cls = 'crystal'
-        elif k0 in coll.dobj.get('grating', []):
-            cls = 'grating'
-        else:
-            msg = f"Unknown optics '{k0}'"
-            raise Exception(msg)
+    phor0, phor1 = _utilities._get_overall_polygons(
+        coll=coll,
+        doptics=coll.dobj['diagnostic'][key]['doptics'],
+        key_cam=key_cam,
+        poly='phor',
+    )
 
-        v0 = coll.dobj[cls][k0]['dgeom']
-        color = coll.dobj[cls][k0]['dmisc']['color']
+    # --------------------------
+    # add margins
 
-        # -----------
-        # prepare data
+    pcross0, pcross1 = _utilities._get_poly_margin(
+        # polygon
+        p0=pcross0,
+        p1=pcross1,
+        # margin
+        margin=margin_poly,
+    )
+
+    phor0, phor1 = _utilities._get_poly_margin(
+        # polygon
+        p0=phor0,
+        p1=phor1,
+        # margin
+        margin=margin_poly,
+    )
 
-        # cent
-        if 'c' in elements or 'v' in elements or 'r' in elements:
-            if v0.get('cent') is not None:
-                cx, cy, cz = v0['cent'][:, None]
-            elif 'cents' in v0.keys():
-                cx, cy, cz = v0['cents']
-                cx = coll.ddata[cx]['data']
-                cy = coll.ddata[cy]['data']
-                cz = coll.ddata[cz]['data']
-            cr = np.hypot(cx, cy)
-
-        # vectors
-        if 'v' in elements or 'r' in elements:
-            ninx, niny, ninz = v0['nin']
-            e0x, e0y, e0z = v0['e0']
-            e1x, e1y, e1z = v0['e1']
-            if isinstance(ninx, str):
-                vinx = coll.ddata[ninx]['data'] * vect_length
-                viny = coll.ddata[niny]['data'] * vect_length
-                vinz = coll.ddata[ninz]['data'] * vect_length
-                v0x = coll.ddata[e0x]['data'] * vect_length
-                v0y = coll.ddata[e0y]['data'] * vect_length
-                v0z = coll.ddata[e0z]['data'] * vect_length
-                v1x = coll.ddata[e1x]['data'] * vect_length
-                v1y = coll.ddata[e1y]['data'] * vect_length
-                v1z = coll.ddata[e1z]['data'] * vect_length
-            else:
-                vinx, viny, vinz = np.r_[ninx, niny, ninz] * vect_length
-                v0x, v0y, v0z = np.r_[e0x, e0y, e0z] * vect_length
-                v1x, v1y, v1z = np.r_[e1x, e1y, e1z] * vect_length
-
-        # radius
-        if 'r' in elements and v0['type'] not in ['planar', '', '3d']:
-            if v0['type'] == 'cylindrical':
-                icurv = (np.isfinite(v0['curve_r'])).nonzero()[0][0]
-                rc = v0['curve_r'][icurv]
-                eax = [(e0x, e0y, e0z), (e1x, e1y, e1z)][1 - icurv]
-            elif v0['type'] == 'spherical':
-                rc = v0['curve_r'][0]
-            elif v0['type'] == 'toroidal':
-                imax = np.argmax(v0['curve_r'])
-                imin = 1 - imax
-                rmax = v0['curve_r'][imax]
-                rmin = v0['curve_r'][imin]
-                emax = [(e0x, e0y, e0z), (e1x, e1y, e1z)][imax]
-            # extenthalf = v0['extenthalf']
-
-        # -----------------
-        # get plotting data
-
-        # outline
-        if 'o' in elements:
-
-            p0, p1, px, py, pz = coll.get_optics_poly(
-                key=k0,
-                add_points=3,
-                closed=True,
-                ravel=True,
-                return_outline=True,
-                total=True,
-            )
+    # ------------------------
+    # get ind in cross-section
 
-            dplot[k0]['o'] = {
-                'x0': p0 + dx0,
-                'x1': p1 + dx1,
-                'x': px,
-                'y': py,
-                'z': pz,
-                'r': np.hypot(px, py),
-                'props': {
-                    'label': f'{k0}-o',
-                    'lw': dlw[cls],
-                    'c': color,
-                },
-            }
-
-        # center
-        if 'c' in elements:
-
-            dplot[k0]['c'] = {
-                'x': cx,
-                'y': cy,
-                'z': cz,
-                'r': cr,
-                'props': {
-                    'label': f'{k0}-o',
-                    'ls': 'None',
-                    'marker': 'o',
-                    'ms': 4,
-                    'c': color,
-                },
-            }
-
-        # unit vectors
-        if 'v' in elements:
-
-            vinr = np.hypot(cx + vinx, cy + viny) - cr
-            v0r = np.hypot(cx + v0x, cy + v0y) - cr
-            v1r = np.hypot(cx + v1x, cy + v1y) - cr
-
-            # dict
-
-            dplot[k0]['v-nin'] = {
-                'x': cx,
-                'y': cy,
-                'z': cz,
-                'r': cr,
-                'ux': vinx,
-                'uy': viny,
-                'uz': vinz,
-                'ur': vinr,
-                'props': {
-                    'label': f'{k0}-nin',
-                    'fc': 'r',
-                    'color': 'r',
-                },
-            }
-
-            dplot[k0]['v-e0'] = {
-                'x': cx,
-                'y': cy,
-                'z': cz,
-                'r': cr,
-                'ux': v0x,
-                'uy': v0y,
-                'uz': v0z,
-                'ur': v0r,
-                'props': {
-                    'label': f'{k0}-e0',
-                    'fc': 'g',
-                    'color': 'g',
-                },
-            }
-
-            dplot[k0]['v-e1'] = {
-                'x': cx,
-                'y': cy,
-                'z': cz,
-                'r': cr,
-                'ux': v1x,
-                'uy': v1y,
-                'uz': v1z,
-                'ur': v1r,
-                'props': {
-                    'label': f'{k0}-e1',
-                    'fc': 'b',
-                    'color': 'b',
-                },
-            }
+    sh = dsamp['x0']['data'].shape
+    x0u = dsamp['x0']['data'][:, 0]
+    x1u = dsamp['x1']['data'][0, :]
+    x0f = dsamp['x0']['data'].ravel()
+    x1f = dsamp['x1']['data'].ravel()
+
+    pcross = Path(np.array([pcross0, pcross1]).T)
+    ind = (
+        dsamp['ind']['data']
+        & pcross.contains_points(np.array([x0f, x1f]).T).reshape(sh)
+    )
+    nRZ = ind.sum()
+
+    # R and Z indices
+    ir, iz = ind.nonzero()
+    iru = np.unique(ir)
 
-        # rowland / axis for curved optics
-        if 'r' in elements and cls in ['crystal', 'grating']:
+    # ----------
+    # get dphi_r
 
-            if v0['type'] not in ['cylindrical', 'spherical', 'toroidal']:
-                continue
+    phi_hor = np.arctan2(phor1, phor0)
+    phimin = np.nanmin(phi_hor)
+    phimax = np.nanmax(phi_hor)
+
+    # get dphi vs phor
+    dphi_r = _utilities._get_dphi_from_R_phor(
+        R=x0u[iru],
+        phor0=phor0,
+        phor1=phor1,
+        phimin=phimin,
+        phimax=phimax,
+        res=res_phi,
+        out=True,
+    )
 
-            theta = np.linspace(-1, 1, 50) * np.pi
-            if v0['type'] == 'cylindrical':
-                c2x = cx + ninx * rc
-                c2y = cy + niny * rc
-                c2z = cz + ninz * rc
-                px = c2x + np.r_[-1, 1] * axis_length * eax[0]
-                py = c2y + np.r_[-1, 1] * axis_length * eax[1]
-                pz = c2z + np.r_[-1, 1] * axis_length * eax[2]
-
-                lab = f'{k0}-axis',
-
-            elif v0['type'] == 'spherical':
-                c2x = cx + ninx * 0.5 * rc
-                c2y = cy + niny * 0.5 * rc
-                c2z = cz + ninz * 0.5 * rc
-                px = (
-                    c2x
-                    + 0.5 * rc * np.cos(theta) * (-ninx)
-                    + 0.5 * rc * np.sin(theta) * e0x
-                )
-                py = (
-                    c2y
-                    + 0.5 * rc * np.cos(theta) * (-niny)
-                    + 0.5 * rc * np.sin(theta) * e0y
-                )
-                pz = (
-                    c2z
-                    + 0.5 * rc * np.cos(theta) * (-ninz)
-                    + 0.5 * rc * np.sin(theta) * e0z
-                )
+    # --------------
+    # prepare output
 
-                lab = f'{k0}-rowland',
+    indr = np.zeros((nRZ,), dtype=int)
+    indz = np.zeros((nRZ,), dtype=int)
+    ncounts = np.full(shape_cam, 0.)
+
+    lp0, lp1 = [], []
+    xx, yy = [], []
+
+    dr = np.mean(np.diff(x0u))
+    dz = np.mean(np.diff(x1u))
+    ipts = 0
+    pti = np.r_[0., 0., 0.]
+    nru = iru.size
+    for i00, i0 in enumerate(iru):
+
+        indiz = ir == i0
+        nz = indiz.sum()
+        if np.all(np.isnan(dphi_r[:, i00])):
+            ipts += nz
+            continue
 
-            elif v0['type'] == 'toroidal':
-                c2x = cx + ninx * (rmin + rmax)
-                c2y = cy + niny * (rmin + rmax)
-                c2z = cz + ninz * (rmin + rmax)
-                px = (
-                    c2x
-                    + rmax * np.cos(theta) * (-ninx)
-                    + rmax * np.sin(theta) * emax[0]
-                )
-                py = (
-                    c2y
-                    + rmax * np.cos(theta) * (-niny)
-                    + rmax * np.sin(theta) * emax[1]
-                )
-                pz = (
-                    c2z
-                    + rmax * np.cos(theta) * (-ninz)
-                    + rmax * np.sin(theta) * emax[2]
+        nphi = np.ceil(x0u[i0]*(dphi_r[1, i00] - dphi_r[0, i00]) / res_phi).astype(int)
+        phir = np.linspace(dphi_r[0, i00], dphi_r[1, i00], nphi)
+        cosphi = np.cos(phir)
+        sinphi = np.sin(phir)
+
+        dphi = phir[1] - phir[0]
+        dv = dr * x0u[i0] * dphi * dz
+
+        for i11, i1 in enumerate(iz[indiz]):
+
+            indr[ipts] = i0
+            indz[ipts] = i1
+            pti[2] = x1u[i1]
+            done_xy = []
+
+            for i2, phii in enumerate(phir):
+
+                # set point
+                pti[0] = x0u[i0]*cosphi[i2]
+                pti[1] = x0u[i0]*sinphi[i2]
+
+                # ------------------------------------------
+                # initial polygon (crystal on its own plane)
+
+                p0, p1 = ptsvect_plane(
+                    pts_x=pti[0],
+                    pts_y=pti[1],
+                    pts_z=pti[2],
+                    vect_x=p0x - pti[0],
+                    vect_y=p0y - pti[1],
+                    vect_z=p0z - pti[2],
+                    strict=True,
+                    return_x01=True,
+                )[-2:]
+                p_a = plg.Polygon(np.array([p0, p1]).T)
+
+                if len(lpoly_post) > 0:
+                    # get equivalent aperture
+                    p0, p1 = _equivalent_apertures._get_equivalent_aperture(
+                        p_a=p_a,
+                        pt=pti,
+                        nop_pre=len(lpoly_post),
+                        lpoly_pre=lpoly_post,
+                        ptsvect=ptsvect_plane,
+                        min_threshold=min_threshold,
+                    )
+
+                    # skip if no intersection
+                    if p0 is None or p0.size == 0:
+                        continue
+
+                # compute image
+                (
+                    x0c, x1c, angles, dsang, cosi, iok,
+                    dangmin_str, x0if, x1if,
+                ) = _get_points_on_camera_from_pts(
+                    p0=p0,
+                    p1=p1,
+                    pti=pti,
+                    # ref
+                    cent=cent,
+                    nin=nin,
+                    e0=e0,
+                    e1=e1,
+                    # dang
+                    pix_size=pix_size,
+                    dist_to_cam=dist_to_cam,
+                    dang=dang,
+                    phi=phii,
+                    # resoluions
+                    n0=n0,
+                    n1=n1,
+                    # functions
+                    coords_x01toxyz_plane=coords_x01toxyz_plane,
+                    ptsvect_spectro=ptsvect_spectro,
+                    ptsvect_cam=ptsvect_cam,
+                )[:9]
+
+                # update
+                lp0.append(x0c)
+                lp1.append(x1c)
+                if i2 not in done_xy:
+                    xx.append(x0u[i0] * np.cos(phii))
+                    yy.append(x0u[i0] * np.sin(phii))
+                    done_xy.append(i2)
+
+                if verb is True:
+                    msg = (
+                        f"\t\t{i00} / {nru}, {i11} / {nz}, {i2} / {nphi}"
+                        f":  {iok.sum()} pts   "
+                        f"\t dangmin: {dangmin_str}"
+                    )
+                    print(msg, end='\r')
+
+                # safety check
+                iok2 = (
+                    (x0c[iok] >= cbin0[0])
+                    & (x0c[iok] <= cbin0[-1])
+                    & (x1c[iok] >= cbin1[0])
+                    & (x1c[iok] <= cbin1[-1])
                 )
 
-                lab = f'{k0}-majorR'
+                if not np.any(iok2):
+                    continue
 
-            dplot[k0]['r'] = {
-                'x': px,
-                'y': py,
-                'z': pz,
-                'r': np.hypot(px, py),
-                'props': {
-                    'label': lab,
-                    'ls': '--',
-                    'lw': 1.,
-                    'color': color,
-                },
-            }
-
-    return dplot
-
-
-# ##################################################################
-# ##################################################################
-#                   Wavelength from angle
-# ##################################################################
+                # update index
+                iok[iok] = iok2
 
+                # 2d pixel by binning
+                out = scpstats.binned_statistic_2d(
+                    x0c[iok],
+                    x1c[iok],
+                    dsang[iok],
+                    statistic='sum',
+                    bins=(cbin0, cbin1),
+                    expand_binnumbers=True,
+                )
 
-def get_lamb_from_angle(
-    coll=None,
-    key=None,
-    key_cam=None,
-    lamb=None,
-    rocking_curve=None,
-    units=None,
-    returnas=None,
-):
-    """"""
+                ipixok = out.statistic > 0
+                ncounts[ipixok] += out.statistic[ipixok] * dv
 
-    # ----------
-    # check
+    # ------------------
+    # length for etendue
 
-    # key
-    lok = list(coll.dobj.get('diagnostic', {}).keys())
-    key = ds._generic_check._check_var(
-        key, 'key',
-        types=str,
-        allowed=lok,
-    )
+    # mesh envelop
+    dout = coll.get_mesh_outline(key=key_mesh)
+    p0 = dout['x0']['data']
+    p1 = dout['x1']['data']
 
-    # key_cam
-    lok = list(coll.dobj['diagnostic'][key]['doptics'].keys())
-    key_cam = ds._generic_check._check_var(
-        key_cam, 'key_cam',
-        types=str,
-        allowed=lok,
+    etendue, length = _get_etendue_length(
+        coll=coll,
+        doptics=coll.dobj['diagnostic'][key]['doptics'][key_cam],
+        poly=np.array([p0, p1]),
     )
 
-    # doptics
-    doptics = coll.dobj['diagnostic'][key]['doptics'][key_cam]
-    if 'crystal' not in doptics['cls']:
-        raise Exception(f"Diag '{key}' is not a spectro!")
-
-    kcryst = doptics['optics'][doptics['cls'].index('crystal')]
-
-    dok = {
-        'lamb': 'alpha',
-        'lambmin': 'amin',
-        'lambmax': 'amax',
-        'dlamb': 'dlamb',
-        'res': 'res',
+    return {
+        'ncounts': {'data': ncounts / length, 'units': 'm3/m'},
+        'lp0': {'data': lp0, 'units': 'm'},
+        'lp1': {'data': lp1, 'units': 'm'},
+        'ptsx': {'data': np.array(xx), 'units': 'm'},
+        'ptsy': {'data': np.array(yy), 'units': 'm'},
+        'ptsr': {'data': x0u[ir], 'units': 'm'},
+        'ptsz': {'data': x1u[iz], 'units': 'm'},
     }
-    lok = list(dok.keys())
-    lamb = ds._generic_check._check_var(
-        lamb, 'lamb',
-        types=str,
-        allowed=lok,
-    )
 
-    # ----------
-    # compute
 
-    lv = []
-    data = None
-    lk = ['lamb', 'lambmin', 'lambmax']
-    for kk in lk:
-        if lamb in [kk, 'dlamb', 'res']:
-
-            if kk == 'lamb':
-                klos = coll.dobj['diagnostic'][key]['doptics'][key_cam]['los']
-                ka = coll.dobj['rays'][klos][dok[kk]]
-                ang = coll.ddata[ka]['data'][0, ...]
-                ref = coll.ddata[ka]['ref'][1:]
-            else:
-                ka = coll.dobj['diagnostic'][key]['doptics'][key_cam][dok[kk]]
-                ang = coll.ddata[ka]['data']
-                ref = coll.ddata[ka]['ref']
-
-            dd = coll.get_crystal_bragglamb(
-                key=kcryst,
-                bragg=ang,
-                rocking_curve=rocking_curve,
-            )[1]
-            if lamb == kk:
-                data = dd
-                break
-            else:
-                lv.append(dd)
+def _get_etendue_length(
+    coll=None,
+    doptics=None,
+    poly=None,
+):
 
-    # ----------------
-    # units conversion
+    # ----------------------
+    # get etendue and length
 
-    if units not in [None, 'm']:
-        if data is None:
+    ketend = doptics['etendue']
+    etendue = coll.ddata[ketend]['data']
 
-            for ii in range(3):
-                lv[ii] = _spectralunits.convert_spectral(
-                    data_in=lv[ii],
-                    units_in='m',
-                    units_out=units,
-                )[0]
+    # -------------------------
+    # los through mesh envelopp
 
-        else:
-            data = _spectralunits.convert_spectral(
-                data_in=data,
-                units_in='m',
-                units_out=units,
-            )[0]
+    # los
+    klos = doptics['los']
+    ptsx, ptsy, ptsz = coll.get_rays_pts(key=klos)
+    vectx, vecty, vectz = coll.get_rays_vect(key=klos)
+
+    iok = np.isfinite(vectx[-1, ...])
+    length = np.full(vectx.shape[1:], np.nan)
+
+    DD = np.array([
+        ptsx[-2, ...][iok],
+        ptsy[-2, ...][iok],
+        ptsz[-2, ...][iok],
+    ])
+    uu = np.array([
+        vectx[-1, ...][iok],
+        vecty[-1, ...][iok],
+        vectz[-1, ...][iok],
+    ])
+
+    # Prepare structures
+    from ..geom import _core
+    ves = _core.Ves(
+        Poly=poly,
+        Name='temp',
+        Exp='',
+    )
+
+    conf = _core.Config(
+        lStruct=[ves],
+        Name='temp',
+        Exp='',
+    )
+
+    # ray-tracing
+    cam = _core.CamLOS1D(
+        dgeom=(DD, uu),
+        config=conf,
+        Name='temp',
+        Diag='',
+        Exp='',
+        strict=False,
+    )
+
+    # length
+    length[iok] = (cam.dgeom['kOut'] - cam.dgeom['kIn'])
+
+    return etendue, length
+
+
+# ################################################
+# ################################################
+#           Sub-routine
+# ################################################
+
+
+def _get_points_on_camera_from_pts(
+    p0=None,
+    p1=None,
+    pti=None,
+    # ref
+    cent=None,
+    nin=None,
+    e0=None,
+    e1=None,
+    # dang
+    pix_size=None,
+    dist_to_cam=None,
+    dang=None,
+    phi=None,
+    # optional
+    n0=None,
+    n1=None,
+    # functions
+    coords_x01toxyz_plane=None,
+    ptsvect_spectro=None,
+    ptsvect_cam=None,
+    # output
+    ptsx_all=None,
+    ptsy_all=None,
+    ptsz_all=None,
+    # debug
+    debug=None,
+):
 
-    # -----------
-    # return
+    # anuglar resolution associated to pixels
+    vect = cent - pti
+    dist = np.linalg.norm(vect)
+    vect = vect / dist
+    dang_pix = pix_size / (dist_to_cam + dist)
+
+    # dang
+    dang_min = min(dang, 0.25*dang_pix)
+    dangmin_str = f"rock {dang:.2e} vs {0.25*dang_pix:.2e} 1/4 pixel"
+
+    # set n0, n1
+    p0min, p0max = p0.min(), p0.max()
+    p1min, p1max = p1.min(), p1.max()
+
+    if n0 is None:
+        cos0 = np.linalg.norm(np.cross(e0, vect))
+        ang0 = cos0 * (p0max - p0min) / dist
+        n0 = int(np.ceil(ang0 / dang_min)) + 2
+    if n1 is None:
+        cos1 = np.linalg.norm(np.cross(e1, vect))
+        ang1 = cos1 * (p1max - p1min) / dist
+        n1 = int(np.ceil(ang1 / dang_min)) + 2
+
+    # sample 2d equivalent aperture
+    margin0 = 1e-6 * (p0max - p0min)
+    margin1 = 1e-6 * (p1max - p1min)
+    x0i = np.linspace(p0min + margin0, p0max - margin0, n0)
+    x1i = np.linspace(p1min + margin1, p1max - margin1, n1)
+    dx0 = x0i[1] - x0i[0]
+    dx1 = x1i[1] - x1i[0]
+
+    # mesh
+    x0if = np.repeat(x0i[:, None], n1, axis=1)
+    x1if = np.repeat(x1i[None, :], n0, axis=0)
+    ind = Path(np.array([p0, p1]).T).contains_points(
+        np.array([x0if.ravel(), x1if.ravel()]).T
+    ).reshape((n0, n1))
+
+    # back to 3d
+    xx, yy, zz = coords_x01toxyz_plane(
+        x0=x0if,
+        x1=x1if,
+    )
+
+    # approx solid angles
+    ax = xx - pti[0]
+    ay = yy - pti[1]
+    az = zz - pti[2]
+    di = np.sqrt(ax**2 + ay**2 + az**2)
+    cos = np.abs((nin[0] * ax + nin[1] * ay + nin[2] * az) / di)
+    dsang = dx0 * dx1 * cos / di**2
+
+    # get normalized vector from plasma point to crystal
+    vectx = ax / di
+    vecty = ay / di
+    vectz = az / di
 
-    if lamb == 'dlamb':
-        data = np.abs(lv[2] - lv[1])
-    elif lamb == 'res':
-        data = lv[0] / np.abs(lv[2] - lv[1])
+    # get local cosine vs toroidal direction (for doppler)
+    cos = -vectx*np.sin(phi) + vecty*np.cos(phi)
 
-    return data, ref
+    # get reflexion
+    (
+        ptsx1, ptsy1, ptsz1,
+        vx, vy, vz,
+        angles,
+    ) = ptsvect_spectro(
+        pts_x=pti[0],
+        pts_y=pti[1],
+        pts_z=pti[2],
+        vect_x=vectx,
+        vect_y=vecty,
+        vect_z=vectz,
+        strict=False,
+        return_x01=False,
+    )[:7]
+
+    # get x0, x1 on camera
+    x0c, x1c, ptsx2, ptsy2, ptsz2 = ptsvect_cam(
+        pts_x=ptsx1,
+        pts_y=ptsy1,
+        pts_z=ptsz1,
+        vect_x=vx,
+        vect_y=vy,
+        vect_z=vz,
+    )
+
+    return (
+        x0c, x1c, angles, dsang, cos, ind,
+        dangmin_str, x0if, x1if,
+        ptsx1, ptsy1, ptsz1,
+        ptsx2, ptsy2, ptsz2,
+    )
 
 
-# ##################################################################
-# ##################################################################
-#                   get data
-# ##################################################################
+# ####################################################
+# ####################################################
+#               plot
+# ####################################################
 
 
-def _get_data(
+def _plot(
     coll=None,
     key=None,
     key_cam=None,
-    data=None,
-    rocking_curve=None,
-    units=None,
-    default=None,
-    **kwdargs,
+    dout=None,
+    # auxiliary
+    cbin0=None,
+    cbin1=None,
+    is2d=None,
+    # options
+    plot_config=None,
+    plot_pixels=None,
+    vmin=None,
+    vmax=None,
+    aspect3d=None,
+    elements=None,
+    colorbar=None,
+    # options
+    dax=None,
+    fs=None,
+    dmargin=None,
+    wintit=None,
 ):
 
-    # key, key_cam
-    key, key_cam = coll.get_diagnostic_cam(
-        key=key,
-        key_cam=key_cam,
-        default=default,
+    # --------------
+    # check inputs
+
+    aspect3d = ds._generic_check._check_var(
+        aspect3d, 'aspect3d',
+        default='equal',
+        allowed=['auto', 'equal'],
     )
-    spectro = coll.dobj['diagnostic'][key]['spectro']
-    # is2d = coll.dobj['diagnostic'][key]['is2d']
 
-    # basic check on data
-    if data is not None:
-        lquant = ['etendue', 'amin', 'amax']  # 'los'
-        lcomp = ['length', 'tangency radius', 'alpha', 'alpha_pixel']
-        if spectro:
-            llamb = ['lamb', 'lambmin', 'lambmax', 'dlamb', 'res']
-            lvos = ['vos_lamb', 'vos_dlamb', 'vos_ph_integ']
-        else:
-            llamb = []
-            lvos = ['vos_sang_integ']
-        lsynth = coll.dobj['diagnostic'][key]['signal']
-
-        if len(key_cam) == 1:
-            lraw = [
-                k0 for k0, v0 in coll.ddata.items()
-                if v0['ref'] == coll.dobj['camera'][key_cam[0]]['dgeom']['ref']
-            ]
-        else:
-            lraw = []
+    elements = ds._generic_check._check_var(
+        elements, 'elements',
+        default='o',
+        types=str,
+    )
 
-        if lsynth is None:
-            lsynth = []
-        lcomp += llamb
+    # --------------
+    # add ncounts to ddata
 
-        data = ds._generic_check._check_var(
-            data, 'data',
-            types=str,
-            allowed=lquant + lcomp + lsynth + lraw + lvos,
-        )
+    ktemp = f'{key_cam}_ncounts'
+    nn = len([
+        k0 for k0 in coll.ddata.keys()
+        if k0.startswith(ktemp)
+    ])
+    if nn > 0:
+        ktemp = f'{ktemp}{nn}'
+
+    coll.add_data(
+        key=ktemp,
+        ref=coll.dobj['camera'][key_cam]['dgeom']['ref'],
+        **dout['ncounts'],
+    )
+
+    kd = 'sang_lamb'
+    if vmin is None:
+        vmin = 0
+    if vmax is None:
+        vmax = np.nanmax(dout[kd]['data'])
 
-    # build ddata
-    ddata = {}
-    static = True
-    daxis = None
-
-    # comp = False
-    if data is None or data in lquant:
-
-        # --------------------------
-        # data is None => kwdargs
-
-        if data is None:
-            # check kwdargs
-            dparam = coll.get_param(which='data', returnas=dict)
-            lkout = [k0 for k0 in kwdargs.keys() if k0 not in dparam.keys()]
-
-            if len(lkout) > 0:
-                msg = (
-                    "The following args correspond to no data parameter:\n"
-                    + "\n".join([f"\t- {k0}" for k0 in lkout])
-                )
-                raise Exception(msg)
+    # --------------
+    # prepare
 
-            # list all available data
-            lok = [
-                k0 for k0, v0 in coll.ddata.items()
-                if v0.get('camera') in key_cam
-            ]
-
-            # Adjust with kwdargs
-            if len(kwdargs) > 0:
-                lok2 = coll.select(
-                    which='data', log='all', returnas=str, **kwdargs,
-                )
-                lok = [k0 for k0 in lok2 if k0 in lok]
+    dplot = coll.get_diagnostic_dplot(
+        key=key,
+        key_cam=key_cam,
+        optics=None,
+        elements=elements,
+    )
 
-            # check there is 1 data per cam
-            lcam = [
-                coll.ddata[k0]['camera'] for k0 in lok
-                if coll.ddata[k0]['camera'] in key_cam
-            ]
+    # --------------
+    # plot_pixels
 
-            if len(set(lcam)) > len(key_cam):
-                msg = (
-                    "There are more / less data identified than cameras:\n"
-                    f"\t- key_cam:  {key_cam}\n"
-                    f"\t- data cam: {lcam}\n"
-                    f"\t- data: {data}"
-                )
-                raise Exception(msg)
+    out0, out1 = coll.get_optics_outline(key_cam, total=True)
+    ck0f = np.array([cbin0, cbin0, np.full((cbin0.size,), np.nan)])
+    ck1f = np.array([cbin1, cbin1, np.full((cbin1.size,), np.nan)])
+    ck01 = np.r_[np.min(cbin1), np.max(cbin1), np.nan]
+    ck10 = np.r_[np.min(cbin0), np.max(cbin0), np.nan]
+
+    # --------------
+    # pepare dax
+
+    if dax is None:
+        dax, cax = _get_dax(
+            fs=fs,
+            dmargin=dmargin,
+        )
+        # dax = _generic_plot.get_dax_diag(
+            # proj=['cross', 'hor', '3d', 'camera'],
+            # dmargin=dmargin,
+            # fs=fs,
+            # wintit=wintit,
+            # tit=key,
+            # is2d=True,
+            # key_cam=['rays', 'binned'],
+        # )
 
-            elif len(set(lcam)) < len(key_cam):
-                pass
+    dax = _generic_check._check_dax(dax=dax, main='cross')
 
-            # reorder
-            ddata = {
-                cc: lok[lcam.index(cc)]
-                for cc in key_cam if cc in lcam
-            }
-
-        # -----------------
-        # data in lquant
-
-        elif data in lquant:
-            for cc in key_cam:
-                # if data == 'los':
-                #     kr = coll.dobj['diagnostic'][key]['doptics'][cc][data]
-                #     dd = coll.dobj['rays'][kr]['pts']
-                # else:
-                dd = coll.dobj['diagnostic'][key]['doptics'][cc][data]
-                lc = [
-                    isinstance(dd, str) and dd in coll.ddata.keys(),
-                    # isinstance(dd, tuple)
-                    # and all([isinstance(di, str) for di in dd])
-                    # and all([di in coll.ddata.keys() for di in dd])
-                ]
-                if lc[0]:
-                    ddata[cc] = dd
-                # elif lc[1]:
-                #     ddata[cc] = list(dd)
-                elif dd is None:
-                    pass
-                else:
-                    msg = f"Unknown data: '{data}'"
-                    raise Exception(msg)
+    # --------------
+    # prepare camera
 
-        # dref
-        dref = {
-            k0: coll.ddata[v0]['ref']
-            for k0, v0 in ddata.items()
-        }
-
-        # units
-        if len(ddata) > 0:
-            units = coll.ddata[ddata[key_cam[0]]]['units']
-        else:
-            units = None
+    kax = 'cam_all'
+    if dax.get(kax) is not None:
+        ax = dax[kax]['handle']
+
+        ax.plot(
+            np.r_[out0, out0[0]],
+            np.r_[out1, out1[0]],
+            c='k',
+            ls='-',
+            lw=0.5,
+        )
 
-        # get actual data
-        ddata = {
-            k0 : coll.ddata[v0]['data']
-            for k0, v0 in ddata.items()
-        }
+        if plot_pixels is True:
+            ax.plot(
+                ck0f.T.ravel(),
+                np.tile(ck01, cbin0.size),
+                c='k',
+                ls='-',
+                lw=0.1,
+            )
+            ax.plot(
+                np.tile(ck10, cbin1.size),
+                ck1f.T.ravel(),
+                c='k',
+                ls='-',
+                lw=0.1,
+            )
 
-    # --------------------
-    # data to be computed
 
-    elif data in lcomp:
+    # -------------
+    # mesh sampling
 
-        # comp = True
-        ddata = {}
-        dref = {}
-
-        if data in llamb:
-            for cc in key_cam:
-               ddata[cc], dref[cc] = coll.get_diagnostic_lamb(
-                   key=key,
-                   key_cam=cc,
-                   rocking_curve=rocking_curve,
-                   lamb=data,
-                   units=units,
-               )
-            if data in ['lamb', 'lambmin', 'lambmax', 'dlamb']:
-                units = 'm'
-            else:
-                units = ''
-
-        elif data in ['length', 'tangency radius', 'alpha']:
-            for cc in key_cam:
-                ddata[cc], _, dref[cc] = coll.get_rays_quantity(
-                    key=key,
-                    key_cam=cc,
-                    quantity=data,
-                    segment=-1,
-                    lim_to_segments=False,
-                )
-            if data in ['length', 'tangency radius']:
-                units = 'm'
-            else:
-                units = 'rad'
-
-        elif data == 'alpha_pixel':
-            for cc in key_cam:
-
-                klos = coll.dobj['diagnostic'][key]['doptics'][cc]['los']
-                vectx, vecty, vectz = coll.get_rays_vect(klos)
-                dvect = coll.get_camera_unit_vectors(cc)
-                sca = (
-                    dvect['nin_x'] * vectx
-                    + dvect['nin_y'] * vecty
-                    + dvect['nin_z'] * vectz
-                )
+    if dout.get('lpx') is None:
 
-                ddata[cc] = np.arccos(sca)
-                dref[cc] = coll.dobj['camera'][cc]['dgeom']['ref']
-                units = 'rad'
-
-    elif data in lsynth:
-
-        dref = {}
-        daxis = {}
-        dsynth = coll.dobj['synth sig'][data]
-        for cc in key_cam:
-            kdat = dsynth['data'][dsynth['camera'].index(cc)]
-            refcam = coll.dobj['camera'][cc]['dgeom']['ref']
-            ref = coll.ddata[kdat]['ref']
-
-            c0 = (
-                tuple([rr for rr in ref if rr in refcam]) == refcam
-                and len(ref) in [len(refcam), len(refcam) + 1]
+        kax = 'cross'
+        if dax.get(kax) is not None:
+            ax = dax[kax]['handle']
+
+            ax.plot(
+                dout['ptsr']['data'],
+                dout['ptsz']['data'],
+                ls='None',
+                lw=1.,
+                marker='.',
             )
-            if not c0:
-                msg = (
-                    "Can only plot data that is either:\n"
-                    "\t- static: same refs as the camera\n"
-                    "\t- has a unique extra dimension\n"
-                    "Provided:\n"
-                    "\t- refcam: {refcam}\n"
-                    "\t- ['{kdat}']['ref']: {ref}"
-                )
-                raise Exception(msg)
 
-            if len(ref) == len(refcam) + 1:
-                static = False
-                daxis[cc] = [
-                    ii for ii, rr in enumerate(ref) if rr not in refcam
-                ][0]
-
-            ddata[cc] = coll.ddata[kdat]['data']
-            dref[cc] = ref
-
-            units = coll.ddata[kdat]['units']
-
-    elif data in lraw:
-        ddata = {key_cam[0]: coll.ddata[data]['data']}
-        dref = {key_cam[0]: coll.dobj['camera'][key_cam[0]]['dgeom']['ref']}
-        units = coll.ddata[data]['units']
-        static = True
-
-    elif data in lvos:
-
-        static = True
-        ddata, dref = {}, {}
-        doptics = coll.dobj['diagnostic'][key]['doptics']
-        for cc in key_cam:
-
-            # safety check
-            ref = coll.dobj['camera'][cc]['dgeom']['ref']
-            dvos = doptics[cc].get('dvos')
-            if dvos is None:
-                msg = (
-                    f"Data '{data}' cannot be retrived for diag '{key}' "
-                    "cam '{cc}' because no dvos computed"
-                )
-                raise Exception(msg)
-
-            # cases
-            if data == 'vos_sang_integ':
-                kdata = dvos['sang']
-                ddata[cc] = np.nansum(coll.ddata[kdata]['data'], axis=-1)
-                dref[cc] = ref
-                units = coll.ddata[kdata]['units']
-
-            elif data in ['vos_lamb', 'vos_dlamb', 'vos_ph_integ']:
-                kph = dvos['ph']
-                ph = coll.ddata[kph]['data']
-                ph_tot = np.sum(ph, axis=(-1, -2))
-
-                if data == 'vos_ph_integ':
-                    out = ph_tot
-                    kout = kph
-                else:
-                    kout = dvos['lamb']
-                    re_lamb = [1 for rr in ref] + [1, -1]
-                    lamb = coll.ddata[kout]['data'].reshape(re_lamb)
-
-                    i0 = ph == 0
-                    if data == 'vos_lamb':
-                        out = np.sum(ph * lamb, axis=(-1, -2)) / ph_tot
-                    else:
-                        for ii, i1 in enumerate(re_lamb[:-1]):
-                            lamb = np.repeat(lamb, ph.shape[ii], axis=ii)
-
-                        lamb[i0] = -np.inf
-                        lambmax = np.max(lamb, axis=(-1, -2))
-                        lamb[i0] = np.inf
-                        lambmin = np.min(lamb, axis=(-1, -2))
-                        out = lambmax - lambmin
-                    out[np.all(i0, axis=(-1, -2))] = np.nan
-
-                ddata[cc] = out
-                dref[cc] = ref
-                units = coll.ddata[kout]['units']
-
-    return ddata, dref, units, static, daxis
-
-
-# ##################################################################
-# ##################################################################
-#                   concatenate data
-# ##################################################################
-
-
-# def _concatenate_check(
-    # coll=None,
-    # key=None,
-    # key_cam=None,
-    # data=None,
-    # rocking_curve=None,
-    # returnas=None,
-    # # naming
-    # key_data=None,
-    # key_ref=None,
-    # **kwdargs,
-    # ):
-
-    # # -------------
-    # # key, key_cam
-    # # -------------
-
-    # key, key_cam = coll.get_diagnostic_cam(key=key, key_cam=key_cam)
-    # spectro = coll.dobj['diagnostic'][key]['spectro']
-    # is2d = coll.dobj['diagnostic'][key]['is2d']
-    # # stack = coll.dobj['diagnostic'][key]['stack']
-
-    # if is2d and len(key_cam) > 1:
-        # msg = (
-            # "Cannot yet concatenate several 2d cameras\n"
-            # "\t- key: '{key}'\n"
-            # "\t- is2d: {is2d}\n"
-            # "\t- key_cam: {key_cam}\n"
-        # )
-        # raise NotImplementedError(msg)
+        kax = 'hor'
+        if dax.get(kax) is not None:
+            ax = dax[kax]['handle']
+
+            ax.plot(
+                dout['ptsx']['data'],
+                dout['ptsy']['data'],
+                ls='None',
+                lw=1.,
+                marker='.',
+            )
 
-    # # ---------------
-    # # build ddata
-    # # -------------
-
-    # # basic check on data
-    # if data is not None:
-        # lquant = ['los', 'etendue', 'amin', 'amax']
-        # lcomp = ['tangency radius']
-        # if spectro:
-            # lcomp += ['lamb', 'lambmin', 'lambmax', 'res']
-
-        # data = ds._generic_check._check_var(
-            # data, 'data',
-            # types=str,
-            # allowed=lquant + lcomp,
-        # )
+        kax = 'cam_all'
+        if dax.get(kax) is not None:
+            ax = dax[kax]['handle']
+
+            p0 = np.concatenate([pp.ravel() for pp in dout['lp0']['data']])
+            p1 = np.concatenate([pp.ravel() for pp in dout['lp1']['data']])
+            ax.plot(
+                p0,
+                p1,
+                ls='None',
+                marker='.',
+            )
 
-    # # build ddata
-    # ddata = {}
-    # comp = False
-    # if data is None or data in lquant:
-
-        # # --------------------------
-        # # data is None => kwdargs
-
-        # if data is None:
-            # # check kwdargs
-            # dparam = coll.get_param(which='data', returnas=dict)
-            # lkout = [k0 for k0 in kwdargs.keys() if k0 not in dparam.keys()]
-
-            # if len(lkout) > 0:
-                # msg= (
-                    # "The following args correspond to no data parameter:\n"
-                    # + "\n".join([f"\t- {k0}" for k0 in lkout])
-                # )
-                # raise Exception(msg)
-
-            # # list all available data
-            # lok = [
-                # k0 for k0, v0 in coll.ddata.items()
-                # if v0.get('camera') in key_cam
-            # ]
-
-            # # Adjust with kwdargs
-            # if len(kwdargs) > 0:
-                # lok2 = coll.select(
-                    # which='data', log='all', returnas=str, **kwdargs,
-                # )
-                # lok = [k0 for k0 in lok2 if k0 in lok]
-
-            # # check there is 1 data per cam
-            # lcam = [
-                # coll.ddata[k0]['camera'] for k0 in lok
-                # if coll.ddata[k0]['camera'] in key_cam
-            # ]
-
-            # if len(set(lcam)) > len(key_cam):
-                # msg = (
-                    # "There are more / less data identified than cameras:\n"
-                    # f"\t- key_cam:  {key_cam}\n"
-                    # f"\t- data cam: {lcam}\n"
-                    # f"\t- data: {data}"
-                # )
-                # raise Exception(msg)
-            # elif len(set(lcam)) < len(key_cam):
-                # pass
-
-            # # reorder
-            # ddata = {
-                # cc: [lok[lcam.index(cc)]]
-                # for cc in key_cam if cc in lcam
-            # }
-
-        # # -----------------
-        # # data in lquant
-
-        # elif data in lquant:
-            # for cc in key_cam:
-                # if data == 'los':
-                    # kr = coll.dobj['diagnostic'][key]['doptics'][cc][data]
-                    # dd = coll.dobj['rays'][kr]['pts']
-                # else:
-                    # dd = coll.dobj['diagnostic'][key]['doptics'][cc][data]
-                # lc = [
-                    # isinstance(dd, str) and dd in coll.ddata.keys(),
-                    # isinstance(dd, tuple)
-                    # and all([isinstance(di, str) for di in dd])
-                    # and all([di in coll.ddata.keys() for di in dd])
-                # ]
-                # if lc[0]:
-                    # ddata[cc] = [dd]
-                # elif lc[1]:
-                    # ddata[cc] = list(dd)
-                # elif dd is None:
-                    # pass
-                # else:
-                    # msg = f"Unknown data: '{data}'"
-                    # raise Exception(msg)
-
-        # # dref
-        # dref = {
-            # k0: [coll.ddata[k1]['ref'] for k1 in v0]
-            # for k0, v0 in ddata.items()
-        # }
-
-    # # --------------------
-    # # data to be computed
-
-    # # TBF
-    # elif data in lcomp:
-
-        # comp = True
-        # ddata = {[None] for cc in key_cam}
-        # dref = {[None] for cc in key_cam}
-
-        # if data in ['lamb', 'lambmin', 'lambmax', 'res']:
-            # for cc in key_cam:
-               # ddata[cc][0], dref[cc][0] = coll.get_diagnostic_lamb(
-                   # key=key,
-                   # key_cam=cc,
-                   # rocking_curve=rocking_curve,
-                   # lamb=data,
-               # )
-
-        # elif data == 'tangency radius':
-            # ddata[cc][0], _, dref[cc][0] = coll.get_rays_tangency_radius(
-                # key=key,
-                # key_cam=key_cam,
-                # segment=-1,
-                # lim_to_segments=False,
-            # )
-
-    # # -----------------------------------
-    # # Final safety checks and adjustments
-    # # -----------------------------------
-
-    # # adjust key_cam
-    # key_cam = [cc for cc in key_cam if cc in ddata.keys()]
-
-    # # ddata vs dref vs key_cam
-    # lcd = sorted(list(ddata.keys()))
-    # lcr = sorted(list(dref.keys()))
-    # if not (sorted(key_cam) == lcd == lcr):
-        # msg = (
-            # "Wrong keys!\n"
-            # f"\t- key_cam: {key_cam}\n"
-            # f"\t- ddata.keys(): {lcd}\n"
-            # f"\t- dref.keys(): {lcr}\n"
-        # )
-        # raise Exception(msg)
+    else:
 
-    # # nb of data per cam
-    # ln = [len(v0) for v0 in ddata.values()]
-    # if len(set(ln)) != 1:
-        # msg = (
-            # "Not the same number of data per cameras!\n"
-            # + str(ddata)
-        # )
-        # raise Exception(msg)
+        # --------------
+        # ray-tracing
 
-    # # check shapes and ndim
-    # dshapes = {
-        # k0: [tuple([coll.dref[k2]['size'] for k2 in k1]) for k1 in v0]
-        # for k0, v0 in dref.items()
-    # }
-
-    # # all same ndim
-    # ndimref = None
-    # for k0, v0 in dshapes.items():
-        # lndim = [len(v1) for v1 in v0]
-        # if len(set(lndim)) > 1:
-            # msg = "All data must have same number of dimensions!\n{dshapes}"
-            # raise Exception(msg)
-        # if ndimref is None:
-            # ndimref = lndim[0]
-        # elif lndim[0] != ndimref:
-            # msg = "All data must have same number of dimensions!\n{dshapes}"
-            # raise Exception(msg)
-
-    # # check indices of camera ref in data ref
-    # indref = None
-    # for k0, v0 in dref.items():
-        # for v1 in v0:
-            # ind = [v1.index(rr) for rr in coll.dobj['camera'][k0]['dgeom']['ref']]
-            # if indref is None:
-                # indref = ind
-            # elif ind != indref:
-                # msg = "All data must have same index of cam ref!\n{drf}"
-                # raise Exception(msg)
-
-    # if len(indref) > 1:
-        # msg = "Cannot conatenate 2d cameras so far"
-        # raise Exception(msg)
-
-    # # check all shapes other than camera shapes are identical
-    # if ndimref > len(indref):
-        # ind = np.delete(np.arange(0, ndimref), indref)
-        # shape0 = tuple(np.r_[dshapes[key_cam[0]][0]][ind])
-        # lcout = [
-            # cc for cc in key_cam
-            # if any([tuple(np.r_[vv][ind]) != shape0 for vv in dshapes[cc]])
-        # ]
-        # if len(lcout) > 0:
-            # msg = (
-                # "The cameras data shall all have same shape (except pixels)\n"
-                # + str(dshapes)
-            # )
-            # raise Exception(msg)
-
-    # # check indices of camera ref in data ref
-    # ref = None
-    # for k0, v0 in dref.items():
-        # for v1 in v0:
-            # if ref is None:
-                # ref = [
-                    # None if ii == indref[0] else rr
-                    # for ii, rr in enumerate(v1)
-                # ]
-            # else:
-                # lc = [
-                    # v1[ii] == ref[ii] for ii in range(ndimref)
-                    # if ii not in indref
-                # ]
-                # if not all(lc):
-                    # msg = (
-                        # "All ref axcept the camera ref must be the same!\n"
-                        # f"\t- ref: {ref}\n"
-                        # f"\t- indref: {indref}\n"
-                        # f"\t- ndimref: {ndimref}\n"
-                        # f"\t- v1: {v1}\n"
-                        # f"\t- lc: {lc}\n"
-                        # + str(dref)
-                    # )
-                    # raise Exception(msg)
-
-    # # -----------------------------------
-    # # keys for new data and ref
-    # # -----------------------------------
-
-    # if key_data is None:
-        # if data in lquant + lcomp:
-            # if data == 'los':
-                # key_data = [
-                    # f'{key}_los_ptsx',
-                    # f'{key}_los_ptsy',
-                    # f'{key}_los_ptsz',
-                # ]
-            # else:
-                # key_data = [f'{key}_{data}']
-        # else:
-            # key_data = [f'{key}_data']
-    # elif isinstance(key_data, str):
-        # key_data = [key_data]
-
-    # if key_ref is None:
-        # key_ref = f'{key}_npix'
-
-    # ref = tuple([key_ref if rr is None else rr for rr in ref])
-
-    # # -----------------------------------
-    # # Other variables
-    # # -----------------------------------
-
-    # # returnas
-    # returnas = ds._generic_check._check_var(
-        # returnas, 'returnas',
-        # default='Datastock',
-        # allowed=[dict, 'Datastock'],
-    # )
-
-    # return (
-        # key, key_cam, is2d,
-        # ddata, ref, comp,
-        # dshapes, ndimref, indref,
-        # key_data, key_ref,
-        # returnas,
-    # )
+        for ii in range(len(dout['lp0']['data'])):
 
+            p0 = dout['lp0']['data'][ii]
+            p1 = dout['lp1']['data'][ii]
 
-def _concatenate_data_check(
-    coll=None,
-    key=None,
-    key_data=None,
-    key_cam=None,
-    flat=None,
-):
+            # --------------
+            # camera image
+
+            kax = 'cam_all'
+            if dax.get(kax) is not None:
+                ax = dax[kax]['handle']
+
+                if dout['lamb']['data'] is None:
+                    ax.plot(
+                        p0,
+                        p1,
+                        ls='None',
+                        marker='.',
+                        # c=dout['lcolor'][ii],
+                    )
+                elif dout['rocking_curve'] is False:
+                    ax.plot(
+                        p0[dout['lindin'][ii]],
+                        p1[dout['lindin'][ii]],
+                        ls='None',
+                        marker='.',
+                        # c=dout['lcolor'][ii],
+                    )
+                    ax.plot(
+                        p0[~dout['lindin'][ii]],
+                        p1[~dout['lindin'][ii]],
+                        ls='None',
+                        marker='.',
+                        c=(0.8, 0.8, 0.8),
+                    )
+                else:
+                    ax.scatter(
+                        p0,
+                        p1,
+                        # c=dout['lcolor'][ii],
+                        s=8,
+                        marker='.',
+                    )
+
+            # --------------
+            # rays
+
+            ind = np.arange(3, dout['lpx']['data'][ii].size, 3)
+            px = np.insert(dout['lpx']['data'][ii].T.ravel(), ind, np.nan)
+            py = np.insert(dout['lpy']['data'][ii].T.ravel(), ind, np.nan)
+            pz = np.insert(dout['lpz']['data'][ii].T.ravel(), ind, np.nan)
+
+            kax = 'cross'
+            if dax.get(kax) is not None:
+                ax = dax[kax]['handle']
+
+                ax.plot(
+                    np.hypot(px, py),
+                    pz,
+                    ls='-',
+                    lw=1.,
+                )
 
-    # ---------------
-    # key and key_cam
-    # ---------------
+            kax = 'hor'
+            if dax.get(kax) is not None:
+                ax = dax[kax]['handle']
+
+                ax.plot(
+                    px,
+                    py,
+                    ls='-',
+                    lw=1.,
+                )
 
-    key, key_cam = coll.get_diagnostic_cam(key=key, key_cam=key_cam)
-    spectro = coll.dobj['diagnostic'][key]['spectro']
-    is2d = coll.dobj['diagnostic'][key]['is2d']
-    stack = coll.dobj['diagnostic'][key]['stack']
-
-    # ------------
-    # key_data
-    # ------------
+            kax = '3d'
+            if dax.get(kax) is not None:
+                ax = dax[kax]['handle']
+
+                ax.plot(
+                    px,
+                    py,
+                    pz,
+                    ls='-',
+                    lw=1.,
+                )
 
     # ----------
-    # key_data
+    # counts
 
-    if isinstance(key_data, str):
-
-        if key_data in coll.ddata.keys():
-            key_data = [key_data]
-
-        else:
-            lok = coll.dobj['diagnostic'][key]['signal']
-            if lok is None:
-                lok = []
-            key_data = ds._generic_check._check_var(
-                key_data, 'key_data',
-                types=str,
-                allowed=lok,
-            )
-
-            key_data = coll.dobj['synth sig'][key_data]['data']
-
-    # ------------------------
-    # basic consistency check
-    # ------------------------
-
-    c0 = (
-        isinstance(key_data, list)
-        and all([
-            isinstance(kk, str) and kk in coll.ddata.keys()
-            for kk in key_data
-        ])
-    )
-    if not c0:
-        msg = (
-            "Arg key_data must be a list of valid data keys!\n"
-            f"Provided: {key_data}"
+    kax = 'cam_bin'
+    if dax.get(kax) is not None:
+        ax = dax[kax]['handle']
+
+        extent = (cbin0[0], cbin0[-1], cbin1[0], cbin1[-1])
+        im = ax.imshow(
+            dout[kd]['data'].T,
+            extent=extent,
+            interpolation='nearest',
+            origin='lower',
+            vmin=vmin,
+            vmax=vmax,
         )
-        raise Exception(msg)
 
-    # ---------------
-    # check cameras
-    # ---------------
+        ax.set_title(kd, size=12, fontweight='bold')
+        if colorbar is True:
+            cb = plt.colorbar(im, ax=ax, cax=cax)
+            cb.set_label(dout[kd]['units'], size=12, weight='bold')
 
-    # get excluded cameras, if any
-    dout = {
-        k0: coll.ddata[k0].get('camera')
-        for k0 in key_data
-        if coll.ddata[k0].get('camera') not in key_cam
-    }
-    if len(dout) > 0:
-        lstr = [f"\t- {k0}: {v0}" for k0, v0 in dout.items()]
-        msg = (
-            f"The following data refers to no known camera in diag '{key}':\n"
-            + "\n".join(lstr)
-        )
-        raise Exception(msg)
-
-    # check unicity of cameras
-    lcam = [coll.ddata[k0]['camera'] for k0 in key_data]
-    if len(set(lcam)) > len(lcam):
-        msg = (
-            f"Non-unique camera references for diag '{key}'\n:"
-            f"\t- key_data = {key_data}\n"
-            f"\t- lcam     = {lcam}\n"
-        )
-        raise Exception(msg)
-
-    key_cam = [k0 for k0 in key_cam if k0 in lcam]
-
-    # ------------
-    # re-order
-    # -------------
+    # ----------
+    # diag geom
 
-    key_data = [key_data[lcam.index(k0)] for k0 in key_cam]
+    _class8_plot._plot_diag_geom(
+        dax=dax,
+        key_cam=key_cam,
+        dplot=dplot,
+        is2d=coll.dobj['diagnostic'][key]['is2d'],
+    )
 
-    # ref uniformity
-    lref = [coll.ddata[k0]['ref'] for k0 in key_data]
-    if any([len(ref) != len(lref[0]) for ref in lref[1:]]):
-        msg = (
-            f"Non uniform refs for data in diag '{key}':\n"
-            f"\t- key_data = {key_data}\n"
-            f"\t- lref = {lref}\n"
-        )
-        raise Exception(msg)
+    # -------
+    # config
 
-    # -------------
-    # ref and axis
-    # -------------
+    if plot_config.__class__.__name__ == 'Config':
 
-    laxcam = [
-        [
-            ref.index(rr)
-            for rr in coll.dobj['camera'][key_cam[ii]]['dgeom']['ref']
-        ]
-        for ii, ref in enumerate(lref)
-    ]
-    if any([len(ax) != len(laxcam[0]) for ax in laxcam[1:]]):
-        msg = (
-            f"Non-uniform camera concatenation axis for diag '{key}':\n"
-            f"\t- key_data: {key_data}\n"
-            f"\t- laxcam:   {laxcam}"
-        )
-        import pdb; pdb.set_trace()     # DB
-        raise Exception(msg)
+        kax = 'cross'
+        if dax.get(kax) is not None:
+            ax = dax[kax]['handle']
+            plot_config.plot(lax=ax, proj=kax, dLeg=False)
 
-    laxcam = np.array(laxcam)
-    if not np.allclose(laxcam, laxcam[0:1, :]):
-        msg = (
-            f"Non-uniform axis for concatenation for diag '{key}':\n"
-            f"\t- laxcam: {laxcam}"
-        )
-        raise Exception(msg)
-    axcam = laxcam[0]
+        kax = 'hor'
+        if dax.get(kax) is not None:
+            ax = dax[kax]['handle']
+            plot_config.plot(lax=ax, proj=kax, dLeg=False)
 
-    if len(axcam) != 1 + is2d:
-        msg = (
-            f"ref not consistent with is2d for diag '{key}':\n"
-            f"\t- is2d: {is2d}\n"
-            f"\t- axcam: {axcam}\n"
-        )
-        raise Exception(msg)
+    # --------------
+    # aspect3d
 
-    ref = list(lref[0])
-    for ii in axcam:
-        ref[ii] = None
+    if aspect3d == 'equal' and dax.get('3d') is not None:
+        ds.set_aspect3d(ax=dax['3d']['handle'])
 
-    # --------
-    # flat
-    # --------
+    # --------------
+    # clean up
 
-    flat = ds._generic_check._check_var(
-        flat, 'flat',
-        types=bool,
-        default=is2d,
-    )
+    coll.remove_data(ktemp)
 
-    return key, key_data, key_cam, is2d, stack, ref, flat
+    return
 
 
-def _concatenate_data(
-    coll=None,
-    key=None,
-    key_data=None,
-    key_cam=None,
-    flat=None,
+def _get_dax(
+    fs=None,
+    dmargin=None,
 ):
 
-    # ------------
-    # check inputs
+    # ----------
+    # check
 
-    key, key_data, key_cam, is2d, stack, ref, flat = _concatenate_data_check(
-        coll=coll,
-        key=key,
-        key_data=key_data,
-        key_cam=key_cam,
-        flat=flat,
+    if fs is None:
+        fs = (15, 9)
+
+    dmargin = ds._generic_check._check_var(
+        dmargin, 'dmargin',
+        types=dict,
+        default={
+            'bottom': 0.05, 'top': 0.95,
+            'left': 0.05, 'right': 0.94,
+            'wspace': 0.20, 'hspace': 0.25,
+        },
     )
 
-    # ------------
+    # --------
     # prepare
 
-    if is2d:
-        ax0 = ref.index(None)
-        ax1 = len(ref) - 1 - ref[::-1].index(None)
-        if flat:
-            ldata = []
-            for k0 in key_data:
-                sh = list(coll.ddata[k0]['data'].shape)
-                size = sh[ax0] * sh[ax1]
-                sh = tuple(np.r_[sh[:ax0], size, sh[ax1+1:]].astype(int))
-                ldata.append(coll.ddata[k0]['data'].reshape(sh))
-            axis = ax0
-        else:
-            axis = ax0 if stack == 'horizontal' else ax1
-            ldata = [coll.ddata[k0]['data'] for k0 in key_data]
-            lsize = [dd.shape[axis] for dd in ldata]
-            if len(set(lsize)) != 1:
-                msg = (
-                    "Data for diag '{key}' cannot be stacked {stack}:\n"
-                    f"\t- shapes: {[dd.shape for dd in ldata]}\n"
-                    f"\t- axis: {axis}"
-                )
-                raise Exception(msg)
-
-    else:
-        ldata = [coll.ddata[k0]['data'] for k0 in key_data]
-        axis = ref.index(None)
-
-    # ------------
-    # concatenate
+    ncols = 31
+    nh = int((ncols - 1) / 2)
+    fig = plt.figure(figsize=fs)
+    gs = gridspec.GridSpec(ncols=ncols, nrows=4, **dmargin)
 
-    data = np.concatenate(tuple(ldata), axis=axis)
-    units = coll.ddata[key_data[0]]['units']
+    # --------
+    # create
 
-    # dind
-    i0 = 0
-    dind = {}
-    for ii, k0 in enumerate(key_data):
-        npix = ldata[ii].shape[axis]
-        ind = i0 + np.arange(0, npix)
-        dind[k0] = ind
-        i0 += npix
+    ax0 = fig.add_subplot(gs[:2, :nh], aspect='equal', adjustable='datalim')
+    ax0.set_xlabel('X (m)')
+    ax0.set_ylabel('Y (m)')
+
+    ax1 = fig.add_subplot(gs[2:, :nh], aspect='equal', adjustable='datalim')
+    ax1.set_xlabel('R (m)')
+    ax1.set_ylabel('Z (m)')
+
+    ax2 = fig.add_subplot(gs[:2, nh:-1], projection='3d')
+    ax2.set_xlabel('X (m)')
+    ax2.set_ylabel('Y (m)')
+    ax2.set_ylabel('Z (m)')
+
+    ax3 = fig.add_subplot(gs[2, nh:-1], aspect='equal')
+    ax3.set_ylabel('x1 (m)')
+
+    ax4 = fig.add_subplot(gs[3, nh:-1], sharex=ax3, sharey=ax3)
+    ax4.set_ylabel('x1 (m)')
+    ax4.set_xlabel('x0 (m)')
+
+    cax = fig.add_subplot(gs[3, -1])
+
+    dax = {
+        'cross': {'handle': ax0, 'type': 'cross'},
+        'hor': {'handle': ax1, 'type': 'hor'},
+        '3d': {'handle': ax2, 'type': '3d'},
+        'cam_all': {'handle': ax3, 'type': 'camera'},
+        'cam_bin': {'handle': ax4, 'type': 'camera'},
+    }
 
-    return {
-        'data': data,
-        'keys': key_data,
-        'keys_cam': key_cam,
-        'units': units,
-        'ref': ref,
-        'axis': axis,
-        'flat': flat,
-        'dind': dind,
-    }
+    return dax, cax
```

### Comparing `tofu-1.7.7/tofu/data/_class8_compute_signal.py` & `tofu-1.7.8/tofu/data/_class8_compute_signal.py`

 * *Files 2% similar despite different names*

```diff
@@ -389,15 +389,15 @@
         default=np.nan,
         allowed=[np.nan, 0.]
     )
 
     # dvos
     if method == 'vos':
         # single camera + get dvos
-        dvos, isstore = coll.check_diagnostic_dvos(
+        key_diag, dvos, isstore = coll.check_diagnostic_dvos(
             key_diag,
             key_cam=key_cam,
             dvos=dvos,
         )
 
         if spectro is True and (not isstore):
             msg = "spectro synthetic signal with 'vos' required stored vos!"
@@ -864,14 +864,28 @@
 
             # timing
             if timing is True:
                 t06 = dtm.datetime.now()
                 dt['\tintegrate on los'] += (t06-t05).total_seconds()
 
         # --------------
+        # safety check
+
+        if shape is None:
+            msg = (
+                "Looks like no single LOS can see non-zero emissivity!\n"
+                f"\t- key_los = {key_los}\n"
+                f"\t- ni = {ni}\n"
+                f"\t- R = {R}\n"
+                "\ncoll.show('rays'):\n"
+                + coll.show('rays', returnas=str, verb=False)
+            )
+            raise Exception(msg)
+
+        # --------------
         # post-treatment
 
         # brightness
         if brightness is False:
             ketend = doptics[k0]['etendue']
             etend = coll.ddata[ketend]['data']
             sh_etend = [-1 if aa == axis else 1 for aa in range(len(refi))]
```

### Comparing `tofu-1.7.7/tofu/data/_class8_compute_signal_moments.py` & `tofu-1.7.8/tofu/data/_class8_compute_signal_moments.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class8_equivalent_apertures.py` & `tofu-1.7.8/tofu/data/_class8_equivalent_apertures.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class8_etendue_los.py` & `tofu-1.7.8/tofu/data/_class8_etendue_los.py`

 * *Files 0% similar despite different names*

```diff
@@ -198,26 +198,27 @@
         # --------------------
         # compute numerically
 
         etend1 = None
         if numerical is True:
 
             if spectro is True:
-                etend1 = _compute_etendue_numerical_spectro(
-                    coll=coll,
-                    key_diag=key,
-                    key_cam=key_cam,
-                    is2d=is2d,
-                    doptics=doptics,
-                    los_x=los_x,
-                    los_y=los_y,
-                    los_z=los_z,
-                    margin_par=margin_par,
-                    margin_perp=margin_perp,
-                )
+                etend1 = None
+                # etend1 = _compute_etendue_numerical_spectro(
+                #     coll=coll,
+                #     key_diag=key,
+                #     key_cam=key_cam,
+                #     is2d=is2d,
+                #     doptics=doptics,
+                #     los_x=los_x,
+                #     los_y=los_y,
+                #     los_z=los_z,
+                #     margin_par=margin_par,
+                #     margin_perp=margin_perp,
+                # )
             else:
                 etend1 = _compute_etendue_numerical(
                     coll=coll,
                     key_diag=key,
                     key_cam=key_cam,
                     ldeti=v0['ldet'],
                     res=res,
@@ -440,15 +441,16 @@
 
     # -----------
     # numerical
 
     numerical = ds._generic_check._check_var(
         numerical, 'numerical',
         types=bool,
-        default=True,
+        default=False if spectro else True,
+        allowed=[False] if spectro else [True, False],
     )
 
     # -----------
     # res
 
     if res is not None:
         res = np.atleast_1d(res).ravel()
```

### Comparing `tofu-1.7.7/tofu/data/_class8_los_angles.py` & `tofu-1.7.8/tofu/data/_class8_los_angles.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class8_los_data.py` & `tofu-1.7.8/tofu/data/_class8_los_data.py`

 * *Files 4% similar despite different names*

```diff
@@ -273,15 +273,15 @@
     dax=None,
 ):
 
     # ------------
     # check inputs
 
     (
-        key_diag, key_cam,
+        key_diag, key_cam, key_los,
         key_integrand, key_coords,
         key_bs_integrand, key_bs_coords,
         lok_coords, segment, mode, radius_max,
         plot, dcolor,
     ) = _integrate_along_los_check(
         coll=coll,
         key_diag=key_diag,
@@ -300,19 +300,24 @@
     # --------------
     # prepare output
 
     dx = {}
     dy = {}
     dout = {}
 
+    # key_los
+    if key_los is not None:
+        doptics = {k0: {'los': k0} for k0 in key_los}
+    else:
+        doptics = coll.dobj['diagnostic'][key_diag]['doptics']
+
     # ---------------
     # loop on cameras
 
     axis_los = 0
-    doptics = coll.dobj['diagnostic'][key_diag]['doptics']
     if key_integrand in lok_coords and key_coords in lok_coords:
 
         for ii, kk in enumerate(key_cam):
 
             klos = doptics[kk]['los']
             if klos is None:
                 continue
@@ -458,14 +463,29 @@
             dy[kk] = np.full(q2d.shape, np.nan)
 
             # isok
             isok = np.isfinite(q2dx) & np.isfinite(q2dy) & np.isfinite(Ri)
             dx[kk][isok] = q2dx[isok]
             dy[kk][isok] = q2dy[isok]
 
+    # ---------------------
+    # safety check
+
+    lout = [k0 for k0, v0 in dx.items() if v0 is None]
+    if len(lout) > 0:
+        lstr = [f"\t- {k0}" for k0 in lout]
+        msg = (
+            "The following rays seem to have no existence in desired range:\n"
+            + "\n".join(lstr)
+            + "\nDetails:\n"
+            f"\t- segment: {segment}\n"
+            f"\t- radius_max: {radius_max}\n"
+        )
+        raise Exception(msg)
+
     # ------------
     # units
 
     ldist = ['x', 'y', 'z', 'R', 'l', 'ltot']
     lang = ['phi', 'ang_vs_ephi']
 
     # coords
@@ -491,14 +511,15 @@
         units_integrand = coll.ddata[key_integrand]['units']
 
     # ---------------------
     # add indices
 
     dind = _get_dind(
         coll=coll,
+        doptics=doptics,
         dx=dx,
         dy=dy,
     )
 
     # ------------
     # format
 
@@ -551,16 +572,43 @@
     plot=None,
     dcolor=None,
 ):
 
     # -----------------
     # keys of diag, cam
 
-    # key_cam
-    key_diag, key_cam = coll.get_diagnostic_cam(key=key_diag, key_cam=key_cam)
+    lrays = list(coll.dobj.get('rays', {}).keys())
+    ldiag = list(coll.dobj.get('diagnostic', {}).keys())
+    lc = [
+            isinstance(key_diag, str)
+            and key_diag in lrays
+            and key_diag not in ldiag,
+            isinstance(key_diag, list)
+            and all([
+                isinstance(kd, str)
+                and kd in lrays
+                and kd not in ldiag
+                for kd in key_diag
+            ]),
+    ]
+
+    if any(lc):
+        if lc[0]:
+            key_los = [key_diag]
+        else:
+            key_los = key_diag
+        key_cam = key_los
+    else:
+        # key_cam
+        key_diag, key_cam = coll.get_diagnostic_cam(
+            key=key_diag,
+            key_cam=key_cam,
+            default='all',
+        )
+        key_los = None
 
     # -------------------------
     # keys of coords, integrand
 
     # key_data: coordinates
     lok_coords = [
         'x', 'y', 'z', 'R', 'phi', 'ang_vs_ephi',
@@ -660,18 +708,18 @@
 
         if len(key_cam) > 1:
             dcolor = {
                 kk: lc[ii % len(lc)]
                 for ii, kk in enumerate(key_cam)
             }
         else:
-            dcolor = {key_cam[0]: None}
+            dcolor = {key_cam[0]: lc[0]}
 
     return (
-        key_diag, key_cam,
+        key_diag, key_cam, key_los,
         key_integrand, key_coords,
         key_bs_integrand, key_bs_coords,
         lok_coords, segment, mode, radius_max,
         plot, dcolor,
     )
 
 
@@ -713,38 +761,41 @@
 # ################################################################
 #                     ind
 # ################################################################
 
 
 def _get_dind(
     coll=None,
+    doptics=None,
     dx=None,
     dy=None,
 ):
 
     # ----------------
     #  loop on cameras
 
     dind = {}
-    for kcam in dx.keys():
+    for kcam in doptics.keys():
+
+        klos = doptics[kcam]['los']
 
         # ------------------
         # preliminary check
 
         inan = (
             np.isnan(dx[kcam])
             & np.isnan(dy[kcam])
         )
 
         # ------------------
         # preliminary check
 
-        shape = coll.dobj['camera'][kcam]['dgeom']['shape']
+        shape = coll.dobj['rays'][klos]['shape'][1:]
         nnan = np.prod(shape)
-        if inan.sum() != nnan:
+        if inan.sum() < nnan:
             msg = (
                 f"cam '{kcam}' has unconsistent nb of nans:\n"
                 f"\t- shape: {shape}\n"
                 f"\t- inan.sum(): {inan.sum()}\n"
                 f"\t- nnan: {nnan}\n"
             )
             warnings.warn(msg)
@@ -759,15 +810,15 @@
             ii = np.arange(i10, i1)
             ind[ii] = i0
             i10 = i1 + 1
 
         # -----------
         # safety check
 
-        lc = [np.any(inan[ind>=0]), (ind == -1).sum() != nnan]
+        lc = [np.any(inan[ind>=0]), (ind == -1).sum() < nnan]
         if  any(lc):
             msg = (
                 "Inconsistent nans!\n"
                 f"\t- lc: {lc}\n"
                 f"\t- ind: {ind}\n"
                 f"\t- inan: {inan}\n"
                 f"\t- isnan: {inan[ind>=0].sum()}\n"
@@ -805,23 +856,26 @@
     # -----------
     # make figure
 
     if dax is None:
 
         fig = plt.figure()
 
-        ax = fig.add_axes([0.1, 0.1, 0.8, 0.8])
+        ax = fig.add_axes([0.15, 0.1, 0.80, 0.8])
 
         tit = "LOS-interpolated"
         ax.set_title(tit, size=12, fontweight='bold')
         ax.set_xlabel(xlab)
         ax.set_ylabel(ylab)
 
         dax = {'main': ax}
 
+    elif isinstance(dax, plt.Axes) or issubclass(dax.__class__, plt.Axes):
+        dax = {'main': dax}
+
     # main
     kax = 'main'
     if dax.get(kax) is not None:
         ax = dax[kax]
 
         for k0 in dout['coords']['ddata'].keys():
```

### Comparing `tofu-1.7.7/tofu/data/_class8_move.py` & `tofu-1.7.8/tofu/data/_class8_move.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class8_plane_perp_to_los.py` & `tofu-1.7.8/tofu/data/_class8_plane_perp_to_los.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class8_plot.py` & `tofu-1.7.8/tofu/data/_class8_plot.py`

 * *Files 0% similar despite different names*

```diff
@@ -70,20 +70,24 @@
             v0.get(defdata) is not None
             for v0 in coll.dobj['diagnostic'][key]['doptics'].values()
         ])
     )
     if c0:
         data = defdata
 
-    ddata, dref, units, static, daxis = coll.get_diagnostic_data(
+    out = coll.get_diagnostic_data(
         key=key,
         key_cam=key_cam,
         data=data,
         units=units,
     )
+    if out is None:
+        return
+
+    ddata, dref, units, static, daxis = out
 
     refz = None
     if static is False:
         lnr = [len(v0) for v0 in dref.values()]
         refz = [v0[daxis[k0]] for k0, v0 in dref.items()]
 
         if len(set(lnr)) != 1:
```

### Comparing `tofu-1.7.7/tofu/data/_class8_plot_coverage.py` & `tofu-1.7.8/tofu/data/_class8_plot_coverage.py`

 * *Files 18% similar despite different names*

```diff
@@ -24,35 +24,43 @@
 #                           Main
 # ################################################################
 
 
 def main(
     coll=None,
     key=None,
+    # observation directions
+    observation_directions=None,
     # mesh sampling
     key_mesh=None,
     res_RZ=None,
+    nan0=None,
     # plotting options
     config=None,
     dcolor=None,
     dax=None,
     fs=None,
     dmargin=None,
     tit=None,
+    cmap=None,
+    vmin=None,
+    vmax=None,
 ):
 
     # -------------
     # check inputs
     # -------------
 
-    is_vos, keym, res_RZ, dcolor = _check(
+    key, is_vos, keym, res_RZ, nan0, dcolor = _check(
         coll=coll,
         key=key,
+        observation_directions=observation_directions,
         key_mesh=key_mesh,
         res_RZ=res_RZ,
+        nan0=nan0,
         dcolor=dcolor,
     )
 
     # -----------
     # compute
     # -----------
 
@@ -61,14 +69,20 @@
         key=key,
         is_vos=is_vos,
         keym=keym,
         res_RZ=res_RZ,
         dcolor=dcolor,
     )
 
+    # ------------
+    # nan0
+
+    if nan0 is True:
+        ndet[ndet == 0] = np.nan
+
     # -----------
     # plot
     # -----------
 
     dax = _plot(
         coll=coll,
         key=key,
@@ -79,30 +93,35 @@
         dpoly=dpoly,
         # plotting options
         config=config,
         dax=dax,
         fs=fs,
         dmargin=dmargin,
         tit=tit,
+        cmap=cmap,
+        vmin=vmin,
+        vmax=vmax,
     )
 
-    return dax
+    return dpoly, ndet, dax
 
 
 # ################################################################
 # ################################################################
 #                           Check
 # ################################################################
 
 
 def _check(
     coll=None,
     key=None,
+    observation_directions=None,
     key_mesh=None,
     res_RZ=None,
+    nan0=None,
     dcolor=None,
 ):
 
     # -----------
     # key
     # -----------
 
@@ -119,14 +138,31 @@
         types=str,
         allowed=lok + lok_vos,
     )
 
     lcam = coll.dobj['diagnostic'][key]['camera']
     is_vos = key in lok_vos
 
+    # is 3d ?
+    doptics = coll.dobj['diagnostic'][key]['doptics']
+    is_3d = doptics[lcam[0]]['dvos']['indr_3d'] is not None
+
+    # ------------------------
+    # observation_directions
+    # ------------------------
+
+    obsdef = None
+    lok = None
+    observation_directions = ds._generic_check._check_var(
+        observation_directions, 'observation_directions',
+        types=bool,
+        default=obsdef,
+        allowed=lok,
+    )
+
     # -------------
     # key mesh
     # -------------
 
     doptics = coll.dobj['diagnostic'][key]['doptics']
     if is_vos:
 
@@ -146,14 +182,24 @@
         keym = list(lmesh)[0]
         res_RZ = list(list(lres_RZ)[0])
 
     else:
         pass
 
     # -----------
+    # nan0 => set 0 to nan
+    # -----------
+
+    nan0 = ds._generic_check._check_var(
+        nan0, 'nan0',
+        types=bool,
+        default=True,
+    )
+
+    # -----------
     # dcolor
     # -----------
 
     if dcolor is None:
         prop_cycle = plt.rcParams['axes.prop_cycle']
         colors = prop_cycle.by_key()['color']
         dcolor = {k0: colors[ii%len(colors)] for ii, k0 in enumerate(lcam)}
@@ -183,15 +229,15 @@
     for k0, v0 in dcolor.items():
         if isinstance(v0, tuple) and len(v0) == 4:
             alpha = v0[-1]
         else:
             alpha = 0.5
         dcolor[k0] = mcolors.to_rgba(v0, alpha=alpha)
 
-    return is_vos, keym, res_RZ, dcolor
+    return key, is_vos, observation_directions, keym, res_RZ, nan0, dcolor
 
 
 # ################################################################
 # ################################################################
 #                           Compute
 # ################################################################
 
@@ -258,16 +304,14 @@
                 iok = coll.ddata[kindr]['data'][ii, :] >= 0
                 ind = (
                     coll.ddata[kindr]['data'][ii, iok],
                     coll.ddata[kindz]['data'][ii, iok],
                 )
                 ndet[ind] += 1
 
-        ndet[ndet == 0] = np.nan
-
     # -----------------
     # ndet for non-vos
     # -----------------
 
     else:
         raise NotImplementedError()
 
@@ -313,22 +357,48 @@
     # plotting options
     config=None,
     is_vos=None,
     dax=None,
     fs=None,
     dmargin=None,
     tit=None,
+    cmap=None,
+    vmin=None,
+    vmax=None,
 ):
 
     # ----------------
+    # check input
+    # ----------------
+
+    # tit
+    if tit is not False:
+        titdef = f"geometrical coverage of diag '{key}'"
+        tit = ds._generic_check._check_var(
+            tit, 'tit',
+            types=str,
+            default=titdef,
+        )
+
+    if cmap is None:
+        cmap = plt.cm.viridis   # Greys
+
+    if vmin is None:
+        vmin = 0
+
+    if vmax is None:
+        vmax = np.nanmax(ndet)
+
+    # ----------------
     # prepare data
     # ----------------
 
-    if tit is None:
-        tit = f"geometrical coverage of diag '{key}'"
+    # directions of observation
+
+
 
     # ----------------
     # prepare figure
     # ----------------
 
     if dax is None:
         if fs is None:
@@ -353,43 +423,64 @@
         # ax1 = nb of detectors
         ax1 = fig.add_subplot(gs[0, 9:], sharex=ax0, sharey=ax0)
         ax1.set_ylabel('Z (m)', size=12, fontweight='bold')
         ax1.set_xlabel('R (m)', size=12, fontweight='bold')
         ax1.set_title("nb. of detectors", size=14, fontweight='bold')
 
         cax = fig.add_subplot(gs[0, 15])
-        dax = {'span': ax0, 'ndet': ax1}
+        dax = {
+            'span': {'handle': ax0, 'type': 'span'},
+            'ndet': {'handle': ax1, 'type': 'ndet'},
+            'cax': {'handle': cax, 'type': 'span_colorbar'},
+        }
+
+    else:
+        fig = list(dax.values())[0].figure
+
+    # --------------------
+    # check / format dax
+
+    dax = ds._generic_check._check_dax(dax)
 
     # ---------------
     # plot ndet
     # ---------------
 
-    kax = 'ndet'
-    if dax.get(kax) is not None:
-        ax = dax[kax]
+    ktype = 'ndet'
+    lax = [v0['handle'] for v0 in dax.values() if v0['type'] == ktype]
+    for ax in lax:
 
+        # plot
         im = ax.imshow(
             ndet.T,
             extent=extent,
             origin='lower',
             interpolation='bilinear',
-            cmap=plt.cm.viridis, # Greys
-            vmin=0,
-            vmax=np.nanmax(ndet),
+            cmap=cmap,
+            vmin=vmin,
+            vmax=vmax,
         )
 
-        plt.colorbar(im, cax=cax)
+        # colorbar
+        ktype2 = 'span_colorbar'
+        lcax = [v0['handle'] for v0 in dax.values() if v0['type'] == ktype2]
+        if len(lcax) == 0:
+            plt.colorbar(im)
+        else:
+            for cax in lcax:
+                plt.colorbar(im, cax=dax['cax'])
+
 
     # ---------------
     # plot spans
     # ---------------
 
-    kax = 'span'
-    if dax.get(kax) is not None:
-        ax = dax[kax]
+    ktype = 'span'
+    lax = [v0['handle'] for v0 in dax.values() if v0['type'] == ktype]
+    for ax in lax:
 
         for k0, v0 in dpoly.items():
             ax.fill(
                 v0['pr'],
                 v0['pz'],
                 fc=v0['color'],
                 label=k0,
@@ -398,14 +489,20 @@
         ax.legend(bbox_to_anchor=(1.05, 1), loc='upper left', fontsize=12)
 
     # --------------
     # add config
     # --------------
 
     if config is not None:
-        for kax in ['span', 'ndet']:
-            if dax.get(kax) is not None:
-                config.plot(lax=dax[kax], proj='cross', dLeg=False)
+        for ktype in ['span', 'ndet']:
+            lax = [v0['handle'] for v0 in dax.values() if v0['type'] == ktype]
+            for ax in lax:
+                config.plot(lax=ax, proj='cross', dLeg=False)
+
+    # --------------
+    # add tit
+    # --------------
 
-    fig.suptitle(tit, size=14, fontweight='bold')
+    if tit is not False:
+        fig.suptitle(tit, size=14, fontweight='bold')
 
     return dax
```

### Comparing `tofu-1.7.7/tofu/data/_class8_plot_vos.py` & `tofu-1.7.8/tofu/data/_class8_plot_vos.py`

 * *Files 1% similar despite different names*

```diff
@@ -101,15 +101,15 @@
         los_res=los_res,
         # interactivity
         color_dict=color_dict,
     )
 
     # single camera + get dvos
     key_cam = key_cam[:1]
-    dvos, isstore = coll.check_diagnostic_dvos(
+    key, dvos, isstore = coll.check_diagnostic_dvos(
         key,
         key_cam=key_cam,
         dvos=dvos,
     )
     doptics = coll.dobj['diagnostic'][key]['doptics'][key_cam[0]]
     shape_cam = coll.dobj['camera'][key_cam[0]]['dgeom']['shape']
```

### Comparing `tofu-1.7.7/tofu/data/_class8_plot_vos_spectro.py` & `tofu-1.7.8/tofu/data/_class8_plot_vos_spectro.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class8_reverse_ray_tracing.py` & `tofu-1.7.8/tofu/geom/_comp_solidangles.py`

 * *Files 20% similar despite different names*

```diff
@@ -1,1834 +1,1570 @@
+# Built-in
+# import warnings
 
-
+# Common
 import numpy as np
-import scipy.interpolate as scpinterp
-import scipy.stats as scpstats
-import Polygon as plg
-from matplotlib.path import Path
+# import scipy.interpolate as scpinterp
+# import scipy.integrate as scpintg
+# from inspect import signature as insp
 import matplotlib.pyplot as plt
-import matplotlib.gridspec as gridspec
-from mpl_toolkits.mplot3d import Axes3D
 import datastock as ds
 
 
-from . import _class8_equivalent_apertures as _equivalent_apertures
-from . import _class8_plot
-from . import _generic_check
-from . import _class8_vos_utilities as _utilities
-
-
-# ################################################
-# ################################################
-#               main
-# ################################################
-
-
-def _from_pts(
-    coll=None,
-    # diag
-    key=None,
-    key_cam=None,
-    # mesh sampling
-    key_mesh=None,
-    res_RZ=None,
-    res_phi=None,
-    # pts coordinates
-    ptsx=None,
-    ptsy=None,
-    ptsz=None,
-    # res
-    n0=None,
-    n1=None,
-    min_threshold=None,
-    # optional lamb
-    lamb0=None,
-    res_lamb=None,
-    rocking_curve=None,
-    res_rock_curve=None,
-    # options
-    append=None,
-    plot=None,
-    plot_pixels=None,
-    plot_config=None,
-    plot_rays=None,
-    vmin=None,
-    vmax=None,
-    aspect3d=None,
-    elements=None,
-    colorbar=None,
-    # options
-    dax=None,
-    fs=None,
-    dmargin=None,
-    wintit=None,
+import datetime as dtm
+
+
+# local
+from . import _GG
+
+
+_APPROX = True
+_ANISO = False
+_BLOCK = True
+_LTYPES = [int, float, np.int_, np.float_]
+
+
+__all__ = [
+    'calc_solidangle_particle',
+    'calc_solidangle_apertures',
+]
+
+
+###############################################################################
+###############################################################################
+#                       Check inputs - Particle
+###############################################################################
+
+
+def _check_calc_solidangle_particle(
+    traj=None,
+    pts=None,
+    rad=None,
+    config=None,
+    approx=None,
+    aniso=None,
+    block=None,
 ):
 
-    # -------------
-    # check inputs
+    # Check booleans
+    if approx is None:
+        approx = _APPROX
+    if aniso is None:
+        aniso = _ANISO
+
+    lbool = [('approx', approx), ('aniso', aniso)]
+    for kk, vv in lbool:
+        if not isinstance(vv, bool):
+            msg = ("Arg {} must be a bool\n".format(kk)
+                   + "\t- provided: {}".format(vv))
+            raise Exception(msg)
 
-    (
-        key, key_cam, key_mesh,
-        dsamp, res_phi,
-        shape, iok,
-        ptsx, ptsy, ptsz, phi,
-        lamb0, rocking_curve,
-        append, plot, plot_pixels, colorbar,
-    ) = _check(
-        coll=coll,
-        # diag
-        key=key,
-        key_cam=key_cam,
-        # mesh sampling
-        key_mesh=key_mesh,
-        res_RZ=res_RZ,
-        res_phi=res_phi,
-        # pts coordinates
-        ptsx=ptsx,
-        ptsy=ptsy,
-        ptsz=ptsz,
-        # optional lamb
-        lamb0=lamb0,
-        rocking_curve=rocking_curve,
-        # options
-        append=append,
-        plot=plot,
-        plot_pixels=plot_pixels,
-        colorbar=colorbar,
-    )
+    # Check config
+    c0 = [config is None, config.__class__.__name__ == "Config"]
+    if not any(c0):
+        msg = ("Arg config must be either Noen or a tf.geom.Config instance!\n"
+               + "\t- provided: {}".format(config))
+        raise Exception(msg)
 
-    # ----------------------
-    # prepare optics, camera
+    # Double-check block vs config
+    if block is None:
+        if config is None:
+            block = False
+        else:
+            block = _BLOCK
+    if not isinstance(block, bool):
+        msg = ("Arg {} must be a bool\n".format('block')
+               + "\t- provided: {}".format(block))
+        raise Exception(msg)
+    if config is None and block is True:
+        msg = ("Arg block cannot be True of config is not provided!")
+        raise Exception(msg)
 
-    (
-        kspectro,
-        lpoly_post,
-        p0x, p0y, p0z,
-        nin, e0, e1,
-        ptsvect_plane,
-        ptsvect_spectro,
-        ptsvect_cam,
-        coords_x01toxyz_plane,
-        cent,
-        cent_cam,
-        dist_to_cam,
-        pix_size,
-        cbin0, cbin1,
-    ) = _prepare_optics(
-        coll=coll,
-        key=key,
-        key_cam=key_cam,
-    )
-    shape_cam = coll.dobj['camera'][key_cam]['dgeom']['shape']
+    # arrays
+    try:
+        traj = np.ascontiguousarray(traj, dtype=float)
+        rad = np.r_[rad].astype(float).ravel()
+
+        # Check pts, traj and r are array of good shape
+        c0 = traj.ndim in [1, 2] and 3 in traj.shape
+        if pts is not False:
+            pts = np.ascontiguousarray(pts, dtype=float)
+            c0 = c0 and pts.ndim in [1, 2] and 3 in pts.shape
+        assert c0
+        if traj.ndim == 1:
+            traj = traj.reshape((3, 1))
+        if traj.shape[0] != 3:
+            traj = traj.T
+        traj = np.ascontiguousarray(traj)
+        if pts is not False:
+            if pts.ndim == 1:
+                pts = pts.reshape((3, 1))
+            if pts.shape[0] != 3:
+                pts = pts.T
+            pts = np.ascontiguousarray(pts)
+    except Exception:
+        msg = (
+            "Args traj and pts must be convertible to np.ndarrays of shape"
+            + "\n\t- traj: (N,), (3, N) or (N, 3)"
+            + "\n\t- pts: (M,), (3, M) or (M, 3)"
+            + "\n\n   You provided:\n"
+            + "\n\t- traj: {}".format(traj)
+            + "\n\t- pts: {}".format(pts)
+            + "\n\t- rad: {}".format(rad)
+        )
+        raise Exception(msg)
 
-    # -------------------------------------
-    # prepare lambda, angles, rocking_curve
+    # check rad vs traj
+    ntraj = traj.shape[1]
+    nrad = rad.size
+
+    nmax = max(nrad, ntraj)
+    if not (nrad in [1, nmax] and ntraj in [1, nmax]):
+        msg = ("rad must be an array with shape (1,) or (N,)\n"
+               + "  provided: {}".format(rad))
+        raise Exception(msg)
+    if nrad < nmax:
+        rad = np.full((nmax,), rad[0])
+    if ntraj < nmax:
+        traj = np.repeat(traj, nmax, axis=1)
+    return traj, pts, rad, config, approx, aniso, block
+
+
+###############################################################################
+###############################################################################
+#                       Solid Angle particle
+###############################################################################
+
+
+def calc_solidangle_particle(
+    pts=None,
+    part_traj=None,
+    part_radius=None,
+    config=None,
+    approx=None,
+    aniso=None,
+    block=None,
+):
+    """ Compute the solid angle subtended by a particle along a trajectory
 
-    (
-        nlamb,
-        lamb,
-        dlamb,
-        pow_ratio,
-        ang_rel,
-        dang,
-        angbragg,
-    ) = _prepare_lamb(
-        coll=coll,
-        key_diag=key,
-        key_cam=key_cam,
-        kspectro=kspectro,
-        lamb=lamb0,
-        res_lamb=res_lamb,
-        rocking_curve=rocking_curve,
-        res_rock_curve=res_rock_curve,
-        verb=False,
-    )
-
-    # -------------------
-    # wavelength specific
-
-    if lamb is not None:
-        angbragg0 = angbragg[:1, :]
-        angbragg1 = angbragg[-1:, :]
-
-        # -------
-        # prepare lamb per pixel
-
-        lamb_per_pix = coll.get_diagnostic_data(
-            key,
-            key_cam=key_cam,
-            data='lamb',
-        )[0][key_cam]
-
-        bragg_per_pix = coll.get_crystal_bragglamb(
-            key=kspectro,
-            lamb=lamb_per_pix,
-        )[0]
+    The particle has radius r, and trajectory (array of points) traj
+    It is observed from pts (array of points)
 
-    # --------------
-    # prepare output
+    traj and pts are (3, N) and (3, M) arrays of cartesian coordinates
 
-    if key_mesh is None:
-        func = _loop0
+    approx = True => use approximation
+    aniso = True => return also unit vector of emission
+    block = True consider LOS collisions (with Ves, Struct...)
+
+    if block:
+        config used for LOS collisions
+
+    Parameters
+    ----------
+    pts:            np.ndarray
+        Array of (3, M) pts coordinates (X, Y, Z) representing the points from
+        which the particle is observed
+    part_traj:      np.ndarray
+        Array of (3, N) pts coordinates (X, Y, Z) representing the particle
+        positions
+    part_radius:    float / np.ndarray
+        Unique of multiple values for the radius of the spherical particle
+            if multiple, rad is a np.ndarray of shape (N,)
+    config:         None / tf.geom.Config
+        if block = True, solid angles are non-zero only if the field of view is
+        not blocked bya structural element in teh chamber
+    approx:         None / bool
+        Flag indicating whether to compute the solid angle using an 1st-order
+        series development (in whichcase the solid angle becomes proportional
+        to the radius of the particle, see Notes_Upgrades/)
+    aniso:          None / bool
+        Flag indicating whether to consider anisotropic emissivity, meaning the
+        routine must also compute and return the unit vector directing the flux
+        from each pts to each position on the trajectory of the particle
+    block:          None / bool
+        Flag indicating whether to check for vignetting by structural elements
+        provided by config
+
+    Return:
+    -------
+    sang:           np.ndarray
+        (N, M) Array of floats, solid angles
+
+    """
+    ################
+    # Prepare inputs
+    (
+        part_traj, pts, part_radius, config,
+        approx, aniso, block
+    ) = _check_calc_solidangle_particle(
+        traj=part_traj,
+        pts=pts,
+        rad=part_radius,
+        config=config,
+        approx=approx,
+        aniso=aniso,
+        block=block,
+    )
+
+    ################
+    # Main computation
+
+    # traj2pts vector, with length (3d array (3, N, M))
+    vect = - pts[:, :, None] + part_traj[:, None, :]
+    len_v = np.ascontiguousarray(np.sqrt(np.sum(vect**2, axis=0)))
+
+    # If aniso or block, normalize
+    if aniso or block:
+        vect = vect / len_v[None, :, :]
+
+    # Solid angle
+    r_d = part_radius[None, :] / len_v
+    where_zero = len_v <= part_radius[None, :]
+    r_d[where_zero] = 0.  # temporary value
+    if approx:
+        sang = np.pi * (r_d**2 + r_d**4 / 4. + r_d**6 / 8. + r_d**8 * 5 / 64)
     else:
-        func = _loop1
+        sang = 2.*np.pi * (1 - np.sqrt(1. - r_d ** 2))
 
-    # -------------
-    # compute
+    # when particle in mesh point, distance len_v = 0 thus sang neglected
+    sang[where_zero] = 0.
 
-    dout = func(**locals())
-    dout['rocking_curve'] = rocking_curve
+    # block
+    if block:
+        kwdargs = config.get_kwdargs_LOS_isVis()
+        indvis = _GG.LOS_areVis_PtsFromPts_VesStruct(
+            pts, part_traj, dist=len_v, **kwdargs
+        )
+        iout = indvis == 0
+        sang[iout] = 0.
+        vect[:, iout] = np.nan
+
+    ################
+    # Return
+    if aniso:
+        return sang, vect
+
+    return sang
+
+
+def calc_solidangle_particle_integ(
+    part_traj=None,
+    part_radius=None,
+    config=None,
+    approx=True,
+    block=True,
+    resolution=None,
+    DR=None,
+    DZ=None,
+    DPhi=None,
+):
 
-    # -------
-    # reshape
+    # step0: if block : generate kwdargs from config
 
-    if len(shape) > 1:
-        shape_new = tuple(np.r_[shape_cam, shape])
-        for k0 in ['sang']:
-            dout[k0] = dout[k0].reshape(shape_new)
-        for k0 in ['sang0']:
-            dout[k0] = dout[k0].reshape(shape_new)
+    # step 1: sample cross-section
 
-    # -------
-    # plot
+    # step 2: loop on R of  pts of cross-section (parallelize ?)
+    # => fix nb. of phi for the rest of the loop
 
-    if plot is True:
-        _plot(
-            coll=coll,
-            key=key,
-            key_cam=key_cam,
-            dout=dout,
-            cbin0=cbin0,
-            cbin1=cbin1,
-            # options
-            plot_config=plot_config,
-            plot_pixels=plot_pixels,
-            vmin=vmin,
-            vmax=vmax,
-            aspect3d=aspect3d,
-            elements=elements,
-            colorbar=colorbar,
-            # options
-            dax=dax,
-            fs=fs,
-            dmargin=dmargin,
-            wintit=wintit,
-        )
-
-    return dout
-
-
-# ################################################
-# ################################################
-#               check
-# ################################################
-
-
-def _check(
-    coll=None,
-    # diag
-    key=None,
-    key_cam=None,
-    # mesh sampling
-    key_mesh=None,
-    res_RZ=None,
-    res_phi=None,
-    # pts coordinates
-    ptsx=None,
-    ptsy=None,
-    ptsz=None,
-    # optional lamb
-    lamb0=None,
-    rocking_curve=None,
-    # bool
-    append=None,
-    plot=None,
-    plot_pixels=None,
-    colorbar=None,
-):
+    # loop of Z
+
+    # step 3: loop phi
+    # Check visibility (if block = True) for each phi (LOS collision)
+    # If visible => compute solid angle
+    # integrate (sum * res) on each phi the solid angle
+
+    # Return sang as (N,nR,nZ) array
+
+    # ----------------
+    # check resolution
+
+    if resolution is None:
+        resolution = 0.1
+    if type(resolution) in _LTYPES:
+        resolution = [resolution, resolution, resolution]
+    c0 = (
+        isinstance(resolution, list)
+        and all([type(ss) in _LTYPES for ss in resolution])
+    )
+    if not c0:
+        msg = (
+            "Arg resolution must be a list of 3 floats [r, z, rphi]\n"
+            "Each representing the spatial sampling step in a direction\n"
+            "If a single float is provided, the same is used for all"
+        )
+        raise Exception(msg)
+    resolution = [float(rr) for rr in resolution]
+
+    # ------------------
+    # Check DR, DZ, DPhi
+    dD = {'DR': DR, 'DZ': DZ, 'DPhi': DPhi}
+    dfail = {}
+    for k0, v0 in dD.items():
+        c0 = (
+            v0 is None
+            or (
+                isinstance(v0, list)
+                and len(v0) == 2
+                and all([v1 is None or type(v1) in _LTYPES for v1 in v0])
+            )
+        )
+        if not c0:
+            dfail[k0] = str(v0)
+    if len(dfail) > 0:
+        lstr = [f'\t- {k0}: {v0}' for k0, v0 in dfail.items()]
+        msg = (
+            "The following arguments are invalid:\n"
+            "Expected None or a list of len(2) of None or floats!\n"
+            + "\n".join(lstr)
+        )
+        raise Exception(msg)
+
+    # ------------------
+    # check other inputs
+
+    (
+        part_traj, _, part_radius, config,
+        approx, _, block
+    ) = _check_calc_solidangle_particle(
+        traj=part_traj,
+        pts=False,
+        rad=part_radius,
+        config=config,
+        approx=approx,
+        aniso=False,
+        block=block,
+    )
+
+    # ------------------
+    # Define the volume to be sampled: smallest vessel
 
-    # --------
-    # key
+    # Get kwdargs for LOS blocking
+    kwdargs = config.get_kwdargs_LOS_isVis()
 
-    # key
-    lok = [
-        k0 for k0, v0 in coll._dobj.get('diagnostic', {}).items()
-        if v0['spectro'] is True
+    # derive limits for sampling
+    limits_r = np.r_[
+        np.min(kwdargs['ves_poly'][0, :]),
+        np.max(kwdargs['ves_poly'][0, :]),
     ]
-    key = ds._generic_check._check_var(
-        key, 'key',
-        types=str,
-        allowed=lok,
-    )
-
-    # key_cam
-    lok = list(coll.dobj['diagnostic'][key]['doptics'].keys())
-    key_cam = ds._generic_check._check_var(
-        key_cam, 'key_cam',
-        types=str,
-        allowed=lok,
-    )
-
-    # ----------------------------
-    # coordinates vs mesh sampling
-
-    lc = [
-        key_mesh is not None,
-        ptsx is not None
+    limits_z = np.r_[
+        np.min(kwdargs['ves_poly'][1, :]),
+        np.max(kwdargs['ves_poly'][1, :]),
     ]
-    if np.sum(lc) != 1:
-        msg = "Please provide key_mesh xor (ptsx, ptsy, ptsz)\n"
+
+    return _GG.compute_solid_angle_map(
+        part_traj, part_radius,
+        resolution[0], resolution[1], resolution[2],
+        limits_r, limits_z,
+        DR=DR, DZ=DZ,
+        DPhi=DPhi,
+        block=block,
+        approx=approx,
+        limit_vpoly=kwdargs['ves_poly'],
+        **kwdargs,
+    )
+
+
+###############################################################################
+###############################################################################
+#           Triangulation
+###############################################################################
+
+
+def triangulate_polygon_2d(
+    poly_x=None,
+    poly_y=None,
+):
+
+    # ----------
+    # check
+
+    if not (isinstance(poly_x, np.ndarray) and isinstance(poly_x, np.ndarray)):
+        msg = "both poly_x and poly_y must be nd.ndarray"
         raise Exception(msg)
 
-    if lc[0]:
+    if not (poly_x.shape == poly_y.shape and poly_x.ndim == 1):
+        msg = "poly_x and poly_y must be 1d arrays of the same shape"
+        raise Exception(msg)
 
-        lok = list(coll.dobj.get('mesh', {}).keys())
-        key_mesh = ds._generic_check._check_var(
-            key_mesh, 'key_mesh',
-            types=str,
-            allowed=lok,
-        )
-
-        dsamp = coll.get_sample_mesh(
-            key=key_mesh,
-            res=res_RZ,
-            mode='abs',
-            grid=True,
-            in_mesh=True,
-            # non-used
-            x0=None,
-            x1=None,
-            Dx0=None,
-            Dx1=None,
-            imshow=False,
-            store=False,
-            kx0=None,
-            kx1=None,
-        )
-
-        # res_RZ
-        if res_RZ is None:
-            res_RZ = 0.01
-
-        # res_phi
-        if res_phi is None:
-            res_phi = 0.01
+    poly_x = poly_x.astype(float)
+    poly_y = poly_y.astype(float)
 
-        iok, shape, phi = None, None, None
+    # ----------
+    # un-close
 
-    else:
+    if poly_x[-1] == poly_x[0] and poly_y[-1] == poly_y[0]:
+        poly_x = poly_x[:-1]
+        poly_y = poly_y[:-1]
 
-        ptsx = np.atleast_1d(ptsx)
-        ptsy = np.atleast_1d(ptsy)
-        ptsz = np.atleast_1d(ptsz)
-
-        # check shapes
-        dshape = {
-            'ptsx': ptsx.shape,
-            'ptsy': ptsy.shape,
-            'ptsz': ptsz.shape,
-        }
-        maxsize = np.max([np.prod(v0) for v0 in dshape.values()])
-        shape = [v0 for v0 in dshape.values() if np.prod(v0) == maxsize][0]
+    # ------------------
+    # couter-clockwise
 
-        lout = [
-            k0 for k0, v0 in dshape.items()
-            if v0 not in [(1,), shape]
-        ]
-        if len(lout) > 0:
-            lstr = [f"\t-{k0}.shape: {v0}" for k0, v0 in dshape.items()]
-            msg = (
-                "All coordinates arrays must be of same shape:\n"
-                + "\n".join(lstr)
-            )
-            raise Exception(msg)
+    clock = np.sum((poly_x[1:] - poly_x[:-1]) * (poly_y[:1] + poly_y[:-1]))
+    if clock > 0:
+        poly_x = poly_x[::-1]
+        poly_y = poly_y[::-1]
 
-        # uniformize shapes
-        if shape != (1,):
-            if ptsx.shape == (1,):
-                ptsx = np.full(shape, ptsx[0])
-            if ptsy.shape == (1,):
-                ptsy = np.full(shape, ptsy[0])
-            if ptsz.shape == (1,):
-                ptsz = np.full(shape, ptsz[0])
+    # ----------------
+    # triangulate
 
-        dsamp = None
+    tri = _GG.triangulate_by_earclipping_2d(np.array([poly_x, poly_y]))
 
     # -------
-    # lamb
+    # format
 
-    if lamb0 is not None:
-        lamb0 = np.atleast_1d(lamb0)
+    if clock > 0:
+        tri = poly_x.size - 1 - tri
 
-        if lc[0]:
-            if lamb0.shape != (1,):
-                msg = "With mesh sampling, lamb0 must be a scalar!"
-                raise Exception(msg)
+    return tri
 
-        else:
-            if lamb0.shape == (1,):
-                lamb0 = np.full(ptsx.shape, lamb0[0])
 
-            elif lamb0.shape != ptsx.shape:
-                msg = (
-                    "Arg lamb0 must be the same shape as coordinates\n"
-                    f"\t- ptsx.shape = {ptsx.shape}\n"
-                    f"\t- lamb0.shape = {lamb0.shape}\n"
-                )
-                raise Exception(msg)
+###############################################################################
+###############################################################################
+#           Check inputs - arbitrary points, multiple apertures
+###############################################################################
 
-    # --------------
-    # rocking_curve
 
-    rocking_curve = ds._generic_check._check_var(
-        rocking_curve, 'rocking_curve',
-        default=True,
-        types=bool,
-    )
+def _check_pts(pts=None, pts_name=None):
 
-    if lamb0 is None:
-        rocking_curve = False
+    if not isinstance(pts, np.ndarray):
+        try:
+            pts = np.atleast_1d(pts)
+        except Exception as err:
+            msg = (
+                f"Arg {pts_name} must be convertible to a np.ndarray float\n"
+                "Provided: {pts}"
+            )
+            raise Exception(msg)
+    return pts.astype(float)
 
-    # -----------------------
-    # store shape and flatten
 
-    if lc[0]:
-        pass
+def _check_polygon_2d_area_ccw(
+    poly_x0=None,
+    poly_x1=None,
+):
+    """ Assumes non-closed polygon """
 
-    else:
-        if len(shape) > 1:
-            ptsx = ptsx.ravel()
-            ptsy = ptsy.ravel()
-            ptsz = ptsz.ravel()
-            if lamb0 is not None:
-                lamb0 = lamb0.ravel()
+    assert not (poly_x0[0] == poly_x0[-1] and poly_x1[0] == poly_x1[-1])
+    i0 = np.arange(0, poly_x0.size)
+    i1 = np.r_[np.arange(1, poly_x0.size), 0]
+    return 0.5*np.sum(
+        (poly_x0[i1] + poly_x0[i0]) * (poly_x1[i1] - poly_x1[i0])
+    )
 
-        iok = np.isfinite(ptsx) & np.isfinite(ptsy) & np.isfinite(ptsz)
-        phi = np.arctan2(ptsy, ptsx)
 
-    # ---------
-    # options
+def _check_polygon_3d_counter_clockwise(
+    poly_x=None,
+    poly_y=None,
+    poly_z=None,
+    normal=None,
+):
+    """ Assumes non-closed polygon """
 
-    # plot
-    plot = ds._generic_check._check_var(
-        plot, 'plot',
+    cent = np.r_[np.mean(poly_x), np.mean(poly_y), np.mean(poly_z)]
+    normal = normal / np.linalg.norm(normal)
+    if np.abs(normal[2]) < 0.99:
+        e0 = np.r_[-normal[1], normal[0], 0.]
+    else:
+        e0 = np.r_[-normal[2], 0., normal[0]]
+    e0 = e0 / np.linalg.norm(e0)
+    e1 = np.cross(normal, e0)
+
+    # project in 2d
+    px0 = (
+        (poly_x - cent[0]) * e0[0]
+        + (poly_y - cent[1]) * e0[1]
+        + (poly_z - cent[2]) * e0[2]
+    )
+
+    px1 = (
+        (poly_x - cent[0]) * e1[0]
+        + (poly_y - cent[1]) * e1[1]
+        + (poly_z - cent[2]) * e1[2]
+    )
+
+    # counter-clockwise?
+    return _check_polygon_2d_area_ccw(
+        poly_x0=px0,
+        poly_x1=px1,
+    ) > 0
+
+
+def _check_polygon_2d(
+    poly_x=None,
+    poly_y=None,
+    poly_name=None,
+    can_be_None=None,
+    closed=None,
+    counter_clockwise=None,
+    return_area=None,
+):
+
+    # -------------
+    # check inputs
+
+    # closed
+    closed = ds._generic_check._check_var(
+        closed, 'closed',
         types=bool,
         default=True,
     )
 
-    # plot_pixel
-    plot_pixels = ds._generic_check._check_var(
-        plot_pixels, 'plot_pixels',
+    # counter_clockwise
+    counter_clockwise = ds._generic_check._check_var(
+        counter_clockwise, 'counter_clockwise',
         types=bool,
-        default=False,
+        default=True,
     )
 
-    # append
-    append = ds._generic_check._check_var(
-        append, 'append',
+    # can_be_None
+    can_be_None = ds._generic_check._check_var(
+        can_be_None, 'can_be_None',
         types=bool,
-        default=lc[1] and ptsx.size < 100,  #  and plot is True,
+        default=False,
     )
 
-    # colorbar
-    colorbar = ds._generic_check._check_var(
-        colorbar, 'colorbar',
+    # return_area
+    return_area = ds._generic_check._check_var(
+        return_area, 'return_area',
         types=bool,
         default=False,
     )
 
-    return  (
-        key, key_cam, key_mesh,
-        dsamp, res_phi,
-        shape, iok,
-        ptsx, ptsy, ptsz, phi,
-        lamb0, rocking_curve,
-        append, plot, plot_pixels, colorbar,
-    )
+    # -------------
+    # Trivial case
 
+    if can_be_None and poly_x is None:
+        return None, None
 
-# ################################################
-# ################################################
-#               prepare optics
-# ################################################
-
-
-def _prepare_optics(
-    coll=None,
-    key=None,
-    key_cam=None,
-):
+    # ------------------------
+    # check each is a 1d array
 
-    doptics = coll.dobj['diagnostic'][key]['doptics']
-    lop = doptics[key_cam]['optics']
-    lop, lcls = coll.get_optics_cls(lop)
-
-    cls_spectro = 'crystal'
-    kspectro = lop[lcls.index(cls_spectro)]
-    ispectro = lop.index(kspectro)
-    if len(lop[:ispectro]) > 1:
-        msg = "Not yet implemented optics between crystal and camera!"
-        raise NotImplementedError(msg)
-
-    # lpoly_post = []
-    lpoly_post = [
-        coll.get_optics_poly(
-            key=k0,
-            add_points=None,
-            return_outline=False,
+    if isinstance(poly_x, (list, tuple)):
+        poly_x = np.atleast_1d(poly_x)
+        poly_y = np.atleast_1d(poly_y)
+
+    c0 = (
+        all([
+            isinstance(pp, np.ndarray) for pp in [poly_x, poly_y]
+        ])
+        and poly_x.ndim == poly_y.ndim == 1
+        and poly_x.shape == poly_y.shape
+    )
+    if not c0:
+        msg = (
+            f"Arg {poly_name} must be 2 (npts,) arrays, where\n"
+            "\t- poly_x, poly_y are (X, Y) coordinates\n"
+            "\t- npts is the number of vertices\n"
+            f"Provided:\n{poly_x, poly_y}"
         )
-        for k0 in lop[ispectro+1:]
-    ]
+        raise Exception(msg)
 
-    # get initial polygon
-    p0x, p0y, p0z = coll.get_optics_poly(key=kspectro, add_points=None)
+    # ------------------------
+    # make sure not closed for ccw test
 
-    # unit vectors
-    nin = coll.dobj[cls_spectro][kspectro]['dgeom']['nin']
-    e0 = coll.dobj[cls_spectro][kspectro]['dgeom']['e0']
-    e1 = coll.dobj[cls_spectro][kspectro]['dgeom']['e1']
-
-    # get functions
-    ptsvect_plane = coll.get_optics_reflect_ptsvect(key=kspectro, asplane=True)
-    ptsvect_spectro = coll.get_optics_reflect_ptsvect(key=kspectro, isnorm=True)
-    ptsvect_cam = coll.get_optics_reflect_ptsvect(key=key_cam, fast=True)
-
-    coords_x01toxyz_plane = coll.get_optics_x01toxyz(
-        key=kspectro,
-        asplane=True,
-    )
-
-    # Get centers of crystal and camera to estimate distance
-    cent_spectro = coll.dobj[cls_spectro][kspectro]['dgeom']['cent']
-    cent_cam = coll.dobj['camera'][key_cam]['dgeom']['cent']
-    dist_to_cam = np.linalg.norm(cent_spectro - cent_cam)
-    pix_size = np.sqrt(coll.dobj['camera'][key_cam]['dgeom']['pix_area'])
-
-    # prepare camera bin edges
-    kcc = coll.dobj['camera'][key_cam]['dgeom']['cents']
-    cc0 = coll.ddata[kcc[0]]['data']
-    cc1 = coll.ddata[kcc[1]]['data']
-    cout0, cout1 = coll.get_optics_outline(key_cam, total=False)
-    cbin0 = np.r_[cc0 + np.min(cout0), cc0[-1] + np.max(cout0)]
-    cbin1 = np.r_[cc1 + np.min(cout1), cc1[-1] + np.max(cout1)]
+    pt0 = np.r_[poly_x[0], poly_y[0]]
+    pt1 = np.r_[poly_x[-1], poly_y[-1]]
+    if np.allclose(pt0, pt1):
+        poly_x = poly_x[:-1]
+        poly_y = poly_y[:-1]
 
-    return (
-        kspectro,
-        lpoly_post,
-        p0x, p0y, p0z,
-        nin, e0, e1,
-        ptsvect_plane,
-        ptsvect_spectro,
-        ptsvect_cam,
-        coords_x01toxyz_plane,
-        cent_spectro,
-        cent_cam,
-        dist_to_cam,
-        pix_size,
-        cbin0, cbin1,
-    )
+    # ------------------------
+    # make sure float
 
+    poly_x = poly_x.astype(float)
+    poly_y = poly_y.astype(float)
 
-# ################################################
-# ################################################
-#           Prepare lambda
-# ################################################
-
-
-def _prepare_lamb(
-    coll=None,
-    key_diag=None,
-    key_cam=None,
-    kspectro=None,
-    lamb=None,
-    res_lamb=None,
-    rocking_curve=None,
-    res_rock_curve=None,
-    verb=None,
-):
+    # ------------------------
+    # check counter-clockwise ass seen from normal vector
 
-    # ------------------
-    # get lamb
+    area_ccw = _check_polygon_2d_area_ccw(
+        poly_x0=poly_x,
+        poly_x1=poly_y,
+    )
+    if counter_clockwise != (area_ccw > 0):
+        poly_x = np.ascontiguousarray(poly_x[::-1])
+        poly_y = np.ascontiguousarray(poly_y[::-1])
 
-    if res_lamb is not None:
-        lamb = coll.get_diagnostic_data(
-            key=key_diag,
-            key_cam=key_cam,
-            data='lamb',
-        )[0][key_cam]
-
-        lambmin = np.nanmin(lamb)
-        lambmax = np.nanmax(lamb)
-        Dlamb = (lambmax - lambmin) * 1.1
-        nlamb = int(np.ceil(Dlamb / res_lamb)) + 2
-        lamb = np.linspace(lambmin - 0.2*Dlamb, lambmax + 0.2*Dlamb, nlamb)
-        dlamb = lamb[1] - lamb[0]
-
-        bragg = coll.get_crystal_bragglamb(key=kspectro, lamb=lamb)[0]
-
-    elif lamb is not None:
-
-        lamb = ds._generic_check._check_flat1darray(
-            lamb, 'lamb',
-            dtype=float,
-            sign='>0',
-            unique=True,
-        )
-        nlamb = lamb.size
-        dlamb = None
-        bragg = coll.get_crystal_bragglamb(key=kspectro, lamb=lamb)[0]
+    # ------------------------
+    # check if closed vs close
 
-    # ---------------
-    # get bragg angle
+    if closed:
+        poly_x = np.r_[poly_x, poly_x[0]]
+        poly_y = np.r_[poly_y, poly_y[0]]
 
-    # power ratio
-    cls_spectro = 'crystal'
-    kpow = coll.dobj[cls_spectro][kspectro]['dmat']['drock']['power_ratio']
-    pow_ratio = coll.ddata[kpow]['data']
-
-    # angle relative
-    kang_rel = coll.dobj[cls_spectro][kspectro]['dmat']['drock']['angle_rel']
-    ang_rel = coll.ddata[kang_rel]['data']
-
-    if rocking_curve is False:
-        dang = np.mean(np.diff(ang_rel))
-        irel = np.abs(ang_rel) < 1.4*dang
-        pow_ratio = np.zeros(pow_ratio.shape, dtype=float)
-        pow_ratio[irel] = 1
-
-    elif res_rock_curve is not None:
-        if isinstance(res_rock_curve, int):
-            nang = res_rock_curve
-        else:
-            nang = int(
-                (np.max(ang_rel) - np.min(ang_rel)) / res_rock_curve
-            )
+    # --------------
+    # return
 
-        ang_rel2 = np.linspace(np.min(ang_rel), np.max(ang_rel), nang)
-        pow_ratio = scpinterp.interp1d(
-            ang_rel,
-            pow_ratio,
-            kind='linear',
-        )(ang_rel2)
-        ang_rel = ang_rel2
+    if return_area:
+        return poly_x, poly_y, np.abs(area_ccw)
+    else:
+        return poly_x, poly_y
 
-    # resolution
-    dang = np.mean(np.diff(ang_rel))
 
-    # --------------------------------------
-    # overall bragg angle with rocking curve
+def _check_polygon_3d(
+    poly_x=None,
+    poly_y=None,
+    poly_z=None,
+    poly_name=None,
+    can_be_None=None,
+    closed=None,
+    counter_clockwise=None,
+    normal=None,
+):
 
-    if res_lamb is None and lamb is None:
-        nlamb, lamb, dlamb, angbragg = None, None, None, None
+    # -------------
+    # check inputs
 
-    else:
-        angbragg = bragg[None, :] + ang_rel[:, None]
+    # closed
+    closed = ds._generic_check._check_var(
+        closed, 'closed',
+        types=bool,
+        default=True,
+    )
 
-        # ------------
-        # safety check
+    # counter_clockwise
+    counter_clockwise = ds._generic_check._check_var(
+        counter_clockwise, 'counter_clockwise',
+        types=bool,
+        default=True,
+    )
 
-        FW = coll.dobj[cls_spectro][kspectro]['dmat']['drock']['FW']
-        dd0 = bragg[0] + np.r_[0, ang_rel[-1] - ang_rel[0]]
-        dd1 = bragg[0] + np.r_[0, FW]
-        dd2 = bragg[0] + np.r_[0, ang_rel[1] - ang_rel[0]]
+    # can_be_None
+    can_be_None = ds._generic_check._check_var(
+        can_be_None, 'can_be_None',
+        types=bool,
+        default=False,
+    )
 
-        dlamb_max = np.diff(coll.get_crystal_bragglamb(key=kspectro, bragg=dd0)[1])
-        dlamb_mh = np.diff(coll.get_crystal_bragglamb(key=kspectro, bragg=dd1)[1])
-        dlamb_res = np.diff(coll.get_crystal_bragglamb(key=kspectro, bragg=dd2)[1])
+    # -------------
+    # Trivial case
 
-        if verb is True and res_lamb is not None:
-            msg = (
-                "Recommended res_lamb to ensure rocking curve overlap:\n"
-                f"\t- edge-edge: \t{dlamb_max[0]:.2e}\n"
-                f"\t- MH-to-MH: \t{dlamb_mh[0]:.2e}\n"
-                f"\t- resolution: \t{dlamb_res[0]:.2e}\n"
-                f"\tProvided: \t{dlamb:.2e}\n"
-            )
-            print(msg)
+    if can_be_None and poly_x is None:
+        return None, None, None
 
-    return (
-        nlamb,
-        lamb,
-        dlamb,
-        pow_ratio,
-        ang_rel,
-        dang,
-        angbragg,
-    )
+    # ------------------------
+    # check each is a 1d array
 
+    if isinstance(poly_x, (list, tuple)):
+        poly_x = np.atleast_1d(poly_x)
+        poly_y = np.atleast_1d(poly_y)
+        poly_z = np.atleast_1d(poly_z)
+
+    c0 = (
+        all([
+            isinstance(pp, np.ndarray) for pp in [poly_x, poly_y, poly_z]
+        ])
+        and poly_x.ndim == poly_y.ndim == poly_z.ndim == 1
+        and poly_x.shape == poly_y.shape == poly_z.shape
+    )
+    if not c0:
+        msg = (
+            f"Arg {poly_name} must be 3 (npts,) arrays, where\n"
+            "\t- poly_x, poly_y, poly_z are (X, Y, Z) coordinates\n"
+            "\t- npts is the number of vertices\n"
+            f"Provided:\n{poly_x, poly_y, poly_z}"
+        )
+        raise Exception(msg)
 
-# ################################################
-# ################################################
-#           Loops
-# ################################################
-
-
-def _loop0(
-    iok=None,
-    ptsx=None,
-    ptsy=None,
-    ptsz=None,
-    lpoly_post=None,
-    min_threshold=None,
-    # ref
-    cent=None,
-    nin=None,
-    e0=None,
-    e1=None,
-    # p0
-    p0x=None,
-    p0y=None,
-    p0z=None,
-    # dang
-    pix_size=None,
-    dist_to_cam=None,
-    dang=None,
-    phi=None,
-    shape_cam=None,
-    # lamb
-    lamb=None,
-    dlamb=None,
-    rocking_curve=None,
-    bragg_per_pix=None,
-    ang_rel=None,
-    pow_ratio=None,
-    angbragg=None,
-    angbragg0=None,
-    angbragg1=None,
-    # optional
-    n0=None,
-    n1=None,
-    # functions
-    ptsvect_plane=None,
-    coords_x01toxyz_plane=None,
-    ptsvect_spectro=None,
-    ptsvect_cam=None,
-    # others
-    ncounts=None,
-    cbin0=None,
-    cbin1=None,
-    append=None,
-    verb=True,
-    **kwdargs,
-):
+    # ------------------------
+    # make sure not closed for ccw test
 
-    # ----------
-    # prepare
+    pt0 = np.r_[poly_x[0], poly_y[0], poly_z[0]]
+    pt1 = np.r_[poly_x[-1], poly_y[-1], poly_z[-1]]
+    if np.allclose(pt0, pt1):
+        poly_x = poly_x[:-1]
+        poly_y = poly_y[:-1]
+        poly_z = poly_z[:-1]
 
-    # counts, ph_count
-    ncounts = np.full(shape_cam, 0.)
-    sang = np.full(tuple(np.r_[shape_cam, ptsx.size]), 0.)
-    sang0 = np.full(tuple(np.r_[shape_cam, ptsx.size]), 0.)
-    sang_lamb = np.full(shape_cam, 0.)
-
-    lsang = None
-    if append is True:
-        lp0, lp1 = [], []
-        lpx, lpy, lpz = [], [], []
-        lsang = []
-    else:
-        lp0, lp1 = None, None
-        lpx, lpy, lpz = None, None, None
-        lsang = None
-
-    # power ratio
-    pwr_interp = scpinterp.interp1d(
-        ang_rel,
-        pow_ratio,
-        kind='linear',
-        bounds_error=False,
-        fill_value=0.,
-    )
+    # ------------------------
+    # make sure float
 
-    # ----------
-    # loop
+    poly_x = poly_x.astype(float)
+    poly_y = poly_y.astype(float)
+    poly_z = poly_z.astype(float)
 
-    pti = np.full((3,), np.nan)
-    npts0 = iok.sum()
-    for ii, i0 in enumerate(iok.nonzero()[0]):
-
-        pti[:] = np.r_[ptsx[i0], ptsy[i0], ptsz[i0]]
-
-        # ------------------------------------------
-        # initial polygon (crystal on its own plane)
-
-        p0, p1 = ptsvect_plane(
-            pts_x=ptsx[i0],
-            pts_y=ptsy[i0],
-            pts_z=ptsz[i0],
-            vect_x=p0x - ptsx[i0],
-            vect_y=p0y - ptsy[i0],
-            vect_z=p0z - ptsz[i0],
-            strict=True,
-            return_x01=True,
-        )[-2:]
-        p_a = plg.Polygon(np.array([p0, p1]).T)
-
-        if len(lpoly_post) > 0:
-
-            # get equivalent aperture
-            p0, p1 = _equivalent_apertures._get_equivalent_aperture(
-                p_a=p_a,
-                pt=pti,
-                nop_pre=len(lpoly_post),
-                lpoly_pre=lpoly_post,
-                ptsvect=ptsvect_plane,
-                min_threshold=min_threshold,
-                # debug
-                debug=False,
-            )
+    # ------------------------
+    # check counter-clockwise ass seen from normal vector
 
-            # skip if no intersection
-            if p0 is None or p0.size == 0:
-                continue
+    ccw = _check_polygon_3d_counter_clockwise(
+        poly_x=poly_x,
+        poly_y=poly_y,
+        poly_z=poly_z,
+        normal=normal,
+    )
+    if counter_clockwise != ccw:
+        poly_x = poly_x[::-1]
+        poly_y = poly_y[::-1]
+        poly_z = poly_z[::-1]
 
-        # compute image
-        (
-            x0c, x1c, angles, dsang, cosi, iok,
-            dangmin_str, x0if, x1if,
-            ptsx1, ptsy1, ptsz1,
-            ptsx2, ptsy2, ptsz2,
-        ) = _get_points_on_camera_from_pts(
-            p0=p0,
-            p1=p1,
-            pti=pti,
-            # ref
-            cent=cent,
-            nin=nin,
-            e0=e0,
-            e1=e1,
-            # dang
-            pix_size=pix_size,
-            dist_to_cam=dist_to_cam,
-            dang=dang,
-            phi=phi[ii],
-            # optional
-            n0=n0,
-            n1=n1,
-            # functions
-            coords_x01toxyz_plane=coords_x01toxyz_plane,
-            ptsvect_spectro=ptsvect_spectro,
-            ptsvect_cam=ptsvect_cam,
-            # debug
-            debug=npts0 == 1,
-        )
+    # ------------------------
+    # check if closed vs close
 
-        if verb is True:
-            msg = (
-                f"\t\t{ii} / {npts0} pts \t dangmin: {dangmin_str}"
-            )
-            print(msg, end='\r')
+    if closed:
+        poly_x = np.r_[poly_x, poly_x[0]]
+        poly_y = np.r_[poly_y, poly_y[0]]
+        poly_z = np.r_[poly_z, poly_z[0]]
 
-        # stack coordinates
-        if append is True:
-            npts = iok.sum()
-            lpx.append(np.array([
-                np.full((npts,), ptsx[i0]),
-                ptsx1[iok],
-                ptsx2[iok],
-            ]))
-            lpy.append(np.array([
-                np.full((npts,), ptsy[i0]),
-                ptsy1[iok],
-                ptsy2[iok],
-            ]))
-            lpz.append(np.array([
-                np.full((npts,), ptsz[i0]),
-                ptsz1[iok],
-                ptsz2[iok],
-            ]))
-
-            # p0, p1
-            lp0.append(x0c[iok])
-            lp1.append(x1c[iok])
-
-        # safety check
-        iok2 = (
-            (x0c[iok] >= cbin0[0])
-            & (x0c[iok] <= cbin0[-1])
-            & (x1c[iok] >= cbin1[0])
-            & (x1c[iok] <= cbin1[-1])
-        )
+    return poly_x, poly_y, poly_z
 
-        if not np.any(iok2):
-            continue
 
-        # update index
-        iok[iok] = iok2
+def _check_unit_vectors(det=None):
+    # check normalization
+    dnorm = {
+        k0: np.sqrt(det[f'{k0}_x']**2 + det[f'{k0}_y']**2 + det[f'{k0}_z']**2)
+        for k0 in ['e0', 'e1', 'nin']
+    }
+    if not np.allclose(list(dnorm.values()), 1):
+        lstr = [f"\t- {k0} = {v0}" for k0, v0 in dnorm.items()]
+        msg = (
+            "All unit vectors ['e0', 'e1', 'nin'] must be normalized!\n"
+            + "\n".join(lstr)
+        )
+        raise Exception(msg)
 
-        # 2d pixel by binning
-        out = scpstats.binned_statistic_2d(
-            x0c[iok],
-            x1c[iok],
-            None,
-            statistic='count',
-            bins=(cbin0, cbin1),
-            expand_binnumbers=True,
-        )
-
-        ipixok = out.statistic > 0
-        ncounts[ipixok] += out.statistic[ipixok]
-
-        sang0[ipixok, i0] += scpstats.binned_statistic_2d(
-            x0c[iok],
-            x1c[iok],
-            dsang[iok],
-            statistic='sum',
-            bins=(cbin0, cbin1),
-            expand_binnumbers=True,
-        ).statistic[ipixok]
-
-        # taking into account rocking curve
-        angles = angles[iok]
-        dsang = dsang[iok]
-
-        ip0, ip1 = ipixok.nonzero()
-        indi = np.zeros((out.binnumber.shape[1],), dtype=bool)
-        indj = np.zeros((out.binnumber.shape[1],), dtype=bool)
-        for ii in np.unique(ip0):
-            indi[:] = (out.binnumber[0, :] == (ii + 1))
-            for jj in np.unique(ip1[ip0 == ii]):
-
-                # indices
-                indj[:] = indi & (out.binnumber[1, :] == jj + 1)
-
-                if lamb is None:
-                    # solid angle
-                    sang[ii, jj, i0] += np.sum(dsang[indj])
-
-                else:
-                    # lambref
-                    arelj = angles[indj] - bragg_per_pix[ii, jj]
-
-                    # solid angle
-                    sang[ii, jj, i0] += np.sum(
-                        pwr_interp(arelj)
-                        * dsang[indj]
-                    )
-
-                    # ----------
-                    # sang_lamb
-
-                    angj = angles[indj]
-                    ilamb = (
-                        (angj[:, None] >= angbragg0)
-                        & (angj[:, None] < angbragg1)
-                    )
-
-                    if not np.any(ilamb):
-                        continue
-
-                    ilamb_n = np.any(ilamb, axis=0).nonzero()[0]
-
-                    # binning of angles
-                    for kk in ilamb_n:
-                        inds = np.searchsorted(
-                            angbragg[:, kk],
-                            angj[ilamb[:, kk]],
-                        )
-
-                        # update power_ratio * solid angle
-                        sang_lamb[ii, jj] += np.sum(
-                            pow_ratio[inds]
-                            * dsang[indj][ilamb[:, kk]]
-                        )
-
-    # adjust sang_lamb
-    if lamb is None:
-        sang_lamb = np.nansum(sang0, axis=-1)
-
-    return {
-        'ncounts': {'data': ncounts, 'units': ''},
-        'sang0': {'data': sang0, 'units': 'sr'},
-        'sang': {'data': sang, 'units': 'sr'},    # not really useful?
-        'sang_lamb': {'data': sang_lamb, 'units': 'sr'},
-        'lamb': {'data': lamb, 'units': 'm'},
-        'dlamb': {'data': dlamb, 'units': 'm'},
-        'lp0': {'data': lp0, 'units': 'm'},
-        'lp1': {'data': lp1, 'units': 'm'},
-        'lpx': {'data': lpx, 'units': 'm'},
-        'lpy': {'data': lpy, 'units': 'm'},
-        'lpz': {'data': lpz, 'units': 'm'},
-        'lsang': {'data': lsang, 'units': 'sr'},
+    # check perpendicularity
+    dsca = {
+        f'{v0}.{v1}': (
+            det[f'{v0}_x']*det[f'{v1}_x']
+            + det[f'{v0}_y']*det[f'{v1}_y']
+            + det[f'{v0}_z']*det[f'{v1}_z']
+        )
+        for v0, v1 in [('e0', 'e1'), ('e0', 'nin'), ('e1', 'nin')]
     }
+    if not np.allclose(list(dsca.values()), 0):
+        lstr = [f"\t- {k0} = {v0}" for k0, v0 in dsca.items()]
+        msg = (
+            "All unit vectors ['e0', 'e1', 'nin'] must be perpendicular!\n"
+            + "\n".join(lstr)
+        )
+        raise Exception(msg)
 
 
-def _loop1(
-    # specific
-    coll=None,
-    key=None,
-    key_cam=None,
-    key_mesh=None,
-    margin_poly=None,
-    res_phi=None,
-    dsamp=None,
-    # common
-    iok=None,
-    ptsx=None,
-    ptsy=None,
-    ptsz=None,
-    lpoly_post=None,
-    min_threshold=None,
-    # ref
-    cent=None,
-    nin=None,
-    e0=None,
-    e1=None,
-    # p0
-    p0x=None,
-    p0y=None,
-    p0z=None,
-    # dang
-    pix_size=None,
-    dist_to_cam=None,
-    dang=None,
-    phi=None,
-    shape_cam=None,
-    # optional
-    n0=None,
-    n1=None,
-    # functions
-    ptsvect_plane=None,
-    coords_x01toxyz_plane=None,
-    ptsvect_spectro=None,
-    ptsvect_cam=None,
-    # others
-    ncounts=None,
-    cbin0=None,
-    cbin1=None,
-    # others
-    verb=True,
-    **kwdargs,
-):
+def _check_det_dict(detectors=None):
 
-    # --------------------------
-    # get overall polygons
+    lk_out = ['outline_x0', 'outline_x1']
+    lk_shape = [
+        'cents_x', 'cents_y', 'cents_z',
+        'e0_x', 'e0_y', 'e0_z',
+        'e1_x', 'e1_y', 'e1_z',
+        'nin_x', 'nin_y', 'nin_z',
+    ]
 
-    pcross0, pcross1 = _utilities._get_overall_polygons(
-        coll=coll,
-        doptics=coll.dobj['diagnostic'][key]['doptics'],
-        key_cam=key_cam,
-        poly='pcross',
-    )
-
-    phor0, phor1 = _utilities._get_overall_polygons(
-        coll=coll,
-        doptics=coll.dobj['diagnostic'][key]['doptics'],
-        key_cam=key_cam,
-        poly='phor',
-    )
-
-    # --------------------------
-    # add margins
-
-    pcross0, pcross1 = _utilities._get_poly_margin(
-        # polygon
-        p0=pcross0,
-        p1=pcross1,
-        # margin
-        margin=margin_poly,
-    )
-
-    phor0, phor1 = _utilities._get_poly_margin(
-        # polygon
-        p0=phor0,
-        p1=phor1,
-        # margin
-        margin=margin_poly,
+    # make sure array + float
+    for k0 in set(lk_shape).intersection(detectors.keys()):
+        detectors[k0] = np.atleast_1d(detectors[k0]).astype(float)
+
+    # check shapes
+    c0 = (
+        all([
+            isinstance(detectors.get(ss), np.ndarray)
+            for ss in lk_out + lk_shape
+        ])
+        and all([
+            detectors[ss].shape == detectors['outline_x0'].shape
+            for ss in lk_out
+        ])
+        and all([
+            detectors[ss].shape == detectors['cents_x'].shape
+            for ss in lk_shape
+        ])
+    )
+    if not c0:
+        lmis = [kk for kk in lk_out + lk_shape if kk not in detectors.keys()]
+        msg = (
+            "Arg detectors, if a dict, must contain the following keys:\n"
+            + f"\t- missing keys: {lmis}\n"
+            "And the following keys should be array of identical shape:\n"
+            + "\n".join([f"\t- {kk}" for kk in lk_out])
+            + "\nAnd the following keys should be array of identical shape:\n"
+            + "\n".join([f"\t- {kk}" for kk in lk_shape])
+            + f"\nProvided:\n{detectors}"
+        )
+        raise Exception(msg)
+
+    # check outline
+    detectors['outline_x0'], detectors['outline_x1'] = _check_polygon_2d(
+        poly_x=detectors['outline_x0'],
+        poly_y=detectors['outline_x1'],
+        poly_name='det',
+        can_be_None=False,
+        closed=False,
+        counter_clockwise=True,
     )
 
-    # ------------------------
-    # get ind in cross-section
+    # check unit vectors (normalize + perpendicular)
+    _check_unit_vectors(detectors)
 
-    sh = dsamp['x0']['data'].shape
-    x0u = dsamp['x0']['data'][:, 0]
-    x1u = dsamp['x1']['data'][0, :]
-    x0f = dsamp['x0']['data'].ravel()
-    x1f = dsamp['x1']['data'].ravel()
-
-    pcross = Path(np.array([pcross0, pcross1]).T)
-    ind = (
-        dsamp['ind']['data']
-        & pcross.contains_points(np.array([x0f, x1f]).T).reshape(sh)
-    )
-    nRZ = ind.sum()
-
-    # R and Z indices
-    ir, iz = ind.nonzero()
-    iru = np.unique(ir)
+    # copy dict and flatten (if not 1d)
+    # if detectors['cents_x'].ndim > 1:
+        # detectors = dict(detectors)
+        # lk = [k0 for k0 in detectors.keys() if 'outline' not in k0]
+        # for k0 in lk:
+            # detectors[k0] = detectors[k0].ravel()
 
-    # ----------
-    # get dphi_r
+    return detectors
 
-    phi_hor = np.arctan2(phor1, phor0)
-    phimin = np.nanmin(phi_hor)
-    phimax = np.nanmax(phi_hor)
-
-    # get dphi vs phor
-    dphi_r = _utilities._get_dphi_from_R_phor(
-        R=x0u[iru],
-        phor0=phor0,
-        phor1=phor1,
-        phimin=phimin,
-        phimax=phimax,
-        res=res_phi,
-        out=True,
-    )
 
-    # --------------
-    # prepare output
+def _check_ap_dict(apertures=None):
 
-    indr = np.zeros((nRZ,), dtype=int)
-    indz = np.zeros((nRZ,), dtype=int)
-    ncounts = np.full(shape_cam, 0.)
-
-    lp0, lp1 = [], []
-    xx, yy = [], []
-
-    dr = np.mean(np.diff(x0u))
-    dz = np.mean(np.diff(x1u))
-    ipts = 0
-    pti = np.r_[0., 0., 0.]
-    nru = iru.size
-    for i00, i0 in enumerate(iru):
-
-        indiz = ir == i0
-        nz = indiz.sum()
-        if np.all(np.isnan(dphi_r[:, i00])):
-            ipts += nz
-            continue
+    lk0 = ['poly_x', 'poly_y', 'poly_z']
+    lk1 = ['nin']
+
+    err = False
+    if not isinstance(apertures, dict):
+        err = True
+    else:
+        if all([k0 in apertures.keys() for k0 in lk0 + lk1]):
+            apertures = {'ap0': apertures}
 
-        nphi = np.ceil(x0u[i0]*(dphi_r[1, i00] - dphi_r[0, i00]) / res_phi).astype(int)
-        phir = np.linspace(dphi_r[0, i00], dphi_r[1, i00], nphi)
-        cosphi = np.cos(phir)
-        sinphi = np.sin(phir)
-
-        dphi = phir[1] - phir[0]
-        dv = dr * x0u[i0] * dphi * dz
-
-        for i11, i1 in enumerate(iz[indiz]):
-
-            indr[ipts] = i0
-            indz[ipts] = i1
-            pti[2] = x1u[i1]
-            done_xy = []
-
-            for i2, phii in enumerate(phir):
-
-                # set point
-                pti[0] = x0u[i0]*cosphi[i2]
-                pti[1] = x0u[i0]*sinphi[i2]
-
-                # ------------------------------------------
-                # initial polygon (crystal on its own plane)
-
-                p0, p1 = ptsvect_plane(
-                    pts_x=pti[0],
-                    pts_y=pti[1],
-                    pts_z=pti[2],
-                    vect_x=p0x - pti[0],
-                    vect_y=p0y - pti[1],
-                    vect_z=p0z - pti[2],
-                    strict=True,
-                    return_x01=True,
-                )[-2:]
-                p_a = plg.Polygon(np.array([p0, p1]).T)
-
-                if len(lpoly_post) > 0:
-                    # get equivalent aperture
-                    p0, p1 = _equivalent_apertures._get_equivalent_aperture(
-                        p_a=p_a,
-                        pt=pti,
-                        nop_pre=len(lpoly_post),
-                        lpoly_pre=lpoly_post,
-                        ptsvect=ptsvect_plane,
-                        min_threshold=min_threshold,
-                    )
-
-                    # skip if no intersection
-                    if p0 is None or p0.size == 0:
-                        continue
-
-                # compute image
-                (
-                    x0c, x1c, angles, dsang, cosi, iok,
-                    dangmin_str, x0if, x1if,
-                ) = _get_points_on_camera_from_pts(
-                    p0=p0,
-                    p1=p1,
-                    pti=pti,
-                    # ref
-                    cent=cent,
-                    nin=nin,
-                    e0=e0,
-                    e1=e1,
-                    # dang
-                    pix_size=pix_size,
-                    dist_to_cam=dist_to_cam,
-                    dang=dang,
-                    phi=phii,
-                    # resoluions
-                    n0=n0,
-                    n1=n1,
-                    # functions
-                    coords_x01toxyz_plane=coords_x01toxyz_plane,
-                    ptsvect_spectro=ptsvect_spectro,
-                    ptsvect_cam=ptsvect_cam,
-                )[:9]
-
-                # update
-                lp0.append(x0c)
-                lp1.append(x1c)
-                if i2 not in done_xy:
-                    xx.append(x0u[i0] * np.cos(phii))
-                    yy.append(x0u[i0] * np.sin(phii))
-                    done_xy.append(i2)
-
-                if verb is True:
-                    msg = (
-                        f"\t\t{i00} / {nru}, {i11} / {nz}, {i2} / {nphi}"
-                        f":  {iok.sum()} pts   "
-                        f"\t dangmin: {dangmin_str}"
-                    )
-                    print(msg, end='\r')
-
-                # safety check
-                iok2 = (
-                    (x0c[iok] >= cbin0[0])
-                    & (x0c[iok] <= cbin0[-1])
-                    & (x1c[iok] >= cbin1[0])
-                    & (x1c[iok] <= cbin1[-1])
-                )
-
-                if not np.any(iok2):
-                    continue
-
-                # update index
-                iok[iok] = iok2
-
-                # 2d pixel by binning
-                out = scpstats.binned_statistic_2d(
-                    x0c[iok],
-                    x1c[iok],
-                    dsang[iok],
-                    statistic='sum',
-                    bins=(cbin0, cbin1),
-                    expand_binnumbers=True,
-                )
+        lkout = [
+            k0 for k0, v0 in apertures.items()
+            if not (
+                all([k1 in v0.keys() for k1 in lk0 + lk1])
+                and all([
+                    isinstance(v0[k1], np.ndarray)
+                    and v0['poly_x'].shape == v0[k1].shape
+                    for k1 in lk0
+                ])
+                and all([v0[k1].shape == (3,) for k1 in lk1])
+                and np.sqrt(np.sum([v0[k1]**2 for k1 in lk1])) == 1.
+            )
+        ]
+        if len(lkout) > 1:
+            err = True
 
-                ipixok = out.statistic > 0
-                ncounts[ipixok] += out.statistic[ipixok] * dv
+    if err:
+        msg = (
+            "Arg apertures must be a dict with keys:\n"
+            "\t- 'nin': normal vector oriented towards the plasma\n"
+            "\t- 'poly_x', 'poly_y', 'poly_z': 3d (x, y, z) polygon\n"
+            "        must be counter-clockwise from 'nin'"
+        )
+        raise Exception(msg)
 
-    # ------------------
-    # length for etendue
+    # make sure float
+    for k0, v0 in apertures.items():
+        for k1 in lk0 + lk1:
+            apertures[k0][k1] = np.atleast_1d(v0[k1]).ravel().astype(float)
 
-    # mesh envelop
-    dout = coll.get_mesh_outline(key=key_mesh)
-    p0 = dout['x0']['data']
-    p1 = dout['x1']['data']
-
-    etendue, length = _get_etendue_length(
-        coll=coll,
-        doptics=coll.dobj['diagnostic'][key]['doptics'][key_cam],
-        poly=np.array([p0, p1]),
-    )
-
-    return {
-        'ncounts': {'data': ncounts / length, 'units': 'm3/m'},
-        'lp0': {'data': lp0, 'units': 'm'},
-        'lp1': {'data': lp1, 'units': 'm'},
-        'ptsx': {'data': np.array(xx), 'units': 'm'},
-        'ptsy': {'data': np.array(yy), 'units': 'm'},
-        'ptsr': {'data': x0u[ir], 'units': 'm'},
-        'ptsz': {'data': x1u[iz], 'units': 'm'},
-    }
+    # check polygons
+    for k0, v0 in apertures.items():
+        (
+            apertures[k0]['poly_x'],
+            apertures[k0]['poly_y'],
+            apertures[k0]['poly_z'],
+        ) = _check_polygon_3d(
+            poly_x=v0['poly_x'],
+            poly_y=v0['poly_y'],
+            poly_z=v0['poly_z'],
+            poly_name=k0,
+            can_be_None=False,
+            closed=False,
+            counter_clockwise=True,
+            normal=v0['nin'],
+        )
+
+    return apertures
 
 
-def _get_etendue_length(
-    coll=None,
-    doptics=None,
-    poly=None,
+def _calc_solidangle_apertures_check(
+    # observation points
+    pts_x=None,
+    pts_y=None,
+    pts_z=None,
+    # polygons
+    apertures=None,
+    detectors=None,
+    # possible obstacles
+    config=None,
+    # parameters
+    summed=None,
+    visibility=None,
+    return_vector=None,
+    # output formatting
+    return_flat_pts=None,
+    return_flat_det=None,
+    # options
+    timing=None,
 ):
 
-    # ----------------------
-    # get etendue and length
+    # ---------------
+    # pts coordinates
 
-    ketend = doptics['etendue']
-    etendue = coll.ddata[ketend]['data']
+    pts_x = _check_pts(pts=pts_x)
+    pts_y = _check_pts(pts=pts_y)
+    pts_z = _check_pts(pts=pts_z)
+
+    if not (pts_x.shape == pts_y.shape == pts_z.shape):
+        msg = (
+            "Arg pts_x, pts_y and pts_z must share the same shape!\n"
+            f"\t- pts_x.shape = {pts_x.shape}\n"
+            f"\t- pts_y.shape = {pts_y.shape}\n"
+            f"\t- pts_z.shape = {pts_z.shape}\n"
+        )
+        raise Exception(msg)
 
-    # -------------------------
-    # los through mesh envelopp
+    mask = np.isfinite(pts_x) & np.isfinite(pts_y) & np.isfinite(pts_z)
+    if np.all(mask):
+        mask = None
 
-    # los
-    klos = doptics['los']
-    ptsx, ptsy, ptsz = coll.get_rays_pts(key=klos)
-    vectx, vecty, vectz = coll.get_rays_vect(key=klos)
-
-    iok = np.isfinite(vectx[-1, ...])
-    length = np.full(vectx.shape[1:], np.nan)
-
-    DD = np.array([
-        ptsx[-2, ...][iok],
-        ptsy[-2, ...][iok],
-        ptsz[-2, ...][iok],
-    ])
-    uu = np.array([
-        vectx[-1, ...][iok],
-        vecty[-1, ...][iok],
-        vectz[-1, ...][iok],
-    ])
-
-    # Prepare structures
-    from ..geom import _core
-    ves = _core.Ves(
-        Poly=poly,
-        Name='temp',
-        Exp='',
-    )
-
-    conf = _core.Config(
-        lStruct=[ves],
-        Name='temp',
-        Exp='',
-    )
-
-    # ray-tracing
-    cam = _core.CamLOS1D(
-        dgeom=(DD, uu),
-        config=conf,
-        Name='temp',
-        Diag='',
-        Exp='',
-        strict=False,
-    )
-
-    # length
-    length[iok] = (cam.dgeom['kOut'] - cam.dgeom['kIn'])
-
-    return etendue, length
-
-
-# ################################################
-# ################################################
-#           Sub-routine
-# ################################################
-
-
-def _get_points_on_camera_from_pts(
-    p0=None,
-    p1=None,
-    pti=None,
-    # ref
-    cent=None,
-    nin=None,
-    e0=None,
-    e1=None,
-    # dang
-    pix_size=None,
-    dist_to_cam=None,
-    dang=None,
-    phi=None,
-    # optional
-    n0=None,
-    n1=None,
-    # functions
-    coords_x01toxyz_plane=None,
-    ptsvect_spectro=None,
-    ptsvect_cam=None,
-    # output
-    ptsx_all=None,
-    ptsy_all=None,
-    ptsz_all=None,
-    # debug
-    debug=None,
-):
+    # ---------
+    # detectors
 
-    # anuglar resolution associated to pixels
-    vect = cent - pti
-    dist = np.linalg.norm(vect)
-    vect = vect / dist
-    dang_pix = pix_size / (dist_to_cam + dist)
-
-    # dang
-    dang_min = min(dang, 0.25*dang_pix)
-    dangmin_str = f"rock {dang:.2e} vs {0.25*dang_pix:.2e} 1/4 pixel"
-
-    # set n0, n1
-    p0min, p0max = p0.min(), p0.max()
-    p1min, p1max = p1.min(), p1.max()
-
-    if n0 is None:
-        cos0 = np.linalg.norm(np.cross(e0, vect))
-        ang0 = cos0 * (p0max - p0min) / dist
-        n0 = int(np.ceil(ang0 / dang_min)) + 2
-    if n1 is None:
-        cos1 = np.linalg.norm(np.cross(e1, vect))
-        ang1 = cos1 * (p1max - p1min) / dist
-        n1 = int(np.ceil(ang1 / dang_min)) + 2
-
-    # sample 2d equivalent aperture
-    margin0 = 1e-6 * (p0max - p0min)
-    margin1 = 1e-6 * (p1max - p1min)
-    x0i = np.linspace(p0min + margin0, p0max - margin0, n0)
-    x1i = np.linspace(p1min + margin1, p1max - margin1, n1)
-    dx0 = x0i[1] - x0i[0]
-    dx1 = x1i[1] - x1i[0]
-
-    # mesh
-    x0if = np.repeat(x0i[:, None], n1, axis=1)
-    x1if = np.repeat(x1i[None, :], n0, axis=0)
-    ind = Path(np.array([p0, p1]).T).contains_points(
-        np.array([x0if.ravel(), x1if.ravel()]).T
-    ).reshape((n0, n1))
-
-    # back to 3d
-    xx, yy, zz = coords_x01toxyz_plane(
-        x0=x0if,
-        x1=x1if,
-    )
-
-    # approx solid angles
-    ax = xx - pti[0]
-    ay = yy - pti[1]
-    az = zz - pti[2]
-    di = np.sqrt(ax**2 + ay**2 + az**2)
-    cos = np.abs((nin[0] * ax + nin[1] * ay + nin[2] * az) / di)
-    dsang = dx0 * dx1 * cos / di**2
-
-    # get normalized vector from plasma point to crystal
-    vectx = ax / di
-    vecty = ay / di
-    vectz = az / di
+    detectors = _check_det_dict(detectors)
 
-    # get local cosine vs toroidal direction (for doppler)
-    cos = -vectx*np.sin(phi) + vecty*np.cos(phi)
+    # ---------
+    # apertures
 
-    # get reflexion
-    (
-        ptsx1, ptsy1, ptsz1,
-        vx, vy, vz,
-        angles,
-    ) = ptsvect_spectro(
-        pts_x=pti[0],
-        pts_y=pti[1],
-        pts_z=pti[2],
-        vect_x=vectx,
-        vect_y=vecty,
-        vect_z=vectz,
-        strict=False,
-        return_x01=False,
-    )[:7]
-
-    # get x0, x1 on camera
-    x0c, x1c, ptsx2, ptsy2, ptsz2 = ptsvect_cam(
-        pts_x=ptsx1,
-        pts_y=ptsy1,
-        pts_z=ptsz1,
-        vect_x=vx,
-        vect_y=vy,
-        vect_z=vz,
-    )
+    if apertures is not None:
+        apertures = _check_ap_dict(apertures)
 
-    return (
-        x0c, x1c, angles, dsang, cos, ind,
-        dangmin_str, x0if, x1if,
-        ptsx1, ptsy1, ptsz1,
-        ptsx2, ptsy2, ptsz2,
+    # ----------
+    # summed
+
+    summed = ds._generic_check._check_var(
+        summed, 'summed',
+        types=bool,
+        default=False,
     )
 
+    # ----------
+    # visibility
 
-# ####################################################
-# ####################################################
-#               plot
-# ####################################################
-
-
-def _plot(
-    coll=None,
-    key=None,
-    key_cam=None,
-    dout=None,
-    # auxiliary
-    cbin0=None,
-    cbin1=None,
-    is2d=None,
-    # options
-    plot_config=None,
-    plot_pixels=None,
-    vmin=None,
-    vmax=None,
-    aspect3d=None,
-    elements=None,
-    colorbar=None,
-    # options
-    dax=None,
-    fs=None,
-    dmargin=None,
-    wintit=None,
-):
+    visibility = ds._generic_check._check_var(
+        visibility, 'visibility',
+        types=bool,
+        default=False,
+    )
 
-    # --------------
-    # check inputs
+    # -------------
+    # return_vector
 
-    aspect3d = ds._generic_check._check_var(
-        aspect3d, 'aspect3d',
-        default='equal',
-        allowed=['auto', 'equal'],
+    return_vector = ds._generic_check._check_var(
+        return_vector, 'return_vector',
+        types=bool,
+        default=False,
     )
 
-    elements = ds._generic_check._check_var(
-        elements, 'elements',
-        default='o',
-        types=str,
+    # -------------
+    # timing
+
+    timing = ds._generic_check._check_var(
+        timing, 'timing',
+        types=bool,
+        default=False,
     )
 
-    # --------------
-    # add ncounts to ddata
+    # -------------
+    # compatibility
 
-    ktemp = f'{key_cam}_ncounts'
-    nn = len([
-        k0 for k0 in coll.ddata.keys()
-        if k0.startswith(ktemp)
-    ])
-    if nn > 0:
-        ktemp = f'{ktemp}{nn}'
-
-    coll.add_data(
-        key=ktemp,
-        ref=coll.dobj['camera'][key_cam]['dgeom']['ref'],
-        **dout['ncounts'],
-    )
-
-    kd = 'sang_lamb'
-    if vmin is None:
-        vmin = 0
-    if vmax is None:
-        vmax = np.nanmax(dout[kd]['data'])
+    if summed is True:
+        if (visibility or return_vector or apertures is None):
+            msg = (
+                "Arg summed = True only usable with (so far):\n"
+                "\t- visibility = False\n"
+                "\t- return_vector = False\n"
+                "\t- aperture != None"
+            )
+            raise NotImplementedError(msg)
 
-    # --------------
-    # prepare
+    # ------
+    # config
+
+    if visibility:
+        if not config.__class__.__name__ == 'Config':
+            msg = (
+                "If visibility, config must be provided (Config instance)\n"
+                f"Provided: {config}"
+            )
+            raise Exception(msg)
+
+    # ----------
+    # check aperture vs visibility
+
+    if apertures is None and (visibility is True or return_vector is True):
+        msg = (
+            "No apertures provided!\n"
+            "=> visibility must be False\n"
+            "=> return_vector must be False\n"
+        )
+        raise Exception(msg)
 
-    dplot = coll.get_diagnostic_dplot(
-        key=key,
-        key_cam=key_cam,
-        optics=None,
-        elements=elements,
+    return (
+        pts_x, pts_y, pts_z, mask,
+        apertures, detectors,
+        summed, visibility,
+        return_vector, timing,
     )
 
-    # --------------
-    # plot_pixels
 
-    out0, out1 = coll.get_optics_outline(key_cam, total=True)
-    ck0f = np.array([cbin0, cbin0, np.full((cbin0.size,), np.nan)])
-    ck1f = np.array([cbin1, cbin1, np.full((cbin1.size,), np.nan)])
-    ck01 = np.r_[np.min(cbin1), np.max(cbin1), np.nan]
-    ck10 = np.r_[np.min(cbin0), np.max(cbin0), np.nan]
+###############################################################################
+###############################################################################
+#           Prepare data - arbitrary points, multiple apertures
+###############################################################################
+
+
+def _calc_solidangle_apertures_prepare(
+    # observation points
+    pts_x=None,
+    pts_y=None,
+    pts_z=None,
+    mask=None,
+    # polygons
+    apertures=None,
+    detectors=None,
+    # possible obstacles
+    config=None,
+):
 
-    # --------------
-    # pepare dax
+    # -----------------------------
+    # pts as 1d C-contiguous arrays
 
-    if dax is None:
-        dax, cax = _get_dax(
-            fs=fs,
-            dmargin=dmargin,
-        )
-        # dax = _generic_plot.get_dax_diag(
-            # proj=['cross', 'hor', '3d', 'camera'],
-            # dmargin=dmargin,
-            # fs=fs,
-            # wintit=wintit,
-            # tit=key,
-            # is2d=True,
-            # key_cam=['rays', 'binned'],
-        # )
+    ndim0 = pts_x.ndim
+    shape0 = pts_x.shape
 
-    dax = _generic_check._check_dax(dax=dax, main='cross')
+    if mask is not None:
+        pts_x = pts_x[mask]
+        pts_y = pts_y[mask]
+        pts_z = pts_z[mask]
+
+    if ndim0 > 1:
+        pts_x = pts_x.ravel()
+        pts_y = pts_y.ravel()
+        pts_z = pts_z.ravel()
 
-    # --------------
-    # prepare camera
+    # ---------
+    # apertures
 
-    kax = 'cam_all'
-    if dax.get(kax) is not None:
-        ax = dax[kax]['handle']
-
-        ax.plot(
-            np.r_[out0, out0[0]],
-            np.r_[out1, out1[0]],
-            c='k',
-            ls='-',
-            lw=0.5,
-        )
-
-        if plot_pixels is True:
-            ax.plot(
-                ck0f.T.ravel(),
-                np.tile(ck01, cbin0.size),
-                c='k',
-                ls='-',
-                lw=0.1,
-            )
-            ax.plot(
-                np.tile(ck10, cbin1.size),
-                ck1f.T.ravel(),
-                c='k',
-                ls='-',
-                lw=0.1,
-            )
+    if apertures is None:
+        ap_ind, ap_x, ap_y, ap_z = None, None, None, None
+        ap_nin_x, ap_nin_y, ap_nin_z = None, None, None
+    else:
+        lka = list(apertures.keys())
+        ap_ind = np.r_[
+            0, np.cumsum([apertures[k0]['poly_x'].size for k0 in lka])
+        ]
+        ap_x = np.concatenate([apertures[k0]['poly_x'] for k0 in lka])
+        ap_y = np.concatenate([apertures[k0]['poly_y'] for k0 in lka])
+        ap_z = np.concatenate([apertures[k0]['poly_z'] for k0 in lka])
+        ap_nin_x = np.array([apertures[k0]['nin'][0] for k0 in lka])
+        ap_nin_y = np.array([apertures[k0]['nin'][1] for k0 in lka])
+        ap_nin_z = np.array([apertures[k0]['nin'][2] for k0 in lka])
 
+    # ---------
+    # detectors
 
-    # -------------
-    # mesh sampling
+    det_shape0 = detectors['cents_x'].shape
 
-    if dout.get('lpx') is None:
+    det_outline_x0 = detectors['outline_x0']
+    det_outline_x1 = detectors['outline_x1']
+    det_cents_x = detectors['cents_x'].ravel()
+    det_cents_y = detectors['cents_y'].ravel()
+    det_cents_z = detectors['cents_z'].ravel()
+    det_nin_x = detectors['nin_x'].ravel()
+    det_nin_y = detectors['nin_y'].ravel()
+    det_nin_z = detectors['nin_z'].ravel()
+    det_e0_x = detectors['e0_x'].ravel()
+    det_e0_y = detectors['e0_y'].ravel()
+    det_e0_z = detectors['e0_z'].ravel()
+    det_e1_x = detectors['e1_x'].ravel()
+    det_e1_y = detectors['e1_y'].ravel()
+    det_e1_z = detectors['e1_z'].ravel()
 
-        kax = 'cross'
-        if dax.get(kax) is not None:
-            ax = dax[kax]['handle']
-
-            ax.plot(
-                dout['ptsr']['data'],
-                dout['ptsz']['data'],
-                ls='None',
-                lw=1.,
-                marker='.',
-            )
+    return (
+        ndim0, shape0, mask,
+        pts_x, pts_y, pts_z,
+        ap_ind, ap_x, ap_y, ap_z,
+        ap_nin_x, ap_nin_y, ap_nin_z,
+        det_shape0, det_outline_x0, det_outline_x1,
+        det_cents_x, det_cents_y, det_cents_z,
+        det_nin_x, det_nin_y, det_nin_z,
+        det_e0_x, det_e0_y, det_e0_z,
+        det_e1_x, det_e1_y, det_e1_z,
+    )
 
-        kax = 'hor'
-        if dax.get(kax) is not None:
-            ax = dax[kax]['handle']
-
-            ax.plot(
-                dout['ptsx']['data'],
-                dout['ptsy']['data'],
-                ls='None',
-                lw=1.,
-                marker='.',
-            )
 
-        kax = 'cam_all'
-        if dax.get(kax) is not None:
-            ax = dax[kax]['handle']
-
-            p0 = np.concatenate([pp.ravel() for pp in dout['lp0']['data']])
-            p1 = np.concatenate([pp.ravel() for pp in dout['lp1']['data']])
-            ax.plot(
-                p0,
-                p1,
-                ls='None',
-                marker='.',
-            )
+def _visibility_unit_vectors(
+    # points
+    pts_x=None,
+    pts_y=None,
+    pts_z=None,
+    # det
+    det_cents_x=None,
+    det_cents_y=None,
+    det_cents_z=None,
+    det_nin_x=None,
+    det_nin_y=None,
+    det_nin_z=None,
+    # results
+    solid_angle=None,
+    unit_vector_x=None,
+    unit_vector_y=None,
+    unit_vector_z=None,
+    **kwdargs,
+):
+    """
 
-    else:
+    """
 
-        # --------------
-        # ray-tracing
+    # compute pts on det surfaces
+    # re-use pre-existing code (TBF)
+    for ii in range(pts_x.size):
 
-        for ii in range(len(dout['lp0']['data'])):
+        iok = solid_angle[:, ii] > 0
+        if not np.any(iok):
+            continue
 
-            p0 = dout['lp0']['data'][ii]
-            p1 = dout['lp1']['data'][ii]
+        # Compute point P such that:
+        #   MP = kk * unit_vect
+        #   CP.norm = 0
+        #   => kk = (MC.norm) / (unit_vect.norm)
+
+        # un = unit_vect.norm
+        un = (
+            unit_vector_x[iok, ii]*det_nin_x[iok]
+            + unit_vector_y[iok, ii]*det_nin_y[iok]
+            + unit_vector_z[iok, ii]*det_nin_z[iok]
+        )
 
-            # --------------
-            # camera image
-
-            kax = 'cam_all'
-            if dax.get(kax) is not None:
-                ax = dax[kax]['handle']
-
-                if dout['lamb']['data'] is None:
-                    ax.plot(
-                        p0,
-                        p1,
-                        ls='None',
-                        marker='.',
-                        # c=dout['lcolor'][ii],
-                    )
-                elif dout['rocking_curve'] is False:
-                    ax.plot(
-                        p0[dout['lindin'][ii]],
-                        p1[dout['lindin'][ii]],
-                        ls='None',
-                        marker='.',
-                        # c=dout['lcolor'][ii],
-                    )
-                    ax.plot(
-                        p0[~dout['lindin'][ii]],
-                        p1[~dout['lindin'][ii]],
-                        ls='None',
-                        marker='.',
-                        c=(0.8, 0.8, 0.8),
-                    )
-                else:
-                    ax.scatter(
-                        p0,
-                        p1,
-                        # c=dout['lcolor'][ii],
-                        s=8,
-                        marker='.',
-                    )
-
-            # --------------
-            # rays
-
-            ind = np.arange(3, dout['lpx']['data'][ii].size, 3)
-            px = np.insert(dout['lpx']['data'][ii].T.ravel(), ind, np.nan)
-            py = np.insert(dout['lpy']['data'][ii].T.ravel(), ind, np.nan)
-            pz = np.insert(dout['lpz']['data'][ii].T.ravel(), ind, np.nan)
-
-            kax = 'cross'
-            if dax.get(kax) is not None:
-                ax = dax[kax]['handle']
-
-                ax.plot(
-                    np.hypot(px, py),
-                    pz,
-                    ls='-',
-                    lw=1.,
-                )
-
-            kax = 'hor'
-            if dax.get(kax) is not None:
-                ax = dax[kax]['handle']
-
-                ax.plot(
-                    px,
-                    py,
-                    ls='-',
-                    lw=1.,
-                )
-
-            kax = '3d'
-            if dax.get(kax) is not None:
-                ax = dax[kax]['handle']
-
-                ax.plot(
-                    px,
-                    py,
-                    pz,
-                    ls='-',
-                    lw=1.,
-                )
+        # MC = point to centers
+        MCx = det_cents_x[iok] - pts_x[ii]
+        MCy = det_cents_y[iok] - pts_y[ii]
+        MCz = det_cents_z[iok] - pts_z[ii]
+
+        # MCn = MC.norm
+        MCn = (
+            MCx*det_nin_x[iok]
+            + MCy*det_nin_y[iok]
+            + MCz*det_nin_z[iok]
+        )
 
-    # ----------
-    # counts
+        # kk = (MC.norm) / (unit_vect.norm)
+        kk = MCn / un
 
-    kax = 'cam_bin'
-    if dax.get(kax) is not None:
-        ax = dax[kax]['handle']
-
-        extent = (cbin0[0], cbin0[-1], cbin1[0], cbin1[-1])
-        im = ax.imshow(
-            dout[kd]['data'].T,
-            extent=extent,
-            interpolation='nearest',
-            origin='lower',
-            vmin=vmin,
-            vmax=vmax,
-        )
-
-        ax.set_title(kd, size=12, fontweight='bold')
-        if colorbar is True:
-            cb = plt.colorbar(im, ax=ax, cax=cax)
-            cb.set_label(dout[kd]['units'], size=12, weight='bold')
+        # P = M + kk * unit_vect
+        Px = pts_x[ii] + kk * unit_vector_x[iok, ii]
+        Py = pts_y[ii] + kk * unit_vector_y[iok, ii]
+        Pz = pts_z[ii] + kk * unit_vector_z[iok, ii]
+
+        # Estimate visibility
+        vis = _GG.LOS_isVis_PtFromPts_VesStruct(
+            Px, Py, Pz,
+            np.array([[pts_x[ii]], [pts_y[ii]], [pts_z[ii]]]),
+            dist=kk,
+            **kwdargs,
+        )
 
-    # ----------
-    # diag geom
+        # Set non-visible to 0 / nan
+        iokn = iok.nonzero()[0]
+        iout = iokn[vis == 0]
+        solid_angle[iout, ii] = 0.
+        unit_vector_x[iout, ii] = np.nan
+        unit_vector_y[iout, ii] = np.nan
+        unit_vector_z[iout, ii] = np.nan
+
+
+###############################################################################
+###############################################################################
+#                           Main entry
+#       arbitrary points, multiple detectors, multiple apertures
+###############################################################################
+
+
+def calc_solidangle_apertures(
+    # observation points
+    pts_x=None,
+    pts_y=None,
+    pts_z=None,
+    # polygons
+    apertures=None,
+    detectors=None,
+    # possible obstacles
+    config=None,
+    # parameters
+    summed=None,
+    visibility=None,
+    return_vector=None,
+    return_flat_pts=None,
+    return_flat_det=None,
+    timing=None,
+):
+    """ Return the solid angle subtended by na apertures and nd detectors
 
-    _class8_plot._plot_diag_geom(
-        dax=dax,
-        key_cam=key_cam,
-        dplot=dplot,
-        is2d=coll.dobj['diagnostic'][key]['is2d'],
-    )
+    Uses non-closed polygons
 
-    # -------
-    # config
+    See the following issue for details on the implementation:
+        https://github.com/ToFuProject/tofu/issues/653
 
-    if plot_config.__class__.__name__ == 'Config':
+    The observation points are:
+        - defined in (X, Y, Z) coordinates using arrays pts_x, pts_y, pts_z
+        - They should have the same shape (shape0)
+
+    The apertures are defined as a list of closed 3d polygons:
+        - defined in (X, Y, Z) coordinates
+
+    The detectors are defined another list of closed 3d polygon:
+        - defined in (X, Y, Z) coordinates
+
+    Alternatively, detectors can also be provided as:
+        - being planar and sharing the same 2d outline
+        - using a dict with keys:
+            - 'outline_x0': 1d array of (ncorners,) coordinates
+            - 'outline_x1': 1d array of (ncorners,) coordinates
+            - 'centers_x': detector's center position x as (nd,) array
+            - 'centers_y': detector's center position y as (nd,) array
+            - 'centers_z': detector's center position z as (nd,) array
+            - 'nin_x': normal unit vector x as (nd,) array
+            - 'nin_y': normal unit vector y as (nd,) array
+            - 'nin_z': normal unit vector z as (nd,) array
+            - 'e1_x': x0 unit vector x as (nd,) array
+            - 'e1_y': x0 unit vector y as (nd,) array
+            - 'e1_z': x0 unit vector z as (nd,) array
+            - 'e2_x': x1 unit vector x as (nd,) array
+            - 'e2_y': x1 unit vector y as (nd,) array
+            - 'e2_z': x1 unit vector z as (nd,) array
+
+    Config is needed if visibility = True to check for obstacles (ray-tracing)
+    It is a tofu Config class
+
+    Return
+    ----------
+    solid_angle:        np.ndarray of shape (nd, shape0)
+        The solid angles
+            computed for each point / det pair
+            considering all apertures
+    unit_vector_x:      np.ndarray of shape (nd, shape0)  (optional)
+        The local unit vectors x coordinates
+    unit_vector_y:      np.ndarray of shape (nd, shape0) (optional)
+        The local unit vectors y coordinates
+    unit_vector_z:      np.ndarray of shape (nd, shape0)  (optional)
+        The local unit vectors z coordinates
 
-        kax = 'cross'
-        if dax.get(kax) is not None:
-            ax = dax[kax]['handle']
-            plot_config.plot(lax=ax, proj=kax, dLeg=False)
-
-        kax = 'hor'
-        if dax.get(kax) is not None:
-            ax = dax[kax]['handle']
-            plot_config.plot(lax=ax, proj=kax, dLeg=False)
+    """
 
-    # --------------
-    # aspect3d
+    # --------------------------------------
+    # check inputs (robust vs user mistakes)
 
-    if aspect3d == 'equal' and dax.get('3d') is not None:
-        ds.set_aspect3d(ax=dax['3d']['handle'])
+    if timing:
+        t0 = dtm.datetime.now()     # DB
 
-    # --------------
-    # clean up
+    (
+        # observation points
+        pts_x,
+        pts_y,
+        pts_z,
+        mask,
+        # polygons
+        apertures,
+        detectors,
+        # parameters
+        summed,
+        visibility,
+        return_vector,
+        timing,
+    ) = _calc_solidangle_apertures_check(
+        # observation points
+        pts_x=pts_x,
+        pts_y=pts_y,
+        pts_z=pts_z,
+        # polygons
+        apertures=apertures,
+        detectors=detectors,
+        # possible obstacles
+        config=config,
+        # parameters
+        summed=summed,
+        visibility=visibility,
+        return_vector=return_vector,
+        # output formatting
+        return_flat_pts=return_flat_pts,
+        return_flat_det=return_flat_det,
+        # options
+        timing=timing,
+    )
 
-    coll.remove_data(ktemp)
+    # ----------------
+    # pre-format input
 
-    return
+    (
+        ndim0, shape0, mask,
+        pts_x, pts_y, pts_z,
+        ap_ind, ap_x, ap_y, ap_z,
+        ap_nin_x, ap_nin_y, ap_nin_z,
+        det_shape0, det_outline_x0, det_outline_x1,
+        det_cents_x, det_cents_y, det_cents_z,
+        det_nin_x, det_nin_y, det_nin_z,
+        det_e0_x, det_e0_y, det_e0_z,
+        det_e1_x, det_e1_y, det_e1_z,
+    ) = _calc_solidangle_apertures_prepare(
+        # observation points
+        pts_x=pts_x,
+        pts_y=pts_y,
+        pts_z=pts_z,
+        mask=mask,
+        # polygons
+        apertures=apertures,
+        detectors=detectors,
+    )
+
+    nd = det_cents_x.size
+
+    # Get kwdargs for LOS blocking
+    if config is not None:
+        kwdargs = {
+            k0: v0 for k0, v0 in config.get_kwdargs_LOS_isVis().items()
+            if 'eps' not in k0
+            and k0 not in ['ves_type', 'test', 'forbid', 'k']
+        }
 
+    if timing:
+        t1 = dtm.datetime.now()     # DB
+        dt1 = (t1 - t0).total_seconds()
+
+    # ------------------------------------------------
+    # compute (call appropriate version for each case)
+
+    if apertures is None:
+        # call fastest / simplest version without apertures
+        # (no computation / storing of unit vector)
+
+        solid_angle = _GG.compute_solid_angle_noapertures(
+            # pts as 1d arrays
+            pts_x=pts_x,
+            pts_y=pts_y,
+            pts_z=pts_z,
+            # detector polygons as 1d arrays
+            det_outline_x0=det_outline_x0,
+            det_outline_x1=det_outline_x1,
+            det_cents_x=det_cents_x,
+            det_cents_y=det_cents_y,
+            det_cents_z=det_cents_z,
+            det_norm_x=det_nin_x,
+            det_norm_y=det_nin_y,
+            det_norm_z=det_nin_z,
+            det_e0_x=det_e0_x,
+            det_e0_y=det_e0_y,
+            det_e0_z=det_e0_z,
+            det_e1_x=det_e1_x,
+            det_e1_y=det_e1_y,
+            det_e1_z=det_e1_z,
+        )
 
-def _get_dax(
-    fs=None,
-    dmargin=None,
-):
+    elif return_vector:
+        # call most complete version
+        # (computation + storing of unit vector)
+        (
+            solid_angle,
+            unit_vector_x, unit_vector_y, unit_vector_z,
+        ) = _GG.compute_solid_angle_apertures_unitvectors(
+            # pts as 1d arrays
+            pts_x=pts_x,
+            pts_y=pts_y,
+            pts_z=pts_z,
+            # detector polygons as 1d arrays
+            det_outline_x0=det_outline_x0,
+            det_outline_x1=det_outline_x1,
+            det_cents_x=det_cents_x,
+            det_cents_y=det_cents_y,
+            det_cents_z=det_cents_z,
+            det_norm_x=det_nin_x,
+            det_norm_y=det_nin_y,
+            det_norm_z=det_nin_z,
+            det_e0_x=det_e0_x,
+            det_e0_y=det_e0_y,
+            det_e0_z=det_e0_z,
+            det_e1_x=det_e1_x,
+            det_e1_y=det_e1_y,
+            det_e1_z=det_e1_z,
+            # apertures
+            ap_ind=ap_ind,
+            ap_x=ap_x,
+            ap_y=ap_y,
+            ap_z=ap_z,
+            ap_norm_x=ap_nin_x,
+            ap_norm_y=ap_nin_y,
+            ap_norm_z=ap_nin_z,
+        )
 
-    # ----------
-    # check
+        if visibility:
+            _visibility_unit_vectors(
+                # points
+                pts_x=pts_x,
+                pts_y=pts_y,
+                pts_z=pts_z,
+                # det
+                det_cents_x=det_cents_x,
+                det_cents_y=det_cents_y,
+                det_cents_z=det_cents_z,
+                det_nin_x=det_nin_x,
+                det_nin_y=det_nin_y,
+                det_nin_z=det_nin_z,
+                # results
+                solid_angle=solid_angle,
+                unit_vector_x=unit_vector_x,
+                unit_vector_y=unit_vector_y,
+                unit_vector_z=unit_vector_z,
+                **kwdargs,
+            )
 
-    if fs is None:
-        fs = (15, 9)
+    elif visibility:
+        # call intermediate version
+        # (computation for visibility but no storing of unit vector)
+        solid_angle = _GG.compute_solid_angle_apertures_visibility(
+            # pts as 1d arrays
+            pts_x=pts_x,
+            pts_y=pts_y,
+            pts_z=pts_z,
+            # detector polygons as 1d arrays
+            det_outline_x0=det_outline_x0,
+            det_outline_x1=det_outline_x1,
+            det_cents_x=det_cents_x,
+            det_cents_y=det_cents_y,
+            det_cents_z=det_cents_z,
+            det_norm_x=det_nin_x,
+            det_norm_y=det_nin_y,
+            det_norm_z=det_nin_z,
+            det_e0_x=det_e0_x,
+            det_e0_y=det_e0_y,
+            det_e0_z=det_e0_z,
+            det_e1_x=det_e1_x,
+            det_e1_y=det_e1_y,
+            det_e1_z=det_e1_z,
+            # apertures
+            ap_ind=ap_ind,
+            ap_x=ap_x,
+            ap_y=ap_y,
+            ap_z=ap_z,
+            ap_norm_x=ap_nin_x,
+            ap_norm_y=ap_nin_y,
+            ap_norm_z=ap_nin_z,
+            # possible obstacles
+            **kwdargs,
+        )
 
-    dmargin = ds._generic_check._check_var(
-        dmargin, 'dmargin',
-        types=dict,
-        default={
-            'bottom': 0.05, 'top': 0.95,
-            'left': 0.05, 'right': 0.94,
-            'wspace': 0.20, 'hspace': 0.25,
-        },
-    )
-
-    # --------
-    # prepare
-
-    ncols = 31
-    nh = int((ncols - 1) / 2)
-    fig = plt.figure(figsize=fs)
-    gs = gridspec.GridSpec(ncols=ncols, nrows=4, **dmargin)
-
-    # --------
-    # create
-
-    ax0 = fig.add_subplot(gs[:2, :nh], aspect='equal', adjustable='datalim')
-    ax0.set_xlabel('X (m)')
-    ax0.set_ylabel('Y (m)')
-
-    ax1 = fig.add_subplot(gs[2:, :nh], aspect='equal', adjustable='datalim')
-    ax1.set_xlabel('R (m)')
-    ax1.set_ylabel('Z (m)')
-
-    ax2 = fig.add_subplot(gs[:2, nh:-1], projection='3d')
-    ax2.set_xlabel('X (m)')
-    ax2.set_ylabel('Y (m)')
-    ax2.set_ylabel('Z (m)')
-
-    ax3 = fig.add_subplot(gs[2, nh:-1], aspect='equal')
-    ax3.set_ylabel('x1 (m)')
-
-    ax4 = fig.add_subplot(gs[3, nh:-1], sharex=ax3, sharey=ax3)
-    ax4.set_ylabel('x1 (m)')
-    ax4.set_xlabel('x0 (m)')
-
-    cax = fig.add_subplot(gs[3, -1])
-
-    dax = {
-        'cross': {'handle': ax0, 'type': 'cross'},
-        'hor': {'handle': ax1, 'type': 'hor'},
-        '3d': {'handle': ax2, 'type': '3d'},
-        'cam_all': {'handle': ax3, 'type': 'camera'},
-        'cam_bin': {'handle': ax4, 'type': 'camera'},
-    }
+    else:
+        # call fastest / simplest version
+        # (no computation / storing of unit vector)
+
+        if summed is True:
+            solid_angle = _GG.compute_solid_angle_apertures_light_summed(
+                # pts as 1d arrays
+                pts_x=pts_x,
+                pts_y=pts_y,
+                pts_z=pts_z,
+                # detector polygons as 1d arrays
+                det_outline_x0=det_outline_x0,
+                det_outline_x1=det_outline_x1,
+                det_cents_x=det_cents_x,
+                det_cents_y=det_cents_y,
+                det_cents_z=det_cents_z,
+                det_norm_x=det_nin_x,
+                det_norm_y=det_nin_y,
+                det_norm_z=det_nin_z,
+                det_e0_x=det_e0_x,
+                det_e0_y=det_e0_y,
+                det_e0_z=det_e0_z,
+                det_e1_x=det_e1_x,
+                det_e1_y=det_e1_y,
+                det_e1_z=det_e1_z,
+                # apertures
+                ap_ind=ap_ind,
+                ap_x=ap_x,
+                ap_y=ap_y,
+                ap_z=ap_z,
+                ap_norm_x=ap_nin_x,
+                ap_norm_y=ap_nin_y,
+                ap_norm_z=ap_nin_z,
+            )
+
+        else:
+            solid_angle = _GG.compute_solid_angle_apertures_light(
+                # pts as 1d arrays
+                pts_x=pts_x,
+                pts_y=pts_y,
+                pts_z=pts_z,
+                # detector polygons as 1d arrays
+                det_outline_x0=det_outline_x0,
+                det_outline_x1=det_outline_x1,
+                det_cents_x=det_cents_x,
+                det_cents_y=det_cents_y,
+                det_cents_z=det_cents_z,
+                det_norm_x=det_nin_x,
+                det_norm_y=det_nin_y,
+                det_norm_z=det_nin_z,
+                det_e0_x=det_e0_x,
+                det_e0_y=det_e0_y,
+                det_e0_z=det_e0_z,
+                det_e1_x=det_e1_x,
+                det_e1_y=det_e1_y,
+                det_e1_z=det_e1_z,
+                # apertures
+                ap_ind=ap_ind,
+                ap_x=ap_x,
+                ap_y=ap_y,
+                ap_z=ap_z,
+                ap_norm_x=ap_nin_x,
+                ap_norm_y=ap_nin_y,
+                ap_norm_z=ap_nin_z,
+            )
 
-    return dax, cax
+    if timing:
+        t2 = dtm.datetime.now()     # DB
+        dt2 = (t2 - t1).total_seconds()
+
+    # -------------
+    # format output
+
+    # solid_angle = 0 => nan for unit vectors
+    if return_vector:
+        i0 = solid_angle == 0
+        unit_vector_x[i0] = np.nan
+        unit_vector_y[i0] = np.nan
+        unit_vector_z[i0] = np.nan
+
+    # reshape if necessary
+    if summed is False:
+        shape = tuple(np.r_[det_shape0, shape0])
+        if mask is None:
+            if ndim0 > 1:
+                solid_angle = np.reshape(solid_angle, shape)
+                if return_vector:
+                    unit_vector_x = np.reshape(unit_vector_x, shape)
+                    unit_vector_y = np.reshape(unit_vector_y, shape)
+                    unit_vector_z = np.reshape(unit_vector_z, shape)
+        else:
+            sa = np.zeros(shape, dtype=float)
+            sa[:, mask] = solid_angle
+            if return_vector:
+                ux = np.fill(shape0, np.nan)
+                uy = np.fill(shape0, np.nan)
+                uz = np.fill(shape0, np.nan)
+                ux[:, mask] = unit_vector_x
+                uy[:, mask] = unit_vector_y
+                uz[:, mask] = unit_vector_z
+
+            # replace
+            solid_angle = sa
+            if return_vector:
+                unit_vector_x, unit_vector_y, unit_vector_z = ux, uy, uz
+
+    if timing:
+        t3 = dtm.datetime.now()     # DB
+        dt3 = (t3 - t2).total_seconds()
+
+    # ------
+    # return
+
+    if return_vector:
+        if timing:
+            return (
+                solid_angle, unit_vector_x, unit_vector_y, unit_vector_z,
+                dt1, dt2, dt3,
+            )
+        else:
+            return solid_angle, unit_vector_x, unit_vector_y, unit_vector_z
+
+    else:
+        if timing:
+            return solid_angle, dt1, dt2, dt3
+        else:
+            return solid_angle
```

### Comparing `tofu-1.7.7/tofu/data/_class8_vos.py` & `tofu-1.7.8/tofu/data/_class8_vos.py`

 * *Files 2% similar despite different names*

```diff
@@ -452,27 +452,18 @@
         types=bool,
         default=False,
     )
 
     # -----------
     # return_vector
 
-    if spectro is True:
-        lok = [True, False]
-    else:
-        if keep3d is False:
-            lok = [False]
-        else:
-            lok = [True, False]
-
     return_vector = ds._generic_check._check_var(
         return_vector, 'return_vector',
         types=bool,
         default=False,
-        allowed=lok,
     )
 
     # -----------
     # convexHull - to get overall pcross and phor, faster if many pixels
 
     convexHull = ds._generic_check._check_var(
         convexHull, 'convexHull',
@@ -702,15 +693,15 @@
             'ph', 'cos', 'ncounts',
             'phi_min', 'phi_max',
             # optional
             'phi_mean',
             'dV', 'etendlen',
         ]
     else:
-        lk = ['sang_cross', 'sang_3d']
+        lk = ['sang_cross', 'ang_pol_cross', 'ang_tor_cross', 'sang_3d']
 
 
     # ------------
     # store
 
     doptics = coll._dobj['diagnostic'][key_diag]['doptics']
 
@@ -962,39 +953,45 @@
         raise Exception(msg)
 
     # only keep desired cams
     lkout = [k0 for k0 in dvos.keys() if k0 not in key_cam]
     for k0 in lkout:
         del dvos[k0]
 
-    return dvos, isstore
+    return key_diag, dvos, isstore
 
 
 # ###############################################################
 # ###############################################################
 #                       get vos to 3d
 # ###############################################################
 
 
 def get_dvos_xyz(coll=None, key_diag=None, key_cam=None, dvos=None):
 
     # ---------
     # get dvos
 
-    dvos, isstore = coll.check_diagnostic_dvos(
+    key_diag, dvos, isstore = coll.check_diagnostic_dvos(
         key=key_diag,
         key_cam=key_cam,
         dvos=dvos,
     )
 
     # check
-    if not all([v0.get('indr_3d') is not None for v0 in dvos.values()]):
+    k3d = 'indr_3d'
+    if not all([v0.get(k3d) is not None for v0 in dvos.values()]):
+        lstr = [
+            f"\t\t- dvos['{k0}']: '{k3d}' {'not' if v0.get(k3d) is None else ''} available"
+            for k0, v0 in dvos.items()
+        ]
         msg = (
             "dvos can only provide (x, y, z) if it contains 3d information!\n"
-            f"\t- key_diag: {key_diag}"
+            f"\t- key_diag: {key_diag}\n"
+            + "\n".join(lstr)
         )
         raise Exception(msg)
 
     # ---------
     # to xyz
 
     for k0, v0 in dvos.items():
```

### Comparing `tofu-1.7.7/tofu/data/_class8_vos_broadband.py` & `tofu-1.7.8/tofu/data/_class8_vos_broadband.py`

 * *Files 9% similar despite different names*

```diff
@@ -159,18 +159,27 @@
     else:
         lindr_3d = None
         lindz_3d = None
         lphi_3d = None
         lsang_3d = None
 
     if return_vector is True:
-        lvectx = []
-        lvecty = []
-        lvectz = []
+        lang_tor_cross = []
+        lang_pol_cross = []
+        if keep3d is True:
+            lvectx = []
+            lvecty = []
+            lvectz = []
+        else:
+            lvectx = None
+            lvecty = None
+            lvectz = None
     else:
+        lang_tor_cross = None
+        lang_pol_cross = None
         lvectx = None
         lvecty = None
         lvectz = None
 
     # ----------------
     # loop on pixels
 
@@ -212,25 +221,31 @@
 
         if xx is None:
             npts_cross = 0
             lpcross.append((None, None))
             lsang_cross.append(np.zeros((npts_cross,), dtype=float))
             lindr_cross.append(np.zeros((npts_cross,), dtype=float))
             lindz_cross.append(np.zeros((npts_cross,), dtype=float))
+            if return_vector is True:
+                lang_pol_cross.append(np.zeros((npts_cross,), dtype=float))
+                lang_tor_cross.append(np.zeros((npts_cross,), dtype=float))
             continue
 
         # re-initialize
         bool_cross[...] = False
         npts_tot = xx.size
         npts_cross = np.sum([v0['iz'].size for v0 in dind.values()])
 
         dsang_hor = {}
         sang_cross = np.zeros((npts_cross,), dtype=float)
         indr_cross = np.zeros((npts_cross,), dtype=int)
         indz_cross = np.zeros((npts_cross,), dtype=int)
+        if return_vector is True:
+            ang_pol_cross = np.zeros((npts_cross,), dtype=float)
+            ang_tor_cross = np.zeros((npts_cross,), dtype=float)
 
         if verb is True:
             msg = (
                 f"\tcam '{key_cam}' pixel {ii+1} / {npix}"
                 f"\tnpts in cross_section = {npts_cross}"
                 f"\t({npts_tot} total)"
             )
@@ -285,26 +300,39 @@
         # ------------
         # get indices
 
         if timing:
             t0 = dtm.datetime.now()     # DB
             out, dt1, dt2, dt3 = out
 
-        # update cross
+        # update cross-section
         ipt = 0
         for i0, v0 in dind.items():
             for i1 in v0['iz']:
                 ind1 = dind[i0]['indrz'] & (iz == i1)
-                sang_cross[ipt] = np.sum(out[0, ind1]) * v0['dV']
+                totii = np.sum(out[0, ind1]) * v0['dV']
+                sang_cross[ipt] = totii
                 indr_cross[ipt] = i0
                 indz_cross[ipt] = i1
                 bool_cross[i0 + 1, i1 + 1] = sang_cross[ipt] > 0.
+                if vectx is not None:
+                    tor = np.arctan2(yy[ind1], xx[ind1])
+                    ang_pol = np.arctan2(
+                        vectz[0, ind1],
+                        vectx[0, ind1]*np.cos(tor) + vecty[0, ind1]*np.sin(tor),
+                    )
+                    ang_tor = np.arccos(
+                        vectx[0, ind1] * (-np.sin(tor))
+                        + vecty[0, ind1] * np.cos(tor)
+                    )
+                    ang_pol_cross[ipt] = np.sum(out[0, ind1] * ang_pol) / totii
+                    ang_tor_cross[ipt] = np.sum(out[0, ind1] * ang_tor) / totii
                 ipt += 1
 
-        # update hor
+        # update horizontal
         for i0, v0 in dind.items():
             dsang_hor[i0] = np.zeros((v0['phi'].size,))
             for i1 in range(v0['phi'].size):
                 ind1 = dind[i0]['indrz'] & (iphi == i1)
                 dsang_hor[i0][i1] = np.sum(out[0, ind1]) * v0['dV']
 
         # update 3d
@@ -372,14 +400,17 @@
         # replace
 
         lpcross.append((pc0, pc1))
         lphor.append((ph0, ph1))
         lsang_cross.append(sang_cross)
         lindr_cross.append(indr_cross)
         lindz_cross.append(indz_cross)
+        if lang_pol_cross is not None:
+            lang_pol_cross.append(ang_pol_cross)
+            lang_tor_cross.append(ang_tor_cross)
 
         if keep3d is True:
             lsang_3d.append(sang_3d)
             lindr_3d.append(indr_3d)
             lindz_3d.append(indz_3d)
             lphi_3d.append(phi_3d)
 
@@ -427,14 +458,28 @@
         shape=shape[1:],
     )
 
     # extract
     lk = ['lsang_cross', 'lindr_cross', 'lindz_cross']
     sang_cross, indr_cross, indz_cross = [dout.get(k0) for k0 in lk]
 
+
+    if lang_pol_cross is not None:
+        dout = _harmonize_reshape_others(
+            lang_pol_cross=lang_pol_cross,
+            lang_tor_cross=lang_tor_cross,
+            # params
+            npix=npix,
+            is2d=is2d,
+            shape=shape[1:],
+        )
+        lk = ['lang_pol_cross', 'lang_tor_cross']
+        ang_pol_cross, ang_tor_cross = [dout.get(k0) for k0 in lk]
+
+
     # 3d
     dout = _harmonize_reshape_others(
         # 3d
         lsang_3d=lsang_3d,
         lindr_3d=lindr_3d,
         lindz_3d=lindz_3d,
         lphi_3d=lphi_3d,
@@ -464,14 +509,18 @@
 
     knpts_cross = f'{key_cam}_vos_npts_cross'
     kir_cross = f'{key_cam}_vos_ir_cross'
     kiz_cross = f'{key_cam}_vos_iz_cross'
     ksa_cross = f'{key_cam}_vos_sa_cross'
     ref_cross = tuple(list(coll.dobj['camera'][key_cam]['dgeom']['ref']) + [knpts_cross])
 
+    if lang_pol_cross is not None:
+        kap_cross = f'{key_cam}_vos_ang_pol_cross'
+        kat_cross = f'{key_cam}_vos_ang_tor_cross'
+
     if keep3d:
         knpts_3d = f'{key_cam}_vos_npts_3d'
         kir_3d = f'{key_cam}_vos_ir_3d'
         kiz_3d = f'{key_cam}_vos_iz_3d'
         kphi_3d = f'{key_cam}_vos_phi_3d'
         ksa_3d = f'{key_cam}_vos_sa_3d'
         ref_3d = tuple(list(coll.dobj['camera'][key_cam]['dgeom']['ref']) + [knpts_3d])
@@ -543,14 +592,34 @@
             'data': sang_cross,
             'ref': ref_cross,
             'units': 'sr.m3',
             'dim': 'sang',
         },
     })
 
+    # return_vect
+    if lang_pol_cross is not None:
+        dout.update({
+            'ang_pol_cross': {
+                'key': kap_cross,
+                'data': ang_pol_cross,
+                'ref': ref_cross,
+                'units': 'rad',
+                'dim': 'angle',
+            },
+            'ang_tor_cross': {
+                'key': kat_cross,
+                'data': ang_tor_cross,
+                'ref': ref_cross,
+                'units': 'rad',
+                'dim': 'angle',
+            },
+        })
+
+    # keep3d
     if keep3d is True:
         dout.update({
             'indr_3d': {
                 'key': kir_3d,
                 'data': indr_3d,
                 'ref': ref_3d,
                 'units': '',
```

### Comparing `tofu-1.7.7/tofu/data/_class8_vos_spectro.py` & `tofu-1.7.8/tofu/data/_class8_vos_spectro.py`

 * *Files 2% similar despite different names*

```diff
@@ -176,37 +176,29 @@
     # -------------------------------------
     # prepare lambda, angles, rocking_curve
 
     (
         nlamb,
         lamb,
         dlamb,
-        pow_ratio,
+        pow_interp,
         ang_rel,
         dang,
-        angbragg,
+        bragg,
     ) = _reverse_rt._prepare_lamb(
         coll=coll,
         key_diag=key_diag,
         key_cam=key_cam,
         kspectro=kspectro,
         lamb=lamb,
         res_lamb=res_lamb,
         res_rock_curve=res_rock_curve,
         verb=verb,
     )
 
-    angbragg0 = angbragg[:1, :]
-    angbragg1 = angbragg[-1:, :]
-
-    # linterpbragg = [
-        # scpinterp.interp1d(angbragg[:, kk], pow_ratio, kind='linear')
-        # for kk in range(angbragg.shape[1])
-    # ]
-
     # --------------
     # prepare output
 
     shape_cam = coll.dobj['camera'][key_cam]['dgeom']['shape']
     is2d = len(shape_cam) == 2
 
     shape0 = tuple(np.r_[shape_cam, nRZ])
@@ -294,16 +286,16 @@
 
             for i2, phii in enumerate(phir):
 
                 if timing:
                     t000 = dtm.datetime.now()     # DB
 
                 # set point
-                pti[0] = x0u[i0]*cosphi[i2]
-                pti[1] = x0u[i0]*sinphi[i2]
+                pti[0] = x0u[i0] * cosphi[i2]
+                pti[1] = x0u[i0] * sinphi[i2]
                 # phi[ipts] = phii
 
                 # ------------------------------------------
                 # initial polygon (crystal on its own plane)
 
                 p0, p1 = ptsvect_plane(
                     pts_x=pti[0],
@@ -459,40 +451,45 @@
 
                         # cos
                         cos[ii, jj, ipts] += np.sum(cosi[indj])
 
                         # ilamb
                         angj = angles[indj]
                         ilamb = (
-                            (angj[:, None] >= angbragg0)
-                            & (angj[:, None] < angbragg1)
+                            (angj[:, None] - bragg >= ang_rel[0])
+                            & (angj[:, None] - bragg < ang_rel[-1])
                         )
 
                         if not np.any(ilamb):
                             continue
 
                         ilamb_n = np.any(ilamb, axis=0).nonzero()[0]
 
                         # nphi_all  # DB
                         # nphi_all[ii, jj, ipts, ilamb_n] += 1
 
                         # if False:
                         # binning of angles
                         for kk in ilamb_n:
-                            inds = np.searchsorted(
-                                angbragg[:, kk],
-                                angj[ilamb[:, kk]],
-                            )
-
-                            # update power_ratio * solid angle
                             ph_count[ii, jj, ipts, kk] += np.sum(
-                                pow_ratio[inds]
+                                pow_interp(angj[ilamb[:, kk]] - bragg[kk])
                                 * dsang[indj][ilamb[:, kk]]
                             ) * dv
 
+                            # inds = np.searchsorted(
+                            #     angbragg[:, kk],
+                            #     angj[ilamb[:, kk]],
+                            # )
+
+                            # # update power_ratio * solid angle
+                            # ph_count[ii, jj, ipts, kk] += np.sum(
+                            #     pow_ratio[inds]
+                            #     * dsang[indj][ilamb[:, kk]]
+                            # ) * dv
+
                             # ------  DEBUG -------
                             # ph_approx[ii, jj, ipts, kk] += (
                                 # POW
                                 # * FW
                                 # * np.sum(dang1[0, np.any(iok, axis=0)])
                             # ) * dv
```

### Comparing `tofu-1.7.7/tofu/data/_class8_vos_spectro_nobin_at_lamb.py` & `tofu-1.7.8/tofu/data/_class8_vos_spectro_nobin_at_lamb.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class8_vos_utilities.py` & `tofu-1.7.8/tofu/data/_class8_vos_utilities.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_class9_compute.py` & `tofu-1.7.8/tofu/data/_class9_compute.py`

 * *Files 0% similar despite different names*

```diff
@@ -316,15 +316,15 @@
     crop = (
         crop
         and coll.dobj[wbs][key_bs]['crop'] not in [None, False]
     )
 
     # dvos
     if method == 'vos':
-        dvos, isstore = coll.check_diagnostic_dvos(
+        key_diag, dvos, isstore = coll.check_diagnostic_dvos(
             key=key_diag,
             key_cam=key_cam,
             dvos=dvos,
         )
 
     # brightness
     brightness = ds._generic_check._check_var(
```

### Comparing `tofu-1.7.7/tofu/data/_class9_plot.py` & `tofu-1.7.8/tofu/data/_class9_plot.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_comp.py` & `tofu-1.7.8/tofu/data/_comp.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_core.py` & `tofu-1.7.8/tofu/data/_core.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_core_plot.py` & `tofu-1.7.8/tofu/data/_core_plot.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_generic_check.py` & `tofu-1.7.8/tofu/data/_generic_check.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_generic_plot.py` & `tofu-1.7.8/tofu/data/_generic_plot.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_plot.py` & `tofu-1.7.8/tofu/data/_plot.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_saveload.py` & `tofu-1.7.8/tofu/data/_saveload.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_spectrallines_checks.py` & `tofu-1.7.8/tofu/data/_spectrallines_checks.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_spectrallines_class.py` & `tofu-1.7.8/tofu/data/_spectrallines_class.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_spectrallines_compute.py` & `tofu-1.7.8/tofu/data/_spectrallines_compute.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_spectrallines_plot.py` & `tofu-1.7.8/tofu/data/_spectrallines_plot.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_spectralunits.py` & `tofu-1.7.8/tofu/data/_spectralunits.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_utils_bsplines.py` & `tofu-1.7.8/tofu/data/_utils_bsplines.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/data/_utils_surface3d.py` & `tofu-1.7.8/tofu/data/_utils_surface3d.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/defaults.py` & `tofu-1.7.8/tofu/defaults.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/dumpro/_core.py` & `tofu-1.7.8/tofu/dumpro/_core.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/dust/_comp.py` & `tofu-1.7.8/tofu/dust/_comp.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/dust/_core.py` & `tofu-1.7.8/tofu/dust/_core.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/dust/_plot.py` & `tofu-1.7.8/tofu/dust/_plot.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/entrypoints/_def.py` & `tofu-1.7.8/tofu/entrypoints/_def.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/entrypoints/tofucalc.py` & `tofu-1.7.8/tofu/entrypoints/tofucalc.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/entrypoints/tofuplot.py` & `tofu-1.7.8/tofu/entrypoints/tofuplot.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/_GG.pyx` & `tofu-1.7.8/tofu/geom/_GG.pyx`

 * *Files 0% similar despite different names*

```diff
@@ -58,16150 +58,16157 @@
 00000390: 6173 2063 5f70 690a 6672 6f6d 206c 6962  as c_pi.from lib
 000003a0: 632e 6d61 7468 2063 696d 706f 7274 204e  c.math cimport N
 000003b0: 414e 2061 7320 435f 4e41 4e0a 6672 6f6d  AN as C_NAN.from
 000003c0: 206c 6962 632e 6d61 7468 2063 696d 706f   libc.math cimpo
 000003d0: 7274 2049 4e46 494e 4954 5920 6173 2043  rt INFINITY as C
 000003e0: 5f49 4e46 0a66 726f 6d20 6c69 6263 2e73  _INF.from libc.s
 000003f0: 7464 6c69 6220 6369 6d70 6f72 7420 6d61  tdlib cimport ma
-00000400: 6c6c 6f63 2c20 6672 6565 0a0a 2320 2d2d  lloc, free..# --
-00000410: 2065 7874 7261 206c 6962 7261 7269 6573   extra libraries
-00000420: 2069 6d70 6f72 7473 202d 2d2d 2d2d 2d2d   imports -------
-00000430: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000440: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00000450: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 696d 706f  -----------.impo
-00000460: 7274 2050 6f6c 7967 6f6e 2061 7320 706c  rt Polygon as pl
-00000470: 670a 0a0a 2320 2d2d 2054 6f46 7520 6c69  g...# -- ToFu li
-00000480: 6272 6172 7920 696d 706f 7274 7320 2d2d  brary imports --
-00000490: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000004a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000004b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000004c0: 2d2d 2d2d 0a66 726f 6d20 2e5f 6261 7369  ----.from ._basi
-000004d0: 635f 6765 6f6d 5f74 6f6f 6c73 2063 696d  c_geom_tools cim
-000004e0: 706f 7274 205f 5653 4d41 4c4c 2c20 5f53  port _VSMALL, _S
-000004f0: 4d41 4c4c 0a66 726f 6d20 2e5f 6261 7369  MALL.from ._basi
-00000500: 635f 6765 6f6d 5f74 6f6f 6c73 2063 696d  c_geom_tools cim
-00000510: 706f 7274 205f 5457 4f50 490a 6672 6f6d  port _TWOPI.from
-00000520: 202e 2063 696d 706f 7274 205f 6261 7369   . cimport _basi
-00000530: 635f 6765 6f6d 5f74 6f6f 6c73 2061 7320  c_geom_tools as 
-00000540: 5f62 6774 0a66 726f 6d20 2e20 6369 6d70  _bgt.from . cimp
-00000550: 6f72 7420 5f72 6179 7472 6163 696e 675f  ort _raytracing_
-00000560: 746f 6f6c 7320 6173 205f 7274 0a66 726f  tools as _rt.fro
-00000570: 6d20 2e20 6369 6d70 6f72 7420 5f64 6973  m . cimport _dis
-00000580: 7461 6e63 655f 746f 6f6c 7320 6173 205f  tance_tools as _
-00000590: 6474 0a66 726f 6d20 2e20 6369 6d70 6f72  dt.from . cimpor
-000005a0: 7420 5f73 616d 706c 696e 675f 746f 6f6c  t _sampling_tool
-000005b0: 7320 6173 205f 7374 0a66 726f 6d20 2e20  s as _st.from . 
-000005c0: 6369 6d70 6f72 7420 5f76 6967 6e65 7474  cimport _vignett
-000005d0: 696e 675f 746f 6f6c 7320 6173 205f 7674  ing_tools as _vt
-000005e0: 0a66 726f 6d20 2e20 696d 706f 7274 205f  .from . import _
-000005f0: 6f70 656e 6d70 5f74 6f6f 6c73 2061 7320  openmp_tools as 
-00000600: 5f6f 6d70 740a 0a0a 2320 3d3d 2045 7870  _ompt...# == Exp
-00000610: 6f72 7473 203d 3d3d 3d3d 3d3d 3d3d 3d3d  orts ===========
-00000620: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00000630: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00000640: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00000650: 3d3d 3d3d 3d3d 3d3d 0a0a 5f5f 616c 6c5f  ========..__all_
-00000660: 5f20 3d20 5b0a 2020 2020 2763 6f6f 7264  _ = [.    'coord
-00000670: 5f73 6869 6674 272c 0a20 2020 2022 636f  _shift',.    "co
-00000680: 6d70 5f64 6973 745f 6c6f 735f 6369 7263  mp_dist_los_circ
-00000690: 6c65 222c 0a20 2020 2022 636f 6d70 5f64  le",.    "comp_d
-000006a0: 6973 745f 6c6f 735f 6369 7263 6c65 5f76  ist_los_circle_v
-000006b0: 6563 222c 0a20 2020 2022 636f 6d70 5f64  ec",.    "comp_d
-000006c0: 6973 745f 6c6f 735f 7670 6f6c 7922 2c0a  ist_los_vpoly",.
-000006d0: 2020 2020 2263 6f6d 705f 6469 7374 5f6c      "comp_dist_l
-000006e0: 6f73 5f76 706f 6c79 5f76 6563 222c 0a20  os_vpoly_vec",. 
-000006f0: 2020 2022 6973 5f63 6c6f 7365 5f6c 6f73     "is_close_los
-00000700: 5f76 706f 6c79 5f76 6563 222c 0a20 2020  _vpoly_vec",.   
-00000710: 2022 6973 5f63 6c6f 7365 5f6c 6f73 5f63   "is_close_los_c
-00000720: 6972 636c 6522 2c0a 2020 2020 2269 735f  ircle",.    "is_
-00000730: 636c 6f73 655f 6c6f 735f 6369 7263 6c65  close_los_circle
-00000740: 5f76 6563 222c 0a20 2020 2022 7768 6963  _vec",.    "whic
-00000750: 685f 6c6f 735f 636c 6f73 6572 5f76 706f  h_los_closer_vpo
-00000760: 6c79 5f76 6563 222c 0a20 2020 2022 7768  ly_vec",.    "wh
-00000770: 6963 685f 7670 6f6c 795f 636c 6f73 6572  ich_vpoly_closer
-00000780: 5f6c 6f73 5f76 6563 222c 0a20 2020 2022  _los_vec",.    "
-00000790: 4c4f 535f 7369 6e6f 5f66 696e 6452 6f6f  LOS_sino_findRoo
-000007a0: 746b 504d 696e 5f54 6f72 222c 0a20 2020  tkPMin_Tor",.   
-000007b0: 2027 506f 6c79 5f69 7343 6c6f 636b 7769   'Poly_isClockwi
-000007c0: 7365 272c 2027 506f 6c79 5f56 6f6c 416e  se', 'Poly_VolAn
-000007d0: 6754 6f72 272c 0a20 2020 2027 706f 6c79  gTor',.    'poly
-000007e0: 5f61 7265 6127 2c20 2270 6f6c 795f 6172  _area', "poly_ar
-000007f0: 6561 5f61 6e64 5f62 6172 7963 656e 7465  ea_and_barycente
-00000800: 7222 2c0a 2020 2020 2753 696e 6f5f 496d  r",.    'Sino_Im
-00000810: 7061 6374 456e 7627 2c20 2743 6f6e 7665  pactEnv', 'Conve
-00000820: 7274 496d 7061 6374 5f54 6865 7461 3258  rtImpact_Theta2X
-00000830: 6927 2c0a 2020 2020 275f 5665 735f 6973  i',.    '_Ves_is
-00000840: 496e 7369 6465 272c 0a20 2020 2027 6469  Inside',.    'di
-00000850: 7363 7265 7469 7a65 5f6c 696e 6531 6427  scretize_line1d'
-00000860: 2c0a 2020 2020 2764 6973 6372 6574 697a  ,.    'discretiz
-00000870: 655f 7365 676d 656e 7432 6427 2c20 275f  e_segment2d', '_
-00000880: 5665 735f 6d65 7368 4372 6f73 735f 4672  Ves_meshCross_Fr
-00000890: 6f6d 496e 6427 2c0a 2020 2020 2764 6973  omInd',.    'dis
-000008a0: 6372 6574 697a 655f 7670 6f6c 7927 2c0a  cretize_vpoly',.
-000008b0: 2020 2020 275f 5665 735f 566d 6573 685f      '_Ves_Vmesh_
-000008c0: 546f 725f 5375 6246 726f 6d44 5f63 7974  Tor_SubFromD_cyt
-000008d0: 686f 6e27 2c0a 2020 2020 275f 5665 735f  hon',.    '_Ves_
-000008e0: 566d 6573 685f 546f 725f 5375 6246 726f  Vmesh_Tor_SubFro
-000008f0: 6d49 6e64 5f63 7974 686f 6e27 2c0a 2020  mInd_cython',.  
-00000900: 2020 275f 5665 735f 566d 6573 685f 546f    '_Ves_Vmesh_To
-00000910: 725f 5375 6246 726f 6d44 5f63 7974 686f  r_SubFromD_cytho
-00000920: 6e5f 6f6c 6427 2c0a 2020 2020 275f 5665  n_old',.    '_Ve
-00000930: 735f 566d 6573 685f 546f 725f 5375 6246  s_Vmesh_Tor_SubF
-00000940: 726f 6d49 6e64 5f63 7974 686f 6e5f 6f6c  romInd_cython_ol
-00000950: 6427 2c0a 2020 2020 275f 5665 735f 566d  d',.    '_Ves_Vm
-00000960: 6573 685f 4c69 6e5f 5375 6246 726f 6d44  esh_Lin_SubFromD
-00000970: 5f63 7974 686f 6e27 2c20 275f 5665 735f  _cython', '_Ves_
-00000980: 566d 6573 685f 4c69 6e5f 5375 6246 726f  Vmesh_Lin_SubFro
-00000990: 6d49 6e64 5f63 7974 686f 6e27 2c0a 2020  mInd_cython',.  
-000009a0: 2020 275f 5665 735f 536d 6573 685f 546f    '_Ves_Smesh_To
-000009b0: 725f 5375 6246 726f 6d44 5f63 7974 686f  r_SubFromD_cytho
-000009c0: 6e27 2c20 275f 5665 735f 536d 6573 685f  n', '_Ves_Smesh_
-000009d0: 546f 725f 5375 6246 726f 6d49 6e64 5f63  Tor_SubFromInd_c
-000009e0: 7974 686f 6e27 2c0a 2020 2020 275f 5665  ython',.    '_Ve
-000009f0: 735f 536d 6573 685f 546f 7253 7472 7563  s_Smesh_TorStruc
-00000a00: 745f 5375 6246 726f 6d44 5f63 7974 686f  t_SubFromD_cytho
-00000a10: 6e27 2c0a 2020 2020 275f 5665 735f 536d  n',.    '_Ves_Sm
-00000a20: 6573 685f 546f 7253 7472 7563 745f 5375  esh_TorStruct_Su
-00000a30: 6246 726f 6d49 6e64 5f63 7974 686f 6e27  bFromInd_cython'
-00000a40: 2c0a 2020 2020 275f 5665 735f 536d 6573  ,.    '_Ves_Smes
-00000a50: 685f 4c69 6e5f 5375 6246 726f 6d44 5f63  h_Lin_SubFromD_c
-00000a60: 7974 686f 6e27 2c0a 2020 2020 275f 5665  ython',.    '_Ve
-00000a70: 735f 536d 6573 685f 4c69 6e5f 5375 6246  s_Smesh_Lin_SubF
-00000a80: 726f 6d49 6e64 5f63 7974 686f 6e27 2c0a  romInd_cython',.
-00000a90: 2020 2020 274c 4f53 5f43 616c 635f 5049      'LOS_Calc_PI
-00000aa0: 6e4f 7574 5f56 6573 5374 7275 6374 272c  nOut_VesStruct',
-00000ab0: 0a20 2020 2022 4c4f 535f 4361 6c63 5f6b  .    "LOS_Calc_k
-00000ac0: 4d69 6e6b 4d61 785f 5665 7353 7472 7563  MinkMax_VesStruc
-00000ad0: 7422 2c0a 2020 2020 224c 4f53 5f69 7356  t",.    "LOS_isV
-00000ae0: 6973 5f50 7446 726f 6d50 7473 5f56 6573  is_PtFromPts_Ves
-00000af0: 5374 7275 6374 222c 0a20 2020 2022 4c4f  Struct",.    "LO
-00000b00: 535f 6172 6556 6973 5f50 7473 4672 6f6d  S_areVis_PtsFrom
-00000b10: 5074 735f 5665 7353 7472 7563 7422 2c0a  Pts_VesStruct",.
-00000b20: 2020 2020 274c 4f53 5f67 6574 5f73 616d      'LOS_get_sam
-00000b30: 706c 6527 2c20 274c 4f53 5f63 616c 635f  ple', 'LOS_calc_
-00000b40: 7369 676e 616c 272c 0a20 2020 2027 4c4f  signal',.    'LO
-00000b50: 535f 7369 6e6f 272c 2027 696e 7465 6772  S_sino', 'integr
-00000b60: 6174 6531 6427 2c0a 2020 2020 2274 7269  ate1d',.    "tri
-00000b70: 616e 6775 6c61 7465 5f62 795f 6561 7263  angulate_by_earc
-00000b80: 6c69 7070 696e 675f 3264 222c 0a20 2020  lipping_2d",.   
-00000b90: 2022 7669 676e 6574 7469 6e67 222c 0a20   "vignetting",. 
-00000ba0: 2020 2022 4475 7374 5f63 616c 635f 536f     "Dust_calc_So
-00000bb0: 6c69 6441 6e67 6c65 222c 0a20 2020 2022  lidAngle",.    "
-00000bc0: 636f 6d70 7574 655f 736f 6c69 645f 616e  compute_solid_an
-00000bd0: 676c 655f 6e6f 6170 6572 7475 7265 7322  gle_noapertures"
-00000be0: 2c0a 2020 2020 2263 6f6d 7075 7465 5f73  ,.    "compute_s
-00000bf0: 6f6c 6964 5f61 6e67 6c65 5f61 7065 7274  olid_angle_apert
-00000c00: 7572 6573 5f6c 6967 6874 222c 0a20 2020  ures_light",.   
-00000c10: 2022 636f 6d70 7574 655f 736f 6c69 645f   "compute_solid_
-00000c20: 616e 676c 655f 6170 6572 7475 7265 735f  angle_apertures_
-00000c30: 6c69 6768 745f 7375 6d6d 6564 222c 0a20  light_summed",. 
-00000c40: 2020 2022 636f 6d70 7574 655f 736f 6c69     "compute_soli
-00000c50: 645f 616e 676c 655f 6170 6572 7475 7265  d_angle_aperture
-00000c60: 735f 756e 6974 7665 6374 6f72 7322 2c0a  s_unitvectors",.
-00000c70: 5d0a 0a0a 2323 2323 2323 2323 2323 2323  ]...############
-00000c80: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000c90: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000ca0: 2323 2323 2323 2323 2323 2323 0a23 2323  ############.###
+00000400: 6c6c 6f63 2c20 6672 6565 0a23 2066 726f  lloc, free.# fro
+00000410: 6d20 6c69 6263 2e73 7464 696f 2063 696d  m libc.stdio cim
+00000420: 706f 7274 2070 7269 6e74 6620 2020 2320  port printf   # 
+00000430: 666f 7220 6465 6275 670a 0a23 202d 2d20  for debug..# -- 
+00000440: 6578 7472 6120 6c69 6272 6172 6965 7320  extra libraries 
+00000450: 696d 706f 7274 7320 2d2d 2d2d 2d2d 2d2d  imports --------
+00000460: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00000470: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00000480: 2d2d 2d2d 2d2d 2d2d 2d2d 0a69 6d70 6f72  ----------.impor
+00000490: 7420 506f 6c79 676f 6e20 6173 2070 6c67  t Polygon as plg
+000004a0: 0a0a 0a23 202d 2d20 546f 4675 206c 6962  ...# -- ToFu lib
+000004b0: 7261 7279 2069 6d70 6f72 7473 202d 2d2d  rary imports ---
+000004c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000004d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000004e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000004f0: 2d2d 2d0a 6672 6f6d 202e 5f62 6173 6963  ---.from ._basic
+00000500: 5f67 656f 6d5f 746f 6f6c 7320 6369 6d70  _geom_tools cimp
+00000510: 6f72 7420 5f56 534d 414c 4c2c 205f 534d  ort _VSMALL, _SM
+00000520: 414c 4c0a 6672 6f6d 202e 5f62 6173 6963  ALL.from ._basic
+00000530: 5f67 656f 6d5f 746f 6f6c 7320 6369 6d70  _geom_tools cimp
+00000540: 6f72 7420 5f54 574f 5049 0a66 726f 6d20  ort _TWOPI.from 
+00000550: 2e20 6369 6d70 6f72 7420 5f62 6173 6963  . cimport _basic
+00000560: 5f67 656f 6d5f 746f 6f6c 7320 6173 205f  _geom_tools as _
+00000570: 6267 740a 6672 6f6d 202e 2063 696d 706f  bgt.from . cimpo
+00000580: 7274 205f 7261 7974 7261 6369 6e67 5f74  rt _raytracing_t
+00000590: 6f6f 6c73 2061 7320 5f72 740a 6672 6f6d  ools as _rt.from
+000005a0: 202e 2063 696d 706f 7274 205f 6469 7374   . cimport _dist
+000005b0: 616e 6365 5f74 6f6f 6c73 2061 7320 5f64  ance_tools as _d
+000005c0: 740a 6672 6f6d 202e 2063 696d 706f 7274  t.from . cimport
+000005d0: 205f 7361 6d70 6c69 6e67 5f74 6f6f 6c73   _sampling_tools
+000005e0: 2061 7320 5f73 740a 6672 6f6d 202e 2063   as _st.from . c
+000005f0: 696d 706f 7274 205f 7669 676e 6574 7469  import _vignetti
+00000600: 6e67 5f74 6f6f 6c73 2061 7320 5f76 740a  ng_tools as _vt.
+00000610: 6672 6f6d 202e 2069 6d70 6f72 7420 5f6f  from . import _o
+00000620: 7065 6e6d 705f 746f 6f6c 7320 6173 205f  penmp_tools as _
+00000630: 6f6d 7074 0a0a 0a23 203d 3d20 4578 706f  ompt...# == Expo
+00000640: 7274 7320 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  rts ============
+00000650: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00000660: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00000670: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00000680: 3d3d 3d3d 3d3d 3d0a 0a5f 5f61 6c6c 5f5f  =======..__all__
+00000690: 203d 205b 0a20 2020 2027 636f 6f72 645f   = [.    'coord_
+000006a0: 7368 6966 7427 2c0a 2020 2020 2263 6f6d  shift',.    "com
+000006b0: 705f 6469 7374 5f6c 6f73 5f63 6972 636c  p_dist_los_circl
+000006c0: 6522 2c0a 2020 2020 2263 6f6d 705f 6469  e",.    "comp_di
+000006d0: 7374 5f6c 6f73 5f63 6972 636c 655f 7665  st_los_circle_ve
+000006e0: 6322 2c0a 2020 2020 2263 6f6d 705f 6469  c",.    "comp_di
+000006f0: 7374 5f6c 6f73 5f76 706f 6c79 222c 0a20  st_los_vpoly",. 
+00000700: 2020 2022 636f 6d70 5f64 6973 745f 6c6f     "comp_dist_lo
+00000710: 735f 7670 6f6c 795f 7665 6322 2c0a 2020  s_vpoly_vec",.  
+00000720: 2020 2269 735f 636c 6f73 655f 6c6f 735f    "is_close_los_
+00000730: 7670 6f6c 795f 7665 6322 2c0a 2020 2020  vpoly_vec",.    
+00000740: 2269 735f 636c 6f73 655f 6c6f 735f 6369  "is_close_los_ci
+00000750: 7263 6c65 222c 0a20 2020 2022 6973 5f63  rcle",.    "is_c
+00000760: 6c6f 7365 5f6c 6f73 5f63 6972 636c 655f  lose_los_circle_
+00000770: 7665 6322 2c0a 2020 2020 2277 6869 6368  vec",.    "which
+00000780: 5f6c 6f73 5f63 6c6f 7365 725f 7670 6f6c  _los_closer_vpol
+00000790: 795f 7665 6322 2c0a 2020 2020 2277 6869  y_vec",.    "whi
+000007a0: 6368 5f76 706f 6c79 5f63 6c6f 7365 725f  ch_vpoly_closer_
+000007b0: 6c6f 735f 7665 6322 2c0a 2020 2020 224c  los_vec",.    "L
+000007c0: 4f53 5f73 696e 6f5f 6669 6e64 526f 6f74  OS_sino_findRoot
+000007d0: 6b50 4d69 6e5f 546f 7222 2c0a 2020 2020  kPMin_Tor",.    
+000007e0: 2750 6f6c 795f 6973 436c 6f63 6b77 6973  'Poly_isClockwis
+000007f0: 6527 2c20 2750 6f6c 795f 566f 6c41 6e67  e', 'Poly_VolAng
+00000800: 546f 7227 2c0a 2020 2020 2770 6f6c 795f  Tor',.    'poly_
+00000810: 6172 6561 272c 2022 706f 6c79 5f61 7265  area', "poly_are
+00000820: 615f 616e 645f 6261 7279 6365 6e74 6572  a_and_barycenter
+00000830: 222c 0a20 2020 2027 5369 6e6f 5f49 6d70  ",.    'Sino_Imp
+00000840: 6163 7445 6e76 272c 2027 436f 6e76 6572  actEnv', 'Conver
+00000850: 7449 6d70 6163 745f 5468 6574 6132 5869  tImpact_Theta2Xi
+00000860: 272c 0a20 2020 2027 5f56 6573 5f69 7349  ',.    '_Ves_isI
+00000870: 6e73 6964 6527 2c0a 2020 2020 2764 6973  nside',.    'dis
+00000880: 6372 6574 697a 655f 6c69 6e65 3164 272c  cretize_line1d',
+00000890: 0a20 2020 2027 6469 7363 7265 7469 7a65  .    'discretize
+000008a0: 5f73 6567 6d65 6e74 3264 272c 2027 5f56  _segment2d', '_V
+000008b0: 6573 5f6d 6573 6843 726f 7373 5f46 726f  es_meshCross_Fro
+000008c0: 6d49 6e64 272c 0a20 2020 2027 6469 7363  mInd',.    'disc
+000008d0: 7265 7469 7a65 5f76 706f 6c79 272c 0a20  retize_vpoly',. 
+000008e0: 2020 2027 5f56 6573 5f56 6d65 7368 5f54     '_Ves_Vmesh_T
+000008f0: 6f72 5f53 7562 4672 6f6d 445f 6379 7468  or_SubFromD_cyth
+00000900: 6f6e 272c 0a20 2020 2027 5f56 6573 5f56  on',.    '_Ves_V
+00000910: 6d65 7368 5f54 6f72 5f53 7562 4672 6f6d  mesh_Tor_SubFrom
+00000920: 496e 645f 6379 7468 6f6e 272c 0a20 2020  Ind_cython',.   
+00000930: 2027 5f56 6573 5f56 6d65 7368 5f54 6f72   '_Ves_Vmesh_Tor
+00000940: 5f53 7562 4672 6f6d 445f 6379 7468 6f6e  _SubFromD_cython
+00000950: 5f6f 6c64 272c 0a20 2020 2027 5f56 6573  _old',.    '_Ves
+00000960: 5f56 6d65 7368 5f54 6f72 5f53 7562 4672  _Vmesh_Tor_SubFr
+00000970: 6f6d 496e 645f 6379 7468 6f6e 5f6f 6c64  omInd_cython_old
+00000980: 272c 0a20 2020 2027 5f56 6573 5f56 6d65  ',.    '_Ves_Vme
+00000990: 7368 5f4c 696e 5f53 7562 4672 6f6d 445f  sh_Lin_SubFromD_
+000009a0: 6379 7468 6f6e 272c 2027 5f56 6573 5f56  cython', '_Ves_V
+000009b0: 6d65 7368 5f4c 696e 5f53 7562 4672 6f6d  mesh_Lin_SubFrom
+000009c0: 496e 645f 6379 7468 6f6e 272c 0a20 2020  Ind_cython',.   
+000009d0: 2027 5f56 6573 5f53 6d65 7368 5f54 6f72   '_Ves_Smesh_Tor
+000009e0: 5f53 7562 4672 6f6d 445f 6379 7468 6f6e  _SubFromD_cython
+000009f0: 272c 2027 5f56 6573 5f53 6d65 7368 5f54  ', '_Ves_Smesh_T
+00000a00: 6f72 5f53 7562 4672 6f6d 496e 645f 6379  or_SubFromInd_cy
+00000a10: 7468 6f6e 272c 0a20 2020 2027 5f56 6573  thon',.    '_Ves
+00000a20: 5f53 6d65 7368 5f54 6f72 5374 7275 6374  _Smesh_TorStruct
+00000a30: 5f53 7562 4672 6f6d 445f 6379 7468 6f6e  _SubFromD_cython
+00000a40: 272c 0a20 2020 2027 5f56 6573 5f53 6d65  ',.    '_Ves_Sme
+00000a50: 7368 5f54 6f72 5374 7275 6374 5f53 7562  sh_TorStruct_Sub
+00000a60: 4672 6f6d 496e 645f 6379 7468 6f6e 272c  FromInd_cython',
+00000a70: 0a20 2020 2027 5f56 6573 5f53 6d65 7368  .    '_Ves_Smesh
+00000a80: 5f4c 696e 5f53 7562 4672 6f6d 445f 6379  _Lin_SubFromD_cy
+00000a90: 7468 6f6e 272c 0a20 2020 2027 5f56 6573  thon',.    '_Ves
+00000aa0: 5f53 6d65 7368 5f4c 696e 5f53 7562 4672  _Smesh_Lin_SubFr
+00000ab0: 6f6d 496e 645f 6379 7468 6f6e 272c 0a20  omInd_cython',. 
+00000ac0: 2020 2027 4c4f 535f 4361 6c63 5f50 496e     'LOS_Calc_PIn
+00000ad0: 4f75 745f 5665 7353 7472 7563 7427 2c0a  Out_VesStruct',.
+00000ae0: 2020 2020 224c 4f53 5f43 616c 635f 6b4d      "LOS_Calc_kM
+00000af0: 696e 6b4d 6178 5f56 6573 5374 7275 6374  inkMax_VesStruct
+00000b00: 222c 0a20 2020 2022 4c4f 535f 6973 5669  ",.    "LOS_isVi
+00000b10: 735f 5074 4672 6f6d 5074 735f 5665 7353  s_PtFromPts_VesS
+00000b20: 7472 7563 7422 2c0a 2020 2020 224c 4f53  truct",.    "LOS
+00000b30: 5f61 7265 5669 735f 5074 7346 726f 6d50  _areVis_PtsFromP
+00000b40: 7473 5f56 6573 5374 7275 6374 222c 0a20  ts_VesStruct",. 
+00000b50: 2020 2027 4c4f 535f 6765 745f 7361 6d70     'LOS_get_samp
+00000b60: 6c65 272c 2027 4c4f 535f 6361 6c63 5f73  le', 'LOS_calc_s
+00000b70: 6967 6e61 6c27 2c0a 2020 2020 274c 4f53  ignal',.    'LOS
+00000b80: 5f73 696e 6f27 2c20 2769 6e74 6567 7261  _sino', 'integra
+00000b90: 7465 3164 272c 0a20 2020 2022 7472 6961  te1d',.    "tria
+00000ba0: 6e67 756c 6174 655f 6279 5f65 6172 636c  ngulate_by_earcl
+00000bb0: 6970 7069 6e67 5f32 6422 2c0a 2020 2020  ipping_2d",.    
+00000bc0: 2276 6967 6e65 7474 696e 6722 2c0a 2020  "vignetting",.  
+00000bd0: 2020 2244 7573 745f 6361 6c63 5f53 6f6c    "Dust_calc_Sol
+00000be0: 6964 416e 676c 6522 2c0a 2020 2020 2263  idAngle",.    "c
+00000bf0: 6f6d 7075 7465 5f73 6f6c 6964 5f61 6e67  ompute_solid_ang
+00000c00: 6c65 5f6e 6f61 7065 7274 7572 6573 222c  le_noapertures",
+00000c10: 0a20 2020 2022 636f 6d70 7574 655f 736f  .    "compute_so
+00000c20: 6c69 645f 616e 676c 655f 6170 6572 7475  lid_angle_apertu
+00000c30: 7265 735f 6c69 6768 7422 2c0a 2020 2020  res_light",.    
+00000c40: 2263 6f6d 7075 7465 5f73 6f6c 6964 5f61  "compute_solid_a
+00000c50: 6e67 6c65 5f61 7065 7274 7572 6573 5f6c  ngle_apertures_l
+00000c60: 6967 6874 5f73 756d 6d65 6422 2c0a 2020  ight_summed",.  
+00000c70: 2020 2263 6f6d 7075 7465 5f73 6f6c 6964    "compute_solid
+00000c80: 5f61 6e67 6c65 5f61 7065 7274 7572 6573  _angle_apertures
+00000c90: 5f75 6e69 7476 6563 746f 7273 222c 0a5d  _unitvectors",.]
+00000ca0: 0a0a 0a23 2323 2323 2323 2323 2323 2323  ...#############
 00000cb0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00000cc0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000cd0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000ce0: 2323 2323 230a 2320 2020 2020 2020 436f  #####.#       Co
-00000cf0: 6f72 6469 6e61 7465 7320 6861 6e64 6c69  ordinates handli
-00000d00: 6e67 0a23 2323 2323 2323 2323 2323 2323  ng.#############
-00000d10: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000d20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000d30: 2323 2323 2323 2323 2323 230a 0a0a 6465  ###########...de
-00000d40: 6620 636f 6f72 645f 7368 6966 7428 706f  f coord_shift(po
-00000d50: 696e 7473 2c20 696e 5f66 6f72 6d61 743d  ints, in_format=
-00000d60: 2728 582c 592c 5a29 272c 0a20 2020 2020  '(X,Y,Z)',.     
-00000d70: 2020 2020 2020 2020 2020 206f 7574 5f66             out_f
-00000d80: 6f72 6d61 743d 2728 522c 5a29 272c 0a20  ormat='(R,Z)',. 
-00000d90: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00000da0: 726f 7373 5f66 6f72 6d61 743d 4e6f 6e65  ross_format=None
-00000db0: 293a 0a20 2020 2022 2222 2043 6865 636b  ):.    """ Check
-00000dc0: 2074 6865 2073 6861 7065 206f 6620 616e   the shape of an
-00000dd0: 2061 7272 6179 206f 6620 706f 696e 7473   array of points
-00000de0: 2063 6f6f 7264 696e 6174 6573 2061 6e64   coordinates and
-00000df0: 2f6f 7220 636f 6e76 6572 7473 2066 726f  /or converts fro
-00000e00: 6d0a 2020 2020 3244 2074 6f20 3344 2c20  m.    2D to 3D, 
-00000e10: 3344 2074 6f20 3244 2c20 6379 6c69 6e64  3D to 2D, cylind
-00000e20: 7269 6361 6c20 746f 2063 6172 7465 7369  rical to cartesi
-00000e30: 616e 2e2e 2e0a 2020 2020 2843 726f 7373  an....    (Cross
-00000e40: 5265 6620 6973 2061 6e20 616e 676c 6520  Ref is an angle 
-00000e50: 2854 6f72 2920 6f72 2061 2064 6973 7461  (Tor) or a dista
-00000e60: 6e63 6520 2858 2066 6f72 204c 696e 2929  nce (X for Lin))
-00000e70: 0a20 2020 2022 2222 0a20 2020 2063 6465  .    """.    cde
-00000e80: 6620 7374 7220 7374 725f 6969 0a20 2020  f str str_ii.   
-00000e90: 2063 6465 6620 6c6f 6e67 206e 636f 6f72   cdef long ncoor
-00000ea0: 6473 203d 2070 6f69 6e74 732e 7368 6170  ds = points.shap
-00000eb0: 655b 305d 0a20 2020 2063 6465 6620 6c6f  e[0].    cdef lo
-00000ec0: 6e67 206e 7074 730a 2020 2020 6173 7365  ng npts.    asse
-00000ed0: 7274 2061 6c6c 285b 7479 7065 2866 6629  rt all([type(ff)
-00000ee0: 2069 7320 7374 7220 616e 6420 272c 2720   is str and ',' 
-00000ef0: 696e 2066 660a 2020 2020 2020 2020 2020  in ff.          
-00000f00: 2020 2020 2020 666f 7220 6666 2069 6e20        for ff in 
-00000f10: 5b69 6e5f 666f 726d 6174 2c20 6f75 745f  [in_format, out_
-00000f20: 666f 726d 6174 5d5d 292c 2028 0a20 2020  format]]), (.   
-00000f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000f40: 2020 2020 2022 4172 6720 496e 2061 6e64       "Arg In and
-00000f50: 204f 7574 2028 636f 6f72 6469 6e61 7465   Out (coordinate
-00000f60: 2066 6f72 6d61 7429 2022 0a20 2020 2020   format) ".     
-00000f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000f80: 2020 202b 2022 6d75 7374 2062 6520 636f     + "must be co
-00000f90: 6d6d 612d 7365 7061 7261 7465 6420 2021  mma-separated  !
-00000fa0: 2229 0a20 2020 2061 7373 6572 7420 7479  ").    assert ty
-00000fb0: 7065 2870 6f69 6e74 7329 2069 7320 6e70  pe(points) is np
-00000fc0: 2e6e 6461 7272 6179 2c20 2250 6f69 6e74  .ndarray, "Point
-00000fd0: 7320 6d75 7374 2062 6520 6120 6e70 2e6e  s must be a np.n
-00000fe0: 6461 7272 6179 2022 0a20 2020 2061 7373  darray ".    ass
-00000ff0: 6572 7420 706f 696e 7473 2e6e 6469 6d20  ert points.ndim 
-00001000: 696e 205b 312c 2032 5d2c 2022 506f 696e  in [1, 2], "Poin
-00001010: 7473 206d 7573 7420 6265 2061 2031 4420  ts must be a 1D 
-00001020: 6f72 2032 4420 6e70 2e6e 6461 7272 6179  or 2D np.ndarray
-00001030: 220a 2020 2020 6173 7365 7274 206e 636f  ".    assert nco
-00001040: 6f72 6473 2069 6e20 2832 2c33 292c 2028  ords in (2,3), (
-00001050: 2250 6f69 6e74 7320 6d75 7374 2062 6520  "Points must be 
-00001060: 6120 3144 206f 7220 3244 206e 702e 6e64  a 1D or 2D np.nd
-00001070: 6172 7261 7920 220a 2020 2020 2020 2020  array ".        
-00001080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001090: 2020 2020 2020 226f 6620 3220 6f72 2033        "of 2 or 3
-000010a0: 2063 6f6f 7264 696e 6174 6573 2021 2229   coordinates !")
-000010b0: 0a20 2020 206f 6b5f 7479 7065 7320 3d20  .    ok_types = 
-000010c0: 5b69 6e74 2c66 6c6f 6174 2c6e 702e 696e  [int,float,np.in
-000010d0: 7436 342c 6e70 2e66 6c6f 6174 3634 5d0a  t64,np.float64].
-000010e0: 2020 2020 6173 7365 7274 2063 726f 7373      assert cross
-000010f0: 5f66 6f72 6d61 7420 6973 204e 6f6e 6520  _format is None 
-00001100: 6f72 2074 7970 6528 6372 6f73 735f 666f  or type(cross_fo
-00001110: 726d 6174 2920 696e 206f 6b5f 7479 7065  rmat) in ok_type
-00001120: 732c 2028 0a20 2020 2020 2020 2022 4172  s, (.        "Ar
-00001130: 6720 4372 6f73 7352 6566 206d 7573 7420  g CrossRef must 
-00001140: 6265 2061 2066 6c6f 6174 2021 2229 0a0a  be a float !")..
-00001150: 2020 2020 2320 5072 652d 666f 726d 6174      # Pre-format
-00001160: 2069 6e70 7574 730a 2020 2020 696e 5f66   inputs.    in_f
-00001170: 6f72 6d61 742c 206f 7574 5f66 6f72 6d61  ormat, out_forma
-00001180: 7420 3d20 696e 5f66 6f72 6d61 742e 6c6f  t = in_format.lo
-00001190: 7765 7228 292c 206f 7574 5f66 6f72 6d61  wer(), out_forma
-000011a0: 742e 6c6f 7765 7228 290a 0a20 2020 2023  t.lower()..    #
-000011b0: 2047 6574 206f 7264 6572 0a20 2020 2069   Get order.    i
-000011c0: 6e73 203d 2069 6e5f 666f 726d 6174 2e72  ns = in_format.r
-000011d0: 6570 6c61 6365 2827 2827 2c20 2727 292e  eplace('(', '').
-000011e0: 7265 706c 6163 6528 2729 272c 2027 2729  replace(')', '')
-000011f0: 2e73 706c 6974 2827 2c27 290a 2020 2020  .split(',').    
-00001200: 6f75 7473 203d 206f 7574 5f66 6f72 6d61  outs = out_forma
-00001210: 742e 7265 706c 6163 6528 2728 272c 2027  t.replace('(', '
-00001220: 2729 2e72 6570 6c61 6365 2827 2927 2c20  ').replace(')', 
-00001230: 2727 292e 7370 6c69 7428 272c 2729 0a0a  '').split(',')..
-00001240: 2020 2020 6173 7365 7274 2061 6c6c 285b      assert all([
-00001250: 7373 2069 6e20 5b27 7827 2c27 7927 2c27  ss in ['x','y','
-00001260: 7a27 2c27 7227 2c27 7068 6927 5d20 666f  z','r','phi'] fo
-00001270: 7220 7373 2069 6e20 696e 735d 292c 2022  r ss in ins]), "
-00001280: 4e6f 6e2d 7661 6c69 6420 496e 2122 0a20  Non-valid In!". 
-00001290: 2020 2061 7373 6572 7420 616c 6c28 5b73     assert all([s
-000012a0: 7320 696e 205b 2778 272c 2779 272c 277a  s in ['x','y','z
-000012b0: 272c 2772 272c 2770 6869 275d 2066 6f72  ','r','phi'] for
-000012c0: 2073 7320 696e 206f 7574 735d 292c 2022   ss in outs]), "
-000012d0: 4e6f 6e2d 7661 6c69 6420 4f75 7421 220a  Non-valid Out!".
-000012e0: 2020 2020 696e 5f74 7970 6520 3d20 2763      in_type = 'c
-000012f0: 796c 2720 6966 2061 6e79 285b 7373 2069  yl' if any([ss i
-00001300: 6e20 696e 7320 666f 7220 7373 2069 6e20  n ins for ss in 
-00001310: 5b27 7227 2c27 7068 6927 5d5d 2920 656c  ['r','phi']]) el
-00001320: 7365 2027 6361 7274 270a 2020 2020 6f75  se 'cart'.    ou
-00001330: 745f 7479 7065 203d 2027 6379 6c27 2069  t_type = 'cyl' i
-00001340: 6620 616e 7928 5b73 7320 696e 206f 7574  f any([ss in out
-00001350: 7320 666f 7220 7373 2069 6e20 5b27 7227  s for ss in ['r'
-00001360: 2c27 7068 6927 5d5d 2920 656c 7365 2027  ,'phi']]) else '
-00001370: 6361 7274 270a 0a20 2020 206e 6469 6d20  cart'..    ndim 
-00001380: 3d20 706f 696e 7473 2e6e 6469 6d0a 2020  = points.ndim.  
-00001390: 2020 6966 206e 6469 6d3d 3d31 3a0a 2020    if ndim==1:.  
-000013a0: 2020 2020 2020 706f 696e 7473 203d 206e        points = n
-000013b0: 702e 636f 7079 2870 6f69 6e74 732e 7265  p.copy(points.re
-000013c0: 7368 6170 6528 286e 636f 6f72 6473 2c20  shape((ncoords, 
-000013d0: 3129 2929 0a0a 2020 2020 2320 436f 6d70  1)))..    # Comp
-000013e0: 7574 650a 2020 2020 6966 2069 6e5f 7479  ute.    if in_ty
-000013f0: 7065 3d3d 6f75 745f 7479 7065 3a0a 2020  pe==out_type:.  
-00001400: 2020 2020 2020 6173 7365 7274 2061 6c6c        assert all
-00001410: 285b 7373 2069 6e20 696e 7320 666f 7220  ([ss in ins for 
-00001420: 7373 2069 6e20 6f75 7473 5d29 0a20 2020  ss in outs]).   
-00001430: 2020 2020 2070 7473 203d 205b 5d0a 2020       pts = [].  
-00001440: 2020 2020 2020 666f 7220 7374 725f 6969        for str_ii
-00001450: 2069 6e20 6f75 7473 3a0a 2020 2020 2020   in outs:.      
-00001460: 2020 2020 2020 6966 2073 7472 5f69 693d        if str_ii=
-00001470: 3d27 7068 6927 3a0a 2020 2020 2020 2020  ='phi':.        
-00001480: 2020 2020 2020 2020 7074 732e 6170 7065          pts.appe
-00001490: 6e64 286e 702e 6172 6374 616e 3228 6e70  nd(np.arctan2(np
-000014a0: 2e73 696e 2870 6f69 6e74 735b 696e 732e  .sin(points[ins.
-000014b0: 696e 6465 7828 7374 725f 6969 292c 203a  index(str_ii), :
-000014c0: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
-000014d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000014e0: 2020 2020 2020 2020 2020 6e70 2e63 6f73            np.cos
-000014f0: 2870 6f69 6e74 735b 696e 732e 696e 6465  (points[ins.inde
-00001500: 7828 7374 725f 6969 292c 203a 5d29 2929  x(str_ii), :])))
-00001510: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00001520: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00001530: 2020 2070 7473 2e61 7070 656e 6428 706f     pts.append(po
-00001540: 696e 7473 5b69 6e73 2e69 6e64 6578 2873  ints[ins.index(s
-00001550: 7472 5f69 6929 2c20 3a5d 290a 2020 2020  tr_ii), :]).    
-00001560: 656c 6966 2069 6e5f 7479 7065 3d3d 2763  elif in_type=='c
-00001570: 6172 7427 3a0a 2020 2020 2020 2020 7074  art':.        pt
-00001580: 7320 3d20 5b5d 0a20 2020 2020 2020 2066  s = [].        f
-00001590: 6f72 2073 7472 5f69 6920 696e 206f 7574  or str_ii in out
-000015a0: 733a 0a20 2020 2020 2020 2020 2020 2069  s:.            i
-000015b0: 6620 7374 725f 6969 3d3d 2772 273a 0a20  f str_ii=='r':. 
-000015c0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-000015d0: 7373 6572 7420 616c 6c28 5b73 7320 696e  ssert all([ss in
-000015e0: 2069 6e73 2066 6f72 2073 7320 696e 205b   ins for ss in [
-000015f0: 2778 272c 2779 275d 5d29 0a20 2020 2020  'x','y']]).     
-00001600: 2020 2020 2020 2020 2020 2070 7473 2e61             pts.a
-00001610: 7070 656e 6428 5f62 6774 2e63 6f6d 7075  ppend(_bgt.compu
-00001620: 7465 5f68 7970 6f74 2870 6f69 6e74 735b  te_hypot(points[
-00001630: 696e 732e 696e 6465 7828 2778 2729 2c20  ins.index('x'), 
-00001640: 3a5d 2c0a 2020 2020 2020 2020 2020 2020  :],.            
-00001650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001670: 2020 706f 696e 7473 5b69 6e73 2e69 6e64    points[ins.ind
-00001680: 6578 2827 7927 292c 203a 5d29 290a 2020  ex('y'), :])).  
-00001690: 2020 2020 2020 2020 2020 656c 6966 2073            elif s
-000016a0: 7472 5f69 693d 3d27 7a27 3a0a 2020 2020  tr_ii=='z':.    
-000016b0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-000016c0: 7274 2027 7a27 2069 6e20 696e 730a 2020  rt 'z' in ins.  
-000016d0: 2020 2020 2020 2020 2020 2020 2020 7074                pt
-000016e0: 732e 6170 7065 6e64 2870 6f69 6e74 735b  s.append(points[
-000016f0: 696e 732e 696e 6465 7828 277a 2729 2c20  ins.index('z'), 
-00001700: 3a5d 290a 2020 2020 2020 2020 2020 2020  :]).            
-00001710: 656c 6966 2073 7472 5f69 693d 3d27 7068  elif str_ii=='ph
-00001720: 6927 3a0a 2020 2020 2020 2020 2020 2020  i':.            
-00001730: 2020 2020 6966 2061 6c6c 285b 7373 2069      if all([ss i
-00001740: 6e20 696e 7320 666f 7220 7373 2069 6e20  n ins for ss in 
-00001750: 5b27 7827 2c27 7927 5d5d 293a 0a20 2020  ['x','y']]):.   
-00001760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001770: 2070 7473 2e61 7070 656e 6428 6e70 2e61   pts.append(np.a
-00001780: 7263 7461 6e32 2870 6f69 6e74 735b 696e  rctan2(points[in
-00001790: 732e 696e 6465 7828 2779 2729 2c20 3a5d  s.index('y'), :]
-000017a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000017b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000017c0: 2020 2020 2020 2020 2020 2020 706f 696e              poin
-000017d0: 7473 5b69 6e73 2e69 6e64 6578 2827 7827  ts[ins.index('x'
-000017e0: 292c 203a 5d29 290a 2020 2020 2020 2020  ), :])).        
-000017f0: 2020 2020 2020 2020 656c 6966 2063 726f          elif cro
-00001800: 7373 5f66 6f72 6d61 7420 6973 206e 6f74  ss_format is not
-00001810: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00001820: 2020 2020 2020 2020 2020 206e 7074 7320             npts 
-00001830: 3d20 706f 696e 7473 2e73 6861 7065 5b31  = points.shape[1
-00001840: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00001850: 2020 2020 2020 7074 732e 6170 7065 6e64        pts.append
-00001860: 2863 726f 7373 5f66 6f72 6d61 7420 2a20  (cross_format * 
-00001870: 6e70 2e6f 6e65 7328 286e 7074 732c 2929  np.ones((npts,))
-00001880: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00001890: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000018a0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-000018b0: 6520 4578 6365 7074 696f 6e28 2254 6865  e Exception("The
-000018c0: 7265 2069 7320 6e6f 2070 6869 2076 616c  re is no phi val
-000018d0: 7565 2061 7661 696c 6162 6c65 2021 2229  ue available !")
-000018e0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-000018f0: 2020 2070 7473 203d 205b 5d0a 2020 2020     pts = [].    
-00001900: 2020 2020 666f 7220 7374 725f 6969 2069      for str_ii i
-00001910: 6e20 6f75 7473 3a0a 2020 2020 2020 2020  n outs:.        
-00001920: 2020 2020 6966 2073 7472 5f69 693d 3d27      if str_ii=='
-00001930: 7827 3a0a 2020 2020 2020 2020 2020 2020  x':.            
-00001940: 2020 2020 6966 2061 6c6c 285b 7373 2069      if all([ss i
-00001950: 6e20 696e 7320 666f 7220 7373 2069 6e20  n ins for ss in 
-00001960: 5b27 7227 2c27 7068 6927 5d5d 2920 3a0a  ['r','phi']]) :.
-00001970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001980: 2020 2020 7074 732e 6170 7065 6e64 2870      pts.append(p
-00001990: 6f69 6e74 735b 696e 732e 696e 6465 7828  oints[ins.index(
-000019a0: 2772 2729 2c20 3a5d 202a 0a20 2020 2020  'r'), :] *.     
-000019b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000019c0: 2020 2020 2020 2020 2020 6e70 2e63 6f73            np.cos
-000019d0: 2870 6f69 6e74 735b 696e 732e 696e 6465  (points[ins.inde
-000019e0: 7828 2770 6869 2729 2c20 3a5d 2929 0a20  x('phi'), :])). 
-000019f0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00001a00: 6c69 6620 6372 6f73 735f 666f 726d 6174  lif cross_format
-00001a10: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-00001a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001a30: 2020 6e70 7473 203d 2070 6f69 6e74 732e    npts = points.
-00001a40: 7368 6170 655b 315d 0a20 2020 2020 2020  shape[1].       
-00001a50: 2020 2020 2020 2020 2020 2020 2070 7473               pts
-00001a60: 2e61 7070 656e 6428 6372 6f73 735f 666f  .append(cross_fo
-00001a70: 726d 6174 202a 206e 702e 6f6e 6573 2828  rmat * np.ones((
-00001a80: 6e70 7473 2c29 2929 0a20 2020 2020 2020  npts,))).       
-00001a90: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00001aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001ab0: 2020 2072 6169 7365 2045 7863 6570 7469     raise Excepti
-00001ac0: 6f6e 2822 5468 6572 6520 6973 206e 6f20  on("There is no 
-00001ad0: 7820 7661 6c75 6520 6176 6169 6c61 626c  x value availabl
-00001ae0: 6520 2122 290a 2020 2020 2020 2020 2020  e !").          
-00001af0: 2020 656c 6966 2073 7472 5f69 693d 3d27    elif str_ii=='
-00001b00: 7927 3a0a 2020 2020 2020 2020 2020 2020  y':.            
-00001b10: 2020 2020 6173 7365 7274 2061 6c6c 285b      assert all([
-00001b20: 7373 2069 6e20 696e 7320 666f 7220 7373  ss in ins for ss
-00001b30: 2069 6e20 5b27 7227 2c27 7068 6927 5d5d   in ['r','phi']]
-00001b40: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00001b50: 2020 7074 732e 6170 7065 6e64 2870 6f69    pts.append(poi
-00001b60: 6e74 735b 696e 732e 696e 6465 7828 2772  nts[ins.index('r
-00001b70: 2729 2c20 3a5d 202a 0a20 2020 2020 2020  '), :] *.       
-00001b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001b90: 2020 2020 6e70 2e73 696e 2870 6f69 6e74      np.sin(point
-00001ba0: 735b 696e 732e 696e 6465 7828 2770 6869  s[ins.index('phi
-00001bb0: 2729 2c20 3a5d 2929 0a20 2020 2020 2020  '), :])).       
-00001bc0: 2020 2020 2065 6c69 6620 7374 725f 6969       elif str_ii
-00001bd0: 3d3d 277a 273a 0a20 2020 2020 2020 2020  =='z':.         
-00001be0: 2020 2020 2020 2061 7373 6572 7420 277a         assert 'z
-00001bf0: 2720 696e 2069 6e73 0a20 2020 2020 2020  ' in ins.       
-00001c00: 2020 2020 2020 2020 2070 7473 2e61 7070           pts.app
-00001c10: 656e 6428 706f 696e 7473 5b69 6e73 2e69  end(points[ins.i
-00001c20: 6e64 6578 2827 7a27 292c 203a 5d29 0a0a  ndex('z'), :])..
-00001c30: 2020 2020 2320 466f 726d 6174 206f 7574      # Format out
-00001c40: 7075 740a 2020 2020 7074 7320 3d20 6e70  put.    pts = np
-00001c50: 2e76 7374 6163 6b28 7074 7329 0a20 2020  .vstack(pts).   
-00001c60: 2069 6620 6e64 696d 3d3d 313a 0a20 2020   if ndim==1:.   
-00001c70: 2020 2020 2070 7473 203d 2070 7473 2e66       pts = pts.f
-00001c80: 6c61 7474 656e 2829 0a20 2020 2072 6574  latten().    ret
-00001c90: 7572 6e20 7074 730a 0a0a 2222 220a 2323  urn pts...""".##
-00001ca0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00001cb0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00001cc0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00001cd0: 2323 2323 2323 0a23 2323 2323 2323 2323  ######.#########
+00000cd0: 2323 2323 2323 2323 2323 230a 2323 2323  ###########.####
+00000ce0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00000cf0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00000d00: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00000d10: 2323 2323 0a23 2020 2020 2020 2043 6f6f  ####.#       Coo
+00000d20: 7264 696e 6174 6573 2068 616e 646c 696e  rdinates handlin
+00000d30: 670a 2323 2323 2323 2323 2323 2323 2323  g.##############
+00000d40: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00000d50: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00000d60: 2323 2323 2323 2323 2323 0a0a 0a64 6566  ##########...def
+00000d70: 2063 6f6f 7264 5f73 6869 6674 2870 6f69   coord_shift(poi
+00000d80: 6e74 732c 2069 6e5f 666f 726d 6174 3d27  nts, in_format='
+00000d90: 2858 2c59 2c5a 2927 2c0a 2020 2020 2020  (X,Y,Z)',.      
+00000da0: 2020 2020 2020 2020 2020 6f75 745f 666f            out_fo
+00000db0: 726d 6174 3d27 2852 2c5a 2927 2c0a 2020  rmat='(R,Z)',.  
+00000dc0: 2020 2020 2020 2020 2020 2020 2020 6372                cr
+00000dd0: 6f73 735f 666f 726d 6174 3d4e 6f6e 6529  oss_format=None)
+00000de0: 3a0a 2020 2020 2222 2220 4368 6563 6b20  :.    """ Check 
+00000df0: 7468 6520 7368 6170 6520 6f66 2061 6e20  the shape of an 
+00000e00: 6172 7261 7920 6f66 2070 6f69 6e74 7320  array of points 
+00000e10: 636f 6f72 6469 6e61 7465 7320 616e 642f  coordinates and/
+00000e20: 6f72 2063 6f6e 7665 7274 7320 6672 6f6d  or converts from
+00000e30: 0a20 2020 2032 4420 746f 2033 442c 2033  .    2D to 3D, 3
+00000e40: 4420 746f 2032 442c 2063 796c 696e 6472  D to 2D, cylindr
+00000e50: 6963 616c 2074 6f20 6361 7274 6573 6961  ical to cartesia
+00000e60: 6e2e 2e2e 0a20 2020 2028 4372 6f73 7352  n....    (CrossR
+00000e70: 6566 2069 7320 616e 2061 6e67 6c65 2028  ef is an angle (
+00000e80: 546f 7229 206f 7220 6120 6469 7374 616e  Tor) or a distan
+00000e90: 6365 2028 5820 666f 7220 4c69 6e29 290a  ce (X for Lin)).
+00000ea0: 2020 2020 2222 220a 2020 2020 6364 6566      """.    cdef
+00000eb0: 2073 7472 2073 7472 5f69 690a 2020 2020   str str_ii.    
+00000ec0: 6364 6566 206c 6f6e 6720 6e63 6f6f 7264  cdef long ncoord
+00000ed0: 7320 3d20 706f 696e 7473 2e73 6861 7065  s = points.shape
+00000ee0: 5b30 5d0a 2020 2020 6364 6566 206c 6f6e  [0].    cdef lon
+00000ef0: 6720 6e70 7473 0a20 2020 2061 7373 6572  g npts.    asser
+00000f00: 7420 616c 6c28 5b74 7970 6528 6666 2920  t all([type(ff) 
+00000f10: 6973 2073 7472 2061 6e64 2027 2c27 2069  is str and ',' i
+00000f20: 6e20 6666 0a20 2020 2020 2020 2020 2020  n ff.           
+00000f30: 2020 2020 2066 6f72 2066 6620 696e 205b       for ff in [
+00000f40: 696e 5f66 6f72 6d61 742c 206f 7574 5f66  in_format, out_f
+00000f50: 6f72 6d61 745d 5d29 2c20 280a 2020 2020  ormat]]), (.    
+00000f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000f70: 2020 2020 2241 7267 2049 6e20 616e 6420      "Arg In and 
+00000f80: 4f75 7420 2863 6f6f 7264 696e 6174 6520  Out (coordinate 
+00000f90: 666f 726d 6174 2920 220a 2020 2020 2020  format) ".      
+00000fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000fb0: 2020 2b20 226d 7573 7420 6265 2063 6f6d    + "must be com
+00000fc0: 6d61 2d73 6570 6172 6174 6564 2020 2122  ma-separated  !"
+00000fd0: 290a 2020 2020 6173 7365 7274 2074 7970  ).    assert typ
+00000fe0: 6528 706f 696e 7473 2920 6973 206e 702e  e(points) is np.
+00000ff0: 6e64 6172 7261 792c 2022 506f 696e 7473  ndarray, "Points
+00001000: 206d 7573 7420 6265 2061 206e 702e 6e64   must be a np.nd
+00001010: 6172 7261 7920 220a 2020 2020 6173 7365  array ".    asse
+00001020: 7274 2070 6f69 6e74 732e 6e64 696d 2069  rt points.ndim i
+00001030: 6e20 5b31 2c20 325d 2c20 2250 6f69 6e74  n [1, 2], "Point
+00001040: 7320 6d75 7374 2062 6520 6120 3144 206f  s must be a 1D o
+00001050: 7220 3244 206e 702e 6e64 6172 7261 7922  r 2D np.ndarray"
+00001060: 0a20 2020 2061 7373 6572 7420 6e63 6f6f  .    assert ncoo
+00001070: 7264 7320 696e 2028 322c 3329 2c20 2822  rds in (2,3), ("
+00001080: 506f 696e 7473 206d 7573 7420 6265 2061  Points must be a
+00001090: 2031 4420 6f72 2032 4420 6e70 2e6e 6461   1D or 2D np.nda
+000010a0: 7272 6179 2022 0a20 2020 2020 2020 2020  rray ".         
+000010b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000010c0: 2020 2020 2022 6f66 2032 206f 7220 3320       "of 2 or 3 
+000010d0: 636f 6f72 6469 6e61 7465 7320 2122 290a  coordinates !").
+000010e0: 2020 2020 6f6b 5f74 7970 6573 203d 205b      ok_types = [
+000010f0: 696e 742c 666c 6f61 742c 6e70 2e69 6e74  int,float,np.int
+00001100: 3634 2c6e 702e 666c 6f61 7436 345d 0a20  64,np.float64]. 
+00001110: 2020 2061 7373 6572 7420 6372 6f73 735f     assert cross_
+00001120: 666f 726d 6174 2069 7320 4e6f 6e65 206f  format is None o
+00001130: 7220 7479 7065 2863 726f 7373 5f66 6f72  r type(cross_for
+00001140: 6d61 7429 2069 6e20 6f6b 5f74 7970 6573  mat) in ok_types
+00001150: 2c20 280a 2020 2020 2020 2020 2241 7267  , (.        "Arg
+00001160: 2043 726f 7373 5265 6620 6d75 7374 2062   CrossRef must b
+00001170: 6520 6120 666c 6f61 7420 2122 290a 0a20  e a float !").. 
+00001180: 2020 2023 2050 7265 2d66 6f72 6d61 7420     # Pre-format 
+00001190: 696e 7075 7473 0a20 2020 2069 6e5f 666f  inputs.    in_fo
+000011a0: 726d 6174 2c20 6f75 745f 666f 726d 6174  rmat, out_format
+000011b0: 203d 2069 6e5f 666f 726d 6174 2e6c 6f77   = in_format.low
+000011c0: 6572 2829 2c20 6f75 745f 666f 726d 6174  er(), out_format
+000011d0: 2e6c 6f77 6572 2829 0a0a 2020 2020 2320  .lower()..    # 
+000011e0: 4765 7420 6f72 6465 720a 2020 2020 696e  Get order.    in
+000011f0: 7320 3d20 696e 5f66 6f72 6d61 742e 7265  s = in_format.re
+00001200: 706c 6163 6528 2728 272c 2027 2729 2e72  place('(', '').r
+00001210: 6570 6c61 6365 2827 2927 2c20 2727 292e  eplace(')', '').
+00001220: 7370 6c69 7428 272c 2729 0a20 2020 206f  split(',').    o
+00001230: 7574 7320 3d20 6f75 745f 666f 726d 6174  uts = out_format
+00001240: 2e72 6570 6c61 6365 2827 2827 2c20 2727  .replace('(', ''
+00001250: 292e 7265 706c 6163 6528 2729 272c 2027  ).replace(')', '
+00001260: 2729 2e73 706c 6974 2827 2c27 290a 0a20  ').split(',').. 
+00001270: 2020 2061 7373 6572 7420 616c 6c28 5b73     assert all([s
+00001280: 7320 696e 205b 2778 272c 2779 272c 277a  s in ['x','y','z
+00001290: 272c 2772 272c 2770 6869 275d 2066 6f72  ','r','phi'] for
+000012a0: 2073 7320 696e 2069 6e73 5d29 2c20 224e   ss in ins]), "N
+000012b0: 6f6e 2d76 616c 6964 2049 6e21 220a 2020  on-valid In!".  
+000012c0: 2020 6173 7365 7274 2061 6c6c 285b 7373    assert all([ss
+000012d0: 2069 6e20 5b27 7827 2c27 7927 2c27 7a27   in ['x','y','z'
+000012e0: 2c27 7227 2c27 7068 6927 5d20 666f 7220  ,'r','phi'] for 
+000012f0: 7373 2069 6e20 6f75 7473 5d29 2c20 224e  ss in outs]), "N
+00001300: 6f6e 2d76 616c 6964 204f 7574 2122 0a20  on-valid Out!". 
+00001310: 2020 2069 6e5f 7479 7065 203d 2027 6379     in_type = 'cy
+00001320: 6c27 2069 6620 616e 7928 5b73 7320 696e  l' if any([ss in
+00001330: 2069 6e73 2066 6f72 2073 7320 696e 205b   ins for ss in [
+00001340: 2772 272c 2770 6869 275d 5d29 2065 6c73  'r','phi']]) els
+00001350: 6520 2763 6172 7427 0a20 2020 206f 7574  e 'cart'.    out
+00001360: 5f74 7970 6520 3d20 2763 796c 2720 6966  _type = 'cyl' if
+00001370: 2061 6e79 285b 7373 2069 6e20 6f75 7473   any([ss in outs
+00001380: 2066 6f72 2073 7320 696e 205b 2772 272c   for ss in ['r',
+00001390: 2770 6869 275d 5d29 2065 6c73 6520 2763  'phi']]) else 'c
+000013a0: 6172 7427 0a0a 2020 2020 6e64 696d 203d  art'..    ndim =
+000013b0: 2070 6f69 6e74 732e 6e64 696d 0a20 2020   points.ndim.   
+000013c0: 2069 6620 6e64 696d 3d3d 313a 0a20 2020   if ndim==1:.   
+000013d0: 2020 2020 2070 6f69 6e74 7320 3d20 6e70       points = np
+000013e0: 2e63 6f70 7928 706f 696e 7473 2e72 6573  .copy(points.res
+000013f0: 6861 7065 2828 6e63 6f6f 7264 732c 2031  hape((ncoords, 1
+00001400: 2929 290a 0a20 2020 2023 2043 6f6d 7075  )))..    # Compu
+00001410: 7465 0a20 2020 2069 6620 696e 5f74 7970  te.    if in_typ
+00001420: 653d 3d6f 7574 5f74 7970 653a 0a20 2020  e==out_type:.   
+00001430: 2020 2020 2061 7373 6572 7420 616c 6c28       assert all(
+00001440: 5b73 7320 696e 2069 6e73 2066 6f72 2073  [ss in ins for s
+00001450: 7320 696e 206f 7574 735d 290a 2020 2020  s in outs]).    
+00001460: 2020 2020 7074 7320 3d20 5b5d 0a20 2020      pts = [].   
+00001470: 2020 2020 2066 6f72 2073 7472 5f69 6920       for str_ii 
+00001480: 696e 206f 7574 733a 0a20 2020 2020 2020  in outs:.       
+00001490: 2020 2020 2069 6620 7374 725f 6969 3d3d       if str_ii==
+000014a0: 2770 6869 273a 0a20 2020 2020 2020 2020  'phi':.         
+000014b0: 2020 2020 2020 2070 7473 2e61 7070 656e         pts.appen
+000014c0: 6428 6e70 2e61 7263 7461 6e32 286e 702e  d(np.arctan2(np.
+000014d0: 7369 6e28 706f 696e 7473 5b69 6e73 2e69  sin(points[ins.i
+000014e0: 6e64 6578 2873 7472 5f69 6929 2c20 3a5d  ndex(str_ii), :]
+000014f0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00001500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001510: 2020 2020 2020 2020 206e 702e 636f 7328           np.cos(
+00001520: 706f 696e 7473 5b69 6e73 2e69 6e64 6578  points[ins.index
+00001530: 2873 7472 5f69 6929 2c20 3a5d 2929 290a  (str_ii), :]))).
+00001540: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00001550: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00001560: 2020 7074 732e 6170 7065 6e64 2870 6f69    pts.append(poi
+00001570: 6e74 735b 696e 732e 696e 6465 7828 7374  nts[ins.index(st
+00001580: 725f 6969 292c 203a 5d29 0a20 2020 2065  r_ii), :]).    e
+00001590: 6c69 6620 696e 5f74 7970 653d 3d27 6361  lif in_type=='ca
+000015a0: 7274 273a 0a20 2020 2020 2020 2070 7473  rt':.        pts
+000015b0: 203d 205b 5d0a 2020 2020 2020 2020 666f   = [].        fo
+000015c0: 7220 7374 725f 6969 2069 6e20 6f75 7473  r str_ii in outs
+000015d0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+000015e0: 2073 7472 5f69 693d 3d27 7227 3a0a 2020   str_ii=='r':.  
+000015f0: 2020 2020 2020 2020 2020 2020 2020 6173                as
+00001600: 7365 7274 2061 6c6c 285b 7373 2069 6e20  sert all([ss in 
+00001610: 696e 7320 666f 7220 7373 2069 6e20 5b27  ins for ss in ['
+00001620: 7827 2c27 7927 5d5d 290a 2020 2020 2020  x','y']]).      
+00001630: 2020 2020 2020 2020 2020 7074 732e 6170            pts.ap
+00001640: 7065 6e64 285f 6267 742e 636f 6d70 7574  pend(_bgt.comput
+00001650: 655f 6879 706f 7428 706f 696e 7473 5b69  e_hypot(points[i
+00001660: 6e73 2e69 6e64 6578 2827 7827 292c 203a  ns.index('x'), :
+00001670: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00001680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000016a0: 2070 6f69 6e74 735b 696e 732e 696e 6465   points[ins.inde
+000016b0: 7828 2779 2729 2c20 3a5d 2929 0a20 2020  x('y'), :])).   
+000016c0: 2020 2020 2020 2020 2065 6c69 6620 7374           elif st
+000016d0: 725f 6969 3d3d 277a 273a 0a20 2020 2020  r_ii=='z':.     
+000016e0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+000016f0: 7420 277a 2720 696e 2069 6e73 0a20 2020  t 'z' in ins.   
+00001700: 2020 2020 2020 2020 2020 2020 2070 7473               pts
+00001710: 2e61 7070 656e 6428 706f 696e 7473 5b69  .append(points[i
+00001720: 6e73 2e69 6e64 6578 2827 7a27 292c 203a  ns.index('z'), :
+00001730: 5d29 0a20 2020 2020 2020 2020 2020 2065  ]).            e
+00001740: 6c69 6620 7374 725f 6969 3d3d 2770 6869  lif str_ii=='phi
+00001750: 273a 0a20 2020 2020 2020 2020 2020 2020  ':.             
+00001760: 2020 2069 6620 616c 6c28 5b73 7320 696e     if all([ss in
+00001770: 2069 6e73 2066 6f72 2073 7320 696e 205b   ins for ss in [
+00001780: 2778 272c 2779 275d 5d29 3a0a 2020 2020  'x','y']]):.    
+00001790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000017a0: 7074 732e 6170 7065 6e64 286e 702e 6172  pts.append(np.ar
+000017b0: 6374 616e 3228 706f 696e 7473 5b69 6e73  ctan2(points[ins
+000017c0: 2e69 6e64 6578 2827 7927 292c 203a 5d2c  .index('y'), :],
+000017d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000017e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000017f0: 2020 2020 2020 2020 2020 2070 6f69 6e74             point
+00001800: 735b 696e 732e 696e 6465 7828 2778 2729  s[ins.index('x')
+00001810: 2c20 3a5d 2929 0a20 2020 2020 2020 2020  , :])).         
+00001820: 2020 2020 2020 2065 6c69 6620 6372 6f73         elif cros
+00001830: 735f 666f 726d 6174 2069 7320 6e6f 7420  s_format is not 
+00001840: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00001850: 2020 2020 2020 2020 2020 6e70 7473 203d            npts =
+00001860: 2070 6f69 6e74 732e 7368 6170 655b 315d   points.shape[1]
+00001870: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00001880: 2020 2020 2070 7473 2e61 7070 656e 6428       pts.append(
+00001890: 6372 6f73 735f 666f 726d 6174 202a 206e  cross_format * n
+000018a0: 702e 6f6e 6573 2828 6e70 7473 2c29 2929  p.ones((npts,)))
+000018b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000018c0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000018d0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+000018e0: 2045 7863 6570 7469 6f6e 2822 5468 6572   Exception("Ther
+000018f0: 6520 6973 206e 6f20 7068 6920 7661 6c75  e is no phi valu
+00001900: 6520 6176 6169 6c61 626c 6520 2122 290a  e available !").
+00001910: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00001920: 2020 7074 7320 3d20 5b5d 0a20 2020 2020    pts = [].     
+00001930: 2020 2066 6f72 2073 7472 5f69 6920 696e     for str_ii in
+00001940: 206f 7574 733a 0a20 2020 2020 2020 2020   outs:.         
+00001950: 2020 2069 6620 7374 725f 6969 3d3d 2778     if str_ii=='x
+00001960: 273a 0a20 2020 2020 2020 2020 2020 2020  ':.             
+00001970: 2020 2069 6620 616c 6c28 5b73 7320 696e     if all([ss in
+00001980: 2069 6e73 2066 6f72 2073 7320 696e 205b   ins for ss in [
+00001990: 2772 272c 2770 6869 275d 5d29 203a 0a20  'r','phi']]) :. 
+000019a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000019b0: 2020 2070 7473 2e61 7070 656e 6428 706f     pts.append(po
+000019c0: 696e 7473 5b69 6e73 2e69 6e64 6578 2827  ints[ins.index('
+000019d0: 7227 292c 203a 5d20 2a0a 2020 2020 2020  r'), :] *.      
+000019e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000019f0: 2020 2020 2020 2020 206e 702e 636f 7328           np.cos(
+00001a00: 706f 696e 7473 5b69 6e73 2e69 6e64 6578  points[ins.index
+00001a10: 2827 7068 6927 292c 203a 5d29 290a 2020  ('phi'), :])).  
+00001a20: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00001a30: 6966 2063 726f 7373 5f66 6f72 6d61 7420  if cross_format 
+00001a40: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00001a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001a60: 206e 7074 7320 3d20 706f 696e 7473 2e73   npts = points.s
+00001a70: 6861 7065 5b31 5d0a 2020 2020 2020 2020  hape[1].        
+00001a80: 2020 2020 2020 2020 2020 2020 7074 732e              pts.
+00001a90: 6170 7065 6e64 2863 726f 7373 5f66 6f72  append(cross_for
+00001aa0: 6d61 7420 2a20 6e70 2e6f 6e65 7328 286e  mat * np.ones((n
+00001ab0: 7074 732c 2929 290a 2020 2020 2020 2020  pts,))).        
+00001ac0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00001ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001ae0: 2020 7261 6973 6520 4578 6365 7074 696f    raise Exceptio
+00001af0: 6e28 2254 6865 7265 2069 7320 6e6f 2078  n("There is no x
+00001b00: 2076 616c 7565 2061 7661 696c 6162 6c65   value available
+00001b10: 2021 2229 0a20 2020 2020 2020 2020 2020   !").           
+00001b20: 2065 6c69 6620 7374 725f 6969 3d3d 2779   elif str_ii=='y
+00001b30: 273a 0a20 2020 2020 2020 2020 2020 2020  ':.             
+00001b40: 2020 2061 7373 6572 7420 616c 6c28 5b73     assert all([s
+00001b50: 7320 696e 2069 6e73 2066 6f72 2073 7320  s in ins for ss 
+00001b60: 696e 205b 2772 272c 2770 6869 275d 5d29  in ['r','phi']])
+00001b70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00001b80: 2070 7473 2e61 7070 656e 6428 706f 696e   pts.append(poin
+00001b90: 7473 5b69 6e73 2e69 6e64 6578 2827 7227  ts[ins.index('r'
+00001ba0: 292c 203a 5d20 2a0a 2020 2020 2020 2020  ), :] *.        
+00001bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001bc0: 2020 206e 702e 7369 6e28 706f 696e 7473     np.sin(points
+00001bd0: 5b69 6e73 2e69 6e64 6578 2827 7068 6927  [ins.index('phi'
+00001be0: 292c 203a 5d29 290a 2020 2020 2020 2020  ), :])).        
+00001bf0: 2020 2020 656c 6966 2073 7472 5f69 693d      elif str_ii=
+00001c00: 3d27 7a27 3a0a 2020 2020 2020 2020 2020  ='z':.          
+00001c10: 2020 2020 2020 6173 7365 7274 2027 7a27        assert 'z'
+00001c20: 2069 6e20 696e 730a 2020 2020 2020 2020   in ins.        
+00001c30: 2020 2020 2020 2020 7074 732e 6170 7065          pts.appe
+00001c40: 6e64 2870 6f69 6e74 735b 696e 732e 696e  nd(points[ins.in
+00001c50: 6465 7828 277a 2729 2c20 3a5d 290a 0a20  dex('z'), :]).. 
+00001c60: 2020 2023 2046 6f72 6d61 7420 6f75 7470     # Format outp
+00001c70: 7574 0a20 2020 2070 7473 203d 206e 702e  ut.    pts = np.
+00001c80: 7673 7461 636b 2870 7473 290a 2020 2020  vstack(pts).    
+00001c90: 6966 206e 6469 6d3d 3d31 3a0a 2020 2020  if ndim==1:.    
+00001ca0: 2020 2020 7074 7320 3d20 7074 732e 666c      pts = pts.fl
+00001cb0: 6174 7465 6e28 290a 2020 2020 7265 7475  atten().    retu
+00001cc0: 726e 2070 7473 0a0a 0a22 2222 0a23 2323  rn pts...""".###
+00001cd0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00001ce0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00001cf0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00001d00: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
+00001d00: 2323 2323 230a 2323 2323 2323 2323 2323  #####.##########
 00001d10: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00001d20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00001d30: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00001d40: 2323 2323 2323 2323 0a23 2020 2020 2020  ########.#      
-00001d50: 2020 2020 2020 2020 2020 2020 4765 6e65              Gene
-00001d60: 7261 6c20 4765 6f6d 6574 7279 0a23 2323  ral Geometry.###
-00001d70: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00001d80: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00001d90: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00001da0: 2323 2323 230a 2323 2323 2323 2323 2323  #####.##########
+00001d30: 2323 2323 2323 2323 2323 2323 2323 0a23  ##############.#
+00001d40: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00001d50: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00001d60: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00001d70: 2323 2323 2323 230a 2320 2020 2020 2020  #######.#       
+00001d80: 2020 2020 2020 2020 2020 2047 656e 6572             Gener
+00001d90: 616c 2047 656f 6d65 7472 790a 2323 2323  al Geometry.####
+00001da0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00001db0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00001dc0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00001dd0: 2323 2323 2323 2323 2323 2323 2323 0a23  ##############.#
+00001dd0: 2323 2323 0a23 2323 2323 2323 2323 2323  ####.###########
 00001de0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00001df0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00001e00: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00001e10: 2323 2323 2323 230a 2222 220a 0a23 2323  #######."""..###
+00001e00: 2323 2323 2323 2323 2323 2323 230a 2323  #############.##
+00001e10: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00001e20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00001e30: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00001e40: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00001e50: 2323 2323 230a 2323 2323 2323 2323 2323  #####.##########
+00001e40: 2323 2323 2323 0a22 2222 0a0a 2323 2323  ######."""..####
+00001e50: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00001e60: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00001e70: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00001e80: 2323 2323 2323 2323 2323 2323 2323 0a23  ##############.#
-00001e90: 2020 2020 2020 2050 6f6c 7967 6f6e 730a         Polygons.
+00001e80: 2323 2323 0a23 2323 2323 2323 2323 2323  ####.###########
+00001e90: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00001ea0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00001eb0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00001ec0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00001ed0: 2323 2323 2323 2323 0a0a 0a63 6465 6620  ########...cdef 
-00001ee0: 5f63 6865 636b 5f70 6f6c 7967 6f6e 5f32  _check_polygon_2
-00001ef0: 645f 636f 756e 7465 725f 636c 6f63 6b77  d_counter_clockw
-00001f00: 6973 6528 0a20 2020 2070 6f6c 795f 7830  ise(.    poly_x0
-00001f10: 3d4e 6f6e 652c 0a20 2020 2070 6f6c 795f  =None,.    poly_
-00001f20: 7831 3d4e 6f6e 652c 0a29 3a0a 2020 2020  x1=None,.):.    
-00001f30: 2222 2220 4173 7375 6d65 7320 6e6f 6e2d  """ Assumes non-
-00001f40: 636c 6f73 6564 2070 6f6c 7967 6f6e 2022  closed polygon "
-00001f50: 2222 0a0a 2020 2020 6930 203d 206e 702e  ""..    i0 = np.
-00001f60: 6172 616e 6765 2830 2c20 706f 6c79 5f78  arange(0, poly_x
-00001f70: 302e 7369 7a65 290a 2020 2020 6931 203d  0.size).    i1 =
-00001f80: 206e 702e 725f 5b6e 702e 6172 616e 6765   np.r_[np.arange
-00001f90: 2831 2c20 706f 6c79 5f78 302e 7369 7a65  (1, poly_x0.size
-00001fa0: 292c 2030 5d0a 2020 2020 7265 7475 726e  ), 0].    return
-00001fb0: 206e 702e 7375 6d28 2870 6f6c 795f 7830   np.sum((poly_x0
-00001fc0: 5b69 315d 202d 2070 6f6c 795f 7830 5b69  [i1] - poly_x0[i
-00001fd0: 305d 2920 2a20 2870 6f6c 795f 7831 5b69  0]) * (poly_x1[i
-00001fe0: 315d 202b 2070 6f6c 795f 7831 5b69 305d  1] + poly_x1[i0]
-00001ff0: 2929 203c 2030 0a0a 0a64 6566 2050 6f6c  )) < 0...def Pol
-00002000: 795f 6973 436c 6f63 6b77 6973 6528 6e70  y_isClockwise(np
-00002010: 2e6e 6461 7272 6179 5b64 6f75 626c 652c  .ndarray[double,
-00002020: 6e64 696d 3d32 5d20 506f 6c79 293a 0a20  ndim=2] Poly):. 
-00002030: 2020 2022 2222 2041 7373 756d 696e 6720     """ Assuming 
-00002040: 3244 2063 6c6f 7365 6420 506f 6c79 2021  2D closed Poly !
-00002050: 0a20 2020 2068 7474 703a 2f2f 7777 772e  .    http://www.
-00002060: 6661 7173 2e6f 7267 2f66 6171 732f 6772  faqs.org/faqs/gr
-00002070: 6170 6869 6373 2f61 6c67 6f72 6974 686d  aphics/algorithm
-00002080: 732d 6661 712f 0a20 2020 2046 696e 6420  s-faq/.    Find 
-00002090: 7468 6520 6c6f 7765 7374 2076 6572 7465  the lowest verte
-000020a0: 7820 286f 722c 2069 6620 7468 6572 6520  x (or, if there 
-000020b0: 6973 206d 6f72 6520 7468 616e 206f 6e65  is more than one
-000020c0: 2076 6572 7465 7820 7769 7468 0a20 2020   vertex with.   
-000020d0: 2074 6865 2073 616d 6520 6c6f 7765 7374   the same lowest
-000020e0: 2063 6f6f 7264 696e 6174 652c 2074 6865   coordinate, the
-000020f0: 2072 6967 6874 6d6f 7374 206f 6620 7468   rightmost of th
-00002100: 6f73 6520 7665 7274 6963 6573 2920 616e  ose vertices) an
-00002110: 6420 7468 656e 0a20 2020 2074 616b 6520  d then.    take 
-00002120: 7468 6520 6372 6f73 7320 7072 6f64 7563  the cross produc
-00002130: 7420 6f66 2074 6865 2065 6467 6573 2062  t of the edges b
-00002140: 6566 6f72 6520 616e 6420 6166 7465 7220  efore and after 
-00002150: 6974 2e0a 2020 2020 426f 7468 206d 6574  it..    Both met
-00002160: 686f 6473 2061 7265 204f 286e 2920 666f  hods are O(n) fo
-00002170: 7220 6e20 7665 7274 6963 6573 2c20 6275  r n vertices, bu
-00002180: 7420 6974 2064 6f65 7320 7365 656d 2061  t it does seem a
-00002190: 2077 6173 7465 2074 6f20 6164 6420 7570   waste to add up
-000021a0: 0a20 2020 2074 6865 2074 6f74 616c 2061  .    the total a
-000021b0: 7265 6120 7768 656e 2061 2073 696e 676c  rea when a singl
-000021c0: 6520 6372 6f73 7320 7072 6f64 7563 7420  e cross product 
-000021d0: 286f 6620 6a75 7374 2074 6865 2072 6967  (of just the rig
-000021e0: 6874 2065 6467 6573 290a 2020 2020 7375  ht edges).    su
-000021f0: 6666 6963 6573 2e20 2043 6f64 6520 666f  ffices.  Code fo
-00002200: 7220 7468 6973 2069 7320 6176 6169 6c61  r this is availa
-00002210: 626c 6520 6174 0a20 2020 2066 7470 3a2f  ble at.    ftp:/
-00002220: 2f63 732e 736d 6974 682e 6564 752f 7075  /cs.smith.edu/pu
-00002230: 622f 636f 6465 2f70 6f6c 796f 7269 656e  b/code/polyorien
-00002240: 742e 4320 2832 4b29 2e0a 2020 2020 2222  t.C (2K)..    ""
-00002250: 220a 2020 2020 6364 6566 2064 6f75 626c  ".    cdef doubl
-00002260: 6520 7265 730a 2020 2020 6364 6566 2064  e res.    cdef d
-00002270: 6f75 626c 655b 3a2c 3a3a 315d 206d 765f  ouble[:,::1] mv_
-00002280: 706f 6c79 203d 206e 702e 6173 636f 6e74  poly = np.ascont
-00002290: 6967 756f 7573 6172 7261 7928 506f 6c79  iguousarray(Poly
-000022a0: 290a 2020 2020 6364 6566 2069 6e74 206e  ).    cdef int n
-000022b0: 7074 7320 3d20 6d76 5f70 6f6c 792e 7368  pts = mv_poly.sh
-000022c0: 6170 655b 315d 0a20 2020 2063 6465 6620  ape[1].    cdef 
-000022d0: 696e 7420 6e64 696d 203d 206d 765f 706f  int ndim = mv_po
-000022e0: 6c79 2e73 6861 7065 5b30 5d0a 2020 2020  ly.shape[0].    
-000022f0: 6364 6566 2064 6f75 626c 655b 3a3a 315d  cdef double[::1]
-00002300: 206d 7678 0a20 2020 2063 6465 6620 646f   mvx.    cdef do
-00002310: 7562 6c65 5b3a 3a31 5d20 6d76 790a 2020  uble[::1] mvy.  
-00002320: 2020 6364 6566 2069 6e74 2069 646d 696e    cdef int idmin
-00002330: 0a20 2020 2063 6465 6620 696e 7420 6964  .    cdef int id
-00002340: 6d31 0a20 2020 2063 6465 6620 696e 7420  m1.    cdef int 
-00002350: 6964 7031 0a20 2020 2063 6465 6620 7374  idp1.    cdef st
-00002360: 7220 6572 725f 6d73 6720 3d20 2222 0a20  r err_msg = "". 
-00002370: 2020 2023 2043 6865 636b 696e 6720 7468     # Checking th
-00002380: 6174 2050 6f6c 7920 7761 736e 2774 2067  at Poly wasn't g
-00002390: 6976 656e 2069 6e20 7468 6520 7368 6170  iven in the shap
-000023a0: 6520 286e 7074 732c 206e 6469 6d29 0a20  e (npts, ndim). 
-000023b0: 2020 2069 6620 6e64 696d 203e 206e 7074     if ndim > npt
-000023c0: 733a 0a20 2020 2020 2020 206d 765f 706f  s:.        mv_po
-000023d0: 6c79 203d 206e 702e 6173 636f 6e74 6967  ly = np.ascontig
-000023e0: 756f 7573 6172 7261 7928 506f 6c79 2e54  uousarray(Poly.T
-000023f0: 290a 2020 2020 2020 2020 6e70 7473 203d  ).        npts =
-00002400: 206d 765f 706f 6c79 2e73 6861 7065 5b31   mv_poly.shape[1
-00002410: 5d0a 2020 2020 2020 2020 6e64 696d 203d  ].        ndim =
-00002420: 206d 765f 706f 6c79 2e73 6861 7065 5b30   mv_poly.shape[0
-00002430: 5d0a 2020 2020 6d76 7820 3d20 6d76 5f70  ].    mvx = mv_p
-00002440: 6f6c 795b 302c 3a5d 0a20 2020 206d 7679  oly[0,:].    mvy
-00002450: 203d 206d 765f 706f 6c79 5b31 2c3a 5d0a   = mv_poly[1,:].
-00002460: 2020 2020 2320 4765 7474 696e 6720 696e      # Getting in
-00002470: 6465 7820 6f66 206c 6f77 6572 2072 6967  dex of lower rig
-00002480: 6874 2063 6f72 6e65 7220 616e 6420 6974  ht corner and it
-00002490: 7320 6e65 6967 6862 6f72 730a 2020 2020  s neighbors.    
-000024a0: 6964 6d69 6e20 3d20 5f62 6774 2e66 696e  idmin = _bgt.fin
-000024b0: 645f 696e 645f 6c6f 7765 7272 6967 6874  d_ind_lowerright
-000024c0: 5f63 6f72 6e65 7228 6d76 782c 206d 7679  _corner(mvx, mvy
-000024d0: 2c20 6e70 7473 290a 2020 2020 6964 6d31  , npts).    idm1
-000024e0: 203d 2069 646d 696e 202d 2031 0a20 2020   = idmin - 1.   
-000024f0: 2069 6470 3120 3d20 2869 646d 696e 202b   idp1 = (idmin +
-00002500: 2031 2920 2520 6e70 7473 0a20 2020 2069   1) % npts.    i
-00002510: 6620 6964 6d69 6e20 3d3d 2030 203a 0a20  f idmin == 0 :. 
-00002520: 2020 2020 2020 2069 646d 3120 3d20 6e70         idm1 = np
-00002530: 7473 202d 2032 0a20 2020 2023 2043 6f6d  ts - 2.    # Com
-00002540: 7075 7469 6e67 2061 7265 6120 6f66 206c  puting area of l
-00002550: 6f77 6572 2072 6967 6874 2074 7269 616e  ower right trian
-00002560: 676c 650a 2020 2020 7265 7320 3d20 6d76  gle.    res = mv
-00002570: 785b 6964 6d31 5d20 202a 2028 6d76 795b  x[idm1]  * (mvy[
-00002580: 6964 6d69 6e5d 202d 206d 7679 5b69 6470  idmin] - mvy[idp
-00002590: 315d 2920 2b20 5c0a 2020 2020 2020 2020  1]) + \.        
-000025a0: 2020 6d76 785b 6964 6d69 6e5d 202a 2028    mvx[idmin] * (
-000025b0: 6d76 795b 6964 7031 5d20 202d 206d 7679  mvy[idp1]  - mvy
-000025c0: 5b69 646d 315d 2920 2b20 5c0a 2020 2020  [idm1]) + \.    
-000025d0: 2020 2020 2020 6d76 785b 6964 7031 5d20        mvx[idp1] 
-000025e0: 202a 2028 6d76 795b 6964 6d31 5d20 202d   * (mvy[idm1]  -
-000025f0: 206d 7679 5b69 646d 696e 5d29 0a20 2020   mvy[idmin]).   
-00002600: 2069 6620 6162 7328 7265 7329 203c 205f   if abs(res) < _
-00002610: 5653 4d41 4c4c 3a0a 2020 2020 2020 2020  VSMALL:.        
-00002620: 6572 725f 6d73 6720 2b3d 2028 2249 6e20  err_msg += ("In 
-00002630: 506f 6c79 5f69 7343 6c6f 636b 7769 7365  Poly_isClockwise
-00002640: 203a 205c 6e22 0a20 2020 2020 2020 2020   : \n".         
-00002650: 2020 2020 2020 2020 2020 202b 2022 2020             + "  
-00002660: 2046 6f75 6e64 206c 6f77 6573 7420 7269   Found lowest ri
-00002670: 6768 7420 706f 696e 7420 6174 2069 6e64  ght point at ind
-00002680: 6578 203a 2022 0a20 2020 2020 2020 2020  ex : ".         
-00002690: 2020 2020 2020 2020 2020 202b 2073 7472             + str
-000026a0: 2869 646d 696e 290a 2020 2020 2020 2020  (idmin).        
-000026b0: 2020 2020 2020 2020 2020 2020 2b20 222c              + ",
-000026c0: 206f 6620 636f 6f72 6469 6e61 7465 7320   of coordinates 
-000026d0: 3a22 202b 2073 7472 286d 7678 5b69 646d  :" + str(mvx[idm
-000026e0: 696e 5d29 0a20 2020 2020 2020 2020 2020  in]).           
-000026f0: 2020 2020 2020 2020 202b 2022 2c20 2220           + ", " 
-00002700: 2b20 7374 7228 6d76 795b 6964 6d69 6e5d  + str(mvy[idmin]
-00002710: 2920 2b20 222e 5c6e 220a 2020 2020 2020  ) + ".\n".      
-00002720: 2020 2020 2020 2020 2020 2020 2020 2b20                + 
-00002730: 2220 2020 5468 6520 7477 6f20 6e65 6967  "   The two neig
-00002740: 6862 6f72 696e 6720 706f 696e 7473 2061  hboring points a
-00002750: 7265 203a 2022 0a20 2020 2020 2020 2020  re : ".         
-00002760: 2020 2020 2020 2020 2020 202b 2073 7472             + str
-00002770: 2869 646d 3129 202b 2022 2061 6e64 2022  (idm1) + " and "
-00002780: 202b 2073 7472 2869 6470 3129 202b 2022   + str(idp1) + "
-00002790: 2e22 290a 2020 2020 2020 2020 7261 6973  .").        rais
-000027a0: 6520 4578 6365 7074 696f 6e28 6572 725f  e Exception(err_
-000027b0: 6d73 6729 2023 206e 6f74 2077 6f72 6b69  msg) # not worki
-000027c0: 6e67 0a20 2020 2072 6574 7572 6e20 7265  ng.    return re
-000027d0: 7320 3c20 302e 0a0a 0a64 6566 2066 6f72  s < 0....def for
-000027e0: 6d61 745f 706f 6c79 286e 702e 6e64 6172  mat_poly(np.ndar
-000027f0: 7261 795b 646f 7562 6c65 2c6e 6469 6d3d  ray[double,ndim=
-00002800: 325d 2070 6f6c 792c 2073 7472 206f 7264  2] poly, str ord
-00002810: 6572 3d27 4327 2c20 436c 6f63 6b3d 4661  er='C', Clock=Fa
-00002820: 6c73 652c 0a20 2020 2020 2020 2020 2020  lse,.           
-00002830: 2020 2020 636c 6f73 653d 5472 7565 2c20      close=True, 
-00002840: 5465 7374 3d54 7275 6529 3a0a 2020 2020  Test=True):.    
-00002850: 2222 220a 2020 2020 5265 7475 726e 2061  """.    Return a
-00002860: 2070 6f6c 7967 6f6e 2070 6f6c 7920 6173   polygon poly as
-00002870: 2061 206e 702e 6e64 6172 7261 7920 666f   a np.ndarray fo
-00002880: 726d 6174 7465 6420 6163 636f 7264 696e  rmatted accordin
-00002890: 6720 746f 2070 6172 616d 6574 6572 730a  g to parameters.
-000028a0: 0a20 2020 2050 6172 616d 6574 6572 730a  .    Parameters.
-000028b0: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
-000028c0: 2020 2020 2020 2070 6f6c 7920 2020 206e         poly    n
-000028d0: 702e 6e64 6172 7261 7920 6f72 206c 6973  p.ndarray or lis
-000028e0: 7420 2020 2049 6e70 7574 206e 702e 6e64  t    Input np.nd
-000028f0: 6172 7261 7920 6f66 2073 6861 7065 2028  array of shape (
-00002900: 6363 2c4e 290a 2020 2020 2020 2020 2020  cc,N).          
-00002910: 2020 2020 2020 6f72 2074 7570 6c65 2020        or tuple  
-00002920: 2020 2020 2020 2020 2020 2020 2877 6865              (whe
-00002930: 7265 2063 6320 3d20 3220 6f72 2033 2c20  re cc = 2 or 3, 
-00002940: 7468 6520 6e75 6d62 6572 206f 660a 2020  the number of.  
-00002950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002970: 2020 2020 636f 6f72 6469 6e61 7465 7320      coordinates 
-00002980: 616e 6420 4e20 706f 696e 7473 292c 206f  and N points), o
-00002990: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
-000029a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000029b0: 2020 2020 2020 2020 6c69 7374 206f 7220          list or 
-000029c0: 7475 706c 6520 6f66 2076 6572 7469 6365  tuple of vertice
-000029d0: 7320 6f66 2061 2070 6f6c 7967 6f6e 0a20  s of a polygon. 
-000029e0: 2020 2020 2020 206f 7264 6572 2020 2073         order   s
-000029f0: 7472 2020 2020 2020 2020 2020 2020 2020  tr              
-00002a00: 2020 2020 2046 6c61 6720 696e 6469 6361       Flag indica
-00002a10: 7469 6e67 2077 6865 7468 6572 2074 6865  ting whether the
-00002a20: 206f 7574 7075 740a 2020 2020 2020 2020   output.        
-00002a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002a40: 2020 2020 2020 2020 2020 2020 2020 6e70                np
-00002a50: 2e6e 6461 7272 6179 2073 6861 6c6c 2062  .ndarray shall b
-00002a60: 6520 432d 636f 6e74 6967 756f 7573 2028  e C-contiguous (
-00002a70: 2743 2729 206f 720a 2020 2020 2020 2020  'C') or.        
-00002a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002a90: 2020 2020 2020 2020 2020 2020 2020 466f                Fo
-00002aa0: 7274 7261 6e2d 636f 6e74 6967 756f 7573  rtran-contiguous
-00002ab0: 2028 2746 2729 0a20 2020 2020 2020 2043   ('F').        C
-00002ac0: 6c6f 636b 2020 2062 6f6f 6c20 2020 2020  lock   bool     
-00002ad0: 2020 2020 2020 2020 2020 2020 2046 6f72               For
-00002ae0: 2032 2d64 696d 656e 7369 6f6e 616c 2061   2-dimensional a
-00002af0: 7272 6179 7320 6f6e 6c79 2c20 666c 6167  rrays only, flag
-00002b00: 2069 6e64 692d 0a20 2020 2020 2020 2020   indi-.         
-00002b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002b20: 2020 2020 2020 2020 2020 2020 2063 6174               cat
-00002b30: 696e 6720 7768 6574 6865 7220 7468 6520  ing whether the 
-00002b40: 6f75 7470 7574 2061 7272 6179 2073 6861  output array sha
-00002b50: 6c6c 0a20 2020 2020 2020 2020 2020 2020  ll.             
-00002b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002b70: 2020 2020 2020 2020 2072 6570 7265 7365           represe
-00002b80: 6e74 2061 2063 6c6f 636b 7769 7365 2070  nt a clockwise p
-00002b90: 6f6c 7967 6f6e 2028 5472 7565 2920 6f72  olygon (True) or
-00002ba0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002bc0: 2020 2020 2020 2061 6e74 692d 636c 6f63         anti-cloc
-00002bd0: 6b77 6973 6520 2846 616c 7365 292c 206f  kwise (False), o
-00002be0: 7220 7368 6f75 6c64 2062 6520 6c65 6674  r should be left
-00002bf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002c10: 2020 2020 2020 2075 6e63 6861 6e67 6564         unchanged
-00002c20: 2028 4e6f 6e65 290a 2020 2020 2020 2020   (None).        
-00002c30: 636c 6f73 6520 2020 626f 6f6c 2020 2020  close   bool    
-00002c40: 2020 2020 2020 2020 2020 2020 2020 466f                Fo
-00002c50: 7220 322d 6469 6d65 6e73 696f 6e61 6c20  r 2-dimensional 
-00002c60: 6172 7261 7973 206f 6e6c 792c 2066 6c61  arrays only, fla
-00002c70: 6720 696e 6469 2d0a 2020 2020 2020 2020  g indi-.        
-00002c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002c90: 2020 2020 2020 2020 2020 2020 2020 6361                ca
-00002ca0: 7469 6e67 2077 6865 7468 6572 2074 6865  ting whether the
-00002cb0: 206f 7574 7075 7420 6172 7261 7920 7368   output array sh
-00002cc0: 616c 6c20 6265 0a20 2020 2020 2020 2020  all be.         
-00002cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002ce0: 2020 2020 2020 2020 2020 2020 2063 6c6f               clo
-00002cf0: 7365 6420 2854 7275 652c 2069 653a 206c  sed (True, ie: l
-00002d00: 6173 7420 706f 696e 743d 3d66 6972 7374  ast point==first
-00002d10: 2070 6f69 6e74 290a 2020 2020 2020 2020   point).        
-00002d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002d30: 2020 2020 2020 2020 2020 2020 2020 6f72                or
-00002d40: 206e 6f74 2063 6c6f 7365 6420 2846 616c   not closed (Fal
-00002d50: 7365 290a 2020 2020 2020 2020 5465 7374  se).        Test
-00002d60: 2020 2020 626f 6f6c 2020 2020 2020 2020      bool        
-00002d70: 2020 2020 2020 2020 2020 466c 6167 2069            Flag i
-00002d80: 6e64 6963 6174 696e 6720 7768 6574 6865  ndicating whethe
-00002d90: 7220 7468 6520 696e 7075 7473 2073 686f  r the inputs sho
-00002da0: 756c 640a 2020 2020 2020 2020 2020 2020  uld.            
-00002db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002dc0: 2020 2020 2020 2020 2020 6265 2074 6573            be tes
-00002dd0: 7465 6420 666f 7220 636f 6e66 6f72 6d69  ted for conformi
-00002de0: 7479 2c20 6465 6661 756c 743a 2054 7275  ty, default: Tru
-00002df0: 650a 0a20 2020 2052 6574 7572 6e73 0a20  e..    Returns. 
-00002e00: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2020     -------.     
-00002e10: 2020 2070 6f6c 7920 2020 206e 702e 6e64     poly    np.nd
-00002e20: 6172 7261 7920 2020 2020 2020 2020 2020  array           
-00002e30: 204f 7574 7075 7420 666f 726d 6174 7465   Output formatte
-00002e40: 6420 706f 6c79 676f 6e0a 2020 2020 2222  d polygon.    ""
-00002e50: 220a 2020 2020 6364 6566 2069 6e74 206e  ".    cdef int n
-00002e60: 6469 6d20 3d20 706f 6c79 2e73 6861 7065  dim = poly.shape
-00002e70: 5b30 5d0a 2020 2020 6364 6566 2069 6e74  [0].    cdef int
-00002e80: 206e 7074 7320 3d20 706f 6c79 2e73 6861   npts = poly.sha
-00002e90: 7065 5b31 5d0a 0a20 2020 2069 6620 5465  pe[1]..    if Te
-00002ea0: 7374 3a0a 2020 2020 2020 2020 6173 7365  st:.        asse
-00002eb0: 7274 2028 6e64 696d 203d 3d20 3220 6f72  rt (ndim == 2 or
-00002ec0: 206e 6469 6d20 3d3d 2033 292c 205c 0a20   ndim == 3), \. 
-00002ed0: 2020 2020 2020 2020 2020 2028 2241 7267             ("Arg
-00002ee0: 2070 6f6c 7920 6d75 7374 2063 6f6e 7461   poly must conta
-00002ef0: 696e 2074 6865 2032 4420 6f72 2033 4420  in the 2D or 3D 
-00002f00: 636f 6f72 6469 6e61 7465 7320 6f66 204e  coordinates of N
-00002f10: 2070 6f69 6e74 732e 220a 2020 2020 2020   points.".      
-00002f20: 2020 2020 2020 2022 2041 6e64 2062 6520         " And be 
-00002f30: 7368 6170 6564 2069 6e20 7468 6520 666f  shaped in the fo
-00002f40: 726d 2028 6469 6d2c 204e 292e 2229 0a20  rm (dim, N)."). 
-00002f50: 2020 2020 2020 2061 7373 6572 7420 706f         assert po
-00002f60: 6c79 2e73 6861 7065 5b31 5d3e 3d33 2c20  ly.shape[1]>=3, 
-00002f70: 2822 4172 6720 706f 6c79 206d 7573 7420  ("Arg poly must 
-00002f80: 636f 6e74 6169 6e20 7468 6520 3244 206f  contain the 2D o
-00002f90: 7220 3344 222c 0a20 2020 2020 2020 2020  r 3D",.         
-00002fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002fb0: 2020 2020 2020 2020 2022 2063 6f6f 7264           " coord
-00002fc0: 696e 6174 6573 206f 6620 6174 206c 6561  inates of at lea
-00002fd0: 7374 2033 2070 6f69 6e74 7321 2229 0a20  st 3 points!"). 
-00002fe0: 2020 2020 2020 2061 7373 6572 7420 6f72         assert or
-00002ff0: 6465 722e 6c6f 7765 7228 2920 696e 205b  der.lower() in [
-00003000: 2763 272c 2766 275d 2c20 2241 7267 206f  'c','f'], "Arg o
-00003010: 7264 6572 206d 7573 7420 6265 2069 6e20  rder must be in 
-00003020: 5b27 6327 2c27 6627 5d21 220a 2020 2020  ['c','f']!".    
-00003030: 2020 2020 6173 7365 7274 2074 7970 6528      assert type(
-00003040: 436c 6f63 6b29 2069 7320 626f 6f6c 2c20  Clock) is bool, 
-00003050: 2241 7267 2043 6c6f 636b 206d 7573 7420  "Arg Clock must 
-00003060: 6265 2061 2062 6f6f 6c21 220a 2020 2020  be a bool!".    
-00003070: 2020 2020 6173 7365 7274 2074 7970 6528      assert type(
-00003080: 636c 6f73 6529 2069 7320 626f 6f6c 2c20  close) is bool, 
-00003090: 2241 7267 2063 6c6f 7365 206d 7573 7420  "Arg close must 
-000030a0: 6265 2061 2062 6f6f 6c21 220a 0a20 2020  be a bool!"..   
-000030b0: 2023 2077 6520 636c 6f73 6520 7468 6520   # we close the 
-000030c0: 706f 6c79 2069 6620 6e6f 7420 636c 6f73  poly if not clos
-000030d0: 6564 0a20 2020 2069 6620 6e6f 7420 6e70  ed.    if not np
-000030e0: 2e61 6c6c 636c 6f73 6528 706f 6c79 5b3a  .allclose(poly[:
-000030f0: 2c30 5d2c 2070 6f6c 795b 3a2c 6e70 7473  ,0], poly[:,npts
-00003100: 2d31 5d2c 2061 746f 6c3d 5f56 534d 414c  -1], atol=_VSMAL
-00003110: 4c29 3a0a 2020 2020 2020 2020 706f 6c79  L):.        poly
-00003120: 203d 206e 702e 636f 6e63 6174 656e 6174   = np.concatenat
-00003130: 6528 2870 6f6c 792c 706f 6c79 5b3a 2c30  e((poly,poly[:,0
-00003140: 3a31 5d29 2c61 7869 733d 3129 0a20 2020  :1]),axis=1).   
-00003150: 2020 2020 206e 7074 7320 2b3d 2031 2023       npts += 1 #
-00003160: 2077 6520 6164 6465 6420 6120 706f 696e   we added a poin
-00003170: 740a 0a20 2020 2023 2076 6572 6966 7969  t..    # verifyi
-00003180: 6e67 2074 6861 7420 706f 6c79 2069 7320  ng that poly is 
-00003190: 2863 6f75 6e74 6572 2963 6c6f 636b 7769  (counter)clockwi
-000031a0: 7365 0a20 2020 2069 6620 6e64 696d 3d3d  se.    if ndim==
-000031b0: 3220 616e 6420 6e6f 7420 436c 6f63 6b20  2 and not Clock 
-000031c0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-000031d0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-000031e0: 2020 6966 206e 6f74 2043 6c6f 636b 3d3d    if not Clock==
-000031f0: 506f 6c79 5f69 7343 6c6f 636b 7769 7365  Poly_isClockwise
-00003200: 2870 6f6c 7929 3a0a 2020 2020 2020 2020  (poly):.        
-00003210: 2020 2020 2020 2020 706f 6c79 203d 2070          poly = p
-00003220: 6f6c 795b 3a2c 3a3a 2d31 5d0a 2020 2020  oly[:,::-1].    
-00003230: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-00003240: 7469 6f6e 2061 7320 6578 6370 3a0a 2020  tion as excp:.  
-00003250: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00003260: 6578 6370 0a0a 2020 2020 2320 6966 2077  excp..    # if w
-00003270: 6520 6469 646e 2774 2077 616e 7420 6974  e didn't want it
-00003280: 2063 6c6f 7365 2c20 7765 2074 616b 6520   close, we take 
-00003290: 6f75 7420 6c61 7374 2070 6f69 6e74 0a20  out last point. 
-000032a0: 2020 2069 6620 6e6f 7420 636c 6f73 653a     if not close:
-000032b0: 0a20 2020 2020 2020 2070 6f6c 7920 3d20  .        poly = 
-000032c0: 706f 6c79 5b3a 2c3a 6e70 7473 2d31 5d0a  poly[:,:npts-1].
-000032d0: 0a20 2020 2023 2074 616b 696e 6720 6361  .    # taking ca
-000032e0: 7265 206f 6620 636f 6e74 696e 7569 7479  re of continuity
-000032f0: 0a20 2020 2070 6f6c 7920 3d20 6e70 2e61  .    poly = np.a
-00003300: 7363 6f6e 7469 6775 6f75 7361 7272 6179  scontiguousarray
-00003310: 2870 6f6c 7929 2069 6620 6f72 6465 722e  (poly) if order.
-00003320: 6c6f 7765 7228 293d 3d27 6327 205c 0a20  lower()=='c' \. 
-00003330: 2020 2020 2020 2020 2020 656c 7365 206e            else n
-00003340: 702e 6173 666f 7274 7261 6e61 7272 6179  p.asfortranarray
-00003350: 2870 6f6c 7929 0a0a 2020 2020 7265 7475  (poly)..    retu
-00003360: 726e 2070 6f6c 790a 0a0a 6465 6620 506f  rn poly...def Po
-00003370: 6c79 5f56 6f6c 416e 6754 6f72 286e 702e  ly_VolAngTor(np.
-00003380: 6e64 6172 7261 795b 646f 7562 6c65 2c6e  ndarray[double,n
-00003390: 6469 6d3d 322c 6d6f 6465 3d27 6327 5d20  dim=2,mode='c'] 
-000033a0: 506f 6c79 293a 0a20 2020 2063 6465 6620  Poly):.    cdef 
-000033b0: 696e 7420 6e70 7473 203d 2050 6f6c 792e  int npts = Poly.
-000033c0: 7368 6170 655b 315d 0a20 2020 2063 6465  shape[1].    cde
-000033d0: 6620 6e70 2e6e 6461 7272 6179 5b64 6f75  f np.ndarray[dou
-000033e0: 626c 652c 6e64 696d 3d31 5d20 5269 3020  ble,ndim=1] Ri0 
-000033f0: 3d20 506f 6c79 5b30 2c3a 6e70 7473 2d31  = Poly[0,:npts-1
-00003400: 5d2c 2052 6931 203d 2050 6f6c 795b 302c  ], Ri1 = Poly[0,
-00003410: 313a 5d0a 2020 2020 6364 6566 206e 702e  1:].    cdef np.
-00003420: 6e64 6172 7261 795b 646f 7562 6c65 2c6e  ndarray[double,n
-00003430: 6469 6d3d 315d 205a 6930 203d 2050 6f6c  dim=1] Zi0 = Pol
-00003440: 795b 312c 3a6e 7074 732d 315d 2c20 5a69  y[1,:npts-1], Zi
-00003450: 3120 3d20 506f 6c79 5b31 2c31 3a5d 0a20  1 = Poly[1,1:]. 
-00003460: 2020 2063 6465 6620 646f 7562 6c65 2056     cdef double V
-00003470: 2020 203d 2020 6e70 2e73 756d 2828 5269     =  np.sum((Ri
-00003480: 302a 5a69 3120 2d20 5a69 302a 5269 3129  0*Zi1 - Zi0*Ri1)
-00003490: 202a 2028 5269 302b 5269 3129 2920 2f20   * (Ri0+Ri1)) / 
-000034a0: 362e 0a20 2020 2063 6465 6620 646f 7562  6..    cdef doub
-000034b0: 6c65 2042 5630 203d 2020 6e70 2e73 756d  le BV0 =  np.sum
-000034c0: 2830 2e35 202a 2028 5269 302a 5a69 3120  (0.5 * (Ri0*Zi1 
-000034d0: 2d20 5a69 302a 5269 3129 202a 0a20 2020  - Zi0*Ri1) *.   
-000034e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000034f0: 2020 2020 2020 2020 2020 2028 5269 312a             (Ri1*
-00003500: 2a32 202b 2052 6931 2a52 6930 202b 2052  *2 + Ri1*Ri0 + R
-00003510: 6930 2a2a 3229 2920 2f20 2836 2e2a 5629  i0**2)) / (6.*V)
-00003520: 0a20 2020 2063 6465 6620 646f 7562 6c65  .    cdef double
-00003530: 2042 5631 203d 202d 6e70 2e73 756d 2828   BV1 = -np.sum((
-00003540: 5269 312a 2a32 2a5a 6930 2a28 322e 2a5a  Ri1**2*Zi0*(2.*Z
-00003550: 6931 2b5a 6930 2920 2b0a 2020 2020 2020  i1+Zi0) +.      
-00003560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003570: 2020 2020 2020 2020 2032 2e2a 5269 302a           2.*Ri0*
-00003580: 5269 312a 285a 6930 2a2a 322d 5a69 312a  Ri1*(Zi0**2-Zi1*
-00003590: 2a32 2920 2d0a 2020 2020 2020 2020 2020  *2) -.          
-000035a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000035b0: 2020 2020 2052 6930 2a2a 322a 5a69 312a       Ri0**2*Zi1*
-000035c0: 285a 6931 2b32 2e2a 5a69 3029 292f 342e  (Zi1+2.*Zi0))/4.
-000035d0: 2920 2f20 2836 2e2a 5629 0a20 2020 2072  ) / (6.*V).    r
-000035e0: 6574 7572 6e20 562c 206e 702e 6172 7261  eturn V, np.arra
-000035f0: 7928 5b42 5630 2c42 5631 5d29 0a0a 0a64  y([BV0,BV1])...d
-00003600: 6566 2070 6f6c 795f 6172 6561 2864 6f75  ef poly_area(dou
-00003610: 626c 655b 3a2c 3a3a 315d 2070 6f6c 792c  ble[:,::1] poly,
-00003620: 2069 6e74 206e 7074 7329 3a0a 2020 2020   int npts):.    
-00003630: 6364 6566 2069 6e74 2069 690a 2020 2020  cdef int ii.    
-00003640: 6364 6566 2064 6f75 626c 6520 6172 6561  cdef double area
-00003650: 203d 2030 2e0a 2020 2020 2320 2320 3220   = 0..    # # 2 
-00003660: 4128 5029 203d 2073 756d 5f7b 693d 317d  A(P) = sum_{i=1}
-00003670: 5e7b 6e7d 2028 2078 5f69 2020 2879 5f7b  ^{n} ( x_i  (y_{
-00003680: 692b 317d 202d 2079 5f7b 692d 317d 2920  i+1} - y_{i-1}) 
-00003690: 290a 2020 2020 666f 7220 6969 2069 6e20  ).    for ii in 
-000036a0: 7261 6e67 6528 312c 6e70 7473 293a 0a20  range(1,npts):. 
-000036b0: 2020 2020 2020 2061 7265 6120 2b3d 2070         area += p
-000036c0: 6f6c 795b 302c 6969 5d20 2a20 2870 6f6c  oly[0,ii] * (pol
-000036d0: 795b 312c 6969 2b31 5d20 2d20 706f 6c79  y[1,ii+1] - poly
-000036e0: 5b31 2c69 692d 315d 290a 2020 2020 6172  [1,ii-1]).    ar
-000036f0: 6561 202b 3d20 706f 6c79 5b30 2c30 5d20  ea += poly[0,0] 
-00003700: 2a20 2870 6f6c 795b 312c 315d 202d 2070  * (poly[1,1] - p
-00003710: 6f6c 795b 312c 6e70 7473 2d31 5d29 0a20  oly[1,npts-1]). 
-00003720: 2020 2072 6574 7572 6e20 6172 6561 2f32     return area/2
-00003730: 0a0a 6465 6620 706f 6c79 5f61 7265 615f  ..def poly_area_
-00003740: 616e 645f 6261 7279 6365 6e74 6572 2864  and_barycenter(d
-00003750: 6f75 626c 655b 3a2c 3a3a 315d 2070 6f6c  ouble[:,::1] pol
-00003760: 792c 2069 6e74 206e 7074 7329 3a0a 2020  y, int npts):.  
-00003770: 2020 6364 6566 2069 6e74 2069 690a 2020    cdef int ii.  
-00003780: 2020 6364 6566 2064 6f75 626c 6520 6132    cdef double a2
-00003790: 0a20 2020 2063 6465 6620 646f 7562 6c65  .    cdef double
-000037a0: 2061 7265 610a 2020 2020 6364 6566 2064   area.    cdef d
-000037b0: 6f75 626c 6520 696e 7661 360a 2020 2020  ouble inva6.    
-000037c0: 6364 6566 206e 702e 6e64 6172 7261 795b  cdef np.ndarray[
-000037d0: 646f 7562 6c65 2c6e 6469 6d3d 315d 2063  double,ndim=1] c
-000037e0: 6720 3d20 6e70 2e7a 6572 6f73 2828 322c  g = np.zeros((2,
-000037f0: 2929 0a20 2020 2063 6465 6620 646f 7562  )).    cdef doub
-00003800: 6c65 5b3a 3a31 5d20 6367 5f6d 7620 3d20  le[::1] cg_mv = 
-00003810: 6367 0a20 2020 2063 6465 6620 646f 7562  cg.    cdef doub
-00003820: 6c65 5b32 5d20 7031 2c20 7032 0a20 2020  le[2] p1, p2.   
-00003830: 2066 6f72 2069 6920 696e 2072 616e 6765   for ii in range
-00003840: 286e 7074 7329 3a0a 2020 2020 2020 2020  (npts):.        
-00003850: 7031 5b30 5d20 3d20 706f 6c79 5b30 2c69  p1[0] = poly[0,i
-00003860: 695d 0a20 2020 2020 2020 2070 315b 315d  i].        p1[1]
-00003870: 203d 2070 6f6c 795b 312c 6969 5d0a 2020   = poly[1,ii].  
-00003880: 2020 2020 2020 7032 5b30 5d20 3d20 706f        p2[0] = po
-00003890: 6c79 5b30 2c69 692b 315d 0a20 2020 2020  ly[0,ii+1].     
-000038a0: 2020 2070 325b 315d 203d 2070 6f6c 795b     p2[1] = poly[
-000038b0: 312c 6969 2b31 5d0a 2020 2020 2020 2020  1,ii+1].        
-000038c0: 6132 203d 2070 315b 305d 2a70 325b 315d  a2 = p1[0]*p2[1]
-000038d0: 202d 2070 325b 305d 2a70 315b 315d 0a20   - p2[0]*p1[1]. 
-000038e0: 2020 2020 2020 2063 675f 6d76 5b30 5d20         cg_mv[0] 
-000038f0: 2b3d 2028 7031 5b30 5d20 2b20 7032 5b30  += (p1[0] + p2[0
-00003900: 5d29 2a61 320a 2020 2020 2020 2020 6367  ])*a2.        cg
-00003910: 5f6d 765b 315d 202b 3d20 2870 315b 315d  _mv[1] += (p1[1]
-00003920: 202b 2070 325b 315d 292a 6132 0a20 2020   + p2[1])*a2.   
-00003930: 2061 7265 6120 3d20 706f 6c79 5f61 7265   area = poly_are
-00003940: 6128 706f 6c79 2c20 6e70 7473 290a 2020  a(poly, npts).  
-00003950: 2020 696e 7661 3620 3d20 312e 202f 2061    inva6 = 1. / a
-00003960: 7265 6120 2f20 362e 0a20 2020 2063 675b  rea / 6..    cg[
-00003970: 305d 203d 2063 675b 305d 202a 2069 6e76  0] = cg[0] * inv
-00003980: 6136 0a20 2020 2063 675b 315d 203d 2063  a6.    cg[1] = c
-00003990: 675b 315d 202a 2069 6e76 6136 0a20 2020  g[1] * inva6.   
-000039a0: 2072 6574 7572 6e20 6367 2c20 6172 6561   return cg, area
-000039b0: 0a0a 0a22 2222 0a23 2323 2323 2323 2323  ...""".#########
-000039c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000039d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000039e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00001eb0: 2323 2323 2323 2323 2323 2323 230a 2320  #############.# 
+00001ec0: 2020 2020 2020 506f 6c79 676f 6e73 0a23        Polygons.#
+00001ed0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00001ee0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00001ef0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00001f00: 2323 2323 2323 230a 0a0a 6364 6566 205f  #######...cdef _
+00001f10: 6368 6563 6b5f 706f 6c79 676f 6e5f 3264  check_polygon_2d
+00001f20: 5f63 6f75 6e74 6572 5f63 6c6f 636b 7769  _counter_clockwi
+00001f30: 7365 280a 2020 2020 706f 6c79 5f78 303d  se(.    poly_x0=
+00001f40: 4e6f 6e65 2c0a 2020 2020 706f 6c79 5f78  None,.    poly_x
+00001f50: 313d 4e6f 6e65 2c0a 293a 0a20 2020 2022  1=None,.):.    "
+00001f60: 2222 2041 7373 756d 6573 206e 6f6e 2d63  "" Assumes non-c
+00001f70: 6c6f 7365 6420 706f 6c79 676f 6e20 2222  losed polygon ""
+00001f80: 220a 0a20 2020 2069 3020 3d20 6e70 2e61  "..    i0 = np.a
+00001f90: 7261 6e67 6528 302c 2070 6f6c 795f 7830  range(0, poly_x0
+00001fa0: 2e73 697a 6529 0a20 2020 2069 3120 3d20  .size).    i1 = 
+00001fb0: 6e70 2e72 5f5b 6e70 2e61 7261 6e67 6528  np.r_[np.arange(
+00001fc0: 312c 2070 6f6c 795f 7830 2e73 697a 6529  1, poly_x0.size)
+00001fd0: 2c20 305d 0a20 2020 2072 6574 7572 6e20  , 0].    return 
+00001fe0: 6e70 2e73 756d 2828 706f 6c79 5f78 305b  np.sum((poly_x0[
+00001ff0: 6931 5d20 2d20 706f 6c79 5f78 305b 6930  i1] - poly_x0[i0
+00002000: 5d29 202a 2028 706f 6c79 5f78 315b 6931  ]) * (poly_x1[i1
+00002010: 5d20 2b20 706f 6c79 5f78 315b 6930 5d29  ] + poly_x1[i0])
+00002020: 2920 3c20 300a 0a0a 6465 6620 506f 6c79  ) < 0...def Poly
+00002030: 5f69 7343 6c6f 636b 7769 7365 286e 702e  _isClockwise(np.
+00002040: 6e64 6172 7261 795b 646f 7562 6c65 2c6e  ndarray[double,n
+00002050: 6469 6d3d 325d 2050 6f6c 7929 3a0a 2020  dim=2] Poly):.  
+00002060: 2020 2222 2220 4173 7375 6d69 6e67 2032    """ Assuming 2
+00002070: 4420 636c 6f73 6564 2050 6f6c 7920 210a  D closed Poly !.
+00002080: 2020 2020 6874 7470 3a2f 2f77 7777 2e66      http://www.f
+00002090: 6171 732e 6f72 672f 6661 7173 2f67 7261  aqs.org/faqs/gra
+000020a0: 7068 6963 732f 616c 676f 7269 7468 6d73  phics/algorithms
+000020b0: 2d66 6171 2f0a 2020 2020 4669 6e64 2074  -faq/.    Find t
+000020c0: 6865 206c 6f77 6573 7420 7665 7274 6578  he lowest vertex
+000020d0: 2028 6f72 2c20 6966 2074 6865 7265 2069   (or, if there i
+000020e0: 7320 6d6f 7265 2074 6861 6e20 6f6e 6520  s more than one 
+000020f0: 7665 7274 6578 2077 6974 680a 2020 2020  vertex with.    
+00002100: 7468 6520 7361 6d65 206c 6f77 6573 7420  the same lowest 
+00002110: 636f 6f72 6469 6e61 7465 2c20 7468 6520  coordinate, the 
+00002120: 7269 6768 746d 6f73 7420 6f66 2074 686f  rightmost of tho
+00002130: 7365 2076 6572 7469 6365 7329 2061 6e64  se vertices) and
+00002140: 2074 6865 6e0a 2020 2020 7461 6b65 2074   then.    take t
+00002150: 6865 2063 726f 7373 2070 726f 6475 6374  he cross product
+00002160: 206f 6620 7468 6520 6564 6765 7320 6265   of the edges be
+00002170: 666f 7265 2061 6e64 2061 6674 6572 2069  fore and after i
+00002180: 742e 0a20 2020 2042 6f74 6820 6d65 7468  t..    Both meth
+00002190: 6f64 7320 6172 6520 4f28 6e29 2066 6f72  ods are O(n) for
+000021a0: 206e 2076 6572 7469 6365 732c 2062 7574   n vertices, but
+000021b0: 2069 7420 646f 6573 2073 6565 6d20 6120   it does seem a 
+000021c0: 7761 7374 6520 746f 2061 6464 2075 700a  waste to add up.
+000021d0: 2020 2020 7468 6520 746f 7461 6c20 6172      the total ar
+000021e0: 6561 2077 6865 6e20 6120 7369 6e67 6c65  ea when a single
+000021f0: 2063 726f 7373 2070 726f 6475 6374 2028   cross product (
+00002200: 6f66 206a 7573 7420 7468 6520 7269 6768  of just the righ
+00002210: 7420 6564 6765 7329 0a20 2020 2073 7566  t edges).    suf
+00002220: 6669 6365 732e 2020 436f 6465 2066 6f72  fices.  Code for
+00002230: 2074 6869 7320 6973 2061 7661 696c 6162   this is availab
+00002240: 6c65 2061 740a 2020 2020 6674 703a 2f2f  le at.    ftp://
+00002250: 6373 2e73 6d69 7468 2e65 6475 2f70 7562  cs.smith.edu/pub
+00002260: 2f63 6f64 652f 706f 6c79 6f72 6965 6e74  /code/polyorient
+00002270: 2e43 2028 324b 292e 0a20 2020 2022 2222  .C (2K)..    """
+00002280: 0a20 2020 2063 6465 6620 646f 7562 6c65  .    cdef double
+00002290: 2072 6573 0a20 2020 2063 6465 6620 646f   res.    cdef do
+000022a0: 7562 6c65 5b3a 2c3a 3a31 5d20 6d76 5f70  uble[:,::1] mv_p
+000022b0: 6f6c 7920 3d20 6e70 2e61 7363 6f6e 7469  oly = np.asconti
+000022c0: 6775 6f75 7361 7272 6179 2850 6f6c 7929  guousarray(Poly)
+000022d0: 0a20 2020 2063 6465 6620 696e 7420 6e70  .    cdef int np
+000022e0: 7473 203d 206d 765f 706f 6c79 2e73 6861  ts = mv_poly.sha
+000022f0: 7065 5b31 5d0a 2020 2020 6364 6566 2069  pe[1].    cdef i
+00002300: 6e74 206e 6469 6d20 3d20 6d76 5f70 6f6c  nt ndim = mv_pol
+00002310: 792e 7368 6170 655b 305d 0a20 2020 2063  y.shape[0].    c
+00002320: 6465 6620 646f 7562 6c65 5b3a 3a31 5d20  def double[::1] 
+00002330: 6d76 780a 2020 2020 6364 6566 2064 6f75  mvx.    cdef dou
+00002340: 626c 655b 3a3a 315d 206d 7679 0a20 2020  ble[::1] mvy.   
+00002350: 2063 6465 6620 696e 7420 6964 6d69 6e0a   cdef int idmin.
+00002360: 2020 2020 6364 6566 2069 6e74 2069 646d      cdef int idm
+00002370: 310a 2020 2020 6364 6566 2069 6e74 2069  1.    cdef int i
+00002380: 6470 310a 2020 2020 6364 6566 2073 7472  dp1.    cdef str
+00002390: 2065 7272 5f6d 7367 203d 2022 220a 2020   err_msg = "".  
+000023a0: 2020 2320 4368 6563 6b69 6e67 2074 6861    # Checking tha
+000023b0: 7420 506f 6c79 2077 6173 6e27 7420 6769  t Poly wasn't gi
+000023c0: 7665 6e20 696e 2074 6865 2073 6861 7065  ven in the shape
+000023d0: 2028 6e70 7473 2c20 6e64 696d 290a 2020   (npts, ndim).  
+000023e0: 2020 6966 206e 6469 6d20 3e20 6e70 7473    if ndim > npts
+000023f0: 3a0a 2020 2020 2020 2020 6d76 5f70 6f6c  :.        mv_pol
+00002400: 7920 3d20 6e70 2e61 7363 6f6e 7469 6775  y = np.ascontigu
+00002410: 6f75 7361 7272 6179 2850 6f6c 792e 5429  ousarray(Poly.T)
+00002420: 0a20 2020 2020 2020 206e 7074 7320 3d20  .        npts = 
+00002430: 6d76 5f70 6f6c 792e 7368 6170 655b 315d  mv_poly.shape[1]
+00002440: 0a20 2020 2020 2020 206e 6469 6d20 3d20  .        ndim = 
+00002450: 6d76 5f70 6f6c 792e 7368 6170 655b 305d  mv_poly.shape[0]
+00002460: 0a20 2020 206d 7678 203d 206d 765f 706f  .    mvx = mv_po
+00002470: 6c79 5b30 2c3a 5d0a 2020 2020 6d76 7920  ly[0,:].    mvy 
+00002480: 3d20 6d76 5f70 6f6c 795b 312c 3a5d 0a20  = mv_poly[1,:]. 
+00002490: 2020 2023 2047 6574 7469 6e67 2069 6e64     # Getting ind
+000024a0: 6578 206f 6620 6c6f 7765 7220 7269 6768  ex of lower righ
+000024b0: 7420 636f 726e 6572 2061 6e64 2069 7473  t corner and its
+000024c0: 206e 6569 6768 626f 7273 0a20 2020 2069   neighbors.    i
+000024d0: 646d 696e 203d 205f 6267 742e 6669 6e64  dmin = _bgt.find
+000024e0: 5f69 6e64 5f6c 6f77 6572 7269 6768 745f  _ind_lowerright_
+000024f0: 636f 726e 6572 286d 7678 2c20 6d76 792c  corner(mvx, mvy,
+00002500: 206e 7074 7329 0a20 2020 2069 646d 3120   npts).    idm1 
+00002510: 3d20 6964 6d69 6e20 2d20 310a 2020 2020  = idmin - 1.    
+00002520: 6964 7031 203d 2028 6964 6d69 6e20 2b20  idp1 = (idmin + 
+00002530: 3129 2025 206e 7074 730a 2020 2020 6966  1) % npts.    if
+00002540: 2069 646d 696e 203d 3d20 3020 3a0a 2020   idmin == 0 :.  
+00002550: 2020 2020 2020 6964 6d31 203d 206e 7074        idm1 = npt
+00002560: 7320 2d20 320a 2020 2020 2320 436f 6d70  s - 2.    # Comp
+00002570: 7574 696e 6720 6172 6561 206f 6620 6c6f  uting area of lo
+00002580: 7765 7220 7269 6768 7420 7472 6961 6e67  wer right triang
+00002590: 6c65 0a20 2020 2072 6573 203d 206d 7678  le.    res = mvx
+000025a0: 5b69 646d 315d 2020 2a20 286d 7679 5b69  [idm1]  * (mvy[i
+000025b0: 646d 696e 5d20 2d20 6d76 795b 6964 7031  dmin] - mvy[idp1
+000025c0: 5d29 202b 205c 0a20 2020 2020 2020 2020  ]) + \.         
+000025d0: 206d 7678 5b69 646d 696e 5d20 2a20 286d   mvx[idmin] * (m
+000025e0: 7679 5b69 6470 315d 2020 2d20 6d76 795b  vy[idp1]  - mvy[
+000025f0: 6964 6d31 5d29 202b 205c 0a20 2020 2020  idm1]) + \.     
+00002600: 2020 2020 206d 7678 5b69 6470 315d 2020       mvx[idp1]  
+00002610: 2a20 286d 7679 5b69 646d 315d 2020 2d20  * (mvy[idm1]  - 
+00002620: 6d76 795b 6964 6d69 6e5d 290a 2020 2020  mvy[idmin]).    
+00002630: 6966 2061 6273 2872 6573 2920 3c20 5f56  if abs(res) < _V
+00002640: 534d 414c 4c3a 0a20 2020 2020 2020 2065  SMALL:.        e
+00002650: 7272 5f6d 7367 202b 3d20 2822 496e 2050  rr_msg += ("In P
+00002660: 6f6c 795f 6973 436c 6f63 6b77 6973 6520  oly_isClockwise 
+00002670: 3a20 5c6e 220a 2020 2020 2020 2020 2020  : \n".          
+00002680: 2020 2020 2020 2020 2020 2b20 2220 2020            + "   
+00002690: 466f 756e 6420 6c6f 7765 7374 2072 6967  Found lowest rig
+000026a0: 6874 2070 6f69 6e74 2061 7420 696e 6465  ht point at inde
+000026b0: 7820 3a20 220a 2020 2020 2020 2020 2020  x : ".          
+000026c0: 2020 2020 2020 2020 2020 2b20 7374 7228            + str(
+000026d0: 6964 6d69 6e29 0a20 2020 2020 2020 2020  idmin).         
+000026e0: 2020 2020 2020 2020 2020 202b 2022 2c20             + ", 
+000026f0: 6f66 2063 6f6f 7264 696e 6174 6573 203a  of coordinates :
+00002700: 2220 2b20 7374 7228 6d76 785b 6964 6d69  " + str(mvx[idmi
+00002710: 6e5d 290a 2020 2020 2020 2020 2020 2020  n]).            
+00002720: 2020 2020 2020 2020 2b20 222c 2022 202b          + ", " +
+00002730: 2073 7472 286d 7679 5b69 646d 696e 5d29   str(mvy[idmin])
+00002740: 202b 2022 2e5c 6e22 0a20 2020 2020 2020   + ".\n".       
+00002750: 2020 2020 2020 2020 2020 2020 202b 2022               + "
+00002760: 2020 2054 6865 2074 776f 206e 6569 6768     The two neigh
+00002770: 626f 7269 6e67 2070 6f69 6e74 7320 6172  boring points ar
+00002780: 6520 3a20 220a 2020 2020 2020 2020 2020  e : ".          
+00002790: 2020 2020 2020 2020 2020 2b20 7374 7228            + str(
+000027a0: 6964 6d31 2920 2b20 2220 616e 6420 2220  idm1) + " and " 
+000027b0: 2b20 7374 7228 6964 7031 2920 2b20 222e  + str(idp1) + ".
+000027c0: 2229 0a20 2020 2020 2020 2072 6169 7365  ").        raise
+000027d0: 2045 7863 6570 7469 6f6e 2865 7272 5f6d   Exception(err_m
+000027e0: 7367 2920 2320 6e6f 7420 776f 726b 696e  sg) # not workin
+000027f0: 670a 2020 2020 7265 7475 726e 2072 6573  g.    return res
+00002800: 203c 2030 2e0a 0a0a 6465 6620 666f 726d   < 0....def form
+00002810: 6174 5f70 6f6c 7928 6e70 2e6e 6461 7272  at_poly(np.ndarr
+00002820: 6179 5b64 6f75 626c 652c 6e64 696d 3d32  ay[double,ndim=2
+00002830: 5d20 706f 6c79 2c20 7374 7220 6f72 6465  ] poly, str orde
+00002840: 723d 2743 272c 2043 6c6f 636b 3d46 616c  r='C', Clock=Fal
+00002850: 7365 2c0a 2020 2020 2020 2020 2020 2020  se,.            
+00002860: 2020 2063 6c6f 7365 3d54 7275 652c 2054     close=True, T
+00002870: 6573 743d 5472 7565 293a 0a20 2020 2022  est=True):.    "
+00002880: 2222 0a20 2020 2052 6574 7572 6e20 6120  "".    Return a 
+00002890: 706f 6c79 676f 6e20 706f 6c79 2061 7320  polygon poly as 
+000028a0: 6120 6e70 2e6e 6461 7272 6179 2066 6f72  a np.ndarray for
+000028b0: 6d61 7474 6564 2061 6363 6f72 6469 6e67  matted according
+000028c0: 2074 6f20 7061 7261 6d65 7465 7273 0a0a   to parameters..
+000028d0: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
+000028e0: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
+000028f0: 2020 2020 2020 706f 6c79 2020 2020 6e70        poly    np
+00002900: 2e6e 6461 7272 6179 206f 7220 6c69 7374  .ndarray or list
+00002910: 2020 2020 496e 7075 7420 6e70 2e6e 6461      Input np.nda
+00002920: 7272 6179 206f 6620 7368 6170 6520 2863  rray of shape (c
+00002930: 632c 4e29 0a20 2020 2020 2020 2020 2020  c,N).           
+00002940: 2020 2020 206f 7220 7475 706c 6520 2020       or tuple   
+00002950: 2020 2020 2020 2020 2020 2028 7768 6572             (wher
+00002960: 6520 6363 203d 2032 206f 7220 332c 2074  e cc = 2 or 3, t
+00002970: 6865 206e 756d 6265 7220 6f66 0a20 2020  he number of.   
+00002980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000029a0: 2020 2063 6f6f 7264 696e 6174 6573 2061     coordinates a
+000029b0: 6e64 204e 2070 6f69 6e74 7329 2c20 6f72  nd N points), or
+000029c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000029d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000029e0: 2020 2020 2020 206c 6973 7420 6f72 2074         list or t
+000029f0: 7570 6c65 206f 6620 7665 7274 6963 6573  uple of vertices
+00002a00: 206f 6620 6120 706f 6c79 676f 6e0a 2020   of a polygon.  
+00002a10: 2020 2020 2020 6f72 6465 7220 2020 7374        order   st
+00002a20: 7220 2020 2020 2020 2020 2020 2020 2020  r               
+00002a30: 2020 2020 466c 6167 2069 6e64 6963 6174      Flag indicat
+00002a40: 696e 6720 7768 6574 6865 7220 7468 6520  ing whether the 
+00002a50: 6f75 7470 7574 0a20 2020 2020 2020 2020  output.         
+00002a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002a70: 2020 2020 2020 2020 2020 2020 206e 702e               np.
+00002a80: 6e64 6172 7261 7920 7368 616c 6c20 6265  ndarray shall be
+00002a90: 2043 2d63 6f6e 7469 6775 6f75 7320 2827   C-contiguous ('
+00002aa0: 4327 2920 6f72 0a20 2020 2020 2020 2020  C') or.         
+00002ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002ac0: 2020 2020 2020 2020 2020 2020 2046 6f72               For
+00002ad0: 7472 616e 2d63 6f6e 7469 6775 6f75 7320  tran-contiguous 
+00002ae0: 2827 4627 290a 2020 2020 2020 2020 436c  ('F').        Cl
+00002af0: 6f63 6b20 2020 626f 6f6c 2020 2020 2020  ock   bool      
+00002b00: 2020 2020 2020 2020 2020 2020 466f 7220              For 
+00002b10: 322d 6469 6d65 6e73 696f 6e61 6c20 6172  2-dimensional ar
+00002b20: 7261 7973 206f 6e6c 792c 2066 6c61 6720  rays only, flag 
+00002b30: 696e 6469 2d0a 2020 2020 2020 2020 2020  indi-.          
+00002b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002b50: 2020 2020 2020 2020 2020 2020 6361 7469              cati
+00002b60: 6e67 2077 6865 7468 6572 2074 6865 206f  ng whether the o
+00002b70: 7574 7075 7420 6172 7261 7920 7368 616c  utput array shal
+00002b80: 6c0a 2020 2020 2020 2020 2020 2020 2020  l.              
+00002b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002ba0: 2020 2020 2020 2020 7265 7072 6573 656e          represen
+00002bb0: 7420 6120 636c 6f63 6b77 6973 6520 706f  t a clockwise po
+00002bc0: 6c79 676f 6e20 2854 7275 6529 206f 720a  lygon (True) or.
+00002bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002bf0: 2020 2020 2020 616e 7469 2d63 6c6f 636b        anti-clock
+00002c00: 7769 7365 2028 4661 6c73 6529 2c20 6f72  wise (False), or
+00002c10: 2073 686f 756c 6420 6265 206c 6566 740a   should be left.
+00002c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002c40: 2020 2020 2020 756e 6368 616e 6765 6420        unchanged 
+00002c50: 284e 6f6e 6529 0a20 2020 2020 2020 2063  (None).        c
+00002c60: 6c6f 7365 2020 2062 6f6f 6c20 2020 2020  lose   bool     
+00002c70: 2020 2020 2020 2020 2020 2020 2046 6f72               For
+00002c80: 2032 2d64 696d 656e 7369 6f6e 616c 2061   2-dimensional a
+00002c90: 7272 6179 7320 6f6e 6c79 2c20 666c 6167  rrays only, flag
+00002ca0: 2069 6e64 692d 0a20 2020 2020 2020 2020   indi-.         
+00002cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002cc0: 2020 2020 2020 2020 2020 2020 2063 6174               cat
+00002cd0: 696e 6720 7768 6574 6865 7220 7468 6520  ing whether the 
+00002ce0: 6f75 7470 7574 2061 7272 6179 2073 6861  output array sha
+00002cf0: 6c6c 2062 650a 2020 2020 2020 2020 2020  ll be.          
+00002d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002d10: 2020 2020 2020 2020 2020 2020 636c 6f73              clos
+00002d20: 6564 2028 5472 7565 2c20 6965 3a20 6c61  ed (True, ie: la
+00002d30: 7374 2070 6f69 6e74 3d3d 6669 7273 7420  st point==first 
+00002d40: 706f 696e 7429 0a20 2020 2020 2020 2020  point).         
+00002d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002d60: 2020 2020 2020 2020 2020 2020 206f 7220               or 
+00002d70: 6e6f 7420 636c 6f73 6564 2028 4661 6c73  not closed (Fals
+00002d80: 6529 0a20 2020 2020 2020 2054 6573 7420  e).        Test 
+00002d90: 2020 2062 6f6f 6c20 2020 2020 2020 2020     bool         
+00002da0: 2020 2020 2020 2020 2046 6c61 6720 696e           Flag in
+00002db0: 6469 6361 7469 6e67 2077 6865 7468 6572  dicating whether
+00002dc0: 2074 6865 2069 6e70 7574 7320 7368 6f75   the inputs shou
+00002dd0: 6c64 0a20 2020 2020 2020 2020 2020 2020  ld.             
+00002de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002df0: 2020 2020 2020 2020 2062 6520 7465 7374           be test
+00002e00: 6564 2066 6f72 2063 6f6e 666f 726d 6974  ed for conformit
+00002e10: 792c 2064 6566 6175 6c74 3a20 5472 7565  y, default: True
+00002e20: 0a0a 2020 2020 5265 7475 726e 730a 2020  ..    Returns.  
+00002e30: 2020 2d2d 2d2d 2d2d 2d0a 2020 2020 2020    -------.      
+00002e40: 2020 706f 6c79 2020 2020 6e70 2e6e 6461    poly    np.nda
+00002e50: 7272 6179 2020 2020 2020 2020 2020 2020  rray            
+00002e60: 4f75 7470 7574 2066 6f72 6d61 7474 6564  Output formatted
+00002e70: 2070 6f6c 7967 6f6e 0a20 2020 2022 2222   polygon.    """
+00002e80: 0a20 2020 2063 6465 6620 696e 7420 6e64  .    cdef int nd
+00002e90: 696d 203d 2070 6f6c 792e 7368 6170 655b  im = poly.shape[
+00002ea0: 305d 0a20 2020 2063 6465 6620 696e 7420  0].    cdef int 
+00002eb0: 6e70 7473 203d 2070 6f6c 792e 7368 6170  npts = poly.shap
+00002ec0: 655b 315d 0a0a 2020 2020 6966 2054 6573  e[1]..    if Tes
+00002ed0: 743a 0a20 2020 2020 2020 2061 7373 6572  t:.        asser
+00002ee0: 7420 286e 6469 6d20 3d3d 2032 206f 7220  t (ndim == 2 or 
+00002ef0: 6e64 696d 203d 3d20 3329 2c20 5c0a 2020  ndim == 3), \.  
+00002f00: 2020 2020 2020 2020 2020 2822 4172 6720            ("Arg 
+00002f10: 706f 6c79 206d 7573 7420 636f 6e74 6169  poly must contai
+00002f20: 6e20 7468 6520 3244 206f 7220 3344 2063  n the 2D or 3D c
+00002f30: 6f6f 7264 696e 6174 6573 206f 6620 4e20  oordinates of N 
+00002f40: 706f 696e 7473 2e22 0a20 2020 2020 2020  points.".       
+00002f50: 2020 2020 2020 2220 416e 6420 6265 2073        " And be s
+00002f60: 6861 7065 6420 696e 2074 6865 2066 6f72  haped in the for
+00002f70: 6d20 2864 696d 2c20 4e29 2e22 290a 2020  m (dim, N).").  
+00002f80: 2020 2020 2020 6173 7365 7274 2070 6f6c        assert pol
+00002f90: 792e 7368 6170 655b 315d 3e3d 332c 2028  y.shape[1]>=3, (
+00002fa0: 2241 7267 2070 6f6c 7920 6d75 7374 2063  "Arg poly must c
+00002fb0: 6f6e 7461 696e 2074 6865 2032 4420 6f72  ontain the 2D or
+00002fc0: 2033 4422 2c0a 2020 2020 2020 2020 2020   3D",.          
+00002fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002fe0: 2020 2020 2020 2020 2220 636f 6f72 6469          " coordi
+00002ff0: 6e61 7465 7320 6f66 2061 7420 6c65 6173  nates of at leas
+00003000: 7420 3320 706f 696e 7473 2122 290a 2020  t 3 points!").  
+00003010: 2020 2020 2020 6173 7365 7274 206f 7264        assert ord
+00003020: 6572 2e6c 6f77 6572 2829 2069 6e20 5b27  er.lower() in ['
+00003030: 6327 2c27 6627 5d2c 2022 4172 6720 6f72  c','f'], "Arg or
+00003040: 6465 7220 6d75 7374 2062 6520 696e 205b  der must be in [
+00003050: 2763 272c 2766 275d 2122 0a20 2020 2020  'c','f']!".     
+00003060: 2020 2061 7373 6572 7420 7479 7065 2843     assert type(C
+00003070: 6c6f 636b 2920 6973 2062 6f6f 6c2c 2022  lock) is bool, "
+00003080: 4172 6720 436c 6f63 6b20 6d75 7374 2062  Arg Clock must b
+00003090: 6520 6120 626f 6f6c 2122 0a20 2020 2020  e a bool!".     
+000030a0: 2020 2061 7373 6572 7420 7479 7065 2863     assert type(c
+000030b0: 6c6f 7365 2920 6973 2062 6f6f 6c2c 2022  lose) is bool, "
+000030c0: 4172 6720 636c 6f73 6520 6d75 7374 2062  Arg close must b
+000030d0: 6520 6120 626f 6f6c 2122 0a0a 2020 2020  e a bool!"..    
+000030e0: 2320 7765 2063 6c6f 7365 2074 6865 2070  # we close the p
+000030f0: 6f6c 7920 6966 206e 6f74 2063 6c6f 7365  oly if not close
+00003100: 640a 2020 2020 6966 206e 6f74 206e 702e  d.    if not np.
+00003110: 616c 6c63 6c6f 7365 2870 6f6c 795b 3a2c  allclose(poly[:,
+00003120: 305d 2c20 706f 6c79 5b3a 2c6e 7074 732d  0], poly[:,npts-
+00003130: 315d 2c20 6174 6f6c 3d5f 5653 4d41 4c4c  1], atol=_VSMALL
+00003140: 293a 0a20 2020 2020 2020 2070 6f6c 7920  ):.        poly 
+00003150: 3d20 6e70 2e63 6f6e 6361 7465 6e61 7465  = np.concatenate
+00003160: 2828 706f 6c79 2c70 6f6c 795b 3a2c 303a  ((poly,poly[:,0:
+00003170: 315d 292c 6178 6973 3d31 290a 2020 2020  1]),axis=1).    
+00003180: 2020 2020 6e70 7473 202b 3d20 3120 2320      npts += 1 # 
+00003190: 7765 2061 6464 6564 2061 2070 6f69 6e74  we added a point
+000031a0: 0a0a 2020 2020 2320 7665 7269 6679 696e  ..    # verifyin
+000031b0: 6720 7468 6174 2070 6f6c 7920 6973 2028  g that poly is (
+000031c0: 636f 756e 7465 7229 636c 6f63 6b77 6973  counter)clockwis
+000031d0: 650a 2020 2020 6966 206e 6469 6d3d 3d32  e.    if ndim==2
+000031e0: 2061 6e64 206e 6f74 2043 6c6f 636b 2069   and not Clock i
+000031f0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+00003200: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00003210: 2069 6620 6e6f 7420 436c 6f63 6b3d 3d50   if not Clock==P
+00003220: 6f6c 795f 6973 436c 6f63 6b77 6973 6528  oly_isClockwise(
+00003230: 706f 6c79 293a 0a20 2020 2020 2020 2020  poly):.         
+00003240: 2020 2020 2020 2070 6f6c 7920 3d20 706f         poly = po
+00003250: 6c79 5b3a 2c3a 3a2d 315d 0a20 2020 2020  ly[:,::-1].     
+00003260: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
+00003270: 696f 6e20 6173 2065 7863 703a 0a20 2020  ion as excp:.   
+00003280: 2020 2020 2020 2020 2072 6169 7365 2065           raise e
+00003290: 7863 700a 0a20 2020 2023 2069 6620 7765  xcp..    # if we
+000032a0: 2064 6964 6e27 7420 7761 6e74 2069 7420   didn't want it 
+000032b0: 636c 6f73 652c 2077 6520 7461 6b65 206f  close, we take o
+000032c0: 7574 206c 6173 7420 706f 696e 740a 2020  ut last point.  
+000032d0: 2020 6966 206e 6f74 2063 6c6f 7365 3a0a    if not close:.
+000032e0: 2020 2020 2020 2020 706f 6c79 203d 2070          poly = p
+000032f0: 6f6c 795b 3a2c 3a6e 7074 732d 315d 0a0a  oly[:,:npts-1]..
+00003300: 2020 2020 2320 7461 6b69 6e67 2063 6172      # taking car
+00003310: 6520 6f66 2063 6f6e 7469 6e75 6974 790a  e of continuity.
+00003320: 2020 2020 706f 6c79 203d 206e 702e 6173      poly = np.as
+00003330: 636f 6e74 6967 756f 7573 6172 7261 7928  contiguousarray(
+00003340: 706f 6c79 2920 6966 206f 7264 6572 2e6c  poly) if order.l
+00003350: 6f77 6572 2829 3d3d 2763 2720 5c0a 2020  ower()=='c' \.  
+00003360: 2020 2020 2020 2020 2065 6c73 6520 6e70           else np
+00003370: 2e61 7366 6f72 7472 616e 6172 7261 7928  .asfortranarray(
+00003380: 706f 6c79 290a 0a20 2020 2072 6574 7572  poly)..    retur
+00003390: 6e20 706f 6c79 0a0a 0a64 6566 2050 6f6c  n poly...def Pol
+000033a0: 795f 566f 6c41 6e67 546f 7228 6e70 2e6e  y_VolAngTor(np.n
+000033b0: 6461 7272 6179 5b64 6f75 626c 652c 6e64  darray[double,nd
+000033c0: 696d 3d32 2c6d 6f64 653d 2763 275d 2050  im=2,mode='c'] P
+000033d0: 6f6c 7929 3a0a 2020 2020 6364 6566 2069  oly):.    cdef i
+000033e0: 6e74 206e 7074 7320 3d20 506f 6c79 2e73  nt npts = Poly.s
+000033f0: 6861 7065 5b31 5d0a 2020 2020 6364 6566  hape[1].    cdef
+00003400: 206e 702e 6e64 6172 7261 795b 646f 7562   np.ndarray[doub
+00003410: 6c65 2c6e 6469 6d3d 315d 2052 6930 203d  le,ndim=1] Ri0 =
+00003420: 2050 6f6c 795b 302c 3a6e 7074 732d 315d   Poly[0,:npts-1]
+00003430: 2c20 5269 3120 3d20 506f 6c79 5b30 2c31  , Ri1 = Poly[0,1
+00003440: 3a5d 0a20 2020 2063 6465 6620 6e70 2e6e  :].    cdef np.n
+00003450: 6461 7272 6179 5b64 6f75 626c 652c 6e64  darray[double,nd
+00003460: 696d 3d31 5d20 5a69 3020 3d20 506f 6c79  im=1] Zi0 = Poly
+00003470: 5b31 2c3a 6e70 7473 2d31 5d2c 205a 6931  [1,:npts-1], Zi1
+00003480: 203d 2050 6f6c 795b 312c 313a 5d0a 2020   = Poly[1,1:].  
+00003490: 2020 6364 6566 2064 6f75 626c 6520 5620    cdef double V 
+000034a0: 2020 3d20 206e 702e 7375 6d28 2852 6930    =  np.sum((Ri0
+000034b0: 2a5a 6931 202d 205a 6930 2a52 6931 2920  *Zi1 - Zi0*Ri1) 
+000034c0: 2a20 2852 6930 2b52 6931 2929 202f 2036  * (Ri0+Ri1)) / 6
+000034d0: 2e0a 2020 2020 6364 6566 2064 6f75 626c  ..    cdef doubl
+000034e0: 6520 4256 3020 3d20 206e 702e 7375 6d28  e BV0 =  np.sum(
+000034f0: 302e 3520 2a20 2852 6930 2a5a 6931 202d  0.5 * (Ri0*Zi1 -
+00003500: 205a 6930 2a52 6931 2920 2a0a 2020 2020   Zi0*Ri1) *.    
+00003510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003520: 2020 2020 2020 2020 2020 2852 6931 2a2a            (Ri1**
+00003530: 3220 2b20 5269 312a 5269 3020 2b20 5269  2 + Ri1*Ri0 + Ri
+00003540: 302a 2a32 2929 202f 2028 362e 2a56 290a  0**2)) / (6.*V).
+00003550: 2020 2020 6364 6566 2064 6f75 626c 6520      cdef double 
+00003560: 4256 3120 3d20 2d6e 702e 7375 6d28 2852  BV1 = -np.sum((R
+00003570: 6931 2a2a 322a 5a69 302a 2832 2e2a 5a69  i1**2*Zi0*(2.*Zi
+00003580: 312b 5a69 3029 202b 0a20 2020 2020 2020  1+Zi0) +.       
+00003590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000035a0: 2020 2020 2020 2020 322e 2a52 6930 2a52          2.*Ri0*R
+000035b0: 6931 2a28 5a69 302a 2a32 2d5a 6931 2a2a  i1*(Zi0**2-Zi1**
+000035c0: 3229 202d 0a20 2020 2020 2020 2020 2020  2) -.           
+000035d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000035e0: 2020 2020 5269 302a 2a32 2a5a 6931 2a28      Ri0**2*Zi1*(
+000035f0: 5a69 312b 322e 2a5a 6930 2929 2f34 2e29  Zi1+2.*Zi0))/4.)
+00003600: 202f 2028 362e 2a56 290a 2020 2020 7265   / (6.*V).    re
+00003610: 7475 726e 2056 2c20 6e70 2e61 7272 6179  turn V, np.array
+00003620: 285b 4256 302c 4256 315d 290a 0a0a 6465  ([BV0,BV1])...de
+00003630: 6620 706f 6c79 5f61 7265 6128 646f 7562  f poly_area(doub
+00003640: 6c65 5b3a 2c3a 3a31 5d20 706f 6c79 2c20  le[:,::1] poly, 
+00003650: 696e 7420 6e70 7473 293a 0a20 2020 2063  int npts):.    c
+00003660: 6465 6620 696e 7420 6969 0a20 2020 2063  def int ii.    c
+00003670: 6465 6620 646f 7562 6c65 2061 7265 6120  def double area 
+00003680: 3d20 302e 0a20 2020 2023 2023 2032 2041  = 0..    # # 2 A
+00003690: 2850 2920 3d20 7375 6d5f 7b69 3d31 7d5e  (P) = sum_{i=1}^
+000036a0: 7b6e 7d20 2820 785f 6920 2028 795f 7b69  {n} ( x_i  (y_{i
+000036b0: 2b31 7d20 2d20 795f 7b69 2d31 7d29 2029  +1} - y_{i-1}) )
+000036c0: 0a20 2020 2066 6f72 2069 6920 696e 2072  .    for ii in r
+000036d0: 616e 6765 2831 2c6e 7074 7329 3a0a 2020  ange(1,npts):.  
+000036e0: 2020 2020 2020 6172 6561 202b 3d20 706f        area += po
+000036f0: 6c79 5b30 2c69 695d 202a 2028 706f 6c79  ly[0,ii] * (poly
+00003700: 5b31 2c69 692b 315d 202d 2070 6f6c 795b  [1,ii+1] - poly[
+00003710: 312c 6969 2d31 5d29 0a20 2020 2061 7265  1,ii-1]).    are
+00003720: 6120 2b3d 2070 6f6c 795b 302c 305d 202a  a += poly[0,0] *
+00003730: 2028 706f 6c79 5b31 2c31 5d20 2d20 706f   (poly[1,1] - po
+00003740: 6c79 5b31 2c6e 7074 732d 315d 290a 2020  ly[1,npts-1]).  
+00003750: 2020 7265 7475 726e 2061 7265 612f 320a    return area/2.
+00003760: 0a64 6566 2070 6f6c 795f 6172 6561 5f61  .def poly_area_a
+00003770: 6e64 5f62 6172 7963 656e 7465 7228 646f  nd_barycenter(do
+00003780: 7562 6c65 5b3a 2c3a 3a31 5d20 706f 6c79  uble[:,::1] poly
+00003790: 2c20 696e 7420 6e70 7473 293a 0a20 2020  , int npts):.   
+000037a0: 2063 6465 6620 696e 7420 6969 0a20 2020   cdef int ii.   
+000037b0: 2063 6465 6620 646f 7562 6c65 2061 320a   cdef double a2.
+000037c0: 2020 2020 6364 6566 2064 6f75 626c 6520      cdef double 
+000037d0: 6172 6561 0a20 2020 2063 6465 6620 646f  area.    cdef do
+000037e0: 7562 6c65 2069 6e76 6136 0a20 2020 2063  uble inva6.    c
+000037f0: 6465 6620 6e70 2e6e 6461 7272 6179 5b64  def np.ndarray[d
+00003800: 6f75 626c 652c 6e64 696d 3d31 5d20 6367  ouble,ndim=1] cg
+00003810: 203d 206e 702e 7a65 726f 7328 2832 2c29   = np.zeros((2,)
+00003820: 290a 2020 2020 6364 6566 2064 6f75 626c  ).    cdef doubl
+00003830: 655b 3a3a 315d 2063 675f 6d76 203d 2063  e[::1] cg_mv = c
+00003840: 670a 2020 2020 6364 6566 2064 6f75 626c  g.    cdef doubl
+00003850: 655b 325d 2070 312c 2070 320a 2020 2020  e[2] p1, p2.    
+00003860: 666f 7220 6969 2069 6e20 7261 6e67 6528  for ii in range(
+00003870: 6e70 7473 293a 0a20 2020 2020 2020 2070  npts):.        p
+00003880: 315b 305d 203d 2070 6f6c 795b 302c 6969  1[0] = poly[0,ii
+00003890: 5d0a 2020 2020 2020 2020 7031 5b31 5d20  ].        p1[1] 
+000038a0: 3d20 706f 6c79 5b31 2c69 695d 0a20 2020  = poly[1,ii].   
+000038b0: 2020 2020 2070 325b 305d 203d 2070 6f6c       p2[0] = pol
+000038c0: 795b 302c 6969 2b31 5d0a 2020 2020 2020  y[0,ii+1].      
+000038d0: 2020 7032 5b31 5d20 3d20 706f 6c79 5b31    p2[1] = poly[1
+000038e0: 2c69 692b 315d 0a20 2020 2020 2020 2061  ,ii+1].        a
+000038f0: 3220 3d20 7031 5b30 5d2a 7032 5b31 5d20  2 = p1[0]*p2[1] 
+00003900: 2d20 7032 5b30 5d2a 7031 5b31 5d0a 2020  - p2[0]*p1[1].  
+00003910: 2020 2020 2020 6367 5f6d 765b 305d 202b        cg_mv[0] +
+00003920: 3d20 2870 315b 305d 202b 2070 325b 305d  = (p1[0] + p2[0]
+00003930: 292a 6132 0a20 2020 2020 2020 2063 675f  )*a2.        cg_
+00003940: 6d76 5b31 5d20 2b3d 2028 7031 5b31 5d20  mv[1] += (p1[1] 
+00003950: 2b20 7032 5b31 5d29 2a61 320a 2020 2020  + p2[1])*a2.    
+00003960: 6172 6561 203d 2070 6f6c 795f 6172 6561  area = poly_area
+00003970: 2870 6f6c 792c 206e 7074 7329 0a20 2020  (poly, npts).   
+00003980: 2069 6e76 6136 203d 2031 2e20 2f20 6172   inva6 = 1. / ar
+00003990: 6561 202f 2036 2e0a 2020 2020 6367 5b30  ea / 6..    cg[0
+000039a0: 5d20 3d20 6367 5b30 5d20 2a20 696e 7661  ] = cg[0] * inva
+000039b0: 360a 2020 2020 6367 5b31 5d20 3d20 6367  6.    cg[1] = cg
+000039c0: 5b31 5d20 2a20 696e 7661 360a 2020 2020  [1] * inva6.    
+000039d0: 7265 7475 726e 2063 672c 2061 7265 610a  return cg, area.
+000039e0: 0a0a 2222 220a 2323 2323 2323 2323 2323  ..""".##########
 000039f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00003a00: 2323 2323 2323 0a23 2323 2323 2323 2323  ######.#########
+00003a00: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00003a10: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00003a20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00003a30: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00003a30: 2323 2323 230a 2323 2323 2323 2323 2323  #####.##########
 00003a40: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00003a50: 2323 2323 2323 0a20 2020 2020 2020 2020  ######.         
-00003a60: 2020 2020 2020 2020 2020 2053 696e 6f67             Sinog
-00003a70: 7261 6d20 7370 6563 6966 6963 0a23 2323  ram specific.###
-00003a80: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00003a90: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00003aa0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00003a50: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00003a60: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00003a70: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00003a80: 2323 2323 230a 2020 2020 2020 2020 2020  #####.          
+00003a90: 2020 2020 2020 2020 2020 5369 6e6f 6772            Sinogr
+00003aa0: 616d 2073 7065 6369 6669 630a 2323 2323  am specific.####
 00003ab0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00003ac0: 2323 2323 2323 2323 2323 2323 0a22 2222  ############."""
-00003ad0: 0a0a 0a64 6566 2053 696e 6f5f 496d 7061  ...def Sino_Impa
-00003ae0: 6374 456e 7628 6e70 2e6e 6461 7272 6179  ctEnv(np.ndarray
-00003af0: 5b64 6f75 626c 652c 6e64 696d 3d31 5d20  [double,ndim=1] 
-00003b00: 525a 2c0a 2020 2020 2020 2020 2020 2020  RZ,.            
-00003b10: 2020 2020 2020 206e 702e 6e64 6172 7261         np.ndarra
-00003b20: 795b 646f 7562 6c65 2c6e 6469 6d3d 325d  y[double,ndim=2]
-00003b30: 2050 6f6c 792c 2069 6e74 204e 503d 3530   Poly, int NP=50
-00003b40: 2c20 5465 7374 3d54 7275 6529 3a0a 2020  , Test=True):.  
-00003b50: 2020 2222 2220 436f 6d70 7574 6573 2069    """ Computes i
-00003b60: 6d70 6163 7420 7061 7261 6d65 7465 7273  mpact parameters
-00003b70: 206f 6620 6120 546f 7220 656e 7665 6c6f   of a Tor envelo
-00003b80: 7070 650a 2020 2020 2861 2060 546f 7260  ppe.    (a `Tor`
-00003b90: 2069 7320 6120 636c 6f73 6564 2032 4420   is a closed 2D 
-00003ba0: 706f 6c79 676f 6e29 0a0a 2020 2020 442e  polygon)..    D.
-00003bb0: 2056 455a 494e 4554 2c20 4175 672e 2032   VEZINET, Aug. 2
-00003bc0: 3031 340a 2020 2020 5061 7261 6d65 7465  014.    Paramete
-00003bd0: 7273 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  rs.    ---------
-00003be0: 2d0a 2020 2020 525a 203a 2020 2020 6e70  -.    RZ :    np
-00003bf0: 2e6e 6461 7272 6179 0a20 2020 2020 2020  .ndarray.       
-00003c00: 2028 322c 2920 6172 7261 7920 696e 6469   (2,) array indi
-00003c10: 6361 7469 6e67 2074 6865 2072 6566 6572  cating the refer
-00003c20: 656e 6365 2069 6d70 6163 7420 706f 696e  ence impact poin
-00003c30: 740a 2020 2020 506f 6c79 203a 2020 6e70  t.    Poly :  np
-00003c40: 2e6e 6461 7272 6179 0a20 2020 2020 2020  .ndarray.       
-00003c50: 2028 322c 4e29 2061 7272 6179 2063 6f6e   (2,N) array con
-00003c60: 7461 696e 696e 6720 7468 6520 636f 6f72  taining the coor
-00003c70: 6469 6e61 7465 736f 6620 6120 636c 6f73  dinatesof a clos
-00003c80: 6564 2070 6f6c 7967 6f6e 0a20 2020 204e  ed polygon.    N
-00003c90: 5020 3a20 2020 2069 6e74 0a20 2020 2020  P :    int.     
-00003ca0: 2020 204e 756d 6265 7220 6f66 2069 6e64     Number of ind
-00003cb0: 6963 6174 696e 6720 7468 6520 6e75 6d62  icating the numb
-00003cc0: 6572 206f 6620 706f 696e 7473 2075 7365  er of points use
-00003cd0: 6420 666f 7220 6469 7363 7265 7469 7369  d for discretisi
-00003ce0: 6e67 2074 6865 7461 2062 6574 7765 656e  ng theta between
-00003cf0: 2030 2061 6e64 2070 690a 0a20 2020 2052   0 and pi..    R
-00003d00: 6574 7572 6e73 0a20 2020 202d 2d2d 2d2d  eturns.    -----
-00003d10: 2d2d 0a20 2020 2020 2020 2074 6865 7461  --.        theta
-00003d20: 0a20 2020 2022 2222 0a20 2020 2069 6620  .    """.    if 
-00003d30: 5465 7374 3a0a 2020 2020 2020 2020 6173  Test:.        as
-00003d40: 7365 7274 2052 5a2e 7369 7a65 3d3d 322c  sert RZ.size==2,
-00003d50: 2027 4172 6720 525a 2073 686f 756c 6420   'Arg RZ should 
-00003d60: 6265 2061 2028 322c 2920 6e70 2e6e 6461  be a (2,) np.nda
-00003d70: 7272 6179 2127 0a20 2020 2020 2020 2061  rray!'.        a
-00003d80: 7373 6572 7420 506f 6c79 2e73 6861 7065  ssert Poly.shape
-00003d90: 5b30 5d3d 3d32 2c20 2741 7267 2050 6f6c  [0]==2, 'Arg Pol
-00003da0: 7920 7368 6f75 6c64 2062 6520 6120 2832  y should be a (2
-00003db0: 2c4e 2920 6e70 2e6e 6461 7272 6179 2127  ,N) np.ndarray!'
-00003dc0: 0a0a 2020 2020 2320 5468 6574 6120 7361  ..    # Theta sa
-00003dd0: 6d70 6c69 6e67 2061 6e64 2075 6e69 7420  mpling and unit 
-00003de0: 7665 6374 6f72 0a20 2020 2074 6865 7461  vector.    theta
-00003df0: 203d 206e 702e 6c69 6e73 7061 6365 2830   = np.linspace(0
-00003e00: 2e2c 6e70 2e70 692c 4e50 2c65 6e64 706f  .,np.pi,NP,endpo
-00003e10: 696e 743d 5472 7565 290a 2020 2020 7665  int=True).    ve
-00003e20: 6374 203d 206e 702e 6172 7261 7928 5b6e  ct = np.array([n
-00003e30: 702e 636f 7328 7468 6574 6129 2c20 6e70  p.cos(theta), np
-00003e40: 2e73 696e 2874 6865 7461 295d 290a 0a20  .sin(theta)]).. 
-00003e50: 2020 2023 2053 6361 6c61 7220 7072 6f64     # Scalar prod
-00003e60: 7563 740a 2020 2020 7363 6120 3d20 6e70  uct.    sca = np
-00003e70: 2e73 756d 2876 6563 745b 3a2c 3a2c 6e70  .sum(vect[:,:,np
-00003e80: 2e6e 6577 6178 6973 5d2a 2850 6f6c 792d  .newaxis]*(Poly-
-00003e90: 525a 5b3a 2c6e 702e 6e65 7761 7869 735d  RZ[:,np.newaxis]
-00003ea0: 295b 3a2c 6e70 2e6e 6577 6178 6973 2c3a  )[:,np.newaxis,:
-00003eb0: 5d2c 6178 6973 3d30 290a 2020 2020 7363  ],axis=0).    sc
-00003ec0: 616d 696e 203d 206e 702e 6d69 6e28 7363  amin = np.min(sc
-00003ed0: 612c 6178 6973 3d31 290a 2020 2020 7363  a,axis=1).    sc
-00003ee0: 616d 6178 203d 206e 702e 6d61 7828 7363  amax = np.max(sc
-00003ef0: 612c 6178 6973 3d31 290a 2020 2020 7265  a,axis=1).    re
-00003f00: 7475 726e 2074 6865 7461 2c20 6e70 2e61  turn theta, np.a
-00003f10: 7272 6179 285b 7363 616d 6178 2c20 7363  rray([scamax, sc
-00003f20: 616d 696e 5d29 0a0a 0a23 2046 6f72 2073  amin])...# For s
-00003f30: 696e 6f67 7261 6d73 0a64 6566 2043 6f6e  inograms.def Con
-00003f40: 7665 7274 496d 7061 6374 5f54 6865 7461  vertImpact_Theta
-00003f50: 3258 6928 7468 6574 612c 2070 502c 2070  2Xi(theta, pP, p
-00003f60: 4e2c 2073 6f72 743d 5472 7565 293a 0a20  N, sort=True):. 
-00003f70: 2020 2069 6620 6861 7361 7474 7228 7468     if hasattr(th
-00003f80: 6574 612c 275f 5f67 6574 6974 656d 5f5f  eta,'__getitem__
-00003f90: 2729 3a0a 2020 2020 2020 2020 7050 2c20  '):.        pP, 
-00003fa0: 704e 2c20 7468 6574 6120 3d20 6e70 2e61  pN, theta = np.a
-00003fb0: 7361 7272 6179 2870 5029 2c20 6e70 2e61  sarray(pP), np.a
-00003fc0: 7361 7272 6179 2870 4e29 2c20 6e70 2e61  sarray(pN), np.a
-00003fd0: 7361 7272 6179 2874 6865 7461 290a 2020  sarray(theta).  
-00003fe0: 2020 2020 2020 6173 7365 7274 2070 502e        assert pP.
-00003ff0: 7368 6170 653d 3d70 4e2e 7368 6170 653d  shape==pN.shape=
-00004000: 3d74 6865 7461 2e73 6861 7065 2c20 280a  =theta.shape, (.
-00004010: 2020 2020 2020 2020 2020 2020 2241 7267              "Arg
-00004020: 7320 7050 2c20 704e 2061 6e64 2074 6865  s pP, pN and the
-00004030: 7461 206d 7573 7420 6861 7665 2073 616d  ta must have sam
-00004040: 6520 7368 6170 6521 2229 0a20 2020 2020  e shape!").     
-00004050: 2020 2070 5062 6973 2c20 704e 6269 7320     pPbis, pNbis 
-00004060: 3d20 6e70 2e63 6f70 7928 7050 292c 206e  = np.copy(pP), n
-00004070: 702e 636f 7079 2870 4e29 0a20 2020 2020  p.copy(pN).     
-00004080: 2020 2078 6920 3d20 7468 6574 6120 2d20     xi = theta - 
-00004090: 6e70 2e70 692f 322e 0a20 2020 2020 2020  np.pi/2..       
-000040a0: 2069 6e64 203d 2078 6920 3c20 300a 2020   ind = xi < 0.  
-000040b0: 2020 2020 2020 7050 6269 735b 696e 645d        pPbis[ind]
-000040c0: 2c20 704e 6269 735b 696e 645d 2c20 7869  , pNbis[ind], xi
-000040d0: 5b69 6e64 5d20 3d20 2d70 4e5b 696e 645d  [ind] = -pN[ind]
-000040e0: 2c20 2d70 505b 696e 645d 2c20 7869 5b69  , -pP[ind], xi[i
-000040f0: 6e64 5d2b 6e70 2e70 690a 2020 2020 2020  nd]+np.pi.      
-00004100: 2020 6966 2073 6f72 743a 0a20 2020 2020    if sort:.     
-00004110: 2020 2020 2020 2069 6e64 203d 206e 702e         ind = np.
-00004120: 6172 6773 6f72 7428 7869 290a 2020 2020  argsort(xi).    
-00004130: 2020 2020 2020 2020 7869 2c20 7050 2c20          xi, pP, 
-00004140: 704e 203d 2078 695b 696e 645d 2c20 7050  pN = xi[ind], pP
-00004150: 6269 735b 696e 645d 2c20 704e 6269 735b  bis[ind], pNbis[
-00004160: 696e 645d 0a20 2020 2020 2020 2072 6574  ind].        ret
-00004170: 7572 6e20 7869 2c20 7050 2c20 704e 0a20  urn xi, pP, pN. 
-00004180: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00004190: 2061 7373 6572 7420 6e6f 7420 2868 6173   assert not (has
-000041a0: 6174 7472 2870 502c 275f 5f67 6574 6974  attr(pP,'__getit
-000041b0: 656d 5f5f 2729 206f 7220 6861 7361 7474  em__') or hasatt
-000041c0: 7228 704e 2c27 5f5f 6765 7469 7465 6d5f  r(pN,'__getitem_
-000041d0: 5f27 2929 2c20 280a 2020 2020 2020 2020  _')), (.        
-000041e0: 2020 2020 2241 7267 7320 7050 2c20 704e      "Args pP, pN
-000041f0: 2061 6e64 2074 6865 7461 206d 7573 7420   and theta must 
-00004200: 6861 7665 2073 616d 6520 7368 6170 6521  have same shape!
-00004210: 2229 0a20 2020 2020 2020 2078 6920 3d20  ").        xi = 
-00004220: 7468 6574 6120 2d20 6e70 2e70 692f 322e  theta - np.pi/2.
-00004230: 0a20 2020 2020 2020 2069 6620 7869 203c  .        if xi <
-00004240: 2030 2e3a 0a20 2020 2020 2020 2020 2020   0.:.           
-00004250: 2072 6574 7572 6e20 7869 2b6e 702e 7069   return xi+np.pi
-00004260: 2c20 2d70 4e2c 202d 7050 0a20 2020 2020  , -pN, -pP.     
-00004270: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00004280: 2020 2020 2072 6574 7572 6e20 7869 2c20       return xi, 
-00004290: 7050 2c20 704e 0a0a 0a22 2222 0a23 2323  pP, pN...""".###
-000042a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000042b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000042c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000042d0: 2323 2323 230a 2323 2323 2323 2323 2323  #####.##########
+00003ac0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00003ad0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00003ae0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00003af0: 2323 2323 2323 2323 2323 230a 2222 220a  ###########.""".
+00003b00: 0a0a 6465 6620 5369 6e6f 5f49 6d70 6163  ..def Sino_Impac
+00003b10: 7445 6e76 286e 702e 6e64 6172 7261 795b  tEnv(np.ndarray[
+00003b20: 646f 7562 6c65 2c6e 6469 6d3d 315d 2052  double,ndim=1] R
+00003b30: 5a2c 0a20 2020 2020 2020 2020 2020 2020  Z,.             
+00003b40: 2020 2020 2020 6e70 2e6e 6461 7272 6179        np.ndarray
+00003b50: 5b64 6f75 626c 652c 6e64 696d 3d32 5d20  [double,ndim=2] 
+00003b60: 506f 6c79 2c20 696e 7420 4e50 3d35 302c  Poly, int NP=50,
+00003b70: 2054 6573 743d 5472 7565 293a 0a20 2020   Test=True):.   
+00003b80: 2022 2222 2043 6f6d 7075 7465 7320 696d   """ Computes im
+00003b90: 7061 6374 2070 6172 616d 6574 6572 7320  pact parameters 
+00003ba0: 6f66 2061 2054 6f72 2065 6e76 656c 6f70  of a Tor envelop
+00003bb0: 7065 0a20 2020 2028 6120 6054 6f72 6020  pe.    (a `Tor` 
+00003bc0: 6973 2061 2063 6c6f 7365 6420 3244 2070  is a closed 2D p
+00003bd0: 6f6c 7967 6f6e 290a 0a20 2020 2044 2e20  olygon)..    D. 
+00003be0: 5645 5a49 4e45 542c 2041 7567 2e20 3230  VEZINET, Aug. 20
+00003bf0: 3134 0a20 2020 2050 6172 616d 6574 6572  14.    Parameter
+00003c00: 730a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  s.    ----------
+00003c10: 0a20 2020 2052 5a20 3a20 2020 206e 702e  .    RZ :    np.
+00003c20: 6e64 6172 7261 790a 2020 2020 2020 2020  ndarray.        
+00003c30: 2832 2c29 2061 7272 6179 2069 6e64 6963  (2,) array indic
+00003c40: 6174 696e 6720 7468 6520 7265 6665 7265  ating the refere
+00003c50: 6e63 6520 696d 7061 6374 2070 6f69 6e74  nce impact point
+00003c60: 0a20 2020 2050 6f6c 7920 3a20 206e 702e  .    Poly :  np.
+00003c70: 6e64 6172 7261 790a 2020 2020 2020 2020  ndarray.        
+00003c80: 2832 2c4e 2920 6172 7261 7920 636f 6e74  (2,N) array cont
+00003c90: 6169 6e69 6e67 2074 6865 2063 6f6f 7264  aining the coord
+00003ca0: 696e 6174 6573 6f66 2061 2063 6c6f 7365  inatesof a close
+00003cb0: 6420 706f 6c79 676f 6e0a 2020 2020 4e50  d polygon.    NP
+00003cc0: 203a 2020 2020 696e 740a 2020 2020 2020   :    int.      
+00003cd0: 2020 4e75 6d62 6572 206f 6620 696e 6469    Number of indi
+00003ce0: 6361 7469 6e67 2074 6865 206e 756d 6265  cating the numbe
+00003cf0: 7220 6f66 2070 6f69 6e74 7320 7573 6564  r of points used
+00003d00: 2066 6f72 2064 6973 6372 6574 6973 696e   for discretisin
+00003d10: 6720 7468 6574 6120 6265 7477 6565 6e20  g theta between 
+00003d20: 3020 616e 6420 7069 0a0a 2020 2020 5265  0 and pi..    Re
+00003d30: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
+00003d40: 2d0a 2020 2020 2020 2020 7468 6574 610a  -.        theta.
+00003d50: 2020 2020 2222 220a 2020 2020 6966 2054      """.    if T
+00003d60: 6573 743a 0a20 2020 2020 2020 2061 7373  est:.        ass
+00003d70: 6572 7420 525a 2e73 697a 653d 3d32 2c20  ert RZ.size==2, 
+00003d80: 2741 7267 2052 5a20 7368 6f75 6c64 2062  'Arg RZ should b
+00003d90: 6520 6120 2832 2c29 206e 702e 6e64 6172  e a (2,) np.ndar
+00003da0: 7261 7921 270a 2020 2020 2020 2020 6173  ray!'.        as
+00003db0: 7365 7274 2050 6f6c 792e 7368 6170 655b  sert Poly.shape[
+00003dc0: 305d 3d3d 322c 2027 4172 6720 506f 6c79  0]==2, 'Arg Poly
+00003dd0: 2073 686f 756c 6420 6265 2061 2028 322c   should be a (2,
+00003de0: 4e29 206e 702e 6e64 6172 7261 7921 270a  N) np.ndarray!'.
+00003df0: 0a20 2020 2023 2054 6865 7461 2073 616d  .    # Theta sam
+00003e00: 706c 696e 6720 616e 6420 756e 6974 2076  pling and unit v
+00003e10: 6563 746f 720a 2020 2020 7468 6574 6120  ector.    theta 
+00003e20: 3d20 6e70 2e6c 696e 7370 6163 6528 302e  = np.linspace(0.
+00003e30: 2c6e 702e 7069 2c4e 502c 656e 6470 6f69  ,np.pi,NP,endpoi
+00003e40: 6e74 3d54 7275 6529 0a20 2020 2076 6563  nt=True).    vec
+00003e50: 7420 3d20 6e70 2e61 7272 6179 285b 6e70  t = np.array([np
+00003e60: 2e63 6f73 2874 6865 7461 292c 206e 702e  .cos(theta), np.
+00003e70: 7369 6e28 7468 6574 6129 5d29 0a0a 2020  sin(theta)])..  
+00003e80: 2020 2320 5363 616c 6172 2070 726f 6475    # Scalar produ
+00003e90: 6374 0a20 2020 2073 6361 203d 206e 702e  ct.    sca = np.
+00003ea0: 7375 6d28 7665 6374 5b3a 2c3a 2c6e 702e  sum(vect[:,:,np.
+00003eb0: 6e65 7761 7869 735d 2a28 506f 6c79 2d52  newaxis]*(Poly-R
+00003ec0: 5a5b 3a2c 6e70 2e6e 6577 6178 6973 5d29  Z[:,np.newaxis])
+00003ed0: 5b3a 2c6e 702e 6e65 7761 7869 732c 3a5d  [:,np.newaxis,:]
+00003ee0: 2c61 7869 733d 3029 0a20 2020 2073 6361  ,axis=0).    sca
+00003ef0: 6d69 6e20 3d20 6e70 2e6d 696e 2873 6361  min = np.min(sca
+00003f00: 2c61 7869 733d 3129 0a20 2020 2073 6361  ,axis=1).    sca
+00003f10: 6d61 7820 3d20 6e70 2e6d 6178 2873 6361  max = np.max(sca
+00003f20: 2c61 7869 733d 3129 0a20 2020 2072 6574  ,axis=1).    ret
+00003f30: 7572 6e20 7468 6574 612c 206e 702e 6172  urn theta, np.ar
+00003f40: 7261 7928 5b73 6361 6d61 782c 2073 6361  ray([scamax, sca
+00003f50: 6d69 6e5d 290a 0a0a 2320 466f 7220 7369  min])...# For si
+00003f60: 6e6f 6772 616d 730a 6465 6620 436f 6e76  nograms.def Conv
+00003f70: 6572 7449 6d70 6163 745f 5468 6574 6132  ertImpact_Theta2
+00003f80: 5869 2874 6865 7461 2c20 7050 2c20 704e  Xi(theta, pP, pN
+00003f90: 2c20 736f 7274 3d54 7275 6529 3a0a 2020  , sort=True):.  
+00003fa0: 2020 6966 2068 6173 6174 7472 2874 6865    if hasattr(the
+00003fb0: 7461 2c27 5f5f 6765 7469 7465 6d5f 5f27  ta,'__getitem__'
+00003fc0: 293a 0a20 2020 2020 2020 2070 502c 2070  ):.        pP, p
+00003fd0: 4e2c 2074 6865 7461 203d 206e 702e 6173  N, theta = np.as
+00003fe0: 6172 7261 7928 7050 292c 206e 702e 6173  array(pP), np.as
+00003ff0: 6172 7261 7928 704e 292c 206e 702e 6173  array(pN), np.as
+00004000: 6172 7261 7928 7468 6574 6129 0a20 2020  array(theta).   
+00004010: 2020 2020 2061 7373 6572 7420 7050 2e73       assert pP.s
+00004020: 6861 7065 3d3d 704e 2e73 6861 7065 3d3d  hape==pN.shape==
+00004030: 7468 6574 612e 7368 6170 652c 2028 0a20  theta.shape, (. 
+00004040: 2020 2020 2020 2020 2020 2022 4172 6773             "Args
+00004050: 2070 502c 2070 4e20 616e 6420 7468 6574   pP, pN and thet
+00004060: 6120 6d75 7374 2068 6176 6520 7361 6d65  a must have same
+00004070: 2073 6861 7065 2122 290a 2020 2020 2020   shape!").      
+00004080: 2020 7050 6269 732c 2070 4e62 6973 203d    pPbis, pNbis =
+00004090: 206e 702e 636f 7079 2870 5029 2c20 6e70   np.copy(pP), np
+000040a0: 2e63 6f70 7928 704e 290a 2020 2020 2020  .copy(pN).      
+000040b0: 2020 7869 203d 2074 6865 7461 202d 206e    xi = theta - n
+000040c0: 702e 7069 2f32 2e0a 2020 2020 2020 2020  p.pi/2..        
+000040d0: 696e 6420 3d20 7869 203c 2030 0a20 2020  ind = xi < 0.   
+000040e0: 2020 2020 2070 5062 6973 5b69 6e64 5d2c       pPbis[ind],
+000040f0: 2070 4e62 6973 5b69 6e64 5d2c 2078 695b   pNbis[ind], xi[
+00004100: 696e 645d 203d 202d 704e 5b69 6e64 5d2c  ind] = -pN[ind],
+00004110: 202d 7050 5b69 6e64 5d2c 2078 695b 696e   -pP[ind], xi[in
+00004120: 645d 2b6e 702e 7069 0a20 2020 2020 2020  d]+np.pi.       
+00004130: 2069 6620 736f 7274 3a0a 2020 2020 2020   if sort:.      
+00004140: 2020 2020 2020 696e 6420 3d20 6e70 2e61        ind = np.a
+00004150: 7267 736f 7274 2878 6929 0a20 2020 2020  rgsort(xi).     
+00004160: 2020 2020 2020 2078 692c 2070 502c 2070         xi, pP, p
+00004170: 4e20 3d20 7869 5b69 6e64 5d2c 2070 5062  N = xi[ind], pPb
+00004180: 6973 5b69 6e64 5d2c 2070 4e62 6973 5b69  is[ind], pNbis[i
+00004190: 6e64 5d0a 2020 2020 2020 2020 7265 7475  nd].        retu
+000041a0: 726e 2078 692c 2070 502c 2070 4e0a 2020  rn xi, pP, pN.  
+000041b0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000041c0: 6173 7365 7274 206e 6f74 2028 6861 7361  assert not (hasa
+000041d0: 7474 7228 7050 2c27 5f5f 6765 7469 7465  ttr(pP,'__getite
+000041e0: 6d5f 5f27 2920 6f72 2068 6173 6174 7472  m__') or hasattr
+000041f0: 2870 4e2c 275f 5f67 6574 6974 656d 5f5f  (pN,'__getitem__
+00004200: 2729 292c 2028 0a20 2020 2020 2020 2020  ')), (.         
+00004210: 2020 2022 4172 6773 2070 502c 2070 4e20     "Args pP, pN 
+00004220: 616e 6420 7468 6574 6120 6d75 7374 2068  and theta must h
+00004230: 6176 6520 7361 6d65 2073 6861 7065 2122  ave same shape!"
+00004240: 290a 2020 2020 2020 2020 7869 203d 2074  ).        xi = t
+00004250: 6865 7461 202d 206e 702e 7069 2f32 2e0a  heta - np.pi/2..
+00004260: 2020 2020 2020 2020 6966 2078 6920 3c20          if xi < 
+00004270: 302e 3a0a 2020 2020 2020 2020 2020 2020  0.:.            
+00004280: 7265 7475 726e 2078 692b 6e70 2e70 692c  return xi+np.pi,
+00004290: 202d 704e 2c20 2d70 500a 2020 2020 2020   -pN, -pP.      
+000042a0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000042b0: 2020 2020 7265 7475 726e 2078 692c 2070      return xi, p
+000042c0: 502c 2070 4e0a 0a0a 2222 220a 2323 2323  P, pN...""".####
+000042d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 000042e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 000042f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00004300: 2323 2323 2323 2323 2323 2323 2323 0a23  ##############.#
+00004300: 2323 2323 0a23 2323 2323 2323 2323 2323  ####.###########
 00004310: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00004320: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00004330: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00004340: 2323 2323 2323 230a 2320 2020 2020 2020  #######.#       
-00004350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004360: 5665 732d 7370 6563 6966 6963 0a23 2323  Ves-specific.###
-00004370: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00004380: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00004390: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000043a0: 2323 2323 230a 2323 2323 2323 2323 2323  #####.##########
+00004330: 2323 2323 2323 2323 2323 2323 230a 2323  #############.##
+00004340: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00004350: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00004360: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00004370: 2323 2323 2323 0a23 2020 2020 2020 2020  ######.#        
+00004380: 2020 2020 2020 2020 2020 2020 2020 2056                 V
+00004390: 6573 2d73 7065 6369 6669 630a 2323 2323  es-specific.####
+000043a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 000043b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 000043c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000043d0: 2323 2323 2323 2323 2323 2323 2323 0a23  ##############.#
+000043d0: 2323 2323 0a23 2323 2323 2323 2323 2323  ####.###########
 000043e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 000043f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00004400: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00004410: 2323 2323 2323 230a 2222 220a 0a0a 2323  #######."""...##
+00004400: 2323 2323 2323 2323 2323 2323 230a 2323  #############.##
+00004410: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00004420: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00004430: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00004440: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00004450: 2323 2323 2323 0a23 2323 2323 2323 2323  ######.#########
+00004440: 2323 2323 2323 0a22 2222 0a0a 0a23 2323  ######."""...###
+00004450: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00004460: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00004470: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00004480: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
-00004490: 2320 2020 2020 2020 6973 496e 7369 6465  #       isInside
-000044a0: 0a23 2323 2323 2323 2323 2323 2323 2323  .###############
-000044b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000044c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000044d0: 2323 2323 2323 2323 230a 0a0a 6465 6620  #########...def 
-000044e0: 5f56 6573 5f69 7349 6e73 6964 6528 646f  _Ves_isInside(do
-000044f0: 7562 6c65 5b3a 2c20 3a3a 315d 2070 7473  uble[:, ::1] pts
-00004500: 2c20 646f 7562 6c65 5b3a 2c20 3a3a 315d  , double[:, ::1]
-00004510: 2076 6573 5f70 6f6c 792c 0a20 2020 2020   ves_poly,.     
-00004520: 2020 2020 2020 2020 2020 2020 2064 6f75               dou
-00004530: 626c 655b 3a2c 203a 3a31 5d20 7665 735f  ble[:, ::1] ves_
-00004540: 6c69 6d73 3d4e 6f6e 652c 2069 6e74 206e  lims=None, int n
-00004550: 6c69 6d3d 302c 0a20 2020 2020 2020 2020  lim=0,.         
-00004560: 2020 2020 2020 2020 2073 7472 2076 6573           str ves
-00004570: 5f74 7970 653d 2754 6f72 272c 2073 7472  _type='Tor', str
-00004580: 2069 6e5f 666f 726d 6174 3d27 2858 2c59   in_format='(X,Y
-00004590: 2c5a 2927 2c20 6269 6e74 2074 6573 743d  ,Z)', bint test=
-000045a0: 5472 7565 293a 0a20 2020 2022 2222 0a20  True):.    """. 
-000045b0: 2020 2043 6865 636b 7320 6966 2070 6f69     Checks if poi
-000045c0: 6e74 7320 5074 7320 6172 6520 696e 2076  nts Pts are in v
-000045d0: 6573 7365 6c20 5650 6f6c 792e 0a20 2020  essel VPoly..   
-000045e0: 2056 506f 6c79 2073 686f 756c 6420 6265   VPoly should be
-000045f0: 2043 4c4f 5345 440a 2020 2020 2222 220a   CLOSED.    """.
-00004600: 2020 2020 6364 6566 2073 7472 2065 7272      cdef str err
-00004610: 5f6d 7367 0a20 2020 2063 6465 6620 7374  _msg.    cdef st
-00004620: 7220 7665 735f 7479 7065 5f6c 6f77 203d  r ves_type_low =
-00004630: 2076 6573 5f74 7970 652e 6c6f 7765 7228   ves_type.lower(
-00004640: 290a 2020 2020 6364 6566 2073 7472 2069  ).    cdef str i
-00004650: 6e5f 666f 726d 5f6c 6f77 203d 2069 6e5f  n_form_low = in_
-00004660: 666f 726d 6174 2e6c 6f77 6572 2829 0a20  format.lower(). 
-00004670: 2020 2063 6465 6620 6269 6e74 2069 735f     cdef bint is_
-00004680: 6361 7274 6573 6961 6e0a 2020 2020 6364  cartesian.    cd
-00004690: 6566 2062 696e 7420 6973 5f74 6f72 6f69  ef bint is_toroi
-000046a0: 6461 6c20 3d20 7665 735f 7479 7065 5f6c  dal = ves_type_l
-000046b0: 6f77 203d 3d20 2774 6f72 270a 2020 2020  ow == 'tor'.    
-000046c0: 6364 6566 2069 6e74 5b33 5d20 6f72 6465  cdef int[3] orde
-000046d0: 720a 2020 2020 6364 6566 206e 702e 6e64  r.    cdef np.nd
-000046e0: 6172 7261 795b 696e 742c 6e64 696d 3d31  array[int,ndim=1
-000046f0: 5d20 6973 5f69 6e73 6964 650a 2020 2020  ] is_inside.    
-00004700: 6364 6566 206c 6973 7420 696e 5f6c 6574  cdef list in_let
-00004710: 7465 7273 203d 2069 6e5f 666f 726d 5f6c  ters = in_form_l
-00004720: 6f77 2e72 6570 6c61 6365 2827 2827 2c0a  ow.replace('(',.
-00004730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004750: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00004760: 2729 2e72 6570 6c61 6365 2827 2927 2c27  ').replace(')','
-00004770: 2729 2e73 706c 6974 2827 2c27 290a 2020  ').split(',').  
-00004780: 2020 2320 7072 6570 6172 696e 6720 666f    # preparing fo
-00004790: 726d 6174 206f 6620 636f 6f72 6469 6e61  rmat of coordina
-000047a0: 7465 733a 0a20 2020 2069 735f 6361 7274  tes:.    is_cart
-000047b0: 6573 6961 6e20 3d20 616c 6c28 5b73 7320  esian = all([ss 
-000047c0: 696e 205b 2778 272c 2779 272c 277a 275d  in ['x','y','z']
-000047d0: 2066 6f72 2073 7320 696e 2069 6e5f 6c65   for ss in in_le
-000047e0: 7474 6572 735d 290a 2020 2020 6966 2069  tters]).    if i
-000047f0: 735f 6361 7274 6573 6961 6e3a 0a20 2020  s_cartesian:.   
-00004800: 2020 2020 206f 7264 6572 5b30 5d20 3d20       order[0] = 
-00004810: 696e 5f6c 6574 7465 7273 2e69 6e64 6578  in_letters.index
-00004820: 2827 7827 290a 2020 2020 2020 2020 6f72  ('x').        or
-00004830: 6465 725b 315d 203d 2069 6e5f 6c65 7474  der[1] = in_lett
-00004840: 6572 732e 696e 6465 7828 2779 2729 0a20  ers.index('y'). 
-00004850: 2020 2020 2020 206f 7264 6572 5b32 5d20         order[2] 
-00004860: 3d20 696e 5f6c 6574 7465 7273 2e69 6e64  = in_letters.ind
-00004870: 6578 2827 7a27 290a 2020 2020 656c 7365  ex('z').    else
-00004880: 3a0a 2020 2020 2020 2020 6f72 6465 725b  :.        order[
-00004890: 305d 203d 2069 6e5f 6c65 7474 6572 732e  0] = in_letters.
-000048a0: 696e 6465 7828 2772 2729 0a20 2020 2020  index('r').     
-000048b0: 2020 206f 7264 6572 5b31 5d20 3d20 696e     order[1] = in
-000048c0: 5f6c 6574 7465 7273 2e69 6e64 6578 2827  _letters.index('
-000048d0: 7a27 290a 2020 2020 2020 2020 6f72 6465  z').        orde
-000048e0: 725b 325d 203d 2069 6e5f 6c65 7474 6572  r[2] = in_letter
-000048f0: 732e 696e 6465 7828 2770 6869 2729 0a20  s.index('phi'). 
-00004900: 2020 2023 202d 2d2d 2d2d 2d2d 2d2d 2d2d     # -----------
-00004910: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00004920: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00004930: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00004940: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a  ---------------.
-00004950: 2020 2020 6966 2074 6573 743a 0a20 2020      if test:.   
-00004960: 2020 2020 2065 7272 5f6d 7367 203d 2022       err_msg = "
-00004970: 4172 6720 5650 6f6c 7920 6d75 7374 2062  Arg VPoly must b
-00004980: 6520 6120 2832 2c4e 2920 6e70 2e6e 6461  e a (2,N) np.nda
-00004990: 7272 6179 2021 220a 2020 2020 2020 2020  rray !".        
-000049a0: 6173 7365 7274 2076 6573 5f70 6f6c 792e  assert ves_poly.
-000049b0: 7368 6170 655b 305d 3d3d 322c 2065 7272  shape[0]==2, err
-000049c0: 5f6d 7367 0a20 2020 2020 2020 2065 7272  _msg.        err
-000049d0: 5f6d 7367 203d 2022 4172 6720 7665 735f  _msg = "Arg ves_
-000049e0: 7479 7065 206d 7573 7420 6265 2061 2073  type must be a s
-000049f0: 7472 2069 6e20 5b27 546f 7227 2c27 4c69  tr in ['Tor','Li
-00004a00: 6e27 5d20 2122 0a20 2020 2020 2020 2061  n'] !".        a
-00004a10: 7373 6572 7420 7665 735f 7479 7065 5f6c  ssert ves_type_l
-00004a20: 6f77 2069 6e20 5b27 746f 7227 2c27 6c69  ow in ['tor','li
-00004a30: 6e27 5d2c 2065 7272 5f6d 7367 0a20 2020  n'], err_msg.   
-00004a40: 2020 2020 2061 7373 6572 7420 6e6c 696d       assert nlim
-00004a50: 3e3d 302c 2022 6e6c 696d 2073 686f 756c  >=0, "nlim shoul
-00004a60: 6420 6265 2069 6e74 6567 6572 203e 3d20  d be integer >= 
-00004a70: 3022 0a20 2020 2020 2020 2065 7272 5f6d  0".        err_m
-00004a80: 7367 203d 2022 4e6f 2076 616c 6964 2066  sg = "No valid f
-00004a90: 6f72 6d61 742c 2079 6f75 2067 6176 6520  ormat, you gave 
-00004aa0: 3d22 202b 2069 6e5f 666f 726d 6174 0a20  =" + in_format. 
-00004ab0: 2020 2020 2020 2061 7373 6572 7420 2869         assert (i
-00004ac0: 735f 6361 7274 6573 6961 6e20 6f72 0a20  s_cartesian or. 
-00004ad0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00004ae0: 6c6c 285b 7373 2069 6e20 5b27 7227 2c20  ll([ss in ['r', 
-00004af0: 277a 272c 2027 7068 6927 5d20 666f 7220  'z', 'phi'] for 
-00004b00: 7373 2069 6e20 696e 5f6c 6574 7465 7273  ss in in_letters
-00004b10: 5d29 292c 2065 7272 5f6d 7367 0a20 2020  ])), err_msg.   
-00004b20: 2020 2020 2069 6620 6973 5f74 6f72 6f69       if is_toroi
-00004b30: 6461 6c20 616e 6420 7665 735f 6c69 6d73  dal and ves_lims
-00004b40: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-00004b50: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00004b60: 2069 735f 6361 7274 6573 6961 6e20 6f72   is_cartesian or
-00004b70: 2027 7068 6927 2069 6e20 696e 5f6c 6574   'phi' in in_let
-00004b80: 7465 7273 2c20 6572 725f 6d73 670a 2020  ters, err_msg.  
-00004b90: 2020 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d    # ------------
-00004ba0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00004bb0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00004bc0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00004bd0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20  --------------. 
-00004be0: 2020 2069 735f 696e 7369 6465 203d 206e     is_inside = n
-00004bf0: 702e 7a65 726f 7328 6d61 7828 6e6c 696d  p.zeros(max(nlim
-00004c00: 2c31 292a 7074 732e 7368 6170 655b 315d  ,1)*pts.shape[1]
-00004c10: 2c64 7479 7065 3d6e 702e 696e 7433 3229  ,dtype=np.int32)
-00004c20: 0a20 2020 205f 7274 2e69 735f 696e 7369  .    _rt.is_insi
-00004c30: 6465 5f76 6573 7365 6c28 7074 732c 2076  de_vessel(pts, v
-00004c40: 6573 5f70 6f6c 792c 2076 6573 5f6c 696d  es_poly, ves_lim
-00004c50: 732c 206e 6c69 6d2c 2069 735f 746f 726f  s, nlim, is_toro
-00004c60: 6964 616c 2c0a 2020 2020 2020 2020 2020  idal,.          
-00004c70: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00004c80: 735f 6361 7274 6573 6961 6e2c 206f 7264  s_cartesian, ord
-00004c90: 6572 2c20 6973 5f69 6e73 6964 6529 0a20  er, is_inside). 
-00004ca0: 2020 2069 6620 6e6c 696d 203d 3d20 3020     if nlim == 0 
-00004cb0: 6f72 206e 6c69 6d3d 3d31 3a0a 2020 2020  or nlim==1:.    
-00004cc0: 2020 2020 7265 7475 726e 2069 735f 696e      return is_in
-00004cd0: 7369 6465 2e61 7374 7970 6528 626f 6f6c  side.astype(bool
-00004ce0: 290a 2020 2020 7265 7475 726e 2069 735f  ).    return is_
-00004cf0: 696e 7369 6465 2e61 7374 7970 6528 626f  inside.astype(bo
-00004d00: 6f6c 292e 7265 7368 6170 6528 6e6c 696d  ol).reshape(nlim
-00004d10: 2c20 7074 732e 7368 6170 655b 315d 290a  , pts.shape[1]).
-00004d20: 0a23 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  .# =============
-00004d30: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00004d40: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00004d50: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00004480: 2323 2323 230a 2323 2323 2323 2323 2323  #####.##########
+00004490: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000044a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000044b0: 2323 2323 2323 2323 2323 2323 2323 0a23  ##############.#
+000044c0: 2020 2020 2020 2069 7349 6e73 6964 650a         isInside.
+000044d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000044e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000044f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00004500: 2323 2323 2323 2323 0a0a 0a64 6566 205f  ########...def _
+00004510: 5665 735f 6973 496e 7369 6465 2864 6f75  Ves_isInside(dou
+00004520: 626c 655b 3a2c 203a 3a31 5d20 7074 732c  ble[:, ::1] pts,
+00004530: 2064 6f75 626c 655b 3a2c 203a 3a31 5d20   double[:, ::1] 
+00004540: 7665 735f 706f 6c79 2c0a 2020 2020 2020  ves_poly,.      
+00004550: 2020 2020 2020 2020 2020 2020 646f 7562              doub
+00004560: 6c65 5b3a 2c20 3a3a 315d 2076 6573 5f6c  le[:, ::1] ves_l
+00004570: 696d 733d 4e6f 6e65 2c20 696e 7420 6e6c  ims=None, int nl
+00004580: 696d 3d30 2c0a 2020 2020 2020 2020 2020  im=0,.          
+00004590: 2020 2020 2020 2020 7374 7220 7665 735f          str ves_
+000045a0: 7479 7065 3d27 546f 7227 2c20 7374 7220  type='Tor', str 
+000045b0: 696e 5f66 6f72 6d61 743d 2728 582c 592c  in_format='(X,Y,
+000045c0: 5a29 272c 2062 696e 7420 7465 7374 3d54  Z)', bint test=T
+000045d0: 7275 6529 3a0a 2020 2020 2222 220a 2020  rue):.    """.  
+000045e0: 2020 4368 6563 6b73 2069 6620 706f 696e    Checks if poin
+000045f0: 7473 2050 7473 2061 7265 2069 6e20 7665  ts Pts are in ve
+00004600: 7373 656c 2056 506f 6c79 2e0a 2020 2020  ssel VPoly..    
+00004610: 5650 6f6c 7920 7368 6f75 6c64 2062 6520  VPoly should be 
+00004620: 434c 4f53 4544 0a20 2020 2022 2222 0a20  CLOSED.    """. 
+00004630: 2020 2063 6465 6620 7374 7220 6572 725f     cdef str err_
+00004640: 6d73 670a 2020 2020 6364 6566 2073 7472  msg.    cdef str
+00004650: 2076 6573 5f74 7970 655f 6c6f 7720 3d20   ves_type_low = 
+00004660: 7665 735f 7479 7065 2e6c 6f77 6572 2829  ves_type.lower()
+00004670: 0a20 2020 2063 6465 6620 7374 7220 696e  .    cdef str in
+00004680: 5f66 6f72 6d5f 6c6f 7720 3d20 696e 5f66  _form_low = in_f
+00004690: 6f72 6d61 742e 6c6f 7765 7228 290a 2020  ormat.lower().  
+000046a0: 2020 6364 6566 2062 696e 7420 6973 5f63    cdef bint is_c
+000046b0: 6172 7465 7369 616e 0a20 2020 2063 6465  artesian.    cde
+000046c0: 6620 6269 6e74 2069 735f 746f 726f 6964  f bint is_toroid
+000046d0: 616c 203d 2076 6573 5f74 7970 655f 6c6f  al = ves_type_lo
+000046e0: 7720 3d3d 2027 746f 7227 0a20 2020 2063  w == 'tor'.    c
+000046f0: 6465 6620 696e 745b 335d 206f 7264 6572  def int[3] order
+00004700: 0a20 2020 2063 6465 6620 6e70 2e6e 6461  .    cdef np.nda
+00004710: 7272 6179 5b69 6e74 2c6e 6469 6d3d 315d  rray[int,ndim=1]
+00004720: 2069 735f 696e 7369 6465 0a20 2020 2063   is_inside.    c
+00004730: 6465 6620 6c69 7374 2069 6e5f 6c65 7474  def list in_lett
+00004740: 6572 7320 3d20 696e 5f66 6f72 6d5f 6c6f  ers = in_form_lo
+00004750: 772e 7265 706c 6163 6528 2728 272c 0a20  w.replace('(',. 
+00004760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004780: 2020 2020 2020 2020 2020 2020 2020 2727                ''
+00004790: 292e 7265 706c 6163 6528 2729 272c 2727  ).replace(')',''
+000047a0: 292e 7370 6c69 7428 272c 2729 0a20 2020  ).split(',').   
+000047b0: 2023 2070 7265 7061 7269 6e67 2066 6f72   # preparing for
+000047c0: 6d61 7420 6f66 2063 6f6f 7264 696e 6174  mat of coordinat
+000047d0: 6573 3a0a 2020 2020 6973 5f63 6172 7465  es:.    is_carte
+000047e0: 7369 616e 203d 2061 6c6c 285b 7373 2069  sian = all([ss i
+000047f0: 6e20 5b27 7827 2c27 7927 2c27 7a27 5d20  n ['x','y','z'] 
+00004800: 666f 7220 7373 2069 6e20 696e 5f6c 6574  for ss in in_let
+00004810: 7465 7273 5d29 0a20 2020 2069 6620 6973  ters]).    if is
+00004820: 5f63 6172 7465 7369 616e 3a0a 2020 2020  _cartesian:.    
+00004830: 2020 2020 6f72 6465 725b 305d 203d 2069      order[0] = i
+00004840: 6e5f 6c65 7474 6572 732e 696e 6465 7828  n_letters.index(
+00004850: 2778 2729 0a20 2020 2020 2020 206f 7264  'x').        ord
+00004860: 6572 5b31 5d20 3d20 696e 5f6c 6574 7465  er[1] = in_lette
+00004870: 7273 2e69 6e64 6578 2827 7927 290a 2020  rs.index('y').  
+00004880: 2020 2020 2020 6f72 6465 725b 325d 203d        order[2] =
+00004890: 2069 6e5f 6c65 7474 6572 732e 696e 6465   in_letters.inde
+000048a0: 7828 277a 2729 0a20 2020 2065 6c73 653a  x('z').    else:
+000048b0: 0a20 2020 2020 2020 206f 7264 6572 5b30  .        order[0
+000048c0: 5d20 3d20 696e 5f6c 6574 7465 7273 2e69  ] = in_letters.i
+000048d0: 6e64 6578 2827 7227 290a 2020 2020 2020  ndex('r').      
+000048e0: 2020 6f72 6465 725b 315d 203d 2069 6e5f    order[1] = in_
+000048f0: 6c65 7474 6572 732e 696e 6465 7828 277a  letters.index('z
+00004900: 2729 0a20 2020 2020 2020 206f 7264 6572  ').        order
+00004910: 5b32 5d20 3d20 696e 5f6c 6574 7465 7273  [2] = in_letters
+00004920: 2e69 6e64 6578 2827 7068 6927 290a 2020  .index('phi').  
+00004930: 2020 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d    # ------------
+00004940: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00004950: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00004960: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00004970: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20  --------------. 
+00004980: 2020 2069 6620 7465 7374 3a0a 2020 2020     if test:.    
+00004990: 2020 2020 6572 725f 6d73 6720 3d20 2241      err_msg = "A
+000049a0: 7267 2056 506f 6c79 206d 7573 7420 6265  rg VPoly must be
+000049b0: 2061 2028 322c 4e29 206e 702e 6e64 6172   a (2,N) np.ndar
+000049c0: 7261 7920 2122 0a20 2020 2020 2020 2061  ray !".        a
+000049d0: 7373 6572 7420 7665 735f 706f 6c79 2e73  ssert ves_poly.s
+000049e0: 6861 7065 5b30 5d3d 3d32 2c20 6572 725f  hape[0]==2, err_
+000049f0: 6d73 670a 2020 2020 2020 2020 6572 725f  msg.        err_
+00004a00: 6d73 6720 3d20 2241 7267 2076 6573 5f74  msg = "Arg ves_t
+00004a10: 7970 6520 6d75 7374 2062 6520 6120 7374  ype must be a st
+00004a20: 7220 696e 205b 2754 6f72 272c 274c 696e  r in ['Tor','Lin
+00004a30: 275d 2021 220a 2020 2020 2020 2020 6173  '] !".        as
+00004a40: 7365 7274 2076 6573 5f74 7970 655f 6c6f  sert ves_type_lo
+00004a50: 7720 696e 205b 2774 6f72 272c 276c 696e  w in ['tor','lin
+00004a60: 275d 2c20 6572 725f 6d73 670a 2020 2020  '], err_msg.    
+00004a70: 2020 2020 6173 7365 7274 206e 6c69 6d3e      assert nlim>
+00004a80: 3d30 2c20 226e 6c69 6d20 7368 6f75 6c64  =0, "nlim should
+00004a90: 2062 6520 696e 7465 6765 7220 3e3d 2030   be integer >= 0
+00004aa0: 220a 2020 2020 2020 2020 6572 725f 6d73  ".        err_ms
+00004ab0: 6720 3d20 224e 6f20 7661 6c69 6420 666f  g = "No valid fo
+00004ac0: 726d 6174 2c20 796f 7520 6761 7665 203d  rmat, you gave =
+00004ad0: 2220 2b20 696e 5f66 6f72 6d61 740a 2020  " + in_format.  
+00004ae0: 2020 2020 2020 6173 7365 7274 2028 6973        assert (is
+00004af0: 5f63 6172 7465 7369 616e 206f 720a 2020  _cartesian or.  
+00004b00: 2020 2020 2020 2020 2020 2020 2020 616c                al
+00004b10: 6c28 5b73 7320 696e 205b 2772 272c 2027  l([ss in ['r', '
+00004b20: 7a27 2c20 2770 6869 275d 2066 6f72 2073  z', 'phi'] for s
+00004b30: 7320 696e 2069 6e5f 6c65 7474 6572 735d  s in in_letters]
+00004b40: 2929 2c20 6572 725f 6d73 670a 2020 2020  )), err_msg.    
+00004b50: 2020 2020 6966 2069 735f 746f 726f 6964      if is_toroid
+00004b60: 616c 2061 6e64 2076 6573 5f6c 696d 7320  al and ves_lims 
+00004b70: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00004b80: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00004b90: 6973 5f63 6172 7465 7369 616e 206f 7220  is_cartesian or 
+00004ba0: 2770 6869 2720 696e 2069 6e5f 6c65 7474  'phi' in in_lett
+00004bb0: 6572 732c 2065 7272 5f6d 7367 0a20 2020  ers, err_msg.   
+00004bc0: 2023 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   # -------------
+00004bd0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00004be0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00004bf0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00004c00: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020  -------------.  
+00004c10: 2020 6973 5f69 6e73 6964 6520 3d20 6e70    is_inside = np
+00004c20: 2e7a 6572 6f73 286d 6178 286e 6c69 6d2c  .zeros(max(nlim,
+00004c30: 3129 2a70 7473 2e73 6861 7065 5b31 5d2c  1)*pts.shape[1],
+00004c40: 6474 7970 653d 6e70 2e69 6e74 3332 290a  dtype=np.int32).
+00004c50: 2020 2020 5f72 742e 6973 5f69 6e73 6964      _rt.is_insid
+00004c60: 655f 7665 7373 656c 2870 7473 2c20 7665  e_vessel(pts, ve
+00004c70: 735f 706f 6c79 2c20 7665 735f 6c69 6d73  s_poly, ves_lims
+00004c80: 2c20 6e6c 696d 2c20 6973 5f74 6f72 6f69  , nlim, is_toroi
+00004c90: 6461 6c2c 0a20 2020 2020 2020 2020 2020  dal,.           
+00004ca0: 2020 2020 2020 2020 2020 2020 2020 6973                is
+00004cb0: 5f63 6172 7465 7369 616e 2c20 6f72 6465  _cartesian, orde
+00004cc0: 722c 2069 735f 696e 7369 6465 290a 2020  r, is_inside).  
+00004cd0: 2020 6966 206e 6c69 6d20 3d3d 2030 206f    if nlim == 0 o
+00004ce0: 7220 6e6c 696d 3d3d 313a 0a20 2020 2020  r nlim==1:.     
+00004cf0: 2020 2072 6574 7572 6e20 6973 5f69 6e73     return is_ins
+00004d00: 6964 652e 6173 7479 7065 2862 6f6f 6c29  ide.astype(bool)
+00004d10: 0a20 2020 2072 6574 7572 6e20 6973 5f69  .    return is_i
+00004d20: 6e73 6964 652e 6173 7479 7065 2862 6f6f  nside.astype(boo
+00004d30: 6c29 2e72 6573 6861 7065 286e 6c69 6d2c  l).reshape(nlim,
+00004d40: 2070 7473 2e73 6861 7065 5b31 5d29 0a0a   pts.shape[1])..
+00004d50: 2320 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  # ==============
 00004d60: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00004d70: 3d0a 230a 2320 2020 2020 2020 2020 2020  =.#.#           
-00004d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004d90: 2020 2020 2020 4c49 4e45 4152 204d 4553        LINEAR MES
-00004da0: 4849 4e47 0a23 2020 2020 2020 2020 2020  HING.#          
-00004db0: 2020 2020 2020 2020 2020 2020 2069 2e65               i.e
-00004dc0: 2e20 4469 7363 7265 7469 7a69 6e67 2068  . Discretizing h
-00004dd0: 6f72 697a 6f6e 7461 6c20 6c69 6e65 730a  orizontal lines.
-00004de0: 230a 2320 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  #.# ============
-00004df0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00004e00: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00004e10: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00004d70: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00004d80: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00004d90: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00004da0: 0a23 0a23 2020 2020 2020 2020 2020 2020  .#.#            
+00004db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004dc0: 2020 2020 204c 494e 4541 5220 4d45 5348       LINEAR MESH
+00004dd0: 494e 470a 2320 2020 2020 2020 2020 2020  ING.#           
+00004de0: 2020 2020 2020 2020 2020 2020 692e 652e              i.e.
+00004df0: 2044 6973 6372 6574 697a 696e 6720 686f   Discretizing ho
+00004e00: 7269 7a6f 6e74 616c 206c 696e 6573 0a23  rizontal lines.#
+00004e10: 0a23 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  .# =============
 00004e20: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00004e30: 3d3d 0a64 6566 2064 6973 6372 6574 697a  ==.def discretiz
-00004e40: 655f 6c69 6e65 3164 2864 6f75 626c 655b  e_line1d(double[
-00004e50: 3a3a 315d 204c 4d69 6e4d 6178 2c20 646f  ::1] LMinMax, do
-00004e60: 7562 6c65 2064 7374 6570 2c0a 2020 2020  uble dstep,.    
-00004e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004e80: 2020 444c 3d4e 6f6e 652c 2062 696e 7420    DL=None, bint 
-00004e90: 4c69 6d3d 5472 7565 2c0a 2020 2020 2020  Lim=True,.      
+00004e30: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00004e40: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00004e50: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00004e60: 3d0a 6465 6620 6469 7363 7265 7469 7a65  =.def discretize
+00004e70: 5f6c 696e 6531 6428 646f 7562 6c65 5b3a  _line1d(double[:
+00004e80: 3a31 5d20 4c4d 696e 4d61 782c 2064 6f75  :1] LMinMax, dou
+00004e90: 626c 6520 6473 7465 702c 0a20 2020 2020  ble dstep,.     
 00004ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004eb0: 7374 7220 6d6f 6465 3d27 6162 7327 2c20  str mode='abs', 
-00004ec0: 646f 7562 6c65 206d 6172 6769 6e3d 5f56  double margin=_V
-00004ed0: 534d 414c 4c29 3a0a 2020 2020 2222 220a  SMALL):.    """.
-00004ee0: 2020 2020 4469 7363 7265 7469 7a65 2061      Discretize a
-00004ef0: 2031 4420 7365 676d 656e 7420 4c4d 696e   1D segment LMin
-00004f00: 2d4c 4d61 782e 2049 6620 606d 6f64 6560  -LMax. If `mode`
-00004f10: 2069 7320 2261 6273 2220 2861 6273 6f6c   is "abs" (absol
-00004f20: 7574 6529 2c20 7468 656e 2074 6865 0a20  ute), then the. 
-00004f30: 2020 2073 6567 6d65 6e74 2077 696c 6c20     segment will 
-00004f40: 6265 2064 6973 6372 6574 697a 6564 2069  be discretized i
-00004f50: 6e20 6365 6c6c 7320 6561 6368 206f 6620  n cells each of 
-00004f60: 7369 7a65 2060 6473 7465 7060 2e20 456c  size `dstep`. El
-00004f70: 7365 2c20 6966 2060 6d6f 6465 600a 2020  se, if `mode`.  
-00004f80: 2020 6973 2022 7265 6c22 2028 7265 6c61    is "rel" (rela
-00004f90: 7469 7665 292c 2074 6865 206d 6573 6869  tive), the meshi
-00004fa0: 6e67 2073 7465 7020 6973 2072 656c 6174  ng step is relat
-00004fb0: 6976 6520 746f 2074 6865 2073 6567 6d65  ive to the segme
-00004fc0: 6e74 7320 6e6f 726d 2028 6965 2e0a 2020  nts norm (ie..  
-00004fd0: 2020 7468 6520 6163 7475 616c 2064 6973    the actual dis
-00004fe0: 6372 6574 697a 6174 696f 6e20 7374 6570  cretization step
-00004ff0: 2077 696c 6c20 6265 2028 4c4d 6178 202d   will be (LMax -
-00005000: 204c 4d69 6e29 2f64 7374 6570 292e 0a20   LMin)/dstep).. 
-00005010: 2020 2049 7420 6973 2070 6f73 7369 626c     It is possibl
-00005020: 6520 746f 206f 6e6c 7920 6f6e 6520 746f  e to only one to
-00005030: 2064 6973 6372 6574 697a 6520 7468 6520   discretize the 
-00005040: 7365 676d 656e 7420 6f6e 2061 2073 7562  segment on a sub
-00005050: 2d64 6f6d 6169 6e2e 2049 6620 736f 2c0a  -domain. If so,.
-00005060: 2020 2020 7468 6520 7375 622d 646f 6d61      the sub-doma
-00005070: 696e 206c 696d 6974 7320 6172 6520 6769  in limits are gi
-00005080: 7665 6e20 696e 2044 4c2e 0a20 2020 2050  ven in DL..    P
-00005090: 6172 616d 6574 6572 730a 2020 2020 3d3d  arameters.    ==
-000050a0: 3d3d 3d3d 3d3d 3d3d 0a20 2020 204c 4d69  ========.    LMi
-000050b0: 6e4d 6178 203a 2028 3229 2d64 6f75 626c  nMax : (2)-doubl
-000050c0: 6520 6172 7261 790a 2020 2020 2020 2020  e array.        
-000050d0: 4769 7665 7320 7468 6520 6c69 6d69 7473  Gives the limits
-000050e0: 204c 4d69 6e20 616e 6420 4c4d 6178 206f   LMin and LMax o
-000050f0: 6620 7468 6520 7365 676d 656e 742e 204c  f the segment. L
-00005100: 4d69 6e4d 6178 203d 205b 4c4d 696e 2c20  MinMax = [LMin, 
-00005110: 4c4d 6178 5d0a 2020 2020 6473 7465 703a  LMax].    dstep:
-00005120: 2064 6f75 626c 650a 2020 2020 2020 2020   double.        
-00005130: 5374 6570 206f 6620 6469 7363 7265 7469  Step of discreti
-00005140: 7a61 7469 6f6e 2c20 6361 6e20 6265 2061  zation, can be a
-00005150: 6273 6f6c 7574 6520 2864 6566 6175 6c74  bsolute (default
-00005160: 2920 6f72 2072 656c 6174 6976 650a 2020  ) or relative.  
-00005170: 2020 444c 203a 2028 6f70 7469 6f6e 616c    DL : (optional
-00005180: 2920 2832 292d 646f 7562 6c65 2061 7272  ) (2)-double arr
-00005190: 6179 0a20 2020 2020 2020 2053 7562 2064  ay.        Sub d
-000051a0: 6f6d 6169 6e20 6f66 2064 6973 6372 6574  omain of discret
-000051b0: 697a 6174 696f 6e2e 2049 6620 6e6f 7420  ization. If not 
-000051c0: 4e6f 6e65 2061 6e64 2069 6620 4c69 6d2c  None and if Lim,
-000051d0: 204c 4d69 6e4d 6178 203d 2044 4c0a 2020   LMinMax = DL.  
-000051e0: 2020 2020 2020 2863 616e 2062 6520 6f6e        (can be on
-000051f0: 6c79 206f 6e20 6f6e 6520 6c69 6d69 7420  ly on one limit 
-00005200: 616e 6420 6361 6e20 6265 2062 6967 6765  and can be bigge
-00005210: 7220 6f72 2073 6d61 6c6c 6572 2074 6861  r or smaller tha
-00005220: 6e20 6f72 6967 696e 616c 292e 0a20 2020  n original)..   
-00005230: 2020 2020 2041 6374 7561 6c20 6465 7369       Actual desi
-00005240: 7265 6420 6c69 6d69 7473 0a20 2020 204c  red limits.    L
-00005250: 696d 203a 2028 6f70 7469 6f6e 616c 2920  im : (optional) 
-00005260: 626f 6f6c 0a20 2020 2020 2020 2049 6e64  bool.        Ind
-00005270: 6963 6174 6564 2069 6620 7468 6520 7375  icated if the su
-00005280: 6264 6f6d 6169 6e20 7368 6f75 6c64 2062  bdomain should b
-00005290: 6520 7461 6b65 6e20 696e 746f 2061 6363  e taken into acc
-000052a0: 6f75 6e74 0a20 2020 206d 6f64 6520 3a20  ount.    mode : 
-000052b0: 286f 7074 696f 6e61 6c29 2073 7472 696e  (optional) strin
-000052c0: 670a 2020 2020 2020 2020 4966 2060 6d6f  g.        If `mo
-000052d0: 6465 6020 6973 2022 6162 7322 2028 6162  de` is "abs" (ab
-000052e0: 736f 6c75 7465 292c 2074 6865 6e20 7468  solute), then th
-000052f0: 650a 2020 2020 2020 2020 7365 676d 656e  e.        segmen
-00005300: 7420 7769 6c6c 2062 6520 6469 7363 7265  t will be discre
-00005310: 7469 7a65 6420 696e 2063 656c 6c73 2065  tized in cells e
-00005320: 6163 6820 6f66 2073 697a 6520 6064 7374  ach of size `dst
-00005330: 6570 602e 2045 6c73 652c 0a20 2020 2020  ep`. Else,.     
-00005340: 2020 2069 6620 2272 656c 2220 2872 656c     if "rel" (rel
-00005350: 6174 6976 6529 2c20 7468 6520 6d65 7368  ative), the mesh
-00005360: 696e 6720 7374 6570 2069 7320 7265 6c61  ing step is rela
-00005370: 7469 7665 2074 6f20 7468 6520 7365 676d  tive to the segm
-00005380: 656e 7473 206e 6f72 6d0a 2020 2020 2020  ents norm.      
-00005390: 2020 2874 6865 2061 6374 7561 6c20 6469    (the actual di
-000053a0: 7363 7265 7469 7a61 7469 6f6e 2073 7465  scretization ste
-000053b0: 7020 7769 6c6c 2062 6520 284c 4d61 7820  p will be (LMax 
-000053c0: 2d20 4c4d 696e 292f 6473 7465 7029 2e0a  - LMin)/dstep)..
-000053d0: 2020 2020 6d61 7267 696e 203a 2028 6f70      margin : (op
-000053e0: 7469 6f6e 616c 2920 646f 7562 6c65 0a20  tional) double. 
-000053f0: 2020 2020 2020 204d 6172 6769 6e20 7661         Margin va
-00005400: 6c75 6520 666f 7220 6365 6c6c 206c 656e  lue for cell len
-00005410: 6774 680a 2020 2020 5265 7475 726e 730a  gth.    Returns.
-00005420: 2020 2020 3d3d 3d3d 3d3d 3d0a 2020 2020      =======.    
-00005430: 6c64 6973 6372 6574 3a20 646f 7562 6c65  ldiscret: double
-00005440: 2061 7272 6179 0a20 2020 2020 2020 2061   array.        a
-00005450: 7272 6179 206f 6620 7468 6520 6469 7363  rray of the disc
-00005460: 7265 7469 7a65 6420 636f 6f72 6469 6e61  retized coordina
-00005470: 7465 7320 6f6e 2074 6865 2073 6567 6d65  tes on the segme
-00005480: 6e74 206f 6620 6465 7369 7265 6420 6c69  nt of desired li
-00005490: 6d69 7473 0a20 2020 2072 6573 6f6c 7574  mits.    resolut
-000054a0: 696f 6e3a 2064 6f75 626c 650a 2020 2020  ion: double.    
-000054b0: 2020 2020 7374 6570 206f 6620 6469 7363      step of disc
-000054c0: 7265 7469 7a61 7469 6f6e 0a20 2020 206c  retization.    l
-000054d0: 696e 6465 783a 2069 6e74 2061 7272 6179  index: int array
-000054e0: 0a20 2020 2020 2020 2061 7272 6179 206f  .        array o
-000054f0: 6620 7468 6520 696e 6469 6365 7320 636f  f the indices co
-00005500: 7272 6573 706f 6e64 696e 6720 746f 206c  rresponding to l
-00005510: 6469 7363 7265 7420 7769 7468 2072 6573  discret with res
-00005520: 7065 6374 7320 746f 2074 6865 0a20 2020  pects to the.   
-00005530: 2020 2020 206f 7269 6769 6e61 6c20 7365       original se
-00005540: 676d 656e 7420 4c4d 696e 4d61 7820 2869  gment LMinMax (i
-00005550: 6620 6e6f 2044 4c2c 2066 726f 6d20 3020  f no DL, from 0 
-00005560: 746f 204e 2d31 290a 2020 2020 4e20 3a20  to N-1).    N : 
-00005570: 696e 7436 340a 2020 2020 2020 2020 4e75  int64.        Nu
-00005580: 6d62 6572 206f 6620 706f 696e 7473 206f  mber of points o
-00005590: 6e20 4c4d 696e 4d61 7820 7365 676d 656e  n LMinMax segmen
-000055a0: 740a 2020 2020 2222 220a 2020 2020 6364  t.    """.    cd
-000055b0: 6566 2069 6e74 206d 6f64 655f 6e75 6d0a  ef int mode_num.
-000055c0: 2020 2020 6364 6566 2073 7472 2065 7272      cdef str err
-000055d0: 5f6d 6573 730a 2020 2020 6364 6566 2073  _mess.    cdef s
-000055e0: 7472 206d 6f64 655f 6c6f 7720 3d20 6d6f  tr mode_low = mo
-000055f0: 6465 2e6c 6f77 6572 2829 0a20 2020 2063  de.lower().    c
-00005600: 6465 6620 6c6f 6e67 2073 7a5f 6c64 0a20  def long sz_ld. 
-00005610: 2020 2063 6465 6620 6c6f 6e67 5b31 5d20     cdef long[1] 
-00005620: 4e0a 2020 2020 6364 6566 206c 6f6e 672a  N.    cdef long*
-00005630: 206c 696e 6465 7820 3d20 4e55 4c4c 0a20   lindex = NULL. 
-00005640: 2020 2063 6465 6620 646f 7562 6c65 2a20     cdef double* 
-00005650: 6c64 6973 6372 6574 203d 204e 554c 4c0a  ldiscret = NULL.
-00005660: 2020 2020 6364 6566 2064 6f75 626c 655b      cdef double[
-00005670: 325d 2064 6c5f 6172 7261 790a 2020 2020  2] dl_array.    
-00005680: 6364 6566 2064 6f75 626c 655b 315d 2072  cdef double[1] r
-00005690: 6573 6f6c 7574 696f 6e0a 2020 2020 2320  esolution.    # 
-000056a0: 2e2e 2e0a 2020 2020 6d6f 6465 5f6e 756d  ....    mode_num
-000056b0: 203d 205f 7374 2e67 6574 5f6e 625f 646d   = _st.get_nb_dm
-000056c0: 6f64 6528 6d6f 6465 5f6c 6f77 290a 2020  ode(mode_low).  
-000056d0: 2020 2320 2e2e 2054 6573 7469 6e67 202e    # .. Testing .
-000056e0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-000056f0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00005700: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00005710: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 0a20  ............... 
-00005720: 2020 2065 7272 5f6d 6573 7320 3d20 224d     err_mess = "M
-00005730: 6f64 6520 6861 7320 746f 2062 6520 2761  ode has to be 'a
-00005740: 6273 2720 2861 6273 6f6c 7574 6529 206f  bs' (absolute) o
-00005750: 7220 2772 656c 2720 2872 656c 6174 6976  r 'rel' (relativ
-00005760: 6529 220a 2020 2020 6173 7365 7274 206d  e)".    assert m
-00005770: 6f64 655f 6e75 6d20 3e3d 2030 2c20 6572  ode_num >= 0, er
-00005780: 725f 6d65 7373 0a20 2020 2023 202e 2e20  r_mess.    # .. 
-00005790: 7072 6570 6172 696e 6720 696e 7075 7473  preparing inputs
-000057a0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-000057b0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-000057c0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-000057d0: 2e2e 2e2e 2e2e 2e0a 2020 2020 5f73 742e  ........    _st.
-000057e0: 6379 7468 6f6e 697a 655f 7375 6264 6f6d  cythonize_subdom
-000057f0: 6169 6e5f 646c 2844 4c2c 2064 6c5f 6172  ain_dl(DL, dl_ar
-00005800: 7261 7929 2020 2320 646c 5f61 7272 6179  ray)  # dl_array
-00005810: 2069 7320 696e 6974 6961 6c69 7a65 640a   is initialized.
-00005820: 2020 2020 232e 2e20 6361 6c6c 696e 6720      #.. calling 
-00005830: 6379 7468 6f6e 2066 756e 6374 696f 6e2e  cython function.
-00005840: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00005850: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00005860: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00005870: 0a20 2020 2073 7a5f 6c64 203d 205f 7374  .    sz_ld = _st
-00005880: 2e64 6973 6372 6574 697a 655f 6c69 6e65  .discretize_line
-00005890: 3164 5f63 6f72 6528 264c 4d69 6e4d 6178  1d_core(&LMinMax
-000058a0: 5b30 5d2c 2064 7374 6570 2c20 646c 5f61  [0], dstep, dl_a
-000058b0: 7272 6179 2c20 4c69 6d2c 0a20 2020 2020  rray, Lim,.     
-000058c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000058d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000058e0: 2020 6d6f 6465 5f6e 756d 2c20 6d61 7267    mode_num, marg
-000058f0: 696e 2c20 266c 6469 7363 7265 742c 2072  in, &ldiscret, r
-00005900: 6573 6f6c 7574 696f 6e2c 0a20 2020 2020  esolution,.     
-00005910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005930: 2020 266c 696e 6465 782c 204e 290a 2020    &lindex, N).  
-00005940: 2020 232e 2e20 636f 6e76 6572 7469 6e67    #.. converting
-00005950: 2061 6e64 2072 6574 7572 6e69 6e67 2e2e   and returning..
-00005960: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00005970: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00005980: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 0a20  ............... 
-00005990: 2020 206c 645f 6172 7220 3d20 6e70 2e63     ld_arr = np.c
-000059a0: 6f70 7928 6e70 2e61 7361 7272 6179 283c  opy(np.asarray(<
-000059b0: 646f 7562 6c65 5b3a 737a 5f6c 645d 3e20  double[:sz_ld]> 
-000059c0: 6c64 6973 6372 6574 2929 0a20 2020 206c  ldiscret)).    l
-000059d0: 695f 6172 7220 3d20 6e70 2e63 6f70 7928  i_arr = np.copy(
-000059e0: 6e70 2e61 7361 7272 6179 283c 6c6f 6e67  np.asarray(<long
-000059f0: 5b3a 737a 5f6c 645d 3e6c 696e 6465 7829  [:sz_ld]>lindex)
-00005a00: 292e 6173 7479 7065 2869 6e74 290a 2020  ).astype(int).  
-00005a10: 2020 6672 6565 286c 6469 7363 7265 7429    free(ldiscret)
-00005a20: 0a20 2020 2066 7265 6528 6c69 6e64 6578  .    free(lindex
-00005a30: 290a 2020 2020 7265 7475 726e 206c 645f  ).    return ld_
-00005a40: 6172 722c 2072 6573 6f6c 7574 696f 6e5b  arr, resolution[
-00005a50: 305d 2c20 6c69 5f61 7272 2c20 4e5b 305d  0], li_arr, N[0]
-00005a60: 0a0a 0a23 203d 3d3d 3d3d 3d3d 3d3d 3d3d  ...# ===========
-00005a70: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00005a80: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00005a90: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00004eb0: 2044 4c3d 4e6f 6e65 2c20 6269 6e74 204c   DL=None, bint L
+00004ec0: 696d 3d54 7275 652c 0a20 2020 2020 2020  im=True,.       
+00004ed0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00004ee0: 7472 206d 6f64 653d 2761 6273 272c 2064  tr mode='abs', d
+00004ef0: 6f75 626c 6520 6d61 7267 696e 3d5f 5653  ouble margin=_VS
+00004f00: 4d41 4c4c 293a 0a20 2020 2022 2222 0a20  MALL):.    """. 
+00004f10: 2020 2044 6973 6372 6574 697a 6520 6120     Discretize a 
+00004f20: 3144 2073 6567 6d65 6e74 204c 4d69 6e2d  1D segment LMin-
+00004f30: 4c4d 6178 2e20 4966 2060 6d6f 6465 6020  LMax. If `mode` 
+00004f40: 6973 2022 6162 7322 2028 6162 736f 6c75  is "abs" (absolu
+00004f50: 7465 292c 2074 6865 6e20 7468 650a 2020  te), then the.  
+00004f60: 2020 7365 676d 656e 7420 7769 6c6c 2062    segment will b
+00004f70: 6520 6469 7363 7265 7469 7a65 6420 696e  e discretized in
+00004f80: 2063 656c 6c73 2065 6163 6820 6f66 2073   cells each of s
+00004f90: 697a 6520 6064 7374 6570 602e 2045 6c73  ize `dstep`. Els
+00004fa0: 652c 2069 6620 606d 6f64 6560 0a20 2020  e, if `mode`.   
+00004fb0: 2069 7320 2272 656c 2220 2872 656c 6174   is "rel" (relat
+00004fc0: 6976 6529 2c20 7468 6520 6d65 7368 696e  ive), the meshin
+00004fd0: 6720 7374 6570 2069 7320 7265 6c61 7469  g step is relati
+00004fe0: 7665 2074 6f20 7468 6520 7365 676d 656e  ve to the segmen
+00004ff0: 7473 206e 6f72 6d20 2869 652e 0a20 2020  ts norm (ie..   
+00005000: 2074 6865 2061 6374 7561 6c20 6469 7363   the actual disc
+00005010: 7265 7469 7a61 7469 6f6e 2073 7465 7020  retization step 
+00005020: 7769 6c6c 2062 6520 284c 4d61 7820 2d20  will be (LMax - 
+00005030: 4c4d 696e 292f 6473 7465 7029 2e0a 2020  LMin)/dstep)..  
+00005040: 2020 4974 2069 7320 706f 7373 6962 6c65    It is possible
+00005050: 2074 6f20 6f6e 6c79 206f 6e65 2074 6f20   to only one to 
+00005060: 6469 7363 7265 7469 7a65 2074 6865 2073  discretize the s
+00005070: 6567 6d65 6e74 206f 6e20 6120 7375 622d  egment on a sub-
+00005080: 646f 6d61 696e 2e20 4966 2073 6f2c 0a20  domain. If so,. 
+00005090: 2020 2074 6865 2073 7562 2d64 6f6d 6169     the sub-domai
+000050a0: 6e20 6c69 6d69 7473 2061 7265 2067 6976  n limits are giv
+000050b0: 656e 2069 6e20 444c 2e0a 2020 2020 5061  en in DL..    Pa
+000050c0: 7261 6d65 7465 7273 0a20 2020 203d 3d3d  rameters.    ===
+000050d0: 3d3d 3d3d 3d3d 3d0a 2020 2020 4c4d 696e  =======.    LMin
+000050e0: 4d61 7820 3a20 2832 292d 646f 7562 6c65  Max : (2)-double
+000050f0: 2061 7272 6179 0a20 2020 2020 2020 2047   array.        G
+00005100: 6976 6573 2074 6865 206c 696d 6974 7320  ives the limits 
+00005110: 4c4d 696e 2061 6e64 204c 4d61 7820 6f66  LMin and LMax of
+00005120: 2074 6865 2073 6567 6d65 6e74 2e20 4c4d   the segment. LM
+00005130: 696e 4d61 7820 3d20 5b4c 4d69 6e2c 204c  inMax = [LMin, L
+00005140: 4d61 785d 0a20 2020 2064 7374 6570 3a20  Max].    dstep: 
+00005150: 646f 7562 6c65 0a20 2020 2020 2020 2053  double.        S
+00005160: 7465 7020 6f66 2064 6973 6372 6574 697a  tep of discretiz
+00005170: 6174 696f 6e2c 2063 616e 2062 6520 6162  ation, can be ab
+00005180: 736f 6c75 7465 2028 6465 6661 756c 7429  solute (default)
+00005190: 206f 7220 7265 6c61 7469 7665 0a20 2020   or relative.   
+000051a0: 2044 4c20 3a20 286f 7074 696f 6e61 6c29   DL : (optional)
+000051b0: 2028 3229 2d64 6f75 626c 6520 6172 7261   (2)-double arra
+000051c0: 790a 2020 2020 2020 2020 5375 6220 646f  y.        Sub do
+000051d0: 6d61 696e 206f 6620 6469 7363 7265 7469  main of discreti
+000051e0: 7a61 7469 6f6e 2e20 4966 206e 6f74 204e  zation. If not N
+000051f0: 6f6e 6520 616e 6420 6966 204c 696d 2c20  one and if Lim, 
+00005200: 4c4d 696e 4d61 7820 3d20 444c 0a20 2020  LMinMax = DL.   
+00005210: 2020 2020 2028 6361 6e20 6265 206f 6e6c       (can be onl
+00005220: 7920 6f6e 206f 6e65 206c 696d 6974 2061  y on one limit a
+00005230: 6e64 2063 616e 2062 6520 6269 6767 6572  nd can be bigger
+00005240: 206f 7220 736d 616c 6c65 7220 7468 616e   or smaller than
+00005250: 206f 7269 6769 6e61 6c29 2e0a 2020 2020   original)..    
+00005260: 2020 2020 4163 7475 616c 2064 6573 6972      Actual desir
+00005270: 6564 206c 696d 6974 730a 2020 2020 4c69  ed limits.    Li
+00005280: 6d20 3a20 286f 7074 696f 6e61 6c29 2062  m : (optional) b
+00005290: 6f6f 6c0a 2020 2020 2020 2020 496e 6469  ool.        Indi
+000052a0: 6361 7465 6420 6966 2074 6865 2073 7562  cated if the sub
+000052b0: 646f 6d61 696e 2073 686f 756c 6420 6265  domain should be
+000052c0: 2074 616b 656e 2069 6e74 6f20 6163 636f   taken into acco
+000052d0: 756e 740a 2020 2020 6d6f 6465 203a 2028  unt.    mode : (
+000052e0: 6f70 7469 6f6e 616c 2920 7374 7269 6e67  optional) string
+000052f0: 0a20 2020 2020 2020 2049 6620 606d 6f64  .        If `mod
+00005300: 6560 2069 7320 2261 6273 2220 2861 6273  e` is "abs" (abs
+00005310: 6f6c 7574 6529 2c20 7468 656e 2074 6865  olute), then the
+00005320: 0a20 2020 2020 2020 2073 6567 6d65 6e74  .        segment
+00005330: 2077 696c 6c20 6265 2064 6973 6372 6574   will be discret
+00005340: 697a 6564 2069 6e20 6365 6c6c 7320 6561  ized in cells ea
+00005350: 6368 206f 6620 7369 7a65 2060 6473 7465  ch of size `dste
+00005360: 7060 2e20 456c 7365 2c0a 2020 2020 2020  p`. Else,.      
+00005370: 2020 6966 2022 7265 6c22 2028 7265 6c61    if "rel" (rela
+00005380: 7469 7665 292c 2074 6865 206d 6573 6869  tive), the meshi
+00005390: 6e67 2073 7465 7020 6973 2072 656c 6174  ng step is relat
+000053a0: 6976 6520 746f 2074 6865 2073 6567 6d65  ive to the segme
+000053b0: 6e74 7320 6e6f 726d 0a20 2020 2020 2020  nts norm.       
+000053c0: 2028 7468 6520 6163 7475 616c 2064 6973   (the actual dis
+000053d0: 6372 6574 697a 6174 696f 6e20 7374 6570  cretization step
+000053e0: 2077 696c 6c20 6265 2028 4c4d 6178 202d   will be (LMax -
+000053f0: 204c 4d69 6e29 2f64 7374 6570 292e 0a20   LMin)/dstep).. 
+00005400: 2020 206d 6172 6769 6e20 3a20 286f 7074     margin : (opt
+00005410: 696f 6e61 6c29 2064 6f75 626c 650a 2020  ional) double.  
+00005420: 2020 2020 2020 4d61 7267 696e 2076 616c        Margin val
+00005430: 7565 2066 6f72 2063 656c 6c20 6c65 6e67  ue for cell leng
+00005440: 7468 0a20 2020 2052 6574 7572 6e73 0a20  th.    Returns. 
+00005450: 2020 203d 3d3d 3d3d 3d3d 0a20 2020 206c     =======.    l
+00005460: 6469 7363 7265 743a 2064 6f75 626c 6520  discret: double 
+00005470: 6172 7261 790a 2020 2020 2020 2020 6172  array.        ar
+00005480: 7261 7920 6f66 2074 6865 2064 6973 6372  ray of the discr
+00005490: 6574 697a 6564 2063 6f6f 7264 696e 6174  etized coordinat
+000054a0: 6573 206f 6e20 7468 6520 7365 676d 656e  es on the segmen
+000054b0: 7420 6f66 2064 6573 6972 6564 206c 696d  t of desired lim
+000054c0: 6974 730a 2020 2020 7265 736f 6c75 7469  its.    resoluti
+000054d0: 6f6e 3a20 646f 7562 6c65 0a20 2020 2020  on: double.     
+000054e0: 2020 2073 7465 7020 6f66 2064 6973 6372     step of discr
+000054f0: 6574 697a 6174 696f 6e0a 2020 2020 6c69  etization.    li
+00005500: 6e64 6578 3a20 696e 7420 6172 7261 790a  ndex: int array.
+00005510: 2020 2020 2020 2020 6172 7261 7920 6f66          array of
+00005520: 2074 6865 2069 6e64 6963 6573 2063 6f72   the indices cor
+00005530: 7265 7370 6f6e 6469 6e67 2074 6f20 6c64  responding to ld
+00005540: 6973 6372 6574 2077 6974 6820 7265 7370  iscret with resp
+00005550: 6563 7473 2074 6f20 7468 650a 2020 2020  ects to the.    
+00005560: 2020 2020 6f72 6967 696e 616c 2073 6567      original seg
+00005570: 6d65 6e74 204c 4d69 6e4d 6178 2028 6966  ment LMinMax (if
+00005580: 206e 6f20 444c 2c20 6672 6f6d 2030 2074   no DL, from 0 t
+00005590: 6f20 4e2d 3129 0a20 2020 204e 203a 2069  o N-1).    N : i
+000055a0: 6e74 3634 0a20 2020 2020 2020 204e 756d  nt64.        Num
+000055b0: 6265 7220 6f66 2070 6f69 6e74 7320 6f6e  ber of points on
+000055c0: 204c 4d69 6e4d 6178 2073 6567 6d65 6e74   LMinMax segment
+000055d0: 0a20 2020 2022 2222 0a20 2020 2063 6465  .    """.    cde
+000055e0: 6620 696e 7420 6d6f 6465 5f6e 756d 0a20  f int mode_num. 
+000055f0: 2020 2063 6465 6620 7374 7220 6572 725f     cdef str err_
+00005600: 6d65 7373 0a20 2020 2063 6465 6620 7374  mess.    cdef st
+00005610: 7220 6d6f 6465 5f6c 6f77 203d 206d 6f64  r mode_low = mod
+00005620: 652e 6c6f 7765 7228 290a 2020 2020 6364  e.lower().    cd
+00005630: 6566 206c 6f6e 6720 737a 5f6c 640a 2020  ef long sz_ld.  
+00005640: 2020 6364 6566 206c 6f6e 675b 315d 204e    cdef long[1] N
+00005650: 0a20 2020 2063 6465 6620 6c6f 6e67 2a20  .    cdef long* 
+00005660: 6c69 6e64 6578 203d 204e 554c 4c0a 2020  lindex = NULL.  
+00005670: 2020 6364 6566 2064 6f75 626c 652a 206c    cdef double* l
+00005680: 6469 7363 7265 7420 3d20 4e55 4c4c 0a20  discret = NULL. 
+00005690: 2020 2063 6465 6620 646f 7562 6c65 5b32     cdef double[2
+000056a0: 5d20 646c 5f61 7272 6179 0a20 2020 2063  ] dl_array.    c
+000056b0: 6465 6620 646f 7562 6c65 5b31 5d20 7265  def double[1] re
+000056c0: 736f 6c75 7469 6f6e 0a20 2020 2023 202e  solution.    # .
+000056d0: 2e2e 0a20 2020 206d 6f64 655f 6e75 6d20  ...    mode_num 
+000056e0: 3d20 5f73 742e 6765 745f 6e62 5f64 6d6f  = _st.get_nb_dmo
+000056f0: 6465 286d 6f64 655f 6c6f 7729 0a20 2020  de(mode_low).   
+00005700: 2023 202e 2e20 5465 7374 696e 6720 2e2e   # .. Testing ..
+00005710: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00005720: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00005730: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00005740: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e0a 2020  ..............  
+00005750: 2020 6572 725f 6d65 7373 203d 2022 4d6f    err_mess = "Mo
+00005760: 6465 2068 6173 2074 6f20 6265 2027 6162  de has to be 'ab
+00005770: 7327 2028 6162 736f 6c75 7465 2920 6f72  s' (absolute) or
+00005780: 2027 7265 6c27 2028 7265 6c61 7469 7665   'rel' (relative
+00005790: 2922 0a20 2020 2061 7373 6572 7420 6d6f  )".    assert mo
+000057a0: 6465 5f6e 756d 203e 3d20 302c 2065 7272  de_num >= 0, err
+000057b0: 5f6d 6573 730a 2020 2020 2320 2e2e 2070  _mess.    # .. p
+000057c0: 7265 7061 7269 6e67 2069 6e70 7574 732e  reparing inputs.
+000057d0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+000057e0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+000057f0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00005800: 2e2e 2e2e 2e2e 0a20 2020 205f 7374 2e63  .......    _st.c
+00005810: 7974 686f 6e69 7a65 5f73 7562 646f 6d61  ythonize_subdoma
+00005820: 696e 5f64 6c28 444c 2c20 646c 5f61 7272  in_dl(DL, dl_arr
+00005830: 6179 2920 2023 2064 6c5f 6172 7261 7920  ay)  # dl_array 
+00005840: 6973 2069 6e69 7469 616c 697a 6564 0a20  is initialized. 
+00005850: 2020 2023 2e2e 2063 616c 6c69 6e67 2063     #.. calling c
+00005860: 7974 686f 6e20 6675 6e63 7469 6f6e 2e2e  ython function..
+00005870: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00005880: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00005890: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e0a  ................
+000058a0: 2020 2020 737a 5f6c 6420 3d20 5f73 742e      sz_ld = _st.
+000058b0: 6469 7363 7265 7469 7a65 5f6c 696e 6531  discretize_line1
+000058c0: 645f 636f 7265 2826 4c4d 696e 4d61 785b  d_core(&LMinMax[
+000058d0: 305d 2c20 6473 7465 702c 2064 6c5f 6172  0], dstep, dl_ar
+000058e0: 7261 792c 204c 696d 2c0a 2020 2020 2020  ray, Lim,.      
+000058f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005910: 206d 6f64 655f 6e75 6d2c 206d 6172 6769   mode_num, margi
+00005920: 6e2c 2026 6c64 6973 6372 6574 2c20 7265  n, &ldiscret, re
+00005930: 736f 6c75 7469 6f6e 2c0a 2020 2020 2020  solution,.      
+00005940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005960: 2026 6c69 6e64 6578 2c20 4e29 0a20 2020   &lindex, N).   
+00005970: 2023 2e2e 2063 6f6e 7665 7274 696e 6720   #.. converting 
+00005980: 616e 6420 7265 7475 726e 696e 672e 2e2e  and returning...
+00005990: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+000059a0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+000059b0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e0a 2020  ..............  
+000059c0: 2020 6c64 5f61 7272 203d 206e 702e 636f    ld_arr = np.co
+000059d0: 7079 286e 702e 6173 6172 7261 7928 3c64  py(np.asarray(<d
+000059e0: 6f75 626c 655b 3a73 7a5f 6c64 5d3e 206c  ouble[:sz_ld]> l
+000059f0: 6469 7363 7265 7429 290a 2020 2020 6c69  discret)).    li
+00005a00: 5f61 7272 203d 206e 702e 636f 7079 286e  _arr = np.copy(n
+00005a10: 702e 6173 6172 7261 7928 3c6c 6f6e 675b  p.asarray(<long[
+00005a20: 3a73 7a5f 6c64 5d3e 6c69 6e64 6578 2929  :sz_ld]>lindex))
+00005a30: 2e61 7374 7970 6528 696e 7429 0a20 2020  .astype(int).   
+00005a40: 2066 7265 6528 6c64 6973 6372 6574 290a   free(ldiscret).
+00005a50: 2020 2020 6672 6565 286c 696e 6465 7829      free(lindex)
+00005a60: 0a20 2020 2072 6574 7572 6e20 6c64 5f61  .    return ld_a
+00005a70: 7272 2c20 7265 736f 6c75 7469 6f6e 5b30  rr, resolution[0
+00005a80: 5d2c 206c 695f 6172 722c 204e 5b30 5d0a  ], li_arr, N[0].
+00005a90: 0a0a 2320 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ..# ============
 00005aa0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00005ab0: 3d3d 3d0a 230a 2320 2020 2020 2020 2020  ===.#.#         
-00005ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005ad0: 2020 2020 2020 2020 2020 3244 204d 4553            2D MES
-00005ae0: 4849 4e47 0a23 2020 2020 2020 2020 2020  HING.#          
+00005ab0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00005ac0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00005ad0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00005ae0: 3d3d 0a23 0a23 2020 2020 2020 2020 2020  ==.#.#          
 00005af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005b00: 2069 2e65 2e20 4469 7363 7265 7469 7a69   i.e. Discretizi
-00005b10: 6e67 2070 6f6c 7967 6f6e 730a 230a 2320  ng polygons.#.# 
-00005b20: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00005b30: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00005b40: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00005b00: 2020 2020 2020 2020 2032 4420 4d45 5348           2D MESH
+00005b10: 494e 470a 2320 2020 2020 2020 2020 2020  ING.#           
+00005b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005b30: 692e 652e 2044 6973 6372 6574 697a 696e  i.e. Discretizin
+00005b40: 6720 706f 6c79 676f 6e73 0a23 0a23 203d  g polygons.#.# =
 00005b50: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00005b60: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 0a64  ==============.d
-00005b70: 6566 2064 6973 6372 6574 697a 655f 7365  ef discretize_se
-00005b80: 676d 656e 7432 6428 646f 7562 6c65 5b3a  gment2d(double[:
-00005b90: 3a31 5d20 4c4d 696e 4d61 7831 2c20 646f  :1] LMinMax1, do
-00005ba0: 7562 6c65 5b3a 3a31 5d20 4c4d 696e 4d61  uble[::1] LMinMa
-00005bb0: 7832 2c0a 2020 2020 2020 2020 2020 2020  x2,.            
-00005bc0: 2020 2020 2020 2020 2020 2020 2064 6f75               dou
-00005bd0: 626c 6520 6473 7465 7031 2c20 646f 7562  ble dstep1, doub
-00005be0: 6c65 2064 7374 6570 322c 0a20 2020 2020  le dstep2,.     
-00005bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005c00: 2020 2020 4431 3d4e 6f6e 652c 0a20 2020      D1=None,.   
-00005c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005c20: 2020 2020 2020 4432 3d4e 6f6e 652c 0a20        D2=None,. 
-00005c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005c40: 2020 2020 2020 2020 7374 7220 6d6f 6465          str mode
-00005c50: 3d27 6162 7327 2c0a 2020 2020 2020 2020  ='abs',.        
+00005b60: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00005b70: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00005b80: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00005b90: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 6465  =============.de
+00005ba0: 6620 6469 7363 7265 7469 7a65 5f73 6567  f discretize_seg
+00005bb0: 6d65 6e74 3264 2864 6f75 626c 655b 3a3a  ment2d(double[::
+00005bc0: 315d 204c 4d69 6e4d 6178 312c 2064 6f75  1] LMinMax1, dou
+00005bd0: 626c 655b 3a3a 315d 204c 4d69 6e4d 6178  ble[::1] LMinMax
+00005be0: 322c 0a20 2020 2020 2020 2020 2020 2020  2,.             
+00005bf0: 2020 2020 2020 2020 2020 2020 646f 7562              doub
+00005c00: 6c65 2064 7374 6570 312c 2064 6f75 626c  le dstep1, doubl
+00005c10: 6520 6473 7465 7032 2c0a 2020 2020 2020  e dstep2,.      
+00005c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005c30: 2020 2044 313d 4e6f 6e65 2c0a 2020 2020     D1=None,.    
+00005c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005c50: 2020 2020 2044 323d 4e6f 6e65 2c0a 2020       D2=None,.  
 00005c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005c70: 2064 6f75 626c 655b 3a2c 3a3a 315d 2056   double[:,::1] V
-00005c80: 506f 6c79 3d4e 6f6e 652c 0a20 2020 2020  Poly=None,.     
+00005c70: 2020 2020 2020 2073 7472 206d 6f64 653d         str mode=
+00005c80: 2761 6273 272c 0a20 2020 2020 2020 2020  'abs',.         
 00005c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005ca0: 2020 2020 646f 7562 6c65 206d 6172 6769      double margi
-00005cb0: 6e3d 5f56 534d 414c 4c29 3a0a 2020 2020  n=_VSMALL):.    
-00005cc0: 2222 220a 2020 2020 4469 7363 7265 7469  """.    Discreti
-00005cd0: 7a65 7320 6120 3244 2073 6567 6d65 6e74  zes a 2D segment
-00005ce0: 2077 6865 7265 2074 6865 2031 7374 2063   where the 1st c
-00005cf0: 6f6f 7264 696e 6174 6573 2061 7265 2064  oordinates are d
-00005d00: 6566 696e 6564 2069 6e20 4c4d 696e 4d61  efined in LMinMa
-00005d10: 7831 0a20 2020 2061 6e64 2074 6865 2073  x1.    and the s
-00005d20: 6563 6f6e 6420 6f6e 6573 2069 6e20 4c4d  econd ones in LM
-00005d30: 696e 4d61 7832 2e20 5468 6520 7265 6669  inMax2. The refi
-00005d40: 6e65 6d65 6e74 2069 6e20 7820 6973 2064  nement in x is d
-00005d50: 6566 696e 6564 2062 7920 6473 7465 7031  efined by dstep1
-00005d60: 2c0a 2020 2020 616e 6420 6473 7465 7032  ,.    and dstep2
-00005d70: 2064 6566 696e 6573 2074 6865 2072 6573   defines the res
-00005d80: 6f6c 7574 696f 6e20 6f6e 2079 2e0a 2020  olution on y..  
-00005d90: 2020 4f70 7469 6f6e 6e61 6c6c 7920 796f    Optionnally yo
-00005da0: 7520 6361 6e20 6769 7665 2061 2056 506f  u can give a VPo
-00005db0: 6c79 2074 6f20 7768 6963 6820 7468 6520  ly to which the 
-00005dc0: 6469 7363 7265 7469 7a65 6420 696e 2077  discretized in w
-00005dd0: 6869 6368 2074 6865 0a20 2020 2073 6567  hich the.    seg
-00005de0: 6d65 6e74 2068 6173 2074 6f20 6265 2069  ment has to be i
-00005df0: 6e63 6c75 6465 642e 0a20 2020 2054 6869  ncluded..    Thi
-00005e00: 7320 6675 6e63 7469 6f6e 2069 7320 6261  s function is ba
-00005e10: 7369 6361 6c6c 7920 6120 6765 6e65 7261  sically a genera
-00005e20: 6c69 7a61 7469 6f6e 206f 6620 6469 7363  lization of disc
-00005e30: 7265 7469 7a65 5f6c 696e 6531 642e 0a20  retize_line1d.. 
-00005e40: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
-00005e50: 2020 3d3d 3d3d 3d3d 3d3d 3d3d 0a20 2020    ==========.   
-00005e60: 204c 4d69 6e4d 6178 3120 3a20 2832 292d   LMinMax1 : (2)-
-00005e70: 646f 7562 6c65 2061 7272 6179 0a20 2020  double array.   
-00005e80: 2020 2020 2047 6976 6573 2074 6865 206c       Gives the l
-00005e90: 696d 6974 7320 4c4d 696e 2061 6e64 204c  imits LMin and L
-00005ea0: 4d61 7820 6f66 2074 6865 2078 2063 6f6f  Max of the x coo
-00005eb0: 7264 696e 6174 6573 206f 6620 7468 6520  rdinates of the 
-00005ec0: 7365 676d 656e 742e 0a20 2020 2020 2020  segment..       
-00005ed0: 204c 4d69 6e4d 6178 3120 3d20 5b78 6d69   LMinMax1 = [xmi
-00005ee0: 6e2c 2078 6d61 785d 0a20 2020 204c 4d69  n, xmax].    LMi
-00005ef0: 6e4d 6178 3220 3a20 2832 292d 646f 7562  nMax2 : (2)-doub
-00005f00: 6c65 2061 7272 6179 0a20 2020 2020 2020  le array.       
-00005f10: 2047 6976 6573 2074 6865 206c 696d 6974   Gives the limit
-00005f20: 7320 4c4d 696e 2061 6e64 204c 4d61 7820  s LMin and LMax 
-00005f30: 6f66 2074 6865 2079 2063 6f6f 7264 696e  of the y coordin
-00005f40: 6174 6573 206f 6620 7468 6520 7365 676d  ates of the segm
-00005f50: 656e 742e 0a20 2020 2020 2020 204c 4d69  ent..        LMi
-00005f60: 6e4d 6178 3220 3d20 5b79 6d69 6e2c 2079  nMax2 = [ymin, y
-00005f70: 6d61 785d 0a20 2020 2064 7374 6570 3120  max].    dstep1 
-00005f80: 6f72 2064 7374 6570 3220 3a20 646f 7562  or dstep2 : doub
-00005f90: 6c65 0a20 2020 2020 2020 2053 7465 7020  le.        Step 
-00005fa0: 6f66 2064 6973 6372 6574 697a 6174 696f  of discretizatio
-00005fb0: 6e2c 2063 616e 2062 6520 6162 736f 6c75  n, can be absolu
-00005fc0: 7465 2028 6465 6661 756c 7429 206f 7220  te (default) or 
-00005fd0: 7265 6c61 7469 7665 0a20 2020 2044 3120  relative.    D1 
-00005fe0: 6f72 2044 3220 3a20 286f 7074 696f 6e61  or D2 : (optiona
-00005ff0: 6c29 2028 3229 2d64 6f75 626c 6520 6172  l) (2)-double ar
-00006000: 7261 790a 2020 2020 2020 2020 5375 6220  ray.        Sub 
-00006010: 646f 6d61 696e 206f 6620 6469 7363 7265  domain of discre
-00006020: 7469 7a61 7469 6f6e 2e20 4966 206e 6f74  tization. If not
-00006030: 204e 6f6e 6520 616e 6420 6966 204c 696d   None and if Lim
-00006040: 2c20 4c4d 696e 4d61 7820 3d20 444c 0a20  , LMinMax = DL. 
-00006050: 2020 2020 2020 2028 6361 6e20 6265 206f         (can be o
-00006060: 6e6c 7920 6f6e 206f 6e65 206c 696d 6974  nly on one limit
-00006070: 2061 6e64 2063 616e 2062 6520 6269 6767   and can be bigg
-00006080: 6572 206f 7220 736d 616c 6c65 7220 7468  er or smaller th
-00006090: 616e 206f 7269 6769 6e61 6c29 2e0a 2020  an original)..  
-000060a0: 2020 2020 2020 4163 7475 616c 2064 6573        Actual des
-000060b0: 6972 6564 206c 696d 6974 730a 2020 2020  ired limits.    
-000060c0: 6d6f 6465 203a 2028 6f70 7469 6f6e 616c  mode : (optional
-000060d0: 2920 7374 7269 6e67 0a20 2020 2020 2020  ) string.       
-000060e0: 2049 6620 606d 6f64 6560 2069 7320 2261   If `mode` is "a
-000060f0: 6273 2220 2861 6273 6f6c 7574 6529 2c20  bs" (absolute), 
-00006100: 7468 656e 2074 6865 0a20 2020 2020 2020  then the.       
-00006110: 2073 6567 6d65 6e74 2077 696c 6c20 6265   segment will be
-00006120: 2064 6973 6372 6574 697a 6564 2069 6e20   discretized in 
-00006130: 6365 6c6c 7320 6561 6368 206f 6620 7369  cells each of si
-00006140: 7a65 2060 6473 7465 7060 2e20 456c 7365  ze `dstep`. Else
-00006150: 2c0a 2020 2020 2020 2020 6966 2022 7265  ,.        if "re
-00006160: 6c22 2028 7265 6c61 7469 7665 292c 2074  l" (relative), t
-00006170: 6865 206d 6573 6869 6e67 2073 7465 7020  he meshing step 
-00006180: 6973 2072 656c 6174 6976 6520 746f 2074  is relative to t
-00006190: 6865 2073 6567 6d65 6e74 7320 6e6f 726d  he segments norm
-000061a0: 0a20 2020 2020 2020 2028 7468 6520 6163  .        (the ac
-000061b0: 7475 616c 2064 6973 6372 6574 697a 6174  tual discretizat
-000061c0: 696f 6e20 7374 6570 2077 696c 6c20 6265  ion step will be
-000061d0: 2028 4c4d 6178 202d 204c 4d69 6e29 2f64   (LMax - LMin)/d
-000061e0: 7374 6570 292e 0a20 2020 206d 6172 6769  step)..    margi
-000061f0: 6e20 3a20 286f 7074 696f 6e61 6c29 2064  n : (optional) d
-00006200: 6f75 626c 650a 2020 2020 2020 2020 4d61  ouble.        Ma
-00006210: 7267 696e 2076 616c 7565 2066 6f72 2063  rgin value for c
-00006220: 656c 6c20 6c65 6e67 7468 0a20 2020 2056  ell length.    V
-00006230: 506f 6c79 203a 2028 6f70 7469 6f6e 616c  Poly : (optional
-00006240: 2920 3264 2064 6f75 626c 6520 6172 7261  ) 2d double arra
-00006250: 790a 2020 2020 2020 2020 4966 2070 7265  y.        If pre
-00006260: 7365 6e74 2c20 7765 2063 6865 636b 2074  sent, we check t
-00006270: 6861 7420 7468 6520 6469 7363 7265 7469  hat the discreti
-00006280: 7a65 6420 7365 676d 656e 7420 6973 2069  zed segment is i
-00006290: 6e63 6c75 6465 6420 696e 2074 6865 0a20  ncluded in the. 
-000062a0: 2020 2020 2020 2070 6174 6820 6465 6669         path defi
-000062b0: 6e65 6420 6279 2056 506f 6c79 2e0a 2020  ned by VPoly..  
-000062c0: 2020 5265 7475 726e 730a 2020 2020 3d3d    Returns.    ==
-000062d0: 3d3d 3d3d 3d0a 2020 2020 6c64 6973 6372  =====.    ldiscr
-000062e0: 6574 3a20 646f 7562 6c65 2032 6420 6172  et: double 2d ar
-000062f0: 7261 790a 2020 2020 2020 2020 6172 7261  ray.        arra
-00006300: 7920 6f66 2074 6865 2064 6973 6372 6574  y of the discret
-00006310: 697a 6564 2063 6f6f 7264 696e 6174 6573  ized coordinates
-00006320: 206f 6e20 7468 6520 7365 676d 656e 7420   on the segment 
-00006330: 6f66 2064 6573 6972 6564 206c 696d 6974  of desired limit
-00006340: 730a 2020 2020 7265 736f 6c75 7469 6f6e  s.    resolution
-00006350: 3a20 646f 7562 6c65 2061 7272 6179 0a20  : double array. 
-00006360: 2020 2020 2020 2073 7465 7020 6f66 2064         step of d
-00006370: 6973 6372 6574 697a 6174 696f 6e20 6f6e  iscretization on
-00006380: 2032 6420 2874 7970 6963 616c 6c79 2072   2d (typically r
-00006390: 6573 6f6c 7574 696f 6e2d 6f6e 2d78 2a72  esolution-on-x*r
-000063a0: 6573 6f6c 7574 696f 6e2d 6f6e 2d79 290a  esolution-on-y).
-000063b0: 2020 2020 6c69 6e64 6578 3a20 696e 7420      lindex: int 
-000063c0: 6172 7261 790a 2020 2020 2020 2020 6172  array.        ar
-000063d0: 7261 7920 6f66 2074 6865 2069 6e64 6963  ray of the indic
-000063e0: 6573 2063 6f72 7265 7370 6f6e 6469 6e67  es corresponding
-000063f0: 2074 6f20 6c64 6973 6372 6574 2077 6974   to ldiscret wit
-00006400: 6820 7265 7370 6563 7473 2074 6f20 7468  h respects to th
-00006410: 650a 2020 2020 2020 2020 6f72 6967 696e  e.        origin
-00006420: 616c 2073 6567 6d65 6e74 204c 4d69 6e4d  al segment LMinM
-00006430: 6178 2028 6966 206e 6f20 444c 2c20 6672  ax (if no DL, fr
-00006440: 6f6d 2030 2074 6f20 4e2d 3129 0a20 2020  om 0 to N-1).   
-00006450: 2072 6573 6f6c 3120 3a20 646f 7562 6c65   resol1 : double
-00006460: 0a20 2020 2020 2020 2053 6d61 6c6c 6573  .        Smalles
-00006470: 7420 7265 736f 6c75 7469 6f6e 206f 6e20  t resolution on 
-00006480: 780a 2020 2020 7265 736f 6c32 203a 2064  x.    resol2 : d
-00006490: 6f75 626c 650a 2020 2020 2020 2020 536d  ouble.        Sm
-000064a0: 616c 6c65 7374 2072 6573 6f6c 7574 696f  allest resolutio
-000064b0: 6e20 6f6e 2079 0a20 2020 2022 2222 0a20  n on y.    """. 
-000064c0: 2020 2063 6465 6620 696e 7420 6e6e 0a20     cdef int nn. 
-000064d0: 2020 2063 6465 6620 696e 7420 6e64 6973     cdef int ndis
-000064e0: 630a 2020 2020 6364 6566 2069 6e74 2069  c.    cdef int i
-000064f0: 692c 206a 6a0a 2020 2020 6364 6566 2069  i, jj.    cdef i
-00006500: 6e74 2074 6f74 5f74 7275 650a 2020 2020  nt tot_true.    
-00006510: 6364 6566 2069 6e74 206d 6f64 655f 6e75  cdef int mode_nu
-00006520: 6d0a 2020 2020 6364 6566 2069 6e74 206e  m.    cdef int n
-00006530: 756d 5f70 7473 5f76 706f 6c79 0a20 2020  um_pts_vpoly.   
-00006540: 2063 6465 6620 7374 7220 6572 725f 6d65   cdef str err_me
-00006550: 7373 0a20 2020 2063 6465 6620 7374 7220  ss.    cdef str 
-00006560: 6d6f 6465 5f6c 6f77 203d 206d 6f64 652e  mode_low = mode.
-00006570: 6c6f 7765 7228 290a 2020 2020 6364 6566  lower().    cdef
-00006580: 206c 6f6e 6720 6e69 6e64 310a 2020 2020   long nind1.    
-00006590: 6364 6566 206c 6f6e 6720 6e69 6e64 320a  cdef long nind2.
-000065a0: 2020 2020 6364 6566 206c 6f6e 675b 315d      cdef long[1]
-000065b0: 206e 6365 6c6c 7331 0a20 2020 2063 6465   ncells1.    cde
-000065c0: 6620 6c6f 6e67 5b31 5d20 6e63 656c 6c73  f long[1] ncells
-000065d0: 320a 2020 2020 6364 6566 2064 6f75 626c  2.    cdef doubl
-000065e0: 655b 325d 2064 6c31 5f61 7272 6179 0a20  e[2] dl1_array. 
-000065f0: 2020 2063 6465 6620 646f 7562 6c65 5b32     cdef double[2
-00006600: 5d20 646c 325f 6172 7261 790a 2020 2020  ] dl2_array.    
-00006610: 6364 6566 2064 6f75 626c 655b 325d 2072  cdef double[2] r
-00006620: 6573 6f6c 7574 696f 6e73 0a20 2020 2063  esolutions.    c
-00006630: 6465 6620 6c6f 6e67 5b3a 5d20 6c69 6e64  def long[:] lind
-00006640: 6578 5f76 6965 770a 2020 2020 6364 6566  ex_view.    cdef
-00006650: 2064 6f75 626c 655b 3a5d 206c 7265 736f   double[:] lreso
-00006660: 6c5f 7669 6577 0a20 2020 2063 6465 6620  l_view.    cdef 
-00006670: 646f 7562 6c65 5b3a 2c3a 5d20 6c64 6973  double[:,:] ldis
-00006680: 6372 5f76 6965 770a 2020 2020 6364 6566  cr_view.    cdef
-00006690: 2069 6e74 2a20 6172 655f 696e 5f70 6f6c   int* are_in_pol
-000066a0: 7920 3d20 4e55 4c4c 0a20 2020 2063 6465  y = NULL.    cde
-000066b0: 6620 6c6f 6e67 2a20 6c69 6e64 6578 315f  f long* lindex1_
-000066c0: 6172 7220 3d20 4e55 4c4c 0a20 2020 2063  arr = NULL.    c
-000066d0: 6465 6620 6c6f 6e67 2a20 6c69 6e64 6578  def long* lindex
-000066e0: 325f 6172 7220 3d20 4e55 4c4c 0a20 2020  2_arr = NULL.   
-000066f0: 2063 6465 6620 6c6f 6e67 2a20 6c69 6e64   cdef long* lind
-00006700: 6578 5f74 6d70 2020 3d20 4e55 4c4c 0a20  ex_tmp  = NULL. 
-00006710: 2020 2063 6465 6620 646f 7562 6c65 2a20     cdef double* 
-00006720: 6c64 6973 6372 5f74 6d70 203d 204e 554c  ldiscr_tmp = NUL
-00006730: 4c0a 2020 2020 6364 6566 2064 6f75 626c  L.    cdef doubl
-00006740: 652a 206c 6469 7363 7265 7431 5f61 7272  e* ldiscret1_arr
-00006750: 203d 204e 554c 4c0a 2020 2020 6364 6566   = NULL.    cdef
-00006760: 2064 6f75 626c 652a 206c 6469 7363 7265   double* ldiscre
-00006770: 7432 5f61 7272 203d 204e 554c 4c0a 2020  t2_arr = NULL.  
-00006780: 2020 6364 6566 206e 702e 6e64 6172 7261    cdef np.ndarra
-00006790: 795b 646f 7562 6c65 2c6e 6469 6d3d 325d  y[double,ndim=2]
-000067a0: 206c 6469 7363 720a 2020 2020 6364 6566   ldiscr.    cdef
-000067b0: 206e 702e 6e64 6172 7261 795b 646f 7562   np.ndarray[doub
-000067c0: 6c65 2c6e 6469 6d3d 315d 206c 7265 736f  le,ndim=1] lreso
-000067d0: 6c0a 2020 2020 6364 6566 206e 702e 6e64  l.    cdef np.nd
-000067e0: 6172 7261 795b 6c6f 6e67 2c6e 6469 6d3d  array[long,ndim=
-000067f0: 315d 206c 696e 6465 780a 2020 2020 2320  1] lindex.    # 
-00006800: 2e2e 2e0a 2020 2020 6d6f 6465 5f6e 756d  ....    mode_num
-00006810: 203d 205f 7374 2e67 6574 5f6e 625f 646d   = _st.get_nb_dm
-00006820: 6f64 6528 6d6f 6465 5f6c 6f77 290a 2020  ode(mode_low).  
-00006830: 2020 2320 2e2e 2054 6573 7469 6e67 202e    # .. Testing .
-00006840: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00006850: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00006860: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00006870: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 0a20  ............... 
-00006880: 2020 2065 7272 5f6d 6573 7320 3d20 224d     err_mess = "M
-00006890: 6f64 6520 6861 7320 746f 2062 6520 2761  ode has to be 'a
-000068a0: 6273 2720 2861 6273 6f6c 7574 6529 206f  bs' (absolute) o
-000068b0: 7220 2772 656c 2720 2872 656c 6174 6976  r 'rel' (relativ
-000068c0: 6529 220a 2020 2020 6173 7365 7274 206d  e)".    assert m
-000068d0: 6f64 655f 6e75 6d20 3e3d 2030 2c20 6572  ode_num >= 0, er
-000068e0: 725f 6d65 7373 0a20 2020 2023 202e 2e20  r_mess.    # .. 
-000068f0: 5472 6561 7469 6e67 2073 7562 646f 6d61  Treating subdoma
-00006900: 696e 7320 616e 6420 4c69 6d69 7473 202e  ins and Limits .
-00006910: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00006920: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00006930: 2e2e 2e2e 2e2e 2e0a 2020 2020 5f73 742e  ........    _st.
-00006940: 6379 7468 6f6e 697a 655f 7375 6264 6f6d  cythonize_subdom
-00006950: 6169 6e5f 646c 2844 312c 2064 6c31 5f61  ain_dl(D1, dl1_a
-00006960: 7272 6179 290a 2020 2020 5f73 742e 6379  rray).    _st.cy
-00006970: 7468 6f6e 697a 655f 7375 6264 6f6d 6169  thonize_subdomai
-00006980: 6e5f 646c 2844 322c 2064 6c32 5f61 7272  n_dl(D2, dl2_arr
-00006990: 6179 290a 2020 2020 2320 2e2e 2044 6973  ay).    # .. Dis
-000069a0: 6372 6574 697a 696e 6720 6f6e 2074 6865  cretizing on the
-000069b0: 2066 6972 7374 2064 6972 6563 7469 6f6e   first direction
-000069c0: 202e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e   ...............
-000069d0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-000069e0: 2e2e 2e2e 0a20 2020 206e 696e 6431 203d  .....    nind1 =
-000069f0: 205f 7374 2e64 6973 6372 6574 697a 655f   _st.discretize_
-00006a00: 6c69 6e65 3164 5f63 6f72 6528 264c 4d69  line1d_core(&LMi
-00006a10: 6e4d 6178 315b 305d 2c20 6473 7465 7031  nMax1[0], dstep1
-00006a20: 2c20 646c 315f 6172 7261 792c 0a20 2020  , dl1_array,.   
-00006a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006a50: 2020 2020 5472 7565 2c20 6d6f 6465 5f6e      True, mode_n
-00006a60: 756d 2c20 6d61 7267 696e 2c0a 2020 2020  um, margin,.    
+00005ca0: 646f 7562 6c65 5b3a 2c3a 3a31 5d20 5650  double[:,::1] VP
+00005cb0: 6f6c 793d 4e6f 6e65 2c0a 2020 2020 2020  oly=None,.      
+00005cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005cd0: 2020 2064 6f75 626c 6520 6d61 7267 696e     double margin
+00005ce0: 3d5f 5653 4d41 4c4c 293a 0a20 2020 2022  =_VSMALL):.    "
+00005cf0: 2222 0a20 2020 2044 6973 6372 6574 697a  "".    Discretiz
+00005d00: 6573 2061 2032 4420 7365 676d 656e 7420  es a 2D segment 
+00005d10: 7768 6572 6520 7468 6520 3173 7420 636f  where the 1st co
+00005d20: 6f72 6469 6e61 7465 7320 6172 6520 6465  ordinates are de
+00005d30: 6669 6e65 6420 696e 204c 4d69 6e4d 6178  fined in LMinMax
+00005d40: 310a 2020 2020 616e 6420 7468 6520 7365  1.    and the se
+00005d50: 636f 6e64 206f 6e65 7320 696e 204c 4d69  cond ones in LMi
+00005d60: 6e4d 6178 322e 2054 6865 2072 6566 696e  nMax2. The refin
+00005d70: 656d 656e 7420 696e 2078 2069 7320 6465  ement in x is de
+00005d80: 6669 6e65 6420 6279 2064 7374 6570 312c  fined by dstep1,
+00005d90: 0a20 2020 2061 6e64 2064 7374 6570 3220  .    and dstep2 
+00005da0: 6465 6669 6e65 7320 7468 6520 7265 736f  defines the reso
+00005db0: 6c75 7469 6f6e 206f 6e20 792e 0a20 2020  lution on y..   
+00005dc0: 204f 7074 696f 6e6e 616c 6c79 2079 6f75   Optionnally you
+00005dd0: 2063 616e 2067 6976 6520 6120 5650 6f6c   can give a VPol
+00005de0: 7920 746f 2077 6869 6368 2074 6865 2064  y to which the d
+00005df0: 6973 6372 6574 697a 6564 2069 6e20 7768  iscretized in wh
+00005e00: 6963 6820 7468 650a 2020 2020 7365 676d  ich the.    segm
+00005e10: 656e 7420 6861 7320 746f 2062 6520 696e  ent has to be in
+00005e20: 636c 7564 6564 2e0a 2020 2020 5468 6973  cluded..    This
+00005e30: 2066 756e 6374 696f 6e20 6973 2062 6173   function is bas
+00005e40: 6963 616c 6c79 2061 2067 656e 6572 616c  ically a general
+00005e50: 697a 6174 696f 6e20 6f66 2064 6973 6372  ization of discr
+00005e60: 6574 697a 655f 6c69 6e65 3164 2e0a 2020  etize_line1d..  
+00005e70: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
+00005e80: 203d 3d3d 3d3d 3d3d 3d3d 3d0a 2020 2020   ==========.    
+00005e90: 4c4d 696e 4d61 7831 203a 2028 3229 2d64  LMinMax1 : (2)-d
+00005ea0: 6f75 626c 6520 6172 7261 790a 2020 2020  ouble array.    
+00005eb0: 2020 2020 4769 7665 7320 7468 6520 6c69      Gives the li
+00005ec0: 6d69 7473 204c 4d69 6e20 616e 6420 4c4d  mits LMin and LM
+00005ed0: 6178 206f 6620 7468 6520 7820 636f 6f72  ax of the x coor
+00005ee0: 6469 6e61 7465 7320 6f66 2074 6865 2073  dinates of the s
+00005ef0: 6567 6d65 6e74 2e0a 2020 2020 2020 2020  egment..        
+00005f00: 4c4d 696e 4d61 7831 203d 205b 786d 696e  LMinMax1 = [xmin
+00005f10: 2c20 786d 6178 5d0a 2020 2020 4c4d 696e  , xmax].    LMin
+00005f20: 4d61 7832 203a 2028 3229 2d64 6f75 626c  Max2 : (2)-doubl
+00005f30: 6520 6172 7261 790a 2020 2020 2020 2020  e array.        
+00005f40: 4769 7665 7320 7468 6520 6c69 6d69 7473  Gives the limits
+00005f50: 204c 4d69 6e20 616e 6420 4c4d 6178 206f   LMin and LMax o
+00005f60: 6620 7468 6520 7920 636f 6f72 6469 6e61  f the y coordina
+00005f70: 7465 7320 6f66 2074 6865 2073 6567 6d65  tes of the segme
+00005f80: 6e74 2e0a 2020 2020 2020 2020 4c4d 696e  nt..        LMin
+00005f90: 4d61 7832 203d 205b 796d 696e 2c20 796d  Max2 = [ymin, ym
+00005fa0: 6178 5d0a 2020 2020 6473 7465 7031 206f  ax].    dstep1 o
+00005fb0: 7220 6473 7465 7032 203a 2064 6f75 626c  r dstep2 : doubl
+00005fc0: 650a 2020 2020 2020 2020 5374 6570 206f  e.        Step o
+00005fd0: 6620 6469 7363 7265 7469 7a61 7469 6f6e  f discretization
+00005fe0: 2c20 6361 6e20 6265 2061 6273 6f6c 7574  , can be absolut
+00005ff0: 6520 2864 6566 6175 6c74 2920 6f72 2072  e (default) or r
+00006000: 656c 6174 6976 650a 2020 2020 4431 206f  elative.    D1 o
+00006010: 7220 4432 203a 2028 6f70 7469 6f6e 616c  r D2 : (optional
+00006020: 2920 2832 292d 646f 7562 6c65 2061 7272  ) (2)-double arr
+00006030: 6179 0a20 2020 2020 2020 2053 7562 2064  ay.        Sub d
+00006040: 6f6d 6169 6e20 6f66 2064 6973 6372 6574  omain of discret
+00006050: 697a 6174 696f 6e2e 2049 6620 6e6f 7420  ization. If not 
+00006060: 4e6f 6e65 2061 6e64 2069 6620 4c69 6d2c  None and if Lim,
+00006070: 204c 4d69 6e4d 6178 203d 2044 4c0a 2020   LMinMax = DL.  
+00006080: 2020 2020 2020 2863 616e 2062 6520 6f6e        (can be on
+00006090: 6c79 206f 6e20 6f6e 6520 6c69 6d69 7420  ly on one limit 
+000060a0: 616e 6420 6361 6e20 6265 2062 6967 6765  and can be bigge
+000060b0: 7220 6f72 2073 6d61 6c6c 6572 2074 6861  r or smaller tha
+000060c0: 6e20 6f72 6967 696e 616c 292e 0a20 2020  n original)..   
+000060d0: 2020 2020 2041 6374 7561 6c20 6465 7369       Actual desi
+000060e0: 7265 6420 6c69 6d69 7473 0a20 2020 206d  red limits.    m
+000060f0: 6f64 6520 3a20 286f 7074 696f 6e61 6c29  ode : (optional)
+00006100: 2073 7472 696e 670a 2020 2020 2020 2020   string.        
+00006110: 4966 2060 6d6f 6465 6020 6973 2022 6162  If `mode` is "ab
+00006120: 7322 2028 6162 736f 6c75 7465 292c 2074  s" (absolute), t
+00006130: 6865 6e20 7468 650a 2020 2020 2020 2020  hen the.        
+00006140: 7365 676d 656e 7420 7769 6c6c 2062 6520  segment will be 
+00006150: 6469 7363 7265 7469 7a65 6420 696e 2063  discretized in c
+00006160: 656c 6c73 2065 6163 6820 6f66 2073 697a  ells each of siz
+00006170: 6520 6064 7374 6570 602e 2045 6c73 652c  e `dstep`. Else,
+00006180: 0a20 2020 2020 2020 2069 6620 2272 656c  .        if "rel
+00006190: 2220 2872 656c 6174 6976 6529 2c20 7468  " (relative), th
+000061a0: 6520 6d65 7368 696e 6720 7374 6570 2069  e meshing step i
+000061b0: 7320 7265 6c61 7469 7665 2074 6f20 7468  s relative to th
+000061c0: 6520 7365 676d 656e 7473 206e 6f72 6d0a  e segments norm.
+000061d0: 2020 2020 2020 2020 2874 6865 2061 6374          (the act
+000061e0: 7561 6c20 6469 7363 7265 7469 7a61 7469  ual discretizati
+000061f0: 6f6e 2073 7465 7020 7769 6c6c 2062 6520  on step will be 
+00006200: 284c 4d61 7820 2d20 4c4d 696e 292f 6473  (LMax - LMin)/ds
+00006210: 7465 7029 2e0a 2020 2020 6d61 7267 696e  tep)..    margin
+00006220: 203a 2028 6f70 7469 6f6e 616c 2920 646f   : (optional) do
+00006230: 7562 6c65 0a20 2020 2020 2020 204d 6172  uble.        Mar
+00006240: 6769 6e20 7661 6c75 6520 666f 7220 6365  gin value for ce
+00006250: 6c6c 206c 656e 6774 680a 2020 2020 5650  ll length.    VP
+00006260: 6f6c 7920 3a20 286f 7074 696f 6e61 6c29  oly : (optional)
+00006270: 2032 6420 646f 7562 6c65 2061 7272 6179   2d double array
+00006280: 0a20 2020 2020 2020 2049 6620 7072 6573  .        If pres
+00006290: 656e 742c 2077 6520 6368 6563 6b20 7468  ent, we check th
+000062a0: 6174 2074 6865 2064 6973 6372 6574 697a  at the discretiz
+000062b0: 6564 2073 6567 6d65 6e74 2069 7320 696e  ed segment is in
+000062c0: 636c 7564 6564 2069 6e20 7468 650a 2020  cluded in the.  
+000062d0: 2020 2020 2020 7061 7468 2064 6566 696e        path defin
+000062e0: 6564 2062 7920 5650 6f6c 792e 0a20 2020  ed by VPoly..   
+000062f0: 2052 6574 7572 6e73 0a20 2020 203d 3d3d   Returns.    ===
+00006300: 3d3d 3d3d 0a20 2020 206c 6469 7363 7265  ====.    ldiscre
+00006310: 743a 2064 6f75 626c 6520 3264 2061 7272  t: double 2d arr
+00006320: 6179 0a20 2020 2020 2020 2061 7272 6179  ay.        array
+00006330: 206f 6620 7468 6520 6469 7363 7265 7469   of the discreti
+00006340: 7a65 6420 636f 6f72 6469 6e61 7465 7320  zed coordinates 
+00006350: 6f6e 2074 6865 2073 6567 6d65 6e74 206f  on the segment o
+00006360: 6620 6465 7369 7265 6420 6c69 6d69 7473  f desired limits
+00006370: 0a20 2020 2072 6573 6f6c 7574 696f 6e3a  .    resolution:
+00006380: 2064 6f75 626c 6520 6172 7261 790a 2020   double array.  
+00006390: 2020 2020 2020 7374 6570 206f 6620 6469        step of di
+000063a0: 7363 7265 7469 7a61 7469 6f6e 206f 6e20  scretization on 
+000063b0: 3264 2028 7479 7069 6361 6c6c 7920 7265  2d (typically re
+000063c0: 736f 6c75 7469 6f6e 2d6f 6e2d 782a 7265  solution-on-x*re
+000063d0: 736f 6c75 7469 6f6e 2d6f 6e2d 7929 0a20  solution-on-y). 
+000063e0: 2020 206c 696e 6465 783a 2069 6e74 2061     lindex: int a
+000063f0: 7272 6179 0a20 2020 2020 2020 2061 7272  rray.        arr
+00006400: 6179 206f 6620 7468 6520 696e 6469 6365  ay of the indice
+00006410: 7320 636f 7272 6573 706f 6e64 696e 6720  s corresponding 
+00006420: 746f 206c 6469 7363 7265 7420 7769 7468  to ldiscret with
+00006430: 2072 6573 7065 6374 7320 746f 2074 6865   respects to the
+00006440: 0a20 2020 2020 2020 206f 7269 6769 6e61  .        origina
+00006450: 6c20 7365 676d 656e 7420 4c4d 696e 4d61  l segment LMinMa
+00006460: 7820 2869 6620 6e6f 2044 4c2c 2066 726f  x (if no DL, fro
+00006470: 6d20 3020 746f 204e 2d31 290a 2020 2020  m 0 to N-1).    
+00006480: 7265 736f 6c31 203a 2064 6f75 626c 650a  resol1 : double.
+00006490: 2020 2020 2020 2020 536d 616c 6c65 7374          Smallest
+000064a0: 2072 6573 6f6c 7574 696f 6e20 6f6e 2078   resolution on x
+000064b0: 0a20 2020 2072 6573 6f6c 3220 3a20 646f  .    resol2 : do
+000064c0: 7562 6c65 0a20 2020 2020 2020 2053 6d61  uble.        Sma
+000064d0: 6c6c 6573 7420 7265 736f 6c75 7469 6f6e  llest resolution
+000064e0: 206f 6e20 790a 2020 2020 2222 220a 2020   on y.    """.  
+000064f0: 2020 6364 6566 2069 6e74 206e 6e0a 2020    cdef int nn.  
+00006500: 2020 6364 6566 2069 6e74 206e 6469 7363    cdef int ndisc
+00006510: 0a20 2020 2063 6465 6620 696e 7420 6969  .    cdef int ii
+00006520: 2c20 6a6a 0a20 2020 2063 6465 6620 696e  , jj.    cdef in
+00006530: 7420 746f 745f 7472 7565 0a20 2020 2063  t tot_true.    c
+00006540: 6465 6620 696e 7420 6d6f 6465 5f6e 756d  def int mode_num
+00006550: 0a20 2020 2063 6465 6620 696e 7420 6e75  .    cdef int nu
+00006560: 6d5f 7074 735f 7670 6f6c 790a 2020 2020  m_pts_vpoly.    
+00006570: 6364 6566 2073 7472 2065 7272 5f6d 6573  cdef str err_mes
+00006580: 730a 2020 2020 6364 6566 2073 7472 206d  s.    cdef str m
+00006590: 6f64 655f 6c6f 7720 3d20 6d6f 6465 2e6c  ode_low = mode.l
+000065a0: 6f77 6572 2829 0a20 2020 2063 6465 6620  ower().    cdef 
+000065b0: 6c6f 6e67 206e 696e 6431 0a20 2020 2063  long nind1.    c
+000065c0: 6465 6620 6c6f 6e67 206e 696e 6432 0a20  def long nind2. 
+000065d0: 2020 2063 6465 6620 6c6f 6e67 5b31 5d20     cdef long[1] 
+000065e0: 6e63 656c 6c73 310a 2020 2020 6364 6566  ncells1.    cdef
+000065f0: 206c 6f6e 675b 315d 206e 6365 6c6c 7332   long[1] ncells2
+00006600: 0a20 2020 2063 6465 6620 646f 7562 6c65  .    cdef double
+00006610: 5b32 5d20 646c 315f 6172 7261 790a 2020  [2] dl1_array.  
+00006620: 2020 6364 6566 2064 6f75 626c 655b 325d    cdef double[2]
+00006630: 2064 6c32 5f61 7272 6179 0a20 2020 2063   dl2_array.    c
+00006640: 6465 6620 646f 7562 6c65 5b32 5d20 7265  def double[2] re
+00006650: 736f 6c75 7469 6f6e 730a 2020 2020 6364  solutions.    cd
+00006660: 6566 206c 6f6e 675b 3a5d 206c 696e 6465  ef long[:] linde
+00006670: 785f 7669 6577 0a20 2020 2063 6465 6620  x_view.    cdef 
+00006680: 646f 7562 6c65 5b3a 5d20 6c72 6573 6f6c  double[:] lresol
+00006690: 5f76 6965 770a 2020 2020 6364 6566 2064  _view.    cdef d
+000066a0: 6f75 626c 655b 3a2c 3a5d 206c 6469 7363  ouble[:,:] ldisc
+000066b0: 725f 7669 6577 0a20 2020 2063 6465 6620  r_view.    cdef 
+000066c0: 696e 742a 2061 7265 5f69 6e5f 706f 6c79  int* are_in_poly
+000066d0: 203d 204e 554c 4c0a 2020 2020 6364 6566   = NULL.    cdef
+000066e0: 206c 6f6e 672a 206c 696e 6465 7831 5f61   long* lindex1_a
+000066f0: 7272 203d 204e 554c 4c0a 2020 2020 6364  rr = NULL.    cd
+00006700: 6566 206c 6f6e 672a 206c 696e 6465 7832  ef long* lindex2
+00006710: 5f61 7272 203d 204e 554c 4c0a 2020 2020  _arr = NULL.    
+00006720: 6364 6566 206c 6f6e 672a 206c 696e 6465  cdef long* linde
+00006730: 785f 746d 7020 203d 204e 554c 4c0a 2020  x_tmp  = NULL.  
+00006740: 2020 6364 6566 2064 6f75 626c 652a 206c    cdef double* l
+00006750: 6469 7363 725f 746d 7020 3d20 4e55 4c4c  discr_tmp = NULL
+00006760: 0a20 2020 2063 6465 6620 646f 7562 6c65  .    cdef double
+00006770: 2a20 6c64 6973 6372 6574 315f 6172 7220  * ldiscret1_arr 
+00006780: 3d20 4e55 4c4c 0a20 2020 2063 6465 6620  = NULL.    cdef 
+00006790: 646f 7562 6c65 2a20 6c64 6973 6372 6574  double* ldiscret
+000067a0: 325f 6172 7220 3d20 4e55 4c4c 0a20 2020  2_arr = NULL.   
+000067b0: 2063 6465 6620 6e70 2e6e 6461 7272 6179   cdef np.ndarray
+000067c0: 5b64 6f75 626c 652c 6e64 696d 3d32 5d20  [double,ndim=2] 
+000067d0: 6c64 6973 6372 0a20 2020 2063 6465 6620  ldiscr.    cdef 
+000067e0: 6e70 2e6e 6461 7272 6179 5b64 6f75 626c  np.ndarray[doubl
+000067f0: 652c 6e64 696d 3d31 5d20 6c72 6573 6f6c  e,ndim=1] lresol
+00006800: 0a20 2020 2063 6465 6620 6e70 2e6e 6461  .    cdef np.nda
+00006810: 7272 6179 5b6c 6f6e 672c 6e64 696d 3d31  rray[long,ndim=1
+00006820: 5d20 6c69 6e64 6578 0a20 2020 2023 202e  ] lindex.    # .
+00006830: 2e2e 0a20 2020 206d 6f64 655f 6e75 6d20  ...    mode_num 
+00006840: 3d20 5f73 742e 6765 745f 6e62 5f64 6d6f  = _st.get_nb_dmo
+00006850: 6465 286d 6f64 655f 6c6f 7729 0a20 2020  de(mode_low).   
+00006860: 2023 202e 2e20 5465 7374 696e 6720 2e2e   # .. Testing ..
+00006870: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00006880: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00006890: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+000068a0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e0a 2020  ..............  
+000068b0: 2020 6572 725f 6d65 7373 203d 2022 4d6f    err_mess = "Mo
+000068c0: 6465 2068 6173 2074 6f20 6265 2027 6162  de has to be 'ab
+000068d0: 7327 2028 6162 736f 6c75 7465 2920 6f72  s' (absolute) or
+000068e0: 2027 7265 6c27 2028 7265 6c61 7469 7665   'rel' (relative
+000068f0: 2922 0a20 2020 2061 7373 6572 7420 6d6f  )".    assert mo
+00006900: 6465 5f6e 756d 203e 3d20 302c 2065 7272  de_num >= 0, err
+00006910: 5f6d 6573 730a 2020 2020 2320 2e2e 2054  _mess.    # .. T
+00006920: 7265 6174 696e 6720 7375 6264 6f6d 6169  reating subdomai
+00006930: 6e73 2061 6e64 204c 696d 6974 7320 2e2e  ns and Limits ..
+00006940: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00006950: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00006960: 2e2e 2e2e 2e2e 0a20 2020 205f 7374 2e63  .......    _st.c
+00006970: 7974 686f 6e69 7a65 5f73 7562 646f 6d61  ythonize_subdoma
+00006980: 696e 5f64 6c28 4431 2c20 646c 315f 6172  in_dl(D1, dl1_ar
+00006990: 7261 7929 0a20 2020 205f 7374 2e63 7974  ray).    _st.cyt
+000069a0: 686f 6e69 7a65 5f73 7562 646f 6d61 696e  honize_subdomain
+000069b0: 5f64 6c28 4432 2c20 646c 325f 6172 7261  _dl(D2, dl2_arra
+000069c0: 7929 0a20 2020 2023 202e 2e20 4469 7363  y).    # .. Disc
+000069d0: 7265 7469 7a69 6e67 206f 6e20 7468 6520  retizing on the 
+000069e0: 6669 7273 7420 6469 7265 6374 696f 6e20  first direction 
+000069f0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00006a00: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00006a10: 2e2e 2e0a 2020 2020 6e69 6e64 3120 3d20  ....    nind1 = 
+00006a20: 5f73 742e 6469 7363 7265 7469 7a65 5f6c  _st.discretize_l
+00006a30: 696e 6531 645f 636f 7265 2826 4c4d 696e  ine1d_core(&LMin
+00006a40: 4d61 7831 5b30 5d2c 2064 7374 6570 312c  Max1[0], dstep1,
+00006a50: 2064 6c31 5f61 7272 6179 2c0a 2020 2020   dl1_array,.    
+00006a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00006a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006a90: 2020 2026 6c64 6973 6372 6574 315f 6172     &ldiscret1_ar
-00006aa0: 722c 2026 7265 736f 6c75 7469 6f6e 735b  r, &resolutions[
-00006ab0: 305d 2c0a 2020 2020 2020 2020 2020 2020  0],.            
-00006ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006ad0: 2020 2020 2020 2020 2020 2026 6c69 6e64             &lind
-00006ae0: 6578 315f 6172 722c 206e 6365 6c6c 7331  ex1_arr, ncells1
-00006af0: 290a 2020 2020 2320 2e2e 2044 6973 6372  ).    # .. Discr
-00006b00: 6574 697a 696e 6720 6f6e 2074 6865 2073  etizing on the s
-00006b10: 6563 6f6e 6420 6469 7265 6374 696f 6e20  econd direction 
-00006b20: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00006b30: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00006b40: 2e2e 0a20 2020 206e 696e 6432 203d 205f  ...    nind2 = _
-00006b50: 7374 2e64 6973 6372 6574 697a 655f 6c69  st.discretize_li
-00006b60: 6e65 3164 5f63 6f72 6528 264c 4d69 6e4d  ne1d_core(&LMinM
-00006b70: 6178 325b 305d 2c20 6473 7465 7032 2c20  ax2[0], dstep2, 
-00006b80: 646c 325f 6172 7261 792c 0a20 2020 2020  dl2_array,.     
-00006b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006bb0: 2020 5472 7565 2c20 6d6f 6465 5f6e 756d    True, mode_num
-00006bc0: 2c20 6d61 7267 696e 2c0a 2020 2020 2020  , margin,.      
+00006a80: 2020 2054 7275 652c 206d 6f64 655f 6e75     True, mode_nu
+00006a90: 6d2c 206d 6172 6769 6e2c 0a20 2020 2020  m, margin,.     
+00006aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006ac0: 2020 266c 6469 7363 7265 7431 5f61 7272    &ldiscret1_arr
+00006ad0: 2c20 2672 6573 6f6c 7574 696f 6e73 5b30  , &resolutions[0
+00006ae0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00006af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006b00: 2020 2020 2020 2020 2020 266c 696e 6465            &linde
+00006b10: 7831 5f61 7272 2c20 6e63 656c 6c73 3129  x1_arr, ncells1)
+00006b20: 0a20 2020 2023 202e 2e20 4469 7363 7265  .    # .. Discre
+00006b30: 7469 7a69 6e67 206f 6e20 7468 6520 7365  tizing on the se
+00006b40: 636f 6e64 2064 6972 6563 7469 6f6e 202e  cond direction .
+00006b50: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00006b60: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00006b70: 2e0a 2020 2020 6e69 6e64 3220 3d20 5f73  ..    nind2 = _s
+00006b80: 742e 6469 7363 7265 7469 7a65 5f6c 696e  t.discretize_lin
+00006b90: 6531 645f 636f 7265 2826 4c4d 696e 4d61  e1d_core(&LMinMa
+00006ba0: 7832 5b30 5d2c 2064 7374 6570 322c 2064  x2[0], dstep2, d
+00006bb0: 6c32 5f61 7272 6179 2c0a 2020 2020 2020  l2_array,.      
+00006bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00006bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006bf0: 2026 6c64 6973 6372 6574 325f 6172 722c   &ldiscret2_arr,
-00006c00: 2026 7265 736f 6c75 7469 6f6e 735b 315d   &resolutions[1]
-00006c10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00006c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006c30: 2020 2020 2020 2020 2026 6c69 6e64 6578           &lindex
-00006c40: 325f 6172 722c 206e 6365 6c6c 7332 290a  2_arr, ncells2).
-00006c50: 2020 2020 232e 2e2e 2e0a 2020 2020 6966      #.....    if
-00006c60: 2056 506f 6c79 2069 7320 6e6f 7420 4e6f   VPoly is not No
-00006c70: 6e65 3a0a 2020 2020 2020 2020 6e64 6973  ne:.        ndis
-00006c80: 6320 3d20 6e69 6e64 3120 2a20 6e69 6e64  c = nind1 * nind
-00006c90: 320a 2020 2020 2020 2020 6c64 6973 6372  2.        ldiscr
-00006ca0: 5f74 6d70 203d 203c 646f 7562 6c65 202a  _tmp = <double *
-00006cb0: 3e6d 616c 6c6f 6328 6e64 6973 6320 2a20  >malloc(ndisc * 
-00006cc0: 3220 2a20 7369 7a65 6f66 2864 6f75 626c  2 * sizeof(doubl
-00006cd0: 6529 290a 2020 2020 2020 2020 6c69 6e64  e)).        lind
-00006ce0: 6578 5f74 6d70 203d 203c 6c6f 6e67 202a  ex_tmp = <long *
-00006cf0: 3e6d 616c 6c6f 6328 6e64 6973 6320 2a20  >malloc(ndisc * 
-00006d00: 7369 7a65 6f66 286c 6f6e 6729 290a 2020  sizeof(long)).  
-00006d10: 2020 2020 2020 666f 7220 6969 2069 6e20        for ii in 
-00006d20: 7261 6e67 6528 6e69 6e64 3229 3a0a 2020  range(nind2):.  
-00006d30: 2020 2020 2020 2020 2020 666f 7220 6a6a            for jj
-00006d40: 2069 6e20 7261 6e67 6528 6e69 6e64 3129   in range(nind1)
-00006d50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00006d60: 2020 6e6e 203d 206a 6a20 2b20 6e69 6e64    nn = jj + nind
-00006d70: 3120 2a20 6969 0a20 2020 2020 2020 2020  1 * ii.         
-00006d80: 2020 2020 2020 206c 6469 7363 725f 746d         ldiscr_tm
-00006d90: 705b 6e6e 5d20 3d20 6c64 6973 6372 6574  p[nn] = ldiscret
-00006da0: 315f 6172 725b 6a6a 5d0a 2020 2020 2020  1_arr[jj].      
-00006db0: 2020 2020 2020 2020 2020 6c64 6973 6372            ldiscr
-00006dc0: 5f74 6d70 5b6e 6469 7363 202b 206e 6e5d  _tmp[ndisc + nn]
-00006dd0: 203d 206c 6469 7363 7265 7432 5f61 7272   = ldiscret2_arr
-00006de0: 5b69 695d 0a20 2020 2020 2020 2020 2020  [ii].           
-00006df0: 2020 2020 206c 696e 6465 785f 746d 705b       lindex_tmp[
-00006e00: 6e6e 5d20 3d20 6c69 6e64 6578 315f 6172  nn] = lindex1_ar
-00006e10: 725b 6a6a 5d20 2b20 6e69 6e64 3120 2a20  r[jj] + nind1 * 
-00006e20: 6c69 6e64 6578 325f 6172 725b 6969 5d0a  lindex2_arr[ii].
-00006e30: 2020 2020 2020 2020 6e75 6d5f 7074 735f          num_pts_
-00006e40: 7670 6f6c 7920 3d20 5650 6f6c 792e 7368  vpoly = VPoly.sh
-00006e50: 6170 655b 315d 202d 2031 0a20 2020 2020  ape[1] - 1.     
-00006e60: 2020 2061 7265 5f69 6e5f 706f 6c79 203d     are_in_poly =
-00006e70: 203c 696e 7420 2a3e 6d61 6c6c 6f63 286e   <int *>malloc(n
-00006e80: 6469 7363 202a 2073 697a 656f 6628 696e  disc * sizeof(in
-00006e90: 7429 290a 2020 2020 2020 2020 746f 745f  t)).        tot_
-00006ea0: 7472 7565 203d 205f 6267 742e 6973 5f70  true = _bgt.is_p
-00006eb0: 6f69 6e74 5f69 6e5f 7061 7468 5f76 6563  oint_in_path_vec
-00006ec0: 286e 756d 5f70 7473 5f76 706f 6c79 2c0a  (num_pts_vpoly,.
-00006ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006ef0: 2020 2020 2020 2020 2020 2020 2026 5650               &VP
-00006f00: 6f6c 795b 305d 5b30 5d2c 2026 5650 6f6c  oly[0][0], &VPol
-00006f10: 795b 315d 5b30 5d2c 0a20 2020 2020 2020  y[1][0],.       
-00006f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006f40: 2020 2020 2020 6e64 6973 632c 0a20 2020        ndisc,.   
+00006be0: 2054 7275 652c 206d 6f64 655f 6e75 6d2c   True, mode_num,
+00006bf0: 206d 6172 6769 6e2c 0a20 2020 2020 2020   margin,.       
+00006c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006c20: 266c 6469 7363 7265 7432 5f61 7272 2c20  &ldiscret2_arr, 
+00006c30: 2672 6573 6f6c 7574 696f 6e73 5b31 5d2c  &resolutions[1],
+00006c40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006c60: 2020 2020 2020 2020 266c 696e 6465 7832          &lindex2
+00006c70: 5f61 7272 2c20 6e63 656c 6c73 3229 0a20  _arr, ncells2). 
+00006c80: 2020 2023 2e2e 2e2e 0a20 2020 2069 6620     #.....    if 
+00006c90: 5650 6f6c 7920 6973 206e 6f74 204e 6f6e  VPoly is not Non
+00006ca0: 653a 0a20 2020 2020 2020 206e 6469 7363  e:.        ndisc
+00006cb0: 203d 206e 696e 6431 202a 206e 696e 6432   = nind1 * nind2
+00006cc0: 0a20 2020 2020 2020 206c 6469 7363 725f  .        ldiscr_
+00006cd0: 746d 7020 3d20 3c64 6f75 626c 6520 2a3e  tmp = <double *>
+00006ce0: 6d61 6c6c 6f63 286e 6469 7363 202a 2032  malloc(ndisc * 2
+00006cf0: 202a 2073 697a 656f 6628 646f 7562 6c65   * sizeof(double
+00006d00: 2929 0a20 2020 2020 2020 206c 696e 6465  )).        linde
+00006d10: 785f 746d 7020 3d20 3c6c 6f6e 6720 2a3e  x_tmp = <long *>
+00006d20: 6d61 6c6c 6f63 286e 6469 7363 202a 2073  malloc(ndisc * s
+00006d30: 697a 656f 6628 6c6f 6e67 2929 0a20 2020  izeof(long)).   
+00006d40: 2020 2020 2066 6f72 2069 6920 696e 2072       for ii in r
+00006d50: 616e 6765 286e 696e 6432 293a 0a20 2020  ange(nind2):.   
+00006d60: 2020 2020 2020 2020 2066 6f72 206a 6a20           for jj 
+00006d70: 696e 2072 616e 6765 286e 696e 6431 293a  in range(nind1):
+00006d80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006d90: 206e 6e20 3d20 6a6a 202b 206e 696e 6431   nn = jj + nind1
+00006da0: 202a 2069 690a 2020 2020 2020 2020 2020   * ii.          
+00006db0: 2020 2020 2020 6c64 6973 6372 5f74 6d70        ldiscr_tmp
+00006dc0: 5b6e 6e5d 203d 206c 6469 7363 7265 7431  [nn] = ldiscret1
+00006dd0: 5f61 7272 5b6a 6a5d 0a20 2020 2020 2020  _arr[jj].       
+00006de0: 2020 2020 2020 2020 206c 6469 7363 725f           ldiscr_
+00006df0: 746d 705b 6e64 6973 6320 2b20 6e6e 5d20  tmp[ndisc + nn] 
+00006e00: 3d20 6c64 6973 6372 6574 325f 6172 725b  = ldiscret2_arr[
+00006e10: 6969 5d0a 2020 2020 2020 2020 2020 2020  ii].            
+00006e20: 2020 2020 6c69 6e64 6578 5f74 6d70 5b6e      lindex_tmp[n
+00006e30: 6e5d 203d 206c 696e 6465 7831 5f61 7272  n] = lindex1_arr
+00006e40: 5b6a 6a5d 202b 206e 696e 6431 202a 206c  [jj] + nind1 * l
+00006e50: 696e 6465 7832 5f61 7272 5b69 695d 0a20  index2_arr[ii]. 
+00006e60: 2020 2020 2020 206e 756d 5f70 7473 5f76         num_pts_v
+00006e70: 706f 6c79 203d 2056 506f 6c79 2e73 6861  poly = VPoly.sha
+00006e80: 7065 5b31 5d20 2d20 310a 2020 2020 2020  pe[1] - 1.      
+00006e90: 2020 6172 655f 696e 5f70 6f6c 7920 3d20    are_in_poly = 
+00006ea0: 3c69 6e74 202a 3e6d 616c 6c6f 6328 6e64  <int *>malloc(nd
+00006eb0: 6973 6320 2a20 7369 7a65 6f66 2869 6e74  isc * sizeof(int
+00006ec0: 2929 0a20 2020 2020 2020 2074 6f74 5f74  )).        tot_t
+00006ed0: 7275 6520 3d20 5f62 6774 2e69 735f 706f  rue = _bgt.is_po
+00006ee0: 696e 745f 696e 5f70 6174 685f 7665 6328  int_in_path_vec(
+00006ef0: 6e75 6d5f 7074 735f 7670 6f6c 792c 0a20  num_pts_vpoly,. 
+00006f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006f20: 2020 2020 2020 2020 2020 2020 2656 506f              &VPo
+00006f30: 6c79 5b30 5d5b 305d 2c20 2656 506f 6c79  ly[0][0], &VPoly
+00006f40: 5b31 5d5b 305d 2c0a 2020 2020 2020 2020  [1][0],.        
 00006f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00006f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006f70: 2020 2020 2020 2020 2020 266c 6469 7363            &ldisc
-00006f80: 725f 746d 705b 305d 2c20 266c 6469 7363  r_tmp[0], &ldisc
-00006f90: 725f 746d 705b 6e64 6973 635d 2c0a 2020  r_tmp[ndisc],.  
-00006fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006fc0: 2020 2020 2020 2020 2020 2061 7265 5f69             are_i
-00006fd0: 6e5f 706f 6c79 290a 2020 2020 2020 2020  n_poly).        
-00006fe0: 6c64 6973 6372 203d 206e 702e 656d 7074  ldiscr = np.empt
-00006ff0: 7928 2832 2c20 746f 745f 7472 7565 292c  y((2, tot_true),
-00007000: 2064 7479 7065 3d66 6c6f 6174 290a 2020   dtype=float).  
-00007010: 2020 2020 2020 6c72 6573 6f6c 203d 206e        lresol = n
-00007020: 702e 656d 7074 7928 2874 6f74 5f74 7275  p.empty((tot_tru
-00007030: 652c 292c 2064 7479 7065 3d66 6c6f 6174  e,), dtype=float
-00007040: 290a 2020 2020 2020 2020 6c69 6e64 6578  ).        lindex
-00007050: 203d 206e 702e 656d 7074 7928 2874 6f74   = np.empty((tot
-00007060: 5f74 7275 652c 292c 2064 7479 7065 3d69  _true,), dtype=i
-00007070: 6e74 290a 2020 2020 2020 2020 6c64 6973  nt).        ldis
-00007080: 6372 5f76 6965 7720 3d20 6c64 6973 6372  cr_view = ldiscr
-00007090: 0a20 2020 2020 2020 206c 696e 6465 785f  .        lindex_
-000070a0: 7669 6577 203d 206c 696e 6465 780a 2020  view = lindex.  
-000070b0: 2020 2020 2020 6c72 6573 6f6c 5f76 6965        lresol_vie
-000070c0: 7720 3d20 6c72 6573 6f6c 0a20 2020 2020  w = lresol.     
-000070d0: 2020 206a 6a20 3d20 300a 2020 2020 2020     jj = 0.      
-000070e0: 2020 666f 7220 6969 2069 6e20 7261 6e67    for ii in rang
-000070f0: 6528 6e64 6973 6329 3a0a 2020 2020 2020  e(ndisc):.      
-00007100: 2020 2020 2020 6966 2061 7265 5f69 6e5f        if are_in_
-00007110: 706f 6c79 5b69 695d 3a0a 2020 2020 2020  poly[ii]:.      
-00007120: 2020 2020 2020 2020 2020 6c72 6573 6f6c            lresol
-00007130: 5f76 6965 775b 6a6a 5d20 3d20 7265 736f  _view[jj] = reso
-00007140: 6c75 7469 6f6e 735b 305d 202a 2072 6573  lutions[0] * res
-00007150: 6f6c 7574 696f 6e73 5b31 5d0a 2020 2020  olutions[1].    
-00007160: 2020 2020 2020 2020 2020 2020 6c69 6e64              lind
-00007170: 6578 5f76 6965 775b 6a6a 5d20 3d20 6c69  ex_view[jj] = li
-00007180: 6e64 6578 5f74 6d70 5b69 695d 0a20 2020  ndex_tmp[ii].   
-00007190: 2020 2020 2020 2020 2020 2020 206c 6469               ldi
-000071a0: 7363 725f 7669 6577 5b30 2c6a 6a5d 203d  scr_view[0,jj] =
-000071b0: 206c 6469 7363 725f 746d 705b 6969 5d0a   ldiscr_tmp[ii].
-000071c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000071d0: 6c64 6973 6372 5f76 6965 775b 312c 6a6a  ldiscr_view[1,jj
-000071e0: 5d20 3d20 6c64 6973 6372 5f74 6d70 5b69  ] = ldiscr_tmp[i
-000071f0: 6920 2b20 6e64 6973 635d 0a20 2020 2020  i + ndisc].     
-00007200: 2020 2020 2020 2020 2020 206a 6a20 3d20             jj = 
-00007210: 6a6a 202b 2031 0a20 2020 2020 2020 2066  jj + 1.        f
-00007220: 7265 6528 6c64 6973 6372 5f74 6d70 290a  ree(ldiscr_tmp).
-00007230: 2020 2020 2020 2020 6672 6565 286c 696e          free(lin
-00007240: 6465 785f 746d 7029 0a20 2020 2020 2020  dex_tmp).       
-00007250: 2066 7265 6528 6172 655f 696e 5f70 6f6c   free(are_in_pol
-00007260: 7929 0a20 2020 2020 2020 2066 7265 6528  y).        free(
-00007270: 6c64 6973 6372 6574 315f 6172 7229 0a20  ldiscret1_arr). 
-00007280: 2020 2020 2020 2066 7265 6528 6c64 6973         free(ldis
-00007290: 6372 6574 325f 6172 7229 0a20 2020 2020  cret2_arr).     
-000072a0: 2020 2066 7265 6528 6c69 6e64 6578 315f     free(lindex1_
-000072b0: 6172 7229 0a20 2020 2020 2020 2066 7265  arr).        fre
-000072c0: 6528 6c69 6e64 6578 325f 6172 7229 0a20  e(lindex2_arr). 
-000072d0: 2020 2020 2020 2072 6574 7572 6e20 6c64         return ld
-000072e0: 6973 6372 2c20 6c72 6573 6f6c 2c5c 0a20  iscr, lresol,\. 
-000072f0: 2020 2020 2020 2020 2020 206c 696e 6465             linde
-00007300: 782c 2072 6573 6f6c 7574 696f 6e73 5b30  x, resolutions[0
-00007310: 5d2c 2072 6573 6f6c 7574 696f 6e73 5b31  ], resolutions[1
-00007320: 5d0a 2020 2020 656c 7365 3a0a 2020 2020  ].    else:.    
-00007330: 2020 2020 6e64 6973 6320 3d20 6e69 6e64      ndisc = nind
-00007340: 3120 2a20 6e69 6e64 320a 2020 2020 2020  1 * nind2.      
-00007350: 2020 6c64 6973 6372 203d 206e 702e 656d    ldiscr = np.em
-00007360: 7074 7928 2832 2c20 6e64 6973 6329 2c20  pty((2, ndisc), 
-00007370: 6474 7970 653d 666c 6f61 7429 0a20 2020  dtype=float).   
-00007380: 2020 2020 206c 7265 736f 6c20 3d20 6e70       lresol = np
-00007390: 2e65 6d70 7479 2828 6e64 6973 632c 292c  .empty((ndisc,),
-000073a0: 2064 7479 7065 3d66 6c6f 6174 290a 2020   dtype=float).  
-000073b0: 2020 2020 2020 6c69 6e64 6578 203d 206e        lindex = n
-000073c0: 702e 656d 7074 7928 286e 6469 7363 2c29  p.empty((ndisc,)
-000073d0: 2c20 6474 7970 653d 696e 7429 0a20 2020  , dtype=int).   
-000073e0: 2020 2020 206c 6469 7363 725f 7669 6577       ldiscr_view
-000073f0: 203d 206c 6469 7363 720a 2020 2020 2020   = ldiscr.      
-00007400: 2020 6c69 6e64 6578 5f76 6965 7720 3d20    lindex_view = 
-00007410: 6c69 6e64 6578 0a20 2020 2020 2020 206c  lindex.        l
-00007420: 7265 736f 6c5f 7669 6577 203d 206c 7265  resol_view = lre
-00007430: 736f 6c0a 2020 2020 2020 2020 666f 7220  sol.        for 
-00007440: 6969 2069 6e20 7261 6e67 6528 6e69 6e64  ii in range(nind
-00007450: 3229 3a0a 2020 2020 2020 2020 2020 2020  2):.            
-00007460: 666f 7220 6a6a 2069 6e20 7261 6e67 6528  for jj in range(
-00007470: 6e69 6e64 3129 3a0a 2020 2020 2020 2020  nind1):.        
-00007480: 2020 2020 2020 2020 6e6e 203d 206a 6a20          nn = jj 
-00007490: 2b20 6e69 6e64 3120 2a20 6969 0a20 2020  + nind1 * ii.   
-000074a0: 2020 2020 2020 2020 2020 2020 206c 6469               ldi
-000074b0: 7363 725f 7669 6577 5b30 2c6e 6e5d 203d  scr_view[0,nn] =
-000074c0: 206c 6469 7363 7265 7431 5f61 7272 5b6a   ldiscret1_arr[j
-000074d0: 6a5d 0a20 2020 2020 2020 2020 2020 2020  j].             
-000074e0: 2020 206c 6469 7363 725f 7669 6577 5b31     ldiscr_view[1
-000074f0: 2c6e 6e5d 203d 206c 6469 7363 7265 7432  ,nn] = ldiscret2
-00007500: 5f61 7272 5b69 695d 0a20 2020 2020 2020  _arr[ii].       
-00007510: 2020 2020 2020 2020 206c 696e 6465 785f           lindex_
-00007520: 7669 6577 5b6e 6e5d 203d 206c 696e 6465  view[nn] = linde
-00007530: 7831 5f61 7272 5b6a 6a5d 202b 206e 696e  x1_arr[jj] + nin
-00007540: 6431 202a 206c 696e 6465 7832 5f61 7272  d1 * lindex2_arr
-00007550: 5b69 695d 0a20 2020 2020 2020 2020 2020  [ii].           
-00007560: 2020 2020 206c 7265 736f 6c5f 7669 6577       lresol_view
-00007570: 5b6e 6e5d 203d 2072 6573 6f6c 7574 696f  [nn] = resolutio
-00007580: 6e73 5b30 5d20 2a20 7265 736f 6c75 7469  ns[0] * resoluti
-00007590: 6f6e 735b 315d 0a20 2020 2020 2020 2066  ons[1].        f
-000075a0: 7265 6528 6c64 6973 6372 6574 315f 6172  ree(ldiscret1_ar
-000075b0: 7229 0a20 2020 2020 2020 2066 7265 6528  r).        free(
-000075c0: 6c64 6973 6372 6574 325f 6172 7229 0a20  ldiscret2_arr). 
-000075d0: 2020 2020 2020 2066 7265 6528 6c69 6e64         free(lind
-000075e0: 6578 315f 6172 7229 0a20 2020 2020 2020  ex1_arr).       
-000075f0: 2066 7265 6528 6c69 6e64 6578 325f 6172   free(lindex2_ar
-00007600: 7229 0a20 2020 2020 2020 2072 6574 7572  r).        retur
-00007610: 6e20 6c64 6973 6372 2c20 6c72 6573 6f6c  n ldiscr, lresol
-00007620: 2c5c 0a20 2020 2020 2020 2020 2020 206c  ,\.            l
-00007630: 696e 6465 782c 2072 6573 6f6c 7574 696f  index, resolutio
-00007640: 6e73 5b30 5d2c 2072 6573 6f6c 7574 696f  ns[0], resolutio
-00007650: 6e73 5b31 5d0a 0a0a 6465 6620 5f56 6573  ns[1]...def _Ves
-00007660: 5f6d 6573 6843 726f 7373 5f46 726f 6d49  _meshCross_FromI
-00007670: 6e64 2864 6f75 626c 655b 3a3a 315d 204d  nd(double[::1] M
-00007680: 696e 4d61 7831 2c0a 2020 2020 2020 2020  inMax1,.        
-00007690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000076a0: 2020 2064 6f75 626c 655b 3a3a 315d 204d     double[::1] M
-000076b0: 696e 4d61 7832 2c0a 2020 2020 2020 2020  inMax2,.        
+00006f70: 2020 2020 206e 6469 7363 2c0a 2020 2020       ndisc,.    
+00006f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006fa0: 2020 2020 2020 2020 2026 6c64 6973 6372           &ldiscr
+00006fb0: 5f74 6d70 5b30 5d2c 2026 6c64 6973 6372  _tmp[0], &ldiscr
+00006fc0: 5f74 6d70 5b6e 6469 7363 5d2c 0a20 2020  _tmp[ndisc],.   
+00006fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006ff0: 2020 2020 2020 2020 2020 6172 655f 696e            are_in
+00007000: 5f70 6f6c 7929 0a20 2020 2020 2020 206c  _poly).        l
+00007010: 6469 7363 7220 3d20 6e70 2e65 6d70 7479  discr = np.empty
+00007020: 2828 322c 2074 6f74 5f74 7275 6529 2c20  ((2, tot_true), 
+00007030: 6474 7970 653d 666c 6f61 7429 0a20 2020  dtype=float).   
+00007040: 2020 2020 206c 7265 736f 6c20 3d20 6e70       lresol = np
+00007050: 2e65 6d70 7479 2828 746f 745f 7472 7565  .empty((tot_true
+00007060: 2c29 2c20 6474 7970 653d 666c 6f61 7429  ,), dtype=float)
+00007070: 0a20 2020 2020 2020 206c 696e 6465 7820  .        lindex 
+00007080: 3d20 6e70 2e65 6d70 7479 2828 746f 745f  = np.empty((tot_
+00007090: 7472 7565 2c29 2c20 6474 7970 653d 696e  true,), dtype=in
+000070a0: 7429 0a20 2020 2020 2020 206c 6469 7363  t).        ldisc
+000070b0: 725f 7669 6577 203d 206c 6469 7363 720a  r_view = ldiscr.
+000070c0: 2020 2020 2020 2020 6c69 6e64 6578 5f76          lindex_v
+000070d0: 6965 7720 3d20 6c69 6e64 6578 0a20 2020  iew = lindex.   
+000070e0: 2020 2020 206c 7265 736f 6c5f 7669 6577       lresol_view
+000070f0: 203d 206c 7265 736f 6c0a 2020 2020 2020   = lresol.      
+00007100: 2020 6a6a 203d 2030 0a20 2020 2020 2020    jj = 0.       
+00007110: 2066 6f72 2069 6920 696e 2072 616e 6765   for ii in range
+00007120: 286e 6469 7363 293a 0a20 2020 2020 2020  (ndisc):.       
+00007130: 2020 2020 2069 6620 6172 655f 696e 5f70       if are_in_p
+00007140: 6f6c 795b 6969 5d3a 0a20 2020 2020 2020  oly[ii]:.       
+00007150: 2020 2020 2020 2020 206c 7265 736f 6c5f           lresol_
+00007160: 7669 6577 5b6a 6a5d 203d 2072 6573 6f6c  view[jj] = resol
+00007170: 7574 696f 6e73 5b30 5d20 2a20 7265 736f  utions[0] * reso
+00007180: 6c75 7469 6f6e 735b 315d 0a20 2020 2020  lutions[1].     
+00007190: 2020 2020 2020 2020 2020 206c 696e 6465             linde
+000071a0: 785f 7669 6577 5b6a 6a5d 203d 206c 696e  x_view[jj] = lin
+000071b0: 6465 785f 746d 705b 6969 5d0a 2020 2020  dex_tmp[ii].    
+000071c0: 2020 2020 2020 2020 2020 2020 6c64 6973              ldis
+000071d0: 6372 5f76 6965 775b 302c 6a6a 5d20 3d20  cr_view[0,jj] = 
+000071e0: 6c64 6973 6372 5f74 6d70 5b69 695d 0a20  ldiscr_tmp[ii]. 
+000071f0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00007200: 6469 7363 725f 7669 6577 5b31 2c6a 6a5d  discr_view[1,jj]
+00007210: 203d 206c 6469 7363 725f 746d 705b 6969   = ldiscr_tmp[ii
+00007220: 202b 206e 6469 7363 5d0a 2020 2020 2020   + ndisc].      
+00007230: 2020 2020 2020 2020 2020 6a6a 203d 206a            jj = j
+00007240: 6a20 2b20 310a 2020 2020 2020 2020 6672  j + 1.        fr
+00007250: 6565 286c 6469 7363 725f 746d 7029 0a20  ee(ldiscr_tmp). 
+00007260: 2020 2020 2020 2066 7265 6528 6c69 6e64         free(lind
+00007270: 6578 5f74 6d70 290a 2020 2020 2020 2020  ex_tmp).        
+00007280: 6672 6565 2861 7265 5f69 6e5f 706f 6c79  free(are_in_poly
+00007290: 290a 2020 2020 2020 2020 6672 6565 286c  ).        free(l
+000072a0: 6469 7363 7265 7431 5f61 7272 290a 2020  discret1_arr).  
+000072b0: 2020 2020 2020 6672 6565 286c 6469 7363        free(ldisc
+000072c0: 7265 7432 5f61 7272 290a 2020 2020 2020  ret2_arr).      
+000072d0: 2020 6672 6565 286c 696e 6465 7831 5f61    free(lindex1_a
+000072e0: 7272 290a 2020 2020 2020 2020 6672 6565  rr).        free
+000072f0: 286c 696e 6465 7832 5f61 7272 290a 2020  (lindex2_arr).  
+00007300: 2020 2020 2020 7265 7475 726e 206c 6469        return ldi
+00007310: 7363 722c 206c 7265 736f 6c2c 5c0a 2020  scr, lresol,\.  
+00007320: 2020 2020 2020 2020 2020 6c69 6e64 6578            lindex
+00007330: 2c20 7265 736f 6c75 7469 6f6e 735b 305d  , resolutions[0]
+00007340: 2c20 7265 736f 6c75 7469 6f6e 735b 315d  , resolutions[1]
+00007350: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+00007360: 2020 206e 6469 7363 203d 206e 696e 6431     ndisc = nind1
+00007370: 202a 206e 696e 6432 0a20 2020 2020 2020   * nind2.       
+00007380: 206c 6469 7363 7220 3d20 6e70 2e65 6d70   ldiscr = np.emp
+00007390: 7479 2828 322c 206e 6469 7363 292c 2064  ty((2, ndisc), d
+000073a0: 7479 7065 3d66 6c6f 6174 290a 2020 2020  type=float).    
+000073b0: 2020 2020 6c72 6573 6f6c 203d 206e 702e      lresol = np.
+000073c0: 656d 7074 7928 286e 6469 7363 2c29 2c20  empty((ndisc,), 
+000073d0: 6474 7970 653d 666c 6f61 7429 0a20 2020  dtype=float).   
+000073e0: 2020 2020 206c 696e 6465 7820 3d20 6e70       lindex = np
+000073f0: 2e65 6d70 7479 2828 6e64 6973 632c 292c  .empty((ndisc,),
+00007400: 2064 7479 7065 3d69 6e74 290a 2020 2020   dtype=int).    
+00007410: 2020 2020 6c64 6973 6372 5f76 6965 7720      ldiscr_view 
+00007420: 3d20 6c64 6973 6372 0a20 2020 2020 2020  = ldiscr.       
+00007430: 206c 696e 6465 785f 7669 6577 203d 206c   lindex_view = l
+00007440: 696e 6465 780a 2020 2020 2020 2020 6c72  index.        lr
+00007450: 6573 6f6c 5f76 6965 7720 3d20 6c72 6573  esol_view = lres
+00007460: 6f6c 0a20 2020 2020 2020 2066 6f72 2069  ol.        for i
+00007470: 6920 696e 2072 616e 6765 286e 696e 6432  i in range(nind2
+00007480: 293a 0a20 2020 2020 2020 2020 2020 2066  ):.            f
+00007490: 6f72 206a 6a20 696e 2072 616e 6765 286e  or jj in range(n
+000074a0: 696e 6431 293a 0a20 2020 2020 2020 2020  ind1):.         
+000074b0: 2020 2020 2020 206e 6e20 3d20 6a6a 202b         nn = jj +
+000074c0: 206e 696e 6431 202a 2069 690a 2020 2020   nind1 * ii.    
+000074d0: 2020 2020 2020 2020 2020 2020 6c64 6973              ldis
+000074e0: 6372 5f76 6965 775b 302c 6e6e 5d20 3d20  cr_view[0,nn] = 
+000074f0: 6c64 6973 6372 6574 315f 6172 725b 6a6a  ldiscret1_arr[jj
+00007500: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00007510: 2020 6c64 6973 6372 5f76 6965 775b 312c    ldiscr_view[1,
+00007520: 6e6e 5d20 3d20 6c64 6973 6372 6574 325f  nn] = ldiscret2_
+00007530: 6172 725b 6969 5d0a 2020 2020 2020 2020  arr[ii].        
+00007540: 2020 2020 2020 2020 6c69 6e64 6578 5f76          lindex_v
+00007550: 6965 775b 6e6e 5d20 3d20 6c69 6e64 6578  iew[nn] = lindex
+00007560: 315f 6172 725b 6a6a 5d20 2b20 6e69 6e64  1_arr[jj] + nind
+00007570: 3120 2a20 6c69 6e64 6578 325f 6172 725b  1 * lindex2_arr[
+00007580: 6969 5d0a 2020 2020 2020 2020 2020 2020  ii].            
+00007590: 2020 2020 6c72 6573 6f6c 5f76 6965 775b      lresol_view[
+000075a0: 6e6e 5d20 3d20 7265 736f 6c75 7469 6f6e  nn] = resolution
+000075b0: 735b 305d 202a 2072 6573 6f6c 7574 696f  s[0] * resolutio
+000075c0: 6e73 5b31 5d0a 2020 2020 2020 2020 6672  ns[1].        fr
+000075d0: 6565 286c 6469 7363 7265 7431 5f61 7272  ee(ldiscret1_arr
+000075e0: 290a 2020 2020 2020 2020 6672 6565 286c  ).        free(l
+000075f0: 6469 7363 7265 7432 5f61 7272 290a 2020  discret2_arr).  
+00007600: 2020 2020 2020 6672 6565 286c 696e 6465        free(linde
+00007610: 7831 5f61 7272 290a 2020 2020 2020 2020  x1_arr).        
+00007620: 6672 6565 286c 696e 6465 7832 5f61 7272  free(lindex2_arr
+00007630: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00007640: 206c 6469 7363 722c 206c 7265 736f 6c2c   ldiscr, lresol,
+00007650: 5c0a 2020 2020 2020 2020 2020 2020 6c69  \.            li
+00007660: 6e64 6578 2c20 7265 736f 6c75 7469 6f6e  ndex, resolution
+00007670: 735b 305d 2c20 7265 736f 6c75 7469 6f6e  s[0], resolution
+00007680: 735b 315d 0a0a 0a64 6566 205f 5665 735f  s[1]...def _Ves_
+00007690: 6d65 7368 4372 6f73 735f 4672 6f6d 496e  meshCross_FromIn
+000076a0: 6428 646f 7562 6c65 5b3a 3a31 5d20 4d69  d(double[::1] Mi
+000076b0: 6e4d 6178 312c 0a20 2020 2020 2020 2020  nMax1,.         
 000076c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000076d0: 2020 2064 6f75 626c 6520 6431 2c0a 2020     double d1,.  
-000076e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000076f0: 2020 2020 2020 2020 2064 6f75 626c 6520           double 
-00007700: 6432 2c0a 2020 2020 2020 2020 2020 2020  d2,.            
-00007710: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00007720: 6f6e 675b 3a3a 315d 2069 6e64 2c0a 2020  ong[::1] ind,.  
-00007730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007740: 2020 2020 2020 2020 2073 7472 2064 534d           str dSM
-00007750: 6f64 653d 2761 6273 272c 0a20 2020 2020  ode='abs',.     
+000076d0: 2020 646f 7562 6c65 5b3a 3a31 5d20 4d69    double[::1] Mi
+000076e0: 6e4d 6178 322c 0a20 2020 2020 2020 2020  nMax2,.         
+000076f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007700: 2020 646f 7562 6c65 2064 312c 0a20 2020    double d1,.   
+00007710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007720: 2020 2020 2020 2020 646f 7562 6c65 2064          double d
+00007730: 322c 0a20 2020 2020 2020 2020 2020 2020  2,.             
+00007740: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+00007750: 6e67 5b3a 3a31 5d20 696e 642c 0a20 2020  ng[::1] ind,.   
 00007760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007770: 2020 2020 2020 646f 7562 6c65 206d 6172        double mar
-00007780: 6769 6e3d 5f56 534d 414c 4c29 3a0a 0a20  gin=_VSMALL):.. 
-00007790: 2020 2063 6465 6620 696e 7420 6969 0a20     cdef int ii. 
-000077a0: 2020 2063 6465 6620 696e 7420 6931 2c20     cdef int i1, 
-000077b0: 6932 0a20 2020 2063 6465 6620 696e 7420  i2.    cdef int 
-000077c0: 6e63 656c 6c73 310a 2020 2020 6364 6566  ncells1.    cdef
-000077d0: 2069 6e74 206d 6f64 655f 6e75 6d0a 2020   int mode_num.  
-000077e0: 2020 6364 6566 2069 6e74 206e 756d 5f70    cdef int num_p
-000077f0: 7473 203d 2069 6e64 2e73 697a 650a 2020  ts = ind.size.  
-00007800: 2020 6364 6566 206c 6f6e 675b 325d 206e    cdef long[2] n
-00007810: 6365 6c6c 730a 2020 2020 6364 6566 206c  cells.    cdef l
-00007820: 6f6e 672a 2064 756d 6d79 203d 204e 554c  ong* dummy = NUL
-00007830: 4c0a 2020 2020 6364 6566 2064 6f75 626c  L.    cdef doubl
-00007840: 6520 6431 722c 2064 3272 0a20 2020 2063  e d1r, d2r.    c
-00007850: 6465 6620 646f 7562 6c65 5b32 5d20 7265  def double[2] re
-00007860: 736f 6c75 7469 6f6e 0a20 2020 2063 6465  solution.    cde
-00007870: 6620 646f 7562 6c65 5b32 5d20 646c 5f61  f double[2] dl_a
-00007880: 7272 6179 0a20 2020 2063 6465 6620 646f  rray.    cdef do
-00007890: 7562 6c65 2a20 5831 203d 204e 554c 4c0a  uble* X1 = NULL.
-000078a0: 2020 2020 6364 6566 2064 6f75 626c 652a      cdef double*
-000078b0: 2058 3220 3d20 4e55 4c4c 0a20 2020 2063   X2 = NULL.    c
-000078c0: 6465 6620 7374 7220 6d6f 6465 5f6c 6f77  def str mode_low
-000078d0: 203d 2064 534d 6f64 652e 6c6f 7765 7228   = dSMode.lower(
-000078e0: 290a 2020 2020 6364 6566 206e 702e 6e64  ).    cdef np.nd
-000078f0: 6172 7261 795b 646f 7562 6c65 2c6e 6469  array[double,ndi
-00007900: 6d3d 325d 2070 7473 5f64 6973 6320 3d20  m=2] pts_disc = 
-00007910: 6e70 2e65 6d70 7479 2828 322c 206e 756d  np.empty((2, num
-00007920: 5f70 7473 2929 0a20 2020 2063 6465 6620  _pts)).    cdef 
-00007930: 6e70 2e6e 6461 7272 6179 5b64 6f75 626c  np.ndarray[doubl
-00007940: 652c 6e64 696d 3d31 5d20 6453 0a20 2020  e,ndim=1] dS.   
-00007950: 2023 202e 2e2e 0a20 2020 206d 6f64 655f   # ....    mode_
-00007960: 6e75 6d20 3d20 5f73 742e 6765 745f 6e62  num = _st.get_nb
-00007970: 5f64 6d6f 6465 286d 6f64 655f 6c6f 7729  _dmode(mode_low)
-00007980: 0a20 2020 2023 202e 2e20 5465 7374 696e  .    # .. Testin
-00007990: 6720 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  g ..............
-000079a0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-000079b0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-000079c0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-000079d0: 2e0a 2020 2020 6572 725f 6d65 7373 203d  ..    err_mess =
-000079e0: 2022 4d6f 6465 2068 6173 2074 6f20 6265   "Mode has to be
-000079f0: 2027 6162 7327 2028 6162 736f 6c75 7465   'abs' (absolute
-00007a00: 2920 6f72 2027 7265 6c27 2028 7265 6c61  ) or 'rel' (rela
-00007a10: 7469 7665 2922 0a20 2020 2061 7373 6572  tive)".    asser
-00007a20: 7420 6d6f 6465 5f6e 756d 203e 3d20 302c  t mode_num >= 0,
-00007a30: 2065 7272 5f6d 6573 730a 2020 2020 232e   err_mess.    #.
-00007a40: 2e20 7072 6570 6172 696e 6720 696e 7075  . preparing inpu
-00007a50: 7473 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ts..............
-00007a60: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00007a70: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00007a80: 2e2e 2e2e 2e2e 2e2e 2e2e 0a20 2020 2064  ...........    d
-00007a90: 6c5f 6172 7261 795b 305d 203d 2043 5f4e  l_array[0] = C_N
-00007aa0: 414e 0a20 2020 2064 6c5f 6172 7261 795b  AN.    dl_array[
-00007ab0: 315d 203d 2043 5f4e 414e 0a20 2020 2023  1] = C_NAN.    #
-00007ac0: 2e2e 2063 616c 6c69 6e67 2063 7974 686f  .. calling cytho
-00007ad0: 6e20 6675 6e63 7469 6f6e 2e2e 2e2e 2e2e  n function......
-00007ae0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00007af0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00007b00: 2e2e 2e2e 2e2e 2e2e 2e2e 2e0a 2020 2020  ............    
-00007b10: 5f73 742e 6469 7363 7265 7469 7a65 5f6c  _st.discretize_l
-00007b20: 696e 6531 645f 636f 7265 2826 4d69 6e4d  ine1d_core(&MinM
-00007b30: 6178 315b 305d 2c20 6431 2c20 646c 5f61  ax1[0], d1, dl_a
-00007b40: 7272 6179 2c20 5472 7565 2c20 6d6f 6465  rray, True, mode
-00007b50: 5f6e 756d 2c0a 2020 2020 2020 2020 2020  _num,.          
-00007b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007b70: 2020 2020 206d 6172 6769 6e2c 2026 5831       margin, &X1
-00007b80: 2c20 2672 6573 6f6c 7574 696f 6e5b 305d  , &resolution[0]
-00007b90: 2c20 2664 756d 6d79 2c0a 2020 2020 2020  , &dummy,.      
-00007ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007bb0: 2020 2020 2020 2020 2026 6e63 656c 6c73           &ncells
-00007bc0: 5b30 5d29 0a20 2020 205f 7374 2e64 6973  [0]).    _st.dis
-00007bd0: 6372 6574 697a 655f 6c69 6e65 3164 5f63  cretize_line1d_c
-00007be0: 6f72 6528 264d 696e 4d61 7832 5b30 5d2c  ore(&MinMax2[0],
-00007bf0: 2064 322c 2064 6c5f 6172 7261 792c 2054   d2, dl_array, T
-00007c00: 7275 652c 206d 6f64 655f 6e75 6d2c 0a20  rue, mode_num,. 
-00007c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007c20: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
-00007c30: 7267 696e 2c20 2658 322c 2026 7265 736f  rgin, &X2, &reso
-00007c40: 6c75 7469 6f6e 5b31 5d2c 2026 6475 6d6d  lution[1], &dumm
-00007c50: 792c 0a20 2020 2020 2020 2020 2020 2020  y,.             
-00007c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007c70: 2020 266e 6365 6c6c 735b 315d 290a 2020    &ncells[1]).  
-00007c80: 2020 6431 7220 3d20 7265 736f 6c75 7469    d1r = resoluti
-00007c90: 6f6e 5b30 5d0a 2020 2020 6432 7220 3d20  on[0].    d2r = 
-00007ca0: 7265 736f 6c75 7469 6f6e 5b31 5d0a 2020  resolution[1].  
-00007cb0: 2020 6e63 656c 6c73 3120 3d20 6e63 656c    ncells1 = ncel
-00007cc0: 6c73 5b30 5d0a 2020 2020 2320 6372 6561  ls[0].    # crea
-00007cd0: 7469 6e67 2061 7272 6179 206f 6620 7265  ting array of re
-00007ce0: 736f 6c75 7469 6f6e 732f 7375 7266 6163  solutions/surfac
-00007cf0: 6573 0a20 2020 2064 5320 3d20 6431 722a  es.    dS = d1r*
-00007d00: 6432 722a 6e70 2e6f 6e65 7328 286e 756d  d2r*np.ones((num
-00007d10: 5f70 7473 2c29 290a 2020 2020 666f 7220  _pts,)).    for 
-00007d20: 6969 2069 6e20 7261 6e67 6528 6e75 6d5f  ii in range(num_
-00007d30: 7074 7329 3a0a 2020 2020 2020 2020 6932  pts):.        i2
-00007d40: 203d 2069 6e64 5b69 695d 202f 2f20 6e63   = ind[ii] // nc
-00007d50: 656c 6c73 310a 2020 2020 2020 2020 6931  ells1.        i1
-00007d60: 203d 2069 6e64 5b69 695d 202d 2069 3220   = ind[ii] - i2 
-00007d70: 2a20 6e63 656c 6c73 310a 2020 2020 2020  * ncells1.      
-00007d80: 2020 7074 735f 6469 7363 5b30 2c20 6969    pts_disc[0, ii
-00007d90: 5d20 3d20 5831 5b69 315d 0a20 2020 2020  ] = X1[i1].     
-00007da0: 2020 2070 7473 5f64 6973 635b 312c 2069     pts_disc[1, i
-00007db0: 695d 203d 2058 325b 6932 5d0a 2020 2020  i] = X2[i2].    
-00007dc0: 2320 6672 6565 696e 6720 6172 7261 7973  # freeing arrays
-00007dd0: 2061 6c6c 6f63 6174 6564 2069 6e20 6469   allocated in di
-00007de0: 7363 7265 7469 7a65 5f6c 696e 6531 645f  scretize_line1d_
-00007df0: 636f 7265 0a20 2020 2066 7265 6528 5831  core.    free(X1
-00007e00: 290a 2020 2020 6672 6565 2858 3229 0a20  ).    free(X2). 
-00007e10: 2020 2066 7265 6528 6475 6d6d 7929 0a20     free(dummy). 
-00007e20: 2020 2072 6574 7572 6e20 7074 735f 6469     return pts_di
-00007e30: 7363 2c20 6453 2c20 6431 722c 2064 3272  sc, dS, d1r, d2r
-00007e40: 0a0a 0a64 6566 2064 6973 6372 6574 697a  ...def discretiz
-00007e50: 655f 7670 6f6c 7928 646f 7562 6c65 5b3a  e_vpoly(double[:
-00007e60: 2c3a 3a31 5d20 5650 6f6c 792c 2064 6f75  ,::1] VPoly, dou
-00007e70: 626c 6520 644c 2c0a 2020 2020 2020 2020  ble dL,.        
-00007e80: 2020 2020 2020 2020 2020 2020 2073 7472               str
-00007e90: 206d 6f64 653d 2761 6273 272c 0a20 2020   mode='abs',.   
-00007ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007eb0: 2020 6c69 7374 2044 313d 4e6f 6e65 2c0a    list D1=None,.
-00007ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007ed0: 2020 2020 206c 6973 7420 4432 3d4e 6f6e       list D2=Non
-00007ee0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00007ef0: 2020 2020 2020 2020 646f 7562 6c65 206d          double m
-00007f00: 6172 6769 6e3d 5f56 534d 414c 4c2c 2064  argin=_VSMALL, d
-00007f10: 6f75 626c 6520 4449 6e3d 302e 2c0a 2020  ouble DIn=0.,.  
-00007f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007f30: 2020 2064 6f75 626c 655b 3a2c 3a3a 315d     double[:,::1]
-00007f40: 2056 496e 3d4e 6f6e 6529 3a0a 2020 2020   VIn=None):.    
-00007f50: 2222 220a 2020 2020 4469 7363 7265 7469  """.    Discreti
-00007f60: 7a65 7320 6120 5650 6f6c 7920 2832 4420  zes a VPoly (2D 
-00007f70: 706f 6c79 676f 6e20 6f66 2061 2063 726f  polygon of a cro
-00007f80: 7373 2073 6563 7469 6f6e 2069 6e20 2852  ss section in (R
-00007f90: 2c5a 2920 636f 6f72 6469 6e61 7465 7329  ,Z) coordinates)
-00007fa0: 2e0a 2020 2020 5468 6520 7265 6669 6e65  ..    The refine
-00007fb0: 6d65 6e74 206f 6e20 5220 616e 6420 5a20  ment on R and Z 
-00007fc0: 6973 2064 6566 696e 6564 2064 4c2e 0a20  is defined dL.. 
-00007fd0: 2020 204f 7074 696f 6e6e 616c 6c79 2079     Optionnally y
-00007fe0: 6f75 2063 616e 2067 6976 6520 6120 636f  ou can give a co
-00007ff0: 6566 6669 6369 656e 7420 2844 496e 2920  efficient (DIn) 
-00008000: 616e 6420 7468 6520 6e6f 726d 616c 2076  and the normal v
-00008010: 6563 746f 7273 2067 6f69 6e67 0a20 2020  ectors going.   
-00008020: 2069 6e77 6172 6473 2074 6865 2056 506f   inwards the VPo
-00008030: 6c79 2028 5649 6e29 2c20 616e 6420 7468  ly (VIn), and th
-00008040: 6520 7265 7375 6c74 2077 696c 6c20 6265  e result will be
-00008050: 2073 6c69 6768 746c 7920 7368 6966 7465   slightly shifte
-00008060: 6420 696e 7761 7264 730a 2020 2020 286f  d inwards.    (o
-00008070: 7220 6f75 7477 6172 6473 2069 6620 4449  r outwards if DI
-00008080: 6e3c 3029 206f 6620 4449 6e2a 5649 6e2e  n<0) of DIn*VIn.
-00008090: 0a20 2020 2050 6172 616d 6574 6572 730a  .    Parameters.
-000080a0: 2020 2020 3d3d 3d3d 3d3d 3d3d 3d3d 0a20      ==========. 
-000080b0: 2020 2056 506f 6c79 203a 2028 322c 206e     VPoly : (2, n
-000080c0: 756d 5f76 6572 7465 7829 2064 6f75 626c  um_vertex) doubl
-000080d0: 6520 6172 7261 790a 2020 2020 2020 2043  e array.       C
-000080e0: 6f6f 7264 696e 6174 6573 206f 6620 7468  oordinates of th
-000080f0: 6520 7665 7274 6963 6573 206f 6620 7468  e vertices of th
-00008100: 6520 506f 6c79 676f 6e20 6465 6669 6e69  e Polygon defini
-00008110: 6e67 2074 6865 2032 4420 706f 6c6f 6964  ng the 2D poloid
-00008120: 616c 0a20 2020 2020 2020 6375 7420 6f66  al.       cut of
-00008130: 2074 6865 2056 6573 7365 6c0a 2020 2020   the Vessel.    
-00008140: 644c 203a 2064 6f75 626c 650a 2020 2020  dL : double.    
-00008150: 2020 2020 5374 6570 206f 6620 6469 7363      Step of disc
-00008160: 7265 7469 7a61 7469 6f6e 2c20 6361 6e20  retization, can 
-00008170: 6265 2061 6273 6f6c 7574 6520 2864 6566  be absolute (def
-00008180: 6175 6c74 2920 6f72 2072 656c 6174 6976  ault) or relativ
-00008190: 650a 2020 2020 4431 206f 7220 4432 203a  e.    D1 or D2 :
-000081a0: 2028 6f70 7469 6f6e 616c 2920 2832 292d   (optional) (2)-
-000081b0: 646f 7562 6c65 2061 7272 6179 0a20 2020  double array.   
-000081c0: 2020 2020 2053 7562 2064 6f6d 6169 6e20       Sub domain 
-000081d0: 6f66 2064 6973 6372 6574 697a 6174 696f  of discretizatio
-000081e0: 6e2e 0a20 2020 2020 2020 2028 6361 6e20  n..        (can 
-000081f0: 6265 206f 6e6c 7920 6f6e 206f 6e65 206c  be only on one l
-00008200: 696d 6974 2061 6e64 2063 616e 2062 6520  imit and can be 
-00008210: 6269 6767 6572 206f 7220 736d 616c 6c65  bigger or smalle
-00008220: 7220 7468 616e 206f 7269 6769 6e61 6c29  r than original)
-00008230: 2e0a 2020 2020 2020 2020 4163 7475 616c  ..        Actual
-00008240: 2064 6573 6972 6564 206c 696d 6974 730a   desired limits.
-00008250: 2020 2020 6d6f 6465 203a 2028 6f70 7469      mode : (opti
-00008260: 6f6e 616c 2920 7374 7269 6e67 0a20 2020  onal) string.   
-00008270: 2020 2020 2049 6620 606d 6f64 6560 2069       If `mode` i
-00008280: 7320 2261 6273 2220 2861 6273 6f6c 7574  s "abs" (absolut
-00008290: 6529 2c20 7468 656e 2074 6865 0a20 2020  e), then the.   
-000082a0: 2020 2020 2073 6567 6d65 6e74 2077 696c       segment wil
-000082b0: 6c20 6265 2064 6973 6372 6574 697a 6564  l be discretized
-000082c0: 2069 6e20 6365 6c6c 7320 6561 6368 206f   in cells each o
-000082d0: 6620 7369 7a65 2060 6473 7465 7060 2e20  f size `dstep`. 
-000082e0: 456c 7365 2c0a 2020 2020 2020 2020 6966  Else,.        if
-000082f0: 2022 7265 6c22 2028 7265 6c61 7469 7665   "rel" (relative
-00008300: 292c 2074 6865 206d 6573 6869 6e67 2073  ), the meshing s
-00008310: 7465 7020 6973 2072 656c 6174 6976 6520  tep is relative 
-00008320: 746f 2074 6865 2073 6567 6d65 6e74 7320  to the segments 
-00008330: 6e6f 726d 0a20 2020 206d 6172 6769 6e20  norm.    margin 
-00008340: 3a20 286f 7074 696f 6e61 6c29 2064 6f75  : (optional) dou
-00008350: 626c 650a 2020 2020 2020 2020 4d61 7267  ble.        Marg
-00008360: 696e 2076 616c 7565 2066 6f72 2063 656c  in value for cel
-00008370: 6c20 6c65 6e67 7468 0a20 2020 2052 6574  l length.    Ret
-00008380: 7572 6e73 0a20 2020 203d 3d3d 3d3d 3d3d  urns.    =======
-00008390: 0a20 2020 2072 6574 7572 6e20 5074 7343  .    return PtsC
-000083a0: 726f 7373 2c20 7265 736f 6c2c 2069 6e64  ross, resol, ind
-000083b0: 5f61 7272 2c20 4e5f 6172 722c 2052 7265  _arr, N_arr, Rre
-000083c0: 665f 6172 722c 2056 506f 6c79 6269 730a  f_arr, VPolybis.
-000083d0: 2020 2020 5074 7343 726f 7373 3a20 646f      PtsCross: do
-000083e0: 7562 6c65 2032 6420 6172 7261 790a 2020  uble 2d array.  
-000083f0: 2020 2020 2020 6172 7261 7920 6f66 2074        array of t
-00008400: 6865 2064 6973 6372 6574 697a 6564 2063  he discretized c
-00008410: 6f6f 7264 696e 6174 6573 206f 6620 7468  oordinates of th
-00008420: 6520 5650 6f6c 790a 2020 2020 7265 736f  e VPoly.    reso
-00008430: 6c3a 2064 6f75 626c 6520 3164 2061 7272  l: double 1d arr
-00008440: 6179 0a20 2020 2020 2020 2073 7465 7020  ay.        step 
-00008450: 6f66 2064 6973 6372 6574 697a 6174 696f  of discretizatio
-00008460: 6e20 6f6e 2032 640a 2020 2020 696e 645f  n on 2d.    ind_
-00008470: 6172 723a 2069 6e74 2020 3164 2061 7272  arr: int  1d arr
-00008480: 6179 0a20 2020 2020 2020 2061 7272 6179  ay.        array
-00008490: 206f 6620 7468 6520 696e 6469 6365 7320   of the indices 
-000084a0: 636f 7272 6573 706f 6e64 696e 6720 746f  corresponding to
-000084b0: 206c 6469 7363 7265 7420 7769 7468 2072   ldiscret with r
-000084c0: 6573 7065 6374 7320 746f 2074 6865 0a20  espects to the. 
-000084d0: 2020 2020 2020 206f 7269 6769 6e61 6c20         original 
-000084e0: 5650 6f6c 790a 2020 2020 4e5f 6172 7220  VPoly.    N_arr 
-000084f0: 3a20 696e 7420 3164 2061 7272 6179 0a20  : int 1d array. 
-00008500: 2020 2020 2020 206e 756d 6265 7220 6f66         number of
-00008510: 2063 656c 6c73 206f 6e20 6561 6368 2073   cells on each s
-00008520: 6567 6d65 6e74 206f 6620 7468 6520 5650  egment of the VP
-00008530: 6f6c 790a 2020 2020 5272 6566 5f61 7272  oly.    Rref_arr
-00008540: 203a 2064 6f75 626c 6520 3164 2061 7272   : double 1d arr
-00008550: 6179 0a20 2020 2020 2020 2072 6566 6572  ay.        refer
-00008560: 656e 6365 2052 6164 6975 7320 636f 6f72  ence Radius coor
-00008570: 6469 6e61 7465 732c 206e 6f74 2073 6869  dinates, not shi
-00008580: 6674 6564 2065 7665 6e20 6966 2044 496e  fted even if DIn
-00008590: 203c 3e20 302e 0a20 2020 2020 2020 2049   <> 0..        I
-000085a0: 6620 4449 6e20 3d3d 2030 2c20 7468 656e  f DIn == 0, then
-000085b0: 2052 7265 665f 6172 7220 3d20 5074 7343   Rref_arr = PtsC
-000085c0: 726f 7373 5b30 2c20 2e2e 2e5d 0a20 2020  ross[0, ...].   
-000085d0: 2056 506f 6c79 6269 7320 3a0a 0a20 2020   VPolybis :..   
-000085e0: 2022 2222 0a20 2020 2063 6465 6620 696e   """.    cdef in
-000085f0: 7420 6e70 7473 5f64 6973 633d 5650 6f6c  t npts_disc=VPol
-00008600: 792e 7368 6170 655b 315d 0a20 2020 2063  y.shape[1].    c
-00008610: 6465 6620 696e 745b 315d 2073 7a5f 7662  def int[1] sz_vb
-00008620: 2c20 737a 5f6f 740a 2020 2020 6364 6566  , sz_ot.    cdef
-00008630: 2064 6f75 626c 652a 2058 4372 6f73 7320   double* XCross 
-00008640: 3d20 4e55 4c4c 0a20 2020 2063 6465 6620  = NULL.    cdef 
-00008650: 646f 7562 6c65 2a20 5943 726f 7373 203d  double* YCross =
-00008660: 204e 554c 4c0a 2020 2020 6364 6566 2064   NULL.    cdef d
-00008670: 6f75 626c 652a 2058 506f 6c79 6269 7320  ouble* XPolybis 
-00008680: 3d20 4e55 4c4c 0a20 2020 2063 6465 6620  = NULL.    cdef 
-00008690: 646f 7562 6c65 2a20 5950 6f6c 7962 6973  double* YPolybis
-000086a0: 203d 204e 554c 4c0a 2020 2020 6364 6566   = NULL.    cdef
-000086b0: 2064 6f75 626c 652a 2052 7265 6620 3d20   double* Rref = 
-000086c0: 4e55 4c4c 0a20 2020 2063 6465 6620 646f  NULL.    cdef do
-000086d0: 7562 6c65 2a20 7265 736f 6c75 7469 6f6e  uble* resolution
-000086e0: 203d 204e 554c 4c0a 2020 2020 6364 6566   = NULL.    cdef
-000086f0: 206c 6f6e 672a 2069 6e64 203d 204e 554c   long* ind = NUL
-00008700: 4c0a 2020 2020 6364 6566 206c 6f6e 672a  L.    cdef long*
-00008710: 206e 756d 6365 6c6c 7320 3d20 4e55 4c4c   numcells = NULL
-00008720: 0a20 2020 2063 6465 6620 6e70 2e6e 6461  .    cdef np.nda
-00008730: 7272 6179 5b64 6f75 626c 652c 6e64 696d  rray[double,ndim
-00008740: 3d32 5d20 5074 7343 726f 7373 2c20 5650  =2] PtsCross, VP
-00008750: 6f6c 7962 6973 0a20 2020 2063 6465 6620  olybis.    cdef 
-00008760: 6e70 2e6e 6461 7272 6179 5b64 6f75 626c  np.ndarray[doubl
-00008770: 652c 6e64 696d 3d31 5d20 5074 7343 726f  e,ndim=1] PtsCro
-00008780: 7373 582c 2050 7473 4372 6f73 7359 0a20  ssX, PtsCrossY. 
-00008790: 2020 2063 6465 6620 6e70 2e6e 6461 7272     cdef np.ndarr
-000087a0: 6179 5b64 6f75 626c 652c 6e64 696d 3d31  ay[double,ndim=1
-000087b0: 5d20 5650 6f6c 7962 6973 582c 2056 506f  ] VPolybisX, VPo
-000087c0: 6c79 6269 7359 0a20 2020 2063 6465 6620  lybisY.    cdef 
-000087d0: 6e70 2e6e 6461 7272 6179 5b64 6f75 626c  np.ndarray[doubl
-000087e0: 652c 6e64 696d 3d31 5d20 5272 6566 5f61  e,ndim=1] Rref_a
-000087f0: 7272 2c20 7265 736f 6c0a 2020 2020 6364  rr, resol.    cd
-00008800: 6566 206e 702e 6e64 6172 7261 795b 6c6f  ef np.ndarray[lo
-00008810: 6e67 2c6e 6469 6d3d 315d 2069 6e64 5f61  ng,ndim=1] ind_a
-00008820: 7272 2c20 4e5f 6172 720a 2020 2020 6364  rr, N_arr.    cd
-00008830: 6566 206e 702e 6e64 6172 7261 795b 6e70  ef np.ndarray[np
-00008840: 2e6e 7079 5f62 6f6f 6c2c 6e64 696d 3d31  .npy_bool,ndim=1
-00008850: 2c63 6173 743d 5472 7565 5d20 696e 6469  ,cast=True] indi
-00008860: 6e0a 2020 2020 6364 6566 2073 7472 206d  n.    cdef str m
-00008870: 6f64 655f 6c6f 7720 3d20 6d6f 6465 2e6c  ode_low = mode.l
-00008880: 6f77 6572 2829 0a20 2020 2063 6465 6620  ower().    cdef 
-00008890: 696e 7420 6d6f 6465 5f6e 756d 203d 205f  int mode_num = _
-000088a0: 7374 2e67 6574 5f6e 625f 646d 6f64 6528  st.get_nb_dmode(
-000088b0: 6d6f 6465 5f6c 6f77 290a 2020 2020 2320  mode_low).    # 
-000088c0: 2e2e 2054 6573 7469 6e67 202e 2e2e 2e2e  .. Testing .....
-000088d0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-000088e0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-000088f0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00008900: 2e2e 2e2e 2e2e 2e2e 2e2e 0a20 2020 2061  ...........    a
-00008910: 7373 6572 7420 6d6f 6465 5f6e 756d 203e  ssert mode_num >
-00008920: 3d20 302c 2022 4d6f 6465 2068 6173 2074  = 0, "Mode has t
-00008930: 6f20 6265 2027 6162 7327 2028 6162 736f  o be 'abs' (abso
-00008940: 6c75 7465 2920 6f72 2027 7265 6c27 2028  lute) or 'rel' (
-00008950: 7265 6c61 7469 7665 2922 0a20 2020 2061  relative)".    a
-00008960: 7373 6572 7420 286e 6f74 2028 4449 6e20  ssert (not (DIn 
-00008970: 3d3d 2030 2e29 206f 7220 5649 6e20 6973  == 0.) or VIn is
-00008980: 206e 6f74 204e 6f6e 6529 0a20 2020 2023   not None).    #
-00008990: 202e 2e20 7072 6570 6172 696e 6720 696e   .. preparing in
-000089a0: 7075 7473 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  puts............
-000089b0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-000089c0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-000089d0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e0a 2020 2020  ............    
-000089e0: 5f73 742e 6469 7363 7265 7469 7a65 5f76  _st.discretize_v
-000089f0: 706f 6c79 5f63 6f72 6528 5650 6f6c 792c  poly_core(VPoly,
-00008a00: 2064 4c2c 206d 6f64 655f 6e75 6d2c 206d   dL, mode_num, m
-00008a10: 6172 6769 6e2c 2044 496e 2c20 5649 6e2c  argin, DIn, VIn,
-00008a20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008a30: 2020 2020 2020 2020 2020 2020 2026 5843               &XC
-00008a40: 726f 7373 2c20 2659 4372 6f73 732c 2026  ross, &YCross, &
-00008a50: 7265 736f 6c75 7469 6f6e 2c0a 2020 2020  resolution,.    
-00008a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008a70: 2020 2020 2020 2020 2669 6e64 2c20 266e          &ind, &n
-00008a80: 756d 6365 6c6c 732c 2026 5272 6566 2c20  umcells, &Rref, 
-00008a90: 2658 506f 6c79 6269 732c 2026 5950 6f6c  &XPolybis, &YPol
-00008aa0: 7962 6973 2c0a 2020 2020 2020 2020 2020  ybis,.          
-00008ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008ac0: 2020 2673 7a5f 7662 5b30 5d2c 2026 737a    &sz_vb[0], &sz
-00008ad0: 5f6f 745b 305d 2c20 6e70 7473 5f64 6973  _ot[0], npts_dis
-00008ae0: 6329 0a20 2020 2061 7373 6572 7420 6e6f  c).    assert no
-00008af0: 7420 2828 5843 726f 7373 203d 3d20 4e55  t ((XCross == NU
-00008b00: 4c4c 2920 6f72 2028 5943 726f 7373 203d  LL) or (YCross =
-00008b10: 3d20 4e55 4c4c 290a 2020 2020 2020 2020  = NULL).        
-00008b20: 2020 2020 2020 2020 6f72 2028 5850 6f6c          or (XPol
-00008b30: 7962 6973 203d 3d20 4e55 4c4c 2920 6f72  ybis == NULL) or
-00008b40: 2028 5950 6f6c 7962 6973 203d 3d20 4e55   (YPolybis == NU
-00008b50: 4c4c 2929 0a20 2020 2050 7473 4372 6f73  LL)).    PtsCros
-00008b60: 7358 203d 206e 702e 6172 7261 7928 3c64  sX = np.array(<d
-00008b70: 6f75 626c 655b 3a73 7a5f 6f74 5b30 5d5d  ouble[:sz_ot[0]]
-00008b80: 3e20 5843 726f 7373 290a 2020 2020 5074  > XCross).    Pt
-00008b90: 7343 726f 7373 5920 3d20 6e70 2e61 7272  sCrossY = np.arr
-00008ba0: 6179 283c 646f 7562 6c65 5b3a 737a 5f6f  ay(<double[:sz_o
-00008bb0: 745b 305d 5d3e 2059 4372 6f73 7329 0a20  t[0]]> YCross). 
-00008bc0: 2020 2050 7473 4372 6f73 7320 3d20 6e70     PtsCross = np
-00008bd0: 2e61 7272 6179 285b 5074 7343 726f 7373  .array([PtsCross
-00008be0: 582c 5074 7343 726f 7373 595d 290a 2020  X,PtsCrossY]).  
-00008bf0: 2020 5650 6f6c 7962 6973 5820 3d20 6e70    VPolybisX = np
-00008c00: 2e61 7272 6179 283c 646f 7562 6c65 5b3a  .array(<double[:
-00008c10: 737a 5f76 625b 305d 5d3e 2058 506f 6c79  sz_vb[0]]> XPoly
-00008c20: 6269 7329 0a20 2020 2056 506f 6c79 6269  bis).    VPolybi
-00008c30: 7359 203d 206e 702e 6172 7261 7928 3c64  sY = np.array(<d
-00008c40: 6f75 626c 655b 3a73 7a5f 7662 5b30 5d5d  ouble[:sz_vb[0]]
-00008c50: 3e20 5950 6f6c 7962 6973 290a 2020 2020  > YPolybis).    
-00008c60: 5650 6f6c 7962 6973 203d 206e 702e 6172  VPolybis = np.ar
-00008c70: 7261 7928 5b56 506f 6c79 6269 7358 2c20  ray([VPolybisX, 
-00008c80: 5650 6f6c 7962 6973 595d 290a 2020 2020  VPolybisY]).    
-00008c90: 7265 736f 6c20 3d20 6e70 2e61 7272 6179  resol = np.array
-00008ca0: 283c 646f 7562 6c65 5b3a 737a 5f6f 745b  (<double[:sz_ot[
-00008cb0: 305d 5d3e 2072 6573 6f6c 7574 696f 6e29  0]]> resolution)
-00008cc0: 0a20 2020 2052 7265 665f 6172 7220 3d20  .    Rref_arr = 
-00008cd0: 6e70 2e61 7272 6179 283c 646f 7562 6c65  np.array(<double
-00008ce0: 5b3a 737a 5f6f 745b 305d 5d3e 2052 7265  [:sz_ot[0]]> Rre
-00008cf0: 6629 0a20 2020 2069 6e64 5f61 7272 203d  f).    ind_arr =
-00008d00: 206e 702e 6172 7261 7928 3c6c 6f6e 675b   np.array(<long[
-00008d10: 3a73 7a5f 6f74 5b30 5d5d 3e20 696e 6429  :sz_ot[0]]> ind)
-00008d20: 0a20 2020 204e 5f61 7272 203d 206e 702e  .    N_arr = np.
-00008d30: 6172 7261 7928 3c6c 6f6e 675b 3a6e 7074  array(<long[:npt
-00008d40: 735f 6469 7363 2d31 5d3e 206e 756d 6365  s_disc-1]> numce
-00008d50: 6c6c 7329 0a20 2020 2069 6620 4431 2069  lls).    if D1 i
-00008d60: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00008d70: 2020 2020 696e 6469 6e20 3d20 2850 7473      indin = (Pts
-00008d80: 4372 6f73 735b 302c 3a5d 3e3d 4431 5b30  Cross[0,:]>=D1[0
-00008d90: 5d29 2026 2028 5074 7343 726f 7373 5b30  ]) & (PtsCross[0
-00008da0: 2c3a 5d3c 3d44 315b 315d 290a 2020 2020  ,:]<=D1[1]).    
-00008db0: 2020 2020 5074 7343 726f 7373 203d 2050      PtsCross = P
-00008dc0: 7473 4372 6f73 735b 3a2c 696e 6469 6e5d  tsCross[:,indin]
-00008dd0: 0a20 2020 2020 2020 2072 6573 6f6c 203d  .        resol =
-00008de0: 2072 6573 6f6c 5b69 6e64 696e 5d0a 2020   resol[indin].  
-00008df0: 2020 2020 2020 696e 645f 6172 7220 3d20        ind_arr = 
-00008e00: 696e 645f 6172 725b 696e 6469 6e5d 0a20  ind_arr[indin]. 
-00008e10: 2020 2069 6620 4432 2069 7320 6e6f 7420     if D2 is not 
-00008e20: 4e6f 6e65 3a0a 2020 2020 2020 2020 696e  None:.        in
-00008e30: 6469 6e20 3d20 2850 7473 4372 6f73 735b  din = (PtsCross[
-00008e40: 312c 3a5d 3e3d 4432 5b30 5d29 2026 2028  1,:]>=D2[0]) & (
-00008e50: 5074 7343 726f 7373 5b31 2c3a 5d3c 3d44  PtsCross[1,:]<=D
-00008e60: 325b 315d 290a 2020 2020 2020 2020 5074  2[1]).        Pt
-00008e70: 7343 726f 7373 203d 2050 7473 4372 6f73  sCross = PtsCros
-00008e80: 735b 3a2c 696e 6469 6e5d 0a20 2020 2020  s[:,indin].     
-00008e90: 2020 2072 6573 6f6c 203d 2072 6573 6f6c     resol = resol
-00008ea0: 5b69 6e64 696e 5d0a 2020 2020 2020 2020  [indin].        
-00008eb0: 696e 645f 6172 7220 3d20 696e 645f 6172  ind_arr = ind_ar
-00008ec0: 725b 696e 6469 6e5d 0a20 2020 2066 7265  r[indin].    fre
-00008ed0: 6528 5843 726f 7373 290a 2020 2020 6672  e(XCross).    fr
-00008ee0: 6565 2859 4372 6f73 7329 0a20 2020 2066  ee(YCross).    f
-00008ef0: 7265 6528 5850 6f6c 7962 6973 290a 2020  ree(XPolybis).  
-00008f00: 2020 6672 6565 2859 506f 6c79 6269 7329    free(YPolybis)
-00008f10: 0a20 2020 2066 7265 6528 7265 736f 6c75  .    free(resolu
-00008f20: 7469 6f6e 290a 2020 2020 6672 6565 2852  tion).    free(R
-00008f30: 7265 6629 0a20 2020 2066 7265 6528 696e  ref).    free(in
-00008f40: 6429 0a20 2020 2066 7265 6528 6e75 6d63  d).    free(numc
-00008f50: 656c 6c73 290a 2020 2020 7265 7475 726e  ells).    return
-00008f60: 2050 7473 4372 6f73 732c 2072 6573 6f6c   PtsCross, resol
-00008f70: 2c20 696e 645f 6172 722c 204e 5f61 7272  , ind_arr, N_arr
-00008f80: 2c20 5272 6566 5f61 7272 2c20 5650 6f6c  , Rref_arr, VPol
-00008f90: 7962 6973 0a0a 0a23 203d 3d3d 3d3d 3d3d  ybis...# =======
-00008fa0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00008fb0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00008fc0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00007770: 2020 2020 2020 2020 7374 7220 6453 4d6f          str dSMo
+00007780: 6465 3d27 6162 7327 2c0a 2020 2020 2020  de='abs',.      
+00007790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000077a0: 2020 2020 2064 6f75 626c 6520 6d61 7267       double marg
+000077b0: 696e 3d5f 5653 4d41 4c4c 293a 0a0a 2020  in=_VSMALL):..  
+000077c0: 2020 6364 6566 2069 6e74 2069 690a 2020    cdef int ii.  
+000077d0: 2020 6364 6566 2069 6e74 2069 312c 2069    cdef int i1, i
+000077e0: 320a 2020 2020 6364 6566 2069 6e74 206e  2.    cdef int n
+000077f0: 6365 6c6c 7331 0a20 2020 2063 6465 6620  cells1.    cdef 
+00007800: 696e 7420 6d6f 6465 5f6e 756d 0a20 2020  int mode_num.   
+00007810: 2063 6465 6620 696e 7420 6e75 6d5f 7074   cdef int num_pt
+00007820: 7320 3d20 696e 642e 7369 7a65 0a20 2020  s = ind.size.   
+00007830: 2063 6465 6620 6c6f 6e67 5b32 5d20 6e63   cdef long[2] nc
+00007840: 656c 6c73 0a20 2020 2063 6465 6620 6c6f  ells.    cdef lo
+00007850: 6e67 2a20 6475 6d6d 7920 3d20 4e55 4c4c  ng* dummy = NULL
+00007860: 0a20 2020 2063 6465 6620 646f 7562 6c65  .    cdef double
+00007870: 2064 3172 2c20 6432 720a 2020 2020 6364   d1r, d2r.    cd
+00007880: 6566 2064 6f75 626c 655b 325d 2072 6573  ef double[2] res
+00007890: 6f6c 7574 696f 6e0a 2020 2020 6364 6566  olution.    cdef
+000078a0: 2064 6f75 626c 655b 325d 2064 6c5f 6172   double[2] dl_ar
+000078b0: 7261 790a 2020 2020 6364 6566 2064 6f75  ray.    cdef dou
+000078c0: 626c 652a 2058 3120 3d20 4e55 4c4c 0a20  ble* X1 = NULL. 
+000078d0: 2020 2063 6465 6620 646f 7562 6c65 2a20     cdef double* 
+000078e0: 5832 203d 204e 554c 4c0a 2020 2020 6364  X2 = NULL.    cd
+000078f0: 6566 2073 7472 206d 6f64 655f 6c6f 7720  ef str mode_low 
+00007900: 3d20 6453 4d6f 6465 2e6c 6f77 6572 2829  = dSMode.lower()
+00007910: 0a20 2020 2063 6465 6620 6e70 2e6e 6461  .    cdef np.nda
+00007920: 7272 6179 5b64 6f75 626c 652c 6e64 696d  rray[double,ndim
+00007930: 3d32 5d20 7074 735f 6469 7363 203d 206e  =2] pts_disc = n
+00007940: 702e 656d 7074 7928 2832 2c20 6e75 6d5f  p.empty((2, num_
+00007950: 7074 7329 290a 2020 2020 6364 6566 206e  pts)).    cdef n
+00007960: 702e 6e64 6172 7261 795b 646f 7562 6c65  p.ndarray[double
+00007970: 2c6e 6469 6d3d 315d 2064 530a 2020 2020  ,ndim=1] dS.    
+00007980: 2320 2e2e 2e0a 2020 2020 6d6f 6465 5f6e  # ....    mode_n
+00007990: 756d 203d 205f 7374 2e67 6574 5f6e 625f  um = _st.get_nb_
+000079a0: 646d 6f64 6528 6d6f 6465 5f6c 6f77 290a  dmode(mode_low).
+000079b0: 2020 2020 2320 2e2e 2054 6573 7469 6e67      # .. Testing
+000079c0: 202e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e   ...............
+000079d0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+000079e0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+000079f0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00007a00: 0a20 2020 2065 7272 5f6d 6573 7320 3d20  .    err_mess = 
+00007a10: 224d 6f64 6520 6861 7320 746f 2062 6520  "Mode has to be 
+00007a20: 2761 6273 2720 2861 6273 6f6c 7574 6529  'abs' (absolute)
+00007a30: 206f 7220 2772 656c 2720 2872 656c 6174   or 'rel' (relat
+00007a40: 6976 6529 220a 2020 2020 6173 7365 7274  ive)".    assert
+00007a50: 206d 6f64 655f 6e75 6d20 3e3d 2030 2c20   mode_num >= 0, 
+00007a60: 6572 725f 6d65 7373 0a20 2020 2023 2e2e  err_mess.    #..
+00007a70: 2070 7265 7061 7269 6e67 2069 6e70 7574   preparing input
+00007a80: 732e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  s...............
+00007a90: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00007aa0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00007ab0: 2e2e 2e2e 2e2e 2e2e 2e0a 2020 2020 646c  ..........    dl
+00007ac0: 5f61 7272 6179 5b30 5d20 3d20 435f 4e41  _array[0] = C_NA
+00007ad0: 4e0a 2020 2020 646c 5f61 7272 6179 5b31  N.    dl_array[1
+00007ae0: 5d20 3d20 435f 4e41 4e0a 2020 2020 232e  ] = C_NAN.    #.
+00007af0: 2e20 6361 6c6c 696e 6720 6379 7468 6f6e  . calling cython
+00007b00: 2066 756e 6374 696f 6e2e 2e2e 2e2e 2e2e   function.......
+00007b10: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00007b20: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00007b30: 2e2e 2e2e 2e2e 2e2e 2e2e 0a20 2020 205f  ...........    _
+00007b40: 7374 2e64 6973 6372 6574 697a 655f 6c69  st.discretize_li
+00007b50: 6e65 3164 5f63 6f72 6528 264d 696e 4d61  ne1d_core(&MinMa
+00007b60: 7831 5b30 5d2c 2064 312c 2064 6c5f 6172  x1[0], d1, dl_ar
+00007b70: 7261 792c 2054 7275 652c 206d 6f64 655f  ray, True, mode_
+00007b80: 6e75 6d2c 0a20 2020 2020 2020 2020 2020  num,.           
+00007b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007ba0: 2020 2020 6d61 7267 696e 2c20 2658 312c      margin, &X1,
+00007bb0: 2026 7265 736f 6c75 7469 6f6e 5b30 5d2c   &resolution[0],
+00007bc0: 2026 6475 6d6d 792c 0a20 2020 2020 2020   &dummy,.       
+00007bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007be0: 2020 2020 2020 2020 266e 6365 6c6c 735b          &ncells[
+00007bf0: 305d 290a 2020 2020 5f73 742e 6469 7363  0]).    _st.disc
+00007c00: 7265 7469 7a65 5f6c 696e 6531 645f 636f  retize_line1d_co
+00007c10: 7265 2826 4d69 6e4d 6178 325b 305d 2c20  re(&MinMax2[0], 
+00007c20: 6432 2c20 646c 5f61 7272 6179 2c20 5472  d2, dl_array, Tr
+00007c30: 7565 2c20 6d6f 6465 5f6e 756d 2c0a 2020  ue, mode_num,.  
+00007c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007c50: 2020 2020 2020 2020 2020 2020 206d 6172               mar
+00007c60: 6769 6e2c 2026 5832 2c20 2672 6573 6f6c  gin, &X2, &resol
+00007c70: 7574 696f 6e5b 315d 2c20 2664 756d 6d79  ution[1], &dummy
+00007c80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00007c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007ca0: 2026 6e63 656c 6c73 5b31 5d29 0a20 2020   &ncells[1]).   
+00007cb0: 2064 3172 203d 2072 6573 6f6c 7574 696f   d1r = resolutio
+00007cc0: 6e5b 305d 0a20 2020 2064 3272 203d 2072  n[0].    d2r = r
+00007cd0: 6573 6f6c 7574 696f 6e5b 315d 0a20 2020  esolution[1].   
+00007ce0: 206e 6365 6c6c 7331 203d 206e 6365 6c6c   ncells1 = ncell
+00007cf0: 735b 305d 0a20 2020 2023 2063 7265 6174  s[0].    # creat
+00007d00: 696e 6720 6172 7261 7920 6f66 2072 6573  ing array of res
+00007d10: 6f6c 7574 696f 6e73 2f73 7572 6661 6365  olutions/surface
+00007d20: 730a 2020 2020 6453 203d 2064 3172 2a64  s.    dS = d1r*d
+00007d30: 3272 2a6e 702e 6f6e 6573 2828 6e75 6d5f  2r*np.ones((num_
+00007d40: 7074 732c 2929 0a20 2020 2066 6f72 2069  pts,)).    for i
+00007d50: 6920 696e 2072 616e 6765 286e 756d 5f70  i in range(num_p
+00007d60: 7473 293a 0a20 2020 2020 2020 2069 3220  ts):.        i2 
+00007d70: 3d20 696e 645b 6969 5d20 2f2f 206e 6365  = ind[ii] // nce
+00007d80: 6c6c 7331 0a20 2020 2020 2020 2069 3120  lls1.        i1 
+00007d90: 3d20 696e 645b 6969 5d20 2d20 6932 202a  = ind[ii] - i2 *
+00007da0: 206e 6365 6c6c 7331 0a20 2020 2020 2020   ncells1.       
+00007db0: 2070 7473 5f64 6973 635b 302c 2069 695d   pts_disc[0, ii]
+00007dc0: 203d 2058 315b 6931 5d0a 2020 2020 2020   = X1[i1].      
+00007dd0: 2020 7074 735f 6469 7363 5b31 2c20 6969    pts_disc[1, ii
+00007de0: 5d20 3d20 5832 5b69 325d 0a20 2020 2023  ] = X2[i2].    #
+00007df0: 2066 7265 6569 6e67 2061 7272 6179 7320   freeing arrays 
+00007e00: 616c 6c6f 6361 7465 6420 696e 2064 6973  allocated in dis
+00007e10: 6372 6574 697a 655f 6c69 6e65 3164 5f63  cretize_line1d_c
+00007e20: 6f72 650a 2020 2020 6672 6565 2858 3129  ore.    free(X1)
+00007e30: 0a20 2020 2066 7265 6528 5832 290a 2020  .    free(X2).  
+00007e40: 2020 6672 6565 2864 756d 6d79 290a 2020    free(dummy).  
+00007e50: 2020 7265 7475 726e 2070 7473 5f64 6973    return pts_dis
+00007e60: 632c 2064 532c 2064 3172 2c20 6432 720a  c, dS, d1r, d2r.
+00007e70: 0a0a 6465 6620 6469 7363 7265 7469 7a65  ..def discretize
+00007e80: 5f76 706f 6c79 2864 6f75 626c 655b 3a2c  _vpoly(double[:,
+00007e90: 3a3a 315d 2056 506f 6c79 2c20 646f 7562  ::1] VPoly, doub
+00007ea0: 6c65 2064 4c2c 0a20 2020 2020 2020 2020  le dL,.         
+00007eb0: 2020 2020 2020 2020 2020 2020 7374 7220              str 
+00007ec0: 6d6f 6465 3d27 6162 7327 2c0a 2020 2020  mode='abs',.    
+00007ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007ee0: 206c 6973 7420 4431 3d4e 6f6e 652c 0a20   list D1=None,. 
+00007ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007f00: 2020 2020 6c69 7374 2044 323d 4e6f 6e65      list D2=None
+00007f10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00007f20: 2020 2020 2020 2064 6f75 626c 6520 6d61         double ma
+00007f30: 7267 696e 3d5f 5653 4d41 4c4c 2c20 646f  rgin=_VSMALL, do
+00007f40: 7562 6c65 2044 496e 3d30 2e2c 0a20 2020  uble DIn=0.,.   
+00007f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007f60: 2020 646f 7562 6c65 5b3a 2c3a 3a31 5d20    double[:,::1] 
+00007f70: 5649 6e3d 4e6f 6e65 293a 0a20 2020 2022  VIn=None):.    "
+00007f80: 2222 0a20 2020 2044 6973 6372 6574 697a  "".    Discretiz
+00007f90: 6573 2061 2056 506f 6c79 2028 3244 2070  es a VPoly (2D p
+00007fa0: 6f6c 7967 6f6e 206f 6620 6120 6372 6f73  olygon of a cros
+00007fb0: 7320 7365 6374 696f 6e20 696e 2028 522c  s section in (R,
+00007fc0: 5a29 2063 6f6f 7264 696e 6174 6573 292e  Z) coordinates).
+00007fd0: 0a20 2020 2054 6865 2072 6566 696e 656d  .    The refinem
+00007fe0: 656e 7420 6f6e 2052 2061 6e64 205a 2069  ent on R and Z i
+00007ff0: 7320 6465 6669 6e65 6420 644c 2e0a 2020  s defined dL..  
+00008000: 2020 4f70 7469 6f6e 6e61 6c6c 7920 796f    Optionnally yo
+00008010: 7520 6361 6e20 6769 7665 2061 2063 6f65  u can give a coe
+00008020: 6666 6963 6965 6e74 2028 4449 6e29 2061  fficient (DIn) a
+00008030: 6e64 2074 6865 206e 6f72 6d61 6c20 7665  nd the normal ve
+00008040: 6374 6f72 7320 676f 696e 670a 2020 2020  ctors going.    
+00008050: 696e 7761 7264 7320 7468 6520 5650 6f6c  inwards the VPol
+00008060: 7920 2856 496e 292c 2061 6e64 2074 6865  y (VIn), and the
+00008070: 2072 6573 756c 7420 7769 6c6c 2062 6520   result will be 
+00008080: 736c 6967 6874 6c79 2073 6869 6674 6564  slightly shifted
+00008090: 2069 6e77 6172 6473 0a20 2020 2028 6f72   inwards.    (or
+000080a0: 206f 7574 7761 7264 7320 6966 2044 496e   outwards if DIn
+000080b0: 3c30 2920 6f66 2044 496e 2a56 496e 2e0a  <0) of DIn*VIn..
+000080c0: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
+000080d0: 2020 203d 3d3d 3d3d 3d3d 3d3d 3d0a 2020     ==========.  
+000080e0: 2020 5650 6f6c 7920 3a20 2832 2c20 6e75    VPoly : (2, nu
+000080f0: 6d5f 7665 7274 6578 2920 646f 7562 6c65  m_vertex) double
+00008100: 2061 7272 6179 0a20 2020 2020 2020 436f   array.       Co
+00008110: 6f72 6469 6e61 7465 7320 6f66 2074 6865  ordinates of the
+00008120: 2076 6572 7469 6365 7320 6f66 2074 6865   vertices of the
+00008130: 2050 6f6c 7967 6f6e 2064 6566 696e 696e   Polygon definin
+00008140: 6720 7468 6520 3244 2070 6f6c 6f69 6461  g the 2D poloida
+00008150: 6c0a 2020 2020 2020 2063 7574 206f 6620  l.       cut of 
+00008160: 7468 6520 5665 7373 656c 0a20 2020 2064  the Vessel.    d
+00008170: 4c20 3a20 646f 7562 6c65 0a20 2020 2020  L : double.     
+00008180: 2020 2053 7465 7020 6f66 2064 6973 6372     Step of discr
+00008190: 6574 697a 6174 696f 6e2c 2063 616e 2062  etization, can b
+000081a0: 6520 6162 736f 6c75 7465 2028 6465 6661  e absolute (defa
+000081b0: 756c 7429 206f 7220 7265 6c61 7469 7665  ult) or relative
+000081c0: 0a20 2020 2044 3120 6f72 2044 3220 3a20  .    D1 or D2 : 
+000081d0: 286f 7074 696f 6e61 6c29 2028 3229 2d64  (optional) (2)-d
+000081e0: 6f75 626c 6520 6172 7261 790a 2020 2020  ouble array.    
+000081f0: 2020 2020 5375 6220 646f 6d61 696e 206f      Sub domain o
+00008200: 6620 6469 7363 7265 7469 7a61 7469 6f6e  f discretization
+00008210: 2e0a 2020 2020 2020 2020 2863 616e 2062  ..        (can b
+00008220: 6520 6f6e 6c79 206f 6e20 6f6e 6520 6c69  e only on one li
+00008230: 6d69 7420 616e 6420 6361 6e20 6265 2062  mit and can be b
+00008240: 6967 6765 7220 6f72 2073 6d61 6c6c 6572  igger or smaller
+00008250: 2074 6861 6e20 6f72 6967 696e 616c 292e   than original).
+00008260: 0a20 2020 2020 2020 2041 6374 7561 6c20  .        Actual 
+00008270: 6465 7369 7265 6420 6c69 6d69 7473 0a20  desired limits. 
+00008280: 2020 206d 6f64 6520 3a20 286f 7074 696f     mode : (optio
+00008290: 6e61 6c29 2073 7472 696e 670a 2020 2020  nal) string.    
+000082a0: 2020 2020 4966 2060 6d6f 6465 6020 6973      If `mode` is
+000082b0: 2022 6162 7322 2028 6162 736f 6c75 7465   "abs" (absolute
+000082c0: 292c 2074 6865 6e20 7468 650a 2020 2020  ), then the.    
+000082d0: 2020 2020 7365 676d 656e 7420 7769 6c6c      segment will
+000082e0: 2062 6520 6469 7363 7265 7469 7a65 6420   be discretized 
+000082f0: 696e 2063 656c 6c73 2065 6163 6820 6f66  in cells each of
+00008300: 2073 697a 6520 6064 7374 6570 602e 2045   size `dstep`. E
+00008310: 6c73 652c 0a20 2020 2020 2020 2069 6620  lse,.        if 
+00008320: 2272 656c 2220 2872 656c 6174 6976 6529  "rel" (relative)
+00008330: 2c20 7468 6520 6d65 7368 696e 6720 7374  , the meshing st
+00008340: 6570 2069 7320 7265 6c61 7469 7665 2074  ep is relative t
+00008350: 6f20 7468 6520 7365 676d 656e 7473 206e  o the segments n
+00008360: 6f72 6d0a 2020 2020 6d61 7267 696e 203a  orm.    margin :
+00008370: 2028 6f70 7469 6f6e 616c 2920 646f 7562   (optional) doub
+00008380: 6c65 0a20 2020 2020 2020 204d 6172 6769  le.        Margi
+00008390: 6e20 7661 6c75 6520 666f 7220 6365 6c6c  n value for cell
+000083a0: 206c 656e 6774 680a 2020 2020 5265 7475   length.    Retu
+000083b0: 726e 730a 2020 2020 3d3d 3d3d 3d3d 3d0a  rns.    =======.
+000083c0: 2020 2020 7265 7475 726e 2050 7473 4372      return PtsCr
+000083d0: 6f73 732c 2072 6573 6f6c 2c20 696e 645f  oss, resol, ind_
+000083e0: 6172 722c 204e 5f61 7272 2c20 5272 6566  arr, N_arr, Rref
+000083f0: 5f61 7272 2c20 5650 6f6c 7962 6973 0a20  _arr, VPolybis. 
+00008400: 2020 2050 7473 4372 6f73 733a 2064 6f75     PtsCross: dou
+00008410: 626c 6520 3264 2061 7272 6179 0a20 2020  ble 2d array.   
+00008420: 2020 2020 2061 7272 6179 206f 6620 7468       array of th
+00008430: 6520 6469 7363 7265 7469 7a65 6420 636f  e discretized co
+00008440: 6f72 6469 6e61 7465 7320 6f66 2074 6865  ordinates of the
+00008450: 2056 506f 6c79 0a20 2020 2072 6573 6f6c   VPoly.    resol
+00008460: 3a20 646f 7562 6c65 2031 6420 6172 7261  : double 1d arra
+00008470: 790a 2020 2020 2020 2020 7374 6570 206f  y.        step o
+00008480: 6620 6469 7363 7265 7469 7a61 7469 6f6e  f discretization
+00008490: 206f 6e20 3264 0a20 2020 2069 6e64 5f61   on 2d.    ind_a
+000084a0: 7272 3a20 696e 7420 2031 6420 6172 7261  rr: int  1d arra
+000084b0: 790a 2020 2020 2020 2020 6172 7261 7920  y.        array 
+000084c0: 6f66 2074 6865 2069 6e64 6963 6573 2063  of the indices c
+000084d0: 6f72 7265 7370 6f6e 6469 6e67 2074 6f20  orresponding to 
+000084e0: 6c64 6973 6372 6574 2077 6974 6820 7265  ldiscret with re
+000084f0: 7370 6563 7473 2074 6f20 7468 650a 2020  spects to the.  
+00008500: 2020 2020 2020 6f72 6967 696e 616c 2056        original V
+00008510: 506f 6c79 0a20 2020 204e 5f61 7272 203a  Poly.    N_arr :
+00008520: 2069 6e74 2031 6420 6172 7261 790a 2020   int 1d array.  
+00008530: 2020 2020 2020 6e75 6d62 6572 206f 6620        number of 
+00008540: 6365 6c6c 7320 6f6e 2065 6163 6820 7365  cells on each se
+00008550: 676d 656e 7420 6f66 2074 6865 2056 506f  gment of the VPo
+00008560: 6c79 0a20 2020 2052 7265 665f 6172 7220  ly.    Rref_arr 
+00008570: 3a20 646f 7562 6c65 2031 6420 6172 7261  : double 1d arra
+00008580: 790a 2020 2020 2020 2020 7265 6665 7265  y.        refere
+00008590: 6e63 6520 5261 6469 7573 2063 6f6f 7264  nce Radius coord
+000085a0: 696e 6174 6573 2c20 6e6f 7420 7368 6966  inates, not shif
+000085b0: 7465 6420 6576 656e 2069 6620 4449 6e20  ted even if DIn 
+000085c0: 3c3e 2030 2e0a 2020 2020 2020 2020 4966  <> 0..        If
+000085d0: 2044 496e 203d 3d20 302c 2074 6865 6e20   DIn == 0, then 
+000085e0: 5272 6566 5f61 7272 203d 2050 7473 4372  Rref_arr = PtsCr
+000085f0: 6f73 735b 302c 202e 2e2e 5d0a 2020 2020  oss[0, ...].    
+00008600: 5650 6f6c 7962 6973 203a 0a0a 2020 2020  VPolybis :..    
+00008610: 2222 220a 2020 2020 6364 6566 2069 6e74  """.    cdef int
+00008620: 206e 7074 735f 6469 7363 3d56 506f 6c79   npts_disc=VPoly
+00008630: 2e73 6861 7065 5b31 5d0a 2020 2020 6364  .shape[1].    cd
+00008640: 6566 2069 6e74 5b31 5d20 737a 5f76 622c  ef int[1] sz_vb,
+00008650: 2073 7a5f 6f74 0a20 2020 2063 6465 6620   sz_ot.    cdef 
+00008660: 646f 7562 6c65 2a20 5843 726f 7373 203d  double* XCross =
+00008670: 204e 554c 4c0a 2020 2020 6364 6566 2064   NULL.    cdef d
+00008680: 6f75 626c 652a 2059 4372 6f73 7320 3d20  ouble* YCross = 
+00008690: 4e55 4c4c 0a20 2020 2063 6465 6620 646f  NULL.    cdef do
+000086a0: 7562 6c65 2a20 5850 6f6c 7962 6973 203d  uble* XPolybis =
+000086b0: 204e 554c 4c0a 2020 2020 6364 6566 2064   NULL.    cdef d
+000086c0: 6f75 626c 652a 2059 506f 6c79 6269 7320  ouble* YPolybis 
+000086d0: 3d20 4e55 4c4c 0a20 2020 2063 6465 6620  = NULL.    cdef 
+000086e0: 646f 7562 6c65 2a20 5272 6566 203d 204e  double* Rref = N
+000086f0: 554c 4c0a 2020 2020 6364 6566 2064 6f75  ULL.    cdef dou
+00008700: 626c 652a 2072 6573 6f6c 7574 696f 6e20  ble* resolution 
+00008710: 3d20 4e55 4c4c 0a20 2020 2063 6465 6620  = NULL.    cdef 
+00008720: 6c6f 6e67 2a20 696e 6420 3d20 4e55 4c4c  long* ind = NULL
+00008730: 0a20 2020 2063 6465 6620 6c6f 6e67 2a20  .    cdef long* 
+00008740: 6e75 6d63 656c 6c73 203d 204e 554c 4c0a  numcells = NULL.
+00008750: 2020 2020 6364 6566 206e 702e 6e64 6172      cdef np.ndar
+00008760: 7261 795b 646f 7562 6c65 2c6e 6469 6d3d  ray[double,ndim=
+00008770: 325d 2050 7473 4372 6f73 732c 2056 506f  2] PtsCross, VPo
+00008780: 6c79 6269 730a 2020 2020 6364 6566 206e  lybis.    cdef n
+00008790: 702e 6e64 6172 7261 795b 646f 7562 6c65  p.ndarray[double
+000087a0: 2c6e 6469 6d3d 315d 2050 7473 4372 6f73  ,ndim=1] PtsCros
+000087b0: 7358 2c20 5074 7343 726f 7373 590a 2020  sX, PtsCrossY.  
+000087c0: 2020 6364 6566 206e 702e 6e64 6172 7261    cdef np.ndarra
+000087d0: 795b 646f 7562 6c65 2c6e 6469 6d3d 315d  y[double,ndim=1]
+000087e0: 2056 506f 6c79 6269 7358 2c20 5650 6f6c   VPolybisX, VPol
+000087f0: 7962 6973 590a 2020 2020 6364 6566 206e  ybisY.    cdef n
+00008800: 702e 6e64 6172 7261 795b 646f 7562 6c65  p.ndarray[double
+00008810: 2c6e 6469 6d3d 315d 2052 7265 665f 6172  ,ndim=1] Rref_ar
+00008820: 722c 2072 6573 6f6c 0a20 2020 2063 6465  r, resol.    cde
+00008830: 6620 6e70 2e6e 6461 7272 6179 5b6c 6f6e  f np.ndarray[lon
+00008840: 672c 6e64 696d 3d31 5d20 696e 645f 6172  g,ndim=1] ind_ar
+00008850: 722c 204e 5f61 7272 0a20 2020 2063 6465  r, N_arr.    cde
+00008860: 6620 6e70 2e6e 6461 7272 6179 5b6e 702e  f np.ndarray[np.
+00008870: 6e70 795f 626f 6f6c 2c6e 6469 6d3d 312c  npy_bool,ndim=1,
+00008880: 6361 7374 3d54 7275 655d 2069 6e64 696e  cast=True] indin
+00008890: 0a20 2020 2063 6465 6620 7374 7220 6d6f  .    cdef str mo
+000088a0: 6465 5f6c 6f77 203d 206d 6f64 652e 6c6f  de_low = mode.lo
+000088b0: 7765 7228 290a 2020 2020 6364 6566 2069  wer().    cdef i
+000088c0: 6e74 206d 6f64 655f 6e75 6d20 3d20 5f73  nt mode_num = _s
+000088d0: 742e 6765 745f 6e62 5f64 6d6f 6465 286d  t.get_nb_dmode(m
+000088e0: 6f64 655f 6c6f 7729 0a20 2020 2023 202e  ode_low).    # .
+000088f0: 2e20 5465 7374 696e 6720 2e2e 2e2e 2e2e  . Testing ......
+00008900: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00008910: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00008920: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00008930: 2e2e 2e2e 2e2e 2e2e 2e0a 2020 2020 6173  ..........    as
+00008940: 7365 7274 206d 6f64 655f 6e75 6d20 3e3d  sert mode_num >=
+00008950: 2030 2c20 224d 6f64 6520 6861 7320 746f   0, "Mode has to
+00008960: 2062 6520 2761 6273 2720 2861 6273 6f6c   be 'abs' (absol
+00008970: 7574 6529 206f 7220 2772 656c 2720 2872  ute) or 'rel' (r
+00008980: 656c 6174 6976 6529 220a 2020 2020 6173  elative)".    as
+00008990: 7365 7274 2028 6e6f 7420 2844 496e 203d  sert (not (DIn =
+000089a0: 3d20 302e 2920 6f72 2056 496e 2069 7320  = 0.) or VIn is 
+000089b0: 6e6f 7420 4e6f 6e65 290a 2020 2020 2320  not None).    # 
+000089c0: 2e2e 2070 7265 7061 7269 6e67 2069 6e70  .. preparing inp
+000089d0: 7574 732e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  uts.............
+000089e0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+000089f0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00008a00: 2e2e 2e2e 2e2e 2e2e 2e2e 0a20 2020 205f  ...........    _
+00008a10: 7374 2e64 6973 6372 6574 697a 655f 7670  st.discretize_vp
+00008a20: 6f6c 795f 636f 7265 2856 506f 6c79 2c20  oly_core(VPoly, 
+00008a30: 644c 2c20 6d6f 6465 5f6e 756d 2c20 6d61  dL, mode_num, ma
+00008a40: 7267 696e 2c20 4449 6e2c 2056 496e 2c0a  rgin, DIn, VIn,.
+00008a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008a60: 2020 2020 2020 2020 2020 2020 2658 4372              &XCr
+00008a70: 6f73 732c 2026 5943 726f 7373 2c20 2672  oss, &YCross, &r
+00008a80: 6573 6f6c 7574 696f 6e2c 0a20 2020 2020  esolution,.     
+00008a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008aa0: 2020 2020 2020 2026 696e 642c 2026 6e75         &ind, &nu
+00008ab0: 6d63 656c 6c73 2c20 2652 7265 662c 2026  mcells, &Rref, &
+00008ac0: 5850 6f6c 7962 6973 2c20 2659 506f 6c79  XPolybis, &YPoly
+00008ad0: 6269 732c 0a20 2020 2020 2020 2020 2020  bis,.           
+00008ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008af0: 2026 737a 5f76 625b 305d 2c20 2673 7a5f   &sz_vb[0], &sz_
+00008b00: 6f74 5b30 5d2c 206e 7074 735f 6469 7363  ot[0], npts_disc
+00008b10: 290a 2020 2020 6173 7365 7274 206e 6f74  ).    assert not
+00008b20: 2028 2858 4372 6f73 7320 3d3d 204e 554c   ((XCross == NUL
+00008b30: 4c29 206f 7220 2859 4372 6f73 7320 3d3d  L) or (YCross ==
+00008b40: 204e 554c 4c29 0a20 2020 2020 2020 2020   NULL).         
+00008b50: 2020 2020 2020 206f 7220 2858 506f 6c79         or (XPoly
+00008b60: 6269 7320 3d3d 204e 554c 4c29 206f 7220  bis == NULL) or 
+00008b70: 2859 506f 6c79 6269 7320 3d3d 204e 554c  (YPolybis == NUL
+00008b80: 4c29 290a 2020 2020 5074 7343 726f 7373  L)).    PtsCross
+00008b90: 5820 3d20 6e70 2e61 7272 6179 283c 646f  X = np.array(<do
+00008ba0: 7562 6c65 5b3a 737a 5f6f 745b 305d 5d3e  uble[:sz_ot[0]]>
+00008bb0: 2058 4372 6f73 7329 0a20 2020 2050 7473   XCross).    Pts
+00008bc0: 4372 6f73 7359 203d 206e 702e 6172 7261  CrossY = np.arra
+00008bd0: 7928 3c64 6f75 626c 655b 3a73 7a5f 6f74  y(<double[:sz_ot
+00008be0: 5b30 5d5d 3e20 5943 726f 7373 290a 2020  [0]]> YCross).  
+00008bf0: 2020 5074 7343 726f 7373 203d 206e 702e    PtsCross = np.
+00008c00: 6172 7261 7928 5b50 7473 4372 6f73 7358  array([PtsCrossX
+00008c10: 2c50 7473 4372 6f73 7359 5d29 0a20 2020  ,PtsCrossY]).   
+00008c20: 2056 506f 6c79 6269 7358 203d 206e 702e   VPolybisX = np.
+00008c30: 6172 7261 7928 3c64 6f75 626c 655b 3a73  array(<double[:s
+00008c40: 7a5f 7662 5b30 5d5d 3e20 5850 6f6c 7962  z_vb[0]]> XPolyb
+00008c50: 6973 290a 2020 2020 5650 6f6c 7962 6973  is).    VPolybis
+00008c60: 5920 3d20 6e70 2e61 7272 6179 283c 646f  Y = np.array(<do
+00008c70: 7562 6c65 5b3a 737a 5f76 625b 305d 5d3e  uble[:sz_vb[0]]>
+00008c80: 2059 506f 6c79 6269 7329 0a20 2020 2056   YPolybis).    V
+00008c90: 506f 6c79 6269 7320 3d20 6e70 2e61 7272  Polybis = np.arr
+00008ca0: 6179 285b 5650 6f6c 7962 6973 582c 2056  ay([VPolybisX, V
+00008cb0: 506f 6c79 6269 7359 5d29 0a20 2020 2072  PolybisY]).    r
+00008cc0: 6573 6f6c 203d 206e 702e 6172 7261 7928  esol = np.array(
+00008cd0: 3c64 6f75 626c 655b 3a73 7a5f 6f74 5b30  <double[:sz_ot[0
+00008ce0: 5d5d 3e20 7265 736f 6c75 7469 6f6e 290a  ]]> resolution).
+00008cf0: 2020 2020 5272 6566 5f61 7272 203d 206e      Rref_arr = n
+00008d00: 702e 6172 7261 7928 3c64 6f75 626c 655b  p.array(<double[
+00008d10: 3a73 7a5f 6f74 5b30 5d5d 3e20 5272 6566  :sz_ot[0]]> Rref
+00008d20: 290a 2020 2020 696e 645f 6172 7220 3d20  ).    ind_arr = 
+00008d30: 6e70 2e61 7272 6179 283c 6c6f 6e67 5b3a  np.array(<long[:
+00008d40: 737a 5f6f 745b 305d 5d3e 2069 6e64 290a  sz_ot[0]]> ind).
+00008d50: 2020 2020 4e5f 6172 7220 3d20 6e70 2e61      N_arr = np.a
+00008d60: 7272 6179 283c 6c6f 6e67 5b3a 6e70 7473  rray(<long[:npts
+00008d70: 5f64 6973 632d 315d 3e20 6e75 6d63 656c  _disc-1]> numcel
+00008d80: 6c73 290a 2020 2020 6966 2044 3120 6973  ls).    if D1 is
+00008d90: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00008da0: 2020 2069 6e64 696e 203d 2028 5074 7343     indin = (PtsC
+00008db0: 726f 7373 5b30 2c3a 5d3e 3d44 315b 305d  ross[0,:]>=D1[0]
+00008dc0: 2920 2620 2850 7473 4372 6f73 735b 302c  ) & (PtsCross[0,
+00008dd0: 3a5d 3c3d 4431 5b31 5d29 0a20 2020 2020  :]<=D1[1]).     
+00008de0: 2020 2050 7473 4372 6f73 7320 3d20 5074     PtsCross = Pt
+00008df0: 7343 726f 7373 5b3a 2c69 6e64 696e 5d0a  sCross[:,indin].
+00008e00: 2020 2020 2020 2020 7265 736f 6c20 3d20          resol = 
+00008e10: 7265 736f 6c5b 696e 6469 6e5d 0a20 2020  resol[indin].   
+00008e20: 2020 2020 2069 6e64 5f61 7272 203d 2069       ind_arr = i
+00008e30: 6e64 5f61 7272 5b69 6e64 696e 5d0a 2020  nd_arr[indin].  
+00008e40: 2020 6966 2044 3220 6973 206e 6f74 204e    if D2 is not N
+00008e50: 6f6e 653a 0a20 2020 2020 2020 2069 6e64  one:.        ind
+00008e60: 696e 203d 2028 5074 7343 726f 7373 5b31  in = (PtsCross[1
+00008e70: 2c3a 5d3e 3d44 325b 305d 2920 2620 2850  ,:]>=D2[0]) & (P
+00008e80: 7473 4372 6f73 735b 312c 3a5d 3c3d 4432  tsCross[1,:]<=D2
+00008e90: 5b31 5d29 0a20 2020 2020 2020 2050 7473  [1]).        Pts
+00008ea0: 4372 6f73 7320 3d20 5074 7343 726f 7373  Cross = PtsCross
+00008eb0: 5b3a 2c69 6e64 696e 5d0a 2020 2020 2020  [:,indin].      
+00008ec0: 2020 7265 736f 6c20 3d20 7265 736f 6c5b    resol = resol[
+00008ed0: 696e 6469 6e5d 0a20 2020 2020 2020 2069  indin].        i
+00008ee0: 6e64 5f61 7272 203d 2069 6e64 5f61 7272  nd_arr = ind_arr
+00008ef0: 5b69 6e64 696e 5d0a 2020 2020 6672 6565  [indin].    free
+00008f00: 2858 4372 6f73 7329 0a20 2020 2066 7265  (XCross).    fre
+00008f10: 6528 5943 726f 7373 290a 2020 2020 6672  e(YCross).    fr
+00008f20: 6565 2858 506f 6c79 6269 7329 0a20 2020  ee(XPolybis).   
+00008f30: 2066 7265 6528 5950 6f6c 7962 6973 290a   free(YPolybis).
+00008f40: 2020 2020 6672 6565 2872 6573 6f6c 7574      free(resolut
+00008f50: 696f 6e29 0a20 2020 2066 7265 6528 5272  ion).    free(Rr
+00008f60: 6566 290a 2020 2020 6672 6565 2869 6e64  ef).    free(ind
+00008f70: 290a 2020 2020 6672 6565 286e 756d 6365  ).    free(numce
+00008f80: 6c6c 7329 0a20 2020 2072 6574 7572 6e20  lls).    return 
+00008f90: 5074 7343 726f 7373 2c20 7265 736f 6c2c  PtsCross, resol,
+00008fa0: 2069 6e64 5f61 7272 2c20 4e5f 6172 722c   ind_arr, N_arr,
+00008fb0: 2052 7265 665f 6172 722c 2056 506f 6c79   Rref_arr, VPoly
+00008fc0: 6269 730a 0a0a 2320 3d3d 3d3d 3d3d 3d3d  bis...# ========
 00008fd0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00008fe0: 3d3d 3d3d 3d3d 3d0a 230a 2320 2020 2020  =======.#.#     
-00008ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009000: 3344 204d 4553 4849 4e47 2069 6e20 544f  3D MESHING in TO
-00009010: 524f 4944 414c 2063 6f6e 6669 6775 7261  ROIDAL configura
-00009020: 7469 6f6e 730a 2320 2020 2020 2020 2020  tions.#         
-00009030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009040: 2020 692e 652e 2044 6973 6372 6574 697a    i.e. Discretiz
-00009050: 696e 6720 566f 6c75 6d65 730a 230a 2320  ing Volumes.#.# 
-00009060: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00009070: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00009080: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00008fe0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00008ff0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00009000: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00009010: 3d3d 3d3d 3d3d 0a23 0a23 2020 2020 2020  ======.#.#      
+00009020: 2020 2020 2020 2020 2020 2020 2020 2033                 3
+00009030: 4420 4d45 5348 494e 4720 696e 2054 4f52  D MESHING in TOR
+00009040: 4f49 4441 4c20 636f 6e66 6967 7572 6174  OIDAL configurat
+00009050: 696f 6e73 0a23 2020 2020 2020 2020 2020  ions.#          
+00009060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009070: 2069 2e65 2e20 4469 7363 7265 7469 7a69   i.e. Discretizi
+00009080: 6e67 2056 6f6c 756d 6573 0a23 0a23 203d  ng Volumes.#.# =
 00009090: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000090a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 0a64  ==============.d
-000090b0: 6566 205f 5665 735f 566d 6573 685f 546f  ef _Ves_Vmesh_To
-000090c0: 725f 5375 6246 726f 6d44 5f63 7974 686f  r_SubFromD_cytho
-000090d0: 6e28 646f 7562 6c65 2072 7374 6570 2c20  n(double rstep, 
-000090e0: 646f 7562 6c65 207a 7374 6570 2c20 646f  double zstep, do
-000090f0: 7562 6c65 2070 6869 7374 6570 2c0a 2020  uble phistep,.  
-00009100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009120: 2064 6f75 626c 655b 3a3a 315d 2052 4d69   double[::1] RMi
-00009130: 6e4d 6178 2c20 646f 7562 6c65 5b3a 3a31  nMax, double[::1
-00009140: 5d20 5a4d 696e 4d61 782c 0a20 2020 2020  ] ZMinMax,.     
-00009150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009160: 2020 2020 2020 2020 2020 2020 2020 6c69                li
-00009170: 7374 2044 523d 4e6f 6e65 2c20 6c69 7374  st DR=None, list
-00009180: 2044 5a3d 4e6f 6e65 2c20 4450 6869 3d4e   DZ=None, DPhi=N
-00009190: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
-000091a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000091b0: 2020 2020 2020 2020 646f 7562 6c65 5b3a          double[:
-000091c0: 2c3a 3a31 5d20 6c69 6d69 745f 7670 6f6c  ,::1] limit_vpol
-000091d0: 793d 4e6f 6e65 2c0a 2020 2020 2020 2020  y=None,.        
-000091e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000091f0: 2020 2020 2020 2020 2020 2073 7472 206f             str o
-00009200: 7574 5f66 6f72 6d61 743d 2728 582c 592c  ut_format='(X,Y,
-00009210: 5a29 272c 0a20 2020 2020 2020 2020 2020  Z)',.           
-00009220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009230: 2020 2020 2020 2020 646f 7562 6c65 206d          double m
-00009240: 6172 6769 6e3d 5f56 534d 414c 4c2c 0a20  argin=_VSMALL,. 
+000090a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000090b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000090c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000090d0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 6465  =============.de
+000090e0: 6620 5f56 6573 5f56 6d65 7368 5f54 6f72  f _Ves_Vmesh_Tor
+000090f0: 5f53 7562 4672 6f6d 445f 6379 7468 6f6e  _SubFromD_cython
+00009100: 2864 6f75 626c 6520 7273 7465 702c 2064  (double rstep, d
+00009110: 6f75 626c 6520 7a73 7465 702c 2064 6f75  ouble zstep, dou
+00009120: 626c 6520 7068 6973 7465 702c 0a20 2020  ble phistep,.   
+00009130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009150: 646f 7562 6c65 5b3a 3a31 5d20 524d 696e  double[::1] RMin
+00009160: 4d61 782c 2064 6f75 626c 655b 3a3a 315d  Max, double[::1]
+00009170: 205a 4d69 6e4d 6178 2c0a 2020 2020 2020   ZMinMax,.      
+00009180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009190: 2020 2020 2020 2020 2020 2020 206c 6973               lis
+000091a0: 7420 4452 3d4e 6f6e 652c 206c 6973 7420  t DR=None, list 
+000091b0: 445a 3d4e 6f6e 652c 2044 5068 693d 4e6f  DZ=None, DPhi=No
+000091c0: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+000091d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000091e0: 2020 2020 2020 2064 6f75 626c 655b 3a2c         double[:,
+000091f0: 3a3a 315d 206c 696d 6974 5f76 706f 6c79  ::1] limit_vpoly
+00009200: 3d4e 6f6e 652c 0a20 2020 2020 2020 2020  =None,.         
+00009210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009220: 2020 2020 2020 2020 2020 7374 7220 6f75            str ou
+00009230: 745f 666f 726d 6174 3d27 2858 2c59 2c5a  t_format='(X,Y,Z
+00009240: 2927 2c0a 2020 2020 2020 2020 2020 2020  )',.            
 00009250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009270: 2020 696e 7420 6e75 6d5f 7468 7265 6164    int num_thread
-00009280: 733d 3438 293a 0a20 2020 2022 2222 5265  s=48):.    """Re
-00009290: 7475 726e 7320 7468 6520 6465 7369 7265  turns the desire
-000092a0: 6420 7375 626d 6573 6820 696e 6469 6361  d submesh indica
-000092b0: 7465 6420 6279 2074 6865 206c 696d 6974  ted by the limit
-000092c0: 7320 2844 522c 445a 2c44 5068 6929 2c0a  s (DR,DZ,DPhi),.
-000092d0: 2020 2020 666f 7220 7468 6520 6465 7369      for the desi
-000092e0: 7265 6420 7265 736f 6c75 7469 6f6e 2028  red resolution (
-000092f0: 7273 7465 702c 7a73 7465 702c 6452 7068  rstep,zstep,dRph
-00009300: 6929 2e0a 0a20 2020 2050 6172 616d 6574  i)...    Paramet
-00009310: 6572 730a 2020 2020 2d2d 2d2d 2d2d 2d2d  ers.    --------
-00009320: 2d2d 0a20 2020 2020 2020 2072 7374 6570  --.        rstep
-00009330: 2028 646f 7562 6c65 293a 2072 6566 696e   (double): refin
-00009340: 656d 656e 7420 616c 6f6e 6720 7261 6469  ement along radi
-00009350: 7573 2060 7260 0a20 2020 2020 2020 207a  us `r`.        z
-00009360: 7374 6570 2028 646f 7562 6c65 293a 2072  step (double): r
-00009370: 6566 696e 656d 656e 7420 616c 6f6e 6720  efinement along 
-00009380: 6865 6967 6874 2060 7a60 0a20 2020 2020  height `z`.     
-00009390: 2020 2070 6869 7374 6570 2028 646f 7562     phistep (doub
-000093a0: 6c65 293a 2072 6566 696e 656d 656e 7420  le): refinement 
-000093b0: 616c 6f6e 6720 746f 726f 6964 616c 2064  along toroidal d
-000093c0: 6972 6563 7469 6f6e 2060 7068 6960 0a20  irection `phi`. 
-000093d0: 2020 2020 2020 2052 4d69 6e4d 6178 3a20         RMinMax: 
-000093e0: 6172 7261 7920 7370 6563 6966 7969 6e67  array specifying
-000093f0: 2074 6865 206c 696d 6974 7320 6d69 6e20   the limits min 
-00009400: 616e 6420 6d61 7820 696e 2060 7260 0a20  and max in `r`. 
-00009410: 2020 2020 2020 205a 4d69 6e4d 6178 3a20         ZMinMax: 
-00009420: 6172 7261 7920 7370 6563 6966 7969 6e67  array specifying
-00009430: 2074 6865 206c 696d 6974 7320 6d69 6e20   the limits min 
-00009440: 616e 6420 6d61 7820 696e 2060 7a60 0a20  and max in `z`. 
-00009450: 2020 2020 2020 2044 523a 2061 7272 6179         DR: array
-00009460: 2073 7065 6369 6679 696e 6720 7468 6520   specifying the 
-00009470: 6163 7475 616c 2073 7562 2d76 6f6c 756d  actual sub-volum
-00009480: 6520 6c69 6d69 7473 2074 6f20 6765 7420  e limits to get 
-00009490: 696e 2060 7260 0a20 2020 2020 2020 2044  in `r`.        D
-000094a0: 5a3a 2061 7272 6179 2073 7065 6369 6679  Z: array specify
-000094b0: 696e 6720 7468 6520 6163 7475 616c 2073  ing the actual s
-000094c0: 7562 2d76 6f6c 756d 6520 6c69 6d69 7473  ub-volume limits
-000094d0: 2074 6f20 6765 7420 696e 2060 7a60 0a20   to get in `z`. 
-000094e0: 2020 2020 2020 2044 5068 693a 2061 7272         DPhi: arr
-000094f0: 6179 2073 7065 6369 6679 696e 6720 7468  ay specifying th
-00009500: 6520 6163 7475 616c 2073 7562 2d76 6f6c  e actual sub-vol
-00009510: 756d 6520 6c69 6d69 7473 2074 6f20 6765  ume limits to ge
-00009520: 7420 696e 2060 7068 6960 0a20 2020 2020  t in `phi`.     
-00009530: 2020 206c 696d 6974 5f76 706f 6c79 3a20     limit_vpoly: 
-00009540: 6172 7261 792d 6c69 6b65 2064 6566 696e  array-like defin
-00009550: 696e 6720 7468 6520 6028 522c 5a29 6020  ing the `(R,Z)` 
-00009560: 636f 6f72 6469 6e61 7465 7320 6f66 2074  coordinates of t
-00009570: 6865 2070 6f6c 6f69 6461 6c0a 2020 2020  he poloidal.    
-00009580: 2020 2020 2020 2020 6375 7420 6f66 2074          cut of t
-00009590: 6865 206c 696d 6974 696e 6720 666c 7578  he limiting flux
-000095a0: 2073 7572 6661 6365 0a20 2020 2020 2020   surface.       
-000095b0: 206f 7574 5f66 6f72 6d61 7428 7374 7269   out_format(stri
-000095c0: 6e67 293a 2065 6974 6865 7220 2228 582c  ng): either "(X,
-000095d0: 592c 5a29 2220 6f72 2022 2852 2c5a 2c50  Y,Z)" or "(R,Z,P
-000095e0: 6869 2922 2066 6f72 2063 6172 7465 7369  hi)" for cartesi
-000095f0: 616e 206f 720a 2020 2020 2020 2020 2020  an or.          
-00009600: 2020 706f 6c61 7220 636f 6f72 6469 6e61    polar coordina
-00009610: 7465 730a 2020 2020 2020 2020 6d61 7267  tes.        marg
-00009620: 696e 2864 6f75 626c 6529 3a20 746f 6c65  in(double): tole
-00009630: 7261 6e63 6520 6572 726f 722e 0a20 2020  rance error..   
-00009640: 2020 2020 2020 2020 2044 6566 6175 6c74           Default
-00009650: 7320 746f 207c 5f56 534d 414c 4c7c 0a20  s to |_VSMALL|. 
-00009660: 2020 2052 6574 7572 6e73 0a20 2020 202d     Returns.    -
-00009670: 2d2d 2d2d 2d0a 2020 2020 2020 2070 7473  -----.       pts
-00009680: 3a20 2833 2c20 6e70 7473 2920 6172 7261  : (3, npts) arra
-00009690: 7920 696e 206f 7574 5f66 6f72 6d61 7420  y in out_format 
-000096a0: 2863 6172 7465 7369 616e 206f 7220 706f  (cartesian or po
-000096b0: 6c61 7229 206f 660a 2020 2020 2020 2020  lar) of.        
-000096c0: 2020 2020 6469 7363 7265 7469 7a65 6420      discretized 
-000096d0: 766f 6c75 6d65 0a20 2020 2020 2020 7265  volume.       re
-000096e0: 7333 643a 2028 6e70 7473 2920 7265 736f  s3d: (npts) reso
-000096f0: 6c75 7469 6f6e 206f 6e20 6561 6368 2070  lution on each p
-00009700: 6f69 6e74 0a20 2020 2020 2020 696e 643a  oint.       ind:
-00009710: 2020 2028 6e70 7473 2920 696e 6469 6365     (npts) indice
-00009720: 7320 746f 2072 6563 6f6e 7374 7275 6374  s to reconstruct
-00009730: 2074 6865 2070 6f69 6e74 7320 696e 2033   the points in 3
-00009740: 4420 2875 7365 6675 6c20 6f6e 6c79 2069  D (useful only i
-00009750: 660a 2020 2020 2020 2020 2020 2020 2020  f.              
-00009760: 6c69 6d69 745f 7670 6f6c 7920 6973 206e  limit_vpoly is n
-00009770: 6f74 206e 6f6e 6529 0a20 2020 2020 2020  ot none).       
-00009780: 7265 736f 5f72 3a20 2864 6f75 626c 6529  reso_r: (double)
-00009790: 2072 6573 6f6c 7574 696f 6e20 6f6e 2072   resolution on r
-000097a0: 2028 636f 6e73 7461 6e74 290a 2020 2020   (constant).    
-000097b0: 2020 2072 6573 6f5f 7a3a 2028 646f 7562     reso_z: (doub
-000097c0: 6c65 2920 7265 736f 6c75 7469 6f6e 206f  le) resolution o
-000097d0: 6e20 7a20 2863 6f6e 7374 616e 7429 0a20  n z (constant). 
-000097e0: 2020 2020 2020 7265 736f 5f70 6869 203a        reso_phi :
-000097f0: 2028 737a 5f72 2920 6172 7261 792c 2072   (sz_r) array, r
-00009800: 6573 6f6c 7574 696f 6e20 522a 6450 6869  esolution R*dPhi
-00009810: 2c20 7068 6920 7265 736f 6c75 7469 6f6e  , phi resolution
-00009820: 206f 6e20 6561 6368 2052 0a20 2020 2020   on each R.     
-00009830: 2020 737a 5f72 203a 2028 696e 7429 206e    sz_r : (int) n
-00009840: 756d 6265 7220 6f66 2070 6f69 6e74 7320  umber of points 
-00009850: 696e 2072 0a20 2020 2020 2020 737a 5f7a  in r.       sz_z
-00009860: 203a 2028 696e 7429 206e 756d 6265 7220   : (int) number 
-00009870: 6f66 2070 6f69 6e74 7320 696e 207a 0a20  of points in z. 
-00009880: 2020 2022 2222 0a20 2020 2063 6465 6620     """.    cdef 
-00009890: 696e 7420 6a6a 0a20 2020 2063 6465 6620  int jj.    cdef 
-000098a0: 696e 7420 6e70 7473 5f64 6973 6320 3d20  int npts_disc = 
-000098b0: 300a 2020 2020 6364 6566 2069 6e74 2073  0.    cdef int s
-000098c0: 7a5f 722c 2073 7a5f 7a0a 2020 2020 6364  z_r, sz_z.    cd
-000098d0: 6566 2069 6e74 2072 5f72 6174 696f 0a20  ef int r_ratio. 
-000098e0: 2020 2063 6465 6620 696e 7420 696e 645f     cdef int ind_
-000098f0: 6c6f 635f 7230 0a20 2020 2063 6465 6620  loc_r0.    cdef 
-00009900: 696e 7420 6e70 7473 5f76 706f 6c79 0a20  int npts_vpoly. 
-00009910: 2020 2063 6465 6620 696e 745b 315d 206d     cdef int[1] m
-00009920: 6178 5f73 7a5f 7068 690a 2020 2020 6364  ax_sz_phi.    cd
-00009930: 6566 2073 7472 206f 7574 5f6c 6f77 203d  ef str out_low =
-00009940: 206f 7574 5f66 6f72 6d61 742e 6c6f 7765   out_format.lowe
-00009950: 7228 290a 2020 2020 6364 6566 2062 696e  r().    cdef bin
-00009960: 7420 6973 5f63 6172 7420 3d20 6f75 745f  t is_cart = out_
-00009970: 6c6f 7720 3d3d 2027 2878 2c79 2c7a 2927  low == '(x,y,z)'
-00009980: 0a20 2020 2063 6465 6620 646f 7562 6c65  .    cdef double
-00009990: 206d 696e 5f70 6869 2c20 6d61 785f 7068   min_phi, max_ph
-000099a0: 690a 2020 2020 6364 6566 2064 6f75 626c  i.    cdef doubl
-000099b0: 6520 6d69 6e5f 7068 695f 7069 0a20 2020  e min_phi_pi.   
-000099c0: 2063 6465 6620 646f 7562 6c65 206d 6178   cdef double max
-000099d0: 5f70 6869 5f70 690a 2020 2020 6364 6566  _phi_pi.    cdef
-000099e0: 2064 6f75 626c 6520 6162 7330 2c20 6162   double abs0, ab
-000099f0: 7331 0a20 2020 2063 6465 6620 646f 7562  s1.    cdef doub
-00009a00: 6c65 2072 6573 6f5f 725f 7a0a 2020 2020  le reso_r_z.    
-00009a10: 6364 6566 2064 6f75 626c 6520 7477 6f70  cdef double twop
-00009a20: 695f 6f76 6572 5f64 7068 690a 2020 2020  i_over_dphi.    
-00009a30: 6364 6566 206c 6f6e 675b 315d 206e 6365  cdef long[1] nce
-00009a40: 6c6c 735f 7230 2c20 6e63 656c 6c73 5f72  lls_r0, ncells_r
-00009a50: 2c20 6e63 656c 6c73 5f7a 0a20 2020 2063  , ncells_z.    c
-00009a60: 6465 6620 6c6f 6e67 5b3a 3a31 5d20 696e  def long[::1] in
-00009a70: 645f 6d76 0a20 2020 2063 6465 6620 646f  d_mv.    cdef do
-00009a80: 7562 6c65 5b32 5d20 6c69 6d69 7473 5f64  uble[2] limits_d
-00009a90: 6c0a 2020 2020 6364 6566 2064 6f75 626c  l.    cdef doubl
-00009aa0: 655b 315d 2072 6573 6f5f 7230 2c20 7265  e[1] reso_r0, re
-00009ab0: 736f 5f72 2c20 7265 736f 5f7a 0a20 2020  so_r, reso_z.   
-00009ac0: 2063 6465 6620 646f 7562 6c65 5b3a 3a31   cdef double[::1
-00009ad0: 5d20 6476 5f6d 760a 2020 2020 6364 6566  ] dv_mv.    cdef
-00009ae0: 2064 6f75 626c 655b 3a3a 315d 2072 6573   double[::1] res
-00009af0: 6f5f 7068 695f 6d76 0a20 2020 2063 6465  o_phi_mv.    cde
-00009b00: 6620 646f 7562 6c65 5b3a 2c20 3a3a 315d  f double[:, ::1]
-00009b10: 2070 6f6c 795f 6d76 0a20 2020 2063 6465   poly_mv.    cde
-00009b20: 6620 646f 7562 6c65 5b3a 2c20 3a3a 315d  f double[:, ::1]
-00009b30: 2070 7473 5f6d 760a 2020 2020 6364 6566   pts_mv.    cdef
-00009b40: 206c 6f6e 675b 3a2c 203a 3a31 5d20 696e   long[:, ::1] in
-00009b50: 6469 5f6d 760a 2020 2020 6364 6566 206c  di_mv.    cdef l
-00009b60: 6f6e 675b 3a2c 203a 2c20 3a3a 315d 206c  ong[:, :, ::1] l
-00009b70: 6e70 0a20 2020 2063 6465 6620 6c6f 6e67  np.    cdef long
-00009b80: 2a20 206e 6365 6c6c 735f 7270 6869 2020  *  ncells_rphi  
-00009b90: 3d20 4e55 4c4c 0a20 2020 2063 6465 6620  = NULL.    cdef 
-00009ba0: 6c6f 6e67 2a20 2074 6f74 5f6e 635f 706c  long*  tot_nc_pl
-00009bb0: 616e 6520 3d20 4e55 4c4c 0a20 2020 2063  ane = NULL.    c
-00009bc0: 6465 6620 6c6f 6e67 2a20 206c 696e 6465  def long*  linde
-00009bd0: 7820 2020 3d20 4e55 4c4c 0a20 2020 2063  x   = NULL.    c
-00009be0: 6465 6620 6c6f 6e67 2a20 206c 696e 6465  def long*  linde
-00009bf0: 785f 7a20 3d20 4e55 4c4c 0a20 2020 2063  x_z = NULL.    c
-00009c00: 6465 6620 6c6f 6e67 2a20 2073 7a5f 7068  def long*  sz_ph
-00009c10: 6920 3d20 4e55 4c4c 0a20 2020 2063 6465  i = NULL.    cde
-00009c20: 6620 646f 7562 6c65 2a20 6469 7363 5f72  f double* disc_r
-00009c30: 3020 3d20 4e55 4c4c 0a20 2020 2063 6465  0 = NULL.    cde
-00009c40: 6620 646f 7562 6c65 2a20 6469 7363 5f72  f double* disc_r
-00009c50: 2020 3d20 4e55 4c4c 0a20 2020 2063 6465    = NULL.    cde
-00009c60: 6620 646f 7562 6c65 2a20 6469 7363 5f7a  f double* disc_z
-00009c70: 2020 3d20 4e55 4c4c 0a20 2020 2063 6465    = NULL.    cde
-00009c80: 6620 646f 7562 6c65 2a20 7374 6570 5f72  f double* step_r
-00009c90: 7068 6920 3d20 4e55 4c4c 0a20 2020 2063  phi = NULL.    c
-00009ca0: 6465 6620 6c6f 6e67 5b3a 3a31 5d20 6669  def long[::1] fi
-00009cb0: 7273 745f 696e 645f 6d76 0a20 2020 2063  rst_ind_mv.    c
-00009cc0: 6465 6620 6e70 2e6e 6461 7272 6179 5b6c  def np.ndarray[l
-00009cd0: 6f6e 672c 206e 6469 6d3d 325d 2069 6e64  ong, ndim=2] ind
-00009ce0: 490a 2020 2020 6364 6566 206e 702e 6e64  I.    cdef np.nd
-00009cf0: 6172 7261 795b 6c6f 6e67 2c20 6e64 696d  array[long, ndim
-00009d00: 3d31 5d20 696e 640a 2020 2020 6364 6566  =1] ind.    cdef
-00009d10: 206e 702e 6e64 6172 7261 795b 646f 7562   np.ndarray[doub
-00009d20: 6c65 2c6e 6469 6d3d 315d 2072 6573 6f5f  le,ndim=1] reso_
-00009d30: 7068 690a 2020 2020 6364 6566 206e 702e  phi.    cdef np.
-00009d40: 6e64 6172 7261 795b 646f 7562 6c65 2c6e  ndarray[double,n
-00009d50: 6469 6d3d 325d 2070 7473 0a20 2020 2063  dim=2] pts.    c
-00009d60: 6465 6620 6e70 2e6e 6461 7272 6179 5b64  def np.ndarray[d
-00009d70: 6f75 626c 652c 6e64 696d 3d31 5d20 7265  ouble,ndim=1] re
-00009d80: 7333 640a 2020 2020 230a 2020 2020 2320  s3d.    #.    # 
-00009d90: 4765 7420 7468 6520 6163 7475 616c 2052  Get the actual R
-00009da0: 2061 6e64 205a 2072 6573 6f6c 7574 696f   and Z resolutio
-00009db0: 6e73 2061 6e64 206d 6573 6820 656c 656d  ns and mesh elem
-00009dc0: 656e 7473 0a20 2020 2023 202e 2e20 4669  ents.    # .. Fi
-00009dd0: 7273 7420 7765 2064 6973 6372 6574 697a  rst we discretiz
-00009de0: 6520 5220 7769 7468 6f75 7420 6c69 6d69  e R without limi
-00009df0: 7473 202e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ts .............
-00009e00: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00009e10: 2e2e 2e2e 2e0a 2020 2020 5f73 742e 6379  ......    _st.cy
-00009e20: 7468 6f6e 697a 655f 7375 6264 6f6d 6169  thonize_subdomai
-00009e30: 6e5f 646c 284e 6f6e 652c 206c 696d 6974  n_dl(None, limit
-00009e40: 735f 646c 2920 2320 6e6f 206c 696d 6974  s_dl) # no limit
-00009e50: 730a 2020 2020 5f20 3d20 5f73 742e 6469  s.    _ = _st.di
-00009e60: 7363 7265 7469 7a65 5f6c 696e 6531 645f  scretize_line1d_
-00009e70: 636f 7265 2826 524d 696e 4d61 785b 305d  core(&RMinMax[0]
-00009e80: 2c20 7273 7465 702c 206c 696d 6974 735f  , rstep, limits_
-00009e90: 646c 2c0a 2020 2020 2020 2020 2020 2020  dl,.            
-00009ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009eb0: 2020 2020 2020 2054 7275 652c 2030 2c20         True, 0, 
-00009ec0: 2320 6469 7363 7265 7469 7a65 2069 6e20  # discretize in 
-00009ed0: 6162 736f 6c75 7465 206d 6f64 650a 2020  absolute mode.  
-00009ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009f00: 206d 6172 6769 6e2c 2026 6469 7363 5f72   margin, &disc_r
-00009f10: 302c 2072 6573 6f5f 7230 2c20 266c 696e  0, reso_r0, &lin
-00009f20: 6465 782c 0a20 2020 2020 2020 2020 2020  dex,.           
-00009f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009f40: 2020 2020 2020 2020 6e63 656c 6c73 5f72          ncells_r
-00009f50: 3029 0a20 2020 2066 7265 6528 6c69 6e64  0).    free(lind
-00009f60: 6578 2920 2320 6765 7474 696e 6720 7269  ex) # getting ri
-00009f70: 6420 6f66 2074 6869 6e67 7320 7765 2064  d of things we d
-00009f80: 6f6e 7420 6e65 6564 0a20 2020 206c 696e  ont need.    lin
-00009f90: 6465 7820 3d20 4e55 4c4c 0a20 2020 2023  dex = NULL.    #
-00009fa0: 202e 2e20 4e6f 7720 7468 6520 6163 7475   .. Now the actu
-00009fb0: 616c 2052 206c 696d 6974 6564 2020 2e2e  al R limited  ..
-00009fc0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00009fd0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00009fe0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e0a 2020 2020  ............    
-00009ff0: 5f73 742e 6379 7468 6f6e 697a 655f 7375  _st.cythonize_su
-0000a000: 6264 6f6d 6169 6e5f 646c 2844 522c 206c  bdomain_dl(DR, l
-0000a010: 696d 6974 735f 646c 290a 2020 2020 737a  imits_dl).    sz
-0000a020: 5f72 203d 205f 7374 2e64 6973 6372 6574  _r = _st.discret
-0000a030: 697a 655f 6c69 6e65 3164 5f63 6f72 6528  ize_line1d_core(
-0000a040: 2652 4d69 6e4d 6178 5b30 5d2c 2072 7374  &RMinMax[0], rst
-0000a050: 6570 2c20 6c69 6d69 7473 5f64 6c2c 0a20  ep, limits_dl,. 
-0000a060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a080: 2020 2020 2054 7275 652c 2030 2c20 2320       True, 0, # 
-0000a090: 6469 7363 7265 7469 7a65 2069 6e20 6162  discretize in ab
-0000a0a0: 736f 6c75 7465 206d 6f64 650a 2020 2020  solute mode.    
-0000a0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a0d0: 2020 6d61 7267 696e 2c20 2664 6973 635f    margin, &disc_
-0000a0e0: 722c 2072 6573 6f5f 722c 2026 6c69 6e64  r, reso_r, &lind
-0000a0f0: 6578 2c0a 2020 2020 2020 2020 2020 2020  ex,.            
-0000a100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a110: 2020 2020 2020 2020 2020 6e63 656c 6c73            ncells
-0000a120: 5f72 290a 2020 2020 6672 6565 286c 696e  _r).    free(lin
-0000a130: 6465 7829 2023 2067 6574 7469 6e67 2072  dex) # getting r
-0000a140: 6964 206f 6620 7468 696e 6773 2077 6520  id of things we 
-0000a150: 646f 6e74 206e 6565 640a 2020 2020 2320  dont need.    # 
-0000a160: 2e2e 204e 6f77 205a 202e 2e2e 2e2e 2e2e  .. Now Z .......
-0000a170: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-0000a180: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-0000a190: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-0000a1a0: 2e2e 2e2e 2e2e 2e2e 2e2e 0a20 2020 205f  ...........    _
-0000a1b0: 7374 2e63 7974 686f 6e69 7a65 5f73 7562  st.cythonize_sub
-0000a1c0: 646f 6d61 696e 5f64 6c28 445a 2c20 6c69  domain_dl(DZ, li
-0000a1d0: 6d69 7473 5f64 6c29 0a20 2020 2073 7a5f  mits_dl).    sz_
-0000a1e0: 7a20 3d20 5f73 742e 6469 7363 7265 7469  z = _st.discreti
-0000a1f0: 7a65 5f6c 696e 6531 645f 636f 7265 2826  ze_line1d_core(&
-0000a200: 5a4d 696e 4d61 785b 305d 2c20 7a73 7465  ZMinMax[0], zste
-0000a210: 702c 206c 696d 6974 735f 646c 2c0a 2020  p, limits_dl,.  
-0000a220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a240: 2020 2020 5472 7565 2c20 302c 2023 2064      True, 0, # d
-0000a250: 6973 6372 6574 697a 6520 696e 2061 6273  iscretize in abs
-0000a260: 6f6c 7574 6520 6d6f 6465 0a20 2020 2020  olute mode.     
-0000a270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a290: 206d 6172 6769 6e2c 2026 6469 7363 5f7a   margin, &disc_z
-0000a2a0: 2c20 7265 736f 5f7a 2c20 266c 696e 6465  , reso_z, &linde
-0000a2b0: 785f 7a2c 0a20 2020 2020 2020 2020 2020  x_z,.           
-0000a2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a2d0: 2020 2020 2020 2020 2020 206e 6365 6c6c             ncell
-0000a2e0: 735f 7a29 0a20 2020 2023 202e 2e20 5072  s_z).    # .. Pr
-0000a2f0: 6570 6172 696e 6720 666f 7220 7068 693a  eparing for phi:
-0000a300: 2067 6574 2074 6865 206c 696d 6974 7320   get the limits 
-0000a310: 6966 2061 6e79 2061 6e64 206d 616b 6520  if any and make 
-0000a320: 7375 7265 2074 6f20 7265 706c 6163 6520  sure to replace 
-0000a330: 7468 656d 0a20 2020 2023 202e 2e20 696e  them.    # .. in
-0000a340: 2074 6865 2070 726f 7065 7220 7175 6164   the proper quad
-0000a350: 7261 6e74 7320 2e2e 2e2e 2e2e 2e2e 2e2e  rants ..........
-0000a360: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-0000a370: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-0000a380: 2e2e 2e2e 2e0a 2020 2020 6966 2044 5068  ......    if DPh
-0000a390: 6920 6973 204e 6f6e 653a 0a20 2020 2020  i is None:.     
-0000a3a0: 2020 206d 696e 5f70 6869 203d 202d 635f     min_phi = -c_
-0000a3b0: 7069 0a20 2020 2020 2020 206d 6178 5f70  pi.        max_p
-0000a3c0: 6869 203d 2063 5f70 690a 2020 2020 656c  hi = c_pi.    el
-0000a3d0: 7365 3a0a 2020 2020 2020 2020 6d69 6e5f  se:.        min_
-0000a3e0: 7068 6920 3d20 4450 6869 5b30 5d20 2320  phi = DPhi[0] # 
-0000a3f0: 746f 2061 766f 6964 2063 6f6e 7665 7273  to avoid convers
-0000a400: 696f 6e73 0a20 2020 2020 2020 206d 696e  ions.        min
-0000a410: 5f70 6869 203d 2063 5f61 7461 6e32 2863  _phi = c_atan2(c
-0000a420: 5f73 696e 286d 696e 5f70 6869 292c 2063  _sin(min_phi), c
-0000a430: 5f63 6f73 286d 696e 5f70 6869 2929 0a20  _cos(min_phi)). 
-0000a440: 2020 2020 2020 206d 6178 5f70 6869 203d         max_phi =
-0000a450: 2044 5068 695b 315d 2023 2074 6f20 6176   DPhi[1] # to av
-0000a460: 6f69 6420 636f 6e76 6572 7369 6f6e 730a  oid conversions.
-0000a470: 2020 2020 2020 2020 6d61 785f 7068 6920          max_phi 
-0000a480: 3d20 635f 6174 616e 3228 635f 7369 6e28  = c_atan2(c_sin(
-0000a490: 6d61 785f 7068 6929 2c20 635f 636f 7328  max_phi), c_cos(
-0000a4a0: 6d61 785f 7068 6929 290a 2020 2020 2320  max_phi)).    # 
-0000a4b0: 2e2e 2049 6e69 7469 616c 697a 6174 696f  .. Initializatio
-0000a4c0: 6e20 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  n ..............
-0000a4d0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-0000a4e0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-0000a4f0: 2e2e 2e2e 2e2e 2e2e 2e2e 0a20 2020 2073  ...........    s
-0000a500: 7a5f 7068 6920 3d20 3c6c 6f6e 672a 3e6d  z_phi = <long*>m
-0000a510: 616c 6c6f 6328 737a 5f72 2a73 697a 656f  alloc(sz_r*sizeo
-0000a520: 6628 6c6f 6e67 2929 0a20 2020 2074 6f74  f(long)).    tot
-0000a530: 5f6e 635f 706c 616e 6520 3d20 3c6c 6f6e  _nc_plane = <lon
-0000a540: 672a 3e6d 616c 6c6f 6328 737a 5f72 2a73  g*>malloc(sz_r*s
-0000a550: 697a 656f 6628 6c6f 6e67 2929 0a20 2020  izeof(long)).   
-0000a560: 206e 6365 6c6c 735f 7270 6869 2020 3d20   ncells_rphi  = 
-0000a570: 3c6c 6f6e 672a 3e6d 616c 6c6f 6328 737a  <long*>malloc(sz
-0000a580: 5f72 2a73 697a 656f 6628 6c6f 6e67 2929  _r*sizeof(long))
-0000a590: 0a20 2020 2073 7465 705f 7270 6869 2020  .    step_rphi  
-0000a5a0: 2020 3d20 3c64 6f75 626c 652a 3e6d 616c    = <double*>mal
-0000a5b0: 6c6f 6328 737a 5f72 2a73 697a 656f 6628  loc(sz_r*sizeof(
-0000a5c0: 646f 7562 6c65 2929 0a20 2020 2072 6573  double)).    res
-0000a5d0: 6f5f 7068 6920 3d20 6e70 2e65 6d70 7479  o_phi = np.empty
-0000a5e0: 2828 737a 5f72 2c29 2920 2320 7765 2063  ((sz_r,)) # we c
-0000a5f0: 7265 6174 6520 7468 6520 6e75 6d70 7920  reate the numpy 
-0000a600: 6172 7261 790a 2020 2020 7265 736f 5f70  array.    reso_p
-0000a610: 6869 5f6d 7620 3d20 7265 736f 5f70 6869  hi_mv = reso_phi
-0000a620: 2023 2061 6e64 2069 7473 2061 7373 6f63   # and its assoc
-0000a630: 6961 7465 6420 6d65 6d6f 7279 7669 6577  iated memoryview
-0000a640: 0a20 2020 2072 5f72 6174 696f 203d 203c  .    r_ratio = <
-0000a650: 696e 743e 2863 5f63 6569 6c28 6469 7363  int>(c_ceil(disc
-0000a660: 5f72 5b73 7a5f 7220 2d20 315d 202f 2064  _r[sz_r - 1] / d
-0000a670: 6973 635f 725b 305d 2929 0a20 2020 2074  isc_r[0])).    t
-0000a680: 776f 7069 5f6f 7665 725f 6470 6869 203d  wopi_over_dphi =
-0000a690: 205f 5457 4f50 4920 2f20 7068 6973 7465   _TWOPI / phiste
-0000a6a0: 700a 2020 2020 696e 645f 6c6f 635f 7230  p.    ind_loc_r0
-0000a6b0: 203d 2030 0a20 2020 206e 6365 6c6c 735f   = 0.    ncells_
-0000a6c0: 7270 6869 3020 3d20 300a 2020 2020 6d69  rphi0 = 0.    mi
-0000a6d0: 6e5f 7068 695f 7069 203d 206d 696e 5f70  n_phi_pi = min_p
-0000a6e0: 6869 202b 2063 5f70 690a 2020 2020 6d61  hi + c_pi.    ma
-0000a6f0: 785f 7068 695f 7069 203d 206d 6178 5f70  x_phi_pi = max_p
-0000a700: 6869 202b 2063 5f70 690a 2020 2020 6162  hi + c_pi.    ab
-0000a710: 7330 203d 2063 5f61 6273 286d 696e 5f70  s0 = c_abs(min_p
-0000a720: 6869 5f70 6929 0a20 2020 2061 6273 3120  hi_pi).    abs1 
-0000a730: 3d20 635f 6162 7328 6d61 785f 7068 695f  = c_abs(max_phi_
-0000a740: 7069 290a 2020 2020 2320 2e2e 2e20 646f  pi).    # ... do
-0000a750: 696e 6720 3020 6c6f 6f70 2062 6566 6f72  ing 0 loop befor
-0000a760: 650a 2020 2020 6966 206d 696e 5f70 6869  e.    if min_phi
-0000a770: 203c 206d 6178 5f70 6869 3a0a 2020 2020   < max_phi:.    
-0000a780: 2020 2020 2320 4765 7420 7468 6520 6163      # Get the ac
-0000a790: 7475 616c 2052 5068 6920 7265 736f 6c75  tual RPhi resolu
-0000a7a0: 7469 6f6e 2061 6e64 2050 6869 206d 6573  tion and Phi mes
-0000a7b0: 6820 656c 656d 656e 7473 2028 2120 6465  h elements (! de
-0000a7c0: 7065 6e64 7320 6f6e 2052 2129 0a20 2020  pends on R!).   
-0000a7d0: 2020 2020 206e 6365 6c6c 735f 7270 6869       ncells_rphi
-0000a7e0: 5b30 5d20 3d20 3c69 6e74 3e63 5f63 6569  [0] = <int>c_cei
-0000a7f0: 6c28 7477 6f70 695f 6f76 6572 5f64 7068  l(twopi_over_dph
-0000a800: 6920 2a20 6469 7363 5f72 5b30 5d29 0a20  i * disc_r[0]). 
-0000a810: 2020 2020 2020 206c 6f63 5f6e 635f 7270         loc_nc_rp
-0000a820: 6869 203d 206e 6365 6c6c 735f 7270 6869  hi = ncells_rphi
-0000a830: 5b30 5d0a 2020 2020 2020 2020 7374 6570  [0].        step
-0000a840: 5f72 7068 695b 305d 203d 205f 5457 4f50  _rphi[0] = _TWOP
-0000a850: 4920 2f20 6e63 656c 6c73 5f72 7068 695b  I / ncells_rphi[
-0000a860: 305d 0a20 2020 2020 2020 2069 6e76 5f64  0].        inv_d
-0000a870: 7270 6869 203d 2031 2e20 2f20 7374 6570  rphi = 1. / step
-0000a880: 5f72 7068 695b 305d 0a20 2020 2020 2020  _rphi[0].       
-0000a890: 2072 6573 6f5f 7068 695f 6d76 5b30 5d20   reso_phi_mv[0] 
-0000a8a0: 3d20 7374 6570 5f72 7068 695b 305d 202a  = step_rphi[0] *
-0000a8b0: 2064 6973 635f 725b 305d 0a20 2020 2020   disc_r[0].     
-0000a8c0: 2020 2074 6f74 5f6e 635f 706c 616e 655b     tot_nc_plane[
-0000a8d0: 305d 203d 2030 2023 2069 6e69 7469 616c  0] = 0 # initial
-0000a8e0: 697a 6174 696f 6e0a 2020 2020 2020 2020  ization.        
-0000a8f0: 2320 4765 7420 696e 6465 7820 616e 6420  # Get index and 
-0000a900: 6375 6d75 6c61 7465 6420 696e 6469 6365  cumulated indice
-0000a910: 7320 6672 6f6d 2062 6163 6b67 726f 756e  s from backgroun
-0000a920: 640a 2020 2020 2020 2020 666f 7220 6a6a  d.        for jj
-0000a930: 2069 6e20 7261 6e67 6528 696e 645f 6c6f   in range(ind_lo
-0000a940: 635f 7230 2c20 6e63 656c 6c73 5f72 305b  c_r0, ncells_r0[
-0000a950: 305d 293a 0a20 2020 2020 2020 2020 2020  0]):.           
-0000a960: 2069 6620 6469 7363 5f72 305b 6a6a 5d3d   if disc_r0[jj]=
-0000a970: 3d64 6973 635f 725b 305d 3a0a 2020 2020  =disc_r[0]:.    
-0000a980: 2020 2020 2020 2020 2020 2020 696e 645f              ind_
-0000a990: 6c6f 635f 7230 203d 206a 6a0a 2020 2020  loc_r0 = jj.    
-0000a9a0: 2020 2020 2020 2020 2020 2020 6272 6561              brea
-0000a9b0: 6b0a 2020 2020 2020 2020 2020 2020 656c  k.            el
-0000a9c0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0000a9d0: 2020 2020 6e63 656c 6c73 5f72 7068 6930      ncells_rphi0
-0000a9e0: 202b 3d20 3c6c 6f6e 673e 635f 6365 696c   += <long>c_ceil
-0000a9f0: 2874 776f 7069 5f6f 7665 725f 6470 6869  (twopi_over_dphi
-0000aa00: 202a 2064 6973 635f 7230 5b6a 6a5d 290a   * disc_r0[jj]).
-0000aa10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000aa20: 746f 745f 6e63 5f70 6c61 6e65 5b30 5d20  tot_nc_plane[0] 
-0000aa30: 3d20 6e63 656c 6c73 5f72 7068 6930 202a  = ncells_rphi0 *
-0000aa40: 206e 6365 6c6c 735f 7a5b 305d 0a20 2020   ncells_z[0].   
-0000aa50: 2020 2020 2023 2047 6574 2069 6e64 6963       # Get indic
-0000aa60: 6573 206f 6620 7068 690a 2020 2020 2020  es of phi.      
-0000aa70: 2020 2320 4765 7420 7468 6520 6578 7472    # Get the extr
-0000aa80: 656d 6520 696e 6469 6365 7320 6f66 2074  eme indices of t
-0000aa90: 6865 206d 6573 6820 656c 656d 656e 7473  he mesh elements
-0000aaa0: 2074 6861 7420 7265 616c 6c79 206e 6565   that really nee
-0000aab0: 6420 746f 0a20 2020 2020 2020 2023 2062  d to.        # b
-0000aac0: 6520 6372 6561 7465 6420 7769 7468 696e  e created within
-0000aad0: 2074 686f 7365 206c 696d 6974 730a 2020   those limits.  
-0000aae0: 2020 2020 2020 6966 2061 6273 3020 2d20        if abs0 - 
-0000aaf0: 7374 6570 5f72 7068 695b 305d 2a63 5f66  step_rphi[0]*c_f
-0000ab00: 6c6f 6f72 2861 6273 3020 2a20 696e 765f  loor(abs0 * inv_
-0000ab10: 6472 7068 6929 203c 206d 6172 6769 6e2a  drphi) < margin*
-0000ab20: 7374 6570 5f72 7068 695b 305d 3a0a 2020  step_rphi[0]:.  
-0000ab30: 2020 2020 2020 2020 2020 6e70 6869 3020            nphi0 
-0000ab40: 3d20 696e 7428 635f 726f 756e 6428 286d  = int(c_round((m
-0000ab50: 696e 5f70 6869 202b 2063 5f70 6929 202a  in_phi + c_pi) *
-0000ab60: 2069 6e76 5f64 7270 6869 2929 0a20 2020   inv_drphi)).   
-0000ab70: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0000ab80: 2020 2020 2020 206e 7068 6930 203d 2069         nphi0 = i
-0000ab90: 6e74 2863 5f66 6c6f 6f72 2828 6d69 6e5f  nt(c_floor((min_
-0000aba0: 7068 6920 2b63 5f70 6929 202a 2069 6e76  phi +c_pi) * inv
-0000abb0: 5f64 7270 6869 2929 0a20 2020 2020 2020  _drphi)).       
-0000abc0: 2069 6620 6162 7331 2d73 7465 705f 7270   if abs1-step_rp
-0000abd0: 6869 5b30 5d2a 635f 666c 6f6f 7228 6162  hi[0]*c_floor(ab
-0000abe0: 7331 202a 2069 6e76 5f64 7270 6869 2920  s1 * inv_drphi) 
-0000abf0: 3c20 6d61 7267 696e 2a73 7465 705f 7270  < margin*step_rp
-0000ac00: 6869 5b30 5d3a 0a20 2020 2020 2020 2020  hi[0]:.         
-0000ac10: 2020 206e 7068 6931 203d 2069 6e74 2863     nphi1 = int(c
-0000ac20: 5f72 6f75 6e64 2828 6d61 785f 7068 692b  _round((max_phi+
-0000ac30: 635f 7069 2920 2a20 696e 765f 6472 7068  c_pi) * inv_drph
-0000ac40: 6929 2d31 290a 2020 2020 2020 2020 656c  i)-1).        el
-0000ac50: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0000ac60: 6e70 6869 3120 3d20 696e 7428 635f 666c  nphi1 = int(c_fl
-0000ac70: 6f6f 7228 286d 6178 5f70 6869 2b63 5f70  oor((max_phi+c_p
-0000ac80: 6929 202a 2069 6e76 5f64 7270 6869 2929  i) * inv_drphi))
-0000ac90: 0a20 2020 2020 2020 2073 7a5f 7068 695b  .        sz_phi[
-0000aca0: 305d 203d 206e 7068 6931 202b 2031 202d  0] = nphi1 + 1 -
-0000acb0: 206e 7068 6930 0a20 2020 2020 2020 206d   nphi0.        m
-0000acc0: 6178 5f73 7a5f 7068 695b 305d 203d 2073  ax_sz_phi[0] = s
-0000acd0: 7a5f 7068 695b 305d 0a20 2020 2020 2020  z_phi[0].       
-0000ace0: 2069 6e64 4920 3d20 2d6e 702e 6f6e 6573   indI = -np.ones
-0000acf0: 2828 737a 5f72 2c20 737a 5f70 6869 5b30  ((sz_r, sz_phi[0
-0000ad00: 5d20 2a20 725f 7261 7469 6f20 2b20 3129  ] * r_ratio + 1)
-0000ad10: 2c20 6474 7970 653d 696e 7429 0a20 2020  , dtype=int).   
-0000ad20: 2020 2020 2069 6e64 695f 6d76 203d 2069       indi_mv = i
-0000ad30: 6e64 490a 2020 2020 2020 2020 666f 7220  ndI.        for 
-0000ad40: 6a6a 2069 6e20 7261 6e67 6528 737a 5f70  jj in range(sz_p
-0000ad50: 6869 5b30 5d29 3a0a 2020 2020 2020 2020  hi[0]):.        
-0000ad60: 2020 2020 696e 6469 5f6d 765b 302c 206a      indi_mv[0, j
-0000ad70: 6a5d 203d 206e 7068 6930 202b 206a 6a0a  j] = nphi0 + jj.
-0000ad80: 2020 2020 2020 2020 6e70 7473 5f64 6973          npts_dis
-0000ad90: 6320 2b3d 2073 7a5f 7a20 2a20 737a 5f70  c += sz_z * sz_p
-0000ada0: 6869 5b30 5d0a 2020 2020 656c 7365 3a0a  hi[0].    else:.
-0000adb0: 2020 2020 2020 2020 2320 4765 7420 7468          # Get th
-0000adc0: 6520 6163 7475 616c 2052 5068 6920 7265  e actual RPhi re
-0000add0: 736f 6c75 7469 6f6e 2061 6e64 2050 6869  solution and Phi
-0000ade0: 206d 6573 6820 656c 656d 656e 7473 2028   mesh elements (
-0000adf0: 2120 6465 7065 6e64 7320 6f6e 2052 2129  ! depends on R!)
-0000ae00: 0a20 2020 2020 2020 206e 6365 6c6c 735f  .        ncells_
-0000ae10: 7270 6869 5b30 5d20 3d20 3c69 6e74 3e63  rphi[0] = <int>c
-0000ae20: 5f63 6569 6c28 7477 6f70 695f 6f76 6572  _ceil(twopi_over
-0000ae30: 5f64 7068 6920 2a20 6469 7363 5f72 5b30  _dphi * disc_r[0
-0000ae40: 5d29 0a20 2020 2020 2020 206c 6f63 5f6e  ]).        loc_n
-0000ae50: 635f 7270 6869 203d 206e 6365 6c6c 735f  c_rphi = ncells_
-0000ae60: 7270 6869 5b30 5d0a 2020 2020 2020 2020  rphi[0].        
-0000ae70: 7374 6570 5f72 7068 695b 305d 203d 205f  step_rphi[0] = _
-0000ae80: 5457 4f50 4920 2f20 6e63 656c 6c73 5f72  TWOPI / ncells_r
-0000ae90: 7068 695b 305d 0a20 2020 2020 2020 2069  phi[0].        i
-0000aea0: 6e76 5f64 7270 6869 203d 2031 2e20 2f20  nv_drphi = 1. / 
-0000aeb0: 7374 6570 5f72 7068 695b 305d 0a20 2020  step_rphi[0].   
-0000aec0: 2020 2020 2072 6573 6f5f 7068 695f 6d76       reso_phi_mv
-0000aed0: 5b30 5d20 3d20 7374 6570 5f72 7068 695b  [0] = step_rphi[
-0000aee0: 305d 202a 2064 6973 635f 725b 305d 0a20  0] * disc_r[0]. 
-0000aef0: 2020 2020 2020 2074 6f74 5f6e 635f 706c         tot_nc_pl
-0000af00: 616e 655b 305d 203d 2030 2023 2069 6e69  ane[0] = 0 # ini
-0000af10: 7469 616c 697a 6174 696f 6e0a 2020 2020  tialization.    
-0000af20: 2020 2020 2320 4765 7420 696e 6465 7820      # Get index 
-0000af30: 616e 6420 6375 6d75 6c61 7465 6420 696e  and cumulated in
-0000af40: 6469 6365 7320 6672 6f6d 2062 6163 6b67  dices from backg
-0000af50: 726f 756e 640a 2020 2020 2020 2020 666f  round.        fo
-0000af60: 7220 6a6a 2069 6e20 7261 6e67 6528 696e  r jj in range(in
-0000af70: 645f 6c6f 635f 7230 2c20 6e63 656c 6c73  d_loc_r0, ncells
-0000af80: 5f72 305b 305d 293a 0a20 2020 2020 2020  _r0[0]):.       
-0000af90: 2020 2020 2069 6620 6469 7363 5f72 305b       if disc_r0[
-0000afa0: 6a6a 5d3d 3d64 6973 635f 725b 305d 3a0a  jj]==disc_r[0]:.
-0000afb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000afc0: 696e 645f 6c6f 635f 7230 203d 206a 6a0a  ind_loc_r0 = jj.
-0000afd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000afe0: 6272 6561 6b0a 2020 2020 2020 2020 2020  break.          
-0000aff0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0000b000: 2020 2020 2020 2020 6e63 656c 6c73 5f72          ncells_r
-0000b010: 7068 6930 202b 3d20 3c6c 6f6e 673e 635f  phi0 += <long>c_
-0000b020: 6365 696c 2874 776f 7069 5f6f 7665 725f  ceil(twopi_over_
-0000b030: 6470 6869 202a 2064 6973 635f 7230 5b6a  dphi * disc_r0[j
-0000b040: 6a5d 290a 2020 2020 2020 2020 2020 2020  j]).            
-0000b050: 2020 2020 746f 745f 6e63 5f70 6c61 6e65      tot_nc_plane
-0000b060: 5b30 5d20 3d20 6e63 656c 6c73 5f72 7068  [0] = ncells_rph
-0000b070: 6930 202a 206e 6365 6c6c 735f 7a5b 305d  i0 * ncells_z[0]
-0000b080: 0a20 2020 2020 2020 2023 2047 6574 2069  .        # Get i
-0000b090: 6e64 6963 6573 206f 6620 7068 690a 2020  ndices of phi.  
-0000b0a0: 2020 2020 2020 2320 4765 7420 7468 6520        # Get the 
-0000b0b0: 6578 7472 656d 6520 696e 6469 6365 7320  extreme indices 
-0000b0c0: 6f66 2074 6865 206d 6573 6820 656c 656d  of the mesh elem
-0000b0d0: 656e 7473 2074 6861 7420 7265 616c 6c79  ents that really
-0000b0e0: 206e 6565 6420 746f 0a20 2020 2020 2020   need to.       
-0000b0f0: 2023 2062 6520 6372 6561 7465 6420 7769   # be created wi
-0000b100: 7468 696e 2074 686f 7365 206c 696d 6974  thin those limit
-0000b110: 730a 2020 2020 2020 2020 6966 2061 6273  s.        if abs
-0000b120: 3020 2d20 7374 6570 5f72 7068 695b 305d  0 - step_rphi[0]
-0000b130: 2a63 5f66 6c6f 6f72 2861 6273 3020 2a20  *c_floor(abs0 * 
-0000b140: 696e 765f 6472 7068 6929 203c 206d 6172  inv_drphi) < mar
-0000b150: 6769 6e2a 7374 6570 5f72 7068 695b 305d  gin*step_rphi[0]
-0000b160: 3a0a 2020 2020 2020 2020 2020 2020 6e70  :.            np
-0000b170: 6869 3020 3d20 696e 7428 635f 726f 756e  hi0 = int(c_roun
-0000b180: 6428 286d 696e 5f70 6869 202b 2063 5f70  d((min_phi + c_p
-0000b190: 6929 202a 2069 6e76 5f64 7270 6869 2929  i) * inv_drphi))
-0000b1a0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-0000b1b0: 2020 2020 2020 2020 2020 206e 7068 6930             nphi0
-0000b1c0: 203d 2069 6e74 2863 5f66 6c6f 6f72 2828   = int(c_floor((
-0000b1d0: 6d69 6e5f 7068 6920 2b20 635f 7069 2920  min_phi + c_pi) 
-0000b1e0: 2a20 696e 765f 6472 7068 6929 290a 2020  * inv_drphi)).  
-0000b1f0: 2020 2020 2020 6966 2061 6273 312d 7374        if abs1-st
-0000b200: 6570 5f72 7068 695b 305d 2a63 5f66 6c6f  ep_rphi[0]*c_flo
-0000b210: 6f72 2861 6273 3120 2a20 696e 765f 6472  or(abs1 * inv_dr
-0000b220: 7068 6929 203c 206d 6172 6769 6e2a 7374  phi) < margin*st
-0000b230: 6570 5f72 7068 695b 305d 3a0a 2020 2020  ep_rphi[0]:.    
-0000b240: 2020 2020 2020 2020 6e70 6869 3120 3d20          nphi1 = 
-0000b250: 696e 7428 635f 726f 756e 6428 286d 6178  int(c_round((max
-0000b260: 5f70 6869 2b63 5f70 6929 202a 2069 6e76  _phi+c_pi) * inv
-0000b270: 5f64 7270 6869 292d 3129 0a20 2020 2020  _drphi)-1).     
-0000b280: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000b290: 2020 2020 206e 7068 6931 203d 2069 6e74       nphi1 = int
-0000b2a0: 2863 5f66 6c6f 6f72 2828 6d61 785f 7068  (c_floor((max_ph
-0000b2b0: 692b 635f 7069 2920 2a20 696e 765f 6472  i+c_pi) * inv_dr
-0000b2c0: 7068 6929 290a 2020 2020 2020 2020 737a  phi)).        sz
-0000b2d0: 5f70 6869 5b30 5d20 3d20 6e70 6869 312b  _phi[0] = nphi1+
-0000b2e0: 312b 6c6f 635f 6e63 5f72 7068 692d 6e70  1+loc_nc_rphi-np
-0000b2f0: 6869 300a 2020 2020 2020 2020 6d61 785f  hi0.        max_
-0000b300: 737a 5f70 6869 5b30 5d20 3d20 737a 5f70  sz_phi[0] = sz_p
-0000b310: 6869 5b30 5d0a 2020 2020 2020 2020 696e  hi[0].        in
-0000b320: 6449 203d 202d 6e70 2e6f 6e65 7328 2873  dI = -np.ones((s
-0000b330: 7a5f 722c 2073 7a5f 7068 695b 305d 202a  z_r, sz_phi[0] *
-0000b340: 2072 5f72 6174 696f 202b 2031 292c 2064   r_ratio + 1), d
-0000b350: 7479 7065 3d69 6e74 290a 2020 2020 2020  type=int).      
-0000b360: 2020 696e 6469 5f6d 7620 3d20 696e 6449    indi_mv = indI
-0000b370: 0a20 2020 2020 2020 2066 6f72 206a 6a20  .        for jj 
-0000b380: 696e 2072 616e 6765 286c 6f63 5f6e 635f  in range(loc_nc_
-0000b390: 7270 6869 202d 206e 7068 6930 293a 0a20  rphi - nphi0):. 
-0000b3a0: 2020 2020 2020 2020 2020 2069 6e64 695f             indi_
-0000b3b0: 6d76 5b30 2c20 6a6a 5d20 3d20 6e70 6869  mv[0, jj] = nphi
-0000b3c0: 3020 2b20 6a6a 0a20 2020 2020 2020 2066  0 + jj.        f
-0000b3d0: 6f72 206a 6a20 696e 2072 616e 6765 286c  or jj in range(l
-0000b3e0: 6f63 5f6e 635f 7270 6869 202d 206e 7068  oc_nc_rphi - nph
-0000b3f0: 6930 2c20 737a 5f70 6869 5b30 5d29 3a0a  i0, sz_phi[0]):.
-0000b400: 2020 2020 2020 2020 2020 2020 696e 6469              indi
-0000b410: 5f6d 765b 302c 206a 6a5d 203d 206a 6a20  _mv[0, jj] = jj 
-0000b420: 2d20 286c 6f63 5f6e 635f 7270 6869 202d  - (loc_nc_rphi -
-0000b430: 206e 7068 6930 290a 2020 2020 2020 2020   nphi0).        
-0000b440: 6e70 7473 5f64 6973 6320 2b3d 2073 7a5f  npts_disc += sz_
-0000b450: 7a20 2a20 737a 5f70 6869 5b30 5d0a 2020  z * sz_phi[0].  
-0000b460: 2020 2320 2e2e 2e20 646f 696e 6720 7468    # ... doing th
-0000b470: 6520 6f74 6865 7273 202e 2e2e 2e2e 2e2e  e others .......
-0000b480: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-0000b490: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-0000b4a0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 0a20  ............... 
-0000b4b0: 2020 206e 7074 735f 6469 7363 202b 3d20     npts_disc += 
-0000b4c0: 5f73 742e 766d 6573 685f 6469 7363 5f70  _st.vmesh_disc_p
-0000b4d0: 6869 2873 7a5f 722c 2073 7a5f 7a2c 206e  hi(sz_r, sz_z, n
-0000b4e0: 6365 6c6c 735f 7270 6869 2c20 7068 6973  cells_rphi, phis
-0000b4f0: 7465 702c 0a20 2020 2020 2020 2020 2020  tep,.           
-0000b500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b510: 2020 6e63 656c 6c73 5f72 7068 6930 2c0a    ncells_rphi0,.
-0000b520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b530: 2020 2020 2020 2020 2020 2020 2064 6973               dis
-0000b540: 635f 722c 2064 6973 635f 7230 2c20 7374  c_r, disc_r0, st
-0000b550: 6570 5f72 7068 692c 0a20 2020 2020 2020  ep_rphi,.       
-0000b560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b570: 2020 2020 2020 7265 736f 5f70 6869 5f6d        reso_phi_m
-0000b580: 762c 2074 6f74 5f6e 635f 706c 616e 652c  v, tot_nc_plane,
-0000b590: 2069 6e64 5f6c 6f63 5f72 302c 0a20 2020   ind_loc_r0,.   
-0000b5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b5b0: 2020 2020 2020 2020 2020 6e63 656c 6c73            ncells
-0000b5c0: 5f72 305b 305d 2c20 6e63 656c 6c73 5f7a  _r0[0], ncells_z
-0000b5d0: 5b30 5d2c 2026 6d61 785f 737a 5f70 6869  [0], &max_sz_phi
-0000b5e0: 5b30 5d2c 0a20 2020 2020 2020 2020 2020  [0],.           
-0000b5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b600: 2020 6d69 6e5f 7068 692c 206d 6178 5f70    min_phi, max_p
-0000b610: 6869 2c20 737a 5f70 6869 2c20 696e 6469  hi, sz_phi, indi
-0000b620: 5f6d 762c 0a20 2020 2020 2020 2020 2020  _mv,.           
-0000b630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b640: 2020 6d61 7267 696e 2c20 6e75 6d5f 7468    margin, num_th
-0000b650: 7265 6164 7329 0a20 2020 2023 202e 2e2e  reads).    # ...
-0000b660: 2076 6967 6e65 7474 696e 6720 2e2e 2e2e   vignetting ....
-0000b670: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-0000b680: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-0000b690: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-0000b6a0: 2e2e 2e2e 2e2e 2e0a 2020 2020 6973 5f69  ........    is_i
-0000b6b0: 6e5f 7669 676e 6574 7465 203d 206e 702e  n_vignette = np.
-0000b6c0: 6f6e 6573 2828 737a 5f72 2c20 737a 5f7a  ones((sz_r, sz_z
-0000b6d0: 292c 2064 7479 7065 3d69 6e74 2920 2320  ), dtype=int) # 
-0000b6e0: 6279 2064 6566 6175 6c74 2079 6573 0a0a  by default yes..
-0000b6f0: 2020 2020 6966 206c 696d 6974 5f76 706f      if limit_vpo
-0000b700: 6c79 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ly is not None:.
-0000b710: 2020 2020 2020 2020 6e70 7473 5f76 706f          npts_vpo
-0000b720: 6c79 203d 206c 696d 6974 5f76 706f 6c79  ly = limit_vpoly
-0000b730: 2e73 6861 7065 5b31 5d20 2d20 310a 0a20  .shape[1] - 1.. 
-0000b740: 2020 2020 2020 2023 2077 6520 6d61 6b65         # we make
-0000b750: 2073 7572 6520 6974 2069 7320 636c 6f73   sure it is clos
-0000b760: 6564 0a20 2020 2020 2020 2069 6620 6e6f  ed.        if no
-0000b770: 7428 6162 7328 6c69 6d69 745f 7670 6f6c  t(abs(limit_vpol
-0000b780: 795b 302c 2030 5d20 2d20 6c69 6d69 745f  y[0, 0] - limit_
-0000b790: 7670 6f6c 795b 302c 206e 7074 735f 7670  vpoly[0, npts_vp
-0000b7a0: 6f6c 795d 2920 3c20 5f56 534d 414c 4c0a  oly]) < _VSMALL.
-0000b7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b7c0: 616e 6420 6162 7328 6c69 6d69 745f 7670  and abs(limit_vp
-0000b7d0: 6f6c 795b 312c 2030 5d0a 2020 2020 2020  oly[1, 0].      
-0000b7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b7f0: 2020 2d20 6c69 6d69 745f 7670 6f6c 795b    - limit_vpoly[
-0000b800: 312c 206e 7074 735f 7670 6f6c 795d 2920  1, npts_vpoly]) 
-0000b810: 3c20 5f56 534d 414c 4c29 3a0a 2020 2020  < _VSMALL):.    
-0000b820: 2020 2020 2020 2020 706f 6c79 5f6d 7620          poly_mv 
-0000b830: 3d20 6e70 2e63 6f6e 6361 7465 6e61 7465  = np.concatenate
-0000b840: 2828 6c69 6d69 745f 7670 6f6c 792c 206c  ((limit_vpoly, l
-0000b850: 696d 6974 5f76 706f 6c79 5b3a 2c20 303a  imit_vpoly[:, 0:
-0000b860: 315d 292c 2061 7869 733d 3129 0a20 2020  1]), axis=1).   
-0000b870: 2020 2020 2020 2020 206e 7074 735f 7670           npts_vp
-0000b880: 6f6c 7920 2b3d 2031 0a20 2020 2020 2020  oly += 1.       
-0000b890: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0000b8a0: 2020 2070 6f6c 795f 6d76 203d 206c 696d     poly_mv = lim
-0000b8b0: 6974 5f76 706f 6c79 0a0a 2020 2020 2020  it_vpoly..      
-0000b8c0: 2020 5f20 3d20 5f76 742e 6172 655f 696e    _ = _vt.are_in
-0000b8d0: 5f76 6967 6e65 7474 6528 737a 5f72 2c20  _vignette(sz_r, 
-0000b8e0: 737a 5f7a 2c0a 2020 2020 2020 2020 2020  sz_z,.          
-0000b8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b900: 2020 2020 2020 706f 6c79 5f6d 762c 206e        poly_mv, n
-0000b910: 7074 735f 7670 6f6c 792c 0a20 2020 2020  pts_vpoly,.     
+00009260: 2020 2020 2020 2064 6f75 626c 6520 6d61         double ma
+00009270: 7267 696e 3d5f 5653 4d41 4c4c 2c0a 2020  rgin=_VSMALL,.  
+00009280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000092a0: 2069 6e74 206e 756d 5f74 6872 6561 6473   int num_threads
+000092b0: 3d34 3829 3a0a 2020 2020 2222 2252 6574  =48):.    """Ret
+000092c0: 7572 6e73 2074 6865 2064 6573 6972 6564  urns the desired
+000092d0: 2073 7562 6d65 7368 2069 6e64 6963 6174   submesh indicat
+000092e0: 6564 2062 7920 7468 6520 6c69 6d69 7473  ed by the limits
+000092f0: 2028 4452 2c44 5a2c 4450 6869 292c 0a20   (DR,DZ,DPhi),. 
+00009300: 2020 2066 6f72 2074 6865 2064 6573 6972     for the desir
+00009310: 6564 2072 6573 6f6c 7574 696f 6e20 2872  ed resolution (r
+00009320: 7374 6570 2c7a 7374 6570 2c64 5270 6869  step,zstep,dRphi
+00009330: 292e 0a0a 2020 2020 5061 7261 6d65 7465  )...    Paramete
+00009340: 7273 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  rs.    ---------
+00009350: 2d0a 2020 2020 2020 2020 7273 7465 7020  -.        rstep 
+00009360: 2864 6f75 626c 6529 3a20 7265 6669 6e65  (double): refine
+00009370: 6d65 6e74 2061 6c6f 6e67 2072 6164 6975  ment along radiu
+00009380: 7320 6072 600a 2020 2020 2020 2020 7a73  s `r`.        zs
+00009390: 7465 7020 2864 6f75 626c 6529 3a20 7265  tep (double): re
+000093a0: 6669 6e65 6d65 6e74 2061 6c6f 6e67 2068  finement along h
+000093b0: 6569 6768 7420 607a 600a 2020 2020 2020  eight `z`.      
+000093c0: 2020 7068 6973 7465 7020 2864 6f75 626c    phistep (doubl
+000093d0: 6529 3a20 7265 6669 6e65 6d65 6e74 2061  e): refinement a
+000093e0: 6c6f 6e67 2074 6f72 6f69 6461 6c20 6469  long toroidal di
+000093f0: 7265 6374 696f 6e20 6070 6869 600a 2020  rection `phi`.  
+00009400: 2020 2020 2020 524d 696e 4d61 783a 2061        RMinMax: a
+00009410: 7272 6179 2073 7065 6369 6679 696e 6720  rray specifying 
+00009420: 7468 6520 6c69 6d69 7473 206d 696e 2061  the limits min a
+00009430: 6e64 206d 6178 2069 6e20 6072 600a 2020  nd max in `r`.  
+00009440: 2020 2020 2020 5a4d 696e 4d61 783a 2061        ZMinMax: a
+00009450: 7272 6179 2073 7065 6369 6679 696e 6720  rray specifying 
+00009460: 7468 6520 6c69 6d69 7473 206d 696e 2061  the limits min a
+00009470: 6e64 206d 6178 2069 6e20 607a 600a 2020  nd max in `z`.  
+00009480: 2020 2020 2020 4452 3a20 6172 7261 7920        DR: array 
+00009490: 7370 6563 6966 7969 6e67 2074 6865 2061  specifying the a
+000094a0: 6374 7561 6c20 7375 622d 766f 6c75 6d65  ctual sub-volume
+000094b0: 206c 696d 6974 7320 746f 2067 6574 2069   limits to get i
+000094c0: 6e20 6072 600a 2020 2020 2020 2020 445a  n `r`.        DZ
+000094d0: 3a20 6172 7261 7920 7370 6563 6966 7969  : array specifyi
+000094e0: 6e67 2074 6865 2061 6374 7561 6c20 7375  ng the actual su
+000094f0: 622d 766f 6c75 6d65 206c 696d 6974 7320  b-volume limits 
+00009500: 746f 2067 6574 2069 6e20 607a 600a 2020  to get in `z`.  
+00009510: 2020 2020 2020 4450 6869 3a20 6172 7261        DPhi: arra
+00009520: 7920 7370 6563 6966 7969 6e67 2074 6865  y specifying the
+00009530: 2061 6374 7561 6c20 7375 622d 766f 6c75   actual sub-volu
+00009540: 6d65 206c 696d 6974 7320 746f 2067 6574  me limits to get
+00009550: 2069 6e20 6070 6869 600a 2020 2020 2020   in `phi`.      
+00009560: 2020 6c69 6d69 745f 7670 6f6c 793a 2061    limit_vpoly: a
+00009570: 7272 6179 2d6c 696b 6520 6465 6669 6e69  rray-like defini
+00009580: 6e67 2074 6865 2060 2852 2c5a 2960 2063  ng the `(R,Z)` c
+00009590: 6f6f 7264 696e 6174 6573 206f 6620 7468  oordinates of th
+000095a0: 6520 706f 6c6f 6964 616c 0a20 2020 2020  e poloidal.     
+000095b0: 2020 2020 2020 2063 7574 206f 6620 7468         cut of th
+000095c0: 6520 6c69 6d69 7469 6e67 2066 6c75 7820  e limiting flux 
+000095d0: 7375 7266 6163 650a 2020 2020 2020 2020  surface.        
+000095e0: 6f75 745f 666f 726d 6174 2873 7472 696e  out_format(strin
+000095f0: 6729 3a20 6569 7468 6572 2022 2858 2c59  g): either "(X,Y
+00009600: 2c5a 2922 206f 7220 2228 522c 5a2c 5068  ,Z)" or "(R,Z,Ph
+00009610: 6929 2220 666f 7220 6361 7274 6573 6961  i)" for cartesia
+00009620: 6e20 6f72 0a20 2020 2020 2020 2020 2020  n or.           
+00009630: 2070 6f6c 6172 2063 6f6f 7264 696e 6174   polar coordinat
+00009640: 6573 0a20 2020 2020 2020 206d 6172 6769  es.        margi
+00009650: 6e28 646f 7562 6c65 293a 2074 6f6c 6572  n(double): toler
+00009660: 616e 6365 2065 7272 6f72 2e0a 2020 2020  ance error..    
+00009670: 2020 2020 2020 2020 4465 6661 756c 7473          Defaults
+00009680: 2074 6f20 7c5f 5653 4d41 4c4c 7c0a 2020   to |_VSMALL|.  
+00009690: 2020 5265 7475 726e 730a 2020 2020 2d2d    Returns.    --
+000096a0: 2d2d 2d2d 0a20 2020 2020 2020 7074 733a  ----.       pts:
+000096b0: 2028 332c 206e 7074 7329 2061 7272 6179   (3, npts) array
+000096c0: 2069 6e20 6f75 745f 666f 726d 6174 2028   in out_format (
+000096d0: 6361 7274 6573 6961 6e20 6f72 2070 6f6c  cartesian or pol
+000096e0: 6172 2920 6f66 0a20 2020 2020 2020 2020  ar) of.         
+000096f0: 2020 2064 6973 6372 6574 697a 6564 2076     discretized v
+00009700: 6f6c 756d 650a 2020 2020 2020 2072 6573  olume.       res
+00009710: 3364 3a20 286e 7074 7329 2072 6573 6f6c  3d: (npts) resol
+00009720: 7574 696f 6e20 6f6e 2065 6163 6820 706f  ution on each po
+00009730: 696e 740a 2020 2020 2020 2069 6e64 3a20  int.       ind: 
+00009740: 2020 286e 7074 7329 2069 6e64 6963 6573    (npts) indices
+00009750: 2074 6f20 7265 636f 6e73 7472 7563 7420   to reconstruct 
+00009760: 7468 6520 706f 696e 7473 2069 6e20 3344  the points in 3D
+00009770: 2028 7573 6566 756c 206f 6e6c 7920 6966   (useful only if
+00009780: 0a20 2020 2020 2020 2020 2020 2020 206c  .              l
+00009790: 696d 6974 5f76 706f 6c79 2069 7320 6e6f  imit_vpoly is no
+000097a0: 7420 6e6f 6e65 290a 2020 2020 2020 2072  t none).       r
+000097b0: 6573 6f5f 723a 2028 646f 7562 6c65 2920  eso_r: (double) 
+000097c0: 7265 736f 6c75 7469 6f6e 206f 6e20 7220  resolution on r 
+000097d0: 2863 6f6e 7374 616e 7429 0a20 2020 2020  (constant).     
+000097e0: 2020 7265 736f 5f7a 3a20 2864 6f75 626c    reso_z: (doubl
+000097f0: 6529 2072 6573 6f6c 7574 696f 6e20 6f6e  e) resolution on
+00009800: 207a 2028 636f 6e73 7461 6e74 290a 2020   z (constant).  
+00009810: 2020 2020 2072 6573 6f5f 7068 6920 3a20       reso_phi : 
+00009820: 2873 7a5f 7229 2061 7272 6179 2c20 7265  (sz_r) array, re
+00009830: 736f 6c75 7469 6f6e 2052 2a64 5068 692c  solution R*dPhi,
+00009840: 2070 6869 2072 6573 6f6c 7574 696f 6e20   phi resolution 
+00009850: 6f6e 2065 6163 6820 520a 2020 2020 2020  on each R.      
+00009860: 2073 7a5f 7220 3a20 2869 6e74 2920 6e75   sz_r : (int) nu
+00009870: 6d62 6572 206f 6620 706f 696e 7473 2069  mber of points i
+00009880: 6e20 720a 2020 2020 2020 2073 7a5f 7a20  n r.       sz_z 
+00009890: 3a20 2869 6e74 2920 6e75 6d62 6572 206f  : (int) number o
+000098a0: 6620 706f 696e 7473 2069 6e20 7a0a 2020  f points in z.  
+000098b0: 2020 2222 220a 2020 2020 6364 6566 2069    """.    cdef i
+000098c0: 6e74 206a 6a0a 2020 2020 6364 6566 2069  nt jj.    cdef i
+000098d0: 6e74 206e 7074 735f 6469 7363 203d 2030  nt npts_disc = 0
+000098e0: 0a20 2020 2063 6465 6620 696e 7420 737a  .    cdef int sz
+000098f0: 5f72 2c20 737a 5f7a 0a20 2020 2063 6465  _r, sz_z.    cde
+00009900: 6620 696e 7420 725f 7261 7469 6f0a 2020  f int r_ratio.  
+00009910: 2020 6364 6566 2069 6e74 2069 6e64 5f6c    cdef int ind_l
+00009920: 6f63 5f72 300a 2020 2020 6364 6566 2069  oc_r0.    cdef i
+00009930: 6e74 206e 7074 735f 7670 6f6c 790a 2020  nt npts_vpoly.  
+00009940: 2020 6364 6566 2069 6e74 5b31 5d20 6d61    cdef int[1] ma
+00009950: 785f 737a 5f70 6869 0a20 2020 2063 6465  x_sz_phi.    cde
+00009960: 6620 7374 7220 6f75 745f 6c6f 7720 3d20  f str out_low = 
+00009970: 6f75 745f 666f 726d 6174 2e6c 6f77 6572  out_format.lower
+00009980: 2829 0a20 2020 2063 6465 6620 6269 6e74  ().    cdef bint
+00009990: 2069 735f 6361 7274 203d 206f 7574 5f6c   is_cart = out_l
+000099a0: 6f77 203d 3d20 2728 782c 792c 7a29 270a  ow == '(x,y,z)'.
+000099b0: 2020 2020 6364 6566 2064 6f75 626c 6520      cdef double 
+000099c0: 6d69 6e5f 7068 692c 206d 6178 5f70 6869  min_phi, max_phi
+000099d0: 0a20 2020 2063 6465 6620 646f 7562 6c65  .    cdef double
+000099e0: 206d 696e 5f70 6869 5f70 690a 2020 2020   min_phi_pi.    
+000099f0: 6364 6566 2064 6f75 626c 6520 6d61 785f  cdef double max_
+00009a00: 7068 695f 7069 0a20 2020 2063 6465 6620  phi_pi.    cdef 
+00009a10: 646f 7562 6c65 2061 6273 302c 2061 6273  double abs0, abs
+00009a20: 310a 2020 2020 6364 6566 2064 6f75 626c  1.    cdef doubl
+00009a30: 6520 7265 736f 5f72 5f7a 0a20 2020 2063  e reso_r_z.    c
+00009a40: 6465 6620 646f 7562 6c65 2074 776f 7069  def double twopi
+00009a50: 5f6f 7665 725f 6470 6869 0a20 2020 2063  _over_dphi.    c
+00009a60: 6465 6620 6c6f 6e67 5b31 5d20 6e63 656c  def long[1] ncel
+00009a70: 6c73 5f72 302c 206e 6365 6c6c 735f 722c  ls_r0, ncells_r,
+00009a80: 206e 6365 6c6c 735f 7a0a 2020 2020 6364   ncells_z.    cd
+00009a90: 6566 206c 6f6e 675b 3a3a 315d 2069 6e64  ef long[::1] ind
+00009aa0: 5f6d 760a 2020 2020 6364 6566 2064 6f75  _mv.    cdef dou
+00009ab0: 626c 655b 325d 206c 696d 6974 735f 646c  ble[2] limits_dl
+00009ac0: 0a20 2020 2063 6465 6620 646f 7562 6c65  .    cdef double
+00009ad0: 5b31 5d20 7265 736f 5f72 302c 2072 6573  [1] reso_r0, res
+00009ae0: 6f5f 722c 2072 6573 6f5f 7a0a 2020 2020  o_r, reso_z.    
+00009af0: 6364 6566 2064 6f75 626c 655b 3a3a 315d  cdef double[::1]
+00009b00: 2064 765f 6d76 0a20 2020 2063 6465 6620   dv_mv.    cdef 
+00009b10: 646f 7562 6c65 5b3a 3a31 5d20 7265 736f  double[::1] reso
+00009b20: 5f70 6869 5f6d 760a 2020 2020 6364 6566  _phi_mv.    cdef
+00009b30: 2064 6f75 626c 655b 3a2c 203a 3a31 5d20   double[:, ::1] 
+00009b40: 706f 6c79 5f6d 760a 2020 2020 6364 6566  poly_mv.    cdef
+00009b50: 2064 6f75 626c 655b 3a2c 203a 3a31 5d20   double[:, ::1] 
+00009b60: 7074 735f 6d76 0a20 2020 2063 6465 6620  pts_mv.    cdef 
+00009b70: 6c6f 6e67 5b3a 2c20 3a3a 315d 2069 6e64  long[:, ::1] ind
+00009b80: 695f 6d76 0a20 2020 2063 6465 6620 6c6f  i_mv.    cdef lo
+00009b90: 6e67 5b3a 2c20 3a2c 203a 3a31 5d20 6c6e  ng[:, :, ::1] ln
+00009ba0: 700a 2020 2020 6364 6566 206c 6f6e 672a  p.    cdef long*
+00009bb0: 2020 6e63 656c 6c73 5f72 7068 6920 203d    ncells_rphi  =
+00009bc0: 204e 554c 4c0a 2020 2020 6364 6566 206c   NULL.    cdef l
+00009bd0: 6f6e 672a 2020 746f 745f 6e63 5f70 6c61  ong*  tot_nc_pla
+00009be0: 6e65 203d 204e 554c 4c0a 2020 2020 6364  ne = NULL.    cd
+00009bf0: 6566 206c 6f6e 672a 2020 6c69 6e64 6578  ef long*  lindex
+00009c00: 2020 203d 204e 554c 4c0a 2020 2020 6364     = NULL.    cd
+00009c10: 6566 206c 6f6e 672a 2020 6c69 6e64 6578  ef long*  lindex
+00009c20: 5f7a 203d 204e 554c 4c0a 2020 2020 6364  _z = NULL.    cd
+00009c30: 6566 206c 6f6e 672a 2020 737a 5f70 6869  ef long*  sz_phi
+00009c40: 203d 204e 554c 4c0a 2020 2020 6364 6566   = NULL.    cdef
+00009c50: 2064 6f75 626c 652a 2064 6973 635f 7230   double* disc_r0
+00009c60: 203d 204e 554c 4c0a 2020 2020 6364 6566   = NULL.    cdef
+00009c70: 2064 6f75 626c 652a 2064 6973 635f 7220   double* disc_r 
+00009c80: 203d 204e 554c 4c0a 2020 2020 6364 6566   = NULL.    cdef
+00009c90: 2064 6f75 626c 652a 2064 6973 635f 7a20   double* disc_z 
+00009ca0: 203d 204e 554c 4c0a 2020 2020 6364 6566   = NULL.    cdef
+00009cb0: 2064 6f75 626c 652a 2073 7465 705f 7270   double* step_rp
+00009cc0: 6869 203d 204e 554c 4c0a 2020 2020 6364  hi = NULL.    cd
+00009cd0: 6566 206c 6f6e 675b 3a3a 315d 2066 6972  ef long[::1] fir
+00009ce0: 7374 5f69 6e64 5f6d 760a 2020 2020 6364  st_ind_mv.    cd
+00009cf0: 6566 206e 702e 6e64 6172 7261 795b 6c6f  ef np.ndarray[lo
+00009d00: 6e67 2c20 6e64 696d 3d32 5d20 696e 6449  ng, ndim=2] indI
+00009d10: 0a20 2020 2063 6465 6620 6e70 2e6e 6461  .    cdef np.nda
+00009d20: 7272 6179 5b6c 6f6e 672c 206e 6469 6d3d  rray[long, ndim=
+00009d30: 315d 2069 6e64 0a20 2020 2063 6465 6620  1] ind.    cdef 
+00009d40: 6e70 2e6e 6461 7272 6179 5b64 6f75 626c  np.ndarray[doubl
+00009d50: 652c 6e64 696d 3d31 5d20 7265 736f 5f70  e,ndim=1] reso_p
+00009d60: 6869 0a20 2020 2063 6465 6620 6e70 2e6e  hi.    cdef np.n
+00009d70: 6461 7272 6179 5b64 6f75 626c 652c 6e64  darray[double,nd
+00009d80: 696d 3d32 5d20 7074 730a 2020 2020 6364  im=2] pts.    cd
+00009d90: 6566 206e 702e 6e64 6172 7261 795b 646f  ef np.ndarray[do
+00009da0: 7562 6c65 2c6e 6469 6d3d 315d 2072 6573  uble,ndim=1] res
+00009db0: 3364 0a20 2020 2023 0a20 2020 2023 2047  3d.    #.    # G
+00009dc0: 6574 2074 6865 2061 6374 7561 6c20 5220  et the actual R 
+00009dd0: 616e 6420 5a20 7265 736f 6c75 7469 6f6e  and Z resolution
+00009de0: 7320 616e 6420 6d65 7368 2065 6c65 6d65  s and mesh eleme
+00009df0: 6e74 730a 2020 2020 2320 2e2e 2046 6972  nts.    # .. Fir
+00009e00: 7374 2077 6520 6469 7363 7265 7469 7a65  st we discretize
+00009e10: 2052 2077 6974 686f 7574 206c 696d 6974   R without limit
+00009e20: 7320 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  s ..............
+00009e30: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00009e40: 2e2e 2e2e 0a20 2020 205f 7374 2e63 7974  .....    _st.cyt
+00009e50: 686f 6e69 7a65 5f73 7562 646f 6d61 696e  honize_subdomain
+00009e60: 5f64 6c28 4e6f 6e65 2c20 6c69 6d69 7473  _dl(None, limits
+00009e70: 5f64 6c29 2023 206e 6f20 6c69 6d69 7473  _dl) # no limits
+00009e80: 0a20 2020 205f 203d 205f 7374 2e64 6973  .    _ = _st.dis
+00009e90: 6372 6574 697a 655f 6c69 6e65 3164 5f63  cretize_line1d_c
+00009ea0: 6f72 6528 2652 4d69 6e4d 6178 5b30 5d2c  ore(&RMinMax[0],
+00009eb0: 2072 7374 6570 2c20 6c69 6d69 7473 5f64   rstep, limits_d
+00009ec0: 6c2c 0a20 2020 2020 2020 2020 2020 2020  l,.             
+00009ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009ee0: 2020 2020 2020 5472 7565 2c20 302c 2023        True, 0, #
+00009ef0: 2064 6973 6372 6574 697a 6520 696e 2061   discretize in a
+00009f00: 6273 6f6c 7574 6520 6d6f 6465 0a20 2020  bsolute mode.   
+00009f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009f30: 6d61 7267 696e 2c20 2664 6973 635f 7230  margin, &disc_r0
+00009f40: 2c20 7265 736f 5f72 302c 2026 6c69 6e64  , reso_r0, &lind
+00009f50: 6578 2c0a 2020 2020 2020 2020 2020 2020  ex,.            
+00009f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009f70: 2020 2020 2020 206e 6365 6c6c 735f 7230         ncells_r0
+00009f80: 290a 2020 2020 6672 6565 286c 696e 6465  ).    free(linde
+00009f90: 7829 2023 2067 6574 7469 6e67 2072 6964  x) # getting rid
+00009fa0: 206f 6620 7468 696e 6773 2077 6520 646f   of things we do
+00009fb0: 6e74 206e 6565 640a 2020 2020 6c69 6e64  nt need.    lind
+00009fc0: 6578 203d 204e 554c 4c0a 2020 2020 2320  ex = NULL.    # 
+00009fd0: 2e2e 204e 6f77 2074 6865 2061 6374 7561  .. Now the actua
+00009fe0: 6c20 5220 6c69 6d69 7465 6420 202e 2e2e  l R limited  ...
+00009ff0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+0000a000: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+0000a010: 2e2e 2e2e 2e2e 2e2e 2e2e 0a20 2020 205f  ...........    _
+0000a020: 7374 2e63 7974 686f 6e69 7a65 5f73 7562  st.cythonize_sub
+0000a030: 646f 6d61 696e 5f64 6c28 4452 2c20 6c69  domain_dl(DR, li
+0000a040: 6d69 7473 5f64 6c29 0a20 2020 2073 7a5f  mits_dl).    sz_
+0000a050: 7220 3d20 5f73 742e 6469 7363 7265 7469  r = _st.discreti
+0000a060: 7a65 5f6c 696e 6531 645f 636f 7265 2826  ze_line1d_core(&
+0000a070: 524d 696e 4d61 785b 305d 2c20 7273 7465  RMinMax[0], rste
+0000a080: 702c 206c 696d 6974 735f 646c 2c0a 2020  p, limits_dl,.  
+0000a090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a0b0: 2020 2020 5472 7565 2c20 302c 2023 2064      True, 0, # d
+0000a0c0: 6973 6372 6574 697a 6520 696e 2061 6273  iscretize in abs
+0000a0d0: 6f6c 7574 6520 6d6f 6465 0a20 2020 2020  olute mode.     
+0000a0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a100: 206d 6172 6769 6e2c 2026 6469 7363 5f72   margin, &disc_r
+0000a110: 2c20 7265 736f 5f72 2c20 266c 696e 6465  , reso_r, &linde
+0000a120: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
+0000a130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a140: 2020 2020 2020 2020 206e 6365 6c6c 735f           ncells_
+0000a150: 7229 0a20 2020 2066 7265 6528 6c69 6e64  r).    free(lind
+0000a160: 6578 2920 2320 6765 7474 696e 6720 7269  ex) # getting ri
+0000a170: 6420 6f66 2074 6869 6e67 7320 7765 2064  d of things we d
+0000a180: 6f6e 7420 6e65 6564 0a20 2020 2023 202e  ont need.    # .
+0000a190: 2e20 4e6f 7720 5a20 2e2e 2e2e 2e2e 2e2e  . Now Z ........
+0000a1a0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+0000a1b0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+0000a1c0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+0000a1d0: 2e2e 2e2e 2e2e 2e2e 2e0a 2020 2020 5f73  ..........    _s
+0000a1e0: 742e 6379 7468 6f6e 697a 655f 7375 6264  t.cythonize_subd
+0000a1f0: 6f6d 6169 6e5f 646c 2844 5a2c 206c 696d  omain_dl(DZ, lim
+0000a200: 6974 735f 646c 290a 2020 2020 737a 5f7a  its_dl).    sz_z
+0000a210: 203d 205f 7374 2e64 6973 6372 6574 697a   = _st.discretiz
+0000a220: 655f 6c69 6e65 3164 5f63 6f72 6528 265a  e_line1d_core(&Z
+0000a230: 4d69 6e4d 6178 5b30 5d2c 207a 7374 6570  MinMax[0], zstep
+0000a240: 2c20 6c69 6d69 7473 5f64 6c2c 0a20 2020  , limits_dl,.   
+0000a250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a270: 2020 2054 7275 652c 2030 2c20 2320 6469     True, 0, # di
+0000a280: 7363 7265 7469 7a65 2069 6e20 6162 736f  scretize in abso
+0000a290: 6c75 7465 206d 6f64 650a 2020 2020 2020  lute mode.      
+0000a2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a2c0: 6d61 7267 696e 2c20 2664 6973 635f 7a2c  margin, &disc_z,
+0000a2d0: 2072 6573 6f5f 7a2c 2026 6c69 6e64 6578   reso_z, &lindex
+0000a2e0: 5f7a 2c0a 2020 2020 2020 2020 2020 2020  _z,.            
+0000a2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a300: 2020 2020 2020 2020 2020 6e63 656c 6c73            ncells
+0000a310: 5f7a 290a 2020 2020 2320 2e2e 2050 7265  _z).    # .. Pre
+0000a320: 7061 7269 6e67 2066 6f72 2070 6869 3a20  paring for phi: 
+0000a330: 6765 7420 7468 6520 6c69 6d69 7473 2069  get the limits i
+0000a340: 6620 616e 7920 616e 6420 6d61 6b65 2073  f any and make s
+0000a350: 7572 6520 746f 2072 6570 6c61 6365 2074  ure to replace t
+0000a360: 6865 6d0a 2020 2020 2320 2e2e 2069 6e20  hem.    # .. in 
+0000a370: 7468 6520 7072 6f70 6572 2071 7561 6472  the proper quadr
+0000a380: 616e 7473 202e 2e2e 2e2e 2e2e 2e2e 2e2e  ants ...........
+0000a390: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+0000a3a0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+0000a3b0: 2e2e 2e2e 0a20 2020 2069 6620 4450 6869  .....    if DPhi
+0000a3c0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0000a3d0: 2020 6d69 6e5f 7068 6920 3d20 2d63 5f70    min_phi = -c_p
+0000a3e0: 690a 2020 2020 2020 2020 6d61 785f 7068  i.        max_ph
+0000a3f0: 6920 3d20 635f 7069 0a20 2020 2065 6c73  i = c_pi.    els
+0000a400: 653a 0a20 2020 2020 2020 206d 696e 5f70  e:.        min_p
+0000a410: 6869 203d 2044 5068 695b 305d 2023 2074  hi = DPhi[0] # t
+0000a420: 6f20 6176 6f69 6420 636f 6e76 6572 7369  o avoid conversi
+0000a430: 6f6e 730a 2020 2020 2020 2020 6d69 6e5f  ons.        min_
+0000a440: 7068 6920 3d20 635f 6174 616e 3228 635f  phi = c_atan2(c_
+0000a450: 7369 6e28 6d69 6e5f 7068 6929 2c20 635f  sin(min_phi), c_
+0000a460: 636f 7328 6d69 6e5f 7068 6929 290a 2020  cos(min_phi)).  
+0000a470: 2020 2020 2020 6d61 785f 7068 6920 3d20        max_phi = 
+0000a480: 4450 6869 5b31 5d20 2320 746f 2061 766f  DPhi[1] # to avo
+0000a490: 6964 2063 6f6e 7665 7273 696f 6e73 0a20  id conversions. 
+0000a4a0: 2020 2020 2020 206d 6178 5f70 6869 203d         max_phi =
+0000a4b0: 2063 5f61 7461 6e32 2863 5f73 696e 286d   c_atan2(c_sin(m
+0000a4c0: 6178 5f70 6869 292c 2063 5f63 6f73 286d  ax_phi), c_cos(m
+0000a4d0: 6178 5f70 6869 2929 0a20 2020 2023 202e  ax_phi)).    # .
+0000a4e0: 2e20 496e 6974 6961 6c69 7a61 7469 6f6e  . Initialization
+0000a4f0: 202e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e   ...............
+0000a500: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+0000a510: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+0000a520: 2e2e 2e2e 2e2e 2e2e 2e0a 2020 2020 737a  ..........    sz
+0000a530: 5f70 6869 203d 203c 6c6f 6e67 2a3e 6d61  _phi = <long*>ma
+0000a540: 6c6c 6f63 2873 7a5f 722a 7369 7a65 6f66  lloc(sz_r*sizeof
+0000a550: 286c 6f6e 6729 290a 2020 2020 746f 745f  (long)).    tot_
+0000a560: 6e63 5f70 6c61 6e65 203d 203c 6c6f 6e67  nc_plane = <long
+0000a570: 2a3e 6d61 6c6c 6f63 2873 7a5f 722a 7369  *>malloc(sz_r*si
+0000a580: 7a65 6f66 286c 6f6e 6729 290a 2020 2020  zeof(long)).    
+0000a590: 6e63 656c 6c73 5f72 7068 6920 203d 203c  ncells_rphi  = <
+0000a5a0: 6c6f 6e67 2a3e 6d61 6c6c 6f63 2873 7a5f  long*>malloc(sz_
+0000a5b0: 722a 7369 7a65 6f66 286c 6f6e 6729 290a  r*sizeof(long)).
+0000a5c0: 2020 2020 7374 6570 5f72 7068 6920 2020      step_rphi   
+0000a5d0: 203d 203c 646f 7562 6c65 2a3e 6d61 6c6c   = <double*>mall
+0000a5e0: 6f63 2873 7a5f 722a 7369 7a65 6f66 2864  oc(sz_r*sizeof(d
+0000a5f0: 6f75 626c 6529 290a 2020 2020 7265 736f  ouble)).    reso
+0000a600: 5f70 6869 203d 206e 702e 656d 7074 7928  _phi = np.empty(
+0000a610: 2873 7a5f 722c 2929 2023 2077 6520 6372  (sz_r,)) # we cr
+0000a620: 6561 7465 2074 6865 206e 756d 7079 2061  eate the numpy a
+0000a630: 7272 6179 0a20 2020 2072 6573 6f5f 7068  rray.    reso_ph
+0000a640: 695f 6d76 203d 2072 6573 6f5f 7068 6920  i_mv = reso_phi 
+0000a650: 2320 616e 6420 6974 7320 6173 736f 6369  # and its associ
+0000a660: 6174 6564 206d 656d 6f72 7976 6965 770a  ated memoryview.
+0000a670: 2020 2020 725f 7261 7469 6f20 3d20 3c69      r_ratio = <i
+0000a680: 6e74 3e28 635f 6365 696c 2864 6973 635f  nt>(c_ceil(disc_
+0000a690: 725b 737a 5f72 202d 2031 5d20 2f20 6469  r[sz_r - 1] / di
+0000a6a0: 7363 5f72 5b30 5d29 290a 2020 2020 7477  sc_r[0])).    tw
+0000a6b0: 6f70 695f 6f76 6572 5f64 7068 6920 3d20  opi_over_dphi = 
+0000a6c0: 5f54 574f 5049 202f 2070 6869 7374 6570  _TWOPI / phistep
+0000a6d0: 0a20 2020 2069 6e64 5f6c 6f63 5f72 3020  .    ind_loc_r0 
+0000a6e0: 3d20 300a 2020 2020 6e63 656c 6c73 5f72  = 0.    ncells_r
+0000a6f0: 7068 6930 203d 2030 0a20 2020 206d 696e  phi0 = 0.    min
+0000a700: 5f70 6869 5f70 6920 3d20 6d69 6e5f 7068  _phi_pi = min_ph
+0000a710: 6920 2b20 635f 7069 0a20 2020 206d 6178  i + c_pi.    max
+0000a720: 5f70 6869 5f70 6920 3d20 6d61 785f 7068  _phi_pi = max_ph
+0000a730: 6920 2b20 635f 7069 0a20 2020 2061 6273  i + c_pi.    abs
+0000a740: 3020 3d20 635f 6162 7328 6d69 6e5f 7068  0 = c_abs(min_ph
+0000a750: 695f 7069 290a 2020 2020 6162 7331 203d  i_pi).    abs1 =
+0000a760: 2063 5f61 6273 286d 6178 5f70 6869 5f70   c_abs(max_phi_p
+0000a770: 6929 0a20 2020 2023 202e 2e2e 2064 6f69  i).    # ... doi
+0000a780: 6e67 2030 206c 6f6f 7020 6265 666f 7265  ng 0 loop before
+0000a790: 0a20 2020 2069 6620 6d69 6e5f 7068 6920  .    if min_phi 
+0000a7a0: 3c20 6d61 785f 7068 693a 0a20 2020 2020  < max_phi:.     
+0000a7b0: 2020 2023 2047 6574 2074 6865 2061 6374     # Get the act
+0000a7c0: 7561 6c20 5250 6869 2072 6573 6f6c 7574  ual RPhi resolut
+0000a7d0: 696f 6e20 616e 6420 5068 6920 6d65 7368  ion and Phi mesh
+0000a7e0: 2065 6c65 6d65 6e74 7320 2821 2064 6570   elements (! dep
+0000a7f0: 656e 6473 206f 6e20 5221 290a 2020 2020  ends on R!).    
+0000a800: 2020 2020 6e63 656c 6c73 5f72 7068 695b      ncells_rphi[
+0000a810: 305d 203d 203c 696e 743e 635f 6365 696c  0] = <int>c_ceil
+0000a820: 2874 776f 7069 5f6f 7665 725f 6470 6869  (twopi_over_dphi
+0000a830: 202a 2064 6973 635f 725b 305d 290a 2020   * disc_r[0]).  
+0000a840: 2020 2020 2020 6c6f 635f 6e63 5f72 7068        loc_nc_rph
+0000a850: 6920 3d20 6e63 656c 6c73 5f72 7068 695b  i = ncells_rphi[
+0000a860: 305d 0a20 2020 2020 2020 2073 7465 705f  0].        step_
+0000a870: 7270 6869 5b30 5d20 3d20 5f54 574f 5049  rphi[0] = _TWOPI
+0000a880: 202f 206e 6365 6c6c 735f 7270 6869 5b30   / ncells_rphi[0
+0000a890: 5d0a 2020 2020 2020 2020 696e 765f 6472  ].        inv_dr
+0000a8a0: 7068 6920 3d20 312e 202f 2073 7465 705f  phi = 1. / step_
+0000a8b0: 7270 6869 5b30 5d0a 2020 2020 2020 2020  rphi[0].        
+0000a8c0: 7265 736f 5f70 6869 5f6d 765b 305d 203d  reso_phi_mv[0] =
+0000a8d0: 2073 7465 705f 7270 6869 5b30 5d20 2a20   step_rphi[0] * 
+0000a8e0: 6469 7363 5f72 5b30 5d0a 2020 2020 2020  disc_r[0].      
+0000a8f0: 2020 746f 745f 6e63 5f70 6c61 6e65 5b30    tot_nc_plane[0
+0000a900: 5d20 3d20 3020 2320 696e 6974 6961 6c69  ] = 0 # initiali
+0000a910: 7a61 7469 6f6e 0a20 2020 2020 2020 2023  zation.        #
+0000a920: 2047 6574 2069 6e64 6578 2061 6e64 2063   Get index and c
+0000a930: 756d 756c 6174 6564 2069 6e64 6963 6573  umulated indices
+0000a940: 2066 726f 6d20 6261 636b 6772 6f75 6e64   from background
+0000a950: 0a20 2020 2020 2020 2066 6f72 206a 6a20  .        for jj 
+0000a960: 696e 2072 616e 6765 2869 6e64 5f6c 6f63  in range(ind_loc
+0000a970: 5f72 302c 206e 6365 6c6c 735f 7230 5b30  _r0, ncells_r0[0
+0000a980: 5d29 3a0a 2020 2020 2020 2020 2020 2020  ]):.            
+0000a990: 6966 2064 6973 635f 7230 5b6a 6a5d 3d3d  if disc_r0[jj]==
+0000a9a0: 6469 7363 5f72 5b30 5d3a 0a20 2020 2020  disc_r[0]:.     
+0000a9b0: 2020 2020 2020 2020 2020 2069 6e64 5f6c             ind_l
+0000a9c0: 6f63 5f72 3020 3d20 6a6a 0a20 2020 2020  oc_r0 = jj.     
+0000a9d0: 2020 2020 2020 2020 2020 2062 7265 616b             break
+0000a9e0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+0000a9f0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0000aa00: 2020 206e 6365 6c6c 735f 7270 6869 3020     ncells_rphi0 
+0000aa10: 2b3d 203c 6c6f 6e67 3e63 5f63 6569 6c28  += <long>c_ceil(
+0000aa20: 7477 6f70 695f 6f76 6572 5f64 7068 6920  twopi_over_dphi 
+0000aa30: 2a20 6469 7363 5f72 305b 6a6a 5d29 0a20  * disc_r0[jj]). 
+0000aa40: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0000aa50: 6f74 5f6e 635f 706c 616e 655b 305d 203d  ot_nc_plane[0] =
+0000aa60: 206e 6365 6c6c 735f 7270 6869 3020 2a20   ncells_rphi0 * 
+0000aa70: 6e63 656c 6c73 5f7a 5b30 5d0a 2020 2020  ncells_z[0].    
+0000aa80: 2020 2020 2320 4765 7420 696e 6469 6365      # Get indice
+0000aa90: 7320 6f66 2070 6869 0a20 2020 2020 2020  s of phi.       
+0000aaa0: 2023 2047 6574 2074 6865 2065 7874 7265   # Get the extre
+0000aab0: 6d65 2069 6e64 6963 6573 206f 6620 7468  me indices of th
+0000aac0: 6520 6d65 7368 2065 6c65 6d65 6e74 7320  e mesh elements 
+0000aad0: 7468 6174 2072 6561 6c6c 7920 6e65 6564  that really need
+0000aae0: 2074 6f0a 2020 2020 2020 2020 2320 6265   to.        # be
+0000aaf0: 2063 7265 6174 6564 2077 6974 6869 6e20   created within 
+0000ab00: 7468 6f73 6520 6c69 6d69 7473 0a20 2020  those limits.   
+0000ab10: 2020 2020 2069 6620 6162 7330 202d 2073       if abs0 - s
+0000ab20: 7465 705f 7270 6869 5b30 5d2a 635f 666c  tep_rphi[0]*c_fl
+0000ab30: 6f6f 7228 6162 7330 202a 2069 6e76 5f64  oor(abs0 * inv_d
+0000ab40: 7270 6869 2920 3c20 6d61 7267 696e 2a73  rphi) < margin*s
+0000ab50: 7465 705f 7270 6869 5b30 5d3a 0a20 2020  tep_rphi[0]:.   
+0000ab60: 2020 2020 2020 2020 206e 7068 6930 203d           nphi0 =
+0000ab70: 2069 6e74 2863 5f72 6f75 6e64 2828 6d69   int(c_round((mi
+0000ab80: 6e5f 7068 6920 2b20 635f 7069 2920 2a20  n_phi + c_pi) * 
+0000ab90: 696e 765f 6472 7068 6929 290a 2020 2020  inv_drphi)).    
+0000aba0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0000abb0: 2020 2020 2020 6e70 6869 3020 3d20 696e        nphi0 = in
+0000abc0: 7428 635f 666c 6f6f 7228 286d 696e 5f70  t(c_floor((min_p
+0000abd0: 6869 202b 635f 7069 2920 2a20 696e 765f  hi +c_pi) * inv_
+0000abe0: 6472 7068 6929 290a 2020 2020 2020 2020  drphi)).        
+0000abf0: 6966 2061 6273 312d 7374 6570 5f72 7068  if abs1-step_rph
+0000ac00: 695b 305d 2a63 5f66 6c6f 6f72 2861 6273  i[0]*c_floor(abs
+0000ac10: 3120 2a20 696e 765f 6472 7068 6929 203c  1 * inv_drphi) <
+0000ac20: 206d 6172 6769 6e2a 7374 6570 5f72 7068   margin*step_rph
+0000ac30: 695b 305d 3a0a 2020 2020 2020 2020 2020  i[0]:.          
+0000ac40: 2020 6e70 6869 3120 3d20 696e 7428 635f    nphi1 = int(c_
+0000ac50: 726f 756e 6428 286d 6178 5f70 6869 2b63  round((max_phi+c
+0000ac60: 5f70 6929 202a 2069 6e76 5f64 7270 6869  _pi) * inv_drphi
+0000ac70: 292d 3129 0a20 2020 2020 2020 2065 6c73  )-1).        els
+0000ac80: 653a 0a20 2020 2020 2020 2020 2020 206e  e:.            n
+0000ac90: 7068 6931 203d 2069 6e74 2863 5f66 6c6f  phi1 = int(c_flo
+0000aca0: 6f72 2828 6d61 785f 7068 692b 635f 7069  or((max_phi+c_pi
+0000acb0: 2920 2a20 696e 765f 6472 7068 6929 290a  ) * inv_drphi)).
+0000acc0: 2020 2020 2020 2020 737a 5f70 6869 5b30          sz_phi[0
+0000acd0: 5d20 3d20 6e70 6869 3120 2b20 3120 2d20  ] = nphi1 + 1 - 
+0000ace0: 6e70 6869 300a 2020 2020 2020 2020 6d61  nphi0.        ma
+0000acf0: 785f 737a 5f70 6869 5b30 5d20 3d20 737a  x_sz_phi[0] = sz
+0000ad00: 5f70 6869 5b30 5d0a 2020 2020 2020 2020  _phi[0].        
+0000ad10: 696e 6449 203d 202d 6e70 2e6f 6e65 7328  indI = -np.ones(
+0000ad20: 2873 7a5f 722c 2073 7a5f 7068 695b 305d  (sz_r, sz_phi[0]
+0000ad30: 202a 2072 5f72 6174 696f 202b 2031 292c   * r_ratio + 1),
+0000ad40: 2064 7479 7065 3d69 6e74 290a 2020 2020   dtype=int).    
+0000ad50: 2020 2020 696e 6469 5f6d 7620 3d20 696e      indi_mv = in
+0000ad60: 6449 0a20 2020 2020 2020 2066 6f72 206a  dI.        for j
+0000ad70: 6a20 696e 2072 616e 6765 2873 7a5f 7068  j in range(sz_ph
+0000ad80: 695b 305d 293a 0a20 2020 2020 2020 2020  i[0]):.         
+0000ad90: 2020 2069 6e64 695f 6d76 5b30 2c20 6a6a     indi_mv[0, jj
+0000ada0: 5d20 3d20 6e70 6869 3020 2b20 6a6a 0a20  ] = nphi0 + jj. 
+0000adb0: 2020 2020 2020 206e 7074 735f 6469 7363         npts_disc
+0000adc0: 202b 3d20 737a 5f7a 202a 2073 7a5f 7068   += sz_z * sz_ph
+0000add0: 695b 305d 0a20 2020 2065 6c73 653a 0a20  i[0].    else:. 
+0000ade0: 2020 2020 2020 2023 2047 6574 2074 6865         # Get the
+0000adf0: 2061 6374 7561 6c20 5250 6869 2072 6573   actual RPhi res
+0000ae00: 6f6c 7574 696f 6e20 616e 6420 5068 6920  olution and Phi 
+0000ae10: 6d65 7368 2065 6c65 6d65 6e74 7320 2821  mesh elements (!
+0000ae20: 2064 6570 656e 6473 206f 6e20 5221 290a   depends on R!).
+0000ae30: 2020 2020 2020 2020 6e63 656c 6c73 5f72          ncells_r
+0000ae40: 7068 695b 305d 203d 203c 696e 743e 635f  phi[0] = <int>c_
+0000ae50: 6365 696c 2874 776f 7069 5f6f 7665 725f  ceil(twopi_over_
+0000ae60: 6470 6869 202a 2064 6973 635f 725b 305d  dphi * disc_r[0]
+0000ae70: 290a 2020 2020 2020 2020 6c6f 635f 6e63  ).        loc_nc
+0000ae80: 5f72 7068 6920 3d20 6e63 656c 6c73 5f72  _rphi = ncells_r
+0000ae90: 7068 695b 305d 0a20 2020 2020 2020 2073  phi[0].        s
+0000aea0: 7465 705f 7270 6869 5b30 5d20 3d20 5f54  tep_rphi[0] = _T
+0000aeb0: 574f 5049 202f 206e 6365 6c6c 735f 7270  WOPI / ncells_rp
+0000aec0: 6869 5b30 5d0a 2020 2020 2020 2020 696e  hi[0].        in
+0000aed0: 765f 6472 7068 6920 3d20 312e 202f 2073  v_drphi = 1. / s
+0000aee0: 7465 705f 7270 6869 5b30 5d0a 2020 2020  tep_rphi[0].    
+0000aef0: 2020 2020 7265 736f 5f70 6869 5f6d 765b      reso_phi_mv[
+0000af00: 305d 203d 2073 7465 705f 7270 6869 5b30  0] = step_rphi[0
+0000af10: 5d20 2a20 6469 7363 5f72 5b30 5d0a 2020  ] * disc_r[0].  
+0000af20: 2020 2020 2020 746f 745f 6e63 5f70 6c61        tot_nc_pla
+0000af30: 6e65 5b30 5d20 3d20 3020 2320 696e 6974  ne[0] = 0 # init
+0000af40: 6961 6c69 7a61 7469 6f6e 0a20 2020 2020  ialization.     
+0000af50: 2020 2023 2047 6574 2069 6e64 6578 2061     # Get index a
+0000af60: 6e64 2063 756d 756c 6174 6564 2069 6e64  nd cumulated ind
+0000af70: 6963 6573 2066 726f 6d20 6261 636b 6772  ices from backgr
+0000af80: 6f75 6e64 0a20 2020 2020 2020 2066 6f72  ound.        for
+0000af90: 206a 6a20 696e 2072 616e 6765 2869 6e64   jj in range(ind
+0000afa0: 5f6c 6f63 5f72 302c 206e 6365 6c6c 735f  _loc_r0, ncells_
+0000afb0: 7230 5b30 5d29 3a0a 2020 2020 2020 2020  r0[0]):.        
+0000afc0: 2020 2020 6966 2064 6973 635f 7230 5b6a      if disc_r0[j
+0000afd0: 6a5d 3d3d 6469 7363 5f72 5b30 5d3a 0a20  j]==disc_r[0]:. 
+0000afe0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000aff0: 6e64 5f6c 6f63 5f72 3020 3d20 6a6a 0a20  nd_loc_r0 = jj. 
+0000b000: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+0000b010: 7265 616b 0a20 2020 2020 2020 2020 2020  reak.           
+0000b020: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0000b030: 2020 2020 2020 206e 6365 6c6c 735f 7270         ncells_rp
+0000b040: 6869 3020 2b3d 203c 6c6f 6e67 3e63 5f63  hi0 += <long>c_c
+0000b050: 6569 6c28 7477 6f70 695f 6f76 6572 5f64  eil(twopi_over_d
+0000b060: 7068 6920 2a20 6469 7363 5f72 305b 6a6a  phi * disc_r0[jj
+0000b070: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
+0000b080: 2020 2074 6f74 5f6e 635f 706c 616e 655b     tot_nc_plane[
+0000b090: 305d 203d 206e 6365 6c6c 735f 7270 6869  0] = ncells_rphi
+0000b0a0: 3020 2a20 6e63 656c 6c73 5f7a 5b30 5d0a  0 * ncells_z[0].
+0000b0b0: 2020 2020 2020 2020 2320 4765 7420 696e          # Get in
+0000b0c0: 6469 6365 7320 6f66 2070 6869 0a20 2020  dices of phi.   
+0000b0d0: 2020 2020 2023 2047 6574 2074 6865 2065       # Get the e
+0000b0e0: 7874 7265 6d65 2069 6e64 6963 6573 206f  xtreme indices o
+0000b0f0: 6620 7468 6520 6d65 7368 2065 6c65 6d65  f the mesh eleme
+0000b100: 6e74 7320 7468 6174 2072 6561 6c6c 7920  nts that really 
+0000b110: 6e65 6564 2074 6f0a 2020 2020 2020 2020  need to.        
+0000b120: 2320 6265 2063 7265 6174 6564 2077 6974  # be created wit
+0000b130: 6869 6e20 7468 6f73 6520 6c69 6d69 7473  hin those limits
+0000b140: 0a20 2020 2020 2020 2069 6620 6162 7330  .        if abs0
+0000b150: 202d 2073 7465 705f 7270 6869 5b30 5d2a   - step_rphi[0]*
+0000b160: 635f 666c 6f6f 7228 6162 7330 202a 2069  c_floor(abs0 * i
+0000b170: 6e76 5f64 7270 6869 2920 3c20 6d61 7267  nv_drphi) < marg
+0000b180: 696e 2a73 7465 705f 7270 6869 5b30 5d3a  in*step_rphi[0]:
+0000b190: 0a20 2020 2020 2020 2020 2020 206e 7068  .            nph
+0000b1a0: 6930 203d 2069 6e74 2863 5f72 6f75 6e64  i0 = int(c_round
+0000b1b0: 2828 6d69 6e5f 7068 6920 2b20 635f 7069  ((min_phi + c_pi
+0000b1c0: 2920 2a20 696e 765f 6472 7068 6929 290a  ) * inv_drphi)).
+0000b1d0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0000b1e0: 2020 2020 2020 2020 2020 6e70 6869 3020            nphi0 
+0000b1f0: 3d20 696e 7428 635f 666c 6f6f 7228 286d  = int(c_floor((m
+0000b200: 696e 5f70 6869 202b 2063 5f70 6929 202a  in_phi + c_pi) *
+0000b210: 2069 6e76 5f64 7270 6869 2929 0a20 2020   inv_drphi)).   
+0000b220: 2020 2020 2069 6620 6162 7331 2d73 7465       if abs1-ste
+0000b230: 705f 7270 6869 5b30 5d2a 635f 666c 6f6f  p_rphi[0]*c_floo
+0000b240: 7228 6162 7331 202a 2069 6e76 5f64 7270  r(abs1 * inv_drp
+0000b250: 6869 2920 3c20 6d61 7267 696e 2a73 7465  hi) < margin*ste
+0000b260: 705f 7270 6869 5b30 5d3a 0a20 2020 2020  p_rphi[0]:.     
+0000b270: 2020 2020 2020 206e 7068 6931 203d 2069         nphi1 = i
+0000b280: 6e74 2863 5f72 6f75 6e64 2828 6d61 785f  nt(c_round((max_
+0000b290: 7068 692b 635f 7069 2920 2a20 696e 765f  phi+c_pi) * inv_
+0000b2a0: 6472 7068 6929 2d31 290a 2020 2020 2020  drphi)-1).      
+0000b2b0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0000b2c0: 2020 2020 6e70 6869 3120 3d20 696e 7428      nphi1 = int(
+0000b2d0: 635f 666c 6f6f 7228 286d 6178 5f70 6869  c_floor((max_phi
+0000b2e0: 2b63 5f70 6929 202a 2069 6e76 5f64 7270  +c_pi) * inv_drp
+0000b2f0: 6869 2929 0a20 2020 2020 2020 2073 7a5f  hi)).        sz_
+0000b300: 7068 695b 305d 203d 206e 7068 6931 2b31  phi[0] = nphi1+1
+0000b310: 2b6c 6f63 5f6e 635f 7270 6869 2d6e 7068  +loc_nc_rphi-nph
+0000b320: 6930 0a20 2020 2020 2020 206d 6178 5f73  i0.        max_s
+0000b330: 7a5f 7068 695b 305d 203d 2073 7a5f 7068  z_phi[0] = sz_ph
+0000b340: 695b 305d 0a20 2020 2020 2020 2069 6e64  i[0].        ind
+0000b350: 4920 3d20 2d6e 702e 6f6e 6573 2828 737a  I = -np.ones((sz
+0000b360: 5f72 2c20 737a 5f70 6869 5b30 5d20 2a20  _r, sz_phi[0] * 
+0000b370: 725f 7261 7469 6f20 2b20 3129 2c20 6474  r_ratio + 1), dt
+0000b380: 7970 653d 696e 7429 0a20 2020 2020 2020  ype=int).       
+0000b390: 2069 6e64 695f 6d76 203d 2069 6e64 490a   indi_mv = indI.
+0000b3a0: 2020 2020 2020 2020 666f 7220 6a6a 2069          for jj i
+0000b3b0: 6e20 7261 6e67 6528 6c6f 635f 6e63 5f72  n range(loc_nc_r
+0000b3c0: 7068 6920 2d20 6e70 6869 3029 3a0a 2020  phi - nphi0):.  
+0000b3d0: 2020 2020 2020 2020 2020 696e 6469 5f6d            indi_m
+0000b3e0: 765b 302c 206a 6a5d 203d 206e 7068 6930  v[0, jj] = nphi0
+0000b3f0: 202b 206a 6a0a 2020 2020 2020 2020 666f   + jj.        fo
+0000b400: 7220 6a6a 2069 6e20 7261 6e67 6528 6c6f  r jj in range(lo
+0000b410: 635f 6e63 5f72 7068 6920 2d20 6e70 6869  c_nc_rphi - nphi
+0000b420: 302c 2073 7a5f 7068 695b 305d 293a 0a20  0, sz_phi[0]):. 
+0000b430: 2020 2020 2020 2020 2020 2069 6e64 695f             indi_
+0000b440: 6d76 5b30 2c20 6a6a 5d20 3d20 6a6a 202d  mv[0, jj] = jj -
+0000b450: 2028 6c6f 635f 6e63 5f72 7068 6920 2d20   (loc_nc_rphi - 
+0000b460: 6e70 6869 3029 0a20 2020 2020 2020 206e  nphi0).        n
+0000b470: 7074 735f 6469 7363 202b 3d20 737a 5f7a  pts_disc += sz_z
+0000b480: 202a 2073 7a5f 7068 695b 305d 0a20 2020   * sz_phi[0].   
+0000b490: 2023 202e 2e2e 2064 6f69 6e67 2074 6865   # ... doing the
+0000b4a0: 206f 7468 6572 7320 2e2e 2e2e 2e2e 2e2e   others ........
+0000b4b0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+0000b4c0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+0000b4d0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e0a 2020  ..............  
+0000b4e0: 2020 6e70 7473 5f64 6973 6320 2b3d 205f    npts_disc += _
+0000b4f0: 7374 2e76 6d65 7368 5f64 6973 635f 7068  st.vmesh_disc_ph
+0000b500: 6928 737a 5f72 2c20 737a 5f7a 2c20 6e63  i(sz_r, sz_z, nc
+0000b510: 656c 6c73 5f72 7068 692c 2070 6869 7374  ells_rphi, phist
+0000b520: 6570 2c0a 2020 2020 2020 2020 2020 2020  ep,.            
+0000b530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b540: 206e 6365 6c6c 735f 7270 6869 302c 0a20   ncells_rphi0,. 
+0000b550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b560: 2020 2020 2020 2020 2020 2020 6469 7363              disc
+0000b570: 5f72 2c20 6469 7363 5f72 302c 2073 7465  _r, disc_r0, ste
+0000b580: 705f 7270 6869 2c0a 2020 2020 2020 2020  p_rphi,.        
+0000b590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b5a0: 2020 2020 2072 6573 6f5f 7068 695f 6d76       reso_phi_mv
+0000b5b0: 2c20 746f 745f 6e63 5f70 6c61 6e65 2c20  , tot_nc_plane, 
+0000b5c0: 696e 645f 6c6f 635f 7230 2c0a 2020 2020  ind_loc_r0,.    
+0000b5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b5e0: 2020 2020 2020 2020 206e 6365 6c6c 735f           ncells_
+0000b5f0: 7230 5b30 5d2c 206e 6365 6c6c 735f 7a5b  r0[0], ncells_z[
+0000b600: 305d 2c20 266d 6178 5f73 7a5f 7068 695b  0], &max_sz_phi[
+0000b610: 305d 2c0a 2020 2020 2020 2020 2020 2020  0],.            
+0000b620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b630: 206d 696e 5f70 6869 2c20 6d61 785f 7068   min_phi, max_ph
+0000b640: 692c 2073 7a5f 7068 692c 2069 6e64 695f  i, sz_phi, indi_
+0000b650: 6d76 2c0a 2020 2020 2020 2020 2020 2020  mv,.            
+0000b660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b670: 206d 6172 6769 6e2c 206e 756d 5f74 6872   margin, num_thr
+0000b680: 6561 6473 290a 2020 2020 2320 2e2e 2e20  eads).    # ... 
+0000b690: 7669 676e 6574 7469 6e67 202e 2e2e 2e2e  vignetting .....
+0000b6a0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+0000b6b0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+0000b6c0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+0000b6d0: 2e2e 2e2e 2e2e 0a20 2020 2069 735f 696e  .......    is_in
+0000b6e0: 5f76 6967 6e65 7474 6520 3d20 6e70 2e6f  _vignette = np.o
+0000b6f0: 6e65 7328 2873 7a5f 722c 2073 7a5f 7a29  nes((sz_r, sz_z)
+0000b700: 2c20 6474 7970 653d 696e 7429 2023 2062  , dtype=int) # b
+0000b710: 7920 6465 6661 756c 7420 7965 730a 0a20  y default yes.. 
+0000b720: 2020 2069 6620 6c69 6d69 745f 7670 6f6c     if limit_vpol
+0000b730: 7920 6973 206e 6f74 204e 6f6e 653a 0a20  y is not None:. 
+0000b740: 2020 2020 2020 206e 7074 735f 7670 6f6c         npts_vpol
+0000b750: 7920 3d20 6c69 6d69 745f 7670 6f6c 792e  y = limit_vpoly.
+0000b760: 7368 6170 655b 315d 202d 2031 0a0a 2020  shape[1] - 1..  
+0000b770: 2020 2020 2020 2320 7765 206d 616b 6520        # we make 
+0000b780: 7375 7265 2069 7420 6973 2063 6c6f 7365  sure it is close
+0000b790: 640a 2020 2020 2020 2020 6966 206e 6f74  d.        if not
+0000b7a0: 2861 6273 286c 696d 6974 5f76 706f 6c79  (abs(limit_vpoly
+0000b7b0: 5b30 2c20 305d 202d 206c 696d 6974 5f76  [0, 0] - limit_v
+0000b7c0: 706f 6c79 5b30 2c20 6e70 7473 5f76 706f  poly[0, npts_vpo
+0000b7d0: 6c79 5d29 203c 205f 5653 4d41 4c4c 0a20  ly]) < _VSMALL. 
+0000b7e0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0000b7f0: 6e64 2061 6273 286c 696d 6974 5f76 706f  nd abs(limit_vpo
+0000b800: 6c79 5b31 2c20 305d 0a20 2020 2020 2020  ly[1, 0].       
+0000b810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b820: 202d 206c 696d 6974 5f76 706f 6c79 5b31   - limit_vpoly[1
+0000b830: 2c20 6e70 7473 5f76 706f 6c79 5d29 203c  , npts_vpoly]) <
+0000b840: 205f 5653 4d41 4c4c 293a 0a20 2020 2020   _VSMALL):.     
+0000b850: 2020 2020 2020 2070 6f6c 795f 6d76 203d         poly_mv =
+0000b860: 206e 702e 636f 6e63 6174 656e 6174 6528   np.concatenate(
+0000b870: 286c 696d 6974 5f76 706f 6c79 2c20 6c69  (limit_vpoly, li
+0000b880: 6d69 745f 7670 6f6c 795b 3a2c 2030 3a31  mit_vpoly[:, 0:1
+0000b890: 5d29 2c20 6178 6973 3d31 290a 2020 2020  ]), axis=1).    
+0000b8a0: 2020 2020 2020 2020 6e70 7473 5f76 706f          npts_vpo
+0000b8b0: 6c79 202b 3d20 310a 2020 2020 2020 2020  ly += 1.        
+0000b8c0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0000b8d0: 2020 706f 6c79 5f6d 7620 3d20 6c69 6d69    poly_mv = limi
+0000b8e0: 745f 7670 6f6c 790a 0a20 2020 2020 2020  t_vpoly..       
+0000b8f0: 205f 203d 205f 7674 2e61 7265 5f69 6e5f   _ = _vt.are_in_
+0000b900: 7669 676e 6574 7465 2873 7a5f 722c 2073  vignette(sz_r, s
+0000b910: 7a5f 7a2c 0a20 2020 2020 2020 2020 2020  z_z,.           
 0000b920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b930: 2020 2020 2020 2020 2020 2064 6973 635f             disc_
-0000b940: 722c 2064 6973 635f 7a2c 0a20 2020 2020  r, disc_z,.     
+0000b930: 2020 2020 2070 6f6c 795f 6d76 2c20 6e70       poly_mv, np
+0000b940: 7473 5f76 706f 6c79 2c0a 2020 2020 2020  ts_vpoly,.      
 0000b950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b960: 2020 2020 2020 2020 2020 2069 735f 696e             is_in
-0000b970: 5f76 6967 6e65 7474 6529 0a0a 2020 2020  _vignette)..    
-0000b980: 2320 5072 6570 6172 696e 6720 616e 2061  # Preparing an a
-0000b990: 7272 6179 206f 6620 696e 6469 6365 7320  rray of indices 
-0000b9a0: 746f 2061 7373 6f63 6961 7465 2028 722c  to associate (r,
-0000b9b0: 207a 2c20 7068 6929 203d 3e20 6e70 7473   z, phi) => npts
-0000b9c0: 5f64 6973 630a 2020 2020 6c6e 7020 3d20  _disc.    lnp = 
-0000b9d0: 6e70 2e65 6d70 7479 2828 737a 5f72 2c20  np.empty((sz_r, 
-0000b9e0: 737a 5f7a 2c20 6d61 785f 737a 5f70 6869  sz_z, max_sz_phi
-0000b9f0: 5b30 5d29 2c20 6474 7970 653d 696e 7429  [0]), dtype=int)
-0000ba00: 0a20 2020 206e 6577 5f6e 7020 3d20 5f73  .    new_np = _s
-0000ba10: 742e 766d 6573 685f 6765 745f 696e 6465  t.vmesh_get_inde
-0000ba20: 785f 6172 7261 7973 286c 6e70 2c20 6973  x_arrays(lnp, is
-0000ba30: 5f69 6e5f 7669 676e 6574 7465 2c0a 2020  _in_vignette,.  
-0000ba40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ba50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ba60: 2020 2020 2020 737a 5f72 2c20 737a 5f7a        sz_r, sz_z
-0000ba70: 2c20 737a 5f70 6869 290a 2020 2020 6966  , sz_phi).    if
-0000ba80: 206c 696d 6974 5f76 706f 6c79 203d 3d20   limit_vpoly == 
-0000ba90: 4e6f 6e65 3a0a 2020 2020 2020 2020 6173  None:.        as
-0000baa0: 7365 7274 206e 7074 735f 6469 7363 203d  sert npts_disc =
-0000bab0: 3d20 6e65 775f 6e70 2c20 6622 4e6f 206d  = new_np, f"No m
-0000bac0: 6174 6368 696e 6720 7b6e 7074 735f 6469  atching {npts_di
-0000bad0: 7363 7d20 7673 207b 6e65 775f 6e70 7d22  sc} vs {new_np}"
-0000bae0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-0000baf0: 2020 206e 7074 735f 6469 7363 203d 206e     npts_disc = n
-0000bb00: 6577 5f6e 700a 0a20 2020 2070 7473 203d  ew_np..    pts =
-0000bb10: 206e 702e 656d 7074 7928 2833 2c6e 7074   np.empty((3,npt
-0000bb20: 735f 6469 7363 2929 0a20 2020 2069 6e64  s_disc)).    ind
-0000bb30: 203d 206e 702e 656d 7074 7928 286e 7074   = np.empty((npt
-0000bb40: 735f 6469 7363 2c29 2c20 6474 7970 653d  s_disc,), dtype=
-0000bb50: 696e 7429 0a20 2020 2072 6573 3364 2020  int).    res3d  
+0000b960: 2020 2020 2020 2020 2020 6469 7363 5f72            disc_r
+0000b970: 2c20 6469 7363 5f7a 2c0a 2020 2020 2020  , disc_z,.      
+0000b980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b990: 2020 2020 2020 2020 2020 6973 5f69 6e5f            is_in_
+0000b9a0: 7669 676e 6574 7465 290a 0a20 2020 2023  vignette)..    #
+0000b9b0: 2050 7265 7061 7269 6e67 2061 6e20 6172   Preparing an ar
+0000b9c0: 7261 7920 6f66 2069 6e64 6963 6573 2074  ray of indices t
+0000b9d0: 6f20 6173 736f 6369 6174 6520 2872 2c20  o associate (r, 
+0000b9e0: 7a2c 2070 6869 2920 3d3e 206e 7074 735f  z, phi) => npts_
+0000b9f0: 6469 7363 0a20 2020 206c 6e70 203d 206e  disc.    lnp = n
+0000ba00: 702e 656d 7074 7928 2873 7a5f 722c 2073  p.empty((sz_r, s
+0000ba10: 7a5f 7a2c 206d 6178 5f73 7a5f 7068 695b  z_z, max_sz_phi[
+0000ba20: 305d 292c 2064 7479 7065 3d69 6e74 290a  0]), dtype=int).
+0000ba30: 2020 2020 6e65 775f 6e70 203d 205f 7374      new_np = _st
+0000ba40: 2e76 6d65 7368 5f67 6574 5f69 6e64 6578  .vmesh_get_index
+0000ba50: 5f61 7272 6179 7328 6c6e 702c 2069 735f  _arrays(lnp, is_
+0000ba60: 696e 5f76 6967 6e65 7474 652c 0a20 2020  in_vignette,.   
+0000ba70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ba80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ba90: 2020 2020 2073 7a5f 722c 2073 7a5f 7a2c       sz_r, sz_z,
+0000baa0: 2073 7a5f 7068 6929 0a20 2020 2069 6620   sz_phi).    if 
+0000bab0: 6c69 6d69 745f 7670 6f6c 7920 3d3d 204e  limit_vpoly == N
+0000bac0: 6f6e 653a 0a20 2020 2020 2020 2061 7373  one:.        ass
+0000bad0: 6572 7420 6e70 7473 5f64 6973 6320 3d3d  ert npts_disc ==
+0000bae0: 206e 6577 5f6e 702c 2066 224e 6f20 6d61   new_np, f"No ma
+0000baf0: 7463 6869 6e67 207b 6e70 7473 5f64 6973  tching {npts_dis
+0000bb00: 637d 2076 7320 7b6e 6577 5f6e 707d 220a  c} vs {new_np}".
+0000bb10: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0000bb20: 2020 6e70 7473 5f64 6973 6320 3d20 6e65    npts_disc = ne
+0000bb30: 775f 6e70 0a0a 2020 2020 7074 7320 3d20  w_np..    pts = 
+0000bb40: 6e70 2e65 6d70 7479 2828 332c 6e70 7473  np.empty((3,npts
+0000bb50: 5f64 6973 6329 290a 2020 2020 696e 6420  _disc)).    ind 
 0000bb60: 3d20 6e70 2e65 6d70 7479 2828 6e70 7473  = np.empty((npts
-0000bb70: 5f64 6973 632c 2929 0a20 2020 2070 7473  _disc,)).    pts
-0000bb80: 5f6d 7620 3d20 7074 730a 2020 2020 696e  _mv = pts.    in
-0000bb90: 645f 6d76 203d 2069 6e64 0a20 2020 2064  d_mv = ind.    d
-0000bba0: 765f 6d76 2020 3d20 7265 7333 640a 2020  v_mv  = res3d.  
-0000bbb0: 2020 7265 736f 5f72 5f7a 203d 2072 6573    reso_r_z = res
-0000bbc0: 6f5f 725b 305d 2a72 6573 6f5f 7a5b 305d  o_r[0]*reso_z[0]
-0000bbd0: 0a0a 2020 2020 696e 6449 203d 206e 702e  ..    indI = np.
-0000bbe0: 736f 7274 2869 6e64 492c 2061 7869 733d  sort(indI, axis=
-0000bbf0: 3129 0a20 2020 2069 6e64 695f 6d76 203d  1).    indi_mv =
-0000bc00: 2069 6e64 490a 2020 2020 6669 7273 745f   indI.    first_
-0000bc10: 696e 645f 6d76 203d 206e 702e 6172 676d  ind_mv = np.argm
-0000bc20: 6178 2869 6e64 4920 3e20 2d31 2c20 6178  ax(indI > -1, ax
-0000bc30: 6973 3d31 292e 6173 7479 7065 2869 6e74  is=1).astype(int
-0000bc40: 290a 0a20 2020 205f 7374 2e76 6d65 7368  )..    _st.vmesh
-0000bc50: 5f61 7373 656d 626c 655f 6172 7261 7973  _assemble_arrays
-0000bc60: 2866 6972 7374 5f69 6e64 5f6d 762c 2069  (first_ind_mv, i
-0000bc70: 6e64 695f 6d76 2c0a 2020 2020 2020 2020  ndi_mv,.        
-0000bc80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bc90: 2020 6973 5f69 6e5f 7669 676e 6574 7465    is_in_vignette
-0000bca0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000bcb0: 2020 2020 2020 2020 2020 2020 6973 5f63              is_c
-0000bcc0: 6172 742c 2073 7a5f 722c 0a20 2020 2020  art, sz_r,.     
-0000bcd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bce0: 2020 2020 2073 7a5f 7a2c 206c 696e 6465       sz_z, linde
-0000bcf0: 785f 7a2c 0a20 2020 2020 2020 2020 2020  x_z,.           
-0000bd00: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0000bd10: 6365 6c6c 735f 7270 6869 2c20 746f 745f  cells_rphi, tot_
-0000bd20: 6e63 5f70 6c61 6e65 2c0a 2020 2020 2020  nc_plane,.      
-0000bd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bd40: 2020 2020 7265 736f 5f72 5f7a 2c20 7374      reso_r_z, st
-0000bd50: 6570 5f72 7068 692c 0a20 2020 2020 2020  ep_rphi,.       
+0000bb70: 5f64 6973 632c 292c 2064 7479 7065 3d69  _disc,), dtype=i
+0000bb80: 6e74 290a 2020 2020 7265 7333 6420 203d  nt).    res3d  =
+0000bb90: 206e 702e 656d 7074 7928 286e 7074 735f   np.empty((npts_
+0000bba0: 6469 7363 2c29 290a 2020 2020 7074 735f  disc,)).    pts_
+0000bbb0: 6d76 203d 2070 7473 0a20 2020 2069 6e64  mv = pts.    ind
+0000bbc0: 5f6d 7620 3d20 696e 640a 2020 2020 6476  _mv = ind.    dv
+0000bbd0: 5f6d 7620 203d 2072 6573 3364 0a20 2020  _mv  = res3d.   
+0000bbe0: 2072 6573 6f5f 725f 7a20 3d20 7265 736f   reso_r_z = reso
+0000bbf0: 5f72 5b30 5d2a 7265 736f 5f7a 5b30 5d0a  _r[0]*reso_z[0].
+0000bc00: 0a20 2020 2069 6e64 4920 3d20 6e70 2e73  .    indI = np.s
+0000bc10: 6f72 7428 696e 6449 2c20 6178 6973 3d31  ort(indI, axis=1
+0000bc20: 290a 2020 2020 696e 6469 5f6d 7620 3d20  ).    indi_mv = 
+0000bc30: 696e 6449 0a20 2020 2066 6972 7374 5f69  indI.    first_i
+0000bc40: 6e64 5f6d 7620 3d20 6e70 2e61 7267 6d61  nd_mv = np.argma
+0000bc50: 7828 696e 6449 203e 202d 312c 2061 7869  x(indI > -1, axi
+0000bc60: 733d 3129 2e61 7374 7970 6528 696e 7429  s=1).astype(int)
+0000bc70: 0a0a 2020 2020 5f73 742e 766d 6573 685f  ..    _st.vmesh_
+0000bc80: 6173 7365 6d62 6c65 5f61 7272 6179 7328  assemble_arrays(
+0000bc90: 6669 7273 745f 696e 645f 6d76 2c20 696e  first_ind_mv, in
+0000bca0: 6469 5f6d 762c 0a20 2020 2020 2020 2020  di_mv,.         
+0000bcb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bcc0: 2069 735f 696e 5f76 6967 6e65 7474 652c   is_in_vignette,
+0000bcd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000bce0: 2020 2020 2020 2020 2020 2069 735f 6361             is_ca
+0000bcf0: 7274 2c20 737a 5f72 2c0a 2020 2020 2020  rt, sz_r,.      
+0000bd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bd10: 2020 2020 737a 5f7a 2c20 6c69 6e64 6578      sz_z, lindex
+0000bd20: 5f7a 2c0a 2020 2020 2020 2020 2020 2020  _z,.            
+0000bd30: 2020 2020 2020 2020 2020 2020 2020 6e63                nc
+0000bd40: 656c 6c73 5f72 7068 692c 2074 6f74 5f6e  ells_rphi, tot_n
+0000bd50: 635f 706c 616e 652c 0a20 2020 2020 2020  c_plane,.       
 0000bd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bd70: 2020 2064 6973 635f 722c 2064 6973 635f     disc_r, disc_
-0000bd80: 7a2c 206c 6e70 2c20 737a 5f70 6869 2c0a  z, lnp, sz_phi,.
+0000bd70: 2020 2072 6573 6f5f 725f 7a2c 2073 7465     reso_r_z, ste
+0000bd80: 705f 7270 6869 2c0a 2020 2020 2020 2020  p_rphi,.        
 0000bd90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bda0: 2020 2020 2020 2020 2020 6476 5f6d 762c            dv_mv,
-0000bdb0: 2072 6573 6f5f 7068 695f 6d76 2c20 7074   reso_phi_mv, pt
-0000bdc0: 735f 6d76 2c20 696e 645f 6d76 2c0a 2020  s_mv, ind_mv,.  
-0000bdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bde0: 2020 2020 2020 2020 6e75 6d5f 7468 7265          num_thre
-0000bdf0: 6164 7329 0a20 2020 2066 7265 6528 6469  ads).    free(di
-0000be00: 7363 5f72 290a 2020 2020 6672 6565 2864  sc_r).    free(d
-0000be10: 6973 635f 7a29 0a20 2020 2066 7265 6528  isc_z).    free(
-0000be20: 6469 7363 5f72 3029 0a20 2020 2066 7265  disc_r0).    fre
-0000be30: 6528 737a 5f70 6869 290a 2020 2020 6672  e(sz_phi).    fr
-0000be40: 6565 286c 696e 6465 785f 7a29 0a20 2020  ee(lindex_z).   
-0000be50: 2066 7265 6528 7374 6570 5f72 7068 6929   free(step_rphi)
-0000be60: 0a20 2020 2066 7265 6528 6e63 656c 6c73  .    free(ncells
-0000be70: 5f72 7068 6929 0a20 2020 2066 7265 6528  _rphi).    free(
-0000be80: 746f 745f 6e63 5f70 6c61 6e65 290a 2020  tot_nc_plane).  
-0000be90: 2020 7265 7475 726e 2070 7473 2c20 7265    return pts, re
-0000bea0: 7333 642c 2069 6e64 2c20 7265 736f 5f72  s3d, ind, reso_r
-0000beb0: 5b30 5d2c 2072 6573 6f5f 7a5b 305d 2c20  [0], reso_z[0], 
-0000bec0: 7265 736f 5f70 6869 2c20 737a 5f72 2c20  reso_phi, sz_r, 
-0000bed0: 737a 5f7a 0a0a 0a64 6566 205f 5665 735f  sz_z...def _Ves_
-0000bee0: 566d 6573 685f 546f 725f 5375 6246 726f  Vmesh_Tor_SubFro
-0000bef0: 6d49 6e64 5f63 7974 686f 6e28 646f 7562  mInd_cython(doub
-0000bf00: 6c65 2072 7374 6570 2c20 646f 7562 6c65  le rstep, double
-0000bf10: 207a 7374 6570 2c20 646f 7562 6c65 2070   zstep, double p
-0000bf20: 6869 7374 6570 2c0a 2020 2020 2020 2020  histep,.        
-0000bf30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bf40: 2020 2020 2020 2020 2020 2020 2064 6f75               dou
-0000bf50: 626c 655b 3a3a 315d 2052 4d69 6e4d 6178  ble[::1] RMinMax
-0000bf60: 2c20 646f 7562 6c65 5b3a 3a31 5d20 5a4d  , double[::1] ZM
-0000bf70: 696e 4d61 782c 0a20 2020 2020 2020 2020  inMax,.         
-0000bf80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bf90: 2020 2020 2020 2020 2020 2020 6c6f 6e67              long
-0000bfa0: 5b3a 3a31 5d20 696e 642c 2073 7472 204f  [::1] ind, str O
-0000bfb0: 7574 3d27 2858 2c59 2c5a 2927 2c0a 2020  ut='(X,Y,Z)',.  
-0000bfc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bfe0: 2020 2064 6f75 626c 6520 6d61 7267 696e     double margin
-0000bff0: 3d5f 5653 4d41 4c4c 2c20 696e 7420 6e75  =_VSMALL, int nu
-0000c000: 6d5f 7468 7265 6164 733d 3438 293a 0a20  m_threads=48):. 
-0000c010: 2020 2022 2222 0a20 2020 2052 6574 7572     """.    Retur
-0000c020: 6e20 7468 6520 6465 7369 7265 6420 7375  n the desired su
-0000c030: 626d 6573 6820 696e 6469 6361 7465 6420  bmesh indicated 
-0000c040: 6279 2074 6865 2028 6e75 6d65 7269 6361  by the (numerica
-0000c050: 6c29 2069 6e64 6963 6573 2c0a 2020 2020  l) indices,.    
-0000c060: 666f 7220 7468 6520 6465 7369 7265 6420  for the desired 
-0000c070: 7265 736f 6c75 7469 6f6e 2028 7273 7465  resolution (rste
-0000c080: 702c 207a 7374 6570 2c20 7068 6973 7465  p, zstep, phiste
-0000c090: 7029 0a20 2020 2022 2222 0a20 2020 2063  p).    """.    c
-0000c0a0: 6465 6620 7374 7220 6f75 745f 6c6f 7720  def str out_low 
-0000c0b0: 3d20 4f75 742e 6c6f 7765 7228 290a 2020  = Out.lower().  
-0000c0c0: 2020 6364 6566 2062 696e 7420 6973 5f63    cdef bint is_c
-0000c0d0: 6172 7420 3d20 6f75 745f 6c6f 7720 3d3d  art = out_low ==
-0000c0e0: 2027 2878 2c79 2c7a 2927 0a20 2020 2063   '(x,y,z)'.    c
-0000c0f0: 6465 6620 696e 7420 737a 5f72 2c20 737a  def int sz_r, sz
-0000c100: 5f7a 0a20 2020 2063 6465 6620 6c6f 6e67  _z.    cdef long
-0000c110: 206e 7074 735f 6469 7363 3d6c 656e 2869   npts_disc=len(i
-0000c120: 6e64 290a 2020 2020 6364 6566 2064 6f75  nd).    cdef dou
-0000c130: 626c 6520 7477 6f70 695f 6f76 6572 5f64  ble twopi_over_d
-0000c140: 7068 690a 2020 2020 6364 6566 2064 6f75  phi.    cdef dou
-0000c150: 626c 655b 3a3a 315d 2064 5250 6869 7252  ble[::1] dRPhirR
-0000c160: 6566 0a20 2020 2063 6465 6620 696e 745b  ef.    cdef int[
-0000c170: 3a3a 315d 2052 750a 2020 2020 6364 6566  ::1] Ru.    cdef
-0000c180: 206e 702e 6e64 6172 7261 795b 646f 7562   np.ndarray[doub
-0000c190: 6c65 2c6e 6469 6d3d 325d 2070 7473 3d6e  le,ndim=2] pts=n
-0000c1a0: 702e 656d 7074 7928 2833 2c6e 7074 735f  p.empty((3,npts_
-0000c1b0: 6469 7363 2929 0a20 2020 2063 6465 6620  disc)).    cdef 
-0000c1c0: 6e70 2e6e 6461 7272 6179 5b64 6f75 626c  np.ndarray[doubl
-0000c1d0: 652c 6e64 696d 3d31 5d20 7265 7333 643d  e,ndim=1] res3d=
-0000c1e0: 6e70 2e65 6d70 7479 2828 6e70 7473 5f64  np.empty((npts_d
-0000c1f0: 6973 632c 2929 0a20 2020 2063 6465 6620  isc,)).    cdef 
-0000c200: 6c6f 6e67 5b31 5d20 2020 6e63 656c 6c73  long[1]   ncells
-0000c210: 5f72 2c20 6e63 656c 6c73 5f7a 0a20 2020  _r, ncells_z.   
-0000c220: 2063 6465 6620 646f 7562 6c65 5b31 5d20   cdef double[1] 
-0000c230: 7265 736f 5f72 2c20 7265 736f 5f7a 0a20  reso_r, reso_z. 
-0000c240: 2020 2063 6465 6620 646f 7562 6c65 5b32     cdef double[2
-0000c250: 5d20 6c69 6d69 7473 5f64 6c0a 2020 2020  ] limits_dl.    
-0000c260: 6364 6566 2069 6e74 2a20 6e63 656c 6c73  cdef int* ncells
-0000c270: 5f72 7068 6920 3d20 4e55 4c4c 0a20 2020  _rphi = NULL.   
-0000c280: 2063 6465 6620 6c6f 6e67 2a20 6c69 6e64   cdef long* lind
-0000c290: 6578 203d 204e 554c 4c0a 2020 2020 6364  ex = NULL.    cd
-0000c2a0: 6566 206c 6f6e 672a 2074 6f74 5f6e 635f  ef long* tot_nc_
-0000c2b0: 706c 616e 6520 3d20 4e55 4c4c 0a20 2020  plane = NULL.   
-0000c2c0: 2063 6465 6620 646f 7562 6c65 2a20 6469   cdef double* di
-0000c2d0: 7363 5f72 203d 204e 554c 4c0a 2020 2020  sc_r = NULL.    
-0000c2e0: 6364 6566 2064 6f75 626c 652a 2064 6973  cdef double* dis
-0000c2f0: 635f 7a20 3d20 4e55 4c4c 0a20 2020 2063  c_z = NULL.    c
-0000c300: 6465 6620 646f 7562 6c65 2a2a 2070 6869  def double** phi
-0000c310: 5f74 6162 203d 204e 554c 4c0a 0a20 2020  _tab = NULL..   
-0000c320: 2023 2047 6574 2074 6865 2061 6374 7561   # Get the actua
-0000c330: 6c20 5220 616e 6420 5a20 7265 736f 6c75  l R and Z resolu
-0000c340: 7469 6f6e 7320 616e 6420 6d65 7368 2065  tions and mesh e
-0000c350: 6c65 6d65 6e74 730a 2020 2020 2320 2e2e  lements.    # ..
-0000c360: 2057 6520 6469 7363 7265 7469 7a65 2052   We discretize R
-0000c370: 202e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e   ...............
-0000c380: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-0000c390: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-0000c3a0: 2e2e 2e2e 2e2e 2e2e 0a20 2020 205f 7374  .........    _st
-0000c3b0: 2e63 7974 686f 6e69 7a65 5f73 7562 646f  .cythonize_subdo
-0000c3c0: 6d61 696e 5f64 6c28 4e6f 6e65 2c20 6c69  main_dl(None, li
-0000c3d0: 6d69 7473 5f64 6c29 0a20 2020 2073 7a5f  mits_dl).    sz_
-0000c3e0: 7220 3d20 5f73 742e 6469 7363 7265 7469  r = _st.discreti
-0000c3f0: 7a65 5f6c 696e 6531 645f 636f 7265 2826  ze_line1d_core(&
-0000c400: 524d 696e 4d61 785b 305d 2c20 7273 7465  RMinMax[0], rste
-0000c410: 702c 206c 696d 6974 735f 646c 2c0a 2020  p, limits_dl,.  
-0000c420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c440: 2020 2020 5472 7565 2c20 302c 2023 2064      True, 0, # d
-0000c450: 6973 6372 6574 697a 6520 696e 2061 6273  iscretize in abs
-0000c460: 6f6c 7574 6520 6d6f 6465 0a20 2020 2020  olute mode.     
-0000c470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c490: 206d 6172 6769 6e2c 2026 6469 7363 5f72   margin, &disc_r
-0000c4a0: 2c20 7265 736f 5f72 2c20 266c 696e 6465  , reso_r, &linde
-0000c4b0: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
-0000c4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c4d0: 2020 2020 2020 2020 206e 6365 6c6c 735f           ncells_
-0000c4e0: 7229 0a20 2020 2066 7265 6528 6c69 6e64  r).    free(lind
-0000c4f0: 6578 2920 2320 6765 7474 696e 6720 7269  ex) # getting ri
-0000c500: 6420 6f66 2074 6869 6e67 7320 7765 2064  d of things we d
-0000c510: 6f6e 7420 6e65 6564 0a20 2020 206c 696e  ont need.    lin
-0000c520: 6465 7820 3d20 4e55 4c4c 0a20 2020 2023  dex = NULL.    #
-0000c530: 202e 2e20 5765 2064 6973 6372 6574 697a   .. We discretiz
-0000c540: 6520 5a20 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  e Z ............
-0000c550: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-0000c560: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-0000c570: 2e2e 2e2e 2e2e 2e2e 2e2e 2e0a 2020 2020  ............    
-0000c580: 737a 5f7a 203d 205f 7374 2e64 6973 6372  sz_z = _st.discr
-0000c590: 6574 697a 655f 6c69 6e65 3164 5f63 6f72  etize_line1d_cor
-0000c5a0: 6528 265a 4d69 6e4d 6178 5b30 5d2c 207a  e(&ZMinMax[0], z
-0000c5b0: 7374 6570 2c20 6c69 6d69 7473 5f64 6c2c  step, limits_dl,
-0000c5c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c5e0: 2020 2020 2020 2054 7275 652c 2030 2c20         True, 0, 
-0000c5f0: 2320 6469 7363 7265 7469 7a65 2069 6e20  # discretize in 
-0000c600: 6162 736f 6c75 7465 206d 6f64 650a 2020  absolute mode.  
-0000c610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c630: 2020 2020 6d61 7267 696e 2c20 2664 6973      margin, &dis
-0000c640: 635f 7a2c 2072 6573 6f5f 7a2c 2026 6c69  c_z, reso_z, &li
-0000c650: 6e64 6578 2c0a 2020 2020 2020 2020 2020  ndex,.          
-0000c660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c670: 2020 2020 2020 2020 2020 2020 6e63 656c              ncel
-0000c680: 6c73 5f7a 290a 2020 2020 6672 6565 286c  ls_z).    free(l
-0000c690: 696e 6465 7829 0a20 2020 2023 204e 756d  index).    # Num
-0000c6a0: 6265 7220 6f66 2050 6869 2070 6572 2052  ber of Phi per R
-0000c6b0: 0a20 2020 2064 5250 6869 7252 6566 203d  .    dRPhirRef =
-0000c6c0: 2020 6e70 2e65 6d70 7479 2828 737a 5f72    np.empty((sz_r
-0000c6d0: 2c29 290a 2020 2020 5275 203d 206e 702e  ,)).    Ru = np.
-0000c6e0: 7a65 726f 7328 2873 7a5f 722c 292c 2064  zeros((sz_r,), d
-0000c6f0: 7479 7065 3d6e 702e 6474 7970 6528 2269  type=np.dtype("i
-0000c700: 2229 290a 2020 2020 6452 5068 6972 203d  ")).    dRPhir =
-0000c710: 206e 702e 6e61 6e2a 6e70 2e6f 6e65 7328   np.nan*np.ones(
-0000c720: 2873 7a5f 722c 2929 0a20 2020 2074 6f74  (sz_r,)).    tot
-0000c730: 5f6e 635f 706c 616e 6520 3d20 3c6c 6f6e  _nc_plane = <lon
-0000c740: 672a 3e20 6d61 6c6c 6f63 2828 737a 5f72  g*> malloc((sz_r
-0000c750: 202b 2031 2920 2a20 7369 7a65 6f66 286c   + 1) * sizeof(l
-0000c760: 6f6e 6729 290a 2020 2020 2320 2e2e 2049  ong)).    # .. I
-0000c770: 6e69 7469 616c 697a 6174 696f 6e20 2e2e  nitialization ..
-0000c780: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-0000c790: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-0000c7a0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-0000c7b0: 2e2e 2e2e 2e2e 0a20 2020 206e 6365 6c6c  .......    ncell
-0000c7c0: 735f 7270 6869 2020 3d20 3c69 6e74 2a3e  s_rphi  = <int*>
-0000c7d0: 6d61 6c6c 6f63 2873 7a5f 7220 2a20 7369  malloc(sz_r * si
-0000c7e0: 7a65 6f66 2869 6e74 2929 0a20 2020 2070  zeof(int)).    p
-0000c7f0: 6869 5f74 6162 203d 203c 646f 7562 6c65  hi_tab = <double
-0000c800: 2a2a 3e6d 616c 6c6f 6328 7369 7a65 6f66  **>malloc(sizeof
-0000c810: 2864 6f75 626c 652a 2929 0a20 2020 2070  (double*)).    p
-0000c820: 6869 5f74 6162 5b30 5d20 3d20 4e55 4c4c  hi_tab[0] = NULL
-0000c830: 0a20 2020 2072 6573 6f5f 725f 7a20 3d20  .    reso_r_z = 
-0000c840: 7265 736f 5f72 5b30 5d2a 7265 736f 5f7a  reso_r[0]*reso_z
-0000c850: 5b30 5d0a 2020 2020 7477 6f70 695f 6f76  [0].    twopi_ov
-0000c860: 6572 5f64 7068 6920 3d20 5f54 574f 5049  er_dphi = _TWOPI
-0000c870: 202f 2070 6869 7374 6570 0a20 2020 2023   / phistep.    #
-0000c880: 202e 2e20 4469 7363 7265 7469 7a69 6e67   .. Discretizing
-0000c890: 2050 6869 2028 7769 7468 2072 6573 7065   Phi (with respe
-0000c8a0: 6374 2074 6f20 7468 6520 636f 7272 6573  ct to the corres
-0000c8b0: 706f 6e64 696e 6720 7261 6469 7573 2052  ponding radius R
-0000c8c0: 2920 2e2e 2e2e 2e2e 2e2e 2e0a 2020 2020  ) ..........    
-0000c8d0: 5f73 742e 766d 6573 685f 696e 645f 696e  _st.vmesh_ind_in
-0000c8e0: 6974 5f74 6162 7328 6e63 656c 6c73 5f72  it_tabs(ncells_r
-0000c8f0: 7068 692c 2064 6973 635f 722c 2073 7a5f  phi, disc_r, sz_
-0000c900: 722c 2073 7a5f 7a2c 0a20 2020 2020 2020  r, sz_z,.       
-0000c910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c920: 2020 2020 2074 776f 7069 5f6f 7665 725f       twopi_over_
-0000c930: 6470 6869 2c20 6452 5068 6972 5265 662c  dphi, dRPhirRef,
-0000c940: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c950: 2020 2020 2020 2020 2020 2020 2074 6f74               tot
-0000c960: 5f6e 635f 706c 616e 652c 2026 7068 695f  _nc_plane, &phi_
-0000c970: 7461 625b 305d 2c0a 2020 2020 2020 2020  tab[0],.        
-0000c980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c990: 2020 2020 6e75 6d5f 7468 7265 6164 7329      num_threads)
-0000c9a0: 0a20 2020 2023 202e 2e20 436f 6d70 7574  .    # .. Comput
-0000c9b0: 696e 6720 7468 6520 706f 696e 7473 2063  ing the points c
-0000c9c0: 6f6f 7264 696e 6174 6573 202e 2e2e 2e2e  oordinates .....
-0000c9d0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-0000c9e0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-0000c9f0: 2e0a 2020 2020 6966 2069 735f 6361 7274  ..    if is_cart
-0000ca00: 3a0a 2020 2020 2020 2020 5f73 742e 766d  :.        _st.vm
-0000ca10: 6573 685f 696e 645f 6361 7274 5f6c 6f6f  esh_ind_cart_loo
-0000ca20: 7028 6e70 7473 5f64 6973 632c 2073 7a5f  p(npts_disc, sz_
-0000ca30: 722c 2069 6e64 2c20 746f 745f 6e63 5f70  r, ind, tot_nc_p
-0000ca40: 6c61 6e65 2c0a 2020 2020 2020 2020 2020  lane,.          
-0000ca50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ca60: 2020 2020 2020 6e63 656c 6c73 5f72 7068        ncells_rph
-0000ca70: 692c 2070 6869 5f74 6162 5b30 5d2c 2064  i, phi_tab[0], d
-0000ca80: 6973 635f 722c 2064 6973 635f 7a2c 0a20  isc_r, disc_z,. 
-0000ca90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000caa0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0000cab0: 7473 2c20 7265 7333 642c 2072 6573 6f5f  ts, res3d, reso_
-0000cac0: 725f 7a2c 2064 5250 6869 7252 6566 2c20  r_z, dRPhirRef, 
-0000cad0: 5275 2c0a 2020 2020 2020 2020 2020 2020  Ru,.            
-0000cae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000caf0: 2020 2020 6452 5068 6972 2c20 6e75 6d5f      dRPhir, num_
-0000cb00: 7468 7265 6164 7329 0a20 2020 2065 6c73  threads).    els
-0000cb10: 653a 0a20 2020 2020 2020 205f 7374 2e76  e:.        _st.v
-0000cb20: 6d65 7368 5f69 6e64 5f70 6f6c 725f 6c6f  mesh_ind_polr_lo
-0000cb30: 6f70 286e 7074 735f 6469 7363 2c20 737a  op(npts_disc, sz
-0000cb40: 5f72 2c20 696e 642c 2074 6f74 5f6e 635f  _r, ind, tot_nc_
-0000cb50: 706c 616e 652c 0a20 2020 2020 2020 2020  plane,.         
-0000cb60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cb70: 2020 2020 2020 206e 6365 6c6c 735f 7270         ncells_rp
-0000cb80: 6869 2c20 7068 695f 7461 625b 305d 2c20  hi, phi_tab[0], 
-0000cb90: 6469 7363 5f72 2c20 6469 7363 5f7a 2c0a  disc_r, disc_z,.
-0000cba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cbc0: 7074 732c 2072 6573 3364 2c20 7265 736f  pts, res3d, reso
-0000cbd0: 5f72 5f7a 2c20 6452 5068 6972 5265 662c  _r_z, dRPhirRef,
-0000cbe0: 2052 752c 0a20 2020 2020 2020 2020 2020   Ru,.           
-0000cbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cc00: 2020 2020 2064 5250 6869 722c 206e 756d       dRPhir, num
-0000cc10: 5f74 6872 6561 6473 290a 2020 2020 6672  _threads).    fr
-0000cc20: 6565 286e 6365 6c6c 735f 7270 6869 290a  ee(ncells_rphi).
-0000cc30: 2020 2020 6672 6565 2874 6f74 5f6e 635f      free(tot_nc_
-0000cc40: 706c 616e 6529 0a20 2020 2069 6620 6e6f  plane).    if no
-0000cc50: 7420 7068 695f 7461 625b 305d 203d 3d20  t phi_tab[0] == 
-0000cc60: 4e55 4c4c 3a0a 2020 2020 2020 2020 6672  NULL:.        fr
-0000cc70: 6565 2870 6869 5f74 6162 5b30 5d29 0a20  ee(phi_tab[0]). 
-0000cc80: 2020 2069 6620 6e6f 7420 7068 695f 7461     if not phi_ta
-0000cc90: 6220 3d3d 204e 554c 4c3a 0a20 2020 2020  b == NULL:.     
-0000cca0: 2020 2066 7265 6528 7068 695f 7461 6229     free(phi_tab)
-0000ccb0: 0a20 2020 2072 6574 7572 6e20 2870 7473  .    return (pts
-0000ccc0: 2c20 7265 7333 642c 2072 6573 6f5f 725b  , res3d, reso_r[
-0000ccd0: 305d 2c20 7265 736f 5f7a 5b30 5d2c 0a20  0], reso_z[0],. 
-0000cce0: 2020 2020 2020 2020 2020 206e 702e 6173             np.as
-0000ccf0: 6172 7261 7928 6452 5068 6972 295b 7e6e  array(dRPhir)[~n
-0000cd00: 702e 6973 6e61 6e28 6452 5068 6972 295d  p.isnan(dRPhir)]
-0000cd10: 290a 0a0a 2320 3d3d 3d3d 3d3d 3d3d 3d3d  )...# ==========
-0000cd20: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000cd30: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000cd40: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000bda0: 2020 6469 7363 5f72 2c20 6469 7363 5f7a    disc_r, disc_z
+0000bdb0: 2c20 6c6e 702c 2073 7a5f 7068 692c 0a20  , lnp, sz_phi,. 
+0000bdc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bdd0: 2020 2020 2020 2020 2064 765f 6d76 2c20           dv_mv, 
+0000bde0: 7265 736f 5f70 6869 5f6d 762c 2070 7473  reso_phi_mv, pts
+0000bdf0: 5f6d 762c 2069 6e64 5f6d 762c 0a20 2020  _mv, ind_mv,.   
+0000be00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000be10: 2020 2020 2020 206e 756d 5f74 6872 6561         num_threa
+0000be20: 6473 290a 2020 2020 6672 6565 2864 6973  ds).    free(dis
+0000be30: 635f 7229 0a20 2020 2066 7265 6528 6469  c_r).    free(di
+0000be40: 7363 5f7a 290a 2020 2020 6672 6565 2864  sc_z).    free(d
+0000be50: 6973 635f 7230 290a 2020 2020 6672 6565  isc_r0).    free
+0000be60: 2873 7a5f 7068 6929 0a20 2020 2066 7265  (sz_phi).    fre
+0000be70: 6528 6c69 6e64 6578 5f7a 290a 2020 2020  e(lindex_z).    
+0000be80: 6672 6565 2873 7465 705f 7270 6869 290a  free(step_rphi).
+0000be90: 2020 2020 6672 6565 286e 6365 6c6c 735f      free(ncells_
+0000bea0: 7270 6869 290a 2020 2020 6672 6565 2874  rphi).    free(t
+0000beb0: 6f74 5f6e 635f 706c 616e 6529 0a20 2020  ot_nc_plane).   
+0000bec0: 2072 6574 7572 6e20 7074 732c 2072 6573   return pts, res
+0000bed0: 3364 2c20 696e 642c 2072 6573 6f5f 725b  3d, ind, reso_r[
+0000bee0: 305d 2c20 7265 736f 5f7a 5b30 5d2c 2072  0], reso_z[0], r
+0000bef0: 6573 6f5f 7068 692c 2073 7a5f 722c 2073  eso_phi, sz_r, s
+0000bf00: 7a5f 7a0a 0a0a 6465 6620 5f56 6573 5f56  z_z...def _Ves_V
+0000bf10: 6d65 7368 5f54 6f72 5f53 7562 4672 6f6d  mesh_Tor_SubFrom
+0000bf20: 496e 645f 6379 7468 6f6e 2864 6f75 626c  Ind_cython(doubl
+0000bf30: 6520 7273 7465 702c 2064 6f75 626c 6520  e rstep, double 
+0000bf40: 7a73 7465 702c 2064 6f75 626c 6520 7068  zstep, double ph
+0000bf50: 6973 7465 702c 0a20 2020 2020 2020 2020  istep,.         
+0000bf60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bf70: 2020 2020 2020 2020 2020 2020 646f 7562              doub
+0000bf80: 6c65 5b3a 3a31 5d20 524d 696e 4d61 782c  le[::1] RMinMax,
+0000bf90: 2064 6f75 626c 655b 3a3a 315d 205a 4d69   double[::1] ZMi
+0000bfa0: 6e4d 6178 2c0a 2020 2020 2020 2020 2020  nMax,.          
+0000bfb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bfc0: 2020 2020 2020 2020 2020 206c 6f6e 675b             long[
+0000bfd0: 3a3a 315d 2069 6e64 2c20 7374 7220 4f75  ::1] ind, str Ou
+0000bfe0: 743d 2728 582c 592c 5a29 272c 0a20 2020  t='(X,Y,Z)',.   
+0000bff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c010: 2020 646f 7562 6c65 206d 6172 6769 6e3d    double margin=
+0000c020: 5f56 534d 414c 4c2c 2069 6e74 206e 756d  _VSMALL, int num
+0000c030: 5f74 6872 6561 6473 3d34 3829 3a0a 2020  _threads=48):.  
+0000c040: 2020 2222 220a 2020 2020 5265 7475 726e    """.    Return
+0000c050: 2074 6865 2064 6573 6972 6564 2073 7562   the desired sub
+0000c060: 6d65 7368 2069 6e64 6963 6174 6564 2062  mesh indicated b
+0000c070: 7920 7468 6520 286e 756d 6572 6963 616c  y the (numerical
+0000c080: 2920 696e 6469 6365 732c 0a20 2020 2066  ) indices,.    f
+0000c090: 6f72 2074 6865 2064 6573 6972 6564 2072  or the desired r
+0000c0a0: 6573 6f6c 7574 696f 6e20 2872 7374 6570  esolution (rstep
+0000c0b0: 2c20 7a73 7465 702c 2070 6869 7374 6570  , zstep, phistep
+0000c0c0: 290a 2020 2020 2222 220a 2020 2020 6364  ).    """.    cd
+0000c0d0: 6566 2073 7472 206f 7574 5f6c 6f77 203d  ef str out_low =
+0000c0e0: 204f 7574 2e6c 6f77 6572 2829 0a20 2020   Out.lower().   
+0000c0f0: 2063 6465 6620 6269 6e74 2069 735f 6361   cdef bint is_ca
+0000c100: 7274 203d 206f 7574 5f6c 6f77 203d 3d20  rt = out_low == 
+0000c110: 2728 782c 792c 7a29 270a 2020 2020 6364  '(x,y,z)'.    cd
+0000c120: 6566 2069 6e74 2073 7a5f 722c 2073 7a5f  ef int sz_r, sz_
+0000c130: 7a0a 2020 2020 6364 6566 206c 6f6e 6720  z.    cdef long 
+0000c140: 6e70 7473 5f64 6973 633d 6c65 6e28 696e  npts_disc=len(in
+0000c150: 6429 0a20 2020 2063 6465 6620 646f 7562  d).    cdef doub
+0000c160: 6c65 2074 776f 7069 5f6f 7665 725f 6470  le twopi_over_dp
+0000c170: 6869 0a20 2020 2063 6465 6620 646f 7562  hi.    cdef doub
+0000c180: 6c65 5b3a 3a31 5d20 6452 5068 6972 5265  le[::1] dRPhirRe
+0000c190: 660a 2020 2020 6364 6566 2069 6e74 5b3a  f.    cdef int[:
+0000c1a0: 3a31 5d20 5275 0a20 2020 2063 6465 6620  :1] Ru.    cdef 
+0000c1b0: 6e70 2e6e 6461 7272 6179 5b64 6f75 626c  np.ndarray[doubl
+0000c1c0: 652c 6e64 696d 3d32 5d20 7074 733d 6e70  e,ndim=2] pts=np
+0000c1d0: 2e65 6d70 7479 2828 332c 6e70 7473 5f64  .empty((3,npts_d
+0000c1e0: 6973 6329 290a 2020 2020 6364 6566 206e  isc)).    cdef n
+0000c1f0: 702e 6e64 6172 7261 795b 646f 7562 6c65  p.ndarray[double
+0000c200: 2c6e 6469 6d3d 315d 2072 6573 3364 3d6e  ,ndim=1] res3d=n
+0000c210: 702e 656d 7074 7928 286e 7074 735f 6469  p.empty((npts_di
+0000c220: 7363 2c29 290a 2020 2020 6364 6566 206c  sc,)).    cdef l
+0000c230: 6f6e 675b 315d 2020 206e 6365 6c6c 735f  ong[1]   ncells_
+0000c240: 722c 206e 6365 6c6c 735f 7a0a 2020 2020  r, ncells_z.    
+0000c250: 6364 6566 2064 6f75 626c 655b 315d 2072  cdef double[1] r
+0000c260: 6573 6f5f 722c 2072 6573 6f5f 7a0a 2020  eso_r, reso_z.  
+0000c270: 2020 6364 6566 2064 6f75 626c 655b 325d    cdef double[2]
+0000c280: 206c 696d 6974 735f 646c 0a20 2020 2063   limits_dl.    c
+0000c290: 6465 6620 696e 742a 206e 6365 6c6c 735f  def int* ncells_
+0000c2a0: 7270 6869 203d 204e 554c 4c0a 2020 2020  rphi = NULL.    
+0000c2b0: 6364 6566 206c 6f6e 672a 206c 696e 6465  cdef long* linde
+0000c2c0: 7820 3d20 4e55 4c4c 0a20 2020 2063 6465  x = NULL.    cde
+0000c2d0: 6620 6c6f 6e67 2a20 746f 745f 6e63 5f70  f long* tot_nc_p
+0000c2e0: 6c61 6e65 203d 204e 554c 4c0a 2020 2020  lane = NULL.    
+0000c2f0: 6364 6566 2064 6f75 626c 652a 2064 6973  cdef double* dis
+0000c300: 635f 7220 3d20 4e55 4c4c 0a20 2020 2063  c_r = NULL.    c
+0000c310: 6465 6620 646f 7562 6c65 2a20 6469 7363  def double* disc
+0000c320: 5f7a 203d 204e 554c 4c0a 2020 2020 6364  _z = NULL.    cd
+0000c330: 6566 2064 6f75 626c 652a 2a20 7068 695f  ef double** phi_
+0000c340: 7461 6220 3d20 4e55 4c4c 0a0a 2020 2020  tab = NULL..    
+0000c350: 2320 4765 7420 7468 6520 6163 7475 616c  # Get the actual
+0000c360: 2052 2061 6e64 205a 2072 6573 6f6c 7574   R and Z resolut
+0000c370: 696f 6e73 2061 6e64 206d 6573 6820 656c  ions and mesh el
+0000c380: 656d 656e 7473 0a20 2020 2023 202e 2e20  ements.    # .. 
+0000c390: 5765 2064 6973 6372 6574 697a 6520 5220  We discretize R 
+0000c3a0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+0000c3b0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+0000c3c0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+0000c3d0: 2e2e 2e2e 2e2e 2e0a 2020 2020 5f73 742e  ........    _st.
+0000c3e0: 6379 7468 6f6e 697a 655f 7375 6264 6f6d  cythonize_subdom
+0000c3f0: 6169 6e5f 646c 284e 6f6e 652c 206c 696d  ain_dl(None, lim
+0000c400: 6974 735f 646c 290a 2020 2020 737a 5f72  its_dl).    sz_r
+0000c410: 203d 205f 7374 2e64 6973 6372 6574 697a   = _st.discretiz
+0000c420: 655f 6c69 6e65 3164 5f63 6f72 6528 2652  e_line1d_core(&R
+0000c430: 4d69 6e4d 6178 5b30 5d2c 2072 7374 6570  MinMax[0], rstep
+0000c440: 2c20 6c69 6d69 7473 5f64 6c2c 0a20 2020  , limits_dl,.   
+0000c450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c470: 2020 2054 7275 652c 2030 2c20 2320 6469     True, 0, # di
+0000c480: 7363 7265 7469 7a65 2069 6e20 6162 736f  scretize in abso
+0000c490: 6c75 7465 206d 6f64 650a 2020 2020 2020  lute mode.      
+0000c4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c4c0: 6d61 7267 696e 2c20 2664 6973 635f 722c  margin, &disc_r,
+0000c4d0: 2072 6573 6f5f 722c 2026 6c69 6e64 6578   reso_r, &lindex
+0000c4e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000c4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c500: 2020 2020 2020 2020 6e63 656c 6c73 5f72          ncells_r
+0000c510: 290a 2020 2020 6672 6565 286c 696e 6465  ).    free(linde
+0000c520: 7829 2023 2067 6574 7469 6e67 2072 6964  x) # getting rid
+0000c530: 206f 6620 7468 696e 6773 2077 6520 646f   of things we do
+0000c540: 6e74 206e 6565 640a 2020 2020 6c69 6e64  nt need.    lind
+0000c550: 6578 203d 204e 554c 4c0a 2020 2020 2320  ex = NULL.    # 
+0000c560: 2e2e 2057 6520 6469 7363 7265 7469 7a65  .. We discretize
+0000c570: 205a 202e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e   Z .............
+0000c580: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+0000c590: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+0000c5a0: 2e2e 2e2e 2e2e 2e2e 2e2e 0a20 2020 2073  ...........    s
+0000c5b0: 7a5f 7a20 3d20 5f73 742e 6469 7363 7265  z_z = _st.discre
+0000c5c0: 7469 7a65 5f6c 696e 6531 645f 636f 7265  tize_line1d_core
+0000c5d0: 2826 5a4d 696e 4d61 785b 305d 2c20 7a73  (&ZMinMax[0], zs
+0000c5e0: 7465 702c 206c 696d 6974 735f 646c 2c0a  tep, limits_dl,.
+0000c5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c610: 2020 2020 2020 5472 7565 2c20 302c 2023        True, 0, #
+0000c620: 2064 6973 6372 6574 697a 6520 696e 2061   discretize in a
+0000c630: 6273 6f6c 7574 6520 6d6f 6465 0a20 2020  bsolute mode.   
+0000c640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c660: 2020 206d 6172 6769 6e2c 2026 6469 7363     margin, &disc
+0000c670: 5f7a 2c20 7265 736f 5f7a 2c20 266c 696e  _z, reso_z, &lin
+0000c680: 6465 782c 0a20 2020 2020 2020 2020 2020  dex,.           
+0000c690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c6a0: 2020 2020 2020 2020 2020 206e 6365 6c6c             ncell
+0000c6b0: 735f 7a29 0a20 2020 2066 7265 6528 6c69  s_z).    free(li
+0000c6c0: 6e64 6578 290a 2020 2020 2320 4e75 6d62  ndex).    # Numb
+0000c6d0: 6572 206f 6620 5068 6920 7065 7220 520a  er of Phi per R.
+0000c6e0: 2020 2020 6452 5068 6972 5265 6620 3d20      dRPhirRef = 
+0000c6f0: 206e 702e 656d 7074 7928 2873 7a5f 722c   np.empty((sz_r,
+0000c700: 2929 0a20 2020 2052 7520 3d20 6e70 2e7a  )).    Ru = np.z
+0000c710: 6572 6f73 2828 737a 5f72 2c29 2c20 6474  eros((sz_r,), dt
+0000c720: 7970 653d 6e70 2e64 7479 7065 2822 6922  ype=np.dtype("i"
+0000c730: 2929 0a20 2020 2064 5250 6869 7220 3d20  )).    dRPhir = 
+0000c740: 6e70 2e6e 616e 2a6e 702e 6f6e 6573 2828  np.nan*np.ones((
+0000c750: 737a 5f72 2c29 290a 2020 2020 746f 745f  sz_r,)).    tot_
+0000c760: 6e63 5f70 6c61 6e65 203d 203c 6c6f 6e67  nc_plane = <long
+0000c770: 2a3e 206d 616c 6c6f 6328 2873 7a5f 7220  *> malloc((sz_r 
+0000c780: 2b20 3129 202a 2073 697a 656f 6628 6c6f  + 1) * sizeof(lo
+0000c790: 6e67 2929 0a20 2020 2023 202e 2e20 496e  ng)).    # .. In
+0000c7a0: 6974 6961 6c69 7a61 7469 6f6e 202e 2e2e  itialization ...
+0000c7b0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+0000c7c0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+0000c7d0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+0000c7e0: 2e2e 2e2e 2e0a 2020 2020 6e63 656c 6c73  ......    ncells
+0000c7f0: 5f72 7068 6920 203d 203c 696e 742a 3e6d  _rphi  = <int*>m
+0000c800: 616c 6c6f 6328 737a 5f72 202a 2073 697a  alloc(sz_r * siz
+0000c810: 656f 6628 696e 7429 290a 2020 2020 7068  eof(int)).    ph
+0000c820: 695f 7461 6220 3d20 3c64 6f75 626c 652a  i_tab = <double*
+0000c830: 2a3e 6d61 6c6c 6f63 2873 697a 656f 6628  *>malloc(sizeof(
+0000c840: 646f 7562 6c65 2a29 290a 2020 2020 7068  double*)).    ph
+0000c850: 695f 7461 625b 305d 203d 204e 554c 4c0a  i_tab[0] = NULL.
+0000c860: 2020 2020 7265 736f 5f72 5f7a 203d 2072      reso_r_z = r
+0000c870: 6573 6f5f 725b 305d 2a72 6573 6f5f 7a5b  eso_r[0]*reso_z[
+0000c880: 305d 0a20 2020 2074 776f 7069 5f6f 7665  0].    twopi_ove
+0000c890: 725f 6470 6869 203d 205f 5457 4f50 4920  r_dphi = _TWOPI 
+0000c8a0: 2f20 7068 6973 7465 700a 2020 2020 2320  / phistep.    # 
+0000c8b0: 2e2e 2044 6973 6372 6574 697a 696e 6720  .. Discretizing 
+0000c8c0: 5068 6920 2877 6974 6820 7265 7370 6563  Phi (with respec
+0000c8d0: 7420 746f 2074 6865 2063 6f72 7265 7370  t to the corresp
+0000c8e0: 6f6e 6469 6e67 2072 6164 6975 7320 5229  onding radius R)
+0000c8f0: 202e 2e2e 2e2e 2e2e 2e2e 0a20 2020 205f   ..........    _
+0000c900: 7374 2e76 6d65 7368 5f69 6e64 5f69 6e69  st.vmesh_ind_ini
+0000c910: 745f 7461 6273 286e 6365 6c6c 735f 7270  t_tabs(ncells_rp
+0000c920: 6869 2c20 6469 7363 5f72 2c20 737a 5f72  hi, disc_r, sz_r
+0000c930: 2c20 737a 5f7a 2c0a 2020 2020 2020 2020  , sz_z,.        
+0000c940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c950: 2020 2020 7477 6f70 695f 6f76 6572 5f64      twopi_over_d
+0000c960: 7068 692c 2064 5250 6869 7252 6566 2c0a  phi, dRPhirRef,.
+0000c970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c980: 2020 2020 2020 2020 2020 2020 746f 745f              tot_
+0000c990: 6e63 5f70 6c61 6e65 2c20 2670 6869 5f74  nc_plane, &phi_t
+0000c9a0: 6162 5b30 5d2c 0a20 2020 2020 2020 2020  ab[0],.         
+0000c9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c9c0: 2020 206e 756d 5f74 6872 6561 6473 290a     num_threads).
+0000c9d0: 2020 2020 2320 2e2e 2043 6f6d 7075 7469      # .. Computi
+0000c9e0: 6e67 2074 6865 2070 6f69 6e74 7320 636f  ng the points co
+0000c9f0: 6f72 6469 6e61 7465 7320 2e2e 2e2e 2e2e  ordinates ......
+0000ca00: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+0000ca10: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+0000ca20: 0a20 2020 2069 6620 6973 5f63 6172 743a  .    if is_cart:
+0000ca30: 0a20 2020 2020 2020 205f 7374 2e76 6d65  .        _st.vme
+0000ca40: 7368 5f69 6e64 5f63 6172 745f 6c6f 6f70  sh_ind_cart_loop
+0000ca50: 286e 7074 735f 6469 7363 2c20 737a 5f72  (npts_disc, sz_r
+0000ca60: 2c20 696e 642c 2074 6f74 5f6e 635f 706c  , ind, tot_nc_pl
+0000ca70: 616e 652c 0a20 2020 2020 2020 2020 2020  ane,.           
+0000ca80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ca90: 2020 2020 206e 6365 6c6c 735f 7270 6869       ncells_rphi
+0000caa0: 2c20 7068 695f 7461 625b 305d 2c20 6469  , phi_tab[0], di
+0000cab0: 7363 5f72 2c20 6469 7363 5f7a 2c0a 2020  sc_r, disc_z,.  
+0000cac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cad0: 2020 2020 2020 2020 2020 2020 2020 7074                pt
+0000cae0: 732c 2072 6573 3364 2c20 7265 736f 5f72  s, res3d, reso_r
+0000caf0: 5f7a 2c20 6452 5068 6972 5265 662c 2052  _z, dRPhirRef, R
+0000cb00: 752c 0a20 2020 2020 2020 2020 2020 2020  u,.             
+0000cb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cb20: 2020 2064 5250 6869 722c 206e 756d 5f74     dRPhir, num_t
+0000cb30: 6872 6561 6473 290a 2020 2020 656c 7365  hreads).    else
+0000cb40: 3a0a 2020 2020 2020 2020 5f73 742e 766d  :.        _st.vm
+0000cb50: 6573 685f 696e 645f 706f 6c72 5f6c 6f6f  esh_ind_polr_loo
+0000cb60: 7028 6e70 7473 5f64 6973 632c 2073 7a5f  p(npts_disc, sz_
+0000cb70: 722c 2069 6e64 2c20 746f 745f 6e63 5f70  r, ind, tot_nc_p
+0000cb80: 6c61 6e65 2c0a 2020 2020 2020 2020 2020  lane,.          
+0000cb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cba0: 2020 2020 2020 6e63 656c 6c73 5f72 7068        ncells_rph
+0000cbb0: 692c 2070 6869 5f74 6162 5b30 5d2c 2064  i, phi_tab[0], d
+0000cbc0: 6973 635f 722c 2064 6973 635f 7a2c 0a20  isc_r, disc_z,. 
+0000cbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cbe0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0000cbf0: 7473 2c20 7265 7333 642c 2072 6573 6f5f  ts, res3d, reso_
+0000cc00: 725f 7a2c 2064 5250 6869 7252 6566 2c20  r_z, dRPhirRef, 
+0000cc10: 5275 2c0a 2020 2020 2020 2020 2020 2020  Ru,.            
+0000cc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cc30: 2020 2020 6452 5068 6972 2c20 6e75 6d5f      dRPhir, num_
+0000cc40: 7468 7265 6164 7329 0a20 2020 2066 7265  threads).    fre
+0000cc50: 6528 6e63 656c 6c73 5f72 7068 6929 0a20  e(ncells_rphi). 
+0000cc60: 2020 2066 7265 6528 746f 745f 6e63 5f70     free(tot_nc_p
+0000cc70: 6c61 6e65 290a 2020 2020 6966 206e 6f74  lane).    if not
+0000cc80: 2070 6869 5f74 6162 5b30 5d20 3d3d 204e   phi_tab[0] == N
+0000cc90: 554c 4c3a 0a20 2020 2020 2020 2066 7265  ULL:.        fre
+0000cca0: 6528 7068 695f 7461 625b 305d 290a 2020  e(phi_tab[0]).  
+0000ccb0: 2020 6966 206e 6f74 2070 6869 5f74 6162    if not phi_tab
+0000ccc0: 203d 3d20 4e55 4c4c 3a0a 2020 2020 2020   == NULL:.      
+0000ccd0: 2020 6672 6565 2870 6869 5f74 6162 290a    free(phi_tab).
+0000cce0: 2020 2020 7265 7475 726e 2028 7074 732c      return (pts,
+0000ccf0: 2072 6573 3364 2c20 7265 736f 5f72 5b30   res3d, reso_r[0
+0000cd00: 5d2c 2072 6573 6f5f 7a5b 305d 2c0a 2020  ], reso_z[0],.  
+0000cd10: 2020 2020 2020 2020 2020 6e70 2e61 7361            np.asa
+0000cd20: 7272 6179 2864 5250 6869 7229 5b7e 6e70  rray(dRPhir)[~np
+0000cd30: 2e69 736e 616e 2864 5250 6869 7229 5d29  .isnan(dRPhir)])
+0000cd40: 0a0a 0a23 203d 3d3d 3d3d 3d3d 3d3d 3d3d  ...# ===========
 0000cd50: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000cd60: 3d3d 3d3d 0a23 0a23 2020 2020 2020 2020  ====.#.#        
-0000cd70: 2020 2020 2020 2020 2020 2020 2020 3344                3D
-0000cd80: 204d 4553 4849 4e47 2069 6e20 4c49 4e45   MESHING in LINE
-0000cd90: 4152 2063 6f6e 6669 6775 7261 7469 6f6e  AR configuration
-0000cda0: 730a 2320 2020 2020 2020 2020 2020 2020  s.#             
-0000cdb0: 2020 2020 2020 2020 2020 2020 2020 692e                i.
-0000cdc0: 652e 2044 6973 6372 6574 697a 696e 6720  e. Discretizing 
-0000cdd0: 566f 6c75 6d65 730a 230a 2320 3d3d 3d3d  Volumes.#.# ====
-0000cde0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000cdf0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000ce00: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000cd60: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000cd70: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000cd80: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000cd90: 3d3d 3d0a 230a 2320 2020 2020 2020 2020  ===.#.#         
+0000cda0: 2020 2020 2020 2020 2020 2020 2033 4420               3D 
+0000cdb0: 4d45 5348 494e 4720 696e 204c 494e 4541  MESHING in LINEA
+0000cdc0: 5220 636f 6e66 6967 7572 6174 696f 6e73  R configurations
+0000cdd0: 0a23 2020 2020 2020 2020 2020 2020 2020  .#              
+0000cde0: 2020 2020 2020 2020 2020 2020 2069 2e65               i.e
+0000cdf0: 2e20 4469 7363 7265 7469 7a69 6e67 2056  . Discretizing V
+0000ce00: 6f6c 756d 6573 0a23 0a23 203d 3d3d 3d3d  olumes.#.# =====
 0000ce10: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000ce20: 3d3d 3d3d 3d3d 3d3d 3d3d 0a0a 6465 6620  ==========..def 
-0000ce30: 5f56 6573 5f56 6d65 7368 5f4c 696e 5f53  _Ves_Vmesh_Lin_S
-0000ce40: 7562 4672 6f6d 445f 6379 7468 6f6e 2864  ubFromD_cython(d
-0000ce50: 6f75 626c 6520 6458 2c20 646f 7562 6c65  ouble dX, double
-0000ce60: 2064 592c 2064 6f75 626c 6520 645a 2c0a   dY, double dZ,.
-0000ce70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ce80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ce90: 2020 2064 6f75 626c 655b 3a3a 315d 2058     double[::1] X
-0000cea0: 4d69 6e4d 6178 2c20 646f 7562 6c65 5b3a  MinMax, double[:
-0000ceb0: 3a31 5d20 594d 696e 4d61 782c 0a20 2020  :1] YMinMax,.   
-0000cec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ced0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cee0: 646f 7562 6c65 5b3a 3a31 5d20 5a4d 696e  double[::1] ZMin
-0000cef0: 4d61 782c 0a20 2020 2020 2020 2020 2020  Max,.           
-0000cf00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cf10: 2020 2020 2020 2020 6c69 7374 2044 583d          list DX=
-0000cf20: 4e6f 6e65 2c20 6c69 7374 2044 593d 4e6f  None, list DY=No
-0000cf30: 6e65 2c20 6c69 7374 2044 5a3d 4e6f 6e65  ne, list DZ=None
-0000cf40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000cf50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cf60: 2020 2020 206c 696d 6974 5f76 706f 6c79       limit_vpoly
-0000cf70: 3d4e 6f6e 652c 0a20 2020 2020 2020 2020  =None,.         
+0000ce20: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000ce30: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000ce40: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000ce50: 3d3d 3d3d 3d3d 3d3d 3d0a 0a64 6566 205f  =========..def _
+0000ce60: 5665 735f 566d 6573 685f 4c69 6e5f 5375  Ves_Vmesh_Lin_Su
+0000ce70: 6246 726f 6d44 5f63 7974 686f 6e28 646f  bFromD_cython(do
+0000ce80: 7562 6c65 2064 582c 2064 6f75 626c 6520  uble dX, double 
+0000ce90: 6459 2c20 646f 7562 6c65 2064 5a2c 0a20  dY, double dZ,. 
+0000cea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ceb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cec0: 2020 646f 7562 6c65 5b3a 3a31 5d20 584d    double[::1] XM
+0000ced0: 696e 4d61 782c 2064 6f75 626c 655b 3a3a  inMax, double[::
+0000cee0: 315d 2059 4d69 6e4d 6178 2c0a 2020 2020  1] YMinMax,.    
+0000cef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cf00: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0000cf10: 6f75 626c 655b 3a3a 315d 205a 4d69 6e4d  ouble[::1] ZMinM
+0000cf20: 6178 2c0a 2020 2020 2020 2020 2020 2020  ax,.            
+0000cf30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cf40: 2020 2020 2020 206c 6973 7420 4458 3d4e         list DX=N
+0000cf50: 6f6e 652c 206c 6973 7420 4459 3d4e 6f6e  one, list DY=Non
+0000cf60: 652c 206c 6973 7420 445a 3d4e 6f6e 652c  e, list DZ=None,
+0000cf70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 0000cf80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cf90: 2020 2020 2020 2020 2020 646f 7562 6c65            double
-0000cfa0: 206d 6172 6769 6e3d 5f56 534d 414c 4c29   margin=_VSMALL)
-0000cfb0: 3a0a 2020 2020 2222 2220 5265 7475 726e  :.    """ Return
-0000cfc0: 2074 6865 2064 6573 6972 6564 2073 7562   the desired sub
-0000cfd0: 6d65 7368 2069 6e64 6963 6174 6564 2062  mesh indicated b
-0000cfe0: 7920 7468 6520 6c69 6d69 7473 2028 4458  y the limits (DX
-0000cff0: 2c44 592c 445a 292c 0a20 2020 2066 6f72  ,DY,DZ),.    for
-0000d000: 2074 6865 2064 6573 6972 6564 2072 6573   the desired res
-0000d010: 6f6c 7574 696f 6e20 2864 582c 6459 2c64  olution (dX,dY,d
-0000d020: 5a29 0a20 2020 2022 2222 0a20 2020 2063  Z).    """.    c
-0000d030: 6465 6620 646f 7562 6c65 5b3a 3a31 5d20  def double[::1] 
-0000d040: 582c 2059 2c20 5a0a 2020 2020 6364 6566  X, Y, Z.    cdef
-0000d050: 2064 6f75 626c 6520 6458 722c 2064 5972   double dXr, dYr
-0000d060: 2c20 7265 736f 5f7a 2c20 7265 7333 640a  , reso_z, res3d.
-0000d070: 2020 2020 6364 6566 206e 702e 6e64 6172      cdef np.ndar
-0000d080: 7261 795b 6c6f 6e67 2c6e 6469 6d3d 315d  ray[long,ndim=1]
-0000d090: 2069 6e64 582c 2069 6e64 592c 2069 6e64   indX, indY, ind
-0000d0a0: 5a0a 2020 2020 6364 6566 2069 6e74 204e  Z.    cdef int N
-0000d0b0: 582c 204e 592c 2058 6e2c 2059 6e2c 205a  X, NY, Xn, Yn, Z
-0000d0c0: 6e0a 2020 2020 6364 6566 206e 702e 6e64  n.    cdef np.nd
-0000d0d0: 6172 7261 795b 646f 7562 6c65 2c6e 6469  array[double,ndi
-0000d0e0: 6d3d 325d 2070 7473 0a20 2020 2063 6465  m=2] pts.    cde
-0000d0f0: 6620 6e70 2e6e 6461 7272 6179 5b6c 6f6e  f np.ndarray[lon
-0000d100: 672c 6e64 696d 3d31 5d20 696e 640a 0a20  g,ndim=1] ind.. 
-0000d110: 2020 2023 2047 6574 2074 6865 2061 6374     # Get the act
-0000d120: 7561 6c20 582c 2059 2061 6e64 205a 2072  ual X, Y and Z r
-0000d130: 6573 6f6c 7574 696f 6e73 2061 6e64 206d  esolutions and m
-0000d140: 6573 6820 656c 656d 656e 7473 0a20 2020  esh elements.   
-0000d150: 2058 2c20 6458 722c 2069 6e64 582c 204e   X, dXr, indX, N
-0000d160: 5820 3d20 6469 7363 7265 7469 7a65 5f6c  X = discretize_l
-0000d170: 696e 6531 6428 584d 696e 4d61 782c 2064  ine1d(XMinMax, d
-0000d180: 582c 2044 582c 204c 696d 3d54 7275 652c  X, DX, Lim=True,
-0000d190: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d1c0: 206d 6172 6769 6e3d 6d61 7267 696e 290a   margin=margin).
-0000d1d0: 2020 2020 592c 2064 5972 2c20 696e 6459      Y, dYr, indY
-0000d1e0: 2c20 4e59 203d 2064 6973 6372 6574 697a  , NY = discretiz
-0000d1f0: 655f 6c69 6e65 3164 2859 4d69 6e4d 6178  e_line1d(YMinMax
-0000d200: 2c20 6459 2c20 4459 2c20 4c69 6d3d 5472  , dY, DY, Lim=Tr
-0000d210: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
-0000d220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d240: 2020 2020 6d61 7267 696e 3d6d 6172 6769      margin=margi
-0000d250: 6e29 0a20 2020 205a 2c20 7265 736f 5f7a  n).    Z, reso_z
-0000d260: 2c20 696e 645a 2c20 5f20 3d20 6469 7363  , indZ, _ = disc
-0000d270: 7265 7469 7a65 5f6c 696e 6531 6428 5a4d  retize_line1d(ZM
-0000d280: 696e 4d61 782c 2064 5a2c 2044 5a2c 204c  inMax, dZ, DZ, L
-0000d290: 696d 3d54 7275 652c 0a20 2020 2020 2020  im=True,.       
-0000d2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d2c0: 2020 2020 2020 2020 206d 6172 6769 6e3d           margin=
-0000d2d0: 6d61 7267 696e 290a 2020 2020 586e 2c20  margin).    Xn, 
-0000d2e0: 596e 2c20 5a6e 203d 206c 656e 2858 292c  Yn, Zn = len(X),
-0000d2f0: 206c 656e 2859 292c 206c 656e 285a 290a   len(Y), len(Z).
-0000d300: 0a20 2020 2070 7473 203d 206e 702e 6172  .    pts = np.ar
-0000d310: 7261 7928 5b6e 702e 7469 6c65 2858 2c28  ray([np.tile(X,(
-0000d320: 596e 2a5a 6e2c 3129 292e 666c 6174 7465  Yn*Zn,1)).flatte
-0000d330: 6e28 292c 0a20 2020 2020 2020 2020 2020  n(),.           
-0000d340: 2020 2020 2020 2020 206e 702e 7469 6c65           np.tile
-0000d350: 286e 702e 7265 7065 6174 2859 2c58 6e29  (np.repeat(Y,Xn)
-0000d360: 2c28 5a6e 2c31 2929 2e66 6c61 7474 656e  ,(Zn,1)).flatten
-0000d370: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
-0000d380: 2020 2020 2020 2020 6e70 2e72 6570 6561          np.repea
-0000d390: 7428 5a2c 586e 2a59 6e29 5d29 0a20 2020  t(Z,Xn*Yn)]).   
-0000d3a0: 2069 6e64 203d 206e 702e 7265 7065 6174   ind = np.repeat
-0000d3b0: 284e 582a 4e59 2a69 6e64 5a2c 586e 2a59  (NX*NY*indZ,Xn*Y
-0000d3c0: 6e29 202b 205c 0a20 2020 2020 206e 702e  n) + \.      np.
-0000d3d0: 7469 6c65 286e 702e 7265 7065 6174 284e  tile(np.repeat(N
-0000d3e0: 582a 696e 6459 2c58 6e29 2c28 5a6e 2c31  X*indY,Xn),(Zn,1
-0000d3f0: 2929 2e66 6c61 7474 656e 2829 202b 205c  )).flatten() + \
-0000d400: 0a20 2020 2020 206e 702e 7469 6c65 2869  .      np.tile(i
-0000d410: 6e64 582c 2859 6e2a 5a6e 2c31 2929 2e66  ndX,(Yn*Zn,1)).f
-0000d420: 6c61 7474 656e 2829 0a20 2020 2072 6573  latten().    res
-0000d430: 3364 203d 2064 5872 2a64 5972 2a72 6573  3d = dXr*dYr*res
-0000d440: 6f5f 7a0a 0a20 2020 2069 6620 6c69 6d69  o_z..    if limi
-0000d450: 745f 7670 6f6c 7920 6973 206e 6f74 204e  t_vpoly is not N
-0000d460: 6f6e 653a 0a20 2020 2020 2020 2069 6e64  one:.        ind
-0000d470: 696e 203d 2050 6174 6828 6c69 6d69 745f  in = Path(limit_
-0000d480: 7670 6f6c 792e 5429 2e63 6f6e 7461 696e  vpoly.T).contain
-0000d490: 735f 706f 696e 7473 2870 7473 5b31 3a2c  s_points(pts[1:,
-0000d4a0: 3a5d 2e54 2c0a 2020 2020 2020 2020 2020  :].T,.          
-0000d4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d4d0: 2020 2020 2020 2020 2020 7472 616e 7366            transf
-0000d4e0: 6f72 6d3d 4e6f 6e65 2c0a 2020 2020 2020  orm=None,.      
+0000cf90: 2020 2020 6c69 6d69 745f 7670 6f6c 793d      limit_vpoly=
+0000cfa0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+0000cfb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cfc0: 2020 2020 2020 2020 2064 6f75 626c 6520           double 
+0000cfd0: 6d61 7267 696e 3d5f 5653 4d41 4c4c 293a  margin=_VSMALL):
+0000cfe0: 0a20 2020 2022 2222 2052 6574 7572 6e20  .    """ Return 
+0000cff0: 7468 6520 6465 7369 7265 6420 7375 626d  the desired subm
+0000d000: 6573 6820 696e 6469 6361 7465 6420 6279  esh indicated by
+0000d010: 2074 6865 206c 696d 6974 7320 2844 582c   the limits (DX,
+0000d020: 4459 2c44 5a29 2c0a 2020 2020 666f 7220  DY,DZ),.    for 
+0000d030: 7468 6520 6465 7369 7265 6420 7265 736f  the desired reso
+0000d040: 6c75 7469 6f6e 2028 6458 2c64 592c 645a  lution (dX,dY,dZ
+0000d050: 290a 2020 2020 2222 220a 2020 2020 6364  ).    """.    cd
+0000d060: 6566 2064 6f75 626c 655b 3a3a 315d 2058  ef double[::1] X
+0000d070: 2c20 592c 205a 0a20 2020 2063 6465 6620  , Y, Z.    cdef 
+0000d080: 646f 7562 6c65 2064 5872 2c20 6459 722c  double dXr, dYr,
+0000d090: 2072 6573 6f5f 7a2c 2072 6573 3364 0a20   reso_z, res3d. 
+0000d0a0: 2020 2063 6465 6620 6e70 2e6e 6461 7272     cdef np.ndarr
+0000d0b0: 6179 5b6c 6f6e 672c 6e64 696d 3d31 5d20  ay[long,ndim=1] 
+0000d0c0: 696e 6458 2c20 696e 6459 2c20 696e 645a  indX, indY, indZ
+0000d0d0: 0a20 2020 2063 6465 6620 696e 7420 4e58  .    cdef int NX
+0000d0e0: 2c20 4e59 2c20 586e 2c20 596e 2c20 5a6e  , NY, Xn, Yn, Zn
+0000d0f0: 0a20 2020 2063 6465 6620 6e70 2e6e 6461  .    cdef np.nda
+0000d100: 7272 6179 5b64 6f75 626c 652c 6e64 696d  rray[double,ndim
+0000d110: 3d32 5d20 7074 730a 2020 2020 6364 6566  =2] pts.    cdef
+0000d120: 206e 702e 6e64 6172 7261 795b 6c6f 6e67   np.ndarray[long
+0000d130: 2c6e 6469 6d3d 315d 2069 6e64 0a0a 2020  ,ndim=1] ind..  
+0000d140: 2020 2320 4765 7420 7468 6520 6163 7475    # Get the actu
+0000d150: 616c 2058 2c20 5920 616e 6420 5a20 7265  al X, Y and Z re
+0000d160: 736f 6c75 7469 6f6e 7320 616e 6420 6d65  solutions and me
+0000d170: 7368 2065 6c65 6d65 6e74 730a 2020 2020  sh elements.    
+0000d180: 582c 2064 5872 2c20 696e 6458 2c20 4e58  X, dXr, indX, NX
+0000d190: 203d 2064 6973 6372 6574 697a 655f 6c69   = discretize_li
+0000d1a0: 6e65 3164 2858 4d69 6e4d 6178 2c20 6458  ne1d(XMinMax, dX
+0000d1b0: 2c20 4458 2c20 4c69 6d3d 5472 7565 2c0a  , DX, Lim=True,.
+0000d1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d1f0: 6d61 7267 696e 3d6d 6172 6769 6e29 0a20  margin=margin). 
+0000d200: 2020 2059 2c20 6459 722c 2069 6e64 592c     Y, dYr, indY,
+0000d210: 204e 5920 3d20 6469 7363 7265 7469 7a65   NY = discretize
+0000d220: 5f6c 696e 6531 6428 594d 696e 4d61 782c  _line1d(YMinMax,
+0000d230: 2064 592c 2044 592c 204c 696d 3d54 7275   dY, DY, Lim=Tru
+0000d240: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+0000d250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d270: 2020 206d 6172 6769 6e3d 6d61 7267 696e     margin=margin
+0000d280: 290a 2020 2020 5a2c 2072 6573 6f5f 7a2c  ).    Z, reso_z,
+0000d290: 2069 6e64 5a2c 205f 203d 2064 6973 6372   indZ, _ = discr
+0000d2a0: 6574 697a 655f 6c69 6e65 3164 285a 4d69  etize_line1d(ZMi
+0000d2b0: 6e4d 6178 2c20 645a 2c20 445a 2c20 4c69  nMax, dZ, DZ, Li
+0000d2c0: 6d3d 5472 7565 2c0a 2020 2020 2020 2020  m=True,.        
+0000d2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d2f0: 2020 2020 2020 2020 6d61 7267 696e 3d6d          margin=m
+0000d300: 6172 6769 6e29 0a20 2020 2058 6e2c 2059  argin).    Xn, Y
+0000d310: 6e2c 205a 6e20 3d20 6c65 6e28 5829 2c20  n, Zn = len(X), 
+0000d320: 6c65 6e28 5929 2c20 6c65 6e28 5a29 0a0a  len(Y), len(Z)..
+0000d330: 2020 2020 7074 7320 3d20 6e70 2e61 7272      pts = np.arr
+0000d340: 6179 285b 6e70 2e74 696c 6528 582c 2859  ay([np.tile(X,(Y
+0000d350: 6e2a 5a6e 2c31 2929 2e66 6c61 7474 656e  n*Zn,1)).flatten
+0000d360: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
+0000d370: 2020 2020 2020 2020 6e70 2e74 696c 6528          np.tile(
+0000d380: 6e70 2e72 6570 6561 7428 592c 586e 292c  np.repeat(Y,Xn),
+0000d390: 285a 6e2c 3129 292e 666c 6174 7465 6e28  (Zn,1)).flatten(
+0000d3a0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0000d3b0: 2020 2020 2020 206e 702e 7265 7065 6174         np.repeat
+0000d3c0: 285a 2c58 6e2a 596e 295d 290a 2020 2020  (Z,Xn*Yn)]).    
+0000d3d0: 696e 6420 3d20 6e70 2e72 6570 6561 7428  ind = np.repeat(
+0000d3e0: 4e58 2a4e 592a 696e 645a 2c58 6e2a 596e  NX*NY*indZ,Xn*Yn
+0000d3f0: 2920 2b20 5c0a 2020 2020 2020 6e70 2e74  ) + \.      np.t
+0000d400: 696c 6528 6e70 2e72 6570 6561 7428 4e58  ile(np.repeat(NX
+0000d410: 2a69 6e64 592c 586e 292c 285a 6e2c 3129  *indY,Xn),(Zn,1)
+0000d420: 292e 666c 6174 7465 6e28 2920 2b20 5c0a  ).flatten() + \.
+0000d430: 2020 2020 2020 6e70 2e74 696c 6528 696e        np.tile(in
+0000d440: 6458 2c28 596e 2a5a 6e2c 3129 292e 666c  dX,(Yn*Zn,1)).fl
+0000d450: 6174 7465 6e28 290a 2020 2020 7265 7333  atten().    res3
+0000d460: 6420 3d20 6458 722a 6459 722a 7265 736f  d = dXr*dYr*reso
+0000d470: 5f7a 0a0a 2020 2020 6966 206c 696d 6974  _z..    if limit
+0000d480: 5f76 706f 6c79 2069 7320 6e6f 7420 4e6f  _vpoly is not No
+0000d490: 6e65 3a0a 2020 2020 2020 2020 696e 6469  ne:.        indi
+0000d4a0: 6e20 3d20 5061 7468 286c 696d 6974 5f76  n = Path(limit_v
+0000d4b0: 706f 6c79 2e54 292e 636f 6e74 6169 6e73  poly.T).contains
+0000d4c0: 5f70 6f69 6e74 7328 7074 735b 313a 2c3a  _points(pts[1:,:
+0000d4d0: 5d2e 542c 0a20 2020 2020 2020 2020 2020  ].T,.           
+0000d4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0000d4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d510: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-0000d520: 6469 7573 3d30 2e30 290a 2020 2020 2020  dius=0.0).      
-0000d530: 2020 7074 732c 2069 6e64 203d 2070 7473    pts, ind = pts
-0000d540: 5b3a 2c69 6e64 696e 5d2c 2069 6e64 5b69  [:,indin], ind[i
-0000d550: 6e64 696e 5d0a 0a20 2020 2072 6574 7572  ndin]..    retur
-0000d560: 6e20 7074 732c 2072 6573 3364 2c20 696e  n pts, res3d, in
-0000d570: 642e 6173 7479 7065 2869 6e74 292c 2064  d.astype(int), d
-0000d580: 5872 2c20 6459 722c 2072 6573 6f5f 7a0a  Xr, dYr, reso_z.
-0000d590: 0a0a 6465 6620 5f56 6573 5f56 6d65 7368  ..def _Ves_Vmesh
-0000d5a0: 5f4c 696e 5f53 7562 4672 6f6d 496e 645f  _Lin_SubFromInd_
-0000d5b0: 6379 7468 6f6e 2864 6f75 626c 6520 6458  cython(double dX
-0000d5c0: 2c20 646f 7562 6c65 2064 592c 2064 6f75  , double dY, dou
-0000d5d0: 626c 6520 645a 2c0a 2020 2020 2020 2020  ble dZ,.        
-0000d5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d5f0: 2020 2020 2020 2020 2020 2020 2064 6f75               dou
-0000d600: 626c 655b 3a3a 315d 2058 4d69 6e4d 6178  ble[::1] XMinMax
-0000d610: 2c20 646f 7562 6c65 5b3a 3a31 5d20 594d  , double[::1] YM
-0000d620: 696e 4d61 782c 0a20 2020 2020 2020 2020  inMax,.         
-0000d630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d640: 2020 2020 2020 2020 2020 2020 646f 7562              doub
-0000d650: 6c65 5b3a 3a31 5d20 5a4d 696e 4d61 782c  le[::1] ZMinMax,
-0000d660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d680: 2020 2020 2020 6e70 2e6e 6461 7272 6179        np.ndarray
-0000d690: 5b6c 6f6e 672c 6e64 696d 3d31 5d20 696e  [long,ndim=1] in
-0000d6a0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
-0000d6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d6c0: 2020 2020 2020 2020 646f 7562 6c65 206d          double m
-0000d6d0: 6172 6769 6e3d 5f56 534d 414c 4c29 3a0a  argin=_VSMALL):.
-0000d6e0: 2020 2020 2222 2220 5265 7475 726e 2074      """ Return t
-0000d6f0: 6865 2064 6573 6972 6564 2073 7562 6d65  he desired subme
-0000d700: 7368 2069 6e64 6963 6174 6564 2062 7920  sh indicated by 
-0000d710: 7468 6520 6c69 6d69 7473 2028 4458 2c44  the limits (DX,D
-0000d720: 592c 445a 292c 0a20 2020 2066 6f72 2074  Y,DZ),.    for t
-0000d730: 6865 2064 6573 6972 6564 2072 6573 6f6c  he desired resol
-0000d740: 7574 696f 6e20 2864 582c 6459 2c64 5a29  ution (dX,dY,dZ)
-0000d750: 0a20 2020 2022 2222 0a0a 2020 2020 6364  .    """..    cd
-0000d760: 6566 206e 702e 6e64 6172 7261 795b 646f  ef np.ndarray[do
-0000d770: 7562 6c65 2c6e 6469 6d3d 315d 2058 2c20  uble,ndim=1] X, 
-0000d780: 592c 205a 0a20 2020 2063 6465 6620 646f  Y, Z.    cdef do
-0000d790: 7562 6c65 2064 5872 2c20 6459 722c 2072  uble dXr, dYr, r
-0000d7a0: 6573 6f5f 7a2c 2072 6573 3364 0a20 2020  eso_z, res3d.   
-0000d7b0: 2063 6465 6620 6e70 2e6e 6461 7272 6179   cdef np.ndarray
-0000d7c0: 5b6c 6f6e 672c 6e64 696d 3d31 5d20 696e  [long,ndim=1] in
-0000d7d0: 6458 2c20 696e 6459 2c20 696e 645a 0a20  dX, indY, indZ. 
-0000d7e0: 2020 2063 6465 6620 696e 7420 4e58 2c20     cdef int NX, 
-0000d7f0: 4e59 0a20 2020 2063 6465 6620 6e70 2e6e  NY.    cdef np.n
-0000d800: 6461 7272 6179 5b64 6f75 626c 652c 6e64  darray[double,nd
-0000d810: 696d 3d32 5d20 7074 730a 0a20 2020 2023  im=2] pts..    #
-0000d820: 2047 6574 2074 6865 2061 6374 7561 6c20   Get the actual 
-0000d830: 582c 2059 2061 6e64 205a 2072 6573 6f6c  X, Y and Z resol
-0000d840: 7574 696f 6e73 2061 6e64 206d 6573 6820  utions and mesh 
-0000d850: 656c 656d 656e 7473 0a20 2020 2058 2c20  elements.    X, 
-0000d860: 6458 722c 205f 2c20 4e58 203d 2064 6973  dXr, _, NX = dis
-0000d870: 6372 6574 697a 655f 6c69 6e65 3164 2858  cretize_line1d(X
-0000d880: 4d69 6e4d 6178 2c20 6458 2c20 4e6f 6e65  MinMax, dX, None
-0000d890: 2c20 4c69 6d3d 5472 7565 2c0a 2020 2020  , Lim=True,.    
-0000d8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d8c0: 2020 2020 2020 2020 2020 206d 6172 6769             margi
-0000d8d0: 6e3d 6d61 7267 696e 290a 2020 2020 592c  n=margin).    Y,
-0000d8e0: 2064 5972 2c20 5f2c 204e 5920 3d20 6469   dYr, _, NY = di
-0000d8f0: 7363 7265 7469 7a65 5f6c 696e 6531 6428  scretize_line1d(
-0000d900: 594d 696e 4d61 782c 2064 592c 204e 6f6e  YMinMax, dY, Non
-0000d910: 652c 204c 696d 3d54 7275 652c 0a20 2020  e, Lim=True,.   
-0000d920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d940: 2020 2020 2020 2020 2020 2020 6d61 7267              marg
-0000d950: 696e 3d6d 6172 6769 6e29 0a20 2020 205a  in=margin).    Z
-0000d960: 2c20 7265 736f 5f7a 2c20 5f2c 205f 203d  , reso_z, _, _ =
-0000d970: 2064 6973 6372 6574 697a 655f 6c69 6e65   discretize_line
-0000d980: 3164 285a 4d69 6e4d 6178 2c20 645a 2c20  1d(ZMinMax, dZ, 
-0000d990: 4e6f 6e65 2c20 4c69 6d3d 5472 7565 2c0a  None, Lim=True,.
-0000d9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d9c0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0000d9d0: 6172 6769 6e3d 6d61 7267 696e 290a 0a20  argin=margin).. 
-0000d9e0: 2020 2069 6e64 5a20 3d20 696e 6420 2f2f     indZ = ind //
-0000d9f0: 2028 4e58 2a4e 5929 0a20 2020 2069 6e64   (NX*NY).    ind
-0000da00: 5920 3d20 2869 6e64 202d 204e 582a 4e59  Y = (ind - NX*NY
-0000da10: 2a69 6e64 5a29 202f 2f20 4e58 0a20 2020  *indZ) // NX.   
-0000da20: 2069 6e64 5820 3d20 696e 6420 2d20 4e58   indX = ind - NX
-0000da30: 2a4e 592a 696e 645a 202d 204e 582a 696e  *NY*indZ - NX*in
-0000da40: 6459 0a20 2020 2070 7473 203d 206e 702e  dY.    pts = np.
-0000da50: 6172 7261 7928 5b58 5b69 6e64 582e 6173  array([X[indX.as
-0000da60: 7479 7065 2869 6e74 295d 2c0a 2020 2020  type(int)],.    
-0000da70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000da80: 595b 696e 6459 2e61 7374 7970 6528 696e  Y[indY.astype(in
-0000da90: 7429 5d2c 0a20 2020 2020 2020 2020 2020  t)],.           
-0000daa0: 2020 2020 2020 2020 205a 5b69 6e64 5a2e           Z[indZ.
-0000dab0: 6173 7479 7065 2869 6e74 295d 5d29 0a20  astype(int)]]). 
-0000dac0: 2020 2072 6573 3364 203d 2064 5872 2a64     res3d = dXr*d
-0000dad0: 5972 2a72 6573 6f5f 7a0a 0a20 2020 2072  Yr*reso_z..    r
-0000dae0: 6574 7572 6e20 7074 732c 2072 6573 3364  eturn pts, res3d
-0000daf0: 2c20 6458 722c 2064 5972 2c20 7265 736f  , dXr, dYr, reso
-0000db00: 5f7a 0a0a 0a0a 2323 2323 2323 2323 2323  _z....##########
-0000db10: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000db20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000db30: 2323 2323 2323 2323 2323 2323 2323 0a23  ##############.#
+0000d500: 2020 2020 2020 2020 2074 7261 6e73 666f           transfo
+0000d510: 726d 3d4e 6f6e 652c 0a20 2020 2020 2020  rm=None,.       
+0000d520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d540: 2020 2020 2020 2020 2020 2020 2072 6164               rad
+0000d550: 6975 733d 302e 3029 0a20 2020 2020 2020  ius=0.0).       
+0000d560: 2070 7473 2c20 696e 6420 3d20 7074 735b   pts, ind = pts[
+0000d570: 3a2c 696e 6469 6e5d 2c20 696e 645b 696e  :,indin], ind[in
+0000d580: 6469 6e5d 0a0a 2020 2020 7265 7475 726e  din]..    return
+0000d590: 2070 7473 2c20 7265 7333 642c 2069 6e64   pts, res3d, ind
+0000d5a0: 2e61 7374 7970 6528 696e 7429 2c20 6458  .astype(int), dX
+0000d5b0: 722c 2064 5972 2c20 7265 736f 5f7a 0a0a  r, dYr, reso_z..
+0000d5c0: 0a64 6566 205f 5665 735f 566d 6573 685f  .def _Ves_Vmesh_
+0000d5d0: 4c69 6e5f 5375 6246 726f 6d49 6e64 5f63  Lin_SubFromInd_c
+0000d5e0: 7974 686f 6e28 646f 7562 6c65 2064 582c  ython(double dX,
+0000d5f0: 2064 6f75 626c 6520 6459 2c20 646f 7562   double dY, doub
+0000d600: 6c65 2064 5a2c 0a20 2020 2020 2020 2020  le dZ,.         
+0000d610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d620: 2020 2020 2020 2020 2020 2020 646f 7562              doub
+0000d630: 6c65 5b3a 3a31 5d20 584d 696e 4d61 782c  le[::1] XMinMax,
+0000d640: 2064 6f75 626c 655b 3a3a 315d 2059 4d69   double[::1] YMi
+0000d650: 6e4d 6178 2c0a 2020 2020 2020 2020 2020  nMax,.          
+0000d660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d670: 2020 2020 2020 2020 2020 2064 6f75 626c             doubl
+0000d680: 655b 3a3a 315d 205a 4d69 6e4d 6178 2c0a  e[::1] ZMinMax,.
+0000d690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d6b0: 2020 2020 206e 702e 6e64 6172 7261 795b       np.ndarray[
+0000d6c0: 6c6f 6e67 2c6e 6469 6d3d 315d 2069 6e64  long,ndim=1] ind
+0000d6d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000d6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d6f0: 2020 2020 2020 2064 6f75 626c 6520 6d61         double ma
+0000d700: 7267 696e 3d5f 5653 4d41 4c4c 293a 0a20  rgin=_VSMALL):. 
+0000d710: 2020 2022 2222 2052 6574 7572 6e20 7468     """ Return th
+0000d720: 6520 6465 7369 7265 6420 7375 626d 6573  e desired submes
+0000d730: 6820 696e 6469 6361 7465 6420 6279 2074  h indicated by t
+0000d740: 6865 206c 696d 6974 7320 2844 582c 4459  he limits (DX,DY
+0000d750: 2c44 5a29 2c0a 2020 2020 666f 7220 7468  ,DZ),.    for th
+0000d760: 6520 6465 7369 7265 6420 7265 736f 6c75  e desired resolu
+0000d770: 7469 6f6e 2028 6458 2c64 592c 645a 290a  tion (dX,dY,dZ).
+0000d780: 2020 2020 2222 220a 0a20 2020 2063 6465      """..    cde
+0000d790: 6620 6e70 2e6e 6461 7272 6179 5b64 6f75  f np.ndarray[dou
+0000d7a0: 626c 652c 6e64 696d 3d31 5d20 582c 2059  ble,ndim=1] X, Y
+0000d7b0: 2c20 5a0a 2020 2020 6364 6566 2064 6f75  , Z.    cdef dou
+0000d7c0: 626c 6520 6458 722c 2064 5972 2c20 7265  ble dXr, dYr, re
+0000d7d0: 736f 5f7a 2c20 7265 7333 640a 2020 2020  so_z, res3d.    
+0000d7e0: 6364 6566 206e 702e 6e64 6172 7261 795b  cdef np.ndarray[
+0000d7f0: 6c6f 6e67 2c6e 6469 6d3d 315d 2069 6e64  long,ndim=1] ind
+0000d800: 582c 2069 6e64 592c 2069 6e64 5a0a 2020  X, indY, indZ.  
+0000d810: 2020 6364 6566 2069 6e74 204e 582c 204e    cdef int NX, N
+0000d820: 590a 2020 2020 6364 6566 206e 702e 6e64  Y.    cdef np.nd
+0000d830: 6172 7261 795b 646f 7562 6c65 2c6e 6469  array[double,ndi
+0000d840: 6d3d 325d 2070 7473 0a0a 2020 2020 2320  m=2] pts..    # 
+0000d850: 4765 7420 7468 6520 6163 7475 616c 2058  Get the actual X
+0000d860: 2c20 5920 616e 6420 5a20 7265 736f 6c75  , Y and Z resolu
+0000d870: 7469 6f6e 7320 616e 6420 6d65 7368 2065  tions and mesh e
+0000d880: 6c65 6d65 6e74 730a 2020 2020 582c 2064  lements.    X, d
+0000d890: 5872 2c20 5f2c 204e 5820 3d20 6469 7363  Xr, _, NX = disc
+0000d8a0: 7265 7469 7a65 5f6c 696e 6531 6428 584d  retize_line1d(XM
+0000d8b0: 696e 4d61 782c 2064 582c 204e 6f6e 652c  inMax, dX, None,
+0000d8c0: 204c 696d 3d54 7275 652c 0a20 2020 2020   Lim=True,.     
+0000d8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d8f0: 2020 2020 2020 2020 2020 6d61 7267 696e            margin
+0000d900: 3d6d 6172 6769 6e29 0a20 2020 2059 2c20  =margin).    Y, 
+0000d910: 6459 722c 205f 2c20 4e59 203d 2064 6973  dYr, _, NY = dis
+0000d920: 6372 6574 697a 655f 6c69 6e65 3164 2859  cretize_line1d(Y
+0000d930: 4d69 6e4d 6178 2c20 6459 2c20 4e6f 6e65  MinMax, dY, None
+0000d940: 2c20 4c69 6d3d 5472 7565 2c0a 2020 2020  , Lim=True,.    
+0000d950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d970: 2020 2020 2020 2020 2020 206d 6172 6769             margi
+0000d980: 6e3d 6d61 7267 696e 290a 2020 2020 5a2c  n=margin).    Z,
+0000d990: 2072 6573 6f5f 7a2c 205f 2c20 5f20 3d20   reso_z, _, _ = 
+0000d9a0: 6469 7363 7265 7469 7a65 5f6c 696e 6531  discretize_line1
+0000d9b0: 6428 5a4d 696e 4d61 782c 2064 5a2c 204e  d(ZMinMax, dZ, N
+0000d9c0: 6f6e 652c 204c 696d 3d54 7275 652c 0a20  one, Lim=True,. 
+0000d9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d9f0: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
+0000da00: 7267 696e 3d6d 6172 6769 6e29 0a0a 2020  rgin=margin)..  
+0000da10: 2020 696e 645a 203d 2069 6e64 202f 2f20    indZ = ind // 
+0000da20: 284e 582a 4e59 290a 2020 2020 696e 6459  (NX*NY).    indY
+0000da30: 203d 2028 696e 6420 2d20 4e58 2a4e 592a   = (ind - NX*NY*
+0000da40: 696e 645a 2920 2f2f 204e 580a 2020 2020  indZ) // NX.    
+0000da50: 696e 6458 203d 2069 6e64 202d 204e 582a  indX = ind - NX*
+0000da60: 4e59 2a69 6e64 5a20 2d20 4e58 2a69 6e64  NY*indZ - NX*ind
+0000da70: 590a 2020 2020 7074 7320 3d20 6e70 2e61  Y.    pts = np.a
+0000da80: 7272 6179 285b 585b 696e 6458 2e61 7374  rray([X[indX.ast
+0000da90: 7970 6528 696e 7429 5d2c 0a20 2020 2020  ype(int)],.     
+0000daa0: 2020 2020 2020 2020 2020 2020 2020 2059                 Y
+0000dab0: 5b69 6e64 592e 6173 7479 7065 2869 6e74  [indY.astype(int
+0000dac0: 295d 2c0a 2020 2020 2020 2020 2020 2020  )],.            
+0000dad0: 2020 2020 2020 2020 5a5b 696e 645a 2e61          Z[indZ.a
+0000dae0: 7374 7970 6528 696e 7429 5d5d 290a 2020  stype(int)]]).  
+0000daf0: 2020 7265 7333 6420 3d20 6458 722a 6459    res3d = dXr*dY
+0000db00: 722a 7265 736f 5f7a 0a0a 2020 2020 7265  r*reso_z..    re
+0000db10: 7475 726e 2070 7473 2c20 7265 7333 642c  turn pts, res3d,
+0000db20: 2064 5872 2c20 6459 722c 2072 6573 6f5f   dXr, dYr, reso_
+0000db30: 7a0a 0a0a 0a23 2323 2323 2323 2323 2323  z....###########
 0000db40: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 0000db50: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000db60: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000db70: 2323 2323 2323 230a 2320 2020 2020 2020  #######.#       
-0000db80: 4d65 7368 696e 6720 2d20 5375 7266 6163  Meshing - Surfac
-0000db90: 6520 2d20 546f 720a 2323 2323 2323 2323  e - Tor.########
-0000dba0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000dbb0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000dbc0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000dbd0: 0a0a 6465 6620 5f67 6574 426f 756e 6473  ..def _getBounds
-0000dbe0: 696e 7465 7232 416e 6753 6567 2862 6f6f  inter2AngSeg(boo
-0000dbf0: 6c20 4675 6c6c 2c20 646f 7562 6c65 2050  l Full, double P
-0000dc00: 6869 302c 2064 6f75 626c 6520 5068 6931  hi0, double Phi1
-0000dc10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000dc20: 2020 2020 2020 2020 2020 2020 2064 6f75               dou
-0000dc30: 626c 6520 4450 6869 302c 2064 6f75 626c  ble DPhi0, doubl
-0000dc40: 6520 4450 6869 3129 3a0a 2020 2020 2222  e DPhi1):.    ""
-0000dc50: 2220 5265 7475 726e 2069 6e74 6572 3d54  " Return inter=T
-0000dc60: 7275 6520 6966 2061 6e20 696e 7465 7273  rue if an inters
-0000dc70: 6563 7469 6f6e 2065 7869 7374 2028 616c  ection exist (al
-0000dc80: 6c20 616e 676c 6573 2069 6e20 7261 6469  l angles in radi
-0000dc90: 616e 730a 2020 2020 696e 205b 2d70 693b  ans.    in [-pi;
-0000dca0: 7069 5d29 0a0a 2020 2020 4966 2069 6e74  pi])..    If int
-0000dcb0: 6572 2c20 7265 7475 726e 2042 6f75 6e64  er, return Bound
-0000dcc0: 732c 2061 206c 6973 7420 6f66 2074 7570  s, a list of tup
-0000dcd0: 6c65 7320 696e 6469 6361 7469 6e67 2074  les indicating t
-0000dce0: 6865 2073 6567 6d65 6e74 7320 6465 6669  he segments defi
-0000dcf0: 6e69 6e67 0a20 2020 2074 6865 2069 6e74  ning.    the int
-0000dd00: 6572 7365 6374 696f 6e2c 2077 6974 680a  ersection, with.
-0000dd10: 2020 2020 5468 6520 696e 7465 7276 616c      The interval
-0000dd20: 7320 6172 6520 6f72 6465 7265 6420 6672  s are ordered fr
-0000dd30: 6f6d 206c 6f77 6573 7420 696e 6465 7820  om lowest index 
-0000dd40: 746f 2068 6967 6865 7374 2069 6e64 6578  to highest index
-0000dd50: 2028 7769 7468 2072 6573 7065 6374 0a20   (with respect. 
-0000dd60: 2020 2074 6f20 5b50 6869 302c 5068 6931     to [Phi0,Phi1
-0000dd70: 5d29 0a20 2020 2022 2222 0a20 2020 2069  ]).    """.    i
-0000dd80: 6620 4675 6c6c 3a0a 2020 2020 2020 2020  f Full:.        
-0000dd90: 426f 756e 6473 203d 205b 5b44 5068 6930  Bounds = [[DPhi0
-0000dda0: 2c44 5068 6931 5d5d 2069 6620 4450 6869  ,DPhi1]] if DPhi
-0000ddb0: 303c 3d44 5068 6931 2065 6c73 6520 5b5b  0<=DPhi1 else [[
-0000ddc0: 2d63 5f70 692c 4450 6869 315d 2c5b 4450  -c_pi,DPhi1],[DP
-0000ddd0: 6869 302c 635f 7069 5d5d 0a20 2020 2020  hi0,c_pi]].     
-0000dde0: 2020 2069 6e74 6572 203d 2054 7275 650a     inter = True.
-0000ddf0: 2020 2020 2020 2020 4661 6365 7320 3d20          Faces = 
-0000de00: 5b4e 6f6e 652c 204e 6f6e 655d 0a0a 2020  [None, None]..  
-0000de10: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0000de20: 696e 7465 722c 2042 6f75 6e64 732c 2046  inter, Bounds, F
-0000de30: 6163 6573 203d 2046 616c 7365 2c20 4e6f  aces = False, No
-0000de40: 6e65 2c20 5b46 616c 7365 2c46 616c 7365  ne, [False,False
-0000de50: 5d0a 2020 2020 2020 2020 6966 2050 6869  ].        if Phi
-0000de60: 303c 3d50 6869 313a 0a20 2020 2020 2020  0<=Phi1:.       
-0000de70: 2020 2020 2069 6620 4450 6869 303c 3d44       if DPhi0<=D
-0000de80: 5068 6931 3a0a 2020 2020 2020 2020 2020  Phi1:.          
-0000de90: 2020 2020 2020 6966 2044 5068 6930 3c3d        if DPhi0<=
-0000dea0: 5068 6931 2061 6e64 2044 5068 6931 3e3d  Phi1 and DPhi1>=
-0000deb0: 5068 6930 3a0a 2020 2020 2020 2020 2020  Phi0:.          
-0000dec0: 2020 2020 2020 2020 2020 696e 7465 7220            inter 
-0000ded0: 3d20 5472 7565 0a20 2020 2020 2020 2020  = True.         
-0000dee0: 2020 2020 2020 2020 2020 2042 6f75 6e64             Bound
-0000def0: 7320 3d20 5b5b 4e6f 6e65 2c4e 6f6e 655d  s = [[None,None]
-0000df00: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0000df10: 2020 2020 2020 426f 756e 6473 5b30 5d5b        Bounds[0][
-0000df20: 305d 203d 2050 6869 3020 6966 2044 5068  0] = Phi0 if DPh
-0000df30: 6930 3c3d 5068 6930 2065 6c73 6520 4450  i0<=Phi0 else DP
-0000df40: 6869 300a 2020 2020 2020 2020 2020 2020  hi0.            
-0000df50: 2020 2020 2020 2020 426f 756e 6473 5b30          Bounds[0
-0000df60: 5d5b 315d 203d 2050 6869 3120 6966 2044  ][1] = Phi1 if D
-0000df70: 5068 6931 3e3d 5068 6931 2065 6c73 6520  Phi1>=Phi1 else 
-0000df80: 4450 6869 310a 2020 2020 2020 2020 2020  DPhi1.          
-0000df90: 2020 2020 2020 2020 2020 4661 6365 735b            Faces[
-0000dfa0: 305d 203d 2044 5068 6930 3c3d 5068 6930  0] = DPhi0<=Phi0
-0000dfb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000dfc0: 2020 2020 2046 6163 6573 5b31 5d20 3d20       Faces[1] = 
-0000dfd0: 4450 6869 313e 3d50 6869 310a 2020 2020  DPhi1>=Phi1.    
-0000dfe0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0000dff0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0000e000: 2044 5068 6930 3c3d 5068 6931 206f 7220   DPhi0<=Phi1 or 
-0000e010: 4450 6869 313e 3d50 6869 303a 0a20 2020  DPhi1>=Phi0:.   
-0000e020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e030: 2069 6e74 6572 203d 2054 7275 650a 2020   inter = True.  
-0000e040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e050: 2020 6966 2044 5068 6930 3c3d 5068 6931    if DPhi0<=Phi1
-0000e060: 2061 6e64 2044 5068 6931 3e3d 5068 6930   and DPhi1>=Phi0
-0000e070: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000e080: 2020 2020 2020 2020 2020 426f 756e 6473            Bounds
-0000e090: 203d 205b 5b50 6869 302c 4450 6869 315d   = [[Phi0,DPhi1]
-0000e0a0: 2c5b 4450 6869 302c 5068 6931 5d5d 0a20  ,[DPhi0,Phi1]]. 
-0000e0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e0c0: 2020 2020 2020 2046 6163 6573 203d 205b         Faces = [
-0000e0d0: 5472 7565 2c54 7275 655d 0a20 2020 2020  True,True].     
-0000e0e0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0000e0f0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0000e100: 2020 2020 2020 2020 2020 2020 2042 6f75               Bou
-0000e110: 6e64 7320 3d20 5b5b 4e6f 6e65 2c4e 6f6e  nds = [[None,Non
-0000e120: 655d 5d0a 2020 2020 2020 2020 2020 2020  e]].            
-0000e130: 2020 2020 2020 2020 2020 2020 6966 2044              if D
-0000e140: 5068 6930 3c3d 5068 6931 3a0a 2020 2020  Phi0<=Phi1:.    
-0000e150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e160: 2020 2020 2020 2020 426f 756e 6473 5b30          Bounds[0
-0000e170: 5d5b 305d 203d 2050 6869 3020 6966 2044  ][0] = Phi0 if D
-0000e180: 5068 6930 3c3d 5068 6930 2065 6c73 6520  Phi0<=Phi0 else 
-0000e190: 4450 6869 300a 2020 2020 2020 2020 2020  DPhi0.          
-0000e1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e1b0: 2020 426f 756e 6473 5b30 5d5b 315d 203d    Bounds[0][1] =
-0000e1c0: 2050 6869 310a 2020 2020 2020 2020 2020   Phi1.          
+0000db60: 2323 2323 2323 2323 2323 2323 230a 2323  #############.##
+0000db70: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000db80: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000db90: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000dba0: 2323 2323 2323 0a23 2020 2020 2020 204d  ######.#       M
+0000dbb0: 6573 6869 6e67 202d 2053 7572 6661 6365  eshing - Surface
+0000dbc0: 202d 2054 6f72 0a23 2323 2323 2323 2323   - Tor.#########
+0000dbd0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000dbe0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000dbf0: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
+0000dc00: 0a64 6566 205f 6765 7442 6f75 6e64 7369  .def _getBoundsi
+0000dc10: 6e74 6572 3241 6e67 5365 6728 626f 6f6c  nter2AngSeg(bool
+0000dc20: 2046 756c 6c2c 2064 6f75 626c 6520 5068   Full, double Ph
+0000dc30: 6930 2c20 646f 7562 6c65 2050 6869 312c  i0, double Phi1,
+0000dc40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000dc50: 2020 2020 2020 2020 2020 2020 646f 7562              doub
+0000dc60: 6c65 2044 5068 6930 2c20 646f 7562 6c65  le DPhi0, double
+0000dc70: 2044 5068 6931 293a 0a20 2020 2022 2222   DPhi1):.    """
+0000dc80: 2052 6574 7572 6e20 696e 7465 723d 5472   Return inter=Tr
+0000dc90: 7565 2069 6620 616e 2069 6e74 6572 7365  ue if an interse
+0000dca0: 6374 696f 6e20 6578 6973 7420 2861 6c6c  ction exist (all
+0000dcb0: 2061 6e67 6c65 7320 696e 2072 6164 6961   angles in radia
+0000dcc0: 6e73 0a20 2020 2069 6e20 5b2d 7069 3b70  ns.    in [-pi;p
+0000dcd0: 695d 290a 0a20 2020 2049 6620 696e 7465  i])..    If inte
+0000dce0: 722c 2072 6574 7572 6e20 426f 756e 6473  r, return Bounds
+0000dcf0: 2c20 6120 6c69 7374 206f 6620 7475 706c  , a list of tupl
+0000dd00: 6573 2069 6e64 6963 6174 696e 6720 7468  es indicating th
+0000dd10: 6520 7365 676d 656e 7473 2064 6566 696e  e segments defin
+0000dd20: 696e 670a 2020 2020 7468 6520 696e 7465  ing.    the inte
+0000dd30: 7273 6563 7469 6f6e 2c20 7769 7468 0a20  rsection, with. 
+0000dd40: 2020 2054 6865 2069 6e74 6572 7661 6c73     The intervals
+0000dd50: 2061 7265 206f 7264 6572 6564 2066 726f   are ordered fro
+0000dd60: 6d20 6c6f 7765 7374 2069 6e64 6578 2074  m lowest index t
+0000dd70: 6f20 6869 6768 6573 7420 696e 6465 7820  o highest index 
+0000dd80: 2877 6974 6820 7265 7370 6563 740a 2020  (with respect.  
+0000dd90: 2020 746f 205b 5068 6930 2c50 6869 315d    to [Phi0,Phi1]
+0000dda0: 290a 2020 2020 2222 220a 2020 2020 6966  ).    """.    if
+0000ddb0: 2046 756c 6c3a 0a20 2020 2020 2020 2042   Full:.        B
+0000ddc0: 6f75 6e64 7320 3d20 5b5b 4450 6869 302c  ounds = [[DPhi0,
+0000ddd0: 4450 6869 315d 5d20 6966 2044 5068 6930  DPhi1]] if DPhi0
+0000dde0: 3c3d 4450 6869 3120 656c 7365 205b 5b2d  <=DPhi1 else [[-
+0000ddf0: 635f 7069 2c44 5068 6931 5d2c 5b44 5068  c_pi,DPhi1],[DPh
+0000de00: 6930 2c63 5f70 695d 5d0a 2020 2020 2020  i0,c_pi]].      
+0000de10: 2020 696e 7465 7220 3d20 5472 7565 0a20    inter = True. 
+0000de20: 2020 2020 2020 2046 6163 6573 203d 205b         Faces = [
+0000de30: 4e6f 6e65 2c20 4e6f 6e65 5d0a 0a20 2020  None, None]..   
+0000de40: 2065 6c73 653a 0a20 2020 2020 2020 2069   else:.        i
+0000de50: 6e74 6572 2c20 426f 756e 6473 2c20 4661  nter, Bounds, Fa
+0000de60: 6365 7320 3d20 4661 6c73 652c 204e 6f6e  ces = False, Non
+0000de70: 652c 205b 4661 6c73 652c 4661 6c73 655d  e, [False,False]
+0000de80: 0a20 2020 2020 2020 2069 6620 5068 6930  .        if Phi0
+0000de90: 3c3d 5068 6931 3a0a 2020 2020 2020 2020  <=Phi1:.        
+0000dea0: 2020 2020 6966 2044 5068 6930 3c3d 4450      if DPhi0<=DP
+0000deb0: 6869 313a 0a20 2020 2020 2020 2020 2020  hi1:.           
+0000dec0: 2020 2020 2069 6620 4450 6869 303c 3d50       if DPhi0<=P
+0000ded0: 6869 3120 616e 6420 4450 6869 313e 3d50  hi1 and DPhi1>=P
+0000dee0: 6869 303a 0a20 2020 2020 2020 2020 2020  hi0:.           
+0000def0: 2020 2020 2020 2020 2069 6e74 6572 203d           inter =
+0000df00: 2054 7275 650a 2020 2020 2020 2020 2020   True.          
+0000df10: 2020 2020 2020 2020 2020 426f 756e 6473            Bounds
+0000df20: 203d 205b 5b4e 6f6e 652c 4e6f 6e65 5d5d   = [[None,None]]
+0000df30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000df40: 2020 2020 2042 6f75 6e64 735b 305d 5b30       Bounds[0][0
+0000df50: 5d20 3d20 5068 6930 2069 6620 4450 6869  ] = Phi0 if DPhi
+0000df60: 303c 3d50 6869 3020 656c 7365 2044 5068  0<=Phi0 else DPh
+0000df70: 6930 0a20 2020 2020 2020 2020 2020 2020  i0.             
+0000df80: 2020 2020 2020 2042 6f75 6e64 735b 305d         Bounds[0]
+0000df90: 5b31 5d20 3d20 5068 6931 2069 6620 4450  [1] = Phi1 if DP
+0000dfa0: 6869 313e 3d50 6869 3120 656c 7365 2044  hi1>=Phi1 else D
+0000dfb0: 5068 6931 0a20 2020 2020 2020 2020 2020  Phi1.           
+0000dfc0: 2020 2020 2020 2020 2046 6163 6573 5b30           Faces[0
+0000dfd0: 5d20 3d20 4450 6869 303c 3d50 6869 300a  ] = DPhi0<=Phi0.
+0000dfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dff0: 2020 2020 4661 6365 735b 315d 203d 2044      Faces[1] = D
+0000e000: 5068 6931 3e3d 5068 6931 0a20 2020 2020  Phi1>=Phi1.     
+0000e010: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0000e020: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0000e030: 4450 6869 303c 3d50 6869 3120 6f72 2044  DPhi0<=Phi1 or D
+0000e040: 5068 6931 3e3d 5068 6930 3a0a 2020 2020  Phi1>=Phi0:.    
+0000e050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e060: 696e 7465 7220 3d20 5472 7565 0a20 2020  inter = True.   
+0000e070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e080: 2069 6620 4450 6869 303c 3d50 6869 3120   if DPhi0<=Phi1 
+0000e090: 616e 6420 4450 6869 313e 3d50 6869 303a  and DPhi1>=Phi0:
+0000e0a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e0b0: 2020 2020 2020 2020 2042 6f75 6e64 7320           Bounds 
+0000e0c0: 3d20 5b5b 5068 6930 2c44 5068 6931 5d2c  = [[Phi0,DPhi1],
+0000e0d0: 5b44 5068 6930 2c50 6869 315d 5d0a 2020  [DPhi0,Phi1]].  
+0000e0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e0f0: 2020 2020 2020 4661 6365 7320 3d20 5b54        Faces = [T
+0000e100: 7275 652c 5472 7565 5d0a 2020 2020 2020  rue,True].      
+0000e110: 2020 2020 2020 2020 2020 2020 2020 656c                el
+0000e120: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0000e130: 2020 2020 2020 2020 2020 2020 426f 756e              Boun
+0000e140: 6473 203d 205b 5b4e 6f6e 652c 4e6f 6e65  ds = [[None,None
+0000e150: 5d5d 0a20 2020 2020 2020 2020 2020 2020  ]].             
+0000e160: 2020 2020 2020 2020 2020 2069 6620 4450             if DP
+0000e170: 6869 303c 3d50 6869 313a 0a20 2020 2020  hi0<=Phi1:.     
+0000e180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e190: 2020 2020 2020 2042 6f75 6e64 735b 305d         Bounds[0]
+0000e1a0: 5b30 5d20 3d20 5068 6930 2069 6620 4450  [0] = Phi0 if DP
+0000e1b0: 6869 303c 3d50 6869 3020 656c 7365 2044  hi0<=Phi0 else D
+0000e1c0: 5068 6930 0a20 2020 2020 2020 2020 2020  Phi0.           
 0000e1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e1e0: 2020 4661 6365 735b 305d 203d 2044 5068    Faces[0] = DPh
-0000e1f0: 6930 3c3d 5068 6930 0a20 2020 2020 2020  i0<=Phi0.       
+0000e1e0: 2042 6f75 6e64 735b 305d 5b31 5d20 3d20   Bounds[0][1] = 
+0000e1f0: 5068 6931 0a20 2020 2020 2020 2020 2020  Phi1.           
 0000e200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e210: 2020 2020 2046 6163 6573 5b31 5d20 3d20       Faces[1] = 
-0000e220: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
-0000e230: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-0000e240: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000e250: 2020 2020 2020 2020 2020 2020 2020 2042                 B
-0000e260: 6f75 6e64 735b 305d 5b30 5d20 3d20 5068  ounds[0][0] = Ph
-0000e270: 6930 0a20 2020 2020 2020 2020 2020 2020  i0.             
-0000e280: 2020 2020 2020 2020 2020 2020 2020 2042                 B
-0000e290: 6f75 6e64 735b 305d 5b31 5d20 3d20 5068  ounds[0][1] = Ph
-0000e2a0: 6931 2069 6620 4450 6869 313e 3d50 6869  i1 if DPhi1>=Phi
-0000e2b0: 3120 656c 7365 2044 5068 6931 0a20 2020  1 else DPhi1.   
-0000e2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e2d0: 2020 2020 2020 2020 2046 6163 6573 5b30           Faces[0
-0000e2e0: 5d20 3d20 5472 7565 0a20 2020 2020 2020  ] = True.       
+0000e210: 2046 6163 6573 5b30 5d20 3d20 4450 6869   Faces[0] = DPhi
+0000e220: 303c 3d50 6869 300a 2020 2020 2020 2020  0<=Phi0.        
+0000e230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e240: 2020 2020 4661 6365 735b 315d 203d 2054      Faces[1] = T
+0000e250: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
+0000e260: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0000e270: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000e280: 2020 2020 2020 2020 2020 2020 2020 426f                Bo
+0000e290: 756e 6473 5b30 5d5b 305d 203d 2050 6869  unds[0][0] = Phi
+0000e2a0: 300a 2020 2020 2020 2020 2020 2020 2020  0.              
+0000e2b0: 2020 2020 2020 2020 2020 2020 2020 426f                Bo
+0000e2c0: 756e 6473 5b30 5d5b 315d 203d 2050 6869  unds[0][1] = Phi
+0000e2d0: 3120 6966 2044 5068 6931 3e3d 5068 6931  1 if DPhi1>=Phi1
+0000e2e0: 2065 6c73 6520 4450 6869 310a 2020 2020   else DPhi1.    
 0000e2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e300: 2020 2020 2046 6163 6573 5b31 5d20 3d20       Faces[1] = 
-0000e310: 4450 6869 313e 3d50 6869 310a 2020 2020  DPhi1>=Phi1.    
-0000e320: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0000e330: 2020 2020 2020 6966 2044 5068 6930 3c3d        if DPhi0<=
-0000e340: 4450 6869 313a 0a20 2020 2020 2020 2020  DPhi1:.         
-0000e350: 2020 2020 2020 2069 6620 4450 6869 303c         if DPhi0<
-0000e360: 3d50 6869 3120 6f72 2044 5068 6931 3e3d  =Phi1 or DPhi1>=
-0000e370: 5068 6930 3a0a 2020 2020 2020 2020 2020  Phi0:.          
-0000e380: 2020 2020 2020 2020 2020 696e 7465 7220            inter 
-0000e390: 3d20 5472 7565 0a20 2020 2020 2020 2020  = True.         
-0000e3a0: 2020 2020 2020 2020 2020 2069 6620 4450             if DP
-0000e3b0: 6869 303c 3d50 6869 3120 616e 6420 4450  hi0<=Phi1 and DP
-0000e3c0: 6869 313e 3d50 6869 303a 0a20 2020 2020  hi1>=Phi0:.     
-0000e3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e3e0: 2020 2042 6f75 6e64 7320 3d20 5b5b 5068     Bounds = [[Ph
-0000e3f0: 6930 2c44 5068 6931 5d2c 5b44 5068 6930  i0,DPhi1],[DPhi0
-0000e400: 2c50 6869 315d 5d0a 2020 2020 2020 2020  ,Phi1]].        
-0000e410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e420: 4661 6365 7320 3d20 5b54 7275 652c 5472  Faces = [True,Tr
-0000e430: 7565 5d0a 2020 2020 2020 2020 2020 2020  ue].            
-0000e440: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0000e450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e460: 2020 2020 2020 426f 756e 6473 203d 205b        Bounds = [
-0000e470: 5b4e 6f6e 652c 4e6f 6e65 5d5d 0a20 2020  [None,None]].   
+0000e300: 2020 2020 2020 2020 4661 6365 735b 305d          Faces[0]
+0000e310: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
+0000e320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e330: 2020 2020 4661 6365 735b 315d 203d 2044      Faces[1] = D
+0000e340: 5068 6931 3e3d 5068 6931 0a20 2020 2020  Phi1>=Phi1.     
+0000e350: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0000e360: 2020 2020 2069 6620 4450 6869 303c 3d44       if DPhi0<=D
+0000e370: 5068 6931 3a0a 2020 2020 2020 2020 2020  Phi1:.          
+0000e380: 2020 2020 2020 6966 2044 5068 6930 3c3d        if DPhi0<=
+0000e390: 5068 6931 206f 7220 4450 6869 313e 3d50  Phi1 or DPhi1>=P
+0000e3a0: 6869 303a 0a20 2020 2020 2020 2020 2020  hi0:.           
+0000e3b0: 2020 2020 2020 2020 2069 6e74 6572 203d           inter =
+0000e3c0: 2054 7275 650a 2020 2020 2020 2020 2020   True.          
+0000e3d0: 2020 2020 2020 2020 2020 6966 2044 5068            if DPh
+0000e3e0: 6930 3c3d 5068 6931 2061 6e64 2044 5068  i0<=Phi1 and DPh
+0000e3f0: 6931 3e3d 5068 6930 3a0a 2020 2020 2020  i1>=Phi0:.      
+0000e400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e410: 2020 426f 756e 6473 203d 205b 5b50 6869    Bounds = [[Phi
+0000e420: 302c 4450 6869 315d 2c5b 4450 6869 302c  0,DPhi1],[DPhi0,
+0000e430: 5068 6931 5d5d 0a20 2020 2020 2020 2020  Phi1]].         
+0000e440: 2020 2020 2020 2020 2020 2020 2020 2046                 F
+0000e450: 6163 6573 203d 205b 5472 7565 2c54 7275  aces = [True,Tru
+0000e460: 655d 0a20 2020 2020 2020 2020 2020 2020  e].             
+0000e470: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
 0000e480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e490: 2020 2020 2069 6620 4450 6869 303c 3d50       if DPhi0<=P
-0000e4a0: 6869 313a 0a20 2020 2020 2020 2020 2020  hi1:.           
+0000e490: 2020 2020 2042 6f75 6e64 7320 3d20 5b5b       Bounds = [[
+0000e4a0: 4e6f 6e65 2c4e 6f6e 655d 5d0a 2020 2020  None,None]].    
 0000e4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e4c0: 2042 6f75 6e64 735b 305d 5b30 5d20 3d20   Bounds[0][0] = 
-0000e4d0: 4450 6869 300a 2020 2020 2020 2020 2020  DPhi0.          
+0000e4c0: 2020 2020 6966 2044 5068 6930 3c3d 5068      if DPhi0<=Ph
+0000e4d0: 6931 3a0a 2020 2020 2020 2020 2020 2020  i1:.            
 0000e4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e4f0: 2020 426f 756e 6473 5b30 5d5b 315d 203d    Bounds[0][1] =
-0000e500: 2050 6869 3120 6966 2044 5068 6931 3e3d   Phi1 if DPhi1>=
-0000e510: 5068 6931 2065 6c73 6520 4450 6869 310a  Phi1 else DPhi1.
-0000e520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e530: 2020 2020 2020 2020 2020 2020 4661 6365              Face
-0000e540: 735b 315d 203d 2044 5068 6931 3e3d 5068  s[1] = DPhi1>=Ph
-0000e550: 6931 0a20 2020 2020 2020 2020 2020 2020  i1.             
-0000e560: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0000e570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e580: 2020 2020 2020 2020 2020 2020 2042 6f75               Bou
-0000e590: 6e64 735b 305d 5b30 5d20 3d20 5068 6930  nds[0][0] = Phi0
-0000e5a0: 2069 6620 4450 6869 303c 3d50 6869 3020   if DPhi0<=Phi0 
-0000e5b0: 656c 7365 2044 5068 6930 0a20 2020 2020  else DPhi0.     
-0000e5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e5d0: 2020 2020 2020 2042 6f75 6e64 735b 305d         Bounds[0]
-0000e5e0: 5b31 5d20 3d20 4450 6869 310a 2020 2020  [1] = DPhi1.    
+0000e4f0: 426f 756e 6473 5b30 5d5b 305d 203d 2044  Bounds[0][0] = D
+0000e500: 5068 6930 0a20 2020 2020 2020 2020 2020  Phi0.           
+0000e510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e520: 2042 6f75 6e64 735b 305d 5b31 5d20 3d20   Bounds[0][1] = 
+0000e530: 5068 6931 2069 6620 4450 6869 313e 3d50  Phi1 if DPhi1>=P
+0000e540: 6869 3120 656c 7365 2044 5068 6931 0a20  hi1 else DPhi1. 
+0000e550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e560: 2020 2020 2020 2020 2020 2046 6163 6573             Faces
+0000e570: 5b31 5d20 3d20 4450 6869 313e 3d50 6869  [1] = DPhi1>=Phi
+0000e580: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
+0000e590: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0000e5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e5b0: 2020 2020 2020 2020 2020 2020 426f 756e              Boun
+0000e5c0: 6473 5b30 5d5b 305d 203d 2050 6869 3020  ds[0][0] = Phi0 
+0000e5d0: 6966 2044 5068 6930 3c3d 5068 6930 2065  if DPhi0<=Phi0 e
+0000e5e0: 6c73 6520 4450 6869 300a 2020 2020 2020  lse DPhi0.      
 0000e5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e600: 2020 2020 2020 2020 4661 6365 735b 305d          Faces[0]
-0000e610: 203d 2044 5068 6930 3c3d 5068 6930 0a20   = DPhi0<=Phi0. 
-0000e620: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0000e630: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e640: 2069 6e74 6572 203d 2054 7275 650a 2020   inter = True.  
-0000e650: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0000e660: 2044 5068 6930 3e3d 5068 6930 2061 6e64   DPhi0>=Phi0 and
-0000e670: 2044 5068 6931 3e3d 5068 6930 3a0a 2020   DPhi1>=Phi0:.  
-0000e680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e690: 2020 426f 756e 6473 203d 205b 5b50 6869    Bounds = [[Phi
-0000e6a0: 302c 4450 6869 315d 2c5b 4450 6869 302c  0,DPhi1],[DPhi0,
-0000e6b0: 635f 7069 5d2c 5b2d 635f 7069 2c50 6869  c_pi],[-c_pi,Phi
-0000e6c0: 315d 5d0a 2020 2020 2020 2020 2020 2020  1]].            
-0000e6d0: 2020 2020 2020 2020 4661 6365 7320 3d20          Faces = 
-0000e6e0: 5b54 7275 652c 5472 7565 5d0a 2020 2020  [True,True].    
-0000e6f0: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-0000e700: 2044 5068 6930 3c3d 5068 6931 2061 6e64   DPhi0<=Phi1 and
-0000e710: 2044 5068 6931 3c3d 5068 6931 3a0a 2020   DPhi1<=Phi1:.  
-0000e720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e730: 2020 426f 756e 6473 203d 205b 5b50 6869    Bounds = [[Phi
-0000e740: 302c 635f 7069 5d2c 5b2d 635f 7069 2c44  0,c_pi],[-c_pi,D
-0000e750: 5068 6931 5d2c 5b44 5068 6930 2c50 6869  Phi1],[DPhi0,Phi
-0000e760: 315d 5d0a 2020 2020 2020 2020 2020 2020  1]].            
-0000e770: 2020 2020 2020 2020 4661 6365 7320 3d20          Faces = 
-0000e780: 5b54 7275 652c 5472 7565 5d0a 2020 2020  [True,True].    
-0000e790: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0000e7a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000e7b0: 2020 2020 2020 426f 756e 6473 203d 205b        Bounds = [
-0000e7c0: 5b4e 6f6e 652c 635f 7069 5d2c 5b2d 635f  [None,c_pi],[-c_
-0000e7d0: 7069 2c4e 6f6e 655d 5d0a 2020 2020 2020  pi,None]].      
-0000e7e0: 2020 2020 2020 2020 2020 2020 2020 426f                Bo
-0000e7f0: 756e 6473 5b30 5d5b 305d 203d 2050 6869  unds[0][0] = Phi
-0000e800: 3020 6966 2044 5068 6930 3c3d 5068 6930  0 if DPhi0<=Phi0
-0000e810: 2065 6c73 6520 4450 6869 300a 2020 2020   else DPhi0.    
-0000e820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e830: 426f 756e 6473 5b31 5d5b 315d 203d 2050  Bounds[1][1] = P
-0000e840: 6869 3120 6966 2044 5068 6931 3e3d 5068  hi1 if DPhi1>=Ph
-0000e850: 6931 2065 6c73 6520 4450 6869 310a 2020  i1 else DPhi1.  
-0000e860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e870: 2020 4661 6365 735b 305d 203d 2044 5068    Faces[0] = DPh
-0000e880: 6930 3c3d 5068 6930 0a20 2020 2020 2020  i0<=Phi0.       
-0000e890: 2020 2020 2020 2020 2020 2020 2046 6163               Fac
-0000e8a0: 6573 5b31 5d20 3d20 4450 6869 313e 3d50  es[1] = DPhi1>=P
-0000e8b0: 6869 310a 2020 2020 7265 7475 726e 2069  hi1.    return i
-0000e8c0: 6e74 6572 2c20 426f 756e 6473 2c20 4661  nter, Bounds, Fa
-0000e8d0: 6365 730a 0a0a 6465 6620 5f56 6573 5f53  ces...def _Ves_S
-0000e8e0: 6d65 7368 5f54 6f72 5f53 7562 4672 6f6d  mesh_Tor_SubFrom
-0000e8f0: 445f 6379 7468 6f6e 2864 6f75 626c 6520  D_cython(double 
-0000e900: 644c 2c20 646f 7562 6c65 2064 5250 6869  dL, double dRPhi
-0000e910: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000e920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e930: 2020 2020 2064 6f75 626c 655b 3a2c 3a3a       double[:,::
-0000e940: 315d 2056 506f 6c79 2c0a 2020 2020 2020  1] VPoly,.      
+0000e600: 2020 2020 2020 426f 756e 6473 5b30 5d5b        Bounds[0][
+0000e610: 315d 203d 2044 5068 6931 0a20 2020 2020  1] = DPhi1.     
+0000e620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e630: 2020 2020 2020 2046 6163 6573 5b30 5d20         Faces[0] 
+0000e640: 3d20 4450 6869 303c 3d50 6869 300a 2020  = DPhi0<=Phi0.  
+0000e650: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0000e660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e670: 696e 7465 7220 3d20 5472 7565 0a20 2020  inter = True.   
+0000e680: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0000e690: 4450 6869 303e 3d50 6869 3020 616e 6420  DPhi0>=Phi0 and 
+0000e6a0: 4450 6869 313e 3d50 6869 303a 0a20 2020  DPhi1>=Phi0:.   
+0000e6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e6c0: 2042 6f75 6e64 7320 3d20 5b5b 5068 6930   Bounds = [[Phi0
+0000e6d0: 2c44 5068 6931 5d2c 5b44 5068 6930 2c63  ,DPhi1],[DPhi0,c
+0000e6e0: 5f70 695d 2c5b 2d63 5f70 692c 5068 6931  _pi],[-c_pi,Phi1
+0000e6f0: 5d5d 0a20 2020 2020 2020 2020 2020 2020  ]].             
+0000e700: 2020 2020 2020 2046 6163 6573 203d 205b         Faces = [
+0000e710: 5472 7565 2c54 7275 655d 0a20 2020 2020  True,True].     
+0000e720: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+0000e730: 4450 6869 303c 3d50 6869 3120 616e 6420  DPhi0<=Phi1 and 
+0000e740: 4450 6869 313c 3d50 6869 313a 0a20 2020  DPhi1<=Phi1:.   
+0000e750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e760: 2042 6f75 6e64 7320 3d20 5b5b 5068 6930   Bounds = [[Phi0
+0000e770: 2c63 5f70 695d 2c5b 2d63 5f70 692c 4450  ,c_pi],[-c_pi,DP
+0000e780: 6869 315d 2c5b 4450 6869 302c 5068 6931  hi1],[DPhi0,Phi1
+0000e790: 5d5d 0a20 2020 2020 2020 2020 2020 2020  ]].             
+0000e7a0: 2020 2020 2020 2046 6163 6573 203d 205b         Faces = [
+0000e7b0: 5472 7565 2c54 7275 655d 0a20 2020 2020  True,True].     
+0000e7c0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0000e7d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e7e0: 2020 2020 2042 6f75 6e64 7320 3d20 5b5b       Bounds = [[
+0000e7f0: 4e6f 6e65 2c63 5f70 695d 2c5b 2d63 5f70  None,c_pi],[-c_p
+0000e800: 692c 4e6f 6e65 5d5d 0a20 2020 2020 2020  i,None]].       
+0000e810: 2020 2020 2020 2020 2020 2020 2042 6f75               Bou
+0000e820: 6e64 735b 305d 5b30 5d20 3d20 5068 6930  nds[0][0] = Phi0
+0000e830: 2069 6620 4450 6869 303c 3d50 6869 3020   if DPhi0<=Phi0 
+0000e840: 656c 7365 2044 5068 6930 0a20 2020 2020  else DPhi0.     
+0000e850: 2020 2020 2020 2020 2020 2020 2020 2042                 B
+0000e860: 6f75 6e64 735b 315d 5b31 5d20 3d20 5068  ounds[1][1] = Ph
+0000e870: 6931 2069 6620 4450 6869 313e 3d50 6869  i1 if DPhi1>=Phi
+0000e880: 3120 656c 7365 2044 5068 6931 0a20 2020  1 else DPhi1.   
+0000e890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e8a0: 2046 6163 6573 5b30 5d20 3d20 4450 6869   Faces[0] = DPhi
+0000e8b0: 303c 3d50 6869 300a 2020 2020 2020 2020  0<=Phi0.        
+0000e8c0: 2020 2020 2020 2020 2020 2020 4661 6365              Face
+0000e8d0: 735b 315d 203d 2044 5068 6931 3e3d 5068  s[1] = DPhi1>=Ph
+0000e8e0: 6931 0a20 2020 2072 6574 7572 6e20 696e  i1.    return in
+0000e8f0: 7465 722c 2042 6f75 6e64 732c 2046 6163  ter, Bounds, Fac
+0000e900: 6573 0a0a 0a64 6566 205f 5665 735f 536d  es...def _Ves_Sm
+0000e910: 6573 685f 546f 725f 5375 6246 726f 6d44  esh_Tor_SubFromD
+0000e920: 5f63 7974 686f 6e28 646f 7562 6c65 2064  _cython(double d
+0000e930: 4c2c 2064 6f75 626c 6520 6452 5068 692c  L, double dRPhi,
+0000e940: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 0000e950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e960: 2020 2020 2020 2020 2020 2020 2044 523d               DR=
-0000e970: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+0000e960: 2020 2020 646f 7562 6c65 5b3a 2c3a 3a31      double[:,::1
+0000e970: 5d20 5650 6f6c 792c 0a20 2020 2020 2020  ] VPoly,.       
 0000e980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e990: 2020 2020 2020 2020 2044 5a3d 4e6f 6e65           DZ=None
-0000e9a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000e990: 2020 2020 2020 2020 2020 2020 4452 3d4e              DR=N
+0000e9a0: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
 0000e9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e9c0: 2020 2020 2044 5068 693d 4e6f 6e65 2c0a       DPhi=None,.
-0000e9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e9c0: 2020 2020 2020 2020 445a 3d4e 6f6e 652c          DZ=None,
+0000e9d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 0000e9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e9f0: 2020 2064 6f75 626c 6520 4449 6e3d 302e     double DIn=0.
-0000ea00: 2c20 5649 6e3d 4e6f 6e65 2c20 5068 694d  , VIn=None, PhiM
-0000ea10: 696e 4d61 783d 4e6f 6e65 2c0a 2020 2020  inMax=None,.    
-0000ea20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ea30: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000ea40: 7472 204f 7574 3d27 2858 2c59 2c5a 2927  tr Out='(X,Y,Z)'
-0000ea50: 2c20 646f 7562 6c65 206d 6172 6769 6e3d  , double margin=
-0000ea60: 5f56 534d 414c 4c29 3a0a 2020 2020 2222  _VSMALL):.    ""
-0000ea70: 2220 5265 7475 726e 2074 6865 2064 6573  " Return the des
-0000ea80: 6972 6564 2073 7572 6661 6369 6320 7375  ired surfacic su
-0000ea90: 626d 6573 6820 696e 6469 6361 7465 6420  bmesh indicated 
-0000eaa0: 6279 2074 6865 206c 696d 6974 7320 2844  by the limits (D
-0000eab0: 522c 445a 2c44 5068 6929 0a20 2020 2066  R,DZ,DPhi).    f
-0000eac0: 6f72 2074 6865 2064 6573 6972 6564 2072  or the desired r
-0000ead0: 6573 6f6c 7574 696f 6e20 2864 522c 645a  esolution (dR,dZ
-0000eae0: 2c64 5270 6869 290a 2020 2020 2222 220a  ,dRphi).    """.
-0000eaf0: 2020 2020 6364 6566 2064 6f75 626c 655b      cdef double[
-0000eb00: 3a3a 315d 2064 5068 6972 2c20 4e52 5068  ::1] dPhir, NRPh
-0000eb10: 6923 2c20 6450 6869 2c20 4e52 5a50 6869  i#, dPhi, NRZPhi
-0000eb20: 5f63 756d 302c 2069 6e64 5068 692c 2070  _cum0, indPhi, p
-0000eb30: 6869 0a20 2020 2063 6465 6620 646f 7562  hi.    cdef doub
-0000eb40: 6c65 2044 5068 6930 2c20 4450 6869 312c  le DPhi0, DPhi1,
-0000eb50: 2044 4450 6869 2c20 4450 6869 4d69 6e4d   DDPhi, DPhiMinM
-0000eb60: 6178 0a20 2020 2063 6465 6620 646f 7562  ax.    cdef doub
-0000eb70: 6c65 2061 6273 302c 2061 6273 312c 2070  le abs0, abs1, p
-0000eb80: 6869 2c20 696e 6469 696a 6a0a 2020 2020  hi, indiijj.    
-0000eb90: 6364 6566 206c 6f6e 675b 3a3a 315d 2069  cdef long[::1] i
-0000eba0: 6e64 5230 2c20 696e 6452 2c20 696e 645a  ndR0, indR, indZ
-0000ebb0: 2c20 5068 696e 2c20 4e52 5068 6930 2c20  , Phin, NRPhi0, 
-0000ebc0: 496e 6469 6e0a 2020 2020 6364 6566 2069  Indin.    cdef i
-0000ebd0: 6e74 204e 5230 2c20 6e52 5068 6930 2c20  nt NR0, nRPhi0, 
-0000ebe0: 696e 6452 3069 692c 2069 692c 206a 6a30  indR0ii, ii, jj0
-0000ebf0: 3d30 2c20 6a6a 2c20 6e70 6869 302c 206e  =0, jj, nphi0, n
-0000ec00: 7068 6931 0a20 2020 2063 6465 6620 696e  phi1.    cdef in
-0000ec10: 7420 6e70 7473 5f64 6973 632c 2072 6164  t npts_disc, rad
-0000ec20: 6975 735f 7261 7469 6f2c 204c 6e0a 2020  ius_ratio, Ln.  
-0000ec30: 2020 6364 6566 206e 702e 6e64 6172 7261    cdef np.ndarra
-0000ec40: 795b 646f 7562 6c65 2c6e 6469 6d3d 325d  y[double,ndim=2]
-0000ec50: 2070 7473 2c20 696e 6449 2c20 7074 7343   pts, indI, ptsC
-0000ec60: 726f 7373 2c20 5650 6269 730a 2020 2020  ross, VPbis.    
-0000ec70: 6364 6566 206e 702e 6e64 6172 7261 795b  cdef np.ndarray[
-0000ec80: 646f 7562 6c65 2c6e 6469 6d3d 315d 2052  double,ndim=1] R
-0000ec90: 302c 2064 532c 2069 6e64 2c20 644c 722c  0, dS, ind, dLr,
-0000eca0: 2052 7265 662c 2064 5250 6869 722c 2069   Rref, dRPhir, i
-0000ecb0: 6969 0a20 2020 2063 6465 6620 6e70 2e6e  ii.    cdef np.n
-0000ecc0: 6461 7272 6179 5b6c 6f6e 672c 6e64 696d  darray[long,ndim
-0000ecd0: 3d31 5d20 696e 644c 2c20 4e4c 2c20 696e  =1] indL, NL, in
-0000ece0: 646f 6b0a 0a20 2020 2023 2054 6f20 6176  dok..    # To av
-0000ecf0: 6f69 6420 7761 726e 696e 6773 3a0a 2020  oid warnings:.  
-0000ed00: 2020 696e 6449 203d 206e 702e 656d 7074    indI = np.empt
-0000ed10: 7928 2831 2c31 2929 0a20 2020 2023 2050  y((1,1)).    # P
-0000ed20: 7265 2d66 6f72 6d61 7420 696e 7075 740a  re-format input.
-0000ed30: 2020 2020 6966 2050 6869 4d69 6e4d 6178      if PhiMinMax
-0000ed40: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0000ed50: 2020 5068 694d 696e 4d61 7820 3d20 5b2d    PhiMinMax = [-
-0000ed60: 635f 7069 2c63 5f70 695d 0a20 2020 2020  c_pi,c_pi].     
-0000ed70: 2020 2044 5068 694d 696e 4d61 7820 3d20     DPhiMinMax = 
-0000ed80: 5f54 574f 5049 0a20 2020 2020 2020 2046  _TWOPI.        F
-0000ed90: 756c 6c20 3d20 5472 7565 0a20 2020 2065  ull = True.    e
-0000eda0: 6c73 653a 0a20 2020 2020 2020 2050 6869  lse:.        Phi
-0000edb0: 4d69 6e4d 6178 203d 205b 635f 6174 616e  MinMax = [c_atan
-0000edc0: 3228 635f 7369 6e28 5068 694d 696e 4d61  2(c_sin(PhiMinMa
-0000edd0: 785b 305d 292c 635f 636f 7328 5068 694d  x[0]),c_cos(PhiM
-0000ede0: 696e 4d61 785b 305d 2929 2c0a 2020 2020  inMax[0])),.    
-0000edf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ee00: 2063 5f61 7461 6e32 2863 5f73 696e 2850   c_atan2(c_sin(P
-0000ee10: 6869 4d69 6e4d 6178 5b31 5d29 2c63 5f63  hiMinMax[1]),c_c
-0000ee20: 6f73 2850 6869 4d69 6e4d 6178 5b31 5d29  os(PhiMinMax[1])
-0000ee30: 295d 0a20 2020 2020 2020 2044 5068 694d  )].        DPhiM
-0000ee40: 696e 4d61 7820 3d20 5068 694d 696e 4d61  inMax = PhiMinMa
-0000ee50: 785b 315d 2d50 6869 4d69 6e4d 6178 5b30  x[1]-PhiMinMax[0
-0000ee60: 5d20 6966 2050 6869 4d69 6e4d 6178 5b31  ] if PhiMinMax[1
-0000ee70: 5d3e 3d50 6869 4d69 6e4d 6178 5b30 5d20  ]>=PhiMinMax[0] 
-0000ee80: 5c0a 2020 2020 2020 2020 2020 656c 7365  \.          else
-0000ee90: 205f 5457 4f50 4920 2b20 5068 694d 696e   _TWOPI + PhiMin
-0000eea0: 4d61 785b 315d 202d 2050 6869 4d69 6e4d  Max[1] - PhiMinM
-0000eeb0: 6178 5b30 5d0a 2020 2020 2020 2020 4675  ax[0].        Fu
-0000eec0: 6c6c 203d 2046 616c 7365 0a0a 2020 2020  ll = False..    
-0000eed0: 2320 4765 7420 7468 6520 6c69 6d69 7473  # Get the limits
-0000eee0: 2069 6620 616e 7920 2861 6e64 206d 616b   if any (and mak
-0000eef0: 6520 7375 7265 2074 6f20 7265 706c 6163  e sure to replac
-0000ef00: 6520 7468 656d 2069 6e20 7468 6520 7072  e them in the pr
-0000ef10: 6f70 6572 0a20 2020 2023 2071 7561 6472  oper.    # quadr
-0000ef20: 616e 7473 290a 2020 2020 6966 2044 5068  ants).    if DPh
-0000ef30: 6920 6973 204e 6f6e 653a 0a20 2020 2020  i is None:.     
-0000ef40: 2020 2044 5068 6930 2c20 4450 6869 3120     DPhi0, DPhi1 
-0000ef50: 3d20 5068 694d 696e 4d61 785b 305d 2c20  = PhiMinMax[0], 
-0000ef60: 5068 694d 696e 4d61 785b 315d 0a20 2020  PhiMinMax[1].   
-0000ef70: 2065 6c73 653a 0a20 2020 2020 2020 2044   else:.        D
-0000ef80: 5068 6930 203d 2050 6869 4d69 6e4d 6178  Phi0 = PhiMinMax
-0000ef90: 5b30 5d20 6966 2044 5068 695b 305d 2069  [0] if DPhi[0] i
-0000efa0: 7320 4e6f 6e65 2065 6c73 6520 635f 6174  s None else c_at
-0000efb0: 616e 3228 635f 7369 6e28 4450 6869 5b30  an2(c_sin(DPhi[0
-0000efc0: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
-0000efd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000efe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f000: 635f 636f 7328 4450 6869 5b30 5d29 290a  c_cos(DPhi[0])).
-0000f010: 2020 2020 2020 2020 4450 6869 3120 3d20          DPhi1 = 
-0000f020: 5068 694d 696e 4d61 785b 315d 2069 6620  PhiMinMax[1] if 
-0000f030: 4450 6869 5b31 5d20 6973 204e 6f6e 6520  DPhi[1] is None 
-0000f040: 656c 7365 2063 5f61 7461 6e32 2863 5f73  else c_atan2(c_s
-0000f050: 696e 2844 5068 695b 315d 292c 0a20 2020  in(DPhi[1]),.   
-0000f060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f090: 2020 2020 2020 2020 2063 5f63 6f73 2844           c_cos(D
-0000f0a0: 5068 695b 315d 2929 0a20 2020 2044 4450  Phi[1])).    DDP
-0000f0b0: 6869 203d 2044 5068 6931 2d44 5068 6930  hi = DPhi1-DPhi0
-0000f0c0: 2069 6620 4450 6869 313e 4450 6869 3020   if DPhi1>DPhi0 
-0000f0d0: 656c 7365 205f 5457 4f50 492b 4450 6869  else _TWOPI+DPhi
-0000f0e0: 312d 4450 6869 300a 0a20 2020 2069 6e74  1-DPhi0..    int
-0000f0f0: 6572 2c20 426f 756e 6473 2c20 5f20 3d20  er, Bounds, _ = 
-0000f100: 5f67 6574 426f 756e 6473 696e 7465 7232  _getBoundsinter2
-0000f110: 416e 6753 6567 2846 756c 6c2c 2050 6869  AngSeg(Full, Phi
-0000f120: 4d69 6e4d 6178 5b30 5d2c 0a20 2020 2020  MinMax[0],.     
-0000f130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f150: 2020 2020 2020 2020 2020 2020 2050 6869               Phi
-0000f160: 4d69 6e4d 6178 5b31 5d2c 2044 5068 6930  MinMax[1], DPhi0
-0000f170: 2c20 4450 6869 3129 0a0a 2020 2020 6966  , DPhi1)..    if
-0000f180: 2069 6e74 6572 3a0a 0a20 2020 2020 2020   inter:..       
-0000f190: 2042 4320 3d20 6c69 7374 2842 6f75 6e64   BC = list(Bound
-0000f1a0: 7329 0a20 2020 2020 2020 206e 426f 756e  s).        nBoun
-0000f1b0: 6473 203d 206c 656e 2842 6f75 6e64 7329  ds = len(Bounds)
-0000f1c0: 0a20 2020 2020 2020 2066 6f72 2069 6920  .        for ii 
-0000f1d0: 696e 2072 616e 6765 2830 2c6e 426f 756e  in range(0,nBoun
-0000f1e0: 6473 293a 0a20 2020 2020 2020 2020 2020  ds):.           
-0000f1f0: 2069 6620 4243 5b69 695d 5b30 5d3c 5068   if BC[ii][0]<Ph
-0000f200: 694d 696e 4d61 785b 305d 3a0a 2020 2020  iMinMax[0]:.    
-0000f210: 2020 2020 2020 2020 2020 2020 4243 5b69              BC[i
-0000f220: 695d 5b30 5d20 2b3d 205f 5457 4f50 490a  i][0] += _TWOPI.
-0000f230: 2020 2020 2020 2020 2020 2020 6966 2042              if B
-0000f240: 435b 6969 5d5b 315d 3c3d 5068 694d 696e  C[ii][1]<=PhiMin
-0000f250: 4d61 785b 305d 3a0a 2020 2020 2020 2020  Max[0]:.        
-0000f260: 2020 2020 2020 2020 4243 5b69 695d 5b31          BC[ii][1
-0000f270: 5d20 2b3d 205f 5457 4f50 490a 0a20 2020  ] += _TWOPI..   
-0000f280: 2020 2020 2023 2047 6574 2074 6865 2061       # Get the a
-0000f290: 6374 7561 6c20 5220 616e 6420 5a20 7265  ctual R and Z re
-0000f2a0: 736f 6c75 7469 6f6e 7320 616e 6420 6d65  solutions and me
-0000f2b0: 7368 2065 6c65 6d65 6e74 730a 2020 2020  sh elements.    
-0000f2c0: 2020 2020 7074 7343 726f 7373 2c20 644c      ptsCross, dL
-0000f2d0: 722c 2069 6e64 4c2c 205c 0a20 2020 2020  r, indL, \.     
-0000f2e0: 2020 2020 204e 4c2c 2052 7265 662c 2056       NL, Rref, V
-0000f2f0: 5062 6973 203d 2064 6973 6372 6574 697a  Pbis = discretiz
-0000f300: 655f 7670 6f6c 7928 5650 6f6c 792c 2064  e_vpoly(VPoly, d
-0000f310: 4c2c 2044 313d 4e6f 6e65 2c20 4432 3d4e  L, D1=None, D2=N
-0000f320: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
-0000f330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f350: 2020 6d61 7267 696e 3d6d 6172 6769 6e2c    margin=margin,
-0000f360: 2044 496e 3d44 496e 2c20 5649 6e3d 5649   DIn=DIn, VIn=VI
-0000f370: 6e29 0a20 2020 2020 2020 2052 3020 3d20  n).        R0 = 
-0000f380: 6e70 2e63 6f70 7928 5272 6566 290a 2020  np.copy(Rref).  
-0000f390: 2020 2020 2020 4e52 3020 3d20 5230 2e73        NR0 = R0.s
-0000f3a0: 697a 650a 2020 2020 2020 2020 696e 6469  ize.        indi
-0000f3b0: 6e20 3d20 6e70 2e6f 6e65 7328 2870 7473  n = np.ones((pts
-0000f3c0: 4372 6f73 732e 7368 6170 655b 315d 2c29  Cross.shape[1],)
-0000f3d0: 2c64 7479 7065 3d62 6f6f 6c29 0a20 2020  ,dtype=bool).   
-0000f3e0: 2020 2020 2069 6620 4452 2069 7320 6e6f       if DR is no
-0000f3f0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-0000f400: 2020 2020 6966 2044 525b 305d 2069 7320      if DR[0] is 
-0000f410: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-0000f420: 2020 2020 2020 2020 2020 696e 6469 6e20            indin 
-0000f430: 3d20 696e 6469 6e20 2620 2852 3020 3e3d  = indin & (R0 >=
-0000f440: 2044 525b 305d 290a 2020 2020 2020 2020   DR[0]).        
-0000f450: 2020 2020 6966 2044 525b 315d 2069 7320      if DR[1] is 
-0000f460: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-0000f470: 2020 2020 2020 2020 2020 696e 6469 6e20            indin 
-0000f480: 3d20 696e 6469 6e20 2620 2852 3020 3c3d  = indin & (R0 <=
-0000f490: 2044 525b 315d 290a 2020 2020 2020 2020   DR[1]).        
-0000f4a0: 6966 2044 5a20 6973 206e 6f74 204e 6f6e  if DZ is not Non
-0000f4b0: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
-0000f4c0: 6620 445a 5b30 5d20 6973 206e 6f74 204e  f DZ[0] is not N
-0000f4d0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0000f4e0: 2020 2020 2069 6e64 696e 203d 2069 6e64       indin = ind
-0000f4f0: 696e 2026 2028 7074 7343 726f 7373 5b31  in & (ptsCross[1
-0000f500: 2c3a 5d20 3e3d 2044 5a5b 305d 290a 2020  ,:] >= DZ[0]).  
-0000f510: 2020 2020 2020 2020 2020 6966 2044 5a5b            if DZ[
-0000f520: 315d 2069 7320 6e6f 7420 4e6f 6e65 3a0a  1] is not None:.
-0000f530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f540: 696e 6469 6e20 3d20 696e 6469 6e20 2620  indin = indin & 
-0000f550: 2870 7473 4372 6f73 735b 312c 3a5d 203c  (ptsCross[1,:] <
-0000f560: 3d20 445a 5b31 5d29 0a0a 2020 2020 2020  = DZ[1])..      
-0000f570: 2020 7074 7343 726f 7373 203d 2070 7473    ptsCross = pts
-0000f580: 4372 6f73 735b 3a2c 696e 6469 6e5d 0a20  Cross[:,indin]. 
-0000f590: 2020 2020 2020 2064 4c72 203d 2064 4c72         dLr = dLr
-0000f5a0: 5b69 6e64 696e 5d0a 2020 2020 2020 2020  [indin].        
-0000f5b0: 696e 644c 203d 2069 6e64 4c5b 696e 6469  indL = indL[indi
-0000f5c0: 6e5d 0a20 2020 2020 2020 2052 7265 6620  n].        Rref 
-0000f5d0: 3d20 5272 6566 5b69 6e64 696e 5d0a 0a20  = Rref[indin].. 
-0000f5e0: 2020 2020 2020 204c 6e20 3d20 696e 6469         Ln = indi
-0000f5f0: 6e2e 7375 6d28 290a 2020 2020 2020 2020  n.sum().        
-0000f600: 496e 6469 6e20 3d20 696e 6469 6e2e 6e6f  Indin = indin.no
-0000f610: 6e7a 6572 6f28 295b 305d 2e61 7374 7970  nzero()[0].astyp
-0000f620: 6528 696e 7429 0a0a 2020 2020 2020 2020  e(int)..        
-0000f630: 6452 5068 6972 2c20 6450 6869 7220 3d20  dRPhir, dPhir = 
-0000f640: 6e70 2e65 6d70 7479 2828 4c6e 2c29 292c  np.empty((Ln,)),
-0000f650: 206e 702e 656d 7074 7928 284c 6e2c 2929   np.empty((Ln,))
-0000f660: 0a20 2020 2020 2020 2050 6869 6e20 3d20  .        Phin = 
-0000f670: 6e70 2e7a 6572 6f73 2828 4c6e 2c29 2c64  np.zeros((Ln,),d
-0000f680: 7479 7065 3d69 6e74 290a 2020 2020 2020  type=int).      
-0000f690: 2020 4e52 5068 6920 3d20 6e70 2e65 6d70    NRPhi = np.emp
-0000f6a0: 7479 2828 4c6e 2c29 290a 2020 2020 2020  ty((Ln,)).      
-0000f6b0: 2020 4e52 5068 6930 203d 206e 702e 7a65    NRPhi0 = np.ze
-0000f6c0: 726f 7328 284c 6e2c 292c 6474 7970 653d  ros((Ln,),dtype=
-0000f6d0: 696e 7429 0a20 2020 2020 2020 206e 5250  int).        nRP
-0000f6e0: 6869 302c 2069 6e64 5230 6969 203d 2030  hi0, indR0ii = 0
-0000f6f0: 2c20 300a 2020 2020 2020 2020 6e70 7473  , 0.        npts
-0000f700: 5f64 6973 6320 3d20 300a 2020 2020 2020  _disc = 0.      
-0000f710: 2020 7261 6469 7573 5f72 6174 696f 203d    radius_ratio =
-0000f720: 2069 6e74 2863 5f63 6569 6c28 6e70 2e6d   int(c_ceil(np.m
-0000f730: 6178 2852 7265 6629 2f6e 702e 6d69 6e28  ax(Rref)/np.min(
-0000f740: 5272 6566 2929 290a 2020 2020 2020 2020  Rref))).        
-0000f750: 696e 6442 6f75 6e64 7320 3d20 6e70 2e65  indBounds = np.e
-0000f760: 6d70 7479 2828 322c 6e42 6f75 6e64 7329  mpty((2,nBounds)
-0000f770: 2c64 7479 7065 3d69 6e74 290a 2020 2020  ,dtype=int).    
-0000f780: 2020 2020 666f 7220 6969 2069 6e20 7261      for ii in ra
-0000f790: 6e67 6528 302c 4c6e 293a 0a20 2020 2020  nge(0,Ln):.     
-0000f7a0: 2020 2020 2020 2023 2047 6574 2074 6865         # Get the
-0000f7b0: 2061 6374 7561 6c20 5250 6869 2072 6573   actual RPhi res
-0000f7c0: 6f6c 7574 696f 6e20 616e 6420 5068 6920  olution and Phi 
-0000f7d0: 6d65 7368 2065 6c65 6d65 6e74 730a 2020  mesh elements.  
-0000f7e0: 2020 2020 2020 2020 2020 2320 2821 2064            # (! d
-0000f7f0: 6570 656e 6473 206f 6e20 5221 290a 2020  epends on R!).  
-0000f800: 2020 2020 2020 2020 2020 4e52 5068 695b            NRPhi[
-0000f810: 6969 5d20 3d20 635f 6365 696c 2844 5068  ii] = c_ceil(DPh
-0000f820: 694d 696e 4d61 782a 5272 6566 5b69 695d  iMinMax*Rref[ii]
-0000f830: 2f64 5250 6869 290a 2020 2020 2020 2020  /dRPhi).        
-0000f840: 2020 2020 4e52 5068 695f 696e 7420 3d20      NRPhi_int = 
-0000f850: 696e 7428 4e52 5068 695b 6969 5d29 0a20  int(NRPhi[ii]). 
-0000f860: 2020 2020 2020 2020 2020 2064 5068 6972             dPhir
-0000f870: 5b69 695d 203d 2044 5068 694d 696e 4d61  [ii] = DPhiMinMa
-0000f880: 782f 4e52 5068 695b 6969 5d0a 2020 2020  x/NRPhi[ii].    
-0000f890: 2020 2020 2020 2020 6452 5068 6972 5b69          dRPhir[i
-0000f8a0: 695d 203d 2064 5068 6972 5b69 695d 2a52  i] = dPhir[ii]*R
-0000f8b0: 7265 665b 6969 5d0a 2020 2020 2020 2020  ref[ii].        
-0000f8c0: 2020 2020 2320 4765 7420 696e 6465 7820      # Get index 
-0000f8d0: 616e 6420 6375 6d75 6c61 7465 6420 696e  and cumulated in
-0000f8e0: 6469 6365 7320 6672 6f6d 2062 6163 6b67  dices from backg
-0000f8f0: 726f 756e 640a 2020 2020 2020 2020 2020  round.          
-0000f900: 2020 666f 7220 6a6a 3020 696e 2072 616e    for jj0 in ran
-0000f910: 6765 2869 6e64 5230 6969 2c4e 5230 293a  ge(indR0ii,NR0):
-0000f920: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f930: 2069 6620 6a6a 303d 3d49 6e64 696e 5b69   if jj0==Indin[i
-0000f940: 695d 3a0a 2020 2020 2020 2020 2020 2020  i]:.            
-0000f950: 2020 2020 2020 2020 696e 6452 3069 6920          indR0ii 
-0000f960: 3d20 6a6a 300a 2020 2020 2020 2020 2020  = jj0.          
-0000f970: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
-0000f980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f990: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0000f9a0: 2020 2020 2020 2020 2020 6e52 5068 6930            nRPhi0
-0000f9b0: 202b 3d20 3c6c 6f6e 673e 635f 6365 696c   += <long>c_ceil
-0000f9c0: 2844 5068 694d 696e 4d61 782a 5230 5b6a  (DPhiMinMax*R0[j
-0000f9d0: 6a30 5d2f 6452 5068 6929 0a20 2020 2020  j0]/dRPhi).     
-0000f9e0: 2020 2020 2020 2020 2020 2020 2020 204e                 N
-0000f9f0: 5250 6869 305b 6969 5d20 3d20 6e52 5068  RPhi0[ii] = nRPh
-0000fa00: 6930 0a20 2020 2020 2020 2020 2020 2023  i0.            #
-0000fa10: 2047 6574 2069 6e64 6963 6573 206f 6620   Get indices of 
-0000fa20: 7068 690a 2020 2020 2020 2020 2020 2020  phi.            
-0000fa30: 2320 4765 7420 7468 6520 6578 7472 656d  # Get the extrem
-0000fa40: 6520 696e 6469 6365 7320 6f66 2074 6865  e indices of the
-0000fa50: 206d 6573 6820 656c 656d 656e 7473 2074   mesh elements t
-0000fa60: 6861 7420 7265 616c 6c79 206e 6565 6420  hat really need 
-0000fa70: 746f 0a20 2020 2020 2020 2020 2020 2023  to.            #
-0000fa80: 2062 6520 6372 6561 7465 6420 7769 7468   be created with
-0000fa90: 696e 2074 686f 7365 206c 696d 6974 730a  in those limits.
-0000faa0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0000fab0: 6b6b 2069 6e20 7261 6e67 6528 302c 6e42  kk in range(0,nB
-0000fac0: 6f75 6e64 7329 3a0a 2020 2020 2020 2020  ounds):.        
-0000fad0: 2020 2020 2020 2020 6162 7330 203d 2042          abs0 = B
-0000fae0: 435b 6b6b 5d5b 305d 2d50 6869 4d69 6e4d  C[kk][0]-PhiMinM
-0000faf0: 6178 5b30 5d0a 2020 2020 2020 2020 2020  ax[0].          
-0000fb00: 2020 2020 2020 6966 2061 6273 302d 6450        if abs0-dP
-0000fb10: 6869 725b 6969 5d2a 635f 666c 6f6f 7228  hir[ii]*c_floor(
-0000fb20: 6162 7330 2f64 5068 6972 5b69 695d 293c  abs0/dPhir[ii])<
-0000fb30: 6d61 7267 696e 2a64 5068 6972 5b69 695d  margin*dPhir[ii]
-0000fb40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000fb50: 2020 2020 2020 6e70 6869 3020 3d20 696e        nphi0 = in
-0000fb60: 7428 635f 726f 756e 6428 6162 7330 2f64  t(c_round(abs0/d
-0000fb70: 5068 6972 5b69 695d 2929 0a20 2020 2020  Phir[ii])).     
-0000fb80: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0000fb90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000fba0: 2020 2020 206e 7068 6930 203d 2069 6e74       nphi0 = int
-0000fbb0: 2863 5f66 6c6f 6f72 2861 6273 302f 6450  (c_floor(abs0/dP
-0000fbc0: 6869 725b 6969 5d29 290a 2020 2020 2020  hir[ii])).      
-0000fbd0: 2020 2020 2020 2020 2020 6162 7331 203d            abs1 =
-0000fbe0: 2042 435b 6b6b 5d5b 315d 2d50 6869 4d69   BC[kk][1]-PhiMi
-0000fbf0: 6e4d 6178 5b30 5d0a 2020 2020 2020 2020  nMax[0].        
-0000fc00: 2020 2020 2020 2020 6966 2061 6273 312d          if abs1-
-0000fc10: 6450 6869 725b 6969 5d2a 635f 666c 6f6f  dPhir[ii]*c_floo
-0000fc20: 7228 6162 7331 2f64 5068 6972 5b69 695d  r(abs1/dPhir[ii]
-0000fc30: 293c 6d61 7267 696e 2a64 5068 6972 5b69  )<margin*dPhir[i
-0000fc40: 695d 3a0a 2020 2020 2020 2020 2020 2020  i]:.            
-0000fc50: 2020 2020 2020 2020 6e70 6869 3120 3d20          nphi1 = 
-0000fc60: 696e 7428 635f 726f 756e 6428 6162 7331  int(c_round(abs1
-0000fc70: 2f64 5068 6972 5b69 695d 292d 3129 0a20  /dPhir[ii])-1). 
-0000fc80: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0000fc90: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0000fca0: 2020 2020 2020 2020 206e 7068 6931 203d           nphi1 =
-0000fcb0: 2069 6e74 2863 5f66 6c6f 6f72 2861 6273   int(c_floor(abs
-0000fcc0: 312f 6450 6869 725b 6969 5d29 290a 2020  1/dPhir[ii])).  
-0000fcd0: 2020 2020 2020 2020 2020 2020 2020 696e                in
-0000fce0: 6442 6f75 6e64 735b 302c 6b6b 5d20 3d20  dBounds[0,kk] = 
-0000fcf0: 6e70 6869 300a 2020 2020 2020 2020 2020  nphi0.          
-0000fd00: 2020 2020 2020 696e 6442 6f75 6e64 735b        indBounds[
-0000fd10: 312c 6b6b 5d20 3d20 6e70 6869 310a 2020  1,kk] = nphi1.  
-0000fd20: 2020 2020 2020 2020 2020 2020 2020 5068                Ph
-0000fd30: 696e 5b69 695d 202b 3d20 6e70 6869 312b  in[ii] += nphi1+
-0000fd40: 312d 6e70 6869 300a 0a20 2020 2020 2020  1-nphi0..       
-0000fd50: 2020 2020 2069 6620 6969 3d3d 303a 0a20       if ii==0:. 
-0000fd60: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000fd70: 6e64 4920 3d20 6e70 2e6e 616e 2a6e 702e  ndI = np.nan*np.
-0000fd80: 6f6e 6573 2828 4c6e 2c50 6869 6e5b 6969  ones((Ln,Phin[ii
-0000fd90: 5d2a 7261 6469 7573 5f72 6174 696f 2b31  ]*radius_ratio+1
-0000fda0: 2929 0a20 2020 2020 2020 2020 2020 206a  )).            j
-0000fdb0: 6a20 3d20 300a 2020 2020 2020 2020 2020  j = 0.          
-0000fdc0: 2020 666f 7220 6b6b 2069 6e20 7261 6e67    for kk in rang
-0000fdd0: 6528 302c 6e42 6f75 6e64 7329 3a0a 2020  e(0,nBounds):.  
-0000fde0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0000fdf0: 7220 6b6b 6220 696e 2072 616e 6765 2869  r kkb in range(i
-0000fe00: 6e64 426f 756e 6473 5b30 2c6b 6b5d 2c69  ndBounds[0,kk],i
-0000fe10: 6e64 426f 756e 6473 5b31 2c6b 6b5d 2b31  ndBounds[1,kk]+1
-0000fe20: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0000fe30: 2020 2020 2020 2069 6e64 495b 6969 2c6a         indI[ii,j
-0000fe40: 6a5d 203d 203c 646f 7562 6c65 3e28 206b  j] = <double>( k
-0000fe50: 6b62 2029 0a20 2020 2020 2020 2020 2020  kb ).           
-0000fe60: 2020 2020 2020 2020 206a 6a20 2b3d 2031           jj += 1
-0000fe70: 0a20 2020 2020 2020 2020 2020 206e 7074  .            npt
-0000fe80: 735f 6469 7363 202b 3d20 5068 696e 5b69  s_disc += Phin[i
-0000fe90: 695d 0a0a 2020 2020 2020 2020 2320 4669  i]..        # Fi
-0000fea0: 6e69 7368 2063 6f75 6e74 696e 6720 746f  nish counting to
-0000feb0: 2067 6574 2074 6f74 616c 206e 756d 6265   get total numbe
-0000fec0: 7220 6f66 2070 6f69 6e74 730a 2020 2020  r of points.    
-0000fed0: 2020 2020 6966 206a 6a30 3c3d 4e52 302d      if jj0<=NR0-
-0000fee0: 313a 0a20 2020 2020 2020 2020 2020 2066  1:.            f
-0000fef0: 6f72 206a 6a30 2069 6e20 7261 6e67 6528  or jj0 in range(
-0000ff00: 696e 6452 3069 692c 4e52 3029 3a0a 2020  indR0ii,NR0):.  
-0000ff10: 2020 2020 2020 2020 2020 2020 2020 6e52                nR
-0000ff20: 5068 6930 202b 3d20 3c6c 6f6e 673e 635f  Phi0 += <long>c_
-0000ff30: 6365 696c 2844 5068 694d 696e 4d61 782a  ceil(DPhiMinMax*
-0000ff40: 5230 5b6a 6a30 5d2f 6452 5068 6929 0a0a  R0[jj0]/dRPhi)..
-0000ff50: 2020 2020 2020 2020 2320 436f 6d70 7574          # Comput
-0000ff60: 6520 7074 732c 2072 6573 3364 2061 6e64  e pts, res3d and
-0000ff70: 2069 6e64 0a20 2020 2020 2020 2070 7473   ind.        pts
-0000ff80: 203d 206e 702e 6e61 6e2a 6e70 2e6f 6e65   = np.nan*np.one
-0000ff90: 7328 2833 2c6e 7074 735f 6469 7363 2929  s((3,npts_disc))
-0000ffa0: 0a20 2020 2020 2020 2069 6e64 203d 206e  .        ind = n
-0000ffb0: 702e 6e61 6e2a 6e70 2e6f 6e65 7328 286e  p.nan*np.ones((n
-0000ffc0: 7074 735f 6469 7363 2c29 290a 2020 2020  pts_disc,)).    
-0000ffd0: 2020 2020 6453 203d 206e 702e 6e61 6e2a      dS = np.nan*
-0000ffe0: 6e70 2e6f 6e65 7328 286e 7074 735f 6469  np.ones((npts_di
-0000fff0: 7363 2c29 290a 2020 2020 2020 2020 2320  sc,)).        # 
-00010000: 5468 6973 2074 7269 706c 6520 6c6f 6f70  This triple loop
-00010010: 2069 7320 7468 6520 6c6f 6e67 6573 7420   is the longest 
-00010020: 7061 7274 2c20 6974 2074 616b 6573 207e  part, it takes ~
-00010030: 3930 2520 6f66 2074 6865 2043 5055 2074  90% of the CPU t
-00010040: 696d 650a 2020 2020 2020 2020 6e70 7473  ime.        npts
-00010050: 5f64 6973 6320 3d20 300a 2020 2020 2020  _disc = 0.      
-00010060: 2020 6966 204f 7574 2e6c 6f77 6572 2829    if Out.lower()
-00010070: 3d3d 2728 782c 792c 7a29 273a 0a20 2020  =='(x,y,z)':.   
-00010080: 2020 2020 2020 2020 2066 6f72 2069 6920           for ii 
-00010090: 696e 2072 616e 6765 2830 2c4c 6e29 3a0a  in range(0,Ln):.
-000100a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000100b0: 2320 536f 6d65 2072 6172 6520 6361 7365  # Some rare case
-000100c0: 7320 7769 7468 2064 6f75 626c 6573 2068  s with doubles h
-000100d0: 6176 6520 746f 2062 6520 656c 696d 696e  ave to be elimin
-000100e0: 6174 6564 3a0a 2020 2020 2020 2020 2020  ated:.          
-000100f0: 2020 2020 2020 6969 6920 3d20 6e70 2e75        iii = np.u
-00010100: 6e69 7175 6528 696e 6449 5b69 692c 7e6e  nique(indI[ii,~n
-00010110: 702e 6973 6e61 6e28 696e 6449 5b69 692c  p.isnan(indI[ii,
-00010120: 3a5d 295d 290a 2020 2020 2020 2020 2020  :])]).          
-00010130: 2020 2020 2020 666f 7220 6a6a 2069 6e20        for jj in 
-00010140: 7261 6e67 6528 302c 6c65 6e28 6969 6929  range(0,len(iii)
-00010150: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00010160: 2020 2020 2020 2069 6e64 6969 6a6a 203d         indiijj =
-00010170: 2069 6969 5b6a 6a5d 0a20 2020 2020 2020   iii[jj].       
-00010180: 2020 2020 2020 2020 2020 2020 2070 6869               phi
-00010190: 203d 2050 6869 4d69 6e4d 6178 5b30 5d20   = PhiMinMax[0] 
-000101a0: 2b20 2830 2e35 2b69 6e64 6969 6a6a 292a  + (0.5+indiijj)*
-000101b0: 6450 6869 725b 6969 5d0a 2020 2020 2020  dPhir[ii].      
-000101c0: 2020 2020 2020 2020 2020 2020 2020 7074                pt
-000101d0: 735b 302c 6e70 7473 5f64 6973 635d 203d  s[0,npts_disc] =
-000101e0: 2070 7473 4372 6f73 735b 302c 6969 5d2a   ptsCross[0,ii]*
-000101f0: 635f 636f 7328 7068 6929 0a20 2020 2020  c_cos(phi).     
-00010200: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00010210: 7473 5b31 2c6e 7074 735f 6469 7363 5d20  ts[1,npts_disc] 
-00010220: 3d20 7074 7343 726f 7373 5b30 2c69 695d  = ptsCross[0,ii]
-00010230: 2a63 5f73 696e 2870 6869 290a 2020 2020  *c_sin(phi).    
-00010240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010250: 7074 735b 322c 6e70 7473 5f64 6973 635d  pts[2,npts_disc]
-00010260: 203d 2070 7473 4372 6f73 735b 312c 6969   = ptsCross[1,ii
-00010270: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00010280: 2020 2020 2020 696e 645b 6e70 7473 5f64        ind[npts_d
-00010290: 6973 635d 203d 204e 5250 6869 305b 6969  isc] = NRPhi0[ii
-000102a0: 5d20 2b20 696e 6469 696a 6a0a 2020 2020  ] + indiijj.    
-000102b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000102c0: 6453 5b6e 7074 735f 6469 7363 5d20 3d20  dS[npts_disc] = 
-000102d0: 644c 725b 6969 5d2a 6452 5068 6972 5b69  dLr[ii]*dRPhir[i
-000102e0: 695d 0a20 2020 2020 2020 2020 2020 2020  i].             
-000102f0: 2020 2020 2020 206e 7074 735f 6469 7363         npts_disc
-00010300: 202b 3d20 310a 2020 2020 2020 2020 656c   += 1.        el
-00010310: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00010320: 666f 7220 6969 2069 6e20 7261 6e67 6528  for ii in range(
-00010330: 302c 4c6e 293a 0a20 2020 2020 2020 2020  0,Ln):.         
-00010340: 2020 2020 2020 2069 6969 203d 206e 702e         iii = np.
-00010350: 756e 6971 7565 2869 6e64 495b 6969 2c7e  unique(indI[ii,~
-00010360: 6e70 2e69 736e 616e 2869 6e64 495b 6969  np.isnan(indI[ii
-00010370: 2c3a 5d29 5d29 0a20 2020 2020 2020 2020  ,:])]).         
-00010380: 2020 2020 2020 2066 6f72 206a 6a20 696e         for jj in
-00010390: 2072 616e 6765 2830 2c6c 656e 2869 6969   range(0,len(iii
-000103a0: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-000103b0: 2020 2020 2020 2020 696e 6469 696a 6a20          indiijj 
-000103c0: 3d20 6969 695b 6a6a 5d0a 2020 2020 2020  = iii[jj].      
-000103d0: 2020 2020 2020 2020 2020 2020 2020 7074                pt
-000103e0: 735b 302c 6e70 7473 5f64 6973 635d 203d  s[0,npts_disc] =
-000103f0: 2070 7473 4372 6f73 735b 302c 6969 5d0a   ptsCross[0,ii].
-00010400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010410: 2020 2020 7074 735b 312c 6e70 7473 5f64      pts[1,npts_d
-00010420: 6973 635d 203d 2070 7473 4372 6f73 735b  isc] = ptsCross[
-00010430: 312c 6969 5d0a 2020 2020 2020 2020 2020  1,ii].          
-00010440: 2020 2020 2020 2020 2020 7074 735b 322c            pts[2,
-00010450: 6e70 7473 5f64 6973 635d 203d 2050 6869  npts_disc] = Phi
-00010460: 4d69 6e4d 6178 5b30 5d20 2b20 2830 2e35  MinMax[0] + (0.5
-00010470: 2b69 6e64 6969 6a6a 292a 6450 6869 725b  +indiijj)*dPhir[
-00010480: 6969 5d0a 2020 2020 2020 2020 2020 2020  ii].            
-00010490: 2020 2020 2020 2020 696e 645b 6e70 7473          ind[npts
-000104a0: 5f64 6973 635d 203d 204e 5250 6869 305b  _disc] = NRPhi0[
-000104b0: 6969 5d20 2b20 696e 6469 696a 6a0a 2020  ii] + indiijj.  
-000104c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000104d0: 2020 6453 5b6e 7074 735f 6469 7363 5d20    dS[npts_disc] 
-000104e0: 3d20 644c 725b 6969 5d2a 6452 5068 6972  = dLr[ii]*dRPhir
-000104f0: 5b69 695d 0a20 2020 2020 2020 2020 2020  [ii].           
-00010500: 2020 2020 2020 2020 206e 7074 735f 6469           npts_di
-00010510: 7363 202b 3d20 310a 2020 2020 2020 2020  sc += 1.        
-00010520: 696e 646f 6b20 3d20 287e 6e70 2e69 736e  indok = (~np.isn
-00010530: 616e 2869 6e64 2929 2e6e 6f6e 7a65 726f  an(ind)).nonzero
-00010540: 2829 5b30 5d2e 6173 7479 7065 2869 6e74  ()[0].astype(int
-00010550: 290a 2020 2020 2020 2020 696e 6420 3d20  ).        ind = 
-00010560: 696e 645b 696e 646f 6b5d 0a20 2020 2020  ind[indok].     
-00010570: 2020 2064 5320 3d20 6453 5b69 6e64 6f6b     dS = dS[indok
-00010580: 5d0a 2020 2020 2020 2020 6966 206c 656e  ].        if len
-00010590: 2869 6e64 6f6b 293d 3d31 3a0a 2020 2020  (indok)==1:.    
-000105a0: 2020 2020 2020 2020 7074 7320 3d20 7074          pts = pt
-000105b0: 735b 3a2c 696e 646f 6b5d 2e72 6573 6861  s[:,indok].resha
-000105c0: 7065 2828 332c 3129 290a 2020 2020 2020  pe((3,1)).      
-000105d0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000105e0: 2020 2020 7074 7320 3d20 7074 735b 3a2c      pts = pts[:,
-000105f0: 696e 646f 6b5d 0a20 2020 2065 6c73 653a  indok].    else:
-00010600: 0a20 2020 2020 2020 2070 7473 2c20 6453  .        pts, dS
-00010610: 2c20 696e 642c 204e 4c2c 2052 7265 662c  , ind, NL, Rref,
-00010620: 2064 5250 6869 722c 206e 5250 6869 3020   dRPhir, nRPhi0 
-00010630: 3d20 6e70 2e6f 6e65 7328 2833 2c30 2929  = np.ones((3,0))
-00010640: 2c20 6e70 2e6f 6e65 7328 2830 2c29 292c  , np.ones((0,)),
-00010650: 5c0a 2020 2020 2020 2020 2020 6e70 2e6f  \.          np.o
-00010660: 6e65 7328 2830 2c29 292c 206e 702e 6e61  nes((0,)), np.na
-00010670: 6e2a 6e70 2e6f 6e65 7328 2856 506f 6c79  n*np.ones((VPoly
-00010680: 2e73 6861 7065 5b31 5d2d 312c 2929 2c5c  .shape[1]-1,)),\
-00010690: 0a20 2020 2020 2020 2020 206e 702e 6f6e  .          np.on
-000106a0: 6573 2828 302c 2929 2c20 6e70 2e6f 6e65  es((0,)), np.one
-000106b0: 7328 2830 2c29 292c 2030 0a20 2020 2072  s((0,)), 0.    r
-000106c0: 6574 7572 6e20 6e70 2e61 7363 6f6e 7469  eturn np.asconti
-000106d0: 6775 6f75 7361 7272 6179 2870 7473 292c  guousarray(pts),
-000106e0: 2064 532c 2069 6e64 2e61 7374 7970 6528   dS, ind.astype(
-000106f0: 696e 7429 2c20 4e4c 2c20 644c 722c 2052  int), NL, dLr, R
-00010700: 7265 662c 2064 5250 6869 722c 206e 5250  ref, dRPhir, nRP
-00010710: 6869 302c 2056 5062 6973 0a0a 0a64 6566  hi0, VPbis...def
-00010720: 205f 5665 735f 536d 6573 685f 546f 725f   _Ves_Smesh_Tor_
-00010730: 5375 6246 726f 6d49 6e64 5f63 7974 686f  SubFromInd_cytho
-00010740: 6e28 646f 7562 6c65 2064 4c2c 2064 6f75  n(double dL, dou
-00010750: 626c 6520 6452 5068 692c 0a20 2020 2020  ble dRPhi,.     
-00010760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010780: 646f 7562 6c65 5b3a 2c3a 3a31 5d20 5650  double[:,::1] VP
-00010790: 6f6c 792c 206c 6f6e 675b 3a3a 315d 2069  oly, long[::1] i
-000107a0: 6e64 2c0a 2020 2020 2020 2020 2020 2020  nd,.            
-000107b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000107c0: 2020 2020 2020 2020 2064 6f75 626c 6520           double 
-000107d0: 4449 6e3d 302e 2c20 5649 6e3d 4e6f 6e65  DIn=0., VIn=None
-000107e0: 2c20 5068 694d 696e 4d61 783d 4e6f 6e65  , PhiMinMax=None
-000107f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00010800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010810: 2020 2020 2020 2073 7472 204f 7574 3d27         str Out='
-00010820: 2858 2c59 2c5a 2927 2c20 646f 7562 6c65  (X,Y,Z)', double
-00010830: 206d 6172 6769 6e3d 5f56 534d 414c 4c29   margin=_VSMALL)
-00010840: 3a0a 2020 2020 2222 2220 5265 7475 726e  :.    """ Return
-00010850: 2074 6865 2064 6573 6972 6564 2073 7562   the desired sub
-00010860: 6d65 7368 2069 6e64 6963 6174 6564 2062  mesh indicated b
-00010870: 7920 7468 6520 286e 756d 6572 6963 616c  y the (numerical
-00010880: 2920 696e 6469 6365 732c 0a20 2020 2066  ) indices,.    f
-00010890: 6f72 2074 6865 2064 6573 6972 6564 2072  or the desired r
-000108a0: 6573 6f6c 7574 696f 6e20 2864 522c 645a  esolution (dR,dZ
-000108b0: 2c64 5270 6869 290a 2020 2020 2222 220a  ,dRphi).    """.
-000108c0: 2020 2020 6364 6566 2064 6f75 626c 655b      cdef double[
-000108d0: 3a3a 315d 2064 5250 6869 7252 6566 2c20  ::1] dRPhirRef, 
-000108e0: 6450 6869 720a 2020 2020 6364 6566 206c  dPhir.    cdef l
-000108f0: 6f6e 675b 3a3a 315d 2069 6e64 4c2c 204e  ong[::1] indL, N
-00010900: 5250 6869 302c 204e 5250 6869 0a20 2020  RPhi0, NRPhi.   
-00010910: 2063 6465 6620 6c6f 6e67 2020 4e50 3d6c   cdef long  NP=l
-00010920: 656e 2869 6e64 292c 2072 6164 6975 735f  en(ind), radius_
-00010930: 7261 7469 6f0a 2020 2020 6364 6566 2069  ratio.    cdef i
-00010940: 6e74 2069 693d 302c 206a 6a3d 302c 2069  nt ii=0, jj=0, i
-00010950: 694c 2c20 6969 7068 692c 204c 6e2c 206e  iL, iiphi, Ln, n
-00010960: 5250 6869 300a 2020 2020 6364 6566 2064  RPhi0.    cdef d
-00010970: 6f75 626c 655b 3a2c 3a3a 315d 2050 6869  ouble[:,::1] Phi
-00010980: 0a20 2020 2063 6465 6620 6e70 2e6e 6461  .    cdef np.nda
-00010990: 7272 6179 5b64 6f75 626c 652c 6e64 696d  rray[double,ndim
-000109a0: 3d32 5d20 7074 733d 6e70 2e65 6d70 7479  =2] pts=np.empty
-000109b0: 2828 332c 4e50 2929 2c20 7074 7343 726f  ((3,NP)), ptsCro
-000109c0: 7373 2c20 5650 6269 730a 2020 2020 6364  ss, VPbis.    cd
-000109d0: 6566 206e 702e 6e64 6172 7261 795b 646f  ef np.ndarray[do
-000109e0: 7562 6c65 2c6e 6469 6d3d 315d 2064 533d  uble,ndim=1] dS=
-000109f0: 6e70 2e65 6d70 7479 2828 4e50 2c29 292c  np.empty((NP,)),
-00010a00: 2064 4c72 2c20 6452 5068 6972 2c20 5272   dLr, dRPhir, Rr
-00010a10: 6566 0a20 2020 2063 6465 6620 6e70 2e6e  ef.    cdef np.n
-00010a20: 6461 7272 6179 5b6c 6f6e 672c 6e64 696d  darray[long,ndim
-00010a30: 3d31 5d20 4e4c 0a0a 2020 2020 2320 5072  =1] NL..    # Pr
-00010a40: 652d 666f 726d 6174 2069 6e70 7574 0a20  e-format input. 
-00010a50: 2020 2069 6620 5068 694d 696e 4d61 7820     if PhiMinMax 
-00010a60: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-00010a70: 2050 6869 4d69 6e4d 6178 203d 205b 2d63   PhiMinMax = [-c
-00010a80: 5f70 692c 635f 7069 5d0a 2020 2020 2020  _pi,c_pi].      
-00010a90: 2020 4450 6869 4d69 6e4d 6178 203d 205f    DPhiMinMax = _
-00010aa0: 5457 4f50 490a 2020 2020 656c 7365 3a0a  TWOPI.    else:.
-00010ab0: 2020 2020 2020 2020 5068 694d 696e 4d61          PhiMinMa
-00010ac0: 7820 3d20 5b63 5f61 7461 6e32 2863 5f73  x = [c_atan2(c_s
-00010ad0: 696e 2850 6869 4d69 6e4d 6178 5b30 5d29  in(PhiMinMax[0])
-00010ae0: 2c20 635f 636f 7328 5068 694d 696e 4d61  , c_cos(PhiMinMa
-00010af0: 785b 305d 2929 2c0a 2020 2020 2020 2020  x[0])),.        
-00010b00: 2020 2020 2020 2020 2020 2020 2063 5f61               c_a
-00010b10: 7461 6e32 2863 5f73 696e 2850 6869 4d69  tan2(c_sin(PhiMi
-00010b20: 6e4d 6178 5b31 5d29 2c20 635f 636f 7328  nMax[1]), c_cos(
-00010b30: 5068 694d 696e 4d61 785b 315d 2929 5d0a  PhiMinMax[1]))].
-00010b40: 2020 2020 2020 2020 6966 2050 6869 4d69          if PhiMi
-00010b50: 6e4d 6178 5b31 5d3e 3d50 6869 4d69 6e4d  nMax[1]>=PhiMinM
-00010b60: 6178 5b30 5d3a 0a20 2020 2020 2020 2020  ax[0]:.         
-00010b70: 2020 2044 5068 694d 696e 4d61 7820 3d20     DPhiMinMax = 
-00010b80: 5068 694d 696e 4d61 785b 315d 2d50 6869  PhiMinMax[1]-Phi
-00010b90: 4d69 6e4d 6178 5b30 5d0a 2020 2020 2020  MinMax[0].      
-00010ba0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00010bb0: 2020 2020 4450 6869 4d69 6e4d 6178 203d      DPhiMinMax =
-00010bc0: 205f 5457 4f50 4920 2b20 5068 694d 696e   _TWOPI + PhiMin
-00010bd0: 4d61 785b 315d 202d 2050 6869 4d69 6e4d  Max[1] - PhiMinM
-00010be0: 6178 5b30 5d0a 0a0a 2020 2020 2320 4765  ax[0]...    # Ge
-00010bf0: 7420 7468 6520 6163 7475 616c 2052 2061  t the actual R a
-00010c00: 6e64 205a 2072 6573 6f6c 7574 696f 6e73  nd Z resolutions
-00010c10: 2061 6e64 206d 6573 6820 656c 656d 656e   and mesh elemen
-00010c20: 7473 0a20 2020 2070 7473 4372 6f73 732c  ts.    ptsCross,
-00010c30: 2064 4c72 5265 662c 2069 6e64 4c2c 5c0a   dLrRef, indL,\.
-00010c40: 2020 2020 2020 4e4c 2c20 5272 6566 5265        NL, RrefRe
-00010c50: 662c 2056 5062 6973 203d 2064 6973 6372  f, VPbis = discr
-00010c60: 6574 697a 655f 7670 6f6c 7928 5650 6f6c  etize_vpoly(VPol
-00010c70: 792c 2064 4c2c 2044 313d 4e6f 6e65 2c20  y, dL, D1=None, 
-00010c80: 4432 3d4e 6f6e 652c 0a20 2020 2020 2020  D2=None,.       
-00010c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010cb0: 2020 2020 206d 6172 6769 6e3d 6d61 7267       margin=marg
-00010cc0: 696e 2c20 4449 6e3d 4449 6e2c 2056 496e  in, DIn=DIn, VIn
-00010cd0: 3d56 496e 290a 2020 2020 4c6e 203d 2064  =VIn).    Ln = d
-00010ce0: 4c72 5265 662e 7369 7a65 0a20 2020 2023  LrRef.size.    #
-00010cf0: 204e 756d 6265 7220 6f66 2050 6869 2070   Number of Phi p
-00010d00: 6572 2052 0a20 2020 2064 5250 6869 7252  er R.    dRPhirR
-00010d10: 6566 2c20 6450 6869 722c 2064 5250 6869  ef, dPhir, dRPhi
-00010d20: 7220 3d20 6e70 2e65 6d70 7479 2828 4c6e  r = np.empty((Ln
-00010d30: 2c29 292c 206e 702e 656d 7074 7928 284c  ,)), np.empty((L
-00010d40: 6e2c 2929 2c20 2d6e 702e 6f6e 6573 2828  n,)), -np.ones((
-00010d50: 4c6e 2c29 290a 2020 2020 644c 722c 2052  Ln,)).    dLr, R
-00010d60: 7265 6620 3d20 2d6e 702e 6f6e 6573 2828  ref = -np.ones((
-00010d70: 4c6e 2c29 292c 202d 6e70 2e6f 6e65 7328  Ln,)), -np.ones(
-00010d80: 284c 6e2c 2929 0a20 2020 204e 5250 6869  (Ln,)).    NRPhi
-00010d90: 2c20 4e52 5068 6930 203d 206e 702e 656d  , NRPhi0 = np.em
-00010da0: 7074 7928 284c 6e2c 292c 6474 7970 653d  pty((Ln,),dtype=
-00010db0: 696e 7429 2c20 6e70 2e65 6d70 7479 2828  int), np.empty((
-00010dc0: 4c6e 2c29 2c64 7479 7065 3d69 6e74 290a  Ln,),dtype=int).
-00010dd0: 2020 2020 7261 6469 7573 5f72 6174 696f      radius_ratio
-00010de0: 203d 2069 6e74 2863 5f63 6569 6c28 6e70   = int(c_ceil(np
-00010df0: 2e6d 6178 2852 7265 6652 6566 292f 6e70  .max(RrefRef)/np
-00010e00: 2e6d 696e 2852 7265 6652 6566 2929 290a  .min(RrefRef))).
-00010e10: 2020 2020 666f 7220 6969 2069 6e20 7261      for ii in ra
-00010e20: 6e67 6528 302c 4c6e 293a 0a20 2020 2020  nge(0,Ln):.     
-00010e30: 2020 204e 5250 6869 5b69 695d 203d 203c     NRPhi[ii] = <
-00010e40: 6c6f 6e67 3e28 635f 6365 696c 2844 5068  long>(c_ceil(DPh
-00010e50: 694d 696e 4d61 782a 5272 6566 5265 665b  iMinMax*RrefRef[
-00010e60: 6969 5d2f 6452 5068 6929 290a 2020 2020  ii]/dRPhi)).    
-00010e70: 2020 2020 6452 5068 6972 5265 665b 6969      dRPhirRef[ii
-00010e80: 5d20 3d20 4450 6869 4d69 6e4d 6178 2a52  ] = DPhiMinMax*R
-00010e90: 7265 6652 6566 5b69 695d 2f3c 646f 7562  refRef[ii]/<doub
-00010ea0: 6c65 3e28 4e52 5068 695b 6969 5d29 0a20  le>(NRPhi[ii]). 
-00010eb0: 2020 2020 2020 2064 5068 6972 5b69 695d         dPhir[ii]
-00010ec0: 203d 2044 5068 694d 696e 4d61 782f 3c64   = DPhiMinMax/<d
-00010ed0: 6f75 626c 653e 284e 5250 6869 5b69 695d  ouble>(NRPhi[ii]
-00010ee0: 290a 2020 2020 2020 2020 6966 2069 693d  ).        if ii=
-00010ef0: 3d30 3a0a 2020 2020 2020 2020 2020 2020  =0:.            
-00010f00: 4e52 5068 6930 5b69 695d 203d 2030 0a20  NRPhi0[ii] = 0. 
-00010f10: 2020 2020 2020 2020 2020 2050 6869 203d             Phi =
-00010f20: 206e 702e 656d 7074 7928 284c 6e2c 4e52   np.empty((Ln,NR
-00010f30: 5068 695b 6969 5d2a 7261 6469 7573 5f72  Phi[ii]*radius_r
-00010f40: 6174 696f 2b31 2929 0a20 2020 2020 2020  atio+1)).       
-00010f50: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00010f60: 2020 204e 5250 6869 305b 6969 5d20 3d20     NRPhi0[ii] = 
-00010f70: 4e52 5068 6930 5b69 692d 315d 202b 204e  NRPhi0[ii-1] + N
-00010f80: 5250 6869 5b69 692d 315d 0a20 2020 2020  RPhi[ii-1].     
-00010f90: 2020 2066 6f72 206a 6a20 696e 2072 616e     for jj in ran
-00010fa0: 6765 2830 2c4e 5250 6869 5b69 695d 293a  ge(0,NRPhi[ii]):
-00010fb0: 0a20 2020 2020 2020 2020 2020 2050 6869  .            Phi
-00010fc0: 5b69 692c 6a6a 5d20 3d20 5068 694d 696e  [ii,jj] = PhiMin
-00010fd0: 4d61 785b 305d 202b 2028 302e 352b 3c64  Max[0] + (0.5+<d
-00010fe0: 6f75 626c 653e 6a6a 292a 6450 6869 725b  ouble>jj)*dPhir[
-00010ff0: 6969 5d0a 2020 2020 6e52 5068 6930 203d  ii].    nRPhi0 =
-00011000: 204e 5250 6869 305b 4c6e 2d31 5d2b 4e52   NRPhi0[Ln-1]+NR
-00011010: 5068 695b 4c6e 2d31 5d0a 0a20 2020 2069  Phi[Ln-1]..    i
-00011020: 6620 4f75 742e 6c6f 7765 7228 293d 3d27  f Out.lower()=='
-00011030: 2878 2c79 2c7a 2927 3a0a 2020 2020 2020  (x,y,z)':.      
-00011040: 2020 666f 7220 6969 2069 6e20 7261 6e67    for ii in rang
-00011050: 6528 302c 4e50 293a 0a20 2020 2020 2020  e(0,NP):.       
-00011060: 2020 2020 2066 6f72 206a 6a20 696e 2072       for jj in r
-00011070: 616e 6765 2830 2c4c 6e2b 3129 3a0a 2020  ange(0,Ln+1):.  
-00011080: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00011090: 2069 6e64 5b69 695d 2d4e 5250 6869 305b   ind[ii]-NRPhi0[
-000110a0: 6a6a 5d3c 302e 3a0a 2020 2020 2020 2020  jj]<0.:.        
-000110b0: 2020 2020 2020 2020 2020 2020 6272 6561              brea
-000110c0: 6b0a 2020 2020 2020 2020 2020 2020 6969  k.            ii
-000110d0: 4c20 3d20 6a6a 2d31 0a20 2020 2020 2020  L = jj-1.       
-000110e0: 2020 2020 2069 6970 6869 203d 2069 6e64       iiphi = ind
-000110f0: 5b69 695d 202d 204e 5250 6869 305b 6969  [ii] - NRPhi0[ii
-00011100: 4c5d 0a20 2020 2020 2020 2020 2020 2070  L].            p
-00011110: 7473 5b30 2c69 695d 203d 2070 7473 4372  ts[0,ii] = ptsCr
-00011120: 6f73 735b 302c 6969 4c5d 2a63 5f63 6f73  oss[0,iiL]*c_cos
-00011130: 2850 6869 5b69 694c 2c69 6970 6869 5d29  (Phi[iiL,iiphi])
-00011140: 0a20 2020 2020 2020 2020 2020 2070 7473  .            pts
-00011150: 5b31 2c69 695d 203d 2070 7473 4372 6f73  [1,ii] = ptsCros
-00011160: 735b 302c 6969 4c5d 2a63 5f73 696e 2850  s[0,iiL]*c_sin(P
-00011170: 6869 5b69 694c 2c69 6970 6869 5d29 0a20  hi[iiL,iiphi]). 
-00011180: 2020 2020 2020 2020 2020 2070 7473 5b32             pts[2
-00011190: 2c69 695d 203d 2070 7473 4372 6f73 735b  ,ii] = ptsCross[
-000111a0: 312c 6969 4c5d 0a20 2020 2020 2020 2020  1,iiL].         
-000111b0: 2020 2064 535b 6969 5d20 3d20 644c 7252     dS[ii] = dLrR
-000111c0: 6566 5b69 694c 5d2a 6452 5068 6972 5265  ef[iiL]*dRPhirRe
-000111d0: 665b 6969 4c5d 0a20 2020 2020 2020 2020  f[iiL].         
-000111e0: 2020 2069 6620 6452 5068 6972 5b69 694c     if dRPhir[iiL
-000111f0: 5d3d 3d2d 312e 3a0a 2020 2020 2020 2020  ]==-1.:.        
-00011200: 2020 2020 2020 2020 6452 5068 6972 5b69          dRPhir[i
-00011210: 694c 5d20 3d20 6452 5068 6972 5265 665b  iL] = dRPhirRef[
-00011220: 6969 4c5d 0a20 2020 2020 2020 2020 2020  iiL].           
-00011230: 2020 2020 2064 4c72 5b69 694c 5d20 3d20       dLr[iiL] = 
-00011240: 644c 7252 6566 5b69 694c 5d0a 2020 2020  dLrRef[iiL].    
-00011250: 2020 2020 2020 2020 2020 2020 5272 6566              Rref
-00011260: 5b69 694c 5d20 3d20 5272 6566 5265 665b  [iiL] = RrefRef[
-00011270: 6969 4c5d 0a0a 2020 2020 656c 7365 3a0a  iiL]..    else:.
-00011280: 2020 2020 2020 2020 666f 7220 6969 2069          for ii i
-00011290: 6e20 7261 6e67 6528 302c 4e50 293a 0a20  n range(0,NP):. 
-000112a0: 2020 2020 2020 2020 2020 2066 6f72 206a             for j
-000112b0: 6a20 696e 2072 616e 6765 2830 2c4c 6e2b  j in range(0,Ln+
-000112c0: 3129 3a0a 2020 2020 2020 2020 2020 2020  1):.            
-000112d0: 2020 2020 6966 2069 6e64 5b69 695d 2d4e      if ind[ii]-N
-000112e0: 5250 6869 305b 6a6a 5d3c 302e 3a0a 2020  RPhi0[jj]<0.:.  
-000112f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011300: 2020 6272 6561 6b0a 2020 2020 2020 2020    break.        
-00011310: 2020 2020 6969 4c20 3d20 6a6a 2d31 0a20      iiL = jj-1. 
-00011320: 2020 2020 2020 2020 2020 2069 6970 6869             iiphi
-00011330: 203d 2069 6e64 5b69 695d 202d 204e 5250   = ind[ii] - NRP
-00011340: 6869 305b 6969 4c5d 0a20 2020 2020 2020  hi0[iiL].       
-00011350: 2020 2020 2070 7473 5b30 2c69 695d 203d       pts[0,ii] =
-00011360: 2070 7473 4372 6f73 735b 302c 6969 4c5d   ptsCross[0,iiL]
-00011370: 0a20 2020 2020 2020 2020 2020 2070 7473  .            pts
-00011380: 5b31 2c69 695d 203d 2070 7473 4372 6f73  [1,ii] = ptsCros
-00011390: 735b 312c 6969 4c5d 0a20 2020 2020 2020  s[1,iiL].       
-000113a0: 2020 2020 2070 7473 5b32 2c69 695d 203d       pts[2,ii] =
-000113b0: 2050 6869 5b69 694c 2c69 6970 6869 5d0a   Phi[iiL,iiphi].
-000113c0: 2020 2020 2020 2020 2020 2020 6453 5b69              dS[i
-000113d0: 695d 203d 2064 4c72 5265 665b 6969 4c5d  i] = dLrRef[iiL]
-000113e0: 2a64 5250 6869 7252 6566 5b69 694c 5d0a  *dRPhirRef[iiL].
-000113f0: 2020 2020 2020 2020 2020 2020 6966 2064              if d
-00011400: 5250 6869 725b 6969 4c5d 3d3d 2d31 2e3a  RPhir[iiL]==-1.:
-00011410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011420: 2064 5250 6869 725b 6969 4c5d 203d 2064   dRPhir[iiL] = d
-00011430: 5250 6869 7252 6566 5b69 694c 5d0a 2020  RPhirRef[iiL].  
-00011440: 2020 2020 2020 2020 2020 2020 2020 644c                dL
-00011450: 725b 6969 4c5d 203d 2064 4c72 5265 665b  r[iiL] = dLrRef[
-00011460: 6969 4c5d 0a20 2020 2020 2020 2020 2020  iiL].           
-00011470: 2020 2020 2052 7265 665b 6969 4c5d 203d       Rref[iiL] =
-00011480: 2052 7265 6652 6566 5b69 694c 5d0a 2020   RrefRef[iiL].  
-00011490: 2020 7265 7475 726e 2070 7473 2c20 6453    return pts, dS
-000114a0: 2c20 4e4c 2c20 644c 725b 644c 723e 2d30  , NL, dLr[dLr>-0
-000114b0: 2e35 5d2c 2052 7265 665b 5272 6566 3e2d  .5], Rref[Rref>-
-000114c0: 302e 355d 2c20 5c0a 2020 2020 2020 6452  0.5], \.      dR
-000114d0: 5068 6972 5b64 5250 6869 723e 2d30 2e35  Phir[dRPhir>-0.5
-000114e0: 5d2c 203c 6c6f 6e67 3e6e 5250 6869 302c  ], <long>nRPhi0,
-000114f0: 2056 5062 6973 0a0a 0a0a 2323 2323 2323   VPbis....######
-00011500: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00011510: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00011520: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00011530: 2323 0a23 2323 2323 2323 2323 2323 2323  ##.#############
+0000e9f0: 2020 2020 4450 6869 3d4e 6f6e 652c 0a20      DPhi=None,. 
+0000ea00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ea10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ea20: 2020 646f 7562 6c65 2044 496e 3d30 2e2c    double DIn=0.,
+0000ea30: 2056 496e 3d4e 6f6e 652c 2050 6869 4d69   VIn=None, PhiMi
+0000ea40: 6e4d 6178 3d4e 6f6e 652c 0a20 2020 2020  nMax=None,.     
+0000ea50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ea60: 2020 2020 2020 2020 2020 2020 2020 7374                st
+0000ea70: 7220 4f75 743d 2728 582c 592c 5a29 272c  r Out='(X,Y,Z)',
+0000ea80: 2064 6f75 626c 6520 6d61 7267 696e 3d5f   double margin=_
+0000ea90: 5653 4d41 4c4c 293a 0a20 2020 2022 2222  VSMALL):.    """
+0000eaa0: 2052 6574 7572 6e20 7468 6520 6465 7369   Return the desi
+0000eab0: 7265 6420 7375 7266 6163 6963 2073 7562  red surfacic sub
+0000eac0: 6d65 7368 2069 6e64 6963 6174 6564 2062  mesh indicated b
+0000ead0: 7920 7468 6520 6c69 6d69 7473 2028 4452  y the limits (DR
+0000eae0: 2c44 5a2c 4450 6869 290a 2020 2020 666f  ,DZ,DPhi).    fo
+0000eaf0: 7220 7468 6520 6465 7369 7265 6420 7265  r the desired re
+0000eb00: 736f 6c75 7469 6f6e 2028 6452 2c64 5a2c  solution (dR,dZ,
+0000eb10: 6452 7068 6929 0a20 2020 2022 2222 0a20  dRphi).    """. 
+0000eb20: 2020 2063 6465 6620 646f 7562 6c65 5b3a     cdef double[:
+0000eb30: 3a31 5d20 6450 6869 722c 204e 5250 6869  :1] dPhir, NRPhi
+0000eb40: 232c 2064 5068 692c 204e 525a 5068 695f  #, dPhi, NRZPhi_
+0000eb50: 6375 6d30 2c20 696e 6450 6869 2c20 7068  cum0, indPhi, ph
+0000eb60: 690a 2020 2020 6364 6566 2064 6f75 626c  i.    cdef doubl
+0000eb70: 6520 4450 6869 302c 2044 5068 6931 2c20  e DPhi0, DPhi1, 
+0000eb80: 4444 5068 692c 2044 5068 694d 696e 4d61  DDPhi, DPhiMinMa
+0000eb90: 780a 2020 2020 6364 6566 2064 6f75 626c  x.    cdef doubl
+0000eba0: 6520 6162 7330 2c20 6162 7331 2c20 7068  e abs0, abs1, ph
+0000ebb0: 692c 2069 6e64 6969 6a6a 0a20 2020 2063  i, indiijj.    c
+0000ebc0: 6465 6620 6c6f 6e67 5b3a 3a31 5d20 696e  def long[::1] in
+0000ebd0: 6452 302c 2069 6e64 522c 2069 6e64 5a2c  dR0, indR, indZ,
+0000ebe0: 2050 6869 6e2c 204e 5250 6869 302c 2049   Phin, NRPhi0, I
+0000ebf0: 6e64 696e 0a20 2020 2063 6465 6620 696e  ndin.    cdef in
+0000ec00: 7420 4e52 302c 206e 5250 6869 302c 2069  t NR0, nRPhi0, i
+0000ec10: 6e64 5230 6969 2c20 6969 2c20 6a6a 303d  ndR0ii, ii, jj0=
+0000ec20: 302c 206a 6a2c 206e 7068 6930 2c20 6e70  0, jj, nphi0, np
+0000ec30: 6869 310a 2020 2020 6364 6566 2069 6e74  hi1.    cdef int
+0000ec40: 206e 7074 735f 6469 7363 2c20 7261 6469   npts_disc, radi
+0000ec50: 7573 5f72 6174 696f 2c20 4c6e 0a20 2020  us_ratio, Ln.   
+0000ec60: 2063 6465 6620 6e70 2e6e 6461 7272 6179   cdef np.ndarray
+0000ec70: 5b64 6f75 626c 652c 6e64 696d 3d32 5d20  [double,ndim=2] 
+0000ec80: 7074 732c 2069 6e64 492c 2070 7473 4372  pts, indI, ptsCr
+0000ec90: 6f73 732c 2056 5062 6973 0a20 2020 2063  oss, VPbis.    c
+0000eca0: 6465 6620 6e70 2e6e 6461 7272 6179 5b64  def np.ndarray[d
+0000ecb0: 6f75 626c 652c 6e64 696d 3d31 5d20 5230  ouble,ndim=1] R0
+0000ecc0: 2c20 6453 2c20 696e 642c 2064 4c72 2c20  , dS, ind, dLr, 
+0000ecd0: 5272 6566 2c20 6452 5068 6972 2c20 6969  Rref, dRPhir, ii
+0000ece0: 690a 2020 2020 6364 6566 206e 702e 6e64  i.    cdef np.nd
+0000ecf0: 6172 7261 795b 6c6f 6e67 2c6e 6469 6d3d  array[long,ndim=
+0000ed00: 315d 2069 6e64 4c2c 204e 4c2c 2069 6e64  1] indL, NL, ind
+0000ed10: 6f6b 0a0a 2020 2020 2320 546f 2061 766f  ok..    # To avo
+0000ed20: 6964 2077 6172 6e69 6e67 733a 0a20 2020  id warnings:.   
+0000ed30: 2069 6e64 4920 3d20 6e70 2e65 6d70 7479   indI = np.empty
+0000ed40: 2828 312c 3129 290a 2020 2020 2320 5072  ((1,1)).    # Pr
+0000ed50: 652d 666f 726d 6174 2069 6e70 7574 0a20  e-format input. 
+0000ed60: 2020 2069 6620 5068 694d 696e 4d61 7820     if PhiMinMax 
+0000ed70: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+0000ed80: 2050 6869 4d69 6e4d 6178 203d 205b 2d63   PhiMinMax = [-c
+0000ed90: 5f70 692c 635f 7069 5d0a 2020 2020 2020  _pi,c_pi].      
+0000eda0: 2020 4450 6869 4d69 6e4d 6178 203d 205f    DPhiMinMax = _
+0000edb0: 5457 4f50 490a 2020 2020 2020 2020 4675  TWOPI.        Fu
+0000edc0: 6c6c 203d 2054 7275 650a 2020 2020 656c  ll = True.    el
+0000edd0: 7365 3a0a 2020 2020 2020 2020 5068 694d  se:.        PhiM
+0000ede0: 696e 4d61 7820 3d20 5b63 5f61 7461 6e32  inMax = [c_atan2
+0000edf0: 2863 5f73 696e 2850 6869 4d69 6e4d 6178  (c_sin(PhiMinMax
+0000ee00: 5b30 5d29 2c63 5f63 6f73 2850 6869 4d69  [0]),c_cos(PhiMi
+0000ee10: 6e4d 6178 5b30 5d29 292c 0a20 2020 2020  nMax[0])),.     
+0000ee20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ee30: 635f 6174 616e 3228 635f 7369 6e28 5068  c_atan2(c_sin(Ph
+0000ee40: 694d 696e 4d61 785b 315d 292c 635f 636f  iMinMax[1]),c_co
+0000ee50: 7328 5068 694d 696e 4d61 785b 315d 2929  s(PhiMinMax[1]))
+0000ee60: 5d0a 2020 2020 2020 2020 4450 6869 4d69  ].        DPhiMi
+0000ee70: 6e4d 6178 203d 2050 6869 4d69 6e4d 6178  nMax = PhiMinMax
+0000ee80: 5b31 5d2d 5068 694d 696e 4d61 785b 305d  [1]-PhiMinMax[0]
+0000ee90: 2069 6620 5068 694d 696e 4d61 785b 315d   if PhiMinMax[1]
+0000eea0: 3e3d 5068 694d 696e 4d61 785b 305d 205c  >=PhiMinMax[0] \
+0000eeb0: 0a20 2020 2020 2020 2020 2065 6c73 6520  .          else 
+0000eec0: 5f54 574f 5049 202b 2050 6869 4d69 6e4d  _TWOPI + PhiMinM
+0000eed0: 6178 5b31 5d20 2d20 5068 694d 696e 4d61  ax[1] - PhiMinMa
+0000eee0: 785b 305d 0a20 2020 2020 2020 2046 756c  x[0].        Ful
+0000eef0: 6c20 3d20 4661 6c73 650a 0a20 2020 2023  l = False..    #
+0000ef00: 2047 6574 2074 6865 206c 696d 6974 7320   Get the limits 
+0000ef10: 6966 2061 6e79 2028 616e 6420 6d61 6b65  if any (and make
+0000ef20: 2073 7572 6520 746f 2072 6570 6c61 6365   sure to replace
+0000ef30: 2074 6865 6d20 696e 2074 6865 2070 726f   them in the pro
+0000ef40: 7065 720a 2020 2020 2320 7175 6164 7261  per.    # quadra
+0000ef50: 6e74 7329 0a20 2020 2069 6620 4450 6869  nts).    if DPhi
+0000ef60: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0000ef70: 2020 4450 6869 302c 2044 5068 6931 203d    DPhi0, DPhi1 =
+0000ef80: 2050 6869 4d69 6e4d 6178 5b30 5d2c 2050   PhiMinMax[0], P
+0000ef90: 6869 4d69 6e4d 6178 5b31 5d0a 2020 2020  hiMinMax[1].    
+0000efa0: 656c 7365 3a0a 2020 2020 2020 2020 4450  else:.        DP
+0000efb0: 6869 3020 3d20 5068 694d 696e 4d61 785b  hi0 = PhiMinMax[
+0000efc0: 305d 2069 6620 4450 6869 5b30 5d20 6973  0] if DPhi[0] is
+0000efd0: 204e 6f6e 6520 656c 7365 2063 5f61 7461   None else c_ata
+0000efe0: 6e32 2863 5f73 696e 2844 5068 695b 305d  n2(c_sin(DPhi[0]
+0000eff0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0000f000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f020: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0000f030: 5f63 6f73 2844 5068 695b 305d 2929 0a20  _cos(DPhi[0])). 
+0000f040: 2020 2020 2020 2044 5068 6931 203d 2050         DPhi1 = P
+0000f050: 6869 4d69 6e4d 6178 5b31 5d20 6966 2044  hiMinMax[1] if D
+0000f060: 5068 695b 315d 2069 7320 4e6f 6e65 2065  Phi[1] is None e
+0000f070: 6c73 6520 635f 6174 616e 3228 635f 7369  lse c_atan2(c_si
+0000f080: 6e28 4450 6869 5b31 5d29 2c0a 2020 2020  n(DPhi[1]),.    
+0000f090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f0c0: 2020 2020 2020 2020 635f 636f 7328 4450          c_cos(DP
+0000f0d0: 6869 5b31 5d29 290a 2020 2020 4444 5068  hi[1])).    DDPh
+0000f0e0: 6920 3d20 4450 6869 312d 4450 6869 3020  i = DPhi1-DPhi0 
+0000f0f0: 6966 2044 5068 6931 3e44 5068 6930 2065  if DPhi1>DPhi0 e
+0000f100: 6c73 6520 5f54 574f 5049 2b44 5068 6931  lse _TWOPI+DPhi1
+0000f110: 2d44 5068 6930 0a0a 2020 2020 696e 7465  -DPhi0..    inte
+0000f120: 722c 2042 6f75 6e64 732c 205f 203d 205f  r, Bounds, _ = _
+0000f130: 6765 7442 6f75 6e64 7369 6e74 6572 3241  getBoundsinter2A
+0000f140: 6e67 5365 6728 4675 6c6c 2c20 5068 694d  ngSeg(Full, PhiM
+0000f150: 696e 4d61 785b 305d 2c0a 2020 2020 2020  inMax[0],.      
+0000f160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f180: 2020 2020 2020 2020 2020 2020 5068 694d              PhiM
+0000f190: 696e 4d61 785b 315d 2c20 4450 6869 302c  inMax[1], DPhi0,
+0000f1a0: 2044 5068 6931 290a 0a20 2020 2069 6620   DPhi1)..    if 
+0000f1b0: 696e 7465 723a 0a0a 2020 2020 2020 2020  inter:..        
+0000f1c0: 4243 203d 206c 6973 7428 426f 756e 6473  BC = list(Bounds
+0000f1d0: 290a 2020 2020 2020 2020 6e42 6f75 6e64  ).        nBound
+0000f1e0: 7320 3d20 6c65 6e28 426f 756e 6473 290a  s = len(Bounds).
+0000f1f0: 2020 2020 2020 2020 666f 7220 6969 2069          for ii i
+0000f200: 6e20 7261 6e67 6528 302c 6e42 6f75 6e64  n range(0,nBound
+0000f210: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
+0000f220: 6966 2042 435b 6969 5d5b 305d 3c50 6869  if BC[ii][0]<Phi
+0000f230: 4d69 6e4d 6178 5b30 5d3a 0a20 2020 2020  MinMax[0]:.     
+0000f240: 2020 2020 2020 2020 2020 2042 435b 6969             BC[ii
+0000f250: 5d5b 305d 202b 3d20 5f54 574f 5049 0a20  ][0] += _TWOPI. 
+0000f260: 2020 2020 2020 2020 2020 2069 6620 4243             if BC
+0000f270: 5b69 695d 5b31 5d3c 3d50 6869 4d69 6e4d  [ii][1]<=PhiMinM
+0000f280: 6178 5b30 5d3a 0a20 2020 2020 2020 2020  ax[0]:.         
+0000f290: 2020 2020 2020 2042 435b 6969 5d5b 315d         BC[ii][1]
+0000f2a0: 202b 3d20 5f54 574f 5049 0a0a 2020 2020   += _TWOPI..    
+0000f2b0: 2020 2020 2320 4765 7420 7468 6520 6163      # Get the ac
+0000f2c0: 7475 616c 2052 2061 6e64 205a 2072 6573  tual R and Z res
+0000f2d0: 6f6c 7574 696f 6e73 2061 6e64 206d 6573  olutions and mes
+0000f2e0: 6820 656c 656d 656e 7473 0a20 2020 2020  h elements.     
+0000f2f0: 2020 2070 7473 4372 6f73 732c 2064 4c72     ptsCross, dLr
+0000f300: 2c20 696e 644c 2c20 5c0a 2020 2020 2020  , indL, \.      
+0000f310: 2020 2020 4e4c 2c20 5272 6566 2c20 5650      NL, Rref, VP
+0000f320: 6269 7320 3d20 6469 7363 7265 7469 7a65  bis = discretize
+0000f330: 5f76 706f 6c79 2856 506f 6c79 2c20 644c  _vpoly(VPoly, dL
+0000f340: 2c20 4431 3d4e 6f6e 652c 2044 323d 4e6f  , D1=None, D2=No
+0000f350: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+0000f360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f380: 206d 6172 6769 6e3d 6d61 7267 696e 2c20   margin=margin, 
+0000f390: 4449 6e3d 4449 6e2c 2056 496e 3d56 496e  DIn=DIn, VIn=VIn
+0000f3a0: 290a 2020 2020 2020 2020 5230 203d 206e  ).        R0 = n
+0000f3b0: 702e 636f 7079 2852 7265 6629 0a20 2020  p.copy(Rref).   
+0000f3c0: 2020 2020 204e 5230 203d 2052 302e 7369       NR0 = R0.si
+0000f3d0: 7a65 0a20 2020 2020 2020 2069 6e64 696e  ze.        indin
+0000f3e0: 203d 206e 702e 6f6e 6573 2828 7074 7343   = np.ones((ptsC
+0000f3f0: 726f 7373 2e73 6861 7065 5b31 5d2c 292c  ross.shape[1],),
+0000f400: 6474 7970 653d 626f 6f6c 290a 2020 2020  dtype=bool).    
+0000f410: 2020 2020 6966 2044 5220 6973 206e 6f74      if DR is not
+0000f420: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0000f430: 2020 2069 6620 4452 5b30 5d20 6973 206e     if DR[0] is n
+0000f440: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+0000f450: 2020 2020 2020 2020 2069 6e64 696e 203d           indin =
+0000f460: 2069 6e64 696e 2026 2028 5230 203e 3d20   indin & (R0 >= 
+0000f470: 4452 5b30 5d29 0a20 2020 2020 2020 2020  DR[0]).         
+0000f480: 2020 2069 6620 4452 5b31 5d20 6973 206e     if DR[1] is n
+0000f490: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+0000f4a0: 2020 2020 2020 2020 2069 6e64 696e 203d           indin =
+0000f4b0: 2069 6e64 696e 2026 2028 5230 203c 3d20   indin & (R0 <= 
+0000f4c0: 4452 5b31 5d29 0a20 2020 2020 2020 2069  DR[1]).        i
+0000f4d0: 6620 445a 2069 7320 6e6f 7420 4e6f 6e65  f DZ is not None
+0000f4e0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+0000f4f0: 2044 5a5b 305d 2069 7320 6e6f 7420 4e6f   DZ[0] is not No
+0000f500: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0000f510: 2020 2020 696e 6469 6e20 3d20 696e 6469      indin = indi
+0000f520: 6e20 2620 2870 7473 4372 6f73 735b 312c  n & (ptsCross[1,
+0000f530: 3a5d 203e 3d20 445a 5b30 5d29 0a20 2020  :] >= DZ[0]).   
+0000f540: 2020 2020 2020 2020 2069 6620 445a 5b31           if DZ[1
+0000f550: 5d20 6973 206e 6f74 204e 6f6e 653a 0a20  ] is not None:. 
+0000f560: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000f570: 6e64 696e 203d 2069 6e64 696e 2026 2028  ndin = indin & (
+0000f580: 7074 7343 726f 7373 5b31 2c3a 5d20 3c3d  ptsCross[1,:] <=
+0000f590: 2044 5a5b 315d 290a 0a20 2020 2020 2020   DZ[1])..       
+0000f5a0: 2070 7473 4372 6f73 7320 3d20 7074 7343   ptsCross = ptsC
+0000f5b0: 726f 7373 5b3a 2c69 6e64 696e 5d0a 2020  ross[:,indin].  
+0000f5c0: 2020 2020 2020 644c 7220 3d20 644c 725b        dLr = dLr[
+0000f5d0: 696e 6469 6e5d 0a20 2020 2020 2020 2069  indin].        i
+0000f5e0: 6e64 4c20 3d20 696e 644c 5b69 6e64 696e  ndL = indL[indin
+0000f5f0: 5d0a 2020 2020 2020 2020 5272 6566 203d  ].        Rref =
+0000f600: 2052 7265 665b 696e 6469 6e5d 0a0a 2020   Rref[indin]..  
+0000f610: 2020 2020 2020 4c6e 203d 2069 6e64 696e        Ln = indin
+0000f620: 2e73 756d 2829 0a20 2020 2020 2020 2049  .sum().        I
+0000f630: 6e64 696e 203d 2069 6e64 696e 2e6e 6f6e  ndin = indin.non
+0000f640: 7a65 726f 2829 5b30 5d2e 6173 7479 7065  zero()[0].astype
+0000f650: 2869 6e74 290a 0a20 2020 2020 2020 2064  (int)..        d
+0000f660: 5250 6869 722c 2064 5068 6972 203d 206e  RPhir, dPhir = n
+0000f670: 702e 656d 7074 7928 284c 6e2c 2929 2c20  p.empty((Ln,)), 
+0000f680: 6e70 2e65 6d70 7479 2828 4c6e 2c29 290a  np.empty((Ln,)).
+0000f690: 2020 2020 2020 2020 5068 696e 203d 206e          Phin = n
+0000f6a0: 702e 7a65 726f 7328 284c 6e2c 292c 6474  p.zeros((Ln,),dt
+0000f6b0: 7970 653d 696e 7429 0a20 2020 2020 2020  ype=int).       
+0000f6c0: 204e 5250 6869 203d 206e 702e 656d 7074   NRPhi = np.empt
+0000f6d0: 7928 284c 6e2c 2929 0a20 2020 2020 2020  y((Ln,)).       
+0000f6e0: 204e 5250 6869 3020 3d20 6e70 2e7a 6572   NRPhi0 = np.zer
+0000f6f0: 6f73 2828 4c6e 2c29 2c64 7479 7065 3d69  os((Ln,),dtype=i
+0000f700: 6e74 290a 2020 2020 2020 2020 6e52 5068  nt).        nRPh
+0000f710: 6930 2c20 696e 6452 3069 6920 3d20 302c  i0, indR0ii = 0,
+0000f720: 2030 0a20 2020 2020 2020 206e 7074 735f   0.        npts_
+0000f730: 6469 7363 203d 2030 0a20 2020 2020 2020  disc = 0.       
+0000f740: 2072 6164 6975 735f 7261 7469 6f20 3d20   radius_ratio = 
+0000f750: 696e 7428 635f 6365 696c 286e 702e 6d61  int(c_ceil(np.ma
+0000f760: 7828 5272 6566 292f 6e70 2e6d 696e 2852  x(Rref)/np.min(R
+0000f770: 7265 6629 2929 0a20 2020 2020 2020 2069  ref))).        i
+0000f780: 6e64 426f 756e 6473 203d 206e 702e 656d  ndBounds = np.em
+0000f790: 7074 7928 2832 2c6e 426f 756e 6473 292c  pty((2,nBounds),
+0000f7a0: 6474 7970 653d 696e 7429 0a20 2020 2020  dtype=int).     
+0000f7b0: 2020 2066 6f72 2069 6920 696e 2072 616e     for ii in ran
+0000f7c0: 6765 2830 2c4c 6e29 3a0a 2020 2020 2020  ge(0,Ln):.      
+0000f7d0: 2020 2020 2020 2320 4765 7420 7468 6520        # Get the 
+0000f7e0: 6163 7475 616c 2052 5068 6920 7265 736f  actual RPhi reso
+0000f7f0: 6c75 7469 6f6e 2061 6e64 2050 6869 206d  lution and Phi m
+0000f800: 6573 6820 656c 656d 656e 7473 0a20 2020  esh elements.   
+0000f810: 2020 2020 2020 2020 2023 2028 2120 6465           # (! de
+0000f820: 7065 6e64 7320 6f6e 2052 2129 0a20 2020  pends on R!).   
+0000f830: 2020 2020 2020 2020 204e 5250 6869 5b69           NRPhi[i
+0000f840: 695d 203d 2063 5f63 6569 6c28 4450 6869  i] = c_ceil(DPhi
+0000f850: 4d69 6e4d 6178 2a52 7265 665b 6969 5d2f  MinMax*Rref[ii]/
+0000f860: 6452 5068 6929 0a20 2020 2020 2020 2020  dRPhi).         
+0000f870: 2020 204e 5250 6869 5f69 6e74 203d 2069     NRPhi_int = i
+0000f880: 6e74 284e 5250 6869 5b69 695d 290a 2020  nt(NRPhi[ii]).  
+0000f890: 2020 2020 2020 2020 2020 6450 6869 725b            dPhir[
+0000f8a0: 6969 5d20 3d20 4450 6869 4d69 6e4d 6178  ii] = DPhiMinMax
+0000f8b0: 2f4e 5250 6869 5b69 695d 0a20 2020 2020  /NRPhi[ii].     
+0000f8c0: 2020 2020 2020 2064 5250 6869 725b 6969         dRPhir[ii
+0000f8d0: 5d20 3d20 6450 6869 725b 6969 5d2a 5272  ] = dPhir[ii]*Rr
+0000f8e0: 6566 5b69 695d 0a20 2020 2020 2020 2020  ef[ii].         
+0000f8f0: 2020 2023 2047 6574 2069 6e64 6578 2061     # Get index a
+0000f900: 6e64 2063 756d 756c 6174 6564 2069 6e64  nd cumulated ind
+0000f910: 6963 6573 2066 726f 6d20 6261 636b 6772  ices from backgr
+0000f920: 6f75 6e64 0a20 2020 2020 2020 2020 2020  ound.           
+0000f930: 2066 6f72 206a 6a30 2069 6e20 7261 6e67   for jj0 in rang
+0000f940: 6528 696e 6452 3069 692c 4e52 3029 3a0a  e(indR0ii,NR0):.
+0000f950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f960: 6966 206a 6a30 3d3d 496e 6469 6e5b 6969  if jj0==Indin[ii
+0000f970: 5d3a 0a20 2020 2020 2020 2020 2020 2020  ]:.             
+0000f980: 2020 2020 2020 2069 6e64 5230 6969 203d         indR0ii =
+0000f990: 206a 6a30 0a20 2020 2020 2020 2020 2020   jj0.           
+0000f9a0: 2020 2020 2020 2020 2062 7265 616b 0a20           break. 
+0000f9b0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0000f9c0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0000f9d0: 2020 2020 2020 2020 206e 5250 6869 3020           nRPhi0 
+0000f9e0: 2b3d 203c 6c6f 6e67 3e63 5f63 6569 6c28  += <long>c_ceil(
+0000f9f0: 4450 6869 4d69 6e4d 6178 2a52 305b 6a6a  DPhiMinMax*R0[jj
+0000fa00: 305d 2f64 5250 6869 290a 2020 2020 2020  0]/dRPhi).      
+0000fa10: 2020 2020 2020 2020 2020 2020 2020 4e52                NR
+0000fa20: 5068 6930 5b69 695d 203d 206e 5250 6869  Phi0[ii] = nRPhi
+0000fa30: 300a 2020 2020 2020 2020 2020 2020 2320  0.            # 
+0000fa40: 4765 7420 696e 6469 6365 7320 6f66 2070  Get indices of p
+0000fa50: 6869 0a20 2020 2020 2020 2020 2020 2023  hi.            #
+0000fa60: 2047 6574 2074 6865 2065 7874 7265 6d65   Get the extreme
+0000fa70: 2069 6e64 6963 6573 206f 6620 7468 6520   indices of the 
+0000fa80: 6d65 7368 2065 6c65 6d65 6e74 7320 7468  mesh elements th
+0000fa90: 6174 2072 6561 6c6c 7920 6e65 6564 2074  at really need t
+0000faa0: 6f0a 2020 2020 2020 2020 2020 2020 2320  o.            # 
+0000fab0: 6265 2063 7265 6174 6564 2077 6974 6869  be created withi
+0000fac0: 6e20 7468 6f73 6520 6c69 6d69 7473 0a20  n those limits. 
+0000fad0: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
+0000fae0: 6b20 696e 2072 616e 6765 2830 2c6e 426f  k in range(0,nBo
+0000faf0: 756e 6473 293a 0a20 2020 2020 2020 2020  unds):.         
+0000fb00: 2020 2020 2020 2061 6273 3020 3d20 4243         abs0 = BC
+0000fb10: 5b6b 6b5d 5b30 5d2d 5068 694d 696e 4d61  [kk][0]-PhiMinMa
+0000fb20: 785b 305d 0a20 2020 2020 2020 2020 2020  x[0].           
+0000fb30: 2020 2020 2069 6620 6162 7330 2d64 5068       if abs0-dPh
+0000fb40: 6972 5b69 695d 2a63 5f66 6c6f 6f72 2861  ir[ii]*c_floor(a
+0000fb50: 6273 302f 6450 6869 725b 6969 5d29 3c6d  bs0/dPhir[ii])<m
+0000fb60: 6172 6769 6e2a 6450 6869 725b 6969 5d3a  argin*dPhir[ii]:
+0000fb70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000fb80: 2020 2020 206e 7068 6930 203d 2069 6e74       nphi0 = int
+0000fb90: 2863 5f72 6f75 6e64 2861 6273 302f 6450  (c_round(abs0/dP
+0000fba0: 6869 725b 6969 5d29 290a 2020 2020 2020  hir[ii])).      
+0000fbb0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0000fbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fbd0: 2020 2020 6e70 6869 3020 3d20 696e 7428      nphi0 = int(
+0000fbe0: 635f 666c 6f6f 7228 6162 7330 2f64 5068  c_floor(abs0/dPh
+0000fbf0: 6972 5b69 695d 2929 0a20 2020 2020 2020  ir[ii])).       
+0000fc00: 2020 2020 2020 2020 2061 6273 3120 3d20           abs1 = 
+0000fc10: 4243 5b6b 6b5d 5b31 5d2d 5068 694d 696e  BC[kk][1]-PhiMin
+0000fc20: 4d61 785b 305d 0a20 2020 2020 2020 2020  Max[0].         
+0000fc30: 2020 2020 2020 2069 6620 6162 7331 2d64         if abs1-d
+0000fc40: 5068 6972 5b69 695d 2a63 5f66 6c6f 6f72  Phir[ii]*c_floor
+0000fc50: 2861 6273 312f 6450 6869 725b 6969 5d29  (abs1/dPhir[ii])
+0000fc60: 3c6d 6172 6769 6e2a 6450 6869 725b 6969  <margin*dPhir[ii
+0000fc70: 5d3a 0a20 2020 2020 2020 2020 2020 2020  ]:.             
+0000fc80: 2020 2020 2020 206e 7068 6931 203d 2069         nphi1 = i
+0000fc90: 6e74 2863 5f72 6f75 6e64 2861 6273 312f  nt(c_round(abs1/
+0000fca0: 6450 6869 725b 6969 5d29 2d31 290a 2020  dPhir[ii])-1).  
+0000fcb0: 2020 2020 2020 2020 2020 2020 2020 656c                el
+0000fcc0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0000fcd0: 2020 2020 2020 2020 6e70 6869 3120 3d20          nphi1 = 
+0000fce0: 696e 7428 635f 666c 6f6f 7228 6162 7331  int(c_floor(abs1
+0000fcf0: 2f64 5068 6972 5b69 695d 2929 0a20 2020  /dPhir[ii])).   
+0000fd00: 2020 2020 2020 2020 2020 2020 2069 6e64               ind
+0000fd10: 426f 756e 6473 5b30 2c6b 6b5d 203d 206e  Bounds[0,kk] = n
+0000fd20: 7068 6930 0a20 2020 2020 2020 2020 2020  phi0.           
+0000fd30: 2020 2020 2069 6e64 426f 756e 6473 5b31       indBounds[1
+0000fd40: 2c6b 6b5d 203d 206e 7068 6931 0a20 2020  ,kk] = nphi1.   
+0000fd50: 2020 2020 2020 2020 2020 2020 2050 6869               Phi
+0000fd60: 6e5b 6969 5d20 2b3d 206e 7068 6931 2b31  n[ii] += nphi1+1
+0000fd70: 2d6e 7068 6930 0a0a 2020 2020 2020 2020  -nphi0..        
+0000fd80: 2020 2020 6966 2069 693d 3d30 3a0a 2020      if ii==0:.  
+0000fd90: 2020 2020 2020 2020 2020 2020 2020 696e                in
+0000fda0: 6449 203d 206e 702e 6e61 6e2a 6e70 2e6f  dI = np.nan*np.o
+0000fdb0: 6e65 7328 284c 6e2c 5068 696e 5b69 695d  nes((Ln,Phin[ii]
+0000fdc0: 2a72 6164 6975 735f 7261 7469 6f2b 3129  *radius_ratio+1)
+0000fdd0: 290a 2020 2020 2020 2020 2020 2020 6a6a  ).            jj
+0000fde0: 203d 2030 0a20 2020 2020 2020 2020 2020   = 0.           
+0000fdf0: 2066 6f72 206b 6b20 696e 2072 616e 6765   for kk in range
+0000fe00: 2830 2c6e 426f 756e 6473 293a 0a20 2020  (0,nBounds):.   
+0000fe10: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0000fe20: 206b 6b62 2069 6e20 7261 6e67 6528 696e   kkb in range(in
+0000fe30: 6442 6f75 6e64 735b 302c 6b6b 5d2c 696e  dBounds[0,kk],in
+0000fe40: 6442 6f75 6e64 735b 312c 6b6b 5d2b 3129  dBounds[1,kk]+1)
+0000fe50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000fe60: 2020 2020 2020 696e 6449 5b69 692c 6a6a        indI[ii,jj
+0000fe70: 5d20 3d20 3c64 6f75 626c 653e 2820 6b6b  ] = <double>( kk
+0000fe80: 6220 290a 2020 2020 2020 2020 2020 2020  b ).            
+0000fe90: 2020 2020 2020 2020 6a6a 202b 3d20 310a          jj += 1.
+0000fea0: 2020 2020 2020 2020 2020 2020 6e70 7473              npts
+0000feb0: 5f64 6973 6320 2b3d 2050 6869 6e5b 6969  _disc += Phin[ii
+0000fec0: 5d0a 0a20 2020 2020 2020 2023 2046 696e  ]..        # Fin
+0000fed0: 6973 6820 636f 756e 7469 6e67 2074 6f20  ish counting to 
+0000fee0: 6765 7420 746f 7461 6c20 6e75 6d62 6572  get total number
+0000fef0: 206f 6620 706f 696e 7473 0a20 2020 2020   of points.     
+0000ff00: 2020 2069 6620 6a6a 303c 3d4e 5230 2d31     if jj0<=NR0-1
+0000ff10: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
+0000ff20: 7220 6a6a 3020 696e 2072 616e 6765 2869  r jj0 in range(i
+0000ff30: 6e64 5230 6969 2c4e 5230 293a 0a20 2020  ndR0ii,NR0):.   
+0000ff40: 2020 2020 2020 2020 2020 2020 206e 5250               nRP
+0000ff50: 6869 3020 2b3d 203c 6c6f 6e67 3e63 5f63  hi0 += <long>c_c
+0000ff60: 6569 6c28 4450 6869 4d69 6e4d 6178 2a52  eil(DPhiMinMax*R
+0000ff70: 305b 6a6a 305d 2f64 5250 6869 290a 0a20  0[jj0]/dRPhi).. 
+0000ff80: 2020 2020 2020 2023 2043 6f6d 7075 7465         # Compute
+0000ff90: 2070 7473 2c20 7265 7333 6420 616e 6420   pts, res3d and 
+0000ffa0: 696e 640a 2020 2020 2020 2020 7074 7320  ind.        pts 
+0000ffb0: 3d20 6e70 2e6e 616e 2a6e 702e 6f6e 6573  = np.nan*np.ones
+0000ffc0: 2828 332c 6e70 7473 5f64 6973 6329 290a  ((3,npts_disc)).
+0000ffd0: 2020 2020 2020 2020 696e 6420 3d20 6e70          ind = np
+0000ffe0: 2e6e 616e 2a6e 702e 6f6e 6573 2828 6e70  .nan*np.ones((np
+0000fff0: 7473 5f64 6973 632c 2929 0a20 2020 2020  ts_disc,)).     
+00010000: 2020 2064 5320 3d20 6e70 2e6e 616e 2a6e     dS = np.nan*n
+00010010: 702e 6f6e 6573 2828 6e70 7473 5f64 6973  p.ones((npts_dis
+00010020: 632c 2929 0a20 2020 2020 2020 2023 2054  c,)).        # T
+00010030: 6869 7320 7472 6970 6c65 206c 6f6f 7020  his triple loop 
+00010040: 6973 2074 6865 206c 6f6e 6765 7374 2070  is the longest p
+00010050: 6172 742c 2069 7420 7461 6b65 7320 7e39  art, it takes ~9
+00010060: 3025 206f 6620 7468 6520 4350 5520 7469  0% of the CPU ti
+00010070: 6d65 0a20 2020 2020 2020 206e 7074 735f  me.        npts_
+00010080: 6469 7363 203d 2030 0a20 2020 2020 2020  disc = 0.       
+00010090: 2069 6620 4f75 742e 6c6f 7765 7228 293d   if Out.lower()=
+000100a0: 3d27 2878 2c79 2c7a 2927 3a0a 2020 2020  ='(x,y,z)':.    
+000100b0: 2020 2020 2020 2020 666f 7220 6969 2069          for ii i
+000100c0: 6e20 7261 6e67 6528 302c 4c6e 293a 0a20  n range(0,Ln):. 
+000100d0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+000100e0: 2053 6f6d 6520 7261 7265 2063 6173 6573   Some rare cases
+000100f0: 2077 6974 6820 646f 7562 6c65 7320 6861   with doubles ha
+00010100: 7665 2074 6f20 6265 2065 6c69 6d69 6e61  ve to be elimina
+00010110: 7465 643a 0a20 2020 2020 2020 2020 2020  ted:.           
+00010120: 2020 2020 2069 6969 203d 206e 702e 756e       iii = np.un
+00010130: 6971 7565 2869 6e64 495b 6969 2c7e 6e70  ique(indI[ii,~np
+00010140: 2e69 736e 616e 2869 6e64 495b 6969 2c3a  .isnan(indI[ii,:
+00010150: 5d29 5d29 0a20 2020 2020 2020 2020 2020  ])]).           
+00010160: 2020 2020 2066 6f72 206a 6a20 696e 2072       for jj in r
+00010170: 616e 6765 2830 2c6c 656e 2869 6969 2929  ange(0,len(iii))
+00010180: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00010190: 2020 2020 2020 696e 6469 696a 6a20 3d20        indiijj = 
+000101a0: 6969 695b 6a6a 5d0a 2020 2020 2020 2020  iii[jj].        
+000101b0: 2020 2020 2020 2020 2020 2020 7068 6920              phi 
+000101c0: 3d20 5068 694d 696e 4d61 785b 305d 202b  = PhiMinMax[0] +
+000101d0: 2028 302e 352b 696e 6469 696a 6a29 2a64   (0.5+indiijj)*d
+000101e0: 5068 6972 5b69 695d 0a20 2020 2020 2020  Phir[ii].       
+000101f0: 2020 2020 2020 2020 2020 2020 2070 7473               pts
+00010200: 5b30 2c6e 7074 735f 6469 7363 5d20 3d20  [0,npts_disc] = 
+00010210: 7074 7343 726f 7373 5b30 2c69 695d 2a63  ptsCross[0,ii]*c
+00010220: 5f63 6f73 2870 6869 290a 2020 2020 2020  _cos(phi).      
+00010230: 2020 2020 2020 2020 2020 2020 2020 7074                pt
+00010240: 735b 312c 6e70 7473 5f64 6973 635d 203d  s[1,npts_disc] =
+00010250: 2070 7473 4372 6f73 735b 302c 6969 5d2a   ptsCross[0,ii]*
+00010260: 635f 7369 6e28 7068 6929 0a20 2020 2020  c_sin(phi).     
+00010270: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00010280: 7473 5b32 2c6e 7074 735f 6469 7363 5d20  ts[2,npts_disc] 
+00010290: 3d20 7074 7343 726f 7373 5b31 2c69 695d  = ptsCross[1,ii]
+000102a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000102b0: 2020 2020 2069 6e64 5b6e 7074 735f 6469       ind[npts_di
+000102c0: 7363 5d20 3d20 4e52 5068 6930 5b69 695d  sc] = NRPhi0[ii]
+000102d0: 202b 2069 6e64 6969 6a6a 0a20 2020 2020   + indiijj.     
+000102e0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+000102f0: 535b 6e70 7473 5f64 6973 635d 203d 2064  S[npts_disc] = d
+00010300: 4c72 5b69 695d 2a64 5250 6869 725b 6969  Lr[ii]*dRPhir[ii
+00010310: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00010320: 2020 2020 2020 6e70 7473 5f64 6973 6320        npts_disc 
+00010330: 2b3d 2031 0a20 2020 2020 2020 2065 6c73  += 1.        els
+00010340: 653a 0a20 2020 2020 2020 2020 2020 2066  e:.            f
+00010350: 6f72 2069 6920 696e 2072 616e 6765 2830  or ii in range(0
+00010360: 2c4c 6e29 3a0a 2020 2020 2020 2020 2020  ,Ln):.          
+00010370: 2020 2020 2020 6969 6920 3d20 6e70 2e75        iii = np.u
+00010380: 6e69 7175 6528 696e 6449 5b69 692c 7e6e  nique(indI[ii,~n
+00010390: 702e 6973 6e61 6e28 696e 6449 5b69 692c  p.isnan(indI[ii,
+000103a0: 3a5d 295d 290a 2020 2020 2020 2020 2020  :])]).          
+000103b0: 2020 2020 2020 666f 7220 6a6a 2069 6e20        for jj in 
+000103c0: 7261 6e67 6528 302c 6c65 6e28 6969 6929  range(0,len(iii)
+000103d0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000103e0: 2020 2020 2020 2069 6e64 6969 6a6a 203d         indiijj =
+000103f0: 2069 6969 5b6a 6a5d 0a20 2020 2020 2020   iii[jj].       
+00010400: 2020 2020 2020 2020 2020 2020 2070 7473               pts
+00010410: 5b30 2c6e 7074 735f 6469 7363 5d20 3d20  [0,npts_disc] = 
+00010420: 7074 7343 726f 7373 5b30 2c69 695d 0a20  ptsCross[0,ii]. 
+00010430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010440: 2020 2070 7473 5b31 2c6e 7074 735f 6469     pts[1,npts_di
+00010450: 7363 5d20 3d20 7074 7343 726f 7373 5b31  sc] = ptsCross[1
+00010460: 2c69 695d 0a20 2020 2020 2020 2020 2020  ,ii].           
+00010470: 2020 2020 2020 2020 2070 7473 5b32 2c6e           pts[2,n
+00010480: 7074 735f 6469 7363 5d20 3d20 5068 694d  pts_disc] = PhiM
+00010490: 696e 4d61 785b 305d 202b 2028 302e 352b  inMax[0] + (0.5+
+000104a0: 696e 6469 696a 6a29 2a64 5068 6972 5b69  indiijj)*dPhir[i
+000104b0: 695d 0a20 2020 2020 2020 2020 2020 2020  i].             
+000104c0: 2020 2020 2020 2069 6e64 5b6e 7074 735f         ind[npts_
+000104d0: 6469 7363 5d20 3d20 4e52 5068 6930 5b69  disc] = NRPhi0[i
+000104e0: 695d 202b 2069 6e64 6969 6a6a 0a20 2020  i] + indiijj.   
+000104f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010500: 2064 535b 6e70 7473 5f64 6973 635d 203d   dS[npts_disc] =
+00010510: 2064 4c72 5b69 695d 2a64 5250 6869 725b   dLr[ii]*dRPhir[
+00010520: 6969 5d0a 2020 2020 2020 2020 2020 2020  ii].            
+00010530: 2020 2020 2020 2020 6e70 7473 5f64 6973          npts_dis
+00010540: 6320 2b3d 2031 0a20 2020 2020 2020 2069  c += 1.        i
+00010550: 6e64 6f6b 203d 2028 7e6e 702e 6973 6e61  ndok = (~np.isna
+00010560: 6e28 696e 6429 292e 6e6f 6e7a 6572 6f28  n(ind)).nonzero(
+00010570: 295b 305d 2e61 7374 7970 6528 696e 7429  )[0].astype(int)
+00010580: 0a20 2020 2020 2020 2069 6e64 203d 2069  .        ind = i
+00010590: 6e64 5b69 6e64 6f6b 5d0a 2020 2020 2020  nd[indok].      
+000105a0: 2020 6453 203d 2064 535b 696e 646f 6b5d    dS = dS[indok]
+000105b0: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
+000105c0: 696e 646f 6b29 3d3d 313a 0a20 2020 2020  indok)==1:.     
+000105d0: 2020 2020 2020 2070 7473 203d 2070 7473         pts = pts
+000105e0: 5b3a 2c69 6e64 6f6b 5d2e 7265 7368 6170  [:,indok].reshap
+000105f0: 6528 2833 2c31 2929 0a20 2020 2020 2020  e((3,1)).       
+00010600: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00010610: 2020 2070 7473 203d 2070 7473 5b3a 2c69     pts = pts[:,i
+00010620: 6e64 6f6b 5d0a 2020 2020 656c 7365 3a0a  ndok].    else:.
+00010630: 2020 2020 2020 2020 7074 732c 2064 532c          pts, dS,
+00010640: 2069 6e64 2c20 4e4c 2c20 5272 6566 2c20   ind, NL, Rref, 
+00010650: 6452 5068 6972 2c20 6e52 5068 6930 203d  dRPhir, nRPhi0 =
+00010660: 206e 702e 6f6e 6573 2828 332c 3029 292c   np.ones((3,0)),
+00010670: 206e 702e 6f6e 6573 2828 302c 2929 2c5c   np.ones((0,)),\
+00010680: 0a20 2020 2020 2020 2020 206e 702e 6f6e  .          np.on
+00010690: 6573 2828 302c 2929 2c20 6e70 2e6e 616e  es((0,)), np.nan
+000106a0: 2a6e 702e 6f6e 6573 2828 5650 6f6c 792e  *np.ones((VPoly.
+000106b0: 7368 6170 655b 315d 2d31 2c29 292c 5c0a  shape[1]-1,)),\.
+000106c0: 2020 2020 2020 2020 2020 6e70 2e6f 6e65            np.one
+000106d0: 7328 2830 2c29 292c 206e 702e 6f6e 6573  s((0,)), np.ones
+000106e0: 2828 302c 2929 2c20 300a 2020 2020 7265  ((0,)), 0.    re
+000106f0: 7475 726e 206e 702e 6173 636f 6e74 6967  turn np.ascontig
+00010700: 756f 7573 6172 7261 7928 7074 7329 2c20  uousarray(pts), 
+00010710: 6453 2c20 696e 642e 6173 7479 7065 2869  dS, ind.astype(i
+00010720: 6e74 292c 204e 4c2c 2064 4c72 2c20 5272  nt), NL, dLr, Rr
+00010730: 6566 2c20 6452 5068 6972 2c20 6e52 5068  ef, dRPhir, nRPh
+00010740: 6930 2c20 5650 6269 730a 0a0a 6465 6620  i0, VPbis...def 
+00010750: 5f56 6573 5f53 6d65 7368 5f54 6f72 5f53  _Ves_Smesh_Tor_S
+00010760: 7562 4672 6f6d 496e 645f 6379 7468 6f6e  ubFromInd_cython
+00010770: 2864 6f75 626c 6520 644c 2c20 646f 7562  (double dL, doub
+00010780: 6c65 2064 5250 6869 2c0a 2020 2020 2020  le dRPhi,.      
+00010790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000107a0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+000107b0: 6f75 626c 655b 3a2c 3a3a 315d 2056 506f  ouble[:,::1] VPo
+000107c0: 6c79 2c20 6c6f 6e67 5b3a 3a31 5d20 696e  ly, long[::1] in
+000107d0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+000107e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000107f0: 2020 2020 2020 2020 646f 7562 6c65 2044          double D
+00010800: 496e 3d30 2e2c 2056 496e 3d4e 6f6e 652c  In=0., VIn=None,
+00010810: 2050 6869 4d69 6e4d 6178 3d4e 6f6e 652c   PhiMinMax=None,
+00010820: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010840: 2020 2020 2020 7374 7220 4f75 743d 2728        str Out='(
+00010850: 582c 592c 5a29 272c 2064 6f75 626c 6520  X,Y,Z)', double 
+00010860: 6d61 7267 696e 3d5f 5653 4d41 4c4c 293a  margin=_VSMALL):
+00010870: 0a20 2020 2022 2222 2052 6574 7572 6e20  .    """ Return 
+00010880: 7468 6520 6465 7369 7265 6420 7375 626d  the desired subm
+00010890: 6573 6820 696e 6469 6361 7465 6420 6279  esh indicated by
+000108a0: 2074 6865 2028 6e75 6d65 7269 6361 6c29   the (numerical)
+000108b0: 2069 6e64 6963 6573 2c0a 2020 2020 666f   indices,.    fo
+000108c0: 7220 7468 6520 6465 7369 7265 6420 7265  r the desired re
+000108d0: 736f 6c75 7469 6f6e 2028 6452 2c64 5a2c  solution (dR,dZ,
+000108e0: 6452 7068 6929 0a20 2020 2022 2222 0a20  dRphi).    """. 
+000108f0: 2020 2063 6465 6620 646f 7562 6c65 5b3a     cdef double[:
+00010900: 3a31 5d20 6452 5068 6972 5265 662c 2064  :1] dRPhirRef, d
+00010910: 5068 6972 0a20 2020 2063 6465 6620 6c6f  Phir.    cdef lo
+00010920: 6e67 5b3a 3a31 5d20 696e 644c 2c20 4e52  ng[::1] indL, NR
+00010930: 5068 6930 2c20 4e52 5068 690a 2020 2020  Phi0, NRPhi.    
+00010940: 6364 6566 206c 6f6e 6720 204e 503d 6c65  cdef long  NP=le
+00010950: 6e28 696e 6429 2c20 7261 6469 7573 5f72  n(ind), radius_r
+00010960: 6174 696f 0a20 2020 2063 6465 6620 696e  atio.    cdef in
+00010970: 7420 6969 3d30 2c20 6a6a 3d30 2c20 6969  t ii=0, jj=0, ii
+00010980: 4c2c 2069 6970 6869 2c20 4c6e 2c20 6e52  L, iiphi, Ln, nR
+00010990: 5068 6930 0a20 2020 2063 6465 6620 646f  Phi0.    cdef do
+000109a0: 7562 6c65 5b3a 2c3a 3a31 5d20 5068 690a  uble[:,::1] Phi.
+000109b0: 2020 2020 6364 6566 206e 702e 6e64 6172      cdef np.ndar
+000109c0: 7261 795b 646f 7562 6c65 2c6e 6469 6d3d  ray[double,ndim=
+000109d0: 325d 2070 7473 3d6e 702e 656d 7074 7928  2] pts=np.empty(
+000109e0: 2833 2c4e 5029 292c 2070 7473 4372 6f73  (3,NP)), ptsCros
+000109f0: 732c 2056 5062 6973 0a20 2020 2063 6465  s, VPbis.    cde
+00010a00: 6620 6e70 2e6e 6461 7272 6179 5b64 6f75  f np.ndarray[dou
+00010a10: 626c 652c 6e64 696d 3d31 5d20 6453 3d6e  ble,ndim=1] dS=n
+00010a20: 702e 656d 7074 7928 284e 502c 2929 2c20  p.empty((NP,)), 
+00010a30: 644c 722c 2064 5250 6869 722c 2052 7265  dLr, dRPhir, Rre
+00010a40: 660a 2020 2020 6364 6566 206e 702e 6e64  f.    cdef np.nd
+00010a50: 6172 7261 795b 6c6f 6e67 2c6e 6469 6d3d  array[long,ndim=
+00010a60: 315d 204e 4c0a 0a20 2020 2023 2050 7265  1] NL..    # Pre
+00010a70: 2d66 6f72 6d61 7420 696e 7075 740a 2020  -format input.  
+00010a80: 2020 6966 2050 6869 4d69 6e4d 6178 2069    if PhiMinMax i
+00010a90: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+00010aa0: 5068 694d 696e 4d61 7820 3d20 5b2d 635f  PhiMinMax = [-c_
+00010ab0: 7069 2c63 5f70 695d 0a20 2020 2020 2020  pi,c_pi].       
+00010ac0: 2044 5068 694d 696e 4d61 7820 3d20 5f54   DPhiMinMax = _T
+00010ad0: 574f 5049 0a20 2020 2065 6c73 653a 0a20  WOPI.    else:. 
+00010ae0: 2020 2020 2020 2050 6869 4d69 6e4d 6178         PhiMinMax
+00010af0: 203d 205b 635f 6174 616e 3228 635f 7369   = [c_atan2(c_si
+00010b00: 6e28 5068 694d 696e 4d61 785b 305d 292c  n(PhiMinMax[0]),
+00010b10: 2063 5f63 6f73 2850 6869 4d69 6e4d 6178   c_cos(PhiMinMax
+00010b20: 5b30 5d29 292c 0a20 2020 2020 2020 2020  [0])),.         
+00010b30: 2020 2020 2020 2020 2020 2020 635f 6174              c_at
+00010b40: 616e 3228 635f 7369 6e28 5068 694d 696e  an2(c_sin(PhiMin
+00010b50: 4d61 785b 315d 292c 2063 5f63 6f73 2850  Max[1]), c_cos(P
+00010b60: 6869 4d69 6e4d 6178 5b31 5d29 295d 0a20  hiMinMax[1]))]. 
+00010b70: 2020 2020 2020 2069 6620 5068 694d 696e         if PhiMin
+00010b80: 4d61 785b 315d 3e3d 5068 694d 696e 4d61  Max[1]>=PhiMinMa
+00010b90: 785b 305d 3a0a 2020 2020 2020 2020 2020  x[0]:.          
+00010ba0: 2020 4450 6869 4d69 6e4d 6178 203d 2050    DPhiMinMax = P
+00010bb0: 6869 4d69 6e4d 6178 5b31 5d2d 5068 694d  hiMinMax[1]-PhiM
+00010bc0: 696e 4d61 785b 305d 0a20 2020 2020 2020  inMax[0].       
+00010bd0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00010be0: 2020 2044 5068 694d 696e 4d61 7820 3d20     DPhiMinMax = 
+00010bf0: 5f54 574f 5049 202b 2050 6869 4d69 6e4d  _TWOPI + PhiMinM
+00010c00: 6178 5b31 5d20 2d20 5068 694d 696e 4d61  ax[1] - PhiMinMa
+00010c10: 785b 305d 0a0a 0a20 2020 2023 2047 6574  x[0]...    # Get
+00010c20: 2074 6865 2061 6374 7561 6c20 5220 616e   the actual R an
+00010c30: 6420 5a20 7265 736f 6c75 7469 6f6e 7320  d Z resolutions 
+00010c40: 616e 6420 6d65 7368 2065 6c65 6d65 6e74  and mesh element
+00010c50: 730a 2020 2020 7074 7343 726f 7373 2c20  s.    ptsCross, 
+00010c60: 644c 7252 6566 2c20 696e 644c 2c5c 0a20  dLrRef, indL,\. 
+00010c70: 2020 2020 204e 4c2c 2052 7265 6652 6566       NL, RrefRef
+00010c80: 2c20 5650 6269 7320 3d20 6469 7363 7265  , VPbis = discre
+00010c90: 7469 7a65 5f76 706f 6c79 2856 506f 6c79  tize_vpoly(VPoly
+00010ca0: 2c20 644c 2c20 4431 3d4e 6f6e 652c 2044  , dL, D1=None, D
+00010cb0: 323d 4e6f 6e65 2c0a 2020 2020 2020 2020  2=None,.        
+00010cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010ce0: 2020 2020 6d61 7267 696e 3d6d 6172 6769      margin=margi
+00010cf0: 6e2c 2044 496e 3d44 496e 2c20 5649 6e3d  n, DIn=DIn, VIn=
+00010d00: 5649 6e29 0a20 2020 204c 6e20 3d20 644c  VIn).    Ln = dL
+00010d10: 7252 6566 2e73 697a 650a 2020 2020 2320  rRef.size.    # 
+00010d20: 4e75 6d62 6572 206f 6620 5068 6920 7065  Number of Phi pe
+00010d30: 7220 520a 2020 2020 6452 5068 6972 5265  r R.    dRPhirRe
+00010d40: 662c 2064 5068 6972 2c20 6452 5068 6972  f, dPhir, dRPhir
+00010d50: 203d 206e 702e 656d 7074 7928 284c 6e2c   = np.empty((Ln,
+00010d60: 2929 2c20 6e70 2e65 6d70 7479 2828 4c6e  )), np.empty((Ln
+00010d70: 2c29 292c 202d 6e70 2e6f 6e65 7328 284c  ,)), -np.ones((L
+00010d80: 6e2c 2929 0a20 2020 2064 4c72 2c20 5272  n,)).    dLr, Rr
+00010d90: 6566 203d 202d 6e70 2e6f 6e65 7328 284c  ef = -np.ones((L
+00010da0: 6e2c 2929 2c20 2d6e 702e 6f6e 6573 2828  n,)), -np.ones((
+00010db0: 4c6e 2c29 290a 2020 2020 4e52 5068 692c  Ln,)).    NRPhi,
+00010dc0: 204e 5250 6869 3020 3d20 6e70 2e65 6d70   NRPhi0 = np.emp
+00010dd0: 7479 2828 4c6e 2c29 2c64 7479 7065 3d69  ty((Ln,),dtype=i
+00010de0: 6e74 292c 206e 702e 656d 7074 7928 284c  nt), np.empty((L
+00010df0: 6e2c 292c 6474 7970 653d 696e 7429 0a20  n,),dtype=int). 
+00010e00: 2020 2072 6164 6975 735f 7261 7469 6f20     radius_ratio 
+00010e10: 3d20 696e 7428 635f 6365 696c 286e 702e  = int(c_ceil(np.
+00010e20: 6d61 7828 5272 6566 5265 6629 2f6e 702e  max(RrefRef)/np.
+00010e30: 6d69 6e28 5272 6566 5265 6629 2929 0a20  min(RrefRef))). 
+00010e40: 2020 2066 6f72 2069 6920 696e 2072 616e     for ii in ran
+00010e50: 6765 2830 2c4c 6e29 3a0a 2020 2020 2020  ge(0,Ln):.      
+00010e60: 2020 4e52 5068 695b 6969 5d20 3d20 3c6c    NRPhi[ii] = <l
+00010e70: 6f6e 673e 2863 5f63 6569 6c28 4450 6869  ong>(c_ceil(DPhi
+00010e80: 4d69 6e4d 6178 2a52 7265 6652 6566 5b69  MinMax*RrefRef[i
+00010e90: 695d 2f64 5250 6869 2929 0a20 2020 2020  i]/dRPhi)).     
+00010ea0: 2020 2064 5250 6869 7252 6566 5b69 695d     dRPhirRef[ii]
+00010eb0: 203d 2044 5068 694d 696e 4d61 782a 5272   = DPhiMinMax*Rr
+00010ec0: 6566 5265 665b 6969 5d2f 3c64 6f75 626c  efRef[ii]/<doubl
+00010ed0: 653e 284e 5250 6869 5b69 695d 290a 2020  e>(NRPhi[ii]).  
+00010ee0: 2020 2020 2020 6450 6869 725b 6969 5d20        dPhir[ii] 
+00010ef0: 3d20 4450 6869 4d69 6e4d 6178 2f3c 646f  = DPhiMinMax/<do
+00010f00: 7562 6c65 3e28 4e52 5068 695b 6969 5d29  uble>(NRPhi[ii])
+00010f10: 0a20 2020 2020 2020 2069 6620 6969 3d3d  .        if ii==
+00010f20: 303a 0a20 2020 2020 2020 2020 2020 204e  0:.            N
+00010f30: 5250 6869 305b 6969 5d20 3d20 300a 2020  RPhi0[ii] = 0.  
+00010f40: 2020 2020 2020 2020 2020 5068 6920 3d20            Phi = 
+00010f50: 6e70 2e65 6d70 7479 2828 4c6e 2c4e 5250  np.empty((Ln,NRP
+00010f60: 6869 5b69 695d 2a72 6164 6975 735f 7261  hi[ii]*radius_ra
+00010f70: 7469 6f2b 3129 290a 2020 2020 2020 2020  tio+1)).        
+00010f80: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00010f90: 2020 4e52 5068 6930 5b69 695d 203d 204e    NRPhi0[ii] = N
+00010fa0: 5250 6869 305b 6969 2d31 5d20 2b20 4e52  RPhi0[ii-1] + NR
+00010fb0: 5068 695b 6969 2d31 5d0a 2020 2020 2020  Phi[ii-1].      
+00010fc0: 2020 666f 7220 6a6a 2069 6e20 7261 6e67    for jj in rang
+00010fd0: 6528 302c 4e52 5068 695b 6969 5d29 3a0a  e(0,NRPhi[ii]):.
+00010fe0: 2020 2020 2020 2020 2020 2020 5068 695b              Phi[
+00010ff0: 6969 2c6a 6a5d 203d 2050 6869 4d69 6e4d  ii,jj] = PhiMinM
+00011000: 6178 5b30 5d20 2b20 2830 2e35 2b3c 646f  ax[0] + (0.5+<do
+00011010: 7562 6c65 3e6a 6a29 2a64 5068 6972 5b69  uble>jj)*dPhir[i
+00011020: 695d 0a20 2020 206e 5250 6869 3020 3d20  i].    nRPhi0 = 
+00011030: 4e52 5068 6930 5b4c 6e2d 315d 2b4e 5250  NRPhi0[Ln-1]+NRP
+00011040: 6869 5b4c 6e2d 315d 0a0a 2020 2020 6966  hi[Ln-1]..    if
+00011050: 204f 7574 2e6c 6f77 6572 2829 3d3d 2728   Out.lower()=='(
+00011060: 782c 792c 7a29 273a 0a20 2020 2020 2020  x,y,z)':.       
+00011070: 2066 6f72 2069 6920 696e 2072 616e 6765   for ii in range
+00011080: 2830 2c4e 5029 3a0a 2020 2020 2020 2020  (0,NP):.        
+00011090: 2020 2020 666f 7220 6a6a 2069 6e20 7261      for jj in ra
+000110a0: 6e67 6528 302c 4c6e 2b31 293a 0a20 2020  nge(0,Ln+1):.   
+000110b0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000110c0: 696e 645b 6969 5d2d 4e52 5068 6930 5b6a  ind[ii]-NRPhi0[j
+000110d0: 6a5d 3c30 2e3a 0a20 2020 2020 2020 2020  j]<0.:.         
+000110e0: 2020 2020 2020 2020 2020 2062 7265 616b             break
+000110f0: 0a20 2020 2020 2020 2020 2020 2069 694c  .            iiL
+00011100: 203d 206a 6a2d 310a 2020 2020 2020 2020   = jj-1.        
+00011110: 2020 2020 6969 7068 6920 3d20 696e 645b      iiphi = ind[
+00011120: 6969 5d20 2d20 4e52 5068 6930 5b69 694c  ii] - NRPhi0[iiL
+00011130: 5d0a 2020 2020 2020 2020 2020 2020 7074  ].            pt
+00011140: 735b 302c 6969 5d20 3d20 7074 7343 726f  s[0,ii] = ptsCro
+00011150: 7373 5b30 2c69 694c 5d2a 635f 636f 7328  ss[0,iiL]*c_cos(
+00011160: 5068 695b 6969 4c2c 6969 7068 695d 290a  Phi[iiL,iiphi]).
+00011170: 2020 2020 2020 2020 2020 2020 7074 735b              pts[
+00011180: 312c 6969 5d20 3d20 7074 7343 726f 7373  1,ii] = ptsCross
+00011190: 5b30 2c69 694c 5d2a 635f 7369 6e28 5068  [0,iiL]*c_sin(Ph
+000111a0: 695b 6969 4c2c 6969 7068 695d 290a 2020  i[iiL,iiphi]).  
+000111b0: 2020 2020 2020 2020 2020 7074 735b 322c            pts[2,
+000111c0: 6969 5d20 3d20 7074 7343 726f 7373 5b31  ii] = ptsCross[1
+000111d0: 2c69 694c 5d0a 2020 2020 2020 2020 2020  ,iiL].          
+000111e0: 2020 6453 5b69 695d 203d 2064 4c72 5265    dS[ii] = dLrRe
+000111f0: 665b 6969 4c5d 2a64 5250 6869 7252 6566  f[iiL]*dRPhirRef
+00011200: 5b69 694c 5d0a 2020 2020 2020 2020 2020  [iiL].          
+00011210: 2020 6966 2064 5250 6869 725b 6969 4c5d    if dRPhir[iiL]
+00011220: 3d3d 2d31 2e3a 0a20 2020 2020 2020 2020  ==-1.:.         
+00011230: 2020 2020 2020 2064 5250 6869 725b 6969         dRPhir[ii
+00011240: 4c5d 203d 2064 5250 6869 7252 6566 5b69  L] = dRPhirRef[i
+00011250: 694c 5d0a 2020 2020 2020 2020 2020 2020  iL].            
+00011260: 2020 2020 644c 725b 6969 4c5d 203d 2064      dLr[iiL] = d
+00011270: 4c72 5265 665b 6969 4c5d 0a20 2020 2020  LrRef[iiL].     
+00011280: 2020 2020 2020 2020 2020 2052 7265 665b             Rref[
+00011290: 6969 4c5d 203d 2052 7265 6652 6566 5b69  iiL] = RrefRef[i
+000112a0: 694c 5d0a 0a20 2020 2065 6c73 653a 0a20  iL]..    else:. 
+000112b0: 2020 2020 2020 2066 6f72 2069 6920 696e         for ii in
+000112c0: 2072 616e 6765 2830 2c4e 5029 3a0a 2020   range(0,NP):.  
+000112d0: 2020 2020 2020 2020 2020 666f 7220 6a6a            for jj
+000112e0: 2069 6e20 7261 6e67 6528 302c 4c6e 2b31   in range(0,Ln+1
+000112f0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00011300: 2020 2069 6620 696e 645b 6969 5d2d 4e52     if ind[ii]-NR
+00011310: 5068 6930 5b6a 6a5d 3c30 2e3a 0a20 2020  Phi0[jj]<0.:.   
+00011320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011330: 2062 7265 616b 0a20 2020 2020 2020 2020   break.         
+00011340: 2020 2069 694c 203d 206a 6a2d 310a 2020     iiL = jj-1.  
+00011350: 2020 2020 2020 2020 2020 6969 7068 6920            iiphi 
+00011360: 3d20 696e 645b 6969 5d20 2d20 4e52 5068  = ind[ii] - NRPh
+00011370: 6930 5b69 694c 5d0a 2020 2020 2020 2020  i0[iiL].        
+00011380: 2020 2020 7074 735b 302c 6969 5d20 3d20      pts[0,ii] = 
+00011390: 7074 7343 726f 7373 5b30 2c69 694c 5d0a  ptsCross[0,iiL].
+000113a0: 2020 2020 2020 2020 2020 2020 7074 735b              pts[
+000113b0: 312c 6969 5d20 3d20 7074 7343 726f 7373  1,ii] = ptsCross
+000113c0: 5b31 2c69 694c 5d0a 2020 2020 2020 2020  [1,iiL].        
+000113d0: 2020 2020 7074 735b 322c 6969 5d20 3d20      pts[2,ii] = 
+000113e0: 5068 695b 6969 4c2c 6969 7068 695d 0a20  Phi[iiL,iiphi]. 
+000113f0: 2020 2020 2020 2020 2020 2064 535b 6969             dS[ii
+00011400: 5d20 3d20 644c 7252 6566 5b69 694c 5d2a  ] = dLrRef[iiL]*
+00011410: 6452 5068 6972 5265 665b 6969 4c5d 0a20  dRPhirRef[iiL]. 
+00011420: 2020 2020 2020 2020 2020 2069 6620 6452             if dR
+00011430: 5068 6972 5b69 694c 5d3d 3d2d 312e 3a0a  Phir[iiL]==-1.:.
+00011440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011450: 6452 5068 6972 5b69 694c 5d20 3d20 6452  dRPhir[iiL] = dR
+00011460: 5068 6972 5265 665b 6969 4c5d 0a20 2020  PhirRef[iiL].   
+00011470: 2020 2020 2020 2020 2020 2020 2064 4c72               dLr
+00011480: 5b69 694c 5d20 3d20 644c 7252 6566 5b69  [iiL] = dLrRef[i
+00011490: 694c 5d0a 2020 2020 2020 2020 2020 2020  iL].            
+000114a0: 2020 2020 5272 6566 5b69 694c 5d20 3d20      Rref[iiL] = 
+000114b0: 5272 6566 5265 665b 6969 4c5d 0a20 2020  RrefRef[iiL].   
+000114c0: 2072 6574 7572 6e20 7074 732c 2064 532c   return pts, dS,
+000114d0: 204e 4c2c 2064 4c72 5b64 4c72 3e2d 302e   NL, dLr[dLr>-0.
+000114e0: 355d 2c20 5272 6566 5b52 7265 663e 2d30  5], Rref[Rref>-0
+000114f0: 2e35 5d2c 205c 0a20 2020 2020 2064 5250  .5], \.      dRP
+00011500: 6869 725b 6452 5068 6972 3e2d 302e 355d  hir[dRPhir>-0.5]
+00011510: 2c20 3c6c 6f6e 673e 6e52 5068 6930 2c20  , <long>nRPhi0, 
+00011520: 5650 6269 730a 0a0a 0a23 2323 2323 2323  VPbis....#######
+00011530: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00011540: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00011550: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00011560: 2323 2323 2323 2323 2323 230a 2320 2020  ###########.#   
-00011570: 2020 2020 4d65 7368 696e 6720 2d20 5375      Meshing - Su
-00011580: 7266 6163 6520 2d20 546f 7253 7472 7563  rface - TorStruc
-00011590: 740a 2323 2323 2323 2323 2323 2323 2323  t.##############
-000115a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000115b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000115c0: 2323 2323 2323 2323 2323 0a0a 6465 6620  ##########..def 
-000115d0: 5f56 6573 5f53 6d65 7368 5f54 6f72 5374  _Ves_Smesh_TorSt
-000115e0: 7275 6374 5f53 7562 4672 6f6d 445f 6379  ruct_SubFromD_cy
-000115f0: 7468 6f6e 2864 6f75 626c 655b 3a3a 315d  thon(double[::1]
-00011600: 2050 6869 4d69 6e4d 6178 2c20 646f 7562   PhiMinMax, doub
-00011610: 6c65 2064 4c2c 0a20 2020 2020 2020 2020  le dL,.         
-00011620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011640: 646f 7562 6c65 2064 5250 6869 2c0a 2020  double dRPhi,.  
+00011560: 230a 2323 2323 2323 2323 2323 2323 2323  #.##############
+00011570: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00011580: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00011590: 2323 2323 2323 2323 2323 0a23 2020 2020  ##########.#    
+000115a0: 2020 204d 6573 6869 6e67 202d 2053 7572     Meshing - Sur
+000115b0: 6661 6365 202d 2054 6f72 5374 7275 6374  face - TorStruct
+000115c0: 0a23 2323 2323 2323 2323 2323 2323 2323  .###############
+000115d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000115e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000115f0: 2323 2323 2323 2323 230a 0a64 6566 205f  #########..def _
+00011600: 5665 735f 536d 6573 685f 546f 7253 7472  Ves_Smesh_TorStr
+00011610: 7563 745f 5375 6246 726f 6d44 5f63 7974  uct_SubFromD_cyt
+00011620: 686f 6e28 646f 7562 6c65 5b3a 3a31 5d20  hon(double[::1] 
+00011630: 5068 694d 696e 4d61 782c 2064 6f75 626c  PhiMinMax, doubl
+00011640: 6520 644c 2c0a 2020 2020 2020 2020 2020  e dL,.          
 00011650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011670: 2020 2020 2020 2064 6f75 626c 655b 3a2c         double[:,
-00011680: 3a3a 315d 2056 506f 6c79 2c0a 2020 2020  ::1] VPoly,.    
+00011660: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00011670: 6f75 626c 6520 6452 5068 692c 0a20 2020  ouble dRPhi,.   
+00011680: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00011690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000116a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000116b0: 2020 2020 206c 6973 7420 4452 3d4e 6f6e       list DR=Non
-000116c0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+000116a0: 2020 2020 2020 646f 7562 6c65 5b3a 2c3a        double[:,:
+000116b0: 3a31 5d20 5650 6f6c 792c 0a20 2020 2020  :1] VPoly,.     
+000116c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000116d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000116e0: 2020 2020 2020 2020 2020 2020 6c69 7374              list
-000116f0: 2044 5a3d 4e6f 6e65 2c0a 2020 2020 2020   DZ=None,.      
+000116e0: 2020 2020 6c69 7374 2044 523d 4e6f 6e65      list DR=None
+000116f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 00011700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011720: 2020 2064 6f75 626c 655b 3a3a 315d 2044     double[::1] D
-00011730: 5068 693d 4e6f 6e65 2c0a 2020 2020 2020  Phi=None,.      
+00011710: 2020 2020 2020 2020 2020 206c 6973 7420             list 
+00011720: 445a 3d4e 6f6e 652c 0a20 2020 2020 2020  DZ=None,.       
+00011730: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00011740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011760: 2020 2064 6f75 626c 6520 4449 6e3d 302e     double DIn=0.
-00011770: 2c20 5649 6e3d 4e6f 6e65 2c0a 2020 2020  , VIn=None,.    
+00011750: 2020 646f 7562 6c65 5b3a 3a31 5d20 4450    double[::1] DP
+00011760: 6869 3d4e 6f6e 652c 0a20 2020 2020 2020  hi=None,.       
+00011770: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00011780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000117a0: 2020 2020 2073 7472 204f 7574 3d27 2858       str Out='(X
-000117b0: 2c59 2c5a 2927 2c0a 2020 2020 2020 2020  ,Y,Z)',.        
+00011790: 2020 646f 7562 6c65 2044 496e 3d30 2e2c    double DIn=0.,
+000117a0: 2056 496e 3d4e 6f6e 652c 0a20 2020 2020   VIn=None,.     
+000117b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000117c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000117d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000117e0: 2064 6f75 626c 6520 6d61 7267 696e 3d5f   double margin=_
-000117f0: 5653 4d41 4c4c 293a 0a20 2020 2022 2222  VSMALL):.    """
-00011800: 5265 7475 726e 2074 6865 2064 6573 6972  Return the desir
-00011810: 6564 2073 7572 6661 6369 6320 7375 626d  ed surfacic subm
-00011820: 6573 6820 696e 6469 6361 7465 6420 6279  esh indicated by
-00011830: 2074 6865 206c 696d 6974 7320 2844 522c   the limits (DR,
-00011840: 445a 2c44 5068 6929 2c0a 2020 2020 666f  DZ,DPhi),.    fo
-00011850: 7220 7468 6520 6465 7369 7265 6420 7265  r the desired re
-00011860: 736f 6c75 7469 6f6e 2028 6452 2c64 5a2c  solution (dR,dZ,
-00011870: 6452 7068 6929 0a20 2020 2022 2222 0a20  dRphi).    """. 
-00011880: 2020 2063 6465 6620 646f 7562 6c65 2044     cdef double D
-00011890: 7068 692c 2064 5230 723d 302e 2c20 645a  phi, dR0r=0., dZ
-000118a0: 3072 3d30 2e0a 2020 2020 6364 6566 2069  0r=0..    cdef i
-000118b0: 6e74 204e 5230 3d30 2c20 4e5a 303d 302c  nt NR0=0, NZ0=0,
-000118c0: 2052 306e 2c20 5a30 6e2c 204e 5250 6869   R0n, Z0n, NRPhi
-000118d0: 300a 2020 2020 6364 6566 2064 6f75 626c  0.    cdef doubl
-000118e0: 655b 3a3a 315d 2070 6869 4d69 6e4d 6178  e[::1] phiMinMax
-000118f0: 203d 206e 702e 6172 7261 7928 5b63 5f61   = np.array([c_a
-00011900: 7461 6e32 2863 5f73 696e 2850 6869 4d69  tan2(c_sin(PhiMi
-00011910: 6e4d 6178 5b30 5d29 2c0a 2020 2020 2020  nMax[0]),.      
-00011920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011940: 2020 2020 2020 2020 2020 2020 635f 636f              c_co
-00011950: 7328 5068 694d 696e 4d61 785b 305d 2929  s(PhiMinMax[0]))
-00011960: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00011970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011980: 2020 2020 2020 2020 2020 2020 2063 5f61               c_a
-00011990: 7461 6e32 2863 5f73 696e 2850 6869 4d69  tan2(c_sin(PhiMi
-000119a0: 6e4d 6178 5b31 5d29 2c0a 2020 2020 2020  nMax[1]),.      
-000119b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000119c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000119d0: 2020 2020 2020 2020 2020 2020 635f 636f              c_co
-000119e0: 7328 5068 694d 696e 4d61 785b 315d 2929  s(PhiMinMax[1]))
-000119f0: 5d29 0a20 2020 2063 6465 6620 6e70 2e6e  ]).    cdef np.n
-00011a00: 6461 7272 6179 5b64 6f75 626c 652c 206e  darray[double, n
-00011a10: 6469 6d3d 315d 2052 302c 205a 302c 2064  dim=1] R0, Z0, d
-00011a20: 7346 2c20 6453 4d2c 2064 4c72 2c20 5272  sF, dSM, dLr, Rr
-00011a30: 6566 2c20 6452 5068 6972 2c20 6453 0a20  ef, dRPhir, dS. 
-00011a40: 2020 2063 6465 6620 6e70 2e6e 6461 7272     cdef np.ndarr
-00011a50: 6179 5b6c 6f6e 672c 6e64 696d 3d31 5d20  ay[long,ndim=1] 
-00011a60: 696e 6452 302c 2069 6e64 5a30 2c20 6969  indR0, indZ0, ii
-00011a70: 6e64 2c20 6969 6e64 462c 2069 6e64 4d2c  nd, iindF, indM,
-00011a80: 204e 4c2c 2069 6e64 0a20 2020 2063 6465   NL, ind.    cde
-00011a90: 6620 6e70 2e6e 6461 7272 6179 5b64 6f75  f np.ndarray[dou
-00011aa0: 626c 652c 6e64 696d 3d32 5d20 7074 7372  ble,ndim=2] ptsr
-00011ab0: 7a2c 2070 7473 2c20 5074 734d 2c20 5650  z, pts, PtsM, VP
-00011ac0: 6269 732c 2050 7473 0a20 2020 2063 6465  bis, Pts.    cde
-00011ad0: 6620 6c69 7374 204c 5074 733d 5b5d 2c20  f list LPts=[], 
-00011ae0: 4c64 533d 5b5d 2c20 4c69 6e64 3d5b 5d0a  LdS=[], Lind=[].
-00011af0: 0a20 2020 2023 2050 7265 2d66 6f72 6d61  .    # Pre-forma
-00011b00: 7420 696e 7075 740a 2020 2020 6966 2050  t input.    if P
-00011b10: 6869 4d69 6e4d 6178 2069 7320 4e6f 6e65  hiMinMax is None
-00011b20: 3a0a 2020 2020 2020 2020 5068 694d 696e  :.        PhiMin
-00011b30: 4d61 7820 3d20 6e70 2e61 7272 6179 285b  Max = np.array([
-00011b40: 2d63 5f70 692c 635f 7069 5d29 0a20 2020  -c_pi,c_pi]).   
-00011b50: 2020 2020 2044 5068 694d 696e 4d61 7820       DPhiMinMax 
-00011b60: 3d20 5f54 574f 5049 0a20 2020 2020 2020  = _TWOPI.       
-00011b70: 2046 756c 6c20 3d20 5472 7565 0a20 2020   Full = True.   
-00011b80: 2065 6c73 653a 0a20 2020 2020 2020 2050   else:.        P
-00011b90: 6869 4d69 6e4d 6178 203d 206e 702e 6172  hiMinMax = np.ar
-00011ba0: 7261 7928 5b63 5f61 7461 6e32 2863 5f73  ray([c_atan2(c_s
-00011bb0: 696e 2850 6869 4d69 6e4d 6178 5b30 5d29  in(PhiMinMax[0])
-00011bc0: 2c63 5f63 6f73 2850 6869 4d69 6e4d 6178  ,c_cos(PhiMinMax
-00011bd0: 5b30 5d29 292c 0a20 2020 2020 2020 2020  [0])),.         
-00011be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011bf0: 2020 2020 2063 5f61 7461 6e32 2863 5f73       c_atan2(c_s
-00011c00: 696e 2850 6869 4d69 6e4d 6178 5b31 5d29  in(PhiMinMax[1])
-00011c10: 2c63 5f63 6f73 2850 6869 4d69 6e4d 6178  ,c_cos(PhiMinMax
-00011c20: 5b31 5d29 295d 290a 2020 2020 2020 2020  [1]))]).        
-00011c30: 4450 6869 4d69 6e4d 6178 203d 2050 6869  DPhiMinMax = Phi
-00011c40: 4d69 6e4d 6178 5b31 5d2d 5068 694d 696e  MinMax[1]-PhiMin
-00011c50: 4d61 785b 305d 2069 6620 5068 694d 696e  Max[0] if PhiMin
-00011c60: 4d61 785b 315d 3e3d 5068 694d 696e 4d61  Max[1]>=PhiMinMa
-00011c70: 785b 305d 5c0a 2020 2020 2020 2020 2020  x[0]\.          
-00011c80: 656c 7365 205f 5457 4f50 4920 2b20 5068  else _TWOPI + Ph
-00011c90: 694d 696e 4d61 785b 315d 202d 2050 6869  iMinMax[1] - Phi
-00011ca0: 4d69 6e4d 6178 5b30 5d0a 2020 2020 2020  MinMax[0].      
-00011cb0: 2020 4675 6c6c 203d 2046 616c 7365 0a0a    Full = False..
-00011cc0: 2020 2020 2320 4765 7420 7468 6520 6c69      # Get the li
-00011cd0: 6d69 7473 2069 6620 616e 7920 616e 6420  mits if any and 
-00011ce0: 6d61 6b65 2073 7572 6520 746f 2072 6570  make sure to rep
-00011cf0: 6c61 6365 2074 6865 6d20 696e 2074 6865  lace them in the
-00011d00: 2070 726f 7065 7220 7175 6164 7261 6e74   proper quadrant
-00011d10: 0a20 2020 2069 6620 4450 6869 2069 7320  .    if DPhi is 
-00011d20: 4e6f 6e65 3a0a 2020 2020 2020 2020 4450  None:.        DP
-00011d30: 6869 302c 2044 5068 6931 203d 2050 6869  hi0, DPhi1 = Phi
-00011d40: 4d69 6e4d 6178 5b30 5d2c 2050 6869 4d69  MinMax[0], PhiMi
-00011d50: 6e4d 6178 5b31 5d0a 2020 2020 656c 7365  nMax[1].    else
-00011d60: 3a0a 2020 2020 2020 2020 4450 6869 3020  :.        DPhi0 
-00011d70: 3d20 5068 694d 696e 4d61 785b 305d 2069  = PhiMinMax[0] i
-00011d80: 6620 4450 6869 5b30 5d20 6973 204e 6f6e  f DPhi[0] is Non
-00011d90: 6520 5c0a 2020 2020 2020 2020 2020 656c  e \.          el
-00011da0: 7365 2063 5f61 7461 6e32 2863 5f73 696e  se c_atan2(c_sin
-00011db0: 2844 5068 695b 305d 292c 635f 636f 7328  (DPhi[0]),c_cos(
-00011dc0: 4450 6869 5b30 5d29 290a 2020 2020 2020  DPhi[0])).      
-00011dd0: 2020 4450 6869 3120 3d20 5068 694d 696e    DPhi1 = PhiMin
-00011de0: 4d61 785b 315d 2069 6620 4450 6869 5b31  Max[1] if DPhi[1
-00011df0: 5d20 6973 204e 6f6e 6520 5c0a 2020 2020  ] is None \.    
-00011e00: 2020 2020 2020 656c 7365 2063 5f61 7461        else c_ata
-00011e10: 6e32 2863 5f73 696e 2844 5068 695b 315d  n2(c_sin(DPhi[1]
-00011e20: 292c 635f 636f 7328 4450 6869 5b31 5d29  ),c_cos(DPhi[1])
-00011e30: 290a 2020 2020 4444 5068 6920 3d20 4450  ).    DDPhi = DP
-00011e40: 6869 312d 4450 6869 3020 6966 2044 5068  hi1-DPhi0 if DPh
-00011e50: 6931 3e44 5068 6930 2065 6c73 6520 5f54  i1>DPhi0 else _T
-00011e60: 574f 5049 2b44 5068 6931 2d44 5068 6930  WOPI+DPhi1-DPhi0
-00011e70: 0a0a 2020 2020 696e 7465 722c 2042 6f75  ..    inter, Bou
-00011e80: 6e64 732c 2046 6163 6573 203d 205f 6765  nds, Faces = _ge
-00011e90: 7442 6f75 6e64 7369 6e74 6572 3241 6e67  tBoundsinter2Ang
-00011ea0: 5365 6728 4675 6c6c 2c20 5068 694d 696e  Seg(Full, PhiMin
-00011eb0: 4d61 785b 305d 2c0a 2020 2020 2020 2020  Max[0],.        
-00011ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011ee0: 2020 2020 2020 2020 2020 5068 694d 696e            PhiMin
-00011ef0: 4d61 785b 315d 2c20 4450 6869 302c 2044  Max[1], DPhi0, D
-00011f00: 5068 6931 290a 0a20 2020 2069 6620 696e  Phi1)..    if in
-00011f10: 7465 723a 0a20 2020 2020 2020 2042 4320  ter:.        BC 
-00011f20: 3d20 6c69 7374 2842 6f75 6e64 7329 0a20  = list(Bounds). 
-00011f30: 2020 2020 2020 206e 426f 756e 6473 203d         nBounds =
-00011f40: 206c 656e 2842 6f75 6e64 7329 0a20 2020   len(Bounds).   
-00011f50: 2020 2020 2066 6f72 2069 6920 696e 2072       for ii in r
-00011f60: 616e 6765 2830 2c6e 426f 756e 6473 293a  ange(0,nBounds):
-00011f70: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00011f80: 4243 5b69 695d 5b30 5d3c 5068 694d 696e  BC[ii][0]<PhiMin
-00011f90: 4d61 785b 305d 3a0a 2020 2020 2020 2020  Max[0]:.        
-00011fa0: 2020 2020 2020 2020 4243 5b69 695d 5b30          BC[ii][0
-00011fb0: 5d20 2b3d 205f 5457 4f50 490a 2020 2020  ] += _TWOPI.    
-00011fc0: 2020 2020 2020 2020 6966 2042 435b 6969          if BC[ii
-00011fd0: 5d5b 315d 3c3d 5068 694d 696e 4d61 785b  ][1]<=PhiMinMax[
-00011fe0: 305d 3a0a 2020 2020 2020 2020 2020 2020  0]:.            
-00011ff0: 2020 2020 4243 5b69 695d 5b31 5d20 2b3d      BC[ii][1] +=
-00012000: 205f 5457 4f50 490a 0a20 2020 2020 2020   _TWOPI..       
-00012010: 2023 2052 6571 7569 7265 6420 6469 7374   # Required dist
-00012020: 616e 6365 2065 6666 6563 7469 7665 2061  ance effective a
-00012030: 7420 6d61 7820 520a 2020 2020 2020 2020  t max R.        
-00012040: 4470 6869 203d 2044 496e 2f6e 702e 6d61  Dphi = DIn/np.ma
-00012050: 7828 5650 6f6c 795b 302c 3a5d 2920 6966  x(VPoly[0,:]) if
-00012060: 2044 496e 213d 302e 2065 6c73 6520 302e   DIn!=0. else 0.
-00012070: 0a0a 2020 2020 2020 2020 2320 4765 7420  ..        # Get 
-00012080: 7468 6520 6d65 7368 2066 6f72 2074 6865  the mesh for the
-00012090: 2066 6163 6573 0a20 2020 2020 2020 2069   faces.        i
-000120a0: 6620 616e 7928 4661 6365 7329 203a 0a20  f any(Faces) :. 
-000120b0: 2020 2020 2020 2020 2020 2052 302c 2064             R0, d
-000120c0: 5230 722c 2069 6e64 5230 2c5c 0a20 2020  R0r, indR0,\.   
-000120d0: 2020 2020 2020 2020 2020 204e 5230 203d             NR0 =
-000120e0: 2064 6973 6372 6574 697a 655f 6c69 6e65   discretize_line
-000120f0: 3164 286e 702e 6172 7261 7928 5b6e 702e  1d(np.array([np.
-00012100: 6d69 6e28 5650 6f6c 795b 302c 3a5d 292c  min(VPoly[0,:]),
-00012110: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012140: 2020 2020 2020 2020 6e70 2e6d 6178 2856          np.max(V
-00012150: 506f 6c79 5b30 2c3a 5d29 5d29 2c0a 2020  Poly[0,:])]),.  
+000117d0: 2020 2020 7374 7220 4f75 743d 2728 582c      str Out='(X,
+000117e0: 592c 5a29 272c 0a20 2020 2020 2020 2020  Y,Z)',.         
+000117f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011810: 646f 7562 6c65 206d 6172 6769 6e3d 5f56  double margin=_V
+00011820: 534d 414c 4c29 3a0a 2020 2020 2222 2252  SMALL):.    """R
+00011830: 6574 7572 6e20 7468 6520 6465 7369 7265  eturn the desire
+00011840: 6420 7375 7266 6163 6963 2073 7562 6d65  d surfacic subme
+00011850: 7368 2069 6e64 6963 6174 6564 2062 7920  sh indicated by 
+00011860: 7468 6520 6c69 6d69 7473 2028 4452 2c44  the limits (DR,D
+00011870: 5a2c 4450 6869 292c 0a20 2020 2066 6f72  Z,DPhi),.    for
+00011880: 2074 6865 2064 6573 6972 6564 2072 6573   the desired res
+00011890: 6f6c 7574 696f 6e20 2864 522c 645a 2c64  olution (dR,dZ,d
+000118a0: 5270 6869 290a 2020 2020 2222 220a 2020  Rphi).    """.  
+000118b0: 2020 6364 6566 2064 6f75 626c 6520 4470    cdef double Dp
+000118c0: 6869 2c20 6452 3072 3d30 2e2c 2064 5a30  hi, dR0r=0., dZ0
+000118d0: 723d 302e 0a20 2020 2063 6465 6620 696e  r=0..    cdef in
+000118e0: 7420 4e52 303d 302c 204e 5a30 3d30 2c20  t NR0=0, NZ0=0, 
+000118f0: 5230 6e2c 205a 306e 2c20 4e52 5068 6930  R0n, Z0n, NRPhi0
+00011900: 0a20 2020 2063 6465 6620 646f 7562 6c65  .    cdef double
+00011910: 5b3a 3a31 5d20 7068 694d 696e 4d61 7820  [::1] phiMinMax 
+00011920: 3d20 6e70 2e61 7272 6179 285b 635f 6174  = np.array([c_at
+00011930: 616e 3228 635f 7369 6e28 5068 694d 696e  an2(c_sin(PhiMin
+00011940: 4d61 785b 305d 292c 0a20 2020 2020 2020  Max[0]),.       
+00011950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011970: 2020 2020 2020 2020 2020 2063 5f63 6f73             c_cos
+00011980: 2850 6869 4d69 6e4d 6178 5b30 5d29 292c  (PhiMinMax[0])),
+00011990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000119a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000119b0: 2020 2020 2020 2020 2020 2020 635f 6174              c_at
+000119c0: 616e 3228 635f 7369 6e28 5068 694d 696e  an2(c_sin(PhiMin
+000119d0: 4d61 785b 315d 292c 0a20 2020 2020 2020  Max[1]),.       
+000119e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000119f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011a00: 2020 2020 2020 2020 2020 2063 5f63 6f73             c_cos
+00011a10: 2850 6869 4d69 6e4d 6178 5b31 5d29 295d  (PhiMinMax[1]))]
+00011a20: 290a 2020 2020 6364 6566 206e 702e 6e64  ).    cdef np.nd
+00011a30: 6172 7261 795b 646f 7562 6c65 2c20 6e64  array[double, nd
+00011a40: 696d 3d31 5d20 5230 2c20 5a30 2c20 6473  im=1] R0, Z0, ds
+00011a50: 462c 2064 534d 2c20 644c 722c 2052 7265  F, dSM, dLr, Rre
+00011a60: 662c 2064 5250 6869 722c 2064 530a 2020  f, dRPhir, dS.  
+00011a70: 2020 6364 6566 206e 702e 6e64 6172 7261    cdef np.ndarra
+00011a80: 795b 6c6f 6e67 2c6e 6469 6d3d 315d 2069  y[long,ndim=1] i
+00011a90: 6e64 5230 2c20 696e 645a 302c 2069 696e  ndR0, indZ0, iin
+00011aa0: 642c 2069 696e 6446 2c20 696e 644d 2c20  d, iindF, indM, 
+00011ab0: 4e4c 2c20 696e 640a 2020 2020 6364 6566  NL, ind.    cdef
+00011ac0: 206e 702e 6e64 6172 7261 795b 646f 7562   np.ndarray[doub
+00011ad0: 6c65 2c6e 6469 6d3d 325d 2070 7473 727a  le,ndim=2] ptsrz
+00011ae0: 2c20 7074 732c 2050 7473 4d2c 2056 5062  , pts, PtsM, VPb
+00011af0: 6973 2c20 5074 730a 2020 2020 6364 6566  is, Pts.    cdef
+00011b00: 206c 6973 7420 4c50 7473 3d5b 5d2c 204c   list LPts=[], L
+00011b10: 6453 3d5b 5d2c 204c 696e 643d 5b5d 0a0a  dS=[], Lind=[]..
+00011b20: 2020 2020 2320 5072 652d 666f 726d 6174      # Pre-format
+00011b30: 2069 6e70 7574 0a20 2020 2069 6620 5068   input.    if Ph
+00011b40: 694d 696e 4d61 7820 6973 204e 6f6e 653a  iMinMax is None:
+00011b50: 0a20 2020 2020 2020 2050 6869 4d69 6e4d  .        PhiMinM
+00011b60: 6178 203d 206e 702e 6172 7261 7928 5b2d  ax = np.array([-
+00011b70: 635f 7069 2c63 5f70 695d 290a 2020 2020  c_pi,c_pi]).    
+00011b80: 2020 2020 4450 6869 4d69 6e4d 6178 203d      DPhiMinMax =
+00011b90: 205f 5457 4f50 490a 2020 2020 2020 2020   _TWOPI.        
+00011ba0: 4675 6c6c 203d 2054 7275 650a 2020 2020  Full = True.    
+00011bb0: 656c 7365 3a0a 2020 2020 2020 2020 5068  else:.        Ph
+00011bc0: 694d 696e 4d61 7820 3d20 6e70 2e61 7272  iMinMax = np.arr
+00011bd0: 6179 285b 635f 6174 616e 3228 635f 7369  ay([c_atan2(c_si
+00011be0: 6e28 5068 694d 696e 4d61 785b 305d 292c  n(PhiMinMax[0]),
+00011bf0: 635f 636f 7328 5068 694d 696e 4d61 785b  c_cos(PhiMinMax[
+00011c00: 305d 2929 2c0a 2020 2020 2020 2020 2020  0])),.          
+00011c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011c20: 2020 2020 635f 6174 616e 3228 635f 7369      c_atan2(c_si
+00011c30: 6e28 5068 694d 696e 4d61 785b 315d 292c  n(PhiMinMax[1]),
+00011c40: 635f 636f 7328 5068 694d 696e 4d61 785b  c_cos(PhiMinMax[
+00011c50: 315d 2929 5d29 0a20 2020 2020 2020 2044  1]))]).        D
+00011c60: 5068 694d 696e 4d61 7820 3d20 5068 694d  PhiMinMax = PhiM
+00011c70: 696e 4d61 785b 315d 2d50 6869 4d69 6e4d  inMax[1]-PhiMinM
+00011c80: 6178 5b30 5d20 6966 2050 6869 4d69 6e4d  ax[0] if PhiMinM
+00011c90: 6178 5b31 5d3e 3d50 6869 4d69 6e4d 6178  ax[1]>=PhiMinMax
+00011ca0: 5b30 5d5c 0a20 2020 2020 2020 2020 2065  [0]\.          e
+00011cb0: 6c73 6520 5f54 574f 5049 202b 2050 6869  lse _TWOPI + Phi
+00011cc0: 4d69 6e4d 6178 5b31 5d20 2d20 5068 694d  MinMax[1] - PhiM
+00011cd0: 696e 4d61 785b 305d 0a20 2020 2020 2020  inMax[0].       
+00011ce0: 2046 756c 6c20 3d20 4661 6c73 650a 0a20   Full = False.. 
+00011cf0: 2020 2023 2047 6574 2074 6865 206c 696d     # Get the lim
+00011d00: 6974 7320 6966 2061 6e79 2061 6e64 206d  its if any and m
+00011d10: 616b 6520 7375 7265 2074 6f20 7265 706c  ake sure to repl
+00011d20: 6163 6520 7468 656d 2069 6e20 7468 6520  ace them in the 
+00011d30: 7072 6f70 6572 2071 7561 6472 616e 740a  proper quadrant.
+00011d40: 2020 2020 6966 2044 5068 6920 6973 204e      if DPhi is N
+00011d50: 6f6e 653a 0a20 2020 2020 2020 2044 5068  one:.        DPh
+00011d60: 6930 2c20 4450 6869 3120 3d20 5068 694d  i0, DPhi1 = PhiM
+00011d70: 696e 4d61 785b 305d 2c20 5068 694d 696e  inMax[0], PhiMin
+00011d80: 4d61 785b 315d 0a20 2020 2065 6c73 653a  Max[1].    else:
+00011d90: 0a20 2020 2020 2020 2044 5068 6930 203d  .        DPhi0 =
+00011da0: 2050 6869 4d69 6e4d 6178 5b30 5d20 6966   PhiMinMax[0] if
+00011db0: 2044 5068 695b 305d 2069 7320 4e6f 6e65   DPhi[0] is None
+00011dc0: 205c 0a20 2020 2020 2020 2020 2065 6c73   \.          els
+00011dd0: 6520 635f 6174 616e 3228 635f 7369 6e28  e c_atan2(c_sin(
+00011de0: 4450 6869 5b30 5d29 2c63 5f63 6f73 2844  DPhi[0]),c_cos(D
+00011df0: 5068 695b 305d 2929 0a20 2020 2020 2020  Phi[0])).       
+00011e00: 2044 5068 6931 203d 2050 6869 4d69 6e4d   DPhi1 = PhiMinM
+00011e10: 6178 5b31 5d20 6966 2044 5068 695b 315d  ax[1] if DPhi[1]
+00011e20: 2069 7320 4e6f 6e65 205c 0a20 2020 2020   is None \.     
+00011e30: 2020 2020 2065 6c73 6520 635f 6174 616e       else c_atan
+00011e40: 3228 635f 7369 6e28 4450 6869 5b31 5d29  2(c_sin(DPhi[1])
+00011e50: 2c63 5f63 6f73 2844 5068 695b 315d 2929  ,c_cos(DPhi[1]))
+00011e60: 0a20 2020 2044 4450 6869 203d 2044 5068  .    DDPhi = DPh
+00011e70: 6931 2d44 5068 6930 2069 6620 4450 6869  i1-DPhi0 if DPhi
+00011e80: 313e 4450 6869 3020 656c 7365 205f 5457  1>DPhi0 else _TW
+00011e90: 4f50 492b 4450 6869 312d 4450 6869 300a  OPI+DPhi1-DPhi0.
+00011ea0: 0a20 2020 2069 6e74 6572 2c20 426f 756e  .    inter, Boun
+00011eb0: 6473 2c20 4661 6365 7320 3d20 5f67 6574  ds, Faces = _get
+00011ec0: 426f 756e 6473 696e 7465 7232 416e 6753  Boundsinter2AngS
+00011ed0: 6567 2846 756c 6c2c 2050 6869 4d69 6e4d  eg(Full, PhiMinM
+00011ee0: 6178 5b30 5d2c 0a20 2020 2020 2020 2020  ax[0],.         
+00011ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011f10: 2020 2020 2020 2020 2050 6869 4d69 6e4d           PhiMinM
+00011f20: 6178 5b31 5d2c 2044 5068 6930 2c20 4450  ax[1], DPhi0, DP
+00011f30: 6869 3129 0a0a 2020 2020 6966 2069 6e74  hi1)..    if int
+00011f40: 6572 3a0a 2020 2020 2020 2020 4243 203d  er:.        BC =
+00011f50: 206c 6973 7428 426f 756e 6473 290a 2020   list(Bounds).  
+00011f60: 2020 2020 2020 6e42 6f75 6e64 7320 3d20        nBounds = 
+00011f70: 6c65 6e28 426f 756e 6473 290a 2020 2020  len(Bounds).    
+00011f80: 2020 2020 666f 7220 6969 2069 6e20 7261      for ii in ra
+00011f90: 6e67 6528 302c 6e42 6f75 6e64 7329 3a0a  nge(0,nBounds):.
+00011fa0: 2020 2020 2020 2020 2020 2020 6966 2042              if B
+00011fb0: 435b 6969 5d5b 305d 3c50 6869 4d69 6e4d  C[ii][0]<PhiMinM
+00011fc0: 6178 5b30 5d3a 0a20 2020 2020 2020 2020  ax[0]:.         
+00011fd0: 2020 2020 2020 2042 435b 6969 5d5b 305d         BC[ii][0]
+00011fe0: 202b 3d20 5f54 574f 5049 0a20 2020 2020   += _TWOPI.     
+00011ff0: 2020 2020 2020 2069 6620 4243 5b69 695d         if BC[ii]
+00012000: 5b31 5d3c 3d50 6869 4d69 6e4d 6178 5b30  [1]<=PhiMinMax[0
+00012010: 5d3a 0a20 2020 2020 2020 2020 2020 2020  ]:.             
+00012020: 2020 2042 435b 6969 5d5b 315d 202b 3d20     BC[ii][1] += 
+00012030: 5f54 574f 5049 0a0a 2020 2020 2020 2020  _TWOPI..        
+00012040: 2320 5265 7175 6972 6564 2064 6973 7461  # Required dista
+00012050: 6e63 6520 6566 6665 6374 6976 6520 6174  nce effective at
+00012060: 206d 6178 2052 0a20 2020 2020 2020 2044   max R.        D
+00012070: 7068 6920 3d20 4449 6e2f 6e70 2e6d 6178  phi = DIn/np.max
+00012080: 2856 506f 6c79 5b30 2c3a 5d29 2069 6620  (VPoly[0,:]) if 
+00012090: 4449 6e21 3d30 2e20 656c 7365 2030 2e0a  DIn!=0. else 0..
+000120a0: 0a20 2020 2020 2020 2023 2047 6574 2074  .        # Get t
+000120b0: 6865 206d 6573 6820 666f 7220 7468 6520  he mesh for the 
+000120c0: 6661 6365 730a 2020 2020 2020 2020 6966  faces.        if
+000120d0: 2061 6e79 2846 6163 6573 2920 3a0a 2020   any(Faces) :.  
+000120e0: 2020 2020 2020 2020 2020 5230 2c20 6452            R0, dR
+000120f0: 3072 2c20 696e 6452 302c 5c0a 2020 2020  0r, indR0,\.    
+00012100: 2020 2020 2020 2020 2020 4e52 3020 3d20            NR0 = 
+00012110: 6469 7363 7265 7469 7a65 5f6c 696e 6531  discretize_line1
+00012120: 6428 6e70 2e61 7272 6179 285b 6e70 2e6d  d(np.array([np.m
+00012130: 696e 2856 506f 6c79 5b30 2c3a 5d29 2c0a  in(VPoly[0,:]),.
+00012140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012150: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00012160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012180: 2020 2020 2020 2020 2020 2064 4c2c 2044             dL, D
-00012190: 4c3d 4452 2c20 4c69 6d3d 5472 7565 2c20  L=DR, Lim=True, 
-000121a0: 6d61 7267 696e 3d6d 6172 6769 6e29 0a20  margin=margin). 
-000121b0: 2020 2020 2020 2020 2020 205a 302c 2064             Z0, d
-000121c0: 5a30 722c 2069 6e64 5a30 2c5c 0a20 2020  Z0r, indZ0,\.   
-000121d0: 2020 2020 2020 2020 2020 204e 5a30 203d             NZ0 =
-000121e0: 2064 6973 6372 6574 697a 655f 6c69 6e65   discretize_line
-000121f0: 3164 286e 702e 6172 7261 7928 5b6e 702e  1d(np.array([np.
-00012200: 6d69 6e28 5650 6f6c 795b 312c 3a5d 292c  min(VPoly[1,:]),
-00012210: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012240: 2020 2020 2020 2020 6e70 2e6d 6178 2856          np.max(V
-00012250: 506f 6c79 5b31 2c3a 5d29 5d29 2c0a 2020  Poly[1,:])]),.  
+00012170: 2020 2020 2020 206e 702e 6d61 7828 5650         np.max(VP
+00012180: 6f6c 795b 302c 3a5d 295d 292c 0a20 2020  oly[0,:])]),.   
+00012190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000121a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000121b0: 2020 2020 2020 2020 2020 644c 2c20 444c            dL, DL
+000121c0: 3d44 522c 204c 696d 3d54 7275 652c 206d  =DR, Lim=True, m
+000121d0: 6172 6769 6e3d 6d61 7267 696e 290a 2020  argin=margin).  
+000121e0: 2020 2020 2020 2020 2020 5a30 2c20 645a            Z0, dZ
+000121f0: 3072 2c20 696e 645a 302c 5c0a 2020 2020  0r, indZ0,\.    
+00012200: 2020 2020 2020 2020 2020 4e5a 3020 3d20            NZ0 = 
+00012210: 6469 7363 7265 7469 7a65 5f6c 696e 6531  discretize_line1
+00012220: 6428 6e70 2e61 7272 6179 285b 6e70 2e6d  d(np.array([np.m
+00012230: 696e 2856 506f 6c79 5b31 2c3a 5d29 2c0a  in(VPoly[1,:]),.
+00012240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012250: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00012260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012280: 2020 2020 2020 2020 2020 2064 4c2c 2044             dL, D
-00012290: 4c3d 445a 2c20 4c69 6d3d 5472 7565 2c20  L=DZ, Lim=True, 
-000122a0: 6d61 7267 696e 3d6d 6172 6769 6e29 0a20  margin=margin). 
-000122b0: 2020 2020 2020 2020 2020 2052 306e 2c20             R0n, 
-000122c0: 5a30 6e20 3d20 6c65 6e28 5230 292c 206c  Z0n = len(R0), l
-000122d0: 656e 285a 3029 0a20 2020 2020 2020 2020  en(Z0).         
-000122e0: 2020 2070 7473 727a 203d 206e 702e 6172     ptsrz = np.ar
-000122f0: 7261 7928 5b6e 702e 7469 6c65 2852 302c  ray([np.tile(R0,
-00012300: 5a30 6e29 2c6e 702e 7265 7065 6174 285a  Z0n),np.repeat(Z
-00012310: 302c 5230 6e29 5d29 0a20 2020 2020 2020  0,R0n)]).       
-00012320: 2020 2020 2069 696e 6420 3d20 4e52 302a       iind = NR0*
-00012330: 6e70 2e72 6570 6561 7428 696e 645a 302c  np.repeat(indZ0,
-00012340: 5230 6e29 202b 206e 702e 7469 6c65 2869  R0n) + np.tile(i
-00012350: 6e64 5230 2c5a 306e 290a 2020 2020 2020  ndR0,Z0n).      
-00012360: 2020 2020 2020 696e 6469 6e20 3d20 5061        indin = Pa
-00012370: 7468 2856 506f 6c79 2e54 292e 636f 6e74  th(VPoly.T).cont
-00012380: 6169 6e73 5f70 6f69 6e74 7328 7074 7372  ains_points(ptsr
-00012390: 7a2e 542c 2074 7261 6e73 666f 726d 3d4e  z.T, transform=N
-000123a0: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
-000123b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000123c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000123d0: 2020 2020 2020 2072 6164 6975 733d 302e         radius=0.
-000123e0: 3029 0a20 2020 2020 2020 2020 2020 2069  0).            i
-000123f0: 6620 6e70 2e61 6e79 2869 6e64 696e 293a  f np.any(indin):
-00012400: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012410: 2070 7473 727a 203d 2070 7473 727a 5b3a   ptsrz = ptsrz[:
-00012420: 2c69 6e64 696e 5d20 6966 2069 6e64 696e  ,indin] if indin
-00012430: 2e73 756d 2829 3e31 205c 0a20 2020 2020  .sum()>1 \.     
-00012440: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-00012450: 6520 7074 7372 7a5b 3a2c 696e 6469 6e5d  e ptsrz[:,indin]
-00012460: 2e72 6573 6861 7065 2828 322c 3129 290a  .reshape((2,1)).
-00012470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012480: 6969 6e64 4620 3d20 6969 6e64 5b69 6e64  iindF = iind[ind
-00012490: 696e 5d0a 2020 2020 2020 2020 2020 2020  in].            
-000124a0: 2020 2020 6473 4620 3d20 6452 3072 2a64      dsF = dR0r*d
-000124b0: 5a30 722a 6e70 2e6f 6e65 7328 2869 6e64  Z0r*np.ones((ind
-000124c0: 696e 2e73 756d 2829 2c29 290a 0a20 2020  in.sum(),))..   
-000124d0: 2020 2020 2023 2046 6972 7374 2066 6163       # First fac
-000124e0: 650a 2020 2020 2020 2020 6966 2046 6163  e.        if Fac
-000124f0: 6573 5b30 5d3a 0a20 2020 2020 2020 2020  es[0]:.         
-00012500: 2020 2069 6620 4f75 742e 6c6f 7765 7228     if Out.lower(
-00012510: 293d 3d27 2878 2c79 2c7a 2927 3a0a 2020  )=='(x,y,z)':.  
-00012520: 2020 2020 2020 2020 2020 2020 2020 7074                pt
-00012530: 7320 3d20 6e70 2e61 7272 6179 285b 7074  s = np.array([pt
-00012540: 7372 7a5b 302c 3a5d 2a63 5f63 6f73 2870  srz[0,:]*c_cos(p
-00012550: 6869 4d69 6e4d 6178 5b30 5d2b 4470 6869  hiMinMax[0]+Dphi
-00012560: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00012570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012580: 2020 2070 7473 727a 5b30 2c3a 5d2a 635f     ptsrz[0,:]*c_
-00012590: 7369 6e28 7068 694d 696e 4d61 785b 305d  sin(phiMinMax[0]
-000125a0: 2b44 7068 6929 2c0a 2020 2020 2020 2020  +Dphi),.        
-000125b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000125c0: 2020 2020 2020 2020 7074 7372 7a5b 312c          ptsrz[1,
-000125d0: 3a5d 5d29 0a20 2020 2020 2020 2020 2020  :]]).           
-000125e0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000125f0: 2020 2020 2020 2070 7473 203d 206e 702e         pts = np.
-00012600: 6172 7261 7928 5b70 7473 727a 5b30 2c3a  array([ptsrz[0,:
-00012610: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00012620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012630: 2020 2070 7473 727a 5b31 2c3a 5d2c 0a20     ptsrz[1,:],. 
-00012640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012650: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00012660: 7068 694d 696e 4d61 785b 305d 2b44 7068  phiMinMax[0]+Dph
-00012670: 6929 2a6e 702e 6f6e 6573 2828 696e 6469  i)*np.ones((indi
-00012680: 6e2e 7375 6d28 292c 2929 5d29 0a20 2020  n.sum(),))]).   
-00012690: 2020 2020 2020 2020 204c 5074 732e 6170           LPts.ap
-000126a0: 7065 6e64 2820 7074 7320 290a 2020 2020  pend( pts ).    
-000126b0: 2020 2020 2020 2020 4c69 6e64 2e61 7070          Lind.app
-000126c0: 656e 6428 2069 696e 6446 2029 0a20 2020  end( iindF ).   
-000126d0: 2020 2020 2020 2020 204c 6453 2e61 7070           LdS.app
-000126e0: 656e 6428 2064 7346 2029 0a0a 2020 2020  end( dsF )..    
-000126f0: 2020 2020 2320 4d61 696e 2062 6f64 790a      # Main body.
-00012700: 2020 2020 2020 2020 5074 734d 2c20 6453          PtsM, dS
-00012710: 4d2c 5c0a 2020 2020 2020 2020 2020 696e  M,\.          in
-00012720: 644d 2c20 4e4c 2c5c 0a20 2020 2020 2020  dM, NL,\.       
-00012730: 2020 2064 4c72 2c20 5272 6566 2c5c 0a20     dLr, Rref,\. 
-00012740: 2020 2020 2020 2020 2064 5250 6869 722c           dRPhir,
-00012750: 206e 5250 6869 302c 5c0a 2020 2020 2020   nRPhi0,\.      
-00012760: 2020 2020 5650 6269 7320 3d20 5f56 6573      VPbis = _Ves
-00012770: 5f53 6d65 7368 5f54 6f72 5f53 7562 4672  _Smesh_Tor_SubFr
-00012780: 6f6d 445f 6379 7468 6f6e 2864 4c2c 2064  omD_cython(dL, d
-00012790: 5250 6869 2c20 5650 6f6c 792c 0a20 2020  RPhi, VPoly,.   
-000127a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000127b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000127c0: 2020 2020 2020 2020 2020 2020 2020 4452                DR
-000127d0: 3d44 522c 2044 5a3d 445a 2c0a 2020 2020  =DR, DZ=DZ,.    
+00012270: 2020 2020 2020 206e 702e 6d61 7828 5650         np.max(VP
+00012280: 6f6c 795b 312c 3a5d 295d 292c 0a20 2020  oly[1,:])]),.   
+00012290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000122a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000122b0: 2020 2020 2020 2020 2020 644c 2c20 444c            dL, DL
+000122c0: 3d44 5a2c 204c 696d 3d54 7275 652c 206d  =DZ, Lim=True, m
+000122d0: 6172 6769 6e3d 6d61 7267 696e 290a 2020  argin=margin).  
+000122e0: 2020 2020 2020 2020 2020 5230 6e2c 205a            R0n, Z
+000122f0: 306e 203d 206c 656e 2852 3029 2c20 6c65  0n = len(R0), le
+00012300: 6e28 5a30 290a 2020 2020 2020 2020 2020  n(Z0).          
+00012310: 2020 7074 7372 7a20 3d20 6e70 2e61 7272    ptsrz = np.arr
+00012320: 6179 285b 6e70 2e74 696c 6528 5230 2c5a  ay([np.tile(R0,Z
+00012330: 306e 292c 6e70 2e72 6570 6561 7428 5a30  0n),np.repeat(Z0
+00012340: 2c52 306e 295d 290a 2020 2020 2020 2020  ,R0n)]).        
+00012350: 2020 2020 6969 6e64 203d 204e 5230 2a6e      iind = NR0*n
+00012360: 702e 7265 7065 6174 2869 6e64 5a30 2c52  p.repeat(indZ0,R
+00012370: 306e 2920 2b20 6e70 2e74 696c 6528 696e  0n) + np.tile(in
+00012380: 6452 302c 5a30 6e29 0a20 2020 2020 2020  dR0,Z0n).       
+00012390: 2020 2020 2069 6e64 696e 203d 2050 6174       indin = Pat
+000123a0: 6828 5650 6f6c 792e 5429 2e63 6f6e 7461  h(VPoly.T).conta
+000123b0: 696e 735f 706f 696e 7473 2870 7473 727a  ins_points(ptsrz
+000123c0: 2e54 2c20 7472 616e 7366 6f72 6d3d 4e6f  .T, transform=No
+000123d0: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+000123e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000123f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012400: 2020 2020 2020 7261 6469 7573 3d30 2e30        radius=0.0
+00012410: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+00012420: 206e 702e 616e 7928 696e 6469 6e29 3a0a   np.any(indin):.
+00012430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012440: 7074 7372 7a20 3d20 7074 7372 7a5b 3a2c  ptsrz = ptsrz[:,
+00012450: 696e 6469 6e5d 2069 6620 696e 6469 6e2e  indin] if indin.
+00012460: 7375 6d28 293e 3120 5c0a 2020 2020 2020  sum()>1 \.      
+00012470: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00012480: 2070 7473 727a 5b3a 2c69 6e64 696e 5d2e   ptsrz[:,indin].
+00012490: 7265 7368 6170 6528 2832 2c31 2929 0a20  reshape((2,1)). 
+000124a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000124b0: 696e 6446 203d 2069 696e 645b 696e 6469  indF = iind[indi
+000124c0: 6e5d 0a20 2020 2020 2020 2020 2020 2020  n].             
+000124d0: 2020 2064 7346 203d 2064 5230 722a 645a     dsF = dR0r*dZ
+000124e0: 3072 2a6e 702e 6f6e 6573 2828 696e 6469  0r*np.ones((indi
+000124f0: 6e2e 7375 6d28 292c 2929 0a0a 2020 2020  n.sum(),))..    
+00012500: 2020 2020 2320 4669 7273 7420 6661 6365      # First face
+00012510: 0a20 2020 2020 2020 2069 6620 4661 6365  .        if Face
+00012520: 735b 305d 3a0a 2020 2020 2020 2020 2020  s[0]:.          
+00012530: 2020 6966 204f 7574 2e6c 6f77 6572 2829    if Out.lower()
+00012540: 3d3d 2728 782c 792c 7a29 273a 0a20 2020  =='(x,y,z)':.   
+00012550: 2020 2020 2020 2020 2020 2020 2070 7473               pts
+00012560: 203d 206e 702e 6172 7261 7928 5b70 7473   = np.array([pts
+00012570: 727a 5b30 2c3a 5d2a 635f 636f 7328 7068  rz[0,:]*c_cos(ph
+00012580: 694d 696e 4d61 785b 305d 2b44 7068 6929  iMinMax[0]+Dphi)
+00012590: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000125a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000125b0: 2020 7074 7372 7a5b 302c 3a5d 2a63 5f73    ptsrz[0,:]*c_s
+000125c0: 696e 2870 6869 4d69 6e4d 6178 5b30 5d2b  in(phiMinMax[0]+
+000125d0: 4470 6869 292c 0a20 2020 2020 2020 2020  Dphi),.         
+000125e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000125f0: 2020 2020 2020 2070 7473 727a 5b31 2c3a         ptsrz[1,:
+00012600: 5d5d 290a 2020 2020 2020 2020 2020 2020  ]]).            
+00012610: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00012620: 2020 2020 2020 7074 7320 3d20 6e70 2e61        pts = np.a
+00012630: 7272 6179 285b 7074 7372 7a5b 302c 3a5d  rray([ptsrz[0,:]
+00012640: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00012650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012660: 2020 7074 7372 7a5b 312c 3a5d 2c0a 2020    ptsrz[1,:],.  
+00012670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012680: 2020 2020 2020 2020 2020 2020 2020 2870                (p
+00012690: 6869 4d69 6e4d 6178 5b30 5d2b 4470 6869  hiMinMax[0]+Dphi
+000126a0: 292a 6e70 2e6f 6e65 7328 2869 6e64 696e  )*np.ones((indin
+000126b0: 2e73 756d 2829 2c29 295d 290a 2020 2020  .sum(),))]).    
+000126c0: 2020 2020 2020 2020 4c50 7473 2e61 7070          LPts.app
+000126d0: 656e 6428 2070 7473 2029 0a20 2020 2020  end( pts ).     
+000126e0: 2020 2020 2020 204c 696e 642e 6170 7065         Lind.appe
+000126f0: 6e64 2820 6969 6e64 4620 290a 2020 2020  nd( iindF ).    
+00012700: 2020 2020 2020 2020 4c64 532e 6170 7065          LdS.appe
+00012710: 6e64 2820 6473 4620 290a 0a20 2020 2020  nd( dsF )..     
+00012720: 2020 2023 204d 6169 6e20 626f 6479 0a20     # Main body. 
+00012730: 2020 2020 2020 2050 7473 4d2c 2064 534d         PtsM, dSM
+00012740: 2c5c 0a20 2020 2020 2020 2020 2069 6e64  ,\.          ind
+00012750: 4d2c 204e 4c2c 5c0a 2020 2020 2020 2020  M, NL,\.        
+00012760: 2020 644c 722c 2052 7265 662c 5c0a 2020    dLr, Rref,\.  
+00012770: 2020 2020 2020 2020 6452 5068 6972 2c20          dRPhir, 
+00012780: 6e52 5068 6930 2c5c 0a20 2020 2020 2020  nRPhi0,\.       
+00012790: 2020 2056 5062 6973 203d 205f 5665 735f     VPbis = _Ves_
+000127a0: 536d 6573 685f 546f 725f 5375 6246 726f  Smesh_Tor_SubFro
+000127b0: 6d44 5f63 7974 686f 6e28 644c 2c20 6452  mD_cython(dL, dR
+000127c0: 5068 692c 2056 506f 6c79 2c0a 2020 2020  Phi, VPoly,.    
+000127d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000127e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000127f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012800: 2020 2020 2020 2020 2020 2020 2044 5068               DPh
-00012810: 693d 5b44 5068 6930 2c20 4450 6869 315d  i=[DPhi0, DPhi1]
-00012820: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00012830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012850: 2020 2044 496e 3d44 496e 2c20 5649 6e3d     DIn=DIn, VIn=
-00012860: 5649 6e2c 0a20 2020 2020 2020 2020 2020  VIn,.           
+000127f0: 2020 2020 2020 2020 2020 2020 2044 523d               DR=
+00012800: 4452 2c20 445a 3d44 5a2c 0a20 2020 2020  DR, DZ=DZ,.     
+00012810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012830: 2020 2020 2020 2020 2020 2020 4450 6869              DPhi
+00012840: 3d5b 4450 6869 302c 2044 5068 6931 5d2c  =[DPhi0, DPhi1],
+00012850: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012860: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00012870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012890: 2020 2020 2020 5068 694d 696e 4d61 783d        PhiMinMax=
-000128a0: 7068 694d 696e 4d61 782c 0a20 2020 2020  phiMinMax,.     
+00012880: 2020 4449 6e3d 4449 6e2c 2056 496e 3d56    DIn=DIn, VIn=V
+00012890: 496e 2c0a 2020 2020 2020 2020 2020 2020  In,.            
+000128a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000128b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000128c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000128d0: 2020 2020 2020 2020 2020 2020 4f75 743d              Out=
-000128e0: 4f75 742c 206d 6172 6769 6e3d 6d61 7267  Out, margin=marg
-000128f0: 696e 290a 0a20 2020 2020 2020 2069 6620  in)..        if 
-00012900: 5074 734d 2e73 6861 7065 5b31 5d3e 3d31  PtsM.shape[1]>=1
-00012910: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00012920: 2050 7473 4d2e 7368 6170 655b 315d 3d3d   PtsM.shape[1]==
-00012930: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
-00012940: 2020 204c 5074 732e 6170 7065 6e64 2850     LPts.append(P
-00012950: 7473 4d2e 7265 7368 6170 6528 2833 2c31  tsM.reshape((3,1
-00012960: 2929 290a 2020 2020 2020 2020 2020 2020  ))).            
-00012970: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00012980: 2020 2020 2020 4c50 7473 2e61 7070 656e        LPts.appen
-00012990: 6428 5074 734d 290a 2020 2020 2020 2020  d(PtsM).        
-000129a0: 2020 2020 4c69 6e64 2e61 7070 656e 6428      Lind.append(
-000129b0: 2069 6e64 4d20 2b20 4e52 302a 4e5a 3020   indM + NR0*NZ0 
-000129c0: 290a 2020 2020 2020 2020 2020 2020 4c64  ).            Ld
-000129d0: 532e 6170 7065 6e64 2820 6453 4d20 290a  S.append( dSM ).
-000129e0: 0a20 2020 2020 2020 2023 2053 6563 6f6e  .        # Secon
-000129f0: 6420 6661 6365 0a20 2020 2020 2020 2069  d face.        i
-00012a00: 6620 4661 6365 735b 315d 3a0a 2020 2020  f Faces[1]:.    
-00012a10: 2020 2020 2020 2020 6966 204f 7574 2e6c          if Out.l
-00012a20: 6f77 6572 2829 3d3d 2728 782c 792c 7a29  ower()=='(x,y,z)
-00012a30: 273a 0a20 2020 2020 2020 2020 2020 2020  ':.             
-00012a40: 2020 2070 7473 203d 206e 702e 6172 7261     pts = np.arra
-00012a50: 7928 5b70 7473 727a 5b30 2c3a 5d2a 635f  y([ptsrz[0,:]*c_
-00012a60: 636f 7328 7068 694d 696e 4d61 785b 315d  cos(phiMinMax[1]
-00012a70: 2d44 7068 6929 2c0a 2020 2020 2020 2020  -Dphi),.        
-00012a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012a90: 2020 2020 2020 2020 7074 7372 7a5b 302c          ptsrz[0,
-00012aa0: 3a5d 2a63 5f73 696e 2870 6869 4d69 6e4d  :]*c_sin(phiMinM
-00012ab0: 6178 5b31 5d2d 4470 6869 292c 0a20 2020  ax[1]-Dphi),.   
-00012ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012ad0: 2020 2020 2020 2020 2020 2020 2070 7473               pts
-00012ae0: 727a 5b31 2c3a 5d5d 290a 2020 2020 2020  rz[1,:]]).      
-00012af0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00012b00: 2020 2020 2020 2020 2020 2020 7074 7320              pts 
-00012b10: 3d20 6e70 2e61 7272 6179 285b 7074 7372  = np.array([ptsr
-00012b20: 7a5b 302c 3a5d 2c0a 2020 2020 2020 2020  z[0,:],.        
-00012b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012b40: 2020 2020 2020 2020 7074 7372 7a5b 312c          ptsrz[1,
-00012b50: 3a5d 2c0a 2020 2020 2020 2020 2020 2020  :],.            
+000128c0: 2020 2020 2050 6869 4d69 6e4d 6178 3d70       PhiMinMax=p
+000128d0: 6869 4d69 6e4d 6178 2c0a 2020 2020 2020  hiMinMax,.      
+000128e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000128f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012900: 2020 2020 2020 2020 2020 204f 7574 3d4f             Out=O
+00012910: 7574 2c20 6d61 7267 696e 3d6d 6172 6769  ut, margin=margi
+00012920: 6e29 0a0a 2020 2020 2020 2020 6966 2050  n)..        if P
+00012930: 7473 4d2e 7368 6170 655b 315d 3e3d 313a  tsM.shape[1]>=1:
+00012940: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00012950: 5074 734d 2e73 6861 7065 5b31 5d3d 3d31  PtsM.shape[1]==1
+00012960: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00012970: 2020 4c50 7473 2e61 7070 656e 6428 5074    LPts.append(Pt
+00012980: 734d 2e72 6573 6861 7065 2828 332c 3129  sM.reshape((3,1)
+00012990: 2929 0a20 2020 2020 2020 2020 2020 2065  )).            e
+000129a0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+000129b0: 2020 2020 204c 5074 732e 6170 7065 6e64       LPts.append
+000129c0: 2850 7473 4d29 0a20 2020 2020 2020 2020  (PtsM).         
+000129d0: 2020 204c 696e 642e 6170 7065 6e64 2820     Lind.append( 
+000129e0: 696e 644d 202b 204e 5230 2a4e 5a30 2029  indM + NR0*NZ0 )
+000129f0: 0a20 2020 2020 2020 2020 2020 204c 6453  .            LdS
+00012a00: 2e61 7070 656e 6428 2064 534d 2029 0a0a  .append( dSM )..
+00012a10: 2020 2020 2020 2020 2320 5365 636f 6e64          # Second
+00012a20: 2066 6163 650a 2020 2020 2020 2020 6966   face.        if
+00012a30: 2046 6163 6573 5b31 5d3a 0a20 2020 2020   Faces[1]:.     
+00012a40: 2020 2020 2020 2069 6620 4f75 742e 6c6f         if Out.lo
+00012a50: 7765 7228 293d 3d27 2878 2c79 2c7a 2927  wer()=='(x,y,z)'
+00012a60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00012a70: 2020 7074 7320 3d20 6e70 2e61 7272 6179    pts = np.array
+00012a80: 285b 7074 7372 7a5b 302c 3a5d 2a63 5f63  ([ptsrz[0,:]*c_c
+00012a90: 6f73 2870 6869 4d69 6e4d 6178 5b31 5d2d  os(phiMinMax[1]-
+00012aa0: 4470 6869 292c 0a20 2020 2020 2020 2020  Dphi),.         
+00012ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012ac0: 2020 2020 2020 2070 7473 727a 5b30 2c3a         ptsrz[0,:
+00012ad0: 5d2a 635f 7369 6e28 7068 694d 696e 4d61  ]*c_sin(phiMinMa
+00012ae0: 785b 315d 2d44 7068 6929 2c0a 2020 2020  x[1]-Dphi),.    
+00012af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012b00: 2020 2020 2020 2020 2020 2020 7074 7372              ptsr
+00012b10: 7a5b 312c 3a5d 5d29 0a20 2020 2020 2020  z[1,:]]).       
+00012b20: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00012b30: 2020 2020 2020 2020 2020 2070 7473 203d             pts =
+00012b40: 206e 702e 6172 7261 7928 5b70 7473 727a   np.array([ptsrz
+00012b50: 5b30 2c3a 5d2c 0a20 2020 2020 2020 2020  [0,:],.         
 00012b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012b70: 2020 2020 2870 6869 4d69 6e4d 6178 5b31      (phiMinMax[1
-00012b80: 5d2d 4470 6869 292a 6e70 2e6f 6e65 7328  ]-Dphi)*np.ones(
-00012b90: 2869 6e64 696e 2e73 756d 2829 2c29 295d  (indin.sum(),))]
-00012ba0: 290a 2020 2020 2020 2020 2020 2020 4c50  ).            LP
-00012bb0: 7473 2e61 7070 656e 6428 2070 7473 2029  ts.append( pts )
-00012bc0: 0a20 2020 2020 2020 2020 2020 204c 696e  .            Lin
-00012bd0: 642e 6170 7065 6e64 2820 6969 6e64 4620  d.append( iindF 
-00012be0: 2b20 4e52 302a 4e5a 3020 2b20 6e52 5068  + NR0*NZ0 + nRPh
-00012bf0: 6930 2029 0a20 2020 2020 2020 2020 2020  i0 ).           
-00012c00: 204c 6453 2e61 7070 656e 6428 2064 7346   LdS.append( dsF
-00012c10: 2029 0a0a 2020 2020 2020 2020 2320 4167   )..        # Ag
-00012c20: 6772 6567 6174 650a 2020 2020 2020 2020  gregate.        
-00012c30: 6966 206c 656e 284c 5074 7329 3d3d 313a  if len(LPts)==1:
-00012c40: 0a20 2020 2020 2020 2020 2020 2050 7473  .            Pts
-00012c50: 203d 204c 5074 735b 305d 0a20 2020 2020   = LPts[0].     
-00012c60: 2020 2020 2020 2069 6e64 203d 204c 696e         ind = Lin
-00012c70: 645b 305d 0a20 2020 2020 2020 2020 2020  d[0].           
-00012c80: 2064 5320 3d20 4c64 535b 305d 0a20 2020   dS = LdS[0].   
-00012c90: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00012ca0: 2020 2020 2020 2050 7473 203d 206e 702e         Pts = np.
-00012cb0: 636f 6e63 6174 656e 6174 6528 7475 706c  concatenate(tupl
-00012cc0: 6528 4c50 7473 292c 6178 6973 3d31 290a  e(LPts),axis=1).
-00012cd0: 2020 2020 2020 2020 2020 2020 696e 6420              ind 
-00012ce0: 3d20 6e70 2e63 6f6e 6361 7465 6e61 7465  = np.concatenate
-00012cf0: 2874 7570 6c65 284c 696e 6429 292e 6173  (tuple(Lind)).as
-00012d00: 7479 7065 2869 6e74 290a 2020 2020 2020  type(int).      
-00012d10: 2020 2020 2020 6453 203d 206e 702e 636f        dS = np.co
-00012d20: 6e63 6174 656e 6174 6528 7475 706c 6528  ncatenate(tuple(
-00012d30: 4c64 5329 290a 0a20 2020 2065 6c73 653a  LdS))..    else:
-00012d40: 0a20 2020 2020 2020 2050 7473 2c20 6453  .        Pts, dS
-00012d50: 2c20 696e 642c 204e 4c2c 2052 7265 6620  , ind, NL, Rref 
-00012d60: 3d20 6e70 2e6f 6e65 7328 2833 2c30 2929  = np.ones((3,0))
-00012d70: 2c20 6e70 2e6f 6e65 7328 2830 2c29 292c  , np.ones((0,)),
-00012d80: 5c0a 2020 2020 2020 2020 2020 6e70 2e6f  \.          np.o
-00012d90: 6e65 7328 2830 2c29 2c64 7479 7065 3d69  nes((0,),dtype=i
-00012da0: 6e74 292c 206e 702e 6f6e 6573 2828 302c  nt), np.ones((0,
-00012db0: 292c 6474 7970 653d 696e 7429 2c5c 0a20  ),dtype=int),\. 
-00012dc0: 2020 2020 2020 2020 206e 702e 6e61 6e2a           np.nan*
-00012dd0: 6e70 2e6f 6e65 7328 2856 506f 6c79 2e73  np.ones((VPoly.s
-00012de0: 6861 7065 5b31 5d2d 312c 2929 0a20 2020  hape[1]-1,)).   
-00012df0: 2020 2020 2064 4c72 2c20 6452 3072 2c20       dLr, dR0r, 
-00012e00: 645a 3072 2c20 6452 5068 6972 2c20 5650  dZ0r, dRPhir, VP
-00012e10: 6269 7320 3d20 6e70 2e6f 6e65 7328 2830  bis = np.ones((0
-00012e20: 2c29 292c 2030 2e2c 2030 2e2c 5c0a 2020  ,)), 0., 0.,\.  
-00012e30: 2020 2020 2020 2020 6e70 2e6f 6e65 7328          np.ones(
-00012e40: 2830 2c29 292c 206e 702e 6173 6172 7261  (0,)), np.asarra
-00012e50: 7928 5650 6f6c 7929 0a0a 2020 2020 7265  y(VPoly)..    re
-00012e60: 7475 726e 2050 7473 2c20 6453 2c20 696e  turn Pts, dS, in
-00012e70: 642c 204e 4c2c 2064 4c72 2c20 5272 6566  d, NL, dLr, Rref
-00012e80: 2c20 6452 3072 2c20 645a 3072 2c20 6452  , dR0r, dZ0r, dR
-00012e90: 5068 6972 2c20 5650 6269 730a 0a0a 6465  Phir, VPbis...de
-00012ea0: 6620 5f56 6573 5f53 6d65 7368 5f54 6f72  f _Ves_Smesh_Tor
-00012eb0: 5374 7275 6374 5f53 7562 4672 6f6d 496e  Struct_SubFromIn
-00012ec0: 645f 6379 7468 6f6e 2864 6f75 626c 655b  d_cython(double[
-00012ed0: 3a3a 315d 2050 6869 4d69 6e4d 6178 2c20  ::1] PhiMinMax, 
-00012ee0: 646f 7562 6c65 2064 4c2c 0a20 2020 2020  double dL,.     
-00012ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012f10: 2020 2020 2020 646f 7562 6c65 2064 5250        double dRP
-00012f20: 6869 2c20 646f 7562 6c65 5b3a 2c3a 3a31  hi, double[:,::1
-00012f30: 5d20 5650 6f6c 792c 0a20 2020 2020 2020  ] VPoly,.       
-00012f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012f60: 2020 2020 6e70 2e6e 6461 7272 6179 5b6c      np.ndarray[l
-00012f70: 6f6e 672c 6e64 696d 3d31 5d20 696e 642c  ong,ndim=1] ind,
-00012f80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012fa0: 2020 2020 2020 2020 2020 2020 646f 7562              doub
-00012fb0: 6c65 2044 496e 3d30 2e2c 2056 496e 3d4e  le DIn=0., VIn=N
-00012fc0: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
-00012fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012ff0: 7374 7220 4f75 743d 2728 582c 592c 5a29  str Out='(X,Y,Z)
-00013000: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00013010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013020: 2020 2020 2020 2020 2020 2020 2020 646f                do
-00013030: 7562 6c65 206d 6172 6769 6e3d 5f56 534d  uble margin=_VSM
-00013040: 414c 4c29 3a0a 2020 2020 2222 2220 5265  ALL):.    """ Re
-00013050: 7475 726e 2074 6865 2064 6573 6972 6564  turn the desired
-00013060: 2073 7572 6661 6369 6320 7375 626d 6573   surfacic submes
-00013070: 6820 696e 6469 6361 7465 6420 6279 2074  h indicated by t
-00013080: 6865 206c 696d 6974 7320 2844 522c 445a  he limits (DR,DZ
-00013090: 2c44 5068 6929 0a20 2020 2066 6f72 2074  ,DPhi).    for t
-000130a0: 6865 2064 6573 6972 6564 2072 6573 6f6c  he desired resol
-000130b0: 7574 696f 6e20 2864 522c 645a 2c64 5270  ution (dR,dZ,dRp
-000130c0: 6869 2920 2222 220a 2020 2020 6364 6566  hi) """.    cdef
-000130d0: 2064 6f75 626c 6520 4470 6869 2c20 6452   double Dphi, dR
-000130e0: 3072 2c20 645a 3072 0a20 2020 2063 6465  0r, dZ0r.    cde
-000130f0: 6620 696e 7420 4e52 302c 204e 5a30 2c20  f int NR0, NZ0, 
-00013100: 5230 6e2c 205a 306e 2c20 4e52 5068 6930  R0n, Z0n, NRPhi0
-00013110: 0a20 2020 2063 6465 6620 646f 7562 6c65  .    cdef double
-00013120: 5b3a 3a31 5d20 7068 694d 696e 4d61 7820  [::1] phiMinMax 
-00013130: 3d20 6e70 2e61 7272 6179 285b 635f 6174  = np.array([c_at
-00013140: 616e 3228 635f 7369 6e28 5068 694d 696e  an2(c_sin(PhiMin
-00013150: 4d61 785b 305d 292c 0a20 2020 2020 2020  Max[0]),.       
-00013160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013180: 2020 2020 2020 2020 2020 2063 5f63 6f73             c_cos
-00013190: 2850 6869 4d69 6e4d 6178 5b30 5d29 292c  (PhiMinMax[0])),
-000131a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000131b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000131c0: 2020 2020 2020 2020 2020 2020 635f 6174              c_at
-000131d0: 616e 3228 635f 7369 6e28 5068 694d 696e  an2(c_sin(PhiMin
-000131e0: 4d61 785b 315d 292c 0a20 2020 2020 2020  Max[1]),.       
-000131f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013210: 2020 2020 2020 2020 2020 2063 5f63 6f73             c_cos
-00013220: 2850 6869 4d69 6e4d 6178 5b31 5d29 295d  (PhiMinMax[1]))]
-00013230: 290a 2020 2020 6364 6566 206e 702e 6e64  ).    cdef np.nd
-00013240: 6172 7261 795b 646f 7562 6c65 2c20 6e64  array[double, nd
-00013250: 696d 3d31 5d20 5230 2c20 5a30 2c20 6473  im=1] R0, Z0, ds
-00013260: 462c 2064 534d 2c20 644c 722c 2052 7265  F, dSM, dLr, Rre
-00013270: 662c 2064 5250 6869 722c 2064 530a 2020  f, dRPhir, dS.  
-00013280: 2020 6364 6566 206e 702e 6e64 6172 7261    cdef np.ndarra
-00013290: 795b 6c6f 6e67 2c6e 6469 6d3d 315d 2062  y[long,ndim=1] b
-000132a0: 6c61 2c20 696e 6452 302c 2069 6e64 5a30  la, indR0, indZ0
-000132b0: 2c20 6969 6e64 2c20 6969 6e64 462c 2069  , iind, iindF, i
-000132c0: 6e64 4d2c 204e 4c0a 2020 2020 6364 6566  ndM, NL.    cdef
-000132d0: 206e 702e 6e64 6172 7261 795b 646f 7562   np.ndarray[doub
-000132e0: 6c65 2c6e 6469 6d3d 325d 2070 7473 727a  le,ndim=2] ptsrz
-000132f0: 2c20 7074 732c 2050 7473 4d2c 2056 5062  , pts, PtsM, VPb
-00013300: 6973 2c20 5074 730a 2020 2020 6364 6566  is, Pts.    cdef
-00013310: 206c 6973 7420 4c50 7473 3d5b 5d2c 204c   list LPts=[], L
-00013320: 6453 3d5b 5d2c 204c 696e 643d 5b5d 0a0a  dS=[], Lind=[]..
-00013330: 2020 2020 2320 5072 652d 666f 726d 6174      # Pre-format
-00013340: 2069 6e70 7574 0a20 2020 2023 2052 6571   input.    # Req
-00013350: 7569 7265 6420 6469 7374 616e 6365 2065  uired distance e
-00013360: 6666 6563 7469 7665 2061 7420 6d61 7820  ffective at max 
-00013370: 520a 2020 2020 4470 6869 203d 2044 496e  R.    Dphi = DIn
-00013380: 2f6e 702e 6d61 7828 5650 6f6c 795b 302c  /np.max(VPoly[0,
-00013390: 3a5d 2920 6966 2044 496e 213d 302e 2065  :]) if DIn!=0. e
-000133a0: 6c73 6520 302e 0a0a 2020 2020 2320 4765  lse 0...    # Ge
-000133b0: 7420 7468 6520 6261 7369 6320 6d65 7368  t the basic mesh
-000133c0: 6573 2066 6f72 2074 6865 2066 6163 6573  es for the faces
-000133d0: 0a20 2020 2052 302c 2064 5230 722c 2062  .    R0, dR0r, b
-000133e0: 6c61 2c20 4e52 3020 3d20 6469 7363 7265  la, NR0 = discre
-000133f0: 7469 7a65 5f6c 696e 6531 6428 6e70 2e61  tize_line1d(np.a
-00013400: 7272 6179 285b 6e70 2e6d 696e 2856 506f  rray([np.min(VPo
-00013410: 6c79 5b30 2c3a 5d29 2c0a 2020 2020 2020  ly[0,:]),.      
-00013420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013450: 2020 2020 2020 6e70 2e6d 6178 2856 506f        np.max(VPo
-00013460: 6c79 5b30 2c3a 5d29 5d29 2c0a 2020 2020  ly[0,:])]),.    
+00012b70: 2020 2020 2020 2070 7473 727a 5b31 2c3a         ptsrz[1,:
+00012b80: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00012b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012ba0: 2020 2028 7068 694d 696e 4d61 785b 315d     (phiMinMax[1]
+00012bb0: 2d44 7068 6929 2a6e 702e 6f6e 6573 2828  -Dphi)*np.ones((
+00012bc0: 696e 6469 6e2e 7375 6d28 292c 2929 5d29  indin.sum(),))])
+00012bd0: 0a20 2020 2020 2020 2020 2020 204c 5074  .            LPt
+00012be0: 732e 6170 7065 6e64 2820 7074 7320 290a  s.append( pts ).
+00012bf0: 2020 2020 2020 2020 2020 2020 4c69 6e64              Lind
+00012c00: 2e61 7070 656e 6428 2069 696e 6446 202b  .append( iindF +
+00012c10: 204e 5230 2a4e 5a30 202b 206e 5250 6869   NR0*NZ0 + nRPhi
+00012c20: 3020 290a 2020 2020 2020 2020 2020 2020  0 ).            
+00012c30: 4c64 532e 6170 7065 6e64 2820 6473 4620  LdS.append( dsF 
+00012c40: 290a 0a20 2020 2020 2020 2023 2041 6767  )..        # Agg
+00012c50: 7265 6761 7465 0a20 2020 2020 2020 2069  regate.        i
+00012c60: 6620 6c65 6e28 4c50 7473 293d 3d31 3a0a  f len(LPts)==1:.
+00012c70: 2020 2020 2020 2020 2020 2020 5074 7320              Pts 
+00012c80: 3d20 4c50 7473 5b30 5d0a 2020 2020 2020  = LPts[0].      
+00012c90: 2020 2020 2020 696e 6420 3d20 4c69 6e64        ind = Lind
+00012ca0: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
+00012cb0: 6453 203d 204c 6453 5b30 5d0a 2020 2020  dS = LdS[0].    
+00012cc0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00012cd0: 2020 2020 2020 5074 7320 3d20 6e70 2e63        Pts = np.c
+00012ce0: 6f6e 6361 7465 6e61 7465 2874 7570 6c65  oncatenate(tuple
+00012cf0: 284c 5074 7329 2c61 7869 733d 3129 0a20  (LPts),axis=1). 
+00012d00: 2020 2020 2020 2020 2020 2069 6e64 203d             ind =
+00012d10: 206e 702e 636f 6e63 6174 656e 6174 6528   np.concatenate(
+00012d20: 7475 706c 6528 4c69 6e64 2929 2e61 7374  tuple(Lind)).ast
+00012d30: 7970 6528 696e 7429 0a20 2020 2020 2020  ype(int).       
+00012d40: 2020 2020 2064 5320 3d20 6e70 2e63 6f6e       dS = np.con
+00012d50: 6361 7465 6e61 7465 2874 7570 6c65 284c  catenate(tuple(L
+00012d60: 6453 2929 0a0a 2020 2020 656c 7365 3a0a  dS))..    else:.
+00012d70: 2020 2020 2020 2020 5074 732c 2064 532c          Pts, dS,
+00012d80: 2069 6e64 2c20 4e4c 2c20 5272 6566 203d   ind, NL, Rref =
+00012d90: 206e 702e 6f6e 6573 2828 332c 3029 292c   np.ones((3,0)),
+00012da0: 206e 702e 6f6e 6573 2828 302c 2929 2c5c   np.ones((0,)),\
+00012db0: 0a20 2020 2020 2020 2020 206e 702e 6f6e  .          np.on
+00012dc0: 6573 2828 302c 292c 6474 7970 653d 696e  es((0,),dtype=in
+00012dd0: 7429 2c20 6e70 2e6f 6e65 7328 2830 2c29  t), np.ones((0,)
+00012de0: 2c64 7479 7065 3d69 6e74 292c 5c0a 2020  ,dtype=int),\.  
+00012df0: 2020 2020 2020 2020 6e70 2e6e 616e 2a6e          np.nan*n
+00012e00: 702e 6f6e 6573 2828 5650 6f6c 792e 7368  p.ones((VPoly.sh
+00012e10: 6170 655b 315d 2d31 2c29 290a 2020 2020  ape[1]-1,)).    
+00012e20: 2020 2020 644c 722c 2064 5230 722c 2064      dLr, dR0r, d
+00012e30: 5a30 722c 2064 5250 6869 722c 2056 5062  Z0r, dRPhir, VPb
+00012e40: 6973 203d 206e 702e 6f6e 6573 2828 302c  is = np.ones((0,
+00012e50: 2929 2c20 302e 2c20 302e 2c5c 0a20 2020  )), 0., 0.,\.   
+00012e60: 2020 2020 2020 206e 702e 6f6e 6573 2828         np.ones((
+00012e70: 302c 2929 2c20 6e70 2e61 7361 7272 6179  0,)), np.asarray
+00012e80: 2856 506f 6c79 290a 0a20 2020 2072 6574  (VPoly)..    ret
+00012e90: 7572 6e20 5074 732c 2064 532c 2069 6e64  urn Pts, dS, ind
+00012ea0: 2c20 4e4c 2c20 644c 722c 2052 7265 662c  , NL, dLr, Rref,
+00012eb0: 2064 5230 722c 2064 5a30 722c 2064 5250   dR0r, dZ0r, dRP
+00012ec0: 6869 722c 2056 5062 6973 0a0a 0a64 6566  hir, VPbis...def
+00012ed0: 205f 5665 735f 536d 6573 685f 546f 7253   _Ves_Smesh_TorS
+00012ee0: 7472 7563 745f 5375 6246 726f 6d49 6e64  truct_SubFromInd
+00012ef0: 5f63 7974 686f 6e28 646f 7562 6c65 5b3a  _cython(double[:
+00012f00: 3a31 5d20 5068 694d 696e 4d61 782c 2064  :1] PhiMinMax, d
+00012f10: 6f75 626c 6520 644c 2c0a 2020 2020 2020  ouble dL,.      
+00012f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012f40: 2020 2020 2064 6f75 626c 6520 6452 5068       double dRPh
+00012f50: 692c 2064 6f75 626c 655b 3a2c 3a3a 315d  i, double[:,::1]
+00012f60: 2056 506f 6c79 2c0a 2020 2020 2020 2020   VPoly,.        
+00012f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012f90: 2020 206e 702e 6e64 6172 7261 795b 6c6f     np.ndarray[lo
+00012fa0: 6e67 2c6e 6469 6d3d 315d 2069 6e64 2c0a  ng,ndim=1] ind,.
+00012fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012fd0: 2020 2020 2020 2020 2020 2064 6f75 626c             doubl
+00012fe0: 6520 4449 6e3d 302e 2c20 5649 6e3d 4e6f  e DIn=0., VIn=No
+00012ff0: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+00013000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013010: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00013020: 7472 204f 7574 3d27 2858 2c59 2c5a 2927  tr Out='(X,Y,Z)'
+00013030: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00013040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013050: 2020 2020 2020 2020 2020 2020 2064 6f75               dou
+00013060: 626c 6520 6d61 7267 696e 3d5f 5653 4d41  ble margin=_VSMA
+00013070: 4c4c 293a 0a20 2020 2022 2222 2052 6574  LL):.    """ Ret
+00013080: 7572 6e20 7468 6520 6465 7369 7265 6420  urn the desired 
+00013090: 7375 7266 6163 6963 2073 7562 6d65 7368  surfacic submesh
+000130a0: 2069 6e64 6963 6174 6564 2062 7920 7468   indicated by th
+000130b0: 6520 6c69 6d69 7473 2028 4452 2c44 5a2c  e limits (DR,DZ,
+000130c0: 4450 6869 290a 2020 2020 666f 7220 7468  DPhi).    for th
+000130d0: 6520 6465 7369 7265 6420 7265 736f 6c75  e desired resolu
+000130e0: 7469 6f6e 2028 6452 2c64 5a2c 6452 7068  tion (dR,dZ,dRph
+000130f0: 6929 2022 2222 0a20 2020 2063 6465 6620  i) """.    cdef 
+00013100: 646f 7562 6c65 2044 7068 692c 2064 5230  double Dphi, dR0
+00013110: 722c 2064 5a30 720a 2020 2020 6364 6566  r, dZ0r.    cdef
+00013120: 2069 6e74 204e 5230 2c20 4e5a 302c 2052   int NR0, NZ0, R
+00013130: 306e 2c20 5a30 6e2c 204e 5250 6869 300a  0n, Z0n, NRPhi0.
+00013140: 2020 2020 6364 6566 2064 6f75 626c 655b      cdef double[
+00013150: 3a3a 315d 2070 6869 4d69 6e4d 6178 203d  ::1] phiMinMax =
+00013160: 206e 702e 6172 7261 7928 5b63 5f61 7461   np.array([c_ata
+00013170: 6e32 2863 5f73 696e 2850 6869 4d69 6e4d  n2(c_sin(PhiMinM
+00013180: 6178 5b30 5d29 2c0a 2020 2020 2020 2020  ax[0]),.        
+00013190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000131a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000131b0: 2020 2020 2020 2020 2020 635f 636f 7328            c_cos(
+000131c0: 5068 694d 696e 4d61 785b 305d 2929 2c0a  PhiMinMax[0])),.
+000131d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000131e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000131f0: 2020 2020 2020 2020 2020 2063 5f61 7461             c_ata
+00013200: 6e32 2863 5f73 696e 2850 6869 4d69 6e4d  n2(c_sin(PhiMinM
+00013210: 6178 5b31 5d29 2c0a 2020 2020 2020 2020  ax[1]),.        
+00013220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013240: 2020 2020 2020 2020 2020 635f 636f 7328            c_cos(
+00013250: 5068 694d 696e 4d61 785b 315d 2929 5d29  PhiMinMax[1]))])
+00013260: 0a20 2020 2063 6465 6620 6e70 2e6e 6461  .    cdef np.nda
+00013270: 7272 6179 5b64 6f75 626c 652c 206e 6469  rray[double, ndi
+00013280: 6d3d 315d 2052 302c 205a 302c 2064 7346  m=1] R0, Z0, dsF
+00013290: 2c20 6453 4d2c 2064 4c72 2c20 5272 6566  , dSM, dLr, Rref
+000132a0: 2c20 6452 5068 6972 2c20 6453 0a20 2020  , dRPhir, dS.   
+000132b0: 2063 6465 6620 6e70 2e6e 6461 7272 6179   cdef np.ndarray
+000132c0: 5b6c 6f6e 672c 6e64 696d 3d31 5d20 626c  [long,ndim=1] bl
+000132d0: 612c 2069 6e64 5230 2c20 696e 645a 302c  a, indR0, indZ0,
+000132e0: 2069 696e 642c 2069 696e 6446 2c20 696e   iind, iindF, in
+000132f0: 644d 2c20 4e4c 0a20 2020 2063 6465 6620  dM, NL.    cdef 
+00013300: 6e70 2e6e 6461 7272 6179 5b64 6f75 626c  np.ndarray[doubl
+00013310: 652c 6e64 696d 3d32 5d20 7074 7372 7a2c  e,ndim=2] ptsrz,
+00013320: 2070 7473 2c20 5074 734d 2c20 5650 6269   pts, PtsM, VPbi
+00013330: 732c 2050 7473 0a20 2020 2063 6465 6620  s, Pts.    cdef 
+00013340: 6c69 7374 204c 5074 733d 5b5d 2c20 4c64  list LPts=[], Ld
+00013350: 533d 5b5d 2c20 4c69 6e64 3d5b 5d0a 0a20  S=[], Lind=[].. 
+00013360: 2020 2023 2050 7265 2d66 6f72 6d61 7420     # Pre-format 
+00013370: 696e 7075 740a 2020 2020 2320 5265 7175  input.    # Requ
+00013380: 6972 6564 2064 6973 7461 6e63 6520 6566  ired distance ef
+00013390: 6665 6374 6976 6520 6174 206d 6178 2052  fective at max R
+000133a0: 0a20 2020 2044 7068 6920 3d20 4449 6e2f  .    Dphi = DIn/
+000133b0: 6e70 2e6d 6178 2856 506f 6c79 5b30 2c3a  np.max(VPoly[0,:
+000133c0: 5d29 2069 6620 4449 6e21 3d30 2e20 656c  ]) if DIn!=0. el
+000133d0: 7365 2030 2e0a 0a20 2020 2023 2047 6574  se 0...    # Get
+000133e0: 2074 6865 2062 6173 6963 206d 6573 6865   the basic meshe
+000133f0: 7320 666f 7220 7468 6520 6661 6365 730a  s for the faces.
+00013400: 2020 2020 5230 2c20 6452 3072 2c20 626c      R0, dR0r, bl
+00013410: 612c 204e 5230 203d 2064 6973 6372 6574  a, NR0 = discret
+00013420: 697a 655f 6c69 6e65 3164 286e 702e 6172  ize_line1d(np.ar
+00013430: 7261 7928 5b6e 702e 6d69 6e28 5650 6f6c  ray([np.min(VPol
+00013440: 795b 302c 3a5d 292c 0a20 2020 2020 2020  y[0,:]),.       
+00013450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013460: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00013470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013490: 2020 2020 2020 2020 2020 2020 2020 644c                dL
-000134a0: 2c20 444c 3d4e 6f6e 652c 204c 696d 3d54  , DL=None, Lim=T
-000134b0: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
-000134c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000134d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000134e0: 2020 2020 2020 206d 6172 6769 6e3d 6d61         margin=ma
-000134f0: 7267 696e 290a 2020 2020 5a30 2c20 645a  rgin).    Z0, dZ
-00013500: 3072 2c20 626c 612c 204e 5a30 203d 2064  0r, bla, NZ0 = d
-00013510: 6973 6372 6574 697a 655f 6c69 6e65 3164  iscretize_line1d
-00013520: 286e 702e 6172 7261 7928 5b6e 702e 6d69  (np.array([np.mi
-00013530: 6e28 5650 6f6c 795b 312c 3a5d 292c 0a20  n(VPoly[1,:]),. 
-00013540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013570: 2020 2020 2020 2020 2020 206e 702e 6d61             np.ma
-00013580: 7828 5650 6f6c 795b 312c 3a5d 295d 292c  x(VPoly[1,:])]),
-00013590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000135a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000135b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000135c0: 2020 2064 4c2c 2044 4c3d 4e6f 6e65 2c20     dL, DL=None, 
-000135d0: 4c69 6d3d 5472 7565 2c0a 2020 2020 2020  Lim=True,.      
+00013480: 2020 2020 206e 702e 6d61 7828 5650 6f6c       np.max(VPol
+00013490: 795b 302c 3a5d 295d 292c 0a20 2020 2020  y[0,:])]),.     
+000134a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000134b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000134c0: 2020 2020 2020 2020 2020 2020 2064 4c2c               dL,
+000134d0: 2044 4c3d 4e6f 6e65 2c20 4c69 6d3d 5472   DL=None, Lim=Tr
+000134e0: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
+000134f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013510: 2020 2020 2020 6d61 7267 696e 3d6d 6172        margin=mar
+00013520: 6769 6e29 0a20 2020 205a 302c 2064 5a30  gin).    Z0, dZ0
+00013530: 722c 2062 6c61 2c20 4e5a 3020 3d20 6469  r, bla, NZ0 = di
+00013540: 7363 7265 7469 7a65 5f6c 696e 6531 6428  scretize_line1d(
+00013550: 6e70 2e61 7272 6179 285b 6e70 2e6d 696e  np.array([np.min
+00013560: 2856 506f 6c79 5b31 2c3a 5d29 2c0a 2020  (VPoly[1,:]),.  
+00013570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000135a0: 2020 2020 2020 2020 2020 6e70 2e6d 6178            np.max
+000135b0: 2856 506f 6c79 5b31 2c3a 5d29 5d29 2c0a  (VPoly[1,:])]),.
+000135c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000135d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000135e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000135f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013600: 2020 2020 2020 2020 2020 2020 6d61 7267              marg
-00013610: 696e 3d6d 6172 6769 6e29 0a0a 2020 2020  in=margin)..    
-00013620: 5074 734d 2c20 6453 4d2c 2069 6e64 4d2c  PtsM, dSM, indM,
-00013630: 5c0a 2020 2020 2020 4e4c 2c20 644c 722c  \.      NL, dLr,
-00013640: 2052 7265 662c 5c0a 2020 2020 2020 6452   Rref,\.      dR
-00013650: 5068 6972 2c20 6e52 5068 6930 2c20 5650  Phir, nRPhi0, VP
-00013660: 6269 7320 3d20 5f56 6573 5f53 6d65 7368  bis = _Ves_Smesh
-00013670: 5f54 6f72 5f53 7562 4672 6f6d 445f 6379  _Tor_SubFromD_cy
-00013680: 7468 6f6e 2864 4c2c 2064 5250 6869 2c20  thon(dL, dRPhi, 
-00013690: 5650 6f6c 792c 0a20 2020 2020 2020 2020  VPoly,.         
-000136a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000136b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000136c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000136d0: 2020 2020 4452 3d4e 6f6e 652c 2044 5a3d      DR=None, DZ=
-000136e0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+000135f0: 2020 644c 2c20 444c 3d4e 6f6e 652c 204c    dL, DL=None, L
+00013600: 696d 3d54 7275 652c 0a20 2020 2020 2020  im=True,.       
+00013610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013630: 2020 2020 2020 2020 2020 206d 6172 6769             margi
+00013640: 6e3d 6d61 7267 696e 290a 0a20 2020 2050  n=margin)..    P
+00013650: 7473 4d2c 2064 534d 2c20 696e 644d 2c5c  tsM, dSM, indM,\
+00013660: 0a20 2020 2020 204e 4c2c 2064 4c72 2c20  .      NL, dLr, 
+00013670: 5272 6566 2c5c 0a20 2020 2020 2064 5250  Rref,\.      dRP
+00013680: 6869 722c 206e 5250 6869 302c 2056 5062  hir, nRPhi0, VPb
+00013690: 6973 203d 205f 5665 735f 536d 6573 685f  is = _Ves_Smesh_
+000136a0: 546f 725f 5375 6246 726f 6d44 5f63 7974  Tor_SubFromD_cyt
+000136b0: 686f 6e28 644c 2c20 6452 5068 692c 2056  hon(dL, dRPhi, V
+000136c0: 506f 6c79 2c0a 2020 2020 2020 2020 2020  Poly,.          
+000136d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000136e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000136f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013720: 2020 2044 5068 693d 4e6f 6e65 2c0a 2020     DPhi=None,.  
+00013700: 2020 2044 523d 4e6f 6e65 2c20 445a 3d4e     DR=None, DZ=N
+00013710: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+00013720: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00013730: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00013740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013760: 2020 2020 2020 2020 2020 2044 496e 3d44             DIn=D
-00013770: 496e 2c20 5649 6e3d 5649 6e2c 0a20 2020  In, VIn=VIn,.   
+00013750: 2020 4450 6869 3d4e 6f6e 652c 0a20 2020    DPhi=None,.   
+00013760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013770: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00013780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000137a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000137b0: 2020 2020 2020 2020 2020 5068 694d 696e            PhiMin
-000137c0: 4d61 783d 7068 694d 696e 4d61 782c 0a20  Max=phiMinMax,. 
+00013790: 2020 2020 2020 2020 2020 4449 6e3d 4449            DIn=DI
+000137a0: 6e2c 2056 496e 3d56 496e 2c0a 2020 2020  n, VIn=VIn,.    
+000137b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000137c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000137d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000137e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000137f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013800: 2020 2020 2020 2020 2020 2020 4f75 743d              Out=
-00013810: 4f75 742c 206d 6172 6769 6e3d 6d61 7267  Out, margin=marg
-00013820: 696e 290a 2020 2020 2320 4669 7273 7420  in).    # First 
-00013830: 6661 6365 0a20 2020 2069 6920 3d20 2869  face.    ii = (i
-00013840: 6e64 3c4e 5230 2a4e 5a30 292e 6e6f 6e7a  nd<NR0*NZ0).nonz
-00013850: 6572 6f28 295b 305d 0a20 2020 206e 6969  ero()[0].    nii
-00013860: 203d 206c 656e 2869 6929 0a20 2020 2069   = len(ii).    i
-00013870: 6620 6e69 693e 303a 0a20 2020 2020 2020  f nii>0:.       
-00013880: 2069 6e64 5a30 203d 2069 6e64 5b69 695d   indZ0 = ind[ii]
-00013890: 202f 2f20 4e52 300a 2020 2020 2020 2020   // NR0.        
-000138a0: 696e 6452 3020 3d20 2869 6e64 5b69 695d  indR0 = (ind[ii]
-000138b0: 2d69 6e64 5a30 2a4e 5230 290a 2020 2020  -indZ0*NR0).    
-000138c0: 2020 2020 6966 204f 7574 2e6c 6f77 6572      if Out.lower
-000138d0: 2829 3d3d 2728 782c 792c 7a29 273a 0a20  ()=='(x,y,z)':. 
-000138e0: 2020 2020 2020 2020 2020 2070 7473 203d             pts =
-000138f0: 206e 702e 6172 7261 7928 5b52 305b 696e   np.array([R0[in
-00013900: 6452 305d 2a63 5f63 6f73 2870 6869 4d69  dR0]*c_cos(phiMi
-00013910: 6e4d 6178 5b30 5d2b 4470 6869 292c 0a20  nMax[0]+Dphi),. 
-00013920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013930: 2020 2020 2020 2020 2020 2052 305b 696e             R0[in
-00013940: 6452 305d 2a63 5f73 696e 2870 6869 4d69  dR0]*c_sin(phiMi
-00013950: 6e4d 6178 5b30 5d2b 4470 6869 292c 205a  nMax[0]+Dphi), Z
-00013960: 305b 696e 645a 305d 5d29 0a20 2020 2020  0[indZ0]]).     
-00013970: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00013980: 2020 2020 2070 7473 203d 206e 702e 6172       pts = np.ar
-00013990: 7261 7928 5b52 305b 696e 6452 305d 2c20  ray([R0[indR0], 
-000139a0: 5a30 5b69 6e64 5a30 5d2c 0a20 2020 2020  Z0[indZ0],.     
-000139b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000139c0: 2020 2020 2020 2028 7068 694d 696e 4d61         (phiMinMa
-000139d0: 785b 305d 2b44 7068 6929 2a6e 702e 6f6e  x[0]+Dphi)*np.on
-000139e0: 6573 2828 6e69 692c 2929 5d29 0a20 2020  es((nii,))]).   
-000139f0: 2020 2020 2070 7473 203d 2070 7473 2069       pts = pts i
-00013a00: 6620 6e69 693e 3120 656c 7365 2070 7473  f nii>1 else pts
-00013a10: 2e72 6573 6861 7065 2828 332c 3129 290a  .reshape((3,1)).
-00013a20: 2020 2020 2020 2020 4c50 7473 2e61 7070          LPts.app
-00013a30: 656e 6428 2070 7473 2029 0a20 2020 2020  end( pts ).     
-00013a40: 2020 204c 6453 2e61 7070 656e 6428 2064     LdS.append( d
-00013a50: 5230 722a 645a 3072 2a6e 702e 6f6e 6573  R0r*dZ0r*np.ones
-00013a60: 2828 6e69 692c 2929 2029 0a0a 2020 2020  ((nii,)) )..    
-00013a70: 2320 4d61 696e 2062 6f64 790a 2020 2020  # Main body.    
-00013a80: 6969 203d 2028 696e 643e 3d4e 5230 2a4e  ii = (ind>=NR0*N
-00013a90: 5a30 2920 2620 2869 6e64 3c4e 5230 2a4e  Z0) & (ind<NR0*N
-00013aa0: 5a30 2b50 7473 4d2e 7368 6170 655b 315d  Z0+PtsM.shape[1]
-00013ab0: 290a 2020 2020 6e69 6920 3d20 6c65 6e28  ).    nii = len(
-00013ac0: 6969 290a 2020 2020 6966 206e 6969 3e30  ii).    if nii>0
-00013ad0: 3a0a 2020 2020 2020 2020 7074 7320 3d20  :.        pts = 
-00013ae0: 5074 734d 5b3a 2c69 6e64 5b69 695d 2d4e  PtsM[:,ind[ii]-N
-00013af0: 5230 2a4e 5a30 5d20 6966 206e 6969 3e31  R0*NZ0] if nii>1
-00013b00: 5c0a 2020 2020 2020 2020 2020 656c 7365  \.          else
-00013b10: 2050 7473 4d5b 3a2c 696e 645b 6969 5d2d   PtsM[:,ind[ii]-
-00013b20: 4e52 302a 4e5a 305d 2e72 6573 6861 7065  NR0*NZ0].reshape
-00013b30: 2828 332c 3129 290a 2020 2020 2020 2020  ((3,1)).        
-00013b40: 4c50 7473 2e61 7070 656e 6428 2050 7473  LPts.append( Pts
-00013b50: 4d5b 3a2c 696e 645b 6969 5d2d 4e52 302a  M[:,ind[ii]-NR0*
-00013b60: 4e5a 305d 2029 0a20 2020 2020 2020 204c  NZ0] ).        L
-00013b70: 6453 2e61 7070 656e 6428 2064 534d 5b69  dS.append( dSM[i
-00013b80: 6e64 5b69 695d 2d4e 5230 2a4e 5a30 5d20  nd[ii]-NR0*NZ0] 
-00013b90: 290a 0a20 2020 2023 2053 6563 6f6e 6420  )..    # Second 
-00013ba0: 6661 6365 0a20 2020 2069 6920 3d20 2869  face.    ii = (i
-00013bb0: 6e64 203e 3d20 4e52 302a 4e5a 302b 5074  nd >= NR0*NZ0+Pt
-00013bc0: 734d 2e73 6861 7065 5b31 5d20 292e 6e6f  sM.shape[1] ).no
-00013bd0: 6e7a 6572 6f28 295b 305d 0a20 2020 206e  nzero()[0].    n
-00013be0: 6969 203d 206c 656e 2869 6929 0a20 2020  ii = len(ii).   
-00013bf0: 2069 6620 6e69 693e 303a 0a20 2020 2020   if nii>0:.     
-00013c00: 2020 2069 6e64 5a30 203d 2028 696e 645b     indZ0 = (ind[
-00013c10: 6969 5d2d 284e 5230 2a4e 5a30 2b50 7473  ii]-(NR0*NZ0+Pts
-00013c20: 4d2e 7368 6170 655b 315d 2929 202f 2f20  M.shape[1])) // 
-00013c30: 4e52 300a 2020 2020 2020 2020 696e 6452  NR0.        indR
-00013c40: 3020 3d20 696e 645b 6969 5d2d 284e 5230  0 = ind[ii]-(NR0
-00013c50: 2a4e 5a30 2b50 7473 4d2e 7368 6170 655b  *NZ0+PtsM.shape[
-00013c60: 315d 2920 2d20 696e 645a 302a 4e52 300a  1]) - indZ0*NR0.
-00013c70: 2020 2020 2020 2020 6966 204f 7574 2e6c          if Out.l
-00013c80: 6f77 6572 2829 3d3d 2728 782c 792c 7a29  ower()=='(x,y,z)
-00013c90: 273a 0a20 2020 2020 2020 2020 2020 2070  ':.            p
-00013ca0: 7473 203d 206e 702e 6172 7261 7928 5b52  ts = np.array([R
-00013cb0: 305b 696e 6452 305d 2a63 5f63 6f73 2870  0[indR0]*c_cos(p
-00013cc0: 6869 4d69 6e4d 6178 5b31 5d2d 4470 6869  hiMinMax[1]-Dphi
-00013cd0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00013ce0: 2020 2020 2020 2020 2020 2020 2020 2052                 R
-00013cf0: 305b 696e 6452 305d 2a63 5f73 696e 2870  0[indR0]*c_sin(p
-00013d00: 6869 4d69 6e4d 6178 5b31 5d2d 4470 6869  hiMinMax[1]-Dphi
-00013d10: 292c 205a 305b 696e 645a 305d 5d29 0a20  ), Z0[indZ0]]). 
-00013d20: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00013d30: 2020 2020 2020 2020 2070 7473 203d 206e           pts = n
-00013d40: 702e 6172 7261 7928 5b52 305b 696e 6452  p.array([R0[indR
-00013d50: 305d 2c20 5a30 5b69 6e64 5a30 5d2c 0a20  0], Z0[indZ0],. 
-00013d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013d70: 2020 2020 2020 2020 2020 2028 7068 694d             (phiM
-00013d80: 696e 4d61 785b 315d 2d44 7068 6929 2a6e  inMax[1]-Dphi)*n
-00013d90: 702e 6f6e 6573 2828 6e69 692c 2929 5d29  p.ones((nii,))])
-00013da0: 0a20 2020 2020 2020 2070 7473 203d 2070  .        pts = p
-00013db0: 7473 2069 6620 6e69 693e 3120 656c 7365  ts if nii>1 else
-00013dc0: 2070 7473 2e72 6573 6861 7065 2828 332c   pts.reshape((3,
-00013dd0: 3129 290a 2020 2020 2020 2020 4c50 7473  1)).        LPts
-00013de0: 2e61 7070 656e 6428 2070 7473 2029 0a20  .append( pts ). 
-00013df0: 2020 2020 2020 204c 6453 2e61 7070 656e         LdS.appen
-00013e00: 6428 2064 5230 722a 645a 3072 2a6e 702e  d( dR0r*dZ0r*np.
-00013e10: 6f6e 6573 2828 6e69 692c 2929 2029 0a0a  ones((nii,)) )..
-00013e20: 2020 2020 2320 4167 6772 6567 6174 650a      # Aggregate.
-00013e30: 2020 2020 6966 206c 656e 284c 5074 7329      if len(LPts)
-00013e40: 3d3d 313a 0a20 2020 2020 2020 2050 7473  ==1:.        Pts
-00013e50: 203d 204c 5074 735b 305d 0a20 2020 2020   = LPts[0].     
-00013e60: 2020 2064 5320 3d20 4c64 535b 305d 0a20     dS = LdS[0]. 
-00013e70: 2020 2065 6c69 6620 6c65 6e28 4c50 7473     elif len(LPts
-00013e80: 293e 313a 0a20 2020 2020 2020 2050 7473  )>1:.        Pts
-00013e90: 203d 206e 702e 636f 6e63 6174 656e 6174   = np.concatenat
-00013ea0: 6528 7475 706c 6528 4c50 7473 292c 6178  e(tuple(LPts),ax
-00013eb0: 6973 3d31 290a 2020 2020 2020 2020 6453  is=1).        dS
-00013ec0: 203d 206e 702e 636f 6e63 6174 656e 6174   = np.concatenat
-00013ed0: 6528 7475 706c 6528 4c64 5329 290a 0a20  e(tuple(LdS)).. 
-00013ee0: 2020 2072 6574 7572 6e20 5074 732c 2064     return Pts, d
-00013ef0: 532c 204e 4c2c 2064 4c72 2c20 5272 6566  S, NL, dLr, Rref
-00013f00: 2c20 6452 3072 2c20 645a 3072 2c20 6452  , dR0r, dZ0r, dR
-00013f10: 5068 6972 2c20 5650 6269 730a 0a0a 0a0a  Phir, VPbis.....
-00013f20: 0a0a 2323 2323 2323 2323 2323 2323 2323  ..##############
-00013f30: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00013f40: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00013f50: 2323 2323 2323 2323 2323 0a23 2323 2323  ##########.#####
+000137e0: 2020 2020 2020 2020 2050 6869 4d69 6e4d           PhiMinM
+000137f0: 6178 3d70 6869 4d69 6e4d 6178 2c0a 2020  ax=phiMinMax,.  
+00013800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013830: 2020 2020 2020 2020 2020 204f 7574 3d4f             Out=O
+00013840: 7574 2c20 6d61 7267 696e 3d6d 6172 6769  ut, margin=margi
+00013850: 6e29 0a20 2020 2023 2046 6972 7374 2066  n).    # First f
+00013860: 6163 650a 2020 2020 6969 203d 2028 696e  ace.    ii = (in
+00013870: 643c 4e52 302a 4e5a 3029 2e6e 6f6e 7a65  d<NR0*NZ0).nonze
+00013880: 726f 2829 5b30 5d0a 2020 2020 6e69 6920  ro()[0].    nii 
+00013890: 3d20 6c65 6e28 6969 290a 2020 2020 6966  = len(ii).    if
+000138a0: 206e 6969 3e30 3a0a 2020 2020 2020 2020   nii>0:.        
+000138b0: 696e 645a 3020 3d20 696e 645b 6969 5d20  indZ0 = ind[ii] 
+000138c0: 2f2f 204e 5230 0a20 2020 2020 2020 2069  // NR0.        i
+000138d0: 6e64 5230 203d 2028 696e 645b 6969 5d2d  ndR0 = (ind[ii]-
+000138e0: 696e 645a 302a 4e52 3029 0a20 2020 2020  indZ0*NR0).     
+000138f0: 2020 2069 6620 4f75 742e 6c6f 7765 7228     if Out.lower(
+00013900: 293d 3d27 2878 2c79 2c7a 2927 3a0a 2020  )=='(x,y,z)':.  
+00013910: 2020 2020 2020 2020 2020 7074 7320 3d20            pts = 
+00013920: 6e70 2e61 7272 6179 285b 5230 5b69 6e64  np.array([R0[ind
+00013930: 5230 5d2a 635f 636f 7328 7068 694d 696e  R0]*c_cos(phiMin
+00013940: 4d61 785b 305d 2b44 7068 6929 2c0a 2020  Max[0]+Dphi),.  
+00013950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013960: 2020 2020 2020 2020 2020 5230 5b69 6e64            R0[ind
+00013970: 5230 5d2a 635f 7369 6e28 7068 694d 696e  R0]*c_sin(phiMin
+00013980: 4d61 785b 305d 2b44 7068 6929 2c20 5a30  Max[0]+Dphi), Z0
+00013990: 5b69 6e64 5a30 5d5d 290a 2020 2020 2020  [indZ0]]).      
+000139a0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000139b0: 2020 2020 7074 7320 3d20 6e70 2e61 7272      pts = np.arr
+000139c0: 6179 285b 5230 5b69 6e64 5230 5d2c 205a  ay([R0[indR0], Z
+000139d0: 305b 696e 645a 305d 2c0a 2020 2020 2020  0[indZ0],.      
+000139e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000139f0: 2020 2020 2020 2870 6869 4d69 6e4d 6178        (phiMinMax
+00013a00: 5b30 5d2b 4470 6869 292a 6e70 2e6f 6e65  [0]+Dphi)*np.one
+00013a10: 7328 286e 6969 2c29 295d 290a 2020 2020  s((nii,))]).    
+00013a20: 2020 2020 7074 7320 3d20 7074 7320 6966      pts = pts if
+00013a30: 206e 6969 3e31 2065 6c73 6520 7074 732e   nii>1 else pts.
+00013a40: 7265 7368 6170 6528 2833 2c31 2929 0a20  reshape((3,1)). 
+00013a50: 2020 2020 2020 204c 5074 732e 6170 7065         LPts.appe
+00013a60: 6e64 2820 7074 7320 290a 2020 2020 2020  nd( pts ).      
+00013a70: 2020 4c64 532e 6170 7065 6e64 2820 6452    LdS.append( dR
+00013a80: 3072 2a64 5a30 722a 6e70 2e6f 6e65 7328  0r*dZ0r*np.ones(
+00013a90: 286e 6969 2c29 2920 290a 0a20 2020 2023  (nii,)) )..    #
+00013aa0: 204d 6169 6e20 626f 6479 0a20 2020 2069   Main body.    i
+00013ab0: 6920 3d20 2869 6e64 3e3d 4e52 302a 4e5a  i = (ind>=NR0*NZ
+00013ac0: 3029 2026 2028 696e 643c 4e52 302a 4e5a  0) & (ind<NR0*NZ
+00013ad0: 302b 5074 734d 2e73 6861 7065 5b31 5d29  0+PtsM.shape[1])
+00013ae0: 0a20 2020 206e 6969 203d 206c 656e 2869  .    nii = len(i
+00013af0: 6929 0a20 2020 2069 6620 6e69 693e 303a  i).    if nii>0:
+00013b00: 0a20 2020 2020 2020 2070 7473 203d 2050  .        pts = P
+00013b10: 7473 4d5b 3a2c 696e 645b 6969 5d2d 4e52  tsM[:,ind[ii]-NR
+00013b20: 302a 4e5a 305d 2069 6620 6e69 693e 315c  0*NZ0] if nii>1\
+00013b30: 0a20 2020 2020 2020 2020 2065 6c73 6520  .          else 
+00013b40: 5074 734d 5b3a 2c69 6e64 5b69 695d 2d4e  PtsM[:,ind[ii]-N
+00013b50: 5230 2a4e 5a30 5d2e 7265 7368 6170 6528  R0*NZ0].reshape(
+00013b60: 2833 2c31 2929 0a20 2020 2020 2020 204c  (3,1)).        L
+00013b70: 5074 732e 6170 7065 6e64 2820 5074 734d  Pts.append( PtsM
+00013b80: 5b3a 2c69 6e64 5b69 695d 2d4e 5230 2a4e  [:,ind[ii]-NR0*N
+00013b90: 5a30 5d20 290a 2020 2020 2020 2020 4c64  Z0] ).        Ld
+00013ba0: 532e 6170 7065 6e64 2820 6453 4d5b 696e  S.append( dSM[in
+00013bb0: 645b 6969 5d2d 4e52 302a 4e5a 305d 2029  d[ii]-NR0*NZ0] )
+00013bc0: 0a0a 2020 2020 2320 5365 636f 6e64 2066  ..    # Second f
+00013bd0: 6163 650a 2020 2020 6969 203d 2028 696e  ace.    ii = (in
+00013be0: 6420 3e3d 204e 5230 2a4e 5a30 2b50 7473  d >= NR0*NZ0+Pts
+00013bf0: 4d2e 7368 6170 655b 315d 2029 2e6e 6f6e  M.shape[1] ).non
+00013c00: 7a65 726f 2829 5b30 5d0a 2020 2020 6e69  zero()[0].    ni
+00013c10: 6920 3d20 6c65 6e28 6969 290a 2020 2020  i = len(ii).    
+00013c20: 6966 206e 6969 3e30 3a0a 2020 2020 2020  if nii>0:.      
+00013c30: 2020 696e 645a 3020 3d20 2869 6e64 5b69    indZ0 = (ind[i
+00013c40: 695d 2d28 4e52 302a 4e5a 302b 5074 734d  i]-(NR0*NZ0+PtsM
+00013c50: 2e73 6861 7065 5b31 5d29 2920 2f2f 204e  .shape[1])) // N
+00013c60: 5230 0a20 2020 2020 2020 2069 6e64 5230  R0.        indR0
+00013c70: 203d 2069 6e64 5b69 695d 2d28 4e52 302a   = ind[ii]-(NR0*
+00013c80: 4e5a 302b 5074 734d 2e73 6861 7065 5b31  NZ0+PtsM.shape[1
+00013c90: 5d29 202d 2069 6e64 5a30 2a4e 5230 0a20  ]) - indZ0*NR0. 
+00013ca0: 2020 2020 2020 2069 6620 4f75 742e 6c6f         if Out.lo
+00013cb0: 7765 7228 293d 3d27 2878 2c79 2c7a 2927  wer()=='(x,y,z)'
+00013cc0: 3a0a 2020 2020 2020 2020 2020 2020 7074  :.            pt
+00013cd0: 7320 3d20 6e70 2e61 7272 6179 285b 5230  s = np.array([R0
+00013ce0: 5b69 6e64 5230 5d2a 635f 636f 7328 7068  [indR0]*c_cos(ph
+00013cf0: 694d 696e 4d61 785b 315d 2d44 7068 6929  iMinMax[1]-Dphi)
+00013d00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00013d10: 2020 2020 2020 2020 2020 2020 2020 5230                R0
+00013d20: 5b69 6e64 5230 5d2a 635f 7369 6e28 7068  [indR0]*c_sin(ph
+00013d30: 694d 696e 4d61 785b 315d 2d44 7068 6929  iMinMax[1]-Dphi)
+00013d40: 2c20 5a30 5b69 6e64 5a30 5d5d 290a 2020  , Z0[indZ0]]).  
+00013d50: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00013d60: 2020 2020 2020 2020 7074 7320 3d20 6e70          pts = np
+00013d70: 2e61 7272 6179 285b 5230 5b69 6e64 5230  .array([R0[indR0
+00013d80: 5d2c 205a 305b 696e 645a 305d 2c0a 2020  ], Z0[indZ0],.  
+00013d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013da0: 2020 2020 2020 2020 2020 2870 6869 4d69            (phiMi
+00013db0: 6e4d 6178 5b31 5d2d 4470 6869 292a 6e70  nMax[1]-Dphi)*np
+00013dc0: 2e6f 6e65 7328 286e 6969 2c29 295d 290a  .ones((nii,))]).
+00013dd0: 2020 2020 2020 2020 7074 7320 3d20 7074          pts = pt
+00013de0: 7320 6966 206e 6969 3e31 2065 6c73 6520  s if nii>1 else 
+00013df0: 7074 732e 7265 7368 6170 6528 2833 2c31  pts.reshape((3,1
+00013e00: 2929 0a20 2020 2020 2020 204c 5074 732e  )).        LPts.
+00013e10: 6170 7065 6e64 2820 7074 7320 290a 2020  append( pts ).  
+00013e20: 2020 2020 2020 4c64 532e 6170 7065 6e64        LdS.append
+00013e30: 2820 6452 3072 2a64 5a30 722a 6e70 2e6f  ( dR0r*dZ0r*np.o
+00013e40: 6e65 7328 286e 6969 2c29 2920 290a 0a20  nes((nii,)) ).. 
+00013e50: 2020 2023 2041 6767 7265 6761 7465 0a20     # Aggregate. 
+00013e60: 2020 2069 6620 6c65 6e28 4c50 7473 293d     if len(LPts)=
+00013e70: 3d31 3a0a 2020 2020 2020 2020 5074 7320  =1:.        Pts 
+00013e80: 3d20 4c50 7473 5b30 5d0a 2020 2020 2020  = LPts[0].      
+00013e90: 2020 6453 203d 204c 6453 5b30 5d0a 2020    dS = LdS[0].  
+00013ea0: 2020 656c 6966 206c 656e 284c 5074 7329    elif len(LPts)
+00013eb0: 3e31 3a0a 2020 2020 2020 2020 5074 7320  >1:.        Pts 
+00013ec0: 3d20 6e70 2e63 6f6e 6361 7465 6e61 7465  = np.concatenate
+00013ed0: 2874 7570 6c65 284c 5074 7329 2c61 7869  (tuple(LPts),axi
+00013ee0: 733d 3129 0a20 2020 2020 2020 2064 5320  s=1).        dS 
+00013ef0: 3d20 6e70 2e63 6f6e 6361 7465 6e61 7465  = np.concatenate
+00013f00: 2874 7570 6c65 284c 6453 2929 0a0a 2020  (tuple(LdS))..  
+00013f10: 2020 7265 7475 726e 2050 7473 2c20 6453    return Pts, dS
+00013f20: 2c20 4e4c 2c20 644c 722c 2052 7265 662c  , NL, dLr, Rref,
+00013f30: 2064 5230 722c 2064 5a30 722c 2064 5250   dR0r, dZ0r, dRP
+00013f40: 6869 722c 2056 5062 6973 0a0a 0a0a 0a0a  hir, VPbis......
+00013f50: 0a23 2323 2323 2323 2323 2323 2323 2323  .###############
 00013f60: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00013f70: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00013f80: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00013f90: 2323 230a 2320 2020 2020 2020 4d65 7368  ###.#       Mesh
-00013fa0: 696e 6720 2d20 5375 7266 6163 6520 2d20  ing - Surface - 
-00013fb0: 4c69 6e0a 2323 2323 2323 2323 2323 2323  Lin.############
-00013fc0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00013fd0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00013fe0: 2323 2323 2323 2323 2323 2323 0a0a 6364  ############..cd
-00013ff0: 6566 2069 6e6c 696e 6520 696e 7420 5f63  ef inline int _c
-00014000: 6865 636b 5f44 4c76 734c 4d69 6e4d 6178  heck_DLvsLMinMax
-00014010: 2864 6f75 626c 655b 3a3a 315d 204c 4d69  (double[::1] LMi
-00014020: 6e4d 6178 2c0a 2020 2020 2020 2020 2020  nMax,.          
-00014030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014040: 2020 2020 2020 2020 206c 6973 7420 444c           list DL
-00014050: 3d4e 6f6e 6529 3a0a 2020 2020 6364 6566  =None):.    cdef
-00014060: 2069 6e74 2069 6e74 6572 203d 2031 0a20   int inter = 1. 
-00014070: 2020 2063 6465 6620 6269 6e74 2064 6c30     cdef bint dl0
-00014080: 5f69 735f 6e6f 745f 6e6f 6e65 0a20 2020  _is_not_none.   
-00014090: 2063 6465 6620 6269 6e74 2064 6c31 5f69   cdef bint dl1_i
-000140a0: 735f 6e6f 745f 6e6f 6e65 0a20 2020 2069  s_not_none.    i
-000140b0: 6620 444c 2069 7320 6e6f 7420 4e6f 6e65  f DL is not None
-000140c0: 3a0a 2020 2020 2020 2020 646c 305f 6973  :.        dl0_is
-000140d0: 5f6e 6f74 5f6e 6f6e 6520 3d20 444c 5b30  _not_none = DL[0
-000140e0: 5d20 6973 206e 6f74 204e 6f6e 650a 2020  ] is not None.  
-000140f0: 2020 2020 2020 646c 315f 6973 5f6e 6f74        dl1_is_not
-00014100: 5f6e 6f6e 6520 3d20 444c 5b31 5d20 6973  _none = DL[1] is
-00014110: 206e 6f74 204e 6f6e 650a 2020 2020 2020   not None.      
-00014120: 2020 6966 206c 656e 2844 4c29 2021 3d20    if len(DL) != 
-00014130: 3220 6f72 204c 4d69 6e4d 6178 5b30 5d3e  2 or LMinMax[0]>
-00014140: 3d4c 4d69 6e4d 6178 5b31 5d3a 0a20 2020  =LMinMax[1]:.   
-00014150: 2020 2020 2020 2020 2061 7373 6572 7428           assert(
-00014160: 4661 6c73 6529 0a20 2020 2020 2020 2069  False).        i
-00014170: 6620 646c 305f 6973 5f6e 6f74 5f6e 6f6e  f dl0_is_not_non
-00014180: 6520 616e 6420 646c 315f 6973 5f6e 6f74  e and dl1_is_not
-00014190: 5f6e 6f6e 6520 616e 6420 444c 5b30 5d20  _none and DL[0] 
-000141a0: 3e3d 2044 4c5b 315d 3a0a 2020 2020 2020  >= DL[1]:.      
-000141b0: 2020 2020 2020 6173 7365 7274 2846 616c        assert(Fal
-000141c0: 7365 290a 2020 2020 2020 2020 6966 2064  se).        if d
-000141d0: 6c30 5f69 735f 6e6f 745f 6e6f 6e65 2061  l0_is_not_none a
-000141e0: 6e64 2044 4c5b 305d 3e4c 4d69 6e4d 6178  nd DL[0]>LMinMax
-000141f0: 5b31 5d3a 0a20 2020 2020 2020 2020 2020  [1]:.           
-00014200: 2069 6e74 6572 203d 2030 0a20 2020 2020   inter = 0.     
-00014210: 2020 2065 6c69 6620 646c 315f 6973 5f6e     elif dl1_is_n
-00014220: 6f74 5f6e 6f6e 6520 616e 6420 444c 5b31  ot_none and DL[1
-00014230: 5d3c 4c4d 696e 4d61 785b 305d 3a0a 2020  ]<LMinMax[0]:.  
-00014240: 2020 2020 2020 2020 2020 696e 7465 7220            inter 
-00014250: 3d20 300a 2020 2020 2020 2020 656c 7365  = 0.        else
-00014260: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00014270: 2064 6c30 5f69 735f 6e6f 745f 6e6f 6e65   dl0_is_not_none
-00014280: 2061 6e64 2044 4c5b 305d 3c3d 4c4d 696e   and DL[0]<=LMin
-00014290: 4d61 785b 305d 3a0a 2020 2020 2020 2020  Max[0]:.        
-000142a0: 2020 2020 2020 2020 444c 5b30 5d20 3d20          DL[0] = 
-000142b0: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-000142c0: 2069 6620 646c 315f 6973 5f6e 6f74 5f6e   if dl1_is_not_n
-000142d0: 6f6e 6520 616e 6420 444c 5b31 5d3e 3d4c  one and DL[1]>=L
-000142e0: 4d69 6e4d 6178 5b31 5d3a 0a20 2020 2020  MinMax[1]:.     
-000142f0: 2020 2020 2020 2020 2020 2044 4c5b 315d             DL[1]
-00014300: 203d 204e 6f6e 650a 2020 2020 7265 7475   = None.    retu
-00014310: 726e 2069 6e74 6572 0a0a 0a64 6566 205f  rn inter...def _
-00014320: 5665 735f 536d 6573 685f 4c69 6e5f 5375  Ves_Smesh_Lin_Su
-00014330: 6246 726f 6d44 5f63 7974 686f 6e28 646f  bFromD_cython(do
-00014340: 7562 6c65 5b3a 3a31 5d20 584d 696e 4d61  uble[::1] XMinMa
-00014350: 782c 2064 6f75 626c 6520 644c 2c20 646f  x, double dL, do
-00014360: 7562 6c65 2064 582c 0a20 2020 2020 2020  uble dX,.       
-00014370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014380: 2020 2020 2020 2020 2020 2020 646f 7562              doub
-00014390: 6c65 5b3a 2c3a 3a31 5d20 5650 6f6c 792c  le[:,::1] VPoly,
-000143a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000143b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000143c0: 2020 2020 6c69 7374 2044 583d 4e6f 6e65      list DX=None
-000143d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00013f80: 2323 2323 2323 2323 230a 2323 2323 2323  #########.######
+00013f90: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00013fa0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00013fb0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00013fc0: 2323 0a23 2020 2020 2020 204d 6573 6869  ##.#       Meshi
+00013fd0: 6e67 202d 2053 7572 6661 6365 202d 204c  ng - Surface - L
+00013fe0: 696e 0a23 2323 2323 2323 2323 2323 2323  in.#############
+00013ff0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00014000: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00014010: 2323 2323 2323 2323 2323 230a 0a63 6465  ###########..cde
+00014020: 6620 696e 6c69 6e65 2069 6e74 205f 6368  f inline int _ch
+00014030: 6563 6b5f 444c 7673 4c4d 696e 4d61 7828  eck_DLvsLMinMax(
+00014040: 646f 7562 6c65 5b3a 3a31 5d20 4c4d 696e  double[::1] LMin
+00014050: 4d61 782c 0a20 2020 2020 2020 2020 2020  Max,.           
+00014060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014070: 2020 2020 2020 2020 6c69 7374 2044 4c3d          list DL=
+00014080: 4e6f 6e65 293a 0a20 2020 2063 6465 6620  None):.    cdef 
+00014090: 696e 7420 696e 7465 7220 3d20 310a 2020  int inter = 1.  
+000140a0: 2020 6364 6566 2062 696e 7420 646c 305f    cdef bint dl0_
+000140b0: 6973 5f6e 6f74 5f6e 6f6e 650a 2020 2020  is_not_none.    
+000140c0: 6364 6566 2062 696e 7420 646c 315f 6973  cdef bint dl1_is
+000140d0: 5f6e 6f74 5f6e 6f6e 650a 2020 2020 6966  _not_none.    if
+000140e0: 2044 4c20 6973 206e 6f74 204e 6f6e 653a   DL is not None:
+000140f0: 0a20 2020 2020 2020 2064 6c30 5f69 735f  .        dl0_is_
+00014100: 6e6f 745f 6e6f 6e65 203d 2044 4c5b 305d  not_none = DL[0]
+00014110: 2069 7320 6e6f 7420 4e6f 6e65 0a20 2020   is not None.   
+00014120: 2020 2020 2064 6c31 5f69 735f 6e6f 745f       dl1_is_not_
+00014130: 6e6f 6e65 203d 2044 4c5b 315d 2069 7320  none = DL[1] is 
+00014140: 6e6f 7420 4e6f 6e65 0a20 2020 2020 2020  not None.       
+00014150: 2069 6620 6c65 6e28 444c 2920 213d 2032   if len(DL) != 2
+00014160: 206f 7220 4c4d 696e 4d61 785b 305d 3e3d   or LMinMax[0]>=
+00014170: 4c4d 696e 4d61 785b 315d 3a0a 2020 2020  LMinMax[1]:.    
+00014180: 2020 2020 2020 2020 6173 7365 7274 2846          assert(F
+00014190: 616c 7365 290a 2020 2020 2020 2020 6966  alse).        if
+000141a0: 2064 6c30 5f69 735f 6e6f 745f 6e6f 6e65   dl0_is_not_none
+000141b0: 2061 6e64 2064 6c31 5f69 735f 6e6f 745f   and dl1_is_not_
+000141c0: 6e6f 6e65 2061 6e64 2044 4c5b 305d 203e  none and DL[0] >
+000141d0: 3d20 444c 5b31 5d3a 0a20 2020 2020 2020  = DL[1]:.       
+000141e0: 2020 2020 2061 7373 6572 7428 4661 6c73       assert(Fals
+000141f0: 6529 0a20 2020 2020 2020 2069 6620 646c  e).        if dl
+00014200: 305f 6973 5f6e 6f74 5f6e 6f6e 6520 616e  0_is_not_none an
+00014210: 6420 444c 5b30 5d3e 4c4d 696e 4d61 785b  d DL[0]>LMinMax[
+00014220: 315d 3a0a 2020 2020 2020 2020 2020 2020  1]:.            
+00014230: 696e 7465 7220 3d20 300a 2020 2020 2020  inter = 0.      
+00014240: 2020 656c 6966 2064 6c31 5f69 735f 6e6f    elif dl1_is_no
+00014250: 745f 6e6f 6e65 2061 6e64 2044 4c5b 315d  t_none and DL[1]
+00014260: 3c4c 4d69 6e4d 6178 5b30 5d3a 0a20 2020  <LMinMax[0]:.   
+00014270: 2020 2020 2020 2020 2069 6e74 6572 203d           inter =
+00014280: 2030 0a20 2020 2020 2020 2065 6c73 653a   0.        else:
+00014290: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000142a0: 646c 305f 6973 5f6e 6f74 5f6e 6f6e 6520  dl0_is_not_none 
+000142b0: 616e 6420 444c 5b30 5d3c 3d4c 4d69 6e4d  and DL[0]<=LMinM
+000142c0: 6178 5b30 5d3a 0a20 2020 2020 2020 2020  ax[0]:.         
+000142d0: 2020 2020 2020 2044 4c5b 305d 203d 204e         DL[0] = N
+000142e0: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+000142f0: 6966 2064 6c31 5f69 735f 6e6f 745f 6e6f  if dl1_is_not_no
+00014300: 6e65 2061 6e64 2044 4c5b 315d 3e3d 4c4d  ne and DL[1]>=LM
+00014310: 696e 4d61 785b 315d 3a0a 2020 2020 2020  inMax[1]:.      
+00014320: 2020 2020 2020 2020 2020 444c 5b31 5d20            DL[1] 
+00014330: 3d20 4e6f 6e65 0a20 2020 2072 6574 7572  = None.    retur
+00014340: 6e20 696e 7465 720a 0a0a 6465 6620 5f56  n inter...def _V
+00014350: 6573 5f53 6d65 7368 5f4c 696e 5f53 7562  es_Smesh_Lin_Sub
+00014360: 4672 6f6d 445f 6379 7468 6f6e 2864 6f75  FromD_cython(dou
+00014370: 626c 655b 3a3a 315d 2058 4d69 6e4d 6178  ble[::1] XMinMax
+00014380: 2c20 646f 7562 6c65 2064 4c2c 2064 6f75  , double dL, dou
+00014390: 626c 6520 6458 2c0a 2020 2020 2020 2020  ble dX,.        
+000143a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000143b0: 2020 2020 2020 2020 2020 2064 6f75 626c             doubl
+000143c0: 655b 3a2c 3a3a 315d 2056 506f 6c79 2c0a  e[:,::1] VPoly,.
+000143d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000143e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000143f0: 2020 2020 206c 6973 7420 4459 3d4e 6f6e       list DY=Non
-00014400: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+000143f0: 2020 206c 6973 7420 4458 3d4e 6f6e 652c     list DX=None,
+00014400: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 00014410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014420: 2020 2020 2020 6c69 7374 2044 5a3d 4e6f        list DZ=No
-00014430: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+00014420: 2020 2020 6c69 7374 2044 593d 4e6f 6e65      list DY=None
+00014430: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 00014440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014450: 2020 2020 2020 2064 6f75 626c 6520 4449         double DI
-00014460: 6e3d 302e 2c0a 2020 2020 2020 2020 2020  n=0.,.          
+00014450: 2020 2020 206c 6973 7420 445a 3d4e 6f6e       list DZ=Non
+00014460: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
 00014470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014480: 2020 2020 2020 2020 2064 6f75 626c 655b           double[
-00014490: 3a2c 3a3a 315d 2056 496e 3d4e 6f6e 652c  :,::1] VIn=None,
-000144a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000144b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000144c0: 2020 2020 646f 7562 6c65 206d 6172 6769      double margi
-000144d0: 6e3d 5f56 534d 414c 4c2c 0a20 2020 2020  n=_VSMALL,.     
+00014480: 2020 2020 2020 646f 7562 6c65 2044 496e        double DIn
+00014490: 3d30 2e2c 0a20 2020 2020 2020 2020 2020  =0.,.           
+000144a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000144b0: 2020 2020 2020 2020 646f 7562 6c65 5b3a          double[:
+000144c0: 2c3a 3a31 5d20 5649 6e3d 4e6f 6e65 2c0a  ,::1] VIn=None,.
+000144d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000144e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000144f0: 2020 2020 2020 2020 2020 2020 2020 293a                ):
-00014500: 0a20 2020 2022 2222 5265 7475 726e 2074  .    """Return t
-00014510: 6865 2064 6573 6972 6564 2073 7572 6661  he desired surfa
-00014520: 6369 6320 7375 626d 6573 6820 696e 6469  cic submesh indi
-00014530: 6361 7465 6420 6279 2074 6865 206c 696d  cated by the lim
-00014540: 6974 7320 2844 582c 4459 2c44 5a29 2c0a  its (DX,DY,DZ),.
-00014550: 2020 2020 666f 7220 7468 6520 6465 7369      for the desi
-00014560: 7265 6420 7265 736f 6c75 7469 6f6e 2028  red resolution (
-00014570: 6458 2c64 4c29 2022 2222 0a20 2020 2063  dX,dL) """.    c
-00014580: 6465 6620 6e70 2e6e 6461 7272 6179 5b64  def np.ndarray[d
-00014590: 6f75 626c 652c 6e64 696d 3d31 5d20 582c  ouble,ndim=1] X,
-000145a0: 2059 302c 205a 300a 2020 2020 6364 6566   Y0, Z0.    cdef
-000145b0: 2064 6f75 626c 6520 6458 722c 2064 5930   double dXr, dY0
-000145c0: 722c 2064 5a30 720a 2020 2020 6364 6566  r, dZ0r.    cdef
-000145d0: 2069 6e74 204e 5930 2c20 4e5a 302c 2059   int NY0, NZ0, Y
-000145e0: 306e 2c20 5a30 6e2c 204e 582c 2058 6e2c  0n, Z0n, NX, Xn,
-000145f0: 204c 6e2c 204e 5230 2c20 696e 7465 723d   Ln, NR0, inter=
-00014600: 310a 2020 2020 6364 6566 206e 702e 6e64  1.    cdef np.nd
-00014610: 6172 7261 795b 646f 7562 6c65 2c6e 6469  array[double,ndi
-00014620: 6d3d 325d 2050 7473 2c20 5074 7343 726f  m=2] Pts, PtsCro
-00014630: 7373 2c20 5650 6269 730a 2020 2020 6364  ss, VPbis.    cd
-00014640: 6566 206e 702e 6e64 6172 7261 795b 646f  ef np.ndarray[do
-00014650: 7562 6c65 2c6e 6469 6d3d 315d 2064 532c  uble,ndim=1] dS,
-00014660: 2064 4c72 2c20 5272 6566 0a20 2020 2063   dLr, Rref.    c
-00014670: 6465 6620 6e70 2e6e 6461 7272 6179 5b6c  def np.ndarray[l
-00014680: 6f6e 672c 6e64 696d 3d31 5d20 696e 6458  ong,ndim=1] indX
-00014690: 2c20 696e 6459 302c 2069 6e64 5a30 2c20  , indY0, indZ0, 
-000146a0: 696e 644c 2c20 4e4c 2c20 696e 640a 0a20  indL, NL, ind.. 
-000146b0: 2020 2023 2050 7265 666f 726d 6174 0a20     # Preformat. 
-000146c0: 2020 2023 2041 646a 7573 7420 6c69 6d69     # Adjust limi
-000146d0: 7473 0a20 2020 2069 6e74 6572 5820 3d20  ts.    interX = 
-000146e0: 5f63 6865 636b 5f44 4c76 734c 4d69 6e4d  _check_DLvsLMinM
-000146f0: 6178 2858 4d69 6e4d 6178 2c20 4458 290a  ax(XMinMax, DX).
-00014700: 2020 2020 696e 7465 7259 203d 205f 6368      interY = _ch
-00014710: 6563 6b5f 444c 7673 4c4d 696e 4d61 7828  eck_DLvsLMinMax(
-00014720: 6e70 2e61 7272 6179 285b 6e70 2e6d 696e  np.array([np.min
-00014730: 2856 506f 6c79 5b30 2c3a 5d29 2c0a 2020  (VPoly[0,:]),.  
-00014740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014760: 2020 2020 2020 2020 6e70 2e6d 6178 2856          np.max(V
-00014770: 506f 6c79 5b30 2c3a 5d29 5d29 2c20 4459  Poly[0,:])]), DY
-00014780: 290a 2020 2020 696e 7465 725a 203d 205f  ).    interZ = _
-00014790: 6368 6563 6b5f 444c 7673 4c4d 696e 4d61  check_DLvsLMinMa
-000147a0: 7828 6e70 2e61 7272 6179 285b 6e70 2e6d  x(np.array([np.m
-000147b0: 696e 2856 506f 6c79 5b31 2c3a 5d29 2c0a  in(VPoly[1,:]),.
-000147c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000147d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000147e0: 2020 2020 2020 2020 2020 2020 2020 6e70                np
-000147f0: 2e6d 6178 2856 506f 6c79 5b31 2c3a 5d29  .max(VPoly[1,:])
-00014800: 5d29 2c20 445a 290a 0a20 2020 2069 6620  ]), DZ)..    if 
-00014810: 696e 7465 7258 3d3d 3120 616e 6420 696e  interX==1 and in
-00014820: 7465 7259 3d3d 3120 616e 6420 696e 7465  terY==1 and inte
-00014830: 725a 3d3d 313a 0a0a 2020 2020 2020 2020  rZ==1:..        
-00014840: 2320 4765 7420 7468 6520 6d65 7368 2066  # Get the mesh f
-00014850: 6f72 2074 6865 2066 6163 6573 0a20 2020  or the faces.   
-00014860: 2020 2020 2059 302c 2064 5930 722c 5c0a       Y0, dY0r,\.
-00014870: 2020 2020 2020 2020 2020 696e 6459 302c            indY0,
-00014880: 204e 5930 203d 2064 6973 6372 6574 697a   NY0 = discretiz
-00014890: 655f 6c69 6e65 3164 286e 702e 6172 7261  e_line1d(np.arra
-000148a0: 7928 5b6e 702e 6d69 6e28 5650 6f6c 795b  y([np.min(VPoly[
-000148b0: 302c 3a5d 292c 0a20 2020 2020 2020 2020  0,:]),.         
-000148c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000148d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000148e0: 2020 2020 2020 2020 2020 6e70 2e6d 6178            np.max
-000148f0: 2856 506f 6c79 5b30 2c3a 5d29 5d29 2c0a  (VPoly[0,:])]),.
+000144f0: 2020 2064 6f75 626c 6520 6d61 7267 696e     double margin
+00014500: 3d5f 5653 4d41 4c4c 2c0a 2020 2020 2020  =_VSMALL,.      
+00014510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014520: 2020 2020 2020 2020 2020 2020 2029 3a0a               ):.
+00014530: 2020 2020 2222 2252 6574 7572 6e20 7468      """Return th
+00014540: 6520 6465 7369 7265 6420 7375 7266 6163  e desired surfac
+00014550: 6963 2073 7562 6d65 7368 2069 6e64 6963  ic submesh indic
+00014560: 6174 6564 2062 7920 7468 6520 6c69 6d69  ated by the limi
+00014570: 7473 2028 4458 2c44 592c 445a 292c 0a20  ts (DX,DY,DZ),. 
+00014580: 2020 2066 6f72 2074 6865 2064 6573 6972     for the desir
+00014590: 6564 2072 6573 6f6c 7574 696f 6e20 2864  ed resolution (d
+000145a0: 582c 644c 2920 2222 220a 2020 2020 6364  X,dL) """.    cd
+000145b0: 6566 206e 702e 6e64 6172 7261 795b 646f  ef np.ndarray[do
+000145c0: 7562 6c65 2c6e 6469 6d3d 315d 2058 2c20  uble,ndim=1] X, 
+000145d0: 5930 2c20 5a30 0a20 2020 2063 6465 6620  Y0, Z0.    cdef 
+000145e0: 646f 7562 6c65 2064 5872 2c20 6459 3072  double dXr, dY0r
+000145f0: 2c20 645a 3072 0a20 2020 2063 6465 6620  , dZ0r.    cdef 
+00014600: 696e 7420 4e59 302c 204e 5a30 2c20 5930  int NY0, NZ0, Y0
+00014610: 6e2c 205a 306e 2c20 4e58 2c20 586e 2c20  n, Z0n, NX, Xn, 
+00014620: 4c6e 2c20 4e52 302c 2069 6e74 6572 3d31  Ln, NR0, inter=1
+00014630: 0a20 2020 2063 6465 6620 6e70 2e6e 6461  .    cdef np.nda
+00014640: 7272 6179 5b64 6f75 626c 652c 6e64 696d  rray[double,ndim
+00014650: 3d32 5d20 5074 732c 2050 7473 4372 6f73  =2] Pts, PtsCros
+00014660: 732c 2056 5062 6973 0a20 2020 2063 6465  s, VPbis.    cde
+00014670: 6620 6e70 2e6e 6461 7272 6179 5b64 6f75  f np.ndarray[dou
+00014680: 626c 652c 6e64 696d 3d31 5d20 6453 2c20  ble,ndim=1] dS, 
+00014690: 644c 722c 2052 7265 660a 2020 2020 6364  dLr, Rref.    cd
+000146a0: 6566 206e 702e 6e64 6172 7261 795b 6c6f  ef np.ndarray[lo
+000146b0: 6e67 2c6e 6469 6d3d 315d 2069 6e64 582c  ng,ndim=1] indX,
+000146c0: 2069 6e64 5930 2c20 696e 645a 302c 2069   indY0, indZ0, i
+000146d0: 6e64 4c2c 204e 4c2c 2069 6e64 0a0a 2020  ndL, NL, ind..  
+000146e0: 2020 2320 5072 6566 6f72 6d61 740a 2020    # Preformat.  
+000146f0: 2020 2320 4164 6a75 7374 206c 696d 6974    # Adjust limit
+00014700: 730a 2020 2020 696e 7465 7258 203d 205f  s.    interX = _
+00014710: 6368 6563 6b5f 444c 7673 4c4d 696e 4d61  check_DLvsLMinMa
+00014720: 7828 584d 696e 4d61 782c 2044 5829 0a20  x(XMinMax, DX). 
+00014730: 2020 2069 6e74 6572 5920 3d20 5f63 6865     interY = _che
+00014740: 636b 5f44 4c76 734c 4d69 6e4d 6178 286e  ck_DLvsLMinMax(n
+00014750: 702e 6172 7261 7928 5b6e 702e 6d69 6e28  p.array([np.min(
+00014760: 5650 6f6c 795b 302c 3a5d 292c 0a20 2020  VPoly[0,:]),.   
+00014770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014790: 2020 2020 2020 206e 702e 6d61 7828 5650         np.max(VP
+000147a0: 6f6c 795b 302c 3a5d 295d 292c 2044 5929  oly[0,:])]), DY)
+000147b0: 0a20 2020 2069 6e74 6572 5a20 3d20 5f63  .    interZ = _c
+000147c0: 6865 636b 5f44 4c76 734c 4d69 6e4d 6178  heck_DLvsLMinMax
+000147d0: 286e 702e 6172 7261 7928 5b6e 702e 6d69  (np.array([np.mi
+000147e0: 6e28 5650 6f6c 795b 312c 3a5d 292c 0a20  n(VPoly[1,:]),. 
+000147f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014810: 2020 2020 2020 2020 2020 2020 206e 702e               np.
+00014820: 6d61 7828 5650 6f6c 795b 312c 3a5d 295d  max(VPoly[1,:])]
+00014830: 292c 2044 5a29 0a0a 2020 2020 6966 2069  ), DZ)..    if i
+00014840: 6e74 6572 583d 3d31 2061 6e64 2069 6e74  nterX==1 and int
+00014850: 6572 593d 3d31 2061 6e64 2069 6e74 6572  erY==1 and inter
+00014860: 5a3d 3d31 3a0a 0a20 2020 2020 2020 2023  Z==1:..        #
+00014870: 2047 6574 2074 6865 206d 6573 6820 666f   Get the mesh fo
+00014880: 7220 7468 6520 6661 6365 730a 2020 2020  r the faces.    
+00014890: 2020 2020 5930 2c20 6459 3072 2c5c 0a20      Y0, dY0r,\. 
+000148a0: 2020 2020 2020 2020 2069 6e64 5930 2c20           indY0, 
+000148b0: 4e59 3020 3d20 6469 7363 7265 7469 7a65  NY0 = discretize
+000148c0: 5f6c 696e 6531 6428 6e70 2e61 7272 6179  _line1d(np.array
+000148d0: 285b 6e70 2e6d 696e 2856 506f 6c79 5b30  ([np.min(VPoly[0
+000148e0: 2c3a 5d29 2c0a 2020 2020 2020 2020 2020  ,:]),.          
+000148f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00014900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014920: 2020 2020 2020 2020 2064 4c2c 2044 4c3d           dL, DL=
-00014930: 4459 2c20 4c69 6d3d 5472 7565 2c20 6d61  DY, Lim=True, ma
-00014940: 7267 696e 3d6d 6172 6769 6e29 0a20 2020  rgin=margin).   
-00014950: 2020 2020 205a 302c 2064 5a30 722c 5c0a       Z0, dZ0r,\.
-00014960: 2020 2020 2020 2020 2020 696e 645a 302c            indZ0,
-00014970: 204e 5a30 203d 2064 6973 6372 6574 697a   NZ0 = discretiz
-00014980: 655f 6c69 6e65 3164 286e 702e 6172 7261  e_line1d(np.arra
-00014990: 7928 5b6e 702e 6d69 6e28 5650 6f6c 795b  y([np.min(VPoly[
-000149a0: 312c 3a5d 292c 0a20 2020 2020 2020 2020  1,:]),.         
-000149b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000149c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000149d0: 2020 2020 2020 2020 2020 6e70 2e6d 6178            np.max
-000149e0: 2856 506f 6c79 5b31 2c3a 5d29 5d29 2c0a  (VPoly[1,:])]),.
+00014910: 2020 2020 2020 2020 206e 702e 6d61 7828           np.max(
+00014920: 5650 6f6c 795b 302c 3a5d 295d 292c 0a20  VPoly[0,:])]),. 
+00014930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014950: 2020 2020 2020 2020 644c 2c20 444c 3d44          dL, DL=D
+00014960: 592c 204c 696d 3d54 7275 652c 206d 6172  Y, Lim=True, mar
+00014970: 6769 6e3d 6d61 7267 696e 290a 2020 2020  gin=margin).    
+00014980: 2020 2020 5a30 2c20 645a 3072 2c5c 0a20      Z0, dZ0r,\. 
+00014990: 2020 2020 2020 2020 2069 6e64 5a30 2c20           indZ0, 
+000149a0: 4e5a 3020 3d20 6469 7363 7265 7469 7a65  NZ0 = discretize
+000149b0: 5f6c 696e 6531 6428 6e70 2e61 7272 6179  _line1d(np.array
+000149c0: 285b 6e70 2e6d 696e 2856 506f 6c79 5b31  ([np.min(VPoly[1
+000149d0: 2c3a 5d29 2c0a 2020 2020 2020 2020 2020  ,:]),.          
+000149e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000149f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014a10: 2020 2020 2020 2020 2064 4c2c 2044 4c3d           dL, DL=
-00014a20: 445a 2c20 4c69 6d3d 5472 7565 2c20 6d61  DZ, Lim=True, ma
-00014a30: 7267 696e 3d6d 6172 6769 6e29 0a20 2020  rgin=margin).   
-00014a40: 2020 2020 2059 306e 2c20 5a30 6e20 3d20       Y0n, Z0n = 
-00014a50: 6c65 6e28 5930 292c 206c 656e 285a 3029  len(Y0), len(Z0)
-00014a60: 0a20 2020 2020 2020 2023 2047 6574 2074  .        # Get t
-00014a70: 6865 2061 6374 7561 6c20 5220 616e 6420  he actual R and 
-00014a80: 5a20 7265 736f 6c75 7469 6f6e 7320 616e  Z resolutions an
-00014a90: 6420 6d65 7368 2065 6c65 6d65 6e74 730a  d mesh elements.
-00014aa0: 2020 2020 2020 2020 582c 2064 5872 2c20          X, dXr, 
-00014ab0: 696e 6458 2c20 4e58 203d 2064 6973 6372  indX, NX = discr
-00014ac0: 6574 697a 655f 6c69 6e65 3164 2858 4d69  etize_line1d(XMi
-00014ad0: 6e4d 6178 2c20 6458 2c0a 2020 2020 2020  nMax, dX,.      
-00014ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014b00: 2020 2020 2020 2020 444c 3d44 582c 0a20          DL=DX,. 
+00014a00: 2020 2020 2020 2020 206e 702e 6d61 7828           np.max(
+00014a10: 5650 6f6c 795b 312c 3a5d 295d 292c 0a20  VPoly[1,:])]),. 
+00014a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014a40: 2020 2020 2020 2020 644c 2c20 444c 3d44          dL, DL=D
+00014a50: 5a2c 204c 696d 3d54 7275 652c 206d 6172  Z, Lim=True, mar
+00014a60: 6769 6e3d 6d61 7267 696e 290a 2020 2020  gin=margin).    
+00014a70: 2020 2020 5930 6e2c 205a 306e 203d 206c      Y0n, Z0n = l
+00014a80: 656e 2859 3029 2c20 6c65 6e28 5a30 290a  en(Y0), len(Z0).
+00014a90: 2020 2020 2020 2020 2320 4765 7420 7468          # Get th
+00014aa0: 6520 6163 7475 616c 2052 2061 6e64 205a  e actual R and Z
+00014ab0: 2072 6573 6f6c 7574 696f 6e73 2061 6e64   resolutions and
+00014ac0: 206d 6573 6820 656c 656d 656e 7473 0a20   mesh elements. 
+00014ad0: 2020 2020 2020 2058 2c20 6458 722c 2069         X, dXr, i
+00014ae0: 6e64 582c 204e 5820 3d20 6469 7363 7265  ndX, NX = discre
+00014af0: 7469 7a65 5f6c 696e 6531 6428 584d 696e  tize_line1d(XMin
+00014b00: 4d61 782c 2064 582c 0a20 2020 2020 2020  Max, dX,.       
 00014b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00014b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014b30: 2020 2020 2020 2020 2020 2020 204c 696d               Lim
-00014b40: 3d54 7275 652c 206d 6172 6769 6e3d 6d61  =True, margin=ma
-00014b50: 7267 696e 290a 2020 2020 2020 2020 586e  rgin).        Xn
-00014b60: 203d 206c 656e 2858 290a 2020 2020 2020   = len(X).      
-00014b70: 2020 5074 7343 726f 7373 2c20 644c 722c    PtsCross, dLr,
-00014b80: 2069 6e64 4c2c 5c0a 2020 2020 2020 2020   indL,\.        
-00014b90: 2020 4e4c 2c20 5272 6566 2c20 5650 6269    NL, Rref, VPbi
-00014ba0: 7320 3d20 6469 7363 7265 7469 7a65 5f76  s = discretize_v
-00014bb0: 706f 6c79 2856 506f 6c79 2c20 644c 2c20  poly(VPoly, dL, 
-00014bc0: 4431 3d4e 6f6e 652c 2044 323d 4e6f 6e65  D1=None, D2=None
-00014bd0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00014be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014bf0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00014c00: 6172 6769 6e3d 6d61 7267 696e 2c20 4449  argin=margin, DI
-00014c10: 6e3d 4449 6e2c 2056 496e 3d56 496e 290a  n=DIn, VIn=VIn).
-00014c20: 2020 2020 2020 2020 4e52 3020 3d20 5272          NR0 = Rr
-00014c30: 6566 2e73 697a 650a 2020 2020 2020 2020  ef.size.        
-00014c40: 696e 6469 6e20 3d20 6e70 2e6f 6e65 7328  indin = np.ones(
-00014c50: 2850 7473 4372 6f73 732e 7368 6170 655b  (PtsCross.shape[
-00014c60: 315d 2c29 2c64 7479 7065 3d62 6f6f 6c29  1],),dtype=bool)
-00014c70: 0a20 2020 2020 2020 2069 6620 4459 2069  .        if DY i
-00014c80: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00014c90: 2020 2020 2020 2020 6966 2044 595b 305d          if DY[0]
-00014ca0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-00014cb0: 2020 2020 2020 2020 2020 2020 2020 696e                in
-00014cc0: 6469 6e20 3d20 696e 6469 6e20 2620 2850  din = indin & (P
-00014cd0: 7473 4372 6f73 735b 302c 3a5d 3e3d 4459  tsCross[0,:]>=DY
-00014ce0: 5b30 5d29 0a20 2020 2020 2020 2020 2020  [0]).           
-00014cf0: 2069 6620 4459 5b31 5d20 6973 206e 6f74   if DY[1] is not
-00014d00: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00014d10: 2020 2020 2020 2069 6e64 696e 203d 2069         indin = i
-00014d20: 6e64 696e 2026 2028 5074 7343 726f 7373  ndin & (PtsCross
-00014d30: 5b30 2c3a 5d3c 3d44 595b 315d 290a 2020  [0,:]<=DY[1]).  
-00014d40: 2020 2020 2020 6966 2044 5a20 6973 206e        if DZ is n
-00014d50: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00014d60: 2020 2020 2069 6620 445a 5b30 5d20 6973       if DZ[0] is
-00014d70: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-00014d80: 2020 2020 2020 2020 2020 2069 6e64 696e             indin
-00014d90: 203d 2069 6e64 696e 2026 2028 5074 7343   = indin & (PtsC
-00014da0: 726f 7373 5b31 2c3a 5d3e 3d44 5a5b 305d  ross[1,:]>=DZ[0]
-00014db0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-00014dc0: 2044 5a5b 315d 2069 7320 6e6f 7420 4e6f   DZ[1] is not No
-00014dd0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00014de0: 2020 2020 696e 6469 6e20 3d20 696e 6469      indin = indi
-00014df0: 6e20 2620 2850 7473 4372 6f73 735b 312c  n & (PtsCross[1,
-00014e00: 3a5d 3c3d 445a 5b31 5d29 0a20 2020 2020  :]<=DZ[1]).     
-00014e10: 2020 2050 7473 4372 6f73 732c 2064 4c72     PtsCross, dLr
-00014e20: 2c5c 0a20 2020 2020 2020 2020 2069 6e64  ,\.          ind
-00014e30: 4c2c 2052 7265 6620 3d20 5074 7343 726f  L, Rref = PtsCro
-00014e40: 7373 5b3a 2c69 6e64 696e 5d2c 2064 4c72  ss[:,indin], dLr
-00014e50: 5b69 6e64 696e 5d2c 2069 6e64 4c5b 696e  [indin], indL[in
-00014e60: 6469 6e5d 2c20 5272 6566 5b69 6e64 696e  din], Rref[indin
-00014e70: 5d0a 2020 2020 2020 2020 4c6e 203d 2069  ].        Ln = i
-00014e80: 6e64 696e 2e73 756d 2829 0a20 2020 2020  ndin.sum().     
-00014e90: 2020 2023 2041 6772 6567 6174 696e 670a     # Agregating.
-00014ea0: 2020 2020 2020 2020 5074 7320 3d20 6e70          Pts = np
-00014eb0: 2e61 7272 6179 285b 6e70 2e72 6570 6561  .array([np.repea
-00014ec0: 7428 582c 4c6e 292c 0a20 2020 2020 2020  t(X,Ln),.       
-00014ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014ee0: 206e 702e 7469 6c65 2850 7473 4372 6f73   np.tile(PtsCros
-00014ef0: 735b 302c 3a5d 2c58 6e29 2c0a 2020 2020  s[0,:],Xn),.    
+00014b30: 2020 2020 2020 2044 4c3d 4458 2c0a 2020         DL=DX,.  
+00014b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014b60: 2020 2020 2020 2020 2020 2020 4c69 6d3d              Lim=
+00014b70: 5472 7565 2c20 6d61 7267 696e 3d6d 6172  True, margin=mar
+00014b80: 6769 6e29 0a20 2020 2020 2020 2058 6e20  gin).        Xn 
+00014b90: 3d20 6c65 6e28 5829 0a20 2020 2020 2020  = len(X).       
+00014ba0: 2050 7473 4372 6f73 732c 2064 4c72 2c20   PtsCross, dLr, 
+00014bb0: 696e 644c 2c5c 0a20 2020 2020 2020 2020  indL,\.         
+00014bc0: 204e 4c2c 2052 7265 662c 2056 5062 6973   NL, Rref, VPbis
+00014bd0: 203d 2064 6973 6372 6574 697a 655f 7670   = discretize_vp
+00014be0: 6f6c 7928 5650 6f6c 792c 2064 4c2c 2044  oly(VPoly, dL, D
+00014bf0: 313d 4e6f 6e65 2c20 4432 3d4e 6f6e 652c  1=None, D2=None,
+00014c00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014c20: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
+00014c30: 7267 696e 3d6d 6172 6769 6e2c 2044 496e  rgin=margin, DIn
+00014c40: 3d44 496e 2c20 5649 6e3d 5649 6e29 0a20  =DIn, VIn=VIn). 
+00014c50: 2020 2020 2020 204e 5230 203d 2052 7265         NR0 = Rre
+00014c60: 662e 7369 7a65 0a20 2020 2020 2020 2069  f.size.        i
+00014c70: 6e64 696e 203d 206e 702e 6f6e 6573 2828  ndin = np.ones((
+00014c80: 5074 7343 726f 7373 2e73 6861 7065 5b31  PtsCross.shape[1
+00014c90: 5d2c 292c 6474 7970 653d 626f 6f6c 290a  ],),dtype=bool).
+00014ca0: 2020 2020 2020 2020 6966 2044 5920 6973          if DY is
+00014cb0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00014cc0: 2020 2020 2020 2069 6620 4459 5b30 5d20         if DY[0] 
+00014cd0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00014ce0: 2020 2020 2020 2020 2020 2020 2069 6e64               ind
+00014cf0: 696e 203d 2069 6e64 696e 2026 2028 5074  in = indin & (Pt
+00014d00: 7343 726f 7373 5b30 2c3a 5d3e 3d44 595b  sCross[0,:]>=DY[
+00014d10: 305d 290a 2020 2020 2020 2020 2020 2020  0]).            
+00014d20: 6966 2044 595b 315d 2069 7320 6e6f 7420  if DY[1] is not 
+00014d30: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00014d40: 2020 2020 2020 696e 6469 6e20 3d20 696e        indin = in
+00014d50: 6469 6e20 2620 2850 7473 4372 6f73 735b  din & (PtsCross[
+00014d60: 302c 3a5d 3c3d 4459 5b31 5d29 0a20 2020  0,:]<=DY[1]).   
+00014d70: 2020 2020 2069 6620 445a 2069 7320 6e6f       if DZ is no
+00014d80: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00014d90: 2020 2020 6966 2044 5a5b 305d 2069 7320      if DZ[0] is 
+00014da0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+00014db0: 2020 2020 2020 2020 2020 696e 6469 6e20            indin 
+00014dc0: 3d20 696e 6469 6e20 2620 2850 7473 4372  = indin & (PtsCr
+00014dd0: 6f73 735b 312c 3a5d 3e3d 445a 5b30 5d29  oss[1,:]>=DZ[0])
+00014de0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00014df0: 445a 5b31 5d20 6973 206e 6f74 204e 6f6e  DZ[1] is not Non
+00014e00: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00014e10: 2020 2069 6e64 696e 203d 2069 6e64 696e     indin = indin
+00014e20: 2026 2028 5074 7343 726f 7373 5b31 2c3a   & (PtsCross[1,:
+00014e30: 5d3c 3d44 5a5b 315d 290a 2020 2020 2020  ]<=DZ[1]).      
+00014e40: 2020 5074 7343 726f 7373 2c20 644c 722c    PtsCross, dLr,
+00014e50: 5c0a 2020 2020 2020 2020 2020 696e 644c  \.          indL
+00014e60: 2c20 5272 6566 203d 2050 7473 4372 6f73  , Rref = PtsCros
+00014e70: 735b 3a2c 696e 6469 6e5d 2c20 644c 725b  s[:,indin], dLr[
+00014e80: 696e 6469 6e5d 2c20 696e 644c 5b69 6e64  indin], indL[ind
+00014e90: 696e 5d2c 2052 7265 665b 696e 6469 6e5d  in], Rref[indin]
+00014ea0: 0a20 2020 2020 2020 204c 6e20 3d20 696e  .        Ln = in
+00014eb0: 6469 6e2e 7375 6d28 290a 2020 2020 2020  din.sum().      
+00014ec0: 2020 2320 4167 7265 6761 7469 6e67 0a20    # Agregating. 
+00014ed0: 2020 2020 2020 2050 7473 203d 206e 702e         Pts = np.
+00014ee0: 6172 7261 7928 5b6e 702e 7265 7065 6174  array([np.repeat
+00014ef0: 2858 2c4c 6e29 2c0a 2020 2020 2020 2020  (X,Ln),.        
 00014f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014f10: 2020 2020 6e70 2e74 696c 6528 5074 7343      np.tile(PtsC
-00014f20: 726f 7373 5b31 2c3a 5d2c 586e 295d 290a  ross[1,:],Xn)]).
-00014f30: 2020 2020 2020 2020 696e 6420 3d20 4e59          ind = NY
-00014f40: 302a 4e5a 3020 2b20 6e70 2e72 6570 6561  0*NZ0 + np.repea
-00014f50: 7428 696e 6458 2a4e 5230 2c4c 6e29 202b  t(indX*NR0,Ln) +
-00014f60: 206e 702e 7469 6c65 2869 6e64 4c2c 586e   np.tile(indL,Xn
-00014f70: 290a 2020 2020 2020 2020 6453 203d 206e  ).        dS = n
-00014f80: 702e 7469 6c65 2864 4c72 2a64 5872 2c58  p.tile(dLr*dXr,X
-00014f90: 6e29 0a20 2020 2020 2020 2069 6620 4458  n).        if DX
-00014fa0: 2069 7320 4e6f 6e65 206f 7220 4458 5b30   is None or DX[0
-00014fb0: 5d20 6973 204e 6f6e 653a 0a20 2020 2020  ] is None:.     
-00014fc0: 2020 2020 2020 2070 7473 203d 206e 702e         pts = np.
-00014fd0: 6172 7261 7928 5b28 584d 696e 4d61 785b  array([(XMinMax[
-00014fe0: 305d 2b44 496e 292a 6e70 2e6f 6e65 7328  0]+DIn)*np.ones(
-00014ff0: 2859 306e 2a5a 306e 2c29 292c 0a20 2020  (Y0n*Z0n,)),.   
-00015000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015010: 2020 2020 2020 2020 206e 702e 7469 6c65           np.tile
-00015020: 2859 302c 5a30 6e29 2c0a 2020 2020 2020  (Y0,Z0n),.      
+00014f10: 6e70 2e74 696c 6528 5074 7343 726f 7373  np.tile(PtsCross
+00014f20: 5b30 2c3a 5d2c 586e 292c 0a20 2020 2020  [0,:],Xn),.     
+00014f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014f40: 2020 206e 702e 7469 6c65 2850 7473 4372     np.tile(PtsCr
+00014f50: 6f73 735b 312c 3a5d 2c58 6e29 5d29 0a20  oss[1,:],Xn)]). 
+00014f60: 2020 2020 2020 2069 6e64 203d 204e 5930         ind = NY0
+00014f70: 2a4e 5a30 202b 206e 702e 7265 7065 6174  *NZ0 + np.repeat
+00014f80: 2869 6e64 582a 4e52 302c 4c6e 2920 2b20  (indX*NR0,Ln) + 
+00014f90: 6e70 2e74 696c 6528 696e 644c 2c58 6e29  np.tile(indL,Xn)
+00014fa0: 0a20 2020 2020 2020 2064 5320 3d20 6e70  .        dS = np
+00014fb0: 2e74 696c 6528 644c 722a 6458 722c 586e  .tile(dLr*dXr,Xn
+00014fc0: 290a 2020 2020 2020 2020 6966 2044 5820  ).        if DX 
+00014fd0: 6973 204e 6f6e 6520 6f72 2044 585b 305d  is None or DX[0]
+00014fe0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00014ff0: 2020 2020 2020 7074 7320 3d20 6e70 2e61        pts = np.a
+00015000: 7272 6179 285b 2858 4d69 6e4d 6178 5b30  rray([(XMinMax[0
+00015010: 5d2b 4449 6e29 2a6e 702e 6f6e 6573 2828  ]+DIn)*np.ones((
+00015020: 5930 6e2a 5a30 6e2c 2929 2c0a 2020 2020  Y0n*Z0n,)),.    
 00015030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015040: 2020 2020 2020 6e70 2e72 6570 6561 7428        np.repeat(
-00015050: 5a30 2c59 306e 295d 290a 2020 2020 2020  Z0,Y0n)]).      
-00015060: 2020 2020 2020 6969 6e64 203d 204e 5930        iind = NY0
-00015070: 2a6e 702e 7265 7065 6174 2869 6e64 5a30  *np.repeat(indZ0
-00015080: 2c59 306e 2920 2b20 6e70 2e74 696c 6528  ,Y0n) + np.tile(
-00015090: 696e 6459 302c 5a30 6e29 0a20 2020 2020  indY0,Z0n).     
-000150a0: 2020 2020 2020 2069 6e64 696e 203d 2050         indin = P
-000150b0: 6174 6828 5650 6f6c 792e 5429 2e63 6f6e  ath(VPoly.T).con
-000150c0: 7461 696e 735f 706f 696e 7473 2870 7473  tains_points(pts
-000150d0: 5b31 3a2c 3a5d 2e54 2c20 7472 616e 7366  [1:,:].T, transf
-000150e0: 6f72 6d3d 4e6f 6e65 2c0a 2020 2020 2020  orm=None,.      
-000150f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015110: 2020 2020 2020 2020 2020 2020 7261 6469              radi
-00015120: 7573 3d30 2e30 290a 2020 2020 2020 2020  us=0.0).        
-00015130: 2020 2020 6966 206e 702e 616e 7928 696e      if np.any(in
-00015140: 6469 6e29 3a0a 2020 2020 2020 2020 2020  din):.          
-00015150: 2020 2020 2020 7074 7320 3d20 7074 735b        pts = pts[
-00015160: 3a2c 696e 6469 6e5d 2e72 6573 6861 7065  :,indin].reshape
-00015170: 2828 332c 3129 2920 6966 2069 6e64 696e  ((3,1)) if indin
-00015180: 2e73 756d 2829 3d3d 315c 0a20 2020 2020  .sum()==1\.     
-00015190: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-000151a0: 6520 7074 735b 3a2c 696e 6469 6e5d 0a20  e pts[:,indin]. 
-000151b0: 2020 2020 2020 2020 2020 2020 2020 2050                 P
-000151c0: 7473 203d 206e 702e 636f 6e63 6174 656e  ts = np.concaten
-000151d0: 6174 6528 2870 7473 2c50 7473 292c 6178  ate((pts,Pts),ax
-000151e0: 6973 3d31 290a 2020 2020 2020 2020 2020  is=1).          
-000151f0: 2020 2020 2020 696e 6420 3d20 6e70 2e63        ind = np.c
-00015200: 6f6e 6361 7465 6e61 7465 2828 6969 6e64  oncatenate((iind
-00015210: 5b69 6e64 696e 5d2c 2069 6e64 2929 0a20  [indin], ind)). 
-00015220: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00015230: 5320 3d20 6e70 2e63 6f6e 6361 7465 6e61  S = np.concatena
-00015240: 7465 2828 6459 3072 2a64 5a30 722a 6e70  te((dY0r*dZ0r*np
-00015250: 2e6f 6e65 7328 2869 6e64 696e 2e73 756d  .ones((indin.sum
-00015260: 2829 2c29 292c 6453 2929 0a20 2020 2020  (),)),dS)).     
-00015270: 2020 2069 6620 4458 2069 7320 4e6f 6e65     if DX is None
-00015280: 206f 7220 4458 5b31 5d20 6973 204e 6f6e   or DX[1] is Non
-00015290: 653a 0a20 2020 2020 2020 2020 2020 2070  e:.            p
-000152a0: 7473 203d 206e 702e 6172 7261 7928 5b28  ts = np.array([(
-000152b0: 584d 696e 4d61 785b 315d 2d44 496e 292a  XMinMax[1]-DIn)*
-000152c0: 6e70 2e6f 6e65 7328 2859 306e 2a5a 306e  np.ones((Y0n*Z0n
-000152d0: 2c29 292c 0a20 2020 2020 2020 2020 2020  ,)),.           
-000152e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000152f0: 206e 702e 7469 6c65 2859 302c 5a30 6e29   np.tile(Y0,Z0n)
-00015300: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00015310: 2020 2020 2020 2020 2020 2020 2020 6e70                np
-00015320: 2e72 6570 6561 7428 5a30 2c59 306e 295d  .repeat(Z0,Y0n)]
-00015330: 290a 2020 2020 2020 2020 2020 2020 6969  ).            ii
-00015340: 6e64 203d 204e 5930 2a4e 5a30 202b 204e  nd = NY0*NZ0 + N
-00015350: 582a 4e52 3020 2b20 4e59 302a 6e70 2e72  X*NR0 + NY0*np.r
-00015360: 6570 6561 7428 696e 645a 302c 5930 6e29  epeat(indZ0,Y0n)
-00015370: 202b 5c0a 2020 2020 2020 2020 2020 2020   +\.            
-00015380: 2020 6e70 2e74 696c 6528 696e 6459 302c    np.tile(indY0,
-00015390: 5a30 6e29 0a20 2020 2020 2020 2020 2020  Z0n).           
-000153a0: 2069 6e64 696e 203d 2050 6174 6828 5650   indin = Path(VP
-000153b0: 6f6c 792e 5429 2e63 6f6e 7461 696e 735f  oly.T).contains_
-000153c0: 706f 696e 7473 2870 7473 5b31 3a2c 3a5d  points(pts[1:,:]
-000153d0: 2e54 2c0a 2020 2020 2020 2020 2020 2020  .T,.            
-000153e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000153f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015400: 2020 2020 2020 7472 616e 7366 6f72 6d3d        transform=
-00015410: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+00015040: 2020 2020 2020 2020 6e70 2e74 696c 6528          np.tile(
+00015050: 5930 2c5a 306e 292c 0a20 2020 2020 2020  Y0,Z0n),.       
+00015060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015070: 2020 2020 206e 702e 7265 7065 6174 285a       np.repeat(Z
+00015080: 302c 5930 6e29 5d29 0a20 2020 2020 2020  0,Y0n)]).       
+00015090: 2020 2020 2069 696e 6420 3d20 4e59 302a       iind = NY0*
+000150a0: 6e70 2e72 6570 6561 7428 696e 645a 302c  np.repeat(indZ0,
+000150b0: 5930 6e29 202b 206e 702e 7469 6c65 2869  Y0n) + np.tile(i
+000150c0: 6e64 5930 2c5a 306e 290a 2020 2020 2020  ndY0,Z0n).      
+000150d0: 2020 2020 2020 696e 6469 6e20 3d20 5061        indin = Pa
+000150e0: 7468 2856 506f 6c79 2e54 292e 636f 6e74  th(VPoly.T).cont
+000150f0: 6169 6e73 5f70 6f69 6e74 7328 7074 735b  ains_points(pts[
+00015100: 313a 2c3a 5d2e 542c 2074 7261 6e73 666f  1:,:].T, transfo
+00015110: 726d 3d4e 6f6e 652c 0a20 2020 2020 2020  rm=None,.       
+00015120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015140: 2020 2020 2020 2020 2020 2072 6164 6975             radiu
+00015150: 733d 302e 3029 0a20 2020 2020 2020 2020  s=0.0).         
+00015160: 2020 2069 6620 6e70 2e61 6e79 2869 6e64     if np.any(ind
+00015170: 696e 293a 0a20 2020 2020 2020 2020 2020  in):.           
+00015180: 2020 2020 2070 7473 203d 2070 7473 5b3a       pts = pts[:
+00015190: 2c69 6e64 696e 5d2e 7265 7368 6170 6528  ,indin].reshape(
+000151a0: 2833 2c31 2929 2069 6620 696e 6469 6e2e  (3,1)) if indin.
+000151b0: 7375 6d28 293d 3d31 5c0a 2020 2020 2020  sum()==1\.      
+000151c0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+000151d0: 2070 7473 5b3a 2c69 6e64 696e 5d0a 2020   pts[:,indin].  
+000151e0: 2020 2020 2020 2020 2020 2020 2020 5074                Pt
+000151f0: 7320 3d20 6e70 2e63 6f6e 6361 7465 6e61  s = np.concatena
+00015200: 7465 2828 7074 732c 5074 7329 2c61 7869  te((pts,Pts),axi
+00015210: 733d 3129 0a20 2020 2020 2020 2020 2020  s=1).           
+00015220: 2020 2020 2069 6e64 203d 206e 702e 636f       ind = np.co
+00015230: 6e63 6174 656e 6174 6528 2869 696e 645b  ncatenate((iind[
+00015240: 696e 6469 6e5d 2c20 696e 6429 290a 2020  indin], ind)).  
+00015250: 2020 2020 2020 2020 2020 2020 2020 6453                dS
+00015260: 203d 206e 702e 636f 6e63 6174 656e 6174   = np.concatenat
+00015270: 6528 2864 5930 722a 645a 3072 2a6e 702e  e((dY0r*dZ0r*np.
+00015280: 6f6e 6573 2828 696e 6469 6e2e 7375 6d28  ones((indin.sum(
+00015290: 292c 2929 2c64 5329 290a 2020 2020 2020  ),)),dS)).      
+000152a0: 2020 6966 2044 5820 6973 204e 6f6e 6520    if DX is None 
+000152b0: 6f72 2044 585b 315d 2069 7320 4e6f 6e65  or DX[1] is None
+000152c0: 3a0a 2020 2020 2020 2020 2020 2020 7074  :.            pt
+000152d0: 7320 3d20 6e70 2e61 7272 6179 285b 2858  s = np.array([(X
+000152e0: 4d69 6e4d 6178 5b31 5d2d 4449 6e29 2a6e  MinMax[1]-DIn)*n
+000152f0: 702e 6f6e 6573 2828 5930 6e2a 5a30 6e2c  p.ones((Y0n*Z0n,
+00015300: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
+00015310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015320: 6e70 2e74 696c 6528 5930 2c5a 306e 292c  np.tile(Y0,Z0n),
+00015330: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015340: 2020 2020 2020 2020 2020 2020 206e 702e               np.
+00015350: 7265 7065 6174 285a 302c 5930 6e29 5d29  repeat(Z0,Y0n)])
+00015360: 0a20 2020 2020 2020 2020 2020 2069 696e  .            iin
+00015370: 6420 3d20 4e59 302a 4e5a 3020 2b20 4e58  d = NY0*NZ0 + NX
+00015380: 2a4e 5230 202b 204e 5930 2a6e 702e 7265  *NR0 + NY0*np.re
+00015390: 7065 6174 2869 6e64 5a30 2c59 306e 2920  peat(indZ0,Y0n) 
+000153a0: 2b5c 0a20 2020 2020 2020 2020 2020 2020  +\.             
+000153b0: 206e 702e 7469 6c65 2869 6e64 5930 2c5a   np.tile(indY0,Z
+000153c0: 306e 290a 2020 2020 2020 2020 2020 2020  0n).            
+000153d0: 696e 6469 6e20 3d20 5061 7468 2856 506f  indin = Path(VPo
+000153e0: 6c79 2e54 292e 636f 6e74 6169 6e73 5f70  ly.T).contains_p
+000153f0: 6f69 6e74 7328 7074 735b 313a 2c3a 5d2e  oints(pts[1:,:].
+00015400: 542c 0a20 2020 2020 2020 2020 2020 2020  T,.             
+00015410: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00015420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015440: 2020 2020 2020 2020 7261 6469 7573 3d30          radius=0
-00015450: 2e30 290a 2020 2020 2020 2020 2020 2020  .0).            
-00015460: 6966 206e 702e 616e 7928 696e 6469 6e29  if np.any(indin)
-00015470: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00015480: 2020 7074 7320 3d20 7074 735b 3a2c 696e    pts = pts[:,in
-00015490: 6469 6e5d 2e72 6573 6861 7065 2828 332c  din].reshape((3,
-000154a0: 3129 2920 6966 2069 6e64 696e 2e73 756d  1)) if indin.sum
-000154b0: 2829 3d3d 315c 0a20 2020 2020 2020 2020  ()==1\.         
-000154c0: 2020 2020 2020 2020 2065 6c73 6520 7074           else pt
-000154d0: 735b 3a2c 696e 6469 6e5d 0a20 2020 2020  s[:,indin].     
-000154e0: 2020 2020 2020 2020 2020 2050 7473 203d             Pts =
-000154f0: 206e 702e 636f 6e63 6174 656e 6174 6528   np.concatenate(
-00015500: 2850 7473 2c70 7473 292c 6178 6973 3d31  (Pts,pts),axis=1
-00015510: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00015520: 2020 696e 6420 3d20 6e70 2e63 6f6e 6361    ind = np.conca
-00015530: 7465 6e61 7465 2828 696e 642c 6969 6e64  tenate((ind,iind
-00015540: 5b69 6e64 696e 5d29 290a 2020 2020 2020  [indin])).      
-00015550: 2020 2020 2020 2020 2020 6453 203d 206e            dS = n
-00015560: 702e 636f 6e63 6174 656e 6174 6528 2864  p.concatenate((d
-00015570: 532c 6459 3072 2a64 5a30 722a 6e70 2e6f  S,dY0r*dZ0r*np.o
-00015580: 6e65 7328 2869 6e64 696e 2e73 756d 2829  nes((indin.sum()
-00015590: 2c29 2929 290a 0a20 2020 2065 6c73 653a  ,))))..    else:
-000155a0: 0a20 2020 2020 2020 2050 7473 2c20 6453  .        Pts, dS
-000155b0: 2c20 696e 642c 5c0a 2020 2020 2020 2020  , ind,\.        
-000155c0: 2020 4e4c 2c20 644c 722c 2052 7265 6620    NL, dLr, Rref 
-000155d0: 3d20 6e70 2e6f 6e65 7328 2833 2c30 2929  = np.ones((3,0))
-000155e0: 2c20 6e70 2e6f 6e65 7328 2830 2c29 292c  , np.ones((0,)),
-000155f0: 5c0a 2020 2020 2020 2020 2020 6e70 2e6f  \.          np.o
-00015600: 6e65 7328 2830 2c29 2c64 7479 7065 3d69  nes((0,),dtype=i
-00015610: 6e74 292c 206e 702e 6f6e 6573 2828 302c  nt), np.ones((0,
-00015620: 292c 6474 7970 653d 696e 7429 2c5c 0a20  ),dtype=int),\. 
-00015630: 2020 2020 2020 2020 206e 702e 6f6e 6573           np.ones
-00015640: 2828 302c 2929 2c20 6e70 2e6f 6e65 7328  ((0,)), np.ones(
-00015650: 2830 2c29 290a 2020 2020 2020 2020 6458  (0,)).        dX
-00015660: 722c 2064 5930 722c 2064 5a30 722c 2056  r, dY0r, dZ0r, V
-00015670: 5062 6973 203d 2030 2e2c 2030 2e2c 2030  Pbis = 0., 0., 0
-00015680: 2e2c 206e 702e 6f6e 6573 2828 332c 3029  ., np.ones((3,0)
-00015690: 290a 0a20 2020 2072 6574 7572 6e20 5074  )..    return Pt
-000156a0: 732c 2064 532c 2069 6e64 2c20 4e4c 2c20  s, dS, ind, NL, 
-000156b0: 644c 722c 2052 7265 662c 2064 5872 2c20  dLr, Rref, dXr, 
-000156c0: 6459 3072 2c20 645a 3072 2c20 5650 6269  dY0r, dZ0r, VPbi
-000156d0: 730a 0a0a 6465 6620 5f56 6573 5f53 6d65  s...def _Ves_Sme
-000156e0: 7368 5f4c 696e 5f53 7562 4672 6f6d 496e  sh_Lin_SubFromIn
-000156f0: 645f 6379 7468 6f6e 2864 6f75 626c 655b  d_cython(double[
-00015700: 3a3a 315d 2058 4d69 6e4d 6178 2c20 646f  ::1] XMinMax, do
-00015710: 7562 6c65 2064 4c2c 2064 6f75 626c 6520  uble dL, double 
-00015720: 6458 2c0a 2020 2020 2020 2020 2020 2020  dX,.            
-00015730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015740: 2020 2020 2020 2020 2064 6f75 626c 655b           double[
-00015750: 3a2c 3a3a 315d 2056 506f 6c79 2c0a 2020  :,::1] VPoly,.  
+00015430: 2020 2020 2074 7261 6e73 666f 726d 3d4e       transform=N
+00015440: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+00015450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015470: 2020 2020 2020 2072 6164 6975 733d 302e         radius=0.
+00015480: 3029 0a20 2020 2020 2020 2020 2020 2069  0).            i
+00015490: 6620 6e70 2e61 6e79 2869 6e64 696e 293a  f np.any(indin):
+000154a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000154b0: 2070 7473 203d 2070 7473 5b3a 2c69 6e64   pts = pts[:,ind
+000154c0: 696e 5d2e 7265 7368 6170 6528 2833 2c31  in].reshape((3,1
+000154d0: 2929 2069 6620 696e 6469 6e2e 7375 6d28  )) if indin.sum(
+000154e0: 293d 3d31 5c0a 2020 2020 2020 2020 2020  )==1\.          
+000154f0: 2020 2020 2020 2020 656c 7365 2070 7473          else pts
+00015500: 5b3a 2c69 6e64 696e 5d0a 2020 2020 2020  [:,indin].      
+00015510: 2020 2020 2020 2020 2020 5074 7320 3d20            Pts = 
+00015520: 6e70 2e63 6f6e 6361 7465 6e61 7465 2828  np.concatenate((
+00015530: 5074 732c 7074 7329 2c61 7869 733d 3129  Pts,pts),axis=1)
+00015540: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015550: 2069 6e64 203d 206e 702e 636f 6e63 6174   ind = np.concat
+00015560: 656e 6174 6528 2869 6e64 2c69 696e 645b  enate((ind,iind[
+00015570: 696e 6469 6e5d 2929 0a20 2020 2020 2020  indin])).       
+00015580: 2020 2020 2020 2020 2064 5320 3d20 6e70           dS = np
+00015590: 2e63 6f6e 6361 7465 6e61 7465 2828 6453  .concatenate((dS
+000155a0: 2c64 5930 722a 645a 3072 2a6e 702e 6f6e  ,dY0r*dZ0r*np.on
+000155b0: 6573 2828 696e 6469 6e2e 7375 6d28 292c  es((indin.sum(),
+000155c0: 2929 2929 0a0a 2020 2020 656c 7365 3a0a  ))))..    else:.
+000155d0: 2020 2020 2020 2020 5074 732c 2064 532c          Pts, dS,
+000155e0: 2069 6e64 2c5c 0a20 2020 2020 2020 2020   ind,\.         
+000155f0: 204e 4c2c 2064 4c72 2c20 5272 6566 203d   NL, dLr, Rref =
+00015600: 206e 702e 6f6e 6573 2828 332c 3029 292c   np.ones((3,0)),
+00015610: 206e 702e 6f6e 6573 2828 302c 2929 2c5c   np.ones((0,)),\
+00015620: 0a20 2020 2020 2020 2020 206e 702e 6f6e  .          np.on
+00015630: 6573 2828 302c 292c 6474 7970 653d 696e  es((0,),dtype=in
+00015640: 7429 2c20 6e70 2e6f 6e65 7328 2830 2c29  t), np.ones((0,)
+00015650: 2c64 7479 7065 3d69 6e74 292c 5c0a 2020  ,dtype=int),\.  
+00015660: 2020 2020 2020 2020 6e70 2e6f 6e65 7328          np.ones(
+00015670: 2830 2c29 292c 206e 702e 6f6e 6573 2828  (0,)), np.ones((
+00015680: 302c 2929 0a20 2020 2020 2020 2064 5872  0,)).        dXr
+00015690: 2c20 6459 3072 2c20 645a 3072 2c20 5650  , dY0r, dZ0r, VP
+000156a0: 6269 7320 3d20 302e 2c20 302e 2c20 302e  bis = 0., 0., 0.
+000156b0: 2c20 6e70 2e6f 6e65 7328 2833 2c30 2929  , np.ones((3,0))
+000156c0: 0a0a 2020 2020 7265 7475 726e 2050 7473  ..    return Pts
+000156d0: 2c20 6453 2c20 696e 642c 204e 4c2c 2064  , dS, ind, NL, d
+000156e0: 4c72 2c20 5272 6566 2c20 6458 722c 2064  Lr, Rref, dXr, d
+000156f0: 5930 722c 2064 5a30 722c 2056 5062 6973  Y0r, dZ0r, VPbis
+00015700: 0a0a 0a64 6566 205f 5665 735f 536d 6573  ...def _Ves_Smes
+00015710: 685f 4c69 6e5f 5375 6246 726f 6d49 6e64  h_Lin_SubFromInd
+00015720: 5f63 7974 686f 6e28 646f 7562 6c65 5b3a  _cython(double[:
+00015730: 3a31 5d20 584d 696e 4d61 782c 2064 6f75  :1] XMinMax, dou
+00015740: 626c 6520 644c 2c20 646f 7562 6c65 2064  ble dL, double d
+00015750: 582c 0a20 2020 2020 2020 2020 2020 2020  X,.             
 00015760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015780: 2020 206e 702e 6e64 6172 7261 795b 6c6f     np.ndarray[lo
-00015790: 6e67 2c6e 6469 6d3d 315d 2069 6e64 2c0a  ng,ndim=1] ind,.
+00015770: 2020 2020 2020 2020 646f 7562 6c65 5b3a          double[:
+00015780: 2c3a 3a31 5d20 5650 6f6c 792c 0a20 2020  ,::1] VPoly,.   
+00015790: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000157a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000157b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000157c0: 2020 2020 2064 6f75 626c 6520 4449 6e3d       double DIn=
-000157d0: 302e 2c20 5649 6e3d 4e6f 6e65 2c0a 2020  0., VIn=None,.  
+000157b0: 2020 6e70 2e6e 6461 7272 6179 5b6c 6f6e    np.ndarray[lon
+000157c0: 672c 6e64 696d 3d31 5d20 696e 642c 0a20  g,ndim=1] ind,. 
+000157d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000157e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000157f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015800: 2020 2064 6f75 626c 6520 6d61 7267 696e     double margin
-00015810: 3d5f 5653 4d41 4c4c 293a 0a20 2020 2022  =_VSMALL):.    "
-00015820: 2222 2052 6574 7572 6e20 7468 6520 6465  "" Return the de
-00015830: 7369 7265 6420 7375 7266 6163 6963 2073  sired surfacic s
-00015840: 7562 6d65 7368 2069 6e64 6963 6174 6564  ubmesh indicated
-00015850: 2062 7920 696e 642c 0a20 2020 2066 6f72   by ind,.    for
-00015860: 2074 6865 2064 6573 6972 6564 2072 6573   the desired res
-00015870: 6f6c 7574 696f 6e20 2864 582c 644c 2920  olution (dX,dL) 
-00015880: 2222 220a 2020 2020 6364 6566 2064 6f75  """.    cdef dou
-00015890: 626c 6520 6458 722c 2064 5930 722c 2064  ble dXr, dY0r, d
-000158a0: 5a30 720a 2020 2020 6364 6566 2069 6e74  Z0r.    cdef int
-000158b0: 204e 582c 204e 5930 2c20 4e5a 302c 204c   NX, NY0, NZ0, L
-000158c0: 6e2c 204e 5230 2c20 6e69 690a 2020 2020  n, NR0, nii.    
-000158d0: 6364 6566 206c 6973 7420 4c50 7473 2c20  cdef list LPts, 
-000158e0: 4c64 530a 2020 2020 6364 6566 206e 702e  LdS.    cdef np.
-000158f0: 6e64 6172 7261 795b 646f 7562 6c65 2c6e  ndarray[double,n
-00015900: 6469 6d3d 325d 2050 7473 2c20 5074 7343  dim=2] Pts, PtsC
-00015910: 726f 7373 2c20 5650 6269 730a 2020 2020  ross, VPbis.    
-00015920: 6364 6566 206e 702e 6e64 6172 7261 795b  cdef np.ndarray[
-00015930: 646f 7562 6c65 2c6e 6469 6d3d 315d 2058  double,ndim=1] X
-00015940: 2c20 5930 2c20 5a30 2c20 6453 2c20 644c  , Y0, Z0, dS, dL
-00015950: 722c 2052 7265 660a 2020 2020 6364 6566  r, Rref.    cdef
-00015960: 206e 702e 6e64 6172 7261 795b 6c6f 6e67   np.ndarray[long
-00015970: 2c6e 6469 6d3d 315d 2069 6e64 582c 2069  ,ndim=1] indX, i
-00015980: 6e64 5930 2c20 696e 645a 302c 2069 6e64  ndY0, indZ0, ind
-00015990: 4c2c 204e 4c2c 2069 690a 0a20 2020 2023  L, NL, ii..    #
-000159a0: 2047 6574 2074 6865 206d 6573 6820 666f   Get the mesh fo
-000159b0: 7220 7468 6520 6661 6365 730a 2020 2020  r the faces.    
-000159c0: 5930 2c20 6459 3072 2c20 5f2c 204e 5930  Y0, dY0r, _, NY0
-000159d0: 203d 2064 6973 6372 6574 697a 655f 6c69   = discretize_li
-000159e0: 6e65 3164 286e 702e 6172 7261 7928 5b6e  ne1d(np.array([n
-000159f0: 702e 6d69 6e28 5650 6f6c 795b 302c 203a  p.min(VPoly[0, :
-00015a00: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
-00015a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015a30: 2020 2020 2020 206e 702e 6d61 7828 5650         np.max(VP
-00015a40: 6f6c 795b 302c 3a5d 295d 292c 0a20 2020  oly[0,:])]),.   
+000157f0: 2020 2020 646f 7562 6c65 2044 496e 3d30      double DIn=0
+00015800: 2e2c 2056 496e 3d4e 6f6e 652c 0a20 2020  ., VIn=None,.   
+00015810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015830: 2020 646f 7562 6c65 206d 6172 6769 6e3d    double margin=
+00015840: 5f56 534d 414c 4c29 3a0a 2020 2020 2222  _VSMALL):.    ""
+00015850: 2220 5265 7475 726e 2074 6865 2064 6573  " Return the des
+00015860: 6972 6564 2073 7572 6661 6369 6320 7375  ired surfacic su
+00015870: 626d 6573 6820 696e 6469 6361 7465 6420  bmesh indicated 
+00015880: 6279 2069 6e64 2c0a 2020 2020 666f 7220  by ind,.    for 
+00015890: 7468 6520 6465 7369 7265 6420 7265 736f  the desired reso
+000158a0: 6c75 7469 6f6e 2028 6458 2c64 4c29 2022  lution (dX,dL) "
+000158b0: 2222 0a20 2020 2063 6465 6620 646f 7562  "".    cdef doub
+000158c0: 6c65 2064 5872 2c20 6459 3072 2c20 645a  le dXr, dY0r, dZ
+000158d0: 3072 0a20 2020 2063 6465 6620 696e 7420  0r.    cdef int 
+000158e0: 4e58 2c20 4e59 302c 204e 5a30 2c20 4c6e  NX, NY0, NZ0, Ln
+000158f0: 2c20 4e52 302c 206e 6969 0a20 2020 2063  , NR0, nii.    c
+00015900: 6465 6620 6c69 7374 204c 5074 732c 204c  def list LPts, L
+00015910: 6453 0a20 2020 2063 6465 6620 6e70 2e6e  dS.    cdef np.n
+00015920: 6461 7272 6179 5b64 6f75 626c 652c 6e64  darray[double,nd
+00015930: 696d 3d32 5d20 5074 732c 2050 7473 4372  im=2] Pts, PtsCr
+00015940: 6f73 732c 2056 5062 6973 0a20 2020 2063  oss, VPbis.    c
+00015950: 6465 6620 6e70 2e6e 6461 7272 6179 5b64  def np.ndarray[d
+00015960: 6f75 626c 652c 6e64 696d 3d31 5d20 582c  ouble,ndim=1] X,
+00015970: 2059 302c 205a 302c 2064 532c 2064 4c72   Y0, Z0, dS, dLr
+00015980: 2c20 5272 6566 0a20 2020 2063 6465 6620  , Rref.    cdef 
+00015990: 6e70 2e6e 6461 7272 6179 5b6c 6f6e 672c  np.ndarray[long,
+000159a0: 6e64 696d 3d31 5d20 696e 6458 2c20 696e  ndim=1] indX, in
+000159b0: 6459 302c 2069 6e64 5a30 2c20 696e 644c  dY0, indZ0, indL
+000159c0: 2c20 4e4c 2c20 6969 0a0a 2020 2020 2320  , NL, ii..    # 
+000159d0: 4765 7420 7468 6520 6d65 7368 2066 6f72  Get the mesh for
+000159e0: 2074 6865 2066 6163 6573 0a20 2020 2059   the faces.    Y
+000159f0: 302c 2064 5930 722c 205f 2c20 4e59 3020  0, dY0r, _, NY0 
+00015a00: 3d20 6469 7363 7265 7469 7a65 5f6c 696e  = discretize_lin
+00015a10: 6531 6428 6e70 2e61 7272 6179 285b 6e70  e1d(np.array([np
+00015a20: 2e6d 696e 2856 506f 6c79 5b30 2c20 3a5d  .min(VPoly[0, :]
+00015a30: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00015a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00015a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015a70: 2020 2020 2020 644c 2c20 444c 3d4e 6f6e        dL, DL=Non
-00015a80: 652c 204c 696d 3d54 7275 652c 206d 6172  e, Lim=True, mar
-00015a90: 6769 6e3d 6d61 7267 696e 290a 2020 2020  gin=margin).    
-00015aa0: 5a30 2c20 645a 3072 2c20 5f2c 204e 5a30  Z0, dZ0r, _, NZ0
-00015ab0: 203d 2064 6973 6372 6574 697a 655f 6c69   = discretize_li
-00015ac0: 6e65 3164 286e 702e 6172 7261 7928 5b6e  ne1d(np.array([n
-00015ad0: 702e 6d69 6e28 5650 6f6c 795b 312c 203a  p.min(VPoly[1, :
-00015ae0: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
-00015af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015b10: 2020 2020 2020 206e 702e 6d61 7828 5650         np.max(VP
-00015b20: 6f6c 795b 312c 3a5d 295d 292c 0a20 2020  oly[1,:])]),.   
+00015a60: 2020 2020 2020 6e70 2e6d 6178 2856 506f        np.max(VPo
+00015a70: 6c79 5b30 2c3a 5d29 5d29 2c0a 2020 2020  ly[0,:])]),.    
+00015a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015aa0: 2020 2020 2064 4c2c 2044 4c3d 4e6f 6e65       dL, DL=None
+00015ab0: 2c20 4c69 6d3d 5472 7565 2c20 6d61 7267  , Lim=True, marg
+00015ac0: 696e 3d6d 6172 6769 6e29 0a20 2020 205a  in=margin).    Z
+00015ad0: 302c 2064 5a30 722c 205f 2c20 4e5a 3020  0, dZ0r, _, NZ0 
+00015ae0: 3d20 6469 7363 7265 7469 7a65 5f6c 696e  = discretize_lin
+00015af0: 6531 6428 6e70 2e61 7272 6179 285b 6e70  e1d(np.array([np
+00015b00: 2e6d 696e 2856 506f 6c79 5b31 2c20 3a5d  .min(VPoly[1, :]
+00015b10: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00015b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00015b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015b50: 2020 2020 2020 644c 2c20 444c 3d4e 6f6e        dL, DL=Non
-00015b60: 652c 204c 696d 3d54 7275 652c 206d 6172  e, Lim=True, mar
-00015b70: 6769 6e3d 6d61 7267 696e 290a 0a20 2020  gin=margin)..   
-00015b80: 2023 2047 6574 2074 6865 2061 6374 7561   # Get the actua
-00015b90: 6c20 5220 616e 6420 5a20 7265 736f 6c75  l R and Z resolu
-00015ba0: 7469 6f6e 7320 616e 6420 6d65 7368 2065  tions and mesh e
-00015bb0: 6c65 6d65 6e74 730a 2020 2020 582c 2064  lements.    X, d
-00015bc0: 5872 2c20 5f2c 204e 5820 3d20 6469 7363  Xr, _, NX = disc
-00015bd0: 7265 7469 7a65 5f6c 696e 6531 6428 584d  retize_line1d(XM
-00015be0: 696e 4d61 782c 2064 582c 0a20 2020 2020  inMax, dX,.     
-00015bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015c10: 2044 4c3d 4e6f 6e65 2c20 4c69 6d3d 5472   DL=None, Lim=Tr
-00015c20: 7565 2c20 6d61 7267 696e 3d6d 6172 6769  ue, margin=margi
-00015c30: 6e29 0a20 2020 2050 7473 4372 6f73 732c  n).    PtsCross,
-00015c40: 2064 4c72 2c20 5f2c 204e 4c2c 2052 7265   dLr, _, NL, Rre
-00015c50: 662c 2056 5062 6973 203d 2064 6973 6372  f, VPbis = discr
-00015c60: 6574 697a 655f 7670 6f6c 7928 5650 6f6c  etize_vpoly(VPol
-00015c70: 792c 2064 4c2c 0a20 2020 2020 2020 2020  y, dL,.         
-00015c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015cb0: 2020 4431 3d4e 6f6e 652c 2044 323d 4e6f    D1=None, D2=No
-00015cc0: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+00015b40: 2020 2020 2020 6e70 2e6d 6178 2856 506f        np.max(VPo
+00015b50: 6c79 5b31 2c3a 5d29 5d29 2c0a 2020 2020  ly[1,:])]),.    
+00015b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015b80: 2020 2020 2064 4c2c 2044 4c3d 4e6f 6e65       dL, DL=None
+00015b90: 2c20 4c69 6d3d 5472 7565 2c20 6d61 7267  , Lim=True, marg
+00015ba0: 696e 3d6d 6172 6769 6e29 0a0a 2020 2020  in=margin)..    
+00015bb0: 2320 4765 7420 7468 6520 6163 7475 616c  # Get the actual
+00015bc0: 2052 2061 6e64 205a 2072 6573 6f6c 7574   R and Z resolut
+00015bd0: 696f 6e73 2061 6e64 206d 6573 6820 656c  ions and mesh el
+00015be0: 656d 656e 7473 0a20 2020 2058 2c20 6458  ements.    X, dX
+00015bf0: 722c 205f 2c20 4e58 203d 2064 6973 6372  r, _, NX = discr
+00015c00: 6574 697a 655f 6c69 6e65 3164 2858 4d69  etize_line1d(XMi
+00015c10: 6e4d 6178 2c20 6458 2c0a 2020 2020 2020  nMax, dX,.      
+00015c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015c40: 444c 3d4e 6f6e 652c 204c 696d 3d54 7275  DL=None, Lim=Tru
+00015c50: 652c 206d 6172 6769 6e3d 6d61 7267 696e  e, margin=margin
+00015c60: 290a 2020 2020 5074 7343 726f 7373 2c20  ).    PtsCross, 
+00015c70: 644c 722c 205f 2c20 4e4c 2c20 5272 6566  dLr, _, NL, Rref
+00015c80: 2c20 5650 6269 7320 3d20 6469 7363 7265  , VPbis = discre
+00015c90: 7469 7a65 5f76 706f 6c79 2856 506f 6c79  tize_vpoly(VPoly
+00015ca0: 2c20 644c 2c0a 2020 2020 2020 2020 2020  , dL,.          
+00015cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00015cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015cf0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00015d00: 6172 6769 6e3d 6d61 7267 696e 2c0a 2020  argin=margin,.  
+00015ce0: 2044 313d 4e6f 6e65 2c20 4432 3d4e 6f6e   D1=None, D2=Non
+00015cf0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00015d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00015d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015d40: 2020 2020 2020 2020 2044 496e 3d44 496e           DIn=DIn
-00015d50: 2c20 5649 6e3d 5649 6e29 0a20 2020 204c  , VIn=VIn).    L
-00015d60: 6e20 3d20 5074 7343 726f 7373 2e73 6861  n = PtsCross.sha
-00015d70: 7065 5b31 5d0a 0a20 2020 204c 5074 732c  pe[1]..    LPts,
-00015d80: 204c 6453 203d 205b 5d2c 205b 5d0a 2020   LdS = [], [].  
-00015d90: 2020 2320 4669 7273 7420 6661 6365 0a20    # First face. 
-00015da0: 2020 2069 6920 3d20 2869 6e64 3c4e 5930     ii = (ind<NY0
-00015db0: 2a4e 5a30 292e 6e6f 6e7a 6572 6f28 295b  *NZ0).nonzero()[
-00015dc0: 305d 2e61 7374 7970 6528 696e 7429 0a20  0].astype(int). 
-00015dd0: 2020 206e 6969 203d 206c 656e 2869 6929     nii = len(ii)
-00015de0: 0a20 2020 2069 6620 6e69 693e 303a 0a20  .    if nii>0:. 
-00015df0: 2020 2020 2020 2069 6e64 5a30 203d 2069         indZ0 = i
-00015e00: 6e64 5b69 695d 202f 2f20 4e59 300a 2020  nd[ii] // NY0.  
-00015e10: 2020 2020 2020 696e 6459 3020 3d20 2869        indY0 = (i
-00015e20: 6e64 5b69 695d 2d69 6e64 5a30 2a4e 5930  nd[ii]-indZ0*NY0
-00015e30: 290a 2020 2020 2020 2020 6966 206e 6969  ).        if nii
-00015e40: 3d3d 313a 0a20 2020 2020 2020 2020 2020  ==1:.           
-00015e50: 204c 5074 732e 6170 7065 6e64 2820 6e70   LPts.append( np
-00015e60: 2e61 7272 6179 285b 5b58 4d69 6e4d 6178  .array([[XMinMax
-00015e70: 5b30 5d20 2b20 4449 6e5d 2c0a 2020 2020  [0] + DIn],.    
-00015e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015e90: 2020 2020 2020 2020 2020 2020 2020 205b                 [
-00015ea0: 5930 5b69 6e64 5930 5d5d 2c20 5b5a 305b  Y0[indY0]], [Z0[
-00015eb0: 696e 645a 305d 5d5d 2920 290a 2020 2020  indZ0]]]) ).    
-00015ec0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00015ed0: 2020 2020 2020 4c50 7473 2e61 7070 656e        LPts.appen
-00015ee0: 6428 206e 702e 6172 7261 7928 5b28 584d  d( np.array([(XM
-00015ef0: 696e 4d61 785b 305d 202b 2044 496e 292a  inMax[0] + DIn)*
-00015f00: 6e70 2e6f 6e65 7328 286e 6969 2c29 292c  np.ones((nii,)),
-00015f10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015f30: 2020 2020 5930 5b69 6e64 5930 5d2c 205a      Y0[indY0], Z
-00015f40: 305b 696e 645a 305d 5d29 2029 0a20 2020  0[indZ0]]) ).   
-00015f50: 2020 2020 204c 6453 2e61 7070 656e 6428       LdS.append(
-00015f60: 2064 5930 722a 645a 3072 2a6e 702e 6f6e   dY0r*dZ0r*np.on
-00015f70: 6573 2828 6e69 692c 2929 2029 0a0a 2020  es((nii,)) )..  
-00015f80: 2020 2320 4379 6c69 6e64 6572 0a20 2020    # Cylinder.   
-00015f90: 2069 6920 3d20 2828 696e 643e 3d4e 5930   ii = ((ind>=NY0
-00015fa0: 2a4e 5a30 2920 2620 2869 6e64 3c4e 5930  *NZ0) & (ind<NY0
-00015fb0: 2a4e 5a30 2b4e 582a 4c6e 2929 2e6e 6f6e  *NZ0+NX*Ln)).non
-00015fc0: 7a65 726f 2829 5b30 5d2e 6173 7479 7065  zero()[0].astype
-00015fd0: 2869 6e74 290a 2020 2020 6e69 6920 3d20  (int).    nii = 
-00015fe0: 6c65 6e28 6969 290a 2020 2020 6966 206e  len(ii).    if n
-00015ff0: 6969 3e30 3a0a 2020 2020 2020 2020 696e  ii>0:.        in
-00016000: 6458 203d 2028 696e 645b 6969 5d2d 4e59  dX = (ind[ii]-NY
-00016010: 302a 4e5a 3029 202f 2f20 4c6e 0a20 2020  0*NZ0) // Ln.   
-00016020: 2020 2020 2069 6e64 4c20 3d20 2869 6e64       indL = (ind
-00016030: 5b69 695d 2d4e 5930 2a4e 5a30 202d 204c  [ii]-NY0*NZ0 - L
-00016040: 6e2a 696e 6458 290a 2020 2020 2020 2020  n*indX).        
-00016050: 6966 206e 6969 3d3d 313a 0a20 2020 2020  if nii==1:.     
-00016060: 2020 2020 2020 204c 5074 732e 6170 7065         LPts.appe
-00016070: 6e64 2820 6e70 2e61 7272 6179 285b 5b58  nd( np.array([[X
-00016080: 5b69 6e64 585d 5d2c 0a20 2020 2020 2020  [indX]],.       
-00016090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000160a0: 2020 2020 2020 2020 2020 2020 5b50 7473              [Pts
-000160b0: 4372 6f73 735b 302c 696e 644c 5d5d 2c20  Cross[0,indL]], 
-000160c0: 5b50 7473 4372 6f73 735b 312c 696e 644c  [PtsCross[1,indL
-000160d0: 5d5d 5d29 2029 0a20 2020 2020 2020 2020  ]]]) ).         
-000160e0: 2020 204c 6453 2e61 7070 656e 6428 206e     LdS.append( n
-000160f0: 702e 6172 7261 7928 5b64 5872 2a64 4c72  p.array([dXr*dLr
-00016100: 5b69 6e64 4c5d 5d29 2029 0a20 2020 2020  [indL]]) ).     
-00016110: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00016120: 2020 2020 204c 5074 732e 6170 7065 6e64       LPts.append
-00016130: 2820 6e70 2e61 7272 6179 285b 585b 696e  ( np.array([X[in
-00016140: 6458 5d2c 0a20 2020 2020 2020 2020 2020  dX],.           
-00016150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016160: 2020 2020 2020 2020 5074 7343 726f 7373          PtsCross
-00016170: 5b30 2c69 6e64 4c5d 2c20 5074 7343 726f  [0,indL], PtsCro
-00016180: 7373 5b31 2c69 6e64 4c5d 5d29 2029 0a20  ss[1,indL]]) ). 
-00016190: 2020 2020 2020 2020 2020 204c 6453 2e61             LdS.a
-000161a0: 7070 656e 6428 2064 5872 2a64 4c72 5b69  ppend( dXr*dLr[i
-000161b0: 6e64 4c5d 2029 0a0a 2020 2020 2320 456e  ndL] )..    # En
-000161c0: 6420 6661 6365 0a20 2020 2069 6920 3d20  d face.    ii = 
-000161d0: 2869 6e64 203e 3d20 4e59 302a 4e5a 302b  (ind >= NY0*NZ0+
-000161e0: 4e58 2a4c 6e29 2e6e 6f6e 7a65 726f 2829  NX*Ln).nonzero()
-000161f0: 5b30 5d2e 6173 7479 7065 2869 6e74 290a  [0].astype(int).
-00016200: 2020 2020 6e69 6920 3d20 6c65 6e28 6969      nii = len(ii
-00016210: 290a 2020 2020 6966 206e 6969 3e30 3a0a  ).    if nii>0:.
-00016220: 2020 2020 2020 2020 696e 645a 3020 3d20          indZ0 = 
-00016230: 2869 6e64 5b69 695d 2d4e 5930 2a4e 5a30  (ind[ii]-NY0*NZ0
-00016240: 2d4e 582a 4c6e 2920 2f2f 204e 5930 0a20  -NX*Ln) // NY0. 
-00016250: 2020 2020 2020 2069 6e64 5930 203d 2069         indY0 = i
-00016260: 6e64 5b69 695d 2d4e 5930 2a4e 5a30 2d4e  nd[ii]-NY0*NZ0-N
-00016270: 582a 4c6e 202d 204e 5930 2a69 6e64 5a30  X*Ln - NY0*indZ0
-00016280: 0a20 2020 2020 2020 2069 6620 6e69 693d  .        if nii=
-00016290: 3d31 3a0a 2020 2020 2020 2020 2020 2020  =1:.            
-000162a0: 4c50 7473 2e61 7070 656e 6428 206e 702e  LPts.append( np.
-000162b0: 6172 7261 7928 5b5b 584d 696e 4d61 785b  array([[XMinMax[
-000162c0: 315d 202d 2044 496e 5d2c 0a20 2020 2020  1] - DIn],.     
-000162d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000162e0: 2020 2020 2020 2020 2020 2020 2020 5b59                [Y
-000162f0: 305b 696e 6459 305d 5d2c 205b 5a30 5b69  0[indY0]], [Z0[i
-00016300: 6e64 5a30 5d5d 5d29 2029 0a20 2020 2020  ndZ0]]]) ).     
-00016310: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00016320: 2020 2020 204c 5074 732e 6170 7065 6e64       LPts.append
-00016330: 2820 6e70 2e61 7272 6179 285b 2858 4d69  ( np.array([(XMi
-00016340: 6e4d 6178 5b31 5d20 2d20 4449 6e29 2a6e  nMax[1] - DIn)*n
-00016350: 702e 6f6e 6573 2828 6e69 692c 2929 2c0a  p.ones((nii,)),.
-00016360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016380: 2020 2059 305b 696e 6459 305d 2c20 5a30     Y0[indY0], Z0
-00016390: 5b69 6e64 5a30 5d5d 2920 290a 2020 2020  [indZ0]]) ).    
-000163a0: 2020 2020 4c64 532e 6170 7065 6e64 2820      LdS.append( 
-000163b0: 6459 3072 2a64 5a30 722a 6e70 2e6f 6e65  dY0r*dZ0r*np.one
-000163c0: 7328 286e 6969 2c29 2920 290a 0a20 2020  s((nii,)) )..   
-000163d0: 2023 2046 6f72 6d61 7420 6f75 7470 7574   # Format output
-000163e0: 0a20 2020 2069 6620 6c65 6e28 4c50 7473  .    if len(LPts
-000163f0: 293d 3d31 3a0a 2020 2020 2020 2020 5074  )==1:.        Pt
-00016400: 732c 2064 5320 3d20 4c50 7473 5b30 5d2c  s, dS = LPts[0],
-00016410: 204c 6453 5b30 5d0a 2020 2020 656c 7365   LdS[0].    else
-00016420: 3a0a 2020 2020 2020 2020 5074 7320 3d20  :.        Pts = 
-00016430: 6e70 2e63 6f6e 6361 7465 6e61 7465 2874  np.concatenate(t
-00016440: 7570 6c65 284c 5074 7329 2c61 7869 733d  uple(LPts),axis=
-00016450: 3129 0a20 2020 2020 2020 2064 5320 3d20  1).        dS = 
-00016460: 6e70 2e63 6f6e 6361 7465 6e61 7465 2874  np.concatenate(t
-00016470: 7570 6c65 284c 6453 2929 0a0a 2020 2020  uple(LdS))..    
-00016480: 7265 7475 726e 2050 7473 2c20 6453 2c20  return Pts, dS, 
-00016490: 4e4c 2c20 644c 722c 2052 7265 662c 2064  NL, dLr, Rref, d
-000164a0: 5872 2c20 6459 3072 2c20 645a 3072 2c20  Xr, dY0r, dZ0r, 
-000164b0: 5650 6269 730a 0a0a 0a0a 2222 220a 2323  VPbis.....""".##
-000164c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000164d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000164e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000164f0: 2323 2323 2323 0a23 2323 2323 2323 2323  ######.#########
+00015d20: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
+00015d30: 7267 696e 3d6d 6172 6769 6e2c 0a20 2020  rgin=margin,.   
+00015d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015d70: 2020 2020 2020 2020 4449 6e3d 4449 6e2c          DIn=DIn,
+00015d80: 2056 496e 3d56 496e 290a 2020 2020 4c6e   VIn=VIn).    Ln
+00015d90: 203d 2050 7473 4372 6f73 732e 7368 6170   = PtsCross.shap
+00015da0: 655b 315d 0a0a 2020 2020 4c50 7473 2c20  e[1]..    LPts, 
+00015db0: 4c64 5320 3d20 5b5d 2c20 5b5d 0a20 2020  LdS = [], [].   
+00015dc0: 2023 2046 6972 7374 2066 6163 650a 2020   # First face.  
+00015dd0: 2020 6969 203d 2028 696e 643c 4e59 302a    ii = (ind<NY0*
+00015de0: 4e5a 3029 2e6e 6f6e 7a65 726f 2829 5b30  NZ0).nonzero()[0
+00015df0: 5d2e 6173 7479 7065 2869 6e74 290a 2020  ].astype(int).  
+00015e00: 2020 6e69 6920 3d20 6c65 6e28 6969 290a    nii = len(ii).
+00015e10: 2020 2020 6966 206e 6969 3e30 3a0a 2020      if nii>0:.  
+00015e20: 2020 2020 2020 696e 645a 3020 3d20 696e        indZ0 = in
+00015e30: 645b 6969 5d20 2f2f 204e 5930 0a20 2020  d[ii] // NY0.   
+00015e40: 2020 2020 2069 6e64 5930 203d 2028 696e       indY0 = (in
+00015e50: 645b 6969 5d2d 696e 645a 302a 4e59 3029  d[ii]-indZ0*NY0)
+00015e60: 0a20 2020 2020 2020 2069 6620 6e69 693d  .        if nii=
+00015e70: 3d31 3a0a 2020 2020 2020 2020 2020 2020  =1:.            
+00015e80: 4c50 7473 2e61 7070 656e 6428 206e 702e  LPts.append( np.
+00015e90: 6172 7261 7928 5b5b 584d 696e 4d61 785b  array([[XMinMax[
+00015ea0: 305d 202b 2044 496e 5d2c 0a20 2020 2020  0] + DIn],.     
+00015eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015ec0: 2020 2020 2020 2020 2020 2020 2020 5b59                [Y
+00015ed0: 305b 696e 6459 305d 5d2c 205b 5a30 5b69  0[indY0]], [Z0[i
+00015ee0: 6e64 5a30 5d5d 5d29 2029 0a20 2020 2020  ndZ0]]]) ).     
+00015ef0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00015f00: 2020 2020 204c 5074 732e 6170 7065 6e64       LPts.append
+00015f10: 2820 6e70 2e61 7272 6179 285b 2858 4d69  ( np.array([(XMi
+00015f20: 6e4d 6178 5b30 5d20 2b20 4449 6e29 2a6e  nMax[0] + DIn)*n
+00015f30: 702e 6f6e 6573 2828 6e69 692c 2929 2c0a  p.ones((nii,)),.
+00015f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015f60: 2020 2059 305b 696e 6459 305d 2c20 5a30     Y0[indY0], Z0
+00015f70: 5b69 6e64 5a30 5d5d 2920 290a 2020 2020  [indZ0]]) ).    
+00015f80: 2020 2020 4c64 532e 6170 7065 6e64 2820      LdS.append( 
+00015f90: 6459 3072 2a64 5a30 722a 6e70 2e6f 6e65  dY0r*dZ0r*np.one
+00015fa0: 7328 286e 6969 2c29 2920 290a 0a20 2020  s((nii,)) )..   
+00015fb0: 2023 2043 796c 696e 6465 720a 2020 2020   # Cylinder.    
+00015fc0: 6969 203d 2028 2869 6e64 3e3d 4e59 302a  ii = ((ind>=NY0*
+00015fd0: 4e5a 3029 2026 2028 696e 643c 4e59 302a  NZ0) & (ind<NY0*
+00015fe0: 4e5a 302b 4e58 2a4c 6e29 292e 6e6f 6e7a  NZ0+NX*Ln)).nonz
+00015ff0: 6572 6f28 295b 305d 2e61 7374 7970 6528  ero()[0].astype(
+00016000: 696e 7429 0a20 2020 206e 6969 203d 206c  int).    nii = l
+00016010: 656e 2869 6929 0a20 2020 2069 6620 6e69  en(ii).    if ni
+00016020: 693e 303a 0a20 2020 2020 2020 2069 6e64  i>0:.        ind
+00016030: 5820 3d20 2869 6e64 5b69 695d 2d4e 5930  X = (ind[ii]-NY0
+00016040: 2a4e 5a30 2920 2f2f 204c 6e0a 2020 2020  *NZ0) // Ln.    
+00016050: 2020 2020 696e 644c 203d 2028 696e 645b      indL = (ind[
+00016060: 6969 5d2d 4e59 302a 4e5a 3020 2d20 4c6e  ii]-NY0*NZ0 - Ln
+00016070: 2a69 6e64 5829 0a20 2020 2020 2020 2069  *indX).        i
+00016080: 6620 6e69 693d 3d31 3a0a 2020 2020 2020  f nii==1:.      
+00016090: 2020 2020 2020 4c50 7473 2e61 7070 656e        LPts.appen
+000160a0: 6428 206e 702e 6172 7261 7928 5b5b 585b  d( np.array([[X[
+000160b0: 696e 6458 5d5d 2c0a 2020 2020 2020 2020  indX]],.        
+000160c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000160d0: 2020 2020 2020 2020 2020 205b 5074 7343             [PtsC
+000160e0: 726f 7373 5b30 2c69 6e64 4c5d 5d2c 205b  ross[0,indL]], [
+000160f0: 5074 7343 726f 7373 5b31 2c69 6e64 4c5d  PtsCross[1,indL]
+00016100: 5d5d 2920 290a 2020 2020 2020 2020 2020  ]]) ).          
+00016110: 2020 4c64 532e 6170 7065 6e64 2820 6e70    LdS.append( np
+00016120: 2e61 7272 6179 285b 6458 722a 644c 725b  .array([dXr*dLr[
+00016130: 696e 644c 5d5d 2920 290a 2020 2020 2020  indL]]) ).      
+00016140: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00016150: 2020 2020 4c50 7473 2e61 7070 656e 6428      LPts.append(
+00016160: 206e 702e 6172 7261 7928 5b58 5b69 6e64   np.array([X[ind
+00016170: 585d 2c0a 2020 2020 2020 2020 2020 2020  X],.            
+00016180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016190: 2020 2020 2020 2050 7473 4372 6f73 735b         PtsCross[
+000161a0: 302c 696e 644c 5d2c 2050 7473 4372 6f73  0,indL], PtsCros
+000161b0: 735b 312c 696e 644c 5d5d 2920 290a 2020  s[1,indL]]) ).  
+000161c0: 2020 2020 2020 2020 2020 4c64 532e 6170            LdS.ap
+000161d0: 7065 6e64 2820 6458 722a 644c 725b 696e  pend( dXr*dLr[in
+000161e0: 644c 5d20 290a 0a20 2020 2023 2045 6e64  dL] )..    # End
+000161f0: 2066 6163 650a 2020 2020 6969 203d 2028   face.    ii = (
+00016200: 696e 6420 3e3d 204e 5930 2a4e 5a30 2b4e  ind >= NY0*NZ0+N
+00016210: 582a 4c6e 292e 6e6f 6e7a 6572 6f28 295b  X*Ln).nonzero()[
+00016220: 305d 2e61 7374 7970 6528 696e 7429 0a20  0].astype(int). 
+00016230: 2020 206e 6969 203d 206c 656e 2869 6929     nii = len(ii)
+00016240: 0a20 2020 2069 6620 6e69 693e 303a 0a20  .    if nii>0:. 
+00016250: 2020 2020 2020 2069 6e64 5a30 203d 2028         indZ0 = (
+00016260: 696e 645b 6969 5d2d 4e59 302a 4e5a 302d  ind[ii]-NY0*NZ0-
+00016270: 4e58 2a4c 6e29 202f 2f20 4e59 300a 2020  NX*Ln) // NY0.  
+00016280: 2020 2020 2020 696e 6459 3020 3d20 696e        indY0 = in
+00016290: 645b 6969 5d2d 4e59 302a 4e5a 302d 4e58  d[ii]-NY0*NZ0-NX
+000162a0: 2a4c 6e20 2d20 4e59 302a 696e 645a 300a  *Ln - NY0*indZ0.
+000162b0: 2020 2020 2020 2020 6966 206e 6969 3d3d          if nii==
+000162c0: 313a 0a20 2020 2020 2020 2020 2020 204c  1:.            L
+000162d0: 5074 732e 6170 7065 6e64 2820 6e70 2e61  Pts.append( np.a
+000162e0: 7272 6179 285b 5b58 4d69 6e4d 6178 5b31  rray([[XMinMax[1
+000162f0: 5d20 2d20 4449 6e5d 2c0a 2020 2020 2020  ] - DIn],.      
+00016300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016310: 2020 2020 2020 2020 2020 2020 205b 5930               [Y0
+00016320: 5b69 6e64 5930 5d5d 2c20 5b5a 305b 696e  [indY0]], [Z0[in
+00016330: 645a 305d 5d5d 2920 290a 2020 2020 2020  dZ0]]]) ).      
+00016340: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00016350: 2020 2020 4c50 7473 2e61 7070 656e 6428      LPts.append(
+00016360: 206e 702e 6172 7261 7928 5b28 584d 696e   np.array([(XMin
+00016370: 4d61 785b 315d 202d 2044 496e 292a 6e70  Max[1] - DIn)*np
+00016380: 2e6f 6e65 7328 286e 6969 2c29 292c 0a20  .ones((nii,)),. 
+00016390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000163a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000163b0: 2020 5930 5b69 6e64 5930 5d2c 205a 305b    Y0[indY0], Z0[
+000163c0: 696e 645a 305d 5d29 2029 0a20 2020 2020  indZ0]]) ).     
+000163d0: 2020 204c 6453 2e61 7070 656e 6428 2064     LdS.append( d
+000163e0: 5930 722a 645a 3072 2a6e 702e 6f6e 6573  Y0r*dZ0r*np.ones
+000163f0: 2828 6e69 692c 2929 2029 0a0a 2020 2020  ((nii,)) )..    
+00016400: 2320 466f 726d 6174 206f 7574 7075 740a  # Format output.
+00016410: 2020 2020 6966 206c 656e 284c 5074 7329      if len(LPts)
+00016420: 3d3d 313a 0a20 2020 2020 2020 2050 7473  ==1:.        Pts
+00016430: 2c20 6453 203d 204c 5074 735b 305d 2c20  , dS = LPts[0], 
+00016440: 4c64 535b 305d 0a20 2020 2065 6c73 653a  LdS[0].    else:
+00016450: 0a20 2020 2020 2020 2050 7473 203d 206e  .        Pts = n
+00016460: 702e 636f 6e63 6174 656e 6174 6528 7475  p.concatenate(tu
+00016470: 706c 6528 4c50 7473 292c 6178 6973 3d31  ple(LPts),axis=1
+00016480: 290a 2020 2020 2020 2020 6453 203d 206e  ).        dS = n
+00016490: 702e 636f 6e63 6174 656e 6174 6528 7475  p.concatenate(tu
+000164a0: 706c 6528 4c64 5329 290a 0a20 2020 2072  ple(LdS))..    r
+000164b0: 6574 7572 6e20 5074 732c 2064 532c 204e  eturn Pts, dS, N
+000164c0: 4c2c 2064 4c72 2c20 5272 6566 2c20 6458  L, dLr, Rref, dX
+000164d0: 722c 2064 5930 722c 2064 5a30 722c 2056  r, dY0r, dZ0r, V
+000164e0: 5062 6973 0a0a 0a0a 0a22 2222 0a23 2323  Pbis.....""".###
+000164f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00016500: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00016510: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00016520: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
+00016520: 2323 2323 230a 2323 2323 2323 2323 2323  #####.##########
 00016530: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00016540: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00016550: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00016560: 2323 2323 2323 2323 0a23 2020 2020 2020  ########.#      
-00016570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016580: 204c 4f53 2d73 7065 6369 6669 630a 2323   LOS-specific.##
-00016590: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000165a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000165b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000165c0: 2323 2323 2323 0a23 2323 2323 2323 2323  ######.#########
+00016550: 2323 2323 2323 2323 2323 2323 2323 0a23  ##############.#
+00016560: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00016570: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00016580: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00016590: 2323 2323 2323 230a 2320 2020 2020 2020  #######.#       
+000165a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000165b0: 4c4f 532d 7370 6563 6966 6963 0a23 2323  LOS-specific.###
+000165c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 000165d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 000165e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000165f0: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
+000165f0: 2323 2323 230a 2323 2323 2323 2323 2323  #####.##########
 00016600: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00016610: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00016620: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00016630: 2323 2323 2323 2323 0a22 2222 0a0a 0a0a  ########."""....
-00016640: 0a23 2323 2323 2323 2323 2323 2323 2323  .###############
+00016620: 2323 2323 2323 2323 2323 2323 2323 0a23  ##############.#
+00016630: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00016640: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00016650: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00016660: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00016670: 2323 2323 2323 2323 230a 2323 2323 2323  #########.######
+00016660: 2323 2323 2323 230a 2222 220a 0a0a 0a0a  #######.""".....
+00016670: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00016680: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00016690: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000166a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000166b0: 2323 0a23 2020 2020 2020 2050 496e 2050  ##.#       PIn P
-000166c0: 4f75 740a 2323 2323 2323 2323 2323 2323  Out.############
+000166a0: 2323 2323 2323 2323 0a23 2323 2323 2323  ########.#######
+000166b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000166c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 000166d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000166e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000166f0: 2323 2323 2323 2323 2323 2323 0a0a 0a23  ############...#
-00016700: 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d   ===============
-00016710: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00016720: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000166e0: 230a 2320 2020 2020 2020 5049 6e20 504f  #.#       PIn PO
+000166f0: 7574 0a23 2323 2323 2323 2323 2323 2323  ut.#############
+00016700: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00016710: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00016720: 2323 2323 2323 2323 2323 230a 0a0a 2320  ###########...# 
 00016730: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00016740: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 0a23  ==============.#
-00016750: 203d 2053 6574 206f 6620 6675 6e63 7469   = Set of functi
-00016760: 6f6e 7320 666f 7220 5261 792d 7472 6163  ons for Ray-trac
-00016770: 696e 670a 2320 3d3d 3d3d 3d3d 3d3d 3d3d  ing.# ==========
-00016780: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00016790: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000167a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00016740: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00016750: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00016760: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00016770: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 2320  =============.# 
+00016780: 3d20 5365 7420 6f66 2066 756e 6374 696f  = Set of functio
+00016790: 6e73 2066 6f72 2052 6179 2d74 7261 6369  ns for Ray-traci
+000167a0: 6e67 0a23 203d 3d3d 3d3d 3d3d 3d3d 3d3d  ng.# ===========
 000167b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000167c0: 3d3d 3d0a 6465 6620 4c4f 535f 4361 6c63  ===.def LOS_Calc
-000167d0: 5f50 496e 4f75 745f 5665 7353 7472 7563  _PInOut_VesStruc
-000167e0: 7428 646f 7562 6c65 5b3a 2c20 3a3a 315d  t(double[:, ::1]
-000167f0: 2072 6179 5f6f 7269 672c 0a20 2020 2020   ray_orig,.     
-00016800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016810: 2020 2020 2020 2020 2064 6f75 626c 655b           double[
-00016820: 3a2c 203a 3a31 5d20 7261 795f 7664 6972  :, ::1] ray_vdir
-00016830: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00016840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016850: 646f 7562 6c65 5b3a 2c20 3a3a 315d 2076  double[:, ::1] v
-00016860: 6573 5f70 6f6c 792c 0a20 2020 2020 2020  es_poly,.       
-00016870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016880: 2020 2020 2020 2064 6f75 626c 655b 3a2c         double[:,
-00016890: 203a 3a31 5d20 7665 735f 6e6f 726d 2c0a   ::1] ves_norm,.
+000167c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000167d0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000167e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000167f0: 3d3d 0a64 6566 204c 4f53 5f43 616c 635f  ==.def LOS_Calc_
+00016800: 5049 6e4f 7574 5f56 6573 5374 7275 6374  PInOut_VesStruct
+00016810: 2864 6f75 626c 655b 3a2c 203a 3a31 5d20  (double[:, ::1] 
+00016820: 7261 795f 6f72 6967 2c0a 2020 2020 2020  ray_orig,.      
+00016830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016840: 2020 2020 2020 2020 646f 7562 6c65 5b3a          double[:
+00016850: 2c20 3a3a 315d 2072 6179 5f76 6469 722c  , ::1] ray_vdir,
+00016860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016870: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00016880: 6f75 626c 655b 3a2c 203a 3a31 5d20 7665  ouble[:, ::1] ve
+00016890: 735f 706f 6c79 2c0a 2020 2020 2020 2020  s_poly,.        
 000168a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000168b0: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-000168c0: 6e67 5b3a 3a31 5d20 6c73 7472 7563 745f  ng[::1] lstruct_
-000168d0: 6e6c 696d 3d4e 6f6e 652c 0a20 2020 2020  nlim=None,.     
-000168e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000168f0: 2020 2020 2020 2020 2064 6f75 626c 655b           double[
-00016900: 3a3a 315d 2076 6573 5f6c 696d 733d 4e6f  ::1] ves_lims=No
-00016910: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-00016920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016930: 2020 646f 7562 6c65 5b3a 3a31 5d20 6c73    double[::1] ls
-00016940: 7472 7563 745f 706f 6c79 783d 4e6f 6e65  truct_polyx=None
-00016950: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00016960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016970: 646f 7562 6c65 5b3a 3a31 5d20 6c73 7472  double[::1] lstr
-00016980: 7563 745f 706f 6c79 793d 4e6f 6e65 2c0a  uct_polyy=None,.
-00016990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000169a0: 2020 2020 2020 2020 2020 2020 2020 6c69                li
-000169b0: 7374 206c 7374 7275 6374 5f6c 696d 733d  st lstruct_lims=
-000169c0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
-000169d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000169e0: 2020 2020 646f 7562 6c65 5b3a 3a31 5d20      double[::1] 
-000169f0: 6c73 7472 7563 745f 6e6f 726d 783d 4e6f  lstruct_normx=No
-00016a00: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-00016a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016a20: 2020 646f 7562 6c65 5b3a 3a31 5d20 6c73    double[::1] ls
-00016a30: 7472 7563 745f 6e6f 726d 793d 4e6f 6e65  truct_normy=None
-00016a40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00016a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016a60: 6c6f 6e67 5b3a 3a31 5d20 6c6e 7665 7274  long[::1] lnvert
-00016a70: 3d4e 6f6e 652c 0a20 2020 2020 2020 2020  =None,.         
-00016a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016a90: 2020 2020 2069 6e74 206e 7374 7275 6374       int nstruct
-00016aa0: 5f74 6f74 3d30 2c0a 2020 2020 2020 2020  _tot=0,.        
+000168b0: 2020 2020 2020 646f 7562 6c65 5b3a 2c20        double[:, 
+000168c0: 3a3a 315d 2076 6573 5f6e 6f72 6d2c 0a20  ::1] ves_norm,. 
+000168d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000168e0: 2020 2020 2020 2020 2020 2020 206c 6f6e               lon
+000168f0: 675b 3a3a 315d 206c 7374 7275 6374 5f6e  g[::1] lstruct_n
+00016900: 6c69 6d3d 4e6f 6e65 2c0a 2020 2020 2020  lim=None,.      
+00016910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016920: 2020 2020 2020 2020 646f 7562 6c65 5b3a          double[:
+00016930: 3a31 5d20 7665 735f 6c69 6d73 3d4e 6f6e  :1] ves_lims=Non
+00016940: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00016950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016960: 2064 6f75 626c 655b 3a3a 315d 206c 7374   double[::1] lst
+00016970: 7275 6374 5f70 6f6c 7978 3d4e 6f6e 652c  ruct_polyx=None,
+00016980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016990: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+000169a0: 6f75 626c 655b 3a3a 315d 206c 7374 7275  ouble[::1] lstru
+000169b0: 6374 5f70 6f6c 7979 3d4e 6f6e 652c 0a20  ct_polyy=None,. 
+000169c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000169d0: 2020 2020 2020 2020 2020 2020 206c 6973               lis
+000169e0: 7420 6c73 7472 7563 745f 6c69 6d73 3d4e  t lstruct_lims=N
+000169f0: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+00016a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016a10: 2020 2064 6f75 626c 655b 3a3a 315d 206c     double[::1] l
+00016a20: 7374 7275 6374 5f6e 6f72 6d78 3d4e 6f6e  struct_normx=Non
+00016a30: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00016a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016a50: 2064 6f75 626c 655b 3a3a 315d 206c 7374   double[::1] lst
+00016a60: 7275 6374 5f6e 6f72 6d79 3d4e 6f6e 652c  ruct_normy=None,
+00016a70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016a80: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00016a90: 6f6e 675b 3a3a 315d 206c 6e76 6572 743d  ong[::1] lnvert=
+00016aa0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
 00016ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016ac0: 2020 2020 2020 696e 7420 6e73 7472 7563        int nstruc
-00016ad0: 745f 6c69 6d3d 302c 0a20 2020 2020 2020  t_lim=0,.       
+00016ac0: 2020 2020 696e 7420 6e73 7472 7563 745f      int nstruct_
+00016ad0: 746f 743d 302c 0a20 2020 2020 2020 2020  tot=0,.         
 00016ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016af0: 2020 2020 2020 2064 6f75 626c 6520 726d         double rm
-00016b00: 696e 3d2d 312c 0a20 2020 2020 2020 2020  in=-1,.         
+00016af0: 2020 2020 2069 6e74 206e 7374 7275 6374       int nstruct
+00016b00: 5f6c 696d 3d30 2c0a 2020 2020 2020 2020  _lim=0,.        
 00016b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016b20: 2020 2020 2064 6f75 626c 6520 6570 735f       double eps_
-00016b30: 757a 3d5f 534d 414c 4c2c 2064 6f75 626c  uz=_SMALL, doubl
-00016b40: 6520 6570 735f 613d 5f56 534d 414c 4c2c  e eps_a=_VSMALL,
-00016b50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016b60: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00016b70: 6f75 626c 6520 6570 735f 767a 3d5f 5653  ouble eps_vz=_VS
-00016b80: 4d41 4c4c 2c20 646f 7562 6c65 2065 7073  MALL, double eps
-00016b90: 5f62 3d5f 5653 4d41 4c4c 2c0a 2020 2020  _b=_VSMALL,.    
-00016ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016bb0: 2020 2020 2020 2020 2020 646f 7562 6c65            double
-00016bc0: 2065 7073 5f70 6c61 6e65 3d5f 5653 4d41   eps_plane=_VSMA
-00016bd0: 4c4c 2c20 7374 7220 7665 735f 7479 7065  LL, str ves_type
-00016be0: 3d27 546f 7227 2c0a 2020 2020 2020 2020  ='Tor',.        
-00016bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016c00: 2020 2020 2020 6269 6e74 2066 6f72 6269        bint forbi
-00016c10: 643d 312c 2062 696e 7420 7465 7374 3d31  d=1, bint test=1
-00016c20: 2c20 696e 7420 6e75 6d5f 7468 7265 6164  , int num_thread
-00016c30: 733d 3136 293a 0a20 2020 2022 2222 0a20  s=16):.    """. 
-00016c40: 2020 2043 6f6d 7075 7465 7320 7468 6520     Computes the 
-00016c50: 656e 7472 7920 616e 6420 6578 6974 2070  entry and exit p
-00016c60: 6f69 6e74 206f 6620 616c 6c20 7072 6f76  oint of all prov
-00016c70: 6964 6564 204c 4f53 2066 6f72 2074 6865  ided LOS for the
-00016c80: 2070 726f 7669 6465 640a 2020 2020 7665   provided.    ve
-00016c90: 7373 656c 2070 6f6c 7967 6f6e 2028 746f  ssel polygon (to
-00016ca0: 726f 6964 616c 206f 7220 6c69 6e65 6172  roidal or linear
-00016cb0: 2920 7769 7468 2069 7473 2061 7373 6f63  ) with its assoc
-00016cc0: 6961 7465 6420 7374 7275 6374 7572 6573  iated structures
-00016cd0: 2e0a 2020 2020 5265 7475 726e 2074 6865  ..    Return the
-00016ce0: 206e 6f72 6d61 6c20 7665 6374 6f72 2061   normal vector a
-00016cf0: 7420 696d 7061 6374 2061 6e64 2074 6865  t impact and the
-00016d00: 2069 6e64 6578 206f 6620 7468 6520 696d   index of the im
-00016d10: 7061 6374 2073 6567 6d65 6e74 0a0a 2020  pact segment..  
-00016d20: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
-00016d30: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
-00016d40: 7261 795f 6f72 6967 203a 2028 332c 206e  ray_orig : (3, n
-00016d50: 6c6f 7329 2064 6f75 626c 6520 6172 7261  los) double arra
-00016d60: 790a 2020 2020 2020 204c 4f53 206f 7269  y.       LOS ori
-00016d70: 6769 6e20 706f 696e 7473 2063 6f6f 7264  gin points coord
-00016d80: 696e 6174 6573 0a20 2020 2072 6179 5f76  inates.    ray_v
-00016d90: 6469 7220 3a20 2833 2c20 6e6c 6f73 2920  dir : (3, nlos) 
-00016da0: 646f 7562 6c65 2061 7272 6179 0a20 2020  double array.   
-00016db0: 2020 2020 4c4f 5320 6e6f 726d 616c 697a      LOS normaliz
-00016dc0: 6564 2064 6972 6563 7469 6f6e 2076 6563  ed direction vec
-00016dd0: 746f 720a 2020 2020 7665 735f 706f 6c79  tor.    ves_poly
-00016de0: 203a 2028 322c 206e 756d 5f76 6572 7465   : (2, num_verte
-00016df0: 7829 2064 6f75 626c 6520 6172 7261 790a  x) double array.
-00016e00: 2020 2020 2020 2043 6f6f 7264 696e 6174         Coordinat
-00016e10: 6573 206f 6620 7468 6520 7665 7274 6963  es of the vertic
-00016e20: 6573 206f 6620 7468 6520 506f 6c79 676f  es of the Polygo
-00016e30: 6e20 6465 6669 6e69 6e67 2074 6865 2032  n defining the 2
-00016e40: 4420 706f 6c6f 6964 616c 0a20 2020 2020  D poloidal.     
-00016e50: 2020 6375 7420 6f66 2074 6865 2056 6573    cut of the Ves
-00016e60: 7365 6c0a 2020 2020 7665 735f 6e6f 726d  sel.    ves_norm
-00016e70: 203a 2028 322c 206e 756d 5f76 6572 7465   : (2, num_verte
-00016e80: 782d 3129 2064 6f75 626c 6520 6172 7261  x-1) double arra
-00016e90: 790a 2020 2020 2020 204e 6f72 6d61 6c20  y.       Normal 
-00016ea0: 7665 6374 6f72 7320 676f 696e 6720 2269  vectors going "i
-00016eb0: 6e77 6172 6473 2220 6f66 2074 6865 2065  nwards" of the e
-00016ec0: 6467 6573 206f 6620 7468 6520 506f 6c79  dges of the Poly
-00016ed0: 676f 6e20 6465 6669 6e65 640a 2020 2020  gon defined.    
-00016ee0: 2020 2062 7920 7665 735f 706f 6c79 0a20     by ves_poly. 
-00016ef0: 2020 206e 7374 7275 6374 5f74 6f74 203a     nstruct_tot :
-00016f00: 2069 6e74 0a20 2020 2020 2020 546f 7461   int.       Tota
-00016f10: 6c20 6e75 6d62 6572 206f 6620 7374 7275  l number of stru
-00016f20: 6374 7572 6573 2028 636f 756e 7469 6e67  ctures (counting
-00016f30: 2065 6163 6820 6c69 6d69 7465 6420 7374   each limited st
-00016f40: 7275 6374 7572 6520 6173 206f 6e65 290a  ructure as one).
-00016f50: 2020 2020 7665 735f 6c69 6d73 203a 2061      ves_lims : a
-00016f60: 7272 6179 0a20 2020 2020 2020 436f 6e74  rray.       Cont
-00016f70: 6169 6e73 2074 6865 206c 696d 6974 7320  ains the limits 
-00016f80: 6d69 6e20 616e 6420 6d61 7820 6f66 2076  min and max of v
-00016f90: 6573 7365 6c0a 2020 2020 6c73 7472 7563  essel.    lstruc
-00016fa0: 745f 706f 6c79 7820 3a20 6172 7261 790a  t_polyx : array.
-00016fb0: 2020 2020 2020 204c 6973 7420 6f66 2078         List of x
-00016fc0: 2063 6f6f 7264 696e 6174 6573 206f 6620   coordinates of 
-00016fd0: 7468 6520 7665 7274 6963 6573 206f 6620  the vertices of 
-00016fe0: 616c 6c20 7374 7275 6374 7572 6573 206f  all structures o
-00016ff0: 6e20 706f 6c6f 6964 616c 2070 6c61 6e65  n poloidal plane
-00017000: 0a20 2020 2020 2020 4966 206e 6f20 7374  .       If no st
-00017010: 7275 6374 7572 6573 203a 204e 6f6e 650a  ructures : None.
-00017020: 2020 2020 6c73 7472 7563 745f 706f 6c79      lstruct_poly
-00017030: 7920 3a20 6172 7261 790a 2020 2020 2020  y : array.      
-00017040: 204c 6973 7420 6f66 2079 2063 6f6f 7264   List of y coord
-00017050: 696e 6174 6573 206f 6620 7468 6520 7665  inates of the ve
-00017060: 7274 6963 6573 206f 6620 616c 6c20 7374  rtices of all st
-00017070: 7275 6374 7572 6573 206f 6e20 706f 6c6f  ructures on polo
-00017080: 6964 616c 2070 6c61 6e65 0a20 2020 2020  idal plane.     
-00017090: 2020 4966 206e 6f20 7374 7275 6374 7572    If no structur
-000170a0: 6573 203a 204e 6f6e 650a 2020 2020 6c73  es : None.    ls
-000170b0: 7472 7563 745f 6c69 6d73 203a 2061 7272  truct_lims : arr
-000170c0: 6179 0a20 2020 2020 2020 4c69 7374 206f  ay.       List o
-000170d0: 6620 6c69 6d69 7473 206f 6620 616c 6c20  f limits of all 
-000170e0: 7374 7275 6374 7572 6573 0a20 2020 2020  structures.     
-000170f0: 2020 4966 206e 6f20 7374 7275 6374 7572    If no structur
-00017100: 6573 203a 204e 6f6e 650a 2020 2020 6c73  es : None.    ls
-00017110: 7472 7563 745f 6e6c 696d 203a 2061 7272  truct_nlim : arr
-00017120: 6179 206f 6620 696e 7473 0a20 2020 2020  ay of ints.     
-00017130: 2020 4c69 7374 206f 6620 6e75 6d62 6572    List of number
-00017140: 206f 6620 6c69 6d69 7473 2066 6f72 2061   of limits for a
-00017150: 6c6c 2073 7472 7563 7475 7265 730a 2020  ll structures.  
-00017160: 2020 2020 2049 6620 6e6f 2073 7472 7563       If no struc
-00017170: 7475 7265 7320 3a20 4e6f 6e65 0a20 2020  tures : None.   
-00017180: 206c 7374 7275 6374 5f6e 6f72 6d78 203a   lstruct_normx :
-00017190: 2061 7272 6179 0a20 2020 2020 2020 4c69   array.       Li
-000171a0: 7374 206f 6620 7820 636f 6f72 6469 6e61  st of x coordina
-000171b0: 7465 7320 6f66 2022 696e 7761 7264 7322  tes of "inwards"
-000171c0: 206e 6f72 6d61 6c20 7665 6374 6f72 7320   normal vectors 
-000171d0: 6f66 2074 6865 2070 6f6c 7967 6f6e 206f  of the polygon o
-000171e0: 6620 616c 6c0a 2020 2020 2020 2074 6865  f all.       the
-000171f0: 2073 7472 7563 7475 7265 730a 2020 2020   structures.    
-00017200: 2020 2049 6620 6e6f 2073 7472 7563 7475     If no structu
-00017210: 7265 7320 3a20 4e6f 6e65 0a20 2020 206c  res : None.    l
-00017220: 7374 7275 6374 5f6e 6f72 6d79 203a 2061  struct_normy : a
-00017230: 7272 6179 0a20 2020 2020 2020 4c69 7374  rray.       List
-00017240: 206f 6620 7920 636f 6f72 6469 6e61 7465   of y coordinate
-00017250: 7320 6f66 2022 696e 7761 7264 7322 206e  s of "inwards" n
-00017260: 6f72 6d61 6c20 7665 6374 6f72 7320 6f66  ormal vectors of
-00017270: 2074 6865 2070 6f6c 7967 6f6e 206f 6620   the polygon of 
-00017280: 616c 6c0a 2020 2020 2020 2074 6865 2073  all.       the s
-00017290: 7472 7563 7475 7265 730a 2020 2020 2020  tructures.      
-000172a0: 2049 6620 6e6f 2073 7472 7563 7475 7265   If no structure
-000172b0: 7320 3a20 4e6f 6e65 0a20 2020 2072 6d69  s : None.    rmi
-000172c0: 6e20 3a20 646f 7562 6c65 0a20 2020 2020  n : double.     
-000172d0: 2020 4d69 6e69 6d61 6c20 7261 6469 7573    Minimal radius
-000172e0: 206f 6620 7665 7373 656c 2074 6f20 7461   of vessel to ta
-000172f0: 6b65 2069 6e74 6f20 636f 6e73 6964 6572  ke into consider
-00017300: 6174 696f 6e0a 2020 2020 6570 735f 3c76  ation.    eps_<v
-00017310: 616c 3e20 3a20 646f 7562 6c65 0a20 2020  al> : double.   
-00017320: 2020 2020 536d 616c 6c20 7661 6c75 652c      Small value,
-00017330: 2061 6363 6570 7461 6e63 6520 6f66 2065   acceptance of e
-00017340: 7272 6f72 0a20 2020 2076 6573 5f74 7970  rror.    ves_typ
-00017350: 6520 3a20 7374 7269 6e67 0a20 2020 2020  e : string.     
-00017360: 2020 5479 7065 206f 6620 7665 7373 656c    Type of vessel
-00017370: 2028 2254 6f72 2220 6f72 2022 4c69 6e22   ("Tor" or "Lin"
-00017380: 290a 2020 2020 666f 7262 6964 203a 2062  ).    forbid : b
-00017390: 6f6f 6c0a 2020 2020 2020 2053 686f 756c  ool.       Shoul
-000173a0: 6420 7765 2066 6f72 6269 6420 7661 6c75  d we forbid valu
-000173b0: 6573 2062 6568 696e 6420 7669 7369 626c  es behind visibl
-000173c0: 6520 7261 6469 7573 203f 2028 7365 6520  e radius ? (see 
-000173d0: 726d 696e 290a 2020 2020 7465 7374 203a  rmin).    test :
-000173e0: 2062 6f6f 6c0a 2020 2020 2020 2053 686f   bool.       Sho
-000173f0: 756c 6420 7765 2072 756e 2074 6573 7473  uld we run tests
-00017400: 203f 0a20 2020 206e 756d 5f74 6872 6561   ?.    num_threa
-00017410: 6473 203a 2069 6e74 0a20 2020 2020 2020  ds : int.       
-00017420: 5468 6520 6e75 6d5f 7468 7265 6164 7320  The num_threads 
-00017430: 6172 6775 6d65 6e74 2069 6e64 6963 6174  argument indicat
-00017440: 6573 2068 6f77 206d 616e 7920 7468 7265  es how many thre
-00017450: 6164 7320 7468 6520 7465 616d 2073 686f  ads the team sho
-00017460: 756c 640a 2020 2020 2020 2063 6f6e 7369  uld.       consi
-00017470: 7374 206f 662e 2049 6620 6e6f 7420 6769  st of. If not gi
-00017480: 7665 6e2c 204f 7065 6e4d 5020 7769 6c6c  ven, OpenMP will
-00017490: 2064 6563 6964 6520 686f 7720 6d61 6e79   decide how many
-000174a0: 2074 6872 6561 6473 2074 6f20 7573 652e   threads to use.
-000174b0: 0a20 2020 2020 2020 5479 7069 6361 6c6c  .       Typicall
-000174c0: 7920 7468 6973 2069 7320 7468 6520 6e75  y this is the nu
-000174d0: 6d62 6572 206f 6620 636f 7265 7320 6176  mber of cores av
-000174e0: 6169 6c61 626c 6520 6f6e 2074 6865 206d  ailable on the m
-000174f0: 6163 6869 6e65 2e0a 0a20 2020 2052 6574  achine...    Ret
-00017500: 7572 6e73 0a20 2020 202d 2d2d 2d2d 2d2d  urns.    -------
-00017510: 0a20 2020 2063 6f65 6666 5f69 6e74 6572  .    coeff_inter
-00017520: 5f69 6e20 3a20 286e 6c6f 7329 2061 7272  _in : (nlos) arr
-00017530: 6179 0a20 2020 2020 2020 7363 616c 6172  ay.       scalar
-00017540: 7320 6c65 7665 6c20 6f66 2022 696e 2220  s level of "in" 
-00017550: 696e 7465 7273 6563 7469 6f6e 206f 6620  intersection of 
-00017560: 7468 6520 4c4f 5320 2869 6620 6b3d 3020  the LOS (if k=0 
-00017570: 6174 206f 7269 6769 6e29 0a20 2020 2063  at origin).    c
-00017580: 6f65 6666 5f69 6e74 6572 5f6f 7574 203a  oeff_inter_out :
-00017590: 2028 6e6c 6f73 2920 6172 7261 790a 2020   (nlos) array.  
-000175a0: 2020 2020 2073 6361 6c61 7273 206c 6576       scalars lev
-000175b0: 656c 206f 6620 226f 7574 2220 696e 7465  el of "out" inte
-000175c0: 7273 6563 7469 6f6e 206f 6620 7468 6520  rsection of the 
-000175d0: 4c4f 5320 2869 6620 6b3d 3020 6174 206f  LOS (if k=0 at o
-000175e0: 7269 6769 6e29 0a20 2020 2076 7065 7270  rigin).    vperp
-000175f0: 5f6f 7574 203a 2028 332c 206e 6c6f 7329  _out : (3, nlos)
-00017600: 2061 7272 6179 0a20 2020 2020 2020 436f   array.       Co
-00017610: 6f72 6469 6e61 7465 7320 6f66 2074 6865  ordinates of the
-00017620: 206e 6f72 6d61 6c20 7665 6374 6f72 206f   normal vector o
-00017630: 6620 696d 7061 6374 206f 6620 7468 6520  f impact of the 
-00017640: 4c4f 5320 284e 614e 2069 6620 6e6f 6e65  LOS (NaN if none
-00017650: 290a 2020 2020 696e 645f 696e 7465 725f  ).    ind_inter_
-00017660: 6f75 7420 3a20 2833 2c20 6e6c 6f73 290a  out : (3, nlos).
-00017670: 2020 2020 2020 2049 6e64 6578 206f 6620         Index of 
-00017680: 7374 7275 6374 7572 6520 696d 7061 6374  structure impact
-00017690: 6564 2062 7920 4c4f 533a 2069 6e64 5f69  ed by LOS: ind_i
-000176a0: 6e74 6572 5f6f 7574 5b3a 2c69 6e64 5f6c  nter_out[:,ind_l
-000176b0: 6f73 5d3d 2869 2c6a 2c6b 290a 2020 2020  os]=(i,j,k).    
-000176c0: 2020 2077 6865 7265 206b 2069 7320 7468     where k is th
-000176d0: 6520 696e 6465 7820 6f66 2065 6467 6520  e index of edge 
-000176e0: 696d 7061 6374 6564 206f 6e20 7468 6520  impacted on the 
-000176f0: 6a2d 7468 2073 7562 2073 7472 7563 7475  j-th sub structu
-00017700: 7265 206f 6620 7468 650a 2020 2020 2020  re of the.      
-00017710: 2073 7472 7563 7475 7265 206e 756d 6265   structure numbe
-00017720: 7220 692e 2049 6620 7468 6520 4c4f 5320  r i. If the LOS 
-00017730: 696d 7061 6374 6564 2074 6865 2076 6573  impacted the ves
-00017740: 7365 6c20 693d 6a3d 300a 2020 2020 2222  sel i=j=0.    ""
-00017750: 220a 2020 2020 6364 6566 2073 7472 2076  ".    cdef str v
-00017760: 745f 6c6f 7765 7220 3d20 7665 735f 7479  t_lower = ves_ty
-00017770: 7065 2e6c 6f77 6572 2829 0a20 2020 2063  pe.lower().    c
-00017780: 6465 6620 7374 7220 6572 726f 725f 6d65  def str error_me
-00017790: 7373 6167 650a 2020 2020 6364 6566 2069  ssage.    cdef i
-000177a0: 6e74 2073 7a5f 7665 735f 6c69 6d73 0a20  nt sz_ves_lims. 
-000177b0: 2020 2063 6465 6620 696e 7420 6e6c 6f73     cdef int nlos
-000177c0: 203d 2072 6179 5f6f 7269 672e 7368 6170   = ray_orig.shap
-000177d0: 655b 315d 0a20 2020 2063 6465 6620 696e  e[1].    cdef in
-000177e0: 7420 6e70 7473 5f70 6f6c 7920 3d20 7665  t npts_poly = ve
-000177f0: 735f 6e6f 726d 2e73 6861 7065 5b31 5d0a  s_norm.shape[1].
-00017800: 2020 2020 6364 6566 2062 696e 7420 626f      cdef bint bo
-00017810: 6f6c 312c 2062 6f6f 6c32 0a20 2020 2063  ol1, bool2.    c
-00017820: 6465 6620 646f 7562 6c65 206d 696e 5f70  def double min_p
-00017830: 6f6c 795f 720a 2020 2020 6364 6566 2061  oly_r.    cdef a
-00017840: 7272 6179 2076 7065 7270 5f6f 7574 203d  rray vperp_out =
-00017850: 2063 6c6f 6e65 2861 7272 6179 2827 6427   clone(array('d'
-00017860: 292c 206e 6c6f 7320 2a20 332c 2054 7275  ), nlos * 3, Tru
-00017870: 6529 0a20 2020 2063 6465 6620 6172 7261  e).    cdef arra
-00017880: 7920 636f 6566 665f 696e 7465 725f 696e  y coeff_inter_in
-00017890: 2020 3d20 636c 6f6e 6528 6172 7261 7928    = clone(array(
-000178a0: 2764 2729 2c20 6e6c 6f73 2c20 5472 7565  'd'), nlos, True
-000178b0: 290a 2020 2020 6364 6566 2061 7272 6179  ).    cdef array
-000178c0: 2063 6f65 6666 5f69 6e74 6572 5f6f 7574   coeff_inter_out
-000178d0: 203d 2063 6c6f 6e65 2861 7272 6179 2827   = clone(array('
-000178e0: 6427 292c 206e 6c6f 732c 2054 7275 6529  d'), nlos, True)
-000178f0: 0a20 2020 2063 6465 6620 6172 7261 7920  .    cdef array 
-00017900: 696e 645f 696e 7465 725f 6f75 7420 3d20  ind_inter_out = 
-00017910: 636c 6f6e 6528 6172 7261 7928 2769 2729  clone(array('i')
-00017920: 2c20 6e6c 6f73 202a 2033 2c20 5472 7565  , nlos * 3, True
-00017930: 290a 2020 2020 6364 6566 2064 6f75 626c  ).    cdef doubl
-00017940: 655b 3a3a 315d 206c 7374 7275 6374 5f6c  e[::1] lstruct_l
-00017950: 696d 735f 6e70 0a20 2020 2023 203d 3d20  ims_np.    # == 
-00017960: 5465 7374 696e 6720 696e 7075 7473 203d  Testing inputs =
-00017970: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00017980: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00017990: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000179a0: 3d3d 3d3d 3d3d 3d0a 2020 2020 6966 2074  =======.    if t
-000179b0: 6573 743a 0a20 2020 2020 2020 2065 7272  est:.        err
-000179c0: 6f72 5f6d 6573 7361 6765 203d 2022 7261  or_message = "ra
-000179d0: 795f 6f72 6967 2061 6e64 2072 6179 5f76  y_orig and ray_v
-000179e0: 6469 7220 6d75 7374 2068 6176 6520 7468  dir must have th
-000179f0: 6520 7361 6d65 2073 6861 7065 3a20 225c  e same shape: "\
-00017a00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017a10: 2020 2020 2020 2020 202b 2022 2833 2c29           + "(3,)
-00017a20: 206f 7220 2833 2c4e 4c29 2122 0a20 2020   or (3,NL)!".   
-00017a30: 2020 2020 2061 7373 6572 7420 7475 706c       assert tupl
-00017a40: 6528 7261 795f 6f72 6967 2e73 6861 7065  e(ray_orig.shape
-00017a50: 2920 3d3d 2074 7570 6c65 2872 6179 5f76  ) == tuple(ray_v
-00017a60: 6469 722e 7368 6170 6529 2061 6e64 205c  dir.shape) and \
-00017a70: 0a20 2020 2020 2020 2020 2072 6179 5f6f  .          ray_o
-00017a80: 7269 672e 7368 6170 655b 305d 203d 3d20  rig.shape[0] == 
-00017a90: 332c 2065 7272 6f72 5f6d 6573 7361 6765  3, error_message
-00017aa0: 0a20 2020 2020 2020 2065 7272 6f72 5f6d  .        error_m
-00017ab0: 6573 7361 6765 203d 2022 7665 735f 706f  essage = "ves_po
-00017ac0: 6c79 2061 6e64 2076 6573 5f6e 6f72 6d20  ly and ves_norm 
-00017ad0: 6d75 7374 2068 6176 6520 7468 6520 7361  must have the sa
-00017ae0: 6d65 2073 6861 7065 2028 322c 4e53 2921  me shape (2,NS)!
-00017af0: 220a 2020 2020 2020 2020 6173 7365 7274  ".        assert
-00017b00: 2076 6573 5f70 6f6c 792e 7368 6170 655b   ves_poly.shape[
-00017b10: 305d 203d 3d20 3220 616e 6420 7665 735f  0] == 2 and ves_
-00017b20: 6e6f 726d 2e73 6861 7065 5b30 5d20 3d3d  norm.shape[0] ==
-00017b30: 2032 2c20 6572 726f 725f 6d65 7373 6167   2, error_messag
-00017b40: 650a 2020 2020 2020 2020 626f 6f6c 3120  e.        bool1 
-00017b50: 3d20 6c73 7472 7563 745f 6c69 6d73 2069  = lstruct_lims i
-00017b60: 7320 4e6f 6e65 206f 7220 6c65 6e28 6c73  s None or len(ls
-00017b70: 7472 7563 745f 6e6f 726d 7929 203d 3d20  truct_normy) == 
-00017b80: 6c65 6e28 6c73 7472 7563 745f 6e6f 726d  len(lstruct_norm
-00017b90: 7929 0a20 2020 2020 2020 2062 6f6f 6c32  y).        bool2
-00017ba0: 203d 206c 7374 7275 6374 5f6e 6f72 6d78   = lstruct_normx
-00017bb0: 2069 7320 4e6f 6e65 206f 7220 6c65 6e28   is None or len(
-00017bc0: 6c73 7472 7563 745f 706f 6c79 7829 203d  lstruct_polyx) =
-00017bd0: 3d20 6c65 6e28 6c73 7472 7563 745f 706f  = len(lstruct_po
-00017be0: 6c79 7929 0a20 2020 2020 2020 2065 7272  lyy).        err
-00017bf0: 6f72 5f6d 6573 7361 6765 203d 2022 6c73  or_message = "ls
-00017c00: 7472 7563 745f 706f 6c79 2c20 6c73 7472  truct_poly, lstr
-00017c10: 7563 745f 6c69 6d73 2c20 6c73 7472 7563  uct_lims, lstruc
-00017c20: 745f 6e6f 726d 206d 7573 7420 6265 204e  t_norm must be N
-00017c30: 6f6e 6522 5c0a 2020 2020 2020 2020 2020  one"\.          
-00017c40: 2020 2020 2020 2020 2020 2020 2020 2b20                + 
-00017c50: 2220 6f72 206c 6973 7473 206f 6620 7361  " or lists of sa
-00017c60: 6d65 206c 656e 2122 0a20 2020 2020 2020  me len!".       
-00017c70: 2061 7373 6572 7420 626f 6f6c 3120 616e   assert bool1 an
-00017c80: 6420 626f 6f6c 322c 2065 7272 6f72 5f6d  d bool2, error_m
-00017c90: 6573 7361 6765 0a20 2020 2020 2020 2065  essage.        e
-00017ca0: 7272 6f72 5f6d 6573 7361 6765 203d 2022  rror_message = "
-00017cb0: 5b65 7073 5f75 7a2c 6570 735f 767a 2c65  [eps_uz,eps_vz,e
-00017cc0: 7073 5f61 2c65 7073 5f62 5d20 6d75 7374  ps_a,eps_b] must
-00017cd0: 2062 6520 666c 6f61 7473 203c 2031 2e65   be floats < 1.e
-00017ce0: 2d34 2122 0a20 2020 2020 2020 2061 7373  -4!".        ass
-00017cf0: 6572 7420 616c 6c28 5b65 6520 3c20 312e  ert all([ee < 1.
-00017d00: 652d 3420 666f 7220 6565 2069 6e20 5b65  e-4 for ee in [e
-00017d10: 7073 5f75 7a2c 2065 7073 5f61 2c0a 2020  ps_uz, eps_a,.  
-00017d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017d40: 2020 2020 2020 2020 6570 735f 767a 2c20          eps_vz, 
-00017d50: 6570 735f 622c 0a20 2020 2020 2020 2020  eps_b,.         
+00016b20: 2020 2020 2020 646f 7562 6c65 2072 6d69        double rmi
+00016b30: 6e3d 2d31 2c0a 2020 2020 2020 2020 2020  n=-1,.          
+00016b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016b50: 2020 2020 646f 7562 6c65 2065 7073 5f75      double eps_u
+00016b60: 7a3d 5f53 4d41 4c4c 2c20 646f 7562 6c65  z=_SMALL, double
+00016b70: 2065 7073 5f61 3d5f 5653 4d41 4c4c 2c0a   eps_a=_VSMALL,.
+00016b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016b90: 2020 2020 2020 2020 2020 2020 2020 646f                do
+00016ba0: 7562 6c65 2065 7073 5f76 7a3d 5f56 534d  uble eps_vz=_VSM
+00016bb0: 414c 4c2c 2064 6f75 626c 6520 6570 735f  ALL, double eps_
+00016bc0: 623d 5f56 534d 414c 4c2c 0a20 2020 2020  b=_VSMALL,.     
+00016bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016be0: 2020 2020 2020 2020 2064 6f75 626c 6520           double 
+00016bf0: 6570 735f 706c 616e 653d 5f56 534d 414c  eps_plane=_VSMAL
+00016c00: 4c2c 2073 7472 2076 6573 5f74 7970 653d  L, str ves_type=
+00016c10: 2754 6f72 272c 0a20 2020 2020 2020 2020  'Tor',.         
+00016c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016c30: 2020 2020 2062 696e 7420 666f 7262 6964       bint forbid
+00016c40: 3d31 2c20 6269 6e74 2074 6573 743d 312c  =1, bint test=1,
+00016c50: 2069 6e74 206e 756d 5f74 6872 6561 6473   int num_threads
+00016c60: 3d31 3629 3a0a 2020 2020 2222 220a 2020  =16):.    """.  
+00016c70: 2020 436f 6d70 7574 6573 2074 6865 2065    Computes the e
+00016c80: 6e74 7279 2061 6e64 2065 7869 7420 706f  ntry and exit po
+00016c90: 696e 7420 6f66 2061 6c6c 2070 726f 7669  int of all provi
+00016ca0: 6465 6420 4c4f 5320 666f 7220 7468 6520  ded LOS for the 
+00016cb0: 7072 6f76 6964 6564 0a20 2020 2076 6573  provided.    ves
+00016cc0: 7365 6c20 706f 6c79 676f 6e20 2874 6f72  sel polygon (tor
+00016cd0: 6f69 6461 6c20 6f72 206c 696e 6561 7229  oidal or linear)
+00016ce0: 2077 6974 6820 6974 7320 6173 736f 6369   with its associ
+00016cf0: 6174 6564 2073 7472 7563 7475 7265 732e  ated structures.
+00016d00: 0a20 2020 2052 6574 7572 6e20 7468 6520  .    Return the 
+00016d10: 6e6f 726d 616c 2076 6563 746f 7220 6174  normal vector at
+00016d20: 2069 6d70 6163 7420 616e 6420 7468 6520   impact and the 
+00016d30: 696e 6465 7820 6f66 2074 6865 2069 6d70  index of the imp
+00016d40: 6163 7420 7365 676d 656e 740a 0a20 2020  act segment..   
+00016d50: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
+00016d60: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2072  ----------.    r
+00016d70: 6179 5f6f 7269 6720 3a20 2833 2c20 6e6c  ay_orig : (3, nl
+00016d80: 6f73 2920 646f 7562 6c65 2061 7272 6179  os) double array
+00016d90: 0a20 2020 2020 2020 4c4f 5320 6f72 6967  .       LOS orig
+00016da0: 696e 2070 6f69 6e74 7320 636f 6f72 6469  in points coordi
+00016db0: 6e61 7465 730a 2020 2020 7261 795f 7664  nates.    ray_vd
+00016dc0: 6972 203a 2028 332c 206e 6c6f 7329 2064  ir : (3, nlos) d
+00016dd0: 6f75 626c 6520 6172 7261 790a 2020 2020  ouble array.    
+00016de0: 2020 204c 4f53 206e 6f72 6d61 6c69 7a65     LOS normalize
+00016df0: 6420 6469 7265 6374 696f 6e20 7665 6374  d direction vect
+00016e00: 6f72 0a20 2020 2076 6573 5f70 6f6c 7920  or.    ves_poly 
+00016e10: 3a20 2832 2c20 6e75 6d5f 7665 7274 6578  : (2, num_vertex
+00016e20: 2920 646f 7562 6c65 2061 7272 6179 0a20  ) double array. 
+00016e30: 2020 2020 2020 436f 6f72 6469 6e61 7465        Coordinate
+00016e40: 7320 6f66 2074 6865 2076 6572 7469 6365  s of the vertice
+00016e50: 7320 6f66 2074 6865 2050 6f6c 7967 6f6e  s of the Polygon
+00016e60: 2064 6566 696e 696e 6720 7468 6520 3244   defining the 2D
+00016e70: 2070 6f6c 6f69 6461 6c0a 2020 2020 2020   poloidal.      
+00016e80: 2063 7574 206f 6620 7468 6520 5665 7373   cut of the Vess
+00016e90: 656c 0a20 2020 2076 6573 5f6e 6f72 6d20  el.    ves_norm 
+00016ea0: 3a20 2832 2c20 6e75 6d5f 7665 7274 6578  : (2, num_vertex
+00016eb0: 2d31 2920 646f 7562 6c65 2061 7272 6179  -1) double array
+00016ec0: 0a20 2020 2020 2020 4e6f 726d 616c 2076  .       Normal v
+00016ed0: 6563 746f 7273 2067 6f69 6e67 2022 696e  ectors going "in
+00016ee0: 7761 7264 7322 206f 6620 7468 6520 6564  wards" of the ed
+00016ef0: 6765 7320 6f66 2074 6865 2050 6f6c 7967  ges of the Polyg
+00016f00: 6f6e 2064 6566 696e 6564 0a20 2020 2020  on defined.     
+00016f10: 2020 6279 2076 6573 5f70 6f6c 790a 2020    by ves_poly.  
+00016f20: 2020 6e73 7472 7563 745f 746f 7420 3a20    nstruct_tot : 
+00016f30: 696e 740a 2020 2020 2020 2054 6f74 616c  int.       Total
+00016f40: 206e 756d 6265 7220 6f66 2073 7472 7563   number of struc
+00016f50: 7475 7265 7320 2863 6f75 6e74 696e 6720  tures (counting 
+00016f60: 6561 6368 206c 696d 6974 6564 2073 7472  each limited str
+00016f70: 7563 7475 7265 2061 7320 6f6e 6529 0a20  ucture as one). 
+00016f80: 2020 2076 6573 5f6c 696d 7320 3a20 6172     ves_lims : ar
+00016f90: 7261 790a 2020 2020 2020 2043 6f6e 7461  ray.       Conta
+00016fa0: 696e 7320 7468 6520 6c69 6d69 7473 206d  ins the limits m
+00016fb0: 696e 2061 6e64 206d 6178 206f 6620 7665  in and max of ve
+00016fc0: 7373 656c 0a20 2020 206c 7374 7275 6374  ssel.    lstruct
+00016fd0: 5f70 6f6c 7978 203a 2061 7272 6179 0a20  _polyx : array. 
+00016fe0: 2020 2020 2020 4c69 7374 206f 6620 7820        List of x 
+00016ff0: 636f 6f72 6469 6e61 7465 7320 6f66 2074  coordinates of t
+00017000: 6865 2076 6572 7469 6365 7320 6f66 2061  he vertices of a
+00017010: 6c6c 2073 7472 7563 7475 7265 7320 6f6e  ll structures on
+00017020: 2070 6f6c 6f69 6461 6c20 706c 616e 650a   poloidal plane.
+00017030: 2020 2020 2020 2049 6620 6e6f 2073 7472         If no str
+00017040: 7563 7475 7265 7320 3a20 4e6f 6e65 0a20  uctures : None. 
+00017050: 2020 206c 7374 7275 6374 5f70 6f6c 7979     lstruct_polyy
+00017060: 203a 2061 7272 6179 0a20 2020 2020 2020   : array.       
+00017070: 4c69 7374 206f 6620 7920 636f 6f72 6469  List of y coordi
+00017080: 6e61 7465 7320 6f66 2074 6865 2076 6572  nates of the ver
+00017090: 7469 6365 7320 6f66 2061 6c6c 2073 7472  tices of all str
+000170a0: 7563 7475 7265 7320 6f6e 2070 6f6c 6f69  uctures on poloi
+000170b0: 6461 6c20 706c 616e 650a 2020 2020 2020  dal plane.      
+000170c0: 2049 6620 6e6f 2073 7472 7563 7475 7265   If no structure
+000170d0: 7320 3a20 4e6f 6e65 0a20 2020 206c 7374  s : None.    lst
+000170e0: 7275 6374 5f6c 696d 7320 3a20 6172 7261  ruct_lims : arra
+000170f0: 790a 2020 2020 2020 204c 6973 7420 6f66  y.       List of
+00017100: 206c 696d 6974 7320 6f66 2061 6c6c 2073   limits of all s
+00017110: 7472 7563 7475 7265 730a 2020 2020 2020  tructures.      
+00017120: 2049 6620 6e6f 2073 7472 7563 7475 7265   If no structure
+00017130: 7320 3a20 4e6f 6e65 0a20 2020 206c 7374  s : None.    lst
+00017140: 7275 6374 5f6e 6c69 6d20 3a20 6172 7261  ruct_nlim : arra
+00017150: 7920 6f66 2069 6e74 730a 2020 2020 2020  y of ints.      
+00017160: 204c 6973 7420 6f66 206e 756d 6265 7220   List of number 
+00017170: 6f66 206c 696d 6974 7320 666f 7220 616c  of limits for al
+00017180: 6c20 7374 7275 6374 7572 6573 0a20 2020  l structures.   
+00017190: 2020 2020 4966 206e 6f20 7374 7275 6374      If no struct
+000171a0: 7572 6573 203a 204e 6f6e 650a 2020 2020  ures : None.    
+000171b0: 6c73 7472 7563 745f 6e6f 726d 7820 3a20  lstruct_normx : 
+000171c0: 6172 7261 790a 2020 2020 2020 204c 6973  array.       Lis
+000171d0: 7420 6f66 2078 2063 6f6f 7264 696e 6174  t of x coordinat
+000171e0: 6573 206f 6620 2269 6e77 6172 6473 2220  es of "inwards" 
+000171f0: 6e6f 726d 616c 2076 6563 746f 7273 206f  normal vectors o
+00017200: 6620 7468 6520 706f 6c79 676f 6e20 6f66  f the polygon of
+00017210: 2061 6c6c 0a20 2020 2020 2020 7468 6520   all.       the 
+00017220: 7374 7275 6374 7572 6573 0a20 2020 2020  structures.     
+00017230: 2020 4966 206e 6f20 7374 7275 6374 7572    If no structur
+00017240: 6573 203a 204e 6f6e 650a 2020 2020 6c73  es : None.    ls
+00017250: 7472 7563 745f 6e6f 726d 7920 3a20 6172  truct_normy : ar
+00017260: 7261 790a 2020 2020 2020 204c 6973 7420  ray.       List 
+00017270: 6f66 2079 2063 6f6f 7264 696e 6174 6573  of y coordinates
+00017280: 206f 6620 2269 6e77 6172 6473 2220 6e6f   of "inwards" no
+00017290: 726d 616c 2076 6563 746f 7273 206f 6620  rmal vectors of 
+000172a0: 7468 6520 706f 6c79 676f 6e20 6f66 2061  the polygon of a
+000172b0: 6c6c 0a20 2020 2020 2020 7468 6520 7374  ll.       the st
+000172c0: 7275 6374 7572 6573 0a20 2020 2020 2020  ructures.       
+000172d0: 4966 206e 6f20 7374 7275 6374 7572 6573  If no structures
+000172e0: 203a 204e 6f6e 650a 2020 2020 726d 696e   : None.    rmin
+000172f0: 203a 2064 6f75 626c 650a 2020 2020 2020   : double.      
+00017300: 204d 696e 696d 616c 2072 6164 6975 7320   Minimal radius 
+00017310: 6f66 2076 6573 7365 6c20 746f 2074 616b  of vessel to tak
+00017320: 6520 696e 746f 2063 6f6e 7369 6465 7261  e into considera
+00017330: 7469 6f6e 0a20 2020 2065 7073 5f3c 7661  tion.    eps_<va
+00017340: 6c3e 203a 2064 6f75 626c 650a 2020 2020  l> : double.    
+00017350: 2020 2053 6d61 6c6c 2076 616c 7565 2c20     Small value, 
+00017360: 6163 6365 7074 616e 6365 206f 6620 6572  acceptance of er
+00017370: 726f 720a 2020 2020 7665 735f 7479 7065  ror.    ves_type
+00017380: 203a 2073 7472 696e 670a 2020 2020 2020   : string.      
+00017390: 2054 7970 6520 6f66 2076 6573 7365 6c20   Type of vessel 
+000173a0: 2822 546f 7222 206f 7220 224c 696e 2229  ("Tor" or "Lin")
+000173b0: 0a20 2020 2066 6f72 6269 6420 3a20 626f  .    forbid : bo
+000173c0: 6f6c 0a20 2020 2020 2020 5368 6f75 6c64  ol.       Should
+000173d0: 2077 6520 666f 7262 6964 2076 616c 7565   we forbid value
+000173e0: 7320 6265 6869 6e64 2076 6973 6962 6c65  s behind visible
+000173f0: 2072 6164 6975 7320 3f20 2873 6565 2072   radius ? (see r
+00017400: 6d69 6e29 0a20 2020 2074 6573 7420 3a20  min).    test : 
+00017410: 626f 6f6c 0a20 2020 2020 2020 5368 6f75  bool.       Shou
+00017420: 6c64 2077 6520 7275 6e20 7465 7374 7320  ld we run tests 
+00017430: 3f0a 2020 2020 6e75 6d5f 7468 7265 6164  ?.    num_thread
+00017440: 7320 3a20 696e 740a 2020 2020 2020 2054  s : int.       T
+00017450: 6865 206e 756d 5f74 6872 6561 6473 2061  he num_threads a
+00017460: 7267 756d 656e 7420 696e 6469 6361 7465  rgument indicate
+00017470: 7320 686f 7720 6d61 6e79 2074 6872 6561  s how many threa
+00017480: 6473 2074 6865 2074 6561 6d20 7368 6f75  ds the team shou
+00017490: 6c64 0a20 2020 2020 2020 636f 6e73 6973  ld.       consis
+000174a0: 7420 6f66 2e20 4966 206e 6f74 2067 6976  t of. If not giv
+000174b0: 656e 2c20 4f70 656e 4d50 2077 696c 6c20  en, OpenMP will 
+000174c0: 6465 6369 6465 2068 6f77 206d 616e 7920  decide how many 
+000174d0: 7468 7265 6164 7320 746f 2075 7365 2e0a  threads to use..
+000174e0: 2020 2020 2020 2054 7970 6963 616c 6c79         Typically
+000174f0: 2074 6869 7320 6973 2074 6865 206e 756d   this is the num
+00017500: 6265 7220 6f66 2063 6f72 6573 2061 7661  ber of cores ava
+00017510: 696c 6162 6c65 206f 6e20 7468 6520 6d61  ilable on the ma
+00017520: 6368 696e 652e 0a0a 2020 2020 5265 7475  chine...    Retu
+00017530: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
+00017540: 2020 2020 636f 6566 665f 696e 7465 725f      coeff_inter_
+00017550: 696e 203a 2028 6e6c 6f73 2920 6172 7261  in : (nlos) arra
+00017560: 790a 2020 2020 2020 2073 6361 6c61 7273  y.       scalars
+00017570: 206c 6576 656c 206f 6620 2269 6e22 2069   level of "in" i
+00017580: 6e74 6572 7365 6374 696f 6e20 6f66 2074  ntersection of t
+00017590: 6865 204c 4f53 2028 6966 206b 3d30 2061  he LOS (if k=0 a
+000175a0: 7420 6f72 6967 696e 290a 2020 2020 636f  t origin).    co
+000175b0: 6566 665f 696e 7465 725f 6f75 7420 3a20  eff_inter_out : 
+000175c0: 286e 6c6f 7329 2061 7272 6179 0a20 2020  (nlos) array.   
+000175d0: 2020 2020 7363 616c 6172 7320 6c65 7665      scalars leve
+000175e0: 6c20 6f66 2022 6f75 7422 2069 6e74 6572  l of "out" inter
+000175f0: 7365 6374 696f 6e20 6f66 2074 6865 204c  section of the L
+00017600: 4f53 2028 6966 206b 3d30 2061 7420 6f72  OS (if k=0 at or
+00017610: 6967 696e 290a 2020 2020 7670 6572 705f  igin).    vperp_
+00017620: 6f75 7420 3a20 2833 2c20 6e6c 6f73 2920  out : (3, nlos) 
+00017630: 6172 7261 790a 2020 2020 2020 2043 6f6f  array.       Coo
+00017640: 7264 696e 6174 6573 206f 6620 7468 6520  rdinates of the 
+00017650: 6e6f 726d 616c 2076 6563 746f 7220 6f66  normal vector of
+00017660: 2069 6d70 6163 7420 6f66 2074 6865 204c   impact of the L
+00017670: 4f53 2028 4e61 4e20 6966 206e 6f6e 6529  OS (NaN if none)
+00017680: 0a20 2020 2069 6e64 5f69 6e74 6572 5f6f  .    ind_inter_o
+00017690: 7574 203a 2028 332c 206e 6c6f 7329 0a20  ut : (3, nlos). 
+000176a0: 2020 2020 2020 496e 6465 7820 6f66 2073        Index of s
+000176b0: 7472 7563 7475 7265 2069 6d70 6163 7465  tructure impacte
+000176c0: 6420 6279 204c 4f53 3a20 696e 645f 696e  d by LOS: ind_in
+000176d0: 7465 725f 6f75 745b 3a2c 696e 645f 6c6f  ter_out[:,ind_lo
+000176e0: 735d 3d28 692c 6a2c 6b29 0a20 2020 2020  s]=(i,j,k).     
+000176f0: 2020 7768 6572 6520 6b20 6973 2074 6865    where k is the
+00017700: 2069 6e64 6578 206f 6620 6564 6765 2069   index of edge i
+00017710: 6d70 6163 7465 6420 6f6e 2074 6865 206a  mpacted on the j
+00017720: 2d74 6820 7375 6220 7374 7275 6374 7572  -th sub structur
+00017730: 6520 6f66 2074 6865 0a20 2020 2020 2020  e of the.       
+00017740: 7374 7275 6374 7572 6520 6e75 6d62 6572  structure number
+00017750: 2069 2e20 4966 2074 6865 204c 4f53 2069   i. If the LOS i
+00017760: 6d70 6163 7465 6420 7468 6520 7665 7373  mpacted the vess
+00017770: 656c 2069 3d6a 3d30 0a20 2020 2022 2222  el i=j=0.    """
+00017780: 0a20 2020 2063 6465 6620 7374 7220 7674  .    cdef str vt
+00017790: 5f6c 6f77 6572 203d 2076 6573 5f74 7970  _lower = ves_typ
+000177a0: 652e 6c6f 7765 7228 290a 2020 2020 6364  e.lower().    cd
+000177b0: 6566 2073 7472 2065 7272 6f72 5f6d 6573  ef str error_mes
+000177c0: 7361 6765 0a20 2020 2063 6465 6620 696e  sage.    cdef in
+000177d0: 7420 737a 5f76 6573 5f6c 696d 730a 2020  t sz_ves_lims.  
+000177e0: 2020 6364 6566 2069 6e74 206e 6c6f 7320    cdef int nlos 
+000177f0: 3d20 7261 795f 6f72 6967 2e73 6861 7065  = ray_orig.shape
+00017800: 5b31 5d0a 2020 2020 6364 6566 2069 6e74  [1].    cdef int
+00017810: 206e 7074 735f 706f 6c79 203d 2076 6573   npts_poly = ves
+00017820: 5f6e 6f72 6d2e 7368 6170 655b 315d 0a20  _norm.shape[1]. 
+00017830: 2020 2063 6465 6620 6269 6e74 2062 6f6f     cdef bint boo
+00017840: 6c31 2c20 626f 6f6c 320a 2020 2020 6364  l1, bool2.    cd
+00017850: 6566 2064 6f75 626c 6520 6d69 6e5f 706f  ef double min_po
+00017860: 6c79 5f72 0a20 2020 2063 6465 6620 6172  ly_r.    cdef ar
+00017870: 7261 7920 7670 6572 705f 6f75 7420 3d20  ray vperp_out = 
+00017880: 636c 6f6e 6528 6172 7261 7928 2764 2729  clone(array('d')
+00017890: 2c20 6e6c 6f73 202a 2033 2c20 5472 7565  , nlos * 3, True
+000178a0: 290a 2020 2020 6364 6566 2061 7272 6179  ).    cdef array
+000178b0: 2063 6f65 6666 5f69 6e74 6572 5f69 6e20   coeff_inter_in 
+000178c0: 203d 2063 6c6f 6e65 2861 7272 6179 2827   = clone(array('
+000178d0: 6427 292c 206e 6c6f 732c 2054 7275 6529  d'), nlos, True)
+000178e0: 0a20 2020 2063 6465 6620 6172 7261 7920  .    cdef array 
+000178f0: 636f 6566 665f 696e 7465 725f 6f75 7420  coeff_inter_out 
+00017900: 3d20 636c 6f6e 6528 6172 7261 7928 2764  = clone(array('d
+00017910: 2729 2c20 6e6c 6f73 2c20 5472 7565 290a  '), nlos, True).
+00017920: 2020 2020 6364 6566 2061 7272 6179 2069      cdef array i
+00017930: 6e64 5f69 6e74 6572 5f6f 7574 203d 2063  nd_inter_out = c
+00017940: 6c6f 6e65 2861 7272 6179 2827 6927 292c  lone(array('i'),
+00017950: 206e 6c6f 7320 2a20 332c 2054 7275 6529   nlos * 3, True)
+00017960: 0a20 2020 2063 6465 6620 646f 7562 6c65  .    cdef double
+00017970: 5b3a 3a31 5d20 6c73 7472 7563 745f 6c69  [::1] lstruct_li
+00017980: 6d73 5f6e 700a 2020 2020 2320 3d3d 2054  ms_np.    # == T
+00017990: 6573 7469 6e67 2069 6e70 7574 7320 3d3d  esting inputs ==
+000179a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000179b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000179c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000179d0: 3d3d 3d3d 3d3d 0a20 2020 2069 6620 7465  ======.    if te
+000179e0: 7374 3a0a 2020 2020 2020 2020 6572 726f  st:.        erro
+000179f0: 725f 6d65 7373 6167 6520 3d20 2272 6179  r_message = "ray
+00017a00: 5f6f 7269 6720 616e 6420 7261 795f 7664  _orig and ray_vd
+00017a10: 6972 206d 7573 7420 6861 7665 2074 6865  ir must have the
+00017a20: 2073 616d 6520 7368 6170 653a 2022 5c0a   same shape: "\.
+00017a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017a40: 2020 2020 2020 2020 2b20 2228 332c 2920          + "(3,) 
+00017a50: 6f72 2028 332c 4e4c 2921 220a 2020 2020  or (3,NL)!".    
+00017a60: 2020 2020 6173 7365 7274 2074 7570 6c65      assert tuple
+00017a70: 2872 6179 5f6f 7269 672e 7368 6170 6529  (ray_orig.shape)
+00017a80: 203d 3d20 7475 706c 6528 7261 795f 7664   == tuple(ray_vd
+00017a90: 6972 2e73 6861 7065 2920 616e 6420 5c0a  ir.shape) and \.
+00017aa0: 2020 2020 2020 2020 2020 7261 795f 6f72            ray_or
+00017ab0: 6967 2e73 6861 7065 5b30 5d20 3d3d 2033  ig.shape[0] == 3
+00017ac0: 2c20 6572 726f 725f 6d65 7373 6167 650a  , error_message.
+00017ad0: 2020 2020 2020 2020 6572 726f 725f 6d65          error_me
+00017ae0: 7373 6167 6520 3d20 2276 6573 5f70 6f6c  ssage = "ves_pol
+00017af0: 7920 616e 6420 7665 735f 6e6f 726d 206d  y and ves_norm m
+00017b00: 7573 7420 6861 7665 2074 6865 2073 616d  ust have the sam
+00017b10: 6520 7368 6170 6520 2832 2c4e 5329 2122  e shape (2,NS)!"
+00017b20: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00017b30: 7665 735f 706f 6c79 2e73 6861 7065 5b30  ves_poly.shape[0
+00017b40: 5d20 3d3d 2032 2061 6e64 2076 6573 5f6e  ] == 2 and ves_n
+00017b50: 6f72 6d2e 7368 6170 655b 305d 203d 3d20  orm.shape[0] == 
+00017b60: 322c 2065 7272 6f72 5f6d 6573 7361 6765  2, error_message
+00017b70: 0a20 2020 2020 2020 2062 6f6f 6c31 203d  .        bool1 =
+00017b80: 206c 7374 7275 6374 5f6c 696d 7320 6973   lstruct_lims is
+00017b90: 204e 6f6e 6520 6f72 206c 656e 286c 7374   None or len(lst
+00017ba0: 7275 6374 5f6e 6f72 6d79 2920 3d3d 206c  ruct_normy) == l
+00017bb0: 656e 286c 7374 7275 6374 5f6e 6f72 6d79  en(lstruct_normy
+00017bc0: 290a 2020 2020 2020 2020 626f 6f6c 3220  ).        bool2 
+00017bd0: 3d20 6c73 7472 7563 745f 6e6f 726d 7820  = lstruct_normx 
+00017be0: 6973 204e 6f6e 6520 6f72 206c 656e 286c  is None or len(l
+00017bf0: 7374 7275 6374 5f70 6f6c 7978 2920 3d3d  struct_polyx) ==
+00017c00: 206c 656e 286c 7374 7275 6374 5f70 6f6c   len(lstruct_pol
+00017c10: 7979 290a 2020 2020 2020 2020 6572 726f  yy).        erro
+00017c20: 725f 6d65 7373 6167 6520 3d20 226c 7374  r_message = "lst
+00017c30: 7275 6374 5f70 6f6c 792c 206c 7374 7275  ruct_poly, lstru
+00017c40: 6374 5f6c 696d 732c 206c 7374 7275 6374  ct_lims, lstruct
+00017c50: 5f6e 6f72 6d20 6d75 7374 2062 6520 4e6f  _norm must be No
+00017c60: 6e65 225c 0a20 2020 2020 2020 2020 2020  ne"\.           
+00017c70: 2020 2020 2020 2020 2020 2020 202b 2022               + "
+00017c80: 206f 7220 6c69 7374 7320 6f66 2073 616d   or lists of sam
+00017c90: 6520 6c65 6e21 220a 2020 2020 2020 2020  e len!".        
+00017ca0: 6173 7365 7274 2062 6f6f 6c31 2061 6e64  assert bool1 and
+00017cb0: 2062 6f6f 6c32 2c20 6572 726f 725f 6d65   bool2, error_me
+00017cc0: 7373 6167 650a 2020 2020 2020 2020 6572  ssage.        er
+00017cd0: 726f 725f 6d65 7373 6167 6520 3d20 225b  ror_message = "[
+00017ce0: 6570 735f 757a 2c65 7073 5f76 7a2c 6570  eps_uz,eps_vz,ep
+00017cf0: 735f 612c 6570 735f 625d 206d 7573 7420  s_a,eps_b] must 
+00017d00: 6265 2066 6c6f 6174 7320 3c20 312e 652d  be floats < 1.e-
+00017d10: 3421 220a 2020 2020 2020 2020 6173 7365  4!".        asse
+00017d20: 7274 2061 6c6c 285b 6565 203c 2031 2e65  rt all([ee < 1.e
+00017d30: 2d34 2066 6f72 2065 6520 696e 205b 6570  -4 for ee in [ep
+00017d40: 735f 757a 2c20 6570 735f 612c 0a20 2020  s_uz, eps_a,.   
+00017d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00017d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017d80: 2065 7073 5f70 6c61 6e65 5d5d 292c 2065   eps_plane]]), e
-00017d90: 7272 6f72 5f6d 6573 7361 6765 0a20 2020  rror_message.   
-00017da0: 2020 2020 2065 7272 6f72 5f6d 6573 7361       error_messa
-00017db0: 6765 203d 2022 7665 735f 7479 7065 206d  ge = "ves_type m
-00017dc0: 7573 7420 6265 2061 2073 7472 2069 6e20  ust be a str in 
-00017dd0: 5b27 546f 7227 2c27 4c69 6e27 5d21 220a  ['Tor','Lin']!".
-00017de0: 2020 2020 2020 2020 6173 7365 7274 2076          assert v
-00017df0: 745f 6c6f 7765 7220 696e 205b 2774 6f72  t_lower in ['tor
-00017e00: 272c 2027 6c69 6e27 5d2c 2065 7272 6f72  ', 'lin'], error
-00017e10: 5f6d 6573 7361 6765 0a20 2020 2020 2020  _message.       
-00017e20: 2065 7272 6f72 5f6d 6573 7361 6765 203d   error_message =
-00017e30: 2022 4966 2079 6f75 2064 6566 696e 6520   "If you define 
-00017e40: 7374 7275 6374 7572 6573 2079 6f75 206d  structures you m
-00017e50: 7573 7420 6465 6669 6e65 2061 6c6c 2074  ust define all t
-00017e60: 6865 2022 5c0a 2020 2020 2020 2020 2020  he "\.          
-00017e70: 2020 2020 2020 2020 2020 2020 2020 2b20                + 
-00017e80: 2273 7472 7563 7475 7261 6c20 7661 7269  "structural vari
-00017e90: 6162 6c65 733a 205c 6e22 5c0a 2020 2020  ables: \n"\.    
-00017ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017eb0: 2020 2020 2b20 2220 2020 202d 206c 7374      + "    - lst
-00017ec0: 7275 6374 5f70 6f6c 7978 2c20 6c73 7472  ruct_polyx, lstr
-00017ed0: 7563 745f 706f 6c79 792c 206c 7374 7275  uct_polyy, lstru
-00017ee0: 6374 5f6c 696d 732c 5c6e 225c 0a20 2020  ct_lims,\n"\.   
-00017ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017f00: 2020 2020 202b 2022 2020 2020 2d20 6c73       + "    - ls
-00017f10: 7472 7563 745f 6e6c 696d 2c20 6e73 7472  truct_nlim, nstr
-00017f20: 7563 745f 746f 742c 206e 7374 7275 6374  uct_tot, nstruct
-00017f30: 5f6c 696d 2c5c 6e22 5c0a 2020 2020 2020  _lim,\n"\.      
-00017f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017f50: 2020 2b20 2220 2020 202d 206c 6e76 6572    + "    - lnver
-00017f60: 742c 206c 7374 7275 6374 5f6e 6f72 6d78  t, lstruct_normx
-00017f70: 2c20 6c73 7472 7563 745f 6e6f 726d 795c  , lstruct_normy\
-00017f80: 6e22 0a20 2020 2020 2020 2062 6f6f 6c31  n".        bool1
-00017f90: 203d 2028 286c 7374 7275 6374 5f70 6f6c   = ((lstruct_pol
-00017fa0: 7978 2069 7320 6e6f 7420 4e6f 6e65 290a  yx is not None).
-00017fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017fc0: 206f 7220 286c 7374 7275 6374 5f70 6f6c   or (lstruct_pol
-00017fd0: 7979 2069 7320 6e6f 7420 4e6f 6e65 290a  yy is not None).
+00017d70: 2020 2020 2020 2065 7073 5f76 7a2c 2065         eps_vz, e
+00017d80: 7073 5f62 2c0a 2020 2020 2020 2020 2020  ps_b,.          
+00017d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017db0: 6570 735f 706c 616e 655d 5d29 2c20 6572  eps_plane]]), er
+00017dc0: 726f 725f 6d65 7373 6167 650a 2020 2020  ror_message.    
+00017dd0: 2020 2020 6572 726f 725f 6d65 7373 6167      error_messag
+00017de0: 6520 3d20 2276 6573 5f74 7970 6520 6d75  e = "ves_type mu
+00017df0: 7374 2062 6520 6120 7374 7220 696e 205b  st be a str in [
+00017e00: 2754 6f72 272c 274c 696e 275d 2122 0a20  'Tor','Lin']!". 
+00017e10: 2020 2020 2020 2061 7373 6572 7420 7674         assert vt
+00017e20: 5f6c 6f77 6572 2069 6e20 5b27 746f 7227  _lower in ['tor'
+00017e30: 2c20 276c 696e 275d 2c20 6572 726f 725f  , 'lin'], error_
+00017e40: 6d65 7373 6167 650a 2020 2020 2020 2020  message.        
+00017e50: 6572 726f 725f 6d65 7373 6167 6520 3d20  error_message = 
+00017e60: 2249 6620 796f 7520 6465 6669 6e65 2073  "If you define s
+00017e70: 7472 7563 7475 7265 7320 796f 7520 6d75  tructures you mu
+00017e80: 7374 2064 6566 696e 6520 616c 6c20 7468  st define all th
+00017e90: 6520 225c 0a20 2020 2020 2020 2020 2020  e "\.           
+00017ea0: 2020 2020 2020 2020 2020 2020 202b 2022               + "
+00017eb0: 7374 7275 6374 7572 616c 2076 6172 6961  structural varia
+00017ec0: 626c 6573 3a20 5c6e 225c 0a20 2020 2020  bles: \n"\.     
+00017ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017ee0: 2020 202b 2022 2020 2020 2d20 6c73 7472     + "    - lstr
+00017ef0: 7563 745f 706f 6c79 782c 206c 7374 7275  uct_polyx, lstru
+00017f00: 6374 5f70 6f6c 7979 2c20 6c73 7472 7563  ct_polyy, lstruc
+00017f10: 745f 6c69 6d73 2c5c 6e22 5c0a 2020 2020  t_lims,\n"\.    
+00017f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017f30: 2020 2020 2b20 2220 2020 202d 206c 7374      + "    - lst
+00017f40: 7275 6374 5f6e 6c69 6d2c 206e 7374 7275  ruct_nlim, nstru
+00017f50: 6374 5f74 6f74 2c20 6e73 7472 7563 745f  ct_tot, nstruct_
+00017f60: 6c69 6d2c 5c6e 225c 0a20 2020 2020 2020  lim,\n"\.       
+00017f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017f80: 202b 2022 2020 2020 2d20 6c6e 7665 7274   + "    - lnvert
+00017f90: 2c20 6c73 7472 7563 745f 6e6f 726d 782c  , lstruct_normx,
+00017fa0: 206c 7374 7275 6374 5f6e 6f72 6d79 5c6e   lstruct_normy\n
+00017fb0: 220a 2020 2020 2020 2020 626f 6f6c 3120  ".        bool1 
+00017fc0: 3d20 2828 6c73 7472 7563 745f 706f 6c79  = ((lstruct_poly
+00017fd0: 7820 6973 206e 6f74 204e 6f6e 6529 0a20  x is not None). 
 00017fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017ff0: 206f 7220 286c 7374 7275 6374 5f6e 6f72   or (lstruct_nor
-00018000: 6d78 2069 7320 6e6f 7420 4e6f 6e65 290a  mx is not None).
+00017ff0: 6f72 2028 6c73 7472 7563 745f 706f 6c79  or (lstruct_poly
+00018000: 7920 6973 206e 6f74 204e 6f6e 6529 0a20  y is not None). 
 00018010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018020: 206f 7220 286c 7374 7275 6374 5f6e 6f72   or (lstruct_nor
-00018030: 6d79 2069 7320 6e6f 7420 4e6f 6e65 290a  my is not None).
+00018020: 6f72 2028 6c73 7472 7563 745f 6e6f 726d  or (lstruct_norm
+00018030: 7820 6973 206e 6f74 204e 6f6e 6529 0a20  x is not None). 
 00018040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018050: 206f 7220 286c 7374 7275 6374 5f6e 6c69   or (lstruct_nli
-00018060: 6d20 6973 206e 6f74 204e 6f6e 6529 0a20  m is not None). 
+00018050: 6f72 2028 6c73 7472 7563 745f 6e6f 726d  or (lstruct_norm
+00018060: 7920 6973 206e 6f74 204e 6f6e 6529 0a20  y is not None). 
 00018070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018080: 6f72 2028 6c73 7472 7563 745f 6c69 6d73  or (lstruct_lims
+00018080: 6f72 2028 6c73 7472 7563 745f 6e6c 696d  or (lstruct_nlim
 00018090: 2069 7320 6e6f 7420 4e6f 6e65 290a 2020   is not None).  
 000180a0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-000180b0: 7220 286c 6e76 6572 7420 6973 206e 6f74  r (lnvert is not
-000180c0: 204e 6f6e 6529 0a20 2020 2020 2020 2020   None).         
-000180d0: 2020 2020 2020 2020 6f72 2028 6e73 7472          or (nstr
-000180e0: 7563 745f 746f 7420 3e20 3029 206f 7220  uct_tot > 0) or 
-000180f0: 286e 7374 7275 6374 5f6c 696d 203e 2030  (nstruct_lim > 0
-00018100: 2929 0a20 2020 2020 2020 2069 6620 626f  )).        if bo
-00018110: 6f6c 313a 0a20 2020 2020 2020 2020 2020  ol1:.           
-00018120: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-00018130: 2020 2020 2020 626f 6f6c 3120 3d20 2828        bool1 = ((
-00018140: 6c65 6e28 6c73 7472 7563 745f 706f 6c79  len(lstruct_poly
-00018150: 7829 203e 2030 290a 2020 2020 2020 2020  x) > 0).        
-00018160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018170: 206f 7220 286c 656e 286c 7374 7275 6374   or (len(lstruct
-00018180: 5f70 6f6c 7979 2920 3e20 3029 0a20 2020  _polyy) > 0).   
+000180b0: 7220 286c 7374 7275 6374 5f6c 696d 7320  r (lstruct_lims 
+000180c0: 6973 206e 6f74 204e 6f6e 6529 0a20 2020  is not None).   
+000180d0: 2020 2020 2020 2020 2020 2020 2020 6f72                or
+000180e0: 2028 6c6e 7665 7274 2069 7320 6e6f 7420   (lnvert is not 
+000180f0: 4e6f 6e65 290a 2020 2020 2020 2020 2020  None).          
+00018100: 2020 2020 2020 206f 7220 286e 7374 7275         or (nstru
+00018110: 6374 5f74 6f74 203e 2030 2920 6f72 2028  ct_tot > 0) or (
+00018120: 6e73 7472 7563 745f 6c69 6d20 3e20 3029  nstruct_lim > 0)
+00018130: 290a 2020 2020 2020 2020 6966 2062 6f6f  ).        if boo
+00018140: 6c31 3a0a 2020 2020 2020 2020 2020 2020  l1:.            
+00018150: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00018160: 2020 2020 2062 6f6f 6c31 203d 2028 286c       bool1 = ((l
+00018170: 656e 286c 7374 7275 6374 5f70 6f6c 7978  en(lstruct_polyx
+00018180: 2920 3e20 3029 0a20 2020 2020 2020 2020  ) > 0).         
 00018190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000181a0: 2020 2020 2020 6f72 2028 6c65 6e28 6c73        or (len(ls
-000181b0: 7472 7563 745f 6e6f 726d 7829 203e 2030  truct_normx) > 0
-000181c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000181d0: 2020 2020 2020 2020 2020 206f 7220 286c             or (l
-000181e0: 656e 286c 7374 7275 6374 5f6e 6f72 6d79  en(lstruct_normy
-000181f0: 2920 3e20 3029 0a20 2020 2020 2020 2020  ) > 0).         
-00018200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018210: 6f72 2028 6c65 6e28 6c73 7472 7563 745f  or (len(lstruct_
-00018220: 6e6c 696d 2920 3e20 3029 0a20 2020 2020  nlim) > 0).     
-00018230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018240: 2020 2020 6f72 2028 6c65 6e28 6c73 7472      or (len(lstr
-00018250: 7563 745f 6c69 6d73 2920 3e20 3029 0a20  uct_lims) > 0). 
+000181a0: 6f72 2028 6c65 6e28 6c73 7472 7563 745f  or (len(lstruct_
+000181b0: 706f 6c79 7929 203e 2030 290a 2020 2020  polyy) > 0).    
+000181c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000181d0: 2020 2020 206f 7220 286c 656e 286c 7374       or (len(lst
+000181e0: 7275 6374 5f6e 6f72 6d78 2920 3e20 3029  ruct_normx) > 0)
+000181f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018200: 2020 2020 2020 2020 2020 6f72 2028 6c65            or (le
+00018210: 6e28 6c73 7472 7563 745f 6e6f 726d 7929  n(lstruct_normy)
+00018220: 203e 2030 290a 2020 2020 2020 2020 2020   > 0).          
+00018230: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00018240: 7220 286c 656e 286c 7374 7275 6374 5f6e  r (len(lstruct_n
+00018250: 6c69 6d29 203e 2030 290a 2020 2020 2020  lim) > 0).      
 00018260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018270: 2020 2020 2020 2020 6f72 2028 6c65 6e28          or (len(
-00018280: 6c6e 7665 7274 2920 3e20 3029 0a20 2020  lnvert) > 0).   
+00018270: 2020 206f 7220 286c 656e 286c 7374 7275     or (len(lstru
+00018280: 6374 5f6c 696d 7329 203e 2030 290a 2020  ct_lims) > 0).  
 00018290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000182a0: 2020 2020 2020 6f72 2028 6e73 7472 7563        or (nstruc
-000182b0: 745f 746f 7420 3e20 3029 0a20 2020 2020  t_tot > 0).     
+000182a0: 2020 2020 2020 206f 7220 286c 656e 286c         or (len(l
+000182b0: 6e76 6572 7429 203e 2030 290a 2020 2020  nvert) > 0).    
 000182c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000182d0: 2020 2020 6f72 2028 6e73 7472 7563 745f      or (nstruct_
-000182e0: 6c69 6d20 3e20 3029 290a 2020 2020 2020  lim > 0)).      
-000182f0: 2020 2020 2020 2020 2020 626f 6f6c 3220            bool2 
-00018300: 3d20 2828 6c65 6e28 6c73 7472 7563 745f  = ((len(lstruct_
-00018310: 706f 6c79 7829 203e 2030 290a 2020 2020  polyx) > 0).    
-00018320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018330: 2020 2020 2061 6e64 2028 6c65 6e28 6c73       and (len(ls
-00018340: 7472 7563 745f 706f 6c79 7929 203e 2030  truct_polyy) > 0
-00018350: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00018360: 2020 2020 2020 2020 2020 2061 6e64 2028             and (
-00018370: 6c65 6e28 6c73 7472 7563 745f 6e6f 726d  len(lstruct_norm
-00018380: 7829 203e 2030 290a 2020 2020 2020 2020  x) > 0).        
-00018390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000183a0: 2061 6e64 2028 6c65 6e28 6c73 7472 7563   and (len(lstruc
-000183b0: 745f 6e6f 726d 7929 203e 2030 290a 2020  t_normy) > 0).  
+000182d0: 2020 2020 206f 7220 286e 7374 7275 6374       or (nstruct
+000182e0: 5f74 6f74 203e 2030 290a 2020 2020 2020  _tot > 0).      
+000182f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018300: 2020 206f 7220 286e 7374 7275 6374 5f6c     or (nstruct_l
+00018310: 696d 203e 2030 2929 0a20 2020 2020 2020  im > 0)).       
+00018320: 2020 2020 2020 2020 2062 6f6f 6c32 203d           bool2 =
+00018330: 2028 286c 656e 286c 7374 7275 6374 5f70   ((len(lstruct_p
+00018340: 6f6c 7978 2920 3e20 3029 0a20 2020 2020  olyx) > 0).     
+00018350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018360: 2020 2020 616e 6420 286c 656e 286c 7374      and (len(lst
+00018370: 7275 6374 5f70 6f6c 7979 2920 3e20 3029  ruct_polyy) > 0)
+00018380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018390: 2020 2020 2020 2020 2020 616e 6420 286c            and (l
+000183a0: 656e 286c 7374 7275 6374 5f6e 6f72 6d78  en(lstruct_normx
+000183b0: 2920 3e20 3029 0a20 2020 2020 2020 2020  ) > 0).         
 000183c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000183d0: 2020 2020 2020 2061 6e64 2028 6c65 6e28         and (len(
-000183e0: 6c73 7472 7563 745f 6e6c 696d 2920 3e20  lstruct_nlim) > 
-000183f0: 3029 0a20 2020 2020 2020 2020 2020 2020  0).             
-00018400: 2020 2020 2020 2020 2020 2020 616e 6420              and 
-00018410: 286c 656e 286c 7374 7275 6374 5f6c 696d  (len(lstruct_lim
-00018420: 7329 203e 2030 290a 2020 2020 2020 2020  s) > 0).        
-00018430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018440: 2061 6e64 2028 6c65 6e28 6c6e 7665 7274   and (len(lnvert
+000183d0: 616e 6420 286c 656e 286c 7374 7275 6374  and (len(lstruct
+000183e0: 5f6e 6f72 6d79 2920 3e20 3029 0a20 2020  _normy) > 0).   
+000183f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018400: 2020 2020 2020 616e 6420 286c 656e 286c        and (len(l
+00018410: 7374 7275 6374 5f6e 6c69 6d29 203e 2030  struct_nlim) > 0
+00018420: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00018430: 2020 2020 2020 2020 2020 2061 6e64 2028             and (
+00018440: 6c65 6e28 6c73 7472 7563 745f 6c69 6d73  len(lstruct_lims
 00018450: 2920 3e20 3029 0a20 2020 2020 2020 2020  ) > 0).         
 00018460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018470: 616e 6420 286e 7374 7275 6374 5f74 6f74  and (nstruct_tot
+00018470: 616e 6420 286c 656e 286c 6e76 6572 7429  and (len(lnvert)
 00018480: 203e 2030 290a 2020 2020 2020 2020 2020   > 0).          
 00018490: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-000184a0: 6e64 2028 6e73 7472 7563 745f 6c69 6d20  nd (nstruct_lim 
-000184b0: 3e20 3029 290a 2020 2020 2020 2020 2020  > 0)).          
-000184c0: 2020 2020 2020 6173 7365 7274 2028 6e6f        assert (no
-000184d0: 7420 626f 6f6c 3120 6f72 2062 6f6f 6c32  t bool1 or bool2
-000184e0: 292c 2065 7272 6f72 5f6d 6573 7361 6765  ), error_message
-000184f0: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-00018500: 6570 7420 4578 6365 7074 696f 6e3a 0a20  ept Exception:. 
-00018510: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00018520: 7373 6572 7420 4661 6c73 652c 2065 7272  ssert False, err
-00018530: 6f72 5f6d 6573 7361 6765 0a20 2020 2020  or_message.     
-00018540: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00018550: 2020 2020 2062 6f6f 6c32 203d 2028 286c       bool2 = ((l
-00018560: 7374 7275 6374 5f70 6f6c 7978 2069 7320  struct_polyx is 
-00018570: 6e6f 7420 4e6f 6e65 290a 2020 2020 2020  not None).      
-00018580: 2020 2020 2020 2020 2020 2061 6e64 2028             and (
-00018590: 6c73 7472 7563 745f 706f 6c79 7920 6973  lstruct_polyy is
-000185a0: 206e 6f74 204e 6f6e 6529 0a20 2020 2020   not None).     
-000185b0: 2020 2020 2020 2020 2020 2020 616e 6420              and 
-000185c0: 286c 7374 7275 6374 5f6e 6f72 6d78 2069  (lstruct_normx i
-000185d0: 7320 6e6f 7420 4e6f 6e65 290a 2020 2020  s not None).    
-000185e0: 2020 2020 2020 2020 2020 2020 2061 6e64               and
-000185f0: 2028 6c73 7472 7563 745f 6e6f 726d 7920   (lstruct_normy 
-00018600: 6973 206e 6f74 204e 6f6e 6529 0a20 2020  is not None).   
-00018610: 2020 2020 2020 2020 2020 2020 2020 616e                an
-00018620: 6420 286c 7374 7275 6374 5f6e 6c69 6d20  d (lstruct_nlim 
-00018630: 6973 206e 6f74 204e 6f6e 6529 0a20 2020  is not None).   
-00018640: 2020 2020 2020 2020 2020 2020 2020 616e                an
-00018650: 6420 286c 7374 7275 6374 5f6c 696d 7320  d (lstruct_lims 
-00018660: 6973 206e 6f74 204e 6f6e 6529 0a20 2020  is not None).   
-00018670: 2020 2020 2020 2020 2020 2020 2020 616e                an
-00018680: 6420 286c 6e76 6572 7420 6973 206e 6f74  d (lnvert is not
-00018690: 204e 6f6e 6529 0a20 2020 2020 2020 2020   None).         
-000186a0: 2020 2020 2020 2020 616e 6420 286e 7374          and (nst
-000186b0: 7275 6374 5f74 6f74 203e 2030 2920 616e  ruct_tot > 0) an
-000186c0: 6420 286e 7374 7275 6374 5f6c 696d 203e  d (nstruct_lim >
-000186d0: 2030 2929 0a20 2020 2020 2020 2020 2020   0)).           
-000186e0: 2061 7373 6572 7420 286e 6f74 2062 6f6f   assert (not boo
-000186f0: 6c31 206f 7220 626f 6f6c 3229 2c20 6572  l1 or bool2), er
-00018700: 726f 725f 6d65 7373 6167 650a 2020 2020  ror_message.    
-00018710: 2320 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  # ==============
-00018720: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00018730: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00018740: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00018750: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 0a20 2020  ============.   
-00018760: 2069 6620 7665 735f 6c69 6d73 2069 7320   if ves_lims is 
-00018770: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00018780: 2020 737a 5f76 6573 5f6c 696d 7320 3d20    sz_ves_lims = 
-00018790: 6e70 2e73 697a 6528 7665 735f 6c69 6d73  np.size(ves_lims
-000187a0: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
-000187b0: 2020 2020 737a 5f76 6573 5f6c 696d 7320      sz_ves_lims 
-000187c0: 3d20 300a 2020 2020 6d69 6e5f 706f 6c79  = 0.    min_poly
-000187d0: 5f72 203d 205f 6267 742e 636f 6d70 5f6d  _r = _bgt.comp_m
-000187e0: 696e 2876 6573 5f70 6f6c 795b 302c 202e  in(ves_poly[0, .
-000187f0: 2e2e 5d2c 206e 7074 735f 706f 6c79 2d31  ..], npts_poly-1
-00018800: 290a 0a20 2020 206c 7374 7275 6374 5f6c  )..    lstruct_l
-00018810: 696d 735f 6e70 203d 2066 6c61 7474 656e  ims_np = flatten
-00018820: 5f6c 7374 7275 6374 5f6c 696d 7328 6c73  _lstruct_lims(ls
-00018830: 7472 7563 745f 6c69 6d73 290a 2020 2020  truct_lims).    
-00018840: 5f72 742e 636f 6d70 7574 655f 696e 6f75  _rt.compute_inou
-00018850: 745f 746f 7428 6e6c 6f73 2c20 6e70 7473  t_tot(nlos, npts
-00018860: 5f70 6f6c 792c 0a20 2020 2020 2020 2020  _poly,.         
-00018870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018880: 2072 6179 5f6f 7269 672c 2072 6179 5f76   ray_orig, ray_v
-00018890: 6469 722c 0a20 2020 2020 2020 2020 2020  dir,.           
-000188a0: 2020 2020 2020 2020 2020 2020 2020 2076                 v
-000188b0: 6573 5f70 6f6c 792c 2076 6573 5f6e 6f72  es_poly, ves_nor
-000188c0: 6d2c 0a20 2020 2020 2020 2020 2020 2020  m,.             
-000188d0: 2020 2020 2020 2020 2020 2020 206c 7374               lst
-000188e0: 7275 6374 5f6e 6c69 6d2c 2076 6573 5f6c  ruct_nlim, ves_l
-000188f0: 696d 732c 0a20 2020 2020 2020 2020 2020  ims,.           
-00018900: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00018910: 7374 7275 6374 5f70 6f6c 7978 2c20 6c73  struct_polyx, ls
-00018920: 7472 7563 745f 706f 6c79 792c 0a20 2020  truct_polyy,.   
-00018930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018940: 2020 2020 2020 206c 7374 7275 6374 5f6c         lstruct_l
-00018950: 696d 735f 6e70 2c20 6c73 7472 7563 745f  ims_np, lstruct_
-00018960: 6e6f 726d 782c 0a20 2020 2020 2020 2020  normx,.         
-00018970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018980: 206c 7374 7275 6374 5f6e 6f72 6d79 2c20   lstruct_normy, 
-00018990: 6c6e 7665 7274 2c0a 2020 2020 2020 2020  lnvert,.        
+000184a0: 6e64 2028 6e73 7472 7563 745f 746f 7420  nd (nstruct_tot 
+000184b0: 3e20 3029 0a20 2020 2020 2020 2020 2020  > 0).           
+000184c0: 2020 2020 2020 2020 2020 2020 2020 616e                an
+000184d0: 6420 286e 7374 7275 6374 5f6c 696d 203e  d (nstruct_lim >
+000184e0: 2030 2929 0a20 2020 2020 2020 2020 2020   0)).           
+000184f0: 2020 2020 2061 7373 6572 7420 286e 6f74       assert (not
+00018500: 2062 6f6f 6c31 206f 7220 626f 6f6c 3229   bool1 or bool2)
+00018510: 2c20 6572 726f 725f 6d65 7373 6167 650a  , error_message.
+00018520: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+00018530: 7074 2045 7863 6570 7469 6f6e 3a0a 2020  pt Exception:.  
+00018540: 2020 2020 2020 2020 2020 2020 2020 6173                as
+00018550: 7365 7274 2046 616c 7365 2c20 6572 726f  sert False, erro
+00018560: 725f 6d65 7373 6167 650a 2020 2020 2020  r_message.      
+00018570: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00018580: 2020 2020 626f 6f6c 3220 3d20 2828 6c73      bool2 = ((ls
+00018590: 7472 7563 745f 706f 6c79 7820 6973 206e  truct_polyx is n
+000185a0: 6f74 204e 6f6e 6529 0a20 2020 2020 2020  ot None).       
+000185b0: 2020 2020 2020 2020 2020 616e 6420 286c            and (l
+000185c0: 7374 7275 6374 5f70 6f6c 7979 2069 7320  struct_polyy is 
+000185d0: 6e6f 7420 4e6f 6e65 290a 2020 2020 2020  not None).      
+000185e0: 2020 2020 2020 2020 2020 2061 6e64 2028             and (
+000185f0: 6c73 7472 7563 745f 6e6f 726d 7820 6973  lstruct_normx is
+00018600: 206e 6f74 204e 6f6e 6529 0a20 2020 2020   not None).     
+00018610: 2020 2020 2020 2020 2020 2020 616e 6420              and 
+00018620: 286c 7374 7275 6374 5f6e 6f72 6d79 2069  (lstruct_normy i
+00018630: 7320 6e6f 7420 4e6f 6e65 290a 2020 2020  s not None).    
+00018640: 2020 2020 2020 2020 2020 2020 2061 6e64               and
+00018650: 2028 6c73 7472 7563 745f 6e6c 696d 2069   (lstruct_nlim i
+00018660: 7320 6e6f 7420 4e6f 6e65 290a 2020 2020  s not None).    
+00018670: 2020 2020 2020 2020 2020 2020 2061 6e64               and
+00018680: 2028 6c73 7472 7563 745f 6c69 6d73 2069   (lstruct_lims i
+00018690: 7320 6e6f 7420 4e6f 6e65 290a 2020 2020  s not None).    
+000186a0: 2020 2020 2020 2020 2020 2020 2061 6e64               and
+000186b0: 2028 6c6e 7665 7274 2069 7320 6e6f 7420   (lnvert is not 
+000186c0: 4e6f 6e65 290a 2020 2020 2020 2020 2020  None).          
+000186d0: 2020 2020 2020 2061 6e64 2028 6e73 7472         and (nstr
+000186e0: 7563 745f 746f 7420 3e20 3029 2061 6e64  uct_tot > 0) and
+000186f0: 2028 6e73 7472 7563 745f 6c69 6d20 3e20   (nstruct_lim > 
+00018700: 3029 290a 2020 2020 2020 2020 2020 2020  0)).            
+00018710: 6173 7365 7274 2028 6e6f 7420 626f 6f6c  assert (not bool
+00018720: 3120 6f72 2062 6f6f 6c32 292c 2065 7272  1 or bool2), err
+00018730: 6f72 5f6d 6573 7361 6765 0a20 2020 2023  or_message.    #
+00018740: 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d   ===============
+00018750: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00018760: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00018770: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00018780: 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 2020 2020  ===========.    
+00018790: 6966 2076 6573 5f6c 696d 7320 6973 206e  if ves_lims is n
+000187a0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+000187b0: 2073 7a5f 7665 735f 6c69 6d73 203d 206e   sz_ves_lims = n
+000187c0: 702e 7369 7a65 2876 6573 5f6c 696d 7329  p.size(ves_lims)
+000187d0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+000187e0: 2020 2073 7a5f 7665 735f 6c69 6d73 203d     sz_ves_lims =
+000187f0: 2030 0a20 2020 206d 696e 5f70 6f6c 795f   0.    min_poly_
+00018800: 7220 3d20 5f62 6774 2e63 6f6d 705f 6d69  r = _bgt.comp_mi
+00018810: 6e28 7665 735f 706f 6c79 5b30 2c20 2e2e  n(ves_poly[0, ..
+00018820: 2e5d 2c20 6e70 7473 5f70 6f6c 792d 3129  .], npts_poly-1)
+00018830: 0a0a 2020 2020 6c73 7472 7563 745f 6c69  ..    lstruct_li
+00018840: 6d73 5f6e 7020 3d20 666c 6174 7465 6e5f  ms_np = flatten_
+00018850: 6c73 7472 7563 745f 6c69 6d73 286c 7374  lstruct_lims(lst
+00018860: 7275 6374 5f6c 696d 7329 0a20 2020 205f  ruct_lims).    _
+00018870: 7274 2e63 6f6d 7075 7465 5f69 6e6f 7574  rt.compute_inout
+00018880: 5f74 6f74 286e 6c6f 732c 206e 7074 735f  _tot(nlos, npts_
+00018890: 706f 6c79 2c0a 2020 2020 2020 2020 2020  poly,.          
+000188a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000188b0: 7261 795f 6f72 6967 2c20 7261 795f 7664  ray_orig, ray_vd
+000188c0: 6972 2c0a 2020 2020 2020 2020 2020 2020  ir,.            
+000188d0: 2020 2020 2020 2020 2020 2020 2020 7665                ve
+000188e0: 735f 706f 6c79 2c20 7665 735f 6e6f 726d  s_poly, ves_norm
+000188f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00018900: 2020 2020 2020 2020 2020 2020 6c73 7472              lstr
+00018910: 7563 745f 6e6c 696d 2c20 7665 735f 6c69  uct_nlim, ves_li
+00018920: 6d73 2c0a 2020 2020 2020 2020 2020 2020  ms,.            
+00018930: 2020 2020 2020 2020 2020 2020 2020 6c73                ls
+00018940: 7472 7563 745f 706f 6c79 782c 206c 7374  truct_polyx, lst
+00018950: 7275 6374 5f70 6f6c 7979 2c0a 2020 2020  ruct_polyy,.    
+00018960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018970: 2020 2020 2020 6c73 7472 7563 745f 6c69        lstruct_li
+00018980: 6d73 5f6e 702c 206c 7374 7275 6374 5f6e  ms_np, lstruct_n
+00018990: 6f72 6d78 2c0a 2020 2020 2020 2020 2020  ormx,.          
 000189a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000189b0: 2020 6e73 7472 7563 745f 746f 742c 206e    nstruct_tot, n
-000189c0: 7374 7275 6374 5f6c 696d 2c0a 2020 2020  struct_lim,.    
+000189b0: 6c73 7472 7563 745f 6e6f 726d 792c 206c  lstruct_normy, l
+000189c0: 6e76 6572 742c 0a20 2020 2020 2020 2020  nvert,.         
 000189d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000189e0: 2020 2020 2020 737a 5f76 6573 5f6c 696d        sz_ves_lim
-000189f0: 732c 206d 696e 5f70 6f6c 795f 722c 2072  s, min_poly_r, r
-00018a00: 6d69 6e2c 0a20 2020 2020 2020 2020 2020  min,.           
-00018a10: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00018a20: 7073 5f75 7a2c 2065 7073 5f61 2c20 6570  ps_uz, eps_a, ep
-00018a30: 735f 767a 2c20 6570 735f 622c 0a20 2020  s_vz, eps_b,.   
-00018a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018a50: 2020 2020 2020 2065 7073 5f70 6c61 6e65         eps_plane
-00018a60: 2c20 7674 5f6c 6f77 6572 3d3d 2774 6f72  , vt_lower=='tor
-00018a70: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00018a80: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00018a90: 6269 642c 206e 756d 5f74 6872 6561 6473  bid, num_threads
+000189e0: 206e 7374 7275 6374 5f74 6f74 2c20 6e73   nstruct_tot, ns
+000189f0: 7472 7563 745f 6c69 6d2c 0a20 2020 2020  truct_lim,.     
+00018a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018a10: 2020 2020 2073 7a5f 7665 735f 6c69 6d73       sz_ves_lims
+00018a20: 2c20 6d69 6e5f 706f 6c79 5f72 2c20 726d  , min_poly_r, rm
+00018a30: 696e 2c0a 2020 2020 2020 2020 2020 2020  in,.            
+00018a40: 2020 2020 2020 2020 2020 2020 2020 6570                ep
+00018a50: 735f 757a 2c20 6570 735f 612c 2065 7073  s_uz, eps_a, eps
+00018a60: 5f76 7a2c 2065 7073 5f62 2c0a 2020 2020  _vz, eps_b,.    
+00018a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018a80: 2020 2020 2020 6570 735f 706c 616e 652c        eps_plane,
+00018a90: 2076 745f 6c6f 7765 723d 3d27 746f 7227   vt_lower=='tor'
 00018aa0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00018ab0: 2020 2020 2020 2020 2020 2020 636f 6566              coef
-00018ac0: 665f 696e 7465 725f 6f75 742c 2063 6f65  f_inter_out, coe
-00018ad0: 6666 5f69 6e74 6572 5f69 6e2c 2076 7065  ff_inter_in, vpe
-00018ae0: 7270 5f6f 7574 2c0a 2020 2020 2020 2020  rp_out,.        
-00018af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018b00: 2020 696e 645f 696e 7465 725f 6f75 7429    ind_inter_out)
-00018b10: 0a20 2020 2072 6574 7572 6e20 6e70 2e61  .    return np.a
-00018b20: 7361 7272 6179 2863 6f65 6666 5f69 6e74  sarray(coeff_int
-00018b30: 6572 5f69 6e29 2c20 6e70 2e61 7361 7272  er_in), np.asarr
-00018b40: 6179 2863 6f65 6666 5f69 6e74 6572 5f6f  ay(coeff_inter_o
-00018b50: 7574 292c 5c0a 2020 2020 2020 2020 2020  ut),\.          
-00018b60: 206e 702e 7472 616e 7370 6f73 6528 6e70   np.transpose(np
-00018b70: 2e61 7361 7272 6179 2876 7065 7270 5f6f  .asarray(vperp_o
-00018b80: 7574 292e 7265 7368 6170 6528 6e6c 6f73  ut).reshape(nlos
-00018b90: 2c33 2929 2c5c 0a20 2020 2020 2020 2020  ,3)),\.         
-00018ba0: 2020 6e70 2e74 7261 6e73 706f 7365 286e    np.transpose(n
-00018bb0: 702e 6173 6172 7261 7928 696e 645f 696e  p.asarray(ind_in
-00018bc0: 7465 725f 6f75 742c 0a20 2020 2020 2020  ter_out,.       
-00018bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018be0: 2020 2020 2020 2020 2020 2020 6474 7970              dtyp
-00018bf0: 653d 696e 7429 2e72 6573 6861 7065 286e  e=int).reshape(n
-00018c00: 6c6f 732c 2033 2929 0a0a 0a23 203d 3d3d  los, 3))...# ===
-00018c10: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00018c20: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00018c30: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00018ab0: 2020 2020 2020 2020 2020 2020 666f 7262              forb
+00018ac0: 6964 2c20 6e75 6d5f 7468 7265 6164 732c  id, num_threads,
+00018ad0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018ae0: 2020 2020 2020 2020 2020 2063 6f65 6666             coeff
+00018af0: 5f69 6e74 6572 5f6f 7574 2c20 636f 6566  _inter_out, coef
+00018b00: 665f 696e 7465 725f 696e 2c20 7670 6572  f_inter_in, vper
+00018b10: 705f 6f75 742c 0a20 2020 2020 2020 2020  p_out,.         
+00018b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018b30: 2069 6e64 5f69 6e74 6572 5f6f 7574 290a   ind_inter_out).
+00018b40: 2020 2020 7265 7475 726e 206e 702e 6173      return np.as
+00018b50: 6172 7261 7928 636f 6566 665f 696e 7465  array(coeff_inte
+00018b60: 725f 696e 292c 206e 702e 6173 6172 7261  r_in), np.asarra
+00018b70: 7928 636f 6566 665f 696e 7465 725f 6f75  y(coeff_inter_ou
+00018b80: 7429 2c5c 0a20 2020 2020 2020 2020 2020  t),\.           
+00018b90: 6e70 2e74 7261 6e73 706f 7365 286e 702e  np.transpose(np.
+00018ba0: 6173 6172 7261 7928 7670 6572 705f 6f75  asarray(vperp_ou
+00018bb0: 7429 2e72 6573 6861 7065 286e 6c6f 732c  t).reshape(nlos,
+00018bc0: 3329 292c 5c0a 2020 2020 2020 2020 2020  3)),\.          
+00018bd0: 206e 702e 7472 616e 7370 6f73 6528 6e70   np.transpose(np
+00018be0: 2e61 7361 7272 6179 2869 6e64 5f69 6e74  .asarray(ind_int
+00018bf0: 6572 5f6f 7574 2c0a 2020 2020 2020 2020  er_out,.        
+00018c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018c10: 2020 2020 2020 2020 2020 2064 7479 7065             dtype
+00018c20: 3d69 6e74 292e 7265 7368 6170 6528 6e6c  =int).reshape(nl
+00018c30: 6f73 2c20 3329 290a 0a0a 2320 3d3d 3d3d  os, 3))...# ====
 00018c40: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00018c50: 3d3d 3d3d 3d3d 3d3d 3d3d 0a23 203d 2052  ==========.# = R
-00018c60: 6179 2074 7261 6369 6e67 2077 6865 6e20  ay tracing when 
-00018c70: 7765 206f 6e6c 7920 7761 6e74 206b 4d69  we only want kMi
-00018c80: 6e20 2f20 6b4d 6178 0a23 202d 2020 2028  n / kMax.# -   (
-00018c90: 7573 6566 756c 2077 6865 6e20 776f 726b  useful when work
-00018ca0: 696e 6720 7769 7468 2066 6c75 7820 7375  ing with flux su
-00018cb0: 7266 6163 6573 290a 2320 3d3d 3d3d 3d3d  rfaces).# ======
-00018cc0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00018cd0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00018ce0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00018c50: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00018c60: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00018c70: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00018c80: 3d3d 3d3d 3d3d 3d3d 3d0a 2320 3d20 5261  =========.# = Ra
+00018c90: 7920 7472 6163 696e 6720 7768 656e 2077  y tracing when w
+00018ca0: 6520 6f6e 6c79 2077 616e 7420 6b4d 696e  e only want kMin
+00018cb0: 202f 206b 4d61 780a 2320 2d20 2020 2875   / kMax.# -   (u
+00018cc0: 7365 6675 6c20 7768 656e 2077 6f72 6b69  seful when worki
+00018cd0: 6e67 2077 6974 6820 666c 7578 2073 7572  ng with flux sur
+00018ce0: 6661 6365 7329 0a23 203d 3d3d 3d3d 3d3d  faces).# =======
 00018cf0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00018d00: 3d3d 3d3d 3d3d 3d0a 6465 6620 4c4f 535f  =======.def LOS_
-00018d10: 4361 6c63 5f6b 4d69 6e6b 4d61 785f 5665  Calc_kMinkMax_Ve
-00018d20: 7353 7472 7563 7428 646f 7562 6c65 5b3a  sStruct(double[:
-00018d30: 2c20 3a3a 315d 2072 6179 5f6f 7269 672c  , ::1] ray_orig,
-00018d40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018d60: 2064 6f75 626c 655b 3a2c 203a 3a31 5d20   double[:, ::1] 
-00018d70: 7261 795f 7664 6972 2c0a 2020 2020 2020  ray_vdir,.      
+00018d00: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00018d10: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00018d20: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00018d30: 3d3d 3d3d 3d3d 0a64 6566 204c 4f53 5f43  ======.def LOS_C
+00018d40: 616c 635f 6b4d 696e 6b4d 6178 5f56 6573  alc_kMinkMax_Ves
+00018d50: 5374 7275 6374 2864 6f75 626c 655b 3a2c  Struct(double[:,
+00018d60: 203a 3a31 5d20 7261 795f 6f72 6967 2c0a   ::1] ray_orig,.
+00018d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00018d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018d90: 2020 2020 2020 2020 2020 6c69 7374 2076            list v
-00018da0: 6573 5f70 6f6c 792c 0a20 2020 2020 2020  es_poly,.       
+00018d90: 646f 7562 6c65 5b3a 2c20 3a3a 315d 2072  double[:, ::1] r
+00018da0: 6179 5f76 6469 722c 0a20 2020 2020 2020  ay_vdir,.       
 00018db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00018dc0: 2020 2020 2020 2020 206c 6973 7420 7665           list ve
-00018dd0: 735f 6e6f 726d 2c0a 2020 2020 2020 2020  s_norm,.        
+00018dd0: 735f 706f 6c79 2c0a 2020 2020 2020 2020  s_poly,.        
 00018de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018df0: 2020 2020 2020 2020 696e 7420 6e75 6d5f          int num_
-00018e00: 7375 7266 2c0a 2020 2020 2020 2020 2020  surf,.          
+00018df0: 2020 2020 2020 2020 6c69 7374 2076 6573          list ves
+00018e00: 5f6e 6f72 6d2c 0a20 2020 2020 2020 2020  _norm,.         
 00018e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018e20: 2020 2020 2020 6c6f 6e67 5b3a 3a31 5d20        long[::1] 
-00018e30: 6c6e 7665 7274 2c0a 2020 2020 2020 2020  lnvert,.        
+00018e20: 2020 2020 2020 2069 6e74 206e 756d 5f73         int num_s
+00018e30: 7572 662c 0a20 2020 2020 2020 2020 2020  urf,.           
 00018e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018e50: 2020 2020 2020 2020 646f 7562 6c65 5b3a          double[:
-00018e60: 3a31 5d20 7665 735f 6c69 6d73 3d4e 6f6e  :1] ves_lims=Non
-00018e70: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00018e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018e90: 2020 2064 6f75 626c 6520 726d 696e 3d2d     double rmin=-
-00018ea0: 312c 0a20 2020 2020 2020 2020 2020 2020  1,.             
+00018e50: 2020 2020 206c 6f6e 675b 3a3a 315d 206c       long[::1] l
+00018e60: 6e76 6572 742c 0a20 2020 2020 2020 2020  nvert,.         
+00018e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018e80: 2020 2020 2020 2064 6f75 626c 655b 3a3a         double[::
+00018e90: 315d 2076 6573 5f6c 696d 733d 4e6f 6e65  1] ves_lims=None
+00018ea0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 00018eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018ec0: 2020 2064 6f75 626c 6520 6570 735f 757a     double eps_uz
-00018ed0: 3d5f 534d 414c 4c2c 2064 6f75 626c 6520  =_SMALL, double 
-00018ee0: 6570 735f 613d 5f56 534d 414c 4c2c 0a20  eps_a=_VSMALL,. 
-00018ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018f00: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00018f10: 6f75 626c 6520 6570 735f 767a 3d5f 5653  ouble eps_vz=_VS
-00018f20: 4d41 4c4c 2c20 646f 7562 6c65 2065 7073  MALL, double eps
-00018f30: 5f62 3d5f 5653 4d41 4c4c 2c0a 2020 2020  _b=_VSMALL,.    
-00018f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018f50: 2020 2020 2020 2020 2020 2020 646f 7562              doub
-00018f60: 6c65 2065 7073 5f70 6c61 6e65 3d5f 5653  le eps_plane=_VS
-00018f70: 4d41 4c4c 2c20 7374 7220 7665 735f 7479  MALL, str ves_ty
-00018f80: 7065 3d27 546f 7227 2c0a 2020 2020 2020  pe='Tor',.      
-00018f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018fa0: 2020 2020 2020 2020 2020 6269 6e74 2066            bint f
-00018fb0: 6f72 6269 643d 312c 2062 696e 7420 7465  orbid=1, bint te
-00018fc0: 7374 3d31 2c20 696e 7420 6e75 6d5f 7468  st=1, int num_th
-00018fd0: 7265 6164 733d 3136 293a 0a20 2020 2022  reads=16):.    "
-00018fe0: 2222 0a20 2020 2043 6f6d 7075 7465 7320  "".    Computes 
-00018ff0: 7468 6520 656e 7472 7920 616e 6420 6578  the entry and ex
-00019000: 6974 2070 6f69 6e74 206f 6620 616c 6c20  it point of all 
-00019010: 7072 6f76 6964 6564 204c 4f53 2066 6f72  provided LOS for
-00019020: 2074 6865 2070 726f 7669 6465 640a 2020   the provided.  
-00019030: 2020 706f 6c79 676f 6e73 2028 746f 726f    polygons (toro
-00019040: 6964 616c 206f 7220 6c69 6e65 6172 2920  idal or linear) 
-00019050: 206f 6620 494e 2073 7472 7563 7475 7265   of IN structure
-00019060: 7320 286e 6f6e 2d73 6f6c 6964 2c20 6f72  s (non-solid, or
-00019070: 2060 656d 7074 7960 0a20 2020 2069 6e73   `empty`.    ins
-00019080: 6964 6520 666f 7220 7468 6520 4c4f 5329  ide for the LOS)
-00019090: 2e0a 2020 2020 4174 7465 6e74 696f 6e3a  ..    Attention:
-000190a0: 2074 6865 2073 7572 6661 6365 7320 6361   the surfaces ca
-000190b0: 6e20 6265 206c 696d 6974 6564 2c20 6275  n be limited, bu
-000190c0: 7420 7468 6579 2061 6c6c 2068 6176 6520  t they all have 
-000190d0: 746f 2068 6176 6520 7468 650a 2020 2020  to have the.    
-000190e0: 7361 6d65 206c 696d 6974 7320 6465 6669  same limits defi
-000190f0: 6e65 6420 6279 2028 7665 735f 6c69 6d73  ned by (ves_lims
-00019100: 290a 2020 2020 5265 7475 726e 2074 6865  ).    Return the
-00019110: 2073 6574 206f 6620 6b6d 696e 202f 206b   set of kmin / k
-00019120: 6d61 7820 666f 7220 6561 6368 2049 6e20  max for each In 
-00019130: 7374 7275 6374 2061 6e64 2066 6f72 2065  struct and for e
-00019140: 6163 6820 4c4f 530a 0a20 2020 2050 6172  ach LOS..    Par
-00019150: 616d 730a 2020 2020 3d3d 3d3d 3d3d 0a20  ams.    ======. 
-00019160: 2020 2072 6179 5f6f 7269 6720 3a20 2833     ray_orig : (3
-00019170: 2c20 6e6c 6f73 2920 646f 7562 6c65 2061  , nlos) double a
-00019180: 7272 6179 0a20 2020 2020 2020 4c4f 5320  rray.       LOS 
-00019190: 6f72 6967 696e 2070 6f69 6e74 7320 636f  origin points co
-000191a0: 6f72 6469 6e61 7465 730a 2020 2020 7261  ordinates.    ra
-000191b0: 795f 7664 6972 203a 2028 332c 206e 6c6f  y_vdir : (3, nlo
-000191c0: 7329 2064 6f75 626c 6520 6172 7261 790a  s) double array.
-000191d0: 2020 2020 2020 204c 4f53 206e 6f72 6d61         LOS norma
-000191e0: 6c69 7a65 6420 6469 7265 6374 696f 6e20  lized direction 
-000191f0: 7665 6374 6f72 0a20 2020 206e 756d 5f73  vector.    num_s
-00019200: 7572 6620 3a20 696e 740a 2020 2020 2020  urf : int.      
-00019210: 206e 756d 6265 7220 6f66 2073 7572 6661   number of surfa
-00019220: 7865 732c 2061 6b61 2027 696e 2720 7374  xes, aka 'in' st
-00019230: 7275 6374 7572 6573 206f 7220 2776 6573  ructures or 'ves
-00019240: 7365 6c73 270a 2020 2020 7665 735f 706f  sels'.    ves_po
-00019250: 6c79 203a 2028 6e75 6d5f 7375 7266 2c20  ly : (num_surf, 
-00019260: 322c 206e 756d 5f76 6572 7465 7829 2064  2, num_vertex) d
-00019270: 6f75 626c 6520 6172 7261 790a 2020 2020  ouble array.    
-00019280: 2020 2043 6f6f 7264 696e 6174 6573 206f     Coordinates o
-00019290: 6620 7468 6520 7665 7274 6963 6573 206f  f the vertices o
-000192a0: 6620 7468 6520 506f 6c79 676f 6e20 6465  f the Polygon de
-000192b0: 6669 6e69 6e67 2074 6865 2032 4420 706f  fining the 2D po
-000192c0: 6c6f 6964 616c 0a20 2020 2020 2020 6375  loidal.       cu
-000192d0: 7420 6f66 2074 6865 2060 696e 6020 7374  t of the `in` st
-000192e0: 7275 6374 7572 6573 0a20 2020 2076 6573  ructures.    ves
-000192f0: 5f6e 6f72 6d20 3a20 286e 756d 5f73 7572  _norm : (num_sur
-00019300: 662c 2032 2c20 6e75 6d5f 7665 7274 6578  f, 2, num_vertex
-00019310: 2d31 2920 646f 7562 6c65 2061 7272 6179  -1) double array
-00019320: 0a20 2020 2020 2020 4e6f 726d 616c 2076  .       Normal v
-00019330: 6563 746f 7273 2067 6f69 6e67 2022 696e  ectors going "in
-00019340: 7761 7264 7322 206f 6620 7468 6520 6564  wards" of the ed
-00019350: 6765 7320 6f66 2074 6865 2050 6f6c 7967  ges of the Polyg
-00019360: 6f6e 2064 6566 696e 6564 0a20 2020 2020  on defined.     
-00019370: 2020 6279 2076 6573 5f70 6f6c 790a 2020    by ves_poly.  
-00019380: 2020 7665 735f 6c69 6d73 203a 2061 7272    ves_lims : arr
-00019390: 6179 0a20 2020 2020 2020 436f 6e74 6169  ay.       Contai
-000193a0: 6e73 2074 6865 206c 696d 6974 7320 6d69  ns the limits mi
-000193b0: 6e20 616e 6420 6d61 7820 6f66 2076 6573  n and max of ves
-000193c0: 7365 6c0a 2020 2020 726d 696e 203a 2064  sel.    rmin : d
-000193d0: 6f75 626c 650a 2020 2020 2020 204d 696e  ouble.       Min
-000193e0: 696d 616c 2072 6164 6975 7320 6f66 2076  imal radius of v
-000193f0: 6573 7365 6c20 746f 2074 616b 6520 696e  essel to take in
-00019400: 746f 2063 6f6e 7369 6465 7261 7469 6f6e  to consideration
-00019410: 0a20 2020 2065 7073 3c76 616c 3e20 3a20  .    eps<val> : 
-00019420: 646f 7562 6c65 0a20 2020 2020 2020 536d  double.       Sm
-00019430: 616c 6c20 7661 6c75 652c 2061 6363 6570  all value, accep
-00019440: 7461 6e63 6520 6f66 2065 7272 6f72 0a20  tance of error. 
-00019450: 2020 2076 7479 7065 203a 2073 7472 696e     vtype : strin
-00019460: 670a 2020 2020 2020 2054 7970 6520 6f66  g.       Type of
-00019470: 2076 6573 7365 6c20 2822 546f 7222 206f   vessel ("Tor" o
-00019480: 7220 224c 696e 2229 0a20 2020 2066 6f72  r "Lin").    for
-00019490: 6269 6420 3a20 626f 6f6c 0a20 2020 2020  bid : bool.     
-000194a0: 2020 5368 6f75 6c64 2077 6520 666f 7262    Should we forb
-000194b0: 6964 2076 616c 7565 7320 6265 6869 6e64  id values behind
-000194c0: 2076 6973 6962 6c65 2072 6164 6975 7320   visible radius 
-000194d0: 3f20 2873 6565 2072 6d69 6e29 0a20 2020  ? (see rmin).   
-000194e0: 2074 6573 7420 3a20 626f 6f6c 0a20 2020   test : bool.   
-000194f0: 2020 2020 5368 6f75 6c64 2077 6520 7275      Should we ru
-00019500: 6e20 7465 7374 7320 3f0a 2020 2020 6e75  n tests ?.    nu
-00019510: 6d5f 7468 7265 6164 7320 3a20 696e 740a  m_threads : int.
-00019520: 2020 2020 2020 2054 6865 206e 756d 5f74         The num_t
-00019530: 6872 6561 6473 2061 7267 756d 656e 7420  hreads argument 
-00019540: 696e 6469 6361 7465 7320 686f 7720 6d61  indicates how ma
-00019550: 6e79 2074 6872 6561 6473 2074 6865 2074  ny threads the t
-00019560: 6561 6d20 7368 6f75 6c64 0a20 2020 2020  eam should.     
-00019570: 2020 636f 6e73 6973 7420 6f66 2e20 4966    consist of. If
-00019580: 206e 6f74 2067 6976 656e 2c20 4f70 656e   not given, Open
-00019590: 4d50 2077 696c 6c20 6465 6369 6465 2068  MP will decide h
-000195a0: 6f77 206d 616e 7920 7468 7265 6164 7320  ow many threads 
-000195b0: 746f 2075 7365 2e0a 2020 2020 2020 2054  to use..       T
-000195c0: 7970 6963 616c 6c79 2074 6869 7320 6973  ypically this is
-000195d0: 2074 6865 206e 756d 6265 7220 6f66 2063   the number of c
-000195e0: 6f72 6573 2061 7661 696c 6162 6c65 206f  ores available o
-000195f0: 6e20 7468 6520 6d61 6368 696e 652e 0a20  n the machine.. 
-00019600: 2020 2052 6574 7572 6e0a 2020 2020 3d3d     Return.    ==
-00019610: 3d3d 3d3d 0a20 2020 2063 6f65 6666 5f69  ====.    coeff_i
-00019620: 6e74 6572 5f69 6e20 3a20 286e 756d 5f73  nter_in : (num_s
-00019630: 7572 662c 206e 6c6f 7329 2061 7272 6179  urf, nlos) array
-00019640: 0a20 2020 2020 2020 7363 616c 6172 7320  .       scalars 
-00019650: 6c65 7665 6c20 6f66 2022 696e 2220 696e  level of "in" in
-00019660: 7465 7273 6563 7469 6f6e 206f 6620 7468  tersection of th
-00019670: 6520 4c4f 5320 2869 6620 6b3d 3020 6174  e LOS (if k=0 at
-00019680: 206f 7269 6769 6e29 2066 6f72 0a20 2020   origin) for.   
-00019690: 2020 2020 6561 6368 2073 7572 6661 6365      each surface
-000196a0: 0a20 2020 2020 2020 5b6b 6d69 6e28 7375  .       [kmin(su
-000196b0: 7266 302c 206c 6f73 3029 2c20 6b6d 696e  rf0, los0), kmin
-000196c0: 2873 7572 6630 2c20 6c6f 7331 292c 202e  (surf0, los1), .
-000196d0: 2e2e 2c20 6b6d 696e 2873 7572 6631 2c20  .., kmin(surf1, 
-000196e0: 6c6f 7330 292c 2e2e 2e2e 5d0a 2020 2020  los0),....].    
-000196f0: 636f 6566 665f 696e 7465 725f 6f75 7420  coeff_inter_out 
-00019700: 3a20 286e 756d 5f73 7572 662c 206e 6c6f  : (num_surf, nlo
-00019710: 7329 2061 7272 6179 0a20 2020 2020 2020  s) array.       
-00019720: 7363 616c 6172 7320 6c65 7665 6c20 6f66  scalars level of
-00019730: 2022 6f75 7422 2069 6e74 6572 7365 6374   "out" intersect
-00019740: 696f 6e20 6f66 2074 6865 204c 4f53 2028  ion of the LOS (
-00019750: 6966 206b 3d30 2061 7420 6f72 6967 696e  if k=0 at origin
-00019760: 2920 666f 720a 2020 2020 2020 2065 6163  ) for.       eac
-00019770: 6820 7375 7266 6163 650a 2020 2020 2020  h surface.      
-00019780: 205b 6b6d 6178 2873 7572 6630 2c20 6c6f   [kmax(surf0, lo
-00019790: 7330 292c 206b 6d61 7828 7375 7266 302c  s0), kmax(surf0,
-000197a0: 206c 6f73 3129 2c20 2e2e 2e2c 206b 6d61   los1), ..., kma
-000197b0: 7828 7375 7266 312c 206c 6f73 3029 2c2e  x(surf1, los0),.
-000197c0: 2e2e 2e5d 0a20 2020 2022 2222 0a20 2020  ...].    """.   
-000197d0: 2063 6465 6620 696e 7420 6e70 7473 5f70   cdef int npts_p
-000197e0: 6f6c 790a 2020 2020 6364 6566 2069 6e74  oly.    cdef int
-000197f0: 206e 6c6f 7320 3d20 7261 795f 6f72 6967   nlos = ray_orig
-00019800: 2e73 6861 7065 5b31 5d0a 2020 2020 6364  .shape[1].    cd
-00019810: 6566 2069 6e74 2069 6e64 5f73 7472 7563  ef int ind_struc
-00019820: 7420 3d20 300a 2020 2020 6364 6566 2069  t = 0.    cdef i
-00019830: 6e74 2069 6e64 5f73 7572 660a 2020 2020  nt ind_surf.    
-00019840: 6364 6566 2064 6f75 626c 6520 6372 6974  cdef double crit
-00019850: 325f 6261 7365 203d 2065 7073 5f75 7a20  2_base = eps_uz 
-00019860: 2a20 6570 735f 757a 202f 3430 302e 0a20  * eps_uz /400.. 
-00019870: 2020 2063 6465 6620 646f 7562 6c65 206c     cdef double l
-00019880: 696d 5f6d 696e 203d 2030 2e0a 2020 2020  im_min = 0..    
-00019890: 6364 6566 2064 6f75 626c 6520 6c69 6d5f  cdef double lim_
-000198a0: 6d61 7820 3d20 302e 0a20 2020 2063 6465  max = 0..    cde
-000198b0: 6620 646f 7562 6c65 2072 6d69 6e32 203d  f double rmin2 =
-000198c0: 2030 2e0a 2020 2020 6364 6566 2073 7472   0..    cdef str
-000198d0: 2065 7272 6f72 5f6d 6573 7361 6765 0a20   error_message. 
-000198e0: 2020 2063 6465 6620 6269 6e74 2066 6f72     cdef bint for
-000198f0: 6269 6462 6973 2c20 666f 7262 6964 300a  bidbis, forbid0.
-00019900: 2020 2020 6364 6566 2062 696e 7420 626f      cdef bint bo
-00019910: 6f6c 312c 2062 6f6f 6c32 0a20 2020 2063  ol1, bool2.    c
-00019920: 6465 6620 6172 7261 7920 636f 6566 665f  def array coeff_
-00019930: 696e 7465 725f 696e 2020 3d20 636c 6f6e  inter_in  = clon
-00019940: 6528 6172 7261 7928 2764 2729 2c20 6e6c  e(array('d'), nl
-00019950: 6f73 202a 206e 756d 5f73 7572 662c 2054  os * num_surf, T
-00019960: 7275 6529 0a20 2020 2063 6465 6620 6172  rue).    cdef ar
-00019970: 7261 7920 636f 6566 665f 696e 7465 725f  ray coeff_inter_
-00019980: 6f75 7420 3d20 636c 6f6e 6528 6172 7261  out = clone(arra
-00019990: 7928 2764 2729 2c20 6e6c 6f73 202a 206e  y('d'), nlos * n
-000199a0: 756d 5f73 7572 662c 2054 7275 6529 0a20  um_surf, True). 
-000199b0: 2020 2063 6465 6620 696e 7420 2a6c 6c69     cdef int *lli
-000199c0: 6d69 7473 203d 204e 554c 4c0a 2020 2020  mits = NULL.    
-000199d0: 6364 6566 206c 6f6e 6720 2a6c 737a 5f6c  cdef long *lsz_l
-000199e0: 696d 203d 204e 554c 4c0a 2020 2020 6364  im = NULL.    cd
-000199f0: 6566 2062 696e 7420 6172 655f 6c69 6d69  ef bint are_limi
-00019a00: 7465 640a 2020 2020 6364 6566 2064 6f75  ted.    cdef dou
-00019a10: 626c 655b 325d 206c 626f 756e 6473 5f76  ble[2] lbounds_v
-00019a20: 6573 0a20 2020 2063 6465 6620 646f 7562  es.    cdef doub
-00019a30: 6c65 5b32 5d20 6c69 6d5f 7665 730a 2020  le[2] lim_ves.  
-00019a40: 2020 6364 6566 2064 6f75 626c 655b 3a2c    cdef double[:,
-00019a50: 3a3a 315d 2074 6d70 5f70 6f6c 790a 2020  ::1] tmp_poly.  
-00019a60: 2020 6364 6566 2064 6f75 626c 655b 3a2c    cdef double[:,
-00019a70: 3a3a 315d 2074 6d70 5f6e 6f72 6d0a 2020  ::1] tmp_norm.  
-00019a80: 2020 6364 6566 2064 6f75 626c 652a 2070    cdef double* p
-00019a90: 7472 5f63 6f65 6666 5f69 6e0a 2020 2020  tr_coeff_in.    
-00019aa0: 6364 6566 2064 6f75 626c 652a 2070 7472  cdef double* ptr
-00019ab0: 5f63 6f65 6666 5f6f 7574 0a0a 2020 2020  _coeff_out..    
-00019ac0: 2320 696e 6974 6961 6c69 7a61 7469 6f6e  # initialization
-00019ad0: 7320 2e2e 2e0a 2020 2020 7074 725f 636f  s ....    ptr_co
-00019ae0: 6566 665f 696e 203d 2063 6f65 6666 5f69  eff_in = coeff_i
-00019af0: 6e74 6572 5f69 6e2e 6461 7461 2e61 735f  nter_in.data.as_
-00019b00: 646f 7562 6c65 730a 2020 2020 7074 725f  doubles.    ptr_
-00019b10: 636f 6566 665f 6f75 7420 3d20 636f 6566  coeff_out = coef
-00019b20: 665f 696e 7465 725f 6f75 742e 6461 7461  f_inter_out.data
-00019b30: 2e61 735f 646f 7562 6c65 730a 0a20 2020  .as_doubles..   
-00019b40: 2023 203d 3d20 5465 7374 696e 6720 696e   # == Testing in
-00019b50: 7075 7473 203d 3d3d 3d3d 3d3d 3d3d 3d3d  puts ===========
-00019b60: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00019b70: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00019b80: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 2020  =============.  
-00019b90: 2020 6966 2074 6573 743a 0a20 2020 2020    if test:.     
-00019ba0: 2020 2065 7272 6f72 5f6d 6573 7361 6765     error_message
-00019bb0: 203d 2022 7261 795f 6f72 6967 2061 6e64   = "ray_orig and
-00019bc0: 2072 6179 5f76 6469 7220 6d75 7374 2068   ray_vdir must h
-00019bd0: 6176 6520 7468 6520 7361 6d65 2073 6861  ave the same sha
-00019be0: 7065 3a20 225c 0a20 2020 2020 2020 2020  pe: "\.         
-00019bf0: 2020 2020 2020 2020 2020 2020 2020 202b                 +
-00019c00: 2022 2833 2c29 206f 7220 2833 2c4e 4c29   "(3,) or (3,NL)
-00019c10: 2122 0a20 2020 2020 2020 2061 7373 6572  !".        asser
-00019c20: 7420 7475 706c 6528 7261 795f 6f72 6967  t tuple(ray_orig
-00019c30: 2e73 6861 7065 2920 3d3d 2074 7570 6c65  .shape) == tuple
-00019c40: 2872 6179 5f76 6469 722e 7368 6170 6529  (ray_vdir.shape)
-00019c50: 2061 6e64 205c 0a20 2020 2020 2020 2020   and \.         
-00019c60: 2072 6179 5f6f 7269 672e 7368 6170 655b   ray_orig.shape[
-00019c70: 305d 203d 3d20 332c 2065 7272 6f72 5f6d  0] == 3, error_m
-00019c80: 6573 7361 6765 0a20 2020 2020 2020 2065  essage.        e
-00019c90: 7272 6f72 5f6d 6573 7361 6765 203d 2022  rror_message = "
-00019ca0: 5b65 7073 5f75 7a2c 6570 735f 767a 2c65  [eps_uz,eps_vz,e
-00019cb0: 7073 5f61 2c65 7073 5f62 5d20 6d75 7374  ps_a,eps_b] must
-00019cc0: 2062 6520 666c 6f61 7473 203c 2031 2e65   be floats < 1.e
-00019cd0: 2d34 2122 0a20 2020 2020 2020 2061 7373  -4!".        ass
-00019ce0: 6572 7420 616c 6c28 5b65 6520 3c20 312e  ert all([ee < 1.
-00019cf0: 652d 3420 666f 7220 6565 2069 6e20 5b65  e-4 for ee in [e
-00019d00: 7073 5f75 7a2c 2065 7073 5f61 2c0a 2020  ps_uz, eps_a,.  
-00019d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019d30: 2020 2020 2020 2020 6570 735f 767a 2c20          eps_vz, 
-00019d40: 6570 735f 622c 0a20 2020 2020 2020 2020  eps_b,.         
+00018ec0: 2020 646f 7562 6c65 2072 6d69 6e3d 2d31    double rmin=-1
+00018ed0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00018ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018ef0: 2020 646f 7562 6c65 2065 7073 5f75 7a3d    double eps_uz=
+00018f00: 5f53 4d41 4c4c 2c20 646f 7562 6c65 2065  _SMALL, double e
+00018f10: 7073 5f61 3d5f 5653 4d41 4c4c 2c0a 2020  ps_a=_VSMALL,.  
+00018f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018f30: 2020 2020 2020 2020 2020 2020 2020 646f                do
+00018f40: 7562 6c65 2065 7073 5f76 7a3d 5f56 534d  uble eps_vz=_VSM
+00018f50: 414c 4c2c 2064 6f75 626c 6520 6570 735f  ALL, double eps_
+00018f60: 623d 5f56 534d 414c 4c2c 0a20 2020 2020  b=_VSMALL,.     
+00018f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018f80: 2020 2020 2020 2020 2020 2064 6f75 626c             doubl
+00018f90: 6520 6570 735f 706c 616e 653d 5f56 534d  e eps_plane=_VSM
+00018fa0: 414c 4c2c 2073 7472 2076 6573 5f74 7970  ALL, str ves_typ
+00018fb0: 653d 2754 6f72 272c 0a20 2020 2020 2020  e='Tor',.       
+00018fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018fd0: 2020 2020 2020 2020 2062 696e 7420 666f           bint fo
+00018fe0: 7262 6964 3d31 2c20 6269 6e74 2074 6573  rbid=1, bint tes
+00018ff0: 743d 312c 2069 6e74 206e 756d 5f74 6872  t=1, int num_thr
+00019000: 6561 6473 3d31 3629 3a0a 2020 2020 2222  eads=16):.    ""
+00019010: 220a 2020 2020 436f 6d70 7574 6573 2074  ".    Computes t
+00019020: 6865 2065 6e74 7279 2061 6e64 2065 7869  he entry and exi
+00019030: 7420 706f 696e 7420 6f66 2061 6c6c 2070  t point of all p
+00019040: 726f 7669 6465 6420 4c4f 5320 666f 7220  rovided LOS for 
+00019050: 7468 6520 7072 6f76 6964 6564 0a20 2020  the provided.   
+00019060: 2070 6f6c 7967 6f6e 7320 2874 6f72 6f69   polygons (toroi
+00019070: 6461 6c20 6f72 206c 696e 6561 7229 2020  dal or linear)  
+00019080: 6f66 2049 4e20 7374 7275 6374 7572 6573  of IN structures
+00019090: 2028 6e6f 6e2d 736f 6c69 642c 206f 7220   (non-solid, or 
+000190a0: 6065 6d70 7479 600a 2020 2020 696e 7369  `empty`.    insi
+000190b0: 6465 2066 6f72 2074 6865 204c 4f53 292e  de for the LOS).
+000190c0: 0a20 2020 2041 7474 656e 7469 6f6e 3a20  .    Attention: 
+000190d0: 7468 6520 7375 7266 6163 6573 2063 616e  the surfaces can
+000190e0: 2062 6520 6c69 6d69 7465 642c 2062 7574   be limited, but
+000190f0: 2074 6865 7920 616c 6c20 6861 7665 2074   they all have t
+00019100: 6f20 6861 7665 2074 6865 0a20 2020 2073  o have the.    s
+00019110: 616d 6520 6c69 6d69 7473 2064 6566 696e  ame limits defin
+00019120: 6564 2062 7920 2876 6573 5f6c 696d 7329  ed by (ves_lims)
+00019130: 0a20 2020 2052 6574 7572 6e20 7468 6520  .    Return the 
+00019140: 7365 7420 6f66 206b 6d69 6e20 2f20 6b6d  set of kmin / km
+00019150: 6178 2066 6f72 2065 6163 6820 496e 2073  ax for each In s
+00019160: 7472 7563 7420 616e 6420 666f 7220 6561  truct and for ea
+00019170: 6368 204c 4f53 0a0a 2020 2020 5061 7261  ch LOS..    Para
+00019180: 6d73 0a20 2020 203d 3d3d 3d3d 3d0a 2020  ms.    ======.  
+00019190: 2020 7261 795f 6f72 6967 203a 2028 332c    ray_orig : (3,
+000191a0: 206e 6c6f 7329 2064 6f75 626c 6520 6172   nlos) double ar
+000191b0: 7261 790a 2020 2020 2020 204c 4f53 206f  ray.       LOS o
+000191c0: 7269 6769 6e20 706f 696e 7473 2063 6f6f  rigin points coo
+000191d0: 7264 696e 6174 6573 0a20 2020 2072 6179  rdinates.    ray
+000191e0: 5f76 6469 7220 3a20 2833 2c20 6e6c 6f73  _vdir : (3, nlos
+000191f0: 2920 646f 7562 6c65 2061 7272 6179 0a20  ) double array. 
+00019200: 2020 2020 2020 4c4f 5320 6e6f 726d 616c        LOS normal
+00019210: 697a 6564 2064 6972 6563 7469 6f6e 2076  ized direction v
+00019220: 6563 746f 720a 2020 2020 6e75 6d5f 7375  ector.    num_su
+00019230: 7266 203a 2069 6e74 0a20 2020 2020 2020  rf : int.       
+00019240: 6e75 6d62 6572 206f 6620 7375 7266 6178  number of surfax
+00019250: 6573 2c20 616b 6120 2769 6e27 2073 7472  es, aka 'in' str
+00019260: 7563 7475 7265 7320 6f72 2027 7665 7373  uctures or 'vess
+00019270: 656c 7327 0a20 2020 2076 6573 5f70 6f6c  els'.    ves_pol
+00019280: 7920 3a20 286e 756d 5f73 7572 662c 2032  y : (num_surf, 2
+00019290: 2c20 6e75 6d5f 7665 7274 6578 2920 646f  , num_vertex) do
+000192a0: 7562 6c65 2061 7272 6179 0a20 2020 2020  uble array.     
+000192b0: 2020 436f 6f72 6469 6e61 7465 7320 6f66    Coordinates of
+000192c0: 2074 6865 2076 6572 7469 6365 7320 6f66   the vertices of
+000192d0: 2074 6865 2050 6f6c 7967 6f6e 2064 6566   the Polygon def
+000192e0: 696e 696e 6720 7468 6520 3244 2070 6f6c  ining the 2D pol
+000192f0: 6f69 6461 6c0a 2020 2020 2020 2063 7574  oidal.       cut
+00019300: 206f 6620 7468 6520 6069 6e60 2073 7472   of the `in` str
+00019310: 7563 7475 7265 730a 2020 2020 7665 735f  uctures.    ves_
+00019320: 6e6f 726d 203a 2028 6e75 6d5f 7375 7266  norm : (num_surf
+00019330: 2c20 322c 206e 756d 5f76 6572 7465 782d  , 2, num_vertex-
+00019340: 3129 2064 6f75 626c 6520 6172 7261 790a  1) double array.
+00019350: 2020 2020 2020 204e 6f72 6d61 6c20 7665         Normal ve
+00019360: 6374 6f72 7320 676f 696e 6720 2269 6e77  ctors going "inw
+00019370: 6172 6473 2220 6f66 2074 6865 2065 6467  ards" of the edg
+00019380: 6573 206f 6620 7468 6520 506f 6c79 676f  es of the Polygo
+00019390: 6e20 6465 6669 6e65 640a 2020 2020 2020  n defined.      
+000193a0: 2062 7920 7665 735f 706f 6c79 0a20 2020   by ves_poly.   
+000193b0: 2076 6573 5f6c 696d 7320 3a20 6172 7261   ves_lims : arra
+000193c0: 790a 2020 2020 2020 2043 6f6e 7461 696e  y.       Contain
+000193d0: 7320 7468 6520 6c69 6d69 7473 206d 696e  s the limits min
+000193e0: 2061 6e64 206d 6178 206f 6620 7665 7373   and max of vess
+000193f0: 656c 0a20 2020 2072 6d69 6e20 3a20 646f  el.    rmin : do
+00019400: 7562 6c65 0a20 2020 2020 2020 4d69 6e69  uble.       Mini
+00019410: 6d61 6c20 7261 6469 7573 206f 6620 7665  mal radius of ve
+00019420: 7373 656c 2074 6f20 7461 6b65 2069 6e74  ssel to take int
+00019430: 6f20 636f 6e73 6964 6572 6174 696f 6e0a  o consideration.
+00019440: 2020 2020 6570 733c 7661 6c3e 203a 2064      eps<val> : d
+00019450: 6f75 626c 650a 2020 2020 2020 2053 6d61  ouble.       Sma
+00019460: 6c6c 2076 616c 7565 2c20 6163 6365 7074  ll value, accept
+00019470: 616e 6365 206f 6620 6572 726f 720a 2020  ance of error.  
+00019480: 2020 7674 7970 6520 3a20 7374 7269 6e67    vtype : string
+00019490: 0a20 2020 2020 2020 5479 7065 206f 6620  .       Type of 
+000194a0: 7665 7373 656c 2028 2254 6f72 2220 6f72  vessel ("Tor" or
+000194b0: 2022 4c69 6e22 290a 2020 2020 666f 7262   "Lin").    forb
+000194c0: 6964 203a 2062 6f6f 6c0a 2020 2020 2020  id : bool.      
+000194d0: 2053 686f 756c 6420 7765 2066 6f72 6269   Should we forbi
+000194e0: 6420 7661 6c75 6573 2062 6568 696e 6420  d values behind 
+000194f0: 7669 7369 626c 6520 7261 6469 7573 203f  visible radius ?
+00019500: 2028 7365 6520 726d 696e 290a 2020 2020   (see rmin).    
+00019510: 7465 7374 203a 2062 6f6f 6c0a 2020 2020  test : bool.    
+00019520: 2020 2053 686f 756c 6420 7765 2072 756e     Should we run
+00019530: 2074 6573 7473 203f 0a20 2020 206e 756d   tests ?.    num
+00019540: 5f74 6872 6561 6473 203a 2069 6e74 0a20  _threads : int. 
+00019550: 2020 2020 2020 5468 6520 6e75 6d5f 7468        The num_th
+00019560: 7265 6164 7320 6172 6775 6d65 6e74 2069  reads argument i
+00019570: 6e64 6963 6174 6573 2068 6f77 206d 616e  ndicates how man
+00019580: 7920 7468 7265 6164 7320 7468 6520 7465  y threads the te
+00019590: 616d 2073 686f 756c 640a 2020 2020 2020  am should.      
+000195a0: 2063 6f6e 7369 7374 206f 662e 2049 6620   consist of. If 
+000195b0: 6e6f 7420 6769 7665 6e2c 204f 7065 6e4d  not given, OpenM
+000195c0: 5020 7769 6c6c 2064 6563 6964 6520 686f  P will decide ho
+000195d0: 7720 6d61 6e79 2074 6872 6561 6473 2074  w many threads t
+000195e0: 6f20 7573 652e 0a20 2020 2020 2020 5479  o use..       Ty
+000195f0: 7069 6361 6c6c 7920 7468 6973 2069 7320  pically this is 
+00019600: 7468 6520 6e75 6d62 6572 206f 6620 636f  the number of co
+00019610: 7265 7320 6176 6169 6c61 626c 6520 6f6e  res available on
+00019620: 2074 6865 206d 6163 6869 6e65 2e0a 2020   the machine..  
+00019630: 2020 5265 7475 726e 0a20 2020 203d 3d3d    Return.    ===
+00019640: 3d3d 3d0a 2020 2020 636f 6566 665f 696e  ===.    coeff_in
+00019650: 7465 725f 696e 203a 2028 6e75 6d5f 7375  ter_in : (num_su
+00019660: 7266 2c20 6e6c 6f73 2920 6172 7261 790a  rf, nlos) array.
+00019670: 2020 2020 2020 2073 6361 6c61 7273 206c         scalars l
+00019680: 6576 656c 206f 6620 2269 6e22 2069 6e74  evel of "in" int
+00019690: 6572 7365 6374 696f 6e20 6f66 2074 6865  ersection of the
+000196a0: 204c 4f53 2028 6966 206b 3d30 2061 7420   LOS (if k=0 at 
+000196b0: 6f72 6967 696e 2920 666f 720a 2020 2020  origin) for.    
+000196c0: 2020 2065 6163 6820 7375 7266 6163 650a     each surface.
+000196d0: 2020 2020 2020 205b 6b6d 696e 2873 7572         [kmin(sur
+000196e0: 6630 2c20 6c6f 7330 292c 206b 6d69 6e28  f0, los0), kmin(
+000196f0: 7375 7266 302c 206c 6f73 3129 2c20 2e2e  surf0, los1), ..
+00019700: 2e2c 206b 6d69 6e28 7375 7266 312c 206c  ., kmin(surf1, l
+00019710: 6f73 3029 2c2e 2e2e 2e5d 0a20 2020 2063  os0),....].    c
+00019720: 6f65 6666 5f69 6e74 6572 5f6f 7574 203a  oeff_inter_out :
+00019730: 2028 6e75 6d5f 7375 7266 2c20 6e6c 6f73   (num_surf, nlos
+00019740: 2920 6172 7261 790a 2020 2020 2020 2073  ) array.       s
+00019750: 6361 6c61 7273 206c 6576 656c 206f 6620  calars level of 
+00019760: 226f 7574 2220 696e 7465 7273 6563 7469  "out" intersecti
+00019770: 6f6e 206f 6620 7468 6520 4c4f 5320 2869  on of the LOS (i
+00019780: 6620 6b3d 3020 6174 206f 7269 6769 6e29  f k=0 at origin)
+00019790: 2066 6f72 0a20 2020 2020 2020 6561 6368   for.       each
+000197a0: 2073 7572 6661 6365 0a20 2020 2020 2020   surface.       
+000197b0: 5b6b 6d61 7828 7375 7266 302c 206c 6f73  [kmax(surf0, los
+000197c0: 3029 2c20 6b6d 6178 2873 7572 6630 2c20  0), kmax(surf0, 
+000197d0: 6c6f 7331 292c 202e 2e2e 2c20 6b6d 6178  los1), ..., kmax
+000197e0: 2873 7572 6631 2c20 6c6f 7330 292c 2e2e  (surf1, los0),..
+000197f0: 2e2e 5d0a 2020 2020 2222 220a 2020 2020  ..].    """.    
+00019800: 6364 6566 2069 6e74 206e 7074 735f 706f  cdef int npts_po
+00019810: 6c79 0a20 2020 2063 6465 6620 696e 7420  ly.    cdef int 
+00019820: 6e6c 6f73 203d 2072 6179 5f6f 7269 672e  nlos = ray_orig.
+00019830: 7368 6170 655b 315d 0a20 2020 2063 6465  shape[1].    cde
+00019840: 6620 696e 7420 696e 645f 7374 7275 6374  f int ind_struct
+00019850: 203d 2030 0a20 2020 2063 6465 6620 696e   = 0.    cdef in
+00019860: 7420 696e 645f 7375 7266 0a20 2020 2063  t ind_surf.    c
+00019870: 6465 6620 646f 7562 6c65 2063 7269 7432  def double crit2
+00019880: 5f62 6173 6520 3d20 6570 735f 757a 202a  _base = eps_uz *
+00019890: 2065 7073 5f75 7a20 2f34 3030 2e0a 2020   eps_uz /400..  
+000198a0: 2020 6364 6566 2064 6f75 626c 6520 6c69    cdef double li
+000198b0: 6d5f 6d69 6e20 3d20 302e 0a20 2020 2063  m_min = 0..    c
+000198c0: 6465 6620 646f 7562 6c65 206c 696d 5f6d  def double lim_m
+000198d0: 6178 203d 2030 2e0a 2020 2020 6364 6566  ax = 0..    cdef
+000198e0: 2064 6f75 626c 6520 726d 696e 3220 3d20   double rmin2 = 
+000198f0: 302e 0a20 2020 2063 6465 6620 7374 7220  0..    cdef str 
+00019900: 6572 726f 725f 6d65 7373 6167 650a 2020  error_message.  
+00019910: 2020 6364 6566 2062 696e 7420 666f 7262    cdef bint forb
+00019920: 6964 6269 732c 2066 6f72 6269 6430 0a20  idbis, forbid0. 
+00019930: 2020 2063 6465 6620 6269 6e74 2062 6f6f     cdef bint boo
+00019940: 6c31 2c20 626f 6f6c 320a 2020 2020 6364  l1, bool2.    cd
+00019950: 6566 2061 7272 6179 2063 6f65 6666 5f69  ef array coeff_i
+00019960: 6e74 6572 5f69 6e20 203d 2063 6c6f 6e65  nter_in  = clone
+00019970: 2861 7272 6179 2827 6427 292c 206e 6c6f  (array('d'), nlo
+00019980: 7320 2a20 6e75 6d5f 7375 7266 2c20 5472  s * num_surf, Tr
+00019990: 7565 290a 2020 2020 6364 6566 2061 7272  ue).    cdef arr
+000199a0: 6179 2063 6f65 6666 5f69 6e74 6572 5f6f  ay coeff_inter_o
+000199b0: 7574 203d 2063 6c6f 6e65 2861 7272 6179  ut = clone(array
+000199c0: 2827 6427 292c 206e 6c6f 7320 2a20 6e75  ('d'), nlos * nu
+000199d0: 6d5f 7375 7266 2c20 5472 7565 290a 2020  m_surf, True).  
+000199e0: 2020 6364 6566 2069 6e74 202a 6c6c 696d    cdef int *llim
+000199f0: 6974 7320 3d20 4e55 4c4c 0a20 2020 2063  its = NULL.    c
+00019a00: 6465 6620 6c6f 6e67 202a 6c73 7a5f 6c69  def long *lsz_li
+00019a10: 6d20 3d20 4e55 4c4c 0a20 2020 2063 6465  m = NULL.    cde
+00019a20: 6620 6269 6e74 2061 7265 5f6c 696d 6974  f bint are_limit
+00019a30: 6564 0a20 2020 2063 6465 6620 646f 7562  ed.    cdef doub
+00019a40: 6c65 5b32 5d20 6c62 6f75 6e64 735f 7665  le[2] lbounds_ve
+00019a50: 730a 2020 2020 6364 6566 2064 6f75 626c  s.    cdef doubl
+00019a60: 655b 325d 206c 696d 5f76 6573 0a20 2020  e[2] lim_ves.   
+00019a70: 2063 6465 6620 646f 7562 6c65 5b3a 2c3a   cdef double[:,:
+00019a80: 3a31 5d20 746d 705f 706f 6c79 0a20 2020  :1] tmp_poly.   
+00019a90: 2063 6465 6620 646f 7562 6c65 5b3a 2c3a   cdef double[:,:
+00019aa0: 3a31 5d20 746d 705f 6e6f 726d 0a20 2020  :1] tmp_norm.   
+00019ab0: 2063 6465 6620 646f 7562 6c65 2a20 7074   cdef double* pt
+00019ac0: 725f 636f 6566 665f 696e 0a20 2020 2063  r_coeff_in.    c
+00019ad0: 6465 6620 646f 7562 6c65 2a20 7074 725f  def double* ptr_
+00019ae0: 636f 6566 665f 6f75 740a 0a20 2020 2023  coeff_out..    #
+00019af0: 2069 6e69 7469 616c 697a 6174 696f 6e73   initializations
+00019b00: 202e 2e2e 0a20 2020 2070 7472 5f63 6f65   ....    ptr_coe
+00019b10: 6666 5f69 6e20 3d20 636f 6566 665f 696e  ff_in = coeff_in
+00019b20: 7465 725f 696e 2e64 6174 612e 6173 5f64  ter_in.data.as_d
+00019b30: 6f75 626c 6573 0a20 2020 2070 7472 5f63  oubles.    ptr_c
+00019b40: 6f65 6666 5f6f 7574 203d 2063 6f65 6666  oeff_out = coeff
+00019b50: 5f69 6e74 6572 5f6f 7574 2e64 6174 612e  _inter_out.data.
+00019b60: 6173 5f64 6f75 626c 6573 0a0a 2020 2020  as_doubles..    
+00019b70: 2320 3d3d 2054 6573 7469 6e67 2069 6e70  # == Testing inp
+00019b80: 7574 7320 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  uts ============
+00019b90: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00019ba0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00019bb0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 0a20 2020  ============.   
+00019bc0: 2069 6620 7465 7374 3a0a 2020 2020 2020   if test:.      
+00019bd0: 2020 6572 726f 725f 6d65 7373 6167 6520    error_message 
+00019be0: 3d20 2272 6179 5f6f 7269 6720 616e 6420  = "ray_orig and 
+00019bf0: 7261 795f 7664 6972 206d 7573 7420 6861  ray_vdir must ha
+00019c00: 7665 2074 6865 2073 616d 6520 7368 6170  ve the same shap
+00019c10: 653a 2022 5c0a 2020 2020 2020 2020 2020  e: "\.          
+00019c20: 2020 2020 2020 2020 2020 2020 2020 2b20                + 
+00019c30: 2228 332c 2920 6f72 2028 332c 4e4c 2921  "(3,) or (3,NL)!
+00019c40: 220a 2020 2020 2020 2020 6173 7365 7274  ".        assert
+00019c50: 2074 7570 6c65 2872 6179 5f6f 7269 672e   tuple(ray_orig.
+00019c60: 7368 6170 6529 203d 3d20 7475 706c 6528  shape) == tuple(
+00019c70: 7261 795f 7664 6972 2e73 6861 7065 2920  ray_vdir.shape) 
+00019c80: 616e 6420 5c0a 2020 2020 2020 2020 2020  and \.          
+00019c90: 7261 795f 6f72 6967 2e73 6861 7065 5b30  ray_orig.shape[0
+00019ca0: 5d20 3d3d 2033 2c20 6572 726f 725f 6d65  ] == 3, error_me
+00019cb0: 7373 6167 650a 2020 2020 2020 2020 6572  ssage.        er
+00019cc0: 726f 725f 6d65 7373 6167 6520 3d20 225b  ror_message = "[
+00019cd0: 6570 735f 757a 2c65 7073 5f76 7a2c 6570  eps_uz,eps_vz,ep
+00019ce0: 735f 612c 6570 735f 625d 206d 7573 7420  s_a,eps_b] must 
+00019cf0: 6265 2066 6c6f 6174 7320 3c20 312e 652d  be floats < 1.e-
+00019d00: 3421 220a 2020 2020 2020 2020 6173 7365  4!".        asse
+00019d10: 7274 2061 6c6c 285b 6565 203c 2031 2e65  rt all([ee < 1.e
+00019d20: 2d34 2066 6f72 2065 6520 696e 205b 6570  -4 for ee in [ep
+00019d30: 735f 757a 2c20 6570 735f 612c 0a20 2020  s_uz, eps_a,.   
+00019d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00019d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019d70: 2065 7073 5f70 6c61 6e65 5d5d 292c 2065   eps_plane]]), e
-00019d80: 7272 6f72 5f6d 6573 7361 6765 0a20 2020  rror_message.   
-00019d90: 2020 2020 2065 7272 6f72 5f6d 6573 7361       error_messa
-00019da0: 6765 203d 2022 7665 735f 7479 7065 206d  ge = "ves_type m
-00019db0: 7573 7420 6265 2061 2073 7472 2069 6e20  ust be a str in 
-00019dc0: 5b27 546f 7227 2c27 4c69 6e27 5d21 220a  ['Tor','Lin']!".
-00019dd0: 2020 2020 2020 2020 6173 7365 7274 2076          assert v
-00019de0: 6573 5f74 7970 652e 6c6f 7765 7228 2920  es_type.lower() 
-00019df0: 696e 205b 2774 6f72 272c 2027 6c69 6e27  in ['tor', 'lin'
-00019e00: 5d2c 2065 7272 6f72 5f6d 6573 7361 6765  ], error_message
-00019e10: 0a0a 2020 2020 2320 3d3d 3d3d 3d3d 3d3d  ..    # ========
-00019e20: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00019e30: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00019e40: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00019d60: 2020 2020 2020 2065 7073 5f76 7a2c 2065         eps_vz, e
+00019d70: 7073 5f62 2c0a 2020 2020 2020 2020 2020  ps_b,.          
+00019d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019da0: 6570 735f 706c 616e 655d 5d29 2c20 6572  eps_plane]]), er
+00019db0: 726f 725f 6d65 7373 6167 650a 2020 2020  ror_message.    
+00019dc0: 2020 2020 6572 726f 725f 6d65 7373 6167      error_messag
+00019dd0: 6520 3d20 2276 6573 5f74 7970 6520 6d75  e = "ves_type mu
+00019de0: 7374 2062 6520 6120 7374 7220 696e 205b  st be a str in [
+00019df0: 2754 6f72 272c 274c 696e 275d 2122 0a20  'Tor','Lin']!". 
+00019e00: 2020 2020 2020 2061 7373 6572 7420 7665         assert ve
+00019e10: 735f 7479 7065 2e6c 6f77 6572 2829 2069  s_type.lower() i
+00019e20: 6e20 5b27 746f 7227 2c20 276c 696e 275d  n ['tor', 'lin']
+00019e30: 2c20 6572 726f 725f 6d65 7373 6167 650a  , error_message.
+00019e40: 0a20 2020 2023 203d 3d3d 3d3d 3d3d 3d3d  .    # =========
 00019e50: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00019e60: 3d3d 0a20 2020 2069 6620 7665 735f 7479  ==.    if ves_ty
-00019e70: 7065 2e6c 6f77 6572 2829 203d 3d20 2774  pe.lower() == 't
-00019e80: 6f72 273a 0a20 2020 2020 2020 2023 202e  or':.        # .
-00019e90: 2e20 6966 2074 6865 7265 2061 7265 2c20  . if there are, 
-00019ea0: 7765 2067 6574 2074 6865 206c 696d 6974  we get the limit
-00019eb0: 7320 666f 7220 7468 6520 7665 7373 656c  s for the vessel
-00019ec0: 202e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e   ...............
-00019ed0: 2e2e 2e2e 2e0a 2020 2020 2020 2020 6966  ......        if
-00019ee0: 2076 6573 5f6c 696d 7320 6973 204e 6f6e   ves_lims is Non
-00019ef0: 6520 206f 7220 6e70 2e73 697a 6528 7665  e  or np.size(ve
-00019f00: 735f 6c69 6d73 2920 3d3d 2030 3a0a 2020  s_lims) == 0:.  
-00019f10: 2020 2020 2020 2020 2020 6172 655f 6c69            are_li
-00019f20: 6d69 7465 6420 3d20 4661 6c73 650a 2020  mited = False.  
-00019f30: 2020 2020 2020 2020 2020 6c62 6f75 6e64            lbound
-00019f40: 735f 7665 735b 305d 203d 2030 0a20 2020  s_ves[0] = 0.   
-00019f50: 2020 2020 2020 2020 206c 626f 756e 6473           lbounds
-00019f60: 5f76 6573 5b31 5d20 3d20 300a 2020 2020  _ves[1] = 0.    
-00019f70: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00019f80: 2020 2020 2020 6172 655f 6c69 6d69 7465        are_limite
-00019f90: 6420 3d20 5472 7565 0a20 2020 2020 2020  d = True.       
-00019fa0: 2020 2020 206c 626f 756e 6473 5f76 6573       lbounds_ves
-00019fb0: 5b30 5d20 3d20 635f 6174 616e 3228 635f  [0] = c_atan2(c_
-00019fc0: 7369 6e28 7665 735f 6c69 6d73 5b30 5d29  sin(ves_lims[0])
-00019fd0: 2c20 635f 636f 7328 7665 735f 6c69 6d73  , c_cos(ves_lims
-00019fe0: 5b30 5d29 290a 2020 2020 2020 2020 2020  [0])).          
-00019ff0: 2020 6c62 6f75 6e64 735f 7665 735b 315d    lbounds_ves[1]
-0001a000: 203d 2063 5f61 7461 6e32 2863 5f73 696e   = c_atan2(c_sin
-0001a010: 2876 6573 5f6c 696d 735b 315d 292c 2063  (ves_lims[1]), c
-0001a020: 5f63 6f73 2876 6573 5f6c 696d 735b 315d  _cos(ves_lims[1]
-0001a030: 2929 0a20 2020 2020 2020 2023 202d 2d20  )).        # -- 
-0001a040: 546f 726f 6964 616c 2063 6173 6520 2d2d  Toroidal case --
-0001a050: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0001a060: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0001a070: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0001a080: 2d2d 2d0a 2020 2020 2020 2020 666f 7220  ---.        for 
-0001a090: 696e 645f 7375 7266 2069 6e20 7261 6e67  ind_surf in rang
-0001a0a0: 6528 6e75 6d5f 7375 7266 293a 0a20 2020  e(num_surf):.   
-0001a0b0: 2020 2020 2020 2020 2023 2072 6d69 6e20           # rmin 
-0001a0c0: 6973 206e 6563 6573 7361 7279 2074 6f20  is necessary to 
-0001a0d0: 6176 6f69 6420 6c6f 6f6b 696e 6720 6f6e  avoid looking on
-0001a0e0: 2074 6865 206f 7468 6572 2073 6964 6520   the other side 
-0001a0f0: 6f66 2074 6865 2074 6f6b 0a20 2020 2020  of the tok.     
-0001a100: 2020 2020 2020 2069 6620 726d 696e 203c         if rmin <
-0001a110: 2030 2e3a 0a20 2020 2020 2020 2020 2020   0.:.           
-0001a120: 2020 2020 2072 6d69 6e20 3d20 302e 3935       rmin = 0.95
-0001a130: 2a6d 696e 286e 702e 6d69 6e28 7665 735f  *min(np.min(ves_
-0001a140: 706f 6c79 5b69 6e64 5f73 7572 665d 5b30  poly[ind_surf][0
-0001a150: 2c20 2e2e 2e5d 292c 0a20 2020 2020 2020  , ...]),.       
-0001a160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a170: 2020 2020 2020 2020 205f 6267 742e 636f           _bgt.co
-0001a180: 6d70 5f6d 696e 5f68 7970 6f74 2872 6179  mp_min_hypot(ray
-0001a190: 5f6f 7269 675b 302c 202e 2e2e 5d2c 0a20  _orig[0, ...],. 
-0001a1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a1d0: 2020 2072 6179 5f6f 7269 675b 312c 202e     ray_orig[1, .
-0001a1e0: 2e2e 5d2c 0a20 2020 2020 2020 2020 2020  ..],.           
+00019e60: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00019e70: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00019e80: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00019e90: 3d0a 2020 2020 6966 2076 6573 5f74 7970  =.    if ves_typ
+00019ea0: 652e 6c6f 7765 7228 2920 3d3d 2027 746f  e.lower() == 'to
+00019eb0: 7227 3a0a 2020 2020 2020 2020 2320 2e2e  r':.        # ..
+00019ec0: 2069 6620 7468 6572 6520 6172 652c 2077   if there are, w
+00019ed0: 6520 6765 7420 7468 6520 6c69 6d69 7473  e get the limits
+00019ee0: 2066 6f72 2074 6865 2076 6573 7365 6c20   for the vessel 
+00019ef0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00019f00: 2e2e 2e2e 0a20 2020 2020 2020 2069 6620  .....        if 
+00019f10: 7665 735f 6c69 6d73 2069 7320 4e6f 6e65  ves_lims is None
+00019f20: 2020 6f72 206e 702e 7369 7a65 2876 6573    or np.size(ves
+00019f30: 5f6c 696d 7329 203d 3d20 303a 0a20 2020  _lims) == 0:.   
+00019f40: 2020 2020 2020 2020 2061 7265 5f6c 696d           are_lim
+00019f50: 6974 6564 203d 2046 616c 7365 0a20 2020  ited = False.   
+00019f60: 2020 2020 2020 2020 206c 626f 756e 6473           lbounds
+00019f70: 5f76 6573 5b30 5d20 3d20 300a 2020 2020  _ves[0] = 0.    
+00019f80: 2020 2020 2020 2020 6c62 6f75 6e64 735f          lbounds_
+00019f90: 7665 735b 315d 203d 2030 0a20 2020 2020  ves[1] = 0.     
+00019fa0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00019fb0: 2020 2020 2061 7265 5f6c 696d 6974 6564       are_limited
+00019fc0: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
+00019fd0: 2020 2020 6c62 6f75 6e64 735f 7665 735b      lbounds_ves[
+00019fe0: 305d 203d 2063 5f61 7461 6e32 2863 5f73  0] = c_atan2(c_s
+00019ff0: 696e 2876 6573 5f6c 696d 735b 305d 292c  in(ves_lims[0]),
+0001a000: 2063 5f63 6f73 2876 6573 5f6c 696d 735b   c_cos(ves_lims[
+0001a010: 305d 2929 0a20 2020 2020 2020 2020 2020  0])).           
+0001a020: 206c 626f 756e 6473 5f76 6573 5b31 5d20   lbounds_ves[1] 
+0001a030: 3d20 635f 6174 616e 3228 635f 7369 6e28  = c_atan2(c_sin(
+0001a040: 7665 735f 6c69 6d73 5b31 5d29 2c20 635f  ves_lims[1]), c_
+0001a050: 636f 7328 7665 735f 6c69 6d73 5b31 5d29  cos(ves_lims[1])
+0001a060: 290a 2020 2020 2020 2020 2320 2d2d 2054  ).        # -- T
+0001a070: 6f72 6f69 6461 6c20 6361 7365 202d 2d2d  oroidal case ---
+0001a080: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0001a090: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0001a0a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0001a0b0: 2d2d 0a20 2020 2020 2020 2066 6f72 2069  --.        for i
+0001a0c0: 6e64 5f73 7572 6620 696e 2072 616e 6765  nd_surf in range
+0001a0d0: 286e 756d 5f73 7572 6629 3a0a 2020 2020  (num_surf):.    
+0001a0e0: 2020 2020 2020 2020 2320 726d 696e 2069          # rmin i
+0001a0f0: 7320 6e65 6365 7373 6172 7920 746f 2061  s necessary to a
+0001a100: 766f 6964 206c 6f6f 6b69 6e67 206f 6e20  void looking on 
+0001a110: 7468 6520 6f74 6865 7220 7369 6465 206f  the other side o
+0001a120: 6620 7468 6520 746f 6b0a 2020 2020 2020  f the tok.      
+0001a130: 2020 2020 2020 6966 2072 6d69 6e20 3c20        if rmin < 
+0001a140: 302e 3a0a 2020 2020 2020 2020 2020 2020  0.:.            
+0001a150: 2020 2020 726d 696e 203d 2030 2e39 352a      rmin = 0.95*
+0001a160: 6d69 6e28 6e70 2e6d 696e 2876 6573 5f70  min(np.min(ves_p
+0001a170: 6f6c 795b 696e 645f 7375 7266 5d5b 302c  oly[ind_surf][0,
+0001a180: 202e 2e2e 5d29 2c0a 2020 2020 2020 2020   ...]),.        
+0001a190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a1a0: 2020 2020 2020 2020 5f62 6774 2e63 6f6d          _bgt.com
+0001a1b0: 705f 6d69 6e5f 6879 706f 7428 7261 795f  p_min_hypot(ray_
+0001a1c0: 6f72 6967 5b30 2c20 2e2e 2e5d 2c0a 2020  orig[0, ...],.  
+0001a1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001a1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a210: 2020 2020 2020 2020 206e 6c6f 7329 290a           nlos)).
-0001a220: 2020 2020 2020 2020 2020 2020 726d 696e              rmin
-0001a230: 3220 3d20 726d 696e 2a72 6d69 6e0a 2020  2 = rmin*rmin.  
-0001a240: 2020 2020 2020 2020 2020 2320 5661 7269            # Vari
-0001a250: 6162 6c65 2074 6f20 6176 6f69 6420 6c6f  able to avoid lo
-0001a260: 6f6b 696e 6720 2262 6568 696e 6422 2062  oking "behind" b
-0001a270: 6c69 6e64 2073 706f 7420 6f66 2074 6f72  lind spot of tor
-0001a280: 650a 2020 2020 2020 2020 2020 2020 6966  e.            if
-0001a290: 2066 6f72 6269 643a 0a20 2020 2020 2020   forbid:.       
-0001a2a0: 2020 2020 2020 2020 2066 6f72 6269 6430           forbid0
-0001a2b0: 2c20 666f 7262 6964 6269 7320 3d20 312c  , forbidbis = 1,
-0001a2c0: 2031 0a20 2020 2020 2020 2020 2020 2065   1.            e
-0001a2d0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0001a2e0: 2020 2020 2066 6f72 6269 6430 2c20 666f       forbid0, fo
-0001a2f0: 7262 6964 6269 7320 3d20 302c 2030 0a20  rbidbis = 0, 0. 
-0001a300: 2020 2020 2020 2020 2020 2023 2047 6574             # Get
-0001a310: 7469 6e67 2073 697a 6520 6f66 2070 6f6c  ting size of pol
-0001a320: 790a 2020 2020 2020 2020 2020 2020 6e70  y.            np
-0001a330: 7473 5f70 6f6c 7920 3d20 6c6e 7665 7274  ts_poly = lnvert
-0001a340: 5b69 6e64 5f73 7572 665d 0a20 2020 2020  [ind_surf].     
-0001a350: 2020 2020 2020 2074 6d70 5f70 6f6c 7920         tmp_poly 
-0001a360: 3d20 7665 735f 706f 6c79 5b69 6e64 5f73  = ves_poly[ind_s
-0001a370: 7572 665d 0a20 2020 2020 2020 2020 2020  urf].           
-0001a380: 2074 6d70 5f6e 6f72 6d20 3d20 7665 735f   tmp_norm = ves_
-0001a390: 6e6f 726d 5b69 6e64 5f73 7572 665d 0a20  norm[ind_surf]. 
-0001a3a0: 2020 2020 2020 2020 2020 2023 202d 2d20             # -- 
-0001a3b0: 436f 6d70 7574 696e 6720 696e 7465 7273  Computing inters
-0001a3c0: 6563 7469 6f6e 2062 6574 7765 656e 204c  ection between L
-0001a3d0: 4f53 2061 6e64 2056 6573 7365 6c20 2d2d  OS and Vessel --
-0001a3e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a  ---------------.
-0001a3f0: 2020 2020 2020 2020 2020 2020 5f72 742e              _rt.
-0001a400: 7261 7974 7261 6369 6e67 5f6d 696e 6d61  raytracing_minma
-0001a410: 785f 7374 7275 6374 5f74 6f72 286e 6c6f  x_struct_tor(nlo
-0001a420: 732c 2072 6179 5f76 6469 722c 2072 6179  s, ray_vdir, ray
-0001a430: 5f6f 7269 672c 0a20 2020 2020 2020 2020  _orig,.         
-0001a440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a460: 2020 2020 2670 7472 5f63 6f65 6666 5f6f      &ptr_coeff_o
-0001a470: 7574 5b69 6e64 5f73 7572 662a 6e6c 6f73  ut[ind_surf*nlos
-0001a480: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-0001a490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a4b0: 2670 7472 5f63 6f65 6666 5f69 6e5b 696e  &ptr_coeff_in[in
-0001a4c0: 645f 7375 7266 2a6e 6c6f 735d 2c0a 2020  d_surf*nlos],.  
-0001a4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a4f0: 2020 2020 2020 2020 2020 2066 6f72 6269             forbi
-0001a500: 6430 2c20 666f 7262 6964 6269 732c 0a20  d0, forbidbis,. 
+0001a200: 2020 7261 795f 6f72 6967 5b31 2c20 2e2e    ray_orig[1, ..
+0001a210: 2e5d 2c0a 2020 2020 2020 2020 2020 2020  .],.            
+0001a220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a240: 2020 2020 2020 2020 6e6c 6f73 2929 0a20          nlos)). 
+0001a250: 2020 2020 2020 2020 2020 2072 6d69 6e32             rmin2
+0001a260: 203d 2072 6d69 6e2a 726d 696e 0a20 2020   = rmin*rmin.   
+0001a270: 2020 2020 2020 2020 2023 2056 6172 6961           # Varia
+0001a280: 626c 6520 746f 2061 766f 6964 206c 6f6f  ble to avoid loo
+0001a290: 6b69 6e67 2022 6265 6869 6e64 2220 626c  king "behind" bl
+0001a2a0: 696e 6420 7370 6f74 206f 6620 746f 7265  ind spot of tore
+0001a2b0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0001a2c0: 666f 7262 6964 3a0a 2020 2020 2020 2020  forbid:.        
+0001a2d0: 2020 2020 2020 2020 666f 7262 6964 302c          forbid0,
+0001a2e0: 2066 6f72 6269 6462 6973 203d 2031 2c20   forbidbis = 1, 
+0001a2f0: 310a 2020 2020 2020 2020 2020 2020 656c  1.            el
+0001a300: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0001a310: 2020 2020 666f 7262 6964 302c 2066 6f72      forbid0, for
+0001a320: 6269 6462 6973 203d 2030 2c20 300a 2020  bidbis = 0, 0.  
+0001a330: 2020 2020 2020 2020 2020 2320 4765 7474            # Gett
+0001a340: 696e 6720 7369 7a65 206f 6620 706f 6c79  ing size of poly
+0001a350: 0a20 2020 2020 2020 2020 2020 206e 7074  .            npt
+0001a360: 735f 706f 6c79 203d 206c 6e76 6572 745b  s_poly = lnvert[
+0001a370: 696e 645f 7375 7266 5d0a 2020 2020 2020  ind_surf].      
+0001a380: 2020 2020 2020 746d 705f 706f 6c79 203d        tmp_poly =
+0001a390: 2076 6573 5f70 6f6c 795b 696e 645f 7375   ves_poly[ind_su
+0001a3a0: 7266 5d0a 2020 2020 2020 2020 2020 2020  rf].            
+0001a3b0: 746d 705f 6e6f 726d 203d 2076 6573 5f6e  tmp_norm = ves_n
+0001a3c0: 6f72 6d5b 696e 645f 7375 7266 5d0a 2020  orm[ind_surf].  
+0001a3d0: 2020 2020 2020 2020 2020 2320 2d2d 2043            # -- C
+0001a3e0: 6f6d 7075 7469 6e67 2069 6e74 6572 7365  omputing interse
+0001a3f0: 6374 696f 6e20 6265 7477 6565 6e20 4c4f  ction between LO
+0001a400: 5320 616e 6420 5665 7373 656c 202d 2d2d  S and Vessel ---
+0001a410: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20  --------------. 
+0001a420: 2020 2020 2020 2020 2020 205f 7274 2e72             _rt.r
+0001a430: 6179 7472 6163 696e 675f 6d69 6e6d 6178  aytracing_minmax
+0001a440: 5f73 7472 7563 745f 746f 7228 6e6c 6f73  _struct_tor(nlos
+0001a450: 2c20 7261 795f 7664 6972 2c20 7261 795f  , ray_vdir, ray_
+0001a460: 6f72 6967 2c0a 2020 2020 2020 2020 2020  orig,.          
+0001a470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a490: 2020 2026 7074 725f 636f 6566 665f 6f75     &ptr_coeff_ou
+0001a4a0: 745b 696e 645f 7375 7266 2a6e 6c6f 735d  t[ind_surf*nlos]
+0001a4b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001a4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a4d0: 2020 2020 2020 2020 2020 2020 2020 2026                 &
+0001a4e0: 7074 725f 636f 6566 665f 696e 5b69 6e64  ptr_coeff_in[ind
+0001a4f0: 5f73 7572 662a 6e6c 6f73 5d2c 0a20 2020  _surf*nlos],.   
+0001a500: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001a510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a530: 2020 2020 2020 2020 2020 2020 726d 696e              rmin
-0001a540: 2c20 726d 696e 322c 2063 7269 7432 5f62  , rmin2, crit2_b
-0001a550: 6173 652c 0a20 2020 2020 2020 2020 2020  ase,.           
-0001a560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a580: 2020 6e70 7473 5f70 6f6c 792c 206c 626f    npts_poly, lbo
-0001a590: 756e 6473 5f76 6573 2c0a 2020 2020 2020  unds_ves,.      
+0001a520: 2020 2020 2020 2020 2020 666f 7262 6964            forbid
+0001a530: 302c 2066 6f72 6269 6462 6973 2c0a 2020  0, forbidbis,.  
+0001a540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a560: 2020 2020 2020 2020 2020 2072 6d69 6e2c             rmin,
+0001a570: 2072 6d69 6e32 2c20 6372 6974 325f 6261   rmin2, crit2_ba
+0001a580: 7365 2c0a 2020 2020 2020 2020 2020 2020  se,.            
+0001a590: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001a5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a5c0: 2020 2020 2020 2061 7265 5f6c 696d 6974         are_limit
-0001a5d0: 6564 2c0a 2020 2020 2020 2020 2020 2020  ed,.            
+0001a5b0: 206e 7074 735f 706f 6c79 2c20 6c62 6f75   npts_poly, lbou
+0001a5c0: 6e64 735f 7665 732c 0a20 2020 2020 2020  nds_ves,.       
+0001a5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001a5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a600: 2026 746d 705f 706f 6c79 5b30 5d5b 305d   &tmp_poly[0][0]
-0001a610: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001a5f0: 2020 2020 2020 6172 655f 6c69 6d69 7465        are_limite
+0001a600: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+0001a610: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001a620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a630: 2020 2020 2020 2020 2020 2020 2020 2026                 &
-0001a640: 746d 705f 706f 6c79 5b31 5d5b 305d 2c0a  tmp_poly[1][0],.
+0001a630: 2674 6d70 5f70 6f6c 795b 305d 5b30 5d2c  &tmp_poly[0][0],
+0001a640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 0001a650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a670: 2020 2020 2020 2020 2020 2020 2026 746d               &tm
-0001a680: 705f 6e6f 726d 5b30 5d5b 305d 2c0a 2020  p_norm[0][0],.  
+0001a660: 2020 2020 2020 2020 2020 2020 2020 2674                &t
+0001a670: 6d70 5f70 6f6c 795b 315d 5b30 5d2c 0a20  mp_poly[1][0],. 
+0001a680: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001a690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a6b0: 2020 2020 2020 2020 2020 2026 746d 705f             &tmp_
-0001a6c0: 6e6f 726d 5b31 5d5b 305d 2c0a 2020 2020  norm[1][0],.    
+0001a6a0: 2020 2020 2020 2020 2020 2020 2674 6d70              &tmp
+0001a6b0: 5f6e 6f72 6d5b 305d 5b30 5d2c 0a20 2020  _norm[0][0],.   
+0001a6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001a6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a6f0: 2020 2020 2020 2020 2065 7073 5f75 7a2c           eps_uz,
-0001a700: 2065 7073 5f76 7a2c 2065 7073 5f61 2c0a   eps_vz, eps_a,.
+0001a6e0: 2020 2020 2020 2020 2020 2674 6d70 5f6e            &tmp_n
+0001a6f0: 6f72 6d5b 315d 5b30 5d2c 0a20 2020 2020  orm[1][0],.     
+0001a700: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001a710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a730: 2020 2020 2020 2020 2020 2020 2065 7073               eps
-0001a740: 5f62 2c20 6570 735f 706c 616e 652c 0a20  _b, eps_plane,. 
+0001a720: 2020 2020 2020 2020 6570 735f 757a 2c20          eps_uz, 
+0001a730: 6570 735f 767a 2c20 6570 735f 612c 0a20  eps_vz, eps_a,. 
+0001a740: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001a750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a770: 2020 2020 2020 2020 2020 2020 6e75 6d5f              num_
-0001a780: 7468 7265 6164 7329 0a20 2020 2065 6c73  threads).    els
-0001a790: 653a 0a20 2020 2020 2020 2023 202e 2e20  e:.        # .. 
-0001a7a0: 6966 2074 6865 7265 2061 7265 2c20 7765  if there are, we
-0001a7b0: 2067 6574 2074 6865 206c 696d 6974 7320   get the limits 
-0001a7c0: 666f 7220 7468 6520 7665 7373 656c 202e  for the vessel .
-0001a7d0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-0001a7e0: 2e2e 2e0a 2020 2020 2020 2020 6966 2076  ....        if v
-0001a7f0: 6573 5f6c 696d 7320 6973 204e 6f6e 6520  es_lims is None 
-0001a800: 206f 7220 6e70 2e73 697a 6528 7665 735f   or np.size(ves_
-0001a810: 6c69 6d73 2920 3d3d 2030 3a0a 2020 2020  lims) == 0:.    
-0001a820: 2020 2020 2020 2020 6172 655f 6c69 6d69          are_limi
-0001a830: 7465 6420 3d20 4661 6c73 650a 2020 2020  ted = False.    
-0001a840: 2020 2020 2020 2020 6c62 6f75 6e64 735f          lbounds_
-0001a850: 7665 735b 305d 203d 2030 0a20 2020 2020  ves[0] = 0.     
-0001a860: 2020 2020 2020 206c 626f 756e 6473 5f76         lbounds_v
-0001a870: 6573 5b31 5d20 3d20 300a 2020 2020 2020  es[1] = 0.      
-0001a880: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001a890: 2020 2020 6172 655f 6c69 6d69 7465 6420      are_limited 
-0001a8a0: 3d20 5472 7565 0a20 2020 2020 2020 2020  = True.         
-0001a8b0: 2020 206c 626f 756e 6473 5f76 6573 5b30     lbounds_ves[0
-0001a8c0: 5d20 3d20 7665 735f 6c69 6d73 5b30 5d0a  ] = ves_lims[0].
-0001a8d0: 2020 2020 2020 2020 2020 2020 6c62 6f75              lbou
-0001a8e0: 6e64 735f 7665 735b 315d 203d 2076 6573  nds_ves[1] = ves
-0001a8f0: 5f6c 696d 735b 315d 0a0a 2020 2020 2020  _lims[1]..      
-0001a900: 2020 2320 2d2d 2043 796c 696e 6472 6963    # -- Cylindric
-0001a910: 616c 2063 6173 6520 2d2d 2d2d 2d2d 2d2d  al case --------
-0001a920: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0001a930: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0001a940: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020  ----------.     
-0001a950: 2020 2066 6f72 2069 6e64 5f73 7572 6620     for ind_surf 
-0001a960: 696e 2072 616e 6765 286e 756d 5f73 7572  in range(num_sur
-0001a970: 6629 3a0a 2020 2020 2020 2020 2020 2020  f):.            
-0001a980: 2320 4765 7474 696e 6720 7369 7a65 206f  # Getting size o
-0001a990: 6620 706f 6c79 0a20 2020 2020 2020 2020  f poly.         
-0001a9a0: 2020 206e 7074 735f 706f 6c79 203d 206c     npts_poly = l
-0001a9b0: 6e76 6572 745b 696e 645f 7375 7266 5d0a  nvert[ind_surf].
-0001a9c0: 2020 2020 2020 2020 2020 2020 746d 705f              tmp_
-0001a9d0: 706f 6c79 203d 2076 6573 5f70 6f6c 795b  poly = ves_poly[
-0001a9e0: 696e 645f 7375 7266 5d0a 2020 2020 2020  ind_surf].      
-0001a9f0: 2020 2020 2020 746d 705f 6e6f 726d 203d        tmp_norm =
-0001aa00: 2076 6573 5f6e 6f72 6d5b 696e 645f 7375   ves_norm[ind_su
-0001aa10: 7266 5d0a 2020 2020 2020 2020 2020 2020  rf].            
-0001aa20: 5f72 742e 7261 7974 7261 6369 6e67 5f6d  _rt.raytracing_m
-0001aa30: 696e 6d61 785f 7374 7275 6374 5f6c 696e  inmax_struct_lin
-0001aa40: 286e 6c6f 732c 2072 6179 5f6f 7269 672c  (nlos, ray_orig,
-0001aa50: 2072 6179 5f76 6469 722c 0a20 2020 2020   ray_vdir,.     
-0001aa60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aa70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aa80: 2020 2020 2020 2020 6e70 7473 5f70 6f6c          npts_pol
-0001aa90: 792c 0a20 2020 2020 2020 2020 2020 2020  y,.             
+0001a760: 2020 2020 2020 2020 2020 2020 6570 735f              eps_
+0001a770: 622c 2065 7073 5f70 6c61 6e65 2c0a 2020  b, eps_plane,.  
+0001a780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a7a0: 2020 2020 2020 2020 2020 206e 756d 5f74             num_t
+0001a7b0: 6872 6561 6473 290a 2020 2020 656c 7365  hreads).    else
+0001a7c0: 3a0a 2020 2020 2020 2020 2320 2e2e 2069  :.        # .. i
+0001a7d0: 6620 7468 6572 6520 6172 652c 2077 6520  f there are, we 
+0001a7e0: 6765 7420 7468 6520 6c69 6d69 7473 2066  get the limits f
+0001a7f0: 6f72 2074 6865 2076 6573 7365 6c20 2e2e  or the vessel ..
+0001a800: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+0001a810: 2e2e 0a20 2020 2020 2020 2069 6620 7665  ...        if ve
+0001a820: 735f 6c69 6d73 2069 7320 4e6f 6e65 2020  s_lims is None  
+0001a830: 6f72 206e 702e 7369 7a65 2876 6573 5f6c  or np.size(ves_l
+0001a840: 696d 7329 203d 3d20 303a 0a20 2020 2020  ims) == 0:.     
+0001a850: 2020 2020 2020 2061 7265 5f6c 696d 6974         are_limit
+0001a860: 6564 203d 2046 616c 7365 0a20 2020 2020  ed = False.     
+0001a870: 2020 2020 2020 206c 626f 756e 6473 5f76         lbounds_v
+0001a880: 6573 5b30 5d20 3d20 300a 2020 2020 2020  es[0] = 0.      
+0001a890: 2020 2020 2020 6c62 6f75 6e64 735f 7665        lbounds_ve
+0001a8a0: 735b 315d 203d 2030 0a20 2020 2020 2020  s[1] = 0.       
+0001a8b0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0001a8c0: 2020 2061 7265 5f6c 696d 6974 6564 203d     are_limited =
+0001a8d0: 2054 7275 650a 2020 2020 2020 2020 2020   True.          
+0001a8e0: 2020 6c62 6f75 6e64 735f 7665 735b 305d    lbounds_ves[0]
+0001a8f0: 203d 2076 6573 5f6c 696d 735b 305d 0a20   = ves_lims[0]. 
+0001a900: 2020 2020 2020 2020 2020 206c 626f 756e             lboun
+0001a910: 6473 5f76 6573 5b31 5d20 3d20 7665 735f  ds_ves[1] = ves_
+0001a920: 6c69 6d73 5b31 5d0a 0a20 2020 2020 2020  lims[1]..       
+0001a930: 2023 202d 2d20 4379 6c69 6e64 7269 6361   # -- Cylindrica
+0001a940: 6c20 6361 7365 202d 2d2d 2d2d 2d2d 2d2d  l case ---------
+0001a950: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0001a960: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0001a970: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 2020  ---------.      
+0001a980: 2020 666f 7220 696e 645f 7375 7266 2069    for ind_surf i
+0001a990: 6e20 7261 6e67 6528 6e75 6d5f 7375 7266  n range(num_surf
+0001a9a0: 293a 0a20 2020 2020 2020 2020 2020 2023  ):.            #
+0001a9b0: 2047 6574 7469 6e67 2073 697a 6520 6f66   Getting size of
+0001a9c0: 2070 6f6c 790a 2020 2020 2020 2020 2020   poly.          
+0001a9d0: 2020 6e70 7473 5f70 6f6c 7920 3d20 6c6e    npts_poly = ln
+0001a9e0: 7665 7274 5b69 6e64 5f73 7572 665d 0a20  vert[ind_surf]. 
+0001a9f0: 2020 2020 2020 2020 2020 2074 6d70 5f70             tmp_p
+0001aa00: 6f6c 7920 3d20 7665 735f 706f 6c79 5b69  oly = ves_poly[i
+0001aa10: 6e64 5f73 7572 665d 0a20 2020 2020 2020  nd_surf].       
+0001aa20: 2020 2020 2074 6d70 5f6e 6f72 6d20 3d20       tmp_norm = 
+0001aa30: 7665 735f 6e6f 726d 5b69 6e64 5f73 7572  ves_norm[ind_sur
+0001aa40: 665d 0a20 2020 2020 2020 2020 2020 205f  f].            _
+0001aa50: 7274 2e72 6179 7472 6163 696e 675f 6d69  rt.raytracing_mi
+0001aa60: 6e6d 6178 5f73 7472 7563 745f 6c69 6e28  nmax_struct_lin(
+0001aa70: 6e6c 6f73 2c20 7261 795f 6f72 6967 2c20  nlos, ray_orig, 
+0001aa80: 7261 795f 7664 6972 2c0a 2020 2020 2020  ray_vdir,.      
+0001aa90: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001aaa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aac0: 2674 6d70 5f70 6f6c 795b 305d 5b30 5d2c  &tmp_poly[0][0],
-0001aad0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001aae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aaf0: 2020 2020 2020 2020 2020 2020 2020 2674                &t
-0001ab00: 6d70 5f70 6f6c 795b 315d 5b30 5d2c 0a20  mp_poly[1][0],. 
+0001aab0: 2020 2020 2020 206e 7074 735f 706f 6c79         npts_poly
+0001aac0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001aad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aae0: 2020 2020 2020 2020 2020 2020 2020 2026                 &
+0001aaf0: 746d 705f 706f 6c79 5b30 5d5b 305d 2c0a  tmp_poly[0][0],.
+0001ab00: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001ab10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ab20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ab30: 2020 2020 2020 2020 2020 2020 2674 6d70              &tmp
-0001ab40: 5f6e 6f72 6d5b 305d 5b30 5d2c 0a20 2020  _norm[0][0],.   
+0001ab20: 2020 2020 2020 2020 2020 2020 2026 746d               &tm
+0001ab30: 705f 706f 6c79 5b31 5d5b 305d 2c0a 2020  p_poly[1][0],.  
+0001ab40: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001ab50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ab60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ab70: 2020 2020 2020 2020 2020 2674 6d70 5f6e            &tmp_n
-0001ab80: 6f72 6d5b 315d 5b30 5d2c 0a20 2020 2020  orm[1][0],.     
+0001ab60: 2020 2020 2020 2020 2020 2026 746d 705f             &tmp_
+0001ab70: 6e6f 726d 5b30 5d5b 305d 2c0a 2020 2020  norm[0][0],.    
+0001ab80: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001ab90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001abb0: 2020 2020 2020 2020 6c62 6f75 6e64 735f          lbounds_
-0001abc0: 7665 735b 305d 2c20 6c62 6f75 6e64 735f  ves[0], lbounds_
-0001abd0: 7665 735b 315d 2c0a 2020 2020 2020 2020  ves[1],.        
-0001abe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001abf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ac00: 2020 2020 2026 7074 725f 636f 6566 665f       &ptr_coeff_
-0001ac10: 6f75 745b 696e 645f 7375 7266 2a6e 6c6f  out[ind_surf*nlo
-0001ac20: 735d 2c0a 2020 2020 2020 2020 2020 2020  s],.            
-0001ac30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ac40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ac50: 2026 7074 725f 636f 6566 665f 696e 5b69   &ptr_coeff_in[i
-0001ac60: 6e64 5f73 7572 662a 6e6c 6f73 5d2c 0a20  nd_surf*nlos],. 
+0001aba0: 2020 2020 2020 2020 2026 746d 705f 6e6f           &tmp_no
+0001abb0: 726d 5b31 5d5b 305d 2c0a 2020 2020 2020  rm[1][0],.      
+0001abc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001abd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001abe0: 2020 2020 2020 206c 626f 756e 6473 5f76         lbounds_v
+0001abf0: 6573 5b30 5d2c 206c 626f 756e 6473 5f76  es[0], lbounds_v
+0001ac00: 6573 5b31 5d2c 0a20 2020 2020 2020 2020  es[1],.         
+0001ac10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ac20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ac30: 2020 2020 2670 7472 5f63 6f65 6666 5f6f      &ptr_coeff_o
+0001ac40: 7574 5b69 6e64 5f73 7572 662a 6e6c 6f73  ut[ind_surf*nlos
+0001ac50: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+0001ac60: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001ac70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ac80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ac90: 2020 2020 2020 2020 2020 2020 6570 735f              eps_
-0001aca0: 706c 616e 6529 0a0a 2020 2020 7265 7475  plane)..    retu
-0001acb0: 726e 206e 702e 6173 6172 7261 7928 636f  rn np.asarray(co
-0001acc0: 6566 665f 696e 7465 725f 696e 292c 206e  eff_inter_in), n
-0001acd0: 702e 6173 6172 7261 7928 636f 6566 665f  p.asarray(coeff_
-0001ace0: 696e 7465 725f 6f75 7429 0a0a 0a64 6566  inter_out)...def
-0001acf0: 2066 6c61 7474 656e 5f6c 7374 7275 6374   flatten_lstruct
-0001ad00: 5f6c 696d 7328 6c69 7374 206c 7374 7275  _lims(list lstru
-0001ad10: 6374 5f6c 696d 7329 202d 3e20 646f 7562  ct_lims) -> doub
-0001ad20: 6c65 5b3a 3a31 5d3a 0a20 2020 2022 2222  le[::1]:.    """
-0001ad30: 0a20 2020 2075 7469 6c69 7461 7279 2066  .    utilitary f
-0001ad40: 756e 6374 696f 6e20 746f 2066 6c61 7474  unction to flatt
-0001ad50: 656e 206c 7374 7275 6374 5f6c 696d 730a  en lstruct_lims.
-0001ad60: 2020 2020 2222 220a 2020 2020 6364 6566      """.    cdef
-0001ad70: 206c 6973 7420 666c 6174 5f6c 6973 740a   list flat_list.
-0001ad80: 2020 2020 6364 6566 2064 6f75 626c 655b      cdef double[
-0001ad90: 3a3a 315d 206c 7374 7275 6374 5f6c 696d  ::1] lstruct_lim
-0001ada0: 735f 6e70 0a20 2020 2069 6620 6c73 7472  s_np.    if lstr
-0001adb0: 7563 745f 6c69 6d73 2069 7320 4e6f 6e65  uct_lims is None
-0001adc0: 206f 7220 6c65 6e28 6c73 7472 7563 745f   or len(lstruct_
-0001add0: 6c69 6d73 2920 3d3d 2030 3a0a 2020 2020  lims) == 0:.    
-0001ade0: 2020 2020 6c73 7472 7563 745f 6c69 6d73      lstruct_lims
-0001adf0: 5f6e 7020 3d20 6e70 2e61 7272 6179 285b  _np = np.array([
-0001ae00: 435f 4e41 4e5d 290a 2020 2020 656c 7365  C_NAN]).    else
-0001ae10: 3a0a 2020 2020 2020 2020 666c 6174 5f6c  :.        flat_l
-0001ae20: 6973 7420 3d20 5b5d 0a20 2020 2020 2020  ist = [].       
-0001ae30: 2066 6f72 2065 6c65 2069 6e20 6c73 7472   for ele in lstr
-0001ae40: 7563 745f 6c69 6d73 3a0a 2020 2020 2020  uct_lims:.      
-0001ae50: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-0001ae60: 6e63 6528 656c 652c 2028 6c69 7374 2c20  nce(ele, (list, 
-0001ae70: 6e70 2e6e 6461 7272 6179 2929 2061 6e64  np.ndarray)) and
-0001ae80: 206e 702e 7369 7a65 2865 6c65 2920 3e20   np.size(ele) > 
-0001ae90: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
-0001aea0: 2020 2066 6f72 2065 6c65 6c65 2069 6e20     for elele in 
-0001aeb0: 656c 653a 0a20 2020 2020 2020 2020 2020  ele:.           
-0001aec0: 2020 2020 2020 2020 2069 6620 7479 7065           if type
-0001aed0: 2865 6c65 6c65 2920 6973 206c 6973 743a  (elele) is list:
-0001aee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001aef0: 2020 2020 2020 2020 2066 6c61 745f 6c69           flat_li
-0001af00: 7374 202b 3d20 656c 656c 650a 2020 2020  st += elele.    
+0001ac80: 2670 7472 5f63 6f65 6666 5f69 6e5b 696e  &ptr_coeff_in[in
+0001ac90: 645f 7375 7266 2a6e 6c6f 735d 2c0a 2020  d_surf*nlos],.  
+0001aca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001acb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001acc0: 2020 2020 2020 2020 2020 2065 7073 5f70             eps_p
+0001acd0: 6c61 6e65 290a 0a20 2020 2072 6574 7572  lane)..    retur
+0001ace0: 6e20 6e70 2e61 7361 7272 6179 2863 6f65  n np.asarray(coe
+0001acf0: 6666 5f69 6e74 6572 5f69 6e29 2c20 6e70  ff_inter_in), np
+0001ad00: 2e61 7361 7272 6179 2863 6f65 6666 5f69  .asarray(coeff_i
+0001ad10: 6e74 6572 5f6f 7574 290a 0a0a 6465 6620  nter_out)...def 
+0001ad20: 666c 6174 7465 6e5f 6c73 7472 7563 745f  flatten_lstruct_
+0001ad30: 6c69 6d73 286c 6973 7420 6c73 7472 7563  lims(list lstruc
+0001ad40: 745f 6c69 6d73 2920 2d3e 2064 6f75 626c  t_lims) -> doubl
+0001ad50: 655b 3a3a 315d 3a0a 2020 2020 2222 220a  e[::1]:.    """.
+0001ad60: 2020 2020 7574 696c 6974 6172 7920 6675      utilitary fu
+0001ad70: 6e63 7469 6f6e 2074 6f20 666c 6174 7465  nction to flatte
+0001ad80: 6e20 6c73 7472 7563 745f 6c69 6d73 0a20  n lstruct_lims. 
+0001ad90: 2020 2022 2222 0a20 2020 2063 6465 6620     """.    cdef 
+0001ada0: 6c69 7374 2066 6c61 745f 6c69 7374 0a20  list flat_list. 
+0001adb0: 2020 2063 6465 6620 646f 7562 6c65 5b3a     cdef double[:
+0001adc0: 3a31 5d20 6c73 7472 7563 745f 6c69 6d73  :1] lstruct_lims
+0001add0: 5f6e 700a 2020 2020 6966 206c 7374 7275  _np.    if lstru
+0001ade0: 6374 5f6c 696d 7320 6973 204e 6f6e 6520  ct_lims is None 
+0001adf0: 6f72 206c 656e 286c 7374 7275 6374 5f6c  or len(lstruct_l
+0001ae00: 696d 7329 203d 3d20 303a 0a20 2020 2020  ims) == 0:.     
+0001ae10: 2020 206c 7374 7275 6374 5f6c 696d 735f     lstruct_lims_
+0001ae20: 6e70 203d 206e 702e 6172 7261 7928 5b43  np = np.array([C
+0001ae30: 5f4e 414e 5d29 0a20 2020 2065 6c73 653a  _NAN]).    else:
+0001ae40: 0a20 2020 2020 2020 2066 6c61 745f 6c69  .        flat_li
+0001ae50: 7374 203d 205b 5d0a 2020 2020 2020 2020  st = [].        
+0001ae60: 666f 7220 656c 6520 696e 206c 7374 7275  for ele in lstru
+0001ae70: 6374 5f6c 696d 733a 0a20 2020 2020 2020  ct_lims:.       
+0001ae80: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+0001ae90: 6365 2865 6c65 2c20 286c 6973 742c 206e  ce(ele, (list, n
+0001aea0: 702e 6e64 6172 7261 7929 2920 616e 6420  p.ndarray)) and 
+0001aeb0: 6e70 2e73 697a 6528 656c 6529 203e 2031  np.size(ele) > 1
+0001aec0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001aed0: 2020 666f 7220 656c 656c 6520 696e 2065    for elele in e
+0001aee0: 6c65 3a0a 2020 2020 2020 2020 2020 2020  le:.            
+0001aef0: 2020 2020 2020 2020 6966 2074 7970 6528          if type(
+0001af00: 656c 656c 6529 2069 7320 6c69 7374 3a0a  elele) is list:.
 0001af10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001af20: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0001af30: 2020 2020 2020 2020 2020 2020 2020 666c                fl
-0001af40: 6174 5f6c 6973 7420 2b3d 2065 6c65 6c65  at_list += elele
-0001af50: 2e66 6c61 7474 656e 2829 2e74 6f6c 6973  .flatten().tolis
-0001af60: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
-0001af70: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0001af80: 2020 2020 2020 666c 6174 5f6c 6973 7420        flat_list 
-0001af90: 2b3d 205b 435f 4e41 4e5d 0a20 2020 2020  += [C_NAN].     
-0001afa0: 2020 206c 7374 7275 6374 5f6c 696d 735f     lstruct_lims_
-0001afb0: 6e70 203d 206e 702e 6172 7261 7928 666c  np = np.array(fl
-0001afc0: 6174 5f6c 6973 7429 0a0a 2020 2020 7265  at_list)..    re
-0001afd0: 7475 726e 206c 7374 7275 6374 5f6c 696d  turn lstruct_lim
-0001afe0: 735f 6e70 0a0a 0a23 203d 3d3d 3d3d 3d3d  s_np...# =======
-0001aff0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001b000: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001b010: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001af20: 2020 2020 2020 2020 666c 6174 5f6c 6973          flat_lis
+0001af30: 7420 2b3d 2065 6c65 6c65 0a20 2020 2020  t += elele.     
+0001af40: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0001af50: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0001af60: 2020 2020 2020 2020 2020 2020 2066 6c61               fla
+0001af70: 745f 6c69 7374 202b 3d20 656c 656c 652e  t_list += elele.
+0001af80: 666c 6174 7465 6e28 292e 746f 6c69 7374  flatten().tolist
+0001af90: 2829 0a20 2020 2020 2020 2020 2020 2065  ().            e
+0001afa0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0001afb0: 2020 2020 2066 6c61 745f 6c69 7374 202b       flat_list +
+0001afc0: 3d20 5b43 5f4e 414e 5d0a 2020 2020 2020  = [C_NAN].      
+0001afd0: 2020 6c73 7472 7563 745f 6c69 6d73 5f6e    lstruct_lims_n
+0001afe0: 7020 3d20 6e70 2e61 7272 6179 2866 6c61  p = np.array(fla
+0001aff0: 745f 6c69 7374 290a 0a20 2020 2072 6574  t_list)..    ret
+0001b000: 7572 6e20 6c73 7472 7563 745f 6c69 6d73  urn lstruct_lims
+0001b010: 5f6e 700a 0a0a 2320 3d3d 3d3d 3d3d 3d3d  _np...# ========
 0001b020: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001b030: 3d3d 3d3d 3d3d 0a23 203d 2054 6f6f 6c73  ======.# = Tools
-0001b040: 2074 6f20 6b6e 6f77 2069 6620 6f6e 6520   to know if one 
-0001b050: 6f72 206d 756c 7469 706c 6520 706f 696e  or multiple poin
-0001b060: 7473 2061 7265 2076 6973 6962 6c65 2066  ts are visible f
-0001b070: 726f 6d20 6f74 6865 7220 706f 696e 7473  rom other points
-0001b080: 0a23 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  .# =============
-0001b090: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001b0a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001b0b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001b030: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001b040: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001b050: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001b060: 3d3d 3d3d 3d0a 2320 3d20 546f 6f6c 7320  =====.# = Tools 
+0001b070: 746f 206b 6e6f 7720 6966 206f 6e65 206f  to know if one o
+0001b080: 7220 6d75 6c74 6970 6c65 2070 6f69 6e74  r multiple point
+0001b090: 7320 6172 6520 7669 7369 626c 6520 6672  s are visible fr
+0001b0a0: 6f6d 206f 7468 6572 2070 6f69 6e74 730a  om other points.
+0001b0b0: 2320 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  # ==============
 0001b0c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001b0d0: 0a64 6566 204c 4f53 5f61 7265 5669 735f  .def LOS_areVis_
-0001b0e0: 5074 7346 726f 6d50 7473 5f56 6573 5374  PtsFromPts_VesSt
-0001b0f0: 7275 6374 286e 702e 6e64 6172 7261 795b  ruct(np.ndarray[
-0001b100: 646f 7562 6c65 2c20 6e64 696d 3d32 2c6d  double, ndim=2,m
-0001b110: 6f64 653d 2763 275d 2070 7473 312c 0a20  ode='c'] pts1,. 
-0001b120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b140: 2020 206e 702e 6e64 6172 7261 795b 646f     np.ndarray[do
-0001b150: 7562 6c65 2c20 6e64 696d 3d32 2c6d 6f64  uble, ndim=2,mod
-0001b160: 653d 2763 275d 2070 7473 322c 0a20 2020  e='c'] pts2,.   
-0001b170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b190: 2064 6f75 626c 655b 3a2c 203a 3a31 5d20   double[:, ::1] 
-0001b1a0: 7665 735f 706f 6c79 3d4e 6f6e 652c 0a20  ves_poly=None,. 
+0001b0d0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001b0e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001b0f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a  ===============.
+0001b100: 6465 6620 4c4f 535f 6172 6556 6973 5f50  def LOS_areVis_P
+0001b110: 7473 4672 6f6d 5074 735f 5665 7353 7472  tsFromPts_VesStr
+0001b120: 7563 7428 6e70 2e6e 6461 7272 6179 5b64  uct(np.ndarray[d
+0001b130: 6f75 626c 652c 206e 6469 6d3d 322c 6d6f  ouble, ndim=2,mo
+0001b140: 6465 3d27 6327 5d20 7074 7331 2c0a 2020  de='c'] pts1,.  
+0001b150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b170: 2020 6e70 2e6e 6461 7272 6179 5b64 6f75    np.ndarray[dou
+0001b180: 626c 652c 206e 6469 6d3d 322c 6d6f 6465  ble, ndim=2,mode
+0001b190: 3d27 6327 5d20 7074 7332 2c0a 2020 2020  ='c'] pts2,.    
+0001b1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001b1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b1d0: 2020 2064 6f75 626c 655b 3a2c 203a 3a31     double[:, ::1
-0001b1e0: 5d20 7665 735f 6e6f 726d 3d4e 6f6e 652c  ] ves_norm=None,
-0001b1f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b210: 2020 2020 2064 6f75 626c 655b 3a2c 203a       double[:, :
-0001b220: 3a31 5d20 6469 7374 3d4e 6f6e 652c 0a20  :1] dist=None,. 
+0001b1c0: 646f 7562 6c65 5b3a 2c20 3a3a 315d 2076  double[:, ::1] v
+0001b1d0: 6573 5f70 6f6c 793d 4e6f 6e65 2c0a 2020  es_poly=None,.  
+0001b1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b200: 2020 646f 7562 6c65 5b3a 2c20 3a3a 315d    double[:, ::1]
+0001b210: 2076 6573 5f6e 6f72 6d3d 4e6f 6e65 2c0a   ves_norm=None,.
+0001b220: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001b230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b250: 2020 2064 6f75 626c 655b 3a3a 315d 2076     double[::1] v
-0001b260: 6573 5f6c 696d 733d 4e6f 6e65 2c0a 2020  es_lims=None,.  
+0001b240: 2020 2020 646f 7562 6c65 5b3a 2c20 3a3a      double[:, ::
+0001b250: 315d 2064 6973 743d 4e6f 6e65 2c0a 2020  1] dist=None,.  
+0001b260: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001b270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b290: 2020 6c6f 6e67 5b3a 3a31 5d20 6c73 7472    long[::1] lstr
-0001b2a0: 7563 745f 6e6c 696d 3d4e 6f6e 652c 0a20  uct_nlim=None,. 
+0001b280: 2020 646f 7562 6c65 5b3a 3a31 5d20 7665    double[::1] ve
+0001b290: 735f 6c69 6d73 3d4e 6f6e 652c 0a20 2020  s_lims=None,.   
+0001b2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001b2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b2d0: 2020 2064 6f75 626c 655b 3a3a 315d 206c     double[::1] l
-0001b2e0: 7374 7275 6374 5f70 6f6c 7978 3d4e 6f6e  struct_polyx=Non
-0001b2f0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0001b300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b310: 2020 2020 2020 2064 6f75 626c 655b 3a3a         double[::
-0001b320: 315d 206c 7374 7275 6374 5f70 6f6c 7979  1] lstruct_polyy
-0001b330: 3d4e 6f6e 652c 0a20 2020 2020 2020 2020  =None,.         
-0001b340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b350: 2020 2020 2020 2020 2020 206c 6973 7420             list 
-0001b360: 6c73 7472 7563 745f 6c69 6d73 3d4e 6f6e  lstruct_lims=Non
-0001b370: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0001b380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b390: 2020 2020 2020 2064 6f75 626c 655b 3a3a         double[::
-0001b3a0: 315d 206c 7374 7275 6374 5f6e 6f72 6d78  1] lstruct_normx
-0001b3b0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2020  =None,.         
-0001b3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b3d0: 2020 2020 2020 2020 2020 2064 6f75 626c             doubl
-0001b3e0: 655b 3a3a 315d 206c 7374 7275 6374 5f6e  e[::1] lstruct_n
-0001b3f0: 6f72 6d79 3d4e 6f6e 652c 0a20 2020 2020  ormy=None,.     
-0001b400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b410: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-0001b420: 6f6e 675b 3a3a 315d 206c 6e76 6572 743d  ong[::1] lnvert=
-0001b430: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
-0001b440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b450: 2020 2020 2020 2020 2020 696e 7420 6e73            int ns
-0001b460: 7472 7563 745f 746f 743d 302c 0a20 2020  truct_tot=0,.   
+0001b2c0: 206c 6f6e 675b 3a3a 315d 206c 7374 7275   long[::1] lstru
+0001b2d0: 6374 5f6e 6c69 6d3d 4e6f 6e65 2c0a 2020  ct_nlim=None,.  
+0001b2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b300: 2020 646f 7562 6c65 5b3a 3a31 5d20 6c73    double[::1] ls
+0001b310: 7472 7563 745f 706f 6c79 783d 4e6f 6e65  truct_polyx=None
+0001b320: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001b330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b340: 2020 2020 2020 646f 7562 6c65 5b3a 3a31        double[::1
+0001b350: 5d20 6c73 7472 7563 745f 706f 6c79 793d  ] lstruct_polyy=
+0001b360: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+0001b370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b380: 2020 2020 2020 2020 2020 6c69 7374 206c            list l
+0001b390: 7374 7275 6374 5f6c 696d 733d 4e6f 6e65  struct_lims=None
+0001b3a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001b3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b3c0: 2020 2020 2020 646f 7562 6c65 5b3a 3a31        double[::1
+0001b3d0: 5d20 6c73 7472 7563 745f 6e6f 726d 783d  ] lstruct_normx=
+0001b3e0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+0001b3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b400: 2020 2020 2020 2020 2020 646f 7562 6c65            double
+0001b410: 5b3a 3a31 5d20 6c73 7472 7563 745f 6e6f  [::1] lstruct_no
+0001b420: 726d 793d 4e6f 6e65 2c0a 2020 2020 2020  rmy=None,.      
+0001b430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b440: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+0001b450: 6e67 5b3a 3a31 5d20 6c6e 7665 7274 3d4e  ng[::1] lnvert=N
+0001b460: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
 0001b470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b490: 2069 6e74 206e 7374 7275 6374 5f6c 696d   int nstruct_lim
-0001b4a0: 3d30 2c0a 2020 2020 2020 2020 2020 2020  =0,.            
+0001b480: 2020 2020 2020 2020 2069 6e74 206e 7374           int nst
+0001b490: 7275 6374 5f74 6f74 3d30 2c0a 2020 2020  ruct_tot=0,.    
+0001b4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001b4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b4c0: 2020 2020 2020 2020 646f 7562 6c65 2072          double r
-0001b4d0: 6d69 6e3d 2d31 2c0a 2020 2020 2020 2020  min=-1,.        
+0001b4c0: 696e 7420 6e73 7472 7563 745f 6c69 6d3d  int nstruct_lim=
+0001b4d0: 302c 0a20 2020 2020 2020 2020 2020 2020  0,.             
 0001b4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b4f0: 2020 2020 2020 2020 2020 2020 646f 7562              doub
-0001b500: 6c65 2065 7073 5f75 7a3d 5f53 4d41 4c4c  le eps_uz=_SMALL
-0001b510: 2c20 646f 7562 6c65 2065 7073 5f61 3d5f  , double eps_a=_
-0001b520: 5653 4d41 4c4c 2c0a 2020 2020 2020 2020  VSMALL,.        
-0001b530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b540: 2020 2020 2020 2020 2020 2020 646f 7562              doub
-0001b550: 6c65 2065 7073 5f76 7a3d 5f56 534d 414c  le eps_vz=_VSMAL
-0001b560: 4c2c 2064 6f75 626c 6520 6570 735f 623d  L, double eps_b=
-0001b570: 5f56 534d 414c 4c2c 0a20 2020 2020 2020  _VSMALL,.       
-0001b580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b590: 2020 2020 2020 2020 2020 2020 2064 6f75               dou
-0001b5a0: 626c 6520 6570 735f 706c 616e 653d 5f56  ble eps_plane=_V
-0001b5b0: 534d 414c 4c2c 0a20 2020 2020 2020 2020  SMALL,.         
-0001b5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b5d0: 2020 2020 2020 2020 2020 2073 7472 2076             str v
-0001b5e0: 6573 5f74 7970 653d 2774 6f72 272c 0a20  es_type='tor',. 
+0001b4f0: 2020 2020 2020 2064 6f75 626c 6520 726d         double rm
+0001b500: 696e 3d2d 312c 0a20 2020 2020 2020 2020  in=-1,.         
+0001b510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b520: 2020 2020 2020 2020 2020 2064 6f75 626c             doubl
+0001b530: 6520 6570 735f 757a 3d5f 534d 414c 4c2c  e eps_uz=_SMALL,
+0001b540: 2064 6f75 626c 6520 6570 735f 613d 5f56   double eps_a=_V
+0001b550: 534d 414c 4c2c 0a20 2020 2020 2020 2020  SMALL,.         
+0001b560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b570: 2020 2020 2020 2020 2020 2064 6f75 626c             doubl
+0001b580: 6520 6570 735f 767a 3d5f 5653 4d41 4c4c  e eps_vz=_VSMALL
+0001b590: 2c20 646f 7562 6c65 2065 7073 5f62 3d5f  , double eps_b=_
+0001b5a0: 5653 4d41 4c4c 2c0a 2020 2020 2020 2020  VSMALL,.        
+0001b5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b5c0: 2020 2020 2020 2020 2020 2020 646f 7562              doub
+0001b5d0: 6c65 2065 7073 5f70 6c61 6e65 3d5f 5653  le eps_plane=_VS
+0001b5e0: 4d41 4c4c 2c0a 2020 2020 2020 2020 2020  MALL,.          
 0001b5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b610: 2020 2062 696e 7420 666f 7262 6964 3d54     bint forbid=T
-0001b620: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
+0001b600: 2020 2020 2020 2020 2020 7374 7220 7665            str ve
+0001b610: 735f 7479 7065 3d27 746f 7227 2c0a 2020  s_type='tor',.  
+0001b620: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001b630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b640: 2020 2020 2020 2020 2062 696e 7420 7465           bint te
-0001b650: 7374 3d54 7275 652c 0a20 2020 2020 2020  st=True,.       
+0001b640: 2020 6269 6e74 2066 6f72 6269 643d 5472    bint forbid=Tr
+0001b650: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
 0001b660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b670: 2020 2020 2020 2020 2020 2020 2069 6e74               int
-0001b680: 206e 756d 5f74 6872 6561 6473 3d31 3629   num_threads=16)
-0001b690: 3a0a 2020 2020 2222 220a 2020 2020 5265  :.    """.    Re
-0001b6a0: 7475 726e 2061 6e20 6172 7261 7920 6f66  turn an array of
-0001b6b0: 2062 6f6f 6c65 616e 7320 696e 6469 6361   booleans indica
-0001b6c0: 7469 6e67 2077 6865 7468 6572 2065 6163  ting whether eac
-0001b6d0: 6820 706f 696e 7420 696e 2070 7473 3120  h point in pts1 
-0001b6e0: 6361 6e20 7365 650a 2020 2020 6561 6368  can see.    each
-0001b6f0: 2070 6f69 6e74 2069 6e20 7074 7332 2063   point in pts2 c
-0001b700: 6f6e 7369 6465 7269 6e67 2076 6967 6e65  onsidering vigne
-0001b710: 7474 696e 6720 6120 6769 7665 6e0a 2020  tting a given.  
-0001b720: 2020 636f 6e66 6967 7572 6174 696f 6e2e    configuration.
-0001b730: 0a20 2020 2020 2020 2070 7473 3120 3a20  .        pts1 : 
-0001b740: 2833 2c20 6e70 7473 3129 2063 6172 7465  (3, npts1) carte
-0001b750: 7369 616e 2063 6f6f 7264 696e 6174 6573  sian coordinates
-0001b760: 206f 6620 7669 6577 696e 6720 706f 696e   of viewing poin
-0001b770: 7473 0a20 2020 2020 2020 2070 7473 3220  ts.        pts2 
-0001b780: 3a20 2833 2c20 6e70 7473 3229 2063 6172  : (3, npts2) car
-0001b790: 7465 7369 616e 2063 6f6f 7264 696e 6174  tesian coordinat
-0001b7a0: 6573 206f 6620 706f 696e 7473 2074 6f20  es of points to 
-0001b7b0: 6368 6563 6b20 6966 2076 6965 7761 626c  check if viewabl
-0001b7c0: 650a 2020 2020 2020 2020 6469 7374 203a  e.        dist :
-0001b7d0: 206f 7074 696f 6e61 6c20 6172 6775 6d65   optional argume
-0001b7e0: 6e74 203a 2064 6973 7461 6e63 6520 6265  nt : distance be
-0001b7f0: 7477 6565 6e20 7468 6520 706f 696e 7473  tween the points
-0001b800: 2070 7473 312c 2070 7473 320a 2020 2020   pts1, pts2.    
-0001b810: 2020 2020 7665 735f 2a20 3a20 7665 7373      ves_* : vess
-0001b820: 656c 2064 6573 6372 6970 746f 7273 2028  el descriptors (
-0001b830: 706f 6c79 2c20 6e6f 726d 2c20 6c69 6d69  poly, norm, limi
-0001b840: 7473 290a 2020 2020 2020 2020 6c73 7472  ts).        lstr
-0001b850: 7563 745f 2a20 3a20 636f 6e66 6967 2773  uct_* : config's
-0001b860: 2073 7472 7563 7475 7265 2064 6573 6372   structure descr
-0001b870: 6970 746f 7273 2028 706f 6c79 2c20 6c69  iptors (poly, li
-0001b880: 6d69 7473 2c20 6e6f 726d 732c 0a20 2020  mits, norms,.   
-0001b890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b8a0: 206e 756d 6265 7220 6f66 2073 7472 7563   number of struc
-0001b8b0: 7475 7265 732c 202e 2e2e 290a 2020 2020  tures, ...).    
-0001b8c0: 2020 2020 6570 735f 2a20 3a20 7661 6c75      eps_* : valu
-0001b8d0: 6573 206f 6620 7072 6563 6973 696f 6e20  es of precision 
-0001b8e0: 696e 2065 6163 6820 6469 7265 6374 696f  in each directio
-0001b8f0: 6e0a 2020 2020 2020 2020 666f 7262 6964  n.        forbid
-0001b900: 203a 2062 6f6f 6c65 616e 2069 6620 7472   : boolean if tr
-0001b910: 7565 2066 6f72 6269 6473 2063 6865 636b  ue forbids check
-0001b920: 696e 6720 2262 6568 696e 6422 2074 6865  ing "behind" the
-0001b930: 2074 6f6b 616d 616b 0a20 2020 2020 2020   tokamak.       
-0001b940: 2074 6573 7420 3a20 626f 6f6c 6561 6e20   test : boolean 
-0001b950: 6368 6563 6b20 6966 2069 6e70 7574 2069  check if input i
-0001b960: 7320 7661 6c69 6420 6f72 206e 6f74 0a20  s valid or not. 
-0001b970: 2020 2020 2020 206e 756d 5f74 6872 6561         num_threa
-0001b980: 6473 203a 206e 756d 6265 7220 6f66 2074  ds : number of t
-0001b990: 6872 6561 6473 2066 6f72 2070 6172 616c  hreads for paral
-0001b9a0: 6c65 6c69 7a61 7469 6f6e 0a20 2020 204f  lelization.    O
-0001b9b0: 7574 7075 743a 0a20 2020 2020 2020 2061  utput:.        a
-0001b9c0: 7265 5f73 6565 6e3a 2028 6e70 7473 312c  re_seen: (npts1,
-0001b9d0: 206e 7074 7332 2920 6172 7261 7920 6f66   npts2) array of
-0001b9e0: 2069 6e74 7320 696e 6469 6361 7469 6e67   ints indicating
-0001b9f0: 2069 6620 7669 6577 696e 6720 706f 696e   if viewing poin
-0001ba00: 7473 2070 7473 310a 2020 2020 2020 2020  ts pts1.        
-0001ba10: 2020 2020 2020 2020 2020 6361 6e20 7365            can se
-0001ba20: 6520 7468 6520 6f74 6865 7220 706f 696e  e the other poin
-0001ba30: 7473 2070 7473 322e 0a20 2020 2020 2020  ts pts2..       
-0001ba40: 2020 2020 2020 2020 2020 2061 7265 5f73             are_s
-0001ba50: 6565 6e5b 692c 6a5d 203d 2031 2069 6620  een[i,j] = 1 if 
-0001ba60: 7074 7331 5b69 5d20 7365 6573 2070 6f69  pts1[i] sees poi
-0001ba70: 6e74 2070 7473 325b 6a5d 0a20 2020 2020  nt pts2[j].     
-0001ba80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ba90: 2020 2020 2020 2020 2020 2020 2030 2065               0 e
-0001baa0: 6c73 650a 2020 2020 2222 220a 2020 2020  lse.    """.    
-0001bab0: 6364 6566 2073 7472 206d 7367 0a20 2020  cdef str msg.   
-0001bac0: 2063 6465 6620 696e 7420 6e70 7473 313d   cdef int npts1=
-0001bad0: 7074 7331 2e73 6861 7065 5b31 5d0a 2020  pts1.shape[1].  
-0001bae0: 2020 6364 6566 2069 6e74 206e 7074 7332    cdef int npts2
-0001baf0: 3d70 7473 322e 7368 6170 655b 315d 0a20  =pts2.shape[1]. 
-0001bb00: 2020 2063 6465 6620 6269 6e74 2062 6f6f     cdef bint boo
-0001bb10: 6c31 2c20 626f 6f6c 320a 2020 2020 6364  l1, bool2.    cd
-0001bb20: 6566 206e 702e 6e64 6172 7261 795b 6c6f  ef np.ndarray[lo
-0001bb30: 6e67 2c20 6e64 696d 3d32 2c20 6d6f 6465  ng, ndim=2, mode
-0001bb40: 3d27 6327 5d20 6172 655f 7365 656e 203d  ='c'] are_seen =
-0001bb50: 206e 702e 656d 7074 7928 286e 7074 7331   np.empty((npts1
-0001bb60: 2c20 6e70 7473 3229 2c0a 2020 2020 2020  , npts2),.      
-0001bb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bba0: 2020 2020 2020 2020 2020 6474 7970 653d            dtype=
-0001bbb0: 696e 7429 0a20 2020 2063 6465 6620 646f  int).    cdef do
-0001bbc0: 7562 6c65 5b3a 3a31 5d20 6c73 7472 7563  uble[::1] lstruc
-0001bbd0: 745f 6c69 6d73 5f6e 700a 2020 2020 2320  t_lims_np.    # 
-0001bbe0: 3d3d 2054 6573 7469 6e67 2069 6e70 7574  == Testing input
-0001bbf0: 7320 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  s ==============
-0001bc00: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001bc10: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001bc20: 3d3d 3d3d 3d3d 3d3d 3d3d 0a20 2020 2069  ==========.    i
-0001bc30: 6620 7465 7374 3a0a 2020 2020 2020 2020  f test:.        
-0001bc40: 6d73 6720 3d20 2276 6573 5f70 6f6c 7920  msg = "ves_poly 
-0001bc50: 616e 6420 7665 735f 6e6f 726d 2061 7265  and ves_norm are
-0001bc60: 206e 6f74 206f 7074 696f 6e61 6c20 6172   not optional ar
-0001bc70: 6775 6d65 6e74 7322 0a20 2020 2020 2020  guments".       
-0001bc80: 2061 7373 6572 7420 7665 735f 706f 6c79   assert ves_poly
-0001bc90: 2069 7320 6e6f 7420 4e6f 6e65 2061 6e64   is not None and
-0001bca0: 2076 6573 5f6e 6f72 6d20 6973 206e 6f74   ves_norm is not
-0001bcb0: 204e 6f6e 652c 206d 7367 0a20 2020 2020   None, msg.     
-0001bcc0: 2020 2062 6f6f 6c31 203d 2028 7665 735f     bool1 = (ves_
-0001bcd0: 706f 6c79 2e73 6861 7065 5b30 5d3d 3d32  poly.shape[0]==2
-0001bce0: 2061 6e64 2076 6573 5f6e 6f72 6d2e 7368   and ves_norm.sh
-0001bcf0: 6170 655b 305d 3d3d 320a 2020 2020 2020  ape[0]==2.      
-0001bd00: 2020 2020 2020 2020 616e 6420 7665 735f          and ves_
-0001bd10: 6e6f 726d 2e73 6861 7065 5b31 5d3d 3d76  norm.shape[1]==v
-0001bd20: 6573 5f70 6f6c 792e 7368 6170 655b 315d  es_poly.shape[1]
-0001bd30: 2d31 290a 2020 2020 2020 2020 6d73 6720  -1).        msg 
-0001bd40: 3d20 2241 7267 7320 7665 735f 706f 6c79  = "Args ves_poly
-0001bd50: 2061 6e64 2076 6573 5f6e 6f72 6d20 6d75   and ves_norm mu
-0001bd60: 7374 2062 6520 6f66 2074 6865 2073 616d  st be of the sam
-0001bd70: 6520 7368 6170 6520 2832 2c4e 5329 2122  e shape (2,NS)!"
-0001bd80: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0001bd90: 626f 6f6c 312c 206d 7367 0a20 2020 2020  bool1, msg.     
-0001bda0: 2020 2062 6f6f 6c31 203d 206c 7374 7275     bool1 = lstru
-0001bdb0: 6374 5f6c 696d 7320 6973 204e 6f6e 6520  ct_lims is None 
-0001bdc0: 6f72 206c 656e 286c 7374 7275 6374 5f6e  or len(lstruct_n
-0001bdd0: 6f72 6d79 2920 3d3d 206c 656e 286c 7374  ormy) == len(lst
-0001bde0: 7275 6374 5f6e 6f72 6d78 290a 2020 2020  ruct_normx).    
-0001bdf0: 2020 2020 626f 6f6c 3220 3d20 6c73 7472      bool2 = lstr
-0001be00: 7563 745f 6e6f 726d 7820 6973 204e 6f6e  uct_normx is Non
-0001be10: 6520 6f72 206c 656e 286c 7374 7275 6374  e or len(lstruct
-0001be20: 5f70 6f6c 7978 2920 3d3d 206c 656e 286c  _polyx) == len(l
-0001be30: 7374 7275 6374 5f70 6f6c 7979 290a 2020  struct_polyy).  
-0001be40: 2020 2020 2020 6d73 6720 3d20 2241 7267        msg = "Arg
-0001be50: 7320 6c73 7472 7563 745f 706f 6c79 782c  s lstruct_polyx,
-0001be60: 206c 7374 7275 6374 5f70 6f6c 7979 2c20   lstruct_polyy, 
-0001be70: 6c73 7472 7563 745f 6c69 6d73 2c20 6c73  lstruct_lims, ls
-0001be80: 7472 7563 745f 6e6f 726d 782c 225c 0a20  truct_normx,"\. 
-0001be90: 2020 2020 2020 2020 2020 2020 202b 2022               + "
-0001bea0: 206c 7374 7275 6374 5f6e 6f72 6d79 2c20   lstruct_normy, 
-0001beb0: 6d75 7374 2062 6520 4e6f 6e65 206f 7220  must be None or 
-0001bec0: 6c69 7374 7320 6f66 2073 616d 6520 6c65  lists of same le
-0001bed0: 6e28 2921 220a 2020 2020 2020 2020 6173  n()!".        as
-0001bee0: 7365 7274 2062 6f6f 6c31 2061 6e64 2062  sert bool1 and b
-0001bef0: 6f6f 6c32 2c20 6d73 670a 2020 2020 2020  ool2, msg.      
-0001bf00: 2020 6d73 6720 3d20 225b 6570 735f 757a    msg = "[eps_uz
-0001bf10: 2c65 7073 5f76 7a2c 6570 735f 612c 6570  ,eps_vz,eps_a,ep
-0001bf20: 735f 625d 206d 7573 7420 6265 2066 6c6f  s_b] must be flo
-0001bf30: 6174 7320 3c20 312e 652d 3421 220a 2020  ats < 1.e-4!".  
-0001bf40: 2020 2020 2020 6173 7365 7274 2061 6c6c        assert all
-0001bf50: 285b 6565 203c 2031 2e65 2d34 2066 6f72  ([ee < 1.e-4 for
-0001bf60: 2065 6520 696e 205b 6570 735f 757a 2c20   ee in [eps_uz, 
-0001bf70: 6570 735f 612c 0a20 2020 2020 2020 2020  eps_a,.         
-0001bf80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bf90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bfa0: 2065 7073 5f76 7a2c 2065 7073 5f62 2c0a   eps_vz, eps_b,.
+0001b670: 2020 2020 2020 2020 6269 6e74 2074 6573          bint tes
+0001b680: 743d 5472 7565 2c0a 2020 2020 2020 2020  t=True,.        
+0001b690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b6a0: 2020 2020 2020 2020 2020 2020 696e 7420              int 
+0001b6b0: 6e75 6d5f 7468 7265 6164 733d 3136 293a  num_threads=16):
+0001b6c0: 0a20 2020 2022 2222 0a20 2020 2052 6574  .    """.    Ret
+0001b6d0: 7572 6e20 616e 2061 7272 6179 206f 6620  urn an array of 
+0001b6e0: 626f 6f6c 6561 6e73 2069 6e64 6963 6174  booleans indicat
+0001b6f0: 696e 6720 7768 6574 6865 7220 6561 6368  ing whether each
+0001b700: 2070 6f69 6e74 2069 6e20 7074 7331 2063   point in pts1 c
+0001b710: 616e 2073 6565 0a20 2020 2065 6163 6820  an see.    each 
+0001b720: 706f 696e 7420 696e 2070 7473 3220 636f  point in pts2 co
+0001b730: 6e73 6964 6572 696e 6720 7669 676e 6574  nsidering vignet
+0001b740: 7469 6e67 2061 2067 6976 656e 0a20 2020  ting a given.   
+0001b750: 2063 6f6e 6669 6775 7261 7469 6f6e 2e0a   configuration..
+0001b760: 2020 2020 2020 2020 7074 7331 203a 2028          pts1 : (
+0001b770: 332c 206e 7074 7331 2920 6361 7274 6573  3, npts1) cartes
+0001b780: 6961 6e20 636f 6f72 6469 6e61 7465 7320  ian coordinates 
+0001b790: 6f66 2076 6965 7769 6e67 2070 6f69 6e74  of viewing point
+0001b7a0: 730a 2020 2020 2020 2020 7074 7332 203a  s.        pts2 :
+0001b7b0: 2028 332c 206e 7074 7332 2920 6361 7274   (3, npts2) cart
+0001b7c0: 6573 6961 6e20 636f 6f72 6469 6e61 7465  esian coordinate
+0001b7d0: 7320 6f66 2070 6f69 6e74 7320 746f 2063  s of points to c
+0001b7e0: 6865 636b 2069 6620 7669 6577 6162 6c65  heck if viewable
+0001b7f0: 0a20 2020 2020 2020 2064 6973 7420 3a20  .        dist : 
+0001b800: 6f70 7469 6f6e 616c 2061 7267 756d 656e  optional argumen
+0001b810: 7420 3a20 6469 7374 616e 6365 2062 6574  t : distance bet
+0001b820: 7765 656e 2074 6865 2070 6f69 6e74 7320  ween the points 
+0001b830: 7074 7331 2c20 7074 7332 0a20 2020 2020  pts1, pts2.     
+0001b840: 2020 2076 6573 5f2a 203a 2076 6573 7365     ves_* : vesse
+0001b850: 6c20 6465 7363 7269 7074 6f72 7320 2870  l descriptors (p
+0001b860: 6f6c 792c 206e 6f72 6d2c 206c 696d 6974  oly, norm, limit
+0001b870: 7329 0a20 2020 2020 2020 206c 7374 7275  s).        lstru
+0001b880: 6374 5f2a 203a 2063 6f6e 6669 6727 7320  ct_* : config's 
+0001b890: 7374 7275 6374 7572 6520 6465 7363 7269  structure descri
+0001b8a0: 7074 6f72 7320 2870 6f6c 792c 206c 696d  ptors (poly, lim
+0001b8b0: 6974 732c 206e 6f72 6d73 2c0a 2020 2020  its, norms,.    
+0001b8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b8d0: 6e75 6d62 6572 206f 6620 7374 7275 6374  number of struct
+0001b8e0: 7572 6573 2c20 2e2e 2e29 0a20 2020 2020  ures, ...).     
+0001b8f0: 2020 2065 7073 5f2a 203a 2076 616c 7565     eps_* : value
+0001b900: 7320 6f66 2070 7265 6369 7369 6f6e 2069  s of precision i
+0001b910: 6e20 6561 6368 2064 6972 6563 7469 6f6e  n each direction
+0001b920: 0a20 2020 2020 2020 2066 6f72 6269 6420  .        forbid 
+0001b930: 3a20 626f 6f6c 6561 6e20 6966 2074 7275  : boolean if tru
+0001b940: 6520 666f 7262 6964 7320 6368 6563 6b69  e forbids checki
+0001b950: 6e67 2022 6265 6869 6e64 2220 7468 6520  ng "behind" the 
+0001b960: 746f 6b61 6d61 6b0a 2020 2020 2020 2020  tokamak.        
+0001b970: 7465 7374 203a 2062 6f6f 6c65 616e 2063  test : boolean c
+0001b980: 6865 636b 2069 6620 696e 7075 7420 6973  heck if input is
+0001b990: 2076 616c 6964 206f 7220 6e6f 740a 2020   valid or not.  
+0001b9a0: 2020 2020 2020 6e75 6d5f 7468 7265 6164        num_thread
+0001b9b0: 7320 3a20 6e75 6d62 6572 206f 6620 7468  s : number of th
+0001b9c0: 7265 6164 7320 666f 7220 7061 7261 6c6c  reads for parall
+0001b9d0: 656c 697a 6174 696f 6e0a 2020 2020 4f75  elization.    Ou
+0001b9e0: 7470 7574 3a0a 2020 2020 2020 2020 6172  tput:.        ar
+0001b9f0: 655f 7365 656e 3a20 286e 7074 7331 2c20  e_seen: (npts1, 
+0001ba00: 6e70 7473 3229 2061 7272 6179 206f 6620  npts2) array of 
+0001ba10: 696e 7473 2069 6e64 6963 6174 696e 6720  ints indicating 
+0001ba20: 6966 2076 6965 7769 6e67 2070 6f69 6e74  if viewing point
+0001ba30: 7320 7074 7331 0a20 2020 2020 2020 2020  s pts1.         
+0001ba40: 2020 2020 2020 2020 2063 616e 2073 6565           can see
+0001ba50: 2074 6865 206f 7468 6572 2070 6f69 6e74   the other point
+0001ba60: 7320 7074 7332 2e0a 2020 2020 2020 2020  s pts2..        
+0001ba70: 2020 2020 2020 2020 2020 6172 655f 7365            are_se
+0001ba80: 656e 5b69 2c6a 5d20 3d20 3120 6966 2070  en[i,j] = 1 if p
+0001ba90: 7473 315b 695d 2073 6565 7320 706f 696e  ts1[i] sees poin
+0001baa0: 7420 7074 7332 5b6a 5d0a 2020 2020 2020  t pts2[j].      
+0001bab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bac0: 2020 2020 2020 2020 2020 2020 3020 656c              0 el
+0001bad0: 7365 0a20 2020 2022 2222 0a20 2020 2063  se.    """.    c
+0001bae0: 6465 6620 7374 7220 6d73 670a 2020 2020  def str msg.    
+0001baf0: 6364 6566 2069 6e74 206e 7074 7331 3d70  cdef int npts1=p
+0001bb00: 7473 312e 7368 6170 655b 315d 0a20 2020  ts1.shape[1].   
+0001bb10: 2063 6465 6620 696e 7420 6e70 7473 323d   cdef int npts2=
+0001bb20: 7074 7332 2e73 6861 7065 5b31 5d0a 2020  pts2.shape[1].  
+0001bb30: 2020 6364 6566 2062 696e 7420 626f 6f6c    cdef bint bool
+0001bb40: 312c 2062 6f6f 6c32 0a20 2020 2063 6465  1, bool2.    cde
+0001bb50: 6620 6e70 2e6e 6461 7272 6179 5b6c 6f6e  f np.ndarray[lon
+0001bb60: 672c 206e 6469 6d3d 322c 206d 6f64 653d  g, ndim=2, mode=
+0001bb70: 2763 275d 2061 7265 5f73 6565 6e20 3d20  'c'] are_seen = 
+0001bb80: 6e70 2e65 6d70 7479 2828 6e70 7473 312c  np.empty((npts1,
+0001bb90: 206e 7074 7332 292c 0a20 2020 2020 2020   npts2),.       
+0001bba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bbd0: 2020 2020 2020 2020 2064 7479 7065 3d69           dtype=i
+0001bbe0: 6e74 290a 2020 2020 6364 6566 2064 6f75  nt).    cdef dou
+0001bbf0: 626c 655b 3a3a 315d 206c 7374 7275 6374  ble[::1] lstruct
+0001bc00: 5f6c 696d 735f 6e70 0a20 2020 2023 203d  _lims_np.    # =
+0001bc10: 3d20 5465 7374 696e 6720 696e 7075 7473  = Testing inputs
+0001bc20: 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d   ===============
+0001bc30: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001bc40: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001bc50: 3d3d 3d3d 3d3d 3d3d 3d0a 2020 2020 6966  =========.    if
+0001bc60: 2074 6573 743a 0a20 2020 2020 2020 206d   test:.        m
+0001bc70: 7367 203d 2022 7665 735f 706f 6c79 2061  sg = "ves_poly a
+0001bc80: 6e64 2076 6573 5f6e 6f72 6d20 6172 6520  nd ves_norm are 
+0001bc90: 6e6f 7420 6f70 7469 6f6e 616c 2061 7267  not optional arg
+0001bca0: 756d 656e 7473 220a 2020 2020 2020 2020  uments".        
+0001bcb0: 6173 7365 7274 2076 6573 5f70 6f6c 7920  assert ves_poly 
+0001bcc0: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
+0001bcd0: 7665 735f 6e6f 726d 2069 7320 6e6f 7420  ves_norm is not 
+0001bce0: 4e6f 6e65 2c20 6d73 670a 2020 2020 2020  None, msg.      
+0001bcf0: 2020 626f 6f6c 3120 3d20 2876 6573 5f70    bool1 = (ves_p
+0001bd00: 6f6c 792e 7368 6170 655b 305d 3d3d 3220  oly.shape[0]==2 
+0001bd10: 616e 6420 7665 735f 6e6f 726d 2e73 6861  and ves_norm.sha
+0001bd20: 7065 5b30 5d3d 3d32 0a20 2020 2020 2020  pe[0]==2.       
+0001bd30: 2020 2020 2020 2061 6e64 2076 6573 5f6e         and ves_n
+0001bd40: 6f72 6d2e 7368 6170 655b 315d 3d3d 7665  orm.shape[1]==ve
+0001bd50: 735f 706f 6c79 2e73 6861 7065 5b31 5d2d  s_poly.shape[1]-
+0001bd60: 3129 0a20 2020 2020 2020 206d 7367 203d  1).        msg =
+0001bd70: 2022 4172 6773 2076 6573 5f70 6f6c 7920   "Args ves_poly 
+0001bd80: 616e 6420 7665 735f 6e6f 726d 206d 7573  and ves_norm mus
+0001bd90: 7420 6265 206f 6620 7468 6520 7361 6d65  t be of the same
+0001bda0: 2073 6861 7065 2028 322c 4e53 2921 220a   shape (2,NS)!".
+0001bdb0: 2020 2020 2020 2020 6173 7365 7274 2062          assert b
+0001bdc0: 6f6f 6c31 2c20 6d73 670a 2020 2020 2020  ool1, msg.      
+0001bdd0: 2020 626f 6f6c 3120 3d20 6c73 7472 7563    bool1 = lstruc
+0001bde0: 745f 6c69 6d73 2069 7320 4e6f 6e65 206f  t_lims is None o
+0001bdf0: 7220 6c65 6e28 6c73 7472 7563 745f 6e6f  r len(lstruct_no
+0001be00: 726d 7929 203d 3d20 6c65 6e28 6c73 7472  rmy) == len(lstr
+0001be10: 7563 745f 6e6f 726d 7829 0a20 2020 2020  uct_normx).     
+0001be20: 2020 2062 6f6f 6c32 203d 206c 7374 7275     bool2 = lstru
+0001be30: 6374 5f6e 6f72 6d78 2069 7320 4e6f 6e65  ct_normx is None
+0001be40: 206f 7220 6c65 6e28 6c73 7472 7563 745f   or len(lstruct_
+0001be50: 706f 6c79 7829 203d 3d20 6c65 6e28 6c73  polyx) == len(ls
+0001be60: 7472 7563 745f 706f 6c79 7929 0a20 2020  truct_polyy).   
+0001be70: 2020 2020 206d 7367 203d 2022 4172 6773       msg = "Args
+0001be80: 206c 7374 7275 6374 5f70 6f6c 7978 2c20   lstruct_polyx, 
+0001be90: 6c73 7472 7563 745f 706f 6c79 792c 206c  lstruct_polyy, l
+0001bea0: 7374 7275 6374 5f6c 696d 732c 206c 7374  struct_lims, lst
+0001beb0: 7275 6374 5f6e 6f72 6d78 2c22 5c0a 2020  ruct_normx,"\.  
+0001bec0: 2020 2020 2020 2020 2020 2020 2b20 2220              + " 
+0001bed0: 6c73 7472 7563 745f 6e6f 726d 792c 206d  lstruct_normy, m
+0001bee0: 7573 7420 6265 204e 6f6e 6520 6f72 206c  ust be None or l
+0001bef0: 6973 7473 206f 6620 7361 6d65 206c 656e  ists of same len
+0001bf00: 2829 2122 0a20 2020 2020 2020 2061 7373  ()!".        ass
+0001bf10: 6572 7420 626f 6f6c 3120 616e 6420 626f  ert bool1 and bo
+0001bf20: 6f6c 322c 206d 7367 0a20 2020 2020 2020  ol2, msg.       
+0001bf30: 206d 7367 203d 2022 5b65 7073 5f75 7a2c   msg = "[eps_uz,
+0001bf40: 6570 735f 767a 2c65 7073 5f61 2c65 7073  eps_vz,eps_a,eps
+0001bf50: 5f62 5d20 6d75 7374 2062 6520 666c 6f61  _b] must be floa
+0001bf60: 7473 203c 2031 2e65 2d34 2122 0a20 2020  ts < 1.e-4!".   
+0001bf70: 2020 2020 2061 7373 6572 7420 616c 6c28       assert all(
+0001bf80: 5b65 6520 3c20 312e 652d 3420 666f 7220  [ee < 1.e-4 for 
+0001bf90: 6565 2069 6e20 5b65 7073 5f75 7a2c 2065  ee in [eps_uz, e
+0001bfa0: 7073 5f61 2c0a 2020 2020 2020 2020 2020  ps_a,.          
 0001bfb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001bfc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bfd0: 2020 2020 2020 2020 2020 6570 735f 706c            eps_pl
-0001bfe0: 616e 655d 5d29 2c20 6d73 670a 2020 2020  ane]]), msg.    
-0001bff0: 2020 2020 6d73 6720 3d20 2276 6573 5f74      msg = "ves_t
-0001c000: 7970 6520 6d75 7374 2062 6520 6120 7374  ype must be a st
-0001c010: 7220 696e 205b 2754 6f72 272c 274c 696e  r in ['Tor','Lin
-0001c020: 275d 2122 0a20 2020 2020 2020 2061 7373  ']!".        ass
-0001c030: 6572 7420 7665 735f 7479 7065 2e6c 6f77  ert ves_type.low
-0001c040: 6572 2829 2069 6e20 5b27 746f 7227 2c20  er() in ['tor', 
-0001c050: 276c 696e 275d 2c20 6d73 670a 0a20 2020  'lin'], msg..   
-0001c060: 206c 7374 7275 6374 5f6c 696d 735f 6e70   lstruct_lims_np
-0001c070: 203d 2066 6c61 7474 656e 5f6c 7374 7275   = flatten_lstru
-0001c080: 6374 5f6c 696d 7328 6c73 7472 7563 745f  ct_lims(lstruct_
-0001c090: 6c69 6d73 290a 2020 2020 5f72 742e 6172  lims).    _rt.ar
-0001c0a0: 655f 7669 7369 626c 655f 7665 635f 7665  e_visible_vec_ve
-0001c0b0: 6328 7074 7331 2c20 6e70 7473 312c 0a20  c(pts1, npts1,. 
-0001c0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c0d0: 2020 2020 2020 2020 2020 2070 7473 322c             pts2,
-0001c0e0: 206e 7074 7332 2c0a 2020 2020 2020 2020   npts2,.        
+0001bfd0: 6570 735f 767a 2c20 6570 735f 622c 0a20  eps_vz, eps_b,. 
+0001bfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c000: 2020 2020 2020 2020 2065 7073 5f70 6c61           eps_pla
+0001c010: 6e65 5d5d 292c 206d 7367 0a20 2020 2020  ne]]), msg.     
+0001c020: 2020 206d 7367 203d 2022 7665 735f 7479     msg = "ves_ty
+0001c030: 7065 206d 7573 7420 6265 2061 2073 7472  pe must be a str
+0001c040: 2069 6e20 5b27 546f 7227 2c27 4c69 6e27   in ['Tor','Lin'
+0001c050: 5d21 220a 2020 2020 2020 2020 6173 7365  ]!".        asse
+0001c060: 7274 2076 6573 5f74 7970 652e 6c6f 7765  rt ves_type.lowe
+0001c070: 7228 2920 696e 205b 2774 6f72 272c 2027  r() in ['tor', '
+0001c080: 6c69 6e27 5d2c 206d 7367 0a0a 2020 2020  lin'], msg..    
+0001c090: 6c73 7472 7563 745f 6c69 6d73 5f6e 7020  lstruct_lims_np 
+0001c0a0: 3d20 666c 6174 7465 6e5f 6c73 7472 7563  = flatten_lstruc
+0001c0b0: 745f 6c69 6d73 286c 7374 7275 6374 5f6c  t_lims(lstruct_l
+0001c0c0: 696d 7329 0a20 2020 205f 7274 2e61 7265  ims).    _rt.are
+0001c0d0: 5f76 6973 6962 6c65 5f76 6563 5f76 6563  _visible_vec_vec
+0001c0e0: 2870 7473 312c 206e 7074 7331 2c0a 2020  (pts1, npts1,.  
 0001c0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c100: 2020 2020 7665 735f 706f 6c79 2c20 7665      ves_poly, ve
-0001c110: 735f 6e6f 726d 2c0a 2020 2020 2020 2020  s_norm,.        
+0001c100: 2020 2020 2020 2020 2020 7074 7332 2c20            pts2, 
+0001c110: 6e70 7473 322c 0a20 2020 2020 2020 2020  npts2,.         
 0001c120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c130: 2020 2020 6172 655f 7365 656e 2c20 6469      are_seen, di
-0001c140: 7374 2c20 7665 735f 6c69 6d73 2c0a 2020  st, ves_lims,.  
+0001c130: 2020 2076 6573 5f70 6f6c 792c 2076 6573     ves_poly, ves
+0001c140: 5f6e 6f72 6d2c 0a20 2020 2020 2020 2020  _norm,.         
 0001c150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c160: 2020 2020 2020 2020 2020 6c73 7472 7563            lstruc
-0001c170: 745f 6e6c 696d 2c0a 2020 2020 2020 2020  t_nlim,.        
+0001c160: 2020 2061 7265 5f73 6565 6e2c 2064 6973     are_seen, dis
+0001c170: 742c 2076 6573 5f6c 696d 732c 0a20 2020  t, ves_lims,.   
 0001c180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c190: 2020 2020 6c73 7472 7563 745f 706f 6c79      lstruct_poly
-0001c1a0: 782c 206c 7374 7275 6374 5f70 6f6c 7979  x, lstruct_polyy
-0001c1b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001c1c0: 2020 2020 2020 2020 2020 2020 2020 6c73                ls
-0001c1d0: 7472 7563 745f 6c69 6d73 5f6e 702c 0a20  truct_lims_np,. 
-0001c1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c1f0: 2020 2020 2020 2020 2020 206c 7374 7275             lstru
-0001c200: 6374 5f6e 6f72 6d78 2c20 6c73 7472 7563  ct_normx, lstruc
-0001c210: 745f 6e6f 726d 792c 0a20 2020 2020 2020  t_normy,.       
-0001c220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c230: 2020 2020 206c 6e76 6572 742c 206e 7374       lnvert, nst
-0001c240: 7275 6374 5f74 6f74 2c20 6e73 7472 7563  ruct_tot, nstruc
-0001c250: 745f 6c69 6d2c 0a20 2020 2020 2020 2020  t_lim,.         
-0001c260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c270: 2020 2072 6d69 6e2c 2065 7073 5f75 7a2c     rmin, eps_uz,
-0001c280: 2065 7073 5f61 2c20 6570 735f 767a 2c20   eps_a, eps_vz, 
-0001c290: 6570 735f 622c 0a20 2020 2020 2020 2020  eps_b,.         
-0001c2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c2b0: 2020 2065 7073 5f70 6c61 6e65 2c20 7665     eps_plane, ve
-0001c2c0: 735f 7479 7065 2e6c 6f77 6572 2829 3d3d  s_type.lower()==
-0001c2d0: 2774 6f72 272c 0a20 2020 2020 2020 2020  'tor',.         
-0001c2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c2f0: 2020 2066 6f72 6269 642c 206e 756d 5f74     forbid, num_t
-0001c300: 6872 6561 6473 290a 2020 2020 7265 7475  hreads).    retu
-0001c310: 726e 2061 7265 5f73 6565 6e0a 0a0a 6465  rn are_seen...de
-0001c320: 6620 4c4f 535f 6973 5669 735f 5074 4672  f LOS_isVis_PtFr
-0001c330: 6f6d 5074 735f 5665 7353 7472 7563 7428  omPts_VesStruct(
-0001c340: 0a20 2020 2064 6f75 626c 6520 7074 302c  .    double pt0,
-0001c350: 2064 6f75 626c 6520 7074 312c 2064 6f75   double pt1, dou
-0001c360: 626c 6520 7074 322c 0a20 2020 206e 702e  ble pt2,.    np.
-0001c370: 6e64 6172 7261 795b 646f 7562 6c65 2c20  ndarray[double, 
-0001c380: 6e64 696d 3d32 2c6d 6f64 653d 2763 275d  ndim=2,mode='c']
-0001c390: 2070 7473 2c0a 2020 2020 646f 7562 6c65   pts,.    double
-0001c3a0: 5b3a 3a31 5d20 6469 7374 3d4e 6f6e 652c  [::1] dist=None,
-0001c3b0: 0a20 2020 2064 6f75 626c 655b 3a2c 203a  .    double[:, :
-0001c3c0: 3a31 5d20 7665 735f 706f 6c79 3d4e 6f6e  :1] ves_poly=Non
-0001c3d0: 652c 0a20 2020 2064 6f75 626c 655b 3a2c  e,.    double[:,
-0001c3e0: 203a 3a31 5d20 7665 735f 6e6f 726d 3d4e   ::1] ves_norm=N
-0001c3f0: 6f6e 652c 0a20 2020 2064 6f75 626c 655b  one,.    double[
-0001c400: 3a3a 315d 2076 6573 5f6c 696d 733d 4e6f  ::1] ves_lims=No
-0001c410: 6e65 2c0a 2020 2020 6c6f 6e67 5b3a 3a31  ne,.    long[::1
-0001c420: 5d20 6c73 7472 7563 745f 6e6c 696d 3d4e  ] lstruct_nlim=N
-0001c430: 6f6e 652c 0a20 2020 2064 6f75 626c 655b  one,.    double[
-0001c440: 3a3a 315d 206c 7374 7275 6374 5f70 6f6c  ::1] lstruct_pol
-0001c450: 7978 3d4e 6f6e 652c 0a20 2020 2064 6f75  yx=None,.    dou
-0001c460: 626c 655b 3a3a 315d 206c 7374 7275 6374  ble[::1] lstruct
-0001c470: 5f70 6f6c 7979 3d4e 6f6e 652c 0a20 2020  _polyy=None,.   
-0001c480: 206c 6973 7420 6c73 7472 7563 745f 6c69   list lstruct_li
-0001c490: 6d73 3d4e 6f6e 652c 0a20 2020 2064 6f75  ms=None,.    dou
-0001c4a0: 626c 655b 3a3a 315d 206c 7374 7275 6374  ble[::1] lstruct
-0001c4b0: 5f6e 6f72 6d78 3d4e 6f6e 652c 0a20 2020  _normx=None,.   
-0001c4c0: 2064 6f75 626c 655b 3a3a 315d 206c 7374   double[::1] lst
-0001c4d0: 7275 6374 5f6e 6f72 6d79 3d4e 6f6e 652c  ruct_normy=None,
-0001c4e0: 0a20 2020 206c 6f6e 675b 3a3a 315d 206c  .    long[::1] l
-0001c4f0: 6e76 6572 743d 4e6f 6e65 2c0a 2020 2020  nvert=None,.    
-0001c500: 696e 7420 6e73 7472 7563 745f 746f 743d  int nstruct_tot=
-0001c510: 302c 0a20 2020 2069 6e74 206e 7374 7275  0,.    int nstru
-0001c520: 6374 5f6c 696d 3d30 2c0a 2020 2020 646f  ct_lim=0,.    do
-0001c530: 7562 6c65 2072 6d69 6e3d 2d31 2c0a 2020  uble rmin=-1,.  
-0001c540: 2020 646f 7562 6c65 2065 7073 5f75 7a3d    double eps_uz=
-0001c550: 5f53 4d41 4c4c 2c20 646f 7562 6c65 2065  _SMALL, double e
-0001c560: 7073 5f61 3d5f 5653 4d41 4c4c 2c0a 2020  ps_a=_VSMALL,.  
-0001c570: 2020 646f 7562 6c65 2065 7073 5f76 7a3d    double eps_vz=
-0001c580: 5f56 534d 414c 4c2c 2064 6f75 626c 6520  _VSMALL, double 
-0001c590: 6570 735f 623d 5f56 534d 414c 4c2c 0a20  eps_b=_VSMALL,. 
-0001c5a0: 2020 2064 6f75 626c 6520 6570 735f 706c     double eps_pl
-0001c5b0: 616e 653d 5f56 534d 414c 4c2c 2073 7472  ane=_VSMALL, str
-0001c5c0: 2076 6573 5f74 7970 653d 2754 6f72 272c   ves_type='Tor',
-0001c5d0: 0a20 2020 2062 696e 7420 666f 7262 6964  .    bint forbid
-0001c5e0: 3d54 7275 652c 0a20 2020 2062 696e 7420  =True,.    bint 
-0001c5f0: 7465 7374 3d54 7275 652c 0a20 2020 2069  test=True,.    i
-0001c600: 6e74 206e 756d 5f74 6872 6561 6473 3d31  nt num_threads=1
-0001c610: 362c 0a29 3a0a 2020 2020 2222 220a 2020  6,.):.    """.  
-0001c620: 2020 5265 7475 726e 2061 6e20 6172 7261    Return an arra
-0001c630: 7920 6f66 2062 6f6f 6c65 616e 7320 696e  y of booleans in
-0001c640: 6469 6361 7469 6e67 2077 6865 7468 6572  dicating whether
-0001c650: 2065 6163 6820 706f 696e 7420 696e 2070   each point in p
-0001c660: 7473 2069 730a 2020 2020 7669 7369 626c  ts is.    visibl
-0001c670: 6520 6672 6f6d 2074 6865 2070 6f69 6e74  e from the point
-0001c680: 2050 203d 205b 7074 302c 2070 7431 2c20   P = [pt0, pt1, 
-0001c690: 7074 325d 2063 6f6e 7369 6465 7269 6e67  pt2] considering
-0001c6a0: 2076 6967 6e65 7474 696e 6720 6120 6769   vignetting a gi
-0001c6b0: 7665 6e0a 2020 2020 636f 6e66 6967 7572  ven.    configur
-0001c6c0: 6174 696f 6e2e 0a20 2020 2020 2020 2070  ation..        p
-0001c6d0: 7430 203a 2078 202d 2063 6f6f 7264 696e  t0 : x - coordin
-0001c6e0: 6174 6520 6f66 2074 6865 2076 6965 7769  ate of the viewi
-0001c6f0: 6e67 2070 6f69 6e74 2050 0a20 2020 2020  ng point P.     
-0001c700: 2020 2070 7431 203a 2079 202d 2063 6f6f     pt1 : y - coo
-0001c710: 7264 696e 6174 6520 6f66 2074 6865 2076  rdinate of the v
-0001c720: 6965 7769 6e67 2070 6f69 6e74 2050 0a20  iewing point P. 
-0001c730: 2020 2020 2020 2070 7432 203a 207a 202d         pt2 : z -
-0001c740: 2063 6f6f 7264 696e 6174 6520 6f66 2074   coordinate of t
-0001c750: 6865 2076 6965 7769 6e67 2070 6f69 6e74  he viewing point
-0001c760: 2050 0a20 2020 2020 2020 2070 7473 203a   P.        pts :
-0001c770: 2028 332c 206e 7074 7329 2063 6172 7465   (3, npts) carte
-0001c780: 7369 616e 2063 6f6f 7264 696e 6174 6573  sian coordinates
-0001c790: 206f 6620 706f 696e 7473 2074 6f20 6368   of points to ch
-0001c7a0: 6563 6b20 6966 2076 6965 7761 626c 650a  eck if viewable.
-0001c7b0: 2020 2020 2020 2020 6469 7374 203a 206f          dist : o
-0001c7c0: 7074 696f 6e61 6c20 6172 6775 6d65 6e74  ptional argument
-0001c7d0: 203a 2064 6973 7461 6e63 6520 6265 7477   : distance betw
-0001c7e0: 6565 6e20 706f 696e 7473 2061 6e64 2050  een points and P
-0001c7f0: 0a20 2020 2020 2020 2076 6573 5f2a 203a  .        ves_* :
-0001c800: 2076 6573 7365 6c20 6465 7363 7269 7074   vessel descript
-0001c810: 6f72 7320 2870 6f6c 792c 206e 6f72 6d2c  ors (poly, norm,
-0001c820: 206c 696d 6974 7329 0a20 2020 2020 2020   limits).       
-0001c830: 206c 7374 7275 6374 5f2a 203a 2063 6f6e   lstruct_* : con
-0001c840: 6669 6727 7320 7374 7275 6374 7572 6520  fig's structure 
-0001c850: 6465 7363 7269 7074 6f72 7320 2870 6f6c  descriptors (pol
-0001c860: 792c 206c 696d 6974 732c 206e 6f72 6d73  y, limits, norms
-0001c870: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001c880: 2020 2020 2020 6e75 6d62 6572 206f 6620        number of 
-0001c890: 7374 7275 6374 7572 6573 2c20 2e2e 2e29  structures, ...)
-0001c8a0: 0a20 2020 2020 2020 2065 7073 5f2a 203a  .        eps_* :
-0001c8b0: 2076 616c 7565 7320 6f66 2070 7265 6369   values of preci
-0001c8c0: 7369 6f6e 2069 6e20 6561 6368 2064 6972  sion in each dir
-0001c8d0: 6563 7469 6f6e 0a20 2020 2020 2020 2066  ection.        f
-0001c8e0: 6f72 6269 6420 3a20 626f 6f6c 6561 6e20  orbid : boolean 
-0001c8f0: 6966 2074 7275 6520 666f 7262 6964 7320  if true forbids 
-0001c900: 6368 6563 6b69 6e67 2022 6265 6869 6e64  checking "behind
-0001c910: 2220 7468 6520 746f 6b61 6d61 6b0a 2020  " the tokamak.  
-0001c920: 2020 2020 2020 7465 7374 203a 2062 6f6f        test : boo
-0001c930: 6c65 616e 2063 6865 636b 2069 6620 696e  lean check if in
-0001c940: 7075 7420 6973 2076 616c 6964 206f 7220  put is valid or 
-0001c950: 6e6f 740a 2020 2020 2020 2020 6e75 6d5f  not.        num_
-0001c960: 7468 7265 6164 7320 3a20 6e75 6d62 6572  threads : number
-0001c970: 206f 6620 7468 7265 6164 7320 666f 7220   of threads for 
-0001c980: 7061 7261 6c6c 656c 697a 6174 696f 6e0a  parallelization.
-0001c990: 2020 2020 4f75 7470 7574 3a0a 2020 2020      Output:.    
-0001c9a0: 2020 2020 6973 5f73 6565 6e3a 2028 6e70      is_seen: (np
-0001c9b0: 7473 3129 2061 7272 6179 206f 6620 696e  ts1) array of in
-0001c9c0: 7473 2069 6e64 6963 6174 696e 6720 6966  ts indicating if
-0001c9d0: 2076 6965 7769 6e67 2070 6f69 6e74 2050   viewing point P
-0001c9e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001c9f0: 2020 6361 6e20 7365 6520 7468 6520 6f74    can see the ot
-0001ca00: 6865 7220 706f 696e 7473 2070 7473 2e0a  her points pts..
+0001c190: 2020 2020 2020 2020 206c 7374 7275 6374           lstruct
+0001c1a0: 5f6e 6c69 6d2c 0a20 2020 2020 2020 2020  _nlim,.         
+0001c1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c1c0: 2020 206c 7374 7275 6374 5f70 6f6c 7978     lstruct_polyx
+0001c1d0: 2c20 6c73 7472 7563 745f 706f 6c79 792c  , lstruct_polyy,
+0001c1e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c1f0: 2020 2020 2020 2020 2020 2020 206c 7374               lst
+0001c200: 7275 6374 5f6c 696d 735f 6e70 2c0a 2020  ruct_lims_np,.  
+0001c210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c220: 2020 2020 2020 2020 2020 6c73 7472 7563            lstruc
+0001c230: 745f 6e6f 726d 782c 206c 7374 7275 6374  t_normx, lstruct
+0001c240: 5f6e 6f72 6d79 2c0a 2020 2020 2020 2020  _normy,.        
+0001c250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c260: 2020 2020 6c6e 7665 7274 2c20 6e73 7472      lnvert, nstr
+0001c270: 7563 745f 746f 742c 206e 7374 7275 6374  uct_tot, nstruct
+0001c280: 5f6c 696d 2c0a 2020 2020 2020 2020 2020  _lim,.          
+0001c290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c2a0: 2020 726d 696e 2c20 6570 735f 757a 2c20    rmin, eps_uz, 
+0001c2b0: 6570 735f 612c 2065 7073 5f76 7a2c 2065  eps_a, eps_vz, e
+0001c2c0: 7073 5f62 2c0a 2020 2020 2020 2020 2020  ps_b,.          
+0001c2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c2e0: 2020 6570 735f 706c 616e 652c 2076 6573    eps_plane, ves
+0001c2f0: 5f74 7970 652e 6c6f 7765 7228 293d 3d27  _type.lower()=='
+0001c300: 746f 7227 2c0a 2020 2020 2020 2020 2020  tor',.          
+0001c310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c320: 2020 666f 7262 6964 2c20 6e75 6d5f 7468    forbid, num_th
+0001c330: 7265 6164 7329 0a20 2020 2072 6574 7572  reads).    retur
+0001c340: 6e20 6172 655f 7365 656e 0a0a 0a64 6566  n are_seen...def
+0001c350: 204c 4f53 5f69 7356 6973 5f50 7446 726f   LOS_isVis_PtFro
+0001c360: 6d50 7473 5f56 6573 5374 7275 6374 280a  mPts_VesStruct(.
+0001c370: 2020 2020 646f 7562 6c65 2070 7430 2c20      double pt0, 
+0001c380: 646f 7562 6c65 2070 7431 2c20 646f 7562  double pt1, doub
+0001c390: 6c65 2070 7432 2c0a 2020 2020 6e70 2e6e  le pt2,.    np.n
+0001c3a0: 6461 7272 6179 5b64 6f75 626c 652c 206e  darray[double, n
+0001c3b0: 6469 6d3d 322c 6d6f 6465 3d27 6327 5d20  dim=2,mode='c'] 
+0001c3c0: 7074 732c 0a20 2020 2064 6f75 626c 655b  pts,.    double[
+0001c3d0: 3a3a 315d 2064 6973 743d 4e6f 6e65 2c0a  ::1] dist=None,.
+0001c3e0: 2020 2020 646f 7562 6c65 5b3a 2c20 3a3a      double[:, ::
+0001c3f0: 315d 2076 6573 5f70 6f6c 793d 4e6f 6e65  1] ves_poly=None
+0001c400: 2c0a 2020 2020 646f 7562 6c65 5b3a 2c20  ,.    double[:, 
+0001c410: 3a3a 315d 2076 6573 5f6e 6f72 6d3d 4e6f  ::1] ves_norm=No
+0001c420: 6e65 2c0a 2020 2020 646f 7562 6c65 5b3a  ne,.    double[:
+0001c430: 3a31 5d20 7665 735f 6c69 6d73 3d4e 6f6e  :1] ves_lims=Non
+0001c440: 652c 0a20 2020 206c 6f6e 675b 3a3a 315d  e,.    long[::1]
+0001c450: 206c 7374 7275 6374 5f6e 6c69 6d3d 4e6f   lstruct_nlim=No
+0001c460: 6e65 2c0a 2020 2020 646f 7562 6c65 5b3a  ne,.    double[:
+0001c470: 3a31 5d20 6c73 7472 7563 745f 706f 6c79  :1] lstruct_poly
+0001c480: 783d 4e6f 6e65 2c0a 2020 2020 646f 7562  x=None,.    doub
+0001c490: 6c65 5b3a 3a31 5d20 6c73 7472 7563 745f  le[::1] lstruct_
+0001c4a0: 706f 6c79 793d 4e6f 6e65 2c0a 2020 2020  polyy=None,.    
+0001c4b0: 6c69 7374 206c 7374 7275 6374 5f6c 696d  list lstruct_lim
+0001c4c0: 733d 4e6f 6e65 2c0a 2020 2020 646f 7562  s=None,.    doub
+0001c4d0: 6c65 5b3a 3a31 5d20 6c73 7472 7563 745f  le[::1] lstruct_
+0001c4e0: 6e6f 726d 783d 4e6f 6e65 2c0a 2020 2020  normx=None,.    
+0001c4f0: 646f 7562 6c65 5b3a 3a31 5d20 6c73 7472  double[::1] lstr
+0001c500: 7563 745f 6e6f 726d 793d 4e6f 6e65 2c0a  uct_normy=None,.
+0001c510: 2020 2020 6c6f 6e67 5b3a 3a31 5d20 6c6e      long[::1] ln
+0001c520: 7665 7274 3d4e 6f6e 652c 0a20 2020 2069  vert=None,.    i
+0001c530: 6e74 206e 7374 7275 6374 5f74 6f74 3d30  nt nstruct_tot=0
+0001c540: 2c0a 2020 2020 696e 7420 6e73 7472 7563  ,.    int nstruc
+0001c550: 745f 6c69 6d3d 302c 0a20 2020 2064 6f75  t_lim=0,.    dou
+0001c560: 626c 6520 726d 696e 3d2d 312c 0a20 2020  ble rmin=-1,.   
+0001c570: 2064 6f75 626c 6520 6570 735f 757a 3d5f   double eps_uz=_
+0001c580: 534d 414c 4c2c 2064 6f75 626c 6520 6570  SMALL, double ep
+0001c590: 735f 613d 5f56 534d 414c 4c2c 0a20 2020  s_a=_VSMALL,.   
+0001c5a0: 2064 6f75 626c 6520 6570 735f 767a 3d5f   double eps_vz=_
+0001c5b0: 5653 4d41 4c4c 2c20 646f 7562 6c65 2065  VSMALL, double e
+0001c5c0: 7073 5f62 3d5f 5653 4d41 4c4c 2c0a 2020  ps_b=_VSMALL,.  
+0001c5d0: 2020 646f 7562 6c65 2065 7073 5f70 6c61    double eps_pla
+0001c5e0: 6e65 3d5f 5653 4d41 4c4c 2c20 7374 7220  ne=_VSMALL, str 
+0001c5f0: 7665 735f 7479 7065 3d27 546f 7227 2c0a  ves_type='Tor',.
+0001c600: 2020 2020 6269 6e74 2066 6f72 6269 643d      bint forbid=
+0001c610: 5472 7565 2c0a 2020 2020 6269 6e74 2074  True,.    bint t
+0001c620: 6573 743d 5472 7565 2c0a 2020 2020 696e  est=True,.    in
+0001c630: 7420 6e75 6d5f 7468 7265 6164 733d 3136  t num_threads=16
+0001c640: 2c0a 293a 0a20 2020 2022 2222 0a20 2020  ,.):.    """.   
+0001c650: 2052 6574 7572 6e20 616e 2061 7272 6179   Return an array
+0001c660: 206f 6620 626f 6f6c 6561 6e73 2069 6e64   of booleans ind
+0001c670: 6963 6174 696e 6720 7768 6574 6865 7220  icating whether 
+0001c680: 6561 6368 2070 6f69 6e74 2069 6e20 7074  each point in pt
+0001c690: 7320 6973 0a20 2020 2076 6973 6962 6c65  s is.    visible
+0001c6a0: 2066 726f 6d20 7468 6520 706f 696e 7420   from the point 
+0001c6b0: 5020 3d20 5b70 7430 2c20 7074 312c 2070  P = [pt0, pt1, p
+0001c6c0: 7432 5d20 636f 6e73 6964 6572 696e 6720  t2] considering 
+0001c6d0: 7669 676e 6574 7469 6e67 2061 2067 6976  vignetting a giv
+0001c6e0: 656e 0a20 2020 2063 6f6e 6669 6775 7261  en.    configura
+0001c6f0: 7469 6f6e 2e0a 2020 2020 2020 2020 7074  tion..        pt
+0001c700: 3020 3a20 7820 2d20 636f 6f72 6469 6e61  0 : x - coordina
+0001c710: 7465 206f 6620 7468 6520 7669 6577 696e  te of the viewin
+0001c720: 6720 706f 696e 7420 500a 2020 2020 2020  g point P.      
+0001c730: 2020 7074 3120 3a20 7920 2d20 636f 6f72    pt1 : y - coor
+0001c740: 6469 6e61 7465 206f 6620 7468 6520 7669  dinate of the vi
+0001c750: 6577 696e 6720 706f 696e 7420 500a 2020  ewing point P.  
+0001c760: 2020 2020 2020 7074 3220 3a20 7a20 2d20        pt2 : z - 
+0001c770: 636f 6f72 6469 6e61 7465 206f 6620 7468  coordinate of th
+0001c780: 6520 7669 6577 696e 6720 706f 696e 7420  e viewing point 
+0001c790: 500a 2020 2020 2020 2020 7074 7320 3a20  P.        pts : 
+0001c7a0: 2833 2c20 6e70 7473 2920 6361 7274 6573  (3, npts) cartes
+0001c7b0: 6961 6e20 636f 6f72 6469 6e61 7465 7320  ian coordinates 
+0001c7c0: 6f66 2070 6f69 6e74 7320 746f 2063 6865  of points to che
+0001c7d0: 636b 2069 6620 7669 6577 6162 6c65 0a20  ck if viewable. 
+0001c7e0: 2020 2020 2020 2064 6973 7420 3a20 6f70         dist : op
+0001c7f0: 7469 6f6e 616c 2061 7267 756d 656e 7420  tional argument 
+0001c800: 3a20 6469 7374 616e 6365 2062 6574 7765  : distance betwe
+0001c810: 656e 2070 6f69 6e74 7320 616e 6420 500a  en points and P.
+0001c820: 2020 2020 2020 2020 7665 735f 2a20 3a20          ves_* : 
+0001c830: 7665 7373 656c 2064 6573 6372 6970 746f  vessel descripto
+0001c840: 7273 2028 706f 6c79 2c20 6e6f 726d 2c20  rs (poly, norm, 
+0001c850: 6c69 6d69 7473 290a 2020 2020 2020 2020  limits).        
+0001c860: 6c73 7472 7563 745f 2a20 3a20 636f 6e66  lstruct_* : conf
+0001c870: 6967 2773 2073 7472 7563 7475 7265 2064  ig's structure d
+0001c880: 6573 6372 6970 746f 7273 2028 706f 6c79  escriptors (poly
+0001c890: 2c20 6c69 6d69 7473 2c20 6e6f 726d 732c  , limits, norms,
+0001c8a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c8b0: 2020 2020 206e 756d 6265 7220 6f66 2073       number of s
+0001c8c0: 7472 7563 7475 7265 732c 202e 2e2e 290a  tructures, ...).
+0001c8d0: 2020 2020 2020 2020 6570 735f 2a20 3a20          eps_* : 
+0001c8e0: 7661 6c75 6573 206f 6620 7072 6563 6973  values of precis
+0001c8f0: 696f 6e20 696e 2065 6163 6820 6469 7265  ion in each dire
+0001c900: 6374 696f 6e0a 2020 2020 2020 2020 666f  ction.        fo
+0001c910: 7262 6964 203a 2062 6f6f 6c65 616e 2069  rbid : boolean i
+0001c920: 6620 7472 7565 2066 6f72 6269 6473 2063  f true forbids c
+0001c930: 6865 636b 696e 6720 2262 6568 696e 6422  hecking "behind"
+0001c940: 2074 6865 2074 6f6b 616d 616b 0a20 2020   the tokamak.   
+0001c950: 2020 2020 2074 6573 7420 3a20 626f 6f6c       test : bool
+0001c960: 6561 6e20 6368 6563 6b20 6966 2069 6e70  ean check if inp
+0001c970: 7574 2069 7320 7661 6c69 6420 6f72 206e  ut is valid or n
+0001c980: 6f74 0a20 2020 2020 2020 206e 756d 5f74  ot.        num_t
+0001c990: 6872 6561 6473 203a 206e 756d 6265 7220  hreads : number 
+0001c9a0: 6f66 2074 6872 6561 6473 2066 6f72 2070  of threads for p
+0001c9b0: 6172 616c 6c65 6c69 7a61 7469 6f6e 0a20  arallelization. 
+0001c9c0: 2020 204f 7574 7075 743a 0a20 2020 2020     Output:.     
+0001c9d0: 2020 2069 735f 7365 656e 3a20 286e 7074     is_seen: (npt
+0001c9e0: 7331 2920 6172 7261 7920 6f66 2069 6e74  s1) array of int
+0001c9f0: 7320 696e 6469 6361 7469 6e67 2069 6620  s indicating if 
+0001ca00: 7669 6577 696e 6720 706f 696e 7420 500a  viewing point P.
 0001ca10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ca20: 2069 735f 7365 656e 5b69 5d20 3d20 3120   is_seen[i] = 1 
-0001ca30: 6966 2050 2073 6565 7320 706f 696e 7420  if P sees point 
-0001ca40: 7074 735b 695d 0a20 2020 2020 2020 2020  pts[i].         
-0001ca50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ca60: 2020 2020 2030 2065 6c73 650a 2020 2020       0 else.    
-0001ca70: 2222 220a 2020 2020 6364 6566 2073 7472  """.    cdef str
-0001ca80: 206d 7367 0a20 2020 2063 6465 6620 696e   msg.    cdef in
-0001ca90: 7420 6e70 7473 203d 2070 7473 2e73 6861  t npts = pts.sha
-0001caa0: 7065 5b31 5d0a 2020 2020 6364 6566 2062  pe[1].    cdef b
-0001cab0: 696e 7420 626f 6f6c 312c 2062 6f6f 6c32  int bool1, bool2
-0001cac0: 0a20 2020 2063 6465 6620 646f 7562 6c65  .    cdef double
-0001cad0: 5b3a 3a31 5d20 6c73 7472 7563 745f 6c69  [::1] lstruct_li
-0001cae0: 6d73 5f6e 700a 2020 2020 6364 6566 206e  ms_np.    cdef n
-0001caf0: 702e 6e64 6172 7261 795b 6c6f 6e67 2c20  p.ndarray[long, 
-0001cb00: 6e64 696d 3d31 2c20 6d6f 6465 3d27 6327  ndim=1, mode='c'
-0001cb10: 5d20 6973 5f73 6565 6e0a 2020 2020 2320  ] is_seen.    # 
-0001cb20: 3d3d 2054 6573 7469 6e67 2069 6e70 7574  == Testing input
-0001cb30: 7320 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  s ==============
-0001cb40: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001cb50: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001cb60: 3d3d 3d3d 3d3d 3d3d 3d3d 0a20 2020 2069  ==========.    i
-0001cb70: 6620 7465 7374 3a0a 2020 2020 2020 2020  f test:.        
-0001cb80: 6d73 6720 3d20 2276 6573 5f70 6f6c 7920  msg = "ves_poly 
-0001cb90: 616e 6420 7665 735f 6e6f 726d 2061 7265  and ves_norm are
-0001cba0: 206e 6f74 206f 7074 696f 6e61 6c20 6172   not optional ar
-0001cbb0: 6775 6d65 6e74 7322 0a20 2020 2020 2020  guments".       
-0001cbc0: 2061 7373 6572 7420 7665 735f 706f 6c79   assert ves_poly
-0001cbd0: 2069 7320 6e6f 7420 4e6f 6e65 2061 6e64   is not None and
-0001cbe0: 2076 6573 5f6e 6f72 6d20 6973 206e 6f74   ves_norm is not
-0001cbf0: 204e 6f6e 652c 206d 7367 0a20 2020 2020   None, msg.     
-0001cc00: 2020 2062 6f6f 6c31 203d 2028 7665 735f     bool1 = (ves_
-0001cc10: 706f 6c79 2e73 6861 7065 5b30 5d3d 3d32  poly.shape[0]==2
-0001cc20: 2061 6e64 2076 6573 5f6e 6f72 6d2e 7368   and ves_norm.sh
-0001cc30: 6170 655b 305d 3d3d 320a 2020 2020 2020  ape[0]==2.      
-0001cc40: 2020 2020 2020 2020 616e 6420 7665 735f          and ves_
-0001cc50: 6e6f 726d 2e73 6861 7065 5b31 5d3d 3d76  norm.shape[1]==v
-0001cc60: 6573 5f70 6f6c 792e 7368 6170 655b 315d  es_poly.shape[1]
-0001cc70: 2d31 290a 2020 2020 2020 2020 6d73 6720  -1).        msg 
-0001cc80: 3d20 2241 7267 7320 7665 735f 706f 6c79  = "Args ves_poly
-0001cc90: 2061 6e64 2076 6573 5f6e 6f72 6d20 6d75   and ves_norm mu
-0001cca0: 7374 2062 6520 6f66 2074 6865 2073 616d  st be of the sam
-0001ccb0: 6520 7368 6170 6520 2832 2c4e 5329 2122  e shape (2,NS)!"
-0001ccc0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0001ccd0: 626f 6f6c 312c 206d 7367 0a20 2020 2020  bool1, msg.     
-0001cce0: 2020 2062 6f6f 6c31 203d 206c 7374 7275     bool1 = lstru
-0001ccf0: 6374 5f6c 696d 7320 6973 204e 6f6e 6520  ct_lims is None 
-0001cd00: 6f72 206c 656e 286c 7374 7275 6374 5f6e  or len(lstruct_n
-0001cd10: 6f72 6d79 2920 3d3d 206c 656e 286c 7374  ormy) == len(lst
-0001cd20: 7275 6374 5f6e 6f72 6d78 290a 2020 2020  ruct_normx).    
-0001cd30: 2020 2020 626f 6f6c 3220 3d20 6c73 7472      bool2 = lstr
-0001cd40: 7563 745f 6e6f 726d 7820 6973 204e 6f6e  uct_normx is Non
-0001cd50: 6520 6f72 206c 656e 286c 7374 7275 6374  e or len(lstruct
-0001cd60: 5f70 6f6c 7978 2920 3d3d 206c 656e 286c  _polyx) == len(l
-0001cd70: 7374 7275 6374 5f70 6f6c 7979 290a 2020  struct_polyy).  
-0001cd80: 2020 2020 2020 6d73 6720 3d20 2241 7267        msg = "Arg
-0001cd90: 7320 6c73 7472 7563 745f 706f 6c79 782c  s lstruct_polyx,
-0001cda0: 206c 7374 7275 6374 5f70 6f6c 7979 2c20   lstruct_polyy, 
-0001cdb0: 6c73 7472 7563 745f 6c69 6d73 2c20 6c73  lstruct_lims, ls
-0001cdc0: 7472 7563 745f 6e6f 726d 782c 225c 0a20  truct_normx,"\. 
-0001cdd0: 2020 2020 2020 2020 2020 2020 202b 2022               + "
-0001cde0: 206c 7374 7275 6374 5f6e 6f72 6d79 2c20   lstruct_normy, 
-0001cdf0: 6d75 7374 2062 6520 4e6f 6e65 206f 7220  must be None or 
-0001ce00: 6c69 7374 7320 6f66 2073 616d 6520 6c65  lists of same le
-0001ce10: 6e28 2921 220a 2020 2020 2020 2020 6173  n()!".        as
-0001ce20: 7365 7274 2062 6f6f 6c31 2061 6e64 2062  sert bool1 and b
-0001ce30: 6f6f 6c32 2c20 6d73 670a 2020 2020 2020  ool2, msg.      
-0001ce40: 2020 6d73 6720 3d20 225b 6570 735f 757a    msg = "[eps_uz
-0001ce50: 2c65 7073 5f76 7a2c 6570 735f 612c 6570  ,eps_vz,eps_a,ep
-0001ce60: 735f 625d 206d 7573 7420 6265 2066 6c6f  s_b] must be flo
-0001ce70: 6174 7320 3c20 312e 652d 3421 220a 2020  ats < 1.e-4!".  
-0001ce80: 2020 2020 2020 6173 7365 7274 2061 6c6c        assert all
-0001ce90: 285b 6565 203c 2031 2e65 2d34 2066 6f72  ([ee < 1.e-4 for
-0001cea0: 2065 6520 696e 205b 6570 735f 757a 2c20   ee in [eps_uz, 
-0001ceb0: 6570 735f 612c 0a20 2020 2020 2020 2020  eps_a,.         
-0001cec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ced0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cee0: 2065 7073 5f76 7a2c 2065 7073 5f62 2c0a   eps_vz, eps_b,.
+0001ca20: 2063 616e 2073 6565 2074 6865 206f 7468   can see the oth
+0001ca30: 6572 2070 6f69 6e74 7320 7074 732e 0a20  er points pts.. 
+0001ca40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ca50: 6973 5f73 6565 6e5b 695d 203d 2031 2069  is_seen[i] = 1 i
+0001ca60: 6620 5020 7365 6573 2070 6f69 6e74 2070  f P sees point p
+0001ca70: 7473 5b69 5d0a 2020 2020 2020 2020 2020  ts[i].          
+0001ca80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ca90: 2020 2020 3020 656c 7365 0a20 2020 2022      0 else.    "
+0001caa0: 2222 0a20 2020 2063 6465 6620 7374 7220  "".    cdef str 
+0001cab0: 6d73 670a 2020 2020 6364 6566 2069 6e74  msg.    cdef int
+0001cac0: 206e 7074 7320 3d20 7074 732e 7368 6170   npts = pts.shap
+0001cad0: 655b 315d 0a20 2020 2063 6465 6620 6269  e[1].    cdef bi
+0001cae0: 6e74 2062 6f6f 6c31 2c20 626f 6f6c 320a  nt bool1, bool2.
+0001caf0: 2020 2020 6364 6566 2064 6f75 626c 655b      cdef double[
+0001cb00: 3a3a 315d 206c 7374 7275 6374 5f6c 696d  ::1] lstruct_lim
+0001cb10: 735f 6e70 0a20 2020 2063 6465 6620 6e70  s_np.    cdef np
+0001cb20: 2e6e 6461 7272 6179 5b6c 6f6e 672c 206e  .ndarray[long, n
+0001cb30: 6469 6d3d 312c 206d 6f64 653d 2763 275d  dim=1, mode='c']
+0001cb40: 2069 735f 7365 656e 0a20 2020 2023 203d   is_seen.    # =
+0001cb50: 3d20 5465 7374 696e 6720 696e 7075 7473  = Testing inputs
+0001cb60: 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d   ===============
+0001cb70: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001cb80: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001cb90: 3d3d 3d3d 3d3d 3d3d 3d0a 2020 2020 6966  =========.    if
+0001cba0: 2074 6573 743a 0a20 2020 2020 2020 206d   test:.        m
+0001cbb0: 7367 203d 2022 7665 735f 706f 6c79 2061  sg = "ves_poly a
+0001cbc0: 6e64 2076 6573 5f6e 6f72 6d20 6172 6520  nd ves_norm are 
+0001cbd0: 6e6f 7420 6f70 7469 6f6e 616c 2061 7267  not optional arg
+0001cbe0: 756d 656e 7473 220a 2020 2020 2020 2020  uments".        
+0001cbf0: 6173 7365 7274 2076 6573 5f70 6f6c 7920  assert ves_poly 
+0001cc00: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
+0001cc10: 7665 735f 6e6f 726d 2069 7320 6e6f 7420  ves_norm is not 
+0001cc20: 4e6f 6e65 2c20 6d73 670a 2020 2020 2020  None, msg.      
+0001cc30: 2020 626f 6f6c 3120 3d20 2876 6573 5f70    bool1 = (ves_p
+0001cc40: 6f6c 792e 7368 6170 655b 305d 3d3d 3220  oly.shape[0]==2 
+0001cc50: 616e 6420 7665 735f 6e6f 726d 2e73 6861  and ves_norm.sha
+0001cc60: 7065 5b30 5d3d 3d32 0a20 2020 2020 2020  pe[0]==2.       
+0001cc70: 2020 2020 2020 2061 6e64 2076 6573 5f6e         and ves_n
+0001cc80: 6f72 6d2e 7368 6170 655b 315d 3d3d 7665  orm.shape[1]==ve
+0001cc90: 735f 706f 6c79 2e73 6861 7065 5b31 5d2d  s_poly.shape[1]-
+0001cca0: 3129 0a20 2020 2020 2020 206d 7367 203d  1).        msg =
+0001ccb0: 2022 4172 6773 2076 6573 5f70 6f6c 7920   "Args ves_poly 
+0001ccc0: 616e 6420 7665 735f 6e6f 726d 206d 7573  and ves_norm mus
+0001ccd0: 7420 6265 206f 6620 7468 6520 7361 6d65  t be of the same
+0001cce0: 2073 6861 7065 2028 322c 4e53 2921 220a   shape (2,NS)!".
+0001ccf0: 2020 2020 2020 2020 6173 7365 7274 2062          assert b
+0001cd00: 6f6f 6c31 2c20 6d73 670a 2020 2020 2020  ool1, msg.      
+0001cd10: 2020 626f 6f6c 3120 3d20 6c73 7472 7563    bool1 = lstruc
+0001cd20: 745f 6c69 6d73 2069 7320 4e6f 6e65 206f  t_lims is None o
+0001cd30: 7220 6c65 6e28 6c73 7472 7563 745f 6e6f  r len(lstruct_no
+0001cd40: 726d 7929 203d 3d20 6c65 6e28 6c73 7472  rmy) == len(lstr
+0001cd50: 7563 745f 6e6f 726d 7829 0a20 2020 2020  uct_normx).     
+0001cd60: 2020 2062 6f6f 6c32 203d 206c 7374 7275     bool2 = lstru
+0001cd70: 6374 5f6e 6f72 6d78 2069 7320 4e6f 6e65  ct_normx is None
+0001cd80: 206f 7220 6c65 6e28 6c73 7472 7563 745f   or len(lstruct_
+0001cd90: 706f 6c79 7829 203d 3d20 6c65 6e28 6c73  polyx) == len(ls
+0001cda0: 7472 7563 745f 706f 6c79 7929 0a20 2020  truct_polyy).   
+0001cdb0: 2020 2020 206d 7367 203d 2022 4172 6773       msg = "Args
+0001cdc0: 206c 7374 7275 6374 5f70 6f6c 7978 2c20   lstruct_polyx, 
+0001cdd0: 6c73 7472 7563 745f 706f 6c79 792c 206c  lstruct_polyy, l
+0001cde0: 7374 7275 6374 5f6c 696d 732c 206c 7374  struct_lims, lst
+0001cdf0: 7275 6374 5f6e 6f72 6d78 2c22 5c0a 2020  ruct_normx,"\.  
+0001ce00: 2020 2020 2020 2020 2020 2020 2b20 2220              + " 
+0001ce10: 6c73 7472 7563 745f 6e6f 726d 792c 206d  lstruct_normy, m
+0001ce20: 7573 7420 6265 204e 6f6e 6520 6f72 206c  ust be None or l
+0001ce30: 6973 7473 206f 6620 7361 6d65 206c 656e  ists of same len
+0001ce40: 2829 2122 0a20 2020 2020 2020 2061 7373  ()!".        ass
+0001ce50: 6572 7420 626f 6f6c 3120 616e 6420 626f  ert bool1 and bo
+0001ce60: 6f6c 322c 206d 7367 0a20 2020 2020 2020  ol2, msg.       
+0001ce70: 206d 7367 203d 2022 5b65 7073 5f75 7a2c   msg = "[eps_uz,
+0001ce80: 6570 735f 767a 2c65 7073 5f61 2c65 7073  eps_vz,eps_a,eps
+0001ce90: 5f62 5d20 6d75 7374 2062 6520 666c 6f61  _b] must be floa
+0001cea0: 7473 203c 2031 2e65 2d34 2122 0a20 2020  ts < 1.e-4!".   
+0001ceb0: 2020 2020 2061 7373 6572 7420 616c 6c28       assert all(
+0001cec0: 5b65 6520 3c20 312e 652d 3420 666f 7220  [ee < 1.e-4 for 
+0001ced0: 6565 2069 6e20 5b65 7073 5f75 7a2c 2065  ee in [eps_uz, e
+0001cee0: 7073 5f61 2c0a 2020 2020 2020 2020 2020  ps_a,.          
 0001cef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001cf00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cf10: 2020 2020 2020 2020 2020 6570 735f 706c            eps_pl
-0001cf20: 616e 655d 5d29 2c20 6d73 670a 2020 2020  ane]]), msg.    
-0001cf30: 2020 2020 6d73 6720 3d20 2276 6573 5f74      msg = "ves_t
-0001cf40: 7970 6520 6d75 7374 2062 6520 6120 7374  ype must be a st
-0001cf50: 7220 696e 205b 2754 6f72 272c 274c 696e  r in ['Tor','Lin
-0001cf60: 275d 2122 0a20 2020 2020 2020 2061 7373  ']!".        ass
-0001cf70: 6572 7420 7665 735f 7479 7065 2e6c 6f77  ert ves_type.low
-0001cf80: 6572 2829 2069 6e20 5b27 746f 7227 2c20  er() in ['tor', 
-0001cf90: 276c 696e 275d 2c20 6d73 670a 2020 2020  'lin'], msg.    
-0001cfa0: 2320 2e2e 2e0a 2020 2020 6c73 7472 7563  # ....    lstruc
-0001cfb0: 745f 6c69 6d73 5f6e 7020 3d20 666c 6174  t_lims_np = flat
-0001cfc0: 7465 6e5f 6c73 7472 7563 745f 6c69 6d73  ten_lstruct_lims
-0001cfd0: 286c 7374 7275 6374 5f6c 696d 7329 0a20  (lstruct_lims). 
-0001cfe0: 2020 2069 735f 7365 656e 203d 206e 702e     is_seen = np.
-0001cff0: 656d 7074 7928 286e 7074 7329 2c20 6474  empty((npts), dt
-0001d000: 7970 653d 696e 7429 0a20 2020 205f 7274  ype=int).    _rt
-0001d010: 2e69 735f 7669 7369 626c 655f 7074 5f76  .is_visible_pt_v
-0001d020: 6563 2870 7430 2c20 7074 312c 2070 7432  ec(pt0, pt1, pt2
-0001d030: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001d040: 2020 2020 2020 2020 2020 2020 7074 732c              pts,
-0001d050: 206e 7074 732c 0a20 2020 2020 2020 2020   npts,.         
-0001d060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d070: 2076 6573 5f70 6f6c 792c 2076 6573 5f6e   ves_poly, ves_n
-0001d080: 6f72 6d2c 0a20 2020 2020 2020 2020 2020  orm,.           
-0001d090: 2020 2020 2020 2020 2020 2020 2020 2026                 &
-0001d0a0: 6973 5f73 6565 6e5b 305d 2c20 6469 7374  is_seen[0], dist
-0001d0b0: 2c20 7665 735f 6c69 6d73 2c0a 2020 2020  , ves_lims,.    
-0001d0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d0d0: 2020 2020 2020 6c73 7472 7563 745f 6e6c        lstruct_nl
-0001d0e0: 696d 2c0a 2020 2020 2020 2020 2020 2020  im,.            
-0001d0f0: 2020 2020 2020 2020 2020 2020 2020 6c73                ls
-0001d100: 7472 7563 745f 706f 6c79 782c 206c 7374  truct_polyx, lst
-0001d110: 7275 6374 5f70 6f6c 7979 2c0a 2020 2020  ruct_polyy,.    
-0001d120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d130: 2020 2020 2020 6c73 7472 7563 745f 6c69        lstruct_li
-0001d140: 6d73 5f6e 702c 0a20 2020 2020 2020 2020  ms_np,.         
+0001cf10: 6570 735f 767a 2c20 6570 735f 622c 0a20  eps_vz, eps_b,. 
+0001cf20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cf30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cf40: 2020 2020 2020 2020 2065 7073 5f70 6c61           eps_pla
+0001cf50: 6e65 5d5d 292c 206d 7367 0a20 2020 2020  ne]]), msg.     
+0001cf60: 2020 206d 7367 203d 2022 7665 735f 7479     msg = "ves_ty
+0001cf70: 7065 206d 7573 7420 6265 2061 2073 7472  pe must be a str
+0001cf80: 2069 6e20 5b27 546f 7227 2c27 4c69 6e27   in ['Tor','Lin'
+0001cf90: 5d21 220a 2020 2020 2020 2020 6173 7365  ]!".        asse
+0001cfa0: 7274 2076 6573 5f74 7970 652e 6c6f 7765  rt ves_type.lowe
+0001cfb0: 7228 2920 696e 205b 2774 6f72 272c 2027  r() in ['tor', '
+0001cfc0: 6c69 6e27 5d2c 206d 7367 0a20 2020 2023  lin'], msg.    #
+0001cfd0: 202e 2e2e 0a20 2020 206c 7374 7275 6374   ....    lstruct
+0001cfe0: 5f6c 696d 735f 6e70 203d 2066 6c61 7474  _lims_np = flatt
+0001cff0: 656e 5f6c 7374 7275 6374 5f6c 696d 7328  en_lstruct_lims(
+0001d000: 6c73 7472 7563 745f 6c69 6d73 290a 2020  lstruct_lims).  
+0001d010: 2020 6973 5f73 6565 6e20 3d20 6e70 2e65    is_seen = np.e
+0001d020: 6d70 7479 2828 6e70 7473 292c 2064 7479  mpty((npts), dty
+0001d030: 7065 3d69 6e74 290a 2020 2020 5f72 742e  pe=int).    _rt.
+0001d040: 6973 5f76 6973 6962 6c65 5f70 745f 7665  is_visible_pt_ve
+0001d050: 6328 7074 302c 2070 7431 2c20 7074 322c  c(pt0, pt1, pt2,
+0001d060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d070: 2020 2020 2020 2020 2020 2070 7473 2c20             pts, 
+0001d080: 6e70 7473 2c0a 2020 2020 2020 2020 2020  npts,.          
+0001d090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d0a0: 7665 735f 706f 6c79 2c20 7665 735f 6e6f  ves_poly, ves_no
+0001d0b0: 726d 2c0a 2020 2020 2020 2020 2020 2020  rm,.            
+0001d0c0: 2020 2020 2020 2020 2020 2020 2020 2669                &i
+0001d0d0: 735f 7365 656e 5b30 5d2c 2064 6973 742c  s_seen[0], dist,
+0001d0e0: 2076 6573 5f6c 696d 732c 0a20 2020 2020   ves_lims,.     
+0001d0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d100: 2020 2020 206c 7374 7275 6374 5f6e 6c69       lstruct_nli
+0001d110: 6d2c 0a20 2020 2020 2020 2020 2020 2020  m,.             
+0001d120: 2020 2020 2020 2020 2020 2020 206c 7374               lst
+0001d130: 7275 6374 5f70 6f6c 7978 2c20 6c73 7472  ruct_polyx, lstr
+0001d140: 7563 745f 706f 6c79 792c 0a20 2020 2020  uct_polyy,.     
 0001d150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d160: 206c 7374 7275 6374 5f6e 6f72 6d78 2c20   lstruct_normx, 
-0001d170: 6c73 7472 7563 745f 6e6f 726d 792c 0a20  lstruct_normy,. 
+0001d160: 2020 2020 206c 7374 7275 6374 5f6c 696d       lstruct_lim
+0001d170: 735f 6e70 2c0a 2020 2020 2020 2020 2020  s_np,.          
 0001d180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d190: 2020 2020 2020 2020 206c 6e76 6572 742c           lnvert,
-0001d1a0: 206e 7374 7275 6374 5f74 6f74 2c20 6e73   nstruct_tot, ns
-0001d1b0: 7472 7563 745f 6c69 6d2c 0a20 2020 2020  truct_lim,.     
-0001d1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d1d0: 2020 2020 2072 6d69 6e2c 2065 7073 5f75       rmin, eps_u
-0001d1e0: 7a2c 2065 7073 5f61 2c20 6570 735f 767a  z, eps_a, eps_vz
-0001d1f0: 2c20 6570 735f 622c 0a20 2020 2020 2020  , eps_b,.       
-0001d200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d210: 2020 2065 7073 5f70 6c61 6e65 2c20 7665     eps_plane, ve
-0001d220: 735f 7479 7065 2e6c 6f77 6572 2829 3d3d  s_type.lower()==
-0001d230: 2774 6f72 272c 0a20 2020 2020 2020 2020  'tor',.         
-0001d240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d250: 2066 6f72 6269 642c 206e 756d 5f74 6872   forbid, num_thr
-0001d260: 6561 6473 290a 2020 2020 7265 7475 726e  eads).    return
-0001d270: 2069 735f 7365 656e 0a0a 0a23 203d 3d3d   is_seen...# ===
-0001d280: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001d290: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001d2a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001d2b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 230a 2320  ===========.#.# 
-0001d2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d2e0: 5649 474e 4554 5449 4e47 0a23 0a23 203d  VIGNETTING.#.# =
-0001d2f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001d300: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001d310: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001d320: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 0a0a  ==============..
-0001d330: 0a64 6566 2074 7269 616e 6775 6c61 7465  .def triangulate
-0001d340: 5f62 795f 6561 7263 6c69 7070 696e 675f  _by_earclipping_
-0001d350: 3264 280a 2020 2020 6e70 2e6e 6461 7272  2d(.    np.ndarr
-0001d360: 6179 5b64 6f75 626c 652c 206e 6469 6d3d  ay[double, ndim=
-0001d370: 325d 2070 6f6c 792c 0a29 3a0a 2020 2020  2] poly,.):.    
-0001d380: 2222 220a 2020 2020 5472 6961 6e67 756c  """.    Triangul
-0001d390: 6174 6573 2061 2073 696e 676c 6520 3364  ates a single 3d
-0001d3a0: 2070 6f6c 7967 6f6e 2062 7920 7468 6520   polygon by the 
-0001d3b0: 6561 7263 6c69 7070 696e 6720 6d65 7468  earclipping meth
-0001d3c0: 6f64 2e0a 2020 2020 436f 6e76 6572 7473  od..    Converts
-0001d3d0: 2033 6420 706f 6c79 676f 6e20 696e 746f   3d polygon into
-0001d3e0: 2032 6420 636f 756e 7465 722d 636c 6f63   2d counter-cloc
-0001d3f0: 6b77 6973 6520 7072 6f6a 6563 7469 6f6e  kwise projection
-0001d400: 0a0a 2020 2020 5061 7261 6d73 0a20 2020  ..    Params.   
-0001d410: 203d 3d3d 3d3d 0a20 2020 2070 6f6c 7920   =====.    poly 
-0001d420: 3a20 2833 2c20 6e76 6572 7429 2064 6f75  : (3, nvert) dou
-0001d430: 626c 6520 6172 7261 790a 2020 2020 2020  ble array.      
-0001d440: 2020 436f 6e74 6169 6e73 2033 4420 636f    Contains 3D co
-0001d450: 6f72 6469 6e61 7465 7320 6f66 206f 7065  ordinates of ope
-0001d460: 6e20 706f 6c79 676f 6e20 696e 2063 6f75  n polygon in cou
-0001d470: 6e74 6572 2063 6c6f 636b 7769 7365 206f  nter clockwise o
-0001d480: 7264 6572 0a20 2020 2052 6574 7572 6e73  rder.    Returns
-0001d490: 0a20 2020 203d 3d3d 3d3d 3d3d 0a20 2020  .    =======.   
-0001d4a0: 206c 7472 6920 3a20 2833 2a28 6e76 6572   ltri : (3*(nver
-0001d4b0: 742d 3229 2920 696e 7420 6172 7261 790a  t-2)) int array.
-0001d4c0: 2020 2020 2020 2020 496e 6469 6365 7320          Indices 
-0001d4d0: 6f66 2074 7269 616e 676c 6573 0a20 2020  of triangles.   
-0001d4e0: 2022 2222 0a20 2020 2063 6465 6620 696e   """.    cdef in
-0001d4f0: 7420 6e76 6572 7420 3d20 706f 6c79 2e73  t nvert = poly.s
-0001d500: 6861 7065 5b31 5d0a 2020 2020 6364 6566  hape[1].    cdef
-0001d510: 206e 702e 6e64 6172 7261 795b 6c6f 6e67   np.ndarray[long
-0001d520: 2c20 6e64 696d 3d31 5d20 6c74 7269 203d  , ndim=1] ltri =
-0001d530: 206e 702e 656d 7074 7928 286e 7665 7274   np.empty((nvert
-0001d540: 2d32 292a 332c 2064 7479 7065 3d69 6e74  -2)*3, dtype=int
-0001d550: 290a 2020 2020 6364 6566 2064 6f75 626c  ).    cdef doubl
-0001d560: 652a 2064 6966 6620 3d20 4e55 4c4c 0a20  e* diff = NULL. 
-0001d570: 2020 2063 6465 6620 6269 6e74 2a20 6c72     cdef bint* lr
-0001d580: 6566 203d 204e 554c 4c0a 0a20 2020 2023  ef = NULL..    #
-0001d590: 2049 6e69 7469 616c 697a 6174 696f 6e20   Initialization 
-0001d5a0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-0001d5b0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-0001d5c0: 2e2e 2e2e 2e2e 2e2e 2e2e 0a20 2020 2064  ...........    d
-0001d5d0: 6966 6620 3d20 3c64 6f75 626c 652a 3e6d  iff = <double*>m
-0001d5e0: 616c 6c6f 6328 322a 6e76 6572 742a 7369  alloc(2*nvert*si
-0001d5f0: 7a65 6f66 2864 6f75 626c 6529 290a 2020  zeof(double)).  
-0001d600: 2020 6c72 6566 203d 203c 6269 6e74 2a3e    lref = <bint*>
-0001d610: 6d61 6c6c 6f63 286e 7665 7274 2a73 697a  malloc(nvert*siz
-0001d620: 656f 6628 6269 6e74 2929 0a0a 2020 2020  eof(bint))..    
-0001d630: 5f76 742e 636f 6d70 7574 655f 6469 6666  _vt.compute_diff
-0001d640: 3264 2826 706f 6c79 5b30 2c20 305d 2c20  2d(&poly[0, 0], 
-0001d650: 6e76 6572 742c 2026 6469 6666 5b30 5d29  nvert, &diff[0])
-0001d660: 0a20 2020 205f 7674 2e61 7265 5f70 6f69  .    _vt.are_poi
-0001d670: 6e74 735f 7265 666c 6578 5f32 6428 6e76  nts_reflex_2d(nv
-0001d680: 6572 742c 2026 6469 6666 5b30 5d2c 2026  ert, &diff[0], &
-0001d690: 6c72 6566 5b30 5d29 0a0a 2020 2020 2320  lref[0])..    # 
-0001d6a0: 4361 6c6c 696e 6720 636f 7265 2066 756e  Calling core fun
-0001d6b0: 6374 696f 6e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ction...........
-0001d6c0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-0001d6d0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e0a 2020 2020  ............    
-0001d6e0: 5f76 742e 6561 7263 6c69 7070 696e 675f  _vt.earclipping_
-0001d6f0: 706f 6c79 5f32 6428 2670 6f6c 795b 302c  poly_2d(&poly[0,
-0001d700: 2030 5d2c 2026 6c74 7269 5b30 5d2c 2026   0], &ltri[0], &
-0001d710: 6469 6666 5b30 5d2c 2026 6c72 6566 5b30  diff[0], &lref[0
-0001d720: 5d2c 206e 7665 7274 290a 0a20 2020 2023  ], nvert)..    #
-0001d730: 2066 7265 6520 6d65 6d6f 7279 2e2e 2e2e   free memory....
-0001d740: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 0a20 2020  .............   
-0001d750: 2066 7265 6528 6469 6666 290a 2020 2020   free(diff).    
-0001d760: 6672 6565 286c 7265 6629 0a20 2020 2072  free(lref).    r
-0001d770: 6574 7572 6e20 6c74 7269 2e72 6573 6861  eturn ltri.resha
-0001d780: 7065 2828 6e76 6572 742d 322c 2033 2929  pe((nvert-2, 3))
-0001d790: 0a0a 0a64 6566 2076 6967 6e65 7474 696e  ...def vignettin
-0001d7a0: 6728 0a20 2020 2064 6f75 626c 655b 3a2c  g(.    double[:,
-0001d7b0: 203a 3a31 5d20 7261 795f 6f72 6967 2c0a   ::1] ray_orig,.
-0001d7c0: 2020 2020 646f 7562 6c65 5b3a 2c20 3a3a      double[:, ::
-0001d7d0: 315d 2072 6179 5f76 6469 722c 0a20 2020  1] ray_vdir,.   
-0001d7e0: 206c 6973 7420 7669 676e 6574 745f 706f   list vignett_po
-0001d7f0: 6c79 2c0a 2020 2020 6c6f 6e67 5b3a 3a31  ly,.    long[::1
-0001d800: 5d20 6c6e 7665 7274 2c0a 2020 2020 696e  ] lnvert,.    in
-0001d810: 7420 6e75 6d5f 7468 7265 6164 733d 3136  t num_threads=16
-0001d820: 2c0a 293a 0a20 2020 2022 2222 0a20 2020  ,.):.    """.   
-0001d830: 2072 6179 5f6f 7269 6720 3a20 2833 2c20   ray_orig : (3, 
-0001d840: 6e6c 6f73 2920 646f 7562 6c65 2061 7272  nlos) double arr
-0001d850: 6179 0a20 2020 2020 2020 4c4f 5320 6f72  ay.       LOS or
-0001d860: 6967 696e 2070 6f69 6e74 7320 636f 6f72  igin points coor
-0001d870: 6469 6e61 7465 730a 2020 2020 7261 795f  dinates.    ray_
-0001d880: 7664 6972 203a 2028 332c 206e 6c6f 7329  vdir : (3, nlos)
-0001d890: 2064 6f75 626c 6520 6172 7261 790a 2020   double array.  
-0001d8a0: 2020 2020 204c 4f53 206e 6f72 6d61 6c69       LOS normali
-0001d8b0: 7a65 6420 6469 7265 6374 696f 6e20 7665  zed direction ve
-0001d8c0: 6374 6f72 0a20 2020 2076 6967 6e65 7474  ctor.    vignett
-0001d8d0: 5f70 6f6c 7920 3a20 286e 756d 5f76 6967  _poly : (num_vig
-0001d8e0: 6e2c 2033 2c20 6e75 6d5f 7665 7274 6578  n, 3, num_vertex
-0001d8f0: 2920 646f 7562 6c65 206c 6973 7420 6f66  ) double list of
-0001d900: 2061 7272 6179 730a 2020 2020 2020 2043   arrays.       C
-0001d910: 6f6f 7264 696e 6174 6573 206f 6620 7468  oordinates of th
-0001d920: 6520 7665 7274 6963 6573 206f 6620 7468  e vertices of th
-0001d930: 6520 506f 6c79 676f 6e20 6465 6669 6e69  e Polygon defini
-0001d940: 6e67 2074 6865 2033 4420 7669 676e 6574  ng the 3D vignet
-0001d950: 742e 0a20 2020 2020 2020 504f 4c59 2043  t..       POLY C
-0001d960: 4c4f 5345 440a 2020 2020 6c6e 7665 7274  LOSED.    lnvert
-0001d970: 203a 2028 6e75 6d5f 7669 676e 2920 6c6f   : (num_vign) lo
-0001d980: 6e67 2061 7272 6179 0a20 2020 2020 2020  ng array.       
-0001d990: 4e75 6d62 6572 206f 6620 7665 7274 6963  Number of vertic
-0001d9a0: 6573 2066 6f72 2065 6163 6820 7669 676e  es for each vign
-0001d9b0: 6574 7420 2877 6974 686f 7574 2063 6f75  ett (without cou
-0001d9c0: 6e74 696e 6720 7468 6520 7265 626f 756e  nting the reboun
-0001d9d0: 6429 0a20 2020 2052 6574 7572 6e73 0a20  d).    Returns. 
-0001d9e0: 2020 203d 3d3d 3d3d 3d0a 2020 2020 676f     ======.    go
-0001d9f0: 6573 5f74 6872 6f75 6768 3a20 286e 756d  es_through: (num
-0001da00: 5f76 6967 6e2c 206e 6c6f 7329 2062 6f6f  _vign, nlos) boo
-0001da10: 6c20 6172 7261 790a 2020 2020 2020 2049  l array.       I
-0001da20: 6e64 6963 6174 6573 2066 6f72 2065 6163  ndicates for eac
-0001da30: 6820 7669 676e 6574 7420 6966 2065 6163  h vignett if eac
-0001da40: 6820 4c4f 5320 7765 6e74 7320 7468 726f  h LOS wents thro
-0001da50: 7567 6820 6f72 206e 6f74 0a20 2020 2022  ugh or not.    "
-0001da60: 2222 0a20 2020 2063 6465 6620 696e 7420  "".    cdef int 
-0001da70: 6969 0a20 2020 2063 6465 6620 696e 7420  ii.    cdef int 
-0001da80: 6e76 6967 6e2c 206e 6c6f 730a 2020 2020  nvign, nlos.    
-0001da90: 6364 6566 206e 702e 6e64 6172 7261 795b  cdef np.ndarray[
-0001daa0: 6e70 2e75 696e 7438 5f74 2c6e 6469 6d3d  np.uint8_t,ndim=
-0001dab0: 312c 6361 7374 3d54 7275 655d 2067 6f65  1,cast=True] goe
-0001dac0: 735f 7468 726f 7567 680a 2020 2020 6364  s_through.    cd
-0001dad0: 6566 206c 6f6e 672a 2a20 6c74 7269 203d  ef long** ltri =
-0001dae0: 204e 554c 4c0a 2020 2020 6364 6566 2064   NULL.    cdef d
-0001daf0: 6f75 626c 652a 206c 626f 756e 6473 203d  ouble* lbounds =
-0001db00: 204e 554c 4c0a 2020 2020 6364 6566 2064   NULL.    cdef d
-0001db10: 6f75 626c 652a 2a20 6461 7461 203d 204e  ouble** data = N
-0001db20: 554c 4c0a 2020 2020 6364 6566 2062 696e  ULL.    cdef bin
-0001db30: 742a 2062 6f6f 6c5f 7265 7320 3d20 4e55  t* bool_res = NU
-0001db40: 4c4c 0a20 2020 2063 6465 6620 6e70 2e6e  LL.    cdef np.n
-0001db50: 6461 7272 6179 5b64 6f75 626c 652c 206e  darray[double, n
-0001db60: 6469 6d3d 322c 206d 6f64 653d 2263 225d  dim=2, mode="c"]
-0001db70: 2074 656d 700a 2020 2020 2320 2d2d 2049   temp.    # -- I
-0001db80: 6e69 7469 616c 697a 6174 696f 6e20 2d2d  nitialization --
-0001db90: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0001dba0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0001dbb0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0001dbc0: 2d2d 2d2d 2d2d 0a20 2020 206e 7669 676e  ------.    nvign
-0001dbd0: 203d 206c 656e 2876 6967 6e65 7474 5f70   = len(vignett_p
-0001dbe0: 6f6c 7929 0a20 2020 206e 6c6f 7320 3d20  oly).    nlos = 
-0001dbf0: 7261 795f 6f72 6967 2e73 6861 7065 5b31  ray_orig.shape[1
-0001dc00: 5d0a 2020 2020 676f 6573 5f74 6872 6f75  ].    goes_throu
-0001dc10: 6768 203d 206e 702e 656d 7074 7928 286e  gh = np.empty((n
-0001dc20: 6c6f 732a 6e76 6967 6e29 2c64 7479 7065  los*nvign),dtype
-0001dc30: 3d62 6f6f 6c29 0a20 2020 2023 2072 6520  =bool).    # re 
-0001dc40: 7772 6974 7469 6e67 2076 6967 6e65 7474  writting vignett
-0001dc50: 5f70 6f6c 7920 746f 2043 2074 7970 653a  _poly to C type:
-0001dc60: 0a20 2020 2064 6174 6120 3d20 3c64 6f75  .    data = <dou
-0001dc70: 626c 6520 2a2a 3e20 6d61 6c6c 6f63 286e  ble **> malloc(n
-0001dc80: 7669 676e 2a73 697a 656f 6628 646f 7562  vign*sizeof(doub
-0001dc90: 6c65 202a 2929 0a20 2020 2066 6f72 2069  le *)).    for i
-0001dca0: 6920 696e 2072 616e 6765 286e 7669 676e  i in range(nvign
-0001dcb0: 293a 0a20 2020 2020 2020 2074 656d 7020  ):.        temp 
-0001dcc0: 3d20 7669 676e 6574 745f 706f 6c79 5b69  = vignett_poly[i
-0001dcd0: 695d 0a20 2020 2020 2020 2064 6174 615b  i].        data[
-0001dce0: 6969 5d20 3d20 2674 656d 705b 302c 305d  ii] = &temp[0,0]
-0001dcf0: 0a20 2020 2023 202d 2d20 5072 6570 6172  .    # -- Prepar
-0001dd00: 6174 696f 6e20 2d2d 2d2d 2d2d 2d2d 2d2d  ation ----------
-0001dd10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0001dd20: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0001dd30: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0001dd40: 2d0a 2020 2020 6c62 6f75 6e64 7320 3d20  -.    lbounds = 
-0001dd50: 3c64 6f75 626c 652a 3e6d 616c 6c6f 6328  <double*>malloc(
-0001dd60: 7369 7a65 6f66 2864 6f75 626c 6529 202a  sizeof(double) *
-0001dd70: 2036 202a 206e 7669 676e 290a 2020 2020   6 * nvign).    
-0001dd80: 5f72 742e 636f 6d70 7574 655f 3364 5f62  _rt.compute_3d_b
-0001dd90: 626f 7865 7328 6461 7461 2c20 266c 6e76  boxes(data, &lnv
-0001dda0: 6572 745b 305d 2c20 6e76 6967 6e2c 2026  ert[0], nvign, &
-0001ddb0: 6c62 6f75 6e64 735b 305d 2c0a 2020 2020  lbounds[0],.    
-0001ddc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ddd0: 2020 2020 2020 6e75 6d5f 7468 7265 6164        num_thread
-0001dde0: 733d 6e75 6d5f 7468 7265 6164 7329 0a20  s=num_threads). 
-0001ddf0: 2020 206c 7472 6920 3d20 3c6c 6f6e 672a     ltri = <long*
-0001de00: 2a3e 6d61 6c6c 6f63 2873 697a 656f 6628  *>malloc(sizeof(
-0001de10: 6c6f 6e67 2a29 2a6e 7669 676e 290a 2020  long*)*nvign).  
-0001de20: 2020 5f76 742e 7472 6961 6e67 756c 6174    _vt.triangulat
-0001de30: 655f 706f 6c79 7328 6461 7461 2c20 266c  e_polys(data, &l
-0001de40: 6e76 6572 745b 305d 2c20 6e76 6967 6e2c  nvert[0], nvign,
-0001de50: 206c 7472 692c 0a20 2020 2020 2020 2020   ltri,.         
-0001de60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001de70: 206e 756d 5f74 6872 6561 6473 290a 2020   num_threads).  
-0001de80: 2020 2320 2d2d 2057 6520 6361 6c6c 2063    # -- We call c
-0001de90: 6f72 6520 6675 6e63 7469 6f6e 202d 2d2d  ore function ---
-0001dea0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0001deb0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0001dec0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20  --------------. 
-0001ded0: 2020 2062 6f6f 6c5f 7265 7320 3d20 3c62     bool_res = <b
-0001dee0: 696e 742a 3e6d 616c 6c6f 6328 6e6c 6f73  int*>malloc(nlos
-0001def0: 2a6e 7669 676e 2a73 697a 656f 6628 6269  *nvign*sizeof(bi
-0001df00: 6e74 2929 0a20 2020 205f 7674 2e76 6967  nt)).    _vt.vig
-0001df10: 6e65 7474 696e 675f 636f 7265 2872 6179  netting_core(ray
-0001df20: 5f6f 7269 672c 2072 6179 5f76 6469 722c  _orig, ray_vdir,
-0001df30: 2064 6174 612c 2026 6c6e 7665 7274 5b30   data, &lnvert[0
-0001df40: 5d2c 2026 6c62 6f75 6e64 735b 305d 2c0a  ], &lbounds[0],.
-0001df50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001df60: 2020 2020 2020 2020 6c74 7269 2c20 6e76          ltri, nv
-0001df70: 6967 6e2c 206e 6c6f 732c 2026 626f 6f6c  ign, nlos, &bool
-0001df80: 5f72 6573 5b30 5d2c 6e75 6d5f 7468 7265  _res[0],num_thre
-0001df90: 6164 7329 0a20 2020 2066 6f72 2069 6920  ads).    for ii 
-0001dfa0: 696e 2072 616e 6765 286e 6c6f 732a 6e76  in range(nlos*nv
-0001dfb0: 6967 6e29 3a0a 2020 2020 2020 2020 676f  ign):.        go
-0001dfc0: 6573 5f74 6872 6f75 6768 5b69 695d 203d  es_through[ii] =
-0001dfd0: 2062 6f6f 6c5f 7265 735b 6969 5d0a 2020   bool_res[ii].  
-0001dfe0: 2020 2320 2d2d 2043 6c65 616e 696e 6720    # -- Cleaning 
-0001dff0: 7570 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  up -------------
-0001e000: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0001e010: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0001e020: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20  --------------. 
-0001e030: 2020 2066 7265 6528 626f 6f6c 5f72 6573     free(bool_res
-0001e040: 290a 2020 2020 6672 6565 286c 626f 756e  ).    free(lboun
-0001e050: 6473 290a 2020 2020 2320 5765 2068 6176  ds).    # We hav
-0001e060: 6520 746f 2066 7265 6520 6561 6368 2061  e to free each a
-0001e070: 7272 6179 2066 6f72 2065 6163 6820 7669  rray for each vi
-0001e080: 676e 6574 743a 0a20 2020 2066 6f72 2069  gnett:.    for i
-0001e090: 6920 696e 2072 616e 6765 286e 7669 676e  i in range(nvign
-0001e0a0: 293a 0a20 2020 2020 2020 2066 7265 6528  ):.        free(
-0001e0b0: 6c74 7269 5b69 695d 290a 2020 2020 6672  ltri[ii]).    fr
-0001e0c0: 6565 286c 7472 6929 2023 2061 6e64 206e  ee(ltri) # and n
-0001e0d0: 6f77 2077 6520 6361 6e20 6672 6565 2074  ow we can free t
-0001e0e0: 6865 206d 6169 6e20 706f 696e 7465 720a  he main pointer.
-0001e0f0: 2020 2020 6672 6565 2864 6174 6129 0a20      free(data). 
-0001e100: 2020 2072 6574 7572 6e20 676f 6573 5f74     return goes_t
-0001e110: 6872 6f75 6768 0a0a 0a23 203d 3d3d 3d3d  hrough...# =====
-0001e120: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001e130: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001e140: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001d190: 6c73 7472 7563 745f 6e6f 726d 782c 206c  lstruct_normx, l
+0001d1a0: 7374 7275 6374 5f6e 6f72 6d79 2c0a 2020  struct_normy,.  
+0001d1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d1c0: 2020 2020 2020 2020 6c6e 7665 7274 2c20          lnvert, 
+0001d1d0: 6e73 7472 7563 745f 746f 742c 206e 7374  nstruct_tot, nst
+0001d1e0: 7275 6374 5f6c 696d 2c0a 2020 2020 2020  ruct_lim,.      
+0001d1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d200: 2020 2020 726d 696e 2c20 6570 735f 757a      rmin, eps_uz
+0001d210: 2c20 6570 735f 612c 2065 7073 5f76 7a2c  , eps_a, eps_vz,
+0001d220: 2065 7073 5f62 2c0a 2020 2020 2020 2020   eps_b,.        
+0001d230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d240: 2020 6570 735f 706c 616e 652c 2076 6573    eps_plane, ves
+0001d250: 5f74 7970 652e 6c6f 7765 7228 293d 3d27  _type.lower()=='
+0001d260: 746f 7227 2c0a 2020 2020 2020 2020 2020  tor',.          
+0001d270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d280: 666f 7262 6964 2c20 6e75 6d5f 7468 7265  forbid, num_thre
+0001d290: 6164 7329 0a20 2020 2072 6574 7572 6e20  ads).    return 
+0001d2a0: 6973 5f73 6565 6e0a 0a0a 2320 3d3d 3d3d  is_seen...# ====
+0001d2b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001d2c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001d2d0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001d2e0: 3d3d 3d3d 3d3d 3d3d 3d3d 0a23 0a23 2020  ==========.#.#  
+0001d2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d300: 2020 2020 2020 2020 2020 2020 2020 2056                 V
+0001d310: 4947 4e45 5454 494e 470a 230a 2320 3d3d  IGNETTING.#.# ==
+0001d320: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001d330: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001d340: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001d350: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 0a0a  =============...
+0001d360: 6465 6620 7472 6961 6e67 756c 6174 655f  def triangulate_
+0001d370: 6279 5f65 6172 636c 6970 7069 6e67 5f32  by_earclipping_2
+0001d380: 6428 0a20 2020 206e 702e 6e64 6172 7261  d(.    np.ndarra
+0001d390: 795b 646f 7562 6c65 2c20 6e64 696d 3d32  y[double, ndim=2
+0001d3a0: 5d20 706f 6c79 2c0a 293a 0a20 2020 2022  ] poly,.):.    "
+0001d3b0: 2222 0a20 2020 2054 7269 616e 6775 6c61  "".    Triangula
+0001d3c0: 7465 7320 6120 7369 6e67 6c65 2033 6420  tes a single 3d 
+0001d3d0: 706f 6c79 676f 6e20 6279 2074 6865 2065  polygon by the e
+0001d3e0: 6172 636c 6970 7069 6e67 206d 6574 686f  arclipping metho
+0001d3f0: 642e 0a20 2020 2043 6f6e 7665 7274 7320  d..    Converts 
+0001d400: 3364 2070 6f6c 7967 6f6e 2069 6e74 6f20  3d polygon into 
+0001d410: 3264 2063 6f75 6e74 6572 2d63 6c6f 636b  2d counter-clock
+0001d420: 7769 7365 2070 726f 6a65 6374 696f 6e0a  wise projection.
+0001d430: 0a20 2020 2050 6172 616d 730a 2020 2020  .    Params.    
+0001d440: 3d3d 3d3d 3d0a 2020 2020 706f 6c79 203a  =====.    poly :
+0001d450: 2028 332c 206e 7665 7274 2920 646f 7562   (3, nvert) doub
+0001d460: 6c65 2061 7272 6179 0a20 2020 2020 2020  le array.       
+0001d470: 2043 6f6e 7461 696e 7320 3344 2063 6f6f   Contains 3D coo
+0001d480: 7264 696e 6174 6573 206f 6620 6f70 656e  rdinates of open
+0001d490: 2070 6f6c 7967 6f6e 2069 6e20 636f 756e   polygon in coun
+0001d4a0: 7465 7220 636c 6f63 6b77 6973 6520 6f72  ter clockwise or
+0001d4b0: 6465 720a 2020 2020 5265 7475 726e 730a  der.    Returns.
+0001d4c0: 2020 2020 3d3d 3d3d 3d3d 3d0a 2020 2020      =======.    
+0001d4d0: 6c74 7269 203a 2028 332a 286e 7665 7274  ltri : (3*(nvert
+0001d4e0: 2d32 2929 2069 6e74 2061 7272 6179 0a20  -2)) int array. 
+0001d4f0: 2020 2020 2020 2049 6e64 6963 6573 206f         Indices o
+0001d500: 6620 7472 6961 6e67 6c65 730a 2020 2020  f triangles.    
+0001d510: 2222 220a 2020 2020 6364 6566 2069 6e74  """.    cdef int
+0001d520: 206e 7665 7274 203d 2070 6f6c 792e 7368   nvert = poly.sh
+0001d530: 6170 655b 315d 0a20 2020 2063 6465 6620  ape[1].    cdef 
+0001d540: 6e70 2e6e 6461 7272 6179 5b6c 6f6e 672c  np.ndarray[long,
+0001d550: 206e 6469 6d3d 315d 206c 7472 6920 3d20   ndim=1] ltri = 
+0001d560: 6e70 2e65 6d70 7479 2828 6e76 6572 742d  np.empty((nvert-
+0001d570: 3229 2a33 2c20 6474 7970 653d 696e 7429  2)*3, dtype=int)
+0001d580: 0a20 2020 2063 6465 6620 646f 7562 6c65  .    cdef double
+0001d590: 2a20 6469 6666 203d 204e 554c 4c0a 2020  * diff = NULL.  
+0001d5a0: 2020 6364 6566 2062 696e 742a 206c 7265    cdef bint* lre
+0001d5b0: 6620 3d20 4e55 4c4c 0a0a 2020 2020 2320  f = NULL..    # 
+0001d5c0: 496e 6974 6961 6c69 7a61 7469 6f6e 202e  Initialization .
+0001d5d0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+0001d5e0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+0001d5f0: 2e2e 2e2e 2e2e 2e2e 2e0a 2020 2020 6469  ..........    di
+0001d600: 6666 203d 203c 646f 7562 6c65 2a3e 6d61  ff = <double*>ma
+0001d610: 6c6c 6f63 2832 2a6e 7665 7274 2a73 697a  lloc(2*nvert*siz
+0001d620: 656f 6628 646f 7562 6c65 2929 0a20 2020  eof(double)).   
+0001d630: 206c 7265 6620 3d20 3c62 696e 742a 3e6d   lref = <bint*>m
+0001d640: 616c 6c6f 6328 6e76 6572 742a 7369 7a65  alloc(nvert*size
+0001d650: 6f66 2862 696e 7429 290a 0a20 2020 205f  of(bint))..    _
+0001d660: 7674 2e63 6f6d 7075 7465 5f64 6966 6632  vt.compute_diff2
+0001d670: 6428 2670 6f6c 795b 302c 2030 5d2c 206e  d(&poly[0, 0], n
+0001d680: 7665 7274 2c20 2664 6966 665b 305d 290a  vert, &diff[0]).
+0001d690: 2020 2020 5f76 742e 6172 655f 706f 696e      _vt.are_poin
+0001d6a0: 7473 5f72 6566 6c65 785f 3264 286e 7665  ts_reflex_2d(nve
+0001d6b0: 7274 2c20 2664 6966 665b 305d 2c20 266c  rt, &diff[0], &l
+0001d6c0: 7265 665b 305d 290a 0a20 2020 2023 2043  ref[0])..    # C
+0001d6d0: 616c 6c69 6e67 2063 6f72 6520 6675 6e63  alling core func
+0001d6e0: 7469 6f6e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  tion............
+0001d6f0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+0001d700: 2e2e 2e2e 2e2e 2e2e 2e2e 0a20 2020 205f  ...........    _
+0001d710: 7674 2e65 6172 636c 6970 7069 6e67 5f70  vt.earclipping_p
+0001d720: 6f6c 795f 3264 2826 706f 6c79 5b30 2c20  oly_2d(&poly[0, 
+0001d730: 305d 2c20 266c 7472 695b 305d 2c20 2664  0], &ltri[0], &d
+0001d740: 6966 665b 305d 2c20 266c 7265 665b 305d  iff[0], &lref[0]
+0001d750: 2c20 6e76 6572 7429 0a0a 2020 2020 2320  , nvert)..    # 
+0001d760: 6672 6565 206d 656d 6f72 792e 2e2e 2e2e  free memory.....
+0001d770: 2e2e 2e2e 2e2e 2e2e 2e2e 2e0a 2020 2020  ............    
+0001d780: 6672 6565 2864 6966 6629 0a20 2020 2066  free(diff).    f
+0001d790: 7265 6528 6c72 6566 290a 2020 2020 7265  ree(lref).    re
+0001d7a0: 7475 726e 206c 7472 692e 7265 7368 6170  turn ltri.reshap
+0001d7b0: 6528 286e 7665 7274 2d32 2c20 3329 290a  e((nvert-2, 3)).
+0001d7c0: 0a0a 6465 6620 7669 676e 6574 7469 6e67  ..def vignetting
+0001d7d0: 280a 2020 2020 646f 7562 6c65 5b3a 2c20  (.    double[:, 
+0001d7e0: 3a3a 315d 2072 6179 5f6f 7269 672c 0a20  ::1] ray_orig,. 
+0001d7f0: 2020 2064 6f75 626c 655b 3a2c 203a 3a31     double[:, ::1
+0001d800: 5d20 7261 795f 7664 6972 2c0a 2020 2020  ] ray_vdir,.    
+0001d810: 6c69 7374 2076 6967 6e65 7474 5f70 6f6c  list vignett_pol
+0001d820: 792c 0a20 2020 206c 6f6e 675b 3a3a 315d  y,.    long[::1]
+0001d830: 206c 6e76 6572 742c 0a20 2020 2069 6e74   lnvert,.    int
+0001d840: 206e 756d 5f74 6872 6561 6473 3d31 362c   num_threads=16,
+0001d850: 0a29 3a0a 2020 2020 2222 220a 2020 2020  .):.    """.    
+0001d860: 7261 795f 6f72 6967 203a 2028 332c 206e  ray_orig : (3, n
+0001d870: 6c6f 7329 2064 6f75 626c 6520 6172 7261  los) double arra
+0001d880: 790a 2020 2020 2020 204c 4f53 206f 7269  y.       LOS ori
+0001d890: 6769 6e20 706f 696e 7473 2063 6f6f 7264  gin points coord
+0001d8a0: 696e 6174 6573 0a20 2020 2072 6179 5f76  inates.    ray_v
+0001d8b0: 6469 7220 3a20 2833 2c20 6e6c 6f73 2920  dir : (3, nlos) 
+0001d8c0: 646f 7562 6c65 2061 7272 6179 0a20 2020  double array.   
+0001d8d0: 2020 2020 4c4f 5320 6e6f 726d 616c 697a      LOS normaliz
+0001d8e0: 6564 2064 6972 6563 7469 6f6e 2076 6563  ed direction vec
+0001d8f0: 746f 720a 2020 2020 7669 676e 6574 745f  tor.    vignett_
+0001d900: 706f 6c79 203a 2028 6e75 6d5f 7669 676e  poly : (num_vign
+0001d910: 2c20 332c 206e 756d 5f76 6572 7465 7829  , 3, num_vertex)
+0001d920: 2064 6f75 626c 6520 6c69 7374 206f 6620   double list of 
+0001d930: 6172 7261 7973 0a20 2020 2020 2020 436f  arrays.       Co
+0001d940: 6f72 6469 6e61 7465 7320 6f66 2074 6865  ordinates of the
+0001d950: 2076 6572 7469 6365 7320 6f66 2074 6865   vertices of the
+0001d960: 2050 6f6c 7967 6f6e 2064 6566 696e 696e   Polygon definin
+0001d970: 6720 7468 6520 3344 2076 6967 6e65 7474  g the 3D vignett
+0001d980: 2e0a 2020 2020 2020 2050 4f4c 5920 434c  ..       POLY CL
+0001d990: 4f53 4544 0a20 2020 206c 6e76 6572 7420  OSED.    lnvert 
+0001d9a0: 3a20 286e 756d 5f76 6967 6e29 206c 6f6e  : (num_vign) lon
+0001d9b0: 6720 6172 7261 790a 2020 2020 2020 204e  g array.       N
+0001d9c0: 756d 6265 7220 6f66 2076 6572 7469 6365  umber of vertice
+0001d9d0: 7320 666f 7220 6561 6368 2076 6967 6e65  s for each vigne
+0001d9e0: 7474 2028 7769 7468 6f75 7420 636f 756e  tt (without coun
+0001d9f0: 7469 6e67 2074 6865 2072 6562 6f75 6e64  ting the rebound
+0001da00: 290a 2020 2020 5265 7475 726e 730a 2020  ).    Returns.  
+0001da10: 2020 3d3d 3d3d 3d3d 0a20 2020 2067 6f65    ======.    goe
+0001da20: 735f 7468 726f 7567 683a 2028 6e75 6d5f  s_through: (num_
+0001da30: 7669 676e 2c20 6e6c 6f73 2920 626f 6f6c  vign, nlos) bool
+0001da40: 2061 7272 6179 0a20 2020 2020 2020 496e   array.       In
+0001da50: 6469 6361 7465 7320 666f 7220 6561 6368  dicates for each
+0001da60: 2076 6967 6e65 7474 2069 6620 6561 6368   vignett if each
+0001da70: 204c 4f53 2077 656e 7473 2074 6872 6f75   LOS wents throu
+0001da80: 6768 206f 7220 6e6f 740a 2020 2020 2222  gh or not.    ""
+0001da90: 220a 2020 2020 6364 6566 2069 6e74 2069  ".    cdef int i
+0001daa0: 690a 2020 2020 6364 6566 2069 6e74 206e  i.    cdef int n
+0001dab0: 7669 676e 2c20 6e6c 6f73 0a20 2020 2063  vign, nlos.    c
+0001dac0: 6465 6620 6e70 2e6e 6461 7272 6179 5b6e  def np.ndarray[n
+0001dad0: 702e 7569 6e74 385f 742c 6e64 696d 3d31  p.uint8_t,ndim=1
+0001dae0: 2c63 6173 743d 5472 7565 5d20 676f 6573  ,cast=True] goes
+0001daf0: 5f74 6872 6f75 6768 0a20 2020 2063 6465  _through.    cde
+0001db00: 6620 6c6f 6e67 2a2a 206c 7472 6920 3d20  f long** ltri = 
+0001db10: 4e55 4c4c 0a20 2020 2063 6465 6620 646f  NULL.    cdef do
+0001db20: 7562 6c65 2a20 6c62 6f75 6e64 7320 3d20  uble* lbounds = 
+0001db30: 4e55 4c4c 0a20 2020 2063 6465 6620 646f  NULL.    cdef do
+0001db40: 7562 6c65 2a2a 2064 6174 6120 3d20 4e55  uble** data = NU
+0001db50: 4c4c 0a20 2020 2063 6465 6620 6269 6e74  LL.    cdef bint
+0001db60: 2a20 626f 6f6c 5f72 6573 203d 204e 554c  * bool_res = NUL
+0001db70: 4c0a 2020 2020 6364 6566 206e 702e 6e64  L.    cdef np.nd
+0001db80: 6172 7261 795b 646f 7562 6c65 2c20 6e64  array[double, nd
+0001db90: 696d 3d32 2c20 6d6f 6465 3d22 6322 5d20  im=2, mode="c"] 
+0001dba0: 7465 6d70 0a20 2020 2023 202d 2d20 496e  temp.    # -- In
+0001dbb0: 6974 6961 6c69 7a61 7469 6f6e 202d 2d2d  itialization ---
+0001dbc0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0001dbd0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0001dbe0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0001dbf0: 2d2d 2d2d 2d0a 2020 2020 6e76 6967 6e20  -----.    nvign 
+0001dc00: 3d20 6c65 6e28 7669 676e 6574 745f 706f  = len(vignett_po
+0001dc10: 6c79 290a 2020 2020 6e6c 6f73 203d 2072  ly).    nlos = r
+0001dc20: 6179 5f6f 7269 672e 7368 6170 655b 315d  ay_orig.shape[1]
+0001dc30: 0a20 2020 2067 6f65 735f 7468 726f 7567  .    goes_throug
+0001dc40: 6820 3d20 6e70 2e65 6d70 7479 2828 6e6c  h = np.empty((nl
+0001dc50: 6f73 2a6e 7669 676e 292c 6474 7970 653d  os*nvign),dtype=
+0001dc60: 626f 6f6c 290a 2020 2020 2320 7265 2077  bool).    # re w
+0001dc70: 7269 7474 696e 6720 7669 676e 6574 745f  ritting vignett_
+0001dc80: 706f 6c79 2074 6f20 4320 7479 7065 3a0a  poly to C type:.
+0001dc90: 2020 2020 6461 7461 203d 203c 646f 7562      data = <doub
+0001dca0: 6c65 202a 2a3e 206d 616c 6c6f 6328 6e76  le **> malloc(nv
+0001dcb0: 6967 6e2a 7369 7a65 6f66 2864 6f75 626c  ign*sizeof(doubl
+0001dcc0: 6520 2a29 290a 2020 2020 666f 7220 6969  e *)).    for ii
+0001dcd0: 2069 6e20 7261 6e67 6528 6e76 6967 6e29   in range(nvign)
+0001dce0: 3a0a 2020 2020 2020 2020 7465 6d70 203d  :.        temp =
+0001dcf0: 2076 6967 6e65 7474 5f70 6f6c 795b 6969   vignett_poly[ii
+0001dd00: 5d0a 2020 2020 2020 2020 6461 7461 5b69  ].        data[i
+0001dd10: 695d 203d 2026 7465 6d70 5b30 2c30 5d0a  i] = &temp[0,0].
+0001dd20: 2020 2020 2320 2d2d 2050 7265 7061 7261      # -- Prepara
+0001dd30: 7469 6f6e 202d 2d2d 2d2d 2d2d 2d2d 2d2d  tion -----------
+0001dd40: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0001dd50: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0001dd60: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0001dd70: 0a20 2020 206c 626f 756e 6473 203d 203c  .    lbounds = <
+0001dd80: 646f 7562 6c65 2a3e 6d61 6c6c 6f63 2873  double*>malloc(s
+0001dd90: 697a 656f 6628 646f 7562 6c65 2920 2a20  izeof(double) * 
+0001dda0: 3620 2a20 6e76 6967 6e29 0a20 2020 205f  6 * nvign).    _
+0001ddb0: 7274 2e63 6f6d 7075 7465 5f33 645f 6262  rt.compute_3d_bb
+0001ddc0: 6f78 6573 2864 6174 612c 2026 6c6e 7665  oxes(data, &lnve
+0001ddd0: 7274 5b30 5d2c 206e 7669 676e 2c20 266c  rt[0], nvign, &l
+0001dde0: 626f 756e 6473 5b30 5d2c 0a20 2020 2020  bounds[0],.     
+0001ddf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001de00: 2020 2020 206e 756d 5f74 6872 6561 6473       num_threads
+0001de10: 3d6e 756d 5f74 6872 6561 6473 290a 2020  =num_threads).  
+0001de20: 2020 6c74 7269 203d 203c 6c6f 6e67 2a2a    ltri = <long**
+0001de30: 3e6d 616c 6c6f 6328 7369 7a65 6f66 286c  >malloc(sizeof(l
+0001de40: 6f6e 672a 292a 6e76 6967 6e29 0a20 2020  ong*)*nvign).   
+0001de50: 205f 7674 2e74 7269 616e 6775 6c61 7465   _vt.triangulate
+0001de60: 5f70 6f6c 7973 2864 6174 612c 2026 6c6e  _polys(data, &ln
+0001de70: 7665 7274 5b30 5d2c 206e 7669 676e 2c20  vert[0], nvign, 
+0001de80: 6c74 7269 2c0a 2020 2020 2020 2020 2020  ltri,.          
+0001de90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dea0: 6e75 6d5f 7468 7265 6164 7329 0a20 2020  num_threads).   
+0001deb0: 2023 202d 2d20 5765 2063 616c 6c20 636f   # -- We call co
+0001dec0: 7265 2066 756e 6374 696f 6e20 2d2d 2d2d  re function ----
+0001ded0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0001dee0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0001def0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020  -------------.  
+0001df00: 2020 626f 6f6c 5f72 6573 203d 203c 6269    bool_res = <bi
+0001df10: 6e74 2a3e 6d61 6c6c 6f63 286e 6c6f 732a  nt*>malloc(nlos*
+0001df20: 6e76 6967 6e2a 7369 7a65 6f66 2862 696e  nvign*sizeof(bin
+0001df30: 7429 290a 2020 2020 5f76 742e 7669 676e  t)).    _vt.vign
+0001df40: 6574 7469 6e67 5f63 6f72 6528 7261 795f  etting_core(ray_
+0001df50: 6f72 6967 2c20 7261 795f 7664 6972 2c20  orig, ray_vdir, 
+0001df60: 6461 7461 2c20 266c 6e76 6572 745b 305d  data, &lnvert[0]
+0001df70: 2c20 266c 626f 756e 6473 5b30 5d2c 0a20  , &lbounds[0],. 
+0001df80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001df90: 2020 2020 2020 206c 7472 692c 206e 7669         ltri, nvi
+0001dfa0: 676e 2c20 6e6c 6f73 2c20 2662 6f6f 6c5f  gn, nlos, &bool_
+0001dfb0: 7265 735b 305d 2c6e 756d 5f74 6872 6561  res[0],num_threa
+0001dfc0: 6473 290a 2020 2020 666f 7220 6969 2069  ds).    for ii i
+0001dfd0: 6e20 7261 6e67 6528 6e6c 6f73 2a6e 7669  n range(nlos*nvi
+0001dfe0: 676e 293a 0a20 2020 2020 2020 2067 6f65  gn):.        goe
+0001dff0: 735f 7468 726f 7567 685b 6969 5d20 3d20  s_through[ii] = 
+0001e000: 626f 6f6c 5f72 6573 5b69 695d 0a20 2020  bool_res[ii].   
+0001e010: 2023 202d 2d20 436c 6561 6e69 6e67 2075   # -- Cleaning u
+0001e020: 7020 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  p --------------
+0001e030: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0001e040: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0001e050: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020  -------------.  
+0001e060: 2020 6672 6565 2862 6f6f 6c5f 7265 7329    free(bool_res)
+0001e070: 0a20 2020 2066 7265 6528 6c62 6f75 6e64  .    free(lbound
+0001e080: 7329 0a20 2020 2023 2057 6520 6861 7665  s).    # We have
+0001e090: 2074 6f20 6672 6565 2065 6163 6820 6172   to free each ar
+0001e0a0: 7261 7920 666f 7220 6561 6368 2076 6967  ray for each vig
+0001e0b0: 6e65 7474 3a0a 2020 2020 666f 7220 6969  nett:.    for ii
+0001e0c0: 2069 6e20 7261 6e67 6528 6e76 6967 6e29   in range(nvign)
+0001e0d0: 3a0a 2020 2020 2020 2020 6672 6565 286c  :.        free(l
+0001e0e0: 7472 695b 6969 5d29 0a20 2020 2066 7265  tri[ii]).    fre
+0001e0f0: 6528 6c74 7269 2920 2320 616e 6420 6e6f  e(ltri) # and no
+0001e100: 7720 7765 2063 616e 2066 7265 6520 7468  w we can free th
+0001e110: 6520 6d61 696e 2070 6f69 6e74 6572 0a20  e main pointer. 
+0001e120: 2020 2066 7265 6528 6461 7461 290a 2020     free(data).  
+0001e130: 2020 7265 7475 726e 2067 6f65 735f 7468    return goes_th
+0001e140: 726f 7567 680a 0a0a 2320 3d3d 3d3d 3d3d  rough...# ======
 0001e150: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001e160: 3d3d 3d3d 3d3d 3d3d 3d0a 230a 2320 2020  =========.#.#   
-0001e170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e180: 2020 2020 2020 2020 2020 2020 2020 204c                 L
-0001e190: 4f53 2053 414d 504c 494e 470a 230a 2320  OS SAMPLING.#.# 
-0001e1a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001e1b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001e1c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001e160: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001e170: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001e180: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001e190: 3d3d 3d3d 3d3d 3d3d 0a23 0a23 2020 2020  ========.#.#    
+0001e1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e1b0: 2020 2020 2020 2020 2020 2020 2020 4c4f                LO
+0001e1c0: 5320 5341 4d50 4c49 4e47 0a23 0a23 203d  S SAMPLING.#.# =
 0001e1d0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0001e1e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 0a64  ==============.d
-0001e1f0: 6566 204c 4f53 5f67 6574 5f73 616d 706c  ef LOS_get_sampl
-0001e200: 6528 696e 7420 6e6c 6f73 2c20 644c 2c20  e(int nlos, dL, 
-0001e210: 646f 7562 6c65 5b3a 2c3a 3a31 5d20 6c6f  double[:,::1] lo
-0001e220: 735f 6c69 6d73 2c20 7374 7220 646d 6574  s_lims, str dmet
-0001e230: 686f 643d 2761 6273 272c 0a20 2020 2020  hod='abs',.     
-0001e240: 2020 2020 2020 2020 2020 2020 2020 7374                st
-0001e250: 7220 6d65 7468 6f64 3d27 7375 6d27 2c20  r method='sum', 
-0001e260: 6269 6e74 2054 6573 743d 5472 7565 2c20  bint Test=True, 
-0001e270: 696e 7420 6e75 6d5f 7468 7265 6164 733d  int num_threads=
-0001e280: 3136 293a 0a20 2020 2022 2222 0a20 2020  16):.    """.   
-0001e290: 2052 6574 7572 6e20 7468 6520 7361 6d70   Return the samp
-0001e2a0: 6c65 6420 6c69 6e65 2c20 7769 7468 2074  led line, with t
-0001e2b0: 6865 2073 7065 6369 6669 6564 206d 6574  he specified met
-0001e2c0: 686f 640a 2020 2020 2d20 2020 2773 756d  hod.    -   'sum
-0001e2d0: 2720 3a20 2020 2020 7265 7475 726e 204e  ' :     return N
-0001e2e0: 2073 6567 6d65 6e74 7320 6365 6e74 6572   segments center
-0001e2f0: 730a 2020 2020 2d20 2020 2773 696d 7073  s.    -   'simps
-0001e300: 273a 2020 2020 7265 7475 726e 204e 2b31  ':    return N+1
-0001e310: 2065 6764 6573 2c20 4e20 6576 656e 2028   egdes, N even (
-0001e320: 666f 7220 7363 6970 792e 696e 7465 6772  for scipy.integr
-0001e330: 6174 652e 7369 6d70 7329 0a20 2020 202d  ate.simps).    -
-0001e340: 2020 2027 726f 6d62 2720 3a20 2020 2072     'romb' :    r
-0001e350: 6574 7572 6e20 4e2b 3120 6564 6765 732c  eturn N+1 edges,
-0001e360: 204e 2b31 203d 2032 2a2a 6b2b 3120 2866   N+1 = 2**k+1 (f
-0001e370: 6f72 2073 6369 7079 2e69 6e74 6567 7261  or scipy.integra
-0001e380: 7465 2e72 6f6d 6229 0a20 2020 2020 2054  te.romb).      T
-0001e390: 6865 2064 6d65 7468 6f64 2064 6566 696e  he dmethod defin
-0001e3a0: 6573 2069 6620 7468 6520 6469 7363 7265  es if the discre
-0001e3b0: 7469 7a61 7469 6f6e 2073 7465 7020 6769  tization step gi
-0001e3c0: 7665 6e20 6973 2061 6273 6f6c 7574 6520  ven is absolute 
-0001e3d0: 2827 6162 7327 290a 2020 2020 2020 6f72  ('abs').      or
-0001e3e0: 2072 656c 6174 6976 6520 2827 7265 6c27   relative ('rel'
-0001e3f0: 290a 2020 2020 5061 7261 6d73 0a20 2020  ).    Params.   
-0001e400: 203d 3d3d 3d3d 3d0a 2020 2020 644c 3a20   ======.    dL: 
-0001e410: 646f 7562 6c65 206f 7220 6c69 7374 206f  double or list o
-0001e420: 6620 646f 7562 6c65 730a 2020 2020 2020  f doubles.      
-0001e430: 2020 4966 2064 4c20 6973 2061 2073 696e    If dL is a sin
-0001e440: 676c 6520 646f 7562 6c65 3a20 6469 7363  gle double: disc
-0001e450: 7265 7469 7a61 7469 6f6e 2073 7465 7020  retization step 
-0001e460: 666f 7220 616c 6c20 4c4f 532e 0a20 2020  for all LOS..   
-0001e470: 2020 2020 2045 6c73 6520 644c 2073 686f       Else dL sho
-0001e480: 756c 6420 6265 2061 206c 6973 7420 6f66  uld be a list of
-0001e490: 2073 697a 6520 6e6c 6f73 2077 6974 6820   size nlos with 
-0001e4a0: 7468 6520 6469 7363 7265 7469 7a61 7469  the discretizati
-0001e4b0: 6f6e 0a20 2020 2020 2020 2073 7465 7020  on.        step 
-0001e4c0: 666f 7220 6561 6368 206e 6c6f 732e 0a20  for each nlos.. 
-0001e4d0: 2020 206c 6f73 5f6c 696d 733a 2028 322c     los_lims: (2,
-0001e4e0: 206e 6c6f 7329 2064 6f75 626c 6520 6172   nlos) double ar
-0001e4f0: 7261 790a 2020 2020 2020 2020 466f 7220  ray.        For 
-0001e500: 6561 6368 206e 6c6f 732c 2069 7420 6769  each nlos, it gi
-0001e510: 7665 6e20 7468 6520 6d61 7869 6d75 6d20  ven the maximum 
-0001e520: 616e 6420 6d69 6e69 6d75 6d20 6c69 6d69  and minimum limi
-0001e530: 7473 206f 6620 7468 6520 7261 790a 2020  ts of the ray.  
-0001e540: 2020 646d 6574 686f 643a 2073 7472 696e    dmethod: strin
-0001e550: 670a 2020 2020 2020 2020 7479 7065 206f  g.        type o
-0001e560: 6620 6469 7363 7265 7469 7a61 7469 6f6e  f discretization
-0001e570: 2073 7465 703a 2027 6162 7327 2066 6f72   step: 'abs' for
-0001e580: 2061 6273 6f6c 7574 6520 6f72 2027 7265   absolute or 're
-0001e590: 6c27 2066 6f72 2072 656c 6174 6976 650a  l' for relative.
-0001e5a0: 2020 2020 6d65 7468 6f64 3a20 7374 7269      method: stri
-0001e5b0: 6e67 0a20 2020 2020 2020 206d 6574 686f  ng.        metho
-0001e5c0: 6420 6f66 2071 7561 6472 6174 7572 6520  d of quadrature 
-0001e5d0: 6f6e 2074 6865 204c 4f53 0a20 2020 2054  on the LOS.    T
-0001e5e0: 6573 743a 2062 6f6f 6c0a 2020 2020 2020  est: bool.      
-0001e5f0: 2020 746f 2069 6e64 6963 6174 6520 6966    to indicate if
-0001e600: 2074 6573 7473 2073 686f 756c 6420 6265   tests should be
-0001e610: 2064 6f6e 6520 6f72 206e 6f74 0a0a 2020   done or not..  
-0001e620: 2020 486f 7720 746f 2072 6563 6f6d 7075    How to recompu
-0001e630: 7465 2050 6f69 6e74 7320 636f 6f72 6469  te Points coordi
-0001e640: 6e61 7465 7320 6672 6f6d 2072 6573 756c  nates from resul
-0001e650: 7473 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  ts.    -------. 
-0001e660: 2020 206b 2c20 7265 732c 206c 696e 6420     k, res, lind 
-0001e670: 3d20 4c6f 735f 6765 745f 7361 6d70 6c65  = Los_get_sample
-0001e680: 282e 2e2e 290a 2020 2020 6e62 7265 7065  (...).    nbrepe
-0001e690: 7420 3d20 6e70 2e72 5f5b 6c69 6e64 5b30  t = np.r_[lind[0
-0001e6a0: 5d2c 206e 702e 6469 6666 286c 696e 6429  ], np.diff(lind)
-0001e6b0: 2c20 6b2e 7369 7a65 202d 206c 696e 645b  , k.size - lind[
-0001e6c0: 2d31 5d5d 0a20 2020 206b 7573 203d 206b  -1]].    kus = k
-0001e6d0: 202a 206e 702e 7265 7065 6174 2872 6179   * np.repeat(ray
-0001e6e0: 5f76 6469 722c 206e 6272 6570 6574 2c20  _vdir, nbrepet, 
-0001e6f0: 6178 6973 3d31 290a 2020 2020 5074 7320  axis=1).    Pts 
-0001e700: 3d20 6e70 2e72 6570 6561 7428 7261 795f  = np.repeat(ray_
-0001e710: 6f72 6967 2c20 6e62 7265 7065 742c 2061  orig, nbrepet, a
-0001e720: 7869 733d 3129 202b 206b 7573 0a20 2020  xis=1) + kus.   
-0001e730: 2022 2222 0a20 2020 2063 6465 6620 7374   """.    cdef st
-0001e740: 7220 6572 726f 725f 6d65 7373 6167 650a  r error_message.
-0001e750: 2020 2020 6364 6566 2073 7472 2064 6d6f      cdef str dmo
-0001e760: 6465 203d 2064 6d65 7468 6f64 2e6c 6f77  de = dmethod.low
-0001e770: 6572 2829 0a20 2020 2063 6465 6620 7374  er().    cdef st
-0001e780: 7220 696d 6f64 6520 3d20 6d65 7468 6f64  r imode = method
-0001e790: 2e6c 6f77 6572 2829 0a20 2020 2063 6465  .lower().    cde
-0001e7a0: 6620 696e 7420 737a 315f 646c 732c 2073  f int sz1_dls, s
-0001e7b0: 7a32 5f64 6c73 0a20 2020 2063 6465 6620  z2_dls.    cdef 
-0001e7c0: 696e 7420 737a 5f63 6f65 6666 0a20 2020  int sz_coeff.   
-0001e7d0: 2063 6465 6620 696e 7420 6e5f 696d 6f64   cdef int n_imod
-0001e7e0: 652c 206e 5f64 6d6f 6465 0a20 2020 2063  e, n_dmode.    c
-0001e7f0: 6465 6620 6269 6e74 2064 6c5f 6973 5f6c  def bint dl_is_l
-0001e800: 6973 740a 2020 2020 6364 6566 2062 696e  ist.    cdef bin
-0001e810: 7420 626f 6f6c 312c 2062 6f6f 6c32 0a20  t bool1, bool2. 
-0001e820: 2020 2063 6465 6620 646f 7562 6c65 5b3a     cdef double[:
-0001e830: 3a31 5d20 646c 5f76 6965 770a 2020 2020  :1] dl_view.    
-0001e840: 6364 6566 206e 702e 6e64 6172 7261 795b  cdef np.ndarray[
-0001e850: 646f 7562 6c65 2c6e 6469 6d3d 315d 2064  double,ndim=1] d
-0001e860: 4c72 0a20 2020 2063 6465 6620 6e70 2e6e  Lr.    cdef np.n
-0001e870: 6461 7272 6179 5b64 6f75 626c 652c 6e64  darray[double,nd
-0001e880: 696d 3d31 5d20 636f 6566 665f 6172 720a  im=1] coeff_arr.
-0001e890: 2020 2020 6364 6566 206e 702e 6e64 6172      cdef np.ndar
-0001e8a0: 7261 795b 6c6f 6e67 2c6e 6469 6d3d 315d  ray[long,ndim=1]
-0001e8b0: 206c 6f73 5f69 6e64 0a20 2020 2063 6465   los_ind.    cde
-0001e8c0: 6620 6c6f 6e67 2a20 746d 705f 6172 720a  f long* tmp_arr.
-0001e8d0: 2020 2020 6364 6566 2064 6f75 626c 652a      cdef double*
-0001e8e0: 206c 6f73 5f63 6f65 6666 7320 3d20 4e55   los_coeffs = NU
-0001e8f0: 4c4c 0a20 2020 2063 6465 6620 646f 7562  LL.    cdef doub
-0001e900: 6c65 2a2a 2063 6f65 6666 5f70 7472 203d  le** coeff_ptr =
-0001e910: 204e 554c 4c0a 2020 2020 6364 6566 206c   NULL.    cdef l
-0001e920: 6f6e 672a 206c 6f73 5f69 6e64 5f70 7472  ong* los_ind_ptr
-0001e930: 203d 204e 554c 4c0a 2020 2020 2320 2e2e   = NULL.    # ..
-0001e940: 2072 6179 5f6f 7269 6720 7368 6170 6520   ray_orig shape 
-0001e950: 6e65 6564 6564 2066 6f72 2074 6573 7469  needed for testi
-0001e960: 6e67 2061 6e64 2069 6e20 616c 676f 202e  ng and in algo .
-0001e970: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-0001e980: 2e2e 2e2e 2e2e 2e2e 0a20 2020 2064 4c72  .........    dLr
-0001e990: 203d 206e 702e 7a65 726f 7328 286e 6c6f   = np.zeros((nlo
-0001e9a0: 732c 292c 2064 7479 7065 3d66 6c6f 6174  s,), dtype=float
-0001e9b0: 290a 2020 2020 6c6f 735f 696e 6420 3d20  ).    los_ind = 
-0001e9c0: 6e70 2e7a 6572 6f73 2828 6e6c 6f73 2c29  np.zeros((nlos,)
-0001e9d0: 2c20 6474 7970 653d 696e 7429 0a20 2020  , dtype=int).   
-0001e9e0: 2064 6c5f 6973 5f6c 6973 7420 3d20 6861   dl_is_list = ha
-0001e9f0: 7361 7474 7228 644c 2c20 275f 5f69 7465  sattr(dL, '__ite
-0001ea00: 725f 5f27 290a 2020 2020 2320 2e2e 2076  r__').    # .. v
-0001ea10: 6572 6966 7969 6e67 2061 7267 756d 656e  erifying argumen
-0001ea20: 7473 202e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ts .............
-0001ea30: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-0001ea40: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-0001ea50: 2e2e 2e2e 2e2e 0a20 2020 2069 6620 5465  .......    if Te
-0001ea60: 7374 3a0a 2020 2020 2020 2020 737a 315f  st:.        sz1_
-0001ea70: 646c 7320 3d20 6c6f 735f 6c69 6d73 2e73  dls = los_lims.s
-0001ea80: 6861 7065 5b30 5d0a 2020 2020 2020 2020  hape[0].        
-0001ea90: 737a 325f 646c 7320 3d20 6c6f 735f 6c69  sz2_dls = los_li
-0001eaa0: 6d73 2e73 6861 7065 5b31 5d0a 2020 2020  ms.shape[1].    
-0001eab0: 2020 2020 6173 7365 7274 2073 7a31 5f64      assert sz1_d
-0001eac0: 6c73 203d 3d20 322c 2022 4469 6d20 3020  ls == 2, "Dim 0 
-0001ead0: 6f66 2061 7267 206c 6f73 5f6c 696d 7320  of arg los_lims 
-0001eae0: 7368 6f75 6c64 2062 6520 3222 0a20 2020  should be 2".   
-0001eaf0: 2020 2020 2065 7272 6f72 5f6d 6573 7361       error_messa
-0001eb00: 6765 203d 2022 4172 6773 206c 6f73 5f6c  ge = "Args los_l
-0001eb10: 696d 7320 7368 6f75 6c64 2068 6176 6520  ims should have 
-0001eb20: 6469 6d20 3120 3d20 6e6c 6f73 220a 2020  dim 1 = nlos".  
-0001eb30: 2020 2020 2020 6173 7365 7274 206e 6c6f        assert nlo
-0001eb40: 7320 3d3d 2073 7a32 5f64 6c73 2c20 6572  s == sz2_dls, er
-0001eb50: 726f 725f 6d65 7373 6167 650a 2020 2020  ror_message.    
-0001eb60: 2020 2020 626f 6f6c 3120 3d20 6e6f 7420      bool1 = not 
-0001eb70: 646c 5f69 735f 6c69 7374 2061 6e64 2064  dl_is_list and d
-0001eb80: 4c20 3e20 302e 0a20 2020 2020 2020 2062  L > 0..        b
-0001eb90: 6f6f 6c32 203d 2064 6c5f 6973 5f6c 6973  ool2 = dl_is_lis
-0001eba0: 7420 616e 6420 6c65 6e28 644c 293d 3d6e  t and len(dL)==n
-0001ebb0: 6c6f 7320 616e 6420 6e70 2e61 6c6c 2864  los and np.all(d
-0001ebc0: 4c3e 302e 290a 2020 2020 2020 2020 6173  L>0.).        as
-0001ebd0: 7365 7274 2062 6f6f 6c31 206f 7220 626f  sert bool1 or bo
-0001ebe0: 6f6c 322c 2022 4172 6720 644c 206d 7573  ol2, "Arg dL mus
-0001ebf0: 7420 6265 2061 2064 6f75 626c 6520 6f72  t be a double or
-0001ec00: 2061 204c 6973 742c 2061 6e64 2064 4c20   a List, and dL 
-0001ec10: 3e30 2e21 220a 2020 2020 2020 2020 6572  >0.!".        er
-0001ec20: 726f 725f 6d65 7373 6167 6520 3d20 2241  ror_message = "A
-0001ec30: 7267 756d 656e 7420 646d 6574 686f 6420  rgument dmethod 
-0001ec40: 2864 6973 6372 6574 697a 6174 696f 6e20  (discretization 
-0001ec50: 6d65 7468 6f64 2920 7368 6f75 6c64 2062  method) should b
-0001ec60: 6520 696e 225c 0a20 2020 2020 2020 2020  e in"\.         
-0001ec70: 2020 2020 2020 2020 2020 2020 2020 202b                 +
-0001ec80: 2220 5b27 6162 7327 2c27 7265 6c27 5d2c  " ['abs','rel'],
-0001ec90: 2066 6f72 2061 6273 6f6c 7574 6520 6f72   for absolute or
-0001eca0: 2072 656c 6174 6976 652e 220a 2020 2020   relative.".    
-0001ecb0: 2020 2020 6173 7365 7274 2064 6d6f 6465      assert dmode
-0001ecc0: 2069 6e20 5b27 6162 7327 2c27 7265 6c27   in ['abs','rel'
-0001ecd0: 5d2c 2065 7272 6f72 5f6d 6573 7361 6765  ], error_message
-0001ece0: 0a20 2020 2020 2020 2065 7272 6f72 5f6d  .        error_m
-0001ecf0: 6573 7361 6765 203d 2022 5772 6f6e 6720  essage = "Wrong 
-0001ed00: 6d65 7468 6f64 206f 6620 696e 7465 6772  method of integr
-0001ed10: 6174 696f 6e2e 2220 5c0a 2020 2020 2020  ation." \.      
-0001ed20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ed30: 2020 2b20 2220 4f70 7469 6f6e 7320 6172    + " Options ar
-0001ed40: 653a 205b 2773 756d 272c 2773 696d 7073  e: ['sum','simps
-0001ed50: 272c 2772 6f6d 6227 2c20 276c 696e 7370  ','romb', 'linsp
-0001ed60: 6163 6527 5d22 0a20 2020 2020 2020 2061  ace']".        a
-0001ed70: 7373 6572 7420 696d 6f64 6520 696e 205b  ssert imode in [
-0001ed80: 2773 756d 272c 2773 696d 7073 272c 2772  'sum','simps','r
-0001ed90: 6f6d 6227 2c27 6c69 6e73 7061 6365 275d  omb','linspace']
-0001eda0: 2c20 6572 726f 725f 6d65 7373 6167 650a  , error_message.
-0001edb0: 2020 2020 2320 496e 6974 0a20 2020 2063      # Init.    c
-0001edc0: 6f65 6666 5f70 7472 203d 203c 646f 7562  oeff_ptr = <doub
-0001edd0: 6c65 2a2a 3e20 6d61 6c6c 6f63 2873 697a  le**> malloc(siz
-0001ede0: 656f 6628 646f 7562 6c65 2a29 290a 2020  eof(double*)).  
-0001edf0: 2020 6c6f 735f 696e 645f 7074 7220 3d20    los_ind_ptr = 
-0001ee00: 3c6c 6f6e 672a 3e20 6d61 6c6c 6f63 286e  <long*> malloc(n
-0001ee10: 6c6f 732a 7369 7a65 6f66 286c 6f6e 6729  los*sizeof(long)
-0001ee20: 290a 2020 2020 636f 6566 665f 7074 725b  ).    coeff_ptr[
-0001ee30: 305d 203d 204e 554c 4c0a 2020 2020 2320  0] = NULL.    # 
-0001ee40: 4765 7474 696e 6720 6e75 6d62 6572 206f  Getting number o
-0001ee50: 6620 6d6f 6465 733a 0a20 2020 206e 5f64  f modes:.    n_d
-0001ee60: 6d6f 6465 203d 205f 7374 2e67 6574 5f6e  mode = _st.get_n
-0001ee70: 625f 646d 6f64 6528 646d 6f64 6529 0a20  b_dmode(dmode). 
-0001ee80: 2020 206e 5f69 6d6f 6465 203d 205f 7374     n_imode = _st
-0001ee90: 2e67 6574 5f6e 625f 696d 6f64 6528 696d  .get_nb_imode(im
-0001eea0: 6f64 6529 0a20 2020 2023 202d 2d20 436f  ode).    # -- Co
-0001eeb0: 7265 2066 756e 6374 696f 6e73 202d 2d2d  re functions ---
-0001eec0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0001eed0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0001eee0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0001eef0: 2d2d 2d2d 2d0a 2020 2020 6966 206e 6f74  -----.    if not
-0001ef00: 2064 6c5f 6973 5f6c 6973 743a 0a20 2020   dl_is_list:.   
-0001ef10: 2020 2020 2023 2043 6173 6520 7769 7468       # Case with
-0001ef20: 2075 6e69 7175 6520 6469 7363 7265 7469   unique discreti
-0001ef30: 7a61 7469 6f6e 2073 7465 7020 644c 0a20  zation step dL. 
-0001ef40: 2020 2020 2020 2073 7a5f 636f 6566 6620         sz_coeff 
-0001ef50: 3d20 5f73 742e 6c6f 735f 6765 745f 7361  = _st.los_get_sa
-0001ef60: 6d70 6c65 5f63 6f72 655f 636f 6e73 745f  mple_core_const_
-0001ef70: 7265 7328 6e6c 6f73 2c0a 2020 2020 2020  res(nlos,.      
-0001ef80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ef90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001efa0: 2020 2020 2020 2020 2020 2020 2020 2026                 &
-0001efb0: 6c6f 735f 6c69 6d73 5b30 2c30 5d2c 0a20  los_lims[0,0],. 
+0001e1e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001e1f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001e200: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0001e210: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 6465  =============.de
+0001e220: 6620 4c4f 535f 6765 745f 7361 6d70 6c65  f LOS_get_sample
+0001e230: 2869 6e74 206e 6c6f 732c 2064 4c2c 2064  (int nlos, dL, d
+0001e240: 6f75 626c 655b 3a2c 3a3a 315d 206c 6f73  ouble[:,::1] los
+0001e250: 5f6c 696d 732c 2073 7472 2064 6d65 7468  _lims, str dmeth
+0001e260: 6f64 3d27 6162 7327 2c0a 2020 2020 2020  od='abs',.      
+0001e270: 2020 2020 2020 2020 2020 2020 2073 7472               str
+0001e280: 206d 6574 686f 643d 2773 756d 272c 2062   method='sum', b
+0001e290: 696e 7420 5465 7374 3d54 7275 652c 2069  int Test=True, i
+0001e2a0: 6e74 206e 756d 5f74 6872 6561 6473 3d31  nt num_threads=1
+0001e2b0: 3629 3a0a 2020 2020 2222 220a 2020 2020  6):.    """.    
+0001e2c0: 5265 7475 726e 2074 6865 2073 616d 706c  Return the sampl
+0001e2d0: 6564 206c 696e 652c 2077 6974 6820 7468  ed line, with th
+0001e2e0: 6520 7370 6563 6966 6965 6420 6d65 7468  e specified meth
+0001e2f0: 6f64 0a20 2020 202d 2020 2027 7375 6d27  od.    -   'sum'
+0001e300: 203a 2020 2020 2072 6574 7572 6e20 4e20   :     return N 
+0001e310: 7365 676d 656e 7473 2063 656e 7465 7273  segments centers
+0001e320: 0a20 2020 202d 2020 2027 7369 6d70 7327  .    -   'simps'
+0001e330: 3a20 2020 2072 6574 7572 6e20 4e2b 3120  :    return N+1 
+0001e340: 6567 6465 732c 204e 2065 7665 6e20 2866  egdes, N even (f
+0001e350: 6f72 2073 6369 7079 2e69 6e74 6567 7261  or scipy.integra
+0001e360: 7465 2e73 696d 7073 290a 2020 2020 2d20  te.simps).    - 
+0001e370: 2020 2772 6f6d 6227 203a 2020 2020 7265    'romb' :    re
+0001e380: 7475 726e 204e 2b31 2065 6467 6573 2c20  turn N+1 edges, 
+0001e390: 4e2b 3120 3d20 322a 2a6b 2b31 2028 666f  N+1 = 2**k+1 (fo
+0001e3a0: 7220 7363 6970 792e 696e 7465 6772 6174  r scipy.integrat
+0001e3b0: 652e 726f 6d62 290a 2020 2020 2020 5468  e.romb).      Th
+0001e3c0: 6520 646d 6574 686f 6420 6465 6669 6e65  e dmethod define
+0001e3d0: 7320 6966 2074 6865 2064 6973 6372 6574  s if the discret
+0001e3e0: 697a 6174 696f 6e20 7374 6570 2067 6976  ization step giv
+0001e3f0: 656e 2069 7320 6162 736f 6c75 7465 2028  en is absolute (
+0001e400: 2761 6273 2729 0a20 2020 2020 206f 7220  'abs').      or 
+0001e410: 7265 6c61 7469 7665 2028 2772 656c 2729  relative ('rel')
+0001e420: 0a20 2020 2050 6172 616d 730a 2020 2020  .    Params.    
+0001e430: 3d3d 3d3d 3d3d 0a20 2020 2064 4c3a 2064  ======.    dL: d
+0001e440: 6f75 626c 6520 6f72 206c 6973 7420 6f66  ouble or list of
+0001e450: 2064 6f75 626c 6573 0a20 2020 2020 2020   doubles.       
+0001e460: 2049 6620 644c 2069 7320 6120 7369 6e67   If dL is a sing
+0001e470: 6c65 2064 6f75 626c 653a 2064 6973 6372  le double: discr
+0001e480: 6574 697a 6174 696f 6e20 7374 6570 2066  etization step f
+0001e490: 6f72 2061 6c6c 204c 4f53 2e0a 2020 2020  or all LOS..    
+0001e4a0: 2020 2020 456c 7365 2064 4c20 7368 6f75      Else dL shou
+0001e4b0: 6c64 2062 6520 6120 6c69 7374 206f 6620  ld be a list of 
+0001e4c0: 7369 7a65 206e 6c6f 7320 7769 7468 2074  size nlos with t
+0001e4d0: 6865 2064 6973 6372 6574 697a 6174 696f  he discretizatio
+0001e4e0: 6e0a 2020 2020 2020 2020 7374 6570 2066  n.        step f
+0001e4f0: 6f72 2065 6163 6820 6e6c 6f73 2e0a 2020  or each nlos..  
+0001e500: 2020 6c6f 735f 6c69 6d73 3a20 2832 2c20    los_lims: (2, 
+0001e510: 6e6c 6f73 2920 646f 7562 6c65 2061 7272  nlos) double arr
+0001e520: 6179 0a20 2020 2020 2020 2046 6f72 2065  ay.        For e
+0001e530: 6163 6820 6e6c 6f73 2c20 6974 2067 6976  ach nlos, it giv
+0001e540: 656e 2074 6865 206d 6178 696d 756d 2061  en the maximum a
+0001e550: 6e64 206d 696e 696d 756d 206c 696d 6974  nd minimum limit
+0001e560: 7320 6f66 2074 6865 2072 6179 0a20 2020  s of the ray.   
+0001e570: 2064 6d65 7468 6f64 3a20 7374 7269 6e67   dmethod: string
+0001e580: 0a20 2020 2020 2020 2074 7970 6520 6f66  .        type of
+0001e590: 2064 6973 6372 6574 697a 6174 696f 6e20   discretization 
+0001e5a0: 7374 6570 3a20 2761 6273 2720 666f 7220  step: 'abs' for 
+0001e5b0: 6162 736f 6c75 7465 206f 7220 2772 656c  absolute or 'rel
+0001e5c0: 2720 666f 7220 7265 6c61 7469 7665 0a20  ' for relative. 
+0001e5d0: 2020 206d 6574 686f 643a 2073 7472 696e     method: strin
+0001e5e0: 670a 2020 2020 2020 2020 6d65 7468 6f64  g.        method
+0001e5f0: 206f 6620 7175 6164 7261 7475 7265 206f   of quadrature o
+0001e600: 6e20 7468 6520 4c4f 530a 2020 2020 5465  n the LOS.    Te
+0001e610: 7374 3a20 626f 6f6c 0a20 2020 2020 2020  st: bool.       
+0001e620: 2074 6f20 696e 6469 6361 7465 2069 6620   to indicate if 
+0001e630: 7465 7374 7320 7368 6f75 6c64 2062 6520  tests should be 
+0001e640: 646f 6e65 206f 7220 6e6f 740a 0a20 2020  done or not..   
+0001e650: 2048 6f77 2074 6f20 7265 636f 6d70 7574   How to recomput
+0001e660: 6520 506f 696e 7473 2063 6f6f 7264 696e  e Points coordin
+0001e670: 6174 6573 2066 726f 6d20 7265 7375 6c74  ates from result
+0001e680: 730a 2020 2020 2d2d 2d2d 2d2d 2d0a 2020  s.    -------.  
+0001e690: 2020 6b2c 2072 6573 2c20 6c69 6e64 203d    k, res, lind =
+0001e6a0: 204c 6f73 5f67 6574 5f73 616d 706c 6528   Los_get_sample(
+0001e6b0: 2e2e 2e29 0a20 2020 206e 6272 6570 6574  ...).    nbrepet
+0001e6c0: 203d 206e 702e 725f 5b6c 696e 645b 305d   = np.r_[lind[0]
+0001e6d0: 2c20 6e70 2e64 6966 6628 6c69 6e64 292c  , np.diff(lind),
+0001e6e0: 206b 2e73 697a 6520 2d20 6c69 6e64 5b2d   k.size - lind[-
+0001e6f0: 315d 5d0a 2020 2020 6b75 7320 3d20 6b20  1]].    kus = k 
+0001e700: 2a20 6e70 2e72 6570 6561 7428 7261 795f  * np.repeat(ray_
+0001e710: 7664 6972 2c20 6e62 7265 7065 742c 2061  vdir, nbrepet, a
+0001e720: 7869 733d 3129 0a20 2020 2050 7473 203d  xis=1).    Pts =
+0001e730: 206e 702e 7265 7065 6174 2872 6179 5f6f   np.repeat(ray_o
+0001e740: 7269 672c 206e 6272 6570 6574 2c20 6178  rig, nbrepet, ax
+0001e750: 6973 3d31 2920 2b20 6b75 730a 2020 2020  is=1) + kus.    
+0001e760: 2222 220a 2020 2020 6364 6566 2073 7472  """.    cdef str
+0001e770: 2065 7272 6f72 5f6d 6573 7361 6765 0a20   error_message. 
+0001e780: 2020 2063 6465 6620 7374 7220 646d 6f64     cdef str dmod
+0001e790: 6520 3d20 646d 6574 686f 642e 6c6f 7765  e = dmethod.lowe
+0001e7a0: 7228 290a 2020 2020 6364 6566 2073 7472  r().    cdef str
+0001e7b0: 2069 6d6f 6465 203d 206d 6574 686f 642e   imode = method.
+0001e7c0: 6c6f 7765 7228 290a 2020 2020 6364 6566  lower().    cdef
+0001e7d0: 2069 6e74 2073 7a31 5f64 6c73 2c20 737a   int sz1_dls, sz
+0001e7e0: 325f 646c 730a 2020 2020 6364 6566 2069  2_dls.    cdef i
+0001e7f0: 6e74 2073 7a5f 636f 6566 660a 2020 2020  nt sz_coeff.    
+0001e800: 6364 6566 2069 6e74 206e 5f69 6d6f 6465  cdef int n_imode
+0001e810: 2c20 6e5f 646d 6f64 650a 2020 2020 6364  , n_dmode.    cd
+0001e820: 6566 2062 696e 7420 646c 5f69 735f 6c69  ef bint dl_is_li
+0001e830: 7374 0a20 2020 2063 6465 6620 6269 6e74  st.    cdef bint
+0001e840: 2062 6f6f 6c31 2c20 626f 6f6c 320a 2020   bool1, bool2.  
+0001e850: 2020 6364 6566 2064 6f75 626c 655b 3a3a    cdef double[::
+0001e860: 315d 2064 6c5f 7669 6577 0a20 2020 2063  1] dl_view.    c
+0001e870: 6465 6620 6e70 2e6e 6461 7272 6179 5b64  def np.ndarray[d
+0001e880: 6f75 626c 652c 6e64 696d 3d31 5d20 644c  ouble,ndim=1] dL
+0001e890: 720a 2020 2020 6364 6566 206e 702e 6e64  r.    cdef np.nd
+0001e8a0: 6172 7261 795b 646f 7562 6c65 2c6e 6469  array[double,ndi
+0001e8b0: 6d3d 315d 2063 6f65 6666 5f61 7272 0a20  m=1] coeff_arr. 
+0001e8c0: 2020 2063 6465 6620 6e70 2e6e 6461 7272     cdef np.ndarr
+0001e8d0: 6179 5b6c 6f6e 672c 6e64 696d 3d31 5d20  ay[long,ndim=1] 
+0001e8e0: 6c6f 735f 696e 640a 2020 2020 6364 6566  los_ind.    cdef
+0001e8f0: 206c 6f6e 672a 2074 6d70 5f61 7272 0a20   long* tmp_arr. 
+0001e900: 2020 2063 6465 6620 646f 7562 6c65 2a20     cdef double* 
+0001e910: 6c6f 735f 636f 6566 6673 203d 204e 554c  los_coeffs = NUL
+0001e920: 4c0a 2020 2020 6364 6566 2064 6f75 626c  L.    cdef doubl
+0001e930: 652a 2a20 636f 6566 665f 7074 7220 3d20  e** coeff_ptr = 
+0001e940: 4e55 4c4c 0a20 2020 2063 6465 6620 6c6f  NULL.    cdef lo
+0001e950: 6e67 2a20 6c6f 735f 696e 645f 7074 7220  ng* los_ind_ptr 
+0001e960: 3d20 4e55 4c4c 0a20 2020 2023 202e 2e20  = NULL.    # .. 
+0001e970: 7261 795f 6f72 6967 2073 6861 7065 206e  ray_orig shape n
+0001e980: 6565 6465 6420 666f 7220 7465 7374 696e  eeded for testin
+0001e990: 6720 616e 6420 696e 2061 6c67 6f20 2e2e  g and in algo ..
+0001e9a0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+0001e9b0: 2e2e 2e2e 2e2e 2e0a 2020 2020 644c 7220  ........    dLr 
+0001e9c0: 3d20 6e70 2e7a 6572 6f73 2828 6e6c 6f73  = np.zeros((nlos
+0001e9d0: 2c29 2c20 6474 7970 653d 666c 6f61 7429  ,), dtype=float)
+0001e9e0: 0a20 2020 206c 6f73 5f69 6e64 203d 206e  .    los_ind = n
+0001e9f0: 702e 7a65 726f 7328 286e 6c6f 732c 292c  p.zeros((nlos,),
+0001ea00: 2064 7479 7065 3d69 6e74 290a 2020 2020   dtype=int).    
+0001ea10: 646c 5f69 735f 6c69 7374 203d 2068 6173  dl_is_list = has
+0001ea20: 6174 7472 2864 4c2c 2027 5f5f 6974 6572  attr(dL, '__iter
+0001ea30: 5f5f 2729 0a20 2020 2023 202e 2e20 7665  __').    # .. ve
+0001ea40: 7269 6679 696e 6720 6172 6775 6d65 6e74  rifying argument
+0001ea50: 7320 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  s ..............
+0001ea60: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+0001ea70: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+0001ea80: 2e2e 2e2e 2e0a 2020 2020 6966 2054 6573  ......    if Tes
+0001ea90: 743a 0a20 2020 2020 2020 2073 7a31 5f64  t:.        sz1_d
+0001eaa0: 6c73 203d 206c 6f73 5f6c 696d 732e 7368  ls = los_lims.sh
+0001eab0: 6170 655b 305d 0a20 2020 2020 2020 2073  ape[0].        s
+0001eac0: 7a32 5f64 6c73 203d 206c 6f73 5f6c 696d  z2_dls = los_lim
+0001ead0: 732e 7368 6170 655b 315d 0a20 2020 2020  s.shape[1].     
+0001eae0: 2020 2061 7373 6572 7420 737a 315f 646c     assert sz1_dl
+0001eaf0: 7320 3d3d 2032 2c20 2244 696d 2030 206f  s == 2, "Dim 0 o
+0001eb00: 6620 6172 6720 6c6f 735f 6c69 6d73 2073  f arg los_lims s
+0001eb10: 686f 756c 6420 6265 2032 220a 2020 2020  hould be 2".    
+0001eb20: 2020 2020 6572 726f 725f 6d65 7373 6167      error_messag
+0001eb30: 6520 3d20 2241 7267 7320 6c6f 735f 6c69  e = "Args los_li
+0001eb40: 6d73 2073 686f 756c 6420 6861 7665 2064  ms should have d
+0001eb50: 696d 2031 203d 206e 6c6f 7322 0a20 2020  im 1 = nlos".   
+0001eb60: 2020 2020 2061 7373 6572 7420 6e6c 6f73       assert nlos
+0001eb70: 203d 3d20 737a 325f 646c 732c 2065 7272   == sz2_dls, err
+0001eb80: 6f72 5f6d 6573 7361 6765 0a20 2020 2020  or_message.     
+0001eb90: 2020 2062 6f6f 6c31 203d 206e 6f74 2064     bool1 = not d
+0001eba0: 6c5f 6973 5f6c 6973 7420 616e 6420 644c  l_is_list and dL
+0001ebb0: 203e 2030 2e0a 2020 2020 2020 2020 626f   > 0..        bo
+0001ebc0: 6f6c 3220 3d20 646c 5f69 735f 6c69 7374  ol2 = dl_is_list
+0001ebd0: 2061 6e64 206c 656e 2864 4c29 3d3d 6e6c   and len(dL)==nl
+0001ebe0: 6f73 2061 6e64 206e 702e 616c 6c28 644c  os and np.all(dL
+0001ebf0: 3e30 2e29 0a20 2020 2020 2020 2061 7373  >0.).        ass
+0001ec00: 6572 7420 626f 6f6c 3120 6f72 2062 6f6f  ert bool1 or boo
+0001ec10: 6c32 2c20 2241 7267 2064 4c20 6d75 7374  l2, "Arg dL must
+0001ec20: 2062 6520 6120 646f 7562 6c65 206f 7220   be a double or 
+0001ec30: 6120 4c69 7374 2c20 616e 6420 644c 203e  a List, and dL >
+0001ec40: 302e 2122 0a20 2020 2020 2020 2065 7272  0.!".        err
+0001ec50: 6f72 5f6d 6573 7361 6765 203d 2022 4172  or_message = "Ar
+0001ec60: 6775 6d65 6e74 2064 6d65 7468 6f64 2028  gument dmethod (
+0001ec70: 6469 7363 7265 7469 7a61 7469 6f6e 206d  discretization m
+0001ec80: 6574 686f 6429 2073 686f 756c 6420 6265  ethod) should be
+0001ec90: 2069 6e22 5c0a 2020 2020 2020 2020 2020   in"\.          
+0001eca0: 2020 2020 2020 2020 2020 2020 2020 2b22                +"
+0001ecb0: 205b 2761 6273 272c 2772 656c 275d 2c20   ['abs','rel'], 
+0001ecc0: 666f 7220 6162 736f 6c75 7465 206f 7220  for absolute or 
+0001ecd0: 7265 6c61 7469 7665 2e22 0a20 2020 2020  relative.".     
+0001ece0: 2020 2061 7373 6572 7420 646d 6f64 6520     assert dmode 
+0001ecf0: 696e 205b 2761 6273 272c 2772 656c 275d  in ['abs','rel']
+0001ed00: 2c20 6572 726f 725f 6d65 7373 6167 650a  , error_message.
+0001ed10: 2020 2020 2020 2020 6572 726f 725f 6d65          error_me
+0001ed20: 7373 6167 6520 3d20 2257 726f 6e67 206d  ssage = "Wrong m
+0001ed30: 6574 686f 6420 6f66 2069 6e74 6567 7261  ethod of integra
+0001ed40: 7469 6f6e 2e22 205c 0a20 2020 2020 2020  tion." \.       
+0001ed50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ed60: 202b 2022 204f 7074 696f 6e73 2061 7265   + " Options are
+0001ed70: 3a20 5b27 7375 6d27 2c27 7369 6d70 7327  : ['sum','simps'
+0001ed80: 2c27 726f 6d62 272c 2027 6c69 6e73 7061  ,'romb', 'linspa
+0001ed90: 6365 275d 220a 2020 2020 2020 2020 6173  ce']".        as
+0001eda0: 7365 7274 2069 6d6f 6465 2069 6e20 5b27  sert imode in ['
+0001edb0: 7375 6d27 2c27 7369 6d70 7327 2c27 726f  sum','simps','ro
+0001edc0: 6d62 272c 276c 696e 7370 6163 6527 5d2c  mb','linspace'],
+0001edd0: 2065 7272 6f72 5f6d 6573 7361 6765 0a20   error_message. 
+0001ede0: 2020 2023 2049 6e69 740a 2020 2020 636f     # Init.    co
+0001edf0: 6566 665f 7074 7220 3d20 3c64 6f75 626c  eff_ptr = <doubl
+0001ee00: 652a 2a3e 206d 616c 6c6f 6328 7369 7a65  e**> malloc(size
+0001ee10: 6f66 2864 6f75 626c 652a 2929 0a20 2020  of(double*)).   
+0001ee20: 206c 6f73 5f69 6e64 5f70 7472 203d 203c   los_ind_ptr = <
+0001ee30: 6c6f 6e67 2a3e 206d 616c 6c6f 6328 6e6c  long*> malloc(nl
+0001ee40: 6f73 2a73 697a 656f 6628 6c6f 6e67 2929  os*sizeof(long))
+0001ee50: 0a20 2020 2063 6f65 6666 5f70 7472 5b30  .    coeff_ptr[0
+0001ee60: 5d20 3d20 4e55 4c4c 0a20 2020 2023 2047  ] = NULL.    # G
+0001ee70: 6574 7469 6e67 206e 756d 6265 7220 6f66  etting number of
+0001ee80: 206d 6f64 6573 3a0a 2020 2020 6e5f 646d   modes:.    n_dm
+0001ee90: 6f64 6520 3d20 5f73 742e 6765 745f 6e62  ode = _st.get_nb
+0001eea0: 5f64 6d6f 6465 2864 6d6f 6465 290a 2020  _dmode(dmode).  
+0001eeb0: 2020 6e5f 696d 6f64 6520 3d20 5f73 742e    n_imode = _st.
+0001eec0: 6765 745f 6e62 5f69 6d6f 6465 2869 6d6f  get_nb_imode(imo
+0001eed0: 6465 290a 2020 2020 2320 2d2d 2043 6f72  de).    # -- Cor
+0001eee0: 6520 6675 6e63 7469 6f6e 7320 2d2d 2d2d  e functions ----
+0001eef0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0001ef00: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0001ef10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0001ef20: 2d2d 2d2d 0a20 2020 2069 6620 6e6f 7420  ----.    if not 
+0001ef30: 646c 5f69 735f 6c69 7374 3a0a 2020 2020  dl_is_list:.    
+0001ef40: 2020 2020 2320 4361 7365 2077 6974 6820      # Case with 
+0001ef50: 756e 6971 7565 2064 6973 6372 6574 697a  unique discretiz
+0001ef60: 6174 696f 6e20 7374 6570 2064 4c0a 2020  ation step dL.  
+0001ef70: 2020 2020 2020 737a 5f63 6f65 6666 203d        sz_coeff =
+0001ef80: 205f 7374 2e6c 6f73 5f67 6574 5f73 616d   _st.los_get_sam
+0001ef90: 706c 655f 636f 7265 5f63 6f6e 7374 5f72  ple_core_const_r
+0001efa0: 6573 286e 6c6f 732c 0a20 2020 2020 2020  es(nlos,.       
+0001efb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001efc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001efd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001efe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001eff0: 2020 2020 266c 6f73 5f6c 696d 735b 312c      &los_lims[1,
-0001f000: 305d 2c0a 2020 2020 2020 2020 2020 2020  0],.            
+0001efd0: 2020 2020 2020 2020 2020 2020 2020 266c                &l
+0001efe0: 6f73 5f6c 696d 735b 302c 305d 2c0a 2020  os_lims[0,0],.  
+0001eff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f000: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001f010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f030: 2020 2020 2020 2020 206e 5f64 6d6f 6465           n_dmode
-0001f040: 2c20 6e5f 696d 6f64 652c 0a20 2020 2020  , n_imode,.     
+0001f020: 2020 2026 6c6f 735f 6c69 6d73 5b31 2c30     &los_lims[1,0
+0001f030: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+0001f040: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001f050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f080: 3c64 6f75 626c 653e 644c 2c0a 2020 2020  <double>dL,.    
+0001f060: 2020 2020 2020 2020 6e5f 646d 6f64 652c          n_dmode,
+0001f070: 206e 5f69 6d6f 6465 2c0a 2020 2020 2020   n_imode,.      
+0001f080: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001f090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f0c0: 2026 636f 6566 665f 7074 725b 305d 2c0a   &coeff_ptr[0],.
+0001f0a0: 2020 2020 2020 2020 2020 2020 2020 203c                 <
+0001f0b0: 646f 7562 6c65 3e64 4c2c 0a20 2020 2020  double>dL,.     
+0001f0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001f0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001f0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f100: 2020 2020 2026 644c 725b 305d 2c0a 2020       &dLr[0],.  
+0001f0f0: 2663 6f65 6666 5f70 7472 5b30 5d2c 0a20  &coeff_ptr[0],. 
+0001f100: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001f110: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001f120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f140: 2020 2026 6c6f 735f 696e 645f 7074 725b     &los_ind_ptr[
-0001f150: 305d 2c0a 2020 2020 2020 2020 2020 2020  0],.            
+0001f130: 2020 2020 2664 4c72 5b30 5d2c 0a20 2020      &dLr[0],.   
+0001f140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f150: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001f160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f180: 2020 2020 2020 2020 206e 756d 5f74 6872           num_thr
-0001f190: 6561 6473 290a 2020 2020 656c 7365 3a0a  eads).    else:.
-0001f1a0: 2020 2020 2020 2020 2320 4361 7365 2077          # Case w
-0001f1b0: 6974 6820 6469 6666 6572 656e 7420 7265  ith different re
-0001f1c0: 736f 6c75 7469 6f6e 2066 6f72 2065 6163  solution for eac
-0001f1d0: 6820 4c4f 530a 2020 2020 2020 2020 646c  h LOS.        dl
-0001f1e0: 5f76 6965 773d 644c 0a20 2020 2020 2020  _view=dL.       
-0001f1f0: 205f 7374 2e6c 6f73 5f67 6574 5f73 616d   _st.los_get_sam
-0001f200: 706c 655f 636f 7265 5f76 6172 5f72 6573  ple_core_var_res
-0001f210: 286e 6c6f 732c 0a20 2020 2020 2020 2020  (nlos,.         
-0001f220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f230: 2020 2020 2020 2020 2020 2020 2020 2026                 &
-0001f240: 6c6f 735f 6c69 6d73 5b30 2c30 5d2c 0a20  los_lims[0,0],. 
+0001f170: 2020 266c 6f73 5f69 6e64 5f70 7472 5b30    &los_ind_ptr[0
+0001f180: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+0001f190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f1b0: 2020 2020 2020 2020 6e75 6d5f 7468 7265          num_thre
+0001f1c0: 6164 7329 0a20 2020 2065 6c73 653a 0a20  ads).    else:. 
+0001f1d0: 2020 2020 2020 2023 2043 6173 6520 7769         # Case wi
+0001f1e0: 7468 2064 6966 6665 7265 6e74 2072 6573  th different res
+0001f1f0: 6f6c 7574 696f 6e20 666f 7220 6561 6368  olution for each
+0001f200: 204c 4f53 0a20 2020 2020 2020 2064 6c5f   LOS.        dl_
+0001f210: 7669 6577 3d64 4c0a 2020 2020 2020 2020  view=dL.        
+0001f220: 5f73 742e 6c6f 735f 6765 745f 7361 6d70  _st.los_get_samp
+0001f230: 6c65 5f63 6f72 655f 7661 725f 7265 7328  le_core_var_res(
+0001f240: 6e6c 6f73 2c0a 2020 2020 2020 2020 2020  nlos,.          
 0001f250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f270: 2020 2020 2020 2026 6c6f 735f 6c69 6d73         &los_lims
-0001f280: 5b31 2c30 5d2c 0a20 2020 2020 2020 2020  [1,0],.         
+0001f260: 2020 2020 2020 2020 2020 2020 2020 266c                &l
+0001f270: 6f73 5f6c 696d 735b 302c 305d 2c0a 2020  os_lims[0,0],.  
+0001f280: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001f290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f2a0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0001f2b0: 5f64 6d6f 6465 2c20 6e5f 696d 6f64 652c  _dmode, n_imode,
-0001f2c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f2e0: 2020 2020 2020 2020 2026 646c 5f76 6965           &dl_vie
-0001f2f0: 775b 305d 2c0a 2020 2020 2020 2020 2020  w[0],.          
+0001f2a0: 2020 2020 2020 266c 6f73 5f6c 696d 735b        &los_lims[
+0001f2b0: 312c 305d 2c0a 2020 2020 2020 2020 2020  1,0],.          
+0001f2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f2d0: 2020 2020 2020 2020 2020 2020 2020 6e5f                n_
+0001f2e0: 646d 6f64 652c 206e 5f69 6d6f 6465 2c0a  dmode, n_imode,.
+0001f2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001f300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f310: 2020 2020 2020 2020 2020 2020 2020 2663                &c
-0001f320: 6f65 6666 5f70 7472 5b30 5d2c 0a20 2020  oeff_ptr[0],.   
+0001f310: 2020 2020 2020 2020 2664 6c5f 7669 6577          &dl_view
+0001f320: 5b30 5d2c 0a20 2020 2020 2020 2020 2020  [0],.           
 0001f330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f350: 2020 2020 2026 644c 725b 305d 2c0a 2020       &dLr[0],.  
+0001f340: 2020 2020 2020 2020 2020 2020 2026 636f               &co
+0001f350: 6566 665f 7074 725b 305d 2c0a 2020 2020  eff_ptr[0],.    
 0001f360: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001f370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f380: 2020 2020 2020 266c 6f73 5f69 6e64 5f70        &los_ind_p
-0001f390: 7472 5b30 5d2c 0a20 2020 2020 2020 2020  tr[0],.         
+0001f380: 2020 2020 2664 4c72 5b30 5d2c 0a20 2020      &dLr[0],.   
+0001f390: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001f3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f3b0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0001f3c0: 756d 5f74 6872 6561 6473 290a 2020 2020  um_threads).    
-0001f3d0: 2020 2020 737a 5f63 6f65 6666 203d 206c      sz_coeff = l
-0001f3e0: 6f73 5f69 6e64 5f70 7472 5b6e 6c6f 732d  os_ind_ptr[nlos-
-0001f3f0: 315d 0a20 2020 2063 6f65 6666 7320 203d  1].    coeffs  =
-0001f400: 206e 702e 636f 7079 286e 702e 6173 6172   np.copy(np.asar
-0001f410: 7261 7928 3c64 6f75 626c 655b 3a73 7a5f  ray(<double[:sz_
-0001f420: 636f 6566 665d 3e63 6f65 6666 5f70 7472  coeff]>coeff_ptr
-0001f430: 5b30 5d29 290a 2020 2020 696e 6469 6365  [0])).    indice
-0001f440: 7320 3d20 6e70 2e63 6f70 7928 6e70 2e61  s = np.copy(np.a
-0001f450: 7361 7272 6179 283c 6c6f 6e67 5b3a 6e6c  sarray(<long[:nl
-0001f460: 6f73 5d3e 6c6f 735f 696e 645f 7074 7229  os]>los_ind_ptr)
-0001f470: 2e61 7374 7970 6528 696e 7429 290a 2020  .astype(int)).  
-0001f480: 2020 2320 2d2d 2066 7265 6569 6e67 202d    # -- freeing -
-0001f490: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0001f4a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0001f4b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0001f4c0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2069  ----------.    i
-0001f4d0: 6620 6e6f 7420 6c6f 735f 696e 645f 7074  f not los_ind_pt
-0001f4e0: 7220 3d3d 204e 554c 4c3a 0a20 2020 2020  r == NULL:.     
-0001f4f0: 2020 2066 7265 6528 6c6f 735f 696e 645f     free(los_ind_
-0001f500: 7074 7229 0a20 2020 2069 6620 6e6f 7420  ptr).    if not 
-0001f510: 636f 6566 665f 7074 7220 3d3d 204e 554c  coeff_ptr == NUL
-0001f520: 4c3a 0a20 2020 2020 2020 2069 6620 6e6f  L:.        if no
-0001f530: 7420 636f 6566 665f 7074 725b 305d 203d  t coeff_ptr[0] =
-0001f540: 3d20 4e55 4c4c 3a0a 2020 2020 2020 2020  = NULL:.        
-0001f550: 2020 2020 6672 6565 2863 6f65 6666 5f70      free(coeff_p
-0001f560: 7472 5b30 5d29 0a20 2020 2020 2020 2066  tr[0]).        f
-0001f570: 7265 6528 636f 6566 665f 7074 7229 0a20  ree(coeff_ptr). 
-0001f580: 2020 2072 6574 7572 6e20 636f 6566 6673     return coeffs
-0001f590: 2c20 644c 722c 2069 6e64 6963 6573 5b3a  , dLr, indices[:
-0001f5a0: 6e6c 6f73 2d31 5d0a 0a0a 0a23 2323 2323  nlos-1]....#####
-0001f5b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001f5c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001f5d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001f3b0: 2020 2020 2026 6c6f 735f 696e 645f 7074       &los_ind_pt
+0001f3c0: 725b 305d 2c0a 2020 2020 2020 2020 2020  r[0],.          
+0001f3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f3e0: 2020 2020 2020 2020 2020 2020 2020 6e75                nu
+0001f3f0: 6d5f 7468 7265 6164 7329 0a20 2020 2020  m_threads).     
+0001f400: 2020 2073 7a5f 636f 6566 6620 3d20 6c6f     sz_coeff = lo
+0001f410: 735f 696e 645f 7074 725b 6e6c 6f73 2d31  s_ind_ptr[nlos-1
+0001f420: 5d0a 2020 2020 636f 6566 6673 2020 3d20  ].    coeffs  = 
+0001f430: 6e70 2e63 6f70 7928 6e70 2e61 7361 7272  np.copy(np.asarr
+0001f440: 6179 283c 646f 7562 6c65 5b3a 737a 5f63  ay(<double[:sz_c
+0001f450: 6f65 6666 5d3e 636f 6566 665f 7074 725b  oeff]>coeff_ptr[
+0001f460: 305d 2929 0a20 2020 2069 6e64 6963 6573  0])).    indices
+0001f470: 203d 206e 702e 636f 7079 286e 702e 6173   = np.copy(np.as
+0001f480: 6172 7261 7928 3c6c 6f6e 675b 3a6e 6c6f  array(<long[:nlo
+0001f490: 735d 3e6c 6f73 5f69 6e64 5f70 7472 292e  s]>los_ind_ptr).
+0001f4a0: 6173 7479 7065 2869 6e74 2929 0a20 2020  astype(int)).   
+0001f4b0: 2023 202d 2d20 6672 6565 696e 6720 2d2d   # -- freeing --
+0001f4c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0001f4d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0001f4e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0001f4f0: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 6966  ---------.    if
+0001f500: 206e 6f74 206c 6f73 5f69 6e64 5f70 7472   not los_ind_ptr
+0001f510: 203d 3d20 4e55 4c4c 3a0a 2020 2020 2020   == NULL:.      
+0001f520: 2020 6672 6565 286c 6f73 5f69 6e64 5f70    free(los_ind_p
+0001f530: 7472 290a 2020 2020 6966 206e 6f74 2063  tr).    if not c
+0001f540: 6f65 6666 5f70 7472 203d 3d20 4e55 4c4c  oeff_ptr == NULL
+0001f550: 3a0a 2020 2020 2020 2020 6966 206e 6f74  :.        if not
+0001f560: 2063 6f65 6666 5f70 7472 5b30 5d20 3d3d   coeff_ptr[0] ==
+0001f570: 204e 554c 4c3a 0a20 2020 2020 2020 2020   NULL:.         
+0001f580: 2020 2066 7265 6528 636f 6566 665f 7074     free(coeff_pt
+0001f590: 725b 305d 290a 2020 2020 2020 2020 6672  r[0]).        fr
+0001f5a0: 6565 2863 6f65 6666 5f70 7472 290a 2020  ee(coeff_ptr).  
+0001f5b0: 2020 7265 7475 726e 2063 6f65 6666 732c    return coeffs,
+0001f5c0: 2064 4c72 2c20 696e 6469 6365 735b 3a6e   dLr, indices[:n
+0001f5d0: 6c6f 732d 315d 0a0a 0a0a 2323 2323 2323  los-1]....######
 0001f5e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001f5f0: 230a 2320 2020 2020 2020 2020 2020 2020  #.#             
-0001f600: 2020 5369 676e 616c 2063 616c 6375 6c61    Signal calcula
-0001f610: 7469 6f6e 0a23 2323 2323 2323 2323 2323  tion.###########
-0001f620: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001f630: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001f640: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001f650: 2323 2323 2323 2323 2323 230a 0a64 6566  ###########..def
-0001f660: 2069 6e74 6567 7261 7465 3164 2879 2c20   integrate1d(y, 
-0001f670: 646f 7562 6c65 2064 782c 2074 3d4e 6f6e  double dx, t=Non
-0001f680: 652c 2073 7472 206d 6574 686f 643d 2773  e, str method='s
-0001f690: 756d 2729 3a0a 2020 2020 2222 2220 4765  um'):.    """ Ge
-0001f6a0: 6e65 7269 6320 696e 7465 6772 6174 696f  neric integratio
-0001f6b0: 6e20 6d65 7468 6f64 205b 2773 756d 272c  n method ['sum',
-0001f6c0: 2773 696d 7073 272c 2772 6f6d 6227 5d0a  'simps','romb'].
-0001f6d0: 0a20 2020 2020 2020 204e 6f74 2075 7365  .        Not use
-0001f6e0: 6420 696e 7465 726e 616c 6c79 0a20 2020  d internally.   
-0001f6f0: 2020 2020 2055 7365 6675 6c20 7768 656e       Useful when
-0001f700: 2074 6865 2073 616d 706c 696e 6720 706f   the sampling po
-0001f710: 696e 7473 206e 6565 6420 746f 2062 6520  ints need to be 
-0001f720: 696e 7465 7270 6f6c 6174 6564 2076 6961  interpolated via
-0001f730: 2065 7175 696c 6962 7269 756d 0a20 2020   equilibrium.   
-0001f740: 2022 2222 0a20 2020 2063 6465 6620 756e   """.    cdef un
-0001f750: 7369 676e 6564 2069 6e74 206e 742c 2061  signed int nt, a
-0001f760: 786d 0a20 2020 2069 6620 7420 6973 204e  xm.    if t is N
-0001f770: 6f6e 6520 6f72 206e 6f74 2068 6173 6174  one or not hasat
-0001f780: 7472 2874 2c27 5f5f 6974 6572 5f5f 2729  tr(t,'__iter__')
-0001f790: 3a0a 2020 2020 2020 2020 6e74 203d 2031  :.        nt = 1
-0001f7a0: 0a20 2020 2020 2020 2061 786d 203d 2030  .        axm = 0
-0001f7b0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-0001f7c0: 2020 206e 7420 3d20 6c65 6e28 7429 0a20     nt = len(t). 
-0001f7d0: 2020 2020 2020 2061 786d 203d 2031 0a20         axm = 1. 
-0001f7e0: 2020 2069 6e64 203d 206e 702e 6973 6e61     ind = np.isna
-0001f7f0: 6e28 7929 0a20 2020 2069 6620 6e70 2e61  n(y).    if np.a
-0001f800: 6e79 2869 6e64 293a 0a20 2020 2020 2020  ny(ind):.       
-0001f810: 2079 203d 2079 2e63 6f70 7928 290a 2020   y = y.copy().  
-0001f820: 2020 2020 2020 795b 696e 645d 203d 2030        y[ind] = 0
-0001f830: 2e0a 0a20 2020 2063 6465 6620 6e70 2e6e  ...    cdef np.n
-0001f840: 6461 7272 6179 5b64 6f75 626c 652c 6e64  darray[double,nd
-0001f850: 696d 3d31 5d20 7320 3d20 6e70 2e65 6d70  im=1] s = np.emp
-0001f860: 7479 2828 6e74 2c29 2c64 7479 7065 3d66  ty((nt,),dtype=f
-0001f870: 6c6f 6174 290a 0a20 2020 2069 6620 6d65  loat)..    if me
-0001f880: 7468 6f64 3d3d 2773 756d 273a 0a20 2020  thod=='sum':.   
-0001f890: 2020 2020 2073 203d 206e 702e 7375 6d28       s = np.sum(
-0001f8a0: 792c 2061 7869 733d 6178 6d29 2a64 780a  y, axis=axm)*dx.
-0001f8b0: 2020 2020 656c 6966 206d 6574 686f 643d      elif method=
-0001f8c0: 3d27 7369 6d70 7327 3a0a 2020 2020 2020  ='simps':.      
-0001f8d0: 2020 7320 3d20 7363 7069 6e74 672e 7369    s = scpintg.si
-0001f8e0: 6d70 7328 792c 2078 3d4e 6f6e 652c 2064  mps(y, x=None, d
-0001f8f0: 783d 6478 2c20 6178 6973 3d61 786d 290a  x=dx, axis=axm).
-0001f900: 2020 2020 656c 6966 206d 6574 686f 643d      elif method=
-0001f910: 3d27 726f 6d62 273a 0a20 2020 2020 2020  ='romb':.       
-0001f920: 2073 203d 2073 6370 696e 7467 2e72 6f6d   s = scpintg.rom
-0001f930: 6228 792c 2064 783d 6478 2c20 6178 6973  b(y, dx=dx, axis
-0001f940: 3d61 786d 2c20 7368 6f77 3d46 616c 7365  =axm, show=False
-0001f950: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
-0001f960: 2020 2020 7261 6973 6520 4578 6365 7074      raise Except
-0001f970: 696f 6e28 2241 7267 206d 6574 686f 6420  ion("Arg method 
-0001f980: 6d75 7374 2062 6520 696e 205b 2773 756d  must be in ['sum
-0001f990: 272c 2773 696d 7073 272c 2772 6f6d 6227  ','simps','romb'
-0001f9a0: 5d22 290a 2020 2020 7265 7475 726e 2073  ]").    return s
-0001f9b0: 0a0a 0a64 6566 204c 4f53 5f63 616c 635f  ...def LOS_calc_
-0001f9c0: 7369 676e 616c 2866 756e 632c 2064 6f75  signal(func, dou
-0001f9d0: 626c 655b 3a2c 3a3a 315d 2072 6179 5f6f  ble[:,::1] ray_o
-0001f9e0: 7269 672c 2064 6f75 626c 655b 3a2c 3a3a  rig, double[:,::
-0001f9f0: 315d 2072 6179 5f76 6469 722c 2072 6573  1] ray_vdir, res
-0001fa00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001fa10: 2020 2020 2020 646f 7562 6c65 5b3a 2c3a        double[:,:
-0001fa20: 3a31 5d20 6c69 6d73 2c20 7374 7220 646d  :1] lims, str dm
-0001fa30: 6574 686f 643d 2761 6273 272c 0a20 2020  ethod='abs',.   
-0001fa40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fa50: 2073 7472 206d 6574 686f 643d 2773 756d   str method='sum
-0001fa60: 272c 2062 696e 7420 616e 693d 4661 6c73  ', bint ani=Fals
-0001fa70: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0001fa80: 2020 2020 2020 2074 3d4e 6f6e 652c 2066         t=None, f
-0001fa90: 6b77 6461 7267 733d 7b7d 2c20 7374 7220  kwdargs={}, str 
-0001faa0: 6d69 6e69 6d69 7a65 3d27 6361 6c6c 7327  minimize='calls'
-0001fab0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001fac0: 2020 2020 2020 6269 6e74 2054 6573 743d        bint Test=
-0001fad0: 5472 7565 2c20 696e 7420 6e75 6d5f 7468  True, int num_th
-0001fae0: 7265 6164 733d 3136 293a 0a20 2020 2022  reads=16):.    "
-0001faf0: 2222 2043 6f6d 7075 7465 2074 6865 2073  "" Compute the s
-0001fb00: 796e 7468 6574 6963 2073 6967 6e61 6c2c  ynthetic signal,
-0001fb10: 206d 696e 696d 697a 696e 6720 6569 7468   minimizing eith
-0001fb20: 6572 2066 756e 6374 696f 6e20 6361 6c6c  er function call
-0001fb30: 7320 6f72 206d 656d 6f72 790a 2020 2020  s or memory.    
-0001fb40: 5061 7261 6d73 0a20 2020 203d 3d3d 3d3d  Params.    =====
-0001fb50: 0a20 2020 2066 756e 6320 3a20 7079 7468  .    func : pyth
-0001fb60: 6f6e 2066 756e 6374 696f 6e20 7374 2e20  on function st. 
-0001fb70: 6675 6e63 2870 7473 2c20 743d 4e6f 6e65  func(pts, t=None
-0001fb80: 2c20 7665 6374 3d4e 6f6e 6529 203d 3e20  , vect=None) => 
-0001fb90: 6461 7461 0a20 2020 2020 2020 2020 2020  data.           
-0001fba0: 7769 7468 2070 7473 203a 206e 6461 7272  with pts : ndarr
-0001fbb0: 6179 2028 332c 206e 7074 7329 202d 2070  ay (3, npts) - p
-0001fbc0: 6f69 6e74 7320 7768 6572 6520 6675 6e63  oints where func
-0001fbd0: 7469 6f6e 2069 7320 6576 616c 7561 7465  tion is evaluate
-0001fbe0: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
-0001fbf0: 2020 7665 6374 203a 206e 6461 7272 6179    vect : ndarray
-0001fc00: 2833 2c20 6e70 7473 2920 2d20 6966 2061  (3, npts) - if a
-0001fc10: 6e69 736f 7472 6f70 6963 2073 6967 6e61  nisotropic signa
-0001fc20: 6c20 7665 6374 6f72 206f 6620 656d 6973  l vector of emis
-0001fc30: 732e 0a20 2020 2020 2020 2020 2020 2020  s..             
-0001fc40: 2020 2074 3a20 6e64 6172 7261 7928 6d29     t: ndarray(m)
-0001fc50: 202d 2074 696d 6573 2077 6865 7265 2074   - times where t
-0001fc60: 6f20 636f 6d70 7574 6520 7468 6520 6675  o compute the fu
-0001fc70: 6e63 7469 6f6e 0a20 2020 2020 2020 2020  nction.         
-0001fc80: 2020 7265 7475 726e 733a 2064 6174 6120    returns: data 
-0001fc90: 3a20 6e64 6172 7261 7928 6e74 2c6e 7261  : ndarray(nt,nra
-0001fca0: 6629 2069 6620 6e74 203d 2031 2c20 7468  f) if nt = 1, th
-0001fcb0: 6520 6172 7261 7920 6d75 7374 2062 6520  e array must be 
-0001fcc0: 3244 0a20 2020 2020 2020 2020 2020 2020  2D.             
-0001fcd0: 2020 2020 2020 2020 2020 2020 2020 7661                va
-0001fce0: 6c75 6573 206f 6620 6675 6e63 2061 7420  lues of func at 
-0001fcf0: 7074 732c 2061 7420 6769 7665 6e20 7469  pts, at given ti
-0001fd00: 6d65 0a20 2020 2020 2020 2020 2020 6675  me.           fu
-0001fd10: 6e63 2069 7320 7468 6520 6675 6e63 7469  nc is the functi
-0001fd20: 6f6e 2074 6f20 6265 2069 6e74 6567 7261  on to be integra
-0001fd30: 7465 6420 616c 6f6e 6720 7468 6520 4c4f  ted along the LO
-0001fd40: 530a 2020 2020 7261 795f 6f72 6967 3a20  S.    ray_orig: 
-0001fd50: 6e64 6172 7261 7920 2833 2c20 6e6c 6f73  ndarray (3, nlos
-0001fd60: 2920 4c4f 5320 6f72 6967 696e 730a 2020  ) LOS origins.  
-0001fd70: 2020 7261 795f 7664 6972 3a20 6e64 6172    ray_vdir: ndar
-0001fd80: 7261 7920 2833 2c20 6e6c 6f73 2920 4c4f  ray (3, nlos) LO
-0001fd90: 5320 6469 7265 6374 696f 6e61 6c20 7665  S directional ve
-0001fda0: 6374 6f72 0a20 2020 2072 6573 3a20 646f  ctor.    res: do
-0001fdb0: 7562 6c65 206f 7220 6c69 7374 206f 6620  uble or list of 
-0001fdc0: 646f 7562 6c65 730a 2020 2020 2020 2020  doubles.        
-0001fdd0: 4966 2072 6573 2069 7320 6120 7369 6e67  If res is a sing
-0001fde0: 6c65 2064 6f75 626c 653a 2064 6973 6372  le double: discr
-0001fdf0: 6574 697a 6174 696f 6e20 7374 6570 2066  etization step f
-0001fe00: 6f72 2061 6c6c 204c 4f53 2e0a 2020 2020  or all LOS..    
-0001fe10: 2020 2020 456c 7365 2072 6573 2073 686f      Else res sho
-0001fe20: 756c 6420 6265 2061 206c 6973 7420 6f66  uld be a list of
-0001fe30: 2073 697a 6520 6e6c 6f73 2077 6974 6820   size nlos with 
-0001fe40: 7468 6520 6469 7363 7265 7469 7a61 7469  the discretizati
-0001fe50: 6f6e 0a20 2020 2020 2020 2073 7465 7020  on.        step 
-0001fe60: 666f 7220 6561 6368 206e 6c6f 732e 0a20  for each nlos.. 
-0001fe70: 2020 206c 696d 733a 2028 322c 206e 6c6f     lims: (2, nlo
-0001fe80: 7329 2064 6f75 626c 6520 6172 7261 790a  s) double array.
-0001fe90: 2020 2020 2020 2020 466f 7220 6561 6368          For each
-0001fea0: 206e 6c6f 732c 2069 7420 6769 7665 6e20   nlos, it given 
-0001feb0: 7468 6520 6d61 7869 6d75 6d20 616e 6420  the maximum and 
-0001fec0: 6d69 6e69 6d75 6d20 6c69 6d69 7473 206f  minimum limits o
-0001fed0: 6620 7468 6520 7261 790a 2020 2020 646d  f the ray.    dm
-0001fee0: 6574 686f 643a 2073 7472 696e 670a 2020  ethod: string.  
-0001fef0: 2020 2020 2020 7479 7065 206f 6620 6469        type of di
-0001ff00: 7363 7265 7469 7a61 7469 6f6e 2073 7465  scretization ste
-0001ff10: 703a 2027 6162 7327 2066 6f72 2061 6273  p: 'abs' for abs
-0001ff20: 6f6c 7574 6520 6f72 2027 7265 6c27 2066  olute or 'rel' f
-0001ff30: 6f72 2072 656c 6174 6976 650a 2020 2020  or relative.    
-0001ff40: 6d65 7468 6f64 3a20 7374 7269 6e67 0a20  method: string. 
-0001ff50: 2020 2020 2020 206d 6574 686f 6420 6f66         method of
-0001ff60: 2071 7561 6472 6174 7572 6520 6f6e 2074   quadrature on t
-0001ff70: 6865 204c 4f53 0a20 2020 2061 6e69 203a  he LOS.    ani :
-0001ff80: 2062 6f6f 6c0a 2020 2020 2020 2020 746f   bool.        to
-0001ff90: 2069 6e64 6963 6174 6520 6966 2065 6d69   indicate if emi
-0001ffa0: 7373 696f 6e20 6973 2061 6e69 736f 7472  ssion is anisotr
-0001ffb0: 6f70 6963 206f 7220 6e6f 740a 2020 2020  opic or not.    
-0001ffc0: 7420 3a20 4e6f 6e65 206f 7220 6172 7261  t : None or arra
-0001ffd0: 792d 6c69 6b65 0a20 2020 2020 2020 2074  y-like.        t
-0001ffe0: 696d 6573 2077 6865 7265 2074 6f20 696e  imes where to in
-0001fff0: 7465 6772 6174 650a 2020 2020 6d69 6e69  tegrate.    mini
-00020000: 6d69 7a65 3a20 7374 7269 6e67 0a20 2020  mize: string.   
-00020010: 2020 2020 2022 6361 6c6c 7322 203a 2077       "calls" : w
-00020020: 6520 7573 6520 616c 676f 7269 7468 6d20  e use algorithm 
-00020030: 746f 206d 696e 696d 697a 6520 7468 6520  to minimize the 
-00020040: 6361 6c6c 7320 746f 2027 6675 6e63 2720  calls to 'func' 
-00020050: 2864 6566 6175 6c74 290a 2020 2020 2020  (default).      
-00020060: 2020 226d 656d 6f72 7922 3a20 7765 2075    "memory": we u
-00020070: 7365 2061 6c67 6f72 6974 686d 2074 6f20  se algorithm to 
-00020080: 6d69 6e69 6d69 7a65 206d 656d 6f72 7920  minimize memory 
-00020090: 7573 6564 0a20 2020 2020 2020 2022 6879  used.        "hy
-000200a0: 6272 6964 223a 2061 206d 6978 206f 6620  brid": a mix of 
-000200b0: 626f 7468 206d 6574 686f 6473 0a20 2020  both methods.   
-000200c0: 2054 6573 7420 3a20 626f 6f6c 0a20 2020   Test : bool.   
-000200d0: 2020 2020 2077 6520 7465 7374 2069 6620       we test if 
-000200e0: 7468 6520 696e 7075 7473 2061 7265 2067  the inputs are g
-000200f0: 6976 696e 6720 696e 2061 2070 726f 7065  iving in a prope
-00020100: 7220 7761 792e 0a20 2020 206e 756d 5f74  r way..    num_t
-00020110: 6872 6561 6473 3a20 696e 740a 2020 2020  hreads: int.    
-00020120: 2020 2020 6e75 6d62 6572 206f 6620 7468      number of th
-00020130: 7265 6164 7320 6966 2077 6520 7761 6e74  reads if we want
-00020140: 2074 6f20 7061 7261 6c6c 656c 697a 6520   to parallelize 
-00020150: 7468 6520 636f 6465 2e0a 2020 2020 2222  the code..    ""
-00020160: 220a 2020 2020 6364 6566 2073 7472 2065  ".    cdef str e
-00020170: 7272 6f72 5f6d 6573 7361 6765 0a20 2020  rror_message.   
-00020180: 2063 6465 6620 7374 7220 646d 6f64 6520   cdef str dmode 
-00020190: 3d20 646d 6574 686f 642e 6c6f 7765 7228  = dmethod.lower(
-000201a0: 290a 2020 2020 6364 6566 2073 7472 2069  ).    cdef str i
-000201b0: 6d6f 6465 203d 206d 6574 686f 642e 6c6f  mode = method.lo
-000201c0: 7765 7228 290a 2020 2020 6364 6566 2073  wer().    cdef s
-000201d0: 7472 206d 696e 696d 203d 206d 696e 696d  tr minim = minim
-000201e0: 697a 652e 6c6f 7765 7228 290a 2020 2020  ize.lower().    
-000201f0: 6364 6566 2069 6e74 206a 6a70 310a 2020  cdef int jjp1.  
-00020200: 2020 6364 6566 2069 6e74 2073 7a31 5f64    cdef int sz1_d
-00020210: 730a 2020 2020 6364 6566 2069 6e74 2073  s.    cdef int s
-00020220: 7a31 5f75 732c 2073 7a32 5f75 730a 2020  z1_us, sz2_us.  
-00020230: 2020 6364 6566 2069 6e74 2073 7a31 5f64    cdef int sz1_d
-00020240: 6c73 2c20 737a 325f 646c 730a 2020 2020  ls, sz2_dls.    
-00020250: 6364 6566 2069 6e74 206e 5f69 6d6f 6465  cdef int n_imode
-00020260: 2c20 6e5f 646d 6f64 650a 2020 2020 6364  , n_dmode.    cd
-00020270: 6566 2069 6e74 206e 6c6f 730a 2020 2020  ef int nlos.    
-00020280: 6364 6566 2069 6e74 206e 743d 302c 2069  cdef int nt=0, i
-00020290: 692c 206a 6a0a 2020 2020 6364 6566 2062  i, jj.    cdef b
-000202a0: 696e 7420 7265 735f 6973 5f6c 6973 740a  int res_is_list.
-000202b0: 2020 2020 6364 6566 2062 696e 7420 4330      cdef bint C0
-000202c0: 2c20 4331 0a20 2020 2063 6465 6620 6c69  , C1.    cdef li
-000202d0: 7374 206c 7469 6d65 0a20 2020 2063 6465  st ltime.    cde
-000202e0: 6620 646f 7562 6c65 206c 6f63 5f72 0a20  f double loc_r. 
-000202f0: 2020 2063 6465 6620 6c6f 6e67 5b31 5d20     cdef long[1] 
-00020300: 6e62 5f72 6f77 730a 2020 2020 6364 6566  nb_rows.    cdef
-00020310: 206c 6f6e 675b 3a3a 315d 2069 6e64 6269   long[::1] indbi
-00020320: 730a 2020 2020 6364 6566 2064 6f75 626c  s.    cdef doubl
-00020330: 655b 315d 206c 6f63 5f65 6666 5f72 6573  e[1] loc_eff_res
-00020340: 0a20 2020 2063 6465 6620 646f 7562 6c65  .    cdef double
-00020350: 5b3a 3a31 5d20 7265 7365 6666 5f6d 760a  [::1] reseff_mv.
-00020360: 2020 2020 6364 6566 2064 6f75 626c 655b      cdef double[
-00020370: 3a3a 315d 2072 6573 5f6d 760a 2020 2020  ::1] res_mv.    
-00020380: 6364 6566 2064 6f75 626c 655b 3a2c 3a3a  cdef double[:,::
-00020390: 315d 2076 616c 5f6d 760a 2020 2020 6364  1] val_mv.    cd
-000203a0: 6566 2064 6f75 626c 655b 3a2c 3a3a 315d  ef double[:,::1]
-000203b0: 2070 7473 5f6d 760a 2020 2020 6364 6566   pts_mv.    cdef
-000203c0: 2064 6f75 626c 655b 3a2c 3a3a 315d 2075   double[:,::1] u
-000203d0: 7362 6973 5f6d 760a 2020 2020 6364 6566  sbis_mv.    cdef
-000203e0: 2064 6f75 626c 655b 3a2c 3a3a 315d 2076   double[:,::1] v
-000203f0: 616c 5f32 640a 2020 2020 6364 6566 206e  al_2d.    cdef n
-00020400: 702e 6e64 6172 7261 795b 646f 7562 6c65  p.ndarray[double
-00020410: 2c6e 6469 6d3d 325d 2075 7362 6973 0a20  ,ndim=2] usbis. 
-00020420: 2020 2063 6465 6620 6e70 2e6e 6461 7272     cdef np.ndarr
-00020430: 6179 5b64 6f75 626c 652c 6e64 696d 3d32  ay[double,ndim=2
-00020440: 5d20 7074 730a 2020 2020 6364 6566 206e  ] pts.    cdef n
-00020450: 702e 6e64 6172 7261 795b 646f 7562 6c65  p.ndarray[double
-00020460: 2c6e 6469 6d3d 322c 206d 6f64 653d 2766  ,ndim=2, mode='f
-00020470: 6f72 7472 616e 275d 2073 6967 0a20 2020  ortran'] sig.   
-00020480: 2063 6465 6620 6e70 2e6e 6461 7272 6179   cdef np.ndarray
-00020490: 5b64 6f75 626c 652c 6e64 696d 3d31 5d20  [double,ndim=1] 
-000204a0: 7265 7365 6666 0a20 2020 2063 6465 6620  reseff.    cdef 
-000204b0: 6e70 2e6e 6461 7272 6179 5b64 6f75 626c  np.ndarray[doubl
-000204c0: 652c 6e64 696d 3d31 5d20 6b0a 2020 2020  e,ndim=1] k.    
-000204d0: 6364 6566 206e 702e 6e64 6172 7261 795b  cdef np.ndarray[
-000204e0: 646f 7562 6c65 2c6e 6469 6d3d 315d 2072  double,ndim=1] r
-000204f0: 6573 5f61 7272 0a20 2020 2063 6465 6620  es_arr.    cdef 
-00020500: 6e70 2e6e 6461 7272 6179 5b6c 6f6e 672c  np.ndarray[long,
-00020510: 6e64 696d 3d31 5d20 696e 640a 2020 2020  ndim=1] ind.    
-00020520: 6364 6566 206c 6f6e 672a 2069 6e64 5f61  cdef long* ind_a
-00020530: 7272 203d 204e 554c 4c0a 2020 2020 6364  rr = NULL.    cd
-00020540: 6566 2064 6f75 626c 652a 2072 6573 6566  ef double* resef
-00020550: 665f 6172 7220 3d20 4e55 4c4c 0a20 2020  f_arr = NULL.   
-00020560: 2063 6465 6620 646f 7562 6c65 2a2a 2063   cdef double** c
-00020570: 6f65 6666 5f70 7472 203d 204e 554c 4c0a  oeff_ptr = NULL.
-00020580: 2020 2020 2320 2e2e 2072 6179 5f6f 7269      # .. ray_ori
-00020590: 6720 7368 6170 6520 6e65 6564 6564 2066  g shape needed f
-000205a0: 6f72 2074 6573 7469 6e67 2061 6e64 2069  or testing and i
-000205b0: 6e20 616c 676f 202e 2e2e 2e2e 2e2e 2e2e  n algo .........
-000205c0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-000205d0: 0a20 2020 2073 7a31 5f64 7320 3d20 7261  .    sz1_ds = ra
-000205e0: 795f 6f72 6967 2e73 6861 7065 5b30 5d0a  y_orig.shape[0].
-000205f0: 2020 2020 6e6c 6f73 203d 2072 6179 5f6f      nlos = ray_o
-00020600: 7269 672e 7368 6170 655b 315d 0a20 2020  rig.shape[1].   
-00020610: 2072 6573 5f69 735f 6c69 7374 203d 2068   res_is_list = h
-00020620: 6173 6174 7472 2872 6573 2c20 275f 5f69  asattr(res, '__i
-00020630: 7465 725f 5f27 290a 2020 2020 2320 2e2e  ter__').    # ..
-00020640: 2076 6572 6966 7969 6e67 2061 7267 756d   verifying argum
-00020650: 656e 7473 202e 2e2e 2e2e 2e2e 2e2e 2e2e  ents ...........
-00020660: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00020670: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00020680: 2e2e 2e2e 2e2e 2e2e 0a20 2020 2069 6620  .........    if 
-00020690: 5465 7374 3a0a 2020 2020 2020 2020 737a  Test:.        sz
-000206a0: 315f 7573 203d 2072 6179 5f76 6469 722e  1_us = ray_vdir.
-000206b0: 7368 6170 655b 305d 0a20 2020 2020 2020  shape[0].       
-000206c0: 2073 7a32 5f75 7320 3d20 7261 795f 7664   sz2_us = ray_vd
-000206d0: 6972 2e73 6861 7065 5b31 5d0a 2020 2020  ir.shape[1].    
-000206e0: 2020 2020 737a 315f 646c 7320 3d20 6c69      sz1_dls = li
-000206f0: 6d73 2e73 6861 7065 5b30 5d0a 2020 2020  ms.shape[0].    
-00020700: 2020 2020 737a 325f 646c 7320 3d20 6c69      sz2_dls = li
-00020710: 6d73 2e73 6861 7065 5b31 5d0a 2020 2020  ms.shape[1].    
-00020720: 2020 2020 6173 7365 7274 2073 7a31 5f64      assert sz1_d
-00020730: 7320 3d3d 2033 2c20 2244 696d 2030 206f  s == 3, "Dim 0 o
-00020740: 6620 6172 6720 7261 795f 6f72 6967 2073  f arg ray_orig s
-00020750: 686f 756c 6420 6265 2033 220a 2020 2020  hould be 3".    
-00020760: 2020 2020 6173 7365 7274 2073 7a31 5f75      assert sz1_u
-00020770: 7320 3d3d 2033 2c20 2244 696d 2030 206f  s == 3, "Dim 0 o
-00020780: 6620 6172 6720 7261 795f 7664 6972 2073  f arg ray_vdir s
-00020790: 686f 756c 6420 6265 2033 220a 2020 2020  hould be 3".    
-000207a0: 2020 2020 6173 7365 7274 2073 7a31 5f64      assert sz1_d
-000207b0: 6c73 203d 3d20 322c 2022 4469 6d20 3020  ls == 2, "Dim 0 
-000207c0: 6f66 2061 7267 206c 696d 7320 7368 6f75  of arg lims shou
-000207d0: 6c64 2062 6520 3222 0a20 2020 2020 2020  ld be 2".       
-000207e0: 2065 7272 6f72 5f6d 6573 7361 6765 203d   error_message =
-000207f0: 2028 2241 7267 7320 7261 795f 6f72 6967   ("Args ray_orig
-00020800: 2c20 7261 795f 7664 6972 2c20 616e 6420  , ray_vdir, and 
-00020810: 6c69 6d73 2022 0a20 2020 2020 2020 2020  lims ".         
-00020820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020830: 2b20 2273 686f 756c 6420 6861 7665 2073  + "should have s
-00020840: 616d 6520 6469 6d65 6e73 696f 6e20 3122  ame dimension 1"
-00020850: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
-00020860: 206e 6c6f 7320 3d3d 2073 7a32 5f75 7320   nlos == sz2_us 
-00020870: 3d3d 2073 7a32 5f64 6c73 2c20 6572 726f  == sz2_dls, erro
-00020880: 725f 6d65 7373 6167 650a 2020 2020 2020  r_message.      
-00020890: 2020 4330 203d 206e 6f74 2072 6573 5f69    C0 = not res_i
-000208a0: 735f 6c69 7374 2061 6e64 2072 6573 203e  s_list and res >
-000208b0: 2030 2e0a 2020 2020 2020 2020 4331 203d   0..        C1 =
-000208c0: 2072 6573 5f69 735f 6c69 7374 2061 6e64   res_is_list and
-000208d0: 206c 656e 2872 6573 293d 3d6e 6c6f 7320   len(res)==nlos 
-000208e0: 616e 6420 6e70 2e61 6c6c 2872 6573 3e30  and np.all(res>0
-000208f0: 2e29 0a20 2020 2020 2020 2061 7373 6572  .).        asser
-00020900: 7420 4330 206f 7220 4331 2c20 2241 7267  t C0 or C1, "Arg
-00020910: 2072 6573 206d 7573 7420 6265 2061 2064   res must be a d
-00020920: 6f75 626c 6520 6f72 2061 204c 6973 742c  ouble or a List,
-00020930: 2061 6e64 2061 6c6c 2072 6573 203e 302e   and all res >0.
-00020940: 2122 0a20 2020 2020 2020 2065 7272 6f72  !".        error
-00020950: 5f6d 6573 7361 6765 203d 2022 4172 6775  _message = "Argu
-00020960: 6d65 6e74 2064 6d65 7468 6f64 2028 6469  ment dmethod (di
-00020970: 7363 7265 7469 7a61 7469 6f6e 206d 6574  scretization met
-00020980: 686f 6429 2073 686f 756c 6420 6265 2069  hod) should be i
-00020990: 6e22 5c0a 2020 2020 2020 2020 2020 2020  n"\.            
-000209a0: 2020 2020 2020 2020 2020 2020 2b22 205b              +" [
-000209b0: 2761 6273 272c 2772 656c 275d 2c20 666f  'abs','rel'], fo
-000209c0: 7220 6162 736f 6c75 7465 206f 7220 7265  r absolute or re
-000209d0: 6c61 7469 7665 2e22 0a20 2020 2020 2020  lative.".       
-000209e0: 2061 7373 6572 7420 646d 6f64 6520 696e   assert dmode in
-000209f0: 205b 2761 6273 272c 2772 656c 275d 2c20   ['abs','rel'], 
-00020a00: 6572 726f 725f 6d65 7373 6167 650a 2020  error_message.  
-00020a10: 2020 2020 2020 6572 726f 725f 6d65 7373        error_mess
-00020a20: 6167 6520 3d20 2257 726f 6e67 206d 6574  age = "Wrong met
-00020a30: 686f 6420 6f66 2069 6e74 6567 7261 7469  hod of integrati
-00020a40: 6f6e 2e22 205c 0a20 2020 2020 2020 2020  on." \.         
-00020a50: 2020 2020 2020 2020 2020 2020 2020 202b                 +
-00020a60: 2022 204f 7074 696f 6e73 2061 7265 3a20   " Options are: 
-00020a70: 5b27 7375 6d27 2c27 7369 6d70 7327 2c27  ['sum','simps','
-00020a80: 726f 6d62 275d 220a 2020 2020 2020 2020  romb']".        
-00020a90: 6173 7365 7274 2069 6d6f 6465 2069 6e20  assert imode in 
-00020aa0: 5b27 7375 6d27 2c27 7369 6d70 7327 2c27  ['sum','simps','
-00020ab0: 726f 6d62 275d 2c20 6572 726f 725f 6d65  romb'], error_me
-00020ac0: 7373 6167 650a 2020 2020 2020 2020 6572  ssage.        er
-00020ad0: 726f 725f 6d65 7373 6167 6520 3d20 2257  ror_message = "W
-00020ae0: 726f 6e67 206d 696e 696d 697a 6520 6f70  rong minimize op
-00020af0: 7469 6d69 7a61 7469 6f6e 2e22 5c0a 2020  timization."\.  
-00020b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020b10: 2020 2020 2020 2b20 2220 4f70 7469 6f6e        + " Option
-00020b20: 7320 6172 653a 205b 2763 616c 6c73 272c  s are: ['calls',
-00020b30: 276d 656d 6f72 7927 2c27 6879 6272 6964  'memory','hybrid
-00020b40: 275d 220a 2020 2020 2020 2020 6173 7365  ']".        asse
-00020b50: 7274 206d 696e 696d 2069 6e20 5b27 6361  rt minim in ['ca
-00020b60: 6c6c 7327 2c27 6d65 6d6f 7279 272c 2768  lls','memory','h
-00020b70: 7962 7269 6427 5d2c 2065 7272 6f72 5f6d  ybrid'], error_m
-00020b80: 6573 7361 6765 0a20 2020 2023 202d 2d20  essage.    # -- 
-00020b90: 5072 6566 6f72 6d61 7420 6f75 7470 7574  Preformat output
-00020ba0: 2073 6967 6e61 6c20 2d2d 2d2d 2d2d 2d2d   signal --------
-00020bb0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00020bc0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00020bd0: 2d2d 2d2d 2d2d 2d0a 2020 2020 6966 2074  -------.    if t
-00020be0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-00020bf0: 2020 6966 206d 696e 696d 203d 3d20 276d    if minim == 'm
-00020c00: 656d 6f72 7927 3a0a 2020 2020 2020 2020  emory':.        
-00020c10: 2020 2020 6d69 6e69 6d20 3d20 2763 616c      minim = 'cal
-00020c20: 6c73 270a 2020 2020 2020 2020 2020 2020  ls'.            
-00020c30: 6572 726f 725f 6d65 7373 6167 6520 3d20  error_message = 
-00020c40: 2249 6620 7420 6973 204e 6f6e 6520 2122  "If t is None !"
-00020c50: 0a20 2020 2020 2020 2020 2020 2065 7272  .            err
-00020c60: 6f72 5f6d 6573 7361 6765 202b 3d20 2220  or_message += " 
-00020c70: 203d 3e20 7468 6572 6520 6973 206e 6f20   => there is no 
-00020c80: 706f 696e 7420 696e 2075 7369 6e67 206d  point in using m
-00020c90: 696e 696d 697a 653d 276d 656d 6f72 7927  inimize='memory'
-00020ca0: 220a 2020 2020 2020 2020 2020 2020 6572  ".            er
-00020cb0: 726f 725f 6d65 7373 6167 6520 2b3d 2022  ror_message += "
-00020cc0: 2020 3d3e 2073 7769 7463 6869 6e67 2074    => switching t
-00020cd0: 6f20 6d69 6e69 6d69 7a65 203d 2027 2573  o minimize = '%s
-00020ce0: 2722 256d 696e 696d 0a20 2020 2020 2020  '"%minim.       
-00020cf0: 2020 2020 2077 6172 6e28 6572 726f 725f       warn(error_
-00020d00: 6d65 7373 6167 6529 0a20 2020 2020 2020  message).       
-00020d10: 206e 7420 3d20 310a 2020 2020 2020 2020   nt = 1.        
-00020d20: 6c74 696d 6520 3d20 5b4e 6f6e 655d 0a20  ltime = [None]. 
-00020d30: 2020 2065 6c69 6620 6e6f 7420 6861 7361     elif not hasa
-00020d40: 7474 7228 742c 275f 5f69 7465 725f 5f27  ttr(t,'__iter__'
-00020d50: 293a 0a20 2020 2020 2020 206e 7420 3d20  ):.        nt = 
-00020d60: 310a 2020 2020 2020 2020 6c74 696d 6520  1.        ltime 
-00020d70: 3d20 5b74 5d0a 2020 2020 656c 7365 3a0a  = [t].    else:.
-00020d80: 2020 2020 2020 2020 6e74 203d 206c 656e          nt = len
-00020d90: 2874 290a 2020 2020 2020 2020 6966 2069  (t).        if i
-00020da0: 7369 6e73 7461 6e63 6528 742c 206c 6973  sinstance(t, lis
-00020db0: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
-00020dc0: 6c74 696d 6520 3d20 740a 2020 2020 2020  ltime = t.      
-00020dd0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00020de0: 2020 2020 6c74 696d 6520 3d20 742e 746f      ltime = t.to
-00020df0: 6c69 7374 2829 0a20 2020 2023 202d 2d20  list().    # -- 
-00020e00: 496e 697a 6961 6c69 7a61 7469 6f6e 7320  Inizializations 
-00020e10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00020e20: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00020e30: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00020e40: 2d2d 2d2d 2d2d 2d0a 2020 2020 2320 4765  -------.    # Ge
-00020e50: 7474 696e 6720 6e75 6d62 6572 206f 6620  tting number of 
-00020e60: 6d6f 6465 733a 0a20 2020 206e 5f64 6d6f  modes:.    n_dmo
-00020e70: 6465 203d 205f 7374 2e67 6574 5f6e 625f  de = _st.get_nb_
-00020e80: 646d 6f64 6528 646d 6f64 6529 0a20 2020  dmode(dmode).   
-00020e90: 206e 5f69 6d6f 6465 203d 205f 7374 2e67   n_imode = _st.g
-00020ea0: 6574 5f6e 625f 696d 6f64 6528 696d 6f64  et_nb_imode(imod
-00020eb0: 6529 0a20 2020 2023 2049 6e69 7469 616c  e).    # Initial
-00020ec0: 697a 6174 696f 6e20 7265 7375 6c74 0a20  ization result. 
-00020ed0: 2020 2073 6967 203d 206e 702e 656d 7074     sig = np.empt
-00020ee0: 7928 286e 742c 206e 6c6f 7329 2c20 6474  y((nt, nlos), dt
-00020ef0: 7970 653d 666c 6f61 742c 206f 7264 6572  ype=float, order
-00020f00: 3d27 4627 290a 2020 2020 2320 4966 2074  ='F').    # If t
-00020f10: 6865 2072 6573 6f6c 7574 696f 6e20 6973  he resolution is
-00020f20: 2074 6865 2073 616d 6520 666f 7220 6576   the same for ev
-00020f30: 6572 7920 4c4f 532c 2077 6520 6372 6561  ery LOS, we crea
-00020f40: 7465 2061 2074 6162 0a20 2020 2069 6620  te a tab.    if 
-00020f50: 7265 735f 6973 5f6c 6973 7420 3a0a 2020  res_is_list :.  
-00020f60: 2020 2020 2020 7265 735f 6172 7220 3d20        res_arr = 
-00020f70: 6e70 2e61 7361 7272 6179 2872 6573 290a  np.asarray(res).
-00020f80: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00020f90: 2020 7265 735f 6172 7220 3d20 6e70 2e6f    res_arr = np.o
-00020fa0: 6e65 7328 286e 6c6f 732c 292c 2064 7479  nes((nlos,), dty
-00020fb0: 7065 3d66 6c6f 6174 2920 2a20 7265 730a  pe=float) * res.
-00020fc0: 2020 2020 7265 735f 6d76 203d 2072 6573      res_mv = res
-00020fd0: 5f61 7272 0a20 2020 2023 202d 2d2d 2d2d  _arr.    # -----
-00020fe0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00020ff0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00021000: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0001f5f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001f600: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001f610: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001f620: 0a23 2020 2020 2020 2020 2020 2020 2020  .#              
+0001f630: 2053 6967 6e61 6c20 6361 6c63 756c 6174   Signal calculat
+0001f640: 696f 6e0a 2323 2323 2323 2323 2323 2323  ion.############
+0001f650: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001f660: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001f670: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001f680: 2323 2323 2323 2323 2323 0a0a 6465 6620  ##########..def 
+0001f690: 696e 7465 6772 6174 6531 6428 792c 2064  integrate1d(y, d
+0001f6a0: 6f75 626c 6520 6478 2c20 743d 4e6f 6e65  ouble dx, t=None
+0001f6b0: 2c20 7374 7220 6d65 7468 6f64 3d27 7375  , str method='su
+0001f6c0: 6d27 293a 0a20 2020 2022 2222 2047 656e  m'):.    """ Gen
+0001f6d0: 6572 6963 2069 6e74 6567 7261 7469 6f6e  eric integration
+0001f6e0: 206d 6574 686f 6420 5b27 7375 6d27 2c27   method ['sum','
+0001f6f0: 7369 6d70 7327 2c27 726f 6d62 275d 0a0a  simps','romb']..
+0001f700: 2020 2020 2020 2020 4e6f 7420 7573 6564          Not used
+0001f710: 2069 6e74 6572 6e61 6c6c 790a 2020 2020   internally.    
+0001f720: 2020 2020 5573 6566 756c 2077 6865 6e20      Useful when 
+0001f730: 7468 6520 7361 6d70 6c69 6e67 2070 6f69  the sampling poi
+0001f740: 6e74 7320 6e65 6564 2074 6f20 6265 2069  nts need to be i
+0001f750: 6e74 6572 706f 6c61 7465 6420 7669 6120  nterpolated via 
+0001f760: 6571 7569 6c69 6272 6975 6d0a 2020 2020  equilibrium.    
+0001f770: 2222 220a 2020 2020 6364 6566 2075 6e73  """.    cdef uns
+0001f780: 6967 6e65 6420 696e 7420 6e74 2c20 6178  igned int nt, ax
+0001f790: 6d0a 2020 2020 6966 2074 2069 7320 4e6f  m.    if t is No
+0001f7a0: 6e65 206f 7220 6e6f 7420 6861 7361 7474  ne or not hasatt
+0001f7b0: 7228 742c 275f 5f69 7465 725f 5f27 293a  r(t,'__iter__'):
+0001f7c0: 0a20 2020 2020 2020 206e 7420 3d20 310a  .        nt = 1.
+0001f7d0: 2020 2020 2020 2020 6178 6d20 3d20 300a          axm = 0.
+0001f7e0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0001f7f0: 2020 6e74 203d 206c 656e 2874 290a 2020    nt = len(t).  
+0001f800: 2020 2020 2020 6178 6d20 3d20 310a 2020        axm = 1.  
+0001f810: 2020 696e 6420 3d20 6e70 2e69 736e 616e    ind = np.isnan
+0001f820: 2879 290a 2020 2020 6966 206e 702e 616e  (y).    if np.an
+0001f830: 7928 696e 6429 3a0a 2020 2020 2020 2020  y(ind):.        
+0001f840: 7920 3d20 792e 636f 7079 2829 0a20 2020  y = y.copy().   
+0001f850: 2020 2020 2079 5b69 6e64 5d20 3d20 302e       y[ind] = 0.
+0001f860: 0a0a 2020 2020 6364 6566 206e 702e 6e64  ..    cdef np.nd
+0001f870: 6172 7261 795b 646f 7562 6c65 2c6e 6469  array[double,ndi
+0001f880: 6d3d 315d 2073 203d 206e 702e 656d 7074  m=1] s = np.empt
+0001f890: 7928 286e 742c 292c 6474 7970 653d 666c  y((nt,),dtype=fl
+0001f8a0: 6f61 7429 0a0a 2020 2020 6966 206d 6574  oat)..    if met
+0001f8b0: 686f 643d 3d27 7375 6d27 3a0a 2020 2020  hod=='sum':.    
+0001f8c0: 2020 2020 7320 3d20 6e70 2e73 756d 2879      s = np.sum(y
+0001f8d0: 2c20 6178 6973 3d61 786d 292a 6478 0a20  , axis=axm)*dx. 
+0001f8e0: 2020 2065 6c69 6620 6d65 7468 6f64 3d3d     elif method==
+0001f8f0: 2773 696d 7073 273a 0a20 2020 2020 2020  'simps':.       
+0001f900: 2073 203d 2073 6370 696e 7467 2e73 696d   s = scpintg.sim
+0001f910: 7073 2879 2c20 783d 4e6f 6e65 2c20 6478  ps(y, x=None, dx
+0001f920: 3d64 782c 2061 7869 733d 6178 6d29 0a20  =dx, axis=axm). 
+0001f930: 2020 2065 6c69 6620 6d65 7468 6f64 3d3d     elif method==
+0001f940: 2772 6f6d 6227 3a0a 2020 2020 2020 2020  'romb':.        
+0001f950: 7320 3d20 7363 7069 6e74 672e 726f 6d62  s = scpintg.romb
+0001f960: 2879 2c20 6478 3d64 782c 2061 7869 733d  (y, dx=dx, axis=
+0001f970: 6178 6d2c 2073 686f 773d 4661 6c73 6529  axm, show=False)
+0001f980: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+0001f990: 2020 2072 6169 7365 2045 7863 6570 7469     raise Excepti
+0001f9a0: 6f6e 2822 4172 6720 6d65 7468 6f64 206d  on("Arg method m
+0001f9b0: 7573 7420 6265 2069 6e20 5b27 7375 6d27  ust be in ['sum'
+0001f9c0: 2c27 7369 6d70 7327 2c27 726f 6d62 275d  ,'simps','romb']
+0001f9d0: 2229 0a20 2020 2072 6574 7572 6e20 730a  ").    return s.
+0001f9e0: 0a0a 6465 6620 4c4f 535f 6361 6c63 5f73  ..def LOS_calc_s
+0001f9f0: 6967 6e61 6c28 6675 6e63 2c20 646f 7562  ignal(func, doub
+0001fa00: 6c65 5b3a 2c3a 3a31 5d20 7261 795f 6f72  le[:,::1] ray_or
+0001fa10: 6967 2c20 646f 7562 6c65 5b3a 2c3a 3a31  ig, double[:,::1
+0001fa20: 5d20 7261 795f 7664 6972 2c20 7265 732c  ] ray_vdir, res,
+0001fa30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001fa40: 2020 2020 2064 6f75 626c 655b 3a2c 3a3a       double[:,::
+0001fa50: 315d 206c 696d 732c 2073 7472 2064 6d65  1] lims, str dme
+0001fa60: 7468 6f64 3d27 6162 7327 2c0a 2020 2020  thod='abs',.    
+0001fa70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fa80: 7374 7220 6d65 7468 6f64 3d27 7375 6d27  str method='sum'
+0001fa90: 2c20 6269 6e74 2061 6e69 3d46 616c 7365  , bint ani=False
+0001faa0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001fab0: 2020 2020 2020 743d 4e6f 6e65 2c20 666b        t=None, fk
+0001fac0: 7764 6172 6773 3d7b 7d2c 2073 7472 206d  wdargs={}, str m
+0001fad0: 696e 696d 697a 653d 2763 616c 6c73 272c  inimize='calls',
+0001fae0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001faf0: 2020 2020 2062 696e 7420 5465 7374 3d54       bint Test=T
+0001fb00: 7275 652c 2069 6e74 206e 756d 5f74 6872  rue, int num_thr
+0001fb10: 6561 6473 3d31 3629 3a0a 2020 2020 2222  eads=16):.    ""
+0001fb20: 2220 436f 6d70 7574 6520 7468 6520 7379  " Compute the sy
+0001fb30: 6e74 6865 7469 6320 7369 676e 616c 2c20  nthetic signal, 
+0001fb40: 6d69 6e69 6d69 7a69 6e67 2065 6974 6865  minimizing eithe
+0001fb50: 7220 6675 6e63 7469 6f6e 2063 616c 6c73  r function calls
+0001fb60: 206f 7220 6d65 6d6f 7279 0a20 2020 2050   or memory.    P
+0001fb70: 6172 616d 730a 2020 2020 3d3d 3d3d 3d0a  arams.    =====.
+0001fb80: 2020 2020 6675 6e63 203a 2070 7974 686f      func : pytho
+0001fb90: 6e20 6675 6e63 7469 6f6e 2073 742e 2066  n function st. f
+0001fba0: 756e 6328 7074 732c 2074 3d4e 6f6e 652c  unc(pts, t=None,
+0001fbb0: 2076 6563 743d 4e6f 6e65 2920 3d3e 2064   vect=None) => d
+0001fbc0: 6174 610a 2020 2020 2020 2020 2020 2077  ata.           w
+0001fbd0: 6974 6820 7074 7320 3a20 6e64 6172 7261  ith pts : ndarra
+0001fbe0: 7920 2833 2c20 6e70 7473 2920 2d20 706f  y (3, npts) - po
+0001fbf0: 696e 7473 2077 6865 7265 2066 756e 6374  ints where funct
+0001fc00: 696f 6e20 6973 2065 7661 6c75 6174 6564  ion is evaluated
+0001fc10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001fc20: 2076 6563 7420 3a20 6e64 6172 7261 7928   vect : ndarray(
+0001fc30: 332c 206e 7074 7329 202d 2069 6620 616e  3, npts) - if an
+0001fc40: 6973 6f74 726f 7069 6320 7369 676e 616c  isotropic signal
+0001fc50: 2076 6563 746f 7220 6f66 2065 6d69 7373   vector of emiss
+0001fc60: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0001fc70: 2020 743a 206e 6461 7272 6179 286d 2920    t: ndarray(m) 
+0001fc80: 2d20 7469 6d65 7320 7768 6572 6520 746f  - times where to
+0001fc90: 2063 6f6d 7075 7465 2074 6865 2066 756e   compute the fun
+0001fca0: 6374 696f 6e0a 2020 2020 2020 2020 2020  ction.          
+0001fcb0: 2072 6574 7572 6e73 3a20 6461 7461 203a   returns: data :
+0001fcc0: 206e 6461 7272 6179 286e 742c 6e72 6166   ndarray(nt,nraf
+0001fcd0: 2920 6966 206e 7420 3d20 312c 2074 6865  ) if nt = 1, the
+0001fce0: 2061 7272 6179 206d 7573 7420 6265 2032   array must be 2
+0001fcf0: 440a 2020 2020 2020 2020 2020 2020 2020  D.              
+0001fd00: 2020 2020 2020 2020 2020 2020 2076 616c               val
+0001fd10: 7565 7320 6f66 2066 756e 6320 6174 2070  ues of func at p
+0001fd20: 7473 2c20 6174 2067 6976 656e 2074 696d  ts, at given tim
+0001fd30: 650a 2020 2020 2020 2020 2020 2066 756e  e.           fun
+0001fd40: 6320 6973 2074 6865 2066 756e 6374 696f  c is the functio
+0001fd50: 6e20 746f 2062 6520 696e 7465 6772 6174  n to be integrat
+0001fd60: 6564 2061 6c6f 6e67 2074 6865 204c 4f53  ed along the LOS
+0001fd70: 0a20 2020 2072 6179 5f6f 7269 673a 206e  .    ray_orig: n
+0001fd80: 6461 7272 6179 2028 332c 206e 6c6f 7329  darray (3, nlos)
+0001fd90: 204c 4f53 206f 7269 6769 6e73 0a20 2020   LOS origins.   
+0001fda0: 2072 6179 5f76 6469 723a 206e 6461 7272   ray_vdir: ndarr
+0001fdb0: 6179 2028 332c 206e 6c6f 7329 204c 4f53  ay (3, nlos) LOS
+0001fdc0: 2064 6972 6563 7469 6f6e 616c 2076 6563   directional vec
+0001fdd0: 746f 720a 2020 2020 7265 733a 2064 6f75  tor.    res: dou
+0001fde0: 626c 6520 6f72 206c 6973 7420 6f66 2064  ble or list of d
+0001fdf0: 6f75 626c 6573 0a20 2020 2020 2020 2049  oubles.        I
+0001fe00: 6620 7265 7320 6973 2061 2073 696e 676c  f res is a singl
+0001fe10: 6520 646f 7562 6c65 3a20 6469 7363 7265  e double: discre
+0001fe20: 7469 7a61 7469 6f6e 2073 7465 7020 666f  tization step fo
+0001fe30: 7220 616c 6c20 4c4f 532e 0a20 2020 2020  r all LOS..     
+0001fe40: 2020 2045 6c73 6520 7265 7320 7368 6f75     Else res shou
+0001fe50: 6c64 2062 6520 6120 6c69 7374 206f 6620  ld be a list of 
+0001fe60: 7369 7a65 206e 6c6f 7320 7769 7468 2074  size nlos with t
+0001fe70: 6865 2064 6973 6372 6574 697a 6174 696f  he discretizatio
+0001fe80: 6e0a 2020 2020 2020 2020 7374 6570 2066  n.        step f
+0001fe90: 6f72 2065 6163 6820 6e6c 6f73 2e0a 2020  or each nlos..  
+0001fea0: 2020 6c69 6d73 3a20 2832 2c20 6e6c 6f73    lims: (2, nlos
+0001feb0: 2920 646f 7562 6c65 2061 7272 6179 0a20  ) double array. 
+0001fec0: 2020 2020 2020 2046 6f72 2065 6163 6820         For each 
+0001fed0: 6e6c 6f73 2c20 6974 2067 6976 656e 2074  nlos, it given t
+0001fee0: 6865 206d 6178 696d 756d 2061 6e64 206d  he maximum and m
+0001fef0: 696e 696d 756d 206c 696d 6974 7320 6f66  inimum limits of
+0001ff00: 2074 6865 2072 6179 0a20 2020 2064 6d65   the ray.    dme
+0001ff10: 7468 6f64 3a20 7374 7269 6e67 0a20 2020  thod: string.   
+0001ff20: 2020 2020 2074 7970 6520 6f66 2064 6973       type of dis
+0001ff30: 6372 6574 697a 6174 696f 6e20 7374 6570  cretization step
+0001ff40: 3a20 2761 6273 2720 666f 7220 6162 736f  : 'abs' for abso
+0001ff50: 6c75 7465 206f 7220 2772 656c 2720 666f  lute or 'rel' fo
+0001ff60: 7220 7265 6c61 7469 7665 0a20 2020 206d  r relative.    m
+0001ff70: 6574 686f 643a 2073 7472 696e 670a 2020  ethod: string.  
+0001ff80: 2020 2020 2020 6d65 7468 6f64 206f 6620        method of 
+0001ff90: 7175 6164 7261 7475 7265 206f 6e20 7468  quadrature on th
+0001ffa0: 6520 4c4f 530a 2020 2020 616e 6920 3a20  e LOS.    ani : 
+0001ffb0: 626f 6f6c 0a20 2020 2020 2020 2074 6f20  bool.        to 
+0001ffc0: 696e 6469 6361 7465 2069 6620 656d 6973  indicate if emis
+0001ffd0: 7369 6f6e 2069 7320 616e 6973 6f74 726f  sion is anisotro
+0001ffe0: 7069 6320 6f72 206e 6f74 0a20 2020 2074  pic or not.    t
+0001fff0: 203a 204e 6f6e 6520 6f72 2061 7272 6179   : None or array
+00020000: 2d6c 696b 650a 2020 2020 2020 2020 7469  -like.        ti
+00020010: 6d65 7320 7768 6572 6520 746f 2069 6e74  mes where to int
+00020020: 6567 7261 7465 0a20 2020 206d 696e 696d  egrate.    minim
+00020030: 697a 653a 2073 7472 696e 670a 2020 2020  ize: string.    
+00020040: 2020 2020 2263 616c 6c73 2220 3a20 7765      "calls" : we
+00020050: 2075 7365 2061 6c67 6f72 6974 686d 2074   use algorithm t
+00020060: 6f20 6d69 6e69 6d69 7a65 2074 6865 2063  o minimize the c
+00020070: 616c 6c73 2074 6f20 2766 756e 6327 2028  alls to 'func' (
+00020080: 6465 6661 756c 7429 0a20 2020 2020 2020  default).       
+00020090: 2022 6d65 6d6f 7279 223a 2077 6520 7573   "memory": we us
+000200a0: 6520 616c 676f 7269 7468 6d20 746f 206d  e algorithm to m
+000200b0: 696e 696d 697a 6520 6d65 6d6f 7279 2075  inimize memory u
+000200c0: 7365 640a 2020 2020 2020 2020 2268 7962  sed.        "hyb
+000200d0: 7269 6422 3a20 6120 6d69 7820 6f66 2062  rid": a mix of b
+000200e0: 6f74 6820 6d65 7468 6f64 730a 2020 2020  oth methods.    
+000200f0: 5465 7374 203a 2062 6f6f 6c0a 2020 2020  Test : bool.    
+00020100: 2020 2020 7765 2074 6573 7420 6966 2074      we test if t
+00020110: 6865 2069 6e70 7574 7320 6172 6520 6769  he inputs are gi
+00020120: 7669 6e67 2069 6e20 6120 7072 6f70 6572  ving in a proper
+00020130: 2077 6179 2e0a 2020 2020 6e75 6d5f 7468   way..    num_th
+00020140: 7265 6164 733a 2069 6e74 0a20 2020 2020  reads: int.     
+00020150: 2020 206e 756d 6265 7220 6f66 2074 6872     number of thr
+00020160: 6561 6473 2069 6620 7765 2077 616e 7420  eads if we want 
+00020170: 746f 2070 6172 616c 6c65 6c69 7a65 2074  to parallelize t
+00020180: 6865 2063 6f64 652e 0a20 2020 2022 2222  he code..    """
+00020190: 0a20 2020 2063 6465 6620 7374 7220 6572  .    cdef str er
+000201a0: 726f 725f 6d65 7373 6167 650a 2020 2020  ror_message.    
+000201b0: 6364 6566 2073 7472 2064 6d6f 6465 203d  cdef str dmode =
+000201c0: 2064 6d65 7468 6f64 2e6c 6f77 6572 2829   dmethod.lower()
+000201d0: 0a20 2020 2063 6465 6620 7374 7220 696d  .    cdef str im
+000201e0: 6f64 6520 3d20 6d65 7468 6f64 2e6c 6f77  ode = method.low
+000201f0: 6572 2829 0a20 2020 2063 6465 6620 7374  er().    cdef st
+00020200: 7220 6d69 6e69 6d20 3d20 6d69 6e69 6d69  r minim = minimi
+00020210: 7a65 2e6c 6f77 6572 2829 0a20 2020 2063  ze.lower().    c
+00020220: 6465 6620 696e 7420 6a6a 7031 0a20 2020  def int jjp1.   
+00020230: 2063 6465 6620 696e 7420 737a 315f 6473   cdef int sz1_ds
+00020240: 0a20 2020 2063 6465 6620 696e 7420 737a  .    cdef int sz
+00020250: 315f 7573 2c20 737a 325f 7573 0a20 2020  1_us, sz2_us.   
+00020260: 2063 6465 6620 696e 7420 737a 315f 646c   cdef int sz1_dl
+00020270: 732c 2073 7a32 5f64 6c73 0a20 2020 2063  s, sz2_dls.    c
+00020280: 6465 6620 696e 7420 6e5f 696d 6f64 652c  def int n_imode,
+00020290: 206e 5f64 6d6f 6465 0a20 2020 2063 6465   n_dmode.    cde
+000202a0: 6620 696e 7420 6e6c 6f73 0a20 2020 2063  f int nlos.    c
+000202b0: 6465 6620 696e 7420 6e74 3d30 2c20 6969  def int nt=0, ii
+000202c0: 2c20 6a6a 0a20 2020 2063 6465 6620 6269  , jj.    cdef bi
+000202d0: 6e74 2072 6573 5f69 735f 6c69 7374 0a20  nt res_is_list. 
+000202e0: 2020 2063 6465 6620 6269 6e74 2043 302c     cdef bint C0,
+000202f0: 2043 310a 2020 2020 6364 6566 206c 6973   C1.    cdef lis
+00020300: 7420 6c74 696d 650a 2020 2020 6364 6566  t ltime.    cdef
+00020310: 2064 6f75 626c 6520 6c6f 635f 720a 2020   double loc_r.  
+00020320: 2020 6364 6566 206c 6f6e 675b 315d 206e    cdef long[1] n
+00020330: 625f 726f 7773 0a20 2020 2063 6465 6620  b_rows.    cdef 
+00020340: 6c6f 6e67 5b3a 3a31 5d20 696e 6462 6973  long[::1] indbis
+00020350: 0a20 2020 2063 6465 6620 646f 7562 6c65  .    cdef double
+00020360: 5b31 5d20 6c6f 635f 6566 665f 7265 730a  [1] loc_eff_res.
+00020370: 2020 2020 6364 6566 2064 6f75 626c 655b      cdef double[
+00020380: 3a3a 315d 2072 6573 6566 665f 6d76 0a20  ::1] reseff_mv. 
+00020390: 2020 2063 6465 6620 646f 7562 6c65 5b3a     cdef double[:
+000203a0: 3a31 5d20 7265 735f 6d76 0a20 2020 2063  :1] res_mv.    c
+000203b0: 6465 6620 646f 7562 6c65 5b3a 2c3a 3a31  def double[:,::1
+000203c0: 5d20 7661 6c5f 6d76 0a20 2020 2063 6465  ] val_mv.    cde
+000203d0: 6620 646f 7562 6c65 5b3a 2c3a 3a31 5d20  f double[:,::1] 
+000203e0: 7074 735f 6d76 0a20 2020 2063 6465 6620  pts_mv.    cdef 
+000203f0: 646f 7562 6c65 5b3a 2c3a 3a31 5d20 7573  double[:,::1] us
+00020400: 6269 735f 6d76 0a20 2020 2063 6465 6620  bis_mv.    cdef 
+00020410: 646f 7562 6c65 5b3a 2c3a 3a31 5d20 7661  double[:,::1] va
+00020420: 6c5f 3264 0a20 2020 2063 6465 6620 6e70  l_2d.    cdef np
+00020430: 2e6e 6461 7272 6179 5b64 6f75 626c 652c  .ndarray[double,
+00020440: 6e64 696d 3d32 5d20 7573 6269 730a 2020  ndim=2] usbis.  
+00020450: 2020 6364 6566 206e 702e 6e64 6172 7261    cdef np.ndarra
+00020460: 795b 646f 7562 6c65 2c6e 6469 6d3d 325d  y[double,ndim=2]
+00020470: 2070 7473 0a20 2020 2063 6465 6620 6e70   pts.    cdef np
+00020480: 2e6e 6461 7272 6179 5b64 6f75 626c 652c  .ndarray[double,
+00020490: 6e64 696d 3d32 2c20 6d6f 6465 3d27 666f  ndim=2, mode='fo
+000204a0: 7274 7261 6e27 5d20 7369 670a 2020 2020  rtran'] sig.    
+000204b0: 6364 6566 206e 702e 6e64 6172 7261 795b  cdef np.ndarray[
+000204c0: 646f 7562 6c65 2c6e 6469 6d3d 315d 2072  double,ndim=1] r
+000204d0: 6573 6566 660a 2020 2020 6364 6566 206e  eseff.    cdef n
+000204e0: 702e 6e64 6172 7261 795b 646f 7562 6c65  p.ndarray[double
+000204f0: 2c6e 6469 6d3d 315d 206b 0a20 2020 2063  ,ndim=1] k.    c
+00020500: 6465 6620 6e70 2e6e 6461 7272 6179 5b64  def np.ndarray[d
+00020510: 6f75 626c 652c 6e64 696d 3d31 5d20 7265  ouble,ndim=1] re
+00020520: 735f 6172 720a 2020 2020 6364 6566 206e  s_arr.    cdef n
+00020530: 702e 6e64 6172 7261 795b 6c6f 6e67 2c6e  p.ndarray[long,n
+00020540: 6469 6d3d 315d 2069 6e64 0a20 2020 2063  dim=1] ind.    c
+00020550: 6465 6620 6c6f 6e67 2a20 696e 645f 6172  def long* ind_ar
+00020560: 7220 3d20 4e55 4c4c 0a20 2020 2063 6465  r = NULL.    cde
+00020570: 6620 646f 7562 6c65 2a20 7265 7365 6666  f double* reseff
+00020580: 5f61 7272 203d 204e 554c 4c0a 2020 2020  _arr = NULL.    
+00020590: 6364 6566 2064 6f75 626c 652a 2a20 636f  cdef double** co
+000205a0: 6566 665f 7074 7220 3d20 4e55 4c4c 0a20  eff_ptr = NULL. 
+000205b0: 2020 2023 202e 2e20 7261 795f 6f72 6967     # .. ray_orig
+000205c0: 2073 6861 7065 206e 6565 6465 6420 666f   shape needed fo
+000205d0: 7220 7465 7374 696e 6720 616e 6420 696e  r testing and in
+000205e0: 2061 6c67 6f20 2e2e 2e2e 2e2e 2e2e 2e2e   algo ..........
+000205f0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e0a  ................
+00020600: 2020 2020 737a 315f 6473 203d 2072 6179      sz1_ds = ray
+00020610: 5f6f 7269 672e 7368 6170 655b 305d 0a20  _orig.shape[0]. 
+00020620: 2020 206e 6c6f 7320 3d20 7261 795f 6f72     nlos = ray_or
+00020630: 6967 2e73 6861 7065 5b31 5d0a 2020 2020  ig.shape[1].    
+00020640: 7265 735f 6973 5f6c 6973 7420 3d20 6861  res_is_list = ha
+00020650: 7361 7474 7228 7265 732c 2027 5f5f 6974  sattr(res, '__it
+00020660: 6572 5f5f 2729 0a20 2020 2023 202e 2e20  er__').    # .. 
+00020670: 7665 7269 6679 696e 6720 6172 6775 6d65  verifying argume
+00020680: 6e74 7320 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  nts ............
+00020690: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+000206a0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+000206b0: 2e2e 2e2e 2e2e 2e0a 2020 2020 6966 2054  ........    if T
+000206c0: 6573 743a 0a20 2020 2020 2020 2073 7a31  est:.        sz1
+000206d0: 5f75 7320 3d20 7261 795f 7664 6972 2e73  _us = ray_vdir.s
+000206e0: 6861 7065 5b30 5d0a 2020 2020 2020 2020  hape[0].        
+000206f0: 737a 325f 7573 203d 2072 6179 5f76 6469  sz2_us = ray_vdi
+00020700: 722e 7368 6170 655b 315d 0a20 2020 2020  r.shape[1].     
+00020710: 2020 2073 7a31 5f64 6c73 203d 206c 696d     sz1_dls = lim
+00020720: 732e 7368 6170 655b 305d 0a20 2020 2020  s.shape[0].     
+00020730: 2020 2073 7a32 5f64 6c73 203d 206c 696d     sz2_dls = lim
+00020740: 732e 7368 6170 655b 315d 0a20 2020 2020  s.shape[1].     
+00020750: 2020 2061 7373 6572 7420 737a 315f 6473     assert sz1_ds
+00020760: 203d 3d20 332c 2022 4469 6d20 3020 6f66   == 3, "Dim 0 of
+00020770: 2061 7267 2072 6179 5f6f 7269 6720 7368   arg ray_orig sh
+00020780: 6f75 6c64 2062 6520 3322 0a20 2020 2020  ould be 3".     
+00020790: 2020 2061 7373 6572 7420 737a 315f 7573     assert sz1_us
+000207a0: 203d 3d20 332c 2022 4469 6d20 3020 6f66   == 3, "Dim 0 of
+000207b0: 2061 7267 2072 6179 5f76 6469 7220 7368   arg ray_vdir sh
+000207c0: 6f75 6c64 2062 6520 3322 0a20 2020 2020  ould be 3".     
+000207d0: 2020 2061 7373 6572 7420 737a 315f 646c     assert sz1_dl
+000207e0: 7320 3d3d 2032 2c20 2244 696d 2030 206f  s == 2, "Dim 0 o
+000207f0: 6620 6172 6720 6c69 6d73 2073 686f 756c  f arg lims shoul
+00020800: 6420 6265 2032 220a 2020 2020 2020 2020  d be 2".        
+00020810: 6572 726f 725f 6d65 7373 6167 6520 3d20  error_message = 
+00020820: 2822 4172 6773 2072 6179 5f6f 7269 672c  ("Args ray_orig,
+00020830: 2072 6179 5f76 6469 722c 2061 6e64 206c   ray_vdir, and l
+00020840: 696d 7320 220a 2020 2020 2020 2020 2020  ims ".          
+00020850: 2020 2020 2020 2020 2020 2020 2020 202b                 +
+00020860: 2022 7368 6f75 6c64 2068 6176 6520 7361   "should have sa
+00020870: 6d65 2064 696d 656e 7369 6f6e 2031 2229  me dimension 1")
+00020880: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00020890: 6e6c 6f73 203d 3d20 737a 325f 7573 203d  nlos == sz2_us =
+000208a0: 3d20 737a 325f 646c 732c 2065 7272 6f72  = sz2_dls, error
+000208b0: 5f6d 6573 7361 6765 0a20 2020 2020 2020  _message.       
+000208c0: 2043 3020 3d20 6e6f 7420 7265 735f 6973   C0 = not res_is
+000208d0: 5f6c 6973 7420 616e 6420 7265 7320 3e20  _list and res > 
+000208e0: 302e 0a20 2020 2020 2020 2043 3120 3d20  0..        C1 = 
+000208f0: 7265 735f 6973 5f6c 6973 7420 616e 6420  res_is_list and 
+00020900: 6c65 6e28 7265 7329 3d3d 6e6c 6f73 2061  len(res)==nlos a
+00020910: 6e64 206e 702e 616c 6c28 7265 733e 302e  nd np.all(res>0.
+00020920: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
+00020930: 2043 3020 6f72 2043 312c 2022 4172 6720   C0 or C1, "Arg 
+00020940: 7265 7320 6d75 7374 2062 6520 6120 646f  res must be a do
+00020950: 7562 6c65 206f 7220 6120 4c69 7374 2c20  uble or a List, 
+00020960: 616e 6420 616c 6c20 7265 7320 3e30 2e21  and all res >0.!
+00020970: 220a 2020 2020 2020 2020 6572 726f 725f  ".        error_
+00020980: 6d65 7373 6167 6520 3d20 2241 7267 756d  message = "Argum
+00020990: 656e 7420 646d 6574 686f 6420 2864 6973  ent dmethod (dis
+000209a0: 6372 6574 697a 6174 696f 6e20 6d65 7468  cretization meth
+000209b0: 6f64 2920 7368 6f75 6c64 2062 6520 696e  od) should be in
+000209c0: 225c 0a20 2020 2020 2020 2020 2020 2020  "\.             
+000209d0: 2020 2020 2020 2020 2020 202b 2220 5b27             +" ['
+000209e0: 6162 7327 2c27 7265 6c27 5d2c 2066 6f72  abs','rel'], for
+000209f0: 2061 6273 6f6c 7574 6520 6f72 2072 656c   absolute or rel
+00020a00: 6174 6976 652e 220a 2020 2020 2020 2020  ative.".        
+00020a10: 6173 7365 7274 2064 6d6f 6465 2069 6e20  assert dmode in 
+00020a20: 5b27 6162 7327 2c27 7265 6c27 5d2c 2065  ['abs','rel'], e
+00020a30: 7272 6f72 5f6d 6573 7361 6765 0a20 2020  rror_message.   
+00020a40: 2020 2020 2065 7272 6f72 5f6d 6573 7361       error_messa
+00020a50: 6765 203d 2022 5772 6f6e 6720 6d65 7468  ge = "Wrong meth
+00020a60: 6f64 206f 6620 696e 7465 6772 6174 696f  od of integratio
+00020a70: 6e2e 2220 5c0a 2020 2020 2020 2020 2020  n." \.          
+00020a80: 2020 2020 2020 2020 2020 2020 2020 2b20                + 
+00020a90: 2220 4f70 7469 6f6e 7320 6172 653a 205b  " Options are: [
+00020aa0: 2773 756d 272c 2773 696d 7073 272c 2772  'sum','simps','r
+00020ab0: 6f6d 6227 5d22 0a20 2020 2020 2020 2061  omb']".        a
+00020ac0: 7373 6572 7420 696d 6f64 6520 696e 205b  ssert imode in [
+00020ad0: 2773 756d 272c 2773 696d 7073 272c 2772  'sum','simps','r
+00020ae0: 6f6d 6227 5d2c 2065 7272 6f72 5f6d 6573  omb'], error_mes
+00020af0: 7361 6765 0a20 2020 2020 2020 2065 7272  sage.        err
+00020b00: 6f72 5f6d 6573 7361 6765 203d 2022 5772  or_message = "Wr
+00020b10: 6f6e 6720 6d69 6e69 6d69 7a65 206f 7074  ong minimize opt
+00020b20: 696d 697a 6174 696f 6e2e 225c 0a20 2020  imization."\.   
+00020b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020b40: 2020 2020 202b 2022 204f 7074 696f 6e73       + " Options
+00020b50: 2061 7265 3a20 5b27 6361 6c6c 7327 2c27   are: ['calls','
+00020b60: 6d65 6d6f 7279 272c 2768 7962 7269 6427  memory','hybrid'
+00020b70: 5d22 0a20 2020 2020 2020 2061 7373 6572  ]".        asser
+00020b80: 7420 6d69 6e69 6d20 696e 205b 2763 616c  t minim in ['cal
+00020b90: 6c73 272c 276d 656d 6f72 7927 2c27 6879  ls','memory','hy
+00020ba0: 6272 6964 275d 2c20 6572 726f 725f 6d65  brid'], error_me
+00020bb0: 7373 6167 650a 2020 2020 2320 2d2d 2050  ssage.    # -- P
+00020bc0: 7265 666f 726d 6174 206f 7574 7075 7420  reformat output 
+00020bd0: 7369 676e 616c 202d 2d2d 2d2d 2d2d 2d2d  signal ---------
+00020be0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00020bf0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00020c00: 2d2d 2d2d 2d2d 0a20 2020 2069 6620 7420  ------.    if t 
+00020c10: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+00020c20: 2069 6620 6d69 6e69 6d20 3d3d 2027 6d65   if minim == 'me
+00020c30: 6d6f 7279 273a 0a20 2020 2020 2020 2020  mory':.         
+00020c40: 2020 206d 696e 696d 203d 2027 6361 6c6c     minim = 'call
+00020c50: 7327 0a20 2020 2020 2020 2020 2020 2065  s'.            e
+00020c60: 7272 6f72 5f6d 6573 7361 6765 203d 2022  rror_message = "
+00020c70: 4966 2074 2069 7320 4e6f 6e65 2021 220a  If t is None !".
+00020c80: 2020 2020 2020 2020 2020 2020 6572 726f              erro
+00020c90: 725f 6d65 7373 6167 6520 2b3d 2022 2020  r_message += "  
+00020ca0: 3d3e 2074 6865 7265 2069 7320 6e6f 2070  => there is no p
+00020cb0: 6f69 6e74 2069 6e20 7573 696e 6720 6d69  oint in using mi
+00020cc0: 6e69 6d69 7a65 3d27 6d65 6d6f 7279 2722  nimize='memory'"
+00020cd0: 0a20 2020 2020 2020 2020 2020 2065 7272  .            err
+00020ce0: 6f72 5f6d 6573 7361 6765 202b 3d20 2220  or_message += " 
+00020cf0: 203d 3e20 7377 6974 6368 696e 6720 746f   => switching to
+00020d00: 206d 696e 696d 697a 6520 3d20 2725 7327   minimize = '%s'
+00020d10: 2225 6d69 6e69 6d0a 2020 2020 2020 2020  "%minim.        
+00020d20: 2020 2020 7761 726e 2865 7272 6f72 5f6d      warn(error_m
+00020d30: 6573 7361 6765 290a 2020 2020 2020 2020  essage).        
+00020d40: 6e74 203d 2031 0a20 2020 2020 2020 206c  nt = 1.        l
+00020d50: 7469 6d65 203d 205b 4e6f 6e65 5d0a 2020  time = [None].  
+00020d60: 2020 656c 6966 206e 6f74 2068 6173 6174    elif not hasat
+00020d70: 7472 2874 2c27 5f5f 6974 6572 5f5f 2729  tr(t,'__iter__')
+00020d80: 3a0a 2020 2020 2020 2020 6e74 203d 2031  :.        nt = 1
+00020d90: 0a20 2020 2020 2020 206c 7469 6d65 203d  .        ltime =
+00020da0: 205b 745d 0a20 2020 2065 6c73 653a 0a20   [t].    else:. 
+00020db0: 2020 2020 2020 206e 7420 3d20 6c65 6e28         nt = len(
+00020dc0: 7429 0a20 2020 2020 2020 2069 6620 6973  t).        if is
+00020dd0: 696e 7374 616e 6365 2874 2c20 6c69 7374  instance(t, list
+00020de0: 293a 0a20 2020 2020 2020 2020 2020 206c  ):.            l
+00020df0: 7469 6d65 203d 2074 0a20 2020 2020 2020  time = t.       
+00020e00: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00020e10: 2020 206c 7469 6d65 203d 2074 2e74 6f6c     ltime = t.tol
+00020e20: 6973 7428 290a 2020 2020 2320 2d2d 2049  ist().    # -- I
+00020e30: 6e69 7a69 616c 697a 6174 696f 6e73 202d  nizializations -
+00020e40: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00020e50: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00020e60: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00020e70: 2d2d 2d2d 2d2d 0a20 2020 2023 2047 6574  ------.    # Get
+00020e80: 7469 6e67 206e 756d 6265 7220 6f66 206d  ting number of m
+00020e90: 6f64 6573 3a0a 2020 2020 6e5f 646d 6f64  odes:.    n_dmod
+00020ea0: 6520 3d20 5f73 742e 6765 745f 6e62 5f64  e = _st.get_nb_d
+00020eb0: 6d6f 6465 2864 6d6f 6465 290a 2020 2020  mode(dmode).    
+00020ec0: 6e5f 696d 6f64 6520 3d20 5f73 742e 6765  n_imode = _st.ge
+00020ed0: 745f 6e62 5f69 6d6f 6465 2869 6d6f 6465  t_nb_imode(imode
+00020ee0: 290a 2020 2020 2320 496e 6974 6961 6c69  ).    # Initiali
+00020ef0: 7a61 7469 6f6e 2072 6573 756c 740a 2020  zation result.  
+00020f00: 2020 7369 6720 3d20 6e70 2e65 6d70 7479    sig = np.empty
+00020f10: 2828 6e74 2c20 6e6c 6f73 292c 2064 7479  ((nt, nlos), dty
+00020f20: 7065 3d66 6c6f 6174 2c20 6f72 6465 723d  pe=float, order=
+00020f30: 2746 2729 0a20 2020 2023 2049 6620 7468  'F').    # If th
+00020f40: 6520 7265 736f 6c75 7469 6f6e 2069 7320  e resolution is 
+00020f50: 7468 6520 7361 6d65 2066 6f72 2065 7665  the same for eve
+00020f60: 7279 204c 4f53 2c20 7765 2063 7265 6174  ry LOS, we creat
+00020f70: 6520 6120 7461 620a 2020 2020 6966 2072  e a tab.    if r
+00020f80: 6573 5f69 735f 6c69 7374 203a 0a20 2020  es_is_list :.   
+00020f90: 2020 2020 2072 6573 5f61 7272 203d 206e       res_arr = n
+00020fa0: 702e 6173 6172 7261 7928 7265 7329 0a20  p.asarray(res). 
+00020fb0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00020fc0: 2072 6573 5f61 7272 203d 206e 702e 6f6e   res_arr = np.on
+00020fd0: 6573 2828 6e6c 6f73 2c29 2c20 6474 7970  es((nlos,), dtyp
+00020fe0: 653d 666c 6f61 7429 202a 2072 6573 0a20  e=float) * res. 
+00020ff0: 2020 2072 6573 5f6d 7620 3d20 7265 735f     res_mv = res_
+00021000: 6172 720a 2020 2020 2320 2d2d 2d2d 2d2d  arr.    # ------
 00021010: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00021020: 2d2d 2d2d 2d0a 2020 2020 2320 4d69 6e69  -----.    # Mini
-00021030: 6d69 7a65 2066 756e 6374 696f 6e20 6361  mize function ca
-00021040: 6c6c 733a 2073 616d 706c 6520 2876 6563  lls: sample (vec
-00021050: 7429 2c20 6361 6c6c 2028 6f6e 6365 2920  t), call (once) 
-00021060: 616e 6420 696e 7465 6772 6174 650a 2020  and integrate.  
-00021070: 2020 6966 206d 696e 696d 203d 3d20 2763    if minim == 'c
-00021080: 616c 6c73 273a 0a20 2020 2020 2020 2069  alls':.        i
-00021090: 6620 6e5f 696d 6f64 6520 213d 2030 3a0a  f n_imode != 0:.
-000210a0: 2020 2020 2020 2020 2020 2020 2320 496e              # In
-000210b0: 7465 6772 6174 696f 6e20 6d6f 6465 2069  tegration mode i
-000210c0: 7320 5369 6d70 736f 6e20 6f72 2052 6f6d  s Simpson or Rom
-000210d0: 6265 7267 0a20 2020 2020 2020 2020 2020  berg.           
-000210e0: 2023 2044 6973 6372 6574 697a 6520 616c   # Discretize al
-000210f0: 6c20 4c4f 530a 2020 2020 2020 2020 2020  l LOS.          
-00021100: 2020 6b2c 2072 6573 6566 662c 2069 6e64    k, reseff, ind
-00021110: 203d 204c 4f53 5f67 6574 5f73 616d 706c   = LOS_get_sampl
-00021120: 6528 6e6c 6f73 2c20 7265 735f 6172 722c  e(nlos, res_arr,
-00021130: 206c 696d 732c 0a20 2020 2020 2020 2020   lims,.         
-00021140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021160: 2020 2064 6d65 7468 6f64 3d64 6d6f 6465     dmethod=dmode
-00021170: 2c20 6d65 7468 6f64 3d69 6d6f 6465 2c0a  , method=imode,.
+00021020: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00021030: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00021040: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00021050: 2d2d 2d2d 0a20 2020 2023 204d 696e 696d  ----.    # Minim
+00021060: 697a 6520 6675 6e63 7469 6f6e 2063 616c  ize function cal
+00021070: 6c73 3a20 7361 6d70 6c65 2028 7665 6374  ls: sample (vect
+00021080: 292c 2063 616c 6c20 286f 6e63 6529 2061  ), call (once) a
+00021090: 6e64 2069 6e74 6567 7261 7465 0a20 2020  nd integrate.   
+000210a0: 2069 6620 6d69 6e69 6d20 3d3d 2027 6361   if minim == 'ca
+000210b0: 6c6c 7327 3a0a 2020 2020 2020 2020 6966  lls':.        if
+000210c0: 206e 5f69 6d6f 6465 2021 3d20 303a 0a20   n_imode != 0:. 
+000210d0: 2020 2020 2020 2020 2020 2023 2049 6e74             # Int
+000210e0: 6567 7261 7469 6f6e 206d 6f64 6520 6973  egration mode is
+000210f0: 2053 696d 7073 6f6e 206f 7220 526f 6d62   Simpson or Romb
+00021100: 6572 670a 2020 2020 2020 2020 2020 2020  erg.            
+00021110: 2320 4469 7363 7265 7469 7a65 2061 6c6c  # Discretize all
+00021120: 204c 4f53 0a20 2020 2020 2020 2020 2020   LOS.           
+00021130: 206b 2c20 7265 7365 6666 2c20 696e 6420   k, reseff, ind 
+00021140: 3d20 4c4f 535f 6765 745f 7361 6d70 6c65  = LOS_get_sample
+00021150: 286e 6c6f 732c 2072 6573 5f61 7272 2c20  (nlos, res_arr, 
+00021160: 6c69 6d73 2c0a 2020 2020 2020 2020 2020  lims,.          
+00021170: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00021180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000211a0: 2020 2020 2020 2020 2020 2020 6e75 6d5f              num_
-000211b0: 7468 7265 6164 733d 6e75 6d5f 7468 7265  threads=num_thre
-000211c0: 6164 732c 2054 6573 743d 5465 7374 290a  ads, Test=Test).
-000211d0: 2020 2020 2020 2020 2020 2020 6e62 7265              nbre
-000211e0: 7020 3d20 6e70 2e72 5f5b 696e 645b 305d  p = np.r_[ind[0]
-000211f0: 2c20 6e70 2e64 6966 6628 696e 6429 2c20  , np.diff(ind), 
-00021200: 6b2e 7369 7a65 202d 2069 6e64 5b6e 6c6f  k.size - ind[nlo
-00021210: 732d 325d 5d0a 2020 2020 2020 2020 2020  s-2]].          
-00021220: 2020 2320 6765 7420 7074 7320 616e 6420    # get pts and 
-00021230: 7661 6c75 6573 0a20 2020 2020 2020 2020  values.         
-00021240: 2020 2075 7362 6973 203d 206e 702e 7265     usbis = np.re
-00021250: 7065 6174 2872 6179 5f76 6469 722c 206e  peat(ray_vdir, n
-00021260: 6272 6570 2c20 6178 6973 3d31 290a 2020  brep, axis=1).  
-00021270: 2020 2020 2020 2020 2020 7074 7320 3d20            pts = 
-00021280: 6e70 2e72 6570 6561 7428 7261 795f 6f72  np.repeat(ray_or
-00021290: 6967 2c20 6e62 7265 702c 2061 7869 733d  ig, nbrep, axis=
-000212a0: 3129 202b 206b 5b4e 6f6e 652c 203a 5d2a  1) + k[None, :]*
-000212b0: 7573 6269 730a 2020 2020 2020 2020 2020  usbis.          
-000212c0: 2020 2320 6d65 6d6f 7279 2076 6965 773a    # memory view:
-000212d0: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
-000212e0: 6566 665f 6d76 203d 2072 6573 6566 660a  eff_mv = reseff.
-000212f0: 2020 2020 2020 2020 2020 2020 696e 6462              indb
-00021300: 6973 203d 206e 702e 636f 6e63 6174 656e  is = np.concaten
-00021310: 6174 6528 285b 305d 2c69 6e64 2c5b 6b2e  ate(([0],ind,[k.
-00021320: 7369 7a65 5d29 290a 2020 2020 2020 2020  size])).        
-00021330: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00021340: 2020 636f 6566 665f 7074 7220 3d20 3c64    coeff_ptr = <d
-00021350: 6f75 626c 652a 2a3e 6d61 6c6c 6f63 2873  ouble**>malloc(s
-00021360: 697a 656f 6628 646f 7562 6c65 2a29 290a  izeof(double*)).
-00021370: 2020 2020 2020 2020 2020 2020 636f 6566              coef
-00021380: 665f 7074 725b 305d 203d 204e 554c 4c0a  f_ptr[0] = NULL.
-00021390: 2020 2020 2020 2020 2020 2020 7265 7365              rese
-000213a0: 6666 5f61 7272 203d 203c 646f 7562 6c65  ff_arr = <double
-000213b0: 2a3e 6d61 6c6c 6f63 286e 6c6f 732a 7369  *>malloc(nlos*si
-000213c0: 7a65 6f66 2864 6f75 626c 6529 290a 2020  zeof(double)).  
-000213d0: 2020 2020 2020 2020 2020 696e 645f 6172            ind_ar
-000213e0: 7220 3d20 3c6c 6f6e 672a 3e6d 616c 6c6f  r = <long*>mallo
-000213f0: 6328 6e6c 6f73 2a73 697a 656f 6628 6c6f  c(nlos*sizeof(lo
-00021400: 6e67 2929 0a20 2020 2020 2020 2020 2020  ng)).           
-00021410: 2023 202e 2e20 7765 2073 616d 706c 6520   # .. we sample 
-00021420: 6c69 6e65 7320 6f66 2073 6967 6874 202e  lines of sight .
-00021430: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00021440: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00021450: 2e2e 2e2e 2e0a 2020 2020 2020 2020 2020  ......          
-00021460: 2020 5f73 742e 6c6f 735f 6765 745f 7361    _st.los_get_sa
-00021470: 6d70 6c65 5f63 6f72 655f 7661 725f 7265  mple_core_var_re
-00021480: 7328 6e6c 6f73 2c0a 2020 2020 2020 2020  s(nlos,.        
-00021490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000214a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000214b0: 2020 2020 266c 696d 735b 302c 2030 5d2c      &lims[0, 0],
-000214c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021190: 2020 646d 6574 686f 643d 646d 6f64 652c    dmethod=dmode,
+000211a0: 206d 6574 686f 643d 696d 6f64 652c 0a20   method=imode,. 
+000211b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000211c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000211d0: 2020 2020 2020 2020 2020 206e 756d 5f74             num_t
+000211e0: 6872 6561 6473 3d6e 756d 5f74 6872 6561  hreads=num_threa
+000211f0: 6473 2c20 5465 7374 3d54 6573 7429 0a20  ds, Test=Test). 
+00021200: 2020 2020 2020 2020 2020 206e 6272 6570             nbrep
+00021210: 203d 206e 702e 725f 5b69 6e64 5b30 5d2c   = np.r_[ind[0],
+00021220: 206e 702e 6469 6666 2869 6e64 292c 206b   np.diff(ind), k
+00021230: 2e73 697a 6520 2d20 696e 645b 6e6c 6f73  .size - ind[nlos
+00021240: 2d32 5d5d 0a20 2020 2020 2020 2020 2020  -2]].           
+00021250: 2023 2067 6574 2070 7473 2061 6e64 2076   # get pts and v
+00021260: 616c 7565 730a 2020 2020 2020 2020 2020  alues.          
+00021270: 2020 7573 6269 7320 3d20 6e70 2e72 6570    usbis = np.rep
+00021280: 6561 7428 7261 795f 7664 6972 2c20 6e62  eat(ray_vdir, nb
+00021290: 7265 702c 2061 7869 733d 3129 0a20 2020  rep, axis=1).   
+000212a0: 2020 2020 2020 2020 2070 7473 203d 206e           pts = n
+000212b0: 702e 7265 7065 6174 2872 6179 5f6f 7269  p.repeat(ray_ori
+000212c0: 672c 206e 6272 6570 2c20 6178 6973 3d31  g, nbrep, axis=1
+000212d0: 2920 2b20 6b5b 4e6f 6e65 2c20 3a5d 2a75  ) + k[None, :]*u
+000212e0: 7362 6973 0a20 2020 2020 2020 2020 2020  sbis.           
+000212f0: 2023 206d 656d 6f72 7920 7669 6577 3a0a   # memory view:.
+00021300: 2020 2020 2020 2020 2020 2020 7265 7365              rese
+00021310: 6666 5f6d 7620 3d20 7265 7365 6666 0a20  ff_mv = reseff. 
+00021320: 2020 2020 2020 2020 2020 2069 6e64 6269             indbi
+00021330: 7320 3d20 6e70 2e63 6f6e 6361 7465 6e61  s = np.concatena
+00021340: 7465 2828 5b30 5d2c 696e 642c 5b6b 2e73  te(([0],ind,[k.s
+00021350: 697a 655d 2929 0a20 2020 2020 2020 2065  ize])).        e
+00021360: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00021370: 2063 6f65 6666 5f70 7472 203d 203c 646f   coeff_ptr = <do
+00021380: 7562 6c65 2a2a 3e6d 616c 6c6f 6328 7369  uble**>malloc(si
+00021390: 7a65 6f66 2864 6f75 626c 652a 2929 0a20  zeof(double*)). 
+000213a0: 2020 2020 2020 2020 2020 2063 6f65 6666             coeff
+000213b0: 5f70 7472 5b30 5d20 3d20 4e55 4c4c 0a20  _ptr[0] = NULL. 
+000213c0: 2020 2020 2020 2020 2020 2072 6573 6566             resef
+000213d0: 665f 6172 7220 3d20 3c64 6f75 626c 652a  f_arr = <double*
+000213e0: 3e6d 616c 6c6f 6328 6e6c 6f73 2a73 697a  >malloc(nlos*siz
+000213f0: 656f 6628 646f 7562 6c65 2929 0a20 2020  eof(double)).   
+00021400: 2020 2020 2020 2020 2069 6e64 5f61 7272           ind_arr
+00021410: 203d 203c 6c6f 6e67 2a3e 6d61 6c6c 6f63   = <long*>malloc
+00021420: 286e 6c6f 732a 7369 7a65 6f66 286c 6f6e  (nlos*sizeof(lon
+00021430: 6729 290a 2020 2020 2020 2020 2020 2020  g)).            
+00021440: 2320 2e2e 2077 6520 7361 6d70 6c65 206c  # .. we sample l
+00021450: 696e 6573 206f 6620 7369 6768 7420 2e2e  ines of sight ..
+00021460: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00021470: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00021480: 2e2e 2e2e 0a20 2020 2020 2020 2020 2020  .....           
+00021490: 205f 7374 2e6c 6f73 5f67 6574 5f73 616d   _st.los_get_sam
+000214a0: 706c 655f 636f 7265 5f76 6172 5f72 6573  ple_core_var_res
+000214b0: 286e 6c6f 732c 0a20 2020 2020 2020 2020  (nlos,.         
+000214c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000214d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000214e0: 2020 2020 2020 2020 2020 2020 2026 6c69               &li
-000214f0: 6d73 5b31 2c20 305d 2c0a 2020 2020 2020  ms[1, 0],.      
+000214e0: 2020 2026 6c69 6d73 5b30 2c20 305d 2c0a     &lims[0, 0],.
+000214f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00021500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021520: 2020 2020 2020 6e5f 646d 6f64 652c 206e        n_dmode, n
-00021530: 5f69 6d6f 6465 2c0a 2020 2020 2020 2020  _imode,.        
+00021510: 2020 2020 2020 2020 2020 2020 266c 696d              &lim
+00021520: 735b 312c 2030 5d2c 0a20 2020 2020 2020  s[1, 0],.       
+00021530: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00021540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021560: 2020 2020 2672 6573 5f61 7272 5b30 5d2c      &res_arr[0],
-00021570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021550: 2020 2020 206e 5f64 6d6f 6465 2c20 6e5f       n_dmode, n_
+00021560: 696d 6f64 652c 0a20 2020 2020 2020 2020  imode,.         
+00021570: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00021580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021590: 2020 2020 2020 2020 2020 2020 2026 636f               &co
-000215a0: 6566 665f 7074 725b 305d 2c0a 2020 2020  eff_ptr[0],.    
+00021590: 2020 2026 7265 735f 6172 725b 305d 2c0a     &res_arr[0],.
+000215a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000215b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000215c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000215d0: 2020 2020 2020 2020 2672 6573 6566 665f          &reseff_
-000215e0: 6172 725b 305d 2c0a 2020 2020 2020 2020  arr[0],.        
+000215c0: 2020 2020 2020 2020 2020 2020 2663 6f65              &coe
+000215d0: 6666 5f70 7472 5b30 5d2c 0a20 2020 2020  ff_ptr[0],.     
+000215e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000215f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021610: 2020 2020 2669 6e64 5f61 7272 5b30 5d2c      &ind_arr[0],
-00021620: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021600: 2020 2020 2020 2026 7265 7365 6666 5f61         &reseff_a
+00021610: 7272 5b30 5d2c 0a20 2020 2020 2020 2020  rr[0],.         
+00021620: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00021630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021640: 2020 2020 2020 2020 2020 2020 206e 756d               num
-00021650: 5f74 6872 6561 6473 290a 2020 2020 2020  _threads).      
-00021660: 2020 2020 2020 737a 5f63 6f65 6666 203d        sz_coeff =
-00021670: 2069 6e64 5f61 7272 5b6e 6c6f 732d 315d   ind_arr[nlos-1]
-00021680: 0a20 2020 2020 2020 2020 2020 2070 7473  .            pts
-00021690: 203d 206e 702e 656d 7074 7928 2833 2c73   = np.empty((3,s
-000216a0: 7a5f 636f 6566 6629 290a 2020 2020 2020  z_coeff)).      
-000216b0: 2020 2020 2020 7573 6269 7320 3d20 6e70        usbis = np
-000216c0: 2e65 6d70 7479 2828 332c 737a 5f63 6f65  .empty((3,sz_coe
-000216d0: 6666 2929 0a20 2020 2020 2020 2020 2020  ff)).           
-000216e0: 2075 7362 6973 5f6d 7620 3d20 7573 6269   usbis_mv = usbi
-000216f0: 730a 2020 2020 2020 2020 2020 2020 7074  s.            pt
-00021700: 735f 6d76 203d 2070 7473 0a20 2020 2020  s_mv = pts.     
-00021710: 2020 2020 2020 205f 7374 2e6c 6f73 5f67         _st.los_g
-00021720: 6574 5f73 616d 706c 655f 7074 7328 6e6c  et_sample_pts(nl
-00021730: 6f73 2c0a 2020 2020 2020 2020 2020 2020  os,.            
-00021740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021750: 2020 2020 2020 2026 7074 735f 6d76 5b30         &pts_mv[0
-00021760: 2c30 5d2c 0a20 2020 2020 2020 2020 2020  ,0],.           
+00021640: 2020 2026 696e 645f 6172 725b 305d 2c0a     &ind_arr[0],.
+00021650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021670: 2020 2020 2020 2020 2020 2020 6e75 6d5f              num_
+00021680: 7468 7265 6164 7329 0a20 2020 2020 2020  threads).       
+00021690: 2020 2020 2073 7a5f 636f 6566 6620 3d20       sz_coeff = 
+000216a0: 696e 645f 6172 725b 6e6c 6f73 2d31 5d0a  ind_arr[nlos-1].
+000216b0: 2020 2020 2020 2020 2020 2020 7074 7320              pts 
+000216c0: 3d20 6e70 2e65 6d70 7479 2828 332c 737a  = np.empty((3,sz
+000216d0: 5f63 6f65 6666 2929 0a20 2020 2020 2020  _coeff)).       
+000216e0: 2020 2020 2075 7362 6973 203d 206e 702e       usbis = np.
+000216f0: 656d 7074 7928 2833 2c73 7a5f 636f 6566  empty((3,sz_coef
+00021700: 6629 290a 2020 2020 2020 2020 2020 2020  f)).            
+00021710: 7573 6269 735f 6d76 203d 2075 7362 6973  usbis_mv = usbis
+00021720: 0a20 2020 2020 2020 2020 2020 2070 7473  .            pts
+00021730: 5f6d 7620 3d20 7074 730a 2020 2020 2020  _mv = pts.      
+00021740: 2020 2020 2020 5f73 742e 6c6f 735f 6765        _st.los_ge
+00021750: 745f 7361 6d70 6c65 5f70 7473 286e 6c6f  t_sample_pts(nlo
+00021760: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
 00021770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021780: 2020 2020 2020 2020 2670 7473 5f6d 765b          &pts_mv[
-00021790: 312c 305d 2c0a 2020 2020 2020 2020 2020  1,0],.          
+00021780: 2020 2020 2020 2670 7473 5f6d 765b 302c        &pts_mv[0,
+00021790: 305d 2c0a 2020 2020 2020 2020 2020 2020  0],.            
 000217a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000217b0: 2020 2020 2020 2020 2026 7074 735f 6d76           &pts_mv
-000217c0: 5b32 2c30 5d2c 0a20 2020 2020 2020 2020  [2,0],.         
+000217b0: 2020 2020 2020 2026 7074 735f 6d76 5b31         &pts_mv[1
+000217c0: 2c30 5d2c 0a20 2020 2020 2020 2020 2020  ,0],.           
 000217d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000217e0: 2020 2020 2020 2020 2020 2675 7362 6973            &usbis
-000217f0: 5f6d 765b 302c 305d 2c0a 2020 2020 2020  _mv[0,0],.      
+000217e0: 2020 2020 2020 2020 2670 7473 5f6d 765b          &pts_mv[
+000217f0: 322c 305d 2c0a 2020 2020 2020 2020 2020  2,0],.          
 00021800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021810: 2020 2020 2020 2020 2020 2020 2026 7573               &us
-00021820: 6269 735f 6d76 5b31 2c30 5d2c 0a20 2020  bis_mv[1,0],.   
+00021810: 2020 2020 2020 2020 2026 7573 6269 735f           &usbis_
+00021820: 6d76 5b30 2c30 5d2c 0a20 2020 2020 2020  mv[0,0],.       
 00021830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021850: 2675 7362 6973 5f6d 765b 322c 305d 2c0a  &usbis_mv[2,0],.
+00021840: 2020 2020 2020 2020 2020 2020 2675 7362              &usb
+00021850: 6973 5f6d 765b 312c 305d 2c0a 2020 2020  is_mv[1,0],.    
 00021860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021880: 2020 2072 6179 5f6f 7269 672c 2072 6179     ray_orig, ray
-00021890: 5f76 6469 722c 0a20 2020 2020 2020 2020  _vdir,.         
+00021870: 2020 2020 2020 2020 2020 2020 2020 2026                 &
+00021880: 7573 6269 735f 6d76 5b32 2c30 5d2c 0a20  usbis_mv[2,0],. 
+00021890: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000218a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000218b0: 2020 2020 2020 2020 2020 636f 6566 665f            coeff_
-000218c0: 7074 725b 305d 2c0a 2020 2020 2020 2020  ptr[0],.        
+000218b0: 2020 7261 795f 6f72 6967 2c20 7261 795f    ray_orig, ray_
+000218c0: 7664 6972 2c0a 2020 2020 2020 2020 2020  vdir,.          
 000218d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000218e0: 2020 2020 2020 2020 2020 2069 6e64 5f61             ind_a
-000218f0: 7272 2c0a 2020 2020 2020 2020 2020 2020  rr,.            
+000218e0: 2020 2020 2020 2020 2063 6f65 6666 5f70           coeff_p
+000218f0: 7472 5b30 5d2c 0a20 2020 2020 2020 2020  tr[0],.         
 00021900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021910: 2020 2020 2020 206e 756d 5f74 6872 6561         num_threa
-00021920: 6473 290a 2020 2020 2020 2020 2020 2020  ds).            
-00021930: 2320 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  # ..............
-00021940: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00021950: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00021960: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00021970: 2e2e 2e2e 0a20 2020 2020 2020 2069 6620  .....        if 
-00021980: 616e 693a 0a20 2020 2020 2020 2020 2020  ani:.           
-00021990: 2076 616c 5f32 6420 3d20 6675 6e63 2870   val_2d = func(p
-000219a0: 7473 2c20 743d 742c 2076 6563 743d 2d75  ts, t=t, vect=-u
-000219b0: 7362 6973 2c20 2a2a 666b 7764 6172 6773  sbis, **fkwdargs
-000219c0: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-000219d0: 2020 2020 2020 2020 2020 2020 7661 6c5f              val_
-000219e0: 3264 203d 2066 756e 6328 7074 732c 2074  2d = func(pts, t
-000219f0: 3d74 2c20 2a2a 666b 7764 6172 6773 290a  =t, **fkwdargs).
-00021a00: 0a20 2020 2020 2020 2023 2049 6e74 6567  .        # Integ
-00021a10: 7261 7465 0a20 2020 2020 2020 2069 6620  rate.        if 
-00021a20: 6e5f 696d 6f64 6520 3d3d 2030 3a20 2023  n_imode == 0:  #
-00021a30: 2022 7375 6d22 2069 6e74 6567 7261 7469   "sum" integrati
-00021a40: 6f6e 206d 6f64 650a 2020 2020 2020 2020  on mode.        
-00021a50: 2020 2020 2320 2e2e 2069 6e74 6567 7261      # .. integra
-00021a60: 7469 6e67 2066 756e 6374 696f 6e20 2e2e  ting function ..
-00021a70: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00021a80: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00021a90: 2e2e 2e2e 2e2e 2e2e 0a20 2020 2020 2020  .........       
-00021aa0: 2020 2020 2072 6573 6566 6673 203d 206e       reseffs = n
-00021ab0: 702e 636f 7079 286e 702e 6173 6172 7261  p.copy(np.asarra
-00021ac0: 7928 3c64 6f75 626c 655b 3a6e 6c6f 735d  y(<double[:nlos]
-00021ad0: 3e72 6573 6566 665f 6172 7229 290a 2020  >reseff_arr)).  
-00021ae0: 2020 2020 2020 2020 2020 696e 6469 6365            indice
-00021af0: 7320 3d20 6e70 2e63 6f70 7928 6e70 2e61  s = np.copy(np.a
-00021b00: 7361 7272 6179 283c 6c6f 6e67 5b3a 6e6c  sarray(<long[:nl
-00021b10: 6f73 2d31 5d3e 696e 645f 6172 7229 2e61  os-1]>ind_arr).a
-00021b20: 7374 7970 6528 696e 7429 290a 2020 2020  stype(int)).    
-00021b30: 2020 2020 2020 2020 7369 6720 3d20 6e70          sig = np
-00021b40: 2e61 7366 6f72 7472 616e 6172 7261 7928  .asfortranarray(
-00021b50: 6e70 2e61 6464 2e72 6564 7563 6561 7428  np.add.reduceat(
-00021b60: 7661 6c5f 3264 2c0a 2020 2020 2020 2020  val_2d,.        
-00021b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021b90: 2020 2020 2020 2020 2020 2020 6e70 2e72              np.r
-00021ba0: 5f5b 302c 2069 6e64 6963 6573 5d2c 0a20  _[0, indices],. 
+00021910: 2020 2020 2020 2020 2020 696e 645f 6172            ind_ar
+00021920: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
+00021930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021940: 2020 2020 2020 6e75 6d5f 7468 7265 6164        num_thread
+00021950: 7329 0a20 2020 2020 2020 2020 2020 2023  s).            #
+00021960: 202e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e   ...............
+00021970: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00021980: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00021990: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+000219a0: 2e2e 2e0a 2020 2020 2020 2020 6966 2061  ....        if a
+000219b0: 6e69 3a0a 2020 2020 2020 2020 2020 2020  ni:.            
+000219c0: 7661 6c5f 3264 203d 2066 756e 6328 7074  val_2d = func(pt
+000219d0: 732c 2074 3d74 2c20 7665 6374 3d2d 7573  s, t=t, vect=-us
+000219e0: 6269 732c 202a 2a66 6b77 6461 7267 7329  bis, **fkwdargs)
+000219f0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00021a00: 2020 2020 2020 2020 2020 2076 616c 5f32             val_2
+00021a10: 6420 3d20 6675 6e63 2870 7473 2c20 743d  d = func(pts, t=
+00021a20: 742c 202a 2a66 6b77 6461 7267 7329 0a0a  t, **fkwdargs)..
+00021a30: 2020 2020 2020 2020 2320 496e 7465 6772          # Integr
+00021a40: 6174 650a 2020 2020 2020 2020 6966 206e  ate.        if n
+00021a50: 5f69 6d6f 6465 203d 3d20 303a 2020 2320  _imode == 0:  # 
+00021a60: 2273 756d 2220 696e 7465 6772 6174 696f  "sum" integratio
+00021a70: 6e20 6d6f 6465 0a20 2020 2020 2020 2020  n mode.         
+00021a80: 2020 2023 202e 2e20 696e 7465 6772 6174     # .. integrat
+00021a90: 696e 6720 6675 6e63 7469 6f6e 202e 2e2e  ing function ...
+00021aa0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00021ab0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00021ac0: 2e2e 2e2e 2e2e 2e0a 2020 2020 2020 2020  ........        
+00021ad0: 2020 2020 7265 7365 6666 7320 3d20 6e70      reseffs = np
+00021ae0: 2e63 6f70 7928 6e70 2e61 7361 7272 6179  .copy(np.asarray
+00021af0: 283c 646f 7562 6c65 5b3a 6e6c 6f73 5d3e  (<double[:nlos]>
+00021b00: 7265 7365 6666 5f61 7272 2929 0a20 2020  reseff_arr)).   
+00021b10: 2020 2020 2020 2020 2069 6e64 6963 6573           indices
+00021b20: 203d 206e 702e 636f 7079 286e 702e 6173   = np.copy(np.as
+00021b30: 6172 7261 7928 3c6c 6f6e 675b 3a6e 6c6f  array(<long[:nlo
+00021b40: 732d 315d 3e69 6e64 5f61 7272 292e 6173  s-1]>ind_arr).as
+00021b50: 7479 7065 2869 6e74 2929 0a20 2020 2020  type(int)).     
+00021b60: 2020 2020 2020 2073 6967 203d 206e 702e         sig = np.
+00021b70: 6173 666f 7274 7261 6e61 7272 6179 286e  asfortranarray(n
+00021b80: 702e 6164 642e 7265 6475 6365 6174 2876  p.add.reduceat(v
+00021b90: 616c 5f32 642c 0a20 2020 2020 2020 2020  al_2d,.         
+00021ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00021bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021be0: 2020 2061 7869 733d 2d31 290a 2020 2020     axis=-1).    
+00021bc0: 2020 2020 2020 2020 2020 206e 702e 725f             np.r_
+00021bd0: 5b30 2c20 696e 6469 6365 735d 2c0a 2020  [0, indices],.  
+00021be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00021bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00021c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021c10: 2a20 7265 7365 6666 735b 4e6f 6e65 2c20  * reseffs[None, 
-00021c20: 3a5d 290a 2020 2020 2020 2020 2020 2020  :]).            
-00021c30: 2320 436c 6561 6e69 6e67 2075 702e 2e2e  # Cleaning up...
-00021c40: 0a20 2020 2020 2020 2020 2020 2066 7265  .            fre
-00021c50: 6528 636f 6566 665f 7074 725b 305d 290a  e(coeff_ptr[0]).
-00021c60: 2020 2020 2020 2020 2020 2020 6672 6565              free
-00021c70: 2863 6f65 6666 5f70 7472 290a 2020 2020  (coeff_ptr).    
-00021c80: 2020 2020 2020 2020 6672 6565 2872 6573          free(res
-00021c90: 6566 665f 6172 7229 0a20 2020 2020 2020  eff_arr).       
-00021ca0: 2020 2020 2066 7265 6528 696e 645f 6172       free(ind_ar
-00021cb0: 7229 0a20 2020 2020 2020 2065 6c69 6620  r).        elif 
-00021cc0: 6e5f 696d 6f64 6520 3d3d 2031 3a20 2023  n_imode == 1:  #
-00021cd0: 2022 7369 6d70 736f 6e22 2069 6e74 6567   "simpson" integ
-00021ce0: 7261 7469 6f6e 206d 6f64 650a 2020 2020  ration mode.    
-00021cf0: 2020 2020 2020 2020 666f 7220 6969 2069          for ii i
-00021d00: 6e20 7261 6e67 6528 6e6c 6f73 293a 0a20  n range(nlos):. 
-00021d10: 2020 2020 2020 2020 2020 2020 2020 206a                 j
-00021d20: 6a20 3d20 696e 6462 6973 5b69 695d 0a20  j = indbis[ii]. 
-00021d30: 2020 2020 2020 2020 2020 2020 2020 206a                 j
-00021d40: 6a70 3120 3d20 696e 6462 6973 5b69 692b  jp1 = indbis[ii+
-00021d50: 315d 0a20 2020 2020 2020 2020 2020 2020  1].             
-00021d60: 2020 2076 616c 5f6d 7620 3d20 7661 6c5f     val_mv = val_
-00021d70: 3264 5b3a 2c6a 6a3a 6a6a 7031 5d0a 2020  2d[:,jj:jjp1].  
-00021d80: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-00021d90: 635f 7220 3d20 7265 7365 6666 5f6d 765b  c_r = reseff_mv[
-00021da0: 6969 5d0a 2020 2020 2020 2020 2020 2020  ii].            
-00021db0: 2020 2020 7369 675b 3a2c 6969 5d20 3d20      sig[:,ii] = 
-00021dc0: 7363 7069 6e74 672e 7369 6d70 7328 7661  scpintg.simps(va
-00021dd0: 6c5f 6d76 2c0a 2020 2020 2020 2020 2020  l_mv,.          
-00021de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021e00: 2020 2078 3d4e 6f6e 652c 2064 783d 6c6f     x=None, dx=lo
-00021e10: 635f 722c 2061 7869 733d 2d31 290a 2020  c_r, axis=-1).  
-00021e20: 2020 2020 2020 656c 7365 3a20 2023 2052        else:  # R
-00021e30: 6f6d 6265 7267 2069 6e74 6567 7261 7469  omberg integrati
-00021e40: 6f6e 206d 6f64 650a 2020 2020 2020 2020  on mode.        
-00021e50: 2020 2020 666f 7220 6969 2069 6e20 7261      for ii in ra
-00021e60: 6e67 6528 6e6c 6f73 293a 0a20 2020 2020  nge(nlos):.     
-00021e70: 2020 2020 2020 2020 2020 2073 6967 5b3a             sig[:
-00021e80: 2c69 695d 203d 2073 6370 696e 7467 2e72  ,ii] = scpintg.r
-00021e90: 6f6d 6228 7661 6c5f 3264 5b3a 2c69 6e64  omb(val_2d[:,ind
-00021ea0: 6269 735b 6969 5d3a 696e 6462 6973 5b69  bis[ii]:indbis[i
-00021eb0: 692b 315d 5d2c 0a20 2020 2020 2020 2020  i+1]],.         
-00021ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021ee0: 6478 3d72 6573 6566 665f 6d76 5b69 695d  dx=reseff_mv[ii]
-00021ef0: 2c20 6178 6973 3d31 2c20 7368 6f77 3d46  , axis=1, show=F
-00021f00: 616c 7365 290a 2020 2020 2320 2d2d 2d2d  alse).    # ----
-00021f10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00021f20: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00021f30: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00021c10: 2020 6178 6973 3d2d 3129 0a20 2020 2020    axis=-1).     
+00021c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021c30: 2020 2020 2020 2020 2020 2020 2020 202a                 *
+00021c40: 2072 6573 6566 6673 5b4e 6f6e 652c 203a   reseffs[None, :
+00021c50: 5d29 0a20 2020 2020 2020 2020 2020 2023  ]).            #
+00021c60: 2043 6c65 616e 696e 6720 7570 2e2e 2e0a   Cleaning up....
+00021c70: 2020 2020 2020 2020 2020 2020 6672 6565              free
+00021c80: 2863 6f65 6666 5f70 7472 5b30 5d29 0a20  (coeff_ptr[0]). 
+00021c90: 2020 2020 2020 2020 2020 2066 7265 6528             free(
+00021ca0: 636f 6566 665f 7074 7229 0a20 2020 2020  coeff_ptr).     
+00021cb0: 2020 2020 2020 2066 7265 6528 7265 7365         free(rese
+00021cc0: 6666 5f61 7272 290a 2020 2020 2020 2020  ff_arr).        
+00021cd0: 2020 2020 6672 6565 2869 6e64 5f61 7272      free(ind_arr
+00021ce0: 290a 2020 2020 2020 2020 656c 6966 206e  ).        elif n
+00021cf0: 5f69 6d6f 6465 203d 3d20 313a 2020 2320  _imode == 1:  # 
+00021d00: 2273 696d 7073 6f6e 2220 696e 7465 6772  "simpson" integr
+00021d10: 6174 696f 6e20 6d6f 6465 0a20 2020 2020  ation mode.     
+00021d20: 2020 2020 2020 2066 6f72 2069 6920 696e         for ii in
+00021d30: 2072 616e 6765 286e 6c6f 7329 3a0a 2020   range(nlos):.  
+00021d40: 2020 2020 2020 2020 2020 2020 2020 6a6a                jj
+00021d50: 203d 2069 6e64 6269 735b 6969 5d0a 2020   = indbis[ii].  
+00021d60: 2020 2020 2020 2020 2020 2020 2020 6a6a                jj
+00021d70: 7031 203d 2069 6e64 6269 735b 6969 2b31  p1 = indbis[ii+1
+00021d80: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00021d90: 2020 7661 6c5f 6d76 203d 2076 616c 5f32    val_mv = val_2
+00021da0: 645b 3a2c 6a6a 3a6a 6a70 315d 0a20 2020  d[:,jj:jjp1].   
+00021db0: 2020 2020 2020 2020 2020 2020 206c 6f63               loc
+00021dc0: 5f72 203d 2072 6573 6566 665f 6d76 5b69  _r = reseff_mv[i
+00021dd0: 695d 0a20 2020 2020 2020 2020 2020 2020  i].             
+00021de0: 2020 2073 6967 5b3a 2c69 695d 203d 2073     sig[:,ii] = s
+00021df0: 6370 696e 7467 2e73 696d 7073 2876 616c  cpintg.simps(val
+00021e00: 5f6d 762c 0a20 2020 2020 2020 2020 2020  _mv,.           
+00021e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021e30: 2020 783d 4e6f 6e65 2c20 6478 3d6c 6f63    x=None, dx=loc
+00021e40: 5f72 2c20 6178 6973 3d2d 3129 0a20 2020  _r, axis=-1).   
+00021e50: 2020 2020 2065 6c73 653a 2020 2320 526f       else:  # Ro
+00021e60: 6d62 6572 6720 696e 7465 6772 6174 696f  mberg integratio
+00021e70: 6e20 6d6f 6465 0a20 2020 2020 2020 2020  n mode.         
+00021e80: 2020 2066 6f72 2069 6920 696e 2072 616e     for ii in ran
+00021e90: 6765 286e 6c6f 7329 3a0a 2020 2020 2020  ge(nlos):.      
+00021ea0: 2020 2020 2020 2020 2020 7369 675b 3a2c            sig[:,
+00021eb0: 6969 5d20 3d20 7363 7069 6e74 672e 726f  ii] = scpintg.ro
+00021ec0: 6d62 2876 616c 5f32 645b 3a2c 696e 6462  mb(val_2d[:,indb
+00021ed0: 6973 5b69 695d 3a69 6e64 6269 735b 6969  is[ii]:indbis[ii
+00021ee0: 2b31 5d5d 2c0a 2020 2020 2020 2020 2020  +1]],.          
+00021ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021f00: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00021f10: 783d 7265 7365 6666 5f6d 765b 6969 5d2c  x=reseff_mv[ii],
+00021f20: 2061 7869 733d 312c 2073 686f 773d 4661   axis=1, show=Fa
+00021f30: 6c73 6529 0a20 2020 2023 202d 2d2d 2d2d  lse).    # -----
 00021f40: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00021f50: 2d2d 2d2d 2d2d 0a20 2020 2023 204d 696e  ------.    # Min
-00021f60: 696d 697a 6520 6d65 6d6f 7279 2075 7365  imize memory use
-00021f70: 3a20 6c6f 6f70 2065 7665 7279 7468 696e  : loop everythin
-00021f80: 672c 2073 7461 7274 696e 6720 7769 7468  g, starting with
-00021f90: 204c 4f53 0a20 2020 2023 2074 6865 6e20   LOS.    # then 
-00021fa0: 7074 7320 7468 656e 2074 696d 650a 2020  pts then time.  
-00021fb0: 2020 656c 6966 206d 696e 696d 203d 3d20    elif minim == 
-00021fc0: 276d 656d 6f72 7927 3a0a 2020 2020 2020  'memory':.      
-00021fd0: 2020 2320 6c6f 6f70 206f 7665 7220 4c4f    # loop over LO
-00021fe0: 5320 616e 6420 7061 7261 6c6c 656c 697a  S and paralleliz
-00021ff0: 650a 2020 2020 2020 2020 6966 2061 6e69  e.        if ani
-00022000: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00022010: 206e 5f69 6d6f 6465 203d 3d20 303a 2020   n_imode == 0:  
-00022020: 2320 7375 6d20 696e 7465 6772 6174 696f  # sum integratio
-00022030: 6e20 6d6f 6465 0a20 2020 2020 2020 2020  n mode.         
-00022040: 2020 2020 2020 2066 6f72 2069 6920 696e         for ii in
-00022050: 2072 616e 6765 286e 6c6f 7329 3a0a 2020   range(nlos):.  
-00022060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022070: 2020 7074 732c 2075 7362 6973 203d 205f    pts, usbis = _
-00022080: 7374 2e63 616c 6c5f 6765 745f 7361 6d70  st.call_get_samp
-00022090: 6c65 5f73 696e 676c 655f 616e 6928 6c69  le_single_ani(li
-000220a0: 6d73 5b30 2c20 6969 5d2c 0a20 2020 2020  ms[0, ii],.     
-000220b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000220c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000220d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000220e0: 2020 2020 2020 2020 2020 206c 696d 735b             lims[
-000220f0: 312c 2069 695d 2c0a 2020 2020 2020 2020  1, ii],.        
+00021f50: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00021f60: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00021f70: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00021f80: 2d2d 2d2d 2d0a 2020 2020 2320 4d69 6e69  -----.    # Mini
+00021f90: 6d69 7a65 206d 656d 6f72 7920 7573 653a  mize memory use:
+00021fa0: 206c 6f6f 7020 6576 6572 7974 6869 6e67   loop everything
+00021fb0: 2c20 7374 6172 7469 6e67 2077 6974 6820  , starting with 
+00021fc0: 4c4f 530a 2020 2020 2320 7468 656e 2070  LOS.    # then p
+00021fd0: 7473 2074 6865 6e20 7469 6d65 0a20 2020  ts then time.   
+00021fe0: 2065 6c69 6620 6d69 6e69 6d20 3d3d 2027   elif minim == '
+00021ff0: 6d65 6d6f 7279 273a 0a20 2020 2020 2020  memory':.       
+00022000: 2023 206c 6f6f 7020 6f76 6572 204c 4f53   # loop over LOS
+00022010: 2061 6e64 2070 6172 616c 6c65 6c69 7a65   and parallelize
+00022020: 0a20 2020 2020 2020 2069 6620 616e 693a  .        if ani:
+00022030: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00022040: 6e5f 696d 6f64 6520 3d3d 2030 3a20 2023  n_imode == 0:  #
+00022050: 2073 756d 2069 6e74 6567 7261 7469 6f6e   sum integration
+00022060: 206d 6f64 650a 2020 2020 2020 2020 2020   mode.          
+00022070: 2020 2020 2020 666f 7220 6969 2069 6e20        for ii in 
+00022080: 7261 6e67 6528 6e6c 6f73 293a 0a20 2020  range(nlos):.   
+00022090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000220a0: 2070 7473 2c20 7573 6269 7320 3d20 5f73   pts, usbis = _s
+000220b0: 742e 6361 6c6c 5f67 6574 5f73 616d 706c  t.call_get_sampl
+000220c0: 655f 7369 6e67 6c65 5f61 6e69 286c 696d  e_single_ani(lim
+000220d0: 735b 302c 2069 695d 2c0a 2020 2020 2020  s[0, ii],.      
+000220e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000220f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00022100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022130: 2020 2020 2020 2020 7265 735f 6d76 5b69          res_mv[i
-00022140: 695d 2c0a 2020 2020 2020 2020 2020 2020  i],.            
+00022110: 2020 2020 2020 2020 2020 6c69 6d73 5b31            lims[1
+00022120: 2c20 6969 5d2c 0a20 2020 2020 2020 2020  , ii],.         
+00022130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022140: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00022150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022180: 2020 2020 6e5f 646d 6f64 652c 0a20 2020      n_dmode,.   
+00022160: 2020 2020 2020 2072 6573 5f6d 765b 6969         res_mv[ii
+00022170: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00022180: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00022190: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000221a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000221b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000221c0: 2020 2020 2020 2020 2020 2020 206e 5f69               n_i
-000221d0: 6d6f 6465 2c0a 2020 2020 2020 2020 2020  mode,.          
+000221b0: 2020 206e 5f64 6d6f 6465 2c0a 2020 2020     n_dmode,.    
+000221c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000221d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000221e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000221f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022210: 2020 2020 2020 266c 6f63 5f65 6666 5f72        &loc_eff_r
-00022220: 6573 5b30 5d2c 0a20 2020 2020 2020 2020  es[0],.         
+000221f0: 2020 2020 2020 2020 2020 2020 6e5f 696d              n_im
+00022200: 6f64 652c 0a20 2020 2020 2020 2020 2020  ode,.           
+00022210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022220: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00022230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022260: 2020 2020 2020 2026 6e62 5f72 6f77 735b         &nb_rows[
-00022270: 305d 2c0a 2020 2020 2020 2020 2020 2020  0],.            
+00022240: 2020 2020 2026 6c6f 635f 6566 665f 7265       &loc_eff_re
+00022250: 735b 305d 2c0a 2020 2020 2020 2020 2020  s[0],.          
+00022260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022270: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00022280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000222a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000222b0: 2020 2020 7261 795f 6f72 6967 5b3a 2c20      ray_orig[:, 
-000222c0: 6969 3a69 692b 315d 2c0a 2020 2020 2020  ii:ii+1],.      
+00022290: 2020 2020 2020 266e 625f 726f 7773 5b30        &nb_rows[0
+000222a0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+000222b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000222c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000222d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000222e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000222f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022300: 2020 2020 2020 2020 2020 7261 795f 7664            ray_vd
-00022310: 6972 5b3a 2c20 6969 3a69 692b 315d 290a  ir[:, ii:ii+1]).
+000222e0: 2020 2072 6179 5f6f 7269 675b 3a2c 2069     ray_orig[:, i
+000222f0: 693a 6969 2b31 5d2c 0a20 2020 2020 2020  i:ii+1],.       
+00022300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022310: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00022320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022330: 2020 2020 2320 6c6f 6f70 206f 7665 7220      # loop over 
-00022340: 7469 6d65 2066 6f72 2063 616c 6c69 6e67  time for calling
-00022350: 2061 6e64 2069 6e74 6567 7261 7469 6e67   and integrating
-00022360: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022370: 2020 2020 2066 6f72 206a 6a20 696e 2072       for jj in r
-00022380: 616e 6765 286e 7429 3a0a 2020 2020 2020  ange(nt):.      
+00022330: 2020 2020 2020 2020 2072 6179 5f76 6469           ray_vdi
+00022340: 725b 3a2c 2069 693a 6969 2b31 5d29 0a20  r[:, ii:ii+1]). 
+00022350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022360: 2020 2023 206c 6f6f 7020 6f76 6572 2074     # loop over t
+00022370: 696d 6520 666f 7220 6361 6c6c 696e 6720  ime for calling 
+00022380: 616e 6420 696e 7465 6772 6174 696e 670a  and integrating.
 00022390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000223a0: 2020 7661 6c20 3d20 6675 6e63 2870 7473    val = func(pts
-000223b0: 2c20 743d 6c74 696d 655b 6a6a 5d2c 2076  , t=ltime[jj], v
-000223c0: 6563 743d 2d75 7362 6973 2c20 2a2a 666b  ect=-usbis, **fk
-000223d0: 7764 6172 6773 290a 2020 2020 2020 2020  wdargs).        
-000223e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000223f0: 7369 675b 6a6a 2c20 6969 5d20 3d20 6e70  sig[jj, ii] = np
-00022400: 2e73 756d 2876 616c 292a 6c6f 635f 6566  .sum(val)*loc_ef
-00022410: 665f 7265 735b 305d 0a20 2020 2020 2020  f_res[0].       
-00022420: 2020 2020 2065 6c69 6620 6e5f 696d 6f64       elif n_imod
-00022430: 6520 3d3d 2031 3a20 2023 2073 696d 7073  e == 1:  # simps
-00022440: 6f6e 2069 6e74 6567 7261 7469 6f6e 206d  on integration m
-00022450: 6f64 650a 2020 2020 2020 2020 2020 2020  ode.            
-00022460: 2020 2020 666f 7220 6969 2069 6e20 7261      for ii in ra
-00022470: 6e67 6528 6e6c 6f73 293a 0a20 2020 2020  nge(nlos):.     
-00022480: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00022490: 7473 2c20 7573 6269 7320 3d20 5f73 742e  ts, usbis = _st.
-000224a0: 6361 6c6c 5f67 6574 5f73 616d 706c 655f  call_get_sample_
-000224b0: 7369 6e67 6c65 5f61 6e69 286c 696d 735b  single_ani(lims[
-000224c0: 302c 2069 695d 2c0a 2020 2020 2020 2020  0, ii],.        
-000224d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000224e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000224f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022500: 2020 2020 2020 2020 6c69 6d73 5b31 2c20          lims[1, 
-00022510: 6969 5d2c 0a20 2020 2020 2020 2020 2020  ii],.           
+000223a0: 2020 2020 666f 7220 6a6a 2069 6e20 7261      for jj in ra
+000223b0: 6e67 6528 6e74 293a 0a20 2020 2020 2020  nge(nt):.       
+000223c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000223d0: 2076 616c 203d 2066 756e 6328 7074 732c   val = func(pts,
+000223e0: 2074 3d6c 7469 6d65 5b6a 6a5d 2c20 7665   t=ltime[jj], ve
+000223f0: 6374 3d2d 7573 6269 732c 202a 2a66 6b77  ct=-usbis, **fkw
+00022400: 6461 7267 7329 0a20 2020 2020 2020 2020  dargs).         
+00022410: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00022420: 6967 5b6a 6a2c 2069 695d 203d 206e 702e  ig[jj, ii] = np.
+00022430: 7375 6d28 7661 6c29 2a6c 6f63 5f65 6666  sum(val)*loc_eff
+00022440: 5f72 6573 5b30 5d0a 2020 2020 2020 2020  _res[0].        
+00022450: 2020 2020 656c 6966 206e 5f69 6d6f 6465      elif n_imode
+00022460: 203d 3d20 313a 2020 2320 7369 6d70 736f   == 1:  # simpso
+00022470: 6e20 696e 7465 6772 6174 696f 6e20 6d6f  n integration mo
+00022480: 6465 0a20 2020 2020 2020 2020 2020 2020  de.             
+00022490: 2020 2066 6f72 2069 6920 696e 2072 616e     for ii in ran
+000224a0: 6765 286e 6c6f 7329 3a0a 2020 2020 2020  ge(nlos):.      
+000224b0: 2020 2020 2020 2020 2020 2020 2020 7074                pt
+000224c0: 732c 2075 7362 6973 203d 205f 7374 2e63  s, usbis = _st.c
+000224d0: 616c 6c5f 6765 745f 7361 6d70 6c65 5f73  all_get_sample_s
+000224e0: 696e 676c 655f 616e 6928 6c69 6d73 5b30  ingle_ani(lims[0
+000224f0: 2c20 6969 5d2c 0a20 2020 2020 2020 2020  , ii],.         
+00022500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022510: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00022520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022550: 2020 2020 2072 6573 5f6d 765b 6969 5d2c       res_mv[ii],
-00022560: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022530: 2020 2020 2020 206c 696d 735b 312c 2069         lims[1, i
+00022540: 695d 2c0a 2020 2020 2020 2020 2020 2020  i],.            
+00022550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022560: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00022570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022580: 2020 2020 7265 735f 6d76 5b69 695d 2c0a      res_mv[ii],.
 00022590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000225a0: 206e 5f64 6d6f 6465 2c20 6e5f 696d 6f64   n_dmode, n_imod
-000225b0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+000225a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000225b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000225c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000225d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000225e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000225f0: 2020 2026 6c6f 635f 6566 665f 7265 735b     &loc_eff_res[
-00022600: 305d 2c0a 2020 2020 2020 2020 2020 2020  0],.            
+000225d0: 6e5f 646d 6f64 652c 206e 5f69 6d6f 6465  n_dmode, n_imode
+000225e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000225f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022600: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00022610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022640: 2020 2020 266e 625f 726f 7773 5b30 5d2c      &nb_rows[0],
-00022650: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022620: 2020 266c 6f63 5f65 6666 5f72 6573 5b30    &loc_eff_res[0
+00022630: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00022640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022650: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00022660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022670: 2020 2026 6e62 5f72 6f77 735b 305d 2c0a     &nb_rows[0],.
 00022680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022690: 2072 6179 5f6f 7269 675b 3a2c 6969 3a69   ray_orig[:,ii:i
-000226a0: 692b 315d 2c0a 2020 2020 2020 2020 2020  i+1],.          
+00022690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000226a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000226b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000226c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000226d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000226e0: 2020 2020 2020 7261 795f 7664 6972 5b3a        ray_vdir[:
-000226f0: 2c69 693a 6969 2b31 5d29 0a20 2020 2020  ,ii:ii+1]).     
-00022700: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00022710: 206c 6f6f 7020 6f76 6572 2074 696d 6520   loop over time 
-00022720: 666f 7220 6361 6c6c 696e 6720 616e 6420  for calling and 
-00022730: 696e 7465 6772 6174 696e 670a 2020 2020  integrating.    
-00022740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022750: 666f 7220 6a6a 2069 6e20 7261 6e67 6528  for jj in range(
-00022760: 6e74 293a 0a20 2020 2020 2020 2020 2020  nt):.           
-00022770: 2020 2020 2020 2020 2020 2020 2076 616c               val
-00022780: 203d 2066 756e 6328 7074 732c 2074 3d6c   = func(pts, t=l
-00022790: 7469 6d65 5b6a 6a5d 2c20 7665 6374 3d2d  time[jj], vect=-
-000227a0: 7573 6269 732c 202a 2a66 6b77 6461 7267  usbis, **fkwdarg
-000227b0: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
-000227c0: 2020 2020 2020 2020 2020 2073 6967 5b6a             sig[j
-000227d0: 6a2c 2069 695d 203d 2073 6370 696e 7467  j, ii] = scpintg
-000227e0: 2e73 696d 7073 2876 616c 2c20 783d 4e6f  .simps(val, x=No
-000227f0: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-00022800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022820: 2020 2020 2020 2020 6478 3d6c 6f63 5f65          dx=loc_e
-00022830: 6666 5f72 6573 5b30 5d29 0a20 2020 2020  ff_res[0]).     
-00022840: 2020 2020 2020 2065 6c69 6620 6e5f 696d         elif n_im
-00022850: 6f64 6520 3d3d 2032 3a20 2023 2072 6f6d  ode == 2:  # rom
-00022860: 6265 7267 2069 6e74 6567 7261 7469 6f6e  berg integration
-00022870: 206d 6f64 650a 2020 2020 2020 2020 2020   mode.          
-00022880: 2020 2020 2020 666f 7220 6969 2069 6e20        for ii in 
-00022890: 7261 6e67 6528 6e6c 6f73 293a 0a20 2020  range(nlos):.   
-000228a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000228b0: 2070 7473 2c20 7573 6269 7320 3d20 5f73   pts, usbis = _s
-000228c0: 742e 6361 6c6c 5f67 6574 5f73 616d 706c  t.call_get_sampl
-000228d0: 655f 7369 6e67 6c65 5f61 6e69 286c 696d  e_single_ani(lim
-000228e0: 735b 302c 2069 695d 2c0a 2020 2020 2020  s[0, ii],.      
-000228f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022920: 2020 2020 2020 2020 2020 6c69 6d73 5b31            lims[1
-00022930: 2c20 6969 5d2c 0a20 2020 2020 2020 2020  , ii],.         
+000226c0: 7261 795f 6f72 6967 5b3a 2c69 693a 6969  ray_orig[:,ii:ii
+000226d0: 2b31 5d2c 0a20 2020 2020 2020 2020 2020  +1],.           
+000226e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000226f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022710: 2020 2020 2072 6179 5f76 6469 725b 3a2c       ray_vdir[:,
+00022720: 6969 3a69 692b 315d 290a 2020 2020 2020  ii:ii+1]).      
+00022730: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00022740: 6c6f 6f70 206f 7665 7220 7469 6d65 2066  loop over time f
+00022750: 6f72 2063 616c 6c69 6e67 2061 6e64 2069  or calling and i
+00022760: 6e74 6567 7261 7469 6e67 0a20 2020 2020  ntegrating.     
+00022770: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00022780: 6f72 206a 6a20 696e 2072 616e 6765 286e  or jj in range(n
+00022790: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
+000227a0: 2020 2020 2020 2020 2020 2020 7661 6c20              val 
+000227b0: 3d20 6675 6e63 2870 7473 2c20 743d 6c74  = func(pts, t=lt
+000227c0: 696d 655b 6a6a 5d2c 2076 6563 743d 2d75  ime[jj], vect=-u
+000227d0: 7362 6973 2c20 2a2a 666b 7764 6172 6773  sbis, **fkwdargs
+000227e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000227f0: 2020 2020 2020 2020 2020 7369 675b 6a6a            sig[jj
+00022800: 2c20 6969 5d20 3d20 7363 7069 6e74 672e  , ii] = scpintg.
+00022810: 7369 6d70 7328 7661 6c2c 2078 3d4e 6f6e  simps(val, x=Non
+00022820: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00022830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022850: 2020 2020 2020 2064 783d 6c6f 635f 6566         dx=loc_ef
+00022860: 665f 7265 735b 305d 290a 2020 2020 2020  f_res[0]).      
+00022870: 2020 2020 2020 656c 6966 206e 5f69 6d6f        elif n_imo
+00022880: 6465 203d 3d20 323a 2020 2320 726f 6d62  de == 2:  # romb
+00022890: 6572 6720 696e 7465 6772 6174 696f 6e20  erg integration 
+000228a0: 6d6f 6465 0a20 2020 2020 2020 2020 2020  mode.           
+000228b0: 2020 2020 2066 6f72 2069 6920 696e 2072       for ii in r
+000228c0: 616e 6765 286e 6c6f 7329 3a0a 2020 2020  ange(nlos):.    
+000228d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000228e0: 7074 732c 2075 7362 6973 203d 205f 7374  pts, usbis = _st
+000228f0: 2e63 616c 6c5f 6765 745f 7361 6d70 6c65  .call_get_sample
+00022900: 5f73 696e 676c 655f 616e 6928 6c69 6d73  _single_ani(lims
+00022910: 5b30 2c20 6969 5d2c 0a20 2020 2020 2020  [0, ii],.       
+00022920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022930: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00022940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022970: 2020 2020 2020 2072 6573 5f6d 765b 6969         res_mv[ii
-00022980: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00022950: 2020 2020 2020 2020 206c 696d 735b 312c           lims[1,
+00022960: 2069 695d 2c0a 2020 2020 2020 2020 2020   ii],.          
+00022970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022980: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00022990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000229a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000229b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000229c0: 2020 206e 5f64 6d6f 6465 2c20 6e5f 696d     n_dmode, n_im
-000229d0: 6f64 652c 0a20 2020 2020 2020 2020 2020  ode,.           
+000229a0: 2020 2020 2020 7265 735f 6d76 5b69 695d        res_mv[ii]
+000229b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000229c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000229d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000229e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000229f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022a10: 2020 2020 2026 6c6f 635f 6566 665f 7265       &loc_eff_re
-00022a20: 735b 305d 2c0a 2020 2020 2020 2020 2020  s[0],.          
+000229f0: 2020 6e5f 646d 6f64 652c 206e 5f69 6d6f    n_dmode, n_imo
+00022a00: 6465 2c0a 2020 2020 2020 2020 2020 2020  de,.            
+00022a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00022a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022a60: 2020 2020 2020 266e 625f 726f 7773 5b30        &nb_rows[0
-00022a70: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00022a40: 2020 2020 266c 6f63 5f65 6666 5f72 6573      &loc_eff_res
+00022a50: 5b30 5d2c 0a20 2020 2020 2020 2020 2020  [0],.           
+00022a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00022a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022ab0: 2020 2072 6179 5f6f 7269 675b 3a2c 6969     ray_orig[:,ii
-00022ac0: 3a69 692b 315d 2c0a 2020 2020 2020 2020  :ii+1],.        
+00022a90: 2020 2020 2026 6e62 5f72 6f77 735b 305d       &nb_rows[0]
+00022aa0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00022ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00022ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022b00: 2020 2020 2020 2020 7261 795f 7664 6972          ray_vdir
-00022b10: 5b3a 2c69 693a 6969 2b31 5d29 0a20 2020  [:,ii:ii+1]).   
+00022ae0: 2020 7261 795f 6f72 6967 5b3a 2c69 693a    ray_orig[:,ii:
+00022af0: 6969 2b31 5d2c 0a20 2020 2020 2020 2020  ii+1],.         
+00022b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00022b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022b30: 2023 206c 6f6f 7020 6f76 6572 2074 696d   # loop over tim
-00022b40: 6520 666f 7220 6361 6c6c 696e 6720 616e  e for calling an
-00022b50: 6420 696e 7465 6772 6174 696e 670a 2020  d integrating.  
-00022b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022b70: 2020 666f 7220 6a6a 2069 6e20 7261 6e67    for jj in rang
-00022b80: 6528 6e74 293a 0a20 2020 2020 2020 2020  e(nt):.         
-00022b90: 2020 2020 2020 2020 2020 2020 2020 2076                 v
-00022ba0: 616c 203d 2066 756e 6328 7074 732c 2074  al = func(pts, t
-00022bb0: 3d6c 7469 6d65 5b6a 6a5d 2c20 7665 6374  =ltime[jj], vect
-00022bc0: 3d2d 7573 6269 732c 202a 2a66 6b77 6461  =-usbis, **fkwda
-00022bd0: 7267 7329 0a20 2020 2020 2020 2020 2020  rgs).           
-00022be0: 2020 2020 2020 2020 2020 2020 2073 6967               sig
-00022bf0: 5b6a 6a2c 2069 695d 203d 2073 6370 696e  [jj, ii] = scpin
-00022c00: 7467 2e72 6f6d 6228 7661 6c2c 2073 686f  tg.romb(val, sho
-00022c10: 773d 4661 6c73 652c 0a20 2020 2020 2020  w=False,.       
-00022c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022c40: 2020 2020 2020 2020 2020 2020 6478 3d6c              dx=l
-00022c50: 6f63 5f65 6666 5f72 6573 5b30 5d29 0a20  oc_eff_res[0]). 
-00022c60: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00022c70: 2020 2020 2020 2020 2023 202d 2d20 6e6f           # -- no
-00022c80: 7420 616e 6973 6f74 726f 7069 6320 2d2d  t anisotropic --
-00022c90: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00022ca0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00022cb0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020  -------------.  
-00022cc0: 2020 2020 2020 2020 2020 6966 206e 5f69            if n_i
-00022cd0: 6d6f 6465 203d 3d20 303a 2020 2320 2273  mode == 0:  # "s
-00022ce0: 756d 2220 696e 7465 6772 6174 696f 6e20  um" integration 
-00022cf0: 6d6f 6465 0a20 2020 2020 2020 2020 2020  mode.           
-00022d00: 2020 2020 2066 6f72 2069 6920 696e 2072       for ii in r
-00022d10: 616e 6765 286e 6c6f 7329 3a0a 2020 2020  ange(nlos):.    
-00022d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022d30: 7074 7320 3d20 5f73 742e 6361 6c6c 5f67  pts = _st.call_g
-00022d40: 6574 5f73 616d 706c 655f 7369 6e67 6c65  et_sample_single
-00022d50: 286c 696d 735b 302c 2069 695d 2c0a 2020  (lims[0, ii],.  
-00022d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022d90: 2020 206c 696d 735b 312c 2069 695d 2c0a     lims[1, ii],.
+00022b30: 2020 2020 2020 2072 6179 5f76 6469 725b         ray_vdir[
+00022b40: 3a2c 6969 3a69 692b 315d 290a 2020 2020  :,ii:ii+1]).    
+00022b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022b60: 2320 6c6f 6f70 206f 7665 7220 7469 6d65  # loop over time
+00022b70: 2066 6f72 2063 616c 6c69 6e67 2061 6e64   for calling and
+00022b80: 2069 6e74 6567 7261 7469 6e67 0a20 2020   integrating.   
+00022b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022ba0: 2066 6f72 206a 6a20 696e 2072 616e 6765   for jj in range
+00022bb0: 286e 7429 3a0a 2020 2020 2020 2020 2020  (nt):.          
+00022bc0: 2020 2020 2020 2020 2020 2020 2020 7661                va
+00022bd0: 6c20 3d20 6675 6e63 2870 7473 2c20 743d  l = func(pts, t=
+00022be0: 6c74 696d 655b 6a6a 5d2c 2076 6563 743d  ltime[jj], vect=
+00022bf0: 2d75 7362 6973 2c20 2a2a 666b 7764 6172  -usbis, **fkwdar
+00022c00: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
+00022c10: 2020 2020 2020 2020 2020 2020 7369 675b              sig[
+00022c20: 6a6a 2c20 6969 5d20 3d20 7363 7069 6e74  jj, ii] = scpint
+00022c30: 672e 726f 6d62 2876 616c 2c20 7368 6f77  g.romb(val, show
+00022c40: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
+00022c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022c70: 2020 2020 2020 2020 2020 2064 783d 6c6f             dx=lo
+00022c80: 635f 6566 665f 7265 735b 305d 290a 2020  c_eff_res[0]).  
+00022c90: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00022ca0: 2020 2020 2020 2020 2320 2d2d 206e 6f74          # -- not
+00022cb0: 2061 6e69 736f 7472 6f70 6963 202d 2d2d   anisotropic ---
+00022cc0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00022cd0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00022ce0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020  ------------.   
+00022cf0: 2020 2020 2020 2020 2069 6620 6e5f 696d           if n_im
+00022d00: 6f64 6520 3d3d 2030 3a20 2023 2022 7375  ode == 0:  # "su
+00022d10: 6d22 2069 6e74 6567 7261 7469 6f6e 206d  m" integration m
+00022d20: 6f64 650a 2020 2020 2020 2020 2020 2020  ode.            
+00022d30: 2020 2020 666f 7220 6969 2069 6e20 7261      for ii in ra
+00022d40: 6e67 6528 6e6c 6f73 293a 0a20 2020 2020  nge(nlos):.     
+00022d50: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00022d60: 7473 203d 205f 7374 2e63 616c 6c5f 6765  ts = _st.call_ge
+00022d70: 745f 7361 6d70 6c65 5f73 696e 676c 6528  t_sample_single(
+00022d80: 6c69 6d73 5b30 2c20 6969 5d2c 0a20 2020  lims[0, ii],.   
+00022d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00022da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00022db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022dd0: 2020 2020 2072 6573 5f6d 765b 6969 5d2c       res_mv[ii],
-00022de0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022dc0: 2020 6c69 6d73 5b31 2c20 6969 5d2c 0a20    lims[1, ii],. 
+00022dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00022df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022e10: 2020 2020 2020 6e5f 646d 6f64 652c 206e        n_dmode, n
-00022e20: 5f69 6d6f 6465 2c0a 2020 2020 2020 2020  _imode,.        
+00022e00: 2020 2020 7265 735f 6d76 5b69 695d 2c0a      res_mv[ii],.
+00022e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00022e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022e50: 2020 2020 2020 2020 2020 2020 2026 6c6f               &lo
-00022e60: 635f 6566 665f 7265 735b 305d 2c0a 2020  c_eff_res[0],.  
+00022e40: 2020 2020 206e 5f64 6d6f 6465 2c20 6e5f       n_dmode, n_
+00022e50: 696d 6f64 652c 0a20 2020 2020 2020 2020  imode,.         
+00022e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00022e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022ea0: 2020 2026 6e62 5f72 6f77 735b 305d 2c0a     &nb_rows[0],.
+00022e80: 2020 2020 2020 2020 2020 2020 266c 6f63              &loc
+00022e90: 5f65 6666 5f72 6573 5b30 5d2c 0a20 2020  _eff_res[0],.   
+00022ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00022eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00022ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022ee0: 2020 2020 2072 6179 5f6f 7269 675b 3a2c       ray_orig[:,
-00022ef0: 6969 3a69 692b 315d 2c0a 2020 2020 2020  ii:ii+1],.      
+00022ed0: 2020 266e 625f 726f 7773 5b30 5d2c 0a20    &nb_rows[0],. 
+00022ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00022f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022f20: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00022f30: 6179 5f76 6469 725b 3a2c 6969 3a69 692b  ay_vdir[:,ii:ii+
-00022f40: 315d 290a 2020 2020 2020 2020 2020 2020  1]).            
-00022f50: 2020 2020 2020 2020 2320 6c6f 6f70 206f          # loop o
-00022f60: 7665 7220 7469 6d65 2066 6f72 2063 616c  ver time for cal
-00022f70: 6c69 6e67 2061 6e64 2069 6e74 6567 7261  ling and integra
-00022f80: 7469 6e67 0a20 2020 2020 2020 2020 2020  ting.           
-00022f90: 2020 2020 2020 2020 2066 6f72 206a 6a20           for jj 
-00022fa0: 696e 2072 616e 6765 286e 7429 3a0a 2020  in range(nt):.  
-00022fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022fc0: 2020 2020 2020 7661 6c20 3d20 6675 6e63        val = func
-00022fd0: 2870 7473 2c20 743d 6c74 696d 655b 6a6a  (pts, t=ltime[jj
-00022fe0: 5d2c 202a 2a66 6b77 6461 7267 7329 0a20  ], **fkwdargs). 
-00022ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023000: 2020 2020 2020 2073 6967 5b6a 6a2c 2069         sig[jj, i
-00023010: 695d 203d 206e 702e 7375 6d28 7661 6c29  i] = np.sum(val)
-00023020: 2a6c 6f63 5f65 6666 5f72 6573 5b30 5d0a  *loc_eff_res[0].
-00023030: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-00023040: 206e 5f69 6d6f 6465 203d 3d20 313a 2020   n_imode == 1:  
-00023050: 2320 2273 696d 7073 6f6e 2220 696e 7465  # "simpson" inte
-00023060: 6772 6174 696f 6e20 6d6f 6465 0a20 2020  gration mode.   
-00023070: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00023080: 2069 6920 696e 2072 616e 6765 286e 6c6f   ii in range(nlo
-00023090: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
-000230a0: 2020 2020 2020 2020 7074 7320 3d20 5f73          pts = _s
-000230b0: 742e 6361 6c6c 5f67 6574 5f73 616d 706c  t.call_get_sampl
-000230c0: 655f 7369 6e67 6c65 286c 696d 735b 302c  e_single(lims[0,
-000230d0: 6969 5d2c 0a20 2020 2020 2020 2020 2020  ii],.           
-000230e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000230f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023100: 2020 2020 2020 2020 2020 6c69 6d73 5b31            lims[1
-00023110: 2c69 695d 2c0a 2020 2020 2020 2020 2020  ,ii],.          
+00022f10: 2020 2020 7261 795f 6f72 6967 5b3a 2c69      ray_orig[:,i
+00022f20: 693a 6969 2b31 5d2c 0a20 2020 2020 2020  i:ii+1],.       
+00022f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022f50: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+00022f60: 795f 7664 6972 5b3a 2c69 693a 6969 2b31  y_vdir[:,ii:ii+1
+00022f70: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
+00022f80: 2020 2020 2020 2023 206c 6f6f 7020 6f76         # loop ov
+00022f90: 6572 2074 696d 6520 666f 7220 6361 6c6c  er time for call
+00022fa0: 696e 6720 616e 6420 696e 7465 6772 6174  ing and integrat
+00022fb0: 696e 670a 2020 2020 2020 2020 2020 2020  ing.            
+00022fc0: 2020 2020 2020 2020 666f 7220 6a6a 2069          for jj i
+00022fd0: 6e20 7261 6e67 6528 6e74 293a 0a20 2020  n range(nt):.   
+00022fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022ff0: 2020 2020 2076 616c 203d 2066 756e 6328       val = func(
+00023000: 7074 732c 2074 3d6c 7469 6d65 5b6a 6a5d  pts, t=ltime[jj]
+00023010: 2c20 2a2a 666b 7764 6172 6773 290a 2020  , **fkwdargs).  
+00023020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023030: 2020 2020 2020 7369 675b 6a6a 2c20 6969        sig[jj, ii
+00023040: 5d20 3d20 6e70 2e73 756d 2876 616c 292a  ] = np.sum(val)*
+00023050: 6c6f 635f 6566 665f 7265 735b 305d 0a20  loc_eff_res[0]. 
+00023060: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+00023070: 6e5f 696d 6f64 6520 3d3d 2031 3a20 2023  n_imode == 1:  #
+00023080: 2022 7369 6d70 736f 6e22 2069 6e74 6567   "simpson" integ
+00023090: 7261 7469 6f6e 206d 6f64 650a 2020 2020  ration mode.    
+000230a0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+000230b0: 6969 2069 6e20 7261 6e67 6528 6e6c 6f73  ii in range(nlos
+000230c0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000230d0: 2020 2020 2020 2070 7473 203d 205f 7374         pts = _st
+000230e0: 2e63 616c 6c5f 6765 745f 7361 6d70 6c65  .call_get_sample
+000230f0: 5f73 696e 676c 6528 6c69 6d73 5b30 2c69  _single(lims[0,i
+00023100: 695d 2c0a 2020 2020 2020 2020 2020 2020  i],.            
+00023110: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00023120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023140: 2020 2020 2020 2020 2020 2072 6573 5f6d             res_m
-00023150: 765b 6969 5d2c 0a20 2020 2020 2020 2020  v[ii],.         
+00023130: 2020 2020 2020 2020 206c 696d 735b 312c           lims[1,
+00023140: 6969 5d2c 0a20 2020 2020 2020 2020 2020  ii],.           
+00023150: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00023160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023180: 2020 2020 2020 2020 2020 2020 6e5f 646d              n_dm
-00023190: 6f64 652c 206e 5f69 6d6f 6465 2c0a 2020  ode, n_imode,.  
+00023170: 2020 2020 2020 2020 2020 7265 735f 6d76            res_mv
+00023180: 5b69 695d 2c0a 2020 2020 2020 2020 2020  [ii],.          
+00023190: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000231a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000231b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000231c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000231d0: 2020 2026 6c6f 635f 6566 665f 7265 735b     &loc_eff_res[
-000231e0: 305d 2c0a 2020 2020 2020 2020 2020 2020  0],.            
+000231b0: 2020 2020 2020 2020 2020 206e 5f64 6d6f             n_dmo
+000231c0: 6465 2c20 6e5f 696d 6f64 652c 0a20 2020  de, n_imode,.   
+000231d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000231e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000231f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023210: 2020 2020 2020 2020 2026 6e62 5f72 6f77           &nb_row
-00023220: 735b 305d 2c0a 2020 2020 2020 2020 2020  s[0],.          
+00023200: 2020 266c 6f63 5f65 6666 5f72 6573 5b30    &loc_eff_res[0
+00023210: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00023220: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00023230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023250: 2020 2020 2020 2020 2020 2072 6179 5f6f             ray_o
-00023260: 7269 675b 3a2c 6969 3a69 692b 315d 2c0a  rig[:,ii:ii+1],.
+00023240: 2020 2020 2020 2020 266e 625f 726f 7773          &nb_rows
+00023250: 5b30 5d2c 0a20 2020 2020 2020 2020 2020  [0],.           
+00023260: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00023270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000232a0: 2020 2020 2072 6179 5f76 6469 725b 3a2c       ray_vdir[:,
-000232b0: 6969 3a69 692b 315d 290a 2020 2020 2020  ii:ii+1]).      
-000232c0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-000232d0: 6c6f 6f70 206f 7665 7220 7469 6d65 2066  loop over time f
-000232e0: 6f72 2063 616c 6c69 6e67 2061 6e64 2069  or calling and i
-000232f0: 6e74 6567 7261 7469 6e67 0a20 2020 2020  ntegrating.     
-00023300: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00023310: 6f72 206a 6a20 696e 2072 616e 6765 286e  or jj in range(n
-00023320: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
-00023330: 2020 2020 2020 2020 2020 2020 7661 6c20              val 
-00023340: 3d20 6675 6e63 2870 7473 2c20 743d 6c74  = func(pts, t=lt
-00023350: 696d 655b 6a6a 5d2c 202a 2a66 6b77 6461  ime[jj], **fkwda
-00023360: 7267 7329 0a20 2020 2020 2020 2020 2020  rgs).           
-00023370: 2020 2020 2020 2020 2020 2020 2073 6967               sig
-00023380: 5b6a 6a2c 2069 695d 203d 2073 6370 696e  [jj, ii] = scpin
-00023390: 7467 2e73 696d 7073 2876 616c 2c20 783d  tg.simps(val, x=
-000233a0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
-000233b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000233c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000233d0: 2020 2020 2020 2020 2020 6478 3d6c 6f63            dx=loc
-000233e0: 5f65 6666 5f72 6573 5b30 5d29 0a20 2020  _eff_res[0]).   
-000233f0: 2020 2020 2020 2020 2065 6c69 6620 6e5f           elif n_
-00023400: 696d 6f64 6520 3d3d 2032 3a20 2023 2022  imode == 2:  # "
-00023410: 726f 6d62 6572 6722 2069 6e74 6567 7261  romberg" integra
-00023420: 7469 6f6e 206d 6f64 650a 2020 2020 2020  tion mode.      
-00023430: 2020 2020 2020 2020 2020 666f 7220 6969            for ii
-00023440: 2069 6e20 7261 6e67 6528 6e6c 6f73 293a   in range(nlos):
-00023450: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00023460: 2020 2020 2070 7473 203d 205f 7374 2e63       pts = _st.c
-00023470: 616c 6c5f 6765 745f 7361 6d70 6c65 5f73  all_get_sample_s
-00023480: 696e 676c 6528 6c69 6d73 5b30 2c20 6969  ingle(lims[0, ii
-00023490: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-000234a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000234b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000234c0: 2020 2020 2020 2020 6c69 6d73 5b31 2c20          lims[1, 
-000234d0: 6969 5d2c 0a20 2020 2020 2020 2020 2020  ii],.           
+00023280: 2020 2020 2020 2020 2020 7261 795f 6f72            ray_or
+00023290: 6967 5b3a 2c69 693a 6969 2b31 5d2c 0a20  ig[:,ii:ii+1],. 
+000232a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000232b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000232c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000232d0: 2020 2020 7261 795f 7664 6972 5b3a 2c69      ray_vdir[:,i
+000232e0: 693a 6969 2b31 5d29 0a20 2020 2020 2020  i:ii+1]).       
+000232f0: 2020 2020 2020 2020 2020 2020 2023 206c               # l
+00023300: 6f6f 7020 6f76 6572 2074 696d 6520 666f  oop over time fo
+00023310: 7220 6361 6c6c 696e 6720 616e 6420 696e  r calling and in
+00023320: 7465 6772 6174 696e 670a 2020 2020 2020  tegrating.      
+00023330: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00023340: 7220 6a6a 2069 6e20 7261 6e67 6528 6e74  r jj in range(nt
+00023350: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00023360: 2020 2020 2020 2020 2020 2076 616c 203d             val =
+00023370: 2066 756e 6328 7074 732c 2074 3d6c 7469   func(pts, t=lti
+00023380: 6d65 5b6a 6a5d 2c20 2a2a 666b 7764 6172  me[jj], **fkwdar
+00023390: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
+000233a0: 2020 2020 2020 2020 2020 2020 7369 675b              sig[
+000233b0: 6a6a 2c20 6969 5d20 3d20 7363 7069 6e74  jj, ii] = scpint
+000233c0: 672e 7369 6d70 7328 7661 6c2c 2078 3d4e  g.simps(val, x=N
+000233d0: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+000233e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000233f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023400: 2020 2020 2020 2020 2064 783d 6c6f 635f           dx=loc_
+00023410: 6566 665f 7265 735b 305d 290a 2020 2020  eff_res[0]).    
+00023420: 2020 2020 2020 2020 656c 6966 206e 5f69          elif n_i
+00023430: 6d6f 6465 203d 3d20 323a 2020 2320 2272  mode == 2:  # "r
+00023440: 6f6d 6265 7267 2220 696e 7465 6772 6174  omberg" integrat
+00023450: 696f 6e20 6d6f 6465 0a20 2020 2020 2020  ion mode.       
+00023460: 2020 2020 2020 2020 2066 6f72 2069 6920           for ii 
+00023470: 696e 2072 616e 6765 286e 6c6f 7329 3a0a  in range(nlos):.
+00023480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023490: 2020 2020 7074 7320 3d20 5f73 742e 6361      pts = _st.ca
+000234a0: 6c6c 5f67 6574 5f73 616d 706c 655f 7369  ll_get_sample_si
+000234b0: 6e67 6c65 286c 696d 735b 302c 2069 695d  ngle(lims[0, ii]
+000234c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000234d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000234e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000234f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023500: 2020 2020 2020 2020 2020 7265 735f 6d76            res_mv
-00023510: 5b69 695d 2c0a 2020 2020 2020 2020 2020  [ii],.          
+000234f0: 2020 2020 2020 206c 696d 735b 312c 2069         lims[1, i
+00023500: 695d 2c0a 2020 2020 2020 2020 2020 2020  i],.            
+00023510: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00023520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023540: 2020 2020 2020 2020 2020 206e 5f64 6d6f             n_dmo
-00023550: 6465 2c20 6e5f 696d 6f64 652c 0a20 2020  de, n_imode,.   
+00023530: 2020 2020 2020 2020 2072 6573 5f6d 765b           res_mv[
+00023540: 6969 5d2c 0a20 2020 2020 2020 2020 2020  ii],.           
+00023550: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00023560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023590: 2020 266c 6f63 5f65 6666 5f72 6573 5b30    &loc_eff_res[0
-000235a0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00023570: 2020 2020 2020 2020 2020 6e5f 646d 6f64            n_dmod
+00023580: 652c 206e 5f69 6d6f 6465 2c0a 2020 2020  e, n_imode,.    
+00023590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000235a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000235b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000235c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000235d0: 2020 2020 2020 2020 266e 625f 726f 7773          &nb_rows
-000235e0: 5b30 5d2c 0a20 2020 2020 2020 2020 2020  [0],.           
+000235c0: 2026 6c6f 635f 6566 665f 7265 735b 305d   &loc_eff_res[0]
+000235d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000235e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000235f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023610: 2020 2020 2020 2020 2020 7261 795f 6f72            ray_or
-00023620: 6967 5b3a 2c69 693a 6969 2b31 5d2c 0a20  ig[:,ii:ii+1],. 
+00023600: 2020 2020 2020 2026 6e62 5f72 6f77 735b         &nb_rows[
+00023610: 305d 2c0a 2020 2020 2020 2020 2020 2020  0],.            
+00023620: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00023630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023660: 2020 2020 7261 795f 7664 6972 5b3a 2c69      ray_vdir[:,i
-00023670: 693a 6969 2b31 5d29 0a20 2020 2020 2020  i:ii+1]).       
-00023680: 2020 2020 2020 2020 2020 2020 2023 206c               # l
-00023690: 6f6f 7020 6f76 6572 2074 696d 6520 666f  oop over time fo
-000236a0: 7220 6361 6c6c 696e 6720 616e 6420 696e  r calling and in
-000236b0: 7465 6772 6174 696e 670a 2020 2020 2020  tegrating.      
-000236c0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-000236d0: 7220 6a6a 2069 6e20 7261 6e67 6528 6e74  r jj in range(nt
-000236e0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-000236f0: 2020 2020 2020 2020 2020 2076 616c 203d             val =
-00023700: 2066 756e 6328 7074 732c 2074 3d6c 7469   func(pts, t=lti
-00023710: 6d65 5b6a 6a5d 2c20 2a2a 666b 7764 6172  me[jj], **fkwdar
-00023720: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
-00023730: 2020 2020 2020 2020 2020 2020 7369 675b              sig[
-00023740: 6a6a 2c20 6969 5d20 3d20 7363 7069 6e74  jj, ii] = scpint
-00023750: 672e 726f 6d62 2876 616c 2c20 7368 6f77  g.romb(val, show
-00023760: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
-00023770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023790: 2020 2020 2020 2020 2020 2064 783d 6c6f             dx=lo
-000237a0: 635f 6566 665f 7265 735b 305d 290a 2020  c_eff_res[0]).  
-000237b0: 2020 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d    # ------------
-000237c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000237d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000237e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000237f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20  --------------. 
-00023800: 2020 2023 2048 5942 5249 4420 6d65 7468     # HYBRID meth
-00023810: 6f64 3a20 4d69 6e69 6d69 7a65 206d 656d  od: Minimize mem
-00023820: 6f72 7920 616e 6420 6361 6c6c 7320 2863  ory and calls (c
-00023830: 6f6d 7072 6f6d 6973 6529 3a20 6c6f 6f70  ompromise): loop
-00023840: 2065 7665 7279 7468 696e 672c 0a20 2020   everything,.   
-00023850: 2023 2073 7461 7274 696e 6720 7769 7468   # starting with
-00023860: 204c 4f53 2c20 6361 6c6c 2066 756e 6320   LOS, call func 
-00023870: 6f6e 6c79 206f 6e63 6520 666f 7220 6561  only once for ea
-00023880: 6368 206c 6f73 2028 7472 6561 7420 616c  ch los (treat al
-00023890: 6c20 7469 6d65 7329 0a20 2020 2023 206c  l times).    # l
-000238a0: 6f6f 7020 6f76 6572 2074 696d 6520 666f  oop over time fo
-000238b0: 7220 696e 7465 6772 616c 730a 2020 2020  r integrals.    
-000238c0: 656c 7365 3a0a 2020 2020 2020 2020 2320  else:.        # 
-000238d0: 6c6f 6f70 206f 7665 7220 4c4f 530a 2020  loop over LOS.  
-000238e0: 2020 2020 2020 6966 2061 6e69 3a0a 2020        if ani:.  
-000238f0: 2020 2020 2020 2020 2020 6966 206e 5f69            if n_i
-00023900: 6d6f 6465 203d 3d20 303a 2020 2320 7375  mode == 0:  # su
-00023910: 6d20 696e 7465 6772 6174 696f 6e20 6d6f  m integration mo
-00023920: 6465 0a20 2020 2020 2020 2020 2020 2020  de.             
-00023930: 2020 2066 6f72 2069 6920 696e 2072 616e     for ii in ran
-00023940: 6765 286e 6c6f 7329 3a0a 2020 2020 2020  ge(nlos):.      
-00023950: 2020 2020 2020 2020 2020 2020 2020 7074                pt
-00023960: 732c 2075 7362 6973 203d 205f 7374 2e63  s, usbis = _st.c
-00023970: 616c 6c5f 6765 745f 7361 6d70 6c65 5f73  all_get_sample_s
-00023980: 696e 676c 655f 616e 6928 6c69 6d73 5b30  ingle_ani(lims[0
-00023990: 2c20 6969 5d2c 0a20 2020 2020 2020 2020  , ii],.         
-000239a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000239b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000239c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000239d0: 2020 2020 2020 206c 696d 735b 312c 2069         lims[1, i
-000239e0: 695d 2c0a 2020 2020 2020 2020 2020 2020  i],.            
+00023640: 2020 2020 2020 2020 2072 6179 5f6f 7269           ray_ori
+00023650: 675b 3a2c 6969 3a69 692b 315d 2c0a 2020  g[:,ii:ii+1],.  
+00023660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023690: 2020 2072 6179 5f76 6469 725b 3a2c 6969     ray_vdir[:,ii
+000236a0: 3a69 692b 315d 290a 2020 2020 2020 2020  :ii+1]).        
+000236b0: 2020 2020 2020 2020 2020 2020 2320 6c6f              # lo
+000236c0: 6f70 206f 7665 7220 7469 6d65 2066 6f72  op over time for
+000236d0: 2063 616c 6c69 6e67 2061 6e64 2069 6e74   calling and int
+000236e0: 6567 7261 7469 6e67 0a20 2020 2020 2020  egrating.       
+000236f0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00023700: 206a 6a20 696e 2072 616e 6765 286e 7429   jj in range(nt)
+00023710: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00023720: 2020 2020 2020 2020 2020 7661 6c20 3d20            val = 
+00023730: 6675 6e63 2870 7473 2c20 743d 6c74 696d  func(pts, t=ltim
+00023740: 655b 6a6a 5d2c 202a 2a66 6b77 6461 7267  e[jj], **fkwdarg
+00023750: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
+00023760: 2020 2020 2020 2020 2020 2073 6967 5b6a             sig[j
+00023770: 6a2c 2069 695d 203d 2073 6370 696e 7467  j, ii] = scpintg
+00023780: 2e72 6f6d 6228 7661 6c2c 2073 686f 773d  .romb(val, show=
+00023790: 4661 6c73 652c 0a20 2020 2020 2020 2020  False,.         
+000237a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000237b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000237c0: 2020 2020 2020 2020 2020 6478 3d6c 6f63            dx=loc
+000237d0: 5f65 6666 5f72 6573 5b30 5d29 0a20 2020  _eff_res[0]).   
+000237e0: 2023 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   # -------------
+000237f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00023800: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00023810: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00023820: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020  -------------.  
+00023830: 2020 2320 4859 4252 4944 206d 6574 686f    # HYBRID metho
+00023840: 643a 204d 696e 696d 697a 6520 6d65 6d6f  d: Minimize memo
+00023850: 7279 2061 6e64 2063 616c 6c73 2028 636f  ry and calls (co
+00023860: 6d70 726f 6d69 7365 293a 206c 6f6f 7020  mpromise): loop 
+00023870: 6576 6572 7974 6869 6e67 2c0a 2020 2020  everything,.    
+00023880: 2320 7374 6172 7469 6e67 2077 6974 6820  # starting with 
+00023890: 4c4f 532c 2063 616c 6c20 6675 6e63 206f  LOS, call func o
+000238a0: 6e6c 7920 6f6e 6365 2066 6f72 2065 6163  nly once for eac
+000238b0: 6820 6c6f 7320 2874 7265 6174 2061 6c6c  h los (treat all
+000238c0: 2074 696d 6573 290a 2020 2020 2320 6c6f   times).    # lo
+000238d0: 6f70 206f 7665 7220 7469 6d65 2066 6f72  op over time for
+000238e0: 2069 6e74 6567 7261 6c73 0a20 2020 2065   integrals.    e
+000238f0: 6c73 653a 0a20 2020 2020 2020 2023 206c  lse:.        # l
+00023900: 6f6f 7020 6f76 6572 204c 4f53 0a20 2020  oop over LOS.   
+00023910: 2020 2020 2069 6620 616e 693a 0a20 2020       if ani:.   
+00023920: 2020 2020 2020 2020 2069 6620 6e5f 696d           if n_im
+00023930: 6f64 6520 3d3d 2030 3a20 2023 2073 756d  ode == 0:  # sum
+00023940: 2069 6e74 6567 7261 7469 6f6e 206d 6f64   integration mod
+00023950: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00023960: 2020 666f 7220 6969 2069 6e20 7261 6e67    for ii in rang
+00023970: 6528 6e6c 6f73 293a 0a20 2020 2020 2020  e(nlos):.       
+00023980: 2020 2020 2020 2020 2020 2020 2070 7473               pts
+00023990: 2c20 7573 6269 7320 3d20 5f73 742e 6361  , usbis = _st.ca
+000239a0: 6c6c 5f67 6574 5f73 616d 706c 655f 7369  ll_get_sample_si
+000239b0: 6e67 6c65 5f61 6e69 286c 696d 735b 302c  ngle_ani(lims[0,
+000239c0: 2069 695d 2c0a 2020 2020 2020 2020 2020   ii],.          
+000239d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000239e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000239f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023a20: 2020 2020 7265 735f 6d76 5b69 695d 2c0a      res_mv[ii],.
+00023a00: 2020 2020 2020 6c69 6d73 5b31 2c20 6969        lims[1, ii
+00023a10: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00023a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00023a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00023a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023a50: 2020 2072 6573 5f6d 765b 6969 5d2c 0a20     res_mv[ii],. 
 00023a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023a70: 6e5f 646d 6f64 652c 0a20 2020 2020 2020  n_dmode,.       
+00023a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00023a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023ab0: 2020 2020 2020 2020 206e 5f69 6d6f 6465           n_imode
-00023ac0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00023a90: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00023aa0: 5f64 6d6f 6465 2c0a 2020 2020 2020 2020  _dmode,.        
+00023ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00023ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023b00: 2020 266c 6f63 5f65 6666 5f72 6573 5b30    &loc_eff_res[0
-00023b10: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00023ae0: 2020 2020 2020 2020 6e5f 696d 6f64 652c          n_imode,
+00023af0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00023b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023b50: 2020 2026 6e62 5f72 6f77 735b 305d 2c0a     &nb_rows[0],.
+00023b30: 2026 6c6f 635f 6566 665f 7265 735b 305d   &loc_eff_res[0]
+00023b40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00023b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00023b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00023b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023b80: 2020 266e 625f 726f 7773 5b30 5d2c 0a20    &nb_rows[0],. 
 00023b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023ba0: 7261 795f 6f72 6967 5b3a 2c20 6969 3a69  ray_orig[:, ii:i
-00023bb0: 692b 315d 2c0a 2020 2020 2020 2020 2020  i+1],.          
-00023bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023bf0: 2020 2020 2020 7261 795f 7664 6972 5b3a        ray_vdir[:
-00023c00: 2c20 6969 3a69 692b 315d 290a 2020 2020  , ii:ii+1]).    
+00023ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023bc0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00023bd0: 6179 5f6f 7269 675b 3a2c 2069 693a 6969  ay_orig[:, ii:ii
+00023be0: 2b31 5d2c 0a20 2020 2020 2020 2020 2020  +1],.           
+00023bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00023c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023c20: 7661 6c5f 3264 203d 2066 756e 6328 7074  val_2d = func(pt
-00023c30: 732c 2074 3d74 2c20 7665 6374 3d2d 7573  s, t=t, vect=-us
-00023c40: 6269 732c 202a 2a66 6b77 6461 7267 7329  bis, **fkwdargs)
-00023c50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00023c60: 2020 2020 2073 6967 5b3a 2c20 6969 5d20       sig[:, ii] 
-00023c70: 3d20 6e70 2e73 756d 2876 616c 5f32 642c  = np.sum(val_2d,
-00023c80: 2061 7869 733d 2d31 292a 6c6f 635f 6566   axis=-1)*loc_ef
-00023c90: 665f 7265 735b 305d 0a20 2020 2020 2020  f_res[0].       
-00023ca0: 2020 2020 2065 6c69 6620 6e5f 696d 6f64       elif n_imod
-00023cb0: 6520 3d3d 2031 3a20 2023 2073 696d 7073  e == 1:  # simps
-00023cc0: 6f6e 2069 6e74 6567 7261 7469 6f6e 206d  on integration m
-00023cd0: 6f64 650a 2020 2020 2020 2020 2020 2020  ode.            
-00023ce0: 2020 2020 666f 7220 6969 2069 6e20 7261      for ii in ra
-00023cf0: 6e67 6528 6e6c 6f73 293a 0a20 2020 2020  nge(nlos):.     
-00023d00: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00023d10: 7473 2c20 7573 6269 7320 3d20 5f73 742e  ts, usbis = _st.
-00023d20: 6361 6c6c 5f67 6574 5f73 616d 706c 655f  call_get_sample_
-00023d30: 7369 6e67 6c65 5f61 6e69 286c 696d 735b  single_ani(lims[
-00023d40: 302c 2069 695d 2c0a 2020 2020 2020 2020  0, ii],.        
-00023d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023d80: 2020 2020 2020 2020 6c69 6d73 5b31 2c20          lims[1, 
-00023d90: 6969 5d2c 0a20 2020 2020 2020 2020 2020  ii],.           
+00023c20: 2020 2020 2072 6179 5f76 6469 725b 3a2c       ray_vdir[:,
+00023c30: 2069 693a 6969 2b31 5d29 0a20 2020 2020   ii:ii+1]).     
+00023c40: 2020 2020 2020 2020 2020 2020 2020 2076                 v
+00023c50: 616c 5f32 6420 3d20 6675 6e63 2870 7473  al_2d = func(pts
+00023c60: 2c20 743d 742c 2076 6563 743d 2d75 7362  , t=t, vect=-usb
+00023c70: 6973 2c20 2a2a 666b 7764 6172 6773 290a  is, **fkwdargs).
+00023c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023c90: 2020 2020 7369 675b 3a2c 2069 695d 203d      sig[:, ii] =
+00023ca0: 206e 702e 7375 6d28 7661 6c5f 3264 2c20   np.sum(val_2d, 
+00023cb0: 6178 6973 3d2d 3129 2a6c 6f63 5f65 6666  axis=-1)*loc_eff
+00023cc0: 5f72 6573 5b30 5d0a 2020 2020 2020 2020  _res[0].        
+00023cd0: 2020 2020 656c 6966 206e 5f69 6d6f 6465      elif n_imode
+00023ce0: 203d 3d20 313a 2020 2320 7369 6d70 736f   == 1:  # simpso
+00023cf0: 6e20 696e 7465 6772 6174 696f 6e20 6d6f  n integration mo
+00023d00: 6465 0a20 2020 2020 2020 2020 2020 2020  de.             
+00023d10: 2020 2066 6f72 2069 6920 696e 2072 616e     for ii in ran
+00023d20: 6765 286e 6c6f 7329 3a0a 2020 2020 2020  ge(nlos):.      
+00023d30: 2020 2020 2020 2020 2020 2020 2020 7074                pt
+00023d40: 732c 2075 7362 6973 203d 205f 7374 2e63  s, usbis = _st.c
+00023d50: 616c 6c5f 6765 745f 7361 6d70 6c65 5f73  all_get_sample_s
+00023d60: 696e 676c 655f 616e 6928 6c69 6d73 5b30  ingle_ani(lims[0
+00023d70: 2c20 6969 5d2c 0a20 2020 2020 2020 2020  , ii],.         
+00023d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00023da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023dd0: 2020 2020 2072 6573 5f6d 765b 6969 5d2c       res_mv[ii],
-00023de0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023db0: 2020 2020 2020 206c 696d 735b 312c 2069         lims[1, i
+00023dc0: 695d 2c0a 2020 2020 2020 2020 2020 2020  i],.            
+00023dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00023df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023e00: 2020 2020 7265 735f 6d76 5b69 695d 2c0a      res_mv[ii],.
 00023e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023e20: 206e 5f64 6d6f 6465 2c20 6e5f 696d 6f64   n_dmode, n_imod
-00023e30: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00023e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00023e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023e70: 2020 2026 6c6f 635f 6566 665f 7265 735b     &loc_eff_res[
-00023e80: 305d 2c0a 2020 2020 2020 2020 2020 2020  0],.            
+00023e50: 6e5f 646d 6f64 652c 206e 5f69 6d6f 6465  n_dmode, n_imode
+00023e60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00023e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00023e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023ec0: 2020 2020 266e 625f 726f 7773 5b30 5d2c      &nb_rows[0],
-00023ed0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023ea0: 2020 266c 6f63 5f65 6666 5f72 6573 5b30    &loc_eff_res[0
+00023eb0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00023ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00023ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023ef0: 2020 2026 6e62 5f72 6f77 735b 305d 2c0a     &nb_rows[0],.
 00023f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023f10: 2072 6179 5f6f 7269 675b 3a2c 2069 693a   ray_orig[:, ii:
-00023f20: 6969 2b31 5d2c 0a20 2020 2020 2020 2020  ii+1],.         
+00023f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00023f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023f60: 2020 2020 2020 2072 6179 5f76 6469 725b         ray_vdir[
-00023f70: 3a2c 2069 693a 6969 2b31 5d29 0a20 2020  :, ii:ii+1]).   
+00023f40: 7261 795f 6f72 6967 5b3a 2c20 6969 3a69  ray_orig[:, ii:i
+00023f50: 692b 315d 2c0a 2020 2020 2020 2020 2020  i+1],.          
+00023f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00023f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023f90: 2076 616c 203d 2066 756e 6328 7074 732c   val = func(pts,
-00023fa0: 2074 3d74 2c20 7665 6374 3d2d 7573 6269   t=t, vect=-usbi
-00023fb0: 732c 202a 2a66 6b77 6461 7267 7329 0a20  s, **fkwdargs). 
-00023fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023fd0: 2020 2023 2069 6e74 6567 7261 7469 6f6e     # integration
-00023fe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00023ff0: 2020 2020 2073 6967 5b3a 2c20 6969 5d20       sig[:, ii] 
-00024000: 3d20 7363 7069 6e74 672e 7369 6d70 7328  = scpintg.simps(
-00024010: 7661 6c2c 2078 3d4e 6f6e 652c 2061 7869  val, x=None, axi
-00024020: 733d 2d31 2c0a 2020 2020 2020 2020 2020  s=-1,.          
-00024030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024050: 2020 2020 2064 783d 6c6f 635f 6566 665f       dx=loc_eff_
-00024060: 7265 735b 305d 290a 2020 2020 2020 2020  res[0]).        
-00024070: 2020 2020 656c 6966 206e 5f69 6d6f 6465      elif n_imode
-00024080: 203d 3d20 323a 2020 2320 726f 6d62 6572   == 2:  # romber
-00024090: 6720 696e 7465 6772 6174 696f 6e20 6d6f  g integration mo
-000240a0: 6465 0a20 2020 2020 2020 2020 2020 2020  de.             
-000240b0: 2020 2066 6f72 2069 6920 696e 2072 616e     for ii in ran
-000240c0: 6765 286e 6c6f 7329 3a0a 2020 2020 2020  ge(nlos):.      
-000240d0: 2020 2020 2020 2020 2020 2020 2020 7074                pt
-000240e0: 732c 2075 7362 6973 203d 205f 7374 2e63  s, usbis = _st.c
-000240f0: 616c 6c5f 6765 745f 7361 6d70 6c65 5f73  all_get_sample_s
-00024100: 696e 676c 655f 616e 6928 6c69 6d73 5b30  ingle_ani(lims[0
-00024110: 2c20 6969 5d2c 0a20 2020 2020 2020 2020  , ii],.         
-00024120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024150: 2020 2020 2020 206c 696d 735b 312c 2069         lims[1, i
-00024160: 695d 2c0a 2020 2020 2020 2020 2020 2020  i],.            
+00023f90: 2020 2020 2020 7261 795f 7664 6972 5b3a        ray_vdir[:
+00023fa0: 2c20 6969 3a69 692b 315d 290a 2020 2020  , ii:ii+1]).    
+00023fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023fc0: 7661 6c20 3d20 6675 6e63 2870 7473 2c20  val = func(pts, 
+00023fd0: 743d 742c 2076 6563 743d 2d75 7362 6973  t=t, vect=-usbis
+00023fe0: 2c20 2a2a 666b 7764 6172 6773 290a 2020  , **fkwdargs).  
+00023ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024000: 2020 2320 696e 7465 6772 6174 696f 6e0a    # integration.
+00024010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024020: 2020 2020 7369 675b 3a2c 2069 695d 203d      sig[:, ii] =
+00024030: 2073 6370 696e 7467 2e73 696d 7073 2876   scpintg.simps(v
+00024040: 616c 2c20 783d 4e6f 6e65 2c20 6178 6973  al, x=None, axis
+00024050: 3d2d 312c 0a20 2020 2020 2020 2020 2020  =-1,.           
+00024060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024080: 2020 2020 6478 3d6c 6f63 5f65 6666 5f72      dx=loc_eff_r
+00024090: 6573 5b30 5d29 0a20 2020 2020 2020 2020  es[0]).         
+000240a0: 2020 2065 6c69 6620 6e5f 696d 6f64 6520     elif n_imode 
+000240b0: 3d3d 2032 3a20 2023 2072 6f6d 6265 7267  == 2:  # romberg
+000240c0: 2069 6e74 6567 7261 7469 6f6e 206d 6f64   integration mod
+000240d0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+000240e0: 2020 666f 7220 6969 2069 6e20 7261 6e67    for ii in rang
+000240f0: 6528 6e6c 6f73 293a 0a20 2020 2020 2020  e(nlos):.       
+00024100: 2020 2020 2020 2020 2020 2020 2070 7473               pts
+00024110: 2c20 7573 6269 7320 3d20 5f73 742e 6361  , usbis = _st.ca
+00024120: 6c6c 5f67 6574 5f73 616d 706c 655f 7369  ll_get_sample_si
+00024130: 6e67 6c65 5f61 6e69 286c 696d 735b 302c  ngle_ani(lims[0,
+00024140: 2069 695d 2c0a 2020 2020 2020 2020 2020   ii],.          
+00024150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024160: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00024170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000241a0: 2020 2020 7265 735f 6d76 5b69 695d 2c0a      res_mv[ii],.
+00024180: 2020 2020 2020 6c69 6d73 5b31 2c20 6969        lims[1, ii
+00024190: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+000241a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000241b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000241c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000241d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000241d0: 2020 2072 6573 5f6d 765b 6969 5d2c 0a20     res_mv[ii],. 
 000241e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000241f0: 6e5f 646d 6f64 652c 0a20 2020 2020 2020  n_dmode,.       
+000241f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00024200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024230: 2020 2020 2020 2020 206e 5f69 6d6f 6465           n_imode
-00024240: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00024210: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00024220: 5f64 6d6f 6465 2c0a 2020 2020 2020 2020  _dmode,.        
+00024230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024240: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00024250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024280: 2020 266c 6f63 5f65 6666 5f72 6573 5b30    &loc_eff_res[0
-00024290: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00024260: 2020 2020 2020 2020 6e5f 696d 6f64 652c          n_imode,
+00024270: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00024280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024290: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000242a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000242b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000242c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000242d0: 2020 2026 6e62 5f72 6f77 735b 305d 2c0a     &nb_rows[0],.
+000242b0: 2026 6c6f 635f 6566 665f 7265 735b 305d   &loc_eff_res[0]
+000242c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000242d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000242e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000242f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024300: 2020 266e 625f 726f 7773 5b30 5d2c 0a20    &nb_rows[0],. 
 00024310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024320: 7261 795f 6f72 6967 5b3a 2c20 6969 3a69  ray_orig[:, ii:i
-00024330: 692b 315d 2c0a 2020 2020 2020 2020 2020  i+1],.          
-00024340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024370: 2020 2020 2020 7261 795f 7664 6972 5b3a        ray_vdir[:
-00024380: 2c20 6969 3a69 692b 315d 290a 2020 2020  , ii:ii+1]).    
+00024320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024340: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00024350: 6179 5f6f 7269 675b 3a2c 2069 693a 6969  ay_orig[:, ii:ii
+00024360: 2b31 5d2c 0a20 2020 2020 2020 2020 2020  +1],.           
+00024370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024380: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00024390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000243a0: 7661 6c20 3d20 6675 6e63 2870 7473 2c20  val = func(pts, 
-000243b0: 743d 742c 2076 6563 743d 2d75 7362 6973  t=t, vect=-usbis
-000243c0: 2c20 2a2a 666b 7764 6172 6773 290a 2020  , **fkwdargs).  
-000243d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000243e0: 2020 7369 675b 3a2c 2069 695d 203d 2073    sig[:, ii] = s
-000243f0: 6370 696e 7467 2e72 6f6d 6228 7661 6c2c  cpintg.romb(val,
-00024400: 2073 686f 773d 4661 6c73 652c 2061 7869   show=False, axi
-00024410: 733d 312c 0a20 2020 2020 2020 2020 2020  s=1,.           
-00024420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024440: 2020 2020 6478 3d6c 6f63 5f65 6666 5f72      dx=loc_eff_r
-00024450: 6573 5b30 5d29 0a20 2020 2020 2020 2065  es[0]).        e
-00024460: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00024470: 2023 202d 2d20 6e6f 7420 616e 6973 6f74   # -- not anisot
-00024480: 726f 7069 6320 2d2d 2d2d 2d2d 2d2d 2d2d  ropic ----------
-00024490: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000244a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000244b0: 2d2d 2d2d 2d0a 2020 2020 2020 2020 2020  -----.          
-000244c0: 2020 6966 206e 5f69 6d6f 6465 203d 3d20    if n_imode == 
-000244d0: 303a 2020 2320 2273 756d 2220 696e 7465  0:  # "sum" inte
-000244e0: 6772 6174 696f 6e20 6d6f 6465 0a20 2020  gration mode.   
-000244f0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00024500: 2069 6920 696e 2072 616e 6765 286e 6c6f   ii in range(nlo
-00024510: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
-00024520: 2020 2020 2020 2020 7074 7320 3d20 5f73          pts = _s
-00024530: 742e 6361 6c6c 5f67 6574 5f73 616d 706c  t.call_get_sampl
-00024540: 655f 7369 6e67 6c65 286c 696d 735b 302c  e_single(lims[0,
-00024550: 2069 695d 2c0a 2020 2020 2020 2020 2020   ii],.          
-00024560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024580: 2020 2020 2020 2020 2020 206c 696d 735b             lims[
-00024590: 312c 2069 695d 2c0a 2020 2020 2020 2020  1, ii],.        
+000243a0: 2020 2020 2072 6179 5f76 6469 725b 3a2c       ray_vdir[:,
+000243b0: 2069 693a 6969 2b31 5d29 0a20 2020 2020   ii:ii+1]).     
+000243c0: 2020 2020 2020 2020 2020 2020 2020 2076                 v
+000243d0: 616c 203d 2066 756e 6328 7074 732c 2074  al = func(pts, t
+000243e0: 3d74 2c20 7665 6374 3d2d 7573 6269 732c  =t, vect=-usbis,
+000243f0: 202a 2a66 6b77 6461 7267 7329 0a20 2020   **fkwdargs).   
+00024400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024410: 2073 6967 5b3a 2c20 6969 5d20 3d20 7363   sig[:, ii] = sc
+00024420: 7069 6e74 672e 726f 6d62 2876 616c 2c20  pintg.romb(val, 
+00024430: 7368 6f77 3d46 616c 7365 2c20 6178 6973  show=False, axis
+00024440: 3d31 2c0a 2020 2020 2020 2020 2020 2020  =1,.            
+00024450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024470: 2020 2064 783d 6c6f 635f 6566 665f 7265     dx=loc_eff_re
+00024480: 735b 305d 290a 2020 2020 2020 2020 656c  s[0]).        el
+00024490: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000244a0: 2320 2d2d 206e 6f74 2061 6e69 736f 7472  # -- not anisotr
+000244b0: 6f70 6963 202d 2d2d 2d2d 2d2d 2d2d 2d2d  opic -----------
+000244c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000244d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000244e0: 2d2d 2d2d 0a20 2020 2020 2020 2020 2020  ----.           
+000244f0: 2069 6620 6e5f 696d 6f64 6520 3d3d 2030   if n_imode == 0
+00024500: 3a20 2023 2022 7375 6d22 2069 6e74 6567  :  # "sum" integ
+00024510: 7261 7469 6f6e 206d 6f64 650a 2020 2020  ration mode.    
+00024520: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00024530: 6969 2069 6e20 7261 6e67 6528 6e6c 6f73  ii in range(nlos
+00024540: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00024550: 2020 2020 2020 2070 7473 203d 205f 7374         pts = _st
+00024560: 2e63 616c 6c5f 6765 745f 7361 6d70 6c65  .call_get_sample
+00024570: 5f73 696e 676c 6528 6c69 6d73 5b30 2c20  _single(lims[0, 
+00024580: 6969 5d2c 0a20 2020 2020 2020 2020 2020  ii],.           
+00024590: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000245a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000245b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000245c0: 2020 2020 2020 2020 2020 2020 2072 6573               res
-000245d0: 5f6d 765b 6969 5d2c 0a20 2020 2020 2020  _mv[ii],.       
+000245b0: 2020 2020 2020 2020 2020 6c69 6d73 5b31            lims[1
+000245c0: 2c20 6969 5d2c 0a20 2020 2020 2020 2020  , ii],.         
+000245d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000245e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000245f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024600: 2020 2020 2020 2020 2020 2020 2020 6e5f                n_
-00024610: 646d 6f64 652c 206e 5f69 6d6f 6465 2c0a  dmode, n_imode,.
+000245f0: 2020 2020 2020 2020 2020 2020 7265 735f              res_
+00024600: 6d76 5b69 695d 2c0a 2020 2020 2020 2020  mv[ii],.        
+00024610: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00024620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024650: 2020 2020 2026 6c6f 635f 6566 665f 7265       &loc_eff_re
-00024660: 735b 305d 2c0a 2020 2020 2020 2020 2020  s[0],.          
+00024630: 2020 2020 2020 2020 2020 2020 206e 5f64               n_d
+00024640: 6d6f 6465 2c20 6e5f 696d 6f64 652c 0a20  mode, n_imode,. 
+00024650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024660: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00024670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024690: 2020 2020 2020 2020 2020 2026 6e62 5f72             &nb_r
-000246a0: 6f77 735b 305d 2c0a 2020 2020 2020 2020  ows[0],.        
+00024680: 2020 2020 266c 6f63 5f65 6666 5f72 6573      &loc_eff_res
+00024690: 5b30 5d2c 0a20 2020 2020 2020 2020 2020  [0],.           
+000246a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000246b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000246c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000246d0: 2020 2020 2020 2020 2020 2020 2072 6179               ray
-000246e0: 5f6f 7269 675b 3a2c 2069 693a 6969 2b31  _orig[:, ii:ii+1
-000246f0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00024700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024720: 2020 2020 2020 2020 7261 795f 7664 6972          ray_vdir
-00024730: 5b3a 2c20 6969 3a69 692b 315d 290a 2020  [:, ii:ii+1]).  
+000246c0: 2020 2020 2020 2020 2020 266e 625f 726f            &nb_ro
+000246d0: 7773 5b30 5d2c 0a20 2020 2020 2020 2020  ws[0],.         
+000246e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000246f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024700: 2020 2020 2020 2020 2020 2020 7261 795f              ray_
+00024710: 6f72 6967 5b3a 2c20 6969 3a69 692b 315d  orig[:, ii:ii+1]
+00024720: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00024730: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00024740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024750: 2020 7661 6c5f 3264 203d 2066 756e 6328    val_2d = func(
-00024760: 7074 732c 2074 3d74 2c20 2a2a 666b 7764  pts, t=t, **fkwd
-00024770: 6172 6773 290a 2020 2020 2020 2020 2020  args).          
-00024780: 2020 2020 2020 2020 2020 7369 675b 3a2c            sig[:,
-00024790: 2069 695d 203d 206e 702e 7375 6d28 7661   ii] = np.sum(va
-000247a0: 6c5f 3264 2c20 6178 6973 3d2d 3129 2a6c  l_2d, axis=-1)*l
-000247b0: 6f63 5f65 6666 5f72 6573 5b30 5d0a 2020  oc_eff_res[0].  
-000247c0: 2020 2020 2020 2020 2020 656c 6966 206e            elif n
-000247d0: 5f69 6d6f 6465 203d 3d20 313a 2020 2320  _imode == 1:  # 
-000247e0: 2273 696d 7073 6f6e 2220 696e 7465 6772  "simpson" integr
-000247f0: 6174 696f 6e20 6d6f 6465 0a20 2020 2020  ation mode.     
-00024800: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
-00024810: 6920 696e 2072 616e 6765 286e 6c6f 7329  i in range(nlos)
-00024820: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00024830: 2020 2020 2020 7074 7320 3d20 5f73 742e        pts = _st.
-00024840: 6361 6c6c 5f67 6574 5f73 616d 706c 655f  call_get_sample_
-00024850: 7369 6e67 6c65 286c 696d 735b 302c 2069  single(lims[0, i
-00024860: 695d 2c0a 2020 2020 2020 2020 2020 2020  i],.            
-00024870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024890: 2020 2020 2020 2020 206c 696d 735b 312c           lims[1,
-000248a0: 2069 695d 2c0a 2020 2020 2020 2020 2020   ii],.          
+00024750: 2020 2020 2020 2072 6179 5f76 6469 725b         ray_vdir[
+00024760: 3a2c 2069 693a 6969 2b31 5d29 0a20 2020  :, ii:ii+1]).   
+00024770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024780: 2076 616c 5f32 6420 3d20 6675 6e63 2870   val_2d = func(p
+00024790: 7473 2c20 743d 742c 202a 2a66 6b77 6461  ts, t=t, **fkwda
+000247a0: 7267 7329 0a20 2020 2020 2020 2020 2020  rgs).           
+000247b0: 2020 2020 2020 2020 2073 6967 5b3a 2c20           sig[:, 
+000247c0: 6969 5d20 3d20 6e70 2e73 756d 2876 616c  ii] = np.sum(val
+000247d0: 5f32 642c 2061 7869 733d 2d31 292a 6c6f  _2d, axis=-1)*lo
+000247e0: 635f 6566 665f 7265 735b 305d 0a20 2020  c_eff_res[0].   
+000247f0: 2020 2020 2020 2020 2065 6c69 6620 6e5f           elif n_
+00024800: 696d 6f64 6520 3d3d 2031 3a20 2023 2022  imode == 1:  # "
+00024810: 7369 6d70 736f 6e22 2069 6e74 6567 7261  simpson" integra
+00024820: 7469 6f6e 206d 6f64 650a 2020 2020 2020  tion mode.      
+00024830: 2020 2020 2020 2020 2020 666f 7220 6969            for ii
+00024840: 2069 6e20 7261 6e67 6528 6e6c 6f73 293a   in range(nlos):
+00024850: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00024860: 2020 2020 2070 7473 203d 205f 7374 2e63       pts = _st.c
+00024870: 616c 6c5f 6765 745f 7361 6d70 6c65 5f73  all_get_sample_s
+00024880: 696e 676c 6528 6c69 6d73 5b30 2c20 6969  ingle(lims[0, ii
+00024890: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+000248a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000248b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000248c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000248d0: 2020 2020 2020 2020 2020 2072 6573 5f6d             res_m
-000248e0: 765b 6969 5d2c 0a20 2020 2020 2020 2020  v[ii],.         
+000248c0: 2020 2020 2020 2020 6c69 6d73 5b31 2c20          lims[1, 
+000248d0: 6969 5d2c 0a20 2020 2020 2020 2020 2020  ii],.           
+000248e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000248f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024910: 2020 2020 2020 2020 2020 2020 6e5f 646d              n_dm
-00024920: 6f64 652c 206e 5f69 6d6f 6465 2c0a 2020  ode, n_imode,.  
+00024900: 2020 2020 2020 2020 2020 7265 735f 6d76            res_mv
+00024910: 5b69 695d 2c0a 2020 2020 2020 2020 2020  [ii],.          
+00024920: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00024930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024960: 2020 2026 6c6f 635f 6566 665f 7265 735b     &loc_eff_res[
-00024970: 305d 2c0a 2020 2020 2020 2020 2020 2020  0],.            
+00024940: 2020 2020 2020 2020 2020 206e 5f64 6d6f             n_dmo
+00024950: 6465 2c20 6e5f 696d 6f64 652c 0a20 2020  de, n_imode,.   
+00024960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024970: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00024980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000249a0: 2020 2020 2020 2020 2026 6e62 5f72 6f77           &nb_row
-000249b0: 735b 305d 2c0a 2020 2020 2020 2020 2020  s[0],.          
+00024990: 2020 266c 6f63 5f65 6666 5f72 6573 5b30    &loc_eff_res[0
+000249a0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+000249b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000249c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000249d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000249e0: 2020 2020 2020 2020 2020 2072 6179 5f6f             ray_o
-000249f0: 7269 675b 3a2c 2069 693a 6969 2b31 5d2c  rig[:, ii:ii+1],
-00024a00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00024a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024a30: 2020 2020 2020 7261 795f 7664 6972 5b3a        ray_vdir[:
-00024a40: 2c20 6969 3a69 692b 315d 290a 2020 2020  , ii:ii+1]).    
+000249d0: 2020 2020 2020 2020 266e 625f 726f 7773          &nb_rows
+000249e0: 5b30 5d2c 0a20 2020 2020 2020 2020 2020  [0],.           
+000249f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024a10: 2020 2020 2020 2020 2020 7261 795f 6f72            ray_or
+00024a20: 6967 5b3a 2c20 6969 3a69 692b 315d 2c0a  ig[:, ii:ii+1],.
+00024a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00024a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024a60: 7661 6c20 3d20 6675 6e63 2870 7473 2c20  val = func(pts, 
-00024a70: 743d 742c 202a 2a66 6b77 6461 7267 7329  t=t, **fkwdargs)
-00024a80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00024a90: 2020 2020 2073 6967 5b3a 2c20 6969 5d20       sig[:, ii] 
-00024aa0: 3d20 7363 7069 6e74 672e 7369 6d70 7328  = scpintg.simps(
-00024ab0: 7661 6c2c 2078 3d4e 6f6e 652c 2061 7869  val, x=None, axi
-00024ac0: 733d 2d31 2c0a 2020 2020 2020 2020 2020  s=-1,.          
-00024ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024af0: 2020 2020 2020 6478 3d6c 6f63 5f65 6666        dx=loc_eff
-00024b00: 5f72 6573 5b30 5d29 0a20 2020 2020 2020  _res[0]).       
-00024b10: 2020 2020 2065 6c69 6620 6e5f 696d 6f64       elif n_imod
-00024b20: 6520 3d3d 2032 3a20 2023 2022 726f 6d62  e == 2:  # "romb
-00024b30: 6572 6722 2069 6e74 6567 7261 7469 6f6e  erg" integration
-00024b40: 206d 6f64 650a 2020 2020 2020 2020 2020   mode.          
-00024b50: 2020 2020 2020 666f 7220 6969 2069 6e20        for ii in 
-00024b60: 7261 6e67 6528 6e6c 6f73 293a 0a20 2020  range(nlos):.   
-00024b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024b80: 2070 7473 203d 205f 7374 2e63 616c 6c5f   pts = _st.call_
-00024b90: 6765 745f 7361 6d70 6c65 5f73 696e 676c  get_sample_singl
-00024ba0: 6528 6c69 6d73 5b30 2c20 6969 5d2c 0a20  e(lims[0, ii],. 
-00024bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024be0: 2020 2020 6c69 6d73 5b31 2c20 6969 5d2c      lims[1, ii],
-00024bf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00024a60: 2020 2020 2072 6179 5f76 6469 725b 3a2c       ray_vdir[:,
+00024a70: 2069 693a 6969 2b31 5d29 0a20 2020 2020   ii:ii+1]).     
+00024a80: 2020 2020 2020 2020 2020 2020 2020 2076                 v
+00024a90: 616c 203d 2066 756e 6328 7074 732c 2074  al = func(pts, t
+00024aa0: 3d74 2c20 2a2a 666b 7764 6172 6773 290a  =t, **fkwdargs).
+00024ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024ac0: 2020 2020 7369 675b 3a2c 2069 695d 203d      sig[:, ii] =
+00024ad0: 2073 6370 696e 7467 2e73 696d 7073 2876   scpintg.simps(v
+00024ae0: 616c 2c20 783d 4e6f 6e65 2c20 6178 6973  al, x=None, axis
+00024af0: 3d2d 312c 0a20 2020 2020 2020 2020 2020  =-1,.           
+00024b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024b20: 2020 2020 2064 783d 6c6f 635f 6566 665f       dx=loc_eff_
+00024b30: 7265 735b 305d 290a 2020 2020 2020 2020  res[0]).        
+00024b40: 2020 2020 656c 6966 206e 5f69 6d6f 6465      elif n_imode
+00024b50: 203d 3d20 323a 2020 2320 2272 6f6d 6265   == 2:  # "rombe
+00024b60: 7267 2220 696e 7465 6772 6174 696f 6e20  rg" integration 
+00024b70: 6d6f 6465 0a20 2020 2020 2020 2020 2020  mode.           
+00024b80: 2020 2020 2066 6f72 2069 6920 696e 2072       for ii in r
+00024b90: 616e 6765 286e 6c6f 7329 3a0a 2020 2020  ange(nlos):.    
+00024ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024bb0: 7074 7320 3d20 5f73 742e 6361 6c6c 5f67  pts = _st.call_g
+00024bc0: 6574 5f73 616d 706c 655f 7369 6e67 6c65  et_sample_single
+00024bd0: 286c 696d 735b 302c 2069 695d 2c0a 2020  (lims[0, ii],.  
+00024be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00024c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024c20: 2020 2020 2020 7265 735f 6d76 5b69 695d        res_mv[ii]
-00024c30: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00024c10: 2020 206c 696d 735b 312c 2069 695d 2c0a     lims[1, ii],.
+00024c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00024c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024c60: 2020 2020 2020 206e 5f64 6d6f 6465 2c20         n_dmode, 
-00024c70: 6e5f 696d 6f64 652c 0a20 2020 2020 2020  n_imode,.       
+00024c50: 2020 2020 2072 6573 5f6d 765b 6969 5d2c       res_mv[ii],
+00024c60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00024c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00024c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024ca0: 2020 2020 2020 2020 2020 2020 2020 266c                &l
-00024cb0: 6f63 5f65 6666 5f72 6573 5b30 5d2c 0a20  oc_eff_res[0],. 
+00024c90: 2020 2020 2020 6e5f 646d 6f64 652c 206e        n_dmode, n
+00024ca0: 5f69 6d6f 6465 2c0a 2020 2020 2020 2020  _imode,.        
+00024cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00024cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024cf0: 2020 2020 266e 625f 726f 7773 5b30 5d2c      &nb_rows[0],
-00024d00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00024cd0: 2020 2020 2020 2020 2020 2020 2026 6c6f               &lo
+00024ce0: 635f 6566 665f 7265 735b 305d 2c0a 2020  c_eff_res[0],.  
+00024cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00024d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024d30: 2020 2020 2020 7261 795f 6f72 6967 5b3a        ray_orig[:
-00024d40: 2c20 6969 3a69 692b 315d 2c0a 2020 2020  , ii:ii+1],.    
+00024d20: 2020 2026 6e62 5f72 6f77 735b 305d 2c0a     &nb_rows[0],.
+00024d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00024d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024d80: 2072 6179 5f76 6469 725b 3a2c 2069 693a   ray_vdir[:, ii:
-00024d90: 6969 2b31 5d29 0a20 2020 2020 2020 2020  ii+1]).         
-00024da0: 2020 2020 2020 2020 2020 2076 616c 203d             val =
-00024db0: 2066 756e 6328 7074 732c 2074 3d74 2c20   func(pts, t=t, 
-00024dc0: 2a2a 666b 7764 6172 6773 290a 2020 2020  **fkwdargs).    
-00024dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024de0: 7369 675b 3a2c 2069 695d 203d 2073 6370  sig[:, ii] = scp
-00024df0: 696e 7467 2e72 6f6d 6228 7661 6c2c 2073  intg.romb(val, s
-00024e00: 686f 773d 4661 6c73 652c 2061 7869 733d  how=False, axis=
-00024e10: 312c 0a20 2020 2020 2020 2020 2020 2020  1,.             
-00024e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024e40: 2064 783d 6c6f 635f 6566 665f 7265 735b   dx=loc_eff_res[
-00024e50: 305d 290a 2020 2020 7265 7475 726e 2073  0]).    return s
-00024e60: 6967 0a0a 0a23 2323 2323 2323 2323 2323  ig...###########
-00024e70: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00024e80: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00024e90: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00024ea0: 2323 2323 2323 2323 2323 230a 2320 2020  ###########.#   
-00024eb0: 2020 2020 2020 2020 2020 2020 5369 6e6f              Sino
-00024ec0: 6772 616d 2d73 7065 6369 6669 630a 2323  gram-specific.##
-00024ed0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00024ee0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00024ef0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00024d60: 2020 2020 2072 6179 5f6f 7269 675b 3a2c       ray_orig[:,
+00024d70: 2069 693a 6969 2b31 5d2c 0a20 2020 2020   ii:ii+1],.     
+00024d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024db0: 7261 795f 7664 6972 5b3a 2c20 6969 3a69  ray_vdir[:, ii:i
+00024dc0: 692b 315d 290a 2020 2020 2020 2020 2020  i+1]).          
+00024dd0: 2020 2020 2020 2020 2020 7661 6c20 3d20            val = 
+00024de0: 6675 6e63 2870 7473 2c20 743d 742c 202a  func(pts, t=t, *
+00024df0: 2a66 6b77 6461 7267 7329 0a20 2020 2020  *fkwdargs).     
+00024e00: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00024e10: 6967 5b3a 2c20 6969 5d20 3d20 7363 7069  ig[:, ii] = scpi
+00024e20: 6e74 672e 726f 6d62 2876 616c 2c20 7368  ntg.romb(val, sh
+00024e30: 6f77 3d46 616c 7365 2c20 6178 6973 3d31  ow=False, axis=1
+00024e40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00024e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024e70: 6478 3d6c 6f63 5f65 6666 5f72 6573 5b30  dx=loc_eff_res[0
+00024e80: 5d29 0a20 2020 2072 6574 7572 6e20 7369  ]).    return si
+00024e90: 670a 0a0a 2323 2323 2323 2323 2323 2323  g...############
+00024ea0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00024eb0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00024ec0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00024ed0: 2323 2323 2323 2323 2323 0a23 2020 2020  ##########.#    
+00024ee0: 2020 2020 2020 2020 2020 2053 696e 6f67             Sinog
+00024ef0: 7261 6d2d 7370 6563 6966 6963 0a23 2323  ram-specific.###
 00024f00: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00024f10: 2323 2323 0a0a 0a64 6566 204c 4f53 5f73  ####...def LOS_s
-00024f20: 696e 6f5f 6669 6e64 526f 6f74 6b50 4d69  ino_findRootkPMi
-00024f30: 6e5f 546f 7228 646f 7562 6c65 2075 5061  n_Tor(double uPa
-00024f40: 724e 2c20 646f 7562 6c65 2075 4e2c 2064  rN, double uN, d
-00024f50: 6f75 626c 6520 5363 612c 2064 6f75 626c  ouble Sca, doubl
-00024f60: 6520 525a 302c 0a20 2020 2020 2020 2020  e RZ0,.         
-00024f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024f80: 2020 2020 2020 2064 6f75 626c 6520 525a         double RZ
-00024f90: 312c 2064 6f75 626c 6520 5363 6150 2c20  1, double ScaP, 
-00024fa0: 646f 7562 6c65 2044 5061 724e 2c0a 2020  double DParN,.  
-00024fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024fc0: 2020 2020 2020 2020 2020 2020 2020 646f                do
-00024fd0: 7562 6c65 206b 4f75 742c 2064 6f75 626c  uble kOut, doubl
-00024fe0: 6520 4430 2c20 646f 7562 6c65 2044 312c  e D0, double D1,
-00024ff0: 2064 6f75 626c 6520 4432 2c0a 2020 2020   double D2,.    
-00025000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025010: 2020 2020 2020 2020 2020 2020 646f 7562              doub
-00025020: 6c65 2075 302c 2064 6f75 626c 6520 7531  le u0, double u1
-00025030: 2c20 646f 7562 6c65 2075 322c 2073 7472  , double u2, str
-00025040: 204d 6f64 653d 274c 4f53 2729 3a0a 2020   Mode='LOS'):.  
-00025050: 2020 2222 220a 2020 2020 5265 6e64 7265    """.    Rendre
-00025060: 2022 7665 6374 6f72 6965 6c22 2073 7572   "vectoriel" sur
-00025070: 204c 4f53 2065 7420 7375 7220 6c65 7320   LOS et sur les 
-00025080: 6365 7263 6c65 7320 2864 6575 7820 626f  cercles (deux bo
-00025090: 7563 6c65 7320 2266 6f72 2229 0a20 2020  ucles "for").   
-000250a0: 2069 6e74 6572 7365 6374 696f 6e20 6c69   intersection li
-000250b0: 676e 6520 6574 2063 6572 636c 650a 2020  gne et cercle.  
-000250c0: 2020 646f 7562 6c65 2075 5061 724e 203a    double uParN :
-000250d0: 2063 6f6d 706f 7361 6e74 6520 6465 2075   composante de u
-000250e0: 2070 6172 616c 6c65 6c20 6175 2070 6c61   parallel au pla
-000250f0: 6e20 2878 2c79 290a 2020 2020 2020 2020  n (x,y).        
-00025100: 646f 7562 6c65 2075 4e20 3a20 757a 0a20  double uN : uz. 
-00025110: 2020 2020 2020 2064 6f75 626c 6520 5363         double Sc
-00025120: 6120 3a20 3f3f 3f20 7072 6f64 7569 7420  a : ??? produit 
-00025130: 7363 616c 6169 7265 202e 2e2e 203f 0a20  scalaire ... ?. 
-00025140: 2020 2020 2020 2064 6f75 626c 6520 525a         double RZ
-00025150: 3020 3a20 4772 616e 6420 7261 796f 6e20  0 : Grand rayon 
-00025160: 6475 2063 6572 636c 650a 2020 2020 2020  du cercle.      
-00025170: 2020 646f 7562 6c65 2052 5a31 203a 205a    double RZ1 : Z
-00025180: 0a20 2020 2020 2020 203d 3e20 6365 7263  .        => cerc
-00025190: 6c65 2065 7374 2063 656e 7472 c3a9 2061  le est centr.. a
-000251a0: 7520 706f 696e 7420 2830 2c20 302c 2052  u point (0, 0, R
-000251b0: 5a31 2920 6574 2072 6179 6f6e 2052 5a30  Z1) et rayon RZ0
-000251c0: 0a20 2020 2020 2020 2064 6f75 626c 6520  .        double 
-000251d0: 5363 6150 203a 202e 2e2e 2e20 3f0a 2020  ScaP : .... ?.  
-000251e0: 2020 2020 2020 646f 7562 6c65 2044 5061        double DPa
-000251f0: 724e 203a 2044 206f 7269 6769 6e65 2064  rN : D origine d
-00025200: 6520 4c4f 532e 2e2e 2e20 3f20 4e20 3d3e  e LOS.... ? N =>
-00025210: 206e 6f72 6d65 2064 6520 6c61 2063 6f6d   norme de la com
-00025220: 706f 7361 6e74 6520 6475 2076 6563 7465  posante du vecte
-00025230: 7572 204f 440a 2020 2020 2020 2020 646f  ur OD.        do
-00025240: 7562 6c65 206b 4f75 7420 3a20 6b6d 6178  uble kOut : kmax
-00025250: 206f c3b9 206f 6e20 7065 7574 2074 726f   o.. on peut tro
-00025260: 7576 6572 2075 6e20 72c3 a973 756c 7461  uver un r..sulta
-00025270: 740a 2020 2020 2020 2020 646f 7562 6c65  t.        double
-00025280: 2044 302c 2064 6f75 626c 6520 4431 2c20   D0, double D1, 
-00025290: 646f 7562 6c65 2044 3220 3a20 636f 6d70  double D2 : comp
-000252a0: 6f73 616e 7465 7320 6465 2044 2028 6f72  osantes de D (or
-000252b0: 6967 696e 6520 4c4f 5329 0a20 2020 2020  igine LOS).     
-000252c0: 2020 2064 6f75 626c 6520 7530 2c20 646f     double u0, do
-000252d0: 7562 6c65 2075 312c 2064 6f75 626c 6520  uble u1, double 
-000252e0: 7532 203a 2063 6f6d 706f 7361 6e74 6573  u2 : composantes
-000252f0: 2064 6520 5520 2864 6972 6563 7469 6f6e   de U (direction
-00025300: 204c 4f53 290a 2020 2020 2020 2020 7374   LOS).        st
-00025310: 7220 4d6f 6465 3d27 4c4f 5327 203a 2073  r Mode='LOS' : s
-00025320: 6920 4c4f 5320 7061 7320 6465 2073 6f6c  i LOS pas de sol
-00025330: 2061 7072 c3a8 7320 6b6d 6178 290a 2020   apr..s kmax).  
-00025340: 2020 3a3a 3a20 4661 6972 6520 756e 6520    ::: Faire une 
-00025350: 666f 6e63 7469 6f6e 2064 6f75 626c 6520  fonction double 
-00025360: 6d61 6973 2071 7569 2072 656e 766f 6974  mais qui renvoit
-00025370: 2051 5545 2075 6e20 7461 626c 6561 7520   QUE un tableau 
-00025380: 6465 2062 6f6f 6c20 6176 6563 2074 7275  de bool avec tru
-00025390: 6520 7369 0a20 2020 206c 6120 6469 7374  e si.    la dist
-000253a0: 616e 6365 2065 7374 2070 6c75 7320 7065  ance est plus pe
-000253b0: 7469 7465 2071 7527 756e 2063 6572 7461  tite qu'un certa
-000253c0: 696e 2065 7073 2c20 6661 6c73 6520 7369  in eps, false si
-000253d0: 6e6f 6e2e 0a20 2020 2054 4f44 4f3a 202e  non..    TODO: .
-000253e0: 2e2e 2e2e 2e2e 2e2e 2e2e 2040 4c4d 0a20  .......... @LM. 
-000253f0: 2020 2022 2222 0a20 2020 2063 6465 6620     """.    cdef 
-00025400: 646f 7562 6c65 2061 3420 3d20 2875 5061  double a4 = (uPa
-00025410: 724e 2a75 4e2a 754e 292a 2a32 2c20 6133  rN*uN*uN)**2, a3
-00025420: 203d 2032 2a28 2028 5363 612d 525a 312a   = 2*( (Sca-RZ1*
-00025430: 7532 292a 2875 5061 724e 2a75 4e29 2a2a  u2)*(uParN*uN)**
-00025440: 3220 2b20 5363 6150 2a75 4e2a 2a34 2029  2 + ScaP*uN**4 )
-00025450: 0a20 2020 2063 6465 6620 646f 7562 6c65  .    cdef double
-00025460: 2061 3220 3d20 2875 5061 724e 2a28 5363   a2 = (uParN*(Sc
-00025470: 612d 525a 312a 7532 2929 2a2a 3220 2b20  a-RZ1*u2))**2 + 
-00025480: 342e 2a53 6361 502a 2853 6361 2d52 5a31  4.*ScaP*(Sca-RZ1
-00025490: 2a75 3229 2a75 4e2a 2a32 202b 2028 4450  *u2)*uN**2 + (DP
-000254a0: 6172 4e2a 754e 2a75 4e29 2a2a 3220 2d20  arN*uN*uN)**2 - 
-000254b0: 2852 5a30 2a75 5061 724e 2a75 5061 724e  (RZ0*uParN*uParN
-000254c0: 292a 2a32 0a20 2020 2063 6465 6620 646f  )**2.    cdef do
-000254d0: 7562 6c65 2061 3120 3d20 322a 2820 5363  uble a1 = 2*( Sc
-000254e0: 6150 2a28 5363 612d 525a 312a 7532 292a  aP*(Sca-RZ1*u2)*
-000254f0: 2a32 202b 2028 5363 612d 525a 312a 7532  *2 + (Sca-RZ1*u2
-00025500: 292a 2844 5061 724e 2a75 4e29 2a2a 3220  )*(DParN*uN)**2 
-00025510: 2d20 5363 6150 2a28 525a 302a 7550 6172  - ScaP*(RZ0*uPar
-00025520: 4e29 2a2a 3220 290a 2020 2020 6364 6566  N)**2 ).    cdef
-00025530: 2064 6f75 626c 6520 6130 203d 2028 2853   double a0 = ((S
-00025540: 6361 2d52 5a31 2a75 3229 2a44 5061 724e  ca-RZ1*u2)*DParN
-00025550: 292a 2a32 202d 2028 525a 302a 5363 6150  )**2 - (RZ0*ScaP
-00025560: 292a 2a32 0a20 2020 2063 6465 6620 6e70  )**2.    cdef np
-00025570: 2e6e 6461 7272 6179 2072 6f6f 203d 206e  .ndarray roo = n
-00025580: 702e 726f 6f74 7328 6e70 2e61 7272 6179  p.roots(np.array
-00025590: 285b 6134 2c61 332c 6132 2c61 312c 6130  ([a4,a3,a2,a1,a0
-000255a0: 5d29 290a 2020 2020 6364 6566 206c 6973  ])).    cdef lis
-000255b0: 7420 4b4b 203d 206c 6973 7428 6e70 2e72  t KK = list(np.r
-000255c0: 6561 6c28 726f 6f5b 6e70 2e69 7372 6561  eal(roo[np.isrea
-000255d0: 6c28 726f 6f29 5d29 2920 2020 2320 5468  l(roo)]))   # Th
-000255e0: 6572 6520 6d69 6768 7420 6265 2073 6576  ere might be sev
-000255f0: 6572 616c 2073 6f6c 7574 696f 6e73 0a20  eral solutions. 
-00025600: 2020 2063 6465 6620 6c69 7374 2050 6b2c     cdef list Pk,
-00025610: 2050 6b32 442c 2072 6b0a 2020 2020 6364   Pk2D, rk.    cd
-00025620: 6566 2064 6f75 626c 6520 6b6b 2c20 6b50  ef double kk, kP
-00025630: 4d69 6e0a 2020 2020 6966 204d 6f64 653d  Min.    if Mode=
-00025640: 3d27 4c4f 5327 3a20 2020 2020 2020 2020  ='LOS':         
-00025650: 2020 2020 2020 2020 2020 2020 2320 5461              # Ta
-00025660: 6b65 2073 6f6c 7574 696f 6e20 6f6e 2070  ke solution on p
-00025670: 6879 7369 6361 6c20 4c4f 530a 2020 2020  hysical LOS.    
-00025680: 2020 2020 6966 2061 6e79 285b 3020 3c3d      if any([0 <=
-00025690: 206b 6b20 3c3d 206b 4f75 7420 666f 7220   kk <= kOut for 
-000256a0: 6b6b 2069 6e20 4b4b 5d29 3a0a 2020 2020  kk in KK]):.    
-000256b0: 2020 2020 2020 2020 4b4b 203d 205b 6b6b          KK = [kk
-000256c0: 2066 6f72 206b 6b20 696e 204b 4b20 6966   for kk in KK if
-000256d0: 2030 203c 3d20 6b6b 203c 3d20 6b4f 7574   0 <= kk <= kOut
-000256e0: 5d0a 2020 2020 2020 2020 2020 2020 506b  ].            Pk
-000256f0: 203d 205b 2844 302b 6b6b 2a75 302c 4431   = [(D0+kk*u0,D1
-00025700: 2b6b 6b2a 7531 2c44 322b 6b6b 2a75 3229  +kk*u1,D2+kk*u2)
-00025710: 2066 6f72 206b 6b20 696e 204b 4b5d 0a20   for kk in KK]. 
-00025720: 2020 2020 2020 2020 2020 2050 6b32 4420             Pk2D 
-00025730: 3d20 5b28 635f 7371 7274 2870 705b 305d  = [(c_sqrt(pp[0]
-00025740: 2a2a 322b 7070 5b31 5d2a 2a32 292c 2070  **2+pp[1]**2), p
-00025750: 705b 325d 2920 666f 7220 7070 2069 6e20  p[2]) for pp in 
-00025760: 506b 5d0a 2020 2020 2020 2020 2020 2020  Pk].            
-00025770: 726b 203d 205b 2870 705b 305d 2d52 5a30  rk = [(pp[0]-RZ0
-00025780: 292a 2a32 2b28 7070 5b31 5d2d 525a 3129  )**2+(pp[1]-RZ1)
-00025790: 2a2a 3220 666f 7220 7070 2069 6e20 506b  **2 for pp in Pk
-000257a0: 3244 5d0a 2020 2020 2020 2020 2020 2020  2D].            
-000257b0: 6b50 4d69 6e20 3d20 4b4b 5b72 6b2e 696e  kPMin = KK[rk.in
-000257c0: 6465 7828 6d69 6e28 726b 2929 5d0a 2020  dex(min(rk))].  
-000257d0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-000257e0: 2020 2020 2020 2020 6b50 4d69 6e20 3d20          kPMin = 
-000257f0: 6d69 6e28 5b63 5f61 6273 286b 6b29 2066  min([c_abs(kk) f
-00025800: 6f72 206b 6b20 696e 204b 4b5d 2920 2023  or kk in KK])  #
-00025810: 2045 6c73 652c 2074 616b 6520 7468 6520   Else, take the 
-00025820: 6f6e 6520 636c 6f73 6573 7420 746f 2044  one closest to D
-00025830: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-00025840: 2020 2050 6b20 3d20 5b28 4430 2b6b 6b2a     Pk = [(D0+kk*
-00025850: 7530 2c44 312b 6b6b 2a75 312c 4432 2b6b  u0,D1+kk*u1,D2+k
-00025860: 6b2a 7532 2920 666f 7220 6b6b 2069 6e20  k*u2) for kk in 
-00025870: 4b4b 5d0a 2020 2020 2020 2020 506b 3244  KK].        Pk2D
-00025880: 203d 205b 2863 5f73 7172 7428 7070 5b30   = [(c_sqrt(pp[0
-00025890: 5d2a 2a32 2b70 705b 315d 2a2a 3229 2c20  ]**2+pp[1]**2), 
-000258a0: 7070 5b32 5d29 2066 6f72 2070 7020 696e  pp[2]) for pp in
-000258b0: 2050 6b5d 0a20 2020 2020 2020 2072 6b20   Pk].        rk 
-000258c0: 3d20 5b28 7070 5b30 5d2d 525a 3029 2a2a  = [(pp[0]-RZ0)**
-000258d0: 322b 2870 705b 315d 2d52 5a31 292a 2a32  2+(pp[1]-RZ1)**2
-000258e0: 2066 6f72 2070 7020 696e 2050 6b32 445d   for pp in Pk2D]
-000258f0: 0a20 2020 2020 2020 206b 504d 696e 203d  .        kPMin =
-00025900: 204b 4b5b 726b 2e69 6e64 6578 286d 696e   KK[rk.index(min
-00025910: 2872 6b29 295d 0a20 2020 2072 6574 7572  (rk))].    retur
-00025920: 6e20 6b50 4d69 6e20 2320 2b20 6469 7374  n kPMin # + dist
-00025930: 616e 6365 2061 7520 6365 7263 6c65 0a0a  ance au cercle..
-00025940: 0a0a 6364 6566 204c 4f53 5f73 696e 6f5f  ..cdef LOS_sino_
-00025950: 546f 7228 646f 7562 6c65 2044 302c 2064  Tor(double D0, d
-00025960: 6f75 626c 6520 4431 2c20 646f 7562 6c65  ouble D1, double
-00025970: 2044 322c 2064 6f75 626c 6520 7530 2c20   D2, double u0, 
-00025980: 646f 7562 6c65 2075 312c 0a20 2020 2020  double u1,.     
-00025990: 2020 2020 2020 2020 2020 2020 2064 6f75               dou
-000259a0: 626c 6520 7532 2c20 646f 7562 6c65 2052  ble u2, double R
-000259b0: 5a30 2c20 646f 7562 6c65 2052 5a31 2c20  Z0, double RZ1, 
-000259c0: 7374 7220 4d6f 6465 3d27 4c4f 5327 2c20  str Mode='LOS', 
-000259d0: 646f 7562 6c65 0a20 2020 2020 2020 2020  double.         
-000259e0: 2020 2020 2020 2020 206b 4f75 743d 435f           kOut=C_
-000259f0: 494e 4629 3a0a 0a20 2020 2063 6465 6620  INF):..    cdef 
-00025a00: 646f 7562 6c65 2020 2020 754e 203d 2063  double    uN = c
-00025a10: 5f73 7172 7428 7530 2a2a 322b 7531 2a2a  _sqrt(u0**2+u1**
-00025a20: 322b 7532 2a2a 3229 2c20 7550 6172 4e20  2+u2**2), uParN 
-00025a30: 3d20 635f 7371 7274 2875 302a 2a32 2b75  = c_sqrt(u0**2+u
-00025a40: 312a 2a32 292c 2044 5061 724e 203d 2063  1**2), DParN = c
-00025a50: 5f73 7172 7428 4430 2a2a 322b 4431 2a2a  _sqrt(D0**2+D1**
-00025a60: 3229 0a20 2020 2063 6465 6620 646f 7562  2).    cdef doub
-00025a70: 6c65 2020 2020 5363 6120 3d20 7530 2a44  le    Sca = u0*D
-00025a80: 302b 7531 2a44 312b 7532 2a44 322c 2053  0+u1*D1+u2*D2, S
-00025a90: 6361 5020 3d20 7530 2a44 302b 7531 2a44  caP = u0*D0+u1*D
-00025aa0: 310a 2020 2020 6364 6566 2064 6f75 626c  1.    cdef doubl
-00025ab0: 6520 2020 206b 504d 696e 0a20 2020 2069  e    kPMin.    i
-00025ac0: 6620 7550 6172 4e20 3d3d 2030 2e3a 0a20  f uParN == 0.:. 
-00025ad0: 2020 2020 2020 206b 504d 696e 203d 2028         kPMin = (
-00025ae0: 525a 312d 4432 292f 7532 0a20 2020 2065  RZ1-D2)/u2.    e
-00025af0: 6c73 653a 0a20 2020 2020 2020 206b 504d  lse:.        kPM
-00025b00: 696e 203d 204c 4f53 5f73 696e 6f5f 6669  in = LOS_sino_fi
-00025b10: 6e64 526f 6f74 6b50 4d69 6e5f 546f 7228  ndRootkPMin_Tor(
-00025b20: 7550 6172 4e2c 2075 4e2c 2053 6361 2c20  uParN, uN, Sca, 
-00025b30: 525a 302c 2052 5a31 2c20 5363 6150 2c20  RZ0, RZ1, ScaP, 
-00025b40: 4450 6172 4e2c 206b 4f75 742c 2044 302c  DParN, kOut, D0,
-00025b50: 2044 312c 2044 322c 2075 302c 2075 312c   D1, D2, u0, u1,
-00025b60: 2075 322c 204d 6f64 653d 4d6f 6465 290a   u2, Mode=Mode).
-00025b70: 2020 2020 6364 6566 2064 6f75 626c 6520      cdef double 
-00025b80: 2020 2050 4d69 6e30 203d 2044 302b 6b50     PMin0 = D0+kP
-00025b90: 4d69 6e2a 7530 2c20 504d 696e 3120 3d20  Min*u0, PMin1 = 
-00025ba0: 4431 2b6b 504d 696e 2a75 312c 2050 4d69  D1+kPMin*u1, PMi
-00025bb0: 6e32 203d 2044 322b 6b50 4d69 6e2a 7532  n2 = D2+kPMin*u2
-00025bc0: 0a20 2020 2063 6465 6620 646f 7562 6c65  .    cdef double
-00025bd0: 2020 2020 504d 696e 326e 6f72 6d20 3d20      PMin2norm = 
-00025be0: 635f 7371 7274 2850 4d69 6e30 2a2a 322b  c_sqrt(PMin0**2+
-00025bf0: 504d 696e 312a 2a32 290a 2020 2020 6364  PMin1**2).    cd
-00025c00: 6566 2064 6f75 626c 6520 2020 2050 4d69  ef double    PMi
-00025c10: 6e32 4430 203d 2050 4d69 6e32 6e6f 726d  n2D0 = PMin2norm
-00025c20: 2c20 504d 696e 3244 3120 3d20 504d 696e  , PMin2D1 = PMin
-00025c30: 320a 2020 2020 6364 6566 2064 6f75 626c  2.    cdef doubl
-00025c40: 6520 2020 2052 4d69 6e20 3d20 635f 7371  e    RMin = c_sq
-00025c50: 7274 2828 504d 696e 3244 302d 525a 3029  rt((PMin2D0-RZ0)
-00025c60: 2a2a 322b 2850 4d69 6e32 4431 2d52 5a31  **2+(PMin2D1-RZ1
-00025c70: 292a 2a32 290a 2020 2020 6364 6566 2064  )**2).    cdef d
-00025c80: 6f75 626c 6520 2020 2065 5468 6574 6130  ouble    eTheta0
-00025c90: 203d 202d 504d 696e 312f 504d 696e 326e   = -PMin1/PMin2n
-00025ca0: 6f72 6d2c 2065 5468 6574 6131 203d 2050  orm, eTheta1 = P
-00025cb0: 4d69 6e30 2f50 4d69 6e32 6e6f 726d 2c20  Min0/PMin2norm, 
-00025cc0: 6554 6865 7461 3220 3d20 302e 0a20 2020  eTheta2 = 0..   
-00025cd0: 2063 6465 6620 646f 7562 6c65 2020 2020   cdef double    
-00025ce0: 7650 3020 3d20 504d 696e 3244 302d 525a  vP0 = PMin2D0-RZ
-00025cf0: 302c 2076 5031 203d 2050 4d69 6e32 4431  0, vP1 = PMin2D1
-00025d00: 2d52 5a31 0a20 2020 2063 6465 6620 646f  -RZ1.    cdef do
-00025d10: 7562 6c65 2020 2020 5468 6574 6120 3d20  uble    Theta = 
-00025d20: 635f 6174 616e 3228 7650 312c 7650 3029  c_atan2(vP1,vP0)
-00025d30: 0a20 2020 2063 6465 6620 646f 7562 6c65  .    cdef double
-00025d40: 2020 2020 496d 7054 6865 7461 203d 2054      ImpTheta = T
-00025d50: 6865 7461 2069 6620 5468 6574 613e 3d30  heta if Theta>=0
-00025d60: 2065 6c73 6520 5468 6574 6120 2b20 6e70   else Theta + np
-00025d70: 2e70 690a 2020 2020 6364 6566 2064 6f75  .pi.    cdef dou
-00025d80: 626c 6520 2020 2065 7232 4430 203d 2063  ble    er2D0 = c
-00025d90: 5f63 6f73 2849 6d70 5468 6574 6129 2c20  _cos(ImpTheta), 
-00025da0: 6572 3244 3120 3d20 635f 7369 6e28 496d  er2D1 = c_sin(Im
-00025db0: 7054 6865 7461 290a 2020 2020 6364 6566  pTheta).    cdef
-00025dc0: 2064 6f75 626c 6520 2020 2070 203d 2076   double    p = v
-00025dd0: 5030 2a65 7232 4430 202b 2076 5031 2a65  P0*er2D0 + vP1*e
-00025de0: 7232 4431 0a20 2020 2063 6465 6620 646f  r2D1.    cdef do
-00025df0: 7562 6c65 2020 2020 754e 3020 3d20 7530  uble    uN0 = u0
-00025e00: 2f75 4e2c 2075 4e31 203d 2075 312f 754e  /uN, uN1 = u1/uN
-00025e10: 2c20 754e 3220 3d20 7532 2f75 4e0a 2020  , uN2 = u2/uN.  
-00025e20: 2020 6364 6566 2064 6f75 626c 6520 2020    cdef double   
-00025e30: 2070 6869 203d 2063 5f61 7369 6e28 2d75   phi = c_asin(-u
-00025e40: 4e30 2a65 5468 6574 6130 202d 754e 312a  N0*eTheta0 -uN1*
-00025e50: 6554 6865 7461 3120 2d75 4e32 2a65 5468  eTheta1 -uN2*eTh
-00025e60: 6574 6132 290a 2020 2020 7265 7475 726e  eta2).    return
-00025e70: 2028 504d 696e 302c 504d 696e 312c 504d   (PMin0,PMin1,PM
-00025e80: 696e 3229 2c20 6b50 4d69 6e2c 2052 4d69  in2), kPMin, RMi
-00025e90: 6e2c 2054 6865 7461 2c20 702c 2049 6d70  n, Theta, p, Imp
-00025ea0: 5468 6574 612c 2070 6869 0a0a 0a0a 6364  Theta, phi....cd
-00025eb0: 6566 2069 6e6c 696e 6520 766f 6964 204e  ef inline void N
-00025ec0: 4557 5f4c 4f53 5f73 696e 6f5f 546f 7228  EW_LOS_sino_Tor(
-00025ed0: 646f 7562 6c65 206f 7269 6730 2c20 646f  double orig0, do
-00025ee0: 7562 6c65 206f 7269 6731 2c20 646f 7562  uble orig1, doub
-00025ef0: 6c65 206f 7269 6732 2c0a 2020 2020 2020  le orig2,.      
-00025f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025f10: 2020 2020 2020 2020 2020 2020 646f 7562              doub
-00025f20: 6c65 2064 6972 7630 2c20 646f 7562 6c65  le dirv0, double
-00025f30: 2064 6972 7631 2c20 646f 7562 6c65 2064   dirv1, double d
-00025f40: 6972 7632 2c0a 2020 2020 2020 2020 2020  irv2,.          
-00025f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025f60: 2020 2020 2020 2020 646f 7562 6c65 2063          double c
-00025f70: 6972 635f 7261 6469 7573 2c20 646f 7562  irc_radius, doub
-00025f80: 6c65 2063 6972 635f 6e6f 726d 7a2c 0a20  le circ_normz,. 
-00025f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025fb0: 2064 6f75 626c 655b 395d 2072 6573 756c   double[9] resul
-00025fc0: 7473 2c0a 2020 2020 2020 2020 2020 2020  ts,.            
+00024f10: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00024f20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00024f30: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00024f40: 2323 230a 0a0a 6465 6620 4c4f 535f 7369  ###...def LOS_si
+00024f50: 6e6f 5f66 696e 6452 6f6f 746b 504d 696e  no_findRootkPMin
+00024f60: 5f54 6f72 2864 6f75 626c 6520 7550 6172  _Tor(double uPar
+00024f70: 4e2c 2064 6f75 626c 6520 754e 2c20 646f  N, double uN, do
+00024f80: 7562 6c65 2053 6361 2c20 646f 7562 6c65  uble Sca, double
+00024f90: 2052 5a30 2c0a 2020 2020 2020 2020 2020   RZ0,.          
+00024fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024fb0: 2020 2020 2020 646f 7562 6c65 2052 5a31        double RZ1
+00024fc0: 2c20 646f 7562 6c65 2053 6361 502c 2064  , double ScaP, d
+00024fd0: 6f75 626c 6520 4450 6172 4e2c 0a20 2020  ouble DParN,.   
+00024fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024ff0: 2020 2020 2020 2020 2020 2020 2064 6f75               dou
+00025000: 626c 6520 6b4f 7574 2c20 646f 7562 6c65  ble kOut, double
+00025010: 2044 302c 2064 6f75 626c 6520 4431 2c20   D0, double D1, 
+00025020: 646f 7562 6c65 2044 322c 0a20 2020 2020  double D2,.     
+00025030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025040: 2020 2020 2020 2020 2020 2064 6f75 626c             doubl
+00025050: 6520 7530 2c20 646f 7562 6c65 2075 312c  e u0, double u1,
+00025060: 2064 6f75 626c 6520 7532 2c20 7374 7220   double u2, str 
+00025070: 4d6f 6465 3d27 4c4f 5327 293a 0a20 2020  Mode='LOS'):.   
+00025080: 2022 2222 0a20 2020 2052 656e 6472 6520   """.    Rendre 
+00025090: 2276 6563 746f 7269 656c 2220 7375 7220  "vectoriel" sur 
+000250a0: 4c4f 5320 6574 2073 7572 206c 6573 2063  LOS et sur les c
+000250b0: 6572 636c 6573 2028 6465 7578 2062 6f75  ercles (deux bou
+000250c0: 636c 6573 2022 666f 7222 290a 2020 2020  cles "for").    
+000250d0: 696e 7465 7273 6563 7469 6f6e 206c 6967  intersection lig
+000250e0: 6e65 2065 7420 6365 7263 6c65 0a20 2020  ne et cercle.   
+000250f0: 2064 6f75 626c 6520 7550 6172 4e20 3a20   double uParN : 
+00025100: 636f 6d70 6f73 616e 7465 2064 6520 7520  composante de u 
+00025110: 7061 7261 6c6c 656c 2061 7520 706c 616e  parallel au plan
+00025120: 2028 782c 7929 0a20 2020 2020 2020 2064   (x,y).        d
+00025130: 6f75 626c 6520 754e 203a 2075 7a0a 2020  ouble uN : uz.  
+00025140: 2020 2020 2020 646f 7562 6c65 2053 6361        double Sca
+00025150: 203a 203f 3f3f 2070 726f 6475 6974 2073   : ??? produit s
+00025160: 6361 6c61 6972 6520 2e2e 2e20 3f0a 2020  calaire ... ?.  
+00025170: 2020 2020 2020 646f 7562 6c65 2052 5a30        double RZ0
+00025180: 203a 2047 7261 6e64 2072 6179 6f6e 2064   : Grand rayon d
+00025190: 7520 6365 7263 6c65 0a20 2020 2020 2020  u cercle.       
+000251a0: 2064 6f75 626c 6520 525a 3120 3a20 5a0a   double RZ1 : Z.
+000251b0: 2020 2020 2020 2020 3d3e 2063 6572 636c          => cercl
+000251c0: 6520 6573 7420 6365 6e74 72c3 a920 6175  e est centr.. au
+000251d0: 2070 6f69 6e74 2028 302c 2030 2c20 525a   point (0, 0, RZ
+000251e0: 3129 2065 7420 7261 796f 6e20 525a 300a  1) et rayon RZ0.
+000251f0: 2020 2020 2020 2020 646f 7562 6c65 2053          double S
+00025200: 6361 5020 3a20 2e2e 2e2e 203f 0a20 2020  caP : .... ?.   
+00025210: 2020 2020 2064 6f75 626c 6520 4450 6172       double DPar
+00025220: 4e20 3a20 4420 6f72 6967 696e 6520 6465  N : D origine de
+00025230: 204c 4f53 2e2e 2e2e 203f 204e 203d 3e20   LOS.... ? N => 
+00025240: 6e6f 726d 6520 6465 206c 6120 636f 6d70  norme de la comp
+00025250: 6f73 616e 7465 2064 7520 7665 6374 6575  osante du vecteu
+00025260: 7220 4f44 0a20 2020 2020 2020 2064 6f75  r OD.        dou
+00025270: 626c 6520 6b4f 7574 203a 206b 6d61 7820  ble kOut : kmax 
+00025280: 6fc3 b920 6f6e 2070 6575 7420 7472 6f75  o.. on peut trou
+00025290: 7665 7220 756e 2072 c3a9 7375 6c74 6174  ver un r..sultat
+000252a0: 0a20 2020 2020 2020 2064 6f75 626c 6520  .        double 
+000252b0: 4430 2c20 646f 7562 6c65 2044 312c 2064  D0, double D1, d
+000252c0: 6f75 626c 6520 4432 203a 2063 6f6d 706f  ouble D2 : compo
+000252d0: 7361 6e74 6573 2064 6520 4420 286f 7269  santes de D (ori
+000252e0: 6769 6e65 204c 4f53 290a 2020 2020 2020  gine LOS).      
+000252f0: 2020 646f 7562 6c65 2075 302c 2064 6f75    double u0, dou
+00025300: 626c 6520 7531 2c20 646f 7562 6c65 2075  ble u1, double u
+00025310: 3220 3a20 636f 6d70 6f73 616e 7465 7320  2 : composantes 
+00025320: 6465 2055 2028 6469 7265 6374 696f 6e20  de U (direction 
+00025330: 4c4f 5329 0a20 2020 2020 2020 2073 7472  LOS).        str
+00025340: 204d 6f64 653d 274c 4f53 2720 3a20 7369   Mode='LOS' : si
+00025350: 204c 4f53 2070 6173 2064 6520 736f 6c20   LOS pas de sol 
+00025360: 6170 72c3 a873 206b 6d61 7829 0a20 2020  apr..s kmax).   
+00025370: 203a 3a3a 2046 6169 7265 2075 6e65 2066   ::: Faire une f
+00025380: 6f6e 6374 696f 6e20 646f 7562 6c65 206d  onction double m
+00025390: 6169 7320 7175 6920 7265 6e76 6f69 7420  ais qui renvoit 
+000253a0: 5155 4520 756e 2074 6162 6c65 6175 2064  QUE un tableau d
+000253b0: 6520 626f 6f6c 2061 7665 6320 7472 7565  e bool avec true
+000253c0: 2073 690a 2020 2020 6c61 2064 6973 7461   si.    la dista
+000253d0: 6e63 6520 6573 7420 706c 7573 2070 6574  nce est plus pet
+000253e0: 6974 6520 7175 2775 6e20 6365 7274 6169  ite qu'un certai
+000253f0: 6e20 6570 732c 2066 616c 7365 2073 696e  n eps, false sin
+00025400: 6f6e 2e0a 2020 2020 544f 444f 3a20 2e2e  on..    TODO: ..
+00025410: 2e2e 2e2e 2e2e 2e2e 2e20 404c 4d0a 2020  ......... @LM.  
+00025420: 2020 2222 220a 2020 2020 6364 6566 2064    """.    cdef d
+00025430: 6f75 626c 6520 6134 203d 2028 7550 6172  ouble a4 = (uPar
+00025440: 4e2a 754e 2a75 4e29 2a2a 322c 2061 3320  N*uN*uN)**2, a3 
+00025450: 3d20 322a 2820 2853 6361 2d52 5a31 2a75  = 2*( (Sca-RZ1*u
+00025460: 3229 2a28 7550 6172 4e2a 754e 292a 2a32  2)*(uParN*uN)**2
+00025470: 202b 2053 6361 502a 754e 2a2a 3420 290a   + ScaP*uN**4 ).
+00025480: 2020 2020 6364 6566 2064 6f75 626c 6520      cdef double 
+00025490: 6132 203d 2028 7550 6172 4e2a 2853 6361  a2 = (uParN*(Sca
+000254a0: 2d52 5a31 2a75 3229 292a 2a32 202b 2034  -RZ1*u2))**2 + 4
+000254b0: 2e2a 5363 6150 2a28 5363 612d 525a 312a  .*ScaP*(Sca-RZ1*
+000254c0: 7532 292a 754e 2a2a 3220 2b20 2844 5061  u2)*uN**2 + (DPa
+000254d0: 724e 2a75 4e2a 754e 292a 2a32 202d 2028  rN*uN*uN)**2 - (
+000254e0: 525a 302a 7550 6172 4e2a 7550 6172 4e29  RZ0*uParN*uParN)
+000254f0: 2a2a 320a 2020 2020 6364 6566 2064 6f75  **2.    cdef dou
+00025500: 626c 6520 6131 203d 2032 2a28 2053 6361  ble a1 = 2*( Sca
+00025510: 502a 2853 6361 2d52 5a31 2a75 3229 2a2a  P*(Sca-RZ1*u2)**
+00025520: 3220 2b20 2853 6361 2d52 5a31 2a75 3229  2 + (Sca-RZ1*u2)
+00025530: 2a28 4450 6172 4e2a 754e 292a 2a32 202d  *(DParN*uN)**2 -
+00025540: 2053 6361 502a 2852 5a30 2a75 5061 724e   ScaP*(RZ0*uParN
+00025550: 292a 2a32 2029 0a20 2020 2063 6465 6620  )**2 ).    cdef 
+00025560: 646f 7562 6c65 2061 3020 3d20 2828 5363  double a0 = ((Sc
+00025570: 612d 525a 312a 7532 292a 4450 6172 4e29  a-RZ1*u2)*DParN)
+00025580: 2a2a 3220 2d20 2852 5a30 2a53 6361 5029  **2 - (RZ0*ScaP)
+00025590: 2a2a 320a 2020 2020 6364 6566 206e 702e  **2.    cdef np.
+000255a0: 6e64 6172 7261 7920 726f 6f20 3d20 6e70  ndarray roo = np
+000255b0: 2e72 6f6f 7473 286e 702e 6172 7261 7928  .roots(np.array(
+000255c0: 5b61 342c 6133 2c61 322c 6131 2c61 305d  [a4,a3,a2,a1,a0]
+000255d0: 2929 0a20 2020 2063 6465 6620 6c69 7374  )).    cdef list
+000255e0: 204b 4b20 3d20 6c69 7374 286e 702e 7265   KK = list(np.re
+000255f0: 616c 2872 6f6f 5b6e 702e 6973 7265 616c  al(roo[np.isreal
+00025600: 2872 6f6f 295d 2929 2020 2023 2054 6865  (roo)]))   # The
+00025610: 7265 206d 6967 6874 2062 6520 7365 7665  re might be seve
+00025620: 7261 6c20 736f 6c75 7469 6f6e 730a 2020  ral solutions.  
+00025630: 2020 6364 6566 206c 6973 7420 506b 2c20    cdef list Pk, 
+00025640: 506b 3244 2c20 726b 0a20 2020 2063 6465  Pk2D, rk.    cde
+00025650: 6620 646f 7562 6c65 206b 6b2c 206b 504d  f double kk, kPM
+00025660: 696e 0a20 2020 2069 6620 4d6f 6465 3d3d  in.    if Mode==
+00025670: 274c 4f53 273a 2020 2020 2020 2020 2020  'LOS':          
+00025680: 2020 2020 2020 2020 2020 2023 2054 616b             # Tak
+00025690: 6520 736f 6c75 7469 6f6e 206f 6e20 7068  e solution on ph
+000256a0: 7973 6963 616c 204c 4f53 0a20 2020 2020  ysical LOS.     
+000256b0: 2020 2069 6620 616e 7928 5b30 203c 3d20     if any([0 <= 
+000256c0: 6b6b 203c 3d20 6b4f 7574 2066 6f72 206b  kk <= kOut for k
+000256d0: 6b20 696e 204b 4b5d 293a 0a20 2020 2020  k in KK]):.     
+000256e0: 2020 2020 2020 204b 4b20 3d20 5b6b 6b20         KK = [kk 
+000256f0: 666f 7220 6b6b 2069 6e20 4b4b 2069 6620  for kk in KK if 
+00025700: 3020 3c3d 206b 6b20 3c3d 206b 4f75 745d  0 <= kk <= kOut]
+00025710: 0a20 2020 2020 2020 2020 2020 2050 6b20  .            Pk 
+00025720: 3d20 5b28 4430 2b6b 6b2a 7530 2c44 312b  = [(D0+kk*u0,D1+
+00025730: 6b6b 2a75 312c 4432 2b6b 6b2a 7532 2920  kk*u1,D2+kk*u2) 
+00025740: 666f 7220 6b6b 2069 6e20 4b4b 5d0a 2020  for kk in KK].  
+00025750: 2020 2020 2020 2020 2020 506b 3244 203d            Pk2D =
+00025760: 205b 2863 5f73 7172 7428 7070 5b30 5d2a   [(c_sqrt(pp[0]*
+00025770: 2a32 2b70 705b 315d 2a2a 3229 2c20 7070  *2+pp[1]**2), pp
+00025780: 5b32 5d29 2066 6f72 2070 7020 696e 2050  [2]) for pp in P
+00025790: 6b5d 0a20 2020 2020 2020 2020 2020 2072  k].            r
+000257a0: 6b20 3d20 5b28 7070 5b30 5d2d 525a 3029  k = [(pp[0]-RZ0)
+000257b0: 2a2a 322b 2870 705b 315d 2d52 5a31 292a  **2+(pp[1]-RZ1)*
+000257c0: 2a32 2066 6f72 2070 7020 696e 2050 6b32  *2 for pp in Pk2
+000257d0: 445d 0a20 2020 2020 2020 2020 2020 206b  D].            k
+000257e0: 504d 696e 203d 204b 4b5b 726b 2e69 6e64  PMin = KK[rk.ind
+000257f0: 6578 286d 696e 2872 6b29 295d 0a20 2020  ex(min(rk))].   
+00025800: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00025810: 2020 2020 2020 206b 504d 696e 203d 206d         kPMin = m
+00025820: 696e 285b 635f 6162 7328 6b6b 2920 666f  in([c_abs(kk) fo
+00025830: 7220 6b6b 2069 6e20 4b4b 5d29 2020 2320  r kk in KK])  # 
+00025840: 456c 7365 2c20 7461 6b65 2074 6865 206f  Else, take the o
+00025850: 6e65 2063 6c6f 7365 7374 2074 6f20 440a  ne closest to D.
+00025860: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00025870: 2020 506b 203d 205b 2844 302b 6b6b 2a75    Pk = [(D0+kk*u
+00025880: 302c 4431 2b6b 6b2a 7531 2c44 322b 6b6b  0,D1+kk*u1,D2+kk
+00025890: 2a75 3229 2066 6f72 206b 6b20 696e 204b  *u2) for kk in K
+000258a0: 4b5d 0a20 2020 2020 2020 2050 6b32 4420  K].        Pk2D 
+000258b0: 3d20 5b28 635f 7371 7274 2870 705b 305d  = [(c_sqrt(pp[0]
+000258c0: 2a2a 322b 7070 5b31 5d2a 2a32 292c 2070  **2+pp[1]**2), p
+000258d0: 705b 325d 2920 666f 7220 7070 2069 6e20  p[2]) for pp in 
+000258e0: 506b 5d0a 2020 2020 2020 2020 726b 203d  Pk].        rk =
+000258f0: 205b 2870 705b 305d 2d52 5a30 292a 2a32   [(pp[0]-RZ0)**2
+00025900: 2b28 7070 5b31 5d2d 525a 3129 2a2a 3220  +(pp[1]-RZ1)**2 
+00025910: 666f 7220 7070 2069 6e20 506b 3244 5d0a  for pp in Pk2D].
+00025920: 2020 2020 2020 2020 6b50 4d69 6e20 3d20          kPMin = 
+00025930: 4b4b 5b72 6b2e 696e 6465 7828 6d69 6e28  KK[rk.index(min(
+00025940: 726b 2929 5d0a 2020 2020 7265 7475 726e  rk))].    return
+00025950: 206b 504d 696e 2023 202b 2064 6973 7461   kPMin # + dista
+00025960: 6e63 6520 6175 2063 6572 636c 650a 0a0a  nce au cercle...
+00025970: 0a63 6465 6620 4c4f 535f 7369 6e6f 5f54  .cdef LOS_sino_T
+00025980: 6f72 2864 6f75 626c 6520 4430 2c20 646f  or(double D0, do
+00025990: 7562 6c65 2044 312c 2064 6f75 626c 6520  uble D1, double 
+000259a0: 4432 2c20 646f 7562 6c65 2075 302c 2064  D2, double u0, d
+000259b0: 6f75 626c 6520 7531 2c0a 2020 2020 2020  ouble u1,.      
+000259c0: 2020 2020 2020 2020 2020 2020 646f 7562              doub
+000259d0: 6c65 2075 322c 2064 6f75 626c 6520 525a  le u2, double RZ
+000259e0: 302c 2064 6f75 626c 6520 525a 312c 2073  0, double RZ1, s
+000259f0: 7472 204d 6f64 653d 274c 4f53 272c 2064  tr Mode='LOS', d
+00025a00: 6f75 626c 650a 2020 2020 2020 2020 2020  ouble.          
+00025a10: 2020 2020 2020 2020 6b4f 7574 3d43 5f49          kOut=C_I
+00025a20: 4e46 293a 0a0a 2020 2020 6364 6566 2064  NF):..    cdef d
+00025a30: 6f75 626c 6520 2020 2075 4e20 3d20 635f  ouble    uN = c_
+00025a40: 7371 7274 2875 302a 2a32 2b75 312a 2a32  sqrt(u0**2+u1**2
+00025a50: 2b75 322a 2a32 292c 2075 5061 724e 203d  +u2**2), uParN =
+00025a60: 2063 5f73 7172 7428 7530 2a2a 322b 7531   c_sqrt(u0**2+u1
+00025a70: 2a2a 3229 2c20 4450 6172 4e20 3d20 635f  **2), DParN = c_
+00025a80: 7371 7274 2844 302a 2a32 2b44 312a 2a32  sqrt(D0**2+D1**2
+00025a90: 290a 2020 2020 6364 6566 2064 6f75 626c  ).    cdef doubl
+00025aa0: 6520 2020 2053 6361 203d 2075 302a 4430  e    Sca = u0*D0
+00025ab0: 2b75 312a 4431 2b75 322a 4432 2c20 5363  +u1*D1+u2*D2, Sc
+00025ac0: 6150 203d 2075 302a 4430 2b75 312a 4431  aP = u0*D0+u1*D1
+00025ad0: 0a20 2020 2063 6465 6620 646f 7562 6c65  .    cdef double
+00025ae0: 2020 2020 6b50 4d69 6e0a 2020 2020 6966      kPMin.    if
+00025af0: 2075 5061 724e 203d 3d20 302e 3a0a 2020   uParN == 0.:.  
+00025b00: 2020 2020 2020 6b50 4d69 6e20 3d20 2852        kPMin = (R
+00025b10: 5a31 2d44 3229 2f75 320a 2020 2020 656c  Z1-D2)/u2.    el
+00025b20: 7365 3a0a 2020 2020 2020 2020 6b50 4d69  se:.        kPMi
+00025b30: 6e20 3d20 4c4f 535f 7369 6e6f 5f66 696e  n = LOS_sino_fin
+00025b40: 6452 6f6f 746b 504d 696e 5f54 6f72 2875  dRootkPMin_Tor(u
+00025b50: 5061 724e 2c20 754e 2c20 5363 612c 2052  ParN, uN, Sca, R
+00025b60: 5a30 2c20 525a 312c 2053 6361 502c 2044  Z0, RZ1, ScaP, D
+00025b70: 5061 724e 2c20 6b4f 7574 2c20 4430 2c20  ParN, kOut, D0, 
+00025b80: 4431 2c20 4432 2c20 7530 2c20 7531 2c20  D1, D2, u0, u1, 
+00025b90: 7532 2c20 4d6f 6465 3d4d 6f64 6529 0a20  u2, Mode=Mode). 
+00025ba0: 2020 2063 6465 6620 646f 7562 6c65 2020     cdef double  
+00025bb0: 2020 504d 696e 3020 3d20 4430 2b6b 504d    PMin0 = D0+kPM
+00025bc0: 696e 2a75 302c 2050 4d69 6e31 203d 2044  in*u0, PMin1 = D
+00025bd0: 312b 6b50 4d69 6e2a 7531 2c20 504d 696e  1+kPMin*u1, PMin
+00025be0: 3220 3d20 4432 2b6b 504d 696e 2a75 320a  2 = D2+kPMin*u2.
+00025bf0: 2020 2020 6364 6566 2064 6f75 626c 6520      cdef double 
+00025c00: 2020 2050 4d69 6e32 6e6f 726d 203d 2063     PMin2norm = c
+00025c10: 5f73 7172 7428 504d 696e 302a 2a32 2b50  _sqrt(PMin0**2+P
+00025c20: 4d69 6e31 2a2a 3229 0a20 2020 2063 6465  Min1**2).    cde
+00025c30: 6620 646f 7562 6c65 2020 2020 504d 696e  f double    PMin
+00025c40: 3244 3020 3d20 504d 696e 326e 6f72 6d2c  2D0 = PMin2norm,
+00025c50: 2050 4d69 6e32 4431 203d 2050 4d69 6e32   PMin2D1 = PMin2
+00025c60: 0a20 2020 2063 6465 6620 646f 7562 6c65  .    cdef double
+00025c70: 2020 2020 524d 696e 203d 2063 5f73 7172      RMin = c_sqr
+00025c80: 7428 2850 4d69 6e32 4430 2d52 5a30 292a  t((PMin2D0-RZ0)*
+00025c90: 2a32 2b28 504d 696e 3244 312d 525a 3129  *2+(PMin2D1-RZ1)
+00025ca0: 2a2a 3229 0a20 2020 2063 6465 6620 646f  **2).    cdef do
+00025cb0: 7562 6c65 2020 2020 6554 6865 7461 3020  uble    eTheta0 
+00025cc0: 3d20 2d50 4d69 6e31 2f50 4d69 6e32 6e6f  = -PMin1/PMin2no
+00025cd0: 726d 2c20 6554 6865 7461 3120 3d20 504d  rm, eTheta1 = PM
+00025ce0: 696e 302f 504d 696e 326e 6f72 6d2c 2065  in0/PMin2norm, e
+00025cf0: 5468 6574 6132 203d 2030 2e0a 2020 2020  Theta2 = 0..    
+00025d00: 6364 6566 2064 6f75 626c 6520 2020 2076  cdef double    v
+00025d10: 5030 203d 2050 4d69 6e32 4430 2d52 5a30  P0 = PMin2D0-RZ0
+00025d20: 2c20 7650 3120 3d20 504d 696e 3244 312d  , vP1 = PMin2D1-
+00025d30: 525a 310a 2020 2020 6364 6566 2064 6f75  RZ1.    cdef dou
+00025d40: 626c 6520 2020 2054 6865 7461 203d 2063  ble    Theta = c
+00025d50: 5f61 7461 6e32 2876 5031 2c76 5030 290a  _atan2(vP1,vP0).
+00025d60: 2020 2020 6364 6566 2064 6f75 626c 6520      cdef double 
+00025d70: 2020 2049 6d70 5468 6574 6120 3d20 5468     ImpTheta = Th
+00025d80: 6574 6120 6966 2054 6865 7461 3e3d 3020  eta if Theta>=0 
+00025d90: 656c 7365 2054 6865 7461 202b 206e 702e  else Theta + np.
+00025da0: 7069 0a20 2020 2063 6465 6620 646f 7562  pi.    cdef doub
+00025db0: 6c65 2020 2020 6572 3244 3020 3d20 635f  le    er2D0 = c_
+00025dc0: 636f 7328 496d 7054 6865 7461 292c 2065  cos(ImpTheta), e
+00025dd0: 7232 4431 203d 2063 5f73 696e 2849 6d70  r2D1 = c_sin(Imp
+00025de0: 5468 6574 6129 0a20 2020 2063 6465 6620  Theta).    cdef 
+00025df0: 646f 7562 6c65 2020 2020 7020 3d20 7650  double    p = vP
+00025e00: 302a 6572 3244 3020 2b20 7650 312a 6572  0*er2D0 + vP1*er
+00025e10: 3244 310a 2020 2020 6364 6566 2064 6f75  2D1.    cdef dou
+00025e20: 626c 6520 2020 2075 4e30 203d 2075 302f  ble    uN0 = u0/
+00025e30: 754e 2c20 754e 3120 3d20 7531 2f75 4e2c  uN, uN1 = u1/uN,
+00025e40: 2075 4e32 203d 2075 322f 754e 0a20 2020   uN2 = u2/uN.   
+00025e50: 2063 6465 6620 646f 7562 6c65 2020 2020   cdef double    
+00025e60: 7068 6920 3d20 635f 6173 696e 282d 754e  phi = c_asin(-uN
+00025e70: 302a 6554 6865 7461 3020 2d75 4e31 2a65  0*eTheta0 -uN1*e
+00025e80: 5468 6574 6131 202d 754e 322a 6554 6865  Theta1 -uN2*eThe
+00025e90: 7461 3229 0a20 2020 2072 6574 7572 6e20  ta2).    return 
+00025ea0: 2850 4d69 6e30 2c50 4d69 6e31 2c50 4d69  (PMin0,PMin1,PMi
+00025eb0: 6e32 292c 206b 504d 696e 2c20 524d 696e  n2), kPMin, RMin
+00025ec0: 2c20 5468 6574 612c 2070 2c20 496d 7054  , Theta, p, ImpT
+00025ed0: 6865 7461 2c20 7068 690a 0a0a 0a63 6465  heta, phi....cde
+00025ee0: 6620 696e 6c69 6e65 2076 6f69 6420 4e45  f inline void NE
+00025ef0: 575f 4c4f 535f 7369 6e6f 5f54 6f72 2864  W_LOS_sino_Tor(d
+00025f00: 6f75 626c 6520 6f72 6967 302c 2064 6f75  ouble orig0, dou
+00025f10: 626c 6520 6f72 6967 312c 2064 6f75 626c  ble orig1, doubl
+00025f20: 6520 6f72 6967 322c 0a20 2020 2020 2020  e orig2,.       
+00025f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025f40: 2020 2020 2020 2020 2020 2064 6f75 626c             doubl
+00025f50: 6520 6469 7276 302c 2064 6f75 626c 6520  e dirv0, double 
+00025f60: 6469 7276 312c 2064 6f75 626c 6520 6469  dirv1, double di
+00025f70: 7276 322c 0a20 2020 2020 2020 2020 2020  rv2,.           
+00025f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025f90: 2020 2020 2020 2064 6f75 626c 6520 6369         double ci
+00025fa0: 7263 5f72 6164 6975 732c 2064 6f75 626c  rc_radius, doubl
+00025fb0: 6520 6369 7263 5f6e 6f72 6d7a 2c0a 2020  e circ_normz,.  
+00025fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00025fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025fe0: 2020 2020 2020 6269 6e74 2069 735f 4c4f        bint is_LO
-00025ff0: 535f 4d6f 6465 3d46 616c 7365 2c0a 2020  S_Mode=False,.  
+00025fe0: 646f 7562 6c65 5b39 5d20 7265 7375 6c74  double[9] result
+00025ff0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
 00026000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026020: 646f 7562 6c65 206b 4f75 743d 435f 494e  double kOut=C_IN
-00026030: 4629 206e 6f67 696c 3a0a 2020 2020 6364  F) nogil:.    cd
-00026040: 6566 2064 6f75 626c 655b 335d 2064 6972  ef double[3] dir
-00026050: 762c 206f 7269 670a 2020 2020 6364 6566  v, orig.    cdef
-00026060: 2064 6f75 626c 655b 325d 2072 6573 0a20   double[2] res. 
-00026070: 2020 2063 6465 6620 646f 7562 6c65 206e     cdef double n
-00026080: 6f72 6d75 2c20 6e6f 726d 755f 7371 720a  ormu, normu_sqr.
-00026090: 2020 2020 6364 6566 2064 6f75 626c 6520      cdef double 
-000260a0: 6b50 4d69 6e0a 0a20 2020 206e 6f72 6d75  kPMin..    normu
-000260b0: 5f73 7172 203d 2064 6972 7630 202a 2064  _sqr = dirv0 * d
-000260c0: 6972 7630 202b 2064 6972 7631 202a 2064  irv0 + dirv1 * d
-000260d0: 6972 7631 202b 2064 6972 7632 202a 2064  irv1 + dirv2 * d
-000260e0: 6972 7632 0a20 2020 206e 6f72 6d75 203d  irv2.    normu =
-000260f0: 2063 5f73 7172 7428 6e6f 726d 755f 7371   c_sqrt(normu_sq
-00026100: 7229 0a20 2020 2064 6972 765b 305d 203d  r).    dirv[0] =
-00026110: 2064 6972 7630 0a20 2020 2064 6972 765b   dirv0.    dirv[
-00026120: 325d 203d 2064 6972 7632 0a20 2020 2064  2] = dirv2.    d
-00026130: 6972 765b 315d 203d 2064 6972 7631 0a20  irv[1] = dirv1. 
-00026140: 2020 206f 7269 675b 305d 203d 206f 7269     orig[0] = ori
-00026150: 6730 0a20 2020 206f 7269 675b 315d 203d  g0.    orig[1] =
-00026160: 206f 7269 6731 0a20 2020 206f 7269 675b   orig1.    orig[
-00026170: 325d 203d 206f 7269 6732 0a0a 2020 2020  2] = orig2..    
-00026180: 6966 2064 6972 7630 203d 3d20 302e 2061  if dirv0 == 0. a
-00026190: 6e64 2064 6972 7631 203d 3d20 302e 3a0a  nd dirv1 == 0.:.
-000261a0: 2020 2020 2020 2020 6b50 4d69 6e20 3d20          kPMin = 
-000261b0: 2863 6972 635f 6e6f 726d 7a2d 6f72 6967  (circ_normz-orig
-000261c0: 3229 2f64 6972 7632 0a20 2020 2065 6c73  2)/dirv2.    els
-000261d0: 653a 0a20 2020 2020 2020 205f 6474 2e64  e:.        _dt.d
-000261e0: 6973 745f 6c6f 735f 6369 7263 6c65 5f63  ist_los_circle_c
-000261f0: 6f72 6528 6469 7276 2c20 6f72 6967 2c0a  ore(dirv, orig,.
-00026200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026220: 6369 7263 5f72 6164 6975 732c 2063 6972  circ_radius, cir
-00026230: 635f 6e6f 726d 7a2c 0a20 2020 2020 2020  c_normz,.       
-00026240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026250: 2020 2020 2020 2020 206e 6f72 6d75 5f73           normu_s
-00026260: 7172 2c20 7265 7329 0a20 2020 2020 2020  qr, res).       
-00026270: 206b 504d 696e 203d 2072 6573 5b30 5d0a   kPMin = res[0].
-00026280: 2020 2020 2020 2020 6966 2069 735f 4c4f          if is_LO
-00026290: 535f 4d6f 6465 2061 6e64 206b 504d 696e  S_Mode and kPMin
-000262a0: 203e 206b 4f75 743a 0a20 2020 2020 2020   > kOut:.       
-000262b0: 2020 2020 206b 504d 696e 203d 206b 4f75       kPMin = kOu
-000262c0: 740a 0a20 2020 2023 2043 6f6d 7075 7469  t..    # Computi
-000262d0: 6e67 2074 6865 2070 6f69 6e74 2773 2063  ng the point's c
-000262e0: 6f6f 7264 696e 6174 6573 2e2e 2e2e 2e2e  oordinates......
-000262f0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00026300: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00026310: 2e2e 2e0a 2020 2020 6364 6566 2064 6f75  ....    cdef dou
-00026320: 626c 6520 504d 696e 3020 3d20 6f72 6967  ble PMin0 = orig
-00026330: 3020 2b20 6b50 4d69 6e20 2a20 6469 7276  0 + kPMin * dirv
-00026340: 300a 2020 2020 6364 6566 2064 6f75 626c  0.    cdef doubl
-00026350: 6520 504d 696e 3120 3d20 6f72 6967 3120  e PMin1 = orig1 
-00026360: 2b20 6b50 4d69 6e20 2a20 6469 7276 310a  + kPMin * dirv1.
-00026370: 2020 2020 6364 6566 2064 6f75 626c 6520      cdef double 
-00026380: 504d 696e 3220 3d20 6f72 6967 3220 2b20  PMin2 = orig2 + 
-00026390: 6b50 4d69 6e20 2a20 6469 7276 320a 2020  kPMin * dirv2.  
-000263a0: 2020 6364 6566 2064 6f75 626c 6520 504d    cdef double PM
-000263b0: 696e 326e 6f72 6d20 3d20 635f 7371 7274  in2norm = c_sqrt
-000263c0: 2850 4d69 6e30 2a2a 322b 504d 696e 312a  (PMin0**2+PMin1*
-000263d0: 2a32 290a 2020 2020 6364 6566 2064 6f75  *2).    cdef dou
-000263e0: 626c 6520 524d 696e 203d 2063 5f73 7172  ble RMin = c_sqr
-000263f0: 7428 2850 4d69 6e32 6e6f 726d 202d 2063  t((PMin2norm - c
-00026400: 6972 635f 7261 6469 7573 292a 2a32 0a20  irc_radius)**2. 
-00026410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026420: 2020 2020 2020 2020 2020 2020 2b20 2850              + (P
-00026430: 4d69 6e32 2020 202d 2063 6972 635f 6e6f  Min2   - circ_no
-00026440: 726d 7a29 2a2a 3229 0a20 2020 2063 6465  rmz)**2).    cde
-00026450: 6620 646f 7562 6c65 2076 5030 203d 2050  f double vP0 = P
-00026460: 4d69 6e32 6e6f 726d 202d 2063 6972 635f  Min2norm - circ_
-00026470: 7261 6469 7573 0a20 2020 2063 6465 6620  radius.    cdef 
-00026480: 646f 7562 6c65 2076 5031 203d 2050 4d69  double vP1 = PMi
-00026490: 6e32 2020 2020 202d 2063 6972 635f 6e6f  n2     - circ_no
-000264a0: 726d 7a0a 2020 2020 6364 6566 2064 6f75  rmz.    cdef dou
-000264b0: 626c 6520 5468 6574 6120 3d20 635f 6174  ble Theta = c_at
-000264c0: 616e 3228 7650 312c 2076 5030 290a 2020  an2(vP1, vP0).  
-000264d0: 2020 6364 6566 2064 6f75 626c 6520 496d    cdef double Im
-000264e0: 7054 6865 7461 203d 2054 6865 7461 2069  pTheta = Theta i
-000264f0: 6620 5468 6574 613e 3d30 2065 6c73 6520  f Theta>=0 else 
-00026500: 5468 6574 6120 2b20 635f 7069 0a20 2020  Theta + c_pi.   
-00026510: 2063 6465 6620 646f 7562 6c65 2065 7232   cdef double er2
-00026520: 4430 203d 2063 5f63 6f73 2849 6d70 5468  D0 = c_cos(ImpTh
-00026530: 6574 6129 0a20 2020 2063 6465 6620 646f  eta).    cdef do
-00026540: 7562 6c65 2065 7232 4431 203d 2063 5f73  uble er2D1 = c_s
-00026550: 696e 2849 6d70 5468 6574 6129 0a20 2020  in(ImpTheta).   
-00026560: 2063 6465 6620 646f 7562 6c65 2070 3020   cdef double p0 
-00026570: 3d20 7650 302a 6572 3244 3020 2b20 7650  = vP0*er2D0 + vP
-00026580: 312a 6572 3244 310a 2020 2020 6364 6566  1*er2D1.    cdef
-00026590: 2064 6f75 626c 6520 6554 6865 7461 3020   double eTheta0 
-000265a0: 3d20 2d50 4d69 6e31 202f 2050 4d69 6e32  = -PMin1 / PMin2
-000265b0: 6e6f 726d 0a20 2020 2063 6465 6620 646f  norm.    cdef do
-000265c0: 7562 6c65 2065 5468 6574 6131 203d 2020  uble eTheta1 =  
-000265d0: 504d 696e 3020 2f20 504d 696e 326e 6f72  PMin0 / PMin2nor
-000265e0: 6d0a 2020 2020 6364 6566 2064 6f75 626c  m.    cdef doubl
-000265f0: 6520 6e6f 726d 7530 203d 2064 6972 7630  e normu0 = dirv0
-00026600: 2f6e 6f72 6d75 0a20 2020 2063 6465 6620  /normu.    cdef 
-00026610: 646f 7562 6c65 206e 6f72 6d75 3120 3d20  double normu1 = 
-00026620: 6469 7276 312f 6e6f 726d 750a 2020 2020  dirv1/normu.    
-00026630: 6364 6566 2064 6f75 626c 6520 7068 6920  cdef double phi 
-00026640: 3d20 635f 6173 696e 282d 6e6f 726d 7530  = c_asin(-normu0
-00026650: 202a 2065 5468 6574 6130 202d 206e 6f72   * eTheta0 - nor
-00026660: 6d75 3120 2a20 6554 6865 7461 3129 0a20  mu1 * eTheta1). 
-00026670: 2020 2023 2046 696c 6c69 6e67 2074 6865     # Filling the
-00026680: 2072 6573 756c 7473 202e 2e2e 2e2e 2e2e   results .......
-00026690: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-000266a0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-000266b0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e0a  ................
-000266c0: 2020 2020 7265 7375 6c74 735b 305d 203d      results[0] =
-000266d0: 2050 4d69 6e30 0a20 2020 2072 6573 756c   PMin0.    resul
-000266e0: 7473 5b31 5d20 3d20 504d 696e 310a 2020  ts[1] = PMin1.  
-000266f0: 2020 7265 7375 6c74 735b 325d 203d 2050    results[2] = P
-00026700: 4d69 6e32 0a20 2020 2072 6573 756c 7473  Min2.    results
-00026710: 5b33 5d20 3d20 6b50 4d69 6e0a 2020 2020  [3] = kPMin.    
-00026720: 7265 7375 6c74 735b 345d 203d 2052 4d69  results[4] = RMi
-00026730: 6e0a 2020 2020 7265 7375 6c74 735b 355d  n.    results[5]
-00026740: 203d 2054 6865 7461 0a20 2020 2072 6573   = Theta.    res
-00026750: 756c 7473 5b36 5d20 3d20 7030 0a20 2020  ults[6] = p0.   
-00026760: 2072 6573 756c 7473 5b37 5d20 3d20 496d   results[7] = Im
-00026770: 7054 6865 7461 0a20 2020 2072 6573 756c  pTheta.    resul
-00026780: 7473 5b38 5d20 3d20 7068 690a 2020 2020  ts[8] = phi.    
-00026790: 7265 7475 726e 0a0a 6364 6566 2069 6e6c  return..cdef inl
-000267a0: 696e 6520 766f 6964 204e 4557 5f6c 6f73  ine void NEW_los
-000267b0: 5f73 696e 6f5f 746f 725f 7665 6328 696e  _sino_tor_vec(in
-000267c0: 7420 6e6c 6f73 2c0a 2020 2020 2020 2020  t nlos,.        
-000267d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000267e0: 2020 2020 2020 2020 2020 2020 2020 646f                do
-000267f0: 7562 6c65 5b3a 2c3a 3a31 5d20 6f72 6967  uble[:,::1] orig
-00026800: 696e 732c 0a20 2020 2020 2020 2020 2020  ins,.           
-00026810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026820: 2020 2020 2020 2020 2020 2064 6f75 626c             doubl
-00026830: 655b 3a2c 3a3a 315d 2064 6972 6563 7469  e[:,::1] directi
-00026840: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
-00026850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026860: 2020 2020 2020 2020 2020 2064 6f75 626c             doubl
-00026870: 6520 6369 7263 5f72 6164 6975 732c 0a20  e circ_radius,. 
+00026010: 2020 2020 2062 696e 7420 6973 5f4c 4f53       bint is_LOS
+00026020: 5f4d 6f64 653d 4661 6c73 652c 0a20 2020  _Mode=False,.   
+00026030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026040: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00026050: 6f75 626c 6520 6b4f 7574 3d43 5f49 4e46  ouble kOut=C_INF
+00026060: 2920 6e6f 6769 6c3a 0a20 2020 2063 6465  ) nogil:.    cde
+00026070: 6620 646f 7562 6c65 5b33 5d20 6469 7276  f double[3] dirv
+00026080: 2c20 6f72 6967 0a20 2020 2063 6465 6620  , orig.    cdef 
+00026090: 646f 7562 6c65 5b32 5d20 7265 730a 2020  double[2] res.  
+000260a0: 2020 6364 6566 2064 6f75 626c 6520 6e6f    cdef double no
+000260b0: 726d 752c 206e 6f72 6d75 5f73 7172 0a20  rmu, normu_sqr. 
+000260c0: 2020 2063 6465 6620 646f 7562 6c65 206b     cdef double k
+000260d0: 504d 696e 0a0a 2020 2020 6e6f 726d 755f  PMin..    normu_
+000260e0: 7371 7220 3d20 6469 7276 3020 2a20 6469  sqr = dirv0 * di
+000260f0: 7276 3020 2b20 6469 7276 3120 2a20 6469  rv0 + dirv1 * di
+00026100: 7276 3120 2b20 6469 7276 3220 2a20 6469  rv1 + dirv2 * di
+00026110: 7276 320a 2020 2020 6e6f 726d 7520 3d20  rv2.    normu = 
+00026120: 635f 7371 7274 286e 6f72 6d75 5f73 7172  c_sqrt(normu_sqr
+00026130: 290a 2020 2020 6469 7276 5b30 5d20 3d20  ).    dirv[0] = 
+00026140: 6469 7276 300a 2020 2020 6469 7276 5b32  dirv0.    dirv[2
+00026150: 5d20 3d20 6469 7276 320a 2020 2020 6469  ] = dirv2.    di
+00026160: 7276 5b31 5d20 3d20 6469 7276 310a 2020  rv[1] = dirv1.  
+00026170: 2020 6f72 6967 5b30 5d20 3d20 6f72 6967    orig[0] = orig
+00026180: 300a 2020 2020 6f72 6967 5b31 5d20 3d20  0.    orig[1] = 
+00026190: 6f72 6967 310a 2020 2020 6f72 6967 5b32  orig1.    orig[2
+000261a0: 5d20 3d20 6f72 6967 320a 0a20 2020 2069  ] = orig2..    i
+000261b0: 6620 6469 7276 3020 3d3d 2030 2e20 616e  f dirv0 == 0. an
+000261c0: 6420 6469 7276 3120 3d3d 2030 2e3a 0a20  d dirv1 == 0.:. 
+000261d0: 2020 2020 2020 206b 504d 696e 203d 2028         kPMin = (
+000261e0: 6369 7263 5f6e 6f72 6d7a 2d6f 7269 6732  circ_normz-orig2
+000261f0: 292f 6469 7276 320a 2020 2020 656c 7365  )/dirv2.    else
+00026200: 3a0a 2020 2020 2020 2020 5f64 742e 6469  :.        _dt.di
+00026210: 7374 5f6c 6f73 5f63 6972 636c 655f 636f  st_los_circle_co
+00026220: 7265 2864 6972 762c 206f 7269 672c 0a20  re(dirv, orig,. 
+00026230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026240: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00026250: 6972 635f 7261 6469 7573 2c20 6369 7263  irc_radius, circ
+00026260: 5f6e 6f72 6d7a 2c0a 2020 2020 2020 2020  _normz,.        
+00026270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026280: 2020 2020 2020 2020 6e6f 726d 755f 7371          normu_sq
+00026290: 722c 2072 6573 290a 2020 2020 2020 2020  r, res).        
+000262a0: 6b50 4d69 6e20 3d20 7265 735b 305d 0a20  kPMin = res[0]. 
+000262b0: 2020 2020 2020 2069 6620 6973 5f4c 4f53         if is_LOS
+000262c0: 5f4d 6f64 6520 616e 6420 6b50 4d69 6e20  _Mode and kPMin 
+000262d0: 3e20 6b4f 7574 3a0a 2020 2020 2020 2020  > kOut:.        
+000262e0: 2020 2020 6b50 4d69 6e20 3d20 6b4f 7574      kPMin = kOut
+000262f0: 0a0a 2020 2020 2320 436f 6d70 7574 696e  ..    # Computin
+00026300: 6720 7468 6520 706f 696e 7427 7320 636f  g the point's co
+00026310: 6f72 6469 6e61 7465 732e 2e2e 2e2e 2e2e  ordinates.......
+00026320: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00026330: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00026340: 2e2e 0a20 2020 2063 6465 6620 646f 7562  ...    cdef doub
+00026350: 6c65 2050 4d69 6e30 203d 206f 7269 6730  le PMin0 = orig0
+00026360: 202b 206b 504d 696e 202a 2064 6972 7630   + kPMin * dirv0
+00026370: 0a20 2020 2063 6465 6620 646f 7562 6c65  .    cdef double
+00026380: 2050 4d69 6e31 203d 206f 7269 6731 202b   PMin1 = orig1 +
+00026390: 206b 504d 696e 202a 2064 6972 7631 0a20   kPMin * dirv1. 
+000263a0: 2020 2063 6465 6620 646f 7562 6c65 2050     cdef double P
+000263b0: 4d69 6e32 203d 206f 7269 6732 202b 206b  Min2 = orig2 + k
+000263c0: 504d 696e 202a 2064 6972 7632 0a20 2020  PMin * dirv2.   
+000263d0: 2063 6465 6620 646f 7562 6c65 2050 4d69   cdef double PMi
+000263e0: 6e32 6e6f 726d 203d 2063 5f73 7172 7428  n2norm = c_sqrt(
+000263f0: 504d 696e 302a 2a32 2b50 4d69 6e31 2a2a  PMin0**2+PMin1**
+00026400: 3229 0a20 2020 2063 6465 6620 646f 7562  2).    cdef doub
+00026410: 6c65 2052 4d69 6e20 3d20 635f 7371 7274  le RMin = c_sqrt
+00026420: 2828 504d 696e 326e 6f72 6d20 2d20 6369  ((PMin2norm - ci
+00026430: 7263 5f72 6164 6975 7329 2a2a 320a 2020  rc_radius)**2.  
+00026440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026450: 2020 2020 2020 2020 2020 202b 2028 504d             + (PM
+00026460: 696e 3220 2020 2d20 6369 7263 5f6e 6f72  in2   - circ_nor
+00026470: 6d7a 292a 2a32 290a 2020 2020 6364 6566  mz)**2).    cdef
+00026480: 2064 6f75 626c 6520 7650 3020 3d20 504d   double vP0 = PM
+00026490: 696e 326e 6f72 6d20 2d20 6369 7263 5f72  in2norm - circ_r
+000264a0: 6164 6975 730a 2020 2020 6364 6566 2064  adius.    cdef d
+000264b0: 6f75 626c 6520 7650 3120 3d20 504d 696e  ouble vP1 = PMin
+000264c0: 3220 2020 2020 2d20 6369 7263 5f6e 6f72  2     - circ_nor
+000264d0: 6d7a 0a20 2020 2063 6465 6620 646f 7562  mz.    cdef doub
+000264e0: 6c65 2054 6865 7461 203d 2063 5f61 7461  le Theta = c_ata
+000264f0: 6e32 2876 5031 2c20 7650 3029 0a20 2020  n2(vP1, vP0).   
+00026500: 2063 6465 6620 646f 7562 6c65 2049 6d70   cdef double Imp
+00026510: 5468 6574 6120 3d20 5468 6574 6120 6966  Theta = Theta if
+00026520: 2054 6865 7461 3e3d 3020 656c 7365 2054   Theta>=0 else T
+00026530: 6865 7461 202b 2063 5f70 690a 2020 2020  heta + c_pi.    
+00026540: 6364 6566 2064 6f75 626c 6520 6572 3244  cdef double er2D
+00026550: 3020 3d20 635f 636f 7328 496d 7054 6865  0 = c_cos(ImpThe
+00026560: 7461 290a 2020 2020 6364 6566 2064 6f75  ta).    cdef dou
+00026570: 626c 6520 6572 3244 3120 3d20 635f 7369  ble er2D1 = c_si
+00026580: 6e28 496d 7054 6865 7461 290a 2020 2020  n(ImpTheta).    
+00026590: 6364 6566 2064 6f75 626c 6520 7030 203d  cdef double p0 =
+000265a0: 2076 5030 2a65 7232 4430 202b 2076 5031   vP0*er2D0 + vP1
+000265b0: 2a65 7232 4431 0a20 2020 2063 6465 6620  *er2D1.    cdef 
+000265c0: 646f 7562 6c65 2065 5468 6574 6130 203d  double eTheta0 =
+000265d0: 202d 504d 696e 3120 2f20 504d 696e 326e   -PMin1 / PMin2n
+000265e0: 6f72 6d0a 2020 2020 6364 6566 2064 6f75  orm.    cdef dou
+000265f0: 626c 6520 6554 6865 7461 3120 3d20 2050  ble eTheta1 =  P
+00026600: 4d69 6e30 202f 2050 4d69 6e32 6e6f 726d  Min0 / PMin2norm
+00026610: 0a20 2020 2063 6465 6620 646f 7562 6c65  .    cdef double
+00026620: 206e 6f72 6d75 3020 3d20 6469 7276 302f   normu0 = dirv0/
+00026630: 6e6f 726d 750a 2020 2020 6364 6566 2064  normu.    cdef d
+00026640: 6f75 626c 6520 6e6f 726d 7531 203d 2064  ouble normu1 = d
+00026650: 6972 7631 2f6e 6f72 6d75 0a20 2020 2063  irv1/normu.    c
+00026660: 6465 6620 646f 7562 6c65 2070 6869 203d  def double phi =
+00026670: 2063 5f61 7369 6e28 2d6e 6f72 6d75 3020   c_asin(-normu0 
+00026680: 2a20 6554 6865 7461 3020 2d20 6e6f 726d  * eTheta0 - norm
+00026690: 7531 202a 2065 5468 6574 6131 290a 2020  u1 * eTheta1).  
+000266a0: 2020 2320 4669 6c6c 696e 6720 7468 6520    # Filling the 
+000266b0: 7265 7375 6c74 7320 2e2e 2e2e 2e2e 2e2e  results ........
+000266c0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+000266d0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+000266e0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 0a20  ............... 
+000266f0: 2020 2072 6573 756c 7473 5b30 5d20 3d20     results[0] = 
+00026700: 504d 696e 300a 2020 2020 7265 7375 6c74  PMin0.    result
+00026710: 735b 315d 203d 2050 4d69 6e31 0a20 2020  s[1] = PMin1.   
+00026720: 2072 6573 756c 7473 5b32 5d20 3d20 504d   results[2] = PM
+00026730: 696e 320a 2020 2020 7265 7375 6c74 735b  in2.    results[
+00026740: 335d 203d 206b 504d 696e 0a20 2020 2072  3] = kPMin.    r
+00026750: 6573 756c 7473 5b34 5d20 3d20 524d 696e  esults[4] = RMin
+00026760: 0a20 2020 2072 6573 756c 7473 5b35 5d20  .    results[5] 
+00026770: 3d20 5468 6574 610a 2020 2020 7265 7375  = Theta.    resu
+00026780: 6c74 735b 365d 203d 2070 300a 2020 2020  lts[6] = p0.    
+00026790: 7265 7375 6c74 735b 375d 203d 2049 6d70  results[7] = Imp
+000267a0: 5468 6574 610a 2020 2020 7265 7375 6c74  Theta.    result
+000267b0: 735b 385d 203d 2070 6869 0a20 2020 2072  s[8] = phi.    r
+000267c0: 6574 7572 6e0a 0a63 6465 6620 696e 6c69  eturn..cdef inli
+000267d0: 6e65 2076 6f69 6420 4e45 575f 6c6f 735f  ne void NEW_los_
+000267e0: 7369 6e6f 5f74 6f72 5f76 6563 2869 6e74  sino_tor_vec(int
+000267f0: 206e 6c6f 732c 0a20 2020 2020 2020 2020   nlos,.         
+00026800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026810: 2020 2020 2020 2020 2020 2020 2064 6f75               dou
+00026820: 626c 655b 3a2c 3a3a 315d 206f 7269 6769  ble[:,::1] origi
+00026830: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
+00026840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026850: 2020 2020 2020 2020 2020 646f 7562 6c65            double
+00026860: 5b3a 2c3a 3a31 5d20 6469 7265 6374 696f  [:,::1] directio
+00026870: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
 00026880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000268a0: 2020 2020 2064 6f75 626c 6520 6369 7263       double circ
-000268b0: 5f6e 6f72 6d7a 2c0a 2020 2020 2020 2020  _normz,.        
+00026890: 2020 2020 2020 2020 2020 646f 7562 6c65            double
+000268a0: 2063 6972 635f 7261 6469 7573 2c0a 2020   circ_radius,.  
+000268b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000268c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000268d0: 2020 2020 2020 2020 2020 2020 2020 646f                do
-000268e0: 7562 6c65 5b3a 2c3a 3a31 5d20 6c6f 735f  uble[:,::1] los_
-000268f0: 636c 6f73 6573 745f 636f 6f72 6473 2c0a  closest_coords,.
-00026900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026920: 2020 2020 2020 646f 7562 6c65 5b3a 3a31        double[::1
-00026930: 5d20 6c6f 735f 636c 6f73 6573 745f 636f  ] los_closest_co
-00026940: 6566 6673 2c0a 2020 2020 2020 2020 2020  effs,.          
-00026950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026960: 2020 2020 2020 2020 2020 2020 646f 7562              doub
-00026970: 6c65 5b3a 3a31 5d20 6369 7263 6c65 5f63  le[::1] circle_c
-00026980: 6c6f 7365 7374 5f72 6d69 6e2c 0a20 2020  losest_rmin,.   
-00026990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000269a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000269b0: 2020 2064 6f75 626c 655b 3a3a 315d 2063     double[::1] c
-000269c0: 6972 636c 655f 636c 6f73 6573 745f 7468  ircle_closest_th
-000269d0: 6574 612c 0a20 2020 2020 2020 2020 2020  eta,.           
-000269e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000269f0: 2020 2020 2020 2020 2020 2064 6f75 626c             doubl
-00026a00: 655b 3a3a 315d 2063 6972 636c 655f 636c  e[::1] circle_cl
-00026a10: 6f73 6573 745f 702c 0a20 2020 2020 2020  osest_p,.       
-00026a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026a30: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00026a40: 6f75 626c 655b 3a3a 315d 2063 6972 636c  ouble[::1] circl
-00026a50: 655f 636c 6f73 6573 745f 696d 7074 6865  e_closest_impthe
-00026a60: 7461 2c0a 2020 2020 2020 2020 2020 2020  ta,.            
-00026a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026a80: 2020 2020 2020 2020 2020 646f 7562 6c65            double
-00026a90: 5b3a 3a31 5d20 6369 7263 6c65 5f63 6c6f  [::1] circle_clo
-00026aa0: 7365 7374 5f70 6869 2c0a 2020 2020 2020  sest_phi,.      
-00026ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026ad0: 6269 6e74 2069 735f 4c4f 535f 4d6f 6465  bint is_LOS_Mode
-00026ae0: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
-00026af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026b00: 2020 2020 2020 2020 2020 2020 2020 646f                do
-00026b10: 7562 6c65 5b3a 3a31 5d20 6b4f 7574 3d4e  uble[::1] kOut=N
-00026b20: 6f6e 6529 206e 6f67 696c 3a0a 2020 2020  one) nogil:.    
-00026b30: 6364 6566 2069 6e74 2069 6e64 5f6c 6f73  cdef int ind_los
-00026b40: 0a20 2020 2063 6465 6620 646f 7562 6c65  .    cdef double
-00026b50: 2a20 6469 7276 0a20 2020 2063 6465 6620  * dirv.    cdef 
-00026b60: 646f 7562 6c65 2a20 6f72 6967 0a20 2020  double* orig.   
-00026b70: 2063 6465 6620 646f 7562 6c65 2a20 7265   cdef double* re
-00026b80: 730a 2020 2020 6364 6566 2064 6f75 626c  s.    cdef doubl
-00026b90: 6520 6e6f 726d 752c 206e 6f72 6d75 5f73  e normu, normu_s
-00026ba0: 710a 2020 2020 6364 6566 2064 6f75 626c  q.    cdef doubl
-00026bb0: 6520 6b50 4d69 6e2c 2050 4d69 6e32 6e6f  e kPMin, PMin2no
-00026bc0: 726d 2c20 5468 6574 610a 2020 2020 6364  rm, Theta.    cd
-00026bd0: 6566 2064 6f75 626c 6520 7650 3020 3d20  ef double vP0 = 
-00026be0: 302e 300a 2020 2020 6364 6566 2064 6f75  0.0.    cdef dou
-00026bf0: 626c 6520 7650 3120 3d20 302e 300a 2020  ble vP1 = 0.0.  
-00026c00: 2020 6364 6566 2064 6f75 626c 6520 6554    cdef double eT
-00026c10: 6865 7461 300a 2020 2020 6364 6566 2064  heta0.    cdef d
-00026c20: 6f75 626c 6520 6554 6865 7461 310a 2020  ouble eTheta1.  
-00026c30: 2020 6364 6566 2064 6f75 626c 6520 6e6f    cdef double no
-00026c40: 726d 7530 0a20 2020 2063 6465 6620 646f  rmu0.    cdef do
-00026c50: 7562 6c65 206e 6f72 6d75 310a 2020 2020  uble normu1.    
-00026c60: 6364 6566 2064 6f75 626c 6520 6469 7374  cdef double dist
-00026c70: 616e 6365 0a20 2020 2063 6465 6620 646f  ance.    cdef do
-00026c80: 7562 6c65 2050 4d69 6e30 2c20 504d 696e  uble PMin0, PMin
-00026c90: 312c 2050 4d69 6e32 0a0a 2020 2020 7769  1, PMin2..    wi
-00026ca0: 7468 206e 6f67 696c 2c20 7061 7261 6c6c  th nogil, parall
-00026cb0: 656c 2829 3a0a 2020 2020 2020 2020 6469  el():.        di
-00026cc0: 7276 203d 203c 646f 7562 6c65 2a3e 6d61  rv = <double*>ma
-00026cd0: 6c6c 6f63 2833 2a73 697a 656f 6628 646f  lloc(3*sizeof(do
-00026ce0: 7562 6c65 2929 0a20 2020 2020 2020 206f  uble)).        o
-00026cf0: 7269 6720 3d20 3c64 6f75 626c 652a 3e6d  rig = <double*>m
-00026d00: 616c 6c6f 6328 332a 7369 7a65 6f66 2864  alloc(3*sizeof(d
-00026d10: 6f75 626c 6529 290a 2020 2020 2020 2020  ouble)).        
-00026d20: 7265 7320 3d20 3c64 6f75 626c 652a 3e6d  res = <double*>m
-00026d30: 616c 6c6f 6328 322a 7369 7a65 6f66 2864  alloc(2*sizeof(d
-00026d40: 6f75 626c 6529 290a 2020 2020 2020 2020  ouble)).        
-00026d50: 666f 7220 696e 645f 6c6f 7320 696e 2070  for ind_los in p
-00026d60: 7261 6e67 6528 6e6c 6f73 293a 0a20 2020  range(nlos):.   
-00026d70: 2020 2020 2020 2020 2064 6972 765b 305d           dirv[0]
-00026d80: 203d 2064 6972 6563 7469 6f6e 735b 302c   = directions[0,
-00026d90: 2069 6e64 5f6c 6f73 5d0a 2020 2020 2020   ind_los].      
-00026da0: 2020 2020 2020 6469 7276 5b31 5d20 3d20        dirv[1] = 
-00026db0: 6469 7265 6374 696f 6e73 5b31 2c20 696e  directions[1, in
-00026dc0: 645f 6c6f 735d 0a20 2020 2020 2020 2020  d_los].         
-00026dd0: 2020 2064 6972 765b 325d 203d 2064 6972     dirv[2] = dir
-00026de0: 6563 7469 6f6e 735b 322c 2069 6e64 5f6c  ections[2, ind_l
-00026df0: 6f73 5d0a 2020 2020 2020 2020 2020 2020  os].            
-00026e00: 6f72 6967 5b30 5d20 3d20 6f72 6967 696e  orig[0] = origin
-00026e10: 735b 302c 2069 6e64 5f6c 6f73 5d0a 2020  s[0, ind_los].  
-00026e20: 2020 2020 2020 2020 2020 6f72 6967 5b31            orig[1
-00026e30: 5d20 3d20 6f72 6967 696e 735b 312c 2069  ] = origins[1, i
-00026e40: 6e64 5f6c 6f73 5d0a 2020 2020 2020 2020  nd_los].        
-00026e50: 2020 2020 6f72 6967 5b32 5d20 3d20 6f72      orig[2] = or
-00026e60: 6967 696e 735b 322c 2069 6e64 5f6c 6f73  igins[2, ind_los
-00026e70: 5d0a 2020 2020 2020 2020 2020 2020 6e6f  ].            no
-00026e80: 726d 755f 7371 203d 2064 6972 765b 305d  rmu_sq = dirv[0]
-00026e90: 202a 2064 6972 765b 305d 202b 2064 6972   * dirv[0] + dir
-00026ea0: 765b 315d 202a 2064 6972 765b 315d 202b  v[1] * dirv[1] +
-00026eb0: 2064 6972 765b 325d 202a 2064 6972 765b   dirv[2] * dirv[
-00026ec0: 325d 0a20 2020 2020 2020 2020 2020 206e  2].            n
-00026ed0: 6f72 6d75 203d 2063 5f73 7172 7428 6e6f  ormu = c_sqrt(no
-00026ee0: 726d 755f 7371 290a 2020 2020 2020 2020  rmu_sq).        
-00026ef0: 2020 2020 2320 436f 6d70 7574 696e 6720      # Computing 
-00026f00: 636f 6566 6620 6f66 2063 6c6f 7365 7374  coeff of closest
-00026f10: 206f 6e20 6c69 6e65 2e2e 2e2e 2e2e 2e2e   on line........
-00026f20: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00026f30: 2e2e 2e2e 2e2e 2e2e 0a20 2020 2020 2020  .........       
-00026f40: 2020 2020 2069 6620 6469 7276 5b30 5d20       if dirv[0] 
-00026f50: 3d3d 2030 2e20 616e 6420 6469 7276 5b31  == 0. and dirv[1
-00026f60: 5d20 3d3d 2030 2e3a 0a20 2020 2020 2020  ] == 0.:.       
-00026f70: 2020 2020 2020 2020 206b 504d 696e 203d           kPMin =
-00026f80: 2028 6369 7263 5f6e 6f72 6d7a 2d6f 7269   (circ_normz-ori
-00026f90: 675b 325d 292f 6469 7276 5b32 5d0a 2020  g[2])/dirv[2].  
-00026fa0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00026fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026fc0: 5f64 742e 6469 7374 5f6c 6f73 5f63 6972  _dt.dist_los_cir
-00026fd0: 636c 655f 636f 7265 2864 6972 762c 206f  cle_core(dirv, o
-00026fe0: 7269 672c 2063 6972 635f 7261 6469 7573  rig, circ_radius
-00026ff0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00027000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027010: 2020 2020 2020 2020 2020 6369 7263 5f6e            circ_n
-00027020: 6f72 6d7a 2c20 6e6f 726d 755f 7371 2c20  ormz, normu_sq, 
-00027030: 7265 7329 0a20 2020 2020 2020 2020 2020  res).           
-00027040: 2020 2020 206b 504d 696e 203d 2072 6573       kPMin = res
-00027050: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
-00027060: 2020 2020 6469 7374 616e 6365 203d 2072      distance = r
-00027070: 6573 5b31 5d0a 2020 2020 2020 2020 2020  es[1].          
-00027080: 2020 6966 2069 735f 4c4f 535f 4d6f 6465    if is_LOS_Mode
-00027090: 2061 6e64 206b 4f75 7420 6973 206e 6f74   and kOut is not
-000270a0: 204e 6f6e 6520 616e 6420 6b50 4d69 6e20   None and kPMin 
-000270b0: 3e20 6b4f 7574 5b69 6e64 5f6c 6f73 5d3a  > kOut[ind_los]:
-000270c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000270d0: 206b 504d 696e 203d 206b 4f75 745b 696e   kPMin = kOut[in
-000270e0: 645f 6c6f 735d 0a20 2020 2020 2020 2020  d_los].         
-000270f0: 2020 206c 6f73 5f63 6c6f 7365 7374 5f63     los_closest_c
-00027100: 6f65 6666 735b 696e 645f 6c6f 735d 203d  oeffs[ind_los] =
-00027110: 206b 504d 696e 0a0a 2020 2020 2020 2020   kPMin..        
-00027120: 2020 2020 2320 436f 6d70 7574 696e 6720      # Computing 
-00027130: 7468 6520 696e 666f 206f 6620 7468 6520  the info of the 
-00027140: 636c 6f73 6573 7420 706f 696e 7420 6f6e  closest point on
-00027150: 204c 4f53 2026 2043 6972 636c 652e 2e2e   LOS & Circle...
-00027160: 2e2e 2e2e 2e2e 2e2e 0a20 2020 2020 2020  .........       
-00027170: 2020 2020 2050 4d69 6e30 203d 206f 7269       PMin0 = ori
-00027180: 675b 305d 202b 206b 504d 696e 202a 2064  g[0] + kPMin * d
-00027190: 6972 765b 305d 0a20 2020 2020 2020 2020  irv[0].         
-000271a0: 2020 2050 4d69 6e31 203d 206f 7269 675b     PMin1 = orig[
-000271b0: 315d 202b 206b 504d 696e 202a 2064 6972  1] + kPMin * dir
-000271c0: 765b 315d 0a20 2020 2020 2020 2020 2020  v[1].           
-000271d0: 2050 4d69 6e32 203d 206f 7269 675b 325d   PMin2 = orig[2]
-000271e0: 202b 206b 504d 696e 202a 2064 6972 765b   + kPMin * dirv[
-000271f0: 325d 0a20 2020 2020 2020 2020 2020 206c  2].            l
-00027200: 6f73 5f63 6c6f 7365 7374 5f63 6f6f 7264  os_closest_coord
-00027210: 735b 302c 2069 6e64 5f6c 6f73 5d20 3d20  s[0, ind_los] = 
-00027220: 504d 696e 300a 2020 2020 2020 2020 2020  PMin0.          
-00027230: 2020 6c6f 735f 636c 6f73 6573 745f 636f    los_closest_co
-00027240: 6f72 6473 5b31 2c20 696e 645f 6c6f 735d  ords[1, ind_los]
-00027250: 203d 2050 4d69 6e31 0a20 2020 2020 2020   = PMin1.       
-00027260: 2020 2020 206c 6f73 5f63 6c6f 7365 7374       los_closest
-00027270: 5f63 6f6f 7264 735b 322c 2069 6e64 5f6c  _coords[2, ind_l
-00027280: 6f73 5d20 3d20 504d 696e 320a 2020 2020  os] = PMin2.    
-00027290: 2020 2020 2020 2020 2320 436f 6d70 7574          # Comput
-000272a0: 696e 6720 524d 696e 3a0a 2020 2020 2020  ing RMin:.      
-000272b0: 2020 2020 2020 504d 696e 326e 6f72 6d20        PMin2norm 
-000272c0: 3d20 635f 7371 7274 2850 4d69 6e30 2a2a  = c_sqrt(PMin0**
-000272d0: 322b 504d 696e 312a 2a32 290a 2020 2020  2+PMin1**2).    
-000272e0: 2020 2020 2020 2020 6369 7263 6c65 5f63          circle_c
-000272f0: 6c6f 7365 7374 5f72 6d69 6e5b 696e 645f  losest_rmin[ind_
-00027300: 6c6f 735d 203d 2063 5f73 7172 7428 2850  los] = c_sqrt((P
-00027310: 4d69 6e32 6e6f 726d 202d 2063 6972 635f  Min2norm - circ_
-00027320: 7261 6469 7573 292a 2a32 0a20 2020 2020  radius)**2.     
-00027330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027350: 2020 202b 2028 504d 696e 3220 2020 2d20     + (PMin2   - 
-00027360: 6369 7263 5f6e 6f72 6d7a 292a 2a32 290a  circ_normz)**2).
-00027370: 2020 2020 2020 2020 2020 2020 2320 5468              # Th
-00027380: 6574 6120 616e 6420 496d 7054 6865 7461  eta and ImpTheta
-00027390: 3a0a 2020 2020 2020 2020 2020 2020 7650  :.            vP
-000273a0: 3020 3d20 504d 696e 326e 6f72 6d20 2d20  0 = PMin2norm - 
-000273b0: 6369 7263 5f72 6164 6975 730a 2020 2020  circ_radius.    
-000273c0: 2020 2020 2020 2020 7650 3120 3d20 504d          vP1 = PM
-000273d0: 696e 3220 2020 2020 2d20 6369 7263 5f6e  in2     - circ_n
-000273e0: 6f72 6d7a 0a20 2020 2020 2020 2020 2020  ormz.           
-000273f0: 2054 6865 7461 203d 2063 5f61 7461 6e32   Theta = c_atan2
-00027400: 2876 5031 2c20 7650 3029 0a20 2020 2020  (vP1, vP0).     
-00027410: 2020 2020 2020 2063 6972 636c 655f 636c         circle_cl
-00027420: 6f73 6573 745f 7468 6574 615b 696e 645f  osest_theta[ind_
-00027430: 6c6f 735d 203d 2054 6865 7461 0a20 2020  los] = Theta.   
-00027440: 2020 2020 2020 2020 2069 6620 5468 6574           if Thet
-00027450: 6120 3c20 303a 0a20 2020 2020 2020 2020  a < 0:.         
-00027460: 2020 2020 2020 2054 6865 7461 203d 2054         Theta = T
-00027470: 6865 7461 202b 2063 5f70 690a 2020 2020  heta + c_pi.    
-00027480: 2020 2020 2020 2020 6369 7263 6c65 5f63          circle_c
-00027490: 6c6f 7365 7374 5f69 6d70 7468 6574 615b  losest_imptheta[
-000274a0: 696e 645f 6c6f 735d 203d 2054 6865 7461  ind_los] = Theta
-000274b0: 0a20 2020 2020 2020 2020 2020 2063 6972  .            cir
-000274c0: 636c 655f 636c 6f73 6573 745f 705b 696e  cle_closest_p[in
-000274d0: 645f 6c6f 735d 203d 2076 5030 202a 2063  d_los] = vP0 * c
-000274e0: 5f63 6f73 2854 6865 7461 2920 2b20 7650  _cos(Theta) + vP
-000274f0: 3120 2a20 635f 7369 6e28 5468 6574 6129  1 * c_sin(Theta)
-00027500: 0a20 2020 2020 2020 2020 2020 2023 2050  .            # P
-00027510: 6869 3a0a 2020 2020 2020 2020 2020 2020  hi:.            
-00027520: 6554 6865 7461 3020 3d20 2d20 504d 696e  eTheta0 = - PMin
-00027530: 3120 2f20 504d 696e 326e 6f72 6d0a 2020  1 / PMin2norm.  
-00027540: 2020 2020 2020 2020 2020 6554 6865 7461            eTheta
-00027550: 3120 3d20 2020 504d 696e 3020 2f20 504d  1 =   PMin0 / PM
-00027560: 696e 326e 6f72 6d0a 2020 2020 2020 2020  in2norm.        
-00027570: 2020 2020 6e6f 726d 7530 203d 2064 6972      normu0 = dir
-00027580: 765b 305d 2f6e 6f72 6d75 0a20 2020 2020  v[0]/normu.     
-00027590: 2020 2020 2020 206e 6f72 6d75 3120 3d20         normu1 = 
-000275a0: 6469 7276 5b31 5d2f 6e6f 726d 750a 2020  dirv[1]/normu.  
-000275b0: 2020 2020 2020 2020 2020 6369 7263 6c65            circle
-000275c0: 5f63 6c6f 7365 7374 5f70 6869 5b69 6e64  _closest_phi[ind
-000275d0: 5f6c 6f73 5d20 3d20 635f 6173 696e 282d  _los] = c_asin(-
-000275e0: 6e6f 726d 7530 202a 2065 5468 6574 6130  normu0 * eTheta0
-000275f0: 202d 206e 6f72 6d75 3120 2a20 6554 6865   - normu1 * eThe
-00027600: 7461 3129 0a20 2020 2020 2020 2066 7265  ta1).        fre
-00027610: 6528 6469 7276 290a 2020 2020 2020 2020  e(dirv).        
-00027620: 6672 6565 286f 7269 6729 0a20 2020 2020  free(orig).     
-00027630: 2020 2066 7265 6528 7265 7329 0a20 2020     free(res).   
-00027640: 2072 6574 7572 6e0a 0a0a 0a63 6465 6620   return....cdef 
-00027650: 4c4f 535f 7369 6e6f 5f4c 696e 2864 6f75  LOS_sino_Lin(dou
-00027660: 626c 6520 4430 2c20 646f 7562 6c65 2044  ble D0, double D
-00027670: 312c 2064 6f75 626c 6520 4432 2c20 646f  1, double D2, do
-00027680: 7562 6c65 2075 302c 2064 6f75 626c 6520  uble u0, double 
-00027690: 7531 2c20 646f 7562 6c65 0a20 2020 2020  u1, double.     
-000276a0: 2020 2020 2020 2020 2020 2020 2075 322c               u2,
-000276b0: 2064 6f75 626c 6520 525a 302c 2064 6f75   double RZ0, dou
-000276c0: 626c 6520 525a 312c 2073 7472 204d 6f64  ble RZ1, str Mod
-000276d0: 653d 274c 4f53 272c 0a20 2020 2020 2020  e='LOS',.       
-000276e0: 2020 2020 2020 2020 2020 2064 6f75 626c             doubl
-000276f0: 6520 6b4f 7574 3d43 5f49 4e46 293a 0a20  e kOut=C_INF):. 
-00027700: 2020 2063 6465 6620 646f 7562 6c65 2020     cdef double  
-00027710: 2020 6b50 4d69 6e0a 2020 2020 6966 2075    kPMin.    if u
-00027720: 302a 2a32 3d3d 312e 3a0a 2020 2020 2020  0**2==1.:.      
-00027730: 2020 6b50 4d69 6e20 3d20 302e 0a20 2020    kPMin = 0..   
-00027740: 2065 6c73 653a 0a20 2020 2020 2020 206b   else:.        k
-00027750: 504d 696e 203d 2028 2028 525a 302d 4431  PMin = ( (RZ0-D1
-00027760: 292a 7531 2b28 525a 312d 4432 292a 7532  )*u1+(RZ1-D2)*u2
-00027770: 2029 202f 2028 312d 7530 2a2a 3229 0a20   ) / (1-u0**2). 
-00027780: 2020 206b 504d 696e 203d 206b 4f75 7420     kPMin = kOut 
-00027790: 6966 204d 6f64 653d 3d27 4c4f 5327 2061  if Mode=='LOS' a
-000277a0: 6e64 206b 504d 696e 203e 206b 4f75 7420  nd kPMin > kOut 
-000277b0: 656c 7365 206b 504d 696e 0a20 2020 2063  else kPMin.    c
-000277c0: 6465 6620 646f 7562 6c65 2020 2020 504d  def double    PM
-000277d0: 696e 3020 3d20 4430 2b6b 504d 696e 2a75  in0 = D0+kPMin*u
-000277e0: 302c 2050 4d69 6e31 203d 2044 312b 6b50  0, PMin1 = D1+kP
-000277f0: 4d69 6e2a 7531 2c20 504d 696e 3220 3d20  Min*u1, PMin2 = 
-00027800: 4432 2b6b 504d 696e 2a75 320a 2020 2020  D2+kPMin*u2.    
-00027810: 6364 6566 2064 6f75 626c 6520 2020 2052  cdef double    R
-00027820: 4d69 6e20 3d20 635f 7371 7274 2828 504d  Min = c_sqrt((PM
-00027830: 696e 312d 525a 3029 2a2a 322b 2850 4d69  in1-RZ0)**2+(PMi
-00027840: 6e32 2d52 5a31 292a 2a32 290a 2020 2020  n2-RZ1)**2).    
-00027850: 6364 6566 2064 6f75 626c 6520 2020 2076  cdef double    v
-00027860: 5030 203d 2050 4d69 6e31 2d52 5a30 2c20  P0 = PMin1-RZ0, 
-00027870: 7650 3120 3d20 504d 696e 322d 525a 310a  vP1 = PMin2-RZ1.
-00027880: 2020 2020 6364 6566 2064 6f75 626c 6520      cdef double 
-00027890: 2020 2054 6865 7461 203d 2063 5f61 7461     Theta = c_ata
-000278a0: 6e32 2876 5031 2c76 5030 290a 2020 2020  n2(vP1,vP0).    
-000278b0: 6364 6566 2064 6f75 626c 6520 2020 2049  cdef double    I
-000278c0: 6d70 5468 6574 6120 3d20 5468 6574 6120  mpTheta = Theta 
-000278d0: 6966 2054 6865 7461 3e3d 3020 656c 7365  if Theta>=0 else
-000278e0: 2054 6865 7461 202b 206e 702e 7069 0a20   Theta + np.pi. 
-000278f0: 2020 2063 6465 6620 646f 7562 6c65 2020     cdef double  
-00027900: 2020 6572 3244 3020 3d20 635f 636f 7328    er2D0 = c_cos(
-00027910: 496d 7054 6865 7461 292c 2065 7232 4431  ImpTheta), er2D1
-00027920: 203d 2063 5f73 696e 2849 6d70 5468 6574   = c_sin(ImpThet
-00027930: 6129 0a20 2020 2063 6465 6620 646f 7562  a).    cdef doub
-00027940: 6c65 2020 2020 7030 203d 2076 5030 2a65  le    p0 = vP0*e
-00027950: 7232 4430 202b 2076 5031 2a65 7232 4431  r2D0 + vP1*er2D1
-00027960: 0a20 2020 2063 6465 6620 646f 7562 6c65  .    cdef double
-00027970: 2020 2020 754e 203d 2063 5f73 7172 7428      uN = c_sqrt(
-00027980: 7530 2a2a 322b 7531 2a2a 322b 7532 2a2a  u0**2+u1**2+u2**
-00027990: 3229 0a20 2020 2063 6465 6620 646f 7562  2).    cdef doub
-000279a0: 6c65 2020 2020 754e 3020 3d20 7530 2f75  le    uN0 = u0/u
-000279b0: 4e2c 2075 4e31 203d 2075 312f 754e 2c20  N, uN1 = u1/uN, 
-000279c0: 754e 3220 3d20 7532 2f75 4e0a 2020 2020  uN2 = u2/uN.    
-000279d0: 6364 6566 2064 6f75 626c 6520 2020 2070  cdef double    p
-000279e0: 6869 203d 2063 5f61 7461 6e32 2875 4e30  hi = c_atan2(uN0
-000279f0: 2c20 635f 7371 7274 2875 4e31 2a2a 322b  , c_sqrt(uN1**2+
-00027a00: 754e 322a 2a32 2929 0a20 2020 2072 6574  uN2**2)).    ret
-00027a10: 7572 6e20 2850 4d69 6e30 2c50 4d69 6e31  urn (PMin0,PMin1
-00027a20: 2c50 4d69 6e32 292c 206b 504d 696e 2c20  ,PMin2), kPMin, 
-00027a30: 524d 696e 2c20 5468 6574 612c 2070 302c  RMin, Theta, p0,
-00027a40: 2049 6d70 5468 6574 612c 2070 6869 0a0a   ImpTheta, phi..
-00027a50: 0a64 6566 204c 4f53 5f73 696e 6f28 646f  .def LOS_sino(do
-00027a60: 7562 6c65 5b3a 2c3a 3a31 5d20 442c 2064  uble[:,::1] D, d
-00027a70: 6f75 626c 655b 3a2c 3a3a 315d 2075 2c20  ouble[:,::1] u, 
-00027a80: 646f 7562 6c65 5b3a 3a31 5d20 525a 2c20  double[::1] RZ, 
-00027a90: 646f 7562 6c65 5b3a 3a31 5d20 6b4f 7574  double[::1] kOut
-00027aa0: 2c0a 2020 2020 2020 2020 2020 2020 2073  ,.             s
-00027ab0: 7472 204d 6f64 653d 274c 4f53 272c 2073  tr Mode='LOS', s
-00027ac0: 7472 2056 5479 7065 3d27 546f 7227 2c20  tr VType='Tor', 
-00027ad0: 6269 6e74 2074 7279 5f6e 6577 5f61 6c67  bint try_new_alg
-00027ae0: 6f3d 5472 7565 293a 0a20 2020 2063 6465  o=True):.    cde
-00027af0: 6620 756e 7369 676e 6564 2069 6e74 206e  f unsigned int n
-00027b00: 4c20 3d20 442e 7368 6170 655b 315d 2c20  L = D.shape[1], 
-00027b10: 6969 0a20 2020 2063 6465 6620 7475 706c  ii.    cdef tupl
-00027b20: 6520 6f75 740a 2020 2020 6364 6566 206e  e out.    cdef n
-00027b30: 702e 6e64 6172 7261 795b 646f 7562 6c65  p.ndarray[double
-00027b40: 2c6e 6469 6d3d 325d 2050 4d69 6e20 3d20  ,ndim=2] PMin = 
-00027b50: 6e70 2e65 6d70 7479 2828 332c 6e4c 2929  np.empty((3,nL))
-00027b60: 0a20 2020 2063 6465 6620 6e70 2e6e 6461  .    cdef np.nda
-00027b70: 7272 6179 5b64 6f75 626c 652c 6e64 696d  rray[double,ndim
-00027b80: 3d31 5d20 6b50 4d69 6e3d 6e70 2e65 6d70  =1] kPMin=np.emp
-00027b90: 7479 2828 6e4c 2c29 292c 2052 4d69 6e3d  ty((nL,)), RMin=
-00027ba0: 6e70 2e65 6d70 7479 2828 6e4c 2c29 290a  np.empty((nL,)).
-00027bb0: 2020 2020 6364 6566 206e 702e 6e64 6172      cdef np.ndar
-00027bc0: 7261 795b 646f 7562 6c65 2c6e 6469 6d3d  ray[double,ndim=
-00027bd0: 315d 2054 6865 7461 3d6e 702e 656d 7074  1] Theta=np.empt
-00027be0: 7928 286e 4c2c 2929 2c20 703d 6e70 2e65  y((nL,)), p=np.e
-00027bf0: 6d70 7479 2828 6e4c 2c29 290a 2020 2020  mpty((nL,)).    
-00027c00: 6364 6566 206e 702e 6e64 6172 7261 795b  cdef np.ndarray[
-00027c10: 646f 7562 6c65 2c6e 6469 6d3d 315d 2049  double,ndim=1] I
-00027c20: 6d70 5468 6574 613d 6e70 2e65 6d70 7479  mpTheta=np.empty
-00027c30: 2828 6e4c 2c29 292c 2070 6869 3d6e 702e  ((nL,)), phi=np.
-00027c40: 656d 7074 7928 286e 4c2c 2929 0a20 2020  empty((nL,)).   
-00027c50: 2063 6465 6620 646f 7562 6c65 5b39 5d20   cdef double[9] 
-00027c60: 7265 7375 6c74 730a 2020 2020 6364 6566  results.    cdef
-00027c70: 2062 696e 7420 6973 5f4c 4f53 5f4d 6f64   bint is_LOS_Mod
-00027c80: 650a 2020 2020 6966 2056 5479 7065 2e6c  e.    if VType.l
-00027c90: 6f77 6572 2829 3d3d 2774 6f72 273a 0a20  ower()=='tor':. 
-00027ca0: 2020 2020 2020 2069 6620 6e6f 7420 7472         if not tr
-00027cb0: 795f 6e65 775f 616c 676f 3a0a 2020 2020  y_new_algo:.    
-00027cc0: 2020 2020 2020 2020 666f 7220 6969 2069          for ii i
-00027cd0: 6e20 7261 6e67 6528 302c 6e4c 293a 0a20  n range(0,nL):. 
-00027ce0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-00027cf0: 7574 203d 204c 4f53 5f73 696e 6f5f 546f  ut = LOS_sino_To
-00027d00: 7228 445b 302c 6969 5d2c 445b 312c 6969  r(D[0,ii],D[1,ii
-00027d10: 5d2c 445b 322c 6969 5d2c 0a20 2020 2020  ],D[2,ii],.     
-00027d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027d30: 2020 2020 2020 2020 2020 2020 2020 755b                u[
-00027d40: 302c 6969 5d2c 755b 312c 6969 5d2c 755b  0,ii],u[1,ii],u[
-00027d50: 322c 6969 5d2c 0a20 2020 2020 2020 2020  2,ii],.         
-00027d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027d70: 2020 2020 2020 2020 2020 525a 5b30 5d2c            RZ[0],
-00027d80: 525a 5b31 5d2c 204d 6f64 653d 4d6f 6465  RZ[1], Mode=Mode
-00027d90: 2c20 6b4f 7574 3d6b 4f75 745b 6969 5d29  , kOut=kOut[ii])
-00027da0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00027db0: 2028 2850 4d69 6e5b 302c 6969 5d2c 504d   ((PMin[0,ii],PM
-00027dc0: 696e 5b31 2c69 695d 2c50 4d69 6e5b 322c  in[1,ii],PMin[2,
-00027dd0: 6969 5d29 2c0a 2020 2020 2020 2020 2020  ii]),.          
-00027de0: 2020 2020 2020 206b 504d 696e 5b69 695d         kPMin[ii]
-00027df0: 2c20 524d 696e 5b69 695d 2c20 5468 6574  , RMin[ii], Thet
-00027e00: 615b 6969 5d2c 0a20 2020 2020 2020 2020  a[ii],.         
-00027e10: 2020 2020 2020 2020 705b 6969 5d2c 2049          p[ii], I
-00027e20: 6d70 5468 6574 615b 6969 5d2c 2070 6869  mpTheta[ii], phi
-00027e30: 5b69 695d 2920 3d20 6f75 740a 2020 2020  [ii]) = out.    
-00027e40: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00027e50: 2020 2020 2020 6973 5f4c 4f53 5f4d 6f64        is_LOS_Mod
-00027e60: 6520 3d20 4d6f 6465 2e6c 6f77 6572 2829  e = Mode.lower()
-00027e70: 203d 3d20 276c 6f73 270a 2020 2020 2020   == 'los'.      
-00027e80: 2020 2020 2020 4e45 575f 6c6f 735f 7369        NEW_los_si
-00027e90: 6e6f 5f74 6f72 5f76 6563 286e 4c2c 2044  no_tor_vec(nL, D
-00027ea0: 2c20 752c 2052 5a5b 305d 2c20 525a 5b31  , u, RZ[0], RZ[1
-00027eb0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00027ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027ed0: 2020 2020 504d 696e 2c20 6b50 4d69 6e2c      PMin, kPMin,
-00027ee0: 2052 4d69 6e2c 2054 6865 7461 2c20 702c   RMin, Theta, p,
-00027ef0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00027f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027f10: 2020 496d 7054 6865 7461 2c20 7068 692c    ImpTheta, phi,
-00027f20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000268d0: 2020 2020 646f 7562 6c65 2063 6972 635f      double circ_
+000268e0: 6e6f 726d 7a2c 0a20 2020 2020 2020 2020  normz,.         
+000268f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026900: 2020 2020 2020 2020 2020 2020 2064 6f75               dou
+00026910: 626c 655b 3a2c 3a3a 315d 206c 6f73 5f63  ble[:,::1] los_c
+00026920: 6c6f 7365 7374 5f63 6f6f 7264 732c 0a20  losest_coords,. 
+00026930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026950: 2020 2020 2064 6f75 626c 655b 3a3a 315d       double[::1]
+00026960: 206c 6f73 5f63 6c6f 7365 7374 5f63 6f65   los_closest_coe
+00026970: 6666 732c 0a20 2020 2020 2020 2020 2020  ffs,.           
+00026980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026990: 2020 2020 2020 2020 2020 2064 6f75 626c             doubl
+000269a0: 655b 3a3a 315d 2063 6972 636c 655f 636c  e[::1] circle_cl
+000269b0: 6f73 6573 745f 726d 696e 2c0a 2020 2020  osest_rmin,.    
+000269c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000269d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000269e0: 2020 646f 7562 6c65 5b3a 3a31 5d20 6369    double[::1] ci
+000269f0: 7263 6c65 5f63 6c6f 7365 7374 5f74 6865  rcle_closest_the
+00026a00: 7461 2c0a 2020 2020 2020 2020 2020 2020  ta,.            
+00026a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026a20: 2020 2020 2020 2020 2020 646f 7562 6c65            double
+00026a30: 5b3a 3a31 5d20 6369 7263 6c65 5f63 6c6f  [::1] circle_clo
+00026a40: 7365 7374 5f70 2c0a 2020 2020 2020 2020  sest_p,.        
+00026a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026a60: 2020 2020 2020 2020 2020 2020 2020 646f                do
+00026a70: 7562 6c65 5b3a 3a31 5d20 6369 7263 6c65  uble[::1] circle
+00026a80: 5f63 6c6f 7365 7374 5f69 6d70 7468 6574  _closest_impthet
+00026a90: 612c 0a20 2020 2020 2020 2020 2020 2020  a,.             
+00026aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026ab0: 2020 2020 2020 2020 2064 6f75 626c 655b           double[
+00026ac0: 3a3a 315d 2063 6972 636c 655f 636c 6f73  ::1] circle_clos
+00026ad0: 6573 745f 7068 692c 0a20 2020 2020 2020  est_phi,.       
+00026ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026af0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+00026b00: 696e 7420 6973 5f4c 4f53 5f4d 6f64 653d  int is_LOS_Mode=
+00026b10: 4661 6c73 652c 0a20 2020 2020 2020 2020  False,.         
+00026b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026b30: 2020 2020 2020 2020 2020 2020 2064 6f75               dou
+00026b40: 626c 655b 3a3a 315d 206b 4f75 743d 4e6f  ble[::1] kOut=No
+00026b50: 6e65 2920 6e6f 6769 6c3a 0a20 2020 2063  ne) nogil:.    c
+00026b60: 6465 6620 696e 7420 696e 645f 6c6f 730a  def int ind_los.
+00026b70: 2020 2020 6364 6566 2064 6f75 626c 652a      cdef double*
+00026b80: 2064 6972 760a 2020 2020 6364 6566 2064   dirv.    cdef d
+00026b90: 6f75 626c 652a 206f 7269 670a 2020 2020  ouble* orig.    
+00026ba0: 6364 6566 2064 6f75 626c 652a 2072 6573  cdef double* res
+00026bb0: 0a20 2020 2063 6465 6620 646f 7562 6c65  .    cdef double
+00026bc0: 206e 6f72 6d75 2c20 6e6f 726d 755f 7371   normu, normu_sq
+00026bd0: 0a20 2020 2063 6465 6620 646f 7562 6c65  .    cdef double
+00026be0: 206b 504d 696e 2c20 504d 696e 326e 6f72   kPMin, PMin2nor
+00026bf0: 6d2c 2054 6865 7461 0a20 2020 2063 6465  m, Theta.    cde
+00026c00: 6620 646f 7562 6c65 2076 5030 203d 2030  f double vP0 = 0
+00026c10: 2e30 0a20 2020 2063 6465 6620 646f 7562  .0.    cdef doub
+00026c20: 6c65 2076 5031 203d 2030 2e30 0a20 2020  le vP1 = 0.0.   
+00026c30: 2063 6465 6620 646f 7562 6c65 2065 5468   cdef double eTh
+00026c40: 6574 6130 0a20 2020 2063 6465 6620 646f  eta0.    cdef do
+00026c50: 7562 6c65 2065 5468 6574 6131 0a20 2020  uble eTheta1.   
+00026c60: 2063 6465 6620 646f 7562 6c65 206e 6f72   cdef double nor
+00026c70: 6d75 300a 2020 2020 6364 6566 2064 6f75  mu0.    cdef dou
+00026c80: 626c 6520 6e6f 726d 7531 0a20 2020 2063  ble normu1.    c
+00026c90: 6465 6620 646f 7562 6c65 2064 6973 7461  def double dista
+00026ca0: 6e63 650a 2020 2020 6364 6566 2064 6f75  nce.    cdef dou
+00026cb0: 626c 6520 504d 696e 302c 2050 4d69 6e31  ble PMin0, PMin1
+00026cc0: 2c20 504d 696e 320a 0a20 2020 2077 6974  , PMin2..    wit
+00026cd0: 6820 6e6f 6769 6c2c 2070 6172 616c 6c65  h nogil, paralle
+00026ce0: 6c28 293a 0a20 2020 2020 2020 2064 6972  l():.        dir
+00026cf0: 7620 3d20 3c64 6f75 626c 652a 3e6d 616c  v = <double*>mal
+00026d00: 6c6f 6328 332a 7369 7a65 6f66 2864 6f75  loc(3*sizeof(dou
+00026d10: 626c 6529 290a 2020 2020 2020 2020 6f72  ble)).        or
+00026d20: 6967 203d 203c 646f 7562 6c65 2a3e 6d61  ig = <double*>ma
+00026d30: 6c6c 6f63 2833 2a73 697a 656f 6628 646f  lloc(3*sizeof(do
+00026d40: 7562 6c65 2929 0a20 2020 2020 2020 2072  uble)).        r
+00026d50: 6573 203d 203c 646f 7562 6c65 2a3e 6d61  es = <double*>ma
+00026d60: 6c6c 6f63 2832 2a73 697a 656f 6628 646f  lloc(2*sizeof(do
+00026d70: 7562 6c65 2929 0a20 2020 2020 2020 2066  uble)).        f
+00026d80: 6f72 2069 6e64 5f6c 6f73 2069 6e20 7072  or ind_los in pr
+00026d90: 616e 6765 286e 6c6f 7329 3a0a 2020 2020  ange(nlos):.    
+00026da0: 2020 2020 2020 2020 6469 7276 5b30 5d20          dirv[0] 
+00026db0: 3d20 6469 7265 6374 696f 6e73 5b30 2c20  = directions[0, 
+00026dc0: 696e 645f 6c6f 735d 0a20 2020 2020 2020  ind_los].       
+00026dd0: 2020 2020 2064 6972 765b 315d 203d 2064       dirv[1] = d
+00026de0: 6972 6563 7469 6f6e 735b 312c 2069 6e64  irections[1, ind
+00026df0: 5f6c 6f73 5d0a 2020 2020 2020 2020 2020  _los].          
+00026e00: 2020 6469 7276 5b32 5d20 3d20 6469 7265    dirv[2] = dire
+00026e10: 6374 696f 6e73 5b32 2c20 696e 645f 6c6f  ctions[2, ind_lo
+00026e20: 735d 0a20 2020 2020 2020 2020 2020 206f  s].            o
+00026e30: 7269 675b 305d 203d 206f 7269 6769 6e73  rig[0] = origins
+00026e40: 5b30 2c20 696e 645f 6c6f 735d 0a20 2020  [0, ind_los].   
+00026e50: 2020 2020 2020 2020 206f 7269 675b 315d           orig[1]
+00026e60: 203d 206f 7269 6769 6e73 5b31 2c20 696e   = origins[1, in
+00026e70: 645f 6c6f 735d 0a20 2020 2020 2020 2020  d_los].         
+00026e80: 2020 206f 7269 675b 325d 203d 206f 7269     orig[2] = ori
+00026e90: 6769 6e73 5b32 2c20 696e 645f 6c6f 735d  gins[2, ind_los]
+00026ea0: 0a20 2020 2020 2020 2020 2020 206e 6f72  .            nor
+00026eb0: 6d75 5f73 7120 3d20 6469 7276 5b30 5d20  mu_sq = dirv[0] 
+00026ec0: 2a20 6469 7276 5b30 5d20 2b20 6469 7276  * dirv[0] + dirv
+00026ed0: 5b31 5d20 2a20 6469 7276 5b31 5d20 2b20  [1] * dirv[1] + 
+00026ee0: 6469 7276 5b32 5d20 2a20 6469 7276 5b32  dirv[2] * dirv[2
+00026ef0: 5d0a 2020 2020 2020 2020 2020 2020 6e6f  ].            no
+00026f00: 726d 7520 3d20 635f 7371 7274 286e 6f72  rmu = c_sqrt(nor
+00026f10: 6d75 5f73 7129 0a20 2020 2020 2020 2020  mu_sq).         
+00026f20: 2020 2023 2043 6f6d 7075 7469 6e67 2063     # Computing c
+00026f30: 6f65 6666 206f 6620 636c 6f73 6573 7420  oeff of closest 
+00026f40: 6f6e 206c 696e 652e 2e2e 2e2e 2e2e 2e2e  on line.........
+00026f50: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00026f60: 2e2e 2e2e 2e2e 2e0a 2020 2020 2020 2020  ........        
+00026f70: 2020 2020 6966 2064 6972 765b 305d 203d      if dirv[0] =
+00026f80: 3d20 302e 2061 6e64 2064 6972 765b 315d  = 0. and dirv[1]
+00026f90: 203d 3d20 302e 3a0a 2020 2020 2020 2020   == 0.:.        
+00026fa0: 2020 2020 2020 2020 6b50 4d69 6e20 3d20          kPMin = 
+00026fb0: 2863 6972 635f 6e6f 726d 7a2d 6f72 6967  (circ_normz-orig
+00026fc0: 5b32 5d29 2f64 6972 765b 325d 0a20 2020  [2])/dirv[2].   
+00026fd0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00026fe0: 2020 2020 2020 2020 2020 2020 2020 205f                 _
+00026ff0: 6474 2e64 6973 745f 6c6f 735f 6369 7263  dt.dist_los_circ
+00027000: 6c65 5f63 6f72 6528 6469 7276 2c20 6f72  le_core(dirv, or
+00027010: 6967 2c20 6369 7263 5f72 6164 6975 732c  ig, circ_radius,
+00027020: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00027030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027040: 2020 2020 2020 2020 2063 6972 635f 6e6f           circ_no
+00027050: 726d 7a2c 206e 6f72 6d75 5f73 712c 2072  rmz, normu_sq, r
+00027060: 6573 290a 2020 2020 2020 2020 2020 2020  es).            
+00027070: 2020 2020 6b50 4d69 6e20 3d20 7265 735b      kPMin = res[
+00027080: 305d 0a20 2020 2020 2020 2020 2020 2020  0].             
+00027090: 2020 2064 6973 7461 6e63 6520 3d20 7265     distance = re
+000270a0: 735b 315d 0a20 2020 2020 2020 2020 2020  s[1].           
+000270b0: 2069 6620 6973 5f4c 4f53 5f4d 6f64 6520   if is_LOS_Mode 
+000270c0: 616e 6420 6b4f 7574 2069 7320 6e6f 7420  and kOut is not 
+000270d0: 4e6f 6e65 2061 6e64 206b 504d 696e 203e  None and kPMin >
+000270e0: 206b 4f75 745b 696e 645f 6c6f 735d 3a0a   kOut[ind_los]:.
+000270f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027100: 6b50 4d69 6e20 3d20 6b4f 7574 5b69 6e64  kPMin = kOut[ind
+00027110: 5f6c 6f73 5d0a 2020 2020 2020 2020 2020  _los].          
+00027120: 2020 6c6f 735f 636c 6f73 6573 745f 636f    los_closest_co
+00027130: 6566 6673 5b69 6e64 5f6c 6f73 5d20 3d20  effs[ind_los] = 
+00027140: 6b50 4d69 6e0a 0a20 2020 2020 2020 2020  kPMin..         
+00027150: 2020 2023 2043 6f6d 7075 7469 6e67 2074     # Computing t
+00027160: 6865 2069 6e66 6f20 6f66 2074 6865 2063  he info of the c
+00027170: 6c6f 7365 7374 2070 6f69 6e74 206f 6e20  losest point on 
+00027180: 4c4f 5320 2620 4369 7263 6c65 2e2e 2e2e  LOS & Circle....
+00027190: 2e2e 2e2e 2e2e 2e0a 2020 2020 2020 2020  ........        
+000271a0: 2020 2020 504d 696e 3020 3d20 6f72 6967      PMin0 = orig
+000271b0: 5b30 5d20 2b20 6b50 4d69 6e20 2a20 6469  [0] + kPMin * di
+000271c0: 7276 5b30 5d0a 2020 2020 2020 2020 2020  rv[0].          
+000271d0: 2020 504d 696e 3120 3d20 6f72 6967 5b31    PMin1 = orig[1
+000271e0: 5d20 2b20 6b50 4d69 6e20 2a20 6469 7276  ] + kPMin * dirv
+000271f0: 5b31 5d0a 2020 2020 2020 2020 2020 2020  [1].            
+00027200: 504d 696e 3220 3d20 6f72 6967 5b32 5d20  PMin2 = orig[2] 
+00027210: 2b20 6b50 4d69 6e20 2a20 6469 7276 5b32  + kPMin * dirv[2
+00027220: 5d0a 2020 2020 2020 2020 2020 2020 6c6f  ].            lo
+00027230: 735f 636c 6f73 6573 745f 636f 6f72 6473  s_closest_coords
+00027240: 5b30 2c20 696e 645f 6c6f 735d 203d 2050  [0, ind_los] = P
+00027250: 4d69 6e30 0a20 2020 2020 2020 2020 2020  Min0.           
+00027260: 206c 6f73 5f63 6c6f 7365 7374 5f63 6f6f   los_closest_coo
+00027270: 7264 735b 312c 2069 6e64 5f6c 6f73 5d20  rds[1, ind_los] 
+00027280: 3d20 504d 696e 310a 2020 2020 2020 2020  = PMin1.        
+00027290: 2020 2020 6c6f 735f 636c 6f73 6573 745f      los_closest_
+000272a0: 636f 6f72 6473 5b32 2c20 696e 645f 6c6f  coords[2, ind_lo
+000272b0: 735d 203d 2050 4d69 6e32 0a20 2020 2020  s] = PMin2.     
+000272c0: 2020 2020 2020 2023 2043 6f6d 7075 7469         # Computi
+000272d0: 6e67 2052 4d69 6e3a 0a20 2020 2020 2020  ng RMin:.       
+000272e0: 2020 2020 2050 4d69 6e32 6e6f 726d 203d       PMin2norm =
+000272f0: 2063 5f73 7172 7428 504d 696e 302a 2a32   c_sqrt(PMin0**2
+00027300: 2b50 4d69 6e31 2a2a 3229 0a20 2020 2020  +PMin1**2).     
+00027310: 2020 2020 2020 2063 6972 636c 655f 636c         circle_cl
+00027320: 6f73 6573 745f 726d 696e 5b69 6e64 5f6c  osest_rmin[ind_l
+00027330: 6f73 5d20 3d20 635f 7371 7274 2828 504d  os] = c_sqrt((PM
+00027340: 696e 326e 6f72 6d20 2d20 6369 7263 5f72  in2norm - circ_r
+00027350: 6164 6975 7329 2a2a 320a 2020 2020 2020  adius)**2.      
+00027360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027380: 2020 2b20 2850 4d69 6e32 2020 202d 2063    + (PMin2   - c
+00027390: 6972 635f 6e6f 726d 7a29 2a2a 3229 0a20  irc_normz)**2). 
+000273a0: 2020 2020 2020 2020 2020 2023 2054 6865             # The
+000273b0: 7461 2061 6e64 2049 6d70 5468 6574 613a  ta and ImpTheta:
+000273c0: 0a20 2020 2020 2020 2020 2020 2076 5030  .            vP0
+000273d0: 203d 2050 4d69 6e32 6e6f 726d 202d 2063   = PMin2norm - c
+000273e0: 6972 635f 7261 6469 7573 0a20 2020 2020  irc_radius.     
+000273f0: 2020 2020 2020 2076 5031 203d 2050 4d69         vP1 = PMi
+00027400: 6e32 2020 2020 202d 2063 6972 635f 6e6f  n2     - circ_no
+00027410: 726d 7a0a 2020 2020 2020 2020 2020 2020  rmz.            
+00027420: 5468 6574 6120 3d20 635f 6174 616e 3228  Theta = c_atan2(
+00027430: 7650 312c 2076 5030 290a 2020 2020 2020  vP1, vP0).      
+00027440: 2020 2020 2020 6369 7263 6c65 5f63 6c6f        circle_clo
+00027450: 7365 7374 5f74 6865 7461 5b69 6e64 5f6c  sest_theta[ind_l
+00027460: 6f73 5d20 3d20 5468 6574 610a 2020 2020  os] = Theta.    
+00027470: 2020 2020 2020 2020 6966 2054 6865 7461          if Theta
+00027480: 203c 2030 3a0a 2020 2020 2020 2020 2020   < 0:.          
+00027490: 2020 2020 2020 5468 6574 6120 3d20 5468        Theta = Th
+000274a0: 6574 6120 2b20 635f 7069 0a20 2020 2020  eta + c_pi.     
+000274b0: 2020 2020 2020 2063 6972 636c 655f 636c         circle_cl
+000274c0: 6f73 6573 745f 696d 7074 6865 7461 5b69  osest_imptheta[i
+000274d0: 6e64 5f6c 6f73 5d20 3d20 5468 6574 610a  nd_los] = Theta.
+000274e0: 2020 2020 2020 2020 2020 2020 6369 7263              circ
+000274f0: 6c65 5f63 6c6f 7365 7374 5f70 5b69 6e64  le_closest_p[ind
+00027500: 5f6c 6f73 5d20 3d20 7650 3020 2a20 635f  _los] = vP0 * c_
+00027510: 636f 7328 5468 6574 6129 202b 2076 5031  cos(Theta) + vP1
+00027520: 202a 2063 5f73 696e 2854 6865 7461 290a   * c_sin(Theta).
+00027530: 2020 2020 2020 2020 2020 2020 2320 5068              # Ph
+00027540: 693a 0a20 2020 2020 2020 2020 2020 2065  i:.            e
+00027550: 5468 6574 6130 203d 202d 2050 4d69 6e31  Theta0 = - PMin1
+00027560: 202f 2050 4d69 6e32 6e6f 726d 0a20 2020   / PMin2norm.   
+00027570: 2020 2020 2020 2020 2065 5468 6574 6131           eTheta1
+00027580: 203d 2020 2050 4d69 6e30 202f 2050 4d69   =   PMin0 / PMi
+00027590: 6e32 6e6f 726d 0a20 2020 2020 2020 2020  n2norm.         
+000275a0: 2020 206e 6f72 6d75 3020 3d20 6469 7276     normu0 = dirv
+000275b0: 5b30 5d2f 6e6f 726d 750a 2020 2020 2020  [0]/normu.      
+000275c0: 2020 2020 2020 6e6f 726d 7531 203d 2064        normu1 = d
+000275d0: 6972 765b 315d 2f6e 6f72 6d75 0a20 2020  irv[1]/normu.   
+000275e0: 2020 2020 2020 2020 2063 6972 636c 655f           circle_
+000275f0: 636c 6f73 6573 745f 7068 695b 696e 645f  closest_phi[ind_
+00027600: 6c6f 735d 203d 2063 5f61 7369 6e28 2d6e  los] = c_asin(-n
+00027610: 6f72 6d75 3020 2a20 6554 6865 7461 3020  ormu0 * eTheta0 
+00027620: 2d20 6e6f 726d 7531 202a 2065 5468 6574  - normu1 * eThet
+00027630: 6131 290a 2020 2020 2020 2020 6672 6565  a1).        free
+00027640: 2864 6972 7629 0a20 2020 2020 2020 2066  (dirv).        f
+00027650: 7265 6528 6f72 6967 290a 2020 2020 2020  ree(orig).      
+00027660: 2020 6672 6565 2872 6573 290a 2020 2020    free(res).    
+00027670: 7265 7475 726e 0a0a 0a0a 6364 6566 204c  return....cdef L
+00027680: 4f53 5f73 696e 6f5f 4c69 6e28 646f 7562  OS_sino_Lin(doub
+00027690: 6c65 2044 302c 2064 6f75 626c 6520 4431  le D0, double D1
+000276a0: 2c20 646f 7562 6c65 2044 322c 2064 6f75  , double D2, dou
+000276b0: 626c 6520 7530 2c20 646f 7562 6c65 2075  ble u0, double u
+000276c0: 312c 2064 6f75 626c 650a 2020 2020 2020  1, double.      
+000276d0: 2020 2020 2020 2020 2020 2020 7532 2c20              u2, 
+000276e0: 646f 7562 6c65 2052 5a30 2c20 646f 7562  double RZ0, doub
+000276f0: 6c65 2052 5a31 2c20 7374 7220 4d6f 6465  le RZ1, str Mode
+00027700: 3d27 4c4f 5327 2c0a 2020 2020 2020 2020  ='LOS',.        
+00027710: 2020 2020 2020 2020 2020 646f 7562 6c65            double
+00027720: 206b 4f75 743d 435f 494e 4629 3a0a 2020   kOut=C_INF):.  
+00027730: 2020 6364 6566 2064 6f75 626c 6520 2020    cdef double   
+00027740: 206b 504d 696e 0a20 2020 2069 6620 7530   kPMin.    if u0
+00027750: 2a2a 323d 3d31 2e3a 0a20 2020 2020 2020  **2==1.:.       
+00027760: 206b 504d 696e 203d 2030 2e0a 2020 2020   kPMin = 0..    
+00027770: 656c 7365 3a0a 2020 2020 2020 2020 6b50  else:.        kP
+00027780: 4d69 6e20 3d20 2820 2852 5a30 2d44 3129  Min = ( (RZ0-D1)
+00027790: 2a75 312b 2852 5a31 2d44 3229 2a75 3220  *u1+(RZ1-D2)*u2 
+000277a0: 2920 2f20 2831 2d75 302a 2a32 290a 2020  ) / (1-u0**2).  
+000277b0: 2020 6b50 4d69 6e20 3d20 6b4f 7574 2069    kPMin = kOut i
+000277c0: 6620 4d6f 6465 3d3d 274c 4f53 2720 616e  f Mode=='LOS' an
+000277d0: 6420 6b50 4d69 6e20 3e20 6b4f 7574 2065  d kPMin > kOut e
+000277e0: 6c73 6520 6b50 4d69 6e0a 2020 2020 6364  lse kPMin.    cd
+000277f0: 6566 2064 6f75 626c 6520 2020 2050 4d69  ef double    PMi
+00027800: 6e30 203d 2044 302b 6b50 4d69 6e2a 7530  n0 = D0+kPMin*u0
+00027810: 2c20 504d 696e 3120 3d20 4431 2b6b 504d  , PMin1 = D1+kPM
+00027820: 696e 2a75 312c 2050 4d69 6e32 203d 2044  in*u1, PMin2 = D
+00027830: 322b 6b50 4d69 6e2a 7532 0a20 2020 2063  2+kPMin*u2.    c
+00027840: 6465 6620 646f 7562 6c65 2020 2020 524d  def double    RM
+00027850: 696e 203d 2063 5f73 7172 7428 2850 4d69  in = c_sqrt((PMi
+00027860: 6e31 2d52 5a30 292a 2a32 2b28 504d 696e  n1-RZ0)**2+(PMin
+00027870: 322d 525a 3129 2a2a 3229 0a20 2020 2063  2-RZ1)**2).    c
+00027880: 6465 6620 646f 7562 6c65 2020 2020 7650  def double    vP
+00027890: 3020 3d20 504d 696e 312d 525a 302c 2076  0 = PMin1-RZ0, v
+000278a0: 5031 203d 2050 4d69 6e32 2d52 5a31 0a20  P1 = PMin2-RZ1. 
+000278b0: 2020 2063 6465 6620 646f 7562 6c65 2020     cdef double  
+000278c0: 2020 5468 6574 6120 3d20 635f 6174 616e    Theta = c_atan
+000278d0: 3228 7650 312c 7650 3029 0a20 2020 2063  2(vP1,vP0).    c
+000278e0: 6465 6620 646f 7562 6c65 2020 2020 496d  def double    Im
+000278f0: 7054 6865 7461 203d 2054 6865 7461 2069  pTheta = Theta i
+00027900: 6620 5468 6574 613e 3d30 2065 6c73 6520  f Theta>=0 else 
+00027910: 5468 6574 6120 2b20 6e70 2e70 690a 2020  Theta + np.pi.  
+00027920: 2020 6364 6566 2064 6f75 626c 6520 2020    cdef double   
+00027930: 2065 7232 4430 203d 2063 5f63 6f73 2849   er2D0 = c_cos(I
+00027940: 6d70 5468 6574 6129 2c20 6572 3244 3120  mpTheta), er2D1 
+00027950: 3d20 635f 7369 6e28 496d 7054 6865 7461  = c_sin(ImpTheta
+00027960: 290a 2020 2020 6364 6566 2064 6f75 626c  ).    cdef doubl
+00027970: 6520 2020 2070 3020 3d20 7650 302a 6572  e    p0 = vP0*er
+00027980: 3244 3020 2b20 7650 312a 6572 3244 310a  2D0 + vP1*er2D1.
+00027990: 2020 2020 6364 6566 2064 6f75 626c 6520      cdef double 
+000279a0: 2020 2075 4e20 3d20 635f 7371 7274 2875     uN = c_sqrt(u
+000279b0: 302a 2a32 2b75 312a 2a32 2b75 322a 2a32  0**2+u1**2+u2**2
+000279c0: 290a 2020 2020 6364 6566 2064 6f75 626c  ).    cdef doubl
+000279d0: 6520 2020 2075 4e30 203d 2075 302f 754e  e    uN0 = u0/uN
+000279e0: 2c20 754e 3120 3d20 7531 2f75 4e2c 2075  , uN1 = u1/uN, u
+000279f0: 4e32 203d 2075 322f 754e 0a20 2020 2063  N2 = u2/uN.    c
+00027a00: 6465 6620 646f 7562 6c65 2020 2020 7068  def double    ph
+00027a10: 6920 3d20 635f 6174 616e 3228 754e 302c  i = c_atan2(uN0,
+00027a20: 2063 5f73 7172 7428 754e 312a 2a32 2b75   c_sqrt(uN1**2+u
+00027a30: 4e32 2a2a 3229 290a 2020 2020 7265 7475  N2**2)).    retu
+00027a40: 726e 2028 504d 696e 302c 504d 696e 312c  rn (PMin0,PMin1,
+00027a50: 504d 696e 3229 2c20 6b50 4d69 6e2c 2052  PMin2), kPMin, R
+00027a60: 4d69 6e2c 2054 6865 7461 2c20 7030 2c20  Min, Theta, p0, 
+00027a70: 496d 7054 6865 7461 2c20 7068 690a 0a0a  ImpTheta, phi...
+00027a80: 6465 6620 4c4f 535f 7369 6e6f 2864 6f75  def LOS_sino(dou
+00027a90: 626c 655b 3a2c 3a3a 315d 2044 2c20 646f  ble[:,::1] D, do
+00027aa0: 7562 6c65 5b3a 2c3a 3a31 5d20 752c 2064  uble[:,::1] u, d
+00027ab0: 6f75 626c 655b 3a3a 315d 2052 5a2c 2064  ouble[::1] RZ, d
+00027ac0: 6f75 626c 655b 3a3a 315d 206b 4f75 742c  ouble[::1] kOut,
+00027ad0: 0a20 2020 2020 2020 2020 2020 2020 7374  .             st
+00027ae0: 7220 4d6f 6465 3d27 4c4f 5327 2c20 7374  r Mode='LOS', st
+00027af0: 7220 5654 7970 653d 2754 6f72 272c 2062  r VType='Tor', b
+00027b00: 696e 7420 7472 795f 6e65 775f 616c 676f  int try_new_algo
+00027b10: 3d54 7275 6529 3a0a 2020 2020 6364 6566  =True):.    cdef
+00027b20: 2075 6e73 6967 6e65 6420 696e 7420 6e4c   unsigned int nL
+00027b30: 203d 2044 2e73 6861 7065 5b31 5d2c 2069   = D.shape[1], i
+00027b40: 690a 2020 2020 6364 6566 2074 7570 6c65  i.    cdef tuple
+00027b50: 206f 7574 0a20 2020 2063 6465 6620 6e70   out.    cdef np
+00027b60: 2e6e 6461 7272 6179 5b64 6f75 626c 652c  .ndarray[double,
+00027b70: 6e64 696d 3d32 5d20 504d 696e 203d 206e  ndim=2] PMin = n
+00027b80: 702e 656d 7074 7928 2833 2c6e 4c29 290a  p.empty((3,nL)).
+00027b90: 2020 2020 6364 6566 206e 702e 6e64 6172      cdef np.ndar
+00027ba0: 7261 795b 646f 7562 6c65 2c6e 6469 6d3d  ray[double,ndim=
+00027bb0: 315d 206b 504d 696e 3d6e 702e 656d 7074  1] kPMin=np.empt
+00027bc0: 7928 286e 4c2c 2929 2c20 524d 696e 3d6e  y((nL,)), RMin=n
+00027bd0: 702e 656d 7074 7928 286e 4c2c 2929 0a20  p.empty((nL,)). 
+00027be0: 2020 2063 6465 6620 6e70 2e6e 6461 7272     cdef np.ndarr
+00027bf0: 6179 5b64 6f75 626c 652c 6e64 696d 3d31  ay[double,ndim=1
+00027c00: 5d20 5468 6574 613d 6e70 2e65 6d70 7479  ] Theta=np.empty
+00027c10: 2828 6e4c 2c29 292c 2070 3d6e 702e 656d  ((nL,)), p=np.em
+00027c20: 7074 7928 286e 4c2c 2929 0a20 2020 2063  pty((nL,)).    c
+00027c30: 6465 6620 6e70 2e6e 6461 7272 6179 5b64  def np.ndarray[d
+00027c40: 6f75 626c 652c 6e64 696d 3d31 5d20 496d  ouble,ndim=1] Im
+00027c50: 7054 6865 7461 3d6e 702e 656d 7074 7928  pTheta=np.empty(
+00027c60: 286e 4c2c 2929 2c20 7068 693d 6e70 2e65  (nL,)), phi=np.e
+00027c70: 6d70 7479 2828 6e4c 2c29 290a 2020 2020  mpty((nL,)).    
+00027c80: 6364 6566 2064 6f75 626c 655b 395d 2072  cdef double[9] r
+00027c90: 6573 756c 7473 0a20 2020 2063 6465 6620  esults.    cdef 
+00027ca0: 6269 6e74 2069 735f 4c4f 535f 4d6f 6465  bint is_LOS_Mode
+00027cb0: 0a20 2020 2069 6620 5654 7970 652e 6c6f  .    if VType.lo
+00027cc0: 7765 7228 293d 3d27 746f 7227 3a0a 2020  wer()=='tor':.  
+00027cd0: 2020 2020 2020 6966 206e 6f74 2074 7279        if not try
+00027ce0: 5f6e 6577 5f61 6c67 6f3a 0a20 2020 2020  _new_algo:.     
+00027cf0: 2020 2020 2020 2066 6f72 2069 6920 696e         for ii in
+00027d00: 2072 616e 6765 2830 2c6e 4c29 3a0a 2020   range(0,nL):.  
+00027d10: 2020 2020 2020 2020 2020 2020 2020 6f75                ou
+00027d20: 7420 3d20 4c4f 535f 7369 6e6f 5f54 6f72  t = LOS_sino_Tor
+00027d30: 2844 5b30 2c69 695d 2c44 5b31 2c69 695d  (D[0,ii],D[1,ii]
+00027d40: 2c44 5b32 2c69 695d 2c0a 2020 2020 2020  ,D[2,ii],.      
+00027d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027d60: 2020 2020 2020 2020 2020 2020 2075 5b30               u[0
+00027d70: 2c69 695d 2c75 5b31 2c69 695d 2c75 5b32  ,ii],u[1,ii],u[2
+00027d80: 2c69 695d 2c0a 2020 2020 2020 2020 2020  ,ii],.          
+00027d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027da0: 2020 2020 2020 2020 2052 5a5b 305d 2c52           RZ[0],R
+00027db0: 5a5b 315d 2c20 4d6f 6465 3d4d 6f64 652c  Z[1], Mode=Mode,
+00027dc0: 206b 4f75 743d 6b4f 7574 5b69 695d 290a   kOut=kOut[ii]).
+00027dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027de0: 2828 504d 696e 5b30 2c69 695d 2c50 4d69  ((PMin[0,ii],PMi
+00027df0: 6e5b 312c 6969 5d2c 504d 696e 5b32 2c69  n[1,ii],PMin[2,i
+00027e00: 695d 292c 0a20 2020 2020 2020 2020 2020  i]),.           
+00027e10: 2020 2020 2020 6b50 4d69 6e5b 6969 5d2c        kPMin[ii],
+00027e20: 2052 4d69 6e5b 6969 5d2c 2054 6865 7461   RMin[ii], Theta
+00027e30: 5b69 695d 2c0a 2020 2020 2020 2020 2020  [ii],.          
+00027e40: 2020 2020 2020 2070 5b69 695d 2c20 496d         p[ii], Im
+00027e50: 7054 6865 7461 5b69 695d 2c20 7068 695b  pTheta[ii], phi[
+00027e60: 6969 5d29 203d 206f 7574 0a20 2020 2020  ii]) = out.     
+00027e70: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00027e80: 2020 2020 2069 735f 4c4f 535f 4d6f 6465       is_LOS_Mode
+00027e90: 203d 204d 6f64 652e 6c6f 7765 7228 2920   = Mode.lower() 
+00027ea0: 3d3d 2027 6c6f 7327 0a20 2020 2020 2020  == 'los'.       
+00027eb0: 2020 2020 204e 4557 5f6c 6f73 5f73 696e       NEW_los_sin
+00027ec0: 6f5f 746f 725f 7665 6328 6e4c 2c20 442c  o_tor_vec(nL, D,
+00027ed0: 2075 2c20 525a 5b30 5d2c 2052 5a5b 315d   u, RZ[0], RZ[1]
+00027ee0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00027ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027f00: 2020 2050 4d69 6e2c 206b 504d 696e 2c20     PMin, kPMin, 
+00027f10: 524d 696e 2c20 5468 6574 612c 2070 2c0a  RMin, Theta, p,.
+00027f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00027f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027f40: 2020 6973 5f4c 4f53 5f4d 6f64 653d 6973    is_LOS_Mode=is
-00027f50: 5f4c 4f53 5f4d 6f64 652c 0a20 2020 2020  _LOS_Mode,.     
+00027f40: 2049 6d70 5468 6574 612c 2070 6869 2c0a   ImpTheta, phi,.
+00027f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00027f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027f70: 2020 2020 2020 2020 2020 2020 6b4f 7574              kOut
-00027f80: 3d6b 4f75 7429 0a20 2020 2065 6c73 653a  =kOut).    else:
-00027f90: 0a20 2020 2020 2020 2066 6f72 2069 6920  .        for ii 
-00027fa0: 696e 2072 616e 6765 2830 2c6e 4c29 3a0a  in range(0,nL):.
-00027fb0: 2020 2020 2020 2020 2020 2020 6f75 7420              out 
-00027fc0: 3d20 4c4f 535f 7369 6e6f 5f4c 696e 2844  = LOS_sino_Lin(D
-00027fd0: 5b30 2c69 695d 2c44 5b31 2c69 695d 2c44  [0,ii],D[1,ii],D
-00027fe0: 5b32 2c69 695d 2c75 5b30 2c69 695d 2c75  [2,ii],u[0,ii],u
-00027ff0: 5b31 2c69 695d 2c75 5b32 2c69 695d 2c0a  [1,ii],u[2,ii],.
-00028000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028010: 2020 2020 2020 2020 2020 2020 2020 2052                 R
-00028020: 5a5b 305d 2c52 5a5b 315d 2c20 4d6f 6465  Z[0],RZ[1], Mode
-00028030: 3d4d 6f64 652c 206b 4f75 743d 6b4f 7574  =Mode, kOut=kOut
-00028040: 5b69 695d 290a 2020 2020 2020 2020 2020  [ii]).          
-00028050: 2020 2828 504d 696e 5b30 2c69 695d 2c50    ((PMin[0,ii],P
-00028060: 4d69 6e5b 312c 6969 5d2c 504d 696e 5b32  Min[1,ii],PMin[2
-00028070: 2c69 695d 292c 0a20 2020 2020 2020 2020  ,ii]),.         
-00028080: 2020 2020 6b50 4d69 6e5b 6969 5d2c 2052      kPMin[ii], R
-00028090: 4d69 6e5b 6969 5d2c 2054 6865 7461 5b69  Min[ii], Theta[i
-000280a0: 695d 2c20 705b 6969 5d2c 2049 6d70 5468  i], p[ii], ImpTh
-000280b0: 6574 615b 6969 5d2c 2070 6869 5b69 695d  eta[ii], phi[ii]
-000280c0: 2920 3d20 6f75 740a 2020 2020 7265 7475  ) = out.    retu
-000280d0: 726e 2050 4d69 6e2c 206b 504d 696e 2c20  rn PMin, kPMin, 
-000280e0: 524d 696e 2c20 5468 6574 612c 2070 2c20  RMin, Theta, p, 
-000280f0: 496d 7054 6865 7461 2c20 7068 690a 0a0a  ImpTheta, phi...
-00028100: 0a0a 0a0a 0a0a 2323 2323 2323 2323 2323  ......##########
-00028110: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00028120: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00028130: 2323 2323 2323 2323 2323 2323 2323 0a23  ##############.#
+00027f70: 2069 735f 4c4f 535f 4d6f 6465 3d69 735f   is_LOS_Mode=is_
+00027f80: 4c4f 535f 4d6f 6465 2c0a 2020 2020 2020  LOS_Mode,.      
+00027f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027fa0: 2020 2020 2020 2020 2020 206b 4f75 743d             kOut=
+00027fb0: 6b4f 7574 290a 2020 2020 656c 7365 3a0a  kOut).    else:.
+00027fc0: 2020 2020 2020 2020 666f 7220 6969 2069          for ii i
+00027fd0: 6e20 7261 6e67 6528 302c 6e4c 293a 0a20  n range(0,nL):. 
+00027fe0: 2020 2020 2020 2020 2020 206f 7574 203d             out =
+00027ff0: 204c 4f53 5f73 696e 6f5f 4c69 6e28 445b   LOS_sino_Lin(D[
+00028000: 302c 6969 5d2c 445b 312c 6969 5d2c 445b  0,ii],D[1,ii],D[
+00028010: 322c 6969 5d2c 755b 302c 6969 5d2c 755b  2,ii],u[0,ii],u[
+00028020: 312c 6969 5d2c 755b 322c 6969 5d2c 0a20  1,ii],u[2,ii],. 
+00028030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028040: 2020 2020 2020 2020 2020 2020 2020 525a                RZ
+00028050: 5b30 5d2c 525a 5b31 5d2c 204d 6f64 653d  [0],RZ[1], Mode=
+00028060: 4d6f 6465 2c20 6b4f 7574 3d6b 4f75 745b  Mode, kOut=kOut[
+00028070: 6969 5d29 0a20 2020 2020 2020 2020 2020  ii]).           
+00028080: 2028 2850 4d69 6e5b 302c 6969 5d2c 504d   ((PMin[0,ii],PM
+00028090: 696e 5b31 2c69 695d 2c50 4d69 6e5b 322c  in[1,ii],PMin[2,
+000280a0: 6969 5d29 2c0a 2020 2020 2020 2020 2020  ii]),.          
+000280b0: 2020 206b 504d 696e 5b69 695d 2c20 524d     kPMin[ii], RM
+000280c0: 696e 5b69 695d 2c20 5468 6574 615b 6969  in[ii], Theta[ii
+000280d0: 5d2c 2070 5b69 695d 2c20 496d 7054 6865  ], p[ii], ImpThe
+000280e0: 7461 5b69 695d 2c20 7068 695b 6969 5d29  ta[ii], phi[ii])
+000280f0: 203d 206f 7574 0a20 2020 2072 6574 7572   = out.    retur
+00028100: 6e20 504d 696e 2c20 6b50 4d69 6e2c 2052  n PMin, kPMin, R
+00028110: 4d69 6e2c 2054 6865 7461 2c20 702c 2049  Min, Theta, p, I
+00028120: 6d70 5468 6574 612c 2070 6869 0a0a 0a0a  mpTheta, phi....
+00028130: 0a0a 0a0a 0a23 2323 2323 2323 2323 2323  .....###########
 00028140: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00028150: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00028160: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00028170: 2323 2323 2323 230a 2323 2323 2323 2323  #######.########
+00028160: 2323 2323 2323 2323 2323 2323 230a 2323  #############.##
+00028170: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00028180: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00028190: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000281a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000281b0: 0a23 2020 2020 2020 2020 2020 2020 2020  .#              
-000281c0: 2020 2020 2053 6f6c 6964 2041 6e67 6c65       Solid Angle
-000281d0: 0a23 2323 2323 2323 2323 2323 2323 2323  .###############
-000281e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000281f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00028200: 2323 2323 2323 2323 230a 2323 2323 2323  #########.######
+000281a0: 2323 2323 2323 0a23 2323 2323 2323 2323  ######.#########
+000281b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000281c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000281d0: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
+000281e0: 2320 2020 2020 2020 2020 2020 2020 2020  #               
+000281f0: 2020 2020 536f 6c69 6420 416e 676c 650a      Solid Angle.
+00028200: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00028210: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00028220: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00028230: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00028240: 2323 0a23 2323 2323 2323 2323 2323 2323  ##.#############
+00028230: 2323 2323 2323 2323 0a23 2323 2323 2323  ########.#######
+00028240: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00028250: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00028260: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00028270: 2323 2323 2323 2323 2323 230a 0a0a 2323  ###########...##
+00028270: 230a 2323 2323 2323 2323 2323 2323 2323  #.##############
 00028280: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00028290: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000282a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000282b0: 2323 2323 0a23 2323 2323 2323 2323 2323  ####.###########
+000282a0: 2323 2323 2323 2323 2323 0a0a 0a23 2323  ##########...###
+000282b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 000282c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 000282d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000282e0: 2323 2323 2323 2323 2323 230a 2320 2020  ###########.#   
-000282f0: 2020 2020 2020 2020 2020 2020 4475 7374              Dust
-00028300: 0a23 2323 2323 2323 2323 2323 2323 2323  .###############
-00028310: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00028320: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00028330: 2323 2323 2323 230a 2323 2323 2323 2323  #######.########
+000282e0: 2323 230a 2323 2323 2323 2323 2323 2323  ###.############
+000282f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00028300: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00028310: 2323 2323 2323 2323 2323 0a23 2020 2020  ##########.#    
+00028320: 2020 2020 2020 2020 2020 2044 7573 740a             Dust.
+00028330: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00028340: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00028350: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00028360: 2323 2323 2323 2323 2323 2323 2323 0a0a  ##############..
-00028370: 6465 6620 4475 7374 5f63 616c 635f 536f  def Dust_calc_So
-00028380: 6c69 6441 6e67 6c65 280a 2020 2020 706f  lidAngle(.    po
-00028390: 732c 2072 2c20 7074 732c 0a20 2020 2061  s, r, pts,.    a
-000283a0: 7070 726f 783d 5472 7565 2c0a 2020 2020  pprox=True,.    
-000283b0: 6f75 745f 636f 6566 6f6e 6c79 3d46 616c  out_coefonly=Fal
-000283c0: 7365 2c0a 2020 2020 5654 7970 653d 2754  se,.    VType='T
-000283d0: 6f72 272c 0a20 2020 2056 506f 6c79 3d4e  or',.    VPoly=N
-000283e0: 6f6e 652c 0a20 2020 2056 496e 3d4e 6f6e  one,.    VIn=Non
-000283f0: 652c 0a20 2020 2056 4c69 6d3d 4e6f 6e65  e,.    VLim=None
-00028400: 2c0a 2020 2020 4c53 506f 6c79 3d4e 6f6e  ,.    LSPoly=Non
-00028410: 652c 0a20 2020 204c 534c 696d 3d4e 6f6e  e,.    LSLim=Non
-00028420: 652c 0a20 2020 204c 5356 496e 3d4e 6f6e  e,.    LSVIn=Non
-00028430: 652c 0a20 2020 2046 6f72 6269 643d 5472  e,.    Forbid=Tr
-00028440: 7565 2c0a 2020 2020 5465 7374 3d54 7275  ue,.    Test=Tru
-00028450: 652c 0a29 3a0a 2020 2020 2222 2220 436f  e,.):.    """ Co
-00028460: 6d70 7574 6520 7468 6520 736f 6c69 6420  mpute the solid 
-00028470: 616e 676c 6520 6f66 2061 206d 6f76 696e  angle of a movin
-00028480: 6720 7061 7274 6963 6c65 206f 6620 7661  g particle of va
-00028490: 7279 696e 6720 7261 6469 7573 2061 7320  rying radius as 
-000284a0: 7365 656e 0a20 2020 2066 726f 6d20 616e  seen.    from an
-000284b0: 7920 6e75 6d62 6572 206f 6620 7069 7865  y number of pixe
-000284c0: 6420 706f 696e 7473 0a0a 2020 2020 4361  d points..    Ca
-000284d0: 6e20 6265 2064 6f6e 6520 772f 6f20 7468  n be done w/o th
-000284e0: 6520 6170 7072 6f78 696d 6174 696f 6e20  e approximation 
-000284f0: 7468 6174 2072 3c3c 640a 2020 2020 4966  that r<<d.    If
-00028500: 2056 6573 2028 616e 6420 6f70 7469 6f6e   Ves (and option
-00028510: 616c 6c79 204c 5350 6f6c 7929 2061 7265  ally LSPoly) are
-00028520: 2070 726f 7669 6465 642c 2074 616b 6573   provided, takes
-00028530: 2069 6e74 6f20 6163 636f 756e 7420 7669   into account vi
-00028540: 676e 6574 7469 6e67 0a20 2020 2022 2222  gnetting.    """
-00028550: 0a20 2020 2063 6465 6620 626c 6f63 6b20  .    cdef block 
-00028560: 3d20 5650 6f6c 7920 6973 206e 6f74 204e  = VPoly is not N
-00028570: 6f6e 650a 2020 2020 6364 6566 2066 6c6f  one.    cdef flo
-00028580: 6174 2070 6972 320a 2020 2020 6364 6566  at pir2.    cdef
-00028590: 2069 6e74 2069 692c 206a 6a2c 206e 7074   int ii, jj, npt
-000285a0: 736f 6b2c 206e 743d 706f 732e 7368 6170  sok, nt=pos.shap
-000285b0: 655b 315d 2c20 6e70 7473 3d70 7473 2e73  e[1], npts=pts.s
-000285c0: 6861 7065 5b31 5d0a 2020 2020 6364 6566  hape[1].    cdef
-000285d0: 206e 702e 6e64 6172 7261 795b 646f 7562   np.ndarray[doub
-000285e0: 6c65 2c20 6e64 696d 3d32 2c20 6d6f 6465  le, ndim=2, mode
-000285f0: 3d27 6327 5d20 7361 6e67 3d6e 702e 7a65  ='c'] sang=np.ze
-00028600: 726f 7328 286e 742c 6e70 7473 2929 0a20  ros((nt,npts)). 
-00028610: 2020 2063 6465 6620 6172 7261 7920 6b0a     cdef array k.
-00028620: 2020 2020 6364 6566 206e 702e 6e64 6172      cdef np.ndar
-00028630: 7261 795b 646f 7562 6c65 2c20 6e64 696d  ray[double, ndim
-00028640: 3d31 2c20 6d6f 6465 3d27 6327 5d20 7669  =1, mode='c'] vi
-00028650: 730a 2020 2020 6364 6566 2064 6f75 626c  s.    cdef doubl
-00028660: 655b 3a3a 315d 206b 5f76 6965 770a 2020  e[::1] k_view.  
-00028670: 2020 6364 6566 2064 6f75 626c 655b 3a3a    cdef double[::
-00028680: 315d 206c 7370 6f6c 7978 2c20 6c73 706f  1] lspolyx, lspo
-00028690: 6c79 790a 2020 2020 6364 6566 2064 6f75  lyy.    cdef dou
-000286a0: 626c 655b 3a3a 315d 206c 736e 6f72 6d78  ble[::1] lsnormx
-000286b0: 2c20 6c73 6e6f 726d 790a 2020 2020 6966  , lsnormy.    if
-000286c0: 2062 6c6f 636b 3a0a 2020 2020 2020 2020   block:.        
-000286d0: 696e 6420 3d20 7e5f 5665 735f 6973 496e  ind = ~_Ves_isIn
-000286e0: 7369 6465 2870 7473 2c20 5650 6f6c 792c  side(pts, VPoly,
-000286f0: 2076 6573 5f6c 696d 733d 564c 696d 2c20   ves_lims=VLim, 
-00028700: 7665 735f 7479 7065 3d56 5479 7065 2c0a  ves_type=VType,.
-00028710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028720: 2020 2020 2020 2020 2020 2020 2069 6e5f               in_
-00028730: 666f 726d 6174 3d27 2858 2c59 2c5a 2927  format='(X,Y,Z)'
-00028740: 2c20 7465 7374 3d54 6573 7429 0a20 2020  , test=Test).   
-00028750: 2020 2020 2069 6620 4c53 506f 6c79 2069       if LSPoly i
-00028760: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00028770: 2020 2020 2020 2020 666f 7220 6969 2069          for ii i
-00028780: 6e20 7261 6e67 6528 6c65 6e28 4c53 506f  n range(len(LSPo
-00028790: 6c79 2929 3a0a 2020 2020 2020 2020 2020  ly)):.          
-000287a0: 2020 2020 2020 696e 6420 3d20 696e 6420        ind = ind 
-000287b0: 2620 5f56 6573 5f69 7349 6e73 6964 6528  & _Ves_isInside(
-000287c0: 7074 732c 204c 5350 6f6c 795b 6969 5d2c  pts, LSPoly[ii],
-000287d0: 2076 6573 5f6c 696d 733d 4c53 4c69 6d5b   ves_lims=LSLim[
-000287e0: 6969 5d2c 0a20 2020 2020 2020 2020 2020  ii],.           
-000287f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028800: 2020 2020 2020 2020 2020 2020 2020 2076                 v
-00028810: 6573 5f74 7970 653d 5654 7970 652c 2069  es_type=VType, i
-00028820: 6e5f 666f 726d 6174 3d27 2858 2c59 2c5a  n_format='(X,Y,Z
-00028830: 2927 2c0a 2020 2020 2020 2020 2020 2020  )',.            
-00028840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028850: 2020 2020 2020 2020 2020 2020 2020 7465                te
-00028860: 7374 3d54 6573 7429 0a20 2020 2020 2020  st=Test).       
-00028870: 2020 2020 206c 7370 6f6c 7978 203d 204c       lspolyx = L
-00028880: 5350 6f6c 795b 302c 2e2e 2e5d 0a20 2020  SPoly[0,...].   
-00028890: 2020 2020 2020 2020 206c 7370 6f6c 7979           lspolyy
-000288a0: 203d 204c 5350 6f6c 795b 312c 2e2e 2e5d   = LSPoly[1,...]
-000288b0: 0a20 2020 2020 2020 2020 2020 206c 736e  .            lsn
-000288c0: 6f72 6d78 203d 204c 5356 496e 5b30 2c2e  ormx = LSVIn[0,.
-000288d0: 2e2e 5d0a 2020 2020 2020 2020 2020 2020  ..].            
-000288e0: 6c73 6e6f 726d 7920 3d20 4c53 5649 6e5b  lsnormy = LSVIn[
-000288f0: 312c 2e2e 2e5d 0a20 2020 2020 2020 2065  1,...].        e
-00028900: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00028910: 206c 7370 6f6c 7978 203d 204e 6f6e 650a   lspolyx = None.
-00028920: 2020 2020 2020 2020 2020 2020 6c73 706f              lspo
-00028930: 6c79 7920 3d20 4e6f 6e65 0a20 2020 2020  lyy = None.     
-00028940: 2020 2020 2020 206c 736e 6f72 6d78 203d         lsnormx =
-00028950: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
-00028960: 2020 6c73 6e6f 726d 7920 3d20 4e6f 6e65    lsnormy = None
-00028970: 0a20 2020 2020 2020 2069 6e64 203d 2028  .        ind = (
-00028980: 7e69 6e64 292e 6e6f 6e7a 6572 6f28 295b  ~ind).nonzero()[
-00028990: 305d 0a20 2020 2020 2020 2070 7473 7465  0].        ptste
-000289a0: 6d70 203d 206e 702e 6173 636f 6e74 6967  mp = np.ascontig
-000289b0: 756f 7573 6172 7261 7928 7074 735b 3a2c  uousarray(pts[:,
-000289c0: 696e 645d 290a 2020 2020 2020 2020 6e70  ind]).        np
-000289d0: 7473 6f6b 203d 2069 6e64 2e73 697a 650a  tsok = ind.size.
-000289e0: 2020 2020 2020 2020 6b20 3d20 636c 6f6e          k = clon
-000289f0: 6528 6172 7261 7928 2764 2729 2c20 6e70  e(array('d'), np
-00028a00: 7473 6f6b 2c20 5472 7565 290a 2020 2020  tsok, True).    
-00028a10: 2020 2020 6b5f 7669 6577 203d 206b 0a20      k_view = k. 
-00028a20: 2020 2020 2020 2069 6620 6170 7072 6f78         if approx
-00028a30: 2061 6e64 206f 7574 5f63 6f65 666f 6e6c   and out_coefonl
-00028a40: 793a 0a20 2020 2020 2020 2020 2020 2066  y:.            f
-00028a50: 6f72 2069 6920 696e 2072 616e 6765 286e  or ii in range(n
-00028a60: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
-00028a70: 2020 2020 5f62 6774 2e63 6f6d 7075 7465      _bgt.compute
-00028a80: 5f64 6973 745f 7074 5f76 6563 2870 6f73  _dist_pt_vec(pos
-00028a90: 5b30 2c69 695d 2c20 706f 735b 312c 6969  [0,ii], pos[1,ii
-00028aa0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00028ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028ac0: 2020 2020 2020 2020 2020 2020 706f 735b              pos[
-00028ad0: 322c 6969 5d2c 206e 7074 736f 6b2c 0a20  2,ii], nptsok,. 
+00028360: 2323 2323 2323 0a23 2323 2323 2323 2323  ######.#########
+00028370: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00028380: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00028390: 2323 2323 2323 2323 2323 2323 230a 0a64  #############..d
+000283a0: 6566 2044 7573 745f 6361 6c63 5f53 6f6c  ef Dust_calc_Sol
+000283b0: 6964 416e 676c 6528 0a20 2020 2070 6f73  idAngle(.    pos
+000283c0: 2c20 722c 2070 7473 2c0a 2020 2020 6170  , r, pts,.    ap
+000283d0: 7072 6f78 3d54 7275 652c 0a20 2020 206f  prox=True,.    o
+000283e0: 7574 5f63 6f65 666f 6e6c 793d 4661 6c73  ut_coefonly=Fals
+000283f0: 652c 0a20 2020 2056 5479 7065 3d27 546f  e,.    VType='To
+00028400: 7227 2c0a 2020 2020 5650 6f6c 793d 4e6f  r',.    VPoly=No
+00028410: 6e65 2c0a 2020 2020 5649 6e3d 4e6f 6e65  ne,.    VIn=None
+00028420: 2c0a 2020 2020 564c 696d 3d4e 6f6e 652c  ,.    VLim=None,
+00028430: 0a20 2020 204c 5350 6f6c 793d 4e6f 6e65  .    LSPoly=None
+00028440: 2c0a 2020 2020 4c53 4c69 6d3d 4e6f 6e65  ,.    LSLim=None
+00028450: 2c0a 2020 2020 4c53 5649 6e3d 4e6f 6e65  ,.    LSVIn=None
+00028460: 2c0a 2020 2020 466f 7262 6964 3d54 7275  ,.    Forbid=Tru
+00028470: 652c 0a20 2020 2054 6573 743d 5472 7565  e,.    Test=True
+00028480: 2c0a 293a 0a20 2020 2022 2222 2043 6f6d  ,.):.    """ Com
+00028490: 7075 7465 2074 6865 2073 6f6c 6964 2061  pute the solid a
+000284a0: 6e67 6c65 206f 6620 6120 6d6f 7669 6e67  ngle of a moving
+000284b0: 2070 6172 7469 636c 6520 6f66 2076 6172   particle of var
+000284c0: 7969 6e67 2072 6164 6975 7320 6173 2073  ying radius as s
+000284d0: 6565 6e0a 2020 2020 6672 6f6d 2061 6e79  een.    from any
+000284e0: 206e 756d 6265 7220 6f66 2070 6978 6564   number of pixed
+000284f0: 2070 6f69 6e74 730a 0a20 2020 2043 616e   points..    Can
+00028500: 2062 6520 646f 6e65 2077 2f6f 2074 6865   be done w/o the
+00028510: 2061 7070 726f 7869 6d61 7469 6f6e 2074   approximation t
+00028520: 6861 7420 723c 3c64 0a20 2020 2049 6620  hat r<<d.    If 
+00028530: 5665 7320 2861 6e64 206f 7074 696f 6e61  Ves (and optiona
+00028540: 6c6c 7920 4c53 506f 6c79 2920 6172 6520  lly LSPoly) are 
+00028550: 7072 6f76 6964 6564 2c20 7461 6b65 7320  provided, takes 
+00028560: 696e 746f 2061 6363 6f75 6e74 2076 6967  into account vig
+00028570: 6e65 7474 696e 670a 2020 2020 2222 220a  netting.    """.
+00028580: 2020 2020 6364 6566 2062 6c6f 636b 203d      cdef block =
+00028590: 2056 506f 6c79 2069 7320 6e6f 7420 4e6f   VPoly is not No
+000285a0: 6e65 0a20 2020 2063 6465 6620 666c 6f61  ne.    cdef floa
+000285b0: 7420 7069 7232 0a20 2020 2063 6465 6620  t pir2.    cdef 
+000285c0: 696e 7420 6969 2c20 6a6a 2c20 6e70 7473  int ii, jj, npts
+000285d0: 6f6b 2c20 6e74 3d70 6f73 2e73 6861 7065  ok, nt=pos.shape
+000285e0: 5b31 5d2c 206e 7074 733d 7074 732e 7368  [1], npts=pts.sh
+000285f0: 6170 655b 315d 0a20 2020 2063 6465 6620  ape[1].    cdef 
+00028600: 6e70 2e6e 6461 7272 6179 5b64 6f75 626c  np.ndarray[doubl
+00028610: 652c 206e 6469 6d3d 322c 206d 6f64 653d  e, ndim=2, mode=
+00028620: 2763 275d 2073 616e 673d 6e70 2e7a 6572  'c'] sang=np.zer
+00028630: 6f73 2828 6e74 2c6e 7074 7329 290a 2020  os((nt,npts)).  
+00028640: 2020 6364 6566 2061 7272 6179 206b 0a20    cdef array k. 
+00028650: 2020 2063 6465 6620 6e70 2e6e 6461 7272     cdef np.ndarr
+00028660: 6179 5b64 6f75 626c 652c 206e 6469 6d3d  ay[double, ndim=
+00028670: 312c 206d 6f64 653d 2763 275d 2076 6973  1, mode='c'] vis
+00028680: 0a20 2020 2063 6465 6620 646f 7562 6c65  .    cdef double
+00028690: 5b3a 3a31 5d20 6b5f 7669 6577 0a20 2020  [::1] k_view.   
+000286a0: 2063 6465 6620 646f 7562 6c65 5b3a 3a31   cdef double[::1
+000286b0: 5d20 6c73 706f 6c79 782c 206c 7370 6f6c  ] lspolyx, lspol
+000286c0: 7979 0a20 2020 2063 6465 6620 646f 7562  yy.    cdef doub
+000286d0: 6c65 5b3a 3a31 5d20 6c73 6e6f 726d 782c  le[::1] lsnormx,
+000286e0: 206c 736e 6f72 6d79 0a20 2020 2069 6620   lsnormy.    if 
+000286f0: 626c 6f63 6b3a 0a20 2020 2020 2020 2069  block:.        i
+00028700: 6e64 203d 207e 5f56 6573 5f69 7349 6e73  nd = ~_Ves_isIns
+00028710: 6964 6528 7074 732c 2056 506f 6c79 2c20  ide(pts, VPoly, 
+00028720: 7665 735f 6c69 6d73 3d56 4c69 6d2c 2076  ves_lims=VLim, v
+00028730: 6573 5f74 7970 653d 5654 7970 652c 0a20  es_type=VType,. 
+00028740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028750: 2020 2020 2020 2020 2020 2020 696e 5f66              in_f
+00028760: 6f72 6d61 743d 2728 582c 592c 5a29 272c  ormat='(X,Y,Z)',
+00028770: 2074 6573 743d 5465 7374 290a 2020 2020   test=Test).    
+00028780: 2020 2020 6966 204c 5350 6f6c 7920 6973      if LSPoly is
+00028790: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+000287a0: 2020 2020 2020 2066 6f72 2069 6920 696e         for ii in
+000287b0: 2072 616e 6765 286c 656e 284c 5350 6f6c   range(len(LSPol
+000287c0: 7929 293a 0a20 2020 2020 2020 2020 2020  y)):.           
+000287d0: 2020 2020 2069 6e64 203d 2069 6e64 2026       ind = ind &
+000287e0: 205f 5665 735f 6973 496e 7369 6465 2870   _Ves_isInside(p
+000287f0: 7473 2c20 4c53 506f 6c79 5b69 695d 2c20  ts, LSPoly[ii], 
+00028800: 7665 735f 6c69 6d73 3d4c 534c 696d 5b69  ves_lims=LSLim[i
+00028810: 695d 2c0a 2020 2020 2020 2020 2020 2020  i],.            
+00028820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028830: 2020 2020 2020 2020 2020 2020 2020 7665                ve
+00028840: 735f 7479 7065 3d56 5479 7065 2c20 696e  s_type=VType, in
+00028850: 5f66 6f72 6d61 743d 2728 582c 592c 5a29  _format='(X,Y,Z)
+00028860: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+00028870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028880: 2020 2020 2020 2020 2020 2020 2074 6573               tes
+00028890: 743d 5465 7374 290a 2020 2020 2020 2020  t=Test).        
+000288a0: 2020 2020 6c73 706f 6c79 7820 3d20 4c53      lspolyx = LS
+000288b0: 506f 6c79 5b30 2c2e 2e2e 5d0a 2020 2020  Poly[0,...].    
+000288c0: 2020 2020 2020 2020 6c73 706f 6c79 7920          lspolyy 
+000288d0: 3d20 4c53 506f 6c79 5b31 2c2e 2e2e 5d0a  = LSPoly[1,...].
+000288e0: 2020 2020 2020 2020 2020 2020 6c73 6e6f              lsno
+000288f0: 726d 7820 3d20 4c53 5649 6e5b 302c 2e2e  rmx = LSVIn[0,..
+00028900: 2e5d 0a20 2020 2020 2020 2020 2020 206c  .].            l
+00028910: 736e 6f72 6d79 203d 204c 5356 496e 5b31  snormy = LSVIn[1
+00028920: 2c2e 2e2e 5d0a 2020 2020 2020 2020 656c  ,...].        el
+00028930: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00028940: 6c73 706f 6c79 7820 3d20 4e6f 6e65 0a20  lspolyx = None. 
+00028950: 2020 2020 2020 2020 2020 206c 7370 6f6c             lspol
+00028960: 7979 203d 204e 6f6e 650a 2020 2020 2020  yy = None.      
+00028970: 2020 2020 2020 6c73 6e6f 726d 7820 3d20        lsnormx = 
+00028980: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+00028990: 206c 736e 6f72 6d79 203d 204e 6f6e 650a   lsnormy = None.
+000289a0: 2020 2020 2020 2020 696e 6420 3d20 287e          ind = (~
+000289b0: 696e 6429 2e6e 6f6e 7a65 726f 2829 5b30  ind).nonzero()[0
+000289c0: 5d0a 2020 2020 2020 2020 7074 7374 656d  ].        ptstem
+000289d0: 7020 3d20 6e70 2e61 7363 6f6e 7469 6775  p = np.ascontigu
+000289e0: 6f75 7361 7272 6179 2870 7473 5b3a 2c69  ousarray(pts[:,i
+000289f0: 6e64 5d29 0a20 2020 2020 2020 206e 7074  nd]).        npt
+00028a00: 736f 6b20 3d20 696e 642e 7369 7a65 0a20  sok = ind.size. 
+00028a10: 2020 2020 2020 206b 203d 2063 6c6f 6e65         k = clone
+00028a20: 2861 7272 6179 2827 6427 292c 206e 7074  (array('d'), npt
+00028a30: 736f 6b2c 2054 7275 6529 0a20 2020 2020  sok, True).     
+00028a40: 2020 206b 5f76 6965 7720 3d20 6b0a 2020     k_view = k.  
+00028a50: 2020 2020 2020 6966 2061 7070 726f 7820        if approx 
+00028a60: 616e 6420 6f75 745f 636f 6566 6f6e 6c79  and out_coefonly
+00028a70: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
+00028a80: 7220 6969 2069 6e20 7261 6e67 6528 6e74  r ii in range(nt
+00028a90: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00028aa0: 2020 205f 6267 742e 636f 6d70 7574 655f     _bgt.compute_
+00028ab0: 6469 7374 5f70 745f 7665 6328 706f 735b  dist_pt_vec(pos[
+00028ac0: 302c 6969 5d2c 2070 6f73 5b31 2c69 695d  0,ii], pos[1,ii]
+00028ad0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 00028ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028b00: 2020 2020 2020 2020 7074 7374 656d 702c          ptstemp,
-00028b10: 2026 6b5f 7669 6577 5b30 5d29 0a20 2020   &k_view[0]).   
-00028b20: 2020 2020 2020 2020 2020 2020 2076 6973               vis
-00028b30: 203d 204c 4f53 5f69 7356 6973 5f50 7446   = LOS_isVis_PtF
-00028b40: 726f 6d50 7473 5f56 6573 5374 7275 6374  romPts_VesStruct
-00028b50: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00028b60: 2020 2020 2020 706f 735b 302c 6969 5d2c        pos[0,ii],
-00028b70: 2070 6f73 5b31 2c69 695d 2c0a 2020 2020   pos[1,ii],.    
-00028b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028b90: 706f 735b 322c 6969 5d2c 2070 7473 7465  pos[2,ii], ptste
-00028ba0: 6d70 2c0a 2020 2020 2020 2020 2020 2020  mp,.            
-00028bb0: 2020 2020 2020 2020 6b3d 6b5f 7669 6577          k=k_view
-00028bc0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00028bd0: 2020 2020 2020 7665 735f 706f 6c79 3d56        ves_poly=V
-00028be0: 506f 6c79 2c0a 2020 2020 2020 2020 2020  Poly,.          
-00028bf0: 2020 2020 2020 2020 2020 7665 735f 6e6f            ves_no
-00028c00: 726d 3d56 496e 2c20 7665 735f 6c69 6d73  rm=VIn, ves_lims
-00028c10: 3d56 4c69 6d2c 0a20 2020 2020 2020 2020  =VLim,.         
-00028c20: 2020 2020 2020 2020 2020 206c 7374 7275             lstru
-00028c30: 6374 5f70 6f6c 7978 3d6c 7370 6f6c 7978  ct_polyx=lspolyx
-00028c40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00028c50: 2020 2020 2020 6c73 7472 7563 745f 706f        lstruct_po
-00028c60: 6c79 793d 6c73 706f 6c79 792c 0a20 2020  lyy=lspolyy,.   
-00028c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028c80: 206c 7374 7275 6374 5f6c 696d 733d 4c53   lstruct_lims=LS
-00028c90: 4c69 6d2c 0a20 2020 2020 2020 2020 2020  Lim,.           
-00028ca0: 2020 2020 2020 2020 206c 7374 7275 6374           lstruct
-00028cb0: 5f6e 6f72 6d78 3d6c 736e 6f72 6d78 2c0a  _normx=lsnormx,.
-00028cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028cd0: 2020 2020 6c73 7472 7563 745f 6e6f 726d      lstruct_norm
-00028ce0: 793d 6c73 6e6f 726d 792c 0a20 2020 2020  y=lsnormy,.     
-00028cf0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00028d00: 6f72 6269 643d 466f 7262 6964 2c0a 2020  orbid=Forbid,.  
-00028d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028d20: 2020 7665 735f 7479 7065 3d56 5479 7065    ves_type=VType
-00028d30: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00028d40: 2020 2020 2020 7465 7374 3d54 6573 742c        test=Test,
-00028d50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00028d60: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00028d70: 2020 2066 6f72 206a 6a20 696e 2072 616e     for jj in ran
-00028d80: 6765 286e 7074 736f 6b29 3a0a 2020 2020  ge(nptsok):.    
-00028d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028da0: 6966 2076 6973 5b6a 6a5d 3a0a 2020 2020  if vis[jj]:.    
-00028db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028dc0: 2020 2020 7361 6e67 5b69 692c 696e 645b      sang[ii,ind[
-00028dd0: 6a6a 5d5d 203d 2063 5f70 692f 6b5f 7669  jj]] = c_pi/k_vi
-00028de0: 6577 5b6a 6a5d 2a2a 320a 2020 2020 2020  ew[jj]**2.      
-00028df0: 2020 656c 6966 2061 7070 726f 783a 0a20    elif approx:. 
-00028e00: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
-00028e10: 6920 696e 2072 616e 6765 286e 7429 3a0a  i in range(nt):.
-00028e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028e30: 5f62 6774 2e63 6f6d 7075 7465 5f64 6973  _bgt.compute_dis
-00028e40: 745f 7074 5f76 6563 2870 6f73 5b30 2c69  t_pt_vec(pos[0,i
-00028e50: 695d 2c20 706f 735b 312c 6969 5d2c 0a20  i], pos[1,ii],. 
-00028e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028e80: 2020 2020 2020 2020 706f 735b 322c 6969          pos[2,ii
-00028e90: 5d2c 206e 7074 736f 6b2c 0a20 2020 2020  ], nptsok,.     
+00028af0: 2020 2020 2020 2020 2020 2070 6f73 5b32             pos[2
+00028b00: 2c69 695d 2c20 6e70 7473 6f6b 2c0a 2020  ,ii], nptsok,.  
+00028b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028b30: 2020 2020 2020 2070 7473 7465 6d70 2c20         ptstemp, 
+00028b40: 266b 5f76 6965 775b 305d 290a 2020 2020  &k_view[0]).    
+00028b50: 2020 2020 2020 2020 2020 2020 7669 7320              vis 
+00028b60: 3d20 4c4f 535f 6973 5669 735f 5074 4672  = LOS_isVis_PtFr
+00028b70: 6f6d 5074 735f 5665 7353 7472 7563 7428  omPts_VesStruct(
+00028b80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028b90: 2020 2020 2070 6f73 5b30 2c69 695d 2c20       pos[0,ii], 
+00028ba0: 706f 735b 312c 6969 5d2c 0a20 2020 2020  pos[1,ii],.     
+00028bb0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00028bc0: 6f73 5b32 2c69 695d 2c20 7074 7374 656d  os[2,ii], ptstem
+00028bd0: 702c 0a20 2020 2020 2020 2020 2020 2020  p,.             
+00028be0: 2020 2020 2020 206b 3d6b 5f76 6965 772c         k=k_view,
+00028bf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028c00: 2020 2020 2076 6573 5f70 6f6c 793d 5650       ves_poly=VP
+00028c10: 6f6c 792c 0a20 2020 2020 2020 2020 2020  oly,.           
+00028c20: 2020 2020 2020 2020 2076 6573 5f6e 6f72           ves_nor
+00028c30: 6d3d 5649 6e2c 2076 6573 5f6c 696d 733d  m=VIn, ves_lims=
+00028c40: 564c 696d 2c0a 2020 2020 2020 2020 2020  VLim,.          
+00028c50: 2020 2020 2020 2020 2020 6c73 7472 7563            lstruc
+00028c60: 745f 706f 6c79 783d 6c73 706f 6c79 782c  t_polyx=lspolyx,
+00028c70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028c80: 2020 2020 206c 7374 7275 6374 5f70 6f6c       lstruct_pol
+00028c90: 7979 3d6c 7370 6f6c 7979 2c0a 2020 2020  yy=lspolyy,.    
+00028ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028cb0: 6c73 7472 7563 745f 6c69 6d73 3d4c 534c  lstruct_lims=LSL
+00028cc0: 696d 2c0a 2020 2020 2020 2020 2020 2020  im,.            
+00028cd0: 2020 2020 2020 2020 6c73 7472 7563 745f          lstruct_
+00028ce0: 6e6f 726d 783d 6c73 6e6f 726d 782c 0a20  normx=lsnormx,. 
+00028cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028d00: 2020 206c 7374 7275 6374 5f6e 6f72 6d79     lstruct_normy
+00028d10: 3d6c 736e 6f72 6d79 2c0a 2020 2020 2020  =lsnormy,.      
+00028d20: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00028d30: 7262 6964 3d46 6f72 6269 642c 0a20 2020  rbid=Forbid,.   
+00028d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028d50: 2076 6573 5f74 7970 653d 5654 7970 652c   ves_type=VType,
+00028d60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028d70: 2020 2020 2074 6573 743d 5465 7374 2c0a       test=Test,.
+00028d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028d90: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00028da0: 2020 666f 7220 6a6a 2069 6e20 7261 6e67    for jj in rang
+00028db0: 6528 6e70 7473 6f6b 293a 0a20 2020 2020  e(nptsok):.     
+00028dc0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00028dd0: 6620 7669 735b 6a6a 5d3a 0a20 2020 2020  f vis[jj]:.     
+00028de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028df0: 2020 2073 616e 675b 6969 2c69 6e64 5b6a     sang[ii,ind[j
+00028e00: 6a5d 5d20 3d20 635f 7069 2f6b 5f76 6965  j]] = c_pi/k_vie
+00028e10: 775b 6a6a 5d2a 2a32 0a20 2020 2020 2020  w[jj]**2.       
+00028e20: 2065 6c69 6620 6170 7072 6f78 3a0a 2020   elif approx:.  
+00028e30: 2020 2020 2020 2020 2020 666f 7220 6969            for ii
+00028e40: 2069 6e20 7261 6e67 6528 6e74 293a 0a20   in range(nt):. 
+00028e50: 2020 2020 2020 2020 2020 2020 2020 205f                 _
+00028e60: 6267 742e 636f 6d70 7574 655f 6469 7374  bgt.compute_dist
+00028e70: 5f70 745f 7665 6328 706f 735b 302c 6969  _pt_vec(pos[0,ii
+00028e80: 5d2c 2070 6f73 5b31 2c69 695d 2c0a 2020  ], pos[1,ii],.  
+00028e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00028ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028ec0: 2020 2020 7074 7374 656d 702c 2026 6b5f      ptstemp, &k_
-00028ed0: 7669 6577 5b30 5d29 0a20 2020 2020 2020  view[0]).       
-00028ee0: 2020 2020 2020 2020 2076 6973 203d 204c           vis = L
-00028ef0: 4f53 5f69 7356 6973 5f50 7446 726f 6d50  OS_isVis_PtFromP
-00028f00: 7473 5f56 6573 5374 7275 6374 2870 6f73  ts_VesStruct(pos
-00028f10: 5b30 2c69 695d 2c20 706f 735b 312c 6969  [0,ii], pos[1,ii
-00028f20: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00028f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028f50: 2020 2020 2020 2070 6f73 5b32 2c69 695d         pos[2,ii]
-00028f60: 2c20 7074 7374 656d 702c 0a20 2020 2020  , ptstemp,.     
+00028eb0: 2020 2020 2020 2070 6f73 5b32 2c69 695d         pos[2,ii]
+00028ec0: 2c20 6e70 7473 6f6b 2c0a 2020 2020 2020  , nptsok,.      
+00028ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028ef0: 2020 2070 7473 7465 6d70 2c20 266b 5f76     ptstemp, &k_v
+00028f00: 6965 775b 305d 290a 2020 2020 2020 2020  iew[0]).        
+00028f10: 2020 2020 2020 2020 7669 7320 3d20 4c4f          vis = LO
+00028f20: 535f 6973 5669 735f 5074 4672 6f6d 5074  S_isVis_PtFromPt
+00028f30: 735f 5665 7353 7472 7563 7428 706f 735b  s_VesStruct(pos[
+00028f40: 302c 6969 5d2c 2070 6f73 5b31 2c69 695d  0,ii], pos[1,ii]
+00028f50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00028f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00028f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028f90: 2020 2020 2020 2020 2020 2020 2020 2076                 v
-00028fa0: 6573 5f70 6f6c 793d 5650 6f6c 792c 0a20  es_poly=VPoly,. 
+00028f80: 2020 2020 2020 706f 735b 322c 6969 5d2c        pos[2,ii],
+00028f90: 2070 7473 7465 6d70 2c0a 2020 2020 2020   ptstemp,.      
+00028fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00028fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028fe0: 2020 206b 3d6b 5f76 6965 772c 0a20 2020     k=k_view,.   
+00028fc0: 2020 2020 2020 2020 2020 2020 2020 7665                ve
+00028fd0: 735f 706f 6c79 3d56 506f 6c79 2c0a 2020  s_poly=VPoly,.  
+00028fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00028ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00029000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029020: 2076 6573 5f6e 6f72 6d3d 5649 6e2c 2076   ves_norm=VIn, v
-00029030: 6573 5f6c 696d 733d 564c 696d 2c0a 2020  es_lims=VLim,.  
+00029010: 2020 6b3d 6b5f 7669 6577 2c0a 2020 2020    k=k_view,.    
+00029020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029030: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00029040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029070: 2020 6c73 7472 7563 745f 706f 6c79 783d    lstruct_polyx=
-00029080: 6c73 706f 6c79 782c 0a20 2020 2020 2020  lspolyx,.       
+00029050: 7665 735f 6e6f 726d 3d56 496e 2c20 7665  ves_norm=VIn, ve
+00029060: 735f 6c69 6d73 3d56 4c69 6d2c 0a20 2020  s_lims=VLim,.   
+00029070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029080: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00029090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000290a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000290b0: 2020 2020 2020 2020 2020 2020 206c 7374               lst
-000290c0: 7275 6374 5f70 6f6c 7979 3d6c 7370 6f6c  ruct_polyy=lspol
-000290d0: 7979 2c0a 2020 2020 2020 2020 2020 2020  yy,.            
-000290e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000290f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029100: 2020 2020 2020 2020 6c73 7472 7563 745f          lstruct_
-00029110: 6c69 6d73 3d4c 534c 696d 2c0a 2020 2020  lims=LSLim,.    
+000290a0: 206c 7374 7275 6374 5f70 6f6c 7978 3d6c   lstruct_polyx=l
+000290b0: 7370 6f6c 7978 2c0a 2020 2020 2020 2020  spolyx,.        
+000290c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000290d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000290e0: 2020 2020 2020 2020 2020 2020 6c73 7472              lstr
+000290f0: 7563 745f 706f 6c79 793d 6c73 706f 6c79  uct_polyy=lspoly
+00029100: 792c 0a20 2020 2020 2020 2020 2020 2020  y,.             
+00029110: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00029120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029150: 6c73 7472 7563 745f 6e6f 726d 783d 6c73  lstruct_normx=ls
-00029160: 6e6f 726d 782c 0a20 2020 2020 2020 2020  normx,.         
-00029170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029190: 2020 2020 2020 2020 2020 206c 7374 7275             lstru
-000291a0: 6374 5f6e 6f72 6d79 3d6c 736e 6f72 6d79  ct_normy=lsnormy
-000291b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000291c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000291d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000291e0: 2020 2020 2020 666f 7262 6964 3d46 6f72        forbid=For
-000291f0: 6269 642c 0a20 2020 2020 2020 2020 2020  bid,.           
+00029130: 2020 2020 2020 206c 7374 7275 6374 5f6c         lstruct_l
+00029140: 696d 733d 4c53 4c69 6d2c 0a20 2020 2020  ims=LSLim,.     
+00029150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029170: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00029180: 7374 7275 6374 5f6e 6f72 6d78 3d6c 736e  struct_normx=lsn
+00029190: 6f72 6d78 2c0a 2020 2020 2020 2020 2020  ormx,.          
+000291a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000291b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000291c0: 2020 2020 2020 2020 2020 6c73 7472 7563            lstruc
+000291d0: 745f 6e6f 726d 793d 6c73 6e6f 726d 792c  t_normy=lsnormy,
+000291e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000291f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00029200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029220: 2020 2020 2020 2020 2076 6573 5f74 7970           ves_typ
-00029230: 653d 5654 7970 652c 2074 6573 743d 5465  e=VType, test=Te
-00029240: 7374 290a 2020 2020 2020 2020 2020 2020  st).            
-00029250: 2020 2020 7069 7232 203d 2063 5f70 692a      pir2 = c_pi*
-00029260: 725b 6969 5d2a 2a32 0a20 2020 2020 2020  r[ii]**2.       
-00029270: 2020 2020 2020 2020 2066 6f72 206a 6a20           for jj 
-00029280: 696e 2072 616e 6765 286e 7074 736f 6b29  in range(nptsok)
-00029290: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000292a0: 2020 2020 2020 6966 2076 6973 5b6a 6a5d        if vis[jj]
-000292b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000292c0: 2020 2020 2020 2020 2020 7361 6e67 5b69            sang[i
-000292d0: 692c 696e 645b 6a6a 5d5d 203d 2070 6972  i,ind[jj]] = pir
-000292e0: 322f 6b5f 7669 6577 5b6a 6a5d 2a2a 320a  2/k_view[jj]**2.
-000292f0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00029300: 2020 2020 2020 2020 2020 7069 7232 203d            pir2 =
-00029310: 205f 5457 4f50 490a 2020 2020 2020 2020   _TWOPI.        
-00029320: 2020 2020 666f 7220 6969 2069 6e20 7261      for ii in ra
-00029330: 6e67 6528 6e74 293a 0a20 2020 2020 2020  nge(nt):.       
-00029340: 2020 2020 2020 2020 205f 6267 742e 636f           _bgt.co
-00029350: 6d70 7574 655f 6469 7374 5f70 745f 7665  mpute_dist_pt_ve
-00029360: 6328 706f 735b 302c 6969 5d2c 2070 6f73  c(pos[0,ii], pos
-00029370: 5b31 2c69 695d 2c0a 2020 2020 2020 2020  [1,ii],.        
-00029380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000293a0: 2070 6f73 5b32 2c69 695d 2c20 6e70 7473   pos[2,ii], npts
-000293b0: 6f6b 2c0a 2020 2020 2020 2020 2020 2020  ok,.            
+00029210: 2020 2020 2066 6f72 6269 643d 466f 7262       forbid=Forb
+00029220: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
+00029230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029250: 2020 2020 2020 2020 7665 735f 7479 7065          ves_type
+00029260: 3d56 5479 7065 2c20 7465 7374 3d54 6573  =VType, test=Tes
+00029270: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
+00029280: 2020 2070 6972 3220 3d20 635f 7069 2a72     pir2 = c_pi*r
+00029290: 5b69 695d 2a2a 320a 2020 2020 2020 2020  [ii]**2.        
+000292a0: 2020 2020 2020 2020 666f 7220 6a6a 2069          for jj i
+000292b0: 6e20 7261 6e67 6528 6e70 7473 6f6b 293a  n range(nptsok):
+000292c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000292d0: 2020 2020 2069 6620 7669 735b 6a6a 5d3a       if vis[jj]:
+000292e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000292f0: 2020 2020 2020 2020 2073 616e 675b 6969           sang[ii
+00029300: 2c69 6e64 5b6a 6a5d 5d20 3d20 7069 7232  ,ind[jj]] = pir2
+00029310: 2f6b 5f76 6965 775b 6a6a 5d2a 2a32 0a20  /k_view[jj]**2. 
+00029320: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00029330: 2020 2020 2020 2020 2070 6972 3220 3d20           pir2 = 
+00029340: 5f54 574f 5049 0a20 2020 2020 2020 2020  _TWOPI.         
+00029350: 2020 2066 6f72 2069 6920 696e 2072 616e     for ii in ran
+00029360: 6765 286e 7429 3a0a 2020 2020 2020 2020  ge(nt):.        
+00029370: 2020 2020 2020 2020 5f62 6774 2e63 6f6d          _bgt.com
+00029380: 7075 7465 5f64 6973 745f 7074 5f76 6563  pute_dist_pt_vec
+00029390: 2870 6f73 5b30 2c69 695d 2c20 706f 735b  (pos[0,ii], pos[
+000293a0: 312c 6969 5d2c 0a20 2020 2020 2020 2020  1,ii],.         
+000293b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000293c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000293d0: 2020 2020 2020 2020 2020 2020 2070 7473               pts
-000293e0: 7465 6d70 2c20 266b 5f76 6965 775b 305d  temp, &k_view[0]
-000293f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00029400: 2020 7669 7320 3d20 4c4f 535f 6973 5669    vis = LOS_isVi
-00029410: 735f 5074 4672 6f6d 5074 735f 5665 7353  s_PtFromPts_VesS
-00029420: 7472 7563 7428 706f 735b 302c 6969 5d2c  truct(pos[0,ii],
-00029430: 2070 6f73 5b31 2c69 695d 2c0a 2020 2020   pos[1,ii],.    
-00029440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029470: 706f 735b 322c 6969 5d2c 0a20 2020 2020  pos[2,ii],.     
+000293d0: 706f 735b 322c 6969 5d2c 206e 7074 736f  pos[2,ii], nptso
+000293e0: 6b2c 0a20 2020 2020 2020 2020 2020 2020  k,.             
+000293f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029400: 2020 2020 2020 2020 2020 2020 7074 7374              ptst
+00029410: 656d 702c 2026 6b5f 7669 6577 5b30 5d29  emp, &k_view[0])
+00029420: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029430: 2076 6973 203d 204c 4f53 5f69 7356 6973   vis = LOS_isVis
+00029440: 5f50 7446 726f 6d50 7473 5f56 6573 5374  _PtFromPts_VesSt
+00029450: 7275 6374 2870 6f73 5b30 2c69 695d 2c20  ruct(pos[0,ii], 
+00029460: 706f 735b 312c 6969 5d2c 0a20 2020 2020  pos[1,ii],.     
+00029470: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00029480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000294a0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-000294b0: 7473 7465 6d70 2c0a 2020 2020 2020 2020  tstemp,.        
+00029490: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+000294a0: 6f73 5b32 2c69 695d 2c0a 2020 2020 2020  os[2,ii],.      
+000294b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000294c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000294d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000294e0: 2020 2020 2020 2020 2020 2020 7665 735f              ves_
-000294f0: 706f 6c79 3d56 506f 6c79 2c0a 2020 2020  poly=VPoly,.    
+000294d0: 2020 2020 2020 2020 2020 2020 2020 7074                pt
+000294e0: 7374 656d 702c 0a20 2020 2020 2020 2020  stemp,.         
+000294f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00029500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029530: 6b3d 6b5f 7669 6577 2c0a 2020 2020 2020  k=k_view,.      
+00029510: 2020 2020 2020 2020 2020 2076 6573 5f70             ves_p
+00029520: 6f6c 793d 5650 6f6c 792c 0a20 2020 2020  oly=VPoly,.     
+00029530: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00029540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029560: 2020 2020 2020 2020 2020 2020 2020 7665                ve
-00029570: 735f 6e6f 726d 3d56 496e 2c20 7665 735f  s_norm=VIn, ves_
-00029580: 6c69 6d73 3d56 4c69 6d2c 0a20 2020 2020  lims=VLim,.     
-00029590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000295a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000295b0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-000295c0: 7374 7275 6374 5f70 6f6c 7978 3d6c 7370  struct_polyx=lsp
-000295d0: 6f6c 7978 2c0a 2020 2020 2020 2020 2020  olyx,.          
-000295e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000295f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029600: 2020 2020 2020 2020 2020 6c73 7472 7563            lstruc
-00029610: 745f 706f 6c79 793d 6c73 706f 6c79 792c  t_polyy=lspolyy,
-00029620: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00029630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029650: 2020 2020 206c 7374 7275 6374 5f6c 696d       lstruct_lim
-00029660: 733d 4c53 4c69 6d2c 0a20 2020 2020 2020  s=LSLim,.       
+00029550: 2020 2020 2020 2020 2020 2020 2020 206b                 k
+00029560: 3d6b 5f76 6965 772c 0a20 2020 2020 2020  =k_view,.       
+00029570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029590: 2020 2020 2020 2020 2020 2020 2076 6573               ves
+000295a0: 5f6e 6f72 6d3d 5649 6e2c 2076 6573 5f6c  _norm=VIn, ves_l
+000295b0: 696d 733d 564c 696d 2c0a 2020 2020 2020  ims=VLim,.      
+000295c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000295d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000295e0: 2020 2020 2020 2020 2020 2020 2020 6c73                ls
+000295f0: 7472 7563 745f 706f 6c79 783d 6c73 706f  truct_polyx=lspo
+00029600: 6c79 782c 0a20 2020 2020 2020 2020 2020  lyx,.           
+00029610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029630: 2020 2020 2020 2020 206c 7374 7275 6374           lstruct
+00029640: 5f70 6f6c 7979 3d6c 7370 6f6c 7979 2c0a  _polyy=lspolyy,.
+00029650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029660: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00029670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029690: 2020 2020 2020 2020 2020 2020 206c 7374               lst
-000296a0: 7275 6374 5f6e 6f72 6d78 3d6c 736e 6f72  ruct_normx=lsnor
-000296b0: 6d78 2c0a 2020 2020 2020 2020 2020 2020  mx,.            
-000296c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000296d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000296e0: 2020 2020 2020 2020 6c73 7472 7563 745f          lstruct_
-000296f0: 6e6f 726d 793d 6c73 6e6f 726d 792c 0a20  normy=lsnormy,. 
+00029680: 2020 2020 6c73 7472 7563 745f 6c69 6d73      lstruct_lims
+00029690: 3d4c 534c 696d 2c0a 2020 2020 2020 2020  =LSLim,.        
+000296a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000296b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000296c0: 2020 2020 2020 2020 2020 2020 6c73 7472              lstr
+000296d0: 7563 745f 6e6f 726d 783d 6c73 6e6f 726d  uct_normx=lsnorm
+000296e0: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
+000296f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00029700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029730: 2020 2066 6f72 6269 643d 466f 7262 6964     forbid=Forbid
-00029740: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00029710: 2020 2020 2020 206c 7374 7275 6374 5f6e         lstruct_n
+00029720: 6f72 6d79 3d6c 736e 6f72 6d79 2c0a 2020  ormy=lsnormy,.  
+00029730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029740: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00029750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029770: 2020 2020 2020 7665 735f 7479 7065 3d56        ves_type=V
-00029780: 5479 7065 2c20 7465 7374 3d54 6573 7429  Type, test=Test)
-00029790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000297a0: 2066 6f72 206a 6a20 696e 2072 616e 6765   for jj in range
-000297b0: 2830 2c6e 7074 736f 6b29 3a0a 2020 2020  (0,nptsok):.    
+00029760: 2020 666f 7262 6964 3d46 6f72 6269 642c    forbid=Forbid,
+00029770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000297a0: 2020 2020 2076 6573 5f74 7970 653d 5654       ves_type=VT
+000297b0: 7970 652c 2074 6573 743d 5465 7374 290a  ype, test=Test).
 000297c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000297d0: 6966 2076 6973 5b6a 6a5d 3a0a 2020 2020  if vis[jj]:.    
-000297e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000297f0: 2020 2020 7361 6e67 5b69 692c 696e 645b      sang[ii,ind[
-00029800: 6a6a 5d5d 203d 2070 6972 322a 2831 2d63  jj]] = pir2*(1-c
-00029810: 5f73 7172 7428 312d 725b 6969 5d2a 2a32  _sqrt(1-r[ii]**2
-00029820: 2f6b 5b6a 6a5d 2a2a 3229 290a 0a20 2020  /k[jj]**2))..   
-00029830: 2065 6c73 653a 0a20 2020 2020 2020 2069   else:.        i
-00029840: 6620 6170 7072 6f78 2061 6e64 206f 7574  f approx and out
-00029850: 5f63 6f65 666f 6e6c 793a 0a20 2020 2020  _coefonly:.     
-00029860: 2020 2020 2020 2066 6f72 2069 6920 696e         for ii in
-00029870: 2072 616e 6765 286e 7429 3a0a 2020 2020   range(nt):.    
-00029880: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00029890: 6a6a 2069 6e20 7261 6e67 6528 6e70 7473  jj in range(npts
-000298a0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-000298b0: 2020 2020 2020 2064 696a 3220 3d20 2828         dij2 = ((
-000298c0: 706f 735b 302c 6969 5d2d 7074 735b 302c  pos[0,ii]-pts[0,
-000298d0: 6a6a 5d29 2a2a 320a 2020 2020 2020 2020  jj])**2.        
-000298e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000298f0: 2020 2020 2b20 2870 6f73 5b31 2c69 695d      + (pos[1,ii]
-00029900: 2d70 7473 5b31 2c6a 6a5d 292a 2a32 0a20  -pts[1,jj])**2. 
+000297d0: 666f 7220 6a6a 2069 6e20 7261 6e67 6528  for jj in range(
+000297e0: 302c 6e70 7473 6f6b 293a 0a20 2020 2020  0,nptsok):.     
+000297f0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00029800: 6620 7669 735b 6a6a 5d3a 0a20 2020 2020  f vis[jj]:.     
+00029810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029820: 2020 2073 616e 675b 6969 2c69 6e64 5b6a     sang[ii,ind[j
+00029830: 6a5d 5d20 3d20 7069 7232 2a28 312d 635f  j]] = pir2*(1-c_
+00029840: 7371 7274 2831 2d72 5b69 695d 2a2a 322f  sqrt(1-r[ii]**2/
+00029850: 6b5b 6a6a 5d2a 2a32 2929 0a0a 2020 2020  k[jj]**2))..    
+00029860: 656c 7365 3a0a 2020 2020 2020 2020 6966  else:.        if
+00029870: 2061 7070 726f 7820 616e 6420 6f75 745f   approx and out_
+00029880: 636f 6566 6f6e 6c79 3a0a 2020 2020 2020  coefonly:.      
+00029890: 2020 2020 2020 666f 7220 6969 2069 6e20        for ii in 
+000298a0: 7261 6e67 6528 6e74 293a 0a20 2020 2020  range(nt):.     
+000298b0: 2020 2020 2020 2020 2020 2066 6f72 206a             for j
+000298c0: 6a20 696e 2072 616e 6765 286e 7074 7329  j in range(npts)
+000298d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000298e0: 2020 2020 2020 6469 6a32 203d 2028 2870        dij2 = ((p
+000298f0: 6f73 5b30 2c69 695d 2d70 7473 5b30 2c6a  os[0,ii]-pts[0,j
+00029900: 6a5d 292a 2a32 0a20 2020 2020 2020 2020  j])**2.         
 00029910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029920: 2020 2020 2020 2020 2020 202b 2028 706f             + (po
-00029930: 735b 322c 6969 5d2d 7074 735b 322c 6a6a  s[2,ii]-pts[2,jj
-00029940: 5d29 2a2a 3229 0a20 2020 2020 2020 2020  ])**2).         
-00029950: 2020 2020 2020 2020 2020 2073 616e 675b             sang[
-00029960: 6969 2c6a 6a5d 203d 2063 5f70 692f 6469  ii,jj] = c_pi/di
-00029970: 6a32 0a20 2020 2020 2020 2065 6c69 6620  j2.        elif 
-00029980: 6170 7072 6f78 3a0a 2020 2020 2020 2020  approx:.        
-00029990: 2020 2020 666f 7220 6969 2069 6e20 7261      for ii in ra
-000299a0: 6e67 6528 6e74 293a 0a20 2020 2020 2020  nge(nt):.       
-000299b0: 2020 2020 2020 2020 2070 6972 3220 3d20           pir2 = 
-000299c0: 635f 7069 2a72 5b69 695d 2a2a 320a 2020  c_pi*r[ii]**2.  
-000299d0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-000299e0: 7220 6a6a 2069 6e20 7261 6e67 6528 6e70  r jj in range(np
-000299f0: 7473 293a 0a20 2020 2020 2020 2020 2020  ts):.           
-00029a00: 2020 2020 2020 2020 2064 696a 3220 3d20           dij2 = 
-00029a10: 2828 706f 735b 302c 6969 5d2d 7074 735b  ((pos[0,ii]-pts[
-00029a20: 302c 6a6a 5d29 2a2a 320a 2020 2020 2020  0,jj])**2.      
-00029a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029a40: 2020 2020 2020 2b20 2870 6f73 5b30 2c69        + (pos[0,i
-00029a50: 695d 2d70 7473 5b30 2c6a 6a5d 292a 2a32  i]-pts[0,jj])**2
-00029a60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00029a70: 2020 2020 2020 2020 2020 2020 202b 2028               + (
-00029a80: 706f 735b 302c 6969 5d2d 7074 735b 302c  pos[0,ii]-pts[0,
-00029a90: 6a6a 5d29 2a2a 3229 0a20 2020 2020 2020  jj])**2).       
-00029aa0: 2020 2020 2020 2020 2020 2020 2073 616e               san
-00029ab0: 675b 6969 2c6a 6a5d 203d 2070 6972 322f  g[ii,jj] = pir2/
-00029ac0: 6469 6a32 0a20 2020 2020 2020 2065 6c73  dij2.        els
-00029ad0: 653a 0a20 2020 2020 2020 2020 2020 2070  e:.            p
-00029ae0: 6972 3220 3d20 5f54 574f 5049 0a20 2020  ir2 = _TWOPI.   
-00029af0: 2020 2020 2020 2020 2066 6f72 2069 6920           for ii 
-00029b00: 696e 2072 616e 6765 286e 7429 3a0a 2020  in range(nt):.  
-00029b10: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00029b20: 7220 6a6a 2069 6e20 7261 6e67 6528 6e70  r jj in range(np
-00029b30: 7473 293a 0a20 2020 2020 2020 2020 2020  ts):.           
-00029b40: 2020 2020 2020 2020 2064 696a 3220 3d20           dij2 = 
-00029b50: 2828 706f 735b 302c 6969 5d2d 7074 735b  ((pos[0,ii]-pts[
-00029b60: 302c 6a6a 5d29 2a2a 320a 2020 2020 2020  0,jj])**2.      
-00029b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029b80: 2020 2020 2020 2b20 2870 6f73 5b30 2c69        + (pos[0,i
-00029b90: 695d 2d70 7473 5b30 2c6a 6a5d 292a 2a32  i]-pts[0,jj])**2
-00029ba0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00029bb0: 2020 2020 2020 2020 2020 2020 202b 2028               + (
-00029bc0: 706f 735b 302c 6969 5d2d 7074 735b 302c  pos[0,ii]-pts[0,
-00029bd0: 6a6a 5d29 2a2a 3229 0a20 2020 2020 2020  jj])**2).       
-00029be0: 2020 2020 2020 2020 2020 2020 2073 616e               san
-00029bf0: 675b 6969 2c6a 6a5d 203d 2070 6972 322a  g[ii,jj] = pir2*
-00029c00: 2831 2d63 5f73 7172 7428 312d 725b 6969  (1-c_sqrt(1-r[ii
-00029c10: 5d2a 2a32 2f64 696a 3229 290a 2020 2020  ]**2/dij2)).    
-00029c20: 7265 7475 726e 2073 616e 670a 0a0a 2320  return sang...# 
-00029c30: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00029c40: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00029c50: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00029920: 2020 202b 2028 706f 735b 312c 6969 5d2d     + (pos[1,ii]-
+00029930: 7074 735b 312c 6a6a 5d29 2a2a 320a 2020  pts[1,jj])**2.  
+00029940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029950: 2020 2020 2020 2020 2020 2b20 2870 6f73            + (pos
+00029960: 5b32 2c69 695d 2d70 7473 5b32 2c6a 6a5d  [2,ii]-pts[2,jj]
+00029970: 292a 2a32 290a 2020 2020 2020 2020 2020  )**2).          
+00029980: 2020 2020 2020 2020 2020 7361 6e67 5b69            sang[i
+00029990: 692c 6a6a 5d20 3d20 635f 7069 2f64 696a  i,jj] = c_pi/dij
+000299a0: 320a 2020 2020 2020 2020 656c 6966 2061  2.        elif a
+000299b0: 7070 726f 783a 0a20 2020 2020 2020 2020  pprox:.         
+000299c0: 2020 2066 6f72 2069 6920 696e 2072 616e     for ii in ran
+000299d0: 6765 286e 7429 3a0a 2020 2020 2020 2020  ge(nt):.        
+000299e0: 2020 2020 2020 2020 7069 7232 203d 2063          pir2 = c
+000299f0: 5f70 692a 725b 6969 5d2a 2a32 0a20 2020  _pi*r[ii]**2.   
+00029a00: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00029a10: 206a 6a20 696e 2072 616e 6765 286e 7074   jj in range(npt
+00029a20: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
+00029a30: 2020 2020 2020 2020 6469 6a32 203d 2028          dij2 = (
+00029a40: 2870 6f73 5b30 2c69 695d 2d70 7473 5b30  (pos[0,ii]-pts[0
+00029a50: 2c6a 6a5d 292a 2a32 0a20 2020 2020 2020  ,jj])**2.       
+00029a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029a70: 2020 2020 202b 2028 706f 735b 302c 6969       + (pos[0,ii
+00029a80: 5d2d 7074 735b 302c 6a6a 5d29 2a2a 320a  ]-pts[0,jj])**2.
+00029a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029aa0: 2020 2020 2020 2020 2020 2020 2b20 2870              + (p
+00029ab0: 6f73 5b30 2c69 695d 2d70 7473 5b30 2c6a  os[0,ii]-pts[0,j
+00029ac0: 6a5d 292a 2a32 290a 2020 2020 2020 2020  j])**2).        
+00029ad0: 2020 2020 2020 2020 2020 2020 7361 6e67              sang
+00029ae0: 5b69 692c 6a6a 5d20 3d20 7069 7232 2f64  [ii,jj] = pir2/d
+00029af0: 696a 320a 2020 2020 2020 2020 656c 7365  ij2.        else
+00029b00: 3a0a 2020 2020 2020 2020 2020 2020 7069  :.            pi
+00029b10: 7232 203d 205f 5457 4f50 490a 2020 2020  r2 = _TWOPI.    
+00029b20: 2020 2020 2020 2020 666f 7220 6969 2069          for ii i
+00029b30: 6e20 7261 6e67 6528 6e74 293a 0a20 2020  n range(nt):.   
+00029b40: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00029b50: 206a 6a20 696e 2072 616e 6765 286e 7074   jj in range(npt
+00029b60: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
+00029b70: 2020 2020 2020 2020 6469 6a32 203d 2028          dij2 = (
+00029b80: 2870 6f73 5b30 2c69 695d 2d70 7473 5b30  (pos[0,ii]-pts[0
+00029b90: 2c6a 6a5d 292a 2a32 0a20 2020 2020 2020  ,jj])**2.       
+00029ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029bb0: 2020 2020 202b 2028 706f 735b 302c 6969       + (pos[0,ii
+00029bc0: 5d2d 7074 735b 302c 6a6a 5d29 2a2a 320a  ]-pts[0,jj])**2.
+00029bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029be0: 2020 2020 2020 2020 2020 2020 2b20 2870              + (p
+00029bf0: 6f73 5b30 2c69 695d 2d70 7473 5b30 2c6a  os[0,ii]-pts[0,j
+00029c00: 6a5d 292a 2a32 290a 2020 2020 2020 2020  j])**2).        
+00029c10: 2020 2020 2020 2020 2020 2020 7361 6e67              sang
+00029c20: 5b69 692c 6a6a 5d20 3d20 7069 7232 2a28  [ii,jj] = pir2*(
+00029c30: 312d 635f 7371 7274 2831 2d72 5b69 695d  1-c_sqrt(1-r[ii]
+00029c40: 2a2a 322f 6469 6a32 2929 0a20 2020 2072  **2/dij2)).    r
+00029c50: 6574 7572 6e20 7361 6e67 0a0a 0a23 203d  eturn sang...# =
 00029c60: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00029c70: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 0a23  ==============.#
-00029c80: 0a23 2020 2020 2020 2020 2020 2020 2020  .#              
-00029c90: 2020 2020 2020 2020 2044 4953 5441 4e43           DISTANC
-00029ca0: 4520 4349 5243 4c45 202d 204c 4f53 0a23  E CIRCLE - LOS.#
-00029cb0: 0a23 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  .# =============
-00029cc0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00029cd0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00029ce0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00029c70: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00029c80: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00029c90: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00029ca0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 230a  =============.#.
+00029cb0: 2320 2020 2020 2020 2020 2020 2020 2020  #               
+00029cc0: 2020 2020 2020 2020 4449 5354 414e 4345          DISTANCE
+00029cd0: 2043 4952 434c 4520 2d20 4c4f 530a 230a   CIRCLE - LOS.#.
+00029ce0: 2320 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  # ==============
 00029cf0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00029d00: 3d0a 6465 6620 636f 6d70 5f64 6973 745f  =.def comp_dist_
-00029d10: 6c6f 735f 6369 7263 6c65 286e 702e 6e64  los_circle(np.nd
-00029d20: 6172 7261 795b 646f 7562 6c65 2c6e 6469  array[double,ndi
-00029d30: 6d3d 312c 6d6f 6465 3d27 6327 5d20 7261  m=1,mode='c'] ra
-00029d40: 795f 7664 6972 2c0a 2020 2020 2020 2020  y_vdir,.        
-00029d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029d60: 206e 702e 6e64 6172 7261 795b 646f 7562   np.ndarray[doub
-00029d70: 6c65 2c6e 6469 6d3d 312c 6d6f 6465 3d27  le,ndim=1,mode='
-00029d80: 6327 5d20 7261 795f 6f72 6967 2c0a 2020  c'] ray_orig,.  
-00029d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029da0: 2020 2020 2020 2064 6f75 626c 6520 7261         double ra
-00029db0: 6469 7573 2c20 646f 7562 6c65 2063 6972  dius, double cir
-00029dc0: 635f 7a2c 2064 6f75 626c 6520 6e6f 726d  c_z, double norm
-00029dd0: 5f64 6972 3d2d 312e 3029 3a0a 2020 2020  _dir=-1.0):.    
-00029de0: 2222 220a 2020 2020 5468 6973 2066 756e  """.    This fun
-00029df0: 6374 696f 6e20 636f 6d70 7574 6573 2074  ction computes t
-00029e00: 6865 2069 6e74 6572 7365 6374 696f 6e20  he intersection 
-00029e10: 6f66 2061 2052 6179 2028 6f72 204c 696e  of a Ray (or Lin
-00029e20: 6520 4f66 2053 6967 6874 290a 2020 2020  e Of Sight).    
-00029e30: 616e 6420 6120 6369 7263 6c65 2069 6e20  and a circle in 
-00029e40: 3344 2e20 4974 2072 6574 7572 6e73 2060  3D. It returns `
-00029e50: 6b6d 696e 6020 616e 6420 6064 6973 7460  kmin` and `dist`
-00029e60: 2e20 5768 6572 6520 606b 6d69 6e60 2069  . Where `kmin` i
-00029e70: 7320 7468 650a 2020 2020 636f 6566 6669  s the.    coeffi
-00029e80: 6369 656e 7420 7375 6368 2074 6861 7420  cient such that 
-00029e90: 7468 6520 7261 7920 6f66 206f 7269 6769  the ray of origi
-00029ea0: 6e20 4f20 3d20 5b6f 7269 312c 206f 7269  n O = [ori1, ori
-00029eb0: 322c 206f 7269 335d 0a20 2020 2061 6e64  2, ori3].    and
-00029ec0: 206f 6620 6469 7265 6374 696f 6e61 6c20   of directional 
-00029ed0: 7665 6374 6f72 2044 203d 205b 6469 7231  vector D = [dir1
-00029ee0: 2c20 6469 7232 2c20 6469 7233 5d20 6973  , dir2, dir3] is
-00029ef0: 2063 6c6f 7365 7374 2074 6f20 7468 6520   closest to the 
-00029f00: 6369 7263 6c65 0a20 2020 2020 6f66 2072  circle.     of r
-00029f10: 6164 6975 7320 6072 6164 6975 7360 2061  adius `radius` a
-00029f20: 6e64 2063 656e 7465 7265 6420 6028 302c  nd centered `(0,
-00029f30: 2030 2c20 6369 7263 5f7a 2960 2061 7420   0, circ_z)` at 
-00029f40: 7468 6520 706f 696e 740a 2020 2020 5020  the point.    P 
-00029f50: 3d20 4f20 2b20 6b6d 696e 202a 2044 2e0a  = O + kmin * D..
-00029f60: 2020 2020 416e 6420 6064 6973 7461 6e63      And `distanc
-00029f70: 6560 2074 6865 2064 6973 7461 6e63 6520  e` the distance 
-00029f80: 6265 7477 6565 6e20 7468 6520 7477 6f20  between the two 
-00029f90: 636c 6f73 6573 7420 706f 696e 7473 2028  closest points (
-00029fa0: 6c69 6e65 2063 6c6f 7365 7374 0a20 2020  line closest.   
-00029fb0: 2061 6e64 2063 6972 636c 6520 636c 6f73   and circle clos
-00029fc0: 6573 7429 0a20 2020 2054 6865 2076 6172  est).    The var
-00029fd0: 6961 626c 6520 606e 6f72 6d5f 6469 7260  iable `norm_dir`
-00029fe0: 2069 7320 7468 6520 7371 7561 7265 6420   is the squared 
-00029ff0: 6e6f 726d 206f 6620 7468 6520 6469 7265  norm of the dire
-0002a000: 6374 696f 6e20 6f66 2074 6865 2072 6179  ction of the ray
-0002a010: 2e0a 2020 2020 5061 7261 6d73 0a20 2020  ..    Params.   
-0002a020: 203d 3d3d 3d3d 0a20 2020 2072 6179 5f76   =====.    ray_v
-0002a030: 6469 723a 2028 3329 2064 6f75 626c 6520  dir: (3) double 
-0002a040: 6172 7261 790a 2020 2020 2020 2020 7261  array.        ra
-0002a050: 7927 7320 6469 7265 6374 6f72 2076 6563  y's director vec
-0002a060: 746f 7220 5620 7375 6368 2074 6861 7420  tor V such that 
-0002a070: 5020 5c69 6e20 5261 7920 6966 6620 5028  P \in Ray iff P(
-0002a080: 7429 203d 204f 202b 2074 2a56 0a20 2020  t) = O + t*V.   
-0002a090: 2072 6179 5f6f 7269 6720 3a20 2833 2920   ray_orig : (3) 
-0002a0a0: 646f 7562 6c65 2061 7272 6179 0a20 2020  double array.   
-0002a0b0: 2020 2020 2072 6179 2773 206f 7269 6769       ray's origi
-0002a0c0: 6e20 636f 6f72 6469 6e61 7465 7320 4f20  n coordinates O 
-0002a0d0: 7375 6368 2074 6861 7420 5020 5c69 6e20  such that P \in 
-0002a0e0: 5261 7920 6966 6620 5028 7429 203d 204f  Ray iff P(t) = O
-0002a0f0: 202b 2074 2a56 0a20 2020 2072 6164 6975   + t*V.    radiu
-0002a100: 7320 3a20 646f 7562 6c65 0a20 2020 2020  s : double.     
-0002a110: 2020 2072 6164 6975 7320 7220 6f66 2068     radius r of h
-0002a120: 6f72 697a 6f6e 7461 6c20 6369 7263 6c65  orizontal circle
-0002a130: 2063 656e 7465 7265 6420 696e 2028 302c   centered in (0,
-0002a140: 302c 6369 7263 5f7a 290a 2020 2020 6369  0,circ_z).    ci
-0002a150: 7263 5f7a 203a 2064 6f75 626c 650a 2020  rc_z : double.  
-0002a160: 2020 2020 2020 3372 6420 636f 6f72 6469        3rd coordi
-0002a170: 6e61 7465 206f 6620 686f 7269 7a6f 6e74  nate of horizont
-0002a180: 616c 2063 6972 636c 6520 6365 6e74 6572  al circle center
-0002a190: 6564 2069 6e20 2830 2c30 2c63 6972 635f  ed in (0,0,circ_
-0002a1a0: 7a29 206f 6620 7261 6469 7573 2072 0a20  z) of radius r. 
-0002a1b0: 2020 206e 6f72 6d5f 6469 7220 3a20 646f     norm_dir : do
-0002a1c0: 7562 6c65 2028 6f70 7469 6f6e 616c 290a  uble (optional).
-0002a1d0: 2020 2020 2020 2020 4966 2066 6f72 2063          If for c
-0002a1e0: 6f6d 7075 7461 7469 6f6e 2072 6561 736f  omputation reaso
-0002a1f0: 6e73 2069 7420 6d61 6b65 7320 7365 6e73  ns it makes sens
-0002a200: 652c 2079 6f75 2063 616e 2070 6173 7320  e, you can pass 
-0002a210: 7468 6520 6e6f 726d 206f 6620 7468 650a  the norm of the.
-0002a220: 2020 2020 2020 2020 6469 7265 6374 6f72          director
-0002a230: 2076 6563 746f 720a 2020 2020 5265 7475   vector.    Retu
-0002a240: 726e 730a 2020 2020 3d3d 3d3d 3d3d 3d0a  rns.    =======.
-0002a250: 2020 2020 7265 7375 6c74 203a 2064 6f75      result : dou
-0002a260: 626c 6520 2832 2920 6172 7261 790a 2020  ble (2) array.  
-0002a270: 2020 2020 202d 2072 6573 756c 745b 305d       - result[0]
-0002a280: 2077 696c 6c20 636f 6e74 6169 6e20 7468   will contain th
-0002a290: 6520 6b20 636f 6566 6669 6369 656e 7420  e k coefficient 
-0002a2a0: 746f 2066 696e 6420 7468 6520 6c69 6e65  to find the line
-0002a2b0: 2070 6f69 6e74 2063 6c6f 7365 7374 0a20   point closest. 
-0002a2c0: 2020 2020 2020 636c 6f73 6573 7420 706f        closest po
-0002a2d0: 696e 740a 2020 2020 2020 202d 2072 6573  int.       - res
-0002a2e0: 756c 745b 315d 2077 696c 6c20 636f 6e74  ult[1] will cont
-0002a2f0: 6169 6e20 7468 6520 4449 5354 414e 4345  ain the DISTANCE
-0002a300: 2066 726f 6d20 6c69 6e65 2063 6c6f 7365   from line close
-0002a310: 7374 2070 6f69 6e74 2074 6f20 6369 7263  st point to circ
-0002a320: 6c65 0a20 2020 2020 2020 746f 2074 6865  le.       to the
-0002a330: 2063 6972 636c 650a 2020 2020 2d2d 2d0a   circle.    ---.
-0002a340: 2020 2020 5468 6973 2069 7320 7468 6520      This is the 
-0002a350: 5059 5448 4f4e 2066 756e 6374 696f 6e2c  PYTHON function,
-0002a360: 2075 7365 206f 6e6c 7920 6966 2079 6f75   use only if you
-0002a370: 206e 6565 6420 7468 6973 2063 6f6d 7075   need this compu
-0002a380: 7461 7469 6f6e 2066 726f 6d0a 2020 2020  tation from.    
-0002a390: 5079 7468 6f6e 2c20 6966 2079 6f75 206e  Python, if you n
-0002a3a0: 6565 6420 6974 2066 726f 6d20 6379 7468  eed it from cyth
-0002a3b0: 6f6e 2c20 7573 6520 6064 6973 745f 6c6f  on, use `dist_lo
-0002a3c0: 735f 6369 7263 6c65 5f63 6f72 6560 0a20  s_circle_core`. 
-0002a3d0: 2020 2022 2222 0a20 2020 2063 6465 6620     """.    cdef 
-0002a3e0: 646f 7562 6c65 5b32 5d20 7265 730a 2020  double[2] res.  
-0002a3f0: 2020 5f64 742e 6469 7374 5f6c 6f73 5f63    _dt.dist_los_c
-0002a400: 6972 636c 655f 636f 7265 283c 646f 7562  ircle_core(<doub
-0002a410: 6c65 2a3e 7261 795f 7664 6972 2e64 6174  le*>ray_vdir.dat
-0002a420: 612c 0a20 2020 2020 2020 2020 2020 2020  a,.             
-0002a430: 2020 2020 2020 2020 2020 2020 2020 203c                 <
-0002a440: 646f 7562 6c65 2a3e 7261 795f 6f72 6967  double*>ray_orig
-0002a450: 2e64 6174 612c 0a20 2020 2020 2020 2020  .data,.         
-0002a460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a470: 2020 2072 6164 6975 732c 2063 6972 635f     radius, circ_
-0002a480: 7a2c 206e 6f72 6d5f 6469 722c 2072 6573  z, norm_dir, res
-0002a490: 290a 2020 2020 7265 7475 726e 206e 702e  ).    return np.
-0002a4a0: 6173 6172 7261 7928 7265 7329 0a0a 6465  asarray(res)..de
-0002a4b0: 6620 636f 6d70 5f64 6973 745f 6c6f 735f  f comp_dist_los_
-0002a4c0: 6369 7263 6c65 5f76 6563 2869 6e74 206e  circle_vec(int n
-0002a4d0: 6c6f 732c 2069 6e74 206e 6369 7263 6c65  los, int ncircle
-0002a4e0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-0002a4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a500: 6e70 2e6e 6461 7272 6179 5b64 6f75 626c  np.ndarray[doubl
-0002a510: 652c 6e64 696d 3d32 2c6d 6f64 653d 2763  e,ndim=2,mode='c
-0002a520: 275d 2064 6972 732c 0a20 2020 2020 2020  '] dirs,.       
-0002a530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a540: 2020 2020 2020 6e70 2e6e 6461 7272 6179        np.ndarray
-0002a550: 5b64 6f75 626c 652c 6e64 696d 3d32 2c6d  [double,ndim=2,m
-0002a560: 6f64 653d 2763 275d 206f 7269 732c 0a20  ode='c'] oris,. 
-0002a570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a580: 2020 2020 2020 2020 2020 2020 6e70 2e6e              np.n
-0002a590: 6461 7272 6179 5b64 6f75 626c 652c 6e64  darray[double,nd
-0002a5a0: 696d 3d31 2c6d 6f64 653d 2763 275d 2063  im=1,mode='c'] c
-0002a5b0: 6972 636c 655f 7261 6469 7573 2c0a 2020  ircle_radius,.  
-0002a5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a5d0: 2020 2020 2020 2020 2020 206e 702e 6e64             np.nd
-0002a5e0: 6172 7261 795b 646f 7562 6c65 2c6e 6469  array[double,ndi
-0002a5f0: 6d3d 312c 6d6f 6465 3d27 6327 5d20 6369  m=1,mode='c'] ci
-0002a600: 7263 6c65 5f7a 2c0a 2020 2020 2020 2020  rcle_z,.        
-0002a610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a620: 2020 2020 206e 702e 6e64 6172 7261 795b       np.ndarray[
-0002a630: 646f 7562 6c65 2c6e 6469 6d3d 312c 6d6f  double,ndim=1,mo
-0002a640: 6465 3d27 6327 5d20 6e6f 726d 5f64 6972  de='c'] norm_dir
-0002a650: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-0002a660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a670: 2020 2020 2020 696e 7420 6e75 6d5f 7468        int num_th
-0002a680: 7265 6164 733d 3438 293a 0a20 2020 2022  reads=48):.    "
-0002a690: 2222 0a20 2020 2054 6869 7320 6675 6e63  "".    This func
-0002a6a0: 7469 6f6e 2063 6f6d 7075 7465 7320 7468  tion computes th
-0002a6b0: 6520 696e 7465 7273 6563 7469 6f6e 206f  e intersection o
-0002a6c0: 6620 6120 5261 7920 286f 7220 4c69 6e65  f a Ray (or Line
-0002a6d0: 204f 6620 5369 6768 7429 0a20 2020 2061   Of Sight).    a
-0002a6e0: 6e64 2061 2063 6972 636c 6520 696e 2033  nd a circle in 3
-0002a6f0: 442e 2049 7420 7265 7475 726e 7320 606b  D. It returns `k
-0002a700: 6d69 6e60 2c20 7468 6520 636f 6566 6669  min`, the coeffi
-0002a710: 6369 656e 7420 7375 6368 2074 6861 7420  cient such that 
-0002a720: 7468 650a 2020 2020 7261 7920 6f66 206f  the.    ray of o
-0002a730: 7269 6769 6e20 4f20 3d20 5b6f 7269 312c  rigin O = [ori1,
-0002a740: 206f 7269 322c 206f 7269 335d 2061 6e64   ori2, ori3] and
-0002a750: 206f 6620 6469 7265 6374 696f 6e61 6c20   of directional 
-0002a760: 7665 6374 6f72 0a20 2020 2044 203d 205b  vector.    D = [
-0002a770: 6469 7231 2c20 6469 7232 2c20 6469 7233  dir1, dir2, dir3
-0002a780: 5d20 6973 2063 6c6f 7365 7374 2074 6f20  ] is closest to 
-0002a790: 7468 6520 6369 7263 6c65 206f 6620 7261  the circle of ra
-0002a7a0: 6469 7573 2060 7261 6469 7573 600a 2020  dius `radius`.  
-0002a7b0: 2020 616e 6420 6365 6e74 6572 6564 2060    and centered `
-0002a7c0: 2830 2c20 302c 2063 6972 635f 7a29 6020  (0, 0, circ_z)` 
-0002a7d0: 6174 2074 6865 2070 6f69 6e74 2050 203d  at the point P =
-0002a7e0: 204f 202b 206b 6d69 6e20 2a20 442e 0a20   O + kmin * D.. 
-0002a7f0: 2020 2054 6865 2076 6172 6961 626c 6520     The variable 
-0002a800: 606e 6f72 6d5f 6469 7260 2069 7320 7468  `norm_dir` is th
-0002a810: 6520 7371 7561 7265 6420 6e6f 726d 206f  e squared norm o
-0002a820: 6620 7468 6520 6469 7265 6374 696f 6e20  f the direction 
-0002a830: 6f66 2074 6865 2072 6179 2e0a 2020 2020  of the ray..    
-0002a840: 5468 6973 2069 7320 7468 6520 7665 6374  This is the vect
-0002a850: 6f72 6961 6c20 7665 7273 696f 6e2c 2077  orial version, w
-0002a860: 6520 6578 7065 6374 2074 6865 2064 6972  e expect the dir
-0002a870: 6563 7469 6f6e 7320 616e 6420 6f72 6967  ections and orig
-0002a880: 696e 7320 746f 2062 653a 0a20 2020 2064  ins to be:.    d
-0002a890: 6972 7320 3d20 5b5b 6469 7231 5f6c 6f73  irs = [[dir1_los
-0002a8a0: 312c 2064 6972 325f 6c6f 7331 2c20 6469  1, dir2_los1, di
-0002a8b0: 7233 5f6c 6f73 315d 2c20 5b64 6972 315f  r3_los1], [dir1_
-0002a8c0: 6c6f 7332 2c2e 2e2e 5d0a 2020 2020 6f72  los2,...].    or
-0002a8d0: 6973 203d 205b 5b6f 7269 315f 6c6f 7331  is = [[ori1_los1
-0002a8e0: 2c20 6f72 6932 5f6c 6f73 312c 206f 7269  , ori2_los1, ori
-0002a8f0: 335f 6c6f 7331 5d2c 205b 6f72 6931 5f6c  3_los1], [ori1_l
-0002a900: 6f73 322c 2e2e 2e5d 0a20 2020 2052 6574  os2,...].    Ret
-0002a910: 7572 6e73 0a20 2020 203d 3d3d 3d3d 3d3d  urns.    =======
-0002a920: 0a20 2020 2072 6573 203a 2028 322c 206e  .    res : (2, n
-0002a930: 6c6f 732c 206e 6369 7263 6c65 7329 0a20  los, ncircles). 
-0002a940: 2020 2020 2020 2072 6573 203d 205b 7265         res = [re
-0002a950: 735f 6b2c 2072 6573 5f64 5d20 7768 6572  s_k, res_d] wher
-0002a960: 6520 7265 735f 6b20 6973 2061 2028 6e6c  e res_k is a (nl
-0002a970: 6f73 2c20 6e63 6972 636c 6573 2920 6e75  os, ncircles) nu
-0002a980: 6d70 7920 6172 7261 790a 2020 2020 2020  mpy array.      
-0002a990: 2020 7769 7468 2074 6865 206b 2063 6f65    with the k coe
-0002a9a0: 6666 6963 6965 6e74 7320 666f 7220 6561  fficients for ea
-0002a9b0: 6368 204c 4f53 2077 6865 7265 2074 6865  ch LOS where the
-0002a9c0: 206d 696e 696d 756d 2064 6973 7461 6e63   minimum distanc
-0002a9d0: 650a 2020 2020 2020 2020 746f 2065 6163  e.        to eac
-0002a9e0: 6820 6369 7263 6c65 2069 7320 7265 6163  h circle is reac
-0002a9f0: 6865 640a 2020 2020 2020 2020 6973 206d  hed.        is m
-0002aa00: 6574 2066 6f72 2065 6163 6820 6369 7263  et for each circ
-0002aa10: 6c65 2c20 616e 6420 7265 735f 6420 6973  le, and res_d is
-0002aa20: 2061 2028 6e6c 6f73 2c20 6e63 6972 636c   a (nlos, ncircl
-0002aa30: 6573 2920 6e75 6d70 7920 6172 7261 790a  es) numpy array.
-0002aa40: 2020 2020 2020 2020 7769 7468 2074 6865          with the
-0002aa50: 2064 6973 7461 6e63 6520 6265 7477 6565   distance betwee
-0002aa60: 6e20 6561 6368 204c 4f53 2074 6f20 6561  n each LOS to ea
-0002aa70: 6368 2063 6972 636c 650a 2020 2020 2d2d  ch circle.    --
-0002aa80: 2d0a 2020 2020 5468 6973 2069 7320 7468  -.    This is th
-0002aa90: 6520 5059 5448 4f4e 2066 756e 6374 696f  e PYTHON functio
-0002aaa0: 6e2c 2075 7365 206f 6e6c 7920 6966 2079  n, use only if y
-0002aab0: 6f75 206e 6565 6420 7468 6973 2063 6f6d  ou need this com
-0002aac0: 7075 7461 7469 6f6e 2066 726f 6d0a 2020  putation from.  
-0002aad0: 2020 5079 7468 6f6e 2c20 6966 2079 6f75    Python, if you
-0002aae0: 206e 6565 6420 6974 2066 726f 6d20 6379   need it from cy
-0002aaf0: 7468 6f6e 2c20 7573 6520 6064 6973 745f  thon, use `dist_
-0002ab00: 6c6f 735f 6369 7263 6c65 5f63 6f72 6560  los_circle_core`
-0002ab10: 0a20 2020 2022 2222 0a20 2020 2063 6465  .    """.    cde
-0002ab20: 6620 6172 7261 7920 6b6d 696e 5f74 6162  f array kmin_tab
-0002ab30: 203d 2063 6c6f 6e65 2861 7272 6179 2827   = clone(array('
-0002ab40: 6427 292c 206e 6c6f 732a 6e63 6972 636c  d'), nlos*ncircl
-0002ab50: 6573 2c20 5472 7565 290a 2020 2020 6364  es, True).    cd
-0002ab60: 6566 2061 7272 6179 2064 6973 745f 7461  ef array dist_ta
-0002ab70: 6220 3d20 636c 6f6e 6528 6172 7261 7928  b = clone(array(
-0002ab80: 2764 2729 2c20 6e6c 6f73 2a6e 6369 7263  'd'), nlos*ncirc
-0002ab90: 6c65 732c 2054 7275 6529 0a0a 2020 2020  les, True)..    
-0002aba0: 6966 206e 6f72 6d5f 6469 7220 6973 204e  if norm_dir is N
-0002abb0: 6f6e 653a 0a20 2020 2020 2020 206e 6f72  one:.        nor
-0002abc0: 6d5f 6469 7220 3d20 2d6e 702e 6f6e 6573  m_dir = -np.ones
-0002abd0: 286e 6c6f 7329 0a20 2020 205f 6474 2e63  (nlos).    _dt.c
-0002abe0: 6f6d 705f 6469 7374 5f6c 6f73 5f63 6972  omp_dist_los_cir
-0002abf0: 636c 655f 7665 635f 636f 7265 286e 6c6f  cle_vec_core(nlo
-0002ac00: 732c 206e 6369 7263 6c65 732c 0a20 2020  s, ncircles,.   
-0002ac10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ac20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ac30: 2020 203c 646f 7562 6c65 2a3e 6469 7273     <double*>dirs
-0002ac40: 2e64 6174 612c 0a20 2020 2020 2020 2020  .data,.         
+00029d00: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00029d10: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00029d20: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00029d30: 0a64 6566 2063 6f6d 705f 6469 7374 5f6c  .def comp_dist_l
+00029d40: 6f73 5f63 6972 636c 6528 6e70 2e6e 6461  os_circle(np.nda
+00029d50: 7272 6179 5b64 6f75 626c 652c 6e64 696d  rray[double,ndim
+00029d60: 3d31 2c6d 6f64 653d 2763 275d 2072 6179  =1,mode='c'] ray
+00029d70: 5f76 6469 722c 0a20 2020 2020 2020 2020  _vdir,.         
+00029d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029d90: 6e70 2e6e 6461 7272 6179 5b64 6f75 626c  np.ndarray[doubl
+00029da0: 652c 6e64 696d 3d31 2c6d 6f64 653d 2763  e,ndim=1,mode='c
+00029db0: 275d 2072 6179 5f6f 7269 672c 0a20 2020  '] ray_orig,.   
+00029dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029dd0: 2020 2020 2020 646f 7562 6c65 2072 6164        double rad
+00029de0: 6975 732c 2064 6f75 626c 6520 6369 7263  ius, double circ
+00029df0: 5f7a 2c20 646f 7562 6c65 206e 6f72 6d5f  _z, double norm_
+00029e00: 6469 723d 2d31 2e30 293a 0a20 2020 2022  dir=-1.0):.    "
+00029e10: 2222 0a20 2020 2054 6869 7320 6675 6e63  "".    This func
+00029e20: 7469 6f6e 2063 6f6d 7075 7465 7320 7468  tion computes th
+00029e30: 6520 696e 7465 7273 6563 7469 6f6e 206f  e intersection o
+00029e40: 6620 6120 5261 7920 286f 7220 4c69 6e65  f a Ray (or Line
+00029e50: 204f 6620 5369 6768 7429 0a20 2020 2061   Of Sight).    a
+00029e60: 6e64 2061 2063 6972 636c 6520 696e 2033  nd a circle in 3
+00029e70: 442e 2049 7420 7265 7475 726e 7320 606b  D. It returns `k
+00029e80: 6d69 6e60 2061 6e64 2060 6469 7374 602e  min` and `dist`.
+00029e90: 2057 6865 7265 2060 6b6d 696e 6020 6973   Where `kmin` is
+00029ea0: 2074 6865 0a20 2020 2063 6f65 6666 6963   the.    coeffic
+00029eb0: 6965 6e74 2073 7563 6820 7468 6174 2074  ient such that t
+00029ec0: 6865 2072 6179 206f 6620 6f72 6967 696e  he ray of origin
+00029ed0: 204f 203d 205b 6f72 6931 2c20 6f72 6932   O = [ori1, ori2
+00029ee0: 2c20 6f72 6933 5d0a 2020 2020 616e 6420  , ori3].    and 
+00029ef0: 6f66 2064 6972 6563 7469 6f6e 616c 2076  of directional v
+00029f00: 6563 746f 7220 4420 3d20 5b64 6972 312c  ector D = [dir1,
+00029f10: 2064 6972 322c 2064 6972 335d 2069 7320   dir2, dir3] is 
+00029f20: 636c 6f73 6573 7420 746f 2074 6865 2063  closest to the c
+00029f30: 6972 636c 650a 2020 2020 206f 6620 7261  ircle.     of ra
+00029f40: 6469 7573 2060 7261 6469 7573 6020 616e  dius `radius` an
+00029f50: 6420 6365 6e74 6572 6564 2060 2830 2c20  d centered `(0, 
+00029f60: 302c 2063 6972 635f 7a29 6020 6174 2074  0, circ_z)` at t
+00029f70: 6865 2070 6f69 6e74 0a20 2020 2050 203d  he point.    P =
+00029f80: 204f 202b 206b 6d69 6e20 2a20 442e 0a20   O + kmin * D.. 
+00029f90: 2020 2041 6e64 2060 6469 7374 616e 6365     And `distance
+00029fa0: 6020 7468 6520 6469 7374 616e 6365 2062  ` the distance b
+00029fb0: 6574 7765 656e 2074 6865 2074 776f 2063  etween the two c
+00029fc0: 6c6f 7365 7374 2070 6f69 6e74 7320 286c  losest points (l
+00029fd0: 696e 6520 636c 6f73 6573 740a 2020 2020  ine closest.    
+00029fe0: 616e 6420 6369 7263 6c65 2063 6c6f 7365  and circle close
+00029ff0: 7374 290a 2020 2020 5468 6520 7661 7269  st).    The vari
+0002a000: 6162 6c65 2060 6e6f 726d 5f64 6972 6020  able `norm_dir` 
+0002a010: 6973 2074 6865 2073 7175 6172 6564 206e  is the squared n
+0002a020: 6f72 6d20 6f66 2074 6865 2064 6972 6563  orm of the direc
+0002a030: 7469 6f6e 206f 6620 7468 6520 7261 792e  tion of the ray.
+0002a040: 0a20 2020 2050 6172 616d 730a 2020 2020  .    Params.    
+0002a050: 3d3d 3d3d 3d0a 2020 2020 7261 795f 7664  =====.    ray_vd
+0002a060: 6972 3a20 2833 2920 646f 7562 6c65 2061  ir: (3) double a
+0002a070: 7272 6179 0a20 2020 2020 2020 2072 6179  rray.        ray
+0002a080: 2773 2064 6972 6563 746f 7220 7665 6374  's director vect
+0002a090: 6f72 2056 2073 7563 6820 7468 6174 2050  or V such that P
+0002a0a0: 205c 696e 2052 6179 2069 6666 2050 2874   \in Ray iff P(t
+0002a0b0: 2920 3d20 4f20 2b20 742a 560a 2020 2020  ) = O + t*V.    
+0002a0c0: 7261 795f 6f72 6967 203a 2028 3329 2064  ray_orig : (3) d
+0002a0d0: 6f75 626c 6520 6172 7261 790a 2020 2020  ouble array.    
+0002a0e0: 2020 2020 7261 7927 7320 6f72 6967 696e      ray's origin
+0002a0f0: 2063 6f6f 7264 696e 6174 6573 204f 2073   coordinates O s
+0002a100: 7563 6820 7468 6174 2050 205c 696e 2052  uch that P \in R
+0002a110: 6179 2069 6666 2050 2874 2920 3d20 4f20  ay iff P(t) = O 
+0002a120: 2b20 742a 560a 2020 2020 7261 6469 7573  + t*V.    radius
+0002a130: 203a 2064 6f75 626c 650a 2020 2020 2020   : double.      
+0002a140: 2020 7261 6469 7573 2072 206f 6620 686f    radius r of ho
+0002a150: 7269 7a6f 6e74 616c 2063 6972 636c 6520  rizontal circle 
+0002a160: 6365 6e74 6572 6564 2069 6e20 2830 2c30  centered in (0,0
+0002a170: 2c63 6972 635f 7a29 0a20 2020 2063 6972  ,circ_z).    cir
+0002a180: 635f 7a20 3a20 646f 7562 6c65 0a20 2020  c_z : double.   
+0002a190: 2020 2020 2033 7264 2063 6f6f 7264 696e       3rd coordin
+0002a1a0: 6174 6520 6f66 2068 6f72 697a 6f6e 7461  ate of horizonta
+0002a1b0: 6c20 6369 7263 6c65 2063 656e 7465 7265  l circle centere
+0002a1c0: 6420 696e 2028 302c 302c 6369 7263 5f7a  d in (0,0,circ_z
+0002a1d0: 2920 6f66 2072 6164 6975 7320 720a 2020  ) of radius r.  
+0002a1e0: 2020 6e6f 726d 5f64 6972 203a 2064 6f75    norm_dir : dou
+0002a1f0: 626c 6520 286f 7074 696f 6e61 6c29 0a20  ble (optional). 
+0002a200: 2020 2020 2020 2049 6620 666f 7220 636f         If for co
+0002a210: 6d70 7574 6174 696f 6e20 7265 6173 6f6e  mputation reason
+0002a220: 7320 6974 206d 616b 6573 2073 656e 7365  s it makes sense
+0002a230: 2c20 796f 7520 6361 6e20 7061 7373 2074  , you can pass t
+0002a240: 6865 206e 6f72 6d20 6f66 2074 6865 0a20  he norm of the. 
+0002a250: 2020 2020 2020 2064 6972 6563 746f 7220         director 
+0002a260: 7665 6374 6f72 0a20 2020 2052 6574 7572  vector.    Retur
+0002a270: 6e73 0a20 2020 203d 3d3d 3d3d 3d3d 0a20  ns.    =======. 
+0002a280: 2020 2072 6573 756c 7420 3a20 646f 7562     result : doub
+0002a290: 6c65 2028 3229 2061 7272 6179 0a20 2020  le (2) array.   
+0002a2a0: 2020 2020 2d20 7265 7375 6c74 5b30 5d20      - result[0] 
+0002a2b0: 7769 6c6c 2063 6f6e 7461 696e 2074 6865  will contain the
+0002a2c0: 206b 2063 6f65 6666 6963 6965 6e74 2074   k coefficient t
+0002a2d0: 6f20 6669 6e64 2074 6865 206c 696e 6520  o find the line 
+0002a2e0: 706f 696e 7420 636c 6f73 6573 740a 2020  point closest.  
+0002a2f0: 2020 2020 2063 6c6f 7365 7374 2070 6f69       closest poi
+0002a300: 6e74 0a20 2020 2020 2020 2d20 7265 7375  nt.       - resu
+0002a310: 6c74 5b31 5d20 7769 6c6c 2063 6f6e 7461  lt[1] will conta
+0002a320: 696e 2074 6865 2044 4953 5441 4e43 4520  in the DISTANCE 
+0002a330: 6672 6f6d 206c 696e 6520 636c 6f73 6573  from line closes
+0002a340: 7420 706f 696e 7420 746f 2063 6972 636c  t point to circl
+0002a350: 650a 2020 2020 2020 2074 6f20 7468 6520  e.       to the 
+0002a360: 6369 7263 6c65 0a20 2020 202d 2d2d 0a20  circle.    ---. 
+0002a370: 2020 2054 6869 7320 6973 2074 6865 2050     This is the P
+0002a380: 5954 484f 4e20 6675 6e63 7469 6f6e 2c20  YTHON function, 
+0002a390: 7573 6520 6f6e 6c79 2069 6620 796f 7520  use only if you 
+0002a3a0: 6e65 6564 2074 6869 7320 636f 6d70 7574  need this comput
+0002a3b0: 6174 696f 6e20 6672 6f6d 0a20 2020 2050  ation from.    P
+0002a3c0: 7974 686f 6e2c 2069 6620 796f 7520 6e65  ython, if you ne
+0002a3d0: 6564 2069 7420 6672 6f6d 2063 7974 686f  ed it from cytho
+0002a3e0: 6e2c 2075 7365 2060 6469 7374 5f6c 6f73  n, use `dist_los
+0002a3f0: 5f63 6972 636c 655f 636f 7265 600a 2020  _circle_core`.  
+0002a400: 2020 2222 220a 2020 2020 6364 6566 2064    """.    cdef d
+0002a410: 6f75 626c 655b 325d 2072 6573 0a20 2020  ouble[2] res.   
+0002a420: 205f 6474 2e64 6973 745f 6c6f 735f 6369   _dt.dist_los_ci
+0002a430: 7263 6c65 5f63 6f72 6528 3c64 6f75 626c  rcle_core(<doubl
+0002a440: 652a 3e72 6179 5f76 6469 722e 6461 7461  e*>ray_vdir.data
+0002a450: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002a460: 2020 2020 2020 2020 2020 2020 2020 3c64                <d
+0002a470: 6f75 626c 652a 3e72 6179 5f6f 7269 672e  ouble*>ray_orig.
+0002a480: 6461 7461 2c0a 2020 2020 2020 2020 2020  data,.          
+0002a490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a4a0: 2020 7261 6469 7573 2c20 6369 7263 5f7a    radius, circ_z
+0002a4b0: 2c20 6e6f 726d 5f64 6972 2c20 7265 7329  , norm_dir, res)
+0002a4c0: 0a20 2020 2072 6574 7572 6e20 6e70 2e61  .    return np.a
+0002a4d0: 7361 7272 6179 2872 6573 290a 0a64 6566  sarray(res)..def
+0002a4e0: 2063 6f6d 705f 6469 7374 5f6c 6f73 5f63   comp_dist_los_c
+0002a4f0: 6972 636c 655f 7665 6328 696e 7420 6e6c  ircle_vec(int nl
+0002a500: 6f73 2c20 696e 7420 6e63 6972 636c 6573  os, int ncircles
+0002a510: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002a520: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0002a530: 702e 6e64 6172 7261 795b 646f 7562 6c65  p.ndarray[double
+0002a540: 2c6e 6469 6d3d 322c 6d6f 6465 3d27 6327  ,ndim=2,mode='c'
+0002a550: 5d20 6469 7273 2c0a 2020 2020 2020 2020  ] dirs,.        
+0002a560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a570: 2020 2020 206e 702e 6e64 6172 7261 795b       np.ndarray[
+0002a580: 646f 7562 6c65 2c6e 6469 6d3d 322c 6d6f  double,ndim=2,mo
+0002a590: 6465 3d27 6327 5d20 6f72 6973 2c0a 2020  de='c'] oris,.  
+0002a5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a5b0: 2020 2020 2020 2020 2020 206e 702e 6e64             np.nd
+0002a5c0: 6172 7261 795b 646f 7562 6c65 2c6e 6469  array[double,ndi
+0002a5d0: 6d3d 312c 6d6f 6465 3d27 6327 5d20 6369  m=1,mode='c'] ci
+0002a5e0: 7263 6c65 5f72 6164 6975 732c 0a20 2020  rcle_radius,.   
+0002a5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a600: 2020 2020 2020 2020 2020 6e70 2e6e 6461            np.nda
+0002a610: 7272 6179 5b64 6f75 626c 652c 6e64 696d  rray[double,ndim
+0002a620: 3d31 2c6d 6f64 653d 2763 275d 2063 6972  =1,mode='c'] cir
+0002a630: 636c 655f 7a2c 0a20 2020 2020 2020 2020  cle_z,.         
+0002a640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a650: 2020 2020 6e70 2e6e 6461 7272 6179 5b64      np.ndarray[d
+0002a660: 6f75 626c 652c 6e64 696d 3d31 2c6d 6f64  ouble,ndim=1,mod
+0002a670: 653d 2763 275d 206e 6f72 6d5f 6469 7220  e='c'] norm_dir 
+0002a680: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+0002a690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a6a0: 2020 2020 2069 6e74 206e 756d 5f74 6872       int num_thr
+0002a6b0: 6561 6473 3d34 3829 3a0a 2020 2020 2222  eads=48):.    ""
+0002a6c0: 220a 2020 2020 5468 6973 2066 756e 6374  ".    This funct
+0002a6d0: 696f 6e20 636f 6d70 7574 6573 2074 6865  ion computes the
+0002a6e0: 2069 6e74 6572 7365 6374 696f 6e20 6f66   intersection of
+0002a6f0: 2061 2052 6179 2028 6f72 204c 696e 6520   a Ray (or Line 
+0002a700: 4f66 2053 6967 6874 290a 2020 2020 616e  Of Sight).    an
+0002a710: 6420 6120 6369 7263 6c65 2069 6e20 3344  d a circle in 3D
+0002a720: 2e20 4974 2072 6574 7572 6e73 2060 6b6d  . It returns `km
+0002a730: 696e 602c 2074 6865 2063 6f65 6666 6963  in`, the coeffic
+0002a740: 6965 6e74 2073 7563 6820 7468 6174 2074  ient such that t
+0002a750: 6865 0a20 2020 2072 6179 206f 6620 6f72  he.    ray of or
+0002a760: 6967 696e 204f 203d 205b 6f72 6931 2c20  igin O = [ori1, 
+0002a770: 6f72 6932 2c20 6f72 6933 5d20 616e 6420  ori2, ori3] and 
+0002a780: 6f66 2064 6972 6563 7469 6f6e 616c 2076  of directional v
+0002a790: 6563 746f 720a 2020 2020 4420 3d20 5b64  ector.    D = [d
+0002a7a0: 6972 312c 2064 6972 322c 2064 6972 335d  ir1, dir2, dir3]
+0002a7b0: 2069 7320 636c 6f73 6573 7420 746f 2074   is closest to t
+0002a7c0: 6865 2063 6972 636c 6520 6f66 2072 6164  he circle of rad
+0002a7d0: 6975 7320 6072 6164 6975 7360 0a20 2020  ius `radius`.   
+0002a7e0: 2061 6e64 2063 656e 7465 7265 6420 6028   and centered `(
+0002a7f0: 302c 2030 2c20 6369 7263 5f7a 2960 2061  0, 0, circ_z)` a
+0002a800: 7420 7468 6520 706f 696e 7420 5020 3d20  t the point P = 
+0002a810: 4f20 2b20 6b6d 696e 202a 2044 2e0a 2020  O + kmin * D..  
+0002a820: 2020 5468 6520 7661 7269 6162 6c65 2060    The variable `
+0002a830: 6e6f 726d 5f64 6972 6020 6973 2074 6865  norm_dir` is the
+0002a840: 2073 7175 6172 6564 206e 6f72 6d20 6f66   squared norm of
+0002a850: 2074 6865 2064 6972 6563 7469 6f6e 206f   the direction o
+0002a860: 6620 7468 6520 7261 792e 0a20 2020 2054  f the ray..    T
+0002a870: 6869 7320 6973 2074 6865 2076 6563 746f  his is the vecto
+0002a880: 7269 616c 2076 6572 7369 6f6e 2c20 7765  rial version, we
+0002a890: 2065 7870 6563 7420 7468 6520 6469 7265   expect the dire
+0002a8a0: 6374 696f 6e73 2061 6e64 206f 7269 6769  ctions and origi
+0002a8b0: 6e73 2074 6f20 6265 3a0a 2020 2020 6469  ns to be:.    di
+0002a8c0: 7273 203d 205b 5b64 6972 315f 6c6f 7331  rs = [[dir1_los1
+0002a8d0: 2c20 6469 7232 5f6c 6f73 312c 2064 6972  , dir2_los1, dir
+0002a8e0: 335f 6c6f 7331 5d2c 205b 6469 7231 5f6c  3_los1], [dir1_l
+0002a8f0: 6f73 322c 2e2e 2e5d 0a20 2020 206f 7269  os2,...].    ori
+0002a900: 7320 3d20 5b5b 6f72 6931 5f6c 6f73 312c  s = [[ori1_los1,
+0002a910: 206f 7269 325f 6c6f 7331 2c20 6f72 6933   ori2_los1, ori3
+0002a920: 5f6c 6f73 315d 2c20 5b6f 7269 315f 6c6f  _los1], [ori1_lo
+0002a930: 7332 2c2e 2e2e 5d0a 2020 2020 5265 7475  s2,...].    Retu
+0002a940: 726e 730a 2020 2020 3d3d 3d3d 3d3d 3d0a  rns.    =======.
+0002a950: 2020 2020 7265 7320 3a20 2832 2c20 6e6c      res : (2, nl
+0002a960: 6f73 2c20 6e63 6972 636c 6573 290a 2020  os, ncircles).  
+0002a970: 2020 2020 2020 7265 7320 3d20 5b72 6573        res = [res
+0002a980: 5f6b 2c20 7265 735f 645d 2077 6865 7265  _k, res_d] where
+0002a990: 2072 6573 5f6b 2069 7320 6120 286e 6c6f   res_k is a (nlo
+0002a9a0: 732c 206e 6369 7263 6c65 7329 206e 756d  s, ncircles) num
+0002a9b0: 7079 2061 7272 6179 0a20 2020 2020 2020  py array.       
+0002a9c0: 2077 6974 6820 7468 6520 6b20 636f 6566   with the k coef
+0002a9d0: 6669 6369 656e 7473 2066 6f72 2065 6163  ficients for eac
+0002a9e0: 6820 4c4f 5320 7768 6572 6520 7468 6520  h LOS where the 
+0002a9f0: 6d69 6e69 6d75 6d20 6469 7374 616e 6365  minimum distance
+0002aa00: 0a20 2020 2020 2020 2074 6f20 6561 6368  .        to each
+0002aa10: 2063 6972 636c 6520 6973 2072 6561 6368   circle is reach
+0002aa20: 6564 0a20 2020 2020 2020 2069 7320 6d65  ed.        is me
+0002aa30: 7420 666f 7220 6561 6368 2063 6972 636c  t for each circl
+0002aa40: 652c 2061 6e64 2072 6573 5f64 2069 7320  e, and res_d is 
+0002aa50: 6120 286e 6c6f 732c 206e 6369 7263 6c65  a (nlos, ncircle
+0002aa60: 7329 206e 756d 7079 2061 7272 6179 0a20  s) numpy array. 
+0002aa70: 2020 2020 2020 2077 6974 6820 7468 6520         with the 
+0002aa80: 6469 7374 616e 6365 2062 6574 7765 656e  distance between
+0002aa90: 2065 6163 6820 4c4f 5320 746f 2065 6163   each LOS to eac
+0002aaa0: 6820 6369 7263 6c65 0a20 2020 202d 2d2d  h circle.    ---
+0002aab0: 0a20 2020 2054 6869 7320 6973 2074 6865  .    This is the
+0002aac0: 2050 5954 484f 4e20 6675 6e63 7469 6f6e   PYTHON function
+0002aad0: 2c20 7573 6520 6f6e 6c79 2069 6620 796f  , use only if yo
+0002aae0: 7520 6e65 6564 2074 6869 7320 636f 6d70  u need this comp
+0002aaf0: 7574 6174 696f 6e20 6672 6f6d 0a20 2020  utation from.   
+0002ab00: 2050 7974 686f 6e2c 2069 6620 796f 7520   Python, if you 
+0002ab10: 6e65 6564 2069 7420 6672 6f6d 2063 7974  need it from cyt
+0002ab20: 686f 6e2c 2075 7365 2060 6469 7374 5f6c  hon, use `dist_l
+0002ab30: 6f73 5f63 6972 636c 655f 636f 7265 600a  os_circle_core`.
+0002ab40: 2020 2020 2222 220a 2020 2020 6364 6566      """.    cdef
+0002ab50: 2061 7272 6179 206b 6d69 6e5f 7461 6220   array kmin_tab 
+0002ab60: 3d20 636c 6f6e 6528 6172 7261 7928 2764  = clone(array('d
+0002ab70: 2729 2c20 6e6c 6f73 2a6e 6369 7263 6c65  '), nlos*ncircle
+0002ab80: 732c 2054 7275 6529 0a20 2020 2063 6465  s, True).    cde
+0002ab90: 6620 6172 7261 7920 6469 7374 5f74 6162  f array dist_tab
+0002aba0: 203d 2063 6c6f 6e65 2861 7272 6179 2827   = clone(array('
+0002abb0: 6427 292c 206e 6c6f 732a 6e63 6972 636c  d'), nlos*ncircl
+0002abc0: 6573 2c20 5472 7565 290a 0a20 2020 2069  es, True)..    i
+0002abd0: 6620 6e6f 726d 5f64 6972 2069 7320 4e6f  f norm_dir is No
+0002abe0: 6e65 3a0a 2020 2020 2020 2020 6e6f 726d  ne:.        norm
+0002abf0: 5f64 6972 203d 202d 6e70 2e6f 6e65 7328  _dir = -np.ones(
+0002ac00: 6e6c 6f73 290a 2020 2020 5f64 742e 636f  nlos).    _dt.co
+0002ac10: 6d70 5f64 6973 745f 6c6f 735f 6369 7263  mp_dist_los_circ
+0002ac20: 6c65 5f76 6563 5f63 6f72 6528 6e6c 6f73  le_vec_core(nlos
+0002ac30: 2c20 6e63 6972 636c 6573 2c0a 2020 2020  , ncircles,.    
+0002ac40: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0002ac50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ac60: 2020 2020 2020 2020 2020 2020 203c 646f               <do
-0002ac70: 7562 6c65 2a3e 6f72 6973 2e64 6174 612c  uble*>oris.data,
-0002ac80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002ac90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002aca0: 2020 2020 2020 203c 646f 7562 6c65 2a3e         <double*>
-0002acb0: 6369 7263 6c65 5f72 6164 6975 732e 6461  circle_radius.da
-0002acc0: 7461 2c0a 2020 2020 2020 2020 2020 2020  ta,.            
-0002acd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ace0: 2020 2020 2020 2020 2020 3c64 6f75 626c            <doubl
-0002acf0: 652a 3e63 6972 636c 655f 7a2e 6461 7461  e*>circle_z.data
-0002ad00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002ad10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ad20: 2020 2020 2020 2020 3c64 6f75 626c 652a          <double*
-0002ad30: 3e6e 6f72 6d5f 6469 722e 6461 7461 2c0a  >norm_dir.data,.
+0002ac60: 2020 3c64 6f75 626c 652a 3e64 6972 732e    <double*>dirs.
+0002ac70: 6461 7461 2c0a 2020 2020 2020 2020 2020  data,.          
+0002ac80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ac90: 2020 2020 2020 2020 2020 2020 3c64 6f75              <dou
+0002aca0: 626c 652a 3e6f 7269 732e 6461 7461 2c0a  ble*>oris.data,.
+0002acb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002acc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002acd0: 2020 2020 2020 3c64 6f75 626c 652a 3e63        <double*>c
+0002ace0: 6972 636c 655f 7261 6469 7573 2e64 6174  ircle_radius.dat
+0002acf0: 612c 0a20 2020 2020 2020 2020 2020 2020  a,.             
+0002ad00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ad10: 2020 2020 2020 2020 203c 646f 7562 6c65           <double
+0002ad20: 2a3e 6369 7263 6c65 5f7a 2e64 6174 612c  *>circle_z.data,
+0002ad30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 0002ad40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ad50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ad60: 2020 2020 2020 6b6d 696e 5f74 6162 2c20        kmin_tab, 
-0002ad70: 6469 7374 5f74 6162 2c20 6e75 6d5f 7468  dist_tab, num_th
-0002ad80: 7265 6164 7329 0a20 2020 2072 6574 7572  reads).    retur
-0002ad90: 6e20 6e70 2e61 7361 7272 6179 286b 6d69  n np.asarray(kmi
-0002ada0: 6e5f 7461 6229 2e72 6573 6861 7065 286e  n_tab).reshape(n
-0002adb0: 6c6f 732c 206e 6369 7263 6c65 7329 2c20  los, ncircles), 
-0002adc0: 5c0a 2020 2020 2020 2020 6e70 2e61 7361  \.        np.asa
-0002add0: 7272 6179 2864 6973 745f 7461 6229 2e72  rray(dist_tab).r
-0002ade0: 6573 6861 7065 286e 6c6f 732c 206e 6369  eshape(nlos, nci
-0002adf0: 7263 6c65 7329 0a0a 0a23 203d 3d3d 3d3d  rcles)...# =====
-0002ae00: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002ae10: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002ae20: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002ad50: 2020 2020 2020 203c 646f 7562 6c65 2a3e         <double*>
+0002ad60: 6e6f 726d 5f64 6972 2e64 6174 612c 0a20  norm_dir.data,. 
+0002ad70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ad80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ad90: 2020 2020 206b 6d69 6e5f 7461 622c 2064       kmin_tab, d
+0002ada0: 6973 745f 7461 622c 206e 756d 5f74 6872  ist_tab, num_thr
+0002adb0: 6561 6473 290a 2020 2020 7265 7475 726e  eads).    return
+0002adc0: 206e 702e 6173 6172 7261 7928 6b6d 696e   np.asarray(kmin
+0002add0: 5f74 6162 292e 7265 7368 6170 6528 6e6c  _tab).reshape(nl
+0002ade0: 6f73 2c20 6e63 6972 636c 6573 292c 205c  os, ncircles), \
+0002adf0: 0a20 2020 2020 2020 206e 702e 6173 6172  .        np.asar
+0002ae00: 7261 7928 6469 7374 5f74 6162 292e 7265  ray(dist_tab).re
+0002ae10: 7368 6170 6528 6e6c 6f73 2c20 6e63 6972  shape(nlos, ncir
+0002ae20: 636c 6573 290a 0a0a 2320 3d3d 3d3d 3d3d  cles)...# ======
 0002ae30: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002ae40: 3d3d 3d3d 3d3d 3d3d 3d0a 230a 2320 2020  =========.#.#   
-0002ae50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ae60: 2020 2020 5445 5354 2043 4c4f 5345 4e45      TEST CLOSENE
-0002ae70: 5353 2043 4952 434c 4520 2d20 4c4f 530a  SS CIRCLE - LOS.
-0002ae80: 230a 2320 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  #.# ============
-0002ae90: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002aea0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002aeb0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002ae40: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002ae50: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002ae60: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002ae70: 3d3d 3d3d 3d3d 3d3d 0a23 0a23 2020 2020  ========.#.#    
+0002ae80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ae90: 2020 2054 4553 5420 434c 4f53 454e 4553     TEST CLOSENES
+0002aea0: 5320 4349 5243 4c45 202d 204c 4f53 0a23  S CIRCLE - LOS.#
+0002aeb0: 0a23 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  .# =============
 0002aec0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002aed0: 3d3d 0a0a 6465 6620 6973 5f63 6c6f 7365  ==..def is_close
-0002aee0: 5f6c 6f73 5f63 6972 636c 6528 6e70 2e6e  _los_circle(np.n
-0002aef0: 6461 7272 6179 5b64 6f75 626c 652c 6e64  darray[double,nd
-0002af00: 696d 3d31 2c6d 6f64 653d 2763 275d 2072  im=1,mode='c'] r
-0002af10: 6179 5f76 6469 722c 0a20 2020 2020 2020  ay_vdir,.       
-0002af20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002af30: 206e 702e 6e64 6172 7261 795b 646f 7562   np.ndarray[doub
-0002af40: 6c65 2c6e 6469 6d3d 312c 6d6f 6465 3d27  le,ndim=1,mode='
-0002af50: 6327 5d20 7261 795f 6f72 6967 2c0a 2020  c'] ray_orig,.  
-0002af60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002af70: 2020 2020 2020 646f 7562 6c65 2072 6164        double rad
-0002af80: 6975 732c 2064 6f75 626c 6520 6369 7263  ius, double circ
-0002af90: 5f7a 2c20 646f 7562 6c65 2065 7073 2c0a  _z, double eps,.
-0002afa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002afb0: 2020 2020 2020 2020 646f 7562 6c65 206e          double n
-0002afc0: 6f72 6d5f 6469 723d 2d31 2e30 293a 0a20  orm_dir=-1.0):. 
-0002afd0: 2020 2022 2222 0a20 2020 2054 6869 7320     """.    This 
-0002afe0: 6675 6e63 7469 6f6e 2063 6865 636b 7320  function checks 
-0002aff0: 6966 2061 7420 6d61 7869 6d75 6d20 6120  if at maximum a 
-0002b000: 4c4f 5320 6973 2061 7420 6120 6469 7374  LOS is at a dist
-0002b010: 616e 6365 2065 7073 696c 6f6e 0a20 2020  ance epsilon.   
-0002b020: 2066 6f72 6d20 6120 6369 726c 6365 0a20   form a cirlce. 
-0002b030: 2020 2054 6865 2072 6573 756c 7420 6973     The result is
-0002b040: 2054 7275 6520 7768 656e 2064 6973 7461   True when dista
-0002b050: 6e63 6520 3c20 6570 7369 6c6f 6e0a 2020  nce < epsilon.  
-0002b060: 2020 2d2d 2d0a 2020 2020 5468 6973 2069    ---.    This i
-0002b070: 7320 7468 6520 5059 5448 4f4e 2066 756e  s the PYTHON fun
-0002b080: 6374 696f 6e2c 2075 7365 206f 6e6c 7920  ction, use only 
-0002b090: 6966 2079 6f75 206e 6565 6420 7468 6973  if you need this
-0002b0a0: 2063 6f6d 7075 7461 7469 6f6e 2066 726f   computation fro
-0002b0b0: 6d0a 2020 2020 5079 7468 6f6e 2c20 6966  m.    Python, if
-0002b0c0: 2079 6f75 206e 6565 6420 6974 2066 726f   you need it fro
-0002b0d0: 6d20 6379 7468 6f6e 2c20 7573 6520 6069  m cython, use `i
-0002b0e0: 735f 6c6f 735f 636c 6f73 655f 6369 7263  s_los_close_circ
-0002b0f0: 6c65 5f63 6f72 6560 0a20 2020 2022 2222  le_core`.    """
-0002b100: 0a20 2020 2072 6574 7572 6e20 5f64 742e  .    return _dt.
-0002b110: 6973 5f63 6c6f 7365 5f6c 6f73 5f63 6972  is_close_los_cir
-0002b120: 636c 655f 636f 7265 283c 646f 7562 6c65  cle_core(<double
-0002b130: 2a3e 7261 795f 7664 6972 2e64 6174 612c  *>ray_vdir.data,
-0002b140: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002b150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b160: 2020 2020 2020 2020 203c 646f 7562 6c65           <double
-0002b170: 2a3e 7261 795f 6f72 6967 2e64 6174 612c  *>ray_orig.data,
-0002b180: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002b190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b1a0: 2020 2020 2020 2020 2072 6164 6975 732c           radius,
-0002b1b0: 2063 6972 635f 7a2c 206e 6f72 6d5f 6469   circ_z, norm_di
-0002b1c0: 722c 2065 7073 290a 0a64 6566 2069 735f  r, eps)..def is_
-0002b1d0: 636c 6f73 655f 6c6f 735f 6369 7263 6c65  close_los_circle
-0002b1e0: 5f76 6563 2869 6e74 206e 6c6f 732c 2069  _vec(int nlos, i
-0002b1f0: 6e74 206e 6369 7263 6c65 732c 2064 6f75  nt ncircles, dou
-0002b200: 626c 6520 6570 7369 6c6f 6e2c 0a20 2020  ble epsilon,.   
-0002b210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b220: 2020 2020 2020 2020 2020 6e70 2e6e 6461            np.nda
-0002b230: 7272 6179 5b64 6f75 626c 652c 6e64 696d  rray[double,ndim
-0002b240: 3d32 2c6d 6f64 653d 2763 275d 2064 6972  =2,mode='c'] dir
-0002b250: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-0002b260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b270: 6e70 2e6e 6461 7272 6179 5b64 6f75 626c  np.ndarray[doubl
-0002b280: 652c 6e64 696d 3d32 2c6d 6f64 653d 2763  e,ndim=2,mode='c
-0002b290: 275d 206f 7269 732c 0a20 2020 2020 2020  '] oris,.       
-0002b2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b2b0: 2020 2020 2020 6e70 2e6e 6461 7272 6179        np.ndarray
-0002b2c0: 5b64 6f75 626c 652c 6e64 696d 3d31 2c6d  [double,ndim=1,m
-0002b2d0: 6f64 653d 2763 275d 2063 6972 636c 655f  ode='c'] circle_
-0002b2e0: 7261 6469 7573 2c0a 2020 2020 2020 2020  radius,.        
-0002b2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b300: 2020 2020 206e 702e 6e64 6172 7261 795b       np.ndarray[
-0002b310: 646f 7562 6c65 2c6e 6469 6d3d 312c 6d6f  double,ndim=1,mo
-0002b320: 6465 3d27 6327 5d20 6369 7263 6c65 5f7a  de='c'] circle_z
-0002b330: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002b340: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0002b350: 702e 6e64 6172 7261 795b 646f 7562 6c65  p.ndarray[double
-0002b360: 2c6e 6469 6d3d 312c 6d6f 6465 3d27 6327  ,ndim=1,mode='c'
-0002b370: 5d20 6e6f 726d 5f64 6972 3d4e 6f6e 652c  ] norm_dir=None,
-0002b380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002b390: 2020 2020 2020 2020 2020 2020 2020 696e                in
-0002b3a0: 7420 6e75 6d5f 7468 7265 6164 733d 3438  t num_threads=48
-0002b3b0: 293a 0a20 2020 2022 2222 0a20 2020 2054  ):.    """.    T
-0002b3c0: 6869 7320 6675 6e63 7469 6f6e 2063 6865  his function che
-0002b3d0: 636b 7320 6966 2061 7420 6d61 7869 6d75  cks if at maximu
-0002b3e0: 6d20 6120 4c4f 5320 6973 2061 7420 6120  m a LOS is at a 
-0002b3f0: 6469 7374 616e 6365 2065 7073 696c 6f6e  distance epsilon
-0002b400: 0a20 2020 2066 6f72 6d20 6120 6369 726c  .    form a cirl
-0002b410: 6365 2e20 5665 6374 6f72 6961 6c20 7665  ce. Vectorial ve
-0002b420: 7273 696f 6e0a 2020 2020 5468 6520 7265  rsion.    The re
-0002b430: 7375 6c74 2069 7320 5472 7565 2077 6865  sult is True whe
-0002b440: 6e20 6469 7374 616e 6365 203c 2065 7073  n distance < eps
-0002b450: 696c 6f6e 0a20 2020 202d 2d2d 0a20 2020  ilon.    ---.   
-0002b460: 2054 6869 7320 6973 2074 6865 2050 5954   This is the PYT
-0002b470: 484f 4e20 6675 6e63 7469 6f6e 2c20 7573  HON function, us
-0002b480: 6520 6f6e 6c79 2069 6620 796f 7520 6e65  e only if you ne
-0002b490: 6564 2074 6869 7320 636f 6d70 7574 6174  ed this computat
-0002b4a0: 696f 6e20 6672 6f6d 0a20 2020 2050 7974  ion from.    Pyt
-0002b4b0: 686f 6e2c 2069 6620 796f 7520 6e65 6564  hon, if you need
-0002b4c0: 2069 7420 6672 6f6d 2063 7974 686f 6e2c   it from cython,
-0002b4d0: 2075 7365 2060 6973 5f6c 6f73 5f63 6c6f   use `is_los_clo
-0002b4e0: 7365 5f63 6972 636c 655f 636f 7265 600a  se_circle_core`.
-0002b4f0: 2020 2020 2222 220a 2020 2020 6364 6566      """.    cdef
-0002b500: 2061 7272 6179 2072 6573 203d 2063 6c6f   array res = clo
-0002b510: 6e65 2861 7272 6179 2827 6927 292c 206e  ne(array('i'), n
-0002b520: 6c6f 732c 2054 7275 6529 0a0a 2020 2020  los, True)..    
-0002b530: 6966 206e 6f72 6d5f 6469 7220 6973 204e  if norm_dir is N
-0002b540: 6f6e 653a 0a20 2020 2020 2020 206e 6f72  one:.        nor
-0002b550: 6d5f 6469 7220 3d20 2d6e 702e 6f6e 6573  m_dir = -np.ones
-0002b560: 286e 6c6f 7329 0a20 2020 205f 6474 2e69  (nlos).    _dt.i
-0002b570: 735f 636c 6f73 655f 6c6f 735f 6369 7263  s_close_los_circ
-0002b580: 6c65 5f76 6563 5f63 6f72 6528 6e6c 6f73  le_vec_core(nlos
-0002b590: 2c20 6e63 6972 636c 6573 2c0a 2020 2020  , ncircles,.    
-0002b5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b5c0: 2065 7073 696c 6f6e 2c0a 2020 2020 2020   epsilon,.      
+0002aed0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002aee0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002aef0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002af00: 3d0a 0a64 6566 2069 735f 636c 6f73 655f  =..def is_close_
+0002af10: 6c6f 735f 6369 7263 6c65 286e 702e 6e64  los_circle(np.nd
+0002af20: 6172 7261 795b 646f 7562 6c65 2c6e 6469  array[double,ndi
+0002af30: 6d3d 312c 6d6f 6465 3d27 6327 5d20 7261  m=1,mode='c'] ra
+0002af40: 795f 7664 6972 2c0a 2020 2020 2020 2020  y_vdir,.        
+0002af50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002af60: 6e70 2e6e 6461 7272 6179 5b64 6f75 626c  np.ndarray[doubl
+0002af70: 652c 6e64 696d 3d31 2c6d 6f64 653d 2763  e,ndim=1,mode='c
+0002af80: 275d 2072 6179 5f6f 7269 672c 0a20 2020  '] ray_orig,.   
+0002af90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002afa0: 2020 2020 2064 6f75 626c 6520 7261 6469       double radi
+0002afb0: 7573 2c20 646f 7562 6c65 2063 6972 635f  us, double circ_
+0002afc0: 7a2c 2064 6f75 626c 6520 6570 732c 0a20  z, double eps,. 
+0002afd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002afe0: 2020 2020 2020 2064 6f75 626c 6520 6e6f         double no
+0002aff0: 726d 5f64 6972 3d2d 312e 3029 3a0a 2020  rm_dir=-1.0):.  
+0002b000: 2020 2222 220a 2020 2020 5468 6973 2066    """.    This f
+0002b010: 756e 6374 696f 6e20 6368 6563 6b73 2069  unction checks i
+0002b020: 6620 6174 206d 6178 696d 756d 2061 204c  f at maximum a L
+0002b030: 4f53 2069 7320 6174 2061 2064 6973 7461  OS is at a dista
+0002b040: 6e63 6520 6570 7369 6c6f 6e0a 2020 2020  nce epsilon.    
+0002b050: 666f 726d 2061 2063 6972 6c63 650a 2020  form a cirlce.  
+0002b060: 2020 5468 6520 7265 7375 6c74 2069 7320    The result is 
+0002b070: 5472 7565 2077 6865 6e20 6469 7374 616e  True when distan
+0002b080: 6365 203c 2065 7073 696c 6f6e 0a20 2020  ce < epsilon.   
+0002b090: 202d 2d2d 0a20 2020 2054 6869 7320 6973   ---.    This is
+0002b0a0: 2074 6865 2050 5954 484f 4e20 6675 6e63   the PYTHON func
+0002b0b0: 7469 6f6e 2c20 7573 6520 6f6e 6c79 2069  tion, use only i
+0002b0c0: 6620 796f 7520 6e65 6564 2074 6869 7320  f you need this 
+0002b0d0: 636f 6d70 7574 6174 696f 6e20 6672 6f6d  computation from
+0002b0e0: 0a20 2020 2050 7974 686f 6e2c 2069 6620  .    Python, if 
+0002b0f0: 796f 7520 6e65 6564 2069 7420 6672 6f6d  you need it from
+0002b100: 2063 7974 686f 6e2c 2075 7365 2060 6973   cython, use `is
+0002b110: 5f6c 6f73 5f63 6c6f 7365 5f63 6972 636c  _los_close_circl
+0002b120: 655f 636f 7265 600a 2020 2020 2222 220a  e_core`.    """.
+0002b130: 2020 2020 7265 7475 726e 205f 6474 2e69      return _dt.i
+0002b140: 735f 636c 6f73 655f 6c6f 735f 6369 7263  s_close_los_circ
+0002b150: 6c65 5f63 6f72 6528 3c64 6f75 626c 652a  le_core(<double*
+0002b160: 3e72 6179 5f76 6469 722e 6461 7461 2c0a  >ray_vdir.data,.
+0002b170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b190: 2020 2020 2020 2020 3c64 6f75 626c 652a          <double*
+0002b1a0: 3e72 6179 5f6f 7269 672e 6461 7461 2c0a  >ray_orig.data,.
+0002b1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b1d0: 2020 2020 2020 2020 7261 6469 7573 2c20          radius, 
+0002b1e0: 6369 7263 5f7a 2c20 6e6f 726d 5f64 6972  circ_z, norm_dir
+0002b1f0: 2c20 6570 7329 0a0a 6465 6620 6973 5f63  , eps)..def is_c
+0002b200: 6c6f 7365 5f6c 6f73 5f63 6972 636c 655f  lose_los_circle_
+0002b210: 7665 6328 696e 7420 6e6c 6f73 2c20 696e  vec(int nlos, in
+0002b220: 7420 6e63 6972 636c 6573 2c20 646f 7562  t ncircles, doub
+0002b230: 6c65 2065 7073 696c 6f6e 2c0a 2020 2020  le epsilon,.    
+0002b240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b250: 2020 2020 2020 2020 206e 702e 6e64 6172           np.ndar
+0002b260: 7261 795b 646f 7562 6c65 2c6e 6469 6d3d  ray[double,ndim=
+0002b270: 322c 6d6f 6465 3d27 6327 5d20 6469 7273  2,mode='c'] dirs
+0002b280: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002b290: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0002b2a0: 702e 6e64 6172 7261 795b 646f 7562 6c65  p.ndarray[double
+0002b2b0: 2c6e 6469 6d3d 322c 6d6f 6465 3d27 6327  ,ndim=2,mode='c'
+0002b2c0: 5d20 6f72 6973 2c0a 2020 2020 2020 2020  ] oris,.        
+0002b2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b2e0: 2020 2020 206e 702e 6e64 6172 7261 795b       np.ndarray[
+0002b2f0: 646f 7562 6c65 2c6e 6469 6d3d 312c 6d6f  double,ndim=1,mo
+0002b300: 6465 3d27 6327 5d20 6369 7263 6c65 5f72  de='c'] circle_r
+0002b310: 6164 6975 732c 0a20 2020 2020 2020 2020  adius,.         
+0002b320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b330: 2020 2020 6e70 2e6e 6461 7272 6179 5b64      np.ndarray[d
+0002b340: 6f75 626c 652c 6e64 696d 3d31 2c6d 6f64  ouble,ndim=1,mod
+0002b350: 653d 2763 275d 2063 6972 636c 655f 7a2c  e='c'] circle_z,
+0002b360: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002b370: 2020 2020 2020 2020 2020 2020 2020 6e70                np
+0002b380: 2e6e 6461 7272 6179 5b64 6f75 626c 652c  .ndarray[double,
+0002b390: 6e64 696d 3d31 2c6d 6f64 653d 2763 275d  ndim=1,mode='c']
+0002b3a0: 206e 6f72 6d5f 6469 723d 4e6f 6e65 2c0a   norm_dir=None,.
+0002b3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b3c0: 2020 2020 2020 2020 2020 2020 2069 6e74               int
+0002b3d0: 206e 756d 5f74 6872 6561 6473 3d34 3829   num_threads=48)
+0002b3e0: 3a0a 2020 2020 2222 220a 2020 2020 5468  :.    """.    Th
+0002b3f0: 6973 2066 756e 6374 696f 6e20 6368 6563  is function chec
+0002b400: 6b73 2069 6620 6174 206d 6178 696d 756d  ks if at maximum
+0002b410: 2061 204c 4f53 2069 7320 6174 2061 2064   a LOS is at a d
+0002b420: 6973 7461 6e63 6520 6570 7369 6c6f 6e0a  istance epsilon.
+0002b430: 2020 2020 666f 726d 2061 2063 6972 6c63      form a cirlc
+0002b440: 652e 2056 6563 746f 7269 616c 2076 6572  e. Vectorial ver
+0002b450: 7369 6f6e 0a20 2020 2054 6865 2072 6573  sion.    The res
+0002b460: 756c 7420 6973 2054 7275 6520 7768 656e  ult is True when
+0002b470: 2064 6973 7461 6e63 6520 3c20 6570 7369   distance < epsi
+0002b480: 6c6f 6e0a 2020 2020 2d2d 2d0a 2020 2020  lon.    ---.    
+0002b490: 5468 6973 2069 7320 7468 6520 5059 5448  This is the PYTH
+0002b4a0: 4f4e 2066 756e 6374 696f 6e2c 2075 7365  ON function, use
+0002b4b0: 206f 6e6c 7920 6966 2079 6f75 206e 6565   only if you nee
+0002b4c0: 6420 7468 6973 2063 6f6d 7075 7461 7469  d this computati
+0002b4d0: 6f6e 2066 726f 6d0a 2020 2020 5079 7468  on from.    Pyth
+0002b4e0: 6f6e 2c20 6966 2079 6f75 206e 6565 6420  on, if you need 
+0002b4f0: 6974 2066 726f 6d20 6379 7468 6f6e 2c20  it from cython, 
+0002b500: 7573 6520 6069 735f 6c6f 735f 636c 6f73  use `is_los_clos
+0002b510: 655f 6369 7263 6c65 5f63 6f72 6560 0a20  e_circle_core`. 
+0002b520: 2020 2022 2222 0a20 2020 2063 6465 6620     """.    cdef 
+0002b530: 6172 7261 7920 7265 7320 3d20 636c 6f6e  array res = clon
+0002b540: 6528 6172 7261 7928 2769 2729 2c20 6e6c  e(array('i'), nl
+0002b550: 6f73 2c20 5472 7565 290a 0a20 2020 2069  os, True)..    i
+0002b560: 6620 6e6f 726d 5f64 6972 2069 7320 4e6f  f norm_dir is No
+0002b570: 6e65 3a0a 2020 2020 2020 2020 6e6f 726d  ne:.        norm
+0002b580: 5f64 6972 203d 202d 6e70 2e6f 6e65 7328  _dir = -np.ones(
+0002b590: 6e6c 6f73 290a 2020 2020 5f64 742e 6973  nlos).    _dt.is
+0002b5a0: 5f63 6c6f 7365 5f6c 6f73 5f63 6972 636c  _close_los_circl
+0002b5b0: 655f 7665 635f 636f 7265 286e 6c6f 732c  e_vec_core(nlos,
+0002b5c0: 206e 6369 7263 6c65 732c 0a20 2020 2020   ncircles,.     
 0002b5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b5e0: 2020 2020 2020 2020 2020 2020 2020 203c                 <
-0002b5f0: 646f 7562 6c65 2a3e 6469 7273 2e64 6174  double*>dirs.dat
-0002b600: 612c 0a20 2020 2020 2020 2020 2020 2020  a,.             
-0002b610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b620: 2020 2020 2020 2020 3c64 6f75 626c 652a          <double*
-0002b630: 3e6f 7269 732e 6461 7461 2c0a 2020 2020  >oris.data,.    
+0002b5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b5f0: 6570 7369 6c6f 6e2c 0a20 2020 2020 2020  epsilon,.       
+0002b600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b610: 2020 2020 2020 2020 2020 2020 2020 3c64                <d
+0002b620: 6f75 626c 652a 3e64 6972 732e 6461 7461  ouble*>dirs.data
+0002b630: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 0002b640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b660: 203c 646f 7562 6c65 2a3e 6369 7263 6c65   <double*>circle
-0002b670: 5f72 6164 6975 732e 6461 7461 2c0a 2020  _radius.data,.  
+0002b650: 2020 2020 2020 203c 646f 7562 6c65 2a3e         <double*>
+0002b660: 6f72 6973 2e64 6174 612c 0a20 2020 2020  oris.data,.     
+0002b670: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0002b680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b6a0: 2020 203c 646f 7562 6c65 2a3e 6369 7263     <double*>circ
-0002b6b0: 6c65 5f7a 2e64 6174 612c 0a20 2020 2020  le_z.data,.     
+0002b690: 3c64 6f75 626c 652a 3e63 6972 636c 655f  <double*>circle_
+0002b6a0: 7261 6469 7573 2e64 6174 612c 0a20 2020  radius.data,.   
+0002b6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0002b6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b6e0: 3c64 6f75 626c 652a 3e6e 6f72 6d5f 6469  <double*>norm_di
-0002b6f0: 722e 6461 7461 2c0a 2020 2020 2020 2020  r.data,.        
-0002b700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b710: 2020 2020 2020 2020 2020 2020 2072 6573               res
-0002b720: 2c20 6e75 6d5f 7468 7265 6164 7329 0a20  , num_threads). 
-0002b730: 2020 2072 6574 7572 6e20 6e70 2e61 7361     return np.asa
-0002b740: 7272 6179 2872 6573 2c20 6474 7970 653d  rray(res, dtype=
-0002b750: 626f 6f6c 292e 7265 7368 6170 6528 6e6c  bool).reshape(nl
-0002b760: 6f73 2c20 6e63 6972 636c 6573 290a 0a23  os, ncircles)..#
-0002b770: 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d   ===============
-0002b780: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002b790: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002b6d0: 2020 3c64 6f75 626c 652a 3e63 6972 636c    <double*>circl
+0002b6e0: 655f 7a2e 6461 7461 2c0a 2020 2020 2020  e_z.data,.      
+0002b6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b700: 2020 2020 2020 2020 2020 2020 2020 203c                 <
+0002b710: 646f 7562 6c65 2a3e 6e6f 726d 5f64 6972  double*>norm_dir
+0002b720: 2e64 6174 612c 0a20 2020 2020 2020 2020  .data,.         
+0002b730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b740: 2020 2020 2020 2020 2020 2020 7265 732c              res,
+0002b750: 206e 756d 5f74 6872 6561 6473 290a 2020   num_threads).  
+0002b760: 2020 7265 7475 726e 206e 702e 6173 6172    return np.asar
+0002b770: 7261 7928 7265 732c 2064 7479 7065 3d62  ray(res, dtype=b
+0002b780: 6f6f 6c29 2e72 6573 6861 7065 286e 6c6f  ool).reshape(nlo
+0002b790: 732c 206e 6369 7263 6c65 7329 0a0a 2320  s, ncircles)..# 
 0002b7a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002b7b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a  ===============.
-0002b7c0: 230a 2320 2020 2020 2020 2020 2020 2020  #.#             
-0002b7d0: 2020 2020 2020 2020 2020 4449 5354 414e            DISTAN
-0002b7e0: 4345 2042 4554 5745 454e 204c 4f53 2041  CE BETWEEN LOS A
-0002b7f0: 4e44 2045 5854 2d50 4f4c 590a 230a 2320  ND EXT-POLY.#.# 
-0002b800: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002b810: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002b820: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002b7b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002b7c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002b7d0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002b7e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 0a23  ==============.#
+0002b7f0: 0a23 2020 2020 2020 2020 2020 2020 2020  .#              
+0002b800: 2020 2020 2020 2020 2044 4953 5441 4e43           DISTANC
+0002b810: 4520 4245 5457 4545 4e20 4c4f 5320 414e  E BETWEEN LOS AN
+0002b820: 4420 4558 542d 504f 4c59 0a23 0a23 203d  D EXT-POLY.#.# =
 0002b830: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002b840: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 0a64  ==============.d
-0002b850: 6566 2063 6f6d 705f 6469 7374 5f6c 6f73  ef comp_dist_los
-0002b860: 5f76 706f 6c79 2864 6f75 626c 655b 3a2c  _vpoly(double[:,
-0002b870: 203a 3a31 5d20 7261 795f 6f72 6967 2c0a   ::1] ray_orig,.
-0002b880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b890: 2020 2020 2020 2020 646f 7562 6c65 5b3a          double[:
-0002b8a0: 2c20 3a3a 315d 2072 6179 5f76 6469 722c  , ::1] ray_vdir,
-0002b8b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002b8c0: 2020 2020 2020 2020 2064 6f75 626c 655b           double[
-0002b8d0: 3a2c 203a 3a31 5d20 7665 735f 706f 6c79  :, ::1] ves_poly
-0002b8e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002b8f0: 2020 2020 2020 2020 2020 646f 7562 6c65            double
-0002b900: 2064 6973 635f 7374 6570 3d30 2e31 2c0a   disc_step=0.1,.
-0002b910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b920: 2020 2020 2020 2020 646f 7562 6c65 2065          double e
-0002b930: 7073 5f75 7a3d 5f53 4d41 4c4c 2c20 646f  ps_uz=_SMALL, do
-0002b940: 7562 6c65 2065 7073 5f61 3d5f 5653 4d41  uble eps_a=_VSMA
-0002b950: 4c4c 2c0a 2020 2020 2020 2020 2020 2020  LL,.            
-0002b960: 2020 2020 2020 2020 2020 2020 646f 7562              doub
-0002b970: 6c65 2065 7073 5f76 7a3d 5f56 534d 414c  le eps_vz=_VSMAL
-0002b980: 4c2c 2064 6f75 626c 6520 6570 735f 623d  L, double eps_b=
-0002b990: 5f56 534d 414c 4c2c 0a20 2020 2020 2020  _VSMALL,.       
-0002b9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b9b0: 2064 6f75 626c 6520 6570 735f 706c 616e   double eps_plan
-0002b9c0: 653d 5f56 534d 414c 4c2c 2073 7472 2076  e=_VSMALL, str v
-0002b9d0: 6573 5f74 7970 653d 2754 6f72 272c 0a20  es_type='Tor',. 
-0002b9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b9f0: 2020 2020 2020 2069 6e74 206e 756d 5f74         int num_t
-0002ba00: 6872 6561 6473 3d31 362c 2062 696e 7420  hreads=16, bint 
-0002ba10: 6465 6275 673d 4661 6c73 652c 0a20 2020  debug=False,.   
-0002ba20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ba30: 2020 2020 2069 6e74 2064 6562 7567 5f6e       int debug_n
-0002ba40: 6c6f 733d 2d31 293a 0a20 2020 2022 2222  los=-1):.    """
-0002ba50: 0a20 2020 2054 6869 7320 6675 6e63 7469  .    This functi
-0002ba60: 6f6e 2063 6f6d 7075 7465 7320 7468 6520  on computes the 
-0002ba70: 6469 7374 616e 6365 2028 616e 6420 7468  distance (and th
-0002ba80: 6520 6173 736f 6369 6174 6564 206b 2920  e associated k) 
-0002ba90: 6265 7477 6565 6e20 6e6c 6f73 0a20 2020  between nlos.   
-0002baa0: 2052 6179 7320 286f 7220 4c4f 5329 2061   Rays (or LOS) a
-0002bab0: 6e64 2061 6e20 6049 4e60 2073 7472 7563  nd an `IN` struc
-0002bac0: 7475 7265 2028 6120 706f 6c79 676f 6e20  ture (a polygon 
-0002bad0: 6578 7472 7564 6564 2061 726f 756e 6420  extruded around 
-0002bae0: 7468 6520 6178 6973 0a20 2020 2028 302c  the axis.    (0,
-0002baf0: 302c 3129 2c20 6567 2e20 6120 666c 7578  0,1), eg. a flux
-0002bb00: 2073 7572 6661 6365 292e 0a20 2020 2046   surface)..    F
-0002bb10: 6f72 206d 6f72 6520 6465 7461 696c 7320  or more details 
-0002bb20: 6f6e 2074 6865 2061 6c67 6f72 6974 686d  on the algorithm
-0002bb30: 2070 6c65 6173 6520 7365 6520 5044 463a   please see PDF:
-0002bb40: 203c 6e61 6d65 5f6f 665f 7064 663e 2e70   <name_of_pdf>.p
-0002bb50: 6466 2023 544f 444f 0a0a 2020 2020 5061  df #TODO..    Pa
-0002bb60: 7261 6d73 0a20 2020 203d 3d3d 3d3d 3d0a  rams.    ======.
-0002bb70: 2020 2020 2020 2020 7261 795f 6f72 6967          ray_orig
-0002bb80: 203a 2028 332c 206e 6c6f 7329 2064 6f75   : (3, nlos) dou
-0002bb90: 626c 6520 6172 7261 790a 2020 2020 2020  ble array.      
-0002bba0: 2020 2020 204c 4f53 206f 7269 6769 6e20       LOS origin 
-0002bbb0: 706f 696e 7473 2063 6f6f 7264 696e 6174  points coordinat
-0002bbc0: 6573 0a20 2020 2020 2020 2072 6179 5f76  es.        ray_v
-0002bbd0: 6469 7220 3a20 2833 2c20 6e6c 6f73 2920  dir : (3, nlos) 
-0002bbe0: 646f 7562 6c65 2061 7272 6179 0a20 2020  double array.   
-0002bbf0: 2020 2020 2020 2020 4c4f 5320 6e6f 726d          LOS norm
-0002bc00: 616c 697a 6564 2064 6972 6563 7469 6f6e  alized direction
-0002bc10: 2076 6563 746f 720a 2020 2020 2020 2020   vector.        
-0002bc20: 7665 735f 706f 6c79 203a 2028 322c 206e  ves_poly : (2, n
-0002bc30: 756d 5f76 6572 7465 7829 2064 6f75 626c  um_vertex) doubl
-0002bc40: 6520 6172 7261 790a 2020 2020 2020 2020  e array.        
-0002bc50: 2020 2043 6f6f 7264 696e 6174 6573 206f     Coordinates o
-0002bc60: 6620 7468 6520 7665 7274 6963 6573 206f  f the vertices o
-0002bc70: 6620 7468 6520 506f 6c79 676f 6e20 6465  f the Polygon de
-0002bc80: 6669 6e69 6e67 2074 6865 2032 4420 706f  fining the 2D po
-0002bc90: 6c6f 6964 616c 0a20 2020 2020 2020 2020  loidal.         
-0002bca0: 2020 6375 7420 6f66 2074 6865 2056 6573    cut of the Ves
-0002bcb0: 7365 6c0a 2020 2020 2020 2020 6570 735f  sel.        eps_
-0002bcc0: 3c76 616c 3e20 3a20 646f 7562 6c65 0a20  <val> : double. 
-0002bcd0: 2020 2020 2020 2020 2020 536d 616c 6c20            Small 
-0002bce0: 7661 6c75 652c 2061 6363 6570 7461 6e63  value, acceptanc
-0002bcf0: 6520 6f66 2065 7272 6f72 0a20 2020 2052  e of error.    R
-0002bd00: 6574 7572 6e73 0a20 2020 203d 3d3d 3d3d  eturns.    =====
-0002bd10: 3d3d 0a20 2020 2020 2020 206b 6d69 6e5f  ==.        kmin_
-0002bd20: 7670 6f6c 7920 3a20 286e 6c6f 7329 2064  vpoly : (nlos) d
-0002bd30: 6f75 626c 6520 6172 7261 790a 2020 2020  ouble array.    
-0002bd40: 2020 2020 2020 2020 4f66 2074 6865 2066          Of the f
-0002bd50: 6f72 6d20 5b6b 5f30 2c20 6b5f 312c 202e  orm [k_0, k_1, .
-0002bd60: 2e2e 2c20 6b5f 6e5d 2c20 7768 6572 6520  .., k_n], where 
-0002bd70: 6b5f 6920 6973 2074 6865 2063 6f65 6666  k_i is the coeff
-0002bd80: 6963 6965 6e74 0a20 2020 2020 2020 2020  icient.         
-0002bd90: 2020 2073 7563 6820 7468 6174 2074 6865     such that the
-0002bda0: 2069 2d74 6820 7261 7920 284c 4f53 2920   i-th ray (LOS) 
-0002bdb0: 6973 2063 6c6f 7365 7374 2074 6f20 7468  is closest to th
-0002bdc0: 6520 6578 7472 7564 6564 2070 6f6c 7967  e extruded polyg
-0002bdd0: 6f6e 0a20 2020 2020 2020 2020 2020 2061  on.            a
-0002bde0: 7420 7468 6520 706f 696e 7420 505f 6920  t the point P_i 
-0002bdf0: 3d20 6f72 6967 5b69 5d20 2b20 6b6d 696e  = orig[i] + kmin
-0002be00: 5b69 5d20 2a20 7664 6972 5b69 5d0a 2020  [i] * vdir[i].  
-0002be10: 2020 2020 2020 6469 7374 5f76 706f 6c79        dist_vpoly
-0002be20: 203a 2028 6e6c 6f73 2920 646f 7562 6c65   : (nlos) double
-0002be30: 2061 7272 6179 0a20 2020 2020 2020 2020   array.         
-0002be40: 2020 2060 6469 7374 616e 6365 5b69 5d60     `distance[i]`
-0002be50: 2069 7320 7468 6520 6469 7374 616e 6365   is the distance
-0002be60: 2066 726f 6d20 505f 6920 746f 2074 6865   from P_i to the
-0002be70: 2065 7874 7275 6465 6420 706f 6c79 676f   extruded polygo
-0002be80: 6e2e 0a20 2020 202d 2d2d 0a20 2020 2054  n..    ---.    T
-0002be90: 6869 7320 6973 2074 6865 2050 5954 484f  his is the PYTHO
-0002bea0: 4e20 6675 6e63 7469 6f6e 2c20 7573 6520  N function, use 
-0002beb0: 6f6e 6c79 2069 6620 796f 7520 6e65 6564  only if you need
-0002bec0: 2074 6869 7320 636f 6d70 7574 6174 696f   this computatio
-0002bed0: 6e20 6672 6f6d 0a20 2020 2050 7974 686f  n from.    Pytho
-0002bee0: 6e2c 2069 6620 796f 7520 6e65 6564 2069  n, if you need i
-0002bef0: 7420 6672 6f6d 2063 7974 686f 6e2c 2075  t from cython, u
-0002bf00: 7365 2060 7369 6d70 6c65 5f64 6973 745f  se `simple_dist_
-0002bf10: 6c6f 735f 7670 6f6c 795f 636f 7265 600a  los_vpoly_core`.
-0002bf20: 2020 2020 2222 220a 2020 2020 6364 6566      """.    cdef
-0002bf30: 2069 6e74 206e 7074 735f 706f 6c79 203d   int npts_poly =
-0002bf40: 2076 6573 5f70 6f6c 792e 7368 6170 655b   ves_poly.shape[
-0002bf50: 315d 0a20 2020 2063 6465 6620 696e 7420  1].    cdef int 
-0002bf60: 6e6c 6f73 203d 2072 6179 5f6f 7269 672e  nlos = ray_orig.
-0002bf70: 7368 6170 655b 315d 0a20 2020 2063 6465  shape[1].    cde
-0002bf80: 6620 696e 7420 6969 2c20 696e 645f 7665  f int ii, ind_ve
-0002bf90: 7274 2c20 696e 645f 6c6f 730a 2020 2020  rt, ind_los.    
-0002bfa0: 6364 6566 2064 6f75 626c 652a 2072 6573  cdef double* res
-0002bfb0: 5f6c 6f63 203d 204e 554c 4c0a 2020 2020  _loc = NULL.    
-0002bfc0: 6364 6566 2064 6f75 626c 652a 206c 6f63  cdef double* loc
-0002bfd0: 5f6f 7267 203d 204e 554c 4c0a 2020 2020  _org = NULL.    
-0002bfe0: 6364 6566 2064 6f75 626c 652a 206c 6f63  cdef double* loc
-0002bff0: 5f64 6972 203d 204e 554c 4c0a 2020 2020  _dir = NULL.    
-0002c000: 6364 6566 2064 6f75 626c 6520 6372 6974  cdef double crit
-0002c010: 322c 2069 6e76 757a 2c20 2064 7061 7232  2, invuz,  dpar2
-0002c020: 2c20 7570 6172 322c 2075 7073 6361 4470  , upar2, upscaDp
-0002c030: 0a20 2020 2063 6465 6620 646f 7562 6c65  .    cdef double
-0002c040: 2063 7269 7432 5f62 6173 6520 3d20 6570   crit2_base = ep
-0002c050: 735f 757a 202a 2065 7073 5f75 7a20 2f34  s_uz * eps_uz /4
-0002c060: 3030 2e0a 2020 2020 6364 6566 206e 702e  00..    cdef np.
-0002c070: 6e64 6172 7261 795b 646f 7562 6c65 2c6e  ndarray[double,n
-0002c080: 6469 6d3d 315d 2064 6973 7420 3d20 6e70  dim=1] dist = np
-0002c090: 2e65 6d70 7479 2828 6e6c 6f73 2c29 2c64  .empty((nlos,),d
-0002c0a0: 7479 7065 3d66 6c6f 6174 290a 2020 2020  type=float).    
-0002c0b0: 6364 6566 206e 702e 6e64 6172 7261 795b  cdef np.ndarray[
-0002c0c0: 646f 7562 6c65 2c6e 6469 6d3d 315d 206b  double,ndim=1] k
-0002c0d0: 6d69 6e20 3d20 6e70 2e65 6d70 7479 2828  min = np.empty((
-0002c0e0: 6e6c 6f73 2c29 2c64 7479 7065 3d66 6c6f  nlos,),dtype=flo
-0002c0f0: 6174 290a 2020 2020 6364 6566 2064 6f75  at).    cdef dou
-0002c100: 626c 652a 206c 6973 745f 7670 6f6c 795f  ble* list_vpoly_
-0002c110: 7820 3d20 4e55 4c4c 0a20 2020 2063 6465  x = NULL.    cde
-0002c120: 6620 646f 7562 6c65 2a20 6c69 7374 5f76  f double* list_v
-0002c130: 706f 6c79 5f79 203d 204e 554c 4c0a 2020  poly_y = NULL.  
-0002c140: 2020 6364 6566 2069 6e74 206e 6577 5f6e    cdef int new_n
-0002c150: 7074 735f 706f 6c79 0a20 2020 2023 203d  pts_poly.    # =
-0002c160: 3d20 4469 7363 7265 7469 7a69 6e67 2076  = Discretizing v
-0002c170: 706f 6c79 7320 3d3d 3d3d 3d3d 3d3d 3d3d  polys ==========
-0002c180: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002c190: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002c1a0: 3d3d 3d3d 3d3d 3d3d 3d0a 2020 2020 5f73  =========.    _s
-0002c1b0: 742e 7369 6d70 6c65 5f64 6973 6372 6574  t.simple_discret
-0002c1c0: 697a 655f 7670 6f6c 795f 636f 7265 2876  ize_vpoly_core(v
-0002c1d0: 6573 5f70 6f6c 792c 0a20 2020 2020 2020  es_poly,.       
-0002c1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c1f0: 2020 2020 2020 2020 2020 2020 206e 7074               npt
+0002b840: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002b850: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002b860: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002b870: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 6465  =============.de
+0002b880: 6620 636f 6d70 5f64 6973 745f 6c6f 735f  f comp_dist_los_
+0002b890: 7670 6f6c 7928 646f 7562 6c65 5b3a 2c20  vpoly(double[:, 
+0002b8a0: 3a3a 315d 2072 6179 5f6f 7269 672c 0a20  ::1] ray_orig,. 
+0002b8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b8c0: 2020 2020 2020 2064 6f75 626c 655b 3a2c         double[:,
+0002b8d0: 203a 3a31 5d20 7261 795f 7664 6972 2c0a   ::1] ray_vdir,.
+0002b8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b8f0: 2020 2020 2020 2020 646f 7562 6c65 5b3a          double[:
+0002b900: 2c20 3a3a 315d 2076 6573 5f70 6f6c 792c  , ::1] ves_poly,
+0002b910: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002b920: 2020 2020 2020 2020 2064 6f75 626c 6520           double 
+0002b930: 6469 7363 5f73 7465 703d 302e 312c 0a20  disc_step=0.1,. 
+0002b940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b950: 2020 2020 2020 2064 6f75 626c 6520 6570         double ep
+0002b960: 735f 757a 3d5f 534d 414c 4c2c 2064 6f75  s_uz=_SMALL, dou
+0002b970: 626c 6520 6570 735f 613d 5f56 534d 414c  ble eps_a=_VSMAL
+0002b980: 4c2c 0a20 2020 2020 2020 2020 2020 2020  L,.             
+0002b990: 2020 2020 2020 2020 2020 2064 6f75 626c             doubl
+0002b9a0: 6520 6570 735f 767a 3d5f 5653 4d41 4c4c  e eps_vz=_VSMALL
+0002b9b0: 2c20 646f 7562 6c65 2065 7073 5f62 3d5f  , double eps_b=_
+0002b9c0: 5653 4d41 4c4c 2c0a 2020 2020 2020 2020  VSMALL,.        
+0002b9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b9e0: 646f 7562 6c65 2065 7073 5f70 6c61 6e65  double eps_plane
+0002b9f0: 3d5f 5653 4d41 4c4c 2c20 7374 7220 7665  =_VSMALL, str ve
+0002ba00: 735f 7479 7065 3d27 546f 7227 2c0a 2020  s_type='Tor',.  
+0002ba10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ba20: 2020 2020 2020 696e 7420 6e75 6d5f 7468        int num_th
+0002ba30: 7265 6164 733d 3136 2c20 6269 6e74 2064  reads=16, bint d
+0002ba40: 6562 7567 3d46 616c 7365 2c0a 2020 2020  ebug=False,.    
+0002ba50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ba60: 2020 2020 696e 7420 6465 6275 675f 6e6c      int debug_nl
+0002ba70: 6f73 3d2d 3129 3a0a 2020 2020 2222 220a  os=-1):.    """.
+0002ba80: 2020 2020 5468 6973 2066 756e 6374 696f      This functio
+0002ba90: 6e20 636f 6d70 7574 6573 2074 6865 2064  n computes the d
+0002baa0: 6973 7461 6e63 6520 2861 6e64 2074 6865  istance (and the
+0002bab0: 2061 7373 6f63 6961 7465 6420 6b29 2062   associated k) b
+0002bac0: 6574 7765 656e 206e 6c6f 730a 2020 2020  etween nlos.    
+0002bad0: 5261 7973 2028 6f72 204c 4f53 2920 616e  Rays (or LOS) an
+0002bae0: 6420 616e 2060 494e 6020 7374 7275 6374  d an `IN` struct
+0002baf0: 7572 6520 2861 2070 6f6c 7967 6f6e 2065  ure (a polygon e
+0002bb00: 7874 7275 6465 6420 6172 6f75 6e64 2074  xtruded around t
+0002bb10: 6865 2061 7869 730a 2020 2020 2830 2c30  he axis.    (0,0
+0002bb20: 2c31 292c 2065 672e 2061 2066 6c75 7820  ,1), eg. a flux 
+0002bb30: 7375 7266 6163 6529 2e0a 2020 2020 466f  surface)..    Fo
+0002bb40: 7220 6d6f 7265 2064 6574 6169 6c73 206f  r more details o
+0002bb50: 6e20 7468 6520 616c 676f 7269 7468 6d20  n the algorithm 
+0002bb60: 706c 6561 7365 2073 6565 2050 4446 3a20  please see PDF: 
+0002bb70: 3c6e 616d 655f 6f66 5f70 6466 3e2e 7064  <name_of_pdf>.pd
+0002bb80: 6620 2354 4f44 4f0a 0a20 2020 2050 6172  f #TODO..    Par
+0002bb90: 616d 730a 2020 2020 3d3d 3d3d 3d3d 0a20  ams.    ======. 
+0002bba0: 2020 2020 2020 2072 6179 5f6f 7269 6720         ray_orig 
+0002bbb0: 3a20 2833 2c20 6e6c 6f73 2920 646f 7562  : (3, nlos) doub
+0002bbc0: 6c65 2061 7272 6179 0a20 2020 2020 2020  le array.       
+0002bbd0: 2020 2020 4c4f 5320 6f72 6967 696e 2070      LOS origin p
+0002bbe0: 6f69 6e74 7320 636f 6f72 6469 6e61 7465  oints coordinate
+0002bbf0: 730a 2020 2020 2020 2020 7261 795f 7664  s.        ray_vd
+0002bc00: 6972 203a 2028 332c 206e 6c6f 7329 2064  ir : (3, nlos) d
+0002bc10: 6f75 626c 6520 6172 7261 790a 2020 2020  ouble array.    
+0002bc20: 2020 2020 2020 204c 4f53 206e 6f72 6d61         LOS norma
+0002bc30: 6c69 7a65 6420 6469 7265 6374 696f 6e20  lized direction 
+0002bc40: 7665 6374 6f72 0a20 2020 2020 2020 2076  vector.        v
+0002bc50: 6573 5f70 6f6c 7920 3a20 2832 2c20 6e75  es_poly : (2, nu
+0002bc60: 6d5f 7665 7274 6578 2920 646f 7562 6c65  m_vertex) double
+0002bc70: 2061 7272 6179 0a20 2020 2020 2020 2020   array.         
+0002bc80: 2020 436f 6f72 6469 6e61 7465 7320 6f66    Coordinates of
+0002bc90: 2074 6865 2076 6572 7469 6365 7320 6f66   the vertices of
+0002bca0: 2074 6865 2050 6f6c 7967 6f6e 2064 6566   the Polygon def
+0002bcb0: 696e 696e 6720 7468 6520 3244 2070 6f6c  ining the 2D pol
+0002bcc0: 6f69 6461 6c0a 2020 2020 2020 2020 2020  oidal.          
+0002bcd0: 2063 7574 206f 6620 7468 6520 5665 7373   cut of the Vess
+0002bce0: 656c 0a20 2020 2020 2020 2065 7073 5f3c  el.        eps_<
+0002bcf0: 7661 6c3e 203a 2064 6f75 626c 650a 2020  val> : double.  
+0002bd00: 2020 2020 2020 2020 2053 6d61 6c6c 2076           Small v
+0002bd10: 616c 7565 2c20 6163 6365 7074 616e 6365  alue, acceptance
+0002bd20: 206f 6620 6572 726f 720a 2020 2020 5265   of error.    Re
+0002bd30: 7475 726e 730a 2020 2020 3d3d 3d3d 3d3d  turns.    ======
+0002bd40: 3d0a 2020 2020 2020 2020 6b6d 696e 5f76  =.        kmin_v
+0002bd50: 706f 6c79 203a 2028 6e6c 6f73 2920 646f  poly : (nlos) do
+0002bd60: 7562 6c65 2061 7272 6179 0a20 2020 2020  uble array.     
+0002bd70: 2020 2020 2020 204f 6620 7468 6520 666f         Of the fo
+0002bd80: 726d 205b 6b5f 302c 206b 5f31 2c20 2e2e  rm [k_0, k_1, ..
+0002bd90: 2e2c 206b 5f6e 5d2c 2077 6865 7265 206b  ., k_n], where k
+0002bda0: 5f69 2069 7320 7468 6520 636f 6566 6669  _i is the coeffi
+0002bdb0: 6369 656e 740a 2020 2020 2020 2020 2020  cient.          
+0002bdc0: 2020 7375 6368 2074 6861 7420 7468 6520    such that the 
+0002bdd0: 692d 7468 2072 6179 2028 4c4f 5329 2069  i-th ray (LOS) i
+0002bde0: 7320 636c 6f73 6573 7420 746f 2074 6865  s closest to the
+0002bdf0: 2065 7874 7275 6465 6420 706f 6c79 676f   extruded polygo
+0002be00: 6e0a 2020 2020 2020 2020 2020 2020 6174  n.            at
+0002be10: 2074 6865 2070 6f69 6e74 2050 5f69 203d   the point P_i =
+0002be20: 206f 7269 675b 695d 202b 206b 6d69 6e5b   orig[i] + kmin[
+0002be30: 695d 202a 2076 6469 725b 695d 0a20 2020  i] * vdir[i].   
+0002be40: 2020 2020 2064 6973 745f 7670 6f6c 7920       dist_vpoly 
+0002be50: 3a20 286e 6c6f 7329 2064 6f75 626c 6520  : (nlos) double 
+0002be60: 6172 7261 790a 2020 2020 2020 2020 2020  array.          
+0002be70: 2020 6064 6973 7461 6e63 655b 695d 6020    `distance[i]` 
+0002be80: 6973 2074 6865 2064 6973 7461 6e63 6520  is the distance 
+0002be90: 6672 6f6d 2050 5f69 2074 6f20 7468 6520  from P_i to the 
+0002bea0: 6578 7472 7564 6564 2070 6f6c 7967 6f6e  extruded polygon
+0002beb0: 2e0a 2020 2020 2d2d 2d0a 2020 2020 5468  ..    ---.    Th
+0002bec0: 6973 2069 7320 7468 6520 5059 5448 4f4e  is is the PYTHON
+0002bed0: 2066 756e 6374 696f 6e2c 2075 7365 206f   function, use o
+0002bee0: 6e6c 7920 6966 2079 6f75 206e 6565 6420  nly if you need 
+0002bef0: 7468 6973 2063 6f6d 7075 7461 7469 6f6e  this computation
+0002bf00: 2066 726f 6d0a 2020 2020 5079 7468 6f6e   from.    Python
+0002bf10: 2c20 6966 2079 6f75 206e 6565 6420 6974  , if you need it
+0002bf20: 2066 726f 6d20 6379 7468 6f6e 2c20 7573   from cython, us
+0002bf30: 6520 6073 696d 706c 655f 6469 7374 5f6c  e `simple_dist_l
+0002bf40: 6f73 5f76 706f 6c79 5f63 6f72 6560 0a20  os_vpoly_core`. 
+0002bf50: 2020 2022 2222 0a20 2020 2063 6465 6620     """.    cdef 
+0002bf60: 696e 7420 6e70 7473 5f70 6f6c 7920 3d20  int npts_poly = 
+0002bf70: 7665 735f 706f 6c79 2e73 6861 7065 5b31  ves_poly.shape[1
+0002bf80: 5d0a 2020 2020 6364 6566 2069 6e74 206e  ].    cdef int n
+0002bf90: 6c6f 7320 3d20 7261 795f 6f72 6967 2e73  los = ray_orig.s
+0002bfa0: 6861 7065 5b31 5d0a 2020 2020 6364 6566  hape[1].    cdef
+0002bfb0: 2069 6e74 2069 692c 2069 6e64 5f76 6572   int ii, ind_ver
+0002bfc0: 742c 2069 6e64 5f6c 6f73 0a20 2020 2063  t, ind_los.    c
+0002bfd0: 6465 6620 646f 7562 6c65 2a20 7265 735f  def double* res_
+0002bfe0: 6c6f 6320 3d20 4e55 4c4c 0a20 2020 2063  loc = NULL.    c
+0002bff0: 6465 6620 646f 7562 6c65 2a20 6c6f 635f  def double* loc_
+0002c000: 6f72 6720 3d20 4e55 4c4c 0a20 2020 2063  org = NULL.    c
+0002c010: 6465 6620 646f 7562 6c65 2a20 6c6f 635f  def double* loc_
+0002c020: 6469 7220 3d20 4e55 4c4c 0a20 2020 2063  dir = NULL.    c
+0002c030: 6465 6620 646f 7562 6c65 2063 7269 7432  def double crit2
+0002c040: 2c20 696e 7675 7a2c 2020 6470 6172 322c  , invuz,  dpar2,
+0002c050: 2075 7061 7232 2c20 7570 7363 6144 700a   upar2, upscaDp.
+0002c060: 2020 2020 6364 6566 2064 6f75 626c 6520      cdef double 
+0002c070: 6372 6974 325f 6261 7365 203d 2065 7073  crit2_base = eps
+0002c080: 5f75 7a20 2a20 6570 735f 757a 202f 3430  _uz * eps_uz /40
+0002c090: 302e 0a20 2020 2063 6465 6620 6e70 2e6e  0..    cdef np.n
+0002c0a0: 6461 7272 6179 5b64 6f75 626c 652c 6e64  darray[double,nd
+0002c0b0: 696d 3d31 5d20 6469 7374 203d 206e 702e  im=1] dist = np.
+0002c0c0: 656d 7074 7928 286e 6c6f 732c 292c 6474  empty((nlos,),dt
+0002c0d0: 7970 653d 666c 6f61 7429 0a20 2020 2063  ype=float).    c
+0002c0e0: 6465 6620 6e70 2e6e 6461 7272 6179 5b64  def np.ndarray[d
+0002c0f0: 6f75 626c 652c 6e64 696d 3d31 5d20 6b6d  ouble,ndim=1] km
+0002c100: 696e 203d 206e 702e 656d 7074 7928 286e  in = np.empty((n
+0002c110: 6c6f 732c 292c 6474 7970 653d 666c 6f61  los,),dtype=floa
+0002c120: 7429 0a20 2020 2063 6465 6620 646f 7562  t).    cdef doub
+0002c130: 6c65 2a20 6c69 7374 5f76 706f 6c79 5f78  le* list_vpoly_x
+0002c140: 203d 204e 554c 4c0a 2020 2020 6364 6566   = NULL.    cdef
+0002c150: 2064 6f75 626c 652a 206c 6973 745f 7670   double* list_vp
+0002c160: 6f6c 795f 7920 3d20 4e55 4c4c 0a20 2020  oly_y = NULL.   
+0002c170: 2063 6465 6620 696e 7420 6e65 775f 6e70   cdef int new_np
+0002c180: 7473 5f70 6f6c 790a 2020 2020 2320 3d3d  ts_poly.    # ==
+0002c190: 2044 6973 6372 6574 697a 696e 6720 7670   Discretizing vp
+0002c1a0: 6f6c 7973 203d 3d3d 3d3d 3d3d 3d3d 3d3d  olys ===========
+0002c1b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002c1c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002c1d0: 3d3d 3d3d 3d3d 3d3d 0a20 2020 205f 7374  ========.    _st
+0002c1e0: 2e73 696d 706c 655f 6469 7363 7265 7469  .simple_discreti
+0002c1f0: 7a65 5f76 706f 6c79 5f63 6f72 6528 7665  ze_vpoly_core(ve
 0002c200: 735f 706f 6c79 2c0a 2020 2020 2020 2020  s_poly,.        
 0002c210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c220: 2020 2020 2020 2020 2020 2020 6469 7363              disc
-0002c230: 5f73 7465 702c 2023 2064 6973 6372 6574  _step, # discret
-0002c240: 697a 6174 696f 6e20 7374 6570 0a20 2020  ization step.   
-0002c250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c270: 2026 6c69 7374 5f76 706f 6c79 5f78 2c0a   &list_vpoly_x,.
+0002c220: 2020 2020 2020 2020 2020 2020 6e70 7473              npts
+0002c230: 5f70 6f6c 792c 0a20 2020 2020 2020 2020  _poly,.         
+0002c240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c250: 2020 2020 2020 2020 2020 2064 6973 635f             disc_
+0002c260: 7374 6570 2c20 2320 6469 7363 7265 7469  step, # discreti
+0002c270: 7a61 7469 6f6e 2073 7465 700a 2020 2020  zation step.    
 0002c280: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0002c290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c2a0: 2020 2020 266c 6973 745f 7670 6f6c 795f      &list_vpoly_
-0002c2b0: 792c 0a20 2020 2020 2020 2020 2020 2020  y,.             
+0002c2a0: 266c 6973 745f 7670 6f6c 795f 782c 0a20  &list_vpoly_x,. 
+0002c2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0002c2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c2d0: 2020 2020 2020 2026 6e65 775f 6e70 7473         &new_npts
-0002c2e0: 5f70 6f6c 792c 0a20 2020 2020 2020 2020  _poly,.         
+0002c2d0: 2020 2026 6c69 7374 5f76 706f 6c79 5f79     &list_vpoly_y
+0002c2e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 0002c2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c300: 2020 2020 2020 2020 2020 2030 2c20 2320             0, # 
-0002c310: 6d6f 6465 203d 2061 6273 6f6c 7574 650a  mode = absolute.
+0002c300: 2020 2020 2020 266e 6577 5f6e 7074 735f        &new_npts_
+0002c310: 706f 6c79 2c0a 2020 2020 2020 2020 2020  poly,.          
 0002c320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c340: 2020 2020 5f56 534d 414c 4c29 0a20 2020      _VSMALL).   
-0002c350: 2023 203d 3d20 4465 6669 6e69 6e67 2070   # == Defining p
-0002c360: 6172 616c 6c65 6c20 7061 7274 203d 3d3d  arallel part ===
-0002c370: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002c380: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002c390: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 2020  =============.  
-0002c3a0: 2020 7769 7468 206e 6f67 696c 2c20 7061    with nogil, pa
-0002c3b0: 7261 6c6c 656c 286e 756d 5f74 6872 6561  rallel(num_threa
-0002c3c0: 6473 3d6e 756d 5f74 6872 6561 6473 293a  ds=num_threads):
-0002c3d0: 0a20 2020 2020 2020 2023 2057 6520 7573  .        # We us
-0002c3e0: 6520 6c6f 6361 6c20 6172 7261 7973 2066  e local arrays f
-0002c3f0: 6f72 2065 6163 6820 7468 7265 6164 2073  or each thread s
-0002c400: 6f2e 2e2e 0a20 2020 2020 2020 206c 6f63  o....        loc
-0002c410: 5f6f 7267 2020 203d 203c 646f 7562 6c65  _org   = <double
-0002c420: 202a 3e20 6d61 6c6c 6f63 2873 697a 656f   *> malloc(sizeo
-0002c430: 6628 646f 7562 6c65 2920 2a20 3329 0a20  f(double) * 3). 
-0002c440: 2020 2020 2020 206c 6f63 5f64 6972 2020         loc_dir  
-0002c450: 203d 203c 646f 7562 6c65 202a 3e20 6d61   = <double *> ma
-0002c460: 6c6c 6f63 2873 697a 656f 6628 646f 7562  lloc(sizeof(doub
-0002c470: 6c65 2920 2a20 3329 0a20 2020 2020 2020  le) * 3).       
-0002c480: 2072 6573 5f6c 6f63 203d 203c 646f 7562   res_loc = <doub
-0002c490: 6c65 202a 3e20 6d61 6c6c 6f63 2832 2a73  le *> malloc(2*s
-0002c4a0: 697a 656f 6628 646f 7562 6c65 2929 0a20  izeof(double)). 
-0002c4b0: 2020 2020 2020 2023 203d 3d20 5468 6520         # == The 
-0002c4c0: 7061 7261 6c6c 656c 697a 6174 696f 6e20  parallelization 
-0002c4d0: 6f76 6572 2074 6865 204c 4f53 203d 3d3d  over the LOS ===
-0002c4e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002c4f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a  ===============.
-0002c500: 2020 2020 2020 2020 666f 7220 696e 645f          for ind_
-0002c510: 6c6f 7320 696e 2070 7261 6e67 6528 6e6c  los in prange(nl
-0002c520: 6f73 2c20 7363 6865 6475 6c65 3d27 6479  os, schedule='dy
-0002c530: 6e61 6d69 6327 293a 0a20 2020 2020 2020  namic'):.       
-0002c540: 2020 2020 206c 6f63 5f6f 7267 5b30 5d20       loc_org[0] 
-0002c550: 3d20 7261 795f 6f72 6967 5b30 2c20 696e  = ray_orig[0, in
-0002c560: 645f 6c6f 735d 0a20 2020 2020 2020 2020  d_los].         
-0002c570: 2020 206c 6f63 5f6f 7267 5b31 5d20 3d20     loc_org[1] = 
-0002c580: 7261 795f 6f72 6967 5b31 2c20 696e 645f  ray_orig[1, ind_
-0002c590: 6c6f 735d 0a20 2020 2020 2020 2020 2020  los].           
-0002c5a0: 206c 6f63 5f6f 7267 5b32 5d20 3d20 7261   loc_org[2] = ra
-0002c5b0: 795f 6f72 6967 5b32 2c20 696e 645f 6c6f  y_orig[2, ind_lo
-0002c5c0: 735d 0a20 2020 2020 2020 2020 2020 206c  s].            l
-0002c5d0: 6f63 5f64 6972 5b30 5d20 3d20 7261 795f  oc_dir[0] = ray_
-0002c5e0: 7664 6972 5b30 2c20 696e 645f 6c6f 735d  vdir[0, ind_los]
-0002c5f0: 0a20 2020 2020 2020 2020 2020 206c 6f63  .            loc
-0002c600: 5f64 6972 5b31 5d20 3d20 7261 795f 7664  _dir[1] = ray_vd
-0002c610: 6972 5b31 2c20 696e 645f 6c6f 735d 0a20  ir[1, ind_los]. 
-0002c620: 2020 2020 2020 2020 2020 206c 6f63 5f64             loc_d
-0002c630: 6972 5b32 5d20 3d20 7261 795f 7664 6972  ir[2] = ray_vdir
-0002c640: 5b32 2c20 696e 645f 6c6f 735d 0a20 2020  [2, ind_los].   
-0002c650: 2020 2020 2020 2020 2023 202d 2d20 436f           # -- Co
-0002c660: 6d70 7574 696e 6720 7661 6c75 6573 2074  mputing values t
-0002c670: 6861 7420 6465 7065 6e64 206f 6e20 7468  hat depend on th
-0002c680: 6520 4c4f 532f 7261 7920 2d2d 2d2d 2d2d  e LOS/ray ------
-0002c690: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020  -------------.  
-0002c6a0: 2020 2020 2020 2020 2020 7570 7363 6144            upscaD
-0002c6b0: 7020 3d20 6c6f 635f 6469 725b 305d 2a6c  p = loc_dir[0]*l
-0002c6c0: 6f63 5f6f 7267 5b30 5d20 2b20 6c6f 635f  oc_org[0] + loc_
-0002c6d0: 6469 725b 315d 2a6c 6f63 5f6f 7267 5b31  dir[1]*loc_org[1
-0002c6e0: 5d0a 2020 2020 2020 2020 2020 2020 7570  ].            up
-0002c6f0: 6172 3220 2020 3d20 6c6f 635f 6469 725b  ar2   = loc_dir[
-0002c700: 305d 2a6c 6f63 5f64 6972 5b30 5d20 2b20  0]*loc_dir[0] + 
-0002c710: 6c6f 635f 6469 725b 315d 2a6c 6f63 5f64  loc_dir[1]*loc_d
-0002c720: 6972 5b31 5d0a 2020 2020 2020 2020 2020  ir[1].          
-0002c730: 2020 6470 6172 3220 2020 3d20 6c6f 635f    dpar2   = loc_
-0002c740: 6f72 675b 305d 2a6c 6f63 5f6f 7267 5b30  org[0]*loc_org[0
-0002c750: 5d20 2b20 6c6f 635f 6f72 675b 315d 2a6c  ] + loc_org[1]*l
-0002c760: 6f63 5f6f 7267 5b31 5d0a 2020 2020 2020  oc_org[1].      
-0002c770: 2020 2020 2020 696e 7675 7a20 3d20 312e        invuz = 1.
-0002c780: 2f6c 6f63 5f64 6972 5b32 5d0a 2020 2020  /loc_dir[2].    
-0002c790: 2020 2020 2020 2020 6372 6974 3220 3d20          crit2 = 
-0002c7a0: 7570 6172 322a 6372 6974 325f 6261 7365  upar2*crit2_base
-0002c7b0: 0a20 2020 2020 2020 2020 2020 205f 6474  .            _dt
-0002c7c0: 2e73 696d 706c 655f 6469 7374 5f6c 6f73  .simple_dist_los
-0002c7d0: 5f76 706f 6c79 5f63 6f72 6528 6c6f 635f  _vpoly_core(loc_
-0002c7e0: 6f72 672c 206c 6f63 5f64 6972 2c0a 2020  org, loc_dir,.  
-0002c7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c810: 2020 2020 2020 2020 206c 6973 745f 7670           list_vp
-0002c820: 6f6c 795f 782c 0a20 2020 2020 2020 2020  oly_x,.         
-0002c830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c850: 2020 6c69 7374 5f76 706f 6c79 5f79 2c0a    list_vpoly_y,.
+0002c330: 2020 2020 2020 2020 2020 302c 2023 206d            0, # m
+0002c340: 6f64 6520 3d20 6162 736f 6c75 7465 0a20  ode = absolute. 
+0002c350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c370: 2020 205f 5653 4d41 4c4c 290a 0a20 2020     _VSMALL)..   
+0002c380: 2023 203d 3d20 4465 6669 6e69 6e67 2070   # == Defining p
+0002c390: 6172 616c 6c65 6c20 7061 7274 203d 3d3d  arallel part ===
+0002c3a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002c3b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002c3c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 2020  =============.  
+0002c3d0: 2020 7769 7468 206e 6f67 696c 2c20 7061    with nogil, pa
+0002c3e0: 7261 6c6c 656c 286e 756d 5f74 6872 6561  rallel(num_threa
+0002c3f0: 6473 3d6e 756d 5f74 6872 6561 6473 293a  ds=num_threads):
+0002c400: 0a0a 2020 2020 2020 2020 2320 5765 2075  ..        # We u
+0002c410: 7365 206c 6f63 616c 2061 7272 6179 7320  se local arrays 
+0002c420: 666f 7220 6561 6368 2074 6872 6561 6420  for each thread 
+0002c430: 736f 2e2e 2e0a 2020 2020 2020 2020 6c6f  so....        lo
+0002c440: 635f 6f72 6720 2020 3d20 3c64 6f75 626c  c_org   = <doubl
+0002c450: 6520 2a3e 206d 616c 6c6f 6328 7369 7a65  e *> malloc(size
+0002c460: 6f66 2864 6f75 626c 6529 202a 2033 290a  of(double) * 3).
+0002c470: 2020 2020 2020 2020 6c6f 635f 6469 7220          loc_dir 
+0002c480: 2020 3d20 3c64 6f75 626c 6520 2a3e 206d    = <double *> m
+0002c490: 616c 6c6f 6328 7369 7a65 6f66 2864 6f75  alloc(sizeof(dou
+0002c4a0: 626c 6529 202a 2033 290a 2020 2020 2020  ble) * 3).      
+0002c4b0: 2020 7265 735f 6c6f 6320 3d20 3c64 6f75    res_loc = <dou
+0002c4c0: 626c 6520 2a3e 206d 616c 6c6f 6328 322a  ble *> malloc(2*
+0002c4d0: 7369 7a65 6f66 2864 6f75 626c 6529 290a  sizeof(double)).
+0002c4e0: 0a20 2020 2020 2020 2023 203d 3d20 5468  .        # == Th
+0002c4f0: 6520 7061 7261 6c6c 656c 697a 6174 696f  e parallelizatio
+0002c500: 6e20 6f76 6572 2074 6865 204c 4f53 203d  n over the LOS =
+0002c510: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002c520: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002c530: 3d0a 2020 2020 2020 2020 666f 7220 696e  =.        for in
+0002c540: 645f 6c6f 7320 696e 2070 7261 6e67 6528  d_los in prange(
+0002c550: 6e6c 6f73 2c20 7363 6865 6475 6c65 3d27  nlos, schedule='
+0002c560: 6479 6e61 6d69 6327 293a 0a0a 2020 2020  dynamic'):..    
+0002c570: 2020 2020 2020 2020 6c6f 635f 6f72 675b          loc_org[
+0002c580: 305d 203d 2072 6179 5f6f 7269 675b 302c  0] = ray_orig[0,
+0002c590: 2069 6e64 5f6c 6f73 5d0a 2020 2020 2020   ind_los].      
+0002c5a0: 2020 2020 2020 6c6f 635f 6f72 675b 315d        loc_org[1]
+0002c5b0: 203d 2072 6179 5f6f 7269 675b 312c 2069   = ray_orig[1, i
+0002c5c0: 6e64 5f6c 6f73 5d0a 2020 2020 2020 2020  nd_los].        
+0002c5d0: 2020 2020 6c6f 635f 6f72 675b 325d 203d      loc_org[2] =
+0002c5e0: 2072 6179 5f6f 7269 675b 322c 2069 6e64   ray_orig[2, ind
+0002c5f0: 5f6c 6f73 5d0a 2020 2020 2020 2020 2020  _los].          
+0002c600: 2020 6c6f 635f 6469 725b 305d 203d 2072    loc_dir[0] = r
+0002c610: 6179 5f76 6469 725b 302c 2069 6e64 5f6c  ay_vdir[0, ind_l
+0002c620: 6f73 5d0a 2020 2020 2020 2020 2020 2020  os].            
+0002c630: 6c6f 635f 6469 725b 315d 203d 2072 6179  loc_dir[1] = ray
+0002c640: 5f76 6469 725b 312c 2069 6e64 5f6c 6f73  _vdir[1, ind_los
+0002c650: 5d0a 2020 2020 2020 2020 2020 2020 6c6f  ].            lo
+0002c660: 635f 6469 725b 325d 203d 2072 6179 5f76  c_dir[2] = ray_v
+0002c670: 6469 725b 322c 2069 6e64 5f6c 6f73 5d0a  dir[2, ind_los].
+0002c680: 0a20 2020 2020 2020 2020 2020 2023 202d  .            # -
+0002c690: 2d20 436f 6d70 7574 696e 6720 7661 6c75  - Computing valu
+0002c6a0: 6573 2074 6861 7420 6465 7065 6e64 206f  es that depend o
+0002c6b0: 6e20 7468 6520 4c4f 532f 7261 7920 2d2d  n the LOS/ray --
+0002c6c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0002c6d0: 2d0a 2020 2020 2020 2020 2020 2020 7570  -.            up
+0002c6e0: 7363 6144 7020 3d20 6c6f 635f 6469 725b  scaDp = loc_dir[
+0002c6f0: 305d 2a6c 6f63 5f6f 7267 5b30 5d20 2b20  0]*loc_org[0] + 
+0002c700: 6c6f 635f 6469 725b 315d 2a6c 6f63 5f6f  loc_dir[1]*loc_o
+0002c710: 7267 5b31 5d0a 2020 2020 2020 2020 2020  rg[1].          
+0002c720: 2020 7570 6172 3220 2020 3d20 6c6f 635f    upar2   = loc_
+0002c730: 6469 725b 305d 2a6c 6f63 5f64 6972 5b30  dir[0]*loc_dir[0
+0002c740: 5d20 2b20 6c6f 635f 6469 725b 315d 2a6c  ] + loc_dir[1]*l
+0002c750: 6f63 5f64 6972 5b31 5d0a 2020 2020 2020  oc_dir[1].      
+0002c760: 2020 2020 2020 6470 6172 3220 2020 3d20        dpar2   = 
+0002c770: 6c6f 635f 6f72 675b 305d 2a6c 6f63 5f6f  loc_org[0]*loc_o
+0002c780: 7267 5b30 5d20 2b20 6c6f 635f 6f72 675b  rg[0] + loc_org[
+0002c790: 315d 2a6c 6f63 5f6f 7267 5b31 5d0a 2020  1]*loc_org[1].  
+0002c7a0: 2020 2020 2020 2020 2020 696e 7675 7a20            invuz 
+0002c7b0: 3d20 312e 2f6c 6f63 5f64 6972 5b32 5d0a  = 1./loc_dir[2].
+0002c7c0: 0a20 2020 2020 2020 2020 2020 2023 2068  .            # h
+0002c7d0: 6f72 697a 6f6e 7461 6c69 7479 2063 7269  orizontality cri
+0002c7e0: 7465 7269 6f6e 0a20 2020 2020 2020 2020  terion.         
+0002c7f0: 2020 2063 7269 7432 203d 2075 7061 7232     crit2 = upar2
+0002c800: 2a63 7269 7432 5f62 6173 650a 0a20 2020  *crit2_base..   
+0002c810: 2020 2020 2020 2020 2023 2063 6f6d 7075           # compu
+0002c820: 7465 0a20 2020 2020 2020 2020 2020 205f  te.            _
+0002c830: 6474 2e73 696d 706c 655f 6469 7374 5f6c  dt.simple_dist_l
+0002c840: 6f73 5f76 706f 6c79 5f63 6f72 6528 6c6f  os_vpoly_core(lo
+0002c850: 635f 6f72 672c 206c 6f63 5f64 6972 2c0a  c_org, loc_dir,.
 0002c860: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0002c870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c880: 2020 2020 2020 2020 2020 206e 6577 5f6e             new_n
-0002c890: 7074 735f 706f 6c79 2c20 7570 7363 6144  pts_poly, upscaD
-0002c8a0: 702c 0a20 2020 2020 2020 2020 2020 2020  p,.             
+0002c880: 2020 2020 2020 2020 2020 206c 6973 745f             list_
+0002c890: 7670 6f6c 795f 782c 0a20 2020 2020 2020  vpoly_x,.       
+0002c8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0002c8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c8c0: 2020 2020 2020 2020 2020 2020 2020 7570                up
-0002c8d0: 6172 322c 2064 7061 7232 2c0a 2020 2020  ar2, dpar2,.    
+0002c8c0: 2020 2020 6c69 7374 5f76 706f 6c79 5f79      list_vpoly_y
+0002c8d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 0002c8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c900: 2020 2020 2020 2069 6e76 757a 2c20 6372         invuz, cr
-0002c910: 6974 322c 0a20 2020 2020 2020 2020 2020  it2,.           
+0002c8f0: 2020 2020 2020 2020 2020 2020 206e 6577               new
+0002c900: 5f6e 7074 735f 706f 6c79 2c20 7570 7363  _npts_poly, upsc
+0002c910: 6144 702c 0a20 2020 2020 2020 2020 2020  aDp,.           
 0002c920: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0002c930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c940: 6570 735f 757a 2c20 6570 735f 767a 2c0a  eps_uz, eps_vz,.
+0002c940: 7570 6172 322c 2064 7061 7232 2c0a 2020  upar2, dpar2,.  
 0002c950: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0002c960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c970: 2020 2020 2020 2020 2020 2065 7073 5f61             eps_a
-0002c980: 2c20 6570 735f 622c 0a20 2020 2020 2020  , eps_b,.       
+0002c970: 2020 2020 2020 2020 2069 6e76 757a 2c20           invuz, 
+0002c980: 6372 6974 322c 0a20 2020 2020 2020 2020  crit2,.         
 0002c990: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0002c9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c9b0: 2020 2020 7265 735f 6c6f 6329 0a20 2020      res_loc).   
-0002c9c0: 2020 2020 2020 2020 206b 6d69 6e5b 696e           kmin[in
-0002c9d0: 645f 6c6f 735d 203d 2072 6573 5f6c 6f63  d_los] = res_loc
-0002c9e0: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
-0002c9f0: 6469 7374 5b69 6e64 5f6c 6f73 5d20 3d20  dist[ind_los] = 
-0002ca00: 7265 735f 6c6f 635b 315d 0a20 2020 2020  res_loc[1].     
-0002ca10: 2020 2066 7265 6528 6c6f 635f 6f72 6729     free(loc_org)
-0002ca20: 0a20 2020 2020 2020 2066 7265 6528 6c6f  .        free(lo
-0002ca30: 635f 6469 7229 0a20 2020 2020 2020 2066  c_dir).        f
-0002ca40: 7265 6528 7265 735f 6c6f 6329 0a20 2020  ree(res_loc).   
-0002ca50: 2066 7265 6528 6c69 7374 5f76 706f 6c79   free(list_vpoly
-0002ca60: 5f78 290a 2020 2020 6672 6565 286c 6973  _x).    free(lis
-0002ca70: 745f 7670 6f6c 795f 7929 0a20 2020 2072  t_vpoly_y).    r
-0002ca80: 6574 7572 6e20 6b6d 696e 2c20 6469 7374  eturn kmin, dist
-0002ca90: 0a0a 6465 6620 636f 6d70 5f64 6973 745f  ..def comp_dist_
-0002caa0: 6c6f 735f 7670 6f6c 795f 7665 6328 696e  los_vpoly_vec(in
-0002cab0: 7420 6e76 706f 6c79 2c20 696e 7420 6e6c  t nvpoly, int nl
-0002cac0: 6f73 2c0a 2020 2020 2020 2020 2020 2020  os,.            
-0002cad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cae0: 6e70 2e6e 6461 7272 6179 5b64 6f75 626c  np.ndarray[doubl
-0002caf0: 652c 6e64 696d 3d32 2c6d 6f64 653d 2763  e,ndim=2,mode='c
-0002cb00: 275d 2072 6179 5f6f 7269 672c 0a20 2020  '] ray_orig,.   
-0002cb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cb20: 2020 2020 2020 2020 206e 702e 6e64 6172           np.ndar
-0002cb30: 7261 795b 646f 7562 6c65 2c6e 6469 6d3d  ray[double,ndim=
-0002cb40: 322c 6d6f 6465 3d27 6327 5d20 7261 795f  2,mode='c'] ray_
-0002cb50: 7664 6972 2c0a 2020 2020 2020 2020 2020  vdir,.          
-0002cb60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cb70: 2020 6e70 2e6e 6461 7272 6179 5b64 6f75    np.ndarray[dou
-0002cb80: 626c 652c 6e64 696d 3d33 2c6d 6f64 653d  ble,ndim=3,mode=
-0002cb90: 2763 275d 2076 6573 5f70 6f6c 792c 0a20  'c'] ves_poly,. 
-0002cba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cbb0: 2020 2020 2020 2020 2020 2064 6f75 626c             doubl
-0002cbc0: 6520 6570 735f 757a 3d5f 534d 414c 4c2c  e eps_uz=_SMALL,
-0002cbd0: 2064 6f75 626c 6520 6570 735f 613d 5f56   double eps_a=_V
-0002cbe0: 534d 414c 4c2c 0a20 2020 2020 2020 2020  SMALL,.         
-0002cbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cc00: 2020 2064 6f75 626c 6520 6570 735f 767a     double eps_vz
-0002cc10: 3d5f 5653 4d41 4c4c 2c20 646f 7562 6c65  =_VSMALL, double
-0002cc20: 2065 7073 5f62 3d5f 5653 4d41 4c4c 2c0a   eps_b=_VSMALL,.
-0002cc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cc40: 2020 2020 2020 2020 2020 2020 646f 7562              doub
-0002cc50: 6c65 2065 7073 5f70 6c61 6e65 3d5f 5653  le eps_plane=_VS
-0002cc60: 4d41 4c4c 2c20 7374 7220 7665 735f 7479  MALL, str ves_ty
-0002cc70: 7065 3d27 546f 7227 2c0a 2020 2020 2020  pe='Tor',.      
-0002cc80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cc90: 2020 2020 2020 7374 7220 616c 676f 5f74        str algo_t
-0002cca0: 7970 653d 2773 696d 706c 6527 2c20 696e  ype='simple', in
-0002ccb0: 7420 6e75 6d5f 7468 7265 6164 733d 3136  t num_threads=16
-0002ccc0: 293a 0a20 2020 2022 2222 0a20 2020 2054  ):.    """.    T
-0002ccd0: 6869 7320 6675 6e63 7469 6f6e 2063 6f6d  his function com
-0002cce0: 7075 7465 7320 7468 6520 6469 7374 616e  putes the distan
-0002ccf0: 6365 2028 616e 6420 7468 6520 6173 736f  ce (and the asso
-0002cd00: 6369 6174 6564 206b 2920 6265 7477 6565  ciated k) betwee
-0002cd10: 6e20 6e6c 6f73 0a20 2020 2052 6179 7320  n nlos.    Rays 
-0002cd20: 286f 7220 4c4f 5329 2061 6e64 2073 6576  (or LOS) and sev
-0002cd30: 6572 616c 2060 494e 6020 7374 7275 6374  eral `IN` struct
-0002cd40: 7572 6573 2028 706f 6c79 676f 6e73 2065  ures (polygons e
-0002cd50: 7874 7275 6465 6420 6172 6f75 6e64 2074  xtruded around t
-0002cd60: 6865 2061 7869 730a 2020 2020 2830 2c30  he axis.    (0,0
-0002cd70: 2c31 292c 2065 672e 2066 6c75 7820 7375  ,1), eg. flux su
-0002cd80: 7266 6163 6573 292e 0a20 2020 2046 6f72  rfaces)..    For
-0002cd90: 206d 6f72 6520 6465 7461 696c 7320 6f6e   more details on
-0002cda0: 2074 6865 2061 6c67 6f72 6974 686d 2070   the algorithm p
-0002cdb0: 6c65 6173 6520 7365 6520 5044 463a 203c  lease see PDF: <
-0002cdc0: 6e61 6d65 5f6f 665f 7064 663e 2e70 6466  name_of_pdf>.pdf
-0002cdd0: 2023 544f 444f 0a0a 2020 2020 5061 7261   #TODO..    Para
-0002cde0: 6d73 0a20 2020 203d 3d3d 3d3d 3d0a 2020  ms.    ======.  
-0002cdf0: 2020 2020 2020 6e76 706f 6c79 203a 2069        nvpoly : i
-0002ce00: 6e74 0a20 2020 2020 2020 2020 2020 4e75  nt.           Nu
-0002ce10: 6d62 6572 206f 6620 666c 7578 2073 7572  mber of flux sur
-0002ce20: 6661 6365 730a 2020 2020 2020 2020 6e6c  faces.        nl
-0002ce30: 6f73 203a 2069 6e74 0a20 2020 2020 2020  os : int.       
-0002ce40: 2020 2020 4e75 6d62 6572 206f 6620 4c4f      Number of LO
-0002ce50: 530a 2020 2020 2020 2020 7261 795f 6f72  S.        ray_or
-0002ce60: 6967 203a 2028 332c 206e 6c6f 7329 2064  ig : (3, nlos) d
-0002ce70: 6f75 626c 6520 6172 7261 790a 2020 2020  ouble array.    
-0002ce80: 2020 2020 2020 204c 4f53 206f 7269 6769         LOS origi
-0002ce90: 6e20 706f 696e 7473 2063 6f6f 7264 696e  n points coordin
-0002cea0: 6174 6573 0a20 2020 2020 2020 2072 6179  ates.        ray
-0002ceb0: 5f76 6469 7220 3a20 2833 2c20 6e6c 6f73  _vdir : (3, nlos
-0002cec0: 2920 646f 7562 6c65 2061 7272 6179 0a20  ) double array. 
-0002ced0: 2020 2020 2020 2020 2020 4c4f 5320 6e6f            LOS no
-0002cee0: 726d 616c 697a 6564 2064 6972 6563 7469  rmalized directi
-0002cef0: 6f6e 2076 6563 746f 720a 2020 2020 2020  on vector.      
-0002cf00: 2020 7665 735f 706f 6c79 203a 2028 6e75    ves_poly : (nu
-0002cf10: 6d5f 706f 6c2c 2032 2c20 6e75 6d5f 7665  m_pol, 2, num_ve
-0002cf20: 7274 6578 2920 646f 7562 6c65 2061 7272  rtex) double arr
-0002cf30: 6179 0a20 2020 2020 2020 2020 2020 436f  ay.           Co
-0002cf40: 6f72 6469 6e61 7465 7320 6f66 2074 6865  ordinates of the
-0002cf50: 2076 6572 7469 6365 7320 6f66 2074 6865   vertices of the
-0002cf60: 2050 6f6c 7967 6f6e 2064 6566 696e 696e   Polygon definin
-0002cf70: 6720 7468 6520 3244 2070 6f6c 6f69 6461  g the 2D poloida
-0002cf80: 6c0a 2020 2020 2020 2020 2020 2063 7574  l.           cut
-0002cf90: 206f 6620 7468 6520 6469 6666 6572 656e   of the differen
-0002cfa0: 7420 494e 2073 7572 6661 6365 730a 2020  t IN surfaces.  
-0002cfb0: 2020 2020 2020 2020 2057 4152 4e49 4e47           WARNING
-0002cfc0: 203a 2077 6520 7375 7070 6f73 6520 616c   : we suppose al
-0002cfd0: 6c20 706f 6c79 2061 7265 206e 6573 7465  l poly are neste
-0002cfe0: 6420 696e 2065 6163 6820 6f74 6865 722c  d in each other,
-0002cff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002d000: 2020 2020 2020 6672 6f6d 2069 6e6e 6572        from inner
-0002d010: 2074 6f20 6f75 7465 720a 2020 2020 2020   to outer.      
-0002d020: 2020 6570 735f 3c76 616c 3e20 3a20 646f    eps_<val> : do
-0002d030: 7562 6c65 0a20 2020 2020 2020 2020 2020  uble.           
-0002d040: 536d 616c 6c20 7661 6c75 652c 2061 6363  Small value, acc
-0002d050: 6570 7461 6e63 6520 6f66 2065 7272 6f72  eptance of error
-0002d060: 0a20 2020 2052 6574 7572 6e73 0a20 2020  .    Returns.   
-0002d070: 203d 3d3d 3d3d 3d3d 0a20 2020 2020 2020   =======.       
-0002d080: 206b 6d69 6e5f 7670 6f6c 7920 3a20 286e   kmin_vpoly : (n
-0002d090: 706f 6c79 2c20 6e6c 6f73 2920 646f 7562  poly, nlos) doub
-0002d0a0: 6c65 2061 7272 6179 0a20 2020 2020 2020  le array.       
-0002d0b0: 2020 2020 204f 6620 7468 6520 666f 726d       Of the form
-0002d0c0: 205b 6b5f 3030 2c20 6b5f 3031 2c20 2e2e   [k_00, k_01, ..
-0002d0d0: 2e2c 206b 5f30 6e2c 206b 5f31 302c 206b  ., k_0n, k_10, k
-0002d0e0: 5f31 312c 202e 2e2e 2c20 6b5f 316e 2c20  _11, ..., k_1n, 
-0002d0f0: 2e2e 2e5d 0a20 2020 2020 2020 2020 2020  ...].           
-0002d100: 2077 6865 7265 206b 5f69 6a20 6973 2074   where k_ij is t
-0002d110: 6865 2063 6f65 6666 6963 6965 6e74 2066  he coefficient f
-0002d120: 6f72 2074 6865 206a 2d74 6820 666c 7578  or the j-th flux
-0002d130: 2073 7572 6661 6365 0a20 2020 2020 2020   surface.       
-0002d140: 2020 2020 2073 7563 6820 7468 6174 2074       such that t
-0002d150: 6865 2069 2d74 6820 7261 7920 284c 4f53  he i-th ray (LOS
-0002d160: 2920 6973 2063 6c6f 7365 7374 2074 6f20  ) is closest to 
-0002d170: 7468 6520 6578 7472 7564 6564 2070 6f6c  the extruded pol
-0002d180: 7967 6f6e 0a20 2020 2020 2020 2020 2020  ygon.           
-0002d190: 2061 7420 7468 6520 706f 696e 7420 505f   at the point P_
-0002d1a0: 6920 3d20 6f72 6967 5b69 5d20 2b20 6b6d  i = orig[i] + km
-0002d1b0: 696e 5b69 5d20 2a20 7664 6972 5b69 5d0a  in[i] * vdir[i].
-0002d1c0: 2020 2020 2020 2020 6469 7374 5f76 706f          dist_vpo
-0002d1d0: 6c79 203a 2028 6e70 6f6c 792c 206e 6c6f  ly : (npoly, nlo
-0002d1e0: 7329 2064 6f75 626c 6520 6172 7261 790a  s) double array.
-0002d1f0: 2020 2020 2020 2020 2020 2020 6064 6973              `dis
-0002d200: 7461 6e63 655b 6920 2a20 6e75 6d5f 706f  tance[i * num_po
-0002d210: 6c79 202b 206a 5d60 2069 7320 7468 6520  ly + j]` is the 
-0002d220: 6469 7374 616e 6365 2066 726f 6d20 505f  distance from P_
-0002d230: 6920 746f 2074 6865 2069 2d74 680a 2020  i to the i-th.  
-0002d240: 2020 2020 2020 2020 2020 6578 7472 7564            extrud
-0002d250: 6564 2070 6f6c 792e 0a20 2020 202d 2d2d  ed poly..    ---
-0002d260: 0a20 2020 2054 6869 7320 6973 2074 6865  .    This is the
-0002d270: 2050 5954 484f 4e20 6675 6e63 7469 6f6e   PYTHON function
-0002d280: 2c20 7573 6520 6f6e 6c79 2069 6620 796f  , use only if yo
-0002d290: 7520 6e65 6564 2074 6869 7320 636f 6d70  u need this comp
-0002d2a0: 7574 6174 696f 6e20 6672 6f6d 0a20 2020  utation from.   
-0002d2b0: 2050 7974 686f 6e2c 2069 6620 796f 7520   Python, if you 
-0002d2c0: 6e65 6564 2069 7420 6672 6f6d 2063 7974  need it from cyt
-0002d2d0: 686f 6e2c 2075 7365 2060 636f 6d70 5f64  hon, use `comp_d
-0002d2e0: 6973 745f 6c6f 735f 7670 6f6c 795f 7665  ist_los_vpoly_ve
-0002d2f0: 635f 636f 7265 600a 2020 2020 2222 220a  c_core`.    """.
-0002d300: 2020 2020 6966 206e 6f74 2061 6c67 6f5f      if not algo_
-0002d310: 7479 7065 2e6c 6f77 6572 2829 203d 3d20  type.lower() == 
-0002d320: 2273 696d 706c 6522 206f 7220 6e6f 7420  "simple" or not 
-0002d330: 7665 735f 7479 7065 2e6c 6f77 6572 2829  ves_type.lower()
-0002d340: 203d 3d20 2274 6f72 223a 0a20 2020 2020   == "tor":.     
-0002d350: 2020 2061 7373 6572 7420 4661 6c73 652c     assert False,
-0002d360: 2022 5468 6520 6675 6e63 7469 6f6e 2069   "The function i
-0002d370: 7320 6f6e 6c79 2069 6d70 6c65 6d65 6e74  s only implement
-0002d380: 6564 2077 6974 6820 7468 6520 7369 6d70  ed with the simp
-0002d390: 6c65 225c 0a20 2020 2020 2020 2020 2020  le"\.           
-0002d3a0: 202b 2022 2061 6c67 6f72 6974 686d 2061   + " algorithm a
-0002d3b0: 6e64 2066 6f72 2074 6f72 6f69 6461 6c20  nd for toroidal 
-0002d3c0: 7665 7373 656c 732e 2e2e 2053 6f72 7279  vessels... Sorry
-0002d3d0: 2122 0a20 2020 2077 6172 6e28 2254 6869  !".    warn("Thi
-0002d3e0: 7320 6675 6e63 7469 6f6e 2073 7570 706f  s function suppo
-0002d3f0: 7365 7320 7468 6174 2074 6865 2070 6f6c  ses that the pol
-0002d400: 7973 2061 7265 206e 6573 7465 6420 6672  ys are nested fr
-0002d410: 6f6d 2069 6e6e 6572 2074 6f20 6f75 7465  om inner to oute
-0002d420: 7222 2c0a 2020 2020 2020 2020 2057 6172  r",.         War
-0002d430: 6e69 6e67 290a 0a20 2020 2063 6465 6620  ning)..    cdef 
-0002d440: 6e70 2e6e 6461 7272 6179 5b64 6f75 626c  np.ndarray[doubl
-0002d450: 652c 206e 6469 6d3d 315d 206b 6d69 6e20  e, ndim=1] kmin 
-0002d460: 3d20 6e70 2e65 6d70 7479 2828 6e76 706f  = np.empty((nvpo
-0002d470: 6c79 2a6e 6c6f 732c 292c 2064 7479 7065  ly*nlos,), dtype
-0002d480: 3d66 6c6f 6174 290a 2020 2020 6364 6566  =float).    cdef
-0002d490: 206e 702e 6e64 6172 7261 795b 646f 7562   np.ndarray[doub
-0002d4a0: 6c65 2c20 6e64 696d 3d31 5d20 6469 7374  le, ndim=1] dist
-0002d4b0: 203d 206e 702e 656d 7074 7928 286e 7670   = np.empty((nvp
-0002d4c0: 6f6c 792a 6e6c 6f73 2c29 2c20 6474 7970  oly*nlos,), dtyp
-0002d4d0: 653d 666c 6f61 7429 0a20 2020 2063 6465  e=float).    cde
-0002d4e0: 6620 696e 7420 616c 676f 5f6e 756d 203d  f int algo_num =
-0002d4f0: 2030 0a20 2020 2063 6465 6620 696e 7420   0.    cdef int 
-0002d500: 7665 735f 6e75 6d20 3d20 310a 2020 2020  ves_num = 1.    
-0002d510: 5f64 742e 636f 6d70 5f64 6973 745f 6c6f  _dt.comp_dist_lo
-0002d520: 735f 7670 6f6c 795f 7665 635f 636f 7265  s_vpoly_vec_core
-0002d530: 286e 7670 6f6c 792c 206e 6c6f 732c 0a20  (nvpoly, nlos,. 
-0002d540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d560: 2020 203c 646f 7562 6c65 2a3e 7261 795f     <double*>ray_
-0002d570: 6f72 6967 2e64 6174 612c 0a20 2020 2020  orig.data,.     
-0002d580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d590: 2020 2020 2020 2020 2020 2020 2020 203c                 <
-0002d5a0: 646f 7562 6c65 2a3e 7261 795f 7664 6972  double*>ray_vdir
-0002d5b0: 2e64 6174 612c 0a20 2020 2020 2020 2020  .data,.         
+0002c9b0: 2020 6570 735f 757a 2c20 6570 735f 767a    eps_uz, eps_vz
+0002c9c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002c9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c9e0: 2020 2020 2020 2020 2020 2020 2065 7073               eps
+0002c9f0: 5f61 2c20 6570 735f 622c 0a20 2020 2020  _a, eps_b,.     
+0002ca00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ca10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ca20: 2020 2020 2020 7265 735f 6c6f 6329 0a20        res_loc). 
+0002ca30: 2020 2020 2020 2020 2020 206b 6d69 6e5b             kmin[
+0002ca40: 696e 645f 6c6f 735d 203d 2072 6573 5f6c  ind_los] = res_l
+0002ca50: 6f63 5b30 5d0a 2020 2020 2020 2020 2020  oc[0].          
+0002ca60: 2020 6469 7374 5b69 6e64 5f6c 6f73 5d20    dist[ind_los] 
+0002ca70: 3d20 7265 735f 6c6f 635b 315d 0a0a 2020  = res_loc[1]..  
+0002ca80: 2020 2020 2020 6672 6565 286c 6f63 5f6f        free(loc_o
+0002ca90: 7267 290a 2020 2020 2020 2020 6672 6565  rg).        free
+0002caa0: 286c 6f63 5f64 6972 290a 2020 2020 2020  (loc_dir).      
+0002cab0: 2020 6672 6565 2872 6573 5f6c 6f63 290a    free(res_loc).
+0002cac0: 0a20 2020 2066 7265 6528 6c69 7374 5f76  .    free(list_v
+0002cad0: 706f 6c79 5f78 290a 2020 2020 6672 6565  poly_x).    free
+0002cae0: 286c 6973 745f 7670 6f6c 795f 7929 0a0a  (list_vpoly_y)..
+0002caf0: 2020 2020 7265 7475 726e 206b 6d69 6e2c      return kmin,
+0002cb00: 2064 6973 740a 0a64 6566 2063 6f6d 705f   dist..def comp_
+0002cb10: 6469 7374 5f6c 6f73 5f76 706f 6c79 5f76  dist_los_vpoly_v
+0002cb20: 6563 2869 6e74 206e 7670 6f6c 792c 2069  ec(int nvpoly, i
+0002cb30: 6e74 206e 6c6f 732c 0a20 2020 2020 2020  nt nlos,.       
+0002cb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cb50: 2020 2020 206e 702e 6e64 6172 7261 795b       np.ndarray[
+0002cb60: 646f 7562 6c65 2c6e 6469 6d3d 322c 6d6f  double,ndim=2,mo
+0002cb70: 6465 3d27 6327 5d20 7261 795f 6f72 6967  de='c'] ray_orig
+0002cb80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002cb90: 2020 2020 2020 2020 2020 2020 2020 6e70                np
+0002cba0: 2e6e 6461 7272 6179 5b64 6f75 626c 652c  .ndarray[double,
+0002cbb0: 6e64 696d 3d32 2c6d 6f64 653d 2763 275d  ndim=2,mode='c']
+0002cbc0: 2072 6179 5f76 6469 722c 0a20 2020 2020   ray_vdir,.     
+0002cbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cbe0: 2020 2020 2020 206e 702e 6e64 6172 7261         np.ndarra
+0002cbf0: 795b 646f 7562 6c65 2c6e 6469 6d3d 332c  y[double,ndim=3,
+0002cc00: 6d6f 6465 3d27 6327 5d20 7665 735f 706f  mode='c'] ves_po
+0002cc10: 6c79 2c0a 2020 2020 2020 2020 2020 2020  ly,.            
+0002cc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cc30: 646f 7562 6c65 2065 7073 5f75 7a3d 5f53  double eps_uz=_S
+0002cc40: 4d41 4c4c 2c20 646f 7562 6c65 2065 7073  MALL, double eps
+0002cc50: 5f61 3d5f 5653 4d41 4c4c 2c0a 2020 2020  _a=_VSMALL,.    
+0002cc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cc70: 2020 2020 2020 2020 646f 7562 6c65 2065          double e
+0002cc80: 7073 5f76 7a3d 5f56 534d 414c 4c2c 2064  ps_vz=_VSMALL, d
+0002cc90: 6f75 626c 6520 6570 735f 623d 5f56 534d  ouble eps_b=_VSM
+0002cca0: 414c 4c2c 0a20 2020 2020 2020 2020 2020  ALL,.           
+0002ccb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ccc0: 2064 6f75 626c 6520 6570 735f 706c 616e   double eps_plan
+0002ccd0: 653d 5f56 534d 414c 4c2c 2073 7472 2076  e=_VSMALL, str v
+0002cce0: 6573 5f74 7970 653d 2754 6f72 272c 0a20  es_type='Tor',. 
+0002ccf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cd00: 2020 2020 2020 2020 2020 2073 7472 2061             str a
+0002cd10: 6c67 6f5f 7479 7065 3d27 7369 6d70 6c65  lgo_type='simple
+0002cd20: 272c 2069 6e74 206e 756d 5f74 6872 6561  ', int num_threa
+0002cd30: 6473 3d31 3629 3a0a 2020 2020 2222 220a  ds=16):.    """.
+0002cd40: 2020 2020 5468 6973 2066 756e 6374 696f      This functio
+0002cd50: 6e20 636f 6d70 7574 6573 2074 6865 2064  n computes the d
+0002cd60: 6973 7461 6e63 6520 2861 6e64 2074 6865  istance (and the
+0002cd70: 2061 7373 6f63 6961 7465 6420 6b29 2062   associated k) b
+0002cd80: 6574 7765 656e 206e 6c6f 730a 2020 2020  etween nlos.    
+0002cd90: 5261 7973 2028 6f72 204c 4f53 2920 616e  Rays (or LOS) an
+0002cda0: 6420 7365 7665 7261 6c20 6049 4e60 2073  d several `IN` s
+0002cdb0: 7472 7563 7475 7265 7320 2870 6f6c 7967  tructures (polyg
+0002cdc0: 6f6e 7320 6578 7472 7564 6564 2061 726f  ons extruded aro
+0002cdd0: 756e 6420 7468 6520 6178 6973 0a20 2020  und the axis.   
+0002cde0: 2028 302c 302c 3129 2c20 6567 2e20 666c   (0,0,1), eg. fl
+0002cdf0: 7578 2073 7572 6661 6365 7329 2e0a 2020  ux surfaces)..  
+0002ce00: 2020 466f 7220 6d6f 7265 2064 6574 6169    For more detai
+0002ce10: 6c73 206f 6e20 7468 6520 616c 676f 7269  ls on the algori
+0002ce20: 7468 6d20 706c 6561 7365 2073 6565 2050  thm please see P
+0002ce30: 4446 3a20 3c6e 616d 655f 6f66 5f70 6466  DF: <name_of_pdf
+0002ce40: 3e2e 7064 6620 2354 4f44 4f0a 0a20 2020  >.pdf #TODO..   
+0002ce50: 2050 6172 616d 730a 2020 2020 3d3d 3d3d   Params.    ====
+0002ce60: 3d3d 0a20 2020 2020 2020 206e 7670 6f6c  ==.        nvpol
+0002ce70: 7920 3a20 696e 740a 2020 2020 2020 2020  y : int.        
+0002ce80: 2020 204e 756d 6265 7220 6f66 2066 6c75     Number of flu
+0002ce90: 7820 7375 7266 6163 6573 0a20 2020 2020  x surfaces.     
+0002cea0: 2020 206e 6c6f 7320 3a20 696e 740a 2020     nlos : int.  
+0002ceb0: 2020 2020 2020 2020 204e 756d 6265 7220           Number 
+0002cec0: 6f66 204c 4f53 0a20 2020 2020 2020 2072  of LOS.        r
+0002ced0: 6179 5f6f 7269 6720 3a20 2833 2c20 6e6c  ay_orig : (3, nl
+0002cee0: 6f73 2920 646f 7562 6c65 2061 7272 6179  os) double array
+0002cef0: 0a20 2020 2020 2020 2020 2020 4c4f 5320  .           LOS 
+0002cf00: 6f72 6967 696e 2070 6f69 6e74 7320 636f  origin points co
+0002cf10: 6f72 6469 6e61 7465 730a 2020 2020 2020  ordinates.      
+0002cf20: 2020 7261 795f 7664 6972 203a 2028 332c    ray_vdir : (3,
+0002cf30: 206e 6c6f 7329 2064 6f75 626c 6520 6172   nlos) double ar
+0002cf40: 7261 790a 2020 2020 2020 2020 2020 204c  ray.           L
+0002cf50: 4f53 206e 6f72 6d61 6c69 7a65 6420 6469  OS normalized di
+0002cf60: 7265 6374 696f 6e20 7665 6374 6f72 0a20  rection vector. 
+0002cf70: 2020 2020 2020 2076 6573 5f70 6f6c 7920         ves_poly 
+0002cf80: 3a20 286e 756d 5f70 6f6c 2c20 322c 206e  : (num_pol, 2, n
+0002cf90: 756d 5f76 6572 7465 7829 2064 6f75 626c  um_vertex) doubl
+0002cfa0: 6520 6172 7261 790a 2020 2020 2020 2020  e array.        
+0002cfb0: 2020 2043 6f6f 7264 696e 6174 6573 206f     Coordinates o
+0002cfc0: 6620 7468 6520 7665 7274 6963 6573 206f  f the vertices o
+0002cfd0: 6620 7468 6520 506f 6c79 676f 6e20 6465  f the Polygon de
+0002cfe0: 6669 6e69 6e67 2074 6865 2032 4420 706f  fining the 2D po
+0002cff0: 6c6f 6964 616c 0a20 2020 2020 2020 2020  loidal.         
+0002d000: 2020 6375 7420 6f66 2074 6865 2064 6966    cut of the dif
+0002d010: 6665 7265 6e74 2049 4e20 7375 7266 6163  ferent IN surfac
+0002d020: 6573 0a20 2020 2020 2020 2020 2020 5741  es.           WA
+0002d030: 524e 494e 4720 3a20 7765 2073 7570 706f  RNING : we suppo
+0002d040: 7365 2061 6c6c 2070 6f6c 7920 6172 6520  se all poly are 
+0002d050: 6e65 7374 6564 2069 6e20 6561 6368 206f  nested in each o
+0002d060: 7468 6572 2c0a 2020 2020 2020 2020 2020  ther,.          
+0002d070: 2020 2020 2020 2020 2020 2066 726f 6d20             from 
+0002d080: 696e 6e65 7220 746f 206f 7574 6572 0a20  inner to outer. 
+0002d090: 2020 2020 2020 2065 7073 5f3c 7661 6c3e         eps_<val>
+0002d0a0: 203a 2064 6f75 626c 650a 2020 2020 2020   : double.      
+0002d0b0: 2020 2020 2053 6d61 6c6c 2076 616c 7565       Small value
+0002d0c0: 2c20 6163 6365 7074 616e 6365 206f 6620  , acceptance of 
+0002d0d0: 6572 726f 720a 2020 2020 5265 7475 726e  error.    Return
+0002d0e0: 730a 2020 2020 3d3d 3d3d 3d3d 3d0a 2020  s.    =======.  
+0002d0f0: 2020 2020 2020 6b6d 696e 5f76 706f 6c79        kmin_vpoly
+0002d100: 203a 2028 6e70 6f6c 792c 206e 6c6f 7329   : (npoly, nlos)
+0002d110: 2064 6f75 626c 6520 6172 7261 790a 2020   double array.  
+0002d120: 2020 2020 2020 2020 2020 4f66 2074 6865            Of the
+0002d130: 2066 6f72 6d20 5b6b 5f30 302c 206b 5f30   form [k_00, k_0
+0002d140: 312c 202e 2e2e 2c20 6b5f 306e 2c20 6b5f  1, ..., k_0n, k_
+0002d150: 3130 2c20 6b5f 3131 2c20 2e2e 2e2c 206b  10, k_11, ..., k
+0002d160: 5f31 6e2c 202e 2e2e 5d0a 2020 2020 2020  _1n, ...].      
+0002d170: 2020 2020 2020 7768 6572 6520 6b5f 696a        where k_ij
+0002d180: 2069 7320 7468 6520 636f 6566 6669 6369   is the coeffici
+0002d190: 656e 7420 666f 7220 7468 6520 6a2d 7468  ent for the j-th
+0002d1a0: 2066 6c75 7820 7375 7266 6163 650a 2020   flux surface.  
+0002d1b0: 2020 2020 2020 2020 2020 7375 6368 2074            such t
+0002d1c0: 6861 7420 7468 6520 692d 7468 2072 6179  hat the i-th ray
+0002d1d0: 2028 4c4f 5329 2069 7320 636c 6f73 6573   (LOS) is closes
+0002d1e0: 7420 746f 2074 6865 2065 7874 7275 6465  t to the extrude
+0002d1f0: 6420 706f 6c79 676f 6e0a 2020 2020 2020  d polygon.      
+0002d200: 2020 2020 2020 6174 2074 6865 2070 6f69        at the poi
+0002d210: 6e74 2050 5f69 203d 206f 7269 675b 695d  nt P_i = orig[i]
+0002d220: 202b 206b 6d69 6e5b 695d 202a 2076 6469   + kmin[i] * vdi
+0002d230: 725b 695d 0a20 2020 2020 2020 2064 6973  r[i].        dis
+0002d240: 745f 7670 6f6c 7920 3a20 286e 706f 6c79  t_vpoly : (npoly
+0002d250: 2c20 6e6c 6f73 2920 646f 7562 6c65 2061  , nlos) double a
+0002d260: 7272 6179 0a20 2020 2020 2020 2020 2020  rray.           
+0002d270: 2060 6469 7374 616e 6365 5b69 202a 206e   `distance[i * n
+0002d280: 756d 5f70 6f6c 7920 2b20 6a5d 6020 6973  um_poly + j]` is
+0002d290: 2074 6865 2064 6973 7461 6e63 6520 6672   the distance fr
+0002d2a0: 6f6d 2050 5f69 2074 6f20 7468 6520 692d  om P_i to the i-
+0002d2b0: 7468 0a20 2020 2020 2020 2020 2020 2065  th.            e
+0002d2c0: 7874 7275 6465 6420 706f 6c79 2e0a 2020  xtruded poly..  
+0002d2d0: 2020 2d2d 2d0a 2020 2020 5468 6973 2069    ---.    This i
+0002d2e0: 7320 7468 6520 5059 5448 4f4e 2066 756e  s the PYTHON fun
+0002d2f0: 6374 696f 6e2c 2075 7365 206f 6e6c 7920  ction, use only 
+0002d300: 6966 2079 6f75 206e 6565 6420 7468 6973  if you need this
+0002d310: 2063 6f6d 7075 7461 7469 6f6e 2066 726f   computation fro
+0002d320: 6d0a 2020 2020 5079 7468 6f6e 2c20 6966  m.    Python, if
+0002d330: 2079 6f75 206e 6565 6420 6974 2066 726f   you need it fro
+0002d340: 6d20 6379 7468 6f6e 2c20 7573 6520 6063  m cython, use `c
+0002d350: 6f6d 705f 6469 7374 5f6c 6f73 5f76 706f  omp_dist_los_vpo
+0002d360: 6c79 5f76 6563 5f63 6f72 6560 0a20 2020  ly_vec_core`.   
+0002d370: 2022 2222 0a20 2020 2069 6620 6e6f 7420   """.    if not 
+0002d380: 616c 676f 5f74 7970 652e 6c6f 7765 7228  algo_type.lower(
+0002d390: 2920 3d3d 2022 7369 6d70 6c65 2220 6f72  ) == "simple" or
+0002d3a0: 206e 6f74 2076 6573 5f74 7970 652e 6c6f   not ves_type.lo
+0002d3b0: 7765 7228 2920 3d3d 2022 746f 7222 3a0a  wer() == "tor":.
+0002d3c0: 2020 2020 2020 2020 6173 7365 7274 2046          assert F
+0002d3d0: 616c 7365 2c20 2254 6865 2066 756e 6374  alse, "The funct
+0002d3e0: 696f 6e20 6973 206f 6e6c 7920 696d 706c  ion is only impl
+0002d3f0: 656d 656e 7465 6420 7769 7468 2074 6865  emented with the
+0002d400: 2073 696d 706c 6522 5c0a 2020 2020 2020   simple"\.      
+0002d410: 2020 2020 2020 2b20 2220 616c 676f 7269        + " algori
+0002d420: 7468 6d20 616e 6420 666f 7220 746f 726f  thm and for toro
+0002d430: 6964 616c 2076 6573 7365 6c73 2e2e 2e20  idal vessels... 
+0002d440: 536f 7272 7921 220a 2020 2020 7761 726e  Sorry!".    warn
+0002d450: 2822 5468 6973 2066 756e 6374 696f 6e20  ("This function 
+0002d460: 7375 7070 6f73 6573 2074 6861 7420 7468  supposes that th
+0002d470: 6520 706f 6c79 7320 6172 6520 6e65 7374  e polys are nest
+0002d480: 6564 2066 726f 6d20 696e 6e65 7220 746f  ed from inner to
+0002d490: 206f 7574 6572 222c 0a20 2020 2020 2020   outer",.       
+0002d4a0: 2020 5761 726e 696e 6729 0a0a 2020 2020    Warning)..    
+0002d4b0: 6364 6566 206e 702e 6e64 6172 7261 795b  cdef np.ndarray[
+0002d4c0: 646f 7562 6c65 2c20 6e64 696d 3d31 5d20  double, ndim=1] 
+0002d4d0: 6b6d 696e 203d 206e 702e 656d 7074 7928  kmin = np.empty(
+0002d4e0: 286e 7670 6f6c 792a 6e6c 6f73 2c29 2c20  (nvpoly*nlos,), 
+0002d4f0: 6474 7970 653d 666c 6f61 7429 0a20 2020  dtype=float).   
+0002d500: 2063 6465 6620 6e70 2e6e 6461 7272 6179   cdef np.ndarray
+0002d510: 5b64 6f75 626c 652c 206e 6469 6d3d 315d  [double, ndim=1]
+0002d520: 2064 6973 7420 3d20 6e70 2e65 6d70 7479   dist = np.empty
+0002d530: 2828 6e76 706f 6c79 2a6e 6c6f 732c 292c  ((nvpoly*nlos,),
+0002d540: 2064 7479 7065 3d66 6c6f 6174 290a 2020   dtype=float).  
+0002d550: 2020 6364 6566 2069 6e74 2061 6c67 6f5f    cdef int algo_
+0002d560: 6e75 6d20 3d20 300a 2020 2020 6364 6566  num = 0.    cdef
+0002d570: 2069 6e74 2076 6573 5f6e 756d 203d 2031   int ves_num = 1
+0002d580: 0a20 2020 205f 6474 2e63 6f6d 705f 6469  .    _dt.comp_di
+0002d590: 7374 5f6c 6f73 5f76 706f 6c79 5f76 6563  st_los_vpoly_vec
+0002d5a0: 5f63 6f72 6528 6e76 706f 6c79 2c20 6e6c  _core(nvpoly, nl
+0002d5b0: 6f73 2c0a 2020 2020 2020 2020 2020 2020  os,.            
 0002d5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d5d0: 2020 2020 2020 2020 2020 2076 6573 5f70             ves_p
-0002d5e0: 6f6c 792c 0a20 2020 2020 2020 2020 2020  oly,.           
+0002d5d0: 2020 2020 2020 2020 3c64 6f75 626c 652a          <double*
+0002d5e0: 3e72 6179 5f6f 7269 672e 6461 7461 2c0a  >ray_orig.data,.
 0002d5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d600: 2020 2020 2020 2020 2065 7073 5f75 7a2c           eps_uz,
-0002d610: 2065 7073 5f61 2c0a 2020 2020 2020 2020   eps_a,.        
-0002d620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d630: 2020 2020 2020 2020 2020 2020 6570 735f              eps_
-0002d640: 767a 2c20 6570 735f 622c 0a20 2020 2020  vz, eps_b,.     
-0002d650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d660: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0002d670: 7073 5f70 6c61 6e65 2c0a 2020 2020 2020  ps_plane,.      
-0002d680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d690: 2020 2020 2020 2020 2020 2020 2020 7665                ve
-0002d6a0: 735f 6e75 6d2c 0a20 2020 2020 2020 2020  s_num,.         
-0002d6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d6c0: 2020 2020 2020 2020 2020 2061 6c67 6f5f             algo_
-0002d6d0: 6e75 6d2c 0a20 2020 2020 2020 2020 2020  num,.           
-0002d6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d6f0: 2020 2020 2020 2020 2026 6b6d 696e 5b30           &kmin[0
-0002d700: 5d2c 2026 6469 7374 5b30 5d2c 0a20 2020  ], &dist[0],.   
-0002d710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d610: 2020 2020 3c64 6f75 626c 652a 3e72 6179      <double*>ray
+0002d620: 5f76 6469 722e 6461 7461 2c0a 2020 2020  _vdir.data,.    
+0002d630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d650: 7665 735f 706f 6c79 2c0a 2020 2020 2020  ves_poly,.      
+0002d660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d670: 2020 2020 2020 2020 2020 2020 2020 6570                ep
+0002d680: 735f 757a 2c20 6570 735f 612c 0a20 2020  s_uz, eps_a,.   
+0002d690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d6b0: 2065 7073 5f76 7a2c 2065 7073 5f62 2c0a   eps_vz, eps_b,.
+0002d6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d6e0: 2020 2020 6570 735f 706c 616e 652c 0a20      eps_plane,. 
+0002d6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d710: 2020 2076 6573 5f6e 756d 2c0a 2020 2020     ves_num,.    
 0002d720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d730: 2030 2e30 352c 0a20 2020 2020 2020 2020   0.05,.         
-0002d740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d750: 2020 2020 2020 2020 2020 206e 756d 5f74             num_t
-0002d760: 6872 6561 6473 290a 2020 2020 7265 7475  hreads).    retu
-0002d770: 726e 206b 6d69 6e2e 7265 7368 6170 6528  rn kmin.reshape(
-0002d780: 6e6c 6f73 2c20 6e76 706f 6c79 292c 5c0a  nlos, nvpoly),\.
-0002d790: 2020 2020 2020 2020 6469 7374 2e72 6573          dist.res
-0002d7a0: 6861 7065 286e 6c6f 732c 206e 7670 6f6c  hape(nlos, nvpol
-0002d7b0: 7929 0a0a 2320 3d3d 3d3d 3d3d 3d3d 3d3d  y)..# ==========
-0002d7c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002d7d0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002d7e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002d7f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002d800: 3d3d 3d3d 0a23 0a23 2020 2020 2020 2020  ====.#.#        
-0002d810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d820: 2041 5245 204c 4f53 2041 4e44 2045 5854   ARE LOS AND EXT
-0002d830: 2d50 4f4c 5920 434c 4f53 450a 230a 2320  -POLY CLOSE.#.# 
+0002d730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d740: 616c 676f 5f6e 756d 2c0a 2020 2020 2020  algo_num,.      
+0002d750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d760: 2020 2020 2020 2020 2020 2020 2020 266b                &k
+0002d770: 6d69 6e5b 305d 2c20 2664 6973 745b 305d  min[0], &dist[0]
+0002d780: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002d790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d7a0: 2020 2020 2020 302e 3035 2c0a 2020 2020        0.05,.    
+0002d7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d7d0: 6e75 6d5f 7468 7265 6164 7329 0a20 2020  num_threads).   
+0002d7e0: 2072 6574 7572 6e20 6b6d 696e 2e72 6573   return kmin.res
+0002d7f0: 6861 7065 286e 6c6f 732c 206e 7670 6f6c  hape(nlos, nvpol
+0002d800: 7929 2c5c 0a20 2020 2020 2020 2064 6973  y),\.        dis
+0002d810: 742e 7265 7368 6170 6528 6e6c 6f73 2c20  t.reshape(nlos, 
+0002d820: 6e76 706f 6c79 290a 0a23 203d 3d3d 3d3d  nvpoly)..# =====
+0002d830: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
 0002d840: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
 0002d850: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
 0002d860: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002d870: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002d880: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 0a0a  ==============..
-0002d890: 6465 6620 6973 5f63 6c6f 7365 5f6c 6f73  def is_close_los
-0002d8a0: 5f76 706f 6c79 5f76 6563 2869 6e74 206e  _vpoly_vec(int n
-0002d8b0: 7670 6f6c 792c 2069 6e74 206e 6c6f 732c  vpoly, int nlos,
-0002d8c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002d8d0: 2020 2020 2020 2020 2020 2020 6e70 2e6e              np.n
-0002d8e0: 6461 7272 6179 5b64 6f75 626c 652c 6e64  darray[double,nd
-0002d8f0: 696d 3d32 2c6d 6f64 653d 2763 275d 2072  im=2,mode='c'] r
-0002d900: 6179 5f6f 7269 672c 0a20 2020 2020 2020  ay_orig,.       
-0002d910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d920: 2020 2020 6e70 2e6e 6461 7272 6179 5b64      np.ndarray[d
-0002d930: 6f75 626c 652c 6e64 696d 3d32 2c6d 6f64  ouble,ndim=2,mod
-0002d940: 653d 2763 275d 2072 6179 5f76 6469 722c  e='c'] ray_vdir,
-0002d950: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002d960: 2020 2020 2020 2020 2020 2020 6e70 2e6e              np.n
-0002d970: 6461 7272 6179 5b64 6f75 626c 652c 6e64  darray[double,nd
-0002d980: 696d 3d33 2c6d 6f64 653d 2763 275d 2076  im=3,mode='c'] v
-0002d990: 6573 5f70 6f6c 792c 0a20 2020 2020 2020  es_poly,.       
-0002d9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d9b0: 2020 2020 646f 7562 6c65 2065 7073 696c      double epsil
-0002d9c0: 6f6e 2c0a 2020 2020 2020 2020 2020 2020  on,.            
-0002d9d0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0002d9e0: 6f75 626c 6520 6570 735f 757a 3d5f 534d  ouble eps_uz=_SM
-0002d9f0: 414c 4c2c 2064 6f75 626c 6520 6570 735f  ALL, double eps_
-0002da00: 613d 5f56 534d 414c 4c2c 0a20 2020 2020  a=_VSMALL,.     
+0002d870: 3d3d 3d3d 3d3d 3d3d 3d0a 230a 2320 2020  =========.#.#   
+0002d880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d890: 2020 2020 2020 4152 4520 4c4f 5320 414e        ARE LOS AN
+0002d8a0: 4420 4558 542d 504f 4c59 2043 4c4f 5345  D EXT-POLY CLOSE
+0002d8b0: 0a23 0a23 203d 3d3d 3d3d 3d3d 3d3d 3d3d  .#.# ===========
+0002d8c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002d8d0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002d8e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002d8f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002d900: 3d3d 3d0a 0a64 6566 2069 735f 636c 6f73  ===..def is_clos
+0002d910: 655f 6c6f 735f 7670 6f6c 795f 7665 6328  e_los_vpoly_vec(
+0002d920: 696e 7420 6e76 706f 6c79 2c20 696e 7420  int nvpoly, int 
+0002d930: 6e6c 6f73 2c0a 2020 2020 2020 2020 2020  nlos,.          
+0002d940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d950: 206e 702e 6e64 6172 7261 795b 646f 7562   np.ndarray[doub
+0002d960: 6c65 2c6e 6469 6d3d 322c 6d6f 6465 3d27  le,ndim=2,mode='
+0002d970: 6327 5d20 7261 795f 6f72 6967 2c0a 2020  c'] ray_orig,.  
+0002d980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d990: 2020 2020 2020 2020 206e 702e 6e64 6172           np.ndar
+0002d9a0: 7261 795b 646f 7562 6c65 2c6e 6469 6d3d  ray[double,ndim=
+0002d9b0: 322c 6d6f 6465 3d27 6327 5d20 7261 795f  2,mode='c'] ray_
+0002d9c0: 7664 6972 2c0a 2020 2020 2020 2020 2020  vdir,.          
+0002d9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d9e0: 206e 702e 6e64 6172 7261 795b 646f 7562   np.ndarray[doub
+0002d9f0: 6c65 2c6e 6469 6d3d 332c 6d6f 6465 3d27  le,ndim=3,mode='
+0002da00: 6327 5d20 7665 735f 706f 6c79 2c0a 2020  c'] ves_poly,.  
 0002da10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002da20: 2020 2020 2020 646f 7562 6c65 2065 7073        double eps
-0002da30: 5f76 7a3d 5f56 534d 414c 4c2c 2064 6f75  _vz=_VSMALL, dou
-0002da40: 626c 6520 6570 735f 623d 5f56 534d 414c  ble eps_b=_VSMAL
-0002da50: 4c2c 0a20 2020 2020 2020 2020 2020 2020  L,.             
-0002da60: 2020 2020 2020 2020 2020 2020 2020 646f                do
-0002da70: 7562 6c65 2065 7073 5f70 6c61 6e65 3d5f  uble eps_plane=_
-0002da80: 5653 4d41 4c4c 2c20 7374 7220 7665 735f  VSMALL, str ves_
-0002da90: 7479 7065 3d27 546f 7227 2c0a 2020 2020  type='Tor',.    
-0002daa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dab0: 2020 2020 2020 2073 7472 2061 6c67 6f5f         str algo_
-0002dac0: 7479 7065 3d27 7369 6d70 6c65 272c 2069  type='simple', i
-0002dad0: 6e74 206e 756d 5f74 6872 6561 6473 3d31  nt num_threads=1
-0002dae0: 3629 3a0a 2020 2020 2222 220a 2020 2020  6):.    """.    
-0002daf0: 5468 6973 2066 756e 6374 696f 6e20 7465  This function te
-0002db00: 7374 7320 6966 2074 6865 2064 6973 7461  sts if the dista
-0002db10: 6e63 6520 6265 7477 6565 6e20 6e6c 6f73  nce between nlos
-0002db20: 2052 6179 7320 286f 7220 4c4f 5329 2061   Rays (or LOS) a
-0002db30: 6e64 0a20 2020 2073 6576 6572 616c 2060  nd.    several `
-0002db40: 494e 6020 7374 7275 6374 7572 6573 2028  IN` structures (
-0002db50: 706f 6c79 676f 6e73 2065 7874 7275 6465  polygons extrude
-0002db60: 6420 6172 6f75 6e64 2074 6865 2061 7869  d around the axi
-0002db70: 7320 2830 2c30 2c31 292c 0a20 2020 2065  s (0,0,1),.    e
-0002db80: 672e 2066 6c75 7820 7375 7266 6163 6573  g. flux surfaces
-0002db90: 2920 6973 2073 6d61 6c6c 6572 2074 6861  ) is smaller tha
-0002dba0: 6e20 6065 7073 696c 6f6e 602e 0a20 2020  n `epsilon`..   
-0002dbb0: 2046 6f72 206d 6f72 6520 6465 7461 696c   For more detail
-0002dbc0: 7320 6f6e 2074 6865 2061 6c67 6f72 6974  s on the algorit
-0002dbd0: 686d 2070 6c65 6173 6520 7365 6520 5044  hm please see PD
-0002dbe0: 463a 203c 6e61 6d65 5f6f 665f 7064 663e  F: <name_of_pdf>
-0002dbf0: 2e70 6466 2023 544f 444f 0a0a 2020 2020  .pdf #TODO..    
-0002dc00: 5061 7261 6d73 0a20 2020 203d 3d3d 3d3d  Params.    =====
-0002dc10: 3d0a 2020 2020 2020 2020 6e76 706f 6c79  =.        nvpoly
-0002dc20: 203a 2069 6e74 0a20 2020 2020 2020 2020   : int.         
-0002dc30: 2020 4e75 6d62 6572 206f 6620 666c 7578    Number of flux
-0002dc40: 2073 7572 6661 6365 730a 2020 2020 2020   surfaces.      
-0002dc50: 2020 6e6c 6f73 203a 2069 6e74 0a20 2020    nlos : int.   
-0002dc60: 2020 2020 2020 2020 4e75 6d62 6572 206f          Number o
-0002dc70: 6620 4c4f 530a 2020 2020 2020 2020 7261  f LOS.        ra
-0002dc80: 795f 6f72 6967 203a 2028 332c 206e 6c6f  y_orig : (3, nlo
-0002dc90: 7329 2064 6f75 626c 6520 6172 7261 790a  s) double array.
-0002dca0: 2020 2020 2020 2020 2020 204c 4f53 206f             LOS o
-0002dcb0: 7269 6769 6e20 706f 696e 7473 2063 6f6f  rigin points coo
-0002dcc0: 7264 696e 6174 6573 0a20 2020 2020 2020  rdinates.       
-0002dcd0: 2072 6179 5f76 6469 7220 3a20 2833 2c20   ray_vdir : (3, 
-0002dce0: 6e6c 6f73 2920 646f 7562 6c65 2061 7272  nlos) double arr
-0002dcf0: 6179 0a20 2020 2020 2020 2020 2020 4c4f  ay.           LO
-0002dd00: 5320 6e6f 726d 616c 697a 6564 2064 6972  S normalized dir
-0002dd10: 6563 7469 6f6e 2076 6563 746f 720a 2020  ection vector.  
-0002dd20: 2020 2020 2020 7665 735f 706f 6c79 203a        ves_poly :
-0002dd30: 2028 6e75 6d5f 706f 6c2c 2032 2c20 6e75   (num_pol, 2, nu
-0002dd40: 6d5f 7665 7274 6578 2920 646f 7562 6c65  m_vertex) double
-0002dd50: 2061 7272 6179 0a20 2020 2020 2020 2020   array.         
-0002dd60: 2020 436f 6f72 6469 6e61 7465 7320 6f66    Coordinates of
-0002dd70: 2074 6865 2076 6572 7469 6365 7320 6f66   the vertices of
-0002dd80: 2074 6865 2050 6f6c 7967 6f6e 2064 6566   the Polygon def
-0002dd90: 696e 696e 6720 7468 6520 3244 2070 6f6c  ining the 2D pol
-0002dda0: 6f69 6461 6c0a 2020 2020 2020 2020 2020  oidal.          
-0002ddb0: 2063 7574 206f 6620 7468 6520 6469 6666   cut of the diff
-0002ddc0: 6572 656e 7420 494e 2073 7572 6661 6365  erent IN surface
-0002ddd0: 730a 2020 2020 2020 2020 2020 2057 4152  s.           WAR
-0002dde0: 4e49 4e47 203a 2077 6520 7375 7070 6f73  NING : we suppos
-0002ddf0: 6520 616c 6c20 706f 6c79 2061 7265 206e  e all poly are n
-0002de00: 6573 7465 6420 696e 2065 6163 6820 6f74  ested in each ot
-0002de10: 6865 722c 0a20 2020 2020 2020 2020 2020  her,.           
-0002de20: 2020 2020 2020 2020 2020 616e 6420 7468            and th
-0002de30: 6520 6669 7273 7420 6f6e 6520 6973 2074  e first one is t
-0002de40: 6865 2073 6d61 6c6c 6573 7420 6f6e 650a  he smallest one.
-0002de50: 2020 2020 2020 2020 6570 7369 6c6f 6e20          epsilon 
-0002de60: 3a20 646f 7562 6c65 0a20 2020 2020 2020  : double.       
-0002de70: 2020 2020 5661 6c75 6520 666f 7220 7465      Value for te
-0002de80: 7374 696e 6720 6966 2064 6973 7461 6e63  sting if distanc
-0002de90: 6520 3c20 6570 7369 6c6f 6e0a 2020 2020  e < epsilon.    
-0002dea0: 2020 2020 6570 735f 3c76 616c 3e20 3a20      eps_<val> : 
-0002deb0: 646f 7562 6c65 0a20 2020 2020 2020 2020  double.         
-0002dec0: 2020 536d 616c 6c20 7661 6c75 652c 2061    Small value, a
-0002ded0: 6363 6570 7461 6e63 6520 6f66 2065 7272  cceptance of err
-0002dee0: 6f72 0a20 2020 2052 6574 7572 6e73 0a20  or.    Returns. 
-0002def0: 2020 203d 3d3d 3d3d 3d3d 0a20 2020 2020     =======.     
-0002df00: 2020 2061 7265 5f63 6c6f 7365 203a 2028     are_close : (
-0002df10: 6e70 6f6c 7920 2a20 6e6c 6f73 2920 626f  npoly * nlos) bo
-0002df20: 6f6c 2061 7272 6179 0a20 2020 2020 2020  ol array.       
-0002df30: 2020 2020 2060 6172 655f 636c 6f73 655b       `are_close[
-0002df40: 6920 2a20 6e75 6d5f 706f 6c79 202b 206a  i * num_poly + j
-0002df50: 5d60 2069 6e64 6963 6174 6573 2069 6620  ]` indicates if 
-0002df60: 6469 7374 616e 6365 2062 6574 7765 656e  distance between
-0002df70: 2069 2d74 6820 4c4f 530a 2020 2020 2020   i-th LOS.      
-0002df80: 2020 2020 2020 616e 6420 6a2d 7468 2070        and j-th p
-0002df90: 6f6c 7920 6172 6520 636c 6f73 6572 2074  oly are closer t
-0002dfa0: 6861 6e20 6570 7369 6c6f 6e2e 2028 5472  han epsilon. (Tr
-0002dfb0: 7565 2069 6620 6469 7374 616e 6365 3c65  ue if distance<e
-0002dfc0: 7073 696c 6f6e 290a 2020 2020 2d2d 2d0a  psilon).    ---.
-0002dfd0: 2020 2020 5468 6973 2069 7320 7468 6520      This is the 
-0002dfe0: 5059 5448 4f4e 2066 756e 6374 696f 6e2c  PYTHON function,
-0002dff0: 2075 7365 206f 6e6c 7920 6966 2079 6f75   use only if you
-0002e000: 206e 6565 6420 7468 6973 2063 6f6d 7075   need this compu
-0002e010: 7461 7469 6f6e 2066 726f 6d0a 2020 2020  tation from.    
-0002e020: 5079 7468 6f6e 2c20 6966 2079 6f75 206e  Python, if you n
-0002e030: 6565 6420 6974 2066 726f 6d20 6379 7468  eed it from cyth
-0002e040: 6f6e 2c20 7573 6520 6069 735f 636c 6f73  on, use `is_clos
-0002e050: 655f 6c6f 735f 7670 6f6c 795f 7665 635f  e_los_vpoly_vec_
-0002e060: 636f 7265 600a 2020 2020 2222 220a 2020  core`.    """.  
-0002e070: 2020 7761 726e 2822 5468 6973 2066 756e    warn("This fun
-0002e080: 6374 696f 6e20 7375 7070 6f73 6573 2074  ction supposes t
-0002e090: 6861 7420 7468 6520 706f 6c79 7320 6172  hat the polys ar
-0002e0a0: 6520 6e65 7374 6564 2066 726f 6d20 696e  e nested from in
-0002e0b0: 6e65 7220 746f 206f 7574 6572 222c 0a20  ner to outer",. 
-0002e0c0: 2020 2020 2020 2020 5761 726e 696e 6729          Warning)
-0002e0d0: 0a20 2020 2023 203d 3d3d 3d3d 3d3d 3d3d  .    # =========
-0002e0e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002e0f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002e100: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002e110: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002e120: 3d0a 2020 2020 6966 206e 6f74 2061 6c67  =.    if not alg
-0002e130: 6f5f 7479 7065 2e6c 6f77 6572 2829 203d  o_type.lower() =
-0002e140: 3d20 2273 696d 706c 6522 206f 7220 6e6f  = "simple" or no
-0002e150: 7420 7665 735f 7479 7065 2e6c 6f77 6572  t ves_type.lower
-0002e160: 2829 203d 3d20 2274 6f72 223a 0a20 2020  () == "tor":.   
-0002e170: 2020 2020 2061 7373 6572 7420 4661 6c73       assert Fals
-0002e180: 652c 2022 5468 6520 6675 6e63 7469 6f6e  e, "The function
-0002e190: 2069 7320 6f6e 6c79 2069 6d70 6c65 6d65   is only impleme
-0002e1a0: 6e74 6564 2077 6974 6820 7468 6520 7369  nted with the si
-0002e1b0: 6d70 6c65 225c 0a20 2020 2020 2020 2020  mple"\.         
-0002e1c0: 2020 202b 2022 2061 6c67 6f72 6974 686d     + " algorithm
-0002e1d0: 2061 6e64 2066 6f72 2074 6f72 6f69 6461   and for toroida
-0002e1e0: 6c20 7665 7373 656c 732e 2e2e 2053 6f72  l vessels... Sor
-0002e1f0: 7279 2122 0a20 2020 2077 6172 6e28 2254  ry!".    warn("T
-0002e200: 6869 7320 6675 6e63 7469 6f6e 2073 7570  his function sup
-0002e210: 706f 7365 7320 7468 6174 2074 6865 2070  poses that the p
-0002e220: 6f6c 7973 2061 7265 206e 6573 7465 6420  olys are nested 
-0002e230: 6672 6f6d 2069 6e6e 6572 2074 6f20 6f75  from inner to ou
-0002e240: 7465 7222 2c0a 2020 2020 2020 2020 2057  ter",.         W
-0002e250: 6172 6e69 6e67 290a 2020 2020 2320 3d3d  arning).    # ==
-0002e260: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002e270: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002e280: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002e290: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002e2a0: 3d3d 3d3d 3d3d 3d3d 0a0a 2020 2020 6364  ========..    cd
-0002e2b0: 6566 2061 7272 6179 2061 7265 5f63 6c6f  ef array are_clo
-0002e2c0: 7365 203d 2063 6c6f 6e65 2861 7272 6179  se = clone(array
-0002e2d0: 2827 6927 292c 206e 7670 6f6c 792a 6e6c  ('i'), nvpoly*nl
-0002e2e0: 6f73 2c20 5472 7565 290a 2020 2020 5f64  os, True).    _d
-0002e2f0: 742e 6973 5f63 6c6f 7365 5f6c 6f73 5f76  t.is_close_los_v
-0002e300: 706f 6c79 5f76 6563 5f63 6f72 6528 6e76  poly_vec_core(nv
-0002e310: 706f 6c79 2c20 6e6c 6f73 2c0a 2020 2020  poly, nlos,.    
-0002e320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e330: 2020 2020 2020 2020 2020 2020 3c64 6f75              <dou
-0002e340: 626c 652a 3e72 6179 5f6f 7269 672e 6461  ble*>ray_orig.da
-0002e350: 7461 2c0a 2020 2020 2020 2020 2020 2020  ta,.            
-0002e360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e370: 2020 2020 3c64 6f75 626c 652a 3e72 6179      <double*>ray
-0002e380: 5f76 6469 722e 6461 7461 2c0a 2020 2020  _vdir.data,.    
-0002e390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e3a0: 2020 2020 2020 2020 2020 2020 7665 735f              ves_
-0002e3b0: 706f 6c79 2c0a 2020 2020 2020 2020 2020  poly,.          
-0002e3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e3d0: 2020 2020 2020 6570 735f 757a 2c20 6570        eps_uz, ep
-0002e3e0: 735f 612c 0a20 2020 2020 2020 2020 2020  s_a,.           
-0002e3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e400: 2020 2020 2065 7073 5f76 7a2c 2065 7073       eps_vz, eps
-0002e410: 5f62 2c0a 2020 2020 2020 2020 2020 2020  _b,.            
-0002e420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e430: 2020 2020 6570 735f 706c 616e 652c 0a20      eps_plane,. 
-0002e440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e450: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0002e460: 7073 696c 6f6e 2c0a 2020 2020 2020 2020  psilon,.        
-0002e470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e480: 2020 2020 2020 2020 6172 655f 636c 6f73          are_clos
-0002e490: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0002e4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e4b0: 2020 206e 756d 5f74 6872 6561 6473 290a     num_threads).
-0002e4c0: 2020 2020 7265 7475 726e 206e 702e 6173      return np.as
-0002e4d0: 6172 7261 7928 6172 655f 636c 6f73 652c  array(are_close,
-0002e4e0: 2064 7479 7065 3d62 6f6f 6c29 2e72 6573   dtype=bool).res
-0002e4f0: 6861 7065 286e 6c6f 732c 206e 7670 6f6c  hape(nlos, nvpol
-0002e500: 7929 0a0a 2320 3d3d 3d3d 3d3d 3d3d 3d3d  y)..# ==========
-0002e510: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002e520: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002e530: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002e540: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002e550: 3d3d 3d3d 0a23 0a23 2020 2020 2020 2020  ====.#.#        
-0002e560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e570: 2057 4849 4348 204c 4f53 2f56 504f 4c59   WHICH LOS/VPOLY
-0002e580: 2049 5320 434c 4f53 4552 0a23 0a23 203d   IS CLOSER.#.# =
+0002da20: 2020 2020 2020 2020 2064 6f75 626c 6520           double 
+0002da30: 6570 7369 6c6f 6e2c 0a20 2020 2020 2020  epsilon,.       
+0002da40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002da50: 2020 2020 646f 7562 6c65 2065 7073 5f75      double eps_u
+0002da60: 7a3d 5f53 4d41 4c4c 2c20 646f 7562 6c65  z=_SMALL, double
+0002da70: 2065 7073 5f61 3d5f 5653 4d41 4c4c 2c0a   eps_a=_VSMALL,.
+0002da80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002da90: 2020 2020 2020 2020 2020 2064 6f75 626c             doubl
+0002daa0: 6520 6570 735f 767a 3d5f 5653 4d41 4c4c  e eps_vz=_VSMALL
+0002dab0: 2c20 646f 7562 6c65 2065 7073 5f62 3d5f  , double eps_b=_
+0002dac0: 5653 4d41 4c4c 2c0a 2020 2020 2020 2020  VSMALL,.        
+0002dad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002dae0: 2020 2064 6f75 626c 6520 6570 735f 706c     double eps_pl
+0002daf0: 616e 653d 5f56 534d 414c 4c2c 2073 7472  ane=_VSMALL, str
+0002db00: 2076 6573 5f74 7970 653d 2754 6f72 272c   ves_type='Tor',
+0002db10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002db20: 2020 2020 2020 2020 2020 2020 7374 7220              str 
+0002db30: 616c 676f 5f74 7970 653d 2773 696d 706c  algo_type='simpl
+0002db40: 6527 2c20 696e 7420 6e75 6d5f 7468 7265  e', int num_thre
+0002db50: 6164 733d 3136 293a 0a20 2020 2022 2222  ads=16):.    """
+0002db60: 0a20 2020 2054 6869 7320 6675 6e63 7469  .    This functi
+0002db70: 6f6e 2074 6573 7473 2069 6620 7468 6520  on tests if the 
+0002db80: 6469 7374 616e 6365 2062 6574 7765 656e  distance between
+0002db90: 206e 6c6f 7320 5261 7973 2028 6f72 204c   nlos Rays (or L
+0002dba0: 4f53 2920 616e 640a 2020 2020 7365 7665  OS) and.    seve
+0002dbb0: 7261 6c20 6049 4e60 2073 7472 7563 7475  ral `IN` structu
+0002dbc0: 7265 7320 2870 6f6c 7967 6f6e 7320 6578  res (polygons ex
+0002dbd0: 7472 7564 6564 2061 726f 756e 6420 7468  truded around th
+0002dbe0: 6520 6178 6973 2028 302c 302c 3129 2c0a  e axis (0,0,1),.
+0002dbf0: 2020 2020 6567 2e20 666c 7578 2073 7572      eg. flux sur
+0002dc00: 6661 6365 7329 2069 7320 736d 616c 6c65  faces) is smalle
+0002dc10: 7220 7468 616e 2060 6570 7369 6c6f 6e60  r than `epsilon`
+0002dc20: 2e0a 2020 2020 466f 7220 6d6f 7265 2064  ..    For more d
+0002dc30: 6574 6169 6c73 206f 6e20 7468 6520 616c  etails on the al
+0002dc40: 676f 7269 7468 6d20 706c 6561 7365 2073  gorithm please s
+0002dc50: 6565 2050 4446 3a20 3c6e 616d 655f 6f66  ee PDF: <name_of
+0002dc60: 5f70 6466 3e2e 7064 6620 2354 4f44 4f0a  _pdf>.pdf #TODO.
+0002dc70: 0a20 2020 2050 6172 616d 730a 2020 2020  .    Params.    
+0002dc80: 3d3d 3d3d 3d3d 0a20 2020 2020 2020 206e  ======.        n
+0002dc90: 7670 6f6c 7920 3a20 696e 740a 2020 2020  vpoly : int.    
+0002dca0: 2020 2020 2020 204e 756d 6265 7220 6f66         Number of
+0002dcb0: 2066 6c75 7820 7375 7266 6163 6573 0a20   flux surfaces. 
+0002dcc0: 2020 2020 2020 206e 6c6f 7320 3a20 696e         nlos : in
+0002dcd0: 740a 2020 2020 2020 2020 2020 204e 756d  t.           Num
+0002dce0: 6265 7220 6f66 204c 4f53 0a20 2020 2020  ber of LOS.     
+0002dcf0: 2020 2072 6179 5f6f 7269 6720 3a20 2833     ray_orig : (3
+0002dd00: 2c20 6e6c 6f73 2920 646f 7562 6c65 2061  , nlos) double a
+0002dd10: 7272 6179 0a20 2020 2020 2020 2020 2020  rray.           
+0002dd20: 4c4f 5320 6f72 6967 696e 2070 6f69 6e74  LOS origin point
+0002dd30: 7320 636f 6f72 6469 6e61 7465 730a 2020  s coordinates.  
+0002dd40: 2020 2020 2020 7261 795f 7664 6972 203a        ray_vdir :
+0002dd50: 2028 332c 206e 6c6f 7329 2064 6f75 626c   (3, nlos) doubl
+0002dd60: 6520 6172 7261 790a 2020 2020 2020 2020  e array.        
+0002dd70: 2020 204c 4f53 206e 6f72 6d61 6c69 7a65     LOS normalize
+0002dd80: 6420 6469 7265 6374 696f 6e20 7665 6374  d direction vect
+0002dd90: 6f72 0a20 2020 2020 2020 2076 6573 5f70  or.        ves_p
+0002dda0: 6f6c 7920 3a20 286e 756d 5f70 6f6c 2c20  oly : (num_pol, 
+0002ddb0: 322c 206e 756d 5f76 6572 7465 7829 2064  2, num_vertex) d
+0002ddc0: 6f75 626c 6520 6172 7261 790a 2020 2020  ouble array.    
+0002ddd0: 2020 2020 2020 2043 6f6f 7264 696e 6174         Coordinat
+0002dde0: 6573 206f 6620 7468 6520 7665 7274 6963  es of the vertic
+0002ddf0: 6573 206f 6620 7468 6520 506f 6c79 676f  es of the Polygo
+0002de00: 6e20 6465 6669 6e69 6e67 2074 6865 2032  n defining the 2
+0002de10: 4420 706f 6c6f 6964 616c 0a20 2020 2020  D poloidal.     
+0002de20: 2020 2020 2020 6375 7420 6f66 2074 6865        cut of the
+0002de30: 2064 6966 6665 7265 6e74 2049 4e20 7375   different IN su
+0002de40: 7266 6163 6573 0a20 2020 2020 2020 2020  rfaces.         
+0002de50: 2020 5741 524e 494e 4720 3a20 7765 2073    WARNING : we s
+0002de60: 7570 706f 7365 2061 6c6c 2070 6f6c 7920  uppose all poly 
+0002de70: 6172 6520 6e65 7374 6564 2069 6e20 6561  are nested in ea
+0002de80: 6368 206f 7468 6572 2c0a 2020 2020 2020  ch other,.      
+0002de90: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0002dea0: 6e64 2074 6865 2066 6972 7374 206f 6e65  nd the first one
+0002deb0: 2069 7320 7468 6520 736d 616c 6c65 7374   is the smallest
+0002dec0: 206f 6e65 0a20 2020 2020 2020 2065 7073   one.        eps
+0002ded0: 696c 6f6e 203a 2064 6f75 626c 650a 2020  ilon : double.  
+0002dee0: 2020 2020 2020 2020 2056 616c 7565 2066           Value f
+0002def0: 6f72 2074 6573 7469 6e67 2069 6620 6469  or testing if di
+0002df00: 7374 616e 6365 203c 2065 7073 696c 6f6e  stance < epsilon
+0002df10: 0a20 2020 2020 2020 2065 7073 5f3c 7661  .        eps_<va
+0002df20: 6c3e 203a 2064 6f75 626c 650a 2020 2020  l> : double.    
+0002df30: 2020 2020 2020 2053 6d61 6c6c 2076 616c         Small val
+0002df40: 7565 2c20 6163 6365 7074 616e 6365 206f  ue, acceptance o
+0002df50: 6620 6572 726f 720a 2020 2020 5265 7475  f error.    Retu
+0002df60: 726e 730a 2020 2020 3d3d 3d3d 3d3d 3d0a  rns.    =======.
+0002df70: 2020 2020 2020 2020 6172 655f 636c 6f73          are_clos
+0002df80: 6520 3a20 286e 706f 6c79 202a 206e 6c6f  e : (npoly * nlo
+0002df90: 7329 2062 6f6f 6c20 6172 7261 790a 2020  s) bool array.  
+0002dfa0: 2020 2020 2020 2020 2020 6061 7265 5f63            `are_c
+0002dfb0: 6c6f 7365 5b69 202a 206e 756d 5f70 6f6c  lose[i * num_pol
+0002dfc0: 7920 2b20 6a5d 6020 696e 6469 6361 7465  y + j]` indicate
+0002dfd0: 7320 6966 2064 6973 7461 6e63 6520 6265  s if distance be
+0002dfe0: 7477 6565 6e20 692d 7468 204c 4f53 0a20  tween i-th LOS. 
+0002dff0: 2020 2020 2020 2020 2020 2061 6e64 206a             and j
+0002e000: 2d74 6820 706f 6c79 2061 7265 2063 6c6f  -th poly are clo
+0002e010: 7365 7220 7468 616e 2065 7073 696c 6f6e  ser than epsilon
+0002e020: 2e20 2854 7275 6520 6966 2064 6973 7461  . (True if dista
+0002e030: 6e63 653c 6570 7369 6c6f 6e29 0a20 2020  nce<epsilon).   
+0002e040: 202d 2d2d 0a20 2020 2054 6869 7320 6973   ---.    This is
+0002e050: 2074 6865 2050 5954 484f 4e20 6675 6e63   the PYTHON func
+0002e060: 7469 6f6e 2c20 7573 6520 6f6e 6c79 2069  tion, use only i
+0002e070: 6620 796f 7520 6e65 6564 2074 6869 7320  f you need this 
+0002e080: 636f 6d70 7574 6174 696f 6e20 6672 6f6d  computation from
+0002e090: 0a20 2020 2050 7974 686f 6e2c 2069 6620  .    Python, if 
+0002e0a0: 796f 7520 6e65 6564 2069 7420 6672 6f6d  you need it from
+0002e0b0: 2063 7974 686f 6e2c 2075 7365 2060 6973   cython, use `is
+0002e0c0: 5f63 6c6f 7365 5f6c 6f73 5f76 706f 6c79  _close_los_vpoly
+0002e0d0: 5f76 6563 5f63 6f72 6560 0a20 2020 2022  _vec_core`.    "
+0002e0e0: 2222 0a20 2020 2077 6172 6e28 2254 6869  "".    warn("Thi
+0002e0f0: 7320 6675 6e63 7469 6f6e 2073 7570 706f  s function suppo
+0002e100: 7365 7320 7468 6174 2074 6865 2070 6f6c  ses that the pol
+0002e110: 7973 2061 7265 206e 6573 7465 6420 6672  ys are nested fr
+0002e120: 6f6d 2069 6e6e 6572 2074 6f20 6f75 7465  om inner to oute
+0002e130: 7222 2c0a 2020 2020 2020 2020 2057 6172  r",.         War
+0002e140: 6e69 6e67 290a 2020 2020 2320 3d3d 3d3d  ning).    # ====
+0002e150: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002e160: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002e170: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002e180: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002e190: 3d3d 3d3d 3d3d 0a20 2020 2069 6620 6e6f  ======.    if no
+0002e1a0: 7420 616c 676f 5f74 7970 652e 6c6f 7765  t algo_type.lowe
+0002e1b0: 7228 2920 3d3d 2022 7369 6d70 6c65 2220  r() == "simple" 
+0002e1c0: 6f72 206e 6f74 2076 6573 5f74 7970 652e  or not ves_type.
+0002e1d0: 6c6f 7765 7228 2920 3d3d 2022 746f 7222  lower() == "tor"
+0002e1e0: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
+0002e1f0: 2046 616c 7365 2c20 2254 6865 2066 756e   False, "The fun
+0002e200: 6374 696f 6e20 6973 206f 6e6c 7920 696d  ction is only im
+0002e210: 706c 656d 656e 7465 6420 7769 7468 2074  plemented with t
+0002e220: 6865 2073 696d 706c 6522 5c0a 2020 2020  he simple"\.    
+0002e230: 2020 2020 2020 2020 2b20 2220 616c 676f          + " algo
+0002e240: 7269 7468 6d20 616e 6420 666f 7220 746f  rithm and for to
+0002e250: 726f 6964 616c 2076 6573 7365 6c73 2e2e  roidal vessels..
+0002e260: 2e20 536f 7272 7921 220a 2020 2020 7761  . Sorry!".    wa
+0002e270: 726e 2822 5468 6973 2066 756e 6374 696f  rn("This functio
+0002e280: 6e20 7375 7070 6f73 6573 2074 6861 7420  n supposes that 
+0002e290: 7468 6520 706f 6c79 7320 6172 6520 6e65  the polys are ne
+0002e2a0: 7374 6564 2066 726f 6d20 696e 6e65 7220  sted from inner 
+0002e2b0: 746f 206f 7574 6572 222c 0a20 2020 2020  to outer",.     
+0002e2c0: 2020 2020 5761 726e 696e 6729 0a20 2020      Warning).   
+0002e2d0: 2023 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d   # =============
+0002e2e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002e2f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002e300: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002e310: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 0a20  =============.. 
+0002e320: 2020 2063 6465 6620 6172 7261 7920 6172     cdef array ar
+0002e330: 655f 636c 6f73 6520 3d20 636c 6f6e 6528  e_close = clone(
+0002e340: 6172 7261 7928 2769 2729 2c20 6e76 706f  array('i'), nvpo
+0002e350: 6c79 2a6e 6c6f 732c 2054 7275 6529 0a20  ly*nlos, True). 
+0002e360: 2020 205f 6474 2e69 735f 636c 6f73 655f     _dt.is_close_
+0002e370: 6c6f 735f 7670 6f6c 795f 7665 635f 636f  los_vpoly_vec_co
+0002e380: 7265 286e 7670 6f6c 792c 206e 6c6f 732c  re(nvpoly, nlos,
+0002e390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002e3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e3b0: 203c 646f 7562 6c65 2a3e 7261 795f 6f72   <double*>ray_or
+0002e3c0: 6967 2e64 6174 612c 0a20 2020 2020 2020  ig.data,.       
+0002e3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e3e0: 2020 2020 2020 2020 203c 646f 7562 6c65           <double
+0002e3f0: 2a3e 7261 795f 7664 6972 2e64 6174 612c  *>ray_vdir.data,
+0002e400: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002e410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e420: 2076 6573 5f70 6f6c 792c 0a20 2020 2020   ves_poly,.     
+0002e430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e440: 2020 2020 2020 2020 2020 2065 7073 5f75             eps_u
+0002e450: 7a2c 2065 7073 5f61 2c0a 2020 2020 2020  z, eps_a,.      
+0002e460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e470: 2020 2020 2020 2020 2020 6570 735f 767a            eps_vz
+0002e480: 2c20 6570 735f 622c 0a20 2020 2020 2020  , eps_b,.       
+0002e490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e4a0: 2020 2020 2020 2020 2065 7073 5f70 6c61           eps_pla
+0002e4b0: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+0002e4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e4d0: 2020 2020 6570 7369 6c6f 6e2c 0a20 2020      epsilon,.   
+0002e4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e4f0: 2020 2020 2020 2020 2020 2020 2061 7265               are
+0002e500: 5f63 6c6f 7365 2c0a 2020 2020 2020 2020  _close,.        
+0002e510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e520: 2020 2020 2020 2020 6e75 6d5f 7468 7265          num_thre
+0002e530: 6164 7329 0a20 2020 2072 6574 7572 6e20  ads).    return 
+0002e540: 6e70 2e61 7361 7272 6179 2861 7265 5f63  np.asarray(are_c
+0002e550: 6c6f 7365 2c20 6474 7970 653d 626f 6f6c  lose, dtype=bool
+0002e560: 292e 7265 7368 6170 6528 6e6c 6f73 2c20  ).reshape(nlos, 
+0002e570: 6e76 706f 6c79 290a 0a23 203d 3d3d 3d3d  nvpoly)..# =====
+0002e580: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
 0002e590: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
 0002e5a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
 0002e5b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002e5c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002e5d0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 0a64  =============..d
-0002e5e0: 6566 2077 6869 6368 5f6c 6f73 5f63 6c6f  ef which_los_clo
-0002e5f0: 7365 725f 7670 6f6c 795f 7665 6328 696e  ser_vpoly_vec(in
-0002e600: 7420 6e76 706f 6c79 2c20 696e 7420 6e6c  t nvpoly, int nl
-0002e610: 6f73 2c0a 2020 2020 2020 2020 2020 2020  os,.            
-0002e620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e630: 2020 206e 702e 6e64 6172 7261 795b 646f     np.ndarray[do
-0002e640: 7562 6c65 2c6e 6469 6d3d 322c 6d6f 6465  uble,ndim=2,mode
-0002e650: 3d27 6327 5d20 7261 795f 6f72 6967 2c0a  ='c'] ray_orig,.
-0002e660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e670: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0002e680: 702e 6e64 6172 7261 795b 646f 7562 6c65  p.ndarray[double
-0002e690: 2c6e 6469 6d3d 322c 6d6f 6465 3d27 6327  ,ndim=2,mode='c'
-0002e6a0: 5d20 7261 795f 7664 6972 2c0a 2020 2020  ] ray_vdir,.    
-0002e6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e6c0: 2020 2020 2020 2020 2020 206e 702e 6e64             np.nd
-0002e6d0: 6172 7261 795b 646f 7562 6c65 2c6e 6469  array[double,ndi
-0002e6e0: 6d3d 332c 6d6f 6465 3d27 6327 5d20 7665  m=3,mode='c'] ve
-0002e6f0: 735f 706f 6c79 2c0a 2020 2020 2020 2020  s_poly,.        
-0002e700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e710: 2020 2020 2020 2064 6f75 626c 6520 6570         double ep
-0002e720: 735f 757a 3d5f 534d 414c 4c2c 2064 6f75  s_uz=_SMALL, dou
-0002e730: 626c 6520 6570 735f 613d 5f56 534d 414c  ble eps_a=_VSMAL
-0002e740: 4c2c 0a20 2020 2020 2020 2020 2020 2020  L,.             
-0002e750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e760: 2020 646f 7562 6c65 2065 7073 5f76 7a3d    double eps_vz=
-0002e770: 5f56 534d 414c 4c2c 2064 6f75 626c 6520  _VSMALL, double 
-0002e780: 6570 735f 623d 5f56 534d 414c 4c2c 0a20  eps_b=_VSMALL,. 
-0002e790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e7a0: 2020 2020 2020 2020 2020 2020 2020 646f                do
-0002e7b0: 7562 6c65 2065 7073 5f70 6c61 6e65 3d5f  uble eps_plane=_
-0002e7c0: 5653 4d41 4c4c 2c20 7374 7220 7665 735f  VSMALL, str ves_
-0002e7d0: 7479 7065 3d27 546f 7227 2c0a 2020 2020  type='Tor',.    
-0002e7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e7f0: 2020 2020 2020 2020 2020 2073 7472 2061             str a
-0002e800: 6c67 6f5f 7479 7065 3d27 7369 6d70 6c65  lgo_type='simple
-0002e810: 272c 2069 6e74 206e 756d 5f74 6872 6561  ', int num_threa
-0002e820: 6473 3d31 3629 3a0a 2020 2020 2222 220a  ds=16):.    """.
-0002e830: 2020 2020 5061 7261 6d73 0a20 2020 203d      Params.    =
-0002e840: 3d3d 3d3d 3d0a 2020 2020 2020 2020 6e76  =====.        nv
-0002e850: 706f 6c79 203a 2069 6e74 0a20 2020 2020  poly : int.     
-0002e860: 2020 2020 2020 4e75 6d62 6572 206f 6620        Number of 
-0002e870: 666c 7578 2073 7572 6661 6365 730a 2020  flux surfaces.  
-0002e880: 2020 2020 2020 6e6c 6f73 203a 2069 6e74        nlos : int
-0002e890: 0a20 2020 2020 2020 2020 2020 4e75 6d62  .           Numb
-0002e8a0: 6572 206f 6620 4c4f 530a 2020 2020 2020  er of LOS.      
-0002e8b0: 2020 7261 795f 6f72 6967 203a 2028 332c    ray_orig : (3,
-0002e8c0: 206e 6c6f 7329 2064 6f75 626c 6520 6172   nlos) double ar
-0002e8d0: 7261 790a 2020 2020 2020 2020 2020 204c  ray.           L
-0002e8e0: 4f53 206f 7269 6769 6e20 706f 696e 7473  OS origin points
-0002e8f0: 2063 6f6f 7264 696e 6174 6573 0a20 2020   coordinates.   
-0002e900: 2020 2020 2072 6179 5f76 6469 7220 3a20       ray_vdir : 
-0002e910: 2833 2c20 6e6c 6f73 2920 646f 7562 6c65  (3, nlos) double
-0002e920: 2061 7272 6179 0a20 2020 2020 2020 2020   array.         
-0002e930: 2020 4c4f 5320 6469 7265 6374 696f 6e20    LOS direction 
-0002e940: 7665 6374 6f72 0a20 2020 2020 2020 2076  vector.        v
-0002e950: 6573 5f70 6f6c 7920 3a20 286e 756d 5f70  es_poly : (num_p
-0002e960: 6f6c 2c20 322c 206e 756d 5f76 6572 7465  ol, 2, num_verte
-0002e970: 7829 2064 6f75 626c 6520 6172 7261 790a  x) double array.
-0002e980: 2020 2020 2020 2020 2020 2043 6f6f 7264             Coord
-0002e990: 696e 6174 6573 206f 6620 7468 6520 7665  inates of the ve
-0002e9a0: 7274 6963 6573 206f 6620 7468 6520 506f  rtices of the Po
-0002e9b0: 6c79 676f 6e20 6465 6669 6e69 6e67 2074  lygon defining t
-0002e9c0: 6865 2032 4420 706f 6c6f 6964 616c 0a20  he 2D poloidal. 
-0002e9d0: 2020 2020 2020 2020 2020 6375 7420 6f66            cut of
-0002e9e0: 2074 6865 2064 6966 6665 7265 6e74 2049   the different I
-0002e9f0: 4e20 7375 7266 6163 6573 0a20 2020 2020  N surfaces.     
-0002ea00: 2020 2020 2020 5741 524e 494e 4720 3a20        WARNING : 
-0002ea10: 7765 2073 7570 706f 7365 2061 6c6c 2070  we suppose all p
-0002ea20: 6f6c 7920 6172 6520 6e65 7374 6564 2069  oly are nested i
-0002ea30: 6e20 6561 6368 206f 7468 6572 2c0a 2020  n each other,.  
-0002ea40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ea50: 2020 2061 6e64 2074 6865 2066 6972 7374     and the first
-0002ea60: 206f 6e65 2069 7320 7468 6520 736d 616c   one is the smal
-0002ea70: 6c65 7374 206f 6e65 0a20 2020 2020 2020  lest one.       
-0002ea80: 2065 7073 5f3c 7661 6c3e 203a 2064 6f75   eps_<val> : dou
-0002ea90: 626c 650a 2020 2020 2020 2020 2020 2053  ble.           S
-0002eaa0: 6d61 6c6c 2076 616c 7565 2c20 6163 6365  mall value, acce
-0002eab0: 7074 616e 6365 206f 6620 6572 726f 720a  ptance of error.
-0002eac0: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
-0002ead0: 3d3d 3d3d 3d3d 3d0a 2020 2020 2020 2020  =======.        
-0002eae0: 696e 645f 636c 6f73 655f 6c6f 7320 3a20  ind_close_los : 
-0002eaf0: 286e 706f 6c79 2920 696e 7420 6172 7261  (npoly) int arra
-0002eb00: 790a 2020 2020 2020 2020 2020 2020 4f66  y.            Of
-0002eb10: 2074 6865 2066 6f72 6d20 5b69 6e64 5f30   the form [ind_0
-0002eb20: 2c20 696e 645f 312c 202e 2e2e 2c20 696e  , ind_1, ..., in
-0002eb30: 645f 286e 706f 6c79 2d31 295d 0a20 2020  d_(npoly-1)].   
-0002eb40: 2020 2020 2020 2020 2077 6865 7265 2069           where i
-0002eb50: 6e64 5f69 2069 7320 7468 6520 636f 6566  nd_i is the coef
-0002eb60: 6669 6369 656e 7420 666f 7220 7468 6520  ficient for the 
-0002eb70: 692d 7468 2066 6c75 7820 7375 7266 6163  i-th flux surfac
-0002eb80: 650a 2020 2020 2020 2020 2020 2020 7375  e.            su
-0002eb90: 6368 2074 6861 7420 7468 6520 696e 645f  ch that the ind_
-0002eba0: 692d 7468 2072 6179 2028 4c4f 5329 2069  i-th ray (LOS) i
-0002ebb0: 7320 636c 6f73 6573 7420 746f 2074 6865  s closest to the
-0002ebc0: 2065 7874 7275 6465 6420 706f 6c79 676f   extruded polygo
-0002ebd0: 6e0a 2020 2020 2020 2020 2020 2020 616d  n.            am
-0002ebe0: 6f6e 6720 616c 6c20 6f74 6865 7220 4c4f  ong all other LO
-0002ebf0: 5320 7769 7468 6f75 7420 676f 696e 6720  S without going 
-0002ec00: 6f76 6572 2069 742e 0a20 2020 202d 2d2d  over it..    ---
-0002ec10: 0a20 2020 2054 6869 7320 6973 2074 6865  .    This is the
-0002ec20: 2050 5954 484f 4e20 6675 6e63 7469 6f6e   PYTHON function
-0002ec30: 2c20 7573 6520 6f6e 6c79 2069 6620 796f  , use only if yo
-0002ec40: 7520 6e65 6564 2074 6869 7320 636f 6d70  u need this comp
-0002ec50: 7574 6174 696f 6e20 6672 6f6d 0a20 2020  utation from.   
-0002ec60: 2050 7974 686f 6e2c 2069 6620 796f 7520   Python, if you 
-0002ec70: 6e65 6564 2069 7420 6672 6f6d 2063 7974  need it from cyt
-0002ec80: 686f 6e2c 2075 7365 2060 7768 6963 685f  hon, use `which_
-0002ec90: 6c6f 735f 636c 6f73 6572 5f76 706f 6c79  los_closer_vpoly
-0002eca0: 5f76 6563 5f63 6f72 6560 0a20 2020 2022  _vec_core`.    "
-0002ecb0: 2222 0a20 2020 2077 6172 6e28 2254 6869  "".    warn("Thi
-0002ecc0: 7320 6675 6e63 7469 6f6e 2073 7570 706f  s function suppo
-0002ecd0: 7365 7320 7468 6174 2074 6865 2070 6f6c  ses that the pol
-0002ece0: 7973 2061 7265 206e 6573 7465 6420 6672  ys are nested fr
-0002ecf0: 6f6d 2069 6e6e 6572 2074 6f20 6f75 7465  om inner to oute
-0002ed00: 7222 2c0a 2020 2020 2020 2020 2057 6172  r",.         War
-0002ed10: 6e69 6e67 290a 0a20 2020 2023 203d 3d3d  ning)..    # ===
-0002ed20: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002ed30: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002ed40: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002ed50: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002ed60: 3d3d 3d3d 3d3d 3d0a 2020 2020 6966 206e  =======.    if n
-0002ed70: 6f74 2061 6c67 6f5f 7479 7065 2e6c 6f77  ot algo_type.low
-0002ed80: 6572 2829 203d 3d20 2273 696d 706c 6522  er() == "simple"
-0002ed90: 206f 7220 6e6f 7420 7665 735f 7479 7065   or not ves_type
-0002eda0: 2e6c 6f77 6572 2829 203d 3d20 2274 6f72  .lower() == "tor
-0002edb0: 223a 0a20 2020 2020 2020 2061 7373 6572  ":.        asser
-0002edc0: 7420 4661 6c73 652c 2022 5468 6520 6675  t False, "The fu
-0002edd0: 6e63 7469 6f6e 2069 7320 6f6e 6c79 2069  nction is only i
-0002ede0: 6d70 6c65 6d65 6e74 6564 2077 6974 6820  mplemented with 
-0002edf0: 7468 6520 7369 6d70 6c65 225c 0a20 2020  the simple"\.   
-0002ee00: 2020 2020 2020 2020 202b 2022 2061 6c67           + " alg
-0002ee10: 6f72 6974 686d 2061 6e64 2066 6f72 2074  orithm and for t
-0002ee20: 6f72 6f69 6461 6c20 7665 7373 656c 732e  oroidal vessels.
-0002ee30: 2e2e 2053 6f72 7279 2122 0a20 2020 2077  .. Sorry!".    w
-0002ee40: 6172 6e28 2254 6869 7320 6675 6e63 7469  arn("This functi
-0002ee50: 6f6e 2073 7570 706f 7365 7320 7468 6174  on supposes that
-0002ee60: 2074 6865 2070 6f6c 7973 2061 7265 206e   the polys are n
-0002ee70: 6573 7465 6420 6672 6f6d 2069 6e6e 6572  ested from inner
-0002ee80: 2074 6f20 6f75 7465 7222 2c0a 2020 2020   to outer",.    
-0002ee90: 2020 2020 2057 6172 6e69 6e67 290a 2020       Warning).  
-0002eea0: 2020 2320 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d    # ============
-0002eeb0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002eec0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002eed0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002eee0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 0a0a  ==============..
-0002eef0: 2020 2020 6364 6566 2061 7272 6179 2069      cdef array i
-0002ef00: 6e64 5f63 6c6f 7365 5f74 6162 203d 2063  nd_close_tab = c
-0002ef10: 6c6f 6e65 2861 7272 6179 2827 6927 292c  lone(array('i'),
-0002ef20: 206e 7670 6f6c 792c 2054 7275 6529 0a20   nvpoly, True). 
-0002ef30: 2020 205f 6474 2e77 6869 6368 5f6c 6f73     _dt.which_los
-0002ef40: 5f63 6c6f 7365 725f 7670 6f6c 795f 7665  _closer_vpoly_ve
-0002ef50: 635f 636f 7265 286e 7670 6f6c 792c 206e  c_core(nvpoly, n
-0002ef60: 6c6f 732c 0a20 2020 2020 2020 2020 2020  los,.           
-0002ef70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ef80: 2020 2020 2020 2020 203c 646f 7562 6c65           <double
-0002ef90: 2a3e 7261 795f 6f72 6967 2e64 6174 612c  *>ray_orig.data,
-0002efa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002efb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002efc0: 2020 2020 203c 646f 7562 6c65 2a3e 7261       <double*>ra
-0002efd0: 795f 7664 6972 2e64 6174 612c 0a20 2020  y_vdir.data,.   
+0002e5c0: 3d3d 3d3d 3d3d 3d3d 3d0a 230a 2320 2020  =========.#.#   
+0002e5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e5e0: 2020 2020 2020 5748 4943 4820 4c4f 532f        WHICH LOS/
+0002e5f0: 5650 4f4c 5920 4953 2043 4c4f 5345 520a  VPOLY IS CLOSER.
+0002e600: 230a 2320 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  #.# ============
+0002e610: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002e620: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002e630: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002e640: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002e650: 3d3d 0a0a 6465 6620 7768 6963 685f 6c6f  ==..def which_lo
+0002e660: 735f 636c 6f73 6572 5f76 706f 6c79 5f76  s_closer_vpoly_v
+0002e670: 6563 2869 6e74 206e 7670 6f6c 792c 2069  ec(int nvpoly, i
+0002e680: 6e74 206e 6c6f 732c 0a20 2020 2020 2020  nt nlos,.       
+0002e690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e6a0: 2020 2020 2020 2020 6e70 2e6e 6461 7272          np.ndarr
+0002e6b0: 6179 5b64 6f75 626c 652c 6e64 696d 3d32  ay[double,ndim=2
+0002e6c0: 2c6d 6f64 653d 2763 275d 2072 6179 5f6f  ,mode='c'] ray_o
+0002e6d0: 7269 672c 0a20 2020 2020 2020 2020 2020  rig,.           
+0002e6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e6f0: 2020 2020 6e70 2e6e 6461 7272 6179 5b64      np.ndarray[d
+0002e700: 6f75 626c 652c 6e64 696d 3d32 2c6d 6f64  ouble,ndim=2,mod
+0002e710: 653d 2763 275d 2072 6179 5f76 6469 722c  e='c'] ray_vdir,
+0002e720: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002e730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e740: 6e70 2e6e 6461 7272 6179 5b64 6f75 626c  np.ndarray[doubl
+0002e750: 652c 6e64 696d 3d33 2c6d 6f64 653d 2763  e,ndim=3,mode='c
+0002e760: 275d 2076 6573 5f70 6f6c 792c 0a20 2020  '] ves_poly,.   
+0002e770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e780: 2020 2020 2020 2020 2020 2020 646f 7562              doub
+0002e790: 6c65 2065 7073 5f75 7a3d 5f53 4d41 4c4c  le eps_uz=_SMALL
+0002e7a0: 2c20 646f 7562 6c65 2065 7073 5f61 3d5f  , double eps_a=_
+0002e7b0: 5653 4d41 4c4c 2c0a 2020 2020 2020 2020  VSMALL,.        
+0002e7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e7d0: 2020 2020 2020 2064 6f75 626c 6520 6570         double ep
+0002e7e0: 735f 767a 3d5f 5653 4d41 4c4c 2c20 646f  s_vz=_VSMALL, do
+0002e7f0: 7562 6c65 2065 7073 5f62 3d5f 5653 4d41  uble eps_b=_VSMA
+0002e800: 4c4c 2c0a 2020 2020 2020 2020 2020 2020  LL,.            
+0002e810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e820: 2020 2064 6f75 626c 6520 6570 735f 706c     double eps_pl
+0002e830: 616e 653d 5f56 534d 414c 4c2c 2073 7472  ane=_VSMALL, str
+0002e840: 2076 6573 5f74 7970 653d 2754 6f72 272c   ves_type='Tor',
+0002e850: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002e860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e870: 7374 7220 616c 676f 5f74 7970 653d 2773  str algo_type='s
+0002e880: 696d 706c 6527 2c20 696e 7420 6e75 6d5f  imple', int num_
+0002e890: 7468 7265 6164 733d 3136 293a 0a20 2020  threads=16):.   
+0002e8a0: 2022 2222 0a20 2020 2050 6172 616d 730a   """.    Params.
+0002e8b0: 2020 2020 3d3d 3d3d 3d3d 0a20 2020 2020      ======.     
+0002e8c0: 2020 206e 7670 6f6c 7920 3a20 696e 740a     nvpoly : int.
+0002e8d0: 2020 2020 2020 2020 2020 204e 756d 6265             Numbe
+0002e8e0: 7220 6f66 2066 6c75 7820 7375 7266 6163  r of flux surfac
+0002e8f0: 6573 0a20 2020 2020 2020 206e 6c6f 7320  es.        nlos 
+0002e900: 3a20 696e 740a 2020 2020 2020 2020 2020  : int.          
+0002e910: 204e 756d 6265 7220 6f66 204c 4f53 0a20   Number of LOS. 
+0002e920: 2020 2020 2020 2072 6179 5f6f 7269 6720         ray_orig 
+0002e930: 3a20 2833 2c20 6e6c 6f73 2920 646f 7562  : (3, nlos) doub
+0002e940: 6c65 2061 7272 6179 0a20 2020 2020 2020  le array.       
+0002e950: 2020 2020 4c4f 5320 6f72 6967 696e 2070      LOS origin p
+0002e960: 6f69 6e74 7320 636f 6f72 6469 6e61 7465  oints coordinate
+0002e970: 730a 2020 2020 2020 2020 7261 795f 7664  s.        ray_vd
+0002e980: 6972 203a 2028 332c 206e 6c6f 7329 2064  ir : (3, nlos) d
+0002e990: 6f75 626c 6520 6172 7261 790a 2020 2020  ouble array.    
+0002e9a0: 2020 2020 2020 204c 4f53 2064 6972 6563         LOS direc
+0002e9b0: 7469 6f6e 2076 6563 746f 720a 2020 2020  tion vector.    
+0002e9c0: 2020 2020 7665 735f 706f 6c79 203a 2028      ves_poly : (
+0002e9d0: 6e75 6d5f 706f 6c2c 2032 2c20 6e75 6d5f  num_pol, 2, num_
+0002e9e0: 7665 7274 6578 2920 646f 7562 6c65 2061  vertex) double a
+0002e9f0: 7272 6179 0a20 2020 2020 2020 2020 2020  rray.           
+0002ea00: 436f 6f72 6469 6e61 7465 7320 6f66 2074  Coordinates of t
+0002ea10: 6865 2076 6572 7469 6365 7320 6f66 2074  he vertices of t
+0002ea20: 6865 2050 6f6c 7967 6f6e 2064 6566 696e  he Polygon defin
+0002ea30: 696e 6720 7468 6520 3244 2070 6f6c 6f69  ing the 2D poloi
+0002ea40: 6461 6c0a 2020 2020 2020 2020 2020 2063  dal.           c
+0002ea50: 7574 206f 6620 7468 6520 6469 6666 6572  ut of the differ
+0002ea60: 656e 7420 494e 2073 7572 6661 6365 730a  ent IN surfaces.
+0002ea70: 2020 2020 2020 2020 2020 2057 4152 4e49             WARNI
+0002ea80: 4e47 203a 2077 6520 7375 7070 6f73 6520  NG : we suppose 
+0002ea90: 616c 6c20 706f 6c79 2061 7265 206e 6573  all poly are nes
+0002eaa0: 7465 6420 696e 2065 6163 6820 6f74 6865  ted in each othe
+0002eab0: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
+0002eac0: 2020 2020 2020 2020 616e 6420 7468 6520          and the 
+0002ead0: 6669 7273 7420 6f6e 6520 6973 2074 6865  first one is the
+0002eae0: 2073 6d61 6c6c 6573 7420 6f6e 650a 2020   smallest one.  
+0002eaf0: 2020 2020 2020 6570 735f 3c76 616c 3e20        eps_<val> 
+0002eb00: 3a20 646f 7562 6c65 0a20 2020 2020 2020  : double.       
+0002eb10: 2020 2020 536d 616c 6c20 7661 6c75 652c      Small value,
+0002eb20: 2061 6363 6570 7461 6e63 6520 6f66 2065   acceptance of e
+0002eb30: 7272 6f72 0a20 2020 2052 6574 7572 6e73  rror.    Returns
+0002eb40: 0a20 2020 203d 3d3d 3d3d 3d3d 0a20 2020  .    =======.   
+0002eb50: 2020 2020 2069 6e64 5f63 6c6f 7365 5f6c       ind_close_l
+0002eb60: 6f73 203a 2028 6e70 6f6c 7929 2069 6e74  os : (npoly) int
+0002eb70: 2061 7272 6179 0a20 2020 2020 2020 2020   array.         
+0002eb80: 2020 204f 6620 7468 6520 666f 726d 205b     Of the form [
+0002eb90: 696e 645f 302c 2069 6e64 5f31 2c20 2e2e  ind_0, ind_1, ..
+0002eba0: 2e2c 2069 6e64 5f28 6e70 6f6c 792d 3129  ., ind_(npoly-1)
+0002ebb0: 5d0a 2020 2020 2020 2020 2020 2020 7768  ].            wh
+0002ebc0: 6572 6520 696e 645f 6920 6973 2074 6865  ere ind_i is the
+0002ebd0: 2063 6f65 6666 6963 6965 6e74 2066 6f72   coefficient for
+0002ebe0: 2074 6865 2069 2d74 6820 666c 7578 2073   the i-th flux s
+0002ebf0: 7572 6661 6365 0a20 2020 2020 2020 2020  urface.         
+0002ec00: 2020 2073 7563 6820 7468 6174 2074 6865     such that the
+0002ec10: 2069 6e64 5f69 2d74 6820 7261 7920 284c   ind_i-th ray (L
+0002ec20: 4f53 2920 6973 2063 6c6f 7365 7374 2074  OS) is closest t
+0002ec30: 6f20 7468 6520 6578 7472 7564 6564 2070  o the extruded p
+0002ec40: 6f6c 7967 6f6e 0a20 2020 2020 2020 2020  olygon.         
+0002ec50: 2020 2061 6d6f 6e67 2061 6c6c 206f 7468     among all oth
+0002ec60: 6572 204c 4f53 2077 6974 686f 7574 2067  er LOS without g
+0002ec70: 6f69 6e67 206f 7665 7220 6974 2e0a 2020  oing over it..  
+0002ec80: 2020 2d2d 2d0a 2020 2020 5468 6973 2069    ---.    This i
+0002ec90: 7320 7468 6520 5059 5448 4f4e 2066 756e  s the PYTHON fun
+0002eca0: 6374 696f 6e2c 2075 7365 206f 6e6c 7920  ction, use only 
+0002ecb0: 6966 2079 6f75 206e 6565 6420 7468 6973  if you need this
+0002ecc0: 2063 6f6d 7075 7461 7469 6f6e 2066 726f   computation fro
+0002ecd0: 6d0a 2020 2020 5079 7468 6f6e 2c20 6966  m.    Python, if
+0002ece0: 2079 6f75 206e 6565 6420 6974 2066 726f   you need it fro
+0002ecf0: 6d20 6379 7468 6f6e 2c20 7573 6520 6077  m cython, use `w
+0002ed00: 6869 6368 5f6c 6f73 5f63 6c6f 7365 725f  hich_los_closer_
+0002ed10: 7670 6f6c 795f 7665 635f 636f 7265 600a  vpoly_vec_core`.
+0002ed20: 2020 2020 2222 220a 2020 2020 7761 726e      """.    warn
+0002ed30: 2822 5468 6973 2066 756e 6374 696f 6e20  ("This function 
+0002ed40: 7375 7070 6f73 6573 2074 6861 7420 7468  supposes that th
+0002ed50: 6520 706f 6c79 7320 6172 6520 6e65 7374  e polys are nest
+0002ed60: 6564 2066 726f 6d20 696e 6e65 7220 746f  ed from inner to
+0002ed70: 206f 7574 6572 222c 0a20 2020 2020 2020   outer",.       
+0002ed80: 2020 5761 726e 696e 6729 0a0a 2020 2020    Warning)..    
+0002ed90: 2320 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  # ==============
+0002eda0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002edb0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002edc0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002edd0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 0a20 2020  ============.   
+0002ede0: 2069 6620 6e6f 7420 616c 676f 5f74 7970   if not algo_typ
+0002edf0: 652e 6c6f 7765 7228 2920 3d3d 2022 7369  e.lower() == "si
+0002ee00: 6d70 6c65 2220 6f72 206e 6f74 2076 6573  mple" or not ves
+0002ee10: 5f74 7970 652e 6c6f 7765 7228 2920 3d3d  _type.lower() ==
+0002ee20: 2022 746f 7222 3a0a 2020 2020 2020 2020   "tor":.        
+0002ee30: 6173 7365 7274 2046 616c 7365 2c20 2254  assert False, "T
+0002ee40: 6865 2066 756e 6374 696f 6e20 6973 206f  he function is o
+0002ee50: 6e6c 7920 696d 706c 656d 656e 7465 6420  nly implemented 
+0002ee60: 7769 7468 2074 6865 2073 696d 706c 6522  with the simple"
+0002ee70: 5c0a 2020 2020 2020 2020 2020 2020 2b20  \.            + 
+0002ee80: 2220 616c 676f 7269 7468 6d20 616e 6420  " algorithm and 
+0002ee90: 666f 7220 746f 726f 6964 616c 2076 6573  for toroidal ves
+0002eea0: 7365 6c73 2e2e 2e20 536f 7272 7921 220a  sels... Sorry!".
+0002eeb0: 2020 2020 7761 726e 2822 5468 6973 2066      warn("This f
+0002eec0: 756e 6374 696f 6e20 7375 7070 6f73 6573  unction supposes
+0002eed0: 2074 6861 7420 7468 6520 706f 6c79 7320   that the polys 
+0002eee0: 6172 6520 6e65 7374 6564 2066 726f 6d20  are nested from 
+0002eef0: 696e 6e65 7220 746f 206f 7574 6572 222c  inner to outer",
+0002ef00: 0a20 2020 2020 2020 2020 5761 726e 696e  .         Warnin
+0002ef10: 6729 0a20 2020 2023 203d 3d3d 3d3d 3d3d  g).    # =======
+0002ef20: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002ef30: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002ef40: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002ef50: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002ef60: 3d3d 3d0a 0a20 2020 2063 6465 6620 6172  ===..    cdef ar
+0002ef70: 7261 7920 696e 645f 636c 6f73 655f 7461  ray ind_close_ta
+0002ef80: 6220 3d20 636c 6f6e 6528 6172 7261 7928  b = clone(array(
+0002ef90: 2769 2729 2c20 6e76 706f 6c79 2c20 5472  'i'), nvpoly, Tr
+0002efa0: 7565 290a 2020 2020 5f64 742e 7768 6963  ue).    _dt.whic
+0002efb0: 685f 6c6f 735f 636c 6f73 6572 5f76 706f  h_los_closer_vpo
+0002efc0: 6c79 5f76 6563 5f63 6f72 6528 6e76 706f  ly_vec_core(nvpo
+0002efd0: 6c79 2c20 6e6c 6f73 2c0a 2020 2020 2020  ly, nlos,.      
 0002efe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002eff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f000: 2076 6573 5f70 6f6c 792c 0a20 2020 2020   ves_poly,.     
-0002f010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f020: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0002f030: 7073 5f75 7a2c 2065 7073 5f61 2c0a 2020  ps_uz, eps_a,.  
-0002f040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f060: 2020 6570 735f 767a 2c20 6570 735f 622c    eps_vz, eps_b,
-0002f070: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002eff0: 2020 2020 2020 2020 2020 2020 2020 3c64                <d
+0002f000: 6f75 626c 652a 3e72 6179 5f6f 7269 672e  ouble*>ray_orig.
+0002f010: 6461 7461 2c0a 2020 2020 2020 2020 2020  data,.          
+0002f020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f030: 2020 2020 2020 2020 2020 3c64 6f75 626c            <doubl
+0002f040: 652a 3e72 6179 5f76 6469 722e 6461 7461  e*>ray_vdir.data
+0002f050: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002f060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f070: 2020 2020 2020 7665 735f 706f 6c79 2c0a        ves_poly,.
 0002f080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f090: 2020 2020 2065 7073 5f70 6c61 6e65 2c0a       eps_plane,.
-0002f0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f0c0: 2020 2020 696e 645f 636c 6f73 655f 7461      ind_close_ta
-0002f0d0: 622c 0a20 2020 2020 2020 2020 2020 2020  b,.             
-0002f0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f0f0: 2020 2020 2020 206e 756d 5f74 6872 6561         num_threa
-0002f100: 6473 290a 2020 2020 7265 7475 726e 206e  ds).    return n
-0002f110: 702e 6173 6172 7261 7928 696e 645f 636c  p.asarray(ind_cl
-0002f120: 6f73 655f 7461 6229 0a0a 0a64 6566 2077  ose_tab)...def w
-0002f130: 6869 6368 5f76 706f 6c79 5f63 6c6f 7365  hich_vpoly_close
-0002f140: 725f 6c6f 735f 7665 6328 696e 7420 6e76  r_los_vec(int nv
-0002f150: 706f 6c79 2c20 696e 7420 6e6c 6f73 2c0a  poly, int nlos,.
-0002f160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f170: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0002f180: 702e 6e64 6172 7261 795b 646f 7562 6c65  p.ndarray[double
-0002f190: 2c6e 6469 6d3d 322c 6d6f 6465 3d27 6327  ,ndim=2,mode='c'
-0002f1a0: 5d20 7261 795f 6f72 6967 2c0a 2020 2020  ] ray_orig,.    
-0002f1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f1c0: 2020 2020 2020 2020 2020 206e 702e 6e64             np.nd
-0002f1d0: 6172 7261 795b 646f 7562 6c65 2c6e 6469  array[double,ndi
-0002f1e0: 6d3d 322c 6d6f 6465 3d27 6327 5d20 7261  m=2,mode='c'] ra
-0002f1f0: 795f 7664 6972 2c0a 2020 2020 2020 2020  y_vdir,.        
-0002f200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f210: 2020 2020 2020 206e 702e 6e64 6172 7261         np.ndarra
-0002f220: 795b 646f 7562 6c65 2c6e 6469 6d3d 332c  y[double,ndim=3,
-0002f230: 6d6f 6465 3d27 6327 5d20 7665 735f 706f  mode='c'] ves_po
-0002f240: 6c79 2c0a 2020 2020 2020 2020 2020 2020  ly,.            
-0002f250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f260: 2020 2064 6f75 626c 6520 6570 735f 757a     double eps_uz
-0002f270: 3d5f 534d 414c 4c2c 2064 6f75 626c 6520  =_SMALL, double 
-0002f280: 6570 735f 613d 5f56 534d 414c 4c2c 0a20  eps_a=_VSMALL,. 
-0002f290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f2a0: 2020 2020 2020 2020 2020 2020 2020 646f                do
-0002f2b0: 7562 6c65 2065 7073 5f76 7a3d 5f56 534d  uble eps_vz=_VSM
-0002f2c0: 414c 4c2c 2064 6f75 626c 6520 6570 735f  ALL, double eps_
-0002f2d0: 623d 5f56 534d 414c 4c2c 0a20 2020 2020  b=_VSMALL,.     
-0002f2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f2f0: 2020 2020 2020 2020 2020 646f 7562 6c65            double
-0002f300: 2065 7073 5f70 6c61 6e65 3d5f 5653 4d41   eps_plane=_VSMA
-0002f310: 4c4c 2c20 7374 7220 7665 735f 7479 7065  LL, str ves_type
-0002f320: 3d27 546f 7227 2c0a 2020 2020 2020 2020  ='Tor',.        
-0002f330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f340: 2020 2020 2020 2073 7472 2061 6c67 6f5f         str algo_
-0002f350: 7479 7065 3d27 7369 6d70 6c65 272c 2069  type='simple', i
-0002f360: 6e74 206e 756d 5f74 6872 6561 6473 3d31  nt num_threads=1
-0002f370: 3629 3a0a 2020 2020 2222 220a 2020 2020  6):.    """.    
-0002f380: 5061 7261 6d73 0a20 2020 203d 3d3d 3d3d  Params.    =====
-0002f390: 3d0a 2020 2020 2020 2020 6e76 706f 6c79  =.        nvpoly
-0002f3a0: 203a 2069 6e74 0a20 2020 2020 2020 2020   : int.         
-0002f3b0: 2020 4e75 6d62 6572 206f 6620 666c 7578    Number of flux
-0002f3c0: 2073 7572 6661 6365 730a 2020 2020 2020   surfaces.      
-0002f3d0: 2020 6e6c 6f73 203a 2069 6e74 0a20 2020    nlos : int.   
-0002f3e0: 2020 2020 2020 2020 4e75 6d62 6572 206f          Number o
-0002f3f0: 6620 4c4f 530a 2020 2020 2020 2020 7261  f LOS.        ra
-0002f400: 795f 6f72 6967 203a 2028 332c 206e 6c6f  y_orig : (3, nlo
-0002f410: 7329 2064 6f75 626c 6520 6172 7261 790a  s) double array.
-0002f420: 2020 2020 2020 2020 2020 204c 4f53 206f             LOS o
-0002f430: 7269 6769 6e20 706f 696e 7473 2063 6f6f  rigin points coo
-0002f440: 7264 696e 6174 6573 0a20 2020 2020 2020  rdinates.       
-0002f450: 2072 6179 5f76 6469 7220 3a20 2833 2c20   ray_vdir : (3, 
-0002f460: 6e6c 6f73 2920 646f 7562 6c65 2061 7272  nlos) double arr
-0002f470: 6179 0a20 2020 2020 2020 2020 2020 4c4f  ay.           LO
-0002f480: 5320 6469 7265 6374 696f 6e20 7665 6374  S direction vect
-0002f490: 6f72 0a20 2020 2020 2020 2076 6573 5f70  or.        ves_p
-0002f4a0: 6f6c 7920 3a20 286e 756d 5f70 6f6c 2c20  oly : (num_pol, 
-0002f4b0: 322c 206e 756d 5f76 6572 7465 7829 2064  2, num_vertex) d
-0002f4c0: 6f75 626c 6520 6172 7261 790a 2020 2020  ouble array.    
-0002f4d0: 2020 2020 2020 2043 6f6f 7264 696e 6174         Coordinat
-0002f4e0: 6573 206f 6620 7468 6520 7665 7274 6963  es of the vertic
-0002f4f0: 6573 206f 6620 7468 6520 506f 6c79 676f  es of the Polygo
-0002f500: 6e20 6465 6669 6e69 6e67 2074 6865 2032  n defining the 2
-0002f510: 4420 706f 6c6f 6964 616c 0a20 2020 2020  D poloidal.     
-0002f520: 2020 2020 2020 6375 7420 6f66 2074 6865        cut of the
-0002f530: 2064 6966 6665 7265 6e74 2049 4e20 7375   different IN su
-0002f540: 7266 6163 6573 0a20 2020 2020 2020 2020  rfaces.         
-0002f550: 2020 5741 524e 494e 4720 3a20 7765 2073    WARNING : we s
-0002f560: 7570 706f 7365 2061 6c6c 2070 6f6c 7920  uppose all poly 
-0002f570: 6172 6520 6e65 7374 6564 2069 6e20 6561  are nested in ea
-0002f580: 6368 206f 7468 6572 2c0a 2020 2020 2020  ch other,.      
-0002f590: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0002f5a0: 6e64 2074 6865 2066 6972 7374 206f 6e65  nd the first one
-0002f5b0: 2069 7320 7468 6520 736d 616c 6c65 7374   is the smallest
-0002f5c0: 206f 6e65 0a20 2020 2020 2020 2065 7073   one.        eps
-0002f5d0: 5f3c 7661 6c3e 203a 2064 6f75 626c 650a  _<val> : double.
-0002f5e0: 2020 2020 2020 2020 2020 2053 6d61 6c6c             Small
-0002f5f0: 2076 616c 7565 2c20 6163 6365 7074 616e   value, acceptan
-0002f600: 6365 206f 6620 6572 726f 720a 2020 2020  ce of error.    
-0002f610: 5265 7475 726e 730a 2020 2020 3d3d 3d3d  Returns.    ====
-0002f620: 3d3d 3d0a 2020 2020 2020 2020 696e 645f  ===.        ind_
-0002f630: 636c 6f73 655f 6c6f 7320 3a20 286e 6c6f  close_los : (nlo
-0002f640: 7329 2069 6e74 2061 7272 6179 0a20 2020  s) int array.   
-0002f650: 2020 2020 2020 2020 204f 6620 7468 6520           Of the 
-0002f660: 666f 726d 205b 696e 645f 302c 2069 6e64  form [ind_0, ind
-0002f670: 5f31 2c20 2e2e 2e2c 2069 6e64 5f28 6e6c  _1, ..., ind_(nl
-0002f680: 6f73 2d31 295d 0a20 2020 2020 2020 2020  os-1)].         
-0002f690: 2020 2077 6865 7265 2069 6e64 5f69 2069     where ind_i i
-0002f6a0: 7320 7468 6520 636f 6566 6669 6369 656e  s the coefficien
-0002f6b0: 7420 666f 7220 7468 6520 692d 7468 204c  t for the i-th L
-0002f6c0: 4f53 2028 7261 7929 0a20 2020 2020 2020  OS (ray).       
-0002f6d0: 2020 2020 2073 7563 6820 7468 6174 2074       such that t
-0002f6e0: 6865 2069 6e64 5f69 2d74 6820 706f 6c79  he ind_i-th poly
-0002f6f0: 2028 666c 7578 2073 7572 6661 6365 2920   (flux surface) 
-0002f700: 6973 2063 6c6f 7365 7374 2074 6f20 7468  is closest to th
-0002f710: 6520 4c4f 530a 2020 2020 2020 2020 2020  e LOS.          
-0002f720: 2020 616d 6f6e 6720 616c 6c20 6f74 6865    among all othe
-0002f730: 7220 706f 6c79 2077 6974 686f 7574 2067  r poly without g
-0002f740: 6f69 6e67 206f 7665 7220 6974 2e0a 2020  oing over it..  
-0002f750: 2020 2d2d 2d0a 2020 2020 5468 6973 2069    ---.    This i
-0002f760: 7320 7468 6520 5059 5448 4f4e 2066 756e  s the PYTHON fun
-0002f770: 6374 696f 6e2c 2075 7365 206f 6e6c 7920  ction, use only 
-0002f780: 6966 2079 6f75 206e 6565 6420 7468 6973  if you need this
-0002f790: 2063 6f6d 7075 7461 7469 6f6e 2066 726f   computation fro
-0002f7a0: 6d0a 2020 2020 5079 7468 6f6e 2c20 6966  m.    Python, if
-0002f7b0: 2079 6f75 206e 6565 6420 6974 2066 726f   you need it fro
-0002f7c0: 6d20 6379 7468 6f6e 2c20 7573 6520 6077  m cython, use `w
-0002f7d0: 6869 6368 5f76 706f 6c79 5f63 6c6f 7365  hich_vpoly_close
-0002f7e0: 725f 6c6f 735f 7665 635f 636f 7265 600a  r_los_vec_core`.
-0002f7f0: 2020 2020 2222 220a 2020 2020 7761 726e      """.    warn
-0002f800: 2822 5468 6973 2066 756e 6374 696f 6e20  ("This function 
-0002f810: 7375 7070 6f73 6573 2074 6861 7420 7468  supposes that th
-0002f820: 6520 706f 6c79 7320 6172 6520 6e65 7374  e polys are nest
-0002f830: 6564 2066 726f 6d20 696e 6e65 7220 746f  ed from inner to
-0002f840: 206f 7574 6572 222c 0a20 2020 2020 2020   outer",.       
-0002f850: 2020 5761 726e 696e 6729 0a20 2020 2023    Warning).    #
-0002f860: 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d   ===============
-0002f870: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002f880: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002f890: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002f8a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 2020 2020  ===========.    
-0002f8b0: 6966 206e 6f74 2061 6c67 6f5f 7479 7065  if not algo_type
-0002f8c0: 2e6c 6f77 6572 2829 203d 3d20 2273 696d  .lower() == "sim
-0002f8d0: 706c 6522 206f 7220 6e6f 7420 7665 735f  ple" or not ves_
-0002f8e0: 7479 7065 2e6c 6f77 6572 2829 203d 3d20  type.lower() == 
-0002f8f0: 2274 6f72 223a 0a20 2020 2020 2020 2061  "tor":.        a
-0002f900: 7373 6572 7420 4661 6c73 652c 2022 5468  ssert False, "Th
-0002f910: 6520 6675 6e63 7469 6f6e 2069 7320 6f6e  e function is on
-0002f920: 6c79 2069 6d70 6c65 6d65 6e74 6564 2077  ly implemented w
-0002f930: 6974 6820 7468 6520 7369 6d70 6c65 225c  ith the simple"\
-0002f940: 0a20 2020 2020 2020 2020 2020 202b 2022  .            + "
-0002f950: 2061 6c67 6f72 6974 686d 2061 6e64 2066   algorithm and f
-0002f960: 6f72 2074 6f72 6f69 6461 6c20 7665 7373  or toroidal vess
-0002f970: 656c 732e 2e2e 2053 6f72 7279 2122 0a20  els... Sorry!". 
-0002f980: 2020 2077 6172 6e28 2254 6869 7320 6675     warn("This fu
-0002f990: 6e63 7469 6f6e 2073 7570 706f 7365 7320  nction supposes 
-0002f9a0: 7468 6174 2074 6865 2070 6f6c 7973 2061  that the polys a
-0002f9b0: 7265 206e 6573 7465 6420 6672 6f6d 2069  re nested from i
-0002f9c0: 6e6e 6572 2074 6f20 6f75 7465 7222 2c0a  nner to outer",.
-0002f9d0: 2020 2020 2020 2020 2057 6172 6e69 6e67           Warning
-0002f9e0: 290a 2020 2020 2320 3d3d 3d3d 3d3d 3d3d  ).    # ========
-0002f9f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002fa00: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002fa10: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002fa20: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0002fa30: 3d3d 0a0a 2020 2020 6364 6566 2061 7272  ==..    cdef arr
-0002fa40: 6179 2069 6e64 5f63 6c6f 7365 5f74 6162  ay ind_close_tab
-0002fa50: 203d 2063 6c6f 6e65 2861 7272 6179 2827   = clone(array('
-0002fa60: 6927 292c 206e 6c6f 732c 2054 7275 6529  i'), nlos, True)
-0002fa70: 0a20 2020 205f 6474 2e77 6869 6368 5f76  .    _dt.which_v
-0002fa80: 706f 6c79 5f63 6c6f 7365 725f 6c6f 735f  poly_closer_los_
-0002fa90: 7665 635f 636f 7265 286e 7670 6f6c 792c  vec_core(nvpoly,
-0002faa0: 206e 6c6f 732c 0a20 2020 2020 2020 2020   nlos,.         
-0002fab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fac0: 2020 2020 2020 2020 2020 203c 646f 7562             <doub
-0002fad0: 6c65 2a3e 7261 795f 6f72 6967 2e64 6174  le*>ray_orig.dat
-0002fae0: 612c 0a20 2020 2020 2020 2020 2020 2020  a,.             
-0002faf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fb00: 2020 2020 2020 203c 646f 7562 6c65 2a3e         <double*>
-0002fb10: 7261 795f 7664 6972 2e64 6174 612c 0a20  ray_vdir.data,. 
+0002f090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f0a0: 2020 2020 6570 735f 757a 2c20 6570 735f      eps_uz, eps_
+0002f0b0: 612c 0a20 2020 2020 2020 2020 2020 2020  a,.             
+0002f0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f0d0: 2020 2020 2020 2065 7073 5f76 7a2c 2065         eps_vz, e
+0002f0e0: 7073 5f62 2c0a 2020 2020 2020 2020 2020  ps_b,.          
+0002f0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f100: 2020 2020 2020 2020 2020 6570 735f 706c            eps_pl
+0002f110: 616e 652c 0a20 2020 2020 2020 2020 2020  ane,.           
+0002f120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f130: 2020 2020 2020 2020 2069 6e64 5f63 6c6f           ind_clo
+0002f140: 7365 5f74 6162 2c0a 2020 2020 2020 2020  se_tab,.        
+0002f150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f160: 2020 2020 2020 2020 2020 2020 6e75 6d5f              num_
+0002f170: 7468 7265 6164 7329 0a20 2020 2072 6574  threads).    ret
+0002f180: 7572 6e20 6e70 2e61 7361 7272 6179 2869  urn np.asarray(i
+0002f190: 6e64 5f63 6c6f 7365 5f74 6162 290a 0a0a  nd_close_tab)...
+0002f1a0: 6465 6620 7768 6963 685f 7670 6f6c 795f  def which_vpoly_
+0002f1b0: 636c 6f73 6572 5f6c 6f73 5f76 6563 2869  closer_los_vec(i
+0002f1c0: 6e74 206e 7670 6f6c 792c 2069 6e74 206e  nt nvpoly, int n
+0002f1d0: 6c6f 732c 0a20 2020 2020 2020 2020 2020  los,.           
+0002f1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f1f0: 2020 2020 6e70 2e6e 6461 7272 6179 5b64      np.ndarray[d
+0002f200: 6f75 626c 652c 6e64 696d 3d32 2c6d 6f64  ouble,ndim=2,mod
+0002f210: 653d 2763 275d 2072 6179 5f6f 7269 672c  e='c'] ray_orig,
+0002f220: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002f230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f240: 6e70 2e6e 6461 7272 6179 5b64 6f75 626c  np.ndarray[doubl
+0002f250: 652c 6e64 696d 3d32 2c6d 6f64 653d 2763  e,ndim=2,mode='c
+0002f260: 275d 2072 6179 5f76 6469 722c 0a20 2020  '] ray_vdir,.   
+0002f270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f280: 2020 2020 2020 2020 2020 2020 6e70 2e6e              np.n
+0002f290: 6461 7272 6179 5b64 6f75 626c 652c 6e64  darray[double,nd
+0002f2a0: 696d 3d33 2c6d 6f64 653d 2763 275d 2076  im=3,mode='c'] v
+0002f2b0: 6573 5f70 6f6c 792c 0a20 2020 2020 2020  es_poly,.       
+0002f2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f2d0: 2020 2020 2020 2020 646f 7562 6c65 2065          double e
+0002f2e0: 7073 5f75 7a3d 5f53 4d41 4c4c 2c20 646f  ps_uz=_SMALL, do
+0002f2f0: 7562 6c65 2065 7073 5f61 3d5f 5653 4d41  uble eps_a=_VSMA
+0002f300: 4c4c 2c0a 2020 2020 2020 2020 2020 2020  LL,.            
+0002f310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f320: 2020 2064 6f75 626c 6520 6570 735f 767a     double eps_vz
+0002f330: 3d5f 5653 4d41 4c4c 2c20 646f 7562 6c65  =_VSMALL, double
+0002f340: 2065 7073 5f62 3d5f 5653 4d41 4c4c 2c0a   eps_b=_VSMALL,.
+0002f350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f360: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0002f370: 6f75 626c 6520 6570 735f 706c 616e 653d  ouble eps_plane=
+0002f380: 5f56 534d 414c 4c2c 2073 7472 2076 6573  _VSMALL, str ves
+0002f390: 5f74 7970 653d 2754 6f72 272c 0a20 2020  _type='Tor',.   
+0002f3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f3b0: 2020 2020 2020 2020 2020 2020 7374 7220              str 
+0002f3c0: 616c 676f 5f74 7970 653d 2773 696d 706c  algo_type='simpl
+0002f3d0: 6527 2c20 696e 7420 6e75 6d5f 7468 7265  e', int num_thre
+0002f3e0: 6164 733d 3136 293a 0a20 2020 2022 2222  ads=16):.    """
+0002f3f0: 0a20 2020 2050 6172 616d 730a 2020 2020  .    Params.    
+0002f400: 3d3d 3d3d 3d3d 0a20 2020 2020 2020 206e  ======.        n
+0002f410: 7670 6f6c 7920 3a20 696e 740a 2020 2020  vpoly : int.    
+0002f420: 2020 2020 2020 204e 756d 6265 7220 6f66         Number of
+0002f430: 2066 6c75 7820 7375 7266 6163 6573 0a20   flux surfaces. 
+0002f440: 2020 2020 2020 206e 6c6f 7320 3a20 696e         nlos : in
+0002f450: 740a 2020 2020 2020 2020 2020 204e 756d  t.           Num
+0002f460: 6265 7220 6f66 204c 4f53 0a20 2020 2020  ber of LOS.     
+0002f470: 2020 2072 6179 5f6f 7269 6720 3a20 2833     ray_orig : (3
+0002f480: 2c20 6e6c 6f73 2920 646f 7562 6c65 2061  , nlos) double a
+0002f490: 7272 6179 0a20 2020 2020 2020 2020 2020  rray.           
+0002f4a0: 4c4f 5320 6f72 6967 696e 2070 6f69 6e74  LOS origin point
+0002f4b0: 7320 636f 6f72 6469 6e61 7465 730a 2020  s coordinates.  
+0002f4c0: 2020 2020 2020 7261 795f 7664 6972 203a        ray_vdir :
+0002f4d0: 2028 332c 206e 6c6f 7329 2064 6f75 626c   (3, nlos) doubl
+0002f4e0: 6520 6172 7261 790a 2020 2020 2020 2020  e array.        
+0002f4f0: 2020 204c 4f53 2064 6972 6563 7469 6f6e     LOS direction
+0002f500: 2076 6563 746f 720a 2020 2020 2020 2020   vector.        
+0002f510: 7665 735f 706f 6c79 203a 2028 6e75 6d5f  ves_poly : (num_
+0002f520: 706f 6c2c 2032 2c20 6e75 6d5f 7665 7274  pol, 2, num_vert
+0002f530: 6578 2920 646f 7562 6c65 2061 7272 6179  ex) double array
+0002f540: 0a20 2020 2020 2020 2020 2020 436f 6f72  .           Coor
+0002f550: 6469 6e61 7465 7320 6f66 2074 6865 2076  dinates of the v
+0002f560: 6572 7469 6365 7320 6f66 2074 6865 2050  ertices of the P
+0002f570: 6f6c 7967 6f6e 2064 6566 696e 696e 6720  olygon defining 
+0002f580: 7468 6520 3244 2070 6f6c 6f69 6461 6c0a  the 2D poloidal.
+0002f590: 2020 2020 2020 2020 2020 2063 7574 206f             cut o
+0002f5a0: 6620 7468 6520 6469 6666 6572 656e 7420  f the different 
+0002f5b0: 494e 2073 7572 6661 6365 730a 2020 2020  IN surfaces.    
+0002f5c0: 2020 2020 2020 2057 4152 4e49 4e47 203a         WARNING :
+0002f5d0: 2077 6520 7375 7070 6f73 6520 616c 6c20   we suppose all 
+0002f5e0: 706f 6c79 2061 7265 206e 6573 7465 6420  poly are nested 
+0002f5f0: 696e 2065 6163 6820 6f74 6865 722c 0a20  in each other,. 
+0002f600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f610: 2020 2020 616e 6420 7468 6520 6669 7273      and the firs
+0002f620: 7420 6f6e 6520 6973 2074 6865 2073 6d61  t one is the sma
+0002f630: 6c6c 6573 7420 6f6e 650a 2020 2020 2020  llest one.      
+0002f640: 2020 6570 735f 3c76 616c 3e20 3a20 646f    eps_<val> : do
+0002f650: 7562 6c65 0a20 2020 2020 2020 2020 2020  uble.           
+0002f660: 536d 616c 6c20 7661 6c75 652c 2061 6363  Small value, acc
+0002f670: 6570 7461 6e63 6520 6f66 2065 7272 6f72  eptance of error
+0002f680: 0a20 2020 2052 6574 7572 6e73 0a20 2020  .    Returns.   
+0002f690: 203d 3d3d 3d3d 3d3d 0a20 2020 2020 2020   =======.       
+0002f6a0: 2069 6e64 5f63 6c6f 7365 5f6c 6f73 203a   ind_close_los :
+0002f6b0: 2028 6e6c 6f73 2920 696e 7420 6172 7261   (nlos) int arra
+0002f6c0: 790a 2020 2020 2020 2020 2020 2020 4f66  y.            Of
+0002f6d0: 2074 6865 2066 6f72 6d20 5b69 6e64 5f30   the form [ind_0
+0002f6e0: 2c20 696e 645f 312c 202e 2e2e 2c20 696e  , ind_1, ..., in
+0002f6f0: 645f 286e 6c6f 732d 3129 5d0a 2020 2020  d_(nlos-1)].    
+0002f700: 2020 2020 2020 2020 7768 6572 6520 696e          where in
+0002f710: 645f 6920 6973 2074 6865 2063 6f65 6666  d_i is the coeff
+0002f720: 6963 6965 6e74 2066 6f72 2074 6865 2069  icient for the i
+0002f730: 2d74 6820 4c4f 5320 2872 6179 290a 2020  -th LOS (ray).  
+0002f740: 2020 2020 2020 2020 2020 7375 6368 2074            such t
+0002f750: 6861 7420 7468 6520 696e 645f 692d 7468  hat the ind_i-th
+0002f760: 2070 6f6c 7920 2866 6c75 7820 7375 7266   poly (flux surf
+0002f770: 6163 6529 2069 7320 636c 6f73 6573 7420  ace) is closest 
+0002f780: 746f 2074 6865 204c 4f53 0a20 2020 2020  to the LOS.     
+0002f790: 2020 2020 2020 2061 6d6f 6e67 2061 6c6c         among all
+0002f7a0: 206f 7468 6572 2070 6f6c 7920 7769 7468   other poly with
+0002f7b0: 6f75 7420 676f 696e 6720 6f76 6572 2069  out going over i
+0002f7c0: 742e 0a20 2020 202d 2d2d 0a20 2020 2054  t..    ---.    T
+0002f7d0: 6869 7320 6973 2074 6865 2050 5954 484f  his is the PYTHO
+0002f7e0: 4e20 6675 6e63 7469 6f6e 2c20 7573 6520  N function, use 
+0002f7f0: 6f6e 6c79 2069 6620 796f 7520 6e65 6564  only if you need
+0002f800: 2074 6869 7320 636f 6d70 7574 6174 696f   this computatio
+0002f810: 6e20 6672 6f6d 0a20 2020 2050 7974 686f  n from.    Pytho
+0002f820: 6e2c 2069 6620 796f 7520 6e65 6564 2069  n, if you need i
+0002f830: 7420 6672 6f6d 2063 7974 686f 6e2c 2075  t from cython, u
+0002f840: 7365 2060 7768 6963 685f 7670 6f6c 795f  se `which_vpoly_
+0002f850: 636c 6f73 6572 5f6c 6f73 5f76 6563 5f63  closer_los_vec_c
+0002f860: 6f72 6560 0a20 2020 2022 2222 0a20 2020  ore`.    """.   
+0002f870: 2077 6172 6e28 2254 6869 7320 6675 6e63   warn("This func
+0002f880: 7469 6f6e 2073 7570 706f 7365 7320 7468  tion supposes th
+0002f890: 6174 2074 6865 2070 6f6c 7973 2061 7265  at the polys are
+0002f8a0: 206e 6573 7465 6420 6672 6f6d 2069 6e6e   nested from inn
+0002f8b0: 6572 2074 6f20 6f75 7465 7222 2c0a 2020  er to outer",.  
+0002f8c0: 2020 2020 2020 2057 6172 6e69 6e67 290a         Warning).
+0002f8d0: 2020 2020 2320 3d3d 3d3d 3d3d 3d3d 3d3d      # ==========
+0002f8e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002f8f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002f900: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002f910: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002f920: 0a20 2020 2069 6620 6e6f 7420 616c 676f  .    if not algo
+0002f930: 5f74 7970 652e 6c6f 7765 7228 2920 3d3d  _type.lower() ==
+0002f940: 2022 7369 6d70 6c65 2220 6f72 206e 6f74   "simple" or not
+0002f950: 2076 6573 5f74 7970 652e 6c6f 7765 7228   ves_type.lower(
+0002f960: 2920 3d3d 2022 746f 7222 3a0a 2020 2020  ) == "tor":.    
+0002f970: 2020 2020 6173 7365 7274 2046 616c 7365      assert False
+0002f980: 2c20 2254 6865 2066 756e 6374 696f 6e20  , "The function 
+0002f990: 6973 206f 6e6c 7920 696d 706c 656d 656e  is only implemen
+0002f9a0: 7465 6420 7769 7468 2074 6865 2073 696d  ted with the sim
+0002f9b0: 706c 6522 5c0a 2020 2020 2020 2020 2020  ple"\.          
+0002f9c0: 2020 2b20 2220 616c 676f 7269 7468 6d20    + " algorithm 
+0002f9d0: 616e 6420 666f 7220 746f 726f 6964 616c  and for toroidal
+0002f9e0: 2076 6573 7365 6c73 2e2e 2e20 536f 7272   vessels... Sorr
+0002f9f0: 7921 220a 2020 2020 7761 726e 2822 5468  y!".    warn("Th
+0002fa00: 6973 2066 756e 6374 696f 6e20 7375 7070  is function supp
+0002fa10: 6f73 6573 2074 6861 7420 7468 6520 706f  oses that the po
+0002fa20: 6c79 7320 6172 6520 6e65 7374 6564 2066  lys are nested f
+0002fa30: 726f 6d20 696e 6e65 7220 746f 206f 7574  rom inner to out
+0002fa40: 6572 222c 0a20 2020 2020 2020 2020 5761  er",.         Wa
+0002fa50: 726e 696e 6729 0a20 2020 2023 203d 3d3d  rning).    # ===
+0002fa60: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002fa70: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002fa80: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002fa90: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0002faa0: 3d3d 3d3d 3d3d 3d0a 0a20 2020 2063 6465  =======..    cde
+0002fab0: 6620 6172 7261 7920 696e 645f 636c 6f73  f array ind_clos
+0002fac0: 655f 7461 6220 3d20 636c 6f6e 6528 6172  e_tab = clone(ar
+0002fad0: 7261 7928 2769 2729 2c20 6e6c 6f73 2c20  ray('i'), nlos, 
+0002fae0: 5472 7565 290a 2020 2020 5f64 742e 7768  True).    _dt.wh
+0002faf0: 6963 685f 7670 6f6c 795f 636c 6f73 6572  ich_vpoly_closer
+0002fb00: 5f6c 6f73 5f76 6563 5f63 6f72 6528 6e76  _los_vec_core(nv
+0002fb10: 706f 6c79 2c20 6e6c 6f73 2c0a 2020 2020  poly, nlos,.    
 0002fb20: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0002fb30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fb40: 2020 2076 6573 5f70 6f6c 792c 0a20 2020     ves_poly,.   
-0002fb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fb40: 3c64 6f75 626c 652a 3e72 6179 5f6f 7269  <double*>ray_ori
+0002fb50: 672e 6461 7461 2c0a 2020 2020 2020 2020  g.data,.        
 0002fb60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fb70: 2065 7073 5f75 7a2c 2065 7073 5f61 2c0a   eps_uz, eps_a,.
-0002fb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fba0: 2020 2020 6570 735f 767a 2c20 6570 735f      eps_vz, eps_
-0002fbb0: 622c 0a20 2020 2020 2020 2020 2020 2020  b,.             
-0002fbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fbd0: 2020 2020 2020 2065 7073 5f70 6c61 6e65         eps_plane
-0002fbe0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002fbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fc00: 2020 2020 2020 696e 645f 636c 6f73 655f        ind_close_
-0002fc10: 7461 622c 0a20 2020 2020 2020 2020 2020  tab,.           
-0002fc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fc30: 2020 2020 2020 2020 206e 756d 5f74 6872           num_thr
-0002fc40: 6561 6473 290a 2020 2020 7265 7475 726e  eads).    return
-0002fc50: 206e 702e 6173 6172 7261 7928 696e 645f   np.asarray(ind_
-0002fc60: 636c 6f73 655f 7461 6229 0a0a 0a0a 6465  close_tab)....de
-0002fc70: 6620 5f56 6573 5f56 6d65 7368 5f54 6f72  f _Ves_Vmesh_Tor
-0002fc80: 5f53 7562 4672 6f6d 445f 6379 7468 6f6e  _SubFromD_cython
-0002fc90: 5f6f 6c64 2864 6f75 626c 6520 6452 2c20  _old(double dR, 
-0002fca0: 646f 7562 6c65 2064 5a2c 2064 6f75 626c  double dZ, doubl
-0002fcb0: 6520 6452 5068 692c 0a20 2020 2020 2020  e dRPhi,.       
-0002fcc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fcd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fce0: 646f 7562 6c65 5b3a 3a31 5d20 524d 696e  double[::1] RMin
-0002fcf0: 4d61 782c 2064 6f75 626c 655b 3a3a 315d  Max, double[::1]
-0002fd00: 205a 4d69 6e4d 6178 2c0a 2020 2020 2020   ZMinMax,.      
-0002fd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fd30: 206c 6973 7420 4452 3d4e 6f6e 652c 0a20   list DR=None,. 
+0002fb70: 2020 2020 2020 2020 2020 2020 3c64 6f75              <dou
+0002fb80: 626c 652a 3e72 6179 5f76 6469 722e 6461  ble*>ray_vdir.da
+0002fb90: 7461 2c0a 2020 2020 2020 2020 2020 2020  ta,.            
+0002fba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fbb0: 2020 2020 2020 2020 7665 735f 706f 6c79          ves_poly
+0002fbc0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002fbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fbe0: 2020 2020 2020 6570 735f 757a 2c20 6570        eps_uz, ep
+0002fbf0: 735f 612c 0a20 2020 2020 2020 2020 2020  s_a,.           
+0002fc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fc10: 2020 2020 2020 2020 2065 7073 5f76 7a2c           eps_vz,
+0002fc20: 2065 7073 5f62 2c0a 2020 2020 2020 2020   eps_b,.        
+0002fc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fc40: 2020 2020 2020 2020 2020 2020 6570 735f              eps_
+0002fc50: 706c 616e 652c 0a20 2020 2020 2020 2020  plane,.         
+0002fc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fc70: 2020 2020 2020 2020 2020 2069 6e64 5f63             ind_c
+0002fc80: 6c6f 7365 5f74 6162 2c0a 2020 2020 2020  lose_tab,.      
+0002fc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fca0: 2020 2020 2020 2020 2020 2020 2020 6e75                nu
+0002fcb0: 6d5f 7468 7265 6164 7329 0a20 2020 2072  m_threads).    r
+0002fcc0: 6574 7572 6e20 6e70 2e61 7361 7272 6179  eturn np.asarray
+0002fcd0: 2869 6e64 5f63 6c6f 7365 5f74 6162 290a  (ind_close_tab).
+0002fce0: 0a0a 0a64 6566 205f 5665 735f 566d 6573  ...def _Ves_Vmes
+0002fcf0: 685f 546f 725f 5375 6246 726f 6d44 5f63  h_Tor_SubFromD_c
+0002fd00: 7974 686f 6e5f 6f6c 6428 646f 7562 6c65  ython_old(double
+0002fd10: 2064 522c 2064 6f75 626c 6520 645a 2c20   dR, double dZ, 
+0002fd20: 646f 7562 6c65 2064 5250 6869 2c0a 2020  double dRPhi,.  
+0002fd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0002fd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fd60: 2020 2020 2020 6c69 7374 2044 5a3d 4e6f        list DZ=No
-0002fd70: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+0002fd50: 2020 2020 2064 6f75 626c 655b 3a3a 315d       double[::1]
+0002fd60: 2052 4d69 6e4d 6178 2c20 646f 7562 6c65   RMinMax, double
+0002fd70: 5b3a 3a31 5d20 5a4d 696e 4d61 782c 0a20  [::1] ZMinMax,. 
 0002fd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fd90: 2020 2020 2020 2020 2020 2044 5068 693d             DPhi=
-0002fda0: 4e6f 6e65 2c20 5650 6f6c 793d 4e6f 6e65  None, VPoly=None
-0002fdb0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002fd90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fda0: 2020 2020 2020 6c69 7374 2044 523d 4e6f        list DR=No
+0002fdb0: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
 0002fdc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fdd0: 2020 2020 2020 2020 2073 7472 204f 7574           str Out
-0002fde0: 3d27 2858 2c59 2c5a 2927 2c20 646f 7562  ='(X,Y,Z)', doub
-0002fdf0: 6c65 206d 6172 6769 6e3d 5f56 534d 414c  le margin=_VSMAL
-0002fe00: 4c29 3a0a 2020 2020 2222 220a 2020 2020  L):.    """.    
-0002fe10: 5265 7475 726e 2074 6865 2064 6573 6972  Return the desir
-0002fe20: 6564 2073 7562 6d65 7368 2069 6e64 6963  ed submesh indic
-0002fe30: 6174 6564 2062 7920 7468 6520 6c69 6d69  ated by the limi
-0002fe40: 7473 2028 4452 2c44 5a2c 4450 6869 292c  ts (DR,DZ,DPhi),
-0002fe50: 0a20 2020 2066 6f72 2074 6865 2064 6573  .    for the des
-0002fe60: 6972 6564 2072 6573 6f6c 7574 696f 6e20  ired resolution 
-0002fe70: 2864 522c 645a 2c64 5270 6869 290a 2020  (dR,dZ,dRphi).  
-0002fe80: 2020 2222 220a 2020 2020 6364 6566 2064    """.    cdef d
-0002fe90: 6f75 626c 655b 3a3a 315d 2052 302c 2052  ouble[::1] R0, R
-0002fea0: 2c20 5a2c 2064 5250 6869 722c 2064 5068  , Z, dRPhir, dPh
-0002feb0: 6972 2c20 4e52 5068 692c 2068 7970 6f74  ir, NRPhi, hypot
-0002fec0: 0a20 2020 2063 6465 6620 646f 7562 6c65  .    cdef double
-0002fed0: 2072 6573 6f5f 7230 2c20 7265 736f 5f72   reso_r0, reso_r
-0002fee0: 2c20 7265 736f 5f7a 2c20 4450 6869 302c  , reso_z, DPhi0,
-0002fef0: 2044 5068 6931 0a20 2020 2063 6465 6620   DPhi1.    cdef 
-0002ff00: 646f 7562 6c65 2061 6273 302c 2061 6273  double abs0, abs
-0002ff10: 312c 2070 6869 2c20 696e 6469 696a 6a0a  1, phi, indiijj.
-0002ff20: 2020 2020 6364 6566 206c 6f6e 675b 3a3a      cdef long[::
-0002ff30: 315d 2069 6e64 5230 2c20 696e 6452 2c20  1] indR0, indR, 
-0002ff40: 696e 645a 2c20 5068 696e 2c20 4e52 5068  indZ, Phin, NRPh
-0002ff50: 6930 0a20 2020 2063 6465 6620 696e 7420  i0.    cdef int 
-0002ff60: 4e52 302c 204e 522c 204e 5a2c 2052 6e2c  NR0, NR, NZ, Rn,
-0002ff70: 205a 6e2c 206e 5250 6869 302c 2069 6e64   Zn, nRPhi0, ind
-0002ff80: 5230 6969 2c20 6969 2c20 6a6a 2c20 6e50  R0ii, ii, jj, nP
-0002ff90: 6869 302c 206e 5068 6931 2c20 7a7a 0a20  hi0, nPhi1, zz. 
-0002ffa0: 2020 2063 6465 6620 696e 7420 4e50 2c20     cdef int NP, 
-0002ffb0: 4e52 5068 695f 696e 742c 2072 6164 6975  NRPhi_int, radiu
-0002ffc0: 735f 7261 7469 6f0a 2020 2020 6364 6566  s_ratio.    cdef
-0002ffd0: 206e 702e 6e64 6172 7261 795b 646f 7562   np.ndarray[doub
-0002ffe0: 6c65 2c6e 6469 6d3d 325d 2050 7473 2c20  le,ndim=2] Pts, 
-0002fff0: 696e 6449 0a20 2020 2063 6465 6620 6e70  indI.    cdef np
-00030000: 2e6e 6461 7272 6179 5b64 6f75 626c 652c  .ndarray[double,
-00030010: 6e64 696d 3d31 5d20 6969 692c 2064 562c  ndim=1] iii, dV,
-00030020: 2069 6e64 0a0a 0a20 2020 2077 6172 6e28   ind...    warn(
-00030030: 2259 6f75 2061 7265 2075 7369 6e67 2074  "You are using t
-00030040: 6865 206f 6c64 2061 6c67 6f72 6974 686d  he old algorithm
-00030050: 2066 6f72 206d 6573 6869 6e67 2061 2076   for meshing a v
-00030060: 6f6c 756d 652e 220a 2020 2020 2020 2020  olume.".        
-00030070: 202b 2022 2054 6869 7320 616c 676f 7269   + " This algori
-00030080: 7468 6d20 6973 2073 6c6f 7765 7220 7468  thm is slower th
-00030090: 616e 2074 6865 206e 6577 206f 6e65 2e22  an the new one."
-000300a0: 2c20 5761 726e 696e 6729 0a0a 2020 2020  , Warning)..    
-000300b0: 2320 4765 7420 7468 6520 6163 7475 616c  # Get the actual
-000300c0: 2052 2061 6e64 205a 2072 6573 6f6c 7574   R and Z resolut
-000300d0: 696f 6e73 2061 6e64 206d 6573 6820 656c  ions and mesh el
-000300e0: 656d 656e 7473 0a20 2020 2052 302c 2072  ements.    R0, r
-000300f0: 6573 6f5f 7230 2c20 696e 6452 302c 204e  eso_r0, indR0, N
-00030100: 5230 203d 2064 6973 6372 6574 697a 655f  R0 = discretize_
-00030110: 6c69 6e65 3164 2852 4d69 6e4d 6178 2c20  line1d(RMinMax, 
-00030120: 6452 2c20 4e6f 6e65 2c0a 2020 2020 2020  dR, None,.      
-00030130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030150: 2020 2020 2020 204c 696d 3d54 7275 652c         Lim=True,
-00030160: 206d 6172 6769 6e3d 6d61 7267 696e 290a   margin=margin).
-00030170: 2020 2020 522c 2072 6573 6f5f 722c 2069      R, reso_r, i
-00030180: 6e64 522c 204e 5220 3d20 6469 7363 7265  ndR, NR = discre
-00030190: 7469 7a65 5f6c 696e 6531 6428 524d 696e  tize_line1d(RMin
-000301a0: 4d61 782c 2064 522c 2044 522c 204c 696d  Max, dR, DR, Lim
-000301b0: 3d54 7275 652c 0a20 2020 2020 2020 2020  =True,.         
-000301c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000301d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000301e0: 206d 6172 6769 6e3d 6d61 7267 696e 290a   margin=margin).
-000301f0: 2020 2020 5a2c 2072 6573 6f5f 7a2c 2069      Z, reso_z, i
-00030200: 6e64 5a2c 204e 5a20 3d20 6469 7363 7265  ndZ, NZ = discre
-00030210: 7469 7a65 5f6c 696e 6531 6428 5a4d 696e  tize_line1d(ZMin
-00030220: 4d61 782c 2064 5a2c 2044 5a2c 204c 696d  Max, dZ, DZ, Lim
-00030230: 3d54 7275 652c 0a20 2020 2020 2020 2020  =True,.         
+0002fdd0: 2020 2020 2020 2020 2020 206c 6973 7420             list 
+0002fde0: 445a 3d4e 6f6e 652c 0a20 2020 2020 2020  DZ=None,.       
+0002fdf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fe00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fe10: 4450 6869 3d4e 6f6e 652c 2056 506f 6c79  DPhi=None, VPoly
+0002fe20: 3d4e 6f6e 652c 0a20 2020 2020 2020 2020  =None,.         
+0002fe30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fe40: 2020 2020 2020 2020 2020 2020 2020 7374                st
+0002fe50: 7220 4f75 743d 2728 582c 592c 5a29 272c  r Out='(X,Y,Z)',
+0002fe60: 2064 6f75 626c 6520 6d61 7267 696e 3d5f   double margin=_
+0002fe70: 5653 4d41 4c4c 293a 0a20 2020 2022 2222  VSMALL):.    """
+0002fe80: 0a20 2020 2052 6574 7572 6e20 7468 6520  .    Return the 
+0002fe90: 6465 7369 7265 6420 7375 626d 6573 6820  desired submesh 
+0002fea0: 696e 6469 6361 7465 6420 6279 2074 6865  indicated by the
+0002feb0: 206c 696d 6974 7320 2844 522c 445a 2c44   limits (DR,DZ,D
+0002fec0: 5068 6929 2c0a 2020 2020 666f 7220 7468  Phi),.    for th
+0002fed0: 6520 6465 7369 7265 6420 7265 736f 6c75  e desired resolu
+0002fee0: 7469 6f6e 2028 6452 2c64 5a2c 6452 7068  tion (dR,dZ,dRph
+0002fef0: 6929 0a20 2020 2022 2222 0a20 2020 2063  i).    """.    c
+0002ff00: 6465 6620 646f 7562 6c65 5b3a 3a31 5d20  def double[::1] 
+0002ff10: 5230 2c20 522c 205a 2c20 6452 5068 6972  R0, R, Z, dRPhir
+0002ff20: 2c20 6450 6869 722c 204e 5250 6869 2c20  , dPhir, NRPhi, 
+0002ff30: 6879 706f 740a 2020 2020 6364 6566 2064  hypot.    cdef d
+0002ff40: 6f75 626c 6520 7265 736f 5f72 302c 2072  ouble reso_r0, r
+0002ff50: 6573 6f5f 722c 2072 6573 6f5f 7a2c 2044  eso_r, reso_z, D
+0002ff60: 5068 6930 2c20 4450 6869 310a 2020 2020  Phi0, DPhi1.    
+0002ff70: 6364 6566 2064 6f75 626c 6520 6162 7330  cdef double abs0
+0002ff80: 2c20 6162 7331 2c20 7068 692c 2069 6e64  , abs1, phi, ind
+0002ff90: 6969 6a6a 0a20 2020 2063 6465 6620 6c6f  iijj.    cdef lo
+0002ffa0: 6e67 5b3a 3a31 5d20 696e 6452 302c 2069  ng[::1] indR0, i
+0002ffb0: 6e64 522c 2069 6e64 5a2c 2050 6869 6e2c  ndR, indZ, Phin,
+0002ffc0: 204e 5250 6869 300a 2020 2020 6364 6566   NRPhi0.    cdef
+0002ffd0: 2069 6e74 204e 5230 2c20 4e52 2c20 4e5a   int NR0, NR, NZ
+0002ffe0: 2c20 526e 2c20 5a6e 2c20 6e52 5068 6930  , Rn, Zn, nRPhi0
+0002fff0: 2c20 696e 6452 3069 692c 2069 692c 206a  , indR0ii, ii, j
+00030000: 6a2c 206e 5068 6930 2c20 6e50 6869 312c  j, nPhi0, nPhi1,
+00030010: 207a 7a0a 2020 2020 6364 6566 2069 6e74   zz.    cdef int
+00030020: 204e 502c 204e 5250 6869 5f69 6e74 2c20   NP, NRPhi_int, 
+00030030: 7261 6469 7573 5f72 6174 696f 0a20 2020  radius_ratio.   
+00030040: 2063 6465 6620 6e70 2e6e 6461 7272 6179   cdef np.ndarray
+00030050: 5b64 6f75 626c 652c 6e64 696d 3d32 5d20  [double,ndim=2] 
+00030060: 5074 732c 2069 6e64 490a 2020 2020 6364  Pts, indI.    cd
+00030070: 6566 206e 702e 6e64 6172 7261 795b 646f  ef np.ndarray[do
+00030080: 7562 6c65 2c6e 6469 6d3d 315d 2069 6969  uble,ndim=1] iii
+00030090: 2c20 6456 2c20 696e 640a 0a0a 2020 2020  , dV, ind...    
+000300a0: 7761 726e 2822 596f 7520 6172 6520 7573  warn("You are us
+000300b0: 696e 6720 7468 6520 6f6c 6420 616c 676f  ing the old algo
+000300c0: 7269 7468 6d20 666f 7220 6d65 7368 696e  rithm for meshin
+000300d0: 6720 6120 766f 6c75 6d65 2e22 0a20 2020  g a volume.".   
+000300e0: 2020 2020 2020 2b20 2220 5468 6973 2061        + " This a
+000300f0: 6c67 6f72 6974 686d 2069 7320 736c 6f77  lgorithm is slow
+00030100: 6572 2074 6861 6e20 7468 6520 6e65 7720  er than the new 
+00030110: 6f6e 652e 222c 2057 6172 6e69 6e67 290a  one.", Warning).
+00030120: 0a20 2020 2023 2047 6574 2074 6865 2061  .    # Get the a
+00030130: 6374 7561 6c20 5220 616e 6420 5a20 7265  ctual R and Z re
+00030140: 736f 6c75 7469 6f6e 7320 616e 6420 6d65  solutions and me
+00030150: 7368 2065 6c65 6d65 6e74 730a 2020 2020  sh elements.    
+00030160: 5230 2c20 7265 736f 5f72 302c 2069 6e64  R0, reso_r0, ind
+00030170: 5230 2c20 4e52 3020 3d20 6469 7363 7265  R0, NR0 = discre
+00030180: 7469 7a65 5f6c 696e 6531 6428 524d 696e  tize_line1d(RMin
+00030190: 4d61 782c 2064 522c 204e 6f6e 652c 0a20  Max, dR, None,. 
+000301a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000301b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000301c0: 2020 2020 2020 2020 2020 2020 4c69 6d3d              Lim=
+000301d0: 5472 7565 2c20 6d61 7267 696e 3d6d 6172  True, margin=mar
+000301e0: 6769 6e29 0a20 2020 2052 2c20 7265 736f  gin).    R, reso
+000301f0: 5f72 2c20 696e 6452 2c20 4e52 203d 2064  _r, indR, NR = d
+00030200: 6973 6372 6574 697a 655f 6c69 6e65 3164  iscretize_line1d
+00030210: 2852 4d69 6e4d 6178 2c20 6452 2c20 4452  (RMinMax, dR, DR
+00030220: 2c20 4c69 6d3d 5472 7565 2c0a 2020 2020  , Lim=True,.    
+00030230: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00030240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030260: 206d 6172 6769 6e3d 6d61 7267 696e 290a   margin=margin).
-00030270: 2020 2020 526e 203d 206c 656e 2852 290a      Rn = len(R).
-00030280: 2020 2020 5a6e 203d 206c 656e 285a 290a      Zn = len(Z).
-00030290: 2020 2020 2320 4765 7420 7468 6520 6c69      # Get the li
-000302a0: 6d69 7473 2069 6620 616e 7920 2861 6e64  mits if any (and
-000302b0: 206d 616b 6520 7375 7265 2074 6f20 7265   make sure to re
-000302c0: 706c 6163 6520 7468 656d 2069 6e20 7468  place them in th
-000302d0: 6520 7072 6f70 6572 0a20 2020 2023 2071  e proper.    # q
-000302e0: 7561 6472 616e 7473 290a 2020 2020 6966  uadrants).    if
-000302f0: 2044 5068 6920 6973 204e 6f6e 653a 0a20   DPhi is None:. 
-00030300: 2020 2020 2020 2044 5068 6930 2c20 4450         DPhi0, DP
-00030310: 6869 3120 3d20 2d63 5f70 692c 2063 5f70  hi1 = -c_pi, c_p
-00030320: 690a 2020 2020 656c 7365 3a0a 2020 2020  i.    else:.    
-00030330: 2020 2020 4450 6869 3020 3d20 635f 6174      DPhi0 = c_at
-00030340: 616e 3228 635f 7369 6e28 4450 6869 5b30  an2(c_sin(DPhi[0
-00030350: 5d29 2c20 635f 636f 7328 4450 6869 5b30  ]), c_cos(DPhi[0
-00030360: 5d29 290a 2020 2020 2020 2020 4450 6869  ])).        DPhi
-00030370: 3120 3d20 635f 6174 616e 3228 635f 7369  1 = c_atan2(c_si
-00030380: 6e28 4450 6869 5b31 5d29 2c20 635f 636f  n(DPhi[1]), c_co
-00030390: 7328 4450 6869 5b31 5d29 290a 2020 2020  s(DPhi[1])).    
-000303a0: 6452 5068 6972 2c20 6450 6869 7220 3d20  dRPhir, dPhir = 
-000303b0: 6e70 2e65 6d70 7479 2828 526e 2c29 292c  np.empty((Rn,)),
-000303c0: 206e 702e 656d 7074 7928 2852 6e2c 2929   np.empty((Rn,))
-000303d0: 0a20 2020 2050 6869 6e20 3d20 6e70 2e65  .    Phin = np.e
-000303e0: 6d70 7479 2828 526e 2c29 2c64 7479 7065  mpty((Rn,),dtype
-000303f0: 3d69 6e74 290a 2020 2020 4e52 5068 6920  =int).    NRPhi 
-00030400: 3d20 6e70 2e65 6d70 7479 2828 526e 2c29  = np.empty((Rn,)
-00030410: 290a 2020 2020 4e52 5068 6930 203d 206e  ).    NRPhi0 = n
-00030420: 702e 7a65 726f 7328 2852 6e2c 292c 6474  p.zeros((Rn,),dt
-00030430: 7970 653d 696e 7429 0a20 2020 206e 5250  ype=int).    nRP
-00030440: 6869 302c 2069 6e64 5230 6969 203d 2030  hi0, indR0ii = 0
-00030450: 2c20 300a 2020 2020 4e50 2c20 4e50 6869  , 0.    NP, NPhi
-00030460: 6d61 7820 3d20 302c 2030 0a20 2020 2072  max = 0, 0.    r
-00030470: 6164 6975 735f 7261 7469 6f20 3d20 696e  adius_ratio = in
-00030480: 7428 635f 6365 696c 2852 5b52 6e2d 315d  t(c_ceil(R[Rn-1]
-00030490: 2f52 5b30 5d29 290a 2020 2020 666f 7220  /R[0])).    for 
-000304a0: 6969 2069 6e20 7261 6e67 6528 302c 526e  ii in range(0,Rn
-000304b0: 293a 0a20 2020 2020 2020 2023 2047 6574  ):.        # Get
-000304c0: 2074 6865 2061 6374 7561 6c20 5250 6869   the actual RPhi
-000304d0: 2072 6573 6f6c 7574 696f 6e20 616e 6420   resolution and 
-000304e0: 5068 6920 6d65 7368 2065 6c65 6d65 6e74  Phi mesh element
-000304f0: 7320 2821 2064 6570 656e 6473 206f 6e20  s (! depends on 
-00030500: 5221 290a 2020 2020 2020 2020 4e52 5068  R!).        NRPh
-00030510: 695b 6969 5d20 3d20 635f 6365 696c 2832  i[ii] = c_ceil(2
-00030520: 2e2a 635f 7069 2a52 5b69 695d 2f64 5250  .*c_pi*R[ii]/dRP
-00030530: 6869 290a 2020 2020 2020 2020 4e52 5068  hi).        NRPh
-00030540: 695f 696e 7420 3d20 696e 7428 4e52 5068  i_int = int(NRPh
-00030550: 695b 6969 5d29 0a20 2020 2020 2020 2064  i[ii]).        d
-00030560: 5068 6972 5b69 695d 203d 2032 2e2a 635f  Phir[ii] = 2.*c_
-00030570: 7069 2f4e 5250 6869 5b69 695d 0a20 2020  pi/NRPhi[ii].   
-00030580: 2020 2020 2064 5250 6869 725b 6969 5d20       dRPhir[ii] 
-00030590: 3d20 6450 6869 725b 6969 5d2a 525b 6969  = dPhir[ii]*R[ii
-000305a0: 5d0a 2020 2020 2020 2020 2320 4765 7420  ].        # Get 
-000305b0: 696e 6465 7820 616e 6420 6375 6d75 6c61  index and cumula
-000305c0: 7465 6420 696e 6469 6365 7320 6672 6f6d  ted indices from
-000305d0: 2062 6163 6b67 726f 756e 640a 2020 2020   background.    
-000305e0: 2020 2020 666f 7220 6a6a 2069 6e20 7261      for jj in ra
-000305f0: 6e67 6528 696e 6452 3069 692c 4e52 3029  nge(indR0ii,NR0)
-00030600: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00030610: 2052 305b 6a6a 5d3d 3d52 5b69 695d 3a0a   R0[jj]==R[ii]:.
-00030620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030630: 696e 6452 3069 6920 3d20 6a6a 0a20 2020  indR0ii = jj.   
-00030640: 2020 2020 2020 2020 2020 2020 2062 7265               bre
-00030650: 616b 0a20 2020 2020 2020 2020 2020 2065  ak.            e
-00030660: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00030670: 2020 2020 206e 5250 6869 3020 2b3d 203c       nRPhi0 += <
-00030680: 6c6f 6e67 3e63 5f63 6569 6c28 322e 2a63  long>c_ceil(2.*c
-00030690: 5f70 692a 5230 5b6a 6a5d 2f64 5250 6869  _pi*R0[jj]/dRPhi
-000306a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000306b0: 2020 4e52 5068 6930 5b69 695d 203d 206e    NRPhi0[ii] = n
-000306c0: 5250 6869 302a 4e5a 0a20 2020 2020 2020  RPhi0*NZ.       
-000306d0: 2023 2047 6574 2069 6e64 6963 6573 206f   # Get indices o
-000306e0: 6620 7068 690a 2020 2020 2020 2020 2320  f phi.        # 
-000306f0: 4765 7420 7468 6520 6578 7472 656d 6520  Get the extreme 
-00030700: 696e 6469 6365 7320 6f66 2074 6865 206d  indices of the m
-00030710: 6573 6820 656c 656d 656e 7473 2074 6861  esh elements tha
-00030720: 7420 7265 616c 6c79 206e 6565 6420 746f  t really need to
-00030730: 0a20 2020 2020 2020 2023 2062 6520 6372  .        # be cr
-00030740: 6561 7465 6420 7769 7468 696e 2074 686f  eated within tho
-00030750: 7365 206c 696d 6974 730a 2020 2020 2020  se limits.      
-00030760: 2020 6162 7330 203d 2063 5f61 6273 2844    abs0 = c_abs(D
-00030770: 5068 6930 2b63 5f70 6929 0a20 2020 2020  Phi0+c_pi).     
-00030780: 2020 2069 6620 6162 7330 2d64 5068 6972     if abs0-dPhir
-00030790: 5b69 695d 2a63 5f66 6c6f 6f72 2861 6273  [ii]*c_floor(abs
-000307a0: 302f 6450 6869 725b 6969 5d29 203c 206d  0/dPhir[ii]) < m
-000307b0: 6172 6769 6e2a 6450 6869 725b 6969 5d3a  argin*dPhir[ii]:
-000307c0: 0a20 2020 2020 2020 2020 2020 206e 5068  .            nPh
-000307d0: 6930 203d 2069 6e74 2863 5f72 6f75 6e64  i0 = int(c_round
-000307e0: 2828 4450 6869 302b 635f 7069 292f 6450  ((DPhi0+c_pi)/dP
-000307f0: 6869 725b 6969 5d29 290a 2020 2020 2020  hir[ii])).      
-00030800: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00030810: 2020 2020 6e50 6869 3020 3d20 696e 7428      nPhi0 = int(
-00030820: 635f 666c 6f6f 7228 2844 5068 6930 2b63  c_floor((DPhi0+c
-00030830: 5f70 6929 2f64 5068 6972 5b69 695d 2929  _pi)/dPhir[ii]))
-00030840: 0a20 2020 2020 2020 2061 6273 3120 3d20  .        abs1 = 
-00030850: 635f 6162 7328 4450 6869 312b 635f 7069  c_abs(DPhi1+c_pi
-00030860: 290a 2020 2020 2020 2020 6966 2061 6273  ).        if abs
-00030870: 312d 6450 6869 725b 6969 5d2a 635f 666c  1-dPhir[ii]*c_fl
-00030880: 6f6f 7228 6162 7331 2f64 5068 6972 5b69  oor(abs1/dPhir[i
-00030890: 695d 2920 3c20 6d61 7267 696e 2a64 5068  i]) < margin*dPh
-000308a0: 6972 5b69 695d 3a0a 2020 2020 2020 2020  ir[ii]:.        
-000308b0: 2020 2020 6e50 6869 3120 3d20 696e 7428      nPhi1 = int(
-000308c0: 635f 726f 756e 6428 2844 5068 6931 2b63  c_round((DPhi1+c
-000308d0: 5f70 6929 2f64 5068 6972 5b69 695d 292d  _pi)/dPhir[ii])-
-000308e0: 3129 0a20 2020 2020 2020 2065 6c73 653a  1).        else:
-000308f0: 0a20 2020 2020 2020 2020 2020 206e 5068  .            nPh
-00030900: 6931 203d 2069 6e74 2863 5f66 6c6f 6f72  i1 = int(c_floor
-00030910: 2828 4450 6869 312b 635f 7069 292f 6450  ((DPhi1+c_pi)/dP
-00030920: 6869 725b 6969 5d29 290a 0a20 2020 2020  hir[ii]))..     
-00030930: 2020 2069 6620 4450 6869 303c 4450 6869     if DPhi0<DPhi
-00030940: 313a 0a20 2020 2020 2020 2020 2020 2023  1:.            #
-00030950: 696e 6449 2e61 7070 656e 6428 6c69 7374  indI.append(list
-00030960: 2872 616e 6765 286e 5068 6930 2c6e 5068  (range(nPhi0,nPh
-00030970: 6931 2b31 2929 290a 2020 2020 2020 2020  i1+1))).        
-00030980: 2020 2020 5068 696e 5b69 695d 203d 206e      Phin[ii] = n
-00030990: 5068 6931 2b31 2d6e 5068 6930 0a20 2020  Phi1+1-nPhi0.   
-000309a0: 2020 2020 2020 2020 2069 6620 6969 3d3d           if ii==
-000309b0: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
-000309c0: 2020 2069 6e64 4920 3d20 6e70 2e6e 616e     indI = np.nan
-000309d0: 2a6e 702e 6f6e 6573 2828 526e 2c50 6869  *np.ones((Rn,Phi
-000309e0: 6e5b 6969 5d2a 7261 6469 7573 5f72 6174  n[ii]*radius_rat
-000309f0: 696f 2b31 2929 0a20 2020 2020 2020 2020  io+1)).         
-00030a00: 2020 2066 6f72 206a 6a20 696e 2072 616e     for jj in ran
-00030a10: 6765 2830 2c50 6869 6e5b 6969 5d29 3a0a  ge(0,Phin[ii]):.
-00030a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030a30: 696e 6449 5b69 692c 6a6a 5d20 3d20 3c64  indI[ii,jj] = <d
-00030a40: 6f75 626c 653e 2820 6e50 6869 302b 6a6a  ouble>( nPhi0+jj
-00030a50: 2029 0a20 2020 2020 2020 2065 6c73 653a   ).        else:
-00030a60: 0a20 2020 2020 2020 2020 2020 2023 696e  .            #in
-00030a70: 6449 2e61 7070 656e 6428 6c69 7374 2872  dI.append(list(r
-00030a80: 616e 6765 286e 5068 6930 2c4e 5250 6869  ange(nPhi0,NRPhi
-00030a90: 5f69 6e74 292b 6c69 7374 2872 616e 6765  _int)+list(range
-00030aa0: 2830 2c6e 5068 6931 2b31 2929 2929 0a20  (0,nPhi1+1)))). 
-00030ab0: 2020 2020 2020 2020 2020 2050 6869 6e5b             Phin[
-00030ac0: 6969 5d20 3d20 6e50 6869 312b 312b 4e52  ii] = nPhi1+1+NR
-00030ad0: 5068 695f 696e 742d 6e50 6869 300a 2020  Phi_int-nPhi0.  
-00030ae0: 2020 2020 2020 2020 2020 6966 2069 693d            if ii=
-00030af0: 3d30 3a0a 2020 2020 2020 2020 2020 2020  =0:.            
-00030b00: 2020 2020 696e 6449 203d 206e 702e 6e61      indI = np.na
-00030b10: 6e2a 6e70 2e6f 6e65 7328 2852 6e2c 5068  n*np.ones((Rn,Ph
-00030b20: 696e 5b69 695d 2a72 6164 6975 735f 7261  in[ii]*radius_ra
-00030b30: 7469 6f2b 3129 290a 2020 2020 2020 2020  tio+1)).        
-00030b40: 2020 2020 666f 7220 6a6a 2069 6e20 7261      for jj in ra
-00030b50: 6e67 6528 302c 4e52 5068 695f 696e 742d  nge(0,NRPhi_int-
-00030b60: 6e50 6869 3029 3a0a 2020 2020 2020 2020  nPhi0):.        
-00030b70: 2020 2020 2020 2020 696e 6449 5b69 692c          indI[ii,
-00030b80: 6a6a 5d20 3d20 3c64 6f75 626c 653e 2820  jj] = <double>( 
-00030b90: 6e50 6869 302b 6a6a 2029 0a20 2020 2020  nPhi0+jj ).     
-00030ba0: 2020 2020 2020 2066 6f72 206a 6a20 696e         for jj in
-00030bb0: 2072 616e 6765 284e 5250 6869 5f69 6e74   range(NRPhi_int
-00030bc0: 2d6e 5068 6930 2c50 6869 6e5b 6969 5d29  -nPhi0,Phin[ii])
-00030bd0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00030be0: 2020 696e 6449 5b69 692c 6a6a 5d20 3d20    indI[ii,jj] = 
-00030bf0: 3c64 6f75 626c 653e 2820 6a6a 2d20 284e  <double>( jj- (N
-00030c00: 5250 6869 5f69 6e74 2d6e 5068 6930 2920  RPhi_int-nPhi0) 
-00030c10: 290a 2020 2020 2020 2020 4e50 202b 3d20  ).        NP += 
-00030c20: 5a6e 2a50 6869 6e5b 6969 5d0a 2020 2020  Zn*Phin[ii].    
-00030c30: 5074 7320 3d20 6e70 2e65 6d70 7479 2828  Pts = np.empty((
-00030c40: 332c 4e50 2929 0a20 2020 2069 6e64 203d  3,NP)).    ind =
-00030c50: 206e 702e 656d 7074 7928 284e 502c 2929   np.empty((NP,))
-00030c60: 0a20 2020 2064 5620 3d20 6e70 2e65 6d70  .    dV = np.emp
-00030c70: 7479 2828 4e50 2c29 290a 2020 2020 2320  ty((NP,)).    # 
-00030c80: 436f 6d70 7574 6520 5074 732c 2064 5620  Compute Pts, dV 
-00030c90: 616e 6420 696e 640a 2020 2020 2320 5468  and ind.    # Th
-00030ca0: 6973 2074 7269 706c 6520 6c6f 6f70 2069  is triple loop i
-00030cb0: 7320 7468 6520 6c6f 6e67 6573 7420 7061  s the longest pa
-00030cc0: 7274 2c20 6974 2074 616b 6573 207e 3930  rt, it takes ~90
-00030cd0: 2520 6f66 2074 6865 2043 5055 2074 696d  % of the CPU tim
-00030ce0: 650a 2020 2020 4e50 203d 2030 0a20 2020  e.    NP = 0.   
-00030cf0: 2069 6620 4f75 742e 6c6f 7765 7228 293d   if Out.lower()=
-00030d00: 3d27 2878 2c79 2c7a 2927 3a0a 2020 2020  ='(x,y,z)':.    
-00030d10: 2020 2020 666f 7220 6969 2069 6e20 7261      for ii in ra
-00030d20: 6e67 6528 302c 526e 293a 0a20 2020 2020  nge(0,Rn):.     
-00030d30: 2020 2020 2020 2023 2054 6f20 6d61 6b65         # To make
-00030d40: 2073 7572 6520 7468 6520 696e 6469 6365   sure the indice
-00030d50: 7320 6172 6520 696e 2069 6e63 7265 6173  s are in increas
-00030d60: 696e 6720 6f72 6465 720a 2020 2020 2020  ing order.      
-00030d70: 2020 2020 2020 6969 6920 3d20 6e70 2e73        iii = np.s
-00030d80: 6f72 7428 696e 6449 5b69 692c 7e6e 702e  ort(indI[ii,~np.
-00030d90: 6973 6e61 6e28 696e 6449 5b69 692c 3a5d  isnan(indI[ii,:]
-00030da0: 295d 290a 2020 2020 2020 2020 2020 2020  )]).            
-00030db0: 666f 7220 7a7a 2069 6e20 7261 6e67 6528  for zz in range(
-00030dc0: 302c 5a6e 293a 0a20 2020 2020 2020 2020  0,Zn):.         
-00030dd0: 2020 2020 2020 2066 6f72 206a 6a20 696e         for jj in
-00030de0: 2072 616e 6765 2830 2c50 6869 6e5b 6969   range(0,Phin[ii
-00030df0: 5d29 3a0a 2020 2020 2020 2020 2020 2020  ]):.            
-00030e00: 2020 2020 2020 2020 696e 6469 696a 6a20          indiijj 
-00030e10: 3d20 6969 695b 6a6a 5d0a 2020 2020 2020  = iii[jj].      
-00030e20: 2020 2020 2020 2020 2020 2020 2020 7068                ph
-00030e30: 6920 3d20 2d63 5f70 6920 2b20 2830 2e35  i = -c_pi + (0.5
-00030e40: 2b69 6e64 6969 6a6a 292a 6450 6869 725b  +indiijj)*dPhir[
-00030e50: 6969 5d0a 2020 2020 2020 2020 2020 2020  ii].            
-00030e60: 2020 2020 2020 2020 5074 735b 302c 4e50          Pts[0,NP
-00030e70: 5d20 3d20 525b 6969 5d2a 635f 636f 7328  ] = R[ii]*c_cos(
-00030e80: 7068 6929 0a20 2020 2020 2020 2020 2020  phi).           
-00030e90: 2020 2020 2020 2020 2050 7473 5b31 2c4e           Pts[1,N
-00030ea0: 505d 203d 2052 5b69 695d 2a63 5f73 696e  P] = R[ii]*c_sin
-00030eb0: 2870 6869 290a 2020 2020 2020 2020 2020  (phi).          
-00030ec0: 2020 2020 2020 2020 2020 5074 735b 322c            Pts[2,
-00030ed0: 4e50 5d20 3d20 5a5b 7a7a 5d0a 2020 2020  NP] = Z[zz].    
-00030ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030ef0: 696e 645b 4e50 5d20 3d20 4e52 5068 6930  ind[NP] = NRPhi0
-00030f00: 5b69 695d 202b 2069 6e64 5a5b 7a7a 5d2a  [ii] + indZ[zz]*
-00030f10: 4e52 5068 695b 6969 5d20 2b20 696e 6469  NRPhi[ii] + indi
-00030f20: 696a 6a0a 2020 2020 2020 2020 2020 2020  ijj.            
-00030f30: 2020 2020 2020 2020 6456 5b4e 505d 203d          dV[NP] =
-00030f40: 2072 6573 6f5f 722a 7265 736f 5f7a 2a64   reso_r*reso_z*d
-00030f50: 5250 6869 725b 6969 5d0a 2020 2020 2020  RPhir[ii].      
-00030f60: 2020 2020 2020 2020 2020 2020 2020 4e50                NP
-00030f70: 202b 3d20 310a 2020 2020 656c 7365 3a0a   += 1.    else:.
-00030f80: 2020 2020 2020 2020 666f 7220 6969 2069          for ii i
-00030f90: 6e20 7261 6e67 6528 302c 526e 293a 0a20  n range(0,Rn):. 
-00030fa0: 2020 2020 2020 2020 2020 2069 6969 203d             iii =
-00030fb0: 206e 702e 736f 7274 2869 6e64 495b 6969   np.sort(indI[ii
-00030fc0: 2c7e 6e70 2e69 736e 616e 2869 6e64 495b  ,~np.isnan(indI[
-00030fd0: 6969 2c3a 5d29 5d29 0a20 2020 2020 2020  ii,:])]).       
-00030fe0: 2020 2020 2023 6173 7365 7274 2069 6969       #assert iii
-00030ff0: 2e73 697a 653d 3d50 6869 6e5b 6969 5d20  .size==Phin[ii] 
-00031000: 616e 6420 6e70 2e61 6c6c 286e 702e 756e  and np.all(np.un
-00031010: 6971 7565 2869 6969 293d 3d69 6969 290a  ique(iii)==iii).
-00031020: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00031030: 7a7a 2069 6e20 7261 6e67 6528 302c 5a6e  zz in range(0,Zn
-00031040: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00031050: 2020 2066 6f72 206a 6a20 696e 2072 616e     for jj in ran
-00031060: 6765 2830 2c50 6869 6e5b 6969 5d29 3a0a  ge(0,Phin[ii]):.
-00031070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031080: 2020 2020 696e 6469 696a 6a20 3d20 6969      indiijj = ii
-00031090: 695b 6a6a 5d20 2369 6e64 495b 6969 2c69  i[jj] #indI[ii,i
-000310a0: 6969 5b6a 6a5d 5d0a 2020 2020 2020 2020  ii[jj]].        
-000310b0: 2020 2020 2020 2020 2020 2020 5074 735b              Pts[
-000310c0: 302c 4e50 5d20 3d20 525b 6969 5d0a 2020  0,NP] = R[ii].  
-000310d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000310e0: 2020 5074 735b 312c 4e50 5d20 3d20 5a5b    Pts[1,NP] = Z[
-000310f0: 7a7a 5d0a 2020 2020 2020 2020 2020 2020  zz].            
-00031100: 2020 2020 2020 2020 5074 735b 322c 4e50          Pts[2,NP
-00031110: 5d20 3d20 2d63 5f70 6920 2b20 2830 2e35  ] = -c_pi + (0.5
-00031120: 2b69 6e64 6969 6a6a 292a 6450 6869 725b  +indiijj)*dPhir[
-00031130: 6969 5d0a 2020 2020 2020 2020 2020 2020  ii].            
-00031140: 2020 2020 2020 2020 696e 645b 4e50 5d20          ind[NP] 
-00031150: 3d20 4e52 5068 6930 5b69 695d 202b 2069  = NRPhi0[ii] + i
-00031160: 6e64 5a5b 7a7a 5d2a 4e52 5068 695b 6969  ndZ[zz]*NRPhi[ii
-00031170: 5d20 2b20 696e 6469 696a 6a0a 2020 2020  ] + indiijj.    
-00031180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031190: 6456 5b4e 505d 203d 2072 6573 6f5f 722a  dV[NP] = reso_r*
-000311a0: 7265 736f 5f7a 2a64 5250 6869 725b 6969  reso_z*dRPhir[ii
-000311b0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-000311c0: 2020 2020 2020 4e50 202b 3d20 310a 2020        NP += 1.  
-000311d0: 2020 6966 2056 506f 6c79 2069 7320 6e6f    if VPoly is no
-000311e0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-000311f0: 6966 204f 7574 2e6c 6f77 6572 2829 3d3d  if Out.lower()==
-00031200: 2728 782c 792c 7a29 273a 0a20 2020 2020  '(x,y,z)':.     
-00031210: 2020 2020 2020 2068 7970 6f74 203d 205f         hypot = _
-00031220: 6267 742e 636f 6d70 7574 655f 6879 706f  bgt.compute_hypo
-00031230: 7428 5074 735b 302c 3a5d 2c50 7473 5b31  t(Pts[0,:],Pts[1
-00031240: 2c3a 5d29 0a20 2020 2020 2020 2020 2020  ,:]).           
-00031250: 2069 6e64 696e 203d 2050 6174 6828 5650   indin = Path(VP
-00031260: 6f6c 792e 5429 2e63 6f6e 7461 696e 735f  oly.T).contains_
-00031270: 706f 696e 7473 286e 702e 6172 7261 7928  points(np.array(
-00031280: 5b68 7970 6f74 2c50 7473 5b32 2c3a 5d5d  [hypot,Pts[2,:]]
-00031290: 292e 542c 0a20 2020 2020 2020 2020 2020  ).T,.           
-000312a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000312b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000312c0: 2020 2020 2020 2074 7261 6e73 666f 726d         transform
-000312d0: 3d4e 6f6e 652c 2072 6164 6975 733d 302e  =None, radius=0.
-000312e0: 3029 0a20 2020 2020 2020 2020 2020 2050  0).            P
-000312f0: 7473 2c20 6456 2c20 696e 6420 3d20 5074  ts, dV, ind = Pt
-00031300: 735b 3a2c 696e 6469 6e5d 2c20 6456 5b69  s[:,indin], dV[i
-00031310: 6e64 696e 5d2c 2069 6e64 5b69 6e64 696e  ndin], ind[indin
-00031320: 5d0a 2020 2020 2020 2020 2020 2020 5275  ].            Ru
-00031330: 203d 206e 702e 756e 6971 7565 2868 7970   = np.unique(hyp
-00031340: 6f74 290a 2020 2020 2020 2020 656c 7365  ot).        else
-00031350: 3a0a 2020 2020 2020 2020 2020 2020 696e  :.            in
-00031360: 6469 6e20 3d20 5061 7468 2856 506f 6c79  din = Path(VPoly
-00031370: 2e54 292e 636f 6e74 6169 6e73 5f70 6f69  .T).contains_poi
-00031380: 6e74 7328 5074 735b 3a2d 312c 3a5d 2e54  nts(Pts[:-1,:].T
-00031390: 2c20 7472 616e 7366 6f72 6d3d 4e6f 6e65  , transform=None
-000313a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000313b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000313c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000313d0: 2020 2020 7261 6469 7573 3d30 2e30 290a      radius=0.0).
-000313e0: 2020 2020 2020 2020 2020 2020 5074 732c              Pts,
-000313f0: 2064 562c 2069 6e64 203d 2050 7473 5b3a   dV, ind = Pts[:
-00031400: 2c69 6e64 696e 5d2c 2064 565b 696e 6469  ,indin], dV[indi
-00031410: 6e5d 2c20 696e 645b 696e 6469 6e5d 0a20  n], ind[indin]. 
-00031420: 2020 2020 2020 2020 2020 2052 7520 3d20             Ru = 
-00031430: 6e70 2e75 6e69 7175 6528 5074 735b 302c  np.unique(Pts[0,
-00031440: 3a5d 290a 2020 2020 2020 2020 2320 544f  :]).        # TO
-00031450: 444f 203a 2057 6172 6e69 6e67 203a 2064  DO : Warning : d
-00031460: 6f20 7765 206e 6565 6420 7468 6520 666f  o we need the fo
-00031470: 6c6c 6f77 696e 6720 6c69 6e65 7320 3f3f  llowing lines ??
-00031480: 3f3f 0a20 2020 2020 2020 2023 2069 6620  ??.        # if 
-00031490: 6e6f 7420 6e70 2e61 6c6c 2852 753d 3d52  not np.all(Ru==R
-000314a0: 293a 0a20 2020 2020 2020 2023 2020 2020  ):.        #    
-000314b0: 2064 5250 6869 7220 3d20 6e70 2e61 7272   dRPhir = np.arr
-000314c0: 6179 285b 6452 5068 6972 5b69 695d 2066  ay([dRPhir[ii] f
-000314d0: 6f72 2069 6920 696e 2072 616e 6765 2830  or ii in range(0
-000314e0: 2c6c 656e 2852 2929 205c 0a20 2020 2020  ,len(R)) \.     
-000314f0: 2020 2023 2020 2020 2020 2020 2020 2020     #            
-00031500: 2020 2020 2020 2020 2020 2020 6966 2052              if R
-00031510: 5b69 695d 2069 6e20 5275 5d29 0a20 2020  [ii] in Ru]).   
-00031520: 2072 6574 7572 6e20 5074 732c 2064 562c   return Pts, dV,
-00031530: 2069 6e64 2e61 7374 7970 6528 696e 7429   ind.astype(int)
-00031540: 2c20 7265 736f 5f72 2c20 7265 736f 5f7a  , reso_r, reso_z
-00031550: 2c20 6e70 2e61 7361 7272 6179 2864 5250  , np.asarray(dRP
-00031560: 6869 7229 0a0a 0a64 6566 205f 5665 735f  hir)...def _Ves_
-00031570: 566d 6573 685f 546f 725f 5375 6246 726f  Vmesh_Tor_SubFro
-00031580: 6d49 6e64 5f63 7974 686f 6e5f 6f6c 6428  mInd_cython_old(
-00031590: 646f 7562 6c65 2064 522c 2064 6f75 626c  double dR, doubl
-000315a0: 6520 645a 2c20 646f 7562 6c65 2064 5250  e dZ, double dRP
-000315b0: 6869 2c0a 2020 2020 2020 2020 2020 2020  hi,.            
-000315c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000315d0: 2020 2020 2020 2020 2064 6f75 626c 655b           double[
-000315e0: 3a3a 315d 2052 4d69 6e4d 6178 2c20 646f  ::1] RMinMax, do
-000315f0: 7562 6c65 5b3a 3a31 5d20 5a4d 696e 4d61  uble[::1] ZMinMa
-00031600: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
-00031610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031620: 2020 2020 2020 2020 6c6f 6e67 5b3a 3a31          long[::1
-00031630: 5d20 696e 642c 2073 7472 204f 7574 3d27  ] ind, str Out='
-00031640: 2858 2c59 2c5a 2927 2c0a 2020 2020 2020  (X,Y,Z)',.      
-00031650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031660: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00031670: 6f75 626c 6520 6d61 7267 696e 3d5f 5653  ouble margin=_VS
-00031680: 4d41 4c4c 293a 0a20 2020 2022 2222 2052  MALL):.    """ R
-00031690: 6574 7572 6e20 7468 6520 6465 7369 7265  eturn the desire
-000316a0: 6420 7375 626d 6573 6820 696e 6469 6361  d submesh indica
-000316b0: 7465 6420 6279 2074 6865 2028 6e75 6d65  ted by the (nume
-000316c0: 7269 6361 6c29 2069 6e64 6963 6573 2c0a  rical) indices,.
-000316d0: 2020 2020 666f 7220 7468 6520 6465 7369      for the desi
-000316e0: 7265 6420 7265 736f 6c75 7469 6f6e 2028  red resolution (
-000316f0: 6452 2c64 5a2c 6452 7068 6929 0a20 2020  dR,dZ,dRphi).   
-00031700: 2022 2222 0a20 2020 2063 6465 6620 646f   """.    cdef do
-00031710: 7562 6c65 5b3a 3a31 5d20 522c 205a 2c20  uble[::1] R, Z, 
-00031720: 6452 5068 6972 5265 662c 2064 5068 6972  dRPhirRef, dPhir
-00031730: 2c20 5275 2c20 6452 5068 6972 0a20 2020  , Ru, dRPhir.   
-00031740: 2063 6465 6620 646f 7562 6c65 2072 6573   cdef double res
-00031750: 6f5f 722c 2072 6573 6f5f 7a2c 2070 6869  o_r, reso_z, phi
-00031760: 0a20 2020 2063 6465 6620 6c6f 6e67 5b3a  .    cdef long[:
-00031770: 3a31 5d20 696e 6452 2c20 696e 645a 2c20  :1] indR, indZ, 
-00031780: 4e52 5068 6930 2c20 4e52 5068 690a 2020  NRPhi0, NRPhi.  
-00031790: 2020 6364 6566 206c 6f6e 6720 4e52 2c20    cdef long NR, 
-000317a0: 4e5a 2c20 526e 2c20 5a6e 2c20 4e50 3d6c  NZ, Rn, Zn, NP=l
-000317b0: 656e 2869 6e64 292c 2072 6164 6975 735f  en(ind), radius_
-000317c0: 7261 7469 6f0a 2020 2020 6364 6566 2069  ratio.    cdef i
-000317d0: 6e74 2069 693d 302c 206a 6a3d 302c 2069  nt ii=0, jj=0, i
-000317e0: 6952 2c20 6969 5a2c 2069 6970 6869 0a20  iR, iiZ, iiphi. 
-000317f0: 2020 2063 6465 6620 646f 7562 6c65 5b3a     cdef double[:
-00031800: 2c3a 3a31 5d20 5068 690a 2020 2020 6364  ,::1] Phi.    cd
-00031810: 6566 206e 702e 6e64 6172 7261 795b 646f  ef np.ndarray[do
-00031820: 7562 6c65 2c6e 6469 6d3d 325d 2050 7473  uble,ndim=2] Pts
-00031830: 3d6e 702e 656d 7074 7928 2833 2c4e 5029  =np.empty((3,NP)
-00031840: 290a 2020 2020 6364 6566 206e 702e 6e64  ).    cdef np.nd
-00031850: 6172 7261 795b 646f 7562 6c65 2c6e 6469  array[double,ndi
-00031860: 6d3d 315d 2064 563d 6e70 2e65 6d70 7479  m=1] dV=np.empty
-00031870: 2828 4e50 2c29 290a 0a20 2020 2077 6172  ((NP,))..    war
-00031880: 6e28 2259 6f75 2061 7265 2075 7369 6e67  n("You are using
-00031890: 2074 6865 206f 6c64 2061 6c67 6f72 6974   the old algorit
-000318a0: 686d 2066 6f72 206d 6573 6869 6e67 2061  hm for meshing a
-000318b0: 2076 6f6c 756d 652e 220a 2020 2020 2020   volume.".      
-000318c0: 2020 202b 2022 2054 6869 7320 616c 676f     + " This algo
-000318d0: 7269 7468 6d20 6973 2073 6c6f 7765 7220  rithm is slower 
-000318e0: 7468 616e 2074 6865 206e 6577 206f 6e65  than the new one
-000318f0: 2e22 2c20 5761 726e 696e 6729 0a0a 2020  .", Warning)..  
-00031900: 2020 2320 4765 7420 7468 6520 6163 7475    # Get the actu
-00031910: 616c 2052 2061 6e64 205a 2072 6573 6f6c  al R and Z resol
-00031920: 7574 696f 6e73 2061 6e64 206d 6573 6820  utions and mesh 
-00031930: 656c 656d 656e 7473 0a20 2020 2052 2c20  elements.    R, 
-00031940: 7265 736f 5f72 2c20 696e 6452 2c20 4e52  reso_r, indR, NR
-00031950: 203d 2064 6973 6372 6574 697a 655f 6c69   = discretize_li
-00031960: 6e65 3164 2852 4d69 6e4d 6178 2c20 6452  ne1d(RMinMax, dR
-00031970: 2c20 4e6f 6e65 2c20 4c69 6d3d 5472 7565  , None, Lim=True
-00031980: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00031990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000319a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000319b0: 2020 6d61 7267 696e 3d6d 6172 6769 6e29    margin=margin)
-000319c0: 0a20 2020 205a 2c20 7265 736f 5f7a 2c20  .    Z, reso_z, 
-000319d0: 696e 645a 2c20 4e5a 203d 2064 6973 6372  indZ, NZ = discr
-000319e0: 6574 697a 655f 6c69 6e65 3164 285a 4d69  etize_line1d(ZMi
-000319f0: 6e4d 6178 2c20 645a 2c20 4e6f 6e65 2c20  nMax, dZ, None, 
-00031a00: 4c69 6d3d 5472 7565 2c0a 2020 2020 2020  Lim=True,.      
+00030250: 2020 2020 2020 6d61 7267 696e 3d6d 6172        margin=mar
+00030260: 6769 6e29 0a20 2020 205a 2c20 7265 736f  gin).    Z, reso
+00030270: 5f7a 2c20 696e 645a 2c20 4e5a 203d 2064  _z, indZ, NZ = d
+00030280: 6973 6372 6574 697a 655f 6c69 6e65 3164  iscretize_line1d
+00030290: 285a 4d69 6e4d 6178 2c20 645a 2c20 445a  (ZMinMax, dZ, DZ
+000302a0: 2c20 4c69 6d3d 5472 7565 2c0a 2020 2020  , Lim=True,.    
+000302b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000302c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000302d0: 2020 2020 2020 6d61 7267 696e 3d6d 6172        margin=mar
+000302e0: 6769 6e29 0a20 2020 2052 6e20 3d20 6c65  gin).    Rn = le
+000302f0: 6e28 5229 0a20 2020 205a 6e20 3d20 6c65  n(R).    Zn = le
+00030300: 6e28 5a29 0a20 2020 2023 2047 6574 2074  n(Z).    # Get t
+00030310: 6865 206c 696d 6974 7320 6966 2061 6e79  he limits if any
+00030320: 2028 616e 6420 6d61 6b65 2073 7572 6520   (and make sure 
+00030330: 746f 2072 6570 6c61 6365 2074 6865 6d20  to replace them 
+00030340: 696e 2074 6865 2070 726f 7065 720a 2020  in the proper.  
+00030350: 2020 2320 7175 6164 7261 6e74 7329 0a20    # quadrants). 
+00030360: 2020 2069 6620 4450 6869 2069 7320 4e6f     if DPhi is No
+00030370: 6e65 3a0a 2020 2020 2020 2020 4450 6869  ne:.        DPhi
+00030380: 302c 2044 5068 6931 203d 202d 635f 7069  0, DPhi1 = -c_pi
+00030390: 2c20 635f 7069 0a20 2020 2065 6c73 653a  , c_pi.    else:
+000303a0: 0a20 2020 2020 2020 2044 5068 6930 203d  .        DPhi0 =
+000303b0: 2063 5f61 7461 6e32 2863 5f73 696e 2844   c_atan2(c_sin(D
+000303c0: 5068 695b 305d 292c 2063 5f63 6f73 2844  Phi[0]), c_cos(D
+000303d0: 5068 695b 305d 2929 0a20 2020 2020 2020  Phi[0])).       
+000303e0: 2044 5068 6931 203d 2063 5f61 7461 6e32   DPhi1 = c_atan2
+000303f0: 2863 5f73 696e 2844 5068 695b 315d 292c  (c_sin(DPhi[1]),
+00030400: 2063 5f63 6f73 2844 5068 695b 315d 2929   c_cos(DPhi[1]))
+00030410: 0a20 2020 2064 5250 6869 722c 2064 5068  .    dRPhir, dPh
+00030420: 6972 203d 206e 702e 656d 7074 7928 2852  ir = np.empty((R
+00030430: 6e2c 2929 2c20 6e70 2e65 6d70 7479 2828  n,)), np.empty((
+00030440: 526e 2c29 290a 2020 2020 5068 696e 203d  Rn,)).    Phin =
+00030450: 206e 702e 656d 7074 7928 2852 6e2c 292c   np.empty((Rn,),
+00030460: 6474 7970 653d 696e 7429 0a20 2020 204e  dtype=int).    N
+00030470: 5250 6869 203d 206e 702e 656d 7074 7928  RPhi = np.empty(
+00030480: 2852 6e2c 2929 0a20 2020 204e 5250 6869  (Rn,)).    NRPhi
+00030490: 3020 3d20 6e70 2e7a 6572 6f73 2828 526e  0 = np.zeros((Rn
+000304a0: 2c29 2c64 7479 7065 3d69 6e74 290a 2020  ,),dtype=int).  
+000304b0: 2020 6e52 5068 6930 2c20 696e 6452 3069    nRPhi0, indR0i
+000304c0: 6920 3d20 302c 2030 0a20 2020 204e 502c  i = 0, 0.    NP,
+000304d0: 204e 5068 696d 6178 203d 2030 2c20 300a   NPhimax = 0, 0.
+000304e0: 2020 2020 7261 6469 7573 5f72 6174 696f      radius_ratio
+000304f0: 203d 2069 6e74 2863 5f63 6569 6c28 525b   = int(c_ceil(R[
+00030500: 526e 2d31 5d2f 525b 305d 2929 0a20 2020  Rn-1]/R[0])).   
+00030510: 2066 6f72 2069 6920 696e 2072 616e 6765   for ii in range
+00030520: 2830 2c52 6e29 3a0a 2020 2020 2020 2020  (0,Rn):.        
+00030530: 2320 4765 7420 7468 6520 6163 7475 616c  # Get the actual
+00030540: 2052 5068 6920 7265 736f 6c75 7469 6f6e   RPhi resolution
+00030550: 2061 6e64 2050 6869 206d 6573 6820 656c   and Phi mesh el
+00030560: 656d 656e 7473 2028 2120 6465 7065 6e64  ements (! depend
+00030570: 7320 6f6e 2052 2129 0a20 2020 2020 2020  s on R!).       
+00030580: 204e 5250 6869 5b69 695d 203d 2063 5f63   NRPhi[ii] = c_c
+00030590: 6569 6c28 322e 2a63 5f70 692a 525b 6969  eil(2.*c_pi*R[ii
+000305a0: 5d2f 6452 5068 6929 0a20 2020 2020 2020  ]/dRPhi).       
+000305b0: 204e 5250 6869 5f69 6e74 203d 2069 6e74   NRPhi_int = int
+000305c0: 284e 5250 6869 5b69 695d 290a 2020 2020  (NRPhi[ii]).    
+000305d0: 2020 2020 6450 6869 725b 6969 5d20 3d20      dPhir[ii] = 
+000305e0: 322e 2a63 5f70 692f 4e52 5068 695b 6969  2.*c_pi/NRPhi[ii
+000305f0: 5d0a 2020 2020 2020 2020 6452 5068 6972  ].        dRPhir
+00030600: 5b69 695d 203d 2064 5068 6972 5b69 695d  [ii] = dPhir[ii]
+00030610: 2a52 5b69 695d 0a20 2020 2020 2020 2023  *R[ii].        #
+00030620: 2047 6574 2069 6e64 6578 2061 6e64 2063   Get index and c
+00030630: 756d 756c 6174 6564 2069 6e64 6963 6573  umulated indices
+00030640: 2066 726f 6d20 6261 636b 6772 6f75 6e64   from background
+00030650: 0a20 2020 2020 2020 2066 6f72 206a 6a20  .        for jj 
+00030660: 696e 2072 616e 6765 2869 6e64 5230 6969  in range(indR0ii
+00030670: 2c4e 5230 293a 0a20 2020 2020 2020 2020  ,NR0):.         
+00030680: 2020 2069 6620 5230 5b6a 6a5d 3d3d 525b     if R0[jj]==R[
+00030690: 6969 5d3a 0a20 2020 2020 2020 2020 2020  ii]:.           
+000306a0: 2020 2020 2069 6e64 5230 6969 203d 206a       indR0ii = j
+000306b0: 6a0a 2020 2020 2020 2020 2020 2020 2020  j.              
+000306c0: 2020 6272 6561 6b0a 2020 2020 2020 2020    break.        
+000306d0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000306e0: 2020 2020 2020 2020 2020 6e52 5068 6930            nRPhi0
+000306f0: 202b 3d20 3c6c 6f6e 673e 635f 6365 696c   += <long>c_ceil
+00030700: 2832 2e2a 635f 7069 2a52 305b 6a6a 5d2f  (2.*c_pi*R0[jj]/
+00030710: 6452 5068 6929 0a20 2020 2020 2020 2020  dRPhi).         
+00030720: 2020 2020 2020 204e 5250 6869 305b 6969         NRPhi0[ii
+00030730: 5d20 3d20 6e52 5068 6930 2a4e 5a0a 2020  ] = nRPhi0*NZ.  
+00030740: 2020 2020 2020 2320 4765 7420 696e 6469        # Get indi
+00030750: 6365 7320 6f66 2070 6869 0a20 2020 2020  ces of phi.     
+00030760: 2020 2023 2047 6574 2074 6865 2065 7874     # Get the ext
+00030770: 7265 6d65 2069 6e64 6963 6573 206f 6620  reme indices of 
+00030780: 7468 6520 6d65 7368 2065 6c65 6d65 6e74  the mesh element
+00030790: 7320 7468 6174 2072 6561 6c6c 7920 6e65  s that really ne
+000307a0: 6564 2074 6f0a 2020 2020 2020 2020 2320  ed to.        # 
+000307b0: 6265 2063 7265 6174 6564 2077 6974 6869  be created withi
+000307c0: 6e20 7468 6f73 6520 6c69 6d69 7473 0a20  n those limits. 
+000307d0: 2020 2020 2020 2061 6273 3020 3d20 635f         abs0 = c_
+000307e0: 6162 7328 4450 6869 302b 635f 7069 290a  abs(DPhi0+c_pi).
+000307f0: 2020 2020 2020 2020 6966 2061 6273 302d          if abs0-
+00030800: 6450 6869 725b 6969 5d2a 635f 666c 6f6f  dPhir[ii]*c_floo
+00030810: 7228 6162 7330 2f64 5068 6972 5b69 695d  r(abs0/dPhir[ii]
+00030820: 2920 3c20 6d61 7267 696e 2a64 5068 6972  ) < margin*dPhir
+00030830: 5b69 695d 3a0a 2020 2020 2020 2020 2020  [ii]:.          
+00030840: 2020 6e50 6869 3020 3d20 696e 7428 635f    nPhi0 = int(c_
+00030850: 726f 756e 6428 2844 5068 6930 2b63 5f70  round((DPhi0+c_p
+00030860: 6929 2f64 5068 6972 5b69 695d 2929 0a20  i)/dPhir[ii])). 
+00030870: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00030880: 2020 2020 2020 2020 206e 5068 6930 203d           nPhi0 =
+00030890: 2069 6e74 2863 5f66 6c6f 6f72 2828 4450   int(c_floor((DP
+000308a0: 6869 302b 635f 7069 292f 6450 6869 725b  hi0+c_pi)/dPhir[
+000308b0: 6969 5d29 290a 2020 2020 2020 2020 6162  ii])).        ab
+000308c0: 7331 203d 2063 5f61 6273 2844 5068 6931  s1 = c_abs(DPhi1
+000308d0: 2b63 5f70 6929 0a20 2020 2020 2020 2069  +c_pi).        i
+000308e0: 6620 6162 7331 2d64 5068 6972 5b69 695d  f abs1-dPhir[ii]
+000308f0: 2a63 5f66 6c6f 6f72 2861 6273 312f 6450  *c_floor(abs1/dP
+00030900: 6869 725b 6969 5d29 203c 206d 6172 6769  hir[ii]) < margi
+00030910: 6e2a 6450 6869 725b 6969 5d3a 0a20 2020  n*dPhir[ii]:.   
+00030920: 2020 2020 2020 2020 206e 5068 6931 203d           nPhi1 =
+00030930: 2069 6e74 2863 5f72 6f75 6e64 2828 4450   int(c_round((DP
+00030940: 6869 312b 635f 7069 292f 6450 6869 725b  hi1+c_pi)/dPhir[
+00030950: 6969 5d29 2d31 290a 2020 2020 2020 2020  ii])-1).        
+00030960: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00030970: 2020 6e50 6869 3120 3d20 696e 7428 635f    nPhi1 = int(c_
+00030980: 666c 6f6f 7228 2844 5068 6931 2b63 5f70  floor((DPhi1+c_p
+00030990: 6929 2f64 5068 6972 5b69 695d 2929 0a0a  i)/dPhir[ii]))..
+000309a0: 2020 2020 2020 2020 6966 2044 5068 6930          if DPhi0
+000309b0: 3c44 5068 6931 3a0a 2020 2020 2020 2020  <DPhi1:.        
+000309c0: 2020 2020 2369 6e64 492e 6170 7065 6e64      #indI.append
+000309d0: 286c 6973 7428 7261 6e67 6528 6e50 6869  (list(range(nPhi
+000309e0: 302c 6e50 6869 312b 3129 2929 0a20 2020  0,nPhi1+1))).   
+000309f0: 2020 2020 2020 2020 2050 6869 6e5b 6969           Phin[ii
+00030a00: 5d20 3d20 6e50 6869 312b 312d 6e50 6869  ] = nPhi1+1-nPhi
+00030a10: 300a 2020 2020 2020 2020 2020 2020 6966  0.            if
+00030a20: 2069 693d 3d30 3a0a 2020 2020 2020 2020   ii==0:.        
+00030a30: 2020 2020 2020 2020 696e 6449 203d 206e          indI = n
+00030a40: 702e 6e61 6e2a 6e70 2e6f 6e65 7328 2852  p.nan*np.ones((R
+00030a50: 6e2c 5068 696e 5b69 695d 2a72 6164 6975  n,Phin[ii]*radiu
+00030a60: 735f 7261 7469 6f2b 3129 290a 2020 2020  s_ratio+1)).    
+00030a70: 2020 2020 2020 2020 666f 7220 6a6a 2069          for jj i
+00030a80: 6e20 7261 6e67 6528 302c 5068 696e 5b69  n range(0,Phin[i
+00030a90: 695d 293a 0a20 2020 2020 2020 2020 2020  i]):.           
+00030aa0: 2020 2020 2069 6e64 495b 6969 2c6a 6a5d       indI[ii,jj]
+00030ab0: 203d 203c 646f 7562 6c65 3e28 206e 5068   = <double>( nPh
+00030ac0: 6930 2b6a 6a20 290a 2020 2020 2020 2020  i0+jj ).        
+00030ad0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00030ae0: 2020 2369 6e64 492e 6170 7065 6e64 286c    #indI.append(l
+00030af0: 6973 7428 7261 6e67 6528 6e50 6869 302c  ist(range(nPhi0,
+00030b00: 4e52 5068 695f 696e 7429 2b6c 6973 7428  NRPhi_int)+list(
+00030b10: 7261 6e67 6528 302c 6e50 6869 312b 3129  range(0,nPhi1+1)
+00030b20: 2929 290a 2020 2020 2020 2020 2020 2020  ))).            
+00030b30: 5068 696e 5b69 695d 203d 206e 5068 6931  Phin[ii] = nPhi1
+00030b40: 2b31 2b4e 5250 6869 5f69 6e74 2d6e 5068  +1+NRPhi_int-nPh
+00030b50: 6930 0a20 2020 2020 2020 2020 2020 2069  i0.            i
+00030b60: 6620 6969 3d3d 303a 0a20 2020 2020 2020  f ii==0:.       
+00030b70: 2020 2020 2020 2020 2069 6e64 4920 3d20           indI = 
+00030b80: 6e70 2e6e 616e 2a6e 702e 6f6e 6573 2828  np.nan*np.ones((
+00030b90: 526e 2c50 6869 6e5b 6969 5d2a 7261 6469  Rn,Phin[ii]*radi
+00030ba0: 7573 5f72 6174 696f 2b31 2929 0a20 2020  us_ratio+1)).   
+00030bb0: 2020 2020 2020 2020 2066 6f72 206a 6a20           for jj 
+00030bc0: 696e 2072 616e 6765 2830 2c4e 5250 6869  in range(0,NRPhi
+00030bd0: 5f69 6e74 2d6e 5068 6930 293a 0a20 2020  _int-nPhi0):.   
+00030be0: 2020 2020 2020 2020 2020 2020 2069 6e64               ind
+00030bf0: 495b 6969 2c6a 6a5d 203d 203c 646f 7562  I[ii,jj] = <doub
+00030c00: 6c65 3e28 206e 5068 6930 2b6a 6a20 290a  le>( nPhi0+jj ).
+00030c10: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00030c20: 6a6a 2069 6e20 7261 6e67 6528 4e52 5068  jj in range(NRPh
+00030c30: 695f 696e 742d 6e50 6869 302c 5068 696e  i_int-nPhi0,Phin
+00030c40: 5b69 695d 293a 0a20 2020 2020 2020 2020  [ii]):.         
+00030c50: 2020 2020 2020 2069 6e64 495b 6969 2c6a         indI[ii,j
+00030c60: 6a5d 203d 203c 646f 7562 6c65 3e28 206a  j] = <double>( j
+00030c70: 6a2d 2028 4e52 5068 695f 696e 742d 6e50  j- (NRPhi_int-nP
+00030c80: 6869 3029 2029 0a20 2020 2020 2020 204e  hi0) ).        N
+00030c90: 5020 2b3d 205a 6e2a 5068 696e 5b69 695d  P += Zn*Phin[ii]
+00030ca0: 0a20 2020 2050 7473 203d 206e 702e 656d  .    Pts = np.em
+00030cb0: 7074 7928 2833 2c4e 5029 290a 2020 2020  pty((3,NP)).    
+00030cc0: 696e 6420 3d20 6e70 2e65 6d70 7479 2828  ind = np.empty((
+00030cd0: 4e50 2c29 290a 2020 2020 6456 203d 206e  NP,)).    dV = n
+00030ce0: 702e 656d 7074 7928 284e 502c 2929 0a20  p.empty((NP,)). 
+00030cf0: 2020 2023 2043 6f6d 7075 7465 2050 7473     # Compute Pts
+00030d00: 2c20 6456 2061 6e64 2069 6e64 0a20 2020  , dV and ind.   
+00030d10: 2023 2054 6869 7320 7472 6970 6c65 206c   # This triple l
+00030d20: 6f6f 7020 6973 2074 6865 206c 6f6e 6765  oop is the longe
+00030d30: 7374 2070 6172 742c 2069 7420 7461 6b65  st part, it take
+00030d40: 7320 7e39 3025 206f 6620 7468 6520 4350  s ~90% of the CP
+00030d50: 5520 7469 6d65 0a20 2020 204e 5020 3d20  U time.    NP = 
+00030d60: 300a 2020 2020 6966 204f 7574 2e6c 6f77  0.    if Out.low
+00030d70: 6572 2829 3d3d 2728 782c 792c 7a29 273a  er()=='(x,y,z)':
+00030d80: 0a20 2020 2020 2020 2066 6f72 2069 6920  .        for ii 
+00030d90: 696e 2072 616e 6765 2830 2c52 6e29 3a0a  in range(0,Rn):.
+00030da0: 2020 2020 2020 2020 2020 2020 2320 546f              # To
+00030db0: 206d 616b 6520 7375 7265 2074 6865 2069   make sure the i
+00030dc0: 6e64 6963 6573 2061 7265 2069 6e20 696e  ndices are in in
+00030dd0: 6372 6561 7369 6e67 206f 7264 6572 0a20  creasing order. 
+00030de0: 2020 2020 2020 2020 2020 2069 6969 203d             iii =
+00030df0: 206e 702e 736f 7274 2869 6e64 495b 6969   np.sort(indI[ii
+00030e00: 2c7e 6e70 2e69 736e 616e 2869 6e64 495b  ,~np.isnan(indI[
+00030e10: 6969 2c3a 5d29 5d29 0a20 2020 2020 2020  ii,:])]).       
+00030e20: 2020 2020 2066 6f72 207a 7a20 696e 2072       for zz in r
+00030e30: 616e 6765 2830 2c5a 6e29 3a0a 2020 2020  ange(0,Zn):.    
+00030e40: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00030e50: 6a6a 2069 6e20 7261 6e67 6528 302c 5068  jj in range(0,Ph
+00030e60: 696e 5b69 695d 293a 0a20 2020 2020 2020  in[ii]):.       
+00030e70: 2020 2020 2020 2020 2020 2020 2069 6e64               ind
+00030e80: 6969 6a6a 203d 2069 6969 5b6a 6a5d 0a20  iijj = iii[jj]. 
+00030e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030ea0: 2020 2070 6869 203d 202d 635f 7069 202b     phi = -c_pi +
+00030eb0: 2028 302e 352b 696e 6469 696a 6a29 2a64   (0.5+indiijj)*d
+00030ec0: 5068 6972 5b69 695d 0a20 2020 2020 2020  Phir[ii].       
+00030ed0: 2020 2020 2020 2020 2020 2020 2050 7473               Pts
+00030ee0: 5b30 2c4e 505d 203d 2052 5b69 695d 2a63  [0,NP] = R[ii]*c
+00030ef0: 5f63 6f73 2870 6869 290a 2020 2020 2020  _cos(phi).      
+00030f00: 2020 2020 2020 2020 2020 2020 2020 5074                Pt
+00030f10: 735b 312c 4e50 5d20 3d20 525b 6969 5d2a  s[1,NP] = R[ii]*
+00030f20: 635f 7369 6e28 7068 6929 0a20 2020 2020  c_sin(phi).     
+00030f30: 2020 2020 2020 2020 2020 2020 2020 2050                 P
+00030f40: 7473 5b32 2c4e 505d 203d 205a 5b7a 7a5d  ts[2,NP] = Z[zz]
+00030f50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00030f60: 2020 2020 2069 6e64 5b4e 505d 203d 204e       ind[NP] = N
+00030f70: 5250 6869 305b 6969 5d20 2b20 696e 645a  RPhi0[ii] + indZ
+00030f80: 5b7a 7a5d 2a4e 5250 6869 5b69 695d 202b  [zz]*NRPhi[ii] +
+00030f90: 2069 6e64 6969 6a6a 0a20 2020 2020 2020   indiijj.       
+00030fa0: 2020 2020 2020 2020 2020 2020 2064 565b               dV[
+00030fb0: 4e50 5d20 3d20 7265 736f 5f72 2a72 6573  NP] = reso_r*res
+00030fc0: 6f5f 7a2a 6452 5068 6972 5b69 695d 0a20  o_z*dRPhir[ii]. 
+00030fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030fe0: 2020 204e 5020 2b3d 2031 0a20 2020 2065     NP += 1.    e
+00030ff0: 6c73 653a 0a20 2020 2020 2020 2066 6f72  lse:.        for
+00031000: 2069 6920 696e 2072 616e 6765 2830 2c52   ii in range(0,R
+00031010: 6e29 3a0a 2020 2020 2020 2020 2020 2020  n):.            
+00031020: 6969 6920 3d20 6e70 2e73 6f72 7428 696e  iii = np.sort(in
+00031030: 6449 5b69 692c 7e6e 702e 6973 6e61 6e28  dI[ii,~np.isnan(
+00031040: 696e 6449 5b69 692c 3a5d 295d 290a 2020  indI[ii,:])]).  
+00031050: 2020 2020 2020 2020 2020 2361 7373 6572            #asser
+00031060: 7420 6969 692e 7369 7a65 3d3d 5068 696e  t iii.size==Phin
+00031070: 5b69 695d 2061 6e64 206e 702e 616c 6c28  [ii] and np.all(
+00031080: 6e70 2e75 6e69 7175 6528 6969 6929 3d3d  np.unique(iii)==
+00031090: 6969 6929 0a20 2020 2020 2020 2020 2020  iii).           
+000310a0: 2066 6f72 207a 7a20 696e 2072 616e 6765   for zz in range
+000310b0: 2830 2c5a 6e29 3a0a 2020 2020 2020 2020  (0,Zn):.        
+000310c0: 2020 2020 2020 2020 666f 7220 6a6a 2069          for jj i
+000310d0: 6e20 7261 6e67 6528 302c 5068 696e 5b69  n range(0,Phin[i
+000310e0: 695d 293a 0a20 2020 2020 2020 2020 2020  i]):.           
+000310f0: 2020 2020 2020 2020 2069 6e64 6969 6a6a           indiijj
+00031100: 203d 2069 6969 5b6a 6a5d 2023 696e 6449   = iii[jj] #indI
+00031110: 5b69 692c 6969 695b 6a6a 5d5d 0a20 2020  [ii,iii[jj]].   
+00031120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031130: 2050 7473 5b30 2c4e 505d 203d 2052 5b69   Pts[0,NP] = R[i
+00031140: 695d 0a20 2020 2020 2020 2020 2020 2020  i].             
+00031150: 2020 2020 2020 2050 7473 5b31 2c4e 505d         Pts[1,NP]
+00031160: 203d 205a 5b7a 7a5d 0a20 2020 2020 2020   = Z[zz].       
+00031170: 2020 2020 2020 2020 2020 2020 2050 7473               Pts
+00031180: 5b32 2c4e 505d 203d 202d 635f 7069 202b  [2,NP] = -c_pi +
+00031190: 2028 302e 352b 696e 6469 696a 6a29 2a64   (0.5+indiijj)*d
+000311a0: 5068 6972 5b69 695d 0a20 2020 2020 2020  Phir[ii].       
+000311b0: 2020 2020 2020 2020 2020 2020 2069 6e64               ind
+000311c0: 5b4e 505d 203d 204e 5250 6869 305b 6969  [NP] = NRPhi0[ii
+000311d0: 5d20 2b20 696e 645a 5b7a 7a5d 2a4e 5250  ] + indZ[zz]*NRP
+000311e0: 6869 5b69 695d 202b 2069 6e64 6969 6a6a  hi[ii] + indiijj
+000311f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00031200: 2020 2020 2064 565b 4e50 5d20 3d20 7265       dV[NP] = re
+00031210: 736f 5f72 2a72 6573 6f5f 7a2a 6452 5068  so_r*reso_z*dRPh
+00031220: 6972 5b69 695d 0a20 2020 2020 2020 2020  ir[ii].         
+00031230: 2020 2020 2020 2020 2020 204e 5020 2b3d             NP +=
+00031240: 2031 0a20 2020 2069 6620 5650 6f6c 7920   1.    if VPoly 
+00031250: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00031260: 2020 2020 2069 6620 4f75 742e 6c6f 7765       if Out.lowe
+00031270: 7228 293d 3d27 2878 2c79 2c7a 2927 3a0a  r()=='(x,y,z)':.
+00031280: 2020 2020 2020 2020 2020 2020 6879 706f              hypo
+00031290: 7420 3d20 5f62 6774 2e63 6f6d 7075 7465  t = _bgt.compute
+000312a0: 5f68 7970 6f74 2850 7473 5b30 2c3a 5d2c  _hypot(Pts[0,:],
+000312b0: 5074 735b 312c 3a5d 290a 2020 2020 2020  Pts[1,:]).      
+000312c0: 2020 2020 2020 696e 6469 6e20 3d20 5061        indin = Pa
+000312d0: 7468 2856 506f 6c79 2e54 292e 636f 6e74  th(VPoly.T).cont
+000312e0: 6169 6e73 5f70 6f69 6e74 7328 6e70 2e61  ains_points(np.a
+000312f0: 7272 6179 285b 6879 706f 742c 5074 735b  rray([hypot,Pts[
+00031300: 322c 3a5d 5d29 2e54 2c0a 2020 2020 2020  2,:]]).T,.      
+00031310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031330: 2020 2020 2020 2020 2020 2020 7472 616e              tran
+00031340: 7366 6f72 6d3d 4e6f 6e65 2c20 7261 6469  sform=None, radi
+00031350: 7573 3d30 2e30 290a 2020 2020 2020 2020  us=0.0).        
+00031360: 2020 2020 5074 732c 2064 562c 2069 6e64      Pts, dV, ind
+00031370: 203d 2050 7473 5b3a 2c69 6e64 696e 5d2c   = Pts[:,indin],
+00031380: 2064 565b 696e 6469 6e5d 2c20 696e 645b   dV[indin], ind[
+00031390: 696e 6469 6e5d 0a20 2020 2020 2020 2020  indin].         
+000313a0: 2020 2052 7520 3d20 6e70 2e75 6e69 7175     Ru = np.uniqu
+000313b0: 6528 6879 706f 7429 0a20 2020 2020 2020  e(hypot).       
+000313c0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000313d0: 2020 2069 6e64 696e 203d 2050 6174 6828     indin = Path(
+000313e0: 5650 6f6c 792e 5429 2e63 6f6e 7461 696e  VPoly.T).contain
+000313f0: 735f 706f 696e 7473 2850 7473 5b3a 2d31  s_points(Pts[:-1
+00031400: 2c3a 5d2e 542c 2074 7261 6e73 666f 726d  ,:].T, transform
+00031410: 3d4e 6f6e 652c 0a20 2020 2020 2020 2020  =None,.         
+00031420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031440: 2020 2020 2020 2020 2072 6164 6975 733d           radius=
+00031450: 302e 3029 0a20 2020 2020 2020 2020 2020  0.0).           
+00031460: 2050 7473 2c20 6456 2c20 696e 6420 3d20   Pts, dV, ind = 
+00031470: 5074 735b 3a2c 696e 6469 6e5d 2c20 6456  Pts[:,indin], dV
+00031480: 5b69 6e64 696e 5d2c 2069 6e64 5b69 6e64  [indin], ind[ind
+00031490: 696e 5d0a 2020 2020 2020 2020 2020 2020  in].            
+000314a0: 5275 203d 206e 702e 756e 6971 7565 2850  Ru = np.unique(P
+000314b0: 7473 5b30 2c3a 5d29 0a20 2020 2020 2020  ts[0,:]).       
+000314c0: 2023 2054 4f44 4f20 3a20 5761 726e 696e   # TODO : Warnin
+000314d0: 6720 3a20 646f 2077 6520 6e65 6564 2074  g : do we need t
+000314e0: 6865 2066 6f6c 6c6f 7769 6e67 206c 696e  he following lin
+000314f0: 6573 203f 3f3f 3f0a 2020 2020 2020 2020  es ????.        
+00031500: 2320 6966 206e 6f74 206e 702e 616c 6c28  # if not np.all(
+00031510: 5275 3d3d 5229 3a0a 2020 2020 2020 2020  Ru==R):.        
+00031520: 2320 2020 2020 6452 5068 6972 203d 206e  #     dRPhir = n
+00031530: 702e 6172 7261 7928 5b64 5250 6869 725b  p.array([dRPhir[
+00031540: 6969 5d20 666f 7220 6969 2069 6e20 7261  ii] for ii in ra
+00031550: 6e67 6528 302c 6c65 6e28 5229 2920 5c0a  nge(0,len(R)) \.
+00031560: 2020 2020 2020 2020 2320 2020 2020 2020          #       
+00031570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031580: 2069 6620 525b 6969 5d20 696e 2052 755d   if R[ii] in Ru]
+00031590: 290a 2020 2020 7265 7475 726e 2050 7473  ).    return Pts
+000315a0: 2c20 6456 2c20 696e 642e 6173 7479 7065  , dV, ind.astype
+000315b0: 2869 6e74 292c 2072 6573 6f5f 722c 2072  (int), reso_r, r
+000315c0: 6573 6f5f 7a2c 206e 702e 6173 6172 7261  eso_z, np.asarra
+000315d0: 7928 6452 5068 6972 290a 0a0a 6465 6620  y(dRPhir)...def 
+000315e0: 5f56 6573 5f56 6d65 7368 5f54 6f72 5f53  _Ves_Vmesh_Tor_S
+000315f0: 7562 4672 6f6d 496e 645f 6379 7468 6f6e  ubFromInd_cython
+00031600: 5f6f 6c64 2864 6f75 626c 6520 6452 2c20  _old(double dR, 
+00031610: 646f 7562 6c65 2064 5a2c 2064 6f75 626c  double dZ, doubl
+00031620: 6520 6452 5068 692c 0a20 2020 2020 2020  e dRPhi,.       
+00031630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031640: 2020 2020 2020 2020 2020 2020 2020 646f                do
+00031650: 7562 6c65 5b3a 3a31 5d20 524d 696e 4d61  uble[::1] RMinMa
+00031660: 782c 2064 6f75 626c 655b 3a3a 315d 205a  x, double[::1] Z
+00031670: 4d69 6e4d 6178 2c0a 2020 2020 2020 2020  MinMax,.        
+00031680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031690: 2020 2020 2020 2020 2020 2020 206c 6f6e               lon
+000316a0: 675b 3a3a 315d 2069 6e64 2c20 7374 7220  g[::1] ind, str 
+000316b0: 4f75 743d 2728 582c 592c 5a29 272c 0a20  Out='(X,Y,Z)',. 
+000316c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000316d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000316e0: 2020 2020 646f 7562 6c65 206d 6172 6769      double margi
+000316f0: 6e3d 5f56 534d 414c 4c29 3a0a 2020 2020  n=_VSMALL):.    
+00031700: 2222 2220 5265 7475 726e 2074 6865 2064  """ Return the d
+00031710: 6573 6972 6564 2073 7562 6d65 7368 2069  esired submesh i
+00031720: 6e64 6963 6174 6564 2062 7920 7468 6520  ndicated by the 
+00031730: 286e 756d 6572 6963 616c 2920 696e 6469  (numerical) indi
+00031740: 6365 732c 0a20 2020 2066 6f72 2074 6865  ces,.    for the
+00031750: 2064 6573 6972 6564 2072 6573 6f6c 7574   desired resolut
+00031760: 696f 6e20 2864 522c 645a 2c64 5270 6869  ion (dR,dZ,dRphi
+00031770: 290a 2020 2020 2222 220a 2020 2020 6364  ).    """.    cd
+00031780: 6566 2064 6f75 626c 655b 3a3a 315d 2052  ef double[::1] R
+00031790: 2c20 5a2c 2064 5250 6869 7252 6566 2c20  , Z, dRPhirRef, 
+000317a0: 6450 6869 722c 2052 752c 2064 5250 6869  dPhir, Ru, dRPhi
+000317b0: 720a 2020 2020 6364 6566 2064 6f75 626c  r.    cdef doubl
+000317c0: 6520 7265 736f 5f72 2c20 7265 736f 5f7a  e reso_r, reso_z
+000317d0: 2c20 7068 690a 2020 2020 6364 6566 206c  , phi.    cdef l
+000317e0: 6f6e 675b 3a3a 315d 2069 6e64 522c 2069  ong[::1] indR, i
+000317f0: 6e64 5a2c 204e 5250 6869 302c 204e 5250  ndZ, NRPhi0, NRP
+00031800: 6869 0a20 2020 2063 6465 6620 6c6f 6e67  hi.    cdef long
+00031810: 204e 522c 204e 5a2c 2052 6e2c 205a 6e2c   NR, NZ, Rn, Zn,
+00031820: 204e 503d 6c65 6e28 696e 6429 2c20 7261   NP=len(ind), ra
+00031830: 6469 7573 5f72 6174 696f 0a20 2020 2063  dius_ratio.    c
+00031840: 6465 6620 696e 7420 6969 3d30 2c20 6a6a  def int ii=0, jj
+00031850: 3d30 2c20 6969 522c 2069 695a 2c20 6969  =0, iiR, iiZ, ii
+00031860: 7068 690a 2020 2020 6364 6566 2064 6f75  phi.    cdef dou
+00031870: 626c 655b 3a2c 3a3a 315d 2050 6869 0a20  ble[:,::1] Phi. 
+00031880: 2020 2063 6465 6620 6e70 2e6e 6461 7272     cdef np.ndarr
+00031890: 6179 5b64 6f75 626c 652c 6e64 696d 3d32  ay[double,ndim=2
+000318a0: 5d20 5074 733d 6e70 2e65 6d70 7479 2828  ] Pts=np.empty((
+000318b0: 332c 4e50 2929 0a20 2020 2063 6465 6620  3,NP)).    cdef 
+000318c0: 6e70 2e6e 6461 7272 6179 5b64 6f75 626c  np.ndarray[doubl
+000318d0: 652c 6e64 696d 3d31 5d20 6456 3d6e 702e  e,ndim=1] dV=np.
+000318e0: 656d 7074 7928 284e 502c 2929 0a0a 2020  empty((NP,))..  
+000318f0: 2020 7761 726e 2822 596f 7520 6172 6520    warn("You are 
+00031900: 7573 696e 6720 7468 6520 6f6c 6420 616c  using the old al
+00031910: 676f 7269 7468 6d20 666f 7220 6d65 7368  gorithm for mesh
+00031920: 696e 6720 6120 766f 6c75 6d65 2e22 0a20  ing a volume.". 
+00031930: 2020 2020 2020 2020 2b20 2220 5468 6973          + " This
+00031940: 2061 6c67 6f72 6974 686d 2069 7320 736c   algorithm is sl
+00031950: 6f77 6572 2074 6861 6e20 7468 6520 6e65  ower than the ne
+00031960: 7720 6f6e 652e 222c 2057 6172 6e69 6e67  w one.", Warning
+00031970: 290a 0a20 2020 2023 2047 6574 2074 6865  )..    # Get the
+00031980: 2061 6374 7561 6c20 5220 616e 6420 5a20   actual R and Z 
+00031990: 7265 736f 6c75 7469 6f6e 7320 616e 6420  resolutions and 
+000319a0: 6d65 7368 2065 6c65 6d65 6e74 730a 2020  mesh elements.  
+000319b0: 2020 522c 2072 6573 6f5f 722c 2069 6e64    R, reso_r, ind
+000319c0: 522c 204e 5220 3d20 6469 7363 7265 7469  R, NR = discreti
+000319d0: 7a65 5f6c 696e 6531 6428 524d 696e 4d61  ze_line1d(RMinMa
+000319e0: 782c 2064 522c 204e 6f6e 652c 204c 696d  x, dR, None, Lim
+000319f0: 3d54 7275 652c 0a20 2020 2020 2020 2020  =True,.         
+00031a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00031a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031a30: 2020 2020 2020 2020 2020 6d61 7267 696e            margin
-00031a40: 3d6d 6172 6769 6e29 0a20 2020 2052 6e2c  =margin).    Rn,
-00031a50: 205a 6e20 3d20 6c65 6e28 5229 2c20 6c65   Zn = len(R), le
-00031a60: 6e28 5a29 0a0a 2020 2020 2320 4e75 6d62  n(Z)..    # Numb
-00031a70: 6572 206f 6620 5068 6920 7065 7220 520a  er of Phi per R.
-00031a80: 2020 2020 6452 5068 6972 5265 662c 2064      dRPhirRef, d
-00031a90: 5068 6972 203d 206e 702e 656d 7074 7928  Phir = np.empty(
-00031aa0: 284e 522c 2929 2c20 6e70 2e65 6d70 7479  (NR,)), np.empty
-00031ab0: 2828 4e52 2c29 290a 2020 2020 5275 2c20  ((NR,)).    Ru, 
-00031ac0: 6452 5068 6972 203d 206e 702e 7a65 726f  dRPhir = np.zero
-00031ad0: 7328 284e 522c 2929 2c20 6e70 2e6e 616e  s((NR,)), np.nan
-00031ae0: 2a6e 702e 6f6e 6573 2828 4e52 2c29 290a  *np.ones((NR,)).
-00031af0: 2020 2020 4e52 5068 692c 204e 5250 6869      NRPhi, NRPhi
-00031b00: 3020 3d20 6e70 2e65 6d70 7479 2828 4e52  0 = np.empty((NR
-00031b10: 2c29 2c64 7479 7065 3d69 6e74 292c 206e  ,),dtype=int), n
-00031b20: 702e 656d 7074 7928 284e 522b 312c 292c  p.empty((NR+1,),
-00031b30: 6474 7970 653d 696e 7429 0a20 2020 2072  dtype=int).    r
-00031b40: 6164 6975 735f 7261 7469 6f20 3d20 696e  adius_ratio = in
-00031b50: 7428 635f 6365 696c 2852 5b4e 522d 315d  t(c_ceil(R[NR-1]
-00031b60: 2f52 5b30 5d29 290a 2020 2020 666f 7220  /R[0])).    for 
-00031b70: 6969 2069 6e20 7261 6e67 6528 302c 4e52  ii in range(0,NR
-00031b80: 293a 0a20 2020 2020 2020 204e 5250 6869  ):.        NRPhi
-00031b90: 5b69 695d 203d 203c 6c6f 6e67 3e28 635f  [ii] = <long>(c_
-00031ba0: 6365 696c 2832 2e2a 635f 7069 2a52 5b69  ceil(2.*c_pi*R[i
-00031bb0: 695d 2f64 5250 6869 2929 0a20 2020 2020  i]/dRPhi)).     
-00031bc0: 2020 2064 5250 6869 7252 6566 5b69 695d     dRPhirRef[ii]
-00031bd0: 203d 2032 2e2a 635f 7069 2a52 5b69 695d   = 2.*c_pi*R[ii]
-00031be0: 2f3c 646f 7562 6c65 3e28 4e52 5068 695b  /<double>(NRPhi[
-00031bf0: 6969 5d29 0a20 2020 2020 2020 2064 5068  ii]).        dPh
-00031c00: 6972 5b69 695d 203d 2032 2e2a 635f 7069  ir[ii] = 2.*c_pi
-00031c10: 2f3c 646f 7562 6c65 3e28 4e52 5068 695b  /<double>(NRPhi[
-00031c20: 6969 5d29 0a20 2020 2020 2020 2069 6620  ii]).        if 
-00031c30: 6969 3d3d 303a 0a20 2020 2020 2020 2020  ii==0:.         
-00031c40: 2020 204e 5250 6869 305b 6969 5d20 3d20     NRPhi0[ii] = 
-00031c50: 300a 2020 2020 2020 2020 2020 2020 5068  0.            Ph
-00031c60: 6920 3d20 6e70 2e65 6d70 7479 2828 4e52  i = np.empty((NR
-00031c70: 2c4e 5250 6869 5b69 695d 2a72 6164 6975  ,NRPhi[ii]*radiu
-00031c80: 735f 7261 7469 6f2b 3129 290a 2020 2020  s_ratio+1)).    
-00031c90: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00031ca0: 2020 2020 2020 4e52 5068 6930 5b69 695d        NRPhi0[ii]
-00031cb0: 203d 204e 5250 6869 305b 6969 2d31 5d20   = NRPhi0[ii-1] 
-00031cc0: 2b20 4e52 5068 695b 6969 2d31 5d2a 4e5a  + NRPhi[ii-1]*NZ
-00031cd0: 0a20 2020 2020 2020 2066 6f72 206a 6a20  .        for jj 
-00031ce0: 696e 2072 616e 6765 2830 2c4e 5250 6869  in range(0,NRPhi
-00031cf0: 5b69 695d 293a 0a20 2020 2020 2020 2020  [ii]):.         
-00031d00: 2020 2050 6869 5b69 692c 6a6a 5d20 3d20     Phi[ii,jj] = 
-00031d10: 2d63 5f70 6920 2b20 2830 2e35 2b3c 646f  -c_pi + (0.5+<do
-00031d20: 7562 6c65 3e6a 6a29 2a64 5068 6972 5b69  uble>jj)*dPhir[i
-00031d30: 695d 0a0a 2020 2020 6966 204f 7574 2e6c  i]..    if Out.l
-00031d40: 6f77 6572 2829 3d3d 2728 782c 792c 7a29  ower()=='(x,y,z)
-00031d50: 273a 0a20 2020 2020 2020 2066 6f72 2069  ':.        for i
-00031d60: 6920 696e 2072 616e 6765 2830 2c4e 5029  i in range(0,NP)
-00031d70: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
-00031d80: 7220 6a6a 2069 6e20 7261 6e67 6528 302c  r jj in range(0,
-00031d90: 4e52 2b31 293a 0a20 2020 2020 2020 2020  NR+1):.         
-00031da0: 2020 2020 2020 2069 6620 696e 645b 6969         if ind[ii
-00031db0: 5d2d 4e52 5068 6930 5b6a 6a5d 3c30 2e3a  ]-NRPhi0[jj]<0.:
-00031dc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00031dd0: 2020 2020 2062 7265 616b 0a20 2020 2020       break.     
-00031de0: 2020 2020 2020 2069 6952 203d 206a 6a2d         iiR = jj-
-00031df0: 310a 2020 2020 2020 2020 2020 2020 6969  1.            ii
-00031e00: 5a20 3d20 2869 6e64 5b69 695d 202d 204e  Z = (ind[ii] - N
-00031e10: 5250 6869 305b 6969 525d 292f 2f4e 5250  RPhi0[iiR])//NRP
-00031e20: 6869 5b69 6952 5d0a 2020 2020 2020 2020  hi[iiR].        
-00031e30: 2020 2020 6969 7068 6920 3d20 696e 645b      iiphi = ind[
-00031e40: 6969 5d20 2d20 4e52 5068 6930 5b69 6952  ii] - NRPhi0[iiR
-00031e50: 5d20 2d20 6969 5a2a 4e52 5068 695b 6969  ] - iiZ*NRPhi[ii
-00031e60: 525d 0a20 2020 2020 2020 2020 2020 2070  R].            p
-00031e70: 6869 203d 2050 6869 5b69 6952 2c69 6970  hi = Phi[iiR,iip
-00031e80: 6869 5d0a 2020 2020 2020 2020 2020 2020  hi].            
-00031e90: 5074 735b 302c 6969 5d20 3d20 525b 6969  Pts[0,ii] = R[ii
-00031ea0: 525d 2a63 5f63 6f73 2870 6869 290a 2020  R]*c_cos(phi).  
-00031eb0: 2020 2020 2020 2020 2020 5074 735b 312c            Pts[1,
-00031ec0: 6969 5d20 3d20 525b 6969 525d 2a63 5f73  ii] = R[iiR]*c_s
-00031ed0: 696e 2870 6869 290a 2020 2020 2020 2020  in(phi).        
-00031ee0: 2020 2020 5074 735b 322c 6969 5d20 3d20      Pts[2,ii] = 
-00031ef0: 5a5b 6969 5a5d 0a20 2020 2020 2020 2020  Z[iiZ].         
-00031f00: 2020 2064 565b 6969 5d20 3d20 7265 736f     dV[ii] = reso
-00031f10: 5f72 2a72 6573 6f5f 7a2a 6452 5068 6972  _r*reso_z*dRPhir
-00031f20: 5265 665b 6969 525d 0a20 2020 2020 2020  Ref[iiR].       
-00031f30: 2020 2020 2069 6620 5275 5b69 6952 5d3d       if Ru[iiR]=
-00031f40: 3d30 2e3a 0a20 2020 2020 2020 2020 2020  =0.:.           
-00031f50: 2020 2020 2064 5250 6869 725b 6969 525d       dRPhir[iiR]
-00031f60: 203d 2064 5250 6869 7252 6566 5b69 6952   = dRPhirRef[iiR
-00031f70: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00031f80: 2020 5275 5b69 6952 5d20 3d20 312e 0a20    Ru[iiR] = 1.. 
-00031f90: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00031fa0: 2066 6f72 2069 6920 696e 2072 616e 6765   for ii in range
-00031fb0: 2830 2c4e 5029 3a0a 2020 2020 2020 2020  (0,NP):.        
-00031fc0: 2020 2020 666f 7220 6a6a 2069 6e20 7261      for jj in ra
-00031fd0: 6e67 6528 302c 4e52 2b31 293a 0a20 2020  nge(0,NR+1):.   
-00031fe0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00031ff0: 696e 645b 6969 5d2d 4e52 5068 6930 5b6a  ind[ii]-NRPhi0[j
-00032000: 6a5d 3c30 2e3a 0a20 2020 2020 2020 2020  j]<0.:.         
-00032010: 2020 2020 2020 2020 2020 2062 7265 616b             break
-00032020: 0a20 2020 2020 2020 2020 2020 2069 6952  .            iiR
-00032030: 203d 206a 6a2d 310a 2020 2020 2020 2020   = jj-1.        
-00032040: 2020 2020 6969 5a20 3d20 2869 6e64 5b69      iiZ = (ind[i
-00032050: 695d 202d 204e 5250 6869 305b 6969 525d  i] - NRPhi0[iiR]
-00032060: 292f 2f4e 5250 6869 5b69 6952 5d0a 2020  )//NRPhi[iiR].  
-00032070: 2020 2020 2020 2020 2020 6969 7068 6920            iiphi 
-00032080: 3d20 696e 645b 6969 5d20 2d20 4e52 5068  = ind[ii] - NRPh
-00032090: 6930 5b69 6952 5d20 2d20 6969 5a2a 4e52  i0[iiR] - iiZ*NR
-000320a0: 5068 695b 6969 525d 0a20 2020 2020 2020  Phi[iiR].       
-000320b0: 2020 2020 2050 7473 5b30 2c69 695d 203d       Pts[0,ii] =
-000320c0: 2052 5b69 6952 5d0a 2020 2020 2020 2020   R[iiR].        
-000320d0: 2020 2020 5074 735b 312c 6969 5d20 3d20      Pts[1,ii] = 
-000320e0: 5a5b 6969 5a5d 0a20 2020 2020 2020 2020  Z[iiZ].         
-000320f0: 2020 2050 7473 5b32 2c69 695d 203d 2050     Pts[2,ii] = P
-00032100: 6869 5b69 6952 2c69 6970 6869 5d0a 2020  hi[iiR,iiphi].  
-00032110: 2020 2020 2020 2020 2020 6456 5b69 695d            dV[ii]
-00032120: 203d 2072 6573 6f5f 722a 7265 736f 5f7a   = reso_r*reso_z
-00032130: 2a64 5250 6869 7252 6566 5b69 6952 5d0a  *dRPhirRef[iiR].
-00032140: 2020 2020 2020 2020 2020 2020 6966 2052              if R
-00032150: 755b 6969 525d 3d3d 302e 3a0a 2020 2020  u[iiR]==0.:.    
-00032160: 2020 2020 2020 2020 2020 2020 6452 5068              dRPh
-00032170: 6972 5b69 6952 5d20 3d20 6452 5068 6972  ir[iiR] = dRPhir
-00032180: 5265 665b 6969 525d 0a20 2020 2020 2020  Ref[iiR].       
-00032190: 2020 2020 2020 2020 2052 755b 6969 525d           Ru[iiR]
-000321a0: 203d 2031 2e0a 2020 2020 7265 7475 726e   = 1..    return
-000321b0: 2050 7473 2c20 6456 2c20 7265 736f 5f72   Pts, dV, reso_r
-000321c0: 2c20 7265 736f 5f7a 2c20 6e70 2e61 7361  , reso_z, np.asa
-000321d0: 7272 6179 2864 5250 6869 7229 5b7e 6e70  rray(dRPhir)[~np
-000321e0: 2e69 736e 616e 2864 5250 6869 7229 5d0a  .isnan(dRPhir)].
-000321f0: 0a0a 2320 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ..# ============
-00032200: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00032210: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00032220: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00032230: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00032240: 3d3d 0a23 0a23 2020 2020 2020 2020 2020  ==.#.#          
-00032250: 2020 2020 2020 2020 2020 2020 2053 6f6c               Sol
-00032260: 6964 2041 6e67 6c65 2043 6f6d 7075 7461  id Angle Computa
-00032270: 7469 6f6e 0a23 2020 2020 2020 2020 2020  tion.#          
-00032280: 2020 2020 2020 2020 2020 2020 2020 7375                su
-00032290: 6274 656e 6465 6420 6279 2061 2073 7068  btended by a sph
-000322a0: 6572 650a 230a 2320 3d3d 3d3d 3d3d 3d3d  ere.#.# ========
-000322b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000322c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000322d0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000322e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000322f0: 3d3d 3d3d 3d3d 0a64 6566 2063 6f6d 7075  ======.def compu
-00032300: 7465 5f73 6f6c 6964 5f61 6e67 6c65 5f6d  te_solid_angle_m
-00032310: 6170 2864 6f75 626c 655b 3a2c 3a3a 315d  ap(double[:,::1]
-00032320: 2070 6172 745f 636f 6f72 6473 2c20 646f   part_coords, do
-00032330: 7562 6c65 5b3a 3a31 5d20 7061 7274 5f72  uble[::1] part_r
-00032340: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00032350: 2020 2020 2020 2020 2020 2020 2020 646f                do
-00032360: 7562 6c65 2072 7374 6570 2c20 646f 7562  uble rstep, doub
-00032370: 6c65 207a 7374 6570 2c20 646f 7562 6c65  le zstep, double
-00032380: 2070 6869 7374 6570 2c0a 2020 2020 2020   phistep,.      
-00032390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000323a0: 2020 2020 2020 646f 7562 6c65 5b3a 3a31        double[::1
-000323b0: 5d20 524d 696e 4d61 782c 2064 6f75 626c  ] RMinMax, doubl
-000323c0: 655b 3a3a 315d 205a 4d69 6e4d 6178 2c0a  e[::1] ZMinMax,.
-000323d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000323e0: 2020 2020 2020 2020 2020 2020 6269 6e74              bint
-000323f0: 2061 7070 726f 783d 5472 7565 2c0a 2020   approx=True,.  
+00031a20: 2020 2020 2020 206d 6172 6769 6e3d 6d61         margin=ma
+00031a30: 7267 696e 290a 2020 2020 5a2c 2072 6573  rgin).    Z, res
+00031a40: 6f5f 7a2c 2069 6e64 5a2c 204e 5a20 3d20  o_z, indZ, NZ = 
+00031a50: 6469 7363 7265 7469 7a65 5f6c 696e 6531  discretize_line1
+00031a60: 6428 5a4d 696e 4d61 782c 2064 5a2c 204e  d(ZMinMax, dZ, N
+00031a70: 6f6e 652c 204c 696d 3d54 7275 652c 0a20  one, Lim=True,. 
+00031a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031aa0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00031ab0: 6172 6769 6e3d 6d61 7267 696e 290a 2020  argin=margin).  
+00031ac0: 2020 526e 2c20 5a6e 203d 206c 656e 2852    Rn, Zn = len(R
+00031ad0: 292c 206c 656e 285a 290a 0a20 2020 2023  ), len(Z)..    #
+00031ae0: 204e 756d 6265 7220 6f66 2050 6869 2070   Number of Phi p
+00031af0: 6572 2052 0a20 2020 2064 5250 6869 7252  er R.    dRPhirR
+00031b00: 6566 2c20 6450 6869 7220 3d20 6e70 2e65  ef, dPhir = np.e
+00031b10: 6d70 7479 2828 4e52 2c29 292c 206e 702e  mpty((NR,)), np.
+00031b20: 656d 7074 7928 284e 522c 2929 0a20 2020  empty((NR,)).   
+00031b30: 2052 752c 2064 5250 6869 7220 3d20 6e70   Ru, dRPhir = np
+00031b40: 2e7a 6572 6f73 2828 4e52 2c29 292c 206e  .zeros((NR,)), n
+00031b50: 702e 6e61 6e2a 6e70 2e6f 6e65 7328 284e  p.nan*np.ones((N
+00031b60: 522c 2929 0a20 2020 204e 5250 6869 2c20  R,)).    NRPhi, 
+00031b70: 4e52 5068 6930 203d 206e 702e 656d 7074  NRPhi0 = np.empt
+00031b80: 7928 284e 522c 292c 6474 7970 653d 696e  y((NR,),dtype=in
+00031b90: 7429 2c20 6e70 2e65 6d70 7479 2828 4e52  t), np.empty((NR
+00031ba0: 2b31 2c29 2c64 7479 7065 3d69 6e74 290a  +1,),dtype=int).
+00031bb0: 2020 2020 7261 6469 7573 5f72 6174 696f      radius_ratio
+00031bc0: 203d 2069 6e74 2863 5f63 6569 6c28 525b   = int(c_ceil(R[
+00031bd0: 4e52 2d31 5d2f 525b 305d 2929 0a20 2020  NR-1]/R[0])).   
+00031be0: 2066 6f72 2069 6920 696e 2072 616e 6765   for ii in range
+00031bf0: 2830 2c4e 5229 3a0a 2020 2020 2020 2020  (0,NR):.        
+00031c00: 4e52 5068 695b 6969 5d20 3d20 3c6c 6f6e  NRPhi[ii] = <lon
+00031c10: 673e 2863 5f63 6569 6c28 322e 2a63 5f70  g>(c_ceil(2.*c_p
+00031c20: 692a 525b 6969 5d2f 6452 5068 6929 290a  i*R[ii]/dRPhi)).
+00031c30: 2020 2020 2020 2020 6452 5068 6972 5265          dRPhirRe
+00031c40: 665b 6969 5d20 3d20 322e 2a63 5f70 692a  f[ii] = 2.*c_pi*
+00031c50: 525b 6969 5d2f 3c64 6f75 626c 653e 284e  R[ii]/<double>(N
+00031c60: 5250 6869 5b69 695d 290a 2020 2020 2020  RPhi[ii]).      
+00031c70: 2020 6450 6869 725b 6969 5d20 3d20 322e    dPhir[ii] = 2.
+00031c80: 2a63 5f70 692f 3c64 6f75 626c 653e 284e  *c_pi/<double>(N
+00031c90: 5250 6869 5b69 695d 290a 2020 2020 2020  RPhi[ii]).      
+00031ca0: 2020 6966 2069 693d 3d30 3a0a 2020 2020    if ii==0:.    
+00031cb0: 2020 2020 2020 2020 4e52 5068 6930 5b69          NRPhi0[i
+00031cc0: 695d 203d 2030 0a20 2020 2020 2020 2020  i] = 0.         
+00031cd0: 2020 2050 6869 203d 206e 702e 656d 7074     Phi = np.empt
+00031ce0: 7928 284e 522c 4e52 5068 695b 6969 5d2a  y((NR,NRPhi[ii]*
+00031cf0: 7261 6469 7573 5f72 6174 696f 2b31 2929  radius_ratio+1))
+00031d00: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00031d10: 2020 2020 2020 2020 2020 204e 5250 6869             NRPhi
+00031d20: 305b 6969 5d20 3d20 4e52 5068 6930 5b69  0[ii] = NRPhi0[i
+00031d30: 692d 315d 202b 204e 5250 6869 5b69 692d  i-1] + NRPhi[ii-
+00031d40: 315d 2a4e 5a0a 2020 2020 2020 2020 666f  1]*NZ.        fo
+00031d50: 7220 6a6a 2069 6e20 7261 6e67 6528 302c  r jj in range(0,
+00031d60: 4e52 5068 695b 6969 5d29 3a0a 2020 2020  NRPhi[ii]):.    
+00031d70: 2020 2020 2020 2020 5068 695b 6969 2c6a          Phi[ii,j
+00031d80: 6a5d 203d 202d 635f 7069 202b 2028 302e  j] = -c_pi + (0.
+00031d90: 352b 3c64 6f75 626c 653e 6a6a 292a 6450  5+<double>jj)*dP
+00031da0: 6869 725b 6969 5d0a 0a20 2020 2069 6620  hir[ii]..    if 
+00031db0: 4f75 742e 6c6f 7765 7228 293d 3d27 2878  Out.lower()=='(x
+00031dc0: 2c79 2c7a 2927 3a0a 2020 2020 2020 2020  ,y,z)':.        
+00031dd0: 666f 7220 6969 2069 6e20 7261 6e67 6528  for ii in range(
+00031de0: 302c 4e50 293a 0a20 2020 2020 2020 2020  0,NP):.         
+00031df0: 2020 2066 6f72 206a 6a20 696e 2072 616e     for jj in ran
+00031e00: 6765 2830 2c4e 522b 3129 3a0a 2020 2020  ge(0,NR+1):.    
+00031e10: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+00031e20: 6e64 5b69 695d 2d4e 5250 6869 305b 6a6a  nd[ii]-NRPhi0[jj
+00031e30: 5d3c 302e 3a0a 2020 2020 2020 2020 2020  ]<0.:.          
+00031e40: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
+00031e50: 2020 2020 2020 2020 2020 2020 6969 5220              iiR 
+00031e60: 3d20 6a6a 2d31 0a20 2020 2020 2020 2020  = jj-1.         
+00031e70: 2020 2069 695a 203d 2028 696e 645b 6969     iiZ = (ind[ii
+00031e80: 5d20 2d20 4e52 5068 6930 5b69 6952 5d29  ] - NRPhi0[iiR])
+00031e90: 2f2f 4e52 5068 695b 6969 525d 0a20 2020  //NRPhi[iiR].   
+00031ea0: 2020 2020 2020 2020 2069 6970 6869 203d           iiphi =
+00031eb0: 2069 6e64 5b69 695d 202d 204e 5250 6869   ind[ii] - NRPhi
+00031ec0: 305b 6969 525d 202d 2069 695a 2a4e 5250  0[iiR] - iiZ*NRP
+00031ed0: 6869 5b69 6952 5d0a 2020 2020 2020 2020  hi[iiR].        
+00031ee0: 2020 2020 7068 6920 3d20 5068 695b 6969      phi = Phi[ii
+00031ef0: 522c 6969 7068 695d 0a20 2020 2020 2020  R,iiphi].       
+00031f00: 2020 2020 2050 7473 5b30 2c69 695d 203d       Pts[0,ii] =
+00031f10: 2052 5b69 6952 5d2a 635f 636f 7328 7068   R[iiR]*c_cos(ph
+00031f20: 6929 0a20 2020 2020 2020 2020 2020 2050  i).            P
+00031f30: 7473 5b31 2c69 695d 203d 2052 5b69 6952  ts[1,ii] = R[iiR
+00031f40: 5d2a 635f 7369 6e28 7068 6929 0a20 2020  ]*c_sin(phi).   
+00031f50: 2020 2020 2020 2020 2050 7473 5b32 2c69           Pts[2,i
+00031f60: 695d 203d 205a 5b69 695a 5d0a 2020 2020  i] = Z[iiZ].    
+00031f70: 2020 2020 2020 2020 6456 5b69 695d 203d          dV[ii] =
+00031f80: 2072 6573 6f5f 722a 7265 736f 5f7a 2a64   reso_r*reso_z*d
+00031f90: 5250 6869 7252 6566 5b69 6952 5d0a 2020  RPhirRef[iiR].  
+00031fa0: 2020 2020 2020 2020 2020 6966 2052 755b            if Ru[
+00031fb0: 6969 525d 3d3d 302e 3a0a 2020 2020 2020  iiR]==0.:.      
+00031fc0: 2020 2020 2020 2020 2020 6452 5068 6972            dRPhir
+00031fd0: 5b69 6952 5d20 3d20 6452 5068 6972 5265  [iiR] = dRPhirRe
+00031fe0: 665b 6969 525d 0a20 2020 2020 2020 2020  f[iiR].         
+00031ff0: 2020 2020 2020 2052 755b 6969 525d 203d         Ru[iiR] =
+00032000: 2031 2e0a 2020 2020 656c 7365 3a0a 2020   1..    else:.  
+00032010: 2020 2020 2020 666f 7220 6969 2069 6e20        for ii in 
+00032020: 7261 6e67 6528 302c 4e50 293a 0a20 2020  range(0,NP):.   
+00032030: 2020 2020 2020 2020 2066 6f72 206a 6a20           for jj 
+00032040: 696e 2072 616e 6765 2830 2c4e 522b 3129  in range(0,NR+1)
+00032050: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00032060: 2020 6966 2069 6e64 5b69 695d 2d4e 5250    if ind[ii]-NRP
+00032070: 6869 305b 6a6a 5d3c 302e 3a0a 2020 2020  hi0[jj]<0.:.    
+00032080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032090: 6272 6561 6b0a 2020 2020 2020 2020 2020  break.          
+000320a0: 2020 6969 5220 3d20 6a6a 2d31 0a20 2020    iiR = jj-1.   
+000320b0: 2020 2020 2020 2020 2069 695a 203d 2028           iiZ = (
+000320c0: 696e 645b 6969 5d20 2d20 4e52 5068 6930  ind[ii] - NRPhi0
+000320d0: 5b69 6952 5d29 2f2f 4e52 5068 695b 6969  [iiR])//NRPhi[ii
+000320e0: 525d 0a20 2020 2020 2020 2020 2020 2069  R].            i
+000320f0: 6970 6869 203d 2069 6e64 5b69 695d 202d  iphi = ind[ii] -
+00032100: 204e 5250 6869 305b 6969 525d 202d 2069   NRPhi0[iiR] - i
+00032110: 695a 2a4e 5250 6869 5b69 6952 5d0a 2020  iZ*NRPhi[iiR].  
+00032120: 2020 2020 2020 2020 2020 5074 735b 302c            Pts[0,
+00032130: 6969 5d20 3d20 525b 6969 525d 0a20 2020  ii] = R[iiR].   
+00032140: 2020 2020 2020 2020 2050 7473 5b31 2c69           Pts[1,i
+00032150: 695d 203d 205a 5b69 695a 5d0a 2020 2020  i] = Z[iiZ].    
+00032160: 2020 2020 2020 2020 5074 735b 322c 6969          Pts[2,ii
+00032170: 5d20 3d20 5068 695b 6969 522c 6969 7068  ] = Phi[iiR,iiph
+00032180: 695d 0a20 2020 2020 2020 2020 2020 2064  i].            d
+00032190: 565b 6969 5d20 3d20 7265 736f 5f72 2a72  V[ii] = reso_r*r
+000321a0: 6573 6f5f 7a2a 6452 5068 6972 5265 665b  eso_z*dRPhirRef[
+000321b0: 6969 525d 0a20 2020 2020 2020 2020 2020  iiR].           
+000321c0: 2069 6620 5275 5b69 6952 5d3d 3d30 2e3a   if Ru[iiR]==0.:
+000321d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000321e0: 2064 5250 6869 725b 6969 525d 203d 2064   dRPhir[iiR] = d
+000321f0: 5250 6869 7252 6566 5b69 6952 5d0a 2020  RPhirRef[iiR].  
+00032200: 2020 2020 2020 2020 2020 2020 2020 5275                Ru
+00032210: 5b69 6952 5d20 3d20 312e 0a20 2020 2072  [iiR] = 1..    r
+00032220: 6574 7572 6e20 5074 732c 2064 562c 2072  eturn Pts, dV, r
+00032230: 6573 6f5f 722c 2072 6573 6f5f 7a2c 206e  eso_r, reso_z, n
+00032240: 702e 6173 6172 7261 7928 6452 5068 6972  p.asarray(dRPhir
+00032250: 295b 7e6e 702e 6973 6e61 6e28 6452 5068  )[~np.isnan(dRPh
+00032260: 6972 295d 0a0a 0a23 203d 3d3d 3d3d 3d3d  ir)]...# =======
+00032270: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00032280: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00032290: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000322a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000322b0: 3d3d 3d3d 3d3d 3d0a 230a 2320 2020 2020  =======.#.#     
+000322c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000322d0: 2020 536f 6c69 6420 416e 676c 6520 436f    Solid Angle Co
+000322e0: 6d70 7574 6174 696f 6e0a 2320 2020 2020  mputation.#     
+000322f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032300: 2020 2073 7562 7465 6e64 6564 2062 7920     subtended by 
+00032310: 6120 7370 6865 7265 0a23 0a23 203d 3d3d  a sphere.#.# ===
+00032320: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00032330: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00032340: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00032350: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00032360: 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 6465 6620  ===========.def 
+00032370: 636f 6d70 7574 655f 736f 6c69 645f 616e  compute_solid_an
+00032380: 676c 655f 6d61 7028 646f 7562 6c65 5b3a  gle_map(double[:
+00032390: 2c3a 3a31 5d20 7061 7274 5f63 6f6f 7264  ,::1] part_coord
+000323a0: 732c 2064 6f75 626c 655b 3a3a 315d 2070  s, double[::1] p
+000323b0: 6172 745f 722c 0a20 2020 2020 2020 2020  art_r,.         
+000323c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000323d0: 2020 2064 6f75 626c 6520 7273 7465 702c     double rstep,
+000323e0: 2064 6f75 626c 6520 7a73 7465 702c 2064   double zstep, d
+000323f0: 6f75 626c 6520 7068 6973 7465 702c 0a20  ouble phistep,. 
 00032400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032410: 2020 2020 2020 2020 2020 6c69 7374 2044            list D
-00032420: 523d 4e6f 6e65 2c20 6c69 7374 2044 5a3d  R=None, list DZ=
-00032430: 4e6f 6e65 2c20 4450 6869 3d4e 6f6e 652c  None, DPhi=None,
-00032440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00032450: 2020 2020 2020 2020 2020 2020 2064 6f75               dou
-00032460: 626c 655b 3a2c 3a3a 315d 206c 696d 6974  ble[:,::1] limit
-00032470: 5f76 706f 6c79 3d4e 6f6e 652c 0a20 2020  _vpoly=None,.   
-00032480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032490: 2020 2020 2020 2020 2062 696e 7420 626c           bint bl
-000324a0: 6f63 6b3d 4661 6c73 652c 0a20 2020 2020  ock=False,.     
-000324b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000324c0: 2020 2020 2020 2064 6f75 626c 655b 3a2c         double[:,
-000324d0: 203a 3a31 5d20 7665 735f 706f 6c79 3d4e   ::1] ves_poly=N
-000324e0: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
-000324f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032500: 2064 6f75 626c 655b 3a2c 203a 3a31 5d20   double[:, ::1] 
-00032510: 7665 735f 6e6f 726d 3d4e 6f6e 652c 0a20  ves_norm=None,. 
+00032410: 2020 2020 2020 2020 2020 2064 6f75 626c             doubl
+00032420: 655b 3a3a 315d 2052 4d69 6e4d 6178 2c20  e[::1] RMinMax, 
+00032430: 646f 7562 6c65 5b3a 3a31 5d20 5a4d 696e  double[::1] ZMin
+00032440: 4d61 782c 0a20 2020 2020 2020 2020 2020  Max,.           
+00032450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032460: 2062 696e 7420 6170 7072 6f78 3d54 7275   bint approx=Tru
+00032470: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00032480: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00032490: 6973 7420 4452 3d4e 6f6e 652c 206c 6973  ist DR=None, lis
+000324a0: 7420 445a 3d4e 6f6e 652c 2044 5068 693d  t DZ=None, DPhi=
+000324b0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+000324c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000324d0: 2020 646f 7562 6c65 5b3a 2c3a 3a31 5d20    double[:,::1] 
+000324e0: 6c69 6d69 745f 7670 6f6c 793d 4e6f 6e65  limit_vpoly=None
+000324f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00032500: 2020 2020 2020 2020 2020 2020 2020 6269                bi
+00032510: 6e74 2062 6c6f 636b 3d46 616c 7365 2c0a  nt block=False,.
 00032520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032530: 2020 2020 2020 2020 2020 2064 6f75 626c             doubl
-00032540: 655b 3a3a 315d 2076 6573 5f6c 696d 733d  e[::1] ves_lims=
-00032550: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+00032530: 2020 2020 2020 2020 2020 2020 646f 7562              doub
+00032540: 6c65 5b3a 2c20 3a3a 315d 2076 6573 5f70  le[:, ::1] ves_p
+00032550: 6f6c 793d 4e6f 6e65 2c0a 2020 2020 2020  oly=None,.      
 00032560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032570: 2020 6c6f 6e67 5b3a 3a31 5d20 6c73 7472    long[::1] lstr
-00032580: 7563 745f 6e6c 696d 3d4e 6f6e 652c 0a20  uct_nlim=None,. 
-00032590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000325a0: 2020 2020 2020 2020 2020 2064 6f75 626c             doubl
-000325b0: 655b 3a3a 315d 206c 7374 7275 6374 5f70  e[::1] lstruct_p
-000325c0: 6f6c 7978 3d4e 6f6e 652c 0a20 2020 2020  olyx=None,.     
+00032570: 2020 2020 2020 646f 7562 6c65 5b3a 2c20        double[:, 
+00032580: 3a3a 315d 2076 6573 5f6e 6f72 6d3d 4e6f  ::1] ves_norm=No
+00032590: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+000325a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000325b0: 646f 7562 6c65 5b3a 3a31 5d20 7665 735f  double[::1] ves_
+000325c0: 6c69 6d73 3d4e 6f6e 652c 0a20 2020 2020  lims=None,.     
 000325d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000325e0: 2020 2020 2020 2064 6f75 626c 655b 3a3a         double[::
-000325f0: 315d 206c 7374 7275 6374 5f70 6f6c 7979  1] lstruct_polyy
-00032600: 3d4e 6f6e 652c 0a20 2020 2020 2020 2020  =None,.         
+000325e0: 2020 2020 2020 206c 6f6e 675b 3a3a 315d         long[::1]
+000325f0: 206c 7374 7275 6374 5f6e 6c69 6d3d 4e6f   lstruct_nlim=No
+00032600: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
 00032610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032620: 2020 206c 6973 7420 6c73 7472 7563 745f     list lstruct_
-00032630: 6c69 6d73 3d4e 6f6e 652c 0a20 2020 2020  lims=None,.     
+00032620: 646f 7562 6c65 5b3a 3a31 5d20 6c73 7472  double[::1] lstr
+00032630: 7563 745f 706f 6c79 783d 4e6f 6e65 2c0a  uct_polyx=None,.
 00032640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032650: 2020 2020 2020 2064 6f75 626c 655b 3a3a         double[::
-00032660: 315d 206c 7374 7275 6374 5f6e 6f72 6d78  1] lstruct_normx
-00032670: 3d4e 6f6e 652c 0a20 2020 2020 2020 2020  =None,.         
+00032650: 2020 2020 2020 2020 2020 2020 646f 7562              doub
+00032660: 6c65 5b3a 3a31 5d20 6c73 7472 7563 745f  le[::1] lstruct_
+00032670: 706f 6c79 793d 4e6f 6e65 2c0a 2020 2020  polyy=None,.    
 00032680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032690: 2020 2064 6f75 626c 655b 3a3a 315d 206c     double[::1] l
-000326a0: 7374 7275 6374 5f6e 6f72 6d79 3d4e 6f6e  struct_normy=Non
-000326b0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-000326c0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-000326d0: 6f6e 675b 3a3a 315d 206c 6e76 6572 743d  ong[::1] lnvert=
-000326e0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+00032690: 2020 2020 2020 2020 6c69 7374 206c 7374          list lst
+000326a0: 7275 6374 5f6c 696d 733d 4e6f 6e65 2c0a  ruct_lims=None,.
+000326b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000326c0: 2020 2020 2020 2020 2020 2020 646f 7562              doub
+000326d0: 6c65 5b3a 3a31 5d20 6c73 7472 7563 745f  le[::1] lstruct_
+000326e0: 6e6f 726d 783d 4e6f 6e65 2c0a 2020 2020  normx=None,.    
 000326f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032700: 2020 696e 7420 6e73 7472 7563 745f 746f    int nstruct_to
-00032710: 743d 302c 0a20 2020 2020 2020 2020 2020  t=0,.           
-00032720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032730: 2069 6e74 206e 7374 7275 6374 5f6c 696d   int nstruct_lim
-00032740: 3d30 2c0a 2020 2020 2020 2020 2020 2020  =0,.            
-00032750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032760: 646f 7562 6c65 2072 6d69 6e3d 2d31 2c20  double rmin=-1, 
-00032770: 6269 6e74 2066 6f72 6269 643d 5472 7565  bint forbid=True
-00032780: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00032790: 2020 2020 2020 2020 2020 2020 2020 646f                do
-000327a0: 7562 6c65 2065 7073 5f75 7a3d 5f53 4d41  uble eps_uz=_SMA
-000327b0: 4c4c 2c20 646f 7562 6c65 2065 7073 5f61  LL, double eps_a
-000327c0: 3d5f 5653 4d41 4c4c 2c0a 2020 2020 2020  =_VSMALL,.      
-000327d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000327e0: 2020 2020 2020 646f 7562 6c65 2065 7073        double eps
-000327f0: 5f76 7a3d 5f56 534d 414c 4c2c 2064 6f75  _vz=_VSMALL, dou
-00032800: 626c 6520 6570 735f 623d 5f56 534d 414c  ble eps_b=_VSMAL
-00032810: 4c2c 0a20 2020 2020 2020 2020 2020 2020  L,.             
-00032820: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00032830: 6f75 626c 6520 6570 735f 706c 616e 653d  ouble eps_plane=
-00032840: 5f56 534d 414c 4c2c 2073 7472 2076 6573  _VSMALL, str ves
-00032850: 5f74 7970 653d 2754 6f72 272c 0a20 2020  _type='Tor',.   
-00032860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032870: 2020 2020 2020 2020 2064 6f75 626c 6520           double 
-00032880: 6d61 7267 696e 3d5f 5653 4d41 4c4c 2c20  margin=_VSMALL, 
-00032890: 696e 7420 6e75 6d5f 7468 7265 6164 733d  int num_threads=
-000328a0: 3438 2c0a 2020 2020 2020 2020 2020 2020  48,.            
-000328b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000328c0: 6269 6e74 2074 6573 743d 5472 7565 293a  bint test=True):
-000328d0: 0a20 2020 2022 2222 0a20 2020 2043 6f6d  .    """.    Com
-000328e0: 7075 7465 7320 7468 6520 3244 206d 6170  putes the 2D map
-000328f0: 206f 6620 7468 6520 696e 7465 6772 6174   of the integrat
-00032900: 6564 2073 6f6c 6964 2061 6e67 6c65 7320  ed solid angles 
-00032910: 7375 6274 656e 6465 6420 6279 2065 6163  subtended by eac
-00032920: 6820 6f66 0a20 2020 2074 6865 2073 7a5f  h of.    the sz_
-00032930: 7020 7061 7274 6963 6c65 7320 5020 6f66  p particles P of
-00032940: 2072 6164 6975 7320 7061 7274 5f72 2061   radius part_r a
-00032950: 7420 7468 6520 706f 7369 7469 6f6e 2070  t the position p
-00032960: 6172 745f 636f 6f72 6473 0a20 2020 2069  art_coords.    i
-00032970: 6e20 7468 6520 7361 6d70 6c65 6420 766f  n the sampled vo
-00032980: 6c75 6d65 2e0a 2020 2020 4966 2061 7070  lume..    If app
-00032990: 726f 782c 2061 2038 7468 2064 6567 7265  rox, a 8th degre
-000329a0: 6520 6170 7072 6f78 696d 6174 696f 6e20  e approximation 
-000329b0: 7769 6c6c 2062 6520 7573 6564 2066 6f72  will be used for
-000329c0: 2074 6865 2063 6f6d 7075 7461 7469 6f6e   the computation
-000329d0: 0a20 2020 206f 6620 7468 6520 736f 6c69  .    of the soli
-000329e0: 6420 616e 676c 650a 0a20 2020 2050 6172  d angle..    Par
-000329f0: 616d 6574 6572 730a 2020 2020 2d2d 2d2d  ameters.    ----
-00032a00: 2d2d 2d2d 2d2d 0a20 2020 2070 6172 745f  ------.    part_
-00032a10: 636f 6f72 6473 3a20 2833 2c20 737a 5f70  coords: (3, sz_p
-00032a20: 2920 646f 7562 6c65 206d 656d 6f72 792d  ) double memory-
-00032a30: 7669 6577 0a09 2020 2020 6361 7274 6573  view..    cartes
-00032a40: 6961 6e20 636f 6f72 6469 6e61 7465 7320  ian coordinates 
-00032a50: 6f66 2050 2070 6172 7469 636c 6573 0a20  of P particles. 
-00032a60: 2020 2070 6172 745f 723a 2028 737a 5f70     part_r: (sz_p
-00032a70: 2920 646f 7562 6c65 206d 656d 6f72 792d  ) double memory-
-00032a80: 7669 6577 0a20 2020 2020 2020 2074 6865  view.        the
-00032a90: 2072 6164 6969 206f 6620 7468 6520 5020   radii of the P 
-00032aa0: 7061 7274 6963 6c65 730a 2020 2020 7273  particles.    rs
-00032ab0: 7465 703a 2064 6f75 626c 650a 2020 2020  tep: double.    
-00032ac0: 2020 2020 7265 6669 6e65 6d65 6e74 2061      refinement a
-00032ad0: 6c6f 6e67 2072 6164 6975 7320 6072 600a  long radius `r`.
-00032ae0: 2020 2020 7a73 7465 703a 2064 6f75 626c      zstep: doubl
-00032af0: 650a 2020 2020 2020 2020 7265 6669 6e65  e.        refine
-00032b00: 6d65 6e74 2061 6c6f 6e67 2068 6569 6768  ment along heigh
-00032b10: 7420 607a 600a 2020 2020 7068 6973 7465  t `z`.    phiste
-00032b20: 703a 2064 6f75 626c 650a 2020 2020 2020  p: double.      
-00032b30: 2020 7265 6669 6e65 6d65 6e74 2061 6c6f    refinement alo
-00032b40: 6e67 2074 6f72 6f69 6461 6c20 6469 7265  ng toroidal dire
-00032b50: 6374 696f 6e20 6070 6869 600a 2020 2020  ction `phi`.    
-00032b60: 6170 7072 6f78 3a20 626f 6f6c 0a20 2020  approx: bool.   
-00032b70: 2020 2020 2064 6f20 796f 7520 7761 6e74       do you want
-00032b80: 2074 6f20 7573 6520 6170 7072 6f78 696d   to use approxim
-00032b90: 6174 696f 6e20 2838 7468 206f 7264 6572  ation (8th order
-00032ba0: 2920 6f72 2065 7861 6374 2066 6f72 6d75  ) or exact formu
-00032bb0: 6c61 203f 0a20 2020 2020 2020 2064 6566  la ?.        def
-00032bc0: 6175 6c74 3a20 5472 7565 0a20 2020 2052  ault: True.    R
-00032bd0: 4d69 6e4d 6178 3a20 646f 7562 6c65 206d  MinMax: double m
-00032be0: 656d 6f72 792d 7669 6577 0a20 2020 2020  emory-view.     
-00032bf0: 2020 206c 696d 6974 7320 6d69 6e20 616e     limits min an
-00032c00: 6420 6d61 7820 696e 2060 7260 0a20 2020  d max in `r`.   
-00032c10: 205a 4d69 6e4d 6178 3a20 646f 7562 6c65   ZMinMax: double
-00032c20: 206d 656d 6f72 792d 7669 6577 0a20 2020   memory-view.   
-00032c30: 2020 2020 206c 696d 6974 7320 6d69 6e20       limits min 
-00032c40: 616e 6420 6d61 7820 696e 2060 7a60 0a20  and max in `z`. 
-00032c50: 2020 2044 523a 2064 6f75 626c 6520 6d65     DR: double me
-00032c60: 6d6f 7279 2d76 6965 772c 206f 7074 696f  mory-view, optio
-00032c70: 6e61 6c0a 2020 2020 2020 2020 6163 7475  nal.        actu
-00032c80: 616c 2073 7562 2d76 6f6c 756d 6520 6c69  al sub-volume li
-00032c90: 6d69 7473 2074 6f20 6765 7420 696e 2060  mits to get in `
-00032ca0: 7260 0a20 2020 2044 5a3a 2064 6f75 626c  r`.    DZ: doubl
-00032cb0: 6520 6d65 6d6f 7279 2d76 6965 772c 206f  e memory-view, o
-00032cc0: 7074 696f 6e61 6c0a 2020 2020 2020 2020  ptional.        
-00032cd0: 6163 7475 616c 2073 7562 2d76 6f6c 756d  actual sub-volum
-00032ce0: 6520 6c69 6d69 7473 2074 6f20 6765 7420  e limits to get 
-00032cf0: 696e 2060 7a60 0a20 2020 2044 5068 693a  in `z`.    DPhi:
-00032d00: 2064 6f75 626c 6520 6d65 6d6f 7279 2d76   double memory-v
-00032d10: 6965 772c 206f 7074 696f 6e61 6c0a 2020  iew, optional.  
-00032d20: 2020 2020 2020 6163 7475 616c 2073 7562        actual sub
-00032d30: 2d76 6f6c 756d 6520 6c69 6d69 7473 2074  -volume limits t
-00032d40: 6f20 6765 7420 696e 2060 7068 6960 0a20  o get in `phi`. 
-00032d50: 2020 206c 696d 6974 5f76 706f 6c79 3a20     limit_vpoly: 
-00032d60: 2833 2c20 6e70 7473 2920 646f 7562 6c65  (3, npts) double
-00032d70: 206d 656d 6f72 792d 7669 6577 2c20 6f70   memory-view, op
-00032d80: 7469 6f6e 616c 0a20 2020 2020 2020 2069  tional.        i
-00032d90: 6620 7765 206f 6e6c 7920 7761 6e74 2074  f we only want t
-00032da0: 6f20 6469 7363 7265 7469 7a65 2074 6865  o discretize the
-00032db0: 2076 6f6c 756d 6520 696e 7369 6465 2061   volume inside a
-00032dc0: 2063 6572 7461 696e 2066 6c75 7820 7375   certain flux su
-00032dd0: 7266 6163 652e 0a20 2020 2020 2020 2044  rface..        D
-00032de0: 6566 696e 6573 2074 6865 2060 2852 2c5a  efines the `(R,Z
-00032df0: 2960 2063 6f6f 7264 7320 6f66 2074 6865  )` coords of the
-00032e00: 2070 6f6c 6f69 6461 6c20 6375 7420 6f66   poloidal cut of
-00032e10: 2074 6865 206c 696d 6974 696e 6720 666c   the limiting fl
-00032e20: 7578 0a20 2020 2020 2020 2073 7572 6661  ux.        surfa
-00032e30: 6365 2e0a 2020 2020 626c 6f63 6b3a 2062  ce..    block: b
-00032e40: 6f6f 6c2c 206f 7074 696f 6e61 6c0a 2020  ool, optional.  
-00032e50: 2020 2020 2020 6368 6563 6b20 6966 2070        check if p
-00032e60: 6172 7469 636c 6573 2061 7265 2076 6965  articles are vie
-00032e70: 7761 626c 6520 6672 6f6d 2076 6965 7769  wable from viewi
-00032e80: 6e67 2070 6f69 6e74 7320 6f72 2069 6620  ng points or if 
-00032e90: 7468 6572 6520 6973 2061 0a20 2020 2020  there is a.     
-00032ea0: 2020 2073 7472 7563 7475 7261 6c20 656c     structural el
-00032eb0: 656d 656e 7420 626c 6f63 6b69 6e67 2076  ement blocking v
-00032ec0: 6973 6962 696c 6974 7920 2846 616c 7365  isibility (False
-00032ed0: 290a 2020 2020 7665 735f 706f 6c79 203a  ).    ves_poly :
-00032ee0: 2028 322c 206e 756d 5f76 6572 7465 7829   (2, num_vertex)
-00032ef0: 2064 6f75 626c 6520 6172 7261 790a 2020   double array.  
-00032f00: 2020 2020 2043 6f6f 7264 696e 6174 6573       Coordinates
-00032f10: 206f 6620 7468 6520 7665 7274 6963 6573   of the vertices
-00032f20: 206f 6620 7468 6520 506f 6c79 676f 6e20   of the Polygon 
-00032f30: 6465 6669 6e69 6e67 2074 6865 2032 4420  defining the 2D 
-00032f40: 706f 6c6f 6964 616c 0a20 2020 2020 2020  poloidal.       
-00032f50: 6375 7420 6f66 2074 6865 2056 6573 7365  cut of the Vesse
-00032f60: 6c0a 2020 2020 7665 735f 6e6f 726d 203a  l.    ves_norm :
-00032f70: 2028 322c 206e 756d 5f76 6572 7465 782d   (2, num_vertex-
-00032f80: 3129 2064 6f75 626c 6520 6172 7261 790a  1) double array.
-00032f90: 2020 2020 2020 204e 6f72 6d61 6c20 7665         Normal ve
-00032fa0: 6374 6f72 7320 676f 696e 6720 2269 6e77  ctors going "inw
-00032fb0: 6172 6473 2220 6f66 2074 6865 2065 6467  ards" of the edg
-00032fc0: 6573 206f 6620 7468 6520 506f 6c79 676f  es of the Polygo
-00032fd0: 6e20 6465 6669 6e65 640a 2020 2020 2020  n defined.      
-00032fe0: 2062 7920 7665 735f 706f 6c79 0a20 2020   by ves_poly.   
-00032ff0: 206e 7374 7275 6374 5f74 6f74 203a 2069   nstruct_tot : i
-00033000: 6e74 0a20 2020 2020 2020 546f 7461 6c20  nt.       Total 
-00033010: 6e75 6d62 6572 206f 6620 7374 7275 6374  number of struct
-00033020: 7572 6573 2028 636f 756e 7469 6e67 2065  ures (counting e
-00033030: 6163 6820 6c69 6d69 7465 6420 7374 7275  ach limited stru
-00033040: 6374 7572 6520 6173 206f 6e65 290a 2020  cture as one).  
-00033050: 2020 7665 735f 6c69 6d73 203a 2061 7272    ves_lims : arr
-00033060: 6179 0a20 2020 2020 2020 436f 6e74 6169  ay.       Contai
-00033070: 6e73 2074 6865 206c 696d 6974 7320 6d69  ns the limits mi
-00033080: 6e20 616e 6420 6d61 7820 6f66 2076 6573  n and max of ves
-00033090: 7365 6c0a 2020 2020 6c73 7472 7563 745f  sel.    lstruct_
-000330a0: 706f 6c79 7820 3a20 6172 7261 790a 2020  polyx : array.  
-000330b0: 2020 2020 204c 6973 7420 6f66 2078 2063       List of x c
-000330c0: 6f6f 7264 696e 6174 6573 206f 6620 7468  oordinates of th
-000330d0: 6520 7665 7274 6963 6573 206f 6620 616c  e vertices of al
-000330e0: 6c20 7374 7275 6374 7572 6573 206f 6e20  l structures on 
-000330f0: 706f 6c6f 6964 616c 2070 6c61 6e65 0a20  poloidal plane. 
-00033100: 2020 2020 2020 4966 206e 6f20 7374 7275        If no stru
-00033110: 6374 7572 6573 203a 204e 6f6e 650a 2020  ctures : None.  
-00033120: 2020 6c73 7472 7563 745f 706f 6c79 7920    lstruct_polyy 
-00033130: 3a20 6172 7261 790a 2020 2020 2020 204c  : array.       L
-00033140: 6973 7420 6f66 2079 2063 6f6f 7264 696e  ist of y coordin
-00033150: 6174 6573 206f 6620 7468 6520 7665 7274  ates of the vert
-00033160: 6963 6573 206f 6620 616c 6c20 7374 7275  ices of all stru
-00033170: 6374 7572 6573 206f 6e20 706f 6c6f 6964  ctures on poloid
-00033180: 616c 2070 6c61 6e65 0a20 2020 2020 2020  al plane.       
-00033190: 4966 206e 6f20 7374 7275 6374 7572 6573  If no structures
-000331a0: 203a 204e 6f6e 650a 2020 2020 6c73 7472   : None.    lstr
-000331b0: 7563 745f 6c69 6d73 203a 2061 7272 6179  uct_lims : array
-000331c0: 0a20 2020 2020 2020 4c69 7374 206f 6620  .       List of 
-000331d0: 6c69 6d69 7473 206f 6620 616c 6c20 7374  limits of all st
-000331e0: 7275 6374 7572 6573 0a20 2020 2020 2020  ructures.       
-000331f0: 4966 206e 6f20 7374 7275 6374 7572 6573  If no structures
-00033200: 203a 204e 6f6e 650a 2020 2020 6c73 7472   : None.    lstr
-00033210: 7563 745f 6e6c 696d 203a 2061 7272 6179  uct_nlim : array
-00033220: 206f 6620 696e 7473 0a20 2020 2020 2020   of ints.       
-00033230: 4c69 7374 206f 6620 6e75 6d62 6572 206f  List of number o
-00033240: 6620 6c69 6d69 7473 2066 6f72 2061 6c6c  f limits for all
-00033250: 2073 7472 7563 7475 7265 730a 2020 2020   structures.    
-00033260: 2020 2049 6620 6e6f 2073 7472 7563 7475     If no structu
-00033270: 7265 7320 3a20 4e6f 6e65 0a20 2020 206c  res : None.    l
-00033280: 7374 7275 6374 5f6e 6f72 6d78 203a 2064  struct_normx : d
-00033290: 6f75 626c 6520 6d65 6d6f 7279 2d76 6965  ouble memory-vie
-000332a0: 772c 206f 7074 696f 6e61 6c0a 2020 2020  w, optional.    
-000332b0: 2020 204c 6973 7420 6f66 2078 2d63 6f6f     List of x-coo
-000332c0: 7264 696e 6174 6573 206f 6620 2269 6e77  rdinates of "inw
-000332d0: 6172 6473 2220 6e6f 726d 616c 2076 6563  ards" normal vec
-000332e0: 746f 7273 206f 6620 7468 6520 706f 6c79  tors of the poly
-000332f0: 676f 6e20 6f66 2061 6c6c 0a20 2020 2020  gon of all.     
-00033300: 2020 7468 6520 7374 7275 6374 7572 6573    the structures
-00033310: 0a20 2020 2020 2020 4966 206e 6f20 7374  .       If no st
-00033320: 7275 6374 7572 6573 203a 204e 6f6e 650a  ructures : None.
-00033330: 2020 2020 6c73 7472 7563 745f 6e6f 726d      lstruct_norm
-00033340: 7920 3a20 646f 7562 6c65 206d 656d 6f72  y : double memor
-00033350: 792d 7669 6577 2c20 6f70 7469 6f6e 616c  y-view, optional
-00033360: 0a20 2020 2020 2020 4c69 7374 206f 6620  .       List of 
-00033370: 792d 636f 6f72 6469 6e61 7465 7320 6f66  y-coordinates of
-00033380: 2022 696e 7761 7264 7322 206e 6f72 6d61   "inwards" norma
-00033390: 6c20 7665 6374 6f72 7320 6f66 2074 6865  l vectors of the
-000333a0: 2070 6f6c 7967 6f6e 206f 6620 616c 6c0a   polygon of all.
-000333b0: 2020 2020 2020 2074 6865 2073 7472 7563         the struc
-000333c0: 7475 7265 730a 2020 2020 2020 2049 6620  tures.       If 
-000333d0: 6e6f 2073 7472 7563 7475 7265 7320 3a20  no structures : 
-000333e0: 4e6f 6e65 0a20 2020 2072 6d69 6e20 3a20  None.    rmin : 
-000333f0: 646f 7562 6c65 2c20 6f70 7469 6f6e 616c  double, optional
-00033400: 0a20 2020 2020 2020 4d69 6e69 6d61 6c20  .       Minimal 
-00033410: 7261 6469 7573 206f 6620 7665 7373 656c  radius of vessel
-00033420: 2074 6f20 7461 6b65 2069 6e74 6f20 636f   to take into co
-00033430: 6e73 6964 6572 6174 696f 6e0a 2020 2020  nsideration.    
-00033440: 666f 7262 6964 203a 2062 6f6f 6c2c 206f  forbid : bool, o
-00033450: 7074 696f 6e61 6c0a 2020 2020 2020 2053  ptional.       S
-00033460: 686f 756c 6420 7765 2066 6f72 6269 6420  hould we forbid 
-00033470: 7661 6c75 6573 2062 6568 696e 6420 7669  values behind vi
-00033480: 7369 626c 6520 7261 6469 7573 203f 2028  sible radius ? (
-00033490: 7365 6520 726d 696e 290a 2020 2020 6570  see rmin).    ep
-000334a0: 735f 3c76 616c 3e20 3a20 646f 7562 6c65  s_<val> : double
-000334b0: 2c20 6f70 7469 6f6e 616c 0a20 2020 2020  , optional.     
-000334c0: 2020 536d 616c 6c20 7661 6c75 652c 2061    Small value, a
-000334d0: 6363 6570 7461 6e63 6520 6f66 2065 7272  cceptance of err
-000334e0: 6f72 0a20 2020 206d 6172 6769 6e3a 2064  or.    margin: d
-000334f0: 6f75 626c 652c 206f 7074 696f 6e61 6c0a  ouble, optional.
-00033500: 2020 2020 2020 2020 746f 6c65 7261 6e63          toleranc
-00033510: 6520 6572 726f 722e 2044 6566 6175 6c74  e error. Default
-00033520: 7320 746f 207c 5f56 534d 414c 4c7c 0a20  s to |_VSMALL|. 
-00033530: 2020 206e 756d 5f74 6872 6561 6473 203a     num_threads :
-00033540: 2069 6e74 0a20 2020 2020 2020 5468 6520   int.       The 
-00033550: 6e75 6d5f 7468 7265 6164 7320 6172 6775  num_threads argu
-00033560: 6d65 6e74 2069 6e64 6963 6174 6573 2068  ment indicates h
-00033570: 6f77 206d 616e 7920 7468 7265 6164 7320  ow many threads 
-00033580: 7468 6520 7465 616d 2073 686f 756c 640a  the team should.
-00033590: 2020 2020 2020 2063 6f6e 7369 7374 206f         consist o
-000335a0: 662e 2049 6620 6e6f 7420 6769 7665 6e2c  f. If not given,
-000335b0: 204f 7065 6e4d 5020 7769 6c6c 2064 6563   OpenMP will dec
-000335c0: 6964 6520 686f 7720 6d61 6e79 2074 6872  ide how many thr
-000335d0: 6561 6473 2074 6f20 7573 652e 0a20 2020  eads to use..   
-000335e0: 2020 2020 5479 7069 6361 6c6c 7920 7468      Typically th
-000335f0: 6973 2069 7320 7468 6520 6e75 6d62 6572  is is the number
-00033600: 206f 6620 636f 7265 7320 6176 6169 6c61   of cores availa
-00033610: 626c 6520 6f6e 2074 6865 206d 6163 6869  ble on the machi
-00033620: 6e65 2e0a 2020 2020 7465 7374 203a 2062  ne..    test : b
-00033630: 6f6f 6c2c 206f 7074 696f 6e61 6c0a 2020  ool, optional.  
-00033640: 2020 2020 2053 686f 756c 6420 7765 2072       Should we r
-00033650: 756e 2074 6573 7473 3f20 4465 6661 756c  un tests? Defaul
-00033660: 7420 5472 7565 0a0a 2020 2020 5265 7475  t True..    Retu
-00033670: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
-00033680: 2020 2020 2020 2020 7074 733a 2020 2020          pts:    
-00033690: 2832 2c20 6e70 7473 2920 6172 7261 7920  (2, npts) array 
-000336a0: 6f66 2028 522c 205a 2920 636f 6f72 6469  of (R, Z) coordi
-000336b0: 6e61 7465 7320 6f66 2076 6965 7769 6e67  nates of viewing
-000336c0: 2070 6f69 6e74 7320 696e 0a20 2020 2020   points in.     
-000336d0: 2020 2020 2020 2020 2020 2076 6967 6e65             vigne
-000336e0: 7474 6520 7768 6572 6520 736f 6c69 6420  tte where solid 
-000336f0: 616e 676c 6520 6973 2069 6e74 6567 7261  angle is integra
-00033700: 7465 640a 2020 2020 2020 2020 7361 5f6d  ted.        sa_m
-00033710: 6170 3a20 286e 7074 732c 2073 7a5f 7029  ap: (npts, sz_p)
-00033720: 2061 7272 6179 2061 7070 726f 7820 736f   array approx so
-00033730: 6c69 6420 616e 676c 6520 696e 7465 6772  lid angle integr
-00033740: 6174 6564 2061 6c6f 6e67 2070 6869 0a20  ated along phi. 
-00033750: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00033760: 6e74 6567 7261 6c20 2873 6120 2a20 6470  ntegral (sa * dp
-00033770: 6869 202a 2072 290a 2020 2020 2020 2020  hi * r).        
-00033780: 696e 643a 2020 2020 286e 7074 7329 2069  ind:    (npts) i
-00033790: 6e64 6963 6573 2074 6f20 7265 636f 6e73  ndices to recons
-000337a0: 7472 7563 7420 2852 2c5a 2920 6d61 7020  truct (R,Z) map 
-000337b0: 6672 6f6d 2073 615f 6d61 700a 2020 2020  from sa_map.    
-000337c0: 2020 2020 7264 7264 7a3a 2020 286e 7074      rdrdz:  (npt
-000337d0: 7329 2076 6f6c 756d 6520 756e 6974 3a20  s) volume unit: 
-000337e0: 6472 2a64 7a0a 2020 2020 2222 220a 2020  dr*dz.    """.  
-000337f0: 2020 6364 6566 2069 6e74 206a 6a0a 2020    cdef int jj.  
-00033800: 2020 6364 6566 2069 6e74 2073 7a5f 700a    cdef int sz_p.
-00033810: 2020 2020 6364 6566 2069 6e74 2073 7a5f      cdef int sz_
-00033820: 720a 2020 2020 6364 6566 2069 6e74 2073  r.    cdef int s
-00033830: 7a5f 7a0a 2020 2020 6364 6566 2069 6e74  z_z.    cdef int
-00033840: 206e 7074 735f 706f 6c0a 2020 2020 6364   npts_pol.    cd
-00033850: 6566 2069 6e74 2072 5f72 6174 696f 0a20  ef int r_ratio. 
-00033860: 2020 2063 6465 6620 696e 7420 696e 645f     cdef int ind_
-00033870: 6c6f 635f 7230 0a20 2020 2063 6465 6620  loc_r0.    cdef 
-00033880: 696e 7420 6e70 7473 5f64 6973 6320 3d20  int npts_disc = 
-00033890: 300a 2020 2020 6364 6566 2069 6e74 5b31  0.    cdef int[1
-000338a0: 5d20 6d61 785f 737a 5f70 6869 0a20 2020  ] max_sz_phi.   
-000338b0: 2063 6465 6620 646f 7562 6c65 206d 696e   cdef double min
-000338c0: 5f70 6869 2c20 6d61 785f 7068 690a 2020  _phi, max_phi.  
-000338d0: 2020 6364 6566 2064 6f75 626c 6520 6d69    cdef double mi
-000338e0: 6e5f 7068 695f 7069 0a20 2020 2063 6465  n_phi_pi.    cde
-000338f0: 6620 646f 7562 6c65 206d 6178 5f70 6869  f double max_phi
-00033900: 5f70 690a 2020 2020 6364 6566 2064 6f75  _pi.    cdef dou
-00033910: 626c 6520 6162 7330 2c20 6162 7331 0a20  ble abs0, abs1. 
-00033920: 2020 2063 6465 6620 646f 7562 6c65 2072     cdef double r
-00033930: 6573 6f5f 725f 7a0a 2020 2020 6364 6566  eso_r_z.    cdef
-00033940: 2064 6f75 626c 6520 7477 6f70 695f 6f76   double twopi_ov
-00033950: 6572 5f64 7068 690a 2020 2020 6364 6566  er_dphi.    cdef
-00033960: 206c 6f6e 675b 315d 206e 6365 6c6c 735f   long[1] ncells_
-00033970: 7230 2c20 6e63 656c 6c73 5f72 2c20 6e63  r0, ncells_r, nc
-00033980: 656c 6c73 5f7a 0a20 2020 2063 6465 6620  ells_z.    cdef 
-00033990: 6c6f 6e67 5b3a 3a31 5d20 696e 645f 6d76  long[::1] ind_mv
-000339a0: 0a20 2020 2063 6465 6620 6c6f 6e67 5b3a  .    cdef long[:
-000339b0: 3a31 5d20 6669 7273 745f 696e 645f 6d76  :1] first_ind_mv
-000339c0: 0a20 2020 2063 6465 6620 646f 7562 6c65  .    cdef double
-000339d0: 5b32 5d20 6c69 6d69 7473 5f64 6c0a 2020  [2] limits_dl.  
-000339e0: 2020 6364 6566 2064 6f75 626c 655b 315d    cdef double[1]
-000339f0: 2072 6573 6f5f 7230 2c20 7265 736f 5f72   reso_r0, reso_r
-00033a00: 2c20 7265 736f 5f7a 0a20 2020 2063 6465  , reso_z.    cde
-00033a10: 6620 646f 7562 6c65 5b3a 3a31 5d20 7265  f double[::1] re
-00033a20: 736f 5f72 6472 647a 5f6d 760a 2020 2020  so_rdrdz_mv.    
-00033a30: 6364 6566 2064 6f75 626c 655b 3a3a 315d  cdef double[::1]
-00033a40: 206c 7374 7275 6374 5f6c 696d 735f 6e70   lstruct_lims_np
-00033a50: 0a20 2020 2063 6465 6620 646f 7562 6c65  .    cdef double
-00033a60: 5b3a 2c20 3a3a 315d 2070 6f6c 795f 6d76  [:, ::1] poly_mv
-00033a70: 0a20 2020 2063 6465 6620 646f 7562 6c65  .    cdef double
-00033a80: 5b3a 2c20 3a3a 315d 2070 7473 5f6d 760a  [:, ::1] pts_mv.
-00033a90: 2020 2020 6364 6566 206c 6f6e 675b 3a2c      cdef long[:,
-00033aa0: 203a 3a31 5d20 696e 6469 5f6d 760a 2020   ::1] indi_mv.  
-00033ab0: 2020 6364 6566 206c 6f6e 675b 3a2c 203a    cdef long[:, :
-00033ac0: 3a31 5d20 696e 645f 727a 3270 6f6c 0a20  :1] ind_rz2pol. 
-00033ad0: 2020 2063 6465 6620 6c6f 6e67 5b3a 2c20     cdef long[:, 
-00033ae0: 3a3a 315d 2069 735f 696e 5f76 6967 6e65  ::1] is_in_vigne
-00033af0: 7474 650a 2020 2020 6364 6566 206c 6f6e  tte.    cdef lon
-00033b00: 672a 2020 6e63 656c 6c73 5f72 7068 6920  g*  ncells_rphi 
-00033b10: 203d 204e 554c 4c0a 2020 2020 6364 6566   = NULL.    cdef
-00033b20: 206c 6f6e 672a 2020 6c69 6e64 6578 2020   long*  lindex  
-00033b30: 203d 204e 554c 4c0a 2020 2020 6364 6566   = NULL.    cdef
-00033b40: 206c 6f6e 672a 2020 6c69 6e64 6578 5f7a   long*  lindex_z
-00033b50: 203d 204e 554c 4c0a 2020 2020 6364 6566   = NULL.    cdef
-00033b60: 206c 6f6e 672a 2020 737a 5f70 6869 203d   long*  sz_phi =
-00033b70: 204e 554c 4c0a 2020 2020 6364 6566 2064   NULL.    cdef d
-00033b80: 6f75 626c 652a 2064 6973 635f 7230 203d  ouble* disc_r0 =
-00033b90: 204e 554c 4c0a 2020 2020 6364 6566 2064   NULL.    cdef d
-00033ba0: 6f75 626c 652a 2064 6973 635f 7220 203d  ouble* disc_r  =
-00033bb0: 204e 554c 4c0a 2020 2020 6364 6566 2064   NULL.    cdef d
-00033bc0: 6f75 626c 652a 2064 6973 635f 7a20 203d  ouble* disc_z  =
-00033bd0: 204e 554c 4c0a 2020 2020 6364 6566 2064   NULL.    cdef d
-00033be0: 6f75 626c 652a 2073 7465 705f 7270 6869  ouble* step_rphi
-00033bf0: 203d 204e 554c 4c0a 2020 2020 6364 6566   = NULL.    cdef
-00033c00: 206e 702e 6e64 6172 7261 795b 6c6f 6e67   np.ndarray[long
-00033c10: 2c20 6e64 696d 3d32 5d20 696e 6449 0a20  , ndim=2] indI. 
-00033c20: 2020 2063 6465 6620 6e70 2e6e 6461 7272     cdef np.ndarr
-00033c30: 6179 5b6c 6f6e 672c 206e 6469 6d3d 315d  ay[long, ndim=1]
-00033c40: 2069 6e64 0a20 2020 2063 6465 6620 6e70   ind.    cdef np
-00033c50: 2e6e 6461 7272 6179 5b64 6f75 626c 652c  .ndarray[double,
-00033c60: 206e 6469 6d3d 315d 2072 6573 6f5f 7264   ndim=1] reso_rd
-00033c70: 7264 7a0a 2020 2020 6364 6566 206e 702e  rdz.    cdef np.
-00033c80: 6e64 6172 7261 795b 646f 7562 6c65 2c20  ndarray[double, 
-00033c90: 6e64 696d 3d32 5d20 7074 730a 2020 2020  ndim=2] pts.    
-00033ca0: 6364 6566 206e 702e 6e64 6172 7261 795b  cdef np.ndarray[
-00033cb0: 646f 7562 6c65 2c20 6e64 696d 3d32 5d20  double, ndim=2] 
-00033cc0: 7361 5f6d 6170 0a20 2020 2023 0a20 2020  sa_map.    #.   
-00033cd0: 2023 203d 3d20 5465 7374 696e 6720 696e   # == Testing in
-00033ce0: 7075 7473 203d 3d3d 3d3d 3d3d 3d3d 3d3d  puts ===========
-00033cf0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00033d00: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00033d10: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 2020  =============.  
-00033d20: 2020 6966 2074 6573 743a 0a20 2020 2020    if test:.     
-00033d30: 2020 2069 6620 626c 6f63 6b3a 0a20 2020     if block:.   
-00033d40: 2020 2020 2020 2020 206d 7367 203d 2022           msg = "
-00033d50: 7665 735f 706f 6c79 2061 6e64 2076 6573  ves_poly and ves
-00033d60: 5f6e 6f72 6d20 6172 6520 6e6f 7420 6f70  _norm are not op
-00033d70: 7469 6f6e 616c 2061 7267 756d 656e 7473  tional arguments
-00033d80: 220a 2020 2020 2020 2020 2020 2020 6173  ".            as
-00033d90: 7365 7274 2076 6573 5f70 6f6c 7920 6973  sert ves_poly is
-00033da0: 206e 6f74 204e 6f6e 6520 616e 6420 7665   not None and ve
-00033db0: 735f 6e6f 726d 2069 7320 6e6f 7420 4e6f  s_norm is not No
-00033dc0: 6e65 2c20 6d73 670a 2020 2020 2020 2020  ne, msg.        
-00033dd0: 2020 2020 626f 6f6c 3120 3d20 2876 6573      bool1 = (ves
-00033de0: 5f70 6f6c 792e 7368 6170 655b 305d 3d3d  _poly.shape[0]==
-00033df0: 3220 616e 6420 7665 735f 6e6f 726d 2e73  2 and ves_norm.s
-00033e00: 6861 7065 5b30 5d3d 3d32 0a20 2020 2020  hape[0]==2.     
-00033e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033e20: 616e 6420 7665 735f 6e6f 726d 2e73 6861  and ves_norm.sha
-00033e30: 7065 5b31 5d3d 3d76 6573 5f70 6f6c 792e  pe[1]==ves_poly.
-00033e40: 7368 6170 655b 315d 2d31 290a 2020 2020  shape[1]-1).    
-00033e50: 2020 2020 2020 2020 6d73 6720 3d20 2241          msg = "A
-00033e60: 7267 7320 7665 735f 706f 6c79 2026 2076  rgs ves_poly & v
-00033e70: 6573 5f6e 6f72 6d20 6d75 7374 2062 6520  es_norm must be 
-00033e80: 6f66 2074 6865 2073 616d 6520 7368 6170  of the same shap
-00033e90: 6520 2832 2c20 4e53 2921 220a 2020 2020  e (2, NS)!".    
-00033ea0: 2020 2020 2020 2020 6173 7365 7274 2062          assert b
-00033eb0: 6f6f 6c31 2c20 6d73 670a 2020 2020 2020  ool1, msg.      
-00033ec0: 2020 2020 2020 626f 6f6c 3120 3d20 286c        bool1 = (l
-00033ed0: 7374 7275 6374 5f6c 696d 7320 6973 204e  struct_lims is N
-00033ee0: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
-00033ef0: 2020 2020 2020 2020 206f 7220 6c65 6e28           or len(
-00033f00: 6c73 7472 7563 745f 6e6f 726d 7929 203d  lstruct_normy) =
-00033f10: 3d20 6c65 6e28 6c73 7472 7563 745f 6e6f  = len(lstruct_no
-00033f20: 726d 7829 290a 2020 2020 2020 2020 2020  rmx)).          
-00033f30: 2020 626f 6f6c 3220 3d20 286c 7374 7275    bool2 = (lstru
-00033f40: 6374 5f6e 6f72 6d78 2069 7320 4e6f 6e65  ct_normx is None
-00033f50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00033f60: 2020 2020 2020 6f72 206c 656e 286c 7374        or len(lst
-00033f70: 7275 6374 5f70 6f6c 7978 2920 3d3d 206c  ruct_polyx) == l
-00033f80: 656e 286c 7374 7275 6374 5f70 6f6c 7979  en(lstruct_polyy
-00033f90: 2929 0a20 2020 2020 2020 2020 2020 206d  )).            m
-00033fa0: 7367 203d 2022 4172 6773 206c 7374 7275  sg = "Args lstru
-00033fb0: 6374 5f70 6f6c 7978 2c20 6c73 7472 7563  ct_polyx, lstruc
-00033fc0: 745f 706f 6c79 792c 206c 7374 7275 6374  t_polyy, lstruct
-00033fd0: 5f6c 696d 732c 225c 0a20 2020 2020 2020  _lims,"\.       
-00033fe0: 2020 2020 2020 2020 202b 2022 206c 7374           + " lst
-00033ff0: 7275 6374 5f6e 6f72 6d78 2c20 6c73 7472  ruct_normx, lstr
-00034000: 7563 745f 6e6f 726d 792c 206d 7573 7420  uct_normy, must 
-00034010: 6265 204e 6f6e 6520 6f72 225c 0a20 2020  be None or"\.   
-00034020: 2020 2020 2020 2020 2020 2020 202b 2022               + "
-00034030: 206c 6973 7473 206f 6620 7361 6d65 206c   lists of same l
-00034040: 656e 2829 2122 0a20 2020 2020 2020 2020  en()!".         
-00034050: 2020 2061 7373 6572 7420 626f 6f6c 3120     assert bool1 
-00034060: 616e 6420 626f 6f6c 322c 206d 7367 0a20  and bool2, msg. 
-00034070: 2020 2020 2020 206d 7367 203d 2022 5b65         msg = "[e
-00034080: 7073 5f75 7a2c 6570 735f 767a 2c65 7073  ps_uz,eps_vz,eps
-00034090: 5f61 2c65 7073 5f62 5d20 6d75 7374 2062  _a,eps_b] must b
-000340a0: 6520 666c 6f61 7473 203c 2031 2e65 2d34  e floats < 1.e-4
-000340b0: 2122 0a20 2020 2020 2020 2061 7373 6572  !".        asser
-000340c0: 7420 616c 6c28 5b65 6520 3c20 312e 652d  t all([ee < 1.e-
-000340d0: 3420 666f 7220 6565 2069 6e20 5b65 7073  4 for ee in [eps
-000340e0: 5f75 7a2c 2065 7073 5f61 2c0a 2020 2020  _uz, eps_a,.    
-000340f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034110: 2020 2020 2020 6570 735f 767a 2c20 6570        eps_vz, ep
-00034120: 735f 622c 0a20 2020 2020 2020 2020 2020  s_b,.           
-00034130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034140: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00034150: 7073 5f70 6c61 6e65 5d5d 292c 206d 7367  ps_plane]]), msg
-00034160: 0a20 2020 2020 2020 206d 7367 203d 2022  .        msg = "
-00034170: 7665 735f 7479 7065 206d 7573 7420 6265  ves_type must be
-00034180: 2061 2073 7472 2069 6e20 5b27 546f 7227   a str in ['Tor'
-00034190: 2c27 4c69 6e27 5d21 220a 2020 2020 2020  ,'Lin']!".      
-000341a0: 2020 6173 7365 7274 2076 6573 5f74 7970    assert ves_typ
-000341b0: 652e 6c6f 7765 7228 2920 696e 205b 2774  e.lower() in ['t
-000341c0: 6f72 272c 2027 6c69 6e27 5d2c 206d 7367  or', 'lin'], msg
-000341d0: 0a20 2020 2023 202e 2e2e 0a20 2020 2023  .    # ....    #
-000341e0: 202e 2e20 4765 7474 696e 6720 7369 7a65   .. Getting size
-000341f0: 206f 6620 6172 7261 7973 202e 2e2e 2e2e   of arrays .....
-00034200: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00034210: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00034220: 2e2e 2e2e 2e2e 2e2e 2e2e 2e0a 2020 2020  ............    
-00034230: 737a 5f70 203d 2070 6172 745f 636f 6f72  sz_p = part_coor
-00034240: 6473 2e73 6861 7065 5b31 5d0a 2020 2020  ds.shape[1].    
-00034250: 2320 2320 2e2e 2043 6865 636b 2069 6620  # # .. Check if 
-00034260: 706f 696e 7473 2061 7265 2076 6973 6962  points are visib
-00034270: 6c65 202e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  le .............
+00032700: 2020 2020 2020 2020 646f 7562 6c65 5b3a          double[:
+00032710: 3a31 5d20 6c73 7472 7563 745f 6e6f 726d  :1] lstruct_norm
+00032720: 793d 4e6f 6e65 2c0a 2020 2020 2020 2020  y=None,.        
+00032730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032740: 2020 2020 6c6f 6e67 5b3a 3a31 5d20 6c6e      long[::1] ln
+00032750: 7665 7274 3d4e 6f6e 652c 0a20 2020 2020  vert=None,.     
+00032760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032770: 2020 2020 2020 2069 6e74 206e 7374 7275         int nstru
+00032780: 6374 5f74 6f74 3d30 2c0a 2020 2020 2020  ct_tot=0,.      
+00032790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000327a0: 2020 2020 2020 696e 7420 6e73 7472 7563        int nstruc
+000327b0: 745f 6c69 6d3d 302c 0a20 2020 2020 2020  t_lim=0,.       
+000327c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000327d0: 2020 2020 2064 6f75 626c 6520 726d 696e       double rmin
+000327e0: 3d2d 312c 2062 696e 7420 666f 7262 6964  =-1, bint forbid
+000327f0: 3d54 7275 652c 0a20 2020 2020 2020 2020  =True,.         
+00032800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032810: 2020 2064 6f75 626c 6520 6570 735f 757a     double eps_uz
+00032820: 3d5f 534d 414c 4c2c 2064 6f75 626c 6520  =_SMALL, double 
+00032830: 6570 735f 613d 5f56 534d 414c 4c2c 0a20  eps_a=_VSMALL,. 
+00032840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032850: 2020 2020 2020 2020 2020 2064 6f75 626c             doubl
+00032860: 6520 6570 735f 767a 3d5f 5653 4d41 4c4c  e eps_vz=_VSMALL
+00032870: 2c20 646f 7562 6c65 2065 7073 5f62 3d5f  , double eps_b=_
+00032880: 5653 4d41 4c4c 2c0a 2020 2020 2020 2020  VSMALL,.        
+00032890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000328a0: 2020 2020 646f 7562 6c65 2065 7073 5f70      double eps_p
+000328b0: 6c61 6e65 3d5f 5653 4d41 4c4c 2c20 7374  lane=_VSMALL, st
+000328c0: 7220 7665 735f 7479 7065 3d27 546f 7227  r ves_type='Tor'
+000328d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000328e0: 2020 2020 2020 2020 2020 2020 2020 646f                do
+000328f0: 7562 6c65 206d 6172 6769 6e3d 5f56 534d  uble margin=_VSM
+00032900: 414c 4c2c 2069 6e74 206e 756d 5f74 6872  ALL, int num_thr
+00032910: 6561 6473 3d34 382c 0a20 2020 2020 2020  eads=48,.       
+00032920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032930: 2020 2020 2062 696e 7420 7465 7374 3d54       bint test=T
+00032940: 7275 6529 3a0a 2020 2020 2222 220a 2020  rue):.    """.  
+00032950: 2020 436f 6d70 7574 6573 2074 6865 2032    Computes the 2
+00032960: 4420 6d61 7020 6f66 2074 6865 2069 6e74  D map of the int
+00032970: 6567 7261 7465 6420 736f 6c69 6420 616e  egrated solid an
+00032980: 676c 6573 2073 7562 7465 6e64 6564 2062  gles subtended b
+00032990: 7920 6561 6368 206f 660a 2020 2020 7468  y each of.    th
+000329a0: 6520 737a 5f70 2070 6172 7469 636c 6573  e sz_p particles
+000329b0: 2050 206f 6620 7261 6469 7573 2070 6172   P of radius par
+000329c0: 745f 7220 6174 2074 6865 2070 6f73 6974  t_r at the posit
+000329d0: 696f 6e20 7061 7274 5f63 6f6f 7264 730a  ion part_coords.
+000329e0: 2020 2020 696e 2074 6865 2073 616d 706c      in the sampl
+000329f0: 6564 2076 6f6c 756d 652e 0a20 2020 2049  ed volume..    I
+00032a00: 6620 6170 7072 6f78 2c20 6120 3874 6820  f approx, a 8th 
+00032a10: 6465 6772 6565 2061 7070 726f 7869 6d61  degree approxima
+00032a20: 7469 6f6e 2077 696c 6c20 6265 2075 7365  tion will be use
+00032a30: 6420 666f 7220 7468 6520 636f 6d70 7574  d for the comput
+00032a40: 6174 696f 6e0a 2020 2020 6f66 2074 6865  ation.    of the
+00032a50: 2073 6f6c 6964 2061 6e67 6c65 0a0a 2020   solid angle..  
+00032a60: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
+00032a70: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
+00032a80: 7061 7274 5f63 6f6f 7264 733a 2028 332c  part_coords: (3,
+00032a90: 2073 7a5f 7029 2064 6f75 626c 6520 6d65   sz_p) double me
+00032aa0: 6d6f 7279 2d76 6965 770a 0920 2020 2063  mory-view..    c
+00032ab0: 6172 7465 7369 616e 2063 6f6f 7264 696e  artesian coordin
+00032ac0: 6174 6573 206f 6620 5020 7061 7274 6963  ates of P partic
+00032ad0: 6c65 730a 2020 2020 7061 7274 5f72 3a20  les.    part_r: 
+00032ae0: 2873 7a5f 7029 2064 6f75 626c 6520 6d65  (sz_p) double me
+00032af0: 6d6f 7279 2d76 6965 770a 2020 2020 2020  mory-view.      
+00032b00: 2020 7468 6520 7261 6469 6920 6f66 2074    the radii of t
+00032b10: 6865 2050 2070 6172 7469 636c 6573 0a20  he P particles. 
+00032b20: 2020 2072 7374 6570 3a20 646f 7562 6c65     rstep: double
+00032b30: 0a20 2020 2020 2020 2072 6566 696e 656d  .        refinem
+00032b40: 656e 7420 616c 6f6e 6720 7261 6469 7573  ent along radius
+00032b50: 2060 7260 0a20 2020 207a 7374 6570 3a20   `r`.    zstep: 
+00032b60: 646f 7562 6c65 0a20 2020 2020 2020 2072  double.        r
+00032b70: 6566 696e 656d 656e 7420 616c 6f6e 6720  efinement along 
+00032b80: 6865 6967 6874 2060 7a60 0a20 2020 2070  height `z`.    p
+00032b90: 6869 7374 6570 3a20 646f 7562 6c65 0a20  histep: double. 
+00032ba0: 2020 2020 2020 2072 6566 696e 656d 656e         refinemen
+00032bb0: 7420 616c 6f6e 6720 746f 726f 6964 616c  t along toroidal
+00032bc0: 2064 6972 6563 7469 6f6e 2060 7068 6960   direction `phi`
+00032bd0: 0a20 2020 2061 7070 726f 783a 2062 6f6f  .    approx: boo
+00032be0: 6c0a 2020 2020 2020 2020 646f 2079 6f75  l.        do you
+00032bf0: 2077 616e 7420 746f 2075 7365 2061 7070   want to use app
+00032c00: 726f 7869 6d61 7469 6f6e 2028 3874 6820  roximation (8th 
+00032c10: 6f72 6465 7229 206f 7220 6578 6163 7420  order) or exact 
+00032c20: 666f 726d 756c 6120 3f0a 2020 2020 2020  formula ?.      
+00032c30: 2020 6465 6661 756c 743a 2054 7275 650a    default: True.
+00032c40: 2020 2020 524d 696e 4d61 783a 2064 6f75      RMinMax: dou
+00032c50: 626c 6520 6d65 6d6f 7279 2d76 6965 770a  ble memory-view.
+00032c60: 2020 2020 2020 2020 6c69 6d69 7473 206d          limits m
+00032c70: 696e 2061 6e64 206d 6178 2069 6e20 6072  in and max in `r
+00032c80: 600a 2020 2020 5a4d 696e 4d61 783a 2064  `.    ZMinMax: d
+00032c90: 6f75 626c 6520 6d65 6d6f 7279 2d76 6965  ouble memory-vie
+00032ca0: 770a 2020 2020 2020 2020 6c69 6d69 7473  w.        limits
+00032cb0: 206d 696e 2061 6e64 206d 6178 2069 6e20   min and max in 
+00032cc0: 607a 600a 2020 2020 4452 3a20 646f 7562  `z`.    DR: doub
+00032cd0: 6c65 206d 656d 6f72 792d 7669 6577 2c20  le memory-view, 
+00032ce0: 6f70 7469 6f6e 616c 0a20 2020 2020 2020  optional.       
+00032cf0: 2061 6374 7561 6c20 7375 622d 766f 6c75   actual sub-volu
+00032d00: 6d65 206c 696d 6974 7320 746f 2067 6574  me limits to get
+00032d10: 2069 6e20 6072 600a 2020 2020 445a 3a20   in `r`.    DZ: 
+00032d20: 646f 7562 6c65 206d 656d 6f72 792d 7669  double memory-vi
+00032d30: 6577 2c20 6f70 7469 6f6e 616c 0a20 2020  ew, optional.   
+00032d40: 2020 2020 2061 6374 7561 6c20 7375 622d       actual sub-
+00032d50: 766f 6c75 6d65 206c 696d 6974 7320 746f  volume limits to
+00032d60: 2067 6574 2069 6e20 607a 600a 2020 2020   get in `z`.    
+00032d70: 4450 6869 3a20 646f 7562 6c65 206d 656d  DPhi: double mem
+00032d80: 6f72 792d 7669 6577 2c20 6f70 7469 6f6e  ory-view, option
+00032d90: 616c 0a20 2020 2020 2020 2061 6374 7561  al.        actua
+00032da0: 6c20 7375 622d 766f 6c75 6d65 206c 696d  l sub-volume lim
+00032db0: 6974 7320 746f 2067 6574 2069 6e20 6070  its to get in `p
+00032dc0: 6869 600a 2020 2020 6c69 6d69 745f 7670  hi`.    limit_vp
+00032dd0: 6f6c 793a 2028 332c 206e 7074 7329 2064  oly: (3, npts) d
+00032de0: 6f75 626c 6520 6d65 6d6f 7279 2d76 6965  ouble memory-vie
+00032df0: 772c 206f 7074 696f 6e61 6c0a 2020 2020  w, optional.    
+00032e00: 2020 2020 6966 2077 6520 6f6e 6c79 2077      if we only w
+00032e10: 616e 7420 746f 2064 6973 6372 6574 697a  ant to discretiz
+00032e20: 6520 7468 6520 766f 6c75 6d65 2069 6e73  e the volume ins
+00032e30: 6964 6520 6120 6365 7274 6169 6e20 666c  ide a certain fl
+00032e40: 7578 2073 7572 6661 6365 2e0a 2020 2020  ux surface..    
+00032e50: 2020 2020 4465 6669 6e65 7320 7468 6520      Defines the 
+00032e60: 6028 522c 5a29 6020 636f 6f72 6473 206f  `(R,Z)` coords o
+00032e70: 6620 7468 6520 706f 6c6f 6964 616c 2063  f the poloidal c
+00032e80: 7574 206f 6620 7468 6520 6c69 6d69 7469  ut of the limiti
+00032e90: 6e67 2066 6c75 780a 2020 2020 2020 2020  ng flux.        
+00032ea0: 7375 7266 6163 652e 0a20 2020 2062 6c6f  surface..    blo
+00032eb0: 636b 3a20 626f 6f6c 2c20 6f70 7469 6f6e  ck: bool, option
+00032ec0: 616c 0a20 2020 2020 2020 2063 6865 636b  al.        check
+00032ed0: 2069 6620 7061 7274 6963 6c65 7320 6172   if particles ar
+00032ee0: 6520 7669 6577 6162 6c65 2066 726f 6d20  e viewable from 
+00032ef0: 7669 6577 696e 6720 706f 696e 7473 206f  viewing points o
+00032f00: 7220 6966 2074 6865 7265 2069 7320 610a  r if there is a.
+00032f10: 2020 2020 2020 2020 7374 7275 6374 7572          structur
+00032f20: 616c 2065 6c65 6d65 6e74 2062 6c6f 636b  al element block
+00032f30: 696e 6720 7669 7369 6269 6c69 7479 2028  ing visibility (
+00032f40: 4661 6c73 6529 0a20 2020 2076 6573 5f70  False).    ves_p
+00032f50: 6f6c 7920 3a20 2832 2c20 6e75 6d5f 7665  oly : (2, num_ve
+00032f60: 7274 6578 2920 646f 7562 6c65 2061 7272  rtex) double arr
+00032f70: 6179 0a20 2020 2020 2020 436f 6f72 6469  ay.       Coordi
+00032f80: 6e61 7465 7320 6f66 2074 6865 2076 6572  nates of the ver
+00032f90: 7469 6365 7320 6f66 2074 6865 2050 6f6c  tices of the Pol
+00032fa0: 7967 6f6e 2064 6566 696e 696e 6720 7468  ygon defining th
+00032fb0: 6520 3244 2070 6f6c 6f69 6461 6c0a 2020  e 2D poloidal.  
+00032fc0: 2020 2020 2063 7574 206f 6620 7468 6520       cut of the 
+00032fd0: 5665 7373 656c 0a20 2020 2076 6573 5f6e  Vessel.    ves_n
+00032fe0: 6f72 6d20 3a20 2832 2c20 6e75 6d5f 7665  orm : (2, num_ve
+00032ff0: 7274 6578 2d31 2920 646f 7562 6c65 2061  rtex-1) double a
+00033000: 7272 6179 0a20 2020 2020 2020 4e6f 726d  rray.       Norm
+00033010: 616c 2076 6563 746f 7273 2067 6f69 6e67  al vectors going
+00033020: 2022 696e 7761 7264 7322 206f 6620 7468   "inwards" of th
+00033030: 6520 6564 6765 7320 6f66 2074 6865 2050  e edges of the P
+00033040: 6f6c 7967 6f6e 2064 6566 696e 6564 0a20  olygon defined. 
+00033050: 2020 2020 2020 6279 2076 6573 5f70 6f6c        by ves_pol
+00033060: 790a 2020 2020 6e73 7472 7563 745f 746f  y.    nstruct_to
+00033070: 7420 3a20 696e 740a 2020 2020 2020 2054  t : int.       T
+00033080: 6f74 616c 206e 756d 6265 7220 6f66 2073  otal number of s
+00033090: 7472 7563 7475 7265 7320 2863 6f75 6e74  tructures (count
+000330a0: 696e 6720 6561 6368 206c 696d 6974 6564  ing each limited
+000330b0: 2073 7472 7563 7475 7265 2061 7320 6f6e   structure as on
+000330c0: 6529 0a20 2020 2076 6573 5f6c 696d 7320  e).    ves_lims 
+000330d0: 3a20 6172 7261 790a 2020 2020 2020 2043  : array.       C
+000330e0: 6f6e 7461 696e 7320 7468 6520 6c69 6d69  ontains the limi
+000330f0: 7473 206d 696e 2061 6e64 206d 6178 206f  ts min and max o
+00033100: 6620 7665 7373 656c 0a20 2020 206c 7374  f vessel.    lst
+00033110: 7275 6374 5f70 6f6c 7978 203a 2061 7272  ruct_polyx : arr
+00033120: 6179 0a20 2020 2020 2020 4c69 7374 206f  ay.       List o
+00033130: 6620 7820 636f 6f72 6469 6e61 7465 7320  f x coordinates 
+00033140: 6f66 2074 6865 2076 6572 7469 6365 7320  of the vertices 
+00033150: 6f66 2061 6c6c 2073 7472 7563 7475 7265  of all structure
+00033160: 7320 6f6e 2070 6f6c 6f69 6461 6c20 706c  s on poloidal pl
+00033170: 616e 650a 2020 2020 2020 2049 6620 6e6f  ane.       If no
+00033180: 2073 7472 7563 7475 7265 7320 3a20 4e6f   structures : No
+00033190: 6e65 0a20 2020 206c 7374 7275 6374 5f70  ne.    lstruct_p
+000331a0: 6f6c 7979 203a 2061 7272 6179 0a20 2020  olyy : array.   
+000331b0: 2020 2020 4c69 7374 206f 6620 7920 636f      List of y co
+000331c0: 6f72 6469 6e61 7465 7320 6f66 2074 6865  ordinates of the
+000331d0: 2076 6572 7469 6365 7320 6f66 2061 6c6c   vertices of all
+000331e0: 2073 7472 7563 7475 7265 7320 6f6e 2070   structures on p
+000331f0: 6f6c 6f69 6461 6c20 706c 616e 650a 2020  oloidal plane.  
+00033200: 2020 2020 2049 6620 6e6f 2073 7472 7563       If no struc
+00033210: 7475 7265 7320 3a20 4e6f 6e65 0a20 2020  tures : None.   
+00033220: 206c 7374 7275 6374 5f6c 696d 7320 3a20   lstruct_lims : 
+00033230: 6172 7261 790a 2020 2020 2020 204c 6973  array.       Lis
+00033240: 7420 6f66 206c 696d 6974 7320 6f66 2061  t of limits of a
+00033250: 6c6c 2073 7472 7563 7475 7265 730a 2020  ll structures.  
+00033260: 2020 2020 2049 6620 6e6f 2073 7472 7563       If no struc
+00033270: 7475 7265 7320 3a20 4e6f 6e65 0a20 2020  tures : None.   
+00033280: 206c 7374 7275 6374 5f6e 6c69 6d20 3a20   lstruct_nlim : 
+00033290: 6172 7261 7920 6f66 2069 6e74 730a 2020  array of ints.  
+000332a0: 2020 2020 204c 6973 7420 6f66 206e 756d       List of num
+000332b0: 6265 7220 6f66 206c 696d 6974 7320 666f  ber of limits fo
+000332c0: 7220 616c 6c20 7374 7275 6374 7572 6573  r all structures
+000332d0: 0a20 2020 2020 2020 4966 206e 6f20 7374  .       If no st
+000332e0: 7275 6374 7572 6573 203a 204e 6f6e 650a  ructures : None.
+000332f0: 2020 2020 6c73 7472 7563 745f 6e6f 726d      lstruct_norm
+00033300: 7820 3a20 646f 7562 6c65 206d 656d 6f72  x : double memor
+00033310: 792d 7669 6577 2c20 6f70 7469 6f6e 616c  y-view, optional
+00033320: 0a20 2020 2020 2020 4c69 7374 206f 6620  .       List of 
+00033330: 782d 636f 6f72 6469 6e61 7465 7320 6f66  x-coordinates of
+00033340: 2022 696e 7761 7264 7322 206e 6f72 6d61   "inwards" norma
+00033350: 6c20 7665 6374 6f72 7320 6f66 2074 6865  l vectors of the
+00033360: 2070 6f6c 7967 6f6e 206f 6620 616c 6c0a   polygon of all.
+00033370: 2020 2020 2020 2074 6865 2073 7472 7563         the struc
+00033380: 7475 7265 730a 2020 2020 2020 2049 6620  tures.       If 
+00033390: 6e6f 2073 7472 7563 7475 7265 7320 3a20  no structures : 
+000333a0: 4e6f 6e65 0a20 2020 206c 7374 7275 6374  None.    lstruct
+000333b0: 5f6e 6f72 6d79 203a 2064 6f75 626c 6520  _normy : double 
+000333c0: 6d65 6d6f 7279 2d76 6965 772c 206f 7074  memory-view, opt
+000333d0: 696f 6e61 6c0a 2020 2020 2020 204c 6973  ional.       Lis
+000333e0: 7420 6f66 2079 2d63 6f6f 7264 696e 6174  t of y-coordinat
+000333f0: 6573 206f 6620 2269 6e77 6172 6473 2220  es of "inwards" 
+00033400: 6e6f 726d 616c 2076 6563 746f 7273 206f  normal vectors o
+00033410: 6620 7468 6520 706f 6c79 676f 6e20 6f66  f the polygon of
+00033420: 2061 6c6c 0a20 2020 2020 2020 7468 6520   all.       the 
+00033430: 7374 7275 6374 7572 6573 0a20 2020 2020  structures.     
+00033440: 2020 4966 206e 6f20 7374 7275 6374 7572    If no structur
+00033450: 6573 203a 204e 6f6e 650a 2020 2020 726d  es : None.    rm
+00033460: 696e 203a 2064 6f75 626c 652c 206f 7074  in : double, opt
+00033470: 696f 6e61 6c0a 2020 2020 2020 204d 696e  ional.       Min
+00033480: 696d 616c 2072 6164 6975 7320 6f66 2076  imal radius of v
+00033490: 6573 7365 6c20 746f 2074 616b 6520 696e  essel to take in
+000334a0: 746f 2063 6f6e 7369 6465 7261 7469 6f6e  to consideration
+000334b0: 0a20 2020 2066 6f72 6269 6420 3a20 626f  .    forbid : bo
+000334c0: 6f6c 2c20 6f70 7469 6f6e 616c 0a20 2020  ol, optional.   
+000334d0: 2020 2020 5368 6f75 6c64 2077 6520 666f      Should we fo
+000334e0: 7262 6964 2076 616c 7565 7320 6265 6869  rbid values behi
+000334f0: 6e64 2076 6973 6962 6c65 2072 6164 6975  nd visible radiu
+00033500: 7320 3f20 2873 6565 2072 6d69 6e29 0a20  s ? (see rmin). 
+00033510: 2020 2065 7073 5f3c 7661 6c3e 203a 2064     eps_<val> : d
+00033520: 6f75 626c 652c 206f 7074 696f 6e61 6c0a  ouble, optional.
+00033530: 2020 2020 2020 2053 6d61 6c6c 2076 616c         Small val
+00033540: 7565 2c20 6163 6365 7074 616e 6365 206f  ue, acceptance o
+00033550: 6620 6572 726f 720a 2020 2020 6d61 7267  f error.    marg
+00033560: 696e 3a20 646f 7562 6c65 2c20 6f70 7469  in: double, opti
+00033570: 6f6e 616c 0a20 2020 2020 2020 2074 6f6c  onal.        tol
+00033580: 6572 616e 6365 2065 7272 6f72 2e20 4465  erance error. De
+00033590: 6661 756c 7473 2074 6f20 7c5f 5653 4d41  faults to |_VSMA
+000335a0: 4c4c 7c0a 2020 2020 6e75 6d5f 7468 7265  LL|.    num_thre
+000335b0: 6164 7320 3a20 696e 740a 2020 2020 2020  ads : int.      
+000335c0: 2054 6865 206e 756d 5f74 6872 6561 6473   The num_threads
+000335d0: 2061 7267 756d 656e 7420 696e 6469 6361   argument indica
+000335e0: 7465 7320 686f 7720 6d61 6e79 2074 6872  tes how many thr
+000335f0: 6561 6473 2074 6865 2074 6561 6d20 7368  eads the team sh
+00033600: 6f75 6c64 0a20 2020 2020 2020 636f 6e73  ould.       cons
+00033610: 6973 7420 6f66 2e20 4966 206e 6f74 2067  ist of. If not g
+00033620: 6976 656e 2c20 4f70 656e 4d50 2077 696c  iven, OpenMP wil
+00033630: 6c20 6465 6369 6465 2068 6f77 206d 616e  l decide how man
+00033640: 7920 7468 7265 6164 7320 746f 2075 7365  y threads to use
+00033650: 2e0a 2020 2020 2020 2054 7970 6963 616c  ..       Typical
+00033660: 6c79 2074 6869 7320 6973 2074 6865 206e  ly this is the n
+00033670: 756d 6265 7220 6f66 2063 6f72 6573 2061  umber of cores a
+00033680: 7661 696c 6162 6c65 206f 6e20 7468 6520  vailable on the 
+00033690: 6d61 6368 696e 652e 0a20 2020 2074 6573  machine..    tes
+000336a0: 7420 3a20 626f 6f6c 2c20 6f70 7469 6f6e  t : bool, option
+000336b0: 616c 0a20 2020 2020 2020 5368 6f75 6c64  al.       Should
+000336c0: 2077 6520 7275 6e20 7465 7374 733f 2044   we run tests? D
+000336d0: 6566 6175 6c74 2054 7275 650a 0a20 2020  efault True..   
+000336e0: 2052 6574 7572 6e73 0a20 2020 202d 2d2d   Returns.    ---
+000336f0: 2d2d 2d2d 0a20 2020 2020 2020 2070 7473  ----.        pts
+00033700: 3a20 2020 2028 322c 206e 7074 7329 2061  :    (2, npts) a
+00033710: 7272 6179 206f 6620 2852 2c20 5a29 2063  rray of (R, Z) c
+00033720: 6f6f 7264 696e 6174 6573 206f 6620 7669  oordinates of vi
+00033730: 6577 696e 6720 706f 696e 7473 2069 6e0a  ewing points in.
+00033740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033750: 7669 676e 6574 7465 2077 6865 7265 2073  vignette where s
+00033760: 6f6c 6964 2061 6e67 6c65 2069 7320 696e  olid angle is in
+00033770: 7465 6772 6174 6564 0a20 2020 2020 2020  tegrated.       
+00033780: 2073 615f 6d61 703a 2028 6e70 7473 2c20   sa_map: (npts, 
+00033790: 737a 5f70 2920 6172 7261 7920 6170 7072  sz_p) array appr
+000337a0: 6f78 2073 6f6c 6964 2061 6e67 6c65 2069  ox solid angle i
+000337b0: 6e74 6567 7261 7465 6420 616c 6f6e 6720  ntegrated along 
+000337c0: 7068 690a 2020 2020 2020 2020 2020 2020  phi.            
+000337d0: 2020 2020 696e 7465 6772 616c 2028 7361      integral (sa
+000337e0: 202a 2064 7068 6920 2a20 7229 0a20 2020   * dphi * r).   
+000337f0: 2020 2020 2069 6e64 3a20 2020 2028 6e70       ind:    (np
+00033800: 7473 2920 696e 6469 6365 7320 746f 2072  ts) indices to r
+00033810: 6563 6f6e 7374 7275 6374 2028 522c 5a29  econstruct (R,Z)
+00033820: 206d 6170 2066 726f 6d20 7361 5f6d 6170   map from sa_map
+00033830: 0a20 2020 2020 2020 2072 6472 647a 3a20  .        rdrdz: 
+00033840: 2028 6e70 7473 2920 766f 6c75 6d65 2075   (npts) volume u
+00033850: 6e69 743a 2064 722a 647a 0a20 2020 2022  nit: dr*dz.    "
+00033860: 2222 0a20 2020 2063 6465 6620 696e 7420  "".    cdef int 
+00033870: 6a6a 0a20 2020 2063 6465 6620 696e 7420  jj.    cdef int 
+00033880: 737a 5f70 0a20 2020 2063 6465 6620 696e  sz_p.    cdef in
+00033890: 7420 737a 5f72 0a20 2020 2063 6465 6620  t sz_r.    cdef 
+000338a0: 696e 7420 737a 5f7a 0a20 2020 2063 6465  int sz_z.    cde
+000338b0: 6620 696e 7420 6e70 7473 5f70 6f6c 0a20  f int npts_pol. 
+000338c0: 2020 2063 6465 6620 696e 7420 725f 7261     cdef int r_ra
+000338d0: 7469 6f0a 2020 2020 6364 6566 2069 6e74  tio.    cdef int
+000338e0: 2069 6e64 5f6c 6f63 5f72 300a 2020 2020   ind_loc_r0.    
+000338f0: 6364 6566 2069 6e74 206e 7074 735f 6469  cdef int npts_di
+00033900: 7363 203d 2030 0a20 2020 2063 6465 6620  sc = 0.    cdef 
+00033910: 696e 745b 315d 206d 6178 5f73 7a5f 7068  int[1] max_sz_ph
+00033920: 690a 2020 2020 6364 6566 2064 6f75 626c  i.    cdef doubl
+00033930: 6520 6d69 6e5f 7068 692c 206d 6178 5f70  e min_phi, max_p
+00033940: 6869 0a20 2020 2063 6465 6620 646f 7562  hi.    cdef doub
+00033950: 6c65 206d 696e 5f70 6869 5f70 690a 2020  le min_phi_pi.  
+00033960: 2020 6364 6566 2064 6f75 626c 6520 6d61    cdef double ma
+00033970: 785f 7068 695f 7069 0a20 2020 2063 6465  x_phi_pi.    cde
+00033980: 6620 646f 7562 6c65 2061 6273 302c 2061  f double abs0, a
+00033990: 6273 310a 2020 2020 6364 6566 2064 6f75  bs1.    cdef dou
+000339a0: 626c 6520 7265 736f 5f72 5f7a 0a20 2020  ble reso_r_z.   
+000339b0: 2063 6465 6620 646f 7562 6c65 2074 776f   cdef double two
+000339c0: 7069 5f6f 7665 725f 6470 6869 0a20 2020  pi_over_dphi.   
+000339d0: 2063 6465 6620 6c6f 6e67 5b31 5d20 6e63   cdef long[1] nc
+000339e0: 656c 6c73 5f72 302c 206e 6365 6c6c 735f  ells_r0, ncells_
+000339f0: 722c 206e 6365 6c6c 735f 7a0a 2020 2020  r, ncells_z.    
+00033a00: 6364 6566 206c 6f6e 675b 3a3a 315d 2069  cdef long[::1] i
+00033a10: 6e64 5f6d 760a 2020 2020 6364 6566 206c  nd_mv.    cdef l
+00033a20: 6f6e 675b 3a3a 315d 2066 6972 7374 5f69  ong[::1] first_i
+00033a30: 6e64 5f6d 760a 2020 2020 6364 6566 2064  nd_mv.    cdef d
+00033a40: 6f75 626c 655b 325d 206c 696d 6974 735f  ouble[2] limits_
+00033a50: 646c 0a20 2020 2063 6465 6620 646f 7562  dl.    cdef doub
+00033a60: 6c65 5b31 5d20 7265 736f 5f72 302c 2072  le[1] reso_r0, r
+00033a70: 6573 6f5f 722c 2072 6573 6f5f 7a0a 2020  eso_r, reso_z.  
+00033a80: 2020 6364 6566 2064 6f75 626c 655b 3a3a    cdef double[::
+00033a90: 315d 2072 6573 6f5f 7264 7264 7a5f 6d76  1] reso_rdrdz_mv
+00033aa0: 0a20 2020 2063 6465 6620 646f 7562 6c65  .    cdef double
+00033ab0: 5b3a 3a31 5d20 6c73 7472 7563 745f 6c69  [::1] lstruct_li
+00033ac0: 6d73 5f6e 700a 2020 2020 6364 6566 2064  ms_np.    cdef d
+00033ad0: 6f75 626c 655b 3a2c 203a 3a31 5d20 706f  ouble[:, ::1] po
+00033ae0: 6c79 5f6d 760a 2020 2020 6364 6566 2064  ly_mv.    cdef d
+00033af0: 6f75 626c 655b 3a2c 203a 3a31 5d20 7074  ouble[:, ::1] pt
+00033b00: 735f 6d76 0a20 2020 2063 6465 6620 6c6f  s_mv.    cdef lo
+00033b10: 6e67 5b3a 2c20 3a3a 315d 2069 6e64 695f  ng[:, ::1] indi_
+00033b20: 6d76 0a20 2020 2063 6465 6620 6c6f 6e67  mv.    cdef long
+00033b30: 5b3a 2c20 3a3a 315d 2069 6e64 5f72 7a32  [:, ::1] ind_rz2
+00033b40: 706f 6c0a 2020 2020 6364 6566 206c 6f6e  pol.    cdef lon
+00033b50: 675b 3a2c 203a 3a31 5d20 6973 5f69 6e5f  g[:, ::1] is_in_
+00033b60: 7669 676e 6574 7465 0a20 2020 2063 6465  vignette.    cde
+00033b70: 6620 6c6f 6e67 2a20 206e 6365 6c6c 735f  f long*  ncells_
+00033b80: 7270 6869 2020 3d20 4e55 4c4c 0a20 2020  rphi  = NULL.   
+00033b90: 2063 6465 6620 6c6f 6e67 2a20 206c 696e   cdef long*  lin
+00033ba0: 6465 7820 2020 3d20 4e55 4c4c 0a20 2020  dex   = NULL.   
+00033bb0: 2063 6465 6620 6c6f 6e67 2a20 206c 696e   cdef long*  lin
+00033bc0: 6465 785f 7a20 3d20 4e55 4c4c 0a20 2020  dex_z = NULL.   
+00033bd0: 2063 6465 6620 6c6f 6e67 2a20 2073 7a5f   cdef long*  sz_
+00033be0: 7068 6920 3d20 4e55 4c4c 0a20 2020 2063  phi = NULL.    c
+00033bf0: 6465 6620 646f 7562 6c65 2a20 6469 7363  def double* disc
+00033c00: 5f72 3020 3d20 4e55 4c4c 0a20 2020 2063  _r0 = NULL.    c
+00033c10: 6465 6620 646f 7562 6c65 2a20 6469 7363  def double* disc
+00033c20: 5f72 2020 3d20 4e55 4c4c 0a20 2020 2063  _r  = NULL.    c
+00033c30: 6465 6620 646f 7562 6c65 2a20 6469 7363  def double* disc
+00033c40: 5f7a 2020 3d20 4e55 4c4c 0a20 2020 2063  _z  = NULL.    c
+00033c50: 6465 6620 646f 7562 6c65 2a20 7374 6570  def double* step
+00033c60: 5f72 7068 6920 3d20 4e55 4c4c 0a20 2020  _rphi = NULL.   
+00033c70: 2063 6465 6620 6e70 2e6e 6461 7272 6179   cdef np.ndarray
+00033c80: 5b6c 6f6e 672c 206e 6469 6d3d 325d 2069  [long, ndim=2] i
+00033c90: 6e64 490a 2020 2020 6364 6566 206e 702e  ndI.    cdef np.
+00033ca0: 6e64 6172 7261 795b 6c6f 6e67 2c20 6e64  ndarray[long, nd
+00033cb0: 696d 3d31 5d20 696e 640a 2020 2020 6364  im=1] ind.    cd
+00033cc0: 6566 206e 702e 6e64 6172 7261 795b 646f  ef np.ndarray[do
+00033cd0: 7562 6c65 2c20 6e64 696d 3d31 5d20 7265  uble, ndim=1] re
+00033ce0: 736f 5f72 6472 647a 0a20 2020 2063 6465  so_rdrdz.    cde
+00033cf0: 6620 6e70 2e6e 6461 7272 6179 5b64 6f75  f np.ndarray[dou
+00033d00: 626c 652c 206e 6469 6d3d 325d 2070 7473  ble, ndim=2] pts
+00033d10: 0a20 2020 2063 6465 6620 6e70 2e6e 6461  .    cdef np.nda
+00033d20: 7272 6179 5b64 6f75 626c 652c 206e 6469  rray[double, ndi
+00033d30: 6d3d 325d 2073 615f 6d61 700a 2020 2020  m=2] sa_map.    
+00033d40: 230a 2020 2020 2320 3d3d 2054 6573 7469  #.    # == Testi
+00033d50: 6e67 2069 6e70 7574 7320 3d3d 3d3d 3d3d  ng inputs ======
+00033d60: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00033d70: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00033d80: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00033d90: 3d3d 0a20 2020 2069 6620 7465 7374 3a0a  ==.    if test:.
+00033da0: 2020 2020 2020 2020 6966 2062 6c6f 636b          if block
+00033db0: 3a0a 2020 2020 2020 2020 2020 2020 6d73  :.            ms
+00033dc0: 6720 3d20 2276 6573 5f70 6f6c 7920 616e  g = "ves_poly an
+00033dd0: 6420 7665 735f 6e6f 726d 2061 7265 206e  d ves_norm are n
+00033de0: 6f74 206f 7074 696f 6e61 6c20 6172 6775  ot optional argu
+00033df0: 6d65 6e74 7322 0a20 2020 2020 2020 2020  ments".         
+00033e00: 2020 2061 7373 6572 7420 7665 735f 706f     assert ves_po
+00033e10: 6c79 2069 7320 6e6f 7420 4e6f 6e65 2061  ly is not None a
+00033e20: 6e64 2076 6573 5f6e 6f72 6d20 6973 206e  nd ves_norm is n
+00033e30: 6f74 204e 6f6e 652c 206d 7367 0a20 2020  ot None, msg.   
+00033e40: 2020 2020 2020 2020 2062 6f6f 6c31 203d           bool1 =
+00033e50: 2028 7665 735f 706f 6c79 2e73 6861 7065   (ves_poly.shape
+00033e60: 5b30 5d3d 3d32 2061 6e64 2076 6573 5f6e  [0]==2 and ves_n
+00033e70: 6f72 6d2e 7368 6170 655b 305d 3d3d 320a  orm.shape[0]==2.
+00033e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033e90: 2020 2020 2061 6e64 2076 6573 5f6e 6f72       and ves_nor
+00033ea0: 6d2e 7368 6170 655b 315d 3d3d 7665 735f  m.shape[1]==ves_
+00033eb0: 706f 6c79 2e73 6861 7065 5b31 5d2d 3129  poly.shape[1]-1)
+00033ec0: 0a20 2020 2020 2020 2020 2020 206d 7367  .            msg
+00033ed0: 203d 2022 4172 6773 2076 6573 5f70 6f6c   = "Args ves_pol
+00033ee0: 7920 2620 7665 735f 6e6f 726d 206d 7573  y & ves_norm mus
+00033ef0: 7420 6265 206f 6620 7468 6520 7361 6d65  t be of the same
+00033f00: 2073 6861 7065 2028 322c 204e 5329 2122   shape (2, NS)!"
+00033f10: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00033f20: 6572 7420 626f 6f6c 312c 206d 7367 0a20  ert bool1, msg. 
+00033f30: 2020 2020 2020 2020 2020 2062 6f6f 6c31             bool1
+00033f40: 203d 2028 6c73 7472 7563 745f 6c69 6d73   = (lstruct_lims
+00033f50: 2069 7320 4e6f 6e65 0a20 2020 2020 2020   is None.       
+00033f60: 2020 2020 2020 2020 2020 2020 2020 6f72                or
+00033f70: 206c 656e 286c 7374 7275 6374 5f6e 6f72   len(lstruct_nor
+00033f80: 6d79 2920 3d3d 206c 656e 286c 7374 7275  my) == len(lstru
+00033f90: 6374 5f6e 6f72 6d78 2929 0a20 2020 2020  ct_normx)).     
+00033fa0: 2020 2020 2020 2062 6f6f 6c32 203d 2028         bool2 = (
+00033fb0: 6c73 7472 7563 745f 6e6f 726d 7820 6973  lstruct_normx is
+00033fc0: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
+00033fd0: 2020 2020 2020 2020 2020 206f 7220 6c65             or le
+00033fe0: 6e28 6c73 7472 7563 745f 706f 6c79 7829  n(lstruct_polyx)
+00033ff0: 203d 3d20 6c65 6e28 6c73 7472 7563 745f   == len(lstruct_
+00034000: 706f 6c79 7929 290a 2020 2020 2020 2020  polyy)).        
+00034010: 2020 2020 6d73 6720 3d20 2241 7267 7320      msg = "Args 
+00034020: 6c73 7472 7563 745f 706f 6c79 782c 206c  lstruct_polyx, l
+00034030: 7374 7275 6374 5f70 6f6c 7979 2c20 6c73  struct_polyy, ls
+00034040: 7472 7563 745f 6c69 6d73 2c22 5c0a 2020  truct_lims,"\.  
+00034050: 2020 2020 2020 2020 2020 2020 2020 2b20                + 
+00034060: 2220 6c73 7472 7563 745f 6e6f 726d 782c  " lstruct_normx,
+00034070: 206c 7374 7275 6374 5f6e 6f72 6d79 2c20   lstruct_normy, 
+00034080: 6d75 7374 2062 6520 4e6f 6e65 206f 7222  must be None or"
+00034090: 5c0a 2020 2020 2020 2020 2020 2020 2020  \.              
+000340a0: 2020 2b20 2220 6c69 7374 7320 6f66 2073    + " lists of s
+000340b0: 616d 6520 6c65 6e28 2921 220a 2020 2020  ame len()!".    
+000340c0: 2020 2020 2020 2020 6173 7365 7274 2062          assert b
+000340d0: 6f6f 6c31 2061 6e64 2062 6f6f 6c32 2c20  ool1 and bool2, 
+000340e0: 6d73 670a 2020 2020 2020 2020 6d73 6720  msg.        msg 
+000340f0: 3d20 225b 6570 735f 757a 2c65 7073 5f76  = "[eps_uz,eps_v
+00034100: 7a2c 6570 735f 612c 6570 735f 625d 206d  z,eps_a,eps_b] m
+00034110: 7573 7420 6265 2066 6c6f 6174 7320 3c20  ust be floats < 
+00034120: 312e 652d 3421 220a 2020 2020 2020 2020  1.e-4!".        
+00034130: 6173 7365 7274 2061 6c6c 285b 6565 203c  assert all([ee <
+00034140: 2031 2e65 2d34 2066 6f72 2065 6520 696e   1.e-4 for ee in
+00034150: 205b 6570 735f 757a 2c20 6570 735f 612c   [eps_uz, eps_a,
+00034160: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00034170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034180: 2020 2020 2020 2020 2020 2065 7073 5f76             eps_v
+00034190: 7a2c 2065 7073 5f62 2c0a 2020 2020 2020  z, eps_b,.      
+000341a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000341b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000341c0: 2020 2020 6570 735f 706c 616e 655d 5d29      eps_plane]])
+000341d0: 2c20 6d73 670a 2020 2020 2020 2020 6d73  , msg.        ms
+000341e0: 6720 3d20 2276 6573 5f74 7970 6520 6d75  g = "ves_type mu
+000341f0: 7374 2062 6520 6120 7374 7220 696e 205b  st be a str in [
+00034200: 2754 6f72 272c 274c 696e 275d 2122 0a20  'Tor','Lin']!". 
+00034210: 2020 2020 2020 2061 7373 6572 7420 7665         assert ve
+00034220: 735f 7479 7065 2e6c 6f77 6572 2829 2069  s_type.lower() i
+00034230: 6e20 5b27 746f 7227 2c20 276c 696e 275d  n ['tor', 'lin']
+00034240: 2c20 6d73 670a 2020 2020 2320 2e2e 2e0a  , msg.    # ....
+00034250: 2020 2020 2320 2e2e 2047 6574 7469 6e67      # .. Getting
+00034260: 2073 697a 6520 6f66 2061 7272 6179 7320   size of arrays 
+00034270: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
 00034280: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00034290: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 0a20  ............... 
-000342a0: 2020 2023 2047 6574 2074 6865 2061 6374     # Get the act
-000342b0: 7561 6c20 5220 616e 6420 5a20 7265 736f  ual R and Z reso
-000342c0: 6c75 7469 6f6e 7320 616e 6420 6d65 7368  lutions and mesh
-000342d0: 2065 6c65 6d65 6e74 730a 2020 2020 2320   elements.    # 
-000342e0: 2e2e 2046 6972 7374 2077 6520 6469 7363  .. First we disc
-000342f0: 7265 7469 7a65 2052 2077 6974 686f 7574  retize R without
-00034300: 206c 696d 6974 7320 2e2e 2e2e 2e2e 2e2e   limits ........
-00034310: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00034320: 2e2e 2e2e 2e2e 2e2e 2e2e 0a20 2020 205f  ...........    _
-00034330: 7374 2e63 7974 686f 6e69 7a65 5f73 7562  st.cythonize_sub
-00034340: 646f 6d61 696e 5f64 6c28 4e6f 6e65 2c20  domain_dl(None, 
-00034350: 6c69 6d69 7473 5f64 6c29 2023 206e 6f20  limits_dl) # no 
-00034360: 6c69 6d69 7473 0a20 2020 205f 203d 205f  limits.    _ = _
-00034370: 7374 2e64 6973 6372 6574 697a 655f 6c69  st.discretize_li
-00034380: 6e65 3164 5f63 6f72 6528 2652 4d69 6e4d  ne1d_core(&RMinM
-00034390: 6178 5b30 5d2c 2072 7374 6570 2c20 6c69  ax[0], rstep, li
-000343a0: 6d69 7473 5f64 6c2c 0a20 2020 2020 2020  mits_dl,.       
-000343b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000343c0: 2020 2020 2020 2020 2020 2020 5472 7565              True
-000343d0: 2c20 302c 2023 2064 6973 6372 6574 697a  , 0, # discretiz
-000343e0: 6520 696e 2061 6273 6f6c 7574 6520 6d6f  e in absolute mo
-000343f0: 6465 0a20 2020 2020 2020 2020 2020 2020  de.             
-00034400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034410: 2020 2020 2020 6d61 7267 696e 2c20 2664        margin, &d
-00034420: 6973 635f 7230 2c20 7265 736f 5f72 302c  isc_r0, reso_r0,
-00034430: 2026 6c69 6e64 6578 2c0a 2020 2020 2020   &lindex,.      
-00034440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034450: 2020 2020 2020 2020 2020 2020 206e 6365               nce
-00034460: 6c6c 735f 7230 290a 2020 2020 6672 6565  lls_r0).    free
-00034470: 286c 696e 6465 7829 2023 2067 6574 7469  (lindex) # getti
-00034480: 6e67 2072 6964 206f 6620 7468 696e 6773  ng rid of things
-00034490: 2077 6520 646f 6e74 206e 6565 640a 2020   we dont need.  
-000344a0: 2020 6c69 6e64 6578 203d 204e 554c 4c0a    lindex = NULL.
-000344b0: 2020 2020 2320 2e2e 204e 6f77 2074 6865      # .. Now the
-000344c0: 2061 6374 7561 6c20 5220 6c69 6d69 7465   actual R limite
-000344d0: 6420 202e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  d  .............
-000344e0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-000344f0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00034500: 0a20 2020 205f 7374 2e63 7974 686f 6e69  .    _st.cythoni
-00034510: 7a65 5f73 7562 646f 6d61 696e 5f64 6c28  ze_subdomain_dl(
-00034520: 4452 2c20 6c69 6d69 7473 5f64 6c29 0a20  DR, limits_dl). 
-00034530: 2020 2073 7a5f 7220 3d20 5f73 742e 6469     sz_r = _st.di
-00034540: 7363 7265 7469 7a65 5f6c 696e 6531 645f  scretize_line1d_
-00034550: 636f 7265 2826 524d 696e 4d61 785b 305d  core(&RMinMax[0]
-00034560: 2c20 7273 7465 702c 206c 696d 6974 735f  , rstep, limits_
-00034570: 646c 2c0a 2020 2020 2020 2020 2020 2020  dl,.            
-00034580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034590: 2020 2020 2020 2020 2020 5472 7565 2c20            True, 
-000345a0: 302c 2023 2064 6973 6372 6574 697a 6520  0, # discretize 
-000345b0: 696e 2061 6273 6f6c 7574 6520 6d6f 6465  in absolute mode
-000345c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000345d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000345e0: 2020 2020 2020 206d 6172 6769 6e2c 2026         margin, &
-000345f0: 6469 7363 5f72 2c20 7265 736f 5f72 2c20  disc_r, reso_r, 
-00034600: 266c 696e 6465 782c 0a20 2020 2020 2020  &lindex,.       
-00034610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034620: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00034630: 6365 6c6c 735f 7229 0a20 2020 2066 7265  cells_r).    fre
-00034640: 6528 6c69 6e64 6578 2920 2320 6765 7474  e(lindex) # gett
-00034650: 696e 6720 7269 6420 6f66 2074 6869 6e67  ing rid of thing
-00034660: 7320 7765 2064 6f6e 7420 6e65 6564 0a20  s we dont need. 
-00034670: 2020 2023 202e 2e20 4e6f 7720 5a20 2e2e     # .. Now Z ..
-00034680: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00034690: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-000346a0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-000346b0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e0a  ................
-000346c0: 2020 2020 5f73 742e 6379 7468 6f6e 697a      _st.cythoniz
-000346d0: 655f 7375 6264 6f6d 6169 6e5f 646c 2844  e_subdomain_dl(D
-000346e0: 5a2c 206c 696d 6974 735f 646c 290a 2020  Z, limits_dl).  
-000346f0: 2020 737a 5f7a 203d 205f 7374 2e64 6973    sz_z = _st.dis
-00034700: 6372 6574 697a 655f 6c69 6e65 3164 5f63  cretize_line1d_c
-00034710: 6f72 6528 265a 4d69 6e4d 6178 5b30 5d2c  ore(&ZMinMax[0],
-00034720: 207a 7374 6570 2c20 6c69 6d69 7473 5f64   zstep, limits_d
-00034730: 6c2c 0a20 2020 2020 2020 2020 2020 2020  l,.             
-00034740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034750: 2020 2020 2020 2020 2054 7275 652c 2030           True, 0
-00034760: 2c20 2320 6469 7363 7265 7469 7a65 2069  , # discretize i
-00034770: 6e20 6162 736f 6c75 7465 206d 6f64 650a  n absolute mode.
-00034780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000347a0: 2020 2020 2020 6d61 7267 696e 2c20 2664        margin, &d
-000347b0: 6973 635f 7a2c 2072 6573 6f5f 7a2c 2026  isc_z, reso_z, &
-000347c0: 6c69 6e64 6578 5f7a 2c0a 2020 2020 2020  lindex_z,.      
-000347d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000347e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000347f0: 6e63 656c 6c73 5f7a 290a 2020 2020 2320  ncells_z).    # 
-00034800: 2e2e 2050 7265 7061 7269 6e67 2066 6f72  .. Preparing for
-00034810: 2070 6869 3a20 6765 7420 7468 6520 6c69   phi: get the li
-00034820: 6d69 7473 2069 6620 616e 7920 616e 6420  mits if any and 
-00034830: 6d61 6b65 2073 7572 6520 746f 2072 6570  make sure to rep
-00034840: 6c61 6365 2074 6865 6d0a 2020 2020 2320  lace them.    # 
-00034850: 2e2e 2069 6e20 7468 6520 7072 6f70 6572  .. in the proper
-00034860: 2071 7561 6472 616e 7473 202e 2e2e 2e2e   quadrants .....
-00034870: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00034880: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00034890: 2e2e 2e2e 2e2e 2e2e 2e2e 0a20 2020 2069  ...........    i
-000348a0: 6620 4450 6869 2069 7320 4e6f 6e65 3a0a  f DPhi is None:.
-000348b0: 2020 2020 2020 2020 6d69 6e5f 7068 6920          min_phi 
-000348c0: 3d20 2d63 5f70 690a 2020 2020 2020 2020  = -c_pi.        
-000348d0: 6d61 785f 7068 6920 3d20 635f 7069 0a20  max_phi = c_pi. 
-000348e0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000348f0: 206d 696e 5f70 6869 203d 2044 5068 695b   min_phi = DPhi[
-00034900: 305d 2023 2074 6f20 6176 6f69 6420 636f  0] # to avoid co
-00034910: 6e76 6572 7369 6f6e 730a 2020 2020 2020  nversions.      
-00034920: 2020 6d69 6e5f 7068 6920 3d20 635f 6174    min_phi = c_at
-00034930: 616e 3228 635f 7369 6e28 6d69 6e5f 7068  an2(c_sin(min_ph
-00034940: 6929 2c20 635f 636f 7328 6d69 6e5f 7068  i), c_cos(min_ph
-00034950: 6929 290a 2020 2020 2020 2020 6d61 785f  i)).        max_
-00034960: 7068 6920 3d20 4450 6869 5b31 5d20 2320  phi = DPhi[1] # 
-00034970: 746f 2061 766f 6964 2063 6f6e 7665 7273  to avoid convers
-00034980: 696f 6e73 0a20 2020 2020 2020 206d 6178  ions.        max
-00034990: 5f70 6869 203d 2063 5f61 7461 6e32 2863  _phi = c_atan2(c
-000349a0: 5f73 696e 286d 6178 5f70 6869 292c 2063  _sin(max_phi), c
-000349b0: 5f63 6f73 286d 6178 5f70 6869 2929 0a20  _cos(max_phi)). 
-000349c0: 2020 2023 202e 2e20 496e 6974 6961 6c69     # .. Initiali
-000349d0: 7a61 7469 6f6e 202e 2e2e 2e2e 2e2e 2e2e  zation .........
-000349e0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-000349f0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00034a00: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e0a  ................
-00034a10: 2020 2020 737a 5f70 6869 203d 203c 6c6f      sz_phi = <lo
-00034a20: 6e67 2a3e 6d61 6c6c 6f63 2873 7a5f 722a  ng*>malloc(sz_r*
-00034a30: 7369 7a65 6f66 286c 6f6e 6729 290a 2020  sizeof(long)).  
-00034a40: 2020 6e63 656c 6c73 5f72 7068 6920 203d    ncells_rphi  =
-00034a50: 203c 6c6f 6e67 2a3e 6d61 6c6c 6f63 2873   <long*>malloc(s
-00034a60: 7a5f 722a 7369 7a65 6f66 286c 6f6e 6729  z_r*sizeof(long)
-00034a70: 290a 2020 2020 7374 6570 5f72 7068 6920  ).    step_rphi 
-00034a80: 2020 203d 203c 646f 7562 6c65 2a3e 6d61     = <double*>ma
-00034a90: 6c6c 6f63 2873 7a5f 722a 7369 7a65 6f66  lloc(sz_r*sizeof
-00034aa0: 2864 6f75 626c 6529 290a 2020 2020 725f  (double)).    r_
-00034ab0: 7261 7469 6f20 3d20 3c69 6e74 3e28 635f  ratio = <int>(c_
-00034ac0: 6365 696c 2864 6973 635f 725b 737a 5f72  ceil(disc_r[sz_r
-00034ad0: 202d 2031 5d20 2f20 6469 7363 5f72 5b30   - 1] / disc_r[0
-00034ae0: 5d29 290a 2020 2020 7477 6f70 695f 6f76  ])).    twopi_ov
-00034af0: 6572 5f64 7068 6920 3d20 5f54 574f 5049  er_dphi = _TWOPI
-00034b00: 202f 2070 6869 7374 6570 0a20 2020 2069   / phistep.    i
-00034b10: 6e64 5f6c 6f63 5f72 3020 3d20 300a 2020  nd_loc_r0 = 0.  
-00034b20: 2020 6d69 6e5f 7068 695f 7069 203d 206d    min_phi_pi = m
-00034b30: 696e 5f70 6869 202b 2063 5f70 690a 2020  in_phi + c_pi.  
-00034b40: 2020 6d61 785f 7068 695f 7069 203d 206d    max_phi_pi = m
-00034b50: 6178 5f70 6869 202b 2063 5f70 690a 2020  ax_phi + c_pi.  
-00034b60: 2020 6162 7330 203d 2063 5f61 6273 286d    abs0 = c_abs(m
-00034b70: 696e 5f70 6869 5f70 6929 0a20 2020 2061  in_phi_pi).    a
-00034b80: 6273 3120 3d20 635f 6162 7328 6d61 785f  bs1 = c_abs(max_
-00034b90: 7068 695f 7069 290a 2020 2020 2320 2e2e  phi_pi).    # ..
-00034ba0: 2e20 646f 696e 6720 3020 6c6f 6f70 2062  . doing 0 loop b
-00034bb0: 6566 6f72 6520 2e2e 2e2e 2e2e 2e2e 2e2e  efore ..........
-00034bc0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00034bd0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00034be0: 2e2e 2e2e 2e2e 2e2e 0a20 2020 2069 6620  .........    if 
-00034bf0: 6d69 6e5f 7068 6920 3c20 6d61 785f 7068  min_phi < max_ph
-00034c00: 693a 0a20 2020 2020 2020 2023 2047 6574  i:.        # Get
-00034c10: 2074 6865 2061 6374 7561 6c20 5250 6869   the actual RPhi
-00034c20: 2072 6573 6f6c 7574 696f 6e20 616e 6420   resolution and 
-00034c30: 5068 6920 6d65 7368 2065 6c65 6d65 6e74  Phi mesh element
-00034c40: 7320 2821 2064 6570 656e 6473 206f 6e20  s (! depends on 
-00034c50: 5221 290a 2020 2020 2020 2020 6e63 656c  R!).        ncel
-00034c60: 6c73 5f72 7068 695b 305d 203d 203c 696e  ls_rphi[0] = <in
-00034c70: 743e 635f 6365 696c 2874 776f 7069 5f6f  t>c_ceil(twopi_o
-00034c80: 7665 725f 6470 6869 202a 2064 6973 635f  ver_dphi * disc_
-00034c90: 725b 305d 290a 2020 2020 2020 2020 6c6f  r[0]).        lo
-00034ca0: 635f 6e63 5f72 7068 6920 3d20 6e63 656c  c_nc_rphi = ncel
-00034cb0: 6c73 5f72 7068 695b 305d 0a20 2020 2020  ls_rphi[0].     
-00034cc0: 2020 2073 7465 705f 7270 6869 5b30 5d20     step_rphi[0] 
-00034cd0: 3d20 5f54 574f 5049 202f 206e 6365 6c6c  = _TWOPI / ncell
-00034ce0: 735f 7270 6869 5b30 5d0a 2020 2020 2020  s_rphi[0].      
-00034cf0: 2020 696e 765f 6472 7068 6920 3d20 312e    inv_drphi = 1.
-00034d00: 202f 2073 7465 705f 7270 6869 5b30 5d0a   / step_rphi[0].
-00034d10: 2020 2020 2020 2020 2320 4765 7420 696e          # Get in
-00034d20: 6465 7820 616e 6420 6375 6d75 6c61 7465  dex and cumulate
-00034d30: 6420 696e 6469 6365 7320 6672 6f6d 2062  d indices from b
-00034d40: 6163 6b67 726f 756e 640a 2020 2020 2020  ackground.      
-00034d50: 2020 666f 7220 6a6a 2069 6e20 7261 6e67    for jj in rang
-00034d60: 6528 696e 645f 6c6f 635f 7230 2c20 6e63  e(ind_loc_r0, nc
-00034d70: 656c 6c73 5f72 305b 305d 293a 0a20 2020  ells_r0[0]):.   
-00034d80: 2020 2020 2020 2020 2069 6620 6469 7363           if disc
-00034d90: 5f72 305b 6a6a 5d3d 3d64 6973 635f 725b  _r0[jj]==disc_r[
-00034da0: 305d 3a0a 2020 2020 2020 2020 2020 2020  0]:.            
-00034db0: 2020 2020 696e 645f 6c6f 635f 7230 203d      ind_loc_r0 =
-00034dc0: 206a 6a0a 2020 2020 2020 2020 2020 2020   jj.            
-00034dd0: 2020 2020 6272 6561 6b0a 2020 2020 2020      break.      
-00034de0: 2020 2320 4765 7420 696e 6469 6365 7320    # Get indices 
-00034df0: 6f66 2070 6869 0a20 2020 2020 2020 2023  of phi.        #
-00034e00: 2047 6574 2074 6865 2065 7874 7265 6d65   Get the extreme
-00034e10: 2069 6e64 6963 6573 206f 6620 7468 6520   indices of the 
-00034e20: 6d65 7368 2065 6c65 6d65 6e74 7320 7468  mesh elements th
-00034e30: 6174 2072 6561 6c6c 7920 6e65 6564 2074  at really need t
-00034e40: 6f0a 2020 2020 2020 2020 2320 6265 2063  o.        # be c
-00034e50: 7265 6174 6564 2077 6974 6869 6e20 7468  reated within th
-00034e60: 6f73 6520 6c69 6d69 7473 0a20 2020 2020  ose limits.     
-00034e70: 2020 2069 6620 6162 7330 202d 2073 7465     if abs0 - ste
-00034e80: 705f 7270 6869 5b30 5d2a 635f 666c 6f6f  p_rphi[0]*c_floo
-00034e90: 7228 6162 7330 202a 2069 6e76 5f64 7270  r(abs0 * inv_drp
-00034ea0: 6869 2920 3c20 6d61 7267 696e 2a73 7465  hi) < margin*ste
-00034eb0: 705f 7270 6869 5b30 5d3a 0a20 2020 2020  p_rphi[0]:.     
-00034ec0: 2020 2020 2020 206e 7068 6930 203d 2069         nphi0 = i
-00034ed0: 6e74 2863 5f72 6f75 6e64 2828 6d69 6e5f  nt(c_round((min_
-00034ee0: 7068 6920 2b20 635f 7069 2920 2a20 696e  phi + c_pi) * in
-00034ef0: 765f 6472 7068 6929 290a 2020 2020 2020  v_drphi)).      
-00034f00: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00034f10: 2020 2020 6e70 6869 3020 3d20 696e 7428      nphi0 = int(
-00034f20: 635f 666c 6f6f 7228 286d 696e 5f70 6869  c_floor((min_phi
-00034f30: 202b 635f 7069 2920 2a20 696e 765f 6472   +c_pi) * inv_dr
-00034f40: 7068 6929 290a 2020 2020 2020 2020 6966  phi)).        if
-00034f50: 2061 6273 312d 7374 6570 5f72 7068 695b   abs1-step_rphi[
-00034f60: 305d 2a63 5f66 6c6f 6f72 2861 6273 3120  0]*c_floor(abs1 
-00034f70: 2a20 696e 765f 6472 7068 6929 203c 206d  * inv_drphi) < m
-00034f80: 6172 6769 6e2a 7374 6570 5f72 7068 695b  argin*step_rphi[
-00034f90: 305d 3a0a 2020 2020 2020 2020 2020 2020  0]:.            
-00034fa0: 6e70 6869 3120 3d20 696e 7428 635f 726f  nphi1 = int(c_ro
-00034fb0: 756e 6428 286d 6178 5f70 6869 2b63 5f70  und((max_phi+c_p
-00034fc0: 6929 202a 2069 6e76 5f64 7270 6869 292d  i) * inv_drphi)-
-00034fd0: 3129 0a20 2020 2020 2020 2065 6c73 653a  1).        else:
-00034fe0: 0a20 2020 2020 2020 2020 2020 206e 7068  .            nph
-00034ff0: 6931 203d 2069 6e74 2863 5f66 6c6f 6f72  i1 = int(c_floor
-00035000: 2828 6d61 785f 7068 692b 635f 7069 2920  ((max_phi+c_pi) 
-00035010: 2a20 696e 765f 6472 7068 6929 290a 2020  * inv_drphi)).  
-00035020: 2020 2020 2020 737a 5f70 6869 5b30 5d20        sz_phi[0] 
-00035030: 3d20 6e70 6869 3120 2b20 3120 2d20 6e70  = nphi1 + 1 - np
-00035040: 6869 300a 2020 2020 2020 2020 6d61 785f  hi0.        max_
-00035050: 737a 5f70 6869 5b30 5d20 3d20 737a 5f70  sz_phi[0] = sz_p
-00035060: 6869 5b30 5d0a 2020 2020 2020 2020 696e  hi[0].        in
-00035070: 645f 6920 3d20 2d6e 702e 6f6e 6573 2828  d_i = -np.ones((
-00035080: 737a 5f72 2c20 737a 5f70 6869 5b30 5d20  sz_r, sz_phi[0] 
-00035090: 2a20 725f 7261 7469 6f20 2b20 3129 2c20  * r_ratio + 1), 
-000350a0: 6474 7970 653d 696e 7429 0a20 2020 2020  dtype=int).     
-000350b0: 2020 2069 6e64 695f 6d76 203d 2069 6e64     indi_mv = ind
-000350c0: 5f69 0a20 2020 2020 2020 2066 6f72 206a  _i.        for j
-000350d0: 6a20 696e 2072 616e 6765 2873 7a5f 7068  j in range(sz_ph
-000350e0: 695b 305d 293a 0a20 2020 2020 2020 2020  i[0]):.         
-000350f0: 2020 2069 6e64 695f 6d76 5b30 2c20 6a6a     indi_mv[0, jj
-00035100: 5d20 3d20 6e70 6869 3020 2b20 6a6a 0a20  ] = nphi0 + jj. 
-00035110: 2020 2020 2020 206e 7074 735f 6469 7363         npts_disc
-00035120: 202b 3d20 737a 5f7a 202a 2073 7a5f 7068   += sz_z * sz_ph
-00035130: 695b 305d 0a20 2020 2065 6c73 653a 0a20  i[0].    else:. 
-00035140: 2020 2020 2020 2023 2047 6574 2074 6865         # Get the
-00035150: 2061 6374 7561 6c20 5250 6869 2072 6573   actual RPhi res
-00035160: 6f6c 7574 696f 6e20 616e 6420 5068 6920  olution and Phi 
-00035170: 6d65 7368 2065 6c65 6d65 6e74 7320 2821  mesh elements (!
-00035180: 2064 6570 656e 6473 206f 6e20 5221 290a   depends on R!).
-00035190: 2020 2020 2020 2020 6e63 656c 6c73 5f72          ncells_r
-000351a0: 7068 695b 305d 203d 203c 696e 743e 635f  phi[0] = <int>c_
-000351b0: 6365 696c 2874 776f 7069 5f6f 7665 725f  ceil(twopi_over_
-000351c0: 6470 6869 202a 2064 6973 635f 725b 305d  dphi * disc_r[0]
-000351d0: 290a 2020 2020 2020 2020 6c6f 635f 6e63  ).        loc_nc
-000351e0: 5f72 7068 6920 3d20 6e63 656c 6c73 5f72  _rphi = ncells_r
-000351f0: 7068 695b 305d 0a20 2020 2020 2020 2073  phi[0].        s
-00035200: 7465 705f 7270 6869 5b30 5d20 3d20 5f54  tep_rphi[0] = _T
-00035210: 574f 5049 202f 206e 6365 6c6c 735f 7270  WOPI / ncells_rp
-00035220: 6869 5b30 5d0a 2020 2020 2020 2020 696e  hi[0].        in
-00035230: 765f 6472 7068 6920 3d20 312e 202f 2073  v_drphi = 1. / s
-00035240: 7465 705f 7270 6869 5b30 5d0a 2020 2020  tep_rphi[0].    
-00035250: 2020 2020 2320 4765 7420 696e 6465 7820      # Get index 
-00035260: 616e 6420 6375 6d75 6c61 7465 6420 696e  and cumulated in
-00035270: 6469 6365 7320 6672 6f6d 2062 6163 6b67  dices from backg
-00035280: 726f 756e 640a 2020 2020 2020 2020 666f  round.        fo
-00035290: 7220 6a6a 2069 6e20 7261 6e67 6528 696e  r jj in range(in
-000352a0: 645f 6c6f 635f 7230 2c20 6e63 656c 6c73  d_loc_r0, ncells
-000352b0: 5f72 305b 305d 293a 0a20 2020 2020 2020  _r0[0]):.       
-000352c0: 2020 2020 2069 6620 6469 7363 5f72 305b       if disc_r0[
-000352d0: 6a6a 5d3d 3d64 6973 635f 725b 305d 3a0a  jj]==disc_r[0]:.
-000352e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000352f0: 696e 645f 6c6f 635f 7230 203d 206a 6a0a  ind_loc_r0 = jj.
-00035300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035310: 6272 6561 6b0a 2020 2020 2020 2020 2320  break.        # 
-00035320: 4765 7420 696e 6469 6365 7320 6f66 2070  Get indices of p
-00035330: 6869 0a20 2020 2020 2020 2023 2047 6574  hi.        # Get
-00035340: 2074 6865 2065 7874 7265 6d65 2069 6e64   the extreme ind
-00035350: 6963 6573 206f 6620 7468 6520 6d65 7368  ices of the mesh
-00035360: 2065 6c65 6d65 6e74 7320 7468 6174 2072   elements that r
-00035370: 6561 6c6c 7920 6e65 6564 2074 6f0a 2020  eally need to.  
-00035380: 2020 2020 2020 2320 6265 2063 7265 6174        # be creat
-00035390: 6564 2077 6974 6869 6e20 7468 6f73 6520  ed within those 
-000353a0: 6c69 6d69 7473 0a20 2020 2020 2020 2069  limits.        i
-000353b0: 6620 6162 7330 202d 2073 7465 705f 7270  f abs0 - step_rp
-000353c0: 6869 5b30 5d2a 635f 666c 6f6f 7228 6162  hi[0]*c_floor(ab
-000353d0: 7330 202a 2069 6e76 5f64 7270 6869 2920  s0 * inv_drphi) 
-000353e0: 3c20 6d61 7267 696e 2a73 7465 705f 7270  < margin*step_rp
-000353f0: 6869 5b30 5d3a 0a20 2020 2020 2020 2020  hi[0]:.         
-00035400: 2020 206e 7068 6930 203d 2069 6e74 2863     nphi0 = int(c
-00035410: 5f72 6f75 6e64 2828 6d69 6e5f 7068 6920  _round((min_phi 
-00035420: 2b20 635f 7069 2920 2a20 696e 765f 6472  + c_pi) * inv_dr
-00035430: 7068 6929 290a 2020 2020 2020 2020 656c  phi)).        el
-00035440: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00035450: 6e70 6869 3020 3d20 696e 7428 635f 666c  nphi0 = int(c_fl
-00035460: 6f6f 7228 286d 696e 5f70 6869 202b 2063  oor((min_phi + c
-00035470: 5f70 6929 202a 2069 6e76 5f64 7270 6869  _pi) * inv_drphi
-00035480: 2929 0a20 2020 2020 2020 2069 6620 6162  )).        if ab
-00035490: 7331 2d73 7465 705f 7270 6869 5b30 5d2a  s1-step_rphi[0]*
-000354a0: 635f 666c 6f6f 7228 6162 7331 202a 2069  c_floor(abs1 * i
-000354b0: 6e76 5f64 7270 6869 2920 3c20 6d61 7267  nv_drphi) < marg
-000354c0: 696e 2a73 7465 705f 7270 6869 5b30 5d3a  in*step_rphi[0]:
-000354d0: 0a20 2020 2020 2020 2020 2020 206e 7068  .            nph
-000354e0: 6931 203d 2069 6e74 2863 5f72 6f75 6e64  i1 = int(c_round
-000354f0: 2828 6d61 785f 7068 692b 635f 7069 2920  ((max_phi+c_pi) 
-00035500: 2a20 696e 765f 6472 7068 6929 2d31 290a  * inv_drphi)-1).
-00035510: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00035520: 2020 2020 2020 2020 2020 6e70 6869 3120            nphi1 
-00035530: 3d20 696e 7428 635f 666c 6f6f 7228 286d  = int(c_floor((m
-00035540: 6178 5f70 6869 2b63 5f70 6929 202a 2069  ax_phi+c_pi) * i
-00035550: 6e76 5f64 7270 6869 2929 0a20 2020 2020  nv_drphi)).     
-00035560: 2020 2073 7a5f 7068 695b 305d 203d 206e     sz_phi[0] = n
-00035570: 7068 6931 2b31 2b6c 6f63 5f6e 635f 7270  phi1+1+loc_nc_rp
-00035580: 6869 2d6e 7068 6930 0a20 2020 2020 2020  hi-nphi0.       
-00035590: 206d 6178 5f73 7a5f 7068 695b 305d 203d   max_sz_phi[0] =
-000355a0: 2073 7a5f 7068 695b 305d 0a20 2020 2020   sz_phi[0].     
-000355b0: 2020 2069 6e64 5f69 203d 202d 6e70 2e6f     ind_i = -np.o
-000355c0: 6e65 7328 2873 7a5f 722c 2073 7a5f 7068  nes((sz_r, sz_ph
-000355d0: 695b 305d 202a 2072 5f72 6174 696f 202b  i[0] * r_ratio +
-000355e0: 2031 292c 2064 7479 7065 3d69 6e74 290a   1), dtype=int).
-000355f0: 2020 2020 2020 2020 696e 6469 5f6d 7620          indi_mv 
-00035600: 3d20 696e 645f 690a 2020 2020 2020 2020  = ind_i.        
-00035610: 666f 7220 6a6a 2069 6e20 7261 6e67 6528  for jj in range(
-00035620: 6c6f 635f 6e63 5f72 7068 6920 2d20 6e70  loc_nc_rphi - np
-00035630: 6869 3029 3a0a 2020 2020 2020 2020 2020  hi0):.          
-00035640: 2020 696e 6469 5f6d 765b 302c 206a 6a5d    indi_mv[0, jj]
-00035650: 203d 206e 7068 6930 202b 206a 6a0a 2020   = nphi0 + jj.  
-00035660: 2020 2020 2020 666f 7220 6a6a 2069 6e20        for jj in 
-00035670: 7261 6e67 6528 6c6f 635f 6e63 5f72 7068  range(loc_nc_rph
-00035680: 6920 2d20 6e70 6869 302c 2073 7a5f 7068  i - nphi0, sz_ph
-00035690: 695b 305d 293a 0a20 2020 2020 2020 2020  i[0]):.         
-000356a0: 2020 2069 6e64 695f 6d76 5b30 2c20 6a6a     indi_mv[0, jj
-000356b0: 5d20 3d20 6a6a 202d 2028 6c6f 635f 6e63  ] = jj - (loc_nc
-000356c0: 5f72 7068 6920 2d20 6e70 6869 3029 0a20  _rphi - nphi0). 
-000356d0: 2020 2020 2020 206e 7074 735f 6469 7363         npts_disc
-000356e0: 202b 3d20 737a 5f7a 202a 2073 7a5f 7068   += sz_z * sz_ph
-000356f0: 695b 305d 0a20 2020 2023 202e 2e2e 2064  i[0].    # ... d
-00035700: 6f69 6e67 2074 6865 206f 7468 6572 7320  oing the others 
-00035710: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00035720: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00035730: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00035740: 2e2e 2e2e 2e0a 2020 2020 6e70 7473 5f64  ......    npts_d
-00035750: 6973 6320 2b3d 205f 7374 2e73 615f 6469  isc += _st.sa_di
-00035760: 7363 5f70 6869 2873 7a5f 722c 2073 7a5f  sc_phi(sz_r, sz_
-00035770: 7a2c 206e 6365 6c6c 735f 7270 6869 2c20  z, ncells_rphi, 
-00035780: 7068 6973 7465 702c 0a20 2020 2020 2020  phistep,.       
-00035790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000357a0: 2020 2020 2020 2020 2020 6469 7363 5f72            disc_r
-000357b0: 2c20 6469 7363 5f72 302c 2073 7465 705f  , disc_r0, step_
-000357c0: 7270 6869 2c0a 2020 2020 2020 2020 2020  rphi,.          
-000357d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000357e0: 2020 2020 2020 2069 6e64 5f6c 6f63 5f72         ind_loc_r
-000357f0: 302c 0a20 2020 2020 2020 2020 2020 2020  0,.             
+00034290: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+000342a0: 0a20 2020 2073 7a5f 7020 3d20 7061 7274  .    sz_p = part
+000342b0: 5f63 6f6f 7264 732e 7368 6170 655b 315d  _coords.shape[1]
+000342c0: 0a20 2020 2023 2023 202e 2e20 4368 6563  .    # # .. Chec
+000342d0: 6b20 6966 2070 6f69 6e74 7320 6172 6520  k if points are 
+000342e0: 7669 7369 626c 6520 2e2e 2e2e 2e2e 2e2e  visible ........
+000342f0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00034300: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00034310: 2e2e 2e0a 2020 2020 2320 4765 7420 7468  ....    # Get th
+00034320: 6520 6163 7475 616c 2052 2061 6e64 205a  e actual R and Z
+00034330: 2072 6573 6f6c 7574 696f 6e73 2061 6e64   resolutions and
+00034340: 206d 6573 6820 656c 656d 656e 7473 0a20   mesh elements. 
+00034350: 2020 2023 202e 2e20 4669 7273 7420 7765     # .. First we
+00034360: 2064 6973 6372 6574 697a 6520 5220 7769   discretize R wi
+00034370: 7468 6f75 7420 6c69 6d69 7473 202e 2e2e  thout limits ...
+00034380: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00034390: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e0a  ................
+000343a0: 2020 2020 5f73 742e 6379 7468 6f6e 697a      _st.cythoniz
+000343b0: 655f 7375 6264 6f6d 6169 6e5f 646c 284e  e_subdomain_dl(N
+000343c0: 6f6e 652c 206c 696d 6974 735f 646c 2920  one, limits_dl) 
+000343d0: 2320 6e6f 206c 696d 6974 730a 2020 2020  # no limits.    
+000343e0: 5f20 3d20 5f73 742e 6469 7363 7265 7469  _ = _st.discreti
+000343f0: 7a65 5f6c 696e 6531 645f 636f 7265 2826  ze_line1d_core(&
+00034400: 524d 696e 4d61 785b 305d 2c20 7273 7465  RMinMax[0], rste
+00034410: 702c 206c 696d 6974 735f 646c 2c0a 2020  p, limits_dl,.  
+00034420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034440: 2054 7275 652c 2030 2c20 2320 6469 7363   True, 0, # disc
+00034450: 7265 7469 7a65 2069 6e20 6162 736f 6c75  retize in absolu
+00034460: 7465 206d 6f64 650a 2020 2020 2020 2020  te mode.        
+00034470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034480: 2020 2020 2020 2020 2020 206d 6172 6769             margi
+00034490: 6e2c 2026 6469 7363 5f72 302c 2072 6573  n, &disc_r0, res
+000344a0: 6f5f 7230 2c20 266c 696e 6465 782c 0a20  o_r0, &lindex,. 
+000344b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000344c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000344d0: 2020 6e63 656c 6c73 5f72 3029 0a20 2020    ncells_r0).   
+000344e0: 2066 7265 6528 6c69 6e64 6578 2920 2320   free(lindex) # 
+000344f0: 6765 7474 696e 6720 7269 6420 6f66 2074  getting rid of t
+00034500: 6869 6e67 7320 7765 2064 6f6e 7420 6e65  hings we dont ne
+00034510: 6564 0a20 2020 206c 696e 6465 7820 3d20  ed.    lindex = 
+00034520: 4e55 4c4c 0a20 2020 2023 202e 2e20 4e6f  NULL.    # .. No
+00034530: 7720 7468 6520 6163 7475 616c 2052 206c  w the actual R l
+00034540: 696d 6974 6564 2020 2e2e 2e2e 2e2e 2e2e  imited  ........
+00034550: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00034560: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00034570: 2e2e 2e2e 2e0a 2020 2020 5f73 742e 6379  ......    _st.cy
+00034580: 7468 6f6e 697a 655f 7375 6264 6f6d 6169  thonize_subdomai
+00034590: 6e5f 646c 2844 522c 206c 696d 6974 735f  n_dl(DR, limits_
+000345a0: 646c 290a 2020 2020 737a 5f72 203d 205f  dl).    sz_r = _
+000345b0: 7374 2e64 6973 6372 6574 697a 655f 6c69  st.discretize_li
+000345c0: 6e65 3164 5f63 6f72 6528 2652 4d69 6e4d  ne1d_core(&RMinM
+000345d0: 6178 5b30 5d2c 2072 7374 6570 2c20 6c69  ax[0], rstep, li
+000345e0: 6d69 7473 5f64 6c2c 0a20 2020 2020 2020  mits_dl,.       
+000345f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034600: 2020 2020 2020 2020 2020 2020 2020 2054                 T
+00034610: 7275 652c 2030 2c20 2320 6469 7363 7265  rue, 0, # discre
+00034620: 7469 7a65 2069 6e20 6162 736f 6c75 7465  tize in absolute
+00034630: 206d 6f64 650a 2020 2020 2020 2020 2020   mode.          
+00034640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034650: 2020 2020 2020 2020 2020 2020 6d61 7267              marg
+00034660: 696e 2c20 2664 6973 635f 722c 2072 6573  in, &disc_r, res
+00034670: 6f5f 722c 2026 6c69 6e64 6578 2c0a 2020  o_r, &lindex,.  
+00034680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000346a0: 2020 2020 6e63 656c 6c73 5f72 290a 2020      ncells_r).  
+000346b0: 2020 6672 6565 286c 696e 6465 7829 2023    free(lindex) #
+000346c0: 2067 6574 7469 6e67 2072 6964 206f 6620   getting rid of 
+000346d0: 7468 696e 6773 2077 6520 646f 6e74 206e  things we dont n
+000346e0: 6565 640a 2020 2020 2320 2e2e 204e 6f77  eed.    # .. Now
+000346f0: 205a 202e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e   Z .............
+00034700: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00034710: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00034720: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00034730: 2e2e 2e2e 0a20 2020 205f 7374 2e63 7974  .....    _st.cyt
+00034740: 686f 6e69 7a65 5f73 7562 646f 6d61 696e  honize_subdomain
+00034750: 5f64 6c28 445a 2c20 6c69 6d69 7473 5f64  _dl(DZ, limits_d
+00034760: 6c29 0a20 2020 2073 7a5f 7a20 3d20 5f73  l).    sz_z = _s
+00034770: 742e 6469 7363 7265 7469 7a65 5f6c 696e  t.discretize_lin
+00034780: 6531 645f 636f 7265 2826 5a4d 696e 4d61  e1d_core(&ZMinMa
+00034790: 785b 305d 2c20 7a73 7465 702c 206c 696d  x[0], zstep, lim
+000347a0: 6974 735f 646c 2c0a 2020 2020 2020 2020  its_dl,.        
+000347b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000347c0: 2020 2020 2020 2020 2020 2020 2020 5472                Tr
+000347d0: 7565 2c20 302c 2023 2064 6973 6372 6574  ue, 0, # discret
+000347e0: 697a 6520 696e 2061 6273 6f6c 7574 6520  ize in absolute 
+000347f0: 6d6f 6465 0a20 2020 2020 2020 2020 2020  mode.           
+00034800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034810: 2020 2020 2020 2020 2020 206d 6172 6769             margi
+00034820: 6e2c 2026 6469 7363 5f7a 2c20 7265 736f  n, &disc_z, reso
+00034830: 5f7a 2c20 266c 696e 6465 785f 7a2c 0a20  _z, &lindex_z,. 
+00034840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034860: 2020 2020 206e 6365 6c6c 735f 7a29 0a20       ncells_z). 
+00034870: 2020 2023 202e 2e20 5072 6570 6172 696e     # .. Preparin
+00034880: 6720 666f 7220 7068 693a 2067 6574 2074  g for phi: get t
+00034890: 6865 206c 696d 6974 7320 6966 2061 6e79  he limits if any
+000348a0: 2061 6e64 206d 616b 6520 7375 7265 2074   and make sure t
+000348b0: 6f20 7265 706c 6163 6520 7468 656d 0a20  o replace them. 
+000348c0: 2020 2023 202e 2e20 696e 2074 6865 2070     # .. in the p
+000348d0: 726f 7065 7220 7175 6164 7261 6e74 7320  roper quadrants 
+000348e0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+000348f0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00034900: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e0a  ................
+00034910: 2020 2020 6966 2044 5068 6920 6973 204e      if DPhi is N
+00034920: 6f6e 653a 0a20 2020 2020 2020 206d 696e  one:.        min
+00034930: 5f70 6869 203d 202d 635f 7069 0a20 2020  _phi = -c_pi.   
+00034940: 2020 2020 206d 6178 5f70 6869 203d 2063       max_phi = c
+00034950: 5f70 690a 2020 2020 656c 7365 3a0a 2020  _pi.    else:.  
+00034960: 2020 2020 2020 6d69 6e5f 7068 6920 3d20        min_phi = 
+00034970: 4450 6869 5b30 5d20 2320 746f 2061 766f  DPhi[0] # to avo
+00034980: 6964 2063 6f6e 7665 7273 696f 6e73 0a20  id conversions. 
+00034990: 2020 2020 2020 206d 696e 5f70 6869 203d         min_phi =
+000349a0: 2063 5f61 7461 6e32 2863 5f73 696e 286d   c_atan2(c_sin(m
+000349b0: 696e 5f70 6869 292c 2063 5f63 6f73 286d  in_phi), c_cos(m
+000349c0: 696e 5f70 6869 2929 0a20 2020 2020 2020  in_phi)).       
+000349d0: 206d 6178 5f70 6869 203d 2044 5068 695b   max_phi = DPhi[
+000349e0: 315d 2023 2074 6f20 6176 6f69 6420 636f  1] # to avoid co
+000349f0: 6e76 6572 7369 6f6e 730a 2020 2020 2020  nversions.      
+00034a00: 2020 6d61 785f 7068 6920 3d20 635f 6174    max_phi = c_at
+00034a10: 616e 3228 635f 7369 6e28 6d61 785f 7068  an2(c_sin(max_ph
+00034a20: 6929 2c20 635f 636f 7328 6d61 785f 7068  i), c_cos(max_ph
+00034a30: 6929 290a 2020 2020 2320 2e2e 2049 6e69  i)).    # .. Ini
+00034a40: 7469 616c 697a 6174 696f 6e20 2e2e 2e2e  tialization ....
+00034a50: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00034a60: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00034a70: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00034a80: 2e2e 2e2e 0a20 2020 2073 7a5f 7068 6920  .....    sz_phi 
+00034a90: 3d20 3c6c 6f6e 672a 3e6d 616c 6c6f 6328  = <long*>malloc(
+00034aa0: 737a 5f72 2a73 697a 656f 6628 6c6f 6e67  sz_r*sizeof(long
+00034ab0: 2929 0a20 2020 206e 6365 6c6c 735f 7270  )).    ncells_rp
+00034ac0: 6869 2020 3d20 3c6c 6f6e 672a 3e6d 616c  hi  = <long*>mal
+00034ad0: 6c6f 6328 737a 5f72 2a73 697a 656f 6628  loc(sz_r*sizeof(
+00034ae0: 6c6f 6e67 2929 0a20 2020 2073 7465 705f  long)).    step_
+00034af0: 7270 6869 2020 2020 3d20 3c64 6f75 626c  rphi    = <doubl
+00034b00: 652a 3e6d 616c 6c6f 6328 737a 5f72 2a73  e*>malloc(sz_r*s
+00034b10: 697a 656f 6628 646f 7562 6c65 2929 0a20  izeof(double)). 
+00034b20: 2020 2072 5f72 6174 696f 203d 203c 696e     r_ratio = <in
+00034b30: 743e 2863 5f63 6569 6c28 6469 7363 5f72  t>(c_ceil(disc_r
+00034b40: 5b73 7a5f 7220 2d20 315d 202f 2064 6973  [sz_r - 1] / dis
+00034b50: 635f 725b 305d 2929 0a20 2020 2074 776f  c_r[0])).    two
+00034b60: 7069 5f6f 7665 725f 6470 6869 203d 205f  pi_over_dphi = _
+00034b70: 5457 4f50 4920 2f20 7068 6973 7465 700a  TWOPI / phistep.
+00034b80: 2020 2020 696e 645f 6c6f 635f 7230 203d      ind_loc_r0 =
+00034b90: 2030 0a20 2020 206d 696e 5f70 6869 5f70   0.    min_phi_p
+00034ba0: 6920 3d20 6d69 6e5f 7068 6920 2b20 635f  i = min_phi + c_
+00034bb0: 7069 0a20 2020 206d 6178 5f70 6869 5f70  pi.    max_phi_p
+00034bc0: 6920 3d20 6d61 785f 7068 6920 2b20 635f  i = max_phi + c_
+00034bd0: 7069 0a20 2020 2061 6273 3020 3d20 635f  pi.    abs0 = c_
+00034be0: 6162 7328 6d69 6e5f 7068 695f 7069 290a  abs(min_phi_pi).
+00034bf0: 2020 2020 6162 7331 203d 2063 5f61 6273      abs1 = c_abs
+00034c00: 286d 6178 5f70 6869 5f70 6929 0a20 2020  (max_phi_pi).   
+00034c10: 2023 202e 2e2e 2064 6f69 6e67 2030 206c   # ... doing 0 l
+00034c20: 6f6f 7020 6265 666f 7265 202e 2e2e 2e2e  oop before .....
+00034c30: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00034c40: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00034c50: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e0a 2020  ..............  
+00034c60: 2020 6966 206d 696e 5f70 6869 203c 206d    if min_phi < m
+00034c70: 6178 5f70 6869 3a0a 2020 2020 2020 2020  ax_phi:.        
+00034c80: 2320 4765 7420 7468 6520 6163 7475 616c  # Get the actual
+00034c90: 2052 5068 6920 7265 736f 6c75 7469 6f6e   RPhi resolution
+00034ca0: 2061 6e64 2050 6869 206d 6573 6820 656c   and Phi mesh el
+00034cb0: 656d 656e 7473 2028 2120 6465 7065 6e64  ements (! depend
+00034cc0: 7320 6f6e 2052 2129 0a20 2020 2020 2020  s on R!).       
+00034cd0: 206e 6365 6c6c 735f 7270 6869 5b30 5d20   ncells_rphi[0] 
+00034ce0: 3d20 3c69 6e74 3e63 5f63 6569 6c28 7477  = <int>c_ceil(tw
+00034cf0: 6f70 695f 6f76 6572 5f64 7068 6920 2a20  opi_over_dphi * 
+00034d00: 6469 7363 5f72 5b30 5d29 0a20 2020 2020  disc_r[0]).     
+00034d10: 2020 206c 6f63 5f6e 635f 7270 6869 203d     loc_nc_rphi =
+00034d20: 206e 6365 6c6c 735f 7270 6869 5b30 5d0a   ncells_rphi[0].
+00034d30: 2020 2020 2020 2020 7374 6570 5f72 7068          step_rph
+00034d40: 695b 305d 203d 205f 5457 4f50 4920 2f20  i[0] = _TWOPI / 
+00034d50: 6e63 656c 6c73 5f72 7068 695b 305d 0a20  ncells_rphi[0]. 
+00034d60: 2020 2020 2020 2069 6e76 5f64 7270 6869         inv_drphi
+00034d70: 203d 2031 2e20 2f20 7374 6570 5f72 7068   = 1. / step_rph
+00034d80: 695b 305d 0a20 2020 2020 2020 2023 2047  i[0].        # G
+00034d90: 6574 2069 6e64 6578 2061 6e64 2063 756d  et index and cum
+00034da0: 756c 6174 6564 2069 6e64 6963 6573 2066  ulated indices f
+00034db0: 726f 6d20 6261 636b 6772 6f75 6e64 0a20  rom background. 
+00034dc0: 2020 2020 2020 2066 6f72 206a 6a20 696e         for jj in
+00034dd0: 2072 616e 6765 2869 6e64 5f6c 6f63 5f72   range(ind_loc_r
+00034de0: 302c 206e 6365 6c6c 735f 7230 5b30 5d29  0, ncells_r0[0])
+00034df0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00034e00: 2064 6973 635f 7230 5b6a 6a5d 3d3d 6469   disc_r0[jj]==di
+00034e10: 7363 5f72 5b30 5d3a 0a20 2020 2020 2020  sc_r[0]:.       
+00034e20: 2020 2020 2020 2020 2069 6e64 5f6c 6f63           ind_loc
+00034e30: 5f72 3020 3d20 6a6a 0a20 2020 2020 2020  _r0 = jj.       
+00034e40: 2020 2020 2020 2020 2062 7265 616b 0a20           break. 
+00034e50: 2020 2020 2020 2023 2047 6574 2069 6e64         # Get ind
+00034e60: 6963 6573 206f 6620 7068 690a 2020 2020  ices of phi.    
+00034e70: 2020 2020 2320 4765 7420 7468 6520 6578      # Get the ex
+00034e80: 7472 656d 6520 696e 6469 6365 7320 6f66  treme indices of
+00034e90: 2074 6865 206d 6573 6820 656c 656d 656e   the mesh elemen
+00034ea0: 7473 2074 6861 7420 7265 616c 6c79 206e  ts that really n
+00034eb0: 6565 6420 746f 0a20 2020 2020 2020 2023  eed to.        #
+00034ec0: 2062 6520 6372 6561 7465 6420 7769 7468   be created with
+00034ed0: 696e 2074 686f 7365 206c 696d 6974 730a  in those limits.
+00034ee0: 2020 2020 2020 2020 6966 2061 6273 3020          if abs0 
+00034ef0: 2d20 7374 6570 5f72 7068 695b 305d 2a63  - step_rphi[0]*c
+00034f00: 5f66 6c6f 6f72 2861 6273 3020 2a20 696e  _floor(abs0 * in
+00034f10: 765f 6472 7068 6929 203c 206d 6172 6769  v_drphi) < margi
+00034f20: 6e2a 7374 6570 5f72 7068 695b 305d 3a0a  n*step_rphi[0]:.
+00034f30: 2020 2020 2020 2020 2020 2020 6e70 6869              nphi
+00034f40: 3020 3d20 696e 7428 635f 726f 756e 6428  0 = int(c_round(
+00034f50: 286d 696e 5f70 6869 202b 2063 5f70 6929  (min_phi + c_pi)
+00034f60: 202a 2069 6e76 5f64 7270 6869 2929 0a20   * inv_drphi)). 
+00034f70: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00034f80: 2020 2020 2020 2020 206e 7068 6930 203d           nphi0 =
+00034f90: 2069 6e74 2863 5f66 6c6f 6f72 2828 6d69   int(c_floor((mi
+00034fa0: 6e5f 7068 6920 2b63 5f70 6929 202a 2069  n_phi +c_pi) * i
+00034fb0: 6e76 5f64 7270 6869 2929 0a20 2020 2020  nv_drphi)).     
+00034fc0: 2020 2069 6620 6162 7331 2d73 7465 705f     if abs1-step_
+00034fd0: 7270 6869 5b30 5d2a 635f 666c 6f6f 7228  rphi[0]*c_floor(
+00034fe0: 6162 7331 202a 2069 6e76 5f64 7270 6869  abs1 * inv_drphi
+00034ff0: 2920 3c20 6d61 7267 696e 2a73 7465 705f  ) < margin*step_
+00035000: 7270 6869 5b30 5d3a 0a20 2020 2020 2020  rphi[0]:.       
+00035010: 2020 2020 206e 7068 6931 203d 2069 6e74       nphi1 = int
+00035020: 2863 5f72 6f75 6e64 2828 6d61 785f 7068  (c_round((max_ph
+00035030: 692b 635f 7069 2920 2a20 696e 765f 6472  i+c_pi) * inv_dr
+00035040: 7068 6929 2d31 290a 2020 2020 2020 2020  phi)-1).        
+00035050: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00035060: 2020 6e70 6869 3120 3d20 696e 7428 635f    nphi1 = int(c_
+00035070: 666c 6f6f 7228 286d 6178 5f70 6869 2b63  floor((max_phi+c
+00035080: 5f70 6929 202a 2069 6e76 5f64 7270 6869  _pi) * inv_drphi
+00035090: 2929 0a20 2020 2020 2020 2073 7a5f 7068  )).        sz_ph
+000350a0: 695b 305d 203d 206e 7068 6931 202b 2031  i[0] = nphi1 + 1
+000350b0: 202d 206e 7068 6930 0a20 2020 2020 2020   - nphi0.       
+000350c0: 206d 6178 5f73 7a5f 7068 695b 305d 203d   max_sz_phi[0] =
+000350d0: 2073 7a5f 7068 695b 305d 0a20 2020 2020   sz_phi[0].     
+000350e0: 2020 2069 6e64 5f69 203d 202d 6e70 2e6f     ind_i = -np.o
+000350f0: 6e65 7328 2873 7a5f 722c 2073 7a5f 7068  nes((sz_r, sz_ph
+00035100: 695b 305d 202a 2072 5f72 6174 696f 202b  i[0] * r_ratio +
+00035110: 2031 292c 2064 7479 7065 3d69 6e74 290a   1), dtype=int).
+00035120: 2020 2020 2020 2020 696e 6469 5f6d 7620          indi_mv 
+00035130: 3d20 696e 645f 690a 2020 2020 2020 2020  = ind_i.        
+00035140: 666f 7220 6a6a 2069 6e20 7261 6e67 6528  for jj in range(
+00035150: 737a 5f70 6869 5b30 5d29 3a0a 2020 2020  sz_phi[0]):.    
+00035160: 2020 2020 2020 2020 696e 6469 5f6d 765b          indi_mv[
+00035170: 302c 206a 6a5d 203d 206e 7068 6930 202b  0, jj] = nphi0 +
+00035180: 206a 6a0a 2020 2020 2020 2020 6e70 7473   jj.        npts
+00035190: 5f64 6973 6320 2b3d 2073 7a5f 7a20 2a20  _disc += sz_z * 
+000351a0: 737a 5f70 6869 5b30 5d0a 2020 2020 656c  sz_phi[0].    el
+000351b0: 7365 3a0a 2020 2020 2020 2020 2320 4765  se:.        # Ge
+000351c0: 7420 7468 6520 6163 7475 616c 2052 5068  t the actual RPh
+000351d0: 6920 7265 736f 6c75 7469 6f6e 2061 6e64  i resolution and
+000351e0: 2050 6869 206d 6573 6820 656c 656d 656e   Phi mesh elemen
+000351f0: 7473 2028 2120 6465 7065 6e64 7320 6f6e  ts (! depends on
+00035200: 2052 2129 0a20 2020 2020 2020 206e 6365   R!).        nce
+00035210: 6c6c 735f 7270 6869 5b30 5d20 3d20 3c69  lls_rphi[0] = <i
+00035220: 6e74 3e63 5f63 6569 6c28 7477 6f70 695f  nt>c_ceil(twopi_
+00035230: 6f76 6572 5f64 7068 6920 2a20 6469 7363  over_dphi * disc
+00035240: 5f72 5b30 5d29 0a20 2020 2020 2020 206c  _r[0]).        l
+00035250: 6f63 5f6e 635f 7270 6869 203d 206e 6365  oc_nc_rphi = nce
+00035260: 6c6c 735f 7270 6869 5b30 5d0a 2020 2020  lls_rphi[0].    
+00035270: 2020 2020 7374 6570 5f72 7068 695b 305d      step_rphi[0]
+00035280: 203d 205f 5457 4f50 4920 2f20 6e63 656c   = _TWOPI / ncel
+00035290: 6c73 5f72 7068 695b 305d 0a20 2020 2020  ls_rphi[0].     
+000352a0: 2020 2069 6e76 5f64 7270 6869 203d 2031     inv_drphi = 1
+000352b0: 2e20 2f20 7374 6570 5f72 7068 695b 305d  . / step_rphi[0]
+000352c0: 0a20 2020 2020 2020 2023 2047 6574 2069  .        # Get i
+000352d0: 6e64 6578 2061 6e64 2063 756d 756c 6174  ndex and cumulat
+000352e0: 6564 2069 6e64 6963 6573 2066 726f 6d20  ed indices from 
+000352f0: 6261 636b 6772 6f75 6e64 0a20 2020 2020  background.     
+00035300: 2020 2066 6f72 206a 6a20 696e 2072 616e     for jj in ran
+00035310: 6765 2869 6e64 5f6c 6f63 5f72 302c 206e  ge(ind_loc_r0, n
+00035320: 6365 6c6c 735f 7230 5b30 5d29 3a0a 2020  cells_r0[0]):.  
+00035330: 2020 2020 2020 2020 2020 6966 2064 6973            if dis
+00035340: 635f 7230 5b6a 6a5d 3d3d 6469 7363 5f72  c_r0[jj]==disc_r
+00035350: 5b30 5d3a 0a20 2020 2020 2020 2020 2020  [0]:.           
+00035360: 2020 2020 2069 6e64 5f6c 6f63 5f72 3020       ind_loc_r0 
+00035370: 3d20 6a6a 0a20 2020 2020 2020 2020 2020  = jj.           
+00035380: 2020 2020 2062 7265 616b 0a20 2020 2020       break.     
+00035390: 2020 2023 2047 6574 2069 6e64 6963 6573     # Get indices
+000353a0: 206f 6620 7068 690a 2020 2020 2020 2020   of phi.        
+000353b0: 2320 4765 7420 7468 6520 6578 7472 656d  # Get the extrem
+000353c0: 6520 696e 6469 6365 7320 6f66 2074 6865  e indices of the
+000353d0: 206d 6573 6820 656c 656d 656e 7473 2074   mesh elements t
+000353e0: 6861 7420 7265 616c 6c79 206e 6565 6420  hat really need 
+000353f0: 746f 0a20 2020 2020 2020 2023 2062 6520  to.        # be 
+00035400: 6372 6561 7465 6420 7769 7468 696e 2074  created within t
+00035410: 686f 7365 206c 696d 6974 730a 2020 2020  hose limits.    
+00035420: 2020 2020 6966 2061 6273 3020 2d20 7374      if abs0 - st
+00035430: 6570 5f72 7068 695b 305d 2a63 5f66 6c6f  ep_rphi[0]*c_flo
+00035440: 6f72 2861 6273 3020 2a20 696e 765f 6472  or(abs0 * inv_dr
+00035450: 7068 6929 203c 206d 6172 6769 6e2a 7374  phi) < margin*st
+00035460: 6570 5f72 7068 695b 305d 3a0a 2020 2020  ep_rphi[0]:.    
+00035470: 2020 2020 2020 2020 6e70 6869 3020 3d20          nphi0 = 
+00035480: 696e 7428 635f 726f 756e 6428 286d 696e  int(c_round((min
+00035490: 5f70 6869 202b 2063 5f70 6929 202a 2069  _phi + c_pi) * i
+000354a0: 6e76 5f64 7270 6869 2929 0a20 2020 2020  nv_drphi)).     
+000354b0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000354c0: 2020 2020 206e 7068 6930 203d 2069 6e74       nphi0 = int
+000354d0: 2863 5f66 6c6f 6f72 2828 6d69 6e5f 7068  (c_floor((min_ph
+000354e0: 6920 2b20 635f 7069 2920 2a20 696e 765f  i + c_pi) * inv_
+000354f0: 6472 7068 6929 290a 2020 2020 2020 2020  drphi)).        
+00035500: 6966 2061 6273 312d 7374 6570 5f72 7068  if abs1-step_rph
+00035510: 695b 305d 2a63 5f66 6c6f 6f72 2861 6273  i[0]*c_floor(abs
+00035520: 3120 2a20 696e 765f 6472 7068 6929 203c  1 * inv_drphi) <
+00035530: 206d 6172 6769 6e2a 7374 6570 5f72 7068   margin*step_rph
+00035540: 695b 305d 3a0a 2020 2020 2020 2020 2020  i[0]:.          
+00035550: 2020 6e70 6869 3120 3d20 696e 7428 635f    nphi1 = int(c_
+00035560: 726f 756e 6428 286d 6178 5f70 6869 2b63  round((max_phi+c
+00035570: 5f70 6929 202a 2069 6e76 5f64 7270 6869  _pi) * inv_drphi
+00035580: 292d 3129 0a20 2020 2020 2020 2065 6c73  )-1).        els
+00035590: 653a 0a20 2020 2020 2020 2020 2020 206e  e:.            n
+000355a0: 7068 6931 203d 2069 6e74 2863 5f66 6c6f  phi1 = int(c_flo
+000355b0: 6f72 2828 6d61 785f 7068 692b 635f 7069  or((max_phi+c_pi
+000355c0: 2920 2a20 696e 765f 6472 7068 6929 290a  ) * inv_drphi)).
+000355d0: 2020 2020 2020 2020 737a 5f70 6869 5b30          sz_phi[0
+000355e0: 5d20 3d20 6e70 6869 312b 312b 6c6f 635f  ] = nphi1+1+loc_
+000355f0: 6e63 5f72 7068 692d 6e70 6869 300a 2020  nc_rphi-nphi0.  
+00035600: 2020 2020 2020 6d61 785f 737a 5f70 6869        max_sz_phi
+00035610: 5b30 5d20 3d20 737a 5f70 6869 5b30 5d0a  [0] = sz_phi[0].
+00035620: 2020 2020 2020 2020 696e 645f 6920 3d20          ind_i = 
+00035630: 2d6e 702e 6f6e 6573 2828 737a 5f72 2c20  -np.ones((sz_r, 
+00035640: 737a 5f70 6869 5b30 5d20 2a20 725f 7261  sz_phi[0] * r_ra
+00035650: 7469 6f20 2b20 3129 2c20 6474 7970 653d  tio + 1), dtype=
+00035660: 696e 7429 0a20 2020 2020 2020 2069 6e64  int).        ind
+00035670: 695f 6d76 203d 2069 6e64 5f69 0a20 2020  i_mv = ind_i.   
+00035680: 2020 2020 2066 6f72 206a 6a20 696e 2072       for jj in r
+00035690: 616e 6765 286c 6f63 5f6e 635f 7270 6869  ange(loc_nc_rphi
+000356a0: 202d 206e 7068 6930 293a 0a20 2020 2020   - nphi0):.     
+000356b0: 2020 2020 2020 2069 6e64 695f 6d76 5b30         indi_mv[0
+000356c0: 2c20 6a6a 5d20 3d20 6e70 6869 3020 2b20  , jj] = nphi0 + 
+000356d0: 6a6a 0a20 2020 2020 2020 2066 6f72 206a  jj.        for j
+000356e0: 6a20 696e 2072 616e 6765 286c 6f63 5f6e  j in range(loc_n
+000356f0: 635f 7270 6869 202d 206e 7068 6930 2c20  c_rphi - nphi0, 
+00035700: 737a 5f70 6869 5b30 5d29 3a0a 2020 2020  sz_phi[0]):.    
+00035710: 2020 2020 2020 2020 696e 6469 5f6d 765b          indi_mv[
+00035720: 302c 206a 6a5d 203d 206a 6a20 2d20 286c  0, jj] = jj - (l
+00035730: 6f63 5f6e 635f 7270 6869 202d 206e 7068  oc_nc_rphi - nph
+00035740: 6930 290a 2020 2020 2020 2020 6e70 7473  i0).        npts
+00035750: 5f64 6973 6320 2b3d 2073 7a5f 7a20 2a20  _disc += sz_z * 
+00035760: 737a 5f70 6869 5b30 5d0a 2020 2020 2320  sz_phi[0].    # 
+00035770: 2e2e 2e20 646f 696e 6720 7468 6520 6f74  ... doing the ot
+00035780: 6865 7273 202e 2e2e 2e2e 2e2e 2e2e 2e2e  hers ...........
+00035790: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+000357a0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+000357b0: 2e2e 2e2e 2e2e 2e2e 2e2e 0a20 2020 206e  ...........    n
+000357c0: 7074 735f 6469 7363 202b 3d20 5f73 742e  pts_disc += _st.
+000357d0: 7361 5f64 6973 635f 7068 6928 737a 5f72  sa_disc_phi(sz_r
+000357e0: 2c20 737a 5f7a 2c20 6e63 656c 6c73 5f72  , sz_z, ncells_r
+000357f0: 7068 692c 2070 6869 7374 6570 2c0a 2020  phi, phistep,.  
 00035800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035810: 2020 2020 6e63 656c 6c73 5f72 305b 305d      ncells_r0[0]
-00035820: 2c20 6e63 656c 6c73 5f7a 5b30 5d2c 2026  , ncells_z[0], &
-00035830: 6d61 785f 737a 5f70 6869 5b30 5d2c 0a20  max_sz_phi[0],. 
+00035810: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00035820: 6973 635f 722c 2064 6973 635f 7230 2c20  isc_r, disc_r0, 
+00035830: 7374 6570 5f72 7068 692c 0a20 2020 2020  step_rphi,.     
 00035840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035860: 6d69 6e5f 7068 692c 206d 6178 5f70 6869  min_phi, max_phi
-00035870: 2c20 737a 5f70 6869 2c20 696e 6469 5f6d  , sz_phi, indi_m
-00035880: 762c 0a20 2020 2020 2020 2020 2020 2020  v,.             
-00035890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000358a0: 2020 2020 6d61 7267 696e 2c20 6e75 6d5f      margin, num_
-000358b0: 7468 7265 6164 7329 0a20 2020 2023 202e  threads).    # .
-000358c0: 2e2e 2076 6967 6e65 7474 696e 6720 2e2e  .. vignetting ..
-000358d0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-000358e0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-000358f0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00035900: 2e2e 2e2e 2e2e 2e2e 2e0a 2020 2020 6973  ..........    is
-00035910: 5f69 6e5f 7669 676e 6574 7465 203d 206e  _in_vignette = n
-00035920: 702e 6f6e 6573 2828 737a 5f72 2c20 737a  p.ones((sz_r, sz
-00035930: 5f7a 292c 2064 7479 7065 3d69 6e74 2920  _z), dtype=int) 
-00035940: 2320 6279 2064 6566 6175 6c74 2079 6573  # by default yes
-00035950: 0a20 2020 2069 6620 6c69 6d69 745f 7670  .    if limit_vp
-00035960: 6f6c 7920 6973 206e 6f74 204e 6f6e 653a  oly is not None:
-00035970: 0a20 2020 2020 2020 206e 7074 735f 7670  .        npts_vp
-00035980: 6f6c 7920 3d20 6c69 6d69 745f 7670 6f6c  oly = limit_vpol
-00035990: 792e 7368 6170 655b 315d 202d 2031 0a20  y.shape[1] - 1. 
-000359a0: 2020 2020 2020 2023 2077 6520 6d61 6b65         # we make
-000359b0: 2073 7572 6520 6974 2069 7320 636c 6f73   sure it is clos
-000359c0: 6564 0a20 2020 2020 2020 2069 6620 6e6f  ed.        if no
-000359d0: 7428 6162 7328 6c69 6d69 745f 7670 6f6c  t(abs(limit_vpol
-000359e0: 795b 302c 2030 5d20 2d20 6c69 6d69 745f  y[0, 0] - limit_
-000359f0: 7670 6f6c 795b 302c 206e 7074 735f 7670  vpoly[0, npts_vp
-00035a00: 6f6c 795d 2920 3c20 5f56 534d 414c 4c0a  oly]) < _VSMALL.
-00035a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035a20: 616e 6420 6162 7328 6c69 6d69 745f 7670  and abs(limit_vp
-00035a30: 6f6c 795b 312c 2030 5d0a 2020 2020 2020  oly[1, 0].      
-00035a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035a50: 2020 2d20 6c69 6d69 745f 7670 6f6c 795b    - limit_vpoly[
-00035a60: 312c 206e 7074 735f 7670 6f6c 795d 2920  1, npts_vpoly]) 
-00035a70: 3c20 5f56 534d 414c 4c29 3a0a 2020 2020  < _VSMALL):.    
-00035a80: 2020 2020 2020 2020 706f 6c79 5f6d 7620          poly_mv 
-00035a90: 3d20 6e70 2e63 6f6e 6361 7465 6e61 7465  = np.concatenate
-00035aa0: 2828 6c69 6d69 745f 7670 6f6c 792c 206c  ((limit_vpoly, l
-00035ab0: 696d 6974 5f76 706f 6c79 5b3a 2c30 3a31  imit_vpoly[:,0:1
-00035ac0: 5d29 2c20 6178 6973 3d31 290a 2020 2020  ]), axis=1).    
-00035ad0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00035ae0: 2020 2020 2020 706f 6c79 5f6d 7620 3d20        poly_mv = 
-00035af0: 6c69 6d69 745f 7670 6f6c 790a 2020 2020  limit_vpoly.    
-00035b00: 2020 2020 5f20 3d20 5f76 742e 6172 655f      _ = _vt.are_
-00035b10: 696e 5f76 6967 6e65 7474 6528 737a 5f72  in_vignette(sz_r
-00035b20: 2c20 737a 5f7a 2c0a 2020 2020 2020 2020  , sz_z,.        
-00035b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035b40: 2020 2020 2020 2020 706f 6c79 5f6d 762c          poly_mv,
-00035b50: 206e 7074 735f 7670 6f6c 792c 0a20 2020   npts_vpoly,.   
-00035b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035b70: 2020 2020 2020 2020 2020 2020 2064 6973               dis
-00035b80: 635f 722c 2064 6973 635f 7a2c 0a20 2020  c_r, disc_z,.   
-00035b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035ba0: 2020 2020 2020 2020 2020 2020 2069 735f               is_
-00035bb0: 696e 5f76 6967 6e65 7474 6529 0a20 2020  in_vignette).   
-00035bc0: 2023 202e 2e20 7072 6570 6172 696e 6720   # .. preparing 
-00035bd0: 666f 7220 6163 7475 616c 2064 6973 6372  for actual discr
-00035be0: 6574 697a 6174 696f 6e20 2e2e 2e2e 2e2e  etization ......
-00035bf0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-00035c00: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e0a 2020  ..............  
-00035c10: 2020 696e 645f 727a 3270 6f6c 203d 206e    ind_rz2pol = n
-00035c20: 702e 656d 7074 7928 2873 7a5f 722c 2073  p.empty((sz_r, s
-00035c30: 7a5f 7a29 2c20 6474 7970 653d 696e 7429  z_z), dtype=int)
-00035c40: 0a20 2020 206e 7074 735f 706f 6c20 3d20  .    npts_pol = 
-00035c50: 5f73 742e 7361 5f67 6574 5f69 6e64 6578  _st.sa_get_index
-00035c60: 5f61 7272 6179 7328 696e 645f 727a 3270  _arrays(ind_rz2p
-00035c70: 6f6c 2c0a 2020 2020 2020 2020 2020 2020  ol,.            
-00035c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035c90: 2020 2020 2020 2020 2069 735f 696e 5f76           is_in_v
-00035ca0: 6967 6e65 7474 652c 0a20 2020 2020 2020  ignette,.       
-00035cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035cc0: 2020 2020 2020 2020 2020 2020 2020 737a                sz
-00035cd0: 5f72 2c20 737a 5f7a 290a 2020 2020 2320  _r, sz_z).    # 
-00035ce0: 696e 6974 6961 6c69 7a69 6e67 2061 7272  initializing arr
-00035cf0: 6179 730a 2020 2020 7265 736f 5f72 6472  ays.    reso_rdr
-00035d00: 647a 203d 206e 702e 656d 7074 7928 286e  dz = np.empty((n
-00035d10: 7074 735f 706f 6c2c 2029 290a 2020 2020  pts_pol, )).    
-00035d20: 7361 5f6d 6170 203d 206e 702e 7a65 726f  sa_map = np.zero
-00035d30: 7328 286e 7074 735f 706f 6c2c 2073 7a5f  s((npts_pol, sz_
-00035d40: 7029 290a 2020 2020 7074 7320 3d20 6e70  p)).    pts = np
-00035d50: 2e65 6d70 7479 2828 322c 206e 7074 735f  .empty((2, npts_
-00035d60: 706f 6c29 290a 2020 2020 696e 6420 3d20  pol)).    ind = 
-00035d70: 2d6e 702e 6f6e 6573 2828 6e70 7473 5f70  -np.ones((npts_p
-00035d80: 6f6c 2c20 292c 2064 7479 7065 3d69 6e74  ol, ), dtype=int
-00035d90: 290a 2020 2020 7074 735f 6d76 203d 2070  ).    pts_mv = p
-00035da0: 7473 0a20 2020 2069 6e64 5f6d 7620 3d20  ts.    ind_mv = 
-00035db0: 696e 640a 2020 2020 7265 736f 5f72 6472  ind.    reso_rdr
-00035dc0: 647a 5f6d 7620 3d20 7265 736f 5f72 6472  dz_mv = reso_rdr
-00035dd0: 647a 0a20 2020 2072 6573 6f5f 725f 7a20  dz.    reso_r_z 
-00035de0: 3d20 7265 736f 5f72 5b30 5d2a 7265 736f  = reso_r[0]*reso
-00035df0: 5f7a 5b30 5d0a 2020 2020 696e 645f 6920  _z[0].    ind_i 
-00035e00: 3d20 6e70 2e73 6f72 7428 696e 645f 692c  = np.sort(ind_i,
-00035e10: 2061 7869 733d 3129 0a20 2020 2069 6e64   axis=1).    ind
-00035e20: 695f 6d76 203d 2069 6e64 5f69 0a20 2020  i_mv = ind_i.   
-00035e30: 2066 6972 7374 5f69 6e64 5f6d 7620 3d20   first_ind_mv = 
-00035e40: 6e70 2e61 7267 6d61 7828 696e 645f 6920  np.argmax(ind_i 
-00035e50: 3e20 2d31 2c20 6178 6973 3d31 292e 6173  > -1, axis=1).as
-00035e60: 7479 7065 2869 6e74 290a 2020 2020 2320  type(int).    # 
-00035e70: 696e 6974 6961 6c69 7a69 6e67 2075 7469  initializing uti
-00035e80: 6c69 7461 7279 2061 7272 6179 730a 2020  litary arrays.  
-00035e90: 2020 6e75 6d5f 7468 7265 6164 7320 3d20    num_threads = 
-00035ea0: 5f6f 6d70 742e 6765 745f 6566 6665 6374  _ompt.get_effect
-00035eb0: 6976 655f 6e75 6d5f 7468 7265 6164 7328  ive_num_threads(
-00035ec0: 6e75 6d5f 7468 7265 6164 7329 0a20 2020  num_threads).   
-00035ed0: 206c 7374 7275 6374 5f6c 696d 735f 6e70   lstruct_lims_np
-00035ee0: 203d 2066 6c61 7474 656e 5f6c 7374 7275   = flatten_lstru
-00035ef0: 6374 5f6c 696d 7328 6c73 7472 7563 745f  ct_lims(lstruct_
-00035f00: 6c69 6d73 290a 2020 2020 2320 2e2e 2e2e  lims).    # ....
-00035f10: 2e2e 2e2e 2e2e 2e2e 2e2e 0a20 2020 205f  ...........    _
-00035f20: 7374 2e73 615f 6173 7365 6d62 6c65 5f61  st.sa_assemble_a
-00035f30: 7272 6179 7328 626c 6f63 6b2c 0a20 2020  rrays(block,.   
-00035f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035f50: 2020 2020 2020 2020 6170 7072 6f78 2c0a          approx,.
-00035f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035f70: 2020 2020 2020 2020 2020 2070 6172 745f             part_
-00035f80: 636f 6f72 6473 2c0a 2020 2020 2020 2020  coords,.        
-00035f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035fa0: 2020 2070 6172 745f 722c 0a20 2020 2020     part_r,.     
-00035fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035fc0: 2020 2020 2020 6973 5f69 6e5f 7669 676e        is_in_vign
-00035fd0: 6574 7465 2c0a 2020 2020 2020 2020 2020  ette,.          
+00035850: 2020 2020 2020 2020 2020 2020 696e 645f              ind_
+00035860: 6c6f 635f 7230 2c0a 2020 2020 2020 2020  loc_r0,.        
+00035870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035880: 2020 2020 2020 2020 206e 6365 6c6c 735f           ncells_
+00035890: 7230 5b30 5d2c 206e 6365 6c6c 735f 7a5b  r0[0], ncells_z[
+000358a0: 305d 2c20 266d 6178 5f73 7a5f 7068 695b  0], &max_sz_phi[
+000358b0: 305d 2c0a 2020 2020 2020 2020 2020 2020  0],.            
+000358c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000358d0: 2020 2020 206d 696e 5f70 6869 2c20 6d61       min_phi, ma
+000358e0: 785f 7068 692c 2073 7a5f 7068 692c 2069  x_phi, sz_phi, i
+000358f0: 6e64 695f 6d76 2c0a 2020 2020 2020 2020  ndi_mv,.        
+00035900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035910: 2020 2020 2020 2020 206d 6172 6769 6e2c           margin,
+00035920: 206e 756d 5f74 6872 6561 6473 290a 2020   num_threads).  
+00035930: 2020 2320 2e2e 2e20 7669 676e 6574 7469    # ... vignetti
+00035940: 6e67 202e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ng .............
+00035950: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00035960: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00035970: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 0a20  ............... 
+00035980: 2020 2069 735f 696e 5f76 6967 6e65 7474     is_in_vignett
+00035990: 6520 3d20 6e70 2e6f 6e65 7328 2873 7a5f  e = np.ones((sz_
+000359a0: 722c 2073 7a5f 7a29 2c20 6474 7970 653d  r, sz_z), dtype=
+000359b0: 696e 7429 2023 2062 7920 6465 6661 756c  int) # by defaul
+000359c0: 7420 7965 730a 2020 2020 6966 206c 696d  t yes.    if lim
+000359d0: 6974 5f76 706f 6c79 2069 7320 6e6f 7420  it_vpoly is not 
+000359e0: 4e6f 6e65 3a0a 2020 2020 2020 2020 6e70  None:.        np
+000359f0: 7473 5f76 706f 6c79 203d 206c 696d 6974  ts_vpoly = limit
+00035a00: 5f76 706f 6c79 2e73 6861 7065 5b31 5d20  _vpoly.shape[1] 
+00035a10: 2d20 310a 2020 2020 2020 2020 2320 7765  - 1.        # we
+00035a20: 206d 616b 6520 7375 7265 2069 7420 6973   make sure it is
+00035a30: 2063 6c6f 7365 640a 2020 2020 2020 2020   closed.        
+00035a40: 6966 206e 6f74 2861 6273 286c 696d 6974  if not(abs(limit
+00035a50: 5f76 706f 6c79 5b30 2c20 305d 202d 206c  _vpoly[0, 0] - l
+00035a60: 696d 6974 5f76 706f 6c79 5b30 2c20 6e70  imit_vpoly[0, np
+00035a70: 7473 5f76 706f 6c79 5d29 203c 205f 5653  ts_vpoly]) < _VS
+00035a80: 4d41 4c4c 0a20 2020 2020 2020 2020 2020  MALL.           
+00035a90: 2020 2020 2061 6e64 2061 6273 286c 696d       and abs(lim
+00035aa0: 6974 5f76 706f 6c79 5b31 2c20 305d 0a20  it_vpoly[1, 0]. 
+00035ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035ac0: 2020 2020 2020 202d 206c 696d 6974 5f76         - limit_v
+00035ad0: 706f 6c79 5b31 2c20 6e70 7473 5f76 706f  poly[1, npts_vpo
+00035ae0: 6c79 5d29 203c 205f 5653 4d41 4c4c 293a  ly]) < _VSMALL):
+00035af0: 0a20 2020 2020 2020 2020 2020 2070 6f6c  .            pol
+00035b00: 795f 6d76 203d 206e 702e 636f 6e63 6174  y_mv = np.concat
+00035b10: 656e 6174 6528 286c 696d 6974 5f76 706f  enate((limit_vpo
+00035b20: 6c79 2c20 6c69 6d69 745f 7670 6f6c 795b  ly, limit_vpoly[
+00035b30: 3a2c 303a 315d 292c 2061 7869 733d 3129  :,0:1]), axis=1)
+00035b40: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00035b50: 2020 2020 2020 2020 2020 2070 6f6c 795f             poly_
+00035b60: 6d76 203d 206c 696d 6974 5f76 706f 6c79  mv = limit_vpoly
+00035b70: 0a20 2020 2020 2020 205f 203d 205f 7674  .        _ = _vt
+00035b80: 2e61 7265 5f69 6e5f 7669 676e 6574 7465  .are_in_vignette
+00035b90: 2873 7a5f 722c 2073 7a5f 7a2c 0a20 2020  (sz_r, sz_z,.   
+00035ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035bb0: 2020 2020 2020 2020 2020 2020 2070 6f6c               pol
+00035bc0: 795f 6d76 2c20 6e70 7473 5f76 706f 6c79  y_mv, npts_vpoly
+00035bd0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00035be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035bf0: 2020 6469 7363 5f72 2c20 6469 7363 5f7a    disc_r, disc_z
+00035c00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00035c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035c20: 2020 6973 5f69 6e5f 7669 676e 6574 7465    is_in_vignette
+00035c30: 290a 2020 2020 2320 2e2e 2070 7265 7061  ).    # .. prepa
+00035c40: 7269 6e67 2066 6f72 2061 6374 7561 6c20  ring for actual 
+00035c50: 6469 7363 7265 7469 7a61 7469 6f6e 202e  discretization .
+00035c60: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00035c70: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00035c80: 2e2e 0a20 2020 2069 6e64 5f72 7a32 706f  ...    ind_rz2po
+00035c90: 6c20 3d20 6e70 2e65 6d70 7479 2828 737a  l = np.empty((sz
+00035ca0: 5f72 2c20 737a 5f7a 292c 2064 7479 7065  _r, sz_z), dtype
+00035cb0: 3d69 6e74 290a 2020 2020 6e70 7473 5f70  =int).    npts_p
+00035cc0: 6f6c 203d 205f 7374 2e73 615f 6765 745f  ol = _st.sa_get_
+00035cd0: 696e 6465 785f 6172 7261 7973 2869 6e64  index_arrays(ind
+00035ce0: 5f72 7a32 706f 6c2c 0a20 2020 2020 2020  _rz2pol,.       
+00035cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035d00: 2020 2020 2020 2020 2020 2020 2020 6973                is
+00035d10: 5f69 6e5f 7669 676e 6574 7465 2c0a 2020  _in_vignette,.  
+00035d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035d40: 2020 2073 7a5f 722c 2073 7a5f 7a29 0a20     sz_r, sz_z). 
+00035d50: 2020 2023 2069 6e69 7469 616c 697a 696e     # initializin
+00035d60: 6720 6172 7261 7973 0a20 2020 2072 6573  g arrays.    res
+00035d70: 6f5f 7264 7264 7a20 3d20 6e70 2e65 6d70  o_rdrdz = np.emp
+00035d80: 7479 2828 6e70 7473 5f70 6f6c 2c20 2929  ty((npts_pol, ))
+00035d90: 0a20 2020 2073 615f 6d61 7020 3d20 6e70  .    sa_map = np
+00035da0: 2e7a 6572 6f73 2828 6e70 7473 5f70 6f6c  .zeros((npts_pol
+00035db0: 2c20 737a 5f70 2929 0a20 2020 2070 7473  , sz_p)).    pts
+00035dc0: 203d 206e 702e 656d 7074 7928 2832 2c20   = np.empty((2, 
+00035dd0: 6e70 7473 5f70 6f6c 2929 0a20 2020 2069  npts_pol)).    i
+00035de0: 6e64 203d 202d 6e70 2e6f 6e65 7328 286e  nd = -np.ones((n
+00035df0: 7074 735f 706f 6c2c 2029 2c20 6474 7970  pts_pol, ), dtyp
+00035e00: 653d 696e 7429 0a20 2020 2070 7473 5f6d  e=int).    pts_m
+00035e10: 7620 3d20 7074 730a 2020 2020 696e 645f  v = pts.    ind_
+00035e20: 6d76 203d 2069 6e64 0a20 2020 2072 6573  mv = ind.    res
+00035e30: 6f5f 7264 7264 7a5f 6d76 203d 2072 6573  o_rdrdz_mv = res
+00035e40: 6f5f 7264 7264 7a0a 2020 2020 7265 736f  o_rdrdz.    reso
+00035e50: 5f72 5f7a 203d 2072 6573 6f5f 725b 305d  _r_z = reso_r[0]
+00035e60: 2a72 6573 6f5f 7a5b 305d 0a20 2020 2069  *reso_z[0].    i
+00035e70: 6e64 5f69 203d 206e 702e 736f 7274 2869  nd_i = np.sort(i
+00035e80: 6e64 5f69 2c20 6178 6973 3d31 290a 2020  nd_i, axis=1).  
+00035e90: 2020 696e 6469 5f6d 7620 3d20 696e 645f    indi_mv = ind_
+00035ea0: 690a 2020 2020 6669 7273 745f 696e 645f  i.    first_ind_
+00035eb0: 6d76 203d 206e 702e 6172 676d 6178 2869  mv = np.argmax(i
+00035ec0: 6e64 5f69 203e 202d 312c 2061 7869 733d  nd_i > -1, axis=
+00035ed0: 3129 2e61 7374 7970 6528 696e 7429 0a20  1).astype(int). 
+00035ee0: 2020 2023 2069 6e69 7469 616c 697a 696e     # initializin
+00035ef0: 6720 7574 696c 6974 6172 7920 6172 7261  g utilitary arra
+00035f00: 7973 0a20 2020 206e 756d 5f74 6872 6561  ys.    num_threa
+00035f10: 6473 203d 205f 6f6d 7074 2e67 6574 5f65  ds = _ompt.get_e
+00035f20: 6666 6563 7469 7665 5f6e 756d 5f74 6872  ffective_num_thr
+00035f30: 6561 6473 286e 756d 5f74 6872 6561 6473  eads(num_threads
+00035f40: 290a 2020 2020 6c73 7472 7563 745f 6c69  ).    lstruct_li
+00035f50: 6d73 5f6e 7020 3d20 666c 6174 7465 6e5f  ms_np = flatten_
+00035f60: 6c73 7472 7563 745f 6c69 6d73 286c 7374  lstruct_lims(lst
+00035f70: 7275 6374 5f6c 696d 7329 0a20 2020 2023  ruct_lims).    #
+00035f80: 202e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e0a   ...............
+00035f90: 2020 2020 5f73 742e 7361 5f61 7373 656d      _st.sa_assem
+00035fa0: 626c 655f 6172 7261 7973 2862 6c6f 636b  ble_arrays(block
+00035fb0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00035fc0: 2020 2020 2020 2020 2020 2020 2061 7070               app
+00035fd0: 726f 782c 0a20 2020 2020 2020 2020 2020  rox,.           
 00035fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035ff0: 2073 615f 6d61 702c 0a20 2020 2020 2020   sa_map,.       
+00035ff0: 7061 7274 5f63 6f6f 7264 732c 0a20 2020  part_coords,.   
 00036000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036010: 2020 2020 7665 735f 706f 6c79 2c0a 2020      ves_poly,.  
+00036010: 2020 2020 2020 2020 7061 7274 5f72 2c0a          part_r,.
 00036020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036030: 2020 2020 2020 2020 2076 6573 5f6e 6f72           ves_nor
-00036040: 6d2c 0a20 2020 2020 2020 2020 2020 2020  m,.             
-00036050: 2020 2020 2020 2020 2020 2020 2020 7665                ve
-00036060: 735f 6c69 6d73 2c0a 2020 2020 2020 2020  s_lims,.        
+00036030: 2020 2020 2020 2020 2020 2069 735f 696e             is_in
+00036040: 5f76 6967 6e65 7474 652c 0a20 2020 2020  _vignette,.     
+00036050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036060: 2020 2020 2020 7361 5f6d 6170 2c0a 2020        sa_map,.  
 00036070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036080: 2020 206c 7374 7275 6374 5f6e 6c69 6d2c     lstruct_nlim,
-00036090: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000360a0: 2020 2020 2020 2020 2020 2020 6c73 7472              lstr
-000360b0: 7563 745f 706f 6c79 782c 0a20 2020 2020  uct_polyx,.     
+00036080: 2020 2020 2020 2020 2076 6573 5f70 6f6c           ves_pol
+00036090: 792c 0a20 2020 2020 2020 2020 2020 2020  y,.             
+000360a0: 2020 2020 2020 2020 2020 2020 2020 7665                ve
+000360b0: 735f 6e6f 726d 2c0a 2020 2020 2020 2020  s_norm,.        
 000360c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000360d0: 2020 2020 2020 6c73 7472 7563 745f 706f        lstruct_po
-000360e0: 6c79 792c 0a20 2020 2020 2020 2020 2020  lyy,.           
-000360f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036100: 6c73 7472 7563 745f 6c69 6d73 5f6e 702c  lstruct_lims_np,
-00036110: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00036120: 2020 2020 2020 2020 2020 2020 6c73 7472              lstr
-00036130: 7563 745f 6e6f 726d 782c 0a20 2020 2020  uct_normx,.     
-00036140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036150: 2020 2020 2020 6c73 7472 7563 745f 6e6f        lstruct_no
-00036160: 726d 792c 0a20 2020 2020 2020 2020 2020  rmy,.           
-00036170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036180: 6c6e 7665 7274 2c0a 2020 2020 2020 2020  lnvert,.        
+000360d0: 2020 2076 6573 5f6c 696d 732c 0a20 2020     ves_lims,.   
+000360e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000360f0: 2020 2020 2020 2020 6c73 7472 7563 745f          lstruct_
+00036100: 6e6c 696d 2c0a 2020 2020 2020 2020 2020  nlim,.          
+00036110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036120: 206c 7374 7275 6374 5f70 6f6c 7978 2c0a   lstruct_polyx,.
+00036130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036140: 2020 2020 2020 2020 2020 206c 7374 7275             lstru
+00036150: 6374 5f70 6f6c 7979 2c0a 2020 2020 2020  ct_polyy,.      
+00036160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036170: 2020 2020 206c 7374 7275 6374 5f6c 696d       lstruct_lim
+00036180: 735f 6e70 2c0a 2020 2020 2020 2020 2020  s_np,.          
 00036190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000361a0: 2020 206e 7374 7275 6374 5f74 6f74 2c0a     nstruct_tot,.
+000361a0: 206c 7374 7275 6374 5f6e 6f72 6d78 2c0a   lstruct_normx,.
 000361b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000361c0: 2020 2020 2020 2020 2020 206e 7374 7275             nstru
-000361d0: 6374 5f6c 696d 2c0a 2020 2020 2020 2020  ct_lim,.        
+000361c0: 2020 2020 2020 2020 2020 206c 7374 7275             lstru
+000361d0: 6374 5f6e 6f72 6d79 2c0a 2020 2020 2020  ct_normy,.      
 000361e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000361f0: 2020 2072 6d69 6e2c 0a20 2020 2020 2020     rmin,.       
+000361f0: 2020 2020 206c 6e76 6572 742c 0a20 2020       lnvert,.   
 00036200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036210: 2020 2020 6570 735f 757a 2c20 6570 735f      eps_uz, eps_
-00036220: 612c 0a20 2020 2020 2020 2020 2020 2020  a,.             
-00036230: 2020 2020 2020 2020 2020 2020 2020 6570                ep
-00036240: 735f 767a 2c20 6570 735f 622c 0a20 2020  s_vz, eps_b,.   
+00036210: 2020 2020 2020 2020 6e73 7472 7563 745f          nstruct_
+00036220: 746f 742c 0a20 2020 2020 2020 2020 2020  tot,.           
+00036230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036240: 6e73 7472 7563 745f 6c69 6d2c 0a20 2020  nstruct_lim,.   
 00036250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036260: 2020 2020 2020 2020 6570 735f 706c 616e          eps_plan
-00036270: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00036280: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00036290: 7262 6964 2c0a 2020 2020 2020 2020 2020  rbid,.          
+00036260: 2020 2020 2020 2020 726d 696e 2c0a 2020          rmin,.  
+00036270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036280: 2020 2020 2020 2020 2065 7073 5f75 7a2c           eps_uz,
+00036290: 2065 7073 5f61 2c0a 2020 2020 2020 2020   eps_a,.        
 000362a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000362b0: 2066 6972 7374 5f69 6e64 5f6d 762c 0a20   first_ind_mv,. 
-000362c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000362d0: 2020 2020 2020 2020 2020 696e 6469 5f6d            indi_m
-000362e0: 762c 0a20 2020 2020 2020 2020 2020 2020  v,.             
-000362f0: 2020 2020 2020 2020 2020 2020 2020 737a                sz
-00036300: 5f70 2c20 737a 5f72 2c20 737a 5f7a 2c0a  _p, sz_r, sz_z,.
+000362b0: 2020 2065 7073 5f76 7a2c 2065 7073 5f62     eps_vz, eps_b
+000362c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000362d0: 2020 2020 2020 2020 2020 2020 2065 7073               eps
+000362e0: 5f70 6c61 6e65 2c0a 2020 2020 2020 2020  _plane,.        
+000362f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036300: 2020 2066 6f72 6269 642c 0a20 2020 2020     forbid,.     
 00036310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036320: 2020 2020 2020 2020 2020 206e 6365 6c6c             ncell
-00036330: 735f 7270 6869 2c0a 2020 2020 2020 2020  s_rphi,.        
-00036340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036350: 2020 2072 6573 6f5f 725f 7a2c 0a20 2020     reso_r_z,.   
+00036320: 2020 2020 2020 6669 7273 745f 696e 645f        first_ind_
+00036330: 6d76 2c0a 2020 2020 2020 2020 2020 2020  mv,.            
+00036340: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00036350: 6e64 695f 6d76 2c0a 2020 2020 2020 2020  ndi_mv,.        
 00036360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036370: 2020 2020 2020 2020 6469 7363 5f72 2c0a          disc_r,.
-00036380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036390: 2020 2020 2020 2020 2020 2073 7465 705f             step_
-000363a0: 7270 6869 2c0a 2020 2020 2020 2020 2020  rphi,.          
+00036370: 2020 2073 7a5f 702c 2073 7a5f 722c 2073     sz_p, sz_r, s
+00036380: 7a5f 7a2c 0a20 2020 2020 2020 2020 2020  z_z,.           
+00036390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000363a0: 6e63 656c 6c73 5f72 7068 692c 0a20 2020  ncells_rphi,.   
 000363b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000363c0: 2064 6973 635f 7a2c 0a20 2020 2020 2020   disc_z,.       
-000363d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000363e0: 2020 2020 696e 645f 727a 3270 6f6c 2c0a      ind_rz2pol,.
-000363f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036400: 2020 2020 2020 2020 2020 2073 7a5f 7068             sz_ph
-00036410: 692c 0a20 2020 2020 2020 2020 2020 2020  i,.             
-00036420: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00036430: 736f 5f72 6472 647a 5f6d 762c 0a20 2020  so_rdrdz_mv,.   
+000363c0: 2020 2020 2020 2020 7265 736f 5f72 5f7a          reso_r_z
+000363d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000363e0: 2020 2020 2020 2020 2020 2020 2064 6973               dis
+000363f0: 635f 722c 0a20 2020 2020 2020 2020 2020  c_r,.           
+00036400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036410: 7374 6570 5f72 7068 692c 0a20 2020 2020  step_rphi,.     
+00036420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036430: 2020 2020 2020 6469 7363 5f7a 2c0a 2020        disc_z,.  
 00036440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036450: 2020 2020 2020 2020 7074 735f 6d76 2c0a          pts_mv,.
-00036460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036470: 2020 2020 2020 2020 2020 2069 6e64 5f6d             ind_m
-00036480: 762c 0a20 2020 2020 2020 2020 2020 2020  v,.             
-00036490: 2020 2020 2020 2020 2020 2020 2020 6e75                nu
-000364a0: 6d5f 7468 7265 6164 7329 0a20 2020 2023  m_threads).    #
-000364b0: 202e 2e2e 2066 7265 6569 6e67 2075 7020   ... freeing up 
-000364c0: 6d65 6d6f 7279 202e 2e2e 2e2e 2e2e 2e2e  memory .........
-000364d0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-000364e0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
-000364f0: 2e2e 2e2e 2e2e 2e2e 2e2e 2e0a 2020 2020  ............    
-00036500: 6672 6565 286c 696e 6465 785f 7a29 0a20  free(lindex_z). 
-00036510: 2020 2066 7265 6528 6469 7363 5f72 290a     free(disc_r).
-00036520: 2020 2020 6672 6565 2864 6973 635f 7a29      free(disc_z)
-00036530: 0a20 2020 2066 7265 6528 6469 7363 5f72  .    free(disc_r
-00036540: 3029 0a20 2020 2066 7265 6528 737a 5f70  0).    free(sz_p
-00036550: 6869 290a 2020 2020 6672 6565 2873 7465  hi).    free(ste
-00036560: 705f 7270 6869 290a 2020 2020 6672 6565  p_rphi).    free
-00036570: 286e 6365 6c6c 735f 7270 6869 290a 0a20  (ncells_rphi).. 
-00036580: 2020 2072 6574 7572 6e20 7074 732c 2073     return pts, s
-00036590: 615f 6d61 702c 2069 6e64 2c20 7265 736f  a_map, ind, reso
-000365a0: 5f72 5f7a 0a0a 0a23 203d 3d3d 3d3d 3d3d  _r_z...# =======
-000365b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000365c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000365d0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000365e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000365f0: 3d3d 3d3d 3d3d 3d0a 230a 2320 2020 2020  =======.#.#     
-00036600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036610: 2020 536f 6c69 6420 416e 676c 6520 436f    Solid Angle Co
-00036620: 6d70 7574 6174 696f 6e0a 2320 2020 2020  mputation.#     
-00036630: 2020 2020 2020 2020 2020 2020 2020 7375                su
-00036640: 6274 656e 6465 6420 6279 206d 756c 7469  btended by multi
-00036650: 706c 6520 6170 6572 7475 7265 730a 230a  ple apertures.#.
-00036660: 2320 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  # ==============
-00036670: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00036680: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00036690: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000366a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000366b0: 0a0a 0a64 6566 2063 6f6d 7075 7465 5f73  ...def compute_s
-000366c0: 6f6c 6964 5f61 6e67 6c65 5f61 7065 7274  olid_angle_apert
-000366d0: 7572 6573 5f75 6e69 7476 6563 746f 7273  ures_unitvectors
-000366e0: 280a 2020 2020 2320 7074 733a 2063 6f6f  (.    # pts: coo
-000366f0: 7264 696e 6174 6573 2061 7320 7468 7265  rdinates as thre
-00036700: 6520 3164 2061 7272 6179 730a 2020 2020  e 1d arrays.    
-00036710: 646f 7562 6c65 5b3a 3a31 5d20 7074 735f  double[::1] pts_
-00036720: 782c 0a20 2020 2064 6f75 626c 655b 3a3a  x,.    double[::
-00036730: 315d 2070 7473 5f79 2c0a 2020 2020 646f  1] pts_y,.    do
-00036740: 7562 6c65 5b3a 3a31 5d20 7074 735f 7a2c  uble[::1] pts_z,
-00036750: 0a20 2020 2023 2064 6574 6563 746f 7273  .    # detectors
-00036760: 3a20 706f 6c79 676f 6e20 636f 6f72 6469  : polygon coordi
-00036770: 6e61 7465 7320 696e 2032 6420 2863 6f6d  nates in 2d (com
-00036780: 6d6f 6e20 746f 2061 6c6c 2064 6574 6563  mon to all detec
-00036790: 746f 7273 290a 2020 2020 646f 7562 6c65  tors).    double
-000367a0: 5b3a 3a31 5d20 6465 745f 6f75 746c 696e  [::1] det_outlin
-000367b0: 655f 7830 2c0a 2020 2020 646f 7562 6c65  e_x0,.    double
-000367c0: 5b3a 3a31 5d20 6465 745f 6f75 746c 696e  [::1] det_outlin
-000367d0: 655f 7831 2c0a 2020 2020 2320 6465 7465  e_x1,.    # dete
-000367e0: 6374 6f72 733a 2063 656e 7465 7273 2063  ctors: centers c
-000367f0: 6f6f 7264 696e 6174 6573 2061 7320 7468  oordinates as th
-00036800: 7265 6520 3164 2061 7272 6179 730a 2020  ree 1d arrays.  
-00036810: 2020 646f 7562 6c65 5b3a 3a31 5d20 6465    double[::1] de
-00036820: 745f 6365 6e74 735f 782c 0a20 2020 2064  t_cents_x,.    d
-00036830: 6f75 626c 655b 3a3a 315d 2064 6574 5f63  ouble[::1] det_c
-00036840: 656e 7473 5f79 2c0a 2020 2020 646f 7562  ents_y,.    doub
-00036850: 6c65 5b3a 3a31 5d20 6465 745f 6365 6e74  le[::1] det_cent
-00036860: 735f 7a2c 0a20 2020 2023 2064 6574 6563  s_z,.    # detec
-00036870: 746f 7273 3a20 6e6f 726d 616c 2075 6e69  tors: normal uni
-00036880: 7420 7665 6374 6f72 7320 6173 2074 6872  t vectors as thr
-00036890: 6565 2031 6420 6172 7261 7973 2028 6e64  ee 1d arrays (nd
-000368a0: 203d 206c 656e 2864 6574 5f6e 6f72 6d5f   = len(det_norm_
-000368b0: 7829 290a 2020 2020 646f 7562 6c65 5b3a  x)).    double[:
-000368c0: 3a31 5d20 6465 745f 6e6f 726d 5f78 2c0a  :1] det_norm_x,.
-000368d0: 2020 2020 646f 7562 6c65 5b3a 3a31 5d20      double[::1] 
-000368e0: 6465 745f 6e6f 726d 5f79 2c0a 2020 2020  det_norm_y,.    
-000368f0: 646f 7562 6c65 5b3a 3a31 5d20 6465 745f  double[::1] det_
-00036900: 6e6f 726d 5f7a 2c0a 2020 2020 6e70 2e6e  norm_z,.    np.n
-00036910: 6461 7272 6179 5b64 6f75 626c 652c 206e  darray[double, n
-00036920: 6469 6d3d 315d 2064 6574 5f65 305f 782c  dim=1] det_e0_x,
-00036930: 0a20 2020 206e 702e 6e64 6172 7261 795b  .    np.ndarray[
-00036940: 646f 7562 6c65 2c20 6e64 696d 3d31 5d20  double, ndim=1] 
-00036950: 6465 745f 6530 5f79 2c0a 2020 2020 6e70  det_e0_y,.    np
-00036960: 2e6e 6461 7272 6179 5b64 6f75 626c 652c  .ndarray[double,
-00036970: 206e 6469 6d3d 315d 2064 6574 5f65 305f   ndim=1] det_e0_
-00036980: 7a2c 0a20 2020 206e 702e 6e64 6172 7261  z,.    np.ndarra
-00036990: 795b 646f 7562 6c65 2c20 6e64 696d 3d31  y[double, ndim=1
-000369a0: 5d20 6465 745f 6531 5f78 2c0a 2020 2020  ] det_e1_x,.    
-000369b0: 6e70 2e6e 6461 7272 6179 5b64 6f75 626c  np.ndarray[doubl
-000369c0: 652c 206e 6469 6d3d 315d 2064 6574 5f65  e, ndim=1] det_e
-000369d0: 315f 792c 0a20 2020 206e 702e 6e64 6172  1_y,.    np.ndar
-000369e0: 7261 795b 646f 7562 6c65 2c20 6e64 696d  ray[double, ndim
-000369f0: 3d31 5d20 6465 745f 6531 5f7a 2c0a 2020  =1] det_e1_z,.  
-00036a00: 2020 2320 6170 6572 7475 7265 733a 2069    # apertures: i
-00036a10: 6e64 6963 6573 206f 6620 6669 7273 7420  ndices of first 
-00036a20: 636f 726e 6572 206f 6620 6561 6368 2061  corner of each a
-00036a30: 7020 706f 6c79 676f 6e3a 206e 6120 3d20  p polygon: na = 
-00036a40: 6c65 6e28 6170 5f69 6e64 290a 2020 2020  len(ap_ind).    
-00036a50: 6c6f 6e67 5b3a 3a31 5d20 6170 5f69 6e64  long[::1] ap_ind
-00036a60: 2c0a 2020 2020 2320 6170 6572 7475 7265  ,.    # aperture
-00036a70: 733a 2070 6f6c 7967 6f6e 2063 6f6f 7264  s: polygon coord
-00036a80: 696e 6174 6573 2061 7320 7468 7265 6520  inates as three 
-00036a90: 3164 2061 7272 6179 730a 2020 2020 6e70  1d arrays.    np
-00036aa0: 2e6e 6461 7272 6179 5b64 6f75 626c 652c  .ndarray[double,
-00036ab0: 206e 6469 6d3d 315d 2061 705f 782c 0a20   ndim=1] ap_x,. 
-00036ac0: 2020 206e 702e 6e64 6172 7261 795b 646f     np.ndarray[do
-00036ad0: 7562 6c65 2c20 6e64 696d 3d31 5d20 6170  uble, ndim=1] ap
-00036ae0: 5f79 2c0a 2020 2020 6e70 2e6e 6461 7272  _y,.    np.ndarr
-00036af0: 6179 5b64 6f75 626c 652c 206e 6469 6d3d  ay[double, ndim=
-00036b00: 315d 2061 705f 7a2c 0a20 2020 2023 206e  1] ap_z,.    # n
-00036b10: 6f72 6d61 6c20 756e 6974 2076 6563 746f  ormal unit vecto
-00036b20: 7273 0a20 2020 2064 6f75 626c 655b 3a3a  rs.    double[::
-00036b30: 315d 2061 705f 6e6f 726d 5f78 2c0a 2020  1] ap_norm_x,.  
-00036b40: 2020 646f 7562 6c65 5b3a 3a31 5d20 6170    double[::1] ap
-00036b50: 5f6e 6f72 6d5f 792c 0a20 2020 2064 6f75  _norm_y,.    dou
-00036b60: 626c 655b 3a3a 315d 2061 705f 6e6f 726d  ble[::1] ap_norm
-00036b70: 5f7a 2c0a 2020 2020 2320 706f 7373 6962  _z,.    # possib
-00036b80: 6c65 2065 7874 7261 2070 6172 616d 6574  le extra paramet
-00036b90: 6572 7320 3f0a 2020 2020 646f 7562 6c65  ers ?.    double
-00036ba0: 206d 6172 6769 6e3d 5f56 534d 414c 4c2c   margin=_VSMALL,
-00036bb0: 0a20 2020 2069 6e74 206e 756d 5f74 6872  .    int num_thr
-00036bc0: 6561 6473 3d31 302c 0a29 3a0a 0a20 2020  eads=10,.):..   
-00036bd0: 2023 202d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20   # -----------. 
-00036be0: 2020 2023 2044 6563 6c61 7261 7469 6f6e     # Declaration
-00036bf0: 0a0a 2020 2020 6364 6566 2069 6e74 206e  ..    cdef int n
-00036c00: 7074 7320 3d20 7074 735f 782e 7369 7a65  pts = pts_x.size
-00036c10: 0a20 2020 2063 6465 6620 696e 7420 6e64  .    cdef int nd
-00036c20: 203d 2064 6574 5f63 656e 7473 5f78 2e73   = det_cents_x.s
-00036c30: 697a 650a 2020 2020 6364 6566 2069 6e74  ize.    cdef int
-00036c40: 206e 6120 3d20 6170 5f6e 6f72 6d5f 782e   na = ap_norm_x.
-00036c50: 7369 7a65 0a20 2020 2063 6465 6620 696e  size.    cdef in
-00036c60: 7420 6464 2c20 7070 2c20 6161 2c20 7474  t dd, pp, aa, tt
-00036c70: 0a20 2020 2063 6465 6620 696e 7420 6e70  .    cdef int np
-00036c80: 610a 2020 2020 6364 6566 2066 6c6f 6174  a.    cdef float
-00036c90: 2073 6361 2c20 7363 6130 2c20 7363 6131   sca, sca0, sca1
-00036ca0: 0a20 2020 2063 6465 6620 666c 6f61 7420  .    cdef float 
-00036cb0: 6b69 0a20 2020 2063 6465 6620 6e70 2e6e  ki.    cdef np.n
-00036cc0: 6461 7272 6179 5b64 6f75 626c 652c 206e  darray[double, n
-00036cd0: 6469 6d3d 315d 2061 705f 7830 203d 206e  dim=1] ap_x0 = n
-00036ce0: 702e 636f 7079 2861 705f 7829 0a20 2020  p.copy(ap_x).   
-00036cf0: 2063 6465 6620 6e70 2e6e 6461 7272 6179   cdef np.ndarray
-00036d00: 5b64 6f75 626c 652c 206e 6469 6d3d 315d  [double, ndim=1]
-00036d10: 2061 705f 7831 203d 206e 702e 636f 7079   ap_x1 = np.copy
-00036d20: 2861 705f 7829 0a20 2020 2063 6465 6620  (ap_x).    cdef 
-00036d30: 6e70 2e6e 6461 7272 6179 5b64 6f75 626c  np.ndarray[doubl
-00036d40: 652c 206e 6469 6d3d 315d 2070 5f61 5f78  e, ndim=1] p_a_x
-00036d50: 300a 2020 2020 6364 6566 206e 702e 6e64  0.    cdef np.nd
-00036d60: 6172 7261 795b 646f 7562 6c65 2c20 6e64  array[double, nd
-00036d70: 696d 3d31 5d20 705f 615f 7831 0a20 2020  im=1] p_a_x1.   
-00036d80: 2063 6465 6620 666c 6f61 7420 6378 302c   cdef float cx0,
-00036d90: 2063 7831 0a20 2020 2063 6465 6620 666c   cx1.    cdef fl
-00036da0: 6f61 7420 7578 2c20 7579 2c20 757a 2c20  oat ux, uy, uz, 
-00036db0: 696e 765f 6e6f 726d 0a20 2020 2063 6465  inv_norm.    cde
-00036dc0: 6620 6e70 2e6e 6461 7272 6179 5b6c 6f6e  f np.ndarray[lon
-00036dd0: 672c 206e 6469 6d3d 325d 2074 7269 0a20  g, ndim=2] tri. 
-00036de0: 2020 2063 6465 6620 6e70 2e6e 6461 7272     cdef np.ndarr
-00036df0: 6179 5b64 6f75 626c 652c 206e 6469 6d3d  ay[double, ndim=
-00036e00: 315d 2074 7269 5f78 0a20 2020 2063 6465  1] tri_x.    cde
-00036e10: 6620 6e70 2e6e 6461 7272 6179 5b64 6f75  f np.ndarray[dou
-00036e20: 626c 652c 206e 6469 6d3d 315d 2074 7269  ble, ndim=1] tri
-00036e30: 5f79 0a20 2020 2063 6465 6620 6e70 2e6e  _y.    cdef np.n
-00036e40: 6461 7272 6179 5b64 6f75 626c 652c 206e  darray[double, n
-00036e50: 6469 6d3d 315d 2074 7269 5f7a 0a0a 2020  dim=1] tri_z..  
-00036e60: 2020 2320 696e 6974 6961 6c69 7a65 2073    # initialize s
-00036e70: 6f6c 6964 2061 6e67 6c65 2061 7272 6179  olid angle array
-00036e80: 2077 6974 6820 7a65 726f 730a 2020 2020   with zeros.    
-00036e90: 6364 6566 206e 702e 6e64 6172 7261 795b  cdef np.ndarray[
-00036ea0: 646f 7562 6c65 2c20 6e64 696d 3d32 5d20  double, ndim=2] 
-00036eb0: 736f 6c69 645f 616e 676c 6520 3d20 6e70  solid_angle = np
-00036ec0: 2e7a 6572 6f73 2828 6e64 2c20 6e70 7473  .zeros((nd, npts
-00036ed0: 292c 2064 7479 7065 3d66 6c6f 6174 290a  ), dtype=float).
-00036ee0: 2020 2020 6364 6566 206e 702e 6e64 6172      cdef np.ndar
-00036ef0: 7261 795b 646f 7562 6c65 2c20 6e64 696d  ray[double, ndim
-00036f00: 3d32 5d20 7576 6563 745f 7820 3d20 6e70  =2] uvect_x = np
-00036f10: 2e7a 6572 6f73 2828 6e64 2c20 6e70 7473  .zeros((nd, npts
-00036f20: 292c 2064 7479 7065 3d66 6c6f 6174 290a  ), dtype=float).
-00036f30: 2020 2020 6364 6566 206e 702e 6e64 6172      cdef np.ndar
-00036f40: 7261 795b 646f 7562 6c65 2c20 6e64 696d  ray[double, ndim
-00036f50: 3d32 5d20 7576 6563 745f 7920 3d20 6e70  =2] uvect_y = np
-00036f60: 2e7a 6572 6f73 2828 6e64 2c20 6e70 7473  .zeros((nd, npts
-00036f70: 292c 2064 7479 7065 3d66 6c6f 6174 290a  ), dtype=float).
-00036f80: 2020 2020 6364 6566 206e 702e 6e64 6172      cdef np.ndar
-00036f90: 7261 795b 646f 7562 6c65 2c20 6e64 696d  ray[double, ndim
-00036fa0: 3d32 5d20 7576 6563 745f 7a20 3d20 6e70  =2] uvect_z = np
-00036fb0: 2e7a 6572 6f73 2828 6e64 2c20 6e70 7473  .zeros((nd, npts
-00036fc0: 292c 2064 7479 7065 3d66 6c6f 6174 290a  ), dtype=float).
-00036fd0: 0a20 2020 2023 202d 2d2d 2d2d 2d2d 0a20  .    # -------. 
-00036fe0: 2020 2023 2043 6f6d 7075 7465 0a0a 2020     # Compute..  
-00036ff0: 2020 666f 7220 6464 2069 6e20 7261 6e67    for dd in rang
-00037000: 6528 6e64 293a 0a0a 2020 2020 2020 2020  e(nd):..        
-00037010: 2320 6c6f 6f70 2032 3a20 6f6e 206e 7074  # loop 2: on npt
-00037020: 7320 286f 6273 6572 7661 7469 6f6e 2070  s (observation p
-00037030: 6f69 6e74 7329 0a20 2020 2020 2020 2066  oints).        f
-00037040: 6f72 2070 7020 696e 2072 616e 6765 286e  or pp in range(n
-00037050: 7074 7329 3a0a 0a20 2020 2020 2020 2020  pts):..         
-00037060: 2020 2023 2074 6573 7420 6966 206f 6e20     # test if on 
-00037070: 676f 6f64 2073 6964 6520 6f66 2064 6574  good side of det
-00037080: 6563 746f 720a 2020 2020 2020 2020 2020  ector.          
-00037090: 2020 7363 6130 203d 2028 0a20 2020 2020    sca0 = (.     
-000370a0: 2020 2020 2020 2020 2020 2028 7074 735f             (pts_
-000370b0: 785b 7070 5d20 2d20 6465 745f 6365 6e74  x[pp] - det_cent
-000370c0: 735f 785b 6464 5d29 202a 2064 6574 5f6e  s_x[dd]) * det_n
-000370d0: 6f72 6d5f 785b 6464 5d0a 2020 2020 2020  orm_x[dd].      
-000370e0: 2020 2020 2020 2020 2020 2b20 2870 7473            + (pts
-000370f0: 5f79 5b70 705d 202d 2064 6574 5f63 656e  _y[pp] - det_cen
-00037100: 7473 5f79 5b64 645d 2920 2a20 6465 745f  ts_y[dd]) * det_
-00037110: 6e6f 726d 5f79 5b64 645d 0a20 2020 2020  norm_y[dd].     
-00037120: 2020 2020 2020 2020 2020 202b 2028 7074             + (pt
-00037130: 735f 7a5b 7070 5d20 2d20 6465 745f 6365  s_z[pp] - det_ce
-00037140: 6e74 735f 7a5b 6464 5d29 202a 2064 6574  nts_z[dd]) * det
-00037150: 5f6e 6f72 6d5f 7a5b 6464 5d0a 2020 2020  _norm_z[dd].    
-00037160: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00037170: 2020 2020 2020 2069 6620 7363 6130 203c         if sca0 <
-00037180: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
-00037190: 2020 2020 2063 6f6e 7469 6e75 650a 0a20       continue.. 
-000371a0: 2020 2020 2020 2020 2020 2023 2066 6c61             # fla
-000371b0: 670a 2020 2020 2020 2020 2020 2020 6973  g.            is
-000371c0: 6f6b 203d 2054 7275 650a 0a20 2020 2020  ok = True..     
-000371d0: 2020 2020 2020 2023 206c 6f6f 7020 333a         # loop 3:
-000371e0: 206f 6e20 6e61 2028 6170 6572 7475 7265   on na (aperture
-000371f0: 7329 0a20 2020 2020 2020 2020 2020 2066  s).            f
-00037200: 6f72 2061 6120 696e 2072 616e 6765 286e  or aa in range(n
-00037210: 6129 3a0a 0a20 2020 2020 2020 2020 2020  a):..           
-00037220: 2020 2020 2023 2074 6573 7420 6966 206f       # test if o
-00037230: 6e20 676f 6f64 2073 6964 6520 6f66 2061  n good side of a
-00037240: 7065 7274 7572 650a 2020 2020 2020 2020  perture.        
-00037250: 2020 2020 2020 2020 7363 6120 3d20 280a          sca = (.
-00037260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037270: 2020 2020 2870 7473 5f78 5b70 705d 202d      (pts_x[pp] -
-00037280: 2061 705f 785b 6170 5f69 6e64 5b61 615d   ap_x[ap_ind[aa]
-00037290: 5d29 202a 2061 705f 6e6f 726d 5f78 5b61  ]) * ap_norm_x[a
-000372a0: 615d 0a20 2020 2020 2020 2020 2020 2020  a].             
-000372b0: 2020 2020 2020 202b 2028 7074 735f 795b         + (pts_y[
-000372c0: 7070 5d20 2d20 6170 5f79 5b61 705f 696e  pp] - ap_y[ap_in
-000372d0: 645b 6161 5d5d 2920 2a20 6170 5f6e 6f72  d[aa]]) * ap_nor
-000372e0: 6d5f 795b 6161 5d0a 2020 2020 2020 2020  m_y[aa].        
-000372f0: 2020 2020 2020 2020 2020 2020 2b20 2870              + (p
-00037300: 7473 5f7a 5b70 705d 202d 2061 705f 7a5b  ts_z[pp] - ap_z[
-00037310: 6170 5f69 6e64 5b61 615d 5d29 202a 2061  ap_ind[aa]]) * a
-00037320: 705f 6e6f 726d 5f7a 5b61 615d 0a20 2020  p_norm_z[aa].   
-00037330: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
-00037340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037350: 6966 2073 6361 203c 3d20 303a 0a20 2020  if sca <= 0:.   
+00036450: 2020 2020 2020 2020 2069 6e64 5f72 7a32           ind_rz2
+00036460: 706f 6c2c 0a20 2020 2020 2020 2020 2020  pol,.           
+00036470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036480: 737a 5f70 6869 2c0a 2020 2020 2020 2020  sz_phi,.        
+00036490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000364a0: 2020 2072 6573 6f5f 7264 7264 7a5f 6d76     reso_rdrdz_mv
+000364b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000364c0: 2020 2020 2020 2020 2020 2020 2070 7473               pts
+000364d0: 5f6d 762c 0a20 2020 2020 2020 2020 2020  _mv,.           
+000364e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000364f0: 696e 645f 6d76 2c0a 2020 2020 2020 2020  ind_mv,.        
+00036500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036510: 2020 206e 756d 5f74 6872 6561 6473 290a     num_threads).
+00036520: 2020 2020 2320 2e2e 2e20 6672 6565 696e      # ... freein
+00036530: 6720 7570 206d 656d 6f72 7920 2e2e 2e2e  g up memory ....
+00036540: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00036550: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00036560: 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e 2e2e  ................
+00036570: 0a20 2020 2066 7265 6528 6c69 6e64 6578  .    free(lindex
+00036580: 5f7a 290a 2020 2020 6672 6565 2864 6973  _z).    free(dis
+00036590: 635f 7229 0a20 2020 2066 7265 6528 6469  c_r).    free(di
+000365a0: 7363 5f7a 290a 2020 2020 6672 6565 2864  sc_z).    free(d
+000365b0: 6973 635f 7230 290a 2020 2020 6672 6565  isc_r0).    free
+000365c0: 2873 7a5f 7068 6929 0a20 2020 2066 7265  (sz_phi).    fre
+000365d0: 6528 7374 6570 5f72 7068 6929 0a20 2020  e(step_rphi).   
+000365e0: 2066 7265 6528 6e63 656c 6c73 5f72 7068   free(ncells_rph
+000365f0: 6929 0a0a 2020 2020 7265 7475 726e 2070  i)..    return p
+00036600: 7473 2c20 7361 5f6d 6170 2c20 696e 642c  ts, sa_map, ind,
+00036610: 2072 6573 6f5f 725f 7a0a 0a0a 2320 3d3d   reso_r_z...# ==
+00036620: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00036630: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00036640: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00036650: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00036660: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 0a23 0a23  ============.#.#
+00036670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036680: 2020 2020 2020 2053 6f6c 6964 2041 6e67         Solid Ang
+00036690: 6c65 2043 6f6d 7075 7461 7469 6f6e 0a23  le Computation.#
+000366a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000366b0: 2020 2073 7562 7465 6e64 6564 2062 7920     subtended by 
+000366c0: 6d75 6c74 6970 6c65 2061 7065 7274 7572  multiple apertur
+000366d0: 6573 0a23 0a23 203d 3d3d 3d3d 3d3d 3d3d  es.#.# =========
+000366e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000366f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00036700: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00036710: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00036720: 3d3d 3d3d 3d0a 0a0a 6465 6620 636f 6d70  =====...def comp
+00036730: 7574 655f 736f 6c69 645f 616e 676c 655f  ute_solid_angle_
+00036740: 6170 6572 7475 7265 735f 756e 6974 7665  apertures_unitve
+00036750: 6374 6f72 7328 0a20 2020 2023 2070 7473  ctors(.    # pts
+00036760: 3a20 636f 6f72 6469 6e61 7465 7320 6173  : coordinates as
+00036770: 2074 6872 6565 2031 6420 6172 7261 7973   three 1d arrays
+00036780: 0a20 2020 2064 6f75 626c 655b 3a3a 315d  .    double[::1]
+00036790: 2070 7473 5f78 2c0a 2020 2020 646f 7562   pts_x,.    doub
+000367a0: 6c65 5b3a 3a31 5d20 7074 735f 792c 0a20  le[::1] pts_y,. 
+000367b0: 2020 2064 6f75 626c 655b 3a3a 315d 2070     double[::1] p
+000367c0: 7473 5f7a 2c0a 2020 2020 2320 6465 7465  ts_z,.    # dete
+000367d0: 6374 6f72 733a 2070 6f6c 7967 6f6e 2063  ctors: polygon c
+000367e0: 6f6f 7264 696e 6174 6573 2069 6e20 3264  oordinates in 2d
+000367f0: 2028 636f 6d6d 6f6e 2074 6f20 616c 6c20   (common to all 
+00036800: 6465 7465 6374 6f72 7329 0a20 2020 2064  detectors).    d
+00036810: 6f75 626c 655b 3a3a 315d 2064 6574 5f6f  ouble[::1] det_o
+00036820: 7574 6c69 6e65 5f78 302c 0a20 2020 2064  utline_x0,.    d
+00036830: 6f75 626c 655b 3a3a 315d 2064 6574 5f6f  ouble[::1] det_o
+00036840: 7574 6c69 6e65 5f78 312c 0a20 2020 2023  utline_x1,.    #
+00036850: 2064 6574 6563 746f 7273 3a20 6365 6e74   detectors: cent
+00036860: 6572 7320 636f 6f72 6469 6e61 7465 7320  ers coordinates 
+00036870: 6173 2074 6872 6565 2031 6420 6172 7261  as three 1d arra
+00036880: 7973 0a20 2020 2064 6f75 626c 655b 3a3a  ys.    double[::
+00036890: 315d 2064 6574 5f63 656e 7473 5f78 2c0a  1] det_cents_x,.
+000368a0: 2020 2020 646f 7562 6c65 5b3a 3a31 5d20      double[::1] 
+000368b0: 6465 745f 6365 6e74 735f 792c 0a20 2020  det_cents_y,.   
+000368c0: 2064 6f75 626c 655b 3a3a 315d 2064 6574   double[::1] det
+000368d0: 5f63 656e 7473 5f7a 2c0a 2020 2020 2320  _cents_z,.    # 
+000368e0: 6465 7465 6374 6f72 733a 206e 6f72 6d61  detectors: norma
+000368f0: 6c20 756e 6974 2076 6563 746f 7273 2061  l unit vectors a
+00036900: 7320 7468 7265 6520 3164 2061 7272 6179  s three 1d array
+00036910: 7320 286e 6420 3d20 6c65 6e28 6465 745f  s (nd = len(det_
+00036920: 6e6f 726d 5f78 2929 0a20 2020 2064 6f75  norm_x)).    dou
+00036930: 626c 655b 3a3a 315d 2064 6574 5f6e 6f72  ble[::1] det_nor
+00036940: 6d5f 782c 0a20 2020 2064 6f75 626c 655b  m_x,.    double[
+00036950: 3a3a 315d 2064 6574 5f6e 6f72 6d5f 792c  ::1] det_norm_y,
+00036960: 0a20 2020 2064 6f75 626c 655b 3a3a 315d  .    double[::1]
+00036970: 2064 6574 5f6e 6f72 6d5f 7a2c 0a20 2020   det_norm_z,.   
+00036980: 206e 702e 6e64 6172 7261 795b 646f 7562   np.ndarray[doub
+00036990: 6c65 2c20 6e64 696d 3d31 5d20 6465 745f  le, ndim=1] det_
+000369a0: 6530 5f78 2c0a 2020 2020 6e70 2e6e 6461  e0_x,.    np.nda
+000369b0: 7272 6179 5b64 6f75 626c 652c 206e 6469  rray[double, ndi
+000369c0: 6d3d 315d 2064 6574 5f65 305f 792c 0a20  m=1] det_e0_y,. 
+000369d0: 2020 206e 702e 6e64 6172 7261 795b 646f     np.ndarray[do
+000369e0: 7562 6c65 2c20 6e64 696d 3d31 5d20 6465  uble, ndim=1] de
+000369f0: 745f 6530 5f7a 2c0a 2020 2020 6e70 2e6e  t_e0_z,.    np.n
+00036a00: 6461 7272 6179 5b64 6f75 626c 652c 206e  darray[double, n
+00036a10: 6469 6d3d 315d 2064 6574 5f65 315f 782c  dim=1] det_e1_x,
+00036a20: 0a20 2020 206e 702e 6e64 6172 7261 795b  .    np.ndarray[
+00036a30: 646f 7562 6c65 2c20 6e64 696d 3d31 5d20  double, ndim=1] 
+00036a40: 6465 745f 6531 5f79 2c0a 2020 2020 6e70  det_e1_y,.    np
+00036a50: 2e6e 6461 7272 6179 5b64 6f75 626c 652c  .ndarray[double,
+00036a60: 206e 6469 6d3d 315d 2064 6574 5f65 315f   ndim=1] det_e1_
+00036a70: 7a2c 0a20 2020 2023 2061 7065 7274 7572  z,.    # apertur
+00036a80: 6573 3a20 696e 6469 6365 7320 6f66 2066  es: indices of f
+00036a90: 6972 7374 2063 6f72 6e65 7220 6f66 2065  irst corner of e
+00036aa0: 6163 6820 6170 2070 6f6c 7967 6f6e 3a20  ach ap polygon: 
+00036ab0: 6e61 203d 206c 656e 2861 705f 696e 6429  na = len(ap_ind)
+00036ac0: 0a20 2020 206c 6f6e 675b 3a3a 315d 2061  .    long[::1] a
+00036ad0: 705f 696e 642c 0a20 2020 2023 2061 7065  p_ind,.    # ape
+00036ae0: 7274 7572 6573 3a20 706f 6c79 676f 6e20  rtures: polygon 
+00036af0: 636f 6f72 6469 6e61 7465 7320 6173 2074  coordinates as t
+00036b00: 6872 6565 2031 6420 6172 7261 7973 0a20  hree 1d arrays. 
+00036b10: 2020 206e 702e 6e64 6172 7261 795b 646f     np.ndarray[do
+00036b20: 7562 6c65 2c20 6e64 696d 3d31 5d20 6170  uble, ndim=1] ap
+00036b30: 5f78 2c0a 2020 2020 6e70 2e6e 6461 7272  _x,.    np.ndarr
+00036b40: 6179 5b64 6f75 626c 652c 206e 6469 6d3d  ay[double, ndim=
+00036b50: 315d 2061 705f 792c 0a20 2020 206e 702e  1] ap_y,.    np.
+00036b60: 6e64 6172 7261 795b 646f 7562 6c65 2c20  ndarray[double, 
+00036b70: 6e64 696d 3d31 5d20 6170 5f7a 2c0a 2020  ndim=1] ap_z,.  
+00036b80: 2020 2320 6e6f 726d 616c 2075 6e69 7420    # normal unit 
+00036b90: 7665 6374 6f72 730a 2020 2020 646f 7562  vectors.    doub
+00036ba0: 6c65 5b3a 3a31 5d20 6170 5f6e 6f72 6d5f  le[::1] ap_norm_
+00036bb0: 782c 0a20 2020 2064 6f75 626c 655b 3a3a  x,.    double[::
+00036bc0: 315d 2061 705f 6e6f 726d 5f79 2c0a 2020  1] ap_norm_y,.  
+00036bd0: 2020 646f 7562 6c65 5b3a 3a31 5d20 6170    double[::1] ap
+00036be0: 5f6e 6f72 6d5f 7a2c 0a20 2020 2023 2070  _norm_z,.    # p
+00036bf0: 6f73 7369 626c 6520 6578 7472 6120 7061  ossible extra pa
+00036c00: 7261 6d65 7465 7273 203f 0a20 2020 2064  rameters ?.    d
+00036c10: 6f75 626c 6520 6d61 7267 696e 3d5f 5653  ouble margin=_VS
+00036c20: 4d41 4c4c 2c0a 2020 2020 696e 7420 6e75  MALL,.    int nu
+00036c30: 6d5f 7468 7265 6164 733d 3130 2c0a 293a  m_threads=10,.):
+00036c40: 0a0a 2020 2020 2320 2d2d 2d2d 2d2d 2d2d  ..    # --------
+00036c50: 2d2d 2d0a 2020 2020 2320 4465 636c 6172  ---.    # Declar
+00036c60: 6174 696f 6e0a 0a20 2020 2063 6465 6620  ation..    cdef 
+00036c70: 696e 7420 6e70 7473 203d 2070 7473 5f78  int npts = pts_x
+00036c80: 2e73 697a 650a 2020 2020 6364 6566 2069  .size.    cdef i
+00036c90: 6e74 206e 6420 3d20 6465 745f 6365 6e74  nt nd = det_cent
+00036ca0: 735f 782e 7369 7a65 0a20 2020 2063 6465  s_x.size.    cde
+00036cb0: 6620 696e 7420 6e61 203d 2061 705f 6e6f  f int na = ap_no
+00036cc0: 726d 5f78 2e73 697a 650a 2020 2020 6364  rm_x.size.    cd
+00036cd0: 6566 2069 6e74 2064 642c 2070 702c 2061  ef int dd, pp, a
+00036ce0: 612c 2074 740a 2020 2020 6364 6566 2069  a, tt.    cdef i
+00036cf0: 6e74 206e 7061 0a20 2020 2063 6465 6620  nt npa.    cdef 
+00036d00: 666c 6f61 7420 7363 612c 2073 6361 302c  float sca, sca0,
+00036d10: 2073 6361 310a 2020 2020 6364 6566 2066   sca1.    cdef f
+00036d20: 6c6f 6174 206b 690a 2020 2020 6364 6566  loat ki.    cdef
+00036d30: 206e 702e 6e64 6172 7261 795b 646f 7562   np.ndarray[doub
+00036d40: 6c65 2c20 6e64 696d 3d31 5d20 6170 5f78  le, ndim=1] ap_x
+00036d50: 3020 3d20 6e70 2e63 6f70 7928 6170 5f78  0 = np.copy(ap_x
+00036d60: 290a 2020 2020 6364 6566 206e 702e 6e64  ).    cdef np.nd
+00036d70: 6172 7261 795b 646f 7562 6c65 2c20 6e64  array[double, nd
+00036d80: 696d 3d31 5d20 6170 5f78 3120 3d20 6e70  im=1] ap_x1 = np
+00036d90: 2e63 6f70 7928 6170 5f78 290a 2020 2020  .copy(ap_x).    
+00036da0: 6364 6566 206e 702e 6e64 6172 7261 795b  cdef np.ndarray[
+00036db0: 646f 7562 6c65 2c20 6e64 696d 3d31 5d20  double, ndim=1] 
+00036dc0: 705f 615f 7830 0a20 2020 2063 6465 6620  p_a_x0.    cdef 
+00036dd0: 6e70 2e6e 6461 7272 6179 5b64 6f75 626c  np.ndarray[doubl
+00036de0: 652c 206e 6469 6d3d 315d 2070 5f61 5f78  e, ndim=1] p_a_x
+00036df0: 310a 2020 2020 6364 6566 2066 6c6f 6174  1.    cdef float
+00036e00: 2063 7830 2c20 6378 310a 2020 2020 6364   cx0, cx1.    cd
+00036e10: 6566 2066 6c6f 6174 2075 782c 2075 792c  ef float ux, uy,
+00036e20: 2075 7a2c 2069 6e76 5f6e 6f72 6d0a 2020   uz, inv_norm.  
+00036e30: 2020 6364 6566 206e 702e 6e64 6172 7261    cdef np.ndarra
+00036e40: 795b 6c6f 6e67 2c20 6e64 696d 3d32 5d20  y[long, ndim=2] 
+00036e50: 7472 690a 2020 2020 6364 6566 206e 702e  tri.    cdef np.
+00036e60: 6e64 6172 7261 795b 646f 7562 6c65 2c20  ndarray[double, 
+00036e70: 6e64 696d 3d31 5d20 7472 695f 780a 2020  ndim=1] tri_x.  
+00036e80: 2020 6364 6566 206e 702e 6e64 6172 7261    cdef np.ndarra
+00036e90: 795b 646f 7562 6c65 2c20 6e64 696d 3d31  y[double, ndim=1
+00036ea0: 5d20 7472 695f 790a 2020 2020 6364 6566  ] tri_y.    cdef
+00036eb0: 206e 702e 6e64 6172 7261 795b 646f 7562   np.ndarray[doub
+00036ec0: 6c65 2c20 6e64 696d 3d31 5d20 7472 695f  le, ndim=1] tri_
+00036ed0: 7a0a 0a20 2020 2023 2069 6e69 7469 616c  z..    # initial
+00036ee0: 697a 6520 736f 6c69 6420 616e 676c 6520  ize solid angle 
+00036ef0: 6172 7261 7920 7769 7468 207a 6572 6f73  array with zeros
+00036f00: 0a20 2020 2063 6465 6620 6e70 2e6e 6461  .    cdef np.nda
+00036f10: 7272 6179 5b64 6f75 626c 652c 206e 6469  rray[double, ndi
+00036f20: 6d3d 325d 2073 6f6c 6964 5f61 6e67 6c65  m=2] solid_angle
+00036f30: 203d 206e 702e 7a65 726f 7328 286e 642c   = np.zeros((nd,
+00036f40: 206e 7074 7329 2c20 6474 7970 653d 666c   npts), dtype=fl
+00036f50: 6f61 7429 0a20 2020 2063 6465 6620 6e70  oat).    cdef np
+00036f60: 2e6e 6461 7272 6179 5b64 6f75 626c 652c  .ndarray[double,
+00036f70: 206e 6469 6d3d 325d 2075 7665 6374 5f78   ndim=2] uvect_x
+00036f80: 203d 206e 702e 7a65 726f 7328 286e 642c   = np.zeros((nd,
+00036f90: 206e 7074 7329 2c20 6474 7970 653d 666c   npts), dtype=fl
+00036fa0: 6f61 7429 0a20 2020 2063 6465 6620 6e70  oat).    cdef np
+00036fb0: 2e6e 6461 7272 6179 5b64 6f75 626c 652c  .ndarray[double,
+00036fc0: 206e 6469 6d3d 325d 2075 7665 6374 5f79   ndim=2] uvect_y
+00036fd0: 203d 206e 702e 7a65 726f 7328 286e 642c   = np.zeros((nd,
+00036fe0: 206e 7074 7329 2c20 6474 7970 653d 666c   npts), dtype=fl
+00036ff0: 6f61 7429 0a20 2020 2063 6465 6620 6e70  oat).    cdef np
+00037000: 2e6e 6461 7272 6179 5b64 6f75 626c 652c  .ndarray[double,
+00037010: 206e 6469 6d3d 325d 2075 7665 6374 5f7a   ndim=2] uvect_z
+00037020: 203d 206e 702e 7a65 726f 7328 286e 642c   = np.zeros((nd,
+00037030: 206e 7074 7329 2c20 6474 7970 653d 666c   npts), dtype=fl
+00037040: 6f61 7429 0a0a 2020 2020 2320 2d2d 2d2d  oat)..    # ----
+00037050: 2d2d 2d0a 2020 2020 2320 436f 6d70 7574  ---.    # Comput
+00037060: 650a 0a20 2020 2066 6f72 2064 6420 696e  e..    for dd in
+00037070: 2072 616e 6765 286e 6429 3a0a 0a20 2020   range(nd):..   
+00037080: 2020 2020 2023 206c 6f6f 7020 323a 206f       # loop 2: o
+00037090: 6e20 6e70 7473 2028 6f62 7365 7276 6174  n npts (observat
+000370a0: 696f 6e20 706f 696e 7473 290a 2020 2020  ion points).    
+000370b0: 2020 2020 666f 7220 7070 2069 6e20 7261      for pp in ra
+000370c0: 6e67 6528 6e70 7473 293a 0a0a 2020 2020  nge(npts):..    
+000370d0: 2020 2020 2020 2020 2320 7465 7374 2069          # test i
+000370e0: 6620 6f6e 2067 6f6f 6420 7369 6465 206f  f on good side o
+000370f0: 6620 6465 7465 6374 6f72 0a20 2020 2020  f detector.     
+00037100: 2020 2020 2020 2073 6361 3020 3d20 280a         sca0 = (.
+00037110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037120: 2870 7473 5f78 5b70 705d 202d 2064 6574  (pts_x[pp] - det
+00037130: 5f63 656e 7473 5f78 5b64 645d 2920 2a20  _cents_x[dd]) * 
+00037140: 6465 745f 6e6f 726d 5f78 5b64 645d 0a20  det_norm_x[dd]. 
+00037150: 2020 2020 2020 2020 2020 2020 2020 202b                 +
+00037160: 2028 7074 735f 795b 7070 5d20 2d20 6465   (pts_y[pp] - de
+00037170: 745f 6365 6e74 735f 795b 6464 5d29 202a  t_cents_y[dd]) *
+00037180: 2064 6574 5f6e 6f72 6d5f 795b 6464 5d0a   det_norm_y[dd].
+00037190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000371a0: 2b20 2870 7473 5f7a 5b70 705d 202d 2064  + (pts_z[pp] - d
+000371b0: 6574 5f63 656e 7473 5f7a 5b64 645d 2920  et_cents_z[dd]) 
+000371c0: 2a20 6465 745f 6e6f 726d 5f7a 5b64 645d  * det_norm_z[dd]
+000371d0: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+000371e0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+000371f0: 6361 3020 3c3d 2030 3a0a 2020 2020 2020  ca0 <= 0:.      
+00037200: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
+00037210: 7565 0a0a 2020 2020 2020 2020 2020 2020  ue..            
+00037220: 2320 666c 6167 0a20 2020 2020 2020 2020  # flag.         
+00037230: 2020 2069 736f 6b20 3d20 5472 7565 0a0a     isok = True..
+00037240: 2020 2020 2020 2020 2020 2020 2320 6c6f              # lo
+00037250: 6f70 2033 3a20 6f6e 206e 6120 2861 7065  op 3: on na (ape
+00037260: 7274 7572 6573 290a 2020 2020 2020 2020  rtures).        
+00037270: 2020 2020 666f 7220 6161 2069 6e20 7261      for aa in ra
+00037280: 6e67 6528 6e61 293a 0a0a 2020 2020 2020  nge(na):..      
+00037290: 2020 2020 2020 2020 2020 2320 7465 7374            # test
+000372a0: 2069 6620 6f6e 2067 6f6f 6420 7369 6465   if on good side
+000372b0: 206f 6620 6170 6572 7475 7265 0a20 2020   of aperture.   
+000372c0: 2020 2020 2020 2020 2020 2020 2073 6361               sca
+000372d0: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+000372e0: 2020 2020 2020 2020 2028 7074 735f 785b           (pts_x[
+000372f0: 7070 5d20 2d20 6170 5f78 5b61 705f 696e  pp] - ap_x[ap_in
+00037300: 645b 6161 5d5d 2920 2a20 6170 5f6e 6f72  d[aa]]) * ap_nor
+00037310: 6d5f 785b 6161 5d0a 2020 2020 2020 2020  m_x[aa].        
+00037320: 2020 2020 2020 2020 2020 2020 2b20 2870              + (p
+00037330: 7473 5f79 5b70 705d 202d 2061 705f 795b  ts_y[pp] - ap_y[
+00037340: 6170 5f69 6e64 5b61 615d 5d29 202a 2061  ap_ind[aa]]) * a
+00037350: 705f 6e6f 726d 5f79 5b61 615d 0a20 2020  p_norm_y[aa].   
 00037360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037370: 2069 736f 6b20 3d20 4661 6c73 650a 2020   isok = False.  
-00037380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037390: 2020 6272 6561 6b0a 0a20 2020 2020 2020    break..       
-000373a0: 2020 2020 2020 2020 2023 2074 6573 7420           # test 
-000373b0: 6966 2061 6c6c 2061 7065 7274 7572 6520  if all aperture 
-000373c0: 706f 696e 7473 2063 616e 2062 6520 7072  points can be pr
-000373d0: 6f6a 6563 7465 6420 6f6e 2064 6574 6563  ojected on detec
-000373e0: 746f 7220 706c 616e 6520 6672 6f6d 2070  tor plane from p
-000373f0: 7473 0a20 2020 2020 2020 2020 2020 2020  ts.             
-00037400: 2020 2066 6f72 206c 6c20 696e 2072 616e     for ll in ran
-00037410: 6765 2861 705f 696e 645b 6161 5d2c 2061  ge(ap_ind[aa], a
-00037420: 705f 696e 645b 6161 2b31 5d29 3a0a 2020  p_ind[aa+1]):.  
-00037430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037440: 2020 7363 6131 203d 2028 0a20 2020 2020    sca1 = (.     
-00037450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037460: 2020 2028 6170 5f78 5b6c 6c5d 202d 2070     (ap_x[ll] - p
-00037470: 7473 5f78 5b70 705d 2920 2a20 6465 745f  ts_x[pp]) * det_
-00037480: 6e6f 726d 5f78 5b64 645d 0a20 2020 2020  norm_x[dd].     
-00037490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000374a0: 2020 202b 2028 6170 5f79 5b6c 6c5d 202d     + (ap_y[ll] -
-000374b0: 2070 7473 5f79 5b70 705d 2920 2a20 6465   pts_y[pp]) * de
-000374c0: 745f 6e6f 726d 5f79 5b64 645d 0a20 2020  t_norm_y[dd].   
-000374d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000374e0: 2020 2020 202b 2028 6170 5f7a 5b6c 6c5d       + (ap_z[ll]
-000374f0: 202d 2070 7473 5f7a 5b70 705d 2920 2a20   - pts_z[pp]) * 
-00037500: 6465 745f 6e6f 726d 5f7a 5b64 645d 0a20  det_norm_z[dd]. 
-00037510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037520: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
-00037530: 2020 2020 2020 2020 2020 6966 2073 6361            if sca
-00037540: 3120 3e3d 2030 3a0a 2020 2020 2020 2020  1 >= 0:.        
-00037550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037560: 6973 6f6b 203d 2046 616c 7365 0a20 2020  isok = False.   
-00037570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037580: 2020 2020 2062 7265 616b 0a0a 2020 2020       break..    
-00037590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000375a0: 2320 7072 6f6a 6563 7420 696e 2032 640a  # project in 2d.
-000375b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000375c0: 2020 2020 6b20 3d20 2d20 7363 6130 202f      k = - sca0 /
-000375d0: 2073 6361 310a 2020 2020 2020 2020 2020   sca1.          
-000375e0: 2020 2020 2020 2020 2020 505f 7820 3d20            P_x = 
-000375f0: 7074 735f 785b 7070 5d20 2b20 6b20 2a20  pts_x[pp] + k * 
-00037600: 2861 705f 785b 6c6c 5d20 2d20 7074 735f  (ap_x[ll] - pts_
-00037610: 785b 7070 5d29 0a20 2020 2020 2020 2020  x[pp]).         
-00037620: 2020 2020 2020 2020 2020 2050 5f79 203d             P_y =
-00037630: 2070 7473 5f79 5b70 705d 202b 206b 202a   pts_y[pp] + k *
-00037640: 2028 6170 5f79 5b6c 6c5d 202d 2070 7473   (ap_y[ll] - pts
-00037650: 5f79 5b70 705d 290a 2020 2020 2020 2020  _y[pp]).        
-00037660: 2020 2020 2020 2020 2020 2020 505f 7a20              P_z 
-00037670: 3d20 7074 735f 7a5b 7070 5d20 2b20 6b20  = pts_z[pp] + k 
-00037680: 2a20 2861 705f 7a5b 6c6c 5d20 2d20 7074  * (ap_z[ll] - pt
-00037690: 735f 7a5b 7070 5d29 0a0a 2020 2020 2020  s_z[pp])..      
-000376a0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-000376b0: 7072 6f6a 6563 7420 696e 2032 640a 2020  project in 2d.  
-000376c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000376d0: 2020 6170 5f78 305b 6c6c 5d20 3d20 280a    ap_x0[ll] = (.
-000376e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000376f0: 2020 2020 2020 2020 2850 5f78 202d 2064          (P_x - d
-00037700: 6574 5f63 656e 7473 5f78 5b64 645d 2920  et_cents_x[dd]) 
-00037710: 2a20 6465 745f 6530 5f78 5b64 645d 0a20  * det_e0_x[dd]. 
-00037720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037730: 2020 2020 2020 202b 2028 505f 7920 2d20         + (P_y - 
-00037740: 6465 745f 6365 6e74 735f 795b 6464 5d29  det_cents_y[dd])
-00037750: 202a 2064 6574 5f65 305f 795b 6464 5d0a   * det_e0_y[dd].
-00037760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037770: 2020 2020 2020 2020 2b20 2850 5f7a 202d          + (P_z -
-00037780: 2064 6574 5f63 656e 7473 5f7a 5b64 645d   det_cents_z[dd]
-00037790: 2920 2a20 6465 745f 6530 5f7a 5b64 645d  ) * det_e0_z[dd]
-000377a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000377b0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-000377c0: 2020 2020 2020 2020 2020 2061 705f 7831             ap_x1
-000377d0: 5b6c 6c5d 203d 2028 0a20 2020 2020 2020  [ll] = (.       
-000377e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000377f0: 2028 505f 7820 2d20 6465 745f 6365 6e74   (P_x - det_cent
-00037800: 735f 785b 6464 5d29 202a 2064 6574 5f65  s_x[dd]) * det_e
-00037810: 315f 785b 6464 5d0a 2020 2020 2020 2020  1_x[dd].        
-00037820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037830: 2b20 2850 5f79 202d 2064 6574 5f63 656e  + (P_y - det_cen
-00037840: 7473 5f79 5b64 645d 2920 2a20 6465 745f  ts_y[dd]) * det_
-00037850: 6531 5f79 5b64 645d 0a20 2020 2020 2020  e1_y[dd].       
-00037860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037870: 202b 2028 505f 7a20 2d20 6465 745f 6365   + (P_z - det_ce
-00037880: 6e74 735f 7a5b 6464 5d29 202a 2064 6574  nts_z[dd]) * det
-00037890: 5f65 315f 7a5b 6464 5d0a 2020 2020 2020  _e1_z[dd].      
-000378a0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-000378b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000378c0: 2069 6620 6e6f 7420 6973 6f6b 3a0a 2020   if not isok:.  
+00037370: 202b 2028 7074 735f 7a5b 7070 5d20 2d20   + (pts_z[pp] - 
+00037380: 6170 5f7a 5b61 705f 696e 645b 6161 5d5d  ap_z[ap_ind[aa]]
+00037390: 2920 2a20 6170 5f6e 6f72 6d5f 7a5b 6161  ) * ap_norm_z[aa
+000373a0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+000373b0: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
+000373c0: 2020 2020 2069 6620 7363 6120 3c3d 2030       if sca <= 0
+000373d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000373e0: 2020 2020 2020 6973 6f6b 203d 2046 616c        isok = Fal
+000373f0: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
+00037400: 2020 2020 2020 2062 7265 616b 0a0a 2020         break..  
+00037410: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00037420: 7465 7374 2069 6620 616c 6c20 6170 6572  test if all aper
+00037430: 7475 7265 2070 6f69 6e74 7320 6361 6e20  ture points can 
+00037440: 6265 2070 726f 6a65 6374 6564 206f 6e20  be projected on 
+00037450: 6465 7465 6374 6f72 2070 6c61 6e65 2066  detector plane f
+00037460: 726f 6d20 7074 730a 2020 2020 2020 2020  rom pts.        
+00037470: 2020 2020 2020 2020 666f 7220 6c6c 2069          for ll i
+00037480: 6e20 7261 6e67 6528 6170 5f69 6e64 5b61  n range(ap_ind[a
+00037490: 615d 2c20 6170 5f69 6e64 5b61 612b 315d  a], ap_ind[aa+1]
+000374a0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000374b0: 2020 2020 2020 2073 6361 3120 3d20 280a         sca1 = (.
+000374c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000374d0: 2020 2020 2020 2020 2861 705f 785b 6c6c          (ap_x[ll
+000374e0: 5d20 2d20 7074 735f 785b 7070 5d29 202a  ] - pts_x[pp]) *
+000374f0: 2064 6574 5f6e 6f72 6d5f 785b 6464 5d0a   det_norm_x[dd].
+00037500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037510: 2020 2020 2020 2020 2b20 2861 705f 795b          + (ap_y[
+00037520: 6c6c 5d20 2d20 7074 735f 795b 7070 5d29  ll] - pts_y[pp])
+00037530: 202a 2064 6574 5f6e 6f72 6d5f 795b 6464   * det_norm_y[dd
+00037540: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00037550: 2020 2020 2020 2020 2020 2b20 2861 705f            + (ap_
+00037560: 7a5b 6c6c 5d20 2d20 7074 735f 7a5b 7070  z[ll] - pts_z[pp
+00037570: 5d29 202a 2064 6574 5f6e 6f72 6d5f 7a5b  ]) * det_norm_z[
+00037580: 6464 5d0a 2020 2020 2020 2020 2020 2020  dd].            
+00037590: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+000375a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000375b0: 6620 7363 6131 203e 3d20 303a 0a20 2020  f sca1 >= 0:.   
+000375c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000375d0: 2020 2020 2069 736f 6b20 3d20 4661 6c73       isok = Fals
+000375e0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+000375f0: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
+00037600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00037610: 2020 2020 2023 2070 726f 6a65 6374 2069       # project i
+00037620: 6e20 3264 0a20 2020 2020 2020 2020 2020  n 2d.           
+00037630: 2020 2020 2020 2020 206b 203d 202d 2073           k = - s
+00037640: 6361 3020 2f20 7363 6131 0a20 2020 2020  ca0 / sca1.     
+00037650: 2020 2020 2020 2020 2020 2020 2020 2050                 P
+00037660: 5f78 203d 2070 7473 5f78 5b70 705d 202b  _x = pts_x[pp] +
+00037670: 206b 202a 2028 6170 5f78 5b6c 6c5d 202d   k * (ap_x[ll] -
+00037680: 2070 7473 5f78 5b70 705d 290a 2020 2020   pts_x[pp]).    
+00037690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000376a0: 505f 7920 3d20 7074 735f 795b 7070 5d20  P_y = pts_y[pp] 
+000376b0: 2b20 6b20 2a20 2861 705f 795b 6c6c 5d20  + k * (ap_y[ll] 
+000376c0: 2d20 7074 735f 795b 7070 5d29 0a20 2020  - pts_y[pp]).   
+000376d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000376e0: 2050 5f7a 203d 2070 7473 5f7a 5b70 705d   P_z = pts_z[pp]
+000376f0: 202b 206b 202a 2028 6170 5f7a 5b6c 6c5d   + k * (ap_z[ll]
+00037700: 202d 2070 7473 5f7a 5b70 705d 290a 0a20   - pts_z[pp]).. 
+00037710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037720: 2020 2023 2070 726f 6a65 6374 2069 6e20     # project in 
+00037730: 3264 0a20 2020 2020 2020 2020 2020 2020  2d.             
+00037740: 2020 2020 2020 2061 705f 7830 5b6c 6c5d         ap_x0[ll]
+00037750: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+00037760: 2020 2020 2020 2020 2020 2020 2028 505f               (P_
+00037770: 7820 2d20 6465 745f 6365 6e74 735f 785b  x - det_cents_x[
+00037780: 6464 5d29 202a 2064 6574 5f65 305f 785b  dd]) * det_e0_x[
+00037790: 6464 5d0a 2020 2020 2020 2020 2020 2020  dd].            
+000377a0: 2020 2020 2020 2020 2020 2020 2b20 2850              + (P
+000377b0: 5f79 202d 2064 6574 5f63 656e 7473 5f79  _y - det_cents_y
+000377c0: 5b64 645d 2920 2a20 6465 745f 6530 5f79  [dd]) * det_e0_y
+000377d0: 5b64 645d 0a20 2020 2020 2020 2020 2020  [dd].           
+000377e0: 2020 2020 2020 2020 2020 2020 202b 2028               + (
+000377f0: 505f 7a20 2d20 6465 745f 6365 6e74 735f  P_z - det_cents_
+00037800: 7a5b 6464 5d29 202a 2064 6574 5f65 305f  z[dd]) * det_e0_
+00037810: 7a5b 6464 5d0a 2020 2020 2020 2020 2020  z[dd].          
+00037820: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00037830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037840: 6170 5f78 315b 6c6c 5d20 3d20 280a 2020  ap_x1[ll] = (.  
+00037850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037860: 2020 2020 2020 2850 5f78 202d 2064 6574        (P_x - det
+00037870: 5f63 656e 7473 5f78 5b64 645d 2920 2a20  _cents_x[dd]) * 
+00037880: 6465 745f 6531 5f78 5b64 645d 0a20 2020  det_e1_x[dd].   
+00037890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000378a0: 2020 2020 202b 2028 505f 7920 2d20 6465       + (P_y - de
+000378b0: 745f 6365 6e74 735f 795b 6464 5d29 202a  t_cents_y[dd]) *
+000378c0: 2064 6574 5f65 315f 795b 6464 5d0a 2020   det_e1_y[dd].  
 000378d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000378e0: 2020 6272 6561 6b0a 0a20 2020 2020 2020    break..       
-000378f0: 2020 2020 2023 2067 6f20 746f 206e 6578       # go to nex
-00037900: 7420 706f 696e 740a 2020 2020 2020 2020  t point.        
-00037910: 2020 2020 6966 206e 6f74 2069 736f 6b3a      if not isok:
-00037920: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00037930: 2063 6f6e 7469 6e75 650a 0a20 2020 2020   continue..     
-00037940: 2020 2020 2020 2023 202d 2d2d 2d2d 2d2d         # -------
-00037950: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00037960: 2d2d 2d2d 2d0a 2020 2020 2020 2020 2020  -----.          
-00037970: 2020 2320 636f 6d70 7574 6520 706f 6c79    # compute poly
-00037980: 676f 6e20 696e 7465 7273 6563 7469 6f6e  gon intersection
-00037990: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-000379a0: 636f 6d70 7574 6520 696e 7465 7273 6563  compute intersec
-000379b0: 7469 6f6e 0a20 2020 2020 2020 2020 2020  tion.           
-000379c0: 2070 5f61 203d 2070 6c67 2e50 6f6c 7967   p_a = plg.Polyg
-000379d0: 6f6e 286e 702e 6172 7261 7928 5b64 6574  on(np.array([det
-000379e0: 5f6f 7574 6c69 6e65 5f78 302c 2064 6574  _outline_x0, det
-000379f0: 5f6f 7574 6c69 6e65 5f78 315d 292e 5429  _outline_x1]).T)
-00037a00: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00037a10: 2061 6120 696e 2072 616e 6765 286e 6129   aa in range(na)
-00037a20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00037a30: 2020 705f 6120 3d20 705f 6120 2620 706c    p_a = p_a & pl
-00037a40: 672e 506f 6c79 676f 6e28 6e70 2e61 7272  g.Polygon(np.arr
-00037a50: 6179 285b 0a20 2020 2020 2020 2020 2020  ay([.           
-00037a60: 2020 2020 2020 2020 2061 705f 7830 5b61           ap_x0[a
-00037a70: 705f 696e 645b 6161 5d3a 6170 5f69 6e64  p_ind[aa]:ap_ind
-00037a80: 5b61 612b 315d 5d2c 0a20 2020 2020 2020  [aa+1]],.       
-00037a90: 2020 2020 2020 2020 2020 2020 2061 705f               ap_
-00037aa0: 7831 5b61 705f 696e 645b 6161 5d3a 6170  x1[ap_ind[aa]:ap
-00037ab0: 5f69 6e64 5b61 612b 315d 5d2c 0a20 2020  _ind[aa+1]],.   
-00037ac0: 2020 2020 2020 2020 2020 2020 205d 292e               ]).
-00037ad0: 5429 0a0a 2020 2020 2020 2020 2020 2020  T)..            
-00037ae0: 2020 2020 2320 7374 6f70 2069 6620 6e6f      # stop if no
-00037af0: 2069 6e74 6572 7365 6374 696f 6e0a 2020   intersection.  
-00037b00: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00037b10: 2070 5f61 2e6e 506f 696e 7473 2829 203c   p_a.nPoints() <
-00037b20: 2033 3a0a 2020 2020 2020 2020 2020 2020   3:.            
-00037b30: 2020 2020 2020 2020 6973 6f6b 203d 2046          isok = F
-00037b40: 616c 7365 0a20 2020 2020 2020 2020 2020  alse.           
-00037b50: 2020 2020 2020 2020 2062 7265 616b 0a0a           break..
-00037b60: 2020 2020 2020 2020 2020 2020 2320 7374              # st
-00037b70: 6f70 2069 6620 6e6f 2069 6e74 6572 7365  op if no interse
-00037b80: 6374 696f 6e0a 2020 2020 2020 2020 2020  ction.          
-00037b90: 2020 6966 206e 6f74 2069 736f 6b3a 0a20    if not isok:. 
-00037ba0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00037bb0: 6f6e 7469 6e75 650a 0a20 2020 2020 2020  ontinue..       
-00037bc0: 2020 2020 2023 202d 2d2d 2d2d 2d2d 2d2d       # ---------
-00037bd0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020  ----------.     
-00037be0: 2020 2020 2020 2023 2047 6574 2075 6e69         # Get uni
-00037bf0: 7420 7665 6374 6f72 730a 0a20 2020 2020  t vectors..     
-00037c00: 2020 2020 2020 2063 7830 2c20 6378 3120         cx0, cx1 
-00037c10: 3d20 705f 612e 6365 6e74 6572 2830 290a  = p_a.center(0).
-00037c20: 2020 2020 2020 2020 2020 2020 7578 203d              ux =
-00037c30: 2064 6574 5f63 656e 7473 5f78 5b64 645d   det_cents_x[dd]
-00037c40: 202b 2063 7830 2a64 6574 5f65 305f 785b   + cx0*det_e0_x[
-00037c50: 6464 5d20 2b20 6378 312a 6465 745f 6531  dd] + cx1*det_e1
-00037c60: 5f78 5b64 645d 202d 2070 7473 5f78 5b70  _x[dd] - pts_x[p
-00037c70: 705d 0a20 2020 2020 2020 2020 2020 2075  p].            u
-00037c80: 7920 3d20 6465 745f 6365 6e74 735f 795b  y = det_cents_y[
-00037c90: 6464 5d20 2b20 6378 302a 6465 745f 6530  dd] + cx0*det_e0
-00037ca0: 5f79 5b64 645d 202b 2063 7831 2a64 6574  _y[dd] + cx1*det
-00037cb0: 5f65 315f 795b 6464 5d20 2d20 7074 735f  _e1_y[dd] - pts_
-00037cc0: 795b 7070 5d0a 2020 2020 2020 2020 2020  y[pp].          
-00037cd0: 2020 757a 203d 2064 6574 5f63 656e 7473    uz = det_cents
-00037ce0: 5f7a 5b64 645d 202b 2063 7830 2a64 6574  _z[dd] + cx0*det
-00037cf0: 5f65 305f 7a5b 6464 5d20 2b20 6378 312a  _e0_z[dd] + cx1*
-00037d00: 6465 745f 6531 5f7a 5b64 645d 202d 2070  det_e1_z[dd] - p
-00037d10: 7473 5f7a 5b70 705d 0a20 2020 2020 2020  ts_z[pp].       
-00037d20: 2020 2020 2069 6e76 5f6e 6f72 6d20 3d20       inv_norm = 
-00037d30: 312e 2f63 5f73 7172 7428 7578 2a2a 3220  1./c_sqrt(ux**2 
-00037d40: 2b20 7579 2a2a 3220 2b20 757a 2a2a 3229  + uy**2 + uz**2)
-00037d50: 0a20 2020 2020 2020 2020 2020 2075 7665  .            uve
-00037d60: 6374 5f78 5b64 642c 2070 705d 203d 2075  ct_x[dd, pp] = u
-00037d70: 782a 696e 765f 6e6f 726d 0a20 2020 2020  x*inv_norm.     
-00037d80: 2020 2020 2020 2075 7665 6374 5f79 5b64         uvect_y[d
-00037d90: 642c 2070 705d 203d 2075 792a 696e 765f  d, pp] = uy*inv_
-00037da0: 6e6f 726d 0a20 2020 2020 2020 2020 2020  norm.           
-00037db0: 2075 7665 6374 5f7a 5b64 642c 2070 705d   uvect_z[dd, pp]
-00037dc0: 203d 2075 7a2a 696e 765f 6e6f 726d 0a0a   = uz*inv_norm..
-00037dd0: 2020 2020 2020 2020 2020 2020 2320 2d2d              # --
-00037de0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00037df0: 2d0a 2020 2020 2020 2020 2020 2020 2320  -.            # 
-00037e00: 7265 6275 696c 6420 3364 2070 6f6c 7967  rebuild 3d polyg
-00037e10: 6f6e 0a0a 2020 2020 2020 2020 2020 2020  on..            
-00037e20: 2320 6368 6563 6b20 6363 770a 2020 2020  # check ccw.    
-00037e30: 2020 2020 2020 2020 705f 615f 7830 203d          p_a_x0 =
-00037e40: 206e 702e 6173 636f 6e74 6967 756f 7573   np.ascontiguous
-00037e50: 6172 7261 7928 6e70 2e61 7272 6179 2870  array(np.array(p
-00037e60: 5f61 2e63 6f6e 746f 7572 2830 2929 5b3a  _a.contour(0))[:
-00037e70: 2c20 305d 290a 2020 2020 2020 2020 2020  , 0]).          
-00037e80: 2020 705f 615f 7831 203d 206e 702e 6173    p_a_x1 = np.as
-00037e90: 636f 6e74 6967 756f 7573 6172 7261 7928  contiguousarray(
-00037ea0: 6e70 2e61 7272 6179 2870 5f61 2e63 6f6e  np.array(p_a.con
-00037eb0: 746f 7572 2830 2929 5b3a 2c20 315d 290a  tour(0))[:, 1]).
-00037ec0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00037ed0: 6f74 205f 6368 6563 6b5f 706f 6c79 676f  ot _check_polygo
-00037ee0: 6e5f 3264 5f63 6f75 6e74 6572 5f63 6c6f  n_2d_counter_clo
-00037ef0: 636b 7769 7365 2870 5f61 5f78 302c 2070  ckwise(p_a_x0, p
-00037f00: 5f61 5f78 3129 3a0a 2020 2020 2020 2020  _a_x1):.        
-00037f10: 2020 2020 2020 2020 705f 615f 7830 203d          p_a_x0 =
-00037f20: 206e 702e 6173 636f 6e74 6967 756f 7573   np.ascontiguous
-00037f30: 6172 7261 7928 705f 615f 7830 5b3a 3a2d  array(p_a_x0[::-
-00037f40: 315d 290a 2020 2020 2020 2020 2020 2020  1]).            
-00037f50: 2020 2020 705f 615f 7831 203d 206e 702e      p_a_x1 = np.
-00037f60: 6173 636f 6e74 6967 756f 7573 6172 7261  ascontiguousarra
-00037f70: 7928 705f 615f 7831 5b3a 3a2d 315d 290a  y(p_a_x1[::-1]).
-00037f80: 0a20 2020 2020 2020 2020 2020 2023 2074  .            # t
-00037f90: 7269 616e 6775 6c61 7465 2062 7920 6561  riangulate by ea
-00037fa0: 722d 636c 6970 7069 6e67 2028 290a 2020  r-clipping ().  
-00037fb0: 2020 2020 2020 2020 2020 7472 6920 3d20            tri = 
-00037fc0: 7472 6961 6e67 756c 6174 655f 6279 5f65  triangulate_by_e
-00037fd0: 6172 636c 6970 7069 6e67 5f32 6428 0a20  arclipping_2d(. 
-00037fe0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00037ff0: 702e 6173 636f 6e74 6967 756f 7573 6172  p.ascontiguousar
-00038000: 7261 7928 5b70 5f61 5f78 302c 2070 5f61  ray([p_a_x0, p_a
-00038010: 5f78 315d 290a 2020 2020 2020 2020 2020  _x1]).          
-00038020: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
-00038030: 2023 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   # -------------
-00038040: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2020  ------.         
-00038050: 2020 2023 2063 6f6d 7075 7465 2073 6f6c     # compute sol
-00038060: 6964 2061 6e67 6c65 0a0a 2020 2020 2020  id angle..      
-00038070: 2020 2020 2020 2320 6c6f 6f70 206f 6e20        # loop on 
-00038080: 7472 6961 6e67 6c65 730a 2020 2020 2020  triangles.      
-00038090: 2020 2020 2020 666f 7220 7474 2069 6e20        for tt in 
-000380a0: 7261 6e67 6528 7472 692e 7368 6170 655b  range(tri.shape[
-000380b0: 305d 293a 0a0a 2020 2020 2020 2020 2020  0]):..          
-000380c0: 2020 2020 2020 2320 6765 7420 7472 6961        # get tria
-000380d0: 6e67 6c65 0a20 2020 2020 2020 2020 2020  ngle.           
-000380e0: 2020 2020 2074 7269 5f78 203d 2028 0a20       tri_x = (. 
-000380f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038100: 2020 2064 6574 5f63 656e 7473 5f78 5b64     det_cents_x[d
-00038110: 645d 0a20 2020 2020 2020 2020 2020 2020  d].             
-00038120: 2020 2020 2020 202b 2070 5f61 5f78 305b         + p_a_x0[
-00038130: 7472 695b 7474 2c20 3a5d 5d20 2a20 6465  tri[tt, :]] * de
-00038140: 745f 6530 5f78 5b64 645d 0a20 2020 2020  t_e0_x[dd].     
-00038150: 2020 2020 2020 2020 2020 2020 2020 202b                 +
-00038160: 2070 5f61 5f78 315b 7472 695b 7474 2c20   p_a_x1[tri[tt, 
-00038170: 3a5d 5d20 2a20 6465 745f 6531 5f78 5b64  :]] * det_e1_x[d
-00038180: 645d 0a20 2020 2020 2020 2020 2020 2020  d].             
-00038190: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-000381a0: 2020 2020 2074 7269 5f79 203d 2028 0a20       tri_y = (. 
-000381b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000381c0: 2020 2064 6574 5f63 656e 7473 5f79 5b64     det_cents_y[d
-000381d0: 645d 0a20 2020 2020 2020 2020 2020 2020  d].             
-000381e0: 2020 2020 2020 202b 2070 5f61 5f78 305b         + p_a_x0[
-000381f0: 7472 695b 7474 2c20 3a5d 5d20 2a20 6465  tri[tt, :]] * de
-00038200: 745f 6530 5f79 5b64 645d 0a20 2020 2020  t_e0_y[dd].     
-00038210: 2020 2020 2020 2020 2020 2020 2020 202b                 +
-00038220: 2070 5f61 5f78 315b 7472 695b 7474 2c20   p_a_x1[tri[tt, 
-00038230: 3a5d 5d20 2a20 6465 745f 6531 5f79 5b64  :]] * det_e1_y[d
-00038240: 645d 0a20 2020 2020 2020 2020 2020 2020  d].             
-00038250: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00038260: 2020 2020 2074 7269 5f7a 203d 2028 0a20       tri_z = (. 
-00038270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038280: 2020 2064 6574 5f63 656e 7473 5f7a 5b64     det_cents_z[d
-00038290: 645d 0a20 2020 2020 2020 2020 2020 2020  d].             
-000382a0: 2020 2020 2020 202b 2070 5f61 5f78 305b         + p_a_x0[
-000382b0: 7472 695b 7474 2c20 3a5d 5d20 2a20 6465  tri[tt, :]] * de
-000382c0: 745f 6530 5f7a 5b64 645d 0a20 2020 2020  t_e0_z[dd].     
-000382d0: 2020 2020 2020 2020 2020 2020 2020 202b                 +
-000382e0: 2070 5f61 5f78 315b 7472 695b 7474 2c20   p_a_x1[tri[tt, 
-000382f0: 3a5d 5d20 2a20 6465 745f 6531 5f7a 5b64  :]] * det_e1_z[d
-00038300: 645d 0a20 2020 2020 2020 2020 2020 2020  d].             
-00038310: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
-00038320: 2020 2020 2020 2320 636f 6d70 7574 6174        # computat
-00038330: 696f 6e20 323a 2073 6f6c 6964 2061 6e67  ion 2: solid ang
-00038340: 6c65 206f 6620 7472 6961 6e67 6c65 2066  le of triangle f
-00038350: 726f 6d20 7074 730a 2020 2020 2020 2020  rom pts.        
-00038360: 2020 2020 2020 2020 736f 6c69 645f 616e          solid_an
-00038370: 676c 655b 6464 2c20 7070 5d20 2b3d 205f  gle[dd, pp] += _
-00038380: 7374 2e63 6f6d 705f 7361 5f74 7269 280a  st.comp_sa_tri(.
-00038390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000383a0: 2020 2020 7472 695f 785b 305d 2c0a 2020      tri_x[0],.  
-000383b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000383c0: 2020 7472 695f 795b 305d 2c0a 2020 2020    tri_y[0],.    
-000383d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000383e0: 7472 695f 7a5b 305d 2c0a 2020 2020 2020  tri_z[0],.      
-000383f0: 2020 2020 2020 2020 2020 2020 2020 7472                tr
-00038400: 695f 785b 315d 2c0a 2020 2020 2020 2020  i_x[1],.        
-00038410: 2020 2020 2020 2020 2020 2020 7472 695f              tri_
-00038420: 795b 315d 2c0a 2020 2020 2020 2020 2020  y[1],.          
-00038430: 2020 2020 2020 2020 2020 7472 695f 7a5b            tri_z[
-00038440: 315d 2c0a 2020 2020 2020 2020 2020 2020  1],.            
-00038450: 2020 2020 2020 2020 7472 695f 785b 325d          tri_x[2]
-00038460: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00038470: 2020 2020 2020 7472 695f 795b 325d 2c0a        tri_y[2],.
+000378e0: 2020 2020 2020 2b20 2850 5f7a 202d 2064        + (P_z - d
+000378f0: 6574 5f63 656e 7473 5f7a 5b64 645d 2920  et_cents_z[dd]) 
+00037900: 2a20 6465 745f 6531 5f7a 5b64 645d 0a20  * det_e1_z[dd]. 
+00037910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037920: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
+00037930: 2020 2020 2020 6966 206e 6f74 2069 736f        if not iso
+00037940: 6b3a 0a20 2020 2020 2020 2020 2020 2020  k:.             
+00037950: 2020 2020 2020 2062 7265 616b 0a0a 2020         break..  
+00037960: 2020 2020 2020 2020 2020 2320 676f 2074            # go t
+00037970: 6f20 6e65 7874 2070 6f69 6e74 0a20 2020  o next point.   
+00037980: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+00037990: 6973 6f6b 3a0a 2020 2020 2020 2020 2020  isok:.          
+000379a0: 2020 2020 2020 636f 6e74 696e 7565 0a0a        continue..
+000379b0: 2020 2020 2020 2020 2020 2020 2320 2d2d              # --
+000379c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000379d0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020  ----------.     
+000379e0: 2020 2020 2020 2023 2063 6f6d 7075 7465         # compute
+000379f0: 2070 6f6c 7967 6f6e 2069 6e74 6572 7365   polygon interse
+00037a00: 6374 696f 6e0a 0a20 2020 2020 2020 2020  ction..         
+00037a10: 2020 2023 2063 6f6d 7075 7465 2069 6e74     # compute int
+00037a20: 6572 7365 6374 696f 6e0a 2020 2020 2020  ersection.      
+00037a30: 2020 2020 2020 705f 6120 3d20 706c 672e        p_a = plg.
+00037a40: 506f 6c79 676f 6e28 6e70 2e61 7272 6179  Polygon(np.array
+00037a50: 285b 6465 745f 6f75 746c 696e 655f 7830  ([det_outline_x0
+00037a60: 2c20 6465 745f 6f75 746c 696e 655f 7831  , det_outline_x1
+00037a70: 5d29 2e54 290a 2020 2020 2020 2020 2020  ]).T).          
+00037a80: 2020 666f 7220 6161 2069 6e20 7261 6e67    for aa in rang
+00037a90: 6528 6e61 293a 0a20 2020 2020 2020 2020  e(na):.         
+00037aa0: 2020 2020 2020 2070 5f61 203d 2070 5f61         p_a = p_a
+00037ab0: 2026 2070 6c67 2e50 6f6c 7967 6f6e 286e   & plg.Polygon(n
+00037ac0: 702e 6172 7261 7928 5b0a 2020 2020 2020  p.array([.      
+00037ad0: 2020 2020 2020 2020 2020 2020 2020 6170                ap
+00037ae0: 5f78 305b 6170 5f69 6e64 5b61 615d 3a61  _x0[ap_ind[aa]:a
+00037af0: 705f 696e 645b 6161 2b31 5d5d 2c0a 2020  p_ind[aa+1]],.  
+00037b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037b10: 2020 6170 5f78 315b 6170 5f69 6e64 5b61    ap_x1[ap_ind[a
+00037b20: 615d 3a61 705f 696e 645b 6161 2b31 5d5d  a]:ap_ind[aa+1]]
+00037b30: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00037b40: 2020 5d29 2e54 290a 0a20 2020 2020 2020    ]).T)..       
+00037b50: 2020 2020 2020 2020 2023 2073 746f 7020           # stop 
+00037b60: 6966 206e 6f20 696e 7465 7273 6563 7469  if no intersecti
+00037b70: 6f6e 0a20 2020 2020 2020 2020 2020 2020  on.             
+00037b80: 2020 2069 6620 705f 612e 6e50 6f69 6e74     if p_a.nPoint
+00037b90: 7328 2920 3c20 333a 0a20 2020 2020 2020  s() < 3:.       
+00037ba0: 2020 2020 2020 2020 2020 2020 2069 736f               iso
+00037bb0: 6b20 3d20 4661 6c73 650a 2020 2020 2020  k = False.      
+00037bc0: 2020 2020 2020 2020 2020 2020 2020 6272                br
+00037bd0: 6561 6b0a 0a20 2020 2020 2020 2020 2020  eak..           
+00037be0: 2023 2073 746f 7020 6966 206e 6f20 696e   # stop if no in
+00037bf0: 7465 7273 6563 7469 6f6e 0a20 2020 2020  tersection.     
+00037c00: 2020 2020 2020 2069 6620 6e6f 7420 6973         if not is
+00037c10: 6f6b 3a0a 2020 2020 2020 2020 2020 2020  ok:.            
+00037c20: 2020 2020 636f 6e74 696e 7565 0a0a 2020      continue..  
+00037c30: 2020 2020 2020 2020 2020 2320 2d2d 2d2d            # ----
+00037c40: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a  ---------------.
+00037c50: 2020 2020 2020 2020 2020 2020 2320 4765              # Ge
+00037c60: 7420 756e 6974 2076 6563 746f 7273 0a0a  t unit vectors..
+00037c70: 2020 2020 2020 2020 2020 2020 6378 302c              cx0,
+00037c80: 2063 7831 203d 2070 5f61 2e63 656e 7465   cx1 = p_a.cente
+00037c90: 7228 3029 0a20 2020 2020 2020 2020 2020  r(0).           
+00037ca0: 2075 7820 3d20 6465 745f 6365 6e74 735f   ux = det_cents_
+00037cb0: 785b 6464 5d20 2b20 6378 302a 6465 745f  x[dd] + cx0*det_
+00037cc0: 6530 5f78 5b64 645d 202b 2063 7831 2a64  e0_x[dd] + cx1*d
+00037cd0: 6574 5f65 315f 785b 6464 5d20 2d20 7074  et_e1_x[dd] - pt
+00037ce0: 735f 785b 7070 5d0a 2020 2020 2020 2020  s_x[pp].        
+00037cf0: 2020 2020 7579 203d 2064 6574 5f63 656e      uy = det_cen
+00037d00: 7473 5f79 5b64 645d 202b 2063 7830 2a64  ts_y[dd] + cx0*d
+00037d10: 6574 5f65 305f 795b 6464 5d20 2b20 6378  et_e0_y[dd] + cx
+00037d20: 312a 6465 745f 6531 5f79 5b64 645d 202d  1*det_e1_y[dd] -
+00037d30: 2070 7473 5f79 5b70 705d 0a20 2020 2020   pts_y[pp].     
+00037d40: 2020 2020 2020 2075 7a20 3d20 6465 745f         uz = det_
+00037d50: 6365 6e74 735f 7a5b 6464 5d20 2b20 6378  cents_z[dd] + cx
+00037d60: 302a 6465 745f 6530 5f7a 5b64 645d 202b  0*det_e0_z[dd] +
+00037d70: 2063 7831 2a64 6574 5f65 315f 7a5b 6464   cx1*det_e1_z[dd
+00037d80: 5d20 2d20 7074 735f 7a5b 7070 5d0a 2020  ] - pts_z[pp].  
+00037d90: 2020 2020 2020 2020 2020 696e 765f 6e6f            inv_no
+00037da0: 726d 203d 2031 2e2f 635f 7371 7274 2875  rm = 1./c_sqrt(u
+00037db0: 782a 2a32 202b 2075 792a 2a32 202b 2075  x**2 + uy**2 + u
+00037dc0: 7a2a 2a32 290a 2020 2020 2020 2020 2020  z**2).          
+00037dd0: 2020 7576 6563 745f 785b 6464 2c20 7070    uvect_x[dd, pp
+00037de0: 5d20 3d20 7578 2a69 6e76 5f6e 6f72 6d0a  ] = ux*inv_norm.
+00037df0: 2020 2020 2020 2020 2020 2020 7576 6563              uvec
+00037e00: 745f 795b 6464 2c20 7070 5d20 3d20 7579  t_y[dd, pp] = uy
+00037e10: 2a69 6e76 5f6e 6f72 6d0a 2020 2020 2020  *inv_norm.      
+00037e20: 2020 2020 2020 7576 6563 745f 7a5b 6464        uvect_z[dd
+00037e30: 2c20 7070 5d20 3d20 757a 2a69 6e76 5f6e  , pp] = uz*inv_n
+00037e40: 6f72 6d0a 0a20 2020 2020 2020 2020 2020  orm..           
+00037e50: 2023 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   # -------------
+00037e60: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2020  ------.         
+00037e70: 2020 2023 2072 6562 7569 6c64 2033 6420     # rebuild 3d 
+00037e80: 706f 6c79 676f 6e0a 0a20 2020 2020 2020  polygon..       
+00037e90: 2020 2020 2023 2063 6865 636b 2063 6377       # check ccw
+00037ea0: 0a20 2020 2020 2020 2020 2020 2070 5f61  .            p_a
+00037eb0: 5f78 3020 3d20 6e70 2e61 7363 6f6e 7469  _x0 = np.asconti
+00037ec0: 6775 6f75 7361 7272 6179 286e 702e 6172  guousarray(np.ar
+00037ed0: 7261 7928 705f 612e 636f 6e74 6f75 7228  ray(p_a.contour(
+00037ee0: 3029 295b 3a2c 2030 5d29 0a20 2020 2020  0))[:, 0]).     
+00037ef0: 2020 2020 2020 2070 5f61 5f78 3120 3d20         p_a_x1 = 
+00037f00: 6e70 2e61 7363 6f6e 7469 6775 6f75 7361  np.ascontiguousa
+00037f10: 7272 6179 286e 702e 6172 7261 7928 705f  rray(np.array(p_
+00037f20: 612e 636f 6e74 6f75 7228 3029 295b 3a2c  a.contour(0))[:,
+00037f30: 2031 5d29 0a20 2020 2020 2020 2020 2020   1]).           
+00037f40: 2069 6620 6e6f 7420 5f63 6865 636b 5f70   if not _check_p
+00037f50: 6f6c 7967 6f6e 5f32 645f 636f 756e 7465  olygon_2d_counte
+00037f60: 725f 636c 6f63 6b77 6973 6528 705f 615f  r_clockwise(p_a_
+00037f70: 7830 2c20 705f 615f 7831 293a 0a20 2020  x0, p_a_x1):.   
+00037f80: 2020 2020 2020 2020 2020 2020 2070 5f61               p_a
+00037f90: 5f78 3020 3d20 6e70 2e61 7363 6f6e 7469  _x0 = np.asconti
+00037fa0: 6775 6f75 7361 7272 6179 2870 5f61 5f78  guousarray(p_a_x
+00037fb0: 305b 3a3a 2d31 5d29 0a20 2020 2020 2020  0[::-1]).       
+00037fc0: 2020 2020 2020 2020 2070 5f61 5f78 3120           p_a_x1 
+00037fd0: 3d20 6e70 2e61 7363 6f6e 7469 6775 6f75  = np.ascontiguou
+00037fe0: 7361 7272 6179 2870 5f61 5f78 315b 3a3a  sarray(p_a_x1[::
+00037ff0: 2d31 5d29 0a0a 2020 2020 2020 2020 2020  -1])..          
+00038000: 2020 2320 7472 6961 6e67 756c 6174 6520    # triangulate 
+00038010: 6279 2065 6172 2d63 6c69 7070 696e 6720  by ear-clipping 
+00038020: 2829 0a20 2020 2020 2020 2020 2020 2074  ().            t
+00038030: 7269 203d 2074 7269 616e 6775 6c61 7465  ri = triangulate
+00038040: 5f62 795f 6561 7263 6c69 7070 696e 675f  _by_earclipping_
+00038050: 3264 280a 2020 2020 2020 2020 2020 2020  2d(.            
+00038060: 2020 2020 6e70 2e61 7363 6f6e 7469 6775      np.ascontigu
+00038070: 6f75 7361 7272 6179 285b 705f 615f 7830  ousarray([p_a_x0
+00038080: 2c20 705f 615f 7831 5d29 0a20 2020 2020  , p_a_x1]).     
+00038090: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+000380a0: 2020 2020 2020 2320 2d2d 2d2d 2d2d 2d2d        # --------
+000380b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020  -----------.    
+000380c0: 2020 2020 2020 2020 2320 636f 6d70 7574          # comput
+000380d0: 6520 736f 6c69 6420 616e 676c 650a 0a20  e solid angle.. 
+000380e0: 2020 2020 2020 2020 2020 2023 206c 6f6f             # loo
+000380f0: 7020 6f6e 2074 7269 616e 676c 6573 0a20  p on triangles. 
+00038100: 2020 2020 2020 2020 2020 2066 6f72 2074             for t
+00038110: 7420 696e 2072 616e 6765 2874 7269 2e73  t in range(tri.s
+00038120: 6861 7065 5b30 5d29 3a0a 0a20 2020 2020  hape[0]):..     
+00038130: 2020 2020 2020 2020 2020 2023 2067 6574             # get
+00038140: 2074 7269 616e 676c 650a 2020 2020 2020   triangle.      
+00038150: 2020 2020 2020 2020 2020 7472 695f 7820            tri_x 
+00038160: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+00038170: 2020 2020 2020 2020 6465 745f 6365 6e74          det_cent
+00038180: 735f 785b 6464 5d0a 2020 2020 2020 2020  s_x[dd].        
+00038190: 2020 2020 2020 2020 2020 2020 2b20 705f              + p_
+000381a0: 615f 7830 5b74 7269 5b74 742c 203a 5d5d  a_x0[tri[tt, :]]
+000381b0: 202a 2064 6574 5f65 305f 785b 6464 5d0a   * det_e0_x[dd].
+000381c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000381d0: 2020 2020 2b20 705f 615f 7831 5b74 7269      + p_a_x1[tri
+000381e0: 5b74 742c 203a 5d5d 202a 2064 6574 5f65  [tt, :]] * det_e
+000381f0: 315f 785b 6464 5d0a 2020 2020 2020 2020  1_x[dd].        
+00038200: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00038210: 2020 2020 2020 2020 2020 7472 695f 7920            tri_y 
+00038220: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+00038230: 2020 2020 2020 2020 6465 745f 6365 6e74          det_cent
+00038240: 735f 795b 6464 5d0a 2020 2020 2020 2020  s_y[dd].        
+00038250: 2020 2020 2020 2020 2020 2020 2b20 705f              + p_
+00038260: 615f 7830 5b74 7269 5b74 742c 203a 5d5d  a_x0[tri[tt, :]]
+00038270: 202a 2064 6574 5f65 305f 795b 6464 5d0a   * det_e0_y[dd].
+00038280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038290: 2020 2020 2b20 705f 615f 7831 5b74 7269      + p_a_x1[tri
+000382a0: 5b74 742c 203a 5d5d 202a 2064 6574 5f65  [tt, :]] * det_e
+000382b0: 315f 795b 6464 5d0a 2020 2020 2020 2020  1_y[dd].        
+000382c0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000382d0: 2020 2020 2020 2020 2020 7472 695f 7a20            tri_z 
+000382e0: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+000382f0: 2020 2020 2020 2020 6465 745f 6365 6e74          det_cent
+00038300: 735f 7a5b 6464 5d0a 2020 2020 2020 2020  s_z[dd].        
+00038310: 2020 2020 2020 2020 2020 2020 2b20 705f              + p_
+00038320: 615f 7830 5b74 7269 5b74 742c 203a 5d5d  a_x0[tri[tt, :]]
+00038330: 202a 2064 6574 5f65 305f 7a5b 6464 5d0a   * det_e0_z[dd].
+00038340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038350: 2020 2020 2b20 705f 615f 7831 5b74 7269      + p_a_x1[tri
+00038360: 5b74 742c 203a 5d5d 202a 2064 6574 5f65  [tt, :]] * det_e
+00038370: 315f 7a5b 6464 5d0a 2020 2020 2020 2020  1_z[dd].        
+00038380: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00038390: 2020 2020 2020 2020 2020 2023 2063 6f6d             # com
+000383a0: 7075 7461 7469 6f6e 2032 3a20 736f 6c69  putation 2: soli
+000383b0: 6420 616e 676c 6520 6f66 2074 7269 616e  d angle of trian
+000383c0: 676c 6520 6672 6f6d 2070 7473 0a20 2020  gle from pts.   
+000383d0: 2020 2020 2020 2020 2020 2020 2073 6f6c               sol
+000383e0: 6964 5f61 6e67 6c65 5b64 642c 2070 705d  id_angle[dd, pp]
+000383f0: 202b 3d20 5f73 742e 636f 6d70 5f73 615f   += _st.comp_sa_
+00038400: 7472 6928 0a20 2020 2020 2020 2020 2020  tri(.           
+00038410: 2020 2020 2020 2020 2074 7269 5f78 5b30           tri_x[0
+00038420: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00038430: 2020 2020 2020 2074 7269 5f79 5b30 5d2c         tri_y[0],
+00038440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00038450: 2020 2020 2074 7269 5f7a 5b30 5d2c 0a20       tri_z[0],. 
+00038460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038470: 2020 2074 7269 5f78 5b31 5d2c 0a20 2020     tri_x[1],.   
 00038480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038490: 2020 2020 7472 695f 7a5b 325d 2c0a 2020      tri_z[2],.  
-000384a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000384b0: 2020 7074 735f 785b 7070 5d2c 0a20 2020    pts_x[pp],.   
-000384c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000384d0: 2070 7473 5f79 5b70 705d 2c0a 2020 2020   pts_y[pp],.    
-000384e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000384f0: 7074 735f 7a5b 7070 5d2c 0a20 2020 2020  pts_z[pp],.     
-00038500: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-00038510: 2020 2320 2d2d 2d2d 2d2d 2d0a 2020 2020    # -------.    
-00038520: 2320 5265 7475 726e 0a0a 0a20 2020 2072  # Return...    r
-00038530: 6574 7572 6e20 736f 6c69 645f 616e 676c  eturn solid_angl
-00038540: 652c 2075 7665 6374 5f78 2c20 7576 6563  e, uvect_x, uvec
-00038550: 745f 792c 2075 7665 6374 5f7a 0a0a 0a64  t_y, uvect_z...d
-00038560: 6566 2063 6f6d 7075 7465 5f73 6f6c 6964  ef compute_solid
-00038570: 5f61 6e67 6c65 5f61 7065 7274 7572 6573  _angle_apertures
-00038580: 5f76 6973 6962 696c 6974 7928 0a20 2020  _visibility(.   
-00038590: 2023 2070 7473 3a20 636f 6f72 6469 6e61   # pts: coordina
-000385a0: 7465 7320 6173 2074 6872 6565 2031 6420  tes as three 1d 
-000385b0: 6172 7261 7973 0a20 2020 2064 6f75 626c  arrays.    doubl
-000385c0: 655b 3a3a 315d 2070 7473 5f78 2c0a 2020  e[::1] pts_x,.  
-000385d0: 2020 646f 7562 6c65 5b3a 3a31 5d20 7074    double[::1] pt
-000385e0: 735f 792c 0a20 2020 2064 6f75 626c 655b  s_y,.    double[
-000385f0: 3a3a 315d 2070 7473 5f7a 2c0a 2020 2020  ::1] pts_z,.    
-00038600: 2320 6465 7465 6374 6f72 733a 2070 6f6c  # detectors: pol
-00038610: 7967 6f6e 2063 6f6f 7264 696e 6174 6573  ygon coordinates
-00038620: 2069 6e20 3264 2028 636f 6d6d 6f6e 2074   in 2d (common t
-00038630: 6f20 616c 6c20 6465 7465 6374 6f72 7329  o all detectors)
-00038640: 0a20 2020 2064 6f75 626c 655b 3a3a 315d  .    double[::1]
-00038650: 2064 6574 5f6f 7574 6c69 6e65 5f78 302c   det_outline_x0,
-00038660: 0a20 2020 2064 6f75 626c 655b 3a3a 315d  .    double[::1]
-00038670: 2064 6574 5f6f 7574 6c69 6e65 5f78 312c   det_outline_x1,
-00038680: 0a20 2020 2023 2064 6574 6563 746f 7273  .    # detectors
-00038690: 3a20 6365 6e74 6572 7320 636f 6f72 6469  : centers coordi
-000386a0: 6e61 7465 7320 6173 2074 6872 6565 2031  nates as three 1
-000386b0: 6420 6172 7261 7973 0a20 2020 2064 6f75  d arrays.    dou
-000386c0: 626c 655b 3a3a 315d 2064 6574 5f63 656e  ble[::1] det_cen
-000386d0: 7473 5f78 2c0a 2020 2020 646f 7562 6c65  ts_x,.    double
-000386e0: 5b3a 3a31 5d20 6465 745f 6365 6e74 735f  [::1] det_cents_
-000386f0: 792c 0a20 2020 2064 6f75 626c 655b 3a3a  y,.    double[::
-00038700: 315d 2064 6574 5f63 656e 7473 5f7a 2c0a  1] det_cents_z,.
-00038710: 2020 2020 2320 6465 7465 6374 6f72 733a      # detectors:
-00038720: 206e 6f72 6d61 6c20 756e 6974 2076 6563   normal unit vec
-00038730: 746f 7273 2061 7320 7468 7265 6520 3164  tors as three 1d
-00038740: 2061 7272 6179 7320 286e 6420 3d20 6c65   arrays (nd = le
-00038750: 6e28 6465 745f 6e6f 726d 5f78 2929 0a20  n(det_norm_x)). 
-00038760: 2020 2064 6f75 626c 655b 3a3a 315d 2064     double[::1] d
-00038770: 6574 5f6e 6f72 6d5f 782c 0a20 2020 2064  et_norm_x,.    d
-00038780: 6f75 626c 655b 3a3a 315d 2064 6574 5f6e  ouble[::1] det_n
-00038790: 6f72 6d5f 792c 0a20 2020 2064 6f75 626c  orm_y,.    doubl
-000387a0: 655b 3a3a 315d 2064 6574 5f6e 6f72 6d5f  e[::1] det_norm_
-000387b0: 7a2c 0a20 2020 206e 702e 6e64 6172 7261  z,.    np.ndarra
-000387c0: 795b 646f 7562 6c65 2c20 6e64 696d 3d31  y[double, ndim=1
-000387d0: 5d20 6465 745f 6530 5f78 2c0a 2020 2020  ] det_e0_x,.    
-000387e0: 6e70 2e6e 6461 7272 6179 5b64 6f75 626c  np.ndarray[doubl
-000387f0: 652c 206e 6469 6d3d 315d 2064 6574 5f65  e, ndim=1] det_e
-00038800: 305f 792c 0a20 2020 206e 702e 6e64 6172  0_y,.    np.ndar
-00038810: 7261 795b 646f 7562 6c65 2c20 6e64 696d  ray[double, ndim
-00038820: 3d31 5d20 6465 745f 6530 5f7a 2c0a 2020  =1] det_e0_z,.  
-00038830: 2020 6e70 2e6e 6461 7272 6179 5b64 6f75    np.ndarray[dou
-00038840: 626c 652c 206e 6469 6d3d 315d 2064 6574  ble, ndim=1] det
-00038850: 5f65 315f 782c 0a20 2020 206e 702e 6e64  _e1_x,.    np.nd
-00038860: 6172 7261 795b 646f 7562 6c65 2c20 6e64  array[double, nd
-00038870: 696d 3d31 5d20 6465 745f 6531 5f79 2c0a  im=1] det_e1_y,.
-00038880: 2020 2020 6e70 2e6e 6461 7272 6179 5b64      np.ndarray[d
-00038890: 6f75 626c 652c 206e 6469 6d3d 315d 2064  ouble, ndim=1] d
-000388a0: 6574 5f65 315f 7a2c 0a20 2020 2023 2061  et_e1_z,.    # a
-000388b0: 7065 7274 7572 6573 3a20 696e 6469 6365  pertures: indice
-000388c0: 7320 6f66 2066 6972 7374 2063 6f72 6e65  s of first corne
-000388d0: 7220 6f66 2065 6163 6820 6170 2070 6f6c  r of each ap pol
-000388e0: 7967 6f6e 3a20 6e61 203d 206c 656e 2861  ygon: na = len(a
-000388f0: 705f 696e 6429 0a20 2020 206c 6f6e 675b  p_ind).    long[
-00038900: 3a3a 315d 2061 705f 696e 642c 0a20 2020  ::1] ap_ind,.   
-00038910: 2023 2061 7065 7274 7572 6573 3a20 706f   # apertures: po
-00038920: 6c79 676f 6e20 636f 6f72 6469 6e61 7465  lygon coordinate
-00038930: 7320 6173 2074 6872 6565 2031 6420 6172  s as three 1d ar
-00038940: 7261 7973 0a20 2020 206e 702e 6e64 6172  rays.    np.ndar
-00038950: 7261 795b 646f 7562 6c65 2c20 6e64 696d  ray[double, ndim
-00038960: 3d31 5d20 6170 5f78 2c0a 2020 2020 6e70  =1] ap_x,.    np
-00038970: 2e6e 6461 7272 6179 5b64 6f75 626c 652c  .ndarray[double,
-00038980: 206e 6469 6d3d 315d 2061 705f 792c 0a20   ndim=1] ap_y,. 
-00038990: 2020 206e 702e 6e64 6172 7261 795b 646f     np.ndarray[do
-000389a0: 7562 6c65 2c20 6e64 696d 3d31 5d20 6170  uble, ndim=1] ap
-000389b0: 5f7a 2c0a 2020 2020 2320 6e6f 726d 616c  _z,.    # normal
-000389c0: 2075 6e69 7420 7665 6374 6f72 730a 2020   unit vectors.  
-000389d0: 2020 646f 7562 6c65 5b3a 3a31 5d20 6170    double[::1] ap
-000389e0: 5f6e 6f72 6d5f 782c 0a20 2020 2064 6f75  _norm_x,.    dou
-000389f0: 626c 655b 3a3a 315d 2061 705f 6e6f 726d  ble[::1] ap_norm
-00038a00: 5f79 2c0a 2020 2020 646f 7562 6c65 5b3a  _y,.    double[:
-00038a10: 3a31 5d20 6170 5f6e 6f72 6d5f 7a2c 0a20  :1] ap_norm_z,. 
-00038a20: 2020 2023 2076 6973 6962 696c 6974 7920     # visibility 
-00038a30: 7465 7374 696e 670a 2020 2020 7665 735f  testing.    ves_
-00038a40: 706f 6c79 3d4e 6f6e 652c 0a20 2020 2076  poly=None,.    v
-00038a50: 6573 5f6e 6f72 6d3d 4e6f 6e65 2c0a 2020  es_norm=None,.  
-00038a60: 2020 7665 735f 6c69 6d73 3d4e 6f6e 652c    ves_lims=None,
-00038a70: 0a20 2020 206c 7374 7275 6374 5f70 6f6c  .    lstruct_pol
-00038a80: 7978 3d4e 6f6e 652c 0a20 2020 206c 7374  yx=None,.    lst
-00038a90: 7275 6374 5f70 6f6c 7979 3d4e 6f6e 652c  ruct_polyy=None,
-00038aa0: 0a20 2020 206c 7374 7275 6374 5f6c 696d  .    lstruct_lim
-00038ab0: 733d 4e6f 6e65 2c0a 2020 2020 6c73 7472  s=None,.    lstr
-00038ac0: 7563 745f 6e6c 696d 3d4e 6f6e 652c 0a20  uct_nlim=None,. 
-00038ad0: 2020 206c 7374 7275 6374 5f6e 6f72 6d78     lstruct_normx
-00038ae0: 3d4e 6f6e 652c 0a20 2020 206c 7374 7275  =None,.    lstru
-00038af0: 6374 5f6e 6f72 6d79 3d4e 6f6e 652c 0a20  ct_normy=None,. 
-00038b00: 2020 206e 7374 7275 6374 5f74 6f74 3d4e     nstruct_tot=N
-00038b10: 6f6e 652c 0a20 2020 206e 7374 7275 6374  one,.    nstruct
-00038b20: 5f6c 696d 3d4e 6f6e 652c 0a20 2020 206c  _lim=None,.    l
-00038b30: 6e76 6572 743d 4e6f 6e65 2c0a 2020 2020  nvert=None,.    
-00038b40: 726d 696e 3d4e 6f6e 652c 0a20 2020 2023  rmin=None,.    #
-00038b50: 2070 6f73 7369 626c 6520 6578 7472 6120   possible extra 
-00038b60: 7061 7261 6d65 7465 7273 203f 0a20 2020  parameters ?.   
-00038b70: 2064 6f75 626c 6520 6d61 7267 696e 3d5f   double margin=_
-00038b80: 5653 4d41 4c4c 2c0a 2020 2020 696e 7420  VSMALL,.    int 
-00038b90: 6e75 6d5f 7468 7265 6164 733d 3130 2c0a  num_threads=10,.
-00038ba0: 293a 0a0a 2020 2020 2320 2d2d 2d2d 2d2d  ):..    # ------
-00038bb0: 2d2d 2d2d 2d0a 2020 2020 2320 4465 636c  -----.    # Decl
-00038bc0: 6172 6174 696f 6e0a 0a20 2020 2063 6465  aration..    cde
-00038bd0: 6620 696e 7420 6e70 7473 203d 2070 7473  f int npts = pts
-00038be0: 5f78 2e73 697a 650a 2020 2020 6364 6566  _x.size.    cdef
-00038bf0: 2069 6e74 206e 6420 3d20 6465 745f 6365   int nd = det_ce
-00038c00: 6e74 735f 782e 7369 7a65 0a20 2020 2063  nts_x.size.    c
-00038c10: 6465 6620 696e 7420 6e61 203d 2061 705f  def int na = ap_
-00038c20: 6e6f 726d 5f78 2e73 697a 650a 2020 2020  norm_x.size.    
-00038c30: 6364 6566 2069 6e74 2064 642c 2070 702c  cdef int dd, pp,
-00038c40: 2061 612c 2074 740a 2020 2020 6364 6566   aa, tt.    cdef
-00038c50: 2069 6e74 206e 7061 0a20 2020 2063 6465   int npa.    cde
-00038c60: 6620 666c 6f61 7420 7363 612c 2073 6361  f float sca, sca
-00038c70: 302c 2073 6361 310a 2020 2020 6364 6566  0, sca1.    cdef
-00038c80: 2066 6c6f 6174 206b 690a 2020 2020 6364   float ki.    cd
-00038c90: 6566 206e 702e 6e64 6172 7261 795b 646f  ef np.ndarray[do
-00038ca0: 7562 6c65 2c20 6e64 696d 3d31 5d20 6170  uble, ndim=1] ap
-00038cb0: 5f78 3020 3d20 6e70 2e63 6f70 7928 6170  _x0 = np.copy(ap
-00038cc0: 5f78 290a 2020 2020 6364 6566 206e 702e  _x).    cdef np.
-00038cd0: 6e64 6172 7261 795b 646f 7562 6c65 2c20  ndarray[double, 
-00038ce0: 6e64 696d 3d31 5d20 6170 5f78 3120 3d20  ndim=1] ap_x1 = 
-00038cf0: 6e70 2e63 6f70 7928 6170 5f78 290a 2020  np.copy(ap_x).  
-00038d00: 2020 6364 6566 206e 702e 6e64 6172 7261    cdef np.ndarra
-00038d10: 795b 646f 7562 6c65 2c20 6e64 696d 3d31  y[double, ndim=1
-00038d20: 5d20 705f 615f 7830 0a20 2020 2063 6465  ] p_a_x0.    cde
-00038d30: 6620 6e70 2e6e 6461 7272 6179 5b64 6f75  f np.ndarray[dou
-00038d40: 626c 652c 206e 6469 6d3d 315d 2070 5f61  ble, ndim=1] p_a
-00038d50: 5f78 310a 2020 2020 6364 6566 2066 6c6f  _x1.    cdef flo
-00038d60: 6174 2063 7830 2c20 6378 310a 2020 2020  at cx0, cx1.    
-00038d70: 6364 6566 2066 6c6f 6174 2075 782c 2075  cdef float ux, u
-00038d80: 792c 2075 7a2c 2069 6e76 5f6e 6f72 6d0a  y, uz, inv_norm.
-00038d90: 2020 2020 6364 6566 206e 702e 6e64 6172      cdef np.ndar
-00038da0: 7261 795b 6c6f 6e67 2c20 6e64 696d 3d32  ray[long, ndim=2
-00038db0: 5d20 7472 690a 2020 2020 6364 6566 206e  ] tri.    cdef n
-00038dc0: 702e 6e64 6172 7261 795b 646f 7562 6c65  p.ndarray[double
-00038dd0: 2c20 6e64 696d 3d31 5d20 7472 695f 780a  , ndim=1] tri_x.
-00038de0: 2020 2020 6364 6566 206e 702e 6e64 6172      cdef np.ndar
-00038df0: 7261 795b 646f 7562 6c65 2c20 6e64 696d  ray[double, ndim
-00038e00: 3d31 5d20 7472 695f 790a 2020 2020 6364  =1] tri_y.    cd
-00038e10: 6566 206e 702e 6e64 6172 7261 795b 646f  ef np.ndarray[do
-00038e20: 7562 6c65 2c20 6e64 696d 3d31 5d20 7472  uble, ndim=1] tr
-00038e30: 695f 7a0a 0a20 2020 2023 2069 6e69 7469  i_z..    # initi
-00038e40: 616c 697a 6520 736f 6c69 6420 616e 676c  alize solid angl
-00038e50: 6520 6172 7261 7920 7769 7468 207a 6572  e array with zer
-00038e60: 6f73 0a20 2020 2063 6465 6620 6e70 2e6e  os.    cdef np.n
-00038e70: 6461 7272 6179 5b64 6f75 626c 652c 206e  darray[double, n
-00038e80: 6469 6d3d 325d 2073 6f6c 6964 5f61 6e67  dim=2] solid_ang
-00038e90: 6c65 203d 206e 702e 7a65 726f 7328 286e  le = np.zeros((n
-00038ea0: 642c 206e 7074 7329 2c20 6474 7970 653d  d, npts), dtype=
-00038eb0: 666c 6f61 7429 0a0a 2020 2020 2320 2d2d  float)..    # --
-00038ec0: 2d2d 2d2d 2d0a 2020 2020 2320 436f 6d70  -----.    # Comp
-00038ed0: 7574 650a 0a20 2020 2066 6f72 2064 6420  ute..    for dd 
-00038ee0: 696e 2072 616e 6765 286e 6429 3a0a 0a20  in range(nd):.. 
-00038ef0: 2020 2020 2020 2023 206c 6f6f 7020 323a         # loop 2:
-00038f00: 206f 6e20 6e70 7473 2028 6f62 7365 7276   on npts (observ
-00038f10: 6174 696f 6e20 706f 696e 7473 290a 2020  ation points).  
-00038f20: 2020 2020 2020 666f 7220 7070 2069 6e20        for pp in 
-00038f30: 7261 6e67 6528 6e70 7473 293a 0a0a 2020  range(npts):..  
-00038f40: 2020 2020 2020 2020 2020 2320 7465 7374            # test
-00038f50: 2069 6620 6f6e 2067 6f6f 6420 7369 6465   if on good side
-00038f60: 206f 6620 6465 7465 6374 6f72 0a20 2020   of detector.   
-00038f70: 2020 2020 2020 2020 2073 6361 3020 3d20           sca0 = 
-00038f80: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00038f90: 2020 2870 7473 5f78 5b70 705d 202d 2064    (pts_x[pp] - d
-00038fa0: 6574 5f63 656e 7473 5f78 5b64 645d 2920  et_cents_x[dd]) 
-00038fb0: 2a20 6465 745f 6e6f 726d 5f78 5b64 645d  * det_norm_x[dd]
-00038fc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00038fd0: 202b 2028 7074 735f 795b 7070 5d20 2d20   + (pts_y[pp] - 
-00038fe0: 6465 745f 6365 6e74 735f 795b 6464 5d29  det_cents_y[dd])
-00038ff0: 202a 2064 6574 5f6e 6f72 6d5f 795b 6464   * det_norm_y[dd
-00039000: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00039010: 2020 2b20 2870 7473 5f7a 5b70 705d 202d    + (pts_z[pp] -
-00039020: 2064 6574 5f63 656e 7473 5f7a 5b64 645d   det_cents_z[dd]
-00039030: 2920 2a20 6465 745f 6e6f 726d 5f7a 5b64  ) * det_norm_z[d
-00039040: 645d 0a20 2020 2020 2020 2020 2020 2029  d].            )
-00039050: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-00039060: 2073 6361 3020 3c3d 2030 3a0a 2020 2020   sca0 <= 0:.    
-00039070: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-00039080: 696e 7565 0a0a 2020 2020 2020 2020 2020  inue..          
-00039090: 2020 2320 666c 6167 0a20 2020 2020 2020    # flag.       
-000390a0: 2020 2020 2069 736f 6b20 3d20 5472 7565       isok = True
-000390b0: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-000390c0: 6c6f 6f70 2033 3a20 6f6e 206e 6120 2861  loop 3: on na (a
-000390d0: 7065 7274 7572 6573 290a 2020 2020 2020  pertures).      
-000390e0: 2020 2020 2020 666f 7220 6161 2069 6e20        for aa in 
-000390f0: 7261 6e67 6528 6e61 293a 0a0a 2020 2020  range(na):..    
-00039100: 2020 2020 2020 2020 2020 2020 2320 7465              # te
-00039110: 7374 2069 6620 6f6e 2067 6f6f 6420 7369  st if on good si
-00039120: 6465 206f 6620 6170 6572 7475 7265 0a20  de of aperture. 
-00039130: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00039140: 6361 203d 2028 0a20 2020 2020 2020 2020  ca = (.         
-00039150: 2020 2020 2020 2020 2020 2028 7074 735f             (pts_
-00039160: 785b 7070 5d20 2d20 6170 5f78 5b61 705f  x[pp] - ap_x[ap_
-00039170: 696e 645b 6161 5d5d 2920 2a20 6170 5f6e  ind[aa]]) * ap_n
-00039180: 6f72 6d5f 785b 6161 5d0a 2020 2020 2020  orm_x[aa].      
-00039190: 2020 2020 2020 2020 2020 2020 2020 2b20                + 
-000391a0: 2870 7473 5f79 5b70 705d 202d 2061 705f  (pts_y[pp] - ap_
-000391b0: 795b 6170 5f69 6e64 5b61 615d 5d29 202a  y[ap_ind[aa]]) *
-000391c0: 2061 705f 6e6f 726d 5f79 5b61 615d 0a20   ap_norm_y[aa]. 
-000391d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000391e0: 2020 202b 2028 7074 735f 7a5b 7070 5d20     + (pts_z[pp] 
-000391f0: 2d20 6170 5f7a 5b61 705f 696e 645b 6161  - ap_z[ap_ind[aa
-00039200: 5d5d 2920 2a20 6170 5f6e 6f72 6d5f 7a5b  ]]) * ap_norm_z[
-00039210: 6161 5d0a 2020 2020 2020 2020 2020 2020  aa].            
-00039220: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
-00039230: 2020 2020 2020 2069 6620 7363 6120 3c3d         if sca <=
-00039240: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-00039250: 2020 2020 2020 2020 6973 6f6b 203d 2046          isok = F
-00039260: 616c 7365 0a20 2020 2020 2020 2020 2020  alse.           
-00039270: 2020 2020 2020 2020 2062 7265 616b 0a0a           break..
-00039280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039290: 2320 7465 7374 2069 6620 616c 6c20 6170  # test if all ap
-000392a0: 6572 7475 7265 2070 6f69 6e74 7320 6361  erture points ca
-000392b0: 6e20 6265 2070 726f 6a65 6374 6564 206f  n be projected o
-000392c0: 6e20 6465 7465 6374 6f72 2070 6c61 6e65  n detector plane
-000392d0: 2066 726f 6d20 7074 730a 2020 2020 2020   from pts.      
-000392e0: 2020 2020 2020 2020 2020 666f 7220 6c6c            for ll
-000392f0: 2069 6e20 7261 6e67 6528 6170 5f69 6e64   in range(ap_ind
-00039300: 5b61 615d 2c20 6170 5f69 6e64 5b61 612b  [aa], ap_ind[aa+
-00039310: 315d 293a 0a20 2020 2020 2020 2020 2020  1]):.           
-00039320: 2020 2020 2020 2020 2073 6361 3120 3d20           sca1 = 
-00039330: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00039340: 2020 2020 2020 2020 2020 2861 705f 785b            (ap_x[
-00039350: 6c6c 5d20 2d20 7074 735f 785b 7070 5d29  ll] - pts_x[pp])
-00039360: 202a 2064 6574 5f6e 6f72 6d5f 785b 6464   * det_norm_x[dd
-00039370: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00039380: 2020 2020 2020 2020 2020 2b20 2861 705f            + (ap_
-00039390: 795b 6c6c 5d20 2d20 7074 735f 795b 7070  y[ll] - pts_y[pp
-000393a0: 5d29 202a 2064 6574 5f6e 6f72 6d5f 795b  ]) * det_norm_y[
-000393b0: 6464 5d0a 2020 2020 2020 2020 2020 2020  dd].            
-000393c0: 2020 2020 2020 2020 2020 2020 2b20 2861              + (a
-000393d0: 705f 7a5b 6c6c 5d20 2d20 7074 735f 7a5b  p_z[ll] - pts_z[
-000393e0: 7070 5d29 202a 2064 6574 5f6e 6f72 6d5f  pp]) * det_norm_
-000393f0: 7a5b 6464 5d0a 2020 2020 2020 2020 2020  z[dd].          
-00039400: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-00039410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039420: 2069 6620 7363 6131 203e 3d20 303a 0a20   if sca1 >= 0:. 
+00038490: 2074 7269 5f79 5b31 5d2c 0a20 2020 2020   tri_y[1],.     
+000384a0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+000384b0: 7269 5f7a 5b31 5d2c 0a20 2020 2020 2020  ri_z[1],.       
+000384c0: 2020 2020 2020 2020 2020 2020 2074 7269               tri
+000384d0: 5f78 5b32 5d2c 0a20 2020 2020 2020 2020  _x[2],.         
+000384e0: 2020 2020 2020 2020 2020 2074 7269 5f79             tri_y
+000384f0: 5b32 5d2c 0a20 2020 2020 2020 2020 2020  [2],.           
+00038500: 2020 2020 2020 2020 2074 7269 5f7a 5b32           tri_z[2
+00038510: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00038520: 2020 2020 2020 2070 7473 5f78 5b70 705d         pts_x[pp]
+00038530: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00038540: 2020 2020 2020 7074 735f 795b 7070 5d2c        pts_y[pp],
+00038550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00038560: 2020 2020 2070 7473 5f7a 5b70 705d 2c0a       pts_z[pp],.
+00038570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038580: 290a 0a20 2020 2023 202d 2d2d 2d2d 2d2d  )..    # -------
+00038590: 0a20 2020 2023 2052 6574 7572 6e0a 0a0a  .    # Return...
+000385a0: 2020 2020 7265 7475 726e 2073 6f6c 6964      return solid
+000385b0: 5f61 6e67 6c65 2c20 7576 6563 745f 782c  _angle, uvect_x,
+000385c0: 2075 7665 6374 5f79 2c20 7576 6563 745f   uvect_y, uvect_
+000385d0: 7a0a 0a0a 6465 6620 636f 6d70 7574 655f  z...def compute_
+000385e0: 736f 6c69 645f 616e 676c 655f 6170 6572  solid_angle_aper
+000385f0: 7475 7265 735f 7669 7369 6269 6c69 7479  tures_visibility
+00038600: 280a 2020 2020 2320 7074 733a 2063 6f6f  (.    # pts: coo
+00038610: 7264 696e 6174 6573 2061 7320 7468 7265  rdinates as thre
+00038620: 6520 3164 2061 7272 6179 730a 2020 2020  e 1d arrays.    
+00038630: 646f 7562 6c65 5b3a 3a31 5d20 7074 735f  double[::1] pts_
+00038640: 782c 0a20 2020 2064 6f75 626c 655b 3a3a  x,.    double[::
+00038650: 315d 2070 7473 5f79 2c0a 2020 2020 646f  1] pts_y,.    do
+00038660: 7562 6c65 5b3a 3a31 5d20 7074 735f 7a2c  uble[::1] pts_z,
+00038670: 0a20 2020 2023 2064 6574 6563 746f 7273  .    # detectors
+00038680: 3a20 706f 6c79 676f 6e20 636f 6f72 6469  : polygon coordi
+00038690: 6e61 7465 7320 696e 2032 6420 2863 6f6d  nates in 2d (com
+000386a0: 6d6f 6e20 746f 2061 6c6c 2064 6574 6563  mon to all detec
+000386b0: 746f 7273 290a 2020 2020 646f 7562 6c65  tors).    double
+000386c0: 5b3a 3a31 5d20 6465 745f 6f75 746c 696e  [::1] det_outlin
+000386d0: 655f 7830 2c0a 2020 2020 646f 7562 6c65  e_x0,.    double
+000386e0: 5b3a 3a31 5d20 6465 745f 6f75 746c 696e  [::1] det_outlin
+000386f0: 655f 7831 2c0a 2020 2020 2320 6465 7465  e_x1,.    # dete
+00038700: 6374 6f72 733a 2063 656e 7465 7273 2063  ctors: centers c
+00038710: 6f6f 7264 696e 6174 6573 2061 7320 7468  oordinates as th
+00038720: 7265 6520 3164 2061 7272 6179 730a 2020  ree 1d arrays.  
+00038730: 2020 646f 7562 6c65 5b3a 3a31 5d20 6465    double[::1] de
+00038740: 745f 6365 6e74 735f 782c 0a20 2020 2064  t_cents_x,.    d
+00038750: 6f75 626c 655b 3a3a 315d 2064 6574 5f63  ouble[::1] det_c
+00038760: 656e 7473 5f79 2c0a 2020 2020 646f 7562  ents_y,.    doub
+00038770: 6c65 5b3a 3a31 5d20 6465 745f 6365 6e74  le[::1] det_cent
+00038780: 735f 7a2c 0a20 2020 2023 2064 6574 6563  s_z,.    # detec
+00038790: 746f 7273 3a20 6e6f 726d 616c 2075 6e69  tors: normal uni
+000387a0: 7420 7665 6374 6f72 7320 6173 2074 6872  t vectors as thr
+000387b0: 6565 2031 6420 6172 7261 7973 2028 6e64  ee 1d arrays (nd
+000387c0: 203d 206c 656e 2864 6574 5f6e 6f72 6d5f   = len(det_norm_
+000387d0: 7829 290a 2020 2020 646f 7562 6c65 5b3a  x)).    double[:
+000387e0: 3a31 5d20 6465 745f 6e6f 726d 5f78 2c0a  :1] det_norm_x,.
+000387f0: 2020 2020 646f 7562 6c65 5b3a 3a31 5d20      double[::1] 
+00038800: 6465 745f 6e6f 726d 5f79 2c0a 2020 2020  det_norm_y,.    
+00038810: 646f 7562 6c65 5b3a 3a31 5d20 6465 745f  double[::1] det_
+00038820: 6e6f 726d 5f7a 2c0a 2020 2020 6e70 2e6e  norm_z,.    np.n
+00038830: 6461 7272 6179 5b64 6f75 626c 652c 206e  darray[double, n
+00038840: 6469 6d3d 315d 2064 6574 5f65 305f 782c  dim=1] det_e0_x,
+00038850: 0a20 2020 206e 702e 6e64 6172 7261 795b  .    np.ndarray[
+00038860: 646f 7562 6c65 2c20 6e64 696d 3d31 5d20  double, ndim=1] 
+00038870: 6465 745f 6530 5f79 2c0a 2020 2020 6e70  det_e0_y,.    np
+00038880: 2e6e 6461 7272 6179 5b64 6f75 626c 652c  .ndarray[double,
+00038890: 206e 6469 6d3d 315d 2064 6574 5f65 305f   ndim=1] det_e0_
+000388a0: 7a2c 0a20 2020 206e 702e 6e64 6172 7261  z,.    np.ndarra
+000388b0: 795b 646f 7562 6c65 2c20 6e64 696d 3d31  y[double, ndim=1
+000388c0: 5d20 6465 745f 6531 5f78 2c0a 2020 2020  ] det_e1_x,.    
+000388d0: 6e70 2e6e 6461 7272 6179 5b64 6f75 626c  np.ndarray[doubl
+000388e0: 652c 206e 6469 6d3d 315d 2064 6574 5f65  e, ndim=1] det_e
+000388f0: 315f 792c 0a20 2020 206e 702e 6e64 6172  1_y,.    np.ndar
+00038900: 7261 795b 646f 7562 6c65 2c20 6e64 696d  ray[double, ndim
+00038910: 3d31 5d20 6465 745f 6531 5f7a 2c0a 2020  =1] det_e1_z,.  
+00038920: 2020 2320 6170 6572 7475 7265 733a 2069    # apertures: i
+00038930: 6e64 6963 6573 206f 6620 6669 7273 7420  ndices of first 
+00038940: 636f 726e 6572 206f 6620 6561 6368 2061  corner of each a
+00038950: 7020 706f 6c79 676f 6e3a 206e 6120 3d20  p polygon: na = 
+00038960: 6c65 6e28 6170 5f69 6e64 290a 2020 2020  len(ap_ind).    
+00038970: 6c6f 6e67 5b3a 3a31 5d20 6170 5f69 6e64  long[::1] ap_ind
+00038980: 2c0a 2020 2020 2320 6170 6572 7475 7265  ,.    # aperture
+00038990: 733a 2070 6f6c 7967 6f6e 2063 6f6f 7264  s: polygon coord
+000389a0: 696e 6174 6573 2061 7320 7468 7265 6520  inates as three 
+000389b0: 3164 2061 7272 6179 730a 2020 2020 6e70  1d arrays.    np
+000389c0: 2e6e 6461 7272 6179 5b64 6f75 626c 652c  .ndarray[double,
+000389d0: 206e 6469 6d3d 315d 2061 705f 782c 0a20   ndim=1] ap_x,. 
+000389e0: 2020 206e 702e 6e64 6172 7261 795b 646f     np.ndarray[do
+000389f0: 7562 6c65 2c20 6e64 696d 3d31 5d20 6170  uble, ndim=1] ap
+00038a00: 5f79 2c0a 2020 2020 6e70 2e6e 6461 7272  _y,.    np.ndarr
+00038a10: 6179 5b64 6f75 626c 652c 206e 6469 6d3d  ay[double, ndim=
+00038a20: 315d 2061 705f 7a2c 0a20 2020 2023 206e  1] ap_z,.    # n
+00038a30: 6f72 6d61 6c20 756e 6974 2076 6563 746f  ormal unit vecto
+00038a40: 7273 0a20 2020 2064 6f75 626c 655b 3a3a  rs.    double[::
+00038a50: 315d 2061 705f 6e6f 726d 5f78 2c0a 2020  1] ap_norm_x,.  
+00038a60: 2020 646f 7562 6c65 5b3a 3a31 5d20 6170    double[::1] ap
+00038a70: 5f6e 6f72 6d5f 792c 0a20 2020 2064 6f75  _norm_y,.    dou
+00038a80: 626c 655b 3a3a 315d 2061 705f 6e6f 726d  ble[::1] ap_norm
+00038a90: 5f7a 2c0a 2020 2020 2320 7669 7369 6269  _z,.    # visibi
+00038aa0: 6c69 7479 2074 6573 7469 6e67 0a20 2020  lity testing.   
+00038ab0: 2076 6573 5f70 6f6c 793d 4e6f 6e65 2c0a   ves_poly=None,.
+00038ac0: 2020 2020 7665 735f 6e6f 726d 3d4e 6f6e      ves_norm=Non
+00038ad0: 652c 0a20 2020 2076 6573 5f6c 696d 733d  e,.    ves_lims=
+00038ae0: 4e6f 6e65 2c0a 2020 2020 6c73 7472 7563  None,.    lstruc
+00038af0: 745f 706f 6c79 783d 4e6f 6e65 2c0a 2020  t_polyx=None,.  
+00038b00: 2020 6c73 7472 7563 745f 706f 6c79 793d    lstruct_polyy=
+00038b10: 4e6f 6e65 2c0a 2020 2020 6c73 7472 7563  None,.    lstruc
+00038b20: 745f 6c69 6d73 3d4e 6f6e 652c 0a20 2020  t_lims=None,.   
+00038b30: 206c 7374 7275 6374 5f6e 6c69 6d3d 4e6f   lstruct_nlim=No
+00038b40: 6e65 2c0a 2020 2020 6c73 7472 7563 745f  ne,.    lstruct_
+00038b50: 6e6f 726d 783d 4e6f 6e65 2c0a 2020 2020  normx=None,.    
+00038b60: 6c73 7472 7563 745f 6e6f 726d 793d 4e6f  lstruct_normy=No
+00038b70: 6e65 2c0a 2020 2020 6e73 7472 7563 745f  ne,.    nstruct_
+00038b80: 746f 743d 4e6f 6e65 2c0a 2020 2020 6e73  tot=None,.    ns
+00038b90: 7472 7563 745f 6c69 6d3d 4e6f 6e65 2c0a  truct_lim=None,.
+00038ba0: 2020 2020 6c6e 7665 7274 3d4e 6f6e 652c      lnvert=None,
+00038bb0: 0a20 2020 2072 6d69 6e3d 4e6f 6e65 2c0a  .    rmin=None,.
+00038bc0: 2020 2020 2320 706f 7373 6962 6c65 2065      # possible e
+00038bd0: 7874 7261 2070 6172 616d 6574 6572 7320  xtra parameters 
+00038be0: 3f0a 2020 2020 646f 7562 6c65 206d 6172  ?.    double mar
+00038bf0: 6769 6e3d 5f56 534d 414c 4c2c 0a20 2020  gin=_VSMALL,.   
+00038c00: 2069 6e74 206e 756d 5f74 6872 6561 6473   int num_threads
+00038c10: 3d31 302c 0a29 3a0a 0a20 2020 2023 202d  =10,.):..    # -
+00038c20: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2023  ----------.    #
+00038c30: 2044 6563 6c61 7261 7469 6f6e 0a0a 2020   Declaration..  
+00038c40: 2020 6364 6566 2069 6e74 206e 7074 7320    cdef int npts 
+00038c50: 3d20 7074 735f 782e 7369 7a65 0a20 2020  = pts_x.size.   
+00038c60: 2063 6465 6620 696e 7420 6e64 203d 2064   cdef int nd = d
+00038c70: 6574 5f63 656e 7473 5f78 2e73 697a 650a  et_cents_x.size.
+00038c80: 2020 2020 6364 6566 2069 6e74 206e 6120      cdef int na 
+00038c90: 3d20 6170 5f6e 6f72 6d5f 782e 7369 7a65  = ap_norm_x.size
+00038ca0: 0a20 2020 2063 6465 6620 696e 7420 6464  .    cdef int dd
+00038cb0: 2c20 7070 2c20 6161 2c20 7474 0a20 2020  , pp, aa, tt.   
+00038cc0: 2063 6465 6620 696e 7420 6e70 610a 2020   cdef int npa.  
+00038cd0: 2020 6364 6566 2066 6c6f 6174 2073 6361    cdef float sca
+00038ce0: 2c20 7363 6130 2c20 7363 6131 0a20 2020  , sca0, sca1.   
+00038cf0: 2063 6465 6620 666c 6f61 7420 6b69 0a20   cdef float ki. 
+00038d00: 2020 2063 6465 6620 6e70 2e6e 6461 7272     cdef np.ndarr
+00038d10: 6179 5b64 6f75 626c 652c 206e 6469 6d3d  ay[double, ndim=
+00038d20: 315d 2061 705f 7830 203d 206e 702e 636f  1] ap_x0 = np.co
+00038d30: 7079 2861 705f 7829 0a20 2020 2063 6465  py(ap_x).    cde
+00038d40: 6620 6e70 2e6e 6461 7272 6179 5b64 6f75  f np.ndarray[dou
+00038d50: 626c 652c 206e 6469 6d3d 315d 2061 705f  ble, ndim=1] ap_
+00038d60: 7831 203d 206e 702e 636f 7079 2861 705f  x1 = np.copy(ap_
+00038d70: 7829 0a20 2020 2063 6465 6620 6e70 2e6e  x).    cdef np.n
+00038d80: 6461 7272 6179 5b64 6f75 626c 652c 206e  darray[double, n
+00038d90: 6469 6d3d 315d 2070 5f61 5f78 300a 2020  dim=1] p_a_x0.  
+00038da0: 2020 6364 6566 206e 702e 6e64 6172 7261    cdef np.ndarra
+00038db0: 795b 646f 7562 6c65 2c20 6e64 696d 3d31  y[double, ndim=1
+00038dc0: 5d20 705f 615f 7831 0a20 2020 2063 6465  ] p_a_x1.    cde
+00038dd0: 6620 666c 6f61 7420 6378 302c 2063 7831  f float cx0, cx1
+00038de0: 0a20 2020 2063 6465 6620 666c 6f61 7420  .    cdef float 
+00038df0: 7578 2c20 7579 2c20 757a 2c20 696e 765f  ux, uy, uz, inv_
+00038e00: 6e6f 726d 0a20 2020 2063 6465 6620 6e70  norm.    cdef np
+00038e10: 2e6e 6461 7272 6179 5b6c 6f6e 672c 206e  .ndarray[long, n
+00038e20: 6469 6d3d 325d 2074 7269 0a20 2020 2063  dim=2] tri.    c
+00038e30: 6465 6620 6e70 2e6e 6461 7272 6179 5b64  def np.ndarray[d
+00038e40: 6f75 626c 652c 206e 6469 6d3d 315d 2074  ouble, ndim=1] t
+00038e50: 7269 5f78 0a20 2020 2063 6465 6620 6e70  ri_x.    cdef np
+00038e60: 2e6e 6461 7272 6179 5b64 6f75 626c 652c  .ndarray[double,
+00038e70: 206e 6469 6d3d 315d 2074 7269 5f79 0a20   ndim=1] tri_y. 
+00038e80: 2020 2063 6465 6620 6e70 2e6e 6461 7272     cdef np.ndarr
+00038e90: 6179 5b64 6f75 626c 652c 206e 6469 6d3d  ay[double, ndim=
+00038ea0: 315d 2074 7269 5f7a 0a0a 2020 2020 2320  1] tri_z..    # 
+00038eb0: 696e 6974 6961 6c69 7a65 2073 6f6c 6964  initialize solid
+00038ec0: 2061 6e67 6c65 2061 7272 6179 2077 6974   angle array wit
+00038ed0: 6820 7a65 726f 730a 2020 2020 6364 6566  h zeros.    cdef
+00038ee0: 206e 702e 6e64 6172 7261 795b 646f 7562   np.ndarray[doub
+00038ef0: 6c65 2c20 6e64 696d 3d32 5d20 736f 6c69  le, ndim=2] soli
+00038f00: 645f 616e 676c 6520 3d20 6e70 2e7a 6572  d_angle = np.zer
+00038f10: 6f73 2828 6e64 2c20 6e70 7473 292c 2064  os((nd, npts), d
+00038f20: 7479 7065 3d66 6c6f 6174 290a 0a20 2020  type=float)..   
+00038f30: 2023 202d 2d2d 2d2d 2d2d 0a20 2020 2023   # -------.    #
+00038f40: 2043 6f6d 7075 7465 0a0a 2020 2020 666f   Compute..    fo
+00038f50: 7220 6464 2069 6e20 7261 6e67 6528 6e64  r dd in range(nd
+00038f60: 293a 0a0a 2020 2020 2020 2020 2320 6c6f  ):..        # lo
+00038f70: 6f70 2032 3a20 6f6e 206e 7074 7320 286f  op 2: on npts (o
+00038f80: 6273 6572 7661 7469 6f6e 2070 6f69 6e74  bservation point
+00038f90: 7329 0a20 2020 2020 2020 2066 6f72 2070  s).        for p
+00038fa0: 7020 696e 2072 616e 6765 286e 7074 7329  p in range(npts)
+00038fb0: 3a0a 0a20 2020 2020 2020 2020 2020 2023  :..            #
+00038fc0: 2074 6573 7420 6966 206f 6e20 676f 6f64   test if on good
+00038fd0: 2073 6964 6520 6f66 2064 6574 6563 746f   side of detecto
+00038fe0: 720a 2020 2020 2020 2020 2020 2020 7363  r.            sc
+00038ff0: 6130 203d 2028 0a20 2020 2020 2020 2020  a0 = (.         
+00039000: 2020 2020 2020 2028 7074 735f 785b 7070         (pts_x[pp
+00039010: 5d20 2d20 6465 745f 6365 6e74 735f 785b  ] - det_cents_x[
+00039020: 6464 5d29 202a 2064 6574 5f6e 6f72 6d5f  dd]) * det_norm_
+00039030: 785b 6464 5d0a 2020 2020 2020 2020 2020  x[dd].          
+00039040: 2020 2020 2020 2b20 2870 7473 5f79 5b70        + (pts_y[p
+00039050: 705d 202d 2064 6574 5f63 656e 7473 5f79  p] - det_cents_y
+00039060: 5b64 645d 2920 2a20 6465 745f 6e6f 726d  [dd]) * det_norm
+00039070: 5f79 5b64 645d 0a20 2020 2020 2020 2020  _y[dd].         
+00039080: 2020 2020 2020 202b 2028 7074 735f 7a5b         + (pts_z[
+00039090: 7070 5d20 2d20 6465 745f 6365 6e74 735f  pp] - det_cents_
+000390a0: 7a5b 6464 5d29 202a 2064 6574 5f6e 6f72  z[dd]) * det_nor
+000390b0: 6d5f 7a5b 6464 5d0a 2020 2020 2020 2020  m_z[dd].        
+000390c0: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
+000390d0: 2020 2069 6620 7363 6130 203c 3d20 303a     if sca0 <= 0:
+000390e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000390f0: 2063 6f6e 7469 6e75 650a 0a20 2020 2020   continue..     
+00039100: 2020 2020 2020 2023 2066 6c61 670a 2020         # flag.  
+00039110: 2020 2020 2020 2020 2020 6973 6f6b 203d            isok =
+00039120: 2054 7275 650a 0a20 2020 2020 2020 2020   True..         
+00039130: 2020 2023 206c 6f6f 7020 333a 206f 6e20     # loop 3: on 
+00039140: 6e61 2028 6170 6572 7475 7265 7329 0a20  na (apertures). 
+00039150: 2020 2020 2020 2020 2020 2066 6f72 2061             for a
+00039160: 6120 696e 2072 616e 6765 286e 6129 3a0a  a in range(na):.
+00039170: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00039180: 2023 2074 6573 7420 6966 206f 6e20 676f   # test if on go
+00039190: 6f64 2073 6964 6520 6f66 2061 7065 7274  od side of apert
+000391a0: 7572 650a 2020 2020 2020 2020 2020 2020  ure.            
+000391b0: 2020 2020 7363 6120 3d20 280a 2020 2020      sca = (.    
+000391c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000391d0: 2870 7473 5f78 5b70 705d 202d 2061 705f  (pts_x[pp] - ap_
+000391e0: 785b 6170 5f69 6e64 5b61 615d 5d29 202a  x[ap_ind[aa]]) *
+000391f0: 2061 705f 6e6f 726d 5f78 5b61 615d 0a20   ap_norm_x[aa]. 
+00039200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039210: 2020 202b 2028 7074 735f 795b 7070 5d20     + (pts_y[pp] 
+00039220: 2d20 6170 5f79 5b61 705f 696e 645b 6161  - ap_y[ap_ind[aa
+00039230: 5d5d 2920 2a20 6170 5f6e 6f72 6d5f 795b  ]]) * ap_norm_y[
+00039240: 6161 5d0a 2020 2020 2020 2020 2020 2020  aa].            
+00039250: 2020 2020 2020 2020 2b20 2870 7473 5f7a          + (pts_z
+00039260: 5b70 705d 202d 2061 705f 7a5b 6170 5f69  [pp] - ap_z[ap_i
+00039270: 6e64 5b61 615d 5d29 202a 2061 705f 6e6f  nd[aa]]) * ap_no
+00039280: 726d 5f7a 5b61 615d 0a20 2020 2020 2020  rm_z[aa].       
+00039290: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+000392a0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+000392b0: 6361 203c 3d20 303a 0a20 2020 2020 2020  ca <= 0:.       
+000392c0: 2020 2020 2020 2020 2020 2020 2069 736f               iso
+000392d0: 6b20 3d20 4661 6c73 650a 2020 2020 2020  k = False.      
+000392e0: 2020 2020 2020 2020 2020 2020 2020 6272                br
+000392f0: 6561 6b0a 0a20 2020 2020 2020 2020 2020  eak..           
+00039300: 2020 2020 2023 2074 6573 7420 6966 2061       # test if a
+00039310: 6c6c 2061 7065 7274 7572 6520 706f 696e  ll aperture poin
+00039320: 7473 2063 616e 2062 6520 7072 6f6a 6563  ts can be projec
+00039330: 7465 6420 6f6e 2064 6574 6563 746f 7220  ted on detector 
+00039340: 706c 616e 6520 6672 6f6d 2070 7473 0a20  plane from pts. 
+00039350: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00039360: 6f72 206c 6c20 696e 2072 616e 6765 2861  or ll in range(a
+00039370: 705f 696e 645b 6161 5d2c 2061 705f 696e  p_ind[aa], ap_in
+00039380: 645b 6161 2b31 5d29 3a0a 2020 2020 2020  d[aa+1]):.      
+00039390: 2020 2020 2020 2020 2020 2020 2020 7363                sc
+000393a0: 6131 203d 2028 0a20 2020 2020 2020 2020  a1 = (.         
+000393b0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+000393c0: 6170 5f78 5b6c 6c5d 202d 2070 7473 5f78  ap_x[ll] - pts_x
+000393d0: 5b70 705d 2920 2a20 6465 745f 6e6f 726d  [pp]) * det_norm
+000393e0: 5f78 5b64 645d 0a20 2020 2020 2020 2020  _x[dd].         
+000393f0: 2020 2020 2020 2020 2020 2020 2020 202b                 +
+00039400: 2028 6170 5f79 5b6c 6c5d 202d 2070 7473   (ap_y[ll] - pts
+00039410: 5f79 5b70 705d 2920 2a20 6465 745f 6e6f  _y[pp]) * det_no
+00039420: 726d 5f79 5b64 645d 0a20 2020 2020 2020  rm_y[dd].       
 00039430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039440: 2020 2020 2020 2069 736f 6b20 3d20 4661         isok = Fa
-00039450: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
-00039460: 2020 2020 2020 2020 2020 2020 6272 6561              brea
-00039470: 6b0a 0a20 2020 2020 2020 2020 2020 2020  k..             
-00039480: 2020 2020 2020 2023 2070 726f 6a65 6374         # project
-00039490: 2069 6e20 3264 0a20 2020 2020 2020 2020   in 2d.         
-000394a0: 2020 2020 2020 2020 2020 206b 203d 202d             k = -
-000394b0: 2073 6361 3020 2f20 7363 6131 0a20 2020   sca0 / sca1.   
-000394c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000394d0: 2050 5f78 203d 2070 7473 5f78 5b70 705d   P_x = pts_x[pp]
-000394e0: 202b 206b 202a 2028 6170 5f78 5b6c 6c5d   + k * (ap_x[ll]
-000394f0: 202d 2070 7473 5f78 5b70 705d 290a 2020   - pts_x[pp]).  
-00039500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039510: 2020 505f 7920 3d20 7074 735f 795b 7070    P_y = pts_y[pp
-00039520: 5d20 2b20 6b20 2a20 2861 705f 795b 6c6c  ] + k * (ap_y[ll
-00039530: 5d20 2d20 7074 735f 795b 7070 5d29 0a20  ] - pts_y[pp]). 
-00039540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039550: 2020 2050 5f7a 203d 2070 7473 5f7a 5b70     P_z = pts_z[p
-00039560: 705d 202b 206b 202a 2028 6170 5f7a 5b6c  p] + k * (ap_z[l
-00039570: 6c5d 202d 2070 7473 5f7a 5b70 705d 290a  l] - pts_z[pp]).
-00039580: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00039590: 2020 2020 2023 2070 726f 6a65 6374 2069       # project i
-000395a0: 6e20 3264 0a20 2020 2020 2020 2020 2020  n 2d.           
-000395b0: 2020 2020 2020 2020 2061 705f 7830 5b6c           ap_x0[l
-000395c0: 6c5d 203d 2028 0a20 2020 2020 2020 2020  l] = (.         
-000395d0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-000395e0: 505f 7820 2d20 6465 745f 6365 6e74 735f  P_x - det_cents_
-000395f0: 785b 6464 5d29 202a 2064 6574 5f65 305f  x[dd]) * det_e0_
-00039600: 785b 6464 5d0a 2020 2020 2020 2020 2020  x[dd].          
-00039610: 2020 2020 2020 2020 2020 2020 2020 2b20                + 
-00039620: 2850 5f79 202d 2064 6574 5f63 656e 7473  (P_y - det_cents
-00039630: 5f79 5b64 645d 2920 2a20 6465 745f 6530  _y[dd]) * det_e0
-00039640: 5f79 5b64 645d 0a20 2020 2020 2020 2020  _y[dd].         
-00039650: 2020 2020 2020 2020 2020 2020 2020 202b                 +
-00039660: 2028 505f 7a20 2d20 6465 745f 6365 6e74   (P_z - det_cent
-00039670: 735f 7a5b 6464 5d29 202a 2064 6574 5f65  s_z[dd]) * det_e
-00039680: 305f 7a5b 6464 5d0a 2020 2020 2020 2020  0_z[dd].        
-00039690: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-000396a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000396b0: 2020 6170 5f78 315b 6c6c 5d20 3d20 280a    ap_x1[ll] = (.
+00039440: 202b 2028 6170 5f7a 5b6c 6c5d 202d 2070   + (ap_z[ll] - p
+00039450: 7473 5f7a 5b70 705d 2920 2a20 6465 745f  ts_z[pp]) * det_
+00039460: 6e6f 726d 5f7a 5b64 645d 0a20 2020 2020  norm_z[dd].     
+00039470: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00039480: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00039490: 2020 2020 2020 6966 2073 6361 3120 3e3d        if sca1 >=
+000394a0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+000394b0: 2020 2020 2020 2020 2020 2020 6973 6f6b              isok
+000394c0: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
+000394d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000394e0: 2062 7265 616b 0a0a 2020 2020 2020 2020   break..        
+000394f0: 2020 2020 2020 2020 2020 2020 2320 7072              # pr
+00039500: 6f6a 6563 7420 696e 2032 640a 2020 2020  oject in 2d.    
+00039510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039520: 6b20 3d20 2d20 7363 6130 202f 2073 6361  k = - sca0 / sca
+00039530: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
+00039540: 2020 2020 2020 505f 7820 3d20 7074 735f        P_x = pts_
+00039550: 785b 7070 5d20 2b20 6b20 2a20 2861 705f  x[pp] + k * (ap_
+00039560: 785b 6c6c 5d20 2d20 7074 735f 785b 7070  x[ll] - pts_x[pp
+00039570: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
+00039580: 2020 2020 2020 2050 5f79 203d 2070 7473         P_y = pts
+00039590: 5f79 5b70 705d 202b 206b 202a 2028 6170  _y[pp] + k * (ap
+000395a0: 5f79 5b6c 6c5d 202d 2070 7473 5f79 5b70  _y[ll] - pts_y[p
+000395b0: 705d 290a 2020 2020 2020 2020 2020 2020  p]).            
+000395c0: 2020 2020 2020 2020 505f 7a20 3d20 7074          P_z = pt
+000395d0: 735f 7a5b 7070 5d20 2b20 6b20 2a20 2861  s_z[pp] + k * (a
+000395e0: 705f 7a5b 6c6c 5d20 2d20 7074 735f 7a5b  p_z[ll] - pts_z[
+000395f0: 7070 5d29 0a0a 2020 2020 2020 2020 2020  pp])..          
+00039600: 2020 2020 2020 2020 2020 2320 7072 6f6a            # proj
+00039610: 6563 7420 696e 2032 640a 2020 2020 2020  ect in 2d.      
+00039620: 2020 2020 2020 2020 2020 2020 2020 6170                ap
+00039630: 5f78 305b 6c6c 5d20 3d20 280a 2020 2020  _x0[ll] = (.    
+00039640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039650: 2020 2020 2850 5f78 202d 2064 6574 5f63      (P_x - det_c
+00039660: 656e 7473 5f78 5b64 645d 2920 2a20 6465  ents_x[dd]) * de
+00039670: 745f 6530 5f78 5b64 645d 0a20 2020 2020  t_e0_x[dd].     
+00039680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039690: 2020 202b 2028 505f 7920 2d20 6465 745f     + (P_y - det_
+000396a0: 6365 6e74 735f 795b 6464 5d29 202a 2064  cents_y[dd]) * d
+000396b0: 6574 5f65 305f 795b 6464 5d0a 2020 2020  et_e0_y[dd].    
 000396c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000396d0: 2020 2020 2020 2020 2850 5f78 202d 2064          (P_x - d
-000396e0: 6574 5f63 656e 7473 5f78 5b64 645d 2920  et_cents_x[dd]) 
-000396f0: 2a20 6465 745f 6531 5f78 5b64 645d 0a20  * det_e1_x[dd]. 
+000396d0: 2020 2020 2b20 2850 5f7a 202d 2064 6574      + (P_z - det
+000396e0: 5f63 656e 7473 5f7a 5b64 645d 2920 2a20  _cents_z[dd]) * 
+000396f0: 6465 745f 6530 5f7a 5b64 645d 0a20 2020  det_e0_z[dd].   
 00039700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039710: 2020 2020 2020 202b 2028 505f 7920 2d20         + (P_y - 
-00039720: 6465 745f 6365 6e74 735f 795b 6464 5d29  det_cents_y[dd])
-00039730: 202a 2064 6574 5f65 315f 795b 6464 5d0a   * det_e1_y[dd].
-00039740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039750: 2020 2020 2020 2020 2b20 2850 5f7a 202d          + (P_z -
-00039760: 2064 6574 5f63 656e 7473 5f7a 5b64 645d   det_cents_z[dd]
-00039770: 2920 2a20 6465 745f 6531 5f7a 5b64 645d  ) * det_e1_z[dd]
-00039780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00039790: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-000397a0: 2020 2020 2020 2020 6966 206e 6f74 2069          if not i
-000397b0: 736f 6b3a 0a20 2020 2020 2020 2020 2020  sok:.           
-000397c0: 2020 2020 2020 2020 2062 7265 616b 0a0a           break..
-000397d0: 2020 2020 2020 2020 2020 2020 2320 676f              # go
-000397e0: 2074 6f20 6e65 7874 2070 6f69 6e74 0a20   to next point. 
-000397f0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-00039800: 7420 6973 6f6b 3a0a 2020 2020 2020 2020  t isok:.        
-00039810: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
-00039820: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-00039830: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00039840: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020  ------------.   
-00039850: 2020 2020 2020 2020 2023 2063 6f6d 7075           # compu
-00039860: 7465 2070 6f6c 7967 6f6e 2069 6e74 6572  te polygon inter
-00039870: 7365 6374 696f 6e0a 0a20 2020 2020 2020  section..       
-00039880: 2020 2020 2023 2063 6f6d 7075 7465 2069       # compute i
-00039890: 6e74 6572 7365 6374 696f 6e0a 2020 2020  ntersection.    
-000398a0: 2020 2020 2020 2020 705f 6120 3d20 706c          p_a = pl
-000398b0: 672e 506f 6c79 676f 6e28 6e70 2e61 7272  g.Polygon(np.arr
-000398c0: 6179 285b 6465 745f 6f75 746c 696e 655f  ay([det_outline_
-000398d0: 7830 2c20 6465 745f 6f75 746c 696e 655f  x0, det_outline_
-000398e0: 7831 5d29 2e54 290a 2020 2020 2020 2020  x1]).T).        
-000398f0: 2020 2020 666f 7220 6161 2069 6e20 7261      for aa in ra
-00039900: 6e67 6528 6e61 293a 0a20 2020 2020 2020  nge(na):.       
-00039910: 2020 2020 2020 2020 2070 5f61 203d 2070           p_a = p
-00039920: 5f61 2026 2070 6c67 2e50 6f6c 7967 6f6e  _a & plg.Polygon
-00039930: 286e 702e 6172 7261 7928 5b0a 2020 2020  (np.array([.    
-00039940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039950: 6170 5f78 305b 6170 5f69 6e64 5b61 615d  ap_x0[ap_ind[aa]
-00039960: 3a61 705f 696e 645b 6161 2b31 5d5d 2c0a  :ap_ind[aa+1]],.
-00039970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039980: 2020 2020 6170 5f78 315b 6170 5f69 6e64      ap_x1[ap_ind
-00039990: 5b61 615d 3a61 705f 696e 645b 6161 2b31  [aa]:ap_ind[aa+1
-000399a0: 5d5d 2c0a 2020 2020 2020 2020 2020 2020  ]],.            
-000399b0: 2020 2020 5d29 2e54 290a 0a20 2020 2020      ]).T)..     
-000399c0: 2020 2020 2020 2020 2020 2023 2073 746f             # sto
-000399d0: 7020 6966 206e 6f20 696e 7465 7273 6563  p if no intersec
-000399e0: 7469 6f6e 0a20 2020 2020 2020 2020 2020  tion.           
-000399f0: 2020 2020 2069 6620 705f 612e 6e50 6f69       if p_a.nPoi
-00039a00: 6e74 7328 2920 3c20 333a 0a20 2020 2020  nts() < 3:.     
-00039a10: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00039a20: 736f 6b20 3d20 4661 6c73 650a 2020 2020  sok = False.    
+00039710: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+00039720: 2020 2020 2020 2061 705f 7831 5b6c 6c5d         ap_x1[ll]
+00039730: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+00039740: 2020 2020 2020 2020 2020 2020 2028 505f               (P_
+00039750: 7820 2d20 6465 745f 6365 6e74 735f 785b  x - det_cents_x[
+00039760: 6464 5d29 202a 2064 6574 5f65 315f 785b  dd]) * det_e1_x[
+00039770: 6464 5d0a 2020 2020 2020 2020 2020 2020  dd].            
+00039780: 2020 2020 2020 2020 2020 2020 2b20 2850              + (P
+00039790: 5f79 202d 2064 6574 5f63 656e 7473 5f79  _y - det_cents_y
+000397a0: 5b64 645d 2920 2a20 6465 745f 6531 5f79  [dd]) * det_e1_y
+000397b0: 5b64 645d 0a20 2020 2020 2020 2020 2020  [dd].           
+000397c0: 2020 2020 2020 2020 2020 2020 202b 2028               + (
+000397d0: 505f 7a20 2d20 6465 745f 6365 6e74 735f  P_z - det_cents_
+000397e0: 7a5b 6464 5d29 202a 2064 6574 5f65 315f  z[dd]) * det_e1_
+000397f0: 7a5b 6464 5d0a 2020 2020 2020 2020 2020  z[dd].          
+00039800: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+00039810: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00039820: 6e6f 7420 6973 6f6b 3a0a 2020 2020 2020  not isok:.      
+00039830: 2020 2020 2020 2020 2020 2020 2020 6272                br
+00039840: 6561 6b0a 0a20 2020 2020 2020 2020 2020  eak..           
+00039850: 2023 2067 6f20 746f 206e 6578 7420 706f   # go to next po
+00039860: 696e 740a 2020 2020 2020 2020 2020 2020  int.            
+00039870: 6966 206e 6f74 2069 736f 6b3a 0a20 2020  if not isok:.   
+00039880: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+00039890: 7469 6e75 650a 0a20 2020 2020 2020 2020  tinue..         
+000398a0: 2020 2023 202d 2d2d 2d2d 2d2d 2d2d 2d2d     # -----------
+000398b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000398c0: 2d0a 2020 2020 2020 2020 2020 2020 2320  -.            # 
+000398d0: 636f 6d70 7574 6520 706f 6c79 676f 6e20  compute polygon 
+000398e0: 696e 7465 7273 6563 7469 6f6e 0a0a 2020  intersection..  
+000398f0: 2020 2020 2020 2020 2020 2320 636f 6d70            # comp
+00039900: 7574 6520 696e 7465 7273 6563 7469 6f6e  ute intersection
+00039910: 0a20 2020 2020 2020 2020 2020 2070 5f61  .            p_a
+00039920: 203d 2070 6c67 2e50 6f6c 7967 6f6e 286e   = plg.Polygon(n
+00039930: 702e 6172 7261 7928 5b64 6574 5f6f 7574  p.array([det_out
+00039940: 6c69 6e65 5f78 302c 2064 6574 5f6f 7574  line_x0, det_out
+00039950: 6c69 6e65 5f78 315d 292e 5429 0a20 2020  line_x1]).T).   
+00039960: 2020 2020 2020 2020 2066 6f72 2061 6120           for aa 
+00039970: 696e 2072 616e 6765 286e 6129 3a0a 2020  in range(na):.  
+00039980: 2020 2020 2020 2020 2020 2020 2020 705f                p_
+00039990: 6120 3d20 705f 6120 2620 706c 672e 506f  a = p_a & plg.Po
+000399a0: 6c79 676f 6e28 6e70 2e61 7272 6179 285b  lygon(np.array([
+000399b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000399c0: 2020 2020 2061 705f 7830 5b61 705f 696e       ap_x0[ap_in
+000399d0: 645b 6161 5d3a 6170 5f69 6e64 5b61 612b  d[aa]:ap_ind[aa+
+000399e0: 315d 5d2c 0a20 2020 2020 2020 2020 2020  1]],.           
+000399f0: 2020 2020 2020 2020 2061 705f 7831 5b61           ap_x1[a
+00039a00: 705f 696e 645b 6161 5d3a 6170 5f69 6e64  p_ind[aa]:ap_ind
+00039a10: 5b61 612b 315d 5d2c 0a20 2020 2020 2020  [aa+1]],.       
+00039a20: 2020 2020 2020 2020 205d 292e 5429 0a0a           ]).T)..
 00039a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039a40: 6272 6561 6b0a 0a20 2020 2020 2020 2020  break..         
-00039a50: 2020 2023 2073 746f 7020 6966 206e 6f20     # stop if no 
-00039a60: 696e 7465 7273 6563 7469 6f6e 0a20 2020  intersection.   
-00039a70: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-00039a80: 6973 6f6b 3a0a 2020 2020 2020 2020 2020  isok:.          
-00039a90: 2020 2020 2020 636f 6e74 696e 7565 0a0a        continue..
-00039aa0: 2020 2020 2020 2020 2020 2020 2320 2d2d              # --
-00039ab0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00039ac0: 2d0a 2020 2020 2020 2020 2020 2020 2320  -.            # 
-00039ad0: 4765 7420 756e 6974 2076 6563 746f 720a  Get unit vector.
-00039ae0: 0a20 2020 2020 2020 2020 2020 2063 7830  .            cx0
-00039af0: 2c20 6378 3120 3d20 705f 612e 6365 6e74  , cx1 = p_a.cent
-00039b00: 6572 2830 290a 2020 2020 2020 2020 2020  er(0).          
-00039b10: 2020 6378 203d 2064 6574 5f63 656e 7473    cx = det_cents
-00039b20: 5f78 5b64 645d 202b 2063 7830 2a64 6574  _x[dd] + cx0*det
-00039b30: 5f65 305f 785b 6464 5d20 2b20 6378 312a  _e0_x[dd] + cx1*
-00039b40: 6465 745f 6531 5f78 5b64 645d 0a20 2020  det_e1_x[dd].   
-00039b50: 2020 2020 2020 2020 2063 7920 3d20 6465           cy = de
-00039b60: 745f 6365 6e74 735f 795b 6464 5d20 2b20  t_cents_y[dd] + 
-00039b70: 6378 302a 6465 745f 6530 5f79 5b64 645d  cx0*det_e0_y[dd]
-00039b80: 202b 2063 7831 2a64 6574 5f65 315f 795b   + cx1*det_e1_y[
-00039b90: 6464 5d0a 2020 2020 2020 2020 2020 2020  dd].            
-00039ba0: 637a 203d 2064 6574 5f63 656e 7473 5f7a  cz = det_cents_z
-00039bb0: 5b64 645d 202b 2063 7830 2a64 6574 5f65  [dd] + cx0*det_e
-00039bc0: 305f 7a5b 6464 5d20 2b20 6378 312a 6465  0_z[dd] + cx1*de
-00039bd0: 745f 6531 5f7a 5b64 645d 0a0a 2020 2020  t_e1_z[dd]..    
-00039be0: 2020 2020 2020 2020 2320 6368 6563 6b20          # check 
-00039bf0: 7669 7369 6269 6c69 7479 0a20 2020 2020  visibility.     
-00039c00: 2020 2020 2020 2076 6973 203d 204c 4f53         vis = LOS
-00039c10: 5f69 7356 6973 5f50 7446 726f 6d50 7473  _isVis_PtFromPts
-00039c20: 5f56 6573 5374 7275 6374 280a 2020 2020  _VesStruct(.    
-00039c30: 2020 2020 2020 2020 2020 2020 6378 2c0a              cx,.
-00039c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039c50: 6379 2c0a 2020 2020 2020 2020 2020 2020  cy,.            
-00039c60: 2020 2020 637a 2c0a 2020 2020 2020 2020      cz,.        
-00039c70: 2020 2020 2020 2020 6e70 2e61 7272 6179          np.array
-00039c80: 285b 5b70 7473 5f78 5b70 705d 5d2c 205b  ([[pts_x[pp]], [
-00039c90: 7074 735f 795b 7070 5d5d 2c20 5b70 7473  pts_y[pp]], [pts
-00039ca0: 5f7a 5b70 705d 5d5d 292c 0a20 2020 2020  _z[pp]]]),.     
-00039cb0: 2020 2020 2020 2020 2020 2064 6973 743d             dist=
-00039cc0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
-00039cd0: 2020 2020 2020 726d 696e 3d72 6d69 6e2c        rmin=rmin,
-00039ce0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00039cf0: 2076 6573 5f70 6f6c 793d 7665 735f 706f   ves_poly=ves_po
-00039d00: 6c79 2c0a 2020 2020 2020 2020 2020 2020  ly,.            
-00039d10: 2020 2020 7665 735f 6e6f 726d 3d76 6573      ves_norm=ves
-00039d20: 5f6e 6f72 6d2c 0a20 2020 2020 2020 2020  _norm,.         
-00039d30: 2020 2020 2020 2076 6573 5f6c 696d 733d         ves_lims=
-00039d40: 7665 735f 6c69 6d73 2c0a 2020 2020 2020  ves_lims,.      
-00039d50: 2020 2020 2020 2020 2020 6c73 7472 7563            lstruc
-00039d60: 745f 706f 6c79 783d 6c73 7472 7563 745f  t_polyx=lstruct_
-00039d70: 706f 6c79 782c 0a20 2020 2020 2020 2020  polyx,.         
-00039d80: 2020 2020 2020 206c 7374 7275 6374 5f70         lstruct_p
-00039d90: 6f6c 7979 3d6c 7374 7275 6374 5f70 6f6c  olyy=lstruct_pol
-00039da0: 7979 2c0a 2020 2020 2020 2020 2020 2020  yy,.            
-00039db0: 2020 2020 6c73 7472 7563 745f 6c69 6d73      lstruct_lims
-00039dc0: 3d6c 7374 7275 6374 5f6c 696d 732c 0a20  =lstruct_lims,. 
-00039dd0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00039de0: 7374 7275 6374 5f6e 6c69 6d3d 6c73 7472  struct_nlim=lstr
-00039df0: 7563 745f 6e6c 696d 2c0a 2020 2020 2020  uct_nlim,.      
-00039e00: 2020 2020 2020 2020 2020 6c73 7472 7563            lstruc
-00039e10: 745f 6e6f 726d 783d 6c73 7472 7563 745f  t_normx=lstruct_
-00039e20: 6e6f 726d 782c 0a20 2020 2020 2020 2020  normx,.         
-00039e30: 2020 2020 2020 206c 7374 7275 6374 5f6e         lstruct_n
-00039e40: 6f72 6d79 3d6c 7374 7275 6374 5f6e 6f72  ormy=lstruct_nor
-00039e50: 6d79 2c0a 2020 2020 2020 2020 2020 2020  my,.            
-00039e60: 2020 2020 6c6e 7665 7274 3d6c 6e76 6572      lnvert=lnver
-00039e70: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-00039e80: 2020 206e 7374 7275 6374 5f74 6f74 3d6e     nstruct_tot=n
-00039e90: 7374 7275 6374 5f74 6f74 2c0a 2020 2020  struct_tot,.    
-00039ea0: 2020 2020 2020 2020 2020 2020 6e73 7472              nstr
-00039eb0: 7563 745f 6c69 6d3d 6e73 7472 7563 745f  uct_lim=nstruct_
-00039ec0: 6c69 6d2c 0a20 2020 2020 2020 2020 2020  lim,.           
-00039ed0: 2020 2020 2066 6f72 6269 643d 5472 7565       forbid=True
-00039ee0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00039ef0: 2020 7665 735f 7479 7065 3d27 546f 7227    ves_type='Tor'
-00039f00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00039f10: 2020 7465 7374 3d54 7275 652c 0a20 2020    test=True,.   
-00039f20: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-00039f30: 2020 2020 2020 2020 6966 206e 6f74 2076          if not v
-00039f40: 6973 5b30 5d3a 0a20 2020 2020 2020 2020  is[0]:.         
-00039f50: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
-00039f60: 0a20 2020 2020 2020 2020 2020 2023 202d  .            # -
-00039f70: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00039f80: 2d2d 0a20 2020 2020 2020 2020 2020 2023  --.            #
-00039f90: 2072 6562 7569 6c64 2033 6420 706f 6c79   rebuild 3d poly
-00039fa0: 676f 6e0a 0a20 2020 2020 2020 2020 2020  gon..           
-00039fb0: 2023 2063 6865 636b 2063 6377 0a20 2020   # check ccw.   
-00039fc0: 2020 2020 2020 2020 2070 5f61 5f78 3020           p_a_x0 
-00039fd0: 3d20 6e70 2e61 7363 6f6e 7469 6775 6f75  = np.ascontiguou
-00039fe0: 7361 7272 6179 286e 702e 6172 7261 7928  sarray(np.array(
-00039ff0: 705f 612e 636f 6e74 6f75 7228 3029 295b  p_a.contour(0))[
-0003a000: 3a2c 2030 5d29 0a20 2020 2020 2020 2020  :, 0]).         
-0003a010: 2020 2070 5f61 5f78 3120 3d20 6e70 2e61     p_a_x1 = np.a
-0003a020: 7363 6f6e 7469 6775 6f75 7361 7272 6179  scontiguousarray
-0003a030: 286e 702e 6172 7261 7928 705f 612e 636f  (np.array(p_a.co
-0003a040: 6e74 6f75 7228 3029 295b 3a2c 2031 5d29  ntour(0))[:, 1])
-0003a050: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0003a060: 6e6f 7420 5f63 6865 636b 5f70 6f6c 7967  not _check_polyg
-0003a070: 6f6e 5f32 645f 636f 756e 7465 725f 636c  on_2d_counter_cl
-0003a080: 6f63 6b77 6973 6528 705f 615f 7830 2c20  ockwise(p_a_x0, 
-0003a090: 705f 615f 7831 293a 0a20 2020 2020 2020  p_a_x1):.       
-0003a0a0: 2020 2020 2020 2020 2070 5f61 5f78 3020           p_a_x0 
-0003a0b0: 3d20 6e70 2e61 7363 6f6e 7469 6775 6f75  = np.ascontiguou
-0003a0c0: 7361 7272 6179 2870 5f61 5f78 305b 3a3a  sarray(p_a_x0[::
-0003a0d0: 2d31 5d29 0a20 2020 2020 2020 2020 2020  -1]).           
-0003a0e0: 2020 2020 2070 5f61 5f78 3120 3d20 6e70       p_a_x1 = np
-0003a0f0: 2e61 7363 6f6e 7469 6775 6f75 7361 7272  .ascontiguousarr
-0003a100: 6179 2870 5f61 5f78 315b 3a3a 2d31 5d29  ay(p_a_x1[::-1])
-0003a110: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-0003a120: 7472 6961 6e67 756c 6174 6520 6279 2065  triangulate by e
-0003a130: 6172 2d63 6c69 7070 696e 6720 2829 0a20  ar-clipping (). 
-0003a140: 2020 2020 2020 2020 2020 2074 7269 203d             tri =
-0003a150: 2074 7269 616e 6775 6c61 7465 5f62 795f   triangulate_by_
-0003a160: 6561 7263 6c69 7070 696e 675f 3264 280a  earclipping_2d(.
-0003a170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a180: 6e70 2e61 7363 6f6e 7469 6775 6f75 7361  np.ascontiguousa
-0003a190: 7272 6179 285b 705f 615f 7830 2c20 705f  rray([p_a_x0, p_
-0003a1a0: 615f 7831 5d29 0a20 2020 2020 2020 2020  a_x1]).         
-0003a1b0: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
-0003a1c0: 2020 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d    # ------------
-0003a1d0: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
-0003a1e0: 2020 2020 2320 636f 6d70 7574 6520 736f      # compute so
-0003a1f0: 6c69 6420 616e 676c 650a 0a20 2020 2020  lid angle..     
-0003a200: 2020 2020 2020 2023 206c 6f6f 7020 6f6e         # loop on
-0003a210: 2074 7269 616e 676c 6573 0a20 2020 2020   triangles.     
-0003a220: 2020 2020 2020 2066 6f72 2074 7420 696e         for tt in
-0003a230: 2072 616e 6765 2874 7269 2e73 6861 7065   range(tri.shape
-0003a240: 5b30 5d29 3a0a 0a20 2020 2020 2020 2020  [0]):..         
-0003a250: 2020 2020 2020 2023 2067 6574 2074 7269         # get tri
-0003a260: 616e 676c 650a 2020 2020 2020 2020 2020  angle.          
-0003a270: 2020 2020 2020 7472 695f 7820 3d20 280a        tri_x = (.
-0003a280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a290: 2020 2020 6465 745f 6365 6e74 735f 785b      det_cents_x[
-0003a2a0: 6464 5d0a 2020 2020 2020 2020 2020 2020  dd].            
-0003a2b0: 2020 2020 2020 2020 2b20 705f 615f 7830          + p_a_x0
-0003a2c0: 5b74 7269 5b74 742c 203a 5d5d 202a 2064  [tri[tt, :]] * d
-0003a2d0: 6574 5f65 305f 785b 6464 5d0a 2020 2020  et_e0_x[dd].    
-0003a2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a2f0: 2b20 705f 615f 7831 5b74 7269 5b74 742c  + p_a_x1[tri[tt,
-0003a300: 203a 5d5d 202a 2064 6574 5f65 315f 785b   :]] * det_e1_x[
-0003a310: 6464 5d0a 2020 2020 2020 2020 2020 2020  dd].            
-0003a320: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-0003a330: 2020 2020 2020 7472 695f 7920 3d20 280a        tri_y = (.
-0003a340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a350: 2020 2020 6465 745f 6365 6e74 735f 795b      det_cents_y[
-0003a360: 6464 5d0a 2020 2020 2020 2020 2020 2020  dd].            
-0003a370: 2020 2020 2020 2020 2b20 705f 615f 7830          + p_a_x0
-0003a380: 5b74 7269 5b74 742c 203a 5d5d 202a 2064  [tri[tt, :]] * d
-0003a390: 6574 5f65 305f 795b 6464 5d0a 2020 2020  et_e0_y[dd].    
-0003a3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a3b0: 2b20 705f 615f 7831 5b74 7269 5b74 742c  + p_a_x1[tri[tt,
-0003a3c0: 203a 5d5d 202a 2064 6574 5f65 315f 795b   :]] * det_e1_y[
-0003a3d0: 6464 5d0a 2020 2020 2020 2020 2020 2020  dd].            
-0003a3e0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-0003a3f0: 2020 2020 2020 7472 695f 7a20 3d20 280a        tri_z = (.
-0003a400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a410: 2020 2020 6465 745f 6365 6e74 735f 7a5b      det_cents_z[
-0003a420: 6464 5d0a 2020 2020 2020 2020 2020 2020  dd].            
-0003a430: 2020 2020 2020 2020 2b20 705f 615f 7830          + p_a_x0
-0003a440: 5b74 7269 5b74 742c 203a 5d5d 202a 2064  [tri[tt, :]] * d
-0003a450: 6574 5f65 305f 7a5b 6464 5d0a 2020 2020  et_e0_z[dd].    
-0003a460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a470: 2b20 705f 615f 7831 5b74 7269 5b74 742c  + p_a_x1[tri[tt,
-0003a480: 203a 5d5d 202a 2064 6574 5f65 315f 7a5b   :]] * det_e1_z[
-0003a490: 6464 5d0a 2020 2020 2020 2020 2020 2020  dd].            
-0003a4a0: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
-0003a4b0: 2020 2020 2020 2023 2063 6f6d 7075 7461         # computa
-0003a4c0: 7469 6f6e 2032 3a20 736f 6c69 6420 616e  tion 2: solid an
-0003a4d0: 676c 6520 6f66 2074 7269 616e 676c 6520  gle of triangle 
-0003a4e0: 6672 6f6d 2070 7473 0a20 2020 2020 2020  from pts.       
-0003a4f0: 2020 2020 2020 2020 2073 6f6c 6964 5f61           solid_a
-0003a500: 6e67 6c65 5b64 642c 2070 705d 202b 3d20  ngle[dd, pp] += 
-0003a510: 5f73 742e 636f 6d70 5f73 615f 7472 6928  _st.comp_sa_tri(
-0003a520: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003a530: 2020 2020 2074 7269 5f78 5b30 5d2c 0a20       tri_x[0],. 
-0003a540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a550: 2020 2074 7269 5f79 5b30 5d2c 0a20 2020     tri_y[0],.   
-0003a560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a570: 2074 7269 5f7a 5b30 5d2c 0a20 2020 2020   tri_z[0],.     
-0003a580: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0003a590: 7269 5f78 5b31 5d2c 0a20 2020 2020 2020  ri_x[1],.       
-0003a5a0: 2020 2020 2020 2020 2020 2020 2074 7269               tri
-0003a5b0: 5f79 5b31 5d2c 0a20 2020 2020 2020 2020  _y[1],.         
-0003a5c0: 2020 2020 2020 2020 2020 2074 7269 5f7a             tri_z
-0003a5d0: 5b31 5d2c 0a20 2020 2020 2020 2020 2020  [1],.           
-0003a5e0: 2020 2020 2020 2020 2074 7269 5f78 5b32           tri_x[2
-0003a5f0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-0003a600: 2020 2020 2020 2074 7269 5f79 5b32 5d2c         tri_y[2],
-0003a610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003a620: 2020 2020 2074 7269 5f7a 5b32 5d2c 0a20       tri_z[2],. 
+00039a40: 2320 7374 6f70 2069 6620 6e6f 2069 6e74  # stop if no int
+00039a50: 6572 7365 6374 696f 6e0a 2020 2020 2020  ersection.      
+00039a60: 2020 2020 2020 2020 2020 6966 2070 5f61            if p_a
+00039a70: 2e6e 506f 696e 7473 2829 203c 2033 3a0a  .nPoints() < 3:.
+00039a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039a90: 2020 2020 6973 6f6b 203d 2046 616c 7365      isok = False
+00039aa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00039ab0: 2020 2020 2062 7265 616b 0a0a 2020 2020       break..    
+00039ac0: 2020 2020 2020 2020 2320 7374 6f70 2069          # stop i
+00039ad0: 6620 6e6f 2069 6e74 6572 7365 6374 696f  f no intersectio
+00039ae0: 6e0a 2020 2020 2020 2020 2020 2020 6966  n.            if
+00039af0: 206e 6f74 2069 736f 6b3a 0a20 2020 2020   not isok:.     
+00039b00: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+00039b10: 6e75 650a 0a20 2020 2020 2020 2020 2020  nue..           
+00039b20: 2023 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   # -------------
+00039b30: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2020  ------.         
+00039b40: 2020 2023 2047 6574 2075 6e69 7420 7665     # Get unit ve
+00039b50: 6374 6f72 0a0a 2020 2020 2020 2020 2020  ctor..          
+00039b60: 2020 6378 302c 2063 7831 203d 2070 5f61    cx0, cx1 = p_a
+00039b70: 2e63 656e 7465 7228 3029 0a20 2020 2020  .center(0).     
+00039b80: 2020 2020 2020 2063 7820 3d20 6465 745f         cx = det_
+00039b90: 6365 6e74 735f 785b 6464 5d20 2b20 6378  cents_x[dd] + cx
+00039ba0: 302a 6465 745f 6530 5f78 5b64 645d 202b  0*det_e0_x[dd] +
+00039bb0: 2063 7831 2a64 6574 5f65 315f 785b 6464   cx1*det_e1_x[dd
+00039bc0: 5d0a 2020 2020 2020 2020 2020 2020 6379  ].            cy
+00039bd0: 203d 2064 6574 5f63 656e 7473 5f79 5b64   = det_cents_y[d
+00039be0: 645d 202b 2063 7830 2a64 6574 5f65 305f  d] + cx0*det_e0_
+00039bf0: 795b 6464 5d20 2b20 6378 312a 6465 745f  y[dd] + cx1*det_
+00039c00: 6531 5f79 5b64 645d 0a20 2020 2020 2020  e1_y[dd].       
+00039c10: 2020 2020 2063 7a20 3d20 6465 745f 6365       cz = det_ce
+00039c20: 6e74 735f 7a5b 6464 5d20 2b20 6378 302a  nts_z[dd] + cx0*
+00039c30: 6465 745f 6530 5f7a 5b64 645d 202b 2063  det_e0_z[dd] + c
+00039c40: 7831 2a64 6574 5f65 315f 7a5b 6464 5d0a  x1*det_e1_z[dd].
+00039c50: 0a20 2020 2020 2020 2020 2020 2023 2063  .            # c
+00039c60: 6865 636b 2076 6973 6962 696c 6974 790a  heck visibility.
+00039c70: 2020 2020 2020 2020 2020 2020 7669 7320              vis 
+00039c80: 3d20 4c4f 535f 6973 5669 735f 5074 4672  = LOS_isVis_PtFr
+00039c90: 6f6d 5074 735f 5665 7353 7472 7563 7428  omPts_VesStruct(
+00039ca0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00039cb0: 2063 782c 0a20 2020 2020 2020 2020 2020   cx,.           
+00039cc0: 2020 2020 2063 792c 0a20 2020 2020 2020       cy,.       
+00039cd0: 2020 2020 2020 2020 2063 7a2c 0a20 2020           cz,.   
+00039ce0: 2020 2020 2020 2020 2020 2020 206e 702e               np.
+00039cf0: 6172 7261 7928 5b5b 7074 735f 785b 7070  array([[pts_x[pp
+00039d00: 5d5d 2c20 5b70 7473 5f79 5b70 705d 5d2c  ]], [pts_y[pp]],
+00039d10: 205b 7074 735f 7a5b 7070 5d5d 5d29 2c0a   [pts_z[pp]]]),.
+00039d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039d30: 6469 7374 3d4e 6f6e 652c 0a20 2020 2020  dist=None,.     
+00039d40: 2020 2020 2020 2020 2020 2072 6d69 6e3d             rmin=
+00039d50: 726d 696e 2c0a 2020 2020 2020 2020 2020  rmin,.          
+00039d60: 2020 2020 2020 7665 735f 706f 6c79 3d76        ves_poly=v
+00039d70: 6573 5f70 6f6c 792c 0a20 2020 2020 2020  es_poly,.       
+00039d80: 2020 2020 2020 2020 2076 6573 5f6e 6f72           ves_nor
+00039d90: 6d3d 7665 735f 6e6f 726d 2c0a 2020 2020  m=ves_norm,.    
+00039da0: 2020 2020 2020 2020 2020 2020 7665 735f              ves_
+00039db0: 6c69 6d73 3d76 6573 5f6c 696d 732c 0a20  lims=ves_lims,. 
+00039dc0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00039dd0: 7374 7275 6374 5f70 6f6c 7978 3d6c 7374  struct_polyx=lst
+00039de0: 7275 6374 5f70 6f6c 7978 2c0a 2020 2020  ruct_polyx,.    
+00039df0: 2020 2020 2020 2020 2020 2020 6c73 7472              lstr
+00039e00: 7563 745f 706f 6c79 793d 6c73 7472 7563  uct_polyy=lstruc
+00039e10: 745f 706f 6c79 792c 0a20 2020 2020 2020  t_polyy,.       
+00039e20: 2020 2020 2020 2020 206c 7374 7275 6374           lstruct
+00039e30: 5f6c 696d 733d 6c73 7472 7563 745f 6c69  _lims=lstruct_li
+00039e40: 6d73 2c0a 2020 2020 2020 2020 2020 2020  ms,.            
+00039e50: 2020 2020 6c73 7472 7563 745f 6e6c 696d      lstruct_nlim
+00039e60: 3d6c 7374 7275 6374 5f6e 6c69 6d2c 0a20  =lstruct_nlim,. 
+00039e70: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00039e80: 7374 7275 6374 5f6e 6f72 6d78 3d6c 7374  struct_normx=lst
+00039e90: 7275 6374 5f6e 6f72 6d78 2c0a 2020 2020  ruct_normx,.    
+00039ea0: 2020 2020 2020 2020 2020 2020 6c73 7472              lstr
+00039eb0: 7563 745f 6e6f 726d 793d 6c73 7472 7563  uct_normy=lstruc
+00039ec0: 745f 6e6f 726d 792c 0a20 2020 2020 2020  t_normy,.       
+00039ed0: 2020 2020 2020 2020 206c 6e76 6572 743d           lnvert=
+00039ee0: 6c6e 7665 7274 2c0a 2020 2020 2020 2020  lnvert,.        
+00039ef0: 2020 2020 2020 2020 6e73 7472 7563 745f          nstruct_
+00039f00: 746f 743d 6e73 7472 7563 745f 746f 742c  tot=nstruct_tot,
+00039f10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00039f20: 206e 7374 7275 6374 5f6c 696d 3d6e 7374   nstruct_lim=nst
+00039f30: 7275 6374 5f6c 696d 2c0a 2020 2020 2020  ruct_lim,.      
+00039f40: 2020 2020 2020 2020 2020 666f 7262 6964            forbid
+00039f50: 3d54 7275 652c 0a20 2020 2020 2020 2020  =True,.         
+00039f60: 2020 2020 2020 2076 6573 5f74 7970 653d         ves_type=
+00039f70: 2754 6f72 272c 0a20 2020 2020 2020 2020  'Tor',.         
+00039f80: 2020 2020 2020 2074 6573 743d 5472 7565         test=True
+00039f90: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+00039fa0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00039fb0: 6e6f 7420 7669 735b 305d 3a0a 2020 2020  not vis[0]:.    
+00039fc0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+00039fd0: 696e 7565 0a0a 2020 2020 2020 2020 2020  inue..          
+00039fe0: 2020 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d    # ------------
+00039ff0: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
+0003a000: 2020 2020 2320 7265 6275 696c 6420 3364      # rebuild 3d
+0003a010: 2070 6f6c 7967 6f6e 0a0a 2020 2020 2020   polygon..      
+0003a020: 2020 2020 2020 2320 6368 6563 6b20 6363        # check cc
+0003a030: 770a 2020 2020 2020 2020 2020 2020 705f  w.            p_
+0003a040: 615f 7830 203d 206e 702e 6173 636f 6e74  a_x0 = np.ascont
+0003a050: 6967 756f 7573 6172 7261 7928 6e70 2e61  iguousarray(np.a
+0003a060: 7272 6179 2870 5f61 2e63 6f6e 746f 7572  rray(p_a.contour
+0003a070: 2830 2929 5b3a 2c20 305d 290a 2020 2020  (0))[:, 0]).    
+0003a080: 2020 2020 2020 2020 705f 615f 7831 203d          p_a_x1 =
+0003a090: 206e 702e 6173 636f 6e74 6967 756f 7573   np.ascontiguous
+0003a0a0: 6172 7261 7928 6e70 2e61 7272 6179 2870  array(np.array(p
+0003a0b0: 5f61 2e63 6f6e 746f 7572 2830 2929 5b3a  _a.contour(0))[:
+0003a0c0: 2c20 315d 290a 2020 2020 2020 2020 2020  , 1]).          
+0003a0d0: 2020 6966 206e 6f74 205f 6368 6563 6b5f    if not _check_
+0003a0e0: 706f 6c79 676f 6e5f 3264 5f63 6f75 6e74  polygon_2d_count
+0003a0f0: 6572 5f63 6c6f 636b 7769 7365 2870 5f61  er_clockwise(p_a
+0003a100: 5f78 302c 2070 5f61 5f78 3129 3a0a 2020  _x0, p_a_x1):.  
+0003a110: 2020 2020 2020 2020 2020 2020 2020 705f                p_
+0003a120: 615f 7830 203d 206e 702e 6173 636f 6e74  a_x0 = np.ascont
+0003a130: 6967 756f 7573 6172 7261 7928 705f 615f  iguousarray(p_a_
+0003a140: 7830 5b3a 3a2d 315d 290a 2020 2020 2020  x0[::-1]).      
+0003a150: 2020 2020 2020 2020 2020 705f 615f 7831            p_a_x1
+0003a160: 203d 206e 702e 6173 636f 6e74 6967 756f   = np.ascontiguo
+0003a170: 7573 6172 7261 7928 705f 615f 7831 5b3a  usarray(p_a_x1[:
+0003a180: 3a2d 315d 290a 0a20 2020 2020 2020 2020  :-1])..         
+0003a190: 2020 2023 2074 7269 616e 6775 6c61 7465     # triangulate
+0003a1a0: 2062 7920 6561 722d 636c 6970 7069 6e67   by ear-clipping
+0003a1b0: 2028 290a 2020 2020 2020 2020 2020 2020   ().            
+0003a1c0: 7472 6920 3d20 7472 6961 6e67 756c 6174  tri = triangulat
+0003a1d0: 655f 6279 5f65 6172 636c 6970 7069 6e67  e_by_earclipping
+0003a1e0: 5f32 6428 0a20 2020 2020 2020 2020 2020  _2d(.           
+0003a1f0: 2020 2020 206e 702e 6173 636f 6e74 6967       np.ascontig
+0003a200: 756f 7573 6172 7261 7928 5b70 5f61 5f78  uousarray([p_a_x
+0003a210: 302c 2070 5f61 5f78 315d 290a 2020 2020  0, p_a_x1]).    
+0003a220: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+0003a230: 2020 2020 2020 2023 202d 2d2d 2d2d 2d2d         # -------
+0003a240: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020  ------------.   
+0003a250: 2020 2020 2020 2020 2023 2063 6f6d 7075           # compu
+0003a260: 7465 2073 6f6c 6964 2061 6e67 6c65 0a0a  te solid angle..
+0003a270: 2020 2020 2020 2020 2020 2020 2320 6c6f              # lo
+0003a280: 6f70 206f 6e20 7472 6961 6e67 6c65 730a  op on triangles.
+0003a290: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0003a2a0: 7474 2069 6e20 7261 6e67 6528 7472 692e  tt in range(tri.
+0003a2b0: 7368 6170 655b 305d 293a 0a0a 2020 2020  shape[0]):..    
+0003a2c0: 2020 2020 2020 2020 2020 2020 2320 6765              # ge
+0003a2d0: 7420 7472 6961 6e67 6c65 0a20 2020 2020  t triangle.     
+0003a2e0: 2020 2020 2020 2020 2020 2074 7269 5f78             tri_x
+0003a2f0: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+0003a300: 2020 2020 2020 2020 2064 6574 5f63 656e           det_cen
+0003a310: 7473 5f78 5b64 645d 0a20 2020 2020 2020  ts_x[dd].       
+0003a320: 2020 2020 2020 2020 2020 2020 202b 2070               + p
+0003a330: 5f61 5f78 305b 7472 695b 7474 2c20 3a5d  _a_x0[tri[tt, :]
+0003a340: 5d20 2a20 6465 745f 6530 5f78 5b64 645d  ] * det_e0_x[dd]
+0003a350: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003a360: 2020 2020 202b 2070 5f61 5f78 315b 7472       + p_a_x1[tr
+0003a370: 695b 7474 2c20 3a5d 5d20 2a20 6465 745f  i[tt, :]] * det_
+0003a380: 6531 5f78 5b64 645d 0a20 2020 2020 2020  e1_x[dd].       
+0003a390: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0003a3a0: 2020 2020 2020 2020 2020 2074 7269 5f79             tri_y
+0003a3b0: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+0003a3c0: 2020 2020 2020 2020 2064 6574 5f63 656e           det_cen
+0003a3d0: 7473 5f79 5b64 645d 0a20 2020 2020 2020  ts_y[dd].       
+0003a3e0: 2020 2020 2020 2020 2020 2020 202b 2070               + p
+0003a3f0: 5f61 5f78 305b 7472 695b 7474 2c20 3a5d  _a_x0[tri[tt, :]
+0003a400: 5d20 2a20 6465 745f 6530 5f79 5b64 645d  ] * det_e0_y[dd]
+0003a410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003a420: 2020 2020 202b 2070 5f61 5f78 315b 7472       + p_a_x1[tr
+0003a430: 695b 7474 2c20 3a5d 5d20 2a20 6465 745f  i[tt, :]] * det_
+0003a440: 6531 5f79 5b64 645d 0a20 2020 2020 2020  e1_y[dd].       
+0003a450: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0003a460: 2020 2020 2020 2020 2020 2074 7269 5f7a             tri_z
+0003a470: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+0003a480: 2020 2020 2020 2020 2064 6574 5f63 656e           det_cen
+0003a490: 7473 5f7a 5b64 645d 0a20 2020 2020 2020  ts_z[dd].       
+0003a4a0: 2020 2020 2020 2020 2020 2020 202b 2070               + p
+0003a4b0: 5f61 5f78 305b 7472 695b 7474 2c20 3a5d  _a_x0[tri[tt, :]
+0003a4c0: 5d20 2a20 6465 745f 6530 5f7a 5b64 645d  ] * det_e0_z[dd]
+0003a4d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003a4e0: 2020 2020 202b 2070 5f61 5f78 315b 7472       + p_a_x1[tr
+0003a4f0: 695b 7474 2c20 3a5d 5d20 2a20 6465 745f  i[tt, :]] * det_
+0003a500: 6531 5f7a 5b64 645d 0a20 2020 2020 2020  e1_z[dd].       
+0003a510: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+0003a520: 2020 2020 2020 2020 2020 2020 2320 636f              # co
+0003a530: 6d70 7574 6174 696f 6e20 323a 2073 6f6c  mputation 2: sol
+0003a540: 6964 2061 6e67 6c65 206f 6620 7472 6961  id angle of tria
+0003a550: 6e67 6c65 2066 726f 6d20 7074 730a 2020  ngle from pts.  
+0003a560: 2020 2020 2020 2020 2020 2020 2020 736f                so
+0003a570: 6c69 645f 616e 676c 655b 6464 2c20 7070  lid_angle[dd, pp
+0003a580: 5d20 2b3d 205f 7374 2e63 6f6d 705f 7361  ] += _st.comp_sa
+0003a590: 5f74 7269 280a 2020 2020 2020 2020 2020  _tri(.          
+0003a5a0: 2020 2020 2020 2020 2020 7472 695f 785b            tri_x[
+0003a5b0: 305d 2c0a 2020 2020 2020 2020 2020 2020  0],.            
+0003a5c0: 2020 2020 2020 2020 7472 695f 795b 305d          tri_y[0]
+0003a5d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0003a5e0: 2020 2020 2020 7472 695f 7a5b 305d 2c0a        tri_z[0],.
+0003a5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a600: 2020 2020 7472 695f 785b 315d 2c0a 2020      tri_x[1],.  
+0003a610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a620: 2020 7472 695f 795b 315d 2c0a 2020 2020    tri_y[1],.    
 0003a630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a640: 2020 2070 7473 5f78 5b70 705d 2c0a 2020     pts_x[pp],.  
-0003a650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a660: 2020 7074 735f 795b 7070 5d2c 0a20 2020    pts_y[pp],.   
-0003a670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a680: 2070 7473 5f7a 5b70 705d 2c0a 2020 2020   pts_z[pp],.    
-0003a690: 2020 2020 2020 2020 2020 2020 290a 0a0a              )...
-0003a6a0: 2020 2020 2320 2d2d 2d2d 2d2d 2d0a 2020      # -------.  
-0003a6b0: 2020 2320 5265 7475 726e 0a0a 2020 2020    # Return..    
-0003a6c0: 7265 7475 726e 2073 6f6c 6964 5f61 6e67  return solid_ang
-0003a6d0: 6c65 0a0a 0a64 6566 2063 6f6d 7075 7465  le...def compute
-0003a6e0: 5f73 6f6c 6964 5f61 6e67 6c65 5f61 7065  _solid_angle_ape
-0003a6f0: 7274 7572 6573 5f6c 6967 6874 280a 2020  rtures_light(.  
-0003a700: 2020 2320 7074 733a 2063 6f6f 7264 696e    # pts: coordin
-0003a710: 6174 6573 2061 7320 7468 7265 6520 3164  ates as three 1d
-0003a720: 2061 7272 6179 730a 2020 2020 646f 7562   arrays.    doub
-0003a730: 6c65 5b3a 3a31 5d20 7074 735f 782c 0a20  le[::1] pts_x,. 
-0003a740: 2020 2064 6f75 626c 655b 3a3a 315d 2070     double[::1] p
-0003a750: 7473 5f79 2c0a 2020 2020 646f 7562 6c65  ts_y,.    double
-0003a760: 5b3a 3a31 5d20 7074 735f 7a2c 0a20 2020  [::1] pts_z,.   
-0003a770: 2023 2064 6574 6563 746f 7273 3a20 706f   # detectors: po
-0003a780: 6c79 676f 6e20 636f 6f72 6469 6e61 7465  lygon coordinate
-0003a790: 7320 696e 2032 6420 2863 6f6d 6d6f 6e20  s in 2d (common 
-0003a7a0: 746f 2061 6c6c 2064 6574 6563 746f 7273  to all detectors
-0003a7b0: 290a 2020 2020 646f 7562 6c65 5b3a 3a31  ).    double[::1
-0003a7c0: 5d20 6465 745f 6f75 746c 696e 655f 7830  ] det_outline_x0
-0003a7d0: 2c0a 2020 2020 646f 7562 6c65 5b3a 3a31  ,.    double[::1
-0003a7e0: 5d20 6465 745f 6f75 746c 696e 655f 7831  ] det_outline_x1
-0003a7f0: 2c0a 2020 2020 2320 6465 7465 6374 6f72  ,.    # detector
-0003a800: 733a 2063 656e 7465 7273 2063 6f6f 7264  s: centers coord
-0003a810: 696e 6174 6573 2061 7320 7468 7265 6520  inates as three 
-0003a820: 3164 2061 7272 6179 730a 2020 2020 646f  1d arrays.    do
-0003a830: 7562 6c65 5b3a 3a31 5d20 6465 745f 6365  uble[::1] det_ce
-0003a840: 6e74 735f 782c 0a20 2020 2064 6f75 626c  nts_x,.    doubl
-0003a850: 655b 3a3a 315d 2064 6574 5f63 656e 7473  e[::1] det_cents
-0003a860: 5f79 2c0a 2020 2020 646f 7562 6c65 5b3a  _y,.    double[:
-0003a870: 3a31 5d20 6465 745f 6365 6e74 735f 7a2c  :1] det_cents_z,
-0003a880: 0a20 2020 2023 2064 6574 6563 746f 7273  .    # detectors
-0003a890: 3a20 6e6f 726d 616c 2075 6e69 7420 7665  : normal unit ve
-0003a8a0: 6374 6f72 7320 6173 2074 6872 6565 2031  ctors as three 1
-0003a8b0: 6420 6172 7261 7973 2028 6e64 203d 206c  d arrays (nd = l
-0003a8c0: 656e 2864 6574 5f6e 6f72 6d5f 7829 290a  en(det_norm_x)).
-0003a8d0: 2020 2020 646f 7562 6c65 5b3a 3a31 5d20      double[::1] 
-0003a8e0: 6465 745f 6e6f 726d 5f78 2c0a 2020 2020  det_norm_x,.    
-0003a8f0: 646f 7562 6c65 5b3a 3a31 5d20 6465 745f  double[::1] det_
-0003a900: 6e6f 726d 5f79 2c0a 2020 2020 646f 7562  norm_y,.    doub
-0003a910: 6c65 5b3a 3a31 5d20 6465 745f 6e6f 726d  le[::1] det_norm
-0003a920: 5f7a 2c0a 2020 2020 6e70 2e6e 6461 7272  _z,.    np.ndarr
-0003a930: 6179 5b64 6f75 626c 652c 206e 6469 6d3d  ay[double, ndim=
-0003a940: 315d 2064 6574 5f65 305f 782c 0a20 2020  1] det_e0_x,.   
-0003a950: 206e 702e 6e64 6172 7261 795b 646f 7562   np.ndarray[doub
-0003a960: 6c65 2c20 6e64 696d 3d31 5d20 6465 745f  le, ndim=1] det_
-0003a970: 6530 5f79 2c0a 2020 2020 6e70 2e6e 6461  e0_y,.    np.nda
-0003a980: 7272 6179 5b64 6f75 626c 652c 206e 6469  rray[double, ndi
-0003a990: 6d3d 315d 2064 6574 5f65 305f 7a2c 0a20  m=1] det_e0_z,. 
-0003a9a0: 2020 206e 702e 6e64 6172 7261 795b 646f     np.ndarray[do
-0003a9b0: 7562 6c65 2c20 6e64 696d 3d31 5d20 6465  uble, ndim=1] de
-0003a9c0: 745f 6531 5f78 2c0a 2020 2020 6e70 2e6e  t_e1_x,.    np.n
-0003a9d0: 6461 7272 6179 5b64 6f75 626c 652c 206e  darray[double, n
-0003a9e0: 6469 6d3d 315d 2064 6574 5f65 315f 792c  dim=1] det_e1_y,
-0003a9f0: 0a20 2020 206e 702e 6e64 6172 7261 795b  .    np.ndarray[
-0003aa00: 646f 7562 6c65 2c20 6e64 696d 3d31 5d20  double, ndim=1] 
-0003aa10: 6465 745f 6531 5f7a 2c0a 2020 2020 2320  det_e1_z,.    # 
-0003aa20: 6170 6572 7475 7265 733a 2069 6e64 6963  apertures: indic
-0003aa30: 6573 206f 6620 6669 7273 7420 636f 726e  es of first corn
-0003aa40: 6572 206f 6620 6561 6368 2061 7020 706f  er of each ap po
-0003aa50: 6c79 676f 6e3a 206e 6120 3d20 6c65 6e28  lygon: na = len(
-0003aa60: 6170 5f69 6e64 290a 2020 2020 6c6f 6e67  ap_ind).    long
-0003aa70: 5b3a 3a31 5d20 6170 5f69 6e64 2c0a 2020  [::1] ap_ind,.  
-0003aa80: 2020 2320 6170 6572 7475 7265 733a 2070    # apertures: p
-0003aa90: 6f6c 7967 6f6e 2063 6f6f 7264 696e 6174  olygon coordinat
-0003aaa0: 6573 2061 7320 7468 7265 6520 3164 2061  es as three 1d a
-0003aab0: 7272 6179 730a 2020 2020 6e70 2e6e 6461  rrays.    np.nda
-0003aac0: 7272 6179 5b64 6f75 626c 652c 206e 6469  rray[double, ndi
-0003aad0: 6d3d 315d 2061 705f 782c 0a20 2020 206e  m=1] ap_x,.    n
-0003aae0: 702e 6e64 6172 7261 795b 646f 7562 6c65  p.ndarray[double
-0003aaf0: 2c20 6e64 696d 3d31 5d20 6170 5f79 2c0a  , ndim=1] ap_y,.
-0003ab00: 2020 2020 6e70 2e6e 6461 7272 6179 5b64      np.ndarray[d
-0003ab10: 6f75 626c 652c 206e 6469 6d3d 315d 2061  ouble, ndim=1] a
-0003ab20: 705f 7a2c 0a20 2020 2023 206e 6f72 6d61  p_z,.    # norma
-0003ab30: 6c20 756e 6974 2076 6563 746f 7273 0a20  l unit vectors. 
-0003ab40: 2020 2064 6f75 626c 655b 3a3a 315d 2061     double[::1] a
-0003ab50: 705f 6e6f 726d 5f78 2c0a 2020 2020 646f  p_norm_x,.    do
-0003ab60: 7562 6c65 5b3a 3a31 5d20 6170 5f6e 6f72  uble[::1] ap_nor
-0003ab70: 6d5f 792c 0a20 2020 2064 6f75 626c 655b  m_y,.    double[
-0003ab80: 3a3a 315d 2061 705f 6e6f 726d 5f7a 2c0a  ::1] ap_norm_z,.
-0003ab90: 2020 2020 2320 706f 7373 6962 6c65 2065      # possible e
-0003aba0: 7874 7261 2070 6172 616d 6574 6572 7320  xtra parameters 
-0003abb0: 3f0a 2020 2020 646f 7562 6c65 206d 6172  ?.    double mar
-0003abc0: 6769 6e3d 5f56 534d 414c 4c2c 0a20 2020  gin=_VSMALL,.   
-0003abd0: 2069 6e74 206e 756d 5f74 6872 6561 6473   int num_threads
-0003abe0: 3d31 302c 0a29 3a0a 0a20 2020 2023 202d  =10,.):..    # -
-0003abf0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2023  ----------.    #
-0003ac00: 2044 6563 6c61 7261 7469 6f6e 0a0a 2020   Declaration..  
-0003ac10: 2020 6364 6566 2069 6e74 206e 7074 7320    cdef int npts 
-0003ac20: 3d20 7074 735f 782e 7369 7a65 0a20 2020  = pts_x.size.   
-0003ac30: 2063 6465 6620 696e 7420 6e64 203d 2064   cdef int nd = d
-0003ac40: 6574 5f63 656e 7473 5f78 2e73 697a 650a  et_cents_x.size.
-0003ac50: 2020 2020 6364 6566 2069 6e74 206e 6120      cdef int na 
-0003ac60: 3d20 6170 5f6e 6f72 6d5f 782e 7369 7a65  = ap_norm_x.size
-0003ac70: 0a20 2020 2063 6465 6620 696e 7420 6464  .    cdef int dd
-0003ac80: 2c20 7070 2c20 6161 2c20 7474 0a20 2020  , pp, aa, tt.   
-0003ac90: 2063 6465 6620 696e 7420 6e70 610a 2020   cdef int npa.  
-0003aca0: 2020 6364 6566 2066 6c6f 6174 2073 6361    cdef float sca
-0003acb0: 2c20 7363 6130 2c20 7363 6131 0a20 2020  , sca0, sca1.   
-0003acc0: 2063 6465 6620 666c 6f61 7420 6b69 0a20   cdef float ki. 
-0003acd0: 2020 2063 6465 6620 6e70 2e6e 6461 7272     cdef np.ndarr
-0003ace0: 6179 5b64 6f75 626c 652c 206e 6469 6d3d  ay[double, ndim=
-0003acf0: 315d 2061 705f 7830 203d 206e 702e 636f  1] ap_x0 = np.co
-0003ad00: 7079 2861 705f 7829 0a20 2020 2063 6465  py(ap_x).    cde
-0003ad10: 6620 6e70 2e6e 6461 7272 6179 5b64 6f75  f np.ndarray[dou
-0003ad20: 626c 652c 206e 6469 6d3d 315d 2061 705f  ble, ndim=1] ap_
-0003ad30: 7831 203d 206e 702e 636f 7079 2861 705f  x1 = np.copy(ap_
-0003ad40: 7829 0a20 2020 2063 6465 6620 6e70 2e6e  x).    cdef np.n
-0003ad50: 6461 7272 6179 5b64 6f75 626c 652c 206e  darray[double, n
-0003ad60: 6469 6d3d 315d 2070 5f61 5f78 300a 2020  dim=1] p_a_x0.  
-0003ad70: 2020 6364 6566 206e 702e 6e64 6172 7261    cdef np.ndarra
-0003ad80: 795b 646f 7562 6c65 2c20 6e64 696d 3d31  y[double, ndim=1
-0003ad90: 5d20 705f 615f 7831 0a20 2020 2063 6465  ] p_a_x1.    cde
-0003ada0: 6620 6e70 2e6e 6461 7272 6179 5b6c 6f6e  f np.ndarray[lon
-0003adb0: 672c 206e 6469 6d3d 325d 2074 7269 0a20  g, ndim=2] tri. 
-0003adc0: 2020 2063 6465 6620 6e70 2e6e 6461 7272     cdef np.ndarr
-0003add0: 6179 5b64 6f75 626c 652c 206e 6469 6d3d  ay[double, ndim=
-0003ade0: 315d 2074 7269 5f78 0a20 2020 2063 6465  1] tri_x.    cde
-0003adf0: 6620 6e70 2e6e 6461 7272 6179 5b64 6f75  f np.ndarray[dou
-0003ae00: 626c 652c 206e 6469 6d3d 315d 2074 7269  ble, ndim=1] tri
-0003ae10: 5f79 0a20 2020 2063 6465 6620 6e70 2e6e  _y.    cdef np.n
-0003ae20: 6461 7272 6179 5b64 6f75 626c 652c 206e  darray[double, n
-0003ae30: 6469 6d3d 315d 2074 7269 5f7a 0a0a 2020  dim=1] tri_z..  
-0003ae40: 2020 2320 696e 6974 6961 6c69 7a65 2073    # initialize s
-0003ae50: 6f6c 6964 2061 6e67 6c65 2061 7272 6179  olid angle array
-0003ae60: 2077 6974 6820 7a65 726f 730a 2020 2020   with zeros.    
-0003ae70: 6364 6566 206e 702e 6e64 6172 7261 795b  cdef np.ndarray[
-0003ae80: 646f 7562 6c65 2c20 6e64 696d 3d32 5d20  double, ndim=2] 
-0003ae90: 736f 6c69 645f 616e 676c 6520 3d20 6e70  solid_angle = np
-0003aea0: 2e7a 6572 6f73 2828 6e64 2c20 6e70 7473  .zeros((nd, npts
-0003aeb0: 292c 2064 7479 7065 3d66 6c6f 6174 290a  ), dtype=float).
-0003aec0: 0a20 2020 2023 202d 2d2d 2d2d 2d2d 0a20  .    # -------. 
-0003aed0: 2020 2023 2043 6f6d 7075 7465 0a0a 2020     # Compute..  
-0003aee0: 2020 666f 7220 6464 2069 6e20 7261 6e67    for dd in rang
-0003aef0: 6528 6e64 293a 0a0a 2020 2020 2020 2020  e(nd):..        
-0003af00: 2320 7072 696e 7428 2764 6574 5f63 656e  # print('det_cen
-0003af10: 7427 2c20 6465 745f 6365 6e74 735f 785b  t', det_cents_x[
-0003af20: 6464 5d2c 2064 6574 5f63 656e 7473 5f79  dd], det_cents_y
-0003af30: 5b64 645d 2c20 6465 745f 6365 6e74 735f  [dd], det_cents_
-0003af40: 7a5b 6464 5d29 0a20 2020 2020 2020 2023  z[dd]).        #
-0003af50: 2070 7269 6e74 2827 6465 745f 6e69 6e27   print('det_nin'
-0003af60: 2c20 6465 745f 6e6f 726d 5f78 5b64 645d  , det_norm_x[dd]
-0003af70: 2c20 6465 745f 6e6f 726d 5f79 5b64 645d  , det_norm_y[dd]
-0003af80: 2c20 6465 745f 6e6f 726d 5f7a 5b64 645d  , det_norm_z[dd]
-0003af90: 2920 2020 2020 2020 2023 2044 420a 2020  )        # DB.  
-0003afa0: 2020 2020 2020 2320 7072 696e 7428 2764        # print('d
-0003afb0: 6574 5f65 3027 2c20 6465 745f 6530 5f78  et_e0', det_e0_x
-0003afc0: 5b64 645d 2c20 6465 745f 6530 5f79 5b64  [dd], det_e0_y[d
-0003afd0: 645d 2c20 6465 745f 6530 5f7a 5b64 645d  d], det_e0_z[dd]
-0003afe0: 2920 2020 2020 2020 2023 2044 420a 2020  )        # DB.  
-0003aff0: 2020 2020 2020 2320 7072 696e 7428 2764        # print('d
-0003b000: 6574 5f65 3127 2c20 6465 745f 6531 5f78  et_e1', det_e1_x
-0003b010: 5b64 645d 2c20 6465 745f 6531 5f79 5b64  [dd], det_e1_y[d
-0003b020: 645d 2c20 6465 745f 6531 5f7a 5b64 645d  d], det_e1_z[dd]
-0003b030: 2920 2020 2020 2020 2023 2044 420a 0a20  )        # DB.. 
-0003b040: 2020 2020 2020 2023 206c 6f6f 7020 323a         # loop 2:
-0003b050: 206f 6e20 6e70 7473 2028 6f62 7365 7276   on npts (observ
-0003b060: 6174 696f 6e20 706f 696e 7473 290a 2020  ation points).  
-0003b070: 2020 2020 2020 666f 7220 7070 2069 6e20        for pp in 
-0003b080: 7261 6e67 6528 6e70 7473 293a 0a0a 2020  range(npts):..  
-0003b090: 2020 2020 2020 2020 2020 2320 7072 696e            # prin
-0003b0a0: 7428 2770 7473 272c 2070 702c 2070 7473  t('pts', pp, pts
-0003b0b0: 5f78 5b70 705d 2c20 7074 735f 795b 7070  _x[pp], pts_y[pp
-0003b0c0: 5d2c 2070 7473 5f7a 5b70 705d 2920 2020  ], pts_z[pp])   
-0003b0d0: 2020 2020 2023 2044 420a 0a20 2020 2020       # DB..     
-0003b0e0: 2020 2020 2020 2023 2074 6573 7420 6966         # test if
-0003b0f0: 206f 6e20 676f 6f64 2073 6964 6520 6f66   on good side of
-0003b100: 2064 6574 6563 746f 720a 2020 2020 2020   detector.      
-0003b110: 2020 2020 2020 7363 6130 203d 2028 0a20        sca0 = (. 
-0003b120: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-0003b130: 7074 735f 785b 7070 5d20 2d20 6465 745f  pts_x[pp] - det_
-0003b140: 6365 6e74 735f 785b 6464 5d29 202a 2064  cents_x[dd]) * d
-0003b150: 6574 5f6e 6f72 6d5f 785b 6464 5d0a 2020  et_norm_x[dd].  
-0003b160: 2020 2020 2020 2020 2020 2020 2020 2b20                + 
-0003b170: 2870 7473 5f79 5b70 705d 202d 2064 6574  (pts_y[pp] - det
-0003b180: 5f63 656e 7473 5f79 5b64 645d 2920 2a20  _cents_y[dd]) * 
-0003b190: 6465 745f 6e6f 726d 5f79 5b64 645d 0a20  det_norm_y[dd]. 
-0003b1a0: 2020 2020 2020 2020 2020 2020 2020 202b                 +
-0003b1b0: 2028 7074 735f 7a5b 7070 5d20 2d20 6465   (pts_z[pp] - de
-0003b1c0: 745f 6365 6e74 735f 7a5b 6464 5d29 202a  t_cents_z[dd]) *
-0003b1d0: 2064 6574 5f6e 6f72 6d5f 7a5b 6464 5d0a   det_norm_z[dd].
-0003b1e0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-0003b1f0: 2020 2020 2020 2020 2020 2069 6620 7363             if sc
-0003b200: 6130 203c 3d20 303a 0a20 2020 2020 2020  a0 <= 0:.       
-0003b210: 2020 2020 2020 2020 2023 2070 7269 6e74           # print
-0003b220: 2827 736b 6970 272c 2073 6361 3029 2020  ('skip', sca0)  
-0003b230: 2020 2020 2020 2320 4442 0a20 2020 2020        # DB.     
-0003b240: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-0003b250: 6e75 650a 0a20 2020 2020 2020 2020 2020  nue..           
-0003b260: 2023 2066 6c61 670a 2020 2020 2020 2020   # flag.        
-0003b270: 2020 2020 6973 6f6b 203d 2054 7275 650a      isok = True.
-0003b280: 0a20 2020 2020 2020 2020 2020 2023 206c  .            # l
-0003b290: 6f6f 7020 333a 206f 6e20 6e61 2028 6170  oop 3: on na (ap
-0003b2a0: 6572 7475 7265 7329 0a20 2020 2020 2020  ertures).       
-0003b2b0: 2020 2020 2066 6f72 2061 6120 696e 2072       for aa in r
-0003b2c0: 616e 6765 286e 6129 3a0a 0a20 2020 2020  ange(na):..     
-0003b2d0: 2020 2020 2020 2020 2020 2023 2070 7269             # pri
-0003b2e0: 6e74 2827 6170 272c 2061 6129 0a20 2020  nt('ap', aa).   
-0003b2f0: 2020 2020 2020 2020 2020 2020 2023 2070               # p
-0003b300: 7269 6e74 2827 6170 2069 6e64 272c 2061  rint('ap ind', a
-0003b310: 705f 696e 645b 6161 5d2c 2061 705f 696e  p_ind[aa], ap_in
-0003b320: 645b 6161 2b31 5d29 0a20 2020 2020 2020  d[aa+1]).       
-0003b330: 2020 2020 2020 2020 2023 2070 7269 6e74           # print
-0003b340: 2827 6170 206e 696e 272c 2061 705f 6e6f  ('ap nin', ap_no
-0003b350: 726d 5f78 5b61 615d 2c20 6170 5f6e 6f72  rm_x[aa], ap_nor
-0003b360: 6d5f 795b 6161 5d2c 2061 705f 6e6f 726d  m_y[aa], ap_norm
-0003b370: 5f7a 5b61 615d 290a 2020 2020 2020 2020  _z[aa]).        
-0003b380: 2020 2020 2020 2020 2320 7072 696e 7428          # print(
-0003b390: 2761 705f 7827 2c20 6170 5f78 5b61 705f  'ap_x', ap_x[ap_
-0003b3a0: 696e 645b 6161 5d3a 6170 5f69 6e64 5b61  ind[aa]:ap_ind[a
-0003b3b0: 612b 315d 5d29 0a20 2020 2020 2020 2020  a+1]]).         
-0003b3c0: 2020 2020 2020 2023 2070 7269 6e74 2827         # print('
-0003b3d0: 6170 5f79 272c 2061 705f 795b 6170 5f69  ap_y', ap_y[ap_i
-0003b3e0: 6e64 5b61 615d 3a61 705f 696e 645b 6161  nd[aa]:ap_ind[aa
-0003b3f0: 2b31 5d5d 290a 2020 2020 2020 2020 2020  +1]]).          
-0003b400: 2020 2020 2020 2320 7072 696e 7428 2761        # print('a
-0003b410: 705f 7a27 2c20 6170 5f7a 5b61 705f 696e  p_z', ap_z[ap_in
-0003b420: 645b 6161 5d3a 6170 5f69 6e64 5b61 612b  d[aa]:ap_ind[aa+
-0003b430: 315d 5d29 0a0a 2020 2020 2020 2020 2020  1]])..          
-0003b440: 2020 2020 2020 2320 7465 7374 2069 6620        # test if 
-0003b450: 6f6e 2067 6f6f 6420 7369 6465 206f 6620  on good side of 
-0003b460: 6170 6572 7475 7265 0a20 2020 2020 2020  aperture.       
-0003b470: 2020 2020 2020 2020 2073 6361 203d 2028           sca = (
-0003b480: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003b490: 2020 2020 2028 7074 735f 785b 7070 5d20       (pts_x[pp] 
-0003b4a0: 2d20 6170 5f78 5b61 705f 696e 645b 6161  - ap_x[ap_ind[aa
-0003b4b0: 5d5d 2920 2a20 6170 5f6e 6f72 6d5f 785b  ]]) * ap_norm_x[
-0003b4c0: 6161 5d0a 2020 2020 2020 2020 2020 2020  aa].            
-0003b4d0: 2020 2020 2020 2020 2b20 2870 7473 5f79          + (pts_y
-0003b4e0: 5b70 705d 202d 2061 705f 795b 6170 5f69  [pp] - ap_y[ap_i
-0003b4f0: 6e64 5b61 615d 5d29 202a 2061 705f 6e6f  nd[aa]]) * ap_no
-0003b500: 726d 5f79 5b61 615d 0a20 2020 2020 2020  rm_y[aa].       
-0003b510: 2020 2020 2020 2020 2020 2020 202b 2028               + (
-0003b520: 7074 735f 7a5b 7070 5d20 2d20 6170 5f7a  pts_z[pp] - ap_z
-0003b530: 5b61 705f 696e 645b 6161 5d5d 2920 2a20  [ap_ind[aa]]) * 
-0003b540: 6170 5f6e 6f72 6d5f 7a5b 6161 5d0a 2020  ap_norm_z[aa].  
-0003b550: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0003b560: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003b570: 2069 6620 7363 6120 3c3d 2030 3a0a 2020   if sca <= 0:.  
+0003a640: 7472 695f 7a5b 315d 2c0a 2020 2020 2020  tri_z[1],.      
+0003a650: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+0003a660: 695f 785b 325d 2c0a 2020 2020 2020 2020  i_x[2],.        
+0003a670: 2020 2020 2020 2020 2020 2020 7472 695f              tri_
+0003a680: 795b 325d 2c0a 2020 2020 2020 2020 2020  y[2],.          
+0003a690: 2020 2020 2020 2020 2020 7472 695f 7a5b            tri_z[
+0003a6a0: 325d 2c0a 2020 2020 2020 2020 2020 2020  2],.            
+0003a6b0: 2020 2020 2020 2020 7074 735f 785b 7070          pts_x[pp
+0003a6c0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+0003a6d0: 2020 2020 2020 2070 7473 5f79 5b70 705d         pts_y[pp]
+0003a6e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0003a6f0: 2020 2020 2020 7074 735f 7a5b 7070 5d2c        pts_z[pp],
+0003a700: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003a710: 2029 0a0a 0a20 2020 2023 202d 2d2d 2d2d   )...    # -----
+0003a720: 2d2d 0a20 2020 2023 2052 6574 7572 6e0a  --.    # Return.
+0003a730: 0a20 2020 2072 6574 7572 6e20 736f 6c69  .    return soli
+0003a740: 645f 616e 676c 650a 0a0a 6465 6620 636f  d_angle...def co
+0003a750: 6d70 7574 655f 736f 6c69 645f 616e 676c  mpute_solid_angl
+0003a760: 655f 6170 6572 7475 7265 735f 6c69 6768  e_apertures_ligh
+0003a770: 7428 0a20 2020 2023 2070 7473 3a20 636f  t(.    # pts: co
+0003a780: 6f72 6469 6e61 7465 7320 6173 2074 6872  ordinates as thr
+0003a790: 6565 2031 6420 6172 7261 7973 0a20 2020  ee 1d arrays.   
+0003a7a0: 2064 6f75 626c 655b 3a3a 315d 2070 7473   double[::1] pts
+0003a7b0: 5f78 2c0a 2020 2020 646f 7562 6c65 5b3a  _x,.    double[:
+0003a7c0: 3a31 5d20 7074 735f 792c 0a20 2020 2064  :1] pts_y,.    d
+0003a7d0: 6f75 626c 655b 3a3a 315d 2070 7473 5f7a  ouble[::1] pts_z
+0003a7e0: 2c0a 2020 2020 2320 6465 7465 6374 6f72  ,.    # detector
+0003a7f0: 733a 2070 6f6c 7967 6f6e 2063 6f6f 7264  s: polygon coord
+0003a800: 696e 6174 6573 2069 6e20 3264 2028 636f  inates in 2d (co
+0003a810: 6d6d 6f6e 2074 6f20 616c 6c20 6465 7465  mmon to all dete
+0003a820: 6374 6f72 7329 0a20 2020 2064 6f75 626c  ctors).    doubl
+0003a830: 655b 3a3a 315d 2064 6574 5f6f 7574 6c69  e[::1] det_outli
+0003a840: 6e65 5f78 302c 0a20 2020 2064 6f75 626c  ne_x0,.    doubl
+0003a850: 655b 3a3a 315d 2064 6574 5f6f 7574 6c69  e[::1] det_outli
+0003a860: 6e65 5f78 312c 0a20 2020 2023 2064 6574  ne_x1,.    # det
+0003a870: 6563 746f 7273 3a20 6365 6e74 6572 7320  ectors: centers 
+0003a880: 636f 6f72 6469 6e61 7465 7320 6173 2074  coordinates as t
+0003a890: 6872 6565 2031 6420 6172 7261 7973 0a20  hree 1d arrays. 
+0003a8a0: 2020 2064 6f75 626c 655b 3a3a 315d 2064     double[::1] d
+0003a8b0: 6574 5f63 656e 7473 5f78 2c0a 2020 2020  et_cents_x,.    
+0003a8c0: 646f 7562 6c65 5b3a 3a31 5d20 6465 745f  double[::1] det_
+0003a8d0: 6365 6e74 735f 792c 0a20 2020 2064 6f75  cents_y,.    dou
+0003a8e0: 626c 655b 3a3a 315d 2064 6574 5f63 656e  ble[::1] det_cen
+0003a8f0: 7473 5f7a 2c0a 2020 2020 2320 6465 7465  ts_z,.    # dete
+0003a900: 6374 6f72 733a 206e 6f72 6d61 6c20 756e  ctors: normal un
+0003a910: 6974 2076 6563 746f 7273 2061 7320 7468  it vectors as th
+0003a920: 7265 6520 3164 2061 7272 6179 7320 286e  ree 1d arrays (n
+0003a930: 6420 3d20 6c65 6e28 6465 745f 6e6f 726d  d = len(det_norm
+0003a940: 5f78 2929 0a20 2020 2064 6f75 626c 655b  _x)).    double[
+0003a950: 3a3a 315d 2064 6574 5f6e 6f72 6d5f 782c  ::1] det_norm_x,
+0003a960: 0a20 2020 2064 6f75 626c 655b 3a3a 315d  .    double[::1]
+0003a970: 2064 6574 5f6e 6f72 6d5f 792c 0a20 2020   det_norm_y,.   
+0003a980: 2064 6f75 626c 655b 3a3a 315d 2064 6574   double[::1] det
+0003a990: 5f6e 6f72 6d5f 7a2c 0a20 2020 206e 702e  _norm_z,.    np.
+0003a9a0: 6e64 6172 7261 795b 646f 7562 6c65 2c20  ndarray[double, 
+0003a9b0: 6e64 696d 3d31 5d20 6465 745f 6530 5f78  ndim=1] det_e0_x
+0003a9c0: 2c0a 2020 2020 6e70 2e6e 6461 7272 6179  ,.    np.ndarray
+0003a9d0: 5b64 6f75 626c 652c 206e 6469 6d3d 315d  [double, ndim=1]
+0003a9e0: 2064 6574 5f65 305f 792c 0a20 2020 206e   det_e0_y,.    n
+0003a9f0: 702e 6e64 6172 7261 795b 646f 7562 6c65  p.ndarray[double
+0003aa00: 2c20 6e64 696d 3d31 5d20 6465 745f 6530  , ndim=1] det_e0
+0003aa10: 5f7a 2c0a 2020 2020 6e70 2e6e 6461 7272  _z,.    np.ndarr
+0003aa20: 6179 5b64 6f75 626c 652c 206e 6469 6d3d  ay[double, ndim=
+0003aa30: 315d 2064 6574 5f65 315f 782c 0a20 2020  1] det_e1_x,.   
+0003aa40: 206e 702e 6e64 6172 7261 795b 646f 7562   np.ndarray[doub
+0003aa50: 6c65 2c20 6e64 696d 3d31 5d20 6465 745f  le, ndim=1] det_
+0003aa60: 6531 5f79 2c0a 2020 2020 6e70 2e6e 6461  e1_y,.    np.nda
+0003aa70: 7272 6179 5b64 6f75 626c 652c 206e 6469  rray[double, ndi
+0003aa80: 6d3d 315d 2064 6574 5f65 315f 7a2c 0a20  m=1] det_e1_z,. 
+0003aa90: 2020 2023 2061 7065 7274 7572 6573 3a20     # apertures: 
+0003aaa0: 696e 6469 6365 7320 6f66 2066 6972 7374  indices of first
+0003aab0: 2063 6f72 6e65 7220 6f66 2065 6163 6820   corner of each 
+0003aac0: 6170 2070 6f6c 7967 6f6e 3a20 6e61 203d  ap polygon: na =
+0003aad0: 206c 656e 2861 705f 696e 6429 0a20 2020   len(ap_ind).   
+0003aae0: 206c 6f6e 675b 3a3a 315d 2061 705f 696e   long[::1] ap_in
+0003aaf0: 642c 0a20 2020 2023 2061 7065 7274 7572  d,.    # apertur
+0003ab00: 6573 3a20 706f 6c79 676f 6e20 636f 6f72  es: polygon coor
+0003ab10: 6469 6e61 7465 7320 6173 2074 6872 6565  dinates as three
+0003ab20: 2031 6420 6172 7261 7973 0a20 2020 206e   1d arrays.    n
+0003ab30: 702e 6e64 6172 7261 795b 646f 7562 6c65  p.ndarray[double
+0003ab40: 2c20 6e64 696d 3d31 5d20 6170 5f78 2c0a  , ndim=1] ap_x,.
+0003ab50: 2020 2020 6e70 2e6e 6461 7272 6179 5b64      np.ndarray[d
+0003ab60: 6f75 626c 652c 206e 6469 6d3d 315d 2061  ouble, ndim=1] a
+0003ab70: 705f 792c 0a20 2020 206e 702e 6e64 6172  p_y,.    np.ndar
+0003ab80: 7261 795b 646f 7562 6c65 2c20 6e64 696d  ray[double, ndim
+0003ab90: 3d31 5d20 6170 5f7a 2c0a 2020 2020 2320  =1] ap_z,.    # 
+0003aba0: 6e6f 726d 616c 2075 6e69 7420 7665 6374  normal unit vect
+0003abb0: 6f72 730a 2020 2020 646f 7562 6c65 5b3a  ors.    double[:
+0003abc0: 3a31 5d20 6170 5f6e 6f72 6d5f 782c 0a20  :1] ap_norm_x,. 
+0003abd0: 2020 2064 6f75 626c 655b 3a3a 315d 2061     double[::1] a
+0003abe0: 705f 6e6f 726d 5f79 2c0a 2020 2020 646f  p_norm_y,.    do
+0003abf0: 7562 6c65 5b3a 3a31 5d20 6170 5f6e 6f72  uble[::1] ap_nor
+0003ac00: 6d5f 7a2c 0a20 2020 2023 2070 6f73 7369  m_z,.    # possi
+0003ac10: 626c 6520 6578 7472 6120 7061 7261 6d65  ble extra parame
+0003ac20: 7465 7273 203f 0a20 2020 2064 6f75 626c  ters ?.    doubl
+0003ac30: 6520 6d61 7267 696e 3d5f 5653 4d41 4c4c  e margin=_VSMALL
+0003ac40: 2c0a 2020 2020 696e 7420 6e75 6d5f 7468  ,.    int num_th
+0003ac50: 7265 6164 733d 3130 2c0a 293a 0a0a 2020  reads=10,.):..  
+0003ac60: 2020 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a    # -----------.
+0003ac70: 2020 2020 2320 4465 636c 6172 6174 696f      # Declaratio
+0003ac80: 6e0a 0a20 2020 2063 6465 6620 696e 7420  n..    cdef int 
+0003ac90: 6e70 7473 203d 2070 7473 5f78 2e73 697a  npts = pts_x.siz
+0003aca0: 650a 2020 2020 6364 6566 2069 6e74 206e  e.    cdef int n
+0003acb0: 6420 3d20 6465 745f 6365 6e74 735f 782e  d = det_cents_x.
+0003acc0: 7369 7a65 0a20 2020 2063 6465 6620 696e  size.    cdef in
+0003acd0: 7420 6e61 203d 2061 705f 6e6f 726d 5f78  t na = ap_norm_x
+0003ace0: 2e73 697a 650a 2020 2020 6364 6566 2069  .size.    cdef i
+0003acf0: 6e74 2064 642c 2070 702c 2061 612c 2074  nt dd, pp, aa, t
+0003ad00: 740a 2020 2020 6364 6566 2069 6e74 206e  t.    cdef int n
+0003ad10: 7061 0a20 2020 2063 6465 6620 666c 6f61  pa.    cdef floa
+0003ad20: 7420 7363 612c 2073 6361 302c 2073 6361  t sca, sca0, sca
+0003ad30: 310a 2020 2020 6364 6566 2066 6c6f 6174  1.    cdef float
+0003ad40: 206b 690a 2020 2020 6364 6566 206e 702e   ki.    cdef np.
+0003ad50: 6e64 6172 7261 795b 646f 7562 6c65 2c20  ndarray[double, 
+0003ad60: 6e64 696d 3d31 5d20 6170 5f78 3020 3d20  ndim=1] ap_x0 = 
+0003ad70: 6e70 2e63 6f70 7928 6170 5f78 290a 2020  np.copy(ap_x).  
+0003ad80: 2020 6364 6566 206e 702e 6e64 6172 7261    cdef np.ndarra
+0003ad90: 795b 646f 7562 6c65 2c20 6e64 696d 3d31  y[double, ndim=1
+0003ada0: 5d20 6170 5f78 3120 3d20 6e70 2e63 6f70  ] ap_x1 = np.cop
+0003adb0: 7928 6170 5f78 290a 2020 2020 6364 6566  y(ap_x).    cdef
+0003adc0: 206e 702e 6e64 6172 7261 795b 646f 7562   np.ndarray[doub
+0003add0: 6c65 2c20 6e64 696d 3d31 5d20 705f 615f  le, ndim=1] p_a_
+0003ade0: 7830 0a20 2020 2063 6465 6620 6e70 2e6e  x0.    cdef np.n
+0003adf0: 6461 7272 6179 5b64 6f75 626c 652c 206e  darray[double, n
+0003ae00: 6469 6d3d 315d 2070 5f61 5f78 310a 2020  dim=1] p_a_x1.  
+0003ae10: 2020 6364 6566 206e 702e 6e64 6172 7261    cdef np.ndarra
+0003ae20: 795b 6c6f 6e67 2c20 6e64 696d 3d32 5d20  y[long, ndim=2] 
+0003ae30: 7472 690a 2020 2020 6364 6566 206e 702e  tri.    cdef np.
+0003ae40: 6e64 6172 7261 795b 646f 7562 6c65 2c20  ndarray[double, 
+0003ae50: 6e64 696d 3d31 5d20 7472 695f 780a 2020  ndim=1] tri_x.  
+0003ae60: 2020 6364 6566 206e 702e 6e64 6172 7261    cdef np.ndarra
+0003ae70: 795b 646f 7562 6c65 2c20 6e64 696d 3d31  y[double, ndim=1
+0003ae80: 5d20 7472 695f 790a 2020 2020 6364 6566  ] tri_y.    cdef
+0003ae90: 206e 702e 6e64 6172 7261 795b 646f 7562   np.ndarray[doub
+0003aea0: 6c65 2c20 6e64 696d 3d31 5d20 7472 695f  le, ndim=1] tri_
+0003aeb0: 7a0a 0a20 2020 2023 2069 6e69 7469 616c  z..    # initial
+0003aec0: 697a 6520 736f 6c69 6420 616e 676c 6520  ize solid angle 
+0003aed0: 6172 7261 7920 7769 7468 207a 6572 6f73  array with zeros
+0003aee0: 0a20 2020 2063 6465 6620 6e70 2e6e 6461  .    cdef np.nda
+0003aef0: 7272 6179 5b64 6f75 626c 652c 206e 6469  rray[double, ndi
+0003af00: 6d3d 325d 2073 6f6c 6964 5f61 6e67 6c65  m=2] solid_angle
+0003af10: 203d 206e 702e 7a65 726f 7328 286e 642c   = np.zeros((nd,
+0003af20: 206e 7074 7329 2c20 6474 7970 653d 666c   npts), dtype=fl
+0003af30: 6f61 7429 0a0a 2020 2020 2320 2d2d 2d2d  oat)..    # ----
+0003af40: 2d2d 2d0a 2020 2020 2320 436f 6d70 7574  ---.    # Comput
+0003af50: 650a 0a20 2020 2066 6f72 2064 6420 696e  e..    for dd in
+0003af60: 2072 616e 6765 286e 6429 3a0a 0a20 2020   range(nd):..   
+0003af70: 2020 2020 2023 2070 7269 6e74 2827 6465       # print('de
+0003af80: 745f 6365 6e74 272c 2064 6574 5f63 656e  t_cent', det_cen
+0003af90: 7473 5f78 5b64 645d 2c20 6465 745f 6365  ts_x[dd], det_ce
+0003afa0: 6e74 735f 795b 6464 5d2c 2064 6574 5f63  nts_y[dd], det_c
+0003afb0: 656e 7473 5f7a 5b64 645d 290a 2020 2020  ents_z[dd]).    
+0003afc0: 2020 2020 2320 7072 696e 7428 2764 6574      # print('det
+0003afd0: 5f6e 696e 272c 2064 6574 5f6e 6f72 6d5f  _nin', det_norm_
+0003afe0: 785b 6464 5d2c 2064 6574 5f6e 6f72 6d5f  x[dd], det_norm_
+0003aff0: 795b 6464 5d2c 2064 6574 5f6e 6f72 6d5f  y[dd], det_norm_
+0003b000: 7a5b 6464 5d29 2020 2020 2020 2020 2320  z[dd])        # 
+0003b010: 4442 0a20 2020 2020 2020 2023 2070 7269  DB.        # pri
+0003b020: 6e74 2827 6465 745f 6530 272c 2064 6574  nt('det_e0', det
+0003b030: 5f65 305f 785b 6464 5d2c 2064 6574 5f65  _e0_x[dd], det_e
+0003b040: 305f 795b 6464 5d2c 2064 6574 5f65 305f  0_y[dd], det_e0_
+0003b050: 7a5b 6464 5d29 2020 2020 2020 2020 2320  z[dd])        # 
+0003b060: 4442 0a20 2020 2020 2020 2023 2070 7269  DB.        # pri
+0003b070: 6e74 2827 6465 745f 6531 272c 2064 6574  nt('det_e1', det
+0003b080: 5f65 315f 785b 6464 5d2c 2064 6574 5f65  _e1_x[dd], det_e
+0003b090: 315f 795b 6464 5d2c 2064 6574 5f65 315f  1_y[dd], det_e1_
+0003b0a0: 7a5b 6464 5d29 2020 2020 2020 2020 2320  z[dd])        # 
+0003b0b0: 4442 0a0a 2020 2020 2020 2020 2320 6c6f  DB..        # lo
+0003b0c0: 6f70 2032 3a20 6f6e 206e 7074 7320 286f  op 2: on npts (o
+0003b0d0: 6273 6572 7661 7469 6f6e 2070 6f69 6e74  bservation point
+0003b0e0: 7329 0a20 2020 2020 2020 2066 6f72 2070  s).        for p
+0003b0f0: 7020 696e 2072 616e 6765 286e 7074 7329  p in range(npts)
+0003b100: 3a0a 0a20 2020 2020 2020 2020 2020 2023  :..            #
+0003b110: 2070 7269 6e74 2827 7074 7327 2c20 7070   print('pts', pp
+0003b120: 2c20 7074 735f 785b 7070 5d2c 2070 7473  , pts_x[pp], pts
+0003b130: 5f79 5b70 705d 2c20 7074 735f 7a5b 7070  _y[pp], pts_z[pp
+0003b140: 5d29 2020 2020 2020 2020 2320 4442 0a0a  ])        # DB..
+0003b150: 2020 2020 2020 2020 2020 2020 2320 7465              # te
+0003b160: 7374 2069 6620 6f6e 2067 6f6f 6420 7369  st if on good si
+0003b170: 6465 206f 6620 6465 7465 6374 6f72 0a20  de of detector. 
+0003b180: 2020 2020 2020 2020 2020 2073 6361 3020             sca0 
+0003b190: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+0003b1a0: 2020 2020 2870 7473 5f78 5b70 705d 202d      (pts_x[pp] -
+0003b1b0: 2064 6574 5f63 656e 7473 5f78 5b64 645d   det_cents_x[dd]
+0003b1c0: 2920 2a20 6465 745f 6e6f 726d 5f78 5b64  ) * det_norm_x[d
+0003b1d0: 645d 0a20 2020 2020 2020 2020 2020 2020  d].             
+0003b1e0: 2020 202b 2028 7074 735f 795b 7070 5d20     + (pts_y[pp] 
+0003b1f0: 2d20 6465 745f 6365 6e74 735f 795b 6464  - det_cents_y[dd
+0003b200: 5d29 202a 2064 6574 5f6e 6f72 6d5f 795b  ]) * det_norm_y[
+0003b210: 6464 5d0a 2020 2020 2020 2020 2020 2020  dd].            
+0003b220: 2020 2020 2b20 2870 7473 5f7a 5b70 705d      + (pts_z[pp]
+0003b230: 202d 2064 6574 5f63 656e 7473 5f7a 5b64   - det_cents_z[d
+0003b240: 645d 2920 2a20 6465 745f 6e6f 726d 5f7a  d]) * det_norm_z
+0003b250: 5b64 645d 0a20 2020 2020 2020 2020 2020  [dd].           
+0003b260: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
+0003b270: 6966 2073 6361 3020 3c3d 2030 3a0a 2020  if sca0 <= 0:.  
+0003b280: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0003b290: 7072 696e 7428 2773 6b69 7027 2c20 7363  print('skip', sc
+0003b2a0: 6130 2920 2020 2020 2020 2023 2044 420a  a0)        # DB.
+0003b2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b2c0: 636f 6e74 696e 7565 0a0a 2020 2020 2020  continue..      
+0003b2d0: 2020 2020 2020 2320 666c 6167 0a20 2020        # flag.   
+0003b2e0: 2020 2020 2020 2020 2069 736f 6b20 3d20           isok = 
+0003b2f0: 5472 7565 0a0a 2020 2020 2020 2020 2020  True..          
+0003b300: 2020 2320 6c6f 6f70 2033 3a20 6f6e 206e    # loop 3: on n
+0003b310: 6120 2861 7065 7274 7572 6573 290a 2020  a (apertures).  
+0003b320: 2020 2020 2020 2020 2020 666f 7220 6161            for aa
+0003b330: 2069 6e20 7261 6e67 6528 6e61 293a 0a0a   in range(na):..
+0003b340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b350: 2320 7072 696e 7428 2761 7027 2c20 6161  # print('ap', aa
+0003b360: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0003b370: 2020 2320 7072 696e 7428 2761 7020 696e    # print('ap in
+0003b380: 6427 2c20 6170 5f69 6e64 5b61 615d 2c20  d', ap_ind[aa], 
+0003b390: 6170 5f69 6e64 5b61 612b 315d 290a 2020  ap_ind[aa+1]).  
+0003b3a0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0003b3b0: 7072 696e 7428 2761 7020 6e69 6e27 2c20  print('ap nin', 
+0003b3c0: 6170 5f6e 6f72 6d5f 785b 6161 5d2c 2061  ap_norm_x[aa], a
+0003b3d0: 705f 6e6f 726d 5f79 5b61 615d 2c20 6170  p_norm_y[aa], ap
+0003b3e0: 5f6e 6f72 6d5f 7a5b 6161 5d29 0a20 2020  _norm_z[aa]).   
+0003b3f0: 2020 2020 2020 2020 2020 2020 2023 2070               # p
+0003b400: 7269 6e74 2827 6170 5f78 272c 2061 705f  rint('ap_x', ap_
+0003b410: 785b 6170 5f69 6e64 5b61 615d 3a61 705f  x[ap_ind[aa]:ap_
+0003b420: 696e 645b 6161 2b31 5d5d 290a 2020 2020  ind[aa+1]]).    
+0003b430: 2020 2020 2020 2020 2020 2020 2320 7072              # pr
+0003b440: 696e 7428 2761 705f 7927 2c20 6170 5f79  int('ap_y', ap_y
+0003b450: 5b61 705f 696e 645b 6161 5d3a 6170 5f69  [ap_ind[aa]:ap_i
+0003b460: 6e64 5b61 612b 315d 5d29 0a20 2020 2020  nd[aa+1]]).     
+0003b470: 2020 2020 2020 2020 2020 2023 2070 7269             # pri
+0003b480: 6e74 2827 6170 5f7a 272c 2061 705f 7a5b  nt('ap_z', ap_z[
+0003b490: 6170 5f69 6e64 5b61 615d 3a61 705f 696e  ap_ind[aa]:ap_in
+0003b4a0: 645b 6161 2b31 5d5d 290a 0a20 2020 2020  d[aa+1]])..     
+0003b4b0: 2020 2020 2020 2020 2020 2023 2074 6573             # tes
+0003b4c0: 7420 6966 206f 6e20 676f 6f64 2073 6964  t if on good sid
+0003b4d0: 6520 6f66 2061 7065 7274 7572 650a 2020  e of aperture.  
+0003b4e0: 2020 2020 2020 2020 2020 2020 2020 7363                sc
+0003b4f0: 6120 3d20 280a 2020 2020 2020 2020 2020  a = (.          
+0003b500: 2020 2020 2020 2020 2020 2870 7473 5f78            (pts_x
+0003b510: 5b70 705d 202d 2061 705f 785b 6170 5f69  [pp] - ap_x[ap_i
+0003b520: 6e64 5b61 615d 5d29 202a 2061 705f 6e6f  nd[aa]]) * ap_no
+0003b530: 726d 5f78 5b61 615d 0a20 2020 2020 2020  rm_x[aa].       
+0003b540: 2020 2020 2020 2020 2020 2020 202b 2028               + (
+0003b550: 7074 735f 795b 7070 5d20 2d20 6170 5f79  pts_y[pp] - ap_y
+0003b560: 5b61 705f 696e 645b 6161 5d5d 2920 2a20  [ap_ind[aa]]) * 
+0003b570: 6170 5f6e 6f72 6d5f 795b 6161 5d0a 2020  ap_norm_y[aa].  
 0003b580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b590: 2020 6973 6f6b 203d 2046 616c 7365 0a20    isok = False. 
-0003b5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b5b0: 2020 2062 7265 616b 0a0a 2020 2020 2020     break..      
-0003b5c0: 2020 2020 2020 2020 2020 2320 7465 7374            # test
-0003b5d0: 2069 6620 616c 6c20 6170 6572 7475 7265   if all aperture
-0003b5e0: 2070 6f69 6e74 7320 6361 6e20 6265 2070   points can be p
-0003b5f0: 726f 6a65 6374 6564 206f 6e20 6465 7465  rojected on dete
-0003b600: 6374 6f72 2070 6c61 6e65 2066 726f 6d20  ctor plane from 
-0003b610: 7074 730a 2020 2020 2020 2020 2020 2020  pts.            
-0003b620: 2020 2020 666f 7220 6c6c 2069 6e20 7261      for ll in ra
-0003b630: 6e67 6528 6170 5f69 6e64 5b61 615d 2c20  nge(ap_ind[aa], 
-0003b640: 6170 5f69 6e64 5b61 612b 315d 293a 0a20  ap_ind[aa+1]):. 
-0003b650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b660: 2020 2073 6361 3120 3d20 280a 2020 2020     sca1 = (.    
-0003b670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b680: 2020 2020 2861 705f 785b 6c6c 5d20 2d20      (ap_x[ll] - 
-0003b690: 7074 735f 785b 7070 5d29 202a 2064 6574  pts_x[pp]) * det
-0003b6a0: 5f6e 6f72 6d5f 785b 6464 5d0a 2020 2020  _norm_x[dd].    
-0003b6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b6c0: 2020 2020 2b20 2861 705f 795b 6c6c 5d20      + (ap_y[ll] 
-0003b6d0: 2d20 7074 735f 795b 7070 5d29 202a 2064  - pts_y[pp]) * d
-0003b6e0: 6574 5f6e 6f72 6d5f 795b 6464 5d0a 2020  et_norm_y[dd].  
-0003b6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b700: 2020 2020 2020 2b20 2861 705f 7a5b 6c6c        + (ap_z[ll
-0003b710: 5d20 2d20 7074 735f 7a5b 7070 5d29 202a  ] - pts_z[pp]) *
-0003b720: 2064 6574 5f6e 6f72 6d5f 7a5b 6464 5d0a   det_norm_z[dd].
-0003b730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b740: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
-0003b750: 2020 2020 2020 2020 2020 2069 6620 7363             if sc
-0003b760: 6131 203e 3d20 303a 0a20 2020 2020 2020  a1 >= 0:.       
-0003b770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b780: 2069 736f 6b20 3d20 4661 6c73 650a 2020   isok = False.  
-0003b790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b7a0: 2020 2020 2020 6272 6561 6b0a 0a20 2020        break..   
-0003b7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b7c0: 2023 2070 726f 6a65 6374 2069 6e20 3264   # project in 2d
-0003b7d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003b7e0: 2020 2020 206b 203d 202d 2073 6361 3020       k = - sca0 
-0003b7f0: 2f20 7363 6131 0a20 2020 2020 2020 2020  / sca1.         
-0003b800: 2020 2020 2020 2020 2020 2050 5f78 203d             P_x =
-0003b810: 2070 7473 5f78 5b70 705d 202b 206b 202a   pts_x[pp] + k *
-0003b820: 2028 6170 5f78 5b6c 6c5d 202d 2070 7473   (ap_x[ll] - pts
-0003b830: 5f78 5b70 705d 290a 2020 2020 2020 2020  _x[pp]).        
-0003b840: 2020 2020 2020 2020 2020 2020 505f 7920              P_y 
-0003b850: 3d20 7074 735f 795b 7070 5d20 2b20 6b20  = pts_y[pp] + k 
-0003b860: 2a20 2861 705f 795b 6c6c 5d20 2d20 7074  * (ap_y[ll] - pt
-0003b870: 735f 795b 7070 5d29 0a20 2020 2020 2020  s_y[pp]).       
-0003b880: 2020 2020 2020 2020 2020 2020 2050 5f7a               P_z
-0003b890: 203d 2070 7473 5f7a 5b70 705d 202b 206b   = pts_z[pp] + k
-0003b8a0: 202a 2028 6170 5f7a 5b6c 6c5d 202d 2070   * (ap_z[ll] - p
-0003b8b0: 7473 5f7a 5b70 705d 290a 0a20 2020 2020  ts_z[pp])..     
-0003b8c0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0003b8d0: 2070 726f 6a65 6374 2069 6e20 3264 0a20   project in 2d. 
-0003b8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b8f0: 2020 2061 705f 7830 5b6c 6c5d 203d 2028     ap_x0[ll] = (
-0003b900: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003b910: 2020 2020 2020 2020 2028 505f 7820 2d20           (P_x - 
-0003b920: 6465 745f 6365 6e74 735f 785b 6464 5d29  det_cents_x[dd])
-0003b930: 202a 2064 6574 5f65 305f 785b 6464 5d0a   * det_e0_x[dd].
-0003b940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b950: 2020 2020 2020 2020 2b20 2850 5f79 202d          + (P_y -
-0003b960: 2064 6574 5f63 656e 7473 5f79 5b64 645d   det_cents_y[dd]
-0003b970: 2920 2a20 6465 745f 6530 5f79 5b64 645d  ) * det_e0_y[dd]
-0003b980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003b990: 2020 2020 2020 2020 202b 2028 505f 7a20           + (P_z 
-0003b9a0: 2d20 6465 745f 6365 6e74 735f 7a5b 6464  - det_cents_z[dd
-0003b9b0: 5d29 202a 2064 6574 5f65 305f 7a5b 6464  ]) * det_e0_z[dd
-0003b9c0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0003b9d0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0003b9e0: 2020 2020 2020 2020 2020 2020 6170 5f78              ap_x
-0003b9f0: 315b 6c6c 5d20 3d20 280a 2020 2020 2020  1[ll] = (.      
-0003ba00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ba10: 2020 2850 5f78 202d 2064 6574 5f63 656e    (P_x - det_cen
-0003ba20: 7473 5f78 5b64 645d 2920 2a20 6465 745f  ts_x[dd]) * det_
-0003ba30: 6531 5f78 5b64 645d 0a20 2020 2020 2020  e1_x[dd].       
-0003ba40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ba50: 202b 2028 505f 7920 2d20 6465 745f 6365   + (P_y - det_ce
-0003ba60: 6e74 735f 795b 6464 5d29 202a 2064 6574  nts_y[dd]) * det
-0003ba70: 5f65 315f 795b 6464 5d0a 2020 2020 2020  _e1_y[dd].      
-0003ba80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ba90: 2020 2b20 2850 5f7a 202d 2064 6574 5f63    + (P_z - det_c
-0003baa0: 656e 7473 5f7a 5b64 645d 2920 2a20 6465  ents_z[dd]) * de
-0003bab0: 745f 6531 5f7a 5b64 645d 0a20 2020 2020  t_e1_z[dd].     
-0003bac0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0003bad0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0003bae0: 2020 6966 206e 6f74 2069 736f 6b3a 0a20    if not isok:. 
+0003b590: 2020 2b20 2870 7473 5f7a 5b70 705d 202d    + (pts_z[pp] -
+0003b5a0: 2061 705f 7a5b 6170 5f69 6e64 5b61 615d   ap_z[ap_ind[aa]
+0003b5b0: 5d29 202a 2061 705f 6e6f 726d 5f7a 5b61  ]) * ap_norm_z[a
+0003b5c0: 615d 0a20 2020 2020 2020 2020 2020 2020  a].             
+0003b5d0: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
+0003b5e0: 2020 2020 2020 6966 2073 6361 203c 3d20        if sca <= 
+0003b5f0: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+0003b600: 2020 2020 2020 2069 736f 6b20 3d20 4661         isok = Fa
+0003b610: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
+0003b620: 2020 2020 2020 2020 6272 6561 6b0a 0a20          break.. 
+0003b630: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0003b640: 2074 6573 7420 6966 2061 6c6c 2061 7065   test if all ape
+0003b650: 7274 7572 6520 706f 696e 7473 2063 616e  rture points can
+0003b660: 2062 6520 7072 6f6a 6563 7465 6420 6f6e   be projected on
+0003b670: 2064 6574 6563 746f 7220 706c 616e 6520   detector plane 
+0003b680: 6672 6f6d 2070 7473 0a20 2020 2020 2020  from pts.       
+0003b690: 2020 2020 2020 2020 2066 6f72 206c 6c20           for ll 
+0003b6a0: 696e 2072 616e 6765 2861 705f 696e 645b  in range(ap_ind[
+0003b6b0: 6161 5d2c 2061 705f 696e 645b 6161 2b31  aa], ap_ind[aa+1
+0003b6c0: 5d29 3a0a 2020 2020 2020 2020 2020 2020  ]):.            
+0003b6d0: 2020 2020 2020 2020 7363 6131 203d 2028          sca1 = (
+0003b6e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003b6f0: 2020 2020 2020 2020 2028 6170 5f78 5b6c           (ap_x[l
+0003b700: 6c5d 202d 2070 7473 5f78 5b70 705d 2920  l] - pts_x[pp]) 
+0003b710: 2a20 6465 745f 6e6f 726d 5f78 5b64 645d  * det_norm_x[dd]
+0003b720: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003b730: 2020 2020 2020 2020 202b 2028 6170 5f79           + (ap_y
+0003b740: 5b6c 6c5d 202d 2070 7473 5f79 5b70 705d  [ll] - pts_y[pp]
+0003b750: 2920 2a20 6465 745f 6e6f 726d 5f79 5b64  ) * det_norm_y[d
+0003b760: 645d 0a20 2020 2020 2020 2020 2020 2020  d].             
+0003b770: 2020 2020 2020 2020 2020 202b 2028 6170             + (ap
+0003b780: 5f7a 5b6c 6c5d 202d 2070 7473 5f7a 5b70  _z[ll] - pts_z[p
+0003b790: 705d 2920 2a20 6465 745f 6e6f 726d 5f7a  p]) * det_norm_z
+0003b7a0: 5b64 645d 0a20 2020 2020 2020 2020 2020  [dd].           
+0003b7b0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+0003b7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b7d0: 6966 2073 6361 3120 3e3d 2030 3a0a 2020  if sca1 >= 0:.  
+0003b7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b7f0: 2020 2020 2020 6973 6f6b 203d 2046 616c        isok = Fal
+0003b800: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
+0003b810: 2020 2020 2020 2020 2020 2062 7265 616b             break
+0003b820: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0003b830: 2020 2020 2020 2320 7072 6f6a 6563 7420        # project 
+0003b840: 696e 2032 640a 2020 2020 2020 2020 2020  in 2d.          
+0003b850: 2020 2020 2020 2020 2020 6b20 3d20 2d20            k = - 
+0003b860: 7363 6130 202f 2073 6361 310a 2020 2020  sca0 / sca1.    
+0003b870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b880: 505f 7820 3d20 7074 735f 785b 7070 5d20  P_x = pts_x[pp] 
+0003b890: 2b20 6b20 2a20 2861 705f 785b 6c6c 5d20  + k * (ap_x[ll] 
+0003b8a0: 2d20 7074 735f 785b 7070 5d29 0a20 2020  - pts_x[pp]).   
+0003b8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b8c0: 2050 5f79 203d 2070 7473 5f79 5b70 705d   P_y = pts_y[pp]
+0003b8d0: 202b 206b 202a 2028 6170 5f79 5b6c 6c5d   + k * (ap_y[ll]
+0003b8e0: 202d 2070 7473 5f79 5b70 705d 290a 2020   - pts_y[pp]).  
+0003b8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b900: 2020 505f 7a20 3d20 7074 735f 7a5b 7070    P_z = pts_z[pp
+0003b910: 5d20 2b20 6b20 2a20 2861 705f 7a5b 6c6c  ] + k * (ap_z[ll
+0003b920: 5d20 2d20 7074 735f 7a5b 7070 5d29 0a0a  ] - pts_z[pp])..
+0003b930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b940: 2020 2020 2320 7072 6f6a 6563 7420 696e      # project in
+0003b950: 2032 640a 2020 2020 2020 2020 2020 2020   2d.            
+0003b960: 2020 2020 2020 2020 6170 5f78 305b 6c6c          ap_x0[ll
+0003b970: 5d20 3d20 280a 2020 2020 2020 2020 2020  ] = (.          
+0003b980: 2020 2020 2020 2020 2020 2020 2020 2850                (P
+0003b990: 5f78 202d 2064 6574 5f63 656e 7473 5f78  _x - det_cents_x
+0003b9a0: 5b64 645d 2920 2a20 6465 745f 6530 5f78  [dd]) * det_e0_x
+0003b9b0: 5b64 645d 0a20 2020 2020 2020 2020 2020  [dd].           
+0003b9c0: 2020 2020 2020 2020 2020 2020 202b 2028               + (
+0003b9d0: 505f 7920 2d20 6465 745f 6365 6e74 735f  P_y - det_cents_
+0003b9e0: 795b 6464 5d29 202a 2064 6574 5f65 305f  y[dd]) * det_e0_
+0003b9f0: 795b 6464 5d0a 2020 2020 2020 2020 2020  y[dd].          
+0003ba00: 2020 2020 2020 2020 2020 2020 2020 2b20                + 
+0003ba10: 2850 5f7a 202d 2064 6574 5f63 656e 7473  (P_z - det_cents
+0003ba20: 5f7a 5b64 645d 2920 2a20 6465 745f 6530  _z[dd]) * det_e0
+0003ba30: 5f7a 5b64 645d 0a20 2020 2020 2020 2020  _z[dd].         
+0003ba40: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0003ba50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ba60: 2061 705f 7831 5b6c 6c5d 203d 2028 0a20   ap_x1[ll] = (. 
+0003ba70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ba80: 2020 2020 2020 2028 505f 7820 2d20 6465         (P_x - de
+0003ba90: 745f 6365 6e74 735f 785b 6464 5d29 202a  t_cents_x[dd]) *
+0003baa0: 2064 6574 5f65 315f 785b 6464 5d0a 2020   det_e1_x[dd].  
+0003bab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003bac0: 2020 2020 2020 2b20 2850 5f79 202d 2064        + (P_y - d
+0003bad0: 6574 5f63 656e 7473 5f79 5b64 645d 2920  et_cents_y[dd]) 
+0003bae0: 2a20 6465 745f 6531 5f79 5b64 645d 0a20  * det_e1_y[dd]. 
 0003baf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003bb00: 2020 2062 7265 616b 0a0a 2020 2020 2020     break..      
-0003bb10: 2020 2020 2020 2020 2020 2320 7072 696e            # prin
-0003bb20: 7428 2773 6361 302c 2073 6361 312c 206b  t('sca0, sca1, k
-0003bb30: 2020 272c 2073 6361 302c 2073 6361 312c    ', sca0, sca1,
-0003bb40: 206b 290a 2020 2020 2020 2020 2020 2020   k).            
-0003bb50: 2020 2020 2320 7072 696e 7428 2750 782c      # print('Px,
-0003bb60: 2050 792c 2050 7a3a 2020 272c 2050 5f78   Py, Pz:  ', P_x
-0003bb70: 2c20 505f 792c 2050 5f7a 290a 2020 2020  , P_y, P_z).    
-0003bb80: 2020 2020 2020 2020 2020 2020 2320 7072              # pr
-0003bb90: 696e 7428 0a20 2020 2020 2020 2020 2020  int(.           
-0003bba0: 2020 2020 2020 2020 2023 2027 6170 3031           # 'ap01
-0003bbb0: 3a20 272c 0a20 2020 2020 2020 2020 2020  : ',.           
-0003bbc0: 2020 2020 2020 2020 2023 2061 705f 7830           # ap_x0
-0003bbd0: 5b61 705f 696e 645b 6161 5d3a 6170 5f69  [ap_ind[aa]:ap_i
-0003bbe0: 6e64 5b61 612b 315d 5d2c 0a20 2020 2020  nd[aa+1]],.     
-0003bbf0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0003bc00: 2061 705f 7831 5b61 705f 696e 645b 6161   ap_x1[ap_ind[aa
-0003bc10: 5d3a 6170 5f69 6e64 5b61 612b 315d 5d2c  ]:ap_ind[aa+1]],
-0003bc20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003bc30: 2023 2029 0a0a 0a20 2020 2020 2020 2020   # )...         
-0003bc40: 2020 2023 2067 6f20 746f 206e 6578 7420     # go to next 
-0003bc50: 706f 696e 740a 2020 2020 2020 2020 2020  point.          
-0003bc60: 2020 6966 206e 6f74 2069 736f 6b3a 0a20    if not isok:. 
-0003bc70: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0003bc80: 2070 7269 6e74 2827 736b 6970 2032 272c   print('skip 2',
-0003bc90: 2073 6361 2c20 6161 2920 2020 2020 2020   sca, aa)       
-0003bca0: 2023 2044 420a 2020 2020 2020 2020 2020   # DB.          
-0003bcb0: 2020 2020 2020 636f 6e74 696e 7565 0a0a        continue..
-0003bcc0: 2020 2020 2020 2020 2020 2020 2320 2d2d              # --
-0003bcd0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0003bce0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020  ----------.     
-0003bcf0: 2020 2020 2020 2023 2063 6f6d 7075 7465         # compute
-0003bd00: 2070 6f6c 7967 6f6e 2069 6e74 6572 7365   polygon interse
-0003bd10: 6374 696f 6e0a 0a20 2020 2020 2020 2020  ction..         
-0003bd20: 2020 2023 2063 6f6d 7075 7465 2069 6e74     # compute int
-0003bd30: 6572 7365 6374 696f 6e0a 2020 2020 2020  ersection.      
-0003bd40: 2020 2020 2020 705f 6120 3d20 706c 672e        p_a = plg.
-0003bd50: 506f 6c79 676f 6e28 6e70 2e61 7272 6179  Polygon(np.array
-0003bd60: 285b 6465 745f 6f75 746c 696e 655f 7830  ([det_outline_x0
-0003bd70: 2c20 6465 745f 6f75 746c 696e 655f 7831  , det_outline_x1
-0003bd80: 5d29 2e54 290a 2020 2020 2020 2020 2020  ]).T).          
-0003bd90: 2020 666f 7220 6161 2069 6e20 7261 6e67    for aa in rang
-0003bda0: 6528 6e61 293a 0a20 2020 2020 2020 2020  e(na):.         
-0003bdb0: 2020 2020 2020 2023 2070 7269 6e74 2827         # print('
-0003bdc0: 705f 613a 2027 2c20 6e70 2e61 7272 6179  p_a: ', np.array
-0003bdd0: 2870 5f61 2e63 6f6e 746f 7572 2830 2929  (p_a.contour(0))
-0003bde0: 2e54 290a 2020 2020 2020 2020 2020 2020  .T).            
-0003bdf0: 2020 2020 2320 7072 696e 7428 2777 6974      # print('wit
-0003be00: 683a 2027 2c20 6170 5f78 305b 6170 5f69  h: ', ap_x0[ap_i
-0003be10: 6e64 5b61 615d 3a61 705f 696e 645b 6161  nd[aa]:ap_ind[aa
-0003be20: 2b31 5d5d 2c20 6170 5f78 315b 6170 5f69  +1]], ap_x1[ap_i
-0003be30: 6e64 5b61 615d 3a61 705f 696e 645b 6161  nd[aa]:ap_ind[aa
-0003be40: 2b31 5d5d 290a 2020 2020 2020 2020 2020  +1]]).          
-0003be50: 2020 2020 2020 705f 6120 3d20 705f 6120        p_a = p_a 
-0003be60: 2620 706c 672e 506f 6c79 676f 6e28 6e70  & plg.Polygon(np
-0003be70: 2e61 7272 6179 285b 0a20 2020 2020 2020  .array([.       
-0003be80: 2020 2020 2020 2020 2020 2020 2061 705f               ap_
-0003be90: 7830 5b61 705f 696e 645b 6161 5d3a 6170  x0[ap_ind[aa]:ap
-0003bea0: 5f69 6e64 5b61 612b 315d 5d2c 0a20 2020  _ind[aa+1]],.   
-0003beb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003bec0: 2061 705f 7831 5b61 705f 696e 645b 6161   ap_x1[ap_ind[aa
-0003bed0: 5d3a 6170 5f69 6e64 5b61 612b 315d 5d2c  ]:ap_ind[aa+1]],
-0003bee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003bef0: 205d 292e 5429 0a0a 2020 2020 2020 2020   ]).T)..        
-0003bf00: 2020 2020 2020 2020 2320 7374 6f70 2069          # stop i
-0003bf10: 6620 6e6f 2069 6e74 6572 7365 6374 696f  f no intersectio
-0003bf20: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
-0003bf30: 2020 6966 2070 5f61 2e6e 506f 696e 7473    if p_a.nPoints
-0003bf40: 2829 203c 2033 3a0a 2020 2020 2020 2020  () < 3:.        
-0003bf50: 2020 2020 2020 2020 2020 2020 6973 6f6b              isok
-0003bf60: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-0003bf70: 2020 2020 2020 2020 2020 2020 2062 7265               bre
-0003bf80: 616b 0a0a 2020 2020 2020 2020 2020 2020  ak..            
-0003bf90: 2320 7374 6f70 2069 6620 6e6f 2069 6e74  # stop if no int
-0003bfa0: 6572 7365 6374 696f 6e0a 2020 2020 2020  ersection.      
-0003bfb0: 2020 2020 2020 6966 206e 6f74 2069 736f        if not iso
-0003bfc0: 6b3a 0a20 2020 2020 2020 2020 2020 2020  k:.             
-0003bfd0: 2020 2023 2070 7269 6e74 2827 736b 6970     # print('skip
-0003bfe0: 2033 2729 2020 2020 2020 2020 2320 4442   3')        # DB
-0003bff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003c000: 2063 6f6e 7469 6e75 650a 0a20 2020 2020   continue..     
-0003c010: 2020 2020 2020 2023 202d 2d2d 2d2d 2d2d         # -------
-0003c020: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020  ------------.   
-0003c030: 2020 2020 2020 2020 2023 2072 6562 7569           # rebui
-0003c040: 6c64 2033 6420 706f 6c79 676f 6e0a 0a20  ld 3d polygon.. 
-0003c050: 2020 2020 2020 2020 2020 2023 2063 6865             # che
-0003c060: 636b 2063 6377 0a20 2020 2020 2020 2020  ck ccw.         
-0003c070: 2020 2070 5f61 5f78 3020 3d20 6e70 2e61     p_a_x0 = np.a
-0003c080: 7363 6f6e 7469 6775 6f75 7361 7272 6179  scontiguousarray
-0003c090: 286e 702e 6172 7261 7928 705f 612e 636f  (np.array(p_a.co
-0003c0a0: 6e74 6f75 7228 3029 295b 3a2c 2030 5d29  ntour(0))[:, 0])
-0003c0b0: 0a20 2020 2020 2020 2020 2020 2070 5f61  .            p_a
-0003c0c0: 5f78 3120 3d20 6e70 2e61 7363 6f6e 7469  _x1 = np.asconti
-0003c0d0: 6775 6f75 7361 7272 6179 286e 702e 6172  guousarray(np.ar
-0003c0e0: 7261 7928 705f 612e 636f 6e74 6f75 7228  ray(p_a.contour(
-0003c0f0: 3029 295b 3a2c 2031 5d29 0a20 2020 2020  0))[:, 1]).     
-0003c100: 2020 2020 2020 2069 6620 6e6f 7420 5f63         if not _c
-0003c110: 6865 636b 5f70 6f6c 7967 6f6e 5f32 645f  heck_polygon_2d_
-0003c120: 636f 756e 7465 725f 636c 6f63 6b77 6973  counter_clockwis
-0003c130: 6528 705f 615f 7830 2c20 705f 615f 7831  e(p_a_x0, p_a_x1
-0003c140: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0003c150: 2020 2070 5f61 5f78 3020 3d20 6e70 2e61     p_a_x0 = np.a
-0003c160: 7363 6f6e 7469 6775 6f75 7361 7272 6179  scontiguousarray
-0003c170: 2870 5f61 5f78 305b 3a3a 2d31 5d29 0a20  (p_a_x0[::-1]). 
-0003c180: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0003c190: 5f61 5f78 3120 3d20 6e70 2e61 7363 6f6e  _a_x1 = np.ascon
-0003c1a0: 7469 6775 6f75 7361 7272 6179 2870 5f61  tiguousarray(p_a
-0003c1b0: 5f78 315b 3a3a 2d31 5d29 0a0a 2020 2020  _x1[::-1])..    
-0003c1c0: 2020 2020 2020 2020 2320 7472 6961 6e67          # triang
-0003c1d0: 756c 6174 6520 6279 2065 6172 2d63 6c69  ulate by ear-cli
-0003c1e0: 7070 696e 6720 2829 0a20 2020 2020 2020  pping ().       
-0003c1f0: 2020 2020 2074 7269 203d 2074 7269 616e       tri = trian
-0003c200: 6775 6c61 7465 5f62 795f 6561 7263 6c69  gulate_by_earcli
-0003c210: 7070 696e 675f 3264 280a 2020 2020 2020  pping_2d(.      
-0003c220: 2020 2020 2020 2020 2020 6e70 2e61 7363            np.asc
-0003c230: 6f6e 7469 6775 6f75 7361 7272 6179 285b  ontiguousarray([
-0003c240: 705f 615f 7830 2c20 705f 615f 7831 5d29  p_a_x0, p_a_x1])
-0003c250: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
-0003c260: 2020 2020 2020 2020 2020 2020 2320 2d2d              # --
-0003c270: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0003c280: 2d0a 2020 2020 2020 2020 2020 2020 2320  -.            # 
-0003c290: 636f 6d70 7574 6520 736f 6c69 6420 616e  compute solid an
-0003c2a0: 676c 650a 0a20 2020 2020 2020 2020 2020  gle..           
-0003c2b0: 2023 206c 6f6f 7020 6f6e 2074 7269 616e   # loop on trian
-0003c2c0: 676c 6573 0a20 2020 2020 2020 2020 2020  gles.           
-0003c2d0: 2066 6f72 2074 7420 696e 2072 616e 6765   for tt in range
-0003c2e0: 2874 7269 2e73 6861 7065 5b30 5d29 3a0a  (tri.shape[0]):.
-0003c2f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003c300: 2023 2067 6574 2074 7269 616e 676c 650a   # get triangle.
-0003c310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003c320: 7472 695f 7820 3d20 280a 2020 2020 2020  tri_x = (.      
-0003c330: 2020 2020 2020 2020 2020 2020 2020 6465                de
-0003c340: 745f 6365 6e74 735f 785b 6464 5d0a 2020  t_cents_x[dd].  
-0003c350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003c360: 2020 2b20 705f 615f 7830 5b74 7269 5b74    + p_a_x0[tri[t
-0003c370: 742c 203a 5d5d 202a 2064 6574 5f65 305f  t, :]] * det_e0_
-0003c380: 785b 6464 5d0a 2020 2020 2020 2020 2020  x[dd].          
-0003c390: 2020 2020 2020 2020 2020 2b20 705f 615f            + p_a_
-0003c3a0: 7831 5b74 7269 5b74 742c 203a 5d5d 202a  x1[tri[tt, :]] *
-0003c3b0: 2064 6574 5f65 315f 785b 6464 5d0a 2020   det_e1_x[dd].  
-0003c3c0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0003c3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003c3e0: 7472 695f 7920 3d20 280a 2020 2020 2020  tri_y = (.      
-0003c3f0: 2020 2020 2020 2020 2020 2020 2020 6465                de
-0003c400: 745f 6365 6e74 735f 795b 6464 5d0a 2020  t_cents_y[dd].  
-0003c410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003c420: 2020 2b20 705f 615f 7830 5b74 7269 5b74    + p_a_x0[tri[t
-0003c430: 742c 203a 5d5d 202a 2064 6574 5f65 305f  t, :]] * det_e0_
-0003c440: 795b 6464 5d0a 2020 2020 2020 2020 2020  y[dd].          
-0003c450: 2020 2020 2020 2020 2020 2b20 705f 615f            + p_a_
-0003c460: 7831 5b74 7269 5b74 742c 203a 5d5d 202a  x1[tri[tt, :]] *
-0003c470: 2064 6574 5f65 315f 795b 6464 5d0a 2020   det_e1_y[dd].  
-0003c480: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0003c490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003c4a0: 7472 695f 7a20 3d20 280a 2020 2020 2020  tri_z = (.      
-0003c4b0: 2020 2020 2020 2020 2020 2020 2020 6465                de
-0003c4c0: 745f 6365 6e74 735f 7a5b 6464 5d0a 2020  t_cents_z[dd].  
-0003c4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003c4e0: 2020 2b20 705f 615f 7830 5b74 7269 5b74    + p_a_x0[tri[t
-0003c4f0: 742c 203a 5d5d 202a 2064 6574 5f65 305f  t, :]] * det_e0_
-0003c500: 7a5b 6464 5d0a 2020 2020 2020 2020 2020  z[dd].          
-0003c510: 2020 2020 2020 2020 2020 2b20 705f 615f            + p_a_
-0003c520: 7831 5b74 7269 5b74 742c 203a 5d5d 202a  x1[tri[tt, :]] *
-0003c530: 2064 6574 5f65 315f 7a5b 6464 5d0a 2020   det_e1_z[dd].  
-0003c540: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0003c550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003c560: 2023 2063 6f6d 7075 7461 7469 6f6e 2032   # computation 2
-0003c570: 3a20 736f 6c69 6420 616e 676c 6520 6f66  : solid angle of
-0003c580: 2074 7269 616e 676c 6520 6672 6f6d 2070   triangle from p
-0003c590: 7473 0a20 2020 2020 2020 2020 2020 2020  ts.             
-0003c5a0: 2020 2073 6f6c 6964 5f61 6e67 6c65 5b64     solid_angle[d
-0003c5b0: 642c 2070 705d 202b 3d20 5f73 742e 636f  d, pp] += _st.co
-0003c5c0: 6d70 5f73 615f 7472 6928 0a20 2020 2020  mp_sa_tri(.     
-0003c5d0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0003c5e0: 7269 5f78 5b30 5d2c 0a20 2020 2020 2020  ri_x[0],.       
-0003c5f0: 2020 2020 2020 2020 2020 2020 2074 7269               tri
-0003c600: 5f79 5b30 5d2c 0a20 2020 2020 2020 2020  _y[0],.         
-0003c610: 2020 2020 2020 2020 2020 2074 7269 5f7a             tri_z
-0003c620: 5b30 5d2c 0a20 2020 2020 2020 2020 2020  [0],.           
-0003c630: 2020 2020 2020 2020 2074 7269 5f78 5b31           tri_x[1
-0003c640: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-0003c650: 2020 2020 2020 2074 7269 5f79 5b31 5d2c         tri_y[1],
-0003c660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003c670: 2020 2020 2074 7269 5f7a 5b31 5d2c 0a20       tri_z[1],. 
+0003bb00: 2020 2020 2020 202b 2028 505f 7a20 2d20         + (P_z - 
+0003bb10: 6465 745f 6365 6e74 735f 7a5b 6464 5d29  det_cents_z[dd])
+0003bb20: 202a 2064 6574 5f65 315f 7a5b 6464 5d0a   * det_e1_z[dd].
+0003bb30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003bb40: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
+0003bb50: 2020 2020 2020 2069 6620 6e6f 7420 6973         if not is
+0003bb60: 6f6b 3a0a 2020 2020 2020 2020 2020 2020  ok:.            
+0003bb70: 2020 2020 2020 2020 6272 6561 6b0a 0a20          break.. 
+0003bb80: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0003bb90: 2070 7269 6e74 2827 7363 6130 2c20 7363   print('sca0, sc
+0003bba0: 6131 2c20 6b20 2027 2c20 7363 6130 2c20  a1, k  ', sca0, 
+0003bbb0: 7363 6131 2c20 6b29 0a20 2020 2020 2020  sca1, k).       
+0003bbc0: 2020 2020 2020 2020 2023 2070 7269 6e74           # print
+0003bbd0: 2827 5078 2c20 5079 2c20 507a 3a20 2027  ('Px, Py, Pz:  '
+0003bbe0: 2c20 505f 782c 2050 5f79 2c20 505f 7a29  , P_x, P_y, P_z)
+0003bbf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003bc00: 2023 2070 7269 6e74 280a 2020 2020 2020   # print(.      
+0003bc10: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0003bc20: 2761 7030 313a 2027 2c0a 2020 2020 2020  'ap01: ',.      
+0003bc30: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0003bc40: 6170 5f78 305b 6170 5f69 6e64 5b61 615d  ap_x0[ap_ind[aa]
+0003bc50: 3a61 705f 696e 645b 6161 2b31 5d5d 2c0a  :ap_ind[aa+1]],.
+0003bc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003bc70: 2020 2020 2320 6170 5f78 315b 6170 5f69      # ap_x1[ap_i
+0003bc80: 6e64 5b61 615d 3a61 705f 696e 645b 6161  nd[aa]:ap_ind[aa
+0003bc90: 2b31 5d5d 2c0a 2020 2020 2020 2020 2020  +1]],.          
+0003bca0: 2020 2020 2020 2320 290a 0a0a 2020 2020        # )...    
+0003bcb0: 2020 2020 2020 2020 2320 676f 2074 6f20          # go to 
+0003bcc0: 6e65 7874 2070 6f69 6e74 0a20 2020 2020  next point.     
+0003bcd0: 2020 2020 2020 2069 6620 6e6f 7420 6973         if not is
+0003bce0: 6f6b 3a0a 2020 2020 2020 2020 2020 2020  ok:.            
+0003bcf0: 2020 2020 2320 7072 696e 7428 2773 6b69      # print('ski
+0003bd00: 7020 3227 2c20 7363 612c 2061 6129 2020  p 2', sca, aa)  
+0003bd10: 2020 2020 2020 2320 4442 0a20 2020 2020        # DB.     
+0003bd20: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+0003bd30: 6e75 650a 0a20 2020 2020 2020 2020 2020  nue..           
+0003bd40: 2023 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   # -------------
+0003bd50: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a  ---------------.
+0003bd60: 2020 2020 2020 2020 2020 2020 2320 636f              # co
+0003bd70: 6d70 7574 6520 706f 6c79 676f 6e20 696e  mpute polygon in
+0003bd80: 7465 7273 6563 7469 6f6e 0a0a 2020 2020  tersection..    
+0003bd90: 2020 2020 2020 2020 2320 636f 6d70 7574          # comput
+0003bda0: 6520 696e 7465 7273 6563 7469 6f6e 0a20  e intersection. 
+0003bdb0: 2020 2020 2020 2020 2020 2070 5f61 203d             p_a =
+0003bdc0: 2070 6c67 2e50 6f6c 7967 6f6e 286e 702e   plg.Polygon(np.
+0003bdd0: 6172 7261 7928 5b64 6574 5f6f 7574 6c69  array([det_outli
+0003bde0: 6e65 5f78 302c 2064 6574 5f6f 7574 6c69  ne_x0, det_outli
+0003bdf0: 6e65 5f78 315d 292e 5429 0a20 2020 2020  ne_x1]).T).     
+0003be00: 2020 2020 2020 2066 6f72 2061 6120 696e         for aa in
+0003be10: 2072 616e 6765 286e 6129 3a0a 2020 2020   range(na):.    
+0003be20: 2020 2020 2020 2020 2020 2020 2320 7072              # pr
+0003be30: 696e 7428 2770 5f61 3a20 272c 206e 702e  int('p_a: ', np.
+0003be40: 6172 7261 7928 705f 612e 636f 6e74 6f75  array(p_a.contou
+0003be50: 7228 3029 292e 5429 0a20 2020 2020 2020  r(0)).T).       
+0003be60: 2020 2020 2020 2020 2023 2070 7269 6e74           # print
+0003be70: 2827 7769 7468 3a20 272c 2061 705f 7830  ('with: ', ap_x0
+0003be80: 5b61 705f 696e 645b 6161 5d3a 6170 5f69  [ap_ind[aa]:ap_i
+0003be90: 6e64 5b61 612b 315d 5d2c 2061 705f 7831  nd[aa+1]], ap_x1
+0003bea0: 5b61 705f 696e 645b 6161 5d3a 6170 5f69  [ap_ind[aa]:ap_i
+0003beb0: 6e64 5b61 612b 315d 5d29 0a20 2020 2020  nd[aa+1]]).     
+0003bec0: 2020 2020 2020 2020 2020 2070 5f61 203d             p_a =
+0003bed0: 2070 5f61 2026 2070 6c67 2e50 6f6c 7967   p_a & plg.Polyg
+0003bee0: 6f6e 286e 702e 6172 7261 7928 5b0a 2020  on(np.array([.  
+0003bef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003bf00: 2020 6170 5f78 305b 6170 5f69 6e64 5b61    ap_x0[ap_ind[a
+0003bf10: 615d 3a61 705f 696e 645b 6161 2b31 5d5d  a]:ap_ind[aa+1]]
+0003bf20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0003bf30: 2020 2020 2020 6170 5f78 315b 6170 5f69        ap_x1[ap_i
+0003bf40: 6e64 5b61 615d 3a61 705f 696e 645b 6161  nd[aa]:ap_ind[aa
+0003bf50: 2b31 5d5d 2c0a 2020 2020 2020 2020 2020  +1]],.          
+0003bf60: 2020 2020 2020 5d29 2e54 290a 0a20 2020        ]).T)..   
+0003bf70: 2020 2020 2020 2020 2020 2020 2023 2073               # s
+0003bf80: 746f 7020 6966 206e 6f20 696e 7465 7273  top if no inters
+0003bf90: 6563 7469 6f6e 0a20 2020 2020 2020 2020  ection.         
+0003bfa0: 2020 2020 2020 2069 6620 705f 612e 6e50         if p_a.nP
+0003bfb0: 6f69 6e74 7328 2920 3c20 333a 0a20 2020  oints() < 3:.   
+0003bfc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003bfd0: 2069 736f 6b20 3d20 4661 6c73 650a 2020   isok = False.  
+0003bfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003bff0: 2020 6272 6561 6b0a 0a20 2020 2020 2020    break..       
+0003c000: 2020 2020 2023 2073 746f 7020 6966 206e       # stop if n
+0003c010: 6f20 696e 7465 7273 6563 7469 6f6e 0a20  o intersection. 
+0003c020: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+0003c030: 7420 6973 6f6b 3a0a 2020 2020 2020 2020  t isok:.        
+0003c040: 2020 2020 2020 2020 2320 7072 696e 7428          # print(
+0003c050: 2773 6b69 7020 3327 2920 2020 2020 2020  'skip 3')       
+0003c060: 2023 2044 420a 2020 2020 2020 2020 2020   # DB.          
+0003c070: 2020 2020 2020 636f 6e74 696e 7565 0a0a        continue..
+0003c080: 2020 2020 2020 2020 2020 2020 2320 2d2d              # --
+0003c090: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0003c0a0: 2d0a 2020 2020 2020 2020 2020 2020 2320  -.            # 
+0003c0b0: 7265 6275 696c 6420 3364 2070 6f6c 7967  rebuild 3d polyg
+0003c0c0: 6f6e 0a0a 2020 2020 2020 2020 2020 2020  on..            
+0003c0d0: 2320 6368 6563 6b20 6363 770a 2020 2020  # check ccw.    
+0003c0e0: 2020 2020 2020 2020 705f 615f 7830 203d          p_a_x0 =
+0003c0f0: 206e 702e 6173 636f 6e74 6967 756f 7573   np.ascontiguous
+0003c100: 6172 7261 7928 6e70 2e61 7272 6179 2870  array(np.array(p
+0003c110: 5f61 2e63 6f6e 746f 7572 2830 2929 5b3a  _a.contour(0))[:
+0003c120: 2c20 305d 290a 2020 2020 2020 2020 2020  , 0]).          
+0003c130: 2020 705f 615f 7831 203d 206e 702e 6173    p_a_x1 = np.as
+0003c140: 636f 6e74 6967 756f 7573 6172 7261 7928  contiguousarray(
+0003c150: 6e70 2e61 7272 6179 2870 5f61 2e63 6f6e  np.array(p_a.con
+0003c160: 746f 7572 2830 2929 5b3a 2c20 315d 290a  tour(0))[:, 1]).
+0003c170: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+0003c180: 6f74 205f 6368 6563 6b5f 706f 6c79 676f  ot _check_polygo
+0003c190: 6e5f 3264 5f63 6f75 6e74 6572 5f63 6c6f  n_2d_counter_clo
+0003c1a0: 636b 7769 7365 2870 5f61 5f78 302c 2070  ckwise(p_a_x0, p
+0003c1b0: 5f61 5f78 3129 3a0a 2020 2020 2020 2020  _a_x1):.        
+0003c1c0: 2020 2020 2020 2020 705f 615f 7830 203d          p_a_x0 =
+0003c1d0: 206e 702e 6173 636f 6e74 6967 756f 7573   np.ascontiguous
+0003c1e0: 6172 7261 7928 705f 615f 7830 5b3a 3a2d  array(p_a_x0[::-
+0003c1f0: 315d 290a 2020 2020 2020 2020 2020 2020  1]).            
+0003c200: 2020 2020 705f 615f 7831 203d 206e 702e      p_a_x1 = np.
+0003c210: 6173 636f 6e74 6967 756f 7573 6172 7261  ascontiguousarra
+0003c220: 7928 705f 615f 7831 5b3a 3a2d 315d 290a  y(p_a_x1[::-1]).
+0003c230: 0a20 2020 2020 2020 2020 2020 2023 2074  .            # t
+0003c240: 7269 616e 6775 6c61 7465 2062 7920 6561  riangulate by ea
+0003c250: 722d 636c 6970 7069 6e67 2028 290a 2020  r-clipping ().  
+0003c260: 2020 2020 2020 2020 2020 7472 6920 3d20            tri = 
+0003c270: 7472 6961 6e67 756c 6174 655f 6279 5f65  triangulate_by_e
+0003c280: 6172 636c 6970 7069 6e67 5f32 6428 0a20  arclipping_2d(. 
+0003c290: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0003c2a0: 702e 6173 636f 6e74 6967 756f 7573 6172  p.ascontiguousar
+0003c2b0: 7261 7928 5b70 5f61 5f78 302c 2070 5f61  ray([p_a_x0, p_a
+0003c2c0: 5f78 315d 290a 2020 2020 2020 2020 2020  _x1]).          
+0003c2d0: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
+0003c2e0: 2023 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   # -------------
+0003c2f0: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2020  ------.         
+0003c300: 2020 2023 2063 6f6d 7075 7465 2073 6f6c     # compute sol
+0003c310: 6964 2061 6e67 6c65 0a0a 2020 2020 2020  id angle..      
+0003c320: 2020 2020 2020 2320 6c6f 6f70 206f 6e20        # loop on 
+0003c330: 7472 6961 6e67 6c65 730a 2020 2020 2020  triangles.      
+0003c340: 2020 2020 2020 666f 7220 7474 2069 6e20        for tt in 
+0003c350: 7261 6e67 6528 7472 692e 7368 6170 655b  range(tri.shape[
+0003c360: 305d 293a 0a0a 2020 2020 2020 2020 2020  0]):..          
+0003c370: 2020 2020 2020 2320 6765 7420 7472 6961        # get tria
+0003c380: 6e67 6c65 0a20 2020 2020 2020 2020 2020  ngle.           
+0003c390: 2020 2020 2074 7269 5f78 203d 2028 0a20       tri_x = (. 
+0003c3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003c3b0: 2020 2064 6574 5f63 656e 7473 5f78 5b64     det_cents_x[d
+0003c3c0: 645d 0a20 2020 2020 2020 2020 2020 2020  d].             
+0003c3d0: 2020 2020 2020 202b 2070 5f61 5f78 305b         + p_a_x0[
+0003c3e0: 7472 695b 7474 2c20 3a5d 5d20 2a20 6465  tri[tt, :]] * de
+0003c3f0: 745f 6530 5f78 5b64 645d 0a20 2020 2020  t_e0_x[dd].     
+0003c400: 2020 2020 2020 2020 2020 2020 2020 202b                 +
+0003c410: 2070 5f61 5f78 315b 7472 695b 7474 2c20   p_a_x1[tri[tt, 
+0003c420: 3a5d 5d20 2a20 6465 745f 6531 5f78 5b64  :]] * det_e1_x[d
+0003c430: 645d 0a20 2020 2020 2020 2020 2020 2020  d].             
+0003c440: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0003c450: 2020 2020 2074 7269 5f79 203d 2028 0a20       tri_y = (. 
+0003c460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003c470: 2020 2064 6574 5f63 656e 7473 5f79 5b64     det_cents_y[d
+0003c480: 645d 0a20 2020 2020 2020 2020 2020 2020  d].             
+0003c490: 2020 2020 2020 202b 2070 5f61 5f78 305b         + p_a_x0[
+0003c4a0: 7472 695b 7474 2c20 3a5d 5d20 2a20 6465  tri[tt, :]] * de
+0003c4b0: 745f 6530 5f79 5b64 645d 0a20 2020 2020  t_e0_y[dd].     
+0003c4c0: 2020 2020 2020 2020 2020 2020 2020 202b                 +
+0003c4d0: 2070 5f61 5f78 315b 7472 695b 7474 2c20   p_a_x1[tri[tt, 
+0003c4e0: 3a5d 5d20 2a20 6465 745f 6531 5f79 5b64  :]] * det_e1_y[d
+0003c4f0: 645d 0a20 2020 2020 2020 2020 2020 2020  d].             
+0003c500: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0003c510: 2020 2020 2074 7269 5f7a 203d 2028 0a20       tri_z = (. 
+0003c520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003c530: 2020 2064 6574 5f63 656e 7473 5f7a 5b64     det_cents_z[d
+0003c540: 645d 0a20 2020 2020 2020 2020 2020 2020  d].             
+0003c550: 2020 2020 2020 202b 2070 5f61 5f78 305b         + p_a_x0[
+0003c560: 7472 695b 7474 2c20 3a5d 5d20 2a20 6465  tri[tt, :]] * de
+0003c570: 745f 6530 5f7a 5b64 645d 0a20 2020 2020  t_e0_z[dd].     
+0003c580: 2020 2020 2020 2020 2020 2020 2020 202b                 +
+0003c590: 2070 5f61 5f78 315b 7472 695b 7474 2c20   p_a_x1[tri[tt, 
+0003c5a0: 3a5d 5d20 2a20 6465 745f 6531 5f7a 5b64  :]] * det_e1_z[d
+0003c5b0: 645d 0a20 2020 2020 2020 2020 2020 2020  d].             
+0003c5c0: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
+0003c5d0: 2020 2020 2020 2320 636f 6d70 7574 6174        # computat
+0003c5e0: 696f 6e20 323a 2073 6f6c 6964 2061 6e67  ion 2: solid ang
+0003c5f0: 6c65 206f 6620 7472 6961 6e67 6c65 2066  le of triangle f
+0003c600: 726f 6d20 7074 730a 2020 2020 2020 2020  rom pts.        
+0003c610: 2020 2020 2020 2020 736f 6c69 645f 616e          solid_an
+0003c620: 676c 655b 6464 2c20 7070 5d20 2b3d 205f  gle[dd, pp] += _
+0003c630: 7374 2e63 6f6d 705f 7361 5f74 7269 280a  st.comp_sa_tri(.
+0003c640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003c650: 2020 2020 7472 695f 785b 305d 2c0a 2020      tri_x[0],.  
+0003c660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003c670: 2020 7472 695f 795b 305d 2c0a 2020 2020    tri_y[0],.    
 0003c680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003c690: 2020 2074 7269 5f78 5b32 5d2c 0a20 2020     tri_x[2],.   
-0003c6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003c6b0: 2074 7269 5f79 5b32 5d2c 0a20 2020 2020   tri_y[2],.     
-0003c6c0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0003c6d0: 7269 5f7a 5b32 5d2c 0a20 2020 2020 2020  ri_z[2],.       
-0003c6e0: 2020 2020 2020 2020 2020 2020 2070 7473               pts
-0003c6f0: 5f78 5b70 705d 2c0a 2020 2020 2020 2020  _x[pp],.        
-0003c700: 2020 2020 2020 2020 2020 2020 7074 735f              pts_
-0003c710: 795b 7070 5d2c 0a20 2020 2020 2020 2020  y[pp],.         
-0003c720: 2020 2020 2020 2020 2020 2070 7473 5f7a             pts_z
-0003c730: 5b70 705d 2c0a 2020 2020 2020 2020 2020  [pp],.          
-0003c740: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0003c750: 2020 2020 2020 2020 2320 7072 696e 7428          # print(
-0003c760: 2774 7269 272c 2074 742c 2073 6f6c 6964  'tri', tt, solid
-0003c770: 5f61 6e67 6c65 5b64 642c 2070 705d 2920  _angle[dd, pp]) 
-0003c780: 2020 2020 2020 2023 2044 420a 0a20 2020         # DB..   
-0003c790: 2023 202d 2d2d 2d2d 2d2d 0a20 2020 2023   # -------.    #
-0003c7a0: 2052 6574 7572 6e0a 0a20 2020 2072 6574   Return..    ret
-0003c7b0: 7572 6e20 736f 6c69 645f 616e 676c 650a  urn solid_angle.
-0003c7c0: 0a0a 6465 6620 636f 6d70 7574 655f 736f  ..def compute_so
-0003c7d0: 6c69 645f 616e 676c 655f 6170 6572 7475  lid_angle_apertu
-0003c7e0: 7265 735f 6c69 6768 745f 7375 6d6d 6564  res_light_summed
-0003c7f0: 280a 2020 2020 2320 7074 733a 2063 6f6f  (.    # pts: coo
-0003c800: 7264 696e 6174 6573 2061 7320 7468 7265  rdinates as thre
-0003c810: 6520 3164 2061 7272 6179 730a 2020 2020  e 1d arrays.    
-0003c820: 646f 7562 6c65 5b3a 3a31 5d20 7074 735f  double[::1] pts_
-0003c830: 782c 0a20 2020 2064 6f75 626c 655b 3a3a  x,.    double[::
-0003c840: 315d 2070 7473 5f79 2c0a 2020 2020 646f  1] pts_y,.    do
-0003c850: 7562 6c65 5b3a 3a31 5d20 7074 735f 7a2c  uble[::1] pts_z,
-0003c860: 0a20 2020 2023 2064 6574 6563 746f 7273  .    # detectors
-0003c870: 3a20 706f 6c79 676f 6e20 636f 6f72 6469  : polygon coordi
-0003c880: 6e61 7465 7320 696e 2032 6420 2863 6f6d  nates in 2d (com
-0003c890: 6d6f 6e20 746f 2061 6c6c 2064 6574 6563  mon to all detec
-0003c8a0: 746f 7273 290a 2020 2020 646f 7562 6c65  tors).    double
-0003c8b0: 5b3a 3a31 5d20 6465 745f 6f75 746c 696e  [::1] det_outlin
-0003c8c0: 655f 7830 2c0a 2020 2020 646f 7562 6c65  e_x0,.    double
-0003c8d0: 5b3a 3a31 5d20 6465 745f 6f75 746c 696e  [::1] det_outlin
-0003c8e0: 655f 7831 2c0a 2020 2020 2320 6465 7465  e_x1,.    # dete
-0003c8f0: 6374 6f72 733a 2063 656e 7465 7273 2063  ctors: centers c
-0003c900: 6f6f 7264 696e 6174 6573 2061 7320 7468  oordinates as th
-0003c910: 7265 6520 3164 2061 7272 6179 730a 2020  ree 1d arrays.  
-0003c920: 2020 646f 7562 6c65 5b3a 3a31 5d20 6465    double[::1] de
-0003c930: 745f 6365 6e74 735f 782c 0a20 2020 2064  t_cents_x,.    d
-0003c940: 6f75 626c 655b 3a3a 315d 2064 6574 5f63  ouble[::1] det_c
-0003c950: 656e 7473 5f79 2c0a 2020 2020 646f 7562  ents_y,.    doub
-0003c960: 6c65 5b3a 3a31 5d20 6465 745f 6365 6e74  le[::1] det_cent
-0003c970: 735f 7a2c 0a20 2020 2023 2064 6574 6563  s_z,.    # detec
-0003c980: 746f 7273 3a20 6e6f 726d 616c 2075 6e69  tors: normal uni
-0003c990: 7420 7665 6374 6f72 7320 6173 2074 6872  t vectors as thr
-0003c9a0: 6565 2031 6420 6172 7261 7973 2028 6e64  ee 1d arrays (nd
-0003c9b0: 203d 206c 656e 2864 6574 5f6e 6f72 6d5f   = len(det_norm_
-0003c9c0: 7829 290a 2020 2020 646f 7562 6c65 5b3a  x)).    double[:
-0003c9d0: 3a31 5d20 6465 745f 6e6f 726d 5f78 2c0a  :1] det_norm_x,.
-0003c9e0: 2020 2020 646f 7562 6c65 5b3a 3a31 5d20      double[::1] 
-0003c9f0: 6465 745f 6e6f 726d 5f79 2c0a 2020 2020  det_norm_y,.    
-0003ca00: 646f 7562 6c65 5b3a 3a31 5d20 6465 745f  double[::1] det_
-0003ca10: 6e6f 726d 5f7a 2c0a 2020 2020 6e70 2e6e  norm_z,.    np.n
-0003ca20: 6461 7272 6179 5b64 6f75 626c 652c 206e  darray[double, n
-0003ca30: 6469 6d3d 315d 2064 6574 5f65 305f 782c  dim=1] det_e0_x,
-0003ca40: 0a20 2020 206e 702e 6e64 6172 7261 795b  .    np.ndarray[
-0003ca50: 646f 7562 6c65 2c20 6e64 696d 3d31 5d20  double, ndim=1] 
-0003ca60: 6465 745f 6530 5f79 2c0a 2020 2020 6e70  det_e0_y,.    np
-0003ca70: 2e6e 6461 7272 6179 5b64 6f75 626c 652c  .ndarray[double,
-0003ca80: 206e 6469 6d3d 315d 2064 6574 5f65 305f   ndim=1] det_e0_
-0003ca90: 7a2c 0a20 2020 206e 702e 6e64 6172 7261  z,.    np.ndarra
-0003caa0: 795b 646f 7562 6c65 2c20 6e64 696d 3d31  y[double, ndim=1
-0003cab0: 5d20 6465 745f 6531 5f78 2c0a 2020 2020  ] det_e1_x,.    
-0003cac0: 6e70 2e6e 6461 7272 6179 5b64 6f75 626c  np.ndarray[doubl
-0003cad0: 652c 206e 6469 6d3d 315d 2064 6574 5f65  e, ndim=1] det_e
-0003cae0: 315f 792c 0a20 2020 206e 702e 6e64 6172  1_y,.    np.ndar
-0003caf0: 7261 795b 646f 7562 6c65 2c20 6e64 696d  ray[double, ndim
-0003cb00: 3d31 5d20 6465 745f 6531 5f7a 2c0a 2020  =1] det_e1_z,.  
-0003cb10: 2020 2320 6170 6572 7475 7265 733a 2069    # apertures: i
-0003cb20: 6e64 6963 6573 206f 6620 6669 7273 7420  ndices of first 
-0003cb30: 636f 726e 6572 206f 6620 6561 6368 2061  corner of each a
-0003cb40: 7020 706f 6c79 676f 6e3a 206e 6120 3d20  p polygon: na = 
-0003cb50: 6c65 6e28 6170 5f69 6e64 290a 2020 2020  len(ap_ind).    
-0003cb60: 6c6f 6e67 5b3a 3a31 5d20 6170 5f69 6e64  long[::1] ap_ind
-0003cb70: 2c0a 2020 2020 2320 6170 6572 7475 7265  ,.    # aperture
-0003cb80: 733a 2070 6f6c 7967 6f6e 2063 6f6f 7264  s: polygon coord
-0003cb90: 696e 6174 6573 2061 7320 7468 7265 6520  inates as three 
-0003cba0: 3164 2061 7272 6179 730a 2020 2020 6e70  1d arrays.    np
-0003cbb0: 2e6e 6461 7272 6179 5b64 6f75 626c 652c  .ndarray[double,
-0003cbc0: 206e 6469 6d3d 315d 2061 705f 782c 0a20   ndim=1] ap_x,. 
-0003cbd0: 2020 206e 702e 6e64 6172 7261 795b 646f     np.ndarray[do
-0003cbe0: 7562 6c65 2c20 6e64 696d 3d31 5d20 6170  uble, ndim=1] ap
-0003cbf0: 5f79 2c0a 2020 2020 6e70 2e6e 6461 7272  _y,.    np.ndarr
-0003cc00: 6179 5b64 6f75 626c 652c 206e 6469 6d3d  ay[double, ndim=
-0003cc10: 315d 2061 705f 7a2c 0a20 2020 2023 206e  1] ap_z,.    # n
-0003cc20: 6f72 6d61 6c20 756e 6974 2076 6563 746f  ormal unit vecto
-0003cc30: 7273 0a20 2020 2064 6f75 626c 655b 3a3a  rs.    double[::
-0003cc40: 315d 2061 705f 6e6f 726d 5f78 2c0a 2020  1] ap_norm_x,.  
-0003cc50: 2020 646f 7562 6c65 5b3a 3a31 5d20 6170    double[::1] ap
-0003cc60: 5f6e 6f72 6d5f 792c 0a20 2020 2064 6f75  _norm_y,.    dou
-0003cc70: 626c 655b 3a3a 315d 2061 705f 6e6f 726d  ble[::1] ap_norm
-0003cc80: 5f7a 2c0a 2020 2020 2320 706f 7373 6962  _z,.    # possib
-0003cc90: 6c65 2065 7874 7261 2070 6172 616d 6574  le extra paramet
-0003cca0: 6572 7320 3f0a 2020 2020 646f 7562 6c65  ers ?.    double
-0003ccb0: 206d 6172 6769 6e3d 5f56 534d 414c 4c2c   margin=_VSMALL,
-0003ccc0: 0a20 2020 2069 6e74 206e 756d 5f74 6872  .    int num_thr
-0003ccd0: 6561 6473 3d31 302c 0a29 3a0a 0a20 2020  eads=10,.):..   
-0003cce0: 2023 202d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20   # -----------. 
-0003ccf0: 2020 2023 2044 6563 6c61 7261 7469 6f6e     # Declaration
-0003cd00: 0a0a 2020 2020 6364 6566 2069 6e74 206e  ..    cdef int n
-0003cd10: 7074 7320 3d20 7074 735f 782e 7369 7a65  pts = pts_x.size
-0003cd20: 0a20 2020 2063 6465 6620 696e 7420 6e64  .    cdef int nd
-0003cd30: 203d 2064 6574 5f63 656e 7473 5f78 2e73   = det_cents_x.s
-0003cd40: 697a 650a 2020 2020 6364 6566 2069 6e74  ize.    cdef int
-0003cd50: 206e 6120 3d20 6170 5f6e 6f72 6d5f 782e   na = ap_norm_x.
-0003cd60: 7369 7a65 0a20 2020 2063 6465 6620 696e  size.    cdef in
-0003cd70: 7420 6464 2c20 7070 2c20 6161 2c20 7474  t dd, pp, aa, tt
-0003cd80: 0a20 2020 2063 6465 6620 696e 7420 6e70  .    cdef int np
-0003cd90: 610a 2020 2020 6364 6566 2066 6c6f 6174  a.    cdef float
-0003cda0: 2073 6361 2c20 7363 6130 2c20 7363 6131   sca, sca0, sca1
-0003cdb0: 0a20 2020 2063 6465 6620 666c 6f61 7420  .    cdef float 
-0003cdc0: 6b69 0a20 2020 2063 6465 6620 6e70 2e6e  ki.    cdef np.n
-0003cdd0: 6461 7272 6179 5b64 6f75 626c 652c 206e  darray[double, n
-0003cde0: 6469 6d3d 315d 2061 705f 7830 203d 206e  dim=1] ap_x0 = n
-0003cdf0: 702e 636f 7079 2861 705f 7829 0a20 2020  p.copy(ap_x).   
-0003ce00: 2063 6465 6620 6e70 2e6e 6461 7272 6179   cdef np.ndarray
-0003ce10: 5b64 6f75 626c 652c 206e 6469 6d3d 315d  [double, ndim=1]
-0003ce20: 2061 705f 7831 203d 206e 702e 636f 7079   ap_x1 = np.copy
-0003ce30: 2861 705f 7829 0a20 2020 2063 6465 6620  (ap_x).    cdef 
-0003ce40: 6e70 2e6e 6461 7272 6179 5b64 6f75 626c  np.ndarray[doubl
-0003ce50: 652c 206e 6469 6d3d 315d 2070 5f61 5f78  e, ndim=1] p_a_x
-0003ce60: 300a 2020 2020 6364 6566 206e 702e 6e64  0.    cdef np.nd
-0003ce70: 6172 7261 795b 646f 7562 6c65 2c20 6e64  array[double, nd
-0003ce80: 696d 3d31 5d20 705f 615f 7831 0a20 2020  im=1] p_a_x1.   
-0003ce90: 2063 6465 6620 6e70 2e6e 6461 7272 6179   cdef np.ndarray
-0003cea0: 5b6c 6f6e 672c 206e 6469 6d3d 325d 2074  [long, ndim=2] t
-0003ceb0: 7269 0a20 2020 2063 6465 6620 6e70 2e6e  ri.    cdef np.n
-0003cec0: 6461 7272 6179 5b64 6f75 626c 652c 206e  darray[double, n
-0003ced0: 6469 6d3d 315d 2074 7269 5f78 0a20 2020  dim=1] tri_x.   
-0003cee0: 2063 6465 6620 6e70 2e6e 6461 7272 6179   cdef np.ndarray
-0003cef0: 5b64 6f75 626c 652c 206e 6469 6d3d 315d  [double, ndim=1]
-0003cf00: 2074 7269 5f79 0a20 2020 2063 6465 6620   tri_y.    cdef 
-0003cf10: 6e70 2e6e 6461 7272 6179 5b64 6f75 626c  np.ndarray[doubl
-0003cf20: 652c 206e 6469 6d3d 315d 2074 7269 5f7a  e, ndim=1] tri_z
-0003cf30: 0a0a 2020 2020 2320 696e 6974 6961 6c69  ..    # initiali
-0003cf40: 7a65 2073 6f6c 6964 2061 6e67 6c65 2061  ze solid angle a
-0003cf50: 7272 6179 2077 6974 6820 7a65 726f 730a  rray with zeros.
-0003cf60: 2020 2020 6364 6566 2066 6c6f 6174 2073      cdef float s
-0003cf70: 6f6c 6964 5f61 6e67 6c65 203d 2030 2e0a  olid_angle = 0..
-0003cf80: 0a20 2020 2023 202d 2d2d 2d2d 2d2d 0a20  .    # -------. 
-0003cf90: 2020 2023 2043 6f6d 7075 7465 0a0a 2020     # Compute..  
-0003cfa0: 2020 666f 7220 6464 2069 6e20 7261 6e67    for dd in rang
-0003cfb0: 6528 6e64 293a 0a0a 2020 2020 2020 2020  e(nd):..        
-0003cfc0: 2320 7072 696e 7428 2764 6574 5f63 656e  # print('det_cen
-0003cfd0: 7427 2c20 6465 745f 6365 6e74 735f 785b  t', det_cents_x[
-0003cfe0: 6464 5d2c 2064 6574 5f63 656e 7473 5f79  dd], det_cents_y
-0003cff0: 5b64 645d 2c20 6465 745f 6365 6e74 735f  [dd], det_cents_
-0003d000: 7a5b 6464 5d29 0a20 2020 2020 2020 2023  z[dd]).        #
-0003d010: 2070 7269 6e74 2827 6465 745f 6e69 6e27   print('det_nin'
-0003d020: 2c20 6465 745f 6e6f 726d 5f78 5b64 645d  , det_norm_x[dd]
-0003d030: 2c20 6465 745f 6e6f 726d 5f79 5b64 645d  , det_norm_y[dd]
-0003d040: 2c20 6465 745f 6e6f 726d 5f7a 5b64 645d  , det_norm_z[dd]
-0003d050: 2920 2020 2020 2020 2023 2044 420a 2020  )        # DB.  
-0003d060: 2020 2020 2020 2320 7072 696e 7428 2764        # print('d
-0003d070: 6574 5f65 3027 2c20 6465 745f 6530 5f78  et_e0', det_e0_x
-0003d080: 5b64 645d 2c20 6465 745f 6530 5f79 5b64  [dd], det_e0_y[d
-0003d090: 645d 2c20 6465 745f 6530 5f7a 5b64 645d  d], det_e0_z[dd]
-0003d0a0: 2920 2020 2020 2020 2023 2044 420a 2020  )        # DB.  
-0003d0b0: 2020 2020 2020 2320 7072 696e 7428 2764        # print('d
-0003d0c0: 6574 5f65 3127 2c20 6465 745f 6531 5f78  et_e1', det_e1_x
-0003d0d0: 5b64 645d 2c20 6465 745f 6531 5f79 5b64  [dd], det_e1_y[d
-0003d0e0: 645d 2c20 6465 745f 6531 5f7a 5b64 645d  d], det_e1_z[dd]
-0003d0f0: 2920 2020 2020 2020 2023 2044 420a 0a20  )        # DB.. 
-0003d100: 2020 2020 2020 2023 206c 6f6f 7020 323a         # loop 2:
-0003d110: 206f 6e20 6e70 7473 2028 6f62 7365 7276   on npts (observ
-0003d120: 6174 696f 6e20 706f 696e 7473 290a 2020  ation points).  
-0003d130: 2020 2020 2020 666f 7220 7070 2069 6e20        for pp in 
-0003d140: 7261 6e67 6528 6e70 7473 293a 0a0a 2020  range(npts):..  
-0003d150: 2020 2020 2020 2020 2020 2320 7072 696e            # prin
-0003d160: 7428 2770 7473 272c 2070 702c 2070 7473  t('pts', pp, pts
-0003d170: 5f78 5b70 705d 2c20 7074 735f 795b 7070  _x[pp], pts_y[pp
-0003d180: 5d2c 2070 7473 5f7a 5b70 705d 2920 2020  ], pts_z[pp])   
-0003d190: 2020 2020 2023 2044 420a 0a20 2020 2020       # DB..     
-0003d1a0: 2020 2020 2020 2023 2074 6573 7420 6966         # test if
-0003d1b0: 206f 6e20 676f 6f64 2073 6964 6520 6f66   on good side of
-0003d1c0: 2064 6574 6563 746f 720a 2020 2020 2020   detector.      
-0003d1d0: 2020 2020 2020 7363 6130 203d 2028 0a20        sca0 = (. 
-0003d1e0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-0003d1f0: 7074 735f 785b 7070 5d20 2d20 6465 745f  pts_x[pp] - det_
-0003d200: 6365 6e74 735f 785b 6464 5d29 202a 2064  cents_x[dd]) * d
-0003d210: 6574 5f6e 6f72 6d5f 785b 6464 5d0a 2020  et_norm_x[dd].  
-0003d220: 2020 2020 2020 2020 2020 2020 2020 2b20                + 
-0003d230: 2870 7473 5f79 5b70 705d 202d 2064 6574  (pts_y[pp] - det
-0003d240: 5f63 656e 7473 5f79 5b64 645d 2920 2a20  _cents_y[dd]) * 
-0003d250: 6465 745f 6e6f 726d 5f79 5b64 645d 0a20  det_norm_y[dd]. 
-0003d260: 2020 2020 2020 2020 2020 2020 2020 202b                 +
-0003d270: 2028 7074 735f 7a5b 7070 5d20 2d20 6465   (pts_z[pp] - de
-0003d280: 745f 6365 6e74 735f 7a5b 6464 5d29 202a  t_cents_z[dd]) *
-0003d290: 2064 6574 5f6e 6f72 6d5f 7a5b 6464 5d0a   det_norm_z[dd].
-0003d2a0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-0003d2b0: 2020 2020 2020 2020 2020 2069 6620 7363             if sc
-0003d2c0: 6130 203c 3d20 303a 0a20 2020 2020 2020  a0 <= 0:.       
-0003d2d0: 2020 2020 2020 2020 2023 2070 7269 6e74           # print
-0003d2e0: 2827 736b 6970 272c 2073 6361 3029 2020  ('skip', sca0)  
-0003d2f0: 2020 2020 2020 2320 4442 0a20 2020 2020        # DB.     
-0003d300: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-0003d310: 6e75 650a 0a20 2020 2020 2020 2020 2020  nue..           
-0003d320: 2023 2066 6c61 670a 2020 2020 2020 2020   # flag.        
-0003d330: 2020 2020 6973 6f6b 203d 2054 7275 650a      isok = True.
-0003d340: 0a20 2020 2020 2020 2020 2020 2023 206c  .            # l
-0003d350: 6f6f 7020 333a 206f 6e20 6e61 2028 6170  oop 3: on na (ap
-0003d360: 6572 7475 7265 7329 0a20 2020 2020 2020  ertures).       
-0003d370: 2020 2020 2066 6f72 2061 6120 696e 2072       for aa in r
-0003d380: 616e 6765 286e 6129 3a0a 0a20 2020 2020  ange(na):..     
-0003d390: 2020 2020 2020 2020 2020 2023 2070 7269             # pri
-0003d3a0: 6e74 2827 6170 272c 2061 6129 0a20 2020  nt('ap', aa).   
-0003d3b0: 2020 2020 2020 2020 2020 2020 2023 2070               # p
-0003d3c0: 7269 6e74 2827 6170 2069 6e64 272c 2061  rint('ap ind', a
-0003d3d0: 705f 696e 645b 6161 5d2c 2061 705f 696e  p_ind[aa], ap_in
-0003d3e0: 645b 6161 2b31 5d29 0a20 2020 2020 2020  d[aa+1]).       
-0003d3f0: 2020 2020 2020 2020 2023 2070 7269 6e74           # print
-0003d400: 2827 6170 206e 696e 272c 2061 705f 6e6f  ('ap nin', ap_no
-0003d410: 726d 5f78 5b61 615d 2c20 6170 5f6e 6f72  rm_x[aa], ap_nor
-0003d420: 6d5f 795b 6161 5d2c 2061 705f 6e6f 726d  m_y[aa], ap_norm
-0003d430: 5f7a 5b61 615d 290a 2020 2020 2020 2020  _z[aa]).        
-0003d440: 2020 2020 2020 2020 2320 7072 696e 7428          # print(
-0003d450: 2761 705f 7827 2c20 6170 5f78 5b61 705f  'ap_x', ap_x[ap_
-0003d460: 696e 645b 6161 5d3a 6170 5f69 6e64 5b61  ind[aa]:ap_ind[a
-0003d470: 612b 315d 5d29 0a20 2020 2020 2020 2020  a+1]]).         
-0003d480: 2020 2020 2020 2023 2070 7269 6e74 2827         # print('
-0003d490: 6170 5f79 272c 2061 705f 795b 6170 5f69  ap_y', ap_y[ap_i
-0003d4a0: 6e64 5b61 615d 3a61 705f 696e 645b 6161  nd[aa]:ap_ind[aa
-0003d4b0: 2b31 5d5d 290a 2020 2020 2020 2020 2020  +1]]).          
-0003d4c0: 2020 2020 2020 2320 7072 696e 7428 2761        # print('a
-0003d4d0: 705f 7a27 2c20 6170 5f7a 5b61 705f 696e  p_z', ap_z[ap_in
-0003d4e0: 645b 6161 5d3a 6170 5f69 6e64 5b61 612b  d[aa]:ap_ind[aa+
-0003d4f0: 315d 5d29 0a0a 2020 2020 2020 2020 2020  1]])..          
-0003d500: 2020 2020 2020 2320 7465 7374 2069 6620        # test if 
-0003d510: 6f6e 2067 6f6f 6420 7369 6465 206f 6620  on good side of 
-0003d520: 6170 6572 7475 7265 0a20 2020 2020 2020  aperture.       
-0003d530: 2020 2020 2020 2020 2073 6361 203d 2028           sca = (
-0003d540: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003d550: 2020 2020 2028 7074 735f 785b 7070 5d20       (pts_x[pp] 
-0003d560: 2d20 6170 5f78 5b61 705f 696e 645b 6161  - ap_x[ap_ind[aa
-0003d570: 5d5d 2920 2a20 6170 5f6e 6f72 6d5f 785b  ]]) * ap_norm_x[
-0003d580: 6161 5d0a 2020 2020 2020 2020 2020 2020  aa].            
-0003d590: 2020 2020 2020 2020 2b20 2870 7473 5f79          + (pts_y
-0003d5a0: 5b70 705d 202d 2061 705f 795b 6170 5f69  [pp] - ap_y[ap_i
-0003d5b0: 6e64 5b61 615d 5d29 202a 2061 705f 6e6f  nd[aa]]) * ap_no
-0003d5c0: 726d 5f79 5b61 615d 0a20 2020 2020 2020  rm_y[aa].       
-0003d5d0: 2020 2020 2020 2020 2020 2020 202b 2028               + (
-0003d5e0: 7074 735f 7a5b 7070 5d20 2d20 6170 5f7a  pts_z[pp] - ap_z
-0003d5f0: 5b61 705f 696e 645b 6161 5d5d 2920 2a20  [ap_ind[aa]]) * 
-0003d600: 6170 5f6e 6f72 6d5f 7a5b 6161 5d0a 2020  ap_norm_z[aa].  
-0003d610: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0003d620: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003d630: 2069 6620 7363 6120 3c3d 2030 3a0a 2020   if sca <= 0:.  
+0003c690: 7472 695f 7a5b 305d 2c0a 2020 2020 2020  tri_z[0],.      
+0003c6a0: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+0003c6b0: 695f 785b 315d 2c0a 2020 2020 2020 2020  i_x[1],.        
+0003c6c0: 2020 2020 2020 2020 2020 2020 7472 695f              tri_
+0003c6d0: 795b 315d 2c0a 2020 2020 2020 2020 2020  y[1],.          
+0003c6e0: 2020 2020 2020 2020 2020 7472 695f 7a5b            tri_z[
+0003c6f0: 315d 2c0a 2020 2020 2020 2020 2020 2020  1],.            
+0003c700: 2020 2020 2020 2020 7472 695f 785b 325d          tri_x[2]
+0003c710: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0003c720: 2020 2020 2020 7472 695f 795b 325d 2c0a        tri_y[2],.
+0003c730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003c740: 2020 2020 7472 695f 7a5b 325d 2c0a 2020      tri_z[2],.  
+0003c750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003c760: 2020 7074 735f 785b 7070 5d2c 0a20 2020    pts_x[pp],.   
+0003c770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003c780: 2070 7473 5f79 5b70 705d 2c0a 2020 2020   pts_y[pp],.    
+0003c790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003c7a0: 7074 735f 7a5b 7070 5d2c 0a20 2020 2020  pts_z[pp],.     
+0003c7b0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0003c7c0: 2020 2020 2020 2020 2020 2020 2023 2070               # p
+0003c7d0: 7269 6e74 2827 7472 6927 2c20 7474 2c20  rint('tri', tt, 
+0003c7e0: 736f 6c69 645f 616e 676c 655b 6464 2c20  solid_angle[dd, 
+0003c7f0: 7070 5d29 2020 2020 2020 2020 2320 4442  pp])        # DB
+0003c800: 0a0a 2020 2020 2320 2d2d 2d2d 2d2d 2d0a  ..    # -------.
+0003c810: 2020 2020 2320 5265 7475 726e 0a0a 2020      # Return..  
+0003c820: 2020 7265 7475 726e 2073 6f6c 6964 5f61    return solid_a
+0003c830: 6e67 6c65 0a0a 0a64 6566 2063 6f6d 7075  ngle...def compu
+0003c840: 7465 5f73 6f6c 6964 5f61 6e67 6c65 5f61  te_solid_angle_a
+0003c850: 7065 7274 7572 6573 5f6c 6967 6874 5f73  pertures_light_s
+0003c860: 756d 6d65 6428 0a20 2020 2023 2070 7473  ummed(.    # pts
+0003c870: 3a20 636f 6f72 6469 6e61 7465 7320 6173  : coordinates as
+0003c880: 2074 6872 6565 2031 6420 6172 7261 7973   three 1d arrays
+0003c890: 0a20 2020 2064 6f75 626c 655b 3a3a 315d  .    double[::1]
+0003c8a0: 2070 7473 5f78 2c0a 2020 2020 646f 7562   pts_x,.    doub
+0003c8b0: 6c65 5b3a 3a31 5d20 7074 735f 792c 0a20  le[::1] pts_y,. 
+0003c8c0: 2020 2064 6f75 626c 655b 3a3a 315d 2070     double[::1] p
+0003c8d0: 7473 5f7a 2c0a 2020 2020 2320 6465 7465  ts_z,.    # dete
+0003c8e0: 6374 6f72 733a 2070 6f6c 7967 6f6e 2063  ctors: polygon c
+0003c8f0: 6f6f 7264 696e 6174 6573 2069 6e20 3264  oordinates in 2d
+0003c900: 2028 636f 6d6d 6f6e 2074 6f20 616c 6c20   (common to all 
+0003c910: 6465 7465 6374 6f72 7329 0a20 2020 2064  detectors).    d
+0003c920: 6f75 626c 655b 3a3a 315d 2064 6574 5f6f  ouble[::1] det_o
+0003c930: 7574 6c69 6e65 5f78 302c 0a20 2020 2064  utline_x0,.    d
+0003c940: 6f75 626c 655b 3a3a 315d 2064 6574 5f6f  ouble[::1] det_o
+0003c950: 7574 6c69 6e65 5f78 312c 0a20 2020 2023  utline_x1,.    #
+0003c960: 2064 6574 6563 746f 7273 3a20 6365 6e74   detectors: cent
+0003c970: 6572 7320 636f 6f72 6469 6e61 7465 7320  ers coordinates 
+0003c980: 6173 2074 6872 6565 2031 6420 6172 7261  as three 1d arra
+0003c990: 7973 0a20 2020 2064 6f75 626c 655b 3a3a  ys.    double[::
+0003c9a0: 315d 2064 6574 5f63 656e 7473 5f78 2c0a  1] det_cents_x,.
+0003c9b0: 2020 2020 646f 7562 6c65 5b3a 3a31 5d20      double[::1] 
+0003c9c0: 6465 745f 6365 6e74 735f 792c 0a20 2020  det_cents_y,.   
+0003c9d0: 2064 6f75 626c 655b 3a3a 315d 2064 6574   double[::1] det
+0003c9e0: 5f63 656e 7473 5f7a 2c0a 2020 2020 2320  _cents_z,.    # 
+0003c9f0: 6465 7465 6374 6f72 733a 206e 6f72 6d61  detectors: norma
+0003ca00: 6c20 756e 6974 2076 6563 746f 7273 2061  l unit vectors a
+0003ca10: 7320 7468 7265 6520 3164 2061 7272 6179  s three 1d array
+0003ca20: 7320 286e 6420 3d20 6c65 6e28 6465 745f  s (nd = len(det_
+0003ca30: 6e6f 726d 5f78 2929 0a20 2020 2064 6f75  norm_x)).    dou
+0003ca40: 626c 655b 3a3a 315d 2064 6574 5f6e 6f72  ble[::1] det_nor
+0003ca50: 6d5f 782c 0a20 2020 2064 6f75 626c 655b  m_x,.    double[
+0003ca60: 3a3a 315d 2064 6574 5f6e 6f72 6d5f 792c  ::1] det_norm_y,
+0003ca70: 0a20 2020 2064 6f75 626c 655b 3a3a 315d  .    double[::1]
+0003ca80: 2064 6574 5f6e 6f72 6d5f 7a2c 0a20 2020   det_norm_z,.   
+0003ca90: 206e 702e 6e64 6172 7261 795b 646f 7562   np.ndarray[doub
+0003caa0: 6c65 2c20 6e64 696d 3d31 5d20 6465 745f  le, ndim=1] det_
+0003cab0: 6530 5f78 2c0a 2020 2020 6e70 2e6e 6461  e0_x,.    np.nda
+0003cac0: 7272 6179 5b64 6f75 626c 652c 206e 6469  rray[double, ndi
+0003cad0: 6d3d 315d 2064 6574 5f65 305f 792c 0a20  m=1] det_e0_y,. 
+0003cae0: 2020 206e 702e 6e64 6172 7261 795b 646f     np.ndarray[do
+0003caf0: 7562 6c65 2c20 6e64 696d 3d31 5d20 6465  uble, ndim=1] de
+0003cb00: 745f 6530 5f7a 2c0a 2020 2020 6e70 2e6e  t_e0_z,.    np.n
+0003cb10: 6461 7272 6179 5b64 6f75 626c 652c 206e  darray[double, n
+0003cb20: 6469 6d3d 315d 2064 6574 5f65 315f 782c  dim=1] det_e1_x,
+0003cb30: 0a20 2020 206e 702e 6e64 6172 7261 795b  .    np.ndarray[
+0003cb40: 646f 7562 6c65 2c20 6e64 696d 3d31 5d20  double, ndim=1] 
+0003cb50: 6465 745f 6531 5f79 2c0a 2020 2020 6e70  det_e1_y,.    np
+0003cb60: 2e6e 6461 7272 6179 5b64 6f75 626c 652c  .ndarray[double,
+0003cb70: 206e 6469 6d3d 315d 2064 6574 5f65 315f   ndim=1] det_e1_
+0003cb80: 7a2c 0a20 2020 2023 2061 7065 7274 7572  z,.    # apertur
+0003cb90: 6573 3a20 696e 6469 6365 7320 6f66 2066  es: indices of f
+0003cba0: 6972 7374 2063 6f72 6e65 7220 6f66 2065  irst corner of e
+0003cbb0: 6163 6820 6170 2070 6f6c 7967 6f6e 3a20  ach ap polygon: 
+0003cbc0: 6e61 203d 206c 656e 2861 705f 696e 6429  na = len(ap_ind)
+0003cbd0: 0a20 2020 206c 6f6e 675b 3a3a 315d 2061  .    long[::1] a
+0003cbe0: 705f 696e 642c 0a20 2020 2023 2061 7065  p_ind,.    # ape
+0003cbf0: 7274 7572 6573 3a20 706f 6c79 676f 6e20  rtures: polygon 
+0003cc00: 636f 6f72 6469 6e61 7465 7320 6173 2074  coordinates as t
+0003cc10: 6872 6565 2031 6420 6172 7261 7973 0a20  hree 1d arrays. 
+0003cc20: 2020 206e 702e 6e64 6172 7261 795b 646f     np.ndarray[do
+0003cc30: 7562 6c65 2c20 6e64 696d 3d31 5d20 6170  uble, ndim=1] ap
+0003cc40: 5f78 2c0a 2020 2020 6e70 2e6e 6461 7272  _x,.    np.ndarr
+0003cc50: 6179 5b64 6f75 626c 652c 206e 6469 6d3d  ay[double, ndim=
+0003cc60: 315d 2061 705f 792c 0a20 2020 206e 702e  1] ap_y,.    np.
+0003cc70: 6e64 6172 7261 795b 646f 7562 6c65 2c20  ndarray[double, 
+0003cc80: 6e64 696d 3d31 5d20 6170 5f7a 2c0a 2020  ndim=1] ap_z,.  
+0003cc90: 2020 2320 6e6f 726d 616c 2075 6e69 7420    # normal unit 
+0003cca0: 7665 6374 6f72 730a 2020 2020 646f 7562  vectors.    doub
+0003ccb0: 6c65 5b3a 3a31 5d20 6170 5f6e 6f72 6d5f  le[::1] ap_norm_
+0003ccc0: 782c 0a20 2020 2064 6f75 626c 655b 3a3a  x,.    double[::
+0003ccd0: 315d 2061 705f 6e6f 726d 5f79 2c0a 2020  1] ap_norm_y,.  
+0003cce0: 2020 646f 7562 6c65 5b3a 3a31 5d20 6170    double[::1] ap
+0003ccf0: 5f6e 6f72 6d5f 7a2c 0a20 2020 2023 2070  _norm_z,.    # p
+0003cd00: 6f73 7369 626c 6520 6578 7472 6120 7061  ossible extra pa
+0003cd10: 7261 6d65 7465 7273 203f 0a20 2020 2064  rameters ?.    d
+0003cd20: 6f75 626c 6520 6d61 7267 696e 3d5f 5653  ouble margin=_VS
+0003cd30: 4d41 4c4c 2c0a 2020 2020 696e 7420 6e75  MALL,.    int nu
+0003cd40: 6d5f 7468 7265 6164 733d 3130 2c0a 293a  m_threads=10,.):
+0003cd50: 0a0a 2020 2020 2320 2d2d 2d2d 2d2d 2d2d  ..    # --------
+0003cd60: 2d2d 2d0a 2020 2020 2320 4465 636c 6172  ---.    # Declar
+0003cd70: 6174 696f 6e0a 0a20 2020 2063 6465 6620  ation..    cdef 
+0003cd80: 696e 7420 6e70 7473 203d 2070 7473 5f78  int npts = pts_x
+0003cd90: 2e73 697a 650a 2020 2020 6364 6566 2069  .size.    cdef i
+0003cda0: 6e74 206e 6420 3d20 6465 745f 6365 6e74  nt nd = det_cent
+0003cdb0: 735f 782e 7369 7a65 0a20 2020 2063 6465  s_x.size.    cde
+0003cdc0: 6620 696e 7420 6e61 203d 2061 705f 6e6f  f int na = ap_no
+0003cdd0: 726d 5f78 2e73 697a 650a 2020 2020 6364  rm_x.size.    cd
+0003cde0: 6566 2069 6e74 2064 642c 2070 702c 2061  ef int dd, pp, a
+0003cdf0: 612c 2074 740a 2020 2020 6364 6566 2069  a, tt.    cdef i
+0003ce00: 6e74 206e 7061 0a20 2020 2063 6465 6620  nt npa.    cdef 
+0003ce10: 666c 6f61 7420 7363 612c 2073 6361 302c  float sca, sca0,
+0003ce20: 2073 6361 310a 2020 2020 6364 6566 2066   sca1.    cdef f
+0003ce30: 6c6f 6174 206b 690a 2020 2020 6364 6566  loat ki.    cdef
+0003ce40: 206e 702e 6e64 6172 7261 795b 646f 7562   np.ndarray[doub
+0003ce50: 6c65 2c20 6e64 696d 3d31 5d20 6170 5f78  le, ndim=1] ap_x
+0003ce60: 3020 3d20 6e70 2e63 6f70 7928 6170 5f78  0 = np.copy(ap_x
+0003ce70: 290a 2020 2020 6364 6566 206e 702e 6e64  ).    cdef np.nd
+0003ce80: 6172 7261 795b 646f 7562 6c65 2c20 6e64  array[double, nd
+0003ce90: 696d 3d31 5d20 6170 5f78 3120 3d20 6e70  im=1] ap_x1 = np
+0003cea0: 2e63 6f70 7928 6170 5f78 290a 2020 2020  .copy(ap_x).    
+0003ceb0: 6364 6566 206e 702e 6e64 6172 7261 795b  cdef np.ndarray[
+0003cec0: 646f 7562 6c65 2c20 6e64 696d 3d31 5d20  double, ndim=1] 
+0003ced0: 705f 615f 7830 0a20 2020 2063 6465 6620  p_a_x0.    cdef 
+0003cee0: 6e70 2e6e 6461 7272 6179 5b64 6f75 626c  np.ndarray[doubl
+0003cef0: 652c 206e 6469 6d3d 315d 2070 5f61 5f78  e, ndim=1] p_a_x
+0003cf00: 310a 2020 2020 6364 6566 206e 702e 6e64  1.    cdef np.nd
+0003cf10: 6172 7261 795b 6c6f 6e67 2c20 6e64 696d  array[long, ndim
+0003cf20: 3d32 5d20 7472 690a 2020 2020 6364 6566  =2] tri.    cdef
+0003cf30: 206e 702e 6e64 6172 7261 795b 646f 7562   np.ndarray[doub
+0003cf40: 6c65 2c20 6e64 696d 3d31 5d20 7472 695f  le, ndim=1] tri_
+0003cf50: 780a 2020 2020 6364 6566 206e 702e 6e64  x.    cdef np.nd
+0003cf60: 6172 7261 795b 646f 7562 6c65 2c20 6e64  array[double, nd
+0003cf70: 696d 3d31 5d20 7472 695f 790a 2020 2020  im=1] tri_y.    
+0003cf80: 6364 6566 206e 702e 6e64 6172 7261 795b  cdef np.ndarray[
+0003cf90: 646f 7562 6c65 2c20 6e64 696d 3d31 5d20  double, ndim=1] 
+0003cfa0: 7472 695f 7a0a 0a20 2020 2023 2069 6e69  tri_z..    # ini
+0003cfb0: 7469 616c 697a 6520 736f 6c69 6420 616e  tialize solid an
+0003cfc0: 676c 6520 6172 7261 7920 7769 7468 207a  gle array with z
+0003cfd0: 6572 6f73 0a20 2020 2063 6465 6620 666c  eros.    cdef fl
+0003cfe0: 6f61 7420 736f 6c69 645f 616e 676c 6520  oat solid_angle 
+0003cff0: 3d20 302e 0a0a 2020 2020 2320 2d2d 2d2d  = 0...    # ----
+0003d000: 2d2d 2d0a 2020 2020 2320 436f 6d70 7574  ---.    # Comput
+0003d010: 650a 0a20 2020 2066 6f72 2064 6420 696e  e..    for dd in
+0003d020: 2072 616e 6765 286e 6429 3a0a 0a20 2020   range(nd):..   
+0003d030: 2020 2020 2023 2070 7269 6e74 2827 6465       # print('de
+0003d040: 745f 6365 6e74 272c 2064 6574 5f63 656e  t_cent', det_cen
+0003d050: 7473 5f78 5b64 645d 2c20 6465 745f 6365  ts_x[dd], det_ce
+0003d060: 6e74 735f 795b 6464 5d2c 2064 6574 5f63  nts_y[dd], det_c
+0003d070: 656e 7473 5f7a 5b64 645d 290a 2020 2020  ents_z[dd]).    
+0003d080: 2020 2020 2320 7072 696e 7428 2764 6574      # print('det
+0003d090: 5f6e 696e 272c 2064 6574 5f6e 6f72 6d5f  _nin', det_norm_
+0003d0a0: 785b 6464 5d2c 2064 6574 5f6e 6f72 6d5f  x[dd], det_norm_
+0003d0b0: 795b 6464 5d2c 2064 6574 5f6e 6f72 6d5f  y[dd], det_norm_
+0003d0c0: 7a5b 6464 5d29 2020 2020 2020 2020 2320  z[dd])        # 
+0003d0d0: 4442 0a20 2020 2020 2020 2023 2070 7269  DB.        # pri
+0003d0e0: 6e74 2827 6465 745f 6530 272c 2064 6574  nt('det_e0', det
+0003d0f0: 5f65 305f 785b 6464 5d2c 2064 6574 5f65  _e0_x[dd], det_e
+0003d100: 305f 795b 6464 5d2c 2064 6574 5f65 305f  0_y[dd], det_e0_
+0003d110: 7a5b 6464 5d29 2020 2020 2020 2020 2320  z[dd])        # 
+0003d120: 4442 0a20 2020 2020 2020 2023 2070 7269  DB.        # pri
+0003d130: 6e74 2827 6465 745f 6531 272c 2064 6574  nt('det_e1', det
+0003d140: 5f65 315f 785b 6464 5d2c 2064 6574 5f65  _e1_x[dd], det_e
+0003d150: 315f 795b 6464 5d2c 2064 6574 5f65 315f  1_y[dd], det_e1_
+0003d160: 7a5b 6464 5d29 2020 2020 2020 2020 2320  z[dd])        # 
+0003d170: 4442 0a0a 2020 2020 2020 2020 2320 6c6f  DB..        # lo
+0003d180: 6f70 2032 3a20 6f6e 206e 7074 7320 286f  op 2: on npts (o
+0003d190: 6273 6572 7661 7469 6f6e 2070 6f69 6e74  bservation point
+0003d1a0: 7329 0a20 2020 2020 2020 2066 6f72 2070  s).        for p
+0003d1b0: 7020 696e 2072 616e 6765 286e 7074 7329  p in range(npts)
+0003d1c0: 3a0a 0a20 2020 2020 2020 2020 2020 2023  :..            #
+0003d1d0: 2070 7269 6e74 2827 7074 7327 2c20 7070   print('pts', pp
+0003d1e0: 2c20 7074 735f 785b 7070 5d2c 2070 7473  , pts_x[pp], pts
+0003d1f0: 5f79 5b70 705d 2c20 7074 735f 7a5b 7070  _y[pp], pts_z[pp
+0003d200: 5d29 2020 2020 2020 2020 2320 4442 0a0a  ])        # DB..
+0003d210: 2020 2020 2020 2020 2020 2020 2320 7465              # te
+0003d220: 7374 2069 6620 6f6e 2067 6f6f 6420 7369  st if on good si
+0003d230: 6465 206f 6620 6465 7465 6374 6f72 0a20  de of detector. 
+0003d240: 2020 2020 2020 2020 2020 2073 6361 3020             sca0 
+0003d250: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+0003d260: 2020 2020 2870 7473 5f78 5b70 705d 202d      (pts_x[pp] -
+0003d270: 2064 6574 5f63 656e 7473 5f78 5b64 645d   det_cents_x[dd]
+0003d280: 2920 2a20 6465 745f 6e6f 726d 5f78 5b64  ) * det_norm_x[d
+0003d290: 645d 0a20 2020 2020 2020 2020 2020 2020  d].             
+0003d2a0: 2020 202b 2028 7074 735f 795b 7070 5d20     + (pts_y[pp] 
+0003d2b0: 2d20 6465 745f 6365 6e74 735f 795b 6464  - det_cents_y[dd
+0003d2c0: 5d29 202a 2064 6574 5f6e 6f72 6d5f 795b  ]) * det_norm_y[
+0003d2d0: 6464 5d0a 2020 2020 2020 2020 2020 2020  dd].            
+0003d2e0: 2020 2020 2b20 2870 7473 5f7a 5b70 705d      + (pts_z[pp]
+0003d2f0: 202d 2064 6574 5f63 656e 7473 5f7a 5b64   - det_cents_z[d
+0003d300: 645d 2920 2a20 6465 745f 6e6f 726d 5f7a  d]) * det_norm_z
+0003d310: 5b64 645d 0a20 2020 2020 2020 2020 2020  [dd].           
+0003d320: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
+0003d330: 6966 2073 6361 3020 3c3d 2030 3a0a 2020  if sca0 <= 0:.  
+0003d340: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0003d350: 7072 696e 7428 2773 6b69 7027 2c20 7363  print('skip', sc
+0003d360: 6130 2920 2020 2020 2020 2023 2044 420a  a0)        # DB.
+0003d370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d380: 636f 6e74 696e 7565 0a0a 2020 2020 2020  continue..      
+0003d390: 2020 2020 2020 2320 666c 6167 0a20 2020        # flag.   
+0003d3a0: 2020 2020 2020 2020 2069 736f 6b20 3d20           isok = 
+0003d3b0: 5472 7565 0a0a 2020 2020 2020 2020 2020  True..          
+0003d3c0: 2020 2320 6c6f 6f70 2033 3a20 6f6e 206e    # loop 3: on n
+0003d3d0: 6120 2861 7065 7274 7572 6573 290a 2020  a (apertures).  
+0003d3e0: 2020 2020 2020 2020 2020 666f 7220 6161            for aa
+0003d3f0: 2069 6e20 7261 6e67 6528 6e61 293a 0a0a   in range(na):..
+0003d400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d410: 2320 7072 696e 7428 2761 7027 2c20 6161  # print('ap', aa
+0003d420: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0003d430: 2020 2320 7072 696e 7428 2761 7020 696e    # print('ap in
+0003d440: 6427 2c20 6170 5f69 6e64 5b61 615d 2c20  d', ap_ind[aa], 
+0003d450: 6170 5f69 6e64 5b61 612b 315d 290a 2020  ap_ind[aa+1]).  
+0003d460: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0003d470: 7072 696e 7428 2761 7020 6e69 6e27 2c20  print('ap nin', 
+0003d480: 6170 5f6e 6f72 6d5f 785b 6161 5d2c 2061  ap_norm_x[aa], a
+0003d490: 705f 6e6f 726d 5f79 5b61 615d 2c20 6170  p_norm_y[aa], ap
+0003d4a0: 5f6e 6f72 6d5f 7a5b 6161 5d29 0a20 2020  _norm_z[aa]).   
+0003d4b0: 2020 2020 2020 2020 2020 2020 2023 2070               # p
+0003d4c0: 7269 6e74 2827 6170 5f78 272c 2061 705f  rint('ap_x', ap_
+0003d4d0: 785b 6170 5f69 6e64 5b61 615d 3a61 705f  x[ap_ind[aa]:ap_
+0003d4e0: 696e 645b 6161 2b31 5d5d 290a 2020 2020  ind[aa+1]]).    
+0003d4f0: 2020 2020 2020 2020 2020 2020 2320 7072              # pr
+0003d500: 696e 7428 2761 705f 7927 2c20 6170 5f79  int('ap_y', ap_y
+0003d510: 5b61 705f 696e 645b 6161 5d3a 6170 5f69  [ap_ind[aa]:ap_i
+0003d520: 6e64 5b61 612b 315d 5d29 0a20 2020 2020  nd[aa+1]]).     
+0003d530: 2020 2020 2020 2020 2020 2023 2070 7269             # pri
+0003d540: 6e74 2827 6170 5f7a 272c 2061 705f 7a5b  nt('ap_z', ap_z[
+0003d550: 6170 5f69 6e64 5b61 615d 3a61 705f 696e  ap_ind[aa]:ap_in
+0003d560: 645b 6161 2b31 5d5d 290a 0a20 2020 2020  d[aa+1]])..     
+0003d570: 2020 2020 2020 2020 2020 2023 2074 6573             # tes
+0003d580: 7420 6966 206f 6e20 676f 6f64 2073 6964  t if on good sid
+0003d590: 6520 6f66 2061 7065 7274 7572 650a 2020  e of aperture.  
+0003d5a0: 2020 2020 2020 2020 2020 2020 2020 7363                sc
+0003d5b0: 6120 3d20 280a 2020 2020 2020 2020 2020  a = (.          
+0003d5c0: 2020 2020 2020 2020 2020 2870 7473 5f78            (pts_x
+0003d5d0: 5b70 705d 202d 2061 705f 785b 6170 5f69  [pp] - ap_x[ap_i
+0003d5e0: 6e64 5b61 615d 5d29 202a 2061 705f 6e6f  nd[aa]]) * ap_no
+0003d5f0: 726d 5f78 5b61 615d 0a20 2020 2020 2020  rm_x[aa].       
+0003d600: 2020 2020 2020 2020 2020 2020 202b 2028               + (
+0003d610: 7074 735f 795b 7070 5d20 2d20 6170 5f79  pts_y[pp] - ap_y
+0003d620: 5b61 705f 696e 645b 6161 5d5d 2920 2a20  [ap_ind[aa]]) * 
+0003d630: 6170 5f6e 6f72 6d5f 795b 6161 5d0a 2020  ap_norm_y[aa].  
 0003d640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d650: 2020 6973 6f6b 203d 2046 616c 7365 0a20    isok = False. 
-0003d660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d670: 2020 2062 7265 616b 0a0a 2020 2020 2020     break..      
-0003d680: 2020 2020 2020 2020 2020 2320 7465 7374            # test
-0003d690: 2069 6620 616c 6c20 6170 6572 7475 7265   if all aperture
-0003d6a0: 2070 6f69 6e74 7320 6361 6e20 6265 2070   points can be p
-0003d6b0: 726f 6a65 6374 6564 206f 6e20 6465 7465  rojected on dete
-0003d6c0: 6374 6f72 2070 6c61 6e65 2066 726f 6d20  ctor plane from 
-0003d6d0: 7074 730a 2020 2020 2020 2020 2020 2020  pts.            
-0003d6e0: 2020 2020 666f 7220 6c6c 2069 6e20 7261      for ll in ra
-0003d6f0: 6e67 6528 6170 5f69 6e64 5b61 615d 2c20  nge(ap_ind[aa], 
-0003d700: 6170 5f69 6e64 5b61 612b 315d 293a 0a20  ap_ind[aa+1]):. 
-0003d710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d720: 2020 2073 6361 3120 3d20 280a 2020 2020     sca1 = (.    
-0003d730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d740: 2020 2020 2861 705f 785b 6c6c 5d20 2d20      (ap_x[ll] - 
-0003d750: 7074 735f 785b 7070 5d29 202a 2064 6574  pts_x[pp]) * det
-0003d760: 5f6e 6f72 6d5f 785b 6464 5d0a 2020 2020  _norm_x[dd].    
-0003d770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d780: 2020 2020 2b20 2861 705f 795b 6c6c 5d20      + (ap_y[ll] 
-0003d790: 2d20 7074 735f 795b 7070 5d29 202a 2064  - pts_y[pp]) * d
-0003d7a0: 6574 5f6e 6f72 6d5f 795b 6464 5d0a 2020  et_norm_y[dd].  
-0003d7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d7c0: 2020 2020 2020 2b20 2861 705f 7a5b 6c6c        + (ap_z[ll
-0003d7d0: 5d20 2d20 7074 735f 7a5b 7070 5d29 202a  ] - pts_z[pp]) *
-0003d7e0: 2064 6574 5f6e 6f72 6d5f 7a5b 6464 5d0a   det_norm_z[dd].
-0003d7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d800: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
-0003d810: 2020 2020 2020 2020 2020 2069 6620 7363             if sc
-0003d820: 6131 203e 3d20 303a 0a20 2020 2020 2020  a1 >= 0:.       
-0003d830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d840: 2069 736f 6b20 3d20 4661 6c73 650a 2020   isok = False.  
-0003d850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d860: 2020 2020 2020 6272 6561 6b0a 0a20 2020        break..   
-0003d870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d880: 2023 2070 726f 6a65 6374 2069 6e20 3264   # project in 2d
-0003d890: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003d8a0: 2020 2020 206b 203d 202d 2073 6361 3020       k = - sca0 
-0003d8b0: 2f20 7363 6131 0a20 2020 2020 2020 2020  / sca1.         
-0003d8c0: 2020 2020 2020 2020 2020 2050 5f78 203d             P_x =
-0003d8d0: 2070 7473 5f78 5b70 705d 202b 206b 202a   pts_x[pp] + k *
-0003d8e0: 2028 6170 5f78 5b6c 6c5d 202d 2070 7473   (ap_x[ll] - pts
-0003d8f0: 5f78 5b70 705d 290a 2020 2020 2020 2020  _x[pp]).        
-0003d900: 2020 2020 2020 2020 2020 2020 505f 7920              P_y 
-0003d910: 3d20 7074 735f 795b 7070 5d20 2b20 6b20  = pts_y[pp] + k 
-0003d920: 2a20 2861 705f 795b 6c6c 5d20 2d20 7074  * (ap_y[ll] - pt
-0003d930: 735f 795b 7070 5d29 0a20 2020 2020 2020  s_y[pp]).       
-0003d940: 2020 2020 2020 2020 2020 2020 2050 5f7a               P_z
-0003d950: 203d 2070 7473 5f7a 5b70 705d 202b 206b   = pts_z[pp] + k
-0003d960: 202a 2028 6170 5f7a 5b6c 6c5d 202d 2070   * (ap_z[ll] - p
-0003d970: 7473 5f7a 5b70 705d 290a 0a20 2020 2020  ts_z[pp])..     
-0003d980: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0003d990: 2070 726f 6a65 6374 2069 6e20 3264 0a20   project in 2d. 
-0003d9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d9b0: 2020 2061 705f 7830 5b6c 6c5d 203d 2028     ap_x0[ll] = (
-0003d9c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003d9d0: 2020 2020 2020 2020 2028 505f 7820 2d20           (P_x - 
-0003d9e0: 6465 745f 6365 6e74 735f 785b 6464 5d29  det_cents_x[dd])
-0003d9f0: 202a 2064 6574 5f65 305f 785b 6464 5d0a   * det_e0_x[dd].
-0003da00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003da10: 2020 2020 2020 2020 2b20 2850 5f79 202d          + (P_y -
-0003da20: 2064 6574 5f63 656e 7473 5f79 5b64 645d   det_cents_y[dd]
-0003da30: 2920 2a20 6465 745f 6530 5f79 5b64 645d  ) * det_e0_y[dd]
-0003da40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003da50: 2020 2020 2020 2020 202b 2028 505f 7a20           + (P_z 
-0003da60: 2d20 6465 745f 6365 6e74 735f 7a5b 6464  - det_cents_z[dd
-0003da70: 5d29 202a 2064 6574 5f65 305f 7a5b 6464  ]) * det_e0_z[dd
-0003da80: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0003da90: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0003daa0: 2020 2020 2020 2020 2020 2020 6170 5f78              ap_x
-0003dab0: 315b 6c6c 5d20 3d20 280a 2020 2020 2020  1[ll] = (.      
-0003dac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003dad0: 2020 2850 5f78 202d 2064 6574 5f63 656e    (P_x - det_cen
-0003dae0: 7473 5f78 5b64 645d 2920 2a20 6465 745f  ts_x[dd]) * det_
-0003daf0: 6531 5f78 5b64 645d 0a20 2020 2020 2020  e1_x[dd].       
-0003db00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003db10: 202b 2028 505f 7920 2d20 6465 745f 6365   + (P_y - det_ce
-0003db20: 6e74 735f 795b 6464 5d29 202a 2064 6574  nts_y[dd]) * det
-0003db30: 5f65 315f 795b 6464 5d0a 2020 2020 2020  _e1_y[dd].      
-0003db40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003db50: 2020 2b20 2850 5f7a 202d 2064 6574 5f63    + (P_z - det_c
-0003db60: 656e 7473 5f7a 5b64 645d 2920 2a20 6465  ents_z[dd]) * de
-0003db70: 745f 6531 5f7a 5b64 645d 0a20 2020 2020  t_e1_z[dd].     
-0003db80: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0003db90: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0003dba0: 2020 6966 206e 6f74 2069 736f 6b3a 0a20    if not isok:. 
+0003d650: 2020 2b20 2870 7473 5f7a 5b70 705d 202d    + (pts_z[pp] -
+0003d660: 2061 705f 7a5b 6170 5f69 6e64 5b61 615d   ap_z[ap_ind[aa]
+0003d670: 5d29 202a 2061 705f 6e6f 726d 5f7a 5b61  ]) * ap_norm_z[a
+0003d680: 615d 0a20 2020 2020 2020 2020 2020 2020  a].             
+0003d690: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
+0003d6a0: 2020 2020 2020 6966 2073 6361 203c 3d20        if sca <= 
+0003d6b0: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+0003d6c0: 2020 2020 2020 2069 736f 6b20 3d20 4661         isok = Fa
+0003d6d0: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
+0003d6e0: 2020 2020 2020 2020 6272 6561 6b0a 0a20          break.. 
+0003d6f0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0003d700: 2074 6573 7420 6966 2061 6c6c 2061 7065   test if all ape
+0003d710: 7274 7572 6520 706f 696e 7473 2063 616e  rture points can
+0003d720: 2062 6520 7072 6f6a 6563 7465 6420 6f6e   be projected on
+0003d730: 2064 6574 6563 746f 7220 706c 616e 6520   detector plane 
+0003d740: 6672 6f6d 2070 7473 0a20 2020 2020 2020  from pts.       
+0003d750: 2020 2020 2020 2020 2066 6f72 206c 6c20           for ll 
+0003d760: 696e 2072 616e 6765 2861 705f 696e 645b  in range(ap_ind[
+0003d770: 6161 5d2c 2061 705f 696e 645b 6161 2b31  aa], ap_ind[aa+1
+0003d780: 5d29 3a0a 2020 2020 2020 2020 2020 2020  ]):.            
+0003d790: 2020 2020 2020 2020 7363 6131 203d 2028          sca1 = (
+0003d7a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003d7b0: 2020 2020 2020 2020 2028 6170 5f78 5b6c           (ap_x[l
+0003d7c0: 6c5d 202d 2070 7473 5f78 5b70 705d 2920  l] - pts_x[pp]) 
+0003d7d0: 2a20 6465 745f 6e6f 726d 5f78 5b64 645d  * det_norm_x[dd]
+0003d7e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003d7f0: 2020 2020 2020 2020 202b 2028 6170 5f79           + (ap_y
+0003d800: 5b6c 6c5d 202d 2070 7473 5f79 5b70 705d  [ll] - pts_y[pp]
+0003d810: 2920 2a20 6465 745f 6e6f 726d 5f79 5b64  ) * det_norm_y[d
+0003d820: 645d 0a20 2020 2020 2020 2020 2020 2020  d].             
+0003d830: 2020 2020 2020 2020 2020 202b 2028 6170             + (ap
+0003d840: 5f7a 5b6c 6c5d 202d 2070 7473 5f7a 5b70  _z[ll] - pts_z[p
+0003d850: 705d 2920 2a20 6465 745f 6e6f 726d 5f7a  p]) * det_norm_z
+0003d860: 5b64 645d 0a20 2020 2020 2020 2020 2020  [dd].           
+0003d870: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+0003d880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d890: 6966 2073 6361 3120 3e3d 2030 3a0a 2020  if sca1 >= 0:.  
+0003d8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d8b0: 2020 2020 2020 6973 6f6b 203d 2046 616c        isok = Fal
+0003d8c0: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
+0003d8d0: 2020 2020 2020 2020 2020 2062 7265 616b             break
+0003d8e0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0003d8f0: 2020 2020 2020 2320 7072 6f6a 6563 7420        # project 
+0003d900: 696e 2032 640a 2020 2020 2020 2020 2020  in 2d.          
+0003d910: 2020 2020 2020 2020 2020 6b20 3d20 2d20            k = - 
+0003d920: 7363 6130 202f 2073 6361 310a 2020 2020  sca0 / sca1.    
+0003d930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d940: 505f 7820 3d20 7074 735f 785b 7070 5d20  P_x = pts_x[pp] 
+0003d950: 2b20 6b20 2a20 2861 705f 785b 6c6c 5d20  + k * (ap_x[ll] 
+0003d960: 2d20 7074 735f 785b 7070 5d29 0a20 2020  - pts_x[pp]).   
+0003d970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d980: 2050 5f79 203d 2070 7473 5f79 5b70 705d   P_y = pts_y[pp]
+0003d990: 202b 206b 202a 2028 6170 5f79 5b6c 6c5d   + k * (ap_y[ll]
+0003d9a0: 202d 2070 7473 5f79 5b70 705d 290a 2020   - pts_y[pp]).  
+0003d9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d9c0: 2020 505f 7a20 3d20 7074 735f 7a5b 7070    P_z = pts_z[pp
+0003d9d0: 5d20 2b20 6b20 2a20 2861 705f 7a5b 6c6c  ] + k * (ap_z[ll
+0003d9e0: 5d20 2d20 7074 735f 7a5b 7070 5d29 0a0a  ] - pts_z[pp])..
+0003d9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003da00: 2020 2020 2320 7072 6f6a 6563 7420 696e      # project in
+0003da10: 2032 640a 2020 2020 2020 2020 2020 2020   2d.            
+0003da20: 2020 2020 2020 2020 6170 5f78 305b 6c6c          ap_x0[ll
+0003da30: 5d20 3d20 280a 2020 2020 2020 2020 2020  ] = (.          
+0003da40: 2020 2020 2020 2020 2020 2020 2020 2850                (P
+0003da50: 5f78 202d 2064 6574 5f63 656e 7473 5f78  _x - det_cents_x
+0003da60: 5b64 645d 2920 2a20 6465 745f 6530 5f78  [dd]) * det_e0_x
+0003da70: 5b64 645d 0a20 2020 2020 2020 2020 2020  [dd].           
+0003da80: 2020 2020 2020 2020 2020 2020 202b 2028               + (
+0003da90: 505f 7920 2d20 6465 745f 6365 6e74 735f  P_y - det_cents_
+0003daa0: 795b 6464 5d29 202a 2064 6574 5f65 305f  y[dd]) * det_e0_
+0003dab0: 795b 6464 5d0a 2020 2020 2020 2020 2020  y[dd].          
+0003dac0: 2020 2020 2020 2020 2020 2020 2020 2b20                + 
+0003dad0: 2850 5f7a 202d 2064 6574 5f63 656e 7473  (P_z - det_cents
+0003dae0: 5f7a 5b64 645d 2920 2a20 6465 745f 6530  _z[dd]) * det_e0
+0003daf0: 5f7a 5b64 645d 0a20 2020 2020 2020 2020  _z[dd].         
+0003db00: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0003db10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003db20: 2061 705f 7831 5b6c 6c5d 203d 2028 0a20   ap_x1[ll] = (. 
+0003db30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003db40: 2020 2020 2020 2028 505f 7820 2d20 6465         (P_x - de
+0003db50: 745f 6365 6e74 735f 785b 6464 5d29 202a  t_cents_x[dd]) *
+0003db60: 2064 6574 5f65 315f 785b 6464 5d0a 2020   det_e1_x[dd].  
+0003db70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003db80: 2020 2020 2020 2b20 2850 5f79 202d 2064        + (P_y - d
+0003db90: 6574 5f63 656e 7473 5f79 5b64 645d 2920  et_cents_y[dd]) 
+0003dba0: 2a20 6465 745f 6531 5f79 5b64 645d 0a20  * det_e1_y[dd]. 
 0003dbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003dbc0: 2020 2062 7265 616b 0a0a 2020 2020 2020     break..      
-0003dbd0: 2020 2020 2020 2020 2020 2320 7072 696e            # prin
-0003dbe0: 7428 2773 6361 302c 2073 6361 312c 206b  t('sca0, sca1, k
-0003dbf0: 2020 272c 2073 6361 302c 2073 6361 312c    ', sca0, sca1,
-0003dc00: 206b 290a 2020 2020 2020 2020 2020 2020   k).            
-0003dc10: 2020 2020 2320 7072 696e 7428 2750 782c      # print('Px,
-0003dc20: 2050 792c 2050 7a3a 2020 272c 2050 5f78   Py, Pz:  ', P_x
-0003dc30: 2c20 505f 792c 2050 5f7a 290a 2020 2020  , P_y, P_z).    
-0003dc40: 2020 2020 2020 2020 2020 2020 2320 7072              # pr
-0003dc50: 696e 7428 0a20 2020 2020 2020 2020 2020  int(.           
-0003dc60: 2020 2020 2020 2020 2023 2027 6170 3031           # 'ap01
-0003dc70: 3a20 272c 0a20 2020 2020 2020 2020 2020  : ',.           
-0003dc80: 2020 2020 2020 2020 2023 2061 705f 7830           # ap_x0
-0003dc90: 5b61 705f 696e 645b 6161 5d3a 6170 5f69  [ap_ind[aa]:ap_i
-0003dca0: 6e64 5b61 612b 315d 5d2c 0a20 2020 2020  nd[aa+1]],.     
-0003dcb0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0003dcc0: 2061 705f 7831 5b61 705f 696e 645b 6161   ap_x1[ap_ind[aa
-0003dcd0: 5d3a 6170 5f69 6e64 5b61 612b 315d 5d2c  ]:ap_ind[aa+1]],
-0003dce0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003dcf0: 2023 2029 0a0a 0a20 2020 2020 2020 2020   # )...         
-0003dd00: 2020 2023 2067 6f20 746f 206e 6578 7420     # go to next 
-0003dd10: 706f 696e 740a 2020 2020 2020 2020 2020  point.          
-0003dd20: 2020 6966 206e 6f74 2069 736f 6b3a 0a20    if not isok:. 
-0003dd30: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0003dd40: 2070 7269 6e74 2827 736b 6970 2032 272c   print('skip 2',
-0003dd50: 2073 6361 2c20 6161 2920 2020 2020 2020   sca, aa)       
-0003dd60: 2023 2044 420a 2020 2020 2020 2020 2020   # DB.          
-0003dd70: 2020 2020 2020 636f 6e74 696e 7565 0a0a        continue..
-0003dd80: 2020 2020 2020 2020 2020 2020 2320 2d2d              # --
-0003dd90: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0003dda0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020  ----------.     
-0003ddb0: 2020 2020 2020 2023 2063 6f6d 7075 7465         # compute
-0003ddc0: 2070 6f6c 7967 6f6e 2069 6e74 6572 7365   polygon interse
-0003ddd0: 6374 696f 6e0a 0a20 2020 2020 2020 2020  ction..         
-0003dde0: 2020 2023 2063 6f6d 7075 7465 2069 6e74     # compute int
-0003ddf0: 6572 7365 6374 696f 6e0a 2020 2020 2020  ersection.      
-0003de00: 2020 2020 2020 705f 6120 3d20 706c 672e        p_a = plg.
-0003de10: 506f 6c79 676f 6e28 6e70 2e61 7272 6179  Polygon(np.array
-0003de20: 285b 6465 745f 6f75 746c 696e 655f 7830  ([det_outline_x0
-0003de30: 2c20 6465 745f 6f75 746c 696e 655f 7831  , det_outline_x1
-0003de40: 5d29 2e54 290a 2020 2020 2020 2020 2020  ]).T).          
-0003de50: 2020 666f 7220 6161 2069 6e20 7261 6e67    for aa in rang
-0003de60: 6528 6e61 293a 0a20 2020 2020 2020 2020  e(na):.         
-0003de70: 2020 2020 2020 2023 2070 7269 6e74 2827         # print('
-0003de80: 705f 613a 2027 2c20 6e70 2e61 7272 6179  p_a: ', np.array
-0003de90: 2870 5f61 2e63 6f6e 746f 7572 2830 2929  (p_a.contour(0))
-0003dea0: 2e54 290a 2020 2020 2020 2020 2020 2020  .T).            
-0003deb0: 2020 2020 2320 7072 696e 7428 2777 6974      # print('wit
-0003dec0: 683a 2027 2c20 6170 5f78 305b 6170 5f69  h: ', ap_x0[ap_i
-0003ded0: 6e64 5b61 615d 3a61 705f 696e 645b 6161  nd[aa]:ap_ind[aa
-0003dee0: 2b31 5d5d 2c20 6170 5f78 315b 6170 5f69  +1]], ap_x1[ap_i
-0003def0: 6e64 5b61 615d 3a61 705f 696e 645b 6161  nd[aa]:ap_ind[aa
-0003df00: 2b31 5d5d 290a 2020 2020 2020 2020 2020  +1]]).          
-0003df10: 2020 2020 2020 705f 6120 3d20 705f 6120        p_a = p_a 
-0003df20: 2620 706c 672e 506f 6c79 676f 6e28 6e70  & plg.Polygon(np
-0003df30: 2e61 7272 6179 285b 0a20 2020 2020 2020  .array([.       
-0003df40: 2020 2020 2020 2020 2020 2020 2061 705f               ap_
-0003df50: 7830 5b61 705f 696e 645b 6161 5d3a 6170  x0[ap_ind[aa]:ap
-0003df60: 5f69 6e64 5b61 612b 315d 5d2c 0a20 2020  _ind[aa+1]],.   
-0003df70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003df80: 2061 705f 7831 5b61 705f 696e 645b 6161   ap_x1[ap_ind[aa
-0003df90: 5d3a 6170 5f69 6e64 5b61 612b 315d 5d2c  ]:ap_ind[aa+1]],
-0003dfa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003dfb0: 205d 292e 5429 0a0a 2020 2020 2020 2020   ]).T)..        
-0003dfc0: 2020 2020 2020 2020 2320 7374 6f70 2069          # stop i
-0003dfd0: 6620 6e6f 2069 6e74 6572 7365 6374 696f  f no intersectio
-0003dfe0: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
-0003dff0: 2020 6966 2070 5f61 2e6e 506f 696e 7473    if p_a.nPoints
-0003e000: 2829 203c 2033 3a0a 2020 2020 2020 2020  () < 3:.        
-0003e010: 2020 2020 2020 2020 2020 2020 6973 6f6b              isok
-0003e020: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-0003e030: 2020 2020 2020 2020 2020 2020 2062 7265               bre
-0003e040: 616b 0a0a 2020 2020 2020 2020 2020 2020  ak..            
-0003e050: 2320 7374 6f70 2069 6620 6e6f 2069 6e74  # stop if no int
-0003e060: 6572 7365 6374 696f 6e0a 2020 2020 2020  ersection.      
-0003e070: 2020 2020 2020 6966 206e 6f74 2069 736f        if not iso
-0003e080: 6b3a 0a20 2020 2020 2020 2020 2020 2020  k:.             
-0003e090: 2020 2023 2070 7269 6e74 2827 736b 6970     # print('skip
-0003e0a0: 2033 2729 2020 2020 2020 2020 2320 4442   3')        # DB
-0003e0b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003e0c0: 2063 6f6e 7469 6e75 650a 0a20 2020 2020   continue..     
-0003e0d0: 2020 2020 2020 2023 202d 2d2d 2d2d 2d2d         # -------
-0003e0e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020  ------------.   
-0003e0f0: 2020 2020 2020 2020 2023 2072 6562 7569           # rebui
-0003e100: 6c64 2033 6420 706f 6c79 676f 6e0a 0a20  ld 3d polygon.. 
-0003e110: 2020 2020 2020 2020 2020 2023 2063 6865             # che
-0003e120: 636b 2063 6377 0a20 2020 2020 2020 2020  ck ccw.         
-0003e130: 2020 2070 5f61 5f78 3020 3d20 6e70 2e61     p_a_x0 = np.a
-0003e140: 7363 6f6e 7469 6775 6f75 7361 7272 6179  scontiguousarray
-0003e150: 286e 702e 6172 7261 7928 705f 612e 636f  (np.array(p_a.co
-0003e160: 6e74 6f75 7228 3029 295b 3a2c 2030 5d29  ntour(0))[:, 0])
-0003e170: 0a20 2020 2020 2020 2020 2020 2070 5f61  .            p_a
-0003e180: 5f78 3120 3d20 6e70 2e61 7363 6f6e 7469  _x1 = np.asconti
-0003e190: 6775 6f75 7361 7272 6179 286e 702e 6172  guousarray(np.ar
-0003e1a0: 7261 7928 705f 612e 636f 6e74 6f75 7228  ray(p_a.contour(
-0003e1b0: 3029 295b 3a2c 2031 5d29 0a20 2020 2020  0))[:, 1]).     
-0003e1c0: 2020 2020 2020 2069 6620 6e6f 7420 5f63         if not _c
-0003e1d0: 6865 636b 5f70 6f6c 7967 6f6e 5f32 645f  heck_polygon_2d_
-0003e1e0: 636f 756e 7465 725f 636c 6f63 6b77 6973  counter_clockwis
-0003e1f0: 6528 705f 615f 7830 2c20 705f 615f 7831  e(p_a_x0, p_a_x1
-0003e200: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0003e210: 2020 2070 5f61 5f78 3020 3d20 6e70 2e61     p_a_x0 = np.a
-0003e220: 7363 6f6e 7469 6775 6f75 7361 7272 6179  scontiguousarray
-0003e230: 2870 5f61 5f78 305b 3a3a 2d31 5d29 0a20  (p_a_x0[::-1]). 
-0003e240: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0003e250: 5f61 5f78 3120 3d20 6e70 2e61 7363 6f6e  _a_x1 = np.ascon
-0003e260: 7469 6775 6f75 7361 7272 6179 2870 5f61  tiguousarray(p_a
-0003e270: 5f78 315b 3a3a 2d31 5d29 0a0a 2020 2020  _x1[::-1])..    
-0003e280: 2020 2020 2020 2020 2320 7472 6961 6e67          # triang
-0003e290: 756c 6174 6520 6279 2065 6172 2d63 6c69  ulate by ear-cli
-0003e2a0: 7070 696e 6720 2829 0a20 2020 2020 2020  pping ().       
-0003e2b0: 2020 2020 2074 7269 203d 2074 7269 616e       tri = trian
-0003e2c0: 6775 6c61 7465 5f62 795f 6561 7263 6c69  gulate_by_earcli
-0003e2d0: 7070 696e 675f 3264 280a 2020 2020 2020  pping_2d(.      
-0003e2e0: 2020 2020 2020 2020 2020 6e70 2e61 7363            np.asc
-0003e2f0: 6f6e 7469 6775 6f75 7361 7272 6179 285b  ontiguousarray([
-0003e300: 705f 615f 7830 2c20 705f 615f 7831 5d29  p_a_x0, p_a_x1])
-0003e310: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
-0003e320: 2020 2020 2020 2020 2020 2020 2320 2d2d              # --
-0003e330: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0003e340: 2d0a 2020 2020 2020 2020 2020 2020 2320  -.            # 
-0003e350: 636f 6d70 7574 6520 736f 6c69 6420 616e  compute solid an
-0003e360: 676c 650a 0a20 2020 2020 2020 2020 2020  gle..           
-0003e370: 2023 206c 6f6f 7020 6f6e 2074 7269 616e   # loop on trian
-0003e380: 676c 6573 0a20 2020 2020 2020 2020 2020  gles.           
-0003e390: 2066 6f72 2074 7420 696e 2072 616e 6765   for tt in range
-0003e3a0: 2874 7269 2e73 6861 7065 5b30 5d29 3a0a  (tri.shape[0]):.
-0003e3b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003e3c0: 2023 2067 6574 2074 7269 616e 676c 650a   # get triangle.
-0003e3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e3e0: 7472 695f 7820 3d20 280a 2020 2020 2020  tri_x = (.      
-0003e3f0: 2020 2020 2020 2020 2020 2020 2020 6465                de
-0003e400: 745f 6365 6e74 735f 785b 6464 5d0a 2020  t_cents_x[dd].  
-0003e410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e420: 2020 2b20 705f 615f 7830 5b74 7269 5b74    + p_a_x0[tri[t
-0003e430: 742c 203a 5d5d 202a 2064 6574 5f65 305f  t, :]] * det_e0_
-0003e440: 785b 6464 5d0a 2020 2020 2020 2020 2020  x[dd].          
-0003e450: 2020 2020 2020 2020 2020 2b20 705f 615f            + p_a_
-0003e460: 7831 5b74 7269 5b74 742c 203a 5d5d 202a  x1[tri[tt, :]] *
-0003e470: 2064 6574 5f65 315f 785b 6464 5d0a 2020   det_e1_x[dd].  
-0003e480: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0003e490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e4a0: 7472 695f 7920 3d20 280a 2020 2020 2020  tri_y = (.      
-0003e4b0: 2020 2020 2020 2020 2020 2020 2020 6465                de
-0003e4c0: 745f 6365 6e74 735f 795b 6464 5d0a 2020  t_cents_y[dd].  
-0003e4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e4e0: 2020 2b20 705f 615f 7830 5b74 7269 5b74    + p_a_x0[tri[t
-0003e4f0: 742c 203a 5d5d 202a 2064 6574 5f65 305f  t, :]] * det_e0_
-0003e500: 795b 6464 5d0a 2020 2020 2020 2020 2020  y[dd].          
-0003e510: 2020 2020 2020 2020 2020 2b20 705f 615f            + p_a_
-0003e520: 7831 5b74 7269 5b74 742c 203a 5d5d 202a  x1[tri[tt, :]] *
-0003e530: 2064 6574 5f65 315f 795b 6464 5d0a 2020   det_e1_y[dd].  
-0003e540: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0003e550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e560: 7472 695f 7a20 3d20 280a 2020 2020 2020  tri_z = (.      
-0003e570: 2020 2020 2020 2020 2020 2020 2020 6465                de
-0003e580: 745f 6365 6e74 735f 7a5b 6464 5d0a 2020  t_cents_z[dd].  
-0003e590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e5a0: 2020 2b20 705f 615f 7830 5b74 7269 5b74    + p_a_x0[tri[t
-0003e5b0: 742c 203a 5d5d 202a 2064 6574 5f65 305f  t, :]] * det_e0_
-0003e5c0: 7a5b 6464 5d0a 2020 2020 2020 2020 2020  z[dd].          
-0003e5d0: 2020 2020 2020 2020 2020 2b20 705f 615f            + p_a_
-0003e5e0: 7831 5b74 7269 5b74 742c 203a 5d5d 202a  x1[tri[tt, :]] *
-0003e5f0: 2064 6574 5f65 315f 7a5b 6464 5d0a 2020   det_e1_z[dd].  
-0003e600: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0003e610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003e620: 2023 2063 6f6d 7075 7461 7469 6f6e 2032   # computation 2
-0003e630: 3a20 736f 6c69 6420 616e 676c 6520 6f66  : solid angle of
-0003e640: 2074 7269 616e 676c 6520 6672 6f6d 2070   triangle from p
-0003e650: 7473 0a20 2020 2020 2020 2020 2020 2020  ts.             
-0003e660: 2020 2073 6f6c 6964 5f61 6e67 6c65 202b     solid_angle +
-0003e670: 3d20 5f73 742e 636f 6d70 5f73 615f 7472  = _st.comp_sa_tr
-0003e680: 6928 0a20 2020 2020 2020 2020 2020 2020  i(.             
-0003e690: 2020 2020 2020 2074 7269 5f78 5b30 5d2c         tri_x[0],
-0003e6a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003e6b0: 2020 2020 2074 7269 5f79 5b30 5d2c 0a20       tri_y[0],. 
-0003e6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e6d0: 2020 2074 7269 5f7a 5b30 5d2c 0a20 2020     tri_z[0],.   
-0003e6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e6f0: 2074 7269 5f78 5b31 5d2c 0a20 2020 2020   tri_x[1],.     
-0003e700: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0003e710: 7269 5f79 5b31 5d2c 0a20 2020 2020 2020  ri_y[1],.       
-0003e720: 2020 2020 2020 2020 2020 2020 2074 7269               tri
-0003e730: 5f7a 5b31 5d2c 0a20 2020 2020 2020 2020  _z[1],.         
-0003e740: 2020 2020 2020 2020 2020 2074 7269 5f78             tri_x
-0003e750: 5b32 5d2c 0a20 2020 2020 2020 2020 2020  [2],.           
-0003e760: 2020 2020 2020 2020 2074 7269 5f79 5b32           tri_y[2
-0003e770: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-0003e780: 2020 2020 2020 2074 7269 5f7a 5b32 5d2c         tri_z[2],
-0003e790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003e7a0: 2020 2020 2070 7473 5f78 5b70 705d 2c0a       pts_x[pp],.
+0003dbc0: 2020 2020 2020 202b 2028 505f 7a20 2d20         + (P_z - 
+0003dbd0: 6465 745f 6365 6e74 735f 7a5b 6464 5d29  det_cents_z[dd])
+0003dbe0: 202a 2064 6574 5f65 315f 7a5b 6464 5d0a   * det_e1_z[dd].
+0003dbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003dc00: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
+0003dc10: 2020 2020 2020 2069 6620 6e6f 7420 6973         if not is
+0003dc20: 6f6b 3a0a 2020 2020 2020 2020 2020 2020  ok:.            
+0003dc30: 2020 2020 2020 2020 6272 6561 6b0a 0a20          break.. 
+0003dc40: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0003dc50: 2070 7269 6e74 2827 7363 6130 2c20 7363   print('sca0, sc
+0003dc60: 6131 2c20 6b20 2027 2c20 7363 6130 2c20  a1, k  ', sca0, 
+0003dc70: 7363 6131 2c20 6b29 0a20 2020 2020 2020  sca1, k).       
+0003dc80: 2020 2020 2020 2020 2023 2070 7269 6e74           # print
+0003dc90: 2827 5078 2c20 5079 2c20 507a 3a20 2027  ('Px, Py, Pz:  '
+0003dca0: 2c20 505f 782c 2050 5f79 2c20 505f 7a29  , P_x, P_y, P_z)
+0003dcb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003dcc0: 2023 2070 7269 6e74 280a 2020 2020 2020   # print(.      
+0003dcd0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0003dce0: 2761 7030 313a 2027 2c0a 2020 2020 2020  'ap01: ',.      
+0003dcf0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0003dd00: 6170 5f78 305b 6170 5f69 6e64 5b61 615d  ap_x0[ap_ind[aa]
+0003dd10: 3a61 705f 696e 645b 6161 2b31 5d5d 2c0a  :ap_ind[aa+1]],.
+0003dd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003dd30: 2020 2020 2320 6170 5f78 315b 6170 5f69      # ap_x1[ap_i
+0003dd40: 6e64 5b61 615d 3a61 705f 696e 645b 6161  nd[aa]:ap_ind[aa
+0003dd50: 2b31 5d5d 2c0a 2020 2020 2020 2020 2020  +1]],.          
+0003dd60: 2020 2020 2020 2320 290a 0a0a 2020 2020        # )...    
+0003dd70: 2020 2020 2020 2020 2320 676f 2074 6f20          # go to 
+0003dd80: 6e65 7874 2070 6f69 6e74 0a20 2020 2020  next point.     
+0003dd90: 2020 2020 2020 2069 6620 6e6f 7420 6973         if not is
+0003dda0: 6f6b 3a0a 2020 2020 2020 2020 2020 2020  ok:.            
+0003ddb0: 2020 2020 2320 7072 696e 7428 2773 6b69      # print('ski
+0003ddc0: 7020 3227 2c20 7363 612c 2061 6129 2020  p 2', sca, aa)  
+0003ddd0: 2020 2020 2020 2320 4442 0a20 2020 2020        # DB.     
+0003dde0: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+0003ddf0: 6e75 650a 0a20 2020 2020 2020 2020 2020  nue..           
+0003de00: 2023 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   # -------------
+0003de10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a  ---------------.
+0003de20: 2020 2020 2020 2020 2020 2020 2320 636f              # co
+0003de30: 6d70 7574 6520 706f 6c79 676f 6e20 696e  mpute polygon in
+0003de40: 7465 7273 6563 7469 6f6e 0a0a 2020 2020  tersection..    
+0003de50: 2020 2020 2020 2020 2320 636f 6d70 7574          # comput
+0003de60: 6520 696e 7465 7273 6563 7469 6f6e 0a20  e intersection. 
+0003de70: 2020 2020 2020 2020 2020 2070 5f61 203d             p_a =
+0003de80: 2070 6c67 2e50 6f6c 7967 6f6e 286e 702e   plg.Polygon(np.
+0003de90: 6172 7261 7928 5b64 6574 5f6f 7574 6c69  array([det_outli
+0003dea0: 6e65 5f78 302c 2064 6574 5f6f 7574 6c69  ne_x0, det_outli
+0003deb0: 6e65 5f78 315d 292e 5429 0a20 2020 2020  ne_x1]).T).     
+0003dec0: 2020 2020 2020 2066 6f72 2061 6120 696e         for aa in
+0003ded0: 2072 616e 6765 286e 6129 3a0a 2020 2020   range(na):.    
+0003dee0: 2020 2020 2020 2020 2020 2020 2320 7072              # pr
+0003def0: 696e 7428 2770 5f61 3a20 272c 206e 702e  int('p_a: ', np.
+0003df00: 6172 7261 7928 705f 612e 636f 6e74 6f75  array(p_a.contou
+0003df10: 7228 3029 292e 5429 0a20 2020 2020 2020  r(0)).T).       
+0003df20: 2020 2020 2020 2020 2023 2070 7269 6e74           # print
+0003df30: 2827 7769 7468 3a20 272c 2061 705f 7830  ('with: ', ap_x0
+0003df40: 5b61 705f 696e 645b 6161 5d3a 6170 5f69  [ap_ind[aa]:ap_i
+0003df50: 6e64 5b61 612b 315d 5d2c 2061 705f 7831  nd[aa+1]], ap_x1
+0003df60: 5b61 705f 696e 645b 6161 5d3a 6170 5f69  [ap_ind[aa]:ap_i
+0003df70: 6e64 5b61 612b 315d 5d29 0a20 2020 2020  nd[aa+1]]).     
+0003df80: 2020 2020 2020 2020 2020 2070 5f61 203d             p_a =
+0003df90: 2070 5f61 2026 2070 6c67 2e50 6f6c 7967   p_a & plg.Polyg
+0003dfa0: 6f6e 286e 702e 6172 7261 7928 5b0a 2020  on(np.array([.  
+0003dfb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003dfc0: 2020 6170 5f78 305b 6170 5f69 6e64 5b61    ap_x0[ap_ind[a
+0003dfd0: 615d 3a61 705f 696e 645b 6161 2b31 5d5d  a]:ap_ind[aa+1]]
+0003dfe0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0003dff0: 2020 2020 2020 6170 5f78 315b 6170 5f69        ap_x1[ap_i
+0003e000: 6e64 5b61 615d 3a61 705f 696e 645b 6161  nd[aa]:ap_ind[aa
+0003e010: 2b31 5d5d 2c0a 2020 2020 2020 2020 2020  +1]],.          
+0003e020: 2020 2020 2020 5d29 2e54 290a 0a20 2020        ]).T)..   
+0003e030: 2020 2020 2020 2020 2020 2020 2023 2073               # s
+0003e040: 746f 7020 6966 206e 6f20 696e 7465 7273  top if no inters
+0003e050: 6563 7469 6f6e 0a20 2020 2020 2020 2020  ection.         
+0003e060: 2020 2020 2020 2069 6620 705f 612e 6e50         if p_a.nP
+0003e070: 6f69 6e74 7328 2920 3c20 333a 0a20 2020  oints() < 3:.   
+0003e080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e090: 2069 736f 6b20 3d20 4661 6c73 650a 2020   isok = False.  
+0003e0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e0b0: 2020 6272 6561 6b0a 0a20 2020 2020 2020    break..       
+0003e0c0: 2020 2020 2023 2073 746f 7020 6966 206e       # stop if n
+0003e0d0: 6f20 696e 7465 7273 6563 7469 6f6e 0a20  o intersection. 
+0003e0e0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+0003e0f0: 7420 6973 6f6b 3a0a 2020 2020 2020 2020  t isok:.        
+0003e100: 2020 2020 2020 2020 2320 7072 696e 7428          # print(
+0003e110: 2773 6b69 7020 3327 2920 2020 2020 2020  'skip 3')       
+0003e120: 2023 2044 420a 2020 2020 2020 2020 2020   # DB.          
+0003e130: 2020 2020 2020 636f 6e74 696e 7565 0a0a        continue..
+0003e140: 2020 2020 2020 2020 2020 2020 2320 2d2d              # --
+0003e150: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0003e160: 2d0a 2020 2020 2020 2020 2020 2020 2320  -.            # 
+0003e170: 7265 6275 696c 6420 3364 2070 6f6c 7967  rebuild 3d polyg
+0003e180: 6f6e 0a0a 2020 2020 2020 2020 2020 2020  on..            
+0003e190: 2320 6368 6563 6b20 6363 770a 2020 2020  # check ccw.    
+0003e1a0: 2020 2020 2020 2020 705f 615f 7830 203d          p_a_x0 =
+0003e1b0: 206e 702e 6173 636f 6e74 6967 756f 7573   np.ascontiguous
+0003e1c0: 6172 7261 7928 6e70 2e61 7272 6179 2870  array(np.array(p
+0003e1d0: 5f61 2e63 6f6e 746f 7572 2830 2929 5b3a  _a.contour(0))[:
+0003e1e0: 2c20 305d 290a 2020 2020 2020 2020 2020  , 0]).          
+0003e1f0: 2020 705f 615f 7831 203d 206e 702e 6173    p_a_x1 = np.as
+0003e200: 636f 6e74 6967 756f 7573 6172 7261 7928  contiguousarray(
+0003e210: 6e70 2e61 7272 6179 2870 5f61 2e63 6f6e  np.array(p_a.con
+0003e220: 746f 7572 2830 2929 5b3a 2c20 315d 290a  tour(0))[:, 1]).
+0003e230: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+0003e240: 6f74 205f 6368 6563 6b5f 706f 6c79 676f  ot _check_polygo
+0003e250: 6e5f 3264 5f63 6f75 6e74 6572 5f63 6c6f  n_2d_counter_clo
+0003e260: 636b 7769 7365 2870 5f61 5f78 302c 2070  ckwise(p_a_x0, p
+0003e270: 5f61 5f78 3129 3a0a 2020 2020 2020 2020  _a_x1):.        
+0003e280: 2020 2020 2020 2020 705f 615f 7830 203d          p_a_x0 =
+0003e290: 206e 702e 6173 636f 6e74 6967 756f 7573   np.ascontiguous
+0003e2a0: 6172 7261 7928 705f 615f 7830 5b3a 3a2d  array(p_a_x0[::-
+0003e2b0: 315d 290a 2020 2020 2020 2020 2020 2020  1]).            
+0003e2c0: 2020 2020 705f 615f 7831 203d 206e 702e      p_a_x1 = np.
+0003e2d0: 6173 636f 6e74 6967 756f 7573 6172 7261  ascontiguousarra
+0003e2e0: 7928 705f 615f 7831 5b3a 3a2d 315d 290a  y(p_a_x1[::-1]).
+0003e2f0: 0a20 2020 2020 2020 2020 2020 2023 2074  .            # t
+0003e300: 7269 616e 6775 6c61 7465 2062 7920 6561  riangulate by ea
+0003e310: 722d 636c 6970 7069 6e67 2028 290a 2020  r-clipping ().  
+0003e320: 2020 2020 2020 2020 2020 7472 6920 3d20            tri = 
+0003e330: 7472 6961 6e67 756c 6174 655f 6279 5f65  triangulate_by_e
+0003e340: 6172 636c 6970 7069 6e67 5f32 6428 0a20  arclipping_2d(. 
+0003e350: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0003e360: 702e 6173 636f 6e74 6967 756f 7573 6172  p.ascontiguousar
+0003e370: 7261 7928 5b70 5f61 5f78 302c 2070 5f61  ray([p_a_x0, p_a
+0003e380: 5f78 315d 290a 2020 2020 2020 2020 2020  _x1]).          
+0003e390: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
+0003e3a0: 2023 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d   # -------------
+0003e3b0: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2020  ------.         
+0003e3c0: 2020 2023 2063 6f6d 7075 7465 2073 6f6c     # compute sol
+0003e3d0: 6964 2061 6e67 6c65 0a0a 2020 2020 2020  id angle..      
+0003e3e0: 2020 2020 2020 2320 6c6f 6f70 206f 6e20        # loop on 
+0003e3f0: 7472 6961 6e67 6c65 730a 2020 2020 2020  triangles.      
+0003e400: 2020 2020 2020 666f 7220 7474 2069 6e20        for tt in 
+0003e410: 7261 6e67 6528 7472 692e 7368 6170 655b  range(tri.shape[
+0003e420: 305d 293a 0a0a 2020 2020 2020 2020 2020  0]):..          
+0003e430: 2020 2020 2020 2320 6765 7420 7472 6961        # get tria
+0003e440: 6e67 6c65 0a20 2020 2020 2020 2020 2020  ngle.           
+0003e450: 2020 2020 2074 7269 5f78 203d 2028 0a20       tri_x = (. 
+0003e460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e470: 2020 2064 6574 5f63 656e 7473 5f78 5b64     det_cents_x[d
+0003e480: 645d 0a20 2020 2020 2020 2020 2020 2020  d].             
+0003e490: 2020 2020 2020 202b 2070 5f61 5f78 305b         + p_a_x0[
+0003e4a0: 7472 695b 7474 2c20 3a5d 5d20 2a20 6465  tri[tt, :]] * de
+0003e4b0: 745f 6530 5f78 5b64 645d 0a20 2020 2020  t_e0_x[dd].     
+0003e4c0: 2020 2020 2020 2020 2020 2020 2020 202b                 +
+0003e4d0: 2070 5f61 5f78 315b 7472 695b 7474 2c20   p_a_x1[tri[tt, 
+0003e4e0: 3a5d 5d20 2a20 6465 745f 6531 5f78 5b64  :]] * det_e1_x[d
+0003e4f0: 645d 0a20 2020 2020 2020 2020 2020 2020  d].             
+0003e500: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0003e510: 2020 2020 2074 7269 5f79 203d 2028 0a20       tri_y = (. 
+0003e520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e530: 2020 2064 6574 5f63 656e 7473 5f79 5b64     det_cents_y[d
+0003e540: 645d 0a20 2020 2020 2020 2020 2020 2020  d].             
+0003e550: 2020 2020 2020 202b 2070 5f61 5f78 305b         + p_a_x0[
+0003e560: 7472 695b 7474 2c20 3a5d 5d20 2a20 6465  tri[tt, :]] * de
+0003e570: 745f 6530 5f79 5b64 645d 0a20 2020 2020  t_e0_y[dd].     
+0003e580: 2020 2020 2020 2020 2020 2020 2020 202b                 +
+0003e590: 2070 5f61 5f78 315b 7472 695b 7474 2c20   p_a_x1[tri[tt, 
+0003e5a0: 3a5d 5d20 2a20 6465 745f 6531 5f79 5b64  :]] * det_e1_y[d
+0003e5b0: 645d 0a20 2020 2020 2020 2020 2020 2020  d].             
+0003e5c0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0003e5d0: 2020 2020 2074 7269 5f7a 203d 2028 0a20       tri_z = (. 
+0003e5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e5f0: 2020 2064 6574 5f63 656e 7473 5f7a 5b64     det_cents_z[d
+0003e600: 645d 0a20 2020 2020 2020 2020 2020 2020  d].             
+0003e610: 2020 2020 2020 202b 2070 5f61 5f78 305b         + p_a_x0[
+0003e620: 7472 695b 7474 2c20 3a5d 5d20 2a20 6465  tri[tt, :]] * de
+0003e630: 745f 6530 5f7a 5b64 645d 0a20 2020 2020  t_e0_z[dd].     
+0003e640: 2020 2020 2020 2020 2020 2020 2020 202b                 +
+0003e650: 2070 5f61 5f78 315b 7472 695b 7474 2c20   p_a_x1[tri[tt, 
+0003e660: 3a5d 5d20 2a20 6465 745f 6531 5f7a 5b64  :]] * det_e1_z[d
+0003e670: 645d 0a20 2020 2020 2020 2020 2020 2020  d].             
+0003e680: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
+0003e690: 2020 2020 2020 2320 636f 6d70 7574 6174        # computat
+0003e6a0: 696f 6e20 323a 2073 6f6c 6964 2061 6e67  ion 2: solid ang
+0003e6b0: 6c65 206f 6620 7472 6961 6e67 6c65 2066  le of triangle f
+0003e6c0: 726f 6d20 7074 730a 2020 2020 2020 2020  rom pts.        
+0003e6d0: 2020 2020 2020 2020 736f 6c69 645f 616e          solid_an
+0003e6e0: 676c 6520 2b3d 205f 7374 2e63 6f6d 705f  gle += _st.comp_
+0003e6f0: 7361 5f74 7269 280a 2020 2020 2020 2020  sa_tri(.        
+0003e700: 2020 2020 2020 2020 2020 2020 7472 695f              tri_
+0003e710: 785b 305d 2c0a 2020 2020 2020 2020 2020  x[0],.          
+0003e720: 2020 2020 2020 2020 2020 7472 695f 795b            tri_y[
+0003e730: 305d 2c0a 2020 2020 2020 2020 2020 2020  0],.            
+0003e740: 2020 2020 2020 2020 7472 695f 7a5b 305d          tri_z[0]
+0003e750: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0003e760: 2020 2020 2020 7472 695f 785b 315d 2c0a        tri_x[1],.
+0003e770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e780: 2020 2020 7472 695f 795b 315d 2c0a 2020      tri_y[1],.  
+0003e790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e7a0: 2020 7472 695f 7a5b 315d 2c0a 2020 2020    tri_z[1],.    
 0003e7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e7c0: 2020 2020 7074 735f 795b 7070 5d2c 0a20      pts_y[pp],. 
-0003e7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e7e0: 2020 2070 7473 5f7a 5b70 705d 2c0a 2020     pts_z[pp],.  
-0003e7f0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0003e800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e810: 2320 7072 696e 7428 2774 7269 272c 2074  # print('tri', t
-0003e820: 742c 2073 6f6c 6964 5f61 6e67 6c65 5b64  t, solid_angle[d
-0003e830: 642c 2070 705d 2920 2020 2020 2020 2023  d, pp])        #
-0003e840: 2044 420a 0a20 2020 2023 202d 2d2d 2d2d   DB..    # -----
-0003e850: 2d2d 0a20 2020 2023 2052 6574 7572 6e0a  --.    # Return.
-0003e860: 0a20 2020 2072 6574 7572 6e20 736f 6c69  .    return soli
-0003e870: 645f 616e 676c 650a 0a0a 6465 6620 636f  d_angle...def co
-0003e880: 6d70 7574 655f 736f 6c69 645f 616e 676c  mpute_solid_angl
-0003e890: 655f 6e6f 6170 6572 7475 7265 7328 0a20  e_noapertures(. 
-0003e8a0: 2020 2023 2070 7473 3a20 636f 6f72 6469     # pts: coordi
-0003e8b0: 6e61 7465 7320 6173 2074 6872 6565 2031  nates as three 1
-0003e8c0: 6420 6172 7261 7973 0a20 2020 2064 6f75  d arrays.    dou
-0003e8d0: 626c 655b 3a3a 315d 2070 7473 5f78 2c0a  ble[::1] pts_x,.
-0003e8e0: 2020 2020 646f 7562 6c65 5b3a 3a31 5d20      double[::1] 
-0003e8f0: 7074 735f 792c 0a20 2020 2064 6f75 626c  pts_y,.    doubl
-0003e900: 655b 3a3a 315d 2070 7473 5f7a 2c0a 2020  e[::1] pts_z,.  
-0003e910: 2020 2320 6465 7465 6374 6f72 733a 2070    # detectors: p
-0003e920: 6f6c 7967 6f6e 2063 6f6f 7264 696e 6174  olygon coordinat
-0003e930: 6573 2069 6e20 3264 2028 636f 6d6d 6f6e  es in 2d (common
-0003e940: 2074 6f20 616c 6c20 6465 7465 6374 6f72   to all detector
-0003e950: 7329 0a20 2020 2064 6f75 626c 655b 3a3a  s).    double[::
-0003e960: 315d 2064 6574 5f6f 7574 6c69 6e65 5f78  1] det_outline_x
-0003e970: 302c 0a20 2020 2064 6f75 626c 655b 3a3a  0,.    double[::
-0003e980: 315d 2064 6574 5f6f 7574 6c69 6e65 5f78  1] det_outline_x
-0003e990: 312c 0a20 2020 2023 2064 6574 6563 746f  1,.    # detecto
-0003e9a0: 7273 3a20 6365 6e74 6572 7320 636f 6f72  rs: centers coor
-0003e9b0: 6469 6e61 7465 7320 6173 2074 6872 6565  dinates as three
-0003e9c0: 2031 6420 6172 7261 7973 0a20 2020 2064   1d arrays.    d
-0003e9d0: 6f75 626c 655b 3a3a 315d 2064 6574 5f63  ouble[::1] det_c
-0003e9e0: 656e 7473 5f78 2c0a 2020 2020 646f 7562  ents_x,.    doub
-0003e9f0: 6c65 5b3a 3a31 5d20 6465 745f 6365 6e74  le[::1] det_cent
-0003ea00: 735f 792c 0a20 2020 2064 6f75 626c 655b  s_y,.    double[
-0003ea10: 3a3a 315d 2064 6574 5f63 656e 7473 5f7a  ::1] det_cents_z
-0003ea20: 2c0a 2020 2020 2320 6465 7465 6374 6f72  ,.    # detector
-0003ea30: 733a 206e 6f72 6d61 6c20 756e 6974 2076  s: normal unit v
-0003ea40: 6563 746f 7273 2061 7320 7468 7265 6520  ectors as three 
-0003ea50: 3164 2061 7272 6179 7320 286e 6420 3d20  1d arrays (nd = 
-0003ea60: 6c65 6e28 6465 745f 6e6f 726d 5f78 2929  len(det_norm_x))
-0003ea70: 0a20 2020 2064 6f75 626c 655b 3a3a 315d  .    double[::1]
-0003ea80: 2064 6574 5f6e 6f72 6d5f 782c 0a20 2020   det_norm_x,.   
-0003ea90: 2064 6f75 626c 655b 3a3a 315d 2064 6574   double[::1] det
-0003eaa0: 5f6e 6f72 6d5f 792c 0a20 2020 2064 6f75  _norm_y,.    dou
-0003eab0: 626c 655b 3a3a 315d 2064 6574 5f6e 6f72  ble[::1] det_nor
-0003eac0: 6d5f 7a2c 0a20 2020 206e 702e 6e64 6172  m_z,.    np.ndar
-0003ead0: 7261 795b 646f 7562 6c65 2c20 6e64 696d  ray[double, ndim
-0003eae0: 3d31 5d20 6465 745f 6530 5f78 2c0a 2020  =1] det_e0_x,.  
-0003eaf0: 2020 6e70 2e6e 6461 7272 6179 5b64 6f75    np.ndarray[dou
-0003eb00: 626c 652c 206e 6469 6d3d 315d 2064 6574  ble, ndim=1] det
-0003eb10: 5f65 305f 792c 0a20 2020 206e 702e 6e64  _e0_y,.    np.nd
-0003eb20: 6172 7261 795b 646f 7562 6c65 2c20 6e64  array[double, nd
-0003eb30: 696d 3d31 5d20 6465 745f 6530 5f7a 2c0a  im=1] det_e0_z,.
-0003eb40: 2020 2020 6e70 2e6e 6461 7272 6179 5b64      np.ndarray[d
-0003eb50: 6f75 626c 652c 206e 6469 6d3d 315d 2064  ouble, ndim=1] d
-0003eb60: 6574 5f65 315f 782c 0a20 2020 206e 702e  et_e1_x,.    np.
-0003eb70: 6e64 6172 7261 795b 646f 7562 6c65 2c20  ndarray[double, 
-0003eb80: 6e64 696d 3d31 5d20 6465 745f 6531 5f79  ndim=1] det_e1_y
-0003eb90: 2c0a 2020 2020 6e70 2e6e 6461 7272 6179  ,.    np.ndarray
-0003eba0: 5b64 6f75 626c 652c 206e 6469 6d3d 315d  [double, ndim=1]
-0003ebb0: 2064 6574 5f65 315f 7a2c 0a20 2020 2023   det_e1_z,.    #
-0003ebc0: 2070 6f73 7369 626c 6520 6578 7472 6120   possible extra 
-0003ebd0: 7061 7261 6d65 7465 7273 203f 0a20 2020  parameters ?.   
-0003ebe0: 2064 6f75 626c 6520 6d61 7267 696e 3d5f   double margin=_
-0003ebf0: 5653 4d41 4c4c 2c0a 2020 2020 696e 7420  VSMALL,.    int 
-0003ec00: 6e75 6d5f 7468 7265 6164 733d 3130 2c0a  num_threads=10,.
-0003ec10: 293a 0a20 2020 2022 2222 2054 7970 6963  ):.    """ Typic
-0003ec20: 616c 6c79 2075 7365 6420 746f 2063 6f6d  ally used to com
-0003ec30: 7075 7465 2074 6865 2065 7465 6e64 7565  pute the etendue
-0003ec40: 206f 6620 6120 7369 6e67 6c65 2d61 7065   of a single-ape
-0003ec50: 7274 7572 6520 7365 7420 6f66 0a20 2020  rture set of.   
-0003ec60: 2064 6574 6563 746f 7273 2c20 7768 6572   detectors, wher
-0003ec70: 6520 7468 6520 706f 696e 7473 2061 7265  e the points are
-0003ec80: 2074 616b 656e 2069 6e20 7468 6520 6170   taken in the ap
-0003ec90: 6572 7475 7265 2070 6c61 6e65 2074 6f20  erture plane to 
-0003eca0: 6765 7420 7269 6420 6f66 0a20 2020 2069  get rid of.    i
-0003ecb0: 740a 0a20 2020 204f 6e6c 7920 7661 6c69  t..    Only vali
-0003ecc0: 6420 6f6e 2061 2070 6c61 6e65 2070 6572  d on a plane per
-0003ecd0: 7065 6e64 6963 756c 6172 2074 6f20 7468  pendicular to th
-0003ece0: 6520 4c4f 530a 0a20 2020 203d 3e20 7573  e LOS..    => us
-0003ecf0: 6520 666f 7220 7369 6d70 6c65 2063 6173  e for simple cas
-0003ed00: 6573 0a20 2020 203d 3e20 7573 6564 2061  es.    => used a
-0003ed10: 7320 6120 7465 7374 696e 6720 6772 6f75  s a testing grou
-0003ed20: 6e64 2062 6566 6f72 6520 6d6f 7265 2063  nd before more c
-0003ed30: 6f6d 706c 6578 2072 6f75 7469 6e65 730a  omplex routines.
-0003ed40: 0a20 2020 2022 2222 0a0a 2020 2020 2320  .    """..    # 
-0003ed50: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020  -----------.    
-0003ed60: 2320 4465 636c 6172 6174 696f 6e0a 0a20  # Declaration.. 
-0003ed70: 2020 2063 6465 6620 696e 7420 6e70 7473     cdef int npts
-0003ed80: 203d 2070 7473 5f78 2e73 697a 650a 2020   = pts_x.size.  
-0003ed90: 2020 6364 6566 2069 6e74 206e 6420 3d20    cdef int nd = 
-0003eda0: 6465 745f 6365 6e74 735f 782e 7369 7a65  det_cents_x.size
-0003edb0: 0a20 2020 2063 6465 6620 6464 2c20 7070  .    cdef dd, pp
-0003edc0: 2c20 7474 0a20 2020 2063 6465 6620 666c  , tt.    cdef fl
-0003edd0: 6f61 7420 7363 610a 2020 2020 6364 6566  oat sca.    cdef
-0003ede0: 2064 6f75 626c 655b 3a3a 315d 2070 6f6c   double[::1] pol
-0003edf0: 795f 780a 2020 2020 6364 6566 2064 6f75  y_x.    cdef dou
-0003ee00: 626c 655b 3a3a 315d 2070 6f6c 795f 790a  ble[::1] poly_y.
-0003ee10: 2020 2020 6364 6566 2064 6f75 626c 655b      cdef double[
-0003ee20: 3a3a 315d 2070 6f6c 795f 7a0a 0a20 2020  ::1] poly_z..   
-0003ee30: 2023 2069 6e69 7469 616c 697a 6520 736f   # initialize so
-0003ee40: 6c69 6420 616e 676c 6520 6172 7261 7920  lid angle array 
-0003ee50: 7769 7468 207a 6572 6f73 0a20 2020 2063  with zeros.    c
-0003ee60: 6465 6620 6e70 2e6e 6461 7272 6179 5b64  def np.ndarray[d
-0003ee70: 6f75 626c 652c 206e 6469 6d3d 325d 2073  ouble, ndim=2] s
-0003ee80: 6f6c 6964 5f61 6e67 6c65 203d 206e 702e  olid_angle = np.
-0003ee90: 7a65 726f 7328 286e 642c 206e 7074 7329  zeros((nd, npts)
-0003eea0: 2c20 6474 7970 653d 666c 6f61 7429 0a0a  , dtype=float)..
-0003eeb0: 2020 2020 2320 2d2d 2d2d 2d2d 2d0a 2020      # -------.  
-0003eec0: 2020 2320 436f 6d70 7574 650a 0a20 2020    # Compute..   
-0003eed0: 2023 2074 7269 616e 6775 6c61 7465 2064   # triangulate d
-0003eee0: 6574 2062 7920 6561 722d 636c 6970 7069  et by ear-clippi
-0003eef0: 6e67 0a20 2020 2074 7269 203d 2074 7269  ng.    tri = tri
-0003ef00: 616e 6775 6c61 7465 5f62 795f 6561 7263  angulate_by_earc
-0003ef10: 6c69 7070 696e 675f 3264 286e 702e 6172  lipping_2d(np.ar
-0003ef20: 7261 7928 5b64 6574 5f6f 7574 6c69 6e65  ray([det_outline
-0003ef30: 5f78 302c 2064 6574 5f6f 7574 6c69 6e65  _x0, det_outline
-0003ef40: 5f78 315d 2929 0a0a 2020 2020 666f 7220  _x1]))..    for 
-0003ef50: 6464 2069 6e20 7261 6e67 6528 6e64 293a  dd in range(nd):
-0003ef60: 0a0a 2020 2020 2020 2020 2320 6275 696c  ..        # buil
-0003ef70: 6420 3364 2070 6f6c 7967 6f6e 0a20 2020  d 3d polygon.   
-0003ef80: 2020 2020 2070 6f6c 795f 7820 3d20 6465       poly_x = de
-0003ef90: 745f 6365 6e74 735f 785b 6464 5d20 2b20  t_cents_x[dd] + 
-0003efa0: 6465 745f 6f75 746c 696e 655f 7830 202a  det_outline_x0 *
-0003efb0: 2064 6574 5f65 305f 785b 6464 5d20 2b20   det_e0_x[dd] + 
-0003efc0: 6465 745f 6f75 746c 696e 655f 7831 202a  det_outline_x1 *
-0003efd0: 2064 6574 5f65 315f 785b 6464 5d0a 2020   det_e1_x[dd].  
-0003efe0: 2020 2020 2020 706f 6c79 5f79 203d 2064        poly_y = d
-0003eff0: 6574 5f63 656e 7473 5f79 5b64 645d 202b  et_cents_y[dd] +
-0003f000: 2064 6574 5f6f 7574 6c69 6e65 5f78 3020   det_outline_x0 
-0003f010: 2a20 6465 745f 6530 5f79 5b64 645d 202b  * det_e0_y[dd] +
-0003f020: 2064 6574 5f6f 7574 6c69 6e65 5f78 3120   det_outline_x1 
-0003f030: 2a20 6465 745f 6531 5f79 5b64 645d 0a20  * det_e1_y[dd]. 
-0003f040: 2020 2020 2020 2070 6f6c 795f 7a20 3d20         poly_z = 
-0003f050: 6465 745f 6365 6e74 735f 7a5b 6464 5d20  det_cents_z[dd] 
-0003f060: 2b20 6465 745f 6f75 746c 696e 655f 7830  + det_outline_x0
-0003f070: 202a 2064 6574 5f65 305f 7a5b 6464 5d20   * det_e0_z[dd] 
-0003f080: 2b20 6465 745f 6f75 746c 696e 655f 7831  + det_outline_x1
-0003f090: 202a 2064 6574 5f65 315f 7a5b 6464 5d0a   * det_e1_z[dd].
-0003f0a0: 0a20 2020 2020 2020 2023 206c 6f6f 7020  .        # loop 
-0003f0b0: 323a 206f 6e20 6e70 7473 2028 6f62 7365  2: on npts (obse
-0003f0c0: 7276 6174 696f 6e20 706f 696e 7473 290a  rvation points).
-0003f0d0: 2020 2020 2020 2020 666f 7220 7070 2069          for pp i
-0003f0e0: 6e20 7261 6e67 6528 6e70 7473 293a 0a0a  n range(npts):..
-0003f0f0: 2020 2020 2020 2020 2020 2020 2320 7465              # te
-0003f100: 7374 2069 6620 6f6e 2067 6f6f 6420 7369  st if on good si
-0003f110: 6465 206f 6620 6465 7465 6374 6f72 0a20  de of detector. 
-0003f120: 2020 2020 2020 2020 2020 2073 6361 203d             sca =
-0003f130: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
-0003f140: 2020 2028 7074 735f 785b 7070 5d20 2d20     (pts_x[pp] - 
-0003f150: 6465 745f 6365 6e74 735f 785b 6464 5d29  det_cents_x[dd])
-0003f160: 202a 2064 6574 5f6e 6f72 6d5f 785b 6464   * det_norm_x[dd
-0003f170: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0003f180: 2020 2b20 2870 7473 5f79 5b70 705d 202d    + (pts_y[pp] -
-0003f190: 2064 6574 5f63 656e 7473 5f79 5b64 645d   det_cents_y[dd]
-0003f1a0: 2920 2a20 6465 745f 6e6f 726d 5f79 5b64  ) * det_norm_y[d
-0003f1b0: 645d 0a20 2020 2020 2020 2020 2020 2020  d].             
-0003f1c0: 2020 202b 2028 7074 735f 7a5b 7070 5d20     + (pts_z[pp] 
-0003f1d0: 2d20 6465 745f 6365 6e74 735f 7a5b 6464  - det_cents_z[dd
-0003f1e0: 5d29 202a 2064 6574 5f6e 6f72 6d5f 7a5b  ]) * det_norm_z[
-0003f1f0: 6464 5d0a 2020 2020 2020 2020 2020 2020  dd].            
-0003f200: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
-0003f210: 6620 7363 6120 3c3d 2030 3a0a 2020 2020  f sca <= 0:.    
-0003f220: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-0003f230: 696e 7565 0a0a 2020 2020 2020 2020 2020  inue..          
-0003f240: 2020 2320 6c6f 6f70 206f 6e20 7472 6961    # loop on tria
-0003f250: 6e67 6c65 730a 2020 2020 2020 2020 2020  ngles.          
-0003f260: 2020 666f 7220 7474 2069 6e20 7261 6e67    for tt in rang
-0003f270: 6528 7472 692e 7368 6170 655b 305d 293a  e(tri.shape[0]):
-0003f280: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0003f290: 2020 2320 636f 6d70 7574 6174 696f 6e20    # computation 
-0003f2a0: 323a 2073 6f6c 6964 2061 6e67 6c65 206f  2: solid angle o
-0003f2b0: 6620 7472 6961 6e67 6c65 2066 726f 6d20  f triangle from 
-0003f2c0: 7074 730a 2020 2020 2020 2020 2020 2020  pts.            
-0003f2d0: 2020 2020 736f 6c69 645f 616e 676c 655b      solid_angle[
-0003f2e0: 6464 2c20 7070 5d20 2b3d 205f 7374 2e63  dd, pp] += _st.c
-0003f2f0: 6f6d 705f 7361 5f74 7269 280a 2020 2020  omp_sa_tri(.    
-0003f300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f310: 706f 6c79 5f78 5b74 7269 5b74 742c 2030  poly_x[tri[tt, 0
-0003f320: 5d5d 2c0a 2020 2020 2020 2020 2020 2020  ]],.            
-0003f330: 2020 2020 2020 2020 706f 6c79 5f79 5b74          poly_y[t
-0003f340: 7269 5b74 742c 2030 5d5d 2c0a 2020 2020  ri[tt, 0]],.    
-0003f350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f360: 706f 6c79 5f7a 5b74 7269 5b74 742c 2030  poly_z[tri[tt, 0
-0003f370: 5d5d 2c0a 2020 2020 2020 2020 2020 2020  ]],.            
-0003f380: 2020 2020 2020 2020 706f 6c79 5f78 5b74          poly_x[t
-0003f390: 7269 5b74 742c 2031 5d5d 2c0a 2020 2020  ri[tt, 1]],.    
-0003f3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f3b0: 706f 6c79 5f79 5b74 7269 5b74 742c 2031  poly_y[tri[tt, 1
-0003f3c0: 5d5d 2c0a 2020 2020 2020 2020 2020 2020  ]],.            
-0003f3d0: 2020 2020 2020 2020 706f 6c79 5f7a 5b74          poly_z[t
-0003f3e0: 7269 5b74 742c 2031 5d5d 2c0a 2020 2020  ri[tt, 1]],.    
-0003f3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f400: 706f 6c79 5f78 5b74 7269 5b74 742c 2032  poly_x[tri[tt, 2
-0003f410: 5d5d 2c0a 2020 2020 2020 2020 2020 2020  ]],.            
-0003f420: 2020 2020 2020 2020 706f 6c79 5f79 5b74          poly_y[t
-0003f430: 7269 5b74 742c 2032 5d5d 2c0a 2020 2020  ri[tt, 2]],.    
-0003f440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f450: 706f 6c79 5f7a 5b74 7269 5b74 742c 2032  poly_z[tri[tt, 2
-0003f460: 5d5d 2c0a 2020 2020 2020 2020 2020 2020  ]],.            
-0003f470: 2020 2020 2020 2020 7074 735f 785b 7070          pts_x[pp
-0003f480: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-0003f490: 2020 2020 2020 2070 7473 5f79 5b70 705d         pts_y[pp]
-0003f4a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0003f4b0: 2020 2020 2020 7074 735f 7a5b 7070 5d2c        pts_z[pp],
-0003f4c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003f4d0: 2029 0a0a 2020 2020 7265 7475 726e 2073   )..    return s
-0003f4e0: 6f6c 6964 5f61 6e67 6c65 0a              olid_angle.
+0003e7c0: 7472 695f 785b 325d 2c0a 2020 2020 2020  tri_x[2],.      
+0003e7d0: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+0003e7e0: 695f 795b 325d 2c0a 2020 2020 2020 2020  i_y[2],.        
+0003e7f0: 2020 2020 2020 2020 2020 2020 7472 695f              tri_
+0003e800: 7a5b 325d 2c0a 2020 2020 2020 2020 2020  z[2],.          
+0003e810: 2020 2020 2020 2020 2020 7074 735f 785b            pts_x[
+0003e820: 7070 5d2c 0a20 2020 2020 2020 2020 2020  pp],.           
+0003e830: 2020 2020 2020 2020 2070 7473 5f79 5b70           pts_y[p
+0003e840: 705d 2c0a 2020 2020 2020 2020 2020 2020  p],.            
+0003e850: 2020 2020 2020 2020 7074 735f 7a5b 7070          pts_z[pp
+0003e860: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+0003e870: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0003e880: 2020 2020 2023 2070 7269 6e74 2827 7472       # print('tr
+0003e890: 6927 2c20 7474 2c20 736f 6c69 645f 616e  i', tt, solid_an
+0003e8a0: 676c 655b 6464 2c20 7070 5d29 2020 2020  gle[dd, pp])    
+0003e8b0: 2020 2020 2320 4442 0a0a 2020 2020 2320      # DB..    # 
+0003e8c0: 2d2d 2d2d 2d2d 2d0a 2020 2020 2320 5265  -------.    # Re
+0003e8d0: 7475 726e 0a0a 2020 2020 7265 7475 726e  turn..    return
+0003e8e0: 2073 6f6c 6964 5f61 6e67 6c65 0a0a 0a64   solid_angle...d
+0003e8f0: 6566 2063 6f6d 7075 7465 5f73 6f6c 6964  ef compute_solid
+0003e900: 5f61 6e67 6c65 5f6e 6f61 7065 7274 7572  _angle_noapertur
+0003e910: 6573 280a 2020 2020 2320 7074 733a 2063  es(.    # pts: c
+0003e920: 6f6f 7264 696e 6174 6573 2061 7320 7468  oordinates as th
+0003e930: 7265 6520 3164 2061 7272 6179 730a 2020  ree 1d arrays.  
+0003e940: 2020 646f 7562 6c65 5b3a 3a31 5d20 7074    double[::1] pt
+0003e950: 735f 782c 0a20 2020 2064 6f75 626c 655b  s_x,.    double[
+0003e960: 3a3a 315d 2070 7473 5f79 2c0a 2020 2020  ::1] pts_y,.    
+0003e970: 646f 7562 6c65 5b3a 3a31 5d20 7074 735f  double[::1] pts_
+0003e980: 7a2c 0a20 2020 2023 2064 6574 6563 746f  z,.    # detecto
+0003e990: 7273 3a20 706f 6c79 676f 6e20 636f 6f72  rs: polygon coor
+0003e9a0: 6469 6e61 7465 7320 696e 2032 6420 2863  dinates in 2d (c
+0003e9b0: 6f6d 6d6f 6e20 746f 2061 6c6c 2064 6574  ommon to all det
+0003e9c0: 6563 746f 7273 290a 2020 2020 646f 7562  ectors).    doub
+0003e9d0: 6c65 5b3a 3a31 5d20 6465 745f 6f75 746c  le[::1] det_outl
+0003e9e0: 696e 655f 7830 2c0a 2020 2020 646f 7562  ine_x0,.    doub
+0003e9f0: 6c65 5b3a 3a31 5d20 6465 745f 6f75 746c  le[::1] det_outl
+0003ea00: 696e 655f 7831 2c0a 2020 2020 2320 6465  ine_x1,.    # de
+0003ea10: 7465 6374 6f72 733a 2063 656e 7465 7273  tectors: centers
+0003ea20: 2063 6f6f 7264 696e 6174 6573 2061 7320   coordinates as 
+0003ea30: 7468 7265 6520 3164 2061 7272 6179 730a  three 1d arrays.
+0003ea40: 2020 2020 646f 7562 6c65 5b3a 3a31 5d20      double[::1] 
+0003ea50: 6465 745f 6365 6e74 735f 782c 0a20 2020  det_cents_x,.   
+0003ea60: 2064 6f75 626c 655b 3a3a 315d 2064 6574   double[::1] det
+0003ea70: 5f63 656e 7473 5f79 2c0a 2020 2020 646f  _cents_y,.    do
+0003ea80: 7562 6c65 5b3a 3a31 5d20 6465 745f 6365  uble[::1] det_ce
+0003ea90: 6e74 735f 7a2c 0a20 2020 2023 2064 6574  nts_z,.    # det
+0003eaa0: 6563 746f 7273 3a20 6e6f 726d 616c 2075  ectors: normal u
+0003eab0: 6e69 7420 7665 6374 6f72 7320 6173 2074  nit vectors as t
+0003eac0: 6872 6565 2031 6420 6172 7261 7973 2028  hree 1d arrays (
+0003ead0: 6e64 203d 206c 656e 2864 6574 5f6e 6f72  nd = len(det_nor
+0003eae0: 6d5f 7829 290a 2020 2020 646f 7562 6c65  m_x)).    double
+0003eaf0: 5b3a 3a31 5d20 6465 745f 6e6f 726d 5f78  [::1] det_norm_x
+0003eb00: 2c0a 2020 2020 646f 7562 6c65 5b3a 3a31  ,.    double[::1
+0003eb10: 5d20 6465 745f 6e6f 726d 5f79 2c0a 2020  ] det_norm_y,.  
+0003eb20: 2020 646f 7562 6c65 5b3a 3a31 5d20 6465    double[::1] de
+0003eb30: 745f 6e6f 726d 5f7a 2c0a 2020 2020 6e70  t_norm_z,.    np
+0003eb40: 2e6e 6461 7272 6179 5b64 6f75 626c 652c  .ndarray[double,
+0003eb50: 206e 6469 6d3d 315d 2064 6574 5f65 305f   ndim=1] det_e0_
+0003eb60: 782c 0a20 2020 206e 702e 6e64 6172 7261  x,.    np.ndarra
+0003eb70: 795b 646f 7562 6c65 2c20 6e64 696d 3d31  y[double, ndim=1
+0003eb80: 5d20 6465 745f 6530 5f79 2c0a 2020 2020  ] det_e0_y,.    
+0003eb90: 6e70 2e6e 6461 7272 6179 5b64 6f75 626c  np.ndarray[doubl
+0003eba0: 652c 206e 6469 6d3d 315d 2064 6574 5f65  e, ndim=1] det_e
+0003ebb0: 305f 7a2c 0a20 2020 206e 702e 6e64 6172  0_z,.    np.ndar
+0003ebc0: 7261 795b 646f 7562 6c65 2c20 6e64 696d  ray[double, ndim
+0003ebd0: 3d31 5d20 6465 745f 6531 5f78 2c0a 2020  =1] det_e1_x,.  
+0003ebe0: 2020 6e70 2e6e 6461 7272 6179 5b64 6f75    np.ndarray[dou
+0003ebf0: 626c 652c 206e 6469 6d3d 315d 2064 6574  ble, ndim=1] det
+0003ec00: 5f65 315f 792c 0a20 2020 206e 702e 6e64  _e1_y,.    np.nd
+0003ec10: 6172 7261 795b 646f 7562 6c65 2c20 6e64  array[double, nd
+0003ec20: 696d 3d31 5d20 6465 745f 6531 5f7a 2c0a  im=1] det_e1_z,.
+0003ec30: 2020 2020 2320 706f 7373 6962 6c65 2065      # possible e
+0003ec40: 7874 7261 2070 6172 616d 6574 6572 7320  xtra parameters 
+0003ec50: 3f0a 2020 2020 646f 7562 6c65 206d 6172  ?.    double mar
+0003ec60: 6769 6e3d 5f56 534d 414c 4c2c 0a20 2020  gin=_VSMALL,.   
+0003ec70: 2069 6e74 206e 756d 5f74 6872 6561 6473   int num_threads
+0003ec80: 3d31 302c 0a29 3a0a 2020 2020 2222 2220  =10,.):.    """ 
+0003ec90: 5479 7069 6361 6c6c 7920 7573 6564 2074  Typically used t
+0003eca0: 6f20 636f 6d70 7574 6520 7468 6520 6574  o compute the et
+0003ecb0: 656e 6475 6520 6f66 2061 2073 696e 676c  endue of a singl
+0003ecc0: 652d 6170 6572 7475 7265 2073 6574 206f  e-aperture set o
+0003ecd0: 660a 2020 2020 6465 7465 6374 6f72 732c  f.    detectors,
+0003ece0: 2077 6865 7265 2074 6865 2070 6f69 6e74   where the point
+0003ecf0: 7320 6172 6520 7461 6b65 6e20 696e 2074  s are taken in t
+0003ed00: 6865 2061 7065 7274 7572 6520 706c 616e  he aperture plan
+0003ed10: 6520 746f 2067 6574 2072 6964 206f 660a  e to get rid of.
+0003ed20: 2020 2020 6974 0a0a 2020 2020 4f6e 6c79      it..    Only
+0003ed30: 2076 616c 6964 206f 6e20 6120 706c 616e   valid on a plan
+0003ed40: 6520 7065 7270 656e 6469 6375 6c61 7220  e perpendicular 
+0003ed50: 746f 2074 6865 204c 4f53 0a0a 2020 2020  to the LOS..    
+0003ed60: 3d3e 2075 7365 2066 6f72 2073 696d 706c  => use for simpl
+0003ed70: 6520 6361 7365 730a 2020 2020 3d3e 2075  e cases.    => u
+0003ed80: 7365 6420 6173 2061 2074 6573 7469 6e67  sed as a testing
+0003ed90: 2067 726f 756e 6420 6265 666f 7265 206d   ground before m
+0003eda0: 6f72 6520 636f 6d70 6c65 7820 726f 7574  ore complex rout
+0003edb0: 696e 6573 0a0a 2020 2020 2222 220a 0a20  ines..    """.. 
+0003edc0: 2020 2023 202d 2d2d 2d2d 2d2d 2d2d 2d2d     # -----------
+0003edd0: 0a20 2020 2023 2044 6563 6c61 7261 7469  .    # Declarati
+0003ede0: 6f6e 0a0a 2020 2020 6364 6566 2069 6e74  on..    cdef int
+0003edf0: 206e 7074 7320 3d20 7074 735f 782e 7369   npts = pts_x.si
+0003ee00: 7a65 0a20 2020 2063 6465 6620 696e 7420  ze.    cdef int 
+0003ee10: 6e64 203d 2064 6574 5f63 656e 7473 5f78  nd = det_cents_x
+0003ee20: 2e73 697a 650a 2020 2020 6364 6566 2064  .size.    cdef d
+0003ee30: 642c 2070 702c 2074 740a 2020 2020 6364  d, pp, tt.    cd
+0003ee40: 6566 2066 6c6f 6174 2073 6361 0a20 2020  ef float sca.   
+0003ee50: 2063 6465 6620 646f 7562 6c65 5b3a 3a31   cdef double[::1
+0003ee60: 5d20 706f 6c79 5f78 0a20 2020 2063 6465  ] poly_x.    cde
+0003ee70: 6620 646f 7562 6c65 5b3a 3a31 5d20 706f  f double[::1] po
+0003ee80: 6c79 5f79 0a20 2020 2063 6465 6620 646f  ly_y.    cdef do
+0003ee90: 7562 6c65 5b3a 3a31 5d20 706f 6c79 5f7a  uble[::1] poly_z
+0003eea0: 0a0a 2020 2020 2320 696e 6974 6961 6c69  ..    # initiali
+0003eeb0: 7a65 2073 6f6c 6964 2061 6e67 6c65 2061  ze solid angle a
+0003eec0: 7272 6179 2077 6974 6820 7a65 726f 730a  rray with zeros.
+0003eed0: 2020 2020 6364 6566 206e 702e 6e64 6172      cdef np.ndar
+0003eee0: 7261 795b 646f 7562 6c65 2c20 6e64 696d  ray[double, ndim
+0003eef0: 3d32 5d20 736f 6c69 645f 616e 676c 6520  =2] solid_angle 
+0003ef00: 3d20 6e70 2e7a 6572 6f73 2828 6e64 2c20  = np.zeros((nd, 
+0003ef10: 6e70 7473 292c 2064 7479 7065 3d66 6c6f  npts), dtype=flo
+0003ef20: 6174 290a 0a20 2020 2023 202d 2d2d 2d2d  at)..    # -----
+0003ef30: 2d2d 0a20 2020 2023 2043 6f6d 7075 7465  --.    # Compute
+0003ef40: 0a0a 2020 2020 2320 7472 6961 6e67 756c  ..    # triangul
+0003ef50: 6174 6520 6465 7420 6279 2065 6172 2d63  ate det by ear-c
+0003ef60: 6c69 7070 696e 670a 2020 2020 7472 6920  lipping.    tri 
+0003ef70: 3d20 7472 6961 6e67 756c 6174 655f 6279  = triangulate_by
+0003ef80: 5f65 6172 636c 6970 7069 6e67 5f32 6428  _earclipping_2d(
+0003ef90: 6e70 2e61 7272 6179 285b 6465 745f 6f75  np.array([det_ou
+0003efa0: 746c 696e 655f 7830 2c20 6465 745f 6f75  tline_x0, det_ou
+0003efb0: 746c 696e 655f 7831 5d29 290a 0a20 2020  tline_x1]))..   
+0003efc0: 2066 6f72 2064 6420 696e 2072 616e 6765   for dd in range
+0003efd0: 286e 6429 3a0a 0a20 2020 2020 2020 2023  (nd):..        #
+0003efe0: 2062 7569 6c64 2033 6420 706f 6c79 676f   build 3d polygo
+0003eff0: 6e0a 2020 2020 2020 2020 706f 6c79 5f78  n.        poly_x
+0003f000: 203d 2064 6574 5f63 656e 7473 5f78 5b64   = det_cents_x[d
+0003f010: 645d 202b 2064 6574 5f6f 7574 6c69 6e65  d] + det_outline
+0003f020: 5f78 3020 2a20 6465 745f 6530 5f78 5b64  _x0 * det_e0_x[d
+0003f030: 645d 202b 2064 6574 5f6f 7574 6c69 6e65  d] + det_outline
+0003f040: 5f78 3120 2a20 6465 745f 6531 5f78 5b64  _x1 * det_e1_x[d
+0003f050: 645d 0a20 2020 2020 2020 2070 6f6c 795f  d].        poly_
+0003f060: 7920 3d20 6465 745f 6365 6e74 735f 795b  y = det_cents_y[
+0003f070: 6464 5d20 2b20 6465 745f 6f75 746c 696e  dd] + det_outlin
+0003f080: 655f 7830 202a 2064 6574 5f65 305f 795b  e_x0 * det_e0_y[
+0003f090: 6464 5d20 2b20 6465 745f 6f75 746c 696e  dd] + det_outlin
+0003f0a0: 655f 7831 202a 2064 6574 5f65 315f 795b  e_x1 * det_e1_y[
+0003f0b0: 6464 5d0a 2020 2020 2020 2020 706f 6c79  dd].        poly
+0003f0c0: 5f7a 203d 2064 6574 5f63 656e 7473 5f7a  _z = det_cents_z
+0003f0d0: 5b64 645d 202b 2064 6574 5f6f 7574 6c69  [dd] + det_outli
+0003f0e0: 6e65 5f78 3020 2a20 6465 745f 6530 5f7a  ne_x0 * det_e0_z
+0003f0f0: 5b64 645d 202b 2064 6574 5f6f 7574 6c69  [dd] + det_outli
+0003f100: 6e65 5f78 3120 2a20 6465 745f 6531 5f7a  ne_x1 * det_e1_z
+0003f110: 5b64 645d 0a0a 2020 2020 2020 2020 2320  [dd]..        # 
+0003f120: 6c6f 6f70 2032 3a20 6f6e 206e 7074 7320  loop 2: on npts 
+0003f130: 286f 6273 6572 7661 7469 6f6e 2070 6f69  (observation poi
+0003f140: 6e74 7329 0a20 2020 2020 2020 2066 6f72  nts).        for
+0003f150: 2070 7020 696e 2072 616e 6765 286e 7074   pp in range(npt
+0003f160: 7329 3a0a 0a20 2020 2020 2020 2020 2020  s):..           
+0003f170: 2023 2074 6573 7420 6966 206f 6e20 676f   # test if on go
+0003f180: 6f64 2073 6964 6520 6f66 2064 6574 6563  od side of detec
+0003f190: 746f 720a 2020 2020 2020 2020 2020 2020  tor.            
+0003f1a0: 7363 6120 3d20 280a 2020 2020 2020 2020  sca = (.        
+0003f1b0: 2020 2020 2020 2020 2870 7473 5f78 5b70          (pts_x[p
+0003f1c0: 705d 202d 2064 6574 5f63 656e 7473 5f78  p] - det_cents_x
+0003f1d0: 5b64 645d 2920 2a20 6465 745f 6e6f 726d  [dd]) * det_norm
+0003f1e0: 5f78 5b64 645d 0a20 2020 2020 2020 2020  _x[dd].         
+0003f1f0: 2020 2020 2020 202b 2028 7074 735f 795b         + (pts_y[
+0003f200: 7070 5d20 2d20 6465 745f 6365 6e74 735f  pp] - det_cents_
+0003f210: 795b 6464 5d29 202a 2064 6574 5f6e 6f72  y[dd]) * det_nor
+0003f220: 6d5f 795b 6464 5d0a 2020 2020 2020 2020  m_y[dd].        
+0003f230: 2020 2020 2020 2020 2b20 2870 7473 5f7a          + (pts_z
+0003f240: 5b70 705d 202d 2064 6574 5f63 656e 7473  [pp] - det_cents
+0003f250: 5f7a 5b64 645d 2920 2a20 6465 745f 6e6f  _z[dd]) * det_no
+0003f260: 726d 5f7a 5b64 645d 0a20 2020 2020 2020  rm_z[dd].       
+0003f270: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+0003f280: 2020 2020 6966 2073 6361 203c 3d20 303a      if sca <= 0:
+0003f290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003f2a0: 2063 6f6e 7469 6e75 650a 0a20 2020 2020   continue..     
+0003f2b0: 2020 2020 2020 2023 206c 6f6f 7020 6f6e         # loop on
+0003f2c0: 2074 7269 616e 676c 6573 0a20 2020 2020   triangles.     
+0003f2d0: 2020 2020 2020 2066 6f72 2074 7420 696e         for tt in
+0003f2e0: 2072 616e 6765 2874 7269 2e73 6861 7065   range(tri.shape
+0003f2f0: 5b30 5d29 3a0a 0a20 2020 2020 2020 2020  [0]):..         
+0003f300: 2020 2020 2020 2023 2063 6f6d 7075 7461         # computa
+0003f310: 7469 6f6e 2032 3a20 736f 6c69 6420 616e  tion 2: solid an
+0003f320: 676c 6520 6f66 2074 7269 616e 676c 6520  gle of triangle 
+0003f330: 6672 6f6d 2070 7473 0a20 2020 2020 2020  from pts.       
+0003f340: 2020 2020 2020 2020 2073 6f6c 6964 5f61           solid_a
+0003f350: 6e67 6c65 5b64 642c 2070 705d 202b 3d20  ngle[dd, pp] += 
+0003f360: 5f73 742e 636f 6d70 5f73 615f 7472 6928  _st.comp_sa_tri(
+0003f370: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003f380: 2020 2020 2070 6f6c 795f 785b 7472 695b       poly_x[tri[
+0003f390: 7474 2c20 305d 5d2c 0a20 2020 2020 2020  tt, 0]],.       
+0003f3a0: 2020 2020 2020 2020 2020 2020 2070 6f6c               pol
+0003f3b0: 795f 795b 7472 695b 7474 2c20 305d 5d2c  y_y[tri[tt, 0]],
+0003f3c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003f3d0: 2020 2020 2070 6f6c 795f 7a5b 7472 695b       poly_z[tri[
+0003f3e0: 7474 2c20 305d 5d2c 0a20 2020 2020 2020  tt, 0]],.       
+0003f3f0: 2020 2020 2020 2020 2020 2020 2070 6f6c               pol
+0003f400: 795f 785b 7472 695b 7474 2c20 315d 5d2c  y_x[tri[tt, 1]],
+0003f410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003f420: 2020 2020 2070 6f6c 795f 795b 7472 695b       poly_y[tri[
+0003f430: 7474 2c20 315d 5d2c 0a20 2020 2020 2020  tt, 1]],.       
+0003f440: 2020 2020 2020 2020 2020 2020 2070 6f6c               pol
+0003f450: 795f 7a5b 7472 695b 7474 2c20 315d 5d2c  y_z[tri[tt, 1]],
+0003f460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003f470: 2020 2020 2070 6f6c 795f 785b 7472 695b       poly_x[tri[
+0003f480: 7474 2c20 325d 5d2c 0a20 2020 2020 2020  tt, 2]],.       
+0003f490: 2020 2020 2020 2020 2020 2020 2070 6f6c               pol
+0003f4a0: 795f 795b 7472 695b 7474 2c20 325d 5d2c  y_y[tri[tt, 2]],
+0003f4b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003f4c0: 2020 2020 2070 6f6c 795f 7a5b 7472 695b       poly_z[tri[
+0003f4d0: 7474 2c20 325d 5d2c 0a20 2020 2020 2020  tt, 2]],.       
+0003f4e0: 2020 2020 2020 2020 2020 2020 2070 7473               pts
+0003f4f0: 5f78 5b70 705d 2c0a 2020 2020 2020 2020  _x[pp],.        
+0003f500: 2020 2020 2020 2020 2020 2020 7074 735f              pts_
+0003f510: 795b 7070 5d2c 0a20 2020 2020 2020 2020  y[pp],.         
+0003f520: 2020 2020 2020 2020 2020 2070 7473 5f7a             pts_z
+0003f530: 5b70 705d 2c0a 2020 2020 2020 2020 2020  [pp],.          
+0003f540: 2020 2020 2020 290a 0a20 2020 2072 6574        )..    ret
+0003f550: 7572 6e20 736f 6c69 645f 616e 676c 65    urn solid_angle
```

### Comparing `tofu-1.7.7/tofu/geom/_basic_geom_tools.pxd` & `tofu-1.7.8/tofu/geom/_basic_geom_tools.pxd`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/_basic_geom_tools.pyx` & `tofu-1.7.8/tofu/geom/_basic_geom_tools.pyx`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/_chained_list.pyx` & `tofu-1.7.8/tofu/geom/_chained_list.pyx`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/_check_optics.py` & `tofu-1.7.8/tofu/geom/_check_optics.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/_comp.py` & `tofu-1.7.8/tofu/geom/_comp.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/_comp_optics.py` & `tofu-1.7.8/tofu/geom/_comp_optics.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/_core.py` & `tofu-1.7.8/tofu/geom/_core.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/_core_optics.py` & `tofu-1.7.8/tofu/geom/_core_optics.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/_def.py` & `tofu-1.7.8/tofu/geom/_def.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/_def_config.py` & `tofu-1.7.8/tofu/geom/_def_config.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/_distance_tools.pxd` & `tofu-1.7.8/tofu/geom/_distance_tools.pxd`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/_distance_tools.pyx` & `tofu-1.7.8/tofu/geom/_distance_tools.pyx`

 * *Files 3% similar despite different names*

```diff
@@ -15,14 +15,15 @@
 cimport cython
 from cython.parallel import prange
 from cython.parallel cimport parallel
 from libc.math cimport fabs as c_abs
 from libc.math cimport sqrt as c_sqrt
 from libc.math cimport NAN as C_NAN
 from libc.stdlib cimport malloc, free
+# from libc.stdio cimport printf    # for debug
 from ._basic_geom_tools cimport _VSMALL
 from . cimport _basic_geom_tools as _bgt
 from . cimport _sampling_tools as _st
 
 # ==============================================================================
 # == DISTANCE CIRCLE - LOS
 # ==============================================================================
@@ -120,16 +121,16 @@
         if (b1sqr > zero) :
             # B' = (0,b1',b2') where b1' != 0.  See Sections 1.1.2 and 1.2.2
             # of the PDF documentation.
             b1 = c_sqrt(b1sqr)
             rm0sqr = radius * m0sqr
             if (rm0sqr > b1):
                 twoThirds = 2.0 / 3.0
-                sHat = c_sqrt((rm0sqr * b1sqr)**twoThirds - b1sqr) / m0
-                gHat = rm0sqr * sHat / c_sqrt(m0sqr * sHat * sHat + b1sqr)
+                sHat = c_sqrt(c_abs((rm0sqr * b1sqr)**twoThirds - b1sqr)) / m0
+                gHat = rm0sqr * sHat / c_sqrt(c_abs(m0sqr * sHat * sHat + b1sqr))
                 cutoff = gHat - sHat
                 if (m2b2 <= -cutoff):
                     s = _bgt.compute_bisect(m2b2, rm0sqr, m0sqr, b1sqr, -m2b2, -m2b2 + rm0)
                     roots[numRoots] = s
                     numRoots += 1
                     if (m2b2 == -cutoff):
                         roots[numRoots] = -sHat
@@ -385,16 +386,16 @@
         if (b1sqr > zero) :
             # B' = (0,b1',b2') where b1' != 0.  See Sections 1.1.2 and 1.2.2
             # of the PDF documentation.
             b1 = c_sqrt(b1sqr)
             rm0sqr = radius * m0sqr
             if (rm0sqr > b1):
                 twoThirds = 2.0 / 3.0
-                sHat = c_sqrt((rm0sqr * b1sqr)**twoThirds - b1sqr) / m0
-                gHat = rm0sqr * sHat / c_sqrt(m0sqr * sHat * sHat + b1sqr)
+                sHat = c_sqrt(c_abs((rm0sqr * b1sqr)**twoThirds - b1sqr)) / m0
+                gHat = rm0sqr * sHat / c_sqrt(c_abs(m0sqr * sHat * sHat + b1sqr))
                 cutoff = gHat - sHat
                 if (m2b2 <= -cutoff):
                     s = _bgt.compute_bisect(m2b2, rm0sqr, m0sqr, b1sqr, -m2b2, -m2b2 + rm0)
                     roots[numRoots] = s
                     numRoots += 1
                     if (m2b2 == -cutoff):
                         roots[numRoots] = -sHat
@@ -771,68 +772,71 @@
     ---
     This is the cython version, only accessible from cython. If you need
     to use it from Python please use: comp_dist_los_vpoly
     """
     cdef int jj
     cdef double norm_dir2, norm_dir2_ori
     cdef double radius_z
-    cdef double q, coeff, sqd, k
+    cdef double q = C_NAN, coeff = C_NAN, sqd = C_NAN, k = C_NAN
     cdef double v0, v1, val_a, val_b
     cdef double[2] res_a
     cdef double[2] res_b
     cdef double[3] circle_tangent
+    cdef double[3] ray_vdir_norm
     cdef double rdotvec
     res_final[0] = 1000000000
     res_final[1] = 1000000000
 
     # == Compute all solutions =================================================
     # Set tolerance value for ray_vdir[2,ii]
     # eps_uz is the tolerated DZ across 20m (max Tokamak size)
     norm_dir2 = c_sqrt(_bgt.compute_dot_prod(ray_vdir, ray_vdir))
+
     norm_dir2_ori = norm_dir2
     for jj in range(3):
-        ray_vdir[jj] = ray_vdir[jj] / norm_dir2
+        ray_vdir_norm[jj] = ray_vdir[jj] / norm_dir2
     norm_dir2 = 1.
-    if ray_vdir[2] * ray_vdir[2] < crit2:
+
+    if ray_vdir_norm[2] * ray_vdir_norm[2] < crit2:
         # -- Case with horizontal semi-line ------------------------------------
         for jj in range(nvert-1):
             if (lpolyy[jj+1] - lpolyy[jj])**2 > eps_vz * eps_vz:
                 # If segment AB is NOT horizontal, then we can compute distance
                 # between LOS and cone.
                 # First we compute the "circle" on the cone that lives on the
                 # same plane as the line
                 q = (ray_orig[2] - lpolyy[jj]) / (lpolyy[jj+1] - lpolyy[jj])
                 if q < 0. :
                     # Then we only need to compute distance to circle C_A
-                    dist_los_circle_core(ray_vdir, ray_orig,
+                    dist_los_circle_core(ray_vdir_norm, ray_orig,
                                         lpolyx[jj], lpolyy[jj],
                                         norm_dir2, res_a)
                 elif q > 1:
                     # Then we only need to compute distance to circle C_B
-                    dist_los_circle_core(ray_vdir, ray_orig,
+                    dist_los_circle_core(ray_vdir_norm, ray_orig,
                                          lpolyx[jj+1], lpolyy[jj+1],
                                          norm_dir2, res_a)
                 else:
                     # The we need to compute the radius (the height is Z_D)
                     # of the circle in the same plane as the LOS and compute the
                     # distance between the LOS and circle.
                     radius_z = q * (lpolyx[jj+1] - lpolyx[jj]) + lpolyx[jj]
-                    dist_los_circle_core(ray_vdir, ray_orig,
+                    dist_los_circle_core(ray_vdir_norm, ray_orig,
                                          radius_z, ray_orig[2],
                                          norm_dir2, res_a)
                     if res_a[1] < _VSMALL:
                         # The line is either tangent or intersects the frustum
                         # we need to make the difference
                         k = res_a[0]
                         # we compute the ray from circle center to P
-                        circle_tangent[0] = -ray_orig[0] - k * ray_vdir[0]
-                        circle_tangent[1] = -ray_orig[1] - k * ray_vdir[1]
+                        circle_tangent[0] = -ray_orig[0] - k * ray_vdir_norm[0]
+                        circle_tangent[1] = -ray_orig[1] - k * ray_vdir_norm[1]
                         circle_tangent[2] = 0. # the line is horizontal
                         rdotvec = _bgt.compute_dot_prod(circle_tangent,
-                                                        ray_vdir)
+                                                        ray_vdir_norm)
                         if c_abs(rdotvec) > _VSMALL:
                             # There is an intersection, distance = C_NAN
                             res_final[1] = C_NAN # distance
                             res_final[0] = C_NAN # k
                             # no need to continue
                             return
                 if (res_final[1] - res_a[1] > _VSMALL
@@ -852,46 +856,46 @@
                     if c_abs(ray_orig[2] - lpolyy[jj]) <= res_final[1]:
                         res_final[0] = 0 # k
                         res_final[1] = c_abs(ray_orig[2] - lpolyy[jj])
                 else:
                     # Then the shortest distance is the distance to the
                     # outline circles
                     # computing dist to cricle C_A of radius R_A and height Z_A
-                    dist_los_circle_core(ray_vdir, ray_orig,
+                    dist_los_circle_core(ray_vdir_norm, ray_orig,
                                          lpolyx[jj], lpolyy[jj],
                                          norm_dir2, res_a)
                     if res_a[1] < _VSMALL:
                         # The line is either tangent or intersects the frustum
                         # we need to make the difference
                         k = res_a[0]
                         # we compute the ray from circle center to P
-                        circle_tangent[0] = -ray_orig[0] - k * ray_vdir[0]
-                        circle_tangent[1] = -ray_orig[1] - k * ray_vdir[1]
+                        circle_tangent[0] = -ray_orig[0] - k * ray_vdir_norm[0]
+                        circle_tangent[1] = -ray_orig[1] - k * ray_vdir_norm[1]
                         circle_tangent[2] = 0. # the ray is horizontal
                         rdotvec = _bgt.compute_dot_prod(circle_tangent,
-                                                        ray_vdir)
+                                                        ray_vdir_norm)
                         if c_abs(rdotvec) > _VSMALL:
                             # There is an intersection, distance = C_NAN
                             res_final[1] = C_NAN # distance
                             res_final[0] = C_NAN # k
                             # no need to continue
                             return
-                    dist_los_circle_core(ray_vdir, ray_orig,
+                    dist_los_circle_core(ray_vdir_norm, ray_orig,
                                          lpolyx[jj+1], lpolyy[jj+1],
                                          norm_dir2, res_b)
                     if res_b[1] < _VSMALL:
                         # The line is either tangent or intersects the frustum
                         # we need to make the difference
                         k = res_b[0]
                         # we compute the ray from circle center to P
-                        circle_tangent[0] = -ray_orig[0] - k * ray_vdir[0]
-                        circle_tangent[1] = -ray_orig[1] - k * ray_vdir[1]
+                        circle_tangent[0] = -ray_orig[0] - k * ray_vdir_norm[0]
+                        circle_tangent[1] = -ray_orig[1] - k * ray_vdir_norm[1]
                         circle_tangent[2] = 0. # the ray is horizontal
                         rdotvec = _bgt.compute_dot_prod(circle_tangent,
-                                                        ray_vdir)
+                                                        ray_vdir_norm)
                         if c_abs(rdotvec) > _VSMALL:
                             # There is an intersection, distance = C_NAN
                             res_final[1] = C_NAN # distance
                             res_final[0] = C_NAN # k
                             # no need to continue
                             return
                     # The result is the one associated to the shortest distance
@@ -901,14 +905,15 @@
                         res_final[0] = res_a[0] # k
                         res_final[1] = res_a[1] # distance
                     if (res_final[1] - res_b[1] > _VSMALL
                         or (res_final[1] == res_b[1]
                          and res_final[0] - res_b[0] > _VSMALL)):
                         res_final[0] = res_b[0] # k
                         res_final[1] = res_b[1] # distance
+
     else:
         # == More general non-horizontal semi-line case ========================
         for jj in range(nvert-1):
             v0 = lpolyx[jj+1]-lpolyx[jj]
             v1 = lpolyy[jj+1]-lpolyy[jj]
             val_a = v0 * v0 - upar2 * v1 * invuz * v1 * invuz
             val_b = lpolyx[jj] * v0 + v1 * invuz * (
@@ -930,128 +935,138 @@
                             and ray_orig[2] >= min(lpolyy[jj], lpolyy[jj+1])):
                             # origin of line in the length of cylinder:
                             res_a[0] = 0
                             res_a[1] = c_abs(upar2 - lpolyx[jj])
                         elif (lpolyy[jj] >= ray_orig[2]
                               and ray_orig[2] <= lpolyy[jj+1]):
                             # ray origin below cylinder
-                            if ray_vdir[2] < 0:
+                            if ray_vdir_norm[2] < 0:
                                 # if the ray is going down origin is the closest
                                 res_a[0] = 0
-                                res_a[1] = c_sqrt((lpolyx[jj] - upar2)**2
-                                                 + (min(lpolyy[jj], lpolyy[jj+1])
-                                                    - ray_orig[2])**2)
+                                res_a[1] = c_sqrt(c_abs(
+                                    (lpolyx[jj] - upar2)**2
+                                    + (min(lpolyy[jj], lpolyy[jj+1]) - ray_orig[2])**2
+                                ))
                             else:
                                 res_a[0] = (min(lpolyy[jj], lpolyy[jj+1])
                                             - ray_orig[2]) * invuz
                                 res_a[1] = c_abs(lpolyx[jj] - upar2)
                         else:
                             # ray origin above cylinder
-                            if ray_vdir[2] > 0:
+                            if ray_vdir_norm[2] > 0:
                                 # if the ray is going up origin is the closest
                                 res_a[0] = 0
-                                res_a[1] = c_sqrt((lpolyx[jj] - upar2)**2
-                                                 + (max(lpolyy[jj], lpolyy[jj+1])
-                                                    - ray_orig[2])**2)
+                                res_a[1] = c_sqrt(c_abs(
+                                    (lpolyx[jj] - upar2)**2
+                                    + (max(lpolyy[jj], lpolyy[jj+1]) - ray_orig[2])**2
+                                ))
                             else:
                                 res_a[0] = (max(lpolyy[jj], lpolyy[jj+1])
                                             - ray_orig[2]) * invuz
                                 res_a[1] = c_abs(lpolyx[jj] - upar2)
                 else: # (val_b * val_b > eps_b * eps_b):
                     q = -coeff / (2. * val_b)
                     if q < 0. :
                         # Then we only need to compute distance to circle C_A
-                        dist_los_circle_core(ray_vdir, ray_orig,
+                        dist_los_circle_core(ray_vdir_norm, ray_orig,
                                             lpolyx[jj], lpolyy[jj],
                                              norm_dir2, res_a)
                     elif q > 1:
                         # Then we only need to compute distance to circle C_B
-                        dist_los_circle_core(ray_vdir, ray_orig,
+                        dist_los_circle_core(ray_vdir_norm, ray_orig,
                                             lpolyx[jj+1], lpolyy[jj+1],
                                              norm_dir2, res_a)
                     else :
                         k = (q * v1 - (ray_orig[2] - lpolyy[jj])) * invuz
                         if k >= 0.:
                             # Then there is an intersection
                             res_final[0] = C_NAN
                             res_final[1] = C_NAN
                             return # no need to move forward
                         else:
                             # The closest point on the line is the LOS origin
                             res_a[0] = 0
                             res_a[1] = -k * c_sqrt(norm_dir2)
+
                 if (res_final[1] - res_a[1] > _VSMALL
                     or (res_final[1] == res_a[1]
                         and res_final[0] - res_a[0] > _VSMALL)):
                     res_final[0] = res_a[0] # k
                     res_final[1] = res_a[1] # distance
+
             elif (val_b * val_b >= val_a * coeff):
-                sqd = c_sqrt(val_b * val_b - val_a * coeff)
+
+                sqd = c_sqrt(c_abs(val_b * val_b - val_a * coeff))
                 # First solution
                 q = (-val_b + sqd) / val_a
                 if q < 0:
                     # Then we only need to compute distance to circle C_A
-                    dist_los_circle_core(ray_vdir, ray_orig,
+                    dist_los_circle_core(ray_vdir_norm, ray_orig,
                                          lpolyx[jj], lpolyy[jj],
                                          norm_dir2, res_a)
                 elif q > 1:
                     # Then we only need to compute distance to circle C_B
-                    dist_los_circle_core(ray_vdir, ray_orig,
+                    dist_los_circle_core(ray_vdir_norm, ray_orig,
                                          lpolyx[jj+1], lpolyy[jj+1],
                                          norm_dir2, res_a)
                 else :
                     k = (q * v1 - (ray_orig[2] - lpolyy[jj])) * invuz
                     if k >= 0.:
                         # There is an intersection
                         res_final[0] = C_NAN
                         res_final[1] = C_NAN
                         return # no need to continue
                     else:
                         # The closest point on the LOS is its origin
                         res_a[0] = 0
                         res_a[1] = -k * c_sqrt(norm_dir2)
+
                 if (res_final[1] - res_a[1] > _VSMALL
                     or (res_final[1] == res_a[1]
                         and res_final[0] - res_a[0] > _VSMALL)):
                     res_final[0] = res_a[0] # k
                     res_final[1] = res_a[1] # distance
+
                 # Second solution
                 q = (-val_b - sqd) / val_a
                 if q < 0:
                     # Then we only need to compute distance to circle C_A
-                    dist_los_circle_core(ray_vdir, ray_orig,
+                    dist_los_circle_core(ray_vdir_norm, ray_orig,
                                          lpolyx[jj], lpolyy[jj],
                                          norm_dir2, res_b)
                 elif q > 1:
                     # Then we only need to compute distance to circle C_B
-                    dist_los_circle_core(ray_vdir, ray_orig,
+                    dist_los_circle_core(ray_vdir_norm, ray_orig,
                                          lpolyx[jj+1], lpolyy[jj+1],
                                          norm_dir2, res_b)
                 else:
                     k = (q * v1 - (ray_orig[2] - lpolyy[jj])) * invuz
                     if k>=0.:
                         # there is an intersection
                         res_final[0] = C_NAN
                         res_final[1] = C_NAN
                         return # no need to continue
                     else:
                         # The closest point on the LOS is its origin
                         res_b[0] = 0
                         res_b[1] = -k * c_sqrt(norm_dir2)
+
                 if (res_final[1] - res_b[1] > _VSMALL
                     or (res_final[1] == res_b[1]
                         and res_final[0] - res_b[0] > _VSMALL)):
                     res_final[0] = res_b[0]
                     res_final[1] = res_b[1]
+
     res_final[0] = res_final[0] / norm_dir2_ori
     return
 
-# ==============================================================================
+# =============================================================================
 # == ARE LOS AND EXT-POLY CLOSE
-# ==============================================================================
+# =============================================================================
+
 cdef inline void is_close_los_vpoly_vec_core(int num_poly, int nlos,
                                              double* ray_orig,
                                              double* ray_vdir,
                                              double[:,:,::1] ves_poly,
                                              double eps_uz,
                                              double eps_a,
                                              double eps_vz,
@@ -1297,8 +1312,8 @@
                 if not loc_res[1] == loc_res[1]:
                     #the closer poly is the one just before
                     ind_close_tab[ind_los] = ind_pol-1
                     continue
         free(loc_dir)
         free(loc_org)
         free(loc_res)
-    return
+    return
```

### Comparing `tofu-1.7.7/tofu/geom/_etendue.py` & `tofu-1.7.8/tofu/geom/_etendue.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/_openmp_tools.pyx` & `tofu-1.7.8/tofu/geom/_openmp_tools.pyx`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/_plot.py` & `tofu-1.7.8/tofu/geom/_plot.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/_plot_optics.py` & `tofu-1.7.8/tofu/geom/_plot_optics.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/_raytracing_tools.pxd` & `tofu-1.7.8/tofu/geom/_raytracing_tools.pxd`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/_raytracing_tools.pyx` & `tofu-1.7.8/tofu/geom/_raytracing_tools.pyx`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/_sampling_tools.pxd` & `tofu-1.7.8/tofu/geom/_sampling_tools.pxd`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/_sampling_tools.pyx` & `tofu-1.7.8/tofu/geom/_sampling_tools.pyx`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/_sorted_set.pyx` & `tofu-1.7.8/tofu/geom/_sorted_set.pyx`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/_vignetting_tools.pxd` & `tofu-1.7.8/tofu/geom/_vignetting_tools.pxd`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/_vignetting_tools.pyx` & `tofu-1.7.8/tofu/geom/_vignetting_tools.pyx`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/AUG_V0_from_V1.py` & `tofu-1.7.8/tofu/geom/inputs/AUG_V0_from_V1.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_EFCupper0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_EFCupper0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_VStabPlatelower.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_VStabPlatelower.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_VStabPlateupper.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpSPARC_VStabPlateupper.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_B03A1.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_B03A1.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_B03A2.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_B03A2.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_B03A3.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_B03A3.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_E03A1.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_E03A1.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_E03A3.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_E03A3.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_T03A1.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_T03A1.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_T03A2.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_T03A2.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpTCV_T03A3.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpTCV_T03A3.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpWEST_DivLow1V0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpWEST_DivLow1V0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpWEST_DivLow2V0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpWEST_DivLow2V0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpWEST_DivUp1V0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpWEST_DivUp1V0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_CoilPF_ExpWEST_DivUp2V0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_CoilPF_ExpWEST_DivUp2V0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpAUG_ICRHa.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpAUG_ICRHa.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpAUG_SBi.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpAUG_SBi.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpCOMPASS_inner.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpCOMPASS_inner.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpCOMPASS_lower.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpCOMPASS_lower.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpCOMPASS_outer.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpCOMPASS_outer.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpCOMPASS_upper.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpCOMPASS_upper.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpDEMO2019_BlanketInnerV0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpDEMO2019_BlanketInnerV0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpDEMO2019_BlanketOuterV0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpDEMO2019_BlanketOuterV0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpDEMO2019_DivertorV0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpDEMO2019_DivertorV0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpDEMO2019_LimiterEquatV0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpDEMO2019_LimiterEquatV0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpDEMO2019_LimiterUpperV0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpDEMO2019_LimiterUpperV0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_BLK01.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_BLK01.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_BLK02.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_BLK02.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_BLK03.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_BLK03.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_BLK04.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_BLK04.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_BLK05.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_BLK05.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_BLK06.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_BLK06.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_BLK07.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_BLK07.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_BLK08.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_BLK08.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_BLK09.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_BLK09.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_BLK10.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_BLK10.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_BLK11.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_BLK11.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_BLK12.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_BLK12.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_BLK13.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_BLK13.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_BLK14.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_BLK14.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_BLK15.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_BLK15.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_BLK16.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_BLK16.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_BLK17.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_BLK17.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_BLK18.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_BLK18.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_Div1.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_Div1.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_Div2.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_Div2.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_Div3.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_Div3.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_Div4.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_Div4.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_Div5.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_Div5.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_Div6.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_Div6.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpITER_Div7.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpITER_Div7.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpNSTX_BumperOutter01.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpNSTX_BumperOutter01.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpNSTX_BumperOutter02.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpNSTX_BumperOutter02.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpNSTX_BumperOutter03.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpNSTX_BumperOutter03.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpNSTX_BumperOutter04.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpNSTX_BumperOutter04.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpNSTX_DivertorLower.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpNSTX_DivertorLower.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpNSTX_DivertorUpper.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpNSTX_DivertorUpper.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpNSTX_ICRFAntenna.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpNSTX_ICRFAntenna.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpNSTX_VesselOutter01.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpNSTX_VesselOutter01.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpNSTX_VesselOutter02.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpNSTX_VesselOutter02.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpNSTX_path70015.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpNSTX_path70015.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpNSTX_path70085.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpNSTX_path70085.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpSPARC_ICRH0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpSPARC_ICRH0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpTOMAS_AntennaV0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpTOMAS_AntennaV0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpTOMAS_LimiterV0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpTOMAS_LimiterV0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_BaffleV0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_BaffleV0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_BaffleV1.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_BaffleV1.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_BaffleV2.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_BaffleV2.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_BumperInnerV0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_BumperInnerV0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_BumperInnerV1.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_BumperInnerV1.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_BumperInnerV2.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_BumperInnerV2.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_BumperInnerV3.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_BumperInnerV3.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_BumperOuterV0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_BumperOuterV0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_BumperOuterV1.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_BumperOuterV1.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_BumperOuterV2.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_BumperOuterV2.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_BumperOuterV3.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_BumperOuterV3.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_CasingCoverLDivV0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_CasingCoverLDivV0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_CasingCoverUDivV0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_CasingCoverUDivV0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_CasingLDivV0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_CasingLDivV0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_CasingPFUPlateLDivV0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_CasingPFUPlateLDivV0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_CasingPFUPlateUDivV0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_CasingPFUPlateUDivV0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_CasingPJLDivV0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_CasingPJLDivV0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_CasingPJUDivV0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_CasingPJUDivV0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_CasingUDivV0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_CasingUDivV0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_DivLowGCV2.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_DivLowGCV2.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_DivLowGCV3.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_DivLowGCV3.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_DivLowITERV0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_DivLowITERV0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_DivLowITERV1.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_DivLowITERV1.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_DivLowITERV2.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_DivLowITERV2.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_DivLowITERV3.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_DivLowITERV3.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_DivUpV3.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_DivUpV3.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_IC1V0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_IC1V0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_IC1V1.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_IC1V1.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_IC2V0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_IC2V0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_IC2V1.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_IC2V1.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_IC3V0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_IC3V0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_IC3V1.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_IC3V1.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_LH1V0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_LH1V0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_LH1V1.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_LH1V1.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_LH2V0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_LH2V0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_LH2V1.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_LH2V1.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_RippleV0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_RippleV0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_RippleV1.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_RippleV1.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_ThermalShieldHFSV0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_ThermalShieldHFSV0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_ThermalShieldLFSLowV0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_ThermalShieldLFSLowV0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_ThermalShieldLFSSlimV0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_ThermalShieldLFSSlimV0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_ThermalShieldLFSUpV0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_ThermalShieldLFSUpV0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_ThermalShieldLFSWideV0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_ThermalShieldLFSWideV0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PFC_ExpWEST_VDEV0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PFC_ExpWEST_VDEV0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_PlasmaDomain_ExpWEST_Sep.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_PlasmaDomain_ExpWEST_Sep.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpAUG_V0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpAUG_V0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpAUG_VESiR.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpAUG_VESiR.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpCOMPASS2_V0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpCOMPASS2_V0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpCOMPASS_InnerV1.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpCOMPASS_InnerV1.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpCOMPASS_V0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpCOMPASS_V0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpDEMO2019_V0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpDEMO2019_V0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpITER_Cryostat.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpITER_Cryostat.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpITER_InnerV0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpITER_InnerV0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpITER_OuterV0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpITER_OuterV0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpITER_V0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpITER_V0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpITER_V1.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpITER_V1.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpJET_V0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpJET_V0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpKSTAR_V0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpKSTAR_V0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpMAST_V0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpMAST_V0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpNSTX_V0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpNSTX_V0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpNSTX_VesselInner.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpNSTX_VesselInner.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpSPARC_CoilTFInner.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpSPARC_CoilTFInner.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpSPARC_CoilTFOuter.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpSPARC_CoilTFOuter.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpSPARC_FirstWallV0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpSPARC_FirstWallV0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpSPARC_VesInner.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpSPARC_VesInner.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpSPARC_VesOuter.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpSPARC_VesOuter.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpTCV_t.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpTCV_t.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpTCV_vIn.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpTCV_vIn.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpTCV_vOut.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpTCV_vOut.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpTOMAS_V0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpTOMAS_V0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpWEST_InnerV0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpWEST_InnerV0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpWEST_OuterV0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpWEST_OuterV0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpWEST_StandardV0.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpWEST_StandardV0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpWEST_StandardV1.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpWEST_StandardV1.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/TFG_Ves_ExpWEST_StandardV2.txt` & `tofu-1.7.8/tofu/geom/inputs/TFG_Ves_ExpWEST_StandardV2.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/WEST_get_details_from_excel.py` & `tofu-1.7.8/tofu/geom/inputs/WEST_get_details_from_excel.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/inputs/get_geom_TCV.py` & `tofu-1.7.8/tofu/geom/inputs/get_geom_TCV.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/geom/utils.py` & `tofu-1.7.8/tofu/geom/utils.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/imas2tofu/__init__.py` & `tofu-1.7.8/tofu/imas2tofu/__init__.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/imas2tofu/_comp.py` & `tofu-1.7.8/tofu/imas2tofu/_comp.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/imas2tofu/_comp_mesh.py` & `tofu-1.7.8/tofu/imas2tofu/_comp_mesh.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/imas2tofu/_comp_toobjects.py` & `tofu-1.7.8/tofu/imas2tofu/_comp_toobjects.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/imas2tofu/_core.py` & `tofu-1.7.8/tofu/imas2tofu/_core.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/imas2tofu/_def.py` & `tofu-1.7.8/tofu/imas2tofu/_def.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/imas2tofu/_mat2ids2calc.py` & `tofu-1.7.8/tofu/imas2tofu/_mat2ids2calc.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/mag/__init__.py` & `tofu-1.7.8/tofu/mag/__init__.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/mag/equimap.py` & `tofu-1.7.8/tofu/mag/equimap.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/mag/magFieldLines.py` & `tofu-1.7.8/tofu/mag/magFieldLines.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/mag/mag_ripple/compile_f2py.sh` & `tofu-1.7.8/tofu/mag/mag_ripple/compile_f2py.sh`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/mag/mag_ripple/mag_ripple.f` & `tofu-1.7.8/tofu/mag/mag_ripple/mag_ripple.f`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/mag/regression_test.py` & `tofu-1.7.8/tofu/mag/regression_test.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/mag/test_equimap.py` & `tofu-1.7.8/tofu/mag/test_equimap.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/mag/test_magFieldLines.py` & `tofu-1.7.8/tofu/mag/test_magFieldLines.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/mag/test_ripple.py` & `tofu-1.7.8/tofu/mag/test_ripple.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/nist2tofu/_requests.py` & `tofu-1.7.8/tofu/nist2tofu/_requests.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/openadas2tofu/_read_files.py` & `tofu-1.7.8/tofu/openadas2tofu/_read_files.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/openadas2tofu/_requests.py` & `tofu-1.7.8/tofu/openadas2tofu/_requests.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/pathfile.py` & `tofu-1.7.8/tofu/pathfile.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/spectro/Ge_AtomicScatteringFactors_LBL.txt` & `tofu-1.7.8/tofu/spectro/Ge_AtomicScatteringFactors_LBL.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/spectro/Ge_AtomicScatteringFactors_NIST.txt` & `tofu-1.7.8/tofu/spectro/Ge_AtomicScatteringFactors_NIST.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/spectro/_analysis_tools.py` & `tofu-1.7.8/tofu/spectro/_analysis_tools.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/spectro/_fit12d.py` & `tofu-1.7.8/tofu/spectro/_fit12d.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/spectro/_fit12d_dextract.py` & `tofu-1.7.8/tofu/spectro/_fit12d_dextract.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/spectro/_fit12d_dinput.py` & `tofu-1.7.8/tofu/spectro/_fit12d_dinput.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/spectro/_fit12d_funccostjac.py` & `tofu-1.7.8/tofu/spectro/_fit12d_funccostjac.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/spectro/_plot.py` & `tofu-1.7.8/tofu/spectro/_plot.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/spectro/_rockingcurve.py` & `tofu-1.7.8/tofu/spectro/_rockingcurve.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/spectro/_rockingcurve_def.py` & `tofu-1.7.8/tofu/spectro/_rockingcurve_def.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/spectro/_rockingcurve_tools.py` & `tofu-1.7.8/tofu/spectro/_rockingcurve_tools.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/spectro/_spectralrange2d.py` & `tofu-1.7.8/tofu/spectro/_spectralrange2d.py`

 * *Files 6% similar despite different names*

```diff
@@ -25,34 +25,35 @@
     ex=None,
     ey=None,
     beta_max=None,
     # geometry
     xx=None,
     length=None,
     rcurve=None,
+    varrad_b=None,
     dist=None,
     # camera
     dcam=None,
     # options
     npts=None,
     # plotting
     plot=None,
     dax=None,
     # saving
     save=None,
     pfe_fig=None,
     pfe_npz=None,
 ):
-    
+
     """
-    
+
     lamb0: target wavelength
     bragg0: target bragg angle
     rcurve: radii of curvature
-    
+
     ap: point source position
     xx: distance between point source and crystals
     dist: lenght of rays after reflexion
     beta_max: maximum angular opening from point source (optionnal)
     npts: nb of rays from point source to crystals
     length: crystal length
 
@@ -72,19 +73,29 @@
         dcam=dcam,
         **din,
     )
 
     # -------------
     # format output
 
-    ilamb_min = np.nanargmin(lamb, axis=0)
-    ilamb_max = np.nanargmax(lamb, axis=0)
-    
-    lamb_min = np.array([lamb[imin, ii] for ii, imin in enumerate(ilamb_min)])
-    lamb_max = np.array([lamb[imax, ii] for ii, imax in enumerate(ilamb_max)])
+
+    ilamb_min = np.full((lamb.shape[1],), -1)
+    ilamb_max = np.full((lamb.shape[1],), -1)
+    iok = np.any(np.isfinite(lamb), axis=0)
+    ilamb_min[iok] = np.nanargmin(lamb[:, iok], axis=0)
+    ilamb_max[iok] = np.nanargmax(lamb[:, iok], axis=0)
+
+    lamb_min = np.array([
+        lamb[imin, ii] if imin >= 0 else np.nan
+        for ii, imin in enumerate(ilamb_min)
+    ])
+    lamb_max = np.array([
+        lamb[imax, ii] if imax >= 0 else np.nan
+        for ii, imax in enumerate(ilamb_max)
+    ])
 
     dout = dict(din)
     dout.update({
         'beta_max': beta_max,
         'crystx': crystx,
         'crysty': crysty,
         'endx': endx,
@@ -92,15 +103,15 @@
         'lamb': lamb,
         'ilamb_min': ilamb_min,
         'ilamb_max': ilamb_max,
         'lamb_min': lamb_min,
         'lamb_max': lamb_max,
         'Dlamb': lamb_max - lamb_min,
     })
-    
+
     if dcam is not None:
         dout['dcam'] = dcam
 
     # ---------
     # plot
 
     if plot is True:
@@ -113,16 +124,16 @@
     # ----------
     # save
 
     if save is True:
         np.savez(pfe_npz, **dout)
 
     # ---------
-    # return 
-    
+    # return
+
     if plot is True:
         return dout, dax
     else:
         return dout
 
 
 # #################################################################
@@ -139,14 +150,15 @@
     ap=None,
     ex=None,
     ey=None,
     # geometry
     xx=None,
     length=None,
     rcurve=None,
+    varrad_b=None,
     dist=None,
     # options
     npts=None,
     # plotting
     plot=None,
     ax=None,
     # saving
@@ -183,23 +195,26 @@
     din = {
         'lamb0': lamb0,
         'bragg0': bragg0,
         # geometry
         'xx': xx,
         'length': length,
         'rcurve': rcurve,
+        'varrad_b': varrad_b,
         'dist': dist,
     }
 
     # -------------
     # get size
 
     # make all arrays
     for k0, v0 in din.items():
-        din[k0] = np.atleast_1d(v0).ravel().astype(float)
+        if v0 is None:
+            din[k0] = np.nan
+        din[k0] = np.atleast_1d(din[k0]).ravel().astype(float)
 
     # sizes
     lsizes = list(set([v0.size for v0 in din.values()]))
     if len(lsizes) == 1:
         pass
     elif 1 in lsizes and len(lsizes) == 2:
         size = [ss for ss in lsizes if ss != 1][0]
@@ -214,27 +229,27 @@
         )
         raise Exception(msg)
 
     # -------
     # values
 
     for k0, v0 in din.items():
-        if k0 != 'rcurve':
+        if k0 not in ['rcurve', 'varrad_b']:
             c0 = np.all(np.isfinite(v0)) and np.all(v0 >= 0.)
 
             if not c0:
                 msg = (
                     f"Arg '{k0}' must be finite and positive\n"
                     f"Provided: {v0}"
                 )
                 raise Exception(msg)
 
     # ------------
     # add basis
-    
+
     din.update(din_basis)
 
     # ---------
     # npts
 
     if npts is None:
         npts = 101
@@ -280,14 +295,15 @@
     ex=None,
     ey=None,
     beta_max=None,
     # geometry
     xx=None,
     length=None,
     rcurve=None,
+    varrad_b=None,
     dist=None,
     # options
     npts=None,
     # camera
     dcam=None,
 ):
 
@@ -299,82 +315,168 @@
     crystx = np.full((npts, size), np.nan)
     crysty = np.full((npts, size), np.nan)
     vnx = np.full((npts, size), np.nan)
     vny = np.full((npts, size), np.nan)
 
     # ----------------
     # compute geometry
+    # ----------------
 
     # 2d
     d2 = lamb0 / np.sin(bragg0)
 
     # summit of crystal
     sx = ap[0] + xx * ex[0]
     sy = ap[1] + xx * ex[1]
 
+    # ------------------------
+    # indices of crystal types
+
+    # variable-radii sinusoidal spiral
+    indb = np.isfinite(varrad_b)
+
     # indices of curved crystals
-    indc = np.isfinite(rcurve)
+    indc = np.isfinite(rcurve) & (~indb)
+
+    # flat
+    indf = (~indc) & (~indb)
+
+    # safety check
+    if not np.all(np.sum([indc, indb, indf], axis=0) == 1):
+        msg = (
+            "Some undetermined 2d crystal shapes:\n"
+            f"\t- indc = {indc}\n"
+            f"\t- indb = {indb}\n"
+            f"\t- indf = {indf}\n"
+        )
+        raise Exception(msg)
+
+    # ---------------------
+    # curved crystals
 
     # center of curvature
     ecx = np.sin(bragg0[indc]) * ex[0] - np.cos(bragg0[indc]) * ey[0]
     ecy = np.sin(bragg0[indc]) * ex[1] - np.cos(bragg0[indc]) * ey[1]
     ecx_p = -ecy
     ecy_p = ecx
-    
+
     cx = sx[indc] - rcurve[indc] * ecx
     cy = sy[indc] - rcurve[indc] * ecy
 
     # half angular opening of crystal
     dalpha = 0.5*length[indc] / rcurve[indc]
     theta = dalpha * np.linspace(-1, 1, npts)[:, None]
 
     # crystal plotting - curved
     ethetax = np.cos(theta) * ecx[None, :] + np.sin(theta) * ecx_p[None, :]
     ethetay = np.cos(theta) * ecy[None, :] + np.sin(theta) * ecy_p[None, :]
-    
+
     crystx[:, indc] = cx[None, :] + rcurve[indc][None, :] * ethetax
     crysty[:, indc] = cy[None, :] + rcurve[indc][None, :] * ethetay
 
+    # local normal vectors
+    vnx[:, indc] = -ethetax
+    vny[:, indc] = -ethetay
+
+    # -----------------------
+    # flat crystals
+
     # crystal plotting - straight
-    estraightx = np.cos(bragg0)[~indc] * ex[0] + np.sin(bragg0)[~indc] * ey[0]
-    estraighty = np.cos(bragg0)[~indc] * ex[1] + np.sin(bragg0)[~indc] * ey[1]
-    
-    ll = 0.5 * length[None, ~indc] * np.linspace(-1, 1, npts)[:, None]
-    crystx[:, ~indc] = sx[None, ~indc] + ll*estraightx[None, :]
-    crysty[:, ~indc] = sy[None, ~indc] + ll*estraighty[None, :]
-    
+    estraightx = np.cos(bragg0)[indf] * ex[0] + np.sin(bragg0)[indf] * ey[0]
+    estraighty = np.cos(bragg0)[indf] * ex[1] + np.sin(bragg0)[indf] * ey[1]
+
+    ll = 0.5 * length[None, indf] * np.linspace(-1, 1, npts)[:, None]
+    crystx[:, indf] = sx[None, indf] + ll*estraightx[None, :]
+    crysty[:, indf] = sy[None, indf] + ll*estraighty[None, :]
+
+    # local normal vectors
+    vnx[:, indf] = -estraighty
+    vny[:, indf] = estraightx
+
+    # -----------------------
+    # variable radii crystals
+
+    # main parameters
+    gam0 = bragg0[indb]
+    r0 = rcurve[indb]
+    ix = ~np.isfinite(r0)
+    r0[ix] = xx[indb][ix]
+    b = varrad_b[indb]
+
+    # local radius of curvature at center
+    # rc0 = r0 / (b * np.sin(gam0))
+
+    # dOMx = r / (b-1) * (cos(phi) / tan(gam) - sin(phi))
+    # dOMy = r / (b-1) * (sin(phi) / tan(gam) + cos(phi))
+    # dL = r/(b-1) * 1 / sin(gam)
+    # dL ~ r0/(b-1) * 1/sin(gam0) * Dgam
+
+    # half angular opening of crystal (approximative)
+    # dgam = 0.5*length / rc0
+    dgam = 1.1 * length[indb] * np.sin(gam0) * (b-1) / r0 / 2
+
+    # gam
+    gam = gam0[None, :] + dgam[None, :] * np.linspace(-1, 1, npts)[:, None]
+
+    # r
+    r = r0[None, :] * (np.sin(gam) / np.sin(gam0)[None, :])**(1/(b[None, :]-1))
+
+    # phi
+    phi = (gam - gam0[None, :]) / (b[None, :]-1)
+
+    # cryst
+
+    crystx[:, indb] = (
+        ap[0]
+        + (xx[indb] - r0) * ex[0]
+        + r * (np.cos(phi) * ex[0]  + np.sin(phi) * ey[0])
+    )
+    crysty[:, indb] = (
+        ap[1]
+        + (xx[indb] - r0) * ex[1]
+        + r * (np.cos(phi) * ex[1]  + np.sin(phi) * ey[1])
+    )
+
+    # derivative
+    c0 = r / (b[None, :] - 1)
+    c1 = np.cos(gam) / np.sin(gam)
+    dOMxx = c0 * (c1 * np.cos(phi) - np.sin(phi))
+    dOMyy = c0 * (c1 * np.sin(phi) + np.cos(phi))
+    dOMx = dOMxx * ex[0] + dOMyy * ey[0]
+    dOMy = dOMxx * ex[1] + dOMyy * ey[1]
+
+    # local normal vectors
+    vnx[:, indb] = dOMy / np.sqrt(dOMx**2 + dOMy**2)
+    vny[:, indb] = -dOMx / np.sqrt(dOMx**2 + dOMy**2)
+
     # ----------------
     # compute rays
+    # ----------------
 
     # vectors of incident rays
     vix = crystx - ap[0]
     viy = crysty - ap[1]
     vin = np.sqrt(vix**2 + viy**2)
     vix = vix / vin
     viy = viy / vin
 
-    # local normal vectors
-    vnx[:, indc] = -ethetax
-    vny[:, indc] = -ethetay
-    vnx[:, ~indc] = -estraighty
-    vny[:, ~indc] = estraightx
 
     # reflected vectors
     sca = vix*vnx + viy*vny
     vrx = vix - 2.*sca*vnx
     vry = viy - 2.*sca*vny
 
     # end of rays at dist
     endx = crystx + dist * vrx
     endy = crysty + dist * vry
 
     # ----------------------
     # compute spectral range
 
-    # get local bragg angle - top and bottom    
+    # get local bragg angle - top and bottom
     bragg = np.arccos(sca) - np.pi/2.
 
     # lamb
     lamb = d2 * np.sin(bragg)
 
     # beta_max
     if beta_max is not None:
@@ -383,40 +485,41 @@
         ind = np.abs(beta) > beta_max
         endx[ind] = np.nan
         endy[ind] = np.nan
         lamb[ind] = np.nan
 
     # -----------------
     # impacts on camera
+    # -----------------
 
     if dcam is not None:
         ninx, niny = dcam['nin'][:2]
         ninn = np.sqrt(ninx**2 + niny**2)
         ninx, niny = ninx/ninn, niny/ninn
-        
+
         ninx_r = ninx * ex[0] + niny * ey[0]
         niny_r = ninx * ex[1] + niny * ey[1]
-        
+
         camx = ap[0] + dcam['cent'][0] * ex[0] + dcam['cent'][1] * ey[0]
         camy = ap[1] + dcam['cent'][0] * ex[1] + dcam['cent'][1] * ey[1]
-        
+
         sca_up = (camx - crystx) * ninx_r + (camy - crysty) * niny_r
         sca_bot = vrx*ninx_r + vry*niny_r
 
         kk = sca_up / sca_bot
         ptsx = crystx + kk * vrx
         ptsy = crysty + kk * vry
 
         e0x = -niny_r
         e0y = ninx_r
         x0 = (ptsx - camx) * e0x + (ptsy - camy) * e0y
-        
+
         if beta_max is not None:
             x0[ind] = np.nan
-            
+
         dcam['x0'] = x0
         dcam['cent_r'] = np.r_[camx, camy]
         dcam['nin_r'] = np.r_[ninx_r, niny_r]
 
     return crystx, crysty, endx, endy, lamb
 
 
@@ -590,20 +693,20 @@
     # ---------------
     # plot input data
 
     kax = 'hor'
     if dax.get(kax) is not None:
         ax = dax[kax]['handle']
         ax.legend(fontsize=12)
-        
+
     if beta_max is None:
         beta_str = 'None'
     else:
         beta_str = f'{beta_max*180/np.pi:5.3} deg'
-    
+
     msg = (
         f"beta_max = {beta_str}\n"
     )
 
     ax.text(
         0.8,
         0.4,
@@ -643,29 +746,29 @@
 
     # ----------
     # saving
 
     if pfe_fig is not None:
         dax['hor']['handle'].figure.savefig(pfe_fig, format='png', dpi=200)
 
-    return ax
+    return dax
 
 
 def _get_axes():
 
     # --------------
     # prepare figure
 
     dmargin = {
-        'left': 0.1, 'right': 0.98,
-        'bottom': 0.1, 'top': 0.90,
-        'hspace': 0.2, 'wspace': 0.2,
+        'left': 0.08, 'right': 0.98,
+        'bottom': 0.08, 'top': 0.90,
+        'hspace': 0.20, 'wspace': 0.25,
     }
 
-    fig = plt.figure(figsize=(12, 8))
+    fig = plt.figure(figsize=(13, 8))
     fig.suptitle('2d ray-tracing model')
     gs = gridspec.GridSpec(ncols=3, nrows=2, **dmargin)
 
     # ----------
     # make axes
 
     # ax0 - hor
@@ -692,8 +795,8 @@
     # dict
 
     dax = {
         'hor': {'handle': ax0},
         'cam': {'handle': ax1},
     }
 
-    return dax
+    return dax
```

### Comparing `tofu-1.7.7/tofu/tests/tests00_root/test_03_plot.py` & `tofu-1.7.8/tofu/tests/tests00_root/test_03_plot.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_01_GG.py` & `tofu-1.7.8/tofu/tests/tests01_geom/test_01_GG.py`

 * *Files 0% similar despite different names*

```diff
@@ -1075,24 +1075,28 @@
         assert not np.isnan(np.sum(RMin0))
         assert not np.isnan(np.sum(Theta0))
         assert not np.isnan(np.sum(p0))
         assert not np.isnan(np.sum(ImpTheta0))
         assert not np.isnan(np.sum(phi0))
 
 
-def test16_dist_los_vpoly():
-    num_rays = 11
+def test16_dist_los_vpoly(debug=False):
+
+    # vessel
     ves_poly = np.zeros((2, 9))
     ves_poly0 = [2, 3, 4, 5, 5, 4, 3, 2, 2]
     ves_poly1 = [2, 1, 1, 2, 3, 4, 4, 3, 2]
     ves_poly[0] = np.asarray(ves_poly0)
     ves_poly[1] = np.asarray(ves_poly1)
+
     # rays :
+    num_rays = 11
     ray_orig = np.zeros((3, num_rays))
     ray_vdir = np.zeros((3, num_rays))
+
     # ray 0 :
     ray_orig[0][0] = 0
     ray_orig[2][0] = 5
     ray_vdir[0][0] = 1
     # ray 1 :
     ray_orig[0][1] = 3.5
     ray_orig[2][1] = 5
@@ -1139,43 +1143,107 @@
     ray_orig[2][9] = 0.5
     ray_vdir[2][9] = -1.
     # ray 10:
     ray_orig[0][10] = 5.5
     ray_orig[1][10] = 0.
     ray_orig[2][10] = 2.5
     ray_vdir[0][10] = 1.
+
     out = GG.comp_dist_los_vpoly(
         np.ascontiguousarray(ray_orig, dtype=np.float64),
         np.ascontiguousarray(ray_vdir, dtype=np.float64),
         ves_poly, disc_step=0.5)
 
-    exact_ks = [3.0,
+    # solutions
+    exact_ks = np.r_[3.0,
                 0.,
                 0.,
                 0.9999999999999992,
                 0.0,
                 1.2576248261177692,
                 6.0,
                 1.0,
                 -0.0,
                 0.0,
                 0.0]
-    exact_dists = [1.0,
+    exact_dists = np.r_[1.0,
                    1.0,
                    1.0,
                    1.4142135623730951,
                    2.0,
                    2.448667030011657,
                    2.0,
                    2.0,
                    1.0,
                    0.5,
                    0.5]
-    assert np.allclose(out[0], exact_ks)
-    assert np.allclose(out[1], exact_dists)
+
+    # -----------------
+    # plot to debug
+    # ------------------
+
+    if debug is True:
+
+        ray_plot = np.concatenate(
+            (
+                ray_orig[..., None],
+                (ray_orig + 4 * ray_vdir)[..., None],
+                np.full((3, num_rays, 1), np.nan)
+            ),
+            axis=-1,
+        ).reshape((3, num_rays * 3))
+
+        import tofu as tf
+        ves = tf.geom.Config(Poly=ves_poly, Name='test', Exp='')
+        dax = ves.plot(proj='3d')
+        dax.plot(ray_plot[0, ...], ray_plot[1, ...], ray_plot[2, ...], '-')
+        dax.plot(ray_orig[0, :], ray_orig[1, :], ray_orig[2, :], marker='o', linestyle='None')
+
+    # ----------------------
+    # tests shapes
+
+    msg0 = (
+        f"\n\t- ves_poly[0, :] = {ves_poly[0, :]}\n"
+        f"\t- ves_poly[1, :] = {ves_poly[1, :]}\n"
+    )
+
+    if out[0].shape != exact_ks.shape:
+        msg = (
+            "Wrong shapes:\n"
+            f"\t- out[0].shape = {out[0].shape}\n"
+            f"\t- exact_ks.shape = {exact_ks.shape}\n"
+        )
+        raise Exception(msg + msg0)
+
+    if out[1].shape != exact_dists.shape:
+        msg = (
+            "Wrong shapes:\n"
+            f"\t- out[1].shape = {out[1].shape}\n"
+            f"\t- exact_dists.shape = {exact_dists.shape}\n"
+        )
+        raise Exception(msg + msg0)
+
+    # ----------------------
+    # tests values
+
+    if not np.allclose(out[0], exact_ks, rtol=1e-12, atol=1e-12, equal_nan=True):
+        msg = (
+            "Wrong values:\n"
+            f"\t- out[0]:\n{out[0]}\n"
+            f"\t- exact_ks:\n{exact_ks}\n"
+        )
+        raise Exception(msg + msg0)
+
+    if not np.allclose(out[1], exact_dists, rtol=1e-12, atol=1e-12, equal_nan=True):
+        msg = (
+            "Wrong values:\n"
+            f"\t- out[1]:\n{out[1]}\n"
+            f"\t- exact_dists:\n{exact_dists}\n"
+        )
+        raise Exception(msg + msg0)
 
 
 # ==============================================================================
 #
 #                           DISTANCE CIRCLE - LOS
 #
 # ==============================================================================
@@ -1950,8 +2018,8 @@
         ax.set_ylabel("Z")
         ax2.set_xlabel("X")
         ax2.set_ylabel("Y")
         ax.legend()
         fig.savefig("test3")
 
         print(are_vis)
-        print(np.shape(are_vis))
+        print(np.shape(are_vis))
```

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_02_compute.py` & `tofu-1.7.8/tofu/tests/tests01_geom/test_02_compute.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_03_core.py` & `tofu-1.7.8/tofu/tests/tests01_geom/test_03_core.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_04_core_optics.py` & `tofu-1.7.8/tofu/tests/tests01_geom/test_04_core_optics.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_04_sampling.py` & `tofu-1.7.8/tofu/tests/tests01_geom/test_04_sampling.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_05_solid_angles.py` & `tofu-1.7.8/tofu/tests/tests01_geom/test_05_solid_angles.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/Inkscape.svg` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/Inkscape.svg`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_CoilPF_Notes.py` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_CoilPF_Notes.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_Baffle_Notes.py` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_Baffle_Notes.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_Baffle_V0.txt` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_Baffle_V0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_Baffle_V1.txt` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_Baffle_V1.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_BumperInner_Notes.py` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_BumperInner_Notes.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_BumperInner_V0.txt` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_BumperInner_V0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_BumperInner_V1.txt` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_BumperInner_V1.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_BumperInner_V2.txt` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_BumperInner_V2.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_BumperOuter_Notes.py` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_BumperOuter_Notes.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_BumperOuter_V0.txt` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_BumperOuter_V0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_BumperOuter_V1.txt` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_BumperOuter_V1.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_BumperOuter_V2.txt` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_BumperOuter_V2.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_DivLowGC_Notes.py` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_DivLowGC_Notes.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_DivLowGC_V2.txt` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_DivLowGC_V2.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_DivLowITER_Notes.py` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_DivLowITER_Notes.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_DivLowITER_V0.txt` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_DivLowITER_V0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_DivLowITER_V1.txt` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_DivLowITER_V1.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_DivLowITER_V2.txt` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_DivLowITER_V2.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_DivUp_Notes.py` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_DivUp_Notes.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_IC1_Notes.py` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_IC1_Notes.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_IC1_V0.txt` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_IC1_V0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_IC1_V1.txt` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_IC1_V1.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_IC2_Notes.py` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_IC2_Notes.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_IC2_V0.txt` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_IC2_V0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_IC2_V1.txt` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_IC2_V1.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_IC3_Notes.py` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_IC3_Notes.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_IC3_V0.txt` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_IC3_V0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_IC3_V1.txt` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_IC3_V1.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_LH1_Notes.py` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_LH1_Notes.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_LH1_V0.txt` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_LH1_V0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_LH1_V1.txt` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_LH1_V1.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_LH2_Notes.py` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_LH2_Notes.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_LH2_V0.txt` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_LH2_V0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_LH2_V1.txt` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_LH2_V1.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PFC_Ripple_Notes.py` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PFC_Ripple_Notes.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_PlasmaDomain_Standard_Notes.py` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_PlasmaDomain_Standard_Notes.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_Ves_VesIn_Notes.py` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_Ves_VesIn_Notes.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_Ves_VesIn_V0.txt` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_Ves_VesIn_V0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_Ves_VesOut_Notes.py` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_Ves_VesOut_Notes.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/WEST_Ves_VesOut_V0.txt` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/WEST_Ves_VesOut_V0.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/test_data/det37_CTVD_incC4_New.npz` & `tofu-1.7.8/tofu/tests/tests01_geom/test_data/det37_CTVD_incC4_New.npz`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests01_geom/testing_tools.py` & `tofu-1.7.8/tofu/tests/tests01_geom/testing_tools.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests02_data/test_03_core.py` & `tofu-1.7.8/tofu/tests/tests02_data/test_03_core.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests02_data/test_04_spectrallines.py` & `tofu-1.7.8/tofu/tests/tests02_data/test_04_spectrallines.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests03_openadas/test_03_core.py` & `tofu-1.7.8/tofu/tests/tests03_openadas/test_03_core.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests04_spectro/test_01_fit12d.py` & `tofu-1.7.8/tofu/tests/tests04_spectro/test_01_fit12d.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests04_spectro/test_02_analysistools.py` & `tofu-1.7.8/tofu/tests/tests04_spectro/test_02_analysistools.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests04_spectro/test_03_rockingcurve.py` & `tofu-1.7.8/tofu/tests/tests04_spectro/test_03_rockingcurve.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests04_spectro/test_data/TFG_CrystalBragg_ExpWEST_DgXICS_ArXVII_sh00000_Vers1.5.0.npz` & `tofu-1.7.8/tofu/tests/tests04_spectro/test_data/TFG_CrystalBragg_ExpWEST_DgXICS_ArXVII_sh00000_Vers1.5.0.npz`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests04_spectro/test_data/UV_spectra_sh55506.npz` & `tofu-1.7.8/tofu/tests/tests04_spectro/test_data/UV_spectra_sh55506.npz`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests04_spectro/test_data/_lines_database.py` & `tofu-1.7.8/tofu/tests/tests04_spectro/test_data/_lines_database.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests04_spectro/test_data/_mask_54041.npz` & `tofu-1.7.8/tofu/tests/tests04_spectro/test_data/_mask_54041.npz`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests04_spectro/test_data/_spectral_constraints.py` & `tofu-1.7.8/tofu/tests/tests04_spectro/test_data/_spectral_constraints.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests04_spectro/test_data/det37_CTVD_incC4_New.npz` & `tofu-1.7.8/tofu/tests/tests04_spectro/test_data/det37_CTVD_incC4_New.npz`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests04_spectro/test_data/spectral_fit.npz` & `tofu-1.7.8/tofu/tests/tests04_spectro/test_data/spectral_fit.npz`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests04_spectro/test_data/west_54046_xics.npz` & `tofu-1.7.8/tofu/tests/tests04_spectro/test_data/west_54046_xics.npz`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests05_nist/test_03_core.py` & `tofu-1.7.8/tofu/tests/tests05_nist/test_03_core.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests06_mesh/test_01_checks.py` & `tofu-1.7.8/tofu/tests/tests06_mesh/test_01_checks.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests06_mesh/test_data/ITER_JINTRAC_sh134000_run30_public_edgesources_quadtrimesh.npz` & `tofu-1.7.8/tofu/tests/tests06_mesh/test_data/ITER_JINTRAC_sh134000_run30_public_edgesources_quadtrimesh.npz`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests06_mesh/test_data/mesh_triangular_WEST_eq.txt` & `tofu-1.7.8/tofu/tests/tests06_mesh/test_data/mesh_triangular_WEST_eq.txt`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests07_inversions/test_01_isotropic.py` & `tofu-1.7.8/tofu/tests/tests07_inversions/test_01_isotropic.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests08_diagnostics/test_01_diagnostics.py` & `tofu-1.7.8/tofu/tests/tests08_diagnostics/test_01_diagnostics.py`

 * *Files 0% similar despite different names*

```diff
@@ -589,14 +589,15 @@
         for k0, v0 in self.obj.dobj['crystal'].items():
             dout = self.obj.get_optics_outline(k0)
 
     def test03_plot(self):
         for ii, (k0, v0) in enumerate(self.obj.dobj['diagnostic'].items()):
             dax = self.obj.plot_diagnostic(
                 k0,
+                data='etendue',
                 proj=(
                     None if ii % 3 == 0
                     else ('cross' if ii % 3 == 1 else ['cross', 'hor'])
                 ),
             )
             plt.close('all')
             del dax
@@ -617,9 +618,8 @@
                 impact_pos=ii % 3 != 0,
                 R0=2.4 if ii % 3 != 1 else None,
                 config=None if ii % 3 != 1 else self.conf,
                 pmax=None if ii % 3 == 0 else 5,
                 plot=True,
             )
             plt.close('all')
-            del dax
-
+            del dax
```

### Comparing `tofu-1.7.7/tofu/tests/tests09_tutorials/test_01_runall.py` & `tofu-1.7.8/tofu/tests/tests09_tutorials/test_01_runall.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests09_tutorials/tuto_plot_basic.py` & `tofu-1.7.8/tofu/tests/tests09_tutorials/tuto_plot_basic.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests09_tutorials/tuto_plot_create_geometry.py` & `tofu-1.7.8/tofu/tests/tests09_tutorials/tuto_plot_create_geometry.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests09_tutorials/tuto_plot_create_geometry_from_svg.py` & `tofu-1.7.8/tofu/tests/tests09_tutorials/tuto_plot_create_geometry_from_svg.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests09_tutorials/tuto_plot_custom_emissivity.py` & `tofu-1.7.8/tofu/tests/tests09_tutorials/tuto_plot_custom_emissivity.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests09_tutorials/tuto_plot_gallery_fusion_machines.py` & `tofu-1.7.8/tofu/tests/tests09_tutorials/tuto_plot_gallery_fusion_machines.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests09_tutorials/tuto_plot_solid_angles.py` & `tofu-1.7.8/tofu/tests/tests09_tutorials/tuto_plot_solid_angles.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tests/tests09_tutorials/tuto_real0.py` & `tofu-1.7.8/tofu/tests/tests09_tutorials/tuto_real0.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/tomotok2tofu/_core.py` & `tofu-1.7.8/tofu/tomotok2tofu/_core.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu/utils.py` & `tofu-1.7.8/tofu/utils.py`

 * *Files identical despite different names*

### Comparing `tofu-1.7.7/tofu.egg-info/PKG-INFO` & `tofu-1.7.8/tofu.egg-info/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: tofu
-Version: 1.7.7
+Version: 1.7.8
 Summary: A python library for Tomography for Fusion
 Home-page: https://github.com/ToFuProject/tofu
 Author: Didier VEZINET and Laura MENDOZA
 Author-email: didier.vezinet@gmail.com
 License: MIT
 Keywords: tomography geometry 3D inversion synthetic fusion
 Platform: UNKNOWN
```

### Comparing `tofu-1.7.7/tofu.egg-info/SOURCES.txt` & `tofu-1.7.8/tofu.egg-info/SOURCES.txt`

 * *Files 0% similar despite different names*

```diff
@@ -55,14 +55,19 @@
 tofu/data/_class05_Crystal.py
 tofu/data/_class05_legacy.py
 tofu/data/_class06_Grating.py
 tofu/data/_class06_compute.py
 tofu/data/_class07_Camera.py
 tofu/data/_class07_legacy.py
 tofu/data/_class08_Diagnostic.py
+tofu/data/_class08_concatenate_data.py
+tofu/data/_class08_get_data.py
+tofu/data/_class08_get_data_def.py
+tofu/data/_class08_get_data_vos_broadband.py
+tofu/data/_class08_get_data_vos_spectro.py
 tofu/data/_class08_save2stp.py
 tofu/data/_class09_GeometryMatrix.py
 tofu/data/_class09_compute_broadband.py
 tofu/data/_class10_Inversion.py
 tofu/data/_class10_algos.py
 tofu/data/_class10_checks.py
 tofu/data/_class10_compute.py
```

### Comparing `tofu-1.7.7/tofu_helpers/openmp_helpers.py` & `tofu-1.7.8/tofu_helpers/openmp_helpers.py`

 * *Files identical despite different names*

