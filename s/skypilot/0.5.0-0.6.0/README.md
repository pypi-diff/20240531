# Comparing `tmp/skypilot-0.5.0.tar.gz` & `tmp/skypilot-0.6.0.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "skypilot-0.5.0.tar", last modified: Tue Feb 27 03:51:32 2024, max compression
+gzip compressed data, was "skypilot-0.6.0.tar", last modified: Thu May 30 22:32:39 2024, max compression
```

## Comparing `skypilot-0.5.0.tar` & `skypilot-0.6.0.tar`

### file list

```diff
@@ -1,335 +1,339 @@
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.991630 skypilot-0.5.0/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    12170 2024-02-03 00:23:03.000000 skypilot-0.5.0/LICENSE
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      673 2024-02-13 18:48:14.000000 skypilot-0.5.0/MANIFEST.in
--rw-r--r--   0 azureuser  (1000) azureuser  (1000)    17043 2024-02-27 03:51:32.991630 skypilot-0.5.0/PKG-INFO
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    11042 2024-02-24 18:52:42.000000 skypilot-0.5.0/README.md
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      640 2024-02-03 00:23:03.000000 skypilot-0.5.0/pyproject.toml
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)       38 2024-02-27 03:51:32.991630 skypilot-0.5.0/setup.cfg
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    12019 2024-02-24 18:52:42.000000 skypilot-0.5.0/setup.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.951629 skypilot-0.5.0/sky/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     3743 2024-02-27 03:51:32.000000 skypilot-0.5.0/sky/__init__.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.951629 skypilot-0.5.0/sky/adaptors/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)        0 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/adaptors/__init__.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     7066 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/adaptors/aws.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     2381 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/adaptors/azure.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     7762 2024-02-21 08:42:09.000000 skypilot-0.5.0/sky/adaptors/cloudflare.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      706 2024-02-17 00:21:43.000000 skypilot-0.5.0/sky/adaptors/cudo.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      852 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/adaptors/docker.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     3194 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/adaptors/gcp.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     5444 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/adaptors/ibm.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     4326 2024-02-22 02:37:01.000000 skypilot-0.5.0/sky/adaptors/kubernetes.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     2054 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/adaptors/oci.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      700 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/adaptors/runpod.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     5792 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/adaptors/vsphere.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    20916 2024-02-22 07:04:17.000000 skypilot-0.5.0/sky/authentication.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.955629 skypilot-0.5.0/sky/backends/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      536 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/backends/__init__.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     5932 2024-02-21 08:42:09.000000 skypilot-0.5.0/sky/backends/backend.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)   115303 2024-02-24 18:52:42.000000 skypilot-0.5.0/sky/backends/backend_utils.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)   222121 2024-02-24 18:52:42.000000 skypilot-0.5.0/sky/backends/cloud_vm_ray_backend.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     8358 2024-02-21 08:42:09.000000 skypilot-0.5.0/sky/backends/docker_utils.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    16741 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/backends/local_docker_backend.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.955629 skypilot-0.5.0/sky/backends/monkey_patches/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     3450 2024-02-21 08:42:09.000000 skypilot-0.5.0/sky/backends/monkey_patches/monkey_patch_ray_up.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     7293 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/backends/wheel_utils.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.955629 skypilot-0.5.0/sky/benchmark/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)        0 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/benchmark/__init__.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     8723 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/benchmark/benchmark_state.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    26732 2024-02-21 08:42:09.000000 skypilot-0.5.0/sky/benchmark/benchmark_utils.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     4233 2024-02-22 02:37:01.000000 skypilot-0.5.0/sky/check.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)   213918 2024-02-22 02:37:01.000000 skypilot-0.5.0/sky/cli.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    11806 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/cloud_stores.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.955629 skypilot-0.5.0/sky/clouds/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     1238 2024-02-22 02:37:01.000000 skypilot-0.5.0/sky/clouds/__init__.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    42571 2024-02-24 03:36:25.000000 skypilot-0.5.0/sky/clouds/aws.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    28632 2024-02-17 00:21:43.000000 skypilot-0.5.0/sky/clouds/azure.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    30698 2024-02-21 08:42:09.000000 skypilot-0.5.0/sky/clouds/cloud.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      955 2024-02-22 02:37:01.000000 skypilot-0.5.0/sky/clouds/cloud_registry.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    12036 2024-02-24 18:52:42.000000 skypilot-0.5.0/sky/clouds/cudo.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    12636 2024-02-22 02:37:01.000000 skypilot-0.5.0/sky/clouds/fluidstack.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    46811 2024-02-26 23:00:20.000000 skypilot-0.5.0/sky/clouds/gcp.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    21044 2024-02-17 00:21:43.000000 skypilot-0.5.0/sky/clouds/ibm.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    16553 2024-02-22 08:06:35.000000 skypilot-0.5.0/sky/clouds/kubernetes.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    12012 2024-02-17 00:21:43.000000 skypilot-0.5.0/sky/clouds/lambda_cloud.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    25308 2024-02-21 08:42:09.000000 skypilot-0.5.0/sky/clouds/oci.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    10788 2024-02-17 00:21:43.000000 skypilot-0.5.0/sky/clouds/runpod.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    15546 2024-02-17 00:21:43.000000 skypilot-0.5.0/sky/clouds/scp.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.959629 skypilot-0.5.0/sky/clouds/service_catalog/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    12844 2024-02-22 02:37:01.000000 skypilot-0.5.0/sky/clouds/service_catalog/__init__.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    11965 2024-02-17 00:21:43.000000 skypilot-0.5.0/sky/clouds/service_catalog/aws_catalog.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     6648 2024-02-17 00:21:43.000000 skypilot-0.5.0/sky/clouds/service_catalog/azure_catalog.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    23173 2024-02-21 08:42:09.000000 skypilot-0.5.0/sky/clouds/service_catalog/common.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     1793 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/clouds/service_catalog/config.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      282 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/clouds/service_catalog/constants.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     4335 2024-02-17 00:21:43.000000 skypilot-0.5.0/sky/clouds/service_catalog/cudo_catalog.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.959629 skypilot-0.5.0/sky/clouds/service_catalog/data_fetchers/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)        0 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/clouds/service_catalog/data_fetchers/__init__.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    22251 2024-02-22 08:21:45.000000 skypilot-0.5.0/sky/clouds/service_catalog/data_fetchers/fetch_aws.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    11325 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/clouds/service_catalog/data_fetchers/fetch_azure.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     5072 2024-02-21 08:42:09.000000 skypilot-0.5.0/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     5487 2024-02-22 02:37:01.000000 skypilot-0.5.0/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    20864 2024-02-17 00:21:43.000000 skypilot-0.5.0/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     4297 2024-02-21 08:42:09.000000 skypilot-0.5.0/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    21330 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     5038 2024-02-22 02:37:01.000000 skypilot-0.5.0/sky/clouds/service_catalog/fluidstack_catalog.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    23959 2024-02-17 00:21:43.000000 skypilot-0.5.0/sky/clouds/service_catalog/gcp_catalog.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     4472 2024-02-17 00:21:43.000000 skypilot-0.5.0/sky/clouds/service_catalog/ibm_catalog.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     4067 2024-02-17 00:21:43.000000 skypilot-0.5.0/sky/clouds/service_catalog/kubernetes_catalog.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     5082 2024-02-17 00:21:43.000000 skypilot-0.5.0/sky/clouds/service_catalog/lambda_catalog.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     7546 2024-02-17 00:21:43.000000 skypilot-0.5.0/sky/clouds/service_catalog/oci_catalog.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     4184 2024-02-17 00:21:43.000000 skypilot-0.5.0/sky/clouds/service_catalog/runpod_catalog.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     5174 2024-02-17 00:21:43.000000 skypilot-0.5.0/sky/clouds/service_catalog/scp_catalog.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     4282 2024-02-17 00:21:43.000000 skypilot-0.5.0/sky/clouds/service_catalog/vsphere_catalog.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.959629 skypilot-0.5.0/sky/clouds/utils/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)        0 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/clouds/utils/__init__.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     6420 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/clouds/utils/gcp_utils.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     9991 2024-02-21 08:42:09.000000 skypilot-0.5.0/sky/clouds/utils/lambda_utils.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     4482 2024-02-16 18:10:12.000000 skypilot-0.5.0/sky/clouds/utils/oci_utils.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    15781 2024-02-21 08:42:09.000000 skypilot-0.5.0/sky/clouds/utils/scp_utils.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    11969 2024-02-17 00:21:43.000000 skypilot-0.5.0/sky/clouds/vsphere.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    40878 2024-02-22 08:06:35.000000 skypilot-0.5.0/sky/core.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     2529 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/dag.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.959629 skypilot-0.5.0/sky/data/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      184 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/data/__init__.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     7346 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/data/data_transfer.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    21557 2024-02-21 08:42:09.000000 skypilot-0.5.0/sky/data/data_utils.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     8226 2024-02-24 03:36:25.000000 skypilot-0.5.0/sky/data/mounting_utils.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)   117417 2024-02-22 02:37:01.000000 skypilot-0.5.0/sky/data/storage.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     6867 2024-02-21 08:42:09.000000 skypilot-0.5.0/sky/data/storage_utils.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     8213 2024-02-22 02:37:01.000000 skypilot-0.5.0/sky/exceptions.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    30492 2024-02-17 00:21:43.000000 skypilot-0.5.0/sky/execution.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    29420 2024-02-22 02:37:01.000000 skypilot-0.5.0/sky/global_user_state.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    54001 2024-02-22 02:37:01.000000 skypilot-0.5.0/sky/optimizer.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.959629 skypilot-0.5.0/sky/provision/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     4907 2024-02-22 02:37:01.000000 skypilot-0.5.0/sky/provision/__init__.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.959629 skypilot-0.5.0/sky/provision/aws/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      782 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/provision/aws/__init__.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    22092 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/provision/aws/config.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    36191 2024-02-21 18:57:08.000000 skypilot-0.5.0/sky/provision/aws/instance.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     3238 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/provision/aws/utils.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.963629 skypilot-0.5.0/sky/provision/azure/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      199 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/provision/azure/__init__.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     4390 2024-02-17 00:21:43.000000 skypilot-0.5.0/sky/provision/azure/instance.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     8561 2024-02-21 18:57:08.000000 skypilot-0.5.0/sky/provision/common.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.963629 skypilot-0.5.0/sky/provision/cudo/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      676 2024-02-17 00:21:43.000000 skypilot-0.5.0/sky/provision/cudo/__init__.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      327 2024-02-17 00:21:43.000000 skypilot-0.5.0/sky/provision/cudo/config.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      696 2024-02-21 08:42:09.000000 skypilot-0.5.0/sky/provision/cudo/cudo_machine_type.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     3958 2024-02-17 00:21:43.000000 skypilot-0.5.0/sky/provision/cudo/cudo_wrapper.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     8202 2024-02-17 00:21:43.000000 skypilot-0.5.0/sky/provision/cudo/instance.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    15685 2024-02-24 18:52:42.000000 skypilot-0.5.0/sky/provision/docker_utils.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.963629 skypilot-0.5.0/sky/provision/fluidstack/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      535 2024-02-22 02:37:01.000000 skypilot-0.5.0/sky/provision/fluidstack/__init__.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      326 2024-02-22 02:37:01.000000 skypilot-0.5.0/sky/provision/fluidstack/config.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     8257 2024-02-22 02:37:01.000000 skypilot-0.5.0/sky/provision/fluidstack/fluidstack_utils.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    11177 2024-02-22 02:37:01.000000 skypilot-0.5.0/sky/provision/fluidstack/instance.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.963629 skypilot-0.5.0/sky/provision/gcp/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      579 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/provision/gcp/__init__.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    31387 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/provision/gcp/config.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     6345 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/provision/gcp/constants.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    24482 2024-02-21 18:57:08.000000 skypilot-0.5.0/sky/provision/gcp/instance.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    58478 2024-02-16 18:10:12.000000 skypilot-0.5.0/sky/provision/gcp/instance_utils.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    20310 2024-02-22 02:37:01.000000 skypilot-0.5.0/sky/provision/instance_setup.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.963629 skypilot-0.5.0/sky/provision/kubernetes/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      653 2024-02-21 18:57:08.000000 skypilot-0.5.0/sky/provision/kubernetes/__init__.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    14212 2024-02-16 18:10:12.000000 skypilot-0.5.0/sky/provision/kubernetes/config.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    30595 2024-02-22 07:04:17.000000 skypilot-0.5.0/sky/provision/kubernetes/instance.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     8164 2024-02-17 00:21:43.000000 skypilot-0.5.0/sky/provision/kubernetes/network.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     8015 2024-02-22 02:37:01.000000 skypilot-0.5.0/sky/provision/kubernetes/network_utils.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    49786 2024-02-22 07:04:17.000000 skypilot-0.5.0/sky/provision/kubernetes/utils.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     2103 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/provision/logging.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     4013 2024-02-21 08:42:09.000000 skypilot-0.5.0/sky/provision/metadata_utils.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    24888 2024-02-22 02:37:01.000000 skypilot-0.5.0/sky/provision/provisioner.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.963629 skypilot-0.5.0/sky/provision/runpod/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      502 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/provision/runpod/__init__.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      321 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/provision/runpod/config.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     7849 2024-02-21 18:57:08.000000 skypilot-0.5.0/sky/provision/runpod/instance.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     4626 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/provision/runpod/utils.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.963629 skypilot-0.5.0/sky/provision/vsphere/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      788 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/provision/vsphere/__init__.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.967630 skypilot-0.5.0/sky/provision/vsphere/common/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)        0 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/provision/vsphere/common/__init__.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     4167 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/provision/vsphere/common/cls_api_client.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    14096 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/provision/vsphere/common/cls_api_helper.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      481 2024-02-19 18:53:00.000000 skypilot-0.5.0/sky/provision/vsphere/common/custom_script.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      303 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/provision/vsphere/common/id_generator.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      914 2024-02-21 08:42:09.000000 skypilot-0.5.0/sky/provision/vsphere/common/metadata_utils.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     1817 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/provision/vsphere/common/service_manager.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      544 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/provision/vsphere/common/service_manager_factory.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      795 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/provision/vsphere/common/ssl_helper.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     2932 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/provision/vsphere/common/vapiconnect.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    17877 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/provision/vsphere/common/vim_utils.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      504 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/provision/vsphere/config.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    24330 2024-02-21 18:57:08.000000 skypilot-0.5.0/sky/provision/vsphere/instance.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    15151 2024-02-21 08:42:09.000000 skypilot-0.5.0/sky/provision/vsphere/vsphere_utils.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    57460 2024-02-22 08:06:35.000000 skypilot-0.5.0/sky/resources.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.967630 skypilot-0.5.0/sky/serve/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     1517 2024-02-22 02:37:01.000000 skypilot-0.5.0/sky/serve/__init__.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    14013 2024-02-17 00:21:43.000000 skypilot-0.5.0/sky/serve/autoscalers.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     3343 2024-02-22 02:37:01.000000 skypilot-0.5.0/sky/serve/constants.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     6491 2024-02-17 00:21:43.000000 skypilot-0.5.0/sky/serve/controller.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    28807 2024-02-26 05:51:45.000000 skypilot-0.5.0/sky/serve/core.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     4689 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/serve/load_balancer.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     2047 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/serve/load_balancing_policies.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    47995 2024-02-21 08:42:09.000000 skypilot-0.5.0/sky/serve/replica_managers.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    15553 2024-02-16 18:10:12.000000 skypilot-0.5.0/sky/serve/serve_state.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    34333 2024-02-22 02:37:01.000000 skypilot-0.5.0/sky/serve/serve_utils.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    10968 2024-02-21 08:42:09.000000 skypilot-0.5.0/sky/serve/service.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    10458 2024-02-21 08:42:09.000000 skypilot-0.5.0/sky/serve/service_spec.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.967630 skypilot-0.5.0/sky/setup_files/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      673 2024-02-13 18:48:14.000000 skypilot-0.5.0/sky/setup_files/MANIFEST.in
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    12019 2024-02-24 18:52:42.000000 skypilot-0.5.0/sky/setup_files/setup.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     3959 2024-02-21 08:42:09.000000 skypilot-0.5.0/sky/sky_logging.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.971630 skypilot-0.5.0/sky/skylet/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    12381 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/skylet/LICENSE
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)        0 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/skylet/__init__.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     1725 2024-02-21 08:42:09.000000 skypilot-0.5.0/sky/skylet/attempt_skylet.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     4379 2024-02-21 21:00:40.000000 skypilot-0.5.0/sky/skylet/autostop_lib.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     1887 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/skylet/configs.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     5552 2024-02-22 02:37:01.000000 skypilot-0.5.0/sky/skylet/constants.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    11542 2024-02-21 08:42:09.000000 skypilot-0.5.0/sky/skylet/events.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    35094 2024-02-22 08:06:35.000000 skypilot-0.5.0/sky/skylet/job_lib.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    17964 2024-02-22 02:37:01.000000 skypilot-0.5.0/sky/skylet/log_lib.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     4292 2024-02-22 02:37:01.000000 skypilot-0.5.0/sky/skylet/log_lib.pyi
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.971630 skypilot-0.5.0/sky/skylet/providers/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)        0 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/skylet/providers/__init__.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.971630 skypilot-0.5.0/sky/skylet/providers/azure/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)       97 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/skylet/providers/azure/__init__.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     4344 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/skylet/providers/azure/azure-config-template.json
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    10901 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/skylet/providers/azure/azure-vm-template.json
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     6203 2024-02-13 22:55:00.000000 skypilot-0.5.0/sky/skylet/providers/azure/config.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    18603 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/skylet/providers/azure/node_provider.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    15645 2024-02-24 18:52:42.000000 skypilot-0.5.0/sky/skylet/providers/command_runner.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.971630 skypilot-0.5.0/sky/skylet/providers/gcp/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)       91 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/skylet/providers/gcp/__init__.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    40048 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/skylet/providers/gcp/config.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     4868 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/skylet/providers/gcp/constants.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    28506 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/skylet/providers/gcp/node.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    15603 2024-02-16 23:54:53.000000 skypilot-0.5.0/sky/skylet/providers/gcp/node_provider.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.971630 skypilot-0.5.0/sky/skylet/providers/ibm/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)       94 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/skylet/providers/ibm/__init__.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    38280 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/skylet/providers/ibm/node_provider.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     1292 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/skylet/providers/ibm/utils.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    34630 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/skylet/providers/ibm/vpc_provider.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.971630 skypilot-0.5.0/sky/skylet/providers/kubernetes/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)       81 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/skylet/providers/kubernetes/__init__.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    13406 2024-02-16 18:10:12.000000 skypilot-0.5.0/sky/skylet/providers/kubernetes/config.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    29340 2024-02-22 07:04:17.000000 skypilot-0.5.0/sky/skylet/providers/kubernetes/node_provider.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.971630 skypilot-0.5.0/sky/skylet/providers/lambda_cloud/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      112 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/skylet/providers/lambda_cloud/__init__.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    13832 2024-02-21 18:57:08.000000 skypilot-0.5.0/sky/skylet/providers/lambda_cloud/node_provider.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.971630 skypilot-0.5.0/sky/skylet/providers/oci/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)       91 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/skylet/providers/oci/__init__.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    20426 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/skylet/providers/oci/node_provider.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    17234 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/skylet/providers/oci/query_helper.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      508 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/skylet/providers/oci/utils.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.971630 skypilot-0.5.0/sky/skylet/providers/scp/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)       91 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/skylet/providers/scp/__init__.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     4683 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/skylet/providers/scp/config.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    22411 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/skylet/providers/scp/node_provider.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.975630 skypilot-0.5.0/sky/skylet/ray_patches/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     2904 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/skylet/ray_patches/__init__.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      294 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/skylet/ray_patches/autoscaler.py.patch
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      391 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/skylet/ray_patches/cli.py.patch
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      224 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/skylet/ray_patches/command_runner.py.patch
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      345 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/skylet/ray_patches/job_head.py.patch
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      528 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/skylet/ray_patches/log_monitor.py.patch
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      658 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/skylet/ray_patches/resource_demand_scheduler.py.patch
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      289 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/skylet/ray_patches/updater.py.patch
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      565 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/skylet/ray_patches/worker.py.patch
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     1144 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/skylet/skylet.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     1348 2024-02-22 02:37:01.000000 skypilot-0.5.0/sky/skylet/subprocess_daemon.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     5122 2024-02-21 08:42:09.000000 skypilot-0.5.0/sky/skypilot_config.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.975630 skypilot-0.5.0/sky/spot/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     1285 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/spot/__init__.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     1117 2024-02-22 08:06:35.000000 skypilot-0.5.0/sky/spot/constants.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    25550 2024-02-21 08:42:09.000000 skypilot-0.5.0/sky/spot/controller.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.975630 skypilot-0.5.0/sky/spot/dashboard/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     2294 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/spot/dashboard/dashboard.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.975630 skypilot-0.5.0/sky/spot/dashboard/static/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    15086 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/spot/dashboard/static/favicon.ico
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.975630 skypilot-0.5.0/sky/spot/dashboard/templates/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     6247 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/spot/dashboard/templates/index.html
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    25656 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/spot/recovery_strategy.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    22487 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/spot/spot_state.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    31689 2024-02-21 08:42:09.000000 skypilot-0.5.0/sky/spot/spot_utils.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     1457 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/status_lib.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    45371 2024-02-22 08:06:35.000000 skypilot-0.5.0/sky/task.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.975630 skypilot-0.5.0/sky/templates/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     7965 2024-02-24 18:52:42.000000 skypilot-0.5.0/sky/templates/aws-ray.yml.j2
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     9640 2024-02-24 18:52:42.000000 skypilot-0.5.0/sky/templates/azure-ray.yml.j2
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     4152 2024-02-17 00:21:43.000000 skypilot-0.5.0/sky/templates/cudo-ray.yml.j2
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     4185 2024-02-22 02:37:01.000000 skypilot-0.5.0/sky/templates/fluidstack-ray.yml.j2
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     9580 2024-02-26 23:00:20.000000 skypilot-0.5.0/sky/templates/gcp-ray.yml.j2
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     7272 2024-02-17 00:21:43.000000 skypilot-0.5.0/sky/templates/ibm-ray.yml.j2
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      854 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/templates/kubernetes-ingress.yml.j2
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      376 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/templates/kubernetes-loadbalancer.yml.j2
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     2547 2024-02-22 02:37:01.000000 skypilot-0.5.0/sky/templates/kubernetes-port-forward-proxy-command.sh.j2
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    10589 2024-02-16 18:10:12.000000 skypilot-0.5.0/sky/templates/kubernetes-ray.yml.j2
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     2668 2024-02-22 07:04:17.000000 skypilot-0.5.0/sky/templates/kubernetes-ssh-jump.yml.j2
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     6366 2024-02-17 00:21:43.000000 skypilot-0.5.0/sky/templates/lambda-ray.yml.j2
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     1185 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/templates/local-ray.yml.j2
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     7633 2024-02-17 00:21:43.000000 skypilot-0.5.0/sky/templates/oci-ray.yml.j2
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     4215 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/templates/runpod-ray.yml.j2
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     6235 2024-02-17 00:21:43.000000 skypilot-0.5.0/sky/templates/scp-ray.yml.j2
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     1000 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/templates/sky-serve-controller.yaml.j2
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     1057 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/templates/spot-controller.yaml.j2
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     4234 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/templates/vsphere-ray.yml.j2
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.975630 skypilot-0.5.0/sky/usage/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)        0 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/usage/__init__.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      590 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/usage/constants.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    17601 2024-02-21 08:42:09.000000 skypilot-0.5.0/sky/usage/usage_lib.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.979630 skypilot-0.5.0/sky/utils/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)        0 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/utils/__init__.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     3798 2024-02-22 02:37:01.000000 skypilot-0.5.0/sky/utils/accelerator_registry.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.979630 skypilot-0.5.0/sky/utils/cli_utils/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)        0 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/utils/cli_utils/__init__.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    11032 2024-02-22 02:37:01.000000 skypilot-0.5.0/sky/utils/cli_utils/status_utils.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      695 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/utils/cluster_yaml_utils.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    18268 2024-02-21 18:57:08.000000 skypilot-0.5.0/sky/utils/command_runner.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     3432 2024-02-21 18:57:08.000000 skypilot-0.5.0/sky/utils/command_runner.pyi
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    21541 2024-02-21 08:42:09.000000 skypilot-0.5.0/sky/utils/common_utils.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    24757 2024-02-21 08:42:09.000000 skypilot-0.5.0/sky/utils/controller_utils.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     4574 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/utils/dag_utils.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     2786 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/utils/db_utils.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      852 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/utils/env_options.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.979630 skypilot-0.5.0/sky/utils/kubernetes/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)        0 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/utils/kubernetes/__init__.py
--rwxrwxr-x   0 azureuser  (1000) azureuser  (1000)     8632 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/utils/kubernetes/create_cluster.sh
--rwxrwxr-x   0 azureuser  (1000) azureuser  (1000)      927 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/utils/kubernetes/delete_cluster.sh
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     3012 2024-02-21 08:42:09.000000 skypilot-0.5.0/sky/utils/kubernetes/generate_kind_config.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     6961 2024-02-21 08:42:09.000000 skypilot-0.5.0/sky/utils/kubernetes/gpu_labeler.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     1186 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     3406 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     6560 2024-02-22 07:04:17.000000 skypilot-0.5.0/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     1173 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/utils/kubernetes_enums.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     7747 2024-02-06 04:50:09.000000 skypilot-0.5.0/sky/utils/log_utils.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     5540 2024-02-16 18:10:12.000000 skypilot-0.5.0/sky/utils/resources_utils.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     1581 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/utils/rich_utils.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    19219 2024-02-17 00:21:43.000000 skypilot-0.5.0/sky/utils/schemas.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     6400 2024-02-22 08:06:35.000000 skypilot-0.5.0/sky/utils/subprocess_utils.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     3936 2024-02-21 08:42:09.000000 skypilot-0.5.0/sky/utils/timeline.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     3264 2024-02-21 08:42:09.000000 skypilot-0.5.0/sky/utils/ux_utils.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      701 2024-02-03 00:23:03.000000 skypilot-0.5.0/sky/utils/validator.py
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.983630 skypilot-0.5.0/skypilot.egg-info/
--rw-r--r--   0 azureuser  (1000) azureuser  (1000)    17043 2024-02-27 03:51:32.000000 skypilot-0.5.0/skypilot.egg-info/PKG-INFO
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     9138 2024-02-27 03:51:32.000000 skypilot-0.5.0/skypilot.egg-info/SOURCES.txt
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)        1 2024-02-27 03:51:32.000000 skypilot-0.5.0/skypilot.egg-info/dependency_links.txt
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)       36 2024-02-27 03:51:32.000000 skypilot-0.5.0/skypilot.egg-info/entry_points.txt
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     2254 2024-02-27 03:51:32.000000 skypilot-0.5.0/skypilot.egg-info/requires.txt
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)        4 2024-02-27 03:51:32.000000 skypilot-0.5.0/skypilot.egg-info/top_level.txt
-drwxrwxr-x   0 azureuser  (1000) azureuser  (1000)        0 2024-02-27 03:51:32.983630 skypilot-0.5.0/tests/
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      171 2024-02-03 00:23:03.000000 skypilot-0.5.0/tests/test_api.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     4747 2024-02-06 04:50:09.000000 skypilot-0.5.0/tests/test_cli.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     9599 2024-02-21 08:42:09.000000 skypilot-0.5.0/tests/test_config.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)      260 2024-02-03 00:23:03.000000 skypilot-0.5.0/tests/test_global_user_state.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     8789 2024-02-16 18:10:12.000000 skypilot-0.5.0/tests/test_jobs.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     3717 2024-02-17 00:21:43.000000 skypilot-0.5.0/tests/test_list_accelerators.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)    27759 2024-02-22 02:37:01.000000 skypilot-0.5.0/tests/test_optimizer_dryruns.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     6898 2024-02-06 04:50:09.000000 skypilot-0.5.0/tests/test_optimizer_random_dag.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     1102 2024-02-06 04:50:09.000000 skypilot-0.5.0/tests/test_serve_autoscaler.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)   183491 2024-02-24 18:52:42.000000 skypilot-0.5.0/tests/test_smoke.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     7396 2024-02-03 00:23:03.000000 skypilot-0.5.0/tests/test_spot.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     4048 2024-02-03 00:23:03.000000 skypilot-0.5.0/tests/test_storage.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     1070 2024-02-03 00:23:03.000000 skypilot-0.5.0/tests/test_wheels.py
--rw-rw-r--   0 azureuser  (1000) azureuser  (1000)     3224 2024-02-21 08:42:09.000000 skypilot-0.5.0/tests/test_yaml_parser.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.551320 skypilot-0.6.0/
+-rw-r--r--   0 romilb     (501) staff       (20)    12170 2024-05-30 22:32:03.000000 skypilot-0.6.0/LICENSE
+-rw-r--r--   0 romilb     (501) staff       (20)      718 2024-05-30 22:32:03.000000 skypilot-0.6.0/MANIFEST.in
+-rw-r--r--   0 romilb     (501) staff       (20)    18122 2024-05-30 22:32:39.551019 skypilot-0.6.0/PKG-INFO
+-rw-r--r--   0 romilb     (501) staff       (20)    12079 2024-05-30 22:32:03.000000 skypilot-0.6.0/README.md
+-rw-r--r--   0 romilb     (501) staff       (20)      640 2024-05-30 22:32:03.000000 skypilot-0.6.0/pyproject.toml
+-rw-r--r--   0 romilb     (501) staff       (20)       38 2024-05-30 22:32:39.551365 skypilot-0.6.0/setup.cfg
+-rw-r--r--   0 romilb     (501) staff       (20)    12048 2024-05-30 22:32:03.000000 skypilot-0.6.0/setup.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.506329 skypilot-0.6.0/sky/
+-rw-r--r--   0 romilb     (501) staff       (20)     5576 2024-05-30 22:32:39.000000 skypilot-0.6.0/sky/__init__.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.507928 skypilot-0.6.0/sky/adaptors/
+-rw-r--r--   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/adaptors/__init__.py
+-rw-r--r--   0 romilb     (501) staff       (20)     6863 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/adaptors/aws.py
+-rw-r--r--   0 romilb     (501) staff       (20)     2291 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/adaptors/azure.py
+-rw-r--r--   0 romilb     (501) staff       (20)     7594 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/adaptors/cloudflare.py
+-rw-r--r--   0 romilb     (501) staff       (20)     2354 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/adaptors/common.py
+-rw-r--r--   0 romilb     (501) staff       (20)      239 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/adaptors/cudo.py
+-rw-r--r--   0 romilb     (501) staff       (20)      468 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/adaptors/docker.py
+-rw-r--r--   0 romilb     (501) staff       (20)     3097 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/adaptors/gcp.py
+-rw-r--r--   0 romilb     (501) staff       (20)     4906 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/adaptors/ibm.py
+-rw-r--r--   0 romilb     (501) staff       (20)     4109 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/adaptors/kubernetes.py
+-rw-r--r--   0 romilb     (501) staff       (20)     1480 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/adaptors/oci.py
+-rw-r--r--   0 romilb     (501) staff       (20)      225 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/adaptors/runpod.py
+-rw-r--r--   0 romilb     (501) staff       (20)     2129 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/adaptors/vsphere.py
+-rw-r--r--   0 romilb     (501) staff       (20)    21408 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/authentication.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.509152 skypilot-0.6.0/sky/backends/
+-rw-r--r--   0 romilb     (501) staff       (20)      536 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/backends/__init__.py
+-rw-r--r--   0 romilb     (501) staff       (20)     5932 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/backends/backend.py
+-rw-r--r--   0 romilb     (501) staff       (20)   125856 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/backends/backend_utils.py
+-rw-r--r--   0 romilb     (501) staff       (20)   231003 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/backends/cloud_vm_ray_backend.py
+-rw-r--r--   0 romilb     (501) staff       (20)     8358 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/backends/docker_utils.py
+-rw-r--r--   0 romilb     (501) staff       (20)    16741 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/backends/local_docker_backend.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.509322 skypilot-0.6.0/sky/backends/monkey_patches/
+-rw-r--r--   0 romilb     (501) staff       (20)     3450 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/backends/monkey_patches/monkey_patch_ray_up.py
+-rw-r--r--   0 romilb     (501) staff       (20)     7297 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/backends/wheel_utils.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.509773 skypilot-0.6.0/sky/benchmark/
+-rw-r--r--   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/benchmark/__init__.py
+-rw-r--r--   0 romilb     (501) staff       (20)     8723 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/benchmark/benchmark_state.py
+-rw-r--r--   0 romilb     (501) staff       (20)    26446 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/benchmark/benchmark_utils.py
+-rw-r--r--   0 romilb     (501) staff       (20)     9079 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/check.py
+-rw-r--r--   0 romilb     (501) staff       (20)   200458 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/cli.py
+-rw-r--r--   0 romilb     (501) staff       (20)    11806 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/cloud_stores.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.512459 skypilot-0.6.0/sky/clouds/
+-rw-r--r--   0 romilb     (501) staff       (20)     1310 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/__init__.py
+-rw-r--r--   0 romilb     (501) staff       (20)    44519 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/aws.py
+-rw-r--r--   0 romilb     (501) staff       (20)    30929 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/azure.py
+-rw-r--r--   0 romilb     (501) staff       (20)    31840 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/cloud.py
+-rw-r--r--   0 romilb     (501) staff       (20)      955 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/cloud_registry.py
+-rw-r--r--   0 romilb     (501) staff       (20)    12344 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/cudo.py
+-rw-r--r--   0 romilb     (501) staff       (20)    12477 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/fluidstack.py
+-rw-r--r--   0 romilb     (501) staff       (20)    47944 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/gcp.py
+-rw-r--r--   0 romilb     (501) staff       (20)    20969 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/ibm.py
+-rw-r--r--   0 romilb     (501) staff       (20)    20272 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/kubernetes.py
+-rw-r--r--   0 romilb     (501) staff       (20)    11991 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/lambda_cloud.py
+-rw-r--r--   0 romilb     (501) staff       (20)    25136 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/oci.py
+-rw-r--r--   0 romilb     (501) staff       (20)    10391 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/paperspace.py
+-rw-r--r--   0 romilb     (501) staff       (20)    11000 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/runpod.py
+-rw-r--r--   0 romilb     (501) staff       (20)    15383 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/scp.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.514866 skypilot-0.6.0/sky/clouds/service_catalog/
+-rw-r--r--   0 romilb     (501) staff       (20)    14546 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/service_catalog/__init__.py
+-rw-r--r--   0 romilb     (501) staff       (20)    12550 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/service_catalog/aws_catalog.py
+-rw-r--r--   0 romilb     (501) staff       (20)     7289 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/service_catalog/azure_catalog.py
+-rw-r--r--   0 romilb     (501) staff       (20)    26837 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/service_catalog/common.py
+-rw-r--r--   0 romilb     (501) staff       (20)     1793 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/service_catalog/config.py
+-rw-r--r--   0 romilb     (501) staff       (20)      411 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/service_catalog/constants.py
+-rw-r--r--   0 romilb     (501) staff       (20)     4335 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/service_catalog/cudo_catalog.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.516071 skypilot-0.6.0/sky/clouds/service_catalog/data_fetchers/
+-rw-r--r--   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/service_catalog/data_fetchers/__init__.py
+-rw-r--r--   0 romilb     (501) staff       (20)    22424 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/service_catalog/data_fetchers/fetch_aws.py
+-rw-r--r--   0 romilb     (501) staff       (20)    11477 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/service_catalog/data_fetchers/fetch_azure.py
+-rw-r--r--   0 romilb     (501) staff       (20)     5072 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py
+-rw-r--r--   0 romilb     (501) staff       (20)     3895 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py
+-rw-r--r--   0 romilb     (501) staff       (20)    22243 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py
+-rw-r--r--   0 romilb     (501) staff       (20)     4297 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py
+-rw-r--r--   0 romilb     (501) staff       (20)    21462 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py
+-rw-r--r--   0 romilb     (501) staff       (20)     5038 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/service_catalog/fluidstack_catalog.py
+-rw-r--r--   0 romilb     (501) staff       (20)    24120 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/service_catalog/gcp_catalog.py
+-rw-r--r--   0 romilb     (501) staff       (20)     4472 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/service_catalog/ibm_catalog.py
+-rw-r--r--   0 romilb     (501) staff       (20)     7856 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/service_catalog/kubernetes_catalog.py
+-rw-r--r--   0 romilb     (501) staff       (20)     5082 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/service_catalog/lambda_catalog.py
+-rw-r--r--   0 romilb     (501) staff       (20)     7542 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/service_catalog/oci_catalog.py
+-rw-r--r--   0 romilb     (501) staff       (20)     3768 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/service_catalog/paperspace_catalog.py
+-rw-r--r--   0 romilb     (501) staff       (20)     4184 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/service_catalog/runpod_catalog.py
+-rw-r--r--   0 romilb     (501) staff       (20)     5174 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/service_catalog/scp_catalog.py
+-rw-r--r--   0 romilb     (501) staff       (20)     4391 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/service_catalog/vsphere_catalog.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.516845 skypilot-0.6.0/sky/clouds/utils/
+-rw-r--r--   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/utils/__init__.py
+-rw-r--r--   0 romilb     (501) staff       (20)     6968 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/utils/gcp_utils.py
+-rw-r--r--   0 romilb     (501) staff       (20)     9991 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/utils/lambda_utils.py
+-rw-r--r--   0 romilb     (501) staff       (20)     4482 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/utils/oci_utils.py
+-rw-r--r--   0 romilb     (501) staff       (20)    15781 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/utils/scp_utils.py
+-rw-r--r--   0 romilb     (501) staff       (20)    11802 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/clouds/vsphere.py
+-rw-r--r--   0 romilb     (501) staff       (20)    34233 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/core.py
+-rw-r--r--   0 romilb     (501) staff       (20)     2529 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/dag.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.517809 skypilot-0.6.0/sky/data/
+-rw-r--r--   0 romilb     (501) staff       (20)      184 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/data/__init__.py
+-rw-r--r--   0 romilb     (501) staff       (20)     7346 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/data/data_transfer.py
+-rw-r--r--   0 romilb     (501) staff       (20)    21664 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/data/data_utils.py
+-rw-r--r--   0 romilb     (501) staff       (20)     8351 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/data/mounting_utils.py
+-rw-r--r--   0 romilb     (501) staff       (20)   118872 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/data/storage.py
+-rw-r--r--   0 romilb     (501) staff       (20)     6867 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/data/storage_utils.py
+-rw-r--r--   0 romilb     (501) staff       (20)     8249 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/exceptions.py
+-rw-r--r--   0 romilb     (501) staff       (20)    25107 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/execution.py
+-rw-r--r--   0 romilb     (501) staff       (20)    28681 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/global_user_state.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.518716 skypilot-0.6.0/sky/jobs/
+-rw-r--r--   0 romilb     (501) staff       (20)     1398 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/jobs/__init__.py
+-rw-r--r--   0 romilb     (501) staff       (20)     1350 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/jobs/constants.py
+-rw-r--r--   0 romilb     (501) staff       (20)    26607 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/jobs/controller.py
+-rw-r--r--   0 romilb     (501) staff       (20)    13426 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/jobs/core.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.518843 skypilot-0.6.0/sky/jobs/dashboard/
+-rw-r--r--   0 romilb     (501) staff       (20)     3050 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/jobs/dashboard/dashboard.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.518971 skypilot-0.6.0/sky/jobs/dashboard/static/
+-rw-r--r--   0 romilb     (501) staff       (20)    15086 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/jobs/dashboard/static/favicon.ico
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.519106 skypilot-0.6.0/sky/jobs/dashboard/templates/
+-rw-r--r--   0 romilb     (501) staff       (20)     9837 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/jobs/dashboard/templates/index.html
+-rw-r--r--   0 romilb     (501) staff       (20)    25556 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/jobs/recovery_strategy.py
+-rw-r--r--   0 romilb     (501) staff       (20)    23041 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/jobs/state.py
+-rw-r--r--   0 romilb     (501) staff       (20)    35652 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/jobs/utils.py
+-rw-r--r--   0 romilb     (501) staff       (20)    56668 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/optimizer.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.520169 skypilot-0.6.0/sky/provision/
+-rw-r--r--   0 romilb     (501) staff       (20)     5951 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/__init__.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.520720 skypilot-0.6.0/sky/provision/aws/
+-rw-r--r--   0 romilb     (501) staff       (20)      731 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/aws/__init__.py
+-rw-r--r--   0 romilb     (501) staff       (20)    22092 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/aws/config.py
+-rw-r--r--   0 romilb     (501) staff       (20)    36307 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/aws/instance.py
+-rw-r--r--   0 romilb     (501) staff       (20)     3238 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/aws/utils.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.520982 skypilot-0.6.0/sky/provision/azure/
+-rw-r--r--   0 romilb     (501) staff       (20)      146 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/azure/__init__.py
+-rw-r--r--   0 romilb     (501) staff       (20)     4028 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/azure/instance.py
+-rw-r--r--   0 romilb     (501) staff       (20)     9339 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/common.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.521595 skypilot-0.6.0/sky/provision/cudo/
+-rw-r--r--   0 romilb     (501) staff       (20)      676 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/cudo/__init__.py
+-rw-r--r--   0 romilb     (501) staff       (20)      327 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/cudo/config.py
+-rw-r--r--   0 romilb     (501) staff       (20)      696 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/cudo/cudo_machine_type.py
+-rw-r--r--   0 romilb     (501) staff       (20)     4086 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/cudo/cudo_wrapper.py
+-rw-r--r--   0 romilb     (501) staff       (20)     8307 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/cudo/instance.py
+-rw-r--r--   0 romilb     (501) staff       (20)    17540 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/docker_utils.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.522252 skypilot-0.6.0/sky/provision/fluidstack/
+-rw-r--r--   0 romilb     (501) staff       (20)      592 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/fluidstack/__init__.py
+-rw-r--r--   0 romilb     (501) staff       (20)      326 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/fluidstack/config.py
+-rw-r--r--   0 romilb     (501) staff       (20)     8262 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/fluidstack/fluidstack_utils.py
+-rw-r--r--   0 romilb     (501) staff       (20)    14974 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/fluidstack/instance.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.522936 skypilot-0.6.0/sky/provision/gcp/
+-rw-r--r--   0 romilb     (501) staff       (20)      528 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/gcp/__init__.py
+-rw-r--r--   0 romilb     (501) staff       (20)    32964 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/gcp/config.py
+-rw-r--r--   0 romilb     (501) staff       (20)     7234 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/gcp/constants.py
+-rw-r--r--   0 romilb     (501) staff       (20)    24215 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/gcp/instance.py
+-rw-r--r--   0 romilb     (501) staff       (20)    59069 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/gcp/instance_utils.py
+-rw-r--r--   0 romilb     (501) staff       (20)    22367 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/instance_setup.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.523897 skypilot-0.6.0/sky/provision/kubernetes/
+-rw-r--r--   0 romilb     (501) staff       (20)      653 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/kubernetes/__init__.py
+-rw-r--r--   0 romilb     (501) staff       (20)    28319 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/kubernetes/config.py
+-rw-r--r--   0 romilb     (501) staff       (20)    32724 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/kubernetes/instance.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.524167 skypilot-0.6.0/sky/provision/kubernetes/manifests/
+-rw-r--r--   0 romilb     (501) staff       (20)      229 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/kubernetes/manifests/smarter-device-manager-configmap.yaml
+-rw-r--r--   0 romilb     (501) staff       (20)     1939 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/kubernetes/manifests/smarter-device-manager-daemonset.yaml
+-rw-r--r--   0 romilb     (501) staff       (20)    10851 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/kubernetes/network.py
+-rw-r--r--   0 romilb     (501) staff       (20)     9384 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/kubernetes/network_utils.py
+-rw-r--r--   0 romilb     (501) staff       (20)    62585 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/kubernetes/utils.py
+-rw-r--r--   0 romilb     (501) staff       (20)     2103 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/logging.py
+-rw-r--r--   0 romilb     (501) staff       (20)     4013 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/metadata_utils.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.524817 skypilot-0.6.0/sky/provision/paperspace/
+-rw-r--r--   0 romilb     (501) staff       (20)      598 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/paperspace/__init__.py
+-rw-r--r--   0 romilb     (501) staff       (20)     1541 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/paperspace/config.py
+-rw-r--r--   0 romilb     (501) staff       (20)      802 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/paperspace/constants.py
+-rw-r--r--   0 romilb     (501) staff       (20)    12045 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/paperspace/instance.py
+-rw-r--r--   0 romilb     (501) staff       (20)     9428 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/paperspace/utils.py
+-rw-r--r--   0 romilb     (501) staff       (20)    25103 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/provisioner.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.525437 skypilot-0.6.0/sky/provision/runpod/
+-rw-r--r--   0 romilb     (501) staff       (20)      502 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/runpod/__init__.py
+-rw-r--r--   0 romilb     (501) staff       (20)      321 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/runpod/config.py
+-rw-r--r--   0 romilb     (501) staff       (20)     7905 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/runpod/instance.py
+-rw-r--r--   0 romilb     (501) staff       (20)     4648 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/runpod/utils.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.525985 skypilot-0.6.0/sky/provision/vsphere/
+-rw-r--r--   0 romilb     (501) staff       (20)      788 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/vsphere/__init__.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.527318 skypilot-0.6.0/sky/provision/vsphere/common/
+-rw-r--r--   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/vsphere/common/__init__.py
+-rw-r--r--   0 romilb     (501) staff       (20)     4167 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/vsphere/common/cls_api_client.py
+-rw-r--r--   0 romilb     (501) staff       (20)    14096 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/vsphere/common/cls_api_helper.py
+-rw-r--r--   0 romilb     (501) staff       (20)      481 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/vsphere/common/custom_script.py
+-rw-r--r--   0 romilb     (501) staff       (20)      303 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/vsphere/common/id_generator.py
+-rw-r--r--   0 romilb     (501) staff       (20)      914 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/vsphere/common/metadata_utils.py
+-rw-r--r--   0 romilb     (501) staff       (20)     1817 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/vsphere/common/service_manager.py
+-rw-r--r--   0 romilb     (501) staff       (20)      544 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/vsphere/common/service_manager_factory.py
+-rw-r--r--   0 romilb     (501) staff       (20)      795 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/vsphere/common/ssl_helper.py
+-rw-r--r--   0 romilb     (501) staff       (20)     2932 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/vsphere/common/vapiconnect.py
+-rw-r--r--   0 romilb     (501) staff       (20)    17877 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/vsphere/common/vim_utils.py
+-rw-r--r--   0 romilb     (501) staff       (20)      504 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/vsphere/config.py
+-rw-r--r--   0 romilb     (501) staff       (20)    24488 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/vsphere/instance.py
+-rw-r--r--   0 romilb     (501) staff       (20)    15151 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/provision/vsphere/vsphere_utils.py
+-rw-r--r--   0 romilb     (501) staff       (20)    65346 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/resources.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.529170 skypilot-0.6.0/sky/serve/
+-rw-r--r--   0 romilb     (501) staff       (20)     1661 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/serve/__init__.py
+-rw-r--r--   0 romilb     (501) staff       (20)    30136 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/serve/autoscalers.py
+-rw-r--r--   0 romilb     (501) staff       (20)     4415 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/serve/constants.py
+-rw-r--r--   0 romilb     (501) staff       (20)     8022 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/serve/controller.py
+-rw-r--r--   0 romilb     (501) staff       (20)    28710 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/serve/core.py
+-rw-r--r--   0 romilb     (501) staff       (20)    11548 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/serve/load_balancer.py
+-rw-r--r--   0 romilb     (501) staff       (20)     2331 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/serve/load_balancing_policies.py
+-rw-r--r--   0 romilb     (501) staff       (20)    57216 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/serve/replica_managers.py
+-rw-r--r--   0 romilb     (501) staff       (20)    18830 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/serve/serve_state.py
+-rw-r--r--   0 romilb     (501) staff       (20)    37183 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/serve/serve_utils.py
+-rw-r--r--   0 romilb     (501) staff       (20)    10931 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/serve/service.py
+-rw-r--r--   0 romilb     (501) staff       (20)    14469 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/serve/service_spec.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.529632 skypilot-0.6.0/sky/setup_files/
+-rw-r--r--   0 romilb     (501) staff       (20)      718 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/setup_files/MANIFEST.in
+-rw-r--r--   0 romilb     (501) staff       (20)    12048 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/setup_files/setup.py
+-rw-r--r--   0 romilb     (501) staff       (20)     4000 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/sky_logging.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.531650 skypilot-0.6.0/sky/skylet/
+-rw-r--r--   0 romilb     (501) staff       (20)    12381 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/LICENSE
+-rw-r--r--   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/__init__.py
+-rw-r--r--   0 romilb     (501) staff       (20)     2136 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/attempt_skylet.py
+-rw-r--r--   0 romilb     (501) staff       (20)     4478 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/autostop_lib.py
+-rw-r--r--   0 romilb     (501) staff       (20)     1887 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/configs.py
+-rw-r--r--   0 romilb     (501) staff       (20)    11411 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/constants.py
+-rw-r--r--   0 romilb     (501) staff       (20)    12303 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/events.py
+-rw-r--r--   0 romilb     (501) staff       (20)    35198 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/job_lib.py
+-rw-r--r--   0 romilb     (501) staff       (20)    18824 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/log_lib.py
+-rw-r--r--   0 romilb     (501) staff       (20)     4295 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/log_lib.pyi
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.531874 skypilot-0.6.0/sky/skylet/providers/
+-rw-r--r--   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/providers/__init__.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.532614 skypilot-0.6.0/sky/skylet/providers/azure/
+-rw-r--r--   0 romilb     (501) staff       (20)       97 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/providers/azure/__init__.py
+-rw-r--r--   0 romilb     (501) staff       (20)     4344 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/providers/azure/azure-config-template.json
+-rw-r--r--   0 romilb     (501) staff       (20)    10901 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/providers/azure/azure-vm-template.json
+-rw-r--r--   0 romilb     (501) staff       (20)     6342 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/providers/azure/config.py
+-rw-r--r--   0 romilb     (501) staff       (20)    19215 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/providers/azure/node_provider.py
+-rw-r--r--   0 romilb     (501) staff       (20)    16355 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/providers/command_runner.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.533122 skypilot-0.6.0/sky/skylet/providers/ibm/
+-rw-r--r--   0 romilb     (501) staff       (20)       94 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/providers/ibm/__init__.py
+-rw-r--r--   0 romilb     (501) staff       (20)    38280 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/providers/ibm/node_provider.py
+-rw-r--r--   0 romilb     (501) staff       (20)     1292 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/providers/ibm/utils.py
+-rw-r--r--   0 romilb     (501) staff       (20)    34630 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/providers/ibm/vpc_provider.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.533393 skypilot-0.6.0/sky/skylet/providers/lambda_cloud/
+-rw-r--r--   0 romilb     (501) staff       (20)      112 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/providers/lambda_cloud/__init__.py
+-rw-r--r--   0 romilb     (501) staff       (20)    13971 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/providers/lambda_cloud/node_provider.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.533919 skypilot-0.6.0/sky/skylet/providers/oci/
+-rw-r--r--   0 romilb     (501) staff       (20)       91 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/providers/oci/__init__.py
+-rw-r--r--   0 romilb     (501) staff       (20)    20492 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/providers/oci/node_provider.py
+-rw-r--r--   0 romilb     (501) staff       (20)    17202 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/providers/oci/query_helper.py
+-rw-r--r--   0 romilb     (501) staff       (20)      508 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/providers/oci/utils.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.534321 skypilot-0.6.0/sky/skylet/providers/scp/
+-rw-r--r--   0 romilb     (501) staff       (20)       91 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/providers/scp/__init__.py
+-rw-r--r--   0 romilb     (501) staff       (20)     4683 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/providers/scp/config.py
+-rw-r--r--   0 romilb     (501) staff       (20)    22411 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/providers/scp/node_provider.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.535261 skypilot-0.6.0/sky/skylet/ray_patches/
+-rw-r--r--   0 romilb     (501) staff       (20)     2761 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/ray_patches/__init__.py
+-rw-r--r--   0 romilb     (501) staff       (20)      291 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/ray_patches/autoscaler.py.patch
+-rw-r--r--   0 romilb     (501) staff       (20)      349 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/ray_patches/cli.py.patch
+-rw-r--r--   0 romilb     (501) staff       (20)      224 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/ray_patches/command_runner.py.patch
+-rw-r--r--   0 romilb     (501) staff       (20)      531 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/ray_patches/log_monitor.py.patch
+-rw-r--r--   0 romilb     (501) staff       (20)      658 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/ray_patches/resource_demand_scheduler.py.patch
+-rw-r--r--   0 romilb     (501) staff       (20)      289 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/ray_patches/updater.py.patch
+-rw-r--r--   0 romilb     (501) staff       (20)      565 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/ray_patches/worker.py.patch
+-rw-r--r--   0 romilb     (501) staff       (20)     1153 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/skylet.py
+-rw-r--r--   0 romilb     (501) staff       (20)     1348 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skylet/subprocess_daemon.py
+-rw-r--r--   0 romilb     (501) staff       (20)     5734 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/skypilot_config.py
+-rw-r--r--   0 romilb     (501) staff       (20)     1457 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/status_lib.py
+-rw-r--r--   0 romilb     (501) staff       (20)    47807 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/task.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.537809 skypilot-0.6.0/sky/templates/
+-rw-r--r--   0 romilb     (501) staff       (20)     7477 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/templates/aws-ray.yml.j2
+-rw-r--r--   0 romilb     (501) staff       (20)     9099 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/templates/azure-ray.yml.j2
+-rw-r--r--   0 romilb     (501) staff       (20)     3435 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/templates/cudo-ray.yml.j2
+-rw-r--r--   0 romilb     (501) staff       (20)     3465 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/templates/fluidstack-ray.yml.j2
+-rw-r--r--   0 romilb     (501) staff       (20)     8880 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/templates/gcp-ray.yml.j2
+-rw-r--r--   0 romilb     (501) staff       (20)     6669 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/templates/ibm-ray.yml.j2
+-rw-r--r--   0 romilb     (501) staff       (20)     1554 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/templates/jobs-controller.yaml.j2
+-rw-r--r--   0 romilb     (501) staff       (20)     1095 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/templates/kubernetes-ingress.yml.j2
+-rw-r--r--   0 romilb     (501) staff       (20)      376 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/templates/kubernetes-loadbalancer.yml.j2
+-rw-r--r--   0 romilb     (501) staff       (20)     2547 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/templates/kubernetes-port-forward-proxy-command.sh.j2
+-rw-r--r--   0 romilb     (501) staff       (20)    15489 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/templates/kubernetes-ray.yml.j2
+-rw-r--r--   0 romilb     (501) staff       (20)     2747 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/templates/kubernetes-ssh-jump.yml.j2
+-rw-r--r--   0 romilb     (501) staff       (20)     5738 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/templates/lambda-ray.yml.j2
+-rw-r--r--   0 romilb     (501) staff       (20)     1185 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/templates/local-ray.yml.j2
+-rw-r--r--   0 romilb     (501) staff       (20)     7032 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/templates/oci-ray.yml.j2
+-rw-r--r--   0 romilb     (501) staff       (20)     3898 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/templates/paperspace-ray.yml.j2
+-rw-r--r--   0 romilb     (501) staff       (20)     3496 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/templates/runpod-ray.yml.j2
+-rw-r--r--   0 romilb     (501) staff       (20)     5608 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/templates/scp-ray.yml.j2
+-rw-r--r--   0 romilb     (501) staff       (20)     1575 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/templates/sky-serve-controller.yaml.j2
+-rw-r--r--   0 romilb     (501) staff       (20)     3474 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/templates/vsphere-ray.yml.j2
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.538124 skypilot-0.6.0/sky/usage/
+-rw-r--r--   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/usage/__init__.py
+-rw-r--r--   0 romilb     (501) staff       (20)      590 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/usage/constants.py
+-rw-r--r--   0 romilb     (501) staff       (20)    17807 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/usage/usage_lib.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.540387 skypilot-0.6.0/sky/utils/
+-rw-r--r--   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/utils/__init__.py
+-rw-r--r--   0 romilb     (501) staff       (20)     3798 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/utils/accelerator_registry.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.540595 skypilot-0.6.0/sky/utils/cli_utils/
+-rw-r--r--   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/utils/cli_utils/__init__.py
+-rw-r--r--   0 romilb     (501) staff       (20)    11032 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/utils/cli_utils/status_utils.py
+-rw-r--r--   0 romilb     (501) staff       (20)      849 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/utils/cluster_yaml_utils.py
+-rw-r--r--   0 romilb     (501) staff       (20)    23317 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/utils/command_runner.py
+-rw-r--r--   0 romilb     (501) staff       (20)     5492 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/utils/command_runner.pyi
+-rw-r--r--   0 romilb     (501) staff       (20)    23848 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/utils/common_utils.py
+-rw-r--r--   0 romilb     (501) staff       (20)    34620 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/utils/controller_utils.py
+-rw-r--r--   0 romilb     (501) staff       (20)     5731 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/utils/dag_utils.py
+-rw-r--r--   0 romilb     (501) staff       (20)     2786 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/utils/db_utils.py
+-rw-r--r--   0 romilb     (501) staff       (20)      861 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/utils/env_options.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.541948 skypilot-0.6.0/sky/utils/kubernetes/
+-rw-r--r--   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/utils/kubernetes/__init__.py
+-rwxr-xr-x   0 romilb     (501) staff       (20)     9759 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/utils/kubernetes/create_cluster.sh
+-rwxr-xr-x   0 romilb     (501) staff       (20)      927 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/utils/kubernetes/delete_cluster.sh
+-rw-r--r--   0 romilb     (501) staff       (20)     3187 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/utils/kubernetes/generate_kind_config.py
+-rwxr-xr-x   0 romilb     (501) staff       (20)     4422 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/utils/kubernetes/generate_static_kubeconfig.sh
+-rw-r--r--   0 romilb     (501) staff       (20)     6960 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/utils/kubernetes/gpu_labeler.py
+-rw-r--r--   0 romilb     (501) staff       (20)     1186 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml
+-rw-r--r--   0 romilb     (501) staff       (20)     3812 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml
+-rw-r--r--   0 romilb     (501) staff       (20)     6560 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py
+-rw-r--r--   0 romilb     (501) staff       (20)     1384 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/utils/kubernetes_enums.py
+-rw-r--r--   0 romilb     (501) staff       (20)     8139 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/utils/log_utils.py
+-rw-r--r--   0 romilb     (501) staff       (20)     5540 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/utils/resources_utils.py
+-rw-r--r--   0 romilb     (501) staff       (20)     1581 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/utils/rich_utils.py
+-rw-r--r--   0 romilb     (501) staff       (20)    23359 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/utils/schemas.py
+-rw-r--r--   0 romilb     (501) staff       (20)     6509 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/utils/subprocess_utils.py
+-rw-r--r--   0 romilb     (501) staff       (20)     3936 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/utils/timeline.py
+-rw-r--r--   0 romilb     (501) staff       (20)     3264 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/utils/ux_utils.py
+-rw-r--r--   0 romilb     (501) staff       (20)      701 2024-05-30 22:32:03.000000 skypilot-0.6.0/sky/utils/validator.py
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.545411 skypilot-0.6.0/skypilot.egg-info/
+-rw-r--r--   0 romilb     (501) staff       (20)    18122 2024-05-30 22:32:39.000000 skypilot-0.6.0/skypilot.egg-info/PKG-INFO
+-rw-r--r--   0 romilb     (501) staff       (20)     9305 2024-05-30 22:32:39.000000 skypilot-0.6.0/skypilot.egg-info/SOURCES.txt
+-rw-r--r--   0 romilb     (501) staff       (20)        1 2024-05-30 22:32:39.000000 skypilot-0.6.0/skypilot.egg-info/dependency_links.txt
+-rw-r--r--   0 romilb     (501) staff       (20)       36 2024-05-30 22:32:39.000000 skypilot-0.6.0/skypilot.egg-info/entry_points.txt
+-rw-r--r--   0 romilb     (501) staff       (20)     2272 2024-05-30 22:32:39.000000 skypilot-0.6.0/skypilot.egg-info/requires.txt
+-rw-r--r--   0 romilb     (501) staff       (20)        4 2024-05-30 22:32:39.000000 skypilot-0.6.0/skypilot.egg-info/top_level.txt
+drwxr-xr-x   0 romilb     (501) staff       (20)        0 2024-05-30 22:32:39.545235 skypilot-0.6.0/tests/
+-rw-r--r--   0 romilb     (501) staff       (20)      171 2024-05-30 22:32:03.000000 skypilot-0.6.0/tests/test_api.py
+-rw-r--r--   0 romilb     (501) staff       (20)     3579 2024-05-30 22:32:03.000000 skypilot-0.6.0/tests/test_cli.py
+-rw-r--r--   0 romilb     (501) staff       (20)     9592 2024-05-30 22:32:03.000000 skypilot-0.6.0/tests/test_config.py
+-rw-r--r--   0 romilb     (501) staff       (20)      267 2024-05-30 22:32:03.000000 skypilot-0.6.0/tests/test_global_user_state.py
+-rw-r--r--   0 romilb     (501) staff       (20)     8789 2024-05-30 22:32:03.000000 skypilot-0.6.0/tests/test_jobs.py
+-rw-r--r--   0 romilb     (501) staff       (20)    17649 2024-05-30 22:32:03.000000 skypilot-0.6.0/tests/test_jobs_and_serve.py
+-rw-r--r--   0 romilb     (501) staff       (20)     3718 2024-05-30 22:32:03.000000 skypilot-0.6.0/tests/test_list_accelerators.py
+-rw-r--r--   0 romilb     (501) staff       (20)    27759 2024-05-30 22:32:03.000000 skypilot-0.6.0/tests/test_optimizer_dryruns.py
+-rw-r--r--   0 romilb     (501) staff       (20)     6996 2024-05-30 22:32:03.000000 skypilot-0.6.0/tests/test_optimizer_random_dag.py
+-rw-r--r--   0 romilb     (501) staff       (20)     1102 2024-05-30 22:32:03.000000 skypilot-0.6.0/tests/test_serve_autoscaler.py
+-rw-r--r--   0 romilb     (501) staff       (20)   220340 2024-05-30 22:32:03.000000 skypilot-0.6.0/tests/test_smoke.py
+-rw-r--r--   0 romilb     (501) staff       (20)     4048 2024-05-30 22:32:03.000000 skypilot-0.6.0/tests/test_storage.py
+-rw-r--r--   0 romilb     (501) staff       (20)     1070 2024-05-30 22:32:03.000000 skypilot-0.6.0/tests/test_wheels.py
+-rw-r--r--   0 romilb     (501) staff       (20)     4279 2024-05-30 22:32:03.000000 skypilot-0.6.0/tests/test_yaml_parser.py
```

### Comparing `skypilot-0.5.0/LICENSE` & `skypilot-0.6.0/LICENSE`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/MANIFEST.in` & `skypilot-0.6.0/MANIFEST.in`

 * *Files 13% similar despite different names*

```diff
@@ -1,19 +1,20 @@
 include sky/backends/monkey_patches/*.py
 exclude sky/clouds/service_catalog/data_fetchers/analyze.py
+include sky/provision/kubernetes/manifests/*
 include sky/setup_files/*
 include sky/skylet/*.sh
 include sky/skylet/LICENSE
 include sky/skylet/providers/azure/*
 include sky/skylet/providers/gcp/*
 include sky/skylet/providers/ibm/*
 include sky/skylet/providers/kubernetes/*
 include sky/skylet/providers/lambda_cloud/*
 include sky/skylet/providers/oci/*
 include sky/skylet/providers/scp/*
 include sky/skylet/providers/*.py
 include sky/skylet/ray_patches/*.patch
-include sky/spot/dashboard/*
-include sky/spot/dashboard/templates/*
-include sky/spot/dashboard/static/*
+include sky/jobs/dashboard/*
+include sky/jobs/dashboard/templates/*
+include sky/jobs/dashboard/static/*
 include sky/templates/*
 include sky/utils/kubernetes/*
```

### Comparing `skypilot-0.5.0/PKG-INFO` & `skypilot-0.6.0/PKG-INFO`

 * *Files 4% similar despite different names*

```diff
@@ -1,21 +1,22 @@
 Metadata-Version: 2.1
 Name: skypilot
-Version: 0.5.0
+Version: 0.6.0
 Summary: SkyPilot: An intercloud broker for the clouds
 Author: SkyPilot Team
 License: Apache 2.0
 Project-URL: Homepage, https://github.com/skypilot-org/skypilot
 Project-URL: Issues, https://github.com/skypilot-org/skypilot/issues
 Project-URL: Discussion, https://github.com/skypilot-org/skypilot/discussions
 Project-URL: Documentation, https://skypilot.readthedocs.io/en/latest/
 Classifier: Programming Language :: Python :: 3.7
 Classifier: Programming Language :: Python :: 3.8
 Classifier: Programming Language :: Python :: 3.9
 Classifier: Programming Language :: Python :: 3.10
+Classifier: Programming Language :: Python :: 3.11
 Classifier: License :: OSI Approved :: Apache Software License
 Classifier: Operating System :: OS Independent
 Classifier: Topic :: Software Development :: Libraries :: Python Modules
 Classifier: Topic :: System :: Distributed Computing
 Description-Content-Type: text/markdown
 License-File: LICENSE
 Requires-Dist: wheel
@@ -46,94 +47,95 @@
 Requires-Dist: boto3>=1.26.1; extra == "aws"
 Requires-Dist: colorama<0.4.5; extra == "aws"
 Provides-Extra: azure
 Requires-Dist: azure-cli>=2.31.0; extra == "azure"
 Requires-Dist: azure-core; extra == "azure"
 Requires-Dist: azure-identity>=1.13.0; extra == "azure"
 Requires-Dist: azure-mgmt-network; extra == "azure"
-Requires-Dist: ray[default]!=2.6.0,<=2.6.3,>=2.2.0; extra == "azure"
+Requires-Dist: ray[default]!=2.6.0,>=2.2.0; extra == "azure"
 Provides-Extra: gcp
 Requires-Dist: google-api-python-client>=2.69.0; extra == "gcp"
 Requires-Dist: google-cloud-storage; extra == "gcp"
 Provides-Extra: ibm
 Requires-Dist: ibm-cloud-sdk-core; extra == "ibm"
 Requires-Dist: ibm-vpc; extra == "ibm"
 Requires-Dist: ibm-platform-services; extra == "ibm"
 Requires-Dist: ibm-cos-sdk; extra == "ibm"
-Requires-Dist: ray[default]!=2.6.0,<=2.6.3,>=2.2.0; extra == "ibm"
+Requires-Dist: ray[default]!=2.6.0,>=2.2.0; extra == "ibm"
 Provides-Extra: docker
 Requires-Dist: docker; extra == "docker"
-Requires-Dist: ray[default]!=2.6.0,<=2.6.3,>=2.2.0; extra == "docker"
+Requires-Dist: ray[default]!=2.6.0,>=2.2.0; extra == "docker"
 Provides-Extra: lambda
-Requires-Dist: ray[default]!=2.6.0,<=2.6.3,>=2.2.0; extra == "lambda"
+Requires-Dist: ray[default]!=2.6.0,>=2.2.0; extra == "lambda"
 Provides-Extra: cloudflare
 Requires-Dist: urllib3<2; extra == "cloudflare"
 Requires-Dist: awscli>=1.27.10; extra == "cloudflare"
 Requires-Dist: botocore>=1.29.10; extra == "cloudflare"
 Requires-Dist: boto3>=1.26.1; extra == "cloudflare"
 Requires-Dist: colorama<0.4.5; extra == "cloudflare"
 Provides-Extra: scp
-Requires-Dist: ray[default]!=2.6.0,<=2.6.3,>=2.2.0; extra == "scp"
+Requires-Dist: ray[default]!=2.6.0,>=2.2.0; extra == "scp"
 Provides-Extra: oci
 Requires-Dist: oci; extra == "oci"
-Requires-Dist: ray[default]!=2.6.0,<=2.6.3,>=2.2.0; extra == "oci"
+Requires-Dist: ray[default]!=2.6.0,>=2.2.0; extra == "oci"
 Provides-Extra: kubernetes
 Requires-Dist: kubernetes>=20.0.0; extra == "kubernetes"
 Provides-Extra: remote
 Requires-Dist: grpcio!=1.48.0,<=1.49.1,>=1.32.0; (python_version < "3.10" and sys_platform == "darwin") and extra == "remote"
 Requires-Dist: grpcio!=1.48.0,<=1.49.1,>=1.42.0; (python_version >= "3.10" and sys_platform == "darwin") and extra == "remote"
 Requires-Dist: grpcio!=1.48.0,<=1.51.3,>=1.32.0; (python_version < "3.10" and sys_platform != "darwin") and extra == "remote"
 Requires-Dist: grpcio!=1.48.0,<=1.51.3,>=1.42.0; (python_version >= "3.10" and sys_platform != "darwin") and extra == "remote"
 Requires-Dist: protobuf!=3.19.5,>=3.15.3; extra == "remote"
-Requires-Dist: pydantic<2.0,>=1.10.8; extra == "remote"
+Requires-Dist: pydantic!=2.0.*,!=2.1.*,!=2.2.*,!=2.3.*,!=2.4.*,<3; extra == "remote"
 Provides-Extra: runpod
 Requires-Dist: runpod>=1.5.1; extra == "runpod"
 Provides-Extra: fluidstack
 Provides-Extra: cudo
-Requires-Dist: cudo-compute>=0.1.8; extra == "cudo"
+Requires-Dist: cudo-compute>=0.1.10; extra == "cudo"
+Provides-Extra: paperspace
 Provides-Extra: vsphere
 Requires-Dist: pyvmomi==8.0.1.0.2; extra == "vsphere"
 Provides-Extra: all
 Requires-Dist: urllib3<2; extra == "all"
 Requires-Dist: awscli>=1.27.10; extra == "all"
 Requires-Dist: botocore>=1.29.10; extra == "all"
 Requires-Dist: boto3>=1.26.1; extra == "all"
 Requires-Dist: colorama<0.4.5; extra == "all"
 Requires-Dist: azure-cli>=2.31.0; extra == "all"
 Requires-Dist: azure-core; extra == "all"
 Requires-Dist: azure-identity>=1.13.0; extra == "all"
 Requires-Dist: azure-mgmt-network; extra == "all"
-Requires-Dist: ray[default]!=2.6.0,<=2.6.3,>=2.2.0; extra == "all"
+Requires-Dist: ray[default]!=2.6.0,>=2.2.0; extra == "all"
 Requires-Dist: google-api-python-client>=2.69.0; extra == "all"
 Requires-Dist: google-cloud-storage; extra == "all"
 Requires-Dist: ibm-cloud-sdk-core; extra == "all"
 Requires-Dist: ibm-vpc; extra == "all"
 Requires-Dist: ibm-platform-services; extra == "all"
 Requires-Dist: ibm-cos-sdk; extra == "all"
-Requires-Dist: ray[default]!=2.6.0,<=2.6.3,>=2.2.0; extra == "all"
+Requires-Dist: ray[default]!=2.6.0,>=2.2.0; extra == "all"
 Requires-Dist: docker; extra == "all"
-Requires-Dist: ray[default]!=2.6.0,<=2.6.3,>=2.2.0; extra == "all"
-Requires-Dist: ray[default]!=2.6.0,<=2.6.3,>=2.2.0; extra == "all"
+Requires-Dist: ray[default]!=2.6.0,>=2.2.0; extra == "all"
+Requires-Dist: ray[default]!=2.6.0,>=2.2.0; extra == "all"
 Requires-Dist: urllib3<2; extra == "all"
 Requires-Dist: awscli>=1.27.10; extra == "all"
 Requires-Dist: botocore>=1.29.10; extra == "all"
 Requires-Dist: boto3>=1.26.1; extra == "all"
 Requires-Dist: colorama<0.4.5; extra == "all"
-Requires-Dist: ray[default]!=2.6.0,<=2.6.3,>=2.2.0; extra == "all"
+Requires-Dist: ray[default]!=2.6.0,>=2.2.0; extra == "all"
 Requires-Dist: oci; extra == "all"
-Requires-Dist: ray[default]!=2.6.0,<=2.6.3,>=2.2.0; extra == "all"
+Requires-Dist: ray[default]!=2.6.0,>=2.2.0; extra == "all"
 Requires-Dist: kubernetes>=20.0.0; extra == "all"
 Requires-Dist: grpcio!=1.48.0,<=1.49.1,>=1.32.0; (python_version < "3.10" and sys_platform == "darwin") and extra == "all"
 Requires-Dist: grpcio!=1.48.0,<=1.49.1,>=1.42.0; (python_version >= "3.10" and sys_platform == "darwin") and extra == "all"
 Requires-Dist: grpcio!=1.48.0,<=1.51.3,>=1.32.0; (python_version < "3.10" and sys_platform != "darwin") and extra == "all"
 Requires-Dist: grpcio!=1.48.0,<=1.51.3,>=1.42.0; (python_version >= "3.10" and sys_platform != "darwin") and extra == "all"
 Requires-Dist: protobuf!=3.19.5,>=3.15.3; extra == "all"
-Requires-Dist: pydantic<2.0,>=1.10.8; extra == "all"
+Requires-Dist: pydantic!=2.0.*,!=2.1.*,!=2.2.*,!=2.3.*,!=2.4.*,<3; extra == "all"
 Requires-Dist: runpod>=1.5.1; extra == "all"
-Requires-Dist: cudo-compute>=0.1.8; extra == "all"
+Requires-Dist: cudo-compute>=0.1.10; extra == "all"
 Requires-Dist: pyvmomi==8.0.1.0.2; extra == "all"
 
 <p align="center">
   <img alt="SkyPilot" src="https://raw.githubusercontent.com/skypilot-org/skypilot/master/docs/source/images/skypilot-wide-light-1k.png" width=55%>
 </p>
 
 <p align="center">
@@ -154,28 +156,32 @@
 
 <h3 align="center">
     Run LLMs and AI on Any Cloud
 </h3>
 
 ----
 :fire: *News* :fire:
+- [Apr, 2024] Serve and finetune [**Llama 3**](https://skypilot.readthedocs.io/en/latest/gallery/llms/llama-3.html) on any cloud or Kubernetes: [**example**](./llm/llama-3/)
+- [Apr, 2024] Serve [**Qwen-110B**](https://qwenlm.github.io/blog/qwen1.5-110b/) on your infra: [**example**](./llm/qwen/)
+- [Apr, 2024] Using [**Ollama**](https://github.com/ollama/ollama) to deploy quantized LLMs on CPUs and GPUs: [**example**](./llm/ollama/)
+- [Mar, 2024] Serve and deploy [**Databricks DBRX**](https://www.databricks.com/blog/introducing-dbrx-new-state-art-open-llm) on your infra: [**example**](./llm/dbrx/)
 - [Feb, 2024] Deploying and scaling [**Gemma**](https://blog.google/technology/developers/gemma-open-models/) with SkyServe: [**example**](./llm/gemma/)
 - [Feb, 2024] Speed up your LLM deployments with [**SGLang**](https://github.com/sgl-project/sglang) for 5x throughput on SkyServe: [**example**](./llm/sglang/)
 - [Feb, 2024] Serving [**Code Llama 70B**](https://ai.meta.com/blog/code-llama-large-language-model-coding/) with vLLM and SkyServe: [**example**](./llm/codellama/)
-- [Dec, 2023] Using [**LoRAX**](https://github.com/predibase/lorax) to serve 1000s of finetuned LLMs on a single instance in the cloud: [**example**](./llm/lorax/)
 - [Dec, 2023] [**Mixtral 8x7B**](https://mistral.ai/news/mixtral-of-experts/), a high quality sparse mixture-of-experts model, was released by Mistral AI! Deploy via SkyPilot on any cloud: [**example**](./llm/mixtral/)
 - [Nov, 2023] Using [**Axolotl**](https://github.com/OpenAccess-AI-Collective/axolotl) to finetune Mistral 7B on the cloud (on-demand and spot): [**example**](./llm/axolotl/)
-- [Sep, 2023] [**Mistral 7B**](https://mistral.ai/news/announcing-mistral-7b/), a high-quality open LLM, was released! Deploy via SkyPilot on any cloud: [**Mistral docs**](https://docs.mistral.ai/self-deployment/skypilot)
 - [Sep, 2023] Case study: [**Covariant**](https://covariant.ai/) transformed AI development on the cloud using SkyPilot, delivering models 4x faster cost-effectively: [**read the case study**](https://blog.skypilot.co/covariant/)
-- [Aug, 2023] Cookbook: Finetuning Llama 2 in your own cloud environment, privately: [**example**](./llm/vicuna-llama-2/), [**blog post**](https://blog.skypilot.co/finetuning-llama2-operational-guide/)
+- [Aug, 2023] **Finetuning Cookbook**: Finetuning Llama 2 in your own cloud environment, privately: [**example**](./llm/vicuna-llama-2/), [**blog post**](https://blog.skypilot.co/finetuning-llama2-operational-guide/)
 - [June, 2023] Serving LLM 24x Faster On the Cloud [**with vLLM**](https://vllm.ai/) and SkyPilot: [**example**](./llm/vllm/), [**blog post**](https://blog.skypilot.co/serving-llm-24x-faster-on-the-cloud-with-vllm-and-skypilot/)
 
 <details>
   <summary>Archived</summary>
-  
+
+- [Dec, 2023] Using [**LoRAX**](https://github.com/predibase/lorax) to serve 1000s of finetuned LLMs on a single instance in the cloud: [**example**](./llm/lorax/)
+- [Sep, 2023] [**Mistral 7B**](https://mistral.ai/news/announcing-mistral-7b/), a high-quality open LLM, was released! Deploy via SkyPilot on any cloud: [**Mistral docs**](https://docs.mistral.ai/self-deployment/skypilot)
 - [July, 2023] Self-Hosted **Llama-2 Chatbot** on Any Cloud: [**example**](./llm/llama-2/)
 - [April, 2023] [SkyPilot YAMLs](./llm/vicuna/) for finetuning & serving the [Vicuna LLM](https://lmsys.org/blog/2023-03-30-vicuna/) with a single command!
 
 </details>
 
 ----
 
@@ -194,22 +200,22 @@
 * [Optimizer](https://skypilot.readthedocs.io/en/latest/examples/auto-failover.html): 2x cost savings by auto-picking the cheapest VM/zone/region/cloud
 * [Autostop](https://skypilot.readthedocs.io/en/latest/reference/auto-stop.html): hands-free cleanup of idle clusters
 
 SkyPilot supports your existing GPU, TPU, and CPU workloads, with no code changes.
 
 Install with pip (we recommend the nightly build for the latest features or [from source](https://skypilot.readthedocs.io/en/latest/getting-started/installation.html)):
 ```bash
-pip install "skypilot-nightly[aws,gcp,azure,oci,lambda,runpod,fluidstack,cudo,ibm,scp,kubernetes]"  # choose your clouds
+pip install "skypilot-nightly[aws,gcp,azure,oci,lambda,runpod,fluidstack,paperspace,cudo,ibm,scp,kubernetes]"  # choose your clouds
 ```
 To get the last release, use:
 ```bash
-pip install -U "skypilot[aws,gcp,azure,oci,lambda,runpod,fluidstack,cudo,ibm,scp,kubernetes]"  # choose your clouds
+pip install -U "skypilot[aws,gcp,azure,oci,lambda,runpod,fluidstack,paperspace,cudo,ibm,scp,kubernetes]"  # choose your clouds
 ```
 
-Current supported providers (AWS, Azure, GCP, OCI, Lambda Cloud, RunPod, Fluidstack, Cudo, IBM, Samsung, Cloudflare, any Kubernetes cluster):
+Current supported providers (AWS, Azure, GCP, OCI, Lambda Cloud, RunPod, Fluidstack, Paperspace, Cudo, IBM, Samsung, Cloudflare, any Kubernetes cluster):
 <p align="center">
   <img alt="SkyPilot" src="https://raw.githubusercontent.com/skypilot-org/skypilot/master/docs/source/images/cloud-logos-light.png" width=85%>
 </p>
 
 
 ## Getting Started
 You can find our documentation [here](https://skypilot.readthedocs.io/en/latest/).
@@ -273,30 +279,34 @@
 
 ## More Information
 To learn more, see our [Documentation](https://skypilot.readthedocs.io/en/latest/) and [Tutorials](https://github.com/skypilot-org/skypilot-tutorial).
 
 <!-- Keep this section in sync with index.rst in SkyPilot Docs -->
 Runnable examples:
 - LLMs on SkyPilot
+  - [Llama 3](./llm/llama-3/)
+  - [Qwen](./llm/qwen/) 
+  - [Databricks DBRX](./llm/dbrx/)
   - [Gemma](./llm/gemma/)
   - [Mixtral 8x7B](./llm/mixtral/); [Mistral 7B](https://docs.mistral.ai/self-deployment/skypilot/) (from official Mistral team)
   - [Code Llama](./llm/codellama/)
   - [vLLM: Serving LLM 24x Faster On the Cloud](./llm/vllm/) (from official vLLM team)
   - [SGLang: Fast and Expressive LLM Serving On the Cloud](./llm/sglang/) (from official SGLang team)
   - [Vicuna chatbots: Training & Serving](./llm/vicuna/) (from official Vicuna team)
   - [Train your own Vicuna on Llama-2](./llm/vicuna-llama-2/)
   - [Self-Hosted Llama-2 Chatbot](./llm/llama-2/)
+  - [Ollama: Quantized LLMs on CPUs](./llm/ollama/)
   - [LoRAX](./llm/lorax/)
   - [QLoRA](https://github.com/artidoro/qlora/pull/132)
   - [LLaMA-LoRA-Tuner](https://github.com/zetavg/LLaMA-LoRA-Tuner#run-on-a-cloud-service-via-skypilot)
   - [Tabby: Self-hosted AI coding assistant](https://github.com/TabbyML/tabby/blob/bed723fcedb44a6b867ce22a7b1f03d2f3531c1e/experimental/eval/skypilot.yaml)
   - [LocalGPT](./llm/localgpt)
   - [Falcon](./llm/falcon)
   - Add yours here & see more in [`llm/`](./llm)!
-- Framework examples: [PyTorch DDP](https://github.com/skypilot-org/skypilot/blob/master/examples/resnet_distributed_torch.yaml), [DeepSpeed](./examples/deepspeed-multinode/sky.yaml), [JAX/Flax on TPU](https://github.com/skypilot-org/skypilot/blob/master/examples/tpu/tpuvm_mnist.yaml), [Stable Diffusion](https://github.com/skypilot-org/skypilot/tree/master/examples/stable_diffusion), [Detectron2](https://github.com/skypilot-org/skypilot/blob/master/examples/detectron2_docker.yaml), [Distributed](https://github.com/skypilot-org/skypilot/blob/master/examples/resnet_distributed_tf_app.py) [TensorFlow](https://github.com/skypilot-org/skypilot/blob/master/examples/resnet_app_storage.yaml), [Ray Train](examples/distributed_ray_train/ray_train.yaml), [NeMo](https://github.com/skypilot-org/skypilot/blob/master/examples/nemo/nemo.yaml), [programmatic grid search](https://github.com/skypilot-org/skypilot/blob/master/examples/huggingface_glue_imdb_grid_search_app.py), [Docker](https://github.com/skypilot-org/skypilot/blob/master/examples/docker/echo_app.yaml), and [many more (`examples/`)](./examples).
+- Framework examples: [PyTorch DDP](https://github.com/skypilot-org/skypilot/blob/master/examples/resnet_distributed_torch.yaml), [DeepSpeed](./examples/deepspeed-multinode/sky.yaml), [JAX/Flax on TPU](https://github.com/skypilot-org/skypilot/blob/master/examples/tpu/tpuvm_mnist.yaml), [Stable Diffusion](https://github.com/skypilot-org/skypilot/tree/master/examples/stable_diffusion), [Detectron2](https://github.com/skypilot-org/skypilot/blob/master/examples/detectron2_docker.yaml), [Distributed](https://github.com/skypilot-org/skypilot/blob/master/examples/resnet_distributed_tf_app.py) [TensorFlow](https://github.com/skypilot-org/skypilot/blob/master/examples/resnet_app_storage.yaml), [Ray Train](examples/distributed_ray_train/ray_train.yaml), [NeMo](https://github.com/skypilot-org/skypilot/blob/master/examples/nemo/nemo.yaml), [programmatic grid search](https://github.com/skypilot-org/skypilot/blob/master/examples/huggingface_glue_imdb_grid_search_app.py), [Docker](https://github.com/skypilot-org/skypilot/blob/master/examples/docker/echo_app.yaml), [Cog](https://github.com/skypilot-org/skypilot/blob/master/examples/cog/), [Unsloth](https://github.com/skypilot-org/skypilot/blob/master/examples/unsloth/unsloth.yaml), [Ollama](https://github.com/skypilot-org/skypilot/blob/master/llm/ollama) and [many more (`examples/`)](./examples).
 
 Follow updates:
 - [Twitter](https://twitter.com/skypilot_org)
 - [Slack](http://slack.skypilot.co)
 - [SkyPilot Blog](https://blog.skypilot.co/) ([Introductory blog post](https://blog.skypilot.co/introducing-skypilot/))
 
 Read the research:
```

### Comparing `skypilot-0.5.0/README.md` & `skypilot-0.6.0/README.md`

 * *Files 4% similar despite different names*

```diff
@@ -23,28 +23,32 @@
 
 <h3 align="center">
     Run LLMs and AI on Any Cloud
 </h3>
 
 ----
 :fire: *News* :fire:
+- [Apr, 2024] Serve and finetune [**Llama 3**](https://skypilot.readthedocs.io/en/latest/gallery/llms/llama-3.html) on any cloud or Kubernetes: [**example**](./llm/llama-3/)
+- [Apr, 2024] Serve [**Qwen-110B**](https://qwenlm.github.io/blog/qwen1.5-110b/) on your infra: [**example**](./llm/qwen/)
+- [Apr, 2024] Using [**Ollama**](https://github.com/ollama/ollama) to deploy quantized LLMs on CPUs and GPUs: [**example**](./llm/ollama/)
+- [Mar, 2024] Serve and deploy [**Databricks DBRX**](https://www.databricks.com/blog/introducing-dbrx-new-state-art-open-llm) on your infra: [**example**](./llm/dbrx/)
 - [Feb, 2024] Deploying and scaling [**Gemma**](https://blog.google/technology/developers/gemma-open-models/) with SkyServe: [**example**](./llm/gemma/)
 - [Feb, 2024] Speed up your LLM deployments with [**SGLang**](https://github.com/sgl-project/sglang) for 5x throughput on SkyServe: [**example**](./llm/sglang/)
 - [Feb, 2024] Serving [**Code Llama 70B**](https://ai.meta.com/blog/code-llama-large-language-model-coding/) with vLLM and SkyServe: [**example**](./llm/codellama/)
-- [Dec, 2023] Using [**LoRAX**](https://github.com/predibase/lorax) to serve 1000s of finetuned LLMs on a single instance in the cloud: [**example**](./llm/lorax/)
 - [Dec, 2023] [**Mixtral 8x7B**](https://mistral.ai/news/mixtral-of-experts/), a high quality sparse mixture-of-experts model, was released by Mistral AI! Deploy via SkyPilot on any cloud: [**example**](./llm/mixtral/)
 - [Nov, 2023] Using [**Axolotl**](https://github.com/OpenAccess-AI-Collective/axolotl) to finetune Mistral 7B on the cloud (on-demand and spot): [**example**](./llm/axolotl/)
-- [Sep, 2023] [**Mistral 7B**](https://mistral.ai/news/announcing-mistral-7b/), a high-quality open LLM, was released! Deploy via SkyPilot on any cloud: [**Mistral docs**](https://docs.mistral.ai/self-deployment/skypilot)
 - [Sep, 2023] Case study: [**Covariant**](https://covariant.ai/) transformed AI development on the cloud using SkyPilot, delivering models 4x faster cost-effectively: [**read the case study**](https://blog.skypilot.co/covariant/)
-- [Aug, 2023] Cookbook: Finetuning Llama 2 in your own cloud environment, privately: [**example**](./llm/vicuna-llama-2/), [**blog post**](https://blog.skypilot.co/finetuning-llama2-operational-guide/)
+- [Aug, 2023] **Finetuning Cookbook**: Finetuning Llama 2 in your own cloud environment, privately: [**example**](./llm/vicuna-llama-2/), [**blog post**](https://blog.skypilot.co/finetuning-llama2-operational-guide/)
 - [June, 2023] Serving LLM 24x Faster On the Cloud [**with vLLM**](https://vllm.ai/) and SkyPilot: [**example**](./llm/vllm/), [**blog post**](https://blog.skypilot.co/serving-llm-24x-faster-on-the-cloud-with-vllm-and-skypilot/)
 
 <details>
   <summary>Archived</summary>
-  
+
+- [Dec, 2023] Using [**LoRAX**](https://github.com/predibase/lorax) to serve 1000s of finetuned LLMs on a single instance in the cloud: [**example**](./llm/lorax/)
+- [Sep, 2023] [**Mistral 7B**](https://mistral.ai/news/announcing-mistral-7b/), a high-quality open LLM, was released! Deploy via SkyPilot on any cloud: [**Mistral docs**](https://docs.mistral.ai/self-deployment/skypilot)
 - [July, 2023] Self-Hosted **Llama-2 Chatbot** on Any Cloud: [**example**](./llm/llama-2/)
 - [April, 2023] [SkyPilot YAMLs](./llm/vicuna/) for finetuning & serving the [Vicuna LLM](https://lmsys.org/blog/2023-03-30-vicuna/) with a single command!
 
 </details>
 
 ----
 
@@ -63,22 +67,22 @@
 * [Optimizer](https://skypilot.readthedocs.io/en/latest/examples/auto-failover.html): 2x cost savings by auto-picking the cheapest VM/zone/region/cloud
 * [Autostop](https://skypilot.readthedocs.io/en/latest/reference/auto-stop.html): hands-free cleanup of idle clusters
 
 SkyPilot supports your existing GPU, TPU, and CPU workloads, with no code changes.
 
 Install with pip (we recommend the nightly build for the latest features or [from source](https://skypilot.readthedocs.io/en/latest/getting-started/installation.html)):
 ```bash
-pip install "skypilot-nightly[aws,gcp,azure,oci,lambda,runpod,fluidstack,cudo,ibm,scp,kubernetes]"  # choose your clouds
+pip install "skypilot-nightly[aws,gcp,azure,oci,lambda,runpod,fluidstack,paperspace,cudo,ibm,scp,kubernetes]"  # choose your clouds
 ```
 To get the last release, use:
 ```bash
-pip install -U "skypilot[aws,gcp,azure,oci,lambda,runpod,fluidstack,cudo,ibm,scp,kubernetes]"  # choose your clouds
+pip install -U "skypilot[aws,gcp,azure,oci,lambda,runpod,fluidstack,paperspace,cudo,ibm,scp,kubernetes]"  # choose your clouds
 ```
 
-Current supported providers (AWS, Azure, GCP, OCI, Lambda Cloud, RunPod, Fluidstack, Cudo, IBM, Samsung, Cloudflare, any Kubernetes cluster):
+Current supported providers (AWS, Azure, GCP, OCI, Lambda Cloud, RunPod, Fluidstack, Paperspace, Cudo, IBM, Samsung, Cloudflare, any Kubernetes cluster):
 <p align="center">
   <picture>
     <source media="(prefers-color-scheme: dark)" srcset="https://raw.githubusercontent.com/skypilot-org/skypilot/master/docs/source/images/cloud-logos-dark.png">
     <img alt="SkyPilot" src="https://raw.githubusercontent.com/skypilot-org/skypilot/master/docs/source/images/cloud-logos-light.png" width=85%>
   </picture>
 </p>
 
@@ -145,30 +149,34 @@
 
 ## More Information
 To learn more, see our [Documentation](https://skypilot.readthedocs.io/en/latest/) and [Tutorials](https://github.com/skypilot-org/skypilot-tutorial).
 
 <!-- Keep this section in sync with index.rst in SkyPilot Docs -->
 Runnable examples:
 - LLMs on SkyPilot
+  - [Llama 3](./llm/llama-3/)
+  - [Qwen](./llm/qwen/) 
+  - [Databricks DBRX](./llm/dbrx/)
   - [Gemma](./llm/gemma/)
   - [Mixtral 8x7B](./llm/mixtral/); [Mistral 7B](https://docs.mistral.ai/self-deployment/skypilot/) (from official Mistral team)
   - [Code Llama](./llm/codellama/)
   - [vLLM: Serving LLM 24x Faster On the Cloud](./llm/vllm/) (from official vLLM team)
   - [SGLang: Fast and Expressive LLM Serving On the Cloud](./llm/sglang/) (from official SGLang team)
   - [Vicuna chatbots: Training & Serving](./llm/vicuna/) (from official Vicuna team)
   - [Train your own Vicuna on Llama-2](./llm/vicuna-llama-2/)
   - [Self-Hosted Llama-2 Chatbot](./llm/llama-2/)
+  - [Ollama: Quantized LLMs on CPUs](./llm/ollama/)
   - [LoRAX](./llm/lorax/)
   - [QLoRA](https://github.com/artidoro/qlora/pull/132)
   - [LLaMA-LoRA-Tuner](https://github.com/zetavg/LLaMA-LoRA-Tuner#run-on-a-cloud-service-via-skypilot)
   - [Tabby: Self-hosted AI coding assistant](https://github.com/TabbyML/tabby/blob/bed723fcedb44a6b867ce22a7b1f03d2f3531c1e/experimental/eval/skypilot.yaml)
   - [LocalGPT](./llm/localgpt)
   - [Falcon](./llm/falcon)
   - Add yours here & see more in [`llm/`](./llm)!
-- Framework examples: [PyTorch DDP](https://github.com/skypilot-org/skypilot/blob/master/examples/resnet_distributed_torch.yaml), [DeepSpeed](./examples/deepspeed-multinode/sky.yaml), [JAX/Flax on TPU](https://github.com/skypilot-org/skypilot/blob/master/examples/tpu/tpuvm_mnist.yaml), [Stable Diffusion](https://github.com/skypilot-org/skypilot/tree/master/examples/stable_diffusion), [Detectron2](https://github.com/skypilot-org/skypilot/blob/master/examples/detectron2_docker.yaml), [Distributed](https://github.com/skypilot-org/skypilot/blob/master/examples/resnet_distributed_tf_app.py) [TensorFlow](https://github.com/skypilot-org/skypilot/blob/master/examples/resnet_app_storage.yaml), [Ray Train](examples/distributed_ray_train/ray_train.yaml), [NeMo](https://github.com/skypilot-org/skypilot/blob/master/examples/nemo/nemo.yaml), [programmatic grid search](https://github.com/skypilot-org/skypilot/blob/master/examples/huggingface_glue_imdb_grid_search_app.py), [Docker](https://github.com/skypilot-org/skypilot/blob/master/examples/docker/echo_app.yaml), and [many more (`examples/`)](./examples).
+- Framework examples: [PyTorch DDP](https://github.com/skypilot-org/skypilot/blob/master/examples/resnet_distributed_torch.yaml), [DeepSpeed](./examples/deepspeed-multinode/sky.yaml), [JAX/Flax on TPU](https://github.com/skypilot-org/skypilot/blob/master/examples/tpu/tpuvm_mnist.yaml), [Stable Diffusion](https://github.com/skypilot-org/skypilot/tree/master/examples/stable_diffusion), [Detectron2](https://github.com/skypilot-org/skypilot/blob/master/examples/detectron2_docker.yaml), [Distributed](https://github.com/skypilot-org/skypilot/blob/master/examples/resnet_distributed_tf_app.py) [TensorFlow](https://github.com/skypilot-org/skypilot/blob/master/examples/resnet_app_storage.yaml), [Ray Train](examples/distributed_ray_train/ray_train.yaml), [NeMo](https://github.com/skypilot-org/skypilot/blob/master/examples/nemo/nemo.yaml), [programmatic grid search](https://github.com/skypilot-org/skypilot/blob/master/examples/huggingface_glue_imdb_grid_search_app.py), [Docker](https://github.com/skypilot-org/skypilot/blob/master/examples/docker/echo_app.yaml), [Cog](https://github.com/skypilot-org/skypilot/blob/master/examples/cog/), [Unsloth](https://github.com/skypilot-org/skypilot/blob/master/examples/unsloth/unsloth.yaml), [Ollama](https://github.com/skypilot-org/skypilot/blob/master/llm/ollama) and [many more (`examples/`)](./examples).
 
 Follow updates:
 - [Twitter](https://twitter.com/skypilot_org)
 - [Slack](http://slack.skypilot.co)
 - [SkyPilot Blog](https://blog.skypilot.co/) ([Introductory blog post](https://blog.skypilot.co/introducing-skypilot/))
 
 Read the research:
```

#### html2text {}

```diff
@@ -1,40 +1,48 @@
                                   [SkyPilot]
                   _[_D_o_c_u_m_e_n_t_a_t_i_o_n_]_[_G_i_t_H_u_b_ _R_e_l_e_a_s_e_]_[_J_o_i_n_ _S_l_a_c_k_]
                     ******** RRuunn LLLLMMss aanndd AAII oonn AAnnyy CClloouudd ********
----- :fire: *News* :fire: - [Feb, 2024] Deploying and scaling [**Gemma**]
-(https://blog.google/technology/developers/gemma-open-models/) with SkyServe:
-[**example**](./llm/gemma/) - [Feb, 2024] Speed up your LLM deployments with
-[**SGLang**](https://github.com/sgl-project/sglang) for 5x throughput on
-SkyServe: [**example**](./llm/sglang/) - [Feb, 2024] Serving [**Code Llama
-70B**](https://ai.meta.com/blog/code-llama-large-language-model-coding/) with
-vLLM and SkyServe: [**example**](./llm/codellama/) - [Dec, 2023] Using
-[**LoRAX**](https://github.com/predibase/lorax) to serve 1000s of finetuned
-LLMs on a single instance in the cloud: [**example**](./llm/lorax/) - [Dec,
-2023] [**Mixtral 8x7B**](https://mistral.ai/news/mixtral-of-experts/), a high
-quality sparse mixture-of-experts model, was released by Mistral AI! Deploy via
-SkyPilot on any cloud: [**example**](./llm/mixtral/) - [Nov, 2023] Using
-[**Axolotl**](https://github.com/OpenAccess-AI-Collective/axolotl) to finetune
-Mistral 7B on the cloud (on-demand and spot): [**example**](./llm/axolotl/) -
-[Sep, 2023] [**Mistral 7B**](https://mistral.ai/news/announcing-mistral-7b/), a
-high-quality open LLM, was released! Deploy via SkyPilot on any cloud:
-[**Mistral docs**](https://docs.mistral.ai/self-deployment/skypilot) - [Sep,
-2023] Case study: [**Covariant**](https://covariant.ai/) transformed AI
-development on the cloud using SkyPilot, delivering models 4x faster cost-
-effectively: [**read the case study**](https://blog.skypilot.co/covariant/) -
-[Aug, 2023] Cookbook: Finetuning Llama 2 in your own cloud environment,
-privately: [**example**](./llm/vicuna-llama-2/), [**blog post**](https://
-blog.skypilot.co/finetuning-llama2-operational-guide/) - [June, 2023] Serving
-LLM 24x Faster On the Cloud [**with vLLM**](https://vllm.ai/) and SkyPilot:
-[**example**](./llm/vllm/), [**blog post**](https://blog.skypilot.co/serving-
-llm-24x-faster-on-the-cloud-with-vllm-and-skypilot/) Archived - [July, 2023]
-Self-Hosted **Llama-2 Chatbot** on Any Cloud: [**example**](./llm/llama-2/) -
-[April, 2023] [SkyPilot YAMLs](./llm/vicuna/) for finetuning & serving the
-[Vicuna LLM](https://lmsys.org/blog/2023-03-30-vicuna/) with a single command!
----- SkyPilot is a framework for running LLMs, AI, and batch jobs on any cloud,
+---- :fire: *News* :fire: - [Apr, 2024] Serve and finetune [**Llama 3**](https:
+//skypilot.readthedocs.io/en/latest/gallery/llms/llama-3.html) on any cloud or
+Kubernetes: [**example**](./llm/llama-3/) - [Apr, 2024] Serve [**Qwen-110B**]
+(https://qwenlm.github.io/blog/qwen1.5-110b/) on your infra: [**example**](./
+llm/qwen/) - [Apr, 2024] Using [**Ollama**](https://github.com/ollama/ollama)
+to deploy quantized LLMs on CPUs and GPUs: [**example**](./llm/ollama/) - [Mar,
+2024] Serve and deploy [**Databricks DBRX**](https://www.databricks.com/blog/
+introducing-dbrx-new-state-art-open-llm) on your infra: [**example**](./llm/
+dbrx/) - [Feb, 2024] Deploying and scaling [**Gemma**](https://blog.google/
+technology/developers/gemma-open-models/) with SkyServe: [**example**](./llm/
+gemma/) - [Feb, 2024] Speed up your LLM deployments with [**SGLang**](https://
+github.com/sgl-project/sglang) for 5x throughput on SkyServe: [**example**](./
+llm/sglang/) - [Feb, 2024] Serving [**Code Llama 70B**](https://ai.meta.com/
+blog/code-llama-large-language-model-coding/) with vLLM and SkyServe:
+[**example**](./llm/codellama/) - [Dec, 2023] [**Mixtral 8x7B**](https://
+mistral.ai/news/mixtral-of-experts/), a high quality sparse mixture-of-experts
+model, was released by Mistral AI! Deploy via SkyPilot on any cloud:
+[**example**](./llm/mixtral/) - [Nov, 2023] Using [**Axolotl**](https://
+github.com/OpenAccess-AI-Collective/axolotl) to finetune Mistral 7B on the
+cloud (on-demand and spot): [**example**](./llm/axolotl/) - [Sep, 2023] Case
+study: [**Covariant**](https://covariant.ai/) transformed AI development on the
+cloud using SkyPilot, delivering models 4x faster cost-effectively: [**read the
+case study**](https://blog.skypilot.co/covariant/) - [Aug, 2023] **Finetuning
+Cookbook**: Finetuning Llama 2 in your own cloud environment, privately:
+[**example**](./llm/vicuna-llama-2/), [**blog post**](https://blog.skypilot.co/
+finetuning-llama2-operational-guide/) - [June, 2023] Serving LLM 24x Faster On
+the Cloud [**with vLLM**](https://vllm.ai/) and SkyPilot: [**example**](./llm/
+vllm/), [**blog post**](https://blog.skypilot.co/serving-llm-24x-faster-on-the-
+cloud-with-vllm-and-skypilot/) Archived - [Dec, 2023] Using [**LoRAX**](https:/
+/github.com/predibase/lorax) to serve 1000s of finetuned LLMs on a single
+instance in the cloud: [**example**](./llm/lorax/) - [Sep, 2023] [**Mistral
+7B**](https://mistral.ai/news/announcing-mistral-7b/), a high-quality open LLM,
+was released! Deploy via SkyPilot on any cloud: [**Mistral docs**](https://
+docs.mistral.ai/self-deployment/skypilot) - [July, 2023] Self-Hosted **Llama-
+2 Chatbot** on Any Cloud: [**example**](./llm/llama-2/) - [April, 2023]
+[SkyPilot YAMLs](./llm/vicuna/) for finetuning & serving the [Vicuna LLM]
+(https://lmsys.org/blog/2023-03-30-vicuna/) with a single command! ---
+- SkyPilot is a framework for running LLMs, AI, and batch jobs on any cloud,
 offering maximum cost savings, highest GPU availability, and managed execution.
 SkyPilot **abstracts away cloud infra burdens**: - Launch jobs & clusters on
 any cloud - Easy scale-out: queue and run many jobs, automatically managed -
 Easy access to object stores (S3, GCS, R2) SkyPilot **maximizes GPU
 availability for your jobs**: * Provision in all zones/regions/clouds you have
 access to ([the _Sky_](https://arxiv.org/abs/2205.07147)), with automatic
 failover SkyPilot **cuts your cloud costs**: * [Managed Spot](https://
@@ -43,20 +51,21 @@
 skypilot.readthedocs.io/en/latest/examples/auto-failover.html): 2x cost savings
 by auto-picking the cheapest VM/zone/region/cloud * [Autostop](https://
 skypilot.readthedocs.io/en/latest/reference/auto-stop.html): hands-free cleanup
 of idle clusters SkyPilot supports your existing GPU, TPU, and CPU workloads,
 with no code changes. Install with pip (we recommend the nightly build for the
 latest features or [from source](https://skypilot.readthedocs.io/en/latest/
 getting-started/installation.html)): ```bash pip install "skypilot-nightly
-[aws,gcp,azure,oci,lambda,runpod,fluidstack,cudo,ibm,scp,kubernetes]" # choose
-your clouds ``` To get the last release, use: ```bash pip install -U "skypilot
-[aws,gcp,azure,oci,lambda,runpod,fluidstack,cudo,ibm,scp,kubernetes]" # choose
-your clouds ``` Current supported providers (AWS, Azure, GCP, OCI, Lambda
-Cloud, RunPod, Fluidstack, Cudo, IBM, Samsung, Cloudflare, any Kubernetes
-cluster):
+[aws,gcp,azure,oci,lambda,runpod,fluidstack,paperspace,cudo,ibm,scp,kubernetes]"
+# choose your clouds ``` To get the last release, use: ```bash pip install -
+U "skypilot
+[aws,gcp,azure,oci,lambda,runpod,fluidstack,paperspace,cudo,ibm,scp,kubernetes]"
+# choose your clouds ``` Current supported providers (AWS, Azure, GCP, OCI,
+Lambda Cloud, RunPod, Fluidstack, Paperspace, Cudo, IBM, Samsung, Cloudflare,
+any Kubernetes cluster):
                                   [SkyPilot]
 ## Getting Started You can find our documentation [here](https://
 skypilot.readthedocs.io/en/latest/). - [Installation](https://
 skypilot.readthedocs.io/en/latest/getting-started/installation.html) -
 [Quickstart](https://skypilot.readthedocs.io/en/latest/getting-started/
 quickstart.html) - [CLI reference](https://skypilot.readthedocs.io/en/latest/
 reference/cli.html) ## SkyPilot in 1 Minute A SkyPilot task specifies: resource
@@ -82,25 +91,27 @@
 3. Sync the local `workdir` to the VM 4. Run the task's `setup` commands to
 prepare the VM for running the task 5. Run the task's `run` commands
                                 [SkyPilot Demo]
 Refer to [Quickstart](https://skypilot.readthedocs.io/en/latest/getting-
 started/quickstart.html) to get started with SkyPilot. ## More Information To
 learn more, see our [Documentation](https://skypilot.readthedocs.io/en/latest/
 ) and [Tutorials](https://github.com/skypilot-org/skypilot-tutorial). Runnable
-examples: - LLMs on SkyPilot - [Gemma](./llm/gemma/) - [Mixtral 8x7B](./llm/
-mixtral/); [Mistral 7B](https://docs.mistral.ai/self-deployment/skypilot/)
+examples: - LLMs on SkyPilot - [Llama 3](./llm/llama-3/) - [Qwen](./llm/qwen/
+) - [Databricks DBRX](./llm/dbrx/) - [Gemma](./llm/gemma/) - [Mixtral 8x7B](./
+llm/mixtral/); [Mistral 7B](https://docs.mistral.ai/self-deployment/skypilot/)
 (from official Mistral team) - [Code Llama](./llm/codellama/) - [vLLM: Serving
 LLM 24x Faster On the Cloud](./llm/vllm/) (from official vLLM team) - [SGLang:
 Fast and Expressive LLM Serving On the Cloud](./llm/sglang/) (from official
 SGLang team) - [Vicuna chatbots: Training & Serving](./llm/vicuna/) (from
 official Vicuna team) - [Train your own Vicuna on Llama-2](./llm/vicuna-llama-
-2/) - [Self-Hosted Llama-2 Chatbot](./llm/llama-2/) - [LoRAX](./llm/lorax/) -
-[QLoRA](https://github.com/artidoro/qlora/pull/132) - [LLaMA-LoRA-Tuner](https:
-//github.com/zetavg/LLaMA-LoRA-Tuner#run-on-a-cloud-service-via-skypilot) -
-[Tabby: Self-hosted AI coding assistant](https://github.com/TabbyML/tabby/blob/
+2/) - [Self-Hosted Llama-2 Chatbot](./llm/llama-2/) - [Ollama: Quantized LLMs
+on CPUs](./llm/ollama/) - [LoRAX](./llm/lorax/) - [QLoRA](https://github.com/
+artidoro/qlora/pull/132) - [LLaMA-LoRA-Tuner](https://github.com/zetavg/LLaMA-
+LoRA-Tuner#run-on-a-cloud-service-via-skypilot) - [Tabby: Self-hosted AI coding
+assistant](https://github.com/TabbyML/tabby/blob/
 bed723fcedb44a6b867ce22a7b1f03d2f3531c1e/experimental/eval/skypilot.yaml) -
 [LocalGPT](./llm/localgpt) - [Falcon](./llm/falcon) - Add yours here & see more
 in [`llm/`](./llm)! - Framework examples: [PyTorch DDP](https://github.com/
 skypilot-org/skypilot/blob/master/examples/resnet_distributed_torch.yaml),
 [DeepSpeed](./examples/deepspeed-multinode/sky.yaml), [JAX/Flax on TPU](https:/
 /github.com/skypilot-org/skypilot/blob/master/examples/tpu/tpuvm_mnist.yaml),
 [Stable Diffusion](https://github.com/skypilot-org/skypilot/tree/master/
@@ -109,16 +120,19 @@
 github.com/skypilot-org/skypilot/blob/master/examples/
 resnet_distributed_tf_app.py) [TensorFlow](https://github.com/skypilot-org/
 skypilot/blob/master/examples/resnet_app_storage.yaml), [Ray Train](examples/
 distributed_ray_train/ray_train.yaml), [NeMo](https://github.com/skypilot-org/
 skypilot/blob/master/examples/nemo/nemo.yaml), [programmatic grid search]
 (https://github.com/skypilot-org/skypilot/blob/master/examples/
 huggingface_glue_imdb_grid_search_app.py), [Docker](https://github.com/
-skypilot-org/skypilot/blob/master/examples/docker/echo_app.yaml), and [many
-more (`examples/`)](./examples). Follow updates: - [Twitter](https://
+skypilot-org/skypilot/blob/master/examples/docker/echo_app.yaml), [Cog](https:/
+/github.com/skypilot-org/skypilot/blob/master/examples/cog/), [Unsloth](https:/
+/github.com/skypilot-org/skypilot/blob/master/examples/unsloth/unsloth.yaml),
+[Ollama](https://github.com/skypilot-org/skypilot/blob/master/llm/ollama) and
+[many more (`examples/`)](./examples). Follow updates: - [Twitter](https://
 twitter.com/skypilot_org) - [Slack](http://slack.skypilot.co) - [SkyPilot Blog]
 (https://blog.skypilot.co/) ([Introductory blog post](https://blog.skypilot.co/
 introducing-skypilot/)) Read the research: - [SkyPilot paper](https://
 www.usenix.org/system/files/nsdi23-yang-zongheng.pdf) and [talk](https://
 www.usenix.org/conference/nsdi23/presentation/yang-zongheng) (NSDI 2023) - [Sky
 Computing whitepaper](https://arxiv.org/abs/2205.07147) - [Sky Computing vision
 paper](https://sigops.org/s/conferences/hotos/2021/papers/hotos21-s02-
```

### Comparing `skypilot-0.5.0/pyproject.toml` & `skypilot-0.6.0/pyproject.toml`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/setup.py` & `skypilot-0.6.0/setup.py`

 * *Files 2% similar despite different names*

```diff
@@ -165,38 +165,36 @@
 ]
 
 local_ray = [
     # Lower version of ray will cause dependency conflict for
     # click/grpcio/protobuf.
     # Excluded 2.6.0 as it has a bug in the cluster launcher:
     # https://github.com/ray-project/ray/releases/tag/ray-2.6.1
-    'ray[default] >= 2.2.0, <= 2.6.3, != 2.6.0',
+    'ray[default] >= 2.2.0, != 2.6.0',
 ]
 
 remote = [
     # Adopted from ray's setup.py: https://github.com/ray-project/ray/blob/ray-2.4.0/python/setup.py
     # SkyPilot: != 1.48.0 is required to avoid the error where ray dashboard fails to start when
     # ray start is called (#2054).
     # Tracking issue: https://github.com/ray-project/ray/issues/30984
     "grpcio >= 1.32.0, <= 1.49.1, != 1.48.0; python_version < '3.10' and sys_platform == 'darwin'",  # noqa:E501
     "grpcio >= 1.42.0, <= 1.49.1, != 1.48.0; python_version >= '3.10' and sys_platform == 'darwin'",  # noqa:E501
     # Original issue: https://github.com/ray-project/ray/issues/33833
     "grpcio >= 1.32.0, <= 1.51.3, != 1.48.0; python_version < '3.10' and sys_platform != 'darwin'",  # noqa:E501
     "grpcio >= 1.42.0, <= 1.51.3, != 1.48.0; python_version >= '3.10' and sys_platform != 'darwin'",  # noqa:E501
     # Adopted from ray's setup.py:
-    # https://github.com/ray-project/ray/blob/86fab1764e618215d8131e8e5068f0d493c77023/python/setup.py#L326
+    # https://github.com/ray-project/ray/blob/ray-2.9.3/python/setup.py#L343
     'protobuf >= 3.15.3, != 3.19.5',
-    # Ray job has an issue with pydantic>2.0.0, due to API changes of pydantic. See
-    # https://github.com/ray-project/ray/issues/36990
-    # >=1.10.8 is needed for ray>=2.6. See
-    # https://github.com/ray-project/ray/issues/35661
-    'pydantic <2.0, >=1.10.8',
+    # Some pydantic versions are not compatible with ray. Adopted from ray's
+    # setup.py: https://github.com/ray-project/ray/blob/ray-2.9.3/python/setup.py#L254
+    'pydantic!=2.0.*,!=2.1.*,!=2.2.*,!=2.3.*,!=2.4.*,<3',
 ]
 
-# NOTE: Change the templates/spot-controller.yaml.j2 file if any of the
+# NOTE: Change the templates/jobs-controller.yaml.j2 file if any of the
 # following packages dependencies are changed.
 aws_dependencies = [
     # botocore does not work with urllib3>=2.0.0, according to https://github.com/boto/botocore/issues/2926
     # We have to explicitly pin the version to optimize the time for
     # poetry install. See https://github.com/orgs/python-poetry/discussions/7937
     'urllib3<2',
     # NOTE: this installs CLI V1. To use AWS SSO (e.g., `aws sso login`), users
@@ -233,15 +231,16 @@
     'cloudflare': aws_dependencies,
     'scp': local_ray,
     'oci': ['oci'] + local_ray,
     'kubernetes': ['kubernetes>=20.0.0'],
     'remote': remote,
     'runpod': ['runpod>=1.5.1'],
     'fluidstack': [],  # No dependencies needed for fluidstack
-    'cudo': ['cudo-compute>=0.1.8'],
+    'cudo': ['cudo-compute>=0.1.10'],
+    'paperspace': [],  # No dependencies needed for paperspace
     'vsphere': [
         'pyvmomi==8.0.1.0.2',
         # vsphere-automation-sdk is also required, but it does not have
         # pypi release, which cause failure of our pypi release.
         # https://peps.python.org/pep-0440/#direct-references
         # We have the instruction for its installation in our
         # docs instead.
@@ -284,14 +283,15 @@
     },
     include_package_data=True,
     classifiers=[
         'Programming Language :: Python :: 3.7',
         'Programming Language :: Python :: 3.8',
         'Programming Language :: Python :: 3.9',
         'Programming Language :: Python :: 3.10',
+        'Programming Language :: Python :: 3.11',
         'License :: OSI Approved :: Apache Software License',
         'Operating System :: OS Independent',
         'Topic :: Software Development :: Libraries :: Python Modules',
         'Topic :: System :: Distributed Computing',
     ],
     project_urls={
         'Homepage': 'https://github.com/skypilot-org/skypilot',
```

### Comparing `skypilot-0.5.0/sky/adaptors/aws.py` & `skypilot-0.6.0/sky/adaptors/aws.py`

 * *Files 10% similar despite different names*

```diff
@@ -30,20 +30,25 @@
 
 import functools
 import logging
 import threading
 import time
 from typing import Any, Callable
 
+from sky.adaptors import common
 from sky.utils import common_utils
 
-logger = logging.getLogger(__name__)
+_IMPORT_ERROR_MESSAGE = ('Failed to import dependencies for AWS. '
+                         'Try pip install "skypilot[aws]"')
+boto3 = common.LazyImport('boto3', import_error_message=_IMPORT_ERROR_MESSAGE)
+botocore = common.LazyImport('botocore',
+                             import_error_message=_IMPORT_ERROR_MESSAGE)
+_LAZY_MODULES = (boto3, botocore)
 
-boto3 = None
-botocore = None
+logger = logging.getLogger(__name__)
 _session_creation_lock = threading.RLock()
 
 version = 1
 
 # Retry 5 times by default for potential credential errors,
 # mentioned in
 # https://github.com/skypilot-org/skypilot/pull/1988
@@ -69,33 +74,14 @@
             return local_cache.cache(func)(*args, **kwargs)
 
         return wrapper
 
     return decorator
 
 
-def import_package(func):
-
-    @functools.wraps(func)
-    def wrapper(*args, **kwargs):
-        global boto3, botocore
-        if boto3 is None or botocore is None:
-            try:
-                import boto3 as _boto3
-                import botocore as _botocore
-                boto3 = _boto3
-                botocore = _botocore
-            except ImportError:
-                raise ImportError('Fail to import dependencies for AWS. '
-                                  'Try pip install "skypilot[aws]"') from None
-        return func(*args, **kwargs)
-
-    return wrapper
-
-
 def _assert_kwargs_builtin_type(kwargs):
     assert all(isinstance(v, (int, float, str)) for v in kwargs.values()), (
         f'kwargs should not contain none built-in types: {kwargs}')
 
 
 def _create_aws_object(creation_fn_or_cls: Callable[[], Any],
                        object_name: str) -> Any:
@@ -127,24 +113,22 @@
             if attempt >= _MAX_ATTEMPT_FOR_CREATION:
                 raise
             time.sleep(backoff.current_backoff())
             logger.info(f'Retry creating AWS {object_name} due to '
                         f'{common_utils.format_exception(e)}.')
 
 
-@import_package
 # The LRU cache needs to be thread-local to avoid multiple threads sharing the
 # same session object, which is not guaranteed to be thread-safe.
 @_thread_local_lru_cache()
 def session():
     """Create an AWS session."""
     return _create_aws_object(boto3.session.Session, 'session')
 
 
-@import_package
 # Avoid caching the resource/client objects. If we are using the assumed role,
 # the credentials will be automatically rotated, but the cached resource/client
 # object will only refresh the credentials with a fixed 15 minutes interval,
 # which can cause unexpected NoCredentialsError. By creating the resource/client
 # object every time, the credentials will be explicitly refreshed.
 # The creation of the resource/client is relatively fast (around 0.3s), so the
 # performance impact is negligible.
@@ -168,15 +152,14 @@
     # Need to use the client retrieved from the per-thread session to avoid
     # thread-safety issues (Directly creating the client with boto3.resource()
     # is not thread-safe). Reference: https://stackoverflow.com/a/59635814
     return _create_aws_object(
         lambda: session().resource(service_name, **kwargs), 'resource')
 
 
-@import_package
 def client(service_name: str, **kwargs):
     """Create an AWS client of a certain service.
 
     Args:
         service_name: AWS service name (e.g., 's3', 'ec2').
         kwargs: Other options.
     """
@@ -185,19 +168,19 @@
     # thread-safety issues (Directly creating the client with boto3.client() is
     # not thread-safe). Reference: https://stackoverflow.com/a/59635814
 
     return _create_aws_object(lambda: session().client(service_name, **kwargs),
                               'client')
 
 
-@import_package
+@common.load_lazy_modules(modules=_LAZY_MODULES)
 def botocore_exceptions():
     """AWS botocore exception."""
     from botocore import exceptions
     return exceptions
 
 
-@import_package
+@common.load_lazy_modules(modules=_LAZY_MODULES)
 def botocore_config():
     """AWS botocore exception."""
     from botocore import config
     return config
```

### Comparing `skypilot-0.5.0/sky/adaptors/azure.py` & `skypilot-0.6.0/sky/adaptors/azure.py`

 * *Files 14% similar despite different names*

```diff
@@ -1,75 +1,65 @@
 """Azure cli adaptor"""
 
 # pylint: disable=import-outside-toplevel
 import functools
 import threading
 
-azure = None
-_session_creation_lock = threading.RLock()
-
+from sky.adaptors import common
 
-def import_package(func):
+azure = common.LazyImport(
+    'azure',
+    import_error_message=('Failed to import dependencies for Azure.'
+                          'Try pip install "skypilot[azure]"'))
+_LAZY_MODULES = (azure,)
 
-    @functools.wraps(func)
-    def wrapper(*args, **kwargs):
-        global azure
-        if azure is None:
-            try:
-                import azure as _azure  # type: ignore
-                azure = _azure
-            except ImportError:
-                raise ImportError('Fail to import dependencies for Azure.'
-                                  'Try pip install "skypilot[azure]"') from None
-        return func(*args, **kwargs)
-
-    return wrapper
+_session_creation_lock = threading.RLock()
 
 
-@import_package
+@common.load_lazy_modules(modules=_LAZY_MODULES)
 def get_subscription_id() -> str:
     """Get the default subscription id."""
     from azure.common import credentials
     return credentials.get_cli_profile().get_subscription_id()
 
 
-@import_package
+@common.load_lazy_modules(modules=_LAZY_MODULES)
 def get_current_account_user() -> str:
     """Get the default account user."""
     from azure.common import credentials
     return credentials.get_cli_profile().get_current_account_user()
 
 
-@import_package
-def http_error_exception():
-    """HttpError exception."""
-    from azure.core import exceptions
-    return exceptions.HttpResponseError
+@common.load_lazy_modules(modules=_LAZY_MODULES)
+def exceptions():
+    """Azure exceptions."""
+    from azure.core import exceptions as azure_exceptions
+    return azure_exceptions
 
 
 @functools.lru_cache()
-@import_package
+@common.load_lazy_modules(modules=_LAZY_MODULES)
 def get_client(name: str, subscription_id: str):
     # Sky only supports Azure CLI credential for now.
     # Increase the timeout to fix the Azure get-access-token timeout issue.
     # Tracked in
     # https://github.com/Azure/azure-cli/issues/20404#issuecomment-1249575110
     from azure.identity import AzureCliCredential
-    from azure.mgmt.network import NetworkManagementClient
-    from azure.mgmt.resource import ResourceManagementClient
     with _session_creation_lock:
         credential = AzureCliCredential(process_timeout=30)
         if name == 'compute':
             from azure.mgmt.compute import ComputeManagementClient
             return ComputeManagementClient(credential, subscription_id)
         elif name == 'network':
+            from azure.mgmt.network import NetworkManagementClient
             return NetworkManagementClient(credential, subscription_id)
         elif name == 'resource':
+            from azure.mgmt.resource import ResourceManagementClient
             return ResourceManagementClient(credential, subscription_id)
         else:
             raise ValueError(f'Client not supported: "{name}"')
 
 
-@import_package
+@common.load_lazy_modules(modules=_LAZY_MODULES)
 def create_security_rule(**kwargs):
     from azure.mgmt.network.models import SecurityRule
     return SecurityRule(**kwargs)
```

### Comparing `skypilot-0.5.0/sky/adaptors/cloudflare.py` & `skypilot-0.6.0/sky/adaptors/cloudflare.py`

 * *Files 12% similar despite different names*

```diff
@@ -3,43 +3,31 @@
 
 import contextlib
 import functools
 import os
 import threading
 from typing import Dict, Optional, Tuple
 
+from sky.adaptors import common
 from sky.utils import ux_utils
 
-boto3 = None
-botocore = None
+_IMPORT_ERROR_MESSAGE = ('Failed to import dependencies for Cloudflare.'
+                         'Try pip install "skypilot[cloudflare]"')
+boto3 = common.LazyImport('boto3', import_error_message=_IMPORT_ERROR_MESSAGE)
+botocore = common.LazyImport('botocore',
+                             import_error_message=_IMPORT_ERROR_MESSAGE)
+_LAZY_MODULES = (boto3, botocore)
+
 _session_creation_lock = threading.RLock()
 ACCOUNT_ID_PATH = '~/.cloudflare/accountid'
 R2_CREDENTIALS_PATH = '~/.cloudflare/r2.credentials'
 R2_PROFILE_NAME = 'r2'
 _INDENT_PREFIX = '    '
 NAME = 'Cloudflare'
-
-
-def import_package(func):
-
-    @functools.wraps(func)
-    def wrapper(*args, **kwargs):
-        global boto3, botocore
-        if boto3 is None or botocore is None:
-            try:
-                import boto3 as _boto3
-                import botocore as _botocore
-                boto3 = _boto3
-                botocore = _botocore
-            except ImportError:
-                raise ImportError('Fail to import dependencies for Cloudflare.'
-                                  'Try pip install "skypilot[aws]"') from None
-        return func(*args, **kwargs)
-
-    return wrapper
+SKY_CHECK_NAME = 'Cloudflare (for R2 object store)'
 
 
 @contextlib.contextmanager
 def _load_r2_credentials_env():
     """Context manager to temporarily change the AWS credentials file path."""
     prev_credentials_path = os.environ.get('AWS_SHARED_CREDENTIALS_FILE')
     os.environ['AWS_SHARED_CREDENTIALS_FILE'] = R2_CREDENTIALS_PATH
@@ -71,30 +59,28 @@
             return cloudflare_credentials.get_frozen_credentials()
 
 
 # lru_cache() is thread-safe and it will return the same session object
 # for different threads.
 # Reference: https://docs.python.org/3/library/functools.html#functools.lru_cache # pylint: disable=line-too-long
 @functools.lru_cache()
-@import_package
 def session():
     """Create an AWS session."""
     # Creating the session object is not thread-safe for boto3,
     # so we add a reentrant lock to synchronize the session creation.
     # Reference: https://github.com/boto/boto3/issues/1592
     # However, the session object itself is thread-safe, so we are
     # able to use lru_cache() to cache the session object.
     with _session_creation_lock:
         with _load_r2_credentials_env():
             session_ = boto3.session.Session(profile_name=R2_PROFILE_NAME)
         return session_
 
 
 @functools.lru_cache()
-@import_package
 def resource(resource_name: str, **kwargs):
     """Create a Cloudflare resource.
 
     Args:
         resource_name: Cloudflare resource name (e.g., 's3').
         kwargs: Other options.
     """
@@ -137,15 +123,15 @@
         service_name,
         endpoint_url=endpoint,
         aws_access_key_id=cloudflare_credentials.access_key,
         aws_secret_access_key=cloudflare_credentials.secret_key,
         region_name=region)
 
 
-@import_package
+@common.load_lazy_modules(_LAZY_MODULES)
 def botocore_exceptions():
     """AWS botocore exception."""
     from botocore import exceptions
     return exceptions
 
 
 def create_endpoint():
```

### Comparing `skypilot-0.5.0/sky/adaptors/ibm.py` & `skypilot-0.6.0/sky/adaptors/ibm.py`

 * *Files 13% similar despite different names*

```diff
@@ -1,77 +1,56 @@
 """IBM cloud adaptors"""
 
 # pylint: disable=import-outside-toplevel
 
-import functools
 import json
 import multiprocessing
 import os
 
 import requests
 import yaml
 
 from sky import sky_logging
+from sky.adaptors import common
 
 CREDENTIAL_FILE = '~/.ibm/credentials.yaml'
 logger = sky_logging.init_logger(__name__)
 
-ibm_vpc = None
-ibm_cloud_sdk_core = None
-ibm_platform_services = None
-ibm_boto3 = None
-ibm_botocore = None
-
-
-def import_package(func):
-
-    @functools.wraps(func)
-    def wrapper(*args, **kwargs):
-        global ibm_vpc, ibm_cloud_sdk_core, ibm_platform_services
-        global ibm_boto3, ibm_botocore
-        if None in [ibm_vpc, ibm_cloud_sdk_core, ibm_platform_services]:
-            try:
-                import ibm_boto3 as _ibm_boto3
-                import ibm_botocore as _ibm_botocore
-                import ibm_cloud_sdk_core as _ibm_cloud_sdk_core
-                import ibm_platform_services as _ibm_platform_services
-                import ibm_vpc as _ibm_vpc
-                ibm_vpc = _ibm_vpc
-                ibm_cloud_sdk_core = _ibm_cloud_sdk_core
-                ibm_platform_services = _ibm_platform_services
-                ibm_boto3 = _ibm_boto3
-                ibm_botocore = _ibm_botocore
-            except ImportError:
-                raise ImportError(
-                    'Failed to import dependencies for IBM. '
-                    'Try running: pip install "skypilot[ibm]".\n') from None
-        return func(*args, **kwargs)
-
-    return wrapper
+_IMPORT_ERROR_MESSAGE = ('Failed to import dependencies for IBM. '
+                         'Try running: pip install "skypilot[ibm]".\n')
+ibm_vpc = common.LazyImport('ibm_vpc',
+                            import_error_message=_IMPORT_ERROR_MESSAGE)
+ibm_cloud_sdk_core = common.LazyImport(
+    'ibm_cloud_sdk_core', import_error_message=_IMPORT_ERROR_MESSAGE)
+ibm_platform_services = common.LazyImport(
+    'ibm_platform_services', import_error_message=_IMPORT_ERROR_MESSAGE)
+ibm_boto3 = common.LazyImport('ibm_boto3',
+                              import_error_message=_IMPORT_ERROR_MESSAGE)
+ibm_botocore = common.LazyImport('ibm_botocore',
+                                 import_error_message=_IMPORT_ERROR_MESSAGE)
 
 
 def read_credential_file():
     try:
         with open(os.path.expanduser(CREDENTIAL_FILE), 'r',
                   encoding='utf-8') as f:
             return yaml.safe_load(f)
     except FileNotFoundError:
-        return False
+        return {}
 
 
 def get_api_key():
     return read_credential_file()['iam_api_key']
 
 
 def get_hmac_keys():
     cred_file = read_credential_file()
     return cred_file['access_key_id'], cred_file['secret_access_key']
 
 
-@import_package
 def _get_authenticator():
     return ibm_cloud_sdk_core.authenticators.IAMAuthenticator(get_api_key())
 
 
 def get_oauth_token():
     """returns a temporary authentication token required by
         various IBM cloud APIs
@@ -83,15 +62,14 @@
         headers={'Content-Type': 'application/x-www-form-urlencoded'},
         data=
         f'grant_type=urn:ibm:params:oauth:grant-type:apikey&apikey={get_api_key()}'
     )
     return json.loads(res.text)['access_token']
 
 
-@import_package
 def client(**kwargs):
     """Create an ibm vpc client.
 
     Sets the vpc client to a specific region.
     If none was specified 'us-south' is set internally.
 
     Args:
@@ -110,27 +88,24 @@
     except Exception:
         logger.error('No registered API key found matching specified value')
         raise
 
     return vpc_client  # returns either formerly or newly created client
 
 
-@import_package
 def search_client():
     return ibm_platform_services.GlobalSearchV2(
         authenticator=_get_authenticator())
 
 
-@import_package
 def tagging_client():
     return ibm_platform_services.GlobalTaggingV1(
         authenticator=_get_authenticator())
 
 
-@import_package
 def get_cos_client(region: str = 'us-east'):
     """Returns an IBM COS client object.
       Using process lock to protect not multi process
       safe Boto3.session, which is invoked (default session) by
       boto3.client.
 
     Args:
@@ -145,15 +120,14 @@
             service_name='s3',
             aws_access_key_id=access_key_id,
             aws_secret_access_key=secret_access_key,
             endpoint_url=
             f'https://s3.{region}.cloud-object-storage.appdomain.cloud')
 
 
-@import_package
 def get_cos_resource(region: str = 'us-east'):
     """Returns an IBM COS Resource object.
       Using process lock to protect not multi process safe
       boto3.Resource.
 
     Args:
         region (str, optional): Resource Endpoint. Defaults to 'us-east'.
```

### Comparing `skypilot-0.5.0/sky/adaptors/kubernetes.py` & `skypilot-0.6.0/sky/adaptors/kubernetes.py`

 * *Files 17% similar despite different names*

```diff
@@ -1,60 +1,37 @@
 """Kubernetes adaptors"""
 
 # pylint: disable=import-outside-toplevel
 
-import functools
 import os
 
+from sky.adaptors import common
 from sky.utils import env_options
 from sky.utils import ux_utils
 
-kubernetes = None
-urllib3 = None
+_IMPORT_ERROR_MESSAGE = ('Failed to import dependencies for Kubernetes. '
+                         'Try running: pip install "skypilot[kubernetes]"')
+kubernetes = common.LazyImport('kubernetes',
+                               import_error_message=_IMPORT_ERROR_MESSAGE)
+urllib3 = common.LazyImport('urllib3',
+                            import_error_message=_IMPORT_ERROR_MESSAGE)
 
 _configured = False
 _core_api = None
 _auth_api = None
 _networking_api = None
 _custom_objects_api = None
 _node_api = None
+_apps_api = None
+_api_client = None
 
 # Timeout to use for API calls
 API_TIMEOUT = 5
 
 
-def import_package(func):
-
-    @functools.wraps(func)
-    def wrapper(*args, **kwargs):
-        global kubernetes
-        global urllib3
-        if kubernetes is None:
-            try:
-                import kubernetes as _kubernetes
-                import urllib3 as _urllib3
-            except ImportError:
-                # TODO(romilb): Update this message to point to installation
-                #  docs when they are ready.
-                raise ImportError('Fail to import dependencies for Kubernetes. '
-                                  'Run `pip install kubernetes` to '
-                                  'install them.') from None
-            kubernetes = _kubernetes
-            urllib3 = _urllib3
-        return func(*args, **kwargs)
-
-    return wrapper
-
-
-@import_package
-def get_kubernetes():
-    return kubernetes
-
-
-@import_package
 def _load_config():
     global _configured
     if _configured:
         return
     try:
         # Load in-cluster config if running in a pod
         # Kubernetes set environment variables for service discovery do not
@@ -75,84 +52,93 @@
             if 'Expected key current-context' in str(e):
                 err_str = ('Failed to load Kubernetes configuration. '
                            'Kubeconfig does not contain any valid context(s).'
                            f'{suffix}\n'
                            '    If you were running a local Kubernetes '
                            'cluster, run `sky local up` to start the cluster.')
             else:
-                err_str = (
-                    'Failed to load Kubernetes configuration. '
-                    f'Please check if your kubeconfig file is valid.{suffix}')
+                err_str = ('Failed to load Kubernetes configuration. '
+                           'Please check if your kubeconfig file exists at '
+                           f'~/.kube/config and is valid.{suffix}')
             err_str += '\nTo disable Kubernetes for SkyPilot: run `sky check`.'
             with ux_utils.print_exception_no_traceback():
                 raise ValueError(err_str) from None
     _configured = True
 
 
-@import_package
 def core_api():
     global _core_api
     if _core_api is None:
         _load_config()
         _core_api = kubernetes.client.CoreV1Api()
 
     return _core_api
 
 
-@import_package
 def auth_api():
     global _auth_api
     if _auth_api is None:
         _load_config()
         _auth_api = kubernetes.client.RbacAuthorizationV1Api()
 
     return _auth_api
 
 
-@import_package
 def networking_api():
     global _networking_api
     if _networking_api is None:
         _load_config()
         _networking_api = kubernetes.client.NetworkingV1Api()
 
     return _networking_api
 
 
-@import_package
 def custom_objects_api():
     global _custom_objects_api
     if _custom_objects_api is None:
         _load_config()
         _custom_objects_api = kubernetes.client.CustomObjectsApi()
 
     return _custom_objects_api
 
 
-@import_package
 def node_api():
     global _node_api
     if _node_api is None:
         _load_config()
         _node_api = kubernetes.client.NodeV1Api()
 
     return _node_api
 
 
-@import_package
+def apps_api():
+    global _apps_api
+    if _apps_api is None:
+        _load_config()
+        _apps_api = kubernetes.client.AppsV1Api()
+
+    return _apps_api
+
+
+def api_client():
+    global _api_client
+    if _api_client is None:
+        _load_config()
+        _api_client = kubernetes.client.ApiClient()
+
+    return _api_client
+
+
 def api_exception():
     return kubernetes.client.rest.ApiException
 
 
-@import_package
 def config_exception():
     return kubernetes.config.config_exception.ConfigException
 
 
-@import_package
 def max_retry_error():
     return urllib3.exceptions.MaxRetryError
 
 
-@import_package
 def stream():
     return kubernetes.stream.stream
```

### Comparing `skypilot-0.5.0/sky/authentication.py` & `skypilot-0.6.0/sky/authentication.py`

 * *Files 4% similar despite different names*

```diff
@@ -11,15 +11,15 @@
    content, i.e., `configure_ssh_info`.
 2. Setup the `authorized_keys` on the remote VM with the public key content,
    by cloud-init or directly using cloud provider's API.
 
 The local machine's public key should not be uploaded to the
 `~/.ssh/sky-key.pub` on the remote VM, because it will cause private/public
 key pair mismatch when the user tries to launch new VM from that remote VM
-using SkyPilot, e.g., the node is used as a spot controller. (Lambda cloud
+using SkyPilot, e.g., the node is used as a jobs controller. (Lambda cloud
 is an exception, due to the limitation of the cloud provider. See the
 comments in setup_lambda_authentication)
 """
 import base64
 import copy
 import functools
 import os
@@ -30,14 +30,15 @@
 from typing import Any, Dict, Tuple
 import uuid
 
 import colorama
 from cryptography.hazmat.backends import default_backend
 from cryptography.hazmat.primitives import serialization
 from cryptography.hazmat.primitives.asymmetric import rsa
+import filelock
 import yaml
 
 from sky import clouds
 from sky import sky_logging
 from sky import skypilot_config
 from sky.adaptors import gcp
 from sky.adaptors import ibm
@@ -58,14 +59,15 @@
 # using Cloud Client Libraries for Python, where possible, for new code
 # development.
 
 MAX_TRIALS = 64
 # TODO(zhwu): Support user specified key pair.
 PRIVATE_SSH_KEY_PATH = '~/.ssh/sky-key'
 PUBLIC_SSH_KEY_PATH = '~/.ssh/sky-key.pub'
+_SSH_KEY_GENERATION_LOCK = '~/.sky/generated/ssh/.__internal-sky-key.lock'
 
 
 def _generate_rsa_key_pair() -> Tuple[str, str]:
     key = rsa.generate_private_key(backend=default_backend(),
                                    public_exponent=65537,
                                    key_size=2048)
 
@@ -80,16 +82,16 @@
         serialization.PublicFormat.OpenSSH).decode('utf-8').strip()
 
     return public_key, private_key
 
 
 def _save_key_pair(private_key_path: str, public_key_path: str,
                    private_key: str, public_key: str) -> None:
-    private_key_dir = os.path.dirname(private_key_path)
-    os.makedirs(private_key_dir, exist_ok=True)
+    key_dir = os.path.dirname(private_key_path)
+    os.makedirs(key_dir, exist_ok=True, mode=0o700)
 
     with open(
             private_key_path,
             'w',
             encoding='utf-8',
             opener=functools.partial(os.open, mode=0o600),
     ) as f:
@@ -102,25 +104,29 @@
         f.write(public_key)
 
 
 def get_or_generate_keys() -> Tuple[str, str]:
     """Returns the aboslute private and public key paths."""
     private_key_path = os.path.expanduser(PRIVATE_SSH_KEY_PATH)
     public_key_path = os.path.expanduser(PUBLIC_SSH_KEY_PATH)
-    if not os.path.exists(private_key_path):
-        public_key, private_key = _generate_rsa_key_pair()
-        _save_key_pair(private_key_path, public_key_path, private_key,
-                       public_key)
-    else:
-        # FIXME(skypilot): ran into failing this assert once, but forgot the
-        # reproduction (has private key; but has not generated public key).
-        #   AssertionError: /home/ubuntu/.ssh/sky-key.pub
-        assert os.path.exists(public_key_path), (
-            'Private key found, but associated public key '
-            f'{public_key_path} does not exist.')
+
+    key_file_lock = os.path.expanduser(_SSH_KEY_GENERATION_LOCK)
+    lock_dir = os.path.dirname(key_file_lock)
+    # We should have the folder ~/.sky/generated/ssh to have 0o700 permission,
+    # as the ssh configs will be written to this folder as well in
+    # backend_utils.SSHConfigHelper
+    os.makedirs(lock_dir, exist_ok=True, mode=0o700)
+    with filelock.FileLock(key_file_lock, timeout=10):
+        if not os.path.exists(private_key_path):
+            public_key, private_key = _generate_rsa_key_pair()
+            _save_key_pair(private_key_path, public_key_path, private_key,
+                           public_key)
+    assert os.path.exists(public_key_path), (
+        'Private key found, but associated public key '
+        f'{public_key_path} does not exist.')
     return private_key_path, public_key_path
 
 
 def configure_ssh_info(config: Dict[str, Any]) -> Dict[str, Any]:
     _, public_key_path = get_or_generate_keys()
     with open(public_key_path, 'r', encoding='utf-8') as f:
         public_key = f.read().strip()
@@ -398,25 +404,35 @@
             raise ValueError(str(e) + ' Please check: ~/.sky/config.yaml.') \
                 from None
     get_or_generate_keys()
 
     # Add the user's public key to the SkyPilot cluster.
     public_key_path = os.path.expanduser(PUBLIC_SSH_KEY_PATH)
     secret_name = clouds.Kubernetes.SKY_SSH_KEY_SECRET_NAME
-    secret_field_name = clouds.Kubernetes.SKY_SSH_KEY_SECRET_FIELD_NAME
+    secret_field_name = clouds.Kubernetes().ssh_key_secret_field_name
     namespace = kubernetes_utils.get_current_kube_config_context_namespace()
-    k8s = kubernetes.get_kubernetes()
+    k8s = kubernetes.kubernetes
     with open(public_key_path, 'r', encoding='utf-8') as f:
         public_key = f.read()
         if not public_key.endswith('\n'):
             public_key += '\n'
-        secret_metadata = k8s.client.V1ObjectMeta(name=secret_name,
-                                                  labels={'parent': 'skypilot'})
+
+        # Generate metadata
+        secret_metadata = {
+            'name': secret_name,
+            'labels': {
+                'parent': 'skypilot'
+            }
+        }
+        custom_metadata = skypilot_config.get_nested(
+            ('kubernetes', 'custom_metadata'), {})
+        kubernetes_utils.merge_dicts(custom_metadata, secret_metadata)
+
         secret = k8s.client.V1Secret(
-            metadata=secret_metadata,
+            metadata=k8s.client.V1ObjectMeta(**secret_metadata),
             string_data={secret_field_name: public_key})
     if kubernetes_utils.check_secret_exists(secret_name, namespace):
         logger.debug(f'Key {secret_name} exists in the cluster, patching it...')
         kubernetes.core_api().patch_namespaced_secret(secret_name, namespace,
                                                       secret)
     else:
         logger.debug(
@@ -456,15 +472,15 @@
     """Sets up SSH authentication for RunPod.
     - Generates a new SSH key pair if one does not exist.
     - Adds the public SSH key to the user's RunPod account.
     """
     _, public_key_path = get_or_generate_keys()
     with open(public_key_path, 'r', encoding='UTF-8') as pub_key_file:
         public_key = pub_key_file.read().strip()
-        runpod.runpod().cli.groups.ssh.functions.add_ssh_key(public_key)
+        runpod.runpod.cli.groups.ssh.functions.add_ssh_key(public_key)
 
     return configure_ssh_info(config)
 
 
 def setup_fluidstack_authentication(config: Dict[str, Any]) -> Dict[str, Any]:
 
     get_or_generate_keys()
```

### Comparing `skypilot-0.5.0/sky/backends/__init__.py` & `skypilot-0.6.0/sky/backends/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/backends/backend.py` & `skypilot-0.6.0/sky/backends/backend.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/backends/backend_utils.py` & `skypilot-0.6.0/sky/backends/backend_utils.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,7207 +1,7866 @@
 00000000: 2222 2255 7469 6c20 636f 6e73 7461 6e74  """Util constant
 00000010: 732f 6675 6e63 7469 6f6e 7320 666f 7220  s/functions for 
 00000020: 7468 6520 6261 636b 656e 6473 2e22 2222  the backends."""
 00000030: 0a66 726f 6d20 6461 7465 7469 6d65 2069  .from datetime i
 00000040: 6d70 6f72 7420 6461 7465 7469 6d65 0a69  mport datetime.i
 00000050: 6d70 6f72 7420 656e 756d 0a69 6d70 6f72  mport enum.impor
-00000060: 7420 6675 6e63 746f 6f6c 730a 696d 706f  t functools.impo
-00000070: 7274 206f 730a 696d 706f 7274 2070 6174  rt os.import pat
-00000080: 686c 6962 0a69 6d70 6f72 7420 7070 7269  hlib.import ppri
-00000090: 6e74 0a69 6d70 6f72 7420 7265 0a69 6d70  nt.import re.imp
-000000a0: 6f72 7420 7368 6c65 780a 696d 706f 7274  ort shlex.import
-000000b0: 2073 7562 7072 6f63 6573 730a 696d 706f   subprocess.impo
-000000c0: 7274 2074 656d 7066 696c 650a 696d 706f  rt tempfile.impo
-000000d0: 7274 2074 6578 7477 7261 700a 696d 706f  rt textwrap.impo
-000000e0: 7274 2074 696d 650a 696d 706f 7274 2074  rt time.import t
-000000f0: 7970 696e 670a 6672 6f6d 2074 7970 696e  yping.from typin
-00000100: 6720 696d 706f 7274 2041 6e79 2c20 4469  g import Any, Di
-00000110: 6374 2c20 4c69 7374 2c20 4f70 7469 6f6e  ct, List, Option
-00000120: 616c 2c20 5365 7175 656e 6365 2c20 5365  al, Sequence, Se
-00000130: 742c 2054 7570 6c65 2c20 556e 696f 6e0a  t, Tuple, Union.
-00000140: 696d 706f 7274 2075 7569 640a 0a69 6d70  import uuid..imp
-00000150: 6f72 7420 636f 6c6f 7261 6d61 0a69 6d70  ort colorama.imp
-00000160: 6f72 7420 6669 6c65 6c6f 636b 0a66 726f  ort filelock.fro
-00000170: 6d20 7061 636b 6167 696e 6720 696d 706f  m packaging impo
-00000180: 7274 2076 6572 7369 6f6e 0a69 6d70 6f72  rt version.impor
-00000190: 7420 7265 7175 6573 7473 0a66 726f 6d20  t requests.from 
-000001a0: 7265 7175 6573 7473 2069 6d70 6f72 7420  requests import 
-000001b0: 6164 6170 7465 7273 0a66 726f 6d20 7265  adapters.from re
-000001c0: 7175 6573 7473 2e70 6163 6b61 6765 732e  quests.packages.
-000001d0: 7572 6c6c 6962 332e 7574 696c 2069 6d70  urllib3.util imp
-000001e0: 6f72 7420 7265 7472 7920 6173 2072 6574  ort retry as ret
-000001f0: 7279 5f6c 6962 0a69 6d70 6f72 7420 7269  ry_lib.import ri
-00000200: 6368 2e70 726f 6772 6573 7320 6173 2072  ch.progress as r
-00000210: 6963 685f 7072 6f67 7265 7373 0a66 726f  ich_progress.fro
-00000220: 6d20 7479 7069 6e67 5f65 7874 656e 7369  m typing_extensi
-00000230: 6f6e 7320 696d 706f 7274 204c 6974 6572  ons import Liter
-00000240: 616c 0a69 6d70 6f72 7420 7961 6d6c 0a0a  al.import yaml..
-00000250: 696d 706f 7274 2073 6b79 0a66 726f 6d20  import sky.from 
-00000260: 736b 7920 696d 706f 7274 2061 7574 6865  sky import authe
-00000270: 6e74 6963 6174 696f 6e20 6173 2061 7574  ntication as aut
-00000280: 680a 6672 6f6d 2073 6b79 2069 6d70 6f72  h.from sky impor
-00000290: 7420 6261 636b 656e 6473 0a66 726f 6d20  t backends.from 
-000002a0: 736b 7920 696d 706f 7274 2063 6865 636b  sky import check
-000002b0: 2061 7320 736b 795f 6368 6563 6b0a 6672   as sky_check.fr
-000002c0: 6f6d 2073 6b79 2069 6d70 6f72 7420 636c  om sky import cl
-000002d0: 6f75 6473 0a66 726f 6d20 736b 7920 696d  ouds.from sky im
-000002e0: 706f 7274 2065 7863 6570 7469 6f6e 730a  port exceptions.
-000002f0: 6672 6f6d 2073 6b79 2069 6d70 6f72 7420  from sky import 
-00000300: 676c 6f62 616c 5f75 7365 725f 7374 6174  global_user_stat
-00000310: 650a 6672 6f6d 2073 6b79 2069 6d70 6f72  e.from sky impor
-00000320: 7420 7072 6f76 6973 696f 6e20 6173 2070  t provision as p
-00000330: 726f 7669 7369 6f6e 5f6c 6962 0a66 726f  rovision_lib.fro
-00000340: 6d20 736b 7920 696d 706f 7274 2073 6b79  m sky import sky
-00000350: 5f6c 6f67 6769 6e67 0a66 726f 6d20 736b  _logging.from sk
-00000360: 7920 696d 706f 7274 2073 6b79 7069 6c6f  y import skypilo
-00000370: 745f 636f 6e66 6967 0a66 726f 6d20 736b  t_config.from sk
-00000380: 7920 696d 706f 7274 2073 7461 7475 735f  y import status_
-00000390: 6c69 620a 6672 6f6d 2073 6b79 2e63 6c6f  lib.from sky.clo
-000003a0: 7564 7320 696d 706f 7274 2063 6c6f 7564  uds import cloud
-000003b0: 5f72 6567 6973 7472 790a 6672 6f6d 2073  _registry.from s
-000003c0: 6b79 2e70 726f 7669 7369 6f6e 2069 6d70  ky.provision imp
-000003d0: 6f72 7420 696e 7374 616e 6365 5f73 6574  ort instance_set
-000003e0: 7570 0a66 726f 6d20 736b 792e 7072 6f76  up.from sky.prov
-000003f0: 6973 696f 6e2e 6b75 6265 726e 6574 6573  ision.kubernetes
-00000400: 2069 6d70 6f72 7420 7574 696c 7320 6173   import utils as
-00000410: 206b 7562 6572 6e65 7465 735f 7574 696c   kubernetes_util
-00000420: 730a 6672 6f6d 2073 6b79 2e73 6b79 6c65  s.from sky.skyle
-00000430: 7420 696d 706f 7274 2063 6f6e 7374 616e  t import constan
-00000440: 7473 0a66 726f 6d20 736b 792e 7573 6167  ts.from sky.usag
-00000450: 6520 696d 706f 7274 2075 7361 6765 5f6c  e import usage_l
-00000460: 6962 0a66 726f 6d20 736b 792e 7574 696c  ib.from sky.util
-00000470: 7320 696d 706f 7274 2063 6c75 7374 6572  s import cluster
-00000480: 5f79 616d 6c5f 7574 696c 730a 6672 6f6d  _yaml_utils.from
-00000490: 2073 6b79 2e75 7469 6c73 2069 6d70 6f72   sky.utils impor
-000004a0: 7420 636f 6d6d 616e 645f 7275 6e6e 6572  t command_runner
-000004b0: 0a66 726f 6d20 736b 792e 7574 696c 7320  .from sky.utils 
-000004c0: 696d 706f 7274 2063 6f6d 6d6f 6e5f 7574  import common_ut
-000004d0: 696c 730a 6672 6f6d 2073 6b79 2e75 7469  ils.from sky.uti
-000004e0: 6c73 2069 6d70 6f72 7420 636f 6e74 726f  ls import contro
-000004f0: 6c6c 6572 5f75 7469 6c73 0a66 726f 6d20  ller_utils.from 
-00000500: 736b 792e 7574 696c 7320 696d 706f 7274  sky.utils import
-00000510: 2065 6e76 5f6f 7074 696f 6e73 0a66 726f   env_options.fro
-00000520: 6d20 736b 792e 7574 696c 7320 696d 706f  m sky.utils impo
-00000530: 7274 2072 6963 685f 7574 696c 730a 6672  rt rich_utils.fr
-00000540: 6f6d 2073 6b79 2e75 7469 6c73 2069 6d70  om sky.utils imp
-00000550: 6f72 7420 7375 6270 726f 6365 7373 5f75  ort subprocess_u
-00000560: 7469 6c73 0a66 726f 6d20 736b 792e 7574  tils.from sky.ut
-00000570: 696c 7320 696d 706f 7274 2074 696d 656c  ils import timel
-00000580: 696e 650a 6672 6f6d 2073 6b79 2e75 7469  ine.from sky.uti
-00000590: 6c73 2069 6d70 6f72 7420 7578 5f75 7469  ls import ux_uti
-000005a0: 6c73 0a0a 6966 2074 7970 696e 672e 5459  ls..if typing.TY
-000005b0: 5045 5f43 4845 434b 494e 473a 0a20 2020  PE_CHECKING:.   
-000005c0: 2066 726f 6d20 736b 7920 696d 706f 7274   from sky import
-000005d0: 2072 6573 6f75 7263 6573 0a20 2020 2066   resources.    f
-000005e0: 726f 6d20 736b 7920 696d 706f 7274 2074  rom sky import t
-000005f0: 6173 6b20 6173 2074 6173 6b5f 6c69 620a  ask as task_lib.
-00000600: 2020 2020 6672 6f6d 2073 6b79 2e62 6163      from sky.bac
-00000610: 6b65 6e64 7320 696d 706f 7274 2063 6c6f  kends import clo
-00000620: 7564 5f76 6d5f 7261 795f 6261 636b 656e  ud_vm_ray_backen
-00000630: 640a 2020 2020 6672 6f6d 2073 6b79 2e62  d.    from sky.b
-00000640: 6163 6b65 6e64 7320 696d 706f 7274 206c  ackends import l
-00000650: 6f63 616c 5f64 6f63 6b65 725f 6261 636b  ocal_docker_back
-00000660: 656e 640a 0a6c 6f67 6765 7220 3d20 736b  end..logger = sk
-00000670: 795f 6c6f 6767 696e 672e 696e 6974 5f6c  y_logging.init_l
-00000680: 6f67 6765 7228 5f5f 6e61 6d65 5f5f 290a  ogger(__name__).
-00000690: 0a23 204e 4f54 453a 206b 6565 7020 696e  .# NOTE: keep in
-000006a0: 2073 796e 6320 7769 7468 2074 6865 2063   sync with the c
-000006b0: 6c75 7374 6572 2074 656d 706c 6174 6520  luster template 
-000006c0: 2766 696c 655f 6d6f 756e 7473 272e 0a53  'file_mounts'..S
-000006d0: 4b59 5f52 454d 4f54 455f 4150 505f 4449  KY_REMOTE_APP_DI
-000006e0: 5220 3d20 277e 2f2e 736b 792f 736b 795f  R = '~/.sky/sky_
-000006f0: 6170 7027 0a23 2045 7863 6c75 6465 2073  app'.# Exclude s
-00000700: 7562 6e65 7420 6d61 736b 2066 726f 6d20  ubnet mask from 
-00000710: 4950 2061 6464 7265 7373 2072 6567 6578  IP address regex
-00000720: 2e0a 4950 5f41 4444 525f 5245 4745 5820  ..IP_ADDR_REGEX 
-00000730: 3d20 7227 5c62 5c64 7b31 2c33 7d5c 2e5c  = r'\b\d{1,3}\.\
-00000740: 647b 312c 337d 5c2e 5c64 7b31 2c33 7d5c  d{1,3}\.\d{1,3}\
-00000750: 2e5c 647b 312c 337d 283f 212f 5c64 7b31  .\d{1,3}(?!/\d{1
-00000760: 2c32 7d29 5c62 270a 534b 595f 5245 4d4f  ,2})\b'.SKY_REMO
-00000770: 5445 5f50 4154 4820 3d20 277e 2f2e 736b  TE_PATH = '~/.sk
-00000780: 792f 7768 6565 6c73 270a 534b 595f 5553  y/wheels'.SKY_US
-00000790: 4552 5f46 494c 455f 5041 5448 203d 2027  ER_FILE_PATH = '
-000007a0: 7e2f 2e73 6b79 2f67 656e 6572 6174 6564  ~/.sky/generated
-000007b0: 270a 0a42 4f4c 4420 3d20 275c 3033 335b  '..BOLD = '\033[
-000007c0: 316d 270a 5245 5345 545f 424f 4c44 203d  1m'.RESET_BOLD =
-000007d0: 2027 5c30 3333 5b30 6d27 0a0a 2320 446f   '\033[0m'..# Do
-000007e0: 206e 6f74 2075 7365 202f 746d 7020 6265   not use /tmp be
-000007f0: 6361 7573 6520 6974 2067 6574 7320 636c  cause it gets cl
-00000800: 6561 7265 6420 6f6e 2056 4d20 7265 7374  eared on VM rest
-00000810: 6172 742e 0a5f 534b 595f 5245 4d4f 5445  art.._SKY_REMOTE
-00000820: 5f46 494c 455f 4d4f 554e 5453 5f44 4952  _FILE_MOUNTS_DIR
-00000830: 203d 2027 7e2f 2e73 6b79 2f66 696c 655f   = '~/.sky/file_
-00000840: 6d6f 756e 7473 2f27 0a0a 5f4c 4155 4e43  mounts/'.._LAUNC
-00000850: 4845 445f 4845 4144 5f50 4154 5445 524e  HED_HEAD_PATTERN
-00000860: 203d 2072 652e 636f 6d70 696c 6528 7227   = re.compile(r'
-00000870: 285c 642b 2920 7261 795b 2e5f 5d68 6561  (\d+) ray[._]hea
-00000880: 645b 2e5f 5d64 6566 6175 6c74 2729 0a5f  d[._]default')._
-00000890: 4c41 554e 4348 4544 5f4c 4f43 414c 5f57  LAUNCHED_LOCAL_W
-000008a0: 4f52 4b45 525f 5041 5454 4552 4e20 3d20  ORKER_PATTERN = 
-000008b0: 7265 2e63 6f6d 7069 6c65 2872 2728 5c64  re.compile(r'(\d
-000008c0: 2b29 206e 6f64 655f 2729 0a5f 4c41 554e  +) node_')._LAUN
-000008d0: 4348 4544 5f57 4f52 4b45 525f 5041 5454  CHED_WORKER_PATT
-000008e0: 4552 4e20 3d20 7265 2e63 6f6d 7069 6c65  ERN = re.compile
-000008f0: 2872 2728 5c64 2b29 2072 6179 5b2e 5f5d  (r'(\d+) ray[._]
-00000900: 776f 726b 6572 5b2e 5f5d 6465 6661 756c  worker[._]defaul
-00000910: 7427 290a 5f4c 4155 4e43 4845 445f 5245  t')._LAUNCHED_RE
-00000920: 5345 5256 4544 5f57 4f52 4b45 525f 5041  SERVED_WORKER_PA
-00000930: 5454 4552 4e20 3d20 7265 2e63 6f6d 7069  TTERN = re.compi
-00000940: 6c65 280a 2020 2020 7227 285c 642b 2920  le(.    r'(\d+) 
-00000950: 7261 795b 2e5f 5d77 6f72 6b65 725b 2e5f  ray[._]worker[._
-00000960: 5d72 6573 6572 7665 6427 290a 2320 496e  ]reserved').# In
-00000970: 7465 6e74 696f 6e61 6c6c 7920 6e6f 7420  tentionally not 
-00000980: 7573 696e 6720 7072 6566 6978 2027 7266  using prefix 'rf
-00000990: 2720 666f 7220 7468 6520 7374 7269 6e67  ' for the string
-000009a0: 2066 6f72 6d61 7420 6265 6361 7573 6520   format because 
-000009b0: 7961 7066 2068 6176 6520 610a 2320 6275  yapf have a.# bu
-000009c0: 6720 7769 7468 2070 7974 686f 6e3d 332e  g with python=3.
-000009d0: 362e 0a23 2031 302e 3133 332e 302e 353a  6..# 10.133.0.5:
-000009e0: 2072 6179 2e77 6f72 6b65 722e 6465 6661   ray.worker.defa
-000009f0: 756c 742c 0a5f 4c41 554e 4348 494e 475f  ult,._LAUNCHING_
-00000a00: 4950 5f50 4154 5445 524e 203d 2072 652e  IP_PATTERN = re.
-00000a10: 636f 6d70 696c 6528 0a20 2020 2072 2728  compile(.    r'(
-00000a20: 7b7d 293a 2072 6179 5b2e 5f5d 776f 726b  {}): ray[._]work
-00000a30: 6572 5b2e 5f5d 283f 3a64 6566 6175 6c74  er[._](?:default
-00000a40: 7c72 6573 6572 7665 6429 272e 666f 726d  |reserved)'.form
-00000a50: 6174 2849 505f 4144 4452 5f52 4547 4558  at(IP_ADDR_REGEX
-00000a60: 2929 0a57 4149 545f 4845 4144 5f4e 4f44  )).WAIT_HEAD_NOD
-00000a70: 455f 4950 5f4d 4158 5f41 5454 454d 5054  E_IP_MAX_ATTEMPT
-00000a80: 5320 3d20 330a 0a23 2057 6520 6368 6563  S = 3..# We chec
-00000a90: 6b20 6e65 7477 6f72 6b20 636f 6e6e 6563  k network connec
-00000aa0: 7469 6f6e 2062 7920 676f 696e 6720 7468  tion by going th
-00000ab0: 726f 7567 6820 5f54 4553 545f 4950 5f4c  rough _TEST_IP_L
-00000ac0: 4953 542e 2057 6520 6d61 7920 6e65 6564  IST. We may need
-00000ad0: 2074 6f0a 2320 6368 6563 6b20 6d75 6c74   to.# check mult
-00000ae0: 6970 6c65 2049 5073 2062 6563 6175 7365  iple IPs because
-00000af0: 2073 6f6d 6520 4950 7320 6d61 7920 6265   some IPs may be
-00000b00: 2062 6c6f 636b 6564 206f 6e20 6365 7274   blocked on cert
-00000b10: 6169 6e20 6e65 7477 6f72 6b73 2e0a 2320  ain networks..# 
-00000b20: 4669 7865 6420 4950 2061 6464 7265 7373  Fixed IP address
-00000b30: 6573 2061 7265 2075 7365 6420 746f 2061  es are used to a
-00000b40: 766f 6964 2044 4e53 206c 6f6f 6b75 7020  void DNS lookup 
-00000b50: 626c 6f63 6b69 6e67 2074 6865 2063 6865  blocking the che
-00000b60: 636b 2c20 666f 720a 2320 6d61 6368 696e  ck, for.# machin
-00000b70: 6520 7769 7468 206e 6f20 696e 7465 726e  e with no intern
-00000b80: 6574 2063 6f6e 6e65 6374 696f 6e2e 0a23  et connection..#
-00000b90: 2052 6566 6572 2074 6f3a 2068 7474 7073   Refer to: https
-00000ba0: 3a2f 2f73 7461 636b 6f76 6572 666c 6f77  ://stackoverflow
-00000bb0: 2e63 6f6d 2f71 7565 7374 696f 6e73 2f33  .com/questions/3
-00000bc0: 3736 3432 3931 2f68 6f77 2d63 616e 2d69  764291/how-can-i
-00000bd0: 2d73 6565 2d69 662d 7468 6572 6573 2d61  -see-if-theres-a
-00000be0: 6e2d 6176 6169 6c61 626c 652d 616e 642d  n-available-and-
-00000bf0: 6163 7469 7665 2d6e 6574 776f 726b 2d63  active-network-c
-00000c00: 6f6e 6e65 6374 696f 6e2d 696e 2d70 7974  onnection-in-pyt
-00000c10: 686f 6e20 2320 7079 6c69 6e74 3a20 6469  hon # pylint: di
-00000c20: 7361 626c 653d 6c69 6e65 2d74 6f6f 2d6c  sable=line-too-l
-00000c30: 6f6e 670a 5f54 4553 545f 4950 5f4c 4953  ong._TEST_IP_LIS
-00000c40: 5420 3d20 5b27 6874 7470 733a 2f2f 312e  T = ['https://1.
-00000c50: 312e 312e 3127 2c20 2768 7474 7073 3a2f  1.1.1', 'https:/
-00000c60: 2f38 2e38 2e38 2e38 275d 0a0a 2320 416c  /8.8.8.8']..# Al
-00000c70: 6c6f 7720 6561 6368 2043 5055 2074 6872  low each CPU thr
-00000c80: 6561 6420 7461 6b65 2032 2074 6173 6b73  ead take 2 tasks
-00000c90: 2e0a 2320 4e6f 7465 3a20 5468 6973 2076  ..# Note: This v
-00000ca0: 616c 7565 2063 616e 6e6f 7420 6265 2074  alue cannot be t
-00000cb0: 6f6f 2073 6d61 6c6c 2c20 6f74 6865 7277  oo small, otherw
-00000cc0: 6973 6520 4f4f 4d20 6973 7375 6520 6d61  ise OOM issue ma
-00000cd0: 7920 6f63 6375 722e 0a44 4546 4155 4c54  y occur..DEFAULT
-00000ce0: 5f54 4153 4b5f 4350 555f 4445 4d41 4e44  _TASK_CPU_DEMAND
-00000cf0: 203d 2030 2e35 0a0a 2320 4669 6c65 6c6f   = 0.5..# Filelo
-00000d00: 636b 7320 666f 7220 7468 6520 636c 7573  cks for the clus
-00000d10: 7465 7220 7374 6174 7573 2063 6861 6e67  ter status chang
-00000d20: 652e 0a43 4c55 5354 4552 5f53 5441 5455  e..CLUSTER_STATU
-00000d30: 535f 4c4f 434b 5f50 4154 4820 3d20 6f73  S_LOCK_PATH = os
-00000d40: 2e70 6174 682e 6578 7061 6e64 7573 6572  .path.expanduser
-00000d50: 2827 7e2f 2e73 6b79 2f2e 7b7d 2e6c 6f63  ('~/.sky/.{}.loc
-00000d60: 6b27 290a 434c 5553 5445 525f 5354 4154  k').CLUSTER_STAT
-00000d70: 5553 5f4c 4f43 4b5f 5449 4d45 4f55 545f  US_LOCK_TIMEOUT_
-00000d80: 5345 434f 4e44 5320 3d20 3230 0a0a 2320  SECONDS = 20..# 
-00000d90: 4669 6c65 6c6f 636b 7320 666f 7220 7570  Filelocks for up
-00000da0: 6461 7469 6e67 2063 6c75 7374 6572 2773  dating cluster's
-00000db0: 2066 696c 655f 6d6f 756e 7473 2e0a 434c   file_mounts..CL
-00000dc0: 5553 5445 525f 4649 4c45 5f4d 4f55 4e54  USTER_FILE_MOUNT
-00000dd0: 535f 4c4f 434b 5f50 4154 4820 3d20 6f73  S_LOCK_PATH = os
-00000de0: 2e70 6174 682e 6578 7061 6e64 7573 6572  .path.expanduser
-00000df0: 280a 2020 2020 277e 2f2e 736b 792f 2e7b  (.    '~/.sky/.{
-00000e00: 7d5f 6669 6c65 5f6d 6f75 6e74 732e 6c6f  }_file_mounts.lo
-00000e10: 636b 2729 0a43 4c55 5354 4552 5f46 494c  ck').CLUSTER_FIL
-00000e20: 455f 4d4f 554e 5453 5f4c 4f43 4b5f 5449  E_MOUNTS_LOCK_TI
-00000e30: 4d45 4f55 545f 5345 434f 4e44 5320 3d20  MEOUT_SECONDS = 
-00000e40: 3130 0a0a 2320 5265 6d6f 7465 2064 6972  10..# Remote dir
-00000e50: 2074 6861 7420 686f 6c64 7320 6f75 7220   that holds our 
-00000e60: 7275 6e74 696d 6520 6669 6c65 732e 0a5f  runtime files.._
-00000e70: 5245 4d4f 5445 5f52 554e 5449 4d45 5f46  REMOTE_RUNTIME_F
-00000e80: 494c 4553 5f44 4952 203d 2027 7e2f 2e73  ILES_DIR = '~/.s
-00000e90: 6b79 2f2e 7275 6e74 696d 655f 6669 6c65  ky/.runtime_file
-00000ea0: 7327 0a0a 2320 496e 636c 7564 6520 7468  s'..# Include th
-00000eb0: 6520 6669 656c 6473 2074 6861 7420 7769  e fields that wi
-00000ec0: 6c6c 2062 6520 7573 6564 2066 6f72 2067  ll be used for g
-00000ed0: 656e 6572 6174 696e 6720 7461 6773 2074  enerating tags t
-00000ee0: 6861 7420 6469 7374 696e 6775 6973 6865  hat distinguishe
-00000ef0: 730a 2320 7468 6520 636c 7573 7465 7220  s.# the cluster 
-00000f00: 696e 2072 6179 2c20 746f 2061 766f 6964  in ray, to avoid
-00000f10: 2074 6865 2073 746f 7070 6564 2063 6c75   the stopped clu
-00000f20: 7374 6572 2062 6569 6e67 2064 6973 6361  ster being disca
-00000f30: 7264 6564 2064 7565 2074 6f0a 2320 7570  rded due to.# up
-00000f40: 6461 7465 7320 696e 2074 6865 2079 616d  dates in the yam
-00000f50: 6c20 7465 6d70 6c61 7465 2e0a 2320 536f  l template..# So
-00000f60: 6d65 206e 6f74 6573 206f 6e20 7468 6520  me notes on the 
-00000f70: 6669 656c 6473 3a0a 2320 2d20 2770 726f  fields:.# - 'pro
-00000f80: 7669 6465 7227 2066 6965 6c64 7320 7769  vider' fields wi
-00000f90: 6c6c 2062 6520 7573 6564 2066 6f72 2062  ll be used for b
-00000fa0: 6f6f 7473 7472 6170 7069 6e67 2061 6e64  ootstrapping and
-00000fb0: 2069 6e73 6572 7420 6d6f 7265 206e 6577   insert more new
-00000fc0: 2069 7465 6d73 0a23 2020 2069 6e20 276e   items.#   in 'n
-00000fd0: 6f64 655f 636f 6e66 6967 272e 0a23 202d  ode_config'..# -
-00000fe0: 206b 6565 7069 6e67 2074 6865 2061 7574   keeping the aut
-00000ff0: 6820 6973 206e 6f74 2065 6e6f 7567 6820  h is not enough 
-00001000: 6265 6375 6173 6520 7468 6520 636f 6e74  becuase the cont
-00001010: 656e 7420 6f66 2074 6865 206b 6579 2066  ent of the key f
-00001020: 696c 6520 7769 6c6c 2062 650a 2320 2020  ile will be.#   
-00001030: 7573 6564 2066 6f72 2063 616c 6375 6c61  used for calcula
-00001040: 7469 6e67 2074 6865 2068 6173 682e 0a23  ting the hash..#
-00001050: 2054 4f44 4f28 7a68 7775 293a 204b 6565   TODO(zhwu): Kee
-00001060: 7020 696e 2073 796e 6320 7769 7468 2074  p in sync with t
-00001070: 6865 2066 6965 6c64 7320 7573 6564 2069  he fields used i
-00001080: 6e20 6874 7470 733a 2f2f 6769 7468 7562  n https://github
-00001090: 2e63 6f6d 2f72 6179 2d70 726f 6a65 6374  .com/ray-project
-000010a0: 2f72 6179 2f62 6c6f 622f 6534 6365 3338  /ray/blob/e4ce38
-000010b0: 6430 3031 6462 6265 3039 6364 3231 6334  d001dbbe09cd21c4
-000010c0: 3937 6665 6464 3033 6436 3932 6232 6265  97fedd03d692b2be
-000010d0: 3365 2f70 7974 686f 6e2f 7261 792f 6175  3e/python/ray/au
-000010e0: 746f 7363 616c 6572 2f5f 7072 6976 6174  toscaler/_privat
-000010f0: 652f 636f 6d6d 616e 6473 2e70 7923 4c36  e/commands.py#L6
-00001100: 3837 2d4c 3730 310a 5f52 4159 5f59 414d  87-L701._RAY_YAM
-00001110: 4c5f 4b45 5953 5f54 4f5f 5245 5354 4f52  L_KEYS_TO_RESTOR
-00001120: 455f 464f 525f 4241 434b 5f43 4f4d 5041  E_FOR_BACK_COMPA
-00001130: 5449 4249 4c49 5459 203d 207b 0a20 2020  TIBILITY = {.   
-00001140: 2027 636c 7573 7465 725f 6e61 6d65 272c   'cluster_name',
-00001150: 2027 7072 6f76 6964 6572 272c 2027 6175   'provider', 'au
-00001160: 7468 272c 2027 6e6f 6465 5f63 6f6e 6669  th', 'node_confi
-00001170: 6727 2c20 2764 6f63 6b65 7227 0a7d 0a23  g', 'docker'.}.#
-00001180: 2046 6f72 2074 6865 7365 206b 6579 732c   For these keys,
-00001190: 2064 6f6e 2774 2075 7365 2074 6865 206f   don't use the o
-000011a0: 6c64 2079 616d 6c27 7320 7665 7273 696f  ld yaml's versio
-000011b0: 6e20 616e 6420 696e 7374 6561 6420 7573  n and instead us
-000011c0: 6520 7468 6520 6e65 7720 7961 6d6c 2773  e the new yaml's
-000011d0: 2e0a 2320 202d 207a 6f6e 653a 2054 6865  ..#  - zone: The
-000011e0: 207a 6f6e 6520 6669 656c 6420 6f66 2074   zone field of t
-000011f0: 6865 206f 6c64 2079 616d 6c20 6d61 7920  he old yaml may 
-00001200: 6265 2027 3161 2c31 622c 3163 2720 2841  be '1a,1b,1c' (A
-00001210: 5753 2920 7768 696c 6520 7468 6520 6163  WS) while the ac
-00001220: 7475 616c 0a23 2020 2020 7a6f 6e65 206f  tual.#    zone o
-00001230: 6620 7468 6520 6c61 756e 6368 6564 2063  f the launched c
-00001240: 6c75 7374 6572 2069 7320 2731 6127 2e20  luster is '1a'. 
-00001250: 4966 2077 6520 7265 7374 6f72 652c 2074  If we restore, t
-00001260: 6865 6e20 6f6e 2063 6170 6163 6974 7920  hen on capacity 
-00001270: 6572 726f 7273 0a23 2020 2020 6974 2773  errors.#    it's
-00001280: 2070 6f73 7369 626c 6520 746f 2066 6169   possible to fai
-00001290: 6c6f 7665 7220 746f 2031 622c 2077 6869  lover to 1b, whi
-000012a0: 6368 206c 6561 7665 7320 6120 6c65 616b  ch leaves a leak
-000012b0: 6564 2069 6e73 7461 6e63 6520 696e 2031  ed instance in 1
-000012c0: 612e 2048 6572 652c 0a23 2020 2020 7765  a. Here,.#    we
-000012d0: 2075 7365 2074 6865 206e 6577 2079 616d   use the new yam
-000012e0: 6c27 7320 7a6f 6e65 2066 6965 6c64 2c20  l's zone field, 
-000012f0: 7768 6963 6820 6973 2067 7561 7261 6e74  which is guarant
-00001300: 6565 6420 746f 2062 6520 7468 6520 6578  eed to be the ex
-00001310: 6973 7469 6e67 207a 6f6e 650a 2320 2020  isting zone.#   
-00001320: 2027 3161 272e 0a23 202d 2064 6f63 6b65   '1a'..# - docke
-00001330: 725f 6c6f 6769 6e5f 636f 6e66 6967 3a20  r_login_config: 
-00001340: 5468 6520 646f 636b 6572 5f6c 6f67 696e  The docker_login
-00001350: 5f63 6f6e 6669 6720 6669 656c 6420 6f66  _config field of
-00001360: 2074 6865 206f 6c64 2079 616d 6c20 6d61   the old yaml ma
-00001370: 7920 6265 0a23 2020 206f 7574 6461 7465  y be.#   outdate
-00001380: 6420 6f72 2077 726f 6e67 2e20 5573 6572  d or wrong. User
-00001390: 7320 6d61 7920 7761 6e74 2074 6f20 6669  s may want to fi
-000013a0: 7820 7468 6520 6c6f 6769 6e20 636f 6e66  x the login conf
-000013b0: 6967 2069 6620 6120 636c 7573 7465 7220  ig if a cluster 
-000013c0: 6661 696c 730a 2320 2020 746f 206c 6175  fails.#   to lau
-000013d0: 6e63 6820 6475 6520 746f 2074 6865 206c  nch due to the l
-000013e0: 6f67 696e 2063 6f6e 6669 672e 0a23 202d  ogin config..# -
-000013f0: 2055 7365 7244 6174 613a 2054 6865 2055   UserData: The U
-00001400: 7365 7244 6174 6120 6669 656c 6420 6f66  serData field of
-00001410: 2074 6865 206f 6c64 2079 616d 6c20 6d61   the old yaml ma
-00001420: 7920 6265 206f 7574 6461 7465 642c 2061  y be outdated, a
-00001430: 6e64 2077 6520 7761 6e74 2074 6f0a 2320  nd we want to.# 
-00001440: 2020 7573 6520 7468 6520 6e65 7720 7961    use the new ya
-00001450: 6d6c 2773 2055 7365 7244 6174 6120 6669  ml's UserData fi
-00001460: 656c 642c 2077 6869 6368 2063 6f6e 7461  eld, which conta
-00001470: 696e 7320 7468 6520 6175 7468 6f72 697a  ins the authoriz
-00001480: 6564 206b 6579 2073 6574 7570 2061 730a  ed key setup as.
-00001490: 2320 2020 7765 6c6c 2061 7320 7468 6520  #   well as the 
-000014a0: 6469 7361 626c 696e 6720 6f66 2074 6865  disabling of the
-000014b0: 2061 7574 6f2d 7570 6461 7465 2077 6974   auto-update wit
-000014c0: 6820 6170 742d 6765 742e 0a23 202d 2066  h apt-get..# - f
-000014d0: 6972 6577 616c 6c5f 7275 6c65 3a20 5468  irewall_rule: Th
-000014e0: 6973 2069 7320 6120 6e65 776c 7920 6164  is is a newly ad
-000014f0: 6465 6420 7365 6374 696f 6e20 666f 7220  ded section for 
-00001500: 6763 7020 696e 2070 726f 7669 6465 7220  gcp in provider 
-00001510: 7365 6374 696f 6e2e 0a23 202d 2073 6563  section..# - sec
-00001520: 7572 6974 795f 6772 6f75 703a 2049 6e20  urity_group: In 
-00001530: 2332 3438 3520 7765 2069 6e74 726f 6475  #2485 we introdu
-00001540: 6365 7320 7468 6520 6368 616e 6765 6420  ces the changed 
-00001550: 6f66 2073 6563 7572 6974 7920 6772 6f75  of security grou
-00001560: 702c 2073 6f20 7765 0a23 2020 2073 686f  p, so we.#   sho
-00001570: 756c 6420 7461 6b65 2074 6865 206c 6174  uld take the lat
-00001580: 6573 7420 7365 6375 7269 7479 2067 726f  est security gro
-00001590: 7570 206e 616d 652e 0a5f 5241 595f 5941  up name.._RAY_YA
-000015a0: 4d4c 5f4b 4559 535f 544f 5f52 4553 544f  ML_KEYS_TO_RESTO
-000015b0: 5245 5f45 5843 4550 5449 4f4e 5320 3d20  RE_EXCEPTIONS = 
-000015c0: 5b0a 2020 2020 2827 7072 6f76 6964 6572  [.    ('provider
-000015d0: 272c 2027 6176 6169 6c61 6269 6c69 7479  ', 'availability
-000015e0: 5f7a 6f6e 6527 292c 0a20 2020 2023 2043  _zone'),.    # C
-000015f0: 6c6f 7564 7320 7769 7468 206e 6577 2070  louds with new p
-00001600: 726f 7669 7369 6f6e 6572 2068 6173 2064  rovisioner has d
-00001610: 6f63 6b65 725f 6c6f 6769 6e5f 636f 6e66  ocker_login_conf
-00001620: 6967 2069 6e20 7468 650a 2020 2020 2320  ig in the.    # 
-00001630: 646f 636b 6572 2066 6965 6c64 2c20 696e  docker field, in
-00001640: 7374 6561 6420 6f66 2074 6865 2070 726f  stead of the pro
-00001650: 7669 6465 7220 6669 656c 642e 0a20 2020  vider field..   
-00001660: 2028 2764 6f63 6b65 7227 2c20 2764 6f63   ('docker', 'doc
-00001670: 6b65 725f 6c6f 6769 6e5f 636f 6e66 6967  ker_login_config
-00001680: 2729 2c0a 2020 2020 2320 4f74 6865 7220  '),.    # Other 
-00001690: 636c 6f75 6473 0a20 2020 2028 2770 726f  clouds.    ('pro
-000016a0: 7669 6465 7227 2c20 2764 6f63 6b65 725f  vider', 'docker_
-000016b0: 6c6f 6769 6e5f 636f 6e66 6967 2729 2c0a  login_config'),.
-000016c0: 2020 2020 2827 7072 6f76 6964 6572 272c      ('provider',
-000016d0: 2027 6669 7265 7761 6c6c 5f72 756c 6527   'firewall_rule'
-000016e0: 292c 0a20 2020 2023 2054 5055 206e 6f64  ),.    # TPU nod
-000016f0: 6520 6c61 756e 6368 6564 2062 6566 6f72  e launched befor
-00001700: 6520 2332 3934 3320 646f 6573 206e 6f74  e #2943 does not
-00001710: 2068 6176 6520 7468 6520 6070 726f 7669   have the `provi
-00001720: 6465 722e 7470 755f 6e6f 6465 6020 7365  der.tpu_node` se
-00001730: 742c 0a20 2020 2023 2061 6e64 206f 7572  t,.    # and our
-00001740: 206c 6174 6573 7420 636f 6465 206e 6565   latest code nee
-00001750: 6420 7468 6973 2066 6965 6c64 2074 6f20  d this field to 
-00001760: 6265 2073 6574 2074 6f20 6469 7374 696e  be set to distin
-00001770: 6775 6973 6820 7468 6520 6e6f 6465 2c20  guish the node, 
-00001780: 736f 0a20 2020 2023 2077 6520 6e65 6564  so.    # we need
-00001790: 2074 6f20 7461 6b65 2074 6869 7320 6669   to take this fi
-000017a0: 656c 6420 6672 6f6d 2074 6865 206e 6577  eld from the new
-000017b0: 2079 616d 6c2e 0a20 2020 2028 2770 726f   yaml..    ('pro
-000017c0: 7669 6465 7227 2c20 2774 7075 5f6e 6f64  vider', 'tpu_nod
-000017d0: 6527 292c 0a20 2020 2028 2770 726f 7669  e'),.    ('provi
-000017e0: 6465 7227 2c20 2773 6563 7572 6974 795f  der', 'security_
-000017f0: 6772 6f75 7027 2c20 2747 726f 7570 4e61  group', 'GroupNa
-00001800: 6d65 2729 2c0a 2020 2020 2827 6176 6169  me'),.    ('avai
-00001810: 6c61 626c 655f 6e6f 6465 5f74 7970 6573  lable_node_types
-00001820: 272c 2027 7261 792e 6865 6164 2e64 6566  ', 'ray.head.def
-00001830: 6175 6c74 272c 2027 6e6f 6465 5f63 6f6e  ault', 'node_con
-00001840: 6669 6727 2c20 2755 7365 7244 6174 6127  fig', 'UserData'
-00001850: 292c 0a20 2020 2028 2761 7661 696c 6162  ),.    ('availab
-00001860: 6c65 5f6e 6f64 655f 7479 7065 7327 2c20  le_node_types', 
-00001870: 2772 6179 2e77 6f72 6b65 722e 6465 6661  'ray.worker.defa
-00001880: 756c 7427 2c20 276e 6f64 655f 636f 6e66  ult', 'node_conf
-00001890: 6967 272c 2027 5573 6572 4461 7461 2729  ig', 'UserData')
-000018a0: 2c0a 5d0a 0a0a 6465 6620 6973 5f69 7028  ,.]...def is_ip(
-000018b0: 733a 2073 7472 2920 2d3e 2062 6f6f 6c3a  s: str) -> bool:
-000018c0: 0a20 2020 2022 2222 5265 7475 726e 7320  .    """Returns 
-000018d0: 7768 6574 6865 7220 7468 6973 2073 7472  whether this str
-000018e0: 696e 6720 6d61 7463 6865 7320 4950 5f41  ing matches IP_A
-000018f0: 4444 525f 5245 4745 582e 2222 220a 2020  DDR_REGEX.""".  
-00001900: 2020 7265 7475 726e 206c 656e 2872 652e    return len(re.
-00001910: 6669 6e64 616c 6c28 4950 5f41 4444 525f  findall(IP_ADDR_
-00001920: 5245 4745 582c 2073 2929 203d 3d20 310a  REGEX, s)) == 1.
-00001930: 0a0a 6465 6620 5f67 6574 5f79 616d 6c5f  ..def _get_yaml_
-00001940: 7061 7468 5f66 726f 6d5f 636c 7573 7465  path_from_cluste
-00001950: 725f 6e61 6d65 2863 6c75 7374 6572 5f6e  r_name(cluster_n
-00001960: 616d 653a 2073 7472 2c0a 2020 2020 2020  ame: str,.      
-00001970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001980: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00001990: 7265 6669 783a 2073 7472 203d 2053 4b59  refix: str = SKY
-000019a0: 5f55 5345 525f 4649 4c45 5f50 4154 4829  _USER_FILE_PATH)
-000019b0: 202d 3e20 7374 723a 0a20 2020 206f 7574   -> str:.    out
-000019c0: 7075 745f 7061 7468 203d 2070 6174 686c  put_path = pathl
-000019d0: 6962 2e50 6174 6828 0a20 2020 2020 2020  ib.Path(.       
-000019e0: 2070 7265 6669 7829 2e65 7870 616e 6475   prefix).expandu
-000019f0: 7365 7228 292e 7265 736f 6c76 6528 2920  ser().resolve() 
-00001a00: 2f20 6627 7b63 6c75 7374 6572 5f6e 616d  / f'{cluster_nam
-00001a10: 657d 2e79 6d6c 270a 2020 2020 6f73 2e6d  e}.yml'.    os.m
-00001a20: 616b 6564 6972 7328 6f75 7470 7574 5f70  akedirs(output_p
-00001a30: 6174 682e 7061 7265 6e74 735b 305d 2c20  ath.parents[0], 
-00001a40: 6578 6973 745f 6f6b 3d54 7275 6529 0a20  exist_ok=True). 
-00001a50: 2020 2072 6574 7572 6e20 7374 7228 6f75     return str(ou
-00001a60: 7470 7574 5f70 6174 6829 0a0a 0a64 6566  tput_path)...def
-00001a70: 205f 6f70 7469 6d69 7a65 5f66 696c 655f   _optimize_file_
-00001a80: 6d6f 756e 7473 2879 616d 6c5f 7061 7468  mounts(yaml_path
-00001a90: 3a20 7374 7229 202d 3e20 4e6f 6e65 3a0a  : str) -> None:.
-00001aa0: 2020 2020 2222 224f 7074 696d 697a 6520      """Optimize 
-00001ab0: 6669 6c65 206d 6f75 6e74 7320 696e 2074  file mounts in t
-00001ac0: 6865 2067 6976 656e 2072 6179 2079 616d  he given ray yam
-00001ad0: 6c20 6669 6c65 2e0a 0a20 2020 2052 756e  l file...    Run
-00001ae0: 7469 6d65 2066 696c 6573 2068 616e 646c  time files handl
-00001af0: 696e 673a 0a20 2020 204c 6973 7420 6f66  ing:.    List of
-00001b00: 2072 756e 7469 6d65 2066 696c 6573 2074   runtime files t
-00001b10: 6f20 6265 2075 706c 6f61 6465 6420 746f  o be uploaded to
-00001b20: 2063 6c75 7374 6572 3a0a 2020 2020 2020   cluster:.      
-00001b30: 2d20 7961 6d6c 2063 6f6e 6669 6720 2866  - yaml config (f
-00001b40: 6f72 2061 7574 6f73 746f 7070 696e 6729  or autostopping)
-00001b50: 0a20 2020 2020 202d 2077 6865 656c 0a20  .      - wheel. 
-00001b60: 2020 2020 202d 2063 7265 6465 6e74 6961       - credentia
-00001b70: 6c73 0a20 2020 2046 6f72 6d61 7420 6973  ls.    Format is
-00001b80: 207b 6473 743a 2073 7263 7d2e 0a20 2020   {dst: src}..   
-00001b90: 2022 2222 0a20 2020 2079 616d 6c5f 636f   """.    yaml_co
-00001ba0: 6e66 6967 203d 2063 6f6d 6d6f 6e5f 7574  nfig = common_ut
-00001bb0: 696c 732e 7265 6164 5f79 616d 6c28 7961  ils.read_yaml(ya
-00001bc0: 6d6c 5f70 6174 6829 0a0a 2020 2020 6669  ml_path)..    fi
-00001bd0: 6c65 5f6d 6f75 6e74 7320 3d20 7961 6d6c  le_mounts = yaml
-00001be0: 5f63 6f6e 6669 672e 6765 7428 2766 696c  _config.get('fil
-00001bf0: 655f 6d6f 756e 7473 272c 207b 7d29 0a20  e_mounts', {}). 
-00001c00: 2020 2023 2052 656d 6f76 6520 7468 6520     # Remove the 
-00001c10: 6669 6c65 206d 6f75 6e74 7320 6164 6465  file mounts adde
-00001c20: 6420 6279 2074 6865 206e 6577 6c69 6e65  d by the newline
-00001c30: 2e0a 2020 2020 6966 2027 2720 696e 2066  ..    if '' in f
-00001c40: 696c 655f 6d6f 756e 7473 3a0a 2020 2020  ile_mounts:.    
-00001c50: 2020 2020 6173 7365 7274 2066 696c 655f      assert file_
-00001c60: 6d6f 756e 7473 5b27 275d 203d 3d20 2727  mounts[''] == ''
-00001c70: 2c20 6669 6c65 5f6d 6f75 6e74 735b 2727  , file_mounts[''
-00001c80: 5d0a 2020 2020 2020 2020 6669 6c65 5f6d  ].        file_m
-00001c90: 6f75 6e74 732e 706f 7028 2727 290a 0a20  ounts.pop('').. 
-00001ca0: 2020 2023 2050 7574 7469 6e67 2074 6865     # Putting the
-00001cb0: 7365 2069 6e20 6669 6c65 5f6d 6f75 6e74  se in file_mount
-00001cc0: 7320 6875 7274 7320 7072 6f76 6973 696f  s hurts provisio
-00001cd0: 6e69 6e67 2073 7065 6564 2c20 6173 2065  ning speed, as e
-00001ce0: 6163 6820 6669 6c65 0a20 2020 2023 206f  ach file.    # o
-00001cf0: 7065 6e73 2f63 6c6f 7365 7320 616e 2053  pens/closes an S
-00001d00: 5348 2063 6f6e 6e65 6374 696f 6e2e 2020  SH connection.  
-00001d10: 496e 7374 6561 642c 2077 653a 0a20 2020  Instead, we:.   
-00001d20: 2023 2020 2d20 6370 2074 6865 6d20 6c6f   #  - cp them lo
-00001d30: 6361 6c6c 7920 696e 746f 2061 2064 6972  cally into a dir
-00001d40: 6563 746f 7279 2c20 6561 6368 2077 6974  ectory, each wit
-00001d50: 6820 6120 756e 6971 7565 206e 616d 6520  h a unique name 
-00001d60: 746f 2061 766f 6964 0a20 2020 2023 2020  to avoid.    #  
-00001d70: 2020 6261 7365 6e61 6d65 2063 6f6e 666c    basename confl
-00001d80: 6963 7473 0a20 2020 2023 2020 2d20 7570  icts.    #  - up
-00001d90: 6c6f 6164 2074 6861 7420 6469 7265 6374  load that direct
-00001da0: 6f72 7920 6173 2061 2066 696c 6520 6d6f  ory as a file mo
-00001db0: 756e 7420 2831 2063 6f6e 6e65 6374 696f  unt (1 connectio
-00001dc0: 6e29 0a20 2020 2023 2020 2d20 7573 6520  n).    #  - use 
-00001dd0: 6120 7265 6d6f 7465 2063 6f6d 6d61 6e64  a remote command
-00001de0: 2074 6f20 6d6f 7665 2061 6c6c 2072 756e   to move all run
-00001df0: 7469 6d65 2066 696c 6573 2074 6f20 7468  time files to th
-00001e00: 6569 7220 7269 6768 7420 706c 6163 6573  eir right places
-00001e10: 2e0a 0a20 2020 2023 204c 6f63 616c 2074  ...    # Local t
-00001e20: 6d70 2064 6972 2068 6f6c 6469 6e67 2072  mp dir holding r
-00001e30: 756e 7469 6d65 2066 696c 6573 2e0a 2020  untime files..  
-00001e40: 2020 6c6f 6361 6c5f 7275 6e74 696d 655f    local_runtime_
-00001e50: 6669 6c65 735f 6469 7220 3d20 7465 6d70  files_dir = temp
-00001e60: 6669 6c65 2e6d 6b64 7465 6d70 2829 0a20  file.mkdtemp(). 
-00001e70: 2020 206e 6577 5f66 696c 655f 6d6f 756e     new_file_moun
-00001e80: 7473 203d 207b 5f52 454d 4f54 455f 5255  ts = {_REMOTE_RU
-00001e90: 4e54 494d 455f 4649 4c45 535f 4449 523a  NTIME_FILES_DIR:
-00001ea0: 206c 6f63 616c 5f72 756e 7469 6d65 5f66   local_runtime_f
-00001eb0: 696c 6573 5f64 6972 7d0a 0a20 2020 2023  iles_dir}..    #
-00001ec0: 2047 656e 6572 6174 6520 6c6f 6361 6c5f   Generate local_
-00001ed0: 7372 6320 2d3e 2075 6e69 7175 655f 6e61  src -> unique_na
-00001ee0: 6d65 2e0a 2020 2020 6c6f 6361 6c5f 736f  me..    local_so
-00001ef0: 7572 6365 5f74 6f5f 756e 6971 7565 5f6e  urce_to_unique_n
-00001f00: 616d 6520 3d20 7b7d 0a20 2020 2066 6f72  ame = {}.    for
-00001f10: 206c 6f63 616c 5f73 7263 2069 6e20 6669   local_src in fi
-00001f20: 6c65 5f6d 6f75 6e74 732e 7661 6c75 6573  le_mounts.values
-00001f30: 2829 3a0a 2020 2020 2020 2020 6c6f 6361  ():.        loca
-00001f40: 6c5f 736f 7572 6365 5f74 6f5f 756e 6971  l_source_to_uniq
-00001f50: 7565 5f6e 616d 655b 6c6f 6361 6c5f 7372  ue_name[local_sr
-00001f60: 635d 203d 2073 7472 2875 7569 642e 7575  c] = str(uuid.uu
-00001f70: 6964 3428 2929 0a0a 2020 2020 2320 2846  id4())..    # (F
-00001f80: 6f72 2072 656d 6f74 6529 2042 7569 6c64  or remote) Build
-00001f90: 2061 2063 6f6d 6d61 6e64 2074 6861 7420   a command that 
-00001fa0: 636f 7069 6573 2072 756e 7469 6d65 2066  copies runtime f
-00001fb0: 696c 6573 2074 6f20 7468 6569 7220 7269  iles to their ri
-00001fc0: 6768 740a 2020 2020 2320 6465 7374 696e  ght.    # destin
-00001fd0: 6174 696f 6e73 2e0a 2020 2020 2320 4e4f  ations..    # NO
-00001fe0: 5445 3a20 7765 2063 6f70 7920 7261 7468  TE: we copy rath
-00001ff0: 6572 2074 6861 6e20 6d6f 7665 2c20 6265  er than move, be
-00002000: 6361 7573 6520 7768 656e 206c 6175 6e63  cause when launc
-00002010: 6869 6e67 203e 3120 6e6f 6465 2c20 6865  hing >1 node, he
-00002020: 6164 206e 6f64 650a 2020 2020 2320 6973  ad node.    # is
-00002030: 2066 756c 6c79 2073 6574 2075 7020 6669   fully set up fi
-00002040: 7273 742c 2061 6e64 2069 6620 6d6f 7669  rst, and if movi
-00002050: 6e67 2074 6865 6e20 6865 6164 206e 6f64  ng then head nod
-00002060: 6527 7320 6669 6c65 7320 776f 756c 6420  e's files would 
-00002070: 616c 7265 6164 790a 2020 2020 2320 6d6f  already.    # mo
-00002080: 7665 206f 7574 206f 6620 5f52 454d 4f54  ve out of _REMOT
-00002090: 455f 5255 4e54 494d 455f 4649 4c45 535f  E_RUNTIME_FILES_
-000020a0: 4449 522c 2077 6869 6368 2077 6f75 6c64  DIR, which would
-000020b0: 2063 6175 7365 2073 6574 7469 6e67 2075   cause setting u
-000020c0: 700a 2020 2020 2320 776f 726b 6572 7320  p.    # workers 
-000020d0: 2866 726f 6d20 7468 6520 6865 6164 2773  (from the head's
-000020e0: 2066 696c 6573 2920 746f 2066 6169 6c2e   files) to fail.
-000020f0: 2020 416e 2061 6c74 6572 6e61 7469 7665    An alternative
-00002100: 2069 7320 736f 6674 6c69 6e6b 0a20 2020   is softlink.   
-00002110: 2023 2028 7468 656e 2077 6520 6e65 6564   # (then we need
-00002120: 2074 6f20 6d61 6b65 2073 7572 6520 7468   to make sure th
-00002130: 6520 7573 6167 6520 6f66 2072 756e 7469  e usage of runti
-00002140: 6d65 2066 696c 6573 2066 6f6c 6c6f 7720  me files follow 
-00002150: 6c69 6e6b 7329 2e0a 2020 2020 636f 6d6d  links)..    comm
-00002160: 616e 6473 203d 205b 5d0a 2020 2020 6261  ands = [].    ba
-00002170: 7365 6e61 6d65 7320 3d20 7365 7428 290a  senames = set().
-00002180: 2020 2020 666f 7220 6473 742c 2073 7263      for dst, src
-00002190: 2069 6e20 6669 6c65 5f6d 6f75 6e74 732e   in file_mounts.
-000021a0: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
-000021b0: 2073 7263 5f62 6173 656e 616d 6520 3d20   src_basename = 
-000021c0: 6c6f 6361 6c5f 736f 7572 6365 5f74 6f5f  local_source_to_
-000021d0: 756e 6971 7565 5f6e 616d 655b 7372 635d  unique_name[src]
-000021e0: 0a20 2020 2020 2020 2064 7374 5f62 6173  .        dst_bas
-000021f0: 656e 616d 6520 3d20 6f73 2e70 6174 682e  ename = os.path.
-00002200: 6261 7365 6e61 6d65 2864 7374 290a 2020  basename(dst).  
-00002210: 2020 2020 2020 6473 745f 7061 7265 6e74        dst_parent
-00002220: 5f64 6972 203d 206f 732e 7061 7468 2e64  _dir = os.path.d
-00002230: 6972 6e61 6d65 2864 7374 290a 0a20 2020  irname(dst)..   
-00002240: 2020 2020 2023 2056 616c 6964 6174 6520       # Validate 
-00002250: 6279 2061 7373 6572 7473 2068 6572 6520  by asserts here 
-00002260: 6173 2074 6865 7365 2066 696c 6573 2061  as these files a
-00002270: 7265 2061 6464 6564 2062 7920 6f75 7220  re added by our 
-00002280: 6261 636b 656e 642e 0a20 2020 2020 2020  backend..       
-00002290: 2023 204f 7572 2072 756e 7469 6d65 2066   # Our runtime f
-000022a0: 696c 6573 2028 7768 6565 6c2c 2079 616d  iles (wheel, yam
-000022b0: 6c2c 2063 7265 6465 6e74 6961 6c73 2920  l, credentials) 
-000022c0: 646f 206e 6f74 2068 6176 6520 6261 636b  do not have back
-000022d0: 736c 6173 6865 732e 0a20 2020 2020 2020  slashes..       
-000022e0: 2061 7373 6572 7420 6e6f 7420 7372 632e   assert not src.
-000022f0: 656e 6473 7769 7468 2827 2f27 292c 2073  endswith('/'), s
-00002300: 7263 0a20 2020 2020 2020 2061 7373 6572  rc.        asser
-00002310: 7420 6e6f 7420 6473 742e 656e 6473 7769  t not dst.endswi
-00002320: 7468 2827 2f27 292c 2064 7374 0a20 2020  th('/'), dst.   
-00002330: 2020 2020 2061 7373 6572 7420 7372 635f       assert src_
-00002340: 6261 7365 6e61 6d65 206e 6f74 2069 6e20  basename not in 
-00002350: 6261 7365 6e61 6d65 732c 2028 0a20 2020  basenames, (.   
-00002360: 2020 2020 2020 2020 2066 2744 7570 6c69           f'Dupli
-00002370: 6361 7465 6420 7372 6320 6261 7365 6e61  cated src basena
-00002380: 6d65 3a20 7b73 7263 5f62 6173 656e 616d  me: {src_basenam
-00002390: 657d 3b20 6d6f 756e 7473 3a20 7b66 696c  e}; mounts: {fil
-000023a0: 655f 6d6f 756e 7473 7d27 290a 2020 2020  e_mounts}').    
-000023b0: 2020 2020 6261 7365 6e61 6d65 732e 6164      basenames.ad
-000023c0: 6428 7372 635f 6261 7365 6e61 6d65 290a  d(src_basename).
-000023d0: 2020 2020 2020 2020 2320 4f75 7220 7275          # Our ru
-000023e0: 6e74 696d 6520 6669 6c65 7320 2877 6865  ntime files (whe
-000023f0: 656c 2c20 7961 6d6c 2c20 6372 6564 656e  el, yaml, creden
-00002400: 7469 616c 7329 2061 7265 206e 6f74 2072  tials) are not r
-00002410: 656c 6174 6976 6520 7061 7468 732e 0a20  elative paths.. 
-00002420: 2020 2020 2020 2061 7373 6572 7420 6473         assert ds
-00002430: 745f 7061 7265 6e74 5f64 6972 2c20 6627  t_parent_dir, f'
-00002440: 466f 756e 6420 7265 6c61 7469 7665 2064  Found relative d
-00002450: 6573 7469 6e61 7469 6f6e 2070 6174 683a  estination path:
-00002460: 207b 6473 747d 270a 0a20 2020 2020 2020   {dst}'..       
-00002470: 206d 6b64 6972 5f70 6172 656e 7420 3d20   mkdir_parent = 
-00002480: 6627 6d6b 6469 7220 2d70 207b 6473 745f  f'mkdir -p {dst_
-00002490: 7061 7265 6e74 5f64 6972 7d27 0a20 2020  parent_dir}'.   
-000024a0: 2020 2020 2069 6620 6f73 2e70 6174 682e       if os.path.
-000024b0: 6973 6469 7228 6f73 2e70 6174 682e 6578  isdir(os.path.ex
-000024c0: 7061 6e64 7573 6572 2873 7263 2929 3a0a  panduser(src)):.
-000024d0: 2020 2020 2020 2020 2020 2020 2320 5370              # Sp
-000024e0: 6563 6961 6c20 6361 7365 2066 6f72 2064  ecial case for d
-000024f0: 6972 6563 746f 7269 6573 2e20 4966 2074  irectories. If t
-00002500: 6865 2064 7374 2061 6c72 6561 6479 2065  he dst already e
-00002510: 7869 7374 7320 6173 2061 0a20 2020 2020  xists as a.     
-00002520: 2020 2020 2020 2023 2066 6f6c 6465 722c         # folder,
-00002530: 2064 6972 6563 746c 7920 636f 7079 2074   directly copy t
-00002540: 6865 2066 6f6c 6465 7220 7769 6c6c 2063  he folder will c
-00002550: 7265 6174 6520 6120 7375 6266 6f6c 6465  reate a subfolde
-00002560: 7220 756e 6465 720a 2020 2020 2020 2020  r under.        
-00002570: 2020 2020 2320 7468 6520 6473 742e 0a20      # the dst.. 
-00002580: 2020 2020 2020 2020 2020 206d 6b64 6972             mkdir
-00002590: 5f70 6172 656e 7420 3d20 6627 6d6b 6469  _parent = f'mkdi
-000025a0: 7220 2d70 207b 6473 747d 270a 2020 2020  r -p {dst}'.    
-000025b0: 2020 2020 2020 2020 7372 635f 6261 7365          src_base
-000025c0: 6e61 6d65 203d 2066 277b 7372 635f 6261  name = f'{src_ba
-000025d0: 7365 6e61 6d65 7d2f 2a27 0a20 2020 2020  sename}/*'.     
-000025e0: 2020 206d 7620 3d20 2866 2763 7020 2d72     mv = (f'cp -r
-000025f0: 207b 5f52 454d 4f54 455f 5255 4e54 494d   {_REMOTE_RUNTIM
-00002600: 455f 4649 4c45 535f 4449 527d 2f7b 7372  E_FILES_DIR}/{sr
-00002610: 635f 6261 7365 6e61 6d65 7d20 270a 2020  c_basename} '.  
-00002620: 2020 2020 2020 2020 2020 2020 6627 7b64              f'{d
-00002630: 7374 5f70 6172 656e 745f 6469 727d 2f7b  st_parent_dir}/{
-00002640: 6473 745f 6261 7365 6e61 6d65 7d27 290a  dst_basename}').
-00002650: 2020 2020 2020 2020 6672 6167 6d65 6e74          fragment
-00002660: 203d 2066 2728 7b6d 6b64 6972 5f70 6172   = f'({mkdir_par
-00002670: 656e 747d 2026 2620 7b6d 767d 2927 0a20  ent} && {mv})'. 
-00002680: 2020 2020 2020 2063 6f6d 6d61 6e64 732e         commands.
-00002690: 6170 7065 6e64 2866 7261 676d 656e 7429  append(fragment)
-000026a0: 0a20 2020 2070 6f73 7470 726f 6365 7373  .    postprocess
-000026b0: 5f72 756e 7469 6d65 5f66 696c 6573 5f63  _runtime_files_c
-000026c0: 6f6d 6d61 6e64 203d 2027 2026 2620 272e  ommand = ' && '.
-000026d0: 6a6f 696e 2863 6f6d 6d61 6e64 7329 0a0a  join(commands)..
-000026e0: 2020 2020 7365 7475 705f 636f 6d6d 616e      setup_comman
-000026f0: 6473 203d 2079 616d 6c5f 636f 6e66 6967  ds = yaml_config
-00002700: 2e67 6574 2827 7365 7475 705f 636f 6d6d  .get('setup_comm
-00002710: 616e 6473 272c 205b 5d29 0a20 2020 2069  ands', []).    i
-00002720: 6620 7365 7475 705f 636f 6d6d 616e 6473  f setup_commands
-00002730: 3a0a 2020 2020 2020 2020 7365 7475 705f  :.        setup_
-00002740: 636f 6d6d 616e 6473 5b0a 2020 2020 2020  commands[.      
-00002750: 2020 2020 2020 305d 203d 2066 277b 706f        0] = f'{po
-00002760: 7374 7072 6f63 6573 735f 7275 6e74 696d  stprocess_runtim
-00002770: 655f 6669 6c65 735f 636f 6d6d 616e 647d  e_files_command}
-00002780: 3b20 7b73 6574 7570 5f63 6f6d 6d61 6e64  ; {setup_command
-00002790: 735b 305d 7d27 0a20 2020 2065 6c73 653a  s[0]}'.    else:
-000027a0: 0a20 2020 2020 2020 2073 6574 7570 5f63  .        setup_c
-000027b0: 6f6d 6d61 6e64 7320 3d20 5b70 6f73 7470  ommands = [postp
-000027c0: 726f 6365 7373 5f72 756e 7469 6d65 5f66  rocess_runtime_f
-000027d0: 696c 6573 5f63 6f6d 6d61 6e64 5d0a 0a20  iles_command].. 
-000027e0: 2020 2079 616d 6c5f 636f 6e66 6967 5b27     yaml_config['
-000027f0: 6669 6c65 5f6d 6f75 6e74 7327 5d20 3d20  file_mounts'] = 
-00002800: 6e65 775f 6669 6c65 5f6d 6f75 6e74 730a  new_file_mounts.
-00002810: 2020 2020 7961 6d6c 5f63 6f6e 6669 675b      yaml_config[
-00002820: 2773 6574 7570 5f63 6f6d 6d61 6e64 7327  'setup_commands'
-00002830: 5d20 3d20 7365 7475 705f 636f 6d6d 616e  ] = setup_comman
-00002840: 6473 0a0a 2020 2020 2320 2846 6f72 206c  ds..    # (For l
-00002850: 6f63 616c 2920 436f 7079 2061 6c6c 2072  ocal) Copy all r
-00002860: 756e 7469 6d65 2066 696c 6573 2c20 696e  untime files, in
-00002870: 636c 7564 696e 6720 7468 6520 6a75 7374  cluding the just
-00002880: 2d77 7269 7474 656e 2079 616d 6c2c 2074  -written yaml, t
-00002890: 6f0a 2020 2020 2320 6c6f 6361 6c5f 7275  o.    # local_ru
-000028a0: 6e74 696d 655f 6669 6c65 735f 6469 722f  ntime_files_dir/
-000028b0: 2e0a 2020 2020 2320 3c20 302e 3373 2074  ..    # < 0.3s t
-000028c0: 6f20 6370 2036 2063 6c6f 7564 7327 2063  o cp 6 clouds' c
-000028d0: 7265 6465 6e74 6961 6c73 2e0a 2020 2020  redentials..    
-000028e0: 666f 7220 6c6f 6361 6c5f 7372 6320 696e  for local_src in
-000028f0: 2066 696c 655f 6d6f 756e 7473 2e76 616c   file_mounts.val
-00002900: 7565 7328 293a 0a20 2020 2020 2020 2023  ues():.        #
-00002910: 2063 7020 3c6c 6f63 616c 5f73 7263 3e20   cp <local_src> 
-00002920: 3c6c 6f63 616c 5f72 756e 7469 6d65 5f66  <local_runtime_f
-00002930: 696c 6573 5f64 6972 3e2f 3c75 6e69 7175  iles_dir>/<uniqu
-00002940: 6520 6e61 6d65 206f 6620 6c6f 6361 6c5f  e name of local_
-00002950: 7372 633e 2e0a 2020 2020 2020 2020 6675  src>..        fu
-00002960: 6c6c 5f6c 6f63 616c 5f73 7263 203d 2073  ll_local_src = s
-00002970: 7472 2870 6174 686c 6962 2e50 6174 6828  tr(pathlib.Path(
-00002980: 6c6f 6361 6c5f 7372 6329 2e65 7870 616e  local_src).expan
-00002990: 6475 7365 7228 2929 0a20 2020 2020 2020  duser()).       
-000029a0: 2075 6e69 7175 655f 6e61 6d65 203d 206c   unique_name = l
-000029b0: 6f63 616c 5f73 6f75 7263 655f 746f 5f75  ocal_source_to_u
-000029c0: 6e69 7175 655f 6e61 6d65 5b6c 6f63 616c  nique_name[local
-000029d0: 5f73 7263 5d0a 2020 2020 2020 2020 2320  _src].        # 
-000029e0: 2172 2074 6f20 6164 6420 7175 6f74 6573  !r to add quotes
-000029f0: 2066 6f72 2070 6174 6873 2063 6f6e 7461   for paths conta
-00002a00: 696e 696e 6720 7370 6163 6573 2e0a 2020  ining spaces..  
-00002a10: 2020 2020 2020 7375 6270 726f 6365 7373        subprocess
-00002a20: 2e72 756e 280a 2020 2020 2020 2020 2020  .run(.          
-00002a30: 2020 6627 6370 202d 7220 7b66 756c 6c5f    f'cp -r {full_
-00002a40: 6c6f 6361 6c5f 7372 6321 727d 207b 6c6f  local_src!r} {lo
-00002a50: 6361 6c5f 7275 6e74 696d 655f 6669 6c65  cal_runtime_file
-00002a60: 735f 6469 727d 2f7b 756e 6971 7565 5f6e  s_dir}/{unique_n
-00002a70: 616d 657d 272c 0a20 2020 2020 2020 2020  ame}',.         
-00002a80: 2020 2073 6865 6c6c 3d54 7275 652c 0a20     shell=True,. 
-00002a90: 2020 2020 2020 2020 2020 2063 6865 636b             check
-00002aa0: 3d54 7275 6529 0a0a 2020 2020 636f 6d6d  =True)..    comm
-00002ab0: 6f6e 5f75 7469 6c73 2e64 756d 705f 7961  on_utils.dump_ya
-00002ac0: 6d6c 2879 616d 6c5f 7061 7468 2c20 7961  ml(yaml_path, ya
-00002ad0: 6d6c 5f63 6f6e 6669 6729 0a0a 0a64 6566  ml_config)...def
-00002ae0: 2070 6174 685f 7369 7a65 5f6d 6567 6162   path_size_megab
-00002af0: 7974 6573 2870 6174 683a 2073 7472 2920  ytes(path: str) 
-00002b00: 2d3e 2069 6e74 3a0a 2020 2020 2222 2252  -> int:.    """R
-00002b10: 6574 7572 6e73 2074 6865 2073 697a 6520  eturns the size 
-00002b20: 6f66 2027 7061 7468 2720 2864 6972 6563  of 'path' (direc
-00002b30: 746f 7279 206f 7220 6669 6c65 2920 696e  tory or file) in
-00002b40: 206d 6567 6162 7974 6573 2e0a 0a20 2020   megabytes...   
-00002b50: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
-00002b60: 2020 4966 2073 7563 6365 7373 6675 6c3a    If successful:
-00002b70: 2074 6865 2073 697a 6520 6f66 2027 7061   the size of 'pa
-00002b80: 7468 2720 696e 206d 6567 6162 7974 6573  th' in megabytes
-00002b90: 2c20 726f 756e 6465 6420 646f 776e 2e20  , rounded down. 
-00002ba0: 4f74 6865 7277 6973 652c 0a20 2020 2020  Otherwise,.     
-00002bb0: 2020 202d 312e 0a20 2020 2022 2222 0a20     -1..    """. 
-00002bc0: 2020 2072 6573 6f6c 7665 645f 7061 7468     resolved_path
-00002bd0: 203d 2070 6174 686c 6962 2e50 6174 6828   = pathlib.Path(
-00002be0: 7061 7468 292e 6578 7061 6e64 7573 6572  path).expanduser
-00002bf0: 2829 2e72 6573 6f6c 7665 2829 0a20 2020  ().resolve().   
-00002c00: 2067 6974 5f65 7863 6c75 6465 5f66 696c   git_exclude_fil
-00002c10: 7465 7220 3d20 2727 0a20 2020 2069 6620  ter = ''.    if 
-00002c20: 2872 6573 6f6c 7665 645f 7061 7468 202f  (resolved_path /
-00002c30: 2063 6f6d 6d61 6e64 5f72 756e 6e65 722e   command_runner.
-00002c40: 4749 545f 4558 434c 5544 4529 2e65 7869  GIT_EXCLUDE).exi
-00002c50: 7374 7328 293a 0a20 2020 2020 2020 2023  sts():.        #
-00002c60: 2045 6e73 7572 6520 6669 6c65 2065 7869   Ensure file exi
-00002c70: 7374 733b 206f 7468 6572 7769 7365 2c20  sts; otherwise, 
-00002c80: 7273 796e 6320 7769 6c6c 2065 7272 6f72  rsync will error
-00002c90: 206f 7574 2e0a 2020 2020 2020 2020 230a   out..        #.
-00002ca0: 2020 2020 2020 2020 2320 5765 2073 686c          # We shl
-00002cb0: 6578 2e71 756f 7465 2829 2062 6563 6175  ex.quote() becau
-00002cc0: 7365 2074 6865 2070 6174 6820 6d61 7920  se the path may 
-00002cd0: 636f 6e74 6169 6e20 7370 6163 6573 3a0a  contain spaces:.
-00002ce0: 2020 2020 2020 2020 2320 2020 276d 7920          #   'my 
-00002cf0: 6469 722f 2e67 6974 2f69 6e66 6f2f 6578  dir/.git/info/ex
-00002d00: 636c 7564 6527 0a20 2020 2020 2020 2023  clude'.        #
-00002d10: 2057 6974 686f 7574 2071 756f 7469 6e67   Without quoting
-00002d20: 2072 7379 6e63 2066 6169 6c73 2e0a 2020   rsync fails..  
-00002d30: 2020 2020 2020 6769 745f 6578 636c 7564        git_exclud
-00002d40: 655f 6669 6c74 6572 203d 2063 6f6d 6d61  e_filter = comma
-00002d50: 6e64 5f72 756e 6e65 722e 5253 594e 435f  nd_runner.RSYNC_
-00002d60: 4558 434c 5544 455f 4f50 5449 4f4e 2e66  EXCLUDE_OPTION.f
-00002d70: 6f72 6d61 7428 0a20 2020 2020 2020 2020  ormat(.         
-00002d80: 2020 2073 686c 6578 2e71 756f 7465 2873     shlex.quote(s
-00002d90: 7472 2872 6573 6f6c 7665 645f 7061 7468  tr(resolved_path
-00002da0: 202f 2063 6f6d 6d61 6e64 5f72 756e 6e65   / command_runne
-00002db0: 722e 4749 545f 4558 434c 5544 4529 2929  r.GIT_EXCLUDE)))
-00002dc0: 0a20 2020 2072 7379 6e63 5f63 6f6d 6d61  .    rsync_comma
-00002dd0: 6e64 203d 2028 6627 7273 796e 6320 7b63  nd = (f'rsync {c
-00002de0: 6f6d 6d61 6e64 5f72 756e 6e65 722e 5253  ommand_runner.RS
-00002df0: 594e 435f 4449 5350 4c41 595f 4f50 5449  YNC_DISPLAY_OPTI
-00002e00: 4f4e 7d20 270a 2020 2020 2020 2020 2020  ON} '.          
-00002e10: 2020 2020 2020 2020 2020 2066 277b 636f             f'{co
-00002e20: 6d6d 616e 645f 7275 6e6e 6572 2e52 5359  mmand_runner.RSY
-00002e30: 4e43 5f46 494c 5445 525f 4f50 5449 4f4e  NC_FILTER_OPTION
-00002e40: 7d20 270a 2020 2020 2020 2020 2020 2020  } '.            
-00002e50: 2020 2020 2020 2020 2066 277b 6769 745f           f'{git_
-00002e60: 6578 636c 7564 655f 6669 6c74 6572 7d20  exclude_filter} 
-00002e70: 2d2d 6472 792d 7275 6e20 7b70 6174 6821  --dry-run {path!
-00002e80: 727d 2729 0a20 2020 2072 7379 6e63 5f6f  r}').    rsync_o
-00002e90: 7574 7075 7420 3d20 2727 0a20 2020 2074  utput = ''.    t
-00002ea0: 7279 3a0a 2020 2020 2020 2020 7273 796e  ry:.        rsyn
-00002eb0: 635f 6f75 7470 7574 203d 2073 7472 2873  c_output = str(s
-00002ec0: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
-00002ed0: 6f75 7470 7574 2872 7379 6e63 5f63 6f6d  output(rsync_com
-00002ee0: 6d61 6e64 2c20 7368 656c 6c3d 5472 7565  mand, shell=True
-00002ef0: 2929 0a20 2020 2065 7863 6570 7420 7375  )).    except su
-00002f00: 6270 726f 6365 7373 2e43 616c 6c65 6450  bprocess.CalledP
-00002f10: 726f 6365 7373 4572 726f 723a 0a20 2020  rocessError:.   
-00002f20: 2020 2020 206c 6f67 6765 722e 6465 6275       logger.debu
-00002f30: 6728 2743 6f6d 6d61 6e64 2066 6169 6c65  g('Command faile
-00002f40: 642c 2070 726f 6365 6564 696e 6720 7769  d, proceeding wi
-00002f50: 7468 6f75 7420 6573 7469 6d61 7469 6e67  thout estimating
-00002f60: 2073 697a 653a 2027 0a20 2020 2020 2020   size: '.       
-00002f70: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-00002f80: 7b72 7379 6e63 5f63 6f6d 6d61 6e64 7d27  {rsync_command}'
-00002f90: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00002fa0: 202d 310a 2020 2020 2320 332e 322e 333a   -1.    # 3.2.3:
-00002fb0: 0a20 2020 2023 2020 746f 7461 6c20 7369  .    #  total si
-00002fc0: 7a65 2069 7320 3235 302c 3935 372c 3732  ze is 250,957,72
-00002fd0: 3820 2073 7065 6564 7570 2069 7320 3333  8  speedup is 33
-00002fe0: 302e 3139 2028 4452 5920 5255 4e29 0a20  0.19 (DRY RUN). 
-00002ff0: 2020 2023 2032 2e36 2e39 3a0a 2020 2020     # 2.6.9:.    
-00003000: 2320 2074 6f74 616c 2073 697a 6520 6973  #  total size is
-00003010: 2032 3132 3632 3735 3536 2020 7370 6565   212627556  spee
-00003020: 6475 7020 6973 2032 3433 372e 3431 0a20  dup is 2437.41. 
-00003030: 2020 206d 6174 6368 203d 2072 652e 7365     match = re.se
-00003040: 6172 6368 2872 2774 6f74 616c 2073 697a  arch(r'total siz
-00003050: 6520 6973 2028 5b5c 642c 5d2b 2927 2c20  e is ([\d,]+)', 
-00003060: 7273 796e 635f 6f75 7470 7574 290a 2020  rsync_output).  
-00003070: 2020 6966 206d 6174 6368 2069 7320 6e6f    if match is no
-00003080: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-00003090: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-000030a0: 2074 6f74 616c 5f62 7974 6573 203d 2069   total_bytes = i
-000030b0: 6e74 2866 6c6f 6174 286d 6174 6368 2e67  nt(float(match.g
-000030c0: 726f 7570 2831 292e 7265 706c 6163 6528  roup(1).replace(
-000030d0: 272c 272c 2027 2729 2929 0a20 2020 2020  ',', ''))).     
-000030e0: 2020 2020 2020 2072 6574 7572 6e20 746f         return to
-000030f0: 7461 6c5f 6279 7465 7320 2f2f 2028 3130  tal_bytes // (10
-00003100: 3234 2a2a 3229 0a20 2020 2020 2020 2065  24**2).        e
-00003110: 7863 6570 7420 5661 6c75 6545 7272 6f72  xcept ValueError
-00003120: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
-00003130: 6767 6572 2e64 6562 7567 2827 4661 696c  gger.debug('Fail
-00003140: 6564 2074 6f20 6669 6e64 2022 746f 7461  ed to find "tota
-00003150: 6c20 7369 7a65 2220 696e 2072 7379 6e63  l size" in rsync
-00003160: 206f 7574 7075 742e 2049 6e73 7065 6374   output. Inspect
-00003170: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-00003180: 2020 2020 2020 2020 2020 2020 6627 6f75              f'ou
-00003190: 7470 7574 206f 6620 7468 6520 666f 6c6c  tput of the foll
-000031a0: 6f77 696e 6720 636f 6d6d 616e 643a 207b  owing command: {
-000031b0: 7273 796e 635f 636f 6d6d 616e 647d 2729  rsync_command}')
-000031c0: 0a20 2020 2020 2020 2020 2020 2070 6173  .            pas
-000031d0: 7320 2023 204d 6179 6265 2064 6966 6665  s  # Maybe diffe
-000031e0: 7265 6e74 2072 7379 6e63 2076 6572 7369  rent rsync versi
-000031f0: 6f6e 7320 6861 7665 2064 6966 6665 7265  ons have differe
-00003200: 6e74 206f 7574 7075 742e 0a20 2020 2072  nt output..    r
-00003210: 6574 7572 6e20 2d31 0a0a 0a63 6c61 7373  eturn -1...class
-00003220: 2046 696c 654d 6f75 6e74 4865 6c70 6572   FileMountHelper
-00003230: 286f 626a 6563 7429 3a0a 2020 2020 2222  (object):.    ""
-00003240: 2248 656c 7065 7220 666f 7220 6861 6e64  "Helper for hand
-00003250: 6c69 6e67 2066 696c 6520 6d6f 756e 7473  ling file mounts
-00003260: 2e22 2222 0a0a 2020 2020 4063 6c61 7373  ."""..    @class
-00003270: 6d65 7468 6f64 0a20 2020 2064 6566 2077  method.    def w
-00003280: 7261 705f 6669 6c65 5f6d 6f75 6e74 2863  rap_file_mount(c
-00003290: 6c73 2c20 7061 7468 3a20 7374 7229 202d  ls, path: str) -
-000032a0: 3e20 7374 723a 0a20 2020 2020 2020 2022  > str:.        "
-000032b0: 2222 5072 6570 656e 6473 207e 2f3c 6f70  ""Prepends ~/<op
-000032c0: 6171 7565 2064 6972 3e2f 2074 6f20 6120  aque dir>/ to a 
-000032d0: 7061 7468 2074 6f20 776f 726b 2061 726f  path to work aro
-000032e0: 756e 6420 7065 726d 6973 7369 6f6e 2069  und permission i
-000032f0: 7373 7565 732e 0a0a 2020 2020 2020 2020  ssues...        
-00003300: 4578 616d 706c 6573 3a0a 2020 2020 2020  Examples:.      
-00003310: 2020 2f72 6f6f 742f 6865 6c6c 6f2e 7478    /root/hello.tx
-00003320: 7420 2d3e 207e 2f3c 6f70 6171 7565 2064  t -> ~/<opaque d
-00003330: 6972 3e2f 726f 6f74 2f68 656c 6c6f 2e74  ir>/root/hello.t
-00003340: 7874 0a20 2020 2020 2020 206c 6f63 616c  xt.        local
-00003350: 2e74 7874 202d 3e20 7e2f 3c6f 7061 7175  .txt -> ~/<opaqu
-00003360: 6520 6469 723e 2f6c 6f63 616c 2e74 7874  e dir>/local.txt
-00003370: 0a0a 2020 2020 2020 2020 4166 7465 7220  ..        After 
-00003380: 7468 6520 7061 7468 2069 7320 7379 6e63  the path is sync
-00003390: 6564 2c20 7765 2063 616e 206c 6174 6572  ed, we can later
-000033a0: 2063 7265 6174 6520 6120 7379 6d6c 696e   create a symlin
-000033b0: 6b20 746f 2074 6869 7320 7772 6170 7065  k to this wrappe
-000033c0: 640a 2020 2020 2020 2020 7061 7468 2066  d.        path f
-000033d0: 726f 6d20 7468 6520 6f72 6967 696e 616c  rom the original
-000033e0: 2070 6174 682c 2065 2e67 2e2c 2069 6e20   path, e.g., in 
-000033f0: 7468 6520 696e 6974 6961 6c69 7a61 7469  the initializati
-00003400: 6f6e 5f63 6f6d 6d61 6e64 7320 6f66 2074  on_commands of t
-00003410: 6865 0a20 2020 2020 2020 2072 6179 2061  he.        ray a
-00003420: 7574 6f73 6361 6c65 7220 5941 4d4c 2e0a  utoscaler YAML..
-00003430: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00003440: 2020 2020 7265 7475 726e 206f 732e 7061      return os.pa
-00003450: 7468 2e6a 6f69 6e28 5f53 4b59 5f52 454d  th.join(_SKY_REM
-00003460: 4f54 455f 4649 4c45 5f4d 4f55 4e54 535f  OTE_FILE_MOUNTS_
-00003470: 4449 522c 2070 6174 682e 6c73 7472 6970  DIR, path.lstrip
-00003480: 2827 2f27 2929 0a0a 2020 2020 4063 6c61  ('/'))..    @cla
-00003490: 7373 6d65 7468 6f64 0a20 2020 2064 6566  ssmethod.    def
-000034a0: 206d 616b 655f 7361 6665 5f73 796d 6c69   make_safe_symli
-000034b0: 6e6b 5f63 6f6d 6d61 6e64 2863 6c73 2c20  nk_command(cls, 
-000034c0: 2a2c 2073 6f75 7263 653a 2073 7472 2c20  *, source: str, 
-000034d0: 7461 7267 6574 3a20 7374 7229 202d 3e20  target: str) -> 
-000034e0: 7374 723a 0a20 2020 2020 2020 2022 2222  str:.        """
-000034f0: 5265 7475 726e 7320 6120 636f 6d6d 616e  Returns a comman
-00003500: 6420 7468 6174 2073 6166 656c 7920 7379  d that safely sy
-00003510: 6d6c 696e 6b73 2027 736f 7572 6365 2720  mlinks 'source' 
-00003520: 746f 2027 7461 7267 6574 272e 0a0a 2020  to 'target'...  
-00003530: 2020 2020 2020 416c 6c20 696e 7465 726d        All interm
-00003540: 6564 6961 7465 2064 6972 6563 746f 7269  ediate directori
-00003550: 6573 206f 6620 2773 6f75 7263 6527 2077  es of 'source' w
-00003560: 696c 6c20 6265 206f 776e 6564 2062 7920  ill be owned by 
-00003570: 2455 5345 522c 0a20 2020 2020 2020 2065  $USER,.        e
-00003580: 7863 6c75 6469 6e67 2074 6865 2072 6f6f  xcluding the roo
-00003590: 7420 6469 7265 6374 6f72 7920 282f 292e  t directory (/).
-000035a0: 0a0a 2020 2020 2020 2020 2773 6f75 7263  ..        'sourc
-000035b0: 6527 206d 7573 7420 6265 2061 6e20 6162  e' must be an ab
-000035c0: 736f 6c75 7465 2070 6174 683b 2062 6f74  solute path; bot
-000035d0: 6820 2773 6f75 7263 6527 2061 6e64 2027  h 'source' and '
-000035e0: 7461 7267 6574 2720 6d75 7374 206e 6f74  target' must not
-000035f0: 0a20 2020 2020 2020 2065 6e64 2077 6974  .        end wit
-00003600: 6820 6120 736c 6173 6820 282f 292e 0a0a  h a slash (/)...
-00003610: 2020 2020 2020 2020 5468 6973 2066 756e          This fun
-00003620: 6374 696f 6e20 6973 206e 6565 6465 6420  ction is needed 
-00003630: 6265 6361 7573 6520 6120 7369 6d70 6c65  because a simple
-00003640: 2027 6c6e 202d 7320 7461 7267 6574 2073   'ln -s target s
-00003650: 6f75 7263 6527 206d 6179 0a20 2020 2020  ource' may.     
-00003660: 2020 2066 6169 6c3a 2027 736f 7572 6365     fail: 'source
-00003670: 2720 6361 6e20 6861 7665 206d 756c 7469  ' can have multi
-00003680: 706c 6520 6c65 7665 6c73 2028 2f61 2f62  ple levels (/a/b
-00003690: 2f63 292c 2069 7473 2070 6172 656e 7420  /c), its parent 
-000036a0: 6469 7273 206d 6179 0a20 2020 2020 2020  dirs may.       
-000036b0: 206f 7220 6d61 7920 6e6f 7420 6578 6973   or may not exis
-000036c0: 742c 2063 616e 2065 6e64 2077 6974 6820  t, can end with 
-000036d0: 6120 736c 6173 682c 206f 7220 6d61 7920  a slash, or may 
-000036e0: 6e65 6564 2073 7564 6f20 6163 6365 7373  need sudo access
-000036f0: 2c20 6574 632e 0a0a 2020 2020 2020 2020  , etc...        
-00003700: 4361 7365 7320 6f66 203c 7461 7267 6574  Cases of <target
-00003710: 3a20 6c6f 6361 6c3e 2066 696c 6520 6d6f  : local> file mo
-00003720: 756e 7473 2061 6e64 2074 6865 6972 2062  unts and their b
-00003730: 6568 6176 696f 7273 3a0a 0a20 2020 2020  ehaviors:..     
-00003740: 2020 2020 2020 202f 6578 6973 7469 6e67         /existing
-00003750: 5f64 6972 3a20 7e2f 6c6f 6361 6c2f 6469  _dir: ~/local/di
-00003760: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
-00003770: 2d20 6572 726f 7220 6f75 7420 7361 7969  - error out sayi
-00003780: 6e67 2074 6869 7320 6361 6e6e 6f74 2062  ng this cannot b
-00003790: 6520 646f 6e65 2061 7320 4c48 5320 616c  e done as LHS al
-000037a0: 7265 6164 7920 6578 6973 7473 0a20 2020  ready exists.   
-000037b0: 2020 2020 2020 2020 202f 6578 6973 7469           /existi
-000037c0: 6e67 5f66 696c 653a 207e 2f6c 6f63 616c  ng_file: ~/local
-000037d0: 2f66 696c 650a 2020 2020 2020 2020 2020  /file.          
-000037e0: 2020 2020 2d20 6572 726f 7220 6f75 7420      - error out 
-000037f0: 7361 7969 6e67 2074 6869 7320 6361 6e6e  saying this cann
-00003800: 6f74 2062 6520 646f 6e65 2061 7320 4c48  ot be done as LH
-00003810: 5320 616c 7265 6164 7920 6578 6973 7473  S already exists
-00003820: 0a20 2020 2020 2020 2020 2020 202f 6578  .            /ex
-00003830: 6973 7469 6e67 5f73 796d 6c69 6e6b 3a20  isting_symlink: 
-00003840: 7e2f 6c6f 6361 6c2f 6669 6c65 0a20 2020  ~/local/file.   
-00003850: 2020 2020 2020 2020 2020 202d 206f 7665             - ove
-00003860: 7277 7269 7465 2074 6865 2065 7869 7374  rwrite the exist
-00003870: 696e 6720 7379 6d6c 696e 6b3b 2074 6869  ing symlink; thi
-00003880: 7320 6973 2069 6d70 6f72 7461 6e74 2062  s is important b
-00003890: 6563 6175 7365 2060 736b 790a 2020 2020  ecause `sky.    
-000038a0: 2020 2020 2020 2020 2020 2020 6c61 756e              laun
-000038b0: 6368 6020 6361 6e20 6265 2072 756e 206d  ch` can be run m
-000038c0: 756c 7469 706c 6520 7469 6d65 730a 2020  ultiple times.  
-000038d0: 2020 2020 2020 2020 2020 5061 7468 7320            Paths 
-000038e0: 7468 6174 2073 7461 7274 2077 6974 6820  that start with 
-000038f0: 7e2f 2061 6e64 202f 746d 702f 2064 6f20  ~/ and /tmp/ do 
-00003900: 6e6f 7420 6861 7665 2074 6865 2061 626f  not have the abo
-00003910: 7665 0a20 2020 2020 2020 2020 2020 2072  ve.            r
-00003920: 6573 7472 6963 7469 6f6e 733b 2074 6865  estrictions; the
-00003930: 7920 6172 6520 6465 6c65 6761 7465 6420  y are delegated 
-00003940: 746f 2072 7379 6e63 2062 6568 6176 696f  to rsync behavio
-00003950: 7273 2e0a 2020 2020 2020 2020 2222 220a  rs..        """.
-00003960: 2020 2020 2020 2020 6173 7365 7274 206f          assert o
-00003970: 732e 7061 7468 2e69 7361 6273 2873 6f75  s.path.isabs(sou
-00003980: 7263 6529 2c20 736f 7572 6365 0a20 2020  rce), source.   
-00003990: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-000039a0: 736f 7572 6365 2e65 6e64 7377 6974 6828  source.endswith(
-000039b0: 272f 2729 2061 6e64 206e 6f74 2074 6172  '/') and not tar
-000039c0: 6765 742e 656e 6473 7769 7468 2827 2f27  get.endswith('/'
-000039d0: 292c 2028 736f 7572 6365 2c0a 2020 2020  ), (source,.    
-000039e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000039f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003a20: 2020 2074 6172 6765 7429 0a20 2020 2020     target).     
-00003a30: 2020 2023 2042 656c 6f77 2c20 7573 6520     # Below, use 
-00003a40: 7375 646f 2069 6e20 6361 7365 2074 6865  sudo in case the
-00003a50: 2073 796d 6c69 6e6b 206e 6565 6473 2073   symlink needs s
-00003a60: 7564 6f20 6163 6365 7373 2074 6f20 6372  udo access to cr
-00003a70: 6561 7465 2e0a 2020 2020 2020 2020 2320  eate..        # 
-00003a80: 5072 6570 6172 6520 746f 2063 7265 6174  Prepare to creat
-00003a90: 6520 7468 6520 7379 6d6c 696e 6b3a 0a20  e the symlink:. 
-00003aa0: 2020 2020 2020 2023 2020 312e 206d 616b         #  1. mak
-00003ab0: 6520 7375 7265 2069 7473 2064 6972 2873  e sure its dir(s
-00003ac0: 2920 6578 6973 7420 2620 6172 6520 6f77  ) exist & are ow
-00003ad0: 6e65 6420 6279 2024 5553 4552 2e0a 2020  ned by $USER..  
-00003ae0: 2020 2020 2020 6469 725f 6f66 5f73 796d        dir_of_sym
-00003af0: 6c69 6e6b 203d 206f 732e 7061 7468 2e64  link = os.path.d
-00003b00: 6972 6e61 6d65 2873 6f75 7263 6529 0a20  irname(source). 
-00003b10: 2020 2020 2020 2063 6f6d 6d61 6e64 7320         commands 
-00003b20: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
-00003b30: 2320 6d6b 6469 722c 2074 6865 6e20 6c6f  # mkdir, then lo
-00003b40: 6f70 206f 7665 7220 272f 612f 622f 6327  op over '/a/b/c'
-00003b50: 2061 7320 2f61 2c20 2f61 2f62 2c20 2f61   as /a, /a/b, /a
-00003b60: 2f62 2f63 2e20 2046 6f72 2065 6163 682c  /b/c.  For each,
-00003b70: 0a20 2020 2020 2020 2020 2020 2023 2063  .            # c
-00003b80: 686f 776e 2024 5553 4552 206f 6e20 6974  hown $USER on it
-00003b90: 2073 6f20 7573 6572 2063 616e 2075 7365   so user can use
-00003ba0: 2074 6865 7365 2069 6e74 6572 6d65 6469   these intermedi
-00003bb0: 6174 6520 6469 7273 0a20 2020 2020 2020  ate dirs.       
-00003bc0: 2020 2020 2023 2028 6578 636c 7564 696e       # (excludin
-00003bd0: 6720 2f29 2e0a 2020 2020 2020 2020 2020  g /)..          
-00003be0: 2020 6627 7375 646f 206d 6b64 6972 202d    f'sudo mkdir -
-00003bf0: 7020 7b64 6972 5f6f 665f 7379 6d6c 696e  p {dir_of_symlin
-00003c00: 6b7d 272c 0a20 2020 2020 2020 2020 2020  k}',.           
-00003c10: 2023 2070 3a20 7061 7468 2073 6f20 6661   # p: path so fa
-00003c20: 720a 2020 2020 2020 2020 2020 2020 2827  r.            ('
-00003c30: 2870 3d22 223b 2027 0a20 2020 2020 2020  (p=""; '.       
-00003c40: 2020 2020 2020 6627 666f 7220 7720 696e        f'for w in
-00003c50: 2024 2865 6368 6f20 7b64 6972 5f6f 665f   $(echo {dir_of_
-00003c60: 7379 6d6c 696e 6b7d 207c 2074 7220 222f  symlink} | tr "/
-00003c70: 2220 2220 2229 3b20 646f 2027 0a20 2020  " " "); do '.   
-00003c80: 2020 2020 2020 2020 2020 2770 3d24 7b70            'p=${p
-00003c90: 7d2f 247b 777d 3b20 7375 646f 2063 686f  }/${w}; sudo cho
-00003ca0: 776e 2024 5553 4552 2024 703b 2064 6f6e  wn $USER $p; don
-00003cb0: 6529 2729 0a20 2020 2020 2020 205d 0a20  e)').        ]. 
-00003cc0: 2020 2020 2020 2023 2020 322e 2072 656d         #  2. rem
-00003cd0: 6f76 6520 616e 7920 6578 6973 7469 6e67  ove any existing
-00003ce0: 2073 796d 6c69 6e6b 2028 6c6e 202d 6620   symlink (ln -f 
-00003cf0: 6d61 7920 7468 726f 7720 2763 616e 6e6f  may throw 'canno
-00003d00: 740a 2020 2020 2020 2020 2320 2020 2020  t.        #     
-00003d10: 6f76 6572 7772 6974 6520 6469 7265 6374  overwrite direct
-00003d20: 6f72 7927 2c20 6966 2074 6865 206c 696e  ory', if the lin
-00003d30: 6b20 6578 6973 7473 2061 6e64 2070 6f69  k exists and poi
-00003d40: 6e74 7320 746f 2061 0a20 2020 2020 2020  nts to a.       
-00003d50: 2023 2020 2020 2064 6972 6563 746f 7279   #     directory
-00003d60: 292e 0a20 2020 2020 2020 2063 6f6d 6d61  )..        comma
-00003d70: 6e64 7320 2b3d 205b 0a20 2020 2020 2020  nds += [.       
-00003d80: 2020 2020 2023 2045 7272 6f72 206f 7574       # Error out
-00003d90: 2069 6620 736f 7572 6365 2069 7320 616e   if source is an
-00003da0: 2065 7869 7374 696e 672c 206e 6f6e 2d73   existing, non-s
-00003db0: 796d 6c69 6e6b 2064 6972 6563 746f 7279  ymlink directory
-00003dc0: 2f66 696c 652e 0a20 2020 2020 2020 2020  /file..         
-00003dd0: 2020 2066 2728 2874 6573 7420 2d4c 207b     f'((test -L {
-00003de0: 736f 7572 6365 7d20 2626 2073 7564 6f20  source} && sudo 
-00003df0: 726d 207b 736f 7572 6365 7d20 263e 2f64  rm {source} &>/d
-00003e00: 6576 2f6e 756c 6c29 207c 7c20 270a 2020  ev/null) || '.  
-00003e10: 2020 2020 2020 2020 2020 6627 2874 6573            f'(tes
-00003e20: 7420 2120 2d65 207b 736f 7572 6365 7d20  t ! -e {source} 
-00003e30: 7c7c 2027 0a20 2020 2020 2020 2020 2020  || '.           
-00003e40: 2066 2728 6563 686f 2022 2121 2120 4661   f'(echo "!!! Fa
-00003e50: 696c 6564 206d 6f75 6e74 696e 6720 6265  iled mounting be
-00003e60: 6361 7573 6520 7061 7468 2065 7869 7374  cause path exist
-00003e70: 7320 287b 736f 7572 6365 7d29 223b 2027  s ({source})"; '
-00003e80: 0a20 2020 2020 2020 2020 2020 2027 6578  .            'ex
-00003e90: 6974 2031 2929 2927 2c0a 2020 2020 2020  it 1)))',.      
-00003ea0: 2020 5d0a 2020 2020 2020 2020 636f 6d6d    ].        comm
-00003eb0: 616e 6473 202b 3d20 5b0a 2020 2020 2020  ands += [.      
-00003ec0: 2020 2020 2020 2320 4c69 6e6b 2e0a 2020        # Link..  
-00003ed0: 2020 2020 2020 2020 2020 6627 7375 646f            f'sudo
-00003ee0: 206c 6e20 2d73 207b 7461 7267 6574 7d20   ln -s {target} 
-00003ef0: 7b73 6f75 7263 657d 272c 0a20 2020 2020  {source}',.     
-00003f00: 2020 2020 2020 2023 2063 686f 776e 2e20         # chown. 
-00003f10: 202d 6820 746f 2061 6666 6563 7420 7379   -h to affect sy
-00003f20: 6d6c 696e 6b73 206f 6e6c 792e 0a20 2020  mlinks only..   
-00003f30: 2020 2020 2020 2020 2066 2773 7564 6f20           f'sudo 
-00003f40: 6368 6f77 6e20 2d68 2024 5553 4552 207b  chown -h $USER {
-00003f50: 736f 7572 6365 7d27 2c0a 2020 2020 2020  source}',.      
-00003f60: 2020 5d0a 2020 2020 2020 2020 7265 7475    ].        retu
-00003f70: 726e 2027 2026 2620 272e 6a6f 696e 2863  rn ' && '.join(c
-00003f80: 6f6d 6d61 6e64 7329 0a0a 0a63 6c61 7373  ommands)...class
-00003f90: 2053 5348 436f 6e66 6967 4865 6c70 6572   SSHConfigHelper
-00003fa0: 286f 626a 6563 7429 3a0a 2020 2020 2222  (object):.    ""
-00003fb0: 2248 656c 7065 7220 666f 7220 6861 6e64  "Helper for hand
-00003fc0: 6c69 6e67 206c 6f63 616c 2053 5348 2063  ling local SSH c
-00003fd0: 6f6e 6669 6775 7261 7469 6f6e 2e22 2222  onfiguration."""
-00003fe0: 0a0a 2020 2020 7373 685f 636f 6e66 5f70  ..    ssh_conf_p
-00003ff0: 6174 6820 3d20 277e 2f2e 7373 682f 636f  ath = '~/.ssh/co
-00004000: 6e66 6967 270a 2020 2020 7373 685f 636f  nfig'.    ssh_co
-00004010: 6e66 5f6c 6f63 6b5f 7061 7468 203d 206f  nf_lock_path = o
-00004020: 732e 7061 7468 2e65 7870 616e 6475 7365  s.path.expanduse
-00004030: 7228 277e 2f2e 736b 792f 7373 685f 636f  r('~/.sky/ssh_co
-00004040: 6e66 6967 2e6c 6f63 6b27 290a 2020 2020  nfig.lock').    
-00004050: 7373 685f 636c 7573 7465 725f 7061 7468  ssh_cluster_path
-00004060: 203d 2053 4b59 5f55 5345 525f 4649 4c45   = SKY_USER_FILE
-00004070: 5f50 4154 4820 2b20 272f 7373 682f 7b7d  _PATH + '/ssh/{}
-00004080: 270a 0a20 2020 2040 636c 6173 736d 6574  '..    @classmet
-00004090: 686f 640a 2020 2020 6465 6620 5f67 6574  hod.    def _get
-000040a0: 5f67 656e 6572 6174 6564 5f63 6f6e 6669  _generated_confi
-000040b0: 6728 636c 732c 2061 7574 6f67 656e 5f63  g(cls, autogen_c
-000040c0: 6f6d 6d65 6e74 3a20 7374 722c 2068 6f73  omment: str, hos
-000040d0: 745f 6e61 6d65 3a20 7374 722c 0a20 2020  t_name: str,.   
-000040e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000040f0: 2020 2020 2020 2020 2020 2069 703a 2073             ip: s
-00004100: 7472 2c20 7573 6572 6e61 6d65 3a20 7374  tr, username: st
-00004110: 722c 2073 7368 5f6b 6579 5f70 6174 683a  r, ssh_key_path:
-00004120: 2073 7472 2c0a 2020 2020 2020 2020 2020   str,.          
-00004130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004140: 2020 2020 7072 6f78 795f 636f 6d6d 616e      proxy_comman
-00004150: 643a 204f 7074 696f 6e61 6c5b 7374 725d  d: Optional[str]
-00004160: 2c20 706f 7274 3a20 696e 742c 0a20 2020  , port: int,.   
-00004170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004180: 2020 2020 2020 2020 2020 2064 6f63 6b65             docke
-00004190: 725f 7072 6f78 795f 636f 6d6d 616e 643a  r_proxy_command:
-000041a0: 204f 7074 696f 6e61 6c5b 7374 725d 293a   Optional[str]):
-000041b0: 0a20 2020 2020 2020 2069 6620 7072 6f78  .        if prox
-000041c0: 795f 636f 6d6d 616e 6420 6973 206e 6f74  y_command is not
-000041d0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-000041e0: 2020 2023 2041 6c72 6561 6479 2063 6865     # Already che
-000041f0: 636b 6564 2069 6e20 7265 736f 7572 6365  cked in resource
-00004200: 730a 2020 2020 2020 2020 2020 2020 6173  s.            as
-00004210: 7365 7274 2064 6f63 6b65 725f 7072 6f78  sert docker_prox
-00004220: 795f 636f 6d6d 616e 6420 6973 204e 6f6e  y_command is Non
-00004230: 652c 2028 0a20 2020 2020 2020 2020 2020  e, (.           
-00004240: 2020 2020 2027 4361 6e6e 6f74 2073 7065       'Cannot spe
-00004250: 6369 6679 2062 6f74 6820 7072 6f78 795f  cify both proxy_
-00004260: 636f 6d6d 616e 6420 616e 6420 646f 636b  command and dock
-00004270: 6572 5f70 726f 7879 5f63 6f6d 6d61 6e64  er_proxy_command
-00004280: 2e27 290a 2020 2020 2020 2020 2020 2020  .').            
-00004290: 7072 6f78 7920 3d20 6627 5072 6f78 7943  proxy = f'ProxyC
-000042a0: 6f6d 6d61 6e64 207b 7072 6f78 795f 636f  ommand {proxy_co
-000042b0: 6d6d 616e 647d 270a 2020 2020 2020 2020  mmand}'.        
-000042c0: 656c 6966 2064 6f63 6b65 725f 7072 6f78  elif docker_prox
-000042d0: 795f 636f 6d6d 616e 6420 6973 206e 6f74  y_command is not
-000042e0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-000042f0: 2020 2070 726f 7879 203d 2066 2750 726f     proxy = f'Pro
-00004300: 7879 436f 6d6d 616e 6420 7b64 6f63 6b65  xyCommand {docke
-00004310: 725f 7072 6f78 795f 636f 6d6d 616e 647d  r_proxy_command}
-00004320: 270a 2020 2020 2020 2020 656c 7365 3a0a  '.        else:.
-00004330: 2020 2020 2020 2020 2020 2020 7072 6f78              prox
-00004340: 7920 3d20 2727 0a20 2020 2020 2020 2023  y = ''.        #
-00004350: 2053 7472 6963 7448 6f73 744b 6579 4368   StrictHostKeyCh
-00004360: 6563 6b69 6e67 3d6e 6f20 736b 6970 7320  ecking=no skips 
-00004370: 7468 6520 686f 7374 206b 6579 2063 6865  the host key che
-00004380: 636b 2066 6f72 2074 6865 2066 6972 7374  ck for the first
-00004390: 0a20 2020 2020 2020 2023 2074 696d 652e  .        # time.
-000043a0: 2055 7365 724b 6e6f 776e 486f 7374 7346   UserKnownHostsF
-000043b0: 696c 653d 2f64 6576 2f6e 756c 6c20 616e  ile=/dev/null an
-000043c0: 6420 476c 6f62 616c 4b6e 6f77 6e48 6f73  d GlobalKnownHos
-000043d0: 7473 4669 6c65 2f64 6576 2f6e 756c 6c0a  tsFile/dev/null.
-000043e0: 2020 2020 2020 2020 2320 7072 6576 656e          # preven
-000043f0: 7420 7468 6520 686f 7374 206b 6579 2066  t the host key f
-00004400: 726f 6d20 6265 696e 6720 6164 6465 6420  rom being added 
-00004410: 746f 2074 6865 206b 6e6f 776e 5f68 6f73  to the known_hos
-00004420: 7473 2066 696c 6520 616e 640a 2020 2020  ts file and.    
-00004430: 2020 2020 2320 616c 7761 7973 2072 6574      # always ret
-00004440: 7572 6e20 616e 2065 6d70 7479 2066 696c  urn an empty fil
-00004450: 6520 666f 7220 6b6e 6f77 6e20 686f 7374  e for known host
-00004460: 732c 206d 616b 696e 6720 7468 6520 7373  s, making the ss
-00004470: 6820 7468 696e 6b0a 2020 2020 2020 2020  h think.        
-00004480: 2320 7468 6973 2069 7320 6120 6669 7273  # this is a firs
-00004490: 742d 7469 6d65 2063 6f6e 6e65 6374 696f  t-time connectio
-000044a0: 6e2c 2061 6e64 2074 6875 7320 736b 6970  n, and thus skip
-000044b0: 7069 6e67 2074 6865 2068 6f73 7420 6b65  ping the host ke
-000044c0: 790a 2020 2020 2020 2020 2320 6368 6563  y.        # chec
-000044d0: 6b2e 0a20 2020 2020 2020 2063 6f64 6567  k..        codeg
-000044e0: 656e 203d 2074 6578 7477 7261 702e 6465  en = textwrap.de
-000044f0: 6465 6e74 2866 2222 225c 0a20 2020 2020  dent(f"""\.     
-00004500: 2020 2020 2020 207b 6175 746f 6765 6e5f         {autogen_
-00004510: 636f 6d6d 656e 747d 0a20 2020 2020 2020  comment}.       
-00004520: 2020 2020 2048 6f73 7420 7b68 6f73 745f       Host {host_
-00004530: 6e61 6d65 7d0a 2020 2020 2020 2020 2020  name}.          
-00004540: 2020 2020 486f 7374 4e61 6d65 207b 6970      HostName {ip
-00004550: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-00004560: 5573 6572 207b 7573 6572 6e61 6d65 7d0a  User {username}.
-00004570: 2020 2020 2020 2020 2020 2020 2020 4964                Id
-00004580: 656e 7469 7479 4669 6c65 207b 7373 685f  entityFile {ssh_
-00004590: 6b65 795f 7061 7468 7d0a 2020 2020 2020  key_path}.      
-000045a0: 2020 2020 2020 2020 4964 656e 7469 7469          Identiti
-000045b0: 6573 4f6e 6c79 2079 6573 0a20 2020 2020  esOnly yes.     
-000045c0: 2020 2020 2020 2020 2046 6f72 7761 7264           Forward
-000045d0: 4167 656e 7420 7965 730a 2020 2020 2020  Agent yes.      
-000045e0: 2020 2020 2020 2020 5374 7269 6374 486f          StrictHo
-000045f0: 7374 4b65 7943 6865 636b 696e 6720 6e6f  stKeyChecking no
-00004600: 0a20 2020 2020 2020 2020 2020 2020 2055  .              U
-00004610: 7365 724b 6e6f 776e 486f 7374 7346 696c  serKnownHostsFil
-00004620: 653d 2f64 6576 2f6e 756c 6c0a 2020 2020  e=/dev/null.    
-00004630: 2020 2020 2020 2020 2020 476c 6f62 616c            Global
-00004640: 4b6e 6f77 6e48 6f73 7473 4669 6c65 3d2f  KnownHostsFile=/
-00004650: 6465 762f 6e75 6c6c 0a20 2020 2020 2020  dev/null.       
-00004660: 2020 2020 2020 2050 6f72 7420 7b70 6f72         Port {por
-00004670: 747d 0a20 2020 2020 2020 2020 2020 2020  t}.             
-00004680: 207b 7072 6f78 797d 0a20 2020 2020 2020   {proxy}.       
-00004690: 2020 2020 2022 2222 2e72 7374 7269 7028       """.rstrip(
-000046a0: 2929 0a20 2020 2020 2020 2063 6f64 6567  )).        codeg
-000046b0: 656e 203d 2063 6f64 6567 656e 202b 2027  en = codegen + '
-000046c0: 5c6e 270a 2020 2020 2020 2020 7265 7475  \n'.        retu
-000046d0: 726e 2063 6f64 6567 656e 0a0a 2020 2020  rn codegen..    
-000046e0: 4063 6c61 7373 6d65 7468 6f64 0a20 2020  @classmethod.   
-000046f0: 2040 7469 6d65 6c69 6e65 2e46 696c 654c   @timeline.FileL
-00004700: 6f63 6b45 7665 6e74 2873 7368 5f63 6f6e  ockEvent(ssh_con
-00004710: 665f 6c6f 636b 5f70 6174 6829 0a20 2020  f_lock_path).   
-00004720: 2064 6566 2061 6464 5f63 6c75 7374 6572   def add_cluster
-00004730: 280a 2020 2020 2020 2020 636c 732c 0a20  (.        cls,. 
-00004740: 2020 2020 2020 2063 6c75 7374 6572 5f6e         cluster_n
-00004750: 616d 653a 2073 7472 2c0a 2020 2020 2020  ame: str,.      
-00004760: 2020 6970 733a 204c 6973 745b 7374 725d    ips: List[str]
-00004770: 2c0a 2020 2020 2020 2020 6175 7468 5f63  ,.        auth_c
-00004780: 6f6e 6669 673a 2044 6963 745b 7374 722c  onfig: Dict[str,
-00004790: 2073 7472 5d2c 0a20 2020 2020 2020 2070   str],.        p
-000047a0: 6f72 7473 3a20 4c69 7374 5b69 6e74 5d2c  orts: List[int],
-000047b0: 0a20 2020 2020 2020 2064 6f63 6b65 725f  .        docker_
-000047c0: 7573 6572 3a20 4f70 7469 6f6e 616c 5b73  user: Optional[s
-000047d0: 7472 5d20 3d20 4e6f 6e65 2c0a 2020 2020  tr] = None,.    
-000047e0: 2020 2020 7373 685f 7573 6572 3a20 4f70      ssh_user: Op
-000047f0: 7469 6f6e 616c 5b73 7472 5d20 3d20 4e6f  tional[str] = No
-00004800: 6e65 2c0a 2020 2020 293a 0a20 2020 2020  ne,.    ):.     
-00004810: 2020 2022 2222 4164 6420 6175 7468 656e     """Add authen
-00004820: 7469 6361 7469 6f6e 2069 6e66 6f72 6d61  tication informa
-00004830: 7469 6f6e 2066 6f72 2063 6c75 7374 6572  tion for cluster
-00004840: 2074 6f20 6c6f 6361 6c20 5353 4820 636f   to local SSH co
-00004850: 6e66 6967 2066 696c 652e 0a0a 2020 2020  nfig file...    
-00004860: 2020 2020 4966 2061 2068 6f73 7420 7769      If a host wi
-00004870: 7468 2060 636c 7573 7465 725f 6e61 6d65  th `cluster_name
-00004880: 6020 616c 7265 6164 7920 6578 6973 7473  ` already exists
-00004890: 2061 6e64 2074 6865 2063 6f6e 6669 6775   and the configu
-000048a0: 7261 7469 6f6e 2077 6173 0a20 2020 2020  ration was.     
-000048b0: 2020 206e 6f74 2061 6464 6564 2062 7920     not added by 
-000048c0: 736b 792c 2074 6865 6e20 6069 7060 2069  sky, then `ip` i
-000048d0: 7320 7573 6564 2074 6f20 6964 656e 7469  s used to identi
-000048e0: 6679 2074 6865 2068 6f73 7420 696e 7374  fy the host inst
-000048f0: 6561 6420 696e 2074 6865 0a20 2020 2020  ead in the.     
-00004900: 2020 2066 696c 652e 0a0a 2020 2020 2020     file...      
-00004910: 2020 4966 2061 2068 6f73 7420 7769 7468    If a host with
-00004920: 2060 636c 7573 7465 725f 6e61 6d65 6020   `cluster_name` 
-00004930: 616c 7265 6164 7920 6578 6973 7473 2061  already exists a
-00004940: 6e64 2074 6865 2063 6f6e 6669 6775 7261  nd the configura
-00004950: 7469 6f6e 2077 6173 0a20 2020 2020 2020  tion was.       
-00004960: 2061 6464 6564 2062 7920 736b 7920 2865   added by sky (e
-00004970: 2e67 2e20 6120 7370 6f74 2069 6e73 7461  .g. a spot insta
-00004980: 6e63 6529 2c20 7468 656e 2074 6865 2063  nce), then the c
-00004990: 6f6e 6669 6775 7261 7469 6f6e 2069 730a  onfiguration is.
-000049a0: 2020 2020 2020 2020 6f76 6572 7772 6974          overwrit
-000049b0: 7465 6e2e 0a0a 2020 2020 2020 2020 4172  ten...        Ar
-000049c0: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
-000049d0: 636c 7573 7465 725f 6e61 6d65 3a20 436c  cluster_name: Cl
-000049e0: 7573 7465 7220 6e61 6d65 2028 7365 6520  uster name (see 
-000049f0: 6073 6b79 2073 7461 7475 7360 290a 2020  `sky status`).  
-00004a00: 2020 2020 2020 2020 2020 6970 733a 204c            ips: L
-00004a10: 6973 7420 6f66 2070 7562 6c69 6320 4950  ist of public IP
-00004a20: 2061 6464 7265 7373 6573 2069 6e20 7468   addresses in th
-00004a30: 6520 636c 7573 7465 722e 2046 6972 7374  e cluster. First
-00004a40: 2049 5020 6973 2068 6561 640a 2020 2020   IP is head.    
-00004a50: 2020 2020 2020 2020 2020 6e6f 6465 2e0a            node..
-00004a60: 2020 2020 2020 2020 2020 2020 6175 7468              auth
-00004a70: 5f63 6f6e 6669 673a 2072 6561 645f 7961  _config: read_ya
-00004a80: 6d6c 2868 616e 646c 652e 636c 7573 7465  ml(handle.cluste
-00004a90: 725f 7961 6d6c 295b 2761 7574 6827 5d0a  r_yaml)['auth'].
-00004aa0: 2020 2020 2020 2020 2020 2020 706f 7274              port
-00004ab0: 733a 204c 6973 7420 6f66 2070 6f72 7420  s: List of port 
-00004ac0: 6e75 6d62 6572 7320 666f 7220 5353 4820  numbers for SSH 
-00004ad0: 636f 7272 6573 706f 6e64 696e 6720 746f  corresponding to
-00004ae0: 2069 7073 0a20 2020 2020 2020 2020 2020   ips.           
-00004af0: 2064 6f63 6b65 725f 7573 6572 3a20 4966   docker_user: If
-00004b00: 206e 6f74 204e 6f6e 652c 2075 7365 2074   not None, use t
-00004b10: 6869 7320 7573 6572 2074 6f20 7373 6820  his user to ssh 
-00004b20: 696e 746f 2074 6865 2064 6f63 6b65 720a  into the docker.
-00004b30: 2020 2020 2020 2020 2020 2020 7373 685f              ssh_
-00004b40: 7573 6572 3a20 4f76 6572 7269 6465 2074  user: Override t
-00004b50: 6865 2073 7368 5f75 7365 7220 696e 2061  he ssh_user in a
-00004b60: 7574 685f 636f 6e66 6967 0a20 2020 2020  uth_config.     
-00004b70: 2020 2022 2222 0a20 2020 2020 2020 2069     """.        i
-00004b80: 6620 7373 685f 7573 6572 2069 7320 4e6f  f ssh_user is No
-00004b90: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00004ba0: 7573 6572 6e61 6d65 203d 2061 7574 685f  username = auth_
-00004bb0: 636f 6e66 6967 5b27 7373 685f 7573 6572  config['ssh_user
-00004bc0: 275d 0a20 2020 2020 2020 2065 6c73 653a  '].        else:
-00004bd0: 0a20 2020 2020 2020 2020 2020 2075 7365  .            use
-00004be0: 726e 616d 6520 3d20 7373 685f 7573 6572  rname = ssh_user
-00004bf0: 0a20 2020 2020 2020 2069 6620 646f 636b  .        if dock
-00004c00: 6572 5f75 7365 7220 6973 206e 6f74 204e  er_user is not N
-00004c10: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00004c20: 2075 7365 726e 616d 6520 3d20 646f 636b   username = dock
-00004c30: 6572 5f75 7365 720a 2020 2020 2020 2020  er_user.        
-00004c40: 6b65 795f 7061 7468 203d 206f 732e 7061  key_path = os.pa
-00004c50: 7468 2e65 7870 616e 6475 7365 7228 6175  th.expanduser(au
-00004c60: 7468 5f63 6f6e 6669 675b 2773 7368 5f70  th_config['ssh_p
-00004c70: 7269 7661 7465 5f6b 6579 275d 290a 2020  rivate_key']).  
-00004c80: 2020 2020 2020 736b 795f 6175 746f 6765        sky_autoge
-00004c90: 6e5f 636f 6d6d 656e 7420 3d20 2827 2320  n_comment = ('# 
-00004ca0: 4164 6465 6420 6279 2073 6b79 2028 7573  Added by sky (us
-00004cb0: 6520 6073 6b79 2073 746f 702f 646f 776e  e `sky stop/down
-00004cc0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-00004cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004ce0: 2020 6627 7b63 6c75 7374 6572 5f6e 616d    f'{cluster_nam
-00004cf0: 657d 6020 746f 2072 656d 6f76 6529 2729  e}` to remove)')
-00004d00: 0a20 2020 2020 2020 2069 7020 3d20 6970  .        ip = ip
-00004d10: 735b 305d 0a20 2020 2020 2020 2069 6620  s[0].        if 
-00004d20: 646f 636b 6572 5f75 7365 7220 6973 206e  docker_user is n
-00004d30: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00004d40: 2020 2020 2069 7020 3d20 276c 6f63 616c       ip = 'local
-00004d50: 686f 7374 270a 0a20 2020 2020 2020 2063  host'..        c
-00004d60: 6f6e 6669 675f 7061 7468 203d 206f 732e  onfig_path = os.
-00004d70: 7061 7468 2e65 7870 616e 6475 7365 7228  path.expanduser(
-00004d80: 636c 732e 7373 685f 636f 6e66 5f70 6174  cls.ssh_conf_pat
-00004d90: 6829 0a0a 2020 2020 2020 2020 2320 466f  h)..        # Fo
-00004da0: 7220 6261 636b 7761 7264 2063 6f6d 7061  r backward compa
-00004db0: 7469 6269 6c69 7479 3a20 6265 666f 7265  tibility: before
-00004dc0: 2023 3237 3036 2c20 7765 2077 726f 7465   #2706, we wrote
-00004dd0: 2074 6865 2063 6f6e 6669 6720 6f66 2053   the config of S
-00004de0: 6b79 5069 6c6f 7420 636c 7573 7465 7273  kyPilot clusters
-00004df0: 0a20 2020 2020 2020 2023 2064 6972 6563  .        # direc
-00004e00: 746c 7920 696e 207e 2f2e 7373 682f 636f  tly in ~/.ssh/co
-00004e10: 6e66 6967 2e20 466f 7220 7468 6573 6520  nfig. For these 
-00004e20: 636c 7573 7465 7273 2c20 7765 2072 656d  clusters, we rem
-00004e30: 6f76 6520 7468 6520 636f 6e66 6967 2069  ove the config i
-00004e40: 6e20 7e2f 2e73 7368 2f63 6f6e 6669 670a  n ~/.ssh/config.
-00004e50: 2020 2020 2020 2020 2320 616e 6420 7772          # and wr
-00004e60: 6974 652f 6f76 6572 7772 6974 6520 7468  ite/overwrite th
-00004e70: 6520 636f 6e66 6967 2069 6e20 7e2f 2e73  e config in ~/.s
-00004e80: 6b79 2f73 7368 2f3c 636c 7573 7465 725f  ky/ssh/<cluster_
-00004e90: 6e61 6d65 3e20 696e 7374 6561 642e 0a20  name> instead.. 
-00004ea0: 2020 2020 2020 2063 6c73 2e5f 7265 6d6f         cls._remo
-00004eb0: 7665 5f73 7461 6c65 5f63 6c75 7374 6572  ve_stale_cluster
-00004ec0: 5f63 6f6e 6669 675f 666f 725f 6261 636b  _config_for_back
-00004ed0: 7761 7264 5f63 6f6d 7061 7469 6269 6c69  ward_compatibili
-00004ee0: 7479 280a 2020 2020 2020 2020 2020 2020  ty(.            
-00004ef0: 636c 7573 7465 725f 6e61 6d65 2c20 6970  cluster_name, ip
-00004f00: 2c20 6175 7468 5f63 6f6e 6669 672c 2064  , auth_config, d
-00004f10: 6f63 6b65 725f 7573 6572 290a 0a20 2020  ocker_user)..   
-00004f20: 2020 2020 2069 6620 6e6f 7420 6f73 2e70       if not os.p
-00004f30: 6174 682e 6578 6973 7473 2863 6f6e 6669  ath.exists(confi
-00004f40: 675f 7061 7468 293a 0a20 2020 2020 2020  g_path):.       
-00004f50: 2020 2020 2063 6f6e 6669 6720 3d20 5b27       config = ['
-00004f60: 5c6e 275d 0a20 2020 2020 2020 2020 2020  \n'].           
-00004f70: 2077 6974 6820 6f70 656e 2863 6f6e 6669   with open(confi
-00004f80: 675f 7061 7468 2c0a 2020 2020 2020 2020  g_path,.        
-00004f90: 2020 2020 2020 2020 2020 2020 2020 2777                'w
-00004fa0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00004fb0: 2020 2020 2020 2020 2065 6e63 6f64 696e           encodin
-00004fc0: 673d 2775 7466 2d38 272c 0a20 2020 2020  g='utf-8',.     
-00004fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004fe0: 206f 7065 6e65 723d 6675 6e63 746f 6f6c   opener=functool
-00004ff0: 732e 7061 7274 6961 6c28 6f73 2e6f 7065  s.partial(os.ope
-00005000: 6e2c 206d 6f64 653d 306f 3634 3429 2920  n, mode=0o644)) 
-00005010: 6173 2066 3a0a 2020 2020 2020 2020 2020  as f:.          
-00005020: 2020 2020 2020 662e 7772 6974 656c 696e        f.writelin
-00005030: 6573 2863 6f6e 6669 6729 0a0a 2020 2020  es(config)..    
-00005040: 2020 2020 7769 7468 206f 7065 6e28 636f      with open(co
-00005050: 6e66 6967 5f70 6174 682c 2027 7227 2c20  nfig_path, 'r', 
-00005060: 656e 636f 6469 6e67 3d27 7574 662d 3827  encoding='utf-8'
-00005070: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
-00005080: 2020 2020 636f 6e66 6967 203d 2066 2e72      config = f.r
-00005090: 6561 646c 696e 6573 2829 0a0a 2020 2020  eadlines()..    
-000050a0: 2020 2020 7373 685f 6469 7220 3d20 636c      ssh_dir = cl
-000050b0: 732e 7373 685f 636c 7573 7465 725f 7061  s.ssh_cluster_pa
-000050c0: 7468 2e66 6f72 6d61 7428 2727 290a 2020  th.format('').  
-000050d0: 2020 2020 2020 6f73 2e6d 616b 6564 6972        os.makedir
-000050e0: 7328 6f73 2e70 6174 682e 6578 7061 6e64  s(os.path.expand
-000050f0: 7573 6572 2873 7368 5f64 6972 292c 2065  user(ssh_dir), e
-00005100: 7869 7374 5f6f 6b3d 5472 7565 2c20 6d6f  xist_ok=True, mo
-00005110: 6465 3d30 6f37 3030 290a 0a20 2020 2020  de=0o700)..     
-00005120: 2020 2023 2048 616e 646c 6520 496e 636c     # Handle Incl
-00005130: 7564 6520 6f6e 2074 6f70 206f 6620 436f  ude on top of Co
-00005140: 6e66 6967 2066 696c 650a 2020 2020 2020  nfig file.      
-00005150: 2020 696e 636c 7564 655f 7374 7220 3d20    include_str = 
-00005160: 6627 496e 636c 7564 6520 7b63 6c73 2e73  f'Include {cls.s
-00005170: 7368 5f63 6c75 7374 6572 5f70 6174 682e  sh_cluster_path.
-00005180: 666f 726d 6174 2822 2a22 297d 270a 2020  format("*")}'.  
-00005190: 2020 2020 2020 666f 756e 6420 3d20 4661        found = Fa
-000051a0: 6c73 650a 2020 2020 2020 2020 666f 7220  lse.        for 
-000051b0: 692c 206c 696e 6520 696e 2065 6e75 6d65  i, line in enume
-000051c0: 7261 7465 2863 6f6e 6669 6729 3a0a 2020  rate(config):.  
-000051d0: 2020 2020 2020 2020 2020 636f 6e66 6967            config
-000051e0: 5f73 7472 203d 206c 696e 652e 7374 7269  _str = line.stri
-000051f0: 7028 290a 2020 2020 2020 2020 2020 2020  p().            
-00005200: 6966 2063 6f6e 6669 675f 7374 7220 3d3d  if config_str ==
-00005210: 2069 6e63 6c75 6465 5f73 7472 3a0a 2020   include_str:.  
-00005220: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00005230: 756e 6420 3d20 5472 7565 0a20 2020 2020  und = True.     
-00005240: 2020 2020 2020 2020 2020 2062 7265 616b             break
-00005250: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00005260: 2748 6f73 7427 2069 6e20 636f 6e66 6967  'Host' in config
-00005270: 5f73 7472 3a0a 2020 2020 2020 2020 2020  _str:.          
-00005280: 2020 2020 2020 6272 6561 6b0a 2020 2020        break.    
-00005290: 2020 2020 6966 206e 6f74 2066 6f75 6e64      if not found
-000052a0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-000052b0: 4469 6420 6e6f 7420 6669 6e64 2049 6e63  Did not find Inc
-000052c0: 6c75 6465 2073 7472 696e 672e 2049 6e73  lude string. Ins
-000052d0: 6572 7420 6049 6e63 6c75 6465 6020 6c69  ert `Include` li
-000052e0: 6e65 732e 0a20 2020 2020 2020 2020 2020  nes..           
-000052f0: 2077 6974 6820 6f70 656e 2863 6f6e 6669   with open(confi
-00005300: 675f 7061 7468 2c20 2777 272c 2065 6e63  g_path, 'w', enc
-00005310: 6f64 696e 673d 2775 7466 2d38 2729 2061  oding='utf-8') a
-00005320: 7320 663a 0a20 2020 2020 2020 2020 2020  s f:.           
-00005330: 2020 2020 2063 6f6e 6669 672e 696e 7365       config.inse
-00005340: 7274 280a 2020 2020 2020 2020 2020 2020  rt(.            
-00005350: 2020 2020 2020 2020 302c 0a20 2020 2020          0,.     
-00005360: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00005370: 2723 2041 6464 6564 2062 7920 536b 7950  '# Added by SkyP
-00005380: 696c 6f74 2066 6f72 2073 7368 2063 6f6e  ilot for ssh con
-00005390: 6669 6720 6f66 2061 6c6c 2063 6c75 7374  fig of all clust
-000053a0: 6572 735c 6e7b 696e 636c 7564 655f 7374  ers\n{include_st
-000053b0: 727d 5c6e 270a 2020 2020 2020 2020 2020  r}\n'.          
-000053c0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000053d0: 2020 2020 2020 2020 662e 7772 6974 6528          f.write(
-000053e0: 2727 2e6a 6f69 6e28 636f 6e66 6967 292e  ''.join(config).
-000053f0: 7374 7269 7028 2929 0a20 2020 2020 2020  strip()).       
-00005400: 2020 2020 2020 2020 2066 2e77 7269 7465           f.write
-00005410: 2827 5c6e 2720 2a20 3229 0a0a 2020 2020  ('\n' * 2)..    
-00005420: 2020 2020 7072 6f78 795f 636f 6d6d 616e      proxy_comman
-00005430: 6420 3d20 6175 7468 5f63 6f6e 6669 672e  d = auth_config.
-00005440: 6765 7428 2773 7368 5f70 726f 7879 5f63  get('ssh_proxy_c
-00005450: 6f6d 6d61 6e64 272c 204e 6f6e 6529 0a0a  ommand', None)..
-00005460: 2020 2020 2020 2020 646f 636b 6572 5f70          docker_p
-00005470: 726f 7879 5f63 6f6d 6d61 6e64 5f67 656e  roxy_command_gen
-00005480: 6572 6174 6f72 203d 204e 6f6e 650a 2020  erator = None.  
-00005490: 2020 2020 2020 6966 2064 6f63 6b65 725f        if docker_
-000054a0: 7573 6572 2069 7320 6e6f 7420 4e6f 6e65  user is not None
-000054b0: 3a0a 2020 2020 2020 2020 2020 2020 646f  :.            do
-000054c0: 636b 6572 5f70 726f 7879 5f63 6f6d 6d61  cker_proxy_comma
-000054d0: 6e64 5f67 656e 6572 6174 6f72 203d 206c  nd_generator = l
-000054e0: 616d 6264 6120 6970 2c20 706f 7274 3a20  ambda ip, port: 
-000054f0: 2720 272e 6a6f 696e 280a 2020 2020 2020  ' '.join(.      
-00005500: 2020 2020 2020 2020 2020 5b27 7373 6827            ['ssh'
-00005510: 5d20 2b20 636f 6d6d 616e 645f 7275 6e6e  ] + command_runn
-00005520: 6572 2e73 7368 5f6f 7074 696f 6e73 5f6c  er.ssh_options_l
-00005530: 6973 7428 0a20 2020 2020 2020 2020 2020  ist(.           
-00005540: 2020 2020 2020 2020 206b 6579 5f70 6174           key_pat
-00005550: 682c 2073 7368 5f63 6f6e 7472 6f6c 5f6e  h, ssh_control_n
-00005560: 616d 653d 4e6f 6e65 2c20 706f 7274 3d70  ame=None, port=p
-00005570: 6f72 7429 202b 0a20 2020 2020 2020 2020  ort) +.         
-00005580: 2020 2020 2020 205b 272d 5727 2c20 2725         ['-W', '%
-00005590: 683a 2570 272c 2066 277b 6175 7468 5f63  h:%p', f'{auth_c
-000055a0: 6f6e 6669 675b 2273 7368 5f75 7365 7222  onfig["ssh_user"
-000055b0: 5d7d 407b 6970 7d27 5d29 0a0a 2020 2020  ]}@{ip}'])..    
-000055c0: 2020 2020 636f 6465 6765 6e20 3d20 2727      codegen = ''
-000055d0: 0a20 2020 2020 2020 2023 2041 6464 2074  .        # Add t
-000055e0: 6865 206e 6f64 6573 2074 6f20 7468 6520  he nodes to the 
-000055f0: 636f 6465 6765 6e0a 2020 2020 2020 2020  codegen.        
-00005600: 666f 7220 692c 2069 7020 696e 2065 6e75  for i, ip in enu
-00005610: 6d65 7261 7465 2869 7073 293a 0a20 2020  merate(ips):.   
-00005620: 2020 2020 2020 2020 2064 6f63 6b65 725f           docker_
-00005630: 7072 6f78 795f 636f 6d6d 616e 6420 3d20  proxy_command = 
-00005640: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-00005650: 2070 6f72 7420 3d20 706f 7274 735b 695d   port = ports[i]
-00005660: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00005670: 646f 636b 6572 5f70 726f 7879 5f63 6f6d  docker_proxy_com
-00005680: 6d61 6e64 5f67 656e 6572 6174 6f72 2069  mand_generator i
-00005690: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-000056a0: 2020 2020 2020 2020 2020 2020 646f 636b              dock
-000056b0: 6572 5f70 726f 7879 5f63 6f6d 6d61 6e64  er_proxy_command
-000056c0: 203d 2064 6f63 6b65 725f 7072 6f78 795f   = docker_proxy_
-000056d0: 636f 6d6d 616e 645f 6765 6e65 7261 746f  command_generato
-000056e0: 7228 6970 2c20 706f 7274 290a 2020 2020  r(ip, port).    
-000056f0: 2020 2020 2020 2020 2020 2020 6970 203d              ip =
-00005700: 2027 6c6f 6361 6c68 6f73 7427 0a20 2020   'localhost'.   
-00005710: 2020 2020 2020 2020 2020 2020 2070 6f72               por
-00005720: 7420 3d20 636f 6e73 7461 6e74 732e 4445  t = constants.DE
-00005730: 4641 554c 545f 444f 434b 4552 5f50 4f52  FAULT_DOCKER_POR
-00005740: 540a 2020 2020 2020 2020 2020 2020 6e6f  T.            no
-00005750: 6465 5f6e 616d 6520 3d20 636c 7573 7465  de_name = cluste
-00005760: 725f 6e61 6d65 2069 6620 6920 3d3d 2030  r_name if i == 0
-00005770: 2065 6c73 6520 636c 7573 7465 725f 6e61   else cluster_na
-00005780: 6d65 202b 2066 272d 776f 726b 6572 7b69  me + f'-worker{i
-00005790: 7d27 0a20 2020 2020 2020 2020 2020 2023  }'.            #
-000057a0: 2054 4f44 4f28 726f 6d69 6c62 293a 2055   TODO(romilb): U
-000057b0: 7064 6174 6520 706f 7274 206e 756d 6265  pdate port numbe
-000057c0: 7220 7768 656e 206b 3873 2073 7570 706f  r when k8s suppo
-000057d0: 7274 7320 6d75 6c74 696e 6f64 650a 2020  rts multinode.  
-000057e0: 2020 2020 2020 2020 2020 636f 6465 6765            codege
-000057f0: 6e20 2b3d 2063 6c73 2e5f 6765 745f 6765  n += cls._get_ge
-00005800: 6e65 7261 7465 645f 636f 6e66 6967 280a  nerated_config(.
-00005810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005820: 736b 795f 6175 746f 6765 6e5f 636f 6d6d  sky_autogen_comm
-00005830: 656e 742c 206e 6f64 655f 6e61 6d65 2c20  ent, node_name, 
-00005840: 6970 2c20 7573 6572 6e61 6d65 2c20 6b65  ip, username, ke
-00005850: 795f 7061 7468 2c0a 2020 2020 2020 2020  y_path,.        
-00005860: 2020 2020 2020 2020 7072 6f78 795f 636f          proxy_co
-00005870: 6d6d 616e 642c 2070 6f72 742c 2064 6f63  mmand, port, doc
-00005880: 6b65 725f 7072 6f78 795f 636f 6d6d 616e  ker_proxy_comman
-00005890: 6429 202b 2027 5c6e 270a 0a20 2020 2020  d) + '\n'..     
-000058a0: 2020 2063 6c75 7374 6572 5f63 6f6e 6669     cluster_confi
-000058b0: 675f 7061 7468 203d 206f 732e 7061 7468  g_path = os.path
-000058c0: 2e65 7870 616e 6475 7365 7228 0a20 2020  .expanduser(.   
-000058d0: 2020 2020 2020 2020 2063 6c73 2e73 7368           cls.ssh
-000058e0: 5f63 6c75 7374 6572 5f70 6174 682e 666f  _cluster_path.fo
-000058f0: 726d 6174 2863 6c75 7374 6572 5f6e 616d  rmat(cluster_nam
-00005900: 6529 290a 0a20 2020 2020 2020 2077 6974  e))..        wit
-00005910: 6820 6f70 656e 2863 6c75 7374 6572 5f63  h open(cluster_c
-00005920: 6f6e 6669 675f 7061 7468 2c0a 2020 2020  onfig_path,.    
-00005930: 2020 2020 2020 2020 2020 2020 2020 2777                'w
-00005940: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00005950: 2020 2020 2065 6e63 6f64 696e 673d 2775       encoding='u
-00005960: 7466 2d38 272c 0a20 2020 2020 2020 2020  tf-8',.         
-00005970: 2020 2020 2020 2020 206f 7065 6e65 723d           opener=
-00005980: 6675 6e63 746f 6f6c 732e 7061 7274 6961  functools.partia
-00005990: 6c28 6f73 2e6f 7065 6e2c 206d 6f64 653d  l(os.open, mode=
-000059a0: 306f 3634 3429 2920 6173 2066 3a0a 2020  0o644)) as f:.  
-000059b0: 2020 2020 2020 2020 2020 662e 7772 6974            f.writ
-000059c0: 6528 636f 6465 6765 6e29 0a0a 2020 2020  e(codegen)..    
-000059d0: 4063 6c61 7373 6d65 7468 6f64 0a20 2020  @classmethod.   
-000059e0: 2064 6566 205f 7265 6d6f 7665 5f73 7461   def _remove_sta
-000059f0: 6c65 5f63 6c75 7374 6572 5f63 6f6e 6669  le_cluster_confi
-00005a00: 675f 666f 725f 6261 636b 7761 7264 5f63  g_for_backward_c
-00005a10: 6f6d 7061 7469 6269 6c69 7479 280a 2020  ompatibility(.  
-00005a20: 2020 2020 2020 636c 732c 0a20 2020 2020        cls,.     
-00005a30: 2020 2063 6c75 7374 6572 5f6e 616d 653a     cluster_name:
-00005a40: 2073 7472 2c0a 2020 2020 2020 2020 6970   str,.        ip
-00005a50: 3a20 7374 722c 0a20 2020 2020 2020 2061  : str,.        a
-00005a60: 7574 685f 636f 6e66 6967 3a20 4469 6374  uth_config: Dict
-00005a70: 5b73 7472 2c20 7374 725d 2c0a 2020 2020  [str, str],.    
-00005a80: 2020 2020 646f 636b 6572 5f75 7365 723a      docker_user:
-00005a90: 204f 7074 696f 6e61 6c5b 7374 725d 203d   Optional[str] =
-00005aa0: 204e 6f6e 652c 0a20 2020 2029 3a0a 2020   None,.    ):.  
-00005ab0: 2020 2020 2020 2222 2252 656d 6f76 6520        """Remove 
-00005ac0: 6175 7468 656e 7469 6361 7469 6f6e 2069  authentication i
-00005ad0: 6e66 6f72 6d61 7469 6f6e 2066 6f72 2063  nformation for c
-00005ae0: 6c75 7374 6572 2066 726f 6d20 6c6f 6361  luster from loca
-00005af0: 6c20 5353 4820 636f 6e66 6967 2e0a 0a20  l SSH config... 
-00005b00: 2020 2020 2020 2049 6620 6e6f 2065 7869         If no exi
-00005b10: 7374 696e 6720 686f 7374 206d 6174 6368  sting host match
-00005b20: 696e 6720 7468 6520 7072 6f76 6964 6564  ing the provided
-00005b30: 2073 7065 6369 6669 6361 7469 6f6e 2069   specification i
-00005b40: 7320 666f 756e 642c 2074 6865 6e0a 2020  s found, then.  
-00005b50: 2020 2020 2020 6e6f 7468 696e 6720 6973        nothing is
-00005b60: 2072 656d 6f76 6564 2e0a 0a20 2020 2020   removed...     
-00005b70: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
-00005b80: 2020 2020 2069 703a 2048 6561 6420 6e6f       ip: Head no
-00005b90: 6465 2773 2049 5020 6164 6472 6573 732e  de's IP address.
-00005ba0: 0a20 2020 2020 2020 2020 2020 2061 7574  .            aut
-00005bb0: 685f 636f 6e66 6967 3a20 7265 6164 5f79  h_config: read_y
-00005bc0: 616d 6c28 6861 6e64 6c65 2e63 6c75 7374  aml(handle.clust
-00005bd0: 6572 5f79 616d 6c29 5b27 6175 7468 275d  er_yaml)['auth']
-00005be0: 0a20 2020 2020 2020 2020 2020 2064 6f63  .            doc
-00005bf0: 6b65 725f 7573 6572 3a20 4966 206e 6f74  ker_user: If not
-00005c00: 204e 6f6e 652c 2075 7365 2074 6869 7320   None, use this 
-00005c10: 7573 6572 2074 6f20 7373 6820 696e 746f  user to ssh into
-00005c20: 2074 6865 2064 6f63 6b65 720a 2020 2020   the docker.    
-00005c30: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00005c40: 7573 6572 6e61 6d65 203d 2061 7574 685f  username = auth_
-00005c50: 636f 6e66 6967 5b27 7373 685f 7573 6572  config['ssh_user
-00005c60: 275d 0a20 2020 2020 2020 2063 6f6e 6669  '].        confi
-00005c70: 675f 7061 7468 203d 206f 732e 7061 7468  g_path = os.path
-00005c80: 2e65 7870 616e 6475 7365 7228 636c 732e  .expanduser(cls.
-00005c90: 7373 685f 636f 6e66 5f70 6174 6829 0a20  ssh_conf_path). 
-00005ca0: 2020 2020 2020 2063 6c75 7374 6572 5f63         cluster_c
-00005cb0: 6f6e 6669 675f 7061 7468 203d 206f 732e  onfig_path = os.
-00005cc0: 7061 7468 2e65 7870 616e 6475 7365 7228  path.expanduser(
-00005cd0: 0a20 2020 2020 2020 2020 2020 2063 6c73  .            cls
-00005ce0: 2e73 7368 5f63 6c75 7374 6572 5f70 6174  .ssh_cluster_pat
-00005cf0: 682e 666f 726d 6174 2863 6c75 7374 6572  h.format(cluster
-00005d00: 5f6e 616d 6529 290a 2020 2020 2020 2020  _name)).        
-00005d10: 6966 206e 6f74 206f 732e 7061 7468 2e65  if not os.path.e
-00005d20: 7869 7374 7328 636f 6e66 6967 5f70 6174  xists(config_pat
-00005d30: 6829 3a0a 2020 2020 2020 2020 2020 2020  h):.            
-00005d40: 7265 7475 726e 0a0a 2020 2020 2020 2020  return..        
-00005d50: 7769 7468 206f 7065 6e28 636f 6e66 6967  with open(config
-00005d60: 5f70 6174 682c 2027 7227 2c20 656e 636f  _path, 'r', enco
-00005d70: 6469 6e67 3d27 7574 662d 3827 2920 6173  ding='utf-8') as
-00005d80: 2066 3a0a 2020 2020 2020 2020 2020 2020   f:.            
-00005d90: 636f 6e66 6967 203d 2066 2e72 6561 646c  config = f.readl
-00005da0: 696e 6573 2829 0a0a 2020 2020 2020 2020  ines()..        
-00005db0: 7374 6172 745f 6c69 6e65 5f69 6478 203d  start_line_idx =
-00005dc0: 204e 6f6e 650a 0a20 2020 2020 2020 2023   None..        #
-00005dd0: 2053 6361 6e20 7468 6520 636f 6e66 6967   Scan the config
-00005de0: 2066 6f72 2074 6865 2063 6c75 7374 6572   for the cluster
-00005df0: 206e 616d 652e 0a20 2020 2020 2020 2066   name..        f
-00005e00: 6f72 2069 2c20 6c69 6e65 2069 6e20 656e  or i, line in en
-00005e10: 756d 6572 6174 6528 636f 6e66 6967 293a  umerate(config):
-00005e20: 0a20 2020 2020 2020 2020 2020 206e 6578  .            nex
-00005e30: 745f 6c69 6e65 203d 2063 6f6e 6669 675b  t_line = config[
-00005e40: 6920 2b20 315d 2069 6620 6920 2b20 3120  i + 1] if i + 1 
-00005e50: 3c20 6c65 6e28 636f 6e66 6967 2920 656c  < len(config) el
-00005e60: 7365 2027 270a 2020 2020 2020 2020 2020  se ''.          
-00005e70: 2020 6966 2064 6f63 6b65 725f 7573 6572    if docker_user
-00005e80: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-00005e90: 2020 2020 2020 2020 2020 666f 756e 6420            found 
-00005ea0: 3d20 286c 696e 652e 7374 7269 7028 2920  = (line.strip() 
-00005eb0: 3d3d 2066 2748 6f73 744e 616d 6520 7b69  == f'HostName {i
-00005ec0: 707d 2720 616e 640a 2020 2020 2020 2020  p}' and.        
-00005ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005ee0: 206e 6578 745f 6c69 6e65 2e73 7472 6970   next_line.strip
-00005ef0: 2829 203d 3d20 6627 5573 6572 207b 7573  () == f'User {us
-00005f00: 6572 6e61 6d65 7d27 290a 2020 2020 2020  ername}').      
-00005f10: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00005f20: 2020 2020 2020 2020 2020 2020 666f 756e              foun
-00005f30: 6420 3d20 286c 696e 652e 7374 7269 7028  d = (line.strip(
-00005f40: 2920 3d3d 2027 486f 7374 4e61 6d65 206c  ) == 'HostName l
-00005f50: 6f63 616c 686f 7374 2720 616e 640a 2020  ocalhost' and.  
-00005f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005f70: 2020 2020 2020 206e 6578 745f 6c69 6e65         next_line
-00005f80: 2e73 7472 6970 2829 203d 3d20 6627 5573  .strip() == f'Us
-00005f90: 6572 207b 646f 636b 6572 5f75 7365 727d  er {docker_user}
-00005fa0: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
-00005fb0: 2020 2069 6620 666f 756e 643a 0a20 2020     if found:.   
+00000060: 7420 666e 6d61 7463 680a 696d 706f 7274  t fnmatch.import
+00000070: 2066 756e 6374 6f6f 6c73 0a69 6d70 6f72   functools.impor
+00000080: 7420 6f73 0a69 6d70 6f72 7420 7061 7468  t os.import path
+00000090: 6c69 620a 696d 706f 7274 2070 7072 696e  lib.import pprin
+000000a0: 740a 696d 706f 7274 2072 650a 696d 706f  t.import re.impo
+000000b0: 7274 2073 686c 6578 0a69 6d70 6f72 7420  rt shlex.import 
+000000c0: 7375 6270 726f 6365 7373 0a69 6d70 6f72  subprocess.impor
+000000d0: 7420 7379 730a 696d 706f 7274 2074 656d  t sys.import tem
+000000e0: 7066 696c 650a 696d 706f 7274 2074 6578  pfile.import tex
+000000f0: 7477 7261 700a 696d 706f 7274 2074 696d  twrap.import tim
+00000100: 650a 696d 706f 7274 2074 7970 696e 670a  e.import typing.
+00000110: 6672 6f6d 2074 7970 696e 6720 696d 706f  from typing impo
+00000120: 7274 2041 6e79 2c20 4469 6374 2c20 4c69  rt Any, Dict, Li
+00000130: 7374 2c20 4f70 7469 6f6e 616c 2c20 5365  st, Optional, Se
+00000140: 7175 656e 6365 2c20 5365 742c 2054 7570  quence, Set, Tup
+00000150: 6c65 2c20 556e 696f 6e0a 696d 706f 7274  le, Union.import
+00000160: 2075 7569 640a 0a69 6d70 6f72 7420 636f   uuid..import co
+00000170: 6c6f 7261 6d61 0a69 6d70 6f72 7420 6669  lorama.import fi
+00000180: 6c65 6c6f 636b 0a66 726f 6d20 7061 636b  lelock.from pack
+00000190: 6167 696e 6720 696d 706f 7274 2076 6572  aging import ver
+000001a0: 7369 6f6e 0a69 6d70 6f72 7420 7265 7175  sion.import requ
+000001b0: 6573 7473 0a66 726f 6d20 7265 7175 6573  ests.from reques
+000001c0: 7473 2069 6d70 6f72 7420 6164 6170 7465  ts import adapte
+000001d0: 7273 0a66 726f 6d20 7265 7175 6573 7473  rs.from requests
+000001e0: 2e70 6163 6b61 6765 732e 7572 6c6c 6962  .packages.urllib
+000001f0: 332e 7574 696c 2069 6d70 6f72 7420 7265  3.util import re
+00000200: 7472 7920 6173 2072 6574 7279 5f6c 6962  try as retry_lib
+00000210: 0a69 6d70 6f72 7420 7269 6368 2e70 726f  .import rich.pro
+00000220: 6772 6573 7320 6173 2072 6963 685f 7072  gress as rich_pr
+00000230: 6f67 7265 7373 0a66 726f 6d20 7479 7069  ogress.from typi
+00000240: 6e67 5f65 7874 656e 7369 6f6e 7320 696d  ng_extensions im
+00000250: 706f 7274 204c 6974 6572 616c 0a69 6d70  port Literal.imp
+00000260: 6f72 7420 7961 6d6c 0a0a 696d 706f 7274  ort yaml..import
+00000270: 2073 6b79 0a66 726f 6d20 736b 7920 696d   sky.from sky im
+00000280: 706f 7274 2061 7574 6865 6e74 6963 6174  port authenticat
+00000290: 696f 6e20 6173 2061 7574 680a 6672 6f6d  ion as auth.from
+000002a0: 2073 6b79 2069 6d70 6f72 7420 6261 636b   sky import back
+000002b0: 656e 6473 0a66 726f 6d20 736b 7920 696d  ends.from sky im
+000002c0: 706f 7274 2063 6865 636b 2061 7320 736b  port check as sk
+000002d0: 795f 6368 6563 6b0a 6672 6f6d 2073 6b79  y_check.from sky
+000002e0: 2069 6d70 6f72 7420 636c 6f75 6473 0a66   import clouds.f
+000002f0: 726f 6d20 736b 7920 696d 706f 7274 2065  rom sky import e
+00000300: 7863 6570 7469 6f6e 730a 6672 6f6d 2073  xceptions.from s
+00000310: 6b79 2069 6d70 6f72 7420 676c 6f62 616c  ky import global
+00000320: 5f75 7365 725f 7374 6174 650a 6672 6f6d  _user_state.from
+00000330: 2073 6b79 2069 6d70 6f72 7420 7072 6f76   sky import prov
+00000340: 6973 696f 6e20 6173 2070 726f 7669 7369  ision as provisi
+00000350: 6f6e 5f6c 6962 0a66 726f 6d20 736b 7920  on_lib.from sky 
+00000360: 696d 706f 7274 2073 6b79 5f6c 6f67 6769  import sky_loggi
+00000370: 6e67 0a66 726f 6d20 736b 7920 696d 706f  ng.from sky impo
+00000380: 7274 2073 6b79 7069 6c6f 745f 636f 6e66  rt skypilot_conf
+00000390: 6967 0a66 726f 6d20 736b 7920 696d 706f  ig.from sky impo
+000003a0: 7274 2073 7461 7475 735f 6c69 620a 6672  rt status_lib.fr
+000003b0: 6f6d 2073 6b79 2e63 6c6f 7564 7320 696d  om sky.clouds im
+000003c0: 706f 7274 2063 6c6f 7564 5f72 6567 6973  port cloud_regis
+000003d0: 7472 790a 6672 6f6d 2073 6b79 2e70 726f  try.from sky.pro
+000003e0: 7669 7369 6f6e 2069 6d70 6f72 7420 696e  vision import in
+000003f0: 7374 616e 6365 5f73 6574 7570 0a66 726f  stance_setup.fro
+00000400: 6d20 736b 792e 7072 6f76 6973 696f 6e2e  m sky.provision.
+00000410: 6b75 6265 726e 6574 6573 2069 6d70 6f72  kubernetes impor
+00000420: 7420 7574 696c 7320 6173 206b 7562 6572  t utils as kuber
+00000430: 6e65 7465 735f 7574 696c 730a 6672 6f6d  netes_utils.from
+00000440: 2073 6b79 2e73 6b79 6c65 7420 696d 706f   sky.skylet impo
+00000450: 7274 2063 6f6e 7374 616e 7473 0a66 726f  rt constants.fro
+00000460: 6d20 736b 792e 7573 6167 6520 696d 706f  m sky.usage impo
+00000470: 7274 2075 7361 6765 5f6c 6962 0a66 726f  rt usage_lib.fro
+00000480: 6d20 736b 792e 7574 696c 7320 696d 706f  m sky.utils impo
+00000490: 7274 2063 6c75 7374 6572 5f79 616d 6c5f  rt cluster_yaml_
+000004a0: 7574 696c 730a 6672 6f6d 2073 6b79 2e75  utils.from sky.u
+000004b0: 7469 6c73 2069 6d70 6f72 7420 636f 6d6d  tils import comm
+000004c0: 616e 645f 7275 6e6e 6572 0a66 726f 6d20  and_runner.from 
+000004d0: 736b 792e 7574 696c 7320 696d 706f 7274  sky.utils import
+000004e0: 2063 6f6d 6d6f 6e5f 7574 696c 730a 6672   common_utils.fr
+000004f0: 6f6d 2073 6b79 2e75 7469 6c73 2069 6d70  om sky.utils imp
+00000500: 6f72 7420 636f 6e74 726f 6c6c 6572 5f75  ort controller_u
+00000510: 7469 6c73 0a66 726f 6d20 736b 792e 7574  tils.from sky.ut
+00000520: 696c 7320 696d 706f 7274 2065 6e76 5f6f  ils import env_o
+00000530: 7074 696f 6e73 0a66 726f 6d20 736b 792e  ptions.from sky.
+00000540: 7574 696c 7320 696d 706f 7274 2072 6573  utils import res
+00000550: 6f75 7263 6573 5f75 7469 6c73 0a66 726f  ources_utils.fro
+00000560: 6d20 736b 792e 7574 696c 7320 696d 706f  m sky.utils impo
+00000570: 7274 2072 6963 685f 7574 696c 730a 6672  rt rich_utils.fr
+00000580: 6f6d 2073 6b79 2e75 7469 6c73 2069 6d70  om sky.utils imp
+00000590: 6f72 7420 7363 6865 6d61 730a 6672 6f6d  ort schemas.from
+000005a0: 2073 6b79 2e75 7469 6c73 2069 6d70 6f72   sky.utils impor
+000005b0: 7420 7375 6270 726f 6365 7373 5f75 7469  t subprocess_uti
+000005c0: 6c73 0a66 726f 6d20 736b 792e 7574 696c  ls.from sky.util
+000005d0: 7320 696d 706f 7274 2074 696d 656c 696e  s import timelin
+000005e0: 650a 6672 6f6d 2073 6b79 2e75 7469 6c73  e.from sky.utils
+000005f0: 2069 6d70 6f72 7420 7578 5f75 7469 6c73   import ux_utils
+00000600: 0a0a 6966 2074 7970 696e 672e 5459 5045  ..if typing.TYPE
+00000610: 5f43 4845 434b 494e 473a 0a20 2020 2066  _CHECKING:.    f
+00000620: 726f 6d20 736b 7920 696d 706f 7274 2072  rom sky import r
+00000630: 6573 6f75 7263 6573 0a20 2020 2066 726f  esources.    fro
+00000640: 6d20 736b 7920 696d 706f 7274 2074 6173  m sky import tas
+00000650: 6b20 6173 2074 6173 6b5f 6c69 620a 2020  k as task_lib.  
+00000660: 2020 6672 6f6d 2073 6b79 2e62 6163 6b65    from sky.backe
+00000670: 6e64 7320 696d 706f 7274 2063 6c6f 7564  nds import cloud
+00000680: 5f76 6d5f 7261 795f 6261 636b 656e 640a  _vm_ray_backend.
+00000690: 2020 2020 6672 6f6d 2073 6b79 2e62 6163      from sky.bac
+000006a0: 6b65 6e64 7320 696d 706f 7274 206c 6f63  kends import loc
+000006b0: 616c 5f64 6f63 6b65 725f 6261 636b 656e  al_docker_backen
+000006c0: 640a 0a6c 6f67 6765 7220 3d20 736b 795f  d..logger = sky_
+000006d0: 6c6f 6767 696e 672e 696e 6974 5f6c 6f67  logging.init_log
+000006e0: 6765 7228 5f5f 6e61 6d65 5f5f 290a 0a23  ger(__name__)..#
+000006f0: 204e 4f54 453a 206b 6565 7020 696e 2073   NOTE: keep in s
+00000700: 796e 6320 7769 7468 2074 6865 2063 6c75  ync with the clu
+00000710: 7374 6572 2074 656d 706c 6174 6520 2766  ster template 'f
+00000720: 696c 655f 6d6f 756e 7473 272e 0a53 4b59  ile_mounts'..SKY
+00000730: 5f52 454d 4f54 455f 4150 505f 4449 5220  _REMOTE_APP_DIR 
+00000740: 3d20 277e 2f2e 736b 792f 736b 795f 6170  = '~/.sky/sky_ap
+00000750: 7027 0a23 2045 7863 6c75 6465 2073 7562  p'.# Exclude sub
+00000760: 6e65 7420 6d61 736b 2066 726f 6d20 4950  net mask from IP
+00000770: 2061 6464 7265 7373 2072 6567 6578 2e0a   address regex..
+00000780: 4950 5f41 4444 525f 5245 4745 5820 3d20  IP_ADDR_REGEX = 
+00000790: 7227 5c62 5c64 7b31 2c33 7d5c 2e5c 647b  r'\b\d{1,3}\.\d{
+000007a0: 312c 337d 5c2e 5c64 7b31 2c33 7d5c 2e5c  1,3}\.\d{1,3}\.\
+000007b0: 647b 312c 337d 283f 212f 5c64 7b31 2c32  d{1,3}(?!/\d{1,2
+000007c0: 7d29 5c62 270a 534b 595f 5245 4d4f 5445  })\b'.SKY_REMOTE
+000007d0: 5f50 4154 4820 3d20 277e 2f2e 736b 792f  _PATH = '~/.sky/
+000007e0: 7768 6565 6c73 270a 534b 595f 5553 4552  wheels'.SKY_USER
+000007f0: 5f46 494c 455f 5041 5448 203d 2027 7e2f  _FILE_PATH = '~/
+00000800: 2e73 6b79 2f67 656e 6572 6174 6564 270a  .sky/generated'.
+00000810: 0a42 4f4c 4420 3d20 275c 3033 335b 316d  .BOLD = '\033[1m
+00000820: 270a 5245 5345 545f 424f 4c44 203d 2027  '.RESET_BOLD = '
+00000830: 5c30 3333 5b30 6d27 0a0a 2320 446f 206e  \033[0m'..# Do n
+00000840: 6f74 2075 7365 202f 746d 7020 6265 6361  ot use /tmp beca
+00000850: 7573 6520 6974 2067 6574 7320 636c 6561  use it gets clea
+00000860: 7265 6420 6f6e 2056 4d20 7265 7374 6172  red on VM restar
+00000870: 742e 0a5f 534b 595f 5245 4d4f 5445 5f46  t.._SKY_REMOTE_F
+00000880: 494c 455f 4d4f 554e 5453 5f44 4952 203d  ILE_MOUNTS_DIR =
+00000890: 2027 7e2f 2e73 6b79 2f66 696c 655f 6d6f   '~/.sky/file_mo
+000008a0: 756e 7473 2f27 0a0a 5f4c 4155 4e43 4845  unts/'.._LAUNCHE
+000008b0: 445f 4845 4144 5f50 4154 5445 524e 203d  D_HEAD_PATTERN =
+000008c0: 2072 652e 636f 6d70 696c 6528 7227 285c   re.compile(r'(\
+000008d0: 642b 2920 7261 795b 2e5f 5d68 6561 645b  d+) ray[._]head[
+000008e0: 2e5f 5d64 6566 6175 6c74 2729 0a5f 4c41  ._]default')._LA
+000008f0: 554e 4348 4544 5f4c 4f43 414c 5f57 4f52  UNCHED_LOCAL_WOR
+00000900: 4b45 525f 5041 5454 4552 4e20 3d20 7265  KER_PATTERN = re
+00000910: 2e63 6f6d 7069 6c65 2872 2728 5c64 2b29  .compile(r'(\d+)
+00000920: 206e 6f64 655f 2729 0a5f 4c41 554e 4348   node_')._LAUNCH
+00000930: 4544 5f57 4f52 4b45 525f 5041 5454 4552  ED_WORKER_PATTER
+00000940: 4e20 3d20 7265 2e63 6f6d 7069 6c65 2872  N = re.compile(r
+00000950: 2728 5c64 2b29 2072 6179 5b2e 5f5d 776f  '(\d+) ray[._]wo
+00000960: 726b 6572 5b2e 5f5d 6465 6661 756c 7427  rker[._]default'
+00000970: 290a 5f4c 4155 4e43 4845 445f 5245 5345  )._LAUNCHED_RESE
+00000980: 5256 4544 5f57 4f52 4b45 525f 5041 5454  RVED_WORKER_PATT
+00000990: 4552 4e20 3d20 7265 2e63 6f6d 7069 6c65  ERN = re.compile
+000009a0: 280a 2020 2020 7227 285c 642b 2920 7261  (.    r'(\d+) ra
+000009b0: 795b 2e5f 5d77 6f72 6b65 725b 2e5f 5d72  y[._]worker[._]r
+000009c0: 6573 6572 7665 6427 290a 2320 496e 7465  eserved').# Inte
+000009d0: 6e74 696f 6e61 6c6c 7920 6e6f 7420 7573  ntionally not us
+000009e0: 696e 6720 7072 6566 6978 2027 7266 2720  ing prefix 'rf' 
+000009f0: 666f 7220 7468 6520 7374 7269 6e67 2066  for the string f
+00000a00: 6f72 6d61 7420 6265 6361 7573 6520 7961  ormat because ya
+00000a10: 7066 2068 6176 6520 610a 2320 6275 6720  pf have a.# bug 
+00000a20: 7769 7468 2070 7974 686f 6e3d 332e 362e  with python=3.6.
+00000a30: 0a23 2031 302e 3133 332e 302e 353a 2072  .# 10.133.0.5: r
+00000a40: 6179 2e77 6f72 6b65 722e 6465 6661 756c  ay.worker.defaul
+00000a50: 742c 0a5f 4c41 554e 4348 494e 475f 4950  t,._LAUNCHING_IP
+00000a60: 5f50 4154 5445 524e 203d 2072 652e 636f  _PATTERN = re.co
+00000a70: 6d70 696c 6528 0a20 2020 2072 2728 7b7d  mpile(.    r'({}
+00000a80: 293a 2072 6179 5b2e 5f5d 776f 726b 6572  ): ray[._]worker
+00000a90: 5b2e 5f5d 283f 3a64 6566 6175 6c74 7c72  [._](?:default|r
+00000aa0: 6573 6572 7665 6429 272e 666f 726d 6174  eserved)'.format
+00000ab0: 2849 505f 4144 4452 5f52 4547 4558 2929  (IP_ADDR_REGEX))
+00000ac0: 0a57 4149 545f 4845 4144 5f4e 4f44 455f  .WAIT_HEAD_NODE_
+00000ad0: 4950 5f4d 4158 5f41 5454 454d 5054 5320  IP_MAX_ATTEMPTS 
+00000ae0: 3d20 330a 0a23 2057 6520 6368 6563 6b20  = 3..# We check 
+00000af0: 6e65 7477 6f72 6b20 636f 6e6e 6563 7469  network connecti
+00000b00: 6f6e 2062 7920 676f 696e 6720 7468 726f  on by going thro
+00000b10: 7567 6820 5f54 4553 545f 4950 5f4c 4953  ugh _TEST_IP_LIS
+00000b20: 542e 2057 6520 6d61 7920 6e65 6564 2074  T. We may need t
+00000b30: 6f0a 2320 6368 6563 6b20 6d75 6c74 6970  o.# check multip
+00000b40: 6c65 2049 5073 2062 6563 6175 7365 2073  le IPs because s
+00000b50: 6f6d 6520 4950 7320 6d61 7920 6265 2062  ome IPs may be b
+00000b60: 6c6f 636b 6564 206f 6e20 6365 7274 6169  locked on certai
+00000b70: 6e20 6e65 7477 6f72 6b73 2e0a 2320 4669  n networks..# Fi
+00000b80: 7865 6420 4950 2061 6464 7265 7373 6573  xed IP addresses
+00000b90: 2061 7265 2075 7365 6420 746f 2061 766f   are used to avo
+00000ba0: 6964 2044 4e53 206c 6f6f 6b75 7020 626c  id DNS lookup bl
+00000bb0: 6f63 6b69 6e67 2074 6865 2063 6865 636b  ocking the check
+00000bc0: 2c20 666f 720a 2320 6d61 6368 696e 6520  , for.# machine 
+00000bd0: 7769 7468 206e 6f20 696e 7465 726e 6574  with no internet
+00000be0: 2063 6f6e 6e65 6374 696f 6e2e 0a23 2052   connection..# R
+00000bf0: 6566 6572 2074 6f3a 2068 7474 7073 3a2f  efer to: https:/
+00000c00: 2f73 7461 636b 6f76 6572 666c 6f77 2e63  /stackoverflow.c
+00000c10: 6f6d 2f71 7565 7374 696f 6e73 2f33 3736  om/questions/376
+00000c20: 3432 3931 2f68 6f77 2d63 616e 2d69 2d73  4291/how-can-i-s
+00000c30: 6565 2d69 662d 7468 6572 6573 2d61 6e2d  ee-if-theres-an-
+00000c40: 6176 6169 6c61 626c 652d 616e 642d 6163  available-and-ac
+00000c50: 7469 7665 2d6e 6574 776f 726b 2d63 6f6e  tive-network-con
+00000c60: 6e65 6374 696f 6e2d 696e 2d70 7974 686f  nection-in-pytho
+00000c70: 6e20 2320 7079 6c69 6e74 3a20 6469 7361  n # pylint: disa
+00000c80: 626c 653d 6c69 6e65 2d74 6f6f 2d6c 6f6e  ble=line-too-lon
+00000c90: 670a 5f54 4553 545f 4950 5f4c 4953 5420  g._TEST_IP_LIST 
+00000ca0: 3d20 5b27 6874 7470 733a 2f2f 312e 312e  = ['https://1.1.
+00000cb0: 312e 3127 2c20 2768 7474 7073 3a2f 2f38  1.1', 'https://8
+00000cc0: 2e38 2e38 2e38 275d 0a0a 2320 416c 6c6f  .8.8.8']..# Allo
+00000cd0: 7720 6561 6368 2043 5055 2074 6872 6561  w each CPU threa
+00000ce0: 6420 7461 6b65 2032 2074 6173 6b73 2e0a  d take 2 tasks..
+00000cf0: 2320 4e6f 7465 3a20 5468 6973 2076 616c  # Note: This val
+00000d00: 7565 2063 616e 6e6f 7420 6265 2074 6f6f  ue cannot be too
+00000d10: 2073 6d61 6c6c 2c20 6f74 6865 7277 6973   small, otherwis
+00000d20: 6520 4f4f 4d20 6973 7375 6520 6d61 7920  e OOM issue may 
+00000d30: 6f63 6375 722e 0a44 4546 4155 4c54 5f54  occur..DEFAULT_T
+00000d40: 4153 4b5f 4350 555f 4445 4d41 4e44 203d  ASK_CPU_DEMAND =
+00000d50: 2030 2e35 0a0a 2320 4669 6c65 6c6f 636b   0.5..# Filelock
+00000d60: 7320 666f 7220 7468 6520 636c 7573 7465  s for the cluste
+00000d70: 7220 7374 6174 7573 2063 6861 6e67 652e  r status change.
+00000d80: 0a43 4c55 5354 4552 5f53 5441 5455 535f  .CLUSTER_STATUS_
+00000d90: 4c4f 434b 5f50 4154 4820 3d20 6f73 2e70  LOCK_PATH = os.p
+00000da0: 6174 682e 6578 7061 6e64 7573 6572 2827  ath.expanduser('
+00000db0: 7e2f 2e73 6b79 2f2e 7b7d 2e6c 6f63 6b27  ~/.sky/.{}.lock'
+00000dc0: 290a 434c 5553 5445 525f 5354 4154 5553  ).CLUSTER_STATUS
+00000dd0: 5f4c 4f43 4b5f 5449 4d45 4f55 545f 5345  _LOCK_TIMEOUT_SE
+00000de0: 434f 4e44 5320 3d20 3230 0a0a 2320 4669  CONDS = 20..# Fi
+00000df0: 6c65 6c6f 636b 7320 666f 7220 7570 6461  lelocks for upda
+00000e00: 7469 6e67 2063 6c75 7374 6572 2773 2066  ting cluster's f
+00000e10: 696c 655f 6d6f 756e 7473 2e0a 434c 5553  ile_mounts..CLUS
+00000e20: 5445 525f 4649 4c45 5f4d 4f55 4e54 535f  TER_FILE_MOUNTS_
+00000e30: 4c4f 434b 5f50 4154 4820 3d20 6f73 2e70  LOCK_PATH = os.p
+00000e40: 6174 682e 6578 7061 6e64 7573 6572 280a  ath.expanduser(.
+00000e50: 2020 2020 277e 2f2e 736b 792f 2e7b 7d5f      '~/.sky/.{}_
+00000e60: 6669 6c65 5f6d 6f75 6e74 732e 6c6f 636b  file_mounts.lock
+00000e70: 2729 0a43 4c55 5354 4552 5f46 494c 455f  ').CLUSTER_FILE_
+00000e80: 4d4f 554e 5453 5f4c 4f43 4b5f 5449 4d45  MOUNTS_LOCK_TIME
+00000e90: 4f55 545f 5345 434f 4e44 5320 3d20 3130  OUT_SECONDS = 10
+00000ea0: 0a0a 2320 5265 6d6f 7465 2064 6972 2074  ..# Remote dir t
+00000eb0: 6861 7420 686f 6c64 7320 6f75 7220 7275  hat holds our ru
+00000ec0: 6e74 696d 6520 6669 6c65 732e 0a5f 5245  ntime files.._RE
+00000ed0: 4d4f 5445 5f52 554e 5449 4d45 5f46 494c  MOTE_RUNTIME_FIL
+00000ee0: 4553 5f44 4952 203d 2027 7e2f 2e73 6b79  ES_DIR = '~/.sky
+00000ef0: 2f2e 7275 6e74 696d 655f 6669 6c65 7327  /.runtime_files'
+00000f00: 0a0a 5f45 4e44 504f 494e 5453 5f52 4554  .._ENDPOINTS_RET
+00000f10: 5259 5f4d 4553 5341 4745 203d 2028 2749  RY_MESSAGE = ('I
+00000f20: 6620 7468 6520 636c 7573 7465 7220 7761  f the cluster wa
+00000f30: 7320 7265 6365 6e74 6c79 2073 7461 7274  s recently start
+00000f40: 6564 2c20 270a 2020 2020 2020 2020 2020  ed, '.          
+00000f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000f60: 2020 2770 6c65 6173 6520 7265 7472 7920    'please retry 
+00000f70: 6166 7465 7220 6120 7768 696c 652e 2729  after a while.')
+00000f80: 0a0a 2320 496e 636c 7564 6520 7468 6520  ..# Include the 
+00000f90: 6669 656c 6473 2074 6861 7420 7769 6c6c  fields that will
+00000fa0: 2062 6520 7573 6564 2066 6f72 2067 656e   be used for gen
+00000fb0: 6572 6174 696e 6720 7461 6773 2074 6861  erating tags tha
+00000fc0: 7420 6469 7374 696e 6775 6973 6865 730a  t distinguishes.
+00000fd0: 2320 7468 6520 636c 7573 7465 7220 696e  # the cluster in
+00000fe0: 2072 6179 2c20 746f 2061 766f 6964 2074   ray, to avoid t
+00000ff0: 6865 2073 746f 7070 6564 2063 6c75 7374  he stopped clust
+00001000: 6572 2062 6569 6e67 2064 6973 6361 7264  er being discard
+00001010: 6564 2064 7565 2074 6f0a 2320 7570 6461  ed due to.# upda
+00001020: 7465 7320 696e 2074 6865 2079 616d 6c20  tes in the yaml 
+00001030: 7465 6d70 6c61 7465 2e0a 2320 536f 6d65  template..# Some
+00001040: 206e 6f74 6573 206f 6e20 7468 6520 6669   notes on the fi
+00001050: 656c 6473 3a0a 2320 2d20 2770 726f 7669  elds:.# - 'provi
+00001060: 6465 7227 2066 6965 6c64 7320 7769 6c6c  der' fields will
+00001070: 2062 6520 7573 6564 2066 6f72 2062 6f6f   be used for boo
+00001080: 7473 7472 6170 7069 6e67 2061 6e64 2069  tstrapping and i
+00001090: 6e73 6572 7420 6d6f 7265 206e 6577 2069  nsert more new i
+000010a0: 7465 6d73 0a23 2020 2069 6e20 276e 6f64  tems.#   in 'nod
+000010b0: 655f 636f 6e66 6967 272e 0a23 202d 206b  e_config'..# - k
+000010c0: 6565 7069 6e67 2074 6865 2061 7574 6820  eeping the auth 
+000010d0: 6973 206e 6f74 2065 6e6f 7567 6820 6265  is not enough be
+000010e0: 6375 6173 6520 7468 6520 636f 6e74 656e  cuase the conten
+000010f0: 7420 6f66 2074 6865 206b 6579 2066 696c  t of the key fil
+00001100: 6520 7769 6c6c 2062 650a 2320 2020 7573  e will be.#   us
+00001110: 6564 2066 6f72 2063 616c 6375 6c61 7469  ed for calculati
+00001120: 6e67 2074 6865 2068 6173 682e 0a23 2054  ng the hash..# T
+00001130: 4f44 4f28 7a68 7775 293a 204b 6565 7020  ODO(zhwu): Keep 
+00001140: 696e 2073 796e 6320 7769 7468 2074 6865  in sync with the
+00001150: 2066 6965 6c64 7320 7573 6564 2069 6e20   fields used in 
+00001160: 6874 7470 733a 2f2f 6769 7468 7562 2e63  https://github.c
+00001170: 6f6d 2f72 6179 2d70 726f 6a65 6374 2f72  om/ray-project/r
+00001180: 6179 2f62 6c6f 622f 6534 6365 3338 6430  ay/blob/e4ce38d0
+00001190: 3031 6462 6265 3039 6364 3231 6334 3937  01dbbe09cd21c497
+000011a0: 6665 6464 3033 6436 3932 6232 6265 3365  fedd03d692b2be3e
+000011b0: 2f70 7974 686f 6e2f 7261 792f 6175 746f  /python/ray/auto
+000011c0: 7363 616c 6572 2f5f 7072 6976 6174 652f  scaler/_private/
+000011d0: 636f 6d6d 616e 6473 2e70 7923 4c36 3837  commands.py#L687
+000011e0: 2d4c 3730 310a 5f52 4159 5f59 414d 4c5f  -L701._RAY_YAML_
+000011f0: 4b45 5953 5f54 4f5f 5245 5354 4f52 455f  KEYS_TO_RESTORE_
+00001200: 464f 525f 4241 434b 5f43 4f4d 5041 5449  FOR_BACK_COMPATI
+00001210: 4249 4c49 5459 203d 207b 0a20 2020 2027  BILITY = {.    '
+00001220: 636c 7573 7465 725f 6e61 6d65 272c 2027  cluster_name', '
+00001230: 7072 6f76 6964 6572 272c 2027 6175 7468  provider', 'auth
+00001240: 272c 2027 6e6f 6465 5f63 6f6e 6669 6727  ', 'node_config'
+00001250: 2c20 2764 6f63 6b65 7227 0a7d 0a23 2046  , 'docker'.}.# F
+00001260: 6f72 2074 6865 7365 206b 6579 732c 2064  or these keys, d
+00001270: 6f6e 2774 2075 7365 2074 6865 206f 6c64  on't use the old
+00001280: 2079 616d 6c27 7320 7665 7273 696f 6e20   yaml's version 
+00001290: 616e 6420 696e 7374 6561 6420 7573 6520  and instead use 
+000012a0: 7468 6520 6e65 7720 7961 6d6c 2773 2e0a  the new yaml's..
+000012b0: 2320 202d 207a 6f6e 653a 2054 6865 207a  #  - zone: The z
+000012c0: 6f6e 6520 6669 656c 6420 6f66 2074 6865  one field of the
+000012d0: 206f 6c64 2079 616d 6c20 6d61 7920 6265   old yaml may be
+000012e0: 2027 3161 2c31 622c 3163 2720 2841 5753   '1a,1b,1c' (AWS
+000012f0: 2920 7768 696c 6520 7468 6520 6163 7475  ) while the actu
+00001300: 616c 0a23 2020 2020 7a6f 6e65 206f 6620  al.#    zone of 
+00001310: 7468 6520 6c61 756e 6368 6564 2063 6c75  the launched clu
+00001320: 7374 6572 2069 7320 2731 6127 2e20 4966  ster is '1a'. If
+00001330: 2077 6520 7265 7374 6f72 652c 2074 6865   we restore, the
+00001340: 6e20 6f6e 2063 6170 6163 6974 7920 6572  n on capacity er
+00001350: 726f 7273 0a23 2020 2020 6974 2773 2070  rors.#    it's p
+00001360: 6f73 7369 626c 6520 746f 2066 6169 6c6f  ossible to failo
+00001370: 7665 7220 746f 2031 622c 2077 6869 6368  ver to 1b, which
+00001380: 206c 6561 7665 7320 6120 6c65 616b 6564   leaves a leaked
+00001390: 2069 6e73 7461 6e63 6520 696e 2031 612e   instance in 1a.
+000013a0: 2048 6572 652c 0a23 2020 2020 7765 2075   Here,.#    we u
+000013b0: 7365 2074 6865 206e 6577 2079 616d 6c27  se the new yaml'
+000013c0: 7320 7a6f 6e65 2066 6965 6c64 2c20 7768  s zone field, wh
+000013d0: 6963 6820 6973 2067 7561 7261 6e74 6565  ich is guarantee
+000013e0: 6420 746f 2062 6520 7468 6520 6578 6973  d to be the exis
+000013f0: 7469 6e67 207a 6f6e 650a 2320 2020 2027  ting zone.#    '
+00001400: 3161 272e 0a23 202d 2064 6f63 6b65 725f  1a'..# - docker_
+00001410: 6c6f 6769 6e5f 636f 6e66 6967 3a20 5468  login_config: Th
+00001420: 6520 646f 636b 6572 5f6c 6f67 696e 5f63  e docker_login_c
+00001430: 6f6e 6669 6720 6669 656c 6420 6f66 2074  onfig field of t
+00001440: 6865 206f 6c64 2079 616d 6c20 6d61 7920  he old yaml may 
+00001450: 6265 0a23 2020 206f 7574 6461 7465 6420  be.#   outdated 
+00001460: 6f72 2077 726f 6e67 2e20 5573 6572 7320  or wrong. Users 
+00001470: 6d61 7920 7761 6e74 2074 6f20 6669 7820  may want to fix 
+00001480: 7468 6520 6c6f 6769 6e20 636f 6e66 6967  the login config
+00001490: 2069 6620 6120 636c 7573 7465 7220 6661   if a cluster fa
+000014a0: 696c 730a 2320 2020 746f 206c 6175 6e63  ils.#   to launc
+000014b0: 6820 6475 6520 746f 2074 6865 206c 6f67  h due to the log
+000014c0: 696e 2063 6f6e 6669 672e 0a23 202d 2055  in config..# - U
+000014d0: 7365 7244 6174 613a 2054 6865 2055 7365  serData: The Use
+000014e0: 7244 6174 6120 6669 656c 6420 6f66 2074  rData field of t
+000014f0: 6865 206f 6c64 2079 616d 6c20 6d61 7920  he old yaml may 
+00001500: 6265 206f 7574 6461 7465 642c 2061 6e64  be outdated, and
+00001510: 2077 6520 7761 6e74 2074 6f0a 2320 2020   we want to.#   
+00001520: 7573 6520 7468 6520 6e65 7720 7961 6d6c  use the new yaml
+00001530: 2773 2055 7365 7244 6174 6120 6669 656c  's UserData fiel
+00001540: 642c 2077 6869 6368 2063 6f6e 7461 696e  d, which contain
+00001550: 7320 7468 6520 6175 7468 6f72 697a 6564  s the authorized
+00001560: 206b 6579 2073 6574 7570 2061 730a 2320   key setup as.# 
+00001570: 2020 7765 6c6c 2061 7320 7468 6520 6469    well as the di
+00001580: 7361 626c 696e 6720 6f66 2074 6865 2061  sabling of the a
+00001590: 7574 6f2d 7570 6461 7465 2077 6974 6820  uto-update with 
+000015a0: 6170 742d 6765 742e 0a23 202d 2066 6972  apt-get..# - fir
+000015b0: 6577 616c 6c5f 7275 6c65 3a20 5468 6973  ewall_rule: This
+000015c0: 2069 7320 6120 6e65 776c 7920 6164 6465   is a newly adde
+000015d0: 6420 7365 6374 696f 6e20 666f 7220 6763  d section for gc
+000015e0: 7020 696e 2070 726f 7669 6465 7220 7365  p in provider se
+000015f0: 6374 696f 6e2e 0a23 202d 2073 6563 7572  ction..# - secur
+00001600: 6974 795f 6772 6f75 703a 2049 6e20 2332  ity_group: In #2
+00001610: 3438 3520 7765 2069 6e74 726f 6475 6365  485 we introduce
+00001620: 7320 7468 6520 6368 616e 6765 6420 6f66  s the changed of
+00001630: 2073 6563 7572 6974 7920 6772 6f75 702c   security group,
+00001640: 2073 6f20 7765 0a23 2020 2073 686f 756c   so we.#   shoul
+00001650: 6420 7461 6b65 2074 6865 206c 6174 6573  d take the lates
+00001660: 7420 7365 6375 7269 7479 2067 726f 7570  t security group
+00001670: 206e 616d 652e 0a5f 5241 595f 5941 4d4c   name.._RAY_YAML
+00001680: 5f4b 4559 535f 544f 5f52 4553 544f 5245  _KEYS_TO_RESTORE
+00001690: 5f45 5843 4550 5449 4f4e 5320 3d20 5b0a  _EXCEPTIONS = [.
+000016a0: 2020 2020 2827 7072 6f76 6964 6572 272c      ('provider',
+000016b0: 2027 6176 6169 6c61 6269 6c69 7479 5f7a   'availability_z
+000016c0: 6f6e 6527 292c 0a20 2020 2023 2043 6c6f  one'),.    # Clo
+000016d0: 7564 7320 7769 7468 206e 6577 2070 726f  uds with new pro
+000016e0: 7669 7369 6f6e 6572 2068 6173 2064 6f63  visioner has doc
+000016f0: 6b65 725f 6c6f 6769 6e5f 636f 6e66 6967  ker_login_config
+00001700: 2069 6e20 7468 650a 2020 2020 2320 646f   in the.    # do
+00001710: 636b 6572 2066 6965 6c64 2c20 696e 7374  cker field, inst
+00001720: 6561 6420 6f66 2074 6865 2070 726f 7669  ead of the provi
+00001730: 6465 7220 6669 656c 642e 0a20 2020 2028  der field..    (
+00001740: 2764 6f63 6b65 7227 2c20 2764 6f63 6b65  'docker', 'docke
+00001750: 725f 6c6f 6769 6e5f 636f 6e66 6967 2729  r_login_config')
+00001760: 2c0a 2020 2020 2320 4f74 6865 7220 636c  ,.    # Other cl
+00001770: 6f75 6473 0a20 2020 2028 2770 726f 7669  ouds.    ('provi
+00001780: 6465 7227 2c20 2764 6f63 6b65 725f 6c6f  der', 'docker_lo
+00001790: 6769 6e5f 636f 6e66 6967 2729 2c0a 2020  gin_config'),.  
+000017a0: 2020 2827 7072 6f76 6964 6572 272c 2027    ('provider', '
+000017b0: 6669 7265 7761 6c6c 5f72 756c 6527 292c  firewall_rule'),
+000017c0: 0a20 2020 2023 2054 5055 206e 6f64 6520  .    # TPU node 
+000017d0: 6c61 756e 6368 6564 2062 6566 6f72 6520  launched before 
+000017e0: 2332 3934 3320 646f 6573 206e 6f74 2068  #2943 does not h
+000017f0: 6176 6520 7468 6520 6070 726f 7669 6465  ave the `provide
+00001800: 722e 7470 755f 6e6f 6465 6020 7365 742c  r.tpu_node` set,
+00001810: 0a20 2020 2023 2061 6e64 206f 7572 206c  .    # and our l
+00001820: 6174 6573 7420 636f 6465 206e 6565 6420  atest code need 
+00001830: 7468 6973 2066 6965 6c64 2074 6f20 6265  this field to be
+00001840: 2073 6574 2074 6f20 6469 7374 696e 6775   set to distingu
+00001850: 6973 6820 7468 6520 6e6f 6465 2c20 736f  ish the node, so
+00001860: 0a20 2020 2023 2077 6520 6e65 6564 2074  .    # we need t
+00001870: 6f20 7461 6b65 2074 6869 7320 6669 656c  o take this fiel
+00001880: 6420 6672 6f6d 2074 6865 206e 6577 2079  d from the new y
+00001890: 616d 6c2e 0a20 2020 2028 2770 726f 7669  aml..    ('provi
+000018a0: 6465 7227 2c20 2774 7075 5f6e 6f64 6527  der', 'tpu_node'
+000018b0: 292c 0a20 2020 2028 2770 726f 7669 6465  ),.    ('provide
+000018c0: 7227 2c20 2773 6563 7572 6974 795f 6772  r', 'security_gr
+000018d0: 6f75 7027 2c20 2747 726f 7570 4e61 6d65  oup', 'GroupName
+000018e0: 2729 2c0a 2020 2020 2827 6176 6169 6c61  '),.    ('availa
+000018f0: 626c 655f 6e6f 6465 5f74 7970 6573 272c  ble_node_types',
+00001900: 2027 7261 792e 6865 6164 2e64 6566 6175   'ray.head.defau
+00001910: 6c74 272c 2027 6e6f 6465 5f63 6f6e 6669  lt', 'node_confi
+00001920: 6727 2c20 2755 7365 7244 6174 6127 292c  g', 'UserData'),
+00001930: 0a20 2020 2028 2761 7661 696c 6162 6c65  .    ('available
+00001940: 5f6e 6f64 655f 7479 7065 7327 2c20 2772  _node_types', 'r
+00001950: 6179 2e77 6f72 6b65 722e 6465 6661 756c  ay.worker.defaul
+00001960: 7427 2c20 276e 6f64 655f 636f 6e66 6967  t', 'node_config
+00001970: 272c 2027 5573 6572 4461 7461 2729 2c0a  ', 'UserData'),.
+00001980: 5d0a 0a0a 6465 6620 6973 5f69 7028 733a  ]...def is_ip(s:
+00001990: 2073 7472 2920 2d3e 2062 6f6f 6c3a 0a20   str) -> bool:. 
+000019a0: 2020 2022 2222 5265 7475 726e 7320 7768     """Returns wh
+000019b0: 6574 6865 7220 7468 6973 2073 7472 696e  ether this strin
+000019c0: 6720 6d61 7463 6865 7320 4950 5f41 4444  g matches IP_ADD
+000019d0: 525f 5245 4745 582e 2222 220a 2020 2020  R_REGEX.""".    
+000019e0: 7265 7475 726e 206c 656e 2872 652e 6669  return len(re.fi
+000019f0: 6e64 616c 6c28 4950 5f41 4444 525f 5245  ndall(IP_ADDR_RE
+00001a00: 4745 582c 2073 2929 203d 3d20 310a 0a0a  GEX, s)) == 1...
+00001a10: 6465 6620 5f67 6574 5f79 616d 6c5f 7061  def _get_yaml_pa
+00001a20: 7468 5f66 726f 6d5f 636c 7573 7465 725f  th_from_cluster_
+00001a30: 6e61 6d65 2863 6c75 7374 6572 5f6e 616d  name(cluster_nam
+00001a40: 653a 2073 7472 2c0a 2020 2020 2020 2020  e: str,.        
+00001a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001a60: 2020 2020 2020 2020 2020 2020 2070 7265               pre
+00001a70: 6669 783a 2073 7472 203d 2053 4b59 5f55  fix: str = SKY_U
+00001a80: 5345 525f 4649 4c45 5f50 4154 4829 202d  SER_FILE_PATH) -
+00001a90: 3e20 7374 723a 0a20 2020 206f 7574 7075  > str:.    outpu
+00001aa0: 745f 7061 7468 203d 2070 6174 686c 6962  t_path = pathlib
+00001ab0: 2e50 6174 6828 0a20 2020 2020 2020 2070  .Path(.        p
+00001ac0: 7265 6669 7829 2e65 7870 616e 6475 7365  refix).expanduse
+00001ad0: 7228 292e 7265 736f 6c76 6528 2920 2f20  r().resolve() / 
+00001ae0: 6627 7b63 6c75 7374 6572 5f6e 616d 657d  f'{cluster_name}
+00001af0: 2e79 6d6c 270a 2020 2020 6f73 2e6d 616b  .yml'.    os.mak
+00001b00: 6564 6972 7328 6f75 7470 7574 5f70 6174  edirs(output_pat
+00001b10: 682e 7061 7265 6e74 735b 305d 2c20 6578  h.parents[0], ex
+00001b20: 6973 745f 6f6b 3d54 7275 6529 0a20 2020  ist_ok=True).   
+00001b30: 2072 6574 7572 6e20 7374 7228 6f75 7470   return str(outp
+00001b40: 7574 5f70 6174 6829 0a0a 0a64 6566 205f  ut_path)...def _
+00001b50: 6f70 7469 6d69 7a65 5f66 696c 655f 6d6f  optimize_file_mo
+00001b60: 756e 7473 2879 616d 6c5f 7061 7468 3a20  unts(yaml_path: 
+00001b70: 7374 7229 202d 3e20 4e6f 6e65 3a0a 2020  str) -> None:.  
+00001b80: 2020 2222 224f 7074 696d 697a 6520 6669    """Optimize fi
+00001b90: 6c65 206d 6f75 6e74 7320 696e 2074 6865  le mounts in the
+00001ba0: 2067 6976 656e 2072 6179 2079 616d 6c20   given ray yaml 
+00001bb0: 6669 6c65 2e0a 0a20 2020 2052 756e 7469  file...    Runti
+00001bc0: 6d65 2066 696c 6573 2068 616e 646c 696e  me files handlin
+00001bd0: 673a 0a20 2020 204c 6973 7420 6f66 2072  g:.    List of r
+00001be0: 756e 7469 6d65 2066 696c 6573 2074 6f20  untime files to 
+00001bf0: 6265 2075 706c 6f61 6465 6420 746f 2063  be uploaded to c
+00001c00: 6c75 7374 6572 3a0a 2020 2020 2020 2d20  luster:.      - 
+00001c10: 7961 6d6c 2063 6f6e 6669 6720 2866 6f72  yaml config (for
+00001c20: 2061 7574 6f73 746f 7070 696e 6729 0a20   autostopping). 
+00001c30: 2020 2020 202d 2077 6865 656c 0a20 2020       - wheel.   
+00001c40: 2020 202d 2063 7265 6465 6e74 6961 6c73     - credentials
+00001c50: 0a20 2020 2046 6f72 6d61 7420 6973 207b  .    Format is {
+00001c60: 6473 743a 2073 7263 7d2e 0a20 2020 2022  dst: src}..    "
+00001c70: 2222 0a20 2020 2079 616d 6c5f 636f 6e66  "".    yaml_conf
+00001c80: 6967 203d 2063 6f6d 6d6f 6e5f 7574 696c  ig = common_util
+00001c90: 732e 7265 6164 5f79 616d 6c28 7961 6d6c  s.read_yaml(yaml
+00001ca0: 5f70 6174 6829 0a0a 2020 2020 6669 6c65  _path)..    file
+00001cb0: 5f6d 6f75 6e74 7320 3d20 7961 6d6c 5f63  _mounts = yaml_c
+00001cc0: 6f6e 6669 672e 6765 7428 2766 696c 655f  onfig.get('file_
+00001cd0: 6d6f 756e 7473 272c 207b 7d29 0a20 2020  mounts', {}).   
+00001ce0: 2023 2052 656d 6f76 6520 7468 6520 6669   # Remove the fi
+00001cf0: 6c65 206d 6f75 6e74 7320 6164 6465 6420  le mounts added 
+00001d00: 6279 2074 6865 206e 6577 6c69 6e65 2e0a  by the newline..
+00001d10: 2020 2020 6966 2027 2720 696e 2066 696c      if '' in fil
+00001d20: 655f 6d6f 756e 7473 3a0a 2020 2020 2020  e_mounts:.      
+00001d30: 2020 6173 7365 7274 2066 696c 655f 6d6f    assert file_mo
+00001d40: 756e 7473 5b27 275d 203d 3d20 2727 2c20  unts[''] == '', 
+00001d50: 6669 6c65 5f6d 6f75 6e74 735b 2727 5d0a  file_mounts[''].
+00001d60: 2020 2020 2020 2020 6669 6c65 5f6d 6f75          file_mou
+00001d70: 6e74 732e 706f 7028 2727 290a 0a20 2020  nts.pop('')..   
+00001d80: 2023 2050 7574 7469 6e67 2074 6865 7365   # Putting these
+00001d90: 2069 6e20 6669 6c65 5f6d 6f75 6e74 7320   in file_mounts 
+00001da0: 6875 7274 7320 7072 6f76 6973 696f 6e69  hurts provisioni
+00001db0: 6e67 2073 7065 6564 2c20 6173 2065 6163  ng speed, as eac
+00001dc0: 6820 6669 6c65 0a20 2020 2023 206f 7065  h file.    # ope
+00001dd0: 6e73 2f63 6c6f 7365 7320 616e 2053 5348  ns/closes an SSH
+00001de0: 2063 6f6e 6e65 6374 696f 6e2e 2020 496e   connection.  In
+00001df0: 7374 6561 642c 2077 653a 0a20 2020 2023  stead, we:.    #
+00001e00: 2020 2d20 6370 2074 6865 6d20 6c6f 6361    - cp them loca
+00001e10: 6c6c 7920 696e 746f 2061 2064 6972 6563  lly into a direc
+00001e20: 746f 7279 2c20 6561 6368 2077 6974 6820  tory, each with 
+00001e30: 6120 756e 6971 7565 206e 616d 6520 746f  a unique name to
+00001e40: 2061 766f 6964 0a20 2020 2023 2020 2020   avoid.    #    
+00001e50: 6261 7365 6e61 6d65 2063 6f6e 666c 6963  basename conflic
+00001e60: 7473 0a20 2020 2023 2020 2d20 7570 6c6f  ts.    #  - uplo
+00001e70: 6164 2074 6861 7420 6469 7265 6374 6f72  ad that director
+00001e80: 7920 6173 2061 2066 696c 6520 6d6f 756e  y as a file moun
+00001e90: 7420 2831 2063 6f6e 6e65 6374 696f 6e29  t (1 connection)
+00001ea0: 0a20 2020 2023 2020 2d20 7573 6520 6120  .    #  - use a 
+00001eb0: 7265 6d6f 7465 2063 6f6d 6d61 6e64 2074  remote command t
+00001ec0: 6f20 6d6f 7665 2061 6c6c 2072 756e 7469  o move all runti
+00001ed0: 6d65 2066 696c 6573 2074 6f20 7468 6569  me files to thei
+00001ee0: 7220 7269 6768 7420 706c 6163 6573 2e0a  r right places..
+00001ef0: 0a20 2020 2023 204c 6f63 616c 2074 6d70  .    # Local tmp
+00001f00: 2064 6972 2068 6f6c 6469 6e67 2072 756e   dir holding run
+00001f10: 7469 6d65 2066 696c 6573 2e0a 2020 2020  time files..    
+00001f20: 6c6f 6361 6c5f 7275 6e74 696d 655f 6669  local_runtime_fi
+00001f30: 6c65 735f 6469 7220 3d20 7465 6d70 6669  les_dir = tempfi
+00001f40: 6c65 2e6d 6b64 7465 6d70 2829 0a20 2020  le.mkdtemp().   
+00001f50: 206e 6577 5f66 696c 655f 6d6f 756e 7473   new_file_mounts
+00001f60: 203d 207b 5f52 454d 4f54 455f 5255 4e54   = {_REMOTE_RUNT
+00001f70: 494d 455f 4649 4c45 535f 4449 523a 206c  IME_FILES_DIR: l
+00001f80: 6f63 616c 5f72 756e 7469 6d65 5f66 696c  ocal_runtime_fil
+00001f90: 6573 5f64 6972 7d0a 0a20 2020 2023 2047  es_dir}..    # G
+00001fa0: 656e 6572 6174 6520 6c6f 6361 6c5f 7372  enerate local_sr
+00001fb0: 6320 2d3e 2075 6e69 7175 655f 6e61 6d65  c -> unique_name
+00001fc0: 2e0a 2020 2020 6c6f 6361 6c5f 736f 7572  ..    local_sour
+00001fd0: 6365 5f74 6f5f 756e 6971 7565 5f6e 616d  ce_to_unique_nam
+00001fe0: 6520 3d20 7b7d 0a20 2020 2066 6f72 206c  e = {}.    for l
+00001ff0: 6f63 616c 5f73 7263 2069 6e20 6669 6c65  ocal_src in file
+00002000: 5f6d 6f75 6e74 732e 7661 6c75 6573 2829  _mounts.values()
+00002010: 3a0a 2020 2020 2020 2020 6c6f 6361 6c5f  :.        local_
+00002020: 736f 7572 6365 5f74 6f5f 756e 6971 7565  source_to_unique
+00002030: 5f6e 616d 655b 6c6f 6361 6c5f 7372 635d  _name[local_src]
+00002040: 203d 2073 7472 2875 7569 642e 7575 6964   = str(uuid.uuid
+00002050: 3428 2929 0a0a 2020 2020 2320 2846 6f72  4())..    # (For
+00002060: 2072 656d 6f74 6529 2042 7569 6c64 2061   remote) Build a
+00002070: 2063 6f6d 6d61 6e64 2074 6861 7420 636f   command that co
+00002080: 7069 6573 2072 756e 7469 6d65 2066 696c  pies runtime fil
+00002090: 6573 2074 6f20 7468 6569 7220 7269 6768  es to their righ
+000020a0: 740a 2020 2020 2320 6465 7374 696e 6174  t.    # destinat
+000020b0: 696f 6e73 2e0a 2020 2020 2320 4e4f 5445  ions..    # NOTE
+000020c0: 3a20 7765 2063 6f70 7920 7261 7468 6572  : we copy rather
+000020d0: 2074 6861 6e20 6d6f 7665 2c20 6265 6361   than move, beca
+000020e0: 7573 6520 7768 656e 206c 6175 6e63 6869  use when launchi
+000020f0: 6e67 203e 3120 6e6f 6465 2c20 6865 6164  ng >1 node, head
+00002100: 206e 6f64 650a 2020 2020 2320 6973 2066   node.    # is f
+00002110: 756c 6c79 2073 6574 2075 7020 6669 7273  ully set up firs
+00002120: 742c 2061 6e64 2069 6620 6d6f 7669 6e67  t, and if moving
+00002130: 2074 6865 6e20 6865 6164 206e 6f64 6527   then head node'
+00002140: 7320 6669 6c65 7320 776f 756c 6420 616c  s files would al
+00002150: 7265 6164 790a 2020 2020 2320 6d6f 7665  ready.    # move
+00002160: 206f 7574 206f 6620 5f52 454d 4f54 455f   out of _REMOTE_
+00002170: 5255 4e54 494d 455f 4649 4c45 535f 4449  RUNTIME_FILES_DI
+00002180: 522c 2077 6869 6368 2077 6f75 6c64 2063  R, which would c
+00002190: 6175 7365 2073 6574 7469 6e67 2075 700a  ause setting up.
+000021a0: 2020 2020 2320 776f 726b 6572 7320 2866      # workers (f
+000021b0: 726f 6d20 7468 6520 6865 6164 2773 2066  rom the head's f
+000021c0: 696c 6573 2920 746f 2066 6169 6c2e 2020  iles) to fail.  
+000021d0: 416e 2061 6c74 6572 6e61 7469 7665 2069  An alternative i
+000021e0: 7320 736f 6674 6c69 6e6b 0a20 2020 2023  s softlink.    #
+000021f0: 2028 7468 656e 2077 6520 6e65 6564 2074   (then we need t
+00002200: 6f20 6d61 6b65 2073 7572 6520 7468 6520  o make sure the 
+00002210: 7573 6167 6520 6f66 2072 756e 7469 6d65  usage of runtime
+00002220: 2066 696c 6573 2066 6f6c 6c6f 7720 6c69   files follow li
+00002230: 6e6b 7329 2e0a 2020 2020 636f 6d6d 616e  nks)..    comman
+00002240: 6473 203d 205b 5d0a 2020 2020 6261 7365  ds = [].    base
+00002250: 6e61 6d65 7320 3d20 7365 7428 290a 2020  names = set().  
+00002260: 2020 666f 7220 6473 742c 2073 7263 2069    for dst, src i
+00002270: 6e20 6669 6c65 5f6d 6f75 6e74 732e 6974  n file_mounts.it
+00002280: 656d 7328 293a 0a20 2020 2020 2020 2073  ems():.        s
+00002290: 7263 5f62 6173 656e 616d 6520 3d20 6c6f  rc_basename = lo
+000022a0: 6361 6c5f 736f 7572 6365 5f74 6f5f 756e  cal_source_to_un
+000022b0: 6971 7565 5f6e 616d 655b 7372 635d 0a20  ique_name[src]. 
+000022c0: 2020 2020 2020 2064 7374 5f62 6173 656e         dst_basen
+000022d0: 616d 6520 3d20 6f73 2e70 6174 682e 6261  ame = os.path.ba
+000022e0: 7365 6e61 6d65 2864 7374 290a 2020 2020  sename(dst).    
+000022f0: 2020 2020 6473 745f 7061 7265 6e74 5f64      dst_parent_d
+00002300: 6972 203d 206f 732e 7061 7468 2e64 6972  ir = os.path.dir
+00002310: 6e61 6d65 2864 7374 290a 0a20 2020 2020  name(dst)..     
+00002320: 2020 2023 2056 616c 6964 6174 6520 6279     # Validate by
+00002330: 2061 7373 6572 7473 2068 6572 6520 6173   asserts here as
+00002340: 2074 6865 7365 2066 696c 6573 2061 7265   these files are
+00002350: 2061 6464 6564 2062 7920 6f75 7220 6261   added by our ba
+00002360: 636b 656e 642e 0a20 2020 2020 2020 2023  ckend..        #
+00002370: 204f 7572 2072 756e 7469 6d65 2066 696c   Our runtime fil
+00002380: 6573 2028 7768 6565 6c2c 2079 616d 6c2c  es (wheel, yaml,
+00002390: 2063 7265 6465 6e74 6961 6c73 2920 646f   credentials) do
+000023a0: 206e 6f74 2068 6176 6520 6261 636b 736c   not have backsl
+000023b0: 6173 6865 732e 0a20 2020 2020 2020 2061  ashes..        a
+000023c0: 7373 6572 7420 6e6f 7420 7372 632e 656e  ssert not src.en
+000023d0: 6473 7769 7468 2827 2f27 292c 2073 7263  dswith('/'), src
+000023e0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+000023f0: 6e6f 7420 6473 742e 656e 6473 7769 7468  not dst.endswith
+00002400: 2827 2f27 292c 2064 7374 0a20 2020 2020  ('/'), dst.     
+00002410: 2020 2061 7373 6572 7420 7372 635f 6261     assert src_ba
+00002420: 7365 6e61 6d65 206e 6f74 2069 6e20 6261  sename not in ba
+00002430: 7365 6e61 6d65 732c 2028 0a20 2020 2020  senames, (.     
+00002440: 2020 2020 2020 2066 2744 7570 6c69 6361         f'Duplica
+00002450: 7465 6420 7372 6320 6261 7365 6e61 6d65  ted src basename
+00002460: 3a20 7b73 7263 5f62 6173 656e 616d 657d  : {src_basename}
+00002470: 3b20 6d6f 756e 7473 3a20 7b66 696c 655f  ; mounts: {file_
+00002480: 6d6f 756e 7473 7d27 290a 2020 2020 2020  mounts}').      
+00002490: 2020 6261 7365 6e61 6d65 732e 6164 6428    basenames.add(
+000024a0: 7372 635f 6261 7365 6e61 6d65 290a 2020  src_basename).  
+000024b0: 2020 2020 2020 2320 4f75 7220 7275 6e74        # Our runt
+000024c0: 696d 6520 6669 6c65 7320 2877 6865 656c  ime files (wheel
+000024d0: 2c20 7961 6d6c 2c20 6372 6564 656e 7469  , yaml, credenti
+000024e0: 616c 7329 2061 7265 206e 6f74 2072 656c  als) are not rel
+000024f0: 6174 6976 6520 7061 7468 732e 0a20 2020  ative paths..   
+00002500: 2020 2020 2061 7373 6572 7420 6473 745f       assert dst_
+00002510: 7061 7265 6e74 5f64 6972 2c20 6627 466f  parent_dir, f'Fo
+00002520: 756e 6420 7265 6c61 7469 7665 2064 6573  und relative des
+00002530: 7469 6e61 7469 6f6e 2070 6174 683a 207b  tination path: {
+00002540: 6473 747d 270a 0a20 2020 2020 2020 206d  dst}'..        m
+00002550: 6b64 6972 5f70 6172 656e 7420 3d20 6627  kdir_parent = f'
+00002560: 6d6b 6469 7220 2d70 207b 6473 745f 7061  mkdir -p {dst_pa
+00002570: 7265 6e74 5f64 6972 7d27 0a20 2020 2020  rent_dir}'.     
+00002580: 2020 2069 6620 6f73 2e70 6174 682e 6973     if os.path.is
+00002590: 6469 7228 6f73 2e70 6174 682e 6578 7061  dir(os.path.expa
+000025a0: 6e64 7573 6572 2873 7263 2929 3a0a 2020  nduser(src)):.  
+000025b0: 2020 2020 2020 2020 2020 2320 5370 6563            # Spec
+000025c0: 6961 6c20 6361 7365 2066 6f72 2064 6972  ial case for dir
+000025d0: 6563 746f 7269 6573 2e20 4966 2074 6865  ectories. If the
+000025e0: 2064 7374 2061 6c72 6561 6479 2065 7869   dst already exi
+000025f0: 7374 7320 6173 2061 0a20 2020 2020 2020  sts as a.       
+00002600: 2020 2020 2023 2066 6f6c 6465 722c 2064       # folder, d
+00002610: 6972 6563 746c 7920 636f 7079 2074 6865  irectly copy the
+00002620: 2066 6f6c 6465 7220 7769 6c6c 2063 7265   folder will cre
+00002630: 6174 6520 6120 7375 6266 6f6c 6465 7220  ate a subfolder 
+00002640: 756e 6465 720a 2020 2020 2020 2020 2020  under.          
+00002650: 2020 2320 7468 6520 6473 742e 0a20 2020    # the dst..   
+00002660: 2020 2020 2020 2020 206d 6b64 6972 5f70           mkdir_p
+00002670: 6172 656e 7420 3d20 6627 6d6b 6469 7220  arent = f'mkdir 
+00002680: 2d70 207b 6473 747d 270a 2020 2020 2020  -p {dst}'.      
+00002690: 2020 2020 2020 7372 635f 6261 7365 6e61        src_basena
+000026a0: 6d65 203d 2066 277b 7372 635f 6261 7365  me = f'{src_base
+000026b0: 6e61 6d65 7d2f 2a27 0a20 2020 2020 2020  name}/*'.       
+000026c0: 206d 7620 3d20 2866 2763 7020 2d72 207b   mv = (f'cp -r {
+000026d0: 5f52 454d 4f54 455f 5255 4e54 494d 455f  _REMOTE_RUNTIME_
+000026e0: 4649 4c45 535f 4449 527d 2f7b 7372 635f  FILES_DIR}/{src_
+000026f0: 6261 7365 6e61 6d65 7d20 270a 2020 2020  basename} '.    
+00002700: 2020 2020 2020 2020 2020 6627 7b64 7374            f'{dst
+00002710: 5f70 6172 656e 745f 6469 727d 2f7b 6473  _parent_dir}/{ds
+00002720: 745f 6261 7365 6e61 6d65 7d27 290a 2020  t_basename}').  
+00002730: 2020 2020 2020 6672 6167 6d65 6e74 203d        fragment =
+00002740: 2066 2728 7b6d 6b64 6972 5f70 6172 656e   f'({mkdir_paren
+00002750: 747d 2026 2620 7b6d 767d 2927 0a20 2020  t} && {mv})'.   
+00002760: 2020 2020 2063 6f6d 6d61 6e64 732e 6170       commands.ap
+00002770: 7065 6e64 2866 7261 676d 656e 7429 0a20  pend(fragment). 
+00002780: 2020 2070 6f73 7470 726f 6365 7373 5f72     postprocess_r
+00002790: 756e 7469 6d65 5f66 696c 6573 5f63 6f6d  untime_files_com
+000027a0: 6d61 6e64 203d 2027 2026 2620 272e 6a6f  mand = ' && '.jo
+000027b0: 696e 2863 6f6d 6d61 6e64 7329 0a0a 2020  in(commands)..  
+000027c0: 2020 7365 7475 705f 636f 6d6d 616e 6473    setup_commands
+000027d0: 203d 2079 616d 6c5f 636f 6e66 6967 2e67   = yaml_config.g
+000027e0: 6574 2827 7365 7475 705f 636f 6d6d 616e  et('setup_comman
+000027f0: 6473 272c 205b 5d29 0a20 2020 2069 6620  ds', []).    if 
+00002800: 7365 7475 705f 636f 6d6d 616e 6473 3a0a  setup_commands:.
+00002810: 2020 2020 2020 2020 7365 7475 705f 636f          setup_co
+00002820: 6d6d 616e 6473 5b0a 2020 2020 2020 2020  mmands[.        
+00002830: 2020 2020 305d 203d 2066 277b 706f 7374      0] = f'{post
+00002840: 7072 6f63 6573 735f 7275 6e74 696d 655f  process_runtime_
+00002850: 6669 6c65 735f 636f 6d6d 616e 647d 3b20  files_command}; 
+00002860: 7b73 6574 7570 5f63 6f6d 6d61 6e64 735b  {setup_commands[
+00002870: 305d 7d27 0a20 2020 2065 6c73 653a 0a20  0]}'.    else:. 
+00002880: 2020 2020 2020 2073 6574 7570 5f63 6f6d         setup_com
+00002890: 6d61 6e64 7320 3d20 5b70 6f73 7470 726f  mands = [postpro
+000028a0: 6365 7373 5f72 756e 7469 6d65 5f66 696c  cess_runtime_fil
+000028b0: 6573 5f63 6f6d 6d61 6e64 5d0a 0a20 2020  es_command]..   
+000028c0: 2079 616d 6c5f 636f 6e66 6967 5b27 6669   yaml_config['fi
+000028d0: 6c65 5f6d 6f75 6e74 7327 5d20 3d20 6e65  le_mounts'] = ne
+000028e0: 775f 6669 6c65 5f6d 6f75 6e74 730a 2020  w_file_mounts.  
+000028f0: 2020 7961 6d6c 5f63 6f6e 6669 675b 2773    yaml_config['s
+00002900: 6574 7570 5f63 6f6d 6d61 6e64 7327 5d20  etup_commands'] 
+00002910: 3d20 7365 7475 705f 636f 6d6d 616e 6473  = setup_commands
+00002920: 0a0a 2020 2020 2320 2846 6f72 206c 6f63  ..    # (For loc
+00002930: 616c 2920 436f 7079 2061 6c6c 2072 756e  al) Copy all run
+00002940: 7469 6d65 2066 696c 6573 2c20 696e 636c  time files, incl
+00002950: 7564 696e 6720 7468 6520 6a75 7374 2d77  uding the just-w
+00002960: 7269 7474 656e 2079 616d 6c2c 2074 6f0a  ritten yaml, to.
+00002970: 2020 2020 2320 6c6f 6361 6c5f 7275 6e74      # local_runt
+00002980: 696d 655f 6669 6c65 735f 6469 722f 2e0a  ime_files_dir/..
+00002990: 2020 2020 2320 3c20 302e 3373 2074 6f20      # < 0.3s to 
+000029a0: 6370 2036 2063 6c6f 7564 7327 2063 7265  cp 6 clouds' cre
+000029b0: 6465 6e74 6961 6c73 2e0a 2020 2020 666f  dentials..    fo
+000029c0: 7220 6c6f 6361 6c5f 7372 6320 696e 2066  r local_src in f
+000029d0: 696c 655f 6d6f 756e 7473 2e76 616c 7565  ile_mounts.value
+000029e0: 7328 293a 0a20 2020 2020 2020 2023 2063  s():.        # c
+000029f0: 7020 3c6c 6f63 616c 5f73 7263 3e20 3c6c  p <local_src> <l
+00002a00: 6f63 616c 5f72 756e 7469 6d65 5f66 696c  ocal_runtime_fil
+00002a10: 6573 5f64 6972 3e2f 3c75 6e69 7175 6520  es_dir>/<unique 
+00002a20: 6e61 6d65 206f 6620 6c6f 6361 6c5f 7372  name of local_sr
+00002a30: 633e 2e0a 2020 2020 2020 2020 6675 6c6c  c>..        full
+00002a40: 5f6c 6f63 616c 5f73 7263 203d 2073 7472  _local_src = str
+00002a50: 2870 6174 686c 6962 2e50 6174 6828 6c6f  (pathlib.Path(lo
+00002a60: 6361 6c5f 7372 6329 2e65 7870 616e 6475  cal_src).expandu
+00002a70: 7365 7228 2929 0a20 2020 2020 2020 2075  ser()).        u
+00002a80: 6e69 7175 655f 6e61 6d65 203d 206c 6f63  nique_name = loc
+00002a90: 616c 5f73 6f75 7263 655f 746f 5f75 6e69  al_source_to_uni
+00002aa0: 7175 655f 6e61 6d65 5b6c 6f63 616c 5f73  que_name[local_s
+00002ab0: 7263 5d0a 2020 2020 2020 2020 2320 2172  rc].        # !r
+00002ac0: 2074 6f20 6164 6420 7175 6f74 6573 2066   to add quotes f
+00002ad0: 6f72 2070 6174 6873 2063 6f6e 7461 696e  or paths contain
+00002ae0: 696e 6720 7370 6163 6573 2e0a 2020 2020  ing spaces..    
+00002af0: 2020 2020 7375 6270 726f 6365 7373 2e72      subprocess.r
+00002b00: 756e 280a 2020 2020 2020 2020 2020 2020  un(.            
+00002b10: 6627 6370 202d 7220 7b66 756c 6c5f 6c6f  f'cp -r {full_lo
+00002b20: 6361 6c5f 7372 6321 727d 207b 6c6f 6361  cal_src!r} {loca
+00002b30: 6c5f 7275 6e74 696d 655f 6669 6c65 735f  l_runtime_files_
+00002b40: 6469 727d 2f7b 756e 6971 7565 5f6e 616d  dir}/{unique_nam
+00002b50: 657d 272c 0a20 2020 2020 2020 2020 2020  e}',.           
+00002b60: 2073 6865 6c6c 3d54 7275 652c 0a20 2020   shell=True,.   
+00002b70: 2020 2020 2020 2020 2063 6865 636b 3d54           check=T
+00002b80: 7275 6529 0a0a 2020 2020 636f 6d6d 6f6e  rue)..    common
+00002b90: 5f75 7469 6c73 2e64 756d 705f 7961 6d6c  _utils.dump_yaml
+00002ba0: 2879 616d 6c5f 7061 7468 2c20 7961 6d6c  (yaml_path, yaml
+00002bb0: 5f63 6f6e 6669 6729 0a0a 0a64 6566 2070  _config)...def p
+00002bc0: 6174 685f 7369 7a65 5f6d 6567 6162 7974  ath_size_megabyt
+00002bd0: 6573 2870 6174 683a 2073 7472 2920 2d3e  es(path: str) ->
+00002be0: 2069 6e74 3a0a 2020 2020 2222 2252 6574   int:.    """Ret
+00002bf0: 7572 6e73 2074 6865 2073 697a 6520 6f66  urns the size of
+00002c00: 2027 7061 7468 2720 2864 6972 6563 746f   'path' (directo
+00002c10: 7279 206f 7220 6669 6c65 2920 696e 206d  ry or file) in m
+00002c20: 6567 6162 7974 6573 2e0a 0a20 2020 2052  egabytes...    R
+00002c30: 6574 7572 6e73 3a0a 2020 2020 2020 2020  eturns:.        
+00002c40: 4966 2073 7563 6365 7373 6675 6c3a 2074  If successful: t
+00002c50: 6865 2073 697a 6520 6f66 2027 7061 7468  he size of 'path
+00002c60: 2720 696e 206d 6567 6162 7974 6573 2c20  ' in megabytes, 
+00002c70: 726f 756e 6465 6420 646f 776e 2e20 4f74  rounded down. Ot
+00002c80: 6865 7277 6973 652c 0a20 2020 2020 2020  herwise,.       
+00002c90: 202d 312e 0a20 2020 2022 2222 0a20 2020   -1..    """.   
+00002ca0: 2072 6573 6f6c 7665 645f 7061 7468 203d   resolved_path =
+00002cb0: 2070 6174 686c 6962 2e50 6174 6828 7061   pathlib.Path(pa
+00002cc0: 7468 292e 6578 7061 6e64 7573 6572 2829  th).expanduser()
+00002cd0: 2e72 6573 6f6c 7665 2829 0a20 2020 2067  .resolve().    g
+00002ce0: 6974 5f65 7863 6c75 6465 5f66 696c 7465  it_exclude_filte
+00002cf0: 7220 3d20 2727 0a20 2020 2069 6620 2872  r = ''.    if (r
+00002d00: 6573 6f6c 7665 645f 7061 7468 202f 2063  esolved_path / c
+00002d10: 6f6d 6d61 6e64 5f72 756e 6e65 722e 4749  ommand_runner.GI
+00002d20: 545f 4558 434c 5544 4529 2e65 7869 7374  T_EXCLUDE).exist
+00002d30: 7328 293a 0a20 2020 2020 2020 2023 2045  s():.        # E
+00002d40: 6e73 7572 6520 6669 6c65 2065 7869 7374  nsure file exist
+00002d50: 733b 206f 7468 6572 7769 7365 2c20 7273  s; otherwise, rs
+00002d60: 796e 6320 7769 6c6c 2065 7272 6f72 206f  ync will error o
+00002d70: 7574 2e0a 2020 2020 2020 2020 230a 2020  ut..        #.  
+00002d80: 2020 2020 2020 2320 5765 2073 686c 6578        # We shlex
+00002d90: 2e71 756f 7465 2829 2062 6563 6175 7365  .quote() because
+00002da0: 2074 6865 2070 6174 6820 6d61 7920 636f   the path may co
+00002db0: 6e74 6169 6e20 7370 6163 6573 3a0a 2020  ntain spaces:.  
+00002dc0: 2020 2020 2020 2320 2020 276d 7920 6469        #   'my di
+00002dd0: 722f 2e67 6974 2f69 6e66 6f2f 6578 636c  r/.git/info/excl
+00002de0: 7564 6527 0a20 2020 2020 2020 2023 2057  ude'.        # W
+00002df0: 6974 686f 7574 2071 756f 7469 6e67 2072  ithout quoting r
+00002e00: 7379 6e63 2066 6169 6c73 2e0a 2020 2020  sync fails..    
+00002e10: 2020 2020 6769 745f 6578 636c 7564 655f      git_exclude_
+00002e20: 6669 6c74 6572 203d 2063 6f6d 6d61 6e64  filter = command
+00002e30: 5f72 756e 6e65 722e 5253 594e 435f 4558  _runner.RSYNC_EX
+00002e40: 434c 5544 455f 4f50 5449 4f4e 2e66 6f72  CLUDE_OPTION.for
+00002e50: 6d61 7428 0a20 2020 2020 2020 2020 2020  mat(.           
+00002e60: 2073 686c 6578 2e71 756f 7465 2873 7472   shlex.quote(str
+00002e70: 2872 6573 6f6c 7665 645f 7061 7468 202f  (resolved_path /
+00002e80: 2063 6f6d 6d61 6e64 5f72 756e 6e65 722e   command_runner.
+00002e90: 4749 545f 4558 434c 5544 4529 2929 0a20  GIT_EXCLUDE))). 
+00002ea0: 2020 2072 7379 6e63 5f63 6f6d 6d61 6e64     rsync_command
+00002eb0: 203d 2028 6627 7273 796e 6320 7b63 6f6d   = (f'rsync {com
+00002ec0: 6d61 6e64 5f72 756e 6e65 722e 5253 594e  mand_runner.RSYN
+00002ed0: 435f 4449 5350 4c41 595f 4f50 5449 4f4e  C_DISPLAY_OPTION
+00002ee0: 7d20 270a 2020 2020 2020 2020 2020 2020  } '.            
+00002ef0: 2020 2020 2020 2020 2066 277b 636f 6d6d           f'{comm
+00002f00: 616e 645f 7275 6e6e 6572 2e52 5359 4e43  and_runner.RSYNC
+00002f10: 5f46 494c 5445 525f 4f50 5449 4f4e 7d20  _FILTER_OPTION} 
+00002f20: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00002f30: 2020 2020 2020 2066 277b 6769 745f 6578         f'{git_ex
+00002f40: 636c 7564 655f 6669 6c74 6572 7d20 2d2d  clude_filter} --
+00002f50: 6472 792d 7275 6e20 7b70 6174 6821 727d  dry-run {path!r}
+00002f60: 2729 0a20 2020 2072 7379 6e63 5f6f 7574  ').    rsync_out
+00002f70: 7075 7420 3d20 2727 0a20 2020 2074 7279  put = ''.    try
+00002f80: 3a0a 2020 2020 2020 2020 7273 796e 635f  :.        rsync_
+00002f90: 6f75 7470 7574 203d 2073 7472 2873 7562  output = str(sub
+00002fa0: 7072 6f63 6573 732e 6368 6563 6b5f 6f75  process.check_ou
+00002fb0: 7470 7574 2872 7379 6e63 5f63 6f6d 6d61  tput(rsync_comma
+00002fc0: 6e64 2c20 7368 656c 6c3d 5472 7565 2929  nd, shell=True))
+00002fd0: 0a20 2020 2065 7863 6570 7420 7375 6270  .    except subp
+00002fe0: 726f 6365 7373 2e43 616c 6c65 6450 726f  rocess.CalledPro
+00002ff0: 6365 7373 4572 726f 723a 0a20 2020 2020  cessError:.     
+00003000: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
+00003010: 2743 6f6d 6d61 6e64 2066 6169 6c65 642c  'Command failed,
+00003020: 2070 726f 6365 6564 696e 6720 7769 7468   proceeding with
+00003030: 6f75 7420 6573 7469 6d61 7469 6e67 2073  out estimating s
+00003040: 697a 653a 2027 0a20 2020 2020 2020 2020  ize: '.         
+00003050: 2020 2020 2020 2020 2020 2020 6627 7b72              f'{r
+00003060: 7379 6e63 5f63 6f6d 6d61 6e64 7d27 290a  sync_command}').
+00003070: 2020 2020 2020 2020 7265 7475 726e 202d          return -
+00003080: 310a 2020 2020 2320 332e 322e 333a 0a20  1.    # 3.2.3:. 
+00003090: 2020 2023 2020 746f 7461 6c20 7369 7a65     #  total size
+000030a0: 2069 7320 3235 302c 3935 372c 3732 3820   is 250,957,728 
+000030b0: 2073 7065 6564 7570 2069 7320 3333 302e   speedup is 330.
+000030c0: 3139 2028 4452 5920 5255 4e29 0a20 2020  19 (DRY RUN).   
+000030d0: 2023 2032 2e36 2e39 3a0a 2020 2020 2320   # 2.6.9:.    # 
+000030e0: 2074 6f74 616c 2073 697a 6520 6973 2032   total size is 2
+000030f0: 3132 3632 3735 3536 2020 7370 6565 6475  12627556  speedu
+00003100: 7020 6973 2032 3433 372e 3431 0a20 2020  p is 2437.41.   
+00003110: 206d 6174 6368 203d 2072 652e 7365 6172   match = re.sear
+00003120: 6368 2872 2774 6f74 616c 2073 697a 6520  ch(r'total size 
+00003130: 6973 2028 5b5c 642c 5d2b 2927 2c20 7273  is ([\d,]+)', rs
+00003140: 796e 635f 6f75 7470 7574 290a 2020 2020  ync_output).    
+00003150: 6966 206d 6174 6368 2069 7320 6e6f 7420  if match is not 
+00003160: 4e6f 6e65 3a0a 2020 2020 2020 2020 7472  None:.        tr
+00003170: 793a 0a20 2020 2020 2020 2020 2020 2074  y:.            t
+00003180: 6f74 616c 5f62 7974 6573 203d 2069 6e74  otal_bytes = int
+00003190: 2866 6c6f 6174 286d 6174 6368 2e67 726f  (float(match.gro
+000031a0: 7570 2831 292e 7265 706c 6163 6528 272c  up(1).replace(',
+000031b0: 272c 2027 2729 2929 0a20 2020 2020 2020  ', ''))).       
+000031c0: 2020 2020 2072 6574 7572 6e20 746f 7461       return tota
+000031d0: 6c5f 6279 7465 7320 2f2f 2028 3130 3234  l_bytes // (1024
+000031e0: 2a2a 3229 0a20 2020 2020 2020 2065 7863  **2).        exc
+000031f0: 6570 7420 5661 6c75 6545 7272 6f72 3a0a  ept ValueError:.
+00003200: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+00003210: 6572 2e64 6562 7567 2827 4661 696c 6564  er.debug('Failed
+00003220: 2074 6f20 6669 6e64 2022 746f 7461 6c20   to find "total 
+00003230: 7369 7a65 2220 696e 2072 7379 6e63 206f  size" in rsync o
+00003240: 7574 7075 742e 2049 6e73 7065 6374 2027  utput. Inspect '
+00003250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003260: 2020 2020 2020 2020 2020 6627 6f75 7470            f'outp
+00003270: 7574 206f 6620 7468 6520 666f 6c6c 6f77  ut of the follow
+00003280: 696e 6720 636f 6d6d 616e 643a 207b 7273  ing command: {rs
+00003290: 796e 635f 636f 6d6d 616e 647d 2729 0a20  ync_command}'). 
+000032a0: 2020 2020 2020 2020 2020 2070 6173 7320             pass 
+000032b0: 2023 204d 6179 6265 2064 6966 6665 7265   # Maybe differe
+000032c0: 6e74 2072 7379 6e63 2076 6572 7369 6f6e  nt rsync version
+000032d0: 7320 6861 7665 2064 6966 6665 7265 6e74  s have different
+000032e0: 206f 7574 7075 742e 0a20 2020 2072 6574   output..    ret
+000032f0: 7572 6e20 2d31 0a0a 0a63 6c61 7373 2046  urn -1...class F
+00003300: 696c 654d 6f75 6e74 4865 6c70 6572 286f  ileMountHelper(o
+00003310: 626a 6563 7429 3a0a 2020 2020 2222 2248  bject):.    """H
+00003320: 656c 7065 7220 666f 7220 6861 6e64 6c69  elper for handli
+00003330: 6e67 2066 696c 6520 6d6f 756e 7473 2e22  ng file mounts."
+00003340: 2222 0a0a 2020 2020 4063 6c61 7373 6d65  ""..    @classme
+00003350: 7468 6f64 0a20 2020 2064 6566 2077 7261  thod.    def wra
+00003360: 705f 6669 6c65 5f6d 6f75 6e74 2863 6c73  p_file_mount(cls
+00003370: 2c20 7061 7468 3a20 7374 7229 202d 3e20  , path: str) -> 
+00003380: 7374 723a 0a20 2020 2020 2020 2022 2222  str:.        """
+00003390: 5072 6570 656e 6473 207e 2f3c 6f70 6171  Prepends ~/<opaq
+000033a0: 7565 2064 6972 3e2f 2074 6f20 6120 7061  ue dir>/ to a pa
+000033b0: 7468 2074 6f20 776f 726b 2061 726f 756e  th to work aroun
+000033c0: 6420 7065 726d 6973 7369 6f6e 2069 7373  d permission iss
+000033d0: 7565 732e 0a0a 2020 2020 2020 2020 4578  ues...        Ex
+000033e0: 616d 706c 6573 3a0a 2020 2020 2020 2020  amples:.        
+000033f0: 2f72 6f6f 742f 6865 6c6c 6f2e 7478 7420  /root/hello.txt 
+00003400: 2d3e 207e 2f3c 6f70 6171 7565 2064 6972  -> ~/<opaque dir
+00003410: 3e2f 726f 6f74 2f68 656c 6c6f 2e74 7874  >/root/hello.txt
+00003420: 0a20 2020 2020 2020 206c 6f63 616c 2e74  .        local.t
+00003430: 7874 202d 3e20 7e2f 3c6f 7061 7175 6520  xt -> ~/<opaque 
+00003440: 6469 723e 2f6c 6f63 616c 2e74 7874 0a0a  dir>/local.txt..
+00003450: 2020 2020 2020 2020 4166 7465 7220 7468          After th
+00003460: 6520 7061 7468 2069 7320 7379 6e63 6564  e path is synced
+00003470: 2c20 7765 2063 616e 206c 6174 6572 2063  , we can later c
+00003480: 7265 6174 6520 6120 7379 6d6c 696e 6b20  reate a symlink 
+00003490: 746f 2074 6869 7320 7772 6170 7065 640a  to this wrapped.
+000034a0: 2020 2020 2020 2020 7061 7468 2066 726f          path fro
+000034b0: 6d20 7468 6520 6f72 6967 696e 616c 2070  m the original p
+000034c0: 6174 682c 2065 2e67 2e2c 2069 6e20 7468  ath, e.g., in th
+000034d0: 6520 696e 6974 6961 6c69 7a61 7469 6f6e  e initialization
+000034e0: 5f63 6f6d 6d61 6e64 7320 6f66 2074 6865  _commands of the
+000034f0: 0a20 2020 2020 2020 2072 6179 2061 7574  .        ray aut
+00003500: 6f73 6361 6c65 7220 5941 4d4c 2e0a 2020  oscaler YAML..  
+00003510: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00003520: 2020 7265 7475 726e 206f 732e 7061 7468    return os.path
+00003530: 2e6a 6f69 6e28 5f53 4b59 5f52 454d 4f54  .join(_SKY_REMOT
+00003540: 455f 4649 4c45 5f4d 4f55 4e54 535f 4449  E_FILE_MOUNTS_DI
+00003550: 522c 2070 6174 682e 6c73 7472 6970 2827  R, path.lstrip('
+00003560: 2f27 2929 0a0a 2020 2020 4063 6c61 7373  /'))..    @class
+00003570: 6d65 7468 6f64 0a20 2020 2064 6566 206d  method.    def m
+00003580: 616b 655f 7361 6665 5f73 796d 6c69 6e6b  ake_safe_symlink
+00003590: 5f63 6f6d 6d61 6e64 2863 6c73 2c20 2a2c  _command(cls, *,
+000035a0: 2073 6f75 7263 653a 2073 7472 2c20 7461   source: str, ta
+000035b0: 7267 6574 3a20 7374 7229 202d 3e20 7374  rget: str) -> st
+000035c0: 723a 0a20 2020 2020 2020 2022 2222 5265  r:.        """Re
+000035d0: 7475 726e 7320 6120 636f 6d6d 616e 6420  turns a command 
+000035e0: 7468 6174 2073 6166 656c 7920 7379 6d6c  that safely syml
+000035f0: 696e 6b73 2027 736f 7572 6365 2720 746f  inks 'source' to
+00003600: 2027 7461 7267 6574 272e 0a0a 2020 2020   'target'...    
+00003610: 2020 2020 416c 6c20 696e 7465 726d 6564      All intermed
+00003620: 6961 7465 2064 6972 6563 746f 7269 6573  iate directories
+00003630: 206f 6620 2773 6f75 7263 6527 2077 696c   of 'source' wil
+00003640: 6c20 6265 206f 776e 6564 2062 7920 2428  l be owned by $(
+00003650: 7768 6f61 6d69 292c 0a20 2020 2020 2020  whoami),.       
+00003660: 2065 7863 6c75 6469 6e67 2074 6865 2072   excluding the r
+00003670: 6f6f 7420 6469 7265 6374 6f72 7920 282f  oot directory (/
+00003680: 292e 0a0a 2020 2020 2020 2020 2773 6f75  )...        'sou
+00003690: 7263 6527 206d 7573 7420 6265 2061 6e20  rce' must be an 
+000036a0: 6162 736f 6c75 7465 2070 6174 683b 2062  absolute path; b
+000036b0: 6f74 6820 2773 6f75 7263 6527 2061 6e64  oth 'source' and
+000036c0: 2027 7461 7267 6574 2720 6d75 7374 206e   'target' must n
+000036d0: 6f74 0a20 2020 2020 2020 2065 6e64 2077  ot.        end w
+000036e0: 6974 6820 6120 736c 6173 6820 282f 292e  ith a slash (/).
+000036f0: 0a0a 2020 2020 2020 2020 5468 6973 2066  ..        This f
+00003700: 756e 6374 696f 6e20 6973 206e 6565 6465  unction is neede
+00003710: 6420 6265 6361 7573 6520 6120 7369 6d70  d because a simp
+00003720: 6c65 2027 6c6e 202d 7320 7461 7267 6574  le 'ln -s target
+00003730: 2073 6f75 7263 6527 206d 6179 0a20 2020   source' may.   
+00003740: 2020 2020 2066 6169 6c3a 2027 736f 7572       fail: 'sour
+00003750: 6365 2720 6361 6e20 6861 7665 206d 756c  ce' can have mul
+00003760: 7469 706c 6520 6c65 7665 6c73 2028 2f61  tiple levels (/a
+00003770: 2f62 2f63 292c 2069 7473 2070 6172 656e  /b/c), its paren
+00003780: 7420 6469 7273 206d 6179 0a20 2020 2020  t dirs may.     
+00003790: 2020 206f 7220 6d61 7920 6e6f 7420 6578     or may not ex
+000037a0: 6973 742c 2063 616e 2065 6e64 2077 6974  ist, can end wit
+000037b0: 6820 6120 736c 6173 682c 206f 7220 6d61  h a slash, or ma
+000037c0: 7920 6e65 6564 2073 7564 6f20 6163 6365  y need sudo acce
+000037d0: 7373 2c20 6574 632e 0a0a 2020 2020 2020  ss, etc...      
+000037e0: 2020 4361 7365 7320 6f66 203c 7461 7267    Cases of <targ
+000037f0: 6574 3a20 6c6f 6361 6c3e 2066 696c 6520  et: local> file 
+00003800: 6d6f 756e 7473 2061 6e64 2074 6865 6972  mounts and their
+00003810: 2062 6568 6176 696f 7273 3a0a 0a20 2020   behaviors:..   
+00003820: 2020 2020 2020 2020 202f 6578 6973 7469           /existi
+00003830: 6e67 5f64 6972 3a20 7e2f 6c6f 6361 6c2f  ng_dir: ~/local/
+00003840: 6469 720a 2020 2020 2020 2020 2020 2020  dir.            
+00003850: 2020 2d20 6572 726f 7220 6f75 7420 7361    - error out sa
+00003860: 7969 6e67 2074 6869 7320 6361 6e6e 6f74  ying this cannot
+00003870: 2062 6520 646f 6e65 2061 7320 4c48 5320   be done as LHS 
+00003880: 616c 7265 6164 7920 6578 6973 7473 0a20  already exists. 
+00003890: 2020 2020 2020 2020 2020 202f 6578 6973             /exis
+000038a0: 7469 6e67 5f66 696c 653a 207e 2f6c 6f63  ting_file: ~/loc
+000038b0: 616c 2f66 696c 650a 2020 2020 2020 2020  al/file.        
+000038c0: 2020 2020 2020 2d20 6572 726f 7220 6f75        - error ou
+000038d0: 7420 7361 7969 6e67 2074 6869 7320 6361  t saying this ca
+000038e0: 6e6e 6f74 2062 6520 646f 6e65 2061 7320  nnot be done as 
+000038f0: 4c48 5320 616c 7265 6164 7920 6578 6973  LHS already exis
+00003900: 7473 0a20 2020 2020 2020 2020 2020 202f  ts.            /
+00003910: 6578 6973 7469 6e67 5f73 796d 6c69 6e6b  existing_symlink
+00003920: 3a20 7e2f 6c6f 6361 6c2f 6669 6c65 0a20  : ~/local/file. 
+00003930: 2020 2020 2020 2020 2020 2020 202d 206f               - o
+00003940: 7665 7277 7269 7465 2074 6865 2065 7869  verwrite the exi
+00003950: 7374 696e 6720 7379 6d6c 696e 6b3b 2074  sting symlink; t
+00003960: 6869 7320 6973 2069 6d70 6f72 7461 6e74  his is important
+00003970: 2062 6563 6175 7365 2060 736b 790a 2020   because `sky.  
+00003980: 2020 2020 2020 2020 2020 2020 2020 6c61                la
+00003990: 756e 6368 6020 6361 6e20 6265 2072 756e  unch` can be run
+000039a0: 206d 756c 7469 706c 6520 7469 6d65 730a   multiple times.
+000039b0: 2020 2020 2020 2020 2020 2020 5061 7468              Path
+000039c0: 7320 7468 6174 2073 7461 7274 2077 6974  s that start wit
+000039d0: 6820 7e2f 2061 6e64 202f 746d 702f 2064  h ~/ and /tmp/ d
+000039e0: 6f20 6e6f 7420 6861 7665 2074 6865 2061  o not have the a
+000039f0: 626f 7665 0a20 2020 2020 2020 2020 2020  bove.           
+00003a00: 2072 6573 7472 6963 7469 6f6e 733b 2074   restrictions; t
+00003a10: 6865 7920 6172 6520 6465 6c65 6761 7465  hey are delegate
+00003a20: 6420 746f 2072 7379 6e63 2062 6568 6176  d to rsync behav
+00003a30: 696f 7273 2e0a 2020 2020 2020 2020 2222  iors..        ""
+00003a40: 220a 2020 2020 2020 2020 6173 7365 7274  ".        assert
+00003a50: 206f 732e 7061 7468 2e69 7361 6273 2873   os.path.isabs(s
+00003a60: 6f75 7263 6529 2c20 736f 7572 6365 0a20  ource), source. 
+00003a70: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
+00003a80: 7420 736f 7572 6365 2e65 6e64 7377 6974  t source.endswit
+00003a90: 6828 272f 2729 2061 6e64 206e 6f74 2074  h('/') and not t
+00003aa0: 6172 6765 742e 656e 6473 7769 7468 2827  arget.endswith('
+00003ab0: 2f27 292c 2028 736f 7572 6365 2c0a 2020  /'), (source,.  
+00003ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003b00: 2020 2020 2074 6172 6765 7429 0a20 2020       target).   
+00003b10: 2020 2020 2023 2042 656c 6f77 2c20 7573       # Below, us
+00003b20: 6520 7375 646f 2069 6e20 6361 7365 2074  e sudo in case t
+00003b30: 6865 2073 796d 6c69 6e6b 206e 6565 6473  he symlink needs
+00003b40: 2073 7564 6f20 6163 6365 7373 2074 6f20   sudo access to 
+00003b50: 6372 6561 7465 2e0a 2020 2020 2020 2020  create..        
+00003b60: 2320 5072 6570 6172 6520 746f 2063 7265  # Prepare to cre
+00003b70: 6174 6520 7468 6520 7379 6d6c 696e 6b3a  ate the symlink:
+00003b80: 0a20 2020 2020 2020 2023 2020 312e 206d  .        #  1. m
+00003b90: 616b 6520 7375 7265 2069 7473 2064 6972  ake sure its dir
+00003ba0: 2873 2920 6578 6973 7420 2620 6172 6520  (s) exist & are 
+00003bb0: 6f77 6e65 6420 6279 2024 2877 686f 616d  owned by $(whoam
+00003bc0: 6929 2e0a 2020 2020 2020 2020 6469 725f  i)..        dir_
+00003bd0: 6f66 5f73 796d 6c69 6e6b 203d 206f 732e  of_symlink = os.
+00003be0: 7061 7468 2e64 6972 6e61 6d65 2873 6f75  path.dirname(sou
+00003bf0: 7263 6529 0a20 2020 2020 2020 2063 6f6d  rce).        com
+00003c00: 6d61 6e64 7320 3d20 5b0a 2020 2020 2020  mands = [.      
+00003c10: 2020 2020 2020 2320 6d6b 6469 722c 2074        # mkdir, t
+00003c20: 6865 6e20 6c6f 6f70 206f 7665 7220 272f  hen loop over '/
+00003c30: 612f 622f 6327 2061 7320 2f61 2c20 2f61  a/b/c' as /a, /a
+00003c40: 2f62 2c20 2f61 2f62 2f63 2e20 2046 6f72  /b, /a/b/c.  For
+00003c50: 2065 6163 682c 0a20 2020 2020 2020 2020   each,.         
+00003c60: 2020 2023 2063 686f 776e 2024 2877 686f     # chown $(who
+00003c70: 616d 6929 206f 6e20 6974 2073 6f20 7573  ami) on it so us
+00003c80: 6572 2063 616e 2075 7365 2074 6865 7365  er can use these
+00003c90: 2069 6e74 6572 6d65 6469 6174 6520 6469   intermediate di
+00003ca0: 7273 0a20 2020 2020 2020 2020 2020 2023  rs.            #
+00003cb0: 2028 6578 636c 7564 696e 6720 2f29 2e0a   (excluding /)..
+00003cc0: 2020 2020 2020 2020 2020 2020 6627 7375              f'su
+00003cd0: 646f 206d 6b64 6972 202d 7020 7b64 6972  do mkdir -p {dir
+00003ce0: 5f6f 665f 7379 6d6c 696e 6b7d 272c 0a20  _of_symlink}',. 
+00003cf0: 2020 2020 2020 2020 2020 2023 2070 3a20             # p: 
+00003d00: 7061 7468 2073 6f20 6661 720a 2020 2020  path so far.    
+00003d10: 2020 2020 2020 2020 2827 2870 3d22 223b          ('(p="";
+00003d20: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+00003d30: 6627 666f 7220 7720 696e 2024 2865 6368  f'for w in $(ech
+00003d40: 6f20 7b64 6972 5f6f 665f 7379 6d6c 696e  o {dir_of_symlin
+00003d50: 6b7d 207c 2074 7220 222f 2220 2220 2229  k} | tr "/" " ")
+00003d60: 3b20 646f 2027 0a20 2020 2020 2020 2020  ; do '.         
+00003d70: 2020 2020 2770 3d24 7b70 7d2f 247b 777d      'p=${p}/${w}
+00003d80: 3b20 7375 646f 2063 686f 776e 2024 2877  ; sudo chown $(w
+00003d90: 686f 616d 6929 2024 703b 2064 6f6e 6529  hoami) $p; done)
+00003da0: 2729 0a20 2020 2020 2020 205d 0a20 2020  ').        ].   
+00003db0: 2020 2020 2023 2020 322e 2072 656d 6f76       #  2. remov
+00003dc0: 6520 616e 7920 6578 6973 7469 6e67 2073  e any existing s
+00003dd0: 796d 6c69 6e6b 2028 6c6e 202d 6620 6d61  ymlink (ln -f ma
+00003de0: 7920 7468 726f 7720 2763 616e 6e6f 740a  y throw 'cannot.
+00003df0: 2020 2020 2020 2020 2320 2020 2020 6f76          #     ov
+00003e00: 6572 7772 6974 6520 6469 7265 6374 6f72  erwrite director
+00003e10: 7927 2c20 6966 2074 6865 206c 696e 6b20  y', if the link 
+00003e20: 6578 6973 7473 2061 6e64 2070 6f69 6e74  exists and point
+00003e30: 7320 746f 2061 0a20 2020 2020 2020 2023  s to a.        #
+00003e40: 2020 2020 2064 6972 6563 746f 7279 292e       directory).
+00003e50: 0a20 2020 2020 2020 2063 6f6d 6d61 6e64  .        command
+00003e60: 7320 2b3d 205b 0a20 2020 2020 2020 2020  s += [.         
+00003e70: 2020 2023 2045 7272 6f72 206f 7574 2069     # Error out i
+00003e80: 6620 736f 7572 6365 2069 7320 616e 2065  f source is an e
+00003e90: 7869 7374 696e 672c 206e 6f6e 2d73 796d  xisting, non-sym
+00003ea0: 6c69 6e6b 2064 6972 6563 746f 7279 2f66  link directory/f
+00003eb0: 696c 652e 0a20 2020 2020 2020 2020 2020  ile..           
+00003ec0: 2066 2728 2874 6573 7420 2d4c 207b 736f   f'((test -L {so
+00003ed0: 7572 6365 7d20 2626 2073 7564 6f20 726d  urce} && sudo rm
+00003ee0: 207b 736f 7572 6365 7d20 263e 2f64 6576   {source} &>/dev
+00003ef0: 2f6e 756c 6c29 207c 7c20 270a 2020 2020  /null) || '.    
+00003f00: 2020 2020 2020 2020 6627 2874 6573 7420          f'(test 
+00003f10: 2120 2d65 207b 736f 7572 6365 7d20 7c7c  ! -e {source} ||
+00003f20: 2027 0a20 2020 2020 2020 2020 2020 2066   '.            f
+00003f30: 2728 6563 686f 2022 2121 2120 4661 696c  '(echo "!!! Fail
+00003f40: 6564 206d 6f75 6e74 696e 6720 6265 6361  ed mounting beca
+00003f50: 7573 6520 7061 7468 2065 7869 7374 7320  use path exists 
+00003f60: 287b 736f 7572 6365 7d29 223b 2027 0a20  ({source})"; '. 
+00003f70: 2020 2020 2020 2020 2020 2027 6578 6974             'exit
+00003f80: 2031 2929 2927 2c0a 2020 2020 2020 2020   1)))',.        
+00003f90: 5d0a 2020 2020 2020 2020 636f 6d6d 616e  ].        comman
+00003fa0: 6473 202b 3d20 5b0a 2020 2020 2020 2020  ds += [.        
+00003fb0: 2020 2020 2320 4c69 6e6b 2e0a 2020 2020      # Link..    
+00003fc0: 2020 2020 2020 2020 6627 7375 646f 206c          f'sudo l
+00003fd0: 6e20 2d73 207b 7461 7267 6574 7d20 7b73  n -s {target} {s
+00003fe0: 6f75 7263 657d 272c 0a20 2020 2020 2020  ource}',.       
+00003ff0: 2020 2020 2023 2063 686f 776e 2e20 202d       # chown.  -
+00004000: 6820 746f 2061 6666 6563 7420 7379 6d6c  h to affect syml
+00004010: 696e 6b73 206f 6e6c 792e 0a20 2020 2020  inks only..     
+00004020: 2020 2020 2020 2066 2773 7564 6f20 6368         f'sudo ch
+00004030: 6f77 6e20 2d68 2024 2877 686f 616d 6929  own -h $(whoami)
+00004040: 207b 736f 7572 6365 7d27 2c0a 2020 2020   {source}',.    
+00004050: 2020 2020 5d0a 2020 2020 2020 2020 7265      ].        re
+00004060: 7475 726e 2027 2026 2620 272e 6a6f 696e  turn ' && '.join
+00004070: 2863 6f6d 6d61 6e64 7329 0a0a 0a63 6c61  (commands)...cla
+00004080: 7373 2053 5348 436f 6e66 6967 4865 6c70  ss SSHConfigHelp
+00004090: 6572 286f 626a 6563 7429 3a0a 2020 2020  er(object):.    
+000040a0: 2222 2248 656c 7065 7220 666f 7220 6861  """Helper for ha
+000040b0: 6e64 6c69 6e67 206c 6f63 616c 2053 5348  ndling local SSH
+000040c0: 2063 6f6e 6669 6775 7261 7469 6f6e 2e22   configuration."
+000040d0: 2222 0a0a 2020 2020 7373 685f 636f 6e66  ""..    ssh_conf
+000040e0: 5f70 6174 6820 3d20 277e 2f2e 7373 682f  _path = '~/.ssh/
+000040f0: 636f 6e66 6967 270a 2020 2020 7373 685f  config'.    ssh_
+00004100: 636f 6e66 5f6c 6f63 6b5f 7061 7468 203d  conf_lock_path =
+00004110: 206f 732e 7061 7468 2e65 7870 616e 6475   os.path.expandu
+00004120: 7365 7228 277e 2f2e 736b 792f 7373 685f  ser('~/.sky/ssh_
+00004130: 636f 6e66 6967 2e6c 6f63 6b27 290a 2020  config.lock').  
+00004140: 2020 7373 685f 636c 7573 7465 725f 7061    ssh_cluster_pa
+00004150: 7468 203d 2053 4b59 5f55 5345 525f 4649  th = SKY_USER_FI
+00004160: 4c45 5f50 4154 4820 2b20 272f 7373 682f  LE_PATH + '/ssh/
+00004170: 7b7d 270a 0a20 2020 2040 636c 6173 736d  {}'..    @classm
+00004180: 6574 686f 640a 2020 2020 6465 6620 5f67  ethod.    def _g
+00004190: 6574 5f67 656e 6572 6174 6564 5f63 6f6e  et_generated_con
+000041a0: 6669 6728 636c 732c 2061 7574 6f67 656e  fig(cls, autogen
+000041b0: 5f63 6f6d 6d65 6e74 3a20 7374 722c 2068  _comment: str, h
+000041c0: 6f73 745f 6e61 6d65 3a20 7374 722c 0a20  ost_name: str,. 
+000041d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000041e0: 2020 2020 2020 2020 2020 2020 2069 703a               ip:
+000041f0: 2073 7472 2c20 7573 6572 6e61 6d65 3a20   str, username: 
+00004200: 7374 722c 2073 7368 5f6b 6579 5f70 6174  str, ssh_key_pat
+00004210: 683a 2073 7472 2c0a 2020 2020 2020 2020  h: str,.        
+00004220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004230: 2020 2020 2020 7072 6f78 795f 636f 6d6d        proxy_comm
+00004240: 616e 643a 204f 7074 696f 6e61 6c5b 7374  and: Optional[st
+00004250: 725d 2c20 706f 7274 3a20 696e 742c 0a20  r], port: int,. 
+00004260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004270: 2020 2020 2020 2020 2020 2020 2064 6f63               doc
+00004280: 6b65 725f 7072 6f78 795f 636f 6d6d 616e  ker_proxy_comman
+00004290: 643a 204f 7074 696f 6e61 6c5b 7374 725d  d: Optional[str]
+000042a0: 293a 0a20 2020 2020 2020 2069 6620 7072  ):.        if pr
+000042b0: 6f78 795f 636f 6d6d 616e 6420 6973 206e  oxy_command is n
+000042c0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+000042d0: 2020 2020 2023 2041 6c72 6561 6479 2063       # Already c
+000042e0: 6865 636b 6564 2069 6e20 7265 736f 7572  hecked in resour
+000042f0: 6365 730a 2020 2020 2020 2020 2020 2020  ces.            
+00004300: 6173 7365 7274 2064 6f63 6b65 725f 7072  assert docker_pr
+00004310: 6f78 795f 636f 6d6d 616e 6420 6973 204e  oxy_command is N
+00004320: 6f6e 652c 2028 0a20 2020 2020 2020 2020  one, (.         
+00004330: 2020 2020 2020 2027 4361 6e6e 6f74 2073         'Cannot s
+00004340: 7065 6369 6679 2062 6f74 6820 7072 6f78  pecify both prox
+00004350: 795f 636f 6d6d 616e 6420 616e 6420 646f  y_command and do
+00004360: 636b 6572 5f70 726f 7879 5f63 6f6d 6d61  cker_proxy_comma
+00004370: 6e64 2e27 290a 2020 2020 2020 2020 2020  nd.').          
+00004380: 2020 7072 6f78 7920 3d20 6627 5072 6f78    proxy = f'Prox
+00004390: 7943 6f6d 6d61 6e64 207b 7072 6f78 795f  yCommand {proxy_
+000043a0: 636f 6d6d 616e 647d 270a 2020 2020 2020  command}'.      
+000043b0: 2020 656c 6966 2064 6f63 6b65 725f 7072    elif docker_pr
+000043c0: 6f78 795f 636f 6d6d 616e 6420 6973 206e  oxy_command is n
+000043d0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+000043e0: 2020 2020 2070 726f 7879 203d 2066 2750       proxy = f'P
+000043f0: 726f 7879 436f 6d6d 616e 6420 7b64 6f63  roxyCommand {doc
+00004400: 6b65 725f 7072 6f78 795f 636f 6d6d 616e  ker_proxy_comman
+00004410: 647d 270a 2020 2020 2020 2020 656c 7365  d}'.        else
+00004420: 3a0a 2020 2020 2020 2020 2020 2020 7072  :.            pr
+00004430: 6f78 7920 3d20 2727 0a20 2020 2020 2020  oxy = ''.       
+00004440: 2023 2053 7472 6963 7448 6f73 744b 6579   # StrictHostKey
+00004450: 4368 6563 6b69 6e67 3d6e 6f20 736b 6970  Checking=no skip
+00004460: 7320 7468 6520 686f 7374 206b 6579 2063  s the host key c
+00004470: 6865 636b 2066 6f72 2074 6865 2066 6972  heck for the fir
+00004480: 7374 0a20 2020 2020 2020 2023 2074 696d  st.        # tim
+00004490: 652e 2055 7365 724b 6e6f 776e 486f 7374  e. UserKnownHost
+000044a0: 7346 696c 653d 2f64 6576 2f6e 756c 6c20  sFile=/dev/null 
+000044b0: 616e 6420 476c 6f62 616c 4b6e 6f77 6e48  and GlobalKnownH
+000044c0: 6f73 7473 4669 6c65 2f64 6576 2f6e 756c  ostsFile/dev/nul
+000044d0: 6c0a 2020 2020 2020 2020 2320 7072 6576  l.        # prev
+000044e0: 656e 7420 7468 6520 686f 7374 206b 6579  ent the host key
+000044f0: 2066 726f 6d20 6265 696e 6720 6164 6465   from being adde
+00004500: 6420 746f 2074 6865 206b 6e6f 776e 5f68  d to the known_h
+00004510: 6f73 7473 2066 696c 6520 616e 640a 2020  osts file and.  
+00004520: 2020 2020 2020 2320 616c 7761 7973 2072        # always r
+00004530: 6574 7572 6e20 616e 2065 6d70 7479 2066  eturn an empty f
+00004540: 696c 6520 666f 7220 6b6e 6f77 6e20 686f  ile for known ho
+00004550: 7374 732c 206d 616b 696e 6720 7468 6520  sts, making the 
+00004560: 7373 6820 7468 696e 6b0a 2020 2020 2020  ssh think.      
+00004570: 2020 2320 7468 6973 2069 7320 6120 6669    # this is a fi
+00004580: 7273 742d 7469 6d65 2063 6f6e 6e65 6374  rst-time connect
+00004590: 696f 6e2c 2061 6e64 2074 6875 7320 736b  ion, and thus sk
+000045a0: 6970 7069 6e67 2074 6865 2068 6f73 7420  ipping the host 
+000045b0: 6b65 790a 2020 2020 2020 2020 2320 6368  key.        # ch
+000045c0: 6563 6b2e 0a20 2020 2020 2020 2063 6f64  eck..        cod
+000045d0: 6567 656e 203d 2074 6578 7477 7261 702e  egen = textwrap.
+000045e0: 6465 6465 6e74 2866 2222 225c 0a20 2020  dedent(f"""\.   
+000045f0: 2020 2020 2020 2020 207b 6175 746f 6765           {autoge
+00004600: 6e5f 636f 6d6d 656e 747d 0a20 2020 2020  n_comment}.     
+00004610: 2020 2020 2020 2048 6f73 7420 7b68 6f73         Host {hos
+00004620: 745f 6e61 6d65 7d0a 2020 2020 2020 2020  t_name}.        
+00004630: 2020 2020 2020 486f 7374 4e61 6d65 207b        HostName {
+00004640: 6970 7d0a 2020 2020 2020 2020 2020 2020  ip}.            
+00004650: 2020 5573 6572 207b 7573 6572 6e61 6d65    User {username
+00004660: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+00004670: 4964 656e 7469 7479 4669 6c65 207b 7373  IdentityFile {ss
+00004680: 685f 6b65 795f 7061 7468 7d0a 2020 2020  h_key_path}.    
+00004690: 2020 2020 2020 2020 2020 4964 656e 7469            Identi
+000046a0: 7469 6573 4f6e 6c79 2079 6573 0a20 2020  tiesOnly yes.   
+000046b0: 2020 2020 2020 2020 2020 2046 6f72 7761             Forwa
+000046c0: 7264 4167 656e 7420 7965 730a 2020 2020  rdAgent yes.    
+000046d0: 2020 2020 2020 2020 2020 5374 7269 6374            Strict
+000046e0: 486f 7374 4b65 7943 6865 636b 696e 6720  HostKeyChecking 
+000046f0: 6e6f 0a20 2020 2020 2020 2020 2020 2020  no.             
+00004700: 2055 7365 724b 6e6f 776e 486f 7374 7346   UserKnownHostsF
+00004710: 696c 653d 2f64 6576 2f6e 756c 6c0a 2020  ile=/dev/null.  
+00004720: 2020 2020 2020 2020 2020 2020 476c 6f62              Glob
+00004730: 616c 4b6e 6f77 6e48 6f73 7473 4669 6c65  alKnownHostsFile
+00004740: 3d2f 6465 762f 6e75 6c6c 0a20 2020 2020  =/dev/null.     
+00004750: 2020 2020 2020 2020 2050 6f72 7420 7b70           Port {p
+00004760: 6f72 747d 0a20 2020 2020 2020 2020 2020  ort}.           
+00004770: 2020 207b 7072 6f78 797d 0a20 2020 2020     {proxy}.     
+00004780: 2020 2020 2020 2022 2222 2e72 7374 7269         """.rstri
+00004790: 7028 2929 0a20 2020 2020 2020 2063 6f64  p()).        cod
+000047a0: 6567 656e 203d 2063 6f64 6567 656e 202b  egen = codegen +
+000047b0: 2027 5c6e 270a 2020 2020 2020 2020 7265   '\n'.        re
+000047c0: 7475 726e 2063 6f64 6567 656e 0a0a 2020  turn codegen..  
+000047d0: 2020 4063 6c61 7373 6d65 7468 6f64 0a20    @classmethod. 
+000047e0: 2020 2040 7469 6d65 6c69 6e65 2e46 696c     @timeline.Fil
+000047f0: 654c 6f63 6b45 7665 6e74 2873 7368 5f63  eLockEvent(ssh_c
+00004800: 6f6e 665f 6c6f 636b 5f70 6174 6829 0a20  onf_lock_path). 
+00004810: 2020 2064 6566 2061 6464 5f63 6c75 7374     def add_clust
+00004820: 6572 280a 2020 2020 2020 2020 636c 732c  er(.        cls,
+00004830: 0a20 2020 2020 2020 2063 6c75 7374 6572  .        cluster
+00004840: 5f6e 616d 653a 2073 7472 2c0a 2020 2020  _name: str,.    
+00004850: 2020 2020 6970 733a 204c 6973 745b 7374      ips: List[st
+00004860: 725d 2c0a 2020 2020 2020 2020 6175 7468  r],.        auth
+00004870: 5f63 6f6e 6669 673a 2044 6963 745b 7374  _config: Dict[st
+00004880: 722c 2073 7472 5d2c 0a20 2020 2020 2020  r, str],.       
+00004890: 2070 6f72 7473 3a20 4c69 7374 5b69 6e74   ports: List[int
+000048a0: 5d2c 0a20 2020 2020 2020 2064 6f63 6b65  ],.        docke
+000048b0: 725f 7573 6572 3a20 4f70 7469 6f6e 616c  r_user: Optional
+000048c0: 5b73 7472 5d20 3d20 4e6f 6e65 2c0a 2020  [str] = None,.  
+000048d0: 2020 2020 2020 7373 685f 7573 6572 3a20        ssh_user: 
+000048e0: 4f70 7469 6f6e 616c 5b73 7472 5d20 3d20  Optional[str] = 
+000048f0: 4e6f 6e65 2c0a 2020 2020 293a 0a20 2020  None,.    ):.   
+00004900: 2020 2020 2022 2222 4164 6420 6175 7468       """Add auth
+00004910: 656e 7469 6361 7469 6f6e 2069 6e66 6f72  entication infor
+00004920: 6d61 7469 6f6e 2066 6f72 2063 6c75 7374  mation for clust
+00004930: 6572 2074 6f20 6c6f 6361 6c20 5353 4820  er to local SSH 
+00004940: 636f 6e66 6967 2066 696c 652e 0a0a 2020  config file...  
+00004950: 2020 2020 2020 4966 2061 2068 6f73 7420        If a host 
+00004960: 7769 7468 2060 636c 7573 7465 725f 6e61  with `cluster_na
+00004970: 6d65 6020 616c 7265 6164 7920 6578 6973  me` already exis
+00004980: 7473 2061 6e64 2074 6865 2063 6f6e 6669  ts and the confi
+00004990: 6775 7261 7469 6f6e 2077 6173 0a20 2020  guration was.   
+000049a0: 2020 2020 206e 6f74 2061 6464 6564 2062       not added b
+000049b0: 7920 736b 792c 2074 6865 6e20 6069 7060  y sky, then `ip`
+000049c0: 2069 7320 7573 6564 2074 6f20 6964 656e   is used to iden
+000049d0: 7469 6679 2074 6865 2068 6f73 7420 696e  tify the host in
+000049e0: 7374 6561 6420 696e 2074 6865 0a20 2020  stead in the.   
+000049f0: 2020 2020 2066 696c 652e 0a0a 2020 2020       file...    
+00004a00: 2020 2020 4966 2061 2068 6f73 7420 7769      If a host wi
+00004a10: 7468 2060 636c 7573 7465 725f 6e61 6d65  th `cluster_name
+00004a20: 6020 616c 7265 6164 7920 6578 6973 7473  ` already exists
+00004a30: 2061 6e64 2074 6865 2063 6f6e 6669 6775   and the configu
+00004a40: 7261 7469 6f6e 2077 6173 0a20 2020 2020  ration was.     
+00004a50: 2020 2061 6464 6564 2062 7920 736b 7920     added by sky 
+00004a60: 2865 2e67 2e20 6120 7370 6f74 2069 6e73  (e.g. a spot ins
+00004a70: 7461 6e63 6529 2c20 7468 656e 2074 6865  tance), then the
+00004a80: 2063 6f6e 6669 6775 7261 7469 6f6e 2069   configuration i
+00004a90: 730a 2020 2020 2020 2020 6f76 6572 7772  s.        overwr
+00004aa0: 6974 7465 6e2e 0a0a 2020 2020 2020 2020  itten...        
+00004ab0: 4172 6773 3a0a 2020 2020 2020 2020 2020  Args:.          
+00004ac0: 2020 636c 7573 7465 725f 6e61 6d65 3a20    cluster_name: 
+00004ad0: 436c 7573 7465 7220 6e61 6d65 2028 7365  Cluster name (se
+00004ae0: 6520 6073 6b79 2073 7461 7475 7360 290a  e `sky status`).
+00004af0: 2020 2020 2020 2020 2020 2020 6970 733a              ips:
+00004b00: 204c 6973 7420 6f66 2070 7562 6c69 6320   List of public 
+00004b10: 4950 2061 6464 7265 7373 6573 2069 6e20  IP addresses in 
+00004b20: 7468 6520 636c 7573 7465 722e 2046 6972  the cluster. Fir
+00004b30: 7374 2049 5020 6973 2068 6561 640a 2020  st IP is head.  
+00004b40: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
+00004b50: 2e0a 2020 2020 2020 2020 2020 2020 6175  ..            au
+00004b60: 7468 5f63 6f6e 6669 673a 2072 6561 645f  th_config: read_
+00004b70: 7961 6d6c 2868 616e 646c 652e 636c 7573  yaml(handle.clus
+00004b80: 7465 725f 7961 6d6c 295b 2761 7574 6827  ter_yaml)['auth'
+00004b90: 5d0a 2020 2020 2020 2020 2020 2020 706f  ].            po
+00004ba0: 7274 733a 204c 6973 7420 6f66 2070 6f72  rts: List of por
+00004bb0: 7420 6e75 6d62 6572 7320 666f 7220 5353  t numbers for SS
+00004bc0: 4820 636f 7272 6573 706f 6e64 696e 6720  H corresponding 
+00004bd0: 746f 2069 7073 0a20 2020 2020 2020 2020  to ips.         
+00004be0: 2020 2064 6f63 6b65 725f 7573 6572 3a20     docker_user: 
+00004bf0: 4966 206e 6f74 204e 6f6e 652c 2075 7365  If not None, use
+00004c00: 2074 6869 7320 7573 6572 2074 6f20 7373   this user to ss
+00004c10: 6820 696e 746f 2074 6865 2064 6f63 6b65  h into the docke
+00004c20: 720a 2020 2020 2020 2020 2020 2020 7373  r.            ss
+00004c30: 685f 7573 6572 3a20 4f76 6572 7269 6465  h_user: Override
+00004c40: 2074 6865 2073 7368 5f75 7365 7220 696e   the ssh_user in
+00004c50: 2061 7574 685f 636f 6e66 6967 0a20 2020   auth_config.   
+00004c60: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00004c70: 2069 6620 7373 685f 7573 6572 2069 7320   if ssh_user is 
+00004c80: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00004c90: 2020 7573 6572 6e61 6d65 203d 2061 7574    username = aut
+00004ca0: 685f 636f 6e66 6967 5b27 7373 685f 7573  h_config['ssh_us
+00004cb0: 6572 275d 0a20 2020 2020 2020 2065 6c73  er'].        els
+00004cc0: 653a 0a20 2020 2020 2020 2020 2020 2075  e:.            u
+00004cd0: 7365 726e 616d 6520 3d20 7373 685f 7573  sername = ssh_us
+00004ce0: 6572 0a20 2020 2020 2020 2069 6620 646f  er.        if do
+00004cf0: 636b 6572 5f75 7365 7220 6973 206e 6f74  cker_user is not
+00004d00: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00004d10: 2020 2075 7365 726e 616d 6520 3d20 646f     username = do
+00004d20: 636b 6572 5f75 7365 720a 2020 2020 2020  cker_user.      
+00004d30: 2020 6b65 795f 7061 7468 203d 206f 732e    key_path = os.
+00004d40: 7061 7468 2e65 7870 616e 6475 7365 7228  path.expanduser(
+00004d50: 6175 7468 5f63 6f6e 6669 675b 2773 7368  auth_config['ssh
+00004d60: 5f70 7269 7661 7465 5f6b 6579 275d 290a  _private_key']).
+00004d70: 2020 2020 2020 2020 736b 795f 6175 746f          sky_auto
+00004d80: 6765 6e5f 636f 6d6d 656e 7420 3d20 2827  gen_comment = ('
+00004d90: 2320 4164 6465 6420 6279 2073 6b79 2028  # Added by sky (
+00004da0: 7573 6520 6073 6b79 2073 746f 702f 646f  use `sky stop/do
+00004db0: 776e 2027 0a20 2020 2020 2020 2020 2020  wn '.           
+00004dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004dd0: 2020 2020 6627 7b63 6c75 7374 6572 5f6e      f'{cluster_n
+00004de0: 616d 657d 6020 746f 2072 656d 6f76 6529  ame}` to remove)
+00004df0: 2729 0a20 2020 2020 2020 2069 7020 3d20  ').        ip = 
+00004e00: 6970 735b 305d 0a20 2020 2020 2020 2069  ips[0].        i
+00004e10: 6620 646f 636b 6572 5f75 7365 7220 6973  f docker_user is
+00004e20: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00004e30: 2020 2020 2020 2069 7020 3d20 276c 6f63         ip = 'loc
+00004e40: 616c 686f 7374 270a 0a20 2020 2020 2020  alhost'..       
+00004e50: 2063 6f6e 6669 675f 7061 7468 203d 206f   config_path = o
+00004e60: 732e 7061 7468 2e65 7870 616e 6475 7365  s.path.expanduse
+00004e70: 7228 636c 732e 7373 685f 636f 6e66 5f70  r(cls.ssh_conf_p
+00004e80: 6174 6829 0a0a 2020 2020 2020 2020 2320  ath)..        # 
+00004e90: 466f 7220 6261 636b 7761 7264 2063 6f6d  For backward com
+00004ea0: 7061 7469 6269 6c69 7479 3a20 6265 666f  patibility: befo
+00004eb0: 7265 2023 3237 3036 2c20 7765 2077 726f  re #2706, we wro
+00004ec0: 7465 2074 6865 2063 6f6e 6669 6720 6f66  te the config of
+00004ed0: 2053 6b79 5069 6c6f 7420 636c 7573 7465   SkyPilot cluste
+00004ee0: 7273 0a20 2020 2020 2020 2023 2064 6972  rs.        # dir
+00004ef0: 6563 746c 7920 696e 207e 2f2e 7373 682f  ectly in ~/.ssh/
+00004f00: 636f 6e66 6967 2e20 466f 7220 7468 6573  config. For thes
+00004f10: 6520 636c 7573 7465 7273 2c20 7765 2072  e clusters, we r
+00004f20: 656d 6f76 6520 7468 6520 636f 6e66 6967  emove the config
+00004f30: 2069 6e20 7e2f 2e73 7368 2f63 6f6e 6669   in ~/.ssh/confi
+00004f40: 670a 2020 2020 2020 2020 2320 616e 6420  g.        # and 
+00004f50: 7772 6974 652f 6f76 6572 7772 6974 6520  write/overwrite 
+00004f60: 7468 6520 636f 6e66 6967 2069 6e20 7e2f  the config in ~/
+00004f70: 2e73 6b79 2f73 7368 2f3c 636c 7573 7465  .sky/ssh/<cluste
+00004f80: 725f 6e61 6d65 3e20 696e 7374 6561 642e  r_name> instead.
+00004f90: 0a20 2020 2020 2020 2063 6c73 2e5f 7265  .        cls._re
+00004fa0: 6d6f 7665 5f73 7461 6c65 5f63 6c75 7374  move_stale_clust
+00004fb0: 6572 5f63 6f6e 6669 675f 666f 725f 6261  er_config_for_ba
+00004fc0: 636b 7761 7264 5f63 6f6d 7061 7469 6269  ckward_compatibi
+00004fd0: 6c69 7479 280a 2020 2020 2020 2020 2020  lity(.          
+00004fe0: 2020 636c 7573 7465 725f 6e61 6d65 2c20    cluster_name, 
+00004ff0: 6970 2c20 6175 7468 5f63 6f6e 6669 672c  ip, auth_config,
+00005000: 2064 6f63 6b65 725f 7573 6572 290a 0a20   docker_user).. 
+00005010: 2020 2020 2020 2069 6620 6e6f 7420 6f73         if not os
+00005020: 2e70 6174 682e 6578 6973 7473 2863 6f6e  .path.exists(con
+00005030: 6669 675f 7061 7468 293a 0a20 2020 2020  fig_path):.     
+00005040: 2020 2020 2020 2063 6f6e 6669 6720 3d20         config = 
+00005050: 5b27 5c6e 275d 0a20 2020 2020 2020 2020  ['\n'].         
+00005060: 2020 2077 6974 6820 6f70 656e 2863 6f6e     with open(con
+00005070: 6669 675f 7061 7468 2c0a 2020 2020 2020  fig_path,.      
+00005080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005090: 2777 272c 0a20 2020 2020 2020 2020 2020  'w',.           
+000050a0: 2020 2020 2020 2020 2020 2065 6e63 6f64             encod
+000050b0: 696e 673d 2775 7466 2d38 272c 0a20 2020  ing='utf-8',.   
+000050c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000050d0: 2020 206f 7065 6e65 723d 6675 6e63 746f     opener=functo
+000050e0: 6f6c 732e 7061 7274 6961 6c28 6f73 2e6f  ols.partial(os.o
+000050f0: 7065 6e2c 206d 6f64 653d 306f 3634 3429  pen, mode=0o644)
+00005100: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
+00005110: 2020 2020 2020 2020 662e 7772 6974 656c          f.writel
+00005120: 696e 6573 2863 6f6e 6669 6729 0a0a 2020  ines(config)..  
+00005130: 2020 2020 2020 7769 7468 206f 7065 6e28        with open(
+00005140: 636f 6e66 6967 5f70 6174 682c 2027 7227  config_path, 'r'
+00005150: 2c20 656e 636f 6469 6e67 3d27 7574 662d  , encoding='utf-
+00005160: 3827 2920 6173 2066 3a0a 2020 2020 2020  8') as f:.      
+00005170: 2020 2020 2020 636f 6e66 6967 203d 2066        config = f
+00005180: 2e72 6561 646c 696e 6573 2829 0a0a 2020  .readlines()..  
+00005190: 2020 2020 2020 7373 685f 6469 7220 3d20        ssh_dir = 
+000051a0: 636c 732e 7373 685f 636c 7573 7465 725f  cls.ssh_cluster_
+000051b0: 7061 7468 2e66 6f72 6d61 7428 2727 290a  path.format('').
+000051c0: 2020 2020 2020 2020 6f73 2e6d 616b 6564          os.maked
+000051d0: 6972 7328 6f73 2e70 6174 682e 6578 7061  irs(os.path.expa
+000051e0: 6e64 7573 6572 2873 7368 5f64 6972 292c  nduser(ssh_dir),
+000051f0: 2065 7869 7374 5f6f 6b3d 5472 7565 2c20   exist_ok=True, 
+00005200: 6d6f 6465 3d30 6f37 3030 290a 0a20 2020  mode=0o700)..   
+00005210: 2020 2020 2023 2048 616e 646c 6520 496e       # Handle In
+00005220: 636c 7564 6520 6f6e 2074 6f70 206f 6620  clude on top of 
+00005230: 436f 6e66 6967 2066 696c 650a 2020 2020  Config file.    
+00005240: 2020 2020 696e 636c 7564 655f 7374 7220      include_str 
+00005250: 3d20 6627 496e 636c 7564 6520 7b63 6c73  = f'Include {cls
+00005260: 2e73 7368 5f63 6c75 7374 6572 5f70 6174  .ssh_cluster_pat
+00005270: 682e 666f 726d 6174 2822 2a22 297d 270a  h.format("*")}'.
+00005280: 2020 2020 2020 2020 666f 756e 6420 3d20          found = 
+00005290: 4661 6c73 650a 2020 2020 2020 2020 666f  False.        fo
+000052a0: 7220 692c 206c 696e 6520 696e 2065 6e75  r i, line in enu
+000052b0: 6d65 7261 7465 2863 6f6e 6669 6729 3a0a  merate(config):.
+000052c0: 2020 2020 2020 2020 2020 2020 636f 6e66              conf
+000052d0: 6967 5f73 7472 203d 206c 696e 652e 7374  ig_str = line.st
+000052e0: 7269 7028 290a 2020 2020 2020 2020 2020  rip().          
+000052f0: 2020 6966 2063 6f6e 6669 675f 7374 7220    if config_str 
+00005300: 3d3d 2069 6e63 6c75 6465 5f73 7472 3a0a  == include_str:.
+00005310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005320: 666f 756e 6420 3d20 5472 7565 0a20 2020  found = True.   
+00005330: 2020 2020 2020 2020 2020 2020 2062 7265               bre
+00005340: 616b 0a20 2020 2020 2020 2020 2020 2069  ak.            i
+00005350: 6620 2748 6f73 7427 2069 6e20 636f 6e66  f 'Host' in conf
+00005360: 6967 5f73 7472 3a0a 2020 2020 2020 2020  ig_str:.        
+00005370: 2020 2020 2020 2020 6272 6561 6b0a 2020          break.  
+00005380: 2020 2020 2020 6966 206e 6f74 2066 6f75        if not fou
+00005390: 6e64 3a0a 2020 2020 2020 2020 2020 2020  nd:.            
+000053a0: 2320 4469 6420 6e6f 7420 6669 6e64 2049  # Did not find I
+000053b0: 6e63 6c75 6465 2073 7472 696e 672e 2049  nclude string. I
+000053c0: 6e73 6572 7420 6049 6e63 6c75 6465 6020  nsert `Include` 
+000053d0: 6c69 6e65 732e 0a20 2020 2020 2020 2020  lines..         
+000053e0: 2020 2077 6974 6820 6f70 656e 2863 6f6e     with open(con
+000053f0: 6669 675f 7061 7468 2c20 2777 272c 2065  fig_path, 'w', e
+00005400: 6e63 6f64 696e 673d 2775 7466 2d38 2729  ncoding='utf-8')
+00005410: 2061 7320 663a 0a20 2020 2020 2020 2020   as f:.         
+00005420: 2020 2020 2020 2063 6f6e 6669 672e 696e         config.in
+00005430: 7365 7274 280a 2020 2020 2020 2020 2020  sert(.          
+00005440: 2020 2020 2020 2020 2020 302c 0a20 2020            0,.   
+00005450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005460: 2066 2723 2041 6464 6564 2062 7920 536b   f'# Added by Sk
+00005470: 7950 696c 6f74 2066 6f72 2073 7368 2063  yPilot for ssh c
+00005480: 6f6e 6669 6720 6f66 2061 6c6c 2063 6c75  onfig of all clu
+00005490: 7374 6572 735c 6e7b 696e 636c 7564 655f  sters\n{include_
+000054a0: 7374 727d 5c6e 270a 2020 2020 2020 2020  str}\n'.        
+000054b0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000054c0: 2020 2020 2020 2020 2020 662e 7772 6974            f.writ
+000054d0: 6528 2727 2e6a 6f69 6e28 636f 6e66 6967  e(''.join(config
+000054e0: 292e 7374 7269 7028 2929 0a20 2020 2020  ).strip()).     
+000054f0: 2020 2020 2020 2020 2020 2066 2e77 7269             f.wri
+00005500: 7465 2827 5c6e 2720 2a20 3229 0a0a 2020  te('\n' * 2)..  
+00005510: 2020 2020 2020 7072 6f78 795f 636f 6d6d        proxy_comm
+00005520: 616e 6420 3d20 6175 7468 5f63 6f6e 6669  and = auth_confi
+00005530: 672e 6765 7428 2773 7368 5f70 726f 7879  g.get('ssh_proxy
+00005540: 5f63 6f6d 6d61 6e64 272c 204e 6f6e 6529  _command', None)
+00005550: 0a0a 2020 2020 2020 2020 646f 636b 6572  ..        docker
+00005560: 5f70 726f 7879 5f63 6f6d 6d61 6e64 5f67  _proxy_command_g
+00005570: 656e 6572 6174 6f72 203d 204e 6f6e 650a  enerator = None.
+00005580: 2020 2020 2020 2020 6966 2064 6f63 6b65          if docke
+00005590: 725f 7573 6572 2069 7320 6e6f 7420 4e6f  r_user is not No
+000055a0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+000055b0: 646f 636b 6572 5f70 726f 7879 5f63 6f6d  docker_proxy_com
+000055c0: 6d61 6e64 5f67 656e 6572 6174 6f72 203d  mand_generator =
+000055d0: 206c 616d 6264 6120 6970 2c20 706f 7274   lambda ip, port
+000055e0: 3a20 2720 272e 6a6f 696e 280a 2020 2020  : ' '.join(.    
+000055f0: 2020 2020 2020 2020 2020 2020 5b27 7373              ['ss
+00005600: 6827 5d20 2b20 636f 6d6d 616e 645f 7275  h'] + command_ru
+00005610: 6e6e 6572 2e73 7368 5f6f 7074 696f 6e73  nner.ssh_options
+00005620: 5f6c 6973 7428 0a20 2020 2020 2020 2020  _list(.         
+00005630: 2020 2020 2020 2020 2020 206b 6579 5f70             key_p
+00005640: 6174 682c 2073 7368 5f63 6f6e 7472 6f6c  ath, ssh_control
+00005650: 5f6e 616d 653d 4e6f 6e65 2c20 706f 7274  _name=None, port
+00005660: 3d70 6f72 7429 202b 0a20 2020 2020 2020  =port) +.       
+00005670: 2020 2020 2020 2020 205b 272d 5727 2c20           ['-W', 
+00005680: 2725 683a 2570 272c 2066 277b 6175 7468  '%h:%p', f'{auth
+00005690: 5f63 6f6e 6669 675b 2273 7368 5f75 7365  _config["ssh_use
+000056a0: 7222 5d7d 407b 6970 7d27 5d29 0a0a 2020  r"]}@{ip}'])..  
+000056b0: 2020 2020 2020 636f 6465 6765 6e20 3d20        codegen = 
+000056c0: 2727 0a20 2020 2020 2020 2023 2041 6464  ''.        # Add
+000056d0: 2074 6865 206e 6f64 6573 2074 6f20 7468   the nodes to th
+000056e0: 6520 636f 6465 6765 6e0a 2020 2020 2020  e codegen.      
+000056f0: 2020 666f 7220 692c 2069 7020 696e 2065    for i, ip in e
+00005700: 6e75 6d65 7261 7465 2869 7073 293a 0a20  numerate(ips):. 
+00005710: 2020 2020 2020 2020 2020 2064 6f63 6b65             docke
+00005720: 725f 7072 6f78 795f 636f 6d6d 616e 6420  r_proxy_command 
+00005730: 3d20 4e6f 6e65 0a20 2020 2020 2020 2020  = None.         
+00005740: 2020 2070 6f72 7420 3d20 706f 7274 735b     port = ports[
+00005750: 695d 0a20 2020 2020 2020 2020 2020 2069  i].            i
+00005760: 6620 646f 636b 6572 5f70 726f 7879 5f63  f docker_proxy_c
+00005770: 6f6d 6d61 6e64 5f67 656e 6572 6174 6f72  ommand_generator
+00005780: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00005790: 2020 2020 2020 2020 2020 2020 2020 646f                do
+000057a0: 636b 6572 5f70 726f 7879 5f63 6f6d 6d61  cker_proxy_comma
+000057b0: 6e64 203d 2064 6f63 6b65 725f 7072 6f78  nd = docker_prox
+000057c0: 795f 636f 6d6d 616e 645f 6765 6e65 7261  y_command_genera
+000057d0: 746f 7228 6970 2c20 706f 7274 290a 2020  tor(ip, port).  
+000057e0: 2020 2020 2020 2020 2020 2020 2020 6970                ip
+000057f0: 203d 2027 6c6f 6361 6c68 6f73 7427 0a20   = 'localhost'. 
+00005800: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00005810: 6f72 7420 3d20 636f 6e73 7461 6e74 732e  ort = constants.
+00005820: 4445 4641 554c 545f 444f 434b 4552 5f50  DEFAULT_DOCKER_P
+00005830: 4f52 540a 2020 2020 2020 2020 2020 2020  ORT.            
+00005840: 6e6f 6465 5f6e 616d 6520 3d20 636c 7573  node_name = clus
+00005850: 7465 725f 6e61 6d65 2069 6620 6920 3d3d  ter_name if i ==
+00005860: 2030 2065 6c73 6520 636c 7573 7465 725f   0 else cluster_
+00005870: 6e61 6d65 202b 2066 272d 776f 726b 6572  name + f'-worker
+00005880: 7b69 7d27 0a20 2020 2020 2020 2020 2020  {i}'.           
+00005890: 2023 2054 4f44 4f28 726f 6d69 6c62 293a   # TODO(romilb):
+000058a0: 2055 7064 6174 6520 706f 7274 206e 756d   Update port num
+000058b0: 6265 7220 7768 656e 206b 3873 2073 7570  ber when k8s sup
+000058c0: 706f 7274 7320 6d75 6c74 696e 6f64 650a  ports multinode.
+000058d0: 2020 2020 2020 2020 2020 2020 636f 6465              code
+000058e0: 6765 6e20 2b3d 2063 6c73 2e5f 6765 745f  gen += cls._get_
+000058f0: 6765 6e65 7261 7465 645f 636f 6e66 6967  generated_config
+00005900: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00005910: 2020 736b 795f 6175 746f 6765 6e5f 636f    sky_autogen_co
+00005920: 6d6d 656e 742c 206e 6f64 655f 6e61 6d65  mment, node_name
+00005930: 2c20 6970 2c20 7573 6572 6e61 6d65 2c20  , ip, username, 
+00005940: 6b65 795f 7061 7468 2c0a 2020 2020 2020  key_path,.      
+00005950: 2020 2020 2020 2020 2020 7072 6f78 795f            proxy_
+00005960: 636f 6d6d 616e 642c 2070 6f72 742c 2064  command, port, d
+00005970: 6f63 6b65 725f 7072 6f78 795f 636f 6d6d  ocker_proxy_comm
+00005980: 616e 6429 202b 2027 5c6e 270a 0a20 2020  and) + '\n'..   
+00005990: 2020 2020 2063 6c75 7374 6572 5f63 6f6e       cluster_con
+000059a0: 6669 675f 7061 7468 203d 206f 732e 7061  fig_path = os.pa
+000059b0: 7468 2e65 7870 616e 6475 7365 7228 0a20  th.expanduser(. 
+000059c0: 2020 2020 2020 2020 2020 2063 6c73 2e73             cls.s
+000059d0: 7368 5f63 6c75 7374 6572 5f70 6174 682e  sh_cluster_path.
+000059e0: 666f 726d 6174 2863 6c75 7374 6572 5f6e  format(cluster_n
+000059f0: 616d 6529 290a 0a20 2020 2020 2020 2077  ame))..        w
+00005a00: 6974 6820 6f70 656e 2863 6c75 7374 6572  ith open(cluster
+00005a10: 5f63 6f6e 6669 675f 7061 7468 2c0a 2020  _config_path,.  
+00005a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005a30: 2777 272c 0a20 2020 2020 2020 2020 2020  'w',.           
+00005a40: 2020 2020 2020 2065 6e63 6f64 696e 673d         encoding=
+00005a50: 2775 7466 2d38 272c 0a20 2020 2020 2020  'utf-8',.       
+00005a60: 2020 2020 2020 2020 2020 206f 7065 6e65             opene
+00005a70: 723d 6675 6e63 746f 6f6c 732e 7061 7274  r=functools.part
+00005a80: 6961 6c28 6f73 2e6f 7065 6e2c 206d 6f64  ial(os.open, mod
+00005a90: 653d 306f 3634 3429 2920 6173 2066 3a0a  e=0o644)) as f:.
+00005aa0: 2020 2020 2020 2020 2020 2020 662e 7772              f.wr
+00005ab0: 6974 6528 636f 6465 6765 6e29 0a0a 2020  ite(codegen)..  
+00005ac0: 2020 4063 6c61 7373 6d65 7468 6f64 0a20    @classmethod. 
+00005ad0: 2020 2064 6566 205f 7265 6d6f 7665 5f73     def _remove_s
+00005ae0: 7461 6c65 5f63 6c75 7374 6572 5f63 6f6e  tale_cluster_con
+00005af0: 6669 675f 666f 725f 6261 636b 7761 7264  fig_for_backward
+00005b00: 5f63 6f6d 7061 7469 6269 6c69 7479 280a  _compatibility(.
+00005b10: 2020 2020 2020 2020 636c 732c 0a20 2020          cls,.   
+00005b20: 2020 2020 2063 6c75 7374 6572 5f6e 616d       cluster_nam
+00005b30: 653a 2073 7472 2c0a 2020 2020 2020 2020  e: str,.        
+00005b40: 6970 3a20 7374 722c 0a20 2020 2020 2020  ip: str,.       
+00005b50: 2061 7574 685f 636f 6e66 6967 3a20 4469   auth_config: Di
+00005b60: 6374 5b73 7472 2c20 7374 725d 2c0a 2020  ct[str, str],.  
+00005b70: 2020 2020 2020 646f 636b 6572 5f75 7365        docker_use
+00005b80: 723a 204f 7074 696f 6e61 6c5b 7374 725d  r: Optional[str]
+00005b90: 203d 204e 6f6e 652c 0a20 2020 2029 3a0a   = None,.    ):.
+00005ba0: 2020 2020 2020 2020 2222 2252 656d 6f76          """Remov
+00005bb0: 6520 6175 7468 656e 7469 6361 7469 6f6e  e authentication
+00005bc0: 2069 6e66 6f72 6d61 7469 6f6e 2066 6f72   information for
+00005bd0: 2063 6c75 7374 6572 2066 726f 6d20 6c6f   cluster from lo
+00005be0: 6361 6c20 5353 4820 636f 6e66 6967 2e0a  cal SSH config..
+00005bf0: 0a20 2020 2020 2020 2049 6620 6e6f 2065  .        If no e
+00005c00: 7869 7374 696e 6720 686f 7374 206d 6174  xisting host mat
+00005c10: 6368 696e 6720 7468 6520 7072 6f76 6964  ching the provid
+00005c20: 6564 2073 7065 6369 6669 6361 7469 6f6e  ed specification
+00005c30: 2069 7320 666f 756e 642c 2074 6865 6e0a   is found, then.
+00005c40: 2020 2020 2020 2020 6e6f 7468 696e 6720          nothing 
+00005c50: 6973 2072 656d 6f76 6564 2e0a 0a20 2020  is removed...   
+00005c60: 2020 2020 2041 7267 733a 0a20 2020 2020       Args:.     
+00005c70: 2020 2020 2020 2069 703a 2048 6561 6420         ip: Head 
+00005c80: 6e6f 6465 2773 2049 5020 6164 6472 6573  node's IP addres
+00005c90: 732e 0a20 2020 2020 2020 2020 2020 2061  s..            a
+00005ca0: 7574 685f 636f 6e66 6967 3a20 7265 6164  uth_config: read
+00005cb0: 5f79 616d 6c28 6861 6e64 6c65 2e63 6c75  _yaml(handle.clu
+00005cc0: 7374 6572 5f79 616d 6c29 5b27 6175 7468  ster_yaml)['auth
+00005cd0: 275d 0a20 2020 2020 2020 2020 2020 2064  '].            d
+00005ce0: 6f63 6b65 725f 7573 6572 3a20 4966 206e  ocker_user: If n
+00005cf0: 6f74 204e 6f6e 652c 2075 7365 2074 6869  ot None, use thi
+00005d00: 7320 7573 6572 2074 6f20 7373 6820 696e  s user to ssh in
+00005d10: 746f 2074 6865 2064 6f63 6b65 720a 2020  to the docker.  
+00005d20: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00005d30: 2020 7573 6572 6e61 6d65 203d 2061 7574    username = aut
+00005d40: 685f 636f 6e66 6967 5b27 7373 685f 7573  h_config['ssh_us
+00005d50: 6572 275d 0a20 2020 2020 2020 2063 6f6e  er'].        con
+00005d60: 6669 675f 7061 7468 203d 206f 732e 7061  fig_path = os.pa
+00005d70: 7468 2e65 7870 616e 6475 7365 7228 636c  th.expanduser(cl
+00005d80: 732e 7373 685f 636f 6e66 5f70 6174 6829  s.ssh_conf_path)
+00005d90: 0a20 2020 2020 2020 2063 6c75 7374 6572  .        cluster
+00005da0: 5f63 6f6e 6669 675f 7061 7468 203d 206f  _config_path = o
+00005db0: 732e 7061 7468 2e65 7870 616e 6475 7365  s.path.expanduse
+00005dc0: 7228 0a20 2020 2020 2020 2020 2020 2063  r(.            c
+00005dd0: 6c73 2e73 7368 5f63 6c75 7374 6572 5f70  ls.ssh_cluster_p
+00005de0: 6174 682e 666f 726d 6174 2863 6c75 7374  ath.format(clust
+00005df0: 6572 5f6e 616d 6529 290a 2020 2020 2020  er_name)).      
+00005e00: 2020 6966 206e 6f74 206f 732e 7061 7468    if not os.path
+00005e10: 2e65 7869 7374 7328 636f 6e66 6967 5f70  .exists(config_p
+00005e20: 6174 6829 3a0a 2020 2020 2020 2020 2020  ath):.          
+00005e30: 2020 7265 7475 726e 0a0a 2020 2020 2020    return..      
+00005e40: 2020 7769 7468 206f 7065 6e28 636f 6e66    with open(conf
+00005e50: 6967 5f70 6174 682c 2027 7227 2c20 656e  ig_path, 'r', en
+00005e60: 636f 6469 6e67 3d27 7574 662d 3827 2920  coding='utf-8') 
+00005e70: 6173 2066 3a0a 2020 2020 2020 2020 2020  as f:.          
+00005e80: 2020 636f 6e66 6967 203d 2066 2e72 6561    config = f.rea
+00005e90: 646c 696e 6573 2829 0a0a 2020 2020 2020  dlines()..      
+00005ea0: 2020 7374 6172 745f 6c69 6e65 5f69 6478    start_line_idx
+00005eb0: 203d 204e 6f6e 650a 0a20 2020 2020 2020   = None..       
+00005ec0: 2023 2053 6361 6e20 7468 6520 636f 6e66   # Scan the conf
+00005ed0: 6967 2066 6f72 2074 6865 2063 6c75 7374  ig for the clust
+00005ee0: 6572 206e 616d 652e 0a20 2020 2020 2020  er name..       
+00005ef0: 2066 6f72 2069 2c20 6c69 6e65 2069 6e20   for i, line in 
+00005f00: 656e 756d 6572 6174 6528 636f 6e66 6967  enumerate(config
+00005f10: 293a 0a20 2020 2020 2020 2020 2020 206e  ):.            n
+00005f20: 6578 745f 6c69 6e65 203d 2063 6f6e 6669  ext_line = confi
+00005f30: 675b 6920 2b20 315d 2069 6620 6920 2b20  g[i + 1] if i + 
+00005f40: 3120 3c20 6c65 6e28 636f 6e66 6967 2920  1 < len(config) 
+00005f50: 656c 7365 2027 270a 2020 2020 2020 2020  else ''.        
+00005f60: 2020 2020 6966 2064 6f63 6b65 725f 7573      if docker_us
+00005f70: 6572 2069 7320 4e6f 6e65 3a0a 2020 2020  er is None:.    
+00005f80: 2020 2020 2020 2020 2020 2020 666f 756e              foun
+00005f90: 6420 3d20 286c 696e 652e 7374 7269 7028  d = (line.strip(
+00005fa0: 2920 3d3d 2066 2748 6f73 744e 616d 6520  ) == f'HostName 
+00005fb0: 7b69 707d 2720 616e 640a 2020 2020 2020  {ip}' and.      
 00005fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005fd0: 2023 2046 696e 6420 7468 6520 6c69 6e65   # Find the line
-00005fe0: 2073 7461 7274 696e 6720 7769 7468 2050   starting with P
-00005ff0: 726f 7879 436f 6d6d 616e 6420 616e 6420  roxyCommand and 
-00006000: 636f 6e74 6169 6e73 2074 6865 2069 700a  contains the ip.
-00006010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006020: 2020 2020 666f 756e 6420 3d20 4661 6c73      found = Fals
-00006030: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00006040: 2020 2020 2020 666f 7220 6964 7820 696e        for idx in
-00006050: 2072 616e 6765 2869 2c20 6c65 6e28 636f   range(i, len(co
-00006060: 6e66 6967 2929 3a0a 2020 2020 2020 2020  nfig)):.        
-00006070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006080: 2320 5374 6f70 2069 6620 7765 2072 6561  # Stop if we rea
-00006090: 6368 2061 6e20 656d 7074 7920 6c69 6e65  ch an empty line
-000060a0: 2c20 7768 6963 6820 6d65 616e 7320 6120  , which means a 
-000060b0: 6e65 7720 686f 7374 0a20 2020 2020 2020  new host.       
-000060c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000060d0: 2069 6620 6e6f 7420 636f 6e66 6967 5b69   if not config[i
-000060e0: 6478 5d2e 7374 7269 7028 293a 0a20 2020  dx].strip():.   
-000060f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006100: 2020 2020 2020 2020 2062 7265 616b 0a20           break. 
-00006110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006120: 2020 2020 2020 2069 6620 636f 6e66 6967         if config
-00006130: 5b69 6478 5d2e 7374 7269 7028 292e 7374  [idx].strip().st
-00006140: 6172 7473 7769 7468 2827 5072 6f78 7943  artswith('ProxyC
-00006150: 6f6d 6d61 6e64 2729 3a0a 2020 2020 2020  ommand'):.      
+00005fd0: 2020 206e 6578 745f 6c69 6e65 2e73 7472     next_line.str
+00005fe0: 6970 2829 203d 3d20 6627 5573 6572 207b  ip() == f'User {
+00005ff0: 7573 6572 6e61 6d65 7d27 290a 2020 2020  username}').    
+00006000: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00006010: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00006020: 756e 6420 3d20 286c 696e 652e 7374 7269  und = (line.stri
+00006030: 7028 2920 3d3d 2027 486f 7374 4e61 6d65  p() == 'HostName
+00006040: 206c 6f63 616c 686f 7374 2720 616e 640a   localhost' and.
+00006050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006060: 2020 2020 2020 2020 206e 6578 745f 6c69           next_li
+00006070: 6e65 2e73 7472 6970 2829 203d 3d20 6627  ne.strip() == f'
+00006080: 5573 6572 207b 646f 636b 6572 5f75 7365  User {docker_use
+00006090: 727d 2729 0a20 2020 2020 2020 2020 2020  r}').           
+000060a0: 2020 2020 2069 6620 666f 756e 643a 0a20       if found:. 
+000060b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000060c0: 2020 2023 2046 696e 6420 7468 6520 6c69     # Find the li
+000060d0: 6e65 2073 7461 7274 696e 6720 7769 7468  ne starting with
+000060e0: 2050 726f 7879 436f 6d6d 616e 6420 616e   ProxyCommand an
+000060f0: 6420 636f 6e74 6169 6e73 2074 6865 2069  d contains the i
+00006100: 700a 2020 2020 2020 2020 2020 2020 2020  p.              
+00006110: 2020 2020 2020 666f 756e 6420 3d20 4661        found = Fa
+00006120: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
+00006130: 2020 2020 2020 2020 666f 7220 6964 7820          for idx 
+00006140: 696e 2072 616e 6765 2869 2c20 6c65 6e28  in range(i, len(
+00006150: 636f 6e66 6967 2929 3a0a 2020 2020 2020  config)):.      
 00006160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006170: 2020 2020 2020 7072 6f78 795f 636f 6d6d        proxy_comm
-00006180: 616e 645f 6c69 6e65 203d 2063 6f6e 6669  and_line = confi
-00006190: 675b 6964 785d 2e73 7472 6970 2829 0a20  g[idx].strip(). 
-000061a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000061b0: 2020 2020 2020 2020 2020 2069 6620 7072             if pr
-000061c0: 6f78 795f 636f 6d6d 616e 645f 6c69 6e65  oxy_command_line
-000061d0: 2e65 6e64 7377 6974 6828 6627 407b 6970  .endswith(f'@{ip
-000061e0: 7d27 293a 0a20 2020 2020 2020 2020 2020  }'):.           
-000061f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006200: 2020 2020 2066 6f75 6e64 203d 2054 7275       found = Tru
-00006210: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00006220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006230: 2020 6272 6561 6b0a 2020 2020 2020 2020    break.        
-00006240: 2020 2020 6966 2066 6f75 6e64 3a0a 2020      if found:.  
-00006250: 2020 2020 2020 2020 2020 2020 2020 7374                st
-00006260: 6172 745f 6c69 6e65 5f69 6478 203d 2069  art_line_idx = i
-00006270: 202d 2031 0a20 2020 2020 2020 2020 2020   - 1.           
-00006280: 2020 2020 2062 7265 616b 0a0a 2020 2020       break..    
-00006290: 2020 2020 6966 2073 7461 7274 5f6c 696e      if start_lin
-000062a0: 655f 6964 7820 6973 206e 6f74 204e 6f6e  e_idx is not Non
-000062b0: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
-000062c0: 2053 6361 6e20 666f 7220 656e 6420 6f66   Scan for end of
-000062d0: 2070 7265 7669 6f75 7320 636f 6e66 6967   previous config
-000062e0: 2e0a 2020 2020 2020 2020 2020 2020 6375  ..            cu
-000062f0: 7273 6f72 203d 2073 7461 7274 5f6c 696e  rsor = start_lin
-00006300: 655f 6964 780a 2020 2020 2020 2020 2020  e_idx.          
-00006310: 2020 7768 696c 6520 6375 7273 6f72 203e    while cursor >
-00006320: 2030 2061 6e64 206c 656e 2863 6f6e 6669   0 and len(confi
-00006330: 675b 6375 7273 6f72 5d2e 7374 7269 7028  g[cursor].strip(
-00006340: 2929 203e 2030 3a0a 2020 2020 2020 2020  )) > 0:.        
-00006350: 2020 2020 2020 2020 6375 7273 6f72 202d          cursor -
-00006360: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
-00006370: 7072 6576 5f65 6e64 5f6c 696e 655f 6964  prev_end_line_id
-00006380: 7820 3d20 6375 7273 6f72 0a0a 2020 2020  x = cursor..    
-00006390: 2020 2020 2020 2020 2320 5363 616e 2066          # Scan f
-000063a0: 6f72 2065 6e64 206f 6620 7468 6520 636c  or end of the cl
-000063b0: 7573 7465 7220 636f 6e66 6967 2e0a 2020  uster config..  
-000063c0: 2020 2020 2020 2020 2020 656e 645f 6c69            end_li
-000063d0: 6e65 5f69 6478 203d 204e 6f6e 650a 2020  ne_idx = None.  
-000063e0: 2020 2020 2020 2020 2020 6375 7273 6f72            cursor
-000063f0: 203d 2073 7461 7274 5f6c 696e 655f 6964   = start_line_id
-00006400: 7820 2b20 310a 2020 2020 2020 2020 2020  x + 1.          
-00006410: 2020 7374 6172 745f 6c69 6e65 5f69 6478    start_line_idx
-00006420: 202d 3d20 3120 2023 2072 656d 6f76 6520   -= 1  # remove 
-00006430: 6175 746f 2d67 656e 6572 6174 6564 2063  auto-generated c
-00006440: 6f6d 6d65 6e74 0a20 2020 2020 2020 2020  omment.         
-00006450: 2020 2077 6869 6c65 2063 7572 736f 7220     while cursor 
-00006460: 3c20 6c65 6e28 636f 6e66 6967 293a 0a20  < len(config):. 
-00006470: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00006480: 6620 636f 6e66 6967 5b63 7572 736f 725d  f config[cursor]
-00006490: 2e73 7472 6970 2829 2e73 7461 7274 7377  .strip().startsw
-000064a0: 6974 6828 0a20 2020 2020 2020 2020 2020  ith(.           
-000064b0: 2020 2020 2020 2020 2020 2020 2027 2320               '# 
-000064c0: 2729 206f 7220 636f 6e66 6967 5b63 7572  ') or config[cur
-000064d0: 736f 725d 2e73 7472 6970 2829 2e73 7461  sor].strip().sta
-000064e0: 7274 7377 6974 6828 2748 6f73 7420 2729  rtswith('Host ')
-000064f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00006500: 2020 2020 2020 656e 645f 6c69 6e65 5f69        end_line_i
-00006510: 6478 203d 2063 7572 736f 720a 2020 2020  dx = cursor.    
-00006520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006530: 6272 6561 6b0a 2020 2020 2020 2020 2020  break.          
-00006540: 2020 2020 2020 6375 7273 6f72 202b 3d20        cursor += 
-00006550: 310a 0a20 2020 2020 2020 2020 2020 2023  1..            #
-00006560: 2052 656d 6f76 6520 736b 792d 6765 6e65   Remove sky-gene
-00006570: 7261 7465 6420 636f 6e66 6967 2061 6e64  rated config and
-00006580: 2075 7064 6174 6520 7468 6520 6669 6c65   update the file
-00006590: 2e0a 2020 2020 2020 2020 2020 2020 636f  ..            co
-000065a0: 6e66 6967 5b70 7265 765f 656e 645f 6c69  nfig[prev_end_li
-000065b0: 6e65 5f69 6478 3a65 6e64 5f6c 696e 655f  ne_idx:end_line_
-000065c0: 6964 785d 203d 205b 0a20 2020 2020 2020  idx] = [.       
-000065d0: 2020 2020 2020 2020 2027 5c6e 270a 2020           '\n'.  
-000065e0: 2020 2020 2020 2020 2020 5d20 6966 2065            ] if e
-000065f0: 6e64 5f6c 696e 655f 6964 7820 6973 206e  nd_line_idx is n
-00006600: 6f74 204e 6f6e 6520 656c 7365 205b 5d0a  ot None else [].
-00006610: 2020 2020 2020 2020 2020 2020 7769 7468              with
-00006620: 206f 7065 6e28 636f 6e66 6967 5f70 6174   open(config_pat
-00006630: 682c 2027 7727 2c20 656e 636f 6469 6e67  h, 'w', encoding
-00006640: 3d27 7574 662d 3827 2920 6173 2066 3a0a  ='utf-8') as f:.
-00006650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006660: 662e 7772 6974 6528 2727 2e6a 6f69 6e28  f.write(''.join(
-00006670: 636f 6e66 6967 292e 7374 7269 7028 2929  config).strip())
-00006680: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006690: 2066 2e77 7269 7465 2827 5c6e 2720 2a20   f.write('\n' * 
-000066a0: 3229 0a0a 2020 2020 2020 2020 2320 4465  2)..        # De
-000066b0: 6c65 7465 2069 6e63 6c75 6465 2073 7461  lete include sta
-000066c0: 7465 6d65 6e74 2069 6620 6974 2065 7869  tement if it exi
-000066d0: 7374 7320 696e 2074 6865 2063 6f6e 6669  sts in the confi
-000066e0: 672e 0a20 2020 2020 2020 2073 6b79 5f61  g..        sky_a
-000066f0: 7574 6f67 656e 5f63 6f6d 6d65 6e74 203d  utogen_comment =
-00006700: 2028 2723 2041 6464 6564 2062 7920 736b   ('# Added by sk
-00006710: 7920 2875 7365 2060 736b 7920 7374 6f70  y (use `sky stop
-00006720: 2f64 6f77 6e20 270a 2020 2020 2020 2020  /down '.        
-00006730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006740: 2020 2020 2020 2066 277b 636c 7573 7465         f'{cluste
-00006750: 725f 6e61 6d65 7d60 2074 6f20 7265 6d6f  r_name}` to remo
-00006760: 7665 2927 290a 2020 2020 2020 2020 7769  ve)').        wi
-00006770: 7468 206f 7065 6e28 636f 6e66 6967 5f70  th open(config_p
-00006780: 6174 682c 2027 7227 2c20 656e 636f 6469  ath, 'r', encodi
-00006790: 6e67 3d27 7574 662d 3827 2920 6173 2066  ng='utf-8') as f
-000067a0: 3a0a 2020 2020 2020 2020 2020 2020 636f  :.            co
-000067b0: 6e66 6967 203d 2066 2e72 6561 646c 696e  nfig = f.readlin
-000067c0: 6573 2829 0a0a 2020 2020 2020 2020 666f  es()..        fo
-000067d0: 7220 692c 206c 696e 6520 696e 2065 6e75  r i, line in enu
-000067e0: 6d65 7261 7465 2863 6f6e 6669 6729 3a0a  merate(config):.
-000067f0: 2020 2020 2020 2020 2020 2020 636f 6e66              conf
-00006800: 6967 5f73 7472 203d 206c 696e 652e 7374  ig_str = line.st
-00006810: 7269 7028 290a 2020 2020 2020 2020 2020  rip().          
-00006820: 2020 6966 2066 2749 6e63 6c75 6465 207b    if f'Include {
-00006830: 636c 7573 7465 725f 636f 6e66 6967 5f70  cluster_config_p
-00006840: 6174 687d 2720 696e 2063 6f6e 6669 675f  ath}' in config_
-00006850: 7374 723a 0a20 2020 2020 2020 2020 2020  str:.           
-00006860: 2020 2020 2077 6974 6820 6f70 656e 2863       with open(c
-00006870: 6f6e 6669 675f 7061 7468 2c20 2777 272c  onfig_path, 'w',
-00006880: 2065 6e63 6f64 696e 673d 2775 7466 2d38   encoding='utf-8
-00006890: 2729 2061 7320 663a 0a20 2020 2020 2020  ') as f:.       
-000068a0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000068b0: 6920 3c20 6c65 6e28 636f 6e66 6967 2920  i < len(config) 
-000068c0: 2d20 3120 616e 6420 636f 6e66 6967 5b69  - 1 and config[i
-000068d0: 202b 2031 5d20 3d3d 2027 5c6e 273a 0a20   + 1] == '\n':. 
-000068e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000068f0: 2020 2020 2020 2064 656c 2063 6f6e 6669         del confi
-00006900: 675b 6920 2b20 315d 0a20 2020 2020 2020  g[i + 1].       
-00006910: 2020 2020 2020 2020 2020 2020 2023 2044               # D
-00006920: 656c 6574 6520 496e 636c 7564 6520 7374  elete Include st
-00006930: 7269 6e67 0a20 2020 2020 2020 2020 2020  ring.           
-00006940: 2020 2020 2020 2020 2064 656c 2063 6f6e           del con
-00006950: 6669 675b 695d 0a20 2020 2020 2020 2020  fig[i].         
-00006960: 2020 2020 2020 2020 2020 2023 2044 656c             # Del
-00006970: 6574 6520 536b 7920 4175 746f 6765 6e20  ete Sky Autogen 
-00006980: 436f 6d6d 656e 740a 2020 2020 2020 2020  Comment.        
-00006990: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-000069a0: 203e 2030 2061 6e64 2073 6b79 5f61 7574   > 0 and sky_aut
-000069b0: 6f67 656e 5f63 6f6d 6d65 6e74 2069 6e20  ogen_comment in 
-000069c0: 636f 6e66 6967 5b69 202d 2031 5d2e 7374  config[i - 1].st
-000069d0: 7269 7028 293a 0a20 2020 2020 2020 2020  rip():.         
-000069e0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-000069f0: 656c 2063 6f6e 6669 675b 6920 2d20 315d  el config[i - 1]
-00006a00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006a10: 2020 2020 2066 2e77 7269 7465 2827 272e       f.write(''.
-00006a20: 6a6f 696e 2863 6f6e 6669 6729 290a 2020  join(config)).  
-00006a30: 2020 2020 2020 2020 2020 2020 2020 6272                br
-00006a40: 6561 6b0a 2020 2020 2020 2020 2020 2020  eak.            
-00006a50: 6966 2027 486f 7374 2720 696e 2063 6f6e  if 'Host' in con
-00006a60: 6669 675f 7374 723a 0a20 2020 2020 2020  fig_str:.       
-00006a70: 2020 2020 2020 2020 2062 7265 616b 0a0a           break..
-00006a80: 2020 2020 4063 6c61 7373 6d65 7468 6f64      @classmethod
-00006a90: 0a20 2020 2023 2054 4f44 4f3a 2057 6520  .    # TODO: We 
-00006aa0: 6361 6e20 7265 6d6f 7665 2074 6869 7320  can remove this 
-00006ab0: 6166 7465 7220 302e 362e 3020 616e 6420  after 0.6.0 and 
-00006ac0: 6861 7665 2061 206c 6f63 6b20 6f6e 6c79  have a lock only
-00006ad0: 2070 6572 2063 6c75 7374 6572 2e0a 2020   per cluster..  
-00006ae0: 2020 4074 696d 656c 696e 652e 4669 6c65    @timeline.File
-00006af0: 4c6f 636b 4576 656e 7428 7373 685f 636f  LockEvent(ssh_co
-00006b00: 6e66 5f6c 6f63 6b5f 7061 7468 290a 2020  nf_lock_path).  
-00006b10: 2020 6465 6620 7265 6d6f 7665 5f63 6c75    def remove_clu
-00006b20: 7374 6572 280a 2020 2020 2020 2020 636c  ster(.        cl
-00006b30: 732c 0a20 2020 2020 2020 2063 6c75 7374  s,.        clust
-00006b40: 6572 5f6e 616d 653a 2073 7472 2c0a 2020  er_name: str,.  
-00006b50: 2020 2020 2020 6970 3a20 7374 722c 0a20        ip: str,. 
-00006b60: 2020 2020 2020 2061 7574 685f 636f 6e66         auth_conf
-00006b70: 6967 3a20 4469 6374 5b73 7472 2c20 7374  ig: Dict[str, st
-00006b80: 725d 2c0a 2020 2020 2020 2020 646f 636b  r],.        dock
-00006b90: 6572 5f75 7365 723a 204f 7074 696f 6e61  er_user: Optiona
-00006ba0: 6c5b 7374 725d 203d 204e 6f6e 652c 0a20  l[str] = None,. 
-00006bb0: 2020 2029 3a0a 2020 2020 2020 2020 2222     ):.        ""
-00006bc0: 2252 656d 6f76 6520 6175 7468 656e 7469  "Remove authenti
-00006bd0: 6361 7469 6f6e 2069 6e66 6f72 6d61 7469  cation informati
-00006be0: 6f6e 2066 6f72 2063 6c75 7374 6572 2066  on for cluster f
-00006bf0: 726f 6d20 7e2f 2e73 6b79 2f73 7368 2f3c  rom ~/.sky/ssh/<
-00006c00: 636c 7573 7465 725f 6e61 6d65 3e2e 0a0a  cluster_name>...
-00006c10: 2020 2020 2020 2020 466f 7220 6261 636b          For back
-00006c20: 7761 7264 2063 6f6d 7061 7469 6269 6c69  ward compatibili
-00006c30: 7479 2061 6c73 6f20 7265 6d6f 7665 2074  ty also remove t
-00006c40: 6865 2063 6f6e 6669 6720 6672 6f6d 207e  he config from ~
-00006c50: 2f2e 7373 682f 636f 6e66 6967 2069 6620  /.ssh/config if 
-00006c60: 6974 2065 7869 7374 732e 0a0a 2020 2020  it exists...    
-00006c70: 2020 2020 4966 206e 6f20 6578 6973 7469      If no existi
-00006c80: 6e67 2068 6f73 7420 6d61 7463 6869 6e67  ng host matching
-00006c90: 2074 6865 2070 726f 7669 6465 6420 7370   the provided sp
-00006ca0: 6563 6966 6963 6174 696f 6e20 6973 2066  ecification is f
-00006cb0: 6f75 6e64 2c20 7468 656e 0a20 2020 2020  ound, then.     
-00006cc0: 2020 206e 6f74 6869 6e67 2069 7320 7265     nothing is re
-00006cd0: 6d6f 7665 642e 0a0a 2020 2020 2020 2020  moved...        
-00006ce0: 4172 6773 3a0a 2020 2020 2020 2020 2020  Args:.          
-00006cf0: 2020 6970 3a20 4865 6164 206e 6f64 6527    ip: Head node'
-00006d00: 7320 4950 2061 6464 7265 7373 2e0a 2020  s IP address..  
-00006d10: 2020 2020 2020 2020 2020 6175 7468 5f63            auth_c
-00006d20: 6f6e 6669 673a 2072 6561 645f 7961 6d6c  onfig: read_yaml
-00006d30: 2868 616e 646c 652e 636c 7573 7465 725f  (handle.cluster_
-00006d40: 7961 6d6c 295b 2761 7574 6827 5d0a 2020  yaml)['auth'].  
-00006d50: 2020 2020 2020 2020 2020 646f 636b 6572            docker
-00006d60: 5f75 7365 723a 2049 6620 6e6f 7420 4e6f  _user: If not No
-00006d70: 6e65 2c20 7573 6520 7468 6973 2075 7365  ne, use this use
-00006d80: 7220 746f 2073 7368 2069 6e74 6f20 7468  r to ssh into th
-00006d90: 6520 646f 636b 6572 0a20 2020 2020 2020  e docker.       
-00006da0: 2022 2222 0a20 2020 2020 2020 2063 6c75   """.        clu
-00006db0: 7374 6572 5f63 6f6e 6669 675f 7061 7468  ster_config_path
-00006dc0: 203d 206f 732e 7061 7468 2e65 7870 616e   = os.path.expan
-00006dd0: 6475 7365 7228 0a20 2020 2020 2020 2020  duser(.         
-00006de0: 2020 2063 6c73 2e73 7368 5f63 6c75 7374     cls.ssh_clust
-00006df0: 6572 5f70 6174 682e 666f 726d 6174 2863  er_path.format(c
-00006e00: 6c75 7374 6572 5f6e 616d 6529 290a 2020  luster_name)).  
-00006e10: 2020 2020 2020 636f 6d6d 6f6e 5f75 7469        common_uti
-00006e20: 6c73 2e72 656d 6f76 655f 6669 6c65 5f69  ls.remove_file_i
-00006e30: 665f 6578 6973 7473 2863 6c75 7374 6572  f_exists(cluster
-00006e40: 5f63 6f6e 6669 675f 7061 7468 290a 0a20  _config_path).. 
-00006e50: 2020 2020 2020 2023 2045 6e73 7572 6573         # Ensures
-00006e60: 2062 6163 6b77 6172 6420 636f 6d70 6174   backward compat
-00006e70: 6962 696c 6974 793a 2062 6566 6f72 6520  ibility: before 
-00006e80: 2332 3730 362c 2077 6520 7772 6f74 6520  #2706, we wrote 
-00006e90: 7468 6520 636f 6e66 6967 206f 6620 536b  the config of Sk
-00006ea0: 7950 696c 6f74 2063 6c75 7374 6572 730a  yPilot clusters.
-00006eb0: 2020 2020 2020 2020 2320 6469 7265 6374          # direct
-00006ec0: 6c79 2069 6e20 7e2f 2e73 7368 2f63 6f6e  ly in ~/.ssh/con
-00006ed0: 6669 672e 2046 6f72 2074 6865 7365 2063  fig. For these c
-00006ee0: 6c75 7374 6572 732c 2077 6520 7368 6f75  lusters, we shou
-00006ef0: 6c64 2063 6c65 616e 2075 7020 7468 6520  ld clean up the 
-00006f00: 636f 6e66 6967 2e0a 2020 2020 2020 2020  config..        
-00006f10: 2320 544f 444f 3a20 5265 6d6f 7665 2074  # TODO: Remove t
-00006f20: 6869 7320 6166 7465 7220 302e 362e 300a  his after 0.6.0.
-00006f30: 2020 2020 2020 2020 636c 732e 5f72 656d          cls._rem
-00006f40: 6f76 655f 7374 616c 655f 636c 7573 7465  ove_stale_cluste
-00006f50: 725f 636f 6e66 6967 5f66 6f72 5f62 6163  r_config_for_bac
-00006f60: 6b77 6172 645f 636f 6d70 6174 6962 696c  kward_compatibil
-00006f70: 6974 7928 0a20 2020 2020 2020 2020 2020  ity(.           
-00006f80: 2063 6c75 7374 6572 5f6e 616d 652c 2069   cluster_name, i
-00006f90: 702c 2061 7574 685f 636f 6e66 6967 2c20  p, auth_config, 
-00006fa0: 646f 636b 6572 5f75 7365 7229 0a0a 0a64  docker_user)...d
-00006fb0: 6566 205f 7265 706c 6163 655f 7961 6d6c  ef _replace_yaml
-00006fc0: 5f64 6963 7473 280a 2020 2020 2020 2020  _dicts(.        
-00006fd0: 6e65 775f 7961 6d6c 3a20 7374 722c 206f  new_yaml: str, o
-00006fe0: 6c64 5f79 616d 6c3a 2073 7472 2c20 7265  ld_yaml: str, re
-00006ff0: 7374 6f72 655f 6b65 795f 6e61 6d65 733a  store_key_names:
-00007000: 2053 6574 5b73 7472 5d2c 0a20 2020 2020   Set[str],.     
-00007010: 2020 2072 6573 746f 7265 5f6b 6579 5f6e     restore_key_n
-00007020: 616d 6573 5f65 7863 6570 7469 6f6e 733a  ames_exceptions:
-00007030: 2053 6571 7565 6e63 655b 5475 706c 655b   Sequence[Tuple[
-00007040: 7374 722c 202e 2e2e 5d5d 2920 2d3e 2073  str, ...]]) -> s
-00007050: 7472 3a0a 2020 2020 2222 2252 6570 6c61  tr:.    """Repla
-00007060: 6365 7320 276e 6577 2720 7769 7468 2027  ces 'new' with '
-00007070: 6f6c 6427 2066 6f72 2061 6c6c 206b 6579  old' for all key
-00007080: 7320 696e 2072 6573 746f 7265 5f6b 6579  s in restore_key
-00007090: 5f6e 616d 6573 2e0a 0a20 2020 2054 6865  _names...    The
-000070a0: 2072 6570 6c61 6365 6d65 6e74 2077 696c   replacement wil
-000070b0: 6c20 6265 2061 7070 6c69 6564 2072 6563  l be applied rec
-000070c0: 7572 7369 7665 6c79 2061 6e64 206f 6e6c  ursively and onl
-000070d0: 7920 666f 7220 7468 6520 626c 6f63 6b73  y for the blocks
-000070e0: 0a20 2020 2077 6974 6820 7468 6520 6b65  .    with the ke
-000070f0: 7920 696e 206b 6579 5f6e 616d 6573 2c20  y in key_names, 
-00007100: 616e 6420 6861 7665 2074 6865 2073 616d  and have the sam
-00007110: 6520 616e 6365 7374 6f72 7320 696e 2062  e ancestors in b
-00007120: 6f74 6820 276e 6577 270a 2020 2020 616e  oth 'new'.    an
-00007130: 6420 276f 6c64 2720 5941 4d4c 2074 7265  d 'old' YAML tre
-00007140: 652e 0a0a 2020 2020 5468 6520 7265 7374  e...    The rest
-00007150: 6f72 655f 6b65 795f 6e61 6d65 735f 6578  ore_key_names_ex
-00007160: 6365 7074 696f 6e73 2069 7320 6120 6c69  ceptions is a li
-00007170: 7374 206f 6620 6b65 7920 6e61 6d65 7320  st of key names 
-00007180: 7468 6174 2073 686f 756c 6420 6e6f 740a  that should not.
-00007190: 2020 2020 6265 2072 6573 746f 7265 642c      be restored,
-000071a0: 2069 2e65 2e20 7468 6f73 6520 6b65 7973   i.e. those keys
-000071b0: 2077 696c 6c20 6265 2072 6573 6574 2074   will be reset t
-000071c0: 6f20 7468 6520 7661 6c75 6520 696e 2027  o the value in '
-000071d0: 6e65 7727 2059 414d 4c0a 2020 2020 7472  new' YAML.    tr
-000071e0: 6565 2061 6674 6572 2074 6865 2072 6570  ee after the rep
-000071f0: 6c61 6365 6d65 6e74 2e0a 2020 2020 2222  lacement..    ""
-00007200: 220a 0a20 2020 2064 6566 205f 7265 7374  "..    def _rest
-00007210: 6f72 655f 626c 6f63 6b28 6e65 775f 626c  ore_block(new_bl
-00007220: 6f63 6b3a 2044 6963 745b 7374 722c 2041  ock: Dict[str, A
-00007230: 6e79 5d2c 206f 6c64 5f62 6c6f 636b 3a20  ny], old_block: 
-00007240: 4469 6374 5b73 7472 2c20 416e 795d 293a  Dict[str, Any]):
-00007250: 0a20 2020 2020 2020 2066 6f72 206b 6579  .        for key
-00007260: 2c20 7661 6c75 6520 696e 206e 6577 5f62  , value in new_b
-00007270: 6c6f 636b 2e69 7465 6d73 2829 3a0a 2020  lock.items():.  
-00007280: 2020 2020 2020 2020 2020 6966 206b 6579            if key
-00007290: 2069 6e20 7265 7374 6f72 655f 6b65 795f   in restore_key_
-000072a0: 6e61 6d65 733a 0a20 2020 2020 2020 2020  names:.         
-000072b0: 2020 2020 2020 2069 6620 6b65 7920 696e         if key in
-000072c0: 206f 6c64 5f62 6c6f 636b 3a0a 2020 2020   old_block:.    
-000072d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000072e0: 6e65 775f 626c 6f63 6b5b 6b65 795d 203d  new_block[key] =
-000072f0: 206f 6c64 5f62 6c6f 636b 5b6b 6579 5d0a   old_block[key].
-00007300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007310: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00007320: 2020 2020 2020 2020 2020 6465 6c20 6e65            del ne
-00007330: 775f 626c 6f63 6b5b 6b65 795d 0a20 2020  w_block[key].   
-00007340: 2020 2020 2020 2020 2065 6c69 6620 6973           elif is
-00007350: 696e 7374 616e 6365 2876 616c 7565 2c20  instance(value, 
-00007360: 6469 6374 293a 0a20 2020 2020 2020 2020  dict):.         
-00007370: 2020 2020 2020 2069 6620 6b65 7920 696e         if key in
-00007380: 206f 6c64 5f62 6c6f 636b 3a0a 2020 2020   old_block:.    
-00007390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000073a0: 5f72 6573 746f 7265 5f62 6c6f 636b 2876  _restore_block(v
-000073b0: 616c 7565 2c20 6f6c 645f 626c 6f63 6b5b  alue, old_block[
-000073c0: 6b65 795d 290a 0a20 2020 206e 6577 5f63  key])..    new_c
-000073d0: 6f6e 6669 6720 3d20 7961 6d6c 2e73 6166  onfig = yaml.saf
-000073e0: 655f 6c6f 6164 286e 6577 5f79 616d 6c29  e_load(new_yaml)
-000073f0: 0a20 2020 206f 6c64 5f63 6f6e 6669 6720  .    old_config 
-00007400: 3d20 7961 6d6c 2e73 6166 655f 6c6f 6164  = yaml.safe_load
-00007410: 286f 6c64 5f79 616d 6c29 0a20 2020 2065  (old_yaml).    e
-00007420: 7863 6c75 6465 645f 7265 7375 6c74 7320  xcluded_results 
-00007430: 3d20 7b7d 0a20 2020 2023 2046 696e 6420  = {}.    # Find 
-00007440: 616c 6c20 6b65 7920 7661 6c75 6573 2065  all key values e
-00007450: 7863 6c75 6465 6420 6672 6f6d 2072 6573  xcluded from res
-00007460: 746f 7265 0a20 2020 2066 6f72 2065 7863  tore.    for exc
-00007470: 6c75 6465 5f72 6573 746f 7265 5f6b 6579  lude_restore_key
-00007480: 5f6e 616d 655f 6c69 7374 2069 6e20 7265  _name_list in re
-00007490: 7374 6f72 655f 6b65 795f 6e61 6d65 735f  store_key_names_
-000074a0: 6578 6365 7074 696f 6e73 3a0a 2020 2020  exceptions:.    
-000074b0: 2020 2020 6578 636c 7564 6564 5f72 6573      excluded_res
-000074c0: 756c 7420 3d20 6e65 775f 636f 6e66 6967  ult = new_config
-000074d0: 0a20 2020 2020 2020 2066 6f75 6e64 5f65  .        found_e
-000074e0: 7863 6c75 6465 645f 6b65 7920 3d20 5472  xcluded_key = Tr
-000074f0: 7565 0a20 2020 2020 2020 2066 6f72 206b  ue.        for k
-00007500: 6579 2069 6e20 6578 636c 7564 655f 7265  ey in exclude_re
-00007510: 7374 6f72 655f 6b65 795f 6e61 6d65 5f6c  store_key_name_l
-00007520: 6973 743a 0a20 2020 2020 2020 2020 2020  ist:.           
-00007530: 2069 6620 286e 6f74 2069 7369 6e73 7461   if (not isinsta
-00007540: 6e63 6528 6578 636c 7564 6564 5f72 6573  nce(excluded_res
-00007550: 756c 742c 2064 6963 7429 206f 720a 2020  ult, dict) or.  
-00007560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007570: 2020 6b65 7920 6e6f 7420 696e 2065 7863    key not in exc
-00007580: 6c75 6465 645f 7265 7375 6c74 293a 0a20  luded_result):. 
-00007590: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000075a0: 6f75 6e64 5f65 7863 6c75 6465 645f 6b65  ound_excluded_ke
-000075b0: 7920 3d20 4661 6c73 650a 2020 2020 2020  y = False.      
-000075c0: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
-000075d0: 2020 2020 2020 2020 2020 2020 6578 636c              excl
-000075e0: 7564 6564 5f72 6573 756c 7420 3d20 6578  uded_result = ex
-000075f0: 636c 7564 6564 5f72 6573 756c 745b 6b65  cluded_result[ke
-00007600: 795d 0a20 2020 2020 2020 2069 6620 666f  y].        if fo
-00007610: 756e 645f 6578 636c 7564 6564 5f6b 6579  und_excluded_key
-00007620: 3a0a 2020 2020 2020 2020 2020 2020 6578  :.            ex
-00007630: 636c 7564 6564 5f72 6573 756c 7473 5b65  cluded_results[e
-00007640: 7863 6c75 6465 5f72 6573 746f 7265 5f6b  xclude_restore_k
-00007650: 6579 5f6e 616d 655f 6c69 7374 5d20 3d20  ey_name_list] = 
-00007660: 6578 636c 7564 6564 5f72 6573 756c 740a  excluded_result.
-00007670: 0a20 2020 2023 2052 6573 746f 7265 2066  .    # Restore f
-00007680: 726f 6d20 6f6c 6420 636f 6e66 6967 0a20  rom old config. 
-00007690: 2020 205f 7265 7374 6f72 655f 626c 6f63     _restore_bloc
-000076a0: 6b28 6e65 775f 636f 6e66 6967 2c20 6f6c  k(new_config, ol
-000076b0: 645f 636f 6e66 6967 290a 0a20 2020 2023  d_config)..    #
-000076c0: 2052 6576 6572 7420 7468 6520 6368 616e   Revert the chan
-000076d0: 6765 7320 666f 7220 7468 6520 6578 636c  ges for the excl
-000076e0: 7564 6564 206b 6579 2076 616c 7565 730a  uded key values.
-000076f0: 2020 2020 666f 7220 6578 636c 7564 655f      for exclude_
-00007700: 7265 7374 6f72 655f 6b65 795f 6e61 6d65  restore_key_name
-00007710: 2c20 7661 6c75 6520 696e 2065 7863 6c75  , value in exclu
-00007720: 6465 645f 7265 7375 6c74 732e 6974 656d  ded_results.item
-00007730: 7328 293a 0a20 2020 2020 2020 2063 7572  s():.        cur
-00007740: 7220 3d20 6e65 775f 636f 6e66 6967 0a20  r = new_config. 
-00007750: 2020 2020 2020 2066 6f72 206b 6579 2069         for key i
-00007760: 6e20 6578 636c 7564 655f 7265 7374 6f72  n exclude_restor
-00007770: 655f 6b65 795f 6e61 6d65 5b3a 2d31 5d3a  e_key_name[:-1]:
-00007780: 0a20 2020 2020 2020 2020 2020 2063 7572  .            cur
-00007790: 7220 3d20 6375 7272 5b6b 6579 5d0a 2020  r = curr[key].  
-000077a0: 2020 2020 2020 6375 7272 5b65 7863 6c75        curr[exclu
-000077b0: 6465 5f72 6573 746f 7265 5f6b 6579 5f6e  de_restore_key_n
-000077c0: 616d 655b 2d31 5d5d 203d 2076 616c 7565  ame[-1]] = value
-000077d0: 0a20 2020 2072 6574 7572 6e20 636f 6d6d  .    return comm
-000077e0: 6f6e 5f75 7469 6c73 2e64 756d 705f 7961  on_utils.dump_ya
-000077f0: 6d6c 5f73 7472 286e 6577 5f63 6f6e 6669  ml_str(new_confi
-00007800: 6729 0a0a 0a23 2054 4f44 4f3a 2074 6f6f  g)...# TODO: too
-00007810: 206d 616e 7920 7468 696e 6773 2068 6170   many things hap
-00007820: 7065 6e69 6e67 2068 6572 6520 2d20 6c65  pening here - le
-00007830: 616b 7920 6162 7374 7261 6374 696f 6e2e  aky abstraction.
-00007840: 2052 6566 6163 746f 722e 0a40 7469 6d65   Refactor..@time
-00007850: 6c69 6e65 2e65 7665 6e74 0a64 6566 2077  line.event.def w
-00007860: 7269 7465 5f63 6c75 7374 6572 5f63 6f6e  rite_cluster_con
-00007870: 6669 6728 0a20 2020 2020 2020 2074 6f5f  fig(.        to_
-00007880: 7072 6f76 6973 696f 6e3a 2027 7265 736f  provision: 'reso
-00007890: 7572 6365 732e 5265 736f 7572 6365 7327  urces.Resources'
-000078a0: 2c0a 2020 2020 2020 2020 6e75 6d5f 6e6f  ,.        num_no
-000078b0: 6465 733a 2069 6e74 2c0a 2020 2020 2020  des: int,.      
-000078c0: 2020 636c 7573 7465 725f 636f 6e66 6967    cluster_config
-000078d0: 5f74 656d 706c 6174 653a 2073 7472 2c0a  _template: str,.
-000078e0: 2020 2020 2020 2020 636c 7573 7465 725f          cluster_
-000078f0: 6e61 6d65 3a20 7374 722c 0a20 2020 2020  name: str,.     
-00007900: 2020 206c 6f63 616c 5f77 6865 656c 5f70     local_wheel_p
-00007910: 6174 683a 2070 6174 686c 6962 2e50 6174  ath: pathlib.Pat
-00007920: 682c 0a20 2020 2020 2020 2077 6865 656c  h,.        wheel
-00007930: 5f68 6173 683a 2073 7472 2c0a 2020 2020  _hash: str,.    
-00007940: 2020 2020 7265 6769 6f6e 3a20 4f70 7469      region: Opti
-00007950: 6f6e 616c 5b63 6c6f 7564 732e 5265 6769  onal[clouds.Regi
-00007960: 6f6e 5d20 3d20 4e6f 6e65 2c0a 2020 2020  on] = None,.    
-00007970: 2020 2020 7a6f 6e65 733a 204f 7074 696f      zones: Optio
-00007980: 6e61 6c5b 4c69 7374 5b63 6c6f 7564 732e  nal[List[clouds.
-00007990: 5a6f 6e65 5d5d 203d 204e 6f6e 652c 0a20  Zone]] = None,. 
-000079a0: 2020 2020 2020 2064 7279 7275 6e3a 2062         dryrun: b
-000079b0: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
-000079c0: 2020 2020 206b 6565 705f 6c61 756e 6368       keep_launch
-000079d0: 5f66 6965 6c64 735f 696e 5f65 7869 7374  _fields_in_exist
-000079e0: 696e 675f 636f 6e66 6967 3a20 626f 6f6c  ing_config: bool
-000079f0: 203d 2054 7275 6529 202d 3e20 4469 6374   = True) -> Dict
-00007a00: 5b73 7472 2c20 7374 725d 3a0a 2020 2020  [str, str]:.    
-00007a10: 2222 2246 696c 6c73 2069 6e20 636c 7573  """Fills in clus
-00007a20: 7465 7220 636f 6e66 6967 7572 6174 696f  ter configuratio
-00007a30: 6e20 7465 6d70 6c61 7465 7320 616e 6420  n templates and 
-00007a40: 7772 6974 6573 2074 6865 6d20 6f75 742e  writes them out.
-00007a50: 0a0a 2020 2020 5265 7475 726e 733a 207b  ..    Returns: {
-00007a60: 7072 6f76 6973 696f 6e65 723a 2070 6174  provisioner: pat
-00007a70: 6820 746f 2079 616d 6c2c 2074 6865 2070  h to yaml, the p
-00007a80: 726f 7669 7369 6f6e 696e 6720 7370 6563  rovisioning spec
-00007a90: 7d2e 0a20 2020 2020 2027 7072 6f76 6973  }..      'provis
-00007aa0: 696f 6e65 7227 2063 616e 2062 650a 2020  ioner' can be.  
-00007ab0: 2020 2020 2020 2d20 2772 6179 270a 2020        - 'ray'.  
-00007ac0: 2020 2020 2020 2d20 2774 7075 2d63 7265        - 'tpu-cre
-00007ad0: 6174 652d 7363 7269 7074 2720 2869 6620  ate-script' (if 
-00007ae0: 5450 5520 6973 2072 6571 7565 7374 6564  TPU is requested
-00007af0: 290a 2020 2020 2020 2020 2d20 2774 7075  ).        - 'tpu
-00007b00: 2d64 656c 6574 652d 7363 7269 7074 2720  -delete-script' 
-00007b10: 2869 6620 5450 5520 6973 2072 6571 7565  (if TPU is reque
-00007b20: 7374 6564 290a 2020 2020 5261 6973 6573  sted).    Raises
-00007b30: 3a0a 2020 2020 2020 2020 6578 6365 7074  :.        except
-00007b40: 696f 6e73 2e52 6573 6f75 7263 6573 556e  ions.ResourcesUn
-00007b50: 6176 6169 6c61 626c 6545 7272 6f72 3a20  availableError: 
-00007b60: 6966 2074 6865 2072 6567 696f 6e2f 7a6f  if the region/zo
-00007b70: 6e65 7320 7265 7175 6573 7465 6420 646f  nes requested do
-00007b80: 6573 0a20 2020 2020 2020 2020 2020 206e  es.            n
-00007b90: 6f74 2061 7070 6561 7220 696e 2074 6865  ot appear in the
-00007ba0: 2063 6174 616c 6f67 2c20 6f72 2061 6e20   catalog, or an 
-00007bb0: 7373 685f 7072 6f78 795f 636f 6d6d 616e  ssh_proxy_comman
-00007bc0: 6420 6973 2073 7065 6369 6669 6564 2062  d is specified b
-00007bd0: 7574 0a20 2020 2020 2020 2020 2020 206e  ut.            n
-00007be0: 6f74 2066 6f72 2074 6865 2067 6976 656e  ot for the given
-00007bf0: 2072 6567 696f 6e2c 206f 7220 4750 5573   region, or GPUs
-00007c00: 2061 7265 2072 6571 7565 7374 6564 2069   are requested i
-00007c10: 6e20 6120 4b75 6265 726e 6574 6573 0a20  n a Kubernetes. 
-00007c20: 2020 2020 2020 2020 2020 2063 6c75 7374             clust
-00007c30: 6572 2062 7574 2074 6865 2063 6c75 7374  er but the clust
-00007c40: 6572 2064 6f65 7320 6e6f 7420 6861 7665  er does not have
-00007c50: 206e 6f64 6573 206c 6162 656c 6564 2077   nodes labeled w
-00007c60: 6974 6820 4750 5520 7479 7065 732e 0a20  ith GPU types.. 
-00007c70: 2020 2020 2020 2065 7863 6570 7469 6f6e         exception
-00007c80: 732e 496e 7661 6c69 6443 6c6f 7564 436f  s.InvalidCloudCo
-00007c90: 6e66 6967 733a 2069 6620 7468 6520 7573  nfigs: if the us
-00007ca0: 6572 2073 7065 6369 6669 6573 2073 6f6d  er specifies som
-00007cb0: 6520 636f 6e66 6967 2066 6f72 2074 6865  e config for the
-00007cc0: 0a20 2020 2020 2020 2020 2020 2063 6c6f  .            clo
-00007cd0: 7564 2074 6861 7420 6973 206e 6f74 2076  ud that is not v
-00007ce0: 616c 6964 2c20 652e 672e 2072 656d 6f74  alid, e.g. remot
-00007cf0: 655f 6964 656e 7469 7479 3a20 5345 5256  e_identity: SERV
-00007d00: 4943 455f 4143 434f 554e 540a 2020 2020  ICE_ACCOUNT.    
-00007d10: 2020 2020 2020 2020 666f 7220 6120 636c          for a cl
-00007d20: 6f75 6420 7468 6174 2064 6f65 7320 6e6f  oud that does no
-00007d30: 7420 7375 7070 6f72 7420 6974 2c20 7468  t support it, th
-00007d40: 6520 6361 6c6c 6572 2073 686f 756c 6420  e caller should 
-00007d50: 736b 6970 2074 6865 0a20 2020 2020 2020  skip the.       
-00007d60: 2020 2020 2063 6c6f 7564 2069 6e20 7468       cloud in th
-00007d70: 6973 2063 6173 652e 0a20 2020 2022 2222  is case..    """
-00007d80: 0a20 2020 2023 2074 6173 6b2e 6265 7374  .    # task.best
-00007d90: 5f72 6573 6f75 7263 6573 206d 6179 206e  _resources may n
-00007da0: 6f74 2062 6520 6571 7561 6c20 746f 2074  ot be equal to t
-00007db0: 6f5f 7072 6f76 6973 696f 6e20 6966 2074  o_provision if t
-00007dc0: 6865 2075 7365 720a 2020 2020 2320 6973  he user.    # is
-00007dd0: 2072 756e 6e69 6e67 2061 206a 6f62 2077   running a job w
-00007de0: 6974 6820 6c65 7373 2072 6573 6f75 7263  ith less resourc
-00007df0: 6573 2074 6861 6e20 7468 6520 636c 7573  es than the clus
-00007e00: 7465 7220 6861 732e 0a20 2020 2063 6c6f  ter has..    clo
-00007e10: 7564 203d 2074 6f5f 7072 6f76 6973 696f  ud = to_provisio
-00007e20: 6e2e 636c 6f75 640a 2020 2020 6173 7365  n.cloud.    asse
-00007e30: 7274 2063 6c6f 7564 2069 7320 6e6f 7420  rt cloud is not 
-00007e40: 4e6f 6e65 2c20 746f 5f70 726f 7669 7369  None, to_provisi
-00007e50: 6f6e 0a0a 2020 2020 636c 7573 7465 725f  on..    cluster_
-00007e60: 6e61 6d65 5f6f 6e5f 636c 6f75 6420 3d20  name_on_cloud = 
-00007e70: 636f 6d6d 6f6e 5f75 7469 6c73 2e6d 616b  common_utils.mak
-00007e80: 655f 636c 7573 7465 725f 6e61 6d65 5f6f  e_cluster_name_o
-00007e90: 6e5f 636c 6f75 6428 0a20 2020 2020 2020  n_cloud(.       
-00007ea0: 2063 6c75 7374 6572 5f6e 616d 652c 206d   cluster_name, m
-00007eb0: 6178 5f6c 656e 6774 683d 636c 6f75 642e  ax_length=cloud.
-00007ec0: 6d61 785f 636c 7573 7465 725f 6e61 6d65  max_cluster_name
-00007ed0: 5f6c 656e 6774 6828 2929 0a0a 2020 2020  _length())..    
-00007ee0: 2320 5468 6973 2063 616e 2072 6169 7365  # This can raise
-00007ef0: 2061 2052 6573 6f75 7263 6573 556e 6176   a ResourcesUnav
-00007f00: 6169 6c61 626c 6545 7272 6f72 2077 6865  ailableError whe
-00007f10: 6e3a 0a20 2020 2023 2020 2a20 5468 6520  n:.    #  * The 
-00007f20: 7265 6769 6f6e 2f7a 6f6e 6573 2072 6571  region/zones req
-00007f30: 7565 7374 6564 2064 6f65 7320 6e6f 7420  uested does not 
-00007f40: 6170 7065 6172 2069 6e20 7468 6520 6361  appear in the ca
-00007f50: 7461 6c6f 672e 2049 7420 6361 6e20 6265  talog. It can be
-00007f60: 0a20 2020 2023 2020 2020 7472 6967 6765  .    #    trigge
-00007f70: 7265 6420 6966 2074 6865 2075 7365 7220  red if the user 
-00007f80: 6368 616e 6765 6420 7468 6520 6361 7461  changed the cata
-00007f90: 6c6f 6720 6669 6c65 2077 6869 6c65 2074  log file while t
-00007fa0: 6865 7265 2069 7320 6120 636c 7573 7465  here is a cluste
-00007fb0: 720a 2020 2020 2320 2020 2069 6e20 7468  r.    #    in th
-00007fc0: 6520 7265 6d6f 7665 6420 7265 6769 6f6e  e removed region
-00007fd0: 2f7a 6f6e 652e 0a20 2020 2023 2020 2a20  /zone..    #  * 
-00007fe0: 4750 5573 2061 7265 2072 6571 7565 7374  GPUs are request
-00007ff0: 6564 2069 6e20 6120 4b75 6265 726e 6574  ed in a Kubernet
-00008000: 6573 2063 6c75 7374 6572 2062 7574 2074  es cluster but t
-00008010: 6865 2063 6c75 7374 6572 2064 6f65 7320  he cluster does 
-00008020: 6e6f 740a 2020 2020 2320 2020 2068 6176  not.    #    hav
-00008030: 6520 6e6f 6465 7320 6c61 6265 6c65 6420  e nodes labeled 
-00008040: 7769 7468 2047 5055 2074 7970 6573 2e0a  with GPU types..
-00008050: 2020 2020 230a 2020 2020 2320 544f 444f      #.    # TODO
-00008060: 287a 6877 7529 3a20 5765 2073 686f 756c  (zhwu): We shoul
-00008070: 6420 6368 616e 6765 2074 6865 2065 7863  d change the exc
-00008080: 6570 7469 6f6e 2074 7970 6520 746f 2061  eption type to a
-00008090: 206d 6f72 6520 7370 6563 6966 6963 206f   more specific o
-000080a0: 6e65 2c20 6173 0a20 2020 2023 2074 6865  ne, as.    # the
-000080b0: 2052 6573 6f75 7263 6573 556e 6176 6169   ResourcesUnavai
-000080c0: 6c61 626c 6545 7272 6f72 2069 7320 6f76  lableError is ov
-000080d0: 6572 6c79 2075 7365 642e 2041 6c73 6f2c  erly used. Also,
-000080e0: 2069 7420 776f 756c 6420 6265 2062 6574   it would be bet
-000080f0: 7465 7220 746f 0a20 2020 2023 206d 6f76  ter to.    # mov
-00008100: 6520 7468 6520 6368 6563 6b20 6f75 7420  e the check out 
-00008110: 6f66 2074 6869 7320 6675 6e63 7469 6f6e  of this function
-00008120: 2c20 692e 652e 2074 6865 2063 616c 6c65  , i.e. the calle
-00008130: 7220 7368 6f75 6c64 2062 6520 7265 7370  r should be resp
-00008140: 6f6e 7369 626c 650a 2020 2020 2320 666f  onsible.    # fo
-00008150: 7220 7468 6520 7661 6c69 6461 7469 6f6e  r the validation
-00008160: 2e0a 2020 2020 2320 544f 444f 2874 6961  ..    # TODO(tia
-00008170: 6e29 3a20 4d6f 7665 206d 6f72 6520 636c  n): Move more cl
-00008180: 6f75 6420 6167 6e6f 7374 6963 2076 6172  oud agnostic var
-00008190: 7320 746f 2072 6573 6f75 7263 6573 2e70  s to resources.p
-000081a0: 792e 0a20 2020 2072 6573 6f75 7263 6573  y..    resources
-000081b0: 5f76 6172 7320 3d20 746f 5f70 726f 7669  _vars = to_provi
-000081c0: 7369 6f6e 2e6d 616b 655f 6465 706c 6f79  sion.make_deploy
-000081d0: 5f76 6172 6961 626c 6573 2863 6c75 7374  _variables(clust
-000081e0: 6572 5f6e 616d 655f 6f6e 5f63 6c6f 7564  er_name_on_cloud
-000081f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00008200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008220: 2020 2020 2020 2020 2020 7265 6769 6f6e            region
-00008230: 2c20 7a6f 6e65 732c 2064 7279 7275 6e29  , zones, dryrun)
-00008240: 0a20 2020 2063 6f6e 6669 675f 6469 6374  .    config_dict
-00008250: 203d 207b 7d0a 0a20 2020 2073 7065 6369   = {}..    speci
-00008260: 6669 635f 7265 7365 7276 6174 696f 6e73  fic_reservations
-00008270: 203d 2073 6574 280a 2020 2020 2020 2020   = set(.        
-00008280: 736b 7970 696c 6f74 5f63 6f6e 6669 672e  skypilot_config.
-00008290: 6765 745f 6e65 7374 6564 280a 2020 2020  get_nested(.    
-000082a0: 2020 2020 2020 2020 2873 7472 2874 6f5f          (str(to_
-000082b0: 7072 6f76 6973 696f 6e2e 636c 6f75 6429  provision.cloud)
-000082c0: 2e6c 6f77 6572 2829 2c20 2773 7065 6369  .lower(), 'speci
-000082d0: 6669 635f 7265 7365 7276 6174 696f 6e73  fic_reservations
-000082e0: 2729 2c20 7365 7428 2929 290a 0a20 2020  '), set()))..   
-000082f0: 2061 7373 6572 7420 636c 7573 7465 725f   assert cluster_
-00008300: 6e61 6d65 2069 7320 6e6f 7420 4e6f 6e65  name is not None
-00008310: 0a20 2020 2065 7863 6c75 6465 645f 636c  .    excluded_cl
-00008320: 6f75 6473 203d 205b 5d0a 2020 2020 7265  ouds = [].    re
-00008330: 6d6f 7465 5f69 6465 6e74 6974 7920 3d20  mote_identity = 
-00008340: 736b 7970 696c 6f74 5f63 6f6e 6669 672e  skypilot_config.
-00008350: 6765 745f 6e65 7374 6564 280a 2020 2020  get_nested(.    
-00008360: 2020 2020 2873 7472 2863 6c6f 7564 292e      (str(cloud).
-00008370: 6c6f 7765 7228 292c 2027 7265 6d6f 7465  lower(), 'remote
-00008380: 5f69 6465 6e74 6974 7927 292c 2027 4c4f  _identity'), 'LO
-00008390: 4341 4c5f 4352 4544 454e 5449 414c 5327  CAL_CREDENTIALS'
-000083a0: 290a 2020 2020 6966 2072 656d 6f74 655f  ).    if remote_
-000083b0: 6964 656e 7469 7479 203d 3d20 2753 4552  identity == 'SER
-000083c0: 5649 4345 5f41 4343 4f55 4e54 273a 0a20  VICE_ACCOUNT':. 
-000083d0: 2020 2020 2020 2069 6620 6e6f 7420 636c         if not cl
-000083e0: 6f75 642e 7375 7070 6f72 7473 5f73 6572  oud.supports_ser
-000083f0: 7669 6365 5f61 6363 6f75 6e74 5f6f 6e5f  vice_account_on_
-00008400: 7265 6d6f 7465 2829 3a0a 2020 2020 2020  remote():.      
-00008410: 2020 2020 2020 7261 6973 6520 6578 6365        raise exce
-00008420: 7074 696f 6e73 2e49 6e76 616c 6964 436c  ptions.InvalidCl
-00008430: 6f75 6443 6f6e 6669 6773 280a 2020 2020  oudConfigs(.    
-00008440: 2020 2020 2020 2020 2020 2020 2772 656d              'rem
-00008450: 6f74 655f 6964 656e 7469 7479 3a20 5345  ote_identity: SE
-00008460: 5256 4943 455f 4143 434f 554e 5420 6973  RVICE_ACCOUNT is
-00008470: 2073 7065 6369 6669 6564 2069 6e20 270a   specified in '.
-00008480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008490: 6627 7b73 6b79 7069 6c6f 745f 636f 6e66  f'{skypilot_conf
-000084a0: 6967 2e6c 6f61 6465 645f 636f 6e66 6967  ig.loaded_config
-000084b0: 5f70 6174 6821 727d 2066 6f72 207b 636c  _path!r} for {cl
-000084c0: 6f75 647d 2c20 6275 7420 6974 2027 0a20  oud}, but it '. 
-000084d0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-000084e0: 6973 206e 6f74 2073 7570 706f 7274 6564  is not supported
-000084f0: 2062 7920 7468 6973 2063 6c6f 7564 2e20   by this cloud. 
-00008500: 5265 6d6f 7665 2074 6865 2063 6f6e 6669  Remove the confi
-00008510: 6720 6f72 2073 6574 3a20 270a 2020 2020  g or set: '.    
-00008520: 2020 2020 2020 2020 2020 2020 2760 7265              '`re
-00008530: 6d6f 7465 5f69 6465 6e74 6974 793a 204c  mote_identity: L
-00008540: 4f43 414c 5f43 5245 4445 4e54 4941 4c53  OCAL_CREDENTIALS
-00008550: 602e 2729 0a20 2020 2020 2020 2065 7863  `.').        exc
-00008560: 6c75 6465 645f 636c 6f75 6473 203d 205b  luded_clouds = [
-00008570: 636c 6f75 645d 0a20 2020 2063 7265 6465  cloud].    crede
-00008580: 6e74 6961 6c73 203d 2073 6b79 5f63 6865  ntials = sky_che
-00008590: 636b 2e67 6574 5f63 6c6f 7564 5f63 7265  ck.get_cloud_cre
-000085a0: 6465 6e74 6961 6c5f 6669 6c65 5f6d 6f75  dential_file_mou
-000085b0: 6e74 7328 6578 636c 7564 6564 5f63 6c6f  nts(excluded_clo
-000085c0: 7564 7329 0a0a 2020 2020 6175 7468 5f63  uds)..    auth_c
-000085d0: 6f6e 6669 6720 3d20 7b27 7373 685f 7072  onfig = {'ssh_pr
-000085e0: 6976 6174 655f 6b65 7927 3a20 6175 7468  ivate_key': auth
-000085f0: 2e50 5249 5641 5445 5f53 5348 5f4b 4559  .PRIVATE_SSH_KEY
-00008600: 5f50 4154 487d 0a20 2020 2072 6567 696f  _PATH}.    regio
-00008610: 6e5f 6e61 6d65 203d 2072 6573 6f75 7263  n_name = resourc
-00008620: 6573 5f76 6172 732e 6765 7428 2772 6567  es_vars.get('reg
-00008630: 696f 6e27 290a 0a20 2020 2079 616d 6c5f  ion')..    yaml_
-00008640: 7061 7468 203d 205f 6765 745f 7961 6d6c  path = _get_yaml
-00008650: 5f70 6174 685f 6672 6f6d 5f63 6c75 7374  _path_from_clust
-00008660: 6572 5f6e 616d 6528 636c 7573 7465 725f  er_name(cluster_
-00008670: 6e61 6d65 290a 0a20 2020 2023 2052 6574  name)..    # Ret
-00008680: 7269 6576 6520 7468 6520 7373 685f 7072  rieve the ssh_pr
-00008690: 6f78 795f 636f 6d6d 616e 6420 666f 7220  oxy_command for 
-000086a0: 7468 6520 6769 7665 6e20 636c 6f75 6420  the given cloud 
-000086b0: 2f20 7265 6769 6f6e 2e0a 2020 2020 7373  / region..    ss
-000086c0: 685f 7072 6f78 795f 636f 6d6d 616e 645f  h_proxy_command_
-000086d0: 636f 6e66 6967 203d 2073 6b79 7069 6c6f  config = skypilo
-000086e0: 745f 636f 6e66 6967 2e67 6574 5f6e 6573  t_config.get_nes
-000086f0: 7465 6428 0a20 2020 2020 2020 2028 7374  ted(.        (st
-00008700: 7228 636c 6f75 6429 2e6c 6f77 6572 2829  r(cloud).lower()
-00008710: 2c20 2773 7368 5f70 726f 7879 5f63 6f6d  , 'ssh_proxy_com
-00008720: 6d61 6e64 2729 2c20 4e6f 6e65 290a 2020  mand'), None).  
-00008730: 2020 6966 2028 6973 696e 7374 616e 6365    if (isinstance
-00008740: 2873 7368 5f70 726f 7879 5f63 6f6d 6d61  (ssh_proxy_comma
-00008750: 6e64 5f63 6f6e 6669 672c 2073 7472 2920  nd_config, str) 
-00008760: 6f72 0a20 2020 2020 2020 2020 2020 2073  or.            s
-00008770: 7368 5f70 726f 7879 5f63 6f6d 6d61 6e64  sh_proxy_command
-00008780: 5f63 6f6e 6669 6720 6973 204e 6f6e 6529  _config is None)
-00008790: 3a0a 2020 2020 2020 2020 7373 685f 7072  :.        ssh_pr
-000087a0: 6f78 795f 636f 6d6d 616e 6420 3d20 7373  oxy_command = ss
-000087b0: 685f 7072 6f78 795f 636f 6d6d 616e 645f  h_proxy_command_
-000087c0: 636f 6e66 6967 0a20 2020 2065 6c73 653a  config.    else:
-000087d0: 0a20 2020 2020 2020 2023 2073 7368 5f70  .        # ssh_p
-000087e0: 726f 7879 5f63 6f6d 6d61 6e64 5f63 6f6e  roxy_command_con
-000087f0: 6669 673a 2044 6963 745b 7374 722c 2073  fig: Dict[str, s
-00008800: 7472 5d2c 2072 6567 696f 6e5f 6e61 6d65  tr], region_name
-00008810: 202d 3e20 636f 6d6d 616e 640a 2020 2020   -> command.    
-00008820: 2020 2020 2320 5468 6973 2074 7970 6520      # This type 
-00008830: 6368 6563 6b20 6973 2064 6f6e 6520 6279  check is done by
-00008840: 2073 6b79 7069 6c6f 745f 636f 6e66 6967   skypilot_config
-00008850: 2061 7420 636f 6e66 6967 206c 6f61 6420   at config load 
-00008860: 7469 6d65 2e0a 0a20 2020 2020 2020 2023  time...        #
-00008870: 2054 6865 7265 2061 7265 2074 776f 2063   There are two c
-00008880: 6173 6573 3a0a 2020 2020 2020 2020 6966  ases:.        if
-00008890: 206b 6565 705f 6c61 756e 6368 5f66 6965   keep_launch_fie
-000088a0: 6c64 735f 696e 5f65 7869 7374 696e 675f  lds_in_existing_
-000088b0: 636f 6e66 6967 3a0a 2020 2020 2020 2020  config:.        
-000088c0: 2020 2020 2320 2831 2920 5765 2772 6520      # (1) We're 
-000088d0: 7265 2d70 726f 7669 7369 6f6e 696e 6720  re-provisioning 
-000088e0: 616e 2065 7869 7374 696e 6720 636c 7573  an existing clus
-000088f0: 7465 722e 0a20 2020 2020 2020 2020 2020  ter..           
-00008900: 2023 0a20 2020 2020 2020 2020 2020 2023   #.            #
-00008910: 2057 6520 7573 6520 4e6f 6e65 2066 6f72   We use None for
-00008920: 2073 7368 5f70 726f 7879 5f63 6f6d 6d61   ssh_proxy_comma
-00008930: 6e64 2c20 7768 6963 6820 7769 6c6c 2062  nd, which will b
-00008940: 6520 7265 7374 6f72 6564 2074 6f20 7468  e restored to th
-00008950: 650a 2020 2020 2020 2020 2020 2020 2320  e.            # 
-00008960: 636c 7573 7465 7227 7320 6f72 6967 696e  cluster's origin
-00008970: 616c 2076 616c 7565 206c 6174 6572 2062  al value later b
-00008980: 7920 5f72 6570 6c61 6365 5f79 616d 6c5f  y _replace_yaml_
-00008990: 6469 6374 7328 292e 0a20 2020 2020 2020  dicts()..       
-000089a0: 2020 2020 2073 7368 5f70 726f 7879 5f63       ssh_proxy_c
-000089b0: 6f6d 6d61 6e64 203d 204e 6f6e 650a 2020  ommand = None.  
-000089c0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-000089d0: 2020 2020 2020 2020 2320 2832 2920 5765          # (2) We
-000089e0: 2772 6520 6c61 756e 6368 696e 6720 6120  're launching a 
-000089f0: 6e65 7720 636c 7573 7465 722e 0a20 2020  new cluster..   
-00008a00: 2020 2020 2020 2020 2023 0a20 2020 2020           #.     
-00008a10: 2020 2020 2020 2023 2052 6573 6f75 7263         # Resourc
-00008a20: 6573 2e67 6574 5f76 616c 6964 5f72 6567  es.get_valid_reg
-00008a30: 696f 6e73 5f66 6f72 5f6c 6175 6e63 6861  ions_for_launcha
-00008a40: 626c 6528 2920 7265 7370 6563 7473 2074  ble() respects t
-00008a50: 6865 206b 6579 7320 2872 6567 696f 6e73  he keys (regions
-00008a60: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
-00008a70: 696e 2073 7368 5f70 726f 7879 5f63 6f6d  in ssh_proxy_com
-00008a80: 6d61 6e64 2069 6e20 736b 7970 696c 6f74  mand in skypilot
-00008a90: 5f63 6f6e 6669 672e 2053 6f20 6865 7265  _config. So here
-00008aa0: 2077 6520 6164 6420 616e 2061 7373 6572   we add an asser
-00008ab0: 742e 0a20 2020 2020 2020 2020 2020 2061  t..            a
-00008ac0: 7373 6572 7420 7265 6769 6f6e 5f6e 616d  ssert region_nam
-00008ad0: 6520 696e 2073 7368 5f70 726f 7879 5f63  e in ssh_proxy_c
-00008ae0: 6f6d 6d61 6e64 5f63 6f6e 6669 672c 2028  ommand_config, (
-00008af0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008b00: 2072 6567 696f 6e5f 6e61 6d65 2c20 7373   region_name, ss
-00008b10: 685f 7072 6f78 795f 636f 6d6d 616e 645f  h_proxy_command_
-00008b20: 636f 6e66 6967 290a 2020 2020 2020 2020  config).        
-00008b30: 2020 2020 7373 685f 7072 6f78 795f 636f      ssh_proxy_co
-00008b40: 6d6d 616e 6420 3d20 7373 685f 7072 6f78  mmand = ssh_prox
-00008b50: 795f 636f 6d6d 616e 645f 636f 6e66 6967  y_command_config
-00008b60: 5b72 6567 696f 6e5f 6e61 6d65 5d0a 2020  [region_name].  
-00008b70: 2020 6c6f 6767 6572 2e64 6562 7567 2866    logger.debug(f
-00008b80: 2755 7369 6e67 2073 7368 5f70 726f 7879  'Using ssh_proxy
-00008b90: 5f63 6f6d 6d61 6e64 3a20 7b73 7368 5f70  _command: {ssh_p
-00008ba0: 726f 7879 5f63 6f6d 6d61 6e64 2172 7d27  roxy_command!r}'
-00008bb0: 290a 0a20 2020 2023 2055 7365 722d 7375  )..    # User-su
-00008bc0: 7070 6c69 6564 2069 6e73 7461 6e63 6520  pplied instance 
-00008bd0: 7461 6773 2e0a 2020 2020 696e 7374 616e  tags..    instan
-00008be0: 6365 5f74 6167 7320 3d20 7b7d 0a20 2020  ce_tags = {}.   
-00008bf0: 2069 6e73 7461 6e63 655f 7461 6773 203d   instance_tags =
-00008c00: 2073 6b79 7069 6c6f 745f 636f 6e66 6967   skypilot_config
-00008c10: 2e67 6574 5f6e 6573 7465 6428 0a20 2020  .get_nested(.   
-00008c20: 2020 2020 2028 7374 7228 636c 6f75 6429       (str(cloud)
-00008c30: 2e6c 6f77 6572 2829 2c20 2769 6e73 7461  .lower(), 'insta
-00008c40: 6e63 655f 7461 6773 2729 2c20 7b7d 290a  nce_tags'), {}).
-00008c50: 2020 2020 2320 696e 7374 616e 6365 5f74      # instance_t
-00008c60: 6167 7320 6973 2061 2064 6963 742c 2077  ags is a dict, w
-00008c70: 6869 6368 2069 7320 6775 6172 616e 7465  hich is guarante
-00008c80: 6564 2062 7920 7468 6520 7479 7065 2063  ed by the type c
-00008c90: 6865 636b 2069 6e0a 2020 2020 2320 7363  heck in.    # sc
-00008ca0: 6865 6d61 732e 7079 0a20 2020 2061 7373  hemas.py.    ass
-00008cb0: 6572 7420 6973 696e 7374 616e 6365 2869  ert isinstance(i
-00008cc0: 6e73 7461 6e63 655f 7461 6773 2c20 6469  nstance_tags, di
-00008cd0: 6374 292c 2069 6e73 7461 6e63 655f 7461  ct), instance_ta
-00008ce0: 6773 0a0a 2020 2020 2320 4475 6d70 2074  gs..    # Dump t
-00008cf0: 6865 2052 6179 2070 6f72 7473 2074 6f20  he Ray ports to 
-00008d00: 6120 6669 6c65 2066 6f72 2052 6179 206a  a file for Ray j
-00008d10: 6f62 2073 7562 6d69 7373 696f 6e0a 2020  ob submission.  
-00008d20: 2020 6475 6d70 5f70 6f72 745f 636f 6d6d    dump_port_comm
-00008d30: 616e 6420 3d20 280a 2020 2020 2020 2020  and = (.        
-00008d40: 6627 7079 7468 6f6e 202d 6320 5c27 696d  f'python -c \'im
-00008d50: 706f 7274 206a 736f 6e2c 206f 733b 206a  port json, os; j
-00008d60: 736f 6e2e 6475 6d70 287b 636f 6e73 7461  son.dump({consta
-00008d70: 6e74 732e 534b 595f 5245 4d4f 5445 5f52  nts.SKY_REMOTE_R
-00008d80: 4159 5f50 4f52 545f 4449 4354 5f53 5452  AY_PORT_DICT_STR
-00008d90: 7d2c 2027 0a20 2020 2020 2020 2066 276f  }, '.        f'o
-00008da0: 7065 6e28 6f73 2e70 6174 682e 6578 7061  pen(os.path.expa
-00008db0: 6e64 7573 6572 2822 7b63 6f6e 7374 616e  nduser("{constan
-00008dc0: 7473 2e53 4b59 5f52 454d 4f54 455f 5241  ts.SKY_REMOTE_RA
-00008dd0: 595f 504f 5254 5f46 494c 457d 2229 2c20  Y_PORT_FILE}"), 
-00008de0: 2277 222c 2065 6e63 6f64 696e 673d 2275  "w", encoding="u
-00008df0: 7466 2d38 2229 295c 2727 0a20 2020 2029  tf-8"))\''.    )
-00008e00: 0a0a 2020 2020 2320 5573 6520 6120 746d  ..    # Use a tm
-00008e10: 7020 6669 6c65 2070 6174 6820 746f 2061  p file path to a
-00008e20: 766f 6964 2069 6e63 6f6d 706c 6574 6520  void incomplete 
-00008e30: 5941 4d4c 2066 696c 6520 6265 696e 6720  YAML file being 
-00008e40: 7265 2d75 7365 6420 696e 2074 6865 0a20  re-used in the. 
-00008e50: 2020 2023 2066 7574 7572 652e 0a20 2020     # future..   
-00008e60: 2074 6d70 5f79 616d 6c5f 7061 7468 203d   tmp_yaml_path =
-00008e70: 2079 616d 6c5f 7061 7468 202b 2027 2e74   yaml_path + '.t
-00008e80: 6d70 270a 2020 2020 636f 6d6d 6f6e 5f75  mp'.    common_u
-00008e90: 7469 6c73 2e66 696c 6c5f 7465 6d70 6c61  tils.fill_templa
-00008ea0: 7465 280a 2020 2020 2020 2020 636c 7573  te(.        clus
-00008eb0: 7465 725f 636f 6e66 6967 5f74 656d 706c  ter_config_templ
-00008ec0: 6174 652c 0a20 2020 2020 2020 2064 6963  ate,.        dic
-00008ed0: 7428 0a20 2020 2020 2020 2020 2020 2072  t(.            r
-00008ee0: 6573 6f75 7263 6573 5f76 6172 732c 0a20  esources_vars,. 
-00008ef0: 2020 2020 2020 2020 2020 202a 2a7b 0a20             **{. 
-00008f00: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00008f10: 636c 7573 7465 725f 6e61 6d65 5f6f 6e5f  cluster_name_on_
-00008f20: 636c 6f75 6427 3a20 636c 7573 7465 725f  cloud': cluster_
-00008f30: 6e61 6d65 5f6f 6e5f 636c 6f75 642c 0a20  name_on_cloud,. 
-00008f40: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00008f50: 6e75 6d5f 6e6f 6465 7327 3a20 6e75 6d5f  num_nodes': num_
-00008f60: 6e6f 6465 732c 0a20 2020 2020 2020 2020  nodes,.         
-00008f70: 2020 2020 2020 2027 6469 736b 5f73 697a         'disk_siz
-00008f80: 6527 3a20 746f 5f70 726f 7669 7369 6f6e  e': to_provision
-00008f90: 2e64 6973 6b5f 7369 7a65 2c0a 2020 2020  .disk_size,.    
-00008fa0: 2020 2020 2020 2020 2020 2020 2320 4966              # If
-00008fb0: 2074 6865 2063 7572 7265 6e74 2063 6f64   the current cod
-00008fc0: 6520 6973 2072 756e 2062 7920 636f 6e74  e is run by cont
-00008fd0: 726f 6c6c 6572 2c20 7072 6f70 6167 6174  roller, propagat
-00008fe0: 6520 7468 6520 7265 616c 0a20 2020 2020  e the real.     
-00008ff0: 2020 2020 2020 2020 2020 2023 2063 616c             # cal
-00009000: 6c69 6e67 2075 7365 7220 7768 6963 6820  ling user which 
-00009010: 7368 6f75 6c64 2776 6520 6265 656e 2070  should've been p
-00009020: 6173 7365 6420 696e 2061 7320 7468 650a  assed in as the.
-00009030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009040: 2320 534b 5950 494c 4f54 5f55 5345 5220  # SKYPILOT_USER 
-00009050: 656e 7620 7661 7220 2873 6565 0a20 2020  env var (see.   
-00009060: 2020 2020 2020 2020 2020 2020 2023 2063               # c
-00009070: 6f6e 7472 6f6c 6c65 725f 7574 696c 732e  ontroller_utils.
-00009080: 7368 6172 6564 5f63 6f6e 7472 6f6c 6c65  shared_controlle
-00009090: 725f 7661 7273 5f74 6f5f 6669 6c6c 2829  r_vars_to_fill()
-000090a0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000090b0: 2020 2775 7365 7227 3a20 636f 6d6d 6f6e    'user': common
-000090c0: 5f75 7469 6c73 2e67 6574 5f63 6c65 616e  _utils.get_clean
-000090d0: 6564 5f75 7365 726e 616d 6528 0a20 2020  ed_username(.   
-000090e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000090f0: 206f 732e 656e 7669 726f 6e2e 6765 7428   os.environ.get(
-00009100: 636f 6e73 7461 6e74 732e 5553 4552 5f45  constants.USER_E
-00009110: 4e56 5f56 4152 2c20 2727 2929 2c0a 0a20  NV_VAR, '')),.. 
-00009120: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00009130: 204e 6574 776f 726b 696e 6720 636f 6e66   Networking conf
-00009140: 6967 730a 2020 2020 2020 2020 2020 2020  igs.            
-00009150: 2020 2020 2775 7365 5f69 6e74 6572 6e61      'use_interna
-00009160: 6c5f 6970 7327 3a20 736b 7970 696c 6f74  l_ips': skypilot
-00009170: 5f63 6f6e 6669 672e 6765 745f 6e65 7374  _config.get_nest
-00009180: 6564 280a 2020 2020 2020 2020 2020 2020  ed(.            
-00009190: 2020 2020 2020 2020 2873 7472 2863 6c6f          (str(clo
-000091a0: 7564 292e 6c6f 7765 7228 292c 2027 7573  ud).lower(), 'us
-000091b0: 655f 696e 7465 726e 616c 5f69 7073 2729  e_internal_ips')
-000091c0: 2c20 4661 6c73 6529 2c0a 2020 2020 2020  , False),.      
-000091d0: 2020 2020 2020 2020 2020 2773 7368 5f70            'ssh_p
-000091e0: 726f 7879 5f63 6f6d 6d61 6e64 273a 2073  roxy_command': s
-000091f0: 7368 5f70 726f 7879 5f63 6f6d 6d61 6e64  sh_proxy_command
-00009200: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00009210: 2020 2776 7063 5f6e 616d 6527 3a20 736b    'vpc_name': sk
-00009220: 7970 696c 6f74 5f63 6f6e 6669 672e 6765  ypilot_config.ge
-00009230: 745f 6e65 7374 6564 280a 2020 2020 2020  t_nested(.      
-00009240: 2020 2020 2020 2020 2020 2020 2020 2873                (s
-00009250: 7472 2863 6c6f 7564 292e 6c6f 7765 7228  tr(cloud).lower(
-00009260: 292c 2027 7670 635f 6e61 6d65 2729 2c20  ), 'vpc_name'), 
-00009270: 4e6f 6e65 292c 0a0a 2020 2020 2020 2020  None),..        
-00009280: 2020 2020 2020 2020 2320 5573 6572 2d73          # User-s
-00009290: 7570 706c 6965 6420 696e 7374 616e 6365  upplied instance
-000092a0: 2074 6167 732e 0a20 2020 2020 2020 2020   tags..         
-000092b0: 2020 2020 2020 2027 696e 7374 616e 6365         'instance
-000092c0: 5f74 6167 7327 3a20 696e 7374 616e 6365  _tags': instance
-000092d0: 5f74 6167 732c 0a20 2020 2020 2020 2020  _tags,.         
-000092e0: 2020 2020 2020 2023 2054 6865 2072 6573         # The res
-000092f0: 6572 7661 7469 6f6e 2070 6f6f 6c73 2074  ervation pools t
-00009300: 6861 7420 7370 6563 6966 6965 6420 6279  hat specified by
-00009310: 2074 6865 2075 7365 722e 2054 6869 7320   the user. This 
-00009320: 6973 0a20 2020 2020 2020 2020 2020 2020  is.             
-00009330: 2020 2023 2063 7572 7265 6e74 6c79 206f     # currently o
-00009340: 6e6c 7920 7573 6564 2062 7920 4743 502e  nly used by GCP.
-00009350: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009360: 2027 7370 6563 6966 6963 5f72 6573 6572   'specific_reser
-00009370: 7661 7469 6f6e 7327 3a20 7370 6563 6966  vations': specif
-00009380: 6963 5f72 6573 6572 7661 7469 6f6e 732c  ic_reservations,
-00009390: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000093a0: 2020 2320 436f 6e64 6120 7365 7475 700a    # Conda setup.
-000093b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000093c0: 2763 6f6e 6461 5f69 6e73 7461 6c6c 6174  'conda_installat
-000093d0: 696f 6e5f 636f 6d6d 616e 6473 273a 0a20  ion_commands':. 
-000093e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000093f0: 2020 2063 6f6e 7374 616e 7473 2e43 4f4e     constants.CON
-00009400: 4441 5f49 4e53 5441 4c4c 4154 494f 4e5f  DA_INSTALLATION_
-00009410: 434f 4d4d 414e 4453 2c0a 0a20 2020 2020  COMMANDS,..     
-00009420: 2020 2020 2020 2020 2020 2023 2050 6f72             # Por
-00009430: 7420 6f66 2052 6179 2028 4743 5320 7365  t of Ray (GCS se
-00009440: 7276 6572 292e 0a20 2020 2020 2020 2020  rver)..         
-00009450: 2020 2020 2020 2023 2052 6179 2773 2064         # Ray's d
-00009460: 6566 6175 6c74 2070 6f72 7420 3633 3739  efault port 6379
-00009470: 2069 7320 636f 6e66 6c69 6374 6564 2077   is conflicted w
-00009480: 6974 6820 5265 6469 732e 0a20 2020 2020  ith Redis..     
-00009490: 2020 2020 2020 2020 2020 2027 7261 795f             'ray_
-000094a0: 706f 7274 273a 2063 6f6e 7374 616e 7473  port': constants
-000094b0: 2e53 4b59 5f52 454d 4f54 455f 5241 595f  .SKY_REMOTE_RAY_
-000094c0: 504f 5254 2c0a 2020 2020 2020 2020 2020  PORT,.          
-000094d0: 2020 2020 2020 2772 6179 5f64 6173 6862        'ray_dashb
-000094e0: 6f61 7264 5f70 6f72 7427 3a20 636f 6e73  oard_port': cons
-000094f0: 7461 6e74 732e 534b 595f 5245 4d4f 5445  tants.SKY_REMOTE
-00009500: 5f52 4159 5f44 4153 4842 4f41 5244 5f50  _RAY_DASHBOARD_P
-00009510: 4f52 542c 0a20 2020 2020 2020 2020 2020  ORT,.           
-00009520: 2020 2020 2027 7261 795f 7465 6d70 5f64       'ray_temp_d
-00009530: 6972 273a 2063 6f6e 7374 616e 7473 2e53  ir': constants.S
-00009540: 4b59 5f52 454d 4f54 455f 5241 595f 5445  KY_REMOTE_RAY_TE
-00009550: 4d50 4449 522c 0a20 2020 2020 2020 2020  MPDIR,.         
-00009560: 2020 2020 2020 2027 6475 6d70 5f70 6f72         'dump_por
-00009570: 745f 636f 6d6d 616e 6427 3a20 6475 6d70  t_command': dump
-00009580: 5f70 6f72 745f 636f 6d6d 616e 642c 0a20  _port_command,. 
-00009590: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000095a0: 2052 6179 2076 6572 7369 6f6e 2e0a 2020   Ray version..  
-000095b0: 2020 2020 2020 2020 2020 2020 2020 2772                'r
-000095c0: 6179 5f76 6572 7369 6f6e 273a 2063 6f6e  ay_version': con
-000095d0: 7374 616e 7473 2e53 4b59 5f52 454d 4f54  stants.SKY_REMOT
-000095e0: 455f 5241 595f 5645 5253 494f 4e2c 0a20  E_RAY_VERSION,. 
-000095f0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00009600: 2043 6f6d 6d61 6e64 2066 6f72 2077 6169   Command for wai
-00009610: 7469 6e67 2072 6179 2063 6c75 7374 6572  ting ray cluster
-00009620: 2074 6f20 6265 2072 6561 6479 206f 6e20   to be ready on 
-00009630: 6865 6164 2e0a 2020 2020 2020 2020 2020  head..          
-00009640: 2020 2020 2020 2772 6179 5f68 6561 645f        'ray_head_
-00009650: 7761 6974 5f69 6e69 7469 616c 697a 6564  wait_initialized
-00009660: 5f63 6f6d 6d61 6e64 273a 0a20 2020 2020  _command':.     
-00009670: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00009680: 6e73 7461 6e63 655f 7365 7475 702e 5241  nstance_setup.RA
-00009690: 595f 4845 4144 5f57 4149 545f 494e 4954  Y_HEAD_WAIT_INIT
-000096a0: 4941 4c49 5a45 445f 434f 4d4d 414e 442c  IALIZED_COMMAND,
-000096b0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000096c0: 2020 2320 436c 6f75 6420 6372 6564 656e    # Cloud creden
-000096d0: 7469 616c 7320 666f 7220 636c 6f75 6420  tials for cloud 
-000096e0: 7374 6f72 6167 652e 0a20 2020 2020 2020  storage..       
-000096f0: 2020 2020 2020 2020 2027 6372 6564 656e           'creden
-00009700: 7469 616c 7327 3a20 6372 6564 656e 7469  tials': credenti
-00009710: 616c 732c 0a20 2020 2020 2020 2020 2020  als,.           
-00009720: 2020 2020 2023 2053 6b79 2072 656d 6f74       # Sky remot
-00009730: 6520 7574 696c 732e 0a20 2020 2020 2020  e utils..       
-00009740: 2020 2020 2020 2020 2027 736b 795f 7265           'sky_re
-00009750: 6d6f 7465 5f70 6174 6827 3a20 534b 595f  mote_path': SKY_
-00009760: 5245 4d4f 5445 5f50 4154 482c 0a20 2020  REMOTE_PATH,.   
-00009770: 2020 2020 2020 2020 2020 2020 2027 736b               'sk
-00009780: 795f 6c6f 6361 6c5f 7061 7468 273a 2073  y_local_path': s
-00009790: 7472 286c 6f63 616c 5f77 6865 656c 5f70  tr(local_wheel_p
-000097a0: 6174 6829 2c0a 2020 2020 2020 2020 2020  ath),.          
-000097b0: 2020 2020 2020 2320 4164 6420 7961 6d6c        # Add yaml
-000097c0: 2066 696c 6520 7061 7468 2074 6f20 7468   file path to th
-000097d0: 6520 7465 6d70 6c61 7465 2076 6172 6961  e template varia
-000097e0: 626c 6573 2e0a 2020 2020 2020 2020 2020  bles..          
-000097f0: 2020 2020 2020 2773 6b79 5f72 6179 5f79        'sky_ray_y
-00009800: 616d 6c5f 7265 6d6f 7465 5f70 6174 6827  aml_remote_path'
-00009810: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00009820: 2020 2020 2020 636c 7573 7465 725f 7961        cluster_ya
-00009830: 6d6c 5f75 7469 6c73 2e53 4b59 5f43 4c55  ml_utils.SKY_CLU
-00009840: 5354 4552 5f59 414d 4c5f 5245 4d4f 5445  STER_YAML_REMOTE
-00009850: 5f50 4154 482c 0a20 2020 2020 2020 2020  _PATH,.         
-00009860: 2020 2020 2020 2027 736b 795f 7261 795f         'sky_ray_
-00009870: 7961 6d6c 5f6c 6f63 616c 5f70 6174 6827  yaml_local_path'
-00009880: 3a20 746d 705f 7961 6d6c 5f70 6174 682c  : tmp_yaml_path,
-00009890: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000098a0: 2027 736b 795f 7665 7273 696f 6e27 3a20   'sky_version': 
-000098b0: 7374 7228 7665 7273 696f 6e2e 7061 7273  str(version.pars
-000098c0: 6528 736b 792e 5f5f 7665 7273 696f 6e5f  e(sky.__version_
-000098d0: 5f29 292c 0a20 2020 2020 2020 2020 2020  _)),.           
-000098e0: 2020 2020 2027 736b 795f 7768 6565 6c5f       'sky_wheel_
-000098f0: 6861 7368 273a 2077 6865 656c 5f68 6173  hash': wheel_has
-00009900: 682c 0a20 2020 2020 2020 2020 2020 2020  h,.             
-00009910: 2020 2023 2041 7574 6865 6e74 6963 6174     # Authenticat
-00009920: 696f 6e20 286f 7074 696f 6e61 6c29 2e0a  ion (optional)..
-00009930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009940: 2a2a 6175 7468 5f63 6f6e 6669 672c 0a20  **auth_config,. 
-00009950: 2020 2020 2020 2020 2020 207d 292c 0a20             }),. 
-00009960: 2020 2020 2020 206f 7574 7075 745f 7061         output_pa
-00009970: 7468 3d74 6d70 5f79 616d 6c5f 7061 7468  th=tmp_yaml_path
-00009980: 290a 2020 2020 636f 6e66 6967 5f64 6963  ).    config_dic
-00009990: 745b 2763 6c75 7374 6572 5f6e 616d 6527  t['cluster_name'
-000099a0: 5d20 3d20 636c 7573 7465 725f 6e61 6d65  ] = cluster_name
-000099b0: 0a20 2020 2063 6f6e 6669 675f 6469 6374  .    config_dict
-000099c0: 5b27 7261 7927 5d20 3d20 7961 6d6c 5f70  ['ray'] = yaml_p
-000099d0: 6174 680a 2020 2020 6966 2064 7279 7275  ath.    if dryru
-000099e0: 6e3a 0a20 2020 2020 2020 2023 2049 6620  n:.        # If 
-000099f0: 6472 7972 756e 2c20 7265 7475 726e 2074  dryrun, return t
-00009a00: 6865 2075 6e66 696e 6973 6865 6420 746d  he unfinished tm
-00009a10: 7020 7961 6d6c 2070 6174 682e 0a20 2020  p yaml path..   
-00009a20: 2020 2020 2063 6f6e 6669 675f 6469 6374       config_dict
-00009a30: 5b27 7261 7927 5d20 3d20 746d 705f 7961  ['ray'] = tmp_ya
-00009a40: 6d6c 5f70 6174 680a 2020 2020 2020 2020  ml_path.        
-00009a50: 7265 7475 726e 2063 6f6e 6669 675f 6469  return config_di
-00009a60: 6374 0a20 2020 205f 6164 645f 6175 7468  ct.    _add_auth
-00009a70: 5f74 6f5f 636c 7573 7465 725f 636f 6e66  _to_cluster_conf
-00009a80: 6967 2863 6c6f 7564 2c20 746d 705f 7961  ig(cloud, tmp_ya
-00009a90: 6d6c 5f70 6174 6829 0a0a 2020 2020 2320  ml_path)..    # 
-00009aa0: 4164 6420 6b75 6265 726e 6574 6573 2063  Add kubernetes c
-00009ab0: 6f6e 6669 6720 6669 656c 6473 2066 726f  onfig fields fro
-00009ac0: 6d20 7e2f 2e73 6b79 2f63 6f6e 6669 670a  m ~/.sky/config.
-00009ad0: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-00009ae0: 6528 636c 6f75 642c 2063 6c6f 7564 732e  e(cloud, clouds.
-00009af0: 4b75 6265 726e 6574 6573 293a 0a20 2020  Kubernetes):.   
-00009b00: 2020 2020 206b 7562 6572 6e65 7465 735f       kubernetes_
-00009b10: 7574 696c 732e 636f 6d62 696e 655f 706f  utils.combine_po
-00009b20: 645f 636f 6e66 6967 5f66 6965 6c64 7328  d_config_fields(
-00009b30: 746d 705f 7961 6d6c 5f70 6174 6829 0a0a  tmp_yaml_path)..
-00009b40: 2020 2020 2320 5265 7374 6f72 6520 7468      # Restore th
-00009b50: 6520 6f6c 6420 7961 6d6c 2063 6f6e 7465  e old yaml conte
-00009b60: 6e74 2066 6f72 2062 6163 6b77 6172 6420  nt for backward 
-00009b70: 636f 6d70 6174 6962 696c 6974 792e 0a20  compatibility.. 
-00009b80: 2020 2069 6620 6f73 2e70 6174 682e 6578     if os.path.ex
-00009b90: 6973 7473 2879 616d 6c5f 7061 7468 2920  ists(yaml_path) 
-00009ba0: 616e 6420 6b65 6570 5f6c 6175 6e63 685f  and keep_launch_
-00009bb0: 6669 656c 6473 5f69 6e5f 6578 6973 7469  fields_in_existi
-00009bc0: 6e67 5f63 6f6e 6669 673a 0a20 2020 2020  ng_config:.     
-00009bd0: 2020 2077 6974 6820 6f70 656e 2879 616d     with open(yam
-00009be0: 6c5f 7061 7468 2c20 2772 272c 2065 6e63  l_path, 'r', enc
-00009bf0: 6f64 696e 673d 2775 7466 2d38 2729 2061  oding='utf-8') a
-00009c00: 7320 663a 0a20 2020 2020 2020 2020 2020  s f:.           
-00009c10: 206f 6c64 5f79 616d 6c5f 636f 6e74 656e   old_yaml_conten
-00009c20: 7420 3d20 662e 7265 6164 2829 0a20 2020  t = f.read().   
-00009c30: 2020 2020 2077 6974 6820 6f70 656e 2874       with open(t
-00009c40: 6d70 5f79 616d 6c5f 7061 7468 2c20 2772  mp_yaml_path, 'r
-00009c50: 272c 2065 6e63 6f64 696e 673d 2775 7466  ', encoding='utf
-00009c60: 2d38 2729 2061 7320 663a 0a20 2020 2020  -8') as f:.     
-00009c70: 2020 2020 2020 206e 6577 5f79 616d 6c5f         new_yaml_
-00009c80: 636f 6e74 656e 7420 3d20 662e 7265 6164  content = f.read
-00009c90: 2829 0a20 2020 2020 2020 2072 6573 746f  ().        resto
-00009ca0: 7265 645f 7961 6d6c 5f63 6f6e 7465 6e74  red_yaml_content
-00009cb0: 203d 205f 7265 706c 6163 655f 7961 6d6c   = _replace_yaml
-00009cc0: 5f64 6963 7473 280a 2020 2020 2020 2020  _dicts(.        
-00009cd0: 2020 2020 6e65 775f 7961 6d6c 5f63 6f6e      new_yaml_con
-00009ce0: 7465 6e74 2c20 6f6c 645f 7961 6d6c 5f63  tent, old_yaml_c
-00009cf0: 6f6e 7465 6e74 2c0a 2020 2020 2020 2020  ontent,.        
-00009d00: 2020 2020 5f52 4159 5f59 414d 4c5f 4b45      _RAY_YAML_KE
-00009d10: 5953 5f54 4f5f 5245 5354 4f52 455f 464f  YS_TO_RESTORE_FO
-00009d20: 525f 4241 434b 5f43 4f4d 5041 5449 4249  R_BACK_COMPATIBI
-00009d30: 4c49 5459 2c0a 2020 2020 2020 2020 2020  LITY,.          
-00009d40: 2020 5f52 4159 5f59 414d 4c5f 4b45 5953    _RAY_YAML_KEYS
-00009d50: 5f54 4f5f 5245 5354 4f52 455f 4558 4345  _TO_RESTORE_EXCE
-00009d60: 5054 494f 4e53 290a 2020 2020 2020 2020  PTIONS).        
-00009d70: 7769 7468 206f 7065 6e28 746d 705f 7961  with open(tmp_ya
-00009d80: 6d6c 5f70 6174 682c 2027 7727 2c20 656e  ml_path, 'w', en
-00009d90: 636f 6469 6e67 3d27 7574 662d 3827 2920  coding='utf-8') 
-00009da0: 6173 2066 3a0a 2020 2020 2020 2020 2020  as f:.          
-00009db0: 2020 662e 7772 6974 6528 7265 7374 6f72    f.write(restor
-00009dc0: 6564 5f79 616d 6c5f 636f 6e74 656e 7429  ed_yaml_content)
-00009dd0: 0a0a 2020 2020 2320 5265 6164 2074 6865  ..    # Read the
-00009de0: 2063 6c75 7374 6572 206e 616d 6520 6672   cluster name fr
-00009df0: 6f6d 2074 6865 2074 6d70 2079 616d 6c20  om the tmp yaml 
-00009e00: 6669 6c65 2c20 746f 2074 616b 6520 7468  file, to take th
-00009e10: 6520 6261 636b 7761 7264 0a20 2020 2023  e backward.    #
-00009e20: 2063 6f6d 7061 7462 696c 6974 7920 7265   compatbility re
-00009e30: 7374 6f72 7469 6f6e 2061 626f 7665 2069  stortion above i
-00009e40: 6e74 6f20 6163 636f 756e 742e 0a20 2020  nto account..   
-00009e50: 2023 2054 4f44 4f3a 2072 656d 6f76 6520   # TODO: remove 
-00009e60: 7468 6973 2061 6674 6572 2032 206d 696e  this after 2 min
-00009e70: 6f72 2072 656c 6561 7365 732c 2030 2e35  or releases, 0.5
-00009e80: 2e30 2e0a 2020 2020 7961 6d6c 5f63 6f6e  .0..    yaml_con
-00009e90: 6669 6720 3d20 636f 6d6d 6f6e 5f75 7469  fig = common_uti
-00009ea0: 6c73 2e72 6561 645f 7961 6d6c 2874 6d70  ls.read_yaml(tmp
-00009eb0: 5f79 616d 6c5f 7061 7468 290a 2020 2020  _yaml_path).    
-00009ec0: 636f 6e66 6967 5f64 6963 745b 2763 6c75  config_dict['clu
-00009ed0: 7374 6572 5f6e 616d 655f 6f6e 5f63 6c6f  ster_name_on_clo
-00009ee0: 7564 275d 203d 2079 616d 6c5f 636f 6e66  ud'] = yaml_conf
-00009ef0: 6967 5b27 636c 7573 7465 725f 6e61 6d65  ig['cluster_name
-00009f00: 275d 0a0a 2020 2020 2320 4f70 7469 6d69  ']..    # Optimi
-00009f10: 7a61 7469 6f6e 3a20 636f 7079 2074 6865  zation: copy the
-00009f20: 2063 6f6e 7465 6e74 7320 6f66 2073 6f75   contents of sou
-00009f30: 7263 6520 6669 6c65 7320 696e 2066 696c  rce files in fil
-00009f40: 655f 6d6f 756e 7473 2074 6f20 610a 2020  e_mounts to a.  
-00009f50: 2020 2320 7370 6563 6961 6c20 6469 722c    # special dir,
-00009f60: 2061 6e64 2075 706c 6f61 6420 7468 6174   and upload that
-00009f70: 2061 7320 7468 6520 6f6e 6c79 2066 696c   as the only fil
-00009f80: 655f 6d6f 756e 7420 696e 7374 6561 642e  e_mount instead.
-00009f90: 2044 656c 6179 0a20 2020 2023 2063 616c   Delay.    # cal
-00009fa0: 6c69 6e67 2074 6869 7320 6f70 7469 6d69  ling this optimi
-00009fb0: 7a61 7469 6f6e 2075 6e74 696c 206e 6f77  zation until now
-00009fc0: 2c20 7768 656e 2061 6c6c 2073 6f75 7263  , when all sourc
-00009fd0: 6520 6669 6c65 7320 6861 7665 2062 6565  e files have bee
-00009fe0: 6e0a 2020 2020 2320 7772 6974 7465 6e20  n.    # written 
-00009ff0: 616e 6420 7468 6569 7220 636f 6e74 656e  and their conten
-0000a000: 7473 2066 696e 616c 697a 6564 2e0a 2020  ts finalized..  
-0000a010: 2020 230a 2020 2020 2320 4e6f 7465 2074    #.    # Note t
-0000a020: 6861 7420 7468 6520 7261 7920 7961 6d6c  hat the ray yaml
-0000a030: 2066 696c 6520 7769 6c6c 2062 6520 636f   file will be co
-0000a040: 7069 6564 2069 6e74 6f20 7468 6174 2073  pied into that s
-0000a050: 7065 6369 616c 2064 6972 2028 692e 652e  pecial dir (i.e.
-0000a060: 2c0a 2020 2020 2320 7570 6c6f 6164 6564  ,.    # uploaded
-0000a070: 2061 7320 7061 7274 206f 6620 7468 6520   as part of the 
-0000a080: 6669 6c65 5f6d 6f75 6e74 7329 2c20 736f  file_mounts), so
-0000a090: 2074 6865 2072 6573 746f 7265 2066 6f72   the restore for
-0000a0a0: 2062 6163 6b77 6172 640a 2020 2020 2320   backward.    # 
-0000a0b0: 636f 6d70 6174 6962 696c 6974 7920 7368  compatibility sh
-0000a0c0: 6f75 6c64 2067 6f20 6265 666f 7265 2074  ould go before t
-0000a0d0: 6869 7320 6361 6c6c 2e0a 2020 2020 5f6f  his call..    _o
-0000a0e0: 7074 696d 697a 655f 6669 6c65 5f6d 6f75  ptimize_file_mou
-0000a0f0: 6e74 7328 746d 705f 7961 6d6c 5f70 6174  nts(tmp_yaml_pat
-0000a100: 6829 0a0a 2020 2020 2320 5265 6e61 6d65  h)..    # Rename
-0000a110: 2074 6865 2074 6d70 2066 696c 6520 746f   the tmp file to
-0000a120: 2074 6865 2066 696e 616c 2059 414d 4c20   the final YAML 
-0000a130: 7061 7468 2e0a 2020 2020 6f73 2e72 656e  path..    os.ren
-0000a140: 616d 6528 746d 705f 7961 6d6c 5f70 6174  ame(tmp_yaml_pat
-0000a150: 682c 2079 616d 6c5f 7061 7468 290a 2020  h, yaml_path).  
-0000a160: 2020 7573 6167 655f 6c69 622e 6d65 7373    usage_lib.mess
-0000a170: 6167 6573 2e75 7361 6765 2e75 7064 6174  ages.usage.updat
-0000a180: 655f 7261 795f 7961 6d6c 2879 616d 6c5f  e_ray_yaml(yaml_
-0000a190: 7061 7468 290a 2020 2020 7265 7475 726e  path).    return
-0000a1a0: 2063 6f6e 6669 675f 6469 6374 0a0a 0a64   config_dict...d
-0000a1b0: 6566 205f 6164 645f 6175 7468 5f74 6f5f  ef _add_auth_to_
-0000a1c0: 636c 7573 7465 725f 636f 6e66 6967 2863  cluster_config(c
-0000a1d0: 6c6f 7564 3a20 636c 6f75 6473 2e43 6c6f  loud: clouds.Clo
-0000a1e0: 7564 2c20 636c 7573 7465 725f 636f 6e66  ud, cluster_conf
-0000a1f0: 6967 5f66 696c 653a 2073 7472 293a 0a20  ig_file: str):. 
-0000a200: 2020 2022 2222 4164 6473 2053 5348 206b     """Adds SSH k
-0000a210: 6579 2069 6e66 6f20 746f 2074 6865 2063  ey info to the c
-0000a220: 6c75 7374 6572 2063 6f6e 6669 672e 0a0a  luster config...
-0000a230: 2020 2020 5468 6973 2066 756e 6374 696f      This functio
-0000a240: 6e27 7320 6f75 7470 7574 2072 656d 6f76  n's output remov
-0000a250: 6573 2063 6f6d 6d65 6e74 7320 696e 636c  es comments incl
-0000a260: 7564 6564 2069 6e20 7468 6520 6a69 6e6a  uded in the jinj
-0000a270: 6132 2074 656d 706c 6174 652e 0a20 2020  a2 template..   
-0000a280: 2022 2222 0a20 2020 2063 6f6e 6669 6720   """.    config 
-0000a290: 3d20 636f 6d6d 6f6e 5f75 7469 6c73 2e72  = common_utils.r
-0000a2a0: 6561 645f 7961 6d6c 2863 6c75 7374 6572  ead_yaml(cluster
-0000a2b0: 5f63 6f6e 6669 675f 6669 6c65 290a 2020  _config_file).  
-0000a2c0: 2020 2320 4368 6563 6b20 7468 6520 6176    # Check the av
-0000a2d0: 6169 6c61 6269 6c69 7479 206f 6620 7468  ailability of th
-0000a2e0: 6520 636c 6f75 6420 7479 7065 2e0a 2020  e cloud type..  
-0000a2f0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-0000a300: 0a20 2020 2020 2020 2020 2020 2063 6c6f  .            clo
-0000a310: 7564 2c0a 2020 2020 2020 2020 2863 6c6f  ud,.        (clo
-0000a320: 7564 732e 4157 532c 2063 6c6f 7564 732e  uds.AWS, clouds.
-0000a330: 4f43 492c 2063 6c6f 7564 732e 5343 502c  OCI, clouds.SCP,
-0000a340: 2063 6c6f 7564 732e 5673 7068 6572 652c   clouds.Vsphere,
-0000a350: 2063 6c6f 7564 732e 4375 646f 2929 3a0a   clouds.Cudo)):.
-0000a360: 2020 2020 2020 2020 636f 6e66 6967 203d          config =
-0000a370: 2061 7574 682e 636f 6e66 6967 7572 655f   auth.configure_
-0000a380: 7373 685f 696e 666f 2863 6f6e 6669 6729  ssh_info(config)
-0000a390: 0a20 2020 2065 6c69 6620 6973 696e 7374  .    elif isinst
-0000a3a0: 616e 6365 2863 6c6f 7564 2c20 636c 6f75  ance(cloud, clou
-0000a3b0: 6473 2e47 4350 293a 0a20 2020 2020 2020  ds.GCP):.       
-0000a3c0: 2063 6f6e 6669 6720 3d20 6175 7468 2e73   config = auth.s
-0000a3d0: 6574 7570 5f67 6370 5f61 7574 6865 6e74  etup_gcp_authent
-0000a3e0: 6963 6174 696f 6e28 636f 6e66 6967 290a  ication(config).
-0000a3f0: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
-0000a400: 6e63 6528 636c 6f75 642c 2063 6c6f 7564  nce(cloud, cloud
-0000a410: 732e 417a 7572 6529 3a0a 2020 2020 2020  s.Azure):.      
-0000a420: 2020 636f 6e66 6967 203d 2061 7574 682e    config = auth.
-0000a430: 7365 7475 705f 617a 7572 655f 6175 7468  setup_azure_auth
-0000a440: 656e 7469 6361 7469 6f6e 2863 6f6e 6669  entication(confi
-0000a450: 6729 0a20 2020 2065 6c69 6620 6973 696e  g).    elif isin
-0000a460: 7374 616e 6365 2863 6c6f 7564 2c20 636c  stance(cloud, cl
-0000a470: 6f75 6473 2e4c 616d 6264 6129 3a0a 2020  ouds.Lambda):.  
-0000a480: 2020 2020 2020 636f 6e66 6967 203d 2061        config = a
-0000a490: 7574 682e 7365 7475 705f 6c61 6d62 6461  uth.setup_lambda
-0000a4a0: 5f61 7574 6865 6e74 6963 6174 696f 6e28  _authentication(
-0000a4b0: 636f 6e66 6967 290a 2020 2020 656c 6966  config).    elif
-0000a4c0: 2069 7369 6e73 7461 6e63 6528 636c 6f75   isinstance(clou
-0000a4d0: 642c 2063 6c6f 7564 732e 4b75 6265 726e  d, clouds.Kubern
-0000a4e0: 6574 6573 293a 0a20 2020 2020 2020 2063  etes):.        c
-0000a4f0: 6f6e 6669 6720 3d20 6175 7468 2e73 6574  onfig = auth.set
-0000a500: 7570 5f6b 7562 6572 6e65 7465 735f 6175  up_kubernetes_au
-0000a510: 7468 656e 7469 6361 7469 6f6e 2863 6f6e  thentication(con
-0000a520: 6669 6729 0a20 2020 2065 6c69 6620 6973  fig).    elif is
-0000a530: 696e 7374 616e 6365 2863 6c6f 7564 2c20  instance(cloud, 
-0000a540: 636c 6f75 6473 2e49 424d 293a 0a20 2020  clouds.IBM):.   
-0000a550: 2020 2020 2063 6f6e 6669 6720 3d20 6175       config = au
-0000a560: 7468 2e73 6574 7570 5f69 626d 5f61 7574  th.setup_ibm_aut
-0000a570: 6865 6e74 6963 6174 696f 6e28 636f 6e66  hentication(conf
-0000a580: 6967 290a 2020 2020 656c 6966 2069 7369  ig).    elif isi
-0000a590: 6e73 7461 6e63 6528 636c 6f75 642c 2063  nstance(cloud, c
-0000a5a0: 6c6f 7564 732e 5275 6e50 6f64 293a 0a20  louds.RunPod):. 
-0000a5b0: 2020 2020 2020 2063 6f6e 6669 6720 3d20         config = 
-0000a5c0: 6175 7468 2e73 6574 7570 5f72 756e 706f  auth.setup_runpo
-0000a5d0: 645f 6175 7468 656e 7469 6361 7469 6f6e  d_authentication
-0000a5e0: 2863 6f6e 6669 6729 0a20 2020 2065 6c69  (config).    eli
-0000a5f0: 6620 6973 696e 7374 616e 6365 2863 6c6f  f isinstance(clo
-0000a600: 7564 2c20 636c 6f75 6473 2e46 6c75 6964  ud, clouds.Fluid
-0000a610: 7374 6163 6b29 3a0a 2020 2020 2020 2020  stack):.        
-0000a620: 636f 6e66 6967 203d 2061 7574 682e 7365  config = auth.se
-0000a630: 7475 705f 666c 7569 6473 7461 636b 5f61  tup_fluidstack_a
-0000a640: 7574 6865 6e74 6963 6174 696f 6e28 636f  uthentication(co
-0000a650: 6e66 6967 290a 2020 2020 656c 7365 3a0a  nfig).    else:.
-0000a660: 2020 2020 2020 2020 6173 7365 7274 2046          assert F
-0000a670: 616c 7365 2c20 636c 6f75 640a 2020 2020  alse, cloud.    
-0000a680: 636f 6d6d 6f6e 5f75 7469 6c73 2e64 756d  common_utils.dum
-0000a690: 705f 7961 6d6c 2863 6c75 7374 6572 5f63  p_yaml(cluster_c
-0000a6a0: 6f6e 6669 675f 6669 6c65 2c20 636f 6e66  onfig_file, conf
-0000a6b0: 6967 290a 0a0a 6465 6620 6765 745f 7275  ig)...def get_ru
-0000a6c0: 6e5f 7469 6d65 7374 616d 7028 2920 2d3e  n_timestamp() ->
-0000a6d0: 2073 7472 3a0a 2020 2020 7265 7475 726e   str:.    return
-0000a6e0: 2027 736b 792d 2720 2b20 6461 7465 7469   'sky-' + dateti
-0000a6f0: 6d65 2e6e 6f77 2829 2e73 7472 6674 696d  me.now().strftim
-0000a700: 6528 2725 592d 256d 2d25 642d 2548 2d25  e('%Y-%m-%d-%H-%
-0000a710: 4d2d 2553 2d25 6627 290a 0a0a 6465 6620  M-%S-%f')...def 
-0000a720: 6765 745f 7469 6d65 7374 616d 705f 6672  get_timestamp_fr
-0000a730: 6f6d 5f72 756e 5f74 696d 6573 7461 6d70  om_run_timestamp
-0000a740: 2872 756e 5f74 696d 6573 7461 6d70 3a20  (run_timestamp: 
-0000a750: 7374 7229 202d 3e20 666c 6f61 743a 0a20  str) -> float:. 
-0000a760: 2020 2072 6574 7572 6e20 6461 7465 7469     return dateti
-0000a770: 6d65 2e73 7472 7074 696d 6528 0a20 2020  me.strptime(.   
-0000a780: 2020 2020 2072 756e 5f74 696d 6573 7461       run_timesta
-0000a790: 6d70 2e70 6172 7469 7469 6f6e 2827 2d27  mp.partition('-'
-0000a7a0: 295b 325d 2c20 2725 592d 256d 2d25 642d  )[2], '%Y-%m-%d-
-0000a7b0: 2548 2d25 4d2d 2553 2d25 6627 292e 7469  %H-%M-%S-%f').ti
-0000a7c0: 6d65 7374 616d 7028 290a 0a0a 6465 6620  mestamp()...def 
-0000a7d0: 5f63 6f75 6e74 5f68 6561 6c74 6879 5f6e  _count_healthy_n
-0000a7e0: 6f64 6573 5f66 726f 6d5f 7261 7928 6f75  odes_from_ray(ou
-0000a7f0: 7470 7574 3a20 7374 722c 0a20 2020 2020  tput: str,.     
-0000a800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a810: 2020 2020 2020 2020 2020 2020 2069 735f               is_
-0000a820: 6c6f 6361 6c5f 636c 6f75 643a 2062 6f6f  local_cloud: boo
-0000a830: 6c20 3d20 4661 6c73 650a 2020 2020 2020  l = False.      
-0000a840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a850: 2020 2020 2020 2020 2020 2029 202d 3e20             ) -> 
-0000a860: 5475 706c 655b 696e 742c 2069 6e74 5d3a  Tuple[int, int]:
-0000a870: 0a20 2020 2022 2222 436f 756e 7420 7468  .    """Count th
-0000a880: 6520 6e75 6d62 6572 206f 6620 6865 616c  e number of heal
-0000a890: 7468 7920 6e6f 6465 7320 6672 6f6d 2074  thy nodes from t
-0000a8a0: 6865 206f 7574 7075 7420 6f66 2060 7261  he output of `ra
-0000a8b0: 7920 7374 6174 7573 602e 2222 220a 0a20  y status`.""".. 
-0000a8c0: 2020 2064 6566 2067 6574 5f72 6561 6479     def get_ready
-0000a8d0: 5f6e 6f64 6573 5f63 6f75 6e74 7328 7061  _nodes_counts(pa
-0000a8e0: 7474 6572 6e2c 206f 7574 7075 7429 3a0a  ttern, output):.
-0000a8f0: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
-0000a900: 2070 6174 7465 726e 2e66 696e 6461 6c6c   pattern.findall
-0000a910: 286f 7574 7075 7429 0a20 2020 2020 2020  (output).       
-0000a920: 2069 6620 6e6f 7420 7265 7375 6c74 3a0a   if not result:.
-0000a930: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0000a940: 726e 2030 0a20 2020 2020 2020 2061 7373  rn 0.        ass
-0000a950: 6572 7420 6c65 6e28 7265 7375 6c74 2920  ert len(result) 
-0000a960: 3d3d 2031 2c20 7265 7375 6c74 0a20 2020  == 1, result.   
-0000a970: 2020 2020 2072 6574 7572 6e20 696e 7428       return int(
-0000a980: 7265 7375 6c74 5b30 5d29 0a0a 2020 2020  result[0])..    
-0000a990: 2320 4368 6563 6b20 6966 2074 6865 2072  # Check if the r
-0000a9a0: 6179 2063 6c75 7374 6572 2069 7320 7374  ay cluster is st
-0000a9b0: 6172 7465 6420 7769 7468 2072 6179 2061  arted with ray a
-0000a9c0: 7574 6f73 6361 6c65 722e 2049 6e20 6e65  utoscaler. In ne
-0000a9d0: 770a 2020 2020 2320 7072 6f76 6973 696f  w.    # provisio
-0000a9e0: 6e65 7220 2823 3137 3032 2920 616e 6420  ner (#1702) and 
-0000a9f0: 6c6f 6361 6c20 6d6f 6465 2c20 7765 2073  local mode, we s
-0000aa00: 7461 7274 6564 2074 6865 2072 6179 2063  tarted the ray c
-0000aa10: 6c75 7374 6572 2077 6974 686f 7574 2072  luster without r
-0000aa20: 6179 0a20 2020 2023 2061 7574 6f73 6361  ay.    # autosca
-0000aa30: 6c65 722e 0a20 2020 2023 2049 6620 7261  ler..    # If ra
-0000aa40: 7920 636c 7573 7465 7220 6973 2073 7461  y cluster is sta
-0000aa50: 7274 6564 2077 6974 6820 7261 7920 6175  rted with ray au
-0000aa60: 746f 7363 616c 6572 2c20 7468 6520 6f75  toscaler, the ou
-0000aa70: 7470 7574 2077 696c 6c20 6265 3a0a 2020  tput will be:.  
-0000aa80: 2020 2320 2031 2072 6179 2e68 6561 642e    #  1 ray.head.
-0000aa90: 6465 6661 756c 740a 2020 2020 2320 202e  default.    #  .
-0000aaa0: 2e2e 0a20 2020 2023 2054 4f44 4f28 7a68  ...    # TODO(zh
-0000aab0: 7775 293a 206f 6e63 6520 7765 2064 6570  wu): once we dep
-0000aac0: 7265 6361 7465 2074 6865 206f 6c64 2070  recate the old p
-0000aad0: 726f 7669 7369 6f6e 6572 2c20 7765 2063  rovisioner, we c
-0000aae0: 616e 2072 656d 6f76 6520 7468 6973 0a20  an remove this. 
-0000aaf0: 2020 2023 2063 6865 636b 2e0a 2020 2020     # check..    
-0000ab00: 7261 795f 6175 746f 7363 616c 6572 5f68  ray_autoscaler_h
-0000ab10: 6561 6420 3d20 6765 745f 7265 6164 795f  ead = get_ready_
-0000ab20: 6e6f 6465 735f 636f 756e 7473 285f 4c41  nodes_counts(_LA
-0000ab30: 554e 4348 4544 5f48 4541 445f 5041 5454  UNCHED_HEAD_PATT
-0000ab40: 4552 4e2c 206f 7574 7075 7429 0a20 2020  ERN, output).   
-0000ab50: 2069 735f 6c6f 6361 6c5f 7261 795f 636c   is_local_ray_cl
-0000ab60: 7573 7465 7220 3d20 7261 795f 6175 746f  uster = ray_auto
-0000ab70: 7363 616c 6572 5f68 6561 6420 3d3d 2030  scaler_head == 0
-0000ab80: 0a0a 2020 2020 6966 2069 735f 6c6f 6361  ..    if is_loca
-0000ab90: 6c5f 7261 795f 636c 7573 7465 7220 6f72  l_ray_cluster or
-0000aba0: 2069 735f 6c6f 6361 6c5f 636c 6f75 643a   is_local_cloud:
-0000abb0: 0a20 2020 2020 2020 2023 2052 6179 2063  .        # Ray c
-0000abc0: 6c75 7374 6572 2069 7320 6c61 756e 6368  luster is launch
-0000abd0: 6564 2077 6974 6820 6e65 7720 7072 6f76  ed with new prov
-0000abe0: 6973 696f 6e65 720a 2020 2020 2020 2020  isioner.        
-0000abf0: 2320 466f 7220 6e65 7720 7072 6f76 6973  # For new provis
-0000ac00: 696f 6e65 7220 616e 6420 6c6f 6361 6c20  ioner and local 
-0000ac10: 6d6f 6465 2c20 7468 6520 6f75 7470 7574  mode, the output
-0000ac20: 2077 696c 6c20 6265 3a0a 2020 2020 2020   will be:.      
-0000ac30: 2020 2320 2031 206e 6f64 655f 7878 7878    #  1 node_xxxx
-0000ac40: 0a20 2020 2020 2020 2023 2020 3120 6e6f  .        #  1 no
-0000ac50: 6465 5f78 7878 780a 2020 2020 2020 2020  de_xxxx.        
-0000ac60: 7265 6164 795f 6865 6164 203d 2030 0a20  ready_head = 0. 
-0000ac70: 2020 2020 2020 2072 6561 6479 5f77 6f72         ready_wor
-0000ac80: 6b65 7273 203d 205f 4c41 554e 4348 4544  kers = _LAUNCHED
-0000ac90: 5f4c 4f43 414c 5f57 4f52 4b45 525f 5041  _LOCAL_WORKER_PA
-0000aca0: 5454 4552 4e2e 6669 6e64 616c 6c28 6f75  TTERN.findall(ou
-0000acb0: 7470 7574 290a 2020 2020 2020 2020 7265  tput).        re
-0000acc0: 6164 795f 776f 726b 6572 7320 3d20 6c65  ady_workers = le
-0000acd0: 6e28 7265 6164 795f 776f 726b 6572 7329  n(ready_workers)
-0000ace0: 0a20 2020 2020 2020 2069 6620 6973 5f6c  .        if is_l
-0000acf0: 6f63 616c 5f72 6179 5f63 6c75 7374 6572  ocal_ray_cluster
-0000ad00: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0000ad10: 6164 795f 6865 6164 203d 2031 0a20 2020  ady_head = 1.   
-0000ad20: 2020 2020 2020 2020 2072 6561 6479 5f77           ready_w
-0000ad30: 6f72 6b65 7273 202d 3d20 310a 2020 2020  orkers -= 1.    
-0000ad40: 2020 2020 7265 7475 726e 2072 6561 6479      return ready
-0000ad50: 5f68 6561 642c 2072 6561 6479 5f77 6f72  _head, ready_wor
-0000ad60: 6b65 7273 0a0a 2020 2020 2320 436f 756e  kers..    # Coun
-0000ad70: 7420 6e75 6d62 6572 206f 6620 6e6f 6465  t number of node
-0000ad80: 7320 6279 2070 6172 7369 6e67 2074 6865  s by parsing the
-0000ad90: 206f 7574 7075 7420 6f66 2060 7261 7920   output of `ray 
-0000ada0: 7374 6174 7573 602e 2054 6865 206f 7574  status`. The out
-0000adb0: 7075 740a 2020 2020 2320 6c6f 6f6b 7320  put.    # looks 
-0000adc0: 6c69 6b65 3a0a 2020 2020 2320 2020 3120  like:.    #   1 
-0000add0: 7261 792e 6865 6164 2e64 6566 6175 6c74  ray.head.default
-0000ade0: 0a20 2020 2023 2020 2032 2072 6179 2e77  .    #   2 ray.w
-0000adf0: 6f72 6b65 722e 6465 6661 756c 740a 2020  orker.default.  
-0000ae00: 2020 7265 6164 795f 6865 6164 203d 2072    ready_head = r
-0000ae10: 6179 5f61 7574 6f73 6361 6c65 725f 6865  ay_autoscaler_he
-0000ae20: 6164 0a20 2020 2072 6561 6479 5f77 6f72  ad.    ready_wor
-0000ae30: 6b65 7273 203d 2067 6574 5f72 6561 6479  kers = get_ready
-0000ae40: 5f6e 6f64 6573 5f63 6f75 6e74 7328 5f4c  _nodes_counts(_L
-0000ae50: 4155 4e43 4845 445f 574f 524b 4552 5f50  AUNCHED_WORKER_P
-0000ae60: 4154 5445 524e 2c20 6f75 7470 7574 290a  ATTERN, output).
-0000ae70: 2020 2020 7265 6164 795f 7265 7365 7276      ready_reserv
-0000ae80: 6564 5f77 6f72 6b65 7273 203d 2067 6574  ed_workers = get
-0000ae90: 5f72 6561 6479 5f6e 6f64 6573 5f63 6f75  _ready_nodes_cou
-0000aea0: 6e74 7328 0a20 2020 2020 2020 205f 4c41  nts(.        _LA
-0000aeb0: 554e 4348 4544 5f52 4553 4552 5645 445f  UNCHED_RESERVED_
-0000aec0: 574f 524b 4552 5f50 4154 5445 524e 2c20  WORKER_PATTERN, 
-0000aed0: 6f75 7470 7574 290a 2020 2020 7265 6164  output).    read
-0000aee0: 795f 776f 726b 6572 7320 2b3d 2072 6561  y_workers += rea
-0000aef0: 6479 5f72 6573 6572 7665 645f 776f 726b  dy_reserved_work
-0000af00: 6572 730a 2020 2020 6173 7365 7274 2072  ers.    assert r
-0000af10: 6561 6479 5f68 6561 6420 3c3d 2031 2c20  eady_head <= 1, 
-0000af20: 6627 2368 6561 6420 6e6f 6465 2073 686f  f'#head node sho
-0000af30: 756c 6420 6265 203c 3d31 2028 476f 7420  uld be <=1 (Got 
-0000af40: 7b72 6561 6479 5f68 6561 647d 292e 270a  {ready_head}).'.
-0000af50: 2020 2020 7265 7475 726e 2072 6561 6479      return ready
-0000af60: 5f68 6561 642c 2072 6561 6479 5f77 6f72  _head, ready_wor
-0000af70: 6b65 7273 0a0a 0a64 6566 2067 6574 5f64  kers...def get_d
-0000af80: 6f63 6b65 725f 7573 6572 2869 703a 2073  ocker_user(ip: s
-0000af90: 7472 2c20 636c 7573 7465 725f 636f 6e66  tr, cluster_conf
-0000afa0: 6967 5f66 696c 653a 2073 7472 2920 2d3e  ig_file: str) ->
-0000afb0: 2073 7472 3a0a 2020 2020 2222 2246 696e   str:.    """Fin
-0000afc0: 6420 646f 636b 6572 2063 6f6e 7461 696e  d docker contain
-0000afd0: 6572 2075 7365 726e 616d 652e 2222 220a  er username.""".
-0000afe0: 2020 2020 7373 685f 6372 6564 656e 7469      ssh_credenti
-0000aff0: 616c 7320 3d20 7373 685f 6372 6564 656e  als = ssh_creden
-0000b000: 7469 616c 5f66 726f 6d5f 7961 6d6c 2863  tial_from_yaml(c
-0000b010: 6c75 7374 6572 5f63 6f6e 6669 675f 6669  luster_config_fi
-0000b020: 6c65 290a 2020 2020 7275 6e6e 6572 203d  le).    runner =
-0000b030: 2063 6f6d 6d61 6e64 5f72 756e 6e65 722e   command_runner.
-0000b040: 5353 4843 6f6d 6d61 6e64 5275 6e6e 6572  SSHCommandRunner
-0000b050: 2869 702c 2070 6f72 743d 3232 2c20 2a2a  (ip, port=22, **
-0000b060: 7373 685f 6372 6564 656e 7469 616c 7329  ssh_credentials)
-0000b070: 0a20 2020 2063 6f6e 7461 696e 6572 5f6e  .    container_n
-0000b080: 616d 6520 3d20 636f 6e73 7461 6e74 732e  ame = constants.
-0000b090: 4445 4641 554c 545f 444f 434b 4552 5f43  DEFAULT_DOCKER_C
-0000b0a0: 4f4e 5441 494e 4552 5f4e 414d 450a 2020  ONTAINER_NAME.  
-0000b0b0: 2020 7768 6f61 6d69 5f72 6574 7572 6e63    whoami_returnc
-0000b0c0: 6f64 652c 2077 686f 616d 695f 7374 646f  ode, whoami_stdo
-0000b0d0: 7574 2c20 7768 6f61 6d69 5f73 7464 6572  ut, whoami_stder
-0000b0e0: 7220 3d20 7275 6e6e 6572 2e72 756e 280a  r = runner.run(.
-0000b0f0: 2020 2020 2020 2020 6627 7375 646f 2064          f'sudo d
-0000b100: 6f63 6b65 7220 6578 6563 207b 636f 6e74  ocker exec {cont
-0000b110: 6169 6e65 725f 6e61 6d65 7d20 7768 6f61  ainer_name} whoa
-0000b120: 6d69 272c 0a20 2020 2020 2020 2073 7472  mi',.        str
-0000b130: 6561 6d5f 6c6f 6773 3d46 616c 7365 2c0a  eam_logs=False,.
-0000b140: 2020 2020 2020 2020 7265 7175 6972 655f          require_
-0000b150: 6f75 7470 7574 733d 5472 7565 290a 2020  outputs=True).  
-0000b160: 2020 6173 7365 7274 2077 686f 616d 695f    assert whoami_
-0000b170: 7265 7475 726e 636f 6465 203d 3d20 302c  returncode == 0,
-0000b180: 2028 0a20 2020 2020 2020 2066 2746 6169   (.        f'Fai
-0000b190: 6c65 6420 746f 2067 6574 2064 6f63 6b65  led to get docke
-0000b1a0: 7220 636f 6e74 6169 6e65 7220 7573 6572  r container user
-0000b1b0: 2e20 5265 7475 726e 2027 0a20 2020 2020  . Return '.     
-0000b1c0: 2020 2066 2763 6f64 653a 207b 7768 6f61     f'code: {whoa
-0000b1d0: 6d69 5f72 6574 7572 6e63 6f64 657d 2c20  mi_returncode}, 
-0000b1e0: 4572 726f 723a 207b 7768 6f61 6d69 5f73  Error: {whoami_s
-0000b1f0: 7464 6572 727d 2729 0a20 2020 2064 6f63  tderr}').    doc
-0000b200: 6b65 725f 7573 6572 203d 2077 686f 616d  ker_user = whoam
-0000b210: 695f 7374 646f 7574 2e73 7472 6970 2829  i_stdout.strip()
-0000b220: 0a20 2020 206c 6f67 6765 722e 6465 6275  .    logger.debu
-0000b230: 6728 6627 446f 636b 6572 2063 6f6e 7461  g(f'Docker conta
-0000b240: 696e 6572 2075 7365 723a 207b 646f 636b  iner user: {dock
-0000b250: 6572 5f75 7365 727d 2729 0a20 2020 2072  er_user}').    r
-0000b260: 6574 7572 6e20 646f 636b 6572 5f75 7365  eturn docker_use
-0000b270: 720a 0a0a 4074 696d 656c 696e 652e 6576  r...@timeline.ev
-0000b280: 656e 740a 6465 6620 7761 6974 5f75 6e74  ent.def wait_unt
-0000b290: 696c 5f72 6179 5f63 6c75 7374 6572 5f72  il_ray_cluster_r
-0000b2a0: 6561 6479 280a 2020 2020 636c 7573 7465  eady(.    cluste
-0000b2b0: 725f 636f 6e66 6967 5f66 696c 653a 2073  r_config_file: s
-0000b2c0: 7472 2c0a 2020 2020 6e75 6d5f 6e6f 6465  tr,.    num_node
-0000b2d0: 733a 2069 6e74 2c0a 2020 2020 6c6f 675f  s: int,.    log_
-0000b2e0: 7061 7468 3a20 7374 722c 0a20 2020 2069  path: str,.    i
-0000b2f0: 735f 6c6f 6361 6c5f 636c 6f75 643a 2062  s_local_cloud: b
-0000b300: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
-0000b310: 206e 6f64 6573 5f6c 6175 6e63 6869 6e67   nodes_launching
-0000b320: 5f70 726f 6772 6573 735f 7469 6d65 6f75  _progress_timeou
-0000b330: 743a 204f 7074 696f 6e61 6c5b 696e 745d  t: Optional[int]
-0000b340: 203d 204e 6f6e 652c 0a29 202d 3e20 5475   = None,.) -> Tu
-0000b350: 706c 655b 626f 6f6c 2c20 4f70 7469 6f6e  ple[bool, Option
-0000b360: 616c 5b73 7472 5d5d 3a0a 2020 2020 2222  al[str]]:.    ""
-0000b370: 2257 6169 7420 756e 7469 6c20 7468 6520  "Wait until the 
-0000b380: 7261 7920 636c 7573 7465 7220 6973 2073  ray cluster is s
-0000b390: 6574 2075 7020 6f6e 2056 4d73 206f 7220  et up on VMs or 
-0000b3a0: 696e 2063 6f6e 7461 696e 6572 732e 0a0a  in containers...
-0000b3b0: 2020 2020 5265 7475 726e 733a 2020 7768      Returns:  wh
-0000b3c0: 6574 6865 7220 7468 6520 656e 7469 7265  ether the entire
-0000b3d0: 2072 6179 2063 6c75 7374 6572 2069 7320   ray cluster is 
-0000b3e0: 7265 6164 792c 2061 6e64 2064 6f63 6b65  ready, and docke
-0000b3f0: 7220 7573 6572 6e61 6d65 0a20 2020 2069  r username.    i
-0000b400: 6620 6c61 756e 6368 6564 2077 6974 6820  f launched with 
-0000b410: 646f 636b 6572 2e0a 2020 2020 2222 220a  docker..    """.
-0000b420: 2020 2020 2320 4d61 6e75 616c 6c79 2066      # Manually f
-0000b430: 6574 6368 696e 6720 6865 6164 2069 7020  etching head ip 
-0000b440: 696e 7374 6561 6420 6f66 2075 7369 6e67  instead of using
-0000b450: 2060 7261 7920 6578 6563 6020 746f 2061   `ray exec` to a
-0000b460: 766f 6964 2074 6865 2062 7567 0a20 2020  void the bug.   
-0000b470: 2023 2074 6861 7420 6072 6179 2065 7865   # that `ray exe
-0000b480: 6360 2066 6169 6c73 2074 6f20 636f 6e6e  c` fails to conn
-0000b490: 6563 7420 746f 2074 6865 2068 6561 6420  ect to the head 
-0000b4a0: 6e6f 6465 2061 6674 6572 2073 6f6d 6520  node after some 
-0000b4b0: 776f 726b 6572 730a 2020 2020 2320 6c61  workers.    # la
-0000b4c0: 756e 6368 6564 2065 7370 6563 6961 6c6c  unched especiall
-0000b4d0: 7920 666f 7220 417a 7572 652e 0a20 2020  y for Azure..   
-0000b4e0: 2074 7279 3a0a 2020 2020 2020 2020 6865   try:.        he
-0000b4f0: 6164 5f69 7020 3d20 5f71 7565 7279 5f68  ad_ip = _query_h
-0000b500: 6561 645f 6970 5f77 6974 685f 7265 7472  ead_ip_with_retr
-0000b510: 6965 7328 0a20 2020 2020 2020 2020 2020  ies(.           
-0000b520: 2063 6c75 7374 6572 5f63 6f6e 6669 675f   cluster_config_
-0000b530: 6669 6c65 2c20 6d61 785f 6174 7465 6d70  file, max_attemp
-0000b540: 7473 3d57 4149 545f 4845 4144 5f4e 4f44  ts=WAIT_HEAD_NOD
-0000b550: 455f 4950 5f4d 4158 5f41 5454 454d 5054  E_IP_MAX_ATTEMPT
-0000b560: 5329 0a20 2020 2065 7863 6570 7420 6578  S).    except ex
-0000b570: 6365 7074 696f 6e73 2e46 6574 6368 4950  ceptions.FetchIP
-0000b580: 4572 726f 7220 6173 2065 3a0a 2020 2020  Error as e:.    
-0000b590: 2020 2020 6c6f 6767 6572 2e65 7272 6f72      logger.error
-0000b5a0: 2863 6f6d 6d6f 6e5f 7574 696c 732e 666f  (common_utils.fo
-0000b5b0: 726d 6174 5f65 7863 6570 7469 6f6e 2865  rmat_exception(e
-0000b5c0: 2929 0a20 2020 2020 2020 2072 6574 7572  )).        retur
-0000b5d0: 6e20 4661 6c73 652c 204e 6f6e 6520 2023  n False, None  #
-0000b5e0: 2066 6169 6c65 640a 0a20 2020 2063 6f6e   failed..    con
-0000b5f0: 6669 6720 3d20 636f 6d6d 6f6e 5f75 7469  fig = common_uti
-0000b600: 6c73 2e72 6561 645f 7961 6d6c 2863 6c75  ls.read_yaml(clu
-0000b610: 7374 6572 5f63 6f6e 6669 675f 6669 6c65  ster_config_file
-0000b620: 290a 0a20 2020 2064 6f63 6b65 725f 7573  )..    docker_us
-0000b630: 6572 203d 204e 6f6e 650a 2020 2020 6966  er = None.    if
-0000b640: 2027 646f 636b 6572 2720 696e 2063 6f6e   'docker' in con
-0000b650: 6669 673a 0a20 2020 2020 2020 2064 6f63  fig:.        doc
-0000b660: 6b65 725f 7573 6572 203d 2067 6574 5f64  ker_user = get_d
-0000b670: 6f63 6b65 725f 7573 6572 2868 6561 645f  ocker_user(head_
-0000b680: 6970 2c20 636c 7573 7465 725f 636f 6e66  ip, cluster_conf
-0000b690: 6967 5f66 696c 6529 0a0a 2020 2020 6966  ig_file)..    if
-0000b6a0: 206e 756d 5f6e 6f64 6573 203c 3d20 313a   num_nodes <= 1:
-0000b6b0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000b6c0: 5472 7565 2c20 646f 636b 6572 5f75 7365  True, docker_use
-0000b6d0: 720a 0a20 2020 2073 7368 5f63 7265 6465  r..    ssh_crede
-0000b6e0: 6e74 6961 6c73 203d 2073 7368 5f63 7265  ntials = ssh_cre
-0000b6f0: 6465 6e74 6961 6c5f 6672 6f6d 5f79 616d  dential_from_yam
-0000b700: 6c28 636c 7573 7465 725f 636f 6e66 6967  l(cluster_config
-0000b710: 5f66 696c 652c 2064 6f63 6b65 725f 7573  _file, docker_us
-0000b720: 6572 290a 2020 2020 6c61 7374 5f6e 6f64  er).    last_nod
-0000b730: 6573 5f73 6f5f 6661 7220 3d20 300a 2020  es_so_far = 0.  
-0000b740: 2020 7374 6172 7420 3d20 7469 6d65 2e74    start = time.t
-0000b750: 696d 6528 290a 2020 2020 7275 6e6e 6572  ime().    runner
-0000b760: 203d 2063 6f6d 6d61 6e64 5f72 756e 6e65   = command_runne
-0000b770: 722e 5353 4843 6f6d 6d61 6e64 5275 6e6e  r.SSHCommandRunn
-0000b780: 6572 2868 6561 645f 6970 2c0a 2020 2020  er(head_ip,.    
-0000b790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b7b0: 2020 2020 2020 2020 2070 6f72 743d 3232           port=22
-0000b7c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000b7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b7e0: 2020 2020 2020 2020 2020 2020 2020 202a                 *
+00006170: 2020 2320 5374 6f70 2069 6620 7765 2072    # Stop if we r
+00006180: 6561 6368 2061 6e20 656d 7074 7920 6c69  each an empty li
+00006190: 6e65 2c20 7768 6963 6820 6d65 616e 7320  ne, which means 
+000061a0: 6120 6e65 7720 686f 7374 0a20 2020 2020  a new host.     
+000061b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000061c0: 2020 2069 6620 6e6f 7420 636f 6e66 6967     if not config
+000061d0: 5b69 6478 5d2e 7374 7269 7028 293a 0a20  [idx].strip():. 
+000061e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000061f0: 2020 2020 2020 2020 2020 2062 7265 616b             break
+00006200: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006210: 2020 2020 2020 2020 2069 6620 636f 6e66           if conf
+00006220: 6967 5b69 6478 5d2e 7374 7269 7028 292e  ig[idx].strip().
+00006230: 7374 6172 7473 7769 7468 2827 5072 6f78  startswith('Prox
+00006240: 7943 6f6d 6d61 6e64 2729 3a0a 2020 2020  yCommand'):.    
+00006250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006260: 2020 2020 2020 2020 7072 6f78 795f 636f          proxy_co
+00006270: 6d6d 616e 645f 6c69 6e65 203d 2063 6f6e  mmand_line = con
+00006280: 6669 675b 6964 785d 2e73 7472 6970 2829  fig[idx].strip()
+00006290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000062a0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000062b0: 7072 6f78 795f 636f 6d6d 616e 645f 6c69  proxy_command_li
+000062c0: 6e65 2e65 6e64 7377 6974 6828 6627 407b  ne.endswith(f'@{
+000062d0: 6970 7d27 293a 0a20 2020 2020 2020 2020  ip}'):.         
+000062e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000062f0: 2020 2020 2020 2066 6f75 6e64 203d 2054         found = T
+00006300: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
+00006310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006320: 2020 2020 6272 6561 6b0a 2020 2020 2020      break.      
+00006330: 2020 2020 2020 6966 2066 6f75 6e64 3a0a        if found:.
+00006340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006350: 7374 6172 745f 6c69 6e65 5f69 6478 203d  start_line_idx =
+00006360: 2069 202d 2031 0a20 2020 2020 2020 2020   i - 1.         
+00006370: 2020 2020 2020 2062 7265 616b 0a0a 2020         break..  
+00006380: 2020 2020 2020 6966 2073 7461 7274 5f6c        if start_l
+00006390: 696e 655f 6964 7820 6973 206e 6f74 204e  ine_idx is not N
+000063a0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+000063b0: 2023 2053 6361 6e20 666f 7220 656e 6420   # Scan for end 
+000063c0: 6f66 2070 7265 7669 6f75 7320 636f 6e66  of previous conf
+000063d0: 6967 2e0a 2020 2020 2020 2020 2020 2020  ig..            
+000063e0: 6375 7273 6f72 203d 2073 7461 7274 5f6c  cursor = start_l
+000063f0: 696e 655f 6964 780a 2020 2020 2020 2020  ine_idx.        
+00006400: 2020 2020 7768 696c 6520 6375 7273 6f72      while cursor
+00006410: 203e 2030 2061 6e64 206c 656e 2863 6f6e   > 0 and len(con
+00006420: 6669 675b 6375 7273 6f72 5d2e 7374 7269  fig[cursor].stri
+00006430: 7028 2929 203e 2030 3a0a 2020 2020 2020  p()) > 0:.      
+00006440: 2020 2020 2020 2020 2020 6375 7273 6f72            cursor
+00006450: 202d 3d20 310a 2020 2020 2020 2020 2020   -= 1.          
+00006460: 2020 7072 6576 5f65 6e64 5f6c 696e 655f    prev_end_line_
+00006470: 6964 7820 3d20 6375 7273 6f72 0a0a 2020  idx = cursor..  
+00006480: 2020 2020 2020 2020 2020 2320 5363 616e            # Scan
+00006490: 2066 6f72 2065 6e64 206f 6620 7468 6520   for end of the 
+000064a0: 636c 7573 7465 7220 636f 6e66 6967 2e0a  cluster config..
+000064b0: 2020 2020 2020 2020 2020 2020 656e 645f              end_
+000064c0: 6c69 6e65 5f69 6478 203d 204e 6f6e 650a  line_idx = None.
+000064d0: 2020 2020 2020 2020 2020 2020 6375 7273              curs
+000064e0: 6f72 203d 2073 7461 7274 5f6c 696e 655f  or = start_line_
+000064f0: 6964 7820 2b20 310a 2020 2020 2020 2020  idx + 1.        
+00006500: 2020 2020 7374 6172 745f 6c69 6e65 5f69      start_line_i
+00006510: 6478 202d 3d20 3120 2023 2072 656d 6f76  dx -= 1  # remov
+00006520: 6520 6175 746f 2d67 656e 6572 6174 6564  e auto-generated
+00006530: 2063 6f6d 6d65 6e74 0a20 2020 2020 2020   comment.       
+00006540: 2020 2020 2077 6869 6c65 2063 7572 736f       while curso
+00006550: 7220 3c20 6c65 6e28 636f 6e66 6967 293a  r < len(config):
+00006560: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006570: 2069 6620 636f 6e66 6967 5b63 7572 736f   if config[curso
+00006580: 725d 2e73 7472 6970 2829 2e73 7461 7274  r].strip().start
+00006590: 7377 6974 6828 0a20 2020 2020 2020 2020  swith(.         
+000065a0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+000065b0: 2320 2729 206f 7220 636f 6e66 6967 5b63  # ') or config[c
+000065c0: 7572 736f 725d 2e73 7472 6970 2829 2e73  ursor].strip().s
+000065d0: 7461 7274 7377 6974 6828 2748 6f73 7420  tartswith('Host 
+000065e0: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
+000065f0: 2020 2020 2020 2020 656e 645f 6c69 6e65          end_line
+00006600: 5f69 6478 203d 2063 7572 736f 720a 2020  _idx = cursor.  
+00006610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006620: 2020 6272 6561 6b0a 2020 2020 2020 2020    break.        
+00006630: 2020 2020 2020 2020 6375 7273 6f72 202b          cursor +
+00006640: 3d20 310a 0a20 2020 2020 2020 2020 2020  = 1..           
+00006650: 2023 2052 656d 6f76 6520 736b 792d 6765   # Remove sky-ge
+00006660: 6e65 7261 7465 6420 636f 6e66 6967 2061  nerated config a
+00006670: 6e64 2075 7064 6174 6520 7468 6520 6669  nd update the fi
+00006680: 6c65 2e0a 2020 2020 2020 2020 2020 2020  le..            
+00006690: 636f 6e66 6967 5b70 7265 765f 656e 645f  config[prev_end_
+000066a0: 6c69 6e65 5f69 6478 3a65 6e64 5f6c 696e  line_idx:end_lin
+000066b0: 655f 6964 785d 203d 205b 0a20 2020 2020  e_idx] = [.     
+000066c0: 2020 2020 2020 2020 2020 2027 5c6e 270a             '\n'.
+000066d0: 2020 2020 2020 2020 2020 2020 5d20 6966              ] if
+000066e0: 2065 6e64 5f6c 696e 655f 6964 7820 6973   end_line_idx is
+000066f0: 206e 6f74 204e 6f6e 6520 656c 7365 205b   not None else [
+00006700: 5d0a 2020 2020 2020 2020 2020 2020 7769  ].            wi
+00006710: 7468 206f 7065 6e28 636f 6e66 6967 5f70  th open(config_p
+00006720: 6174 682c 2027 7727 2c20 656e 636f 6469  ath, 'w', encodi
+00006730: 6e67 3d27 7574 662d 3827 2920 6173 2066  ng='utf-8') as f
+00006740: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00006750: 2020 662e 7772 6974 6528 2727 2e6a 6f69    f.write(''.joi
+00006760: 6e28 636f 6e66 6967 292e 7374 7269 7028  n(config).strip(
+00006770: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+00006780: 2020 2066 2e77 7269 7465 2827 5c6e 2720     f.write('\n' 
+00006790: 2a20 3229 0a0a 2020 2020 2020 2020 2320  * 2)..        # 
+000067a0: 4465 6c65 7465 2069 6e63 6c75 6465 2073  Delete include s
+000067b0: 7461 7465 6d65 6e74 2069 6620 6974 2065  tatement if it e
+000067c0: 7869 7374 7320 696e 2074 6865 2063 6f6e  xists in the con
+000067d0: 6669 672e 0a20 2020 2020 2020 2073 6b79  fig..        sky
+000067e0: 5f61 7574 6f67 656e 5f63 6f6d 6d65 6e74  _autogen_comment
+000067f0: 203d 2028 2723 2041 6464 6564 2062 7920   = ('# Added by 
+00006800: 736b 7920 2875 7365 2060 736b 7920 7374  sky (use `sky st
+00006810: 6f70 2f64 6f77 6e20 270a 2020 2020 2020  op/down '.      
+00006820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006830: 2020 2020 2020 2020 2066 277b 636c 7573           f'{clus
+00006840: 7465 725f 6e61 6d65 7d60 2074 6f20 7265  ter_name}` to re
+00006850: 6d6f 7665 2927 290a 2020 2020 2020 2020  move)').        
+00006860: 7769 7468 206f 7065 6e28 636f 6e66 6967  with open(config
+00006870: 5f70 6174 682c 2027 7227 2c20 656e 636f  _path, 'r', enco
+00006880: 6469 6e67 3d27 7574 662d 3827 2920 6173  ding='utf-8') as
+00006890: 2066 3a0a 2020 2020 2020 2020 2020 2020   f:.            
+000068a0: 636f 6e66 6967 203d 2066 2e72 6561 646c  config = f.readl
+000068b0: 696e 6573 2829 0a0a 2020 2020 2020 2020  ines()..        
+000068c0: 666f 7220 692c 206c 696e 6520 696e 2065  for i, line in e
+000068d0: 6e75 6d65 7261 7465 2863 6f6e 6669 6729  numerate(config)
+000068e0: 3a0a 2020 2020 2020 2020 2020 2020 636f  :.            co
+000068f0: 6e66 6967 5f73 7472 203d 206c 696e 652e  nfig_str = line.
+00006900: 7374 7269 7028 290a 2020 2020 2020 2020  strip().        
+00006910: 2020 2020 6966 2066 2749 6e63 6c75 6465      if f'Include
+00006920: 207b 636c 7573 7465 725f 636f 6e66 6967   {cluster_config
+00006930: 5f70 6174 687d 2720 696e 2063 6f6e 6669  _path}' in confi
+00006940: 675f 7374 723a 0a20 2020 2020 2020 2020  g_str:.         
+00006950: 2020 2020 2020 2077 6974 6820 6f70 656e         with open
+00006960: 2863 6f6e 6669 675f 7061 7468 2c20 2777  (config_path, 'w
+00006970: 272c 2065 6e63 6f64 696e 673d 2775 7466  ', encoding='utf
+00006980: 2d38 2729 2061 7320 663a 0a20 2020 2020  -8') as f:.     
+00006990: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000069a0: 6620 6920 3c20 6c65 6e28 636f 6e66 6967  f i < len(config
+000069b0: 2920 2d20 3120 616e 6420 636f 6e66 6967  ) - 1 and config
+000069c0: 5b69 202b 2031 5d20 3d3d 2027 5c6e 273a  [i + 1] == '\n':
+000069d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000069e0: 2020 2020 2020 2020 2064 656c 2063 6f6e           del con
+000069f0: 6669 675b 6920 2b20 315d 0a20 2020 2020  fig[i + 1].     
+00006a00: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00006a10: 2044 656c 6574 6520 496e 636c 7564 6520   Delete Include 
+00006a20: 7374 7269 6e67 0a20 2020 2020 2020 2020  string.         
+00006a30: 2020 2020 2020 2020 2020 2064 656c 2063             del c
+00006a40: 6f6e 6669 675b 695d 0a20 2020 2020 2020  onfig[i].       
+00006a50: 2020 2020 2020 2020 2020 2020 2023 2044               # D
+00006a60: 656c 6574 6520 536b 7920 4175 746f 6765  elete Sky Autoge
+00006a70: 6e20 436f 6d6d 656e 740a 2020 2020 2020  n Comment.      
+00006a80: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00006a90: 2069 203e 2030 2061 6e64 2073 6b79 5f61   i > 0 and sky_a
+00006aa0: 7574 6f67 656e 5f63 6f6d 6d65 6e74 2069  utogen_comment i
+00006ab0: 6e20 636f 6e66 6967 5b69 202d 2031 5d2e  n config[i - 1].
+00006ac0: 7374 7269 7028 293a 0a20 2020 2020 2020  strip():.       
+00006ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006ae0: 2064 656c 2063 6f6e 6669 675b 6920 2d20   del config[i - 
+00006af0: 315d 0a20 2020 2020 2020 2020 2020 2020  1].             
+00006b00: 2020 2020 2020 2066 2e77 7269 7465 2827         f.write('
+00006b10: 272e 6a6f 696e 2863 6f6e 6669 6729 290a  '.join(config)).
+00006b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006b30: 6272 6561 6b0a 2020 2020 2020 2020 2020  break.          
+00006b40: 2020 6966 2027 486f 7374 2720 696e 2063    if 'Host' in c
+00006b50: 6f6e 6669 675f 7374 723a 0a20 2020 2020  onfig_str:.     
+00006b60: 2020 2020 2020 2020 2020 2062 7265 616b             break
+00006b70: 0a0a 2020 2020 4063 6c61 7373 6d65 7468  ..    @classmeth
+00006b80: 6f64 0a20 2020 2023 2054 4f44 4f3a 2057  od.    # TODO: W
+00006b90: 6520 6361 6e20 7265 6d6f 7665 2074 6869  e can remove thi
+00006ba0: 7320 6166 7465 7220 302e 362e 3020 616e  s after 0.6.0 an
+00006bb0: 6420 6861 7665 2061 206c 6f63 6b20 6f6e  d have a lock on
+00006bc0: 6c79 2070 6572 2063 6c75 7374 6572 2e0a  ly per cluster..
+00006bd0: 2020 2020 4074 696d 656c 696e 652e 4669      @timeline.Fi
+00006be0: 6c65 4c6f 636b 4576 656e 7428 7373 685f  leLockEvent(ssh_
+00006bf0: 636f 6e66 5f6c 6f63 6b5f 7061 7468 290a  conf_lock_path).
+00006c00: 2020 2020 6465 6620 7265 6d6f 7665 5f63      def remove_c
+00006c10: 6c75 7374 6572 280a 2020 2020 2020 2020  luster(.        
+00006c20: 636c 732c 0a20 2020 2020 2020 2063 6c75  cls,.        clu
+00006c30: 7374 6572 5f6e 616d 653a 2073 7472 2c0a  ster_name: str,.
+00006c40: 2020 2020 2020 2020 6970 3a20 7374 722c          ip: str,
+00006c50: 0a20 2020 2020 2020 2061 7574 685f 636f  .        auth_co
+00006c60: 6e66 6967 3a20 4469 6374 5b73 7472 2c20  nfig: Dict[str, 
+00006c70: 7374 725d 2c0a 2020 2020 2020 2020 646f  str],.        do
+00006c80: 636b 6572 5f75 7365 723a 204f 7074 696f  cker_user: Optio
+00006c90: 6e61 6c5b 7374 725d 203d 204e 6f6e 652c  nal[str] = None,
+00006ca0: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
+00006cb0: 2222 2252 656d 6f76 6520 6175 7468 656e  """Remove authen
+00006cc0: 7469 6361 7469 6f6e 2069 6e66 6f72 6d61  tication informa
+00006cd0: 7469 6f6e 2066 6f72 2063 6c75 7374 6572  tion for cluster
+00006ce0: 2066 726f 6d20 7e2f 2e73 6b79 2f73 7368   from ~/.sky/ssh
+00006cf0: 2f3c 636c 7573 7465 725f 6e61 6d65 3e2e  /<cluster_name>.
+00006d00: 0a0a 2020 2020 2020 2020 466f 7220 6261  ..        For ba
+00006d10: 636b 7761 7264 2063 6f6d 7061 7469 6269  ckward compatibi
+00006d20: 6c69 7479 2061 6c73 6f20 7265 6d6f 7665  lity also remove
+00006d30: 2074 6865 2063 6f6e 6669 6720 6672 6f6d   the config from
+00006d40: 207e 2f2e 7373 682f 636f 6e66 6967 2069   ~/.ssh/config i
+00006d50: 6620 6974 2065 7869 7374 732e 0a0a 2020  f it exists...  
+00006d60: 2020 2020 2020 4966 206e 6f20 6578 6973        If no exis
+00006d70: 7469 6e67 2068 6f73 7420 6d61 7463 6869  ting host matchi
+00006d80: 6e67 2074 6865 2070 726f 7669 6465 6420  ng the provided 
+00006d90: 7370 6563 6966 6963 6174 696f 6e20 6973  specification is
+00006da0: 2066 6f75 6e64 2c20 7468 656e 0a20 2020   found, then.   
+00006db0: 2020 2020 206e 6f74 6869 6e67 2069 7320       nothing is 
+00006dc0: 7265 6d6f 7665 642e 0a0a 2020 2020 2020  removed...      
+00006dd0: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+00006de0: 2020 2020 6970 3a20 4865 6164 206e 6f64      ip: Head nod
+00006df0: 6527 7320 4950 2061 6464 7265 7373 2e0a  e's IP address..
+00006e00: 2020 2020 2020 2020 2020 2020 6175 7468              auth
+00006e10: 5f63 6f6e 6669 673a 2072 6561 645f 7961  _config: read_ya
+00006e20: 6d6c 2868 616e 646c 652e 636c 7573 7465  ml(handle.cluste
+00006e30: 725f 7961 6d6c 295b 2761 7574 6827 5d0a  r_yaml)['auth'].
+00006e40: 2020 2020 2020 2020 2020 2020 646f 636b              dock
+00006e50: 6572 5f75 7365 723a 2049 6620 6e6f 7420  er_user: If not 
+00006e60: 4e6f 6e65 2c20 7573 6520 7468 6973 2075  None, use this u
+00006e70: 7365 7220 746f 2073 7368 2069 6e74 6f20  ser to ssh into 
+00006e80: 7468 6520 646f 636b 6572 0a20 2020 2020  the docker.     
+00006e90: 2020 2022 2222 0a20 2020 2020 2020 2063     """.        c
+00006ea0: 6c75 7374 6572 5f63 6f6e 6669 675f 7061  luster_config_pa
+00006eb0: 7468 203d 206f 732e 7061 7468 2e65 7870  th = os.path.exp
+00006ec0: 616e 6475 7365 7228 0a20 2020 2020 2020  anduser(.       
+00006ed0: 2020 2020 2063 6c73 2e73 7368 5f63 6c75       cls.ssh_clu
+00006ee0: 7374 6572 5f70 6174 682e 666f 726d 6174  ster_path.format
+00006ef0: 2863 6c75 7374 6572 5f6e 616d 6529 290a  (cluster_name)).
+00006f00: 2020 2020 2020 2020 636f 6d6d 6f6e 5f75          common_u
+00006f10: 7469 6c73 2e72 656d 6f76 655f 6669 6c65  tils.remove_file
+00006f20: 5f69 665f 6578 6973 7473 2863 6c75 7374  _if_exists(clust
+00006f30: 6572 5f63 6f6e 6669 675f 7061 7468 290a  er_config_path).
+00006f40: 0a20 2020 2020 2020 2023 2045 6e73 7572  .        # Ensur
+00006f50: 6573 2062 6163 6b77 6172 6420 636f 6d70  es backward comp
+00006f60: 6174 6962 696c 6974 793a 2062 6566 6f72  atibility: befor
+00006f70: 6520 2332 3730 362c 2077 6520 7772 6f74  e #2706, we wrot
+00006f80: 6520 7468 6520 636f 6e66 6967 206f 6620  e the config of 
+00006f90: 536b 7950 696c 6f74 2063 6c75 7374 6572  SkyPilot cluster
+00006fa0: 730a 2020 2020 2020 2020 2320 6469 7265  s.        # dire
+00006fb0: 6374 6c79 2069 6e20 7e2f 2e73 7368 2f63  ctly in ~/.ssh/c
+00006fc0: 6f6e 6669 672e 2046 6f72 2074 6865 7365  onfig. For these
+00006fd0: 2063 6c75 7374 6572 732c 2077 6520 7368   clusters, we sh
+00006fe0: 6f75 6c64 2063 6c65 616e 2075 7020 7468  ould clean up th
+00006ff0: 6520 636f 6e66 6967 2e0a 2020 2020 2020  e config..      
+00007000: 2020 2320 544f 444f 3a20 5265 6d6f 7665    # TODO: Remove
+00007010: 2074 6869 7320 6166 7465 7220 302e 362e   this after 0.6.
+00007020: 300a 2020 2020 2020 2020 636c 732e 5f72  0.        cls._r
+00007030: 656d 6f76 655f 7374 616c 655f 636c 7573  emove_stale_clus
+00007040: 7465 725f 636f 6e66 6967 5f66 6f72 5f62  ter_config_for_b
+00007050: 6163 6b77 6172 645f 636f 6d70 6174 6962  ackward_compatib
+00007060: 696c 6974 7928 0a20 2020 2020 2020 2020  ility(.         
+00007070: 2020 2063 6c75 7374 6572 5f6e 616d 652c     cluster_name,
+00007080: 2069 702c 2061 7574 685f 636f 6e66 6967   ip, auth_config
+00007090: 2c20 646f 636b 6572 5f75 7365 7229 0a0a  , docker_user)..
+000070a0: 0a64 6566 205f 7265 706c 6163 655f 7961  .def _replace_ya
+000070b0: 6d6c 5f64 6963 7473 280a 2020 2020 2020  ml_dicts(.      
+000070c0: 2020 6e65 775f 7961 6d6c 3a20 7374 722c    new_yaml: str,
+000070d0: 206f 6c64 5f79 616d 6c3a 2073 7472 2c20   old_yaml: str, 
+000070e0: 7265 7374 6f72 655f 6b65 795f 6e61 6d65  restore_key_name
+000070f0: 733a 2053 6574 5b73 7472 5d2c 0a20 2020  s: Set[str],.   
+00007100: 2020 2020 2072 6573 746f 7265 5f6b 6579       restore_key
+00007110: 5f6e 616d 6573 5f65 7863 6570 7469 6f6e  _names_exception
+00007120: 733a 2053 6571 7565 6e63 655b 5475 706c  s: Sequence[Tupl
+00007130: 655b 7374 722c 202e 2e2e 5d5d 2920 2d3e  e[str, ...]]) ->
+00007140: 2073 7472 3a0a 2020 2020 2222 2252 6570   str:.    """Rep
+00007150: 6c61 6365 7320 276e 6577 2720 7769 7468  laces 'new' with
+00007160: 2027 6f6c 6427 2066 6f72 2061 6c6c 206b   'old' for all k
+00007170: 6579 7320 696e 2072 6573 746f 7265 5f6b  eys in restore_k
+00007180: 6579 5f6e 616d 6573 2e0a 0a20 2020 2054  ey_names...    T
+00007190: 6865 2072 6570 6c61 6365 6d65 6e74 2077  he replacement w
+000071a0: 696c 6c20 6265 2061 7070 6c69 6564 2072  ill be applied r
+000071b0: 6563 7572 7369 7665 6c79 2061 6e64 206f  ecursively and o
+000071c0: 6e6c 7920 666f 7220 7468 6520 626c 6f63  nly for the bloc
+000071d0: 6b73 0a20 2020 2077 6974 6820 7468 6520  ks.    with the 
+000071e0: 6b65 7920 696e 206b 6579 5f6e 616d 6573  key in key_names
+000071f0: 2c20 616e 6420 6861 7665 2074 6865 2073  , and have the s
+00007200: 616d 6520 616e 6365 7374 6f72 7320 696e  ame ancestors in
+00007210: 2062 6f74 6820 276e 6577 270a 2020 2020   both 'new'.    
+00007220: 616e 6420 276f 6c64 2720 5941 4d4c 2074  and 'old' YAML t
+00007230: 7265 652e 0a0a 2020 2020 5468 6520 7265  ree...    The re
+00007240: 7374 6f72 655f 6b65 795f 6e61 6d65 735f  store_key_names_
+00007250: 6578 6365 7074 696f 6e73 2069 7320 6120  exceptions is a 
+00007260: 6c69 7374 206f 6620 6b65 7920 6e61 6d65  list of key name
+00007270: 7320 7468 6174 2073 686f 756c 6420 6e6f  s that should no
+00007280: 740a 2020 2020 6265 2072 6573 746f 7265  t.    be restore
+00007290: 642c 2069 2e65 2e20 7468 6f73 6520 6b65  d, i.e. those ke
+000072a0: 7973 2077 696c 6c20 6265 2072 6573 6574  ys will be reset
+000072b0: 2074 6f20 7468 6520 7661 6c75 6520 696e   to the value in
+000072c0: 2027 6e65 7727 2059 414d 4c0a 2020 2020   'new' YAML.    
+000072d0: 7472 6565 2061 6674 6572 2074 6865 2072  tree after the r
+000072e0: 6570 6c61 6365 6d65 6e74 2e0a 2020 2020  eplacement..    
+000072f0: 2222 220a 0a20 2020 2064 6566 205f 7265  """..    def _re
+00007300: 7374 6f72 655f 626c 6f63 6b28 6e65 775f  store_block(new_
+00007310: 626c 6f63 6b3a 2044 6963 745b 7374 722c  block: Dict[str,
+00007320: 2041 6e79 5d2c 206f 6c64 5f62 6c6f 636b   Any], old_block
+00007330: 3a20 4469 6374 5b73 7472 2c20 416e 795d  : Dict[str, Any]
+00007340: 293a 0a20 2020 2020 2020 2066 6f72 206b  ):.        for k
+00007350: 6579 2c20 7661 6c75 6520 696e 206e 6577  ey, value in new
+00007360: 5f62 6c6f 636b 2e69 7465 6d73 2829 3a0a  _block.items():.
+00007370: 2020 2020 2020 2020 2020 2020 6966 206b              if k
+00007380: 6579 2069 6e20 7265 7374 6f72 655f 6b65  ey in restore_ke
+00007390: 795f 6e61 6d65 733a 0a20 2020 2020 2020  y_names:.       
+000073a0: 2020 2020 2020 2020 2069 6620 6b65 7920           if key 
+000073b0: 696e 206f 6c64 5f62 6c6f 636b 3a0a 2020  in old_block:.  
+000073c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000073d0: 2020 6e65 775f 626c 6f63 6b5b 6b65 795d    new_block[key]
+000073e0: 203d 206f 6c64 5f62 6c6f 636b 5b6b 6579   = old_block[key
+000073f0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00007400: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00007410: 2020 2020 2020 2020 2020 2020 6465 6c20              del 
+00007420: 6e65 775f 626c 6f63 6b5b 6b65 795d 0a20  new_block[key]. 
+00007430: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+00007440: 6973 696e 7374 616e 6365 2876 616c 7565  isinstance(value
+00007450: 2c20 6469 6374 293a 0a20 2020 2020 2020  , dict):.       
+00007460: 2020 2020 2020 2020 2069 6620 6b65 7920           if key 
+00007470: 696e 206f 6c64 5f62 6c6f 636b 3a0a 2020  in old_block:.  
+00007480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007490: 2020 5f72 6573 746f 7265 5f62 6c6f 636b    _restore_block
+000074a0: 2876 616c 7565 2c20 6f6c 645f 626c 6f63  (value, old_bloc
+000074b0: 6b5b 6b65 795d 290a 0a20 2020 206e 6577  k[key])..    new
+000074c0: 5f63 6f6e 6669 6720 3d20 7961 6d6c 2e73  _config = yaml.s
+000074d0: 6166 655f 6c6f 6164 286e 6577 5f79 616d  afe_load(new_yam
+000074e0: 6c29 0a20 2020 206f 6c64 5f63 6f6e 6669  l).    old_confi
+000074f0: 6720 3d20 7961 6d6c 2e73 6166 655f 6c6f  g = yaml.safe_lo
+00007500: 6164 286f 6c64 5f79 616d 6c29 0a20 2020  ad(old_yaml).   
+00007510: 2065 7863 6c75 6465 645f 7265 7375 6c74   excluded_result
+00007520: 7320 3d20 7b7d 0a20 2020 2023 2046 696e  s = {}.    # Fin
+00007530: 6420 616c 6c20 6b65 7920 7661 6c75 6573  d all key values
+00007540: 2065 7863 6c75 6465 6420 6672 6f6d 2072   excluded from r
+00007550: 6573 746f 7265 0a20 2020 2066 6f72 2065  estore.    for e
+00007560: 7863 6c75 6465 5f72 6573 746f 7265 5f6b  xclude_restore_k
+00007570: 6579 5f6e 616d 655f 6c69 7374 2069 6e20  ey_name_list in 
+00007580: 7265 7374 6f72 655f 6b65 795f 6e61 6d65  restore_key_name
+00007590: 735f 6578 6365 7074 696f 6e73 3a0a 2020  s_exceptions:.  
+000075a0: 2020 2020 2020 6578 636c 7564 6564 5f72        excluded_r
+000075b0: 6573 756c 7420 3d20 6e65 775f 636f 6e66  esult = new_conf
+000075c0: 6967 0a20 2020 2020 2020 2066 6f75 6e64  ig.        found
+000075d0: 5f65 7863 6c75 6465 645f 6b65 7920 3d20  _excluded_key = 
+000075e0: 5472 7565 0a20 2020 2020 2020 2066 6f72  True.        for
+000075f0: 206b 6579 2069 6e20 6578 636c 7564 655f   key in exclude_
+00007600: 7265 7374 6f72 655f 6b65 795f 6e61 6d65  restore_key_name
+00007610: 5f6c 6973 743a 0a20 2020 2020 2020 2020  _list:.         
+00007620: 2020 2069 6620 286e 6f74 2069 7369 6e73     if (not isins
+00007630: 7461 6e63 6528 6578 636c 7564 6564 5f72  tance(excluded_r
+00007640: 6573 756c 742c 2064 6963 7429 206f 720a  esult, dict) or.
+00007650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007660: 2020 2020 6b65 7920 6e6f 7420 696e 2065      key not in e
+00007670: 7863 6c75 6465 645f 7265 7375 6c74 293a  xcluded_result):
+00007680: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007690: 2066 6f75 6e64 5f65 7863 6c75 6465 645f   found_excluded_
+000076a0: 6b65 7920 3d20 4661 6c73 650a 2020 2020  key = False.    
+000076b0: 2020 2020 2020 2020 2020 2020 6272 6561              brea
+000076c0: 6b0a 2020 2020 2020 2020 2020 2020 6578  k.            ex
+000076d0: 636c 7564 6564 5f72 6573 756c 7420 3d20  cluded_result = 
+000076e0: 6578 636c 7564 6564 5f72 6573 756c 745b  excluded_result[
+000076f0: 6b65 795d 0a20 2020 2020 2020 2069 6620  key].        if 
+00007700: 666f 756e 645f 6578 636c 7564 6564 5f6b  found_excluded_k
+00007710: 6579 3a0a 2020 2020 2020 2020 2020 2020  ey:.            
+00007720: 6578 636c 7564 6564 5f72 6573 756c 7473  excluded_results
+00007730: 5b65 7863 6c75 6465 5f72 6573 746f 7265  [exclude_restore
+00007740: 5f6b 6579 5f6e 616d 655f 6c69 7374 5d20  _key_name_list] 
+00007750: 3d20 6578 636c 7564 6564 5f72 6573 756c  = excluded_resul
+00007760: 740a 0a20 2020 2023 2052 6573 746f 7265  t..    # Restore
+00007770: 2066 726f 6d20 6f6c 6420 636f 6e66 6967   from old config
+00007780: 0a20 2020 205f 7265 7374 6f72 655f 626c  .    _restore_bl
+00007790: 6f63 6b28 6e65 775f 636f 6e66 6967 2c20  ock(new_config, 
+000077a0: 6f6c 645f 636f 6e66 6967 290a 0a20 2020  old_config)..   
+000077b0: 2023 2052 6576 6572 7420 7468 6520 6368   # Revert the ch
+000077c0: 616e 6765 7320 666f 7220 7468 6520 6578  anges for the ex
+000077d0: 636c 7564 6564 206b 6579 2076 616c 7565  cluded key value
+000077e0: 730a 2020 2020 666f 7220 6578 636c 7564  s.    for exclud
+000077f0: 655f 7265 7374 6f72 655f 6b65 795f 6e61  e_restore_key_na
+00007800: 6d65 2c20 7661 6c75 6520 696e 2065 7863  me, value in exc
+00007810: 6c75 6465 645f 7265 7375 6c74 732e 6974  luded_results.it
+00007820: 656d 7328 293a 0a20 2020 2020 2020 2063  ems():.        c
+00007830: 7572 7220 3d20 6e65 775f 636f 6e66 6967  urr = new_config
+00007840: 0a20 2020 2020 2020 2066 6f72 206b 6579  .        for key
+00007850: 2069 6e20 6578 636c 7564 655f 7265 7374   in exclude_rest
+00007860: 6f72 655f 6b65 795f 6e61 6d65 5b3a 2d31  ore_key_name[:-1
+00007870: 5d3a 0a20 2020 2020 2020 2020 2020 2063  ]:.            c
+00007880: 7572 7220 3d20 6375 7272 5b6b 6579 5d0a  urr = curr[key].
+00007890: 2020 2020 2020 2020 6375 7272 5b65 7863          curr[exc
+000078a0: 6c75 6465 5f72 6573 746f 7265 5f6b 6579  lude_restore_key
+000078b0: 5f6e 616d 655b 2d31 5d5d 203d 2076 616c  _name[-1]] = val
+000078c0: 7565 0a20 2020 2072 6574 7572 6e20 636f  ue.    return co
+000078d0: 6d6d 6f6e 5f75 7469 6c73 2e64 756d 705f  mmon_utils.dump_
+000078e0: 7961 6d6c 5f73 7472 286e 6577 5f63 6f6e  yaml_str(new_con
+000078f0: 6669 6729 0a0a 0a23 2054 4f44 4f3a 2074  fig)...# TODO: t
+00007900: 6f6f 206d 616e 7920 7468 696e 6773 2068  oo many things h
+00007910: 6170 7065 6e69 6e67 2068 6572 6520 2d20  appening here - 
+00007920: 6c65 616b 7920 6162 7374 7261 6374 696f  leaky abstractio
+00007930: 6e2e 2052 6566 6163 746f 722e 0a40 7469  n. Refactor..@ti
+00007940: 6d65 6c69 6e65 2e65 7665 6e74 0a64 6566  meline.event.def
+00007950: 2077 7269 7465 5f63 6c75 7374 6572 5f63   write_cluster_c
+00007960: 6f6e 6669 6728 0a20 2020 2020 2020 2074  onfig(.        t
+00007970: 6f5f 7072 6f76 6973 696f 6e3a 2027 7265  o_provision: 're
+00007980: 736f 7572 6365 732e 5265 736f 7572 6365  sources.Resource
+00007990: 7327 2c0a 2020 2020 2020 2020 6e75 6d5f  s',.        num_
+000079a0: 6e6f 6465 733a 2069 6e74 2c0a 2020 2020  nodes: int,.    
+000079b0: 2020 2020 636c 7573 7465 725f 636f 6e66      cluster_conf
+000079c0: 6967 5f74 656d 706c 6174 653a 2073 7472  ig_template: str
+000079d0: 2c0a 2020 2020 2020 2020 636c 7573 7465  ,.        cluste
+000079e0: 725f 6e61 6d65 3a20 7374 722c 0a20 2020  r_name: str,.   
+000079f0: 2020 2020 206c 6f63 616c 5f77 6865 656c       local_wheel
+00007a00: 5f70 6174 683a 2070 6174 686c 6962 2e50  _path: pathlib.P
+00007a10: 6174 682c 0a20 2020 2020 2020 2077 6865  ath,.        whe
+00007a20: 656c 5f68 6173 683a 2073 7472 2c0a 2020  el_hash: str,.  
+00007a30: 2020 2020 2020 7265 6769 6f6e 3a20 636c        region: cl
+00007a40: 6f75 6473 2e52 6567 696f 6e2c 0a20 2020  ouds.Region,.   
+00007a50: 2020 2020 207a 6f6e 6573 3a20 4f70 7469       zones: Opti
+00007a60: 6f6e 616c 5b4c 6973 745b 636c 6f75 6473  onal[List[clouds
+00007a70: 2e5a 6f6e 655d 5d20 3d20 4e6f 6e65 2c0a  .Zone]] = None,.
+00007a80: 2020 2020 2020 2020 6472 7972 756e 3a20          dryrun: 
+00007a90: 626f 6f6c 203d 2046 616c 7365 2c0a 2020  bool = False,.  
+00007aa0: 2020 2020 2020 6b65 6570 5f6c 6175 6e63        keep_launc
+00007ab0: 685f 6669 656c 6473 5f69 6e5f 6578 6973  h_fields_in_exis
+00007ac0: 7469 6e67 5f63 6f6e 6669 673a 2062 6f6f  ting_config: boo
+00007ad0: 6c20 3d20 5472 7565 2920 2d3e 2044 6963  l = True) -> Dic
+00007ae0: 745b 7374 722c 2073 7472 5d3a 0a20 2020  t[str, str]:.   
+00007af0: 2022 2222 4669 6c6c 7320 696e 2063 6c75   """Fills in clu
+00007b00: 7374 6572 2063 6f6e 6669 6775 7261 7469  ster configurati
+00007b10: 6f6e 2074 656d 706c 6174 6573 2061 6e64  on templates and
+00007b20: 2077 7269 7465 7320 7468 656d 206f 7574   writes them out
+00007b30: 2e0a 0a20 2020 2052 6574 7572 6e73 3a20  ...    Returns: 
+00007b40: 7b70 726f 7669 7369 6f6e 6572 3a20 7061  {provisioner: pa
+00007b50: 7468 2074 6f20 7961 6d6c 2c20 7468 6520  th to yaml, the 
+00007b60: 7072 6f76 6973 696f 6e69 6e67 2073 7065  provisioning spe
+00007b70: 637d 2e0a 2020 2020 2020 2770 726f 7669  c}..      'provi
+00007b80: 7369 6f6e 6572 2720 6361 6e20 6265 0a20  sioner' can be. 
+00007b90: 2020 2020 2020 202d 2027 7261 7927 0a20         - 'ray'. 
+00007ba0: 2020 2020 2020 202d 2027 7470 752d 6372         - 'tpu-cr
+00007bb0: 6561 7465 2d73 6372 6970 7427 2028 6966  eate-script' (if
+00007bc0: 2054 5055 2069 7320 7265 7175 6573 7465   TPU is requeste
+00007bd0: 6429 0a20 2020 2020 2020 202d 2027 7470  d).        - 'tp
+00007be0: 752d 6465 6c65 7465 2d73 6372 6970 7427  u-delete-script'
+00007bf0: 2028 6966 2054 5055 2069 7320 7265 7175   (if TPU is requ
+00007c00: 6573 7465 6429 0a20 2020 2052 6169 7365  ested).    Raise
+00007c10: 733a 0a20 2020 2020 2020 2065 7863 6570  s:.        excep
+00007c20: 7469 6f6e 732e 5265 736f 7572 6365 7355  tions.ResourcesU
+00007c30: 6e61 7661 696c 6162 6c65 4572 726f 723a  navailableError:
+00007c40: 2069 6620 7468 6520 7265 6769 6f6e 2f7a   if the region/z
+00007c50: 6f6e 6573 2072 6571 7565 7374 6564 2064  ones requested d
+00007c60: 6f65 730a 2020 2020 2020 2020 2020 2020  oes.            
+00007c70: 6e6f 7420 6170 7065 6172 2069 6e20 7468  not appear in th
+00007c80: 6520 6361 7461 6c6f 672c 206f 7220 616e  e catalog, or an
+00007c90: 2073 7368 5f70 726f 7879 5f63 6f6d 6d61   ssh_proxy_comma
+00007ca0: 6e64 2069 7320 7370 6563 6966 6965 6420  nd is specified 
+00007cb0: 6275 740a 2020 2020 2020 2020 2020 2020  but.            
+00007cc0: 6e6f 7420 666f 7220 7468 6520 6769 7665  not for the give
+00007cd0: 6e20 7265 6769 6f6e 2c20 6f72 2047 5055  n region, or GPU
+00007ce0: 7320 6172 6520 7265 7175 6573 7465 6420  s are requested 
+00007cf0: 696e 2061 204b 7562 6572 6e65 7465 730a  in a Kubernetes.
+00007d00: 2020 2020 2020 2020 2020 2020 636c 7573              clus
+00007d10: 7465 7220 6275 7420 7468 6520 636c 7573  ter but the clus
+00007d20: 7465 7220 646f 6573 206e 6f74 2068 6176  ter does not hav
+00007d30: 6520 6e6f 6465 7320 6c61 6265 6c65 6420  e nodes labeled 
+00007d40: 7769 7468 2047 5055 2074 7970 6573 2e0a  with GPU types..
+00007d50: 2020 2020 2020 2020 6578 6365 7074 696f          exceptio
+00007d60: 6e73 2e49 6e76 616c 6964 436c 6f75 6443  ns.InvalidCloudC
+00007d70: 6f6e 6669 6773 3a20 6966 2074 6865 2075  onfigs: if the u
+00007d80: 7365 7220 7370 6563 6966 6965 7320 736f  ser specifies so
+00007d90: 6d65 2063 6f6e 6669 6720 666f 7220 7468  me config for th
+00007da0: 650a 2020 2020 2020 2020 2020 2020 636c  e.            cl
+00007db0: 6f75 6420 7468 6174 2069 7320 6e6f 7420  oud that is not 
+00007dc0: 7661 6c69 642c 2065 2e67 2e20 7265 6d6f  valid, e.g. remo
+00007dd0: 7465 5f69 6465 6e74 6974 793a 2053 4552  te_identity: SER
+00007de0: 5649 4345 5f41 4343 4f55 4e54 0a20 2020  VICE_ACCOUNT.   
+00007df0: 2020 2020 2020 2020 2066 6f72 2061 2063           for a c
+00007e00: 6c6f 7564 2074 6861 7420 646f 6573 206e  loud that does n
+00007e10: 6f74 2073 7570 706f 7274 2069 742c 2074  ot support it, t
+00007e20: 6865 2063 616c 6c65 7220 7368 6f75 6c64  he caller should
+00007e30: 2073 6b69 7020 7468 650a 2020 2020 2020   skip the.      
+00007e40: 2020 2020 2020 636c 6f75 6420 696e 2074        cloud in t
+00007e50: 6869 7320 6361 7365 2e0a 2020 2020 2222  his case..    ""
+00007e60: 220a 2020 2020 2320 7461 736b 2e62 6573  ".    # task.bes
+00007e70: 745f 7265 736f 7572 6365 7320 6d61 7920  t_resources may 
+00007e80: 6e6f 7420 6265 2065 7175 616c 2074 6f20  not be equal to 
+00007e90: 746f 5f70 726f 7669 7369 6f6e 2069 6620  to_provision if 
+00007ea0: 7468 6520 7573 6572 0a20 2020 2023 2069  the user.    # i
+00007eb0: 7320 7275 6e6e 696e 6720 6120 6a6f 6220  s running a job 
+00007ec0: 7769 7468 206c 6573 7320 7265 736f 7572  with less resour
+00007ed0: 6365 7320 7468 616e 2074 6865 2063 6c75  ces than the clu
+00007ee0: 7374 6572 2068 6173 2e0a 2020 2020 636c  ster has..    cl
+00007ef0: 6f75 6420 3d20 746f 5f70 726f 7669 7369  oud = to_provisi
+00007f00: 6f6e 2e63 6c6f 7564 0a20 2020 2061 7373  on.cloud.    ass
+00007f10: 6572 7420 636c 6f75 6420 6973 206e 6f74  ert cloud is not
+00007f20: 204e 6f6e 652c 2074 6f5f 7072 6f76 6973   None, to_provis
+00007f30: 696f 6e0a 0a20 2020 2063 6c75 7374 6572  ion..    cluster
+00007f40: 5f6e 616d 655f 6f6e 5f63 6c6f 7564 203d  _name_on_cloud =
+00007f50: 2063 6f6d 6d6f 6e5f 7574 696c 732e 6d61   common_utils.ma
+00007f60: 6b65 5f63 6c75 7374 6572 5f6e 616d 655f  ke_cluster_name_
+00007f70: 6f6e 5f63 6c6f 7564 280a 2020 2020 2020  on_cloud(.      
+00007f80: 2020 636c 7573 7465 725f 6e61 6d65 2c20    cluster_name, 
+00007f90: 6d61 785f 6c65 6e67 7468 3d63 6c6f 7564  max_length=cloud
+00007fa0: 2e6d 6178 5f63 6c75 7374 6572 5f6e 616d  .max_cluster_nam
+00007fb0: 655f 6c65 6e67 7468 2829 290a 0a20 2020  e_length())..   
+00007fc0: 2023 2054 6869 7320 6361 6e20 7261 6973   # This can rais
+00007fd0: 6520 6120 5265 736f 7572 6365 7355 6e61  e a ResourcesUna
+00007fe0: 7661 696c 6162 6c65 4572 726f 7220 7768  vailableError wh
+00007ff0: 656e 3a0a 2020 2020 2320 202a 2054 6865  en:.    #  * The
+00008000: 2072 6567 696f 6e2f 7a6f 6e65 7320 7265   region/zones re
+00008010: 7175 6573 7465 6420 646f 6573 206e 6f74  quested does not
+00008020: 2061 7070 6561 7220 696e 2074 6865 2063   appear in the c
+00008030: 6174 616c 6f67 2e20 4974 2063 616e 2062  atalog. It can b
+00008040: 650a 2020 2020 2320 2020 2074 7269 6767  e.    #    trigg
+00008050: 6572 6564 2069 6620 7468 6520 7573 6572  ered if the user
+00008060: 2063 6861 6e67 6564 2074 6865 2063 6174   changed the cat
+00008070: 616c 6f67 2066 696c 6520 7768 696c 6520  alog file while 
+00008080: 7468 6572 6520 6973 2061 2063 6c75 7374  there is a clust
+00008090: 6572 0a20 2020 2023 2020 2020 696e 2074  er.    #    in t
+000080a0: 6865 2072 656d 6f76 6564 2072 6567 696f  he removed regio
+000080b0: 6e2f 7a6f 6e65 2e0a 2020 2020 2320 202a  n/zone..    #  *
+000080c0: 2047 5055 7320 6172 6520 7265 7175 6573   GPUs are reques
+000080d0: 7465 6420 696e 2061 204b 7562 6572 6e65  ted in a Kuberne
+000080e0: 7465 7320 636c 7573 7465 7220 6275 7420  tes cluster but 
+000080f0: 7468 6520 636c 7573 7465 7220 646f 6573  the cluster does
+00008100: 206e 6f74 0a20 2020 2023 2020 2020 6861   not.    #    ha
+00008110: 7665 206e 6f64 6573 206c 6162 656c 6564  ve nodes labeled
+00008120: 2077 6974 6820 4750 5520 7479 7065 732e   with GPU types.
+00008130: 0a20 2020 2023 0a20 2020 2023 2054 4f44  .    #.    # TOD
+00008140: 4f28 7a68 7775 293a 2057 6520 7368 6f75  O(zhwu): We shou
+00008150: 6c64 2063 6861 6e67 6520 7468 6520 6578  ld change the ex
+00008160: 6365 7074 696f 6e20 7479 7065 2074 6f20  ception type to 
+00008170: 6120 6d6f 7265 2073 7065 6369 6669 6320  a more specific 
+00008180: 6f6e 652c 2061 730a 2020 2020 2320 7468  one, as.    # th
+00008190: 6520 5265 736f 7572 6365 7355 6e61 7661  e ResourcesUnava
+000081a0: 696c 6162 6c65 4572 726f 7220 6973 206f  ilableError is o
+000081b0: 7665 726c 7920 7573 6564 2e20 416c 736f  verly used. Also
+000081c0: 2c20 6974 2077 6f75 6c64 2062 6520 6265  , it would be be
+000081d0: 7474 6572 2074 6f0a 2020 2020 2320 6d6f  tter to.    # mo
+000081e0: 7665 2074 6865 2063 6865 636b 206f 7574  ve the check out
+000081f0: 206f 6620 7468 6973 2066 756e 6374 696f   of this functio
+00008200: 6e2c 2069 2e65 2e20 7468 6520 6361 6c6c  n, i.e. the call
+00008210: 6572 2073 686f 756c 6420 6265 2072 6573  er should be res
+00008220: 706f 6e73 6962 6c65 0a20 2020 2023 2066  ponsible.    # f
+00008230: 6f72 2074 6865 2076 616c 6964 6174 696f  or the validatio
+00008240: 6e2e 0a20 2020 2023 2054 4f44 4f28 7469  n..    # TODO(ti
+00008250: 616e 293a 204d 6f76 6520 6d6f 7265 2063  an): Move more c
+00008260: 6c6f 7564 2061 676e 6f73 7469 6320 7661  loud agnostic va
+00008270: 7273 2074 6f20 7265 736f 7572 6365 732e  rs to resources.
+00008280: 7079 2e0a 2020 2020 7265 736f 7572 6365  py..    resource
+00008290: 735f 7661 7273 203d 2074 6f5f 7072 6f76  s_vars = to_prov
+000082a0: 6973 696f 6e2e 6d61 6b65 5f64 6570 6c6f  ision.make_deplo
+000082b0: 795f 7661 7269 6162 6c65 7328 636c 7573  y_variables(clus
+000082c0: 7465 725f 6e61 6d65 5f6f 6e5f 636c 6f75  ter_name_on_clou
+000082d0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+000082e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000082f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008300: 2020 2020 2020 2020 2020 2072 6567 696f             regio
+00008310: 6e2c 207a 6f6e 6573 2c20 6472 7972 756e  n, zones, dryrun
+00008320: 290a 2020 2020 636f 6e66 6967 5f64 6963  ).    config_dic
+00008330: 7420 3d20 7b7d 0a0a 2020 2020 7370 6563  t = {}..    spec
+00008340: 6966 6963 5f72 6573 6572 7661 7469 6f6e  ific_reservation
+00008350: 7320 3d20 7365 7428 0a20 2020 2020 2020  s = set(.       
+00008360: 2073 6b79 7069 6c6f 745f 636f 6e66 6967   skypilot_config
+00008370: 2e67 6574 5f6e 6573 7465 6428 0a20 2020  .get_nested(.   
+00008380: 2020 2020 2020 2020 2028 7374 7228 746f           (str(to
+00008390: 5f70 726f 7669 7369 6f6e 2e63 6c6f 7564  _provision.cloud
+000083a0: 292e 6c6f 7765 7228 292c 2027 7370 6563  ).lower(), 'spec
+000083b0: 6966 6963 5f72 6573 6572 7661 7469 6f6e  ific_reservation
+000083c0: 7327 292c 2073 6574 2829 2929 0a0a 2020  s'), set()))..  
+000083d0: 2020 6173 7365 7274 2063 6c75 7374 6572    assert cluster
+000083e0: 5f6e 616d 6520 6973 206e 6f74 204e 6f6e  _name is not Non
+000083f0: 650a 2020 2020 6578 636c 7564 6564 5f63  e.    excluded_c
+00008400: 6c6f 7564 7320 3d20 5b5d 0a20 2020 2072  louds = [].    r
+00008410: 656d 6f74 655f 6964 656e 7469 7479 203d  emote_identity =
+00008420: 2073 6b79 7069 6c6f 745f 636f 6e66 6967   skypilot_config
+00008430: 2e67 6574 5f6e 6573 7465 6428 0a20 2020  .get_nested(.   
+00008440: 2020 2020 2028 7374 7228 636c 6f75 6429       (str(cloud)
+00008450: 2e6c 6f77 6572 2829 2c20 2772 656d 6f74  .lower(), 'remot
+00008460: 655f 6964 656e 7469 7479 2729 2c0a 2020  e_identity'),.  
+00008470: 2020 2020 2020 7363 6865 6d61 732e 6765        schemas.ge
+00008480: 745f 6465 6661 756c 745f 7265 6d6f 7465  t_default_remote
+00008490: 5f69 6465 6e74 6974 7928 7374 7228 636c  _identity(str(cl
+000084a0: 6f75 6429 2e6c 6f77 6572 2829 2929 0a20  oud).lower())). 
+000084b0: 2020 2069 6620 7265 6d6f 7465 5f69 6465     if remote_ide
+000084c0: 6e74 6974 7920 6973 206e 6f74 204e 6f6e  ntity is not Non
+000084d0: 6520 616e 6420 6e6f 7420 6973 696e 7374  e and not isinst
+000084e0: 616e 6365 2872 656d 6f74 655f 6964 656e  ance(remote_iden
+000084f0: 7469 7479 2c20 7374 7229 3a0a 2020 2020  tity, str):.    
+00008500: 2020 2020 666f 7220 7072 6f66 696c 6520      for profile 
+00008510: 696e 2072 656d 6f74 655f 6964 656e 7469  in remote_identi
+00008520: 7479 3a0a 2020 2020 2020 2020 2020 2020  ty:.            
+00008530: 6966 2066 6e6d 6174 6368 2e66 6e6d 6174  if fnmatch.fnmat
+00008540: 6368 6361 7365 2863 6c75 7374 6572 5f6e  chcase(cluster_n
+00008550: 616d 652c 206c 6973 7428 7072 6f66 696c  ame, list(profil
+00008560: 652e 6b65 7973 2829 295b 305d 293a 0a20  e.keys())[0]):. 
+00008570: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00008580: 656d 6f74 655f 6964 656e 7469 7479 203d  emote_identity =
+00008590: 206c 6973 7428 7072 6f66 696c 652e 7661   list(profile.va
+000085a0: 6c75 6573 2829 295b 305d 0a20 2020 2020  lues())[0].     
+000085b0: 2020 2020 2020 2020 2020 2062 7265 616b             break
+000085c0: 0a20 2020 2069 6620 7265 6d6f 7465 5f69  .    if remote_i
+000085d0: 6465 6e74 6974 7920 213d 2073 6368 656d  dentity != schem
+000085e0: 6173 2e52 656d 6f74 6549 6465 6e74 6974  as.RemoteIdentit
+000085f0: 794f 7074 696f 6e73 2e4c 4f43 414c 5f43  yOptions.LOCAL_C
+00008600: 5245 4445 4e54 4941 4c53 2e76 616c 7565  REDENTIALS.value
+00008610: 3a0a 2020 2020 2020 2020 6966 206e 6f74  :.        if not
+00008620: 2063 6c6f 7564 2e73 7570 706f 7274 735f   cloud.supports_
+00008630: 7365 7276 6963 655f 6163 636f 756e 745f  service_account_
+00008640: 6f6e 5f72 656d 6f74 6528 293a 0a20 2020  on_remote():.   
+00008650: 2020 2020 2020 2020 2072 6169 7365 2065           raise e
+00008660: 7863 6570 7469 6f6e 732e 496e 7661 6c69  xceptions.Invali
+00008670: 6443 6c6f 7564 436f 6e66 6967 7328 0a20  dCloudConfigs(. 
+00008680: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00008690: 7265 6d6f 7465 5f69 6465 6e74 6974 793a  remote_identity:
+000086a0: 2053 4552 5649 4345 5f41 4343 4f55 4e54   SERVICE_ACCOUNT
+000086b0: 2069 7320 7370 6563 6966 6965 6420 696e   is specified in
+000086c0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+000086d0: 2020 2066 277b 736b 7970 696c 6f74 5f63     f'{skypilot_c
+000086e0: 6f6e 6669 672e 6c6f 6164 6564 5f63 6f6e  onfig.loaded_con
+000086f0: 6669 675f 7061 7468 2172 7d20 666f 7220  fig_path!r} for 
+00008700: 7b63 6c6f 7564 7d2c 2062 7574 2069 7420  {cloud}, but it 
+00008710: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00008720: 2020 2769 7320 6e6f 7420 7375 7070 6f72    'is not suppor
+00008730: 7465 6420 6279 2074 6869 7320 636c 6f75  ted by this clou
+00008740: 642e 2052 656d 6f76 6520 7468 6520 636f  d. Remove the co
+00008750: 6e66 6967 206f 7220 7365 743a 2027 0a20  nfig or set: '. 
+00008760: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00008770: 6072 656d 6f74 655f 6964 656e 7469 7479  `remote_identity
+00008780: 3a20 4c4f 4341 4c5f 4352 4544 454e 5449  : LOCAL_CREDENTI
+00008790: 414c 5360 2e27 290a 2020 2020 2020 2020  ALS`.').        
+000087a0: 6578 636c 7564 6564 5f63 6c6f 7564 7320  excluded_clouds 
+000087b0: 3d20 5b63 6c6f 7564 5d0a 2020 2020 6372  = [cloud].    cr
+000087c0: 6564 656e 7469 616c 7320 3d20 736b 795f  edentials = sky_
+000087d0: 6368 6563 6b2e 6765 745f 636c 6f75 645f  check.get_cloud_
+000087e0: 6372 6564 656e 7469 616c 5f66 696c 655f  credential_file_
+000087f0: 6d6f 756e 7473 2865 7863 6c75 6465 645f  mounts(excluded_
+00008800: 636c 6f75 6473 290a 0a20 2020 2061 7574  clouds)..    aut
+00008810: 685f 636f 6e66 6967 203d 207b 2773 7368  h_config = {'ssh
+00008820: 5f70 7269 7661 7465 5f6b 6579 273a 2061  _private_key': a
+00008830: 7574 682e 5052 4956 4154 455f 5353 485f  uth.PRIVATE_SSH_
+00008840: 4b45 595f 5041 5448 7d0a 2020 2020 7265  KEY_PATH}.    re
+00008850: 6769 6f6e 5f6e 616d 6520 3d20 7265 736f  gion_name = reso
+00008860: 7572 6365 735f 7661 7273 2e67 6574 2827  urces_vars.get('
+00008870: 7265 6769 6f6e 2729 0a0a 2020 2020 7961  region')..    ya
+00008880: 6d6c 5f70 6174 6820 3d20 5f67 6574 5f79  ml_path = _get_y
+00008890: 616d 6c5f 7061 7468 5f66 726f 6d5f 636c  aml_path_from_cl
+000088a0: 7573 7465 725f 6e61 6d65 2863 6c75 7374  uster_name(clust
+000088b0: 6572 5f6e 616d 6529 0a0a 2020 2020 2320  er_name)..    # 
+000088c0: 5265 7472 6965 7665 2074 6865 2073 7368  Retrieve the ssh
+000088d0: 5f70 726f 7879 5f63 6f6d 6d61 6e64 2066  _proxy_command f
+000088e0: 6f72 2074 6865 2067 6976 656e 2063 6c6f  or the given clo
+000088f0: 7564 202f 2072 6567 696f 6e2e 0a20 2020  ud / region..   
+00008900: 2073 7368 5f70 726f 7879 5f63 6f6d 6d61   ssh_proxy_comma
+00008910: 6e64 5f63 6f6e 6669 6720 3d20 736b 7970  nd_config = skyp
+00008920: 696c 6f74 5f63 6f6e 6669 672e 6765 745f  ilot_config.get_
+00008930: 6e65 7374 6564 280a 2020 2020 2020 2020  nested(.        
+00008940: 2873 7472 2863 6c6f 7564 292e 6c6f 7765  (str(cloud).lowe
+00008950: 7228 292c 2027 7373 685f 7072 6f78 795f  r(), 'ssh_proxy_
+00008960: 636f 6d6d 616e 6427 292c 204e 6f6e 6529  command'), None)
+00008970: 0a20 2020 2069 6620 2869 7369 6e73 7461  .    if (isinsta
+00008980: 6e63 6528 7373 685f 7072 6f78 795f 636f  nce(ssh_proxy_co
+00008990: 6d6d 616e 645f 636f 6e66 6967 2c20 7374  mmand_config, st
+000089a0: 7229 206f 720a 2020 2020 2020 2020 2020  r) or.          
+000089b0: 2020 7373 685f 7072 6f78 795f 636f 6d6d    ssh_proxy_comm
+000089c0: 616e 645f 636f 6e66 6967 2069 7320 4e6f  and_config is No
+000089d0: 6e65 293a 0a20 2020 2020 2020 2073 7368  ne):.        ssh
+000089e0: 5f70 726f 7879 5f63 6f6d 6d61 6e64 203d  _proxy_command =
+000089f0: 2073 7368 5f70 726f 7879 5f63 6f6d 6d61   ssh_proxy_comma
+00008a00: 6e64 5f63 6f6e 6669 670a 2020 2020 656c  nd_config.    el
+00008a10: 7365 3a0a 2020 2020 2020 2020 2320 7373  se:.        # ss
+00008a20: 685f 7072 6f78 795f 636f 6d6d 616e 645f  h_proxy_command_
+00008a30: 636f 6e66 6967 3a20 4469 6374 5b73 7472  config: Dict[str
+00008a40: 2c20 7374 725d 2c20 7265 6769 6f6e 5f6e  , str], region_n
+00008a50: 616d 6520 2d3e 2063 6f6d 6d61 6e64 0a20  ame -> command. 
+00008a60: 2020 2020 2020 2023 2054 6869 7320 7479         # This ty
+00008a70: 7065 2063 6865 636b 2069 7320 646f 6e65  pe check is done
+00008a80: 2062 7920 736b 7970 696c 6f74 5f63 6f6e   by skypilot_con
+00008a90: 6669 6720 6174 2063 6f6e 6669 6720 6c6f  fig at config lo
+00008aa0: 6164 2074 696d 652e 0a0a 2020 2020 2020  ad time...      
+00008ab0: 2020 2320 5468 6572 6520 6172 6520 7477    # There are tw
+00008ac0: 6f20 6361 7365 733a 0a20 2020 2020 2020  o cases:.       
+00008ad0: 2069 6620 6b65 6570 5f6c 6175 6e63 685f   if keep_launch_
+00008ae0: 6669 656c 6473 5f69 6e5f 6578 6973 7469  fields_in_existi
+00008af0: 6e67 5f63 6f6e 6669 673a 0a20 2020 2020  ng_config:.     
+00008b00: 2020 2020 2020 2023 2028 3129 2057 6527         # (1) We'
+00008b10: 7265 2072 652d 7072 6f76 6973 696f 6e69  re re-provisioni
+00008b20: 6e67 2061 6e20 6578 6973 7469 6e67 2063  ng an existing c
+00008b30: 6c75 7374 6572 2e0a 2020 2020 2020 2020  luster..        
+00008b40: 2020 2020 230a 2020 2020 2020 2020 2020      #.          
+00008b50: 2020 2320 5765 2075 7365 204e 6f6e 6520    # We use None 
+00008b60: 666f 7220 7373 685f 7072 6f78 795f 636f  for ssh_proxy_co
+00008b70: 6d6d 616e 642c 2077 6869 6368 2077 696c  mmand, which wil
+00008b80: 6c20 6265 2072 6573 746f 7265 6420 746f  l be restored to
+00008b90: 2074 6865 0a20 2020 2020 2020 2020 2020   the.           
+00008ba0: 2023 2063 6c75 7374 6572 2773 206f 7269   # cluster's ori
+00008bb0: 6769 6e61 6c20 7661 6c75 6520 6c61 7465  ginal value late
+00008bc0: 7220 6279 205f 7265 706c 6163 655f 7961  r by _replace_ya
+00008bd0: 6d6c 5f64 6963 7473 2829 2e0a 2020 2020  ml_dicts()..    
+00008be0: 2020 2020 2020 2020 7373 685f 7072 6f78          ssh_prox
+00008bf0: 795f 636f 6d6d 616e 6420 3d20 4e6f 6e65  y_command = None
+00008c00: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00008c10: 2020 2020 2020 2020 2020 2023 2028 3229             # (2)
+00008c20: 2057 6527 7265 206c 6175 6e63 6869 6e67   We're launching
+00008c30: 2061 206e 6577 2063 6c75 7374 6572 2e0a   a new cluster..
+00008c40: 2020 2020 2020 2020 2020 2020 230a 2020              #.  
+00008c50: 2020 2020 2020 2020 2020 2320 5265 736f            # Reso
+00008c60: 7572 6365 732e 6765 745f 7661 6c69 645f  urces.get_valid_
+00008c70: 7265 6769 6f6e 735f 666f 725f 6c61 756e  regions_for_laun
+00008c80: 6368 6162 6c65 2829 2072 6573 7065 6374  chable() respect
+00008c90: 7320 7468 6520 6b65 7973 2028 7265 6769  s the keys (regi
+00008ca0: 6f6e 7329 0a20 2020 2020 2020 2020 2020  ons).           
+00008cb0: 2023 2069 6e20 7373 685f 7072 6f78 795f   # in ssh_proxy_
+00008cc0: 636f 6d6d 616e 6420 696e 2073 6b79 7069  command in skypi
+00008cd0: 6c6f 745f 636f 6e66 6967 2e20 536f 2068  lot_config. So h
+00008ce0: 6572 6520 7765 2061 6464 2061 6e20 6173  ere we add an as
+00008cf0: 7365 7274 2e0a 2020 2020 2020 2020 2020  sert..          
+00008d00: 2020 6173 7365 7274 2072 6567 696f 6e5f    assert region_
+00008d10: 6e61 6d65 2069 6e20 7373 685f 7072 6f78  name in ssh_prox
+00008d20: 795f 636f 6d6d 616e 645f 636f 6e66 6967  y_command_config
+00008d30: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
+00008d40: 2020 2020 7265 6769 6f6e 5f6e 616d 652c      region_name,
+00008d50: 2073 7368 5f70 726f 7879 5f63 6f6d 6d61   ssh_proxy_comma
+00008d60: 6e64 5f63 6f6e 6669 6729 0a20 2020 2020  nd_config).     
+00008d70: 2020 2020 2020 2073 7368 5f70 726f 7879         ssh_proxy
+00008d80: 5f63 6f6d 6d61 6e64 203d 2073 7368 5f70  _command = ssh_p
+00008d90: 726f 7879 5f63 6f6d 6d61 6e64 5f63 6f6e  roxy_command_con
+00008da0: 6669 675b 7265 6769 6f6e 5f6e 616d 655d  fig[region_name]
+00008db0: 0a20 2020 206c 6f67 6765 722e 6465 6275  .    logger.debu
+00008dc0: 6728 6627 5573 696e 6720 7373 685f 7072  g(f'Using ssh_pr
+00008dd0: 6f78 795f 636f 6d6d 616e 643a 207b 7373  oxy_command: {ss
+00008de0: 685f 7072 6f78 795f 636f 6d6d 616e 6421  h_proxy_command!
+00008df0: 727d 2729 0a0a 2020 2020 2320 5573 6572  r}')..    # User
+00008e00: 2d73 7570 706c 6965 6420 676c 6f62 616c  -supplied global
+00008e10: 2069 6e73 7461 6e63 6520 7461 6773 2066   instance tags f
+00008e20: 726f 6d20 7e2f 2e73 6b79 2f63 6f6e 6669  rom ~/.sky/confi
+00008e30: 672e 7961 6d6c 2e0a 2020 2020 6c61 6265  g.yaml..    labe
+00008e40: 6c73 203d 2073 6b79 7069 6c6f 745f 636f  ls = skypilot_co
+00008e50: 6e66 6967 2e67 6574 5f6e 6573 7465 6428  nfig.get_nested(
+00008e60: 2873 7472 2863 6c6f 7564 292e 6c6f 7765  (str(cloud).lowe
+00008e70: 7228 292c 2027 6c61 6265 6c73 2729 2c20  r(), 'labels'), 
+00008e80: 7b7d 290a 2020 2020 2320 4465 7072 6563  {}).    # Deprec
+00008e90: 6174 6564 3a20 696e 7374 616e 6365 5f74  ated: instance_t
+00008ea0: 6167 7320 6861 7665 2062 6565 6e20 7265  ags have been re
+00008eb0: 706c 6163 6564 2062 7920 6c61 6265 6c73  placed by labels
+00008ec0: 2e20 466f 7220 6261 636b 7761 7264 0a20  . For backward. 
+00008ed0: 2020 2023 2063 6f6d 7061 7469 6269 6c69     # compatibili
+00008ee0: 7479 2c20 7765 2073 7570 706f 7274 2074  ty, we support t
+00008ef0: 6865 6d20 616e 6420 7468 6520 7363 6865  hem and the sche
+00008f00: 6d61 2061 6c6c 6f77 7320 7468 656d 206f  ma allows them o
+00008f10: 6e6c 7920 6966 0a20 2020 2023 2060 6c61  nly if.    # `la
+00008f20: 6265 6c73 6020 6172 6520 6e6f 7420 7370  bels` are not sp
+00008f30: 6563 6966 6965 642e 2054 6869 7320 7368  ecified. This sh
+00008f40: 6f75 6c64 2062 6520 7265 6d6f 7665 6420  ould be removed 
+00008f50: 6166 7465 7220 302e 372e 302e 0a20 2020  after 0.7.0..   
+00008f60: 206c 6162 656c 7320 3d20 736b 7970 696c   labels = skypil
+00008f70: 6f74 5f63 6f6e 6669 672e 6765 745f 6e65  ot_config.get_ne
+00008f80: 7374 6564 2828 7374 7228 636c 6f75 6429  sted((str(cloud)
+00008f90: 2e6c 6f77 6572 2829 2c20 2769 6e73 7461  .lower(), 'insta
+00008fa0: 6e63 655f 7461 6773 2729 2c0a 2020 2020  nce_tags'),.    
+00008fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008fd0: 2020 2020 6c61 6265 6c73 290a 2020 2020      labels).    
+00008fe0: 2320 6c61 6265 6c73 2069 7320 6120 6469  # labels is a di
+00008ff0: 6374 2c20 7768 6963 6820 6973 2067 7561  ct, which is gua
+00009000: 7261 6e74 6565 6420 6279 2074 6865 2074  ranteed by the t
+00009010: 7970 6520 6368 6563 6b20 696e 0a20 2020  ype check in.   
+00009020: 2023 2073 6368 656d 6173 2e70 790a 2020   # schemas.py.  
+00009030: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
+00009040: 6e63 6528 6c61 6265 6c73 2c20 6469 6374  nce(labels, dict
+00009050: 292c 206c 6162 656c 730a 0a20 2020 2023  ), labels..    #
+00009060: 2047 6574 206c 6162 656c 7320 6672 6f6d   Get labels from
+00009070: 2072 6573 6f75 7263 6573 2061 6e64 206f   resources and o
+00009080: 7665 7272 6964 6520 6672 6f6d 2074 6865  verride from the
+00009090: 206c 6162 656c 7320 746f 5f70 726f 7669   labels to_provi
+000090a0: 7369 6f6e 2e0a 2020 2020 6966 2074 6f5f  sion..    if to_
+000090b0: 7072 6f76 6973 696f 6e2e 6c61 6265 6c73  provision.labels
+000090c0: 3a0a 2020 2020 2020 2020 6c61 6265 6c73  :.        labels
+000090d0: 2e75 7064 6174 6528 746f 5f70 726f 7669  .update(to_provi
+000090e0: 7369 6f6e 2e6c 6162 656c 7329 0a0a 2020  sion.labels)..  
+000090f0: 2020 2320 4475 6d70 2074 6865 2052 6179    # Dump the Ray
+00009100: 2070 6f72 7473 2074 6f20 6120 6669 6c65   ports to a file
+00009110: 2066 6f72 2052 6179 206a 6f62 2073 7562   for Ray job sub
+00009120: 6d69 7373 696f 6e0a 2020 2020 6475 6d70  mission.    dump
+00009130: 5f70 6f72 745f 636f 6d6d 616e 6420 3d20  _port_command = 
+00009140: 280a 2020 2020 2020 2020 6627 7b63 6f6e  (.        f'{con
+00009150: 7374 616e 7473 2e53 4b59 5f50 5954 484f  stants.SKY_PYTHO
+00009160: 4e5f 434d 447d 202d 6320 5c27 696d 706f  N_CMD} -c \'impo
+00009170: 7274 206a 736f 6e2c 206f 733b 206a 736f  rt json, os; jso
+00009180: 6e2e 6475 6d70 287b 636f 6e73 7461 6e74  n.dump({constant
+00009190: 732e 534b 595f 5245 4d4f 5445 5f52 4159  s.SKY_REMOTE_RAY
+000091a0: 5f50 4f52 545f 4449 4354 5f53 5452 7d2c  _PORT_DICT_STR},
+000091b0: 2027 0a20 2020 2020 2020 2066 276f 7065   '.        f'ope
+000091c0: 6e28 6f73 2e70 6174 682e 6578 7061 6e64  n(os.path.expand
+000091d0: 7573 6572 2822 7b63 6f6e 7374 616e 7473  user("{constants
+000091e0: 2e53 4b59 5f52 454d 4f54 455f 5241 595f  .SKY_REMOTE_RAY_
+000091f0: 504f 5254 5f46 494c 457d 2229 2c20 2277  PORT_FILE}"), "w
+00009200: 222c 2065 6e63 6f64 696e 673d 2275 7466  ", encoding="utf
+00009210: 2d38 2229 295c 2727 0a20 2020 2029 0a0a  -8"))\''.    )..
+00009220: 2020 2020 2320 5573 6520 6120 746d 7020      # Use a tmp 
+00009230: 6669 6c65 2070 6174 6820 746f 2061 766f  file path to avo
+00009240: 6964 2069 6e63 6f6d 706c 6574 6520 5941  id incomplete YA
+00009250: 4d4c 2066 696c 6520 6265 696e 6720 7265  ML file being re
+00009260: 2d75 7365 6420 696e 2074 6865 0a20 2020  -used in the.   
+00009270: 2023 2066 7574 7572 652e 0a20 2020 2074   # future..    t
+00009280: 6d70 5f79 616d 6c5f 7061 7468 203d 2079  mp_yaml_path = y
+00009290: 616d 6c5f 7061 7468 202b 2027 2e74 6d70  aml_path + '.tmp
+000092a0: 270a 2020 2020 636f 6d6d 6f6e 5f75 7469  '.    common_uti
+000092b0: 6c73 2e66 696c 6c5f 7465 6d70 6c61 7465  ls.fill_template
+000092c0: 280a 2020 2020 2020 2020 636c 7573 7465  (.        cluste
+000092d0: 725f 636f 6e66 6967 5f74 656d 706c 6174  r_config_templat
+000092e0: 652c 0a20 2020 2020 2020 2064 6963 7428  e,.        dict(
+000092f0: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+00009300: 6f75 7263 6573 5f76 6172 732c 0a20 2020  ources_vars,.   
+00009310: 2020 2020 2020 2020 202a 2a7b 0a20 2020           **{.   
+00009320: 2020 2020 2020 2020 2020 2020 2027 636c               'cl
+00009330: 7573 7465 725f 6e61 6d65 5f6f 6e5f 636c  uster_name_on_cl
+00009340: 6f75 6427 3a20 636c 7573 7465 725f 6e61  oud': cluster_na
+00009350: 6d65 5f6f 6e5f 636c 6f75 642c 0a20 2020  me_on_cloud,.   
+00009360: 2020 2020 2020 2020 2020 2020 2027 6e75               'nu
+00009370: 6d5f 6e6f 6465 7327 3a20 6e75 6d5f 6e6f  m_nodes': num_no
+00009380: 6465 732c 0a20 2020 2020 2020 2020 2020  des,.           
+00009390: 2020 2020 2027 6469 736b 5f73 697a 6527       'disk_size'
+000093a0: 3a20 746f 5f70 726f 7669 7369 6f6e 2e64  : to_provision.d
+000093b0: 6973 6b5f 7369 7a65 2c0a 2020 2020 2020  isk_size,.      
+000093c0: 2020 2020 2020 2020 2020 2320 4966 2074            # If t
+000093d0: 6865 2063 7572 7265 6e74 2063 6f64 6520  he current code 
+000093e0: 6973 2072 756e 2062 7920 636f 6e74 726f  is run by contro
+000093f0: 6c6c 6572 2c20 7072 6f70 6167 6174 6520  ller, propagate 
+00009400: 7468 6520 7265 616c 0a20 2020 2020 2020  the real.       
+00009410: 2020 2020 2020 2020 2023 2063 616c 6c69           # calli
+00009420: 6e67 2075 7365 7220 7768 6963 6820 7368  ng user which sh
+00009430: 6f75 6c64 2776 6520 6265 656e 2070 6173  ould've been pas
+00009440: 7365 6420 696e 2061 7320 7468 650a 2020  sed in as the.  
+00009450: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00009460: 534b 5950 494c 4f54 5f55 5345 5220 656e  SKYPILOT_USER en
+00009470: 7620 7661 7220 2873 6565 0a20 2020 2020  v var (see.     
+00009480: 2020 2020 2020 2020 2020 2023 2063 6f6e             # con
+00009490: 7472 6f6c 6c65 725f 7574 696c 732e 7368  troller_utils.sh
+000094a0: 6172 6564 5f63 6f6e 7472 6f6c 6c65 725f  ared_controller_
+000094b0: 7661 7273 5f74 6f5f 6669 6c6c 2829 2e0a  vars_to_fill()..
+000094c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000094d0: 2775 7365 7227 3a20 636f 6d6d 6f6e 5f75  'user': common_u
+000094e0: 7469 6c73 2e67 6574 5f63 6c65 616e 6564  tils.get_cleaned
+000094f0: 5f75 7365 726e 616d 6528 0a20 2020 2020  _username(.     
+00009500: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00009510: 732e 656e 7669 726f 6e2e 6765 7428 636f  s.environ.get(co
+00009520: 6e73 7461 6e74 732e 5553 4552 5f45 4e56  nstants.USER_ENV
+00009530: 5f56 4152 2c20 2727 2929 2c0a 0a20 2020  _VAR, '')),..   
+00009540: 2020 2020 2020 2020 2020 2020 2023 204e               # N
+00009550: 6574 776f 726b 696e 6720 636f 6e66 6967  etworking config
+00009560: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+00009570: 2020 2775 7365 5f69 6e74 6572 6e61 6c5f    'use_internal_
+00009580: 6970 7327 3a20 736b 7970 696c 6f74 5f63  ips': skypilot_c
+00009590: 6f6e 6669 672e 6765 745f 6e65 7374 6564  onfig.get_nested
+000095a0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000095b0: 2020 2020 2020 2873 7472 2863 6c6f 7564        (str(cloud
+000095c0: 292e 6c6f 7765 7228 292c 2027 7573 655f  ).lower(), 'use_
+000095d0: 696e 7465 726e 616c 5f69 7073 2729 2c20  internal_ips'), 
+000095e0: 4661 6c73 6529 2c0a 2020 2020 2020 2020  False),.        
+000095f0: 2020 2020 2020 2020 2773 7368 5f70 726f          'ssh_pro
+00009600: 7879 5f63 6f6d 6d61 6e64 273a 2073 7368  xy_command': ssh
+00009610: 5f70 726f 7879 5f63 6f6d 6d61 6e64 2c0a  _proxy_command,.
+00009620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009630: 2776 7063 5f6e 616d 6527 3a20 736b 7970  'vpc_name': skyp
+00009640: 696c 6f74 5f63 6f6e 6669 672e 6765 745f  ilot_config.get_
+00009650: 6e65 7374 6564 280a 2020 2020 2020 2020  nested(.        
+00009660: 2020 2020 2020 2020 2020 2020 2873 7472              (str
+00009670: 2863 6c6f 7564 292e 6c6f 7765 7228 292c  (cloud).lower(),
+00009680: 2027 7670 635f 6e61 6d65 2729 2c20 4e6f   'vpc_name'), No
+00009690: 6e65 292c 0a0a 2020 2020 2020 2020 2020  ne),..          
+000096a0: 2020 2020 2020 2320 5573 6572 2d73 7570        # User-sup
+000096b0: 706c 6965 6420 6c61 6265 6c73 2e0a 2020  plied labels..  
+000096c0: 2020 2020 2020 2020 2020 2020 2020 276c                'l
+000096d0: 6162 656c 7327 3a20 6c61 6265 6c73 2c0a  abels': labels,.
+000096e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000096f0: 2320 5573 6572 2d73 7570 706c 6965 6420  # User-supplied 
+00009700: 7265 6d6f 7465 5f69 6465 6e74 6974 790a  remote_identity.
+00009710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009720: 2772 656d 6f74 655f 6964 656e 7469 7479  'remote_identity
+00009730: 273a 2072 656d 6f74 655f 6964 656e 7469  ': remote_identi
+00009740: 7479 2c0a 2020 2020 2020 2020 2020 2020  ty,.            
+00009750: 2020 2020 2320 5468 6520 7265 7365 7276      # The reserv
+00009760: 6174 696f 6e20 706f 6f6c 7320 7468 6174  ation pools that
+00009770: 2073 7065 6369 6669 6564 2062 7920 7468   specified by th
+00009780: 6520 7573 6572 2e20 5468 6973 2069 730a  e user. This is.
+00009790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000097a0: 2320 6375 7272 656e 746c 7920 6f6e 6c79  # currently only
+000097b0: 2075 7365 6420 6279 2047 4350 2e0a 2020   used by GCP..  
+000097c0: 2020 2020 2020 2020 2020 2020 2020 2773                's
+000097d0: 7065 6369 6669 635f 7265 7365 7276 6174  pecific_reservat
+000097e0: 696f 6e73 273a 2073 7065 6369 6669 635f  ions': specific_
+000097f0: 7265 7365 7276 6174 696f 6e73 2c0a 0a20  reservations,.. 
+00009800: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00009810: 2043 6f6e 6461 2073 6574 7570 0a20 2020   Conda setup.   
+00009820: 2020 2020 2020 2020 2020 2020 2027 636f               'co
+00009830: 6e64 615f 696e 7374 616c 6c61 7469 6f6e  nda_installation
+00009840: 5f63 6f6d 6d61 6e64 7327 3a0a 2020 2020  _commands':.    
+00009850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009860: 636f 6e73 7461 6e74 732e 434f 4e44 415f  constants.CONDA_
+00009870: 494e 5354 414c 4c41 5449 4f4e 5f43 4f4d  INSTALLATION_COM
+00009880: 4d41 4e44 532c 0a20 2020 2020 2020 2020  MANDS,.         
+00009890: 2020 2020 2020 2023 2057 6520 7368 6f75         # We shou
+000098a0: 6c64 206e 6f74 2075 7365 2060 2e66 6f72  ld not use `.for
+000098b0: 6d61 7460 2c20 6173 2069 7420 636f 6e74  mat`, as it cont
+000098c0: 6169 6e73 2027 7b7d 2720 6173 2074 6865  ains '{}' as the
+000098d0: 2062 6173 680a 2020 2020 2020 2020 2020   bash.          
+000098e0: 2020 2020 2020 2320 7379 6e74 6178 2e0a        # syntax..
+000098f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009900: 2772 6179 5f73 6b79 7069 6c6f 745f 696e  'ray_skypilot_in
+00009910: 7374 616c 6c61 7469 6f6e 5f63 6f6d 6d61  stallation_comma
+00009920: 6e64 7327 3a0a 2020 2020 2020 2020 2020  nds':.          
+00009930: 2020 2020 2020 2020 2020 2863 6f6e 7374            (const
+00009940: 616e 7473 2e52 4159 5f53 4b59 5049 4c4f  ants.RAY_SKYPILO
+00009950: 545f 494e 5354 414c 4c41 5449 4f4e 5f43  T_INSTALLATION_C
+00009960: 4f4d 4d41 4e44 532e 7265 706c 6163 6528  OMMANDS.replace(
+00009970: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009980: 2020 2020 2020 2020 2027 7b73 6b79 5f77           '{sky_w
+00009990: 6865 656c 5f68 6173 687d 272c 0a20 2020  heel_hash}',.   
+000099a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000099b0: 2020 2020 2077 6865 656c 5f68 6173 6829       wheel_hash)
+000099c0: 2e72 6570 6c61 6365 2827 7b63 6c6f 7564  .replace('{cloud
+000099d0: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
+000099e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000099f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009a00: 7374 7228 636c 6f75 6429 2e6c 6f77 6572  str(cloud).lower
+00009a10: 2829 2929 2c0a 0a20 2020 2020 2020 2020  ())),..         
+00009a20: 2020 2020 2020 2023 2050 6f72 7420 6f66         # Port of
+00009a30: 2052 6179 2028 4743 5320 7365 7276 6572   Ray (GCS server
+00009a40: 292e 0a20 2020 2020 2020 2020 2020 2020  )..             
+00009a50: 2020 2023 2052 6179 2773 2064 6566 6175     # Ray's defau
+00009a60: 6c74 2070 6f72 7420 3633 3739 2069 7320  lt port 6379 is 
+00009a70: 636f 6e66 6c69 6374 6564 2077 6974 6820  conflicted with 
+00009a80: 5265 6469 732e 0a20 2020 2020 2020 2020  Redis..         
+00009a90: 2020 2020 2020 2027 7261 795f 706f 7274         'ray_port
+00009aa0: 273a 2063 6f6e 7374 616e 7473 2e53 4b59  ': constants.SKY
+00009ab0: 5f52 454d 4f54 455f 5241 595f 504f 5254  _REMOTE_RAY_PORT
+00009ac0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00009ad0: 2020 2772 6179 5f64 6173 6862 6f61 7264    'ray_dashboard
+00009ae0: 5f70 6f72 7427 3a20 636f 6e73 7461 6e74  _port': constant
+00009af0: 732e 534b 595f 5245 4d4f 5445 5f52 4159  s.SKY_REMOTE_RAY
+00009b00: 5f44 4153 4842 4f41 5244 5f50 4f52 542c  _DASHBOARD_PORT,
+00009b10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009b20: 2027 7261 795f 7465 6d70 5f64 6972 273a   'ray_temp_dir':
+00009b30: 2063 6f6e 7374 616e 7473 2e53 4b59 5f52   constants.SKY_R
+00009b40: 454d 4f54 455f 5241 595f 5445 4d50 4449  EMOTE_RAY_TEMPDI
+00009b50: 522c 0a20 2020 2020 2020 2020 2020 2020  R,.             
+00009b60: 2020 2027 6475 6d70 5f70 6f72 745f 636f     'dump_port_co
+00009b70: 6d6d 616e 6427 3a20 6475 6d70 5f70 6f72  mmand': dump_por
+00009b80: 745f 636f 6d6d 616e 642c 0a20 2020 2020  t_command,.     
+00009b90: 2020 2020 2020 2020 2020 2023 2053 6b79             # Sky
+00009ba0: 2d69 6e74 6572 6e61 6c20 636f 6e73 7461  -internal consta
+00009bb0: 6e74 732e 0a20 2020 2020 2020 2020 2020  nts..           
+00009bc0: 2020 2020 2027 736b 795f 7261 795f 636d       'sky_ray_cm
+00009bd0: 6427 3a20 636f 6e73 7461 6e74 732e 534b  d': constants.SK
+00009be0: 595f 5241 595f 434d 442c 0a20 2020 2020  Y_RAY_CMD,.     
+00009bf0: 2020 2020 2020 2020 2020 2023 2070 6970             # pip
+00009c00: 2069 6e73 7461 6c6c 206e 6565 6473 2074   install needs t
+00009c10: 6f20 6861 7665 2070 7974 686f 6e20 656e  o have python en
+00009c20: 7620 6163 7469 7661 7465 6420 746f 206d  v activated to m
+00009c30: 616b 6520 7375 7265 0a20 2020 2020 2020  ake sure.       
+00009c40: 2020 2020 2020 2020 2023 2069 6e73 7461           # insta
+00009c50: 6c6c 6564 2070 6163 6b61 6765 7320 6172  lled packages ar
+00009c60: 6520 7769 7468 696e 2074 6865 2065 6e76  e within the env
+00009c70: 2070 6174 682e 0a20 2020 2020 2020 2020   path..         
+00009c80: 2020 2020 2020 2027 736b 795f 7069 705f         'sky_pip_
+00009c90: 636d 6427 3a20 6627 7b63 6f6e 7374 616e  cmd': f'{constan
+00009ca0: 7473 2e53 4b59 5f50 4950 5f43 4d44 7d27  ts.SKY_PIP_CMD}'
+00009cb0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00009cc0: 2020 2320 4163 7469 7661 7465 2074 6865    # Activate the
+00009cd0: 2053 6b79 5069 6c6f 7420 7275 6e74 696d   SkyPilot runtim
+00009ce0: 6520 656e 7669 726f 6e6d 656e 7420 7768  e environment wh
+00009cf0: 656e 2073 7461 7274 696e 6720 7261 790a  en starting ray.
+00009d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009d10: 2320 636c 7573 7465 722c 2073 6f20 7468  # cluster, so th
+00009d20: 6174 2072 6179 2061 7574 6f73 6361 6c65  at ray autoscale
+00009d30: 7220 6361 6e20 6163 6365 7373 2063 6c6f  r can access clo
+00009d40: 7564 2053 444b 2061 6e64 2043 4c49 730a  ud SDK and CLIs.
+00009d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009d60: 2320 6f6e 2072 656d 6f74 650a 2020 2020  # on remote.    
+00009d70: 2020 2020 2020 2020 2020 2020 2773 6b79              'sky
+00009d80: 5f61 6374 6976 6174 655f 7079 7468 6f6e  _activate_python
+00009d90: 5f65 6e76 273a 0a20 2020 2020 2020 2020  _env':.         
+00009da0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+00009db0: 616e 7473 2e41 4354 4956 4154 455f 534b  ants.ACTIVATE_SK
+00009dc0: 595f 5245 4d4f 5445 5f50 5954 484f 4e5f  Y_REMOTE_PYTHON_
+00009dd0: 454e 562c 0a20 2020 2020 2020 2020 2020  ENV,.           
+00009de0: 2020 2020 2027 7261 795f 7665 7273 696f       'ray_versio
+00009df0: 6e27 3a20 636f 6e73 7461 6e74 732e 534b  n': constants.SK
+00009e00: 595f 5245 4d4f 5445 5f52 4159 5f56 4552  Y_REMOTE_RAY_VER
+00009e10: 5349 4f4e 2c0a 2020 2020 2020 2020 2020  SION,.          
+00009e20: 2020 2020 2020 2320 436f 6d6d 616e 6420        # Command 
+00009e30: 666f 7220 7761 6974 696e 6720 7261 7920  for waiting ray 
+00009e40: 636c 7573 7465 7220 746f 2062 6520 7265  cluster to be re
+00009e50: 6164 7920 6f6e 2068 6561 642e 0a20 2020  ady on head..   
+00009e60: 2020 2020 2020 2020 2020 2020 2027 7261               'ra
+00009e70: 795f 6865 6164 5f77 6169 745f 696e 6974  y_head_wait_init
+00009e80: 6961 6c69 7a65 645f 636f 6d6d 616e 6427  ialized_command'
+00009e90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00009ea0: 2020 2020 2020 696e 7374 616e 6365 5f73        instance_s
+00009eb0: 6574 7570 2e52 4159 5f48 4541 445f 5741  etup.RAY_HEAD_WA
+00009ec0: 4954 5f49 4e49 5449 414c 495a 4544 5f43  IT_INITIALIZED_C
+00009ed0: 4f4d 4d41 4e44 2c0a 0a20 2020 2020 2020  OMMAND,..       
+00009ee0: 2020 2020 2020 2020 2023 2043 6c6f 7564           # Cloud
+00009ef0: 2063 7265 6465 6e74 6961 6c73 2066 6f72   credentials for
+00009f00: 2063 6c6f 7564 2073 746f 7261 6765 2e0a   cloud storage..
+00009f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009f20: 2763 7265 6465 6e74 6961 6c73 273a 2063  'credentials': c
+00009f30: 7265 6465 6e74 6961 6c73 2c0a 2020 2020  redentials,.    
+00009f40: 2020 2020 2020 2020 2020 2020 2320 536b              # Sk
+00009f50: 7920 7265 6d6f 7465 2075 7469 6c73 2e0a  y remote utils..
+00009f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009f70: 2773 6b79 5f72 656d 6f74 655f 7061 7468  'sky_remote_path
+00009f80: 273a 2053 4b59 5f52 454d 4f54 455f 5041  ': SKY_REMOTE_PA
+00009f90: 5448 2c0a 2020 2020 2020 2020 2020 2020  TH,.            
+00009fa0: 2020 2020 2773 6b79 5f6c 6f63 616c 5f70      'sky_local_p
+00009fb0: 6174 6827 3a20 7374 7228 6c6f 6361 6c5f  ath': str(local_
+00009fc0: 7768 6565 6c5f 7061 7468 292c 0a20 2020  wheel_path),.   
+00009fd0: 2020 2020 2020 2020 2020 2020 2023 2041               # A
+00009fe0: 6464 2079 616d 6c20 6669 6c65 2070 6174  dd yaml file pat
+00009ff0: 6820 746f 2074 6865 2074 656d 706c 6174  h to the templat
+0000a000: 6520 7661 7269 6162 6c65 732e 0a20 2020  e variables..   
+0000a010: 2020 2020 2020 2020 2020 2020 2027 736b               'sk
+0000a020: 795f 7261 795f 7961 6d6c 5f72 656d 6f74  y_ray_yaml_remot
+0000a030: 655f 7061 7468 273a 0a20 2020 2020 2020  e_path':.       
+0000a040: 2020 2020 2020 2020 2020 2020 2063 6c75               clu
+0000a050: 7374 6572 5f79 616d 6c5f 7574 696c 732e  ster_yaml_utils.
+0000a060: 534b 595f 434c 5553 5445 525f 5941 4d4c  SKY_CLUSTER_YAML
+0000a070: 5f52 454d 4f54 455f 5041 5448 2c0a 2020  _REMOTE_PATH,.  
+0000a080: 2020 2020 2020 2020 2020 2020 2020 2773                's
+0000a090: 6b79 5f72 6179 5f79 616d 6c5f 6c6f 6361  ky_ray_yaml_loca
+0000a0a0: 6c5f 7061 7468 273a 2074 6d70 5f79 616d  l_path': tmp_yam
+0000a0b0: 6c5f 7061 7468 2c0a 2020 2020 2020 2020  l_path,.        
+0000a0c0: 2020 2020 2020 2020 2773 6b79 5f76 6572          'sky_ver
+0000a0d0: 7369 6f6e 273a 2073 7472 2876 6572 7369  sion': str(versi
+0000a0e0: 6f6e 2e70 6172 7365 2873 6b79 2e5f 5f76  on.parse(sky.__v
+0000a0f0: 6572 7369 6f6e 5f5f 2929 2c0a 2020 2020  ersion__)),.    
+0000a100: 2020 2020 2020 2020 2020 2020 2773 6b79              'sky
+0000a110: 5f77 6865 656c 5f68 6173 6827 3a20 7768  _wheel_hash': wh
+0000a120: 6565 6c5f 6861 7368 2c0a 2020 2020 2020  eel_hash,.      
+0000a130: 2020 2020 2020 2020 2020 2320 4175 7468            # Auth
+0000a140: 656e 7469 6361 7469 6f6e 2028 6f70 7469  entication (opti
+0000a150: 6f6e 616c 292e 0a20 2020 2020 2020 2020  onal)..         
+0000a160: 2020 2020 2020 202a 2a61 7574 685f 636f         **auth_co
+0000a170: 6e66 6967 2c0a 2020 2020 2020 2020 2020  nfig,.          
+0000a180: 2020 7d29 2c0a 2020 2020 2020 2020 6f75    }),.        ou
+0000a190: 7470 7574 5f70 6174 683d 746d 705f 7961  tput_path=tmp_ya
+0000a1a0: 6d6c 5f70 6174 6829 0a20 2020 2063 6f6e  ml_path).    con
+0000a1b0: 6669 675f 6469 6374 5b27 636c 7573 7465  fig_dict['cluste
+0000a1c0: 725f 6e61 6d65 275d 203d 2063 6c75 7374  r_name'] = clust
+0000a1d0: 6572 5f6e 616d 650a 2020 2020 636f 6e66  er_name.    conf
+0000a1e0: 6967 5f64 6963 745b 2772 6179 275d 203d  ig_dict['ray'] =
+0000a1f0: 2079 616d 6c5f 7061 7468 0a20 2020 2069   yaml_path.    i
+0000a200: 6620 6472 7972 756e 3a0a 2020 2020 2020  f dryrun:.      
+0000a210: 2020 2320 4966 2064 7279 7275 6e2c 2072    # If dryrun, r
+0000a220: 6574 7572 6e20 7468 6520 756e 6669 6e69  eturn the unfini
+0000a230: 7368 6564 2074 6d70 2079 616d 6c20 7061  shed tmp yaml pa
+0000a240: 7468 2e0a 2020 2020 2020 2020 636f 6e66  th..        conf
+0000a250: 6967 5f64 6963 745b 2772 6179 275d 203d  ig_dict['ray'] =
+0000a260: 2074 6d70 5f79 616d 6c5f 7061 7468 0a20   tmp_yaml_path. 
+0000a270: 2020 2020 2020 2072 6574 7572 6e20 636f         return co
+0000a280: 6e66 6967 5f64 6963 740a 2020 2020 5f61  nfig_dict.    _a
+0000a290: 6464 5f61 7574 685f 746f 5f63 6c75 7374  dd_auth_to_clust
+0000a2a0: 6572 5f63 6f6e 6669 6728 636c 6f75 642c  er_config(cloud,
+0000a2b0: 2074 6d70 5f79 616d 6c5f 7061 7468 290a   tmp_yaml_path).
+0000a2c0: 0a20 2020 2023 2041 6464 206b 7562 6572  .    # Add kuber
+0000a2d0: 6e65 7465 7320 636f 6e66 6967 2066 6965  netes config fie
+0000a2e0: 6c64 7320 6672 6f6d 207e 2f2e 736b 792f  lds from ~/.sky/
+0000a2f0: 636f 6e66 6967 0a20 2020 2069 6620 6973  config.    if is
+0000a300: 696e 7374 616e 6365 2863 6c6f 7564 2c20  instance(cloud, 
+0000a310: 636c 6f75 6473 2e4b 7562 6572 6e65 7465  clouds.Kubernete
+0000a320: 7329 3a0a 2020 2020 2020 2020 6b75 6265  s):.        kube
+0000a330: 726e 6574 6573 5f75 7469 6c73 2e63 6f6d  rnetes_utils.com
+0000a340: 6269 6e65 5f70 6f64 5f63 6f6e 6669 675f  bine_pod_config_
+0000a350: 6669 656c 6473 2874 6d70 5f79 616d 6c5f  fields(tmp_yaml_
+0000a360: 7061 7468 290a 2020 2020 2020 2020 6b75  path).        ku
+0000a370: 6265 726e 6574 6573 5f75 7469 6c73 2e63  bernetes_utils.c
+0000a380: 6f6d 6269 6e65 5f6d 6574 6164 6174 615f  ombine_metadata_
+0000a390: 6669 656c 6473 2874 6d70 5f79 616d 6c5f  fields(tmp_yaml_
+0000a3a0: 7061 7468 290a 0a20 2020 2023 2052 6573  path)..    # Res
+0000a3b0: 746f 7265 2074 6865 206f 6c64 2079 616d  tore the old yam
+0000a3c0: 6c20 636f 6e74 656e 7420 666f 7220 6261  l content for ba
+0000a3d0: 636b 7761 7264 2063 6f6d 7061 7469 6269  ckward compatibi
+0000a3e0: 6c69 7479 2e0a 2020 2020 6966 206f 732e  lity..    if os.
+0000a3f0: 7061 7468 2e65 7869 7374 7328 7961 6d6c  path.exists(yaml
+0000a400: 5f70 6174 6829 2061 6e64 206b 6565 705f  _path) and keep_
+0000a410: 6c61 756e 6368 5f66 6965 6c64 735f 696e  launch_fields_in
+0000a420: 5f65 7869 7374 696e 675f 636f 6e66 6967  _existing_config
+0000a430: 3a0a 2020 2020 2020 2020 7769 7468 206f  :.        with o
+0000a440: 7065 6e28 7961 6d6c 5f70 6174 682c 2027  pen(yaml_path, '
+0000a450: 7227 2c20 656e 636f 6469 6e67 3d27 7574  r', encoding='ut
+0000a460: 662d 3827 2920 6173 2066 3a0a 2020 2020  f-8') as f:.    
+0000a470: 2020 2020 2020 2020 6f6c 645f 7961 6d6c          old_yaml
+0000a480: 5f63 6f6e 7465 6e74 203d 2066 2e72 6561  _content = f.rea
+0000a490: 6428 290a 2020 2020 2020 2020 7769 7468  d().        with
+0000a4a0: 206f 7065 6e28 746d 705f 7961 6d6c 5f70   open(tmp_yaml_p
+0000a4b0: 6174 682c 2027 7227 2c20 656e 636f 6469  ath, 'r', encodi
+0000a4c0: 6e67 3d27 7574 662d 3827 2920 6173 2066  ng='utf-8') as f
+0000a4d0: 3a0a 2020 2020 2020 2020 2020 2020 6e65  :.            ne
+0000a4e0: 775f 7961 6d6c 5f63 6f6e 7465 6e74 203d  w_yaml_content =
+0000a4f0: 2066 2e72 6561 6428 290a 2020 2020 2020   f.read().      
+0000a500: 2020 7265 7374 6f72 6564 5f79 616d 6c5f    restored_yaml_
+0000a510: 636f 6e74 656e 7420 3d20 5f72 6570 6c61  content = _repla
+0000a520: 6365 5f79 616d 6c5f 6469 6374 7328 0a20  ce_yaml_dicts(. 
+0000a530: 2020 2020 2020 2020 2020 206e 6577 5f79             new_y
+0000a540: 616d 6c5f 636f 6e74 656e 742c 206f 6c64  aml_content, old
+0000a550: 5f79 616d 6c5f 636f 6e74 656e 742c 0a20  _yaml_content,. 
+0000a560: 2020 2020 2020 2020 2020 205f 5241 595f             _RAY_
+0000a570: 5941 4d4c 5f4b 4559 535f 544f 5f52 4553  YAML_KEYS_TO_RES
+0000a580: 544f 5245 5f46 4f52 5f42 4143 4b5f 434f  TORE_FOR_BACK_CO
+0000a590: 4d50 4154 4942 494c 4954 592c 0a20 2020  MPATIBILITY,.   
+0000a5a0: 2020 2020 2020 2020 205f 5241 595f 5941           _RAY_YA
+0000a5b0: 4d4c 5f4b 4559 535f 544f 5f52 4553 544f  ML_KEYS_TO_RESTO
+0000a5c0: 5245 5f45 5843 4550 5449 4f4e 5329 0a20  RE_EXCEPTIONS). 
+0000a5d0: 2020 2020 2020 2077 6974 6820 6f70 656e         with open
+0000a5e0: 2874 6d70 5f79 616d 6c5f 7061 7468 2c20  (tmp_yaml_path, 
+0000a5f0: 2777 272c 2065 6e63 6f64 696e 673d 2775  'w', encoding='u
+0000a600: 7466 2d38 2729 2061 7320 663a 0a20 2020  tf-8') as f:.   
+0000a610: 2020 2020 2020 2020 2066 2e77 7269 7465           f.write
+0000a620: 2872 6573 746f 7265 645f 7961 6d6c 5f63  (restored_yaml_c
+0000a630: 6f6e 7465 6e74 290a 0a20 2020 2063 6f6e  ontent)..    con
+0000a640: 6669 675f 6469 6374 5b27 636c 7573 7465  fig_dict['cluste
+0000a650: 725f 6e61 6d65 5f6f 6e5f 636c 6f75 6427  r_name_on_cloud'
+0000a660: 5d20 3d20 636c 7573 7465 725f 6e61 6d65  ] = cluster_name
+0000a670: 5f6f 6e5f 636c 6f75 640a 0a20 2020 2023  _on_cloud..    #
+0000a680: 204f 7074 696d 697a 6174 696f 6e3a 2063   Optimization: c
+0000a690: 6f70 7920 7468 6520 636f 6e74 656e 7473  opy the contents
+0000a6a0: 206f 6620 736f 7572 6365 2066 696c 6573   of source files
+0000a6b0: 2069 6e20 6669 6c65 5f6d 6f75 6e74 7320   in file_mounts 
+0000a6c0: 746f 2061 0a20 2020 2023 2073 7065 6369  to a.    # speci
+0000a6d0: 616c 2064 6972 2c20 616e 6420 7570 6c6f  al dir, and uplo
+0000a6e0: 6164 2074 6861 7420 6173 2074 6865 206f  ad that as the o
+0000a6f0: 6e6c 7920 6669 6c65 5f6d 6f75 6e74 2069  nly file_mount i
+0000a700: 6e73 7465 6164 2e20 4465 6c61 790a 2020  nstead. Delay.  
+0000a710: 2020 2320 6361 6c6c 696e 6720 7468 6973    # calling this
+0000a720: 206f 7074 696d 697a 6174 696f 6e20 756e   optimization un
+0000a730: 7469 6c20 6e6f 772c 2077 6865 6e20 616c  til now, when al
+0000a740: 6c20 736f 7572 6365 2066 696c 6573 2068  l source files h
+0000a750: 6176 6520 6265 656e 0a20 2020 2023 2077  ave been.    # w
+0000a760: 7269 7474 656e 2061 6e64 2074 6865 6972  ritten and their
+0000a770: 2063 6f6e 7465 6e74 7320 6669 6e61 6c69   contents finali
+0000a780: 7a65 642e 0a20 2020 2023 0a20 2020 2023  zed..    #.    #
+0000a790: 204e 6f74 6520 7468 6174 2074 6865 2072   Note that the r
+0000a7a0: 6179 2079 616d 6c20 6669 6c65 2077 696c  ay yaml file wil
+0000a7b0: 6c20 6265 2063 6f70 6965 6420 696e 746f  l be copied into
+0000a7c0: 2074 6861 7420 7370 6563 6961 6c20 6469   that special di
+0000a7d0: 7220 2869 2e65 2e2c 0a20 2020 2023 2075  r (i.e.,.    # u
+0000a7e0: 706c 6f61 6465 6420 6173 2070 6172 7420  ploaded as part 
+0000a7f0: 6f66 2074 6865 2066 696c 655f 6d6f 756e  of the file_moun
+0000a800: 7473 292c 2073 6f20 7468 6520 7265 7374  ts), so the rest
+0000a810: 6f72 6520 666f 7220 6261 636b 7761 7264  ore for backward
+0000a820: 0a20 2020 2023 2063 6f6d 7061 7469 6269  .    # compatibi
+0000a830: 6c69 7479 2073 686f 756c 6420 676f 2062  lity should go b
+0000a840: 6566 6f72 6520 7468 6973 2063 616c 6c2e  efore this call.
+0000a850: 0a20 2020 205f 6f70 7469 6d69 7a65 5f66  .    _optimize_f
+0000a860: 696c 655f 6d6f 756e 7473 2874 6d70 5f79  ile_mounts(tmp_y
+0000a870: 616d 6c5f 7061 7468 290a 0a20 2020 2023  aml_path)..    #
+0000a880: 2052 656e 616d 6520 7468 6520 746d 7020   Rename the tmp 
+0000a890: 6669 6c65 2074 6f20 7468 6520 6669 6e61  file to the fina
+0000a8a0: 6c20 5941 4d4c 2070 6174 682e 0a20 2020  l YAML path..   
+0000a8b0: 206f 732e 7265 6e61 6d65 2874 6d70 5f79   os.rename(tmp_y
+0000a8c0: 616d 6c5f 7061 7468 2c20 7961 6d6c 5f70  aml_path, yaml_p
+0000a8d0: 6174 6829 0a20 2020 2075 7361 6765 5f6c  ath).    usage_l
+0000a8e0: 6962 2e6d 6573 7361 6765 732e 7573 6167  ib.messages.usag
+0000a8f0: 652e 7570 6461 7465 5f72 6179 5f79 616d  e.update_ray_yam
+0000a900: 6c28 7961 6d6c 5f70 6174 6829 0a20 2020  l(yaml_path).   
+0000a910: 2072 6574 7572 6e20 636f 6e66 6967 5f64   return config_d
+0000a920: 6963 740a 0a0a 6465 6620 5f61 6464 5f61  ict...def _add_a
+0000a930: 7574 685f 746f 5f63 6c75 7374 6572 5f63  uth_to_cluster_c
+0000a940: 6f6e 6669 6728 636c 6f75 643a 2063 6c6f  onfig(cloud: clo
+0000a950: 7564 732e 436c 6f75 642c 2063 6c75 7374  uds.Cloud, clust
+0000a960: 6572 5f63 6f6e 6669 675f 6669 6c65 3a20  er_config_file: 
+0000a970: 7374 7229 3a0a 2020 2020 2222 2241 6464  str):.    """Add
+0000a980: 7320 5353 4820 6b65 7920 696e 666f 2074  s SSH key info t
+0000a990: 6f20 7468 6520 636c 7573 7465 7220 636f  o the cluster co
+0000a9a0: 6e66 6967 2e0a 0a20 2020 2054 6869 7320  nfig...    This 
+0000a9b0: 6675 6e63 7469 6f6e 2773 206f 7574 7075  function's outpu
+0000a9c0: 7420 7265 6d6f 7665 7320 636f 6d6d 656e  t removes commen
+0000a9d0: 7473 2069 6e63 6c75 6465 6420 696e 2074  ts included in t
+0000a9e0: 6865 206a 696e 6a61 3220 7465 6d70 6c61  he jinja2 templa
+0000a9f0: 7465 2e0a 2020 2020 2222 220a 2020 2020  te..    """.    
+0000aa00: 636f 6e66 6967 203d 2063 6f6d 6d6f 6e5f  config = common_
+0000aa10: 7574 696c 732e 7265 6164 5f79 616d 6c28  utils.read_yaml(
+0000aa20: 636c 7573 7465 725f 636f 6e66 6967 5f66  cluster_config_f
+0000aa30: 696c 6529 0a20 2020 2023 2043 6865 636b  ile).    # Check
+0000aa40: 2074 6865 2061 7661 696c 6162 696c 6974   the availabilit
+0000aa50: 7920 6f66 2074 6865 2063 6c6f 7564 2074  y of the cloud t
+0000aa60: 7970 652e 0a20 2020 2069 6620 6973 696e  ype..    if isin
+0000aa70: 7374 616e 6365 2863 6c6f 7564 2c20 2863  stance(cloud, (c
+0000aa80: 6c6f 7564 732e 4157 532c 2063 6c6f 7564  louds.AWS, cloud
+0000aa90: 732e 4f43 492c 2063 6c6f 7564 732e 5343  s.OCI, clouds.SC
+0000aaa0: 502c 2063 6c6f 7564 732e 5673 7068 6572  P, clouds.Vspher
+0000aab0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+0000aac0: 2020 2020 2020 2020 2020 2020 2063 6c6f               clo
+0000aad0: 7564 732e 4375 646f 2c20 636c 6f75 6473  uds.Cudo, clouds
+0000aae0: 2e50 6170 6572 7370 6163 6529 293a 0a20  .Paperspace)):. 
+0000aaf0: 2020 2020 2020 2063 6f6e 6669 6720 3d20         config = 
+0000ab00: 6175 7468 2e63 6f6e 6669 6775 7265 5f73  auth.configure_s
+0000ab10: 7368 5f69 6e66 6f28 636f 6e66 6967 290a  sh_info(config).
+0000ab20: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
+0000ab30: 6e63 6528 636c 6f75 642c 2063 6c6f 7564  nce(cloud, cloud
+0000ab40: 732e 4743 5029 3a0a 2020 2020 2020 2020  s.GCP):.        
+0000ab50: 636f 6e66 6967 203d 2061 7574 682e 7365  config = auth.se
+0000ab60: 7475 705f 6763 705f 6175 7468 656e 7469  tup_gcp_authenti
+0000ab70: 6361 7469 6f6e 2863 6f6e 6669 6729 0a20  cation(config). 
+0000ab80: 2020 2065 6c69 6620 6973 696e 7374 616e     elif isinstan
+0000ab90: 6365 2863 6c6f 7564 2c20 636c 6f75 6473  ce(cloud, clouds
+0000aba0: 2e41 7a75 7265 293a 0a20 2020 2020 2020  .Azure):.       
+0000abb0: 2063 6f6e 6669 6720 3d20 6175 7468 2e73   config = auth.s
+0000abc0: 6574 7570 5f61 7a75 7265 5f61 7574 6865  etup_azure_authe
+0000abd0: 6e74 6963 6174 696f 6e28 636f 6e66 6967  ntication(config
+0000abe0: 290a 2020 2020 656c 6966 2069 7369 6e73  ).    elif isins
+0000abf0: 7461 6e63 6528 636c 6f75 642c 2063 6c6f  tance(cloud, clo
+0000ac00: 7564 732e 4c61 6d62 6461 293a 0a20 2020  uds.Lambda):.   
+0000ac10: 2020 2020 2063 6f6e 6669 6720 3d20 6175       config = au
+0000ac20: 7468 2e73 6574 7570 5f6c 616d 6264 615f  th.setup_lambda_
+0000ac30: 6175 7468 656e 7469 6361 7469 6f6e 2863  authentication(c
+0000ac40: 6f6e 6669 6729 0a20 2020 2065 6c69 6620  onfig).    elif 
+0000ac50: 6973 696e 7374 616e 6365 2863 6c6f 7564  isinstance(cloud
+0000ac60: 2c20 636c 6f75 6473 2e4b 7562 6572 6e65  , clouds.Kuberne
+0000ac70: 7465 7329 3a0a 2020 2020 2020 2020 636f  tes):.        co
+0000ac80: 6e66 6967 203d 2061 7574 682e 7365 7475  nfig = auth.setu
+0000ac90: 705f 6b75 6265 726e 6574 6573 5f61 7574  p_kubernetes_aut
+0000aca0: 6865 6e74 6963 6174 696f 6e28 636f 6e66  hentication(conf
+0000acb0: 6967 290a 2020 2020 656c 6966 2069 7369  ig).    elif isi
+0000acc0: 6e73 7461 6e63 6528 636c 6f75 642c 2063  nstance(cloud, c
+0000acd0: 6c6f 7564 732e 4942 4d29 3a0a 2020 2020  louds.IBM):.    
+0000ace0: 2020 2020 636f 6e66 6967 203d 2061 7574      config = aut
+0000acf0: 682e 7365 7475 705f 6962 6d5f 6175 7468  h.setup_ibm_auth
+0000ad00: 656e 7469 6361 7469 6f6e 2863 6f6e 6669  entication(confi
+0000ad10: 6729 0a20 2020 2065 6c69 6620 6973 696e  g).    elif isin
+0000ad20: 7374 616e 6365 2863 6c6f 7564 2c20 636c  stance(cloud, cl
+0000ad30: 6f75 6473 2e52 756e 506f 6429 3a0a 2020  ouds.RunPod):.  
+0000ad40: 2020 2020 2020 636f 6e66 6967 203d 2061        config = a
+0000ad50: 7574 682e 7365 7475 705f 7275 6e70 6f64  uth.setup_runpod
+0000ad60: 5f61 7574 6865 6e74 6963 6174 696f 6e28  _authentication(
+0000ad70: 636f 6e66 6967 290a 2020 2020 656c 6966  config).    elif
+0000ad80: 2069 7369 6e73 7461 6e63 6528 636c 6f75   isinstance(clou
+0000ad90: 642c 2063 6c6f 7564 732e 466c 7569 6473  d, clouds.Fluids
+0000ada0: 7461 636b 293a 0a20 2020 2020 2020 2063  tack):.        c
+0000adb0: 6f6e 6669 6720 3d20 6175 7468 2e73 6574  onfig = auth.set
+0000adc0: 7570 5f66 6c75 6964 7374 6163 6b5f 6175  up_fluidstack_au
+0000add0: 7468 656e 7469 6361 7469 6f6e 2863 6f6e  thentication(con
+0000ade0: 6669 6729 0a20 2020 2065 6c73 653a 0a20  fig).    else:. 
+0000adf0: 2020 2020 2020 2061 7373 6572 7420 4661         assert Fa
+0000ae00: 6c73 652c 2063 6c6f 7564 0a20 2020 2063  lse, cloud.    c
+0000ae10: 6f6d 6d6f 6e5f 7574 696c 732e 6475 6d70  ommon_utils.dump
+0000ae20: 5f79 616d 6c28 636c 7573 7465 725f 636f  _yaml(cluster_co
+0000ae30: 6e66 6967 5f66 696c 652c 2063 6f6e 6669  nfig_file, confi
+0000ae40: 6729 0a0a 0a64 6566 2067 6574 5f72 756e  g)...def get_run
+0000ae50: 5f74 696d 6573 7461 6d70 2829 202d 3e20  _timestamp() -> 
+0000ae60: 7374 723a 0a20 2020 2072 6574 7572 6e20  str:.    return 
+0000ae70: 2773 6b79 2d27 202b 2064 6174 6574 696d  'sky-' + datetim
+0000ae80: 652e 6e6f 7728 292e 7374 7266 7469 6d65  e.now().strftime
+0000ae90: 2827 2559 2d25 6d2d 2564 2d25 482d 254d  ('%Y-%m-%d-%H-%M
+0000aea0: 2d25 532d 2566 2729 0a0a 0a64 6566 2067  -%S-%f')...def g
+0000aeb0: 6574 5f74 696d 6573 7461 6d70 5f66 726f  et_timestamp_fro
+0000aec0: 6d5f 7275 6e5f 7469 6d65 7374 616d 7028  m_run_timestamp(
+0000aed0: 7275 6e5f 7469 6d65 7374 616d 703a 2073  run_timestamp: s
+0000aee0: 7472 2920 2d3e 2066 6c6f 6174 3a0a 2020  tr) -> float:.  
+0000aef0: 2020 7265 7475 726e 2064 6174 6574 696d    return datetim
+0000af00: 652e 7374 7270 7469 6d65 280a 2020 2020  e.strptime(.    
+0000af10: 2020 2020 7275 6e5f 7469 6d65 7374 616d      run_timestam
+0000af20: 702e 7061 7274 6974 696f 6e28 272d 2729  p.partition('-')
+0000af30: 5b32 5d2c 2027 2559 2d25 6d2d 2564 2d25  [2], '%Y-%m-%d-%
+0000af40: 482d 254d 2d25 532d 2566 2729 2e74 696d  H-%M-%S-%f').tim
+0000af50: 6573 7461 6d70 2829 0a0a 0a64 6566 205f  estamp()...def _
+0000af60: 636f 756e 745f 6865 616c 7468 795f 6e6f  count_healthy_no
+0000af70: 6465 735f 6672 6f6d 5f72 6179 286f 7574  des_from_ray(out
+0000af80: 7075 743a 2073 7472 2c0a 2020 2020 2020  put: str,.      
+0000af90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000afa0: 2020 2020 2020 2020 2020 2020 6973 5f6c              is_l
+0000afb0: 6f63 616c 5f63 6c6f 7564 3a20 626f 6f6c  ocal_cloud: bool
+0000afc0: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
+0000afd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000afe0: 2020 2020 2020 2020 2020 2920 2d3e 2054            ) -> T
+0000aff0: 7570 6c65 5b69 6e74 2c20 696e 745d 3a0a  uple[int, int]:.
+0000b000: 2020 2020 2222 2243 6f75 6e74 2074 6865      """Count the
+0000b010: 206e 756d 6265 7220 6f66 2068 6561 6c74   number of healt
+0000b020: 6879 206e 6f64 6573 2066 726f 6d20 7468  hy nodes from th
+0000b030: 6520 6f75 7470 7574 206f 6620 6072 6179  e output of `ray
+0000b040: 2073 7461 7475 7360 2e22 2222 0a0a 2020   status`."""..  
+0000b050: 2020 6465 6620 6765 745f 7265 6164 795f    def get_ready_
+0000b060: 6e6f 6465 735f 636f 756e 7473 2870 6174  nodes_counts(pat
+0000b070: 7465 726e 2c20 6f75 7470 7574 293a 0a20  tern, output):. 
+0000b080: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
+0000b090: 7061 7474 6572 6e2e 6669 6e64 616c 6c28  pattern.findall(
+0000b0a0: 6f75 7470 7574 290a 2020 2020 2020 2020  output).        
+0000b0b0: 6966 206e 6f74 2072 6573 756c 743a 0a20  if not result:. 
+0000b0c0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000b0d0: 6e20 300a 2020 2020 2020 2020 6173 7365  n 0.        asse
+0000b0e0: 7274 206c 656e 2872 6573 756c 7429 203d  rt len(result) =
+0000b0f0: 3d20 312c 2072 6573 756c 740a 2020 2020  = 1, result.    
+0000b100: 2020 2020 7265 7475 726e 2069 6e74 2872      return int(r
+0000b110: 6573 756c 745b 305d 290a 0a20 2020 2023  esult[0])..    #
+0000b120: 2043 6865 636b 2069 6620 7468 6520 7261   Check if the ra
+0000b130: 7920 636c 7573 7465 7220 6973 2073 7461  y cluster is sta
+0000b140: 7274 6564 2077 6974 6820 7261 7920 6175  rted with ray au
+0000b150: 746f 7363 616c 6572 2e20 496e 206e 6577  toscaler. In new
+0000b160: 0a20 2020 2023 2070 726f 7669 7369 6f6e  .    # provision
+0000b170: 6572 2028 2331 3730 3229 2061 6e64 206c  er (#1702) and l
+0000b180: 6f63 616c 206d 6f64 652c 2077 6520 7374  ocal mode, we st
+0000b190: 6172 7465 6420 7468 6520 7261 7920 636c  arted the ray cl
+0000b1a0: 7573 7465 7220 7769 7468 6f75 7420 7261  uster without ra
+0000b1b0: 790a 2020 2020 2320 6175 746f 7363 616c  y.    # autoscal
+0000b1c0: 6572 2e0a 2020 2020 2320 4966 2072 6179  er..    # If ray
+0000b1d0: 2063 6c75 7374 6572 2069 7320 7374 6172   cluster is star
+0000b1e0: 7465 6420 7769 7468 2072 6179 2061 7574  ted with ray aut
+0000b1f0: 6f73 6361 6c65 722c 2074 6865 206f 7574  oscaler, the out
+0000b200: 7075 7420 7769 6c6c 2062 653a 0a20 2020  put will be:.   
+0000b210: 2023 2020 3120 7261 792e 6865 6164 2e64   #  1 ray.head.d
+0000b220: 6566 6175 6c74 0a20 2020 2023 2020 2e2e  efault.    #  ..
+0000b230: 2e0a 2020 2020 2320 544f 444f 287a 6877  ..    # TODO(zhw
+0000b240: 7529 3a20 6f6e 6365 2077 6520 6465 7072  u): once we depr
+0000b250: 6563 6174 6520 7468 6520 6f6c 6420 7072  ecate the old pr
+0000b260: 6f76 6973 696f 6e65 722c 2077 6520 6361  ovisioner, we ca
+0000b270: 6e20 7265 6d6f 7665 2074 6869 730a 2020  n remove this.  
+0000b280: 2020 2320 6368 6563 6b2e 0a20 2020 2072    # check..    r
+0000b290: 6179 5f61 7574 6f73 6361 6c65 725f 6865  ay_autoscaler_he
+0000b2a0: 6164 203d 2067 6574 5f72 6561 6479 5f6e  ad = get_ready_n
+0000b2b0: 6f64 6573 5f63 6f75 6e74 7328 5f4c 4155  odes_counts(_LAU
+0000b2c0: 4e43 4845 445f 4845 4144 5f50 4154 5445  NCHED_HEAD_PATTE
+0000b2d0: 524e 2c20 6f75 7470 7574 290a 2020 2020  RN, output).    
+0000b2e0: 6973 5f6c 6f63 616c 5f72 6179 5f63 6c75  is_local_ray_clu
+0000b2f0: 7374 6572 203d 2072 6179 5f61 7574 6f73  ster = ray_autos
+0000b300: 6361 6c65 725f 6865 6164 203d 3d20 300a  caler_head == 0.
+0000b310: 0a20 2020 2069 6620 6973 5f6c 6f63 616c  .    if is_local
+0000b320: 5f72 6179 5f63 6c75 7374 6572 206f 7220  _ray_cluster or 
+0000b330: 6973 5f6c 6f63 616c 5f63 6c6f 7564 3a0a  is_local_cloud:.
+0000b340: 2020 2020 2020 2020 2320 5261 7920 636c          # Ray cl
+0000b350: 7573 7465 7220 6973 206c 6175 6e63 6865  uster is launche
+0000b360: 6420 7769 7468 206e 6577 2070 726f 7669  d with new provi
+0000b370: 7369 6f6e 6572 0a20 2020 2020 2020 2023  sioner.        #
+0000b380: 2046 6f72 206e 6577 2070 726f 7669 7369   For new provisi
+0000b390: 6f6e 6572 2061 6e64 206c 6f63 616c 206d  oner and local m
+0000b3a0: 6f64 652c 2074 6865 206f 7574 7075 7420  ode, the output 
+0000b3b0: 7769 6c6c 2062 653a 0a20 2020 2020 2020  will be:.       
+0000b3c0: 2023 2020 3120 6e6f 6465 5f78 7878 780a   #  1 node_xxxx.
+0000b3d0: 2020 2020 2020 2020 2320 2031 206e 6f64          #  1 nod
+0000b3e0: 655f 7878 7878 0a20 2020 2020 2020 2072  e_xxxx.        r
+0000b3f0: 6561 6479 5f68 6561 6420 3d20 300a 2020  eady_head = 0.  
+0000b400: 2020 2020 2020 7265 6164 795f 776f 726b        ready_work
+0000b410: 6572 7320 3d20 5f4c 4155 4e43 4845 445f  ers = _LAUNCHED_
+0000b420: 4c4f 4341 4c5f 574f 524b 4552 5f50 4154  LOCAL_WORKER_PAT
+0000b430: 5445 524e 2e66 696e 6461 6c6c 286f 7574  TERN.findall(out
+0000b440: 7075 7429 0a20 2020 2020 2020 2072 6561  put).        rea
+0000b450: 6479 5f77 6f72 6b65 7273 203d 206c 656e  dy_workers = len
+0000b460: 2872 6561 6479 5f77 6f72 6b65 7273 290a  (ready_workers).
+0000b470: 2020 2020 2020 2020 6966 2069 735f 6c6f          if is_lo
+0000b480: 6361 6c5f 7261 795f 636c 7573 7465 723a  cal_ray_cluster:
+0000b490: 0a20 2020 2020 2020 2020 2020 2072 6561  .            rea
+0000b4a0: 6479 5f68 6561 6420 3d20 310a 2020 2020  dy_head = 1.    
+0000b4b0: 2020 2020 2020 2020 7265 6164 795f 776f          ready_wo
+0000b4c0: 726b 6572 7320 2d3d 2031 0a20 2020 2020  rkers -= 1.     
+0000b4d0: 2020 2072 6574 7572 6e20 7265 6164 795f     return ready_
+0000b4e0: 6865 6164 2c20 7265 6164 795f 776f 726b  head, ready_work
+0000b4f0: 6572 730a 0a20 2020 2023 2043 6f75 6e74  ers..    # Count
+0000b500: 206e 756d 6265 7220 6f66 206e 6f64 6573   number of nodes
+0000b510: 2062 7920 7061 7273 696e 6720 7468 6520   by parsing the 
+0000b520: 6f75 7470 7574 206f 6620 6072 6179 2073  output of `ray s
+0000b530: 7461 7475 7360 2e20 5468 6520 6f75 7470  tatus`. The outp
+0000b540: 7574 0a20 2020 2023 206c 6f6f 6b73 206c  ut.    # looks l
+0000b550: 696b 653a 0a20 2020 2023 2020 2031 2072  ike:.    #   1 r
+0000b560: 6179 2e68 6561 642e 6465 6661 756c 740a  ay.head.default.
+0000b570: 2020 2020 2320 2020 3220 7261 792e 776f      #   2 ray.wo
+0000b580: 726b 6572 2e64 6566 6175 6c74 0a20 2020  rker.default.   
+0000b590: 2072 6561 6479 5f68 6561 6420 3d20 7261   ready_head = ra
+0000b5a0: 795f 6175 746f 7363 616c 6572 5f68 6561  y_autoscaler_hea
+0000b5b0: 640a 2020 2020 7265 6164 795f 776f 726b  d.    ready_work
+0000b5c0: 6572 7320 3d20 6765 745f 7265 6164 795f  ers = get_ready_
+0000b5d0: 6e6f 6465 735f 636f 756e 7473 285f 4c41  nodes_counts(_LA
+0000b5e0: 554e 4348 4544 5f57 4f52 4b45 525f 5041  UNCHED_WORKER_PA
+0000b5f0: 5454 4552 4e2c 206f 7574 7075 7429 0a20  TTERN, output). 
+0000b600: 2020 2072 6561 6479 5f72 6573 6572 7665     ready_reserve
+0000b610: 645f 776f 726b 6572 7320 3d20 6765 745f  d_workers = get_
+0000b620: 7265 6164 795f 6e6f 6465 735f 636f 756e  ready_nodes_coun
+0000b630: 7473 280a 2020 2020 2020 2020 5f4c 4155  ts(.        _LAU
+0000b640: 4e43 4845 445f 5245 5345 5256 4544 5f57  NCHED_RESERVED_W
+0000b650: 4f52 4b45 525f 5041 5454 4552 4e2c 206f  ORKER_PATTERN, o
+0000b660: 7574 7075 7429 0a20 2020 2072 6561 6479  utput).    ready
+0000b670: 5f77 6f72 6b65 7273 202b 3d20 7265 6164  _workers += read
+0000b680: 795f 7265 7365 7276 6564 5f77 6f72 6b65  y_reserved_worke
+0000b690: 7273 0a20 2020 2061 7373 6572 7420 7265  rs.    assert re
+0000b6a0: 6164 795f 6865 6164 203c 3d20 312c 2066  ady_head <= 1, f
+0000b6b0: 2723 6865 6164 206e 6f64 6520 7368 6f75  '#head node shou
+0000b6c0: 6c64 2062 6520 3c3d 3120 2847 6f74 207b  ld be <=1 (Got {
+0000b6d0: 7265 6164 795f 6865 6164 7d29 2e27 0a20  ready_head}).'. 
+0000b6e0: 2020 2072 6574 7572 6e20 7265 6164 795f     return ready_
+0000b6f0: 6865 6164 2c20 7265 6164 795f 776f 726b  head, ready_work
+0000b700: 6572 730a 0a0a 6465 6620 6765 745f 646f  ers...def get_do
+0000b710: 636b 6572 5f75 7365 7228 6970 3a20 7374  cker_user(ip: st
+0000b720: 722c 2063 6c75 7374 6572 5f63 6f6e 6669  r, cluster_confi
+0000b730: 675f 6669 6c65 3a20 7374 7229 202d 3e20  g_file: str) -> 
+0000b740: 7374 723a 0a20 2020 2022 2222 4669 6e64  str:.    """Find
+0000b750: 2064 6f63 6b65 7220 636f 6e74 6169 6e65   docker containe
+0000b760: 7220 7573 6572 6e61 6d65 2e22 2222 0a20  r username.""". 
+0000b770: 2020 2073 7368 5f63 7265 6465 6e74 6961     ssh_credentia
+0000b780: 6c73 203d 2073 7368 5f63 7265 6465 6e74  ls = ssh_credent
+0000b790: 6961 6c5f 6672 6f6d 5f79 616d 6c28 636c  ial_from_yaml(cl
+0000b7a0: 7573 7465 725f 636f 6e66 6967 5f66 696c  uster_config_fil
+0000b7b0: 6529 0a20 2020 2072 756e 6e65 7220 3d20  e).    runner = 
+0000b7c0: 636f 6d6d 616e 645f 7275 6e6e 6572 2e53  command_runner.S
+0000b7d0: 5348 436f 6d6d 616e 6452 756e 6e65 7228  SHCommandRunner(
+0000b7e0: 6e6f 6465 3d28 6970 2c20 3232 292c 202a  node=(ip, 22), *
 0000b7f0: 2a73 7368 5f63 7265 6465 6e74 6961 6c73  *ssh_credentials
-0000b800: 290a 2020 2020 7769 7468 2072 6963 685f  ).    with rich_
-0000b810: 7574 696c 732e 7361 6665 5f73 7461 7475  utils.safe_statu
-0000b820: 7328 0a20 2020 2020 2020 2020 2020 2027  s(.            '
-0000b830: 5b62 6f6c 6420 6379 616e 5d57 6169 7469  [bold cyan]Waiti
-0000b840: 6e67 2066 6f72 2077 6f72 6b65 7273 2e2e  ng for workers..
-0000b850: 2e27 2920 6173 2077 6f72 6b65 725f 7374  .') as worker_st
-0000b860: 6174 7573 3a0a 2020 2020 2020 2020 7768  atus:.        wh
-0000b870: 696c 6520 5472 7565 3a0a 2020 2020 2020  ile True:.      
-0000b880: 2020 2020 2020 7263 2c20 6f75 7470 7574        rc, output
-0000b890: 2c20 7374 6465 7272 203d 2072 756e 6e65  , stderr = runne
-0000b8a0: 722e 7275 6e28 0a20 2020 2020 2020 2020  r.run(.         
-0000b8b0: 2020 2020 2020 2069 6e73 7461 6e63 655f         instance_
-0000b8c0: 7365 7475 702e 5241 595f 5354 4154 5553  setup.RAY_STATUS
-0000b8d0: 5f57 4954 485f 534b 595f 5241 595f 504f  _WITH_SKY_RAY_PO
-0000b8e0: 5254 5f43 4f4d 4d41 4e44 2c0a 2020 2020  RT_COMMAND,.    
-0000b8f0: 2020 2020 2020 2020 2020 2020 6c6f 675f              log_
-0000b900: 7061 7468 3d6c 6f67 5f70 6174 682c 0a20  path=log_path,. 
-0000b910: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000b920: 7472 6561 6d5f 6c6f 6773 3d46 616c 7365  tream_logs=False
-0000b930: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000b940: 2020 7265 7175 6972 655f 6f75 7470 7574    require_output
-0000b950: 733d 5472 7565 2c0a 2020 2020 2020 2020  s=True,.        
-0000b960: 2020 2020 2020 2020 7365 7061 7261 7465          separate
-0000b970: 5f73 7464 6572 723d 5472 7565 290a 2020  _stderr=True).  
-0000b980: 2020 2020 2020 2020 2020 7375 6270 726f            subpro
-0000b990: 6365 7373 5f75 7469 6c73 2e68 616e 646c  cess_utils.handl
-0000b9a0: 655f 7265 7475 726e 636f 6465 280a 2020  e_returncode(.  
-0000b9b0: 2020 2020 2020 2020 2020 2020 2020 7263                rc
-0000b9c0: 2c20 696e 7374 616e 6365 5f73 6574 7570  , instance_setup
-0000b9d0: 2e52 4159 5f53 5441 5455 535f 5749 5448  .RAY_STATUS_WITH
-0000b9e0: 5f53 4b59 5f52 4159 5f50 4f52 545f 434f  _SKY_RAY_PORT_CO
-0000b9f0: 4d4d 414e 442c 0a20 2020 2020 2020 2020  MMAND,.         
-0000ba00: 2020 2020 2020 2027 4661 696c 6564 2074         'Failed t
-0000ba10: 6f20 7275 6e20 7261 7920 7374 6174 7573  o run ray status
-0000ba20: 206f 6e20 6865 6164 206e 6f64 652e 272c   on head node.',
-0000ba30: 2073 7464 6572 7229 0a20 2020 2020 2020   stderr).       
-0000ba40: 2020 2020 206c 6f67 6765 722e 6465 6275       logger.debu
-0000ba50: 6728 6f75 7470 7574 290a 0a20 2020 2020  g(output)..     
-0000ba60: 2020 2020 2020 2072 6561 6479 5f68 6561         ready_hea
-0000ba70: 642c 2072 6561 6479 5f77 6f72 6b65 7273  d, ready_workers
-0000ba80: 203d 205f 636f 756e 745f 6865 616c 7468   = _count_health
-0000ba90: 795f 6e6f 6465 735f 6672 6f6d 5f72 6179  y_nodes_from_ray
-0000baa0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000bab0: 2020 6f75 7470 7574 2c20 6973 5f6c 6f63    output, is_loc
-0000bac0: 616c 5f63 6c6f 7564 3d69 735f 6c6f 6361  al_cloud=is_loca
-0000bad0: 6c5f 636c 6f75 6429 0a0a 2020 2020 2020  l_cloud)..      
-0000bae0: 2020 2020 2020 776f 726b 6572 5f73 7461        worker_sta
-0000baf0: 7475 732e 7570 6461 7465 2827 5b62 6f6c  tus.update('[bol
-0000bb00: 6420 6379 616e 5d27 0a20 2020 2020 2020  d cyan]'.       
-0000bb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bb20: 2020 2020 2020 2020 2020 6627 7b72 6561            f'{rea
-0000bb30: 6479 5f77 6f72 6b65 7273 7d20 6f75 7420  dy_workers} out 
-0000bb40: 6f66 207b 6e75 6d5f 6e6f 6465 7320 2d20  of {num_nodes - 
-0000bb50: 317d 2027 0a20 2020 2020 2020 2020 2020  1} '.           
-0000bb60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bb70: 2020 2020 2020 2777 6f72 6b65 7273 2072        'workers r
-0000bb80: 6561 6479 2729 0a0a 2020 2020 2020 2020  eady')..        
-0000bb90: 2020 2020 2320 496e 2074 6865 206c 6f63      # In the loc
-0000bba0: 616c 2063 6173 652c 2072 6561 6479 5f68  al case, ready_h
-0000bbb0: 6561 643d 3020 616e 6420 7265 6164 795f  ead=0 and ready_
-0000bbc0: 776f 726b 6572 733d 6e75 6d5f 6e6f 6465  workers=num_node
-0000bbd0: 732e 2054 6869 730a 2020 2020 2020 2020  s. This.        
-0000bbe0: 2020 2020 2320 6973 2062 6563 6175 7365      # is because
-0000bbf0: 2074 6865 7265 2069 7320 6e6f 206d 6174   there is no mat
-0000bc00: 6368 696e 6720 7265 6765 7820 666f 7220  ching regex for 
-0000bc10: 5f4c 4155 4e43 4845 445f 4845 4144 5f50  _LAUNCHED_HEAD_P
-0000bc20: 4154 5445 524e 2e0a 2020 2020 2020 2020  ATTERN..        
-0000bc30: 2020 2020 6966 2072 6561 6479 5f68 6561      if ready_hea
-0000bc40: 6420 2b20 7265 6164 795f 776f 726b 6572  d + ready_worker
-0000bc50: 7320 3d3d 206e 756d 5f6e 6f64 6573 3a0a  s == num_nodes:.
-0000bc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bc70: 2320 416c 6c20 6e6f 6465 7320 6172 6520  # All nodes are 
-0000bc80: 7570 2e0a 2020 2020 2020 2020 2020 2020  up..            
-0000bc90: 2020 2020 6272 6561 6b0a 0a20 2020 2020      break..     
-0000bca0: 2020 2020 2020 2023 2050 656e 6469 6e67         # Pending
-0000bcb0: 2077 6f72 6b65 7273 2074 6861 7420 6861   workers that ha
-0000bcc0: 7665 2062 6565 6e20 6c61 756e 6368 6564  ve been launched
-0000bcd0: 2062 7920 7261 7920 7570 2e0a 2020 2020   by ray up..    
-0000bce0: 2020 2020 2020 2020 666f 756e 645f 6970          found_ip
-0000bcf0: 7320 3d20 5f4c 4155 4e43 4849 4e47 5f49  s = _LAUNCHING_I
-0000bd00: 505f 5041 5454 4552 4e2e 6669 6e64 616c  P_PATTERN.findal
-0000bd10: 6c28 6f75 7470 7574 290a 2020 2020 2020  l(output).      
-0000bd20: 2020 2020 2020 7065 6e64 696e 675f 776f        pending_wo
-0000bd30: 726b 6572 7320 3d20 6c65 6e28 666f 756e  rkers = len(foun
-0000bd40: 645f 6970 7329 0a0a 2020 2020 2020 2020  d_ips)..        
-0000bd50: 2020 2020 2320 544f 444f 287a 6877 7529      # TODO(zhwu)
-0000bd60: 3a20 4861 6e64 6c65 2074 6865 2063 6173  : Handle the cas
-0000bd70: 6520 7768 6572 6520 7468 6520 666f 6c6c  e where the foll
-0000bd80: 6f77 696e 6720 6f63 6375 7273 2c20 7768  owing occurs, wh
-0000bd90: 6572 6520 7261 790a 2020 2020 2020 2020  ere ray.        
-0000bda0: 2020 2020 2320 636c 7573 7465 7220 6973      # cluster is
-0000bdb0: 206e 6f74 2063 6f72 7265 6374 6c79 2073   not correctly s
-0000bdc0: 7461 7274 6564 206f 6e20 7468 6520 636c  tarted on the cl
-0000bdd0: 7573 7465 722e 0a20 2020 2020 2020 2020  uster..         
-0000bde0: 2020 2023 2050 656e 6469 6e67 3a0a 2020     # Pending:.  
-0000bdf0: 2020 2020 2020 2020 2020 2320 2031 3732            #  172
-0000be00: 2e33 312e 392e 3132 313a 2072 6179 2e77  .31.9.121: ray.w
-0000be10: 6f72 6b65 722e 6465 6661 756c 742c 2075  orker.default, u
-0000be20: 6e69 6e69 7469 616c 697a 6564 0a20 2020  ninitialized.   
-0000be30: 2020 2020 2020 2020 206e 6f64 6573 5f73           nodes_s
-0000be40: 6f5f 6661 7220 3d20 7265 6164 795f 6865  o_far = ready_he
-0000be50: 6164 202b 2072 6561 6479 5f77 6f72 6b65  ad + ready_worke
-0000be60: 7273 202b 2070 656e 6469 6e67 5f77 6f72  rs + pending_wor
-0000be70: 6b65 7273 0a0a 2020 2020 2020 2020 2020  kers..          
-0000be80: 2020 2320 4368 6563 6b20 7468 6520 6e75    # Check the nu
-0000be90: 6d62 6572 206f 6620 6e6f 6465 7320 7468  mber of nodes th
-0000bea0: 6174 2061 7265 2066 6574 6368 6564 2e20  at are fetched. 
-0000beb0: 5469 6d65 6f75 7420 6966 206e 6f20 6e65  Timeout if no ne
-0000bec0: 770a 2020 2020 2020 2020 2020 2020 2320  w.            # 
-0000bed0: 6e6f 6465 7320 6665 7463 6865 6420 696e  nodes fetched in
-0000bee0: 2061 2077 6869 6c65 2028 6e6f 6465 735f   a while (nodes_
-0000bef0: 6c61 756e 6368 696e 675f 7072 6f67 7265  launching_progre
-0000bf00: 7373 5f74 696d 656f 7574 292c 0a20 2020  ss_timeout),.   
-0000bf10: 2020 2020 2020 2020 2023 2074 686f 7567           # thoug
-0000bf20: 6820 6e75 6d62 6572 206f 6620 6e6f 6465  h number of node
-0000bf30: 735f 736f 5f66 6172 2069 7320 7374 696c  s_so_far is stil
-0000bf40: 6c20 6e6f 7420 6173 2065 7870 6563 7465  l not as expecte
-0000bf50: 642e 0a20 2020 2020 2020 2020 2020 2069  d..            i
-0000bf60: 6620 6e6f 6465 735f 736f 5f66 6172 203e  f nodes_so_far >
-0000bf70: 206c 6173 745f 6e6f 6465 735f 736f 5f66   last_nodes_so_f
-0000bf80: 6172 3a0a 2020 2020 2020 2020 2020 2020  ar:.            
-0000bf90: 2020 2020 2320 5265 7365 7420 7468 6520      # Reset the 
-0000bfa0: 7374 6172 7420 7469 6d65 2069 6620 7468  start time if th
-0000bfb0: 6520 6e75 6d62 6572 206f 6620 6c61 756e  e number of laun
-0000bfc0: 6368 696e 6720 6e6f 6465 730a 2020 2020  ching nodes.    
-0000bfd0: 2020 2020 2020 2020 2020 2020 2320 6368              # ch
-0000bfe0: 616e 6765 732c 2069 2e65 2e20 6e65 7720  anges, i.e. new 
-0000bff0: 6e6f 6465 7320 6172 6520 6c61 756e 6368  nodes are launch
-0000c000: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
-0000c010: 2020 2020 6c6f 6767 6572 2e64 6562 7567      logger.debug
-0000c020: 2827 5265 7365 7420 7374 6172 7420 7469  ('Reset start ti
-0000c030: 6d65 2c20 6173 206e 6577 206e 6f64 6573  me, as new nodes
-0000c040: 2061 7265 206c 6175 6e63 6865 642e 2027   are launched. '
-0000c050: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c060: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-0000c070: 287b 6c61 7374 5f6e 6f64 6573 5f73 6f5f  ({last_nodes_so_
-0000c080: 6661 727d 202d 3e20 7b6e 6f64 6573 5f73  far} -> {nodes_s
-0000c090: 6f5f 6661 727d 2927 290a 2020 2020 2020  o_far})').      
-0000c0a0: 2020 2020 2020 2020 2020 7374 6172 7420            start 
-0000c0b0: 3d20 7469 6d65 2e74 696d 6528 290a 2020  = time.time().  
-0000c0c0: 2020 2020 2020 2020 2020 2020 2020 6c61                la
-0000c0d0: 7374 5f6e 6f64 6573 5f73 6f5f 6661 7220  st_nodes_so_far 
-0000c0e0: 3d20 6e6f 6465 735f 736f 5f66 6172 0a20  = nodes_so_far. 
-0000c0f0: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-0000c100: 286e 6f64 6573 5f6c 6175 6e63 6869 6e67  (nodes_launching
-0000c110: 5f70 726f 6772 6573 735f 7469 6d65 6f75  _progress_timeou
-0000c120: 7420 6973 206e 6f74 204e 6f6e 6520 616e  t is not None an
-0000c130: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
-0000c140: 2020 2020 7469 6d65 2e74 696d 6528 2920      time.time() 
-0000c150: 2d20 7374 6172 7420 3e20 6e6f 6465 735f  - start > nodes_
-0000c160: 6c61 756e 6368 696e 675f 7072 6f67 7265  launching_progre
-0000c170: 7373 5f74 696d 656f 7574 2061 6e64 0a20  ss_timeout and. 
-0000c180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c190: 206e 6f64 6573 5f73 6f5f 6661 7220 213d   nodes_so_far !=
-0000c1a0: 206e 756d 5f6e 6f64 6573 293a 0a20 2020   num_nodes):.   
-0000c1b0: 2020 2020 2020 2020 2020 2020 206c 6f67               log
-0000c1c0: 6765 722e 6572 726f 7228 0a20 2020 2020  ger.error(.     
-0000c1d0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-0000c1e0: 5469 6d65 6420 6f75 743a 2077 6169 7465  Timed out: waite
-0000c1f0: 6420 666f 7220 6d6f 7265 2074 6861 6e20  d for more than 
-0000c200: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0000c210: 2020 2020 2020 6627 7b6e 6f64 6573 5f6c        f'{nodes_l
-0000c220: 6175 6e63 6869 6e67 5f70 726f 6772 6573  aunching_progres
-0000c230: 735f 7469 6d65 6f75 747d 2073 6563 6f6e  s_timeout} secon
-0000c240: 6473 2066 6f72 206e 6577 2027 0a20 2020  ds for new '.   
-0000c250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c260: 2027 776f 726b 6572 7320 746f 2062 6520   'workers to be 
-0000c270: 7072 6f76 6973 696f 6e65 642c 2062 7574  provisioned, but
-0000c280: 206e 6f20 7072 6f67 7265 7373 2e27 290a   no progress.').
-0000c290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c2a0: 7265 7475 726e 2046 616c 7365 2c20 4e6f  return False, No
-0000c2b0: 6e65 2020 2320 6661 696c 6564 0a0a 2020  ne  # failed..  
-0000c2c0: 2020 2020 2020 2020 2020 6966 2027 286e            if '(n
-0000c2d0: 6f20 7065 6e64 696e 6720 6e6f 6465 7329  o pending nodes)
-0000c2e0: 2720 696e 206f 7574 7075 7420 616e 6420  ' in output and 
-0000c2f0: 2728 6e6f 2066 6169 6c75 7265 7329 2720  '(no failures)' 
-0000c300: 696e 206f 7574 7075 743a 0a20 2020 2020  in output:.     
-0000c310: 2020 2020 2020 2020 2020 2023 2042 7567             # Bug
-0000c320: 2069 6e20 7261 7920 6175 746f 7363 616c   in ray autoscal
-0000c330: 6572 3a20 652e 672e 2c20 6f6e 2047 4350  er: e.g., on GCP
-0000c340: 2c20 6966 2072 6571 7565 7374 696e 6720  , if requesting 
-0000c350: 3220 6e6f 6465 730a 2020 2020 2020 2020  2 nodes.        
-0000c360: 2020 2020 2020 2020 2320 7468 6174 2047          # that G
-0000c370: 4350 2063 616e 2073 6174 6973 6679 206f  CP can satisfy o
-0000c380: 6e6c 7920 6279 2068 616c 662c 2074 6865  nly by half, the
-0000c390: 2077 6f72 6b65 7220 6e6f 6465 2077 6f75   worker node wou
-0000c3a0: 6c64 2062 650a 2020 2020 2020 2020 2020  ld be.          
-0000c3b0: 2020 2020 2020 2320 666f 7267 6f74 7465        # forgotte
-0000c3c0: 6e2e 2054 6865 2063 6f72 7265 6374 2062  n. The correct b
-0000c3d0: 6568 6176 696f 7220 7368 6f75 6c64 2062  ehavior should b
-0000c3e0: 6520 666f 7220 6974 2074 6f20 6572 726f  e for it to erro
-0000c3f0: 7220 6f75 742e 0a20 2020 2020 2020 2020  r out..         
-0000c400: 2020 2020 2020 206c 6f67 6765 722e 6572         logger.er
-0000c410: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-0000c420: 2020 2020 2020 2020 2027 4661 696c 6564           'Failed
-0000c430: 2074 6f20 6c61 756e 6368 206d 756c 7469   to launch multi
-0000c440: 706c 6520 6e6f 6465 7320 6f6e 2027 0a20  ple nodes on '. 
-0000c450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c460: 2020 2027 4743 5020 6475 6520 746f 2061     'GCP due to a
-0000c470: 206e 6f6e 6465 7465 726d 696e 6973 7469   nondeterministi
-0000c480: 6320 6275 6720 696e 2072 6179 2061 7574  c bug in ray aut
-0000c490: 6f73 6361 6c65 722e 2729 0a20 2020 2020  oscaler.').     
-0000c4a0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000c4b0: 6e20 4661 6c73 652c 204e 6f6e 6520 2023  n False, None  #
-0000c4c0: 2066 6169 6c65 640a 2020 2020 2020 2020   failed.        
-0000c4d0: 2020 2020 7469 6d65 2e73 6c65 6570 2831      time.sleep(1
-0000c4e0: 3029 0a20 2020 2072 6574 7572 6e20 5472  0).    return Tr
-0000c4f0: 7565 2c20 646f 636b 6572 5f75 7365 7220  ue, docker_user 
-0000c500: 2023 2073 7563 6365 7373 0a0a 0a64 6566   # success...def
-0000c510: 2073 7368 5f63 7265 6465 6e74 6961 6c5f   ssh_credential_
-0000c520: 6672 6f6d 5f79 616d 6c28 0a20 2020 2063  from_yaml(.    c
-0000c530: 6c75 7374 6572 5f79 616d 6c3a 2073 7472  luster_yaml: str
-0000c540: 2c0a 2020 2020 646f 636b 6572 5f75 7365  ,.    docker_use
-0000c550: 723a 204f 7074 696f 6e61 6c5b 7374 725d  r: Optional[str]
-0000c560: 203d 204e 6f6e 652c 0a20 2020 2073 7368   = None,.    ssh
-0000c570: 5f75 7365 723a 204f 7074 696f 6e61 6c5b  _user: Optional[
-0000c580: 7374 725d 203d 204e 6f6e 652c 0a29 202d  str] = None,.) -
-0000c590: 3e20 4469 6374 5b73 7472 2c20 416e 795d  > Dict[str, Any]
-0000c5a0: 3a0a 2020 2020 2222 2252 6574 7572 6e73  :.    """Returns
-0000c5b0: 2073 7368 5f75 7365 722c 2073 7368 5f70   ssh_user, ssh_p
-0000c5c0: 7269 7661 7465 5f6b 6579 2061 6e64 2073  rivate_key and s
-0000c5d0: 7368 5f63 6f6e 7472 6f6c 206e 616d 652e  sh_control name.
-0000c5e0: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
-0000c5f0: 2020 2020 636c 7573 7465 725f 7961 6d6c      cluster_yaml
-0000c600: 3a20 7061 7468 2074 6f20 7468 6520 636c  : path to the cl
-0000c610: 7573 7465 7220 7961 6d6c 2e0a 2020 2020  uster yaml..    
-0000c620: 2020 2020 646f 636b 6572 5f75 7365 723a      docker_user:
-0000c630: 2077 6865 6e20 7573 696e 6720 6375 7374   when using cust
-0000c640: 6f6d 2064 6f63 6b65 7220 696d 6167 652c  om docker image,
-0000c650: 2075 7365 2074 6869 7320 7573 6572 2074   use this user t
-0000c660: 6f20 7373 6820 696e 746f 0a20 2020 2020  o ssh into.     
-0000c670: 2020 2020 2020 2074 6865 2064 6f63 6b65         the docke
-0000c680: 7220 636f 6e74 6169 6e65 722e 0a20 2020  r container..   
-0000c690: 2020 2020 2073 7368 5f75 7365 723a 206f       ssh_user: o
-0000c6a0: 7665 7272 6964 6520 7468 6520 7373 685f  verride the ssh_
-0000c6b0: 7573 6572 2069 6e20 7468 6520 636c 7573  user in the clus
-0000c6c0: 7465 7220 7961 6d6c 2e0a 2020 2020 2222  ter yaml..    ""
-0000c6d0: 220a 2020 2020 636f 6e66 6967 203d 2063  ".    config = c
-0000c6e0: 6f6d 6d6f 6e5f 7574 696c 732e 7265 6164  ommon_utils.read
-0000c6f0: 5f79 616d 6c28 636c 7573 7465 725f 7961  _yaml(cluster_ya
-0000c700: 6d6c 290a 2020 2020 6175 7468 5f73 6563  ml).    auth_sec
-0000c710: 7469 6f6e 203d 2063 6f6e 6669 675b 2761  tion = config['a
-0000c720: 7574 6827 5d0a 2020 2020 6966 2073 7368  uth'].    if ssh
-0000c730: 5f75 7365 7220 6973 204e 6f6e 653a 0a20  _user is None:. 
-0000c740: 2020 2020 2020 2073 7368 5f75 7365 7220         ssh_user 
-0000c750: 3d20 6175 7468 5f73 6563 7469 6f6e 5b27  = auth_section['
-0000c760: 7373 685f 7573 6572 275d 2e73 7472 6970  ssh_user'].strip
-0000c770: 2829 0a20 2020 2073 7368 5f70 7269 7661  ().    ssh_priva
-0000c780: 7465 5f6b 6579 203d 2061 7574 685f 7365  te_key = auth_se
-0000c790: 6374 696f 6e2e 6765 7428 2773 7368 5f70  ction.get('ssh_p
-0000c7a0: 7269 7661 7465 5f6b 6579 2729 0a20 2020  rivate_key').   
-0000c7b0: 2073 7368 5f63 6f6e 7472 6f6c 5f6e 616d   ssh_control_nam
-0000c7c0: 6520 3d20 636f 6e66 6967 2e67 6574 2827  e = config.get('
-0000c7d0: 636c 7573 7465 725f 6e61 6d65 272c 2027  cluster_name', '
-0000c7e0: 5f5f 6465 6661 756c 745f 5f27 290a 2020  __default__').  
-0000c7f0: 2020 7373 685f 7072 6f78 795f 636f 6d6d    ssh_proxy_comm
-0000c800: 616e 6420 3d20 6175 7468 5f73 6563 7469  and = auth_secti
-0000c810: 6f6e 2e67 6574 2827 7373 685f 7072 6f78  on.get('ssh_prox
-0000c820: 795f 636f 6d6d 616e 6427 290a 2020 2020  y_command').    
-0000c830: 6372 6564 656e 7469 616c 7320 3d20 7b0a  credentials = {.
-0000c840: 2020 2020 2020 2020 2773 7368 5f75 7365          'ssh_use
-0000c850: 7227 3a20 7373 685f 7573 6572 2c0a 2020  r': ssh_user,.  
-0000c860: 2020 2020 2020 2773 7368 5f70 7269 7661        'ssh_priva
-0000c870: 7465 5f6b 6579 273a 2073 7368 5f70 7269  te_key': ssh_pri
-0000c880: 7661 7465 5f6b 6579 2c0a 2020 2020 2020  vate_key,.      
-0000c890: 2020 2773 7368 5f63 6f6e 7472 6f6c 5f6e    'ssh_control_n
-0000c8a0: 616d 6527 3a20 7373 685f 636f 6e74 726f  ame': ssh_contro
-0000c8b0: 6c5f 6e61 6d65 2c0a 2020 2020 2020 2020  l_name,.        
-0000c8c0: 2773 7368 5f70 726f 7879 5f63 6f6d 6d61  'ssh_proxy_comma
-0000c8d0: 6e64 273a 2073 7368 5f70 726f 7879 5f63  nd': ssh_proxy_c
-0000c8e0: 6f6d 6d61 6e64 2c0a 2020 2020 7d0a 2020  ommand,.    }.  
-0000c8f0: 2020 6966 2064 6f63 6b65 725f 7573 6572    if docker_user
-0000c900: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-0000c910: 2020 2020 2020 6372 6564 656e 7469 616c        credential
-0000c920: 735b 2764 6f63 6b65 725f 7573 6572 275d  s['docker_user']
-0000c930: 203d 2064 6f63 6b65 725f 7573 6572 0a20   = docker_user. 
-0000c940: 2020 2073 7368 5f70 726f 7669 6465 725f     ssh_provider_
-0000c950: 6d6f 6475 6c65 203d 2063 6f6e 6669 675b  module = config[
-0000c960: 2770 726f 7669 6465 7227 5d5b 276d 6f64  'provider']['mod
-0000c970: 756c 6527 5d0a 2020 2020 2320 4966 2077  ule'].    # If w
-0000c980: 6520 6172 6520 7275 6e6e 696e 6720 7373  e are running ss
-0000c990: 6820 636f 6d6d 616e 6420 6f6e 206b 7562  h command on kub
-0000c9a0: 6572 6e65 7465 7320 6e6f 6465 2e0a 2020  ernetes node..  
-0000c9b0: 2020 6966 2027 6b75 6265 726e 6574 6573    if 'kubernetes
-0000c9c0: 2720 696e 2073 7368 5f70 726f 7669 6465  ' in ssh_provide
-0000c9d0: 725f 6d6f 6475 6c65 3a0a 2020 2020 2020  r_module:.      
-0000c9e0: 2020 6372 6564 656e 7469 616c 735b 2764    credentials['d
-0000c9f0: 6973 6162 6c65 5f63 6f6e 7472 6f6c 5f6d  isable_control_m
-0000ca00: 6173 7465 7227 5d20 3d20 5472 7565 0a20  aster'] = True. 
-0000ca10: 2020 2072 6574 7572 6e20 6372 6564 656e     return creden
-0000ca20: 7469 616c 730a 0a0a 6465 6620 7061 7261  tials...def para
-0000ca30: 6c6c 656c 5f64 6174 615f 7472 616e 7366  llel_data_transf
-0000ca40: 6572 5f74 6f5f 6e6f 6465 7328 0a20 2020  er_to_nodes(.   
-0000ca50: 2072 756e 6e65 7273 3a20 4c69 7374 5b63   runners: List[c
-0000ca60: 6f6d 6d61 6e64 5f72 756e 6e65 722e 5353  ommand_runner.SS
-0000ca70: 4843 6f6d 6d61 6e64 5275 6e6e 6572 5d2c  HCommandRunner],
-0000ca80: 0a20 2020 2073 6f75 7263 653a 204f 7074  .    source: Opt
-0000ca90: 696f 6e61 6c5b 7374 725d 2c0a 2020 2020  ional[str],.    
-0000caa0: 7461 7267 6574 3a20 7374 722c 0a20 2020  target: str,.   
-0000cab0: 2063 6d64 3a20 4f70 7469 6f6e 616c 5b73   cmd: Optional[s
-0000cac0: 7472 5d2c 0a20 2020 2072 756e 5f72 7379  tr],.    run_rsy
-0000cad0: 6e63 3a20 626f 6f6c 2c0a 2020 2020 2a2c  nc: bool,.    *,
-0000cae0: 0a20 2020 2061 6374 696f 6e5f 6d65 7373  .    action_mess
-0000caf0: 6167 653a 2073 7472 2c0a 2020 2020 2320  age: str,.    # 
-0000cb00: 4164 7661 6e63 6564 206f 7074 696f 6e73  Advanced options
-0000cb10: 2e0a 2020 2020 6c6f 675f 7061 7468 3a20  ..    log_path: 
-0000cb20: 7374 7220 3d20 6f73 2e64 6576 6e75 6c6c  str = os.devnull
-0000cb30: 2c0a 2020 2020 7374 7265 616d 5f6c 6f67  ,.    stream_log
-0000cb40: 733a 2062 6f6f 6c20 3d20 4661 6c73 652c  s: bool = False,
-0000cb50: 0a29 3a0a 2020 2020 2222 2252 756e 7320  .):.    """Runs 
-0000cb60: 6120 636f 6d6d 616e 6420 6f6e 2061 6c6c  a command on all
-0000cb70: 206e 6f64 6573 2061 6e64 206f 7074 696f   nodes and optio
-0000cb80: 6e61 6c6c 7920 7275 6e73 2072 7379 6e63  nally runs rsync
-0000cb90: 2066 726f 6d20 7372 632d 3e64 7374 2e0a   from src->dst..
-0000cba0: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
-0000cbb0: 2020 2072 756e 6e65 7273 3a20 4120 6c69     runners: A li
-0000cbc0: 7374 206f 6620 5353 4843 6f6d 6d61 6e64  st of SSHCommand
-0000cbd0: 5275 6e6e 6572 206f 626a 6563 7473 2074  Runner objects t
-0000cbe0: 6861 7420 7265 7072 6573 656e 7420 6d75  hat represent mu
-0000cbf0: 6c74 6970 6c65 206e 6f64 6573 2e0a 2020  ltiple nodes..  
-0000cc00: 2020 2020 2020 736f 7572 6365 3a20 4f70        source: Op
-0000cc10: 7469 6f6e 616c 5b73 7472 5d3b 2053 6f75  tional[str]; Sou
-0000cc20: 7263 6520 666f 7220 7273 796e 6320 6f6e  rce for rsync on
-0000cc30: 206c 6f63 616c 206e 6f64 650a 2020 2020   local node.    
-0000cc40: 2020 2020 7461 7267 6574 3a20 7374 723b      target: str;
-0000cc50: 2044 6573 7469 6e61 7469 6f6e 206f 6e20   Destination on 
-0000cc60: 7265 6d6f 7465 206e 6f64 6520 666f 7220  remote node for 
-0000cc70: 7273 796e 630a 2020 2020 2020 2020 636d  rsync.        cm
-0000cc80: 643a 2073 7472 3b20 436f 6d6d 616e 6420  d: str; Command 
-0000cc90: 746f 2062 6520 6578 6563 7574 6564 206f  to be executed o
-0000cca0: 6e20 616c 6c20 6e6f 6465 730a 2020 2020  n all nodes.    
-0000ccb0: 2020 2020 6163 7469 6f6e 5f6d 6573 7361      action_messa
-0000ccc0: 6765 3a20 7374 723b 204d 6573 7361 6765  ge: str; Message
-0000ccd0: 2074 6f20 6265 2070 7269 6e74 6564 2077   to be printed w
-0000cce0: 6869 6c65 2074 6865 2063 6f6d 6d61 6e64  hile the command
-0000ccf0: 2072 756e 730a 2020 2020 2020 2020 6c6f   runs.        lo
-0000cd00: 675f 7061 7468 3a20 7374 723b 2050 6174  g_path: str; Pat
-0000cd10: 6820 746f 2074 6865 206c 6f67 2066 696c  h to the log fil
-0000cd20: 650a 2020 2020 2020 2020 7374 7265 616d  e.        stream
-0000cd30: 5f6c 6f67 733a 2062 6f6f 6c3b 2057 6865  _logs: bool; Whe
-0000cd40: 7468 6572 2074 6f20 7374 7265 616d 206c  ther to stream l
-0000cd50: 6f67 7320 746f 2073 7464 6f75 740a 2020  ogs to stdout.  
-0000cd60: 2020 2222 220a 2020 2020 666f 7265 203d    """.    fore =
-0000cd70: 2063 6f6c 6f72 616d 612e 466f 7265 0a20   colorama.Fore. 
-0000cd80: 2020 2073 7479 6c65 203d 2063 6f6c 6f72     style = color
-0000cd90: 616d 612e 5374 796c 650a 0a20 2020 206f  ama.Style..    o
-0000cda0: 7269 6769 6e5f 736f 7572 6365 203d 2073  rigin_source = s
-0000cdb0: 6f75 7263 650a 0a20 2020 2064 6566 205f  ource..    def _
-0000cdc0: 7379 6e63 5f6e 6f64 6528 7275 6e6e 6572  sync_node(runner
-0000cdd0: 3a20 2763 6f6d 6d61 6e64 5f72 756e 6e65  : 'command_runne
-0000cde0: 722e 5353 4843 6f6d 6d61 6e64 5275 6e6e  r.SSHCommandRunn
-0000cdf0: 6572 2729 202d 3e20 4e6f 6e65 3a0a 2020  er') -> None:.  
-0000ce00: 2020 2020 2020 6966 2063 6d64 2069 7320        if cmd is 
-0000ce10: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-0000ce20: 2020 2020 2020 7263 2c20 7374 646f 7574        rc, stdout
-0000ce30: 2c20 7374 6465 7272 203d 2072 756e 6e65  , stderr = runne
-0000ce40: 722e 7275 6e28 636d 642c 0a20 2020 2020  r.run(cmd,.     
-0000ce50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ce60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ce70: 2020 2020 2020 206c 6f67 5f70 6174 683d         log_path=
-0000ce80: 6c6f 675f 7061 7468 2c0a 2020 2020 2020  log_path,.      
-0000ce90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ceb0: 2020 2020 2020 7374 7265 616d 5f6c 6f67        stream_log
-0000cec0: 733d 7374 7265 616d 5f6c 6f67 732c 0a20  s=stream_logs,. 
-0000ced0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cef0: 2020 2020 2020 2020 2020 2072 6571 7569             requi
-0000cf00: 7265 5f6f 7574 7075 7473 3d54 7275 6529  re_outputs=True)
-0000cf10: 0a20 2020 2020 2020 2020 2020 2065 7272  .            err
-0000cf20: 5f6d 7367 203d 2028 2746 6169 6c65 6420  _msg = ('Failed 
-0000cf30: 746f 2072 756e 2063 6f6d 6d61 6e64 2062  to run command b
-0000cf40: 6566 6f72 6520 7273 796e 6320 270a 2020  efore rsync '.  
-0000cf50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cf60: 2020 2020 2066 277b 6f72 6967 696e 5f73       f'{origin_s
-0000cf70: 6f75 7263 657d 202d 3e20 7b74 6172 6765  ource} -> {targe
-0000cf80: 747d 2e20 270a 2020 2020 2020 2020 2020  t}. '.          
-0000cf90: 2020 2020 2020 2020 2020 2020 2027 456e               'En
-0000cfa0: 7375 7265 2074 6861 7420 7468 6520 6e65  sure that the ne
-0000cfb0: 7477 6f72 6b20 6973 2073 7461 626c 652c  twork is stable,
-0000cfc0: 2074 6865 6e20 7265 7472 792e 2729 0a20   then retry.'). 
-0000cfd0: 2020 2020 2020 2020 2020 2069 6620 6c6f             if lo
-0000cfe0: 675f 7061 7468 2021 3d20 6f73 2e64 6576  g_path != os.dev
-0000cff0: 6e75 6c6c 3a0a 2020 2020 2020 2020 2020  null:.          
-0000d000: 2020 2020 2020 6572 725f 6d73 6720 2b3d        err_msg +=
-0000d010: 2066 2720 5365 6520 6c6f 6773 2069 6e20   f' See logs in 
-0000d020: 7b6c 6f67 5f70 6174 687d 270a 2020 2020  {log_path}'.    
-0000d030: 2020 2020 2020 2020 7375 6270 726f 6365          subproce
-0000d040: 7373 5f75 7469 6c73 2e68 616e 646c 655f  ss_utils.handle_
-0000d050: 7265 7475 726e 636f 6465 2872 632c 0a20  returncode(rc,. 
-0000d060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d080: 2020 2020 2020 2020 2020 2020 2020 636d                cm
-0000d090: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
-0000d0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d0c0: 2020 6572 725f 6d73 672c 0a20 2020 2020    err_msg,.     
-0000d0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d0f0: 2020 2020 2020 2020 2020 7374 6465 7272            stderr
-0000d100: 3d73 7464 6f75 7420 2b20 7374 6465 7272  =stdout + stderr
-0000d110: 290a 0a20 2020 2020 2020 2069 6620 7275  )..        if ru
-0000d120: 6e5f 7273 796e 633a 0a20 2020 2020 2020  n_rsync:.       
-0000d130: 2020 2020 2061 7373 6572 7420 736f 7572       assert sour
-0000d140: 6365 2069 7320 6e6f 7420 4e6f 6e65 0a20  ce is not None. 
-0000d150: 2020 2020 2020 2020 2020 2023 2054 4f44             # TOD
-0000d160: 4f28 7a68 7775 293a 204f 7074 696d 697a  O(zhwu): Optimiz
-0000d170: 6520 666f 7220 6c61 7267 6520 616d 6f75  e for large amou
-0000d180: 6e74 206f 6620 6669 6c65 732e 0a20 2020  nt of files..   
-0000d190: 2020 2020 2020 2020 2023 207a 6970 202f           # zip /
-0000d1a0: 2074 7261 6e73 6665 7220 2f20 756e 7a69   transfer / unzi
-0000d1b0: 700a 2020 2020 2020 2020 2020 2020 7275  p.            ru
-0000d1c0: 6e6e 6572 2e72 7379 6e63 280a 2020 2020  nner.rsync(.    
-0000d1d0: 2020 2020 2020 2020 2020 2020 736f 7572              sour
-0000d1e0: 6365 3d73 6f75 7263 652c 0a20 2020 2020  ce=source,.     
-0000d1f0: 2020 2020 2020 2020 2020 2074 6172 6765             targe
-0000d200: 743d 7461 7267 6574 2c0a 2020 2020 2020  t=target,.      
-0000d210: 2020 2020 2020 2020 2020 7570 3d54 7275            up=Tru
-0000d220: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0000d230: 2020 206c 6f67 5f70 6174 683d 6c6f 675f     log_path=log_
-0000d240: 7061 7468 2c0a 2020 2020 2020 2020 2020  path,.          
-0000d250: 2020 2020 2020 7374 7265 616d 5f6c 6f67        stream_log
-0000d260: 733d 7374 7265 616d 5f6c 6f67 732c 0a20  s=stream_logs,. 
-0000d270: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-0000d280: 2020 6e75 6d5f 6e6f 6465 7320 3d20 6c65    num_nodes = le
-0000d290: 6e28 7275 6e6e 6572 7329 0a20 2020 2070  n(runners).    p
-0000d2a0: 6c75 7261 6c20 3d20 2773 2720 6966 206e  lural = 's' if n
-0000d2b0: 756d 5f6e 6f64 6573 203e 2031 2065 6c73  um_nodes > 1 els
-0000d2c0: 6520 2727 0a20 2020 206d 6573 7361 6765  e ''.    message
-0000d2d0: 203d 2028 6627 7b66 6f72 652e 4359 414e   = (f'{fore.CYAN
-0000d2e0: 7d7b 6163 7469 6f6e 5f6d 6573 7361 6765  }{action_message
-0000d2f0: 7d20 2874 6f20 7b6e 756d 5f6e 6f64 6573  } (to {num_nodes
-0000d300: 7d20 6e6f 6465 7b70 6c75 7261 6c7d 2927  } node{plural})'
-0000d310: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d320: 6627 3a20 7b73 7479 6c65 2e42 5249 4748  f': {style.BRIGH
-0000d330: 547d 7b6f 7269 6769 6e5f 736f 7572 6365  T}{origin_source
-0000d340: 7d7b 7374 796c 652e 5245 5345 545f 414c  }{style.RESET_AL
-0000d350: 4c7d 202d 3e20 270a 2020 2020 2020 2020  L} -> '.        
-0000d360: 2020 2020 2020 2066 277b 7374 796c 652e         f'{style.
-0000d370: 4252 4947 4854 7d7b 7461 7267 6574 7d7b  BRIGHT}{target}{
-0000d380: 7374 796c 652e 5245 5345 545f 414c 4c7d  style.RESET_ALL}
-0000d390: 2729 0a20 2020 206c 6f67 6765 722e 696e  ').    logger.in
-0000d3a0: 666f 286d 6573 7361 6765 290a 2020 2020  fo(message).    
-0000d3b0: 7769 7468 2072 6963 685f 7574 696c 732e  with rich_utils.
-0000d3c0: 7361 6665 5f73 7461 7475 7328 6627 5b62  safe_status(f'[b
-0000d3d0: 6f6c 6420 6379 616e 5d7b 6163 7469 6f6e  old cyan]{action
-0000d3e0: 5f6d 6573 7361 6765 7d5b 2f5d 2729 3a0a  _message}[/]'):.
-0000d3f0: 2020 2020 2020 2020 7375 6270 726f 6365          subproce
-0000d400: 7373 5f75 7469 6c73 2e72 756e 5f69 6e5f  ss_utils.run_in_
-0000d410: 7061 7261 6c6c 656c 285f 7379 6e63 5f6e  parallel(_sync_n
-0000d420: 6f64 652c 2072 756e 6e65 7273 290a 0a0a  ode, runners)...
-0000d430: 6465 6620 6368 6563 6b5f 6c6f 6361 6c5f  def check_local_
-0000d440: 6770 7573 2829 202d 3e20 626f 6f6c 3a0a  gpus() -> bool:.
-0000d450: 2020 2020 2222 2243 6865 636b 7320 6966      """Checks if
-0000d460: 2047 5055 7320 6172 6520 6176 6169 6c61   GPUs are availa
-0000d470: 626c 6520 6c6f 6361 6c6c 792e 0a0a 2020  ble locally...  
-0000d480: 2020 5265 7475 726e 7320 7768 6574 6865    Returns whethe
-0000d490: 7220 4750 5573 2061 7265 2061 7661 696c  r GPUs are avail
-0000d4a0: 6162 6c65 206f 6e20 7468 6520 6c6f 6361  able on the loca
-0000d4b0: 6c20 6d61 6368 696e 6520 6279 2063 6865  l machine by che
-0000d4c0: 636b 696e 670a 2020 2020 6966 206e 7669  cking.    if nvi
-0000d4d0: 6469 612d 736d 6920 6973 2069 6e73 7461  dia-smi is insta
-0000d4e0: 6c6c 6564 2061 6e64 2072 6574 7572 6e73  lled and returns
-0000d4f0: 207a 6572 6f20 7265 7475 726e 2063 6f64   zero return cod
-0000d500: 652e 0a0a 2020 2020 5265 7475 726e 7320  e...    Returns 
-0000d510: 5472 7565 2069 6620 6e76 6964 6961 2d73  True if nvidia-s
-0000d520: 6d69 2069 7320 696e 7374 616c 6c65 6420  mi is installed 
-0000d530: 616e 6420 7265 7475 726e 7320 7a65 726f  and returns zero
-0000d540: 2072 6574 7572 6e20 636f 6465 2c0a 2020   return code,.  
-0000d550: 2020 4661 6c73 6520 6966 206e 6f74 2e0a    False if not..
-0000d560: 2020 2020 2222 220a 2020 2020 6973 5f66      """.    is_f
-0000d570: 756e 6374 696f 6e61 6c20 3d20 4661 6c73  unctional = Fals
-0000d580: 650a 2020 2020 696e 7374 616c 6c61 7469  e.    installati
-0000d590: 6f6e 5f63 6865 636b 203d 2073 7562 7072  on_check = subpr
-0000d5a0: 6f63 6573 732e 7275 6e28 5b27 7768 6963  ocess.run(['whic
-0000d5b0: 6827 2c20 276e 7669 6469 612d 736d 6927  h', 'nvidia-smi'
-0000d5c0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-0000d5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d5e0: 2020 2020 2020 2020 2020 2073 7464 6f75             stdou
-0000d5f0: 743d 7375 6270 726f 6365 7373 2e44 4556  t=subprocess.DEV
-0000d600: 4e55 4c4c 2c0a 2020 2020 2020 2020 2020  NULL,.          
-0000d610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d620: 2020 2020 2020 2020 2020 2020 2020 7374                st
-0000d630: 6465 7272 3d73 7562 7072 6f63 6573 732e  derr=subprocess.
-0000d640: 4445 564e 554c 4c2c 0a20 2020 2020 2020  DEVNULL,.       
-0000d650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b800: 290a 2020 2020 636f 6e74 6169 6e65 725f  ).    container_
+0000b810: 6e61 6d65 203d 2063 6f6e 7374 616e 7473  name = constants
+0000b820: 2e44 4546 4155 4c54 5f44 4f43 4b45 525f  .DEFAULT_DOCKER_
+0000b830: 434f 4e54 4149 4e45 525f 4e41 4d45 0a20  CONTAINER_NAME. 
+0000b840: 2020 2077 686f 616d 695f 7265 7475 726e     whoami_return
+0000b850: 636f 6465 2c20 7768 6f61 6d69 5f73 7464  code, whoami_std
+0000b860: 6f75 742c 2077 686f 616d 695f 7374 6465  out, whoami_stde
+0000b870: 7272 203d 2072 756e 6e65 722e 7275 6e28  rr = runner.run(
+0000b880: 0a20 2020 2020 2020 2066 2773 7564 6f20  .        f'sudo 
+0000b890: 646f 636b 6572 2065 7865 6320 7b63 6f6e  docker exec {con
+0000b8a0: 7461 696e 6572 5f6e 616d 657d 2077 686f  tainer_name} who
+0000b8b0: 616d 6927 2c0a 2020 2020 2020 2020 7374  ami',.        st
+0000b8c0: 7265 616d 5f6c 6f67 733d 4661 6c73 652c  ream_logs=False,
+0000b8d0: 0a20 2020 2020 2020 2072 6571 7569 7265  .        require
+0000b8e0: 5f6f 7574 7075 7473 3d54 7275 6529 0a20  _outputs=True). 
+0000b8f0: 2020 2061 7373 6572 7420 7768 6f61 6d69     assert whoami
+0000b900: 5f72 6574 7572 6e63 6f64 6520 3d3d 2030  _returncode == 0
+0000b910: 2c20 280a 2020 2020 2020 2020 6627 4661  , (.        f'Fa
+0000b920: 696c 6564 2074 6f20 6765 7420 646f 636b  iled to get dock
+0000b930: 6572 2063 6f6e 7461 696e 6572 2075 7365  er container use
+0000b940: 722e 2052 6574 7572 6e20 270a 2020 2020  r. Return '.    
+0000b950: 2020 2020 6627 636f 6465 3a20 7b77 686f      f'code: {who
+0000b960: 616d 695f 7265 7475 726e 636f 6465 7d2c  ami_returncode},
+0000b970: 2045 7272 6f72 3a20 7b77 686f 616d 695f   Error: {whoami_
+0000b980: 7374 6465 7272 7d27 290a 2020 2020 646f  stderr}').    do
+0000b990: 636b 6572 5f75 7365 7220 3d20 7768 6f61  cker_user = whoa
+0000b9a0: 6d69 5f73 7464 6f75 742e 7374 7269 7028  mi_stdout.strip(
+0000b9b0: 290a 2020 2020 6c6f 6767 6572 2e64 6562  ).    logger.deb
+0000b9c0: 7567 2866 2744 6f63 6b65 7220 636f 6e74  ug(f'Docker cont
+0000b9d0: 6169 6e65 7220 7573 6572 3a20 7b64 6f63  ainer user: {doc
+0000b9e0: 6b65 725f 7573 6572 7d27 290a 2020 2020  ker_user}').    
+0000b9f0: 7265 7475 726e 2064 6f63 6b65 725f 7573  return docker_us
+0000ba00: 6572 0a0a 0a40 7469 6d65 6c69 6e65 2e65  er...@timeline.e
+0000ba10: 7665 6e74 0a64 6566 2077 6169 745f 756e  vent.def wait_un
+0000ba20: 7469 6c5f 7261 795f 636c 7573 7465 725f  til_ray_cluster_
+0000ba30: 7265 6164 7928 0a20 2020 2063 6c75 7374  ready(.    clust
+0000ba40: 6572 5f63 6f6e 6669 675f 6669 6c65 3a20  er_config_file: 
+0000ba50: 7374 722c 0a20 2020 206e 756d 5f6e 6f64  str,.    num_nod
+0000ba60: 6573 3a20 696e 742c 0a20 2020 206c 6f67  es: int,.    log
+0000ba70: 5f70 6174 683a 2073 7472 2c0a 2020 2020  _path: str,.    
+0000ba80: 6973 5f6c 6f63 616c 5f63 6c6f 7564 3a20  is_local_cloud: 
+0000ba90: 626f 6f6c 203d 2046 616c 7365 2c0a 2020  bool = False,.  
+0000baa0: 2020 6e6f 6465 735f 6c61 756e 6368 696e    nodes_launchin
+0000bab0: 675f 7072 6f67 7265 7373 5f74 696d 656f  g_progress_timeo
+0000bac0: 7574 3a20 4f70 7469 6f6e 616c 5b69 6e74  ut: Optional[int
+0000bad0: 5d20 3d20 4e6f 6e65 2c0a 2920 2d3e 2054  ] = None,.) -> T
+0000bae0: 7570 6c65 5b62 6f6f 6c2c 204f 7074 696f  uple[bool, Optio
+0000baf0: 6e61 6c5b 7374 725d 5d3a 0a20 2020 2022  nal[str]]:.    "
+0000bb00: 2222 5761 6974 2075 6e74 696c 2074 6865  ""Wait until the
+0000bb10: 2072 6179 2063 6c75 7374 6572 2069 7320   ray cluster is 
+0000bb20: 7365 7420 7570 206f 6e20 564d 7320 6f72  set up on VMs or
+0000bb30: 2069 6e20 636f 6e74 6169 6e65 7273 2e0a   in containers..
+0000bb40: 0a20 2020 2052 6574 7572 6e73 3a20 2077  .    Returns:  w
+0000bb50: 6865 7468 6572 2074 6865 2065 6e74 6972  hether the entir
+0000bb60: 6520 7261 7920 636c 7573 7465 7220 6973  e ray cluster is
+0000bb70: 2072 6561 6479 2c20 616e 6420 646f 636b   ready, and dock
+0000bb80: 6572 2075 7365 726e 616d 650a 2020 2020  er username.    
+0000bb90: 6966 206c 6175 6e63 6865 6420 7769 7468  if launched with
+0000bba0: 2064 6f63 6b65 722e 0a20 2020 2022 2222   docker..    """
+0000bbb0: 0a20 2020 2023 204d 616e 7561 6c6c 7920  .    # Manually 
+0000bbc0: 6665 7463 6869 6e67 2068 6561 6420 6970  fetching head ip
+0000bbd0: 2069 6e73 7465 6164 206f 6620 7573 696e   instead of usin
+0000bbe0: 6720 6072 6179 2065 7865 6360 2074 6f20  g `ray exec` to 
+0000bbf0: 6176 6f69 6420 7468 6520 6275 670a 2020  avoid the bug.  
+0000bc00: 2020 2320 7468 6174 2060 7261 7920 6578    # that `ray ex
+0000bc10: 6563 6020 6661 696c 7320 746f 2063 6f6e  ec` fails to con
+0000bc20: 6e65 6374 2074 6f20 7468 6520 6865 6164  nect to the head
+0000bc30: 206e 6f64 6520 6166 7465 7220 736f 6d65   node after some
+0000bc40: 2077 6f72 6b65 7273 0a20 2020 2023 206c   workers.    # l
+0000bc50: 6175 6e63 6865 6420 6573 7065 6369 616c  aunched especial
+0000bc60: 6c79 2066 6f72 2041 7a75 7265 2e0a 2020  ly for Azure..  
+0000bc70: 2020 7472 793a 0a20 2020 2020 2020 2068    try:.        h
+0000bc80: 6561 645f 6970 203d 205f 7175 6572 795f  ead_ip = _query_
+0000bc90: 6865 6164 5f69 705f 7769 7468 5f72 6574  head_ip_with_ret
+0000bca0: 7269 6573 280a 2020 2020 2020 2020 2020  ries(.          
+0000bcb0: 2020 636c 7573 7465 725f 636f 6e66 6967    cluster_config
+0000bcc0: 5f66 696c 652c 206d 6178 5f61 7474 656d  _file, max_attem
+0000bcd0: 7074 733d 5741 4954 5f48 4541 445f 4e4f  pts=WAIT_HEAD_NO
+0000bce0: 4445 5f49 505f 4d41 585f 4154 5445 4d50  DE_IP_MAX_ATTEMP
+0000bcf0: 5453 290a 2020 2020 6578 6365 7074 2065  TS).    except e
+0000bd00: 7863 6570 7469 6f6e 732e 4665 7463 6843  xceptions.FetchC
+0000bd10: 6c75 7374 6572 496e 666f 4572 726f 7220  lusterInfoError 
+0000bd20: 6173 2065 3a0a 2020 2020 2020 2020 6c6f  as e:.        lo
+0000bd30: 6767 6572 2e65 7272 6f72 2863 6f6d 6d6f  gger.error(commo
+0000bd40: 6e5f 7574 696c 732e 666f 726d 6174 5f65  n_utils.format_e
+0000bd50: 7863 6570 7469 6f6e 2865 2929 0a20 2020  xception(e)).   
+0000bd60: 2020 2020 2072 6574 7572 6e20 4661 6c73       return Fals
+0000bd70: 652c 204e 6f6e 6520 2023 2066 6169 6c65  e, None  # faile
+0000bd80: 640a 0a20 2020 2063 6f6e 6669 6720 3d20  d..    config = 
+0000bd90: 636f 6d6d 6f6e 5f75 7469 6c73 2e72 6561  common_utils.rea
+0000bda0: 645f 7961 6d6c 2863 6c75 7374 6572 5f63  d_yaml(cluster_c
+0000bdb0: 6f6e 6669 675f 6669 6c65 290a 0a20 2020  onfig_file)..   
+0000bdc0: 2064 6f63 6b65 725f 7573 6572 203d 204e   docker_user = N
+0000bdd0: 6f6e 650a 2020 2020 6966 2027 646f 636b  one.    if 'dock
+0000bde0: 6572 2720 696e 2063 6f6e 6669 673a 0a20  er' in config:. 
+0000bdf0: 2020 2020 2020 2064 6f63 6b65 725f 7573         docker_us
+0000be00: 6572 203d 2067 6574 5f64 6f63 6b65 725f  er = get_docker_
+0000be10: 7573 6572 2868 6561 645f 6970 2c20 636c  user(head_ip, cl
+0000be20: 7573 7465 725f 636f 6e66 6967 5f66 696c  uster_config_fil
+0000be30: 6529 0a0a 2020 2020 6966 206e 756d 5f6e  e)..    if num_n
+0000be40: 6f64 6573 203c 3d20 313a 0a20 2020 2020  odes <= 1:.     
+0000be50: 2020 2072 6574 7572 6e20 5472 7565 2c20     return True, 
+0000be60: 646f 636b 6572 5f75 7365 720a 0a20 2020  docker_user..   
+0000be70: 2073 7368 5f63 7265 6465 6e74 6961 6c73   ssh_credentials
+0000be80: 203d 2073 7368 5f63 7265 6465 6e74 6961   = ssh_credentia
+0000be90: 6c5f 6672 6f6d 5f79 616d 6c28 636c 7573  l_from_yaml(clus
+0000bea0: 7465 725f 636f 6e66 6967 5f66 696c 652c  ter_config_file,
+0000beb0: 2064 6f63 6b65 725f 7573 6572 290a 2020   docker_user).  
+0000bec0: 2020 6c61 7374 5f6e 6f64 6573 5f73 6f5f    last_nodes_so_
+0000bed0: 6661 7220 3d20 300a 2020 2020 7374 6172  far = 0.    star
+0000bee0: 7420 3d20 7469 6d65 2e74 696d 6528 290a  t = time.time().
+0000bef0: 2020 2020 7275 6e6e 6572 203d 2063 6f6d      runner = com
+0000bf00: 6d61 6e64 5f72 756e 6e65 722e 5353 4843  mand_runner.SSHC
+0000bf10: 6f6d 6d61 6e64 5275 6e6e 6572 286e 6f64  ommandRunner(nod
+0000bf20: 653d 2868 6561 645f 6970 2c20 3232 292c  e=(head_ip, 22),
+0000bf30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000bf40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bf50: 2020 2020 2020 2020 2020 2020 2020 2a2a                **
+0000bf60: 7373 685f 6372 6564 656e 7469 616c 7329  ssh_credentials)
+0000bf70: 0a20 2020 2077 6974 6820 7269 6368 5f75  .    with rich_u
+0000bf80: 7469 6c73 2e73 6166 655f 7374 6174 7573  tils.safe_status
+0000bf90: 280a 2020 2020 2020 2020 2020 2020 275b  (.            '[
+0000bfa0: 626f 6c64 2063 7961 6e5d 5761 6974 696e  bold cyan]Waitin
+0000bfb0: 6720 666f 7220 776f 726b 6572 732e 2e2e  g for workers...
+0000bfc0: 2729 2061 7320 776f 726b 6572 5f73 7461  ') as worker_sta
+0000bfd0: 7475 733a 0a20 2020 2020 2020 2077 6869  tus:.        whi
+0000bfe0: 6c65 2054 7275 653a 0a20 2020 2020 2020  le True:.       
+0000bff0: 2020 2020 2072 632c 206f 7574 7075 742c       rc, output,
+0000c000: 2073 7464 6572 7220 3d20 7275 6e6e 6572   stderr = runner
+0000c010: 2e72 756e 280a 2020 2020 2020 2020 2020  .run(.          
+0000c020: 2020 2020 2020 696e 7374 616e 6365 5f73        instance_s
+0000c030: 6574 7570 2e52 4159 5f53 5441 5455 535f  etup.RAY_STATUS_
+0000c040: 5749 5448 5f53 4b59 5f52 4159 5f50 4f52  WITH_SKY_RAY_POR
+0000c050: 545f 434f 4d4d 414e 442c 0a20 2020 2020  T_COMMAND,.     
+0000c060: 2020 2020 2020 2020 2020 206c 6f67 5f70             log_p
+0000c070: 6174 683d 6c6f 675f 7061 7468 2c0a 2020  ath=log_path,.  
+0000c080: 2020 2020 2020 2020 2020 2020 2020 7374                st
+0000c090: 7265 616d 5f6c 6f67 733d 4661 6c73 652c  ream_logs=False,
+0000c0a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c0b0: 2072 6571 7569 7265 5f6f 7574 7075 7473   require_outputs
+0000c0c0: 3d54 7275 652c 0a20 2020 2020 2020 2020  =True,.         
+0000c0d0: 2020 2020 2020 2073 6570 6172 6174 655f         separate_
+0000c0e0: 7374 6465 7272 3d54 7275 6529 0a20 2020  stderr=True).   
+0000c0f0: 2020 2020 2020 2020 2073 7562 7072 6f63           subproc
+0000c100: 6573 735f 7574 696c 732e 6861 6e64 6c65  ess_utils.handle
+0000c110: 5f72 6574 7572 6e63 6f64 6528 0a20 2020  _returncode(.   
+0000c120: 2020 2020 2020 2020 2020 2020 2072 632c               rc,
+0000c130: 2069 6e73 7461 6e63 655f 7365 7475 702e   instance_setup.
+0000c140: 5241 595f 5354 4154 5553 5f57 4954 485f  RAY_STATUS_WITH_
+0000c150: 534b 595f 5241 595f 504f 5254 5f43 4f4d  SKY_RAY_PORT_COM
+0000c160: 4d41 4e44 2c0a 2020 2020 2020 2020 2020  MAND,.          
+0000c170: 2020 2020 2020 2746 6169 6c65 6420 746f        'Failed to
+0000c180: 2072 756e 2072 6179 2073 7461 7475 7320   run ray status 
+0000c190: 6f6e 2068 6561 6420 6e6f 6465 2e27 2c20  on head node.', 
+0000c1a0: 7374 6465 7272 290a 2020 2020 2020 2020  stderr).        
+0000c1b0: 2020 2020 6c6f 6767 6572 2e64 6562 7567      logger.debug
+0000c1c0: 286f 7574 7075 7429 0a0a 2020 2020 2020  (output)..      
+0000c1d0: 2020 2020 2020 7265 6164 795f 6865 6164        ready_head
+0000c1e0: 2c20 7265 6164 795f 776f 726b 6572 7320  , ready_workers 
+0000c1f0: 3d20 5f63 6f75 6e74 5f68 6561 6c74 6879  = _count_healthy
+0000c200: 5f6e 6f64 6573 5f66 726f 6d5f 7261 7928  _nodes_from_ray(
+0000c210: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c220: 206f 7574 7075 742c 2069 735f 6c6f 6361   output, is_loca
+0000c230: 6c5f 636c 6f75 643d 6973 5f6c 6f63 616c  l_cloud=is_local
+0000c240: 5f63 6c6f 7564 290a 0a20 2020 2020 2020  _cloud)..       
+0000c250: 2020 2020 2077 6f72 6b65 725f 7374 6174       worker_stat
+0000c260: 7573 2e75 7064 6174 6528 275b 626f 6c64  us.update('[bold
+0000c270: 2063 7961 6e5d 270a 2020 2020 2020 2020   cyan]'.        
+0000c280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c290: 2020 2020 2020 2020 2066 277b 7265 6164           f'{read
+0000c2a0: 795f 776f 726b 6572 737d 206f 7574 206f  y_workers} out o
+0000c2b0: 6620 7b6e 756d 5f6e 6f64 6573 202d 2031  f {num_nodes - 1
+0000c2c0: 7d20 270a 2020 2020 2020 2020 2020 2020  } '.            
+0000c2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c2e0: 2020 2020 2027 776f 726b 6572 7320 7265       'workers re
+0000c2f0: 6164 7927 290a 0a20 2020 2020 2020 2020  ady')..         
+0000c300: 2020 2023 2049 6e20 7468 6520 6c6f 6361     # In the loca
+0000c310: 6c20 6361 7365 2c20 7265 6164 795f 6865  l case, ready_he
+0000c320: 6164 3d30 2061 6e64 2072 6561 6479 5f77  ad=0 and ready_w
+0000c330: 6f72 6b65 7273 3d6e 756d 5f6e 6f64 6573  orkers=num_nodes
+0000c340: 2e20 5468 6973 0a20 2020 2020 2020 2020  . This.         
+0000c350: 2020 2023 2069 7320 6265 6361 7573 6520     # is because 
+0000c360: 7468 6572 6520 6973 206e 6f20 6d61 7463  there is no matc
+0000c370: 6869 6e67 2072 6567 6578 2066 6f72 205f  hing regex for _
+0000c380: 4c41 554e 4348 4544 5f48 4541 445f 5041  LAUNCHED_HEAD_PA
+0000c390: 5454 4552 4e2e 0a20 2020 2020 2020 2020  TTERN..         
+0000c3a0: 2020 2069 6620 7265 6164 795f 6865 6164     if ready_head
+0000c3b0: 202b 2072 6561 6479 5f77 6f72 6b65 7273   + ready_workers
+0000c3c0: 203d 3d20 6e75 6d5f 6e6f 6465 733a 0a20   == num_nodes:. 
+0000c3d0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0000c3e0: 2041 6c6c 206e 6f64 6573 2061 7265 2075   All nodes are u
+0000c3f0: 702e 0a20 2020 2020 2020 2020 2020 2020  p..             
+0000c400: 2020 2062 7265 616b 0a0a 2020 2020 2020     break..      
+0000c410: 2020 2020 2020 2320 5065 6e64 696e 6720        # Pending 
+0000c420: 776f 726b 6572 7320 7468 6174 2068 6176  workers that hav
+0000c430: 6520 6265 656e 206c 6175 6e63 6865 6420  e been launched 
+0000c440: 6279 2072 6179 2075 702e 0a20 2020 2020  by ray up..     
+0000c450: 2020 2020 2020 2066 6f75 6e64 5f69 7073         found_ips
+0000c460: 203d 205f 4c41 554e 4348 494e 475f 4950   = _LAUNCHING_IP
+0000c470: 5f50 4154 5445 524e 2e66 696e 6461 6c6c  _PATTERN.findall
+0000c480: 286f 7574 7075 7429 0a20 2020 2020 2020  (output).       
+0000c490: 2020 2020 2070 656e 6469 6e67 5f77 6f72       pending_wor
+0000c4a0: 6b65 7273 203d 206c 656e 2866 6f75 6e64  kers = len(found
+0000c4b0: 5f69 7073 290a 0a20 2020 2020 2020 2020  _ips)..         
+0000c4c0: 2020 2023 2054 4f44 4f28 7a68 7775 293a     # TODO(zhwu):
+0000c4d0: 2048 616e 646c 6520 7468 6520 6361 7365   Handle the case
+0000c4e0: 2077 6865 7265 2074 6865 2066 6f6c 6c6f   where the follo
+0000c4f0: 7769 6e67 206f 6363 7572 732c 2077 6865  wing occurs, whe
+0000c500: 7265 2072 6179 0a20 2020 2020 2020 2020  re ray.         
+0000c510: 2020 2023 2063 6c75 7374 6572 2069 7320     # cluster is 
+0000c520: 6e6f 7420 636f 7272 6563 746c 7920 7374  not correctly st
+0000c530: 6172 7465 6420 6f6e 2074 6865 2063 6c75  arted on the clu
+0000c540: 7374 6572 2e0a 2020 2020 2020 2020 2020  ster..          
+0000c550: 2020 2320 5065 6e64 696e 673a 0a20 2020    # Pending:.   
+0000c560: 2020 2020 2020 2020 2023 2020 3137 322e           #  172.
+0000c570: 3331 2e39 2e31 3231 3a20 7261 792e 776f  31.9.121: ray.wo
+0000c580: 726b 6572 2e64 6566 6175 6c74 2c20 756e  rker.default, un
+0000c590: 696e 6974 6961 6c69 7a65 640a 2020 2020  initialized.    
+0000c5a0: 2020 2020 2020 2020 6e6f 6465 735f 736f          nodes_so
+0000c5b0: 5f66 6172 203d 2072 6561 6479 5f68 6561  _far = ready_hea
+0000c5c0: 6420 2b20 7265 6164 795f 776f 726b 6572  d + ready_worker
+0000c5d0: 7320 2b20 7065 6e64 696e 675f 776f 726b  s + pending_work
+0000c5e0: 6572 730a 0a20 2020 2020 2020 2020 2020  ers..           
+0000c5f0: 2023 2043 6865 636b 2074 6865 206e 756d   # Check the num
+0000c600: 6265 7220 6f66 206e 6f64 6573 2074 6861  ber of nodes tha
+0000c610: 7420 6172 6520 6665 7463 6865 642e 2054  t are fetched. T
+0000c620: 696d 656f 7574 2069 6620 6e6f 206e 6577  imeout if no new
+0000c630: 0a20 2020 2020 2020 2020 2020 2023 206e  .            # n
+0000c640: 6f64 6573 2066 6574 6368 6564 2069 6e20  odes fetched in 
+0000c650: 6120 7768 696c 6520 286e 6f64 6573 5f6c  a while (nodes_l
+0000c660: 6175 6e63 6869 6e67 5f70 726f 6772 6573  aunching_progres
+0000c670: 735f 7469 6d65 6f75 7429 2c0a 2020 2020  s_timeout),.    
+0000c680: 2020 2020 2020 2020 2320 7468 6f75 6768          # though
+0000c690: 206e 756d 6265 7220 6f66 206e 6f64 6573   number of nodes
+0000c6a0: 5f73 6f5f 6661 7220 6973 2073 7469 6c6c  _so_far is still
+0000c6b0: 206e 6f74 2061 7320 6578 7065 6374 6564   not as expected
+0000c6c0: 2e0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+0000c6d0: 206e 6f64 6573 5f73 6f5f 6661 7220 3e20   nodes_so_far > 
+0000c6e0: 6c61 7374 5f6e 6f64 6573 5f73 6f5f 6661  last_nodes_so_fa
+0000c6f0: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
+0000c700: 2020 2023 2052 6573 6574 2074 6865 2073     # Reset the s
+0000c710: 7461 7274 2074 696d 6520 6966 2074 6865  tart time if the
+0000c720: 206e 756d 6265 7220 6f66 206c 6175 6e63   number of launc
+0000c730: 6869 6e67 206e 6f64 6573 0a20 2020 2020  hing nodes.     
+0000c740: 2020 2020 2020 2020 2020 2023 2063 6861             # cha
+0000c750: 6e67 6573 2c20 692e 652e 206e 6577 206e  nges, i.e. new n
+0000c760: 6f64 6573 2061 7265 206c 6175 6e63 6865  odes are launche
+0000c770: 642e 0a20 2020 2020 2020 2020 2020 2020  d..             
+0000c780: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
+0000c790: 2752 6573 6574 2073 7461 7274 2074 696d  'Reset start tim
+0000c7a0: 652c 2061 7320 6e65 7720 6e6f 6465 7320  e, as new nodes 
+0000c7b0: 6172 6520 6c61 756e 6368 6564 2e20 270a  are launched. '.
+0000c7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c7d0: 2020 2020 2020 2020 2020 2020 2066 2728               f'(
+0000c7e0: 7b6c 6173 745f 6e6f 6465 735f 736f 5f66  {last_nodes_so_f
+0000c7f0: 6172 7d20 2d3e 207b 6e6f 6465 735f 736f  ar} -> {nodes_so
+0000c800: 5f66 6172 7d29 2729 0a20 2020 2020 2020  _far})').       
+0000c810: 2020 2020 2020 2020 2073 7461 7274 203d           start =
+0000c820: 2074 696d 652e 7469 6d65 2829 0a20 2020   time.time().   
+0000c830: 2020 2020 2020 2020 2020 2020 206c 6173               las
+0000c840: 745f 6e6f 6465 735f 736f 5f66 6172 203d  t_nodes_so_far =
+0000c850: 206e 6f64 6573 5f73 6f5f 6661 720a 2020   nodes_so_far.  
+0000c860: 2020 2020 2020 2020 2020 656c 6966 2028            elif (
+0000c870: 6e6f 6465 735f 6c61 756e 6368 696e 675f  nodes_launching_
+0000c880: 7072 6f67 7265 7373 5f74 696d 656f 7574  progress_timeout
+0000c890: 2069 7320 6e6f 7420 4e6f 6e65 2061 6e64   is not None and
+0000c8a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c8b0: 2020 2074 696d 652e 7469 6d65 2829 202d     time.time() -
+0000c8c0: 2073 7461 7274 203e 206e 6f64 6573 5f6c   start > nodes_l
+0000c8d0: 6175 6e63 6869 6e67 5f70 726f 6772 6573  aunching_progres
+0000c8e0: 735f 7469 6d65 6f75 7420 616e 640a 2020  s_timeout and.  
+0000c8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c900: 6e6f 6465 735f 736f 5f66 6172 2021 3d20  nodes_so_far != 
+0000c910: 6e75 6d5f 6e6f 6465 7329 3a0a 2020 2020  num_nodes):.    
+0000c920: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+0000c930: 6572 2e65 7272 6f72 280a 2020 2020 2020  er.error(.      
+0000c940: 2020 2020 2020 2020 2020 2020 2020 2754                'T
+0000c950: 696d 6564 206f 7574 3a20 7761 6974 6564  imed out: waited
+0000c960: 2066 6f72 206d 6f72 6520 7468 616e 2027   for more than '
+0000c970: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c980: 2020 2020 2066 277b 6e6f 6465 735f 6c61       f'{nodes_la
+0000c990: 756e 6368 696e 675f 7072 6f67 7265 7373  unching_progress
+0000c9a0: 5f74 696d 656f 7574 7d20 7365 636f 6e64  _timeout} second
+0000c9b0: 7320 666f 7220 6e65 7720 270a 2020 2020  s for new '.    
+0000c9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c9d0: 2777 6f72 6b65 7273 2074 6f20 6265 2070  'workers to be p
+0000c9e0: 726f 7669 7369 6f6e 6564 2c20 6275 7420  rovisioned, but 
+0000c9f0: 6e6f 2070 726f 6772 6573 732e 2729 0a20  no progress.'). 
+0000ca00: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0000ca10: 6574 7572 6e20 4661 6c73 652c 204e 6f6e  eturn False, Non
+0000ca20: 6520 2023 2066 6169 6c65 640a 0a20 2020  e  # failed..   
+0000ca30: 2020 2020 2020 2020 2069 6620 2728 6e6f           if '(no
+0000ca40: 2070 656e 6469 6e67 206e 6f64 6573 2927   pending nodes)'
+0000ca50: 2069 6e20 6f75 7470 7574 2061 6e64 2027   in output and '
+0000ca60: 286e 6f20 6661 696c 7572 6573 2927 2069  (no failures)' i
+0000ca70: 6e20 6f75 7470 7574 3a0a 2020 2020 2020  n output:.      
+0000ca80: 2020 2020 2020 2020 2020 2320 4275 6720            # Bug 
+0000ca90: 696e 2072 6179 2061 7574 6f73 6361 6c65  in ray autoscale
+0000caa0: 723a 2065 2e67 2e2c 206f 6e20 4743 502c  r: e.g., on GCP,
+0000cab0: 2069 6620 7265 7175 6573 7469 6e67 2032   if requesting 2
+0000cac0: 206e 6f64 6573 0a20 2020 2020 2020 2020   nodes.         
+0000cad0: 2020 2020 2020 2023 2074 6861 7420 4743         # that GC
+0000cae0: 5020 6361 6e20 7361 7469 7366 7920 6f6e  P can satisfy on
+0000caf0: 6c79 2062 7920 6861 6c66 2c20 7468 6520  ly by half, the 
+0000cb00: 776f 726b 6572 206e 6f64 6520 776f 756c  worker node woul
+0000cb10: 6420 6265 0a20 2020 2020 2020 2020 2020  d be.           
+0000cb20: 2020 2020 2023 2066 6f72 676f 7474 656e       # forgotten
+0000cb30: 2e20 5468 6520 636f 7272 6563 7420 6265  . The correct be
+0000cb40: 6861 7669 6f72 2073 686f 756c 6420 6265  havior should be
+0000cb50: 2066 6f72 2069 7420 746f 2065 7272 6f72   for it to error
+0000cb60: 206f 7574 2e0a 2020 2020 2020 2020 2020   out..          
+0000cb70: 2020 2020 2020 6c6f 6767 6572 2e65 7272        logger.err
+0000cb80: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+0000cb90: 2020 2020 2020 2020 2746 6169 6c65 6420          'Failed 
+0000cba0: 746f 206c 6175 6e63 6820 6d75 6c74 6970  to launch multip
+0000cbb0: 6c65 206e 6f64 6573 206f 6e20 270a 2020  le nodes on '.  
+0000cbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cbd0: 2020 2747 4350 2064 7565 2074 6f20 6120    'GCP due to a 
+0000cbe0: 6e6f 6e64 6574 6572 6d69 6e69 7374 6963  nondeterministic
+0000cbf0: 2062 7567 2069 6e20 7261 7920 6175 746f   bug in ray auto
+0000cc00: 7363 616c 6572 2e27 290a 2020 2020 2020  scaler.').      
+0000cc10: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000cc20: 2046 616c 7365 2c20 4e6f 6e65 2020 2320   False, None  # 
+0000cc30: 6661 696c 6564 0a20 2020 2020 2020 2020  failed.         
+0000cc40: 2020 2074 696d 652e 736c 6565 7028 3130     time.sleep(10
+0000cc50: 290a 2020 2020 7265 7475 726e 2054 7275  ).    return Tru
+0000cc60: 652c 2064 6f63 6b65 725f 7573 6572 2020  e, docker_user  
+0000cc70: 2320 7375 6363 6573 730a 0a0a 6465 6620  # success...def 
+0000cc80: 7373 685f 6372 6564 656e 7469 616c 5f66  ssh_credential_f
+0000cc90: 726f 6d5f 7961 6d6c 280a 2020 2020 636c  rom_yaml(.    cl
+0000cca0: 7573 7465 725f 7961 6d6c 3a20 7374 722c  uster_yaml: str,
+0000ccb0: 0a20 2020 2064 6f63 6b65 725f 7573 6572  .    docker_user
+0000ccc0: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
+0000ccd0: 3d20 4e6f 6e65 2c0a 2020 2020 7373 685f  = None,.    ssh_
+0000cce0: 7573 6572 3a20 4f70 7469 6f6e 616c 5b73  user: Optional[s
+0000ccf0: 7472 5d20 3d20 4e6f 6e65 2c0a 2920 2d3e  tr] = None,.) ->
+0000cd00: 2044 6963 745b 7374 722c 2041 6e79 5d3a   Dict[str, Any]:
+0000cd10: 0a20 2020 2022 2222 5265 7475 726e 7320  .    """Returns 
+0000cd20: 7373 685f 7573 6572 2c20 7373 685f 7072  ssh_user, ssh_pr
+0000cd30: 6976 6174 655f 6b65 7920 616e 6420 7373  ivate_key and ss
+0000cd40: 685f 636f 6e74 726f 6c20 6e61 6d65 2e0a  h_control name..
+0000cd50: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
+0000cd60: 2020 2063 6c75 7374 6572 5f79 616d 6c3a     cluster_yaml:
+0000cd70: 2070 6174 6820 746f 2074 6865 2063 6c75   path to the clu
+0000cd80: 7374 6572 2079 616d 6c2e 0a20 2020 2020  ster yaml..     
+0000cd90: 2020 2064 6f63 6b65 725f 7573 6572 3a20     docker_user: 
+0000cda0: 7768 656e 2075 7369 6e67 2063 7573 746f  when using custo
+0000cdb0: 6d20 646f 636b 6572 2069 6d61 6765 2c20  m docker image, 
+0000cdc0: 7573 6520 7468 6973 2075 7365 7220 746f  use this user to
+0000cdd0: 2073 7368 2069 6e74 6f0a 2020 2020 2020   ssh into.      
+0000cde0: 2020 2020 2020 7468 6520 646f 636b 6572        the docker
+0000cdf0: 2063 6f6e 7461 696e 6572 2e0a 2020 2020   container..    
+0000ce00: 2020 2020 7373 685f 7573 6572 3a20 6f76      ssh_user: ov
+0000ce10: 6572 7269 6465 2074 6865 2073 7368 5f75  erride the ssh_u
+0000ce20: 7365 7220 696e 2074 6865 2063 6c75 7374  ser in the clust
+0000ce30: 6572 2079 616d 6c2e 0a20 2020 2022 2222  er yaml..    """
+0000ce40: 0a20 2020 2063 6f6e 6669 6720 3d20 636f  .    config = co
+0000ce50: 6d6d 6f6e 5f75 7469 6c73 2e72 6561 645f  mmon_utils.read_
+0000ce60: 7961 6d6c 2863 6c75 7374 6572 5f79 616d  yaml(cluster_yam
+0000ce70: 6c29 0a20 2020 2061 7574 685f 7365 6374  l).    auth_sect
+0000ce80: 696f 6e20 3d20 636f 6e66 6967 5b27 6175  ion = config['au
+0000ce90: 7468 275d 0a20 2020 2069 6620 7373 685f  th'].    if ssh_
+0000cea0: 7573 6572 2069 7320 4e6f 6e65 3a0a 2020  user is None:.  
+0000ceb0: 2020 2020 2020 7373 685f 7573 6572 203d        ssh_user =
+0000cec0: 2061 7574 685f 7365 6374 696f 6e5b 2773   auth_section['s
+0000ced0: 7368 5f75 7365 7227 5d2e 7374 7269 7028  sh_user'].strip(
+0000cee0: 290a 2020 2020 7373 685f 7072 6976 6174  ).    ssh_privat
+0000cef0: 655f 6b65 7920 3d20 6175 7468 5f73 6563  e_key = auth_sec
+0000cf00: 7469 6f6e 2e67 6574 2827 7373 685f 7072  tion.get('ssh_pr
+0000cf10: 6976 6174 655f 6b65 7927 290a 2020 2020  ivate_key').    
+0000cf20: 7373 685f 636f 6e74 726f 6c5f 6e61 6d65  ssh_control_name
+0000cf30: 203d 2063 6f6e 6669 672e 6765 7428 2763   = config.get('c
+0000cf40: 6c75 7374 6572 5f6e 616d 6527 2c20 275f  luster_name', '_
+0000cf50: 5f64 6566 6175 6c74 5f5f 2729 0a20 2020  _default__').   
+0000cf60: 2073 7368 5f70 726f 7879 5f63 6f6d 6d61   ssh_proxy_comma
+0000cf70: 6e64 203d 2061 7574 685f 7365 6374 696f  nd = auth_sectio
+0000cf80: 6e2e 6765 7428 2773 7368 5f70 726f 7879  n.get('ssh_proxy
+0000cf90: 5f63 6f6d 6d61 6e64 2729 0a20 2020 2063  _command').    c
+0000cfa0: 7265 6465 6e74 6961 6c73 203d 207b 0a20  redentials = {. 
+0000cfb0: 2020 2020 2020 2027 7373 685f 7573 6572         'ssh_user
+0000cfc0: 273a 2073 7368 5f75 7365 722c 0a20 2020  ': ssh_user,.   
+0000cfd0: 2020 2020 2027 7373 685f 7072 6976 6174       'ssh_privat
+0000cfe0: 655f 6b65 7927 3a20 7373 685f 7072 6976  e_key': ssh_priv
+0000cff0: 6174 655f 6b65 792c 0a20 2020 2020 2020  ate_key,.       
+0000d000: 2027 7373 685f 636f 6e74 726f 6c5f 6e61   'ssh_control_na
+0000d010: 6d65 273a 2073 7368 5f63 6f6e 7472 6f6c  me': ssh_control
+0000d020: 5f6e 616d 652c 0a20 2020 2020 2020 2027  _name,.        '
+0000d030: 7373 685f 7072 6f78 795f 636f 6d6d 616e  ssh_proxy_comman
+0000d040: 6427 3a20 7373 685f 7072 6f78 795f 636f  d': ssh_proxy_co
+0000d050: 6d6d 616e 642c 0a20 2020 207d 0a20 2020  mmand,.    }.   
+0000d060: 2069 6620 646f 636b 6572 5f75 7365 7220   if docker_user 
+0000d070: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+0000d080: 2020 2020 2063 7265 6465 6e74 6961 6c73       credentials
+0000d090: 5b27 646f 636b 6572 5f75 7365 7227 5d20  ['docker_user'] 
+0000d0a0: 3d20 646f 636b 6572 5f75 7365 720a 2020  = docker_user.  
+0000d0b0: 2020 7373 685f 7072 6f76 6964 6572 5f6d    ssh_provider_m
+0000d0c0: 6f64 756c 6520 3d20 636f 6e66 6967 5b27  odule = config['
+0000d0d0: 7072 6f76 6964 6572 275d 5b27 6d6f 6475  provider']['modu
+0000d0e0: 6c65 275d 0a20 2020 2023 2049 6620 7765  le'].    # If we
+0000d0f0: 2061 7265 2072 756e 6e69 6e67 2073 7368   are running ssh
+0000d100: 2063 6f6d 6d61 6e64 206f 6e20 6b75 6265   command on kube
+0000d110: 726e 6574 6573 206e 6f64 652e 0a20 2020  rnetes node..   
+0000d120: 2069 6620 276b 7562 6572 6e65 7465 7327   if 'kubernetes'
+0000d130: 2069 6e20 7373 685f 7072 6f76 6964 6572   in ssh_provider
+0000d140: 5f6d 6f64 756c 653a 0a20 2020 2020 2020  _module:.       
+0000d150: 2063 7265 6465 6e74 6961 6c73 5b27 6469   credentials['di
+0000d160: 7361 626c 655f 636f 6e74 726f 6c5f 6d61  sable_control_ma
+0000d170: 7374 6572 275d 203d 2054 7275 650a 2020  ster'] = True.  
+0000d180: 2020 7265 7475 726e 2063 7265 6465 6e74    return credent
+0000d190: 6961 6c73 0a0a 0a64 6566 2070 6172 616c  ials...def paral
+0000d1a0: 6c65 6c5f 6461 7461 5f74 7261 6e73 6665  lel_data_transfe
+0000d1b0: 725f 746f 5f6e 6f64 6573 280a 2020 2020  r_to_nodes(.    
+0000d1c0: 7275 6e6e 6572 733a 204c 6973 745b 636f  runners: List[co
+0000d1d0: 6d6d 616e 645f 7275 6e6e 6572 2e43 6f6d  mmand_runner.Com
+0000d1e0: 6d61 6e64 5275 6e6e 6572 5d2c 0a20 2020  mandRunner],.   
+0000d1f0: 2073 6f75 7263 653a 204f 7074 696f 6e61   source: Optiona
+0000d200: 6c5b 7374 725d 2c0a 2020 2020 7461 7267  l[str],.    targ
+0000d210: 6574 3a20 7374 722c 0a20 2020 2063 6d64  et: str,.    cmd
+0000d220: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d2c  : Optional[str],
+0000d230: 0a20 2020 2072 756e 5f72 7379 6e63 3a20  .    run_rsync: 
+0000d240: 626f 6f6c 2c0a 2020 2020 2a2c 0a20 2020  bool,.    *,.   
+0000d250: 2061 6374 696f 6e5f 6d65 7373 6167 653a   action_message:
+0000d260: 2073 7472 2c0a 2020 2020 2320 4164 7661   str,.    # Adva
+0000d270: 6e63 6564 206f 7074 696f 6e73 2e0a 2020  nced options..  
+0000d280: 2020 6c6f 675f 7061 7468 3a20 7374 7220    log_path: str 
+0000d290: 3d20 6f73 2e64 6576 6e75 6c6c 2c0a 2020  = os.devnull,.  
+0000d2a0: 2020 7374 7265 616d 5f6c 6f67 733a 2062    stream_logs: b
+0000d2b0: 6f6f 6c20 3d20 4661 6c73 652c 0a20 2020  ool = False,.   
+0000d2c0: 2073 6f75 7263 655f 6261 7368 7263 3a20   source_bashrc: 
+0000d2d0: 626f 6f6c 203d 2046 616c 7365 2c0a 293a  bool = False,.):
+0000d2e0: 0a20 2020 2022 2222 5275 6e73 2061 2063  .    """Runs a c
+0000d2f0: 6f6d 6d61 6e64 206f 6e20 616c 6c20 6e6f  ommand on all no
+0000d300: 6465 7320 616e 6420 6f70 7469 6f6e 616c  des and optional
+0000d310: 6c79 2072 756e 7320 7273 796e 6320 6672  ly runs rsync fr
+0000d320: 6f6d 2073 7263 2d3e 6473 742e 0a0a 2020  om src->dst...  
+0000d330: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+0000d340: 7275 6e6e 6572 733a 2041 206c 6973 7420  runners: A list 
+0000d350: 6f66 2043 6f6d 6d61 6e64 5275 6e6e 6572  of CommandRunner
+0000d360: 206f 626a 6563 7473 2074 6861 7420 7265   objects that re
+0000d370: 7072 6573 656e 7420 6d75 6c74 6970 6c65  present multiple
+0000d380: 206e 6f64 6573 2e0a 2020 2020 2020 2020   nodes..        
+0000d390: 736f 7572 6365 3a20 4f70 7469 6f6e 616c  source: Optional
+0000d3a0: 5b73 7472 5d3b 2053 6f75 7263 6520 666f  [str]; Source fo
+0000d3b0: 7220 7273 796e 6320 6f6e 206c 6f63 616c  r rsync on local
+0000d3c0: 206e 6f64 650a 2020 2020 2020 2020 7461   node.        ta
+0000d3d0: 7267 6574 3a20 7374 723b 2044 6573 7469  rget: str; Desti
+0000d3e0: 6e61 7469 6f6e 206f 6e20 7265 6d6f 7465  nation on remote
+0000d3f0: 206e 6f64 6520 666f 7220 7273 796e 630a   node for rsync.
+0000d400: 2020 2020 2020 2020 636d 643a 2073 7472          cmd: str
+0000d410: 3b20 436f 6d6d 616e 6420 746f 2062 6520  ; Command to be 
+0000d420: 6578 6563 7574 6564 206f 6e20 616c 6c20  executed on all 
+0000d430: 6e6f 6465 730a 2020 2020 2020 2020 6163  nodes.        ac
+0000d440: 7469 6f6e 5f6d 6573 7361 6765 3a20 7374  tion_message: st
+0000d450: 723b 204d 6573 7361 6765 2074 6f20 6265  r; Message to be
+0000d460: 2070 7269 6e74 6564 2077 6869 6c65 2074   printed while t
+0000d470: 6865 2063 6f6d 6d61 6e64 2072 756e 730a  he command runs.
+0000d480: 2020 2020 2020 2020 6c6f 675f 7061 7468          log_path
+0000d490: 3a20 7374 723b 2050 6174 6820 746f 2074  : str; Path to t
+0000d4a0: 6865 206c 6f67 2066 696c 650a 2020 2020  he log file.    
+0000d4b0: 2020 2020 7374 7265 616d 5f6c 6f67 733a      stream_logs:
+0000d4c0: 2062 6f6f 6c3b 2057 6865 7468 6572 2074   bool; Whether t
+0000d4d0: 6f20 7374 7265 616d 206c 6f67 7320 746f  o stream logs to
+0000d4e0: 2073 7464 6f75 740a 2020 2020 2020 2020   stdout.        
+0000d4f0: 736f 7572 6365 5f62 6173 6872 633a 2062  source_bashrc: b
+0000d500: 6f6f 6c3b 2053 6f75 7263 6520 6261 7368  ool; Source bash
+0000d510: 7263 2062 6566 6f72 6520 7275 6e6e 696e  rc before runnin
+0000d520: 6720 7468 6520 636f 6d6d 616e 642e 0a20  g the command.. 
+0000d530: 2020 2022 2222 0a20 2020 2066 6f72 6520     """.    fore 
+0000d540: 3d20 636f 6c6f 7261 6d61 2e46 6f72 650a  = colorama.Fore.
+0000d550: 2020 2020 7374 796c 6520 3d20 636f 6c6f      style = colo
+0000d560: 7261 6d61 2e53 7479 6c65 0a0a 2020 2020  rama.Style..    
+0000d570: 6f72 6967 696e 5f73 6f75 7263 6520 3d20  origin_source = 
+0000d580: 736f 7572 6365 0a0a 2020 2020 6465 6620  source..    def 
+0000d590: 5f73 796e 635f 6e6f 6465 2872 756e 6e65  _sync_node(runne
+0000d5a0: 723a 2027 636f 6d6d 616e 645f 7275 6e6e  r: 'command_runn
+0000d5b0: 6572 2e43 6f6d 6d61 6e64 5275 6e6e 6572  er.CommandRunner
+0000d5c0: 2729 202d 3e20 4e6f 6e65 3a0a 2020 2020  ') -> None:.    
+0000d5d0: 2020 2020 6966 2063 6d64 2069 7320 6e6f      if cmd is no
+0000d5e0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+0000d5f0: 2020 2020 7263 2c20 7374 646f 7574 2c20      rc, stdout, 
+0000d600: 7374 6465 7272 203d 2072 756e 6e65 722e  stderr = runner.
+0000d610: 7275 6e28 636d 642c 0a20 2020 2020 2020  run(cmd,.       
+0000d620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d640: 2020 2020 206c 6f67 5f70 6174 683d 6c6f       log_path=lo
+0000d650: 675f 7061 7468 2c0a 2020 2020 2020 2020  g_path,.        
 0000d660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d670: 2063 6865 636b 3d46 616c 7365 290a 2020   check=False).  
-0000d680: 2020 6973 5f69 6e73 7461 6c6c 6564 203d    is_installed =
-0000d690: 2069 6e73 7461 6c6c 6174 696f 6e5f 6368   installation_ch
-0000d6a0: 6563 6b2e 7265 7475 726e 636f 6465 203d  eck.returncode =
-0000d6b0: 3d20 300a 2020 2020 6966 2069 735f 696e  = 0.    if is_in
-0000d6c0: 7374 616c 6c65 643a 0a20 2020 2020 2020  stalled:.       
-0000d6d0: 2065 7865 6375 7469 6f6e 5f63 6865 636b   execution_check
-0000d6e0: 203d 2073 7562 7072 6f63 6573 732e 7275   = subprocess.ru
-0000d6f0: 6e28 5b27 6e76 6964 6961 2d73 6d69 275d  n(['nvidia-smi']
-0000d700: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000d710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d720: 2020 2020 2020 2020 2020 2073 7464 6f75             stdou
-0000d730: 743d 7375 6270 726f 6365 7373 2e44 4556  t=subprocess.DEV
-0000d740: 4e55 4c4c 2c0a 2020 2020 2020 2020 2020  NULL,.          
-0000d750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d760: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000d770: 7464 6572 723d 7375 6270 726f 6365 7373  tderr=subprocess
-0000d780: 2e44 4556 4e55 4c4c 2c0a 2020 2020 2020  .DEVNULL,.      
-0000d790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d680: 2020 2020 7374 7265 616d 5f6c 6f67 733d      stream_logs=
+0000d690: 7374 7265 616d 5f6c 6f67 732c 0a20 2020  stream_logs,.   
+0000d6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d6c0: 2020 2020 2020 2020 2072 6571 7569 7265           require
+0000d6d0: 5f6f 7574 7075 7473 3d54 7275 652c 0a20  _outputs=True,. 
+0000d6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d700: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
+0000d710: 655f 6261 7368 7263 3d73 6f75 7263 655f  e_bashrc=source_
+0000d720: 6261 7368 7263 290a 2020 2020 2020 2020  bashrc).        
+0000d730: 2020 2020 6572 725f 6d73 6720 3d20 2827      err_msg = ('
+0000d740: 4661 696c 6564 2074 6f20 7275 6e20 636f  Failed to run co
+0000d750: 6d6d 616e 6420 6265 666f 7265 2072 7379  mmand before rsy
+0000d760: 6e63 2027 0a20 2020 2020 2020 2020 2020  nc '.           
+0000d770: 2020 2020 2020 2020 2020 2020 6627 7b6f              f'{o
+0000d780: 7269 6769 6e5f 736f 7572 6365 7d20 2d3e  rigin_source} ->
+0000d790: 207b 7461 7267 6574 7d2e 2027 0a20 2020   {target}. '.   
 0000d7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d7b0: 2020 2063 6865 636b 3d46 616c 7365 290a     check=False).
-0000d7c0: 2020 2020 2020 2020 6973 5f66 756e 6374          is_funct
-0000d7d0: 696f 6e61 6c20 3d20 6578 6563 7574 696f  ional = executio
-0000d7e0: 6e5f 6368 6563 6b2e 7265 7475 726e 636f  n_check.returnco
-0000d7f0: 6465 203d 3d20 300a 2020 2020 7265 7475  de == 0.    retu
-0000d800: 726e 2069 735f 6675 6e63 7469 6f6e 616c  rn is_functional
-0000d810: 0a0a 0a64 6566 2067 656e 6572 6174 655f  ...def generate_
-0000d820: 636c 7573 7465 725f 6e61 6d65 2829 3a0a  cluster_name():.
-0000d830: 2020 2020 2320 544f 444f 3a20 6368 616e      # TODO: chan
-0000d840: 6765 2074 6869 7320 4944 2066 6f72 6d61  ge this ID forma
-0000d850: 7474 696e 6720 746f 2073 6f6d 6574 6869  tting to somethi
-0000d860: 6e67 206d 6f72 6520 706c 6561 7361 6e74  ng more pleasant
-0000d870: 2e0a 2020 2020 2320 5573 6572 206e 616d  ..    # User nam
-0000d880: 6520 6973 2068 656c 7066 756c 2069 6e20  e is helpful in 
-0000d890: 6e6f 6e2d 6973 6f6c 6174 6564 2061 6363  non-isolated acc
-0000d8a0: 6f75 6e74 732c 2065 2e67 2e2c 2047 4350  ounts, e.g., GCP
-0000d8b0: 2c20 417a 7572 652e 0a20 2020 2072 6574  , Azure..    ret
-0000d8c0: 7572 6e20 6627 736b 792d 7b75 7569 642e  urn f'sky-{uuid.
-0000d8d0: 7575 6964 3428 292e 6865 785b 3a34 5d7d  uuid4().hex[:4]}
-0000d8e0: 2d7b 636f 6d6d 6f6e 5f75 7469 6c73 2e67  -{common_utils.g
-0000d8f0: 6574 5f63 6c65 616e 6564 5f75 7365 726e  et_cleaned_usern
-0000d900: 616d 6528 297d 270a 0a0a 6465 6620 5f71  ame()}'...def _q
-0000d910: 7565 7279 5f68 6561 645f 6970 5f77 6974  uery_head_ip_wit
-0000d920: 685f 7265 7472 6965 7328 636c 7573 7465  h_retries(cluste
-0000d930: 725f 7961 6d6c 3a20 7374 722c 0a20 2020  r_yaml: str,.   
-0000d940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d950: 2020 2020 2020 2020 2020 2020 206d 6178               max
-0000d960: 5f61 7474 656d 7074 733a 2069 6e74 203d  _attempts: int =
-0000d970: 2031 2920 2d3e 2073 7472 3a0a 2020 2020   1) -> str:.    
-0000d980: 2222 2252 6574 7572 6e73 2074 6865 2049  """Returns the I
-0000d990: 5020 6f66 2074 6865 2068 6561 6420 6e6f  P of the head no
-0000d9a0: 6465 2062 7920 7175 6572 7969 6e67 2074  de by querying t
-0000d9b0: 6865 2063 6c6f 7564 2e0a 0a20 2020 2052  he cloud...    R
-0000d9c0: 6169 7365 733a 0a20 2020 2020 2065 7863  aises:.      exc
-0000d9d0: 6570 7469 6f6e 732e 4665 7463 6849 5045  eptions.FetchIPE
-0000d9e0: 7272 6f72 3a20 6966 2077 6520 6661 696c  rror: if we fail
-0000d9f0: 6564 2074 6f20 6765 7420 7468 6520 6865  ed to get the he
-0000da00: 6164 2049 502e 0a20 2020 2022 2222 0a20  ad IP..    """. 
-0000da10: 2020 2062 6163 6b6f 6666 203d 2063 6f6d     backoff = com
-0000da20: 6d6f 6e5f 7574 696c 732e 4261 636b 6f66  mon_utils.Backof
-0000da30: 6628 696e 6974 6961 6c5f 6261 636b 6f66  f(initial_backof
-0000da40: 663d 352c 206d 6178 5f62 6163 6b6f 6666  f=5, max_backoff
-0000da50: 5f66 6163 746f 723d 3529 0a20 2020 2066  _factor=5).    f
-0000da60: 6f72 2069 2069 6e20 7261 6e67 6528 6d61  or i in range(ma
-0000da70: 785f 6174 7465 6d70 7473 293a 0a20 2020  x_attempts):.   
-0000da80: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-0000da90: 2020 2020 2020 6675 6c6c 5f63 6c75 7374        full_clust
-0000daa0: 6572 5f79 616d 6c20 3d20 7374 7228 7061  er_yaml = str(pa
-0000dab0: 7468 6c69 622e 5061 7468 2863 6c75 7374  thlib.Path(clust
-0000dac0: 6572 5f79 616d 6c29 2e65 7870 616e 6475  er_yaml).expandu
-0000dad0: 7365 7228 2929 0a20 2020 2020 2020 2020  ser()).         
-0000dae0: 2020 206f 7574 203d 2073 7562 7072 6f63     out = subproc
-0000daf0: 6573 735f 7574 696c 732e 7275 6e28 0a20  ess_utils.run(. 
-0000db00: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000db10: 2772 6179 2067 6574 2d68 6561 642d 6970  'ray get-head-ip
-0000db20: 207b 6675 6c6c 5f63 6c75 7374 6572 5f79   {full_cluster_y
-0000db30: 616d 6c21 727d 272c 0a20 2020 2020 2020  aml!r}',.       
-0000db40: 2020 2020 2020 2020 2073 7464 6f75 743d           stdout=
-0000db50: 7375 6270 726f 6365 7373 2e50 4950 452c  subprocess.PIPE,
-0000db60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000db70: 2073 7464 6572 723d 7375 6270 726f 6365   stderr=subproce
-0000db80: 7373 2e44 4556 4e55 4c4c 292e 7374 646f  ss.DEVNULL).stdo
-0000db90: 7574 2e64 6563 6f64 6528 292e 7374 7269  ut.decode().stri
-0000dba0: 7028 290a 2020 2020 2020 2020 2020 2020  p().            
-0000dbb0: 6865 6164 5f69 705f 6c69 7374 203d 2072  head_ip_list = r
-0000dbc0: 652e 6669 6e64 616c 6c28 4950 5f41 4444  e.findall(IP_ADD
-0000dbd0: 525f 5245 4745 582c 206f 7574 290a 2020  R_REGEX, out).  
-0000dbe0: 2020 2020 2020 2020 2020 6966 206c 656e            if len
-0000dbf0: 2868 6561 645f 6970 5f6c 6973 7429 203e  (head_ip_list) >
-0000dc00: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
-0000dc10: 2020 2020 2320 5468 6973 2063 6f75 6c64      # This could
-0000dc20: 2062 6520 7472 6967 6765 7265 6420 6966   be triggered if
-0000dc30: 2065 2e67 2e2c 2073 6f6d 6520 6c6f 6767   e.g., some logg
-0000dc40: 696e 6720 6973 2061 6464 6564 2069 6e0a  ing is added in.
-0000dc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dc60: 2320 736b 7970 696c 6f74 5f63 6f6e 6669  # skypilot_confi
-0000dc70: 672c 2061 206d 6f64 756c 6520 7468 6174  g, a module that
-0000dc80: 2068 6173 2073 6f6d 6520 636f 6465 2065   has some code e
-0000dc90: 7865 6375 7465 640a 2020 2020 2020 2020  xecuted.        
-0000dca0: 2020 2020 2020 2020 2320 7768 656e 6576          # whenev
-0000dcb0: 6572 2060 736b 7960 2069 7320 696d 706f  er `sky` is impo
-0000dcc0: 7274 6564 2e0a 2020 2020 2020 2020 2020  rted..          
-0000dcd0: 2020 2020 2020 6c6f 6767 6572 2e77 6172        logger.war
-0000dce0: 6e69 6e67 280a 2020 2020 2020 2020 2020  ning(.          
-0000dcf0: 2020 2020 2020 2020 2020 2744 6574 6563            'Detec
-0000dd00: 7465 6420 6d6f 7265 2074 6861 6e20 3120  ted more than 1 
-0000dd10: 4950 2066 726f 6d20 7468 6520 6f75 7470  IP from the outp
-0000dd20: 7574 206f 6620 270a 2020 2020 2020 2020  ut of '.        
-0000dd30: 2020 2020 2020 2020 2020 2020 2774 6865              'the
-0000dd40: 2060 7261 7920 6765 742d 6865 6164 2d69   `ray get-head-i
-0000dd50: 7060 2063 6f6d 6d61 6e64 2e20 5468 6973  p` command. This
-0000dd60: 2063 6f75 6c64 2027 0a20 2020 2020 2020   could '.       
-0000dd70: 2020 2020 2020 2020 2020 2020 2027 6861               'ha
-0000dd80: 7070 656e 2069 6620 7468 6572 6520 6973  ppen if there is
-0000dd90: 2065 7874 7261 206f 7574 7075 7420 6672   extra output fr
-0000dda0: 6f6d 2069 742c 2027 0a20 2020 2020 2020  om it, '.       
-0000ddb0: 2020 2020 2020 2020 2020 2020 2027 7768               'wh
-0000ddc0: 6963 6820 7368 6f75 6c64 2062 6520 696e  ich should be in
-0000ddd0: 7370 6563 7465 6420 6265 6c6f 772e 5c6e  spected below.\n
-0000dde0: 5072 6f63 6565 6469 6e67 2077 6974 6820  Proceeding with 
-0000ddf0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0000de00: 2020 2020 2020 6627 7468 6520 6c61 7374        f'the last
-0000de10: 2064 6574 6563 7465 6420 4950 2028 7b68   detected IP ({h
-0000de20: 6561 645f 6970 5f6c 6973 745b 2d31 5d7d  ead_ip_list[-1]}
-0000de30: 2920 6173 2068 6561 6420 4950 2e27 0a20  ) as head IP.'. 
+0000d7b0: 2020 2020 2745 6e73 7572 6520 7468 6174      'Ensure that
+0000d7c0: 2074 6865 206e 6574 776f 726b 2069 7320   the network is 
+0000d7d0: 7374 6162 6c65 2c20 7468 656e 2072 6574  stable, then ret
+0000d7e0: 7279 2e20 270a 2020 2020 2020 2020 2020  ry. '.          
+0000d7f0: 2020 2020 2020 2020 2020 2020 2066 277b               f'{
+0000d800: 636d 647d 2729 0a20 2020 2020 2020 2020  cmd}').         
+0000d810: 2020 2069 6620 6c6f 675f 7061 7468 2021     if log_path !
+0000d820: 3d20 6f73 2e64 6576 6e75 6c6c 3a0a 2020  = os.devnull:.  
+0000d830: 2020 2020 2020 2020 2020 2020 2020 6572                er
+0000d840: 725f 6d73 6720 2b3d 2066 2720 5365 6520  r_msg += f' See 
+0000d850: 6c6f 6773 2069 6e20 7b6c 6f67 5f70 6174  logs in {log_pat
+0000d860: 687d 270a 2020 2020 2020 2020 2020 2020  h}'.            
+0000d870: 7375 6270 726f 6365 7373 5f75 7469 6c73  subprocess_utils
+0000d880: 2e68 616e 646c 655f 7265 7475 726e 636f  .handle_returnco
+0000d890: 6465 2872 632c 0a20 2020 2020 2020 2020  de(rc,.         
+0000d8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d8c0: 2020 2020 2020 636d 642c 0a20 2020 2020        cmd,.     
+0000d8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d8f0: 2020 2020 2020 2020 2020 6572 725f 6d73            err_ms
+0000d900: 672c 0a20 2020 2020 2020 2020 2020 2020  g,.             
+0000d910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d930: 2020 7374 6465 7272 3d73 7464 6f75 7420    stderr=stdout 
+0000d940: 2b20 7374 6465 7272 290a 0a20 2020 2020  + stderr)..     
+0000d950: 2020 2069 6620 7275 6e5f 7273 796e 633a     if run_rsync:
+0000d960: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0000d970: 6572 7420 736f 7572 6365 2069 7320 6e6f  ert source is no
+0000d980: 7420 4e6f 6e65 0a20 2020 2020 2020 2020  t None.         
+0000d990: 2020 2023 2054 4f44 4f28 7a68 7775 293a     # TODO(zhwu):
+0000d9a0: 204f 7074 696d 697a 6520 666f 7220 6c61   Optimize for la
+0000d9b0: 7267 6520 616d 6f75 6e74 206f 6620 6669  rge amount of fi
+0000d9c0: 6c65 732e 0a20 2020 2020 2020 2020 2020  les..           
+0000d9d0: 2023 207a 6970 202f 2074 7261 6e73 6665   # zip / transfe
+0000d9e0: 7220 2f20 756e 7a69 700a 2020 2020 2020  r / unzip.      
+0000d9f0: 2020 2020 2020 7275 6e6e 6572 2e72 7379        runner.rsy
+0000da00: 6e63 280a 2020 2020 2020 2020 2020 2020  nc(.            
+0000da10: 2020 2020 736f 7572 6365 3d73 6f75 7263      source=sourc
+0000da20: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+0000da30: 2020 2074 6172 6765 743d 7461 7267 6574     target=target
+0000da40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000da50: 2020 7570 3d54 7275 652c 0a20 2020 2020    up=True,.     
+0000da60: 2020 2020 2020 2020 2020 206c 6f67 5f70             log_p
+0000da70: 6174 683d 6c6f 675f 7061 7468 2c0a 2020  ath=log_path,.  
+0000da80: 2020 2020 2020 2020 2020 2020 2020 7374                st
+0000da90: 7265 616d 5f6c 6f67 733d 7374 7265 616d  ream_logs=stream
+0000daa0: 5f6c 6f67 732c 0a20 2020 2020 2020 2020  _logs,.         
+0000dab0: 2020 2029 0a0a 2020 2020 6e75 6d5f 6e6f     )..    num_no
+0000dac0: 6465 7320 3d20 6c65 6e28 7275 6e6e 6572  des = len(runner
+0000dad0: 7329 0a20 2020 2070 6c75 7261 6c20 3d20  s).    plural = 
+0000dae0: 2773 2720 6966 206e 756d 5f6e 6f64 6573  's' if num_nodes
+0000daf0: 203e 2031 2065 6c73 6520 2727 0a20 2020   > 1 else ''.   
+0000db00: 206d 6573 7361 6765 203d 2028 6627 7b66   message = (f'{f
+0000db10: 6f72 652e 4359 414e 7d7b 6163 7469 6f6e  ore.CYAN}{action
+0000db20: 5f6d 6573 7361 6765 7d20 2874 6f20 7b6e  _message} (to {n
+0000db30: 756d 5f6e 6f64 6573 7d20 6e6f 6465 7b70  um_nodes} node{p
+0000db40: 6c75 7261 6c7d 2927 0a20 2020 2020 2020  lural})'.       
+0000db50: 2020 2020 2020 2020 6627 3a20 7b73 7479          f': {sty
+0000db60: 6c65 2e42 5249 4748 547d 7b6f 7269 6769  le.BRIGHT}{origi
+0000db70: 6e5f 736f 7572 6365 7d7b 7374 796c 652e  n_source}{style.
+0000db80: 5245 5345 545f 414c 4c7d 202d 3e20 270a  RESET_ALL} -> '.
+0000db90: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000dba0: 277b 7374 796c 652e 4252 4947 4854 7d7b  '{style.BRIGHT}{
+0000dbb0: 7461 7267 6574 7d7b 7374 796c 652e 5245  target}{style.RE
+0000dbc0: 5345 545f 414c 4c7d 2729 0a20 2020 206c  SET_ALL}').    l
+0000dbd0: 6f67 6765 722e 696e 666f 286d 6573 7361  ogger.info(messa
+0000dbe0: 6765 290a 2020 2020 7769 7468 2072 6963  ge).    with ric
+0000dbf0: 685f 7574 696c 732e 7361 6665 5f73 7461  h_utils.safe_sta
+0000dc00: 7475 7328 6627 5b62 6f6c 6420 6379 616e  tus(f'[bold cyan
+0000dc10: 5d7b 6163 7469 6f6e 5f6d 6573 7361 6765  ]{action_message
+0000dc20: 7d5b 2f5d 2729 3a0a 2020 2020 2020 2020  }[/]'):.        
+0000dc30: 7375 6270 726f 6365 7373 5f75 7469 6c73  subprocess_utils
+0000dc40: 2e72 756e 5f69 6e5f 7061 7261 6c6c 656c  .run_in_parallel
+0000dc50: 285f 7379 6e63 5f6e 6f64 652c 2072 756e  (_sync_node, run
+0000dc60: 6e65 7273 290a 0a0a 6465 6620 6368 6563  ners)...def chec
+0000dc70: 6b5f 6c6f 6361 6c5f 6770 7573 2829 202d  k_local_gpus() -
+0000dc80: 3e20 626f 6f6c 3a0a 2020 2020 2222 2243  > bool:.    """C
+0000dc90: 6865 636b 7320 6966 2047 5055 7320 6172  hecks if GPUs ar
+0000dca0: 6520 6176 6169 6c61 626c 6520 6c6f 6361  e available loca
+0000dcb0: 6c6c 792e 0a0a 2020 2020 5265 7475 726e  lly...    Return
+0000dcc0: 7320 7768 6574 6865 7220 4750 5573 2061  s whether GPUs a
+0000dcd0: 7265 2061 7661 696c 6162 6c65 206f 6e20  re available on 
+0000dce0: 7468 6520 6c6f 6361 6c20 6d61 6368 696e  the local machin
+0000dcf0: 6520 6279 2063 6865 636b 696e 670a 2020  e by checking.  
+0000dd00: 2020 6966 206e 7669 6469 612d 736d 6920    if nvidia-smi 
+0000dd10: 6973 2069 6e73 7461 6c6c 6564 2061 6e64  is installed and
+0000dd20: 2072 6574 7572 6e73 207a 6572 6f20 7265   returns zero re
+0000dd30: 7475 726e 2063 6f64 652e 0a0a 2020 2020  turn code...    
+0000dd40: 5265 7475 726e 7320 5472 7565 2069 6620  Returns True if 
+0000dd50: 6e76 6964 6961 2d73 6d69 2069 7320 696e  nvidia-smi is in
+0000dd60: 7374 616c 6c65 6420 616e 6420 7265 7475  stalled and retu
+0000dd70: 726e 7320 7a65 726f 2072 6574 7572 6e20  rns zero return 
+0000dd80: 636f 6465 2c0a 2020 2020 4661 6c73 6520  code,.    False 
+0000dd90: 6966 206e 6f74 2e0a 2020 2020 2222 220a  if not..    """.
+0000dda0: 2020 2020 6973 5f66 756e 6374 696f 6e61      is_functiona
+0000ddb0: 6c20 3d20 4661 6c73 650a 2020 2020 696e  l = False.    in
+0000ddc0: 7374 616c 6c61 7469 6f6e 5f63 6865 636b  stallation_check
+0000ddd0: 203d 2073 7562 7072 6f63 6573 732e 7275   = subprocess.ru
+0000dde0: 6e28 5b27 7768 6963 6827 2c20 276e 7669  n(['which', 'nvi
+0000ddf0: 6469 612d 736d 6927 5d2c 0a20 2020 2020  dia-smi'],.     
+0000de00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000de10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000de20: 2020 2073 7464 6f75 743d 7375 6270 726f     stdout=subpro
+0000de30: 6365 7373 2e44 4556 4e55 4c4c 2c0a 2020  cess.DEVNULL,.  
 0000de40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000de50: 2020 2066 275c 6e3d 3d20 4f75 7470 7574     f'\n== Output
-0000de60: 203d 3d5c 6e7b 6f75 747d 270a 2020 2020   ==\n{out}'.    
-0000de70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000de80: 6627 5c6e 3d3d 204f 7574 7075 7420 656e  f'\n== Output en
-0000de90: 6473 203d 3d27 290a 2020 2020 2020 2020  ds ==').        
-0000dea0: 2020 2020 2020 2020 6865 6164 5f69 705f          head_ip_
-0000deb0: 6c69 7374 203d 2068 6561 645f 6970 5f6c  list = head_ip_l
-0000dec0: 6973 745b 2d31 3a5d 0a20 2020 2020 2020  ist[-1:].       
-0000ded0: 2020 2020 2061 7373 6572 7420 3120 3d3d       assert 1 ==
-0000dee0: 206c 656e 2868 6561 645f 6970 5f6c 6973   len(head_ip_lis
-0000def0: 7429 2c20 286f 7574 2c20 6865 6164 5f69  t), (out, head_i
-0000df00: 705f 6c69 7374 290a 2020 2020 2020 2020  p_list).        
-0000df10: 2020 2020 6865 6164 5f69 7020 3d20 6865      head_ip = he
-0000df20: 6164 5f69 705f 6c69 7374 5b30 5d0a 2020  ad_ip_list[0].  
-0000df30: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
-0000df40: 2020 2020 2020 2020 6578 6365 7074 2073          except s
-0000df50: 7562 7072 6f63 6573 732e 4361 6c6c 6564  ubprocess.Called
-0000df60: 5072 6f63 6573 7345 7272 6f72 2061 7320  ProcessError as 
-0000df70: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
-0000df80: 6620 6920 3d3d 206d 6178 5f61 7474 656d  f i == max_attem
-0000df90: 7074 7320 2d20 313a 0a20 2020 2020 2020  pts - 1:.       
-0000dfa0: 2020 2020 2020 2020 2072 6169 7365 2065           raise e
-0000dfb0: 7863 6570 7469 6f6e 732e 4665 7463 6849  xceptions.FetchI
-0000dfc0: 5045 7272 6f72 280a 2020 2020 2020 2020  PError(.        
-0000dfd0: 2020 2020 2020 2020 2020 2020 7265 6173              reas
-0000dfe0: 6f6e 3d65 7863 6570 7469 6f6e 732e 4665  on=exceptions.Fe
-0000dff0: 7463 6849 5045 7272 6f72 2e52 6561 736f  tchIPError.Reaso
-0000e000: 6e2e 4845 4144 2920 6672 6f6d 2065 0a20  n.HEAD) from e. 
-0000e010: 2020 2020 2020 2020 2020 2023 2052 6574             # Ret
-0000e020: 7279 2069 6620 7468 6520 636c 7573 7465  ry if the cluste
-0000e030: 7220 6973 206e 6f74 2075 7020 7965 742e  r is not up yet.
-0000e040: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
-0000e050: 6765 722e 6465 6275 6728 2752 6574 7279  ger.debug('Retry
-0000e060: 696e 6720 746f 2067 6574 2068 6561 6420  ing to get head 
-0000e070: 6970 2e27 290a 2020 2020 2020 2020 2020  ip.').          
-0000e080: 2020 7469 6d65 2e73 6c65 6570 2862 6163    time.sleep(bac
-0000e090: 6b6f 6666 2e63 7572 7265 6e74 5f62 6163  koff.current_bac
-0000e0a0: 6b6f 6666 2829 290a 2020 2020 7265 7475  koff()).    retu
-0000e0b0: 726e 2068 6561 645f 6970 0a0a 0a40 7469  rn head_ip...@ti
-0000e0c0: 6d65 6c69 6e65 2e65 7665 6e74 0a64 6566  meline.event.def
-0000e0d0: 2067 6574 5f6e 6f64 655f 6970 7328 636c   get_node_ips(cl
-0000e0e0: 7573 7465 725f 7961 6d6c 3a20 7374 722c  uster_yaml: str,
-0000e0f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e100: 2020 6578 7065 6374 6564 5f6e 756d 5f6e    expected_num_n
-0000e110: 6f64 6573 3a20 696e 742c 0a20 2020 2020  odes: int,.     
-0000e120: 2020 2020 2020 2020 2020 2020 6865 6164              head
-0000e130: 5f69 705f 6d61 785f 6174 7465 6d70 7473  _ip_max_attempts
-0000e140: 3a20 696e 7420 3d20 312c 0a20 2020 2020  : int = 1,.     
-0000e150: 2020 2020 2020 2020 2020 2020 776f 726b              work
-0000e160: 6572 5f69 705f 6d61 785f 6174 7465 6d70  er_ip_max_attemp
-0000e170: 7473 3a20 696e 7420 3d20 312c 0a20 2020  ts: int = 1,.   
-0000e180: 2020 2020 2020 2020 2020 2020 2020 6765                ge
-0000e190: 745f 696e 7465 726e 616c 5f69 7073 3a20  t_internal_ips: 
-0000e1a0: 626f 6f6c 203d 2046 616c 7365 2920 2d3e  bool = False) ->
-0000e1b0: 204c 6973 745b 7374 725d 3a0a 2020 2020   List[str]:.    
-0000e1c0: 2222 2252 6574 7572 6e73 2074 6865 2049  """Returns the I
-0000e1d0: 5073 206f 6620 616c 6c20 6e6f 6465 7320  Ps of all nodes 
-0000e1e0: 696e 2074 6865 2063 6c75 7374 6572 2c20  in the cluster, 
-0000e1f0: 7769 7468 2068 6561 6420 6e6f 6465 2061  with head node a
-0000e200: 7420 6672 6f6e 742e 0a0a 2020 2020 4172  t front...    Ar
-0000e210: 6773 3a0a 2020 2020 2020 2020 636c 7573  gs:.        clus
-0000e220: 7465 725f 7961 6d6c 3a20 5061 7468 2074  ter_yaml: Path t
-0000e230: 6f20 7468 6520 636c 7573 7465 7220 7961  o the cluster ya
-0000e240: 6d6c 2e0a 2020 2020 2020 2020 6578 7065  ml..        expe
-0000e250: 6374 6564 5f6e 756d 5f6e 6f64 6573 3a20  cted_num_nodes: 
-0000e260: 4578 7065 6374 6564 206e 756d 6265 7220  Expected number 
-0000e270: 6f66 206e 6f64 6573 2069 6e20 7468 6520  of nodes in the 
-0000e280: 636c 7573 7465 722e 0a20 2020 2020 2020  cluster..       
-0000e290: 2068 6561 645f 6970 5f6d 6178 5f61 7474   head_ip_max_att
-0000e2a0: 656d 7074 733a 204d 6178 2061 7474 656d  empts: Max attem
-0000e2b0: 7074 7320 746f 2067 6574 2068 6561 6420  pts to get head 
-0000e2c0: 6970 2e0a 2020 2020 2020 2020 776f 726b  ip..        work
-0000e2d0: 6572 5f69 705f 6d61 785f 6174 7465 6d70  er_ip_max_attemp
-0000e2e0: 7473 3a20 4d61 7820 6174 7465 6d70 7473  ts: Max attempts
-0000e2f0: 2074 6f20 6765 7420 776f 726b 6572 2069   to get worker i
-0000e300: 7073 2e0a 2020 2020 2020 2020 6765 745f  ps..        get_
-0000e310: 696e 7465 726e 616c 5f69 7073 3a20 5768  internal_ips: Wh
-0000e320: 6574 6865 7220 746f 2067 6574 2069 6e74  ether to get int
-0000e330: 6572 6e61 6c20 4950 732e 2057 6865 6e20  ernal IPs. When 
-0000e340: 4661 6c73 652c 2069 7420 6973 2073 7469  False, it is sti
-0000e350: 6c6c 0a20 2020 2020 2020 2020 2020 2070  ll.            p
-0000e360: 6f73 7369 626c 6520 746f 2067 6574 2069  ossible to get i
-0000e370: 6e74 6572 6e61 6c20 4950 7320 6966 2074  nternal IPs if t
-0000e380: 6865 2063 6c75 7374 6572 2064 6f65 7320  he cluster does 
-0000e390: 6e6f 7420 6861 7665 2065 7874 6572 6e61  not have externa
-0000e3a0: 6c0a 2020 2020 2020 2020 2020 2020 4950  l.            IP
-0000e3b0: 732e 0a0a 2020 2020 5261 6973 6573 3a0a  s...    Raises:.
-0000e3c0: 2020 2020 2020 2020 6578 6365 7074 696f          exceptio
-0000e3d0: 6e73 2e46 6574 6368 4950 4572 726f 723a  ns.FetchIPError:
-0000e3e0: 2069 6620 7765 2066 6169 6c65 6420 746f   if we failed to
-0000e3f0: 2067 6574 2074 6865 2049 5073 2e20 652e   get the IPs. e.
-0000e400: 7265 6173 6f6e 2069 730a 2020 2020 2020  reason is.      
-0000e410: 2020 2020 2020 4845 4144 206f 7220 574f        HEAD or WO
-0000e420: 524b 4552 2e0a 2020 2020 2222 220a 2020  RKER..    """.  
-0000e430: 2020 7261 795f 636f 6e66 6967 203d 2063    ray_config = c
-0000e440: 6f6d 6d6f 6e5f 7574 696c 732e 7265 6164  ommon_utils.read
-0000e450: 5f79 616d 6c28 636c 7573 7465 725f 7961  _yaml(cluster_ya
-0000e460: 6d6c 290a 2020 2020 2320 5573 6520 7468  ml).    # Use th
-0000e470: 6520 6e65 7720 7072 6f76 6973 696f 6e65  e new provisione
-0000e480: 7220 666f 7220 4157 532e 0a20 2020 2070  r for AWS..    p
-0000e490: 726f 7669 6465 725f 6e61 6d65 203d 2063  rovider_name = c
-0000e4a0: 6c75 7374 6572 5f79 616d 6c5f 7574 696c  luster_yaml_util
-0000e4b0: 732e 6765 745f 7072 6f76 6964 6572 5f6e  s.get_provider_n
-0000e4c0: 616d 6528 7261 795f 636f 6e66 6967 290a  ame(ray_config).
-0000e4d0: 2020 2020 636c 6f75 6420 3d20 636c 6f75      cloud = clou
-0000e4e0: 645f 7265 6769 7374 7279 2e43 4c4f 5544  d_registry.CLOUD
-0000e4f0: 5f52 4547 4953 5452 592e 6672 6f6d 5f73  _REGISTRY.from_s
-0000e500: 7472 2870 726f 7669 6465 725f 6e61 6d65  tr(provider_name
-0000e510: 290a 2020 2020 6173 7365 7274 2063 6c6f  ).    assert clo
-0000e520: 7564 2069 7320 6e6f 7420 4e6f 6e65 2c20  ud is not None, 
-0000e530: 7072 6f76 6964 6572 5f6e 616d 650a 0a20  provider_name.. 
-0000e540: 2020 2069 6620 636c 6f75 642e 5052 4f56     if cloud.PROV
-0000e550: 4953 494f 4e45 525f 5645 5253 494f 4e20  ISIONER_VERSION 
-0000e560: 3e3d 2063 6c6f 7564 732e 5072 6f76 6973  >= clouds.Provis
-0000e570: 696f 6e65 7256 6572 7369 6f6e 2e53 4b59  ionerVersion.SKY
-0000e580: 5049 4c4f 543a 0a20 2020 2020 2020 2074  PILOT:.        t
-0000e590: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0000e5a0: 6d65 7461 6461 7461 203d 2070 726f 7669  metadata = provi
-0000e5b0: 7369 6f6e 5f6c 6962 2e67 6574 5f63 6c75  sion_lib.get_clu
-0000e5c0: 7374 6572 5f69 6e66 6f28 0a20 2020 2020  ster_info(.     
-0000e5d0: 2020 2020 2020 2020 2020 2070 726f 7669             provi
-0000e5e0: 6465 725f 6e61 6d65 2c20 7261 795f 636f  der_name, ray_co
-0000e5f0: 6e66 6967 5b27 7072 6f76 6964 6572 275d  nfig['provider']
-0000e600: 2e67 6574 2827 7265 6769 6f6e 2729 2c0a  .get('region'),.
-0000e610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e620: 7261 795f 636f 6e66 6967 5b27 636c 7573  ray_config['clus
-0000e630: 7465 725f 6e61 6d65 275d 2c20 7261 795f  ter_name'], ray_
-0000e640: 636f 6e66 6967 5b27 7072 6f76 6964 6572  config['provider
-0000e650: 275d 290a 2020 2020 2020 2020 6578 6365  ']).        exce
-0000e660: 7074 2045 7863 6570 7469 6f6e 2061 7320  pt Exception as 
-0000e670: 653a 2020 2320 7079 6c69 6e74 3a20 6469  e:  # pylint: di
-0000e680: 7361 626c 653d 6272 6f61 642d 6578 6365  sable=broad-exce
-0000e690: 7074 0a20 2020 2020 2020 2020 2020 2023  pt.            #
-0000e6a0: 2054 6869 7320 636f 756c 6420 6861 7070   This could happ
-0000e6b0: 656e 2077 6865 6e20 7468 6520 564d 2069  en when the VM i
-0000e6c0: 7320 6e6f 7420 6675 6c6c 7920 6c61 756e  s not fully laun
-0000e6d0: 6368 6564 2c20 616e 6420 6120 7573 6572  ched, and a user
-0000e6e0: 0a20 2020 2020 2020 2020 2020 2023 2069  .            # i
-0000e6f0: 7320 7472 7969 6e67 2074 6f20 7465 726d  s trying to term
-0000e700: 696e 6174 6520 6974 2077 6974 6820 6073  inate it with `s
-0000e710: 6b79 2064 6f77 6e60 2e0a 2020 2020 2020  ky down`..      
-0000e720: 2020 2020 2020 6c6f 6767 6572 2e64 6562        logger.deb
-0000e730: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
-0000e740: 2020 2020 2746 6169 6c65 6420 746f 2067      'Failed to g
-0000e750: 6574 2063 6c75 7374 6572 2069 6e66 6f20  et cluster info 
-0000e760: 666f 7220 270a 2020 2020 2020 2020 2020  for '.          
-0000e770: 2020 2020 2020 6627 7b72 6179 5f63 6f6e        f'{ray_con
-0000e780: 6669 675b 2263 6c75 7374 6572 5f6e 616d  fig["cluster_nam
-0000e790: 6522 5d7d 2066 726f 6d20 7468 6520 6e65  e"]} from the ne
-0000e7a0: 7720 7072 6f76 6973 696f 6e65 7220 270a  w provisioner '.
-0000e7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e7c0: 6627 7769 7468 207b 636f 6d6d 6f6e 5f75  f'with {common_u
-0000e7d0: 7469 6c73 2e66 6f72 6d61 745f 6578 6365  tils.format_exce
-0000e7e0: 7074 696f 6e28 6529 7d2e 2729 0a20 2020  ption(e)}.').   
-0000e7f0: 2020 2020 2020 2020 2072 6169 7365 2065           raise e
-0000e800: 7863 6570 7469 6f6e 732e 4665 7463 6849  xceptions.FetchI
-0000e810: 5045 7272 6f72 280a 2020 2020 2020 2020  PError(.        
-0000e820: 2020 2020 2020 2020 6578 6365 7074 696f          exceptio
-0000e830: 6e73 2e46 6574 6368 4950 4572 726f 722e  ns.FetchIPError.
-0000e840: 5265 6173 6f6e 2e48 4541 4429 2066 726f  Reason.HEAD) fro
-0000e850: 6d20 650a 2020 2020 2020 2020 6966 206c  m e.        if l
-0000e860: 656e 286d 6574 6164 6174 612e 696e 7374  en(metadata.inst
-0000e870: 616e 6365 7329 203c 2065 7870 6563 7465  ances) < expecte
-0000e880: 645f 6e75 6d5f 6e6f 6465 733a 0a20 2020  d_num_nodes:.   
-0000e890: 2020 2020 2020 2020 2023 2053 696d 756c           # Simul
-0000e8a0: 6174 6520 7468 6520 6578 6365 7074 696f  ate the exceptio
-0000e8b0: 6e20 7768 656e 2052 6179 2068 6561 6420  n when Ray head 
-0000e8c0: 6e6f 6465 2069 7320 6e6f 7420 7570 2e0a  node is not up..
-0000e8d0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0000e8e0: 6520 6578 6365 7074 696f 6e73 2e46 6574  e exceptions.Fet
-0000e8f0: 6368 4950 4572 726f 7228 6578 6365 7074  chIPError(except
-0000e900: 696f 6e73 2e46 6574 6368 4950 4572 726f  ions.FetchIPErro
-0000e910: 722e 5265 6173 6f6e 2e48 4541 4429 0a20  r.Reason.HEAD). 
-0000e920: 2020 2020 2020 2072 6574 7572 6e20 6d65         return me
-0000e930: 7461 6461 7461 2e67 6574 5f66 6561 7369  tadata.get_feasi
-0000e940: 626c 655f 6970 7328 6765 745f 696e 7465  ble_ips(get_inte
-0000e950: 726e 616c 5f69 7073 290a 0a20 2020 2069  rnal_ips)..    i
-0000e960: 6620 6765 745f 696e 7465 726e 616c 5f69  f get_internal_i
-0000e970: 7073 3a0a 2020 2020 2020 2020 7769 7468  ps:.        with
-0000e980: 2074 656d 7066 696c 652e 4e61 6d65 6454   tempfile.NamedT
-0000e990: 656d 706f 7261 7279 4669 6c65 286d 6f64  emporaryFile(mod
-0000e9a0: 653d 2777 272c 2064 656c 6574 653d 4661  e='w', delete=Fa
-0000e9b0: 6c73 6529 2061 7320 663a 0a20 2020 2020  lse) as f:.     
-0000e9c0: 2020 2020 2020 2072 6179 5f63 6f6e 6669         ray_confi
-0000e9d0: 675b 2770 726f 7669 6465 7227 5d5b 2775  g['provider']['u
-0000e9e0: 7365 5f69 6e74 6572 6e61 6c5f 6970 7327  se_internal_ips'
-0000e9f0: 5d20 3d20 5472 7565 0a20 2020 2020 2020  ] = True.       
-0000ea00: 2020 2020 2079 616d 6c2e 6475 6d70 2872       yaml.dump(r
-0000ea10: 6179 5f63 6f6e 6669 672c 2066 290a 2020  ay_config, f).  
-0000ea20: 2020 2020 2020 2020 2020 636c 7573 7465            cluste
-0000ea30: 725f 7961 6d6c 203d 2066 2e6e 616d 650a  r_yaml = f.name.
-0000ea40: 0a20 2020 2023 2043 6865 636b 2074 6865  .    # Check the
-0000ea50: 206e 6574 776f 726b 2063 6f6e 6e65 6374   network connect
-0000ea60: 696f 6e20 6669 7273 7420 746f 2061 766f  ion first to avo
-0000ea70: 6964 206c 6f6e 6720 6861 6e67 696e 6720  id long hanging 
-0000ea80: 7469 6d65 2066 6f72 0a20 2020 2023 2072  time for.    # r
-0000ea90: 6179 2067 6574 2d68 6561 642d 6970 2062  ay get-head-ip b
-0000eaa0: 656c 6f77 2c20 6966 2061 206c 6f6e 672d  elow, if a long-
-0000eab0: 6c61 7374 696e 6720 6e65 7477 6f72 6b20  lasting network 
-0000eac0: 636f 6e6e 6563 7469 6f6e 2066 6169 6c75  connection failu
-0000ead0: 7265 0a20 2020 2023 2068 6170 7065 6e73  re.    # happens
-0000eae0: 2e0a 2020 2020 6368 6563 6b5f 6e65 7477  ..    check_netw
-0000eaf0: 6f72 6b5f 636f 6e6e 6563 7469 6f6e 2829  ork_connection()
-0000eb00: 0a20 2020 2068 6561 645f 6970 203d 205f  .    head_ip = _
-0000eb10: 7175 6572 795f 6865 6164 5f69 705f 7769  query_head_ip_wi
-0000eb20: 7468 5f72 6574 7269 6573 2863 6c75 7374  th_retries(clust
-0000eb30: 6572 5f79 616d 6c2c 0a20 2020 2020 2020  er_yaml,.       
-0000eb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eb60: 2020 206d 6178 5f61 7474 656d 7074 733d     max_attempts=
-0000eb70: 6865 6164 5f69 705f 6d61 785f 6174 7465  head_ip_max_atte
-0000eb80: 6d70 7473 290a 2020 2020 6865 6164 5f69  mpts).    head_i
-0000eb90: 705f 6c69 7374 203d 205b 6865 6164 5f69  p_list = [head_i
-0000eba0: 705d 0a20 2020 2069 6620 6578 7065 6374  p].    if expect
-0000ebb0: 6564 5f6e 756d 5f6e 6f64 6573 203e 2031  ed_num_nodes > 1
-0000ebc0: 3a0a 2020 2020 2020 2020 6261 636b 6f66  :.        backof
-0000ebd0: 6620 3d20 636f 6d6d 6f6e 5f75 7469 6c73  f = common_utils
-0000ebe0: 2e42 6163 6b6f 6666 2869 6e69 7469 616c  .Backoff(initial
-0000ebf0: 5f62 6163 6b6f 6666 3d35 2c20 6d61 785f  _backoff=5, max_
-0000ec00: 6261 636b 6f66 665f 6661 6374 6f72 3d35  backoff_factor=5
-0000ec10: 290a 0a20 2020 2020 2020 2066 6f72 2072  )..        for r
-0000ec20: 6574 7279 5f63 6e74 2069 6e20 7261 6e67  etry_cnt in rang
-0000ec30: 6528 776f 726b 6572 5f69 705f 6d61 785f  e(worker_ip_max_
-0000ec40: 6174 7465 6d70 7473 293a 0a20 2020 2020  attempts):.     
-0000ec50: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-0000ec60: 2020 2020 2020 2020 2020 2020 6675 6c6c              full
-0000ec70: 5f63 6c75 7374 6572 5f79 616d 6c20 3d20  _cluster_yaml = 
-0000ec80: 7374 7228 7061 7468 6c69 622e 5061 7468  str(pathlib.Path
-0000ec90: 2863 6c75 7374 6572 5f79 616d 6c29 2e65  (cluster_yaml).e
-0000eca0: 7870 616e 6475 7365 7228 2929 0a20 2020  xpanduser()).   
-0000ecb0: 2020 2020 2020 2020 2020 2020 2070 726f               pro
-0000ecc0: 6320 3d20 7375 6270 726f 6365 7373 5f75  c = subprocess_u
-0000ecd0: 7469 6c73 2e72 756e 280a 2020 2020 2020  tils.run(.      
-0000ece0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-0000ecf0: 7261 7920 6765 742d 776f 726b 6572 2d69  ray get-worker-i
-0000ed00: 7073 207b 6675 6c6c 5f63 6c75 7374 6572  ps {full_cluster
-0000ed10: 5f79 616d 6c21 727d 272c 0a20 2020 2020  _yaml!r}',.     
-0000ed20: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000ed30: 7464 6f75 743d 7375 6270 726f 6365 7373  tdout=subprocess
-0000ed40: 2e50 4950 452c 0a20 2020 2020 2020 2020  .PIPE,.         
-0000ed50: 2020 2020 2020 2020 2020 2073 7464 6572             stder
-0000ed60: 723d 7375 6270 726f 6365 7373 2e50 4950  r=subprocess.PIP
-0000ed70: 4529 0a20 2020 2020 2020 2020 2020 2020  E).             
-0000ed80: 2020 206f 7574 203d 2070 726f 632e 7374     out = proc.st
-0000ed90: 646f 7574 2e64 6563 6f64 6528 290a 2020  dout.decode().  
-0000eda0: 2020 2020 2020 2020 2020 2020 2020 6272                br
-0000edb0: 6561 6b0a 2020 2020 2020 2020 2020 2020  eak.            
-0000edc0: 6578 6365 7074 2073 7562 7072 6f63 6573  except subproces
-0000edd0: 732e 4361 6c6c 6564 5072 6f63 6573 7345  s.CalledProcessE
-0000ede0: 7272 6f72 2061 7320 653a 0a20 2020 2020  rror as e:.     
-0000edf0: 2020 2020 2020 2020 2020 2069 6620 7265             if re
-0000ee00: 7472 795f 636e 7420 3d3d 2077 6f72 6b65  try_cnt == worke
-0000ee10: 725f 6970 5f6d 6178 5f61 7474 656d 7074  r_ip_max_attempt
-0000ee20: 7320 2d20 313a 0a20 2020 2020 2020 2020  s - 1:.         
-0000ee30: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0000ee40: 2065 7863 6570 7469 6f6e 732e 4665 7463   exceptions.Fetc
-0000ee50: 6849 5045 7272 6f72 280a 2020 2020 2020  hIPError(.      
-0000ee60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ee70: 2020 6578 6365 7074 696f 6e73 2e46 6574    exceptions.Fet
-0000ee80: 6368 4950 4572 726f 722e 5265 6173 6f6e  chIPError.Reason
-0000ee90: 2e57 4f52 4b45 5229 2066 726f 6d20 650a  .WORKER) from e.
-0000eea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eeb0: 2320 5265 7472 7920 6966 2074 6865 2073  # Retry if the s
-0000eec0: 7368 2069 7320 6e6f 7420 7265 6164 7920  sh is not ready 
-0000eed0: 666f 7220 7468 6520 776f 726b 6572 7320  for the workers 
-0000eee0: 7965 742e 0a20 2020 2020 2020 2020 2020  yet..           
-0000eef0: 2020 2020 2062 6163 6b6f 6666 5f74 696d       backoff_tim
-0000ef00: 6520 3d20 6261 636b 6f66 662e 6375 7272  e = backoff.curr
-0000ef10: 656e 745f 6261 636b 6f66 6628 290a 2020  ent_backoff().  
-0000ef20: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-0000ef30: 6767 6572 2e64 6562 7567 2827 5265 7472  gger.debug('Retr
-0000ef40: 7969 6e67 2074 6f20 6765 7420 776f 726b  ying to get work
-0000ef50: 6572 2069 7020 270a 2020 2020 2020 2020  er ip '.        
-0000ef60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ef70: 2020 2020 2066 275b 7b72 6574 7279 5f63       f'[{retry_c
-0000ef80: 6e74 7d2f 7b77 6f72 6b65 725f 6970 5f6d  nt}/{worker_ip_m
-0000ef90: 6178 5f61 7474 656d 7074 737d 5d20 696e  ax_attempts}] in
-0000efa0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-0000efb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000efc0: 6627 7b62 6163 6b6f 6666 5f74 696d 657d  f'{backoff_time}
-0000efd0: 2073 6563 6f6e 6473 2e27 290a 2020 2020   seconds.').    
-0000efe0: 2020 2020 2020 2020 2020 2020 7469 6d65              time
-0000eff0: 2e73 6c65 6570 2862 6163 6b6f 6666 5f74  .sleep(backoff_t
-0000f000: 696d 6529 0a20 2020 2020 2020 2077 6f72  ime).        wor
-0000f010: 6b65 725f 6970 7320 3d20 7265 2e66 696e  ker_ips = re.fin
-0000f020: 6461 6c6c 2849 505f 4144 4452 5f52 4547  dall(IP_ADDR_REG
-0000f030: 4558 2c20 6f75 7429 0a20 2020 2020 2020  EX, out).       
-0000f040: 2069 6620 6c65 6e28 776f 726b 6572 5f69   if len(worker_i
-0000f050: 7073 2920 213d 2065 7870 6563 7465 645f  ps) != expected_
-0000f060: 6e75 6d5f 6e6f 6465 7320 2d20 313a 0a20  num_nodes - 1:. 
-0000f070: 2020 2020 2020 2020 2020 206e 203d 2065             n = e
-0000f080: 7870 6563 7465 645f 6e75 6d5f 6e6f 6465  xpected_num_node
-0000f090: 7320 2d20 310a 2020 2020 2020 2020 2020  s - 1.          
-0000f0a0: 2020 6966 206c 656e 2877 6f72 6b65 725f    if len(worker_
-0000f0b0: 6970 7329 203e 206e 3a0a 2020 2020 2020  ips) > n:.      
-0000f0c0: 2020 2020 2020 2020 2020 2320 5468 6973            # This
-0000f0d0: 2063 6f75 6c64 2062 6520 7472 6967 6765   could be trigge
-0000f0e0: 7265 6420 6966 2065 2e67 2e2c 2073 6f6d  red if e.g., som
-0000f0f0: 6520 6c6f 6767 696e 6720 6973 2061 6464  e logging is add
-0000f100: 6564 2069 6e0a 2020 2020 2020 2020 2020  ed in.          
-0000f110: 2020 2020 2020 2320 736b 7970 696c 6f74        # skypilot
-0000f120: 5f63 6f6e 6669 672c 2061 206d 6f64 756c  _config, a modul
-0000f130: 6520 7468 6174 2068 6173 2073 6f6d 6520  e that has some 
-0000f140: 636f 6465 2065 7865 6375 7465 6420 7768  code executed wh
-0000f150: 656e 6576 6572 0a20 2020 2020 2020 2020  enever.         
-0000f160: 2020 2020 2020 2023 2060 736b 7960 2069         # `sky` i
-0000f170: 7320 696d 706f 7274 6564 2e0a 2020 2020  s imported..    
-0000f180: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-0000f190: 6572 2e77 6172 6e69 6e67 280a 2020 2020  er.warning(.    
-0000f1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f1b0: 6627 4578 7065 6374 6564 207b 6e7d 2077  f'Expected {n} w
-0000f1c0: 6f72 6b65 7220 4950 2873 293b 2066 6f75  orker IP(s); fou
-0000f1d0: 6e64 2027 0a20 2020 2020 2020 2020 2020  nd '.           
-0000f1e0: 2020 2020 2020 2020 2066 277b 6c65 6e28           f'{len(
-0000f1f0: 776f 726b 6572 5f69 7073 297d 3a20 7b77  worker_ips)}: {w
-0000f200: 6f72 6b65 725f 6970 737d 270a 2020 2020  orker_ips}'.    
-0000f210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f220: 275c 6e54 6869 7320 636f 756c 6420 6861  '\nThis could ha
-0000f230: 7070 656e 2069 6620 7468 6572 6520 6973  ppen if there is
-0000f240: 2065 7874 7261 206f 7574 7075 7420 6672   extra output fr
-0000f250: 6f6d 2027 0a20 2020 2020 2020 2020 2020  om '.           
-0000f260: 2020 2020 2020 2020 2027 6072 6179 2067           '`ray g
-0000f270: 6574 2d77 6f72 6b65 722d 6970 7360 2c20  et-worker-ips`, 
-0000f280: 7768 6963 6820 7368 6f75 6c64 2062 6520  which should be 
-0000f290: 696e 7370 6563 7465 6420 6265 6c6f 772e  inspected below.
-0000f2a0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0000f2b0: 2020 2020 2020 6627 5c6e 3d3d 204f 7574        f'\n== Out
-0000f2c0: 7075 7420 3d3d 5c6e 7b6f 7574 7d27 0a20  put ==\n{out}'. 
-0000f2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f2e0: 2020 2066 275c 6e3d 3d20 4f75 7470 7574     f'\n== Output
-0000f2f0: 2065 6e64 7320 3d3d 2729 0a20 2020 2020   ends ==').     
-0000f300: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-0000f310: 722e 7761 726e 696e 6728 6627 5c6e 5072  r.warning(f'\nPr
-0000f320: 6f63 6565 6469 6e67 2077 6974 6820 7468  oceeding with th
-0000f330: 6520 6c61 7374 207b 6e7d 2027 0a20 2020  e last {n} '.   
-0000f340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f350: 2020 2020 2020 2020 2020 2020 6627 6465              f'de
-0000f360: 7465 6374 6564 2049 5028 7329 3a20 7b77  tected IP(s): {w
-0000f370: 6f72 6b65 725f 6970 735b 2d6e 3a5d 7d2e  orker_ips[-n:]}.
-0000f380: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
-0000f390: 2020 2077 6f72 6b65 725f 6970 7320 3d20     worker_ips = 
-0000f3a0: 776f 726b 6572 5f69 7073 5b2d 6e3a 5d0a  worker_ips[-n:].
-0000f3b0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0000f3c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000f3d0: 2020 7261 6973 6520 6578 6365 7074 696f    raise exceptio
-0000f3e0: 6e73 2e46 6574 6368 4950 4572 726f 7228  ns.FetchIPError(
-0000f3f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f400: 2020 2020 2065 7863 6570 7469 6f6e 732e       exceptions.
-0000f410: 4665 7463 6849 5045 7272 6f72 2e52 6561  FetchIPError.Rea
-0000f420: 736f 6e2e 574f 524b 4552 290a 2020 2020  son.WORKER).    
-0000f430: 656c 7365 3a0a 2020 2020 2020 2020 776f  else:.        wo
-0000f440: 726b 6572 5f69 7073 203d 205b 5d0a 2020  rker_ips = [].  
-0000f450: 2020 7265 7475 726e 2068 6561 645f 6970    return head_ip
-0000f460: 5f6c 6973 7420 2b20 776f 726b 6572 5f69  _list + worker_i
-0000f470: 7073 0a0a 0a64 6566 2063 6865 636b 5f6e  ps...def check_n
-0000f480: 6574 776f 726b 5f63 6f6e 6e65 6374 696f  etwork_connectio
-0000f490: 6e28 293a 0a20 2020 2023 2054 6f6c 6572  n():.    # Toler
-0000f4a0: 6174 6520 3320 7265 7472 6965 7320 6173  ate 3 retries as
-0000f4b0: 2069 7420 6973 206f 6273 6572 7665 6420   it is observed 
-0000f4c0: 7468 6174 2063 6f6e 6e65 6374 696f 6e73  that connections
-0000f4d0: 2063 616e 2066 6169 6c2e 0a20 2020 2061   can fail..    a
-0000f4e0: 6461 7074 6572 203d 2061 6461 7074 6572  dapter = adapter
-0000f4f0: 732e 4854 5450 4164 6170 7465 7228 6d61  s.HTTPAdapter(ma
-0000f500: 785f 7265 7472 6965 733d 7265 7472 795f  x_retries=retry_
-0000f510: 6c69 622e 5265 7472 7928 746f 7461 6c3d  lib.Retry(total=
-0000f520: 3329 290a 2020 2020 6874 7470 203d 2072  3)).    http = r
-0000f530: 6571 7565 7374 732e 5365 7373 696f 6e28  equests.Session(
-0000f540: 290a 2020 2020 6874 7470 2e6d 6f75 6e74  ).    http.mount
-0000f550: 2827 6874 7470 733a 2f2f 272c 2061 6461  ('https://', ada
-0000f560: 7074 6572 290a 2020 2020 6874 7470 2e6d  pter).    http.m
-0000f570: 6f75 6e74 2827 6874 7470 3a2f 2f27 2c20  ount('http://', 
-0000f580: 6164 6170 7465 7229 0a20 2020 2066 6f72  adapter).    for
-0000f590: 2069 2c20 6970 2069 6e20 656e 756d 6572   i, ip in enumer
-0000f5a0: 6174 6528 5f54 4553 545f 4950 5f4c 4953  ate(_TEST_IP_LIS
-0000f5b0: 5429 3a0a 2020 2020 2020 2020 7472 793a  T):.        try:
-0000f5c0: 0a20 2020 2020 2020 2020 2020 2068 7474  .            htt
-0000f5d0: 702e 6865 6164 2869 702c 2074 696d 656f  p.head(ip, timeo
-0000f5e0: 7574 3d33 290a 2020 2020 2020 2020 2020  ut=3).          
-0000f5f0: 2020 7265 7475 726e 0a20 2020 2020 2020    return.       
-0000f600: 2065 7863 6570 7420 2872 6571 7565 7374   except (request
-0000f610: 732e 5469 6d65 6f75 742c 2072 6571 7565  s.Timeout, reque
-0000f620: 7374 732e 6578 6365 7074 696f 6e73 2e43  sts.exceptions.C
-0000f630: 6f6e 6e65 6374 696f 6e45 7272 6f72 2920  onnectionError) 
-0000f640: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
-0000f650: 2020 6966 2069 203d 3d20 6c65 6e28 5f54    if i == len(_T
-0000f660: 4553 545f 4950 5f4c 4953 5429 202d 2031  EST_IP_LIST) - 1
-0000f670: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000f680: 2020 7261 6973 6520 6578 6365 7074 696f    raise exceptio
-0000f690: 6e73 2e4e 6574 776f 726b 4572 726f 7228  ns.NetworkError(
-0000f6a0: 2743 6f75 6c64 206e 6f74 2072 6566 7265  'Could not refre
-0000f6b0: 7368 2074 6865 2063 6c75 7374 6572 2e20  sh the cluster. 
-0000f6c0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0000f6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f6f0: 274e 6574 776f 726b 2073 6565 6d73 2064  'Network seems d
-0000f700: 6f77 6e2e 2729 2066 726f 6d20 650a 0a0a  own.') from e...
-0000f710: 6465 6620 6368 6563 6b5f 6f77 6e65 725f  def check_owner_
-0000f720: 6964 656e 7469 7479 2863 6c75 7374 6572  identity(cluster
-0000f730: 5f6e 616d 653a 2073 7472 2920 2d3e 204e  _name: str) -> N
-0000f740: 6f6e 653a 0a20 2020 2022 2222 4368 6563  one:.    """Chec
-0000f750: 6b20 6966 2063 7572 7265 6e74 2075 7365  k if current use
-0000f760: 7220 6973 2074 6865 2073 616d 6520 6173  r is the same as
-0000f770: 2074 6865 2075 7365 7220 7768 6f20 6372   the user who cr
-0000f780: 6561 7465 6420 7468 6520 636c 7573 7465  eated the cluste
-0000f790: 722e 0a0a 2020 2020 5261 6973 6573 3a0a  r...    Raises:.
-0000f7a0: 2020 2020 2020 2020 6578 6365 7074 696f          exceptio
-0000f7b0: 6e73 2e43 6c75 7374 6572 4f77 6e65 7249  ns.ClusterOwnerI
-0000f7c0: 6465 6e74 6974 794d 6973 6d61 7463 6845  dentityMismatchE
-0000f7d0: 7272 6f72 3a20 6966 2074 6865 2063 7572  rror: if the cur
-0000f7e0: 7265 6e74 2075 7365 7220 6973 0a20 2020  rent user is.   
-0000f7f0: 2020 2020 2020 206e 6f74 2074 6865 2073         not the s
-0000f800: 616d 6520 6173 2074 6865 2075 7365 7220  ame as the user 
-0000f810: 7768 6f20 6372 6561 7465 6420 7468 6520  who created the 
-0000f820: 636c 7573 7465 722e 0a20 2020 2020 2020  cluster..       
-0000f830: 2065 7863 6570 7469 6f6e 732e 436c 6f75   exceptions.Clou
-0000f840: 6455 7365 7249 6465 6e74 6974 7945 7272  dUserIdentityErr
-0000f850: 6f72 3a20 6966 2077 6520 6661 696c 2074  or: if we fail t
-0000f860: 6f20 6765 7420 7468 6520 6375 7272 656e  o get the curren
-0000f870: 7420 7573 6572 0a20 2020 2020 2020 2020  t user.         
-0000f880: 2069 6465 6e74 6974 792e 0a20 2020 2022   identity..    "
-0000f890: 2222 0a20 2020 2069 6620 656e 765f 6f70  "".    if env_op
-0000f8a0: 7469 6f6e 732e 4f70 7469 6f6e 732e 534b  tions.Options.SK
-0000f8b0: 4950 5f43 4c4f 5544 5f49 4445 4e54 4954  IP_CLOUD_IDENTIT
-0000f8c0: 595f 4348 4543 4b2e 6765 7428 293a 0a20  Y_CHECK.get():. 
-0000f8d0: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
-0000f8e0: 2020 7265 636f 7264 203d 2067 6c6f 6261    record = globa
-0000f8f0: 6c5f 7573 6572 5f73 7461 7465 2e67 6574  l_user_state.get
-0000f900: 5f63 6c75 7374 6572 5f66 726f 6d5f 6e61  _cluster_from_na
-0000f910: 6d65 2863 6c75 7374 6572 5f6e 616d 6529  me(cluster_name)
-0000f920: 0a20 2020 2069 6620 7265 636f 7264 2069  .    if record i
-0000f930: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-0000f940: 7265 7475 726e 0a20 2020 2068 616e 646c  return.    handl
-0000f950: 6520 3d20 7265 636f 7264 5b27 6861 6e64  e = record['hand
-0000f960: 6c65 275d 0a20 2020 2069 6620 6e6f 7420  le'].    if not 
-0000f970: 6973 696e 7374 616e 6365 2868 616e 646c  isinstance(handl
-0000f980: 652c 2062 6163 6b65 6e64 732e 436c 6f75  e, backends.Clou
-0000f990: 6456 6d52 6179 5265 736f 7572 6365 4861  dVmRayResourceHa
-0000f9a0: 6e64 6c65 293a 0a20 2020 2020 2020 2072  ndle):.        r
-0000f9b0: 6574 7572 6e0a 0a20 2020 2063 6c6f 7564  eturn..    cloud
-0000f9c0: 203d 2068 616e 646c 652e 6c61 756e 6368   = handle.launch
-0000f9d0: 6564 5f72 6573 6f75 7263 6573 2e63 6c6f  ed_resources.clo
-0000f9e0: 7564 0a20 2020 2063 7572 7265 6e74 5f75  ud.    current_u
-0000f9f0: 7365 725f 6964 656e 7469 7479 203d 2063  ser_identity = c
-0000fa00: 6c6f 7564 2e67 6574 5f63 7572 7265 6e74  loud.get_current
-0000fa10: 5f75 7365 725f 6964 656e 7469 7479 2829  _user_identity()
-0000fa20: 0a20 2020 206f 776e 6572 5f69 6465 6e74  .    owner_ident
-0000fa30: 6974 7920 3d20 7265 636f 7264 5b27 6f77  ity = record['ow
-0000fa40: 6e65 7227 5d0a 2020 2020 6966 2063 7572  ner'].    if cur
-0000fa50: 7265 6e74 5f75 7365 725f 6964 656e 7469  rent_user_identi
-0000fa60: 7479 2069 7320 4e6f 6e65 3a0a 2020 2020  ty is None:.    
-0000fa70: 2020 2020 2320 536b 6970 2074 6865 2063      # Skip the c
-0000fa80: 6865 636b 2069 6620 7468 6520 636c 6f75  heck if the clou
-0000fa90: 6420 646f 6573 206e 6f74 2073 7570 706f  d does not suppo
-0000faa0: 7274 2075 7365 7220 6964 656e 7469 7479  rt user identity
-0000fab0: 2e0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-0000fac0: 0a20 2020 2023 2054 6865 2075 7365 7220  .    # The user 
-0000fad0: 6964 656e 7469 7479 2063 616e 2062 6520  identity can be 
-0000fae0: 4e6f 6e65 2c20 6966 2074 6865 2063 6c75  None, if the clu
-0000faf0: 7374 6572 2069 7320 6372 6561 7465 6420  ster is created 
-0000fb00: 6279 2061 6e20 6f6c 6465 720a 2020 2020  by an older.    
-0000fb10: 2320 7665 7273 696f 6e20 6f66 2053 6b79  # version of Sky
-0000fb20: 5069 6c6f 742e 2049 6e20 7468 6174 2063  Pilot. In that c
-0000fb30: 6173 652c 2077 6520 7365 7420 7468 6520  ase, we set the 
-0000fb40: 7573 6572 2069 6465 6e74 6974 7920 746f  user identity to
-0000fb50: 2074 6865 0a20 2020 2023 2063 7572 7265   the.    # curre
-0000fb60: 6e74 206f 6e65 2e0a 2020 2020 2320 4e4f  nt one..    # NO
-0000fb70: 5445 3a20 6120 7573 6572 2077 686f 2075  TE: a user who u
-0000fb80: 7067 7261 6465 7320 536b 7950 696c 6f74  pgrades SkyPilot
-0000fb90: 2061 6e64 2073 7769 7463 6865 7320 746f   and switches to
-0000fba0: 2061 206e 6577 2063 6c6f 7564 2069 6465   a new cloud ide
-0000fbb0: 6e74 6974 790a 2020 2020 2320 696d 6d65  ntity.    # imme
-0000fbc0: 6469 6174 656c 7920 7769 7468 6f75 7420  diately without 
-0000fbd0: 6073 6b79 2073 7461 7475 7320 2d2d 7265  `sky status --re
-0000fbe0: 6672 6573 6860 2066 6972 7374 2c20 7769  fresh` first, wi
-0000fbf0: 6c6c 2063 6175 7365 2061 206c 6561 6b61  ll cause a leaka
-0000fc00: 6765 0a20 2020 2023 206f 6620 7468 6520  ge.    # of the 
-0000fc10: 6578 6973 7469 6e67 2063 6c75 7374 6572  existing cluster
-0000fc20: 2e20 5765 2064 6565 6d20 7468 6973 2061  . We deem this a
-0000fc30: 6e20 6163 6365 7074 6162 6c65 2074 7261  n acceptable tra
-0000fc40: 6465 6f66 6620 6d61 696e 6c79 0a20 2020  deoff mainly.   
-0000fc50: 2023 2062 6563 6175 7365 206d 756c 7469   # because multi
-0000fc60: 2d69 6465 6e74 6974 7920 6973 206e 6f74  -identity is not
-0000fc70: 2063 6f6d 6d6f 6e20 2861 7420 6c65 6173   common (at leas
-0000fc80: 7420 6174 2074 6865 206d 6f6d 656e 7429  t at the moment)
-0000fc90: 2e0a 2020 2020 6966 206f 776e 6572 5f69  ..    if owner_i
-0000fca0: 6465 6e74 6974 7920 6973 204e 6f6e 653a  dentity is None:
-0000fcb0: 0a20 2020 2020 2020 2067 6c6f 6261 6c5f  .        global_
-0000fcc0: 7573 6572 5f73 7461 7465 2e73 6574 5f6f  user_state.set_o
-0000fcd0: 776e 6572 5f69 6465 6e74 6974 795f 666f  wner_identity_fo
-0000fce0: 725f 636c 7573 7465 7228 0a20 2020 2020  r_cluster(.     
-0000fcf0: 2020 2020 2020 2063 6c75 7374 6572 5f6e         cluster_n
-0000fd00: 616d 652c 2063 7572 7265 6e74 5f75 7365  ame, current_use
-0000fd10: 725f 6964 656e 7469 7479 290a 2020 2020  r_identity).    
-0000fd20: 656c 7365 3a0a 2020 2020 2020 2020 6173  else:.        as
-0000fd30: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
-0000fd40: 6f77 6e65 725f 6964 656e 7469 7479 2c20  owner_identity, 
-0000fd50: 6c69 7374 290a 2020 2020 2020 2020 2320  list).        # 
-0000fd60: 4974 2069 7320 4f4b 2069 6620 7468 6520  It is OK if the 
-0000fd70: 6f77 6e65 7220 6964 656e 7469 7479 2069  owner identity i
-0000fd80: 7320 7368 6f72 7465 722c 2077 6869 6368  s shorter, which
-0000fd90: 2077 696c 6c20 6861 7070 656e 2077 6865   will happen whe
-0000fda0: 6e0a 2020 2020 2020 2020 2320 7468 6520  n.        # the 
-0000fdb0: 636c 7573 7465 7220 6973 206c 6175 6e63  cluster is launc
-0000fdc0: 6865 6420 6265 666f 7265 2023 3138 3038  hed before #1808
-0000fdd0: 2e20 496e 2074 6861 7420 6361 7365 2c20  . In that case, 
-0000fde0: 7765 206f 6e6c 7920 6368 6563 6b0a 2020  we only check.  
-0000fdf0: 2020 2020 2020 2320 7468 6520 7361 6d65        # the same
-0000fe00: 206c 656e 6774 6820 287a 6970 2077 696c   length (zip wil
-0000fe10: 6c20 7374 6f70 2061 7420 7468 6520 7368  l stop at the sh
-0000fe20: 6f72 7465 7220 6f6e 6529 2e0a 2020 2020  orter one)..    
-0000fe30: 2020 2020 666f 7220 692c 2028 6f77 6e65      for i, (owne
-0000fe40: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
-0000fe50: 2020 2063 7572 7265 6e74 2920 696e 2065     current) in e
-0000fe60: 6e75 6d65 7261 7465 287a 6970 286f 776e  numerate(zip(own
-0000fe70: 6572 5f69 6465 6e74 6974 792c 0a20 2020  er_identity,.   
-0000fe80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fe90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fea0: 2020 2020 2020 2063 7572 7265 6e74 5f75         current_u
-0000feb0: 7365 725f 6964 656e 7469 7479 2929 3a0a  ser_identity)):.
-0000fec0: 2020 2020 2020 2020 2020 2020 2320 436c              # Cl
-0000fed0: 6561 6e20 7570 2074 6865 206f 776e 6572  ean up the owner
-0000fee0: 2069 6465 6e74 6979 2066 6f72 2074 6865   identiy for the
-0000fef0: 2062 6163 6b73 6c61 7368 2061 6e64 206e   backslash and n
-0000ff00: 6577 6c69 6e65 732c 2063 6175 7365 640a  ewlines, caused.
-0000ff10: 2020 2020 2020 2020 2020 2020 2320 6279              # by
-0000ff20: 2074 6865 2063 6c6f 7564 2043 4c49 206f   the cloud CLI o
-0000ff30: 7574 7075 742c 2065 2e67 2e20 6763 6c6f  utput, e.g. gclo
-0000ff40: 7564 2e0a 2020 2020 2020 2020 2020 2020  ud..            
-0000ff50: 6f77 6e65 7220 3d20 6f77 6e65 722e 7265  owner = owner.re
-0000ff60: 706c 6163 6528 275c 6e27 2c20 2727 292e  place('\n', '').
-0000ff70: 7265 706c 6163 6528 275c 5c27 2c20 2727  replace('\\', ''
-0000ff80: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0000ff90: 206f 776e 6572 203d 3d20 6375 7272 656e   owner == curren
-0000ffa0: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
-0000ffb0: 2020 2069 6620 6920 213d 2030 3a0a 2020     if i != 0:.  
-0000ffc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ffd0: 2020 6c6f 6767 6572 2e77 6172 6e69 6e67    logger.warning
-0000ffe0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000fff0: 2020 2020 2020 2020 2020 6627 5468 6520            f'The 
-00010000: 636c 7573 7465 7220 7761 7320 6f77 6e65  cluster was owne
-00010010: 6420 6279 207b 6f77 6e65 725f 6964 656e  d by {owner_iden
-00010020: 7469 7479 7d2c 2062 7574 2027 0a20 2020  tity}, but '.   
-00010030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010040: 2020 2020 2066 2761 206e 6577 2069 6465       f'a new ide
-00010050: 6e74 6974 7920 7b63 7572 7265 6e74 5f75  ntity {current_u
-00010060: 7365 725f 6964 656e 7469 7479 7d20 6973  ser_identity} is
-00010070: 2061 6374 6976 6174 6564 2e20 5765 2073   activated. We s
-00010080: 7469 6c6c 2027 0a20 2020 2020 2020 2020  till '.         
-00010090: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-000100a0: 616c 6c6f 7720 7468 6520 6f70 6572 6174  allow the operat
-000100b0: 696f 6e20 6173 2074 6865 2074 776f 2069  ion as the two i
-000100c0: 6465 6e74 6974 6965 7320 6172 6520 6c69  dentities are li
-000100d0: 6b65 6c79 2074 6f20 6861 7665 2027 0a20  kely to have '. 
-000100e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000100f0: 2020 2020 2020 2027 7468 6520 7361 6d65         'the same
-00010100: 2061 6363 6573 7320 746f 2074 6865 2063   access to the c
-00010110: 6c75 7374 6572 2e20 506c 6561 7365 2062  luster. Please b
-00010120: 6520 6177 6172 6520 7468 6174 2074 6869  e aware that thi
-00010130: 7320 6361 6e20 270a 2020 2020 2020 2020  s can '.        
-00010140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010150: 2763 6175 7365 2075 6e65 7870 6563 7465  'cause unexpecte
-00010160: 6420 636c 7573 7465 7220 6c65 616b 6167  d cluster leakag
-00010170: 6520 6966 2074 6865 2074 776f 2069 6465  e if the two ide
-00010180: 6e74 6974 6965 7320 6172 6520 6e6f 7420  ntities are not 
-00010190: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-000101a0: 2020 2020 2020 2020 2020 2761 6374 7561            'actua
-000101b0: 6c6c 7920 6571 7569 7661 6c65 6e74 2028  lly equivalent (
-000101c0: 652e 672e 2c20 6265 6c6f 6e67 2074 6f20  e.g., belong to 
-000101d0: 7468 6520 7361 6d65 2070 6572 736f 6e29  the same person)
-000101e0: 2e27 0a20 2020 2020 2020 2020 2020 2020  .'.             
-000101f0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00010200: 2020 2020 2020 2020 2069 6620 6920 213d           if i !=
-00010210: 2030 206f 7220 6c65 6e28 6f77 6e65 725f   0 or len(owner_
-00010220: 6964 656e 7469 7479 2920 213d 206c 656e  identity) != len
-00010230: 2863 7572 7265 6e74 5f75 7365 725f 6964  (current_user_id
-00010240: 656e 7469 7479 293a 0a20 2020 2020 2020  entity):.       
-00010250: 2020 2020 2020 2020 2020 2020 2023 2057               # W
-00010260: 6520 7570 6461 7465 2074 6865 206f 776e  e update the own
-00010270: 6572 206f 6620 6120 636c 7573 7465 722c  er of a cluster,
-00010280: 2077 6865 6e3a 0a20 2020 2020 2020 2020   when:.         
-00010290: 2020 2020 2020 2020 2020 2023 2031 2e20             # 1. 
-000102a0: 5468 6520 7374 7269 6374 6573 7420 6964  The strictest id
-000102b0: 656e 7474 7920 2869 2e65 2e20 7468 6520  entty (i.e. the 
-000102c0: 6669 7273 7420 6f6e 6529 2064 6f65 7320  first one) does 
-000102d0: 6e6f 740a 2020 2020 2020 2020 2020 2020  not.            
-000102e0: 2020 2020 2020 2020 2320 6d61 7463 682c          # match,
-000102f0: 2062 7574 2074 6865 206c 6174 7465 7220   but the latter 
-00010300: 6f6e 6573 206d 6174 6368 2e0a 2020 2020  ones match..    
-00010310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010320: 2320 322e 2054 6865 206c 656e 6774 6820  # 2. The length 
-00010330: 6f66 2074 6865 2074 776f 2069 6465 6e74  of the two ident
-00010340: 6974 6965 7320 6172 6520 6469 6666 6572  ities are differ
-00010350: 656e 742c 2077 6869 6368 0a20 2020 2020  ent, which.     
-00010360: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00010370: 2077 696c 6c20 6f6e 6c79 2068 6170 7065   will only happe
-00010380: 6e20 7768 656e 2074 6865 2063 6c75 7374  n when the clust
-00010390: 6572 2069 7320 6c61 756e 6368 6564 2062  er is launched b
-000103a0: 6566 6f72 6520 2331 3830 382e 0a20 2020  efore #1808..   
-000103b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000103c0: 2023 2055 7064 6174 6520 7468 6520 7573   # Update the us
-000103d0: 6572 2069 6465 6e74 6974 7920 746f 2061  er identity to a
-000103e0: 766f 6964 2073 686f 7769 6e67 2074 6865  void showing the
-000103f0: 2077 6172 6e69 6e67 2061 626f 7665 0a20   warning above. 
-00010400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010410: 2020 2023 2061 6761 696e 2e0a 2020 2020     # again..    
-00010420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010430: 676c 6f62 616c 5f75 7365 725f 7374 6174  global_user_stat
-00010440: 652e 7365 745f 6f77 6e65 725f 6964 656e  e.set_owner_iden
-00010450: 7469 7479 5f66 6f72 5f63 6c75 7374 6572  tity_for_cluster
-00010460: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00010470: 2020 2020 2020 2020 2020 636c 7573 7465            cluste
-00010480: 725f 6e61 6d65 2c20 6375 7272 656e 745f  r_name, current_
-00010490: 7573 6572 5f69 6465 6e74 6974 7929 0a20  user_identity). 
-000104a0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-000104b0: 6574 7572 6e20 2023 2054 6865 2075 7365  eturn  # The use
-000104c0: 7220 6964 656e 7469 7479 206d 6174 6368  r identity match
-000104d0: 6573 2e0a 2020 2020 2020 2020 7769 7468  es..        with
-000104e0: 2075 785f 7574 696c 732e 7072 696e 745f   ux_utils.print_
-000104f0: 6578 6365 7074 696f 6e5f 6e6f 5f74 7261  exception_no_tra
-00010500: 6365 6261 636b 2829 3a0a 2020 2020 2020  ceback():.      
-00010510: 2020 2020 2020 7261 6973 6520 6578 6365        raise exce
-00010520: 7074 696f 6e73 2e43 6c75 7374 6572 4f77  ptions.ClusterOw
-00010530: 6e65 7249 6465 6e74 6974 794d 6973 6d61  nerIdentityMisma
-00010540: 7463 6845 7272 6f72 280a 2020 2020 2020  tchError(.      
-00010550: 2020 2020 2020 2020 2020 6627 7b63 6c75            f'{clu
-00010560: 7374 6572 5f6e 616d 6521 727d 2028 7b63  ster_name!r} ({c
-00010570: 6c6f 7564 7d29 2069 7320 6f77 6e65 6420  loud}) is owned 
-00010580: 6279 2061 6363 6f75 6e74 2027 0a20 2020  by account '.   
-00010590: 2020 2020 2020 2020 2020 2020 2066 277b               f'{
-000105a0: 6f77 6e65 725f 6964 656e 7469 7479 2172  owner_identity!r
-000105b0: 7d2c 2062 7574 2074 6865 2061 6374 6976  }, but the activ
-000105c0: 6174 6564 2061 6363 6f75 6e74 2027 0a20  ated account '. 
-000105d0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000105e0: 2769 7320 7b63 7572 7265 6e74 5f75 7365  'is {current_use
-000105f0: 725f 6964 656e 7469 7479 2172 7d2e 2729  r_identity!r}.')
-00010600: 0a0a 0a64 6566 2074 6167 5f66 696c 7465  ...def tag_filte
-00010610: 725f 666f 725f 636c 7573 7465 7228 636c  r_for_cluster(cl
-00010620: 7573 7465 725f 6e61 6d65 3a20 7374 7229  uster_name: str)
-00010630: 202d 3e20 4469 6374 5b73 7472 2c20 7374   -> Dict[str, st
-00010640: 725d 3a0a 2020 2020 2222 2252 6574 7572  r]:.    """Retur
-00010650: 6e73 2061 2074 6167 2066 696c 7465 7220  ns a tag filter 
-00010660: 666f 7220 7468 6520 636c 7573 7465 722e  for the cluster.
-00010670: 2222 220a 2020 2020 7265 7475 726e 207b  """.    return {
-00010680: 0a20 2020 2020 2020 2027 7261 792d 636c  .        'ray-cl
-00010690: 7573 7465 722d 6e61 6d65 273a 2063 6c75  uster-name': clu
-000106a0: 7374 6572 5f6e 616d 652c 0a20 2020 207d  ster_name,.    }
-000106b0: 0a0a 0a64 6566 205f 7175 6572 795f 636c  ...def _query_cl
-000106c0: 7573 7465 725f 7374 6174 7573 5f76 6961  uster_status_via
-000106d0: 5f63 6c6f 7564 5f61 7069 280a 2020 2020  _cloud_api(.    
-000106e0: 6861 6e64 6c65 3a20 2763 6c6f 7564 5f76  handle: 'cloud_v
-000106f0: 6d5f 7261 795f 6261 636b 656e 642e 436c  m_ray_backend.Cl
-00010700: 6f75 6456 6d52 6179 5265 736f 7572 6365  oudVmRayResource
-00010710: 4861 6e64 6c65 270a 2920 2d3e 204c 6973  Handle'.) -> Lis
-00010720: 745b 7374 6174 7573 5f6c 6962 2e43 6c75  t[status_lib.Clu
-00010730: 7374 6572 5374 6174 7573 5d3a 0a20 2020  sterStatus]:.   
-00010740: 2022 2222 5265 7475 726e 7320 7468 6520   """Returns the 
-00010750: 7374 6174 7573 206f 6620 7468 6520 636c  status of the cl
-00010760: 7573 7465 722e 0a0a 2020 2020 5261 6973  uster...    Rais
-00010770: 6573 3a0a 2020 2020 2020 2020 6578 6365  es:.        exce
-00010780: 7074 696f 6e73 2e43 6c75 7374 6572 5374  ptions.ClusterSt
-00010790: 6174 7573 4665 7463 6869 6e67 4572 726f  atusFetchingErro
-000107a0: 723a 2074 6865 2063 6c75 7374 6572 2073  r: the cluster s
-000107b0: 7461 7475 7320 6361 6e6e 6f74 2062 650a  tatus cannot be.
-000107c0: 2020 2020 2020 2020 2020 6665 7463 6865            fetche
-000107d0: 6420 6672 6f6d 2074 6865 2063 6c6f 7564  d from the cloud
-000107e0: 2070 726f 7669 6465 722e 0a20 2020 2022   provider..    "
-000107f0: 2222 0a20 2020 2063 6c75 7374 6572 5f6e  "".    cluster_n
-00010800: 616d 655f 6f6e 5f63 6c6f 7564 203d 2068  ame_on_cloud = h
-00010810: 616e 646c 652e 636c 7573 7465 725f 6e61  andle.cluster_na
-00010820: 6d65 5f6f 6e5f 636c 6f75 640a 2020 2020  me_on_cloud.    
-00010830: 636c 7573 7465 725f 6e61 6d65 5f69 6e5f  cluster_name_in_
-00010840: 6869 6e74 203d 2063 6f6d 6d6f 6e5f 7574  hint = common_ut
-00010850: 696c 732e 636c 7573 7465 725f 6e61 6d65  ils.cluster_name
-00010860: 5f69 6e5f 6869 6e74 280a 2020 2020 2020  _in_hint(.      
-00010870: 2020 6861 6e64 6c65 2e63 6c75 7374 6572    handle.cluster
-00010880: 5f6e 616d 652c 2063 6c75 7374 6572 5f6e  _name, cluster_n
-00010890: 616d 655f 6f6e 5f63 6c6f 7564 290a 2020  ame_on_cloud).  
-000108a0: 2020 2320 5573 6520 7265 6769 6f6e 2061    # Use region a
-000108b0: 6e64 207a 6f6e 6520 6672 6f6d 2074 6865  nd zone from the
-000108c0: 2063 6c75 7374 6572 2063 6f6e 6669 672c   cluster config,
-000108d0: 2069 6e73 7465 6164 206f 6620 7468 650a   instead of the.
-000108e0: 2020 2020 2320 6861 6e64 6c65 2e6c 6175      # handle.lau
-000108f0: 6e63 6865 645f 7265 736f 7572 6365 732c  nched_resources,
-00010900: 2062 6563 6175 7365 2074 6865 206c 6174   because the lat
-00010910: 7465 7220 6d61 7920 6e6f 7420 6265 2073  ter may not be s
-00010920: 6574 0a20 2020 2023 2063 6f72 7265 6374  et.    # correct
-00010930: 6c79 2079 6574 2e0a 2020 2020 7261 795f  ly yet..    ray_
-00010940: 636f 6e66 6967 203d 2063 6f6d 6d6f 6e5f  config = common_
-00010950: 7574 696c 732e 7265 6164 5f79 616d 6c28  utils.read_yaml(
-00010960: 6861 6e64 6c65 2e63 6c75 7374 6572 5f79  handle.cluster_y
-00010970: 616d 6c29 0a20 2020 2070 726f 7669 6465  aml).    provide
-00010980: 725f 636f 6e66 6967 203d 2072 6179 5f63  r_config = ray_c
-00010990: 6f6e 6669 675b 2770 726f 7669 6465 7227  onfig['provider'
-000109a0: 5d0a 0a20 2020 2023 2051 7565 7279 2074  ]..    # Query t
-000109b0: 6865 2063 6c6f 7564 2070 726f 7669 6465  he cloud provide
-000109c0: 722e 0a20 2020 2023 2054 4f44 4f28 7375  r..    # TODO(su
-000109d0: 7175 6172 6b29 3a20 6d6f 7665 2069 6d70  quark): move imp
-000109e0: 6c65 6d65 6e74 6174 696f 6e73 206f 6620  lementations of 
-000109f0: 6d6f 7265 2063 6c6f 7564 7320 6865 7265  more clouds here
-00010a00: 0a20 2020 2063 6c6f 7564 203d 2068 616e  .    cloud = han
-00010a10: 646c 652e 6c61 756e 6368 6564 5f72 6573  dle.launched_res
-00010a20: 6f75 7263 6573 2e63 6c6f 7564 0a20 2020  ources.cloud.   
-00010a30: 2061 7373 6572 7420 636c 6f75 6420 6973   assert cloud is
-00010a40: 206e 6f74 204e 6f6e 652c 2068 616e 646c   not None, handl
-00010a50: 650a 2020 2020 6966 2063 6c6f 7564 2e53  e.    if cloud.S
-00010a60: 5441 5455 535f 5645 5253 494f 4e20 3e3d  TATUS_VERSION >=
-00010a70: 2063 6c6f 7564 732e 5374 6174 7573 5665   clouds.StatusVe
-00010a80: 7273 696f 6e2e 534b 5950 494c 4f54 3a0a  rsion.SKYPILOT:.
-00010a90: 2020 2020 2020 2020 636c 6f75 645f 6e61          cloud_na
-00010aa0: 6d65 203d 2072 6570 7228 6861 6e64 6c65  me = repr(handle
-00010ab0: 2e6c 6175 6e63 6865 645f 7265 736f 7572  .launched_resour
-00010ac0: 6365 732e 636c 6f75 6429 0a20 2020 2020  ces.cloud).     
-00010ad0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00010ae0: 2020 2020 6e6f 6465 5f73 7461 7475 735f      node_status_
-00010af0: 6469 6374 203d 2070 726f 7669 7369 6f6e  dict = provision
-00010b00: 5f6c 6962 2e71 7565 7279 5f69 6e73 7461  _lib.query_insta
-00010b10: 6e63 6573 280a 2020 2020 2020 2020 2020  nces(.          
-00010b20: 2020 2020 2020 636c 6f75 645f 6e61 6d65        cloud_name
-00010b30: 2c20 636c 7573 7465 725f 6e61 6d65 5f6f  , cluster_name_o
-00010b40: 6e5f 636c 6f75 642c 2070 726f 7669 6465  n_cloud, provide
-00010b50: 725f 636f 6e66 6967 290a 2020 2020 2020  r_config).      
-00010b60: 2020 2020 2020 6c6f 6767 6572 2e64 6562        logger.deb
-00010b70: 7567 2866 2751 7565 7279 696e 6720 7b63  ug(f'Querying {c
-00010b80: 6c6f 7564 5f6e 616d 657d 2063 6c75 7374  loud_name} clust
-00010b90: 6572 2027 0a20 2020 2020 2020 2020 2020  er '.           
-00010ba0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-00010bb0: 7b63 6c75 7374 6572 5f6e 616d 655f 696e  {cluster_name_in
-00010bc0: 5f68 696e 747d 2027 0a20 2020 2020 2020  _hint} '.       
-00010bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010be0: 2020 6627 7374 6174 7573 3a5c 6e7b 7070    f'status:\n{pp
-00010bf0: 7269 6e74 2e70 666f 726d 6174 286e 6f64  rint.pformat(nod
-00010c00: 655f 7374 6174 7573 5f64 6963 7429 7d27  e_status_dict)}'
-00010c10: 290a 2020 2020 2020 2020 2020 2020 6e6f  ).            no
-00010c20: 6465 5f73 7461 7475 7365 7320 3d20 6c69  de_statuses = li
-00010c30: 7374 286e 6f64 655f 7374 6174 7573 5f64  st(node_status_d
-00010c40: 6963 742e 7661 6c75 6573 2829 290a 2020  ict.values()).  
-00010c50: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
-00010c60: 6570 7469 6f6e 2061 7320 653a 2020 2320  eption as e:  # 
-00010c70: 7079 6c69 6e74 3a20 6469 7361 626c 653d  pylint: disable=
-00010c80: 6272 6f61 642d 6578 6365 7074 0a20 2020  broad-except.   
-00010c90: 2020 2020 2020 2020 2077 6974 6820 7578           with ux
-00010ca0: 5f75 7469 6c73 2e70 7269 6e74 5f65 7863  _utils.print_exc
-00010cb0: 6570 7469 6f6e 5f6e 6f5f 7472 6163 6562  eption_no_traceb
-00010cc0: 6163 6b28 293a 0a20 2020 2020 2020 2020  ack():.         
-00010cd0: 2020 2020 2020 2072 6169 7365 2065 7863         raise exc
-00010ce0: 6570 7469 6f6e 732e 436c 7573 7465 7253  eptions.ClusterS
-00010cf0: 7461 7475 7346 6574 6368 696e 6745 7272  tatusFetchingErr
-00010d00: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-00010d10: 2020 2020 2020 2020 6627 4661 696c 6564          f'Failed
-00010d20: 2074 6f20 7175 6572 7920 7b63 6c6f 7564   to query {cloud
-00010d30: 5f6e 616d 657d 2063 6c75 7374 6572 2027  _name} cluster '
-00010d40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010d50: 2020 2020 2066 277b 636c 7573 7465 725f       f'{cluster_
-00010d60: 6e61 6d65 5f69 6e5f 6869 6e74 7d20 270a  name_in_hint} '.
-00010d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010d80: 2020 2020 6627 7374 6174 7573 3a20 7b63      f'status: {c
-00010d90: 6f6d 6d6f 6e5f 7574 696c 732e 666f 726d  ommon_utils.form
-00010da0: 6174 5f65 7863 6570 7469 6f6e 2865 2c20  at_exception(e, 
-00010db0: 7573 655f 6272 6163 6b65 743d 5472 7565  use_bracket=True
-00010dc0: 297d 270a 2020 2020 2020 2020 2020 2020  )}'.            
-00010dd0: 2020 2020 290a 2020 2020 656c 7365 3a0a      ).    else:.
-00010de0: 2020 2020 2020 2020 7265 6769 6f6e 203d          region =
-00010df0: 2070 726f 7669 6465 725f 636f 6e66 6967   provider_config
-00010e00: 2e67 6574 2827 7265 6769 6f6e 2729 206f  .get('region') o
-00010e10: 7220 7072 6f76 6964 6572 5f63 6f6e 6669  r provider_confi
-00010e20: 672e 6765 7428 0a20 2020 2020 2020 2020  g.get(.         
-00010e30: 2020 2027 6c6f 6361 7469 6f6e 2729 0a20     'location'). 
-00010e40: 2020 2020 2020 207a 6f6e 6520 3d20 7261         zone = ra
-00010e50: 795f 636f 6e66 6967 5b27 7072 6f76 6964  y_config['provid
-00010e60: 6572 275d 2e67 6574 2827 6176 6169 6c61  er'].get('availa
-00010e70: 6269 6c69 7479 5f7a 6f6e 6527 290a 2020  bility_zone').  
-00010e80: 2020 2020 2020 6e6f 6465 5f73 7461 7475        node_statu
-00010e90: 7365 7320 3d20 636c 6f75 642e 7175 6572  ses = cloud.quer
-00010ea0: 795f 7374 6174 7573 280a 2020 2020 2020  y_status(.      
-00010eb0: 2020 2020 2020 636c 7573 7465 725f 6e61        cluster_na
-00010ec0: 6d65 5f6f 6e5f 636c 6f75 642c 0a20 2020  me_on_cloud,.   
-00010ed0: 2020 2020 2020 2020 2074 6167 5f66 696c           tag_fil
-00010ee0: 7465 725f 666f 725f 636c 7573 7465 7228  ter_for_cluster(
-00010ef0: 636c 7573 7465 725f 6e61 6d65 5f6f 6e5f  cluster_name_on_
-00010f00: 636c 6f75 6429 2c20 7265 6769 6f6e 2c20  cloud), region, 
-00010f10: 7a6f 6e65 290a 2020 2020 7265 7475 726e  zone).    return
-00010f20: 206e 6f64 655f 7374 6174 7573 6573 0a0a   node_statuses..
-00010f30: 0a64 6566 2063 6865 636b 5f63 616e 5f63  .def check_can_c
-00010f40: 6c6f 6e65 5f64 6973 6b5f 616e 645f 6f76  lone_disk_and_ov
-00010f50: 6572 7269 6465 5f74 6173 6b28 0a20 2020  erride_task(.   
-00010f60: 2063 6c75 7374 6572 5f6e 616d 653a 2073   cluster_name: s
-00010f70: 7472 2c20 7461 7267 6574 5f63 6c75 7374  tr, target_clust
-00010f80: 6572 5f6e 616d 653a 204f 7074 696f 6e61  er_name: Optiona
-00010f90: 6c5b 7374 725d 2c20 7461 736b 3a20 2774  l[str], task: 't
-00010fa0: 6173 6b5f 6c69 622e 5461 736b 270a 2920  ask_lib.Task'.) 
-00010fb0: 2d3e 2054 7570 6c65 5b27 7461 736b 5f6c  -> Tuple['task_l
-00010fc0: 6962 2e54 6173 6b27 2c20 2763 6c6f 7564  ib.Task', 'cloud
-00010fd0: 5f76 6d5f 7261 795f 6261 636b 656e 642e  _vm_ray_backend.
-00010fe0: 436c 6f75 6456 6d52 6179 5265 736f 7572  CloudVmRayResour
-00010ff0: 6365 4861 6e64 6c65 275d 3a0a 2020 2020  ceHandle']:.    
-00011000: 2222 2243 6865 636b 2069 6620 7468 6520  """Check if the 
-00011010: 7461 736b 2069 7320 636f 6d70 6174 6962  task is compatib
-00011020: 6c65 2074 6f20 636c 6f6e 6520 6469 736b  le to clone disk
-00011030: 2066 726f 6d20 7468 6520 736f 7572 6365   from the source
-00011040: 2063 6c75 7374 6572 2e0a 0a20 2020 2041   cluster...    A
-00011050: 7267 733a 0a20 2020 2020 2020 2063 6c75  rgs:.        clu
-00011060: 7374 6572 5f6e 616d 653a 2054 6865 206e  ster_name: The n
-00011070: 616d 6520 6f66 2074 6865 2063 6c75 7374  ame of the clust
-00011080: 6572 2074 6f20 636c 6f6e 6520 6469 736b  er to clone disk
-00011090: 2066 726f 6d2e 0a20 2020 2020 2020 2074   from..        t
-000110a0: 6172 6765 745f 636c 7573 7465 725f 6e61  arget_cluster_na
-000110b0: 6d65 3a20 5468 6520 6e61 6d65 206f 6620  me: The name of 
-000110c0: 7468 6520 7461 7267 6574 2063 6c75 7374  the target clust
-000110d0: 6572 2e0a 2020 2020 2020 2020 7461 736b  er..        task
-000110e0: 3a20 5468 6520 7461 736b 2074 6f20 6368  : The task to ch
-000110f0: 6563 6b2e 0a0a 2020 2020 5265 7475 726e  eck...    Return
-00011100: 733a 0a20 2020 2020 2020 2054 6865 2074  s:.        The t
-00011110: 6173 6b20 746f 2075 7365 2061 6e64 2074  ask to use and t
-00011120: 6865 2072 6573 6f75 7263 6520 6861 6e64  he resource hand
-00011130: 6c65 206f 6620 7468 6520 736f 7572 6365  le of the source
-00011140: 2063 6c75 7374 6572 2e0a 0a20 2020 2052   cluster...    R
-00011150: 6169 7365 733a 0a20 2020 2020 2020 2056  aises:.        V
-00011160: 616c 7565 4572 726f 723a 2049 6620 7468  alueError: If th
-00011170: 6520 736f 7572 6365 2063 6c75 7374 6572  e source cluster
-00011180: 2064 6f65 7320 6e6f 7420 6578 6973 742e   does not exist.
-00011190: 0a20 2020 2020 2020 2065 7863 6570 7469  .        excepti
-000111a0: 6f6e 732e 4e6f 7453 7570 706f 7274 6564  ons.NotSupported
-000111b0: 4572 726f 723a 2049 6620 7468 6520 736f  Error: If the so
-000111c0: 7572 6365 2063 6c75 7374 6572 2069 7320  urce cluster is 
-000111d0: 6e6f 7420 7661 6c69 6420 6f72 2074 6865  not valid or the
-000111e0: 0a20 2020 2020 2020 2020 2020 2074 6173  .            tas
-000111f0: 6b20 6973 206e 6f74 2063 6f6d 7061 7469  k is not compati
-00011200: 626c 6520 746f 2063 6c6f 6e65 2064 6973  ble to clone dis
-00011210: 6b20 6672 6f6d 2074 6865 2073 6f75 7263  k from the sourc
-00011220: 6520 636c 7573 7465 722e 0a20 2020 2022  e cluster..    "
-00011230: 2222 0a20 2020 2073 6f75 7263 655f 636c  "".    source_cl
-00011240: 7573 7465 725f 7374 6174 7573 2c20 6861  uster_status, ha
-00011250: 6e64 6c65 203d 2072 6566 7265 7368 5f63  ndle = refresh_c
-00011260: 6c75 7374 6572 5f73 7461 7475 735f 6861  luster_status_ha
-00011270: 6e64 6c65 2863 6c75 7374 6572 5f6e 616d  ndle(cluster_nam
-00011280: 6529 0a20 2020 2069 6620 736f 7572 6365  e).    if source
-00011290: 5f63 6c75 7374 6572 5f73 7461 7475 7320  _cluster_status 
-000112a0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-000112b0: 2077 6974 6820 7578 5f75 7469 6c73 2e70   with ux_utils.p
-000112c0: 7269 6e74 5f65 7863 6570 7469 6f6e 5f6e  rint_exception_n
-000112d0: 6f5f 7472 6163 6562 6163 6b28 293a 0a20  o_traceback():. 
-000112e0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-000112f0: 2056 616c 7565 4572 726f 7228 0a20 2020   ValueError(.   
-00011300: 2020 2020 2020 2020 2020 2020 2066 2743               f'C
-00011310: 616e 6e6f 7420 6669 6e64 2063 6c75 7374  annot find clust
-00011320: 6572 207b 636c 7573 7465 725f 6e61 6d65  er {cluster_name
-00011330: 2172 7d20 746f 2063 6c6f 6e65 2064 6973  !r} to clone dis
-00011340: 6b20 6672 6f6d 2e27 290a 0a20 2020 2069  k from.')..    i
-00011350: 6620 6e6f 7420 6973 696e 7374 616e 6365  f not isinstance
-00011360: 2868 616e 646c 652c 2062 6163 6b65 6e64  (handle, backend
-00011370: 732e 436c 6f75 6456 6d52 6179 5265 736f  s.CloudVmRayReso
-00011380: 7572 6365 4861 6e64 6c65 293a 0a20 2020  urceHandle):.   
-00011390: 2020 2020 2077 6974 6820 7578 5f75 7469       with ux_uti
-000113a0: 6c73 2e70 7269 6e74 5f65 7863 6570 7469  ls.print_excepti
-000113b0: 6f6e 5f6e 6f5f 7472 6163 6562 6163 6b28  on_no_traceback(
-000113c0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-000113d0: 6169 7365 2065 7863 6570 7469 6f6e 732e  aise exceptions.
-000113e0: 4e6f 7453 7570 706f 7274 6564 4572 726f  NotSupportedErro
-000113f0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-00011400: 2020 2066 2743 616e 6e6f 7420 636c 6f6e     f'Cannot clon
-00011410: 6520 6469 736b 2066 726f 6d20 6120 6e6f  e disk from a no
-00011420: 6e2d 636c 6f75 6420 636c 7573 7465 7220  n-cloud cluster 
-00011430: 7b63 6c75 7374 6572 5f6e 616d 6521 727d  {cluster_name!r}
-00011440: 2e27 290a 0a20 2020 2069 6620 736f 7572  .')..    if sour
-00011450: 6365 5f63 6c75 7374 6572 5f73 7461 7475  ce_cluster_statu
-00011460: 7320 213d 2073 7461 7475 735f 6c69 622e  s != status_lib.
-00011470: 436c 7573 7465 7253 7461 7475 732e 5354  ClusterStatus.ST
-00011480: 4f50 5045 443a 0a20 2020 2020 2020 2077  OPPED:.        w
-00011490: 6974 6820 7578 5f75 7469 6c73 2e70 7269  ith ux_utils.pri
-000114a0: 6e74 5f65 7863 6570 7469 6f6e 5f6e 6f5f  nt_exception_no_
-000114b0: 7472 6163 6562 6163 6b28 293a 0a20 2020  traceback():.   
-000114c0: 2020 2020 2020 2020 2072 6169 7365 2065           raise e
-000114d0: 7863 6570 7469 6f6e 732e 4e6f 7453 7570  xceptions.NotSup
-000114e0: 706f 7274 6564 4572 726f 7228 0a20 2020  portedError(.   
-000114f0: 2020 2020 2020 2020 2020 2020 2066 2743               f'C
-00011500: 616e 6e6f 7420 636c 6f6e 6520 6469 736b  annot clone disk
-00011510: 2066 726f 6d20 636c 7573 7465 7220 7b63   from cluster {c
-00011520: 6c75 7374 6572 5f6e 616d 6521 727d 2027  luster_name!r} '
-00011530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011540: 2066 2728 7b73 6f75 7263 655f 636c 7573   f'({source_clus
-00011550: 7465 725f 7374 6174 7573 2172 7d29 2e20  ter_status!r}). 
-00011560: 506c 6561 7365 2073 746f 7020 7468 6520  Please stop the 
-00011570: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00011580: 2020 6627 636c 7573 7465 7220 6669 7273    f'cluster firs
-00011590: 743a 2073 6b79 2073 746f 7020 7b63 6c75  t: sky stop {clu
-000115a0: 7374 6572 5f6e 616d 657d 2729 0a0a 2020  ster_name}')..  
-000115b0: 2020 6966 2074 6172 6765 745f 636c 7573    if target_clus
-000115c0: 7465 725f 6e61 6d65 2069 7320 6e6f 7420  ter_name is not 
-000115d0: 4e6f 6e65 3a0a 2020 2020 2020 2020 7461  None:.        ta
-000115e0: 7267 6574 5f63 6c75 7374 6572 5f73 7461  rget_cluster_sta
-000115f0: 7475 732c 205f 203d 2072 6566 7265 7368  tus, _ = refresh
-00011600: 5f63 6c75 7374 6572 5f73 7461 7475 735f  _cluster_status_
-00011610: 6861 6e64 6c65 280a 2020 2020 2020 2020  handle(.        
-00011620: 2020 2020 7461 7267 6574 5f63 6c75 7374      target_clust
-00011630: 6572 5f6e 616d 6529 0a20 2020 2020 2020  er_name).       
-00011640: 2069 6620 7461 7267 6574 5f63 6c75 7374   if target_clust
-00011650: 6572 5f73 7461 7475 7320 6973 206e 6f74  er_status is not
-00011660: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00011670: 2020 2077 6974 6820 7578 5f75 7469 6c73     with ux_utils
-00011680: 2e70 7269 6e74 5f65 7863 6570 7469 6f6e  .print_exception
-00011690: 5f6e 6f5f 7472 6163 6562 6163 6b28 293a  _no_traceback():
-000116a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000116b0: 2072 6169 7365 2065 7863 6570 7469 6f6e   raise exception
-000116c0: 732e 4e6f 7453 7570 706f 7274 6564 4572  s.NotSupportedEr
-000116d0: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
-000116e0: 2020 2020 2020 2020 2066 2754 6865 2074           f'The t
-000116f0: 6172 6765 7420 636c 7573 7465 7220 7b74  arget cluster {t
-00011700: 6172 6765 745f 636c 7573 7465 725f 6e61  arget_cluster_na
-00011710: 6d65 2172 7d20 616c 7265 6164 7920 6578  me!r} already ex
-00011720: 6973 7473 2e20 436c 6f6e 696e 6720 270a  ists. Cloning '.
-00011730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011740: 2020 2020 2764 6973 6b20 6973 206f 6e6c      'disk is onl
-00011750: 7920 7375 7070 6f72 7465 6420 7768 656e  y supported when
-00011760: 2063 7265 6174 696e 6720 6120 6e65 7720   creating a new 
-00011770: 636c 7573 7465 722e 2054 6f20 6669 783a  cluster. To fix:
-00011780: 2073 7065 6369 6679 2027 0a20 2020 2020   specify '.     
-00011790: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-000117a0: 6120 6e65 7720 7461 7267 6574 2063 6c75  a new target clu
-000117b0: 7374 6572 206e 616d 652e 2729 0a0a 2020  ster name.')..  
-000117c0: 2020 6e65 775f 7461 736b 5f72 6573 6f75    new_task_resou
-000117d0: 7263 6573 203d 205b 5d0a 2020 2020 6f72  rces = [].    or
-000117e0: 6967 696e 616c 5f63 6c6f 7564 203d 2068  iginal_cloud = h
-000117f0: 616e 646c 652e 6c61 756e 6368 6564 5f72  andle.launched_r
-00011800: 6573 6f75 7263 6573 2e63 6c6f 7564 0a20  esources.cloud. 
-00011810: 2020 206f 7269 6769 6e61 6c5f 636c 6f75     original_clou
-00011820: 642e 6368 6563 6b5f 6665 6174 7572 6573  d.check_features
-00011830: 5f61 7265 5f73 7570 706f 7274 6564 280a  _are_supported(.
-00011840: 2020 2020 2020 2020 6861 6e64 6c65 2e6c          handle.l
-00011850: 6175 6e63 6865 645f 7265 736f 7572 6365  aunched_resource
-00011860: 732c 0a20 2020 2020 2020 207b 636c 6f75  s,.        {clou
-00011870: 6473 2e43 6c6f 7564 496d 706c 656d 656e  ds.CloudImplemen
-00011880: 7461 7469 6f6e 4665 6174 7572 6573 2e43  tationFeatures.C
-00011890: 4c4f 4e45 5f44 4953 4b5f 4652 4f4d 5f43  LONE_DISK_FROM_C
-000118a0: 4c55 5354 4552 7d29 0a0a 2020 2020 6173  LUSTER})..    as
-000118b0: 7365 7274 206f 7269 6769 6e61 6c5f 636c  sert original_cl
-000118c0: 6f75 6420 6973 206e 6f74 204e 6f6e 652c  oud is not None,
-000118d0: 2068 616e 646c 652e 6c61 756e 6368 6564   handle.launched
-000118e0: 5f72 6573 6f75 7263 6573 0a20 2020 2068  _resources.    h
-000118f0: 6173 5f6f 7665 7272 6964 6520 3d20 4661  as_override = Fa
-00011900: 6c73 650a 2020 2020 6861 735f 6469 736b  lse.    has_disk
-00011910: 5f73 697a 655f 6d65 7420 3d20 4661 6c73  _size_met = Fals
-00011920: 650a 2020 2020 6861 735f 636c 6f75 645f  e.    has_cloud_
-00011930: 6d65 7420 3d20 4661 6c73 650a 2020 2020  met = False.    
-00011940: 666f 7220 7461 736b 5f72 6573 6f75 7263  for task_resourc
-00011950: 6573 2069 6e20 7461 736b 2e72 6573 6f75  es in task.resou
-00011960: 7263 6573 3a0a 2020 2020 2020 2020 6966  rces:.        if
-00011970: 2068 616e 646c 652e 6c61 756e 6368 6564   handle.launched
-00011980: 5f72 6573 6f75 7263 6573 2e64 6973 6b5f  _resources.disk_
-00011990: 7369 7a65 203e 2074 6173 6b5f 7265 736f  size > task_reso
-000119a0: 7572 6365 732e 6469 736b 5f73 697a 653a  urces.disk_size:
-000119b0: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-000119c0: 6865 2074 6172 6765 7420 636c 7573 7465  he target cluste
-000119d0: 7227 7320 6469 736b 2073 686f 756c 6420  r's disk should 
-000119e0: 6265 2061 7420 6c65 6173 7420 6173 206c  be at least as l
-000119f0: 6172 6765 2061 7320 7468 6520 736f 7572  arge as the sour
-00011a00: 6365 2e0a 2020 2020 2020 2020 2020 2020  ce..            
-00011a10: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
-00011a20: 2068 6173 5f64 6973 6b5f 7369 7a65 5f6d   has_disk_size_m
-00011a30: 6574 203d 2054 7275 650a 2020 2020 2020  et = True.      
-00011a40: 2020 6966 2074 6173 6b5f 7265 736f 7572    if task_resour
-00011a50: 6365 732e 636c 6f75 6420 6973 206e 6f74  ces.cloud is not
-00011a60: 204e 6f6e 6520 616e 6420 6e6f 7420 6f72   None and not or
-00011a70: 6967 696e 616c 5f63 6c6f 7564 2e69 735f  iginal_cloud.is_
-00011a80: 7361 6d65 5f63 6c6f 7564 280a 2020 2020  same_cloud(.    
-00011a90: 2020 2020 2020 2020 2020 2020 7461 736b              task
-00011aa0: 5f72 6573 6f75 7263 6573 2e63 6c6f 7564  _resources.cloud
-00011ab0: 293a 0a20 2020 2020 2020 2020 2020 2063  ):.            c
-00011ac0: 6f6e 7469 6e75 650a 2020 2020 2020 2020  ontinue.        
-00011ad0: 6861 735f 636c 6f75 645f 6d65 7420 3d20  has_cloud_met = 
-00011ae0: 5472 7565 0a0a 2020 2020 2020 2020 6f76  True..        ov
-00011af0: 6572 7269 6465 5f70 6172 616d 203d 207b  erride_param = {
-00011b00: 7d0a 2020 2020 2020 2020 6966 2074 6173  }.        if tas
-00011b10: 6b5f 7265 736f 7572 6365 732e 636c 6f75  k_resources.clou
-00011b20: 6420 6973 204e 6f6e 653a 0a20 2020 2020  d is None:.     
-00011b30: 2020 2020 2020 206f 7665 7272 6964 655f         override_
-00011b40: 7061 7261 6d5b 2763 6c6f 7564 275d 203d  param['cloud'] =
-00011b50: 206f 7269 6769 6e61 6c5f 636c 6f75 640a   original_cloud.
-00011b60: 2020 2020 2020 2020 6966 2074 6173 6b5f          if task_
-00011b70: 7265 736f 7572 6365 732e 7265 6769 6f6e  resources.region
-00011b80: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-00011b90: 2020 2020 2020 6f76 6572 7269 6465 5f70        override_p
-00011ba0: 6172 616d 5b27 7265 6769 6f6e 275d 203d  aram['region'] =
-00011bb0: 2068 616e 646c 652e 6c61 756e 6368 6564   handle.launched
-00011bc0: 5f72 6573 6f75 7263 6573 2e72 6567 696f  _resources.regio
-00011bd0: 6e0a 0a20 2020 2020 2020 2069 6620 6f76  n..        if ov
-00011be0: 6572 7269 6465 5f70 6172 616d 3a0a 2020  erride_param:.  
-00011bf0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-00011c00: 2e69 6e66 6f28 0a20 2020 2020 2020 2020  .info(.         
-00011c10: 2020 2020 2020 2066 274e 6f20 636c 6f75         f'No clou
-00011c20: 642f 7265 6769 6f6e 2073 7065 6369 6669  d/region specifi
-00011c30: 6564 2066 6f72 2074 6865 2074 6173 6b20  ed for the task 
-00011c40: 7b74 6173 6b5f 7265 736f 7572 6365 737d  {task_resources}
-00011c50: 2e20 5573 696e 6720 7468 6520 7361 6d65  . Using the same
-00011c60: 2072 6567 696f 6e20 270a 2020 2020 2020   region '.      
-00011c70: 2020 2020 2020 2020 2020 6627 6173 2073            f'as s
-00011c80: 6f75 7263 6520 636c 7573 7465 7220 7b63  ource cluster {c
-00011c90: 6c75 7374 6572 5f6e 616d 6521 727d 3a20  luster_name!r}: 
-00011ca0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00011cb0: 2020 6627 7b68 616e 646c 652e 6c61 756e    f'{handle.laun
-00011cc0: 6368 6564 5f72 6573 6f75 7263 6573 2e63  ched_resources.c
-00011cd0: 6c6f 7564 7d27 0a20 2020 2020 2020 2020  loud}'.         
-00011ce0: 2020 2020 2020 2066 2728 7b68 616e 646c         f'({handl
-00011cf0: 652e 6c61 756e 6368 6564 5f72 6573 6f75  e.launched_resou
-00011d00: 7263 6573 2e72 6567 696f 6e7d 292e 2729  rces.region}).')
-00011d10: 0a20 2020 2020 2020 2020 2020 2068 6173  .            has
-00011d20: 5f6f 7665 7272 6964 6520 3d20 5472 7565  _override = True
-00011d30: 0a20 2020 2020 2020 2074 6173 6b5f 7265  .        task_re
-00011d40: 736f 7572 6365 7320 3d20 7461 736b 5f72  sources = task_r
-00011d50: 6573 6f75 7263 6573 2e63 6f70 7928 2a2a  esources.copy(**
-00011d60: 6f76 6572 7269 6465 5f70 6172 616d 290a  override_param).
-00011d70: 2020 2020 2020 2020 6e65 775f 7461 736b          new_task
-00011d80: 5f72 6573 6f75 7263 6573 2e61 7070 656e  _resources.appen
-00011d90: 6428 7461 736b 5f72 6573 6f75 7263 6573  d(task_resources
-00011da0: 290a 0a20 2020 2069 6620 6e6f 7420 6e65  )..    if not ne
-00011db0: 775f 7461 736b 5f72 6573 6f75 7263 6573  w_task_resources
-00011dc0: 3a0a 2020 2020 2020 2020 6966 206e 6f74  :.        if not
-00011dd0: 2068 6173 5f64 6973 6b5f 7369 7a65 5f6d   has_disk_size_m
-00011de0: 6574 3a0a 2020 2020 2020 2020 2020 2020  et:.            
-00011df0: 7769 7468 2075 785f 7574 696c 732e 7072  with ux_utils.pr
-00011e00: 696e 745f 6578 6365 7074 696f 6e5f 6e6f  int_exception_no
-00011e10: 5f74 7261 6365 6261 636b 2829 3a0a 2020  _traceback():.  
-00011e20: 2020 2020 2020 2020 2020 2020 2020 7461                ta
-00011e30: 7267 6574 5f63 6c75 7374 6572 5f6e 616d  rget_cluster_nam
-00011e40: 655f 7374 7220 3d20 6627 207b 7461 7267  e_str = f' {targ
-00011e50: 6574 5f63 6c75 7374 6572 5f6e 616d 6521  et_cluster_name!
-00011e60: 727d 270a 2020 2020 2020 2020 2020 2020  r}'.            
-00011e70: 2020 2020 6966 2074 6172 6765 745f 636c      if target_cl
-00011e80: 7573 7465 725f 6e61 6d65 2069 7320 4e6f  uster_name is No
-00011e90: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00011ea0: 2020 2020 2020 2020 7461 7267 6574 5f63          target_c
-00011eb0: 6c75 7374 6572 5f6e 616d 655f 7374 7220  luster_name_str 
-00011ec0: 3d20 2727 0a20 2020 2020 2020 2020 2020  = ''.           
-00011ed0: 2020 2020 2072 6169 7365 2065 7863 6570       raise excep
-00011ee0: 7469 6f6e 732e 4e6f 7453 7570 706f 7274  tions.NotSupport
-00011ef0: 6564 4572 726f 7228 0a20 2020 2020 2020  edError(.       
-00011f00: 2020 2020 2020 2020 2020 2020 2066 2754               f'T
-00011f10: 6865 2074 6172 6765 7420 636c 7573 7465  he target cluste
-00011f20: 727b 7461 7267 6574 5f63 6c75 7374 6572  r{target_cluster
-00011f30: 5f6e 616d 655f 7374 727d 2073 686f 756c  _name_str} shoul
-00011f40: 6420 6861 7665 2061 2064 6973 6b20 7369  d have a disk si
-00011f50: 7a65 2027 0a20 2020 2020 2020 2020 2020  ze '.           
-00011f60: 2020 2020 2020 2020 2066 276f 6620 6174           f'of at
-00011f70: 206c 6561 7374 207b 6861 6e64 6c65 2e6c   least {handle.l
-00011f80: 6175 6e63 6865 645f 7265 736f 7572 6365  aunched_resource
-00011f90: 732e 6469 736b 5f73 697a 657d 2047 4220  s.disk_size} GB 
-00011fa0: 746f 2063 6c6f 6e65 2074 6865 2027 0a20  to clone the '. 
-00011fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011fc0: 2020 2066 2764 6973 6b20 6672 6f6d 207b     f'disk from {
-00011fd0: 636c 7573 7465 725f 6e61 6d65 2172 7d2e  cluster_name!r}.
-00011fe0: 2729 0a20 2020 2020 2020 2069 6620 6e6f  ').        if no
-00011ff0: 7420 6861 735f 636c 6f75 645f 6d65 743a  t has_cloud_met:
-00012000: 0a20 2020 2020 2020 2020 2020 2074 6173  .            tas
-00012010: 6b5f 7265 736f 7572 6365 735f 636c 6f75  k_resources_clou
-00012020: 645f 7374 7220 3d20 275b 2720 2b20 272c  d_str = '[' + ',
-00012030: 272e 6a6f 696e 280a 2020 2020 2020 2020  '.join(.        
-00012040: 2020 2020 2020 2020 5b66 277b 7265 732e          [f'{res.
-00012050: 636c 6f75 647d 2720 666f 7220 7265 7320  cloud}' for res 
-00012060: 696e 2074 6173 6b2e 7265 736f 7572 6365  in task.resource
-00012070: 735d 2920 2b20 275d 270a 2020 2020 2020  s]) + ']'.      
-00012080: 2020 2020 2020 7461 736b 5f72 6573 6f75        task_resou
-00012090: 7263 6573 5f73 7472 203d 2027 5b27 202b  rces_str = '[' +
-000120a0: 2027 2c27 2e6a 6f69 6e28 0a20 2020 2020   ','.join(.     
-000120b0: 2020 2020 2020 2020 2020 205b 6627 7b72             [f'{r
-000120c0: 6573 7d27 2066 6f72 2072 6573 2069 6e20  es}' for res in 
-000120d0: 7461 736b 2e72 6573 6f75 7263 6573 5d29  task.resources])
-000120e0: 202b 2027 5d27 0a20 2020 2020 2020 2020   + ']'.         
-000120f0: 2020 2077 6974 6820 7578 5f75 7469 6c73     with ux_utils
-00012100: 2e70 7269 6e74 5f65 7863 6570 7469 6f6e  .print_exception
-00012110: 5f6e 6f5f 7472 6163 6562 6163 6b28 293a  _no_traceback():
-00012120: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012130: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-00012140: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-00012150: 2020 2020 2020 2066 2743 616e 6e6f 7420         f'Cannot 
-00012160: 636c 6f6e 6520 6469 736b 2061 6372 6f73  clone disk acros
-00012170: 7320 636c 6f75 6420 6672 6f6d 207b 6f72  s cloud from {or
-00012180: 6967 696e 616c 5f63 6c6f 7564 7d20 746f  iginal_cloud} to
-00012190: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-000121a0: 2020 2020 2020 2066 277b 7461 736b 5f72         f'{task_r
-000121b0: 6573 6f75 7263 6573 5f63 6c6f 7564 5f73  esources_cloud_s
-000121c0: 7472 7d20 666f 7220 7265 736f 7572 6365  tr} for resource
-000121d0: 7320 7b74 6173 6b5f 7265 736f 7572 6365  s {task_resource
-000121e0: 735f 7374 727d 2e27 0a20 2020 2020 2020  s_str}.'.       
-000121f0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00012200: 2020 2061 7373 6572 7420 4661 6c73 652c     assert False,
-00012210: 2027 5368 6f75 6c64 206e 6f74 2072 6561   'Should not rea
-00012220: 6368 2068 6572 652e 270a 2020 2020 2320  ch here.'.    # 
-00012230: 7365 7420 7468 6520 6e65 775f 7461 736b  set the new_task
-00012240: 5f72 6573 6f75 7263 6573 2074 6f20 6265  _resources to be
-00012250: 2074 6865 2073 616d 6520 7479 7065 2028   the same type (
-00012260: 6c69 7374 206f 7220 7365 7429 2061 7320  list or set) as 
-00012270: 7468 650a 2020 2020 2320 6f72 6967 696e  the.    # origin
-00012280: 616c 2074 6173 6b2e 7265 736f 7572 6365  al task.resource
-00012290: 730a 2020 2020 6966 2068 6173 5f6f 7665  s.    if has_ove
-000122a0: 7272 6964 653a 0a20 2020 2020 2020 2074  rride:.        t
-000122b0: 6173 6b2e 7365 745f 7265 736f 7572 6365  ask.set_resource
-000122c0: 7328 7479 7065 2874 6173 6b2e 7265 736f  s(type(task.reso
-000122d0: 7572 6365 7329 286e 6577 5f74 6173 6b5f  urces)(new_task_
-000122e0: 7265 736f 7572 6365 7329 290a 2020 2020  resources)).    
-000122f0: 2020 2020 2320 5265 7365 7420 7468 6520      # Reset the 
-00012300: 6265 7374 5f72 6573 6f75 7263 6573 2074  best_resources t
-00012310: 6f20 7472 6967 6572 2072 652d 6f70 7469  o triger re-opti
-00012320: 6d69 7a61 7469 6f6e 0a20 2020 2020 2020  mization.       
-00012330: 2023 206c 6174 6572 2c20 736f 2074 6861   # later, so tha
-00012340: 7420 7468 6520 6e65 7720 7461 736b 5f72  t the new task_r
-00012350: 6573 6f75 7263 6573 2077 696c 6c20 6265  esources will be
-00012360: 2075 7365 642e 0a20 2020 2020 2020 2074   used..        t
-00012370: 6173 6b2e 6265 7374 5f72 6573 6f75 7263  ask.best_resourc
-00012380: 6573 203d 204e 6f6e 650a 2020 2020 7265  es = None.    re
-00012390: 7475 726e 2074 6173 6b2c 2068 616e 646c  turn task, handl
-000123a0: 650a 0a0a 6465 6620 5f75 7064 6174 655f  e...def _update_
-000123b0: 636c 7573 7465 725f 7374 6174 7573 5f6e  cluster_status_n
-000123c0: 6f5f 6c6f 636b 280a 2020 2020 2020 2020  o_lock(.        
-000123d0: 636c 7573 7465 725f 6e61 6d65 3a20 7374  cluster_name: st
-000123e0: 7229 202d 3e20 4f70 7469 6f6e 616c 5b44  r) -> Optional[D
-000123f0: 6963 745b 7374 722c 2041 6e79 5d5d 3a0a  ict[str, Any]]:.
-00012400: 2020 2020 2222 2255 7064 6174 6573 2074      """Updates t
-00012410: 6865 2073 7461 7475 7320 6f66 2074 6865  he status of the
-00012420: 2063 6c75 7374 6572 2e0a 0a20 2020 2052   cluster...    R
-00012430: 6169 7365 733a 0a20 2020 2020 2020 2065  aises:.        e
-00012440: 7863 6570 7469 6f6e 732e 436c 7573 7465  xceptions.Cluste
-00012450: 7253 7461 7475 7346 6574 6368 696e 6745  rStatusFetchingE
-00012460: 7272 6f72 3a20 7468 6520 636c 7573 7465  rror: the cluste
-00012470: 7220 7374 6174 7573 2063 616e 6e6f 7420  r status cannot 
-00012480: 6265 0a20 2020 2020 2020 2020 2066 6574  be.          fet
-00012490: 6368 6564 2066 726f 6d20 7468 6520 636c  ched from the cl
-000124a0: 6f75 6420 7072 6f76 6964 6572 2e0a 2020  oud provider..  
-000124b0: 2020 2222 220a 2020 2020 7265 636f 7264    """.    record
-000124c0: 203d 2067 6c6f 6261 6c5f 7573 6572 5f73   = global_user_s
-000124d0: 7461 7465 2e67 6574 5f63 6c75 7374 6572  tate.get_cluster
-000124e0: 5f66 726f 6d5f 6e61 6d65 2863 6c75 7374  _from_name(clust
-000124f0: 6572 5f6e 616d 6529 0a20 2020 2069 6620  er_name).    if 
-00012500: 7265 636f 7264 2069 7320 4e6f 6e65 3a0a  record is None:.
-00012510: 2020 2020 2020 2020 7265 7475 726e 204e          return N
-00012520: 6f6e 650a 2020 2020 6861 6e64 6c65 203d  one.    handle =
-00012530: 2072 6563 6f72 645b 2768 616e 646c 6527   record['handle'
-00012540: 5d0a 2020 2020 6966 206e 6f74 2069 7369  ].    if not isi
-00012550: 6e73 7461 6e63 6528 6861 6e64 6c65 2c20  nstance(handle, 
-00012560: 6261 636b 656e 6473 2e43 6c6f 7564 566d  backends.CloudVm
-00012570: 5261 7952 6573 6f75 7263 6548 616e 646c  RayResourceHandl
-00012580: 6529 3a0a 2020 2020 2020 2020 7265 7475  e):.        retu
-00012590: 726e 2072 6563 6f72 640a 2020 2020 636c  rn record.    cl
-000125a0: 7573 7465 725f 6e61 6d65 203d 2068 616e  uster_name = han
-000125b0: 646c 652e 636c 7573 7465 725f 6e61 6d65  dle.cluster_name
-000125c0: 0a0a 2020 2020 6e6f 6465 5f73 7461 7475  ..    node_statu
-000125d0: 7365 7320 3d20 5f71 7565 7279 5f63 6c75  ses = _query_clu
-000125e0: 7374 6572 5f73 7461 7475 735f 7669 615f  ster_status_via_
-000125f0: 636c 6f75 645f 6170 6928 6861 6e64 6c65  cloud_api(handle
-00012600: 290a 0a20 2020 2061 6c6c 5f6e 6f64 6573  )..    all_nodes
-00012610: 5f75 7020 3d20 2861 6c6c 280a 2020 2020  _up = (all(.    
-00012620: 2020 2020 7374 6174 7573 203d 3d20 7374      status == st
-00012630: 6174 7573 5f6c 6962 2e43 6c75 7374 6572  atus_lib.Cluster
-00012640: 5374 6174 7573 2e55 5020 666f 7220 7374  Status.UP for st
-00012650: 6174 7573 2069 6e20 6e6f 6465 5f73 7461  atus in node_sta
-00012660: 7475 7365 7329 2061 6e64 0a20 2020 2020  tuses) and.     
-00012670: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00012680: 656e 286e 6f64 655f 7374 6174 7573 6573  en(node_statuses
-00012690: 2920 3d3d 2068 616e 646c 652e 6c61 756e  ) == handle.laun
-000126a0: 6368 6564 5f6e 6f64 6573 290a 0a20 2020  ched_nodes)..   
-000126b0: 2064 6566 2072 756e 5f72 6179 5f73 7461   def run_ray_sta
-000126c0: 7475 735f 746f 5f63 6865 636b 5f72 6179  tus_to_check_ray
-000126d0: 5f63 6c75 7374 6572 5f68 6561 6c74 6879  _cluster_healthy
-000126e0: 2829 202d 3e20 626f 6f6c 3a0a 2020 2020  () -> bool:.    
-000126f0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00012700: 2020 2020 2023 2054 4f44 4f28 7a68 7775       # TODO(zhwu
-00012710: 293a 2054 6869 7320 6675 6e63 7469 6f6e  ): This function
-00012720: 2063 616e 6e6f 7420 6469 7374 696e 6775   cannot distingu
-00012730: 6973 6820 7472 616e 7369 656e 7420 6e65  ish transient ne
-00012740: 7477 6f72 6b0a 2020 2020 2020 2020 2020  twork.          
-00012750: 2020 2320 6572 726f 7220 696e 2072 6179    # error in ray
-00012760: 2773 2067 6574 2049 5073 2076 732e 2072  's get IPs vs. r
-00012770: 6179 2072 756e 7469 6d65 2066 6169 6c69  ay runtime faili
-00012780: 6e67 2e0a 0a20 2020 2020 2020 2020 2020  ng...           
-00012790: 2023 204e 4f54 453a 2066 6574 6368 696e   # NOTE: fetchin
-000127a0: 6720 7468 6520 4950 7320 6973 2076 6572  g the IPs is ver
-000127b0: 7920 736c 6f77 2061 7320 6974 2063 616c  y slow as it cal
-000127c0: 6c73 2069 6e74 6f0a 2020 2020 2020 2020  ls into.        
-000127d0: 2020 2020 2320 6072 6179 2067 6574 2068      # `ray get h
-000127e0: 6561 642d 6970 2f77 6f72 6b65 722d 6970  ead-ip/worker-ip
-000127f0: 7360 2e20 5573 696e 6720 6361 6368 6564  s`. Using cached
-00012800: 2049 5073 2069 7320 7361 6665 2062 6563   IPs is safe bec
-00012810: 6175 7365 0a20 2020 2020 2020 2020 2020  ause.           
-00012820: 2023 2069 6e20 7468 6520 776f 7273 7420   # in the worst 
-00012830: 6361 7365 2077 6520 7469 6d65 206f 7574  case we time out
-00012840: 2069 6e20 7468 6520 6072 6179 2073 7461   in the `ray sta
-00012850: 7475 7360 2053 5348 2063 6f6d 6d61 6e64  tus` SSH command
-00012860: 0a20 2020 2020 2020 2020 2020 2023 2062  .            # b
-00012870: 656c 6f77 2e0a 2020 2020 2020 2020 2020  elow..          
-00012880: 2020 6578 7465 726e 616c 5f69 7073 203d    external_ips =
-00012890: 2068 616e 646c 652e 6361 6368 6564 5f65   handle.cached_e
-000128a0: 7874 6572 6e61 6c5f 6970 730a 2020 2020  xternal_ips.    
-000128b0: 2020 2020 2020 2020 2320 5468 6973 2068          # This h
-000128c0: 6170 7065 6e73 2077 6865 6e20 7573 6572  appens when user
-000128d0: 2069 6e74 6572 7275 7074 2074 6865 2060   interrupt the `
-000128e0: 736b 7920 6c61 756e 6368 6020 7072 6f63  sky launch` proc
-000128f0: 6573 7320 6265 666f 7265 0a20 2020 2020  ess before.     
-00012900: 2020 2020 2020 2023 2074 6865 2066 6972         # the fir
-00012910: 7374 2074 696d 6520 7265 736f 7572 6365  st time resource
-00012920: 7320 6861 6e64 6c65 2069 7320 7772 6974  s handle is writ
-00012930: 7465 6e20 6261 636b 2074 6f20 6c6f 6361  ten back to loca
-00012940: 6c20 6461 7461 6261 7365 2e0a 2020 2020  l database..    
-00012950: 2020 2020 2020 2020 2320 5468 6973 2069          # This i
-00012960: 7320 6865 6c70 6675 6c20 7768 656e 2075  s helpful when u
-00012970: 7365 7220 696e 7465 7272 7570 7420 6166  ser interrupt af
-00012980: 7465 7220 7468 6520 7072 6f76 6973 696f  ter the provisio
-00012990: 6e20 6973 2064 6f6e 650a 2020 2020 2020  n is done.      
-000129a0: 2020 2020 2020 2320 616e 6420 6265 666f        # and befo
-000129b0: 7265 2074 6865 2073 6b79 6c65 7420 6973  re the skylet is
-000129c0: 2072 6573 7461 7274 6564 2e20 4166 7465   restarted. Afte
-000129d0: 7220 2332 3330 3420 6973 206d 6572 6765  r #2304 is merge
-000129e0: 642c 2074 6869 730a 2020 2020 2020 2020  d, this.        
-000129f0: 2020 2020 2320 6865 6c70 7320 6b65 6570      # helps keep
-00012a00: 2074 6865 2063 6c75 7374 6572 2073 7461   the cluster sta
-00012a10: 7475 7320 746f 2049 4e49 5420 6166 7465  tus to INIT afte
-00012a20: 7220 6073 6b79 2073 7461 7475 7320 2d72  r `sky status -r
-00012a30: 602c 2073 6f0a 2020 2020 2020 2020 2020  `, so.          
-00012a40: 2020 2320 7573 6572 2077 696c 6c20 6265    # user will be
-00012a50: 206e 6f74 6966 6965 6420 7468 6174 2061   notified that a
-00012a60: 6e79 2061 7574 6f20 7374 6f70 2f64 6f77  ny auto stop/dow
-00012a70: 6e20 6d69 6768 7420 6e6f 7420 6265 0a20  n might not be. 
-00012a80: 2020 2020 2020 2020 2020 2023 2074 7269             # tri
-00012a90: 6767 6572 6564 2e0a 2020 2020 2020 2020  ggered..        
-00012aa0: 2020 2020 6966 2065 7874 6572 6e61 6c5f      if external_
-00012ab0: 6970 7320 6973 204e 6f6e 6520 6f72 206c  ips is None or l
-00012ac0: 656e 2865 7874 6572 6e61 6c5f 6970 7329  en(external_ips)
-00012ad0: 203d 3d20 303a 0a20 2020 2020 2020 2020   == 0:.         
-00012ae0: 2020 2020 2020 206c 6f67 6765 722e 6465         logger.de
-00012af0: 6275 6728 6627 5265 6672 6573 6869 6e67  bug(f'Refreshing
-00012b00: 2073 7461 7475 7320 287b 636c 7573 7465   status ({cluste
-00012b10: 725f 6e61 6d65 2172 7d29 3a20 4e6f 2063  r_name!r}): No c
-00012b20: 6163 6865 6420 270a 2020 2020 2020 2020  ached '.        
-00012b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012b40: 2020 2020 2066 2749 5073 2066 6f75 6e64       f'IPs found
-00012b50: 2e20 4861 6e64 6c65 3a20 7b68 616e 646c  . Handle: {handl
-00012b60: 657d 2729 0a20 2020 2020 2020 2020 2020  e}').           
-00012b70: 2020 2020 2072 6169 7365 2065 7863 6570       raise excep
-00012b80: 7469 6f6e 732e 4665 7463 6849 5045 7272  tions.FetchIPErr
-00012b90: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-00012ba0: 2020 2020 2020 2020 7265 6173 6f6e 3d65          reason=e
-00012bb0: 7863 6570 7469 6f6e 732e 4665 7463 6849  xceptions.FetchI
-00012bc0: 5045 7272 6f72 2e52 6561 736f 6e2e 4845  PError.Reason.HE
-00012bd0: 4144 290a 0a20 2020 2020 2020 2020 2020  AD)..           
-00012be0: 2023 2050 6f74 656e 7469 616c 6c79 2072   # Potentially r
-00012bf0: 6566 7265 7368 2074 6865 2065 7874 6572  efresh the exter
-00012c00: 6e61 6c20 5353 4820 706f 7274 732c 2069  nal SSH ports, i
-00012c10: 6e20 6361 7365 2074 6865 2065 7869 7374  n case the exist
-00012c20: 696e 670a 2020 2020 2020 2020 2020 2020  ing.            
-00012c30: 2320 636c 7573 7465 7220 6265 666f 7265  # cluster before
-00012c40: 2023 3234 3931 2077 6173 206c 6175 6e63   #2491 was launc
-00012c50: 6865 6420 7769 7468 6f75 7420 6578 7465  hed without exte
-00012c60: 726e 616c 2053 5348 2070 6f72 7473 0a20  rnal SSH ports. 
-00012c70: 2020 2020 2020 2020 2020 2023 2063 6163             # cac
-00012c80: 6865 642e 0a20 2020 2020 2020 2020 2020  hed..           
-00012c90: 2065 7874 6572 6e61 6c5f 7373 685f 706f   external_ssh_po
-00012ca0: 7274 7320 3d20 6861 6e64 6c65 2e65 7874  rts = handle.ext
-00012cb0: 6572 6e61 6c5f 7373 685f 706f 7274 7328  ernal_ssh_ports(
-00012cc0: 290a 2020 2020 2020 2020 2020 2020 6865  ).            he
-00012cd0: 6164 5f73 7368 5f70 6f72 7420 3d20 6578  ad_ssh_port = ex
-00012ce0: 7465 726e 616c 5f73 7368 5f70 6f72 7473  ternal_ssh_ports
-00012cf0: 5b30 5d0a 0a20 2020 2020 2020 2020 2020  [0]..           
-00012d00: 2023 2043 6865 636b 2069 6620 7261 7920   # Check if ray 
-00012d10: 636c 7573 7465 7220 7374 6174 7573 2069  cluster status i
-00012d20: 7320 6865 616c 7468 792e 0a20 2020 2020  s healthy..     
-00012d30: 2020 2020 2020 2073 7368 5f63 7265 6465         ssh_crede
-00012d40: 6e74 6961 6c73 203d 2073 7368 5f63 7265  ntials = ssh_cre
-00012d50: 6465 6e74 6961 6c5f 6672 6f6d 5f79 616d  dential_from_yam
-00012d60: 6c28 6861 6e64 6c65 2e63 6c75 7374 6572  l(handle.cluster
-00012d70: 5f79 616d 6c2c 0a20 2020 2020 2020 2020  _yaml,.         
-00012d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012da0: 2020 2020 2020 2020 2020 2020 2020 6861                ha
-00012db0: 6e64 6c65 2e64 6f63 6b65 725f 7573 6572  ndle.docker_user
-00012dc0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00012dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012df0: 2020 2020 2020 2020 2068 616e 646c 652e           handle.
-00012e00: 7373 685f 7573 6572 290a 0a20 2020 2020  ssh_user)..     
-00012e10: 2020 2020 2020 2072 756e 6e65 7220 3d20         runner = 
-00012e20: 636f 6d6d 616e 645f 7275 6e6e 6572 2e53  command_runner.S
-00012e30: 5348 436f 6d6d 616e 6452 756e 6e65 7228  SHCommandRunner(
-00012e40: 6578 7465 726e 616c 5f69 7073 5b30 5d2c  external_ips[0],
-00012e50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012e80: 2020 2020 2020 2a2a 7373 685f 6372 6564        **ssh_cred
-00012e90: 656e 7469 616c 732c 0a20 2020 2020 2020  entials,.       
-00012ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012ec0: 2020 2020 2020 2020 2020 2020 2020 706f                po
-00012ed0: 7274 3d68 6561 645f 7373 685f 706f 7274  rt=head_ssh_port
-00012ee0: 290a 2020 2020 2020 2020 2020 2020 7263  ).            rc
-00012ef0: 2c20 6f75 7470 7574 2c20 7374 6465 7272  , output, stderr
-00012f00: 203d 2072 756e 6e65 722e 7275 6e28 0a20   = runner.run(. 
-00012f10: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00012f20: 6e73 7461 6e63 655f 7365 7475 702e 5241  nstance_setup.RA
-00012f30: 595f 5354 4154 5553 5f57 4954 485f 534b  Y_STATUS_WITH_SK
-00012f40: 595f 5241 595f 504f 5254 5f43 4f4d 4d41  Y_RAY_PORT_COMMA
-00012f50: 4e44 2c0a 2020 2020 2020 2020 2020 2020  ND,.            
-00012f60: 2020 2020 7374 7265 616d 5f6c 6f67 733d      stream_logs=
-00012f70: 4661 6c73 652c 0a20 2020 2020 2020 2020  False,.         
-00012f80: 2020 2020 2020 2072 6571 7569 7265 5f6f         require_o
-00012f90: 7574 7075 7473 3d54 7275 652c 0a20 2020  utputs=True,.   
-00012fa0: 2020 2020 2020 2020 2020 2020 2073 6570               sep
-00012fb0: 6172 6174 655f 7374 6465 7272 3d54 7275  arate_stderr=Tru
-00012fc0: 6529 0a20 2020 2020 2020 2020 2020 2069  e).            i
-00012fd0: 6620 7263 3a0a 2020 2020 2020 2020 2020  f rc:.          
-00012fe0: 2020 2020 2020 7261 6973 6520 5275 6e74        raise Runt
-00012ff0: 696d 6545 7272 6f72 280a 2020 2020 2020  imeError(.      
-00013000: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-00013010: 5265 6672 6573 6869 6e67 2073 7461 7475  Refreshing statu
-00013020: 7320 287b 636c 7573 7465 725f 6e61 6d65  s ({cluster_name
-00013030: 2172 7d29 3a20 4661 696c 6564 2074 6f20  !r}): Failed to 
-00013040: 6368 6563 6b20 270a 2020 2020 2020 2020  check '.        
-00013050: 2020 2020 2020 2020 2020 2020 6627 7261              f'ra
-00013060: 7920 636c 7573 7465 725c 2773 2068 6561  y cluster\'s hea
-00013070: 6c74 6869 6e65 7373 2077 6974 6820 270a  lthiness with '.
-00013080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013090: 2020 2020 6627 7b69 6e73 7461 6e63 655f      f'{instance_
-000130a0: 7365 7475 702e 5241 595f 5354 4154 5553  setup.RAY_STATUS
-000130b0: 5f57 4954 485f 534b 595f 5241 595f 504f  _WITH_SKY_RAY_PO
-000130c0: 5254 5f43 4f4d 4d41 4e44 7d2e 5c6e 270a  RT_COMMAND}.\n'.
-000130d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000130e0: 2020 2020 6627 2d2d 2073 7464 6f75 7420      f'-- stdout 
-000130f0: 2d2d 5c6e 7b6f 7574 7075 747d 5c6e 2d2d  --\n{output}\n--
-00013100: 2073 7464 6572 7220 2d2d 5c6e 7b73 7464   stderr --\n{std
-00013110: 6572 727d 2729 0a0a 2020 2020 2020 2020  err}')..        
-00013120: 2020 2020 7265 6164 795f 6865 6164 2c20      ready_head, 
-00013130: 7265 6164 795f 776f 726b 6572 7320 3d20  ready_workers = 
-00013140: 5f63 6f75 6e74 5f68 6561 6c74 6879 5f6e  _count_healthy_n
-00013150: 6f64 6573 5f66 726f 6d5f 7261 7928 6f75  odes_from_ray(ou
-00013160: 7470 7574 290a 2020 2020 2020 2020 2020  tput).          
-00013170: 2020 746f 7461 6c5f 6e6f 6465 7320 3d20    total_nodes = 
-00013180: 6861 6e64 6c65 2e6c 6175 6e63 6865 645f  handle.launched_
-00013190: 6e6f 6465 7320 2a20 6861 6e64 6c65 2e6e  nodes * handle.n
-000131a0: 756d 5f69 7073 5f70 6572 5f6e 6f64 650a  um_ips_per_node.
-000131b0: 2020 2020 2020 2020 2020 2020 6966 2072              if r
-000131c0: 6561 6479 5f68 6561 6420 2b20 7265 6164  eady_head + read
-000131d0: 795f 776f 726b 6572 7320 3d3d 2074 6f74  y_workers == tot
-000131e0: 616c 5f6e 6f64 6573 3a0a 2020 2020 2020  al_nodes:.      
-000131f0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00013200: 2054 7275 650a 2020 2020 2020 2020 2020   True.          
-00013210: 2020 7261 6973 6520 5275 6e74 696d 6545    raise RuntimeE
-00013220: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-00013230: 2020 2020 2020 6627 5265 6672 6573 6869        f'Refreshi
-00013240: 6e67 2073 7461 7475 7320 287b 636c 7573  ng status ({clus
-00013250: 7465 725f 6e61 6d65 2172 7d29 3a20 7261  ter_name!r}): ra
-00013260: 7920 7374 6174 7573 206e 6f74 2073 686f  y status not sho
-00013270: 7769 6e67 2027 0a20 2020 2020 2020 2020  wing '.         
-00013280: 2020 2020 2020 2066 2761 6c6c 206e 6f64         f'all nod
-00013290: 6573 2028 7b72 6561 6479 5f68 6561 6420  es ({ready_head 
-000132a0: 2b20 7265 6164 795f 776f 726b 6572 737d  + ready_workers}
-000132b0: 2f27 0a20 2020 2020 2020 2020 2020 2020  /'.             
-000132c0: 2020 2066 277b 746f 7461 6c5f 6e6f 6465     f'{total_node
-000132d0: 737d 293b 206f 7574 7075 743a 207b 6f75  s}); output: {ou
-000132e0: 7470 7574 7d3b 2073 7464 6572 723a 207b  tput}; stderr: {
-000132f0: 7374 6465 7272 7d27 290a 2020 2020 2020  stderr}').      
-00013300: 2020 6578 6365 7074 2065 7863 6570 7469    except excepti
-00013310: 6f6e 732e 4665 7463 6849 5045 7272 6f72  ons.FetchIPError
-00013320: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
-00013330: 6767 6572 2e64 6562 7567 280a 2020 2020  gger.debug(.    
-00013340: 2020 2020 2020 2020 2020 2020 6627 5265              f'Re
-00013350: 6672 6573 6869 6e67 2073 7461 7475 7320  freshing status 
-00013360: 287b 636c 7573 7465 725f 6e61 6d65 2172  ({cluster_name!r
-00013370: 7d29 2066 6169 6c65 6420 746f 2067 6574  }) failed to get
-00013380: 2049 5073 2e27 290a 2020 2020 2020 2020   IPs.').        
-00013390: 6578 6365 7074 2052 756e 7469 6d65 4572  except RuntimeEr
-000133a0: 726f 7220 6173 2065 3a0a 2020 2020 2020  ror as e:.      
-000133b0: 2020 2020 2020 6c6f 6767 6572 2e64 6562        logger.deb
-000133c0: 7567 2873 7472 2865 2929 0a20 2020 2020  ug(str(e)).     
-000133d0: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
-000133e0: 696f 6e20 6173 2065 3a20 2023 2070 796c  ion as e:  # pyl
-000133f0: 696e 743a 2064 6973 6162 6c65 3d62 726f  int: disable=bro
-00013400: 6164 2d65 7863 6570 740a 2020 2020 2020  ad-except.      
-00013410: 2020 2020 2020 2320 5468 6973 2063 616e        # This can
-00013420: 2062 6520 7261 6973 6564 2062 7920 6065   be raised by `e
-00013430: 7874 6572 6e61 6c5f 7373 685f 706f 7274  xternal_ssh_port
-00013440: 7328 2960 2c20 6475 6520 746f 2074 6865  s()`, due to the
-00013450: 0a20 2020 2020 2020 2020 2020 2023 2075  .            # u
-00013460: 6e64 6572 6c79 696e 6720 6361 6c6c 2074  nderlying call t
-00013470: 6f20 6b75 6265 726e 6574 6573 2041 5049  o kubernetes API
-00013480: 2e0a 2020 2020 2020 2020 2020 2020 6c6f  ..            lo
-00013490: 6767 6572 2e64 6562 7567 280a 2020 2020  gger.debug(.    
-000134a0: 2020 2020 2020 2020 2020 2020 6627 5265              f'Re
-000134b0: 6672 6573 6869 6e67 2073 7461 7475 7320  freshing status 
-000134c0: 287b 636c 7573 7465 725f 6e61 6d65 2172  ({cluster_name!r
-000134d0: 7d29 2066 6169 6c65 643a 2027 0a20 2020  }) failed: '.   
-000134e0: 2020 2020 2020 2020 2020 2020 2066 277b               f'{
-000134f0: 636f 6d6d 6f6e 5f75 7469 6c73 2e66 6f72  common_utils.for
-00013500: 6d61 745f 6578 6365 7074 696f 6e28 652c  mat_exception(e,
-00013510: 2075 7365 5f62 7261 636b 6574 3d54 7275   use_bracket=Tru
-00013520: 6529 7d27 290a 2020 2020 2020 2020 7265  e)}').        re
-00013530: 7475 726e 2046 616c 7365 0a0a 2020 2020  turn False..    
-00013540: 2320 4465 7465 726d 696e 696e 6720 6966  # Determining if
-00013550: 2074 6865 2063 6c75 7374 6572 2069 7320   the cluster is 
-00013560: 6865 616c 7468 7920 2855 5029 3a0a 2020  healthy (UP):.  
-00013570: 2020 230a 2020 2020 2320 466f 7220 6e6f    #.    # For no
-00013580: 6e2d 7370 6f74 2063 6c75 7374 6572 733a  n-spot clusters:
-00013590: 2049 6620 7261 7920 7374 6174 7573 2073   If ray status s
-000135a0: 686f 7773 2061 6c6c 206e 6f64 6573 2061  hows all nodes a
-000135b0: 7265 2068 6561 6c74 6879 2c20 6974 2069  re healthy, it i
-000135c0: 730a 2020 2020 2320 7361 6665 2074 6f20  s.    # safe to 
-000135d0: 7365 7420 7468 6520 7374 6174 7573 2074  set the status t
-000135e0: 6f20 5550 2061 7320 7374 6172 7469 6e67  o UP as starting
-000135f0: 2072 6179 2069 7320 7468 6520 6669 6e61   ray is the fina
-00013600: 6c20 7374 6570 206f 6620 736b 790a 2020  l step of sky.  
-00013610: 2020 2320 6c61 756e 6368 2e20 4275 7420    # launch. But 
-00013620: 7765 2066 6f75 6e64 2074 6861 7420 7261  we found that ra
-00013630: 7920 7374 6174 7573 2069 7320 7761 7920  y status is way 
-00013640: 746f 6f20 736c 6f77 2028 7365 6520 4e4f  too slow (see NO
-00013650: 5445 2062 656c 6f77 2920 736f 0a20 2020  TE below) so.   
-00013660: 2023 2077 6520 616c 7761 7973 2071 7565   # we always que
-00013670: 7279 2074 6865 2063 6c6f 7564 2070 726f  ry the cloud pro
-00013680: 7669 6465 7220 6669 7273 7420 7768 6963  vider first whic
-00013690: 6820 6973 2066 6173 7465 722e 0a20 2020  h is faster..   
-000136a0: 2023 0a20 2020 2023 2046 6f72 2073 706f   #.    # For spo
-000136b0: 7420 636c 7573 7465 7273 3a20 7468 6520  t clusters: the 
-000136c0: 6162 6f76 6520 6361 6e20 6265 2075 6e73  above can be uns
-000136d0: 6166 6520 6265 6361 7573 6520 7468 6520  afe because the 
-000136e0: 5261 7920 636c 7573 7465 7220 6d61 790a  Ray cluster may.
-000136f0: 2020 2020 2320 7265 6d61 696e 2068 6561      # remain hea
-00013700: 6c74 6879 2066 6f72 2061 2077 6869 6c65  lthy for a while
-00013710: 2062 6566 6f72 6520 7468 6520 636c 6f75   before the clou
-00013720: 6420 636f 6d70 6c65 7465 6c79 2070 7265  d completely pre
-00013730: 656d 7074 7320 7468 6520 564d 732e 0a20  empts the VMs.. 
-00013740: 2020 2023 2057 6520 6861 7665 206d 6974     # We have mit
-00013750: 6967 6174 6564 2074 6869 7320 6279 2061  igated this by a
-00013760: 6761 696e 2066 6972 7374 2071 7565 7279  gain first query
-00013770: 696e 6720 7468 6520 564d 2073 7461 7465  ing the VM state
-00013780: 2066 726f 6d20 7468 6520 636c 6f75 640a   from the cloud.
-00013790: 2020 2020 2320 7072 6f76 6964 6572 2e0a      # provider..
-000137a0: 2020 2020 6966 2061 6c6c 5f6e 6f64 6573      if all_nodes
-000137b0: 5f75 7020 616e 6420 7275 6e5f 7261 795f  _up and run_ray_
-000137c0: 7374 6174 7573 5f74 6f5f 6368 6563 6b5f  status_to_check_
-000137d0: 7261 795f 636c 7573 7465 725f 6865 616c  ray_cluster_heal
-000137e0: 7468 7928 293a 0a20 2020 2020 2020 2023  thy():.        #
-000137f0: 204e 4f54 453a 2061 6c6c 5f6e 6f64 6573   NOTE: all_nodes
-00013800: 5f75 7020 6361 6c63 756c 6174 696f 6e20  _up calculation 
-00013810: 6973 2066 6173 7420 6475 6520 746f 2063  is fast due to c
-00013820: 616c 6c69 6e67 2063 6c6f 7564 2043 4c49  alling cloud CLI
-00013830: 3b0a 2020 2020 2020 2020 2320 7275 6e5f  ;.        # run_
-00013840: 7261 795f 7374 6174 7573 5f74 6f5f 6368  ray_status_to_ch
-00013850: 6563 6b5f 616c 6c5f 6e6f 6465 735f 7570  eck_all_nodes_up
-00013860: 2829 2069 7320 736c 6f77 2064 7565 2074  () is slow due t
-00013870: 6f20 6361 6c6c 696e 6720 6072 6179 2067  o calling `ray g
-00013880: 6574 0a20 2020 2020 2020 2023 2068 6561  et.        # hea
-00013890: 642d 6970 2f77 6f72 6b65 722d 6970 7360  d-ip/worker-ips`
-000138a0: 2e0a 2020 2020 2020 2020 7265 636f 7264  ..        record
-000138b0: 5b27 7374 6174 7573 275d 203d 2073 7461  ['status'] = sta
-000138c0: 7475 735f 6c69 622e 436c 7573 7465 7253  tus_lib.ClusterS
-000138d0: 7461 7475 732e 5550 0a20 2020 2020 2020  tatus.UP.       
-000138e0: 2067 6c6f 6261 6c5f 7573 6572 5f73 7461   global_user_sta
-000138f0: 7465 2e61 6464 5f6f 725f 7570 6461 7465  te.add_or_update
-00013900: 5f63 6c75 7374 6572 2863 6c75 7374 6572  _cluster(cluster
-00013910: 5f6e 616d 652c 0a20 2020 2020 2020 2020  _name,.         
-00013920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013940: 2020 2020 2020 2068 616e 646c 652c 0a20         handle,. 
-00013950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013970: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00013980: 6571 7565 7374 6564 5f72 6573 6f75 7263  equested_resourc
-00013990: 6573 3d4e 6f6e 652c 0a20 2020 2020 2020  es=None,.       
-000139a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000139b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000139c0: 2020 2020 2020 2020 2072 6561 6479 3d54           ready=T
-000139d0: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
-000139e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000139f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013a00: 2020 2020 2069 735f 6c61 756e 6368 3d46       is_launch=F
-00013a10: 616c 7365 290a 2020 2020 2020 2020 7265  alse).        re
-00013a20: 7475 726e 2072 6563 6f72 640a 0a20 2020  turn record..   
-00013a30: 2023 2041 6c6c 2063 6173 6573 2062 656c   # All cases bel
-00013a40: 6f77 2061 7265 2074 7261 6e73 6974 696f  ow are transitio
-00013a50: 6e69 6e67 2074 6865 2063 6c75 7374 6572  ning the cluster
-00013a60: 2074 6f20 6e6f 6e2d 5550 2073 7461 7465   to non-UP state
-00013a70: 732e 0a0a 2020 2020 6966 206c 656e 286e  s...    if len(n
-00013a80: 6f64 655f 7374 6174 7573 6573 2920 3e20  ode_statuses) > 
-00013a90: 6861 6e64 6c65 2e6c 6175 6e63 6865 645f  handle.launched_
-00013aa0: 6e6f 6465 733a 0a20 2020 2020 2020 2023  nodes:.        #
-00013ab0: 2055 6e65 7870 6563 7465 643a 2069 6e20   Unexpected: in 
-00013ac0: 7468 6520 7175 6572 6965 6420 7265 6769  the queried regi
-00013ad0: 6f6e 206d 6f72 6520 7468 616e 2031 2063  on more than 1 c
-00013ae0: 6c75 7374 6572 2077 6974 6820 7468 6520  luster with the 
-00013af0: 7361 6d65 0a20 2020 2020 2020 2023 2063  same.        # c
-00013b00: 6f6e 7374 7275 6374 6564 206e 616d 6520  onstructed name 
-00013b10: 7461 6720 7265 7475 726e 6564 2e20 5468  tag returned. Th
-00013b20: 6973 2077 696c 6c20 7479 7069 6361 6c6c  is will typicall
-00013b30: 7920 6e6f 7420 6861 7070 656e 2075 6e6c  y not happen unl
-00013b40: 6573 730a 2020 2020 2020 2020 2320 7573  ess.        # us
-00013b50: 6572 7320 6d61 6e75 616c 6c79 2063 7265  ers manually cre
-00013b60: 6174 6520 6120 636c 7573 7465 7220 7769  ate a cluster wi
-00013b70: 7468 2074 6861 7420 636f 6e73 7472 7563  th that construc
-00013b80: 7465 6420 6e61 6d65 206f 7220 7468 6572  ted name or ther
-00013b90: 650a 2020 2020 2020 2020 2320 7761 7320  e.        # was 
-00013ba0: 6120 7265 736f 7572 6365 206c 6561 6b20  a resource leak 
-00013bb0: 6361 7573 6564 2062 7920 6469 6666 6572  caused by differ
-00013bc0: 656e 7420 6c61 756e 6368 2068 6173 6820  ent launch hash 
-00013bd0: 6265 666f 7265 2023 3136 3731 0a20 2020  before #1671.   
-00013be0: 2020 2020 2023 2077 6173 206d 6572 6765       # was merge
-00013bf0: 642e 0a20 2020 2020 2020 2023 0a20 2020  d..        #.   
-00013c00: 2020 2020 2023 2028 5465 6368 6e69 6361       # (Technica
-00013c10: 6c6c 7920 7370 6561 6b69 6e67 2c20 6576  lly speaking, ev
-00013c20: 656e 2069 6620 7265 7475 726e 6564 206e  en if returned n
-00013c30: 756d 206e 6f64 6573 203c 3d20 6e75 6d0a  um nodes <= num.
-00013c40: 2020 2020 2020 2020 2320 6861 6e64 6c65          # handle
-00013c50: 2e6c 6175 6e63 6865 645f 6e6f 6465 7329  .launched_nodes)
-00013c60: 2c20 6e6f 7420 696e 636c 7564 696e 6720  , not including 
-00013c70: 7468 6520 6c61 756e 6368 2068 6173 6820  the launch hash 
-00013c80: 636f 756c 6420 6d65 616e 2074 6865 0a20  could mean the. 
-00013c90: 2020 2020 2020 2023 2072 6574 7572 6e65         # returne
-00013ca0: 6420 6e6f 6465 7320 636f 6e74 6169 6e20  d nodes contain 
-00013cb0: 736f 6d65 206e 6f64 6573 2074 6861 7420  some nodes that 
-00013cc0: 646f 206e 6f74 2062 656c 6f6e 6720 746f  do not belong to
-00013cd0: 2074 6865 206c 6f67 6963 616c 0a20 2020   the logical.   
-00013ce0: 2020 2020 2023 2073 6b79 7069 6c6f 7420       # skypilot 
-00013cf0: 636c 7573 7465 722e 2044 6f65 736e 2774  cluster. Doesn't
-00013d00: 2073 6565 6d20 746f 2062 6520 6120 676f   seem to be a go
-00013d10: 6f64 2077 6179 2074 6f20 6861 6e64 6c65  od way to handle
-00013d20: 2074 6869 7320 666f 720a 2020 2020 2020   this for.      
-00013d30: 2020 2320 6e6f 773f 290a 2020 2020 2020    # now?).      
-00013d40: 2020 230a 2020 2020 2020 2020 2320 5765    #.        # We
-00013d50: 2068 6176 6520 6e6f 7420 6578 7065 7269   have not experi
-00013d60: 656e 6365 6420 7468 6520 6162 6f76 653b  enced the above;
-00013d70: 2061 6464 696e 6720 6173 2061 2073 6166   adding as a saf
-00013d80: 6567 7561 7264 2e0a 2020 2020 2020 2020  eguard..        
-00013d90: 230a 2020 2020 2020 2020 2320 5369 6e63  #.        # Sinc
-00013da0: 6520 7765 2066 6169 6c65 6420 746f 2072  e we failed to r
-00013db0: 6566 7265 7368 2c20 7261 6973 6520 7468  efresh, raise th
-00013dc0: 6520 7374 6174 7573 2066 6574 6368 696e  e status fetchin
-00013dd0: 6720 6572 726f 722e 0a20 2020 2020 2020  g error..       
-00013de0: 2077 6974 6820 7578 5f75 7469 6c73 2e70   with ux_utils.p
-00013df0: 7269 6e74 5f65 7863 6570 7469 6f6e 5f6e  rint_exception_n
-00013e00: 6f5f 7472 6163 6562 6163 6b28 293a 0a20  o_traceback():. 
-00013e10: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00013e20: 2065 7863 6570 7469 6f6e 732e 436c 7573   exceptions.Clus
-00013e30: 7465 7253 7461 7475 7346 6574 6368 696e  terStatusFetchin
-00013e40: 6745 7272 6f72 280a 2020 2020 2020 2020  gError(.        
-00013e50: 2020 2020 2020 2020 6627 466f 756e 6420          f'Found 
-00013e60: 7b6c 656e 286e 6f64 655f 7374 6174 7573  {len(node_status
-00013e70: 6573 297d 206e 6f64 6528 7329 2077 6974  es)} node(s) wit
-00013e80: 6820 7468 6520 7361 6d65 2063 6c75 7374  h the same clust
-00013e90: 6572 206e 616d 6527 0a20 2020 2020 2020  er name'.       
-00013ea0: 2020 2020 2020 2020 2066 2720 7461 6720           f' tag 
-00013eb0: 696e 2074 6865 2063 6c6f 7564 2070 726f  in the cloud pro
-00013ec0: 7669 6465 7220 666f 7220 636c 7573 7465  vider for cluste
-00013ed0: 7220 7b63 6c75 7374 6572 5f6e 616d 6521  r {cluster_name!
-00013ee0: 727d 2c20 270a 2020 2020 2020 2020 2020  r}, '.          
-00013ef0: 2020 2020 2020 6627 7768 6963 6820 7368        f'which sh
-00013f00: 6f75 6c64 2068 6176 6520 7b68 616e 646c  ould have {handl
-00013f10: 652e 6c61 756e 6368 6564 5f6e 6f64 6573  e.launched_nodes
-00013f20: 7d20 6e6f 6465 732e 2054 6869 7320 270a  } nodes. This '.
+0000de50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000de60: 2020 2020 2020 7374 6465 7272 3d73 7562        stderr=sub
+0000de70: 7072 6f63 6573 732e 4445 564e 554c 4c2c  process.DEVNULL,
+0000de80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000de90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dea0: 2020 2020 2020 2020 2063 6865 636b 3d46           check=F
+0000deb0: 616c 7365 290a 2020 2020 6973 5f69 6e73  alse).    is_ins
+0000dec0: 7461 6c6c 6564 203d 2069 6e73 7461 6c6c  talled = install
+0000ded0: 6174 696f 6e5f 6368 6563 6b2e 7265 7475  ation_check.retu
+0000dee0: 726e 636f 6465 203d 3d20 300a 2020 2020  rncode == 0.    
+0000def0: 6966 2069 735f 696e 7374 616c 6c65 643a  if is_installed:
+0000df00: 0a20 2020 2020 2020 2065 7865 6375 7469  .        executi
+0000df10: 6f6e 5f63 6865 636b 203d 2073 7562 7072  on_check = subpr
+0000df20: 6f63 6573 732e 7275 6e28 5b27 6e76 6964  ocess.run(['nvid
+0000df30: 6961 2d73 6d69 275d 2c0a 2020 2020 2020  ia-smi'],.      
+0000df40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000df50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000df60: 2020 2073 7464 6f75 743d 7375 6270 726f     stdout=subpro
+0000df70: 6365 7373 2e44 4556 4e55 4c4c 2c0a 2020  cess.DEVNULL,.  
+0000df80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000df90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dfa0: 2020 2020 2020 2073 7464 6572 723d 7375         stderr=su
+0000dfb0: 6270 726f 6365 7373 2e44 4556 4e55 4c4c  bprocess.DEVNULL
+0000dfc0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000dfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dfe0: 2020 2020 2020 2020 2020 2063 6865 636b             check
+0000dff0: 3d46 616c 7365 290a 2020 2020 2020 2020  =False).        
+0000e000: 6973 5f66 756e 6374 696f 6e61 6c20 3d20  is_functional = 
+0000e010: 6578 6563 7574 696f 6e5f 6368 6563 6b2e  execution_check.
+0000e020: 7265 7475 726e 636f 6465 203d 3d20 300a  returncode == 0.
+0000e030: 2020 2020 7265 7475 726e 2069 735f 6675      return is_fu
+0000e040: 6e63 7469 6f6e 616c 0a0a 0a64 6566 2067  nctional...def g
+0000e050: 656e 6572 6174 655f 636c 7573 7465 725f  enerate_cluster_
+0000e060: 6e61 6d65 2829 3a0a 2020 2020 2320 544f  name():.    # TO
+0000e070: 444f 3a20 6368 616e 6765 2074 6869 7320  DO: change this 
+0000e080: 4944 2066 6f72 6d61 7474 696e 6720 746f  ID formatting to
+0000e090: 2073 6f6d 6574 6869 6e67 206d 6f72 6520   something more 
+0000e0a0: 706c 6561 7361 6e74 2e0a 2020 2020 2320  pleasant..    # 
+0000e0b0: 5573 6572 206e 616d 6520 6973 2068 656c  User name is hel
+0000e0c0: 7066 756c 2069 6e20 6e6f 6e2d 6973 6f6c  pful in non-isol
+0000e0d0: 6174 6564 2061 6363 6f75 6e74 732c 2065  ated accounts, e
+0000e0e0: 2e67 2e2c 2047 4350 2c20 417a 7572 652e  .g., GCP, Azure.
+0000e0f0: 0a20 2020 2072 6574 7572 6e20 6627 736b  .    return f'sk
+0000e100: 792d 7b75 7569 642e 7575 6964 3428 292e  y-{uuid.uuid4().
+0000e110: 6865 785b 3a34 5d7d 2d7b 636f 6d6d 6f6e  hex[:4]}-{common
+0000e120: 5f75 7469 6c73 2e67 6574 5f63 6c65 616e  _utils.get_clean
+0000e130: 6564 5f75 7365 726e 616d 6528 297d 270a  ed_username()}'.
+0000e140: 0a0a 6465 6620 5f71 7565 7279 5f68 6561  ..def _query_hea
+0000e150: 645f 6970 5f77 6974 685f 7265 7472 6965  d_ip_with_retrie
+0000e160: 7328 636c 7573 7465 725f 7961 6d6c 3a20  s(cluster_yaml: 
+0000e170: 7374 722c 0a20 2020 2020 2020 2020 2020  str,.           
+0000e180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e190: 2020 2020 206d 6178 5f61 7474 656d 7074       max_attempt
+0000e1a0: 733a 2069 6e74 203d 2031 2920 2d3e 2073  s: int = 1) -> s
+0000e1b0: 7472 3a0a 2020 2020 2222 2252 6574 7572  tr:.    """Retur
+0000e1c0: 6e73 2074 6865 2049 5020 6f66 2074 6865  ns the IP of the
+0000e1d0: 2068 6561 6420 6e6f 6465 2062 7920 7175   head node by qu
+0000e1e0: 6572 7969 6e67 2074 6865 2063 6c6f 7564  erying the cloud
+0000e1f0: 2e0a 0a20 2020 2052 6169 7365 733a 0a20  ...    Raises:. 
+0000e200: 2020 2020 2065 7863 6570 7469 6f6e 732e       exceptions.
+0000e210: 4665 7463 6843 6c75 7374 6572 496e 666f  FetchClusterInfo
+0000e220: 4572 726f 723a 2069 6620 7765 2066 6169  Error: if we fai
+0000e230: 6c65 6420 746f 2067 6574 2074 6865 2068  led to get the h
+0000e240: 6561 6420 4950 2e0a 2020 2020 2222 220a  ead IP..    """.
+0000e250: 2020 2020 6261 636b 6f66 6620 3d20 636f      backoff = co
+0000e260: 6d6d 6f6e 5f75 7469 6c73 2e42 6163 6b6f  mmon_utils.Backo
+0000e270: 6666 2869 6e69 7469 616c 5f62 6163 6b6f  ff(initial_backo
+0000e280: 6666 3d35 2c20 6d61 785f 6261 636b 6f66  ff=5, max_backof
+0000e290: 665f 6661 6374 6f72 3d35 290a 2020 2020  f_factor=5).    
+0000e2a0: 666f 7220 6920 696e 2072 616e 6765 286d  for i in range(m
+0000e2b0: 6178 5f61 7474 656d 7074 7329 3a0a 2020  ax_attempts):.  
+0000e2c0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+0000e2d0: 2020 2020 2020 2066 756c 6c5f 636c 7573         full_clus
+0000e2e0: 7465 725f 7961 6d6c 203d 2073 7472 2870  ter_yaml = str(p
+0000e2f0: 6174 686c 6962 2e50 6174 6828 636c 7573  athlib.Path(clus
+0000e300: 7465 725f 7961 6d6c 292e 6578 7061 6e64  ter_yaml).expand
+0000e310: 7573 6572 2829 290a 2020 2020 2020 2020  user()).        
+0000e320: 2020 2020 6f75 7420 3d20 7375 6270 726f      out = subpro
+0000e330: 6365 7373 5f75 7469 6c73 2e72 756e 280a  cess_utils.run(.
+0000e340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e350: 6627 7261 7920 6765 742d 6865 6164 2d69  f'ray get-head-i
+0000e360: 7020 7b66 756c 6c5f 636c 7573 7465 725f  p {full_cluster_
+0000e370: 7961 6d6c 2172 7d27 2c0a 2020 2020 2020  yaml!r}',.      
+0000e380: 2020 2020 2020 2020 2020 7374 646f 7574            stdout
+0000e390: 3d73 7562 7072 6f63 6573 732e 5049 5045  =subprocess.PIPE
+0000e3a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000e3b0: 2020 7374 6465 7272 3d73 7562 7072 6f63    stderr=subproc
+0000e3c0: 6573 732e 4445 564e 554c 4c29 2e73 7464  ess.DEVNULL).std
+0000e3d0: 6f75 742e 6465 636f 6465 2829 2e73 7472  out.decode().str
+0000e3e0: 6970 2829 0a20 2020 2020 2020 2020 2020  ip().           
+0000e3f0: 2068 6561 645f 6970 5f6c 6973 7420 3d20   head_ip_list = 
+0000e400: 7265 2e66 696e 6461 6c6c 2849 505f 4144  re.findall(IP_AD
+0000e410: 4452 5f52 4547 4558 2c20 6f75 7429 0a20  DR_REGEX, out). 
+0000e420: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
+0000e430: 6e28 6865 6164 5f69 705f 6c69 7374 2920  n(head_ip_list) 
+0000e440: 3e20 313a 0a20 2020 2020 2020 2020 2020  > 1:.           
+0000e450: 2020 2020 2023 2054 6869 7320 636f 756c       # This coul
+0000e460: 6420 6265 2074 7269 6767 6572 6564 2069  d be triggered i
+0000e470: 6620 652e 672e 2c20 736f 6d65 206c 6f67  f e.g., some log
+0000e480: 6769 6e67 2069 7320 6164 6465 6420 696e  ging is added in
+0000e490: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e4a0: 2023 2073 6b79 7069 6c6f 745f 636f 6e66   # skypilot_conf
+0000e4b0: 6967 2c20 6120 6d6f 6475 6c65 2074 6861  ig, a module tha
+0000e4c0: 7420 6861 7320 736f 6d65 2063 6f64 6520  t has some code 
+0000e4d0: 6578 6563 7574 6564 0a20 2020 2020 2020  executed.       
+0000e4e0: 2020 2020 2020 2020 2023 2077 6865 6e65           # whene
+0000e4f0: 7665 7220 6073 6b79 6020 6973 2069 6d70  ver `sky` is imp
+0000e500: 6f72 7465 642e 0a20 2020 2020 2020 2020  orted..         
+0000e510: 2020 2020 2020 206c 6f67 6765 722e 7761         logger.wa
+0000e520: 726e 696e 6728 0a20 2020 2020 2020 2020  rning(.         
+0000e530: 2020 2020 2020 2020 2020 2027 4465 7465             'Dete
+0000e540: 6374 6564 206d 6f72 6520 7468 616e 2031  cted more than 1
+0000e550: 2049 5020 6672 6f6d 2074 6865 206f 7574   IP from the out
+0000e560: 7075 7420 6f66 2027 0a20 2020 2020 2020  put of '.       
+0000e570: 2020 2020 2020 2020 2020 2020 2027 7468               'th
+0000e580: 6520 6072 6179 2067 6574 2d68 6561 642d  e `ray get-head-
+0000e590: 6970 6020 636f 6d6d 616e 642e 2054 6869  ip` command. Thi
+0000e5a0: 7320 636f 756c 6420 270a 2020 2020 2020  s could '.      
+0000e5b0: 2020 2020 2020 2020 2020 2020 2020 2768                'h
+0000e5c0: 6170 7065 6e20 6966 2074 6865 7265 2069  appen if there i
+0000e5d0: 7320 6578 7472 6120 6f75 7470 7574 2066  s extra output f
+0000e5e0: 726f 6d20 6974 2c20 270a 2020 2020 2020  rom it, '.      
+0000e5f0: 2020 2020 2020 2020 2020 2020 2020 2777                'w
+0000e600: 6869 6368 2073 686f 756c 6420 6265 2069  hich should be i
+0000e610: 6e73 7065 6374 6564 2062 656c 6f77 2e5c  nspected below.\
+0000e620: 6e50 726f 6365 6564 696e 6720 7769 7468  nProceeding with
+0000e630: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+0000e640: 2020 2020 2020 2066 2774 6865 206c 6173         f'the las
+0000e650: 7420 6465 7465 6374 6564 2049 5020 287b  t detected IP ({
+0000e660: 6865 6164 5f69 705f 6c69 7374 5b2d 315d  head_ip_list[-1]
+0000e670: 7d29 2061 7320 6865 6164 2049 502e 270a  }) as head IP.'.
+0000e680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e690: 2020 2020 6627 5c6e 3d3d 204f 7574 7075      f'\n== Outpu
+0000e6a0: 7420 3d3d 5c6e 7b6f 7574 7d27 0a20 2020  t ==\n{out}'.   
+0000e6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e6c0: 2066 275c 6e3d 3d20 4f75 7470 7574 2065   f'\n== Output e
+0000e6d0: 6e64 7320 3d3d 2729 0a20 2020 2020 2020  nds ==').       
+0000e6e0: 2020 2020 2020 2020 2068 6561 645f 6970           head_ip
+0000e6f0: 5f6c 6973 7420 3d20 6865 6164 5f69 705f  _list = head_ip_
+0000e700: 6c69 7374 5b2d 313a 5d0a 2020 2020 2020  list[-1:].      
+0000e710: 2020 2020 2020 6173 7365 7274 2031 203d        assert 1 =
+0000e720: 3d20 6c65 6e28 6865 6164 5f69 705f 6c69  = len(head_ip_li
+0000e730: 7374 292c 2028 6f75 742c 2068 6561 645f  st), (out, head_
+0000e740: 6970 5f6c 6973 7429 0a20 2020 2020 2020  ip_list).       
+0000e750: 2020 2020 2068 6561 645f 6970 203d 2068       head_ip = h
+0000e760: 6561 645f 6970 5f6c 6973 745b 305d 0a20  ead_ip_list[0]. 
+0000e770: 2020 2020 2020 2020 2020 2062 7265 616b             break
+0000e780: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+0000e790: 7375 6270 726f 6365 7373 2e43 616c 6c65  subprocess.Calle
+0000e7a0: 6450 726f 6365 7373 4572 726f 7220 6173  dProcessError as
+0000e7b0: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
+0000e7c0: 6966 2069 203d 3d20 6d61 785f 6174 7465  if i == max_atte
+0000e7d0: 6d70 7473 202d 2031 3a0a 2020 2020 2020  mpts - 1:.      
+0000e7e0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0000e7f0: 6578 6365 7074 696f 6e73 2e46 6574 6368  exceptions.Fetch
+0000e800: 436c 7573 7465 7249 6e66 6f45 7272 6f72  ClusterInfoError
+0000e810: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000e820: 2020 2020 2020 7265 6173 6f6e 3d65 7863        reason=exc
+0000e830: 6570 7469 6f6e 732e 4665 7463 6843 6c75  eptions.FetchClu
+0000e840: 7374 6572 496e 666f 4572 726f 722e 5265  sterInfoError.Re
+0000e850: 6173 6f6e 2e48 4541 4429 2066 726f 6d20  ason.HEAD) from 
+0000e860: 650a 2020 2020 2020 2020 2020 2020 2320  e.            # 
+0000e870: 5265 7472 7920 6966 2074 6865 2063 6c75  Retry if the clu
+0000e880: 7374 6572 2069 7320 6e6f 7420 7570 2079  ster is not up y
+0000e890: 6574 2e0a 2020 2020 2020 2020 2020 2020  et..            
+0000e8a0: 6c6f 6767 6572 2e64 6562 7567 2827 5265  logger.debug('Re
+0000e8b0: 7472 7969 6e67 2074 6f20 6765 7420 6865  trying to get he
+0000e8c0: 6164 2069 702e 2729 0a20 2020 2020 2020  ad ip.').       
+0000e8d0: 2020 2020 2074 696d 652e 736c 6565 7028       time.sleep(
+0000e8e0: 6261 636b 6f66 662e 6375 7272 656e 745f  backoff.current_
+0000e8f0: 6261 636b 6f66 6628 2929 0a20 2020 2072  backoff()).    r
+0000e900: 6574 7572 6e20 6865 6164 5f69 700a 0a0a  eturn head_ip...
+0000e910: 4074 696d 656c 696e 652e 6576 656e 740a  @timeline.event.
+0000e920: 6465 6620 6765 745f 6e6f 6465 5f69 7073  def get_node_ips
+0000e930: 2863 6c75 7374 6572 5f79 616d 6c3a 2073  (cluster_yaml: s
+0000e940: 7472 2c0a 2020 2020 2020 2020 2020 2020  tr,.            
+0000e950: 2020 2020 2065 7870 6563 7465 645f 6e75       expected_nu
+0000e960: 6d5f 6e6f 6465 733a 2069 6e74 2c0a 2020  m_nodes: int,.  
+0000e970: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+0000e980: 6561 645f 6970 5f6d 6178 5f61 7474 656d  ead_ip_max_attem
+0000e990: 7074 733a 2069 6e74 203d 2031 2c0a 2020  pts: int = 1,.  
+0000e9a0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+0000e9b0: 6f72 6b65 725f 6970 5f6d 6178 5f61 7474  orker_ip_max_att
+0000e9c0: 656d 7074 733a 2069 6e74 203d 2031 2c0a  empts: int = 1,.
+0000e9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e9e0: 2067 6574 5f69 6e74 6572 6e61 6c5f 6970   get_internal_ip
+0000e9f0: 733a 2062 6f6f 6c20 3d20 4661 6c73 6529  s: bool = False)
+0000ea00: 202d 3e20 4c69 7374 5b73 7472 5d3a 0a20   -> List[str]:. 
+0000ea10: 2020 2022 2222 5265 7475 726e 7320 7468     """Returns th
+0000ea20: 6520 4950 7320 6f66 2061 6c6c 206e 6f64  e IPs of all nod
+0000ea30: 6573 2069 6e20 7468 6520 636c 7573 7465  es in the cluste
+0000ea40: 722c 2077 6974 6820 6865 6164 206e 6f64  r, with head nod
+0000ea50: 6520 6174 2066 726f 6e74 2e0a 0a20 2020  e at front...   
+0000ea60: 2041 7267 733a 0a20 2020 2020 2020 2063   Args:.        c
+0000ea70: 6c75 7374 6572 5f79 616d 6c3a 2050 6174  luster_yaml: Pat
+0000ea80: 6820 746f 2074 6865 2063 6c75 7374 6572  h to the cluster
+0000ea90: 2079 616d 6c2e 0a20 2020 2020 2020 2065   yaml..        e
+0000eaa0: 7870 6563 7465 645f 6e75 6d5f 6e6f 6465  xpected_num_node
+0000eab0: 733a 2045 7870 6563 7465 6420 6e75 6d62  s: Expected numb
+0000eac0: 6572 206f 6620 6e6f 6465 7320 696e 2074  er of nodes in t
+0000ead0: 6865 2063 6c75 7374 6572 2e0a 2020 2020  he cluster..    
+0000eae0: 2020 2020 6865 6164 5f69 705f 6d61 785f      head_ip_max_
+0000eaf0: 6174 7465 6d70 7473 3a20 4d61 7820 6174  attempts: Max at
+0000eb00: 7465 6d70 7473 2074 6f20 6765 7420 6865  tempts to get he
+0000eb10: 6164 2069 702e 0a20 2020 2020 2020 2077  ad ip..        w
+0000eb20: 6f72 6b65 725f 6970 5f6d 6178 5f61 7474  orker_ip_max_att
+0000eb30: 656d 7074 733a 204d 6178 2061 7474 656d  empts: Max attem
+0000eb40: 7074 7320 746f 2067 6574 2077 6f72 6b65  pts to get worke
+0000eb50: 7220 6970 732e 0a20 2020 2020 2020 2067  r ips..        g
+0000eb60: 6574 5f69 6e74 6572 6e61 6c5f 6970 733a  et_internal_ips:
+0000eb70: 2057 6865 7468 6572 2074 6f20 6765 7420   Whether to get 
+0000eb80: 696e 7465 726e 616c 2049 5073 2e20 5768  internal IPs. Wh
+0000eb90: 656e 2046 616c 7365 2c20 6974 2069 7320  en False, it is 
+0000eba0: 7374 696c 6c0a 2020 2020 2020 2020 2020  still.          
+0000ebb0: 2020 706f 7373 6962 6c65 2074 6f20 6765    possible to ge
+0000ebc0: 7420 696e 7465 726e 616c 2049 5073 2069  t internal IPs i
+0000ebd0: 6620 7468 6520 636c 7573 7465 7220 646f  f the cluster do
+0000ebe0: 6573 206e 6f74 2068 6176 6520 6578 7465  es not have exte
+0000ebf0: 726e 616c 0a20 2020 2020 2020 2020 2020  rnal.           
+0000ec00: 2049 5073 2e0a 0a20 2020 2052 6169 7365   IPs...    Raise
+0000ec10: 733a 0a20 2020 2020 2020 2065 7863 6570  s:.        excep
+0000ec20: 7469 6f6e 732e 4665 7463 6843 6c75 7374  tions.FetchClust
+0000ec30: 6572 496e 666f 4572 726f 723a 2069 6620  erInfoError: if 
+0000ec40: 7765 2066 6169 6c65 6420 746f 2067 6574  we failed to get
+0000ec50: 2074 6865 2049 5073 2e20 652e 7265 6173   the IPs. e.reas
+0000ec60: 6f6e 2069 730a 2020 2020 2020 2020 2020  on is.          
+0000ec70: 2020 4845 4144 206f 7220 574f 524b 4552    HEAD or WORKER
+0000ec80: 2e0a 2020 2020 2222 220a 2020 2020 7261  ..    """.    ra
+0000ec90: 795f 636f 6e66 6967 203d 2063 6f6d 6d6f  y_config = commo
+0000eca0: 6e5f 7574 696c 732e 7265 6164 5f79 616d  n_utils.read_yam
+0000ecb0: 6c28 636c 7573 7465 725f 7961 6d6c 290a  l(cluster_yaml).
+0000ecc0: 2020 2020 2320 5573 6520 7468 6520 6e65      # Use the ne
+0000ecd0: 7720 7072 6f76 6973 696f 6e65 7220 666f  w provisioner fo
+0000ece0: 7220 4157 532e 0a20 2020 2070 726f 7669  r AWS..    provi
+0000ecf0: 6465 725f 6e61 6d65 203d 2063 6c75 7374  der_name = clust
+0000ed00: 6572 5f79 616d 6c5f 7574 696c 732e 6765  er_yaml_utils.ge
+0000ed10: 745f 7072 6f76 6964 6572 5f6e 616d 6528  t_provider_name(
+0000ed20: 7261 795f 636f 6e66 6967 290a 2020 2020  ray_config).    
+0000ed30: 636c 6f75 6420 3d20 636c 6f75 645f 7265  cloud = cloud_re
+0000ed40: 6769 7374 7279 2e43 4c4f 5544 5f52 4547  gistry.CLOUD_REG
+0000ed50: 4953 5452 592e 6672 6f6d 5f73 7472 2870  ISTRY.from_str(p
+0000ed60: 726f 7669 6465 725f 6e61 6d65 290a 2020  rovider_name).  
+0000ed70: 2020 6173 7365 7274 2063 6c6f 7564 2069    assert cloud i
+0000ed80: 7320 6e6f 7420 4e6f 6e65 2c20 7072 6f76  s not None, prov
+0000ed90: 6964 6572 5f6e 616d 650a 0a20 2020 2069  ider_name..    i
+0000eda0: 6620 636c 6f75 642e 5052 4f56 4953 494f  f cloud.PROVISIO
+0000edb0: 4e45 525f 5645 5253 494f 4e20 3e3d 2063  NER_VERSION >= c
+0000edc0: 6c6f 7564 732e 5072 6f76 6973 696f 6e65  louds.Provisione
+0000edd0: 7256 6572 7369 6f6e 2e53 4b59 5049 4c4f  rVersion.SKYPILO
+0000ede0: 543a 0a20 2020 2020 2020 2074 7279 3a0a  T:.        try:.
+0000edf0: 2020 2020 2020 2020 2020 2020 6d65 7461              meta
+0000ee00: 6461 7461 203d 2070 726f 7669 7369 6f6e  data = provision
+0000ee10: 5f6c 6962 2e67 6574 5f63 6c75 7374 6572  _lib.get_cluster
+0000ee20: 5f69 6e66 6f28 0a20 2020 2020 2020 2020  _info(.         
+0000ee30: 2020 2020 2020 2070 726f 7669 6465 725f         provider_
+0000ee40: 6e61 6d65 2c20 7261 795f 636f 6e66 6967  name, ray_config
+0000ee50: 5b27 7072 6f76 6964 6572 275d 2e67 6574  ['provider'].get
+0000ee60: 2827 7265 6769 6f6e 2729 2c0a 2020 2020  ('region'),.    
+0000ee70: 2020 2020 2020 2020 2020 2020 7261 795f              ray_
+0000ee80: 636f 6e66 6967 5b27 636c 7573 7465 725f  config['cluster_
+0000ee90: 6e61 6d65 275d 2c20 7261 795f 636f 6e66  name'], ray_conf
+0000eea0: 6967 5b27 7072 6f76 6964 6572 275d 290a  ig['provider']).
+0000eeb0: 2020 2020 2020 2020 6578 6365 7074 2045          except E
+0000eec0: 7863 6570 7469 6f6e 2061 7320 653a 2020  xception as e:  
+0000eed0: 2320 7079 6c69 6e74 3a20 6469 7361 626c  # pylint: disabl
+0000eee0: 653d 6272 6f61 642d 6578 6365 7074 0a20  e=broad-except. 
+0000eef0: 2020 2020 2020 2020 2020 2023 2054 6869             # Thi
+0000ef00: 7320 636f 756c 6420 6861 7070 656e 2077  s could happen w
+0000ef10: 6865 6e20 7468 6520 564d 2069 7320 6e6f  hen the VM is no
+0000ef20: 7420 6675 6c6c 7920 6c61 756e 6368 6564  t fully launched
+0000ef30: 2c20 616e 6420 6120 7573 6572 0a20 2020  , and a user.   
+0000ef40: 2020 2020 2020 2020 2023 2069 7320 7472           # is tr
+0000ef50: 7969 6e67 2074 6f20 7465 726d 696e 6174  ying to terminat
+0000ef60: 6520 6974 2077 6974 6820 6073 6b79 2064  e it with `sky d
+0000ef70: 6f77 6e60 2e0a 2020 2020 2020 2020 2020  own`..          
+0000ef80: 2020 6c6f 6767 6572 2e64 6562 7567 280a    logger.debug(.
+0000ef90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000efa0: 2746 6169 6c65 6420 746f 2067 6574 2063  'Failed to get c
+0000efb0: 6c75 7374 6572 2069 6e66 6f20 666f 7220  luster info for 
+0000efc0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+0000efd0: 2020 6627 7b72 6179 5f63 6f6e 6669 675b    f'{ray_config[
+0000efe0: 2263 6c75 7374 6572 5f6e 616d 6522 5d7d  "cluster_name"]}
+0000eff0: 2066 726f 6d20 7468 6520 6e65 7720 7072   from the new pr
+0000f000: 6f76 6973 696f 6e65 7220 270a 2020 2020  ovisioner '.    
+0000f010: 2020 2020 2020 2020 2020 2020 6627 7769              f'wi
+0000f020: 7468 207b 636f 6d6d 6f6e 5f75 7469 6c73  th {common_utils
+0000f030: 2e66 6f72 6d61 745f 6578 6365 7074 696f  .format_exceptio
+0000f040: 6e28 6529 7d2e 2729 0a20 2020 2020 2020  n(e)}.').       
+0000f050: 2020 2020 2072 6169 7365 2065 7863 6570       raise excep
+0000f060: 7469 6f6e 732e 4665 7463 6843 6c75 7374  tions.FetchClust
+0000f070: 6572 496e 666f 4572 726f 7228 0a20 2020  erInfoError(.   
+0000f080: 2020 2020 2020 2020 2020 2020 2065 7863               exc
+0000f090: 6570 7469 6f6e 732e 4665 7463 6843 6c75  eptions.FetchClu
+0000f0a0: 7374 6572 496e 666f 4572 726f 722e 5265  sterInfoError.Re
+0000f0b0: 6173 6f6e 2e48 4541 4429 2066 726f 6d20  ason.HEAD) from 
+0000f0c0: 650a 2020 2020 2020 2020 6966 206c 656e  e.        if len
+0000f0d0: 286d 6574 6164 6174 612e 696e 7374 616e  (metadata.instan
+0000f0e0: 6365 7329 203c 2065 7870 6563 7465 645f  ces) < expected_
+0000f0f0: 6e75 6d5f 6e6f 6465 733a 0a20 2020 2020  num_nodes:.     
+0000f100: 2020 2020 2020 2023 2053 696d 756c 6174         # Simulat
+0000f110: 6520 7468 6520 6578 6365 7074 696f 6e20  e the exception 
+0000f120: 7768 656e 2052 6179 2068 6561 6420 6e6f  when Ray head no
+0000f130: 6465 2069 7320 6e6f 7420 7570 2e0a 2020  de is not up..  
+0000f140: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0000f150: 6578 6365 7074 696f 6e73 2e46 6574 6368  exceptions.Fetch
+0000f160: 436c 7573 7465 7249 6e66 6f45 7272 6f72  ClusterInfoError
+0000f170: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000f180: 2020 6578 6365 7074 696f 6e73 2e46 6574    exceptions.Fet
+0000f190: 6368 436c 7573 7465 7249 6e66 6f45 7272  chClusterInfoErr
+0000f1a0: 6f72 2e52 6561 736f 6e2e 4845 4144 290a  or.Reason.HEAD).
+0000f1b0: 2020 2020 2020 2020 7265 7475 726e 206d          return m
+0000f1c0: 6574 6164 6174 612e 6765 745f 6665 6173  etadata.get_feas
+0000f1d0: 6962 6c65 5f69 7073 2867 6574 5f69 6e74  ible_ips(get_int
+0000f1e0: 6572 6e61 6c5f 6970 7329 0a0a 2020 2020  ernal_ips)..    
+0000f1f0: 6966 2067 6574 5f69 6e74 6572 6e61 6c5f  if get_internal_
+0000f200: 6970 733a 0a20 2020 2020 2020 2077 6974  ips:.        wit
+0000f210: 6820 7465 6d70 6669 6c65 2e4e 616d 6564  h tempfile.Named
+0000f220: 5465 6d70 6f72 6172 7946 696c 6528 6d6f  TemporaryFile(mo
+0000f230: 6465 3d27 7727 2c20 6465 6c65 7465 3d46  de='w', delete=F
+0000f240: 616c 7365 2920 6173 2066 3a0a 2020 2020  alse) as f:.    
+0000f250: 2020 2020 2020 2020 7261 795f 636f 6e66          ray_conf
+0000f260: 6967 5b27 7072 6f76 6964 6572 275d 5b27  ig['provider']['
+0000f270: 7573 655f 696e 7465 726e 616c 5f69 7073  use_internal_ips
+0000f280: 275d 203d 2054 7275 650a 2020 2020 2020  '] = True.      
+0000f290: 2020 2020 2020 7961 6d6c 2e64 756d 7028        yaml.dump(
+0000f2a0: 7261 795f 636f 6e66 6967 2c20 6629 0a20  ray_config, f). 
+0000f2b0: 2020 2020 2020 2020 2020 2063 6c75 7374             clust
+0000f2c0: 6572 5f79 616d 6c20 3d20 662e 6e61 6d65  er_yaml = f.name
+0000f2d0: 0a0a 2020 2020 2320 4368 6563 6b20 7468  ..    # Check th
+0000f2e0: 6520 6e65 7477 6f72 6b20 636f 6e6e 6563  e network connec
+0000f2f0: 7469 6f6e 2066 6972 7374 2074 6f20 6176  tion first to av
+0000f300: 6f69 6420 6c6f 6e67 2068 616e 6769 6e67  oid long hanging
+0000f310: 2074 696d 6520 666f 720a 2020 2020 2320   time for.    # 
+0000f320: 7261 7920 6765 742d 6865 6164 2d69 7020  ray get-head-ip 
+0000f330: 6265 6c6f 772c 2069 6620 6120 6c6f 6e67  below, if a long
+0000f340: 2d6c 6173 7469 6e67 206e 6574 776f 726b  -lasting network
+0000f350: 2063 6f6e 6e65 6374 696f 6e20 6661 696c   connection fail
+0000f360: 7572 650a 2020 2020 2320 6861 7070 656e  ure.    # happen
+0000f370: 732e 0a20 2020 2063 6865 636b 5f6e 6574  s..    check_net
+0000f380: 776f 726b 5f63 6f6e 6e65 6374 696f 6e28  work_connection(
+0000f390: 290a 2020 2020 6865 6164 5f69 7020 3d20  ).    head_ip = 
+0000f3a0: 5f71 7565 7279 5f68 6561 645f 6970 5f77  _query_head_ip_w
+0000f3b0: 6974 685f 7265 7472 6965 7328 636c 7573  ith_retries(clus
+0000f3c0: 7465 725f 7961 6d6c 2c0a 2020 2020 2020  ter_yaml,.      
+0000f3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f3f0: 2020 2020 6d61 785f 6174 7465 6d70 7473      max_attempts
+0000f400: 3d68 6561 645f 6970 5f6d 6178 5f61 7474  =head_ip_max_att
+0000f410: 656d 7074 7329 0a20 2020 2068 6561 645f  empts).    head_
+0000f420: 6970 5f6c 6973 7420 3d20 5b68 6561 645f  ip_list = [head_
+0000f430: 6970 5d0a 2020 2020 6966 2065 7870 6563  ip].    if expec
+0000f440: 7465 645f 6e75 6d5f 6e6f 6465 7320 3e20  ted_num_nodes > 
+0000f450: 313a 0a20 2020 2020 2020 2062 6163 6b6f  1:.        backo
+0000f460: 6666 203d 2063 6f6d 6d6f 6e5f 7574 696c  ff = common_util
+0000f470: 732e 4261 636b 6f66 6628 696e 6974 6961  s.Backoff(initia
+0000f480: 6c5f 6261 636b 6f66 663d 352c 206d 6178  l_backoff=5, max
+0000f490: 5f62 6163 6b6f 6666 5f66 6163 746f 723d  _backoff_factor=
+0000f4a0: 3529 0a0a 2020 2020 2020 2020 666f 7220  5)..        for 
+0000f4b0: 7265 7472 795f 636e 7420 696e 2072 616e  retry_cnt in ran
+0000f4c0: 6765 2877 6f72 6b65 725f 6970 5f6d 6178  ge(worker_ip_max
+0000f4d0: 5f61 7474 656d 7074 7329 3a0a 2020 2020  _attempts):.    
+0000f4e0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+0000f4f0: 2020 2020 2020 2020 2020 2020 2066 756c               ful
+0000f500: 6c5f 636c 7573 7465 725f 7961 6d6c 203d  l_cluster_yaml =
+0000f510: 2073 7472 2870 6174 686c 6962 2e50 6174   str(pathlib.Pat
+0000f520: 6828 636c 7573 7465 725f 7961 6d6c 292e  h(cluster_yaml).
+0000f530: 6578 7061 6e64 7573 6572 2829 290a 2020  expanduser()).  
+0000f540: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+0000f550: 6f63 203d 2073 7562 7072 6f63 6573 735f  oc = subprocess_
+0000f560: 7574 696c 732e 7275 6e28 0a20 2020 2020  utils.run(.     
+0000f570: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000f580: 2772 6179 2067 6574 2d77 6f72 6b65 722d  'ray get-worker-
+0000f590: 6970 7320 7b66 756c 6c5f 636c 7573 7465  ips {full_cluste
+0000f5a0: 725f 7961 6d6c 2172 7d27 2c0a 2020 2020  r_yaml!r}',.    
+0000f5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f5c0: 7374 646f 7574 3d73 7562 7072 6f63 6573  stdout=subproces
+0000f5d0: 732e 5049 5045 2c0a 2020 2020 2020 2020  s.PIPE,.        
+0000f5e0: 2020 2020 2020 2020 2020 2020 7374 6465              stde
+0000f5f0: 7272 3d73 7562 7072 6f63 6573 732e 5049  rr=subprocess.PI
+0000f600: 5045 290a 2020 2020 2020 2020 2020 2020  PE).            
+0000f610: 2020 2020 6f75 7420 3d20 7072 6f63 2e73      out = proc.s
+0000f620: 7464 6f75 742e 6465 636f 6465 2829 0a20  tdout.decode(). 
+0000f630: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+0000f640: 7265 616b 0a20 2020 2020 2020 2020 2020  reak.           
+0000f650: 2065 7863 6570 7420 7375 6270 726f 6365   except subproce
+0000f660: 7373 2e43 616c 6c65 6450 726f 6365 7373  ss.CalledProcess
+0000f670: 4572 726f 7220 6173 2065 3a0a 2020 2020  Error as e:.    
+0000f680: 2020 2020 2020 2020 2020 2020 6966 2072              if r
+0000f690: 6574 7279 5f63 6e74 203d 3d20 776f 726b  etry_cnt == work
+0000f6a0: 6572 5f69 705f 6d61 785f 6174 7465 6d70  er_ip_max_attemp
+0000f6b0: 7473 202d 2031 3a0a 2020 2020 2020 2020  ts - 1:.        
+0000f6c0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0000f6d0: 6520 6578 6365 7074 696f 6e73 2e46 6574  e exceptions.Fet
+0000f6e0: 6368 436c 7573 7465 7249 6e66 6f45 7272  chClusterInfoErr
+0000f6f0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+0000f700: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+0000f710: 7074 696f 6e73 2e46 6574 6368 436c 7573  ptions.FetchClus
+0000f720: 7465 7249 6e66 6f45 7272 6f72 2e52 6561  terInfoError.Rea
+0000f730: 736f 6e2e 574f 524b 4552 2920 6672 6f6d  son.WORKER) from
+0000f740: 2065 0a20 2020 2020 2020 2020 2020 2020   e.             
+0000f750: 2020 2023 2052 6574 7279 2069 6620 7468     # Retry if th
+0000f760: 6520 7373 6820 6973 206e 6f74 2072 6561  e ssh is not rea
+0000f770: 6479 2066 6f72 2074 6865 2077 6f72 6b65  dy for the worke
+0000f780: 7273 2079 6574 2e0a 2020 2020 2020 2020  rs yet..        
+0000f790: 2020 2020 2020 2020 6261 636b 6f66 665f          backoff_
+0000f7a0: 7469 6d65 203d 2062 6163 6b6f 6666 2e63  time = backoff.c
+0000f7b0: 7572 7265 6e74 5f62 6163 6b6f 6666 2829  urrent_backoff()
+0000f7c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f7d0: 206c 6f67 6765 722e 6465 6275 6728 2752   logger.debug('R
+0000f7e0: 6574 7279 696e 6720 746f 2067 6574 2077  etrying to get w
+0000f7f0: 6f72 6b65 7220 6970 2027 0a20 2020 2020  orker ip '.     
+0000f800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f810: 2020 2020 2020 2020 6627 5b7b 7265 7472          f'[{retr
+0000f820: 795f 636e 747d 2f7b 776f 726b 6572 5f69  y_cnt}/{worker_i
+0000f830: 705f 6d61 785f 6174 7465 6d70 7473 7d5d  p_max_attempts}]
+0000f840: 2069 6e20 270a 2020 2020 2020 2020 2020   in '.          
+0000f850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f860: 2020 2066 277b 6261 636b 6f66 665f 7469     f'{backoff_ti
+0000f870: 6d65 7d20 7365 636f 6e64 732e 2729 0a20  me} seconds.'). 
+0000f880: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0000f890: 696d 652e 736c 6565 7028 6261 636b 6f66  ime.sleep(backof
+0000f8a0: 665f 7469 6d65 290a 2020 2020 2020 2020  f_time).        
+0000f8b0: 776f 726b 6572 5f69 7073 203d 2072 652e  worker_ips = re.
+0000f8c0: 6669 6e64 616c 6c28 4950 5f41 4444 525f  findall(IP_ADDR_
+0000f8d0: 5245 4745 582c 206f 7574 290a 2020 2020  REGEX, out).    
+0000f8e0: 2020 2020 6966 206c 656e 2877 6f72 6b65      if len(worke
+0000f8f0: 725f 6970 7329 2021 3d20 6578 7065 6374  r_ips) != expect
+0000f900: 6564 5f6e 756d 5f6e 6f64 6573 202d 2031  ed_num_nodes - 1
+0000f910: 3a0a 2020 2020 2020 2020 2020 2020 6e20  :.            n 
+0000f920: 3d20 6578 7065 6374 6564 5f6e 756d 5f6e  = expected_num_n
+0000f930: 6f64 6573 202d 2031 0a20 2020 2020 2020  odes - 1.       
+0000f940: 2020 2020 2069 6620 6c65 6e28 776f 726b       if len(work
+0000f950: 6572 5f69 7073 2920 3e20 6e3a 0a20 2020  er_ips) > n:.   
+0000f960: 2020 2020 2020 2020 2020 2020 2023 2054               # T
+0000f970: 6869 7320 636f 756c 6420 6265 2074 7269  his could be tri
+0000f980: 6767 6572 6564 2069 6620 652e 672e 2c20  ggered if e.g., 
+0000f990: 736f 6d65 206c 6f67 6769 6e67 2069 7320  some logging is 
+0000f9a0: 6164 6465 6420 696e 0a20 2020 2020 2020  added in.       
+0000f9b0: 2020 2020 2020 2020 2023 2073 6b79 7069           # skypi
+0000f9c0: 6c6f 745f 636f 6e66 6967 2c20 6120 6d6f  lot_config, a mo
+0000f9d0: 6475 6c65 2074 6861 7420 6861 7320 736f  dule that has so
+0000f9e0: 6d65 2063 6f64 6520 6578 6563 7574 6564  me code executed
+0000f9f0: 2077 6865 6e65 7665 720a 2020 2020 2020   whenever.      
+0000fa00: 2020 2020 2020 2020 2020 2320 6073 6b79            # `sky
+0000fa10: 6020 6973 2069 6d70 6f72 7465 642e 0a20  ` is imported.. 
+0000fa20: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+0000fa30: 6f67 6765 722e 7761 726e 696e 6728 0a20  ogger.warning(. 
+0000fa40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fa50: 2020 2066 2745 7870 6563 7465 6420 7b6e     f'Expected {n
+0000fa60: 7d20 776f 726b 6572 2049 5028 7329 3b20  } worker IP(s); 
+0000fa70: 666f 756e 6420 270a 2020 2020 2020 2020  found '.        
+0000fa80: 2020 2020 2020 2020 2020 2020 6627 7b6c              f'{l
+0000fa90: 656e 2877 6f72 6b65 725f 6970 7329 7d3a  en(worker_ips)}:
+0000faa0: 207b 776f 726b 6572 5f69 7073 7d27 0a20   {worker_ips}'. 
+0000fab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fac0: 2020 2027 5c6e 5468 6973 2063 6f75 6c64     '\nThis could
+0000fad0: 2068 6170 7065 6e20 6966 2074 6865 7265   happen if there
+0000fae0: 2069 7320 6578 7472 6120 6f75 7470 7574   is extra output
+0000faf0: 2066 726f 6d20 270a 2020 2020 2020 2020   from '.        
+0000fb00: 2020 2020 2020 2020 2020 2020 2760 7261              '`ra
+0000fb10: 7920 6765 742d 776f 726b 6572 2d69 7073  y get-worker-ips
+0000fb20: 602c 2077 6869 6368 2073 686f 756c 6420  `, which should 
+0000fb30: 6265 2069 6e73 7065 6374 6564 2062 656c  be inspected bel
+0000fb40: 6f77 2e27 0a20 2020 2020 2020 2020 2020  ow.'.           
+0000fb50: 2020 2020 2020 2020 2066 275c 6e3d 3d20           f'\n== 
+0000fb60: 4f75 7470 7574 203d 3d5c 6e7b 6f75 747d  Output ==\n{out}
+0000fb70: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+0000fb80: 2020 2020 2020 6627 5c6e 3d3d 204f 7574        f'\n== Out
+0000fb90: 7075 7420 656e 6473 203d 3d27 290a 2020  put ends ==').  
+0000fba0: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+0000fbb0: 6767 6572 2e77 6172 6e69 6e67 2866 275c  gger.warning(f'\
+0000fbc0: 6e50 726f 6365 6564 696e 6720 7769 7468  nProceeding with
+0000fbd0: 2074 6865 206c 6173 7420 7b6e 7d20 270a   the last {n} '.
+0000fbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fbf0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000fc00: 2764 6574 6563 7465 6420 4950 2873 293a  'detected IP(s):
+0000fc10: 207b 776f 726b 6572 5f69 7073 5b2d 6e3a   {worker_ips[-n:
+0000fc20: 5d7d 2e27 290a 2020 2020 2020 2020 2020  ]}.').          
+0000fc30: 2020 2020 2020 776f 726b 6572 5f69 7073        worker_ips
+0000fc40: 203d 2077 6f72 6b65 725f 6970 735b 2d6e   = worker_ips[-n
+0000fc50: 3a5d 0a20 2020 2020 2020 2020 2020 2065  :].            e
+0000fc60: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0000fc70: 2020 2020 2072 6169 7365 2065 7863 6570       raise excep
+0000fc80: 7469 6f6e 732e 4665 7463 6843 6c75 7374  tions.FetchClust
+0000fc90: 6572 496e 666f 4572 726f 7228 0a20 2020  erInfoError(.   
+0000fca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fcb0: 2065 7863 6570 7469 6f6e 732e 4665 7463   exceptions.Fetc
+0000fcc0: 6843 6c75 7374 6572 496e 666f 4572 726f  hClusterInfoErro
+0000fcd0: 722e 5265 6173 6f6e 2e57 4f52 4b45 5229  r.Reason.WORKER)
+0000fce0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+0000fcf0: 2020 2077 6f72 6b65 725f 6970 7320 3d20     worker_ips = 
+0000fd00: 5b5d 0a20 2020 2072 6574 7572 6e20 6865  [].    return he
+0000fd10: 6164 5f69 705f 6c69 7374 202b 2077 6f72  ad_ip_list + wor
+0000fd20: 6b65 725f 6970 730a 0a0a 6465 6620 6368  ker_ips...def ch
+0000fd30: 6563 6b5f 6e65 7477 6f72 6b5f 636f 6e6e  eck_network_conn
+0000fd40: 6563 7469 6f6e 2829 3a0a 2020 2020 2320  ection():.    # 
+0000fd50: 546f 6c65 7261 7465 2033 2072 6574 7269  Tolerate 3 retri
+0000fd60: 6573 2061 7320 6974 2069 7320 6f62 7365  es as it is obse
+0000fd70: 7276 6564 2074 6861 7420 636f 6e6e 6563  rved that connec
+0000fd80: 7469 6f6e 7320 6361 6e20 6661 696c 2e0a  tions can fail..
+0000fd90: 2020 2020 6164 6170 7465 7220 3d20 6164      adapter = ad
+0000fda0: 6170 7465 7273 2e48 5454 5041 6461 7074  apters.HTTPAdapt
+0000fdb0: 6572 286d 6178 5f72 6574 7269 6573 3d72  er(max_retries=r
+0000fdc0: 6574 7279 5f6c 6962 2e52 6574 7279 2874  etry_lib.Retry(t
+0000fdd0: 6f74 616c 3d33 2929 0a20 2020 2068 7474  otal=3)).    htt
+0000fde0: 7020 3d20 7265 7175 6573 7473 2e53 6573  p = requests.Ses
+0000fdf0: 7369 6f6e 2829 0a20 2020 2068 7474 702e  sion().    http.
+0000fe00: 6d6f 756e 7428 2768 7474 7073 3a2f 2f27  mount('https://'
+0000fe10: 2c20 6164 6170 7465 7229 0a20 2020 2068  , adapter).    h
+0000fe20: 7474 702e 6d6f 756e 7428 2768 7474 703a  ttp.mount('http:
+0000fe30: 2f2f 272c 2061 6461 7074 6572 290a 2020  //', adapter).  
+0000fe40: 2020 666f 7220 692c 2069 7020 696e 2065    for i, ip in e
+0000fe50: 6e75 6d65 7261 7465 285f 5445 5354 5f49  numerate(_TEST_I
+0000fe60: 505f 4c49 5354 293a 0a20 2020 2020 2020  P_LIST):.       
+0000fe70: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+0000fe80: 2020 6874 7470 2e68 6561 6428 6970 2c20    http.head(ip, 
+0000fe90: 7469 6d65 6f75 743d 3329 0a20 2020 2020  timeout=3).     
+0000fea0: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
+0000feb0: 2020 2020 2020 6578 6365 7074 2028 7265        except (re
+0000fec0: 7175 6573 7473 2e54 696d 656f 7574 2c20  quests.Timeout, 
+0000fed0: 7265 7175 6573 7473 2e65 7863 6570 7469  requests.excepti
+0000fee0: 6f6e 732e 436f 6e6e 6563 7469 6f6e 4572  ons.ConnectionEr
+0000fef0: 726f 7229 2061 7320 653a 0a20 2020 2020  ror) as e:.     
+0000ff00: 2020 2020 2020 2069 6620 6920 3d3d 206c         if i == l
+0000ff10: 656e 285f 5445 5354 5f49 505f 4c49 5354  en(_TEST_IP_LIST
+0000ff20: 2920 2d20 313a 0a20 2020 2020 2020 2020  ) - 1:.         
+0000ff30: 2020 2020 2020 2072 6169 7365 2065 7863         raise exc
+0000ff40: 6570 7469 6f6e 732e 4e65 7477 6f72 6b45  eptions.NetworkE
+0000ff50: 7272 6f72 2827 436f 756c 6420 6e6f 7420  rror('Could not 
+0000ff60: 7265 6672 6573 6820 7468 6520 636c 7573  refresh the clus
+0000ff70: 7465 722e 2027 0a20 2020 2020 2020 2020  ter. '.         
+0000ff80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ff90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ffa0: 2020 2020 2027 4e65 7477 6f72 6b20 7365       'Network se
+0000ffb0: 656d 7320 646f 776e 2e27 2920 6672 6f6d  ems down.') from
+0000ffc0: 2065 0a0a 0a64 6566 2063 6865 636b 5f6f   e...def check_o
+0000ffd0: 776e 6572 5f69 6465 6e74 6974 7928 636c  wner_identity(cl
+0000ffe0: 7573 7465 725f 6e61 6d65 3a20 7374 7229  uster_name: str)
+0000fff0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2222   -> None:.    ""
+00010000: 2243 6865 636b 2069 6620 6375 7272 656e  "Check if curren
+00010010: 7420 7573 6572 2069 7320 7468 6520 7361  t user is the sa
+00010020: 6d65 2061 7320 7468 6520 7573 6572 2077  me as the user w
+00010030: 686f 2063 7265 6174 6564 2074 6865 2063  ho created the c
+00010040: 6c75 7374 6572 2e0a 0a20 2020 2052 6169  luster...    Rai
+00010050: 7365 733a 0a20 2020 2020 2020 2065 7863  ses:.        exc
+00010060: 6570 7469 6f6e 732e 436c 7573 7465 724f  eptions.ClusterO
+00010070: 776e 6572 4964 656e 7469 7479 4d69 736d  wnerIdentityMism
+00010080: 6174 6368 4572 726f 723a 2069 6620 7468  atchError: if th
+00010090: 6520 6375 7272 656e 7420 7573 6572 2069  e current user i
+000100a0: 730a 2020 2020 2020 2020 2020 6e6f 7420  s.          not 
+000100b0: 7468 6520 7361 6d65 2061 7320 7468 6520  the same as the 
+000100c0: 7573 6572 2077 686f 2063 7265 6174 6564  user who created
+000100d0: 2074 6865 2063 6c75 7374 6572 2e0a 2020   the cluster..  
+000100e0: 2020 2020 2020 6578 6365 7074 696f 6e73        exceptions
+000100f0: 2e43 6c6f 7564 5573 6572 4964 656e 7469  .CloudUserIdenti
+00010100: 7479 4572 726f 723a 2069 6620 7765 2066  tyError: if we f
+00010110: 6169 6c20 746f 2067 6574 2074 6865 2063  ail to get the c
+00010120: 7572 7265 6e74 2075 7365 720a 2020 2020  urrent user.    
+00010130: 2020 2020 2020 6964 656e 7469 7479 2e0a        identity..
+00010140: 2020 2020 2222 220a 2020 2020 6966 2065      """.    if e
+00010150: 6e76 5f6f 7074 696f 6e73 2e4f 7074 696f  nv_options.Optio
+00010160: 6e73 2e53 4b49 505f 434c 4f55 445f 4944  ns.SKIP_CLOUD_ID
+00010170: 454e 5449 5459 5f43 4845 434b 2e67 6574  ENTITY_CHECK.get
+00010180: 2829 3a0a 2020 2020 2020 2020 7265 7475  ():.        retu
+00010190: 726e 0a20 2020 2072 6563 6f72 6420 3d20  rn.    record = 
+000101a0: 676c 6f62 616c 5f75 7365 725f 7374 6174  global_user_stat
+000101b0: 652e 6765 745f 636c 7573 7465 725f 6672  e.get_cluster_fr
+000101c0: 6f6d 5f6e 616d 6528 636c 7573 7465 725f  om_name(cluster_
+000101d0: 6e61 6d65 290a 2020 2020 6966 2072 6563  name).    if rec
+000101e0: 6f72 6420 6973 204e 6f6e 653a 0a20 2020  ord is None:.   
+000101f0: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
+00010200: 6861 6e64 6c65 203d 2072 6563 6f72 645b  handle = record[
+00010210: 2768 616e 646c 6527 5d0a 2020 2020 6966  'handle'].    if
+00010220: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
+00010230: 6861 6e64 6c65 2c20 6261 636b 656e 6473  handle, backends
+00010240: 2e43 6c6f 7564 566d 5261 7952 6573 6f75  .CloudVmRayResou
+00010250: 7263 6548 616e 646c 6529 3a0a 2020 2020  rceHandle):.    
+00010260: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
+00010270: 636c 6f75 6420 3d20 6861 6e64 6c65 2e6c  cloud = handle.l
+00010280: 6175 6e63 6865 645f 7265 736f 7572 6365  aunched_resource
+00010290: 732e 636c 6f75 640a 2020 2020 6375 7272  s.cloud.    curr
+000102a0: 656e 745f 7573 6572 5f69 6465 6e74 6974  ent_user_identit
+000102b0: 7920 3d20 636c 6f75 642e 6765 745f 6375  y = cloud.get_cu
+000102c0: 7272 656e 745f 7573 6572 5f69 6465 6e74  rrent_user_ident
+000102d0: 6974 7928 290a 2020 2020 6f77 6e65 725f  ity().    owner_
+000102e0: 6964 656e 7469 7479 203d 2072 6563 6f72  identity = recor
+000102f0: 645b 276f 776e 6572 275d 0a20 2020 2069  d['owner'].    i
+00010300: 6620 6375 7272 656e 745f 7573 6572 5f69  f current_user_i
+00010310: 6465 6e74 6974 7920 6973 204e 6f6e 653a  dentity is None:
+00010320: 0a20 2020 2020 2020 2023 2053 6b69 7020  .        # Skip 
+00010330: 7468 6520 6368 6563 6b20 6966 2074 6865  the check if the
+00010340: 2063 6c6f 7564 2064 6f65 7320 6e6f 7420   cloud does not 
+00010350: 7375 7070 6f72 7420 7573 6572 2069 6465  support user ide
+00010360: 6e74 6974 792e 0a20 2020 2020 2020 2072  ntity..        r
+00010370: 6574 7572 6e0a 2020 2020 2320 5468 6520  eturn.    # The 
+00010380: 7573 6572 2069 6465 6e74 6974 7920 6361  user identity ca
+00010390: 6e20 6265 204e 6f6e 652c 2069 6620 7468  n be None, if th
+000103a0: 6520 636c 7573 7465 7220 6973 2063 7265  e cluster is cre
+000103b0: 6174 6564 2062 7920 616e 206f 6c64 6572  ated by an older
+000103c0: 0a20 2020 2023 2076 6572 7369 6f6e 206f  .    # version o
+000103d0: 6620 536b 7950 696c 6f74 2e20 496e 2074  f SkyPilot. In t
+000103e0: 6861 7420 6361 7365 2c20 7765 2073 6574  hat case, we set
+000103f0: 2074 6865 2075 7365 7220 6964 656e 7469   the user identi
+00010400: 7479 2074 6f20 7468 650a 2020 2020 2320  ty to the.    # 
+00010410: 6375 7272 656e 7420 6f6e 652e 0a20 2020  current one..   
+00010420: 2023 204e 4f54 453a 2061 2075 7365 7220   # NOTE: a user 
+00010430: 7768 6f20 7570 6772 6164 6573 2053 6b79  who upgrades Sky
+00010440: 5069 6c6f 7420 616e 6420 7377 6974 6368  Pilot and switch
+00010450: 6573 2074 6f20 6120 6e65 7720 636c 6f75  es to a new clou
+00010460: 6420 6964 656e 7469 7479 0a20 2020 2023  d identity.    #
+00010470: 2069 6d6d 6564 6961 7465 6c79 2077 6974   immediately wit
+00010480: 686f 7574 2060 736b 7920 7374 6174 7573  hout `sky status
+00010490: 202d 2d72 6566 7265 7368 6020 6669 7273   --refresh` firs
+000104a0: 742c 2077 696c 6c20 6361 7573 6520 6120  t, will cause a 
+000104b0: 6c65 616b 6167 650a 2020 2020 2320 6f66  leakage.    # of
+000104c0: 2074 6865 2065 7869 7374 696e 6720 636c   the existing cl
+000104d0: 7573 7465 722e 2057 6520 6465 656d 2074  uster. We deem t
+000104e0: 6869 7320 616e 2061 6363 6570 7461 626c  his an acceptabl
+000104f0: 6520 7472 6164 656f 6666 206d 6169 6e6c  e tradeoff mainl
+00010500: 790a 2020 2020 2320 6265 6361 7573 6520  y.    # because 
+00010510: 6d75 6c74 692d 6964 656e 7469 7479 2069  multi-identity i
+00010520: 7320 6e6f 7420 636f 6d6d 6f6e 2028 6174  s not common (at
+00010530: 206c 6561 7374 2061 7420 7468 6520 6d6f   least at the mo
+00010540: 6d65 6e74 292e 0a20 2020 2069 6620 6f77  ment)..    if ow
+00010550: 6e65 725f 6964 656e 7469 7479 2069 7320  ner_identity is 
+00010560: 4e6f 6e65 3a0a 2020 2020 2020 2020 676c  None:.        gl
+00010570: 6f62 616c 5f75 7365 725f 7374 6174 652e  obal_user_state.
+00010580: 7365 745f 6f77 6e65 725f 6964 656e 7469  set_owner_identi
+00010590: 7479 5f66 6f72 5f63 6c75 7374 6572 280a  ty_for_cluster(.
+000105a0: 2020 2020 2020 2020 2020 2020 636c 7573              clus
+000105b0: 7465 725f 6e61 6d65 2c20 6375 7272 656e  ter_name, curren
+000105c0: 745f 7573 6572 5f69 6465 6e74 6974 7929  t_user_identity)
+000105d0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+000105e0: 2020 2061 7373 6572 7420 6973 696e 7374     assert isinst
+000105f0: 616e 6365 286f 776e 6572 5f69 6465 6e74  ance(owner_ident
+00010600: 6974 792c 206c 6973 7429 0a20 2020 2020  ity, list).     
+00010610: 2020 2023 2049 7420 6973 204f 4b20 6966     # It is OK if
+00010620: 2074 6865 206f 776e 6572 2069 6465 6e74   the owner ident
+00010630: 6974 7920 6973 2073 686f 7274 6572 2c20  ity is shorter, 
+00010640: 7768 6963 6820 7769 6c6c 2068 6170 7065  which will happe
+00010650: 6e20 7768 656e 0a20 2020 2020 2020 2023  n when.        #
+00010660: 2074 6865 2063 6c75 7374 6572 2069 7320   the cluster is 
+00010670: 6c61 756e 6368 6564 2062 6566 6f72 6520  launched before 
+00010680: 2331 3830 382e 2049 6e20 7468 6174 2063  #1808. In that c
+00010690: 6173 652c 2077 6520 6f6e 6c79 2063 6865  ase, we only che
+000106a0: 636b 0a20 2020 2020 2020 2023 2074 6865  ck.        # the
+000106b0: 2073 616d 6520 6c65 6e67 7468 2028 7a69   same length (zi
+000106c0: 7020 7769 6c6c 2073 746f 7020 6174 2074  p will stop at t
+000106d0: 6865 2073 686f 7274 6572 206f 6e65 292e  he shorter one).
+000106e0: 0a20 2020 2020 2020 2066 6f72 2069 2c20  .        for i, 
+000106f0: 286f 776e 6572 2c0a 2020 2020 2020 2020  (owner,.        
+00010700: 2020 2020 2020 2020 6375 7272 656e 7429          current)
+00010710: 2069 6e20 656e 756d 6572 6174 6528 7a69   in enumerate(zi
+00010720: 7028 6f77 6e65 725f 6964 656e 7469 7479  p(owner_identity
+00010730: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00010740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010750: 2020 2020 2020 2020 2020 2020 6375 7272              curr
+00010760: 656e 745f 7573 6572 5f69 6465 6e74 6974  ent_user_identit
+00010770: 7929 293a 0a20 2020 2020 2020 2020 2020  y)):.           
+00010780: 2023 2043 6c65 616e 2075 7020 7468 6520   # Clean up the 
+00010790: 6f77 6e65 7220 6964 656e 7469 7479 2066  owner identity f
+000107a0: 6f72 2074 6865 2062 6163 6b73 6c61 7368  or the backslash
+000107b0: 2061 6e64 206e 6577 6c69 6e65 732c 2063   and newlines, c
+000107c0: 6175 7365 640a 2020 2020 2020 2020 2020  aused.          
+000107d0: 2020 2320 6279 2074 6865 2063 6c6f 7564    # by the cloud
+000107e0: 2043 4c49 206f 7574 7075 742c 2065 2e67   CLI output, e.g
+000107f0: 2e20 6763 6c6f 7564 2e0a 2020 2020 2020  . gcloud..      
+00010800: 2020 2020 2020 6f77 6e65 7220 3d20 6f77        owner = ow
+00010810: 6e65 722e 7265 706c 6163 6528 275c 6e27  ner.replace('\n'
+00010820: 2c20 2727 292e 7265 706c 6163 6528 275c  , '').replace('\
+00010830: 5c27 2c20 2727 290a 2020 2020 2020 2020  \', '').        
+00010840: 2020 2020 6966 206f 776e 6572 203d 3d20      if owner == 
+00010850: 6375 7272 656e 743a 0a20 2020 2020 2020  current:.       
+00010860: 2020 2020 2020 2020 2069 6620 6920 213d           if i !=
+00010870: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+00010880: 2020 2020 2020 2020 6c6f 6767 6572 2e77          logger.w
+00010890: 6172 6e69 6e67 280a 2020 2020 2020 2020  arning(.        
+000108a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000108b0: 6627 5468 6520 636c 7573 7465 7220 7761  f'The cluster wa
+000108c0: 7320 6f77 6e65 6420 6279 207b 6f77 6e65  s owned by {owne
+000108d0: 725f 6964 656e 7469 7479 7d2c 2062 7574  r_identity}, but
+000108e0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+000108f0: 2020 2020 2020 2020 2020 2066 2761 206e             f'a n
+00010900: 6577 2069 6465 6e74 6974 7920 7b63 7572  ew identity {cur
+00010910: 7265 6e74 5f75 7365 725f 6964 656e 7469  rent_user_identi
+00010920: 7479 7d20 6973 2061 6374 6976 6174 6564  ty} is activated
+00010930: 2e20 5765 2073 7469 6c6c 2027 0a20 2020  . We still '.   
+00010940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010950: 2020 2020 2027 616c 6c6f 7720 7468 6520       'allow the 
+00010960: 6f70 6572 6174 696f 6e20 6173 2074 6865  operation as the
+00010970: 2074 776f 2069 6465 6e74 6974 6965 7320   two identities 
+00010980: 6172 6520 6c69 6b65 6c79 2074 6f20 6861  are likely to ha
+00010990: 7665 2027 0a20 2020 2020 2020 2020 2020  ve '.           
+000109a0: 2020 2020 2020 2020 2020 2020 2027 7468               'th
+000109b0: 6520 7361 6d65 2061 6363 6573 7320 746f  e same access to
+000109c0: 2074 6865 2063 6c75 7374 6572 2e20 506c   the cluster. Pl
+000109d0: 6561 7365 2062 6520 6177 6172 6520 7468  ease be aware th
+000109e0: 6174 2074 6869 7320 6361 6e20 270a 2020  at this can '.  
+000109f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010a00: 2020 2020 2020 2763 6175 7365 2075 6e65        'cause une
+00010a10: 7870 6563 7465 6420 636c 7573 7465 7220  xpected cluster 
+00010a20: 6c65 616b 6167 6520 6966 2074 6865 2074  leakage if the t
+00010a30: 776f 2069 6465 6e74 6974 6965 7320 6172  wo identities ar
+00010a40: 6520 6e6f 7420 270a 2020 2020 2020 2020  e not '.        
+00010a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010a60: 2761 6374 7561 6c6c 7920 6571 7569 7661  'actually equiva
+00010a70: 6c65 6e74 2028 652e 672e 2c20 6265 6c6f  lent (e.g., belo
+00010a80: 6e67 2074 6f20 7468 6520 7361 6d65 2070  ng to the same p
+00010a90: 6572 736f 6e29 2e27 0a20 2020 2020 2020  erson).'.       
+00010aa0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00010ab0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00010ac0: 6620 6920 213d 2030 206f 7220 6c65 6e28  f i != 0 or len(
+00010ad0: 6f77 6e65 725f 6964 656e 7469 7479 2920  owner_identity) 
+00010ae0: 213d 206c 656e 2863 7572 7265 6e74 5f75  != len(current_u
+00010af0: 7365 725f 6964 656e 7469 7479 293a 0a20  ser_identity):. 
+00010b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010b10: 2020 2023 2057 6520 7570 6461 7465 2074     # We update t
+00010b20: 6865 206f 776e 6572 206f 6620 6120 636c  he owner of a cl
+00010b30: 7573 7465 722c 2077 6865 6e3a 0a20 2020  uster, when:.   
+00010b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010b50: 2023 2031 2e20 5468 6520 7374 7269 6374   # 1. The strict
+00010b60: 6573 7420 6964 656e 7474 7920 2869 2e65  est identty (i.e
+00010b70: 2e20 7468 6520 6669 7273 7420 6f6e 6529  . the first one)
+00010b80: 2064 6f65 7320 6e6f 740a 2020 2020 2020   does not.      
+00010b90: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00010ba0: 6d61 7463 682c 2062 7574 2074 6865 206c  match, but the l
+00010bb0: 6174 7465 7220 6f6e 6573 206d 6174 6368  atter ones match
+00010bc0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00010bd0: 2020 2020 2020 2320 322e 2054 6865 206c        # 2. The l
+00010be0: 656e 6774 6820 6f66 2074 6865 2074 776f  ength of the two
+00010bf0: 2069 6465 6e74 6974 6965 7320 6172 6520   identities are 
+00010c00: 6469 6666 6572 656e 742c 2077 6869 6368  different, which
+00010c10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010c20: 2020 2020 2023 2077 696c 6c20 6f6e 6c79       # will only
+00010c30: 2068 6170 7065 6e20 7768 656e 2074 6865   happen when the
+00010c40: 2063 6c75 7374 6572 2069 7320 6c61 756e   cluster is laun
+00010c50: 6368 6564 2062 6566 6f72 6520 2331 3830  ched before #180
+00010c60: 382e 0a20 2020 2020 2020 2020 2020 2020  8..             
+00010c70: 2020 2020 2020 2023 2055 7064 6174 6520         # Update 
+00010c80: 7468 6520 7573 6572 2069 6465 6e74 6974  the user identit
+00010c90: 7920 746f 2061 766f 6964 2073 686f 7769  y to avoid showi
+00010ca0: 6e67 2074 6865 2077 6172 6e69 6e67 2061  ng the warning a
+00010cb0: 626f 7665 0a20 2020 2020 2020 2020 2020  bove.           
+00010cc0: 2020 2020 2020 2020 2023 2061 6761 696e           # again
+00010cd0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00010ce0: 2020 2020 2020 676c 6f62 616c 5f75 7365        global_use
+00010cf0: 725f 7374 6174 652e 7365 745f 6f77 6e65  r_state.set_owne
+00010d00: 725f 6964 656e 7469 7479 5f66 6f72 5f63  r_identity_for_c
+00010d10: 6c75 7374 6572 280a 2020 2020 2020 2020  luster(.        
+00010d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010d30: 636c 7573 7465 725f 6e61 6d65 2c20 6375  cluster_name, cu
+00010d40: 7272 656e 745f 7573 6572 5f69 6465 6e74  rrent_user_ident
+00010d50: 6974 7929 0a20 2020 2020 2020 2020 2020  ity).           
+00010d60: 2020 2020 2072 6574 7572 6e20 2023 2054       return  # T
+00010d70: 6865 2075 7365 7220 6964 656e 7469 7479  he user identity
+00010d80: 206d 6174 6368 6573 2e0a 2020 2020 2020   matches..      
+00010d90: 2020 7769 7468 2075 785f 7574 696c 732e    with ux_utils.
+00010da0: 7072 696e 745f 6578 6365 7074 696f 6e5f  print_exception_
+00010db0: 6e6f 5f74 7261 6365 6261 636b 2829 3a0a  no_traceback():.
+00010dc0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00010dd0: 6520 6578 6365 7074 696f 6e73 2e43 6c75  e exceptions.Clu
+00010de0: 7374 6572 4f77 6e65 7249 6465 6e74 6974  sterOwnerIdentit
+00010df0: 794d 6973 6d61 7463 6845 7272 6f72 280a  yMismatchError(.
+00010e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010e10: 6627 7b63 6c75 7374 6572 5f6e 616d 6521  f'{cluster_name!
+00010e20: 727d 2028 7b63 6c6f 7564 7d29 2069 7320  r} ({cloud}) is 
+00010e30: 6f77 6e65 6420 6279 2061 6363 6f75 6e74  owned by account
+00010e40: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+00010e50: 2020 2066 277b 6f77 6e65 725f 6964 656e     f'{owner_iden
+00010e60: 7469 7479 2172 7d2c 2062 7574 2074 6865  tity!r}, but the
+00010e70: 2061 6374 6976 6174 6564 2061 6363 6f75   activated accou
+00010e80: 6e74 2027 0a20 2020 2020 2020 2020 2020  nt '.           
+00010e90: 2020 2020 2066 2769 7320 7b63 7572 7265       f'is {curre
+00010ea0: 6e74 5f75 7365 725f 6964 656e 7469 7479  nt_user_identity
+00010eb0: 2172 7d2e 2729 0a0a 0a64 6566 2074 6167  !r}.')...def tag
+00010ec0: 5f66 696c 7465 725f 666f 725f 636c 7573  _filter_for_clus
+00010ed0: 7465 7228 636c 7573 7465 725f 6e61 6d65  ter(cluster_name
+00010ee0: 3a20 7374 7229 202d 3e20 4469 6374 5b73  : str) -> Dict[s
+00010ef0: 7472 2c20 7374 725d 3a0a 2020 2020 2222  tr, str]:.    ""
+00010f00: 2252 6574 7572 6e73 2061 2074 6167 2066  "Returns a tag f
+00010f10: 696c 7465 7220 666f 7220 7468 6520 636c  ilter for the cl
+00010f20: 7573 7465 722e 2222 220a 2020 2020 7265  uster.""".    re
+00010f30: 7475 726e 207b 0a20 2020 2020 2020 2027  turn {.        '
+00010f40: 7261 792d 636c 7573 7465 722d 6e61 6d65  ray-cluster-name
+00010f50: 273a 2063 6c75 7374 6572 5f6e 616d 652c  ': cluster_name,
+00010f60: 0a20 2020 207d 0a0a 0a64 6566 205f 7175  .    }...def _qu
+00010f70: 6572 795f 636c 7573 7465 725f 7374 6174  ery_cluster_stat
+00010f80: 7573 5f76 6961 5f63 6c6f 7564 5f61 7069  us_via_cloud_api
+00010f90: 280a 2020 2020 6861 6e64 6c65 3a20 2763  (.    handle: 'c
+00010fa0: 6c6f 7564 5f76 6d5f 7261 795f 6261 636b  loud_vm_ray_back
+00010fb0: 656e 642e 436c 6f75 6456 6d52 6179 5265  end.CloudVmRayRe
+00010fc0: 736f 7572 6365 4861 6e64 6c65 270a 2920  sourceHandle'.) 
+00010fd0: 2d3e 204c 6973 745b 7374 6174 7573 5f6c  -> List[status_l
+00010fe0: 6962 2e43 6c75 7374 6572 5374 6174 7573  ib.ClusterStatus
+00010ff0: 5d3a 0a20 2020 2022 2222 5265 7475 726e  ]:.    """Return
+00011000: 7320 7468 6520 7374 6174 7573 206f 6620  s the status of 
+00011010: 7468 6520 636c 7573 7465 722e 0a0a 2020  the cluster...  
+00011020: 2020 5261 6973 6573 3a0a 2020 2020 2020    Raises:.      
+00011030: 2020 6578 6365 7074 696f 6e73 2e43 6c75    exceptions.Clu
+00011040: 7374 6572 5374 6174 7573 4665 7463 6869  sterStatusFetchi
+00011050: 6e67 4572 726f 723a 2074 6865 2063 6c75  ngError: the clu
+00011060: 7374 6572 2073 7461 7475 7320 6361 6e6e  ster status cann
+00011070: 6f74 2062 650a 2020 2020 2020 2020 2020  ot be.          
+00011080: 6665 7463 6865 6420 6672 6f6d 2074 6865  fetched from the
+00011090: 2063 6c6f 7564 2070 726f 7669 6465 722e   cloud provider.
+000110a0: 0a20 2020 2022 2222 0a20 2020 2063 6c75  .    """.    clu
+000110b0: 7374 6572 5f6e 616d 655f 6f6e 5f63 6c6f  ster_name_on_clo
+000110c0: 7564 203d 2068 616e 646c 652e 636c 7573  ud = handle.clus
+000110d0: 7465 725f 6e61 6d65 5f6f 6e5f 636c 6f75  ter_name_on_clou
+000110e0: 640a 2020 2020 636c 7573 7465 725f 6e61  d.    cluster_na
+000110f0: 6d65 5f69 6e5f 6869 6e74 203d 2063 6f6d  me_in_hint = com
+00011100: 6d6f 6e5f 7574 696c 732e 636c 7573 7465  mon_utils.cluste
+00011110: 725f 6e61 6d65 5f69 6e5f 6869 6e74 280a  r_name_in_hint(.
+00011120: 2020 2020 2020 2020 6861 6e64 6c65 2e63          handle.c
+00011130: 6c75 7374 6572 5f6e 616d 652c 2063 6c75  luster_name, clu
+00011140: 7374 6572 5f6e 616d 655f 6f6e 5f63 6c6f  ster_name_on_clo
+00011150: 7564 290a 2020 2020 2320 5573 6520 7265  ud).    # Use re
+00011160: 6769 6f6e 2061 6e64 207a 6f6e 6520 6672  gion and zone fr
+00011170: 6f6d 2074 6865 2063 6c75 7374 6572 2063  om the cluster c
+00011180: 6f6e 6669 672c 2069 6e73 7465 6164 206f  onfig, instead o
+00011190: 6620 7468 650a 2020 2020 2320 6861 6e64  f the.    # hand
+000111a0: 6c65 2e6c 6175 6e63 6865 645f 7265 736f  le.launched_reso
+000111b0: 7572 6365 732c 2062 6563 6175 7365 2074  urces, because t
+000111c0: 6865 206c 6174 7465 7220 6d61 7920 6e6f  he latter may no
+000111d0: 7420 6265 2073 6574 0a20 2020 2023 2063  t be set.    # c
+000111e0: 6f72 7265 6374 6c79 2079 6574 2e0a 2020  orrectly yet..  
+000111f0: 2020 7261 795f 636f 6e66 6967 203d 2063    ray_config = c
+00011200: 6f6d 6d6f 6e5f 7574 696c 732e 7265 6164  ommon_utils.read
+00011210: 5f79 616d 6c28 6861 6e64 6c65 2e63 6c75  _yaml(handle.clu
+00011220: 7374 6572 5f79 616d 6c29 0a20 2020 2070  ster_yaml).    p
+00011230: 726f 7669 6465 725f 636f 6e66 6967 203d  rovider_config =
+00011240: 2072 6179 5f63 6f6e 6669 675b 2770 726f   ray_config['pro
+00011250: 7669 6465 7227 5d0a 0a20 2020 2023 2051  vider']..    # Q
+00011260: 7565 7279 2074 6865 2063 6c6f 7564 2070  uery the cloud p
+00011270: 726f 7669 6465 722e 0a20 2020 2023 2054  rovider..    # T
+00011280: 4f44 4f28 7375 7175 6172 6b29 3a20 6d6f  ODO(suquark): mo
+00011290: 7665 2069 6d70 6c65 6d65 6e74 6174 696f  ve implementatio
+000112a0: 6e73 206f 6620 6d6f 7265 2063 6c6f 7564  ns of more cloud
+000112b0: 7320 6865 7265 0a20 2020 2063 6c6f 7564  s here.    cloud
+000112c0: 203d 2068 616e 646c 652e 6c61 756e 6368   = handle.launch
+000112d0: 6564 5f72 6573 6f75 7263 6573 2e63 6c6f  ed_resources.clo
+000112e0: 7564 0a20 2020 2061 7373 6572 7420 636c  ud.    assert cl
+000112f0: 6f75 6420 6973 206e 6f74 204e 6f6e 652c  oud is not None,
+00011300: 2068 616e 646c 650a 2020 2020 6966 2063   handle.    if c
+00011310: 6c6f 7564 2e53 5441 5455 535f 5645 5253  loud.STATUS_VERS
+00011320: 494f 4e20 3e3d 2063 6c6f 7564 732e 5374  ION >= clouds.St
+00011330: 6174 7573 5665 7273 696f 6e2e 534b 5950  atusVersion.SKYP
+00011340: 494c 4f54 3a0a 2020 2020 2020 2020 636c  ILOT:.        cl
+00011350: 6f75 645f 6e61 6d65 203d 2072 6570 7228  oud_name = repr(
+00011360: 6861 6e64 6c65 2e6c 6175 6e63 6865 645f  handle.launched_
+00011370: 7265 736f 7572 6365 732e 636c 6f75 6429  resources.cloud)
+00011380: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
+00011390: 2020 2020 2020 2020 2020 6e6f 6465 5f73            node_s
+000113a0: 7461 7475 735f 6469 6374 203d 2070 726f  tatus_dict = pro
+000113b0: 7669 7369 6f6e 5f6c 6962 2e71 7565 7279  vision_lib.query
+000113c0: 5f69 6e73 7461 6e63 6573 280a 2020 2020  _instances(.    
+000113d0: 2020 2020 2020 2020 2020 2020 636c 6f75              clou
+000113e0: 645f 6e61 6d65 2c20 636c 7573 7465 725f  d_name, cluster_
+000113f0: 6e61 6d65 5f6f 6e5f 636c 6f75 642c 2070  name_on_cloud, p
+00011400: 726f 7669 6465 725f 636f 6e66 6967 290a  rovider_config).
+00011410: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+00011420: 6572 2e64 6562 7567 2866 2751 7565 7279  er.debug(f'Query
+00011430: 696e 6720 7b63 6c6f 7564 5f6e 616d 657d  ing {cloud_name}
+00011440: 2063 6c75 7374 6572 2027 0a20 2020 2020   cluster '.     
+00011450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011460: 2020 2020 6627 7b63 6c75 7374 6572 5f6e      f'{cluster_n
+00011470: 616d 655f 696e 5f68 696e 747d 2027 0a20  ame_in_hint} '. 
+00011480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011490: 2020 2020 2020 2020 6627 7374 6174 7573          f'status
+000114a0: 3a5c 6e7b 7070 7269 6e74 2e70 666f 726d  :\n{pprint.pform
+000114b0: 6174 286e 6f64 655f 7374 6174 7573 5f64  at(node_status_d
+000114c0: 6963 7429 7d27 290a 2020 2020 2020 2020  ict)}').        
+000114d0: 2020 2020 6e6f 6465 5f73 7461 7475 7365      node_statuse
+000114e0: 7320 3d20 6c69 7374 286e 6f64 655f 7374  s = list(node_st
+000114f0: 6174 7573 5f64 6963 742e 7661 6c75 6573  atus_dict.values
+00011500: 2829 290a 2020 2020 2020 2020 6578 6365  ()).        exce
+00011510: 7074 2045 7863 6570 7469 6f6e 2061 7320  pt Exception as 
+00011520: 653a 2020 2320 7079 6c69 6e74 3a20 6469  e:  # pylint: di
+00011530: 7361 626c 653d 6272 6f61 642d 6578 6365  sable=broad-exce
+00011540: 7074 0a20 2020 2020 2020 2020 2020 2077  pt.            w
+00011550: 6974 6820 7578 5f75 7469 6c73 2e70 7269  ith ux_utils.pri
+00011560: 6e74 5f65 7863 6570 7469 6f6e 5f6e 6f5f  nt_exception_no_
+00011570: 7472 6163 6562 6163 6b28 293a 0a20 2020  traceback():.   
+00011580: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+00011590: 7365 2065 7863 6570 7469 6f6e 732e 436c  se exceptions.Cl
+000115a0: 7573 7465 7253 7461 7475 7346 6574 6368  usterStatusFetch
+000115b0: 696e 6745 7272 6f72 280a 2020 2020 2020  ingError(.      
+000115c0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+000115d0: 4661 696c 6564 2074 6f20 7175 6572 7920  Failed to query 
+000115e0: 7b63 6c6f 7564 5f6e 616d 657d 2063 6c75  {cloud_name} clu
+000115f0: 7374 6572 2027 0a20 2020 2020 2020 2020  ster '.         
+00011600: 2020 2020 2020 2020 2020 2066 277b 636c             f'{cl
+00011610: 7573 7465 725f 6e61 6d65 5f69 6e5f 6869  uster_name_in_hi
+00011620: 6e74 7d20 270a 2020 2020 2020 2020 2020  nt} '.          
+00011630: 2020 2020 2020 2020 2020 6627 7374 6174            f'stat
+00011640: 7573 3a20 7b63 6f6d 6d6f 6e5f 7574 696c  us: {common_util
+00011650: 732e 666f 726d 6174 5f65 7863 6570 7469  s.format_excepti
+00011660: 6f6e 2865 2c20 7573 655f 6272 6163 6b65  on(e, use_bracke
+00011670: 743d 5472 7565 297d 270a 2020 2020 2020  t=True)}'.      
+00011680: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00011690: 656c 7365 3a0a 2020 2020 2020 2020 7265  else:.        re
+000116a0: 6769 6f6e 203d 2070 726f 7669 6465 725f  gion = provider_
+000116b0: 636f 6e66 6967 2e67 6574 2827 7265 6769  config.get('regi
+000116c0: 6f6e 2729 206f 7220 7072 6f76 6964 6572  on') or provider
+000116d0: 5f63 6f6e 6669 672e 6765 7428 0a20 2020  _config.get(.   
+000116e0: 2020 2020 2020 2020 2027 6c6f 6361 7469           'locati
+000116f0: 6f6e 2729 0a20 2020 2020 2020 207a 6f6e  on').        zon
+00011700: 6520 3d20 7261 795f 636f 6e66 6967 5b27  e = ray_config['
+00011710: 7072 6f76 6964 6572 275d 2e67 6574 2827  provider'].get('
+00011720: 6176 6169 6c61 6269 6c69 7479 5f7a 6f6e  availability_zon
+00011730: 6527 290a 2020 2020 2020 2020 6e6f 6465  e').        node
+00011740: 5f73 7461 7475 7365 7320 3d20 636c 6f75  _statuses = clou
+00011750: 642e 7175 6572 795f 7374 6174 7573 280a  d.query_status(.
+00011760: 2020 2020 2020 2020 2020 2020 636c 7573              clus
+00011770: 7465 725f 6e61 6d65 5f6f 6e5f 636c 6f75  ter_name_on_clou
+00011780: 642c 0a20 2020 2020 2020 2020 2020 2074  d,.            t
+00011790: 6167 5f66 696c 7465 725f 666f 725f 636c  ag_filter_for_cl
+000117a0: 7573 7465 7228 636c 7573 7465 725f 6e61  uster(cluster_na
+000117b0: 6d65 5f6f 6e5f 636c 6f75 6429 2c20 7265  me_on_cloud), re
+000117c0: 6769 6f6e 2c20 7a6f 6e65 290a 2020 2020  gion, zone).    
+000117d0: 7265 7475 726e 206e 6f64 655f 7374 6174  return node_stat
+000117e0: 7573 6573 0a0a 0a64 6566 2063 6865 636b  uses...def check
+000117f0: 5f63 616e 5f63 6c6f 6e65 5f64 6973 6b5f  _can_clone_disk_
+00011800: 616e 645f 6f76 6572 7269 6465 5f74 6173  and_override_tas
+00011810: 6b28 0a20 2020 2063 6c75 7374 6572 5f6e  k(.    cluster_n
+00011820: 616d 653a 2073 7472 2c20 7461 7267 6574  ame: str, target
+00011830: 5f63 6c75 7374 6572 5f6e 616d 653a 204f  _cluster_name: O
+00011840: 7074 696f 6e61 6c5b 7374 725d 2c20 7461  ptional[str], ta
+00011850: 736b 3a20 2774 6173 6b5f 6c69 622e 5461  sk: 'task_lib.Ta
+00011860: 736b 270a 2920 2d3e 2054 7570 6c65 5b27  sk'.) -> Tuple['
+00011870: 7461 736b 5f6c 6962 2e54 6173 6b27 2c20  task_lib.Task', 
+00011880: 2763 6c6f 7564 5f76 6d5f 7261 795f 6261  'cloud_vm_ray_ba
+00011890: 636b 656e 642e 436c 6f75 6456 6d52 6179  ckend.CloudVmRay
+000118a0: 5265 736f 7572 6365 4861 6e64 6c65 275d  ResourceHandle']
+000118b0: 3a0a 2020 2020 2222 2243 6865 636b 2069  :.    """Check i
+000118c0: 6620 7468 6520 7461 736b 2069 7320 636f  f the task is co
+000118d0: 6d70 6174 6962 6c65 2074 6f20 636c 6f6e  mpatible to clon
+000118e0: 6520 6469 736b 2066 726f 6d20 7468 6520  e disk from the 
+000118f0: 736f 7572 6365 2063 6c75 7374 6572 2e0a  source cluster..
+00011900: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
+00011910: 2020 2063 6c75 7374 6572 5f6e 616d 653a     cluster_name:
+00011920: 2054 6865 206e 616d 6520 6f66 2074 6865   The name of the
+00011930: 2063 6c75 7374 6572 2074 6f20 636c 6f6e   cluster to clon
+00011940: 6520 6469 736b 2066 726f 6d2e 0a20 2020  e disk from..   
+00011950: 2020 2020 2074 6172 6765 745f 636c 7573       target_clus
+00011960: 7465 725f 6e61 6d65 3a20 5468 6520 6e61  ter_name: The na
+00011970: 6d65 206f 6620 7468 6520 7461 7267 6574  me of the target
+00011980: 2063 6c75 7374 6572 2e0a 2020 2020 2020   cluster..      
+00011990: 2020 7461 736b 3a20 5468 6520 7461 736b    task: The task
+000119a0: 2074 6f20 6368 6563 6b2e 0a0a 2020 2020   to check...    
+000119b0: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
+000119c0: 2054 6865 2074 6173 6b20 746f 2075 7365   The task to use
+000119d0: 2061 6e64 2074 6865 2072 6573 6f75 7263   and the resourc
+000119e0: 6520 6861 6e64 6c65 206f 6620 7468 6520  e handle of the 
+000119f0: 736f 7572 6365 2063 6c75 7374 6572 2e0a  source cluster..
+00011a00: 0a20 2020 2052 6169 7365 733a 0a20 2020  .    Raises:.   
+00011a10: 2020 2020 2056 616c 7565 4572 726f 723a       ValueError:
+00011a20: 2049 6620 7468 6520 736f 7572 6365 2063   If the source c
+00011a30: 6c75 7374 6572 2064 6f65 7320 6e6f 7420  luster does not 
+00011a40: 6578 6973 742e 0a20 2020 2020 2020 2065  exist..        e
+00011a50: 7863 6570 7469 6f6e 732e 4e6f 7453 7570  xceptions.NotSup
+00011a60: 706f 7274 6564 4572 726f 723a 2049 6620  portedError: If 
+00011a70: 7468 6520 736f 7572 6365 2063 6c75 7374  the source clust
+00011a80: 6572 2069 7320 6e6f 7420 7661 6c69 6420  er is not valid 
+00011a90: 6f72 2074 6865 0a20 2020 2020 2020 2020  or the.         
+00011aa0: 2020 2074 6173 6b20 6973 206e 6f74 2063     task is not c
+00011ab0: 6f6d 7061 7469 626c 6520 746f 2063 6c6f  ompatible to clo
+00011ac0: 6e65 2064 6973 6b20 6672 6f6d 2074 6865  ne disk from the
+00011ad0: 2073 6f75 7263 6520 636c 7573 7465 722e   source cluster.
+00011ae0: 0a20 2020 2022 2222 0a20 2020 2073 6f75  .    """.    sou
+00011af0: 7263 655f 636c 7573 7465 725f 7374 6174  rce_cluster_stat
+00011b00: 7573 2c20 6861 6e64 6c65 203d 2072 6566  us, handle = ref
+00011b10: 7265 7368 5f63 6c75 7374 6572 5f73 7461  resh_cluster_sta
+00011b20: 7475 735f 6861 6e64 6c65 2863 6c75 7374  tus_handle(clust
+00011b30: 6572 5f6e 616d 6529 0a20 2020 2069 6620  er_name).    if 
+00011b40: 736f 7572 6365 5f63 6c75 7374 6572 5f73  source_cluster_s
+00011b50: 7461 7475 7320 6973 204e 6f6e 653a 0a20  tatus is None:. 
+00011b60: 2020 2020 2020 2077 6974 6820 7578 5f75         with ux_u
+00011b70: 7469 6c73 2e70 7269 6e74 5f65 7863 6570  tils.print_excep
+00011b80: 7469 6f6e 5f6e 6f5f 7472 6163 6562 6163  tion_no_tracebac
+00011b90: 6b28 293a 0a20 2020 2020 2020 2020 2020  k():.           
+00011ba0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+00011bb0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+00011bc0: 2020 2066 2743 616e 6e6f 7420 6669 6e64     f'Cannot find
+00011bd0: 2063 6c75 7374 6572 207b 636c 7573 7465   cluster {cluste
+00011be0: 725f 6e61 6d65 2172 7d20 746f 2063 6c6f  r_name!r} to clo
+00011bf0: 6e65 2064 6973 6b20 6672 6f6d 2e27 290a  ne disk from.').
+00011c00: 0a20 2020 2069 6620 6e6f 7420 6973 696e  .    if not isin
+00011c10: 7374 616e 6365 2868 616e 646c 652c 2062  stance(handle, b
+00011c20: 6163 6b65 6e64 732e 436c 6f75 6456 6d52  ackends.CloudVmR
+00011c30: 6179 5265 736f 7572 6365 4861 6e64 6c65  ayResourceHandle
+00011c40: 293a 0a20 2020 2020 2020 2077 6974 6820  ):.        with 
+00011c50: 7578 5f75 7469 6c73 2e70 7269 6e74 5f65  ux_utils.print_e
+00011c60: 7863 6570 7469 6f6e 5f6e 6f5f 7472 6163  xception_no_trac
+00011c70: 6562 6163 6b28 293a 0a20 2020 2020 2020  eback():.       
+00011c80: 2020 2020 2072 6169 7365 2065 7863 6570       raise excep
+00011c90: 7469 6f6e 732e 4e6f 7453 7570 706f 7274  tions.NotSupport
+00011ca0: 6564 4572 726f 7228 0a20 2020 2020 2020  edError(.       
+00011cb0: 2020 2020 2020 2020 2066 2743 616e 6e6f           f'Canno
+00011cc0: 7420 636c 6f6e 6520 6469 736b 2066 726f  t clone disk fro
+00011cd0: 6d20 6120 6e6f 6e2d 636c 6f75 6420 636c  m a non-cloud cl
+00011ce0: 7573 7465 7220 7b63 6c75 7374 6572 5f6e  uster {cluster_n
+00011cf0: 616d 6521 727d 2e27 290a 0a20 2020 2069  ame!r}.')..    i
+00011d00: 6620 736f 7572 6365 5f63 6c75 7374 6572  f source_cluster
+00011d10: 5f73 7461 7475 7320 213d 2073 7461 7475  _status != statu
+00011d20: 735f 6c69 622e 436c 7573 7465 7253 7461  s_lib.ClusterSta
+00011d30: 7475 732e 5354 4f50 5045 443a 0a20 2020  tus.STOPPED:.   
+00011d40: 2020 2020 2077 6974 6820 7578 5f75 7469       with ux_uti
+00011d50: 6c73 2e70 7269 6e74 5f65 7863 6570 7469  ls.print_excepti
+00011d60: 6f6e 5f6e 6f5f 7472 6163 6562 6163 6b28  on_no_traceback(
+00011d70: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+00011d80: 6169 7365 2065 7863 6570 7469 6f6e 732e  aise exceptions.
+00011d90: 4e6f 7453 7570 706f 7274 6564 4572 726f  NotSupportedErro
+00011da0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+00011db0: 2020 2066 2743 616e 6e6f 7420 636c 6f6e     f'Cannot clon
+00011dc0: 6520 6469 736b 2066 726f 6d20 636c 7573  e disk from clus
+00011dd0: 7465 7220 7b63 6c75 7374 6572 5f6e 616d  ter {cluster_nam
+00011de0: 6521 727d 2027 0a20 2020 2020 2020 2020  e!r} '.         
+00011df0: 2020 2020 2020 2066 2728 7b73 6f75 7263         f'({sourc
+00011e00: 655f 636c 7573 7465 725f 7374 6174 7573  e_cluster_status
+00011e10: 2172 7d29 2e20 506c 6561 7365 2073 746f  !r}). Please sto
+00011e20: 7020 7468 6520 270a 2020 2020 2020 2020  p the '.        
+00011e30: 2020 2020 2020 2020 6627 636c 7573 7465          f'cluste
+00011e40: 7220 6669 7273 743a 2073 6b79 2073 746f  r first: sky sto
+00011e50: 7020 7b63 6c75 7374 6572 5f6e 616d 657d  p {cluster_name}
+00011e60: 2729 0a0a 2020 2020 6966 2074 6172 6765  ')..    if targe
+00011e70: 745f 636c 7573 7465 725f 6e61 6d65 2069  t_cluster_name i
+00011e80: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00011e90: 2020 2020 7461 7267 6574 5f63 6c75 7374      target_clust
+00011ea0: 6572 5f73 7461 7475 732c 205f 203d 2072  er_status, _ = r
+00011eb0: 6566 7265 7368 5f63 6c75 7374 6572 5f73  efresh_cluster_s
+00011ec0: 7461 7475 735f 6861 6e64 6c65 280a 2020  tatus_handle(.  
+00011ed0: 2020 2020 2020 2020 2020 7461 7267 6574            target
+00011ee0: 5f63 6c75 7374 6572 5f6e 616d 6529 0a20  _cluster_name). 
+00011ef0: 2020 2020 2020 2069 6620 7461 7267 6574         if target
+00011f00: 5f63 6c75 7374 6572 5f73 7461 7475 7320  _cluster_status 
+00011f10: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00011f20: 2020 2020 2020 2020 2077 6974 6820 7578           with ux
+00011f30: 5f75 7469 6c73 2e70 7269 6e74 5f65 7863  _utils.print_exc
+00011f40: 6570 7469 6f6e 5f6e 6f5f 7472 6163 6562  eption_no_traceb
+00011f50: 6163 6b28 293a 0a20 2020 2020 2020 2020  ack():.         
+00011f60: 2020 2020 2020 2072 6169 7365 2065 7863         raise exc
+00011f70: 6570 7469 6f6e 732e 4e6f 7453 7570 706f  eptions.NotSuppo
+00011f80: 7274 6564 4572 726f 7228 0a20 2020 2020  rtedError(.     
+00011f90: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00011fa0: 2754 6865 2074 6172 6765 7420 636c 7573  'The target clus
+00011fb0: 7465 7220 7b74 6172 6765 745f 636c 7573  ter {target_clus
+00011fc0: 7465 725f 6e61 6d65 2172 7d20 616c 7265  ter_name!r} alre
+00011fd0: 6164 7920 6578 6973 7473 2e20 436c 6f6e  ady exists. Clon
+00011fe0: 696e 6720 270a 2020 2020 2020 2020 2020  ing '.          
+00011ff0: 2020 2020 2020 2020 2020 2764 6973 6b20            'disk 
+00012000: 6973 206f 6e6c 7920 7375 7070 6f72 7465  is only supporte
+00012010: 6420 7768 656e 2063 7265 6174 696e 6720  d when creating 
+00012020: 6120 6e65 7720 636c 7573 7465 722e 2054  a new cluster. T
+00012030: 6f20 6669 783a 2073 7065 6369 6679 2027  o fix: specify '
+00012040: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012050: 2020 2020 2027 6120 6e65 7720 7461 7267       'a new targ
+00012060: 6574 2063 6c75 7374 6572 206e 616d 652e  et cluster name.
+00012070: 2729 0a0a 2020 2020 6e65 775f 7461 736b  ')..    new_task
+00012080: 5f72 6573 6f75 7263 6573 203d 205b 5d0a  _resources = [].
+00012090: 2020 2020 6f72 6967 696e 616c 5f63 6c6f      original_clo
+000120a0: 7564 203d 2068 616e 646c 652e 6c61 756e  ud = handle.laun
+000120b0: 6368 6564 5f72 6573 6f75 7263 6573 2e63  ched_resources.c
+000120c0: 6c6f 7564 0a20 2020 206f 7269 6769 6e61  loud.    origina
+000120d0: 6c5f 636c 6f75 642e 6368 6563 6b5f 6665  l_cloud.check_fe
+000120e0: 6174 7572 6573 5f61 7265 5f73 7570 706f  atures_are_suppo
+000120f0: 7274 6564 280a 2020 2020 2020 2020 6861  rted(.        ha
+00012100: 6e64 6c65 2e6c 6175 6e63 6865 645f 7265  ndle.launched_re
+00012110: 736f 7572 6365 732c 0a20 2020 2020 2020  sources,.       
+00012120: 207b 636c 6f75 6473 2e43 6c6f 7564 496d   {clouds.CloudIm
+00012130: 706c 656d 656e 7461 7469 6f6e 4665 6174  plementationFeat
+00012140: 7572 6573 2e43 4c4f 4e45 5f44 4953 4b5f  ures.CLONE_DISK_
+00012150: 4652 4f4d 5f43 4c55 5354 4552 7d29 0a0a  FROM_CLUSTER})..
+00012160: 2020 2020 6173 7365 7274 206f 7269 6769      assert origi
+00012170: 6e61 6c5f 636c 6f75 6420 6973 206e 6f74  nal_cloud is not
+00012180: 204e 6f6e 652c 2068 616e 646c 652e 6c61   None, handle.la
+00012190: 756e 6368 6564 5f72 6573 6f75 7263 6573  unched_resources
+000121a0: 0a20 2020 2068 6173 5f6f 7665 7272 6964  .    has_overrid
+000121b0: 6520 3d20 4661 6c73 650a 2020 2020 6861  e = False.    ha
+000121c0: 735f 6469 736b 5f73 697a 655f 6d65 7420  s_disk_size_met 
+000121d0: 3d20 4661 6c73 650a 2020 2020 6861 735f  = False.    has_
+000121e0: 636c 6f75 645f 6d65 7420 3d20 4661 6c73  cloud_met = Fals
+000121f0: 650a 2020 2020 666f 7220 7461 736b 5f72  e.    for task_r
+00012200: 6573 6f75 7263 6573 2069 6e20 7461 736b  esources in task
+00012210: 2e72 6573 6f75 7263 6573 3a0a 2020 2020  .resources:.    
+00012220: 2020 2020 6966 2068 616e 646c 652e 6c61      if handle.la
+00012230: 756e 6368 6564 5f72 6573 6f75 7263 6573  unched_resources
+00012240: 2e64 6973 6b5f 7369 7a65 203e 2074 6173  .disk_size > tas
+00012250: 6b5f 7265 736f 7572 6365 732e 6469 736b  k_resources.disk
+00012260: 5f73 697a 653a 0a20 2020 2020 2020 2020  _size:.         
+00012270: 2020 2023 2054 6865 2074 6172 6765 7420     # The target 
+00012280: 636c 7573 7465 7227 7320 6469 736b 2073  cluster's disk s
+00012290: 686f 756c 6420 6265 2061 7420 6c65 6173  hould be at leas
+000122a0: 7420 6173 206c 6172 6765 2061 7320 7468  t as large as th
+000122b0: 6520 736f 7572 6365 2e0a 2020 2020 2020  e source..      
+000122c0: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
+000122d0: 2020 2020 2020 2068 6173 5f64 6973 6b5f         has_disk_
+000122e0: 7369 7a65 5f6d 6574 203d 2054 7275 650a  size_met = True.
+000122f0: 2020 2020 2020 2020 6966 2074 6173 6b5f          if task_
+00012300: 7265 736f 7572 6365 732e 636c 6f75 6420  resources.cloud 
+00012310: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
+00012320: 6e6f 7420 6f72 6967 696e 616c 5f63 6c6f  not original_clo
+00012330: 7564 2e69 735f 7361 6d65 5f63 6c6f 7564  ud.is_same_cloud
+00012340: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00012350: 2020 7461 736b 5f72 6573 6f75 7263 6573    task_resources
+00012360: 2e63 6c6f 7564 293a 0a20 2020 2020 2020  .cloud):.       
+00012370: 2020 2020 2063 6f6e 7469 6e75 650a 2020       continue.  
+00012380: 2020 2020 2020 6861 735f 636c 6f75 645f        has_cloud_
+00012390: 6d65 7420 3d20 5472 7565 0a0a 2020 2020  met = True..    
+000123a0: 2020 2020 6f76 6572 7269 6465 5f70 6172      override_par
+000123b0: 616d 203d 207b 7d0a 2020 2020 2020 2020  am = {}.        
+000123c0: 6966 2074 6173 6b5f 7265 736f 7572 6365  if task_resource
+000123d0: 732e 636c 6f75 6420 6973 204e 6f6e 653a  s.cloud is None:
+000123e0: 0a20 2020 2020 2020 2020 2020 206f 7665  .            ove
+000123f0: 7272 6964 655f 7061 7261 6d5b 2763 6c6f  rride_param['clo
+00012400: 7564 275d 203d 206f 7269 6769 6e61 6c5f  ud'] = original_
+00012410: 636c 6f75 640a 2020 2020 2020 2020 6966  cloud.        if
+00012420: 2074 6173 6b5f 7265 736f 7572 6365 732e   task_resources.
+00012430: 7265 6769 6f6e 2069 7320 4e6f 6e65 3a0a  region is None:.
+00012440: 2020 2020 2020 2020 2020 2020 6f76 6572              over
+00012450: 7269 6465 5f70 6172 616d 5b27 7265 6769  ride_param['regi
+00012460: 6f6e 275d 203d 2068 616e 646c 652e 6c61  on'] = handle.la
+00012470: 756e 6368 6564 5f72 6573 6f75 7263 6573  unched_resources
+00012480: 2e72 6567 696f 6e0a 0a20 2020 2020 2020  .region..       
+00012490: 2069 6620 6f76 6572 7269 6465 5f70 6172   if override_par
+000124a0: 616d 3a0a 2020 2020 2020 2020 2020 2020  am:.            
+000124b0: 6c6f 6767 6572 2e69 6e66 6f28 0a20 2020  logger.info(.   
+000124c0: 2020 2020 2020 2020 2020 2020 2066 274e               f'N
+000124d0: 6f20 636c 6f75 642f 7265 6769 6f6e 2073  o cloud/region s
+000124e0: 7065 6369 6669 6564 2066 6f72 2074 6865  pecified for the
+000124f0: 2074 6173 6b20 7b74 6173 6b5f 7265 736f   task {task_reso
+00012500: 7572 6365 737d 2e20 5573 696e 6720 7468  urces}. Using th
+00012510: 6520 7361 6d65 2072 6567 696f 6e20 270a  e same region '.
+00012520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012530: 6627 6173 2073 6f75 7263 6520 636c 7573  f'as source clus
+00012540: 7465 7220 7b63 6c75 7374 6572 5f6e 616d  ter {cluster_nam
+00012550: 6521 727d 3a20 270a 2020 2020 2020 2020  e!r}: '.        
+00012560: 2020 2020 2020 2020 6627 7b68 616e 646c          f'{handl
+00012570: 652e 6c61 756e 6368 6564 5f72 6573 6f75  e.launched_resou
+00012580: 7263 6573 2e63 6c6f 7564 7d27 0a20 2020  rces.cloud}'.   
+00012590: 2020 2020 2020 2020 2020 2020 2066 2728               f'(
+000125a0: 7b68 616e 646c 652e 6c61 756e 6368 6564  {handle.launched
+000125b0: 5f72 6573 6f75 7263 6573 2e72 6567 696f  _resources.regio
+000125c0: 6e7d 292e 2729 0a20 2020 2020 2020 2020  n}).').         
+000125d0: 2020 2068 6173 5f6f 7665 7272 6964 6520     has_override 
+000125e0: 3d20 5472 7565 0a20 2020 2020 2020 2074  = True.        t
+000125f0: 6173 6b5f 7265 736f 7572 6365 7320 3d20  ask_resources = 
+00012600: 7461 736b 5f72 6573 6f75 7263 6573 2e63  task_resources.c
+00012610: 6f70 7928 2a2a 6f76 6572 7269 6465 5f70  opy(**override_p
+00012620: 6172 616d 290a 2020 2020 2020 2020 6e65  aram).        ne
+00012630: 775f 7461 736b 5f72 6573 6f75 7263 6573  w_task_resources
+00012640: 2e61 7070 656e 6428 7461 736b 5f72 6573  .append(task_res
+00012650: 6f75 7263 6573 290a 0a20 2020 2069 6620  ources)..    if 
+00012660: 6e6f 7420 6e65 775f 7461 736b 5f72 6573  not new_task_res
+00012670: 6f75 7263 6573 3a0a 2020 2020 2020 2020  ources:.        
+00012680: 6966 206e 6f74 2068 6173 5f64 6973 6b5f  if not has_disk_
+00012690: 7369 7a65 5f6d 6574 3a0a 2020 2020 2020  size_met:.      
+000126a0: 2020 2020 2020 7769 7468 2075 785f 7574        with ux_ut
+000126b0: 696c 732e 7072 696e 745f 6578 6365 7074  ils.print_except
+000126c0: 696f 6e5f 6e6f 5f74 7261 6365 6261 636b  ion_no_traceback
+000126d0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+000126e0: 2020 2020 7461 7267 6574 5f63 6c75 7374      target_clust
+000126f0: 6572 5f6e 616d 655f 7374 7220 3d20 6627  er_name_str = f'
+00012700: 207b 7461 7267 6574 5f63 6c75 7374 6572   {target_cluster
+00012710: 5f6e 616d 6521 727d 270a 2020 2020 2020  _name!r}'.      
+00012720: 2020 2020 2020 2020 2020 6966 2074 6172            if tar
+00012730: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+00012740: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00012750: 2020 2020 2020 2020 2020 2020 2020 7461                ta
+00012760: 7267 6574 5f63 6c75 7374 6572 5f6e 616d  rget_cluster_nam
+00012770: 655f 7374 7220 3d20 2727 0a20 2020 2020  e_str = ''.     
+00012780: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00012790: 2065 7863 6570 7469 6f6e 732e 4e6f 7453   exceptions.NotS
+000127a0: 7570 706f 7274 6564 4572 726f 7228 0a20  upportedError(. 
+000127b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000127c0: 2020 2066 2754 6865 2074 6172 6765 7420     f'The target 
+000127d0: 636c 7573 7465 727b 7461 7267 6574 5f63  cluster{target_c
+000127e0: 6c75 7374 6572 5f6e 616d 655f 7374 727d  luster_name_str}
+000127f0: 2073 686f 756c 6420 6861 7665 2061 2064   should have a d
+00012800: 6973 6b20 7369 7a65 2027 0a20 2020 2020  isk size '.     
+00012810: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00012820: 276f 6620 6174 206c 6561 7374 207b 6861  'of at least {ha
+00012830: 6e64 6c65 2e6c 6175 6e63 6865 645f 7265  ndle.launched_re
+00012840: 736f 7572 6365 732e 6469 736b 5f73 697a  sources.disk_siz
+00012850: 657d 2047 4220 746f 2063 6c6f 6e65 2074  e} GB to clone t
+00012860: 6865 2027 0a20 2020 2020 2020 2020 2020  he '.           
+00012870: 2020 2020 2020 2020 2066 2764 6973 6b20           f'disk 
+00012880: 6672 6f6d 207b 636c 7573 7465 725f 6e61  from {cluster_na
+00012890: 6d65 2172 7d2e 2729 0a20 2020 2020 2020  me!r}.').       
+000128a0: 2069 6620 6e6f 7420 6861 735f 636c 6f75   if not has_clou
+000128b0: 645f 6d65 743a 0a20 2020 2020 2020 2020  d_met:.         
+000128c0: 2020 2074 6173 6b5f 7265 736f 7572 6365     task_resource
+000128d0: 735f 636c 6f75 645f 7374 7220 3d20 275b  s_cloud_str = '[
+000128e0: 2720 2b20 272c 272e 6a6f 696e 280a 2020  ' + ','.join(.  
+000128f0: 2020 2020 2020 2020 2020 2020 2020 5b66                [f
+00012900: 277b 7265 732e 636c 6f75 647d 2720 666f  '{res.cloud}' fo
+00012910: 7220 7265 7320 696e 2074 6173 6b2e 7265  r res in task.re
+00012920: 736f 7572 6365 735d 2920 2b20 275d 270a  sources]) + ']'.
+00012930: 2020 2020 2020 2020 2020 2020 7461 736b              task
+00012940: 5f72 6573 6f75 7263 6573 5f73 7472 203d  _resources_str =
+00012950: 2027 5b27 202b 2027 2c27 2e6a 6f69 6e28   '[' + ','.join(
+00012960: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012970: 205b 6627 7b72 6573 7d27 2066 6f72 2072   [f'{res}' for r
+00012980: 6573 2069 6e20 7461 736b 2e72 6573 6f75  es in task.resou
+00012990: 7263 6573 5d29 202b 2027 5d27 0a20 2020  rces]) + ']'.   
+000129a0: 2020 2020 2020 2020 2077 6974 6820 7578           with ux
+000129b0: 5f75 7469 6c73 2e70 7269 6e74 5f65 7863  _utils.print_exc
+000129c0: 6570 7469 6f6e 5f6e 6f5f 7472 6163 6562  eption_no_traceb
+000129d0: 6163 6b28 293a 0a20 2020 2020 2020 2020  ack():.         
+000129e0: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+000129f0: 7565 4572 726f 7228 0a20 2020 2020 2020  ueError(.       
+00012a00: 2020 2020 2020 2020 2020 2020 2066 2743               f'C
+00012a10: 616e 6e6f 7420 636c 6f6e 6520 6469 736b  annot clone disk
+00012a20: 2061 6372 6f73 7320 636c 6f75 6420 6672   across cloud fr
+00012a30: 6f6d 207b 6f72 6967 696e 616c 5f63 6c6f  om {original_clo
+00012a40: 7564 7d20 746f 2027 0a20 2020 2020 2020  ud} to '.       
+00012a50: 2020 2020 2020 2020 2020 2020 2066 277b               f'{
+00012a60: 7461 736b 5f72 6573 6f75 7263 6573 5f63  task_resources_c
+00012a70: 6c6f 7564 5f73 7472 7d20 666f 7220 7265  loud_str} for re
+00012a80: 736f 7572 6365 7320 7b74 6173 6b5f 7265  sources {task_re
+00012a90: 736f 7572 6365 735f 7374 727d 2e27 0a20  sources_str}.'. 
+00012aa0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00012ab0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00012ac0: 4661 6c73 652c 2027 5368 6f75 6c64 206e  False, 'Should n
+00012ad0: 6f74 2072 6561 6368 2068 6572 652e 270a  ot reach here.'.
+00012ae0: 2020 2020 2320 7365 7420 7468 6520 6e65      # set the ne
+00012af0: 775f 7461 736b 5f72 6573 6f75 7263 6573  w_task_resources
+00012b00: 2074 6f20 6265 2074 6865 2073 616d 6520   to be the same 
+00012b10: 7479 7065 2028 6c69 7374 206f 7220 7365  type (list or se
+00012b20: 7429 2061 7320 7468 650a 2020 2020 2320  t) as the.    # 
+00012b30: 6f72 6967 696e 616c 2074 6173 6b2e 7265  original task.re
+00012b40: 736f 7572 6365 730a 2020 2020 6966 2068  sources.    if h
+00012b50: 6173 5f6f 7665 7272 6964 653a 0a20 2020  as_override:.   
+00012b60: 2020 2020 2074 6173 6b2e 7365 745f 7265       task.set_re
+00012b70: 736f 7572 6365 7328 7479 7065 2874 6173  sources(type(tas
+00012b80: 6b2e 7265 736f 7572 6365 7329 286e 6577  k.resources)(new
+00012b90: 5f74 6173 6b5f 7265 736f 7572 6365 7329  _task_resources)
+00012ba0: 290a 2020 2020 2020 2020 2320 5265 7365  ).        # Rese
+00012bb0: 7420 7468 6520 6265 7374 5f72 6573 6f75  t the best_resou
+00012bc0: 7263 6573 2074 6f20 7472 6967 6572 2072  rces to triger r
+00012bd0: 652d 6f70 7469 6d69 7a61 7469 6f6e 0a20  e-optimization. 
+00012be0: 2020 2020 2020 2023 206c 6174 6572 2c20         # later, 
+00012bf0: 736f 2074 6861 7420 7468 6520 6e65 7720  so that the new 
+00012c00: 7461 736b 5f72 6573 6f75 7263 6573 2077  task_resources w
+00012c10: 696c 6c20 6265 2075 7365 642e 0a20 2020  ill be used..   
+00012c20: 2020 2020 2074 6173 6b2e 6265 7374 5f72       task.best_r
+00012c30: 6573 6f75 7263 6573 203d 204e 6f6e 650a  esources = None.
+00012c40: 2020 2020 7265 7475 726e 2074 6173 6b2c      return task,
+00012c50: 2068 616e 646c 650a 0a0a 6465 6620 5f75   handle...def _u
+00012c60: 7064 6174 655f 636c 7573 7465 725f 7374  pdate_cluster_st
+00012c70: 6174 7573 5f6e 6f5f 6c6f 636b 280a 2020  atus_no_lock(.  
+00012c80: 2020 2020 2020 636c 7573 7465 725f 6e61        cluster_na
+00012c90: 6d65 3a20 7374 7229 202d 3e20 4f70 7469  me: str) -> Opti
+00012ca0: 6f6e 616c 5b44 6963 745b 7374 722c 2041  onal[Dict[str, A
+00012cb0: 6e79 5d5d 3a0a 2020 2020 2222 2255 7064  ny]]:.    """Upd
+00012cc0: 6174 6573 2074 6865 2073 7461 7475 7320  ates the status 
+00012cd0: 6f66 2074 6865 2063 6c75 7374 6572 2e0a  of the cluster..
+00012ce0: 0a20 2020 2052 6169 7365 733a 0a20 2020  .    Raises:.   
+00012cf0: 2020 2020 2065 7863 6570 7469 6f6e 732e       exceptions.
+00012d00: 436c 7573 7465 7253 7461 7475 7346 6574  ClusterStatusFet
+00012d10: 6368 696e 6745 7272 6f72 3a20 7468 6520  chingError: the 
+00012d20: 636c 7573 7465 7220 7374 6174 7573 2063  cluster status c
+00012d30: 616e 6e6f 7420 6265 0a20 2020 2020 2020  annot be.       
+00012d40: 2020 2066 6574 6368 6564 2066 726f 6d20     fetched from 
+00012d50: 7468 6520 636c 6f75 6420 7072 6f76 6964  the cloud provid
+00012d60: 6572 2e0a 2020 2020 2222 220a 2020 2020  er..    """.    
+00012d70: 7265 636f 7264 203d 2067 6c6f 6261 6c5f  record = global_
+00012d80: 7573 6572 5f73 7461 7465 2e67 6574 5f63  user_state.get_c
+00012d90: 6c75 7374 6572 5f66 726f 6d5f 6e61 6d65  luster_from_name
+00012da0: 2863 6c75 7374 6572 5f6e 616d 6529 0a20  (cluster_name). 
+00012db0: 2020 2069 6620 7265 636f 7264 2069 7320     if record is 
+00012dc0: 4e6f 6e65 3a0a 2020 2020 2020 2020 7265  None:.        re
+00012dd0: 7475 726e 204e 6f6e 650a 2020 2020 6861  turn None.    ha
+00012de0: 6e64 6c65 203d 2072 6563 6f72 645b 2768  ndle = record['h
+00012df0: 616e 646c 6527 5d0a 2020 2020 6966 206e  andle'].    if n
+00012e00: 6f74 2069 7369 6e73 7461 6e63 6528 6861  ot isinstance(ha
+00012e10: 6e64 6c65 2c20 6261 636b 656e 6473 2e43  ndle, backends.C
+00012e20: 6c6f 7564 566d 5261 7952 6573 6f75 7263  loudVmRayResourc
+00012e30: 6548 616e 646c 6529 3a0a 2020 2020 2020  eHandle):.      
+00012e40: 2020 7265 7475 726e 2072 6563 6f72 640a    return record.
+00012e50: 2020 2020 636c 7573 7465 725f 6e61 6d65      cluster_name
+00012e60: 203d 2068 616e 646c 652e 636c 7573 7465   = handle.cluste
+00012e70: 725f 6e61 6d65 0a0a 2020 2020 6e6f 6465  r_name..    node
+00012e80: 5f73 7461 7475 7365 7320 3d20 5f71 7565  _statuses = _que
+00012e90: 7279 5f63 6c75 7374 6572 5f73 7461 7475  ry_cluster_statu
+00012ea0: 735f 7669 615f 636c 6f75 645f 6170 6928  s_via_cloud_api(
+00012eb0: 6861 6e64 6c65 290a 0a20 2020 2061 6c6c  handle)..    all
+00012ec0: 5f6e 6f64 6573 5f75 7020 3d20 2861 6c6c  _nodes_up = (all
+00012ed0: 280a 2020 2020 2020 2020 7374 6174 7573  (.        status
+00012ee0: 203d 3d20 7374 6174 7573 5f6c 6962 2e43   == status_lib.C
+00012ef0: 6c75 7374 6572 5374 6174 7573 2e55 5020  lusterStatus.UP 
+00012f00: 666f 7220 7374 6174 7573 2069 6e20 6e6f  for status in no
+00012f10: 6465 5f73 7461 7475 7365 7329 2061 6e64  de_statuses) and
+00012f20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012f30: 2020 2020 206c 656e 286e 6f64 655f 7374       len(node_st
+00012f40: 6174 7573 6573 2920 3d3d 2068 616e 646c  atuses) == handl
+00012f50: 652e 6c61 756e 6368 6564 5f6e 6f64 6573  e.launched_nodes
+00012f60: 290a 0a20 2020 2064 6566 2072 756e 5f72  )..    def run_r
+00012f70: 6179 5f73 7461 7475 735f 746f 5f63 6865  ay_status_to_che
+00012f80: 636b 5f72 6179 5f63 6c75 7374 6572 5f68  ck_ray_cluster_h
+00012f90: 6561 6c74 6879 2829 202d 3e20 626f 6f6c  ealthy() -> bool
+00012fa0: 3a0a 2020 2020 2020 2020 7472 793a 0a20  :.        try:. 
+00012fb0: 2020 2020 2020 2020 2020 2023 204e 4f54             # NOT
+00012fc0: 453a 2066 6574 6368 696e 6720 7468 6520  E: fetching the 
+00012fd0: 4950 7320 6973 2076 6572 7920 736c 6f77  IPs is very slow
+00012fe0: 2061 7320 6974 2063 616c 6c73 2069 6e74   as it calls int
+00012ff0: 6f0a 2020 2020 2020 2020 2020 2020 2320  o.            # 
+00013000: 6072 6179 2067 6574 2068 6561 642d 6970  `ray get head-ip
+00013010: 2f77 6f72 6b65 722d 6970 7360 2e20 5573  /worker-ips`. Us
+00013020: 696e 6720 6361 6368 6564 2049 5073 2069  ing cached IPs i
+00013030: 7320 7361 6665 2062 6563 6175 7365 0a20  s safe because. 
+00013040: 2020 2020 2020 2020 2020 2023 2069 6e20             # in 
+00013050: 7468 6520 776f 7273 7420 6361 7365 2077  the worst case w
+00013060: 6520 7469 6d65 206f 7574 2069 6e20 7468  e time out in th
+00013070: 6520 6072 6179 2073 7461 7475 7360 2053  e `ray status` S
+00013080: 5348 2063 6f6d 6d61 6e64 0a20 2020 2020  SH command.     
+00013090: 2020 2020 2020 2023 2062 656c 6f77 2e0a         # below..
+000130a0: 2020 2020 2020 2020 2020 2020 7275 6e6e              runn
+000130b0: 6572 7320 3d20 6861 6e64 6c65 2e67 6574  ers = handle.get
+000130c0: 5f63 6f6d 6d61 6e64 5f72 756e 6e65 7273  _command_runners
+000130d0: 2866 6f72 6365 5f63 6163 6865 643d 5472  (force_cached=Tr
+000130e0: 7565 290a 2020 2020 2020 2020 2020 2020  ue).            
+000130f0: 2320 5468 6973 2068 6170 7065 6e73 2077  # This happens w
+00013100: 6865 6e20 7573 6572 2069 6e74 6572 7275  hen user interru
+00013110: 7074 2074 6865 2060 736b 7920 6c61 756e  pt the `sky laun
+00013120: 6368 6020 7072 6f63 6573 7320 6265 666f  ch` process befo
+00013130: 7265 0a20 2020 2020 2020 2020 2020 2023  re.            #
+00013140: 2074 6865 2066 6972 7374 2074 696d 6520   the first time 
+00013150: 7265 736f 7572 6365 7320 6861 6e64 6c65  resources handle
+00013160: 2069 7320 7772 6974 7465 6e20 6261 636b   is written back
+00013170: 2074 6f20 6c6f 6361 6c20 6461 7461 6261   to local databa
+00013180: 7365 2e0a 2020 2020 2020 2020 2020 2020  se..            
+00013190: 2320 5468 6973 2069 7320 6865 6c70 6675  # This is helpfu
+000131a0: 6c20 7768 656e 2075 7365 7220 696e 7465  l when user inte
+000131b0: 7272 7570 7420 6166 7465 7220 7468 6520  rrupt after the 
+000131c0: 7072 6f76 6973 696f 6e20 6973 2064 6f6e  provision is don
+000131d0: 650a 2020 2020 2020 2020 2020 2020 2320  e.            # 
+000131e0: 616e 6420 6265 666f 7265 2074 6865 2073  and before the s
+000131f0: 6b79 6c65 7420 6973 2072 6573 7461 7274  kylet is restart
+00013200: 6564 2e20 4166 7465 7220 2332 3330 3420  ed. After #2304 
+00013210: 6973 206d 6572 6765 642c 2074 6869 730a  is merged, this.
+00013220: 2020 2020 2020 2020 2020 2020 2320 6865              # he
+00013230: 6c70 7320 6b65 6570 2074 6865 2063 6c75  lps keep the clu
+00013240: 7374 6572 2073 7461 7475 7320 746f 2049  ster status to I
+00013250: 4e49 5420 6166 7465 7220 6073 6b79 2073  NIT after `sky s
+00013260: 7461 7475 7320 2d72 602c 2073 6f0a 2020  tatus -r`, so.  
+00013270: 2020 2020 2020 2020 2020 2320 7573 6572            # user
+00013280: 2077 696c 6c20 6265 206e 6f74 6966 6965   will be notifie
+00013290: 6420 7468 6174 2061 6e79 2061 7574 6f20  d that any auto 
+000132a0: 7374 6f70 2f64 6f77 6e20 6d69 6768 7420  stop/down might 
+000132b0: 6e6f 7420 6265 0a20 2020 2020 2020 2020  not be.         
+000132c0: 2020 2023 2074 7269 6767 6572 6564 2e0a     # triggered..
+000132d0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+000132e0: 6f74 2072 756e 6e65 7273 3a0a 2020 2020  ot runners:.    
+000132f0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+00013300: 6572 2e64 6562 7567 2866 2752 6566 7265  er.debug(f'Refre
+00013310: 7368 696e 6720 7374 6174 7573 2028 7b63  shing status ({c
+00013320: 6c75 7374 6572 5f6e 616d 6521 727d 293a  luster_name!r}):
+00013330: 204e 6f20 6361 6368 6564 2027 0a20 2020   No cached '.   
+00013340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013350: 2020 2020 2020 2020 2020 6627 4950 7320            f'IPs 
+00013360: 666f 756e 642e 2048 616e 646c 653a 207b  found. Handle: {
+00013370: 6861 6e64 6c65 7d27 290a 2020 2020 2020  handle}').      
+00013380: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00013390: 6578 6365 7074 696f 6e73 2e46 6574 6368  exceptions.Fetch
+000133a0: 436c 7573 7465 7249 6e66 6f45 7272 6f72  ClusterInfoError
+000133b0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000133c0: 2020 2020 2020 7265 6173 6f6e 3d65 7863        reason=exc
+000133d0: 6570 7469 6f6e 732e 4665 7463 6843 6c75  eptions.FetchClu
+000133e0: 7374 6572 496e 666f 4572 726f 722e 5265  sterInfoError.Re
+000133f0: 6173 6f6e 2e48 4541 4429 0a20 2020 2020  ason.HEAD).     
+00013400: 2020 2020 2020 2068 6561 645f 7275 6e6e         head_runn
+00013410: 6572 203d 2072 756e 6e65 7273 5b30 5d0a  er = runners[0].
+00013420: 2020 2020 2020 2020 2020 2020 7263 2c20              rc, 
+00013430: 6f75 7470 7574 2c20 7374 6465 7272 203d  output, stderr =
+00013440: 2068 6561 645f 7275 6e6e 6572 2e72 756e   head_runner.run
+00013450: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00013460: 2020 696e 7374 616e 6365 5f73 6574 7570    instance_setup
+00013470: 2e52 4159 5f53 5441 5455 535f 5749 5448  .RAY_STATUS_WITH
+00013480: 5f53 4b59 5f52 4159 5f50 4f52 545f 434f  _SKY_RAY_PORT_CO
+00013490: 4d4d 414e 442c 0a20 2020 2020 2020 2020  MMAND,.         
+000134a0: 2020 2020 2020 2073 7472 6561 6d5f 6c6f         stream_lo
+000134b0: 6773 3d46 616c 7365 2c0a 2020 2020 2020  gs=False,.      
+000134c0: 2020 2020 2020 2020 2020 7265 7175 6972            requir
+000134d0: 655f 6f75 7470 7574 733d 5472 7565 2c0a  e_outputs=True,.
+000134e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000134f0: 7365 7061 7261 7465 5f73 7464 6572 723d  separate_stderr=
+00013500: 5472 7565 290a 2020 2020 2020 2020 2020  True).          
+00013510: 2020 6966 2072 633a 0a20 2020 2020 2020    if rc:.       
+00013520: 2020 2020 2020 2020 2072 6169 7365 2052           raise R
+00013530: 756e 7469 6d65 4572 726f 7228 0a20 2020  untimeError(.   
+00013540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013550: 2066 2752 6566 7265 7368 696e 6720 7374   f'Refreshing st
+00013560: 6174 7573 2028 7b63 6c75 7374 6572 5f6e  atus ({cluster_n
+00013570: 616d 6521 727d 293a 2046 6169 6c65 6420  ame!r}): Failed 
+00013580: 746f 2063 6865 636b 2027 0a20 2020 2020  to check '.     
+00013590: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000135a0: 2772 6179 2063 6c75 7374 6572 5c27 7320  'ray cluster\'s 
+000135b0: 6865 616c 7468 696e 6573 7320 7769 7468  healthiness with
+000135c0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+000135d0: 2020 2020 2020 2066 277b 696e 7374 616e         f'{instan
+000135e0: 6365 5f73 6574 7570 2e52 4159 5f53 5441  ce_setup.RAY_STA
+000135f0: 5455 535f 5749 5448 5f53 4b59 5f52 4159  TUS_WITH_SKY_RAY
+00013600: 5f50 4f52 545f 434f 4d4d 414e 447d 2e5c  _PORT_COMMAND}.\
+00013610: 6e27 0a20 2020 2020 2020 2020 2020 2020  n'.             
+00013620: 2020 2020 2020 2066 272d 2d20 7374 646f         f'-- stdo
+00013630: 7574 202d 2d5c 6e7b 6f75 7470 7574 7d5c  ut --\n{output}\
+00013640: 6e2d 2d20 7374 6465 7272 202d 2d5c 6e7b  n-- stderr --\n{
+00013650: 7374 6465 7272 7d27 290a 0a20 2020 2020  stderr}')..     
+00013660: 2020 2020 2020 2072 6561 6479 5f68 6561         ready_hea
+00013670: 642c 2072 6561 6479 5f77 6f72 6b65 7273  d, ready_workers
+00013680: 203d 205f 636f 756e 745f 6865 616c 7468   = _count_health
+00013690: 795f 6e6f 6465 735f 6672 6f6d 5f72 6179  y_nodes_from_ray
+000136a0: 286f 7574 7075 7429 0a20 2020 2020 2020  (output).       
+000136b0: 2020 2020 2074 6f74 616c 5f6e 6f64 6573       total_nodes
+000136c0: 203d 2068 616e 646c 652e 6c61 756e 6368   = handle.launch
+000136d0: 6564 5f6e 6f64 6573 202a 2068 616e 646c  ed_nodes * handl
+000136e0: 652e 6e75 6d5f 6970 735f 7065 725f 6e6f  e.num_ips_per_no
+000136f0: 6465 0a20 2020 2020 2020 2020 2020 2069  de.            i
+00013700: 6620 7265 6164 795f 6865 6164 202b 2072  f ready_head + r
+00013710: 6561 6479 5f77 6f72 6b65 7273 203d 3d20  eady_workers == 
+00013720: 746f 7461 6c5f 6e6f 6465 733a 0a20 2020  total_nodes:.   
+00013730: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00013740: 7572 6e20 5472 7565 0a20 2020 2020 2020  urn True.       
+00013750: 2020 2020 2072 6169 7365 2052 756e 7469       raise Runti
+00013760: 6d65 4572 726f 7228 0a20 2020 2020 2020  meError(.       
+00013770: 2020 2020 2020 2020 2066 2752 6566 7265           f'Refre
+00013780: 7368 696e 6720 7374 6174 7573 2028 7b63  shing status ({c
+00013790: 6c75 7374 6572 5f6e 616d 6521 727d 293a  luster_name!r}):
+000137a0: 2072 6179 2073 7461 7475 7320 6e6f 7420   ray status not 
+000137b0: 7368 6f77 696e 6720 270a 2020 2020 2020  showing '.      
+000137c0: 2020 2020 2020 2020 2020 6627 616c 6c20            f'all 
+000137d0: 6e6f 6465 7320 287b 7265 6164 795f 6865  nodes ({ready_he
+000137e0: 6164 202b 2072 6561 6479 5f77 6f72 6b65  ad + ready_worke
+000137f0: 7273 7d2f 270a 2020 2020 2020 2020 2020  rs}/'.          
+00013800: 2020 2020 2020 6627 7b74 6f74 616c 5f6e        f'{total_n
+00013810: 6f64 6573 7d29 3b20 6f75 7470 7574 3a20  odes}); output: 
+00013820: 7b6f 7574 7075 747d 3b20 7374 6465 7272  {output}; stderr
+00013830: 3a20 7b73 7464 6572 727d 2729 0a20 2020  : {stderr}').   
+00013840: 2020 2020 2065 7863 6570 7420 6578 6365       except exce
+00013850: 7074 696f 6e73 2e46 6574 6368 436c 7573  ptions.FetchClus
+00013860: 7465 7249 6e66 6f45 7272 6f72 3a0a 2020  terInfoError:.  
+00013870: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+00013880: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
+00013890: 2020 2020 2020 2020 6627 5265 6672 6573          f'Refres
+000138a0: 6869 6e67 2073 7461 7475 7320 287b 636c  hing status ({cl
+000138b0: 7573 7465 725f 6e61 6d65 2172 7d29 2066  uster_name!r}) f
+000138c0: 6169 6c65 6420 746f 2067 6574 2049 5073  ailed to get IPs
+000138d0: 2e27 290a 2020 2020 2020 2020 6578 6365  .').        exce
+000138e0: 7074 2052 756e 7469 6d65 4572 726f 7220  pt RuntimeError 
+000138f0: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
+00013900: 2020 6c6f 6767 6572 2e64 6562 7567 2873    logger.debug(s
+00013910: 7472 2865 2929 0a20 2020 2020 2020 2065  tr(e)).        e
+00013920: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
+00013930: 6173 2065 3a20 2023 2070 796c 696e 743a  as e:  # pylint:
+00013940: 2064 6973 6162 6c65 3d62 726f 6164 2d65   disable=broad-e
+00013950: 7863 6570 740a 2020 2020 2020 2020 2020  xcept.          
+00013960: 2020 2320 5468 6973 2063 616e 2062 6520    # This can be 
+00013970: 7261 6973 6564 2062 7920 6065 7874 6572  raised by `exter
+00013980: 6e61 6c5f 7373 685f 706f 7274 7328 2960  nal_ssh_ports()`
+00013990: 2c20 6475 6520 746f 2074 6865 0a20 2020  , due to the.   
+000139a0: 2020 2020 2020 2020 2023 2075 6e64 6572           # under
+000139b0: 6c79 696e 6720 6361 6c6c 2074 6f20 6b75  lying call to ku
+000139c0: 6265 726e 6574 6573 2041 5049 2e0a 2020  bernetes API..  
+000139d0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+000139e0: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
+000139f0: 2020 2020 2020 2020 6627 5265 6672 6573          f'Refres
+00013a00: 6869 6e67 2073 7461 7475 7320 287b 636c  hing status ({cl
+00013a10: 7573 7465 725f 6e61 6d65 2172 7d29 2066  uster_name!r}) f
+00013a20: 6169 6c65 643a 2027 0a20 2020 2020 2020  ailed: '.       
+00013a30: 2020 2020 2020 2020 2066 277b 636f 6d6d           f'{comm
+00013a40: 6f6e 5f75 7469 6c73 2e66 6f72 6d61 745f  on_utils.format_
+00013a50: 6578 6365 7074 696f 6e28 652c 2075 7365  exception(e, use
+00013a60: 5f62 7261 636b 6574 3d54 7275 6529 7d27  _bracket=True)}'
+00013a70: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00013a80: 2046 616c 7365 0a0a 2020 2020 2320 4465   False..    # De
+00013a90: 7465 726d 696e 696e 6720 6966 2074 6865  termining if the
+00013aa0: 2063 6c75 7374 6572 2069 7320 6865 616c   cluster is heal
+00013ab0: 7468 7920 2855 5029 3a0a 2020 2020 230a  thy (UP):.    #.
+00013ac0: 2020 2020 2320 466f 7220 6e6f 6e2d 7370      # For non-sp
+00013ad0: 6f74 2063 6c75 7374 6572 733a 2049 6620  ot clusters: If 
+00013ae0: 7261 7920 7374 6174 7573 2073 686f 7773  ray status shows
+00013af0: 2061 6c6c 206e 6f64 6573 2061 7265 2068   all nodes are h
+00013b00: 6561 6c74 6879 2c20 6974 2069 730a 2020  ealthy, it is.  
+00013b10: 2020 2320 7361 6665 2074 6f20 7365 7420    # safe to set 
+00013b20: 7468 6520 7374 6174 7573 2074 6f20 5550  the status to UP
+00013b30: 2061 7320 7374 6172 7469 6e67 2072 6179   as starting ray
+00013b40: 2069 7320 7468 6520 6669 6e61 6c20 7374   is the final st
+00013b50: 6570 206f 6620 736b 790a 2020 2020 2320  ep of sky.    # 
+00013b60: 6c61 756e 6368 2e20 4275 7420 7765 2066  launch. But we f
+00013b70: 6f75 6e64 2074 6861 7420 7261 7920 7374  ound that ray st
+00013b80: 6174 7573 2069 7320 7761 7920 746f 6f20  atus is way too 
+00013b90: 736c 6f77 2028 7365 6520 4e4f 5445 2062  slow (see NOTE b
+00013ba0: 656c 6f77 2920 736f 0a20 2020 2023 2077  elow) so.    # w
+00013bb0: 6520 616c 7761 7973 2071 7565 7279 2074  e always query t
+00013bc0: 6865 2063 6c6f 7564 2070 726f 7669 6465  he cloud provide
+00013bd0: 7220 6669 7273 7420 7768 6963 6820 6973  r first which is
+00013be0: 2066 6173 7465 722e 0a20 2020 2023 0a20   faster..    #. 
+00013bf0: 2020 2023 2046 6f72 2073 706f 7420 636c     # For spot cl
+00013c00: 7573 7465 7273 3a20 7468 6520 6162 6f76  usters: the abov
+00013c10: 6520 6361 6e20 6265 2075 6e73 6166 6520  e can be unsafe 
+00013c20: 6265 6361 7573 6520 7468 6520 5261 7920  because the Ray 
+00013c30: 636c 7573 7465 7220 6d61 790a 2020 2020  cluster may.    
+00013c40: 2320 7265 6d61 696e 2068 6561 6c74 6879  # remain healthy
+00013c50: 2066 6f72 2061 2077 6869 6c65 2062 6566   for a while bef
+00013c60: 6f72 6520 7468 6520 636c 6f75 6420 636f  ore the cloud co
+00013c70: 6d70 6c65 7465 6c79 2070 7265 656d 7074  mpletely preempt
+00013c80: 7320 7468 6520 564d 732e 0a20 2020 2023  s the VMs..    #
+00013c90: 2057 6520 6861 7665 206d 6974 6967 6174   We have mitigat
+00013ca0: 6564 2074 6869 7320 6279 2061 6761 696e  ed this by again
+00013cb0: 2066 6972 7374 2071 7565 7279 696e 6720   first querying 
+00013cc0: 7468 6520 564d 2073 7461 7465 2066 726f  the VM state fro
+00013cd0: 6d20 7468 6520 636c 6f75 640a 2020 2020  m the cloud.    
+00013ce0: 2320 7072 6f76 6964 6572 2e0a 2020 2020  # provider..    
+00013cf0: 6966 2061 6c6c 5f6e 6f64 6573 5f75 7020  if all_nodes_up 
+00013d00: 616e 6420 7275 6e5f 7261 795f 7374 6174  and run_ray_stat
+00013d10: 7573 5f74 6f5f 6368 6563 6b5f 7261 795f  us_to_check_ray_
+00013d20: 636c 7573 7465 725f 6865 616c 7468 7928  cluster_healthy(
+00013d30: 293a 0a20 2020 2020 2020 2023 204e 4f54  ):.        # NOT
+00013d40: 453a 2061 6c6c 5f6e 6f64 6573 5f75 7020  E: all_nodes_up 
+00013d50: 6361 6c63 756c 6174 696f 6e20 6973 2066  calculation is f
+00013d60: 6173 7420 6475 6520 746f 2063 616c 6c69  ast due to calli
+00013d70: 6e67 2063 6c6f 7564 2043 4c49 3b0a 2020  ng cloud CLI;.  
+00013d80: 2020 2020 2020 2320 7275 6e5f 7261 795f        # run_ray_
+00013d90: 7374 6174 7573 5f74 6f5f 6368 6563 6b5f  status_to_check_
+00013da0: 616c 6c5f 6e6f 6465 735f 7570 2829 2069  all_nodes_up() i
+00013db0: 7320 736c 6f77 2064 7565 2074 6f20 6361  s slow due to ca
+00013dc0: 6c6c 696e 6720 6072 6179 2067 6574 0a20  lling `ray get. 
+00013dd0: 2020 2020 2020 2023 2068 6561 642d 6970         # head-ip
+00013de0: 2f77 6f72 6b65 722d 6970 7360 2e0a 2020  /worker-ips`..  
+00013df0: 2020 2020 2020 7265 636f 7264 5b27 7374        record['st
+00013e00: 6174 7573 275d 203d 2073 7461 7475 735f  atus'] = status_
+00013e10: 6c69 622e 436c 7573 7465 7253 7461 7475  lib.ClusterStatu
+00013e20: 732e 5550 0a20 2020 2020 2020 2067 6c6f  s.UP.        glo
+00013e30: 6261 6c5f 7573 6572 5f73 7461 7465 2e61  bal_user_state.a
+00013e40: 6464 5f6f 725f 7570 6461 7465 5f63 6c75  dd_or_update_clu
+00013e50: 7374 6572 2863 6c75 7374 6572 5f6e 616d  ster(cluster_nam
+00013e60: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00013e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013e90: 2020 2068 616e 646c 652c 0a20 2020 2020     handle,.     
+00013ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013ec0: 2020 2020 2020 2020 2020 2072 6571 7565             reque
+00013ed0: 7374 6564 5f72 6573 6f75 7263 6573 3d4e  sted_resources=N
+00013ee0: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+00013ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013f10: 2020 2020 2072 6561 6479 3d54 7275 652c       ready=True,
+00013f20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 00013f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013f40: 6627 6e6f 726d 616c 6c79 2073 686f 756c  f'normally shoul
-00013f50: 6420 6e6f 7420 6861 7070 656e 2e20 7b63  d not happen. {c
-00013f60: 6f6c 6f72 616d 612e 466f 7265 2e52 4544  olorama.Fore.RED
-00013f70: 7d50 6c65 6173 6520 6368 6563 6b20 270a  }Please check '.
-00013f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013f90: 2774 6865 2063 6c6f 7564 2063 6f6e 736f  'the cloud conso
-00013fa0: 6c65 2061 6e64 2066 6978 2061 6e79 2070  le and fix any p
-00013fb0: 6f73 7369 626c 6520 7265 736f 7572 6365  ossible resource
-00013fc0: 7320 6c65 616b 6167 6520 270a 2020 2020  s leakage '.    
-00013fd0: 2020 2020 2020 2020 2020 2020 2728 652e              '(e.
-00013fe0: 672e 2c20 6966 2074 6865 7265 2061 7265  g., if there are
-00013ff0: 2061 6e79 2073 746f 7070 6564 206e 6f64   any stopped nod
-00014000: 6573 2061 6e64 2074 6865 7920 646f 206e  es and they do n
-00014010: 6f74 2068 6176 6520 270a 2020 2020 2020  ot have '.      
-00014020: 2020 2020 2020 2020 2020 2764 6174 6120            'data 
-00014030: 6f72 2061 7265 2075 6e68 6561 6c74 6879  or are unhealthy
-00014040: 2c20 7465 726d 696e 6174 6520 7468 656d  , terminate them
-00014050: 292e 270a 2020 2020 2020 2020 2020 2020  ).'.            
-00014060: 2020 2020 6627 7b63 6f6c 6f72 616d 612e      f'{colorama.
-00014070: 5374 796c 652e 5245 5345 545f 414c 4c7d  Style.RESET_ALL}
-00014080: 2729 0a20 2020 2061 7373 6572 7420 6c65  ').    assert le
-00014090: 6e28 6e6f 6465 5f73 7461 7475 7365 7329  n(node_statuses)
-000140a0: 203c 3d20 6861 6e64 6c65 2e6c 6175 6e63   <= handle.launc
-000140b0: 6865 645f 6e6f 6465 730a 0a20 2020 2023  hed_nodes..    #
-000140c0: 2049 6620 7468 6520 6e6f 6465 5f73 7461   If the node_sta
-000140d0: 7475 7365 7320 6973 2065 6d70 7479 2c20  tuses is empty, 
-000140e0: 616c 6c20 7468 6520 6e6f 6465 7320 6172  all the nodes ar
-000140f0: 6520 7465 726d 696e 6174 6564 2e20 5765  e terminated. We
-00014100: 2063 616e 0a20 2020 2023 2073 6166 656c   can.    # safel
-00014110: 7920 7365 7420 7468 6520 636c 7573 7465  y set the cluste
-00014120: 7220 7374 6174 7573 2074 6f20 5445 524d  r status to TERM
-00014130: 494e 4154 4544 2e20 5468 6973 2068 616e  INATED. This han
-00014140: 646c 6573 2074 6865 2065 6467 6520 6361  dles the edge ca
-00014150: 7365 0a20 2020 2023 2077 6865 7265 2074  se.    # where t
-00014160: 6865 2063 6c75 7374 6572 2069 7320 7465  he cluster is te
-00014170: 726d 696e 6174 6564 2062 7920 7468 6520  rminated by the 
-00014180: 7573 6572 206d 616e 7561 6c6c 7920 7468  user manually th
-00014190: 726f 7567 6820 7468 6520 5549 2e0a 2020  rough the UI..  
-000141a0: 2020 746f 5f74 6572 6d69 6e61 7465 203d    to_terminate =
-000141b0: 206e 6f74 206e 6f64 655f 7374 6174 7573   not node_status
-000141c0: 6573 0a0a 2020 2020 2320 4120 636c 7573  es..    # A clus
-000141d0: 7465 7220 6973 2063 6f6e 7369 6465 7265  ter is considere
-000141e0: 6420 2261 626e 6f72 6d61 6c22 2c20 6966  d "abnormal", if
-000141f0: 206e 6f74 2061 6c6c 206e 6f64 6573 2061   not all nodes a
-00014200: 7265 2054 4552 4d49 4e41 5445 4420 6f72  re TERMINATED or
-00014210: 0a20 2020 2023 206e 6f74 2061 6c6c 206e  .    # not all n
-00014220: 6f64 6573 2061 7265 2053 544f 5050 4544  odes are STOPPED
-00014230: 2e20 5765 2063 6865 636b 2074 6861 7420  . We check that 
-00014240: 7769 7468 2074 6865 2066 6f6c 6c6f 7769  with the followi
-00014250: 6e67 206c 6f67 6963 3a0a 2020 2020 2320  ng logic:.    # 
-00014260: 2020 2a20 4e6f 7420 616c 6c20 6e6f 6465    * Not all node
-00014270: 7320 6172 6520 7465 726d 696e 6174 6564  s are terminated
-00014280: 2061 6e64 2074 6865 7265 2773 2061 7420   and there's at 
-00014290: 6c65 6173 7420 6f6e 6520 6e6f 6465 0a20  least one node. 
-000142a0: 2020 2023 2020 2020 2074 6572 6d69 6e61     #     termina
-000142b0: 7465 643b 206f 720a 2020 2020 2320 2020  ted; or.    #   
-000142c0: 2a20 416e 7920 6f66 2074 6865 206e 6f6e  * Any of the non
-000142d0: 2d54 4552 4d49 4e41 5445 4420 6e6f 6465  -TERMINATED node
-000142e0: 7320 6973 2069 6e20 6120 6e6f 6e2d 5354  s is in a non-ST
-000142f0: 4f50 5045 4420 7374 6174 7573 2e0a 2020  OPPED status..  
-00014300: 2020 230a 2020 2020 2320 5468 6973 2069    #.    # This i
-00014310: 6e63 6c75 6465 7320 7468 6573 6520 7370  ncludes these sp
-00014320: 6563 6961 6c20 6361 7365 733a 0a20 2020  ecial cases:.   
-00014330: 2023 2020 202a 2041 6c6c 2073 746f 7070   #   * All stopp
-00014340: 6564 2061 7265 2063 6f6e 7369 6465 7265  ed are considere
-00014350: 6420 6e6f 726d 616c 2061 6e64 2077 696c  d normal and wil
-00014360: 6c20 6265 2063 6c65 616e 6564 2075 7020  l be cleaned up 
-00014370: 6174 2074 6865 2065 6e64 0a20 2020 2023  at the end.    #
-00014380: 2020 2020 206f 6620 7468 6520 6675 6e63       of the func
-00014390: 7469 6f6e 2e0a 2020 2020 2320 2020 2a20  tion..    #   * 
-000143a0: 536f 6d65 206f 6620 7468 6520 6e6f 6465  Some of the node
-000143b0: 7320 5550 2073 686f 756c 6420 6265 2063  s UP should be c
-000143c0: 6f6e 7369 6465 7265 6420 6162 6e6f 726d  onsidered abnorm
-000143d0: 616c 2c20 6265 6361 7573 6520 7468 6520  al, because the 
-000143e0: 7261 790a 2020 2020 2320 2020 2020 636c  ray.    #     cl
-000143f0: 7573 7465 7220 6973 2070 726f 6261 626c  uster is probabl
-00014400: 7920 646f 776e 2e0a 2020 2020 2320 2020  y down..    #   
-00014410: 2a20 5468 6520 636c 7573 7465 7220 6973  * The cluster is
-00014420: 2070 6172 7469 616c 6c79 2074 6572 6d69   partially termi
-00014430: 6e61 7465 6420 6f72 2073 746f 7070 6564  nated or stopped
-00014440: 2073 686f 756c 6420 6265 2063 6f6e 7369   should be consi
-00014450: 6465 7265 640a 2020 2020 2320 2020 2020  dered.    #     
-00014460: 6162 6e6f 726d 616c 2e0a 2020 2020 230a  abnormal..    #.
-00014470: 2020 2020 2320 416e 2061 626e 6f72 6d61      # An abnorma
-00014480: 6c20 636c 7573 7465 7220 7769 6c6c 2074  l cluster will t
-00014490: 7261 6e73 6974 696f 6e20 746f 2049 4e49  ransition to INI
-000144a0: 5420 616e 6420 6861 7665 2061 6e79 2061  T and have any a
-000144b0: 7574 6f73 746f 7020 7365 7474 696e 670a  utostop setting.
-000144c0: 2020 2020 2320 7265 7365 7420 2875 6e6c      # reset (unl
-000144d0: 6573 7320 6974 2773 2061 7574 6f73 746f  ess it's autosto
-000144e0: 7070 696e 672f 6175 746f 646f 776e 696e  pping/autodownin
-000144f0: 6729 2e0a 2020 2020 6973 5f61 626e 6f72  g)..    is_abnor
-00014500: 6d61 6c20 3d20 2828 3020 3c20 6c65 6e28  mal = ((0 < len(
-00014510: 6e6f 6465 5f73 7461 7475 7365 7329 203c  node_statuses) <
-00014520: 2068 616e 646c 652e 6c61 756e 6368 6564   handle.launched
-00014530: 5f6e 6f64 6573 2920 6f72 2061 6e79 280a  _nodes) or any(.
-00014540: 2020 2020 2020 2020 7374 6174 7573 2021          status !
-00014550: 3d20 7374 6174 7573 5f6c 6962 2e43 6c75  = status_lib.Clu
-00014560: 7374 6572 5374 6174 7573 2e53 544f 5050  sterStatus.STOPP
-00014570: 4544 2066 6f72 2073 7461 7475 7320 696e  ED for status in
-00014580: 206e 6f64 655f 7374 6174 7573 6573 2929   node_statuses))
-00014590: 0a20 2020 2069 6620 6973 5f61 626e 6f72  .    if is_abnor
-000145a0: 6d61 6c3a 0a20 2020 2020 2020 206c 6f67  mal:.        log
-000145b0: 6765 722e 6465 6275 6728 2754 6865 2063  ger.debug('The c
-000145c0: 6c75 7374 6572 2069 7320 6162 6e6f 726d  luster is abnorm
-000145d0: 616c 2e20 5365 7474 696e 6720 746f 2049  al. Setting to I
-000145e0: 4e49 5420 7374 6174 7573 2e20 270a 2020  NIT status. '.  
-000145f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014600: 2020 2066 276e 6f64 655f 7374 6174 7573     f'node_status
-00014610: 6573 3a20 7b6e 6f64 655f 7374 6174 7573  es: {node_status
-00014620: 6573 7d27 290a 2020 2020 2020 2020 6261  es}').        ba
-00014630: 636b 656e 6420 3d20 6765 745f 6261 636b  ckend = get_back
-00014640: 656e 645f 6672 6f6d 5f68 616e 646c 6528  end_from_handle(
-00014650: 6861 6e64 6c65 290a 2020 2020 2020 2020  handle).        
-00014660: 6966 2069 7369 6e73 7461 6e63 6528 6261  if isinstance(ba
-00014670: 636b 656e 642c 0a20 2020 2020 2020 2020  ckend,.         
-00014680: 2020 2020 2020 2020 2020 2020 2062 6163               bac
-00014690: 6b65 6e64 732e 436c 6f75 6456 6d52 6179  kends.CloudVmRay
-000146a0: 4261 636b 656e 6429 2061 6e64 2072 6563  Backend) and rec
-000146b0: 6f72 645b 2761 7574 6f73 746f 7027 5d20  ord['autostop'] 
-000146c0: 3e3d 2030 3a0a 2020 2020 2020 2020 2020  >= 0:.          
-000146d0: 2020 6966 206e 6f74 2062 6163 6b65 6e64    if not backend
-000146e0: 2e69 735f 6465 6669 6e69 7465 6c79 5f61  .is_definitely_a
-000146f0: 7574 6f73 746f 7070 696e 6728 6861 6e64  utostopping(hand
-00014700: 6c65 2c0a 2020 2020 2020 2020 2020 2020  le,.            
-00014710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014730: 2020 2020 2020 2020 2020 7374 7265 616d            stream
-00014740: 5f6c 6f67 733d 4661 6c73 6529 3a0a 2020  _logs=False):.  
-00014750: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00014760: 5265 7365 7420 7468 6520 6175 746f 7374  Reset the autost
-00014770: 6f70 7069 6e67 2061 7320 7468 6520 636c  opping as the cl
-00014780: 7573 7465 7220 6973 2061 626e 6f72 6d61  uster is abnorma
-00014790: 6c2c 2061 6e64 206d 6179 0a20 2020 2020  l, and may.     
-000147a0: 2020 2020 2020 2020 2020 2023 206e 6f74             # not
-000147b0: 2063 6f72 7265 6374 6c79 2061 7574 6f73   correctly autos
-000147c0: 746f 702e 2052 6573 6574 7469 6e67 2074  top. Resetting t
-000147d0: 6865 2061 7574 6f73 746f 7020 7769 6c6c  he autostop will
-000147e0: 206c 6574 0a20 2020 2020 2020 2020 2020   let.           
-000147f0: 2020 2020 2023 2074 6865 2075 7365 7220       # the user 
-00014800: 6b6e 6f77 2074 6861 7420 7468 6520 6175  know that the au
-00014810: 746f 7374 6f70 206d 6179 206e 6f74 2068  tostop may not h
-00014820: 6170 7065 6e20 746f 2061 766f 6964 0a20  appen to avoid. 
-00014830: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00014840: 206c 6561 6b61 6765 7320 6672 6f6d 2074   leakages from t
-00014850: 6865 2061 7373 756d 7074 696f 6e20 7468  he assumption th
-00014860: 6174 2074 6865 2063 6c75 7374 6572 2077  at the cluster w
-00014870: 696c 6c20 6175 746f 7374 6f70 2e0a 2020  ill autostop..  
-00014880: 2020 2020 2020 2020 2020 2020 2020 7375                su
-00014890: 6363 6573 7320 3d20 5472 7565 0a20 2020  ccess = True.   
-000148a0: 2020 2020 2020 2020 2020 2020 2074 7279               try
-000148b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000148c0: 2020 2020 2020 6261 636b 656e 642e 7365        backend.se
-000148d0: 745f 6175 746f 7374 6f70 2868 616e 646c  t_autostop(handl
-000148e0: 652c 202d 312c 2073 7472 6561 6d5f 6c6f  e, -1, stream_lo
-000148f0: 6773 3d46 616c 7365 290a 2020 2020 2020  gs=False).      
-00014900: 2020 2020 2020 2020 2020 6578 6365 7074            except
-00014910: 2028 4578 6365 7074 696f 6e2c 2053 7973   (Exception, Sys
-00014920: 7465 6d45 7869 7429 2061 7320 653a 2020  temExit) as e:  
-00014930: 2320 7079 6c69 6e74 3a20 6469 7361 626c  # pylint: disabl
-00014940: 653d 6272 6f61 642d 6578 6365 7074 0a20  e=broad-except. 
-00014950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014960: 2020 2073 7563 6365 7373 203d 2046 616c     success = Fal
-00014970: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
-00014980: 2020 2020 2020 206c 6f67 6765 722e 6465         logger.de
-00014990: 6275 6728 6627 4661 696c 6564 2074 6f20  bug(f'Failed to 
-000149a0: 7265 7365 7420 6175 746f 7374 6f70 2e20  reset autostop. 
-000149b0: 4475 6520 746f 2027 0a20 2020 2020 2020  Due to '.       
-000149c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000149d0: 2020 2020 2020 2020 2020 6627 7b63 6f6d            f'{com
-000149e0: 6d6f 6e5f 7574 696c 732e 666f 726d 6174  mon_utils.format
-000149f0: 5f65 7863 6570 7469 6f6e 2865 297d 2729  _exception(e)}')
-00014a00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014a10: 2067 6c6f 6261 6c5f 7573 6572 5f73 7461   global_user_sta
-00014a20: 7465 2e73 6574 5f63 6c75 7374 6572 5f61  te.set_cluster_a
-00014a30: 7574 6f73 746f 705f 7661 6c75 6528 0a20  utostop_value(. 
-00014a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014a50: 2020 2068 616e 646c 652e 636c 7573 7465     handle.cluste
-00014a60: 725f 6e61 6d65 2c20 2d31 2c20 746f 5f64  r_name, -1, to_d
-00014a70: 6f77 6e3d 4661 6c73 6529 0a0a 2020 2020  own=False)..    
-00014a80: 2020 2020 2020 2020 2020 2020 2320 4672              # Fr
-00014a90: 6965 6e64 6c79 2068 696e 742e 0a20 2020  iendly hint..   
-00014aa0: 2020 2020 2020 2020 2020 2020 2061 7574               aut
-00014ab0: 6f73 746f 7020 3d20 7265 636f 7264 5b27  ostop = record['
-00014ac0: 6175 746f 7374 6f70 275d 0a20 2020 2020  autostop'].     
-00014ad0: 2020 2020 2020 2020 2020 206d 6179 6265             maybe
-00014ae0: 5f64 6f77 6e5f 7374 7220 3d20 2720 2d2d  _down_str = ' --
-00014af0: 646f 776e 2720 6966 2072 6563 6f72 645b  down' if record[
-00014b00: 2774 6f5f 646f 776e 275d 2065 6c73 6520  'to_down'] else 
-00014b10: 2727 0a20 2020 2020 2020 2020 2020 2020  ''.             
-00014b20: 2020 206e 6f75 6e20 3d20 2761 7574 6f64     noun = 'autod
-00014b30: 6f77 6e27 2069 6620 7265 636f 7264 5b27  own' if record['
-00014b40: 746f 5f64 6f77 6e27 5d20 656c 7365 2027  to_down'] else '
-00014b50: 6175 746f 7374 6f70 270a 2020 2020 2020  autostop'.      
-00014b60: 2020 2020 2020 2020 2020 6966 2073 7563            if suc
-00014b70: 6365 7373 3a0a 2020 2020 2020 2020 2020  cess:.          
-00014b80: 2020 2020 2020 2020 2020 6f70 6572 6174            operat
-00014b90: 696f 6e5f 7374 7220 3d20 2866 2743 616e  ion_str = (f'Can
-00014ba0: 6365 6c65 6420 7b6e 6f75 6e7d 206f 6e20  celed {noun} on 
-00014bb0: 7468 6520 636c 7573 7465 7220 270a 2020  the cluster '.  
-00014bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014be0: 2020 2066 277b 636c 7573 7465 725f 6e61     f'{cluster_na
-00014bf0: 6d65 2172 7d27 290a 2020 2020 2020 2020  me!r}').        
-00014c00: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00014c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014c20: 2020 6f70 6572 6174 696f 6e5f 7374 7220    operation_str 
-00014c30: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
-00014c40: 2020 2020 2020 2020 2020 2020 6627 4174              f'At
-00014c50: 7465 6d70 7465 6420 746f 2063 616e 6365  tempted to cance
-00014c60: 6c20 7b6e 6f75 6e7d 206f 6e20 7468 6520  l {noun} on the 
-00014c70: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00014c80: 2020 2020 2020 2020 2020 6627 636c 7573            f'clus
-00014c90: 7465 7220 7b63 6c75 7374 6572 5f6e 616d  ter {cluster_nam
-00014ca0: 6521 727d 2077 6974 6820 6265 7374 2065  e!r} with best e
-00014cb0: 6666 6f72 7427 290a 2020 2020 2020 2020  ffort').        
-00014cc0: 2020 2020 2020 2020 7965 6c6c 6f77 203d          yellow =
-00014cd0: 2063 6f6c 6f72 616d 612e 466f 7265 2e59   colorama.Fore.Y
-00014ce0: 454c 4c4f 570a 2020 2020 2020 2020 2020  ELLOW.          
-00014cf0: 2020 2020 2020 6272 6967 6874 203d 2063        bright = c
-00014d00: 6f6c 6f72 616d 612e 5374 796c 652e 4252  olorama.Style.BR
-00014d10: 4947 4854 0a20 2020 2020 2020 2020 2020  IGHT.           
-00014d20: 2020 2020 2072 6573 6574 203d 2063 6f6c       reset = col
-00014d30: 6f72 616d 612e 5374 796c 652e 5245 5345  orama.Style.RESE
-00014d40: 545f 414c 4c0a 2020 2020 2020 2020 2020  T_ALL.          
-00014d50: 2020 2020 2020 7578 5f75 7469 6c73 2e63        ux_utils.c
-00014d60: 6f6e 736f 6c65 5f6e 6577 6c69 6e65 2829  onsole_newline()
-00014d70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014d80: 206c 6f67 6765 722e 7761 726e 696e 6728   logger.warning(
-00014d90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014da0: 2020 2020 2066 277b 7965 6c6c 6f77 7d7b       f'{yellow}{
-00014db0: 6f70 6572 6174 696f 6e5f 7374 727d 2c20  operation_str}, 
-00014dc0: 7369 6e63 6520 6974 2069 7320 666f 756e  since it is foun
-00014dd0: 6420 746f 2062 6520 696e 2061 6e20 270a  d to be in an '.
-00014de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014df0: 2020 2020 6627 6162 6e6f 726d 616c 2073      f'abnormal s
-00014e00: 7461 7465 2e20 546f 2066 6978 2c20 7472  tate. To fix, tr
-00014e10: 7920 7275 6e6e 696e 673a 207b 7265 7365  y running: {rese
-00014e20: 747d 7b62 7269 6768 747d 736b 7920 270a  t}{bright}sky '.
-00014e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014e40: 2020 2020 6627 7374 6172 7420 2d66 202d      f'start -f -
-00014e50: 6920 7b61 7574 6f73 746f 707d 7b6d 6179  i {autostop}{may
-00014e60: 6265 5f64 6f77 6e5f 7374 727d 207b 636c  be_down_str} {cl
-00014e70: 7573 7465 725f 6e61 6d65 7d27 0a20 2020  uster_name}'.   
-00014e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014e90: 2066 277b 7265 7365 747d 2729 0a20 2020   f'{reset}').   
-00014ea0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00014eb0: 2020 2020 2020 2020 2020 2020 2020 2075                 u
-00014ec0: 785f 7574 696c 732e 636f 6e73 6f6c 655f  x_utils.console_
-00014ed0: 6e65 776c 696e 6528 290a 2020 2020 2020  newline().      
-00014ee0: 2020 2020 2020 2020 2020 6f70 6572 6174            operat
-00014ef0: 696f 6e5f 7374 7220 3d20 2761 7574 6f64  ion_str = 'autod
-00014f00: 6f77 6e69 6e67 2720 6966 2072 6563 6f72  owning' if recor
-00014f10: 645b 0a20 2020 2020 2020 2020 2020 2020  d[.             
-00014f20: 2020 2020 2020 2027 746f 5f64 6f77 6e27         'to_down'
-00014f30: 5d20 656c 7365 2027 6175 746f 7374 6f70  ] else 'autostop
-00014f40: 7069 6e67 270a 2020 2020 2020 2020 2020  ping'.          
-00014f50: 2020 2020 2020 6c6f 6767 6572 2e69 6e66        logger.inf
-00014f60: 6f28 0a20 2020 2020 2020 2020 2020 2020  o(.             
-00014f70: 2020 2020 2020 2066 2743 6c75 7374 6572         f'Cluster
-00014f80: 207b 636c 7573 7465 725f 6e61 6d65 2172   {cluster_name!r
-00014f90: 7d20 6973 207b 6f70 6572 6174 696f 6e5f  } is {operation_
-00014fa0: 7374 727d 2e20 5365 7474 696e 6720 746f  str}. Setting to
-00014fb0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-00014fc0: 2020 2020 2020 2027 494e 4954 2073 7461         'INIT sta
-00014fd0: 7475 733b 2074 7279 2072 6566 7265 7368  tus; try refresh
-00014fe0: 2061 6761 696e 2069 6e20 6120 7768 696c   again in a whil
-00014ff0: 652e 2729 0a0a 2020 2020 2020 2020 2320  e.')..        # 
-00015000: 4966 2074 6865 2075 7365 7220 7374 6172  If the user star
-00015010: 7473 2070 6172 7420 6f66 2061 2053 544f  ts part of a STO
-00015020: 5050 4544 2063 6c75 7374 6572 2c20 7765  PPED cluster, we
-00015030: 2073 7469 6c6c 206e 6565 6420 6120 7374   still need a st
-00015040: 6174 7573 0a20 2020 2020 2020 2023 2074  atus.        # t
-00015050: 6f20 7265 7072 6573 656e 7420 7468 6520  o represent the 
-00015060: 6162 6e6f 726d 616c 2073 7461 7475 732e  abnormal status.
-00015070: 2046 6f72 2073 706f 7420 636c 7573 7465   For spot cluste
-00015080: 722c 2069 7420 6361 6e20 616c 736f 0a20  r, it can also. 
-00015090: 2020 2020 2020 2023 2072 6570 7265 7365         # represe
-000150a0: 6e74 2074 6861 7420 7468 6520 636c 7573  nt that the clus
-000150b0: 7465 7220 6973 2070 6172 7469 616c 6c79  ter is partially
-000150c0: 2070 7265 656d 7074 6564 2e0a 2020 2020   preempted..    
-000150d0: 2020 2020 2320 544f 444f 287a 6877 7529      # TODO(zhwu)
-000150e0: 3a20 7468 6520 6465 6669 6e69 7469 6f6e  : the definition
-000150f0: 206f 6620 494e 4954 2073 686f 756c 6420   of INIT should 
-00015100: 6265 2061 7564 6974 6564 2f63 6861 6e67  be audited/chang
-00015110: 6564 2e0a 2020 2020 2020 2020 2320 4164  ed..        # Ad
-00015120: 6469 6e67 2061 206e 6577 2073 7461 7475  ding a new statu
-00015130: 7320 554e 4845 414c 5448 5920 666f 7220  s UNHEALTHY for 
-00015140: 6162 6e6f 726d 616c 2073 7461 7475 7320  abnormal status 
-00015150: 6361 6e20 6265 2061 2063 686f 6963 652e  can be a choice.
-00015160: 0a20 2020 2020 2020 2067 6c6f 6261 6c5f  .        global_
-00015170: 7573 6572 5f73 7461 7465 2e61 6464 5f6f  user_state.add_o
-00015180: 725f 7570 6461 7465 5f63 6c75 7374 6572  r_update_cluster
-00015190: 2863 6c75 7374 6572 5f6e 616d 652c 0a20  (cluster_name,. 
-000151a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000151b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000151c0: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-000151d0: 616e 646c 652c 0a20 2020 2020 2020 2020  andle,.         
-000151e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000151f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015200: 2020 2020 2020 2072 6571 7565 7374 6564         requested
-00015210: 5f72 6573 6f75 7263 6573 3d4e 6f6e 652c  _resources=None,
-00015220: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015250: 2072 6561 6479 3d46 616c 7365 2c0a 2020   ready=False,.  
-00015260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013f50: 2069 735f 6c61 756e 6368 3d46 616c 7365   is_launch=False
+00013f60: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00013f70: 2072 6563 6f72 640a 0a20 2020 2023 2041   record..    # A
+00013f80: 6c6c 2063 6173 6573 2062 656c 6f77 2061  ll cases below a
+00013f90: 7265 2074 7261 6e73 6974 696f 6e69 6e67  re transitioning
+00013fa0: 2074 6865 2063 6c75 7374 6572 2074 6f20   the cluster to 
+00013fb0: 6e6f 6e2d 5550 2073 7461 7465 732e 0a20  non-UP states.. 
+00013fc0: 2020 2069 6620 6c65 6e28 6e6f 6465 5f73     if len(node_s
+00013fd0: 7461 7475 7365 7329 203e 2068 616e 646c  tatuses) > handl
+00013fe0: 652e 6c61 756e 6368 6564 5f6e 6f64 6573  e.launched_nodes
+00013ff0: 3a0a 2020 2020 2020 2020 2320 556e 6578  :.        # Unex
+00014000: 7065 6374 6564 3a20 696e 2074 6865 2071  pected: in the q
+00014010: 7565 7269 6564 2072 6567 696f 6e20 6d6f  ueried region mo
+00014020: 7265 2074 6861 6e20 3120 636c 7573 7465  re than 1 cluste
+00014030: 7220 7769 7468 2074 6865 2073 616d 650a  r with the same.
+00014040: 2020 2020 2020 2020 2320 636f 6e73 7472          # constr
+00014050: 7563 7465 6420 6e61 6d65 2074 6167 2072  ucted name tag r
+00014060: 6574 7572 6e65 642e 2054 6869 7320 7769  eturned. This wi
+00014070: 6c6c 2074 7970 6963 616c 6c79 206e 6f74  ll typically not
+00014080: 2068 6170 7065 6e20 756e 6c65 7373 0a20   happen unless. 
+00014090: 2020 2020 2020 2023 2075 7365 7273 206d         # users m
+000140a0: 616e 7561 6c6c 7920 6372 6561 7465 2061  anually create a
+000140b0: 2063 6c75 7374 6572 2077 6974 6820 7468   cluster with th
+000140c0: 6174 2063 6f6e 7374 7275 6374 6564 206e  at constructed n
+000140d0: 616d 6520 6f72 2074 6865 7265 0a20 2020  ame or there.   
+000140e0: 2020 2020 2023 2077 6173 2061 2072 6573       # was a res
+000140f0: 6f75 7263 6520 6c65 616b 2063 6175 7365  ource leak cause
+00014100: 6420 6279 2064 6966 6665 7265 6e74 206c  d by different l
+00014110: 6175 6e63 6820 6861 7368 2062 6566 6f72  aunch hash befor
+00014120: 6520 2331 3637 310a 2020 2020 2020 2020  e #1671.        
+00014130: 2320 7761 7320 6d65 7267 6564 2e0a 2020  # was merged..  
+00014140: 2020 2020 2020 230a 2020 2020 2020 2020        #.        
+00014150: 2320 2854 6563 686e 6963 616c 6c79 2073  # (Technically s
+00014160: 7065 616b 696e 672c 2065 7665 6e20 6966  peaking, even if
+00014170: 2072 6574 7572 6e65 6420 6e75 6d20 6e6f   returned num no
+00014180: 6465 7320 3c3d 206e 756d 0a20 2020 2020  des <= num.     
+00014190: 2020 2023 2068 616e 646c 652e 6c61 756e     # handle.laun
+000141a0: 6368 6564 5f6e 6f64 6573 292c 206e 6f74  ched_nodes), not
+000141b0: 2069 6e63 6c75 6469 6e67 2074 6865 206c   including the l
+000141c0: 6175 6e63 6820 6861 7368 2063 6f75 6c64  aunch hash could
+000141d0: 206d 6561 6e20 7468 650a 2020 2020 2020   mean the.      
+000141e0: 2020 2320 7265 7475 726e 6564 206e 6f64    # returned nod
+000141f0: 6573 2063 6f6e 7461 696e 2073 6f6d 6520  es contain some 
+00014200: 6e6f 6465 7320 7468 6174 2064 6f20 6e6f  nodes that do no
+00014210: 7420 6265 6c6f 6e67 2074 6f20 7468 6520  t belong to the 
+00014220: 6c6f 6769 6361 6c0a 2020 2020 2020 2020  logical.        
+00014230: 2320 736b 7970 696c 6f74 2063 6c75 7374  # skypilot clust
+00014240: 6572 2e20 446f 6573 6e27 7420 7365 656d  er. Doesn't seem
+00014250: 2074 6f20 6265 2061 2067 6f6f 6420 7761   to be a good wa
+00014260: 7920 746f 2068 616e 646c 6520 7468 6973  y to handle this
+00014270: 2066 6f72 0a20 2020 2020 2020 2023 206e   for.        # n
+00014280: 6f77 3f29 0a20 2020 2020 2020 2023 0a20  ow?).        #. 
+00014290: 2020 2020 2020 2023 2057 6520 6861 7665         # We have
+000142a0: 206e 6f74 2065 7870 6572 6965 6e63 6564   not experienced
+000142b0: 2074 6865 2061 626f 7665 3b20 6164 6469   the above; addi
+000142c0: 6e67 2061 7320 6120 7361 6665 6775 6172  ng as a safeguar
+000142d0: 642e 0a20 2020 2020 2020 2023 0a20 2020  d..        #.   
+000142e0: 2020 2020 2023 2053 696e 6365 2077 6520       # Since we 
+000142f0: 6661 696c 6564 2074 6f20 7265 6672 6573  failed to refres
+00014300: 682c 2072 6169 7365 2074 6865 2073 7461  h, raise the sta
+00014310: 7475 7320 6665 7463 6869 6e67 2065 7272  tus fetching err
+00014320: 6f72 2e0a 2020 2020 2020 2020 7769 7468  or..        with
+00014330: 2075 785f 7574 696c 732e 7072 696e 745f   ux_utils.print_
+00014340: 6578 6365 7074 696f 6e5f 6e6f 5f74 7261  exception_no_tra
+00014350: 6365 6261 636b 2829 3a0a 2020 2020 2020  ceback():.      
+00014360: 2020 2020 2020 7261 6973 6520 6578 6365        raise exce
+00014370: 7074 696f 6e73 2e43 6c75 7374 6572 5374  ptions.ClusterSt
+00014380: 6174 7573 4665 7463 6869 6e67 4572 726f  atusFetchingErro
+00014390: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+000143a0: 2020 2066 2746 6f75 6e64 207b 6c65 6e28     f'Found {len(
+000143b0: 6e6f 6465 5f73 7461 7475 7365 7329 7d20  node_statuses)} 
+000143c0: 6e6f 6465 2873 2920 7769 7468 2074 6865  node(s) with the
+000143d0: 2073 616d 6520 636c 7573 7465 7220 6e61   same cluster na
+000143e0: 6d65 270a 2020 2020 2020 2020 2020 2020  me'.            
+000143f0: 2020 2020 6627 2074 6167 2069 6e20 7468      f' tag in th
+00014400: 6520 636c 6f75 6420 7072 6f76 6964 6572  e cloud provider
+00014410: 2066 6f72 2063 6c75 7374 6572 207b 636c   for cluster {cl
+00014420: 7573 7465 725f 6e61 6d65 2172 7d2c 2027  uster_name!r}, '
+00014430: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014440: 2066 2777 6869 6368 2073 686f 756c 6420   f'which should 
+00014450: 6861 7665 207b 6861 6e64 6c65 2e6c 6175  have {handle.lau
+00014460: 6e63 6865 645f 6e6f 6465 737d 206e 6f64  nched_nodes} nod
+00014470: 6573 2e20 5468 6973 2027 0a20 2020 2020  es. This '.     
+00014480: 2020 2020 2020 2020 2020 2066 276e 6f72             f'nor
+00014490: 6d61 6c6c 7920 7368 6f75 6c64 206e 6f74  mally should not
+000144a0: 2068 6170 7065 6e2e 207b 636f 6c6f 7261   happen. {colora
+000144b0: 6d61 2e46 6f72 652e 5245 447d 506c 6561  ma.Fore.RED}Plea
+000144c0: 7365 2063 6865 636b 2027 0a20 2020 2020  se check '.     
+000144d0: 2020 2020 2020 2020 2020 2027 7468 6520             'the 
+000144e0: 636c 6f75 6420 636f 6e73 6f6c 6520 616e  cloud console an
+000144f0: 6420 6669 7820 616e 7920 706f 7373 6962  d fix any possib
+00014500: 6c65 2072 6573 6f75 7263 6573 206c 6561  le resources lea
+00014510: 6b61 6765 2027 0a20 2020 2020 2020 2020  kage '.         
+00014520: 2020 2020 2020 2027 2865 2e67 2e2c 2069         '(e.g., i
+00014530: 6620 7468 6572 6520 6172 6520 616e 7920  f there are any 
+00014540: 7374 6f70 7065 6420 6e6f 6465 7320 616e  stopped nodes an
+00014550: 6420 7468 6579 2064 6f20 6e6f 7420 6861  d they do not ha
+00014560: 7665 2027 0a20 2020 2020 2020 2020 2020  ve '.           
+00014570: 2020 2020 2027 6461 7461 206f 7220 6172       'data or ar
+00014580: 6520 756e 6865 616c 7468 792c 2074 6572  e unhealthy, ter
+00014590: 6d69 6e61 7465 2074 6865 6d29 2e27 0a20  minate them).'. 
+000145a0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000145b0: 277b 636f 6c6f 7261 6d61 2e53 7479 6c65  '{colorama.Style
+000145c0: 2e52 4553 4554 5f41 4c4c 7d27 290a 2020  .RESET_ALL}').  
+000145d0: 2020 6173 7365 7274 206c 656e 286e 6f64    assert len(nod
+000145e0: 655f 7374 6174 7573 6573 2920 3c3d 2068  e_statuses) <= h
+000145f0: 616e 646c 652e 6c61 756e 6368 6564 5f6e  andle.launched_n
+00014600: 6f64 6573 0a0a 2020 2020 2320 4966 2074  odes..    # If t
+00014610: 6865 206e 6f64 655f 7374 6174 7573 6573  he node_statuses
+00014620: 2069 7320 656d 7074 792c 2061 6c6c 2074   is empty, all t
+00014630: 6865 206e 6f64 6573 2061 7265 2074 6572  he nodes are ter
+00014640: 6d69 6e61 7465 642e 2057 6520 6361 6e0a  minated. We can.
+00014650: 2020 2020 2320 7361 6665 6c79 2073 6574      # safely set
+00014660: 2074 6865 2063 6c75 7374 6572 2073 7461   the cluster sta
+00014670: 7475 7320 746f 2054 4552 4d49 4e41 5445  tus to TERMINATE
+00014680: 442e 2054 6869 7320 6861 6e64 6c65 7320  D. This handles 
+00014690: 7468 6520 6564 6765 2063 6173 650a 2020  the edge case.  
+000146a0: 2020 2320 7768 6572 6520 7468 6520 636c    # where the cl
+000146b0: 7573 7465 7220 6973 2074 6572 6d69 6e61  uster is termina
+000146c0: 7465 6420 6279 2074 6865 2075 7365 7220  ted by the user 
+000146d0: 6d61 6e75 616c 6c79 2074 6872 6f75 6768  manually through
+000146e0: 2074 6865 2055 492e 0a20 2020 2074 6f5f   the UI..    to_
+000146f0: 7465 726d 696e 6174 6520 3d20 6e6f 7420  terminate = not 
+00014700: 6e6f 6465 5f73 7461 7475 7365 730a 0a20  node_statuses.. 
+00014710: 2020 2023 2041 2063 6c75 7374 6572 2069     # A cluster i
+00014720: 7320 636f 6e73 6964 6572 6564 2022 6162  s considered "ab
+00014730: 6e6f 726d 616c 222c 2069 6620 6e6f 7420  normal", if not 
+00014740: 616c 6c20 6e6f 6465 7320 6172 6520 5445  all nodes are TE
+00014750: 524d 494e 4154 4544 206f 720a 2020 2020  RMINATED or.    
+00014760: 2320 6e6f 7420 616c 6c20 6e6f 6465 7320  # not all nodes 
+00014770: 6172 6520 5354 4f50 5045 442e 2057 6520  are STOPPED. We 
+00014780: 6368 6563 6b20 7468 6174 2077 6974 6820  check that with 
+00014790: 7468 6520 666f 6c6c 6f77 696e 6720 6c6f  the following lo
+000147a0: 6769 633a 0a20 2020 2023 2020 202a 204e  gic:.    #   * N
+000147b0: 6f74 2061 6c6c 206e 6f64 6573 2061 7265  ot all nodes are
+000147c0: 2074 6572 6d69 6e61 7465 6420 616e 6420   terminated and 
+000147d0: 7468 6572 6527 7320 6174 206c 6561 7374  there's at least
+000147e0: 206f 6e65 206e 6f64 650a 2020 2020 2320   one node.    # 
+000147f0: 2020 2020 7465 726d 696e 6174 6564 3b20      terminated; 
+00014800: 6f72 0a20 2020 2023 2020 202a 2041 6e79  or.    #   * Any
+00014810: 206f 6620 7468 6520 6e6f 6e2d 5445 524d   of the non-TERM
+00014820: 494e 4154 4544 206e 6f64 6573 2069 7320  INATED nodes is 
+00014830: 696e 2061 206e 6f6e 2d53 544f 5050 4544  in a non-STOPPED
+00014840: 2073 7461 7475 732e 0a20 2020 2023 0a20   status..    #. 
+00014850: 2020 2023 2054 6869 7320 696e 636c 7564     # This includ
+00014860: 6573 2074 6865 7365 2073 7065 6369 616c  es these special
+00014870: 2063 6173 6573 3a0a 2020 2020 2320 2020   cases:.    #   
+00014880: 2a20 416c 6c20 7374 6f70 7065 6420 6172  * All stopped ar
+00014890: 6520 636f 6e73 6964 6572 6564 206e 6f72  e considered nor
+000148a0: 6d61 6c20 616e 6420 7769 6c6c 2062 6520  mal and will be 
+000148b0: 636c 6561 6e65 6420 7570 2061 7420 7468  cleaned up at th
+000148c0: 6520 656e 640a 2020 2020 2320 2020 2020  e end.    #     
+000148d0: 6f66 2074 6865 2066 756e 6374 696f 6e2e  of the function.
+000148e0: 0a20 2020 2023 2020 202a 2053 6f6d 6520  .    #   * Some 
+000148f0: 6f66 2074 6865 206e 6f64 6573 2055 5020  of the nodes UP 
+00014900: 7368 6f75 6c64 2062 6520 636f 6e73 6964  should be consid
+00014910: 6572 6564 2061 626e 6f72 6d61 6c2c 2062  ered abnormal, b
+00014920: 6563 6175 7365 2074 6865 2072 6179 0a20  ecause the ray. 
+00014930: 2020 2023 2020 2020 2063 6c75 7374 6572     #     cluster
+00014940: 2069 7320 7072 6f62 6162 6c79 2064 6f77   is probably dow
+00014950: 6e2e 0a20 2020 2023 2020 202a 2054 6865  n..    #   * The
+00014960: 2063 6c75 7374 6572 2069 7320 7061 7274   cluster is part
+00014970: 6961 6c6c 7920 7465 726d 696e 6174 6564  ially terminated
+00014980: 206f 7220 7374 6f70 7065 6420 7368 6f75   or stopped shou
+00014990: 6c64 2062 6520 636f 6e73 6964 6572 6564  ld be considered
+000149a0: 0a20 2020 2023 2020 2020 2061 626e 6f72  .    #     abnor
+000149b0: 6d61 6c2e 0a20 2020 2023 0a20 2020 2023  mal..    #.    #
+000149c0: 2041 6e20 6162 6e6f 726d 616c 2063 6c75   An abnormal clu
+000149d0: 7374 6572 2077 696c 6c20 7472 616e 7369  ster will transi
+000149e0: 7469 6f6e 2074 6f20 494e 4954 2061 6e64  tion to INIT and
+000149f0: 2068 6176 6520 616e 7920 6175 746f 7374   have any autost
+00014a00: 6f70 2073 6574 7469 6e67 0a20 2020 2023  op setting.    #
+00014a10: 2072 6573 6574 2028 756e 6c65 7373 2069   reset (unless i
+00014a20: 7427 7320 6175 746f 7374 6f70 7069 6e67  t's autostopping
+00014a30: 2f61 7574 6f64 6f77 6e69 6e67 292e 0a20  /autodowning).. 
+00014a40: 2020 2069 735f 6162 6e6f 726d 616c 203d     is_abnormal =
+00014a50: 2028 2830 203c 206c 656e 286e 6f64 655f   ((0 < len(node_
+00014a60: 7374 6174 7573 6573 2920 3c20 6861 6e64  statuses) < hand
+00014a70: 6c65 2e6c 6175 6e63 6865 645f 6e6f 6465  le.launched_node
+00014a80: 7329 206f 7220 616e 7928 0a20 2020 2020  s) or any(.     
+00014a90: 2020 2073 7461 7475 7320 213d 2073 7461     status != sta
+00014aa0: 7475 735f 6c69 622e 436c 7573 7465 7253  tus_lib.ClusterS
+00014ab0: 7461 7475 732e 5354 4f50 5045 4420 666f  tatus.STOPPED fo
+00014ac0: 7220 7374 6174 7573 2069 6e20 6e6f 6465  r status in node
+00014ad0: 5f73 7461 7475 7365 7329 290a 2020 2020  _statuses)).    
+00014ae0: 6966 2069 735f 6162 6e6f 726d 616c 3a0a  if is_abnormal:.
+00014af0: 2020 2020 2020 2020 6c6f 6767 6572 2e64          logger.d
+00014b00: 6562 7567 2827 5468 6520 636c 7573 7465  ebug('The cluste
+00014b10: 7220 6973 2061 626e 6f72 6d61 6c2e 2053  r is abnormal. S
+00014b20: 6574 7469 6e67 2074 6f20 494e 4954 2073  etting to INIT s
+00014b30: 7461 7475 732e 2027 0a20 2020 2020 2020  tatus. '.       
+00014b40: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+00014b50: 6e6f 6465 5f73 7461 7475 7365 733a 207b  node_statuses: {
+00014b60: 6e6f 6465 5f73 7461 7475 7365 737d 2729  node_statuses}')
+00014b70: 0a20 2020 2020 2020 2062 6163 6b65 6e64  .        backend
+00014b80: 203d 2067 6574 5f62 6163 6b65 6e64 5f66   = get_backend_f
+00014b90: 726f 6d5f 6861 6e64 6c65 2868 616e 646c  rom_handle(handl
+00014ba0: 6529 0a20 2020 2020 2020 2069 6620 6973  e).        if is
+00014bb0: 696e 7374 616e 6365 2862 6163 6b65 6e64  instance(backend
+00014bc0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00014bd0: 2020 2020 2020 2020 6261 636b 656e 6473          backends
+00014be0: 2e43 6c6f 7564 566d 5261 7942 6163 6b65  .CloudVmRayBacke
+00014bf0: 6e64 2920 616e 6420 7265 636f 7264 5b27  nd) and record['
+00014c00: 6175 746f 7374 6f70 275d 203e 3d20 303a  autostop'] >= 0:
+00014c10: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00014c20: 6e6f 7420 6261 636b 656e 642e 6973 5f64  not backend.is_d
+00014c30: 6566 696e 6974 656c 795f 6175 746f 7374  efinitely_autost
+00014c40: 6f70 7069 6e67 2868 616e 646c 652c 0a20  opping(handle,. 
+00014c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014c80: 2020 2020 2073 7472 6561 6d5f 6c6f 6773       stream_logs
+00014c90: 3d46 616c 7365 293a 0a20 2020 2020 2020  =False):.       
+00014ca0: 2020 2020 2020 2020 2023 2046 7269 656e           # Frien
+00014cb0: 646c 7920 6869 6e74 2e0a 2020 2020 2020  dly hint..      
+00014cc0: 2020 2020 2020 2020 2020 6175 746f 7374            autost
+00014cd0: 6f70 203d 2072 6563 6f72 645b 2761 7574  op = record['aut
+00014ce0: 6f73 746f 7027 5d0a 2020 2020 2020 2020  ostop'].        
+00014cf0: 2020 2020 2020 2020 6d61 7962 655f 646f          maybe_do
+00014d00: 776e 5f73 7472 203d 2027 202d 2d64 6f77  wn_str = ' --dow
+00014d10: 6e27 2069 6620 7265 636f 7264 5b27 746f  n' if record['to
+00014d20: 5f64 6f77 6e27 5d20 656c 7365 2027 270a  _down'] else ''.
+00014d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014d40: 6e6f 756e 203d 2027 6175 746f 646f 776e  noun = 'autodown
+00014d50: 2720 6966 2072 6563 6f72 645b 2774 6f5f  ' if record['to_
+00014d60: 646f 776e 275d 2065 6c73 6520 2761 7574  down'] else 'aut
+00014d70: 6f73 746f 7027 0a0a 2020 2020 2020 2020  ostop'..        
+00014d80: 2020 2020 2020 2020 2320 5265 7365 7420          # Reset 
+00014d90: 7468 6520 6175 746f 7374 6f70 7069 6e67  the autostopping
+00014da0: 2061 7320 7468 6520 636c 7573 7465 7220   as the cluster 
+00014db0: 6973 2061 626e 6f72 6d61 6c2c 2061 6e64  is abnormal, and
+00014dc0: 206d 6179 0a20 2020 2020 2020 2020 2020   may.           
+00014dd0: 2020 2020 2023 206e 6f74 2063 6f72 7265       # not corre
+00014de0: 6374 6c79 2061 7574 6f73 746f 702e 2052  ctly autostop. R
+00014df0: 6573 6574 7469 6e67 2074 6865 2061 7574  esetting the aut
+00014e00: 6f73 746f 7020 7769 6c6c 206c 6574 0a20  ostop will let. 
+00014e10: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00014e20: 2074 6865 2075 7365 7220 6b6e 6f77 2074   the user know t
+00014e30: 6861 7420 7468 6520 6175 746f 7374 6f70  hat the autostop
+00014e40: 206d 6179 206e 6f74 2068 6170 7065 6e20   may not happen 
+00014e50: 746f 2061 766f 6964 0a20 2020 2020 2020  to avoid.       
+00014e60: 2020 2020 2020 2020 2023 206c 6561 6b61           # leaka
+00014e70: 6765 7320 6672 6f6d 2074 6865 2061 7373  ges from the ass
+00014e80: 756d 7074 696f 6e20 7468 6174 2074 6865  umption that the
+00014e90: 2063 6c75 7374 6572 2077 696c 6c20 6175   cluster will au
+00014ea0: 746f 7374 6f70 2e0a 2020 2020 2020 2020  tostop..        
+00014eb0: 2020 2020 2020 2020 7375 6363 6573 7320          success 
+00014ec0: 3d20 5472 7565 0a20 2020 2020 2020 2020  = True.         
+00014ed0: 2020 2020 2020 2072 6573 6574 5f6c 6f63         reset_loc
+00014ee0: 616c 5f61 7574 6f73 746f 7020 3d20 5472  al_autostop = Tr
+00014ef0: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
+00014f00: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00014f10: 2020 2020 2020 2020 2020 2020 6261 636b              back
+00014f20: 656e 642e 7365 745f 6175 746f 7374 6f70  end.set_autostop
+00014f30: 2868 616e 646c 652c 202d 312c 2073 7472  (handle, -1, str
+00014f40: 6561 6d5f 6c6f 6773 3d46 616c 7365 290a  eam_logs=False).
+00014f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014f60: 6578 6365 7074 2065 7863 6570 7469 6f6e  except exception
+00014f70: 732e 436f 6d6d 616e 6445 7272 6f72 2061  s.CommandError a
+00014f80: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
+00014f90: 2020 2020 2020 2020 2073 7563 6365 7373           success
+00014fa0: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
+00014fb0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00014fc0: 652e 7265 7475 726e 636f 6465 203d 3d20  e.returncode == 
+00014fd0: 3235 353a 0a20 2020 2020 2020 2020 2020  255:.           
+00014fe0: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+00014ff0: 6765 722e 6465 6275 6728 6627 5468 6520  ger.debug(f'The 
+00015000: 636c 7573 7465 7220 6973 206c 696b 656c  cluster is likel
+00015010: 7920 7b6e 6f75 6e7d 6564 2e27 290a 2020  y {noun}ed.').  
+00015020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015030: 2020 2020 2020 7265 7365 745f 6c6f 6361        reset_loca
+00015040: 6c5f 6175 746f 7374 6f70 203d 2046 616c  l_autostop = Fal
+00015050: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
+00015060: 2020 2065 7863 6570 7420 2845 7863 6570     except (Excep
+00015070: 7469 6f6e 2c20 5379 7374 656d 4578 6974  tion, SystemExit
+00015080: 2920 6173 2065 3a20 2023 2070 796c 696e  ) as e:  # pylin
+00015090: 743a 2064 6973 6162 6c65 3d62 726f 6164  t: disable=broad
+000150a0: 2d65 7863 6570 740a 2020 2020 2020 2020  -except.        
+000150b0: 2020 2020 2020 2020 2020 2020 7375 6363              succ
+000150c0: 6573 7320 3d20 4661 6c73 650a 2020 2020  ess = False.    
+000150d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000150e0: 6c6f 6767 6572 2e64 6562 7567 2866 2746  logger.debug(f'F
+000150f0: 6169 6c65 6420 746f 2072 6573 6574 2061  ailed to reset a
+00015100: 7574 6f73 746f 702e 2044 7565 2074 6f20  utostop. Due to 
+00015110: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00015120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015130: 2020 2066 277b 636f 6d6d 6f6e 5f75 7469     f'{common_uti
+00015140: 6c73 2e66 6f72 6d61 745f 6578 6365 7074  ls.format_except
+00015150: 696f 6e28 6529 7d27 290a 2020 2020 2020  ion(e)}').      
+00015160: 2020 2020 2020 2020 2020 6966 2072 6573            if res
+00015170: 6574 5f6c 6f63 616c 5f61 7574 6f73 746f  et_local_autosto
+00015180: 703a 0a20 2020 2020 2020 2020 2020 2020  p:.             
+00015190: 2020 2020 2020 2067 6c6f 6261 6c5f 7573         global_us
+000151a0: 6572 5f73 7461 7465 2e73 6574 5f63 6c75  er_state.set_clu
+000151b0: 7374 6572 5f61 7574 6f73 746f 705f 7661  ster_autostop_va
+000151c0: 6c75 6528 0a20 2020 2020 2020 2020 2020  lue(.           
+000151d0: 2020 2020 2020 2020 2020 2020 2068 616e               han
+000151e0: 646c 652e 636c 7573 7465 725f 6e61 6d65  dle.cluster_name
+000151f0: 2c20 2d31 2c20 746f 5f64 6f77 6e3d 4661  , -1, to_down=Fa
+00015200: 6c73 6529 0a0a 2020 2020 2020 2020 2020  lse)..          
+00015210: 2020 2020 2020 6966 2073 7563 6365 7373        if success
+00015220: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00015230: 2020 2020 2020 6f70 6572 6174 696f 6e5f        operation_
+00015240: 7374 7220 3d20 2866 2743 616e 6365 6c65  str = (f'Cancele
+00015250: 6420 7b6e 6f75 6e7d 206f 6e20 7468 6520  d {noun} on the 
+00015260: 636c 7573 7465 7220 270a 2020 2020 2020  cluster '.      
 00015270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015280: 2020 2020 2020 2020 2020 2020 2020 6973                is
-00015290: 5f6c 6175 6e63 683d 4661 6c73 6529 0a20  _launch=False). 
-000152a0: 2020 2020 2020 2072 6574 7572 6e20 676c         return gl
-000152b0: 6f62 616c 5f75 7365 725f 7374 6174 652e  obal_user_state.
-000152c0: 6765 745f 636c 7573 7465 725f 6672 6f6d  get_cluster_from
-000152d0: 5f6e 616d 6528 636c 7573 7465 725f 6e61  _name(cluster_na
-000152e0: 6d65 290a 2020 2020 2320 4e6f 7720 6973  me).    # Now is
-000152f0: 5f61 626e 6f72 6d61 6c20 6973 2046 616c  _abnormal is Fal
-00015300: 7365 3a20 6569 7468 6572 206e 6f64 655f  se: either node_
-00015310: 7374 6174 7573 6573 2069 7320 656d 7074  statuses is empt
-00015320: 7920 6f72 2061 6c6c 206e 6f64 6573 2061  y or all nodes a
-00015330: 7265 0a20 2020 2023 2053 544f 5050 4544  re.    # STOPPED
-00015340: 2e0a 2020 2020 6261 636b 656e 6420 3d20  ..    backend = 
-00015350: 6261 636b 656e 6473 2e43 6c6f 7564 566d  backends.CloudVm
-00015360: 5261 7942 6163 6b65 6e64 2829 0a20 2020  RayBackend().   
-00015370: 2062 6163 6b65 6e64 2e70 6f73 745f 7465   backend.post_te
-00015380: 6172 646f 776e 5f63 6c65 616e 7570 2868  ardown_cleanup(h
-00015390: 616e 646c 652c 2074 6572 6d69 6e61 7465  andle, terminate
-000153a0: 3d74 6f5f 7465 726d 696e 6174 652c 2070  =to_terminate, p
-000153b0: 7572 6765 3d46 616c 7365 290a 2020 2020  urge=False).    
-000153c0: 7265 7475 726e 2067 6c6f 6261 6c5f 7573  return global_us
-000153d0: 6572 5f73 7461 7465 2e67 6574 5f63 6c75  er_state.get_clu
-000153e0: 7374 6572 5f66 726f 6d5f 6e61 6d65 2863  ster_from_name(c
-000153f0: 6c75 7374 6572 5f6e 616d 6529 0a0a 0a64  luster_name)...d
-00015400: 6566 205f 7570 6461 7465 5f63 6c75 7374  ef _update_clust
-00015410: 6572 5f73 7461 7475 7328 0a20 2020 2020  er_status(.     
-00015420: 2020 2063 6c75 7374 6572 5f6e 616d 653a     cluster_name:
-00015430: 2073 7472 2c0a 2020 2020 2020 2020 6163   str,.        ac
-00015440: 7175 6972 655f 7065 725f 636c 7573 7465  quire_per_cluste
-00015450: 725f 7374 6174 7573 5f6c 6f63 6b3a 2062  r_status_lock: b
-00015460: 6f6f 6c29 202d 3e20 4f70 7469 6f6e 616c  ool) -> Optional
-00015470: 5b44 6963 745b 7374 722c 2041 6e79 5d5d  [Dict[str, Any]]
-00015480: 3a0a 2020 2020 2222 2255 7064 6174 6520  :.    """Update 
-00015490: 7468 6520 636c 7573 7465 7220 7374 6174  the cluster stat
-000154a0: 7573 2e0a 0a20 2020 2054 6865 2063 6c75  us...    The clu
-000154b0: 7374 6572 2073 7461 7475 7320 6973 2075  ster status is u
-000154c0: 7064 6174 6564 2062 7920 6368 6563 6b69  pdated by checki
-000154d0: 6e67 2072 6179 2063 6c75 7374 6572 2061  ng ray cluster a
-000154e0: 6e64 2072 6561 6c20 7374 6174 7573 2066  nd real status f
-000154f0: 726f 6d0a 2020 2020 636c 6f75 642e 0a0a  rom.    cloud...
-00015500: 2020 2020 5468 6520 6675 6e63 7469 6f6e      The function
-00015510: 2077 696c 6c20 7570 6461 7465 2074 6865   will update the
-00015520: 2063 6163 6865 6420 636c 7573 7465 7220   cached cluster 
-00015530: 7374 6174 7573 2069 6e20 7468 6520 676c  status in the gl
-00015540: 6f62 616c 2073 7461 7465 2e20 466f 720a  obal state. For.
-00015550: 2020 2020 7468 6520 6465 7369 676e 206f      the design o
-00015560: 6620 7468 6520 636c 7573 7465 7220 7374  f the cluster st
-00015570: 6174 7573 2061 6e64 2074 7261 6e73 6974  atus and transit
-00015580: 696f 6e2c 2070 6c65 6173 6520 7265 6665  ion, please refe
-00015590: 7220 746f 2074 6865 0a20 2020 2073 6b79  r to the.    sky
-000155a0: 2f64 6573 6967 6e5f 646f 6373 2f63 6c75  /design_docs/clu
-000155b0: 7374 6572 5f73 7461 7475 732e 6d64 0a0a  ster_status.md..
-000155c0: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
-000155d0: 2020 636c 7573 7465 725f 6e61 6d65 3a20    cluster_name: 
-000155e0: 5468 6520 6e61 6d65 206f 6620 7468 6520  The name of the 
-000155f0: 636c 7573 7465 722e 0a20 2020 2020 2020  cluster..       
-00015600: 2061 6371 7569 7265 5f70 6572 5f63 6c75   acquire_per_clu
-00015610: 7374 6572 5f73 7461 7475 735f 6c6f 636b  ster_status_lock
-00015620: 3a20 5768 6574 6865 7220 746f 2061 6371  : Whether to acq
-00015630: 7569 7265 2074 6865 2070 6572 2d63 6c75  uire the per-clu
-00015640: 7374 6572 206c 6f63 6b0a 2020 2020 2020  ster lock.      
-00015650: 2020 2020 2020 6265 666f 7265 2075 7064        before upd
-00015660: 6174 696e 6720 7468 6520 7374 6174 7573  ating the status
-00015670: 2e0a 2020 2020 2020 2020 6e65 6564 5f6f  ..        need_o
-00015680: 776e 6572 5f69 6465 6e74 6974 795f 6368  wner_identity_ch
-00015690: 6563 6b3a 2057 6865 7468 6572 2074 6f20  eck: Whether to 
-000156a0: 6368 6563 6b20 7468 6520 6f77 6e65 7220  check the owner 
-000156b0: 6964 656e 7469 7479 2062 6566 6f72 650a  identity before.
-000156c0: 2020 2020 2020 2020 2020 2020 7570 6461              upda
-000156d0: 7469 6e67 0a0a 2020 2020 5265 7475 726e  ting..    Return
-000156e0: 733a 0a20 2020 2020 2020 2049 6620 7468  s:.        If th
-000156f0: 6520 636c 7573 7465 7220 6973 2074 6572  e cluster is ter
-00015700: 6d69 6e61 7465 6420 6f72 2064 6f65 7320  minated or does 
-00015710: 6e6f 7420 6578 6973 742c 2072 6574 7572  not exist, retur
-00015720: 6e20 4e6f 6e65 2e20 4f74 6865 7277 6973  n None. Otherwis
-00015730: 650a 2020 2020 2020 2020 7265 7475 726e  e.        return
-00015740: 7320 7468 6520 696e 7075 7420 7265 636f  s the input reco
-00015750: 7264 2077 6974 6820 7374 6174 7573 2061  rd with status a
-00015760: 6e64 2068 616e 646c 6520 706f 7465 6e74  nd handle potent
-00015770: 6961 6c6c 7920 7570 6461 7465 642e 0a0a  ially updated...
-00015780: 2020 2020 5261 6973 6573 3a0a 2020 2020      Raises:.    
-00015790: 2020 2020 6578 6365 7074 696f 6e73 2e43      exceptions.C
-000157a0: 6c75 7374 6572 4f77 6e65 7249 6465 6e74  lusterOwnerIdent
-000157b0: 6974 794d 6973 6d61 7463 6845 7272 6f72  ityMismatchError
-000157c0: 3a20 6966 2074 6865 2063 7572 7265 6e74  : if the current
-000157d0: 2075 7365 7220 6973 0a20 2020 2020 2020   user is.       
-000157e0: 2020 206e 6f74 2074 6865 2073 616d 6520     not the same 
-000157f0: 6173 2074 6865 2075 7365 7220 7768 6f20  as the user who 
-00015800: 6372 6561 7465 6420 7468 6520 636c 7573  created the clus
-00015810: 7465 722e 0a20 2020 2020 2020 2065 7863  ter..        exc
-00015820: 6570 7469 6f6e 732e 436c 6f75 6455 7365  eptions.CloudUse
-00015830: 7249 6465 6e74 6974 7945 7272 6f72 3a20  rIdentityError: 
-00015840: 6966 2077 6520 6661 696c 2074 6f20 6765  if we fail to ge
-00015850: 7420 7468 6520 6375 7272 656e 7420 7573  t the current us
-00015860: 6572 0a20 2020 2020 2020 2020 2069 6465  er.          ide
-00015870: 6e74 6974 792e 0a20 2020 2020 2020 2065  ntity..        e
-00015880: 7863 6570 7469 6f6e 732e 436c 7573 7465  xceptions.Cluste
-00015890: 7253 7461 7475 7346 6574 6368 696e 6745  rStatusFetchingE
-000158a0: 7272 6f72 3a20 7468 6520 636c 7573 7465  rror: the cluste
-000158b0: 7220 7374 6174 7573 2063 616e 6e6f 7420  r status cannot 
-000158c0: 6265 0a20 2020 2020 2020 2020 2066 6574  be.          fet
-000158d0: 6368 6564 2066 726f 6d20 7468 6520 636c  ched from the cl
-000158e0: 6f75 6420 7072 6f76 6964 6572 206f 7220  oud provider or 
-000158f0: 7468 6572 6520 6172 6520 6c65 616b 6564  there are leaked
-00015900: 206e 6f64 6573 2063 6175 7369 6e67 0a20   nodes causing. 
-00015910: 2020 2020 2020 2020 2074 6865 206e 6f64           the nod
-00015920: 6520 6e75 6d62 6572 206c 6172 6765 7220  e number larger 
-00015930: 7468 616e 2065 7870 6563 7465 642e 0a20  than expected.. 
-00015940: 2020 2022 2222 0a20 2020 2069 6620 6e6f     """.    if no
-00015950: 7420 6163 7175 6972 655f 7065 725f 636c  t acquire_per_cl
-00015960: 7573 7465 725f 7374 6174 7573 5f6c 6f63  uster_status_loc
-00015970: 6b3a 0a20 2020 2020 2020 2072 6574 7572  k:.        retur
-00015980: 6e20 5f75 7064 6174 655f 636c 7573 7465  n _update_cluste
-00015990: 725f 7374 6174 7573 5f6e 6f5f 6c6f 636b  r_status_no_lock
-000159a0: 2863 6c75 7374 6572 5f6e 616d 6529 0a0a  (cluster_name)..
-000159b0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-000159c0: 2023 2054 4f44 4f28 6d72 6168 656a 6129   # TODO(mraheja)
-000159d0: 3a20 7265 6d6f 7665 2070 796c 696e 7420  : remove pylint 
-000159e0: 6469 7361 626c 696e 6720 7768 656e 2066  disabling when f
-000159f0: 696c 656c 6f63 6b0a 2020 2020 2020 2020  ilelock.        
-00015a00: 2320 7665 7273 696f 6e20 7570 6461 7465  # version update
-00015a10: 640a 2020 2020 2020 2020 2320 7079 6c69  d.        # pyli
-00015a20: 6e74 3a20 6469 7361 626c 653d 6162 7374  nt: disable=abst
-00015a30: 7261 6374 2d63 6c61 7373 2d69 6e73 7461  ract-class-insta
-00015a40: 6e74 6961 7465 640a 2020 2020 2020 2020  ntiated.        
-00015a50: 7769 7468 2066 696c 656c 6f63 6b2e 4669  with filelock.Fi
-00015a60: 6c65 4c6f 636b 2843 4c55 5354 4552 5f53  leLock(CLUSTER_S
-00015a70: 5441 5455 535f 4c4f 434b 5f50 4154 482e  TATUS_LOCK_PATH.
-00015a80: 666f 726d 6174 2863 6c75 7374 6572 5f6e  format(cluster_n
-00015a90: 616d 6529 2c0a 2020 2020 2020 2020 2020  ame),.          
-00015aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015ab0: 2020 2020 2043 4c55 5354 4552 5f53 5441       CLUSTER_STA
-00015ac0: 5455 535f 4c4f 434b 5f54 494d 454f 5554  TUS_LOCK_TIMEOUT
-00015ad0: 5f53 4543 4f4e 4453 293a 0a20 2020 2020  _SECONDS):.     
-00015ae0: 2020 2020 2020 2072 6574 7572 6e20 5f75         return _u
-00015af0: 7064 6174 655f 636c 7573 7465 725f 7374  pdate_cluster_st
-00015b00: 6174 7573 5f6e 6f5f 6c6f 636b 2863 6c75  atus_no_lock(clu
-00015b10: 7374 6572 5f6e 616d 6529 0a20 2020 2065  ster_name).    e
-00015b20: 7863 6570 7420 6669 6c65 6c6f 636b 2e54  xcept filelock.T
-00015b30: 696d 656f 7574 3a0a 2020 2020 2020 2020  imeout:.        
-00015b40: 6c6f 6767 6572 2e64 6562 7567 2827 5265  logger.debug('Re
-00015b50: 6672 6573 6869 6e67 2073 7461 7475 733a  freshing status:
-00015b60: 2046 6169 6c65 6420 6765 7420 7468 6520   Failed get the 
-00015b70: 6c6f 636b 2066 6f72 2063 6c75 7374 6572  lock for cluster
-00015b80: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-00015b90: 2020 2020 2020 2020 6627 7b63 6c75 7374          f'{clust
-00015ba0: 6572 5f6e 616d 6521 727d 2e20 5573 696e  er_name!r}. Usin
-00015bb0: 6720 7468 6520 6361 6368 6564 2073 7461  g the cached sta
-00015bc0: 7475 732e 2729 0a20 2020 2020 2020 2072  tus.').        r
-00015bd0: 6574 7572 6e20 676c 6f62 616c 5f75 7365  eturn global_use
-00015be0: 725f 7374 6174 652e 6765 745f 636c 7573  r_state.get_clus
-00015bf0: 7465 725f 6672 6f6d 5f6e 616d 6528 636c  ter_from_name(cl
-00015c00: 7573 7465 725f 6e61 6d65 290a 0a0a 6465  uster_name)...de
-00015c10: 6620 7265 6672 6573 685f 636c 7573 7465  f refresh_cluste
-00015c20: 725f 7265 636f 7264 280a 2020 2020 2020  r_record(.      
-00015c30: 2020 636c 7573 7465 725f 6e61 6d65 3a20    cluster_name: 
-00015c40: 7374 722c 0a20 2020 2020 2020 202a 2c0a  str,.        *,.
-00015c50: 2020 2020 2020 2020 666f 7263 655f 7265          force_re
-00015c60: 6672 6573 685f 7374 6174 7573 6573 3a20  fresh_statuses: 
-00015c70: 4f70 7469 6f6e 616c 5b53 6574 5b73 7461  Optional[Set[sta
-00015c80: 7475 735f 6c69 622e 436c 7573 7465 7253  tus_lib.ClusterS
-00015c90: 7461 7475 735d 5d20 3d20 4e6f 6e65 2c0a  tatus]] = None,.
-00015ca0: 2020 2020 2020 2020 6163 7175 6972 655f          acquire_
-00015cb0: 7065 725f 636c 7573 7465 725f 7374 6174  per_cluster_stat
-00015cc0: 7573 5f6c 6f63 6b3a 2062 6f6f 6c20 3d20  us_lock: bool = 
-00015cd0: 5472 7565 0a29 202d 3e20 4f70 7469 6f6e  True.) -> Option
-00015ce0: 616c 5b44 6963 745b 7374 722c 2041 6e79  al[Dict[str, Any
-00015cf0: 5d5d 3a0a 2020 2020 2222 2252 6566 7265  ]]:.    """Refre
-00015d00: 7368 2074 6865 2063 6c75 7374 6572 2c20  sh the cluster, 
-00015d10: 616e 6420 7265 7475 726e 2074 6865 2070  and return the p
-00015d20: 6f73 7369 626c 7920 7570 6461 7465 6420  ossibly updated 
-00015d30: 7265 636f 7264 2e0a 0a20 2020 2054 6869  record...    Thi
-00015d40: 7320 6675 6e63 7469 6f6e 2077 696c 6c20  s function will 
-00015d50: 616c 736f 2063 6865 636b 2074 6865 206f  also check the o
-00015d60: 776e 6572 2069 6465 6e74 6974 7920 6f66  wner identity of
-00015d70: 2074 6865 2063 6c75 7374 6572 2c20 616e   the cluster, an
-00015d80: 6420 7261 6973 650a 2020 2020 6578 6365  d raise.    exce
-00015d90: 7074 696f 6e73 2069 6620 7468 6520 6375  ptions if the cu
-00015da0: 7272 656e 7420 7573 6572 2069 7320 6e6f  rrent user is no
-00015db0: 7420 7468 6520 7361 6d65 2061 7320 7468  t the same as th
-00015dc0: 6520 7573 6572 2077 686f 2063 7265 6174  e user who creat
-00015dd0: 6564 2074 6865 0a20 2020 2063 6c75 7374  ed the.    clust
-00015de0: 6572 2e0a 0a20 2020 2041 7267 733a 0a20  er...    Args:. 
-00015df0: 2020 2020 2020 2063 6c75 7374 6572 5f6e         cluster_n
-00015e00: 616d 653a 2054 6865 206e 616d 6520 6f66  ame: The name of
-00015e10: 2074 6865 2063 6c75 7374 6572 2e0a 2020   the cluster..  
-00015e20: 2020 2020 2020 666f 7263 655f 7265 6672        force_refr
-00015e30: 6573 685f 7374 6174 7573 6573 3a20 6966  esh_statuses: if
-00015e40: 2073 7065 6369 6669 6564 2c20 7265 6672   specified, refr
-00015e50: 6573 6820 7468 6520 636c 7573 7465 7220  esh the cluster 
-00015e60: 6966 2069 7420 6861 7320 6f6e 6520 6f66  if it has one of
-00015e70: 0a20 2020 2020 2020 2020 2020 2074 6865  .            the
-00015e80: 2073 7065 6369 6669 6564 2073 7461 7475   specified statu
-00015e90: 7365 732e 2041 6464 6974 696f 6e61 6c6c  ses. Additionall
-00015ea0: 792c 2063 6c75 7374 6572 7320 7361 7469  y, clusters sati
-00015eb0: 7366 7969 6e67 2074 6865 0a20 2020 2020  sfying the.     
-00015ec0: 2020 2020 2020 2066 6f6c 6c6f 7769 6e67         following
-00015ed0: 2063 6f6e 6469 7469 6f6e 7320 7769 6c6c   conditions will
-00015ee0: 2061 6c77 6179 7320 6265 2072 6566 7265   always be refre
-00015ef0: 7368 6564 206e 6f20 6d61 7474 6572 2074  shed no matter t
-00015f00: 6865 0a20 2020 2020 2020 2020 2020 2061  he.            a
-00015f10: 7267 756d 656e 7420 6973 2073 7065 6369  rgument is speci
-00015f20: 6669 6564 206f 7220 6e6f 743a 0a20 2020  fied or not:.   
-00015f30: 2020 2020 2020 2020 2020 2020 2031 2e20               1. 
-00015f40: 6973 2061 2073 706f 7420 636c 7573 7465  is a spot cluste
-00015f50: 722c 206f 720a 2020 2020 2020 2020 2020  r, or.          
-00015f60: 2020 2020 2020 322e 2069 7320 6120 6e6f        2. is a no
-00015f70: 6e2d 7370 6f74 2063 6c75 7374 6572 2c20  n-spot cluster, 
-00015f80: 6973 206e 6f74 2053 544f 5050 4544 2c20  is not STOPPED, 
-00015f90: 616e 6420 6175 746f 7374 6f70 2069 7320  and autostop is 
-00015fa0: 7365 742e 0a20 2020 2020 2020 2061 6371  set..        acq
-00015fb0: 7569 7265 5f70 6572 5f63 6c75 7374 6572  uire_per_cluster
-00015fc0: 5f73 7461 7475 735f 6c6f 636b 3a20 5768  _status_lock: Wh
-00015fd0: 6574 6865 7220 746f 2061 6371 7569 7265  ether to acquire
-00015fe0: 2074 6865 2070 6572 2d63 6c75 7374 6572   the per-cluster
-00015ff0: 206c 6f63 6b0a 2020 2020 2020 2020 2020   lock.          
-00016000: 2020 6265 666f 7265 2075 7064 6174 696e    before updatin
-00016010: 6720 7468 6520 7374 6174 7573 2e0a 0a20  g the status... 
-00016020: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
-00016030: 2020 2020 4966 2074 6865 2063 6c75 7374      If the clust
-00016040: 6572 2069 7320 7465 726d 696e 6174 6564  er is terminated
-00016050: 206f 7220 646f 6573 206e 6f74 2065 7869   or does not exi
-00016060: 7374 2c20 7265 7475 726e 204e 6f6e 652e  st, return None.
-00016070: 0a20 2020 2020 2020 204f 7468 6572 7769  .        Otherwi
-00016080: 7365 2072 6574 7572 6e73 2074 6865 2063  se returns the c
-00016090: 6c75 7374 6572 2072 6563 6f72 642e 0a0a  luster record...
-000160a0: 2020 2020 5261 6973 6573 3a0a 2020 2020      Raises:.    
-000160b0: 2020 2020 6578 6365 7074 696f 6e73 2e43      exceptions.C
-000160c0: 6c75 7374 6572 4f77 6e65 7249 6465 6e74  lusterOwnerIdent
-000160d0: 6974 794d 6973 6d61 7463 6845 7272 6f72  ityMismatchError
-000160e0: 3a20 6966 2074 6865 2063 7572 7265 6e74  : if the current
-000160f0: 2075 7365 7220 6973 0a20 2020 2020 2020   user is.       
-00016100: 2020 206e 6f74 2074 6865 2073 616d 6520     not the same 
-00016110: 6173 2074 6865 2075 7365 7220 7768 6f20  as the user who 
-00016120: 6372 6561 7465 6420 7468 6520 636c 7573  created the clus
-00016130: 7465 722e 0a20 2020 2020 2020 2065 7863  ter..        exc
-00016140: 6570 7469 6f6e 732e 436c 6f75 6455 7365  eptions.CloudUse
-00016150: 7249 6465 6e74 6974 7945 7272 6f72 3a20  rIdentityError: 
-00016160: 6966 2077 6520 6661 696c 2074 6f20 6765  if we fail to ge
-00016170: 7420 7468 6520 6375 7272 656e 7420 7573  t the current us
-00016180: 6572 0a20 2020 2020 2020 2020 2069 6465  er.          ide
-00016190: 6e74 6974 792e 0a20 2020 2020 2020 2065  ntity..        e
-000161a0: 7863 6570 7469 6f6e 732e 436c 7573 7465  xceptions.Cluste
-000161b0: 7253 7461 7475 7346 6574 6368 696e 6745  rStatusFetchingE
-000161c0: 7272 6f72 3a20 7468 6520 636c 7573 7465  rror: the cluste
-000161d0: 7220 7374 6174 7573 2063 616e 6e6f 7420  r status cannot 
-000161e0: 6265 0a20 2020 2020 2020 2020 2066 6574  be.          fet
-000161f0: 6368 6564 2066 726f 6d20 7468 6520 636c  ched from the cl
-00016200: 6f75 6420 7072 6f76 6964 6572 206f 7220  oud provider or 
-00016210: 7468 6572 6520 6172 6520 6c65 616b 6564  there are leaked
-00016220: 206e 6f64 6573 2063 6175 7369 6e67 0a20   nodes causing. 
-00016230: 2020 2020 2020 2020 2074 6865 206e 6f64           the nod
-00016240: 6520 6e75 6d62 6572 206c 6172 6765 7220  e number larger 
-00016250: 7468 616e 2065 7870 6563 7465 642e 0a20  than expected.. 
-00016260: 2020 2022 2222 0a0a 2020 2020 7265 636f     """..    reco
-00016270: 7264 203d 2067 6c6f 6261 6c5f 7573 6572  rd = global_user
-00016280: 5f73 7461 7465 2e67 6574 5f63 6c75 7374  _state.get_clust
-00016290: 6572 5f66 726f 6d5f 6e61 6d65 2863 6c75  er_from_name(clu
-000162a0: 7374 6572 5f6e 616d 6529 0a20 2020 2069  ster_name).    i
-000162b0: 6620 7265 636f 7264 2069 7320 4e6f 6e65  f record is None
-000162c0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-000162d0: 204e 6f6e 650a 2020 2020 6368 6563 6b5f   None.    check_
-000162e0: 6f77 6e65 725f 6964 656e 7469 7479 2863  owner_identity(c
-000162f0: 6c75 7374 6572 5f6e 616d 6529 0a0a 2020  luster_name)..  
-00016300: 2020 6861 6e64 6c65 203d 2072 6563 6f72    handle = recor
-00016310: 645b 2768 616e 646c 6527 5d0a 2020 2020  d['handle'].    
-00016320: 6966 2069 7369 6e73 7461 6e63 6528 6861  if isinstance(ha
-00016330: 6e64 6c65 2c20 6261 636b 656e 6473 2e43  ndle, backends.C
-00016340: 6c6f 7564 566d 5261 7952 6573 6f75 7263  loudVmRayResourc
-00016350: 6548 616e 646c 6529 3a0a 2020 2020 2020  eHandle):.      
-00016360: 2020 7573 655f 7370 6f74 203d 2068 616e    use_spot = han
-00016370: 646c 652e 6c61 756e 6368 6564 5f72 6573  dle.launched_res
-00016380: 6f75 7263 6573 2e75 7365 5f73 706f 740a  ources.use_spot.
-00016390: 2020 2020 2020 2020 6861 735f 6175 746f          has_auto
-000163a0: 7374 6f70 203d 2028 7265 636f 7264 5b27  stop = (record['
-000163b0: 7374 6174 7573 275d 2021 3d20 7374 6174  status'] != stat
-000163c0: 7573 5f6c 6962 2e43 6c75 7374 6572 5374  us_lib.ClusterSt
-000163d0: 6174 7573 2e53 544f 5050 4544 2061 6e64  atus.STOPPED and
-000163e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000163f0: 2020 2020 2020 2020 2072 6563 6f72 645b           record[
-00016400: 2761 7574 6f73 746f 7027 5d20 3e3d 2030  'autostop'] >= 0
-00016410: 290a 2020 2020 2020 2020 666f 7263 655f  ).        force_
-00016420: 7265 6672 6573 685f 666f 725f 636c 7573  refresh_for_clus
-00016430: 7465 7220 3d20 2866 6f72 6365 5f72 6566  ter = (force_ref
-00016440: 7265 7368 5f73 7461 7475 7365 7320 6973  resh_statuses is
-00016450: 206e 6f74 204e 6f6e 6520 616e 640a 2020   not None and.  
-00016460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016480: 2020 2072 6563 6f72 645b 2773 7461 7475     record['statu
-00016490: 7327 5d20 696e 2066 6f72 6365 5f72 6566  s'] in force_ref
-000164a0: 7265 7368 5f73 7461 7475 7365 7329 0a20  resh_statuses). 
-000164b0: 2020 2020 2020 2069 6620 666f 7263 655f         if force_
-000164c0: 7265 6672 6573 685f 666f 725f 636c 7573  refresh_for_clus
-000164d0: 7465 7220 6f72 2068 6173 5f61 7574 6f73  ter or has_autos
-000164e0: 746f 7020 6f72 2075 7365 5f73 706f 743a  top or use_spot:
-000164f0: 0a20 2020 2020 2020 2020 2020 2072 6563  .            rec
-00016500: 6f72 6420 3d20 5f75 7064 6174 655f 636c  ord = _update_cl
-00016510: 7573 7465 725f 7374 6174 7573 280a 2020  uster_status(.  
-00016520: 2020 2020 2020 2020 2020 2020 2020 636c                cl
-00016530: 7573 7465 725f 6e61 6d65 2c0a 2020 2020  uster_name,.    
-00016540: 2020 2020 2020 2020 2020 2020 6163 7175              acqu
-00016550: 6972 655f 7065 725f 636c 7573 7465 725f  ire_per_cluster_
-00016560: 7374 6174 7573 5f6c 6f63 6b3d 6163 7175  status_lock=acqu
-00016570: 6972 655f 7065 725f 636c 7573 7465 725f  ire_per_cluster_
-00016580: 7374 6174 7573 5f6c 6f63 6b29 0a20 2020  status_lock).   
-00016590: 2072 6574 7572 6e20 7265 636f 7264 0a0a   return record..
-000165a0: 0a40 7469 6d65 6c69 6e65 2e65 7665 6e74  .@timeline.event
-000165b0: 0a64 6566 2072 6566 7265 7368 5f63 6c75  .def refresh_clu
-000165c0: 7374 6572 5f73 7461 7475 735f 6861 6e64  ster_status_hand
-000165d0: 6c65 280a 2020 2020 636c 7573 7465 725f  le(.    cluster_
-000165e0: 6e61 6d65 3a20 7374 722c 0a20 2020 202a  name: str,.    *
-000165f0: 2c0a 2020 2020 666f 7263 655f 7265 6672  ,.    force_refr
-00016600: 6573 685f 7374 6174 7573 6573 3a20 4f70  esh_statuses: Op
-00016610: 7469 6f6e 616c 5b53 6574 5b73 7461 7475  tional[Set[statu
-00016620: 735f 6c69 622e 436c 7573 7465 7253 7461  s_lib.ClusterSta
-00016630: 7475 735d 5d20 3d20 4e6f 6e65 2c0a 2020  tus]] = None,.  
-00016640: 2020 6163 7175 6972 655f 7065 725f 636c    acquire_per_cl
-00016650: 7573 7465 725f 7374 6174 7573 5f6c 6f63  uster_status_loc
-00016660: 6b3a 2062 6f6f 6c20 3d20 5472 7565 2c0a  k: bool = True,.
-00016670: 2920 2d3e 2054 7570 6c65 5b4f 7074 696f  ) -> Tuple[Optio
-00016680: 6e61 6c5b 7374 6174 7573 5f6c 6962 2e43  nal[status_lib.C
-00016690: 6c75 7374 6572 5374 6174 7573 5d2c 0a20  lusterStatus],. 
-000166a0: 2020 2020 2020 2020 2020 4f70 7469 6f6e            Option
-000166b0: 616c 5b62 6163 6b65 6e64 732e 5265 736f  al[backends.Reso
-000166c0: 7572 6365 4861 6e64 6c65 5d5d 3a0a 2020  urceHandle]]:.  
-000166d0: 2020 2222 2252 6566 7265 7368 2074 6865    """Refresh the
-000166e0: 2063 6c75 7374 6572 2c20 616e 6420 7265   cluster, and re
-000166f0: 7475 726e 2074 6865 2070 6f73 7369 626c  turn the possibl
-00016700: 7920 7570 6461 7465 6420 7374 6174 7573  y updated status
-00016710: 2061 6e64 2068 616e 646c 652e 0a0a 2020   and handle...  
-00016720: 2020 5468 6973 2069 7320 6120 7772 6170    This is a wrap
-00016730: 7065 7220 6f66 2072 6566 7265 7368 5f63  per of refresh_c
-00016740: 6c75 7374 6572 5f72 6563 6f72 642c 2077  luster_record, w
-00016750: 6869 6368 2072 6574 7572 6e73 2074 6865  hich returns the
-00016760: 2073 7461 7475 7320 616e 640a 2020 2020   status and.    
-00016770: 6861 6e64 6c65 206f 6620 7468 6520 636c  handle of the cl
-00016780: 7573 7465 722e 0a20 2020 2050 6c65 6173  uster..    Pleas
-00016790: 6520 7265 6665 7220 746f 2074 6865 2064  e refer to the d
-000167a0: 6f63 7374 7269 6e67 206f 6620 7265 6672  ocstring of refr
-000167b0: 6573 685f 636c 7573 7465 725f 7265 636f  esh_cluster_reco
-000167c0: 7264 2066 6f72 2074 6865 2064 6574 6169  rd for the detai
-000167d0: 6c73 2e0a 2020 2020 2222 220a 2020 2020  ls..    """.    
-000167e0: 7265 636f 7264 203d 2072 6566 7265 7368  record = refresh
-000167f0: 5f63 6c75 7374 6572 5f72 6563 6f72 6428  _cluster_record(
-00016800: 0a20 2020 2020 2020 2063 6c75 7374 6572  .        cluster
-00016810: 5f6e 616d 652c 0a20 2020 2020 2020 2066  _name,.        f
-00016820: 6f72 6365 5f72 6566 7265 7368 5f73 7461  orce_refresh_sta
-00016830: 7475 7365 733d 666f 7263 655f 7265 6672  tuses=force_refr
-00016840: 6573 685f 7374 6174 7573 6573 2c0a 2020  esh_statuses,.  
-00016850: 2020 2020 2020 6163 7175 6972 655f 7065        acquire_pe
-00016860: 725f 636c 7573 7465 725f 7374 6174 7573  r_cluster_status
-00016870: 5f6c 6f63 6b3d 6163 7175 6972 655f 7065  _lock=acquire_pe
-00016880: 725f 636c 7573 7465 725f 7374 6174 7573  r_cluster_status
-00016890: 5f6c 6f63 6b29 0a20 2020 2069 6620 7265  _lock).    if re
-000168a0: 636f 7264 2069 7320 4e6f 6e65 3a0a 2020  cord is None:.  
-000168b0: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
-000168c0: 652c 204e 6f6e 650a 2020 2020 7265 7475  e, None.    retu
-000168d0: 726e 2072 6563 6f72 645b 2773 7461 7475  rn record['statu
-000168e0: 7327 5d2c 2072 6563 6f72 645b 2768 616e  s'], record['han
-000168f0: 646c 6527 5d0a 0a0a 2320 3d3d 3d3d 3d3d  dle']...# ======
-00016900: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00016910: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a  ===============.
-00016920: 0a0a 4074 7970 696e 672e 6f76 6572 6c6f  ..@typing.overlo
-00016930: 6164 0a64 6566 2063 6865 636b 5f63 6c75  ad.def check_clu
-00016940: 7374 6572 5f61 7661 696c 6162 6c65 280a  ster_available(.
-00016950: 2020 2020 636c 7573 7465 725f 6e61 6d65      cluster_name
-00016960: 3a20 7374 722c 0a20 2020 202a 2c0a 2020  : str,.    *,.  
-00016970: 2020 6f70 6572 6174 696f 6e3a 2073 7472    operation: str
-00016980: 2c0a 2020 2020 6368 6563 6b5f 636c 6f75  ,.    check_clou
-00016990: 645f 766d 5f72 6179 5f62 6163 6b65 6e64  d_vm_ray_backend
-000169a0: 3a20 4c69 7465 7261 6c5b 5472 7565 5d20  : Literal[True] 
-000169b0: 3d20 5472 7565 2c0a 2020 2020 6472 7972  = True,.    dryr
-000169c0: 756e 3a20 626f 6f6c 203d 202e 2e2e 2c0a  un: bool = ...,.
-000169d0: 2920 2d3e 2027 636c 6f75 645f 766d 5f72  ) -> 'cloud_vm_r
-000169e0: 6179 5f62 6163 6b65 6e64 2e43 6c6f 7564  ay_backend.Cloud
-000169f0: 566d 5261 7952 6573 6f75 7263 6548 616e  VmRayResourceHan
-00016a00: 646c 6527 3a0a 2020 2020 2e2e 2e0a 0a0a  dle':.    ......
-00016a10: 4074 7970 696e 672e 6f76 6572 6c6f 6164  @typing.overload
-00016a20: 0a64 6566 2063 6865 636b 5f63 6c75 7374  .def check_clust
-00016a30: 6572 5f61 7661 696c 6162 6c65 280a 2020  er_available(.  
-00016a40: 2020 636c 7573 7465 725f 6e61 6d65 3a20    cluster_name: 
-00016a50: 7374 722c 0a20 2020 202a 2c0a 2020 2020  str,.    *,.    
-00016a60: 6f70 6572 6174 696f 6e3a 2073 7472 2c0a  operation: str,.
-00016a70: 2020 2020 6368 6563 6b5f 636c 6f75 645f      check_cloud_
-00016a80: 766d 5f72 6179 5f62 6163 6b65 6e64 3a20  vm_ray_backend: 
-00016a90: 4c69 7465 7261 6c5b 4661 6c73 655d 2c0a  Literal[False],.
-00016aa0: 2020 2020 6472 7972 756e 3a20 626f 6f6c      dryrun: bool
-00016ab0: 203d 202e 2e2e 2c0a 2920 2d3e 2062 6163   = ...,.) -> bac
-00016ac0: 6b65 6e64 732e 5265 736f 7572 6365 4861  kends.ResourceHa
-00016ad0: 6e64 6c65 3a0a 2020 2020 2e2e 2e0a 0a0a  ndle:.    ......
-00016ae0: 6465 6620 6368 6563 6b5f 636c 7573 7465  def check_cluste
-00016af0: 725f 6176 6169 6c61 626c 6528 0a20 2020  r_available(.   
-00016b00: 2063 6c75 7374 6572 5f6e 616d 653a 2073   cluster_name: s
-00016b10: 7472 2c0a 2020 2020 2a2c 0a20 2020 206f  tr,.    *,.    o
-00016b20: 7065 7261 7469 6f6e 3a20 7374 722c 0a20  peration: str,. 
-00016b30: 2020 2063 6865 636b 5f63 6c6f 7564 5f76     check_cloud_v
-00016b40: 6d5f 7261 795f 6261 636b 656e 643a 2062  m_ray_backend: b
-00016b50: 6f6f 6c20 3d20 5472 7565 2c0a 2020 2020  ool = True,.    
-00016b60: 6472 7972 756e 3a20 626f 6f6c 203d 2046  dryrun: bool = F
-00016b70: 616c 7365 2c0a 2920 2d3e 2062 6163 6b65  alse,.) -> backe
-00016b80: 6e64 732e 5265 736f 7572 6365 4861 6e64  nds.ResourceHand
-00016b90: 6c65 3a0a 2020 2020 2222 2243 6865 636b  le:.    """Check
-00016ba0: 2069 6620 7468 6520 636c 7573 7465 7220   if the cluster 
-00016bb0: 6973 2061 7661 696c 6162 6c65 2e0a 0a20  is available... 
-00016bc0: 2020 2052 6169 7365 733a 0a20 2020 2020     Raises:.     
-00016bd0: 2020 2056 616c 7565 4572 726f 723a 2069     ValueError: i
-00016be0: 6620 7468 6520 636c 7573 7465 7220 646f  f the cluster do
-00016bf0: 6573 206e 6f74 2065 7869 7374 2e0a 2020  es not exist..  
-00016c00: 2020 2020 2020 6578 6365 7074 696f 6e73        exceptions
-00016c10: 2e43 6c75 7374 6572 4e6f 7455 7045 7272  .ClusterNotUpErr
-00016c20: 6f72 3a20 6966 2074 6865 2063 6c75 7374  or: if the clust
-00016c30: 6572 2069 7320 6e6f 7420 5550 2e0a 2020  er is not UP..  
-00016c40: 2020 2020 2020 6578 6365 7074 696f 6e73        exceptions
-00016c50: 2e4e 6f74 5375 7070 6f72 7465 6445 7272  .NotSupportedErr
-00016c60: 6f72 3a20 6966 2074 6865 2063 6c75 7374  or: if the clust
-00016c70: 6572 2069 7320 6e6f 7420 6261 7365 6420  er is not based 
-00016c80: 6f6e 0a20 2020 2020 2020 2020 2043 6c6f  on.          Clo
-00016c90: 7564 566d 5261 7942 6163 6b65 6e64 2e0a  udVmRayBackend..
-00016ca0: 2020 2020 2020 2020 6578 6365 7074 696f          exceptio
-00016cb0: 6e73 2e43 6c75 7374 6572 4f77 6e65 7249  ns.ClusterOwnerI
-00016cc0: 6465 6e74 6974 794d 6973 6d61 7463 6845  dentityMismatchE
-00016cd0: 7272 6f72 3a20 6966 2074 6865 2063 7572  rror: if the cur
-00016ce0: 7265 6e74 2075 7365 7220 6973 0a20 2020  rent user is.   
-00016cf0: 2020 2020 2020 206e 6f74 2074 6865 2073         not the s
-00016d00: 616d 6520 6173 2074 6865 2075 7365 7220  ame as the user 
-00016d10: 7768 6f20 6372 6561 7465 6420 7468 6520  who created the 
-00016d20: 636c 7573 7465 722e 0a20 2020 2020 2020  cluster..       
-00016d30: 2065 7863 6570 7469 6f6e 732e 436c 6f75   exceptions.Clou
-00016d40: 6455 7365 7249 6465 6e74 6974 7945 7272  dUserIdentityErr
-00016d50: 6f72 3a20 6966 2077 6520 6661 696c 2074  or: if we fail t
-00016d60: 6f20 6765 7420 7468 6520 6375 7272 656e  o get the curren
-00016d70: 7420 7573 6572 0a20 2020 2020 2020 2020  t user.         
-00016d80: 2069 6465 6e74 6974 792e 0a20 2020 2022   identity..    "
-00016d90: 2222 0a20 2020 2072 6563 6f72 6420 3d20  "".    record = 
-00016da0: 676c 6f62 616c 5f75 7365 725f 7374 6174  global_user_stat
-00016db0: 652e 6765 745f 636c 7573 7465 725f 6672  e.get_cluster_fr
-00016dc0: 6f6d 5f6e 616d 6528 636c 7573 7465 725f  om_name(cluster_
-00016dd0: 6e61 6d65 290a 2020 2020 6966 2064 7279  name).    if dry
-00016de0: 7275 6e3a 0a20 2020 2020 2020 2061 7373  run:.        ass
-00016df0: 6572 7420 7265 636f 7264 2069 7320 6e6f  ert record is no
-00016e00: 7420 4e6f 6e65 2c20 636c 7573 7465 725f  t None, cluster_
-00016e10: 6e61 6d65 0a20 2020 2020 2020 2072 6574  name.        ret
-00016e20: 7572 6e20 7265 636f 7264 5b27 6861 6e64  urn record['hand
-00016e30: 6c65 275d 0a0a 2020 2020 7072 6576 696f  le']..    previo
-00016e40: 7573 5f63 6c75 7374 6572 5f73 7461 7475  us_cluster_statu
-00016e50: 7320 3d20 4e6f 6e65 0a20 2020 2069 6620  s = None.    if 
-00016e60: 7265 636f 7264 2069 7320 6e6f 7420 4e6f  record is not No
-00016e70: 6e65 3a0a 2020 2020 2020 2020 7072 6576  ne:.        prev
-00016e80: 696f 7573 5f63 6c75 7374 6572 5f73 7461  ious_cluster_sta
-00016e90: 7475 7320 3d20 7265 636f 7264 5b27 7374  tus = record['st
-00016ea0: 6174 7573 275d 0a0a 2020 2020 7472 793a  atus']..    try:
-00016eb0: 0a20 2020 2020 2020 2063 6c75 7374 6572  .        cluster
-00016ec0: 5f73 7461 7475 732c 2068 616e 646c 6520  _status, handle 
-00016ed0: 3d20 7265 6672 6573 685f 636c 7573 7465  = refresh_cluste
-00016ee0: 725f 7374 6174 7573 5f68 616e 646c 6528  r_status_handle(
-00016ef0: 636c 7573 7465 725f 6e61 6d65 290a 2020  cluster_name).  
-00016f00: 2020 6578 6365 7074 2065 7863 6570 7469    except excepti
-00016f10: 6f6e 732e 436c 7573 7465 7253 7461 7475  ons.ClusterStatu
-00016f20: 7346 6574 6368 696e 6745 7272 6f72 2061  sFetchingError a
-00016f30: 7320 653a 0a20 2020 2020 2020 2023 2046  s e:.        # F
-00016f40: 6169 6c65 6420 746f 2072 6566 7265 7368  ailed to refresh
-00016f50: 2074 6865 2063 6c75 7374 6572 2073 7461   the cluster sta
-00016f60: 7475 7320 6973 206e 6f74 2066 6174 616c  tus is not fatal
-00016f70: 2065 7272 6f72 2061 7320 7468 6520 6361   error as the ca
-00016f80: 6c6c 6572 730a 2020 2020 2020 2020 2320  llers.        # 
-00016f90: 6361 6e20 7374 696c 6c20 6265 2064 6f6e  can still be don
-00016fa0: 6520 6279 206f 6e6c 7920 7573 696e 6720  e by only using 
-00016fb0: 7373 682c 2062 7574 2074 6865 2073 7368  ssh, but the ssh
-00016fc0: 2063 616e 2068 616e 6720 6966 2074 6865   can hang if the
-00016fd0: 0a20 2020 2020 2020 2023 2063 6c75 7374  .        # clust
-00016fe0: 6572 2069 7320 6e6f 7420 7570 2028 652e  er is not up (e.
-00016ff0: 672e 2c20 6175 746f 7374 6f70 7065 6429  g., autostopped)
-00017000: 2e0a 0a20 2020 2020 2020 2023 2057 6520  ...        # We 
-00017010: 646f 206e 6f74 2063 6174 6368 2074 6865  do not catch the
-00017020: 2065 7863 6570 7469 6f6e 2066 6f72 2063   exception for c
-00017030: 6c6f 7564 2069 6465 6e74 6974 7920 6368  loud identity ch
-00017040: 6563 6b69 6e67 2066 6f72 206e 6f77 2c20  ecking for now, 
-00017050: 696e 0a20 2020 2020 2020 2023 206f 7264  in.        # ord
-00017060: 6572 2074 6f20 6469 7361 626c 6520 616c  er to disable al
-00017070: 6c20 6f70 6572 6174 696f 6e73 206f 6e20  l operations on 
-00017080: 636c 7573 7465 7273 2063 7265 6174 6564  clusters created
-00017090: 2062 7920 616e 6f74 6865 7220 7573 6572   by another user
-000170a0: 0a20 2020 2020 2020 2023 2069 6465 6e74  .        # ident
-000170b0: 6974 792e 2020 5468 6174 2077 696c 6c20  ity.  That will 
-000170c0: 6d61 6b65 2074 6865 2064 6573 6967 6e20  make the design 
-000170d0: 7369 6d70 6c65 7220 616e 6420 6561 7369  simpler and easi
-000170e0: 6572 2074 6f0a 2020 2020 2020 2020 2320  er to.        # 
-000170f0: 756e 6465 7273 7461 6e64 2c20 6275 7420  understand, but 
-00017100: 6974 206d 6967 6874 2062 6520 7573 6566  it might be usef
-00017110: 756c 2074 6f20 616c 6c6f 7720 7468 6520  ul to allow the 
-00017120: 7573 6572 2074 6f20 7573 650a 2020 2020  user to use.    
-00017130: 2020 2020 2320 6f70 6572 6174 696f 6e73      # operations
-00017140: 2074 6861 7420 6f6e 6c79 2069 6e76 6f6c   that only invol
-00017150: 7665 2073 7368 2028 652e 672e 2c20 736b  ve ssh (e.g., sk
-00017160: 7920 6578 6563 2c20 736b 7920 6c6f 6773  y exec, sky logs
-00017170: 2c20 6574 6329 2065 7665 6e0a 2020 2020  , etc) even.    
-00017180: 2020 2020 2320 6966 2074 6865 2075 7365      # if the use
-00017190: 7220 6973 206e 6f74 2074 6865 206f 776e  r is not the own
-000171a0: 6572 206f 6620 7468 6520 636c 7573 7465  er of the cluste
-000171b0: 722e 0a20 2020 2020 2020 2075 785f 7574  r..        ux_ut
-000171c0: 696c 732e 636f 6e73 6f6c 655f 6e65 776c  ils.console_newl
-000171d0: 696e 6528 290a 2020 2020 2020 2020 6c6f  ine().        lo
-000171e0: 6767 6572 2e77 6172 6e69 6e67 280a 2020  gger.warning(.  
-000171f0: 2020 2020 2020 2020 2020 6627 4661 696c            f'Fail
-00017200: 6564 2074 6f20 7265 6672 6573 6820 7468  ed to refresh th
-00017210: 6520 7374 6174 7573 2066 6f72 2063 6c75  e status for clu
-00017220: 7374 6572 207b 636c 7573 7465 725f 6e61  ster {cluster_na
-00017230: 6d65 2172 7d2e 2049 7420 6973 2027 0a20  me!r}. It is '. 
-00017240: 2020 2020 2020 2020 2020 2066 276e 6f74             f'not
-00017250: 2066 6174 616c 2c20 6275 7420 7b6f 7065   fatal, but {ope
-00017260: 7261 7469 6f6e 7d20 6d69 6768 7420 6861  ration} might ha
-00017270: 6e67 2069 6620 7468 6520 636c 7573 7465  ng if the cluste
-00017280: 7220 6973 206e 6f74 2075 702e 5c6e 270a  r is not up.\n'.
-00017290: 2020 2020 2020 2020 2020 2020 6627 4465              f'De
-000172a0: 7461 696c 6564 2072 6561 736f 6e3a 207b  tailed reason: {
-000172b0: 657d 2729 0a20 2020 2020 2020 2069 6620  e}').        if 
-000172c0: 7265 636f 7264 2069 7320 4e6f 6e65 3a0a  record is None:.
-000172d0: 2020 2020 2020 2020 2020 2020 636c 7573              clus
-000172e0: 7465 725f 7374 6174 7573 2c20 6861 6e64  ter_status, hand
-000172f0: 6c65 203d 204e 6f6e 652c 204e 6f6e 650a  le = None, None.
-00017300: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00017310: 2020 2020 2020 2020 2020 636c 7573 7465            cluste
-00017320: 725f 7374 6174 7573 2c20 6861 6e64 6c65  r_status, handle
-00017330: 203d 2072 6563 6f72 645b 2773 7461 7475   = record['statu
-00017340: 7327 5d2c 2072 6563 6f72 645b 2768 616e  s'], record['han
-00017350: 646c 6527 5d0a 0a20 2020 2062 7269 6768  dle']..    brigh
-00017360: 7420 3d20 636f 6c6f 7261 6d61 2e53 7479  t = colorama.Sty
-00017370: 6c65 2e42 5249 4748 540a 2020 2020 7265  le.BRIGHT.    re
-00017380: 7365 7420 3d20 636f 6c6f 7261 6d61 2e53  set = colorama.S
-00017390: 7479 6c65 2e52 4553 4554 5f41 4c4c 0a20  tyle.RESET_ALL. 
-000173a0: 2020 2069 6620 6861 6e64 6c65 2069 7320     if handle is 
-000173b0: 4e6f 6e65 3a0a 2020 2020 2020 2020 6966  None:.        if
-000173c0: 2070 7265 7669 6f75 735f 636c 7573 7465   previous_cluste
-000173d0: 725f 7374 6174 7573 2069 7320 4e6f 6e65  r_status is None
-000173e0: 3a0a 2020 2020 2020 2020 2020 2020 6572  :.            er
-000173f0: 726f 725f 6d73 6720 3d20 6627 436c 7573  ror_msg = f'Clus
-00017400: 7465 7220 7b63 6c75 7374 6572 5f6e 616d  ter {cluster_nam
-00017410: 6521 727d 2064 6f65 7320 6e6f 7420 6578  e!r} does not ex
-00017420: 6973 742e 270a 2020 2020 2020 2020 656c  ist.'.        el
-00017430: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00017440: 6572 726f 725f 6d73 6720 3d20 2866 2743  error_msg = (f'C
-00017450: 6c75 7374 6572 207b 636c 7573 7465 725f  luster {cluster_
-00017460: 6e61 6d65 2172 7d20 6e6f 7420 666f 756e  name!r} not foun
-00017470: 6420 6f6e 2074 6865 2063 6c6f 7564 2027  d on the cloud '
-00017480: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017490: 2020 2020 2020 2020 2020 2770 726f 7669            'provi
-000174a0: 6465 722e 2729 0a20 2020 2020 2020 2020  der.').         
-000174b0: 2020 2061 7373 6572 7420 7265 636f 7264     assert record
-000174c0: 2069 7320 6e6f 7420 4e6f 6e65 2c20 7072   is not None, pr
-000174d0: 6576 696f 7573 5f63 6c75 7374 6572 5f73  evious_cluster_s
-000174e0: 7461 7475 730a 2020 2020 2020 2020 2020  tatus.          
-000174f0: 2020 6163 7469 6f6e 7320 3d20 5b5d 0a20    actions = []. 
-00017500: 2020 2020 2020 2020 2020 2069 6620 7265             if re
-00017510: 636f 7264 5b27 6861 6e64 6c65 275d 2e6c  cord['handle'].l
-00017520: 6175 6e63 6865 645f 7265 736f 7572 6365  aunched_resource
-00017530: 732e 7573 655f 7370 6f74 3a0a 2020 2020  s.use_spot:.    
-00017540: 2020 2020 2020 2020 2020 2020 6163 7469              acti
-00017550: 6f6e 732e 6170 7065 6e64 2827 7072 6565  ons.append('pree
-00017560: 6d70 7465 6427 290a 2020 2020 2020 2020  mpted').        
-00017570: 2020 2020 6966 2072 6563 6f72 645b 2761      if record['a
-00017580: 7574 6f73 746f 7027 5d20 3e20 3020 616e  utostop'] > 0 an
-00017590: 6420 7265 636f 7264 5b27 746f 5f64 6f77  d record['to_dow
-000175a0: 6e27 5d3a 0a20 2020 2020 2020 2020 2020  n']:.           
-000175b0: 2020 2020 2061 6374 696f 6e73 2e61 7070       actions.app
-000175c0: 656e 6428 2761 7574 6f64 6f77 6e65 6427  end('autodowned'
-000175d0: 290a 2020 2020 2020 2020 2020 2020 6163  ).            ac
-000175e0: 7469 6f6e 732e 6170 7065 6e64 2827 6d61  tions.append('ma
-000175f0: 6e75 616c 6c79 2074 6572 6d69 6e61 7465  nually terminate
-00017600: 6420 696e 2063 6f6e 736f 6c65 2729 0a20  d in console'). 
-00017610: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
-00017620: 6e28 6163 7469 6f6e 7329 203e 2031 3a0a  n(actions) > 1:.
-00017630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017640: 6163 7469 6f6e 735b 2d31 5d20 3d20 276f  actions[-1] = 'o
-00017650: 7220 2720 2b20 6163 7469 6f6e 735b 2d31  r ' + actions[-1
-00017660: 5d0a 2020 2020 2020 2020 2020 2020 6163  ].            ac
-00017670: 7469 6f6e 735f 7374 7220 3d20 272c 2027  tions_str = ', '
-00017680: 2e6a 6f69 6e28 6163 7469 6f6e 7329 0a20  .join(actions). 
-00017690: 2020 2020 2020 2020 2020 206d 6573 7361             messa
-000176a0: 6765 203d 2066 2720 4974 2077 6173 206c  ge = f' It was l
-000176b0: 696b 656c 7920 7b61 6374 696f 6e73 5f73  ikely {actions_s
-000176c0: 7472 7d2e 270a 2020 2020 2020 2020 2020  tr}.'.          
-000176d0: 2020 6966 206c 656e 2861 6374 696f 6e73    if len(actions
-000176e0: 2920 3e20 313a 0a20 2020 2020 2020 2020  ) > 1:.         
-000176f0: 2020 2020 2020 206d 6573 7361 6765 203d         message =
-00017700: 206d 6573 7361 6765 2e72 6570 6c61 6365   message.replace
-00017710: 2827 6c69 6b65 6c79 272c 2027 6569 7468  ('likely', 'eith
-00017720: 6572 2729 0a20 2020 2020 2020 2020 2020  er').           
-00017730: 2065 7272 6f72 5f6d 7367 202b 3d20 6d65   error_msg += me
-00017740: 7373 6167 650a 0a20 2020 2020 2020 2077  ssage..        w
-00017750: 6974 6820 7578 5f75 7469 6c73 2e70 7269  ith ux_utils.pri
-00017760: 6e74 5f65 7863 6570 7469 6f6e 5f6e 6f5f  nt_exception_no_
-00017770: 7472 6163 6562 6163 6b28 293a 0a20 2020  traceback():.   
-00017780: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
-00017790: 616c 7565 4572 726f 7228 6627 7b63 6f6c  alueError(f'{col
-000177a0: 6f72 616d 612e 466f 7265 2e59 454c 4c4f  orama.Fore.YELLO
-000177b0: 577d 7b65 7272 6f72 5f6d 7367 7d7b 7265  W}{error_msg}{re
-000177c0: 7365 747d 2729 0a20 2020 2061 7373 6572  set}').    asser
-000177d0: 7420 636c 7573 7465 725f 7374 6174 7573  t cluster_status
-000177e0: 2069 7320 6e6f 7420 4e6f 6e65 2c20 2768   is not None, 'h
-000177f0: 616e 646c 6520 6973 206e 6f74 204e 6f6e  andle is not Non
-00017800: 6520 6275 7420 7374 6174 7573 2069 7320  e but status is 
-00017810: 4e6f 6e65 270a 2020 2020 6261 636b 656e  None'.    backen
-00017820: 6420 3d20 6765 745f 6261 636b 656e 645f  d = get_backend_
-00017830: 6672 6f6d 5f68 616e 646c 6528 6861 6e64  from_handle(hand
-00017840: 6c65 290a 2020 2020 6966 2063 6865 636b  le).    if check
-00017850: 5f63 6c6f 7564 5f76 6d5f 7261 795f 6261  _cloud_vm_ray_ba
-00017860: 636b 656e 6420 616e 6420 6e6f 7420 6973  ckend and not is
-00017870: 696e 7374 616e 6365 280a 2020 2020 2020  instance(.      
-00017880: 2020 2020 2020 6261 636b 656e 642c 2062        backend, b
-00017890: 6163 6b65 6e64 732e 436c 6f75 6456 6d52  ackends.CloudVmR
-000178a0: 6179 4261 636b 656e 6429 3a0a 2020 2020  ayBackend):.    
-000178b0: 2020 2020 7769 7468 2075 785f 7574 696c      with ux_util
-000178c0: 732e 7072 696e 745f 6578 6365 7074 696f  s.print_exceptio
-000178d0: 6e5f 6e6f 5f74 7261 6365 6261 636b 2829  n_no_traceback()
-000178e0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-000178f0: 6973 6520 6578 6365 7074 696f 6e73 2e4e  ise exceptions.N
-00017900: 6f74 5375 7070 6f72 7465 6445 7272 6f72  otSupportedError
-00017910: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00017920: 2020 6627 7b63 6f6c 6f72 616d 612e 466f    f'{colorama.Fo
-00017930: 7265 2e59 454c 4c4f 577d 7b6f 7065 7261  re.YELLOW}{opera
-00017940: 7469 6f6e 2e63 6170 6974 616c 697a 6528  tion.capitalize(
-00017950: 297d 3a20 736b 6970 7065 6420 666f 7220  )}: skipped for 
-00017960: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00017970: 2020 6627 636c 7573 7465 7220 7b63 6c75    f'cluster {clu
-00017980: 7374 6572 5f6e 616d 6521 727d 2e20 4974  ster_name!r}. It
-00017990: 2069 7320 6f6e 6c79 2073 7570 706f 7274   is only support
-000179a0: 6564 2062 7920 6261 636b 656e 643a 2027  ed by backend: '
-000179b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000179c0: 2066 277b 6261 636b 656e 6473 2e43 6c6f   f'{backends.Clo
-000179d0: 7564 566d 5261 7942 6163 6b65 6e64 2e4e  udVmRayBackend.N
-000179e0: 414d 457d 2e27 0a20 2020 2020 2020 2020  AME}.'.         
-000179f0: 2020 2020 2020 2066 277b 7265 7365 747d         f'{reset}
-00017a00: 2729 0a20 2020 2069 6620 636c 7573 7465  ').    if cluste
-00017a10: 725f 7374 6174 7573 2021 3d20 7374 6174  r_status != stat
-00017a20: 7573 5f6c 6962 2e43 6c75 7374 6572 5374  us_lib.ClusterSt
-00017a30: 6174 7573 2e55 503a 0a20 2020 2020 2020  atus.UP:.       
-00017a40: 2077 6974 6820 7578 5f75 7469 6c73 2e70   with ux_utils.p
-00017a50: 7269 6e74 5f65 7863 6570 7469 6f6e 5f6e  rint_exception_n
-00017a60: 6f5f 7472 6163 6562 6163 6b28 293a 0a20  o_traceback():. 
-00017a70: 2020 2020 2020 2020 2020 2068 696e 745f             hint_
-00017a80: 666f 725f 696e 6974 203d 2027 270a 2020  for_init = ''.  
-00017a90: 2020 2020 2020 2020 2020 6966 2063 6c75            if clu
-00017aa0: 7374 6572 5f73 7461 7475 7320 3d3d 2073  ster_status == s
-00017ab0: 7461 7475 735f 6c69 622e 436c 7573 7465  tatus_lib.Cluste
-00017ac0: 7253 7461 7475 732e 494e 4954 3a0a 2020  rStatus.INIT:.  
-00017ad0: 2020 2020 2020 2020 2020 2020 2020 6869                hi
-00017ae0: 6e74 5f66 6f72 5f69 6e69 7420 3d20 280a  nt_for_init = (.
-00017af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017b00: 2020 2020 6627 7b72 6573 6574 7d20 5761      f'{reset} Wa
-00017b10: 6974 2066 6f72 2061 206c 6175 6e63 6820  it for a launch 
-00017b20: 746f 2066 696e 6973 682c 206f 7220 7573  to finish, or us
-00017b30: 6520 7468 6973 2063 6f6d 6d61 6e64 2027  e this command '
-00017b40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017b50: 2020 2020 2066 2774 6f20 7472 7920 746f       f'to try to
-00017b60: 2074 7261 6e73 6974 696f 6e20 7468 6520   transition the 
-00017b70: 636c 7573 7465 7220 746f 2055 503a 207b  cluster to UP: {
-00017b80: 6272 6967 6874 7d73 6b79 2027 0a20 2020  bright}sky '.   
-00017b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017ba0: 2066 2773 7461 7274 207b 636c 7573 7465   f'start {cluste
-00017bb0: 725f 6e61 6d65 7d7b 7265 7365 747d 2729  r_name}{reset}')
-00017bc0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-00017bd0: 7365 2065 7863 6570 7469 6f6e 732e 436c  se exceptions.Cl
-00017be0: 7573 7465 724e 6f74 5570 4572 726f 7228  usterNotUpError(
-00017bf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017c00: 2066 277b 636f 6c6f 7261 6d61 2e46 6f72   f'{colorama.For
-00017c10: 652e 5945 4c4c 4f57 7d7b 6f70 6572 6174  e.YELLOW}{operat
-00017c20: 696f 6e2e 6361 7069 7461 6c69 7a65 2829  ion.capitalize()
-00017c30: 7d3a 2073 6b69 7070 6564 2066 6f72 2027  }: skipped for '
-00017c40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017c50: 2066 2763 6c75 7374 6572 207b 636c 7573   f'cluster {clus
-00017c60: 7465 725f 6e61 6d65 2172 7d20 2873 7461  ter_name!r} (sta
-00017c70: 7475 733a 207b 636c 7573 7465 725f 7374  tus: {cluster_st
-00017c80: 6174 7573 2e76 616c 7565 7d29 2e20 270a  atus.value}). '.
-00017c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017ca0: 2749 7420 6973 206f 6e6c 7920 616c 6c6f  'It is only allo
-00017cb0: 7765 6420 666f 7220 270a 2020 2020 2020  wed for '.      
-00017cc0: 2020 2020 2020 2020 2020 6627 7b73 7461            f'{sta
-00017cd0: 7475 735f 6c69 622e 436c 7573 7465 7253  tus_lib.ClusterS
-00017ce0: 7461 7475 732e 5550 2e76 616c 7565 7d20  tatus.UP.value} 
-00017cf0: 636c 7573 7465 7273 2e27 0a20 2020 2020  clusters.'.     
-00017d00: 2020 2020 2020 2020 2020 2066 277b 6869             f'{hi
-00017d10: 6e74 5f66 6f72 5f69 6e69 747d 270a 2020  nt_for_init}'.  
-00017d20: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-00017d30: 7b72 6573 6574 7d27 2c0a 2020 2020 2020  {reset}',.      
-00017d40: 2020 2020 2020 2020 2020 636c 7573 7465            cluste
-00017d50: 725f 7374 6174 7573 3d63 6c75 7374 6572  r_status=cluster
-00017d60: 5f73 7461 7475 732c 0a20 2020 2020 2020  _status,.       
-00017d70: 2020 2020 2020 2020 2068 616e 646c 653d           handle=
-00017d80: 6861 6e64 6c65 290a 0a20 2020 2069 6620  handle)..    if 
-00017d90: 6861 6e64 6c65 2e68 6561 645f 6970 2069  handle.head_ip i
-00017da0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-00017db0: 7769 7468 2075 785f 7574 696c 732e 7072  with ux_utils.pr
-00017dc0: 696e 745f 6578 6365 7074 696f 6e5f 6e6f  int_exception_no
-00017dd0: 5f74 7261 6365 6261 636b 2829 3a0a 2020  _traceback():.  
-00017de0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00017df0: 6578 6365 7074 696f 6e73 2e43 6c75 7374  exceptions.Clust
-00017e00: 6572 4e6f 7455 7045 7272 6f72 280a 2020  erNotUpError(.  
-00017e10: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-00017e20: 436c 7573 7465 7220 7b63 6c75 7374 6572  Cluster {cluster
-00017e30: 5f6e 616d 6521 727d 2068 6173 2062 6565  _name!r} has bee
-00017e40: 6e20 7374 6f70 7065 6420 6f72 206e 6f74  n stopped or not
-00017e50: 2070 726f 7065 726c 7920 270a 2020 2020   properly '.    
-00017e60: 2020 2020 2020 2020 2020 2020 2773 6574              'set
-00017e70: 2075 702e 2050 6c65 6173 6520 7265 2d6c   up. Please re-l
-00017e80: 6175 6e63 6820 6974 2077 6974 6820 6073  aunch it with `s
-00017e90: 6b79 2073 7461 7274 602e 272c 0a20 2020  ky start`.',.   
-00017ea0: 2020 2020 2020 2020 2020 2020 2063 6c75               clu
-00017eb0: 7374 6572 5f73 7461 7475 733d 636c 7573  ster_status=clus
-00017ec0: 7465 725f 7374 6174 7573 2c0a 2020 2020  ter_status,.    
-00017ed0: 2020 2020 2020 2020 2020 2020 6861 6e64              hand
-00017ee0: 6c65 3d68 616e 646c 6529 0a20 2020 2072  le=handle).    r
-00017ef0: 6574 7572 6e20 6861 6e64 6c65 0a0a 0a23  eturn handle...#
-00017f00: 2054 4f44 4f28 7469 616e 293a 2052 6566   TODO(tian): Ref
-00017f10: 6163 746f 7220 746f 2063 6f6e 7472 6f6c  actor to control
-00017f20: 6c65 725f 7574 696c 732e 2043 7572 7265  ler_utils. Curre
-00017f30: 6e74 2062 6c6f 636b 6572 3a20 6369 7263  nt blocker: circ
-00017f40: 756c 6172 2069 6d70 6f72 742e 0a64 6566  ular import..def
-00017f50: 2069 735f 636f 6e74 726f 6c6c 6572 5f75   is_controller_u
-00017f60: 7028 0a20 2020 2063 6f6e 7472 6f6c 6c65  p(.    controlle
-00017f70: 725f 7479 7065 3a20 636f 6e74 726f 6c6c  r_type: controll
-00017f80: 6572 5f75 7469 6c73 2e43 6f6e 7472 6f6c  er_utils.Control
-00017f90: 6c65 7273 2c0a 2020 2020 7374 6f70 7065  lers,.    stoppe
-00017fa0: 645f 6d65 7373 6167 653a 2073 7472 2c0a  d_message: str,.
-00017fb0: 2020 2020 6e6f 6e5f 6578 6973 7465 6e74      non_existent
-00017fc0: 5f6d 6573 7361 6765 3a20 4f70 7469 6f6e  _message: Option
-00017fd0: 616c 5b73 7472 5d20 3d20 4e6f 6e65 2c0a  al[str] = None,.
-00017fe0: 2920 2d3e 2054 7570 6c65 5b4f 7074 696f  ) -> Tuple[Optio
-00017ff0: 6e61 6c5b 7374 6174 7573 5f6c 6962 2e43  nal[status_lib.C
-00018000: 6c75 7374 6572 5374 6174 7573 5d2c 0a20  lusterStatus],. 
-00018010: 2020 2020 2020 2020 2020 4f70 7469 6f6e            Option
-00018020: 616c 5b27 6261 636b 656e 6473 2e43 6c6f  al['backends.Clo
-00018030: 7564 566d 5261 7952 6573 6f75 7263 6548  udVmRayResourceH
-00018040: 616e 646c 6527 5d5d 3a0a 2020 2020 2222  andle']]:.    ""
-00018050: 2243 6865 636b 2069 6620 7468 6520 7370  "Check if the sp
-00018060: 6f74 2f73 6572 7665 2063 6f6e 7472 6f6c  ot/serve control
-00018070: 6c65 7220 6973 2075 702e 0a0a 2020 2020  ler is up...    
-00018080: 4974 2063 616e 2062 6520 7573 6564 2074  It can be used t
-00018090: 6f20 6368 6563 6b20 7468 6520 6163 7475  o check the actu
-000180a0: 616c 2063 6f6e 7472 6f6c 6c65 7220 7374  al controller st
-000180b0: 6174 7573 2028 7369 6e63 6520 7468 6520  atus (since the 
-000180c0: 6175 746f 7374 6f70 2069 730a 2020 2020  autostop is.    
-000180d0: 7365 7420 666f 7220 7468 6520 636f 6e74  set for the cont
-000180e0: 726f 6c6c 6572 2920 6265 666f 7265 2074  roller) before t
-000180f0: 6865 2073 706f 742f 7365 7276 6520 636f  he spot/serve co
-00018100: 6d6d 616e 6473 2069 6e74 6572 6163 7420  mmands interact 
-00018110: 7769 7468 2074 6865 0a20 2020 2063 6f6e  with the.    con
-00018120: 7472 6f6c 6c65 722e 0a0a 2020 2020 4172  troller...    Ar
-00018130: 6773 3a0a 2020 2020 2020 2020 7479 7065  gs:.        type
-00018140: 3a20 5479 7065 206f 6620 7468 6520 636f  : Type of the co
-00018150: 6e74 726f 6c6c 6572 2e0a 2020 2020 2020  ntroller..      
-00018160: 2020 7374 6f70 7065 645f 6d65 7373 6167    stopped_messag
-00018170: 653a 204d 6573 7361 6765 2074 6f20 7072  e: Message to pr
-00018180: 696e 7420 6966 2074 6865 2063 6f6e 7472  int if the contr
-00018190: 6f6c 6c65 7220 6973 2053 544f 5050 4544  oller is STOPPED
-000181a0: 2e0a 2020 2020 2020 2020 6e6f 6e5f 6578  ..        non_ex
-000181b0: 6973 7465 6e74 5f6d 6573 7361 6765 3a20  istent_message: 
-000181c0: 4d65 7373 6167 6520 746f 2073 686f 7720  Message to show 
-000181d0: 6966 2074 6865 2063 6f6e 7472 6f6c 6c65  if the controlle
-000181e0: 7220 646f 6573 206e 6f74 2065 7869 7374  r does not exist
-000181f0: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
-00018200: 2020 2020 2020 2020 636f 6e74 726f 6c6c          controll
-00018210: 6572 5f73 7461 7475 733a 2054 6865 2073  er_status: The s
-00018220: 7461 7475 7320 6f66 2074 6865 2063 6f6e  tatus of the con
-00018230: 7472 6f6c 6c65 722e 2049 6620 6974 2066  troller. If it f
-00018240: 6169 6c73 2064 7572 696e 670a 2020 2020  ails during.    
-00018250: 2020 2020 2020 7265 6672 6573 6869 6e67        refreshing
-00018260: 2074 6865 2073 7461 7475 732c 2069 7420   the status, it 
-00018270: 7769 6c6c 2062 6520 7468 6520 6361 6368  will be the cach
-00018280: 6564 2073 7461 7475 732e 204e 6f6e 6520  ed status. None 
-00018290: 6966 2074 6865 0a20 2020 2020 2020 2020  if the.         
-000182a0: 2063 6f6e 7472 6f6c 6c65 7220 646f 6573   controller does
-000182b0: 206e 6f74 2065 7869 7374 2e0a 2020 2020   not exist..    
-000182c0: 2020 2020 6861 6e64 6c65 3a20 5468 6520      handle: The 
-000182d0: 5265 736f 7572 6365 4861 6e64 6c65 206f  ResourceHandle o
-000182e0: 6620 7468 6520 636f 6e74 726f 6c6c 6572  f the controller
-000182f0: 2e20 4e6f 6e65 2069 6620 7468 650a 2020  . None if the.  
-00018300: 2020 2020 2020 2020 636f 6e74 726f 6c6c          controll
-00018310: 6572 2069 7320 6e6f 7420 5550 206f 7220  er is not UP or 
-00018320: 646f 6573 206e 6f74 2065 7869 7374 2e0a  does not exist..
-00018330: 0a20 2020 2052 6169 7365 733a 0a20 2020  .    Raises:.   
-00018340: 2020 2020 2065 7863 6570 7469 6f6e 732e       exceptions.
-00018350: 436c 7573 7465 724f 776e 6572 4964 656e  ClusterOwnerIden
-00018360: 7469 7479 4d69 736d 6174 6368 4572 726f  tityMismatchErro
-00018370: 723a 2069 6620 7468 6520 6375 7272 656e  r: if the curren
-00018380: 7420 7573 6572 2069 7320 6e6f 740a 2020  t user is not.  
-00018390: 2020 2020 2020 2020 7468 6520 7361 6d65          the same
-000183a0: 2061 7320 7468 6520 7573 6572 2077 686f   as the user who
-000183b0: 2063 7265 6174 6564 2074 6865 2063 6c75   created the clu
-000183c0: 7374 6572 2e0a 2020 2020 2020 2020 6578  ster..        ex
-000183d0: 6365 7074 696f 6e73 2e43 6c6f 7564 5573  ceptions.CloudUs
-000183e0: 6572 4964 656e 7469 7479 4572 726f 723a  erIdentityError:
-000183f0: 2069 6620 7765 2066 6169 6c20 746f 2067   if we fail to g
-00018400: 6574 2074 6865 2063 7572 7265 6e74 2075  et the current u
-00018410: 7365 720a 2020 2020 2020 2020 2020 6964  ser.          id
-00018420: 656e 7469 7479 2e0a 2020 2020 2222 220a  entity..    """.
-00018430: 2020 2020 6966 206e 6f6e 5f65 7869 7374      if non_exist
-00018440: 656e 745f 6d65 7373 6167 6520 6973 204e  ent_message is N
-00018450: 6f6e 653a 0a20 2020 2020 2020 206e 6f6e  one:.        non
-00018460: 5f65 7869 7374 656e 745f 6d65 7373 6167  _existent_messag
-00018470: 6520 3d20 280a 2020 2020 2020 2020 2020  e = (.          
-00018480: 2020 636f 6e74 726f 6c6c 6572 5f74 7970    controller_typ
-00018490: 652e 7661 6c75 652e 6465 6661 756c 745f  e.value.default_
-000184a0: 6869 6e74 5f69 665f 6e6f 6e5f 6578 6973  hint_if_non_exis
-000184b0: 7465 6e74 290a 2020 2020 636c 7573 7465  tent).    cluste
-000184c0: 725f 6e61 6d65 203d 2063 6f6e 7472 6f6c  r_name = control
-000184d0: 6c65 725f 7479 7065 2e76 616c 7565 2e63  ler_type.value.c
-000184e0: 6c75 7374 6572 5f6e 616d 650a 2020 2020  luster_name.    
-000184f0: 636f 6e74 726f 6c6c 6572 5f6e 616d 6520  controller_name 
-00018500: 3d20 636f 6e74 726f 6c6c 6572 5f74 7970  = controller_typ
-00018510: 652e 7661 6c75 652e 6e61 6d65 2e72 6570  e.value.name.rep
-00018520: 6c61 6365 2827 2063 6f6e 7472 6f6c 6c65  lace(' controlle
-00018530: 7227 2c20 2727 290a 2020 2020 7472 793a  r', '').    try:
-00018540: 0a20 2020 2020 2020 2023 2053 6574 2066  .        # Set f
-00018550: 6f72 6365 5f72 6566 7265 7368 5f73 7461  orce_refresh_sta
-00018560: 7475 7365 733d 4e6f 6e65 2074 6f20 6d61  tuses=None to ma
-00018570: 6b65 2073 7572 6520 7468 6520 7265 6672  ke sure the refr
-00018580: 6573 6820 6f6e 6c79 2068 6170 7065 6e73  esh only happens
-00018590: 0a20 2020 2020 2020 2023 2077 6865 6e20  .        # when 
-000185a0: 7468 6520 636f 6e74 726f 6c6c 6572 2069  the controller i
-000185b0: 7320 494e 4954 2f55 5020 2874 7269 6767  s INIT/UP (trigg
-000185c0: 6572 6564 2069 6e20 7468 6573 6520 7374  ered in these st
-000185d0: 6174 7573 6573 2061 7320 7468 650a 2020  atuses as the.  
-000185e0: 2020 2020 2020 2320 6175 746f 7374 6f70        # autostop
-000185f0: 2069 7320 616c 7761 7973 2073 6574 2066   is always set f
-00018600: 6f72 2074 6865 2063 6f6e 7472 6f6c 6c65  or the controlle
-00018610: 7229 2e20 5468 6973 206f 7074 696d 697a  r). This optimiz
-00018620: 6174 696f 6e20 6176 6f69 6473 0a20 2020  ation avoids.   
-00018630: 2020 2020 2023 2075 6e6e 6563 6573 7361       # unnecessa
-00018640: 7279 2063 6f73 746c 7920 7265 6672 6573  ry costly refres
-00018650: 6820 7768 656e 2074 6865 2063 6f6e 7472  h when the contr
-00018660: 6f6c 6c65 7220 6973 2061 6c72 6561 6479  oller is already
-00018670: 2073 746f 7070 6564 2e0a 2020 2020 2020   stopped..      
-00018680: 2020 2320 5468 6973 206f 7074 696d 697a    # This optimiz
-00018690: 6174 696f 6e20 6973 2062 6173 6564 206f  ation is based o
-000186a0: 6e20 7468 6520 6173 7375 6d70 7469 6f6e  n the assumption
-000186b0: 2074 6861 7420 7468 6520 7573 6572 2077   that the user w
-000186c0: 696c 6c20 6e6f 740a 2020 2020 2020 2020  ill not.        
-000186d0: 2320 7374 6172 7420 7468 6520 636f 6e74  # start the cont
-000186e0: 726f 6c6c 6572 206d 616e 7561 6c6c 7920  roller manually 
-000186f0: 6672 6f6d 2074 6865 2063 6c6f 7564 2063  from the cloud c
-00018700: 6f6e 736f 6c65 2e0a 2020 2020 2020 2020  onsole..        
-00018710: 636f 6e74 726f 6c6c 6572 5f73 7461 7475  controller_statu
-00018720: 732c 2068 616e 646c 6520 3d20 7265 6672  s, handle = refr
-00018730: 6573 685f 636c 7573 7465 725f 7374 6174  esh_cluster_stat
-00018740: 7573 5f68 616e 646c 6528 0a20 2020 2020  us_handle(.     
-00018750: 2020 2020 2020 2063 6c75 7374 6572 5f6e         cluster_n
-00018760: 616d 652c 2066 6f72 6365 5f72 6566 7265  ame, force_refre
-00018770: 7368 5f73 7461 7475 7365 733d 4e6f 6e65  sh_statuses=None
-00018780: 290a 2020 2020 6578 6365 7074 2065 7863  ).    except exc
-00018790: 6570 7469 6f6e 732e 436c 7573 7465 7253  eptions.ClusterS
-000187a0: 7461 7475 7346 6574 6368 696e 6745 7272  tatusFetchingErr
-000187b0: 6f72 2061 7320 653a 0a20 2020 2020 2020  or as e:.       
-000187c0: 2023 2057 6520 646f 206e 6f74 2063 6174   # We do not cat
-000187d0: 6368 2074 6865 2065 7863 6570 7469 6f6e  ch the exception
-000187e0: 7320 7265 6c61 7465 6420 746f 2074 6865  s related to the
-000187f0: 2063 6c75 7374 6572 206f 776e 6572 2069   cluster owner i
-00018800: 6465 6e74 6974 790a 2020 2020 2020 2020  dentity.        
-00018810: 2320 6d69 736d 6174 6368 2c20 706c 6561  # mismatch, plea
-00018820: 7365 2072 6566 6572 2074 6f20 7468 6520  se refer to the 
-00018830: 636f 6d6d 656e 7420 696e 0a20 2020 2020  comment in.     
-00018840: 2020 2023 2060 6261 636b 656e 645f 7574     # `backend_ut
-00018850: 696c 732e 6368 6563 6b5f 636c 7573 7465  ils.check_cluste
-00018860: 725f 6176 6169 6c61 626c 6560 2e0a 2020  r_available`..  
-00018870: 2020 2020 2020 6c6f 6767 6572 2e77 6172        logger.war
-00018880: 6e69 6e67 280a 2020 2020 2020 2020 2020  ning(.          
-00018890: 2020 2746 6169 6c65 6420 746f 2067 6574    'Failed to get
-000188a0: 2074 6865 2073 7461 7475 7320 6f66 2074   the status of t
-000188b0: 6865 2063 6f6e 7472 6f6c 6c65 722e 2049  he controller. I
-000188c0: 7420 6973 206e 6f74 2027 0a20 2020 2020  t is not '.     
-000188d0: 2020 2020 2020 2066 2766 6174 616c 2c20         f'fatal, 
-000188e0: 6275 7420 7b63 6f6e 7472 6f6c 6c65 725f  but {controller_
-000188f0: 6e61 6d65 7d20 636f 6d6d 616e 6473 2f63  name} commands/c
-00018900: 616c 6c73 206d 6179 2068 616e 6720 6f72  alls may hang or
-00018910: 2072 6574 7572 6e20 270a 2020 2020 2020   return '.      
-00018920: 2020 2020 2020 2773 7461 6c65 2069 6e66        'stale inf
-00018930: 6f72 6d61 7469 6f6e 2c20 7768 656e 2074  ormation, when t
-00018940: 6865 2063 6f6e 7472 6f6c 6c65 7220 6973  he controller is
-00018950: 206e 6f74 2075 702e 5c6e 270a 2020 2020   not up.\n'.    
-00018960: 2020 2020 2020 2020 6627 2020 4465 7461          f'  Deta
-00018970: 696c 733a 207b 636f 6d6d 6f6e 5f75 7469  ils: {common_uti
-00018980: 6c73 2e66 6f72 6d61 745f 6578 6365 7074  ls.format_except
-00018990: 696f 6e28 652c 2075 7365 5f62 7261 636b  ion(e, use_brack
-000189a0: 6574 3d54 7275 6529 7d27 290a 2020 2020  et=True)}').    
-000189b0: 2020 2020 7265 636f 7264 203d 2067 6c6f      record = glo
-000189c0: 6261 6c5f 7573 6572 5f73 7461 7465 2e67  bal_user_state.g
-000189d0: 6574 5f63 6c75 7374 6572 5f66 726f 6d5f  et_cluster_from_
-000189e0: 6e61 6d65 2863 6c75 7374 6572 5f6e 616d  name(cluster_nam
-000189f0: 6529 0a20 2020 2020 2020 2063 6f6e 7472  e).        contr
-00018a00: 6f6c 6c65 725f 7374 6174 7573 2c20 6861  oller_status, ha
-00018a10: 6e64 6c65 203d 204e 6f6e 652c 204e 6f6e  ndle = None, Non
-00018a20: 650a 2020 2020 2020 2020 6966 2072 6563  e.        if rec
-00018a30: 6f72 6420 6973 206e 6f74 204e 6f6e 653a  ord is not None:
-00018a40: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-00018a50: 7472 6f6c 6c65 725f 7374 6174 7573 2c20  troller_status, 
-00018a60: 6861 6e64 6c65 203d 2072 6563 6f72 645b  handle = record[
-00018a70: 2773 7461 7475 7327 5d2c 2072 6563 6f72  'status'], recor
-00018a80: 645b 2768 616e 646c 6527 5d0a 0a20 2020  d['handle']..   
-00018a90: 2069 6620 636f 6e74 726f 6c6c 6572 5f73   if controller_s
-00018aa0: 7461 7475 7320 6973 204e 6f6e 653a 0a20  tatus is None:. 
-00018ab0: 2020 2020 2020 2073 6b79 5f6c 6f67 6769         sky_loggi
-00018ac0: 6e67 2e70 7269 6e74 286e 6f6e 5f65 7869  ng.print(non_exi
-00018ad0: 7374 656e 745f 6d65 7373 6167 6529 0a20  stent_message). 
-00018ae0: 2020 2065 6c69 6620 636f 6e74 726f 6c6c     elif controll
-00018af0: 6572 5f73 7461 7475 7320 213d 2073 7461  er_status != sta
-00018b00: 7475 735f 6c69 622e 436c 7573 7465 7253  tus_lib.ClusterS
-00018b10: 7461 7475 732e 5550 3a0a 2020 2020 2020  tatus.UP:.      
-00018b20: 2020 6d73 6720 3d20 2866 277b 636f 6e74    msg = (f'{cont
-00018b30: 726f 6c6c 6572 5f6e 616d 652e 6361 7069  roller_name.capi
-00018b40: 7461 6c69 7a65 2829 7d20 636f 6e74 726f  talize()} contro
-00018b50: 6c6c 6572 207b 636c 7573 7465 725f 6e61  ller {cluster_na
-00018b60: 6d65 7d20 270a 2020 2020 2020 2020 2020  me} '.          
-00018b70: 2020 2020 2066 2769 7320 7b63 6f6e 7472       f'is {contr
-00018b80: 6f6c 6c65 725f 7374 6174 7573 2e76 616c  oller_status.val
-00018b90: 7565 7d2e 2729 0a20 2020 2020 2020 2069  ue}.').        i
-00018ba0: 6620 636f 6e74 726f 6c6c 6572 5f73 7461  f controller_sta
-00018bb0: 7475 7320 3d3d 2073 7461 7475 735f 6c69  tus == status_li
-00018bc0: 622e 436c 7573 7465 7253 7461 7475 732e  b.ClusterStatus.
-00018bd0: 5354 4f50 5045 443a 0a20 2020 2020 2020  STOPPED:.       
-00018be0: 2020 2020 206d 7367 202b 3d20 6627 5c6e       msg += f'\n
-00018bf0: 7b73 746f 7070 6564 5f6d 6573 7361 6765  {stopped_message
-00018c00: 7d27 0a20 2020 2020 2020 2069 6620 636f  }'.        if co
-00018c10: 6e74 726f 6c6c 6572 5f73 7461 7475 7320  ntroller_status 
-00018c20: 3d3d 2073 7461 7475 735f 6c69 622e 436c  == status_lib.Cl
-00018c30: 7573 7465 7253 7461 7475 732e 494e 4954  usterStatus.INIT
-00018c40: 3a0a 2020 2020 2020 2020 2020 2020 6d73  :.            ms
-00018c50: 6720 2b3d 2027 5c6e 506c 6561 7365 2077  g += '\nPlease w
-00018c60: 6169 7420 666f 7220 7468 6520 636f 6e74  ait for the cont
-00018c70: 726f 6c6c 6572 2074 6f20 6265 2072 6561  roller to be rea
-00018c80: 6479 2e27 0a20 2020 2020 2020 2073 6b79  dy.'.        sky
-00018c90: 5f6c 6f67 6769 6e67 2e70 7269 6e74 286d  _logging.print(m
-00018ca0: 7367 290a 2020 2020 2020 2020 6861 6e64  sg).        hand
-00018cb0: 6c65 203d 204e 6f6e 650a 2020 2020 7265  le = None.    re
-00018cc0: 7475 726e 2063 6f6e 7472 6f6c 6c65 725f  turn controller_
-00018cd0: 7374 6174 7573 2c20 6861 6e64 6c65 0a0a  status, handle..
-00018ce0: 0a63 6c61 7373 2043 6c6f 7564 4669 6c74  .class CloudFilt
-00018cf0: 6572 2865 6e75 6d2e 456e 756d 293a 0a20  er(enum.Enum):. 
-00018d00: 2020 2023 2046 696c 7465 7220 666f 7220     # Filter for 
-00018d10: 616c 6c20 7479 7065 7320 6f66 2063 6c6f  all types of clo
-00018d20: 7564 732e 0a20 2020 2041 4c4c 203d 2027  uds..    ALL = '
-00018d30: 616c 6c27 0a20 2020 2023 2046 696c 7465  all'.    # Filte
-00018d40: 7220 666f 7220 536b 7927 7320 6d61 696e  r for Sky's main
-00018d50: 2063 6c6f 7564 7320 2861 7773 2c20 6763   clouds (aws, gc
-00018d60: 702c 2061 7a75 7265 2c20 646f 636b 6572  p, azure, docker
-00018d70: 292e 0a20 2020 2043 4c4f 5544 535f 414e  )..    CLOUDS_AN
-00018d80: 445f 444f 434b 4552 203d 2027 636c 6f75  D_DOCKER = 'clou
-00018d90: 6473 2d61 6e64 2d64 6f63 6b65 7227 0a20  ds-and-docker'. 
-00018da0: 2020 2023 2046 696c 7465 7220 666f 7220     # Filter for 
-00018db0: 6f6e 6c79 206c 6f63 616c 2063 6c6f 7564  only local cloud
-00018dc0: 732e 0a20 2020 204c 4f43 414c 203d 2027  s..    LOCAL = '
-00018dd0: 6c6f 6361 6c27 0a0a 0a64 6566 2067 6574  local'...def get
-00018de0: 5f63 6c75 7374 6572 7328 0a20 2020 2069  _clusters(.    i
-00018df0: 6e63 6c75 6465 5f63 6f6e 7472 6f6c 6c65  nclude_controlle
-00018e00: 723a 2062 6f6f 6c2c 0a20 2020 2072 6566  r: bool,.    ref
-00018e10: 7265 7368 3a20 626f 6f6c 2c0a 2020 2020  resh: bool,.    
-00018e20: 636c 7573 7465 725f 6e61 6d65 733a 204f  cluster_names: O
-00018e30: 7074 696f 6e61 6c5b 556e 696f 6e5b 7374  ptional[Union[st
-00018e40: 722c 204c 6973 745b 7374 725d 5d5d 203d  r, List[str]]] =
-00018e50: 204e 6f6e 652c 0a29 202d 3e20 4c69 7374   None,.) -> List
-00018e60: 5b44 6963 745b 7374 722c 2041 6e79 5d5d  [Dict[str, Any]]
-00018e70: 3a0a 2020 2020 2222 2252 6574 7572 6e73  :.    """Returns
-00018e80: 2061 206c 6973 7420 6f66 2063 6163 6865   a list of cache
-00018e90: 6420 6f72 206f 7074 696f 6e61 6c6c 7920  d or optionally 
-00018ea0: 7265 6672 6573 6865 6420 636c 7573 7465  refreshed cluste
-00018eb0: 7220 7265 636f 7264 732e 0a0a 2020 2020  r records...    
-00018ec0: 436f 6d62 7320 7468 726f 7567 6820 7468  Combs through th
-00018ed0: 6520 6461 7461 6261 7365 2028 696e 207e  e database (in ~
-00018ee0: 2f2e 736b 792f 7374 6174 652e 6462 2920  /.sky/state.db) 
-00018ef0: 746f 2067 6574 2061 206c 6973 7420 6f66  to get a list of
-00018f00: 2072 6563 6f72 6473 0a20 2020 2063 6f72   records.    cor
-00018f10: 7265 7370 6f6e 6469 6e67 2074 6f20 6c61  responding to la
-00018f20: 756e 6368 6564 2063 6c75 7374 6572 7320  unched clusters 
-00018f30: 2866 696c 7465 7265 6420 6279 2060 636c  (filtered by `cl
-00018f40: 7573 7465 725f 6e61 6d65 7360 2069 6620  uster_names` if 
-00018f50: 6974 2069 730a 2020 2020 7370 6563 6966  it is.    specif
-00018f60: 6965 6429 2e20 5468 6520 7265 6672 6573  ied). The refres
-00018f70: 6820 666c 6167 2063 616e 2062 6520 7573  h flag can be us
-00018f80: 6564 2074 6f20 666f 7263 6520 6120 7265  ed to force a re
-00018f90: 6672 6573 6820 6f66 2074 6865 2073 7461  fresh of the sta
-00018fa0: 7475 730a 2020 2020 6f66 2074 6865 2063  tus.    of the c
-00018fb0: 6c75 7374 6572 732e 0a0a 2020 2020 4172  lusters...    Ar
-00018fc0: 6773 3a0a 2020 2020 2020 2020 696e 636c  gs:.        incl
-00018fd0: 7564 655f 636f 6e74 726f 6c6c 6572 3a20  ude_controller: 
-00018fe0: 5768 6574 6865 7220 746f 2069 6e63 6c75  Whether to inclu
-00018ff0: 6465 2063 6f6e 7472 6f6c 6c65 7273 2c20  de controllers, 
-00019000: 652e 672e 2073 706f 7420 636f 6e74 726f  e.g. spot contro
-00019010: 6c6c 6572 0a20 2020 2020 2020 2020 2020  ller.           
-00019020: 206f 7220 736b 7920 7365 7276 6520 636f   or sky serve co
-00019030: 6e74 726f 6c6c 6572 2e0a 2020 2020 2020  ntroller..      
-00019040: 2020 7265 6672 6573 683a 2057 6865 7468    refresh: Wheth
-00019050: 6572 2074 6f20 7265 6672 6573 6820 7468  er to refresh th
-00019060: 6520 7374 6174 7573 206f 6620 7468 6520  e status of the 
-00019070: 636c 7573 7465 7273 2e20 2852 6566 7265  clusters. (Refre
-00019080: 7368 696e 6720 7769 6c6c 0a20 2020 2020  shing will.     
-00019090: 2020 2020 2020 2073 6574 2074 6865 2073         set the s
-000190a0: 7461 7475 7320 746f 2053 544f 5050 4544  tatus to STOPPED
-000190b0: 2069 6620 7468 6520 636c 7573 7465 7220   if the cluster 
-000190c0: 6361 6e6e 6f74 2062 6520 7069 6e67 6564  cannot be pinged
-000190d0: 2e29 0a20 2020 2020 2020 2063 6c6f 7564  .).        cloud
-000190e0: 5f66 696c 7465 723a 2053 6574 7320 7768  _filter: Sets wh
-000190f0: 6963 6820 636c 6f75 6473 2074 6f20 6669  ich clouds to fi
-00019100: 6c65 7220 7468 726f 7567 6820 6672 6f6d  ler through from
-00019110: 2074 6865 2067 6c6f 6261 6c20 7573 6572   the global user
-00019120: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
-00019130: 7465 2e20 5375 7070 6f72 7473 2074 6872  te. Supports thr
-00019140: 6565 2076 616c 7565 732c 2027 616c 6c27  ee values, 'all'
-00019150: 2066 6f72 2061 6c6c 2063 6c6f 7564 732c   for all clouds,
-00019160: 2027 7075 626c 6963 2720 666f 720a 2020   'public' for.  
-00019170: 2020 2020 2020 2020 2020 7075 626c 6963            public
-00019180: 2063 6c6f 7564 7320 6f6e 6c79 2c20 616e   clouds only, an
-00019190: 6420 276c 6f63 616c 2720 666f 7220 6f6e  d 'local' for on
-000191a0: 6c79 206c 6f63 616c 2063 6c6f 7564 732e  ly local clouds.
-000191b0: 0a20 2020 2020 2020 2063 6c75 7374 6572  .        cluster
-000191c0: 5f6e 616d 6573 3a20 4966 2070 726f 7669  _names: If provi
-000191d0: 6465 642c 206f 6e6c 7920 7265 7475 726e  ded, only return
-000191e0: 2072 6563 6f72 6473 2066 6f72 2074 6865   records for the
-000191f0: 2067 6976 656e 2063 6c75 7374 6572 0a20   given cluster. 
-00019200: 2020 2020 2020 2020 2020 206e 616d 6573             names
-00019210: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
-00019220: 2020 2020 2020 2020 4120 6c69 7374 206f          A list o
-00019230: 6620 636c 7573 7465 7220 7265 636f 7264  f cluster record
-00019240: 732e 2049 6620 7468 6520 636c 7573 7465  s. If the cluste
-00019250: 7220 646f 6573 206e 6f74 2065 7869 7374  r does not exist
-00019260: 206f 7220 6861 7320 6265 656e 0a20 2020   or has been.   
-00019270: 2020 2020 2074 6572 6d69 6e61 7465 642c       terminated,
-00019280: 2074 6865 2072 6563 6f72 6420 7769 6c6c   the record will
-00019290: 2062 6520 6f6d 6974 7465 6420 6672 6f6d   be omitted from
-000192a0: 2074 6865 2072 6574 7572 6e65 6420 6c69   the returned li
-000192b0: 7374 2e0a 2020 2020 2222 220a 2020 2020  st..    """.    
-000192c0: 7265 636f 7264 7320 3d20 676c 6f62 616c  records = global
-000192d0: 5f75 7365 725f 7374 6174 652e 6765 745f  _user_state.get_
-000192e0: 636c 7573 7465 7273 2829 0a0a 2020 2020  clusters()..    
-000192f0: 6966 206e 6f74 2069 6e63 6c75 6465 5f63  if not include_c
-00019300: 6f6e 7472 6f6c 6c65 723a 0a20 2020 2020  ontroller:.     
-00019310: 2020 2072 6563 6f72 6473 203d 205b 0a20     records = [. 
-00019320: 2020 2020 2020 2020 2020 2072 6563 6f72             recor
-00019330: 6420 666f 7220 7265 636f 7264 2069 6e20  d for record in 
-00019340: 7265 636f 7264 730a 2020 2020 2020 2020  records.        
-00019350: 2020 2020 6966 2063 6f6e 7472 6f6c 6c65      if controlle
-00019360: 725f 7574 696c 732e 436f 6e74 726f 6c6c  r_utils.Controll
-00019370: 6572 732e 6672 6f6d 5f6e 616d 6528 7265  ers.from_name(re
-00019380: 636f 7264 5b27 6e61 6d65 275d 2920 6973  cord['name']) is
-00019390: 204e 6f6e 650a 2020 2020 2020 2020 5d0a   None.        ].
-000193a0: 0a20 2020 2079 656c 6c6f 7720 3d20 636f  .    yellow = co
-000193b0: 6c6f 7261 6d61 2e46 6f72 652e 5945 4c4c  lorama.Fore.YELL
-000193c0: 4f57 0a20 2020 2062 7269 6768 7420 3d20  OW.    bright = 
-000193d0: 636f 6c6f 7261 6d61 2e53 7479 6c65 2e42  colorama.Style.B
-000193e0: 5249 4748 540a 2020 2020 7265 7365 7420  RIGHT.    reset 
-000193f0: 3d20 636f 6c6f 7261 6d61 2e53 7479 6c65  = colorama.Style
-00019400: 2e52 4553 4554 5f41 4c4c 0a0a 2020 2020  .RESET_ALL..    
-00019410: 6966 2063 6c75 7374 6572 5f6e 616d 6573  if cluster_names
-00019420: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-00019430: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-00019440: 6e63 6528 636c 7573 7465 725f 6e61 6d65  nce(cluster_name
-00019450: 732c 2073 7472 293a 0a20 2020 2020 2020  s, str):.       
-00019460: 2020 2020 2063 6c75 7374 6572 5f6e 616d       cluster_nam
-00019470: 6573 203d 205b 636c 7573 7465 725f 6e61  es = [cluster_na
-00019480: 6d65 735d 0a20 2020 2020 2020 206e 6577  mes].        new
-00019490: 5f72 6563 6f72 6473 203d 205b 5d0a 2020  _records = [].  
-000194a0: 2020 2020 2020 6e6f 745f 6578 6973 745f        not_exist_
-000194b0: 636c 7573 7465 725f 6e61 6d65 7320 3d20  cluster_names = 
-000194c0: 5b5d 0a20 2020 2020 2020 2066 6f72 2063  [].        for c
-000194d0: 6c75 7374 6572 5f6e 616d 6520 696e 2063  luster_name in c
-000194e0: 6c75 7374 6572 5f6e 616d 6573 3a0a 2020  luster_names:.  
-000194f0: 2020 2020 2020 2020 2020 666f 7220 7265            for re
-00019500: 636f 7264 2069 6e20 7265 636f 7264 733a  cord in records:
-00019510: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019520: 2069 6620 7265 636f 7264 5b27 6e61 6d65   if record['name
-00019530: 275d 203d 3d20 636c 7573 7465 725f 6e61  '] == cluster_na
-00019540: 6d65 3a0a 2020 2020 2020 2020 2020 2020  me:.            
-00019550: 2020 2020 2020 2020 6e65 775f 7265 636f          new_reco
-00019560: 7264 732e 6170 7065 6e64 2872 6563 6f72  rds.append(recor
-00019570: 6429 0a20 2020 2020 2020 2020 2020 2020  d).             
-00019580: 2020 2020 2020 2062 7265 616b 0a20 2020         break.   
-00019590: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-000195a0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-000195b0: 6f74 5f65 7869 7374 5f63 6c75 7374 6572  ot_exist_cluster
-000195c0: 5f6e 616d 6573 2e61 7070 656e 6428 636c  _names.append(cl
-000195d0: 7573 7465 725f 6e61 6d65 290a 2020 2020  uster_name).    
-000195e0: 2020 2020 6966 206e 6f74 5f65 7869 7374      if not_exist
-000195f0: 5f63 6c75 7374 6572 5f6e 616d 6573 3a0a  _cluster_names:.
-00019600: 2020 2020 2020 2020 2020 2020 636c 7573              clus
-00019610: 7465 7273 5f73 7472 203d 2027 2c20 272e  ters_str = ', '.
-00019620: 6a6f 696e 286e 6f74 5f65 7869 7374 5f63  join(not_exist_c
-00019630: 6c75 7374 6572 5f6e 616d 6573 290a 2020  luster_names).  
-00019640: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-00019650: 2e69 6e66 6f28 6627 436c 7573 7465 7228  .info(f'Cluster(
-00019660: 7329 206e 6f74 2066 6f75 6e64 3a20 7b62  s) not found: {b
-00019670: 7269 6768 747d 7b63 6c75 7374 6572 735f  right}{clusters_
-00019680: 7374 727d 7b72 6573 6574 7d2e 2729 0a20  str}{reset}.'). 
-00019690: 2020 2020 2020 2072 6563 6f72 6473 203d         records =
-000196a0: 206e 6577 5f72 6563 6f72 6473 0a0a 2020   new_records..  
-000196b0: 2020 6966 206e 6f74 2072 6566 7265 7368    if not refresh
-000196c0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-000196d0: 2072 6563 6f72 6473 0a0a 2020 2020 706c   records..    pl
-000196e0: 7572 616c 203d 2027 7327 2069 6620 6c65  ural = 's' if le
-000196f0: 6e28 7265 636f 7264 7329 203e 2031 2065  n(records) > 1 e
-00019700: 6c73 6520 2727 0a20 2020 2070 726f 6772  lse ''.    progr
-00019710: 6573 7320 3d20 7269 6368 5f70 726f 6772  ess = rich_progr
-00019720: 6573 732e 5072 6f67 7265 7373 2874 7261  ess.Progress(tra
-00019730: 6e73 6965 6e74 3d54 7275 652c 0a20 2020  nsient=True,.   
-00019740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019760: 2020 2072 6564 6972 6563 745f 7374 646f     redirect_stdo
-00019770: 7574 3d46 616c 7365 2c0a 2020 2020 2020  ut=False,.      
-00019780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000197a0: 7265 6469 7265 6374 5f73 7464 6572 723d  redirect_stderr=
-000197b0: 4661 6c73 6529 0a20 2020 2074 6173 6b20  False).    task 
-000197c0: 3d20 7072 6f67 7265 7373 2e61 6464 5f74  = progress.add_t
-000197d0: 6173 6b28 0a20 2020 2020 2020 2066 275b  ask(.        f'[
-000197e0: 626f 6c64 2063 7961 6e5d 5265 6672 6573  bold cyan]Refres
-000197f0: 6869 6e67 2073 7461 7475 7320 666f 7220  hing status for 
-00019800: 7b6c 656e 2872 6563 6f72 6473 297d 2063  {len(records)} c
-00019810: 6c75 7374 6572 7b70 6c75 7261 6c7d 5b2f  luster{plural}[/
-00019820: 5d27 2c0a 2020 2020 2020 2020 746f 7461  ]',.        tota
-00019830: 6c3d 6c65 6e28 7265 636f 7264 7329 290a  l=len(records)).
-00019840: 0a20 2020 2064 6566 205f 7265 6672 6573  .    def _refres
-00019850: 685f 636c 7573 7465 7228 636c 7573 7465  h_cluster(cluste
-00019860: 725f 6e61 6d65 293a 0a20 2020 2020 2020  r_name):.       
-00019870: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-00019880: 2020 7265 636f 7264 203d 2072 6566 7265    record = refre
-00019890: 7368 5f63 6c75 7374 6572 5f72 6563 6f72  sh_cluster_recor
-000198a0: 6428 0a20 2020 2020 2020 2020 2020 2020  d(.             
-000198b0: 2020 2063 6c75 7374 6572 5f6e 616d 652c     cluster_name,
-000198c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000198d0: 2066 6f72 6365 5f72 6566 7265 7368 5f73   force_refresh_s
-000198e0: 7461 7475 7365 733d 7365 7428 7374 6174  tatuses=set(stat
-000198f0: 7573 5f6c 6962 2e43 6c75 7374 6572 5374  us_lib.ClusterSt
-00019900: 6174 7573 292c 0a20 2020 2020 2020 2020  atus),.         
-00019910: 2020 2020 2020 2061 6371 7569 7265 5f70         acquire_p
-00019920: 6572 5f63 6c75 7374 6572 5f73 7461 7475  er_cluster_statu
-00019930: 735f 6c6f 636b 3d54 7275 6529 0a20 2020  s_lock=True).   
-00019940: 2020 2020 2065 7863 6570 7420 2865 7863       except (exc
-00019950: 6570 7469 6f6e 732e 436c 7573 7465 7253  eptions.ClusterS
-00019960: 7461 7475 7346 6574 6368 696e 6745 7272  tatusFetchingErr
-00019970: 6f72 2c0a 2020 2020 2020 2020 2020 2020  or,.            
-00019980: 2020 2020 6578 6365 7074 696f 6e73 2e43      exceptions.C
-00019990: 6c6f 7564 5573 6572 4964 656e 7469 7479  loudUserIdentity
-000199a0: 4572 726f 722c 0a20 2020 2020 2020 2020  Error,.         
-000199b0: 2020 2020 2020 2065 7863 6570 7469 6f6e         exception
-000199c0: 732e 436c 7573 7465 724f 776e 6572 4964  s.ClusterOwnerId
-000199d0: 656e 7469 7479 4d69 736d 6174 6368 4572  entityMismatchEr
-000199e0: 726f 7229 2061 7320 653a 0a20 2020 2020  ror) as e:.     
-000199f0: 2020 2020 2020 2023 2044 6f20 6e6f 7420         # Do not 
-00019a00: 6661 696c 2074 6865 2065 6e74 6972 6520  fail the entire 
-00019a10: 7265 6672 6573 6820 7072 6f63 6573 732e  refresh process.
-00019a20: 2054 6865 2063 616c 6c65 7220 7769 6c6c   The caller will
-00019a30: 0a20 2020 2020 2020 2020 2020 2023 2068  .            # h
-00019a40: 616e 646c 6520 7468 6520 2755 4e4b 4e4f  andle the 'UNKNO
-00019a50: 574e 2720 7374 6174 7573 2c20 616e 6420  WN' status, and 
-00019a60: 636f 6c6c 6563 7420 7468 6520 6572 726f  collect the erro
-00019a70: 7273 2069 6e74 6f0a 2020 2020 2020 2020  rs into.        
-00019a80: 2020 2020 2320 6120 7461 626c 652e 0a20      # a table.. 
-00019a90: 2020 2020 2020 2020 2020 2072 6563 6f72             recor
-00019aa0: 6420 3d20 7b27 7374 6174 7573 273a 2027  d = {'status': '
-00019ab0: 554e 4b4e 4f57 4e27 2c20 2765 7272 6f72  UNKNOWN', 'error
-00019ac0: 273a 2065 7d0a 2020 2020 2020 2020 7072  ': e}.        pr
-00019ad0: 6f67 7265 7373 2e75 7064 6174 6528 7461  ogress.update(ta
-00019ae0: 736b 2c20 6164 7661 6e63 653d 3129 0a20  sk, advance=1). 
-00019af0: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
-00019b00: 636f 7264 0a0a 2020 2020 636c 7573 7465  cord..    cluste
-00019b10: 725f 6e61 6d65 7320 3d20 5b72 6563 6f72  r_names = [recor
-00019b20: 645b 276e 616d 6527 5d20 666f 7220 7265  d['name'] for re
-00019b30: 636f 7264 2069 6e20 7265 636f 7264 735d  cord in records]
-00019b40: 0a20 2020 2077 6974 6820 7072 6f67 7265  .    with progre
-00019b50: 7373 3a0a 2020 2020 2020 2020 7570 6461  ss:.        upda
-00019b60: 7465 645f 7265 636f 7264 7320 3d20 7375  ted_records = su
-00019b70: 6270 726f 6365 7373 5f75 7469 6c73 2e72  bprocess_utils.r
-00019b80: 756e 5f69 6e5f 7061 7261 6c6c 656c 280a  un_in_parallel(.
-00019b90: 2020 2020 2020 2020 2020 2020 5f72 6566              _ref
-00019ba0: 7265 7368 5f63 6c75 7374 6572 2c20 636c  resh_cluster, cl
-00019bb0: 7573 7465 725f 6e61 6d65 7329 0a0a 2020  uster_names)..  
-00019bc0: 2020 2320 5368 6f77 2069 6e66 6f72 6d61    # Show informa
-00019bd0: 7469 6f6e 2066 6f72 2072 656d 6f76 6564  tion for removed
-00019be0: 2063 6c75 7374 6572 732e 0a20 2020 206b   clusters..    k
-00019bf0: 6570 745f 7265 636f 7264 7320 3d20 5b5d  ept_records = []
-00019c00: 0a20 2020 2061 7574 6f64 6f77 6e5f 636c  .    autodown_cl
-00019c10: 7573 7465 7273 2c20 7265 6d61 696e 696e  usters, remainin
-00019c20: 675f 636c 7573 7465 7273 2c20 6661 696c  g_clusters, fail
-00019c30: 6564 5f63 6c75 7374 6572 7320 3d20 5b5d  ed_clusters = []
-00019c40: 2c20 5b5d 2c20 5b5d 0a20 2020 2066 6f72  , [], [].    for
-00019c50: 2069 2c20 7265 636f 7264 2069 6e20 656e   i, record in en
-00019c60: 756d 6572 6174 6528 7265 636f 7264 7329  umerate(records)
-00019c70: 3a0a 2020 2020 2020 2020 6966 2075 7064  :.        if upd
-00019c80: 6174 6564 5f72 6563 6f72 6473 5b69 5d20  ated_records[i] 
-00019c90: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-00019ca0: 2020 2020 2069 6620 7265 636f 7264 5b27       if record['
-00019cb0: 746f 5f64 6f77 6e27 5d3a 0a20 2020 2020  to_down']:.     
-00019cc0: 2020 2020 2020 2020 2020 2061 7574 6f64             autod
-00019cd0: 6f77 6e5f 636c 7573 7465 7273 2e61 7070  own_clusters.app
-00019ce0: 656e 6428 636c 7573 7465 725f 6e61 6d65  end(cluster_name
-00019cf0: 735b 695d 290a 2020 2020 2020 2020 2020  s[i]).          
-00019d00: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00019d10: 2020 2020 2020 2020 7265 6d61 696e 696e          remainin
-00019d20: 675f 636c 7573 7465 7273 2e61 7070 656e  g_clusters.appen
-00019d30: 6428 636c 7573 7465 725f 6e61 6d65 735b  d(cluster_names[
-00019d40: 695d 290a 2020 2020 2020 2020 656c 6966  i]).        elif
-00019d50: 2075 7064 6174 6564 5f72 6563 6f72 6473   updated_records
-00019d60: 5b69 5d5b 2773 7461 7475 7327 5d20 3d3d  [i]['status'] ==
-00019d70: 2027 554e 4b4e 4f57 4e27 3a0a 2020 2020   'UNKNOWN':.    
-00019d80: 2020 2020 2020 2020 6661 696c 6564 5f63          failed_c
-00019d90: 6c75 7374 6572 732e 6170 7065 6e64 280a  lusters.append(.
+00015280: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00015290: 277b 636c 7573 7465 725f 6e61 6d65 2172  '{cluster_name!r
+000152a0: 7d27 290a 2020 2020 2020 2020 2020 2020  }').            
+000152b0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000152c0: 2020 2020 2020 2020 2020 2020 2020 6f70                op
+000152d0: 6572 6174 696f 6e5f 7374 7220 3d20 280a  eration_str = (.
+000152e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000152f0: 2020 2020 2020 2020 6627 4174 7465 6d70          f'Attemp
+00015300: 7465 6420 746f 2063 616e 6365 6c20 7b6e  ted to cancel {n
+00015310: 6f75 6e7d 206f 6e20 7468 6520 270a 2020  oun} on the '.  
+00015320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015330: 2020 2020 2020 6627 636c 7573 7465 7220        f'cluster 
+00015340: 7b63 6c75 7374 6572 5f6e 616d 6521 727d  {cluster_name!r}
+00015350: 2077 6974 6820 6265 7374 2065 6666 6f72   with best effor
+00015360: 7427 290a 2020 2020 2020 2020 2020 2020  t').            
+00015370: 2020 2020 7965 6c6c 6f77 203d 2063 6f6c      yellow = col
+00015380: 6f72 616d 612e 466f 7265 2e59 454c 4c4f  orama.Fore.YELLO
+00015390: 570a 2020 2020 2020 2020 2020 2020 2020  W.              
+000153a0: 2020 6272 6967 6874 203d 2063 6f6c 6f72    bright = color
+000153b0: 616d 612e 5374 796c 652e 4252 4947 4854  ama.Style.BRIGHT
+000153c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000153d0: 2072 6573 6574 203d 2063 6f6c 6f72 616d   reset = coloram
+000153e0: 612e 5374 796c 652e 5245 5345 545f 414c  a.Style.RESET_AL
+000153f0: 4c0a 2020 2020 2020 2020 2020 2020 2020  L.              
+00015400: 2020 7578 5f75 7469 6c73 2e63 6f6e 736f    ux_utils.conso
+00015410: 6c65 5f6e 6577 6c69 6e65 2829 0a20 2020  le_newline().   
+00015420: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+00015430: 6765 722e 7761 726e 696e 6728 0a20 2020  ger.warning(.   
+00015440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015450: 2066 277b 7965 6c6c 6f77 7d7b 6f70 6572   f'{yellow}{oper
+00015460: 6174 696f 6e5f 7374 727d 2c20 7369 6e63  ation_str}, sinc
+00015470: 6520 6974 2069 7320 666f 756e 6420 746f  e it is found to
+00015480: 2062 6520 696e 2061 6e20 270a 2020 2020   be in an '.    
+00015490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000154a0: 6627 6162 6e6f 726d 616c 2073 7461 7465  f'abnormal state
+000154b0: 2e20 546f 2066 6978 2c20 7472 7920 7275  . To fix, try ru
+000154c0: 6e6e 696e 673a 207b 7265 7365 747d 7b62  nning: {reset}{b
+000154d0: 7269 6768 747d 736b 7920 270a 2020 2020  right}sky '.    
+000154e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000154f0: 6627 7374 6172 7420 2d66 202d 6920 7b61  f'start -f -i {a
+00015500: 7574 6f73 746f 707d 7b6d 6179 6265 5f64  utostop}{maybe_d
+00015510: 6f77 6e5f 7374 727d 207b 636c 7573 7465  own_str} {cluste
+00015520: 725f 6e61 6d65 7d27 0a20 2020 2020 2020  r_name}'.       
+00015530: 2020 2020 2020 2020 2020 2020 2066 277b               f'{
+00015540: 7265 7365 747d 2729 0a20 2020 2020 2020  reset}').       
+00015550: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00015560: 2020 2020 2020 2020 2020 2075 785f 7574             ux_ut
+00015570: 696c 732e 636f 6e73 6f6c 655f 6e65 776c  ils.console_newl
+00015580: 696e 6528 290a 2020 2020 2020 2020 2020  ine().          
+00015590: 2020 2020 2020 6f70 6572 6174 696f 6e5f        operation_
+000155a0: 7374 7220 3d20 2761 7574 6f64 6f77 6e69  str = 'autodowni
+000155b0: 6e67 2720 6966 2072 6563 6f72 645b 0a20  ng' if record[. 
+000155c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000155d0: 2020 2027 746f 5f64 6f77 6e27 5d20 656c     'to_down'] el
+000155e0: 7365 2027 6175 746f 7374 6f70 7069 6e67  se 'autostopping
+000155f0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00015600: 2020 6c6f 6767 6572 2e69 6e66 6f28 0a20    logger.info(. 
+00015610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015620: 2020 2066 2743 6c75 7374 6572 207b 636c     f'Cluster {cl
+00015630: 7573 7465 725f 6e61 6d65 2172 7d20 6973  uster_name!r} is
+00015640: 207b 6f70 6572 6174 696f 6e5f 7374 727d   {operation_str}
+00015650: 2e20 5365 7474 696e 6720 746f 2027 0a20  . Setting to '. 
+00015660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015670: 2020 2027 494e 4954 2073 7461 7475 733b     'INIT status;
+00015680: 2074 7279 2072 6566 7265 7368 2061 6761   try refresh aga
+00015690: 696e 2069 6e20 6120 7768 696c 652e 2729  in in a while.')
+000156a0: 0a0a 2020 2020 2020 2020 2320 4966 2074  ..        # If t
+000156b0: 6865 2075 7365 7220 7374 6172 7473 2070  he user starts p
+000156c0: 6172 7420 6f66 2061 2053 544f 5050 4544  art of a STOPPED
+000156d0: 2063 6c75 7374 6572 2c20 7765 2073 7469   cluster, we sti
+000156e0: 6c6c 206e 6565 6420 6120 7374 6174 7573  ll need a status
+000156f0: 0a20 2020 2020 2020 2023 2074 6f20 7265  .        # to re
+00015700: 7072 6573 656e 7420 7468 6520 6162 6e6f  present the abno
+00015710: 726d 616c 2073 7461 7475 732e 2046 6f72  rmal status. For
+00015720: 2073 706f 7420 636c 7573 7465 722c 2069   spot cluster, i
+00015730: 7420 6361 6e20 616c 736f 0a20 2020 2020  t can also.     
+00015740: 2020 2023 2072 6570 7265 7365 6e74 2074     # represent t
+00015750: 6861 7420 7468 6520 636c 7573 7465 7220  hat the cluster 
+00015760: 6973 2070 6172 7469 616c 6c79 2070 7265  is partially pre
+00015770: 656d 7074 6564 2e0a 2020 2020 2020 2020  empted..        
+00015780: 2320 544f 444f 287a 6877 7529 3a20 7468  # TODO(zhwu): th
+00015790: 6520 6465 6669 6e69 7469 6f6e 206f 6620  e definition of 
+000157a0: 494e 4954 2073 686f 756c 6420 6265 2061  INIT should be a
+000157b0: 7564 6974 6564 2f63 6861 6e67 6564 2e0a  udited/changed..
+000157c0: 2020 2020 2020 2020 2320 4164 6469 6e67          # Adding
+000157d0: 2061 206e 6577 2073 7461 7475 7320 554e   a new status UN
+000157e0: 4845 414c 5448 5920 666f 7220 6162 6e6f  HEALTHY for abno
+000157f0: 726d 616c 2073 7461 7475 7320 6361 6e20  rmal status can 
+00015800: 6265 2061 2063 686f 6963 652e 0a20 2020  be a choice..   
+00015810: 2020 2020 2067 6c6f 6261 6c5f 7573 6572       global_user
+00015820: 5f73 7461 7465 2e61 6464 5f6f 725f 7570  _state.add_or_up
+00015830: 6461 7465 5f63 6c75 7374 6572 2863 6c75  date_cluster(clu
+00015840: 7374 6572 5f6e 616d 652c 0a20 2020 2020  ster_name,.     
+00015850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015870: 2020 2020 2020 2020 2020 2068 616e 646c             handl
+00015880: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00015890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000158a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000158b0: 2020 2072 6571 7565 7374 6564 5f72 6573     requested_res
+000158c0: 6f75 7263 6573 3d4e 6f6e 652c 0a20 2020  ources=None,.   
+000158d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000158e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000158f0: 2020 2020 2020 2020 2020 2020 2072 6561               rea
+00015900: 6479 3d46 616c 7365 2c0a 2020 2020 2020  dy=False,.      
+00015910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015930: 2020 2020 2020 2020 2020 6973 5f6c 6175            is_lau
+00015940: 6e63 683d 4661 6c73 6529 0a20 2020 2020  nch=False).     
+00015950: 2020 2072 6574 7572 6e20 676c 6f62 616c     return global
+00015960: 5f75 7365 725f 7374 6174 652e 6765 745f  _user_state.get_
+00015970: 636c 7573 7465 725f 6672 6f6d 5f6e 616d  cluster_from_nam
+00015980: 6528 636c 7573 7465 725f 6e61 6d65 290a  e(cluster_name).
+00015990: 2020 2020 2320 4e6f 7720 6973 5f61 626e      # Now is_abn
+000159a0: 6f72 6d61 6c20 6973 2046 616c 7365 3a20  ormal is False: 
+000159b0: 6569 7468 6572 206e 6f64 655f 7374 6174  either node_stat
+000159c0: 7573 6573 2069 7320 656d 7074 7920 6f72  uses is empty or
+000159d0: 2061 6c6c 206e 6f64 6573 2061 7265 0a20   all nodes are. 
+000159e0: 2020 2023 2053 544f 5050 4544 2e0a 2020     # STOPPED..  
+000159f0: 2020 6261 636b 656e 6420 3d20 6261 636b    backend = back
+00015a00: 656e 6473 2e43 6c6f 7564 566d 5261 7942  ends.CloudVmRayB
+00015a10: 6163 6b65 6e64 2829 0a20 2020 2062 6163  ackend().    bac
+00015a20: 6b65 6e64 2e70 6f73 745f 7465 6172 646f  kend.post_teardo
+00015a30: 776e 5f63 6c65 616e 7570 2868 616e 646c  wn_cleanup(handl
+00015a40: 652c 2074 6572 6d69 6e61 7465 3d74 6f5f  e, terminate=to_
+00015a50: 7465 726d 696e 6174 652c 2070 7572 6765  terminate, purge
+00015a60: 3d46 616c 7365 290a 2020 2020 7265 7475  =False).    retu
+00015a70: 726e 2067 6c6f 6261 6c5f 7573 6572 5f73  rn global_user_s
+00015a80: 7461 7465 2e67 6574 5f63 6c75 7374 6572  tate.get_cluster
+00015a90: 5f66 726f 6d5f 6e61 6d65 2863 6c75 7374  _from_name(clust
+00015aa0: 6572 5f6e 616d 6529 0a0a 0a64 6566 205f  er_name)...def _
+00015ab0: 7570 6461 7465 5f63 6c75 7374 6572 5f73  update_cluster_s
+00015ac0: 7461 7475 7328 0a20 2020 2063 6c75 7374  tatus(.    clust
+00015ad0: 6572 5f6e 616d 653a 2073 7472 2c0a 2020  er_name: str,.  
+00015ae0: 2020 6163 7175 6972 655f 7065 725f 636c    acquire_per_cl
+00015af0: 7573 7465 725f 7374 6174 7573 5f6c 6f63  uster_status_loc
+00015b00: 6b3a 2062 6f6f 6c2c 0a20 2020 2063 6c75  k: bool,.    clu
+00015b10: 7374 6572 5f73 7461 7475 735f 6c6f 636b  ster_status_lock
+00015b20: 5f74 696d 656f 7574 3a20 696e 7420 3d20  _timeout: int = 
+00015b30: 434c 5553 5445 525f 5354 4154 5553 5f4c  CLUSTER_STATUS_L
+00015b40: 4f43 4b5f 5449 4d45 4f55 545f 5345 434f  OCK_TIMEOUT_SECO
+00015b50: 4e44 530a 2920 2d3e 204f 7074 696f 6e61  NDS.) -> Optiona
+00015b60: 6c5b 4469 6374 5b73 7472 2c20 416e 795d  l[Dict[str, Any]
+00015b70: 5d3a 0a20 2020 2022 2222 5570 6461 7465  ]:.    """Update
+00015b80: 2074 6865 2063 6c75 7374 6572 2073 7461   the cluster sta
+00015b90: 7475 732e 0a0a 2020 2020 5468 6520 636c  tus...    The cl
+00015ba0: 7573 7465 7220 7374 6174 7573 2069 7320  uster status is 
+00015bb0: 7570 6461 7465 6420 6279 2063 6865 636b  updated by check
+00015bc0: 696e 6720 7261 7920 636c 7573 7465 7220  ing ray cluster 
+00015bd0: 616e 6420 7265 616c 2073 7461 7475 7320  and real status 
+00015be0: 6672 6f6d 0a20 2020 2063 6c6f 7564 2e0a  from.    cloud..
+00015bf0: 0a20 2020 2054 6865 2066 756e 6374 696f  .    The functio
+00015c00: 6e20 7769 6c6c 2075 7064 6174 6520 7468  n will update th
+00015c10: 6520 6361 6368 6564 2063 6c75 7374 6572  e cached cluster
+00015c20: 2073 7461 7475 7320 696e 2074 6865 2067   status in the g
+00015c30: 6c6f 6261 6c20 7374 6174 652e 2046 6f72  lobal state. For
+00015c40: 0a20 2020 2074 6865 2064 6573 6967 6e20  .    the design 
+00015c50: 6f66 2074 6865 2063 6c75 7374 6572 2073  of the cluster s
+00015c60: 7461 7475 7320 616e 6420 7472 616e 7369  tatus and transi
+00015c70: 7469 6f6e 2c20 706c 6561 7365 2072 6566  tion, please ref
+00015c80: 6572 2074 6f20 7468 650a 2020 2020 736b  er to the.    sk
+00015c90: 792f 6465 7369 676e 5f64 6f63 732f 636c  y/design_docs/cl
+00015ca0: 7573 7465 725f 7374 6174 7573 2e6d 640a  uster_status.md.
+00015cb0: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
+00015cc0: 2020 2063 6c75 7374 6572 5f6e 616d 653a     cluster_name:
+00015cd0: 2054 6865 206e 616d 6520 6f66 2074 6865   The name of the
+00015ce0: 2063 6c75 7374 6572 2e0a 2020 2020 2020   cluster..      
+00015cf0: 2020 6163 7175 6972 655f 7065 725f 636c    acquire_per_cl
+00015d00: 7573 7465 725f 7374 6174 7573 5f6c 6f63  uster_status_loc
+00015d10: 6b3a 2057 6865 7468 6572 2074 6f20 6163  k: Whether to ac
+00015d20: 7175 6972 6520 7468 6520 7065 722d 636c  quire the per-cl
+00015d30: 7573 7465 7220 6c6f 636b 0a20 2020 2020  uster lock.     
+00015d40: 2020 2020 2062 6566 6f72 6520 7570 6461       before upda
+00015d50: 7469 6e67 2074 6865 2073 7461 7475 732e  ting the status.
+00015d60: 0a20 2020 2020 2020 2063 6c75 7374 6572  .        cluster
+00015d70: 5f73 7461 7475 735f 6c6f 636b 5f74 696d  _status_lock_tim
+00015d80: 656f 7574 3a20 5468 6520 7469 6d65 6f75  eout: The timeou
+00015d90: 7420 746f 2061 6371 7569 7265 2074 6865  t to acquire the
+00015da0: 2070 6572 2d63 6c75 7374 6572 0a20 2020   per-cluster.   
+00015db0: 2020 2020 2020 206c 6f63 6b2e 0a0a 2020         lock...  
+00015dc0: 2020 5265 7475 726e 733a 0a20 2020 2020    Returns:.     
+00015dd0: 2020 2049 6620 7468 6520 636c 7573 7465     If the cluste
+00015de0: 7220 6973 2074 6572 6d69 6e61 7465 6420  r is terminated 
+00015df0: 6f72 2064 6f65 7320 6e6f 7420 6578 6973  or does not exis
+00015e00: 742c 2072 6574 7572 6e20 4e6f 6e65 2e20  t, return None. 
+00015e10: 4f74 6865 7277 6973 650a 2020 2020 2020  Otherwise.      
+00015e20: 2020 7265 7475 726e 7320 7468 6520 696e    returns the in
+00015e30: 7075 7420 7265 636f 7264 2077 6974 6820  put record with 
+00015e40: 7374 6174 7573 2061 6e64 2068 616e 646c  status and handl
+00015e50: 6520 706f 7465 6e74 6961 6c6c 7920 7570  e potentially up
+00015e60: 6461 7465 642e 0a0a 2020 2020 5261 6973  dated...    Rais
+00015e70: 6573 3a0a 2020 2020 2020 2020 6578 6365  es:.        exce
+00015e80: 7074 696f 6e73 2e43 6c75 7374 6572 4f77  ptions.ClusterOw
+00015e90: 6e65 7249 6465 6e74 6974 794d 6973 6d61  nerIdentityMisma
+00015ea0: 7463 6845 7272 6f72 3a20 6966 2074 6865  tchError: if the
+00015eb0: 2063 7572 7265 6e74 2075 7365 7220 6973   current user is
+00015ec0: 0a20 2020 2020 2020 2020 206e 6f74 2074  .          not t
+00015ed0: 6865 2073 616d 6520 6173 2074 6865 2075  he same as the u
+00015ee0: 7365 7220 7768 6f20 6372 6561 7465 6420  ser who created 
+00015ef0: 7468 6520 636c 7573 7465 722e 0a20 2020  the cluster..   
+00015f00: 2020 2020 2065 7863 6570 7469 6f6e 732e       exceptions.
+00015f10: 436c 6f75 6455 7365 7249 6465 6e74 6974  CloudUserIdentit
+00015f20: 7945 7272 6f72 3a20 6966 2077 6520 6661  yError: if we fa
+00015f30: 696c 2074 6f20 6765 7420 7468 6520 6375  il to get the cu
+00015f40: 7272 656e 7420 7573 6572 0a20 2020 2020  rrent user.     
+00015f50: 2020 2020 2069 6465 6e74 6974 792e 0a20       identity.. 
+00015f60: 2020 2020 2020 2065 7863 6570 7469 6f6e         exception
+00015f70: 732e 436c 7573 7465 7253 7461 7475 7346  s.ClusterStatusF
+00015f80: 6574 6368 696e 6745 7272 6f72 3a20 7468  etchingError: th
+00015f90: 6520 636c 7573 7465 7220 7374 6174 7573  e cluster status
+00015fa0: 2063 616e 6e6f 7420 6265 0a20 2020 2020   cannot be.     
+00015fb0: 2020 2020 2066 6574 6368 6564 2066 726f       fetched fro
+00015fc0: 6d20 7468 6520 636c 6f75 6420 7072 6f76  m the cloud prov
+00015fd0: 6964 6572 206f 7220 7468 6572 6520 6172  ider or there ar
+00015fe0: 6520 6c65 616b 6564 206e 6f64 6573 2063  e leaked nodes c
+00015ff0: 6175 7369 6e67 0a20 2020 2020 2020 2020  ausing.         
+00016000: 2074 6865 206e 6f64 6520 6e75 6d62 6572   the node number
+00016010: 206c 6172 6765 7220 7468 616e 2065 7870   larger than exp
+00016020: 6563 7465 642e 0a20 2020 2022 2222 0a20  ected..    """. 
+00016030: 2020 2069 6620 6e6f 7420 6163 7175 6972     if not acquir
+00016040: 655f 7065 725f 636c 7573 7465 725f 7374  e_per_cluster_st
+00016050: 6174 7573 5f6c 6f63 6b3a 0a20 2020 2020  atus_lock:.     
+00016060: 2020 2072 6574 7572 6e20 5f75 7064 6174     return _updat
+00016070: 655f 636c 7573 7465 725f 7374 6174 7573  e_cluster_status
+00016080: 5f6e 6f5f 6c6f 636b 2863 6c75 7374 6572  _no_lock(cluster
+00016090: 5f6e 616d 6529 0a0a 2020 2020 7472 793a  _name)..    try:
+000160a0: 0a20 2020 2020 2020 2077 6974 6820 6669  .        with fi
+000160b0: 6c65 6c6f 636b 2e46 696c 654c 6f63 6b28  lelock.FileLock(
+000160c0: 434c 5553 5445 525f 5354 4154 5553 5f4c  CLUSTER_STATUS_L
+000160d0: 4f43 4b5f 5041 5448 2e66 6f72 6d61 7428  OCK_PATH.format(
+000160e0: 636c 7573 7465 725f 6e61 6d65 292c 0a20  cluster_name),. 
+000160f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016100: 2020 2020 2020 2020 2020 2020 2020 7469                ti
+00016110: 6d65 6f75 743d 636c 7573 7465 725f 7374  meout=cluster_st
+00016120: 6174 7573 5f6c 6f63 6b5f 7469 6d65 6f75  atus_lock_timeou
+00016130: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
+00016140: 7265 7475 726e 205f 7570 6461 7465 5f63  return _update_c
+00016150: 6c75 7374 6572 5f73 7461 7475 735f 6e6f  luster_status_no
+00016160: 5f6c 6f63 6b28 636c 7573 7465 725f 6e61  _lock(cluster_na
+00016170: 6d65 290a 2020 2020 6578 6365 7074 2066  me).    except f
+00016180: 696c 656c 6f63 6b2e 5469 6d65 6f75 743a  ilelock.Timeout:
+00016190: 0a20 2020 2020 2020 206c 6f67 6765 722e  .        logger.
+000161a0: 6465 6275 6728 2752 6566 7265 7368 696e  debug('Refreshin
+000161b0: 6720 7374 6174 7573 3a20 4661 696c 6564  g status: Failed
+000161c0: 2067 6574 2074 6865 206c 6f63 6b20 666f   get the lock fo
+000161d0: 7220 636c 7573 7465 7220 270a 2020 2020  r cluster '.    
+000161e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000161f0: 2066 277b 636c 7573 7465 725f 6e61 6d65   f'{cluster_name
+00016200: 2172 7d2e 2055 7369 6e67 2074 6865 2063  !r}. Using the c
+00016210: 6163 6865 6420 7374 6174 7573 2e27 290a  ached status.').
+00016220: 2020 2020 2020 2020 7265 636f 7264 203d          record =
+00016230: 2067 6c6f 6261 6c5f 7573 6572 5f73 7461   global_user_sta
+00016240: 7465 2e67 6574 5f63 6c75 7374 6572 5f66  te.get_cluster_f
+00016250: 726f 6d5f 6e61 6d65 2863 6c75 7374 6572  rom_name(cluster
+00016260: 5f6e 616d 6529 0a20 2020 2020 2020 2072  _name).        r
+00016270: 6574 7572 6e20 7265 636f 7264 0a0a 0a64  eturn record...d
+00016280: 6566 2072 6566 7265 7368 5f63 6c75 7374  ef refresh_clust
+00016290: 6572 5f72 6563 6f72 6428 0a20 2020 2063  er_record(.    c
+000162a0: 6c75 7374 6572 5f6e 616d 653a 2073 7472  luster_name: str
+000162b0: 2c0a 2020 2020 2a2c 0a20 2020 2066 6f72  ,.    *,.    for
+000162c0: 6365 5f72 6566 7265 7368 5f73 7461 7475  ce_refresh_statu
+000162d0: 7365 733a 204f 7074 696f 6e61 6c5b 5365  ses: Optional[Se
+000162e0: 745b 7374 6174 7573 5f6c 6962 2e43 6c75  t[status_lib.Clu
+000162f0: 7374 6572 5374 6174 7573 5d5d 203d 204e  sterStatus]] = N
+00016300: 6f6e 652c 0a20 2020 2061 6371 7569 7265  one,.    acquire
+00016310: 5f70 6572 5f63 6c75 7374 6572 5f73 7461  _per_cluster_sta
+00016320: 7475 735f 6c6f 636b 3a20 626f 6f6c 203d  tus_lock: bool =
+00016330: 2054 7275 652c 0a20 2020 2063 6c75 7374   True,.    clust
+00016340: 6572 5f73 7461 7475 735f 6c6f 636b 5f74  er_status_lock_t
+00016350: 696d 656f 7574 3a20 696e 7420 3d20 434c  imeout: int = CL
+00016360: 5553 5445 525f 5354 4154 5553 5f4c 4f43  USTER_STATUS_LOC
+00016370: 4b5f 5449 4d45 4f55 545f 5345 434f 4e44  K_TIMEOUT_SECOND
+00016380: 530a 2920 2d3e 204f 7074 696f 6e61 6c5b  S.) -> Optional[
+00016390: 4469 6374 5b73 7472 2c20 416e 795d 5d3a  Dict[str, Any]]:
+000163a0: 0a20 2020 2022 2222 5265 6672 6573 6820  .    """Refresh 
+000163b0: 7468 6520 636c 7573 7465 722c 2061 6e64  the cluster, and
+000163c0: 2072 6574 7572 6e20 7468 6520 706f 7373   return the poss
+000163d0: 6962 6c79 2075 7064 6174 6564 2072 6563  ibly updated rec
+000163e0: 6f72 642e 0a0a 2020 2020 5468 6973 2066  ord...    This f
+000163f0: 756e 6374 696f 6e20 7769 6c6c 2061 6c73  unction will als
+00016400: 6f20 6368 6563 6b20 7468 6520 6f77 6e65  o check the owne
+00016410: 7220 6964 656e 7469 7479 206f 6620 7468  r identity of th
+00016420: 6520 636c 7573 7465 722c 2061 6e64 2072  e cluster, and r
+00016430: 6169 7365 0a20 2020 2065 7863 6570 7469  aise.    excepti
+00016440: 6f6e 7320 6966 2074 6865 2063 7572 7265  ons if the curre
+00016450: 6e74 2075 7365 7220 6973 206e 6f74 2074  nt user is not t
+00016460: 6865 2073 616d 6520 6173 2074 6865 2075  he same as the u
+00016470: 7365 7220 7768 6f20 6372 6561 7465 6420  ser who created 
+00016480: 7468 650a 2020 2020 636c 7573 7465 722e  the.    cluster.
+00016490: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
+000164a0: 2020 2020 636c 7573 7465 725f 6e61 6d65      cluster_name
+000164b0: 3a20 5468 6520 6e61 6d65 206f 6620 7468  : The name of th
+000164c0: 6520 636c 7573 7465 722e 0a20 2020 2020  e cluster..     
+000164d0: 2020 2066 6f72 6365 5f72 6566 7265 7368     force_refresh
+000164e0: 5f73 7461 7475 7365 733a 2069 6620 7370  _statuses: if sp
+000164f0: 6563 6966 6965 642c 2072 6566 7265 7368  ecified, refresh
+00016500: 2074 6865 2063 6c75 7374 6572 2069 6620   the cluster if 
+00016510: 6974 2068 6173 206f 6e65 206f 660a 2020  it has one of.  
+00016520: 2020 2020 2020 2020 7468 6520 7370 6563          the spec
+00016530: 6966 6965 6420 7374 6174 7573 6573 2e20  ified statuses. 
+00016540: 4164 6469 7469 6f6e 616c 6c79 2c20 636c  Additionally, cl
+00016550: 7573 7465 7273 2073 6174 6973 6679 696e  usters satisfyin
+00016560: 6720 7468 650a 2020 2020 2020 2020 2020  g the.          
+00016570: 666f 6c6c 6f77 696e 6720 636f 6e64 6974  following condit
+00016580: 696f 6e73 2077 696c 6c20 616c 7761 7973  ions will always
+00016590: 2062 6520 7265 6672 6573 6865 6420 6e6f   be refreshed no
+000165a0: 206d 6174 7465 7220 7468 650a 2020 2020   matter the.    
+000165b0: 2020 2020 2020 6172 6775 6d65 6e74 2069        argument i
+000165c0: 7320 7370 6563 6966 6965 6420 6f72 206e  s specified or n
+000165d0: 6f74 3a0a 2020 2020 2020 2020 2020 2020  ot:.            
+000165e0: 312e 2069 7320 6120 7370 6f74 2063 6c75  1. is a spot clu
+000165f0: 7374 6572 2c20 6f72 0a20 2020 2020 2020  ster, or.       
+00016600: 2020 2020 2032 2e20 6973 2061 206e 6f6e       2. is a non
+00016610: 2d73 706f 7420 636c 7573 7465 722c 2069  -spot cluster, i
+00016620: 7320 6e6f 7420 5354 4f50 5045 442c 2061  s not STOPPED, a
+00016630: 6e64 2061 7574 6f73 746f 7020 6973 2073  nd autostop is s
+00016640: 6574 2e0a 2020 2020 2020 2020 6163 7175  et..        acqu
+00016650: 6972 655f 7065 725f 636c 7573 7465 725f  ire_per_cluster_
+00016660: 7374 6174 7573 5f6c 6f63 6b3a 2057 6865  status_lock: Whe
+00016670: 7468 6572 2074 6f20 6163 7175 6972 6520  ther to acquire 
+00016680: 7468 6520 7065 722d 636c 7573 7465 7220  the per-cluster 
+00016690: 6c6f 636b 0a20 2020 2020 2020 2020 2062  lock.          b
+000166a0: 6566 6f72 6520 7570 6461 7469 6e67 2074  efore updating t
+000166b0: 6865 2073 7461 7475 732e 0a20 2020 2020  he status..     
+000166c0: 2020 2063 6c75 7374 6572 5f73 7461 7475     cluster_statu
+000166d0: 735f 6c6f 636b 5f74 696d 656f 7574 3a20  s_lock_timeout: 
+000166e0: 5468 6520 7469 6d65 6f75 7420 746f 2061  The timeout to a
+000166f0: 6371 7569 7265 2074 6865 2070 6572 2d63  cquire the per-c
+00016700: 6c75 7374 6572 0a20 2020 2020 2020 2020  luster.         
+00016710: 206c 6f63 6b2e 2049 6620 7469 6d65 6f75   lock. If timeou
+00016720: 742c 2074 6865 2066 756e 6374 696f 6e20  t, the function 
+00016730: 7769 6c6c 2075 7365 2074 6865 2063 6163  will use the cac
+00016740: 6865 6420 7374 6174 7573 2e0a 0a20 2020  hed status...   
+00016750: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+00016760: 2020 4966 2074 6865 2063 6c75 7374 6572    If the cluster
+00016770: 2069 7320 7465 726d 696e 6174 6564 206f   is terminated o
+00016780: 7220 646f 6573 206e 6f74 2065 7869 7374  r does not exist
+00016790: 2c20 7265 7475 726e 204e 6f6e 652e 0a20  , return None.. 
+000167a0: 2020 2020 2020 204f 7468 6572 7769 7365         Otherwise
+000167b0: 2072 6574 7572 6e73 2074 6865 2063 6c75   returns the clu
+000167c0: 7374 6572 2072 6563 6f72 642e 0a0a 2020  ster record...  
+000167d0: 2020 5261 6973 6573 3a0a 2020 2020 2020    Raises:.      
+000167e0: 2020 6578 6365 7074 696f 6e73 2e43 6c75    exceptions.Clu
+000167f0: 7374 6572 4f77 6e65 7249 6465 6e74 6974  sterOwnerIdentit
+00016800: 794d 6973 6d61 7463 6845 7272 6f72 3a20  yMismatchError: 
+00016810: 6966 2074 6865 2063 7572 7265 6e74 2075  if the current u
+00016820: 7365 7220 6973 0a20 2020 2020 2020 2020  ser is.         
+00016830: 206e 6f74 2074 6865 2073 616d 6520 6173   not the same as
+00016840: 2074 6865 2075 7365 7220 7768 6f20 6372   the user who cr
+00016850: 6561 7465 6420 7468 6520 636c 7573 7465  eated the cluste
+00016860: 722e 0a20 2020 2020 2020 2065 7863 6570  r..        excep
+00016870: 7469 6f6e 732e 436c 6f75 6455 7365 7249  tions.CloudUserI
+00016880: 6465 6e74 6974 7945 7272 6f72 3a20 6966  dentityError: if
+00016890: 2077 6520 6661 696c 2074 6f20 6765 7420   we fail to get 
+000168a0: 7468 6520 6375 7272 656e 7420 7573 6572  the current user
+000168b0: 0a20 2020 2020 2020 2020 2069 6465 6e74  .          ident
+000168c0: 6974 792e 0a20 2020 2020 2020 2065 7863  ity..        exc
+000168d0: 6570 7469 6f6e 732e 436c 7573 7465 7253  eptions.ClusterS
+000168e0: 7461 7475 7346 6574 6368 696e 6745 7272  tatusFetchingErr
+000168f0: 6f72 3a20 7468 6520 636c 7573 7465 7220  or: the cluster 
+00016900: 7374 6174 7573 2063 616e 6e6f 7420 6265  status cannot be
+00016910: 0a20 2020 2020 2020 2020 2066 6574 6368  .          fetch
+00016920: 6564 2066 726f 6d20 7468 6520 636c 6f75  ed from the clou
+00016930: 6420 7072 6f76 6964 6572 206f 7220 7468  d provider or th
+00016940: 6572 6520 6172 6520 6c65 616b 6564 206e  ere are leaked n
+00016950: 6f64 6573 2063 6175 7369 6e67 0a20 2020  odes causing.   
+00016960: 2020 2020 2020 2074 6865 206e 6f64 6520         the node 
+00016970: 6e75 6d62 6572 206c 6172 6765 7220 7468  number larger th
+00016980: 616e 2065 7870 6563 7465 642e 0a20 2020  an expected..   
+00016990: 2022 2222 0a0a 2020 2020 7265 636f 7264   """..    record
+000169a0: 203d 2067 6c6f 6261 6c5f 7573 6572 5f73   = global_user_s
+000169b0: 7461 7465 2e67 6574 5f63 6c75 7374 6572  tate.get_cluster
+000169c0: 5f66 726f 6d5f 6e61 6d65 2863 6c75 7374  _from_name(clust
+000169d0: 6572 5f6e 616d 6529 0a20 2020 2069 6620  er_name).    if 
+000169e0: 7265 636f 7264 2069 7320 4e6f 6e65 3a0a  record is None:.
+000169f0: 2020 2020 2020 2020 7265 7475 726e 204e          return N
+00016a00: 6f6e 650a 2020 2020 6368 6563 6b5f 6f77  one.    check_ow
+00016a10: 6e65 725f 6964 656e 7469 7479 2863 6c75  ner_identity(clu
+00016a20: 7374 6572 5f6e 616d 6529 0a0a 2020 2020  ster_name)..    
+00016a30: 6861 6e64 6c65 203d 2072 6563 6f72 645b  handle = record[
+00016a40: 2768 616e 646c 6527 5d0a 2020 2020 6966  'handle'].    if
+00016a50: 2069 7369 6e73 7461 6e63 6528 6861 6e64   isinstance(hand
+00016a60: 6c65 2c20 6261 636b 656e 6473 2e43 6c6f  le, backends.Clo
+00016a70: 7564 566d 5261 7952 6573 6f75 7263 6548  udVmRayResourceH
+00016a80: 616e 646c 6529 3a0a 2020 2020 2020 2020  andle):.        
+00016a90: 7573 655f 7370 6f74 203d 2068 616e 646c  use_spot = handl
+00016aa0: 652e 6c61 756e 6368 6564 5f72 6573 6f75  e.launched_resou
+00016ab0: 7263 6573 2e75 7365 5f73 706f 740a 2020  rces.use_spot.  
+00016ac0: 2020 2020 2020 6861 735f 6175 746f 7374        has_autost
+00016ad0: 6f70 203d 2028 7265 636f 7264 5b27 7374  op = (record['st
+00016ae0: 6174 7573 275d 2021 3d20 7374 6174 7573  atus'] != status
+00016af0: 5f6c 6962 2e43 6c75 7374 6572 5374 6174  _lib.ClusterStat
+00016b00: 7573 2e53 544f 5050 4544 2061 6e64 0a20  us.STOPPED and. 
+00016b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016b20: 2020 2020 2020 2072 6563 6f72 645b 2761         record['a
+00016b30: 7574 6f73 746f 7027 5d20 3e3d 2030 290a  utostop'] >= 0).
+00016b40: 2020 2020 2020 2020 666f 7263 655f 7265          force_re
+00016b50: 6672 6573 685f 666f 725f 636c 7573 7465  fresh_for_cluste
+00016b60: 7220 3d20 2866 6f72 6365 5f72 6566 7265  r = (force_refre
+00016b70: 7368 5f73 7461 7475 7365 7320 6973 206e  sh_statuses is n
+00016b80: 6f74 204e 6f6e 6520 616e 640a 2020 2020  ot None and.    
+00016b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016bb0: 2072 6563 6f72 645b 2773 7461 7475 7327   record['status'
+00016bc0: 5d20 696e 2066 6f72 6365 5f72 6566 7265  ] in force_refre
+00016bd0: 7368 5f73 7461 7475 7365 7329 0a20 2020  sh_statuses).   
+00016be0: 2020 2020 2069 6620 666f 7263 655f 7265       if force_re
+00016bf0: 6672 6573 685f 666f 725f 636c 7573 7465  fresh_for_cluste
+00016c00: 7220 6f72 2068 6173 5f61 7574 6f73 746f  r or has_autosto
+00016c10: 7020 6f72 2075 7365 5f73 706f 743a 0a20  p or use_spot:. 
+00016c20: 2020 2020 2020 2020 2020 2072 6563 6f72             recor
+00016c30: 6420 3d20 5f75 7064 6174 655f 636c 7573  d = _update_clus
+00016c40: 7465 725f 7374 6174 7573 280a 2020 2020  ter_status(.    
+00016c50: 2020 2020 2020 2020 2020 2020 636c 7573              clus
+00016c60: 7465 725f 6e61 6d65 2c0a 2020 2020 2020  ter_name,.      
+00016c70: 2020 2020 2020 2020 2020 6163 7175 6972            acquir
+00016c80: 655f 7065 725f 636c 7573 7465 725f 7374  e_per_cluster_st
+00016c90: 6174 7573 5f6c 6f63 6b3d 6163 7175 6972  atus_lock=acquir
+00016ca0: 655f 7065 725f 636c 7573 7465 725f 7374  e_per_cluster_st
+00016cb0: 6174 7573 5f6c 6f63 6b2c 0a20 2020 2020  atus_lock,.     
+00016cc0: 2020 2020 2020 2020 2020 2063 6c75 7374             clust
+00016cd0: 6572 5f73 7461 7475 735f 6c6f 636b 5f74  er_status_lock_t
+00016ce0: 696d 656f 7574 3d63 6c75 7374 6572 5f73  imeout=cluster_s
+00016cf0: 7461 7475 735f 6c6f 636b 5f74 696d 656f  tatus_lock_timeo
+00016d00: 7574 290a 2020 2020 7265 7475 726e 2072  ut).    return r
+00016d10: 6563 6f72 640a 0a0a 4074 696d 656c 696e  ecord...@timelin
+00016d20: 652e 6576 656e 740a 6465 6620 7265 6672  e.event.def refr
+00016d30: 6573 685f 636c 7573 7465 725f 7374 6174  esh_cluster_stat
+00016d40: 7573 5f68 616e 646c 6528 0a20 2020 2063  us_handle(.    c
+00016d50: 6c75 7374 6572 5f6e 616d 653a 2073 7472  luster_name: str
+00016d60: 2c0a 2020 2020 2a2c 0a20 2020 2066 6f72  ,.    *,.    for
+00016d70: 6365 5f72 6566 7265 7368 5f73 7461 7475  ce_refresh_statu
+00016d80: 7365 733a 204f 7074 696f 6e61 6c5b 5365  ses: Optional[Se
+00016d90: 745b 7374 6174 7573 5f6c 6962 2e43 6c75  t[status_lib.Clu
+00016da0: 7374 6572 5374 6174 7573 5d5d 203d 204e  sterStatus]] = N
+00016db0: 6f6e 652c 0a20 2020 2061 6371 7569 7265  one,.    acquire
+00016dc0: 5f70 6572 5f63 6c75 7374 6572 5f73 7461  _per_cluster_sta
+00016dd0: 7475 735f 6c6f 636b 3a20 626f 6f6c 203d  tus_lock: bool =
+00016de0: 2054 7275 652c 0a20 2020 2063 6c75 7374   True,.    clust
+00016df0: 6572 5f73 7461 7475 735f 6c6f 636b 5f74  er_status_lock_t
+00016e00: 696d 656f 7574 3a20 696e 7420 3d20 434c  imeout: int = CL
+00016e10: 5553 5445 525f 5354 4154 5553 5f4c 4f43  USTER_STATUS_LOC
+00016e20: 4b5f 5449 4d45 4f55 545f 5345 434f 4e44  K_TIMEOUT_SECOND
+00016e30: 530a 2920 2d3e 2054 7570 6c65 5b4f 7074  S.) -> Tuple[Opt
+00016e40: 696f 6e61 6c5b 7374 6174 7573 5f6c 6962  ional[status_lib
+00016e50: 2e43 6c75 7374 6572 5374 6174 7573 5d2c  .ClusterStatus],
+00016e60: 0a20 2020 2020 2020 2020 2020 4f70 7469  .           Opti
+00016e70: 6f6e 616c 5b62 6163 6b65 6e64 732e 5265  onal[backends.Re
+00016e80: 736f 7572 6365 4861 6e64 6c65 5d5d 3a0a  sourceHandle]]:.
+00016e90: 2020 2020 2222 2252 6566 7265 7368 2074      """Refresh t
+00016ea0: 6865 2063 6c75 7374 6572 2c20 616e 6420  he cluster, and 
+00016eb0: 7265 7475 726e 2074 6865 2070 6f73 7369  return the possi
+00016ec0: 626c 7920 7570 6461 7465 6420 7374 6174  bly updated stat
+00016ed0: 7573 2061 6e64 2068 616e 646c 652e 0a0a  us and handle...
+00016ee0: 2020 2020 5468 6973 2069 7320 6120 7772      This is a wr
+00016ef0: 6170 7065 7220 6f66 2072 6566 7265 7368  apper of refresh
+00016f00: 5f63 6c75 7374 6572 5f72 6563 6f72 642c  _cluster_record,
+00016f10: 2077 6869 6368 2072 6574 7572 6e73 2074   which returns t
+00016f20: 6865 2073 7461 7475 7320 616e 640a 2020  he status and.  
+00016f30: 2020 6861 6e64 6c65 206f 6620 7468 6520    handle of the 
+00016f40: 636c 7573 7465 722e 0a20 2020 2050 6c65  cluster..    Ple
+00016f50: 6173 6520 7265 6665 7220 746f 2074 6865  ase refer to the
+00016f60: 2064 6f63 7374 7269 6e67 206f 6620 7265   docstring of re
+00016f70: 6672 6573 685f 636c 7573 7465 725f 7265  fresh_cluster_re
+00016f80: 636f 7264 2066 6f72 2074 6865 2064 6574  cord for the det
+00016f90: 6169 6c73 2e0a 2020 2020 2222 220a 2020  ails..    """.  
+00016fa0: 2020 7265 636f 7264 203d 2072 6566 7265    record = refre
+00016fb0: 7368 5f63 6c75 7374 6572 5f72 6563 6f72  sh_cluster_recor
+00016fc0: 6428 0a20 2020 2020 2020 2063 6c75 7374  d(.        clust
+00016fd0: 6572 5f6e 616d 652c 0a20 2020 2020 2020  er_name,.       
+00016fe0: 2066 6f72 6365 5f72 6566 7265 7368 5f73   force_refresh_s
+00016ff0: 7461 7475 7365 733d 666f 7263 655f 7265  tatuses=force_re
+00017000: 6672 6573 685f 7374 6174 7573 6573 2c0a  fresh_statuses,.
+00017010: 2020 2020 2020 2020 6163 7175 6972 655f          acquire_
+00017020: 7065 725f 636c 7573 7465 725f 7374 6174  per_cluster_stat
+00017030: 7573 5f6c 6f63 6b3d 6163 7175 6972 655f  us_lock=acquire_
+00017040: 7065 725f 636c 7573 7465 725f 7374 6174  per_cluster_stat
+00017050: 7573 5f6c 6f63 6b2c 0a20 2020 2020 2020  us_lock,.       
+00017060: 2063 6c75 7374 6572 5f73 7461 7475 735f   cluster_status_
+00017070: 6c6f 636b 5f74 696d 656f 7574 3d63 6c75  lock_timeout=clu
+00017080: 7374 6572 5f73 7461 7475 735f 6c6f 636b  ster_status_lock
+00017090: 5f74 696d 656f 7574 290a 2020 2020 6966  _timeout).    if
+000170a0: 2072 6563 6f72 6420 6973 204e 6f6e 653a   record is None:
+000170b0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000170c0: 4e6f 6e65 2c20 4e6f 6e65 0a20 2020 2072  None, None.    r
+000170d0: 6574 7572 6e20 7265 636f 7264 5b27 7374  eturn record['st
+000170e0: 6174 7573 275d 2c20 7265 636f 7264 5b27  atus'], record['
+000170f0: 6861 6e64 6c65 275d 0a0a 0a23 203d 3d3d  handle']...# ===
+00017100: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00017110: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00017120: 3d3d 0a0a 0a40 7479 7069 6e67 2e6f 7665  ==...@typing.ove
+00017130: 726c 6f61 640a 6465 6620 6368 6563 6b5f  rload.def check_
+00017140: 636c 7573 7465 725f 6176 6169 6c61 626c  cluster_availabl
+00017150: 6528 0a20 2020 2063 6c75 7374 6572 5f6e  e(.    cluster_n
+00017160: 616d 653a 2073 7472 2c0a 2020 2020 2a2c  ame: str,.    *,
+00017170: 0a20 2020 206f 7065 7261 7469 6f6e 3a20  .    operation: 
+00017180: 7374 722c 0a20 2020 2063 6865 636b 5f63  str,.    check_c
+00017190: 6c6f 7564 5f76 6d5f 7261 795f 6261 636b  loud_vm_ray_back
+000171a0: 656e 643a 204c 6974 6572 616c 5b54 7275  end: Literal[Tru
+000171b0: 655d 203d 2054 7275 652c 0a20 2020 2064  e] = True,.    d
+000171c0: 7279 7275 6e3a 2062 6f6f 6c20 3d20 2e2e  ryrun: bool = ..
+000171d0: 2e2c 0a29 202d 3e20 2763 6c6f 7564 5f76  .,.) -> 'cloud_v
+000171e0: 6d5f 7261 795f 6261 636b 656e 642e 436c  m_ray_backend.Cl
+000171f0: 6f75 6456 6d52 6179 5265 736f 7572 6365  oudVmRayResource
+00017200: 4861 6e64 6c65 273a 0a20 2020 202e 2e2e  Handle':.    ...
+00017210: 0a0a 0a40 7479 7069 6e67 2e6f 7665 726c  ...@typing.overl
+00017220: 6f61 640a 6465 6620 6368 6563 6b5f 636c  oad.def check_cl
+00017230: 7573 7465 725f 6176 6169 6c61 626c 6528  uster_available(
+00017240: 0a20 2020 2063 6c75 7374 6572 5f6e 616d  .    cluster_nam
+00017250: 653a 2073 7472 2c0a 2020 2020 2a2c 0a20  e: str,.    *,. 
+00017260: 2020 206f 7065 7261 7469 6f6e 3a20 7374     operation: st
+00017270: 722c 0a20 2020 2063 6865 636b 5f63 6c6f  r,.    check_clo
+00017280: 7564 5f76 6d5f 7261 795f 6261 636b 656e  ud_vm_ray_backen
+00017290: 643a 204c 6974 6572 616c 5b46 616c 7365  d: Literal[False
+000172a0: 5d2c 0a20 2020 2064 7279 7275 6e3a 2062  ],.    dryrun: b
+000172b0: 6f6f 6c20 3d20 2e2e 2e2c 0a29 202d 3e20  ool = ...,.) -> 
+000172c0: 6261 636b 656e 6473 2e52 6573 6f75 7263  backends.Resourc
+000172d0: 6548 616e 646c 653a 0a20 2020 202e 2e2e  eHandle:.    ...
+000172e0: 0a0a 0a64 6566 2063 6865 636b 5f63 6c75  ...def check_clu
+000172f0: 7374 6572 5f61 7661 696c 6162 6c65 280a  ster_available(.
+00017300: 2020 2020 636c 7573 7465 725f 6e61 6d65      cluster_name
+00017310: 3a20 7374 722c 0a20 2020 202a 2c0a 2020  : str,.    *,.  
+00017320: 2020 6f70 6572 6174 696f 6e3a 2073 7472    operation: str
+00017330: 2c0a 2020 2020 6368 6563 6b5f 636c 6f75  ,.    check_clou
+00017340: 645f 766d 5f72 6179 5f62 6163 6b65 6e64  d_vm_ray_backend
+00017350: 3a20 626f 6f6c 203d 2054 7275 652c 0a20  : bool = True,. 
+00017360: 2020 2064 7279 7275 6e3a 2062 6f6f 6c20     dryrun: bool 
+00017370: 3d20 4661 6c73 652c 0a29 202d 3e20 6261  = False,.) -> ba
+00017380: 636b 656e 6473 2e52 6573 6f75 7263 6548  ckends.ResourceH
+00017390: 616e 646c 653a 0a20 2020 2022 2222 4368  andle:.    """Ch
+000173a0: 6563 6b20 6966 2074 6865 2063 6c75 7374  eck if the clust
+000173b0: 6572 2069 7320 6176 6169 6c61 626c 652e  er is available.
+000173c0: 0a0a 2020 2020 5261 6973 6573 3a0a 2020  ..    Raises:.  
+000173d0: 2020 2020 2020 5661 6c75 6545 7272 6f72        ValueError
+000173e0: 3a20 6966 2074 6865 2063 6c75 7374 6572  : if the cluster
+000173f0: 2064 6f65 7320 6e6f 7420 6578 6973 742e   does not exist.
+00017400: 0a20 2020 2020 2020 2065 7863 6570 7469  .        excepti
+00017410: 6f6e 732e 436c 7573 7465 724e 6f74 5570  ons.ClusterNotUp
+00017420: 4572 726f 723a 2069 6620 7468 6520 636c  Error: if the cl
+00017430: 7573 7465 7220 6973 206e 6f74 2055 502e  uster is not UP.
+00017440: 0a20 2020 2020 2020 2065 7863 6570 7469  .        excepti
+00017450: 6f6e 732e 4e6f 7453 7570 706f 7274 6564  ons.NotSupported
+00017460: 4572 726f 723a 2069 6620 7468 6520 636c  Error: if the cl
+00017470: 7573 7465 7220 6973 206e 6f74 2062 6173  uster is not bas
+00017480: 6564 206f 6e0a 2020 2020 2020 2020 2020  ed on.          
+00017490: 436c 6f75 6456 6d52 6179 4261 636b 656e  CloudVmRayBacken
+000174a0: 642e 0a20 2020 2020 2020 2065 7863 6570  d..        excep
+000174b0: 7469 6f6e 732e 436c 7573 7465 724f 776e  tions.ClusterOwn
+000174c0: 6572 4964 656e 7469 7479 4d69 736d 6174  erIdentityMismat
+000174d0: 6368 4572 726f 723a 2069 6620 7468 6520  chError: if the 
+000174e0: 6375 7272 656e 7420 7573 6572 2069 730a  current user is.
+000174f0: 2020 2020 2020 2020 2020 6e6f 7420 7468            not th
+00017500: 6520 7361 6d65 2061 7320 7468 6520 7573  e same as the us
+00017510: 6572 2077 686f 2063 7265 6174 6564 2074  er who created t
+00017520: 6865 2063 6c75 7374 6572 2e0a 2020 2020  he cluster..    
+00017530: 2020 2020 6578 6365 7074 696f 6e73 2e43      exceptions.C
+00017540: 6c6f 7564 5573 6572 4964 656e 7469 7479  loudUserIdentity
+00017550: 4572 726f 723a 2069 6620 7765 2066 6169  Error: if we fai
+00017560: 6c20 746f 2067 6574 2074 6865 2063 7572  l to get the cur
+00017570: 7265 6e74 2075 7365 720a 2020 2020 2020  rent user.      
+00017580: 2020 2020 6964 656e 7469 7479 2e0a 2020      identity..  
+00017590: 2020 2222 220a 2020 2020 7265 636f 7264    """.    record
+000175a0: 203d 2067 6c6f 6261 6c5f 7573 6572 5f73   = global_user_s
+000175b0: 7461 7465 2e67 6574 5f63 6c75 7374 6572  tate.get_cluster
+000175c0: 5f66 726f 6d5f 6e61 6d65 2863 6c75 7374  _from_name(clust
+000175d0: 6572 5f6e 616d 6529 0a20 2020 2069 6620  er_name).    if 
+000175e0: 6472 7972 756e 3a0a 2020 2020 2020 2020  dryrun:.        
+000175f0: 6173 7365 7274 2072 6563 6f72 6420 6973  assert record is
+00017600: 206e 6f74 204e 6f6e 652c 2063 6c75 7374   not None, clust
+00017610: 6572 5f6e 616d 650a 2020 2020 2020 2020  er_name.        
+00017620: 7265 7475 726e 2072 6563 6f72 645b 2768  return record['h
+00017630: 616e 646c 6527 5d0a 0a20 2020 2070 7265  andle']..    pre
+00017640: 7669 6f75 735f 636c 7573 7465 725f 7374  vious_cluster_st
+00017650: 6174 7573 203d 204e 6f6e 650a 2020 2020  atus = None.    
+00017660: 6966 2072 6563 6f72 6420 6973 206e 6f74  if record is not
+00017670: 204e 6f6e 653a 0a20 2020 2020 2020 2070   None:.        p
+00017680: 7265 7669 6f75 735f 636c 7573 7465 725f  revious_cluster_
+00017690: 7374 6174 7573 203d 2072 6563 6f72 645b  status = record[
+000176a0: 2773 7461 7475 7327 5d0a 0a20 2020 2074  'status']..    t
+000176b0: 7279 3a0a 2020 2020 2020 2020 636c 7573  ry:.        clus
+000176c0: 7465 725f 7374 6174 7573 2c20 6861 6e64  ter_status, hand
+000176d0: 6c65 203d 2072 6566 7265 7368 5f63 6c75  le = refresh_clu
+000176e0: 7374 6572 5f73 7461 7475 735f 6861 6e64  ster_status_hand
+000176f0: 6c65 2863 6c75 7374 6572 5f6e 616d 6529  le(cluster_name)
+00017700: 0a20 2020 2065 7863 6570 7420 6578 6365  .    except exce
+00017710: 7074 696f 6e73 2e43 6c75 7374 6572 5374  ptions.ClusterSt
+00017720: 6174 7573 4665 7463 6869 6e67 4572 726f  atusFetchingErro
+00017730: 7220 6173 2065 3a0a 2020 2020 2020 2020  r as e:.        
+00017740: 2320 4661 696c 6564 2074 6f20 7265 6672  # Failed to refr
+00017750: 6573 6820 7468 6520 636c 7573 7465 7220  esh the cluster 
+00017760: 7374 6174 7573 2069 7320 6e6f 7420 6661  status is not fa
+00017770: 7461 6c20 6572 726f 7220 6173 2074 6865  tal error as the
+00017780: 2063 616c 6c65 7273 0a20 2020 2020 2020   callers.       
+00017790: 2023 2063 616e 2073 7469 6c6c 2062 6520   # can still be 
+000177a0: 646f 6e65 2062 7920 6f6e 6c79 2075 7369  done by only usi
+000177b0: 6e67 2073 7368 2c20 6275 7420 7468 6520  ng ssh, but the 
+000177c0: 7373 6820 6361 6e20 6861 6e67 2069 6620  ssh can hang if 
+000177d0: 7468 650a 2020 2020 2020 2020 2320 636c  the.        # cl
+000177e0: 7573 7465 7220 6973 206e 6f74 2075 7020  uster is not up 
+000177f0: 2865 2e67 2e2c 2061 7574 6f73 746f 7070  (e.g., autostopp
+00017800: 6564 292e 0a0a 2020 2020 2020 2020 2320  ed)...        # 
+00017810: 5765 2064 6f20 6e6f 7420 6361 7463 6820  We do not catch 
+00017820: 7468 6520 6578 6365 7074 696f 6e20 666f  the exception fo
+00017830: 7220 636c 6f75 6420 6964 656e 7469 7479  r cloud identity
+00017840: 2063 6865 636b 696e 6720 666f 7220 6e6f   checking for no
+00017850: 772c 2069 6e0a 2020 2020 2020 2020 2320  w, in.        # 
+00017860: 6f72 6465 7220 746f 2064 6973 6162 6c65  order to disable
+00017870: 2061 6c6c 206f 7065 7261 7469 6f6e 7320   all operations 
+00017880: 6f6e 2063 6c75 7374 6572 7320 6372 6561  on clusters crea
+00017890: 7465 6420 6279 2061 6e6f 7468 6572 2075  ted by another u
+000178a0: 7365 720a 2020 2020 2020 2020 2320 6964  ser.        # id
+000178b0: 656e 7469 7479 2e20 2054 6861 7420 7769  entity.  That wi
+000178c0: 6c6c 206d 616b 6520 7468 6520 6465 7369  ll make the desi
+000178d0: 676e 2073 696d 706c 6572 2061 6e64 2065  gn simpler and e
+000178e0: 6173 6965 7220 746f 0a20 2020 2020 2020  asier to.       
+000178f0: 2023 2075 6e64 6572 7374 616e 642c 2062   # understand, b
+00017900: 7574 2069 7420 6d69 6768 7420 6265 2075  ut it might be u
+00017910: 7365 6675 6c20 746f 2061 6c6c 6f77 2074  seful to allow t
+00017920: 6865 2075 7365 7220 746f 2075 7365 0a20  he user to use. 
+00017930: 2020 2020 2020 2023 206f 7065 7261 7469         # operati
+00017940: 6f6e 7320 7468 6174 206f 6e6c 7920 696e  ons that only in
+00017950: 766f 6c76 6520 7373 6820 2865 2e67 2e2c  volve ssh (e.g.,
+00017960: 2073 6b79 2065 7865 632c 2073 6b79 206c   sky exec, sky l
+00017970: 6f67 732c 2065 7463 2920 6576 656e 0a20  ogs, etc) even. 
+00017980: 2020 2020 2020 2023 2069 6620 7468 6520         # if the 
+00017990: 7573 6572 2069 7320 6e6f 7420 7468 6520  user is not the 
+000179a0: 6f77 6e65 7220 6f66 2074 6865 2063 6c75  owner of the clu
+000179b0: 7374 6572 2e0a 2020 2020 2020 2020 7578  ster..        ux
+000179c0: 5f75 7469 6c73 2e63 6f6e 736f 6c65 5f6e  _utils.console_n
+000179d0: 6577 6c69 6e65 2829 0a20 2020 2020 2020  ewline().       
+000179e0: 206c 6f67 6765 722e 7761 726e 696e 6728   logger.warning(
+000179f0: 0a20 2020 2020 2020 2020 2020 2066 2746  .            f'F
+00017a00: 6169 6c65 6420 746f 2072 6566 7265 7368  ailed to refresh
+00017a10: 2074 6865 2073 7461 7475 7320 666f 7220   the status for 
+00017a20: 636c 7573 7465 7220 7b63 6c75 7374 6572  cluster {cluster
+00017a30: 5f6e 616d 6521 727d 2e20 4974 2069 7320  _name!r}. It is 
+00017a40: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
+00017a50: 6e6f 7420 6661 7461 6c2c 2062 7574 207b  not fatal, but {
+00017a60: 6f70 6572 6174 696f 6e7d 206d 6967 6874  operation} might
+00017a70: 2068 616e 6720 6966 2074 6865 2063 6c75   hang if the clu
+00017a80: 7374 6572 2069 7320 6e6f 7420 7570 2e5c  ster is not up.\
+00017a90: 6e27 0a20 2020 2020 2020 2020 2020 2066  n'.            f
+00017aa0: 2744 6574 6169 6c65 6420 7265 6173 6f6e  'Detailed reason
+00017ab0: 3a20 7b65 7d27 290a 2020 2020 2020 2020  : {e}').        
+00017ac0: 6966 2072 6563 6f72 6420 6973 204e 6f6e  if record is Non
+00017ad0: 653a 0a20 2020 2020 2020 2020 2020 2063  e:.            c
+00017ae0: 6c75 7374 6572 5f73 7461 7475 732c 2068  luster_status, h
+00017af0: 616e 646c 6520 3d20 4e6f 6e65 2c20 4e6f  andle = None, No
+00017b00: 6e65 0a20 2020 2020 2020 2065 6c73 653a  ne.        else:
+00017b10: 0a20 2020 2020 2020 2020 2020 2063 6c75  .            clu
+00017b20: 7374 6572 5f73 7461 7475 732c 2068 616e  ster_status, han
+00017b30: 646c 6520 3d20 7265 636f 7264 5b27 7374  dle = record['st
+00017b40: 6174 7573 275d 2c20 7265 636f 7264 5b27  atus'], record['
+00017b50: 6861 6e64 6c65 275d 0a0a 2020 2020 6272  handle']..    br
+00017b60: 6967 6874 203d 2063 6f6c 6f72 616d 612e  ight = colorama.
+00017b70: 5374 796c 652e 4252 4947 4854 0a20 2020  Style.BRIGHT.   
+00017b80: 2072 6573 6574 203d 2063 6f6c 6f72 616d   reset = coloram
+00017b90: 612e 5374 796c 652e 5245 5345 545f 414c  a.Style.RESET_AL
+00017ba0: 4c0a 2020 2020 6966 2068 616e 646c 6520  L.    if handle 
+00017bb0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+00017bc0: 2069 6620 7072 6576 696f 7573 5f63 6c75   if previous_clu
+00017bd0: 7374 6572 5f73 7461 7475 7320 6973 204e  ster_status is N
+00017be0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00017bf0: 2065 7272 6f72 5f6d 7367 203d 2066 2743   error_msg = f'C
+00017c00: 6c75 7374 6572 207b 636c 7573 7465 725f  luster {cluster_
+00017c10: 6e61 6d65 2172 7d20 646f 6573 206e 6f74  name!r} does not
+00017c20: 2065 7869 7374 2e27 0a20 2020 2020 2020   exist.'.       
+00017c30: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00017c40: 2020 2065 7272 6f72 5f6d 7367 203d 2028     error_msg = (
+00017c50: 6627 436c 7573 7465 7220 7b63 6c75 7374  f'Cluster {clust
+00017c60: 6572 5f6e 616d 6521 727d 206e 6f74 2066  er_name!r} not f
+00017c70: 6f75 6e64 206f 6e20 7468 6520 636c 6f75  ound on the clou
+00017c80: 6420 270a 2020 2020 2020 2020 2020 2020  d '.            
+00017c90: 2020 2020 2020 2020 2020 2020 2027 7072               'pr
+00017ca0: 6f76 6964 6572 2e27 290a 2020 2020 2020  ovider.').      
+00017cb0: 2020 2020 2020 6173 7365 7274 2072 6563        assert rec
+00017cc0: 6f72 6420 6973 206e 6f74 204e 6f6e 652c  ord is not None,
+00017cd0: 2070 7265 7669 6f75 735f 636c 7573 7465   previous_cluste
+00017ce0: 725f 7374 6174 7573 0a20 2020 2020 2020  r_status.       
+00017cf0: 2020 2020 2061 6374 696f 6e73 203d 205b       actions = [
+00017d00: 5d0a 2020 2020 2020 2020 2020 2020 6966  ].            if
+00017d10: 2072 6563 6f72 645b 2768 616e 646c 6527   record['handle'
+00017d20: 5d2e 6c61 756e 6368 6564 5f72 6573 6f75  ].launched_resou
+00017d30: 7263 6573 2e75 7365 5f73 706f 743a 0a20  rces.use_spot:. 
+00017d40: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00017d50: 6374 696f 6e73 2e61 7070 656e 6428 2770  ctions.append('p
+00017d60: 7265 656d 7074 6564 2729 0a20 2020 2020  reempted').     
+00017d70: 2020 2020 2020 2069 6620 7265 636f 7264         if record
+00017d80: 5b27 6175 746f 7374 6f70 275d 203e 2030  ['autostop'] > 0
+00017d90: 2061 6e64 2072 6563 6f72 645b 2774 6f5f   and record['to_
+00017da0: 646f 776e 275d 3a0a 2020 2020 2020 2020  down']:.        
+00017db0: 2020 2020 2020 2020 6163 7469 6f6e 732e          actions.
+00017dc0: 6170 7065 6e64 2827 6175 746f 646f 776e  append('autodown
+00017dd0: 6564 2729 0a20 2020 2020 2020 2020 2020  ed').           
+00017de0: 2061 6374 696f 6e73 2e61 7070 656e 6428   actions.append(
+00017df0: 276d 616e 7561 6c6c 7920 7465 726d 696e  'manually termin
+00017e00: 6174 6564 2069 6e20 636f 6e73 6f6c 6527  ated in console'
+00017e10: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+00017e20: 206c 656e 2861 6374 696f 6e73 2920 3e20   len(actions) > 
+00017e30: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
+00017e40: 2020 2061 6374 696f 6e73 5b2d 315d 203d     actions[-1] =
+00017e50: 2027 6f72 2027 202b 2061 6374 696f 6e73   'or ' + actions
+00017e60: 5b2d 315d 0a20 2020 2020 2020 2020 2020  [-1].           
+00017e70: 2061 6374 696f 6e73 5f73 7472 203d 2027   actions_str = '
+00017e80: 2c20 272e 6a6f 696e 2861 6374 696f 6e73  , '.join(actions
+00017e90: 290a 2020 2020 2020 2020 2020 2020 6d65  ).            me
+00017ea0: 7373 6167 6520 3d20 6627 2049 7420 7761  ssage = f' It wa
+00017eb0: 7320 6c69 6b65 6c79 207b 6163 7469 6f6e  s likely {action
+00017ec0: 735f 7374 727d 2e27 0a20 2020 2020 2020  s_str}.'.       
+00017ed0: 2020 2020 2069 6620 6c65 6e28 6163 7469       if len(acti
+00017ee0: 6f6e 7329 203e 2031 3a0a 2020 2020 2020  ons) > 1:.      
+00017ef0: 2020 2020 2020 2020 2020 6d65 7373 6167            messag
+00017f00: 6520 3d20 6d65 7373 6167 652e 7265 706c  e = message.repl
+00017f10: 6163 6528 276c 696b 656c 7927 2c20 2765  ace('likely', 'e
+00017f20: 6974 6865 7227 290a 2020 2020 2020 2020  ither').        
+00017f30: 2020 2020 6572 726f 725f 6d73 6720 2b3d      error_msg +=
+00017f40: 206d 6573 7361 6765 0a0a 2020 2020 2020   message..      
+00017f50: 2020 7769 7468 2075 785f 7574 696c 732e    with ux_utils.
+00017f60: 7072 696e 745f 6578 6365 7074 696f 6e5f  print_exception_
+00017f70: 6e6f 5f74 7261 6365 6261 636b 2829 3a0a  no_traceback():.
+00017f80: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00017f90: 6520 5661 6c75 6545 7272 6f72 2866 277b  e ValueError(f'{
+00017fa0: 636f 6c6f 7261 6d61 2e46 6f72 652e 5945  colorama.Fore.YE
+00017fb0: 4c4c 4f57 7d7b 6572 726f 725f 6d73 677d  LLOW}{error_msg}
+00017fc0: 7b72 6573 6574 7d27 290a 2020 2020 6173  {reset}').    as
+00017fd0: 7365 7274 2063 6c75 7374 6572 5f73 7461  sert cluster_sta
+00017fe0: 7475 7320 6973 206e 6f74 204e 6f6e 652c  tus is not None,
+00017ff0: 2027 6861 6e64 6c65 2069 7320 6e6f 7420   'handle is not 
+00018000: 4e6f 6e65 2062 7574 2073 7461 7475 7320  None but status 
+00018010: 6973 204e 6f6e 6527 0a20 2020 2062 6163  is None'.    bac
+00018020: 6b65 6e64 203d 2067 6574 5f62 6163 6b65  kend = get_backe
+00018030: 6e64 5f66 726f 6d5f 6861 6e64 6c65 2868  nd_from_handle(h
+00018040: 616e 646c 6529 0a20 2020 2069 6620 6368  andle).    if ch
+00018050: 6563 6b5f 636c 6f75 645f 766d 5f72 6179  eck_cloud_vm_ray
+00018060: 5f62 6163 6b65 6e64 2061 6e64 206e 6f74  _backend and not
+00018070: 2069 7369 6e73 7461 6e63 6528 0a20 2020   isinstance(.   
+00018080: 2020 2020 2020 2020 2062 6163 6b65 6e64           backend
+00018090: 2c20 6261 636b 656e 6473 2e43 6c6f 7564  , backends.Cloud
+000180a0: 566d 5261 7942 6163 6b65 6e64 293a 0a20  VmRayBackend):. 
+000180b0: 2020 2020 2020 2077 6974 6820 7578 5f75         with ux_u
+000180c0: 7469 6c73 2e70 7269 6e74 5f65 7863 6570  tils.print_excep
+000180d0: 7469 6f6e 5f6e 6f5f 7472 6163 6562 6163  tion_no_tracebac
+000180e0: 6b28 293a 0a20 2020 2020 2020 2020 2020  k():.           
+000180f0: 2072 6169 7365 2065 7863 6570 7469 6f6e   raise exception
+00018100: 732e 4e6f 7453 7570 706f 7274 6564 4572  s.NotSupportedEr
+00018110: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
+00018120: 2020 2020 2066 277b 636f 6c6f 7261 6d61       f'{colorama
+00018130: 2e46 6f72 652e 5945 4c4c 4f57 7d7b 6f70  .Fore.YELLOW}{op
+00018140: 6572 6174 696f 6e2e 6361 7069 7461 6c69  eration.capitali
+00018150: 7a65 2829 7d3a 2073 6b69 7070 6564 2066  ze()}: skipped f
+00018160: 6f72 2027 0a20 2020 2020 2020 2020 2020  or '.           
+00018170: 2020 2020 2066 2763 6c75 7374 6572 207b       f'cluster {
+00018180: 636c 7573 7465 725f 6e61 6d65 2172 7d2e  cluster_name!r}.
+00018190: 2049 7420 6973 206f 6e6c 7920 7375 7070   It is only supp
+000181a0: 6f72 7465 6420 6279 2062 6163 6b65 6e64  orted by backend
+000181b0: 3a20 270a 2020 2020 2020 2020 2020 2020  : '.            
+000181c0: 2020 2020 6627 7b62 6163 6b65 6e64 732e      f'{backends.
+000181d0: 436c 6f75 6456 6d52 6179 4261 636b 656e  CloudVmRayBacken
+000181e0: 642e 4e41 4d45 7d2e 270a 2020 2020 2020  d.NAME}.'.      
+000181f0: 2020 2020 2020 2020 2020 6627 7b72 6573            f'{res
+00018200: 6574 7d27 290a 2020 2020 6966 2063 6c75  et}').    if clu
+00018210: 7374 6572 5f73 7461 7475 7320 213d 2073  ster_status != s
+00018220: 7461 7475 735f 6c69 622e 436c 7573 7465  tatus_lib.Cluste
+00018230: 7253 7461 7475 732e 5550 3a0a 2020 2020  rStatus.UP:.    
+00018240: 2020 2020 7769 7468 2075 785f 7574 696c      with ux_util
+00018250: 732e 7072 696e 745f 6578 6365 7074 696f  s.print_exceptio
+00018260: 6e5f 6e6f 5f74 7261 6365 6261 636b 2829  n_no_traceback()
+00018270: 3a0a 2020 2020 2020 2020 2020 2020 6869  :.            hi
+00018280: 6e74 5f66 6f72 5f69 6e69 7420 3d20 2727  nt_for_init = ''
+00018290: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000182a0: 636c 7573 7465 725f 7374 6174 7573 203d  cluster_status =
+000182b0: 3d20 7374 6174 7573 5f6c 6962 2e43 6c75  = status_lib.Clu
+000182c0: 7374 6572 5374 6174 7573 2e49 4e49 543a  sterStatus.INIT:
+000182d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000182e0: 2068 696e 745f 666f 725f 696e 6974 203d   hint_for_init =
+000182f0: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+00018300: 2020 2020 2020 2066 277b 7265 7365 747d         f'{reset}
+00018310: 2057 6169 7420 666f 7220 6120 6c61 756e   Wait for a laun
+00018320: 6368 2074 6f20 6669 6e69 7368 2c20 6f72  ch to finish, or
+00018330: 2075 7365 2074 6869 7320 636f 6d6d 616e   use this comman
+00018340: 6420 270a 2020 2020 2020 2020 2020 2020  d '.            
+00018350: 2020 2020 2020 2020 6627 746f 2074 7279          f'to try
+00018360: 2074 6f20 7472 616e 7369 7469 6f6e 2074   to transition t
+00018370: 6865 2063 6c75 7374 6572 2074 6f20 5550  he cluster to UP
+00018380: 3a20 7b62 7269 6768 747d 736b 7920 270a  : {bright}sky '.
+00018390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000183a0: 2020 2020 6627 7374 6172 7420 7b63 6c75      f'start {clu
+000183b0: 7374 6572 5f6e 616d 657d 7b72 6573 6574  ster_name}{reset
+000183c0: 7d27 290a 2020 2020 2020 2020 2020 2020  }').            
+000183d0: 7261 6973 6520 6578 6365 7074 696f 6e73  raise exceptions
+000183e0: 2e43 6c75 7374 6572 4e6f 7455 7045 7272  .ClusterNotUpErr
+000183f0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+00018400: 2020 2020 6627 7b63 6f6c 6f72 616d 612e      f'{colorama.
+00018410: 466f 7265 2e59 454c 4c4f 577d 7b6f 7065  Fore.YELLOW}{ope
+00018420: 7261 7469 6f6e 2e63 6170 6974 616c 697a  ration.capitaliz
+00018430: 6528 297d 3a20 736b 6970 7065 6420 666f  e()}: skipped fo
+00018440: 7220 270a 2020 2020 2020 2020 2020 2020  r '.            
+00018450: 2020 2020 6627 636c 7573 7465 7220 7b63      f'cluster {c
+00018460: 6c75 7374 6572 5f6e 616d 6521 727d 2028  luster_name!r} (
+00018470: 7374 6174 7573 3a20 7b63 6c75 7374 6572  status: {cluster
+00018480: 5f73 7461 7475 732e 7661 6c75 657d 292e  _status.value}).
+00018490: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+000184a0: 2020 2027 4974 2069 7320 6f6e 6c79 2061     'It is only a
+000184b0: 6c6c 6f77 6564 2066 6f72 2027 0a20 2020  llowed for '.   
+000184c0: 2020 2020 2020 2020 2020 2020 2066 277b               f'{
+000184d0: 7374 6174 7573 5f6c 6962 2e43 6c75 7374  status_lib.Clust
+000184e0: 6572 5374 6174 7573 2e55 502e 7661 6c75  erStatus.UP.valu
+000184f0: 657d 2063 6c75 7374 6572 732e 270a 2020  e} clusters.'.  
+00018500: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+00018510: 7b68 696e 745f 666f 725f 696e 6974 7d27  {hint_for_init}'
+00018520: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018530: 2066 277b 7265 7365 747d 272c 0a20 2020   f'{reset}',.   
+00018540: 2020 2020 2020 2020 2020 2020 2063 6c75               clu
+00018550: 7374 6572 5f73 7461 7475 733d 636c 7573  ster_status=clus
+00018560: 7465 725f 7374 6174 7573 2c0a 2020 2020  ter_status,.    
+00018570: 2020 2020 2020 2020 2020 2020 6861 6e64              hand
+00018580: 6c65 3d68 616e 646c 6529 0a0a 2020 2020  le=handle)..    
+00018590: 6966 2068 616e 646c 652e 6865 6164 5f69  if handle.head_i
+000185a0: 7020 6973 204e 6f6e 653a 0a20 2020 2020  p is None:.     
+000185b0: 2020 2077 6974 6820 7578 5f75 7469 6c73     with ux_utils
+000185c0: 2e70 7269 6e74 5f65 7863 6570 7469 6f6e  .print_exception
+000185d0: 5f6e 6f5f 7472 6163 6562 6163 6b28 293a  _no_traceback():
+000185e0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+000185f0: 7365 2065 7863 6570 7469 6f6e 732e 436c  se exceptions.Cl
+00018600: 7573 7465 724e 6f74 5570 4572 726f 7228  usterNotUpError(
+00018610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018620: 2066 2743 6c75 7374 6572 207b 636c 7573   f'Cluster {clus
+00018630: 7465 725f 6e61 6d65 2172 7d20 6861 7320  ter_name!r} has 
+00018640: 6265 656e 2073 746f 7070 6564 206f 7220  been stopped or 
+00018650: 6e6f 7420 7072 6f70 6572 6c79 2027 0a20  not properly '. 
+00018660: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00018670: 7365 7420 7570 2e20 506c 6561 7365 2072  set up. Please r
+00018680: 652d 6c61 756e 6368 2069 7420 7769 7468  e-launch it with
+00018690: 2060 736b 7920 7374 6172 7460 2e27 2c0a   `sky start`.',.
+000186a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000186b0: 636c 7573 7465 725f 7374 6174 7573 3d63  cluster_status=c
+000186c0: 6c75 7374 6572 5f73 7461 7475 732c 0a20  luster_status,. 
+000186d0: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+000186e0: 616e 646c 653d 6861 6e64 6c65 290a 2020  andle=handle).  
+000186f0: 2020 7265 7475 726e 2068 616e 646c 650a    return handle.
+00018700: 0a0a 2320 544f 444f 2874 6961 6e29 3a20  ..# TODO(tian): 
+00018710: 5265 6661 6374 6f72 2074 6f20 636f 6e74  Refactor to cont
+00018720: 726f 6c6c 6572 5f75 7469 6c73 2e20 4375  roller_utils. Cu
+00018730: 7272 656e 7420 626c 6f63 6b65 723a 2063  rrent blocker: c
+00018740: 6972 6375 6c61 7220 696d 706f 7274 2e0a  ircular import..
+00018750: 6465 6620 6973 5f63 6f6e 7472 6f6c 6c65  def is_controlle
+00018760: 725f 6163 6365 7373 6962 6c65 280a 2020  r_accessible(.  
+00018770: 2020 636f 6e74 726f 6c6c 6572 3a20 636f    controller: co
+00018780: 6e74 726f 6c6c 6572 5f75 7469 6c73 2e43  ntroller_utils.C
+00018790: 6f6e 7472 6f6c 6c65 7273 2c0a 2020 2020  ontrollers,.    
+000187a0: 7374 6f70 7065 645f 6d65 7373 6167 653a  stopped_message:
+000187b0: 2073 7472 2c0a 2020 2020 6e6f 6e5f 6578   str,.    non_ex
+000187c0: 6973 7465 6e74 5f6d 6573 7361 6765 3a20  istent_message: 
+000187d0: 4f70 7469 6f6e 616c 5b73 7472 5d20 3d20  Optional[str] = 
+000187e0: 4e6f 6e65 2c0a 2020 2020 6578 6974 5f69  None,.    exit_i
+000187f0: 665f 6e6f 745f 6163 6365 7373 6962 6c65  f_not_accessible
+00018800: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
+00018810: 2920 2d3e 2027 6261 636b 656e 6473 2e43  ) -> 'backends.C
+00018820: 6c6f 7564 566d 5261 7952 6573 6f75 7263  loudVmRayResourc
+00018830: 6548 616e 646c 6527 3a0a 2020 2020 2222  eHandle':.    ""
+00018840: 2243 6865 636b 2069 6620 7468 6520 6a6f  "Check if the jo
+00018850: 6273 2f73 6572 7665 2063 6f6e 7472 6f6c  bs/serve control
+00018860: 6c65 7220 6973 2075 702e 0a0a 2020 2020  ler is up...    
+00018870: 5468 6520 636f 6e74 726f 6c6c 6572 2069  The controller i
+00018880: 7320 6163 6365 7373 6962 6c65 2077 6865  s accessible whe
+00018890: 6e20 6974 2069 7320 696e 2055 5020 6f72  n it is in UP or
+000188a0: 2049 4e49 5420 7374 6174 652c 2061 6e64   INIT state, and
+000188b0: 2074 6865 2073 7368 0a20 2020 2063 6f6e   the ssh.    con
+000188c0: 6e65 6374 696f 6e20 6973 2073 7563 6365  nection is succe
+000188d0: 7373 6675 6c2e 0a0a 2020 2020 4974 2063  ssful...    It c
+000188e0: 616e 2062 6520 7573 6564 2074 6f20 6368  an be used to ch
+000188f0: 6563 6b20 6966 2074 6865 2063 6f6e 7472  eck if the contr
+00018900: 6f6c 6c65 7220 6973 2061 6363 6573 7369  oller is accessi
+00018910: 626c 6520 2873 696e 6365 2074 6865 2061  ble (since the a
+00018920: 7574 6f73 746f 700a 2020 2020 6973 2073  utostop.    is s
+00018930: 6574 2066 6f72 2074 6865 2063 6f6e 7472  et for the contr
+00018940: 6f6c 6c65 7229 2062 6566 6f72 6520 7468  oller) before th
+00018950: 6520 6a6f 6273 2f73 6572 7665 2063 6f6d  e jobs/serve com
+00018960: 6d61 6e64 7320 696e 7465 7261 6374 2077  mands interact w
+00018970: 6974 6820 7468 650a 2020 2020 636f 6e74  ith the.    cont
+00018980: 726f 6c6c 6572 2e0a 0a20 2020 2043 6c75  roller...    Clu
+00018990: 7374 6572 4e6f 7455 7045 7272 6f72 2077  sterNotUpError w
+000189a0: 696c 6c20 6265 2072 6169 7365 6420 7768  ill be raised wh
+000189b0: 656e 6576 6572 2074 6865 2063 6f6e 7472  enever the contr
+000189c0: 6f6c 6c65 7220 6361 6e6e 6f74 2062 6520  oller cannot be 
+000189d0: 6163 6365 7373 6564 2e0a 0a20 2020 2041  accessed...    A
+000189e0: 7267 733a 0a20 2020 2020 2020 2074 7970  rgs:.        typ
+000189f0: 653a 2054 7970 6520 6f66 2074 6865 2063  e: Type of the c
+00018a00: 6f6e 7472 6f6c 6c65 722e 0a20 2020 2020  ontroller..     
+00018a10: 2020 2073 746f 7070 6564 5f6d 6573 7361     stopped_messa
+00018a20: 6765 3a20 4d65 7373 6167 6520 746f 2070  ge: Message to p
+00018a30: 7269 6e74 2069 6620 7468 6520 636f 6e74  rint if the cont
+00018a40: 726f 6c6c 6572 2069 7320 5354 4f50 5045  roller is STOPPE
+00018a50: 442e 0a20 2020 2020 2020 206e 6f6e 5f65  D..        non_e
+00018a60: 7869 7374 656e 745f 6d65 7373 6167 653a  xistent_message:
+00018a70: 204d 6573 7361 6765 2074 6f20 7368 6f77   Message to show
+00018a80: 2069 6620 7468 6520 636f 6e74 726f 6c6c   if the controll
+00018a90: 6572 2064 6f65 7320 6e6f 7420 6578 6973  er does not exis
+00018aa0: 742e 0a20 2020 2020 2020 2065 7869 745f  t..        exit_
+00018ab0: 6966 5f6e 6f74 5f61 6363 6573 7369 626c  if_not_accessibl
+00018ac0: 653a 2057 6865 7468 6572 2074 6f20 6578  e: Whether to ex
+00018ad0: 6974 2064 6972 6563 746c 7920 6966 2074  it directly if t
+00018ae0: 6865 2063 6f6e 7472 6f6c 6c65 7220 6973  he controller is
+00018af0: 206e 6f74 0a20 2020 2020 2020 2020 2061   not.          a
+00018b00: 6363 6573 7369 626c 652e 2049 6620 4661  ccessible. If Fa
+00018b10: 6c73 652c 2074 6865 2066 756e 6374 696f  lse, the functio
+00018b20: 6e20 7769 6c6c 2072 6169 7365 2043 6c75  n will raise Clu
+00018b30: 7374 6572 4e6f 7455 7045 7272 6f72 2e0a  sterNotUpError..
+00018b40: 0a20 2020 2052 6574 7572 6e73 3a0a 2020  .    Returns:.  
+00018b50: 2020 2020 2020 6861 6e64 6c65 3a20 5468        handle: Th
+00018b60: 6520 5265 736f 7572 6365 4861 6e64 6c65  e ResourceHandle
+00018b70: 206f 6620 7468 6520 636f 6e74 726f 6c6c   of the controll
+00018b80: 6572 2e0a 0a20 2020 2052 6169 7365 733a  er...    Raises:
+00018b90: 0a20 2020 2020 2020 2065 7863 6570 7469  .        excepti
+00018ba0: 6f6e 732e 436c 7573 7465 724f 776e 6572  ons.ClusterOwner
+00018bb0: 4964 656e 7469 7479 4d69 736d 6174 6368  IdentityMismatch
+00018bc0: 4572 726f 723a 2069 6620 7468 6520 6375  Error: if the cu
+00018bd0: 7272 656e 7420 7573 6572 2069 7320 6e6f  rrent user is no
+00018be0: 740a 2020 2020 2020 2020 2020 7468 6520  t.          the 
+00018bf0: 7361 6d65 2061 7320 7468 6520 7573 6572  same as the user
+00018c00: 2077 686f 2063 7265 6174 6564 2074 6865   who created the
+00018c10: 2063 6c75 7374 6572 2e0a 2020 2020 2020   cluster..      
+00018c20: 2020 6578 6365 7074 696f 6e73 2e43 6c6f    exceptions.Clo
+00018c30: 7564 5573 6572 4964 656e 7469 7479 4572  udUserIdentityEr
+00018c40: 726f 723a 2069 6620 7765 2066 6169 6c20  ror: if we fail 
+00018c50: 746f 2067 6574 2074 6865 2063 7572 7265  to get the curre
+00018c60: 6e74 2075 7365 720a 2020 2020 2020 2020  nt user.        
+00018c70: 2020 6964 656e 7469 7479 2e0a 2020 2020    identity..    
+00018c80: 2020 2020 6578 6365 7074 696f 6e73 2e43      exceptions.C
+00018c90: 6c75 7374 6572 4e6f 7455 7045 7272 6f72  lusterNotUpError
+00018ca0: 3a20 6966 2074 6865 2063 6f6e 7472 6f6c  : if the control
+00018cb0: 6c65 7220 6973 206e 6f74 2061 6363 6573  ler is not acces
+00018cc0: 7369 626c 652c 206f 720a 2020 2020 2020  sible, or.      
+00018cd0: 2020 2020 6661 696c 6564 2074 6f20 6265      failed to be
+00018ce0: 2063 6f6e 6e65 6374 6564 2e0a 2020 2020   connected..    
+00018cf0: 2222 220a 2020 2020 6966 206e 6f6e 5f65  """.    if non_e
+00018d00: 7869 7374 656e 745f 6d65 7373 6167 6520  xistent_message 
+00018d10: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+00018d20: 206e 6f6e 5f65 7869 7374 656e 745f 6d65   non_existent_me
+00018d30: 7373 6167 6520 3d20 636f 6e74 726f 6c6c  ssage = controll
+00018d40: 6572 2e76 616c 7565 2e64 6566 6175 6c74  er.value.default
+00018d50: 5f68 696e 745f 6966 5f6e 6f6e 5f65 7869  _hint_if_non_exi
+00018d60: 7374 656e 740a 2020 2020 636c 7573 7465  stent.    cluste
+00018d70: 725f 6e61 6d65 203d 2063 6f6e 7472 6f6c  r_name = control
+00018d80: 6c65 722e 7661 6c75 652e 636c 7573 7465  ler.value.cluste
+00018d90: 725f 6e61 6d65 0a20 2020 206e 6565 645f  r_name.    need_
+00018da0: 636f 6e6e 6563 7469 6f6e 5f63 6865 636b  connection_check
+00018db0: 203d 2046 616c 7365 0a20 2020 2063 6f6e   = False.    con
+00018dc0: 7472 6f6c 6c65 725f 7374 6174 7573 2c20  troller_status, 
+00018dd0: 6861 6e64 6c65 203d 204e 6f6e 652c 204e  handle = None, N
+00018de0: 6f6e 650a 2020 2020 7472 793a 0a20 2020  one.    try:.   
+00018df0: 2020 2020 2023 2053 6574 2066 6f72 6365       # Set force
+00018e00: 5f72 6566 7265 7368 5f73 7461 7475 7365  _refresh_statuse
+00018e10: 733d 5b49 4e49 545d 2074 6f20 6d61 6b65  s=[INIT] to make
+00018e20: 2073 7572 6520 7468 6520 7265 6672 6573   sure the refres
+00018e30: 6820 6861 7070 656e 730a 2020 2020 2020  h happens.      
+00018e40: 2020 2320 7768 656e 2074 6865 2063 6f6e    # when the con
+00018e50: 7472 6f6c 6c65 7220 6973 2049 4e49 542f  troller is INIT/
+00018e60: 5550 2028 7472 6967 6765 7265 6420 696e  UP (triggered in
+00018e70: 2074 6865 7365 2073 7461 7475 7365 7320   these statuses 
+00018e80: 6173 2074 6865 0a20 2020 2020 2020 2023  as the.        #
+00018e90: 2061 7574 6f73 746f 7020 6973 2061 6c77   autostop is alw
+00018ea0: 6179 7320 7365 7420 666f 7220 7468 6520  ays set for the 
+00018eb0: 636f 6e74 726f 6c6c 6572 292e 2054 6865  controller). The
+00018ec0: 2063 6f6e 7472 6f6c 6c65 7220 6361 6e20   controller can 
+00018ed0: 6265 2069 6e0a 2020 2020 2020 2020 2320  be in.        # 
+00018ee0: 666f 6c6c 6f77 696e 6720 6361 7365 733a  following cases:
+00018ef0: 0a20 2020 2020 2020 2023 202a 2028 5550  .        # * (UP
+00018f00: 2c20 6175 746f 7374 6f70 2073 6574 293a  , autostop set):
+00018f10: 2069 7420 7769 6c6c 2062 6520 7265 6672   it will be refr
+00018f20: 6573 6865 6420 7769 7468 6f75 7420 666f  eshed without fo
+00018f30: 7263 655f 7265 6672 6573 6820 7365 742e  rce_refresh set.
+00018f40: 0a20 2020 2020 2020 2023 202a 2028 5550  .        # * (UP
+00018f50: 2c20 6e6f 2061 7574 6f73 746f 7029 3a20  , no autostop): 
+00018f60: 7665 7279 2072 6172 6520 2861 2075 7365  very rare (a use
+00018f70: 7220 6374 726c 2d63 2077 6865 6e20 7468  r ctrl-c when th
+00018f80: 6520 636f 6e74 726f 6c6c 6572 2069 730a  e controller is.
+00018f90: 2020 2020 2020 2020 2320 2020 6c61 756e          #   laun
+00018fa0: 6368 696e 6729 2c20 646f 6573 206e 6f74  ching), does not
+00018fb0: 206d 6174 7465 7220 6966 2072 6566 7265   matter if refre
+00018fc0: 7368 206f 7220 6e6f 742c 2073 696e 6365  sh or not, since
+00018fd0: 206e 6f20 6175 746f 7374 6f70 2e20 5765   no autostop. We
+00018fe0: 0a20 2020 2020 2020 2023 2020 2064 6f6e  .        #   don
+00018ff0: 2774 2069 6e63 6c75 6465 2055 5020 696e  't include UP in
+00019000: 2066 6f72 6365 5f72 6566 7265 7368 5f73   force_refresh_s
+00019010: 7461 7475 7365 7320 746f 2061 766f 6964  tatuses to avoid
+00019020: 206f 7665 7268 6561 6473 2e0a 2020 2020   overheads..    
+00019030: 2020 2020 2320 2a20 2849 4e49 542c 2061      # * (INIT, a
+00019040: 7574 6f73 746f 7020 7365 7429 0a20 2020  utostop set).   
+00019050: 2020 2020 2023 202a 2028 494e 4954 2c20       # * (INIT, 
+00019060: 6e6f 2061 7574 6f73 746f 7029 3a20 7665  no autostop): ve
+00019070: 7279 2072 6172 6520 285f 7570 6461 7465  ry rare (_update
+00019080: 5f63 6c75 7374 6572 5f73 7461 7475 735f  _cluster_status_
+00019090: 6e6f 5f6c 6f63 6b20 6d61 790a 2020 2020  no_lock may.    
+000190a0: 2020 2020 2320 2020 7265 7365 7420 6c6f      #   reset lo
+000190b0: 6361 6c20 6175 746f 7374 6f70 2063 6f6e  cal autostop con
+000190c0: 6669 6729 2c20 6275 7420 666f 7263 655f  fig), but force_
+000190d0: 7265 6672 6573 6820 7769 6c6c 206d 616b  refresh will mak
+000190e0: 6520 7375 7265 0a20 2020 2020 2020 2023  e sure.        #
+000190f0: 2020 2073 7461 7475 7320 6973 2072 6566     status is ref
+00019100: 7265 7368 6564 2e0a 2020 2020 2020 2020  reshed..        
+00019110: 230a 2020 2020 2020 2020 2320 5765 2061  #.        # We a
+00019120: 766f 6964 7320 756e 6e65 6365 7373 6172  voids unnecessar
+00019130: 7920 636f 7374 6c79 2072 6566 7265 7368  y costly refresh
+00019140: 2077 6865 6e20 7468 6520 636f 6e74 726f   when the contro
+00019150: 6c6c 6572 2069 7320 616c 7265 6164 790a  ller is already.
+00019160: 2020 2020 2020 2020 2320 5354 4f50 5045          # STOPPE
+00019170: 442e 2054 6869 7320 6f70 7469 6d69 7a61  D. This optimiza
+00019180: 7469 6f6e 2069 7320 6261 7365 6420 6f6e  tion is based on
+00019190: 2074 6865 2061 7373 756d 7074 696f 6e20   the assumption 
+000191a0: 7468 6174 2074 6865 2075 7365 720a 2020  that the user.  
+000191b0: 2020 2020 2020 2320 7769 6c6c 206e 6f74        # will not
+000191c0: 2073 7461 7274 2074 6865 2063 6f6e 7472   start the contr
+000191d0: 6f6c 6c65 7220 6d61 6e75 616c 6c79 2066  oller manually f
+000191e0: 726f 6d20 7468 6520 636c 6f75 6420 636f  rom the cloud co
+000191f0: 6e73 6f6c 652e 0a20 2020 2020 2020 2023  nsole..        #
+00019200: 0a20 2020 2020 2020 2023 2054 6865 2061  .        # The a
+00019210: 6371 7569 7265 5f6c 6f63 6b5f 7469 6d65  cquire_lock_time
+00019220: 6f75 7420 6973 2073 6574 2074 6f20 3020  out is set to 0 
+00019230: 746f 2061 766f 6964 2068 616e 6769 6e67  to avoid hanging
+00019240: 2074 6865 2063 6f6d 6d61 6e64 2077 6865   the command whe
+00019250: 6e0a 2020 2020 2020 2020 2320 6d75 6c74  n.        # mult
+00019260: 6970 6c65 206a 6f62 732e 6c61 756e 6368  iple jobs.launch
+00019270: 2063 6f6d 6d61 6e64 7320 6172 6520 7275   commands are ru
+00019280: 6e6e 696e 6720 6174 2074 6865 2073 616d  nning at the sam
+00019290: 6520 7469 6d65 2e20 4f75 7220 6c61 7465  e time. Our late
+000192a0: 720a 2020 2020 2020 2020 2320 636f 6465  r.        # code
+000192b0: 2077 696c 6c20 6368 6563 6b20 6966 2074   will check if t
+000192c0: 6865 2063 6f6e 7472 6f6c 6c65 7220 6973  he controller is
+000192d0: 2061 6363 6573 7369 626c 6520 6279 2064   accessible by d
+000192e0: 6972 6563 746c 7920 6368 6563 6b69 6e67  irectly checking
+000192f0: 0a20 2020 2020 2020 2023 2074 6865 2073  .        # the s
+00019300: 7368 2063 6f6e 6e65 6374 696f 6e20 746f  sh connection to
+00019310: 2074 6865 2063 6f6e 7472 6f6c 6c65 722c   the controller,
+00019320: 2069 6620 6974 2066 6169 6c73 2074 6f20   if it fails to 
+00019330: 6765 7420 6163 6375 7261 7465 0a20 2020  get accurate.   
+00019340: 2020 2020 2023 2073 7461 7475 7320 6f66       # status of
+00019350: 2074 6865 2063 6f6e 7472 6f6c 6c65 722e   the controller.
+00019360: 0a20 2020 2020 2020 2063 6f6e 7472 6f6c  .        control
+00019370: 6c65 725f 7374 6174 7573 2c20 6861 6e64  ler_status, hand
+00019380: 6c65 203d 2072 6566 7265 7368 5f63 6c75  le = refresh_clu
+00019390: 7374 6572 5f73 7461 7475 735f 6861 6e64  ster_status_hand
+000193a0: 6c65 280a 2020 2020 2020 2020 2020 2020  le(.            
+000193b0: 636c 7573 7465 725f 6e61 6d65 2c0a 2020  cluster_name,.  
+000193c0: 2020 2020 2020 2020 2020 666f 7263 655f            force_
+000193d0: 7265 6672 6573 685f 7374 6174 7573 6573  refresh_statuses
+000193e0: 3d5b 7374 6174 7573 5f6c 6962 2e43 6c75  =[status_lib.Clu
+000193f0: 7374 6572 5374 6174 7573 2e49 4e49 545d  sterStatus.INIT]
+00019400: 2c0a 2020 2020 2020 2020 2020 2020 636c  ,.            cl
+00019410: 7573 7465 725f 7374 6174 7573 5f6c 6f63  uster_status_loc
+00019420: 6b5f 7469 6d65 6f75 743d 3029 0a20 2020  k_timeout=0).   
+00019430: 2065 7863 6570 7420 6578 6365 7074 696f   except exceptio
+00019440: 6e73 2e43 6c75 7374 6572 5374 6174 7573  ns.ClusterStatus
+00019450: 4665 7463 6869 6e67 4572 726f 7220 6173  FetchingError as
+00019460: 2065 3a0a 2020 2020 2020 2020 2320 5765   e:.        # We
+00019470: 2064 6f20 6e6f 7420 6361 7463 6820 7468   do not catch th
+00019480: 6520 6578 6365 7074 696f 6e73 2072 656c  e exceptions rel
+00019490: 6174 6564 2074 6f20 7468 6520 636c 7573  ated to the clus
+000194a0: 7465 7220 6f77 6e65 7220 6964 656e 7469  ter owner identi
+000194b0: 7479 0a20 2020 2020 2020 2023 206d 6973  ty.        # mis
+000194c0: 6d61 7463 682c 2070 6c65 6173 6520 7265  match, please re
+000194d0: 6665 7220 746f 2074 6865 2063 6f6d 6d65  fer to the comme
+000194e0: 6e74 2069 6e0a 2020 2020 2020 2020 2320  nt in.        # 
+000194f0: 6062 6163 6b65 6e64 5f75 7469 6c73 2e63  `backend_utils.c
+00019500: 6865 636b 5f63 6c75 7374 6572 5f61 7661  heck_cluster_ava
+00019510: 696c 6162 6c65 602e 0a20 2020 2020 2020  ilable`..       
+00019520: 2063 6f6e 7472 6f6c 6c65 725f 6e61 6d65   controller_name
+00019530: 203d 2063 6f6e 7472 6f6c 6c65 722e 7661   = controller.va
+00019540: 6c75 652e 6e61 6d65 2e72 6570 6c61 6365  lue.name.replace
+00019550: 2827 2063 6f6e 7472 6f6c 6c65 7227 2c20  (' controller', 
+00019560: 2727 290a 2020 2020 2020 2020 6c6f 6767  '').        logg
+00019570: 6572 2e77 6172 6e69 6e67 280a 2020 2020  er.warning(.    
+00019580: 2020 2020 2020 2020 2746 6169 6c65 6420          'Failed 
+00019590: 746f 2067 6574 2074 6865 2073 7461 7475  to get the statu
+000195a0: 7320 6f66 2074 6865 2063 6f6e 7472 6f6c  s of the control
+000195b0: 6c65 722e 2049 7420 6973 206e 6f74 2027  ler. It is not '
+000195c0: 0a20 2020 2020 2020 2020 2020 2066 2766  .            f'f
+000195d0: 6174 616c 2c20 6275 7420 7b63 6f6e 7472  atal, but {contr
+000195e0: 6f6c 6c65 725f 6e61 6d65 7d20 636f 6d6d  oller_name} comm
+000195f0: 616e 6473 2f63 616c 6c73 206d 6179 2068  ands/calls may h
+00019600: 616e 6720 6f72 2072 6574 7572 6e20 270a  ang or return '.
+00019610: 2020 2020 2020 2020 2020 2020 2773 7461              'sta
+00019620: 6c65 2069 6e66 6f72 6d61 7469 6f6e 2c20  le information, 
+00019630: 7768 656e 2074 6865 2063 6f6e 7472 6f6c  when the control
+00019640: 6c65 7220 6973 206e 6f74 2075 702e 5c6e  ler is not up.\n
+00019650: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
+00019660: 2020 4465 7461 696c 733a 207b 636f 6d6d    Details: {comm
+00019670: 6f6e 5f75 7469 6c73 2e66 6f72 6d61 745f  on_utils.format_
+00019680: 6578 6365 7074 696f 6e28 652c 2075 7365  exception(e, use
+00019690: 5f62 7261 636b 6574 3d54 7275 6529 7d27  _bracket=True)}'
+000196a0: 290a 2020 2020 2020 2020 7265 636f 7264  ).        record
+000196b0: 203d 2067 6c6f 6261 6c5f 7573 6572 5f73   = global_user_s
+000196c0: 7461 7465 2e67 6574 5f63 6c75 7374 6572  tate.get_cluster
+000196d0: 5f66 726f 6d5f 6e61 6d65 2863 6c75 7374  _from_name(clust
+000196e0: 6572 5f6e 616d 6529 0a20 2020 2020 2020  er_name).       
+000196f0: 2069 6620 7265 636f 7264 2069 7320 6e6f   if record is no
+00019700: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00019710: 2020 2020 636f 6e74 726f 6c6c 6572 5f73      controller_s
+00019720: 7461 7475 732c 2068 616e 646c 6520 3d20  tatus, handle = 
+00019730: 7265 636f 7264 5b27 7374 6174 7573 275d  record['status']
+00019740: 2c20 7265 636f 7264 5b27 6861 6e64 6c65  , record['handle
+00019750: 275d 0a20 2020 2020 2020 2020 2020 2023  '].            #
+00019760: 2057 6520 6368 6563 6b20 7468 6520 636f   We check the co
+00019770: 6e6e 6563 7469 6f6e 2065 7665 6e20 6966  nnection even if
+00019780: 2074 6865 2063 6c75 7374 6572 2068 6173   the cluster has
+00019790: 2061 2063 6163 6865 6420 7374 6174 7573   a cached status
+000197a0: 2055 500a 2020 2020 2020 2020 2020 2020   UP.            
+000197b0: 2320 746f 206d 616b 6520 7375 7265 2074  # to make sure t
+000197c0: 6865 2063 6f6e 7472 6f6c 6c65 7220 6973  he controller is
+000197d0: 2061 6374 7561 6c6c 7920 6163 6365 7373   actually access
+000197e0: 6962 6c65 2c20 6173 2074 6865 2063 6163  ible, as the cac
+000197f0: 6865 640a 2020 2020 2020 2020 2020 2020  hed.            
+00019800: 2320 7374 6174 7573 206d 6967 6874 2062  # status might b
+00019810: 6520 7374 616c 652e 0a20 2020 2020 2020  e stale..       
+00019820: 2020 2020 206e 6565 645f 636f 6e6e 6563       need_connec
+00019830: 7469 6f6e 5f63 6865 636b 203d 2054 7275  tion_check = Tru
+00019840: 650a 0a20 2020 2065 7272 6f72 5f6d 7367  e..    error_msg
+00019850: 203d 204e 6f6e 650a 2020 2020 6966 2063   = None.    if c
+00019860: 6f6e 7472 6f6c 6c65 725f 7374 6174 7573  ontroller_status
+00019870: 203d 3d20 7374 6174 7573 5f6c 6962 2e43   == status_lib.C
+00019880: 6c75 7374 6572 5374 6174 7573 2e53 544f  lusterStatus.STO
+00019890: 5050 4544 3a0a 2020 2020 2020 2020 6572  PPED:.        er
+000198a0: 726f 725f 6d73 6720 3d20 7374 6f70 7065  ror_msg = stoppe
+000198b0: 645f 6d65 7373 6167 650a 2020 2020 656c  d_message.    el
+000198c0: 6966 2063 6f6e 7472 6f6c 6c65 725f 7374  if controller_st
+000198d0: 6174 7573 2069 7320 4e6f 6e65 206f 7220  atus is None or 
+000198e0: 6861 6e64 6c65 2069 7320 4e6f 6e65 206f  handle is None o
+000198f0: 7220 6861 6e64 6c65 2e68 6561 645f 6970  r handle.head_ip
+00019900: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00019910: 2020 2320 5765 2063 6865 636b 2074 6865    # We check the
+00019920: 2063 6f6e 7472 6f6c 6c65 7220 6973 2053   controller is S
+00019930: 544f 5050 4544 2062 6566 6f72 6520 7468  TOPPED before th
+00019940: 6520 6368 6563 6b20 666f 7220 6861 6e64  e check for hand
+00019950: 6c65 2e68 6561 645f 6970 0a20 2020 2020  le.head_ip.     
+00019960: 2020 2023 204e 6f6e 6520 6265 6361 7573     # None becaus
+00019970: 6520 7768 656e 2074 6865 2063 6f6e 7472  e when the contr
+00019980: 6f6c 6c65 7220 6973 2053 544f 5050 4544  oller is STOPPED
+00019990: 2c20 6861 6e64 6c65 2e68 6561 645f 6970  , handle.head_ip
+000199a0: 2063 616e 2061 6c73 6f0a 2020 2020 2020   can also.      
+000199b0: 2020 2320 6265 204e 6f6e 652c 2062 7574    # be None, but
+000199c0: 2077 6520 6f6e 6c79 2077 616e 7420 746f   we only want to
+000199d0: 2063 6174 6368 2074 6865 2063 6173 6520   catch the case 
+000199e0: 7768 656e 2074 6865 2063 6f6e 7472 6f6c  when the control
+000199f0: 6c65 7220 6973 0a20 2020 2020 2020 2023  ler is.        #
+00019a00: 2062 6569 6e67 2070 726f 7669 7369 6f6e   being provision
+00019a10: 6564 2061 7420 7468 6520 6669 7273 7420  ed at the first 
+00019a20: 7469 6d65 2061 6e64 2068 6176 6520 6e6f  time and have no
+00019a30: 2068 6561 645f 6970 2e0a 2020 2020 2020   head_ip..      
+00019a40: 2020 6572 726f 725f 6d73 6720 3d20 6e6f    error_msg = no
+00019a50: 6e5f 6578 6973 7465 6e74 5f6d 6573 7361  n_existent_messa
+00019a60: 6765 0a20 2020 2065 6c69 6620 2863 6f6e  ge.    elif (con
+00019a70: 7472 6f6c 6c65 725f 7374 6174 7573 203d  troller_status =
+00019a80: 3d20 7374 6174 7573 5f6c 6962 2e43 6c75  = status_lib.Clu
+00019a90: 7374 6572 5374 6174 7573 2e49 4e49 5420  sterStatus.INIT 
+00019aa0: 6f72 0a20 2020 2020 2020 2020 206e 6565  or.          nee
+00019ab0: 645f 636f 6e6e 6563 7469 6f6e 5f63 6865  d_connection_che
+00019ac0: 636b 293a 0a20 2020 2020 2020 2023 2043  ck):.        # C
+00019ad0: 6865 636b 2073 7368 2063 6f6e 6e65 6374  heck ssh connect
+00019ae0: 696f 6e20 6966 2028 3129 2063 6f6e 7472  ion if (1) contr
+00019af0: 6f6c 6c65 7220 6973 2069 6e20 494e 4954  oller is in INIT
+00019b00: 2073 7461 7465 2c20 6f72 2028 3229 2077   state, or (2) w
+00019b10: 6520 6661 696c 6564 2074 6f20 6665 7463  e failed to fetc
+00019b20: 6820 7468 650a 2020 2020 2020 2020 2320  h the.        # 
+00019b30: 7374 6174 7573 2c20 626f 7468 206f 6620  status, both of 
+00019b40: 7768 6963 6820 6361 6e20 6861 7070 656e  which can happen
+00019b50: 2077 6865 6e20 636f 6e74 726f 6c6c 6572   when controller
+00019b60: 2773 2073 7461 7475 7320 6c6f 636b 2069  's status lock i
+00019b70: 7320 6865 6c64 2062 7920 616e 6f74 6865  s held by anothe
+00019b80: 7220 6073 6b79 206a 6f62 7320 6c61 756e  r `sky jobs laun
+00019b90: 6368 6020 6f72 0a20 2020 2020 2020 2023  ch` or.        #
+00019ba0: 2060 736b 7920 7365 7276 6520 7570 602e   `sky serve up`.
+00019bb0: 2049 6620 7765 2068 6176 65c2 a063 6f6e   If we have..con
+00019bc0: 7472 6f6c 6c65 7227 7320 6865 6164 5f69  troller's head_i
+00019bd0: 7020 6176 6169 6c61 626c 6520 616e 6420  p available and 
+00019be0: 6974 2069 7320 7373 682d 7265 6163 6861  it is ssh-reacha
+00019bf0: 626c 652c 0a20 2020 2020 2020 2023 2077  ble,.        # w
+00019c00: 6520 6361 6e20 616c 6c6f 7720 6163 6365  e can allow acce
+00019c10: 7373 2074 6f20 7468 6520 636f 6e74 726f  ss to the contro
+00019c20: 6c6c 6572 2e0a 2020 2020 2020 2020 7373  ller..        ss
+00019c30: 685f 6372 6564 656e 7469 616c 7320 3d20  h_credentials = 
+00019c40: 7373 685f 6372 6564 656e 7469 616c 5f66  ssh_credential_f
+00019c50: 726f 6d5f 7961 6d6c 2868 616e 646c 652e  rom_yaml(handle.
+00019c60: 636c 7573 7465 725f 7961 6d6c 2c0a 2020  cluster_yaml,.  
+00019c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019ca0: 2068 616e 646c 652e 646f 636b 6572 5f75   handle.docker_u
+00019cb0: 7365 722c 0a20 2020 2020 2020 2020 2020  ser,.           
+00019cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019ce0: 2020 2020 2020 2020 6861 6e64 6c65 2e73          handle.s
+00019cf0: 7368 5f75 7365 7229 0a0a 2020 2020 2020  sh_user)..      
+00019d00: 2020 7275 6e6e 6572 203d 2063 6f6d 6d61    runner = comma
+00019d10: 6e64 5f72 756e 6e65 722e 5353 4843 6f6d  nd_runner.SSHCom
+00019d20: 6d61 6e64 5275 6e6e 6572 286e 6f64 653d  mandRunner(node=
+00019d30: 2868 616e 646c 652e 6865 6164 5f69 702c  (handle.head_ip,
+00019d40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019d70: 2020 2020 2020 2020 6861 6e64 6c65 2e68          handle.h
+00019d80: 6561 645f 7373 685f 706f 7274 292c 0a20  ead_ssh_port),. 
+00019d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00019da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019db0: 2863 6c75 7374 6572 5f6e 616d 6573 5b69  (cluster_names[i
-00019dc0: 5d2c 2075 7064 6174 6564 5f72 6563 6f72  ], updated_recor
-00019dd0: 6473 5b69 5d5b 2765 7272 6f72 275d 2929  ds[i]['error']))
-00019de0: 0a20 2020 2020 2020 2020 2020 2023 204b  .            # K
-00019df0: 6565 7020 7468 6520 6f72 6967 696e 616c  eep the original
-00019e00: 2072 6563 6f72 6420 6966 2074 6865 2073   record if the s
-00019e10: 7461 7475 7320 6973 2075 6e6b 6e6f 776e  tatus is unknown
-00019e20: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00019e30: 736f 2074 6861 7420 7468 6520 7573 6572  so that the user
-00019e40: 2063 616e 2073 7469 6c6c 2073 6565 2074   can still see t
-00019e50: 6865 2063 6c75 7374 6572 2e0a 2020 2020  he cluster..    
-00019e60: 2020 2020 2020 2020 6b65 7074 5f72 6563          kept_rec
-00019e70: 6f72 6473 2e61 7070 656e 6428 7265 636f  ords.append(reco
-00019e80: 7264 290a 2020 2020 2020 2020 656c 7365  rd).        else
-00019e90: 3a0a 2020 2020 2020 2020 2020 2020 6b65  :.            ke
-00019ea0: 7074 5f72 6563 6f72 6473 2e61 7070 656e  pt_records.appen
-00019eb0: 6428 7570 6461 7465 645f 7265 636f 7264  d(updated_record
-00019ec0: 735b 695d 290a 0a20 2020 2069 6620 6175  s[i])..    if au
-00019ed0: 746f 646f 776e 5f63 6c75 7374 6572 733a  todown_clusters:
-00019ee0: 0a20 2020 2020 2020 2070 6c75 7261 6c20  .        plural 
-00019ef0: 3d20 2773 2720 6966 206c 656e 2861 7574  = 's' if len(aut
-00019f00: 6f64 6f77 6e5f 636c 7573 7465 7273 2920  odown_clusters) 
-00019f10: 3e20 3120 656c 7365 2027 270a 2020 2020  > 1 else ''.    
-00019f20: 2020 2020 636c 7573 7465 725f 7374 7220      cluster_str 
-00019f30: 3d20 272c 2027 2e6a 6f69 6e28 6175 746f  = ', '.join(auto
-00019f40: 646f 776e 5f63 6c75 7374 6572 7329 0a20  down_clusters). 
-00019f50: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
-00019f60: 666f 2866 2741 7574 6f64 6f77 6e65 6420  fo(f'Autodowned 
-00019f70: 636c 7573 7465 727b 706c 7572 616c 7d3a  cluster{plural}:
-00019f80: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-00019f90: 2020 2020 2020 2066 277b 6272 6967 6874         f'{bright
-00019fa0: 7d7b 636c 7573 7465 725f 7374 727d 7b72  }{cluster_str}{r
-00019fb0: 6573 6574 7d27 290a 2020 2020 6966 2072  eset}').    if r
-00019fc0: 656d 6169 6e69 6e67 5f63 6c75 7374 6572  emaining_cluster
-00019fd0: 733a 0a20 2020 2020 2020 2070 6c75 7261  s:.        plura
-00019fe0: 6c20 3d20 2773 2720 6966 206c 656e 2872  l = 's' if len(r
-00019ff0: 656d 6169 6e69 6e67 5f63 6c75 7374 6572  emaining_cluster
-0001a000: 7329 203e 2031 2065 6c73 6520 2727 0a20  s) > 1 else ''. 
-0001a010: 2020 2020 2020 2063 6c75 7374 6572 5f73         cluster_s
-0001a020: 7472 203d 2027 2c20 272e 6a6f 696e 286e  tr = ', '.join(n
-0001a030: 616d 6520 666f 7220 6e61 6d65 2069 6e20  ame for name in 
-0001a040: 7265 6d61 696e 696e 675f 636c 7573 7465  remaining_cluste
-0001a050: 7273 290a 2020 2020 2020 2020 6c6f 6767  rs).        logg
-0001a060: 6572 2e77 6172 6e69 6e67 2866 277b 7965  er.warning(f'{ye
-0001a070: 6c6c 6f77 7d43 6c75 7374 6572 7b70 6c75  llow}Cluster{plu
-0001a080: 7261 6c7d 2074 6572 6d69 6e61 7465 6420  ral} terminated 
-0001a090: 6f6e 2027 0a20 2020 2020 2020 2020 2020  on '.           
-0001a0a0: 2020 2020 2020 2020 2020 2020 6627 7468              f'th
-0001a0b0: 6520 636c 6f75 643a 207b 7265 7365 747d  e cloud: {reset}
-0001a0c0: 7b62 7269 6768 747d 7b63 6c75 7374 6572  {bright}{cluster
-0001a0d0: 5f73 7472 7d7b 7265 7365 747d 2729 0a0a  _str}{reset}')..
-0001a0e0: 2020 2020 6966 2066 6169 6c65 645f 636c      if failed_cl
-0001a0f0: 7573 7465 7273 3a0a 2020 2020 2020 2020  usters:.        
-0001a100: 706c 7572 616c 203d 2027 7327 2069 6620  plural = 's' if 
-0001a110: 6c65 6e28 6661 696c 6564 5f63 6c75 7374  len(failed_clust
-0001a120: 6572 7329 203e 2031 2065 6c73 6520 2727  ers) > 1 else ''
-0001a130: 0a20 2020 2020 2020 206c 6f67 6765 722e  .        logger.
-0001a140: 7761 726e 696e 6728 6627 7b79 656c 6c6f  warning(f'{yello
-0001a150: 777d 4661 696c 6564 2074 6f20 7265 6672  w}Failed to refr
-0001a160: 6573 6820 7374 6174 7573 2066 6f72 2027  esh status for '
-0001a170: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001a180: 2020 2020 2020 2020 6627 7b6c 656e 2866          f'{len(f
-0001a190: 6169 6c65 645f 636c 7573 7465 7273 297d  ailed_clusters)}
-0001a1a0: 2063 6c75 7374 6572 7b70 6c75 7261 6c7d   cluster{plural}
-0001a1b0: 3a7b 7265 7365 747d 2729 0a20 2020 2020  :{reset}').     
-0001a1c0: 2020 2066 6f72 2063 6c75 7374 6572 5f6e     for cluster_n
-0001a1d0: 616d 652c 2065 2069 6e20 6661 696c 6564  ame, e in failed
-0001a1e0: 5f63 6c75 7374 6572 733a 0a20 2020 2020  _clusters:.     
-0001a1f0: 2020 2020 2020 206c 6f67 6765 722e 7761         logger.wa
-0001a200: 726e 696e 6728 6627 2020 7b62 7269 6768  rning(f'  {brigh
-0001a210: 747d 7b63 6c75 7374 6572 5f6e 616d 657d  t}{cluster_name}
-0001a220: 7b72 6573 6574 7d3a 207b 657d 2729 0a20  {reset}: {e}'). 
-0001a230: 2020 2072 6574 7572 6e20 6b65 7074 5f72     return kept_r
-0001a240: 6563 6f72 6473 0a0a 0a40 7479 7069 6e67  ecords...@typing
-0001a250: 2e6f 7665 726c 6f61 640a 6465 6620 6765  .overload.def ge
-0001a260: 745f 6261 636b 656e 645f 6672 6f6d 5f68  t_backend_from_h
-0001a270: 616e 646c 6528 0a20 2020 2068 616e 646c  andle(.    handl
-0001a280: 653a 2027 636c 6f75 645f 766d 5f72 6179  e: 'cloud_vm_ray
-0001a290: 5f62 6163 6b65 6e64 2e43 6c6f 7564 566d  _backend.CloudVm
-0001a2a0: 5261 7952 6573 6f75 7263 6548 616e 646c  RayResourceHandl
-0001a2b0: 6527 0a29 202d 3e20 2763 6c6f 7564 5f76  e'.) -> 'cloud_v
-0001a2c0: 6d5f 7261 795f 6261 636b 656e 642e 436c  m_ray_backend.Cl
-0001a2d0: 6f75 6456 6d52 6179 4261 636b 656e 6427  oudVmRayBackend'
-0001a2e0: 3a0a 2020 2020 2e2e 2e0a 0a0a 4074 7970  :.    ......@typ
-0001a2f0: 696e 672e 6f76 6572 6c6f 6164 0a64 6566  ing.overload.def
-0001a300: 2067 6574 5f62 6163 6b65 6e64 5f66 726f   get_backend_fro
-0001a310: 6d5f 6861 6e64 6c65 280a 2020 2020 6861  m_handle(.    ha
-0001a320: 6e64 6c65 3a20 276c 6f63 616c 5f64 6f63  ndle: 'local_doc
-0001a330: 6b65 725f 6261 636b 656e 642e 4c6f 6361  ker_backend.Loca
-0001a340: 6c44 6f63 6b65 7252 6573 6f75 7263 6548  lDockerResourceH
-0001a350: 616e 646c 6527 0a29 202d 3e20 276c 6f63  andle'.) -> 'loc
-0001a360: 616c 5f64 6f63 6b65 725f 6261 636b 656e  al_docker_backen
-0001a370: 642e 4c6f 6361 6c44 6f63 6b65 7242 6163  d.LocalDockerBac
-0001a380: 6b65 6e64 273a 0a20 2020 202e 2e2e 0a0a  kend':.    .....
-0001a390: 0a40 7479 7069 6e67 2e6f 7665 726c 6f61  .@typing.overloa
-0001a3a0: 640a 6465 6620 6765 745f 6261 636b 656e  d.def get_backen
-0001a3b0: 645f 6672 6f6d 5f68 616e 646c 6528 0a20  d_from_handle(. 
-0001a3c0: 2020 2020 2020 2068 616e 646c 653a 2062         handle: b
-0001a3d0: 6163 6b65 6e64 732e 5265 736f 7572 6365  ackends.Resource
-0001a3e0: 4861 6e64 6c65 2920 2d3e 2062 6163 6b65  Handle) -> backe
-0001a3f0: 6e64 732e 4261 636b 656e 643a 0a20 2020  nds.Backend:.   
-0001a400: 202e 2e2e 0a0a 0a64 6566 2067 6574 5f62   ......def get_b
-0001a410: 6163 6b65 6e64 5f66 726f 6d5f 6861 6e64  ackend_from_hand
-0001a420: 6c65 280a 2020 2020 2020 2020 6861 6e64  le(.        hand
-0001a430: 6c65 3a20 6261 636b 656e 6473 2e52 6573  le: backends.Res
-0001a440: 6f75 7263 6548 616e 646c 6529 202d 3e20  ourceHandle) -> 
-0001a450: 6261 636b 656e 6473 2e42 6163 6b65 6e64  backends.Backend
-0001a460: 3a0a 2020 2020 2222 2247 6574 7320 6120  :.    """Gets a 
-0001a470: 4261 636b 656e 6420 6f62 6a65 6374 2063  Backend object c
-0001a480: 6f72 7265 7370 6f6e 6469 6e67 2074 6f20  orresponding to 
-0001a490: 6120 6861 6e64 6c65 2e0a 0a20 2020 2049  a handle...    I
-0001a4a0: 6e73 7065 6374 7320 6861 6e64 6c65 2074  nspects handle t
-0001a4b0: 7970 6520 746f 2069 6e66 6572 2074 6865  ype to infer the
-0001a4c0: 2062 6163 6b65 6e64 2075 7365 6420 666f   backend used fo
-0001a4d0: 7220 7468 6520 7265 736f 7572 6365 2e0a  r the resource..
-0001a4e0: 2020 2020 2222 220a 2020 2020 6261 636b      """.    back
-0001a4f0: 656e 643a 2062 6163 6b65 6e64 732e 4261  end: backends.Ba
-0001a500: 636b 656e 640a 2020 2020 6966 2069 7369  ckend.    if isi
-0001a510: 6e73 7461 6e63 6528 6861 6e64 6c65 2c20  nstance(handle, 
-0001a520: 6261 636b 656e 6473 2e43 6c6f 7564 566d  backends.CloudVm
-0001a530: 5261 7952 6573 6f75 7263 6548 616e 646c  RayResourceHandl
-0001a540: 6529 3a0a 2020 2020 2020 2020 6261 636b  e):.        back
-0001a550: 656e 6420 3d20 6261 636b 656e 6473 2e43  end = backends.C
-0001a560: 6c6f 7564 566d 5261 7942 6163 6b65 6e64  loudVmRayBackend
-0001a570: 2829 0a20 2020 2065 6c69 6620 6973 696e  ().    elif isin
-0001a580: 7374 616e 6365 2868 616e 646c 652c 2062  stance(handle, b
-0001a590: 6163 6b65 6e64 732e 4c6f 6361 6c44 6f63  ackends.LocalDoc
-0001a5a0: 6b65 7252 6573 6f75 7263 6548 616e 646c  kerResourceHandl
-0001a5b0: 6529 3a0a 2020 2020 2020 2020 6261 636b  e):.        back
-0001a5c0: 656e 6420 3d20 6261 636b 656e 6473 2e4c  end = backends.L
-0001a5d0: 6f63 616c 446f 636b 6572 4261 636b 656e  ocalDockerBacken
-0001a5e0: 6428 290a 2020 2020 656c 7365 3a0a 2020  d().    else:.  
-0001a5f0: 2020 2020 2020 7261 6973 6520 4e6f 7449        raise NotI
-0001a600: 6d70 6c65 6d65 6e74 6564 4572 726f 7228  mplementedError(
-0001a610: 0a20 2020 2020 2020 2020 2020 2066 2748  .            f'H
-0001a620: 616e 646c 6520 7479 7065 207b 7479 7065  andle type {type
-0001a630: 2868 616e 646c 6529 7d20 6973 206e 6f74  (handle)} is not
-0001a640: 2073 7570 706f 7274 6564 2079 6574 2e27   supported yet.'
-0001a650: 290a 2020 2020 7265 7475 726e 2062 6163  ).    return bac
-0001a660: 6b65 6e64 0a0a 0a64 6566 2067 6574 5f74  kend...def get_t
-0001a670: 6173 6b5f 6465 6d61 6e64 735f 6469 6374  ask_demands_dict
-0001a680: 2874 6173 6b3a 2027 7461 736b 5f6c 6962  (task: 'task_lib
-0001a690: 2e54 6173 6b27 2920 2d3e 2044 6963 745b  .Task') -> Dict[
-0001a6a0: 7374 722c 2066 6c6f 6174 5d3a 0a20 2020  str, float]:.   
-0001a6b0: 2022 2222 5265 7475 726e 7320 7468 6520   """Returns the 
-0001a6c0: 7265 736f 7572 6365 7320 6469 6374 206f  resources dict o
-0001a6d0: 6620 7468 6520 7461 736b 2e0a 0a20 2020  f the task...   
-0001a6e0: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
-0001a6f0: 2020 4120 6469 6374 206f 6620 7468 6520    A dict of the 
-0001a700: 7265 736f 7572 6365 7320 6f66 2074 6865  resources of the
-0001a710: 2074 6173 6b2e 2054 6865 206b 6579 7320   task. The keys 
-0001a720: 6172 6520 7468 6520 7265 736f 7572 6365  are the resource
-0001a730: 206e 616d 6573 0a20 2020 2020 2020 2061   names.        a
-0001a740: 6e64 2074 6865 2076 616c 7565 7320 6172  nd the values ar
-0001a750: 6520 7468 6520 6e75 6d62 6572 206f 6620  e the number of 
-0001a760: 7468 6520 7265 736f 7572 6365 732e 2049  the resources. I
-0001a770: 7420 616c 7761 7973 2063 6f6e 7461 696e  t always contain
-0001a780: 730a 2020 2020 2020 2020 7468 6520 4350  s.        the CP
-0001a790: 5520 7265 736f 7572 6365 2028 746f 2063  U resource (to c
-0001a7a0: 6f6e 7472 6f6c 2074 6865 206d 6178 696d  ontrol the maxim
-0001a7b0: 756d 206e 756d 6265 7220 6f66 2074 6173  um number of tas
-0001a7c0: 6b73 292c 2061 6e64 0a20 2020 2020 2020  ks), and.       
-0001a7d0: 206f 7074 696f 6e61 6c6c 7920 6163 6365   optionally acce
-0001a7e0: 6c65 7261 746f 7220 6465 6d61 6e64 732e  lerator demands.
-0001a7f0: 0a20 2020 2022 2222 0a20 2020 2023 2054  .    """.    # T
-0001a800: 4f44 4f3a 2043 7573 746f 6d20 4350 5520  ODO: Custom CPU 
-0001a810: 616e 6420 6f74 6865 7220 6d65 6d6f 7279  and other memory
-0001a820: 2072 6573 6f75 7263 6573 2061 7265 206e   resources are n
-0001a830: 6f74 2073 7570 706f 7274 6564 2079 6574  ot supported yet
-0001a840: 2e0a 2020 2020 2320 466f 7220 736b 7920  ..    # For sky 
-0001a850: 7370 6f74 2f73 6572 7665 2063 6f6e 7472  spot/serve contr
-0001a860: 6f6c 6c65 7220 7461 736b 2c20 7765 2073  oller task, we s
-0001a870: 6574 2074 6865 2043 5055 2072 6573 6f75  et the CPU resou
-0001a880: 7263 6520 746f 2061 2073 6d61 6c6c 6572  rce to a smaller
-0001a890: 0a20 2020 2023 2076 616c 7565 2074 6f20  .    # value to 
-0001a8a0: 7375 7070 6f72 7420 6120 6c61 7267 6572  support a larger
-0001a8b0: 206e 756d 6265 7220 6f66 2073 706f 7420   number of spot 
-0001a8c0: 6a6f 6273 2061 6e64 2073 6572 7669 6365  jobs and service
-0001a8d0: 732e 0a20 2020 2072 6573 6f75 7263 6573  s..    resources
-0001a8e0: 5f64 6963 7420 3d20 7b0a 2020 2020 2020  _dict = {.      
-0001a8f0: 2020 2743 5055 273a 2028 636f 6e73 7461    'CPU': (consta
-0001a900: 6e74 732e 434f 4e54 524f 4c4c 4552 5f50  nts.CONTROLLER_P
-0001a910: 524f 4345 5353 5f43 5055 5f44 454d 414e  ROCESS_CPU_DEMAN
-0001a920: 440a 2020 2020 2020 2020 2020 2020 2020  D.              
-0001a930: 2020 6966 2074 6173 6b2e 6973 5f63 6f6e    if task.is_con
-0001a940: 7472 6f6c 6c65 725f 7461 736b 2829 2065  troller_task() e
-0001a950: 6c73 6520 4445 4641 554c 545f 5441 534b  lse DEFAULT_TASK
-0001a960: 5f43 5055 5f44 454d 414e 4429 0a20 2020  _CPU_DEMAND).   
-0001a970: 207d 0a20 2020 2069 6620 7461 736b 2e62   }.    if task.b
-0001a980: 6573 745f 7265 736f 7572 6365 7320 6973  est_resources is
-0001a990: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-0001a9a0: 2020 2072 6573 6f75 7263 6573 203d 2074     resources = t
-0001a9b0: 6173 6b2e 6265 7374 5f72 6573 6f75 7263  ask.best_resourc
-0001a9c0: 6573 0a20 2020 2065 6c73 653a 0a20 2020  es.    else:.   
-0001a9d0: 2020 2020 2023 2054 6173 6b20 6d61 7920       # Task may 
-0001a9e0: 2865 2e67 2e2c 2073 6b79 206c 6175 6e63  (e.g., sky launc
-0001a9f0: 6829 206f 7220 6d61 7920 6e6f 7420 2865  h) or may not (e
-0001aa00: 2e67 2e2c 2073 6b79 2065 7865 6329 2068  .g., sky exec) h
-0001aa10: 6176 6520 756e 6465 7267 6f6e 650a 2020  ave undergone.  
-0001aa20: 2020 2020 2020 2320 736b 792e 6f70 7469        # sky.opti
-0001aa30: 6d69 7a65 2829 2c20 736f 2062 6573 745f  mize(), so best_
-0001aa40: 7265 736f 7572 6365 7320 6d61 7920 6265  resources may be
-0001aa50: 204e 6f6e 652e 0a20 2020 2020 2020 2061   None..        a
-0001aa60: 7373 6572 7420 6c65 6e28 7461 736b 2e72  ssert len(task.r
-0001aa70: 6573 6f75 7263 6573 2920 3d3d 2031 2c20  esources) == 1, 
-0001aa80: 7461 736b 2e72 6573 6f75 7263 6573 0a20  task.resources. 
-0001aa90: 2020 2020 2020 2072 6573 6f75 7263 6573         resources
-0001aaa0: 203d 206c 6973 7428 7461 736b 2e72 6573   = list(task.res
-0001aab0: 6f75 7263 6573 295b 305d 0a20 2020 2069  ources)[0].    i
-0001aac0: 6620 7265 736f 7572 6365 7320 6973 206e  f resources is n
-0001aad0: 6f74 204e 6f6e 6520 616e 6420 7265 736f  ot None and reso
-0001aae0: 7572 6365 732e 6163 6365 6c65 7261 746f  urces.accelerato
-0001aaf0: 7273 2069 7320 6e6f 7420 4e6f 6e65 3a0a  rs is not None:.
-0001ab00: 2020 2020 2020 2020 7265 736f 7572 6365          resource
-0001ab10: 735f 6469 6374 2e75 7064 6174 6528 7265  s_dict.update(re
-0001ab20: 736f 7572 6365 732e 6163 6365 6c65 7261  sources.accelera
-0001ab30: 746f 7273 290a 2020 2020 7265 7475 726e  tors).    return
-0001ab40: 2072 6573 6f75 7263 6573 5f64 6963 740a   resources_dict.
-0001ab50: 0a0a 6465 6620 6765 745f 7461 736b 5f72  ..def get_task_r
-0001ab60: 6573 6f75 7263 6573 5f73 7472 2874 6173  esources_str(tas
-0001ab70: 6b3a 2027 7461 736b 5f6c 6962 2e54 6173  k: 'task_lib.Tas
-0001ab80: 6b27 2920 2d3e 2073 7472 3a0a 2020 2020  k') -> str:.    
-0001ab90: 2222 2252 6574 7572 6e73 2074 6865 2072  """Returns the r
-0001aba0: 6573 6f75 7263 6573 2073 7472 696e 6720  esources string 
-0001abb0: 6f66 2074 6865 2074 6173 6b2e 0a0a 2020  of the task...  
-0001abc0: 2020 5468 6520 7265 736f 7572 6365 7320    The resources 
-0001abd0: 7374 7269 6e67 2069 7320 6f6e 6c79 2075  string is only u
-0001abe0: 7365 6420 6173 2061 2064 6973 706c 6179  sed as a display
-0001abf0: 2070 7572 706f 7365 2c20 736f 2077 6520   purpose, so we 
-0001ac00: 6f6e 6c79 2073 686f 770a 2020 2020 7468  only show.    th
-0001ac10: 6520 6163 6365 6c65 7261 746f 7220 6465  e accelerator de
-0001ac20: 6d61 6e64 7320 2869 6620 616e 7929 2e20  mands (if any). 
-0001ac30: 4f74 6865 7277 6973 652c 2074 6865 2043  Otherwise, the C
-0001ac40: 5055 2064 656d 616e 6420 6973 2073 686f  PU demand is sho
-0001ac50: 776e 2e0a 2020 2020 2222 220a 2020 2020  wn..    """.    
-0001ac60: 7461 736b 5f63 7075 5f64 656d 616e 6420  task_cpu_demand 
-0001ac70: 3d20 2863 6f6e 7374 616e 7473 2e43 4f4e  = (constants.CON
-0001ac80: 5452 4f4c 4c45 525f 5052 4f43 4553 535f  TROLLER_PROCESS_
-0001ac90: 4350 555f 4445 4d41 4e44 2069 660a 2020  CPU_DEMAND if.  
-0001aca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001acb0: 2020 2020 2074 6173 6b2e 6973 5f63 6f6e       task.is_con
-0001acc0: 7472 6f6c 6c65 725f 7461 736b 2829 2065  troller_task() e
-0001acd0: 6c73 6520 4445 4641 554c 545f 5441 534b  lse DEFAULT_TASK
-0001ace0: 5f43 5055 5f44 454d 414e 4429 0a20 2020  _CPU_DEMAND).   
-0001acf0: 2069 6620 7461 736b 2e62 6573 745f 7265   if task.best_re
-0001ad00: 736f 7572 6365 7320 6973 206e 6f74 204e  sources is not N
-0001ad10: 6f6e 653a 0a20 2020 2020 2020 2061 6363  one:.        acc
-0001ad20: 656c 6572 6174 6f72 5f64 6963 7420 3d20  elerator_dict = 
-0001ad30: 7461 736b 2e62 6573 745f 7265 736f 7572  task.best_resour
-0001ad40: 6365 732e 6163 6365 6c65 7261 746f 7273  ces.accelerators
-0001ad50: 0a20 2020 2020 2020 2069 6620 6163 6365  .        if acce
-0001ad60: 6c65 7261 746f 725f 6469 6374 2069 7320  lerator_dict is 
-0001ad70: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0001ad80: 2020 7265 736f 7572 6365 735f 7374 7220    resources_str 
-0001ad90: 3d20 6627 4350 553a 7b74 6173 6b5f 6370  = f'CPU:{task_cp
-0001ada0: 755f 6465 6d61 6e64 7d27 0a20 2020 2020  u_demand}'.     
-0001adb0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0001adc0: 2020 2020 2072 6573 6f75 7263 6573 5f73       resources_s
-0001add0: 7472 203d 2027 2c20 272e 6a6f 696e 280a  tr = ', '.join(.
-0001ade0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001adf0: 6627 7b6b 7d3a 7b76 7d27 2066 6f72 206b  f'{k}:{v}' for k
-0001ae00: 2c20 7620 696e 2061 6363 656c 6572 6174  , v in accelerat
-0001ae10: 6f72 5f64 6963 742e 6974 656d 7328 2929  or_dict.items())
-0001ae20: 0a20 2020 2065 6c69 6620 6c65 6e28 7461  .    elif len(ta
-0001ae30: 736b 2e72 6573 6f75 7263 6573 2920 3d3d  sk.resources) ==
-0001ae40: 2031 3a0a 2020 2020 2020 2020 7265 736f   1:.        reso
-0001ae50: 7572 6365 735f 6469 6374 203d 206c 6973  urces_dict = lis
-0001ae60: 7428 7461 736b 2e72 6573 6f75 7263 6573  t(task.resources
-0001ae70: 295b 305d 2e61 6363 656c 6572 6174 6f72  )[0].accelerator
-0001ae80: 730a 2020 2020 2020 2020 6966 2072 6573  s.        if res
-0001ae90: 6f75 7263 6573 5f64 6963 7420 6973 204e  ources_dict is N
-0001aea0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0001aeb0: 2072 6573 6f75 7263 6573 5f73 7472 203d   resources_str =
-0001aec0: 2066 2743 5055 3a7b 7461 736b 5f63 7075   f'CPU:{task_cpu
-0001aed0: 5f64 656d 616e 647d 270a 2020 2020 2020  _demand}'.      
-0001aee0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001aef0: 2020 2020 7265 736f 7572 6365 735f 7374      resources_st
-0001af00: 7220 3d20 272c 2027 2e6a 6f69 6e28 0a20  r = ', '.join(. 
-0001af10: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0001af20: 277b 6b7d 3a7b 767d 2720 666f 7220 6b2c  '{k}:{v}' for k,
-0001af30: 2076 2069 6e20 7265 736f 7572 6365 735f   v in resources_
-0001af40: 6469 6374 2e69 7465 6d73 2829 290a 2020  dict.items()).  
-0001af50: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001af60: 7265 736f 7572 6365 5f61 6363 656c 6572  resource_acceler
-0001af70: 6174 6f72 7320 3d20 5b5d 0a20 2020 2020  ators = [].     
-0001af80: 2020 2066 6f72 2072 6573 6f75 7263 6520     for resource 
-0001af90: 696e 2074 6173 6b2e 7265 736f 7572 6365  in task.resource
-0001afa0: 733a 0a20 2020 2020 2020 2020 2020 2069  s:.            i
-0001afb0: 6620 7265 736f 7572 6365 2e61 6363 656c  f resource.accel
-0001afc0: 6572 6174 6f72 7320 6973 204e 6f6e 653a  erators is None:
-0001afd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001afe0: 2063 6f6e 7469 6e75 650a 2020 2020 2020   continue.      
-0001aff0: 2020 2020 2020 666f 7220 6b2c 2076 2069        for k, v i
-0001b000: 6e20 7265 736f 7572 6365 2e61 6363 656c  n resource.accel
-0001b010: 6572 6174 6f72 732e 6974 656d 7328 293a  erators.items():
-0001b020: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b030: 2072 6573 6f75 7263 655f 6163 6365 6c65   resource_accele
-0001b040: 7261 746f 7273 2e61 7070 656e 6428 6627  rators.append(f'
-0001b050: 7b6b 7d3a 7b76 7d27 290a 0a20 2020 2020  {k}:{v}')..     
-0001b060: 2020 2069 6620 7265 736f 7572 6365 5f61     if resource_a
-0001b070: 6363 656c 6572 6174 6f72 733a 0a20 2020  ccelerators:.   
-0001b080: 2020 2020 2020 2020 2072 6573 6f75 7263           resourc
-0001b090: 6573 5f73 7472 203d 2027 2c20 272e 6a6f  es_str = ', '.jo
-0001b0a0: 696e 2873 6574 2872 6573 6f75 7263 655f  in(set(resource_
-0001b0b0: 6163 6365 6c65 7261 746f 7273 2929 0a20  accelerators)). 
-0001b0c0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0001b0d0: 2020 2020 2020 2020 2072 6573 6f75 7263           resourc
-0001b0e0: 6573 5f73 7472 203d 2066 2743 5055 3a7b  es_str = f'CPU:{
-0001b0f0: 7461 736b 5f63 7075 5f64 656d 616e 647d  task_cpu_demand}
-0001b100: 270a 2020 2020 7265 736f 7572 6365 735f  '.    resources_
-0001b110: 7374 7220 3d20 6627 7b74 6173 6b2e 6e75  str = f'{task.nu
-0001b120: 6d5f 6e6f 6465 737d 7820 5b7b 7265 736f  m_nodes}x [{reso
-0001b130: 7572 6365 735f 7374 727d 5d27 0a20 2020  urces_str}]'.   
-0001b140: 2072 6574 7572 6e20 7265 736f 7572 6365   return resource
-0001b150: 735f 7374 720a 0a0a 2320 4861 6e64 6c65  s_str...# Handle
-0001b160: 2063 7472 6c2d 630a 6465 6620 696e 7465   ctrl-c.def inte
-0001b170: 7272 7570 745f 6861 6e64 6c65 7228 7369  rrupt_handler(si
-0001b180: 676e 756d 2c20 6672 616d 6529 3a0a 2020  gnum, frame):.  
-0001b190: 2020 6465 6c20 7369 676e 756d 2c20 6672    del signum, fr
-0001b1a0: 616d 650a 2020 2020 7375 6270 726f 6365  ame.    subproce
-0001b1b0: 7373 5f75 7469 6c73 2e6b 696c 6c5f 6368  ss_utils.kill_ch
-0001b1c0: 696c 6472 656e 5f70 726f 6365 7373 6573  ildren_processes
-0001b1d0: 2829 0a20 2020 2023 2041 766f 6964 2075  ().    # Avoid u
-0001b1e0: 7369 6e67 206c 6f67 6765 7220 6865 7265  sing logger here
-0001b1f0: 2c20 6173 2069 7420 7769 6c6c 2070 7269  , as it will pri
-0001b200: 6e74 2074 6865 2073 7461 636b 2074 7261  nt the stack tra
-0001b210: 6365 2066 6f72 2062 726f 6b65 6e0a 2020  ce for broken.  
-0001b220: 2020 2320 7069 7065 2c20 7768 656e 2074    # pipe, when t
-0001b230: 6865 206f 7574 7075 7420 6973 2070 6970  he output is pip
-0001b240: 6564 2074 6f20 616e 6f74 6865 7220 7072  ed to another pr
-0001b250: 6f67 7261 6d2e 0a20 2020 2070 7269 6e74  ogram..    print
-0001b260: 2866 277b 636f 6c6f 7261 6d61 2e53 7479  (f'{colorama.Sty
-0001b270: 6c65 2e44 494d 7d54 6970 3a20 5468 6520  le.DIM}Tip: The 
-0001b280: 6a6f 6220 7769 6c6c 206b 6565 7020 270a  job will keep '.
-0001b290: 2020 2020 2020 2020 2020 6627 7275 6e6e            f'runn
-0001b2a0: 696e 6720 6166 7465 7220 4374 726c 2d43  ing after Ctrl-C
-0001b2b0: 2e7b 636f 6c6f 7261 6d61 2e53 7479 6c65  .{colorama.Style
-0001b2c0: 2e52 4553 4554 5f41 4c4c 7d27 290a 2020  .RESET_ALL}').  
-0001b2d0: 2020 7769 7468 2075 785f 7574 696c 732e    with ux_utils.
-0001b2e0: 7072 696e 745f 6578 6365 7074 696f 6e5f  print_exception_
-0001b2f0: 6e6f 5f74 7261 6365 6261 636b 2829 3a0a  no_traceback():.
-0001b300: 2020 2020 2020 2020 7261 6973 6520 4b65          raise Ke
-0001b310: 7962 6f61 7264 496e 7465 7272 7570 7428  yboardInterrupt(
-0001b320: 6578 6365 7074 696f 6e73 2e4b 4559 424f  exceptions.KEYBO
-0001b330: 4152 445f 494e 5445 5252 5550 545f 434f  ARD_INTERRUPT_CO
-0001b340: 4445 290a 0a0a 2320 4861 6e64 6c65 2063  DE)...# Handle c
-0001b350: 7472 6c2d 7a0a 6465 6620 7374 6f70 5f68  trl-z.def stop_h
-0001b360: 616e 646c 6572 2873 6967 6e75 6d2c 2066  andler(signum, f
-0001b370: 7261 6d65 293a 0a20 2020 2064 656c 2073  rame):.    del s
-0001b380: 6967 6e75 6d2c 2066 7261 6d65 0a20 2020  ignum, frame.   
-0001b390: 2073 7562 7072 6f63 6573 735f 7574 696c   subprocess_util
-0001b3a0: 732e 6b69 6c6c 5f63 6869 6c64 7265 6e5f  s.kill_children_
-0001b3b0: 7072 6f63 6573 7365 7328 290a 2020 2020  processes().    
-0001b3c0: 2320 4176 6f69 6420 7573 696e 6720 6c6f  # Avoid using lo
-0001b3d0: 6767 6572 2068 6572 652c 2061 7320 6974  gger here, as it
-0001b3e0: 2077 696c 6c20 7072 696e 7420 7468 6520   will print the 
-0001b3f0: 7374 6163 6b20 7472 6163 6520 666f 7220  stack trace for 
-0001b400: 6272 6f6b 656e 0a20 2020 2023 2070 6970  broken.    # pip
-0001b410: 652c 2077 6865 6e20 7468 6520 6f75 7470  e, when the outp
-0001b420: 7574 2069 7320 7069 7065 6420 746f 2061  ut is piped to a
-0001b430: 6e6f 7468 6572 2070 726f 6772 616d 2e0a  nother program..
-0001b440: 2020 2020 7072 696e 7428 6627 7b63 6f6c      print(f'{col
-0001b450: 6f72 616d 612e 5374 796c 652e 4449 4d7d  orama.Style.DIM}
-0001b460: 5469 703a 2054 6865 206a 6f62 2077 696c  Tip: The job wil
-0001b470: 6c20 6b65 6570 2027 0a20 2020 2020 2020  l keep '.       
-0001b480: 2020 2066 2772 756e 6e69 6e67 2061 6674     f'running aft
-0001b490: 6572 2043 7472 6c2d 5a2e 7b63 6f6c 6f72  er Ctrl-Z.{color
-0001b4a0: 616d 612e 5374 796c 652e 5245 5345 545f  ama.Style.RESET_
-0001b4b0: 414c 4c7d 2729 0a20 2020 2077 6974 6820  ALL}').    with 
-0001b4c0: 7578 5f75 7469 6c73 2e70 7269 6e74 5f65  ux_utils.print_e
-0001b4d0: 7863 6570 7469 6f6e 5f6e 6f5f 7472 6163  xception_no_trac
-0001b4e0: 6562 6163 6b28 293a 0a20 2020 2020 2020  eback():.       
-0001b4f0: 2072 6169 7365 204b 6579 626f 6172 6449   raise KeyboardI
-0001b500: 6e74 6572 7275 7074 2865 7863 6570 7469  nterrupt(excepti
-0001b510: 6f6e 732e 5349 4754 5354 505f 434f 4445  ons.SIGTSTP_CODE
-0001b520: 290a 0a0a 6465 6620 6368 6563 6b5f 7075  )...def check_pu
-0001b530: 626c 6963 5f63 6c6f 7564 5f65 6e61 626c  blic_cloud_enabl
-0001b540: 6564 2829 3a0a 2020 2020 2222 2243 6865  ed():.    """Che
-0001b550: 636b 7320 6966 2061 6e79 206f 6620 7468  cks if any of th
-0001b560: 6520 7075 626c 6963 2063 6c6f 7564 7320  e public clouds 
-0001b570: 6973 2065 6e61 626c 6564 2e0a 0a20 2020  is enabled...   
-0001b580: 2045 7863 6570 7469 6f6e 733a 0a20 2020   Exceptions:.   
-0001b590: 2020 2020 2065 7863 6570 7469 6f6e 732e       exceptions.
-0001b5a0: 4e6f 436c 6f75 6441 6363 6573 7345 7272  NoCloudAccessErr
-0001b5b0: 6f72 3a20 6966 206e 6f20 7075 626c 6963  or: if no public
-0001b5c0: 2063 6c6f 7564 2069 7320 656e 6162 6c65   cloud is enable
-0001b5d0: 642e 0a20 2020 2022 2222 0a20 2020 2069  d..    """.    i
-0001b5e0: 6620 676c 6f62 616c 5f75 7365 725f 7374  f global_user_st
-0001b5f0: 6174 652e 6765 745f 656e 6162 6c65 645f  ate.get_enabled_
-0001b600: 636c 6f75 6473 2829 3a0a 2020 2020 2020  clouds():.      
-0001b610: 2020 7265 7475 726e 0a0a 2020 2020 736b    return..    sk
-0001b620: 795f 6368 6563 6b2e 6368 6563 6b28 7175  y_check.check(qu
-0001b630: 6965 743d 5472 7565 290a 2020 2020 6966  iet=True).    if
-0001b640: 206e 6f74 2067 6c6f 6261 6c5f 7573 6572   not global_user
-0001b650: 5f73 7461 7465 2e67 6574 5f65 6e61 626c  _state.get_enabl
-0001b660: 6564 5f63 6c6f 7564 7328 293a 0a20 2020  ed_clouds():.   
-0001b670: 2020 2020 2077 6974 6820 7578 5f75 7469       with ux_uti
-0001b680: 6c73 2e70 7269 6e74 5f65 7863 6570 7469  ls.print_excepti
-0001b690: 6f6e 5f6e 6f5f 7472 6163 6562 6163 6b28  on_no_traceback(
-0001b6a0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-0001b6b0: 6169 7365 2065 7863 6570 7469 6f6e 732e  aise exceptions.
-0001b6c0: 4e6f 436c 6f75 6441 6363 6573 7345 7272  NoCloudAccessErr
-0001b6d0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-0001b6e0: 2020 2020 2743 6c6f 7564 2061 6363 6573      'Cloud acces
-0001b6f0: 7320 6973 206e 6f74 2073 6574 2075 702e  s is not set up.
-0001b700: 2052 756e 3a20 270a 2020 2020 2020 2020   Run: '.        
-0001b710: 2020 2020 2020 2020 6627 7b63 6f6c 6f72          f'{color
-0001b720: 616d 612e 5374 796c 652e 4252 4947 4854  ama.Style.BRIGHT
-0001b730: 7d73 6b79 2063 6865 636b 7b63 6f6c 6f72  }sky check{color
-0001b740: 616d 612e 5374 796c 652e 5245 5345 545f  ama.Style.RESET_
-0001b750: 414c 4c7d 2729 0a0a 0a64 6566 2072 756e  ALL}')...def run
-0001b760: 5f63 6f6d 6d61 6e64 5f61 6e64 5f68 616e  _command_and_han
-0001b770: 646c 655f 7373 685f 6661 696c 7572 6528  dle_ssh_failure(
-0001b780: 7275 6e6e 6572 3a20 636f 6d6d 616e 645f  runner: command_
-0001b790: 7275 6e6e 6572 2e53 5348 436f 6d6d 616e  runner.SSHComman
-0001b7a0: 6452 756e 6e65 722c 0a20 2020 2020 2020  dRunner,.       
-0001b7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b7d0: 636f 6d6d 616e 643a 2073 7472 2c0a 2020  command: str,.  
-0001b7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b800: 2020 2020 2066 6169 6c75 7265 5f6d 6573       failure_mes
-0001b810: 7361 6765 3a20 7374 7229 202d 3e20 7374  sage: str) -> st
-0001b820: 723a 0a20 2020 2022 2222 5275 6e73 2063  r:.    """Runs c
-0001b830: 6f6d 6d61 6e64 2072 656d 6f74 656c 7920  ommand remotely 
-0001b840: 616e 6420 7265 7475 726e 7320 6f75 7470  and returns outp
-0001b850: 7574 2077 6974 6820 7072 6f70 6572 2065  ut with proper e
-0001b860: 7272 6f72 2068 616e 646c 696e 672e 2222  rror handling.""
-0001b870: 220a 2020 2020 7263 2c20 7374 646f 7574  ".    rc, stdout
-0001b880: 2c20 7374 6465 7272 203d 2072 756e 6e65  , stderr = runne
-0001b890: 722e 7275 6e28 636f 6d6d 616e 642c 0a20  r.run(command,. 
-0001b8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b8c0: 2020 2072 6571 7569 7265 5f6f 7574 7075     require_outpu
-0001b8d0: 7473 3d54 7275 652c 0a20 2020 2020 2020  ts=True,.       
-0001b8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b8f0: 2020 2020 2020 2020 2020 2020 2073 7472               str
-0001b900: 6561 6d5f 6c6f 6773 3d46 616c 7365 290a  eam_logs=False).
-0001b910: 2020 2020 6966 2072 6320 3d3d 2032 3535      if rc == 255
-0001b920: 3a0a 2020 2020 2020 2020 2320 5353 4820  :.        # SSH 
-0001b930: 6661 696c 6564 0a20 2020 2020 2020 2072  failed.        r
-0001b940: 6169 7365 2052 756e 7469 6d65 4572 726f  aise RuntimeErro
-0001b950: 7228 0a20 2020 2020 2020 2020 2020 2066  r(.            f
-0001b960: 2753 5348 2077 6974 6820 7573 6572 207b  'SSH with user {
-0001b970: 7275 6e6e 6572 2e73 7368 5f75 7365 727d  runner.ssh_user}
-0001b980: 2061 6e64 206b 6579 207b 7275 6e6e 6572   and key {runner
-0001b990: 2e73 7368 5f70 7269 7661 7465 5f6b 6579  .ssh_private_key
-0001b9a0: 7d20 270a 2020 2020 2020 2020 2020 2020  } '.            
-0001b9b0: 6627 746f 207b 7275 6e6e 6572 2e69 707d  f'to {runner.ip}
-0001b9c0: 2066 6169 6c65 642e 2054 6869 7320 6973   failed. This is
-0001b9d0: 206d 6f73 7420 6c69 6b65 6c79 2064 7565   most likely due
-0001b9e0: 2074 6f20 696e 636f 7272 6563 7420 270a   to incorrect '.
-0001b9f0: 2020 2020 2020 2020 2020 2020 2763 7265              'cre
-0001ba00: 6465 6e74 6961 6c73 206f 7220 696e 636f  dentials or inco
-0001ba10: 7272 6563 7420 7065 726d 6973 7369 6f6e  rrect permission
-0001ba20: 7320 666f 7220 7468 6520 6b65 7920 6669  s for the key fi
-0001ba30: 6c65 2e20 4368 6563 6b20 270a 2020 2020  le. Check '.    
-0001ba40: 2020 2020 2020 2020 2779 6f75 7220 6372          'your cr
-0001ba50: 6564 656e 7469 616c 7320 616e 6420 7472  edentials and tr
-0001ba60: 7920 6167 6169 6e2e 2729 0a20 2020 2073  y again.').    s
-0001ba70: 7562 7072 6f63 6573 735f 7574 696c 732e  ubprocess_utils.
-0001ba80: 6861 6e64 6c65 5f72 6574 7572 6e63 6f64  handle_returncod
-0001ba90: 6528 7263 2c0a 2020 2020 2020 2020 2020  e(rc,.          
-0001baa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bab0: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
-0001bac0: 6d61 6e64 2c0a 2020 2020 2020 2020 2020  mand,.          
-0001bad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bae0: 2020 2020 2020 2020 2020 2020 2066 6169               fai
-0001baf0: 6c75 7265 5f6d 6573 7361 6765 2c0a 2020  lure_message,.  
-0001bb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bb20: 2020 2020 2073 7464 6572 723d 7374 6465       stderr=stde
-0001bb30: 7272 290a 2020 2020 7265 7475 726e 2073  rr).    return s
-0001bb40: 7464 6f75 740a 0a0a 6465 6620 6368 6563  tdout...def chec
-0001bb50: 6b5f 7273 796e 635f 696e 7374 616c 6c65  k_rsync_installe
-0001bb60: 6428 2920 2d3e 204e 6f6e 653a 0a20 2020  d() -> None:.   
-0001bb70: 2022 2222 4368 6563 6b73 2069 6620 7273   """Checks if rs
-0001bb80: 796e 6320 6973 2069 6e73 7461 6c6c 6564  ync is installed
-0001bb90: 2e0a 0a20 2020 2052 6169 7365 733a 0a20  ...    Raises:. 
-0001bba0: 2020 2020 2020 2052 756e 7469 6d65 4572         RuntimeEr
-0001bbb0: 726f 723a 2069 6620 7273 796e 6320 6973  ror: if rsync is
-0001bbc0: 206e 6f74 2069 6e73 7461 6c6c 6564 2069   not installed i
-0001bbd0: 6e20 7468 6520 6d61 6368 696e 652e 0a20  n the machine.. 
-0001bbe0: 2020 2022 2222 0a20 2020 2074 7279 3a0a     """.    try:.
-0001bbf0: 2020 2020 2020 2020 7375 6270 726f 6365          subproce
-0001bc00: 7373 2e72 756e 2827 7273 796e 6320 2d2d  ss.run('rsync --
-0001bc10: 7665 7273 696f 6e27 2c0a 2020 2020 2020  version',.      
-0001bc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bc30: 2073 6865 6c6c 3d54 7275 652c 0a20 2020   shell=True,.   
-0001bc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bc50: 2020 2020 6368 6563 6b3d 5472 7565 2c0a      check=True,.
-0001bc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bc70: 2020 2020 2020 2073 7464 6f75 743d 7375         stdout=su
-0001bc80: 6270 726f 6365 7373 2e50 4950 452c 0a20  bprocess.PIPE,. 
-0001bc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bca0: 2020 2020 2020 7374 6465 7272 3d73 7562        stderr=sub
-0001bcb0: 7072 6f63 6573 732e 5049 5045 290a 2020  process.PIPE).  
-0001bcc0: 2020 6578 6365 7074 2073 7562 7072 6f63    except subproc
-0001bcd0: 6573 732e 4361 6c6c 6564 5072 6f63 6573  ess.CalledProces
-0001bce0: 7345 7272 6f72 3a0a 2020 2020 2020 2020  sError:.        
-0001bcf0: 7769 7468 2075 785f 7574 696c 732e 7072  with ux_utils.pr
-0001bd00: 696e 745f 6578 6365 7074 696f 6e5f 6e6f  int_exception_no
-0001bd10: 5f74 7261 6365 6261 636b 2829 3a0a 2020  _traceback():.  
-0001bd20: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0001bd30: 5275 6e74 696d 6545 7272 6f72 280a 2020  RuntimeError(.  
-0001bd40: 2020 2020 2020 2020 2020 2020 2020 2760                '`
-0001bd50: 7273 796e 6360 2069 7320 7265 7175 6972  rsync` is requir
-0001bd60: 6564 2066 6f72 2070 726f 7669 7369 6f6e  ed for provision
-0001bd70: 696e 6720 616e 6427 0a20 2020 2020 2020  ing and'.       
-0001bd80: 2020 2020 2020 2020 2027 2069 7420 6973           ' it is
-0001bd90: 206e 6f74 2069 6e73 7461 6c6c 6564 2e20   not installed. 
-0001bda0: 466f 7220 4465 6269 616e 2f55 6275 6e74  For Debian/Ubunt
-0001bdb0: 7520 7379 7374 656d 2c20 270a 2020 2020  u system, '.    
-0001bdc0: 2020 2020 2020 2020 2020 2020 2769 6e73              'ins
-0001bdd0: 7461 6c6c 2069 7420 7769 7468 3a5c 6e27  tall it with:\n'
-0001bde0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001bdf0: 2027 2020 2420 7375 646f 2061 7074 2069   '  $ sudo apt i
-0001be00: 6e73 7461 6c6c 2072 7379 6e63 2729 2066  nstall rsync') f
-0001be10: 726f 6d20 4e6f 6e65 0a0a 0a64 6566 2063  rom None...def c
-0001be20: 6865 636b 5f73 7461 6c65 5f72 756e 7469  heck_stale_runti
-0001be30: 6d65 5f6f 6e5f 7265 6d6f 7465 2872 6574  me_on_remote(ret
-0001be40: 7572 6e63 6f64 653a 2069 6e74 2c20 7374  urncode: int, st
-0001be50: 6465 7272 3a20 7374 722c 0a20 2020 2020  derr: str,.     
-0001be60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001be70: 2020 2020 2020 2020 2020 2020 2063 6c75               clu
-0001be80: 7374 6572 5f6e 616d 653a 2073 7472 2920  ster_name: str) 
-0001be90: 2d3e 204e 6f6e 653a 0a20 2020 2022 2222  -> None:.    """
-0001bea0: 5261 6973 6573 2052 756e 7469 6d65 4572  Raises RuntimeEr
-0001beb0: 726f 7220 6966 2072 656d 6f74 6520 536b  ror if remote Sk
-0001bec0: 7950 696c 6f74 2072 756e 7469 6d65 206e  yPilot runtime n
-0001bed0: 6565 6473 2074 6f20 6265 2075 7064 6174  eeds to be updat
-0001bee0: 6564 2e0a 0a20 2020 2057 6520 6465 7465  ed...    We dete
-0001bef0: 6374 2074 6869 7320 6279 2070 6172 7369  ct this by parsi
-0001bf00: 6e67 2063 6572 7461 696e 2062 6163 6b77  ng certain backw
-0001bf10: 6172 642d 696e 636f 6d70 6174 6962 6c65  ard-incompatible
-0001bf20: 2065 7272 6f72 206d 6573 7361 6765 7320   error messages 
-0001bf30: 6672 6f6d 0a20 2020 2060 7374 6465 7272  from.    `stderr
-0001bf40: 602e 2054 7970 6963 616c 6c79 2064 7565  `. Typically due
-0001bf50: 2074 6f20 7468 6520 6c6f 6361 6c20 636c   to the local cl
-0001bf60: 6965 6e74 2076 6572 7369 6f6e 206a 7573  ient version jus
-0001bf70: 7420 676f 7420 7570 6461 7465 642c 2061  t got updated, a
-0001bf80: 6e64 0a20 2020 2074 6865 2072 656d 6f74  nd.    the remot
-0001bf90: 6520 7275 6e74 696d 6520 6973 2061 6e20  e runtime is an 
-0001bfa0: 6f6c 6465 7220 7665 7273 696f 6e2e 0a20  older version.. 
-0001bfb0: 2020 2022 2222 0a20 2020 2070 6174 7465     """.    patte
-0001bfc0: 726e 203d 2072 652e 636f 6d70 696c 6528  rn = re.compile(
-0001bfd0: 7227 4174 7472 6962 7574 6545 7272 6f72  r'AttributeError
-0001bfe0: 3a20 6d6f 6475 6c65 205c 2773 6b79 5c2e  : module \'sky\.
-0001bff0: 282e 2a29 5c27 2068 6173 206e 6f20 270a  (.*)\' has no '.
-0001c000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c010: 2020 2020 2020 2020 2072 2761 7474 7269           r'attri
-0001c020: 6275 7465 205c 2728 2e2a 295c 2727 290a  bute \'(.*)\'').
-0001c030: 2020 2020 6966 2072 6574 7572 6e63 6f64      if returncod
-0001c040: 6520 213d 2030 3a0a 2020 2020 2020 2020  e != 0:.        
-0001c050: 6174 7472 6962 7574 655f 6572 726f 7220  attribute_error 
-0001c060: 3d20 7265 2e66 696e 6461 6c6c 2870 6174  = re.findall(pat
-0001c070: 7465 726e 2c20 7374 6465 7272 290a 2020  tern, stderr).  
-0001c080: 2020 2020 2020 6966 2061 7474 7269 6275        if attribu
-0001c090: 7465 5f65 7272 6f72 3a0a 2020 2020 2020  te_error:.      
-0001c0a0: 2020 2020 2020 7769 7468 2075 785f 7574        with ux_ut
-0001c0b0: 696c 732e 7072 696e 745f 6578 6365 7074  ils.print_except
-0001c0c0: 696f 6e5f 6e6f 5f74 7261 6365 6261 636b  ion_no_traceback
-0001c0d0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-0001c0e0: 2020 2020 7261 6973 6520 5275 6e74 696d      raise Runtim
-0001c0f0: 6545 7272 6f72 280a 2020 2020 2020 2020  eError(.        
-0001c100: 2020 2020 2020 2020 2020 2020 6627 7b63              f'{c
-0001c110: 6f6c 6f72 616d 612e 466f 7265 2e52 4544  olorama.Fore.RED
-0001c120: 7d53 6b79 5069 6c6f 7420 7275 6e74 696d  }SkyPilot runtim
-0001c130: 6520 6e65 6564 7320 746f 2062 6520 7570  e needs to be up
-0001c140: 6461 7465 6420 270a 2020 2020 2020 2020  dated '.        
-0001c150: 2020 2020 2020 2020 2020 2020 276f 6e20              'on 
-0001c160: 7468 6520 7265 6d6f 7465 2063 6c75 7374  the remote clust
-0001c170: 6572 2e20 546f 2075 7064 6174 652c 2072  er. To update, r
-0001c180: 756e 2028 6578 6973 7469 6e67 206a 6f62  un (existing job
-0001c190: 7320 6172 6520 270a 2020 2020 2020 2020  s are '.        
-0001c1a0: 2020 2020 2020 2020 2020 2020 6627 6e6f              f'no
-0001c1b0: 7420 696e 7465 7272 7570 7465 6429 3a20  t interrupted): 
-0001c1c0: 7b63 6f6c 6f72 616d 612e 5374 796c 652e  {colorama.Style.
-0001c1d0: 4252 4947 4854 7d73 6b79 2073 7461 7274  BRIGHT}sky start
-0001c1e0: 202d 6620 2d79 2027 0a20 2020 2020 2020   -f -y '.       
-0001c1f0: 2020 2020 2020 2020 2020 2020 2066 277b               f'{
-0001c200: 636c 7573 7465 725f 6e61 6d65 7d7b 636f  cluster_name}{co
-0001c210: 6c6f 7261 6d61 2e53 7479 6c65 2e52 4553  lorama.Style.RES
-0001c220: 4554 5f41 4c4c 7d27 0a20 2020 2020 2020  ET_ALL}'.       
-0001c230: 2020 2020 2020 2020 2020 2020 2066 275c               f'\
-0001c240: 6e2d 2d2d 2044 6574 6169 6c73 202d 2d2d  n--- Details ---
-0001c250: 5c6e 7b73 7464 6572 722e 7374 7269 7028  \n{stderr.strip(
-0001c260: 297d 5c6e 2729 0a                        )}\n').
+00019db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019dc0: 2a2a 7373 685f 6372 6564 656e 7469 616c  **ssh_credential
+00019dd0: 7329 0a20 2020 2020 2020 2069 6620 6e6f  s).        if no
+00019de0: 7420 7275 6e6e 6572 2e63 6865 636b 5f63  t runner.check_c
+00019df0: 6f6e 6e65 6374 696f 6e28 293a 0a20 2020  onnection():.   
+00019e00: 2020 2020 2020 2020 2065 7272 6f72 5f6d           error_m
+00019e10: 7367 203d 2063 6f6e 7472 6f6c 6c65 722e  sg = controller.
+00019e20: 7661 6c75 652e 636f 6e6e 6563 7469 6f6e  value.connection
+00019e30: 5f65 7272 6f72 5f68 696e 740a 2020 2020  _error_hint.    
+00019e40: 656c 7365 3a0a 2020 2020 2020 2020 6173  else:.        as
+00019e50: 7365 7274 2063 6f6e 7472 6f6c 6c65 725f  sert controller_
+00019e60: 7374 6174 7573 203d 3d20 7374 6174 7573  status == status
+00019e70: 5f6c 6962 2e43 6c75 7374 6572 5374 6174  _lib.ClusterStat
+00019e80: 7573 2e55 502c 2068 616e 646c 650a 0a20  us.UP, handle.. 
+00019e90: 2020 2069 6620 6572 726f 725f 6d73 6720     if error_msg 
+00019ea0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00019eb0: 2020 2020 2069 6620 6578 6974 5f69 665f       if exit_if_
+00019ec0: 6e6f 745f 6163 6365 7373 6962 6c65 3a0a  not_accessible:.
+00019ed0: 2020 2020 2020 2020 2020 2020 736b 795f              sky_
+00019ee0: 6c6f 6767 696e 672e 7072 696e 7428 6572  logging.print(er
+00019ef0: 726f 725f 6d73 6729 0a20 2020 2020 2020  ror_msg).       
+00019f00: 2020 2020 2073 7973 2e65 7869 7428 3129       sys.exit(1)
+00019f10: 0a20 2020 2020 2020 2077 6974 6820 7578  .        with ux
+00019f20: 5f75 7469 6c73 2e70 7269 6e74 5f65 7863  _utils.print_exc
+00019f30: 6570 7469 6f6e 5f6e 6f5f 7472 6163 6562  eption_no_traceb
+00019f40: 6163 6b28 293a 0a20 2020 2020 2020 2020  ack():.         
+00019f50: 2020 2072 6169 7365 2065 7863 6570 7469     raise excepti
+00019f60: 6f6e 732e 436c 7573 7465 724e 6f74 5570  ons.ClusterNotUp
+00019f70: 4572 726f 7228 6572 726f 725f 6d73 672c  Error(error_msg,
+00019f80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019fb0: 636c 7573 7465 725f 7374 6174 7573 3d63  cluster_status=c
+00019fc0: 6f6e 7472 6f6c 6c65 725f 7374 6174 7573  ontroller_status
+00019fd0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00019fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a000: 2068 616e 646c 653d 6861 6e64 6c65 290a   handle=handle).
+0001a010: 2020 2020 6173 7365 7274 2068 616e 646c      assert handl
+0001a020: 6520 6973 206e 6f74 204e 6f6e 6520 616e  e is not None an
+0001a030: 6420 6861 6e64 6c65 2e68 6561 645f 6970  d handle.head_ip
+0001a040: 2069 7320 6e6f 7420 4e6f 6e65 2c20 280a   is not None, (.
+0001a050: 2020 2020 2020 2020 6861 6e64 6c65 2c20          handle, 
+0001a060: 636f 6e74 726f 6c6c 6572 5f73 7461 7475  controller_statu
+0001a070: 7329 0a20 2020 2072 6574 7572 6e20 6861  s).    return ha
+0001a080: 6e64 6c65 0a0a 0a63 6c61 7373 2043 6c6f  ndle...class Clo
+0001a090: 7564 4669 6c74 6572 2865 6e75 6d2e 456e  udFilter(enum.En
+0001a0a0: 756d 293a 0a20 2020 2023 2046 696c 7465  um):.    # Filte
+0001a0b0: 7220 666f 7220 616c 6c20 7479 7065 7320  r for all types 
+0001a0c0: 6f66 2063 6c6f 7564 732e 0a20 2020 2041  of clouds..    A
+0001a0d0: 4c4c 203d 2027 616c 6c27 0a20 2020 2023  LL = 'all'.    #
+0001a0e0: 2046 696c 7465 7220 666f 7220 536b 7927   Filter for Sky'
+0001a0f0: 7320 6d61 696e 2063 6c6f 7564 7320 2861  s main clouds (a
+0001a100: 7773 2c20 6763 702c 2061 7a75 7265 2c20  ws, gcp, azure, 
+0001a110: 646f 636b 6572 292e 0a20 2020 2043 4c4f  docker)..    CLO
+0001a120: 5544 535f 414e 445f 444f 434b 4552 203d  UDS_AND_DOCKER =
+0001a130: 2027 636c 6f75 6473 2d61 6e64 2d64 6f63   'clouds-and-doc
+0001a140: 6b65 7227 0a20 2020 2023 2046 696c 7465  ker'.    # Filte
+0001a150: 7220 666f 7220 6f6e 6c79 206c 6f63 616c  r for only local
+0001a160: 2063 6c6f 7564 732e 0a20 2020 204c 4f43   clouds..    LOC
+0001a170: 414c 203d 2027 6c6f 6361 6c27 0a0a 0a64  AL = 'local'...d
+0001a180: 6566 2067 6574 5f63 6c75 7374 6572 7328  ef get_clusters(
+0001a190: 0a20 2020 2069 6e63 6c75 6465 5f63 6f6e  .    include_con
+0001a1a0: 7472 6f6c 6c65 723a 2062 6f6f 6c2c 0a20  troller: bool,. 
+0001a1b0: 2020 2072 6566 7265 7368 3a20 626f 6f6c     refresh: bool
+0001a1c0: 2c0a 2020 2020 636c 7573 7465 725f 6e61  ,.    cluster_na
+0001a1d0: 6d65 733a 204f 7074 696f 6e61 6c5b 556e  mes: Optional[Un
+0001a1e0: 696f 6e5b 7374 722c 204c 6973 745b 7374  ion[str, List[st
+0001a1f0: 725d 5d5d 203d 204e 6f6e 652c 0a29 202d  r]]] = None,.) -
+0001a200: 3e20 4c69 7374 5b44 6963 745b 7374 722c  > List[Dict[str,
+0001a210: 2041 6e79 5d5d 3a0a 2020 2020 2222 2252   Any]]:.    """R
+0001a220: 6574 7572 6e73 2061 206c 6973 7420 6f66  eturns a list of
+0001a230: 2063 6163 6865 6420 6f72 206f 7074 696f   cached or optio
+0001a240: 6e61 6c6c 7920 7265 6672 6573 6865 6420  nally refreshed 
+0001a250: 636c 7573 7465 7220 7265 636f 7264 732e  cluster records.
+0001a260: 0a0a 2020 2020 436f 6d62 7320 7468 726f  ..    Combs thro
+0001a270: 7567 6820 7468 6520 6461 7461 6261 7365  ugh the database
+0001a280: 2028 696e 207e 2f2e 736b 792f 7374 6174   (in ~/.sky/stat
+0001a290: 652e 6462 2920 746f 2067 6574 2061 206c  e.db) to get a l
+0001a2a0: 6973 7420 6f66 2072 6563 6f72 6473 0a20  ist of records. 
+0001a2b0: 2020 2063 6f72 7265 7370 6f6e 6469 6e67     corresponding
+0001a2c0: 2074 6f20 6c61 756e 6368 6564 2063 6c75   to launched clu
+0001a2d0: 7374 6572 7320 2866 696c 7465 7265 6420  sters (filtered 
+0001a2e0: 6279 2060 636c 7573 7465 725f 6e61 6d65  by `cluster_name
+0001a2f0: 7360 2069 6620 6974 2069 730a 2020 2020  s` if it is.    
+0001a300: 7370 6563 6966 6965 6429 2e20 5468 6520  specified). The 
+0001a310: 7265 6672 6573 6820 666c 6167 2063 616e  refresh flag can
+0001a320: 2062 6520 7573 6564 2074 6f20 666f 7263   be used to forc
+0001a330: 6520 6120 7265 6672 6573 6820 6f66 2074  e a refresh of t
+0001a340: 6865 2073 7461 7475 730a 2020 2020 6f66  he status.    of
+0001a350: 2074 6865 2063 6c75 7374 6572 732e 0a0a   the clusters...
+0001a360: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+0001a370: 2020 696e 636c 7564 655f 636f 6e74 726f    include_contro
+0001a380: 6c6c 6572 3a20 5768 6574 6865 7220 746f  ller: Whether to
+0001a390: 2069 6e63 6c75 6465 2063 6f6e 7472 6f6c   include control
+0001a3a0: 6c65 7273 2c20 652e 672e 206a 6f62 7320  lers, e.g. jobs 
+0001a3b0: 636f 6e74 726f 6c6c 6572 0a20 2020 2020  controller.     
+0001a3c0: 2020 2020 2020 206f 7220 736b 7920 7365         or sky se
+0001a3d0: 7276 6520 636f 6e74 726f 6c6c 6572 2e0a  rve controller..
+0001a3e0: 2020 2020 2020 2020 7265 6672 6573 683a          refresh:
+0001a3f0: 2057 6865 7468 6572 2074 6f20 7265 6672   Whether to refr
+0001a400: 6573 6820 7468 6520 7374 6174 7573 206f  esh the status o
+0001a410: 6620 7468 6520 636c 7573 7465 7273 2e20  f the clusters. 
+0001a420: 2852 6566 7265 7368 696e 6720 7769 6c6c  (Refreshing will
+0001a430: 0a20 2020 2020 2020 2020 2020 2073 6574  .            set
+0001a440: 2074 6865 2073 7461 7475 7320 746f 2053   the status to S
+0001a450: 544f 5050 4544 2069 6620 7468 6520 636c  TOPPED if the cl
+0001a460: 7573 7465 7220 6361 6e6e 6f74 2062 6520  uster cannot be 
+0001a470: 7069 6e67 6564 2e29 0a20 2020 2020 2020  pinged.).       
+0001a480: 2063 6c6f 7564 5f66 696c 7465 723a 2053   cloud_filter: S
+0001a490: 6574 7320 7768 6963 6820 636c 6f75 6473  ets which clouds
+0001a4a0: 2074 6f20 6669 6c65 7220 7468 726f 7567   to filer throug
+0001a4b0: 6820 6672 6f6d 2074 6865 2067 6c6f 6261  h from the globa
+0001a4c0: 6c20 7573 6572 0a20 2020 2020 2020 2020  l user.         
+0001a4d0: 2020 2073 7461 7465 2e20 5375 7070 6f72     state. Suppor
+0001a4e0: 7473 2074 6872 6565 2076 616c 7565 732c  ts three values,
+0001a4f0: 2027 616c 6c27 2066 6f72 2061 6c6c 2063   'all' for all c
+0001a500: 6c6f 7564 732c 2027 7075 626c 6963 2720  louds, 'public' 
+0001a510: 666f 720a 2020 2020 2020 2020 2020 2020  for.            
+0001a520: 7075 626c 6963 2063 6c6f 7564 7320 6f6e  public clouds on
+0001a530: 6c79 2c20 616e 6420 276c 6f63 616c 2720  ly, and 'local' 
+0001a540: 666f 7220 6f6e 6c79 206c 6f63 616c 2063  for only local c
+0001a550: 6c6f 7564 732e 0a20 2020 2020 2020 2063  louds..        c
+0001a560: 6c75 7374 6572 5f6e 616d 6573 3a20 4966  luster_names: If
+0001a570: 2070 726f 7669 6465 642c 206f 6e6c 7920   provided, only 
+0001a580: 7265 7475 726e 2072 6563 6f72 6473 2066  return records f
+0001a590: 6f72 2074 6865 2067 6976 656e 2063 6c75  or the given clu
+0001a5a0: 7374 6572 0a20 2020 2020 2020 2020 2020  ster.           
+0001a5b0: 206e 616d 6573 2e0a 0a20 2020 2052 6574   names...    Ret
+0001a5c0: 7572 6e73 3a0a 2020 2020 2020 2020 4120  urns:.        A 
+0001a5d0: 6c69 7374 206f 6620 636c 7573 7465 7220  list of cluster 
+0001a5e0: 7265 636f 7264 732e 2049 6620 7468 6520  records. If the 
+0001a5f0: 636c 7573 7465 7220 646f 6573 206e 6f74  cluster does not
+0001a600: 2065 7869 7374 206f 7220 6861 7320 6265   exist or has be
+0001a610: 656e 0a20 2020 2020 2020 2074 6572 6d69  en.        termi
+0001a620: 6e61 7465 642c 2074 6865 2072 6563 6f72  nated, the recor
+0001a630: 6420 7769 6c6c 2062 6520 6f6d 6974 7465  d will be omitte
+0001a640: 6420 6672 6f6d 2074 6865 2072 6574 7572  d from the retur
+0001a650: 6e65 6420 6c69 7374 2e0a 2020 2020 2222  ned list..    ""
+0001a660: 220a 2020 2020 7265 636f 7264 7320 3d20  ".    records = 
+0001a670: 676c 6f62 616c 5f75 7365 725f 7374 6174  global_user_stat
+0001a680: 652e 6765 745f 636c 7573 7465 7273 2829  e.get_clusters()
+0001a690: 0a0a 2020 2020 6966 206e 6f74 2069 6e63  ..    if not inc
+0001a6a0: 6c75 6465 5f63 6f6e 7472 6f6c 6c65 723a  lude_controller:
+0001a6b0: 0a20 2020 2020 2020 2072 6563 6f72 6473  .        records
+0001a6c0: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
+0001a6d0: 2072 6563 6f72 6420 666f 7220 7265 636f   record for reco
+0001a6e0: 7264 2069 6e20 7265 636f 7264 730a 2020  rd in records.  
+0001a6f0: 2020 2020 2020 2020 2020 6966 2063 6f6e            if con
+0001a700: 7472 6f6c 6c65 725f 7574 696c 732e 436f  troller_utils.Co
+0001a710: 6e74 726f 6c6c 6572 732e 6672 6f6d 5f6e  ntrollers.from_n
+0001a720: 616d 6528 7265 636f 7264 5b27 6e61 6d65  ame(record['name
+0001a730: 275d 2920 6973 204e 6f6e 650a 2020 2020  ']) is None.    
+0001a740: 2020 2020 5d0a 0a20 2020 2079 656c 6c6f      ]..    yello
+0001a750: 7720 3d20 636f 6c6f 7261 6d61 2e46 6f72  w = colorama.For
+0001a760: 652e 5945 4c4c 4f57 0a20 2020 2062 7269  e.YELLOW.    bri
+0001a770: 6768 7420 3d20 636f 6c6f 7261 6d61 2e53  ght = colorama.S
+0001a780: 7479 6c65 2e42 5249 4748 540a 2020 2020  tyle.BRIGHT.    
+0001a790: 7265 7365 7420 3d20 636f 6c6f 7261 6d61  reset = colorama
+0001a7a0: 2e53 7479 6c65 2e52 4553 4554 5f41 4c4c  .Style.RESET_ALL
+0001a7b0: 0a0a 2020 2020 6966 2063 6c75 7374 6572  ..    if cluster
+0001a7c0: 5f6e 616d 6573 2069 7320 6e6f 7420 4e6f  _names is not No
+0001a7d0: 6e65 3a0a 2020 2020 2020 2020 6966 2069  ne:.        if i
+0001a7e0: 7369 6e73 7461 6e63 6528 636c 7573 7465  sinstance(cluste
+0001a7f0: 725f 6e61 6d65 732c 2073 7472 293a 0a20  r_names, str):. 
+0001a800: 2020 2020 2020 2020 2020 2063 6c75 7374             clust
+0001a810: 6572 5f6e 616d 6573 203d 205b 636c 7573  er_names = [clus
+0001a820: 7465 725f 6e61 6d65 735d 0a20 2020 2020  ter_names].     
+0001a830: 2020 206e 6577 5f72 6563 6f72 6473 203d     new_records =
+0001a840: 205b 5d0a 2020 2020 2020 2020 6e6f 745f   [].        not_
+0001a850: 6578 6973 745f 636c 7573 7465 725f 6e61  exist_cluster_na
+0001a860: 6d65 7320 3d20 5b5d 0a20 2020 2020 2020  mes = [].       
+0001a870: 2066 6f72 2063 6c75 7374 6572 5f6e 616d   for cluster_nam
+0001a880: 6520 696e 2063 6c75 7374 6572 5f6e 616d  e in cluster_nam
+0001a890: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+0001a8a0: 666f 7220 7265 636f 7264 2069 6e20 7265  for record in re
+0001a8b0: 636f 7264 733a 0a20 2020 2020 2020 2020  cords:.         
+0001a8c0: 2020 2020 2020 2069 6620 7265 636f 7264         if record
+0001a8d0: 5b27 6e61 6d65 275d 203d 3d20 636c 7573  ['name'] == clus
+0001a8e0: 7465 725f 6e61 6d65 3a0a 2020 2020 2020  ter_name:.      
+0001a8f0: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
+0001a900: 775f 7265 636f 7264 732e 6170 7065 6e64  w_records.append
+0001a910: 2872 6563 6f72 6429 0a20 2020 2020 2020  (record).       
+0001a920: 2020 2020 2020 2020 2020 2020 2062 7265               bre
+0001a930: 616b 0a20 2020 2020 2020 2020 2020 2065  ak.            e
+0001a940: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0001a950: 2020 2020 206e 6f74 5f65 7869 7374 5f63       not_exist_c
+0001a960: 6c75 7374 6572 5f6e 616d 6573 2e61 7070  luster_names.app
+0001a970: 656e 6428 636c 7573 7465 725f 6e61 6d65  end(cluster_name
+0001a980: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
+0001a990: 5f65 7869 7374 5f63 6c75 7374 6572 5f6e  _exist_cluster_n
+0001a9a0: 616d 6573 3a0a 2020 2020 2020 2020 2020  ames:.          
+0001a9b0: 2020 636c 7573 7465 7273 5f73 7472 203d    clusters_str =
+0001a9c0: 2027 2c20 272e 6a6f 696e 286e 6f74 5f65   ', '.join(not_e
+0001a9d0: 7869 7374 5f63 6c75 7374 6572 5f6e 616d  xist_cluster_nam
+0001a9e0: 6573 290a 2020 2020 2020 2020 2020 2020  es).            
+0001a9f0: 6c6f 6767 6572 2e69 6e66 6f28 6627 436c  logger.info(f'Cl
+0001aa00: 7573 7465 7228 7329 206e 6f74 2066 6f75  uster(s) not fou
+0001aa10: 6e64 3a20 7b62 7269 6768 747d 7b63 6c75  nd: {bright}{clu
+0001aa20: 7374 6572 735f 7374 727d 7b72 6573 6574  sters_str}{reset
+0001aa30: 7d2e 2729 0a20 2020 2020 2020 2072 6563  }.').        rec
+0001aa40: 6f72 6473 203d 206e 6577 5f72 6563 6f72  ords = new_recor
+0001aa50: 6473 0a0a 2020 2020 6966 206e 6f74 2072  ds..    if not r
+0001aa60: 6566 7265 7368 3a0a 2020 2020 2020 2020  efresh:.        
+0001aa70: 7265 7475 726e 2072 6563 6f72 6473 0a0a  return records..
+0001aa80: 2020 2020 706c 7572 616c 203d 2027 7327      plural = 's'
+0001aa90: 2069 6620 6c65 6e28 7265 636f 7264 7329   if len(records)
+0001aaa0: 203e 2031 2065 6c73 6520 2727 0a20 2020   > 1 else ''.   
+0001aab0: 2070 726f 6772 6573 7320 3d20 7269 6368   progress = rich
+0001aac0: 5f70 726f 6772 6573 732e 5072 6f67 7265  _progress.Progre
+0001aad0: 7373 2874 7261 6e73 6965 6e74 3d54 7275  ss(transient=Tru
+0001aae0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+0001aaf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ab00: 2020 2020 2020 2020 2072 6564 6972 6563           redirec
+0001ab10: 745f 7374 646f 7574 3d46 616c 7365 2c0a  t_stdout=False,.
+0001ab20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ab30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ab40: 2020 2020 2020 7265 6469 7265 6374 5f73        redirect_s
+0001ab50: 7464 6572 723d 4661 6c73 6529 0a20 2020  tderr=False).   
+0001ab60: 2074 6173 6b20 3d20 7072 6f67 7265 7373   task = progress
+0001ab70: 2e61 6464 5f74 6173 6b28 0a20 2020 2020  .add_task(.     
+0001ab80: 2020 2066 275b 626f 6c64 2063 7961 6e5d     f'[bold cyan]
+0001ab90: 5265 6672 6573 6869 6e67 2073 7461 7475  Refreshing statu
+0001aba0: 7320 666f 7220 7b6c 656e 2872 6563 6f72  s for {len(recor
+0001abb0: 6473 297d 2063 6c75 7374 6572 7b70 6c75  ds)} cluster{plu
+0001abc0: 7261 6c7d 5b2f 5d27 2c0a 2020 2020 2020  ral}[/]',.      
+0001abd0: 2020 746f 7461 6c3d 6c65 6e28 7265 636f    total=len(reco
+0001abe0: 7264 7329 290a 0a20 2020 2064 6566 205f  rds))..    def _
+0001abf0: 7265 6672 6573 685f 636c 7573 7465 7228  refresh_cluster(
+0001ac00: 636c 7573 7465 725f 6e61 6d65 293a 0a20  cluster_name):. 
+0001ac10: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+0001ac20: 2020 2020 2020 2020 7265 636f 7264 203d          record =
+0001ac30: 2072 6566 7265 7368 5f63 6c75 7374 6572   refresh_cluster
+0001ac40: 5f72 6563 6f72 6428 0a20 2020 2020 2020  _record(.       
+0001ac50: 2020 2020 2020 2020 2063 6c75 7374 6572           cluster
+0001ac60: 5f6e 616d 652c 0a20 2020 2020 2020 2020  _name,.         
+0001ac70: 2020 2020 2020 2066 6f72 6365 5f72 6566         force_ref
+0001ac80: 7265 7368 5f73 7461 7475 7365 733d 7365  resh_statuses=se
+0001ac90: 7428 7374 6174 7573 5f6c 6962 2e43 6c75  t(status_lib.Clu
+0001aca0: 7374 6572 5374 6174 7573 292c 0a20 2020  sterStatus),.   
+0001acb0: 2020 2020 2020 2020 2020 2020 2061 6371               acq
+0001acc0: 7569 7265 5f70 6572 5f63 6c75 7374 6572  uire_per_cluster
+0001acd0: 5f73 7461 7475 735f 6c6f 636b 3d54 7275  _status_lock=Tru
+0001ace0: 6529 0a20 2020 2020 2020 2065 7863 6570  e).        excep
+0001acf0: 7420 2865 7863 6570 7469 6f6e 732e 436c  t (exceptions.Cl
+0001ad00: 7573 7465 7253 7461 7475 7346 6574 6368  usterStatusFetch
+0001ad10: 696e 6745 7272 6f72 2c0a 2020 2020 2020  ingError,.      
+0001ad20: 2020 2020 2020 2020 2020 6578 6365 7074            except
+0001ad30: 696f 6e73 2e43 6c6f 7564 5573 6572 4964  ions.CloudUserId
+0001ad40: 656e 7469 7479 4572 726f 722c 0a20 2020  entityError,.   
+0001ad50: 2020 2020 2020 2020 2020 2020 2065 7863               exc
+0001ad60: 6570 7469 6f6e 732e 436c 7573 7465 724f  eptions.ClusterO
+0001ad70: 776e 6572 4964 656e 7469 7479 4d69 736d  wnerIdentityMism
+0001ad80: 6174 6368 4572 726f 7229 2061 7320 653a  atchError) as e:
+0001ad90: 0a20 2020 2020 2020 2020 2020 2023 2044  .            # D
+0001ada0: 6f20 6e6f 7420 6661 696c 2074 6865 2065  o not fail the e
+0001adb0: 6e74 6972 6520 7265 6672 6573 6820 7072  ntire refresh pr
+0001adc0: 6f63 6573 732e 2054 6865 2063 616c 6c65  ocess. The calle
+0001add0: 7220 7769 6c6c 0a20 2020 2020 2020 2020  r will.         
+0001ade0: 2020 2023 2068 616e 646c 6520 7468 6520     # handle the 
+0001adf0: 2755 4e4b 4e4f 574e 2720 7374 6174 7573  'UNKNOWN' status
+0001ae00: 2c20 616e 6420 636f 6c6c 6563 7420 7468  , and collect th
+0001ae10: 6520 6572 726f 7273 2069 6e74 6f0a 2020  e errors into.  
+0001ae20: 2020 2020 2020 2020 2020 2320 6120 7461            # a ta
+0001ae30: 626c 652e 0a20 2020 2020 2020 2020 2020  ble..           
+0001ae40: 2072 6563 6f72 6420 3d20 7b27 7374 6174   record = {'stat
+0001ae50: 7573 273a 2027 554e 4b4e 4f57 4e27 2c20  us': 'UNKNOWN', 
+0001ae60: 2765 7272 6f72 273a 2065 7d0a 2020 2020  'error': e}.    
+0001ae70: 2020 2020 7072 6f67 7265 7373 2e75 7064      progress.upd
+0001ae80: 6174 6528 7461 736b 2c20 6164 7661 6e63  ate(task, advanc
+0001ae90: 653d 3129 0a20 2020 2020 2020 2072 6574  e=1).        ret
+0001aea0: 7572 6e20 7265 636f 7264 0a0a 2020 2020  urn record..    
+0001aeb0: 636c 7573 7465 725f 6e61 6d65 7320 3d20  cluster_names = 
+0001aec0: 5b72 6563 6f72 645b 276e 616d 6527 5d20  [record['name'] 
+0001aed0: 666f 7220 7265 636f 7264 2069 6e20 7265  for record in re
+0001aee0: 636f 7264 735d 0a20 2020 2077 6974 6820  cords].    with 
+0001aef0: 7072 6f67 7265 7373 3a0a 2020 2020 2020  progress:.      
+0001af00: 2020 7570 6461 7465 645f 7265 636f 7264    updated_record
+0001af10: 7320 3d20 7375 6270 726f 6365 7373 5f75  s = subprocess_u
+0001af20: 7469 6c73 2e72 756e 5f69 6e5f 7061 7261  tils.run_in_para
+0001af30: 6c6c 656c 280a 2020 2020 2020 2020 2020  llel(.          
+0001af40: 2020 5f72 6566 7265 7368 5f63 6c75 7374    _refresh_clust
+0001af50: 6572 2c20 636c 7573 7465 725f 6e61 6d65  er, cluster_name
+0001af60: 7329 0a0a 2020 2020 2320 5368 6f77 2069  s)..    # Show i
+0001af70: 6e66 6f72 6d61 7469 6f6e 2066 6f72 2072  nformation for r
+0001af80: 656d 6f76 6564 2063 6c75 7374 6572 732e  emoved clusters.
+0001af90: 0a20 2020 206b 6570 745f 7265 636f 7264  .    kept_record
+0001afa0: 7320 3d20 5b5d 0a20 2020 2061 7574 6f64  s = [].    autod
+0001afb0: 6f77 6e5f 636c 7573 7465 7273 2c20 7265  own_clusters, re
+0001afc0: 6d61 696e 696e 675f 636c 7573 7465 7273  maining_clusters
+0001afd0: 2c20 6661 696c 6564 5f63 6c75 7374 6572  , failed_cluster
+0001afe0: 7320 3d20 5b5d 2c20 5b5d 2c20 5b5d 0a20  s = [], [], []. 
+0001aff0: 2020 2066 6f72 2069 2c20 7265 636f 7264     for i, record
+0001b000: 2069 6e20 656e 756d 6572 6174 6528 7265   in enumerate(re
+0001b010: 636f 7264 7329 3a0a 2020 2020 2020 2020  cords):.        
+0001b020: 6966 2075 7064 6174 6564 5f72 6563 6f72  if updated_recor
+0001b030: 6473 5b69 5d20 6973 204e 6f6e 653a 0a20  ds[i] is None:. 
+0001b040: 2020 2020 2020 2020 2020 2069 6620 7265             if re
+0001b050: 636f 7264 5b27 746f 5f64 6f77 6e27 5d3a  cord['to_down']:
+0001b060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001b070: 2061 7574 6f64 6f77 6e5f 636c 7573 7465   autodown_cluste
+0001b080: 7273 2e61 7070 656e 6428 636c 7573 7465  rs.append(cluste
+0001b090: 725f 6e61 6d65 735b 695d 290a 2020 2020  r_names[i]).    
+0001b0a0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0001b0b0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0001b0c0: 6d61 696e 696e 675f 636c 7573 7465 7273  maining_clusters
+0001b0d0: 2e61 7070 656e 6428 636c 7573 7465 725f  .append(cluster_
+0001b0e0: 6e61 6d65 735b 695d 290a 2020 2020 2020  names[i]).      
+0001b0f0: 2020 656c 6966 2075 7064 6174 6564 5f72    elif updated_r
+0001b100: 6563 6f72 6473 5b69 5d5b 2773 7461 7475  ecords[i]['statu
+0001b110: 7327 5d20 3d3d 2027 554e 4b4e 4f57 4e27  s'] == 'UNKNOWN'
+0001b120: 3a0a 2020 2020 2020 2020 2020 2020 6661  :.            fa
+0001b130: 696c 6564 5f63 6c75 7374 6572 732e 6170  iled_clusters.ap
+0001b140: 7065 6e64 280a 2020 2020 2020 2020 2020  pend(.          
+0001b150: 2020 2020 2020 2863 6c75 7374 6572 5f6e        (cluster_n
+0001b160: 616d 6573 5b69 5d2c 2075 7064 6174 6564  ames[i], updated
+0001b170: 5f72 6563 6f72 6473 5b69 5d5b 2765 7272  _records[i]['err
+0001b180: 6f72 275d 2929 0a20 2020 2020 2020 2020  or'])).         
+0001b190: 2020 2023 204b 6565 7020 7468 6520 6f72     # Keep the or
+0001b1a0: 6967 696e 616c 2072 6563 6f72 6420 6966  iginal record if
+0001b1b0: 2074 6865 2073 7461 7475 7320 6973 2075   the status is u
+0001b1c0: 6e6b 6e6f 776e 2c0a 2020 2020 2020 2020  nknown,.        
+0001b1d0: 2020 2020 2320 736f 2074 6861 7420 7468      # so that th
+0001b1e0: 6520 7573 6572 2063 616e 2073 7469 6c6c  e user can still
+0001b1f0: 2073 6565 2074 6865 2063 6c75 7374 6572   see the cluster
+0001b200: 2e0a 2020 2020 2020 2020 2020 2020 6b65  ..            ke
+0001b210: 7074 5f72 6563 6f72 6473 2e61 7070 656e  pt_records.appen
+0001b220: 6428 7265 636f 7264 290a 2020 2020 2020  d(record).      
+0001b230: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0001b240: 2020 2020 6b65 7074 5f72 6563 6f72 6473      kept_records
+0001b250: 2e61 7070 656e 6428 7570 6461 7465 645f  .append(updated_
+0001b260: 7265 636f 7264 735b 695d 290a 0a20 2020  records[i])..   
+0001b270: 2069 6620 6175 746f 646f 776e 5f63 6c75   if autodown_clu
+0001b280: 7374 6572 733a 0a20 2020 2020 2020 2070  sters:.        p
+0001b290: 6c75 7261 6c20 3d20 2773 2720 6966 206c  lural = 's' if l
+0001b2a0: 656e 2861 7574 6f64 6f77 6e5f 636c 7573  en(autodown_clus
+0001b2b0: 7465 7273 2920 3e20 3120 656c 7365 2027  ters) > 1 else '
+0001b2c0: 270a 2020 2020 2020 2020 636c 7573 7465  '.        cluste
+0001b2d0: 725f 7374 7220 3d20 272c 2027 2e6a 6f69  r_str = ', '.joi
+0001b2e0: 6e28 6175 746f 646f 776e 5f63 6c75 7374  n(autodown_clust
+0001b2f0: 6572 7329 0a20 2020 2020 2020 206c 6f67  ers).        log
+0001b300: 6765 722e 696e 666f 2866 2741 7574 6f64  ger.info(f'Autod
+0001b310: 6f77 6e65 6420 636c 7573 7465 727b 706c  owned cluster{pl
+0001b320: 7572 616c 7d3a 2027 0a20 2020 2020 2020  ural}: '.       
+0001b330: 2020 2020 2020 2020 2020 2020 2066 277b               f'{
+0001b340: 6272 6967 6874 7d7b 636c 7573 7465 725f  bright}{cluster_
+0001b350: 7374 727d 7b72 6573 6574 7d27 290a 2020  str}{reset}').  
+0001b360: 2020 6966 2072 656d 6169 6e69 6e67 5f63    if remaining_c
+0001b370: 6c75 7374 6572 733a 0a20 2020 2020 2020  lusters:.       
+0001b380: 2070 6c75 7261 6c20 3d20 2773 2720 6966   plural = 's' if
+0001b390: 206c 656e 2872 656d 6169 6e69 6e67 5f63   len(remaining_c
+0001b3a0: 6c75 7374 6572 7329 203e 2031 2065 6c73  lusters) > 1 els
+0001b3b0: 6520 2727 0a20 2020 2020 2020 2063 6c75  e ''.        clu
+0001b3c0: 7374 6572 5f73 7472 203d 2027 2c20 272e  ster_str = ', '.
+0001b3d0: 6a6f 696e 286e 616d 6520 666f 7220 6e61  join(name for na
+0001b3e0: 6d65 2069 6e20 7265 6d61 696e 696e 675f  me in remaining_
+0001b3f0: 636c 7573 7465 7273 290a 2020 2020 2020  clusters).      
+0001b400: 2020 6c6f 6767 6572 2e77 6172 6e69 6e67    logger.warning
+0001b410: 2866 277b 7965 6c6c 6f77 7d43 6c75 7374  (f'{yellow}Clust
+0001b420: 6572 7b70 6c75 7261 6c7d 2074 6572 6d69  er{plural} termi
+0001b430: 6e61 7465 6420 6f6e 2027 0a20 2020 2020  nated on '.     
+0001b440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b450: 2020 6627 7468 6520 636c 6f75 643a 207b    f'the cloud: {
+0001b460: 7265 7365 747d 7b62 7269 6768 747d 7b63  reset}{bright}{c
+0001b470: 6c75 7374 6572 5f73 7472 7d7b 7265 7365  luster_str}{rese
+0001b480: 747d 2729 0a0a 2020 2020 6966 2066 6169  t}')..    if fai
+0001b490: 6c65 645f 636c 7573 7465 7273 3a0a 2020  led_clusters:.  
+0001b4a0: 2020 2020 2020 706c 7572 616c 203d 2027        plural = '
+0001b4b0: 7327 2069 6620 6c65 6e28 6661 696c 6564  s' if len(failed
+0001b4c0: 5f63 6c75 7374 6572 7329 203e 2031 2065  _clusters) > 1 e
+0001b4d0: 6c73 6520 2727 0a20 2020 2020 2020 206c  lse ''.        l
+0001b4e0: 6f67 6765 722e 7761 726e 696e 6728 6627  ogger.warning(f'
+0001b4f0: 7b79 656c 6c6f 777d 4661 696c 6564 2074  {yellow}Failed t
+0001b500: 6f20 7265 6672 6573 6820 7374 6174 7573  o refresh status
+0001b510: 2066 6f72 2027 0a20 2020 2020 2020 2020   for '.         
+0001b520: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+0001b530: 7b6c 656e 2866 6169 6c65 645f 636c 7573  {len(failed_clus
+0001b540: 7465 7273 297d 2063 6c75 7374 6572 7b70  ters)} cluster{p
+0001b550: 6c75 7261 6c7d 3a7b 7265 7365 747d 2729  lural}:{reset}')
+0001b560: 0a20 2020 2020 2020 2066 6f72 2063 6c75  .        for clu
+0001b570: 7374 6572 5f6e 616d 652c 2065 2069 6e20  ster_name, e in 
+0001b580: 6661 696c 6564 5f63 6c75 7374 6572 733a  failed_clusters:
+0001b590: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+0001b5a0: 6765 722e 7761 726e 696e 6728 6627 2020  ger.warning(f'  
+0001b5b0: 7b62 7269 6768 747d 7b63 6c75 7374 6572  {bright}{cluster
+0001b5c0: 5f6e 616d 657d 7b72 6573 6574 7d3a 207b  _name}{reset}: {
+0001b5d0: 657d 2729 0a20 2020 2072 6574 7572 6e20  e}').    return 
+0001b5e0: 6b65 7074 5f72 6563 6f72 6473 0a0a 0a40  kept_records...@
+0001b5f0: 7479 7069 6e67 2e6f 7665 726c 6f61 640a  typing.overload.
+0001b600: 6465 6620 6765 745f 6261 636b 656e 645f  def get_backend_
+0001b610: 6672 6f6d 5f68 616e 646c 6528 0a20 2020  from_handle(.   
+0001b620: 2068 616e 646c 653a 2027 636c 6f75 645f   handle: 'cloud_
+0001b630: 766d 5f72 6179 5f62 6163 6b65 6e64 2e43  vm_ray_backend.C
+0001b640: 6c6f 7564 566d 5261 7952 6573 6f75 7263  loudVmRayResourc
+0001b650: 6548 616e 646c 6527 0a29 202d 3e20 2763  eHandle'.) -> 'c
+0001b660: 6c6f 7564 5f76 6d5f 7261 795f 6261 636b  loud_vm_ray_back
+0001b670: 656e 642e 436c 6f75 6456 6d52 6179 4261  end.CloudVmRayBa
+0001b680: 636b 656e 6427 3a0a 2020 2020 2e2e 2e0a  ckend':.    ....
+0001b690: 0a0a 4074 7970 696e 672e 6f76 6572 6c6f  ..@typing.overlo
+0001b6a0: 6164 0a64 6566 2067 6574 5f62 6163 6b65  ad.def get_backe
+0001b6b0: 6e64 5f66 726f 6d5f 6861 6e64 6c65 280a  nd_from_handle(.
+0001b6c0: 2020 2020 6861 6e64 6c65 3a20 276c 6f63      handle: 'loc
+0001b6d0: 616c 5f64 6f63 6b65 725f 6261 636b 656e  al_docker_backen
+0001b6e0: 642e 4c6f 6361 6c44 6f63 6b65 7252 6573  d.LocalDockerRes
+0001b6f0: 6f75 7263 6548 616e 646c 6527 0a29 202d  ourceHandle'.) -
+0001b700: 3e20 276c 6f63 616c 5f64 6f63 6b65 725f  > 'local_docker_
+0001b710: 6261 636b 656e 642e 4c6f 6361 6c44 6f63  backend.LocalDoc
+0001b720: 6b65 7242 6163 6b65 6e64 273a 0a20 2020  kerBackend':.   
+0001b730: 202e 2e2e 0a0a 0a40 7479 7069 6e67 2e6f   ......@typing.o
+0001b740: 7665 726c 6f61 640a 6465 6620 6765 745f  verload.def get_
+0001b750: 6261 636b 656e 645f 6672 6f6d 5f68 616e  backend_from_han
+0001b760: 646c 6528 0a20 2020 2020 2020 2068 616e  dle(.        han
+0001b770: 646c 653a 2062 6163 6b65 6e64 732e 5265  dle: backends.Re
+0001b780: 736f 7572 6365 4861 6e64 6c65 2920 2d3e  sourceHandle) ->
+0001b790: 2062 6163 6b65 6e64 732e 4261 636b 656e   backends.Backen
+0001b7a0: 643a 0a20 2020 202e 2e2e 0a0a 0a64 6566  d:.    ......def
+0001b7b0: 2067 6574 5f62 6163 6b65 6e64 5f66 726f   get_backend_fro
+0001b7c0: 6d5f 6861 6e64 6c65 280a 2020 2020 2020  m_handle(.      
+0001b7d0: 2020 6861 6e64 6c65 3a20 6261 636b 656e    handle: backen
+0001b7e0: 6473 2e52 6573 6f75 7263 6548 616e 646c  ds.ResourceHandl
+0001b7f0: 6529 202d 3e20 6261 636b 656e 6473 2e42  e) -> backends.B
+0001b800: 6163 6b65 6e64 3a0a 2020 2020 2222 2247  ackend:.    """G
+0001b810: 6574 7320 6120 4261 636b 656e 6420 6f62  ets a Backend ob
+0001b820: 6a65 6374 2063 6f72 7265 7370 6f6e 6469  ject correspondi
+0001b830: 6e67 2074 6f20 6120 6861 6e64 6c65 2e0a  ng to a handle..
+0001b840: 0a20 2020 2049 6e73 7065 6374 7320 6861  .    Inspects ha
+0001b850: 6e64 6c65 2074 7970 6520 746f 2069 6e66  ndle type to inf
+0001b860: 6572 2074 6865 2062 6163 6b65 6e64 2075  er the backend u
+0001b870: 7365 6420 666f 7220 7468 6520 7265 736f  sed for the reso
+0001b880: 7572 6365 2e0a 2020 2020 2222 220a 2020  urce..    """.  
+0001b890: 2020 6261 636b 656e 643a 2062 6163 6b65    backend: backe
+0001b8a0: 6e64 732e 4261 636b 656e 640a 2020 2020  nds.Backend.    
+0001b8b0: 6966 2069 7369 6e73 7461 6e63 6528 6861  if isinstance(ha
+0001b8c0: 6e64 6c65 2c20 6261 636b 656e 6473 2e43  ndle, backends.C
+0001b8d0: 6c6f 7564 566d 5261 7952 6573 6f75 7263  loudVmRayResourc
+0001b8e0: 6548 616e 646c 6529 3a0a 2020 2020 2020  eHandle):.      
+0001b8f0: 2020 6261 636b 656e 6420 3d20 6261 636b    backend = back
+0001b900: 656e 6473 2e43 6c6f 7564 566d 5261 7942  ends.CloudVmRayB
+0001b910: 6163 6b65 6e64 2829 0a20 2020 2065 6c69  ackend().    eli
+0001b920: 6620 6973 696e 7374 616e 6365 2868 616e  f isinstance(han
+0001b930: 646c 652c 2062 6163 6b65 6e64 732e 4c6f  dle, backends.Lo
+0001b940: 6361 6c44 6f63 6b65 7252 6573 6f75 7263  calDockerResourc
+0001b950: 6548 616e 646c 6529 3a0a 2020 2020 2020  eHandle):.      
+0001b960: 2020 6261 636b 656e 6420 3d20 6261 636b    backend = back
+0001b970: 656e 6473 2e4c 6f63 616c 446f 636b 6572  ends.LocalDocker
+0001b980: 4261 636b 656e 6428 290a 2020 2020 656c  Backend().    el
+0001b990: 7365 3a0a 2020 2020 2020 2020 7261 6973  se:.        rais
+0001b9a0: 6520 4e6f 7449 6d70 6c65 6d65 6e74 6564  e NotImplemented
+0001b9b0: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+0001b9c0: 2020 2066 2748 616e 646c 6520 7479 7065     f'Handle type
+0001b9d0: 207b 7479 7065 2868 616e 646c 6529 7d20   {type(handle)} 
+0001b9e0: 6973 206e 6f74 2073 7570 706f 7274 6564  is not supported
+0001b9f0: 2079 6574 2e27 290a 2020 2020 7265 7475   yet.').    retu
+0001ba00: 726e 2062 6163 6b65 6e64 0a0a 0a64 6566  rn backend...def
+0001ba10: 2067 6574 5f74 6173 6b5f 6465 6d61 6e64   get_task_demand
+0001ba20: 735f 6469 6374 2874 6173 6b3a 2027 7461  s_dict(task: 'ta
+0001ba30: 736b 5f6c 6962 2e54 6173 6b27 2920 2d3e  sk_lib.Task') ->
+0001ba40: 2044 6963 745b 7374 722c 2066 6c6f 6174   Dict[str, float
+0001ba50: 5d3a 0a20 2020 2022 2222 5265 7475 726e  ]:.    """Return
+0001ba60: 7320 7468 6520 7265 736f 7572 6365 7320  s the resources 
+0001ba70: 6469 6374 206f 6620 7468 6520 7461 736b  dict of the task
+0001ba80: 2e0a 0a20 2020 2052 6574 7572 6e73 3a0a  ...    Returns:.
+0001ba90: 2020 2020 2020 2020 4120 6469 6374 206f          A dict o
+0001baa0: 6620 7468 6520 7265 736f 7572 6365 7320  f the resources 
+0001bab0: 6f66 2074 6865 2074 6173 6b2e 2054 6865  of the task. The
+0001bac0: 206b 6579 7320 6172 6520 7468 6520 7265   keys are the re
+0001bad0: 736f 7572 6365 206e 616d 6573 0a20 2020  source names.   
+0001bae0: 2020 2020 2061 6e64 2074 6865 2076 616c       and the val
+0001baf0: 7565 7320 6172 6520 7468 6520 6e75 6d62  ues are the numb
+0001bb00: 6572 206f 6620 7468 6520 7265 736f 7572  er of the resour
+0001bb10: 6365 732e 2049 7420 616c 7761 7973 2063  ces. It always c
+0001bb20: 6f6e 7461 696e 730a 2020 2020 2020 2020  ontains.        
+0001bb30: 7468 6520 4350 5520 7265 736f 7572 6365  the CPU resource
+0001bb40: 2028 746f 2063 6f6e 7472 6f6c 2074 6865   (to control the
+0001bb50: 206d 6178 696d 756d 206e 756d 6265 7220   maximum number 
+0001bb60: 6f66 2074 6173 6b73 292c 2061 6e64 0a20  of tasks), and. 
+0001bb70: 2020 2020 2020 206f 7074 696f 6e61 6c6c         optionall
+0001bb80: 7920 6163 6365 6c65 7261 746f 7220 6465  y accelerator de
+0001bb90: 6d61 6e64 732e 0a20 2020 2022 2222 0a20  mands..    """. 
+0001bba0: 2020 2023 2054 4f44 4f3a 2043 7573 746f     # TODO: Custo
+0001bbb0: 6d20 4350 5520 616e 6420 6f74 6865 7220  m CPU and other 
+0001bbc0: 6d65 6d6f 7279 2072 6573 6f75 7263 6573  memory resources
+0001bbd0: 2061 7265 206e 6f74 2073 7570 706f 7274   are not support
+0001bbe0: 6564 2079 6574 2e0a 2020 2020 2320 466f  ed yet..    # Fo
+0001bbf0: 7220 736b 7920 6a6f 6273 2f73 6572 7665  r sky jobs/serve
+0001bc00: 2063 6f6e 7472 6f6c 6c65 7220 7461 736b   controller task
+0001bc10: 2c20 7765 2073 6574 2074 6865 2043 5055  , we set the CPU
+0001bc20: 2072 6573 6f75 7263 6520 746f 2061 2073   resource to a s
+0001bc30: 6d61 6c6c 6572 0a20 2020 2023 2076 616c  maller.    # val
+0001bc40: 7565 2074 6f20 7375 7070 6f72 7420 6120  ue to support a 
+0001bc50: 6c61 7267 6572 206e 756d 6265 7220 6f66  larger number of
+0001bc60: 206d 616e 6167 6564 206a 6f62 7320 616e   managed jobs an
+0001bc70: 6420 7365 7276 6963 6573 2e0a 2020 2020  d services..    
+0001bc80: 7265 736f 7572 6365 735f 6469 6374 203d  resources_dict =
+0001bc90: 207b 0a20 2020 2020 2020 2027 4350 5527   {.        'CPU'
+0001bca0: 3a20 2863 6f6e 7374 616e 7473 2e43 4f4e  : (constants.CON
+0001bcb0: 5452 4f4c 4c45 525f 5052 4f43 4553 535f  TROLLER_PROCESS_
+0001bcc0: 4350 555f 4445 4d41 4e44 0a20 2020 2020  CPU_DEMAND.     
+0001bcd0: 2020 2020 2020 2020 2020 2069 6620 7461             if ta
+0001bce0: 736b 2e69 735f 636f 6e74 726f 6c6c 6572  sk.is_controller
+0001bcf0: 5f74 6173 6b28 2920 656c 7365 2044 4546  _task() else DEF
+0001bd00: 4155 4c54 5f54 4153 4b5f 4350 555f 4445  AULT_TASK_CPU_DE
+0001bd10: 4d41 4e44 290a 2020 2020 7d0a 2020 2020  MAND).    }.    
+0001bd20: 6966 2074 6173 6b2e 6265 7374 5f72 6573  if task.best_res
+0001bd30: 6f75 7263 6573 2069 7320 6e6f 7420 4e6f  ources is not No
+0001bd40: 6e65 3a0a 2020 2020 2020 2020 7265 736f  ne:.        reso
+0001bd50: 7572 6365 7320 3d20 7461 736b 2e62 6573  urces = task.bes
+0001bd60: 745f 7265 736f 7572 6365 730a 2020 2020  t_resources.    
+0001bd70: 656c 7365 3a0a 2020 2020 2020 2020 2320  else:.        # 
+0001bd80: 5461 736b 206d 6179 2028 652e 672e 2c20  Task may (e.g., 
+0001bd90: 736b 7920 6c61 756e 6368 2920 6f72 206d  sky launch) or m
+0001bda0: 6179 206e 6f74 2028 652e 672e 2c20 736b  ay not (e.g., sk
+0001bdb0: 7920 6578 6563 2920 6861 7665 2075 6e64  y exec) have und
+0001bdc0: 6572 676f 6e65 0a20 2020 2020 2020 2023  ergone.        #
+0001bdd0: 2073 6b79 2e6f 7074 696d 697a 6528 292c   sky.optimize(),
+0001bde0: 2073 6f20 6265 7374 5f72 6573 6f75 7263   so best_resourc
+0001bdf0: 6573 206d 6179 2062 6520 4e6f 6e65 2e0a  es may be None..
+0001be00: 2020 2020 2020 2020 6173 7365 7274 206c          assert l
+0001be10: 656e 2874 6173 6b2e 7265 736f 7572 6365  en(task.resource
+0001be20: 7329 203d 3d20 312c 2074 6173 6b2e 7265  s) == 1, task.re
+0001be30: 736f 7572 6365 730a 2020 2020 2020 2020  sources.        
+0001be40: 7265 736f 7572 6365 7320 3d20 6c69 7374  resources = list
+0001be50: 2874 6173 6b2e 7265 736f 7572 6365 7329  (task.resources)
+0001be60: 5b30 5d0a 2020 2020 6966 2072 6573 6f75  [0].    if resou
+0001be70: 7263 6573 2069 7320 6e6f 7420 4e6f 6e65  rces is not None
+0001be80: 2061 6e64 2072 6573 6f75 7263 6573 2e61   and resources.a
+0001be90: 6363 656c 6572 6174 6f72 7320 6973 206e  ccelerators is n
+0001bea0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+0001beb0: 2072 6573 6f75 7263 6573 5f64 6963 742e   resources_dict.
+0001bec0: 7570 6461 7465 2872 6573 6f75 7263 6573  update(resources
+0001bed0: 2e61 6363 656c 6572 6174 6f72 7329 0a20  .accelerators). 
+0001bee0: 2020 2072 6574 7572 6e20 7265 736f 7572     return resour
+0001bef0: 6365 735f 6469 6374 0a0a 0a64 6566 2067  ces_dict...def g
+0001bf00: 6574 5f74 6173 6b5f 7265 736f 7572 6365  et_task_resource
+0001bf10: 735f 7374 7228 7461 736b 3a20 2774 6173  s_str(task: 'tas
+0001bf20: 6b5f 6c69 622e 5461 736b 272c 0a20 2020  k_lib.Task',.   
+0001bf30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bf40: 2020 2020 2020 2020 6973 5f6d 616e 6167          is_manag
+0001bf50: 6564 5f6a 6f62 3a20 626f 6f6c 203d 2046  ed_job: bool = F
+0001bf60: 616c 7365 2920 2d3e 2073 7472 3a0a 2020  alse) -> str:.  
+0001bf70: 2020 2222 2252 6574 7572 6e73 2074 6865    """Returns the
+0001bf80: 2072 6573 6f75 7263 6573 2073 7472 696e   resources strin
+0001bf90: 6720 6f66 2074 6865 2074 6173 6b2e 0a0a  g of the task...
+0001bfa0: 2020 2020 5468 6520 7265 736f 7572 6365      The resource
+0001bfb0: 7320 7374 7269 6e67 2069 7320 6f6e 6c79  s string is only
+0001bfc0: 2075 7365 6420 6173 2061 2064 6973 706c   used as a displ
+0001bfd0: 6179 2070 7572 706f 7365 2c20 736f 2077  ay purpose, so w
+0001bfe0: 6520 6f6e 6c79 2073 686f 770a 2020 2020  e only show.    
+0001bff0: 7468 6520 6163 6365 6c65 7261 746f 7220  the accelerator 
+0001c000: 6465 6d61 6e64 7320 2869 6620 616e 7929  demands (if any)
+0001c010: 2e20 4f74 6865 7277 6973 652c 2074 6865  . Otherwise, the
+0001c020: 2043 5055 2064 656d 616e 6420 6973 2073   CPU demand is s
+0001c030: 686f 776e 2e0a 2020 2020 2222 220a 2020  hown..    """.  
+0001c040: 2020 7370 6f74 5f73 7472 203d 2027 270a    spot_str = ''.
+0001c050: 2020 2020 7461 736b 5f63 7075 5f64 656d      task_cpu_dem
+0001c060: 616e 6420 3d20 2873 7472 2863 6f6e 7374  and = (str(const
+0001c070: 616e 7473 2e43 4f4e 5452 4f4c 4c45 525f  ants.CONTROLLER_
+0001c080: 5052 4f43 4553 535f 4350 555f 4445 4d41  PROCESS_CPU_DEMA
+0001c090: 4e44 290a 2020 2020 2020 2020 2020 2020  ND).            
+0001c0a0: 2020 2020 2020 2020 2020 2069 6620 7461             if ta
+0001c0b0: 736b 2e69 735f 636f 6e74 726f 6c6c 6572  sk.is_controller
+0001c0c0: 5f74 6173 6b28 2920 656c 7365 0a20 2020  _task() else.   
+0001c0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c0e0: 2020 2020 7374 7228 4445 4641 554c 545f      str(DEFAULT_
+0001c0f0: 5441 534b 5f43 5055 5f44 454d 414e 4429  TASK_CPU_DEMAND)
+0001c100: 290a 2020 2020 6966 2074 6173 6b2e 6265  ).    if task.be
+0001c110: 7374 5f72 6573 6f75 7263 6573 2069 7320  st_resources is 
+0001c120: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+0001c130: 2020 6163 6365 6c65 7261 746f 725f 6469    accelerator_di
+0001c140: 6374 203d 2074 6173 6b2e 6265 7374 5f72  ct = task.best_r
+0001c150: 6573 6f75 7263 6573 2e61 6363 656c 6572  esources.acceler
+0001c160: 6174 6f72 730a 2020 2020 2020 2020 6966  ators.        if
+0001c170: 2069 735f 6d61 6e61 6765 645f 6a6f 623a   is_managed_job:
+0001c180: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0001c190: 7461 736b 2e62 6573 745f 7265 736f 7572  task.best_resour
+0001c1a0: 6365 732e 7573 655f 7370 6f74 3a0a 2020  ces.use_spot:.  
+0001c1b0: 2020 2020 2020 2020 2020 2020 2020 7370                sp
+0001c1c0: 6f74 5f73 7472 203d 2027 5b53 706f 745d  ot_str = '[Spot]
+0001c1d0: 270a 2020 2020 2020 2020 2020 2020 7461  '.            ta
+0001c1e0: 736b 5f63 7075 5f64 656d 616e 6420 3d20  sk_cpu_demand = 
+0001c1f0: 7461 736b 2e62 6573 745f 7265 736f 7572  task.best_resour
+0001c200: 6365 732e 6370 7573 0a20 2020 2020 2020  ces.cpus.       
+0001c210: 2069 6620 6163 6365 6c65 7261 746f 725f   if accelerator_
+0001c220: 6469 6374 2069 7320 4e6f 6e65 3a0a 2020  dict is None:.  
+0001c230: 2020 2020 2020 2020 2020 7265 736f 7572            resour
+0001c240: 6365 735f 7374 7220 3d20 6627 4350 553a  ces_str = f'CPU:
+0001c250: 7b74 6173 6b5f 6370 755f 6465 6d61 6e64  {task_cpu_demand
+0001c260: 7d27 0a20 2020 2020 2020 2065 6c73 653a  }'.        else:
+0001c270: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+0001c280: 6f75 7263 6573 5f73 7472 203d 2027 2c20  ources_str = ', 
+0001c290: 272e 6a6f 696e 280a 2020 2020 2020 2020  '.join(.        
+0001c2a0: 2020 2020 2020 2020 6627 7b6b 7d3a 7b76          f'{k}:{v
+0001c2b0: 7d27 2066 6f72 206b 2c20 7620 696e 2061  }' for k, v in a
+0001c2c0: 6363 656c 6572 6174 6f72 5f64 6963 742e  ccelerator_dict.
+0001c2d0: 6974 656d 7328 2929 0a20 2020 2065 6c73  items()).    els
+0001c2e0: 653a 0a20 2020 2020 2020 2072 6573 6f75  e:.        resou
+0001c2f0: 7263 655f 6163 6365 6c65 7261 746f 7273  rce_accelerators
+0001c300: 203d 205b 5d0a 2020 2020 2020 2020 6d69   = [].        mi
+0001c310: 6e5f 6370 7573 203d 2066 6c6f 6174 2827  n_cpus = float('
+0001c320: 696e 6627 290a 2020 2020 2020 2020 7370  inf').        sp
+0001c330: 6f74 5f74 7970 653a 2053 6574 5b73 7472  ot_type: Set[str
+0001c340: 5d20 3d20 7365 7428 290a 2020 2020 2020  ] = set().      
+0001c350: 2020 666f 7220 7265 736f 7572 6365 2069    for resource i
+0001c360: 6e20 7461 736b 2e72 6573 6f75 7263 6573  n task.resources
+0001c370: 3a0a 2020 2020 2020 2020 2020 2020 7461  :.            ta
+0001c380: 736b 5f63 7075 5f64 656d 616e 6420 3d20  sk_cpu_demand = 
+0001c390: 2731 2b27 0a20 2020 2020 2020 2020 2020  '1+'.           
+0001c3a0: 2069 6620 7265 736f 7572 6365 2e63 7075   if resource.cpu
+0001c3b0: 7320 6973 206e 6f74 204e 6f6e 653a 0a20  s is not None:. 
+0001c3c0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0001c3d0: 6173 6b5f 6370 755f 6465 6d61 6e64 203d  ask_cpu_demand =
+0001c3e0: 2072 6573 6f75 7263 652e 6370 7573 0a20   resource.cpus. 
+0001c3f0: 2020 2020 2020 2020 2020 206d 696e 5f63             min_c
+0001c400: 7075 7320 3d20 6d69 6e28 6d69 6e5f 6370  pus = min(min_cp
+0001c410: 7573 2c20 666c 6f61 7428 7461 736b 5f63  us, float(task_c
+0001c420: 7075 5f64 656d 616e 642e 7374 7269 7028  pu_demand.strip(
+0001c430: 272b 2027 2929 290a 2020 2020 2020 2020  '+ '))).        
+0001c440: 2020 2020 6966 2072 6573 6f75 7263 652e      if resource.
+0001c450: 7573 655f 7370 6f74 3a0a 2020 2020 2020  use_spot:.      
+0001c460: 2020 2020 2020 2020 2020 7370 6f74 5f74            spot_t
+0001c470: 7970 652e 6164 6428 2753 706f 7427 290a  ype.add('Spot').
+0001c480: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0001c490: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001c4a0: 2020 7370 6f74 5f74 7970 652e 6164 6428    spot_type.add(
+0001c4b0: 274f 6e2d 6465 6d61 6e64 2729 0a0a 2020  'On-demand')..  
+0001c4c0: 2020 2020 2020 2020 2020 6966 2072 6573            if res
+0001c4d0: 6f75 7263 652e 6163 6365 6c65 7261 746f  ource.accelerato
+0001c4e0: 7273 2069 7320 4e6f 6e65 3a0a 2020 2020  rs is None:.    
+0001c4f0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+0001c500: 696e 7565 0a20 2020 2020 2020 2020 2020  inue.           
+0001c510: 2066 6f72 206b 2c20 7620 696e 2072 6573   for k, v in res
+0001c520: 6f75 7263 652e 6163 6365 6c65 7261 746f  ource.accelerato
+0001c530: 7273 2e69 7465 6d73 2829 3a0a 2020 2020  rs.items():.    
+0001c540: 2020 2020 2020 2020 2020 2020 7265 736f              reso
+0001c550: 7572 6365 5f61 6363 656c 6572 6174 6f72  urce_accelerator
+0001c560: 732e 6170 7065 6e64 2866 277b 6b7d 3a7b  s.append(f'{k}:{
+0001c570: 767d 2729 0a0a 2020 2020 2020 2020 6966  v}')..        if
+0001c580: 2069 735f 6d61 6e61 6765 645f 6a6f 623a   is_managed_job:
+0001c590: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0001c5a0: 6c65 6e28 7461 736b 2e72 6573 6f75 7263  len(task.resourc
+0001c5b0: 6573 2920 3e20 313a 0a20 2020 2020 2020  es) > 1:.       
+0001c5c0: 2020 2020 2020 2020 2074 6173 6b5f 6370           task_cp
+0001c5d0: 755f 6465 6d61 6e64 203d 2066 277b 6d69  u_demand = f'{mi
+0001c5e0: 6e5f 6370 7573 7d2b 270a 2020 2020 2020  n_cpus}+'.      
+0001c5f0: 2020 2020 2020 6966 2027 5370 6f74 2720        if 'Spot' 
+0001c600: 696e 2073 706f 745f 7479 7065 3a0a 2020  in spot_type:.  
+0001c610: 2020 2020 2020 2020 2020 2020 2020 7370                sp
+0001c620: 6f74 5f73 7472 203d 2027 7c27 2e6a 6f69  ot_str = '|'.joi
+0001c630: 6e28 736f 7274 6564 2873 706f 745f 7479  n(sorted(spot_ty
+0001c640: 7065 2929 0a20 2020 2020 2020 2020 2020  pe)).           
+0001c650: 2020 2020 2073 706f 745f 7374 7220 3d20       spot_str = 
+0001c660: 6627 5b7b 7370 6f74 5f73 7472 7d5d 270a  f'[{spot_str}]'.
+0001c670: 2020 2020 2020 2020 6966 2072 6573 6f75          if resou
+0001c680: 7263 655f 6163 6365 6c65 7261 746f 7273  rce_accelerators
+0001c690: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0001c6a0: 736f 7572 6365 735f 7374 7220 3d20 272c  sources_str = ',
+0001c6b0: 2027 2e6a 6f69 6e28 7365 7428 7265 736f   '.join(set(reso
+0001c6c0: 7572 6365 5f61 6363 656c 6572 6174 6f72  urce_accelerator
+0001c6d0: 7329 290a 2020 2020 2020 2020 656c 7365  s)).        else
+0001c6e0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0001c6f0: 736f 7572 6365 735f 7374 7220 3d20 6627  sources_str = f'
+0001c700: 4350 553a 7b74 6173 6b5f 6370 755f 6465  CPU:{task_cpu_de
+0001c710: 6d61 6e64 7d27 0a20 2020 2072 6573 6f75  mand}'.    resou
+0001c720: 7263 6573 5f73 7472 203d 2066 277b 7461  rces_str = f'{ta
+0001c730: 736b 2e6e 756d 5f6e 6f64 6573 7d78 5b7b  sk.num_nodes}x[{
+0001c740: 7265 736f 7572 6365 735f 7374 727d 5d7b  resources_str}]{
+0001c750: 7370 6f74 5f73 7472 7d27 0a20 2020 2072  spot_str}'.    r
+0001c760: 6574 7572 6e20 7265 736f 7572 6365 735f  eturn resources_
+0001c770: 7374 720a 0a0a 2320 4861 6e64 6c65 2063  str...# Handle c
+0001c780: 7472 6c2d 630a 6465 6620 696e 7465 7272  trl-c.def interr
+0001c790: 7570 745f 6861 6e64 6c65 7228 7369 676e  upt_handler(sign
+0001c7a0: 756d 2c20 6672 616d 6529 3a0a 2020 2020  um, frame):.    
+0001c7b0: 6465 6c20 7369 676e 756d 2c20 6672 616d  del signum, fram
+0001c7c0: 650a 2020 2020 7375 6270 726f 6365 7373  e.    subprocess
+0001c7d0: 5f75 7469 6c73 2e6b 696c 6c5f 6368 696c  _utils.kill_chil
+0001c7e0: 6472 656e 5f70 726f 6365 7373 6573 2829  dren_processes()
+0001c7f0: 0a20 2020 2023 2041 766f 6964 2075 7369  .    # Avoid usi
+0001c800: 6e67 206c 6f67 6765 7220 6865 7265 2c20  ng logger here, 
+0001c810: 6173 2069 7420 7769 6c6c 2070 7269 6e74  as it will print
+0001c820: 2074 6865 2073 7461 636b 2074 7261 6365   the stack trace
+0001c830: 2066 6f72 2062 726f 6b65 6e0a 2020 2020   for broken.    
+0001c840: 2320 7069 7065 2c20 7768 656e 2074 6865  # pipe, when the
+0001c850: 206f 7574 7075 7420 6973 2070 6970 6564   output is piped
+0001c860: 2074 6f20 616e 6f74 6865 7220 7072 6f67   to another prog
+0001c870: 7261 6d2e 0a20 2020 2070 7269 6e74 2866  ram..    print(f
+0001c880: 277b 636f 6c6f 7261 6d61 2e53 7479 6c65  '{colorama.Style
+0001c890: 2e44 494d 7d54 6970 3a20 5468 6520 6a6f  .DIM}Tip: The jo
+0001c8a0: 6220 7769 6c6c 206b 6565 7020 270a 2020  b will keep '.  
+0001c8b0: 2020 2020 2020 2020 6627 7275 6e6e 696e          f'runnin
+0001c8c0: 6720 6166 7465 7220 4374 726c 2d43 2e7b  g after Ctrl-C.{
+0001c8d0: 636f 6c6f 7261 6d61 2e53 7479 6c65 2e52  colorama.Style.R
+0001c8e0: 4553 4554 5f41 4c4c 7d27 290a 2020 2020  ESET_ALL}').    
+0001c8f0: 7769 7468 2075 785f 7574 696c 732e 7072  with ux_utils.pr
+0001c900: 696e 745f 6578 6365 7074 696f 6e5f 6e6f  int_exception_no
+0001c910: 5f74 7261 6365 6261 636b 2829 3a0a 2020  _traceback():.  
+0001c920: 2020 2020 2020 7261 6973 6520 4b65 7962        raise Keyb
+0001c930: 6f61 7264 496e 7465 7272 7570 7428 6578  oardInterrupt(ex
+0001c940: 6365 7074 696f 6e73 2e4b 4559 424f 4152  ceptions.KEYBOAR
+0001c950: 445f 494e 5445 5252 5550 545f 434f 4445  D_INTERRUPT_CODE
+0001c960: 290a 0a0a 2320 4861 6e64 6c65 2063 7472  )...# Handle ctr
+0001c970: 6c2d 7a0a 6465 6620 7374 6f70 5f68 616e  l-z.def stop_han
+0001c980: 646c 6572 2873 6967 6e75 6d2c 2066 7261  dler(signum, fra
+0001c990: 6d65 293a 0a20 2020 2064 656c 2073 6967  me):.    del sig
+0001c9a0: 6e75 6d2c 2066 7261 6d65 0a20 2020 2073  num, frame.    s
+0001c9b0: 7562 7072 6f63 6573 735f 7574 696c 732e  ubprocess_utils.
+0001c9c0: 6b69 6c6c 5f63 6869 6c64 7265 6e5f 7072  kill_children_pr
+0001c9d0: 6f63 6573 7365 7328 290a 2020 2020 2320  ocesses().    # 
+0001c9e0: 4176 6f69 6420 7573 696e 6720 6c6f 6767  Avoid using logg
+0001c9f0: 6572 2068 6572 652c 2061 7320 6974 2077  er here, as it w
+0001ca00: 696c 6c20 7072 696e 7420 7468 6520 7374  ill print the st
+0001ca10: 6163 6b20 7472 6163 6520 666f 7220 6272  ack trace for br
+0001ca20: 6f6b 656e 0a20 2020 2023 2070 6970 652c  oken.    # pipe,
+0001ca30: 2077 6865 6e20 7468 6520 6f75 7470 7574   when the output
+0001ca40: 2069 7320 7069 7065 6420 746f 2061 6e6f   is piped to ano
+0001ca50: 7468 6572 2070 726f 6772 616d 2e0a 2020  ther program..  
+0001ca60: 2020 7072 696e 7428 6627 7b63 6f6c 6f72    print(f'{color
+0001ca70: 616d 612e 5374 796c 652e 4449 4d7d 5469  ama.Style.DIM}Ti
+0001ca80: 703a 2054 6865 206a 6f62 2077 696c 6c20  p: The job will 
+0001ca90: 6b65 6570 2027 0a20 2020 2020 2020 2020  keep '.         
+0001caa0: 2066 2772 756e 6e69 6e67 2061 6674 6572   f'running after
+0001cab0: 2043 7472 6c2d 5a2e 7b63 6f6c 6f72 616d   Ctrl-Z.{coloram
+0001cac0: 612e 5374 796c 652e 5245 5345 545f 414c  a.Style.RESET_AL
+0001cad0: 4c7d 2729 0a20 2020 2077 6974 6820 7578  L}').    with ux
+0001cae0: 5f75 7469 6c73 2e70 7269 6e74 5f65 7863  _utils.print_exc
+0001caf0: 6570 7469 6f6e 5f6e 6f5f 7472 6163 6562  eption_no_traceb
+0001cb00: 6163 6b28 293a 0a20 2020 2020 2020 2072  ack():.        r
+0001cb10: 6169 7365 204b 6579 626f 6172 6449 6e74  aise KeyboardInt
+0001cb20: 6572 7275 7074 2865 7863 6570 7469 6f6e  errupt(exception
+0001cb30: 732e 5349 4754 5354 505f 434f 4445 290a  s.SIGTSTP_CODE).
+0001cb40: 0a0a 6465 6620 7275 6e5f 636f 6d6d 616e  ..def run_comman
+0001cb50: 645f 616e 645f 6861 6e64 6c65 5f73 7368  d_and_handle_ssh
+0001cb60: 5f66 6169 6c75 7265 2872 756e 6e65 723a  _failure(runner:
+0001cb70: 2063 6f6d 6d61 6e64 5f72 756e 6e65 722e   command_runner.
+0001cb80: 5353 4843 6f6d 6d61 6e64 5275 6e6e 6572  SSHCommandRunner
+0001cb90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001cba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cbb0: 2020 2020 2020 2020 2063 6f6d 6d61 6e64           command
+0001cbc0: 3a20 7374 722c 0a20 2020 2020 2020 2020  : str,.         
+0001cbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cbe0: 2020 2020 2020 2020 2020 2020 2020 6661                fa
+0001cbf0: 696c 7572 655f 6d65 7373 6167 653a 2073  ilure_message: s
+0001cc00: 7472 2920 2d3e 2073 7472 3a0a 2020 2020  tr) -> str:.    
+0001cc10: 2222 2252 756e 7320 636f 6d6d 616e 6420  """Runs command 
+0001cc20: 7265 6d6f 7465 6c79 2061 6e64 2072 6574  remotely and ret
+0001cc30: 7572 6e73 206f 7574 7075 7420 7769 7468  urns output with
+0001cc40: 2070 726f 7065 7220 6572 726f 7220 6861   proper error ha
+0001cc50: 6e64 6c69 6e67 2e22 2222 0a20 2020 2072  ndling.""".    r
+0001cc60: 632c 2073 7464 6f75 742c 2073 7464 6572  c, stdout, stder
+0001cc70: 7220 3d20 7275 6e6e 6572 2e72 756e 2863  r = runner.run(c
+0001cc80: 6f6d 6d61 6e64 2c0a 2020 2020 2020 2020  ommand,.        
+0001cc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cca0: 2020 2020 2020 2020 2020 2020 7265 7175              requ
+0001ccb0: 6972 655f 6f75 7470 7574 733d 5472 7565  ire_outputs=True
+0001ccc0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001ccd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cce0: 2020 2020 2020 7374 7265 616d 5f6c 6f67        stream_log
+0001ccf0: 733d 4661 6c73 6529 0a20 2020 2069 6620  s=False).    if 
+0001cd00: 7263 203d 3d20 3235 353a 0a20 2020 2020  rc == 255:.     
+0001cd10: 2020 2023 2053 5348 2066 6169 6c65 640a     # SSH failed.
+0001cd20: 2020 2020 2020 2020 7261 6973 6520 5275          raise Ru
+0001cd30: 6e74 696d 6545 7272 6f72 280a 2020 2020  ntimeError(.    
+0001cd40: 2020 2020 2020 2020 6627 5353 4820 7769          f'SSH wi
+0001cd50: 7468 2075 7365 7220 7b72 756e 6e65 722e  th user {runner.
+0001cd60: 7373 685f 7573 6572 7d20 616e 6420 6b65  ssh_user} and ke
+0001cd70: 7920 7b72 756e 6e65 722e 7373 685f 7072  y {runner.ssh_pr
+0001cd80: 6976 6174 655f 6b65 797d 2027 0a20 2020  ivate_key} '.   
+0001cd90: 2020 2020 2020 2020 2066 2774 6f20 7b72           f'to {r
+0001cda0: 756e 6e65 722e 6970 7d20 6661 696c 6564  unner.ip} failed
+0001cdb0: 2e20 5468 6973 2069 7320 6d6f 7374 206c  . This is most l
+0001cdc0: 696b 656c 7920 6475 6520 746f 2069 6e63  ikely due to inc
+0001cdd0: 6f72 7265 6374 2027 0a20 2020 2020 2020  orrect '.       
+0001cde0: 2020 2020 2027 6372 6564 656e 7469 616c       'credential
+0001cdf0: 7320 6f72 2069 6e63 6f72 7265 6374 2070  s or incorrect p
+0001ce00: 6572 6d69 7373 696f 6e73 2066 6f72 2074  ermissions for t
+0001ce10: 6865 206b 6579 2066 696c 652e 2043 6865  he key file. Che
+0001ce20: 636b 2027 0a20 2020 2020 2020 2020 2020  ck '.           
+0001ce30: 2027 796f 7572 2063 7265 6465 6e74 6961   'your credentia
+0001ce40: 6c73 2061 6e64 2074 7279 2061 6761 696e  ls and try again
+0001ce50: 2e27 290a 2020 2020 7375 6270 726f 6365  .').    subproce
+0001ce60: 7373 5f75 7469 6c73 2e68 616e 646c 655f  ss_utils.handle_
+0001ce70: 7265 7475 726e 636f 6465 2872 632c 0a20  returncode(rc,. 
+0001ce80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ce90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cea0: 2020 2020 2020 636f 6d6d 616e 642c 0a20        command,. 
+0001ceb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ced0: 2020 2020 2020 6661 696c 7572 655f 6d65        failure_me
+0001cee0: 7373 6167 652c 0a20 2020 2020 2020 2020  ssage,.         
+0001cef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cf00: 2020 2020 2020 2020 2020 2020 2020 7374                st
+0001cf10: 6465 7272 3d73 7464 6572 7229 0a20 2020  derr=stderr).   
+0001cf20: 2072 6574 7572 6e20 7374 646f 7574 0a0a   return stdout..
+0001cf30: 0a64 6566 2063 6865 636b 5f72 7379 6e63  .def check_rsync
+0001cf40: 5f69 6e73 7461 6c6c 6564 2829 202d 3e20  _installed() -> 
+0001cf50: 4e6f 6e65 3a0a 2020 2020 2222 2243 6865  None:.    """Che
+0001cf60: 636b 7320 6966 2072 7379 6e63 2069 7320  cks if rsync is 
+0001cf70: 696e 7374 616c 6c65 642e 0a0a 2020 2020  installed...    
+0001cf80: 5261 6973 6573 3a0a 2020 2020 2020 2020  Raises:.        
+0001cf90: 5275 6e74 696d 6545 7272 6f72 3a20 6966  RuntimeError: if
+0001cfa0: 2072 7379 6e63 2069 7320 6e6f 7420 696e   rsync is not in
+0001cfb0: 7374 616c 6c65 6420 696e 2074 6865 206d  stalled in the m
+0001cfc0: 6163 6869 6e65 2e0a 2020 2020 2222 220a  achine..    """.
+0001cfd0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0001cfe0: 2073 7562 7072 6f63 6573 732e 7275 6e28   subprocess.run(
+0001cff0: 2772 7379 6e63 202d 2d76 6572 7369 6f6e  'rsync --version
+0001d000: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+0001d010: 2020 2020 2020 2020 2020 7368 656c 6c3d            shell=
+0001d020: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
+0001d030: 2020 2020 2020 2020 2020 2020 2063 6865               che
+0001d040: 636b 3d54 7275 652c 0a20 2020 2020 2020  ck=True,.       
+0001d050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d060: 7374 646f 7574 3d73 7562 7072 6f63 6573  stdout=subproces
+0001d070: 732e 5049 5045 2c0a 2020 2020 2020 2020  s.PIPE,.        
+0001d080: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0001d090: 7464 6572 723d 7375 6270 726f 6365 7373  tderr=subprocess
+0001d0a0: 2e50 4950 4529 0a20 2020 2065 7863 6570  .PIPE).    excep
+0001d0b0: 7420 7375 6270 726f 6365 7373 2e43 616c  t subprocess.Cal
+0001d0c0: 6c65 6450 726f 6365 7373 4572 726f 723a  ledProcessError:
+0001d0d0: 0a20 2020 2020 2020 2077 6974 6820 7578  .        with ux
+0001d0e0: 5f75 7469 6c73 2e70 7269 6e74 5f65 7863  _utils.print_exc
+0001d0f0: 6570 7469 6f6e 5f6e 6f5f 7472 6163 6562  eption_no_traceb
+0001d100: 6163 6b28 293a 0a20 2020 2020 2020 2020  ack():.         
+0001d110: 2020 2072 6169 7365 2052 756e 7469 6d65     raise Runtime
+0001d120: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+0001d130: 2020 2020 2020 2027 6072 7379 6e63 6020         '`rsync` 
+0001d140: 6973 2072 6571 7569 7265 6420 666f 7220  is required for 
+0001d150: 7072 6f76 6973 696f 6e69 6e67 2061 6e64  provisioning and
+0001d160: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+0001d170: 2020 2720 6974 2069 7320 6e6f 7420 696e    ' it is not in
+0001d180: 7374 616c 6c65 642e 2046 6f72 2044 6562  stalled. For Deb
+0001d190: 6961 6e2f 5562 756e 7475 2073 7973 7465  ian/Ubuntu syste
+0001d1a0: 6d2c 2027 0a20 2020 2020 2020 2020 2020  m, '.           
+0001d1b0: 2020 2020 2027 696e 7374 616c 6c20 6974       'install it
+0001d1c0: 2077 6974 683a 5c6e 270a 2020 2020 2020   with:\n'.      
+0001d1d0: 2020 2020 2020 2020 2020 2720 2024 2073            '  $ s
+0001d1e0: 7564 6f20 6170 7420 696e 7374 616c 6c20  udo apt install 
+0001d1f0: 7273 796e 6327 2920 6672 6f6d 204e 6f6e  rsync') from Non
+0001d200: 650a 0a0a 6465 6620 6368 6563 6b5f 7374  e...def check_st
+0001d210: 616c 655f 7275 6e74 696d 655f 6f6e 5f72  ale_runtime_on_r
+0001d220: 656d 6f74 6528 7265 7475 726e 636f 6465  emote(returncode
+0001d230: 3a20 696e 742c 2073 7464 6572 723a 2073  : int, stderr: s
+0001d240: 7472 2c0a 2020 2020 2020 2020 2020 2020  tr,.            
+0001d250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d260: 2020 2020 2020 636c 7573 7465 725f 6e61        cluster_na
+0001d270: 6d65 3a20 7374 7229 202d 3e20 4e6f 6e65  me: str) -> None
+0001d280: 3a0a 2020 2020 2222 2252 6169 7365 7320  :.    """Raises 
+0001d290: 5275 6e74 696d 6545 7272 6f72 2069 6620  RuntimeError if 
+0001d2a0: 7265 6d6f 7465 2053 6b79 5069 6c6f 7420  remote SkyPilot 
+0001d2b0: 7275 6e74 696d 6520 6e65 6564 7320 746f  runtime needs to
+0001d2c0: 2062 6520 7570 6461 7465 642e 0a0a 2020   be updated...  
+0001d2d0: 2020 5765 2064 6574 6563 7420 7468 6973    We detect this
+0001d2e0: 2062 7920 7061 7273 696e 6720 6365 7274   by parsing cert
+0001d2f0: 6169 6e20 6261 636b 7761 7264 2d69 6e63  ain backward-inc
+0001d300: 6f6d 7061 7469 626c 6520 6572 726f 7220  ompatible error 
+0001d310: 6d65 7373 6167 6573 2066 726f 6d0a 2020  messages from.  
+0001d320: 2020 6073 7464 6572 7260 2e20 5479 7069    `stderr`. Typi
+0001d330: 6361 6c6c 7920 6475 6520 746f 2074 6865  cally due to the
+0001d340: 206c 6f63 616c 2063 6c69 656e 7420 7665   local client ve
+0001d350: 7273 696f 6e20 6a75 7374 2067 6f74 2075  rsion just got u
+0001d360: 7064 6174 6564 2c20 616e 640a 2020 2020  pdated, and.    
+0001d370: 7468 6520 7265 6d6f 7465 2072 756e 7469  the remote runti
+0001d380: 6d65 2069 7320 616e 206f 6c64 6572 2076  me is an older v
+0001d390: 6572 7369 6f6e 2e0a 2020 2020 2222 220a  ersion..    """.
+0001d3a0: 2020 2020 7061 7474 6572 6e20 3d20 7265      pattern = re
+0001d3b0: 2e63 6f6d 7069 6c65 2872 2741 7474 7269  .compile(r'Attri
+0001d3c0: 6275 7465 4572 726f 723a 206d 6f64 756c  buteError: modul
+0001d3d0: 6520 5c27 736b 795c 2e28 2e2a 295c 2720  e \'sky\.(.*)\' 
+0001d3e0: 6861 7320 6e6f 2027 0a20 2020 2020 2020  has no '.       
+0001d3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d400: 2020 7227 6174 7472 6962 7574 6520 5c27    r'attribute \'
+0001d410: 282e 2a29 5c27 2729 0a20 2020 2069 6620  (.*)\'').    if 
+0001d420: 7265 7475 726e 636f 6465 2021 3d20 303a  returncode != 0:
+0001d430: 0a20 2020 2020 2020 2061 7474 7269 6275  .        attribu
+0001d440: 7465 5f65 7272 6f72 203d 2072 652e 6669  te_error = re.fi
+0001d450: 6e64 616c 6c28 7061 7474 6572 6e2c 2073  ndall(pattern, s
+0001d460: 7464 6572 7229 0a20 2020 2020 2020 2069  tderr).        i
+0001d470: 6620 6174 7472 6962 7574 655f 6572 726f  f attribute_erro
+0001d480: 723a 0a20 2020 2020 2020 2020 2020 2077  r:.            w
+0001d490: 6974 6820 7578 5f75 7469 6c73 2e70 7269  ith ux_utils.pri
+0001d4a0: 6e74 5f65 7863 6570 7469 6f6e 5f6e 6f5f  nt_exception_no_
+0001d4b0: 7472 6163 6562 6163 6b28 293a 0a20 2020  traceback():.   
+0001d4c0: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+0001d4d0: 7365 2052 756e 7469 6d65 4572 726f 7228  se RuntimeError(
+0001d4e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d4f0: 2020 2020 2066 277b 636f 6c6f 7261 6d61       f'{colorama
+0001d500: 2e46 6f72 652e 5245 447d 536b 7950 696c  .Fore.RED}SkyPil
+0001d510: 6f74 2072 756e 7469 6d65 206e 6565 6473  ot runtime needs
+0001d520: 2074 6f20 6265 2075 7064 6174 6564 2027   to be updated '
+0001d530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d540: 2020 2020 2027 6f6e 2074 6865 2072 656d       'on the rem
+0001d550: 6f74 6520 636c 7573 7465 722e 2054 6f20  ote cluster. To 
+0001d560: 7570 6461 7465 2c20 7275 6e20 2865 7869  update, run (exi
+0001d570: 7374 696e 6720 6a6f 6273 2061 7265 2027  sting jobs are '
+0001d580: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d590: 2020 2020 2066 276e 6f74 2069 6e74 6572       f'not inter
+0001d5a0: 7275 7074 6564 293a 207b 636f 6c6f 7261  rupted): {colora
+0001d5b0: 6d61 2e53 7479 6c65 2e42 5249 4748 547d  ma.Style.BRIGHT}
+0001d5c0: 736b 7920 7374 6172 7420 2d66 202d 7920  sky start -f -y 
+0001d5d0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+0001d5e0: 2020 2020 2020 6627 7b63 6c75 7374 6572        f'{cluster
+0001d5f0: 5f6e 616d 657d 7b63 6f6c 6f72 616d 612e  _name}{colorama.
+0001d600: 5374 796c 652e 5245 5345 545f 414c 4c7d  Style.RESET_ALL}
+0001d610: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+0001d620: 2020 2020 2020 6627 5c6e 2d2d 2d20 4465        f'\n--- De
+0001d630: 7461 696c 7320 2d2d 2d5c 6e7b 7374 6465  tails ---\n{stde
+0001d640: 7272 2e73 7472 6970 2829 7d5c 6e27 290a  rr.strip()}\n').
+0001d650: 0a0a 6465 6620 6765 745f 656e 6470 6f69  ..def get_endpoi
+0001d660: 6e74 7328 636c 7573 7465 723a 2073 7472  nts(cluster: str
+0001d670: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001d680: 2020 2020 706f 7274 3a20 4f70 7469 6f6e      port: Option
+0001d690: 616c 5b55 6e69 6f6e 5b69 6e74 2c20 7374  al[Union[int, st
+0001d6a0: 725d 5d20 3d20 4e6f 6e65 2c0a 2020 2020  r]] = None,.    
+0001d6b0: 2020 2020 2020 2020 2020 2020 2020 736b                sk
+0001d6c0: 6970 5f73 7461 7475 735f 6368 6563 6b3a  ip_status_check:
+0001d6d0: 2062 6f6f 6c20 3d20 4661 6c73 6529 202d   bool = False) -
+0001d6e0: 3e20 4469 6374 5b69 6e74 2c20 7374 725d  > Dict[int, str]
+0001d6f0: 3a0a 2020 2020 2222 2247 6574 7320 7468  :.    """Gets th
+0001d700: 6520 656e 6470 6f69 6e74 2066 6f72 2061  e endpoint for a
+0001d710: 2067 6976 656e 2063 6c75 7374 6572 2061   given cluster a
+0001d720: 6e64 2070 6f72 7420 6e75 6d62 6572 2028  nd port number (
+0001d730: 656e 6470 6f69 6e74 292e 0a0a 2020 2020  endpoint)...    
+0001d740: 4172 6773 3a0a 2020 2020 2020 2020 636c  Args:.        cl
+0001d750: 7573 7465 723a 2054 6865 206e 616d 6520  uster: The name 
+0001d760: 6f66 2074 6865 2063 6c75 7374 6572 2e0a  of the cluster..
+0001d770: 2020 2020 2020 2020 706f 7274 3a20 5468          port: Th
+0001d780: 6520 706f 7274 206e 756d 6265 7220 746f  e port number to
+0001d790: 2067 6574 2074 6865 2065 6e64 706f 696e   get the endpoin
+0001d7a0: 7420 666f 722e 2049 6620 4e6f 6e65 2c20  t for. If None, 
+0001d7b0: 656e 6470 6f69 6e74 730a 2020 2020 2020  endpoints.      
+0001d7c0: 2020 2020 2020 666f 7220 616c 6c20 706f        for all po
+0001d7d0: 7274 7320 6172 6520 7265 7475 726e 6564  rts are returned
+0001d7e0: 2e0a 2020 2020 2020 2020 736b 6970 5f73  ..        skip_s
+0001d7f0: 7461 7475 735f 6368 6563 6b3a 2057 6865  tatus_check: Whe
+0001d800: 7468 6572 2074 6f20 736b 6970 2074 6865  ther to skip the
+0001d810: 2073 7461 7475 7320 6368 6563 6b20 666f   status check fo
+0001d820: 7220 7468 6520 636c 7573 7465 722e 0a20  r the cluster.. 
+0001d830: 2020 2020 2020 2020 2020 2054 6869 7320             This 
+0001d840: 6973 2075 7365 6675 6c20 7768 656e 2074  is useful when t
+0001d850: 6865 2063 6c75 7374 6572 2069 7320 6b6e  he cluster is kn
+0001d860: 6f77 6e20 746f 2062 6520 696e 2061 2049  own to be in a I
+0001d870: 4e49 5420 7374 6174 650a 2020 2020 2020  NIT state.      
+0001d880: 2020 2020 2020 616e 6420 7468 6520 6361        and the ca
+0001d890: 6c6c 6572 2077 616e 7473 2074 6f20 7175  ller wants to qu
+0001d8a0: 6572 7920 7468 6520 656e 6470 6f69 6e74  ery the endpoint
+0001d8b0: 732e 2055 7365 6420 6279 2073 6572 7665  s. Used by serve
+0001d8c0: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+0001d8d0: 7472 6f6c 6c65 7220 746f 2071 7565 7279  troller to query
+0001d8e0: 2065 6e64 706f 696e 7473 2064 7572 696e   endpoints durin
+0001d8f0: 6720 636c 7573 7465 7220 6c61 756e 6368  g cluster launch
+0001d900: 2077 6865 6e20 6d75 6c74 6970 6c65 0a20   when multiple. 
+0001d910: 2020 2020 2020 2020 2020 2073 6572 7669             servi
+0001d920: 6365 7320 6d61 7920 6265 2067 6574 7469  ces may be getti
+0001d930: 6e67 206c 6175 6e63 6865 6420 696e 2070  ng launched in p
+0001d940: 6172 616c 6c65 6c20 2861 6e64 2061 7320  arallel (and as 
+0001d950: 6120 7265 7375 6c74 2c0a 2020 2020 2020  a result,.      
+0001d960: 2020 2020 2020 7468 6520 636f 6e74 726f        the contro
+0001d970: 6c6c 6572 206d 6179 2062 6520 696e 2049  ller may be in I
+0001d980: 4e49 5420 7374 6174 7573 2064 7565 2074  NIT status due t
+0001d990: 6f20 6120 636f 6e63 7572 7265 6e74 206c  o a concurrent l
+0001d9a0: 6175 6e63 6829 2e0a 0a20 2020 2052 6574  aunch)...    Ret
+0001d9b0: 7572 6e73 3a20 4120 6469 6374 696f 6e61  urns: A dictiona
+0001d9c0: 7279 206f 6620 706f 7274 206e 756d 6265  ry of port numbe
+0001d9d0: 7273 2074 6f20 656e 6470 6f69 6e74 732e  rs to endpoints.
+0001d9e0: 2049 6620 656e 6470 6f69 6e74 2069 7320   If endpoint is 
+0001d9f0: 4e6f 6e65 2c0a 2020 2020 2020 2020 7468  None,.        th
+0001da00: 6520 6469 6374 696f 6e61 7279 2077 696c  e dictionary wil
+0001da10: 6c20 636f 6e74 6169 6e20 616c 6c20 706f  l contain all po
+0001da20: 7274 733a 656e 6470 6f69 6e74 7320 6578  rts:endpoints ex
+0001da30: 706f 7365 6420 6f6e 2074 6865 2063 6c75  posed on the clu
+0001da40: 7374 6572 2e0a 2020 2020 2020 2020 4966  ster..        If
+0001da50: 2074 6865 2065 6e64 706f 696e 7420 6973   the endpoint is
+0001da60: 206e 6f74 2065 7870 6f73 6564 2079 6574   not exposed yet
+0001da70: 2028 652e 672e 2c20 6475 7269 6e67 2063   (e.g., during c
+0001da80: 6c75 7374 6572 206c 6175 6e63 6820 6f72  luster launch or
+0001da90: 0a20 2020 2020 2020 2077 6169 7469 6e67  .        waiting
+0001daa0: 2066 6f72 2063 6c6f 7564 2070 726f 7669   for cloud provi
+0001dab0: 6465 7220 746f 2065 7870 6f73 6520 7468  der to expose th
+0001dac0: 6520 656e 6470 6f69 6e74 292c 2061 6e20  e endpoint), an 
+0001dad0: 656d 7074 7920 6469 6374 696f 6e61 7279  empty dictionary
+0001dae0: 0a20 2020 2020 2020 2069 7320 7265 7475  .        is retu
+0001daf0: 726e 6564 2e0a 0a20 2020 2052 6169 7365  rned...    Raise
+0001db00: 733a 0a20 2020 2020 2020 2056 616c 7565  s:.        Value
+0001db10: 4572 726f 723a 2069 6620 7468 6520 706f  Error: if the po
+0001db20: 7274 2069 7320 696e 7661 6c69 6420 6f72  rt is invalid or
+0001db30: 2074 6865 2063 6c6f 7564 2070 726f 7669   the cloud provi
+0001db40: 6465 7220 646f 6573 206e 6f74 0a20 2020  der does not.   
+0001db50: 2020 2020 2020 2020 2073 7570 706f 7274           support
+0001db60: 2071 7565 7279 696e 6720 656e 6470 6f69   querying endpoi
+0001db70: 6e74 732e 0a20 2020 2020 2020 2065 7863  nts..        exc
+0001db80: 6570 7469 6f6e 732e 436c 7573 7465 724e  eptions.ClusterN
+0001db90: 6f74 5570 4572 726f 723a 2069 6620 7468  otUpError: if th
+0001dba0: 6520 636c 7573 7465 7220 6973 206e 6f74  e cluster is not
+0001dbb0: 2069 6e20 5550 2073 7461 7475 732e 0a20   in UP status.. 
+0001dbc0: 2020 2022 2222 0a20 2020 2023 2043 6173     """.    # Cas
+0001dbd0: 7420 656e 6470 6f69 6e74 2074 6f20 696e  t endpoint to in
+0001dbe0: 7420 6966 2069 7420 6973 206e 6f74 204e  t if it is not N
+0001dbf0: 6f6e 650a 2020 2020 6966 2070 6f72 7420  one.    if port 
+0001dc00: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+0001dc10: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+0001dc20: 2020 2020 2020 706f 7274 203d 2069 6e74        port = int
+0001dc30: 2870 6f72 7429 0a20 2020 2020 2020 2065  (port).        e
+0001dc40: 7863 6570 7420 5661 6c75 6545 7272 6f72  xcept ValueError
+0001dc50: 3a0a 2020 2020 2020 2020 2020 2020 7769  :.            wi
+0001dc60: 7468 2075 785f 7574 696c 732e 7072 696e  th ux_utils.prin
+0001dc70: 745f 6578 6365 7074 696f 6e5f 6e6f 5f74  t_exception_no_t
+0001dc80: 7261 6365 6261 636b 2829 3a0a 2020 2020  raceback():.    
+0001dc90: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0001dca0: 6520 5661 6c75 6545 7272 6f72 2866 2749  e ValueError(f'I
+0001dcb0: 6e76 616c 6964 2065 6e64 706f 696e 7420  nvalid endpoint 
+0001dcc0: 7b70 6f72 7421 727d 2e27 2920 6672 6f6d  {port!r}.') from
+0001dcd0: 204e 6f6e 650a 2020 2020 636c 7573 7465   None.    cluste
+0001dce0: 725f 7265 636f 7264 7320 3d20 6765 745f  r_records = get_
+0001dcf0: 636c 7573 7465 7273 2869 6e63 6c75 6465  clusters(include
+0001dd00: 5f63 6f6e 7472 6f6c 6c65 723d 5472 7565  _controller=True
+0001dd10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001dd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dd30: 2020 2020 2072 6566 7265 7368 3d46 616c       refresh=Fal
+0001dd40: 7365 2c0a 2020 2020 2020 2020 2020 2020  se,.            
+0001dd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dd60: 2020 2020 2020 2063 6c75 7374 6572 5f6e         cluster_n
+0001dd70: 616d 6573 3d5b 636c 7573 7465 725d 290a  ames=[cluster]).
+0001dd80: 2020 2020 636c 7573 7465 725f 7265 636f      cluster_reco
+0001dd90: 7264 203d 2063 6c75 7374 6572 5f72 6563  rd = cluster_rec
+0001dda0: 6f72 6473 5b30 5d0a 2020 2020 6966 2028  ords[0].    if (
+0001ddb0: 6e6f 7420 736b 6970 5f73 7461 7475 735f  not skip_status_
+0001ddc0: 6368 6563 6b20 616e 640a 2020 2020 2020  check and.      
+0001ddd0: 2020 2020 2020 636c 7573 7465 725f 7265        cluster_re
+0001dde0: 636f 7264 5b27 7374 6174 7573 275d 2021  cord['status'] !
+0001ddf0: 3d20 7374 6174 7573 5f6c 6962 2e43 6c75  = status_lib.Clu
+0001de00: 7374 6572 5374 6174 7573 2e55 5029 3a0a  sterStatus.UP):.
+0001de10: 2020 2020 2020 2020 7769 7468 2075 785f          with ux_
+0001de20: 7574 696c 732e 7072 696e 745f 6578 6365  utils.print_exce
+0001de30: 7074 696f 6e5f 6e6f 5f74 7261 6365 6261  ption_no_traceba
+0001de40: 636b 2829 3a0a 2020 2020 2020 2020 2020  ck():.          
+0001de50: 2020 7261 6973 6520 6578 6365 7074 696f    raise exceptio
+0001de60: 6e73 2e43 6c75 7374 6572 4e6f 7455 7045  ns.ClusterNotUpE
+0001de70: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+0001de80: 2020 2020 2020 6627 436c 7573 7465 7220        f'Cluster 
+0001de90: 7b63 6c75 7374 6572 5f72 6563 6f72 645b  {cluster_record[
+0001dea0: 226e 616d 6522 5d21 727d 2027 0a20 2020  "name"]!r} '.   
+0001deb0: 2020 2020 2020 2020 2020 2020 2027 6973               'is
+0001dec0: 206e 6f74 2069 6e20 5550 2073 7461 7475   not in UP statu
+0001ded0: 732e 272c 2063 6c75 7374 6572 5f72 6563  s.', cluster_rec
+0001dee0: 6f72 645b 2773 7461 7475 7327 5d29 0a20  ord['status']). 
+0001def0: 2020 2068 616e 646c 6520 3d20 636c 7573     handle = clus
+0001df00: 7465 725f 7265 636f 7264 5b27 6861 6e64  ter_record['hand
+0001df10: 6c65 275d 0a20 2020 2069 6620 6e6f 7420  le'].    if not 
+0001df20: 6973 696e 7374 616e 6365 2868 616e 646c  isinstance(handl
+0001df30: 652c 2062 6163 6b65 6e64 732e 436c 6f75  e, backends.Clou
+0001df40: 6456 6d52 6179 5265 736f 7572 6365 4861  dVmRayResourceHa
+0001df50: 6e64 6c65 293a 0a20 2020 2020 2020 2077  ndle):.        w
+0001df60: 6974 6820 7578 5f75 7469 6c73 2e70 7269  ith ux_utils.pri
+0001df70: 6e74 5f65 7863 6570 7469 6f6e 5f6e 6f5f  nt_exception_no_
+0001df80: 7472 6163 6562 6163 6b28 293a 0a20 2020  traceback():.   
+0001df90: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+0001dfa0: 616c 7565 4572 726f 7228 2751 7565 7279  alueError('Query
+0001dfb0: 696e 6720 4950 2061 6464 7265 7373 2069  ing IP address i
+0001dfc0: 7320 6e6f 7420 7375 7070 6f72 7465 6420  s not supported 
+0001dfd0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+0001dfe0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0001dff0: 2766 6f72 2063 6c75 7374 6572 207b 636c  'for cluster {cl
+0001e000: 7573 7465 7221 727d 2077 6974 6820 6261  uster!r} with ba
+0001e010: 636b 656e 6420 270a 2020 2020 2020 2020  ckend '.        
+0001e020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e030: 2020 2020 2066 277b 6765 745f 6261 636b       f'{get_back
+0001e040: 656e 645f 6672 6f6d 5f68 616e 646c 6528  end_from_handle(
+0001e050: 6861 6e64 6c65 292e 4e41 4d45 7d2e 2729  handle).NAME}.')
+0001e060: 0a0a 2020 2020 6c61 756e 6368 6564 5f72  ..    launched_r
+0001e070: 6573 6f75 7263 6573 203d 2068 616e 646c  esources = handl
+0001e080: 652e 6c61 756e 6368 6564 5f72 6573 6f75  e.launched_resou
+0001e090: 7263 6573 0a20 2020 2063 6c6f 7564 203d  rces.    cloud =
+0001e0a0: 206c 6175 6e63 6865 645f 7265 736f 7572   launched_resour
+0001e0b0: 6365 732e 636c 6f75 640a 2020 2020 7472  ces.cloud.    tr
+0001e0c0: 793a 0a20 2020 2020 2020 2063 6c6f 7564  y:.        cloud
+0001e0d0: 2e63 6865 636b 5f66 6561 7475 7265 735f  .check_features_
+0001e0e0: 6172 655f 7375 7070 6f72 7465 6428 0a20  are_supported(. 
+0001e0f0: 2020 2020 2020 2020 2020 206c 6175 6e63             launc
+0001e100: 6865 645f 7265 736f 7572 6365 732c 207b  hed_resources, {
+0001e110: 636c 6f75 6473 2e43 6c6f 7564 496d 706c  clouds.CloudImpl
+0001e120: 656d 656e 7461 7469 6f6e 4665 6174 7572  ementationFeatur
+0001e130: 6573 2e4f 5045 4e5f 504f 5254 537d 290a  es.OPEN_PORTS}).
+0001e140: 2020 2020 6578 6365 7074 2065 7863 6570      except excep
+0001e150: 7469 6f6e 732e 4e6f 7453 7570 706f 7274  tions.NotSupport
+0001e160: 6564 4572 726f 723a 0a20 2020 2020 2020  edError:.       
+0001e170: 2077 6974 6820 7578 5f75 7469 6c73 2e70   with ux_utils.p
+0001e180: 7269 6e74 5f65 7863 6570 7469 6f6e 5f6e  rint_exception_n
+0001e190: 6f5f 7472 6163 6562 6163 6b28 293a 0a20  o_traceback():. 
+0001e1a0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0001e1b0: 2056 616c 7565 4572 726f 7228 2751 7565   ValueError('Que
+0001e1c0: 7279 696e 6720 656e 6470 6f69 6e74 7320  rying endpoints 
+0001e1d0: 6973 206e 6f74 2073 7570 706f 7274 6564  is not supported
+0001e1e0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+0001e1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e200: 6627 666f 7220 636c 7573 7465 7220 7b63  f'for cluster {c
+0001e210: 6c75 7374 6572 2172 7d20 6f6e 207b 636c  luster!r} on {cl
+0001e220: 6f75 647d 2e27 2920 6672 6f6d 204e 6f6e  oud}.') from Non
+0001e230: 650a 0a20 2020 2063 6f6e 6669 6720 3d20  e..    config = 
+0001e240: 636f 6d6d 6f6e 5f75 7469 6c73 2e72 6561  common_utils.rea
+0001e250: 645f 7961 6d6c 2868 616e 646c 652e 636c  d_yaml(handle.cl
+0001e260: 7573 7465 725f 7961 6d6c 290a 2020 2020  uster_yaml).    
+0001e270: 706f 7274 5f64 6574 6169 6c73 203d 2070  port_details = p
+0001e280: 726f 7669 7369 6f6e 5f6c 6962 2e71 7565  rovision_lib.que
+0001e290: 7279 5f70 6f72 7473 2872 6570 7228 636c  ry_ports(repr(cl
+0001e2a0: 6f75 6429 2c0a 2020 2020 2020 2020 2020  oud),.          
+0001e2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e2d0: 2020 2068 616e 646c 652e 636c 7573 7465     handle.cluste
+0001e2e0: 725f 6e61 6d65 5f6f 6e5f 636c 6f75 642c  r_name_on_cloud,
+0001e2f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001e300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e310: 2020 2020 2020 2020 2020 2020 2020 6861                ha
+0001e320: 6e64 6c65 2e6c 6175 6e63 6865 645f 7265  ndle.launched_re
+0001e330: 736f 7572 6365 732e 706f 7274 732c 0a20  sources.ports,. 
+0001e340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e360: 2020 2020 2020 2020 2020 2020 6865 6164              head
+0001e370: 5f69 703d 6861 6e64 6c65 2e68 6561 645f  _ip=handle.head_
+0001e380: 6970 2c0a 2020 2020 2020 2020 2020 2020  ip,.            
+0001e390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e3b0: 2070 726f 7669 6465 725f 636f 6e66 6967   provider_config
+0001e3c0: 3d63 6f6e 6669 675b 2770 726f 7669 6465  =config['provide
+0001e3d0: 7227 5d29 0a0a 2020 2020 2320 5661 6c69  r'])..    # Vali
+0001e3e0: 6461 7469 6f6e 2062 6566 6f72 6520 7265  dation before re
+0001e3f0: 7475 726e 696e 6720 7468 6520 656e 6470  turning the endp
+0001e400: 6f69 6e74 730a 2020 2020 6966 2070 6f72  oints.    if por
+0001e410: 7420 6973 206e 6f74 204e 6f6e 653a 0a20  t is not None:. 
+0001e420: 2020 2020 2020 2023 2049 6620 7468 6520         # If the 
+0001e430: 7265 7175 6573 7465 6420 656e 6470 6f69  requested endpoi
+0001e440: 6e74 2077 6173 206e 6f74 2074 6f20 6265  nt was not to be
+0001e450: 2065 7870 6f73 6564 0a20 2020 2020 2020   exposed.       
+0001e460: 2070 6f72 745f 7365 7420 3d20 7265 736f   port_set = reso
+0001e470: 7572 6365 735f 7574 696c 732e 706f 7274  urces_utils.port
+0001e480: 5f72 616e 6765 735f 746f 5f73 6574 280a  _ranges_to_set(.
+0001e490: 2020 2020 2020 2020 2020 2020 6861 6e64              hand
+0001e4a0: 6c65 2e6c 6175 6e63 6865 645f 7265 736f  le.launched_reso
+0001e4b0: 7572 6365 732e 706f 7274 7329 0a20 2020  urces.ports).   
+0001e4c0: 2020 2020 2069 6620 706f 7274 206e 6f74       if port not
+0001e4d0: 2069 6e20 706f 7274 5f73 6574 3a0a 2020   in port_set:.  
+0001e4e0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+0001e4f0: 2e77 6172 6e69 6e67 2866 2750 6f72 7420  .warning(f'Port 
+0001e500: 7b70 6f72 747d 2069 7320 6e6f 7420 6578  {port} is not ex
+0001e510: 706f 7365 6420 6f6e 2027 0a20 2020 2020  posed on '.     
+0001e520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e530: 2020 2020 2020 6627 636c 7573 7465 7220        f'cluster 
+0001e540: 7b63 6c75 7374 6572 2172 7d2e 2729 0a20  {cluster!r}.'). 
+0001e550: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001e560: 6e20 7b7d 0a20 2020 2020 2020 2023 2049  n {}.        # I
+0001e570: 6620 7468 6520 7573 6572 2072 6571 7565  f the user reque
+0001e580: 7374 6564 2061 2073 7065 6369 6669 6320  sted a specific 
+0001e590: 706f 7274 2065 6e64 706f 696e 742c 2063  port endpoint, c
+0001e5a0: 6865 636b 2069 6620 6974 2069 7320 6578  heck if it is ex
+0001e5b0: 706f 7365 640a 2020 2020 2020 2020 6966  posed.        if
+0001e5c0: 2070 6f72 7420 6e6f 7420 696e 2070 6f72   port not in por
+0001e5d0: 745f 6465 7461 696c 733a 0a20 2020 2020  t_details:.     
+0001e5e0: 2020 2020 2020 2065 7272 6f72 5f6d 7367         error_msg
+0001e5f0: 203d 2028 6627 506f 7274 207b 706f 7274   = (f'Port {port
+0001e600: 7d20 6e6f 7420 6578 706f 7365 6420 7965  } not exposed ye
+0001e610: 742e 2027 0a20 2020 2020 2020 2020 2020  t. '.           
+0001e620: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+0001e630: 7b5f 454e 4450 4f49 4e54 535f 5245 5452  {_ENDPOINTS_RETR
+0001e640: 595f 4d45 5353 4147 457d 2027 290a 2020  Y_MESSAGE} ').  
+0001e650: 2020 2020 2020 2020 2020 6966 2068 616e            if han
+0001e660: 646c 652e 6c61 756e 6368 6564 5f72 6573  dle.launched_res
+0001e670: 6f75 7263 6573 2e63 6c6f 7564 2e69 735f  ources.cloud.is_
+0001e680: 7361 6d65 5f63 6c6f 7564 280a 2020 2020  same_cloud(.    
+0001e690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e6a0: 636c 6f75 6473 2e4b 7562 6572 6e65 7465  clouds.Kubernete
+0001e6b0: 7328 2929 3a0a 2020 2020 2020 2020 2020  s()):.          
+0001e6c0: 2020 2020 2020 2320 4164 6420 4b75 6265        # Add Kube
+0001e6d0: 726e 6574 6573 2073 7065 6369 6669 6320  rnetes specific 
+0001e6e0: 6465 6275 6767 696e 6720 696e 666f 0a20  debugging info. 
+0001e6f0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0001e700: 7272 6f72 5f6d 7367 202b 3d20 286b 7562  rror_msg += (kub
+0001e710: 6572 6e65 7465 735f 7574 696c 732e 6765  ernetes_utils.ge
+0001e720: 745f 656e 6470 6f69 6e74 5f64 6562 7567  t_endpoint_debug
+0001e730: 5f6d 6573 7361 6765 2829 290a 2020 2020  _message()).    
+0001e740: 2020 2020 2020 2020 6c6f 6767 6572 2e77          logger.w
+0001e750: 6172 6e69 6e67 2865 7272 6f72 5f6d 7367  arning(error_msg
+0001e760: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+0001e770: 7475 726e 207b 7d0a 2020 2020 2020 2020  turn {}.        
+0001e780: 7265 7475 726e 207b 706f 7274 3a20 706f  return {port: po
+0001e790: 7274 5f64 6574 6169 6c73 5b70 6f72 745d  rt_details[port]
+0001e7a0: 5b30 5d2e 7572 6c28 297d 0a20 2020 2065  [0].url()}.    e
+0001e7b0: 6c73 653a 0a20 2020 2020 2020 2069 6620  lse:.        if 
+0001e7c0: 6e6f 7420 706f 7274 5f64 6574 6169 6c73  not port_details
+0001e7d0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+0001e7e0: 4966 2063 6c75 7374 6572 2068 6164 206e  If cluster had n
+0001e7f0: 6f20 706f 7274 7320 746f 2062 6520 6578  o ports to be ex
+0001e800: 706f 7365 640a 2020 2020 2020 2020 2020  posed.          
+0001e810: 2020 6966 2068 616e 646c 652e 6c61 756e    if handle.laun
+0001e820: 6368 6564 5f72 6573 6f75 7263 6573 2e70  ched_resources.p
+0001e830: 6f72 7473 2069 7320 4e6f 6e65 3a0a 2020  orts is None:.  
+0001e840: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+0001e850: 6767 6572 2e77 6172 6e69 6e67 2866 2743  gger.warning(f'C
+0001e860: 6c75 7374 6572 207b 636c 7573 7465 7221  luster {cluster!
+0001e870: 727d 2064 6f65 7320 6e6f 7420 6861 7665  r} does not have
+0001e880: 2061 6e79 2027 0a20 2020 2020 2020 2020   any '.         
+0001e890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e8a0: 2020 2020 2020 2770 6f72 7473 2074 6f20        'ports to 
+0001e8b0: 6265 2065 7870 6f73 6564 2e27 290a 2020  be exposed.').  
+0001e8c0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0001e8d0: 7475 726e 207b 7d0a 2020 2020 2020 2020  turn {}.        
+0001e8e0: 2020 2020 2320 456c 7365 2070 6f72 7473      # Else ports
+0001e8f0: 2068 6176 6520 6e6f 7420 6265 656e 2065   have not been e
+0001e900: 7870 6f73 6564 2065 7665 6e20 7468 6f75  xposed even thou
+0001e910: 6768 2074 6865 7920 6578 6973 742e 0a20  gh they exist.. 
+0001e920: 2020 2020 2020 2020 2020 2023 2049 6e20             # In 
+0001e930: 7468 6973 2063 6173 652c 2061 736b 2074  this case, ask t
+0001e940: 6865 2075 7365 7220 746f 2072 6574 7279  he user to retry
+0001e950: 2e0a 2020 2020 2020 2020 2020 2020 656c  ..            el
+0001e960: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0001e970: 2020 2020 6572 726f 725f 6d73 6720 3d20      error_msg = 
+0001e980: 2866 274e 6f20 656e 6470 6f69 6e74 7320  (f'No endpoints 
+0001e990: 6578 706f 7365 6420 7965 742e 2027 0a20  exposed yet. '. 
+0001e9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e9b0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+0001e9c0: 454e 4450 4f49 4e54 535f 5245 5452 595f  ENDPOINTS_RETRY_
+0001e9d0: 4d45 5353 4147 457d 2027 290a 2020 2020  MESSAGE} ').    
+0001e9e0: 2020 2020 2020 2020 2020 2020 6966 2068              if h
+0001e9f0: 616e 646c 652e 6c61 756e 6368 6564 5f72  andle.launched_r
+0001ea00: 6573 6f75 7263 6573 2e63 6c6f 7564 2e69  esources.cloud.i
+0001ea10: 735f 7361 6d65 5f63 6c6f 7564 280a 2020  s_same_cloud(.  
+0001ea20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ea30: 2020 2020 2020 636c 6f75 6473 2e4b 7562        clouds.Kub
+0001ea40: 6572 6e65 7465 7328 2929 3a0a 2020 2020  ernetes()):.    
+0001ea50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ea60: 2320 4164 6420 4b75 6265 726e 6574 6573  # Add Kubernetes
+0001ea70: 2073 7065 6369 6669 6320 6465 6275 6767   specific debugg
+0001ea80: 696e 6720 696e 666f 0a20 2020 2020 2020  ing info.       
+0001ea90: 2020 2020 2020 2020 2020 2020 2065 7272               err
+0001eaa0: 6f72 5f6d 7367 202b 3d20 5c0a 2020 2020  or_msg += \.    
+0001eab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001eac0: 2020 2020 6b75 6265 726e 6574 6573 5f75      kubernetes_u
+0001ead0: 7469 6c73 2e67 6574 5f65 6e64 706f 696e  tils.get_endpoin
+0001eae0: 745f 6465 6275 675f 6d65 7373 6167 6528  t_debug_message(
+0001eaf0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001eb00: 2020 6c6f 6767 6572 2e77 6172 6e69 6e67    logger.warning
+0001eb10: 2865 7272 6f72 5f6d 7367 290a 2020 2020  (error_msg).    
+0001eb20: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0001eb30: 726e 207b 7d0a 2020 2020 2020 2020 7265  rn {}.        re
+0001eb40: 7475 726e 207b 0a20 2020 2020 2020 2020  turn {.         
+0001eb50: 2020 2070 6f72 745f 6e75 6d3a 2075 726c     port_num: url
+0001eb60: 735b 305d 2e75 726c 2829 2066 6f72 2070  s[0].url() for p
+0001eb70: 6f72 745f 6e75 6d2c 2075 726c 7320 696e  ort_num, urls in
+0001eb80: 2070 6f72 745f 6465 7461 696c 732e 6974   port_details.it
+0001eb90: 656d 7328 290a 2020 2020 2020 2020 7d0a  ems().        }.
```

### Comparing `skypilot-0.5.0/sky/backends/cloud_vm_ray_backend.py` & `skypilot-0.6.0/sky/backends/cloud_vm_ray_backend.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,17 +1,19 @@
 """Backend: runs on cloud virtual machines, managed by Ray."""
 import copy
 import enum
+import functools
 import getpass
 import inspect
 import json
 import math
 import os
 import pathlib
 import re
+import shlex
 import signal
 import subprocess
 import sys
 import tempfile
 import textwrap
 import threading
 import time
@@ -23,24 +25,25 @@
 
 import sky
 from sky import backends
 from sky import cloud_stores
 from sky import clouds
 from sky import exceptions
 from sky import global_user_state
+from sky import jobs as managed_jobs
 from sky import optimizer
 from sky import provision as provision_lib
 from sky import resources as resources_lib
 from sky import serve as serve_lib
 from sky import sky_logging
-from sky import spot as spot_lib
 from sky import status_lib
 from sky import task as task_lib
 from sky.backends import backend_utils
 from sky.backends import wheel_utils
+from sky.clouds import service_catalog
 from sky.clouds.utils import gcp_utils
 from sky.data import data_utils
 from sky.data import storage as storage_lib
 from sky.provision import common as provision_common
 from sky.provision import instance_setup
 from sky.provision import metadata_utils
 from sky.provision import provisioner
@@ -129,25 +132,39 @@
 # Path to the monkey-patched ray up script.
 # We don't do import then __file__ because that script needs to be filled in
 # (so import would fail).
 _RAY_UP_WITH_MONKEY_PATCHED_HASH_LAUNCH_CONF_PATH = (
     pathlib.Path(sky.__file__).resolve().parent / 'backends' /
     'monkey_patches' / 'monkey_patch_ray_up.py')
 
+# The maximum size of a command line arguments is 128 KB, i.e. the command
+# executed with /bin/sh should be less than 128KB.
+# https://github.com/torvalds/linux/blob/master/include/uapi/linux/binfmts.h
+#
+# If a user have very long run or setup commands, the generated command may
+# exceed the limit, as we directly include scripts in job submission commands.
+# If the command is too long, we instead write it to a file, rsync and execute
+# it.
+#
+# We use 120KB as a threshold to be safe for other arguments that
+# might be added during ssh.
+_MAX_INLINE_SCRIPT_LENGTH = 120 * 1024
+
 
 def _get_cluster_config_template(cloud):
     cloud_to_template = {
         clouds.AWS: 'aws-ray.yml.j2',
         clouds.Azure: 'azure-ray.yml.j2',
         clouds.Cudo: 'cudo-ray.yml.j2',
         clouds.GCP: 'gcp-ray.yml.j2',
         clouds.Lambda: 'lambda-ray.yml.j2',
         clouds.IBM: 'ibm-ray.yml.j2',
         clouds.SCP: 'scp-ray.yml.j2',
         clouds.OCI: 'oci-ray.yml.j2',
+        clouds.Paperspace: 'paperspace-ray.yml.j2',
         clouds.RunPod: 'runpod-ray.yml.j2',
         clouds.Kubernetes: 'kubernetes-ray.yml.j2',
         clouds.Vsphere: 'vsphere-ray.yml.j2',
         clouds.Fluidstack: 'fluidstack-ray.yml.j2'
     }
     return cloud_to_template[type(cloud)]
 
@@ -227,17 +244,18 @@
         self._code = [
             textwrap.dedent(f"""\
             import getpass
             import hashlib
             import io
             import os
             import pathlib
-            import sys
             import selectors
+            import shlex
             import subprocess
+            import sys
             import tempfile
             import textwrap
             import time
             from typing import Dict, List, Optional, Tuple, Union
 
             import ray
             import ray.util as ray_util
@@ -260,15 +278,23 @@
                 log_to_driver=True,
                 **kwargs
             )
             def get_or_fail(futures, pg) -> List[int]:
                 \"\"\"Wait for tasks, if any fails, cancel all unready.\"\"\"
                 returncodes = [1] * len(futures)
                 # Wait for 1 task to be ready.
-                ready, unready = ray.wait(futures)
+                ready = []
+                # Keep invoking ray.wait if ready is empty. This is because
+                # ray.wait with timeout=None will only wait for 10**6 seconds,
+                # which will cause tasks running for more than 12 days to return
+                # before becoming ready.
+                # (Such tasks are common in serving jobs.)
+                # Reference: https://github.com/ray-project/ray/blob/ray-2.9.3/python/ray/_private/worker.py#L2845-L2846
+                while not ready:
+                    ready, unready = ray.wait(futures)
                 idx = futures.index(ready[0])
                 returncodes[idx] = ray.get(ready[0])
                 while unready:
                     if returncodes[idx] != 0:
                         for task in unready:
                             # ray.cancel without force fails to kill tasks.
                             # We use force=True to kill unready tasks.
@@ -281,17 +307,16 @@
                     ready, unready = ray.wait(unready)
                     idx = futures.index(ready[0])
                     returncodes[idx] = ray.get(ready[0])
                 # Remove the placement group after all tasks are done, so that the
                 # next job can be scheduled on the released resources immediately.
                 ray_util.remove_placement_group(pg)
                 sys.stdout.flush()
-                sys.stderr.flush()
                 return returncodes
-            
+
             run_fn = None
             futures = []
             """),
             # FIXME: This is a hack to make sure that the functions can be found
             # by ray.remote. This should be removed once we have a better way to
             # specify dependencies for ray.
             inspect.getsource(log_lib._ProcessingArgs),  # pylint: disable=protected-access
@@ -320,15 +345,15 @@
     def add_gang_scheduling_placement_group_and_setup(
         self,
         num_nodes: int,
         resources_dict: Dict[str, float],
         stable_cluster_internal_ips: List[str],
         setup_cmd: Optional[str] = None,
         setup_log_path: Optional[str] = None,
-        envs: Optional[Dict[str, str]] = None,
+        env_vars: Optional[Dict[str, str]] = None,
     ) -> None:
         """Create the gang scheduling placement group for a Task.
 
         cluster_ips_sorted is used to ensure that the SKY_NODE_RANK environment
         variable is assigned in a deterministic order whenever a new task is
         added.
         """
@@ -368,22 +393,20 @@
                 pg = ray_util.placement_group({json.dumps(bundles)}, 'STRICT_SPREAD')
                 plural = 's' if {num_nodes} > 1 else ''
                 node_str = f'{num_nodes} node{{plural}}'
 
                 message = {_CTRL_C_TIP_MESSAGE!r} + '\\n'
                 message += f'INFO: Waiting for task resources on {{node_str}}. This will block if the cluster is full.'
                 print(message,
-                      file=sys.stderr,
                       flush=True)
                 # FIXME: This will print the error message from autoscaler if
                 # it is waiting for other task to finish. We should hide the
                 # error message.
                 ray.get(pg.ready())
                 print('INFO: All task resources reserved.',
-                      file=sys.stderr,
                       flush=True)
                 """)
         ]
 
         job_id = self.job_id
         if setup_cmd is not None:
             self._code += [
@@ -411,27 +434,26 @@
                         scheduling_strategy=ray.util.scheduling_strategies.PlacementGroupSchedulingStrategy(
                             placement_group=setup_pg,
                             placement_group_bundle_index=i)
                     ) \\
                     .remote(
                         setup_cmd,
                         os.path.expanduser({setup_log_path!r}),
-                        env_vars={envs!r},
+                        env_vars={env_vars!r},
                         stream_logs=True,
                         with_ray=True,
                     ) for i in range(total_num_nodes)]
                 setup_returncodes = get_or_fail(setup_workers, setup_pg)
                 if sum(setup_returncodes) != 0:
                     job_lib.set_status({self.job_id!r}, job_lib.JobStatus.FAILED_SETUP)
                     # This waits for all streaming logs to finish.
                     time.sleep(1)
                     print('ERROR: {colorama.Fore.RED}Job {self.job_id}\\'s setup failed with '
                         'return code list:{colorama.Style.RESET_ALL}',
                         setup_returncodes,
-                        file=sys.stderr,
                         flush=True)
                     # Need this to set the job status in ray job to be FAILED.
                     sys.exit(1)
                 """)
             ]
 
         self._code.append(f'job_lib.set_job_started({self.job_id!r})')
@@ -481,15 +503,14 @@
             run_fn,
             f'run_fn = {run_fn_name}',
         ]
 
     def add_ray_task(self,
                      bash_script: Optional[str],
                      task_name: Optional[str],
-                     job_run_id: Optional[str],
                      ray_resources_dict: Dict[str, float],
                      log_dir: str,
                      env_vars: Optional[Dict[str, str]] = None,
                      gang_scheduling_id: int = 0) -> None:
         """Generates code for a ray remote task that runs a bash command."""
         assert self._has_gang_scheduling, (
             'Call add_gang_scheduling_placement_group_and_setup() before '
@@ -535,23 +556,14 @@
             sky_env_vars_dict['SKY_NODE_IPS'] = job_ip_list_str
             """)
         ]
 
         if env_vars is not None:
             sky_env_vars_dict_str.extend(f'sky_env_vars_dict[{k!r}] = {v!r}'
                                          for k, v in env_vars.items())
-        if job_run_id is not None:
-            sky_env_vars_dict_str += [
-                f'sky_env_vars_dict[{constants.TASK_ID_ENV_VAR!r}]'
-                f' = {job_run_id!r}',
-                # TODO(zhwu): remove this deprecated env var in later release
-                # (after 0.5).
-                f'sky_env_vars_dict[{constants.TASK_ID_ENV_VAR_DEPRECATED!r}]'
-                f' = {job_run_id!r}'
-            ]
         sky_env_vars_dict_str = '\n'.join(sky_env_vars_dict_str)
 
         options_str = ', '.join(options)
         logger.debug('Added Task with options: '
                      f'{options_str}')
         self._code += [
             sky_env_vars_dict_str,
@@ -619,15 +631,14 @@
                 # 139 is the return code of SIGSEGV, i.e. Segmentation Fault.
                 if any(r == 139 for r in returncodes):
                     reason = '(likely due to Segmentation Fault)'
                 print('ERROR: {colorama.Fore.RED}Job {self.job_id} failed with '
                       'return code list:{colorama.Style.RESET_ALL}',
                       returncodes,
                       reason,
-                      file=sys.stderr,
                       flush=True)
                 # Need this to set the job status in ray job to be FAILED.
                 sys.exit(1)
             else:
                 job_lib.set_status({self.job_id!r}, job_lib.JobStatus.SUCCEEDED)
                 # Schedule the next pending job immediately to make the job
                 # scheduling more efficient.
@@ -754,15 +765,15 @@
         logger.warning(f'{style.DIM}\t{messages}{style.RESET_ALL}')
         _add_to_blocked_resources(blocked_resources,
                                   launchable_resources.copy(zone=None))
 
         # Sometimes, LambdaCloudError will list available regions.
         for e in errors:
             if e.find('Regions with capacity available:') != -1:
-                for r in clouds.Lambda.regions():
+                for r in service_catalog.regions('lambda'):
                     if e.find(r.name) == -1:
                         _add_to_blocked_resources(
                             blocked_resources,
                             launchable_resources.copy(region=r.name, zone=None))
 
     @staticmethod
     def _kubernetes_handler(blocked_resources: Set['resources_lib.Resources'],
@@ -826,15 +837,15 @@
         logger.warning(f'{style.DIM}\t{messages}{style.RESET_ALL}')
         _add_to_blocked_resources(blocked_resources,
                                   launchable_resources.copy(zone=None))
 
         # Sometimes, SCPError will list available regions.
         for e in errors:
             if e.find('Regions with capacity available:') != -1:
-                for r in clouds.SCP.regions():
+                for r in service_catalog.regions('scp'):
                     if e.find(r.name) == -1:
                         _add_to_blocked_resources(
                             blocked_resources,
                             launchable_resources.copy(region=r.name, zone=None))
 
     @staticmethod
     def _ibm_handler(blocked_resources: Set['resources_lib.Resources'],
@@ -1079,15 +1090,16 @@
             elif code == 'VPC_NOT_FOUND':
                 # User has specified a VPC that does not exist. On GCP, VPC is
                 # global. So we skip the entire cloud.
                 _add_to_blocked_resources(
                     blocked_resources,
                     launchable_resources.copy(region=None, zone=None))
             elif code == 'SUBNET_NOT_FOUND_FOR_VPC':
-                if (any(acc.lower().startswith('tpu-v4')
+                if (launchable_resources.accelerators is not None and any(
+                        acc.lower().startswith('tpu-v4')
                         for acc in launchable_resources.accelerators.keys()) and
                         region.name == 'us-central2'):
                     # us-central2 is a TPU v4 only region. The subnet for
                     # this region may not exist when the user does not have
                     # the TPU v4 quota. We should skip this region.
                     logger.warning('Please check if you have TPU v4 quotas '
                                    f'in {region.name}.')
@@ -1476,18 +1488,20 @@
                 return config_dict
             cluster_config_file = config_dict['ray']
 
             launched_resources = to_provision.copy(region=region.name)
             if zones and len(zones) == 1:
                 launched_resources = launched_resources.copy(zone=zones[0].name)
 
-            prev_cluster_ips, prev_ssh_ports = None, None
+            prev_cluster_ips, prev_ssh_ports, prev_cluster_info = (None, None,
+                                                                   None)
             if prev_handle is not None:
                 prev_cluster_ips = prev_handle.stable_internal_external_ips
                 prev_ssh_ports = prev_handle.stable_ssh_ports
+                prev_cluster_info = prev_handle.cached_cluster_info
             # Record early, so if anything goes wrong, 'sky status' will show
             # the cluster name and users can appropriately 'sky down'.  It also
             # means a second 'sky launch -c <name>' will attempt to reuse.
             handle = CloudVmRayResourceHandle(
                 cluster_name=cluster_name,
                 # Backward compatibility will be guaranteed by the underlying
                 # backend_utils.write_cluster_config, which gets the cluster
@@ -1498,15 +1512,17 @@
                 launched_nodes=num_nodes,
                 # OK for this to be shown in CLI as status == INIT.
                 launched_resources=launched_resources,
                 # Use the previous cluster's IPs and ports if available to
                 # optimize the case where the cluster is restarted, i.e., no
                 # need to query IPs and ports from the cloud provider.
                 stable_internal_external_ips=prev_cluster_ips,
-                stable_ssh_ports=prev_ssh_ports)
+                stable_ssh_ports=prev_ssh_ports,
+                cluster_info=prev_cluster_info,
+            )
             usage_lib.messages.usage.update_final_cluster_status(
                 status_lib.ClusterStatus.INIT)
 
             # This sets the status to INIT (even for a normal, UP cluster).
             global_user_state.add_or_update_cluster(
                 cluster_name,
                 cluster_handle=handle,
@@ -1579,22 +1595,22 @@
                 # We must query the IPs from the cloud provider, when the
                 # provisioning is done, to make sure the cluster IPs are
                 # up-to-date.
                 # The staled IPs may be caused by the node being restarted
                 # manually or by the cloud provider.
                 # Optimize the case where the cluster's head IPs can be parsed
                 # from the output of 'ray up'.
-                kwargs = {}
                 if handle.launched_nodes == 1:
-                    kwargs = {
-                        'internal_ips': [head_internal_ip],
-                        'external_ips': [head_external_ip]
-                    }
-                handle.update_cluster_ips(max_attempts=_FETCH_IP_MAX_ATTEMPTS,
-                                          **kwargs)
+                    handle.update_cluster_ips(
+                        max_attempts=_FETCH_IP_MAX_ATTEMPTS,
+                        internal_ips=[head_internal_ip],
+                        external_ips=[head_external_ip])
+                else:
+                    handle.update_cluster_ips(
+                        max_attempts=_FETCH_IP_MAX_ATTEMPTS)
                 handle.update_ssh_ports(max_attempts=_FETCH_IP_MAX_ATTEMPTS)
                 if cluster_exists:
                     # Guard against the case where there's an existing cluster
                     # with ray runtime messed up (e.g., manually killed) by (1)
                     # querying ray status (2) restarting ray if needed.
                     #
                     # The above 'ray up' will not restart it automatically due
@@ -1938,15 +1954,15 @@
             time.sleep(1)
             returncode, output, _ = backend.run_on_head(
                 handle,
                 instance_setup.RAY_STATUS_WITH_SKY_RAY_PORT_COMMAND,
                 require_outputs=True)
         if returncode == 0:
             return
-        backend.run_on_head(handle, 'ray stop')
+        backend.run_on_head(handle, f'{constants.SKY_RAY_CMD} stop')
 
         # Runs `ray up <kwargs>` with our monkey-patched launch hash
         # calculation. See the monkey patch file for why.
         script_path = write_ray_up_script_with_patched_launch_hash_fn(
             handle.cluster_yaml, ray_up_kwargs={'restart_only': True})
         log_lib.run_with_log(
             [sys.executable, script_path],
@@ -1989,17 +2005,28 @@
                 # Recheck cluster name as the 'except:' block below may
                 # change the cloud assignment.
                 common_utils.check_cluster_name_is_valid(cluster_name)
                 if dryrun:
                     cloud_user = None
                 else:
                     cloud_user = to_provision.cloud.get_current_user_identity()
+
+                requested_features = self._requested_features.copy()
+                # Skip stop feature for Kubernetes controllers.
+                if (isinstance(to_provision.cloud, clouds.Kubernetes) and
+                        controller_utils.Controllers.from_name(cluster_name)
+                        is not None):
+                    assert (clouds.CloudImplementationFeatures.STOP
+                            in requested_features), requested_features
+                    requested_features.remove(
+                        clouds.CloudImplementationFeatures.STOP)
+
                 # Skip if to_provision.cloud does not support requested features
                 to_provision.cloud.check_features_are_supported(
-                    to_provision, self._requested_features)
+                    to_provision, requested_features)
 
                 config_dict = self._retry_zones(
                     to_provision,
                     num_nodes,
                     requested_resources=set(task.resources),
                     dryrun=dryrun,
                     stream_logs=stream_logs,
@@ -2112,27 +2139,28 @@
     - (optional) Launched num nodes
     - (optional) Launched resources
     - (optional) Docker user name
     - (optional) If TPU(s) are managed, a path to a deletion script.
     """
     # Bump if any fields get added/removed/changed, and add backward
     # compaitibility logic in __setstate__.
-    _VERSION = 7
+    _VERSION = 8
 
     def __init__(
             self,
             *,
             cluster_name: str,
             cluster_name_on_cloud: str,
             cluster_yaml: str,
             launched_nodes: int,
             launched_resources: resources_lib.Resources,
             stable_internal_external_ips: Optional[List[Tuple[str,
                                                               str]]] = None,
             stable_ssh_ports: Optional[List[int]] = None,
+            cluster_info: Optional[provision_common.ClusterInfo] = None,
             # The following 2 fields are deprecated. SkyPilot new provisioner
             # API handles the TPU node creation/deletion.
             # Backward compatibility for TPU nodes created before #2943.
             # TODO (zhwu): Remove this after 0.6.0.
             tpu_create_script: Optional[str] = None,
             tpu_delete_script: Optional[str] = None) -> None:
         self._version = self._VERSION
@@ -2141,18 +2169,18 @@
         self._cluster_yaml = cluster_yaml.replace(os.path.expanduser('~'), '~',
                                                   1)
         # List of (internal_ip, feasible_ip) tuples for all the nodes in the
         # cluster, sorted by the feasible ips. The feasible ips can be either
         # internal or external ips, depending on the use_internal_ips flag.
         self.stable_internal_external_ips = stable_internal_external_ips
         self.stable_ssh_ports = stable_ssh_ports
+        self.cached_cluster_info = cluster_info
         self.launched_nodes = launched_nodes
         self.launched_resources = launched_resources
         self.docker_user: Optional[str] = None
-        self.ssh_user: Optional[str] = None
         # Deprecated. SkyPilot new provisioner API handles the TPU node
         # creation/deletion.
         # Backward compatibility for TPU nodes created before #2943.
         # TODO (zhwu): Remove this after 0.6.0.
         self.tpu_create_script = tpu_create_script
         self.tpu_delete_script = tpu_delete_script
 
@@ -2208,33 +2236,66 @@
 
     def update_ssh_ports(self, max_attempts: int = 1) -> None:
         """Fetches and sets the SSH ports for the cluster nodes.
 
         Use this method to use any cloud-specific port fetching logic.
         """
         del max_attempts  # Unused.
-        if isinstance(self.launched_resources.cloud, clouds.RunPod):
-            cluster_info = provision_lib.get_cluster_info(
-                str(self.launched_resources.cloud).lower(),
-                region=self.launched_resources.region,
-                cluster_name_on_cloud=self.cluster_name_on_cloud,
-                provider_config=None)
-            self.stable_ssh_ports = cluster_info.get_ssh_ports()
+        if self.cached_cluster_info is not None:
+            self.stable_ssh_ports = self.cached_cluster_info.get_ssh_ports()
             return
 
         head_ssh_port = 22
         self.stable_ssh_ports = (
             [head_ssh_port] + [22] *
             (self.num_ips_per_node * self.launched_nodes - 1))
 
+    def _update_cluster_info(self):
+        # When a cluster is on a cloud that does not support the new
+        # provisioner, we should skip updating cluster_info.
+        if (self.launched_resources.cloud.PROVISIONER_VERSION >=
+                clouds.ProvisionerVersion.SKYPILOT):
+            provider_name = str(self.launched_resources.cloud).lower()
+            config = {}
+            if os.path.exists(self.cluster_yaml):
+                # It is possible that the cluster yaml is not available when
+                # the handle is unpickled for service replicas from the
+                # controller with older version.
+                config = common_utils.read_yaml(self.cluster_yaml)
+            try:
+                cluster_info = provision_lib.get_cluster_info(
+                    provider_name,
+                    region=self.launched_resources.region,
+                    cluster_name_on_cloud=self.cluster_name_on_cloud,
+                    provider_config=config.get('provider', None))
+            except Exception as e:  # pylint: disable=broad-except
+                # This could happen when the VM is not fully launched, and a
+                # user is trying to terminate it with `sky down`.
+                logger.debug('Failed to get cluster info for '
+                             f'{self.cluster_name} from the new provisioner '
+                             f'with {common_utils.format_exception(e)}.')
+                raise exceptions.FetchClusterInfoError(
+                    exceptions.FetchClusterInfoError.Reason.HEAD) from e
+            if cluster_info.num_instances != self.launched_nodes:
+                logger.debug(
+                    f'Available nodes in the cluster {self.cluster_name} '
+                    'do not match the number of nodes requested ('
+                    f'{cluster_info.num_instances} != '
+                    f'{self.launched_nodes}).')
+                raise exceptions.FetchClusterInfoError(
+                    exceptions.FetchClusterInfoError.Reason.HEAD)
+            self.cached_cluster_info = cluster_info
+
     def update_cluster_ips(
             self,
             max_attempts: int = 1,
             internal_ips: Optional[List[Optional[str]]] = None,
-            external_ips: Optional[List[Optional[str]]] = None) -> None:
+            external_ips: Optional[List[Optional[str]]] = None,
+            cluster_info: Optional[provision_common.ClusterInfo] = None
+    ) -> None:
         """Updates the cluster IPs cached in the handle.
 
         We cache the cluster IPs in the handle to avoid having to retrieve
         them from the cloud provider every time we need them. This method
         updates the cached IPs.
 
         Optimizations:
@@ -2252,69 +2313,82 @@
                 cloud provider. Typically, it can be parsed from the provision
                 logs.
             external_ips: The external IPs to use for the cluster. Similar to
                 internal_ips, it is an optimization to avoid retrieving the
                 external IPs from the cloud provider.
 
         Raises:
-            exceptions.FetchIPError: if we failed to get the IPs. e.reason is
-                HEAD or WORKER.
+            exceptions.FetchClusterInfoError: if we failed to get the cluster
+                infos. e.reason is HEAD or WORKER.
         """
-
-        def is_provided_ips_valid(ips: Optional[List[Optional[str]]]) -> bool:
-            return (ips is not None and
-                    len(ips) == self.num_ips_per_node * self.launched_nodes and
-                    all(ip is not None for ip in ips))
-
-        use_internal_ips = self._use_internal_ips()
-
-        # cluster_feasible_ips is the list of IPs of the nodes in the cluster
-        # which can be used to connect to the cluster. It is a list of external
-        # IPs if the cluster is assigned public IPs, otherwise it is a list of
-        # internal IPs.
-        cluster_feasible_ips: List[str]
-        if is_provided_ips_valid(external_ips):
-            logger.debug(f'Using provided external IPs: {external_ips}')
-            cluster_feasible_ips = typing.cast(List[str], external_ips)
+        if cluster_info is not None:
+            self.cached_cluster_info = cluster_info
+            use_internal_ips = self._use_internal_ips()
+            cluster_feasible_ips = self.cached_cluster_info.get_feasible_ips(
+                use_internal_ips)
+            cluster_internal_ips = self.cached_cluster_info.get_feasible_ips(
+                force_internal_ips=True)
         else:
-            cluster_feasible_ips = backend_utils.get_node_ips(
-                self.cluster_yaml,
-                self.launched_nodes,
-                head_ip_max_attempts=max_attempts,
-                worker_ip_max_attempts=max_attempts,
-                get_internal_ips=use_internal_ips)
-
-        if self.cached_external_ips == cluster_feasible_ips:
-            logger.debug('Skipping the fetching of internal IPs as the cached '
-                         'external IPs matches the newly fetched ones.')
-            # Optimization: If the cached external IPs are the same as the
-            # retrieved feasible IPs, then we can skip retrieving internal
-            # IPs since the cached IPs are up-to-date.
-            return
-        logger.debug(
-            'Cached external IPs do not match with the newly fetched ones: '
-            f'cached ({self.cached_external_ips}), new ({cluster_feasible_ips})'
-        )
+            # For clouds that do not support the SkyPilot Provisioner API.
+            # TODO(zhwu): once all the clouds are migrated to SkyPilot
+            # Provisioner API, we should remove this else block
+            def is_provided_ips_valid(
+                    ips: Optional[List[Optional[str]]]) -> bool:
+                return (ips is not None and len(ips)
+                        == self.num_ips_per_node * self.launched_nodes and
+                        all(ip is not None for ip in ips))
+
+            use_internal_ips = self._use_internal_ips()
+
+            # cluster_feasible_ips is the list of IPs of the nodes in the
+            # cluster which can be used to connect to the cluster. It is a list
+            # of external IPs if the cluster is assigned public IPs, otherwise
+            # it is a list of internal IPs.
+            if is_provided_ips_valid(external_ips):
+                logger.debug(f'Using provided external IPs: {external_ips}')
+                cluster_feasible_ips = typing.cast(List[str], external_ips)
+            else:
+                cluster_feasible_ips = backend_utils.get_node_ips(
+                    self.cluster_yaml,
+                    self.launched_nodes,
+                    head_ip_max_attempts=max_attempts,
+                    worker_ip_max_attempts=max_attempts,
+                    get_internal_ips=use_internal_ips)
 
-        if use_internal_ips:
-            # Optimization: if we know use_internal_ips is True (currently
-            # only exposed for AWS and GCP), then our provisioner is guaranteed
-            # to not assign public IPs, thus the first list of IPs returned
-            # above are already private IPs. So skip the second query.
-            cluster_internal_ips = list(cluster_feasible_ips)
-        elif is_provided_ips_valid(internal_ips):
-            logger.debug(f'Using provided internal IPs: {internal_ips}')
-            cluster_internal_ips = typing.cast(List[str], internal_ips)
-        else:
-            cluster_internal_ips = backend_utils.get_node_ips(
-                self.cluster_yaml,
-                self.launched_nodes,
-                head_ip_max_attempts=max_attempts,
-                worker_ip_max_attempts=max_attempts,
-                get_internal_ips=True)
+            if self.cached_external_ips == cluster_feasible_ips:
+                logger.debug(
+                    'Skipping the fetching of internal IPs as the cached '
+                    'external IPs matches the newly fetched ones.')
+                # Optimization: If the cached external IPs are the same as the
+                # retrieved feasible IPs, then we can skip retrieving internal
+                # IPs since the cached IPs are up-to-date.
+                return
+
+            logger.debug(
+                'Cached external IPs do not match with the newly fetched ones: '
+                f'cached ({self.cached_external_ips}), new '
+                f'({cluster_feasible_ips})')
+
+            if use_internal_ips:
+                # Optimization: if we know use_internal_ips is True (currently
+                # only exposed for AWS and GCP), then our provisioner is
+                # guaranteed to not assign public IPs, thus the first list of
+                # IPs returned above are already private IPs. So skip the second
+                # query.
+                cluster_internal_ips = list(cluster_feasible_ips)
+            elif is_provided_ips_valid(internal_ips):
+                logger.debug(f'Using provided internal IPs: {internal_ips}')
+                cluster_internal_ips = typing.cast(List[str], internal_ips)
+            else:
+                cluster_internal_ips = backend_utils.get_node_ips(
+                    self.cluster_yaml,
+                    self.launched_nodes,
+                    head_ip_max_attempts=max_attempts,
+                    worker_ip_max_attempts=max_attempts,
+                    get_internal_ips=True)
 
         assert len(cluster_feasible_ips) == len(cluster_internal_ips), (
             f'Cluster {self.cluster_name!r}:'
             f'Expected same number of internal IPs {cluster_internal_ips}'
             f' and external IPs {cluster_feasible_ips}.')
 
         # List of (internal_ip, feasible_ip) tuples for all the nodes in the
@@ -2325,14 +2399,47 @@
 
         # Ensure head node is the first element, then sort based on the
         # external IPs for stableness
         stable_internal_external_ips = [internal_external_ips[0]] + sorted(
             internal_external_ips[1:], key=lambda x: x[1])
         self.stable_internal_external_ips = stable_internal_external_ips
 
+    @functools.lru_cache()
+    @timeline.event
+    def get_command_runners(self,
+                            force_cached: bool = False,
+                            avoid_ssh_control: bool = False
+                           ) -> List[command_runner.CommandRunner]:
+        """Returns a list of command runners for the cluster."""
+        ssh_credentials = backend_utils.ssh_credential_from_yaml(
+            self.cluster_yaml, self.docker_user, self.ssh_user)
+        if avoid_ssh_control:
+            ssh_credentials.pop('ssh_control_name', None)
+        if (clouds.ProvisionerVersion.RAY_PROVISIONER_SKYPILOT_TERMINATOR >=
+                self.launched_resources.cloud.PROVISIONER_VERSION):
+            ip_list = (self.cached_external_ips
+                       if force_cached else self.external_ips())
+            if ip_list is None:
+                return []
+            # Potentially refresh the external SSH ports, in case the existing
+            # cluster before #2491 was launched without external SSH ports
+            # cached.
+            port_list = self.external_ssh_ports()
+            runners = command_runner.SSHCommandRunner.make_runner_list(
+                zip(ip_list, port_list), **ssh_credentials)
+            return runners
+        if self.cached_cluster_info is None:
+            assert not force_cached, 'cached_cluster_info is None.'
+            self._update_cluster_info()
+        assert self.cached_cluster_info is not None, self
+        runners = provision_lib.get_command_runners(
+            self.cached_cluster_info.provider_name, self.cached_cluster_info,
+            **ssh_credentials)
+        return runners
+
     @property
     def cached_internal_ips(self) -> Optional[List[str]]:
         if self.stable_internal_external_ips is not None:
             return [ips[0] for ips in self.stable_internal_external_ips]
         return None
 
     def internal_ips(self,
@@ -2391,14 +2498,24 @@
         self.docker_user = docker_user
 
     @property
     def cluster_yaml(self):
         return os.path.expanduser(self._cluster_yaml)
 
     @property
+    def ssh_user(self):
+        if self.cached_cluster_info is not None:
+            # Overload ssh_user with the user stored in cluster_info, which is
+            # useful for kubernetes case, where the ssh_user can depend on the
+            # container image used. For those clusters launched with ray
+            # autoscaler, we directly use the ssh_user in yaml config.
+            return self.cached_cluster_info.ssh_user
+        return None
+
+    @property
     def head_ip(self):
         external_ips = self.cached_external_ips
         if external_ips is not None:
             return external_ips[0]
         return None
 
     @property
@@ -2435,34 +2552,42 @@
             state['stable_ssh_ports'] = None
         if version < 5:
             state['docker_user'] = None
 
         if version < 6:
             state['cluster_name_on_cloud'] = state['cluster_name']
 
-        if version < 7:
-            self.ssh_user = None
+        if version < 8:
+            self.cached_cluster_info = None
 
         self.__dict__.update(state)
 
         # Because the update_cluster_ips and update_ssh_ports
         # functions use the handle, we call it on the current instance
         # after the state is updated.
         if version < 3 and head_ip is not None:
             try:
                 self.update_cluster_ips()
-            except exceptions.FetchIPError:
+            except exceptions.FetchClusterInfoError:
                 # This occurs when an old cluster from was autostopped,
                 # so the head IP in the database is not updated.
                 pass
         if version < 4:
             self.update_ssh_ports()
 
         self._update_cluster_region()
 
+        if version < 8:
+            try:
+                self._update_cluster_info()
+            except exceptions.FetchClusterInfoError:
+                # This occurs when an old cluster from was autostopped,
+                # so the head IP in the database is not updated.
+                pass
+
 
 class CloudVmRayBackend(backends.Backend['CloudVmRayResourceHandle']):
     """Backend: runs on cloud virtual machines, managed by Ray.
 
     Changing this class may also require updates to:
       * Cloud providers' templates under config/
       * Cloud providers' implementations under clouds/
@@ -2567,14 +2692,25 @@
                                 'does not have zone specified.')
                     with ux_utils.print_exception_no_traceback():
                         raise exceptions.ResourcesMismatchError(
                             f'Task requested resources {example_resource} in zone '  # pylint: disable=line-too-long
                             f'{example_resource.zone!r},'
                             'but the existing cluster '
                             f'{zone_str}')
+                if (example_resource.requires_fuse and
+                        not launched_resources.requires_fuse):
+                    # Will not be reached for non-k8s case since the
+                    # less_demanding_than only fails fuse requirement when
+                    # the cloud is Kubernetes AND the cluster doesn't have fuse.
+                    with ux_utils.print_exception_no_traceback():
+                        raise exceptions.ResourcesMismatchError(
+                            'Task requires FUSE support for mounting object '
+                            'stores, but the existing cluster with '
+                            f'{launched_resources!r} does not support FUSE '
+                            f'mounting. Launch a new cluster to run this task.')
             requested_resource_str = ', '.join(requested_resource_list)
             if isinstance(task.resources, list):
                 requested_resource_str = f'[{requested_resource_str}]'
             elif isinstance(task.resources, set):
                 requested_resource_str = f'{{{requested_resource_str}}}'
             with ux_utils.print_exception_no_traceback():
                 raise exceptions.ResourcesMismatchError(
@@ -2735,30 +2871,25 @@
                     repr(handle.launched_resources.cloud),
                     provisioner.ClusterName(handle.cluster_name,
                                             handle.cluster_name_on_cloud),
                     handle.cluster_yaml,
                     provision_record=provision_record,
                     custom_resource=resources_vars.get('custom_resources'),
                     log_dir=self.log_dir)
-                # We must query the IPs from the cloud provider, when the
-                # provisioning is done, to make sure the cluster IPs are
-                # up-to-date.
+                # We use the IPs from the cluster_info to update_cluster_ips,
+                # when the provisioning is done, to make sure the cluster IPs
+                # are up-to-date.
                 # The staled IPs may be caused by the node being restarted
                 # manually or by the cloud provider.
                 # Optimize the case where the cluster's IPs can be retrieved
                 # from cluster_info.
-                internal_ips, external_ips = zip(*cluster_info.ip_tuples())
-                if not cluster_info.has_external_ips():
-                    external_ips = internal_ips
+                handle.docker_user = cluster_info.docker_user
                 handle.update_cluster_ips(max_attempts=_FETCH_IP_MAX_ATTEMPTS,
-                                          internal_ips=list(internal_ips),
-                                          external_ips=list(external_ips))
+                                          cluster_info=cluster_info)
                 handle.update_ssh_ports(max_attempts=_FETCH_IP_MAX_ATTEMPTS)
-                handle.docker_user = cluster_info.docker_user
-                handle.ssh_user = cluster_info.ssh_user
 
                 # Update launched resources.
                 handle.launched_resources = handle.launched_resources.copy(
                     region=provision_record.region, zone=provision_record.zone)
 
                 self._update_after_cluster_provisioned(
                     handle, to_provision_config.prev_handle, task,
@@ -2782,19 +2913,15 @@
             # NOTE: querying zones is expensive, observed 1node GCP >=4s.
             zone = handle.launched_resources.zone
             if zone is None:
                 get_zone_cmd = (
                     handle.launched_resources.cloud.get_zone_shell_cmd())
                 # zone is None for Azure
                 if get_zone_cmd is not None:
-                    ssh_credentials = backend_utils.ssh_credential_from_yaml(
-                        handle.cluster_yaml, handle.docker_user,
-                        handle.ssh_user)
-                    runners = command_runner.SSHCommandRunner.make_runner_list(
-                        ip_list, port_list=ssh_port_list, **ssh_credentials)
+                    runners = handle.get_command_runners()
 
                     def _get_zone(runner):
                         retry_count = 0
                         backoff = common_utils.Backoff(initial_backoff=1,
                                                        max_backoff_factor=3)
                         while True:
                             returncode, stdout, stderr = runner.run(
@@ -2827,16 +2954,19 @@
                     # to None.
 
             # For backward compatibility and robustness of skylet, it is checked
             # and restarted if necessary.
             logger.debug('Checking if skylet is running on the head node.')
             with rich_utils.safe_status(
                     '[bold cyan]Preparing SkyPilot runtime'):
+                # We need to source bashrc for skylet to make sure the autostop
+                # event can access the path to the cloud CLIs.
                 self.run_on_head(handle,
-                                 instance_setup.MAYBE_SKYLET_RESTART_CMD)
+                                 instance_setup.MAYBE_SKYLET_RESTART_CMD,
+                                 source_bashrc=True)
 
             self._update_after_cluster_provisioned(
                 handle, to_provision_config.prev_handle, task,
                 prev_cluster_status, ip_list, ssh_port_list, lock_path)
             return handle
 
     def _open_ports(self, handle: CloudVmRayResourceHandle) -> None:
@@ -2927,15 +3057,14 @@
                       workdir: Path) -> None:
         # Even though provision() takes care of it, there may be cases where
         # this function is called in isolation, without calling provision(),
         # e.g., in CLI.  So we should rerun rsync_up.
         fore = colorama.Fore
         style = colorama.Style
         ip_list = handle.external_ips()
-        port_list = handle.external_ssh_ports()
         assert ip_list is not None, 'external_ips is not cached in handle'
         full_workdir = os.path.abspath(os.path.expanduser(workdir))
 
         # These asserts have been validated at Task construction time.
         assert os.path.exists(full_workdir), f'{full_workdir} does not exist'
         if os.path.islink(full_workdir):
             logger.warning(
@@ -2952,22 +3081,18 @@
                 f'{fore.YELLOW}The size of workdir {workdir!r} '
                 f'is {dir_size} MB. Try to keep workdir small or use '
                 '.gitignore to exclude large files, as large sizes will slow '
                 f'down rsync.{style.RESET_ALL}')
 
         log_path = os.path.join(self.log_dir, 'workdir_sync.log')
 
-        ssh_credentials = backend_utils.ssh_credential_from_yaml(
-            handle.cluster_yaml, handle.docker_user, handle.ssh_user)
-
         # TODO(zhwu): refactor this with backend_utils.parallel_cmd_with_rsync
-        runners = command_runner.SSHCommandRunner.make_runner_list(
-            ip_list, port_list=port_list, **ssh_credentials)
+        runners = handle.get_command_runners()
 
-        def _sync_workdir_node(runner: command_runner.SSHCommandRunner) -> None:
+        def _sync_workdir_node(runner: command_runner.CommandRunner) -> None:
             runner.rsync(
                 source=workdir,
                 target=SKY_REMOTE_WORKDIR,
                 up=True,
                 log_path=log_path,
                 stream_logs=False,
             )
@@ -3006,54 +3131,59 @@
         style = colorama.Style
         fore = colorama.Fore
 
         if task.setup is None:
             return
         setup = task.setup
         # Sync the setup script up and run it.
-        ip_list = handle.external_ips()
         internal_ips = handle.internal_ips()
-        port_list = handle.external_ssh_ports()
-        assert ip_list is not None, 'external_ips is not cached in handle'
-        ssh_credentials = backend_utils.ssh_credential_from_yaml(
-            handle.cluster_yaml, handle.docker_user, handle.ssh_user)
-        # Disable connection sharing for setup script to avoid old
-        # connections being reused, which may cause stale ssh agent
-        # forwarding.
-        ssh_credentials.pop('ssh_control_name', None)
-
         remote_setup_file_name = f'/tmp/sky_setup_{self.run_timestamp}'
         # Need this `-i` option to make sure `source ~/.bashrc` work
         setup_cmd = f'/bin/bash -i {remote_setup_file_name} 2>&1'
+        runners = handle.get_command_runners(avoid_ssh_control=True)
 
         def _setup_node(node_id: int) -> None:
             setup_envs = task.envs.copy()
+            setup_envs.update(self._skypilot_predefined_env_vars(handle))
             setup_envs['SKYPILOT_SETUP_NODE_IPS'] = '\n'.join(internal_ips)
             setup_envs['SKYPILOT_SETUP_NODE_RANK'] = str(node_id)
-            runner = command_runner.SSHCommandRunner(ip_list[node_id],
-                                                     port=port_list[node_id],
-                                                     **ssh_credentials)
+            runner = runners[node_id]
             setup_script = log_lib.make_task_bash_script(setup,
                                                          env_vars=setup_envs)
-            with tempfile.NamedTemporaryFile('w', prefix='sky_setup_') as f:
-                f.write(setup_script)
-                f.flush()
-                setup_sh_path = f.name
-                runner.rsync(source=setup_sh_path,
-                             target=remote_setup_file_name,
-                             up=True,
-                             stream_logs=False)
+            encoded_script = shlex.quote(setup_script)
+            if (detach_setup or
+                    len(encoded_script) > _MAX_INLINE_SCRIPT_LENGTH):
+                with tempfile.NamedTemporaryFile('w', prefix='sky_setup_') as f:
+                    f.write(setup_script)
+                    f.flush()
+                    setup_sh_path = f.name
+                    runner.rsync(source=setup_sh_path,
+                                 target=remote_setup_file_name,
+                                 up=True,
+                                 stream_logs=False)
+                create_script_code = 'true'
+            else:
+                create_script_code = (f'{{ echo {encoded_script} > '
+                                      f'{remote_setup_file_name}; }}')
+
             if detach_setup:
                 return
             setup_log_path = os.path.join(self.log_dir,
-                                          f'setup-{runner.ip}.log')
+                                          f'setup-{runner.node_id}.log')
             returncode = runner.run(
-                setup_cmd,
+                f'{create_script_code} && {setup_cmd}',
                 log_path=setup_log_path,
                 process_stream=False,
+                # We do not source bashrc for setup, since bashrc is sourced
+                # in the script already.
+                # Skip an empty line and two lines due to the /bin/bash -i and
+                # source ~/.bashrc in the setup_cmd.
+                #   bash: cannot set terminal process group (7398): Inappropriate ioctl for device # pylint: disable=line-too-long
+                #   bash: no job control in this shell
+                skip_lines=3,
             )
 
             def error_message() -> str:
                 # Use the function to avoid tailing the file in success case
                 try:
                     last_10_lines = subprocess.run(
                         ['tail', '-n10',
@@ -3075,15 +3205,15 @@
                                 f'{colorama.Style.RESET_ALL}')
                 return err_msg
 
             subprocess_utils.handle_returncode(returncode=returncode,
                                                command=setup_cmd,
                                                error_msg=error_message)
 
-        num_nodes = len(ip_list)
+        num_nodes = len(runners)
         plural = 's' if num_nodes > 1 else ''
         if not detach_setup:
             logger.info(f'{fore.CYAN}Running setup on {num_nodes} node{plural}.'
                         f'{style.RESET_ALL}')
         # TODO(zhwu): run_in_parallel uses multi-thread to run the commands,
         # which can cause the program waiting for all the threads to finish,
         # even if some of them raise exceptions. We should replace it with
@@ -3100,72 +3230,77 @@
         logger.debug(f'Setup took {end - start} seconds.')
 
     def _exec_code_on_head(
         self,
         handle: CloudVmRayResourceHandle,
         codegen: str,
         job_id: int,
-        executable: str,
         detach_run: bool = False,
-        spot_dag: Optional['dag.Dag'] = None,
+        managed_job_dag: Optional['dag.Dag'] = None,
     ) -> None:
         """Executes generated code on the head node."""
         style = colorama.Style
         fore = colorama.Fore
-        ssh_credentials = backend_utils.ssh_credential_from_yaml(
-            handle.cluster_yaml, handle.docker_user, handle.ssh_user)
-        head_ssh_port = handle.head_ssh_port
-        runner = command_runner.SSHCommandRunner(handle.head_ip,
-                                                 port=head_ssh_port,
-                                                 **ssh_credentials)
-        with tempfile.NamedTemporaryFile('w', prefix='sky_app_') as fp:
-            fp.write(codegen)
-            fp.flush()
-            script_path = os.path.join(SKY_REMOTE_APP_DIR, f'sky_job_{job_id}')
-            # We choose to sync code + exec, because the alternative of 'ray
-            # submit' may not work as it may use system python (python2) to
-            # execute the script.  Happens for AWS.
-            runner.rsync(source=fp.name,
-                         target=script_path,
-                         up=True,
-                         stream_logs=False)
+
+        script_path = os.path.join(SKY_REMOTE_APP_DIR, f'sky_job_{job_id}')
         remote_log_dir = self.log_dir
         remote_log_path = os.path.join(remote_log_dir, 'run.log')
 
-        assert executable == 'python3', executable
         cd = f'cd {SKY_REMOTE_WORKDIR}'
 
+        mkdir_code = (f'{cd} && mkdir -p {remote_log_dir} && '
+                      f'touch {remote_log_path}')
+        encoded_script = shlex.quote(codegen)
+        create_script_code = (f'{{ echo {encoded_script} > {script_path}; }}')
         job_submit_cmd = (
-            'RAY_DASHBOARD_PORT=$(python -c "from sky.skylet import job_lib; print(job_lib.get_job_submission_port())" 2> /dev/null || echo 8265);'  # pylint: disable=line-too-long
-            f'{cd} && ray job submit '
+            f'RAY_DASHBOARD_PORT=$({constants.SKY_PYTHON_CMD} -c "from sky.skylet import job_lib; print(job_lib.get_job_submission_port())" 2> /dev/null || echo 8265);'  # pylint: disable=line-too-long
+            f'{cd} && {constants.SKY_RAY_CMD} job submit '
             '--address=http://127.0.0.1:$RAY_DASHBOARD_PORT '
             f'--submission-id {job_id}-$(whoami) --no-wait '
-            f'"{executable} -u {script_path} > {remote_log_path} 2>&1"')
+            # Redirect stderr to /dev/null to avoid distracting error from ray.
+            f'"{constants.SKY_PYTHON_CMD} -u {script_path} > {remote_log_path} 2> /dev/null"'
+        )
 
-        mkdir_code = (f'{cd} && mkdir -p {remote_log_dir} && '
-                      f'touch {remote_log_path}')
         code = job_lib.JobLibCodeGen.queue_job(job_id, job_submit_cmd)
-        job_submit_cmd = mkdir_code + ' && ' + code
-
-        if spot_dag is not None:
-            # Add the spot job to spot queue table.
-            spot_codegen = spot_lib.SpotCodeGen()
-            spot_code = spot_codegen.set_pending(job_id, spot_dag)
-            # Set the spot job to PENDING state to make sure that this spot
-            # job appears in the `sky spot queue`, when there are already 16
-            # controller process jobs running on the controller VM with 8
-            # CPU cores.
-            # The spot job should be set to PENDING state *after* the
+        job_submit_cmd = ' && '.join([mkdir_code, create_script_code, code])
+        if len(job_submit_cmd) > _MAX_INLINE_SCRIPT_LENGTH:
+            runners = handle.get_command_runners()
+            head_runner = runners[0]
+            with tempfile.NamedTemporaryFile('w', prefix='sky_app_') as fp:
+                fp.write(codegen)
+                fp.flush()
+                script_path = os.path.join(SKY_REMOTE_APP_DIR,
+                                           f'sky_job_{job_id}')
+                # We choose to sync code + exec, because the alternative of 'ray
+                # submit' may not work as it may use system python (python2) to
+                # execute the script. Happens for AWS.
+                head_runner.rsync(source=fp.name,
+                                  target=script_path,
+                                  up=True,
+                                  stream_logs=False)
+            job_submit_cmd = f'{mkdir_code} && {code}'
+
+        if managed_job_dag is not None:
+            # Add the managed job to job queue database.
+            managed_job_codegen = managed_jobs.ManagedJobCodeGen()
+            managed_job_code = managed_job_codegen.set_pending(
+                job_id, managed_job_dag)
+            # Set the managed job to PENDING state to make sure that this
+            # managed job appears in the `sky jobs queue`, when there are
+            # already 2x vCPU controller processes running on the controller VM,
+            # e.g., 16 controller processes running on a controller with 8
+            # vCPUs.
+            # The managed job should be set to PENDING state *after* the
             # controller process job has been queued, as our skylet on spot
-            # controller will set the spot job in FAILED state if the
+            # controller will set the managed job in FAILED state if the
             # controller process job does not exist.
-            # We cannot set the spot job to PENDING state in the codegen for
+            # We cannot set the managed job to PENDING state in the codegen for
             # the controller process job, as it will stay in the job pending
             # table and not be executed until there is an empty slot.
-            job_submit_cmd = job_submit_cmd + ' && ' + spot_code
+            job_submit_cmd = job_submit_cmd + ' && ' + managed_job_code
 
         returncode, stdout, stderr = self.run_on_head(handle,
                                                       job_submit_cmd,
                                                       stream_logs=False,
                                                       require_outputs=True)
 
         # Happens when someone calls `sky exec` but remote is outdated
@@ -3178,41 +3313,42 @@
                                            stderr=stdout + stderr)
 
         logger.info('Job submitted with Job ID: '
                     f'{style.BRIGHT}{job_id}{style.RESET_ALL}')
 
         try:
             if not detach_run:
-                if handle.cluster_name == spot_lib.SPOT_CONTROLLER_NAME:
-                    self.tail_spot_logs(handle, job_id)
+                if (handle.cluster_name in controller_utils.Controllers.
+                        JOBS_CONTROLLER.value.candidate_cluster_names):
+                    self.tail_managed_job_logs(handle, job_id)
                 else:
                     # Sky logs. Not using subprocess.run since it will make the
                     # ssh keep connected after ctrl-c.
                     self.tail_logs(handle, job_id)
         finally:
             name = handle.cluster_name
             controller = controller_utils.Controllers.from_name(name)
-            if controller == controller_utils.Controllers.SPOT_CONTROLLER:
+            if controller == controller_utils.Controllers.JOBS_CONTROLLER:
                 logger.info(
-                    f'{fore.CYAN}Spot Job ID: '
+                    f'{fore.CYAN}Managed Job ID: '
                     f'{style.BRIGHT}{job_id}{style.RESET_ALL}'
                     '\nTo cancel the job:\t\t'
-                    f'{backend_utils.BOLD}sky spot cancel {job_id}'
+                    f'{backend_utils.BOLD}sky jobs cancel {job_id}'
                     f'{backend_utils.RESET_BOLD}'
                     '\nTo stream job logs:\t\t'
-                    f'{backend_utils.BOLD}sky spot logs {job_id}'
+                    f'{backend_utils.BOLD}sky jobs logs {job_id}'
                     f'{backend_utils.RESET_BOLD}'
                     f'\nTo stream controller logs:\t'
-                    f'{backend_utils.BOLD}sky spot logs --controller {job_id}'
+                    f'{backend_utils.BOLD}sky jobs logs --controller {job_id}'
                     f'{backend_utils.RESET_BOLD}'
-                    '\nTo view all spot jobs:\t\t'
-                    f'{backend_utils.BOLD}sky spot queue'
+                    '\nTo view all managed jobs:\t'
+                    f'{backend_utils.BOLD}sky jobs queue'
                     f'{backend_utils.RESET_BOLD}'
-                    '\nTo view the spot job dashboard:\t'
-                    f'{backend_utils.BOLD}sky spot dashboard'
+                    '\nTo view managed job dashboard:\t'
+                    f'{backend_utils.BOLD}sky jobs dashboard'
                     f'{backend_utils.RESET_BOLD}')
             elif controller is None:
                 logger.info(f'{fore.CYAN}Job ID: '
                             f'{style.BRIGHT}{job_id}{style.RESET_ALL}'
                             '\nTo cancel the job:\t'
                             f'{backend_utils.BOLD}sky cancel {name} {job_id}'
                             f'{backend_utils.RESET_BOLD}'
@@ -3271,15 +3407,15 @@
         valid_resource = self.check_resources_fit_cluster(handle,
                                                           task,
                                                           check_ports=True)
         task_copy = copy.copy(task)
         # Handle multiple resources exec case.
         task_copy.set_resources(valid_resource)
         if len(task.resources) > 1:
-            logger.info('Multiple resources are specified'
+            logger.info('Multiple resources are specified '
                         f'for the task, using: {valid_resource}')
         task_copy.best_resources = None
         resources_str = backend_utils.get_task_resources_str(task_copy)
 
         if dryrun:
             logger.info(f'Dryrun complete. Would have run:\n{task}')
             return None
@@ -3330,15 +3466,15 @@
                 if not storage.persistent:
                     storage.delete()
 
     def _teardown(self,
                   handle: CloudVmRayResourceHandle,
                   terminate: bool,
                   purge: bool = False):
-        """Tear down/ Stop the cluster.
+        """Tear down or stop the cluster.
 
         Args:
             handle: The handle to the cluster.
             terminate: Terminate or stop the cluster.
             purge: Purge the cluster record from the cluster table, even if
                 the teardown fails.
         Raises:
@@ -3433,21 +3569,18 @@
         """
         if cancel_all:
             assert jobs is None, (
                 'If cancel_all=True, usage is to set jobs=None')
         code = job_lib.JobLibCodeGen.cancel_jobs(jobs, cancel_all)
 
         # All error messages should have been redirected to stdout.
-        returncode, stdout, stderr = self.run_on_head(handle,
-                                                      code,
-                                                      stream_logs=False,
-                                                      require_outputs=True)
-        # TODO(zongheng): remove after >=0.5.0, 2 minor versions after.
-        backend_utils.check_stale_runtime_on_remote(returncode, stdout + stderr,
-                                                    handle.cluster_name)
+        returncode, stdout, _ = self.run_on_head(handle,
+                                                 code,
+                                                 stream_logs=False,
+                                                 require_outputs=True)
         subprocess_utils.handle_returncode(
             returncode, code,
             f'Failed to cancel jobs on cluster {handle.cluster_name}.', stdout)
 
         cancelled_ids = common_utils.decode_payload(stdout)
         if cancelled_ids:
             logger.info(
@@ -3495,23 +3628,15 @@
 
         style = colorama.Style
         fore = colorama.Fore
         for job_id, log_dir in zip(job_ids, local_log_dirs):
             logger.info(f'{fore.CYAN}Job {job_id} logs: {log_dir}'
                         f'{style.RESET_ALL}')
 
-        ip_list = handle.external_ips()
-        assert ip_list is not None, 'external_ips is not cached in handle'
-        ssh_port_list = handle.external_ssh_ports()
-        assert ssh_port_list is not None, 'external_ssh_ports is not cached ' \
-                                          'in handle'
-        ssh_credentials = backend_utils.ssh_credential_from_yaml(
-            handle.cluster_yaml, handle.docker_user, handle.ssh_user)
-        runners = command_runner.SSHCommandRunner.make_runner_list(
-            ip_list, port_list=ssh_port_list, **ssh_credentials)
+        runners = handle.get_command_runners()
 
         def _rsync_down(args) -> None:
             """Rsync down logs from remote nodes.
 
             Args:
                 args: A tuple of (runner, local_log_dir, remote_log_dir)
             """
@@ -3537,20 +3662,28 @@
                          for runner in runners]
         subprocess_utils.run_in_parallel(_rsync_down, parallel_args)
         return dict(zip(job_ids, local_log_dirs))
 
     def tail_logs(self,
                   handle: CloudVmRayResourceHandle,
                   job_id: Optional[int],
-                  spot_job_id: Optional[int] = None,
+                  managed_job_id: Optional[int] = None,
                   follow: bool = True) -> int:
+        """Tail the logs of a job.
+
+        Args:
+            handle: The handle to the cluster.
+            job_id: The job ID to tail the logs of.
+            managed_job_id: The managed job ID for display purpose only.
+            follow: Whether to follow the logs.
+        """
         code = job_lib.JobLibCodeGen.tail_logs(job_id,
-                                               spot_job_id=spot_job_id,
+                                               managed_job_id=managed_job_id,
                                                follow=follow)
-        if job_id is None and spot_job_id is None:
+        if job_id is None and managed_job_id is None:
             logger.info(
                 'Job ID not provided. Streaming the logs of the latest job.')
 
         # With the stdin=subprocess.DEVNULL, the ctrl-c will not directly
         # kill the process, so we need to handle it manually here.
         if threading.current_thread() is threading.main_thread():
             signal.signal(signal.SIGINT, backend_utils.interrupt_handler)
@@ -3569,25 +3702,24 @@
                 # Refer to: https://github.com/ray-project/ray/blob/d462172be7c5779abf37609aed08af112a533e1e/python/ray/autoscaler/_private/subprocess_output_util.py#L264 # pylint: disable=line-too-long
                 stdin=subprocess.DEVNULL,
             )
         except SystemExit as e:
             returncode = e.code
         return returncode
 
-    def tail_spot_logs(self,
-                       handle: CloudVmRayResourceHandle,
-                       job_id: Optional[int] = None,
-                       job_name: Optional[str] = None,
-                       follow: bool = True) -> None:
+    def tail_managed_job_logs(self,
+                              handle: CloudVmRayResourceHandle,
+                              job_id: Optional[int] = None,
+                              job_name: Optional[str] = None,
+                              controller: bool = False,
+                              follow: bool = True) -> None:
         # if job_name is not None, job_id should be None
         assert job_name is None or job_id is None, (job_name, job_id)
-        if job_name is not None:
-            code = spot_lib.SpotCodeGen.stream_logs_by_name(job_name, follow)
-        else:
-            code = spot_lib.SpotCodeGen.stream_logs_by_id(job_id, follow)
+        code = managed_jobs.ManagedJobCodeGen.stream_logs(
+            job_name, job_id, follow, controller)
 
         # With the stdin=subprocess.DEVNULL, the ctrl-c will not directly
         # kill the process, so we need to handle it manually here.
         if threading.current_thread() is threading.main_thread():
             signal.signal(signal.SIGINT, backend_utils.interrupt_handler)
             signal.signal(signal.SIGTSTP, backend_utils.stop_handler)
 
@@ -3693,16 +3825,17 @@
             # Stop the ray autoscaler first to avoid the head node trying to
             # re-launch the worker nodes, during the termination of the
             # cluster.
             try:
                 # We do not check the return code, since Ray returns
                 # non-zero return code when calling Ray stop,
                 # even when the command was executed successfully.
-                self.run_on_head(handle, 'ray stop --force')
-            except exceptions.FetchIPError:
+                self.run_on_head(handle,
+                                 f'{constants.SKY_RAY_CMD} stop --force')
+            except exceptions.FetchClusterInfoError:
                 # This error is expected if the previous cluster IP is
                 # failed to be found,
                 # i.e., the cluster is already stopped/terminated.
                 if prev_cluster_status == status_lib.ClusterStatus.UP:
                     logger.warning(
                         'Failed to take down Ray autoscaler on the head node. '
                         'It might be because the cluster\'s head node has '
@@ -3971,14 +4104,22 @@
                 provision_lib.cleanup_ports(repr(cloud), cluster_name_on_cloud,
                                             handle.launched_resources.ports,
                                             config['provider'])
             except exceptions.NotSupportedError:
                 pass
             except exceptions.PortDoesNotExistError:
                 logger.debug('Ports do not exist. Skipping cleanup.')
+            except Exception as e:  # pylint: disable=broad-except
+                if purge:
+                    logger.warning(
+                        f'Failed to cleanup ports. Skipping since purge is '
+                        f'set. Details: '
+                        f'{common_utils.format_exception(e, use_bracket=True)}')
+                else:
+                    raise
 
         # The cluster file must exist because the cluster_yaml will only
         # be removed after the cluster entry in the database is removed.
         config = common_utils.read_yaml(handle.cluster_yaml)
         auth_config = config['auth']
         backend_utils.SSHConfigHelper.remove_cluster(handle.cluster_name,
                                                      handle.head_ip,
@@ -4009,14 +4150,24 @@
                      handle: CloudVmRayResourceHandle,
                      idle_minutes_to_autostop: Optional[int],
                      down: bool = False,
                      stream_logs: bool = True) -> None:
         # The core.autostop() function should have already checked that the
         # cloud and resources support requested autostop.
         if idle_minutes_to_autostop is not None:
+            # Skip auto-stop for Kubernetes clusters.
+            if (isinstance(handle.launched_resources.cloud, clouds.Kubernetes)
+                    and not down and idle_minutes_to_autostop >= 0):
+                # We should hit this code path only for the controllers on
+                # Kubernetes clusters.
+                assert (controller_utils.Controllers.from_name(
+                    handle.cluster_name) is not None), handle.cluster_name
+                logger.info('Auto-stop is not supported for Kubernetes '
+                            'clusters. Skipping.')
+                return
 
             # Check if we're stopping spot
             assert (handle.launched_resources is not None and
                     handle.launched_resources.cloud is not None), handle
             code = autostop_lib.AutostopCodeGen.set_autostop(
                 idle_minutes_to_autostop, self.NAME, down)
             returncode, _, stderr = self.run_on_head(handle,
@@ -4049,15 +4200,17 @@
         returncode, stdout, stderr = self.run_on_head(handle,
                                                       code,
                                                       require_outputs=True,
                                                       stream_logs=stream_logs)
 
         if returncode == 0:
             return common_utils.decode_payload(stdout)
-        logger.debug(f'Failed to check if cluster is autostopping: {stderr}')
+        logger.debug('Failed to check if cluster is autostopping with '
+                     f'{returncode}: {stdout+stderr}\n'
+                     f'Command: {code}')
         return False
 
     # TODO(zhwu): Refactor this to a CommandRunner class, so different backends
     # can support its own command runner.
     @timeline.event
     def run_on_head(
         self,
@@ -4069,14 +4222,15 @@
         stream_logs: bool = False,
         ssh_mode: command_runner.SshMode = command_runner.SshMode.
         NON_INTERACTIVE,
         under_remote_workdir: bool = False,
         require_outputs: bool = False,
         separate_stderr: bool = False,
         process_stream: bool = True,
+        source_bashrc: bool = False,
         **kwargs,
     ) -> Union[int, Tuple[int, str, str]]:
         """Runs 'cmd' on the cluster's head node.
 
         It will try to fetch the head node IP if it is not cached.
 
         Args:
@@ -4094,47 +4248,44 @@
                 workdir ~/sky_workdir.
             require_outputs: Whether to return the stdout and stderr of the
                 command.
             separate_stderr: Whether to separate stderr from stdout.
             process_stream: Whether to post-process the stdout/stderr of the
                 command, such as replacing or skipping lines on the fly. If
                 enabled, lines are printed only when '\r' or '\n' is found.
+            source_bashrc: Whether to source bashrc when running on the command
+                on the VM. If it is a user-related commands, it would always be
+                good to source bashrc to make sure the env vars are set.
 
         Returns:
             returncode
             or
             A tuple of (returncode, stdout, stderr).
 
         Raises:
-            exceptions.FetchIPError: If the head node IP cannot be fetched.
+            exceptions.FetchClusterInfoError: If the cluster info cannot be
+                fetched.
         """
         # This will try to fetch the head node IP if it is not cached.
-        external_ips = handle.external_ips(max_attempts=_FETCH_IP_MAX_ATTEMPTS)
-        head_ip = external_ips[0]
-        external_ssh_ports = handle.external_ssh_ports(
-            max_attempts=_FETCH_IP_MAX_ATTEMPTS)
-        head_ssh_port = external_ssh_ports[0]
 
-        ssh_credentials = backend_utils.ssh_credential_from_yaml(
-            handle.cluster_yaml, handle.docker_user, handle.ssh_user)
-        runner = command_runner.SSHCommandRunner(head_ip,
-                                                 port=head_ssh_port,
-                                                 **ssh_credentials)
+        runners = handle.get_command_runners()
+        head_runner = runners[0]
         if under_remote_workdir:
             cmd = f'cd {SKY_REMOTE_WORKDIR} && {cmd}'
 
-        return runner.run(
+        return head_runner.run(
             cmd,
             port_forward=port_forward,
             log_path=log_path,
             process_stream=process_stream,
             stream_logs=stream_logs,
             ssh_mode=ssh_mode,
             require_outputs=require_outputs,
             separate_stderr=separate_stderr,
+            source_bashrc=source_bashrc,
             **kwargs,
         )
 
     # --- Utilities ---
 
     @timeline.event
     def _check_existing_cluster(
@@ -4270,21 +4421,15 @@
         if file_mounts is None or not file_mounts:
             return
         symlink_commands = []
         fore = colorama.Fore
         style = colorama.Style
         logger.info(f'{fore.CYAN}Processing file mounts.{style.RESET_ALL}')
         start = time.time()
-        ip_list = handle.external_ips()
-        port_list = handle.external_ssh_ports()
-        assert ip_list is not None, 'external_ips is not cached in handle'
-        ssh_credentials = backend_utils.ssh_credential_from_yaml(
-            handle.cluster_yaml, handle.docker_user, handle.ssh_user)
-        runners = command_runner.SSHCommandRunner.make_runner_list(
-            ip_list, port_list=port_list, **ssh_credentials)
+        runners = handle.get_command_runners()
         log_path = os.path.join(self.log_dir, 'file_mounts.log')
 
         # Check the files and warn
         for dst, src in file_mounts.items():
             if not data_utils.is_cloud_store_url(src):
                 full_src = os.path.abspath(os.path.expanduser(src))
                 # Checked during Task.set_file_mounts().
@@ -4372,20 +4517,29 @@
                 source=src,
                 target=dst,
                 cmd=command,
                 run_rsync=False,
                 action_message='Syncing',
                 log_path=log_path,
                 stream_logs=False,
+                # Need to source bashrc, as the cloud specific CLI or SDK may
+                # require PATH in bashrc.
+                source_bashrc=True,
             )
         # (2) Run the commands to create symlinks on all the nodes.
         symlink_command = ' && '.join(symlink_commands)
         if symlink_command:
+            # ALIAS_SUDO_TO_EMPTY_FOR_ROOT_CMD sets sudo to empty string for
+            # root. We need this as we do not source bashrc for the command for
+            # better performance, and our sudo handling is only in bashrc.
+            symlink_command = (
+                f'{command_runner.ALIAS_SUDO_TO_EMPTY_FOR_ROOT_CMD} && '
+                f'{symlink_command}')
 
-            def _symlink_node(runner: command_runner.SSHCommandRunner):
+            def _symlink_node(runner: command_runner.CommandRunner):
                 returncode = runner.run(symlink_command, log_path=log_path)
                 subprocess_utils.handle_returncode(
                     returncode, symlink_command,
                     'Failed to create symlinks. The target destination '
                     f'may already exist. Log: {log_path}')
 
             subprocess_utils.run_in_parallel(_symlink_node, runners)
@@ -4417,21 +4571,15 @@
 
         fore = colorama.Fore
         style = colorama.Style
         plural = 's' if len(storage_mounts) > 1 else ''
         logger.info(f'{fore.CYAN}Processing {len(storage_mounts)} '
                     f'storage mount{plural}.{style.RESET_ALL}')
         start = time.time()
-        ip_list = handle.external_ips()
-        port_list = handle.external_ssh_ports()
-        assert ip_list is not None, 'external_ips is not cached in handle'
-        ssh_credentials = backend_utils.ssh_credential_from_yaml(
-            handle.cluster_yaml, handle.docker_user, handle.ssh_user)
-        runners = command_runner.SSHCommandRunner.make_runner_list(
-            ip_list, port_list=port_list, **ssh_credentials)
+        runners = handle.get_command_runners()
         log_path = os.path.join(self.log_dir, 'storage_mounts.log')
 
         for dst, storage_obj in storage_mounts.items():
             if not os.path.isabs(dst) and not dst.startswith('~/'):
                 dst = f'{SKY_REMOTE_WORKDIR}/{dst}'
             # Raised when the bucket is externall removed before re-mounting
             # with sky start.
@@ -4454,14 +4602,17 @@
                     runners,
                     source=src_print,
                     target=dst,
                     cmd=mount_cmd,
                     run_rsync=False,
                     action_message='Mounting',
                     log_path=log_path,
+                    # Need to source bashrc, as the cloud specific CLI or SDK
+                    # may require PATH in bashrc.
+                    source_bashrc=True,
                 )
             except exceptions.CommandError as e:
                 if e.returncode == exceptions.MOUNT_PATH_NON_EMPTY_CODE:
                     mount_path = (f'{colorama.Fore.RED}'
                                   f'{colorama.Style.BRIGHT}{dst}'
                                   f'{colorama.Style.RESET_ALL}')
                     error_msg = (f'Mount path {mount_path} is non-empty.'
@@ -4539,65 +4690,91 @@
             # object creation to sync local source syncing to the bucket. Local
             # source specified in Storage object is synced to the bucket only
             # when it is created with 'sky launch'.
             storage_mounts[dst] = storage_lib.Storage.from_metadata(
                 storage_metadata, sync_on_reconstruction=False)
         return storage_mounts
 
+    def _skypilot_predefined_env_vars(
+            self, handle: CloudVmRayResourceHandle) -> Dict[str, str]:
+        """Returns the SkyPilot predefined environment variables.
+
+        TODO(zhwu): Check if a single variable for all the cluster info is more
+        desirable or separate variables for each piece of info.
+        NOTE: In order to avoid complication in a potential future separation
+        of the info into multiple env vars, we should not treat this json format
+        as a sink for all the cluster info.
+        """
+        return {
+            'SKYPILOT_CLUSTER_INFO': json.dumps({
+                'cluster_name': handle.cluster_name,
+                'cloud': str(handle.launched_resources.cloud),
+                'region': handle.launched_resources.region,
+                'zone': handle.launched_resources.zone,
+            })
+        }
+
+    def _get_task_env_vars(self, task: task_lib.Task, job_id: int,
+                           handle: CloudVmRayResourceHandle) -> Dict[str, str]:
+        """Returns the environment variables for the task."""
+        env_vars = task.envs.copy()
+        # If it is a managed job, the TASK_ID_ENV_VAR will have been already set
+        # by the controller.
+        if constants.TASK_ID_ENV_VAR not in env_vars:
+            env_vars[
+                constants.TASK_ID_ENV_VAR] = common_utils.get_global_job_id(
+                    self.run_timestamp,
+                    cluster_name=handle.cluster_name,
+                    job_id=str(job_id))
+        env_vars.update(self._skypilot_predefined_env_vars(handle))
+        return env_vars
+
     def _execute_task_one_node(self, handle: CloudVmRayResourceHandle,
                                task: task_lib.Task, job_id: int,
                                detach_run: bool) -> None:
         # Launch the command as a Ray task.
         log_dir = os.path.join(self.log_dir, 'tasks')
 
         resources_dict = backend_utils.get_task_demands_dict(task)
         internal_ips = handle.internal_ips()
         assert internal_ips is not None, 'internal_ips is not cached in handle'
 
+        task_env_vars = self._get_task_env_vars(task, job_id, handle)
+
         codegen = RayCodeGen()
         codegen.add_prologue(job_id)
         codegen.add_gang_scheduling_placement_group_and_setup(
             1,
             resources_dict,
             stable_cluster_internal_ips=internal_ips,
             setup_cmd=self._setup_cmd,
             setup_log_path=os.path.join(log_dir, 'setup.log'),
-            envs=task.envs,
+            env_vars=task_env_vars,
         )
 
         if callable(task.run):
             run_fn_code = textwrap.dedent(inspect.getsource(task.run))
             run_fn_name = task.run.__name__
             codegen.register_run_fn(run_fn_code, run_fn_name)
 
-        # If it is a managed spot job, the TASK_ID_ENV_VAR will have been
-        # already set by the controller.
-        job_run_id = task.envs.get(
-            constants.TASK_ID_ENV_VAR,
-            common_utils.get_global_job_id(self.run_timestamp,
-                                           cluster_name=handle.cluster_name,
-                                           job_id=str(job_id)))
-
         command_for_node = task.run if isinstance(task.run, str) else None
         codegen.add_ray_task(
             bash_script=command_for_node,
-            env_vars=task.envs,
+            env_vars=task_env_vars,
             task_name=task.name,
-            job_run_id=job_run_id,
             ray_resources_dict=backend_utils.get_task_demands_dict(task),
             log_dir=log_dir)
 
         codegen.add_epilogue()
 
         self._exec_code_on_head(handle,
                                 codegen.build(),
                                 job_id,
-                                executable='python3',
                                 detach_run=detach_run,
-                                spot_dag=task.spot_dag)
+                                managed_job_dag=task.managed_job_dag)
 
     def _execute_task_n_nodes(self, handle: CloudVmRayResourceHandle,
                               task: task_lib.Task, job_id: int,
                               detach_run: bool) -> None:
         # Strategy:
         #   ray.init(...)
         #   for node:
@@ -4606,55 +4783,46 @@
         log_dir = os.path.join(log_dir_base, 'tasks')
         resources_dict = backend_utils.get_task_demands_dict(task)
         internal_ips = handle.internal_ips()
         assert internal_ips is not None, 'internal_ips is not cached in handle'
 
         # If TPU VM Pods is used, #num_nodes should be num_nodes * num_node_ips
         num_actual_nodes = task.num_nodes * handle.num_ips_per_node
+        task_env_vars = self._get_task_env_vars(task, job_id, handle)
 
         codegen = RayCodeGen()
         codegen.add_prologue(job_id)
         codegen.add_gang_scheduling_placement_group_and_setup(
             num_actual_nodes,
             resources_dict,
             stable_cluster_internal_ips=internal_ips,
             setup_cmd=self._setup_cmd,
             setup_log_path=os.path.join(log_dir, 'setup.log'),
-            envs=task.envs)
+            env_vars=task_env_vars)
 
         if callable(task.run):
             run_fn_code = textwrap.dedent(inspect.getsource(task.run))
             run_fn_name = task.run.__name__
             codegen.register_run_fn(run_fn_code, run_fn_name)
 
-        # If it is a managed spot job, the TASK_ID_ENV_VAR will have been
-        # already set by the controller.
-        job_run_id = task.envs.get(
-            constants.TASK_ID_ENV_VAR,
-            common_utils.get_global_job_id(self.run_timestamp,
-                                           cluster_name=handle.cluster_name,
-                                           job_id=str(job_id)))
-
         # TODO(zhwu): The resources limitation for multi-node ray.tune and
         # horovod should be considered.
         for i in range(num_actual_nodes):
             command_for_node = task.run if isinstance(task.run, str) else None
 
             # Ray's per-node resources, to constrain scheduling each command to
             # the corresponding node, represented by private IPs.
             codegen.add_ray_task(
                 bash_script=command_for_node,
-                env_vars=task.envs,
+                env_vars=task_env_vars,
                 task_name=task.name,
-                job_run_id=job_run_id,
                 ray_resources_dict=backend_utils.get_task_demands_dict(task),
                 log_dir=log_dir,
                 gang_scheduling_id=i)
 
         codegen.add_epilogue()
         # TODO(zhanghao): Add help info for downloading logs.
         self._exec_code_on_head(handle,
                                 codegen.build(),
                                 job_id,
-                                executable='python3',
                                 detach_run=detach_run,
-                                spot_dag=task.spot_dag)
+                                managed_job_dag=task.managed_job_dag)
```

### Comparing `skypilot-0.5.0/sky/backends/docker_utils.py` & `skypilot-0.6.0/sky/backends/docker_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/backends/local_docker_backend.py` & `skypilot-0.6.0/sky/backends/local_docker_backend.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/backends/monkey_patches/monkey_patch_ray_up.py` & `skypilot-0.6.0/sky/backends/monkey_patches/monkey_patch_ray_up.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/backends/wheel_utils.py` & `skypilot-0.6.0/sky/backends/wheel_utils.py`

 * *Files 1% similar despite different names*

```diff
@@ -103,22 +103,22 @@
                 'pip3', 'wheel', '--no-deps', norm_path, '--wheel-dir',
                 str(tmp_dir)
             ],
                            stdout=subprocess.DEVNULL,
                            stderr=subprocess.PIPE,
                            check=True)
         except subprocess.CalledProcessError as e:
-            raise RuntimeError('Fail to build pip wheel for SkyPilot. '
+            raise RuntimeError('Failed to build pip wheel for SkyPilot. '
                                f'Error message: {e.stderr.decode()}') from e
 
         try:
             wheel_path = next(tmp_dir.glob(_WHEEL_PATTERN))
         except StopIteration:
             raise RuntimeError(
-                f'Fail to find pip wheel for SkyPilot under {tmp_dir} with '
+                f'Failed to find pip wheel for SkyPilot under {tmp_dir} with '
                 f'glob pattern {_WHEEL_PATTERN!r}. '
                 f'Found: {list(map(str, tmp_dir.glob("*")))}.'
                 'No wheel file is generated.') from None
 
         # Use a unique temporary dir per wheel hash, because there may be many
         # concurrent 'sky launch' happening.  The path should be stable if the
         # wheel content hash doesn't change.
```

### Comparing `skypilot-0.5.0/sky/benchmark/benchmark_state.py` & `skypilot-0.6.0/sky/benchmark/benchmark_state.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/benchmark/benchmark_utils.py` & `skypilot-0.6.0/sky/benchmark/benchmark_utils.py`

 * *Files 1% similar despite different names*

```diff
@@ -22,14 +22,15 @@
 from sky import backends
 from sky import data
 from sky import global_user_state
 from sky import sky_logging
 from sky import status_lib
 from sky.backends import backend_utils
 from sky.benchmark import benchmark_state
+from sky.data import storage as storage_lib
 from sky.skylet import constants
 from sky.skylet import job_lib
 from sky.skylet import log_lib
 from sky.utils import common_utils
 from sky.utils import log_utils
 from sky.utils import rich_utils
 from sky.utils import subprocess_utils
@@ -163,27 +164,19 @@
 def _create_benchmark_bucket() -> Tuple[str, str]:
     # Generate a bucket name.
     # TODO(woosuk): Use a more pleasant naming scheme.
     # TODO(woosuk): Ensure that the bucket name is globally unique.
     bucket_name = f'sky-bench-{uuid.uuid4().hex[:4]}-{getpass.getuser()}'
 
     # Select the bucket type.
-    enabled_clouds = global_user_state.get_enabled_clouds()
-    enabled_clouds = [str(cloud) for cloud in enabled_clouds]
-    if 'AWS' in enabled_clouds:
-        bucket_type = data.StoreType.S3.value
-    elif 'GCP' in enabled_clouds:
-        bucket_type = data.StoreType.GCS.value
-    elif 'AZURE' in enabled_clouds:
-        raise RuntimeError(
-            'Azure Blob Storage is not supported yet. '
-            'Please enable another cloud to create a benchmark bucket.')
-    else:
-        raise RuntimeError('No cloud is enabled. '
-                           'Please enable at least one cloud.')
+    enabled_clouds = storage_lib.get_cached_enabled_storage_clouds_or_refresh(
+        raise_if_no_cloud_access=True)
+    # Already checked by raise_if_no_cloud_access=True.
+    assert enabled_clouds
+    bucket_type = data.StoreType.from_cloud(enabled_clouds[0]).value
 
     # Create a benchmark bucket.
     logger.info(f'Creating a bucket {bucket_name} to save the benchmark logs.')
     storage = data.Storage(bucket_name, source=None, persistent=True)
     storage.add_store(bucket_type)
 
     # Save the bucket name and type to the config.
```

### Comparing `skypilot-0.5.0/sky/cli.py` & `skypilot-0.6.0/sky/cli.py`

 * *Files 2% similar despite different names*

```diff
@@ -43,86 +43,70 @@
 import dotenv
 from rich import progress as rich_progress
 import yaml
 
 import sky
 from sky import backends
 from sky import check as sky_check
-from sky import clouds
+from sky import clouds as sky_clouds
 from sky import core
 from sky import exceptions
 from sky import global_user_state
-from sky import provision as provision_lib
+from sky import jobs as managed_jobs
 from sky import serve as serve_lib
 from sky import sky_logging
-from sky import spot as spot_lib
 from sky import status_lib
+from sky.adaptors import common as adaptors_common
 from sky.backends import backend_utils
 from sky.benchmark import benchmark_state
 from sky.benchmark import benchmark_utils
 from sky.clouds import service_catalog
 from sky.data import storage_utils
 from sky.provision.kubernetes import utils as kubernetes_utils
 from sky.skylet import constants
 from sky.skylet import job_lib
 from sky.skylet import log_lib
 from sky.usage import usage_lib
-from sky.utils import command_runner
 from sky.utils import common_utils
 from sky.utils import controller_utils
 from sky.utils import dag_utils
 from sky.utils import log_utils
 from sky.utils import resources_utils
 from sky.utils import rich_utils
 from sky.utils import subprocess_utils
 from sky.utils import timeline
 from sky.utils import ux_utils
 from sky.utils.cli_utils import status_utils
 
 if typing.TYPE_CHECKING:
     from sky.backends import backend as backend_lib
 
+pd = adaptors_common.LazyImport('pandas')
 logger = sky_logging.init_logger(__name__)
 
 _CONTEXT_SETTINGS = dict(help_option_names=['-h', '--help'])
 
 _CLUSTER_FLAG_HELP = """\
 A cluster name. If provided, either reuse an existing cluster with that name or
 provision a new cluster with that name. Otherwise provision a new cluster with
 an autogenerated name."""
-_INTERACTIVE_NODE_TYPES = ('cpunode', 'gpunode', 'tpunode')
-_INTERACTIVE_NODE_DEFAULT_RESOURCES = {
-    'cpunode': sky.Resources(cloud=None,
-                             instance_type=None,
-                             accelerators=None,
-                             use_spot=False),
-    'gpunode': sky.Resources(cloud=None,
-                             instance_type=None,
-                             accelerators={'K80': 1},
-                             use_spot=False),
-    'tpunode': sky.Resources(cloud=sky.GCP(),
-                             instance_type=None,
-                             accelerators={'tpu-v2-8': 1},
-                             accelerator_args={'runtime_version': '2.12.0'},
-                             use_spot=False),
-}
 
-# The maximum number of in-progress spot jobs to show in the status
+# The maximum number of in-progress managed jobs to show in the status
 # command.
-_NUM_SPOT_JOBS_TO_SHOW_IN_STATUS = 5
+_NUM_MANAGED_JOBS_TO_SHOW_IN_STATUS = 5
 
 _STATUS_PROPERTY_CLUSTER_NUM_ERROR_MESSAGE = (
     '{cluster_num} cluster{plural} {verb}. Please specify {cause} '
     'cluster to show its {property}.\nUsage: `sky status --{flag} <cluster>`')
 
 _ENDPOINTS_RETRY_MESSAGE = ('If the cluster was recently started, '
                             'please retry after a while.')
 
 _DAG_NOT_SUPPORTED_MESSAGE = ('YAML specifies a DAG which is only supported by '
-                              '`sky spot launch`. `{command}` supports a '
+                              '`sky jobs launch`. `{command}` supports a '
                               'single task only.')
 
 
 def _get_glob_clusters(clusters: List[str], silent: bool = False) -> List[str]:
     """Returns a list of clusters that match the glob pattern."""
     glob_clusters = []
     for cluster in clusters:
@@ -140,194 +124,14 @@
         glob_storage = global_user_state.get_glob_storage_name(storage_object)
         if len(glob_storage) == 0:
             click.echo(f'Storage {storage_object} not found.')
         glob_storages.extend(glob_storage)
     return list(set(glob_storages))
 
 
-def _interactive_node_cli_command(cli_func):
-    """Click command decorator for interactive node commands."""
-    assert cli_func.__name__ in _INTERACTIVE_NODE_TYPES, cli_func.__name__
-
-    cluster_option = click.option('--cluster',
-                                  '-c',
-                                  default=None,
-                                  type=str,
-                                  required=False,
-                                  help=_CLUSTER_FLAG_HELP)
-    port_forward_option = click.option(
-        '--port-forward',
-        '-p',
-        multiple=True,
-        default=[],
-        type=int,
-        required=False,
-        help=('Port to be forwarded. To forward multiple ports, '
-              'use this option multiple times.'))
-    screen_option = click.option('--screen',
-                                 default=False,
-                                 is_flag=True,
-                                 help='If true, attach using screen.')
-    tmux_option = click.option('--tmux',
-                               default=False,
-                               is_flag=True,
-                               help='If true, attach using tmux.')
-    cloud_option = click.option('--cloud',
-                                default=None,
-                                type=str,
-                                help='Cloud provider to use.')
-    instance_type_option = click.option('--instance-type',
-                                        '-t',
-                                        default=None,
-                                        type=str,
-                                        help='Instance type to use.')
-    cpus = click.option(
-        '--cpus',
-        default=None,
-        type=str,
-        help=('Number of vCPUs each instance must have '
-              '(e.g., ``--cpus=4`` (exactly 4) or ``--cpus=4+`` (at least 4)). '
-              'This is used to automatically select the instance type.'))
-    memory = click.option(
-        '--memory',
-        default=None,
-        type=str,
-        required=False,
-        help=('Amount of memory each instance must have in GB (e.g., '
-              '``--memory=16`` (exactly 16GB), ``--memory=16+`` (at least '
-              '16GB))'))
-    gpus = click.option('--gpus',
-                        default=None,
-                        type=str,
-                        help=('Type and number of GPUs to use '
-                              '(e.g., ``--gpus=V100:8`` or ``--gpus=V100``).'))
-    tpus = click.option(
-        '--tpus',
-        default=None,
-        type=str,
-        help=('Type and number of TPUs to use (e.g., ``--tpus=tpu-v3-8:4`` or '
-              '``--tpus=tpu-v3-8``).'))
-
-    spot_option = click.option('--use-spot',
-                               default=None,
-                               is_flag=True,
-                               help='If true, use spot instances.')
-
-    tpuvm_option = click.option('--tpu-vm/--no-tpu-vm',
-                                default=True,
-                                is_flag=True,
-                                help='If true, use TPU VMs.')
-
-    disk_size = click.option('--disk-size',
-                             default=None,
-                             type=int,
-                             required=False,
-                             help=('OS disk size in GBs.'))
-    disk_tier = click.option('--disk-tier',
-                             default=None,
-                             type=click.Choice(
-                                 resources_utils.DiskTier.supported_tiers(),
-                                 case_sensitive=False),
-                             required=False,
-                             help=resources_utils.DiskTier.cli_help_message())
-    ports = click.option(
-        '--ports',
-        required=False,
-        type=str,
-        multiple=True,
-        help=('Ports to open on the cluster. '
-              'If specified, overrides the "ports" config in the YAML. '),
-    )
-    no_confirm = click.option('--yes',
-                              '-y',
-                              is_flag=True,
-                              default=False,
-                              required=False,
-                              help='Skip confirmation prompt.')
-    idle_autostop = click.option('--idle-minutes-to-autostop',
-                                 '-i',
-                                 default=None,
-                                 type=int,
-                                 required=False,
-                                 help=('Automatically stop the cluster after '
-                                       'this many minutes of idleness, i.e. '
-                                       'no running or pending jobs in the '
-                                       'cluster\'s job queue. Idleness gets '
-                                       'reset whenever setting-up/running/'
-                                       'pending jobs are found in the job '
-                                       'queue. If not set, the cluster '
-                                       'will not be auto-stopped.'))
-    autodown = click.option('--down',
-                            default=False,
-                            is_flag=True,
-                            required=False,
-                            help=('Autodown the cluster: tear down the '
-                                  'cluster after all jobs finish '
-                                  '(successfully or abnormally). If '
-                                  '--idle-minutes-to-autostop is also set, '
-                                  'the cluster will be torn down after the '
-                                  'specified idle time. Note that if errors '
-                                  'occur during provisioning/data syncing/'
-                                  'setting up, the cluster will not be torn '
-                                  'down for debugging purposes.'))
-    retry_until_up = click.option('--retry-until-up',
-                                  '-r',
-                                  is_flag=True,
-                                  default=False,
-                                  required=False,
-                                  help=('Whether to retry provisioning '
-                                        'infinitely until the cluster is up '
-                                        'if we fail to launch the cluster on '
-                                        'any possible region/cloud due to '
-                                        'unavailability errors.'))
-    region_option = click.option('--region',
-                                 default=None,
-                                 type=str,
-                                 required=False,
-                                 help='The region to use.')
-    zone_option = click.option('--zone',
-                               default=None,
-                               type=str,
-                               required=False,
-                               help='The zone to use.')
-
-    click_decorators = [
-        cli.command(cls=_DocumentedCodeCommand),
-        cluster_option,
-        no_confirm,
-        port_forward_option,
-        idle_autostop,
-        autodown,
-        retry_until_up,
-
-        # Resource options
-        *([cloud_option] if cli_func.__name__ != 'tpunode' else []),
-        region_option,
-        zone_option,
-        instance_type_option,
-        cpus,
-        memory,
-        disk_size,
-        disk_tier,
-        ports,
-        *([gpus] if cli_func.__name__ == 'gpunode' else []),
-        *([tpus] if cli_func.__name__ == 'tpunode' else []),
-        spot_option,
-        *([tpuvm_option] if cli_func.__name__ == 'tpunode' else []),
-
-        # Attach options
-        screen_option,
-        tmux_option,
-    ]
-    decorator = functools.reduce(lambda res, f: f(res),
-                                 reversed(click_decorators), cli_func)
-
-    return decorator
-
-
 def _parse_env_var(env_var: str) -> Tuple[str, str]:
     """Parse env vars into a (KEY, VAL) pair."""
     if '=' not in env_var:
         value = os.environ.get(env_var)
         if value is None:
             raise click.UsageError(
                 f'{env_var} is not set in local environment.')
@@ -671,15 +475,15 @@
         ports: Optional[Tuple[str]] = None) -> Dict[str, Any]:
     """Parses the override parameters into a dictionary."""
     override_params: Dict[str, Any] = {}
     if cloud is not None:
         if cloud.lower() == 'none':
             override_params['cloud'] = None
         else:
-            override_params['cloud'] = clouds.CLOUD_REGISTRY.from_str(cloud)
+            override_params['cloud'] = sky_clouds.CLOUD_REGISTRY.from_str(cloud)
     if region is not None:
         if region.lower() == 'none':
             override_params['region'] = None
         else:
             override_params['region'] = region
     if zone is not None:
         if zone.lower() == 'none':
@@ -721,89 +525,27 @@
         else:
             override_params['disk_tier'] = disk_tier
     if ports:
         override_params['ports'] = ports
     return override_params
 
 
-def _default_interactive_node_name(node_type: str):
-    """Returns a deterministic name to refer to the same node."""
-    # FIXME: this technically can collide in Azure/GCP with another
-    # same-username user.  E.g., sky-gpunode-ubuntu.  Not a problem on AWS
-    # which is the current cloud for interactive nodes.
-    assert node_type in _INTERACTIVE_NODE_TYPES, node_type
-    return f'sky-{node_type}-{common_utils.get_cleaned_username()}'
-
-
-def _infer_interactive_node_type(resources: sky.Resources):
-    """Determine interactive node type from resources."""
-    accelerators = resources.accelerators
-    cloud = resources.cloud
-    if accelerators:
-        # We only support homogenous accelerators for now.
-        assert len(accelerators) == 1, resources
-        acc, _ = list(accelerators.items())[0]
-        is_gcp = cloud is not None and cloud.is_same_cloud(sky.GCP())
-        if is_gcp and 'tpu' in acc:
-            return 'tpunode'
-        return 'gpunode'
-    return 'cpunode'
-
-
-def _check_resources_match(backend: backends.Backend,
-                           cluster_name: str,
-                           task: 'sky.Task',
-                           node_type: Optional[str] = None) -> None:
-    """Check matching resources when reusing an existing cluster.
-
-    The only exception is when [cpu|tpu|gpu]node -c cluster_name is used with no
-    additional arguments, then login succeeds.
-
-    Args:
-        cluster_name: The name of the cluster.
-        task: The task requested to be run on the cluster.
-        node_type: Only used for interactive node. Node type to attach to VM.
-    """
-    handle = global_user_state.get_handle_from_cluster_name(cluster_name)
-    if handle is None:
-        return
-
-    if node_type is not None:
-        assert isinstance(handle,
-                          backends.CloudVmRayResourceHandle), (node_type,
-                                                               handle)
-        inferred_node_type = _infer_interactive_node_type(
-            handle.launched_resources)
-        if node_type != inferred_node_type:
-            name_arg = ''
-            if cluster_name != _default_interactive_node_name(
-                    inferred_node_type):
-                name_arg = f' -c {cluster_name}'
-            raise click.UsageError(
-                f'Failed to attach to interactive node {cluster_name}. '
-                f'Please use: {colorama.Style.BRIGHT}'
-                f'sky {inferred_node_type}{name_arg}{colorama.Style.RESET_ALL}')
-        return
-    backend.check_resources_fit_cluster(handle, task)
-
-
 def _launch_with_confirm(
     task: sky.Task,
     backend: backends.Backend,
     cluster: Optional[str],
     *,
     dryrun: bool,
     detach_run: bool,
     detach_setup: bool = False,
     no_confirm: bool = False,
     idle_minutes_to_autostop: Optional[int] = None,
     down: bool = False,  # pylint: disable=redefined-outer-name
     retry_until_up: bool = False,
     no_setup: bool = False,
-    node_type: Optional[str] = None,
     clone_disk_from: Optional[str] = None,
 ):
     """Launch a cluster with a Task."""
     if cluster is None:
         cluster = backend_utils.generate_cluster_name()
 
     clone_source_str = ''
@@ -811,28 +553,31 @@
         clone_source_str = f' from the disk of {clone_disk_from!r}'
         task, _ = backend_utils.check_can_clone_disk_and_override_task(
             clone_disk_from, cluster, task)
 
     with sky.Dag() as dag:
         dag.add(task)
 
-    maybe_status, _ = backend_utils.refresh_cluster_status_handle(cluster)
+    maybe_status, handle = backend_utils.refresh_cluster_status_handle(cluster)
     if maybe_status is None:
         # Show the optimize log before the prompt if the cluster does not exist.
         try:
-            backend_utils.check_public_cloud_enabled()
+            sky_check.get_cached_enabled_clouds_or_refresh(
+                raise_if_no_cloud_access=True)
         except exceptions.NoCloudAccessError as e:
             # Catch the exception where the public cloud is not enabled, and
-            # only print the error message without the error type.
-            click.secho(e, fg='yellow')
-            sys.exit(1)
+            # make it yellow for better visibility.
+            with ux_utils.print_exception_no_traceback():
+                raise RuntimeError(f'{colorama.Fore.YELLOW}{e}'
+                                   f'{colorama.Style.RESET_ALL}') from e
         dag = sky.optimize(dag)
     task = dag.tasks[0]
 
-    _check_resources_match(backend, cluster, task, node_type=node_type)
+    if handle is not None:
+        backend.check_resources_fit_cluster(handle, task)
 
     confirm_shown = False
     if not no_confirm:
         # Prompt if (1) --cluster is None, or (2) cluster doesn't exist, or (3)
         # it exists but is STOPPED.
         prompt = None
         if maybe_status is None:
@@ -842,169 +587,31 @@
                 'Proceed?')
         elif maybe_status == status_lib.ClusterStatus.STOPPED:
             prompt = f'Restarting the stopped cluster {cluster!r}. Proceed?'
         if prompt is not None:
             confirm_shown = True
             click.confirm(prompt, default=True, abort=True, show_default=True)
 
-    if node_type is not None:
-        if maybe_status != status_lib.ClusterStatus.UP:
-            click.secho(f'Setting up interactive node {cluster}...',
-                        fg='yellow')
-
-        # We do not sky.launch if interactive node is already up, so we need
-        # to update idle timeout and autodown here.
-        elif idle_minutes_to_autostop is not None:
-            core.autostop(cluster, idle_minutes_to_autostop, down)
-        elif down:
-            core.autostop(cluster, 1, down)
-
-    elif not confirm_shown:
+    if not confirm_shown:
         click.secho(f'Running task on cluster {cluster}...', fg='yellow')
 
-    if node_type is None or maybe_status != status_lib.ClusterStatus.UP:
-        # No need to sky.launch again when interactive node is already up.
-        sky.launch(
-            dag,
-            dryrun=dryrun,
-            stream_logs=True,
-            cluster_name=cluster,
-            detach_setup=detach_setup,
-            detach_run=detach_run,
-            backend=backend,
-            idle_minutes_to_autostop=idle_minutes_to_autostop,
-            down=down,
-            retry_until_up=retry_until_up,
-            no_setup=no_setup,
-            clone_disk_from=clone_disk_from,
-        )
-
-
-# TODO: skip installing ray to speed up provisioning.
-def _create_and_ssh_into_node(
-    node_type: str,
-    resources: sky.Resources,
-    cluster_name: str,
-    backend: Optional['backend_lib.Backend'] = None,
-    port_forward: Optional[List[int]] = None,
-    session_manager: Optional[str] = None,
-    user_requested_resources: Optional[bool] = False,
-    no_confirm: bool = False,
-    idle_minutes_to_autostop: Optional[int] = None,
-    down: bool = False,  # pylint: disable=redefined-outer-name
-    retry_until_up: bool = False,
-):
-    """Creates and attaches to an interactive node.
-
-    Args:
-        node_type: Type of the interactive node: { 'cpunode', 'gpunode' }.
-        resources: Resources to attach to VM.
-        cluster_name: a cluster name to identify the interactive node.
-        backend: the Backend to use (currently only CloudVmRayBackend).
-        port_forward: List of ports to forward.
-        session_manager: Attach session manager: { 'screen', 'tmux' }.
-        user_requested_resources: If true, user requested resources explicitly.
-        no_confirm: If true, skips confirmation prompt presented to user.
-        idle_minutes_to_autostop: Automatically stop the cluster after
-                                  specified minutes of idleness. Idleness gets
-                                  reset whenever setting-up/running/pending
-                                  jobs are found in the job queue.
-        down: If true, autodown the cluster after all jobs finish. If
-              idle_minutes_to_autostop is also set, the cluster will be torn
-              down after the specified idle time.
-        retry_until_up: Whether to retry provisioning infinitely until the
-                        cluster is up if we fail to launch due to
-                        unavailability errors.
-    """
-    assert node_type in _INTERACTIVE_NODE_TYPES, node_type
-    assert session_manager in (None, 'screen', 'tmux'), session_manager
-
-    backend = backend if backend is not None else backends.CloudVmRayBackend()
-    if not isinstance(backend, backends.CloudVmRayBackend):
-        raise click.UsageError('Interactive nodes are only supported for '
-                               f'{backends.CloudVmRayBackend.__name__} '
-                               f'backend. Got {type(backend).__name__}.')
-
-    maybe_status, handle = backend_utils.refresh_cluster_status_handle(
-        cluster_name)
-    if maybe_status is not None:
-        if user_requested_resources:
-            if not resources.less_demanding_than(handle.launched_resources):
-                name_arg = ''
-                if cluster_name != _default_interactive_node_name(node_type):
-                    name_arg = f' -c {cluster_name}'
-                raise click.UsageError(
-                    f'Relaunching interactive node {cluster_name!r} with '
-                    'mismatched resources.\n    '
-                    f'Requested resources: {resources}\n    '
-                    f'Launched resources: {handle.launched_resources}\n'
-                    'To login to existing cluster, use '
-                    f'{colorama.Style.BRIGHT}sky {node_type}{name_arg}'
-                    f'{colorama.Style.RESET_ALL}. To launch a new cluster, '
-                    f'use {colorama.Style.BRIGHT}sky {node_type} -c NEW_NAME '
-                    f'{colorama.Style.RESET_ALL}')
-        else:
-            # Use existing interactive node if it exists and no user
-            # resources were specified.
-            resources = handle.launched_resources
-
-    # TODO: Add conda environment replication
-    # should be setup =
-    # 'conda env export | grep -v "^prefix: " > environment.yml'
-    # && conda env create -f environment.yml
-    task = sky.Task(
-        node_type,
-        workdir=None,
-        setup=None,
-    )
-    task.set_resources(resources)
-
-    _launch_with_confirm(
-        task,
-        backend,
-        cluster_name,
-        dryrun=False,
-        detach_run=True,
-        no_confirm=no_confirm,
+    sky.launch(
+        dag,
+        dryrun=dryrun,
+        stream_logs=True,
+        cluster_name=cluster,
+        detach_setup=detach_setup,
+        detach_run=detach_run,
+        backend=backend,
         idle_minutes_to_autostop=idle_minutes_to_autostop,
         down=down,
         retry_until_up=retry_until_up,
-        node_type=node_type,
+        no_setup=no_setup,
+        clone_disk_from=clone_disk_from,
     )
-    handle = global_user_state.get_handle_from_cluster_name(cluster_name)
-    assert isinstance(handle, backends.CloudVmRayResourceHandle), handle
-
-    # Use ssh rather than 'ray attach' to suppress ray messages, speed up
-    # connection, and for allowing adding 'cd workdir' in the future.
-    # Disable check, since the returncode could be non-zero if the user Ctrl-D.
-    commands = []
-    if session_manager == 'screen':
-        commands += ['screen', '-D', '-R']
-    elif session_manager == 'tmux':
-        commands += ['tmux', 'attach', '||', 'tmux', 'new']
-    backend.run_on_head(handle,
-                        commands,
-                        port_forward=port_forward,
-                        ssh_mode=command_runner.SshMode.LOGIN)
-    cluster_name = handle.cluster_name
-
-    click.echo('To attach to it again:  ', nl=False)
-    if cluster_name == _default_interactive_node_name(node_type):
-        option = ''
-    else:
-        option = f' -c {cluster_name}'
-    click.secho(f'sky {node_type}{option}', bold=True)
-    click.echo('To stop the node:\t', nl=False)
-    click.secho(f'sky stop {cluster_name}', bold=True)
-    click.echo('To tear down the node:\t', nl=False)
-    click.secho(f'sky down {cluster_name}', bold=True)
-    click.echo('To upload a folder:\t', nl=False)
-    click.secho(f'rsync -rP /local/path {cluster_name}:/remote/path', bold=True)
-    click.echo('To download a folder:\t', nl=False)
-    click.secho(f'rsync -rP {cluster_name}:/remote/path /local/path', bold=True)
 
 
 def _check_yaml(entrypoint: str) -> Tuple[bool, Optional[Dict[str, Any]]]:
     """Checks if entrypoint is a readable YAML file.
 
     Args:
         entrypoint: Path to a YAML file.
@@ -1077,15 +684,15 @@
             field_value = params.pop(field, None)
             if field_value is not None:
                 click.secho(f'Override param {field}={field_value} is ignored.',
                             fg='yellow')
 
 
 def _make_task_or_dag_from_entrypoint_with_overrides(
-    entrypoint: List[str],
+    entrypoint: Tuple[str, ...],
     *,
     entrypoint_name: str = 'Task',
     name: Optional[str] = None,
     workdir: Optional[str] = None,
     cloud: Optional[str] = None,
     region: Optional[str] = None,
     zone: Optional[str] = None,
@@ -1097,16 +704,16 @@
     use_spot: Optional[bool] = None,
     image_id: Optional[str] = None,
     disk_size: Optional[int] = None,
     disk_tier: Optional[str] = None,
     ports: Optional[Tuple[str]] = None,
     env: Optional[List[Tuple[str, str]]] = None,
     field_to_ignore: Optional[List[str]] = None,
-    # spot launch specific
-    spot_recovery: Optional[str] = None,
+    # job launch specific
+    job_recovery: Optional[str] = None,
 ) -> Union[sky.Task, sky.Dag]:
     """Creates a task or a dag from an entrypoint with overrides.
 
     Returns:
         A dag iff the entrypoint is YAML and contains more than 1 task.
         Otherwise, a task.
     """
@@ -1166,17 +773,17 @@
         task = sky.Task(name='sky-cmd', run=entrypoint)
         task.set_resources({sky.Resources()})
 
     # Override.
     if workdir is not None:
         task.workdir = workdir
 
-    # Spot launch specific.
-    if spot_recovery is not None:
-        override_params['spot_recovery'] = spot_recovery
+    # job launch specific.
+    if job_recovery is not None:
+        override_params['job_recovery'] = job_recovery
 
     task.set_resources_override(override_params)
 
     if num_nodes is not None:
         task.num_nodes = num_nodes
     if name is not None:
         task.name = name
@@ -1205,39 +812,88 @@
 
     def get_help(self, ctx):
         help_str = ctx.command.help
         ctx.command.help = help_str.replace('.. code-block:: bash\n', '\b')
         return super().get_help(ctx)
 
 
-def _with_deprecation_warning(f, original_name, alias_name):
+def _with_deprecation_warning(
+        f,
+        original_name: str,
+        alias_name: str,
+        override_command_argument: Optional[Dict[str, Any]] = None):
 
     @functools.wraps(f)
     def wrapper(self, *args, **kwargs):
+        override_str = ''
+        if override_command_argument is not None:
+            overrides = []
+            for k, v in override_command_argument.items():
+                if isinstance(v, bool):
+                    if v:
+                        overrides.append(f'--{k}')
+                    else:
+                        overrides.append(f'--no-{k}')
+                else:
+                    overrides.append(f'--{k.replace("_", "-")}={v}')
+            override_str = ' with additional arguments ' + ' '.join(overrides)
         click.secho(
-            f'WARNING: `{alias_name}` is deprecated and will be removed in a '
-            f'future release. Please use `{original_name}` instead.\n',
+            f'WARNING: `{alias_name}` has been renamed to `{original_name}` '
+            f'and will be removed in a future release. Please use the '
+            f'latter{override_str} instead.\n',
             err=True,
             fg='yellow')
         return f(self, *args, **kwargs)
 
     return wrapper
 
 
-def _add_command_alias_to_group(group, command, name, hidden):
+def _override_arguments(callback, override_command_argument: Dict[str, Any]):
+
+    def wrapper(*args, **kwargs):
+        logger.info(f'Overriding arguments: {override_command_argument}')
+        kwargs.update(override_command_argument)
+        return callback(*args, **kwargs)
+
+    return wrapper
+
+
+def _add_command_alias(
+    group: click.Group,
+    command: click.Command,
+    hidden: bool = False,
+    new_group: Optional[click.Group] = None,
+    new_command_name: Optional[str] = None,
+    override_command_argument: Optional[Dict[str, Any]] = None,
+    with_warning: bool = True,
+) -> None:
     """Add a alias of a command to a group."""
+    if new_group is None:
+        new_group = group
+    if new_command_name is None:
+        new_command_name = command.name
+    if new_group == group and new_command_name == command.name:
+        raise ValueError('Cannot add an alias to the same command.')
     new_command = copy.deepcopy(command)
     new_command.hidden = hidden
-    new_command.name = name
+    new_command.name = new_command_name
+
+    if override_command_argument:
+        new_command.callback = _override_arguments(new_command.callback,
+                                                   override_command_argument)
 
     orig = f'sky {group.name} {command.name}'
-    alias = f'sky {group.name} {name}'
-    new_command.invoke = _with_deprecation_warning(new_command.invoke, orig,
-                                                   alias)
-    group.add_command(new_command, name=name)
+    alias = f'sky {new_group.name} {new_command_name}'
+    if with_warning:
+        new_command.invoke = _with_deprecation_warning(
+            new_command.invoke,
+            orig,
+            alias,
+            override_command_argument=override_command_argument)
+    new_group.add_command(new_command, name=new_command_name)
 
 
 def _deprecate_and_hide_command(group, command_to_deprecate,
                                 alternative_command):
     """Hide a command and show a deprecation note, hinting the alternative."""
     command_to_deprecate.hidden = True
     if group is not None:
@@ -1369,15 +1025,15 @@
     type=str,
     **_get_shell_complete_args(_complete_cluster_name),
     help=('[Experimental] Clone disk from an existing cluster to launch '
           'a new one. This is useful when the new cluster needs to have '
           'the same data on the boot disk as an existing cluster.'))
 @usage_lib.entrypoint
 def launch(
-    entrypoint: List[str],
+    entrypoint: Tuple[str, ...],
     cluster: Optional[str],
     dryrun: bool,
     detach_setup: bool,
     detach_run: bool,
     backend_name: Optional[str],
     name: Optional[str],
     workdir: Optional[str],
@@ -1471,35 +1127,44 @@
                          retry_until_up=retry_until_up,
                          no_setup=no_setup,
                          clone_disk_from=clone_disk_from)
 
 
 @cli.command(cls=_DocumentedCodeCommand)
 @click.argument('cluster',
-                required=True,
+                required=False,
                 type=str,
                 **_get_shell_complete_args(_complete_cluster_name))
+@click.option(
+    '--cluster',
+    '-c',
+    'cluster_option',
+    hidden=True,
+    type=str,
+    help='This is the same as the positional argument, just for consistency.',
+    **_get_shell_complete_args(_complete_cluster_name))
 @click.argument('entrypoint',
-                required=True,
+                required=False,
                 type=str,
                 nargs=-1,
                 **_get_shell_complete_args(_complete_file_name))
 @click.option(
     '--detach-run',
     '-d',
     default=False,
     is_flag=True,
     help=('If True, as soon as a job is submitted, return from this call '
           'and do not stream execution logs.'))
 @_add_click_options(_TASK_OPTIONS_WITH_NAME + _EXTRA_RESOURCES_OPTIONS)
 @usage_lib.entrypoint
 # pylint: disable=redefined-builtin
 def exec(
-    cluster: str,
-    entrypoint: List[str],
+    cluster: Optional[str],
+    cluster_option: Optional[str],
+    entrypoint: Tuple[str, ...],
     detach_run: bool,
     name: Optional[str],
     cloud: Optional[str],
     region: Optional[str],
     zone: Optional[str],
     workdir: Optional[str],
     gpus: Optional[str],
@@ -1569,14 +1234,25 @@
       sky exec mycluster python train_cpu.py
       sky exec mycluster --gpus=V100:1 python train_gpu.py
       \b
       # Pass environment variables to the task.
       sky exec mycluster --env WANDB_API_KEY python train_gpu.py
 
     """
+    if cluster_option is None and cluster is None:
+        raise click.UsageError('Missing argument \'[CLUSTER]\' and '
+                               '\'[ENTRYPOINT]...\'')
+    if cluster_option is not None:
+        if cluster is not None:
+            entrypoint = (cluster,) + entrypoint
+        cluster = cluster_option
+    if not entrypoint:
+        raise click.UsageError('Missing argument \'[ENTRYPOINT]...\'')
+    assert cluster is not None, (cluster, cluster_option, entrypoint)
+
     env = _merge_env_vars(env_file, env)
     controller_utils.check_cluster_name_not_controller(
         cluster, operation_str='Executing task on it')
     handle = global_user_state.get_handle_from_cluster_name(cluster)
     if handle is None:
         raise click.BadParameter(f'Cluster {cluster!r} not found. '
                                  'Use `sky launch` to provision first.')
@@ -1608,72 +1284,90 @@
                                'supports a single task only.')
     task = task_or_dag
 
     click.secho(f'Executing task on cluster {cluster}...', fg='yellow')
     sky.exec(task, backend=backend, cluster_name=cluster, detach_run=detach_run)
 
 
-def _get_spot_jobs(
+def _get_managed_jobs(
         refresh: bool,
         skip_finished: bool,
         show_all: bool,
         limit_num_jobs_to_show: bool = False,
         is_called_by_user: bool = False) -> Tuple[Optional[int], str]:
-    """Get the in-progress spot jobs.
+    """Get the in-progress managed jobs.
 
     Args:
-        refresh: Query the latest statuses, restarting the spot controller if
+        refresh: Query the latest statuses, restarting the jobs controller if
             stopped.
         skip_finished: Show only in-progress jobs.
-        show_all: Show all information of each spot job (e.g., region, price).
+        show_all: Show all information of each job (e.g., region, price).
         limit_num_jobs_to_show: If True, limit the number of jobs to show to
-            _NUM_SPOT_JOBS_TO_SHOW_IN_STATUS, which is mainly used by
+            _NUM_MANAGED_JOBS_TO_SHOW_IN_STATUS, which is mainly used by
             `sky status`.
         is_called_by_user: If this function is called by user directly, or an
             internal call.
 
     Returns:
         A tuple of (num_in_progress_jobs, msg). If num_in_progress_jobs is None,
-        it means there is an error when querying the spot jobs. In this case,
+        it means there is an error when querying the managed jobs. In this case,
         msg contains the error message. Otherwise, msg contains the formatted
-        spot job table.
+        managed job table.
     """
     num_in_progress_jobs = None
     try:
         if not is_called_by_user:
             usage_lib.messages.usage.set_internal()
         with sky_logging.silent():
             # Make the call silent
-            spot_jobs = core.spot_queue(refresh=refresh,
-                                        skip_finished=skip_finished)
-        num_in_progress_jobs = len(spot_jobs)
+            managed_jobs_ = managed_jobs.queue(refresh=refresh,
+                                               skip_finished=skip_finished)
+        num_in_progress_jobs = len(set(job['job_id'] for job in managed_jobs_))
     except exceptions.ClusterNotUpError as e:
         controller_status = e.cluster_status
-        if controller_status == status_lib.ClusterStatus.INIT:
-            msg = ('Controller\'s latest status is INIT; jobs '
-                   'will not be shown until it becomes UP.')
-        else:
-            assert controller_status in [None, status_lib.ClusterStatus.STOPPED]
-            msg = 'No in progress jobs.'
-            if controller_status is None:
-                msg += (f' (See: {colorama.Style.BRIGHT}sky spot -h'
-                        f'{colorama.Style.RESET_ALL})')
+        msg = str(e)
+        if controller_status is None:
+            msg += (f' (See: {colorama.Style.BRIGHT}sky jobs -h'
+                    f'{colorama.Style.RESET_ALL})')
+        elif (controller_status == status_lib.ClusterStatus.STOPPED and
+              is_called_by_user):
+            msg += (f' (See finished managed jobs: {colorama.Style.BRIGHT}'
+                    f'sky jobs queue --refresh{colorama.Style.RESET_ALL})')
     except RuntimeError as e:
-        msg = ('Failed to query spot jobs due to connection '
-               'issues. Try again later. '
-               f'Details: {common_utils.format_exception(e, use_bracket=True)}')
+        msg = ''
+        try:
+            # Check the controller status again, as the RuntimeError is likely
+            # due to the controller being autostopped when querying the jobs.
+            controller_type = controller_utils.Controllers.JOBS_CONTROLLER
+            record = backend_utils.refresh_cluster_record(
+                controller_type.value.cluster_name,
+                cluster_status_lock_timeout=0)
+            if (record is None or
+                    record['status'] == status_lib.ClusterStatus.STOPPED):
+                msg = controller_type.value.default_hint_if_non_existent
+        except Exception:  # pylint: disable=broad-except
+            # This is to an best effort to find the latest controller status to
+            # print more helpful message, so we can ignore any exception to
+            # print the original error.
+            pass
+        if not msg:
+            msg = (
+                'Failed to query managed jobs due to connection '
+                'issues. Try again later. '
+                f'Details: {common_utils.format_exception(e, use_bracket=True)}'
+            )
     except Exception as e:  # pylint: disable=broad-except
-        msg = ('Failed to query spot jobs: '
+        msg = ('Failed to query managed jobs: '
                f'{common_utils.format_exception(e, use_bracket=True)}')
     else:
-        max_jobs_to_show = (_NUM_SPOT_JOBS_TO_SHOW_IN_STATUS
+        max_jobs_to_show = (_NUM_MANAGED_JOBS_TO_SHOW_IN_STATUS
                             if limit_num_jobs_to_show else None)
-        msg = spot_lib.format_job_table(spot_jobs,
-                                        show_all=show_all,
-                                        max_jobs=max_jobs_to_show)
+        msg = managed_jobs.format_job_table(managed_jobs_,
+                                            show_all=show_all,
+                                            max_jobs=max_jobs_to_show)
     return num_in_progress_jobs, msg
 
 
 def _get_services(service_names: Optional[List[str]],
                   show_all: bool,
                   show_endpoint: bool,
                   is_called_by_user: bool = False) -> Tuple[Optional[int], str]:
@@ -1699,26 +1393,40 @@
             if not service_names:
                 # Change empty list to None
                 service_names = None
             service_records = serve_lib.status(service_names)
             num_services = len(service_records)
     except exceptions.ClusterNotUpError as e:
         controller_status = e.cluster_status
-        if controller_status == status_lib.ClusterStatus.INIT:
-            msg = 'Controller is initializing. Please wait for a while.'
-        else:
-            assert controller_status in [None, status_lib.ClusterStatus.STOPPED]
-            msg = 'No existing services. '
-            if controller_status is None:
-                msg += (f'(See: {colorama.Style.BRIGHT}sky serve -h'
-                        f'{colorama.Style.RESET_ALL})')
+        msg = str(e)
+        if controller_status is None:
+            msg += (f' (See: {colorama.Style.BRIGHT}sky serve -h'
+                    f'{colorama.Style.RESET_ALL})')
     except RuntimeError as e:
-        msg = ('Failed to fetch service statuses due to connection issues. '
-               'Please try again later. Details: '
-               f'{common_utils.format_exception(e, use_bracket=True)}')
+        msg = ''
+        try:
+            # Check the controller status again, as the RuntimeError is likely
+            # due to the controller being autostopped when querying the
+            # services.
+            controller_type = controller_utils.Controllers.SKY_SERVE_CONTROLLER
+            record = backend_utils.refresh_cluster_record(
+                controller_type.value.cluster_name,
+                cluster_status_lock_timeout=0)
+            if (record is None or
+                    record['status'] == status_lib.ClusterStatus.STOPPED):
+                msg = controller_type.value.default_hint_if_non_existent
+        except Exception:  # pylint: disable=broad-except
+            # This is to an best effort to find the latest controller status to
+            # print more helpful message, so we can ignore any exception to
+            # print the original error.
+            pass
+        if not msg:
+            msg = ('Failed to fetch service statuses due to connection issues. '
+                   'Please try again later. Details: '
+                   f'{common_utils.format_exception(e, use_bracket=True)}')
     except Exception as e:  # pylint: disable=broad-except
         msg = ('Failed to fetch service statuses: '
                f'{common_utils.format_exception(e, use_bracket=True)}')
     else:
         if show_endpoint:
             if len(service_records) != 1:
                 plural = 's' if len(service_records) > 1 else ''
@@ -1774,34 +1482,34 @@
                     'cluster. This option will override all other options.'))
 @click.option('--endpoint',
               required=False,
               default=None,
               type=int,
               help=('Get the endpoint URL for the specified port number on the '
                     'cluster. This option will override all other options.'))
-@click.option('--show-spot-jobs/--no-show-spot-jobs',
+@click.option('--show-managed-jobs/--no-show-managed-jobs',
               default=True,
               is_flag=True,
               required=False,
-              help='Also show recent in-progress spot jobs, if any.')
+              help='Also show recent in-progress managed jobs, if any.')
 @click.option('--show-services/--no-show-services',
               default=True,
               is_flag=True,
               required=False,
               help='Also show sky serve services, if any.')
 @click.argument('clusters',
                 required=False,
                 type=str,
                 nargs=-1,
                 **_get_shell_complete_args(_complete_cluster_name))
 @usage_lib.entrypoint
 # pylint: disable=redefined-builtin
 def status(all: bool, refresh: bool, ip: bool, endpoints: bool,
-           endpoint: Optional[int], show_spot_jobs: bool, show_services: bool,
-           clusters: List[str]):
+           endpoint: Optional[int], show_managed_jobs: bool,
+           show_services: bool, clusters: List[str]):
     # NOTE(dev): Keep the docstring consistent between the Python API and CLI.
     """Show clusters.
 
     If CLUSTERS is given, show those clusters. Otherwise, show all clusters.
 
     If --ip is specified, show the IP address of the head node of the cluster.
     Only available when CLUSTERS contains exactly one cluster, e.g.
@@ -1852,27 +1560,28 @@
       statuses.
 
     - In cases where clusters are changed outside of SkyPilot (e.g., manual
       operations in cloud consoles; unmanaged spot clusters getting preempted)
       or for autostop-enabled clusters, use ``--refresh`` to query the latest
       cluster statuses from the cloud providers.
     """
-    # Using a pool with 2 worker to run the spot job query and sky serve service
-    # query in parallel to speed up. The pool provides a AsyncResult object that
-    # can be used as a future.
+    # Using a pool with 2 worker to run the managed job query and sky serve
+    # service query in parallel to speed up. The pool provides a AsyncResult
+    # object that can be used as a future.
     with multiprocessing.Pool(2) as pool:
-        # Do not show spot queue if user specifies clusters, and if user
+        # Do not show job queue if user specifies clusters, and if user
         # specifies --ip or --endpoint(s).
-        show_spot_jobs = show_spot_jobs and not any([clusters, ip, endpoints])
+        show_managed_jobs = show_managed_jobs and not any(
+            [clusters, ip, endpoints])
         show_endpoints = endpoints or endpoint is not None
         show_single_endpoint = endpoint is not None
-        if show_spot_jobs:
-            # Run the spot job query in parallel to speed up the status query.
-            spot_jobs_future = pool.apply_async(
-                _get_spot_jobs,
+        if show_managed_jobs:
+            # Run managed job query in parallel to speed up the status query.
+            managed_jobs_future = pool.apply_async(
+                _get_managed_jobs,
                 kwds=dict(refresh=False,
                           skip_finished=True,
                           show_all=False,
                           limit_num_jobs_to_show=not all,
                           is_called_by_user=False))
 
         show_services = show_services and not clusters and not ip
@@ -1957,79 +1666,36 @@
             if not isinstance(handle, backends.CloudVmRayResourceHandle):
                 with ux_utils.print_exception_no_traceback():
                     raise ValueError('Querying IP address is not supported '
                                      'for local clusters.')
 
             head_ip = handle.external_ips()[0]
             if show_endpoints:
-                launched_resources = handle.launched_resources
-                cloud = launched_resources.cloud
-                try:
-                    cloud.check_features_are_supported(
-                        launched_resources,
-                        {clouds.CloudImplementationFeatures.OPEN_PORTS})
-                except exceptions.NotSupportedError:
-                    with ux_utils.print_exception_no_traceback():
-                        raise ValueError('Querying endpoints is not supported '
-                                         f'for {cloud}.') from None
-
-                config = common_utils.read_yaml(handle.cluster_yaml)
-                port_details = provision_lib.query_ports(
-                    repr(cloud), handle.cluster_name_on_cloud,
-                    handle.launched_resources.ports, config['provider'])
-
-                if endpoint is not None:
-                    # If cluster had no ports to be exposed
-                    ports_set = resources_utils.port_ranges_to_set(
-                        handle.launched_resources.ports)
-                    if endpoint not in ports_set:
-                        with ux_utils.print_exception_no_traceback():
-                            raise ValueError(f'Port {endpoint} is not exposed '
-                                             'on cluster '
-                                             f'{cluster_record["name"]!r}.')
-                    # If the user requested a specific port endpoint
-                    if endpoint not in port_details:
-                        error_msg = (f'Port {endpoint} not exposed yet. '
-                                     f'{_ENDPOINTS_RETRY_MESSAGE} ')
-                        if handle.launched_resources.cloud.is_same_cloud(
-                                clouds.Kubernetes()):
-                            # Add Kubernetes specific debugging info
-                            error_msg += (
-                                kubernetes_utils.get_endpoint_debug_message())
-                        with ux_utils.print_exception_no_traceback():
-                            raise RuntimeError(error_msg)
-                    click.echo(port_details[endpoint][0].url(ip=head_ip))
-                    return
-
-                if not port_details:
-                    # If cluster had no ports to be exposed
-                    if handle.launched_resources.ports is None:
-                        with ux_utils.print_exception_no_traceback():
-                            raise ValueError('Cluster does not have any ports '
-                                             'to be exposed.')
-                    # Else wait for the ports to be exposed
-                    else:
-                        error_msg = (f'No endpoints exposed yet. '
-                                     f'{_ENDPOINTS_RETRY_MESSAGE} ')
-                        if handle.launched_resources.cloud.is_same_cloud(
-                                clouds.Kubernetes()):
-                            # Add Kubernetes specific debugging info
-                            error_msg += \
-                                kubernetes_utils.get_endpoint_debug_message()
-                        with ux_utils.print_exception_no_traceback():
-                            raise RuntimeError(error_msg)
-
-                for port, urls in port_details.items():
-                    click.echo(
-                        f'{colorama.Fore.BLUE}{colorama.Style.BRIGHT}{port}'
-                        f'{colorama.Style.RESET_ALL}: '
-                        f'{colorama.Fore.CYAN}{colorama.Style.BRIGHT}'
-                        f'{urls[0].url(ip=head_ip)}{colorama.Style.RESET_ALL}')
+                if endpoint:
+                    cluster_endpoint = core.endpoints(cluster_record['name'],
+                                                      endpoint).get(
+                                                          endpoint, None)
+                    if not cluster_endpoint:
+                        raise click.Abort(
+                            f'Endpoint {endpoint} not found for cluster '
+                            f'{cluster_record["name"]!r}.')
+                    click.echo(cluster_endpoint)
+                else:
+                    cluster_endpoints = core.endpoints(cluster_record['name'])
+                    assert isinstance(cluster_endpoints, dict)
+                    if not cluster_endpoints:
+                        raise click.Abort(f'No endpoint found for cluster '
+                                          f'{cluster_record["name"]!r}.')
+                    for port, port_endpoint in cluster_endpoints.items():
+                        click.echo(
+                            f'{colorama.Fore.BLUE}{colorama.Style.BRIGHT}{port}'
+                            f'{colorama.Style.RESET_ALL}: '
+                            f'{colorama.Fore.CYAN}{colorama.Style.BRIGHT}'
+                            f'{port_endpoint}{colorama.Style.RESET_ALL}')
                 return
-
             click.echo(head_ip)
             return
         hints = []
         normal_clusters = []
         controllers = []
         for cluster_record in cluster_records:
             cluster_name = cluster_record['name']
@@ -2049,55 +1715,56 @@
             try:
                 result = future.get()
             except KeyboardInterrupt:
                 pool.terminate()
                 interrupted = True
             return interrupted, result
 
-        spot_jobs_query_interrupted = False
-        if show_spot_jobs:
+        managed_jobs_query_interrupted = False
+        if show_managed_jobs:
             click.echo(f'\n{colorama.Fore.CYAN}{colorama.Style.BRIGHT}'
-                       f'Managed spot jobs{colorama.Style.RESET_ALL}')
-            with rich_utils.safe_status('[cyan]Checking spot jobs[/]'):
-                spot_jobs_query_interrupted, result = _try_get_future_result(
-                    spot_jobs_future)
-                if spot_jobs_query_interrupted:
+                       f'Managed jobs{colorama.Style.RESET_ALL}')
+            with rich_utils.safe_status('[cyan]Checking managed jobs[/]'):
+                managed_jobs_query_interrupted, result = _try_get_future_result(
+                    managed_jobs_future)
+                if managed_jobs_query_interrupted:
                     # Set to -1, so that the controller is not considered
-                    # down, and the hint for showing sky spot queue
+                    # down, and the hint for showing sky jobs queue
                     # will still be shown.
                     num_in_progress_jobs = -1
                     msg = 'KeyboardInterrupt'
                 else:
                     num_in_progress_jobs, msg = result
 
             click.echo(msg)
             if num_in_progress_jobs is not None:
-                # spot controller is UP.
+                # jobs controller is UP.
                 job_info = ''
                 if num_in_progress_jobs > 0:
                     plural_and_verb = ' is'
                     if num_in_progress_jobs > 1:
                         plural_and_verb = 's are'
                     job_info = (
-                        f'{num_in_progress_jobs} spot job{plural_and_verb} '
+                        f'{num_in_progress_jobs} managed job{plural_and_verb} '
                         'in progress')
-                    if num_in_progress_jobs > _NUM_SPOT_JOBS_TO_SHOW_IN_STATUS:
+                    if (num_in_progress_jobs >
+                            _NUM_MANAGED_JOBS_TO_SHOW_IN_STATUS):
                         job_info += (
-                            f' ({_NUM_SPOT_JOBS_TO_SHOW_IN_STATUS} latest ones '
-                            'shown)')
+                            f' ({_NUM_MANAGED_JOBS_TO_SHOW_IN_STATUS} latest '
+                            'ones shown)')
                     job_info += '. '
                 hints.append(
-                    controller_utils.Controllers.SPOT_CONTROLLER.value.
+                    controller_utils.Controllers.JOBS_CONTROLLER.value.
                     in_progress_hint.format(job_info=job_info))
 
         if show_services:
             click.echo(f'\n{colorama.Fore.CYAN}{colorama.Style.BRIGHT}'
                        f'Services{colorama.Style.RESET_ALL}')
             num_services = None
-            if spot_jobs_query_interrupted:
+            if managed_jobs_query_interrupted:
                 # The pool is terminated, so we cannot run the service query.
                 msg = 'KeyboardInterrupt'
             else:
                 with rich_utils.safe_status('[cyan]Checking services[/]'):
                     interrupted, result = _try_get_future_result(
                         services_future)
                     if interrupted:
@@ -2106,15 +1773,15 @@
                     else:
                         num_services, msg = result
             click.echo(msg)
             if num_services is not None:
                 hints.append(controller_utils.Controllers.SKY_SERVE_CONTROLLER.
                              value.in_progress_hint)
 
-        if show_spot_jobs or show_services:
+        if show_managed_jobs or show_services:
             try:
                 pool.close()
                 pool.join()
             except SystemExit as e:
                 # This is to avoid a "Exception ignored" problem caused by
                 # ray worker setting the sigterm handler to sys.exit(15)
                 # (see ray/_private/worker.py).
@@ -2377,15 +2044,15 @@
               '-y',
               is_flag=True,
               default=False,
               required=False,
               help='Skip confirmation prompt.')
 @click.argument('jobs', required=False, type=int, nargs=-1)
 @usage_lib.entrypoint
-def cancel(cluster: str, all: bool, jobs: List[int], yes: bool):  # pylint: disable=redefined-builtin
+def cancel(cluster: str, all: bool, jobs: List[int], yes: bool):  # pylint: disable=redefined-builtin, redefined-outer-name
     # NOTE(dev): Keep the docstring consistent between the Python API and CLI.
     """Cancel job(s).
 
     Example usage:
 
     .. code-block:: bash
 
@@ -2424,24 +2091,24 @@
         click.confirm(f'Cancelling {job_identity_str}. Proceed?',
                       default=True,
                       abort=True,
                       show_default=True)
 
     try:
         core.cancel(cluster, all=all, job_ids=job_ids_to_cancel)
-    except exceptions.NotSupportedError:
+    except exceptions.NotSupportedError as e:
         controller = controller_utils.Controllers.from_name(cluster)
         assert controller is not None, cluster
-        click.echo(controller.value.decline_cancel_hint)
-        sys.exit(1)
+        with ux_utils.print_exception_no_traceback():
+            raise click.UsageError(controller.value.decline_cancel_hint) from e
     except ValueError as e:
         raise click.UsageError(str(e))
-    except exceptions.ClusterNotUpError as e:
-        click.echo(str(e))
-        sys.exit(1)
+    except exceptions.ClusterNotUpError:
+        with ux_utils.print_exception_no_traceback():
+            raise
 
 
 @cli.command(cls=_DocumentedCodeCommand)
 @click.argument('clusters',
                 nargs=-1,
                 required=False,
                 **_get_shell_complete_args(_complete_cluster_name))
@@ -2555,39 +2222,38 @@
 
     Idleness time of a cluster is reset to zero, when any of these happens:
 
     - A job is submitted (``sky launch`` or ``sky exec``).
 
     - The cluster has restarted.
 
-    - An autostop is set when there is no active setting. (Namely, either
-      there's never any autostop setting set, or the previous autostop setting
-      was canceled.) This is useful for restarting the autostop timer.
+    - An autostop idle time is set.
 
-    Example: say a cluster without any autostop set has been idle for 1 hour,
+    Example 1: say a cluster with autostop set to 2 hours has been idle for 1
+    hour, then autostop is reset to 30 minutes. The cluster will not be
+    immediately autostopped. Instead, the idleness timer restarts counting
+    when the second autostop setting of 30 minutes was submitted.
+
+    Example 2: say a cluster without any autostop set has been idle for 1 hour,
     then an autostop of 30 minutes is set. The cluster will not be immediately
     autostopped. Instead, the idleness timer only starts counting after the
     autostop setting was set.
 
-    When multiple autostop settings are specified for the same cluster, the
-    last setting takes precedence.
-
     Typical usage:
 
     .. code-block:: bash
 
         # Autostop this cluster after 60 minutes of idleness.
         sky autostop cluster_name -i 60
         \b
         # Cancel autostop for a specific cluster.
         sky autostop cluster_name --cancel
         \b
-        # Since autostop was canceled in the last command, idleness will
-        # restart counting after this command.
-        sky autostop cluster_name -i 60
+        # Autodown this cluster after 60 minutes of idleness.
+        sky autostop cluster_name -i 60 --down
     """
     if cancel and idle_minutes is not None:
         raise click.UsageError(
             'Only one of --idle-minutes and --cancel should be specified. '
             f'cancel: {cancel}, idle_minutes: {idle_minutes}')
     if cancel:
         idle_minutes = -1
@@ -2743,15 +2409,15 @@
             #    (currently, only AWS/GCP non-spot clusters can be in this
             #    state)
             #
             #  UP - skipped, see below
             #
             #  INIT - ok to restart:
             #    1. It can be a failed-to-provision cluster, so it isn't up
-            #      (Ex: gpunode --gpus=A100:8).  Running `sky start` enables
+            #      (Ex: launch --gpus=A100:8).  Running `sky start` enables
             #      retrying the provisioning - without setup steps being
             #      completed. (Arguably the original command that failed should
             #      be used instead; but using start isn't harmful - after it
             #      gets provisioned successfully the user can use the original
             #      command).
             #
             #    2. It can be an up cluster that failed one of the setup steps.
@@ -2777,15 +2443,15 @@
             assert force or cluster_status in (
                 status_lib.ClusterStatus.INIT,
                 status_lib.ClusterStatus.STOPPED), cluster_status
             to_start.append(name)
     if not to_start:
         return
 
-    # Checks for controller clusters (spot controller / sky serve controller).
+    # Checks for controller clusters (jobs controller / sky serve controller).
     controllers, normal_clusters = [], []
     for name in to_start:
         if controller_utils.Controllers.from_name(name) is not None:
             controllers.append(name)
         else:
             normal_clusters.append(name)
     if controllers and normal_clusters:
@@ -2842,21 +2508,26 @@
               help='Tear down all existing clusters.')
 @click.option('--yes',
               '-y',
               is_flag=True,
               default=False,
               required=False,
               help='Skip confirmation prompt.')
-@click.option('--purge',
-              '-p',
-              is_flag=True,
-              default=False,
-              required=False,
-              help='Ignore cloud provider errors (if any). '
-              'Useful for cleaning up manually deleted cluster(s).')
+@click.option(
+    '--purge',
+    '-p',
+    is_flag=True,
+    default=False,
+    required=False,
+    help=('(Advanced) Forcefully remove the cluster(s) from '
+          'SkyPilot\'s cluster table, even if the actual cluster termination '
+          'failed on the cloud. WARNING: This flag should only be set sparingly'
+          ' in certain manual troubleshooting scenarios; with it set, it is the'
+          ' user\'s responsibility to ensure there are no leaked instances and '
+          'related resources.'))
 @usage_lib.entrypoint
 def down(
     clusters: List[str],
     all: Optional[bool],  # pylint: disable=redefined-builtin
     yes: bool,
     purge: bool,
 ):
@@ -2891,119 +2562,130 @@
     _down_or_stop_clusters(clusters,
                            apply_to_all=all,
                            down=True,
                            no_confirm=yes,
                            purge=purge)
 
 
-def _hint_or_raise_for_down_spot_controller(controller_name: str):
-    # spot_jobs will be empty when the spot cluster is not running.
-    cluster_status, _ = backend_utils.refresh_cluster_status_handle(
-        controller_name)
-    if cluster_status is None:
-        click.echo('Managed spot controller has already been torn down.')
-        return
+def _hint_or_raise_for_down_jobs_controller(controller_name: str):
+    """Helper function to check job controller status before tearing it down.
+
+    Raises helpful exceptions and errors if the controller is not in a safe
+    state to be torn down.
 
+    Raises:
+        RuntimeError: if failed to get the job queue.
+        exceptions.NotSupportedError: if the controller is not in a safe state
+            to be torn down (e.g., because it has jobs running or
+            it is in init state)
+    """
     controller = controller_utils.Controllers.from_name(controller_name)
     assert controller is not None, controller_name
-    if cluster_status == status_lib.ClusterStatus.INIT:
-        with ux_utils.print_exception_no_traceback():
-            raise exceptions.NotSupportedError(
-                controller.value.decline_down_in_init_status_hint)
+
+    with rich_utils.safe_status(
+            '[bold cyan]Checking for in-progress managed jobs[/]'):
+        try:
+            managed_jobs_ = managed_jobs.queue(refresh=False,
+                                               skip_finished=True)
+        except exceptions.ClusterNotUpError as e:
+            if controller.value.connection_error_hint in str(e):
+                with ux_utils.print_exception_no_traceback():
+                    raise exceptions.NotSupportedError(
+                        controller.value.
+                        decline_down_when_failed_to_fetch_status_hint)
+            if e.cluster_status is None:
+                click.echo(
+                    'Managed jobs controller has already been torn down.')
+                sys.exit(0)
+            # At this point, the managed jobs are failed to be fetched due to
+            # the controller being STOPPED or being firstly launched, i.e.,
+            # there is no in-prgress managed jobs.
+            managed_jobs_ = []
+
     msg = (f'{colorama.Fore.YELLOW}WARNING: Tearing down the managed '
-           f'spot controller ({cluster_status.value}). Please be '
-           f'aware of the following:{colorama.Style.RESET_ALL}'
-           '\n * All logs and status information of the spot '
-           'jobs (output of `sky spot queue`) will be lost.')
+           'jobs controller. Please be aware of the following:'
+           f'{colorama.Style.RESET_ALL}'
+           '\n * All logs and status information of the managed '
+           'jobs (output of `sky jobs queue`) will be lost.')
     click.echo(msg)
-    if cluster_status == status_lib.ClusterStatus.UP:
-        with rich_utils.safe_status(
-                '[bold cyan]Checking for in-progress spot jobs[/]'):
-            try:
-                spot_jobs = core.spot_queue(refresh=False)
-            except exceptions.ClusterNotUpError:
-                # The spot controller cluster status changed during querying
-                # the spot jobs, use the latest cluster status, so that the
-                # message for INIT and STOPPED states will be correctly
-                # added to the message.
-                cluster_status = backend_utils.refresh_cluster_status_handle(
-                    controller_name)
-                spot_jobs = []
-
-        # Find in-progress spot jobs, and hint users to cancel them.
-        non_terminal_jobs = [
-            job for job in spot_jobs if not job['status'].is_terminal()
-        ]
-        if (cluster_status == status_lib.ClusterStatus.UP and
-                non_terminal_jobs):
-            job_table = spot_lib.format_job_table(non_terminal_jobs,
-                                                  show_all=False)
-            msg = controller.value.decline_down_for_dirty_controller_hint
-            # Add prefix to each line to align with the bullet point.
-            msg += '\n'.join(
-                ['   ' + line for line in job_table.split('\n') if line != ''])
-            with ux_utils.print_exception_no_traceback():
-                raise exceptions.NotSupportedError(msg)
-        else:
-            click.echo(' * No in-progress spot jobs found. It should be safe '
-                       'to terminate (see caveats above).')
+    if managed_jobs_:
+        job_table = managed_jobs.format_job_table(managed_jobs_, show_all=False)
+        msg = controller.value.decline_down_for_dirty_controller_hint
+        # Add prefix to each line to align with the bullet point.
+        msg += '\n'.join(
+            ['   ' + line for line in job_table.split('\n') if line != ''])
+        with ux_utils.print_exception_no_traceback():
+            raise exceptions.NotSupportedError(msg)
+    else:
+        click.echo(' * No in-progress managed jobs found. It should be safe to '
+                   'terminate (see caveats above).')
 
 
 def _hint_or_raise_for_down_sky_serve_controller(controller_name: str):
-    cluster_status, _ = backend_utils.refresh_cluster_status_handle(
-        controller_name)
-    if cluster_status is None:
-        click.echo('Sky serve controller has already been torn down.')
-        return
+    """Helper function to check serve controller status before tearing it down.
+
+    Raises helpful exceptions and errors if the controller is not in a safe
+    state to be torn down.
 
+    Raises:
+        RuntimeError: if failed to get the service status.
+        exceptions.NotSupportedError: if the controller is not in a safe state
+            to be torn down (e.g., because it has services running or
+            it is in init state)
+    """
     controller = controller_utils.Controllers.from_name(controller_name)
     assert controller is not None, controller_name
-    if cluster_status == status_lib.ClusterStatus.INIT:
+    with rich_utils.safe_status('[bold cyan]Checking for live services[/]'):
+        try:
+            services = serve_lib.status()
+        except exceptions.ClusterNotUpError as e:
+            if controller.value.connection_error_hint in str(e):
+                with ux_utils.print_exception_no_traceback():
+                    raise exceptions.NotSupportedError(
+                        controller.value.
+                        decline_down_when_failed_to_fetch_status_hint)
+            if e.cluster_status is None:
+                click.echo('Serve controller has already been torn down.')
+                sys.exit(0)
+            # At this point, the services are failed to be fetched due to the
+            # controller being STOPPED or being firstly launched, i.e., there is
+            # no in-prgress services.
+            services = []
+
+    if services:
+        service_names = [service['name'] for service in services]
         with ux_utils.print_exception_no_traceback():
-            raise exceptions.NotSupportedError(
-                controller.value.decline_down_in_init_status_hint)
-    elif cluster_status == status_lib.ClusterStatus.UP:
-        with rich_utils.safe_status(
-                '[bold cyan]Checking for running services[/]'):
-            try:
-                services = serve_lib.status()
-            except exceptions.ClusterNotUpError:
-                cluster_status = backend_utils.refresh_cluster_status_handle(
-                    controller_name)
-                services = []
-        if services:
-            service_names = [service['name'] for service in services]
-            with ux_utils.print_exception_no_traceback():
-                msg = (controller.value.decline_down_for_dirty_controller_hint.
-                       format(service_names=', '.join(service_names)))
-                raise exceptions.NotSupportedError(msg)
+            msg = (
+                controller.value.decline_down_for_dirty_controller_hint.format(
+                    service_names=', '.join(service_names)))
+            raise exceptions.NotSupportedError(msg)
     # Do nothing for STOPPED state, as it is safe to terminate the cluster.
     click.echo(f'Terminate sky serve controller: {controller_name}.')
 
 
 _CONTROLLER_TO_HINT_OR_RAISE = {
-    controller_utils.Controllers.SPOT_CONTROLLER:
-        (_hint_or_raise_for_down_spot_controller),
+    controller_utils.Controllers.JOBS_CONTROLLER:
+        (_hint_or_raise_for_down_jobs_controller),
     controller_utils.Controllers.SKY_SERVE_CONTROLLER:
         (_hint_or_raise_for_down_sky_serve_controller),
 }
 
 
 def _down_or_stop_clusters(
         names: List[str],
         apply_to_all: Optional[bool],
         down: bool,  # pylint: disable=redefined-outer-name
         no_confirm: bool,
         purge: bool = False,
         idle_minutes_to_autostop: Optional[int] = None) -> None:
     """Tears down or (auto-)stops a cluster (or all clusters).
 
-    Controllers (spot controller and sky serve controller) can only be
+    Controllers (jobs controller and sky serve controller) can only be
     terminated if the cluster name is explicitly and uniquely specified (not
-    via glob) and purge is set to True.
+    via glob).
     """
     if down:
         command = 'down'
     elif idle_minutes_to_autostop is not None:
         command = 'autostop'
     else:
         command = 'stop'
@@ -3061,16 +2743,24 @@
                     f'{controllers_str} is currently not supported.')
             else:
                 controller = controller_utils.Controllers.from_name(
                     controller_name)
                 assert controller is not None
                 hint_or_raise = _CONTROLLER_TO_HINT_OR_RAISE[controller]
                 try:
+                    # TODO(zhwu): This hint or raise is not transactional, which
+                    # means even if it passed the check with no in-progress spot
+                    # or service and prompt the confirmation for termination,
+                    # a user could still do a `sky jobs launch` or a
+                    # `sky serve up` before typing the delete, causing a leaked
+                    # managed job or service. We should make this check atomic
+                    # with the termination.
                     hint_or_raise(controller_name)
-                except exceptions.ClusterOwnerIdentityMismatchError as e:
+                except (exceptions.ClusterOwnerIdentityMismatchError,
+                        RuntimeError) as e:
                     if purge:
                         click.echo(common_utils.format_exception(e))
                     else:
                         raise
                 confirm_str = 'delete'
                 input_prefix = ('Since --purge is set, errors will be ignored '
                                 'and controller will be removed from '
@@ -3189,290 +2879,46 @@
     with progress:
         subprocess_utils.run_in_parallel(_down_or_stop, clusters)
         progress.live.transient = False
         # Make sure the progress bar not mess up the terminal.
         progress.refresh()
 
 
-@_interactive_node_cli_command
-@usage_lib.entrypoint
-# pylint: disable=redefined-outer-name
-def gpunode(cluster: str, yes: bool, port_forward: Optional[List[int]],
-            cloud: Optional[str], region: Optional[str], zone: Optional[str],
-            instance_type: Optional[str], cpus: Optional[str],
-            memory: Optional[str], gpus: Optional[str],
-            use_spot: Optional[bool], screen: Optional[bool],
-            tmux: Optional[bool], disk_size: Optional[int],
-            disk_tier: Optional[str], ports: Tuple[str],
-            idle_minutes_to_autostop: Optional[int], down: bool,
-            retry_until_up: bool):
-    """Launch or attach to an interactive GPU node.
-
-    Examples:
-
-    .. code-block:: bash
-
-        # Launch a default gpunode.
-        sky gpunode
-        \b
-        # Do work, then log out. The node is kept running. Attach back to the
-        # same node and do more work.
-        sky gpunode
-        \b
-        # Create many interactive nodes by assigning names via --cluster (-c).
-        sky gpunode -c node0
-        sky gpunode -c node1
-        \b
-        # Port forward.
-        sky gpunode --port-forward 8080 --port-forward 4650 -c cluster_name
-        sky gpunode -p 8080 -p 4650 -c cluster_name
-        \b
-        # Sync current working directory to ~/workdir on the node.
-        rsync -r . cluster_name:~/workdir
-
-    """
-    # TODO: Factor out the shared logic below for [gpu|cpu|tpu]node.
-    if screen and tmux:
-        raise click.UsageError('Cannot use both screen and tmux.')
-
-    session_manager = None
-    if screen or tmux:
-        session_manager = 'tmux' if tmux else 'screen'
-    name = cluster
-    if name is None:
-        name = _default_interactive_node_name('gpunode')
-
-    user_requested_resources = not (cloud is None and region is None and
-                                    zone is None and instance_type is None and
-                                    cpus is None and memory is None and
-                                    gpus is None and use_spot is None)
-    default_resources = _INTERACTIVE_NODE_DEFAULT_RESOURCES['gpunode']
-    cloud_provider = clouds.CLOUD_REGISTRY.from_str(cloud)
-    if gpus is None and instance_type is None:
-        # Use this request if both gpus and instance_type are not specified.
-        gpus = default_resources.accelerators
-        instance_type = default_resources.instance_type
-    if use_spot is None:
-        use_spot = default_resources.use_spot
-    resources = sky.Resources(cloud=cloud_provider,
-                              region=region,
-                              zone=zone,
-                              instance_type=instance_type,
-                              cpus=cpus,
-                              memory=memory,
-                              accelerators=gpus,
-                              use_spot=use_spot,
-                              disk_size=disk_size,
-                              disk_tier=disk_tier,
-                              ports=ports)
-
-    _create_and_ssh_into_node(
-        'gpunode',
-        resources,
-        cluster_name=name,
-        port_forward=port_forward,
-        session_manager=session_manager,
-        user_requested_resources=user_requested_resources,
-        no_confirm=yes,
-        idle_minutes_to_autostop=idle_minutes_to_autostop,
-        down=down,
-        retry_until_up=retry_until_up,
-    )
-
-
-@_interactive_node_cli_command
-@usage_lib.entrypoint
-# pylint: disable=redefined-outer-name
-def cpunode(cluster: str, yes: bool, port_forward: Optional[List[int]],
-            cloud: Optional[str], region: Optional[str], zone: Optional[str],
-            instance_type: Optional[str], cpus: Optional[str],
-            memory: Optional[str], use_spot: Optional[bool],
-            screen: Optional[bool], tmux: Optional[bool],
-            disk_size: Optional[int], disk_tier: Optional[str],
-            ports: Tuple[str], idle_minutes_to_autostop: Optional[int],
-            down: bool, retry_until_up: bool):
-    """Launch or attach to an interactive CPU node.
-
-    Examples:
-
-    .. code-block:: bash
-
-        # Launch a default cpunode.
-        sky cpunode
-        \b
-        # Do work, then log out. The node is kept running. Attach back to the
-        # same node and do more work.
-        sky cpunode
-        \b
-        # Create many interactive nodes by assigning names via --cluster (-c).
-        sky cpunode -c node0
-        sky cpunode -c node1
-        \b
-        # Port forward.
-        sky cpunode --port-forward 8080 --port-forward 4650 -c cluster_name
-        sky cpunode -p 8080 -p 4650 -c cluster_name
-        \b
-        # Sync current working directory to ~/workdir on the node.
-        rsync -r . cluster_name:~/workdir
-
-    """
-    if screen and tmux:
-        raise click.UsageError('Cannot use both screen and tmux.')
-
-    session_manager = None
-    if screen or tmux:
-        session_manager = 'tmux' if tmux else 'screen'
-    name = cluster
-    if name is None:
-        name = _default_interactive_node_name('cpunode')
-
-    user_requested_resources = not (cloud is None and region is None and
-                                    zone is None and instance_type is None and
-                                    cpus is None and memory is None and
-                                    use_spot is None)
-    default_resources = _INTERACTIVE_NODE_DEFAULT_RESOURCES['cpunode']
-    cloud_provider = clouds.CLOUD_REGISTRY.from_str(cloud)
-    if instance_type is None:
-        instance_type = default_resources.instance_type
-    if use_spot is None:
-        use_spot = default_resources.use_spot
-    resources = sky.Resources(cloud=cloud_provider,
-                              region=region,
-                              zone=zone,
-                              instance_type=instance_type,
-                              cpus=cpus,
-                              memory=memory,
-                              use_spot=use_spot,
-                              disk_size=disk_size,
-                              disk_tier=disk_tier,
-                              ports=ports)
-
-    _create_and_ssh_into_node(
-        'cpunode',
-        resources,
-        cluster_name=name,
-        port_forward=port_forward,
-        session_manager=session_manager,
-        user_requested_resources=user_requested_resources,
-        no_confirm=yes,
-        idle_minutes_to_autostop=idle_minutes_to_autostop,
-        down=down,
-        retry_until_up=retry_until_up,
-    )
-
-
-@_interactive_node_cli_command
-@usage_lib.entrypoint
-# pylint: disable=redefined-outer-name
-def tpunode(cluster: str, yes: bool, port_forward: Optional[List[int]],
-            region: Optional[str], zone: Optional[str],
-            instance_type: Optional[str], cpus: Optional[str],
-            memory: Optional[str], tpus: Optional[str],
-            use_spot: Optional[bool], tpu_vm: Optional[bool],
-            screen: Optional[bool], tmux: Optional[bool],
-            disk_size: Optional[int], disk_tier: Optional[str],
-            ports: Tuple[str], idle_minutes_to_autostop: Optional[int],
-            down: bool, retry_until_up: bool):
-    """Launch or attach to an interactive TPU node.
-
-    Examples:
-
-    .. code-block:: bash
-
-        # Launch a default tpunode.
-        sky tpunode
-        \b
-        # Do work, then log out. The node is kept running. Attach back to the
-        # same node and do more work.
-        sky tpunode
-        \b
-        # Create many interactive nodes by assigning names via --cluster (-c).
-        sky tpunode -c node0
-        sky tpunode -c node1
-        \b
-        # Port forward.
-        sky tpunode --port-forward 8080 --port-forward 4650 -c cluster_name
-        sky tpunode -p 8080 -p 4650 -c cluster_name
-        \b
-        # Sync current working directory to ~/workdir on the node.
-        rsync -r . cluster_name:~/workdir
-
-    """
-    if screen and tmux:
-        raise click.UsageError('Cannot use both screen and tmux.')
-
-    session_manager = None
-    if screen or tmux:
-        session_manager = 'tmux' if tmux else 'screen'
-    name = cluster
-    if name is None:
-        name = _default_interactive_node_name('tpunode')
-
-    user_requested_resources = not (region is None and zone is None and
-                                    instance_type is None and cpus is None and
-                                    memory is None and tpus is None and
-                                    use_spot is None)
-    default_resources = _INTERACTIVE_NODE_DEFAULT_RESOURCES['tpunode']
-    accelerator_args = default_resources.accelerator_args
-    if tpu_vm:
-        accelerator_args['tpu_vm'] = True
-        accelerator_args['runtime_version'] = 'tpu-vm-base'
-    else:
-        accelerator_args['tpu_vm'] = False
-    if instance_type is None:
-        instance_type = default_resources.instance_type
-    if tpus is None:
-        tpus = default_resources.accelerators
-    if use_spot is None:
-        use_spot = default_resources.use_spot
-    resources = sky.Resources(cloud=sky.GCP(),
-                              region=region,
-                              zone=zone,
-                              instance_type=instance_type,
-                              cpus=cpus,
-                              memory=memory,
-                              accelerators=tpus,
-                              accelerator_args=accelerator_args,
-                              use_spot=use_spot,
-                              disk_size=disk_size,
-                              disk_tier=disk_tier,
-                              ports=ports)
-
-    _create_and_ssh_into_node(
-        'tpunode',
-        resources,
-        cluster_name=name,
-        port_forward=port_forward,
-        session_manager=session_manager,
-        user_requested_resources=user_requested_resources,
-        no_confirm=yes,
-        idle_minutes_to_autostop=idle_minutes_to_autostop,
-        down=down,
-        retry_until_up=retry_until_up,
-    )
-
-
-@cli.command()
+@cli.command(cls=_DocumentedCodeCommand)
+@click.argument('clouds', required=False, type=str, nargs=-1)
 @click.option('--verbose',
               '-v',
               is_flag=True,
               default=False,
               help='Show the activated account for each cloud.')
 @usage_lib.entrypoint
-def check(verbose: bool):
+def check(clouds: Tuple[str], verbose: bool):
     """Check which clouds are available to use.
 
     This checks access credentials for all clouds supported by SkyPilot. If a
     cloud is detected to be inaccessible, the reason and correction steps will
     be shown.
 
+    If CLOUDS are specified, checks credentials for only those clouds.
+
     The enabled clouds are cached and form the "search space" to be considered
     for each task.
+
+    Examples:
+
+    .. code-block:: bash
+
+      # Check credentials for all supported clouds.
+      sky check
+      \b
+      # Check only specific clouds - AWS and GCP.
+      sky check aws gcp
     """
-    sky_check.check(verbose=verbose)
+    clouds_arg = clouds if len(clouds) > 0 else None
+    sky_check.check(verbose=verbose, clouds=clouds_arg)
 
 
 @cli.command()
 @click.argument('accelerator_str', required=False)
 @click.option('--all',
               '-a',
               is_flag=True,
@@ -3516,25 +2962,39 @@
 
     To show all accelerators, including less common ones and their detailed
     information, use ``sky show-gpus --all``.
 
     To show all regions for a specified accelerator, use
     ``sky show-gpus <accelerator> --all-regions``.
 
+    If ``--region`` or ``--all-regions`` is not specified, the price displayed
+    for each instance type is the lowest across all regions for both on-demand
+    and spot instances. There may be multiple regions with the same lowest
+    price.
+
+    If ``--cloud kubernetes`` is specified, it will show the maximum quantities
+    of the GPU available on a single node and the real-time availability of
+    the GPU across all nodes in the Kubernetes cluster.
+
     Definitions of certain fields:
 
     * ``DEVICE_MEM``: Memory of a single device; does not depend on the device
       count of the instance (VM).
 
     * ``HOST_MEM``: Memory of the host instance (VM).
 
-    If ``--region`` or ``--all-regions`` is not specified, the price displayed
-    for each instance type is the lowest across all regions for both on-demand
-    and spot instances. There may be multiple regions with the same lowest
-    price.
+    * ``QTY_PER_NODE`` (Kubernetes only): GPU quantities that can be requested
+      on a single node.
+
+    * ``TOTAL_GPUS`` (Kubernetes only): Total number of GPUs available in the
+      Kubernetes cluster.
+
+    * ``TOTAL_FREE_GPUS`` (Kubernetes only): Number of currently free GPUs
+      in the Kubernetes cluster. This is fetched in real-time and may change
+      when other users are using the cluster.
     """
     # validation for the --region flag
     if region is not None and cloud is None:
         raise click.UsageError(
             'The --region flag is only valid when the --cloud flag is set.')
 
     # validation for the --all-regions flag
@@ -3543,56 +3003,151 @@
             'The --all-regions flag is only valid when an accelerator '
             'is specified.')
     if all_regions and region is not None:
         raise click.UsageError(
             '--all-regions and --region flags cannot be used simultaneously.')
 
     # This will validate 'cloud' and raise if not found.
-    cloud_obj = clouds.CLOUD_REGISTRY.from_str(cloud)
+    cloud_obj = sky_clouds.CLOUD_REGISTRY.from_str(cloud)
     service_catalog.validate_region_zone(region, None, clouds=cloud)
     show_all = all
     if show_all and accelerator_str is not None:
         raise click.UsageError('--all is only allowed without a GPU name.')
 
+    # Kubernetes specific bools
+    cloud_is_kubernetes = isinstance(cloud_obj, sky_clouds.Kubernetes)
+    kubernetes_autoscaling = kubernetes_utils.get_autoscaler_type() is not None
+    kubernetes_is_enabled = sky_clouds.cloud_in_iterable(
+        sky_clouds.Kubernetes(), global_user_state.get_cached_enabled_clouds())
+
+    if cloud_is_kubernetes and region is not None:
+        raise click.UsageError(
+            'The --region flag cannot be set with --cloud kubernetes.')
+
     def _list_to_str(lst):
         return ', '.join([str(e) for e in lst])
 
+    def _get_kubernetes_realtime_gpu_table(
+            name_filter: Optional[str] = None,
+            quantity_filter: Optional[int] = None):
+        if quantity_filter:
+            qty_header = 'QTY_FILTER'
+            free_header = 'FILTERED_FREE_GPUS'
+        else:
+            qty_header = 'QTY_PER_NODE'
+            free_header = 'TOTAL_FREE_GPUS'
+        realtime_gpu_table = log_utils.create_table(
+            ['GPU', qty_header, 'TOTAL_GPUS', free_header])
+        counts, capacity, available = service_catalog.list_accelerator_realtime(
+            gpus_only=True,
+            clouds='kubernetes',
+            name_filter=name_filter,
+            region_filter=region,
+            quantity_filter=quantity_filter,
+            case_sensitive=False)
+        assert (set(counts.keys()) == set(capacity.keys()) == set(
+            available.keys())), (f'Keys of counts ({list(counts.keys())}), '
+                                 f'capacity ({list(capacity.keys())}), '
+                                 f'and available ({list(available.keys())}) '
+                                 'must be same.')
+        if len(counts) == 0:
+            err_msg = 'No GPUs found in Kubernetes cluster. '
+            debug_msg = 'To further debug, run: sky check '
+            if name_filter is not None:
+                gpu_info_msg = f' {name_filter!r}'
+                if quantity_filter is not None:
+                    gpu_info_msg += (' with requested quantity'
+                                     f' {quantity_filter}')
+                err_msg = (f'Resources{gpu_info_msg} not found '
+                           'in Kubernetes cluster. ')
+                debug_msg = ('To show available accelerators on kubernetes,'
+                             ' run: sky show-gpus --cloud kubernetes ')
+            full_err_msg = (err_msg + kubernetes_utils.NO_GPU_HELP_MESSAGE +
+                            debug_msg)
+            raise ValueError(full_err_msg)
+        for gpu, _ in sorted(counts.items()):
+            realtime_gpu_table.add_row([
+                gpu,
+                _list_to_str(counts.pop(gpu)), capacity[gpu], available[gpu]
+            ])
+        return realtime_gpu_table
+
     def _output():
         gpu_table = log_utils.create_table(
             ['COMMON_GPU', 'AVAILABLE_QUANTITIES'])
         tpu_table = log_utils.create_table(
             ['GOOGLE_TPU', 'AVAILABLE_QUANTITIES'])
         other_table = log_utils.create_table(
             ['OTHER_GPU', 'AVAILABLE_QUANTITIES'])
 
         name, quantity = None, None
 
+        # Optimization - do not poll for Kubernetes API for fetching
+        # common GPUs because that will be fetched later for the table after
+        # common GPUs.
+        clouds_to_list = cloud
+        if cloud is None:
+            clouds_to_list = [
+                c for c in service_catalog.ALL_CLOUDS if c != 'kubernetes'
+            ]
+
+        k8s_messages = ''
         if accelerator_str is None:
+            # Collect k8s related messages in k8s_messages and print them at end
+            print_section_titles = False
+            # If cloud is kubernetes, we want to show real-time capacity
+            if kubernetes_is_enabled and (cloud is None or cloud_is_kubernetes):
+                try:
+                    # If --cloud kubernetes is not specified, we want to catch
+                    # the case where no GPUs are available on the cluster and
+                    # print the warning at the end.
+                    k8s_realtime_table = _get_kubernetes_realtime_gpu_table()
+                except ValueError as e:
+                    if not cloud_is_kubernetes:
+                        # Make it a note if cloud is not kubernetes
+                        k8s_messages += 'Note: '
+                    k8s_messages += str(e)
+                else:
+                    print_section_titles = True
+                    yield (f'{colorama.Fore.CYAN}{colorama.Style.BRIGHT}'
+                           f'Kubernetes GPUs{colorama.Style.RESET_ALL}\n')
+                    yield from k8s_realtime_table.get_string()
+                if kubernetes_autoscaling:
+                    k8s_messages += (
+                        '\n' + kubernetes_utils.KUBERNETES_AUTOSCALER_NOTE)
+            if cloud_is_kubernetes:
+                # Do not show clouds if --cloud kubernetes is specified
+                if not kubernetes_is_enabled:
+                    yield ('Kubernetes is not enabled. To fix, run: '
+                           'sky check kubernetes ')
+                yield k8s_messages
+                return
+
+            # For show_all, show the k8s message at the start since output is
+            # long and the user may not scroll to the end.
+            if show_all and k8s_messages:
+                yield k8s_messages
+                yield '\n\n'
+
             result = service_catalog.list_accelerator_counts(
                 gpus_only=True,
-                clouds=cloud,
+                clouds=clouds_to_list,
                 region_filter=region,
             )
 
-            if (len(result) == 0 and cloud_obj is not None and
-                    cloud_obj.is_same_cloud(clouds.Kubernetes())):
-                yield kubernetes_utils.NO_GPU_ERROR_MESSAGE
-                return
+            if print_section_titles:
+                # If section titles were printed above, print again here
+                yield '\n\n'
+                yield (f'{colorama.Fore.CYAN}{colorama.Style.BRIGHT}'
+                       f'Cloud GPUs{colorama.Style.RESET_ALL}\n')
 
             # "Common" GPUs
-            # If cloud is kubernetes, we want to show all GPUs here, even if
-            # they are not listed as common in SkyPilot.
-            if (cloud_obj is not None and
-                    cloud_obj.is_same_cloud(clouds.Kubernetes())):
-                for gpu, _ in sorted(result.items()):
+            for gpu in service_catalog.get_common_gpus():
+                if gpu in result:
                     gpu_table.add_row([gpu, _list_to_str(result.pop(gpu))])
-            else:
-                for gpu in service_catalog.get_common_gpus():
-                    if gpu in result:
-                        gpu_table.add_row([gpu, _list_to_str(result.pop(gpu))])
             yield from gpu_table.get_string()
 
             # Google TPUs
             for tpu in service_catalog.get_tpus():
                 if tpu in result:
                     tpu_table.add_row([tpu, _list_to_str(result.pop(tpu))])
             if len(tpu_table.get_string()) > 0:
@@ -3605,14 +3160,17 @@
                 for gpu, qty in sorted(result.items()):
                     other_table.add_row([gpu, _list_to_str(qty)])
                 yield from other_table.get_string()
                 yield '\n\n'
             else:
                 yield ('\n\nHint: use -a/--all to see all accelerators '
                        '(including non-common ones) and pricing.')
+                if k8s_messages:
+                    yield '\n'
+                    yield k8s_messages
                 return
         else:
             # Parse accelerator string
             accelerator_split = accelerator_str.split(':')
             if len(accelerator_split) > 2:
                 raise click.UsageError(
                     f'Invalid accelerator string {accelerator_str}. '
@@ -3628,36 +3186,92 @@
                 except ValueError as invalid_quantity:
                     raise click.UsageError(
                         f'Invalid accelerator quantity {accelerator_split[1]}. '
                         'Expected a positive integer.') from invalid_quantity
             else:
                 name, quantity = accelerator_str, None
 
+        print_section_titles = False
+        if (kubernetes_is_enabled and (cloud is None or cloud_is_kubernetes) and
+                not show_all):
+            # Print section title if not showing all and instead a specific
+            # accelerator is requested
+            print_section_titles = True
+            yield (f'{colorama.Fore.CYAN}{colorama.Style.BRIGHT}'
+                   f'Kubernetes GPUs{colorama.Style.RESET_ALL}\n')
+            try:
+                k8s_realtime_table = _get_kubernetes_realtime_gpu_table(
+                    name_filter=name, quantity_filter=quantity)
+                yield from k8s_realtime_table.get_string()
+            except ValueError as e:
+                # In the case of a specific accelerator, show the error message
+                # immediately (e.g., "Resources H100 not found ...")
+                yield str(e)
+            if kubernetes_autoscaling:
+                k8s_messages += ('\n' +
+                                 kubernetes_utils.KUBERNETES_AUTOSCALER_NOTE)
+            yield k8s_messages
+        if cloud_is_kubernetes:
+            # Do not show clouds if --cloud kubernetes is specified
+            if not kubernetes_is_enabled:
+                yield ('Kubernetes is not enabled. To fix, run: '
+                       'sky check kubernetes ')
+            return
+
+        # For clouds other than Kubernetes, get the accelerator details
         # Case-sensitive
         result = service_catalog.list_accelerators(gpus_only=True,
                                                    name_filter=name,
                                                    quantity_filter=quantity,
                                                    region_filter=region,
-                                                   clouds=cloud,
+                                                   clouds=clouds_to_list,
                                                    case_sensitive=False,
                                                    all_regions=all_regions)
+        # Import here to save module load speed.
+        # pylint: disable=import-outside-toplevel,line-too-long
+        from sky.clouds.service_catalog import common
+
+        # For each gpu name (count not included):
+        #   - Group by cloud
+        #   - Sort within each group by prices
+        #   - Sort groups by each cloud's (min price, min spot price)
+        new_result = {}
+        for i, (gpu, items) in enumerate(result.items()):
+            df = pd.DataFrame([t._asdict() for t in items])
+            # Determine the minimum prices for each cloud.
+            min_price_df = df.groupby('cloud').agg(min_price=('price', 'min'),
+                                                   min_spot_price=('spot_price',
+                                                                   'min'))
+            df = df.merge(min_price_df, on='cloud')
+            # Sort within each cloud by price.
+            df = df.groupby('cloud', group_keys=False).apply(
+                lambda x: x.sort_values(by=['price', 'spot_price']))
+            # Sort across groups (clouds).
+            df = df.sort_values(by=['min_price', 'min_spot_price'])
+            df = df.drop(columns=['min_price', 'min_spot_price'])
+            sorted_dataclasses = [
+                common.InstanceTypeInfo(*row)
+                for row in df.to_records(index=False)
+            ]
+            new_result[gpu] = sorted_dataclasses
+        result = new_result
 
-        if len(result) == 0:
-            if cloud == 'kubernetes':
-                yield kubernetes_utils.NO_GPU_ERROR_MESSAGE
-                return
+        if print_section_titles and not show_all:
+            yield '\n\n'
+            yield (f'{colorama.Fore.CYAN}{colorama.Style.BRIGHT}'
+                   f'Cloud GPUs{colorama.Style.RESET_ALL}\n')
 
+        if len(result) == 0:
             quantity_str = (f' with requested quantity {quantity}'
                             if quantity else '')
-            yield f'Resources \'{name}\'{quantity_str} not found. '
-            yield 'Try \'sky show-gpus --all\' '
-            yield 'to show available accelerators.'
+            cloud_str = f' on {cloud_obj}.' if cloud else ' in cloud catalogs.'
+            yield f'Resources \'{name}\'{quantity_str} not found{cloud_str} '
+            yield 'To show available accelerators, run: sky show-gpus --all'
             return
 
-        import pandas as pd  # pylint: disable=import-outside-toplevel
         for i, (gpu, items) in enumerate(result.items()):
             accelerator_table_headers = [
                 'GPU',
                 'QTY',
                 'CLOUD',
                 'INSTANCE_TYPE',
                 'DEVICE_MEM',
@@ -3670,21 +3284,22 @@
                 accelerator_table_headers.append('REGION')
             accelerator_table = log_utils.create_table(
                 accelerator_table_headers)
             for item in items:
                 instance_type_str = item.instance_type if not pd.isna(
                     item.instance_type) else '(attachable)'
                 cpu_count = item.cpu_count
-                if pd.isna(cpu_count):
-                    cpu_str = '-'
-                elif isinstance(cpu_count, (float, int)):
+                if not pd.isna(cpu_count) and isinstance(
+                        cpu_count, (float, int)):
                     if int(cpu_count) == cpu_count:
                         cpu_str = str(int(cpu_count))
                     else:
                         cpu_str = f'{cpu_count:.1f}'
+                else:
+                    cpu_str = '-'
                 device_memory_str = (f'{item.device_memory:.0f}GB' if
                                      not pd.isna(item.device_memory) else '-')
                 host_memory_str = f'{item.memory:.0f}GB' if not pd.isna(
                     item.memory) else '-'
                 price_str = f'$ {item.price:.3f}' if not pd.isna(
                     item.price) else '-'
                 spot_price_str = f'$ {item.spot_price:.3f}' if not pd.isna(
@@ -3801,31 +3416,37 @@
 @cli.group(cls=_NaturalOrderGroup)
 def bench():
     """SkyPilot Benchmark CLI."""
     pass
 
 
 @cli.group(cls=_NaturalOrderGroup)
-def spot():
-    """Managed Spot CLI (spot instances with auto-recovery)."""
+def jobs():
+    """Managed Jobs CLI (jobs with auto-recovery)."""
     pass
 
 
-@spot.command('launch', cls=_DocumentedCodeCommand)
+@jobs.command('launch', cls=_DocumentedCodeCommand)
 @click.argument('entrypoint',
                 required=True,
                 type=str,
                 nargs=-1,
                 **_get_shell_complete_args(_complete_file_name))
 # TODO(zhwu): Add --dryrun option to test the launch command.
 @_add_click_options(_TASK_OPTIONS_WITH_NAME + _EXTRA_RESOURCES_OPTIONS)
-@click.option('--spot-recovery',
+@click.option('--cluster',
+              '-c',
               default=None,
               type=str,
-              help='Spot recovery strategy to use for the managed spot task.')
+              hidden=True,
+              help=('Alias for --name, the name of the spot job.'))
+@click.option('--job-recovery',
+              default=None,
+              type=str,
+              help='Recovery strategy to use for managed jobs.')
 @click.option(
     '--detach-run',
     '-d',
     default=False,
     is_flag=True,
     help=('If True, as soon as a job is submitted, return from this call '
           'and do not stream execution logs.'))
@@ -3835,62 +3456,68 @@
     default=None,
     is_flag=True,
     required=False,
     help=(
         '(Default: True; this flag is deprecated and will be removed in a '
         'future release.) Whether to retry provisioning infinitely until the '
         'cluster is up, if unavailability errors are encountered. This '  # pylint: disable=bad-docstring-quotes
-        'applies to launching the spot clusters (both the initial and any '
-        'recovery attempts), not the spot controller.'))
+        'applies to launching all managed jobs (both the initial and '
+        'any recovery attempts), not the jobs controller.'))
 @click.option('--yes',
               '-y',
               is_flag=True,
               default=False,
               required=False,
               help='Skip confirmation prompt.')
 @timeline.event
 @usage_lib.entrypoint
-def spot_launch(
-    entrypoint: List[str],
+def jobs_launch(
+    entrypoint: Tuple[str, ...],
     name: Optional[str],
+    cluster: Optional[str],
     workdir: Optional[str],
     cloud: Optional[str],
     region: Optional[str],
     zone: Optional[str],
     gpus: Optional[str],
     cpus: Optional[str],
     memory: Optional[str],
     instance_type: Optional[str],
     num_nodes: Optional[int],
     use_spot: Optional[bool],
     image_id: Optional[str],
-    spot_recovery: Optional[str],
+    job_recovery: Optional[str],
     env_file: Optional[Dict[str, str]],
     env: List[Tuple[str, str]],
     disk_size: Optional[int],
     disk_tier: Optional[str],
     ports: Tuple[str],
     detach_run: bool,
     retry_until_up: bool,
     yes: bool,
 ):
-    """Launch a managed spot job from a YAML or a command.
+    """Launch a managed job from a YAML or a command.
 
     If ENTRYPOINT points to a valid YAML file, it is read in as the task
     specification. Otherwise, it is interpreted as a bash command.
 
     Examples:
 
     .. code-block:: bash
 
       # You can use normal task YAMLs.
-      sky spot launch task.yaml
+      sky jobs launch task.yaml
 
-      sky spot launch 'echo hello!'
+      sky jobs launch 'echo hello!'
     """
+    if cluster is not None:
+        if name is not None and name != cluster:
+            raise click.UsageError('Cannot specify both --name and --cluster. '
+                                   'Use one of the flags as they are alias.')
+        name = cluster
     env = _merge_env_vars(env_file, env)
     task_or_dag = _make_task_or_dag_from_entrypoint_with_overrides(
         entrypoint,
         name=name,
         workdir=workdir,
         cloud=cloud,
         region=region,
@@ -3902,24 +3529,25 @@
         num_nodes=num_nodes,
         use_spot=use_spot,
         image_id=image_id,
         env=env,
         disk_size=disk_size,
         disk_tier=disk_tier,
         ports=ports,
-        spot_recovery=spot_recovery,
+        job_recovery=job_recovery,
     )
-    # Deprecation.
+    # Deprecation. We set the default behavior to be retry until up, and the
+    # flag `--retry-until-up` is deprecated. We can remove the flag in 0.8.0.
     if retry_until_up is not None:
         flag_str = '--retry-until-up'
         if not retry_until_up:
             flag_str = '--no-retry-until-up'
         click.secho(
             f'Flag {flag_str} is deprecated and will be removed in a '
-            'future release (managed spot jobs will always be retried). '
+            'future release (managed jobs will always be retried). '
             'Please file an issue if this does not work for you.',
             fg='yellow')
     else:
         retry_until_up = True
 
     if not isinstance(task_or_dag, sky.Dag):
         assert isinstance(task_or_dag, sky.Task), task_or_dag
@@ -3929,72 +3557,71 @@
     else:
         dag = task_or_dag
 
     if name is not None:
         dag.name = name
 
     dag_utils.maybe_infer_and_fill_dag_and_task_names(dag)
-    dag_utils.fill_default_spot_config_in_dag_for_spot_launch(dag)
+    dag_utils.fill_default_config_in_dag_for_job_launch(dag)
 
-    click.secho(
-        f'Managed spot job {dag.name!r} will be launched on (estimated):',
-        fg='yellow')
+    click.secho(f'Managed job {dag.name!r} will be launched on (estimated):',
+                fg='yellow')
     dag = sky.optimize(dag)
 
     if not yes:
-        prompt = f'Launching the spot job {dag.name!r}. Proceed?'
+        prompt = f'Launching a managed job {dag.name!r}. Proceed?'
         if prompt is not None:
             click.confirm(prompt, default=True, abort=True, show_default=True)
 
     common_utils.check_cluster_name_is_valid(name)
 
-    sky.spot_launch(dag,
-                    name,
-                    detach_run=detach_run,
-                    retry_until_up=retry_until_up)
+    managed_jobs.launch(dag,
+                        name,
+                        detach_run=detach_run,
+                        retry_until_up=retry_until_up)
 
 
-@spot.command('queue', cls=_DocumentedCodeCommand)
+@jobs.command('queue', cls=_DocumentedCodeCommand)
 @click.option('--all',
               '-a',
               default=False,
               is_flag=True,
               required=False,
               help='Show all information in full.')
 @click.option(
     '--refresh',
     '-r',
     default=False,
     is_flag=True,
     required=False,
-    help='Query the latest statuses, restarting the spot controller if stopped.'
+    help='Query the latest statuses, restarting the jobs controller if stopped.'
 )
 @click.option('--skip-finished',
               '-s',
               default=False,
               is_flag=True,
               required=False,
               help='Show only pending/running jobs\' information.')
 @usage_lib.entrypoint
 # pylint: disable=redefined-builtin
-def spot_queue(all: bool, refresh: bool, skip_finished: bool):
-    """Show statuses of managed spot jobs.
+def jobs_queue(all: bool, refresh: bool, skip_finished: bool):
+    """Show statuses of managed jobs.
 
-    Each spot job can have one of the following statuses:
+    Each managed jobs can have one of the following statuses:
 
-    - ``PENDING``: Job is waiting for a free slot on the spot controller to be
+    - ``PENDING``: Job is waiting for a free slot on the jobs controller to be
       accepted.
 
-    - ``SUBMITTED``: Job is submitted to and accepted by the spot controller.
+    - ``SUBMITTED``: Job is submitted to and accepted by the jobs controller.
 
-    - ``STARTING``: Job is starting (provisioning a spot cluster).
+    - ``STARTING``: Job is starting (provisioning a cluster for the job).
 
     - ``RUNNING``: Job is running.
 
-    - ``RECOVERING``: The spot cluster is recovering from a preemption.
+    - ``RECOVERING``: The cluster of the job is recovering from a preemption.
 
     - ``SUCCEEDED``: Job succeeded.
 
     - ``CANCELLING``: Job was requested to be cancelled by the user, and the
       cancellation is in progress.
 
     - ``CANCELLED``: Job was cancelled by the user.
@@ -4009,182 +3636,178 @@
 
     - ``FAILED_NO_RESOURCE``: Job failed due to resources being unavailable
       after a maximum number of retries.
 
     - ``FAILED_CONTROLLER``: Job failed due to an unexpected error in the spot
       controller.
 
-    If the job failed, either due to user code or spot unavailability, the
-    error log can be found with ``sky spot logs --controller``, e.g.:
+    If the job failed, either due to user code or resource unavailability, the
+    error log can be found with ``sky jobs logs --controller``, e.g.:
 
     .. code-block:: bash
 
-      sky spot logs --controller job_id
+      sky jobs logs --controller job_id
 
     This also shows the logs for provisioning and any preemption and recovery
     attempts.
 
     (Tip) To fetch job statuses every 60 seconds, use ``watch``:
 
     .. code-block:: bash
 
-      watch -n60 sky spot queue
+      watch -n60 sky jobs queue
 
     """
-    click.secho('Fetching managed spot job statuses...', fg='yellow')
-    with rich_utils.safe_status('[cyan]Checking spot jobs[/]'):
-        _, msg = _get_spot_jobs(refresh=refresh,
-                                skip_finished=skip_finished,
-                                show_all=all,
-                                is_called_by_user=True)
+    click.secho('Fetching managed job statuses...', fg='yellow')
+    with rich_utils.safe_status('[cyan]Checking managed jobs[/]'):
+        _, msg = _get_managed_jobs(refresh=refresh,
+                                   skip_finished=skip_finished,
+                                   show_all=all,
+                                   is_called_by_user=True)
     if not skip_finished:
         in_progress_only_hint = ''
     else:
         in_progress_only_hint = ' (showing in-progress jobs only)'
     click.echo(f'{colorama.Fore.CYAN}{colorama.Style.BRIGHT}'
-               f'Managed spot jobs{colorama.Style.RESET_ALL}'
+               f'Managed jobs{colorama.Style.RESET_ALL}'
                f'{in_progress_only_hint}\n{msg}')
 
 
-@spot.command('cancel', cls=_DocumentedCodeCommand)
+@jobs.command('cancel', cls=_DocumentedCodeCommand)
 @click.option('--name',
               '-n',
               required=False,
               type=str,
-              help='Managed spot job name to cancel.')
+              help='Managed job name to cancel.')
 @click.argument('job_ids', default=None, type=int, required=False, nargs=-1)
 @click.option('--all',
               '-a',
               is_flag=True,
               default=False,
               required=False,
-              help='Cancel all managed spot jobs.')
+              help='Cancel all managed jobs.')
 @click.option('--yes',
               '-y',
               is_flag=True,
               default=False,
               required=False,
               help='Skip confirmation prompt.')
 @usage_lib.entrypoint
 # pylint: disable=redefined-builtin
-def spot_cancel(name: Optional[str], job_ids: Tuple[int], all: bool, yes: bool):
-    """Cancel managed spot jobs.
+def jobs_cancel(name: Optional[str], job_ids: Tuple[int], all: bool, yes: bool):
+    """Cancel managed jobs.
 
     You can provide either a job name or a list of job IDs to be cancelled.
     They are exclusive options.
 
     Examples:
 
     .. code-block:: bash
 
-      # Cancel managed spot job with name 'my-job'
-      $ sky spot cancel -n my-job
+      # Cancel managed job with name 'my-job'
+      $ sky jobs cancel -n my-job
       \b
-      # Cancel managed spot jobs with IDs 1, 2, 3
-      $ sky spot cancel 1 2 3
+      # Cancel managed jobs with IDs 1, 2, 3
+      $ sky jobs cancel 1 2 3
     """
-    _, handle = backend_utils.is_controller_up(
-        controller_type=controller_utils.Controllers.SPOT_CONTROLLER,
-        stopped_message='All managed spot jobs should have finished.')
-    if handle is None:
-        # Hint messages already printed by the call above.
-        sys.exit(1)
+    backend_utils.is_controller_accessible(
+        controller=controller_utils.Controllers.JOBS_CONTROLLER,
+        stopped_message='All managed jobs should have finished.',
+        exit_if_not_accessible=True)
 
     job_id_str = ','.join(map(str, job_ids))
     if sum([len(job_ids) > 0, name is not None, all]) != 1:
         argument_str = f'--job-ids {job_id_str}' if len(job_ids) > 0 else ''
         argument_str += f' --name {name}' if name is not None else ''
         argument_str += ' --all' if all else ''
         raise click.UsageError(
             'Can only specify one of JOB_IDS or --name or --all. '
             f'Provided {argument_str!r}.')
 
     if not yes:
-        job_identity_str = (f'managed spot jobs with IDs {job_id_str}'
+        job_identity_str = (f'managed jobs with IDs {job_id_str}'
                             if job_ids else repr(name))
         if all:
-            job_identity_str = 'all managed spot jobs'
+            job_identity_str = 'all managed jobs'
         click.confirm(f'Cancelling {job_identity_str}. Proceed?',
                       default=True,
                       abort=True,
                       show_default=True)
 
-    core.spot_cancel(job_ids=job_ids, name=name, all=all)
+    managed_jobs.cancel(job_ids=job_ids, name=name, all=all)
 
 
-@spot.command('logs', cls=_DocumentedCodeCommand)
+@jobs.command('logs', cls=_DocumentedCodeCommand)
 @click.option('--name',
               '-n',
               required=False,
               type=str,
-              help='Managed spot job name.')
+              help='Managed job name.')
 @click.option(
     '--follow/--no-follow',
     is_flag=True,
     default=True,
     help=('Follow the logs of the job. [default: --follow] '
           'If --no-follow is specified, print the log so far and exit.'))
 @click.option(
     '--controller',
     is_flag=True,
     default=False,
     help=('Show the controller logs of this job; useful for debugging '
           'launching/recoveries, etc.'))
 @click.argument('job_id', required=False, type=int)
 @usage_lib.entrypoint
-def spot_logs(name: Optional[str], job_id: Optional[int], follow: bool,
+def jobs_logs(name: Optional[str], job_id: Optional[int], follow: bool,
               controller: bool):
-    """Tail the log of a managed spot job."""
+    """Tail the log of a managed job."""
     try:
-        if controller:
-            core.tail_logs(spot_lib.SPOT_CONTROLLER_NAME,
-                           job_id=job_id,
-                           follow=follow)
-        else:
-            core.spot_tail_logs(name=name, job_id=job_id, follow=follow)
+        managed_jobs.tail_logs(name=name,
+                               job_id=job_id,
+                               follow=follow,
+                               controller=controller)
     except exceptions.ClusterNotUpError:
-        # Hint messages already printed by the call above.
-        sys.exit(1)
+        with ux_utils.print_exception_no_traceback():
+            raise
 
 
-@spot.command('dashboard', cls=_DocumentedCodeCommand)
+@jobs.command('dashboard', cls=_DocumentedCodeCommand)
 @click.option(
     '--port',
     '-p',
     default=None,
     type=int,
     required=False,
     help=('Local port to use for the dashboard. If None, a free port is '
           'automatically chosen.'))
 @usage_lib.entrypoint
-def spot_dashboard(port: Optional[int]):
-    """Opens a dashboard for spot jobs (needs controller to be UP)."""
+def jobs_dashboard(port: Optional[int]):
+    """Opens a dashboard for managed jobs (needs controller to be UP)."""
     # TODO(zongheng): ideally, the controller/dashboard server should expose the
     # API perhaps via REST. Then here we would (1) not have to use SSH to try to
     # see if the controller is UP first, which is slow; (2) not have to run SSH
     # port forwarding first (we'd just launch a local dashboard which would make
     # REST API calls to the controller dashboard server).
-    click.secho('Checking if spot controller is up...', fg='yellow')
-    hint = (
-        'Dashboard is not available if spot controller is not up. Run a spot '
-        'job first.')
-    _, handle = backend_utils.is_controller_up(
-        controller_type=controller_utils.Controllers.SPOT_CONTROLLER,
+    click.secho('Checking if jobs controller is up...', fg='yellow')
+    hint = ('Dashboard is not available if jobs controller is not up. Run a '
+            'managed job first.')
+    backend_utils.is_controller_accessible(
+        controller=controller_utils.Controllers.JOBS_CONTROLLER,
         stopped_message=hint,
-        non_existent_message=hint)
-    if handle is None:
-        sys.exit(1)
+        non_existent_message=hint,
+        exit_if_not_accessible=True)
+
     # SSH forward a free local port to remote's dashboard port.
     remote_port = constants.SPOT_DASHBOARD_REMOTE_PORT
     if port is None:
         free_port = common_utils.find_free_port(remote_port)
     else:
         free_port = port
-    ssh_command = (f'ssh -qNL {free_port}:localhost:{remote_port} '
-                   f'{spot_lib.SPOT_CONTROLLER_NAME}')
+    ssh_command = (
+        f'ssh -qNL {free_port}:localhost:{remote_port} '
+        f'{controller_utils.Controllers.JOBS_CONTROLLER.value.cluster_name}')
     click.echo('Forwarding port: ', nl=False)
     click.secho(f'{ssh_command}', dim=True)
 
     with subprocess.Popen(ssh_command, shell=True,
                           start_new_session=True) as ssh_process:
         time.sleep(3)  # Added delay for ssh_command to initialize.
         webbrowser.open(f'http://localhost:{free_port}')
@@ -4195,29 +3818,48 @@
             ssh_process.wait()
         except KeyboardInterrupt:
             # When user presses Ctrl-C in terminal, exits the previous ssh
             # command so that <free local port> is freed up.
             try:
                 os.killpg(os.getpgid(ssh_process.pid), signal.SIGTERM)
             except ProcessLookupError:
-                # This happens if spot controller is auto-stopped.
+                # This happens if jobs controller is auto-stopped.
                 pass
         finally:
             click.echo('Exiting.')
 
 
+# TODO(zhwu): Backward compatibility for the old `sky spot launch` command.
+# It is now renamed to `sky jobs launch` and the old command is deprecated.
+# Remove in v0.8.0.
+@cli.group(cls=_NaturalOrderGroup)
+def spot():
+    """Alias for Managed Jobs CLI (default to managed spot jobs)."""
+    pass
+
+
+_add_command_alias(jobs,
+                   jobs_launch,
+                   new_group=spot,
+                   override_command_argument={'use_spot': True})
+_add_command_alias(jobs, jobs_queue, new_group=spot)
+_add_command_alias(jobs, jobs_logs, new_group=spot)
+_add_command_alias(jobs, jobs_cancel, new_group=spot)
+_add_command_alias(jobs, jobs_dashboard, new_group=spot)
+
+
 @cli.group(cls=_NaturalOrderGroup)
 def serve():
     """SkyServe CLI (multi-region, multi-cloud serving)."""
     pass
 
 
 def _generate_task_with_service(
     service_name: str,
-    service_yaml_args: List[str],
+    service_yaml_args: Tuple[str, ...],
     workdir: Optional[str],
     cloud: Optional[str],
     region: Optional[str],
     zone: Optional[str],
     num_nodes: Optional[int],
     use_spot: Optional[bool],
     image_id: Optional[str],
@@ -4314,15 +3956,15 @@
               is_flag=True,
               default=False,
               required=False,
               help='Skip confirmation prompt.')
 @timeline.event
 @usage_lib.entrypoint
 def serve_up(
-    service_yaml: List[str],
+    service_yaml: Tuple[str, ...],
     service_name: Optional[str],
     workdir: Optional[str],
     cloud: Optional[str],
     region: Optional[str],
     zone: Optional[str],
     num_nodes: Optional[int],
     use_spot: Optional[bool],
@@ -4414,25 +4056,33 @@
 @click.argument('service_name', required=True, type=str)
 @click.argument('service_yaml',
                 required=True,
                 type=str,
                 nargs=-1,
                 **_get_shell_complete_args(_complete_file_name))
 @_add_click_options(_TASK_OPTIONS + _EXTRA_RESOURCES_OPTIONS)
+@click.option('--mode',
+              default=serve_lib.DEFAULT_UPDATE_MODE.value,
+              type=click.Choice([m.value for m in serve_lib.UpdateMode],
+                                case_sensitive=False),
+              required=False,
+              help=('Update mode. If "rolling", SkyServe will update the '
+                    'service with rolling update. If "blue_green", SkyServe '
+                    'will update the service with blue-green update. '))
 @click.option('--yes',
               '-y',
               is_flag=True,
               default=False,
               required=False,
               help='Skip confirmation prompt.')
 @timeline.event
 @usage_lib.entrypoint
 def serve_update(
     service_name: str,
-    service_yaml: List[str],
+    service_yaml: Tuple[str, ...],
     workdir: Optional[str],
     cloud: Optional[str],
     region: Optional[str],
     zone: Optional[str],
     num_nodes: Optional[int],
     use_spot: Optional[bool],
     image_id: Optional[str],
@@ -4441,25 +4091,45 @@
     gpus: Optional[str],
     instance_type: Optional[str],
     ports: Tuple[str],
     cpus: Optional[str],
     memory: Optional[str],
     disk_size: Optional[int],
     disk_tier: Optional[str],
+    mode: str,
     yes: bool,
 ):
     """Update a SkyServe service.
 
     service_yaml must point to a valid YAML file.
 
+    SkyServe will reuse old replicas, if only the service section is changed
+    and no file mounts are specified.
+
+    Otherwise, SkyServe will terminate the old replicas and start new replicas.
+
+    Two update modes are supported:
+
+    - "rolling": (default) SkyServe will update the service with rolling update,
+        i.e., it will terminate one old replica whenever one new replica is
+        ready. Traffic can be mixed on old and new replicas.
+    - "blue_green": SkyServe will update the service with blue-green update,
+        i.e., it will wait for new replicas to be ready and then terminate old
+        replicas. Traffic will only be switched from old to new replicas after
+        enough new replicas are ready.
+
     Example:
 
     .. code-block:: bash
 
+        # Update an existing service with rolling update
         sky serve update sky-service-16aa new_service.yaml
+        # Use blue-green update
+        sky serve update --mode blue_green sky-service-16aa new_service.yaml
+
     """
     task = _generate_task_with_service(
         service_name=service_name,
         service_yaml_args=service_yaml,
         workdir=workdir,
         cloud=cloud,
         region=region,
@@ -4489,15 +4159,15 @@
 
     if not yes:
         click.confirm(f'Updating service {service_name!r}. Proceed?',
                       default=True,
                       abort=True,
                       show_default=True)
 
-    serve_lib.update(task, service_name)
+    serve_lib.update(task, service_name, mode=serve_lib.UpdateMode(mode))
 
 
 @serve.command('status', cls=_DocumentedCodeCommand)
 @click.option('--all',
               '-a',
               default=False,
               is_flag=True,
@@ -4667,20 +4337,18 @@
         argument_str = f'SERVICE_NAMES={",".join(service_names)}' if len(
             service_names) > 0 else ''
         argument_str += ' --all' if all else ''
         raise click.UsageError(
             'Can only specify one of SERVICE_NAMES or --all. '
             f'Provided {argument_str!r}.')
 
-    _, handle = backend_utils.is_controller_up(
-        controller_type=controller_utils.Controllers.SKY_SERVE_CONTROLLER,
-        stopped_message='All services should have been terminated.')
-    if handle is None:
-        # Hint messages already printed by the call above.
-        sys.exit(1)
+    backend_utils.is_controller_accessible(
+        controller=controller_utils.Controllers.SKY_SERVE_CONTROLLER,
+        stopped_message='All services should have been terminated.',
+        exit_if_not_accessible=True)
 
     if not yes:
         quoted_service_names = [f'{name!r}' for name in service_names]
         service_identity_str = f'service(s) {", ".join(quoted_service_names)}'
         if all:
             service_identity_str = 'all services'
         click.confirm(f'Terminating {service_identity_str}. Proceed?',
@@ -4753,16 +4421,16 @@
         target_component = serve_lib.ServiceComponent.REPLICA
     try:
         serve_lib.tail_logs(service_name,
                             target=target_component,
                             replica_id=replica_id,
                             follow=follow)
     except exceptions.ClusterNotUpError:
-        # Hint messages already printed by the call above.
-        sys.exit(1)
+        with ux_utils.print_exception_no_traceback():
+            raise
 
 
 # ==============================
 # Sky Benchmark CLIs
 # ==============================
 
 
@@ -5437,25 +5105,26 @@
     # to strip all stderr of "No kind clusters found.", which is
     # printed when querying with kind get clusters.
     stderr = stderr.replace('No kind clusters found.\n', '')
 
     if returncode == 0:
         cluster_created = True
     elif returncode == 100:
-        click.echo(f'{style.BRIGHT}Local cluster already '
-                   f'exists.{style.RESET_ALL} '
-                   'Run `sky local down` to delete it.')
+        click.echo(f'{colorama.Fore.GREEN}Local cluster already '
+                   f'exists.{style.RESET_ALL}\n'
+                   'If you want to delete it instead, run: sky local down')
     else:
-        click.echo('Failed to create local cluster. '
-                   f'Full log: {log_path}'
-                   f'\nError: {style.BRIGHT}{stderr}{style.RESET_ALL}')
-        sys.exit(1)
+        with ux_utils.print_exception_no_traceback():
+            raise RuntimeError(
+                'Failed to create local cluster. '
+                f'Full log: {log_path}'
+                f'\nError: {style.BRIGHT}{stderr}{style.RESET_ALL}')
     # Run sky check
     with rich_utils.safe_status('[bold cyan]Running sky check...'):
-        sky_check.check(quiet=True)
+        sky_check.check(clouds=['kubernetes'], quiet=True)
     if cluster_created:
         # Prepare completion message which shows CPU and GPU count
         # Get number of CPUs
         p = subprocess_utils.run(
             'kubectl get nodes -o jsonpath=\'{.items[0].status.capacity.cpu}\'',
             capture_output=True)
         num_cpus = int(p.stdout.decode('utf-8'))
@@ -5497,17 +5166,18 @@
                 '\nHint: To see the list of GPUs in the cluster, '
                 'run \'sky show-gpus --cloud kubernetes\'') if gpus else ''
 
         if num_cpus < 2:
             click.echo('Warning: Local cluster has less than 2 CPUs. '
                        'This may cause issues with running tasks.')
         click.echo(
-            f'{style.BRIGHT}Local Kubernetes cluster created successfully with '
-            f'{num_cpus} CPUs{gpu_message}. `sky launch` can now run tasks '
-            f'locally.{style.RESET_ALL}'
+            f'\n{colorama.Fore.GREEN}Local Kubernetes cluster created '
+            'successfully with '
+            f'{num_cpus} CPUs{gpu_message}.{style.RESET_ALL}\n`sky launch` can '
+            'now run tasks locally.'
             '\nHint: To change the number of CPUs, change your docker '
             'runtime settings. See https://kind.sigs.k8s.io/docs/user/quick-start/#settings-for-docker-desktop for more info.'  # pylint: disable=line-too-long
             f'{gpu_hint}')
 
 
 @local.command('down', cls=_DocumentedCodeCommand)
 @usage_lib.entrypoint
@@ -5540,36 +5210,25 @@
         stderr = stderr.replace('No kind clusters found.\n', '')
 
         if returncode == 0:
             cluster_removed = True
         elif returncode == 100:
             click.echo('\nLocal cluster does not exist.')
         else:
-            click.echo('Failed to create local cluster. '
-                       f'Stdout: {stdout}'
-                       f'\nError: {style.BRIGHT}{stderr}{style.RESET_ALL}')
-            sys.exit(1)
+            with ux_utils.print_exception_no_traceback():
+                raise RuntimeError(
+                    'Failed to create local cluster. '
+                    f'Stdout: {stdout}'
+                    f'\nError: {style.BRIGHT}{stderr}{style.RESET_ALL}')
     if cluster_removed:
         # Run sky check
         with rich_utils.safe_status('[bold cyan]Running sky check...'):
-            sky_check.check(quiet=True)
-        click.echo(f'{style.BRIGHT}Local cluster removed.{style.RESET_ALL}')
-
-
-# TODO(skypilot): remove the below in v0.5.
-_add_command_alias_to_group(spot, spot_queue, 'status', hidden=True)
-_deprecate_and_hide_command(group=None,
-                            command_to_deprecate=cpunode,
-                            alternative_command='sky launch')
-_deprecate_and_hide_command(group=None,
-                            command_to_deprecate=gpunode,
-                            alternative_command='sky launch --gpus <gpus>')
-_deprecate_and_hide_command(group=None,
-                            command_to_deprecate=tpunode,
-                            alternative_command='sky launch --gpus <tpus>')
+            sky_check.check(clouds=['kubernetes'], quiet=True)
+        click.echo(
+            f'{colorama.Fore.GREEN}Local cluster removed.{style.RESET_ALL}')
 
 
 def main():
     return cli()
 
 
 if __name__ == '__main__':
```

### Comparing `skypilot-0.5.0/sky/cloud_stores.py` & `skypilot-0.6.0/sky/cloud_stores.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/clouds/__init__.py` & `skypilot-0.6.0/sky/clouds/__init__.py`

 * *Files 13% similar despite different names*

```diff
@@ -1,10 +1,11 @@
 """Clouds in Sky."""
+
 from sky.clouds.cloud import Cloud
-from sky.clouds.cloud import cloud_in_list
+from sky.clouds.cloud import cloud_in_iterable
 from sky.clouds.cloud import CloudImplementationFeatures
 from sky.clouds.cloud import ProvisionerVersion
 from sky.clouds.cloud import Region
 from sky.clouds.cloud import StatusVersion
 from sky.clouds.cloud import Zone
 from sky.clouds.cloud_registry import CLOUD_REGISTRY
 
@@ -15,34 +16,36 @@
 from sky.clouds.cudo import Cudo
 from sky.clouds.fluidstack import Fluidstack
 from sky.clouds.gcp import GCP
 from sky.clouds.ibm import IBM
 from sky.clouds.kubernetes import Kubernetes
 from sky.clouds.lambda_cloud import Lambda
 from sky.clouds.oci import OCI
+from sky.clouds.paperspace import Paperspace
 from sky.clouds.runpod import RunPod
 from sky.clouds.scp import SCP
 from sky.clouds.vsphere import Vsphere
 
 __all__ = [
     'IBM',
     'AWS',
     'Azure',
     'Cloud',
     'Cudo',
     'GCP',
     'Lambda',
+    'Paperspace',
     'SCP',
     'RunPod',
     'OCI',
     'Vsphere',
     'Kubernetes',
     'CloudImplementationFeatures',
     'Region',
     'Zone',
     'CLOUD_REGISTRY',
     'ProvisionerVersion',
     'StatusVersion',
     'Fluidstack',
     # Utility functions
-    'cloud_in_list',
+    'cloud_in_iterable',
 ]
```

### Comparing `skypilot-0.5.0/sky/clouds/aws.py` & `skypilot-0.6.0/sky/clouds/aws.py`

 * *Files 2% similar despite different names*

```diff
@@ -12,14 +12,15 @@
 from sky import clouds
 from sky import exceptions
 from sky import provision as provision_lib
 from sky import sky_logging
 from sky import skypilot_config
 from sky.adaptors import aws
 from sky.clouds import service_catalog
+from sky.skylet import constants
 from sky.utils import common_utils
 from sky.utils import resources_utils
 from sky.utils import rich_utils
 from sky.utils import subprocess_utils
 from sky.utils import ux_utils
 
 if typing.TYPE_CHECKING:
@@ -32,15 +33,15 @@
 # This local file (under ~/.aws/) will be uploaded to remote nodes (any
 # cloud), if all of the following conditions hold:
 #   - the current user identity is not using AWS SSO
 #   - this file exists
 # It has the following purposes:
 #   - make all nodes (any cloud) able to access private S3 buckets
 #   - make some remote nodes able to launch new nodes on AWS (i.e., makes
-#     AWS head node able to launch AWS workers, or any-cloud spot controller
+#     AWS head node able to launch AWS workers, or any-cloud jobs controller
 #     able to launch spot clusters on AWS).
 #
 # If we detect the current user identity is AWS SSO, we will not upload this
 # file to any remote nodes (any cloud). Instead, a SkyPilot IAM role is
 # assigned to both AWS head and workers.
 # TODO(skypilot): This also means we leave open a bug for AWS SSO users that
 # use multiple clouds. The non-AWS nodes will have neither the credential
@@ -76,14 +77,16 @@
     #     region                <not set>             None    None
     SSO = 'sso'
 
     ENV = 'env'
 
     IAM_ROLE = 'iam-role'
 
+    CONTAINER_ROLE = 'container-role'
+
     #       Name                    Value             Type    Location
     #       ----                    -----             ----    --------
     #    profile                <not set>             None    None
     # access_key     ****************abcd shared-credentials-file
     # secret_key     ****************abcd shared-credentials-file
     #     region                us-east-1      config-file    ~/.aws/config
     SHARED_CREDENTIALS_FILE = 'shared-credentials-file'
@@ -282,15 +285,15 @@
 
     @classmethod
     def get_zone_shell_cmd(cls) -> Optional[str]:
         # The command for getting the current zone is from:
         # https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-identity-documents.html  # pylint: disable=line-too-long
         command_str = (
             'curl -s http://169.254.169.254/latest/dynamic/instance-identity/document'  # pylint: disable=line-too-long
-            ' | python3 -u -c "import sys, json; '
+            f' | {constants.SKY_PYTHON_CMD} -u -c "import sys, json; '
             'print(json.load(sys.stdin)[\'availabilityZone\'])"')
         return command_str
 
     #### Normal methods ####
 
     def instance_type_to_hourly_cost(self,
                                      instance_type: str,
@@ -333,17 +336,14 @@
 
         if num_gigabytes > 1:
             cost += (num_gigabytes - 1) * 0.09
 
         cost += 0.0
         return cost
 
-    def is_same_cloud(self, other: clouds.Cloud):
-        return isinstance(other, AWS)
-
     @classmethod
     def get_default_instance_type(
             cls,
             cpus: Optional[str] = None,
             memory: Optional[str] = None,
             disk_tier: Optional[resources_utils.DiskTier] = None
     ) -> Optional[str]:
@@ -414,22 +414,33 @@
             'instance_type': r.instance_type,
             'custom_resources': custom_resources,
             'use_spot': r.use_spot,
             'region': region_name,
             'zones': ','.join(zone_names),
             'image_id': image_id,
             'security_group': security_group,
+            'security_group_managed_by_skypilot':
+                str(security_group != user_security_group).lower(),
             **AWS._get_disk_specs(r.disk_tier)
         }
 
     def _get_feasible_launchable_resources(
         self, resources: 'resources_lib.Resources'
     ) -> Tuple[List['resources_lib.Resources'], List[str]]:
         if resources.instance_type is not None:
             assert resources.is_launchable(), resources
+            # Check the instance type is valid in the cloud
+            regions = self.regions_with_offering(
+                resources.instance_type,
+                accelerators=resources.accelerators,
+                use_spot=resources.use_spot,
+                region=resources.region,
+                zone=resources.zone)
+            if not regions:
+                return ([], [])
             # Treat Resources(AWS, p3.2x, V100) as Resources(AWS, p3.2x).
             resources = resources.copy(accelerators=None)
             return ([resources], [])
 
         def _make(instance_list):
             resource_list = []
             for instance_type in instance_list:
@@ -525,18 +536,24 @@
                     'with static credentials (e.g., ~/.aws/credentials) by unsetting '
                     'the AWS_PROFILE environment variable.')
             else:
                 hints += single_cloud_hint
         elif identity_type == AWSIdentityType.IAM_ROLE:
             # When using an IAM role, the credentials may not exist in the
             # ~/.aws/credentials file. So we don't check for the existence of the
-            # file. This will happen when the user is on a VM (or spot-controller)
-            # created by an SSO account, i.e. the VM will be assigned the IAM
-            # role: skypilot-v1.
+            # file. This will happen when the user is on a VM (or
+            # jobs-controller) created by an SSO account, i.e. the VM will be
+            # assigned the IAM role: skypilot-v1.
             hints = f'AWS IAM role is set.{single_cloud_hint}'
+        elif identity_type == AWSIdentityType.CONTAINER_ROLE:
+            # Similar to the IAM ROLE, an ECS container may not store credentials
+            # in the~/.aws/credentials file. So we don't check for the existence of
+            # the file. i.e. the container will be assigned the IAM role of the
+            # task: skypilot-v1.
+            hints = f'AWS container-role is set.{single_cloud_hint}'
         else:
             # This file is required because it is required by the VMs launched on
             # other clouds to access private s3 buckets and resources like EC2.
             # `get_current_user_identity` does not guarantee this file exists.
             if not static_credential_exists:
                 return (False, '~/.aws/credentials does not exist. ' +
                         cls._STATIC_CREDENTIAL_HELP_STR)
@@ -588,14 +605,16 @@
                     f'Unexpected `aws configure list` output:\n{stdout}')
             return len(results) == 1
 
         if _is_access_key_of_type(AWSIdentityType.SSO.value):
             return AWSIdentityType.SSO
         elif _is_access_key_of_type(AWSIdentityType.IAM_ROLE.value):
             return AWSIdentityType.IAM_ROLE
+        elif _is_access_key_of_type(AWSIdentityType.CONTAINER_ROLE.value):
+            return AWSIdentityType.CONTAINER_ROLE
         elif _is_access_key_of_type(AWSIdentityType.ENV.value):
             return AWSIdentityType.ENV
         else:
             return AWSIdentityType.SHARED_CREDENTIALS_FILE
 
     @classmethod
     def get_current_user_identity(cls) -> Optional[List[str]]:
@@ -729,15 +748,15 @@
         # buckets.
         #
         # TODO(zhwu/zongheng): We can also avoid uploading the credential file
         # for the cluster launched on AWS even if the user is using static
         # credentials. We need to define a mechanism to find out the cloud
         # provider of the cluster to be launched in this function and make sure
         # the cluster will not be used for launching clusters in other clouds,
-        # e.g. spot controller.
+        # e.g. jobs controller.
         if self._current_identity_type(
         ) != AWSIdentityType.SHARED_CREDENTIALS_FILE:
             return {}
         return {
             f'~/.aws/{filename}': f'~/.aws/{filename}'
             for filename in _CREDENTIAL_FILES
             if os.path.exists(os.path.expanduser(f'~/.aws/{filename}'))
@@ -946,7 +965,26 @@
         )
         subprocess_utils.handle_returncode(
             returncode,
             delete_image_cmd,
             error_msg=f'Failed to delete image {image_id!r} on {region}.',
             stderr=stderr,
             stream_logs=True)
+
+    @classmethod
+    def is_label_valid(cls, label_key: str,
+                       label_value: str) -> Tuple[bool, Optional[str]]:
+        key_regex = re.compile(r'^[^aws:][\S]{0,127}$')
+        value_regex = re.compile(r'^[\S]{0,255}$')
+        key_valid = bool(key_regex.match(label_key))
+        value_valid = bool(value_regex.match(label_value))
+        error_msg = None
+        if not key_valid:
+            error_msg = (f'Invalid tag key {label_key} for AWS. '
+                         'Key must start with any character except \'aws:\' '
+                         'and must be 128 characters or fewer in length.')
+        if not value_valid:
+            error_msg = (f'Invalid tag value {label_value} for AWS. '
+                         'Value must be 256 characters or fewer in length.')
+        if not key_valid or not value_valid:
+            return False, error_msg
+        return True, None
```

### Comparing `skypilot-0.5.0/sky/clouds/azure.py` & `skypilot-0.6.0/sky/clouds/azure.py`

 * *Files 4% similar despite different names*

```diff
@@ -33,14 +33,17 @@
     'clouds.config',
     'config',
     'msal_token_cache.json',
 ]
 
 _MAX_IDENTITY_FETCH_RETRY = 10
 
+_DEFAULT_AZURE_UBUNTU_HPC_IMAGE_GB = 30
+_DEFAULT_AZURE_UBUNTU_2004_IMAGE_GB = 150
+
 
 def _run_output(cmd):
     proc = subprocess.run(cmd,
                           shell=True,
                           check=True,
                           stderr=subprocess.PIPE,
                           stdout=subprocess.PIPE)
@@ -71,17 +74,14 @@
     @classmethod
     def _unsupported_features_for_resources(
         cls, resources: 'resources.Resources'
     ) -> Dict[clouds.CloudImplementationFeatures, str]:
         features = {
             clouds.CloudImplementationFeatures.CLONE_DISK_FROM_CLUSTER:
                 (f'Migrating disk is currently not supported on {cls._REPR}.'),
-            clouds.CloudImplementationFeatures.IMAGE_ID:
-                ('Specifying image ID is currently not supported on '
-                 f'{cls._REPR}.'),
         }
         if resources.use_spot:
             features[clouds.CloudImplementationFeatures.STOP] = (
                 'Stopping spot instances is currently not supported on'
                 f' {cls._REPR}.')
         return features
 
@@ -130,72 +130,92 @@
 
         if num_gigabytes > 1:
             cost += (num_gigabytes - 1) * 0.0875
 
         cost += 0.0
         return cost
 
-    def is_same_cloud(self, other):
-        return isinstance(other, Azure)
+    @classmethod
+    def get_image_size(cls, image_id: str, region: Optional[str]) -> float:
+        if region is None:
+            # The region used here is only for where to send the query,
+            # not the image location. Azure's image is globally available.
+            region = 'eastus'
+        is_skypilot_image_tag = False
+        if image_id.startswith('skypilot:'):
+            is_skypilot_image_tag = True
+            image_id = service_catalog.get_image_id_from_tag(image_id,
+                                                             clouds='azure')
+        image_id_splitted = image_id.split(':')
+        if len(image_id_splitted) != 4:
+            with ux_utils.print_exception_no_traceback():
+                raise ValueError(f'Invalid image id: {image_id}. Expected '
+                                 'format: <publisher>:<offer>:<sku>:<version>')
+        publisher, offer, sku, version = image_id_splitted
+        if is_skypilot_image_tag:
+            if offer == 'ubuntu-hpc':
+                return _DEFAULT_AZURE_UBUNTU_HPC_IMAGE_GB
+            else:
+                return _DEFAULT_AZURE_UBUNTU_2004_IMAGE_GB
+        compute_client = azure.get_client('compute', cls.get_project_id())
+        try:
+            image = compute_client.virtual_machine_images.get(
+                region, publisher, offer, sku, version)
+        except azure.exceptions().ResourceNotFoundError as e:
+            with ux_utils.print_exception_no_traceback():
+                raise ValueError(f'Image not found: {image_id}') from e
+        if image.os_disk_image is None:
+            with ux_utils.print_exception_no_traceback():
+                raise ValueError(f'Retrieve image size for {image_id} failed.')
+        ap = image.os_disk_image.additional_properties
+        size_in_gb = ap.get('sizeInGb')
+        if size_in_gb is not None:
+            return float(size_in_gb)
+        size_in_bytes = ap.get('sizeInBytes')
+        if size_in_bytes is None:
+            with ux_utils.print_exception_no_traceback():
+                raise ValueError(f'Retrieve image size for {image_id} failed. '
+                                 f'Got additional_properties: {ap}')
+        size_in_gb = size_in_bytes / (1024**3)
+        return size_in_gb
 
     @classmethod
     def get_default_instance_type(
             cls,
             cpus: Optional[str] = None,
             memory: Optional[str] = None,
             disk_tier: Optional[resources_utils.DiskTier] = None
     ) -> Optional[str]:
         return service_catalog.get_default_instance_type(cpus=cpus,
                                                          memory=memory,
                                                          disk_tier=disk_tier,
                                                          clouds='azure')
 
-    def _get_image_config(self, gen_version, instance_type):
-        # TODO(tian): images for Azure is not well organized. We should refactor
-        # it to images.csv like AWS.
-        # az vm image list \
-        #  --publisher microsoft-dsvm --all --output table
-        # nvidia-driver: 535.54.03, cuda: 12.2
-        # see: https://github.com/Azure/azhpc-images/releases/tag/ubuntu-hpc-20230803
-        # All A100 instances is of gen2, so it will always use
-        # the latest ubuntu-hpc:2204 image.
-        image_config = {
-            'image_publisher': 'microsoft-dsvm',
-            'image_offer': 'ubuntu-hpc',
-            'image_sku': '2204',
-            'image_version': '22.04.2023080201'
-        }
-
+    def _get_default_image_tag(self, gen_version, instance_type) -> str:
         # ubuntu-2004 v21.08.30, K80 requires image with old NVIDIA driver version
         acc = self.get_accelerators_from_instance_type(instance_type)
         if acc is not None:
             acc_name = list(acc.keys())[0]
             if acc_name == 'K80':
-                image_config = {
-                    'image_publisher': 'microsoft-dsvm',
-                    'image_offer': 'ubuntu-2004',
-                    'image_sku': '2004-gen2',
-                    'image_version': '21.08.30'
-                }
+                return 'skypilot:k80-ubuntu-2004'
 
         # ubuntu-2004 v21.11.04, the previous image we used in the past for
         # V1 HyperV instance before we change default image to ubuntu-hpc.
         # In Azure, all instances with K80 (Standard_NC series), some
         # instances with M60 (Standard_NV series) and some cpu instances
         # (Basic_A, Standard_D, ...) are V1 instance. For these instances,
         # we use the previous image.
         if gen_version == 'V1':
-            image_config = {
-                'image_publisher': 'microsoft-dsvm',
-                'image_offer': 'ubuntu-2004',
-                'image_sku': '2004',
-                'image_version': '21.11.04'
-            }
+            return 'skypilot:v1-ubuntu-2004'
 
-        return image_config
+        # nvidia-driver: 535.54.03, cuda: 12.2
+        # see: https://github.com/Azure/azhpc-images/releases/tag/ubuntu-hpc-20230803
+        # All A100 instances is of gen2, so it will always use
+        # the latest ubuntu-hpc:2204 image.
+        return 'skypilot:gpu-ubuntu-2204'
 
     @classmethod
     def regions_with_offering(cls, instance_type: str,
                               accelerators: Optional[Dict[str, int]],
                               use_spot: bool, region: Optional[str],
                               zone: Optional[str]) -> List[clouds.Region]:
         del accelerators  # unused
@@ -260,23 +280,46 @@
         assert zones is None, ('Azure does not support zones', zones)
 
         region_name = region.name
 
         r = resources
         # r.accelerators is cleared but .instance_type encodes the info.
         acc_dict = self.get_accelerators_from_instance_type(r.instance_type)
+        acc_count = None
         if acc_dict is not None:
             custom_resources = json.dumps(acc_dict, separators=(',', ':'))
+            acc_count = str(sum(acc_dict.values()))
         else:
             custom_resources = None
-        # pylint: disable=import-outside-toplevel
-        from sky.clouds.service_catalog import azure_catalog
-        gen_version = azure_catalog.get_gen_version_from_instance_type(
-            r.instance_type)
-        image_config = self._get_image_config(gen_version, r.instance_type)
+
+        if (resources.image_id is None or
+                resources.extract_docker_image() is not None):
+            # pylint: disable=import-outside-toplevel
+            from sky.clouds.service_catalog import azure_catalog
+            gen_version = azure_catalog.get_gen_version_from_instance_type(
+                r.instance_type)
+            image_id = self._get_default_image_tag(gen_version, r.instance_type)
+        else:
+            if None in resources.image_id:
+                image_id = resources.image_id[None]
+            else:
+                assert region_name in resources.image_id, resources.image_id
+                image_id = resources.image_id[region_name]
+        if image_id.startswith('skypilot:'):
+            image_id = service_catalog.get_image_id_from_tag(image_id,
+                                                             clouds='azure')
+        # Already checked in resources.py
+        publisher, offer, sku, version = image_id.split(':')
+        image_config = {
+            'image_publisher': publisher,
+            'image_offer': offer,
+            'image_sku': sku,
+            'image_version': version,
+        }
+
         # Setup commands to eliminate the banner and restart sshd.
         # This script will modify /etc/ssh/sshd_config and add a bash script
         # into .bashrc. The bash script will restart sshd if it has not been
         # restarted, identified by a file /tmp/__restarted is existing.
         # Also, add default user to docker group.
         # pylint: disable=line-too-long
         cloud_init_setup_commands = base64.b64encode(
@@ -315,14 +358,15 @@
                     return disk_tier
                 start_index += 1
             assert False, 'Low disk tier should always be supported on Azure.'
 
         return {
             'instance_type': r.instance_type,
             'custom_resources': custom_resources,
+            'num_gpus': acc_count,
             'use_spot': r.use_spot,
             'region': region_name,
             # Azure does not support specific zones.
             'zones': None,
             **image_config,
             'disk_tier': Azure._get_disk_type(_failover_disk_tier()),
             'cloud_init_setup_commands': cloud_init_setup_commands,
```

### Comparing `skypilot-0.5.0/sky/clouds/cloud.py` & `skypilot-0.6.0/sky/clouds/cloud.py`

 * *Files 2% similar despite different names*

```diff
@@ -37,14 +37,17 @@
     MULTI_NODE = 'multi-node'
     CLONE_DISK_FROM_CLUSTER = 'clone_disk_from_cluster'
     IMAGE_ID = 'image_id'
     DOCKER_IMAGE = 'docker_image'
     SPOT_INSTANCE = 'spot_instance'
     CUSTOM_DISK_TIER = 'custom_disk_tier'
     OPEN_PORTS = 'open_ports'
+    STORAGE_MOUNTING = 'storage_mounting'
+    HOST_CONTROLLERS = 'host_controllers'  # Can run jobs/serve controllers
+    AUTO_TERMINATE = 'auto_terminate'  # Pod/VM can stop or down itself
 
 
 class Region(collections.namedtuple('Region', ['name'])):
     """A region."""
     name: str
     zones: Optional[List['Zone']] = None
 
@@ -240,16 +243,16 @@
     def get_egress_cost(self, num_gigabytes: float):
         """Returns the egress cost.
 
         TODO: takes into account "per month" accumulation per account.
         """
         raise NotImplementedError
 
-    def is_same_cloud(self, other: 'Cloud'):
-        raise NotImplementedError
+    def is_same_cloud(self, other: 'Cloud') -> bool:
+        return isinstance(other, self.__class__)
 
     def make_deploy_resources_variables(
         self,
         resources: 'resources_lib.Resources',
         cluster_name_on_cloud: str,
         region: 'Region',
         zones: Optional[List['Zone']],
@@ -314,14 +317,33 @@
     @classmethod
     def is_image_tag_valid(cls, image_tag: str, region: Optional[str]) -> bool:
         """Validates that the image tag is valid for this cloud."""
         return service_catalog.is_image_tag_valid(image_tag,
                                                   region,
                                                   clouds=cls._REPR.lower())
 
+    @classmethod
+    def is_label_valid(cls, label_key: str,
+                       label_value: str) -> Tuple[bool, Optional[str]]:
+        """Validates that the label key and value are valid for this cloud.
+
+        Labels can be implemented in different ways across clouds. For example,
+        on AWS we use instance tags, on GCP we use labels, and on Kubernetes we
+        use labels. This method should be implemented to validate the label
+        format for the cloud.
+
+        Returns:
+            A tuple of a boolean indicating whether the label is valid and an
+            optional string describing the reason if the label is invalid.
+        """
+        # If a cloud does not support labels, they are ignored. Only clouds
+        # that support labels implement this method.
+        del label_key, label_value
+        return True, None
+
     def get_feasible_launchable_resources(
         self,
         resources: 'resources_lib.Resources',
         num_nodes: int = 1
     ) -> Tuple[List['resources_lib.Resources'], List[str]]:
         """Returns ([feasible and launchable resources], [fuzzy candidates]).
 
@@ -471,23 +493,24 @@
         Raises:
             ValueError: If region or zone is invalid or not supported.
         """
         return service_catalog.validate_region_zone(region,
                                                     zone,
                                                     clouds=self._REPR.lower())
 
-    def need_cleanup_after_preemption(
+    def need_cleanup_after_preemption_or_failure(
             self, resources: 'resources_lib.Resources') -> bool:
-        """Returns whether a spot resource needs cleanup after preeemption.
+        """Whether a resource needs cleanup after preeemption or failure.
 
         In most cases, spot resources do not need cleanup after preemption,
         as long as the cluster can be relaunched with the same name and tag,
         no matter the preemption behavior is to terminate or stop the cluster.
-        The only exception by far is GCP's Spot TPU VM. We override this method
-        in gcp.py.
+        Similar for on-demand resources that go into maintenance mode. The
+        only exception by far is GCP's TPU VM. We override this method in
+        gcp.py.
         """
         del resources
         return False
 
     @classmethod
     def check_features_are_supported(
             cls, resources: 'resources_lib.Resources',
@@ -740,10 +763,10 @@
         state = self.__dict__.copy()
         state.pop('PROVISIONER_VERSION', None)
         state.pop('STATUS_VERSION', None)
         return state
 
 
 # === Helper functions ===
-def cloud_in_list(cloud: Cloud, cloud_list: Iterable[Cloud]) -> bool:
+def cloud_in_iterable(cloud: Cloud, cloud_list: Iterable[Cloud]) -> bool:
     """Returns whether the cloud is in the given cloud list."""
     return any(cloud.is_same_cloud(c) for c in cloud_list)
```

### Comparing `skypilot-0.5.0/sky/clouds/cloud_registry.py` & `skypilot-0.6.0/sky/clouds/cloud_registry.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/clouds/cudo.py` & `skypilot-0.6.0/sky/clouds/cudo.py`

 * *Files 3% similar despite different names*

```diff
@@ -42,14 +42,23 @@
         'Install cudoctl and run the following commands:\n'
         f'{_INDENT_PREFIX}  $ cudoctl init\n'
         f'{_INDENT_PREFIX}For more info: '
         # pylint: disable=line-too-long
         'https://skypilot.readthedocs.io/en/latest/getting-started/installation.html'
     )
 
+    _PROJECT_HINT = (
+        'Create a project and then set it as the default project,:\n'
+        f'{_INDENT_PREFIX} $ cudoctl projects create my-project-name\n'
+        f'{_INDENT_PREFIX} $ cudoctl init\n'
+        f'{_INDENT_PREFIX}For more info: '
+        # pylint: disable=line-too-long
+        'https://skypilot.readthedocs.io/en/latest/getting-started/installation.html'
+    )
+
     _CLOUD_UNSUPPORTED_FEATURES = {
         clouds.CloudImplementationFeatures.STOP: 'Stopping not supported.',
         clouds.CloudImplementationFeatures.SPOT_INSTANCE:
             ('Spot is not supported, as Cudo API does not implement spot.'),
         clouds.CloudImplementationFeatures.CUSTOM_DISK_TIER:
             ('Custom disk tier is currently not supported on Cudo Compute'),
         clouds.CloudImplementationFeatures.IMAGE_ID:
@@ -151,18 +160,14 @@
         return 0.0
 
     def get_egress_cost(self, num_gigabytes: float) -> float:
         # Change if your cloud has egress cost. (You can do this later;
         # `return 0.0` is a good placeholder.)
         return 0.0
 
-    def is_same_cloud(self, other: clouds.Cloud) -> bool:
-        # Returns true if the two clouds are the same cloud type.
-        return isinstance(other, Cudo)
-
     @classmethod
     def get_default_instance_type(
             cls,
             cpus: Optional[str] = None,
             memory: Optional[str] = None,
             disk_tier: Optional[resources_utils.DiskTier] = None
     ) -> Optional[str]:
@@ -289,15 +294,17 @@
             return False, (
                 f'Application credentials are not set. '
                 f'{common_utils.format_exception(error, use_bracket=True)}')
 
         project_id, error = cudo_api.get_project_id()
         if error is not None:
             return False, (
-                f'Error getting project '
+                f'Default project is not set. '
+                f'{cls._PROJECT_HINT}\n'
+                f'{cls._INDENT_PREFIX}'
                 f'{common_utils.format_exception(error, use_bracket=True)}')
         try:
             api = cudo_api.virtual_machines()
             api.list_vms(project_id)
             return True, None
         except ApiException as e:
             return False, (
```

### Comparing `skypilot-0.5.0/sky/clouds/fluidstack.py` & `skypilot-0.6.0/sky/clouds/fluidstack.py`

 * *Files 1% similar despite different names*

```diff
@@ -46,17 +46,17 @@
             f' not supported in {_REPR}.',
         clouds.CloudImplementationFeatures.IMAGE_ID:
             'Specifying image ID '
             f'is not supported for {_REPR}.',
         clouds.CloudImplementationFeatures.CUSTOM_DISK_TIER:
             'Custom disk tiers'
             f' is not supported in {_REPR}.',
-        clouds.CloudImplementationFeatures.OPEN_PORTS:
-            'Opening ports'
-            f'is not supported in {_REPR}.',
+        clouds.CloudImplementationFeatures.HOST_CONTROLLERS:
+            'Host controllers'
+            f' are not supported in {_REPR}.',
     }
     # Using the latest SkyPilot provisioner API to provision and check status.
     PROVISIONER_VERSION = clouds.ProvisionerVersion.SKYPILOT
     STATUS_VERSION = clouds.StatusVersion.SKYPILOT
 
     @classmethod
     def _unsupported_features_for_resources(
@@ -136,18 +136,14 @@
 
     def get_egress_cost(self, num_gigabytes: float) -> float:
         return 0.0
 
     def __repr__(self):
         return 'Fluidstack'
 
-    def is_same_cloud(self, other: clouds.Cloud) -> bool:
-        # Returns true if the two clouds are the same cloud type.
-        return isinstance(other, Fluidstack)
-
     @classmethod
     def get_default_instance_type(
             cls,
             cpus: Optional[str] = None,
             memory: Optional[str] = None,
             disk_tier: Optional[DiskTier] = None) -> Optional[str]:
         return service_catalog.get_default_instance_type(cpus=cpus,
@@ -300,15 +296,15 @@
         return service_catalog.validate_region_zone(region,
                                                     zone,
                                                     clouds='fluidstack')
 
     @classmethod
     def default_username(cls, region: str) -> str:
         return {
-            'norway_2_eu': 'fsuser',
+            'norway_2_eu': 'ubuntu',
             'calgary_1_canada': 'ubuntu',
             'norway_3_eu': 'ubuntu',
             'norway_4_eu': 'ubuntu',
             'india_2': 'root',
             'nevada_1_usa': 'fsuser',
             'generic_1_canada': 'ubuntu',
             'iceland_1_eu': 'ubuntu',
```

### Comparing `skypilot-0.5.0/sky/clouds/gcp.py` & `skypilot-0.6.0/sky/clouds/gcp.py`

 * *Files 3% similar despite different names*

```diff
@@ -311,17 +311,14 @@
         if num_gigabytes <= 1024:
             return 0.12 * num_gigabytes
         elif num_gigabytes <= 1024 * 10:
             return 0.11 * num_gigabytes
         else:
             return 0.08 * num_gigabytes
 
-    def is_same_cloud(self, other):
-        return isinstance(other, GCP)
-
     @classmethod
     def _is_machine_image(cls, image_id: str) -> bool:
         find_machine = re.match(r'projects/.*/.*/machineImages/.*', image_id)
         return find_machine is not None
 
     @classmethod
     @functools.lru_cache(maxsize=1)
@@ -441,30 +438,32 @@
                 resources_vars['tpu_node_name'] = r.accelerator_args.get(
                     'tpu_name')
             else:
                 # Convert to GCP names:
                 # https://cloud.google.com/compute/docs/gpus
                 if acc in ('A100-80GB', 'L4'):
                     # A100-80GB and L4 have a different name pattern.
-                    resources_vars['gpu'] = 'nvidia-{}'.format(acc.lower())
+                    resources_vars['gpu'] = f'nvidia-{acc.lower()}'
+                elif acc == 'H100':
+                    resources_vars['gpu'] = f'nvidia-{acc.lower()}-80gb'
                 else:
                     resources_vars['gpu'] = 'nvidia-tesla-{}'.format(
                         acc.lower())
                 resources_vars['gpu_count'] = acc_count
                 if acc == 'K80':
                     # Though the image is called cu113, it actually has later
                     # versions of CUDA as noted below.
                     # CUDA driver version 470.57.02, CUDA Library 11.4
                     image_id = 'skypilot:k80-debian-10'
                 else:
                     # CUDA driver version 535.86.10, CUDA Library 12.2
                     image_id = 'skypilot:gpu-debian-11'
 
-        if resources.image_id is not None and resources.extract_docker_image(
-        ) is None:
+        if (resources.image_id is not None and
+                resources.extract_docker_image() is None):
             if None in resources.image_id:
                 image_id = resources.image_id[None]
             else:
                 assert region_name in resources.image_id, resources.image_id
                 image_id = resources.image_id[region_name]
         if image_id.startswith('skypilot:'):
             image_id = service_catalog.get_image_id_from_tag(image_id,
@@ -737,21 +736,21 @@
 
         # pylint: disable=import-outside-toplevel,unused-import
         import google.auth
         import googleapiclient.discovery
 
         # This takes user's credential info from "~/.config/gcloud/application_default_credentials.json".  # pylint: disable=line-too-long
         credentials, project = google.auth.default()
-        service = googleapiclient.discovery.build('cloudresourcemanager',
-                                                  'v1',
-                                                  credentials=credentials)
+        crm = googleapiclient.discovery.build('cloudresourcemanager',
+                                              'v1',
+                                              credentials=credentials)
         gcp_minimal_permissions = gcp_utils.get_minimal_permissions()
         permissions = {'permissions': gcp_minimal_permissions}
-        request = service.projects().testIamPermissions(resource=project,
-                                                        body=permissions)
+        request = crm.projects().testIamPermissions(resource=project,
+                                                    body=permissions)
         ret_permissions = request.execute().get('permissions', [])
 
         diffs = set(gcp_minimal_permissions).difference(set(ret_permissions))
         if len(diffs) > 0:
             identity_str = identity[0] if identity else None
             return False, (
                 'The following permissions are not enabled for the current '
@@ -835,21 +834,22 @@
         if user_identity is None:
             return None
         return user_identity[0].replace('\n', '')
 
     def instance_type_exists(self, instance_type):
         return service_catalog.instance_type_exists(instance_type, 'gcp')
 
-    def need_cleanup_after_preemption(self,
-                                      resources: 'resources.Resources') -> bool:
-        """Returns whether a spot resource needs cleanup after preeemption."""
+    def need_cleanup_after_preemption_or_failure(
+            self, resources: 'resources.Resources') -> bool:
+        """Whether a resource needs cleanup after preeemption or failure."""
         # Spot TPU VMs require manual cleanup after preemption.
         # "If your Cloud TPU is preempted,
         # you must delete it and create a new one ..."
         # See: https://cloud.google.com/tpu/docs/preemptible#tpu-vm
+        # On-demand TPU VMs are likely to require manual cleanup as well.
 
         return gcp_utils.is_tpu_vm(resources)
 
     @classmethod
     def get_project_id(cls, dryrun: bool = False) -> str:
         if dryrun:
             return 'dryrun-project-id'
@@ -1063,7 +1063,29 @@
         )
         subprocess_utils.handle_returncode(
             returncode,
             delete_image_cmd,
             error_msg=f'Failed to delete image {image_name!r}',
             stderr=stderr,
             stream_logs=True)
+
+    @classmethod
+    def is_label_valid(cls, label_key: str,
+                       label_value: str) -> Tuple[bool, Optional[str]]:
+        key_regex = re.compile(r'^[a-z]([a-z0-9_-]{0,62})?$')
+        value_regex = re.compile(r'^[a-z0-9_-]{0,63}$')
+        key_valid = bool(key_regex.match(label_key))
+        value_valid = bool(value_regex.match(label_value))
+        error_msg = None
+        condition_msg = ('can include lowercase alphanumeric characters, '
+                         'dashes, and underscores, with a total length of 63 '
+                         'characters or less.')
+        if not key_valid:
+            error_msg = (f'Invalid label key {label_key} for GCP. '
+                         f'Key must start with a lowercase letter '
+                         f'and {condition_msg}')
+        if not value_valid:
+            error_msg = (f'Invalid label value {label_value} for GCP. Value '
+                         f'{condition_msg}')
+        if not key_valid or not value_valid:
+            return False, error_msg
+        return True, None
```

### Comparing `skypilot-0.5.0/sky/clouds/ibm.py` & `skypilot-0.6.0/sky/clouds/ibm.py`

 * *Files 1% similar despite different names*

```diff
@@ -161,17 +161,14 @@
         for price_threshold in price_thresholds:
             # pylint: disable=line-too-long
             cost += (num_gigabytes - price_threshold['threshold']
                     ) * price_threshold['price_per_gb']
             num_gigabytes -= (num_gigabytes - price_threshold['threshold'])
         return cost
 
-    def is_same_cloud(self, other):
-        return isinstance(other, IBM)
-
     def make_deploy_resources_variables(
         self,
         resources: 'resources_lib.Resources',
         cluster_name_on_cloud: str,
         region: 'clouds.Region',
         zones: Optional[List['clouds.Zone']],
         dryrun: bool = False,
```

### Comparing `skypilot-0.5.0/sky/clouds/kubernetes.py` & `skypilot-0.6.0/sky/clouds/kubernetes.py`

 * *Files 16% similar despite different names*

```diff
@@ -1,53 +1,61 @@
 """Kubernetes."""
 import json
 import os
+import re
 import typing
 from typing import Dict, Iterator, List, Optional, Tuple
 
 from sky import clouds
 from sky import sky_logging
+from sky import skypilot_config
 from sky.adaptors import kubernetes
 from sky.clouds import service_catalog
 from sky.provision.kubernetes import network_utils
 from sky.provision.kubernetes import utils as kubernetes_utils
 from sky.utils import common_utils
 from sky.utils import resources_utils
+from sky.utils import schemas
 
 if typing.TYPE_CHECKING:
     # Renaming to avoid shadowing variables.
     from sky import resources as resources_lib
 
 logger = sky_logging.init_logger(__name__)
 
 # Check if KUBECONFIG is set, and use it if it is.
 DEFAULT_KUBECONFIG_PATH = '~/.kube/config'
 CREDENTIAL_PATH = os.environ.get('KUBECONFIG', DEFAULT_KUBECONFIG_PATH)
 
+# Namespace for SkyPilot resources shared across multiple tenants on the
+# same cluster (even if they might be running in different namespaces).
+# E.g., FUSE device manager daemonset is run in this namespace.
+_SKYPILOT_SYSTEM_NAMESPACE = 'skypilot-system'
+
 
 @clouds.CLOUD_REGISTRY.register
 class Kubernetes(clouds.Cloud):
     """Kubernetes."""
 
     SKY_SSH_KEY_SECRET_NAME = 'sky-ssh-keys'
-    SKY_SSH_KEY_SECRET_FIELD_NAME = \
-        f'ssh-publickey-{common_utils.get_user_hash()}'
     SKY_SSH_JUMP_NAME = 'sky-ssh-jump-pod'
     PORT_FORWARD_PROXY_CMD_TEMPLATE = \
         'kubernetes-port-forward-proxy-command.sh.j2'
     PORT_FORWARD_PROXY_CMD_PATH = '~/.sky/port-forward-proxy-cmd.sh'
     # Timeout for resource provisioning. This timeout determines how long to
     # wait for pod to be in pending status before giving up.
     # Larger timeout may be required for autoscaling clusters, since autoscaler
     # may take some time to provision new nodes.
     # Note that this timeout includes time taken by the Kubernetes scheduler
     # itself, which can be upto 2-3 seconds.
     # For non-autoscaling clusters, we conservatively set this to 10s.
-    # TODO(romilb): Make the timeout configurable.
-    TIMEOUT = 10
+    timeout = skypilot_config.get_nested(['kubernetes', 'provision_timeout'],
+                                         10)
+
+    _SUPPORTS_SERVICE_ACCOUNT_ON_REMOTE = True
 
     _DEFAULT_NUM_VCPUS = 2
     _DEFAULT_MEMORY_CPU_RATIO = 1
     _DEFAULT_MEMORY_CPU_RATIO_WITH_GPU = 4  # Allocate more memory for GPU tasks
     _REPR = 'Kubernetes'
     _SINGLETON_REGION = 'kubernetes'
     _regions: List[clouds.Region] = [clouds.Region(_SINGLETON_REGION)]
@@ -68,29 +76,36 @@
 
     IMAGE_CPU = 'skypilot:cpu-ubuntu-2004'
     IMAGE_GPU = 'skypilot:gpu-ubuntu-2004'
 
     PROVISIONER_VERSION = clouds.ProvisionerVersion.SKYPILOT
     STATUS_VERSION = clouds.StatusVersion.SKYPILOT
 
+    @property
+    def ssh_key_secret_field_name(self):
+        # Use a fresh user hash to avoid conflicts in the secret object naming.
+        # This can happen when the controller is reusing the same user hash
+        # through USER_ID_ENV_VAR but has a different SSH key.
+        fresh_user_hash = common_utils.get_user_hash(force_fresh_hash=True)
+        return f'ssh-publickey-{fresh_user_hash}'
+
     @classmethod
     def _unsupported_features_for_resources(
         cls, resources: 'resources_lib.Resources'
     ) -> Dict[clouds.CloudImplementationFeatures, str]:
         unsupported_features = cls._CLOUD_UNSUPPORTED_FEATURES
-        curr_context = kubernetes_utils.get_current_kube_config_context_name()
-        if curr_context == kubernetes_utils.KIND_CONTEXT_NAME:
-            # If we are using KIND, the loadbalancer service will never be
-            # assigned an external IP. Users may use ingress, but that requires
-            # blocking HTTP port 80.
-            # For now, we disable port opening feature on kind clusters.
+        is_exec_auth, message = kubernetes_utils.is_kubeconfig_exec_auth()
+        if is_exec_auth:
+            assert isinstance(message, str), message
+            # Controllers cannot spin up new pods with exec auth.
+            unsupported_features[
+                clouds.CloudImplementationFeatures.HOST_CONTROLLERS] = message
+            # Pod does not have permissions to terminate itself with exec auth.
             unsupported_features[
-                clouds.CloudImplementationFeatures.OPEN_PORTS] = (
-                    'Opening ports is not supported in Kubernetes when '
-                    'using local kind cluster.')
+                clouds.CloudImplementationFeatures.AUTO_TERMINATE] = message
         return unsupported_features
 
     @classmethod
     def regions(cls) -> List[clouds.Region]:
         return cls._regions
 
     @classmethod
@@ -121,17 +136,14 @@
 
     def get_egress_cost(self, num_gigabytes: float) -> float:
         return 0.0
 
     def __repr__(self):
         return self._REPR
 
-    def is_same_cloud(self, other: clouds.Cloud) -> bool:
-        return isinstance(other, Kubernetes)
-
     @classmethod
     def get_port(cls, svc_name) -> int:
         ns = kubernetes_utils.get_current_kube_config_context_namespace()
         return kubernetes_utils.get_port(svc_name, ns)
 
     @classmethod
     def get_default_instance_type(
@@ -142,16 +154,23 @@
         # TODO(romilb): In the future, we may want to move the instance type
         #  selection + availability checking to a kubernetes_catalog module.
         del disk_tier  # Unused.
         # We strip '+' from resource requests since Kubernetes can provision
         # exactly the requested resources.
         instance_cpus = float(
             cpus.strip('+')) if cpus is not None else cls._DEFAULT_NUM_VCPUS
-        instance_mem = float(memory.strip('+')) if memory is not None else \
-            instance_cpus * cls._DEFAULT_MEMORY_CPU_RATIO
+        if memory is not None:
+            if memory.endswith('+'):
+                instance_mem = float(memory[:-1])
+            elif memory.endswith('x'):
+                instance_mem = float(memory[:-1]) * instance_cpus
+            else:
+                instance_mem = float(memory)
+        else:
+            instance_mem = instance_cpus * cls._DEFAULT_MEMORY_CPU_RATIO
         virtual_instance_type = kubernetes_utils.KubernetesInstanceType(
             instance_cpus, instance_mem).name
         return virtual_instance_type
 
     @classmethod
     def get_accelerators_from_instance_type(
         cls,
@@ -246,31 +265,56 @@
         # If GPUs are requested, set node label to match the GPU type.
         if acc_count > 0 and acc_type is not None:
             k8s_acc_label_key, k8s_acc_label_value = \
                 kubernetes_utils.get_gpu_label_key_value(acc_type)
 
         port_mode = network_utils.get_port_mode(None)
 
+        remote_identity = skypilot_config.get_nested(
+            ('kubernetes', 'remote_identity'),
+            schemas.get_default_remote_identity('kubernetes'))
+        if (remote_identity ==
+                schemas.RemoteIdentityOptions.LOCAL_CREDENTIALS.value):
+            # SA name doesn't matter since automounting credentials is disabled
+            k8s_service_account_name = 'default'
+            k8s_automount_sa_token = 'false'
+        elif (remote_identity ==
+              schemas.RemoteIdentityOptions.SERVICE_ACCOUNT.value):
+            # Use the default service account
+            k8s_service_account_name = (
+                kubernetes_utils.DEFAULT_SERVICE_ACCOUNT_NAME)
+            k8s_automount_sa_token = 'true'
+        else:
+            # User specified a custom service account
+            k8s_service_account_name = remote_identity
+            k8s_automount_sa_token = 'true'
+
+        fuse_device_required = bool(resources.requires_fuse)
+
         deploy_vars = {
             'instance_type': resources.instance_type,
             'custom_resources': custom_resources,
             'region': region.name,
             'cpus': str(cpus),
             'memory': str(mem),
             'accelerator_count': str(acc_count),
-            'timeout': str(self.TIMEOUT),
+            'timeout': str(self.timeout),
             'k8s_namespace':
                 kubernetes_utils.get_current_kube_config_context_namespace(),
             'k8s_port_mode': port_mode.value,
             'k8s_ssh_key_secret_name': self.SKY_SSH_KEY_SECRET_NAME,
             'k8s_acc_label_key': k8s_acc_label_key,
             'k8s_acc_label_value': k8s_acc_label_value,
             'k8s_ssh_jump_name': self.SKY_SSH_JUMP_NAME,
             'k8s_ssh_jump_image': ssh_jump_image,
-            # TODO(romilb): Allow user to specify custom images
+            'k8s_service_account_name': k8s_service_account_name,
+            'k8s_automount_sa_token': k8s_automount_sa_token,
+            'k8s_fuse_device_required': fuse_device_required,
+            # Namespace to run the FUSE device manager in
+            'k8s_skypilot_system_namespace': _SKYPILOT_SYSTEM_NAMESPACE,
             'image_id': image_id,
         }
 
         return deploy_vars
 
     def _get_feasible_launchable_resources(
         self, resources: 'resources_lib.Resources'
@@ -318,38 +362,40 @@
                                resources.memory is not None else gpu_task_cpus *
                                self._DEFAULT_MEMORY_CPU_RATIO_WITH_GPU)
             chosen_instance_type = (
                 kubernetes_utils.KubernetesInstanceType.from_resources(
                     gpu_task_cpus, gpu_task_memory, acc_count, acc_type).name)
 
         # Check if requested instance type will fit in the cluster.
-        # TODO(romilb): This will fail early for autoscaling clusters.
-        fits, reason = kubernetes_utils.check_instance_fits(
-            chosen_instance_type)
-        if not fits:
-            logger.debug(f'Instance type {chosen_instance_type} does '
-                         'not fit in the Kubernetes cluster. '
-                         f'Reason: {reason}')
-            return [], []
+        autoscaler_type = kubernetes_utils.get_autoscaler_type()
+        if autoscaler_type is None:
+            # If autoscaler is not set, check if the instance type fits in the
+            # cluster. Else, rely on the autoscaler to provision the right
+            # instance type without running checks. Worst case, if autoscaling
+            # fails, the pod will be stuck in pending state until
+            # provision_timeout, after which failover will be triggered.
+            fits, reason = kubernetes_utils.check_instance_fits(
+                chosen_instance_type)
+            if not fits:
+                logger.debug(f'Instance type {chosen_instance_type} does '
+                             'not fit in the Kubernetes cluster. '
+                             f'Reason: {reason}')
+                return [], []
 
         # No fuzzy lists for Kubernetes
         return _make([chosen_instance_type]), []
 
     @classmethod
     def check_credentials(cls) -> Tuple[bool, Optional[str]]:
-        if os.path.exists(os.path.expanduser(CREDENTIAL_PATH)):
-            # Test using python API
-            try:
-                return kubernetes_utils.check_credentials()
-            except Exception as e:  # pylint: disable=broad-except
-                return (False, 'Credential check failed: '
-                        f'{common_utils.format_exception(e)}')
-        else:
-            return (False, 'Credentials not found - '
-                    f'check if {CREDENTIAL_PATH} exists.')
+        # Test using python API
+        try:
+            return kubernetes_utils.check_credentials()
+        except Exception as e:  # pylint: disable=broad-except
+            return (False, 'Credential check failed: '
+                    f'{common_utils.format_exception(e)}')
 
     def get_credential_file_mounts(self) -> Dict[str, str]:
         if os.path.exists(os.path.expanduser(CREDENTIAL_PATH)):
             # Upload kubeconfig to the default path to avoid having to set
             # KUBECONFIG in the environment.
             return {DEFAULT_KUBECONFIG_PATH: CREDENTIAL_PATH}
         else:
@@ -367,20 +413,50 @@
         if zone is not None:
             raise ValueError('Kubernetes support does not support setting zone.'
                              ' Cluster used is determined by the kubeconfig.')
         return region, zone
 
     @classmethod
     def get_current_user_identity(cls) -> Optional[List[str]]:
-        k8s = kubernetes.get_kubernetes()
+        k8s = kubernetes.kubernetes
         try:
             _, current_context = k8s.config.list_kube_config_contexts()
             if 'namespace' in current_context['context']:
                 namespace = current_context['context']['namespace']
             else:
                 namespace = kubernetes_utils.DEFAULT_NAMESPACE
 
             user = current_context['context']['user']
             cluster = current_context['context']['cluster']
             return [f'{cluster}_{user}_{namespace}']
         except k8s.config.config_exception.ConfigException:
             return None
+
+    @classmethod
+    def is_label_valid(cls, label_key: str,
+                       label_value: str) -> Tuple[bool, Optional[str]]:
+        # Kubernetes labels can be of the format <domain>/<key>: <value>
+        key_regex = re.compile(
+            # Look-ahead to ensure proper domain formatting up to a slash
+            r'^(?:(?=[a-z0-9]([-a-z0-9.]*[a-z0-9])?\/)'
+            # Match domain: starts and ends with alphanum up to 253 chars
+            # including a slash in the domain.
+            r'[a-z0-9]([-a-z0-9.]{0,251}[a-z0-9])?\/)?'
+            # Match key: starts and ends with alphanum, upto to 63 chars.
+            r'[a-z0-9]([-a-z0-9_.]{0,61}[a-z0-9])?$')
+        value_regex = re.compile(
+            r'^([a-zA-Z0-9]([-a-zA-Z0-9_.]{0,61}[a-zA-Z0-9])?)?$')
+        key_valid = bool(key_regex.match(label_key))
+        value_valid = bool(value_regex.match(label_value))
+        error_msg = None
+        condition_msg = ('Value must consist of alphanumeric characters or '
+                         '\'-\', \'_\', \'.\', and must be no more than 63 '
+                         'characters in length.')
+        if not key_valid:
+            error_msg = (f'Invalid label key {label_key} for Kubernetes. '
+                         f'{condition_msg}')
+        if not value_valid:
+            error_msg = (f'Invalid label value {label_value} for Kubernetes. '
+                         f'{condition_msg}')
+        if not key_valid or not value_valid:
+            return False, error_msg
+        return True, None
```

### Comparing `skypilot-0.5.0/sky/clouds/lambda_cloud.py` & `skypilot-0.6.0/sky/clouds/lambda_cloud.py`

 * *Files 2% similar despite different names*

```diff
@@ -41,14 +41,15 @@
             f'Docker image is currently not supported on {_REPR}. '
             'You can try running docker command inside the `run` section in task.yaml.'
         ),
         clouds.CloudImplementationFeatures.SPOT_INSTANCE: f'Spot instances are not supported in {_REPR}.',
         clouds.CloudImplementationFeatures.IMAGE_ID: f'Specifying image ID is not supported in {_REPR}.',
         clouds.CloudImplementationFeatures.CUSTOM_DISK_TIER: f'Custom disk tiers are not supported in {_REPR}.',
         clouds.CloudImplementationFeatures.OPEN_PORTS: f'Opening ports is currently not supported on {_REPR}.',
+        clouds.CloudImplementationFeatures.HOST_CONTROLLERS: f'Host controllers are not supported in {_REPR}.',
     }
 
     @classmethod
     def _unsupported_features_for_resources(
         cls, resources: 'resources_lib.Resources'
     ) -> Dict[clouds.CloudImplementationFeatures, str]:
         del resources  # unused
@@ -116,18 +117,14 @@
 
     def get_egress_cost(self, num_gigabytes: float) -> float:
         return 0.0
 
     def __repr__(self):
         return 'Lambda'
 
-    def is_same_cloud(self, other: clouds.Cloud) -> bool:
-        # Returns true if the two clouds are the same cloud type.
-        return isinstance(other, Lambda)
-
     @classmethod
     def get_default_instance_type(
             cls,
             cpus: Optional[str] = None,
             memory: Optional[str] = None,
             disk_tier: Optional[resources_utils.DiskTier] = None
     ) -> Optional[str]:
@@ -276,14 +273,15 @@
     def query_status(cls, name: str, tag_filters: Dict[str, str],
                      region: Optional[str], zone: Optional[str],
                      **kwargs) -> List[status_lib.ClusterStatus]:
         status_map = {
             'booting': status_lib.ClusterStatus.INIT,
             'active': status_lib.ClusterStatus.UP,
             'unhealthy': status_lib.ClusterStatus.INIT,
+            'terminating': None,
             'terminated': None,
         }
         # TODO(ewzeng): filter by hash_filter_string to be safe
         status_list = []
         vms = lambda_utils.LambdaCloudClient().list_instances()
         possible_names = [f'{name}-head', f'{name}-worker']
         for node in vms:
```

### Comparing `skypilot-0.5.0/sky/clouds/oci.py` & `skypilot-0.6.0/sky/clouds/oci.py`

 * *Files 1% similar despite different names*

```diff
@@ -23,15 +23,15 @@
 
 if typing.TYPE_CHECKING:
     # Renaming to avoid shadowing variables.
     from sky import resources as resources_lib
 
 logger = logging.getLogger(__name__)
 
-_tenancy_prefix = None
+_tenancy_prefix: Optional[str] = None
 
 
 @clouds.CLOUD_REGISTRY.register
 class OCI(clouds.Cloud):
     """OCI: Oracle Cloud Infrastructure """
 
     _REPR = 'OCI'
@@ -156,18 +156,14 @@
         # elif region in REGIONS_MidEast_Africa:
         #     return (num_gigabytes - 10 * 1024) * 0.05
         # else:
         #     logger.debug(f"* ! Region {region} is not listed for cost calc!")
         #     return 0.0
         return (num_gigabytes - 10 * 1024) * 0.0085
 
-    def is_same_cloud(self, other: clouds.Cloud) -> bool:
-        # Returns true if the two clouds are the same cloud type.
-        return isinstance(other, OCI)
-
     @classmethod
     def get_default_instance_type(
             cls,
             cpus: Optional[str] = None,
             memory: Optional[str] = None,
             disk_tier: Optional[resources_utils.DiskTier] = None
     ) -> Optional[str]:
@@ -265,16 +261,16 @@
                 ad_list = identity_client.list_availability_domains(
                     compartment_id=oci_adaptor.get_oci_config(
                         profile=oci_utils.oci_config.get_profile())
                     ['tenancy']).data
 
                 first_ad = ad_list[0]
                 _tenancy_prefix = str(first_ad.name).split(':', maxsplit=1)[0]
-            except (oci_adaptor.get_oci().exceptions.ConfigFileNotFound,
-                    oci_adaptor.get_oci().exceptions.InvalidConfig) as e:
+            except (oci_adaptor.oci.exceptions.ConfigFileNotFound,
+                    oci_adaptor.oci.exceptions.InvalidConfig) as e:
                 # This should only happen in testing where oci config is
                 # monkeypatched. In real use, if the OCI config is not
                 # valid, the 'sky check' would fail (OCI disabled).
                 logger.debug(f'It is OK goes here when testing: {str(e)}')
                 pass
 
         # Disk performane: Volume Performance Units.
@@ -399,16 +395,16 @@
                 region=None,
                 profile=oci_utils.oci_config.get_profile()).get_user(
                     oci_adaptor.get_oci_config(profile=oci_utils.oci_config.
                                                get_profile())['user']).data
             del user
             # TODO[Hysun]: More privilege check can be added
             return True, None
-        except (oci_adaptor.get_oci().exceptions.ConfigFileNotFound,
-                oci_adaptor.get_oci().exceptions.InvalidConfig,
+        except (oci_adaptor.oci.exceptions.ConfigFileNotFound,
+                oci_adaptor.oci.exceptions.InvalidConfig,
                 oci_adaptor.service_exception()) as e:
             return False, (
                 f'OCI credential is not correctly set. '
                 f'Check the credential file at {conf_file}\n'
                 f'{cls._INDENT_PREFIX}{credential_help_str}\n'
                 f'{cls._INDENT_PREFIX}Error details: '
                 f'{common_utils.format_exception(e, use_bracket=True)}')
```

### Comparing `skypilot-0.5.0/sky/clouds/runpod.py` & `skypilot-0.6.0/sky/clouds/runpod.py`

 * *Files 2% similar despite different names*

```diff
@@ -34,15 +34,21 @@
             ('Opening ports is not '
              'supported yet on RunPod.'),
         clouds.CloudImplementationFeatures.IMAGE_ID:
             ('Specifying image ID is not supported on RunPod.'),
         clouds.CloudImplementationFeatures.DOCKER_IMAGE:
             (f'Docker image is currently not supported on {_REPR}.'),
         clouds.CloudImplementationFeatures.CUSTOM_DISK_TIER:
-            ('Customizing disk tier is not supported yet on RunPod.')
+            ('Customizing disk tier is not supported yet on RunPod.'),
+        clouds.CloudImplementationFeatures.STORAGE_MOUNTING:
+            ('Mounting object stores is not supported on RunPod. To read data '
+             'from object stores on RunPod, use `mode: COPY` to copy the data '
+             'to local disk.'),
+        clouds.CloudImplementationFeatures.HOST_CONTROLLERS:
+            ('Host controllers are not supported on RunPod.'),
     }
     _MAX_CLUSTER_NAME_LEN_LIMIT = 120
     _regions: List[clouds.Region] = []
 
     PROVISIONER_VERSION = clouds.ProvisionerVersion.SKYPILOT
     STATUS_VERSION = clouds.StatusVersion.SKYPILOT
 
@@ -130,18 +136,14 @@
         """Returns the hourly cost of the accelerators, in dollars/hour."""
         del accelerators, use_spot, region, zone  # unused
         return 0.0  # RunPod includes accelerators in the hourly cost.
 
     def get_egress_cost(self, num_gigabytes: float) -> float:
         return 0.0
 
-    def is_same_cloud(self, other: clouds.Cloud) -> bool:
-        # Returns true if the two clouds are the same cloud type.
-        return isinstance(other, RunPod)
-
     @classmethod
     def get_default_instance_type(
             cls,
             cpus: Optional[str] = None,
             memory: Optional[str] = None,
             disk_tier: Optional[resources_utils.DiskTier] = None
     ) -> Optional[str]:
```

### Comparing `skypilot-0.5.0/sky/clouds/scp.py` & `skypilot-0.6.0/sky/clouds/scp.py`

 * *Files 1% similar despite different names*

```diff
@@ -140,18 +140,14 @@
         del accelerators, use_spot, region, zone  # unused
         # SCP includes accelerators as part of the instance type.
         return 0.0
 
     def get_egress_cost(self, num_gigabytes: float) -> float:
         return 0.0
 
-    def is_same_cloud(self, other: clouds.Cloud) -> bool:
-        # Returns true if the two clouds are the same cloud type.
-        return isinstance(other, SCP)
-
     @classmethod
     def get_default_instance_type(
             cls,
             cpus: Optional[str] = None,
             memory: Optional[str] = None,
             disk_tier: Optional[resources_utils.DiskTier] = None
     ) -> Optional[str]:
```

### Comparing `skypilot-0.5.0/sky/clouds/service_catalog/__init__.py` & `skypilot-0.6.0/sky/clouds/service_catalog/__init__.py`

 * *Files 10% similar despite different names*

```diff
@@ -1,26 +1,25 @@
 """Service catalog."""
 import collections
 import importlib
 import typing
 from typing import Dict, List, Optional, Set, Tuple, Union
 
 from sky.clouds.service_catalog.config import fallback_to_default_catalog
+from sky.clouds.service_catalog.constants import ALL_CLOUDS
+from sky.clouds.service_catalog.constants import CATALOG_DIR
 from sky.clouds.service_catalog.constants import CATALOG_SCHEMA_VERSION
 from sky.clouds.service_catalog.constants import HOSTED_CATALOG_DIR_URL
-from sky.clouds.service_catalog.constants import LOCAL_CATALOG_DIR
 from sky.utils import resources_utils
 
 if typing.TYPE_CHECKING:
     from sky.clouds import cloud
     from sky.clouds.service_catalog import common
 
 CloudFilter = Optional[Union[List[str], str]]
-ALL_CLOUDS = ('aws', 'azure', 'gcp', 'ibm', 'lambda', 'scp', 'oci',
-              'kubernetes', 'runpod', 'vsphere', 'cudo', 'fluidstack')
 
 
 def _map_clouds_catalog(clouds: CloudFilter, method_name: str, *args, **kwargs):
     if clouds is None:
         clouds = list(ALL_CLOUDS)
 
         # TODO(hemil): Remove this once the common service catalog
@@ -114,14 +113,54 @@
                 accelerator_counts[gpu].add(item.accelerator_count)
     ret: Dict[str, List[int]] = {}
     for gpu, counts in accelerator_counts.items():
         ret[gpu] = sorted(counts)
     return ret
 
 
+def list_accelerator_realtime(
+    gpus_only: bool = True,
+    name_filter: Optional[str] = None,
+    region_filter: Optional[str] = None,
+    quantity_filter: Optional[int] = None,
+    clouds: CloudFilter = None,
+    case_sensitive: bool = True,
+) -> Tuple[Dict[str, List[int]], Dict[str, int], Dict[str, int]]:
+    """List all accelerators offered by Sky with their realtime availability.
+
+    Realtime availability is the total number of accelerators in the cluster
+    and number of accelerators available at the time of the call.
+
+    Used for fixed size cluster settings, such as Kubernetes.
+
+    Returns:
+        A tuple of three dictionaries mapping canonical accelerator names to:
+        - A list of available counts. (e.g., [1, 2, 4])
+        - Total number of accelerators in the cluster (capacity).
+        - Number of accelerators available at the time of call (availability).
+    """
+    qtys_map, total_accelerators_capacity, total_accelerators_available = (
+        _map_clouds_catalog(clouds,
+                            'list_accelerators_realtime',
+                            gpus_only,
+                            name_filter,
+                            region_filter,
+                            quantity_filter,
+                            case_sensitive=case_sensitive,
+                            all_regions=False,
+                            require_price=False))
+    accelerator_counts: Dict[str, List[int]] = collections.defaultdict(list)
+    for gpu, items in qtys_map.items():
+        for item in items:
+            accelerator_counts[gpu].append(item.accelerator_count)
+        accelerator_counts[gpu] = sorted(accelerator_counts[gpu])
+    return (accelerator_counts, total_accelerators_capacity,
+            total_accelerators_available)
+
+
 def instance_type_exists(instance_type: str,
                          clouds: CloudFilter = None) -> bool:
     """Check the existence of a instance type."""
     return _map_clouds_catalog(clouds, 'instance_type_exists', instance_type)
 
 
 def validate_region_zone(
@@ -332,11 +371,12 @@
     'get_tpus',
     # Images
     'get_image_id_from_tag',
     'is_image_tag_valid',
     # Configuration
     'fallback_to_default_catalog',
     # Constants
+    'ALL_CLOUDS',
     'HOSTED_CATALOG_DIR_URL',
     'CATALOG_SCHEMA_VERSION',
-    'LOCAL_CATALOG_DIR',
+    'CATALOG_DIR',
 ]
```

### Comparing `skypilot-0.5.0/sky/clouds/service_catalog/aws_catalog.py` & `skypilot-0.6.0/sky/clouds/service_catalog/aws_catalog.py`

 * *Files 6% similar despite different names*

```diff
@@ -7,27 +7,31 @@
 import hashlib
 import os
 import threading
 import typing
 from typing import Dict, List, Optional, Tuple
 
 import colorama
-import pandas as pd
 
 from sky import exceptions
 from sky import sky_logging
+from sky.adaptors import common as adaptors_common
 from sky.clouds import aws
 from sky.clouds.service_catalog import common
 from sky.clouds.service_catalog import config
 from sky.clouds.service_catalog.data_fetchers import fetch_aws
 from sky.utils import common_utils
 from sky.utils import resources_utils
 
 if typing.TYPE_CHECKING:
+    import pandas as pd
+
     from sky.clouds import cloud
+else:
+    pd = adaptors_common.LazyImport('pandas')
 
 logger = sky_logging.init_logger(__name__)
 
 # We will select from the following three instance families:
 _DEFAULT_INSTANCE_FAMILY = [
     # This is the latest general-purpose instance family as of Mar 2023.
     # CPU: Intel Ice Lake 8375C.
@@ -66,35 +70,42 @@
 _image_df = common.read_catalog('aws/images.csv',
                                 pull_frequency_hours=_PULL_FREQUENCY_HOURS)
 
 _quotas_df = common.read_catalog('aws/instance_quota_mapping.csv',
                                  pull_frequency_hours=_PULL_FREQUENCY_HOURS)
 
 
-def _get_az_mappings(aws_user_hash: str) -> Optional[pd.DataFrame]:
-    az_mapping_path = common.get_catalog_path(
-        f'aws/az_mappings-{aws_user_hash}.csv')
+def _get_az_mappings(aws_user_hash: str) -> Optional['pd.DataFrame']:
+    filename = f'aws/az_mappings-{aws_user_hash}.csv'
+    az_mapping_path = common.get_catalog_path(filename)
+    az_mapping_md5_path = common.get_catalog_path(f'.meta/{filename}.md5')
     if not os.path.exists(az_mapping_path):
         az_mappings = None
         if aws_user_hash != 'default':
             # Fetch az mapping from AWS.
             print(
                 f'\r{colorama.Style.DIM}AWS: Fetching availability zones '
                 f'mapping...{colorama.Style.RESET_ALL}',
                 end='')
             az_mappings = fetch_aws.fetch_availability_zone_mappings()
         else:
             return None
         az_mappings.to_csv(az_mapping_path, index=False)
+        # Write md5 of the az_mapping file to a file so we can check it for
+        # any changes when uploading to the controller
+        with open(az_mapping_path, 'r', encoding='utf-8') as f:
+            az_mapping_hash = hashlib.md5(f.read().encode()).hexdigest()
+        with open(az_mapping_md5_path, 'w', encoding='utf-8') as f:
+            f.write(az_mapping_hash)
     else:
         az_mappings = pd.read_csv(az_mapping_path)
     return az_mappings
 
 
-def _fetch_and_apply_az_mapping(df: pd.DataFrame) -> pd.DataFrame:
+def _fetch_and_apply_az_mapping(df: common.LazyDataFrame) -> 'pd.DataFrame':
     """Maps zone IDs (use1-az1) to zone names (us-east-1x).
 
     The upper-level functions that use the availability zone information
     should be able to handle the case where the zone name is not correct,
     due to the credentials not being configured.
 
     Such mappings are account-specific and determined by AWS. We fetch the
@@ -147,15 +158,15 @@
     # there will be rows with NaN in the AvailabilityZone column.
     df = df.merge(az_mappings, on=['AvailabilityZone'], how='inner')
     df = df.drop(columns=['AvailabilityZone']).rename(
         columns={'AvailabilityZoneName': 'AvailabilityZone'})
     return df
 
 
-def _get_df() -> pd.DataFrame:
+def _get_df() -> 'pd.DataFrame':
     global _user_df
     with _apply_az_mapping_lock:
         if _user_df is None:
             try:
                 _user_df = _fetch_and_apply_az_mapping(_default_df)
             except (RuntimeError, ImportError) as e:
                 if config.get_use_default_catalog_if_failed():
```

### Comparing `skypilot-0.5.0/sky/clouds/service_catalog/azure_catalog.py` & `skypilot-0.6.0/sky/clouds/service_catalog/azure_catalog.py`

 * *Files 18% similar despite different names*

```diff
@@ -17,14 +17,17 @@
 # still want to pull the latest catalog periodically to make sure the
 # user is using the latest catalog.
 _PULL_FREQUENCY_HOURS = 7
 
 _df = common.read_catalog('azure/vms.csv',
                           pull_frequency_hours=_PULL_FREQUENCY_HOURS)
 
+_image_df = common.read_catalog('azure/images.csv',
+                                pull_frequency_hours=_PULL_FREQUENCY_HOURS)
+
 # We will select from the following three instance families:
 _DEFAULT_INSTANCE_FAMILY = [
     # The latest general-purpose instance family as of Mar. 2023.
     # CPU: Intel Ice Lake 8370C.
     # Memory: 4 GiB RAM per 1 vCPU;
     'Ds_v5',
     # The latest memory-optimized instance family as of Mar. 2023.
@@ -164,7 +167,21 @@
         all_regions: bool = False,
         require_price: bool = True) -> Dict[str, List[common.InstanceTypeInfo]]:
     """Returns all instance types in Azure offering GPUs."""
     del require_price  # Unused.
     return common.list_accelerators_impl('Azure', _df, gpus_only, name_filter,
                                          region_filter, quantity_filter,
                                          case_sensitive, all_regions)
+
+
+def get_image_id_from_tag(tag: str, region: Optional[str]) -> Optional[str]:
+    """Returns the image id from the tag."""
+    # Azure images are not region-specific.
+    del region  # Unused.
+    return common.get_image_id_from_tag_impl(_image_df, tag, None)
+
+
+def is_image_tag_valid(tag: str, region: Optional[str]) -> bool:
+    """Returns whether the image tag is valid."""
+    # Azure images are not region-specific.
+    del region  # Unused.
+    return common.is_image_tag_valid_impl(_image_df, tag, None)
```

### Comparing `skypilot-0.5.0/sky/clouds/service_catalog/common.py` & `skypilot-0.6.0/sky/clouds/service_catalog/common.py`

 * *Files 14% similar despite different names*

```diff
@@ -1,31 +1,37 @@
 """Common utilities for service catalog."""
 import ast
 import difflib
 import hashlib
 import os
 import time
+import typing
 from typing import Dict, List, NamedTuple, Optional, Tuple
 
 import filelock
-import pandas as pd
 import requests
 
 from sky import sky_logging
+from sky.adaptors import common as adaptors_common
 from sky.clouds import cloud as cloud_lib
 from sky.clouds import cloud_registry
 from sky.clouds.service_catalog import constants
 from sky.utils import rich_utils
 from sky.utils import ux_utils
 
+if typing.TYPE_CHECKING:
+    import pandas as pd
+else:
+    pd = adaptors_common.LazyImport('pandas')
+
 logger = sky_logging.init_logger(__name__)
 
-_CATALOG_DIR = os.path.join(constants.LOCAL_CATALOG_DIR,
-                            constants.CATALOG_SCHEMA_VERSION)
-os.makedirs(_CATALOG_DIR, exist_ok=True)
+_ABSOLUTE_VERSIONED_CATALOG_DIR = os.path.join(
+    os.path.expanduser(constants.CATALOG_DIR), constants.CATALOG_SCHEMA_VERSION)
+os.makedirs(_ABSOLUTE_VERSIONED_CATALOG_DIR, exist_ok=True)
 
 
 class InstanceTypeInfo(NamedTuple):
     """Instance type information.
 
     - cloud: Cloud name.
     - instance_type: String that can be used in YAML to specify this instance
@@ -48,19 +54,110 @@
     memory: Optional[float]
     price: float
     spot_price: float
     region: str
 
 
 def get_catalog_path(filename: str) -> str:
-    return os.path.join(_CATALOG_DIR, filename)
+    return os.path.join(_ABSOLUTE_VERSIONED_CATALOG_DIR, filename)
+
+
+def is_catalog_modified(filename: str) -> bool:
+    # Check the md5 of the file to see if it has changed.
+    catalog_path = get_catalog_path(filename)
+    meta_path = os.path.join(_ABSOLUTE_VERSIONED_CATALOG_DIR, '.meta', filename)
+    md5_filepath = meta_path + '.md5'
+    if os.path.exists(md5_filepath):
+        with open(catalog_path, 'rb') as f:
+            file_md5 = hashlib.md5(f.read()).hexdigest()
+        with open(md5_filepath, 'r', encoding='utf-8') as f:
+            last_md5 = f.read()
+        return file_md5 != last_md5
+    else:
+        # If the md5 file does not exist, it means the catalog was manually
+        # populated instead of being fetched from the cloud.
+        return True
+
+
+def get_modified_catalog_file_mounts() -> Dict[str, str]:
+    """Returns a dict of catalogs which have been modified locally.
+
+    The dictionary maps the remote catalog path (relative) to the local path of
+    the modified catalog (absolute). Can be used directly as file_mounts for a
+    Task.
+
+    Used to determine which catalogs to upload to the controllers when they
+    are provisioned.
+    """
+
+    def _get_modified_catalogs() -> List[str]:
+        """Returns a list of modified catalogs relative to the catalog dir."""
+        modified_catalogs = []
+        for cloud_name in constants.ALL_CLOUDS:
+            cloud_catalog_dir = os.path.join(_ABSOLUTE_VERSIONED_CATALOG_DIR,
+                                             cloud_name)
+            if not os.path.exists(cloud_catalog_dir):
+                continue
+            # Iterate over all csvs cloud's catalog directory
+            for file in os.listdir(cloud_catalog_dir):
+                if file.endswith('.csv'):
+                    filename = os.path.join(cloud_name,
+                                            file)  # e.g., aws/vms.csv
+                    if is_catalog_modified(filename):
+                        modified_catalogs.append(filename)
+        return modified_catalogs
+
+    modified_catalog_list = _get_modified_catalogs()
+    modified_catalog_path_map = {}  # Map of remote: local catalog paths
+    for catalog in modified_catalog_list:
+        # Use relative paths for remote to handle varying usernames on the cloud
+        remote_path = os.path.join(constants.CATALOG_DIR,
+                                   constants.CATALOG_SCHEMA_VERSION, catalog)
+        local_path = os.path.expanduser(remote_path)
+        modified_catalog_path_map[remote_path] = local_path
+    return modified_catalog_path_map
+
+
+class LazyDataFrame:
+    """A lazy data frame that reads the catalog on demand.
+
+    We don't need to load the catalog for every SkyPilot call, and this class
+    allows us to load the catalog only when needed.
+    """
+
+    def __init__(self, filename: str):
+        self._filename = filename
+        self._df: Optional['pd.DataFrame'] = None
+
+    def _load_df(self) -> 'pd.DataFrame':
+        if self._df is None:
+            try:
+                self._df = pd.read_csv(self._filename)
+            except Exception as e:  # pylint: disable=broad-except
+                # As users can manually modify the catalog, read_csv can fail.
+                logger.error(f'Failed to read {self._filename}. '
+                             'To fix: delete the csv file and try again.')
+                with ux_utils.print_exception_no_traceback():
+                    raise e
+        return self._df
+
+    def __getattr__(self, name: str):
+        return getattr(self._load_df(), name)
+
+    def __getitem__(self, key):
+        # Delegate the indexing operation to the underlying DataFrame
+        return self._load_df()[key]
+
+    def __setitem__(self, key, value):
+        # Delegate the set operation to the underlying DataFrame
+        self._load_df()[key] = value
 
 
 def read_catalog(filename: str,
-                 pull_frequency_hours: Optional[int] = None) -> pd.DataFrame:
+                 pull_frequency_hours: Optional[int] = None) -> LazyDataFrame:
     """Reads the catalog from a local CSV file.
 
     If the file does not exist, download the up-to-date catalog that matches
     the schema version.
     If `pull_frequency_hours` is not None: pull the latest catalog with
     possibly updated prices, if the local catalog file is older than
     `pull_frequency_hours` and no changes to the local catalog file are
@@ -68,37 +165,31 @@
     """
     assert filename.endswith('.csv'), 'The catalog file must be a CSV file.'
     assert (pull_frequency_hours is None or
             pull_frequency_hours >= 0), pull_frequency_hours
     catalog_path = get_catalog_path(filename)
     cloud = cloud_registry.CLOUD_REGISTRY.from_str(os.path.dirname(filename))
 
-    meta_path = os.path.join(_CATALOG_DIR, '.meta', filename)
+    meta_path = os.path.join(_ABSOLUTE_VERSIONED_CATALOG_DIR, '.meta', filename)
     os.makedirs(os.path.dirname(meta_path), exist_ok=True)
 
     # Atomic check, to avoid conflicts with other processes.
     # TODO(mraheja): remove pylint disabling when filelock version updated
     # pylint: disable=abstract-class-instantiated
     with filelock.FileLock(meta_path + '.lock'):
 
         def _need_update() -> bool:
             if not os.path.exists(catalog_path):
                 return True
             if pull_frequency_hours is None:
                 return False
-            # Check the md5 of the file to see if it has changed.
-            with open(catalog_path, 'rb') as f:
-                file_md5 = hashlib.md5(f.read()).hexdigest()
-            md5_filepath = meta_path + '.md5'
-            if os.path.exists(md5_filepath):
-                with open(md5_filepath, 'r', encoding='utf-8') as f:
-                    last_md5 = f.read()
-                if file_md5 != last_md5:
-                    # Do not update the file if the user modified it.
-                    return False
+            if is_catalog_modified(filename):
+                # If the catalog is modified by a user manually, we should
+                # avoid overwriting the catalog by fetching from GitHub.
+                return False
 
             last_update = os.path.getmtime(catalog_path)
             return last_update + pull_frequency_hours * 3600 < time.time()
 
         if _need_update():
             url = f'{constants.HOSTED_CATALOG_DIR_URL}/{constants.CATALOG_SCHEMA_VERSION}/{filename}'  # pylint: disable=line-too-long
             update_frequency_str = ''
@@ -128,47 +219,39 @@
                     # Download successful, save the catalog to a local file.
                     os.makedirs(os.path.dirname(catalog_path), exist_ok=True)
                     with open(catalog_path, 'w', encoding='utf-8') as f:
                         f.write(r.text)
                     with open(meta_path + '.md5', 'w', encoding='utf-8') as f:
                         f.write(hashlib.md5(r.text.encode()).hexdigest())
 
-    try:
-        df = pd.read_csv(catalog_path)
-    except Exception as e:  # pylint: disable=broad-except
-        # As users can manually modify the catalog, read_csv can fail.
-        logger.error(f'Failed to read {catalog_path}. '
-                     'To fix: delete the csv file and try again.')
-        with ux_utils.print_exception_no_traceback():
-            raise e
-    return df
+    return LazyDataFrame(catalog_path)
 
 
 def _get_instance_type(
-    df: pd.DataFrame,
+    df: 'pd.DataFrame',
     instance_type: str,
     region: Optional[str],
     zone: Optional[str] = None,
-) -> pd.DataFrame:
+) -> 'pd.DataFrame':
     idx = df['InstanceType'] == instance_type
     if region is not None:
         idx &= df['Region'].str.lower() == region.lower()
     if zone is not None:
         # NOTE: For Azure instances, zone must be None.
         idx &= df['AvailabilityZone'] == zone
     return df[idx]
 
 
-def instance_type_exists_impl(df: pd.DataFrame, instance_type: str) -> bool:
+def instance_type_exists_impl(df: 'pd.DataFrame', instance_type: str) -> bool:
     """Returns True if the instance type is valid."""
     return instance_type in df['InstanceType'].unique()
 
 
 def validate_region_zone_impl(
-        cloud_name: str, df: pd.DataFrame, region: Optional[str],
+        cloud_name: str, df: 'pd.DataFrame', region: Optional[str],
         zone: Optional[str]) -> Tuple[Optional[str], Optional[str]]:
     """Validates whether region and zone exist in the catalog.
 
     Returns:
         A tuple of region and zone, if validated.
 
     Raises:
@@ -230,15 +313,15 @@
         region_df = filter_df['Region'].unique()
         assert len(region_df) == 1, 'Zone should be unique across regions.'
         validated_region = region_df[0]
     return validated_region, validated_zone
 
 
 def get_hourly_cost_impl(
-    df: pd.DataFrame,
+    df: 'pd.DataFrame',
     instance_type: str,
     use_spot: bool,
     region: Optional[str],
     zone: Optional[str],
 ) -> float:
     """Returns the hourly price of a VM instance in the given region and zone.
 
@@ -263,27 +346,31 @@
         price_str = 'SpotPrice'
     else:
         price_str = 'Price'
         # For AWS/Azure/GCP on-demand instances, the price is the same across
         # all the zones in the same region.
         assert region is None or len(set(df[price_str])) == 1, df
 
+    if pd.isna(df[price_str]).all():
+        with ux_utils.print_exception_no_traceback():
+            raise ValueError(f'No {price_str} found for instance type '
+                             f'{instance_type!r}.')
     cheapest_idx = df[price_str].idxmin()
     cheapest = df.loc[cheapest_idx]
     return cheapest[price_str]
 
 
 def _get_value(value):
     if pd.isna(value):
         return None
     return float(value)
 
 
 def get_vcpus_mem_from_instance_type_impl(
-    df: pd.DataFrame,
+    df: 'pd.DataFrame',
     instance_type: str,
 ) -> Tuple[Optional[float], Optional[float]]:
     df = _get_instance_type(df, instance_type, None)
     if len(df) == 0:
         with ux_utils.print_exception_no_traceback():
             raise ValueError(f'No instance type {instance_type} found.')
     assert len(set(df['vCPUs'])) == 1, ('Cannot determine the number of vCPUs '
@@ -296,15 +383,16 @@
 
     vcpus = df['vCPUs'].iloc[0]
     mem = df['MemoryGiB'].iloc[0]
 
     return _get_value(vcpus), _get_value(mem)
 
 
-def _filter_with_cpus(df: pd.DataFrame, cpus: Optional[str]) -> pd.DataFrame:
+def _filter_with_cpus(df: 'pd.DataFrame',
+                      cpus: Optional[str]) -> 'pd.DataFrame':
     if cpus is None:
         return df
 
     # The following code is redundant with the code in resources.py::_set_cpus()
     # but we add it here for safety.
     if cpus.endswith('+'):
         num_cpus_str = cpus[:-1]
@@ -319,16 +407,16 @@
 
     if cpus.endswith('+'):
         return df[df['vCPUs'] >= num_cpus]
     else:
         return df[df['vCPUs'] == num_cpus]
 
 
-def _filter_with_mem(df: pd.DataFrame,
-                     memory_gb_or_ratio: Optional[str]) -> pd.DataFrame:
+def _filter_with_mem(df: 'pd.DataFrame',
+                     memory_gb_or_ratio: Optional[str]) -> 'pd.DataFrame':
     if memory_gb_or_ratio is None:
         return df
 
     # The following code is partially redundant with the code in
     # resources.py::_set_memory() but we add it here for safety.
     if memory_gb_or_ratio.endswith(('+', 'x')):
         memory_gb_str = memory_gb_or_ratio[:-1]
@@ -345,25 +433,25 @@
         return df[df['MemoryGiB'] >= memory]
     elif memory_gb_or_ratio.endswith('x'):
         return df[df['MemoryGiB'] >= df['vCPUs'] * memory]
     else:
         return df[df['MemoryGiB'] == memory]
 
 
-def _filter_region_zone(df: pd.DataFrame, region: Optional[str],
-                        zone: Optional[str]) -> pd.DataFrame:
+def _filter_region_zone(df: 'pd.DataFrame', region: Optional[str],
+                        zone: Optional[str]) -> 'pd.DataFrame':
     if region is not None:
         df = df[df['Region'].str.lower() == region.lower()]
     if zone is not None:
         df = df[df['AvailabilityZone'].str.lower() == zone.lower()]
     return df
 
 
 def get_instance_type_for_cpus_mem_impl(
-        df: pd.DataFrame, cpus: Optional[str],
+        df: 'pd.DataFrame', cpus: Optional[str],
         memory_gb_or_ratio: Optional[str]) -> Optional[str]:
     """Returns the cheapest instance type that satisfies the requirements.
 
     Args:
         df: The catalog cloud catalog data frame.
         cpus: The number of vCPUs. Can be a number or a string "<number>+". If
             the string ends with "+", then the returned instance type should
@@ -380,30 +468,30 @@
         return None
     # Sort by the price.
     df = df.sort_values(by=['Price'], ascending=True)
     return df['InstanceType'].iloc[0]
 
 
 def get_accelerators_from_instance_type_impl(
-    df: pd.DataFrame,
+    df: 'pd.DataFrame',
     instance_type: str,
 ) -> Optional[Dict[str, int]]:
     df = _get_instance_type(df, instance_type, None)
     if len(df) == 0:
         with ux_utils.print_exception_no_traceback():
             raise ValueError(f'No instance type {instance_type} found.')
     row = df.iloc[0]
     acc_name, acc_count = row['AcceleratorName'], row['AcceleratorCount']
     if pd.isnull(acc_name):
         return None
     return {acc_name: int(acc_count)}
 
 
 def get_instance_type_for_accelerator_impl(
-    df: pd.DataFrame,
+    df: 'pd.DataFrame',
     acc_name: str,
     acc_count: int,
     cpus: Optional[str] = None,
     memory: Optional[str] = None,
     use_spot: bool = False,
     region: Optional[str] = None,
     zone: Optional[str] = None,
@@ -435,22 +523,24 @@
     result = _filter_with_mem(result, memory)
     result = _filter_region_zone(result, region, zone)
     if len(result) == 0:
         return ([], [])
 
     # Current strategy: choose the cheapest instance
     price_str = 'SpotPrice' if use_spot else 'Price'
+    if pd.isna(result[price_str]).all():
+        return ([], [])
     result = result.sort_values(price_str, ascending=True)
     instance_types = list(result['InstanceType'].drop_duplicates())
     return (instance_types, [])
 
 
 def list_accelerators_impl(
         cloud: str,
-        df: pd.DataFrame,
+        df: 'pd.DataFrame',
         gpus_only: bool,
         name_filter: Optional[str],
         region_filter: Optional[str],
         quantity_filter: Optional[int],
         case_sensitive: bool = True,
         all_regions: bool = False,
         require_price: bool = True) -> Dict[str, List[InstanceTypeInfo]]:
@@ -536,15 +626,15 @@
                               cpu_count if not pd.isna(info.cpu_count) else 0,
                               info.price, info.spot_price, info.region))
         return ret
 
     return {k: make_list_from_df(v) for k, v in grouped}
 
 
-def get_region_zones(df: pd.DataFrame,
+def get_region_zones(df: 'pd.DataFrame',
                      use_spot: bool) -> List[cloud_lib.Region]:
     """Returns a list of regions/zones from a dataframe."""
     price_str = 'SpotPrice' if use_spot else 'Price'
     sort_keys = [price_str, 'Region']
     if 'AvailabilityZone' in df.columns:
         sort_keys.append('AvailabilityZone')
     # If NaN appears in any of the sort keys, drop the row, as that means
@@ -556,15 +646,15 @@
             lambda x: [cloud_lib.Zone(zone) for zone in x])
         for region in regions:
             region.set_zones(zones_in_region[region.name])
     return regions
 
 
 # Images
-def get_image_id_from_tag_impl(df: pd.DataFrame, tag: str,
+def get_image_id_from_tag_impl(df: 'pd.DataFrame', tag: str,
                                region: Optional[str]) -> Optional[str]:
     """Returns the image ID for the given tag and region.
 
     If region is None, there must be only one image with the given tag.
 
     Returns None if a region (or globally if region is None) does not have
     an image that matches the tag.
@@ -577,14 +667,14 @@
         return None
     image_id = df['ImageId'].iloc[0]
     if pd.isna(image_id):
         return None
     return image_id
 
 
-def is_image_tag_valid_impl(df: pd.DataFrame, tag: str,
+def is_image_tag_valid_impl(df: 'pd.DataFrame', tag: str,
                             region: Optional[str]) -> bool:
     """Returns True if the image tag is valid."""
     df = df[df['Tag'] == tag]
     df = _filter_region_zone(df, region, zone=None)
     df = df.dropna(subset=['ImageId'])
     return len(df) > 0
```

### Comparing `skypilot-0.5.0/sky/clouds/service_catalog/config.py` & `skypilot-0.6.0/sky/clouds/service_catalog/config.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/clouds/service_catalog/cudo_catalog.py` & `skypilot-0.6.0/sky/clouds/service_catalog/cudo_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/clouds/service_catalog/data_fetchers/fetch_aws.py` & `skypilot-0.6.0/sky/clouds/service_catalog/data_fetchers/fetch_aws.py`

 * *Files 2% similar despite different names*

```diff
@@ -8,24 +8,30 @@
 from multiprocessing import pool as mp_pool
 import os
 import re
 import subprocess
 import sys
 import textwrap
 import traceback
+import typing
 from typing import Dict, List, Optional, Set, Tuple, Union
 
 import numpy as np
-import pandas as pd
 
 from sky import exceptions
 from sky.adaptors import aws
+from sky.adaptors import common as adaptors_common
 from sky.utils import log_utils
 from sky.utils import ux_utils
 
+if typing.TYPE_CHECKING:
+    import pandas as pd
+else:
+    pd = adaptors_common.LazyImport('pandas')
+
 # Enable most of the regions. Each user's account may have a subset of these
 # enabled; this is ok because we take the intersection of the list here with
 # the user-specific enabled regions in `aws_catalog`, via the "availability
 # zone mapping".
 # TODO(zhwu): fix the regions with no supported AMI (maybe by finding AMIs
 # similar to the Deep Learning AMI).
 ALL_REGIONS = [
@@ -94,39 +100,39 @@
             else:
                 raise
         regions_enabled = {r['RegionName'] for r in user_cloud_regions}
         regions_enabled = regions_enabled.intersection(set(ALL_REGIONS))
     return regions_enabled
 
 
-def _get_instance_types(region: str) -> pd.DataFrame:
+def _get_instance_types(region: str) -> 'pd.DataFrame':
     client = aws.client('ec2', region_name=region)
     paginator = client.get_paginator('describe_instance_types')
     items = []
     for i, resp in enumerate(paginator.paginate()):
         print(f'{region} getting instance types page {i}')
         items += resp['InstanceTypes']
 
     return pd.DataFrame(items)
 
 
-def _get_instance_type_offerings(region: str) -> pd.DataFrame:
+def _get_instance_type_offerings(region: str) -> 'pd.DataFrame':
     client = aws.client('ec2', region_name=region)
     paginator = client.get_paginator('describe_instance_type_offerings')
     items = []
     for i, resp in enumerate(
             paginator.paginate(LocationType='availability-zone')):
         print(f'{region} getting instance type offerings page {i}')
         items += resp['InstanceTypeOfferings']
 
     return pd.DataFrame(items).rename(
         columns={'Location': 'AvailabilityZoneName'})
 
 
-def _get_availability_zones(region: str) -> pd.DataFrame:
+def _get_availability_zones(region: str) -> 'pd.DataFrame':
     client = aws.client('ec2', region_name=region)
     zones = []
     try:
         response = client.describe_availability_zones()
     except aws.botocore_exceptions().ClientError as e:
         if e.response['Error']['Code'] == 'AuthFailure':
             # The user's AWS account may not have access to this region.
@@ -152,15 +158,15 @@
         zones.append({
             'AvailabilityZoneName': resp['ZoneName'],
             'AvailabilityZone': resp['ZoneId'],
         })
     return pd.DataFrame(zones)
 
 
-def _get_pricing_table(region: str) -> pd.DataFrame:
+def _get_pricing_table(region: str) -> 'pd.DataFrame':
     print(f'{region} downloading pricing table')
     url = PRICING_TABLE_URL_FMT.format(region=region)
     df = pd.read_csv(url, skiprows=5, low_memory=False)
     df.rename(columns={
         'Instance Type': 'InstanceType',
         'PricePerUnit': 'Price',
     },
@@ -170,15 +176,15 @@
               df['Pre Installed S/W'].isnull() &
               (df['CapacityStatus'] == 'Used') &
               (df['Tenancy'].isin(['Host', 'Shared'])) & df['Price'] > 0][[
                   'InstanceType', 'Price', 'vCPU', 'Memory'
               ]]
 
 
-def _get_spot_pricing_table(region: str) -> pd.DataFrame:
+def _get_spot_pricing_table(region: str) -> 'pd.DataFrame':
     """Get spot pricing table for a region.
 
     Example output:
         InstanceType  AvailabilityZoneName  SpotPrice
         p3.2xlarge    us-east-1a            1.0000
     """
     print(f'{region} downloading spot pricing table')
@@ -199,16 +205,16 @@
         ret = ret + response['SpotPriceHistory']
     df = pd.DataFrame(ret)[['InstanceType', 'AvailabilityZone', 'SpotPrice']]
     df = df.rename(columns={'AvailabilityZone': 'AvailabilityZoneName'})
     df = df.set_index(['InstanceType', 'AvailabilityZoneName'])
     return df
 
 
-def _patch_p4de(region: str, df: pd.DataFrame,
-                pricing_df: pd.DataFrame) -> pd.DataFrame:
+def _patch_p4de(region: str, df: 'pd.DataFrame',
+                pricing_df: 'pd.DataFrame') -> 'pd.DataFrame':
     # Hardcoded patch for p4de.24xlarge, as our credentials doesn't have access
     # to the instance type.
     # Columns:
     # InstanceType,AcceleratorName,AcceleratorCount,vCPUs,MemoryGiB,GpuInfo,
     # Price,SpotPrice,Region,AvailabilityZone
     records = []
     for zone in df[df['Region'] == region]['AvailabilityZone'].unique():
@@ -228,15 +234,15 @@
                      ['Price'].values[0],
             'SpotPrice': np.nan,
         })
     df = pd.concat([df, pd.DataFrame.from_records(records)])
     return df
 
 
-def _get_instance_types_df(region: str) -> Union[str, pd.DataFrame]:
+def _get_instance_types_df(region: str) -> Union[str, 'pd.DataFrame']:
     try:
         # Fetch the zone info first to make sure the account has access to the
         # region.
         zone_df = _get_availability_zones(region)
 
         # Use ThreadPool instead of Pool because this function can be called
         # within a multiprocessing.Pool, and Pool cannot be nested.
@@ -337,15 +343,15 @@
     except Exception as e:  # pylint: disable=broad-except
         print(traceback.format_exc())
         print(f'{region} failed with {e}', file=sys.stderr)
         return region
     return df
 
 
-def get_all_regions_instance_types_df(regions: Set[str]) -> pd.DataFrame:
+def get_all_regions_instance_types_df(regions: Set[str]) -> 'pd.DataFrame':
     with mp_pool.Pool() as pool:
         df_or_regions = pool.map(_get_instance_types_df, regions)
     new_dfs = []
     for df_or_region in df_or_regions:
         if isinstance(df_or_region, str):
             print(f'{df_or_region} failed')
         else:
@@ -409,28 +415,28 @@
     if image_id is None:
         # not found
         print(f'Failed to find image for {region}, {ubuntu_version}, {gpu}')
     tag = f'skypilot:{gpu}-ubuntu-{ubuntu_version.replace(".", "")}'
     return tag, region, 'ubuntu', ubuntu_version, image_id, date
 
 
-def get_all_regions_images_df(regions: Set[str]) -> pd.DataFrame:
+def get_all_regions_images_df(regions: Set[str]) -> 'pd.DataFrame':
     image_metas = [
         (r, *i) for r, i in itertools.product(regions, _GPU_UBUNTU_DATE_PYTORCH)
     ]
     with mp_pool.Pool() as pool:
         results = pool.starmap(_get_image_row, image_metas)
     result_df = pd.DataFrame(
         results,
         columns=['Tag', 'Region', 'OS', 'OSVersion', 'ImageId', 'CreationDate'])
     result_df.sort_values(['Tag', 'Region'], inplace=True)
     return result_df
 
 
-def fetch_availability_zone_mappings() -> pd.DataFrame:
+def fetch_availability_zone_mappings() -> 'pd.DataFrame':
     """Fetch the availability zone mappings from ID to Name.
 
     Example output:
         AvailabilityZone  AvailabilityZoneName
         use1-az1          us-east-1b
         use1-az2          us-east-1a
     """
@@ -500,15 +506,15 @@
 
     user_regions = get_enabled_regions()
     if args.check_all_regions_enabled_for_account and set(
             ALL_REGIONS) - user_regions:
         raise RuntimeError('The following regions are not enabled: '
                            f'{set(ALL_REGIONS) - user_regions}')
 
-    def _check_regions_integrity(df: pd.DataFrame, name: str):
+    def _check_regions_integrity(df: 'pd.DataFrame', name: str):
         # Check whether the fetched regions match the requested regions to
         # guard against network issues or glitches in the AWS API.
         fetched_regions = set(df['Region'].unique())
         if fetched_regions != user_regions:
             # This is a sanity check to make sure that the regions we
             # requested are the same as the ones we fetched.
             # The mismatch could happen for network issues or glitches
```

### Comparing `skypilot-0.5.0/sky/clouds/service_catalog/data_fetchers/fetch_azure.py` & `skypilot-0.6.0/sky/clouds/service_catalog/data_fetchers/fetch_azure.py`

 * *Files 2% similar despite different names*

```diff
@@ -3,21 +3,28 @@
 This script takes about 1 minute to finish.
 """
 import argparse
 import json
 from multiprocessing import pool as mp_pool
 import os
 import subprocess
+import typing
 from typing import List, Optional, Set
 import urllib
 
 import numpy as np
-import pandas as pd
 import requests
 
+from sky.adaptors import common as adaptors_common
+
+if typing.TYPE_CHECKING:
+    import pandas as pd
+else:
+    pd = adaptors_common.LazyImport('pandas')
+
 US_REGIONS = {
     'centralus',
     'eastus',
     'eastus2',
     'northcentralus',
     'southcentralus',
     'westcentralus',
@@ -99,15 +106,15 @@
     ]
     if region is not None:
         filters.append(f'armRegionName eq \'{region}\'')
     filters_str = urllib.parse.quote(' and '.join(filters))
     return f'https://prices.azure.com/api/retail/prices?$filter={filters_str}'
 
 
-def get_pricing_df(region: Optional[str] = None) -> pd.DataFrame:
+def get_pricing_df(region: Optional[str] = None) -> 'pd.DataFrame':
     all_items = []
     url = get_pricing_url(region)
     print(f'Getting pricing for {region}, url: {url}')
     page = 0
     while url is not None:
         page += 1
         if page % 10 == 0:
@@ -124,15 +131,15 @@
     print(f'Done fetching pricing {region}')
     df = pd.DataFrame(all_items)
     assert 'productName' in df.columns, (region, df.columns)
     return df[(~df['productName'].str.contains(' Windows')) &
               (df['unitPrice'] > 0)]
 
 
-def get_sku_df(region_set: Set[str]) -> pd.DataFrame:
+def get_sku_df(region_set: Set[str]) -> 'pd.DataFrame':
     print('Fetching SKU list')
     # To get a complete list, --all option is necessary.
     proc = subprocess.run(
         'az vm list-skus --all --resource-type virtualMachines -o json',
         shell=True,
         check=True,
         stdout=subprocess.PIPE,
```

### Comparing `skypilot-0.5.0/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py` & `skypilot-0.6.0/sky/clouds/service_catalog/data_fetchers/fetch_cudo.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py` & `skypilot-0.6.0/sky/clouds/service_catalog/data_fetchers/fetch_fluidstack.py`

 * *Files 26% similar despite different names*

```diff
@@ -1,28 +1,29 @@
 """A script that generates the Fluidstack catalog.
 
 Usage:
     python fetch_fluidstack_cloud.py
 """
 
-import copy
 import csv
 import json
 import os
 from typing import List
 
 import requests
 
 ENDPOINT = 'https://api.fluidstack.io/v1/plans'
 DEFAULT_FLUIDSTACK_API_KEY_PATH = os.path.expanduser('~/.fluidstack/api_key')
 DEFAULT_FLUIDSTACK_API_TOKEN_PATH = os.path.expanduser(
     '~/.fluidstack/api_token')
 
 GPU_MAP = {
     'H100_PCIE_80GB': 'H100',
+    'H100_NVLINK_80GB': 'H100',
+    'A100_NVLINK_80GB': 'A100-80GB',
     'A100_SXM4_80GB': 'A100-80GB',
     'A100_PCIE_80GB': 'A100-80GB',
     'A100_SXM4_40GB': 'A100',
     'A100_PCIE_40GB': 'A100',
     'Tesla_V100_SXM2_16GB': 'V100',
     'Tesla_V100_PCIE_16GB': 'V100',
     'A10_PCIE_24GB': 'A10',
@@ -36,70 +37,34 @@
     'L40_48GB': 'L40',
     'Quadro_RTX_6000_16GB': 'RTX6000',
     'T4_16GB': 'T4',
     'RTX_3090_24GB': 'RTX3090',
     'RTX_3080_10GB': 'RTX3080',
 }
 
-CUSTOM_PLANS_CONFIG = [
-    dict(gpu_count=1, cpu_count=8, nvme_storage=750, ram=64),
-    dict(gpu_count=2, cpu_count=16, nvme_storage=1024, ram=128),
-    #dict(gpu_count=4, cpu_count=32, nvme_storage=1200, ram=160),
-    #dict(gpu_count=8, cpu_count=64, nvme_storage=1500, ram=200)
-]
-
 
 def get_regions(plans: List) -> dict:
     """Return a list of regions where the plan is available."""
     regions = {}
     for plan in plans:
         for region in plan.get('regions', []):
             regions[region['id']] = region['id']
     return regions
 
 
-def plans_from_custom_plan(plan: dict) -> List[dict]:
-    prices = dict(cpu=plan['price']['cpu']['hourly'],
-                  ram=plan['price']['ram']['hourly'],
-                  storage=plan['price']['storage']['hourly'],
-                  gpu=plan['price']['gpu']['hourly'])
-    new_plans = []
-    for i, config in enumerate(CUSTOM_PLANS_CONFIG):
-        new_plan = copy.deepcopy(plan)
-        price = (prices['cpu'] *
-                 config['cpu_count']) + (prices['ram'] * config['ram']) + (
-                     prices['storage'] * config['nvme_storage']) + (
-                         prices['gpu'] * config['gpu_count'])
-        new_plan['price']['hourly'] = price / config['gpu_count']
-        new_plan['configuration']['core_count'] = config['cpu_count']
-        new_plan['configuration']['ram'] = config['ram']
-        new_plan['configuration']['gpu_count'] = config['gpu_count']
-        new_plan['configuration']['nvme_storage'] = config['nvme_storage']
-        new_plan['plan_id'] = f'custom:{i}:{plan["plan_id"]}'
-        new_plans.append(new_plan)
-    return new_plans
-
-
 def create_catalog(output_dir: str) -> None:
     response = requests.get(ENDPOINT)
     plans = response.json()
-    custom_plans = [
-        plan for plan in plans if plan['minimum_commitment'] == 'hourly' and
-        plan['type'] in ['custom'] and plan['gpu_type'] != 'NO GPU'
-    ]
     #plans = [plan for plan in plans if len(plan['regions']) > 0]
     plans = [
         plan for plan in plans if plan['minimum_commitment'] == 'hourly' and
         plan['type'] in ['preconfigured'] and
         plan['gpu_type'] not in ['NO GPU', 'RTX_3080_10GB', 'RTX_3090_24GB']
     ]
 
-    plans = plans + [
-        plan for plan in custom_plans for plan in plans_from_custom_plan(plan)
-    ]
     with open(os.path.join(output_dir, 'vms.csv'), mode='w',
               encoding='utf-8') as f:
         writer = csv.writer(f, delimiter=',', quotechar='"')
         writer.writerow([
             'InstanceType',
             'AcceleratorName',
             'AcceleratorCount',
@@ -110,15 +75,15 @@
             'GpuInfo',
             'SpotPrice',
         ])
         for plan in plans:
             try:
                 gpu = GPU_MAP[plan['gpu_type']]
             except KeyError:
-                print(f'Could not map {plan["gpu_type"]}')
+                #print(f'Could not map {plan["gpu_type"]}')
                 continue
             gpu_memory = int(
                 str(plan['configuration']['gpu_memory']).replace('GB',
                                                                  '')) * 1024
             gpu_cnt = int(plan['configuration']['gpu_count'])
             vcpus = float(plan['configuration']['core_count'])
             mem = float(plan['configuration']['ram'])
```

### Comparing `skypilot-0.5.0/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py` & `skypilot-0.6.0/sky/clouds/service_catalog/data_fetchers/fetch_gcp.py`

 * *Files 5% similar despite different names*

```diff
@@ -6,23 +6,29 @@
 
 import argparse
 import functools
 import io
 import multiprocessing
 import os
 import textwrap
+import typing
 from typing import Any, Callable, Dict, List, Optional, Set
 
 import google.auth
 from googleapiclient import discovery
 import numpy as np
-import pandas as pd
 
+from sky.adaptors import common as adaptors_common
 from sky.adaptors import gcp
 
+if typing.TYPE_CHECKING:
+    import pandas as pd
+else:
+    pd = adaptors_common.LazyImport('pandas')
+
 # Useful links:
 # GCP SKUs: https://cloud.google.com/skus
 # VM pricing: https://cloud.google.com/compute/vm-instance-pricing
 # GPU pricing: https://cloud.google.com/compute/gpus-pricing
 # TPU pricing: https://cloud.google.com/tpu/pricing
 
 # Service IDs found in https://cloud.google.com/skus
@@ -58,14 +64,15 @@
  """)))
 
 # TODO(woosuk): Make this more robust.
 # Refer to: https://github.com/skypilot-org/skypilot/issues/1006
 # Unsupported Series: 'f1', 'm2'
 SERIES_TO_DISCRIPTION = {
     'a2': 'A2 Instance',
+    'a3': 'A3 Instance',
     'c2': 'Compute optimized',
     'c2d': 'C2D AMD Instance',
     'c3': 'C3 Instance',
     'e2': 'E2 Instance',
     'f1': 'Micro Instance with burstable CPU',
     'g1': 'Small Instance with 1 VCPU',
     'g2': 'G2 Instance',
@@ -170,15 +177,15 @@
         zones_response = zones_request.execute()
         zones.extend([zone['name'] for zone in zones_response['items']])
         zones_request = gcp_client.zones().list_next(
             previous_request=zones_request, previous_response=zones_response)
     return zones
 
 
-def _get_machine_type_for_zone(zone: str) -> pd.DataFrame:
+def _get_machine_type_for_zone(zone: str) -> 'pd.DataFrame':
     machine_types_request = gcp_client.machineTypes().list(project=project_id,
                                                            zone=zone)
     print(f'Fetching machine types for zone {zone!r}...')
     machine_types = []
     while machine_types_request is not None:
         machine_types_response = machine_types_request.execute()
         machine_types.extend(machine_types_response['items'])
@@ -191,27 +198,27 @@
         'MemoryGiB': machine_type['memoryMb'] / 1024,
         'Region': zone.rpartition('-')[0],
         'AvailabilityZone': zone
     } for machine_type in machine_types]
     return pd.DataFrame(machine_types).reset_index(drop=True)
 
 
-def _get_machine_types(region_prefix: str) -> pd.DataFrame:
+def _get_machine_types(region_prefix: str) -> 'pd.DataFrame':
     zones = _get_all_zones()
     zones = [zone for zone in zones if zone.startswith(region_prefix)]
     if SINGLE_THREADED:
         all_machine_dfs = [_get_machine_type_for_zone(zone) for zone in zones]
     else:
         with multiprocessing.Pool() as pool:
             all_machine_dfs = pool.map(_get_machine_type_for_zone, zones)
     machine_df = pd.concat(all_machine_dfs, ignore_index=True)
     return machine_df
 
 
-def get_vm_df(skus: List[Dict[str, Any]], region_prefix: str) -> pd.DataFrame:
+def get_vm_df(skus: List[Dict[str, Any]], region_prefix: str) -> 'pd.DataFrame':
     df = _get_machine_types(region_prefix)
     if df.empty:
         return df
 
     # Drop the unsupported series.
     df = df[df['InstanceType'].str.startswith(
         tuple(f'{series}-' for series in SERIES_TO_DISCRIPTION))]
@@ -276,15 +283,15 @@
     df['Price'] = df.apply(lambda row: get_vm_price(row, spot=False), axis=1)
     df['SpotPrice'] = df.apply(lambda row: get_vm_price(row, spot=True), axis=1)
     df = df.reset_index(drop=True)
     df = df.sort_values(['InstanceType', 'Region', 'AvailabilityZone'])
     return df
 
 
-def _get_gpus_for_zone(zone: str) -> pd.DataFrame:
+def _get_gpus_for_zone(zone: str) -> 'pd.DataFrame':
     gpus_request = gcp_client.acceleratorTypes().list(project=project_id,
                                                       zone=zone)
     print(f'Fetching GPUs for zone {zone!r}...')
     gpus = []
     while gpus_request is not None:
         gpus_response = gpus_request.execute()
         gpus.extend(gpus_response.get('items', []))
@@ -294,41 +301,75 @@
     for gpu in gpus:
         for sup in range(0, int(np.log2(gpu['maximumCardsPerInstance']) + 1)):
             count = int(2**sup)
             gpu_name = gpu['name']
             gpu_name = gpu_name.replace('nvidia-', '')
             gpu_name = gpu_name.replace('tesla-', '')
             gpu_name = gpu_name.upper()
+            if 'H100-80GB' in gpu_name:
+                gpu_name = 'H100'
+                if count != 8:
+                    # H100 only has 8 cards.
+                    continue
             if 'VWS' in gpu_name:
                 continue
             if gpu_name.startswith('TPU-'):
                 continue
+            gpu_info = _gpu_info_from_name(gpu_name)
+            if gpu_info is None:
+                # Prevent `show-gpus` from not showing GPUs without GPU info.
+                gpu_info = gpu_name
             new_gpus.append({
                 'AcceleratorName': gpu_name,
                 'AcceleratorCount': count,
-                'GpuInfo': None,
+                'GpuInfo': gpu_info,
                 'Region': zone.rpartition('-')[0],
                 'AvailabilityZone': zone,
             })
     return pd.DataFrame(new_gpus).reset_index(drop=True)
 
 
-def _get_gpus(region_prefix: str) -> pd.DataFrame:
+def _gpu_info_from_name(name: str) -> Optional[Dict[str, List[Dict[str, Any]]]]:
+    """Hard-codes the GPU memory info for certain GPUs.
+
+    Reference: https://cloud.google.com/compute/docs/gpus
+    """
+    name_to_gpu_memory_in_mib = {
+        'L4': 24 * 1024,
+        'A100-80GB': 80 * 1024,
+        'A100': 40 * 1024,
+        'H100': 80 * 1024,
+        'P4': 8 * 1024,
+        'T4': 16 * 1024,
+        'V100': 16 * 1024,
+        'P100': 16 * 1024,
+        # End of life:
+        'K80': 12 * 1024,
+    }
+    gpu_memory_in_mib = name_to_gpu_memory_in_mib.get(name)
+    if gpu_memory_in_mib is not None:
+        return {'Gpus': [{'MemoryInfo': {'SizeInMiB': gpu_memory_in_mib}}]}
+    print('Warning: GPU memory info not found for', name)
+    return None
+
+
+def _get_gpus(region_prefix: str) -> 'pd.DataFrame':
     zones = _get_all_zones()
     zones = [zone for zone in zones if zone.startswith(region_prefix)]
     if SINGLE_THREADED:
         all_gpu_dfs = [_get_gpus_for_zone(zone) for zone in zones]
     else:
         with multiprocessing.Pool() as pool:
             all_gpu_dfs = pool.map(_get_gpus_for_zone, zones)
     gpu_df = pd.concat(all_gpu_dfs, ignore_index=True)
     return gpu_df
 
 
-def get_gpu_df(skus: List[Dict[str, Any]], region_prefix: str) -> pd.DataFrame:
+def get_gpu_df(skus: List[Dict[str, Any]],
+               region_prefix: str) -> 'pd.DataFrame':
     gpu_skus = [
         sku for sku in skus if sku['category']['resourceGroup'] == 'GPU'
     ]
     df = _get_gpus(region_prefix)
     if df.empty:
         return df
 
@@ -340,14 +381,16 @@
                 continue
             if sku['category']['usageType'] != ondemand_or_spot:
                 continue
 
             gpu_name = row['AcceleratorName']
             if gpu_name == 'A100-80GB':
                 gpu_name = 'A100 80GB'
+            if gpu_name == 'H100':
+                gpu_name = 'H100 80GB'
             if f'{gpu_name} GPU' not in sku['description']:
                 continue
 
             unit_price = _get_unit_price(sku)
             gpu_price = unit_price * row['AcceleratorCount']
             break
 
@@ -364,19 +407,18 @@
     df['SpotPrice'] = df.apply(lambda row: get_gpu_price(row, spot=True),
                                axis=1)
     # Drop invalid rows.
     df = df[df['Price'].notna() | df['SpotPrice'].notna()]
     df = df.reset_index(drop=True)
     df = df.sort_values(
         ['AcceleratorName', 'AcceleratorCount', 'Region', 'AvailabilityZone'])
-    df['GpuInfo'] = df['AcceleratorName']
     return df
 
 
-def _get_tpu_for_zone(zone: str) -> pd.DataFrame:
+def _get_tpu_for_zone(zone: str) -> 'pd.DataFrame':
     tpus = []
     parent = f'projects/{project_id}/locations/{zone}'
     tpus_request = tpu_client.projects().locations().acceleratorTypes().list(
         parent=parent)
     try:
         tpus_response = tpus_request.execute()
         for tpu in tpus_response['acceleratorTypes']:
@@ -398,29 +440,29 @@
             'AcceleratorCount': 1,
             'Region': zone.rpartition('-')[0],
             'AvailabilityZone': zone,
         })
     return pd.DataFrame(new_tpus).reset_index(drop=True)
 
 
-def _get_tpus() -> pd.DataFrame:
+def _get_tpus() -> 'pd.DataFrame':
     zones = _get_all_zones()
     # Add TPU-v4 zones.
     zones += TPU_V4_ZONES
     if SINGLE_THREADED:
         all_tpu_dfs = [_get_tpu_for_zone(zone) for zone in zones]
     else:
         with multiprocessing.Pool() as pool:
             all_tpu_dfs = pool.map(_get_tpu_for_zone, zones)
     tpu_df = pd.concat(all_tpu_dfs, ignore_index=True)
     return tpu_df
 
 
 # TODO: the TPUs fetched fails to contain us-east1
-def get_tpu_df(skus: List[Dict[str, Any]]) -> pd.DataFrame:
+def get_tpu_df(skus: List[Dict[str, Any]]) -> 'pd.DataFrame':
     df = _get_tpus()
     if df.empty:
         return df
 
     def get_tpu_price(row: pd.Series, spot: bool) -> Optional[float]:
         assert row['AcceleratorCount'] == 1, row
         tpu_price = None
@@ -488,15 +530,15 @@
     df = df.sort_values(
         ['version_and_size', 'AcceleratorCount', 'Region', 'AvailabilityZone'])
     df.drop(columns=['version_and_size'], inplace=True)
     df['GpuInfo'] = df['AcceleratorName']
     return df
 
 
-def get_catalog_df(region_prefix: str) -> pd.DataFrame:
+def get_catalog_df(region_prefix: str) -> 'pd.DataFrame':
     gcp_skus = get_skus(GCE_SERVICE_ID)
     vm_df = get_vm_df(gcp_skus, region_prefix)
     gpu_df = get_gpu_df(gcp_skus, region_prefix)
 
     # Drop regions without the given prefix.
     # NOTE: We intentionally do not drop any TPU regions.
     vm_df = vm_df[vm_df['Region'].str.startswith(region_prefix)]
```

### Comparing `skypilot-0.5.0/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py` & `skypilot-0.6.0/sky/clouds/service_catalog/data_fetchers/fetch_lambda_cloud.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py` & `skypilot-0.6.0/sky/clouds/service_catalog/data_fetchers/fetch_vsphere.py`

 * *Files 0% similar despite different names*

```diff
@@ -1,19 +1,23 @@
 """ data fetcher for vsphere """
 import json
 import logging
 import os
 import typing
 
-import pandas as pd
-
+from sky.adaptors import common as adaptors_common
 from sky.adaptors import vsphere as vsphere_adaptor
 from sky.clouds.service_catalog.common import get_catalog_path
 from sky.provision.vsphere.common.cls_api_client import ClsApiClient
 
+if typing.TYPE_CHECKING:
+    import pandas as pd
+else:
+    pd = adaptors_common.LazyImport('pandas')
+
 logging.basicConfig(level=logging.INFO)
 logger = logging.getLogger(__name__)
 
 # TODO: Add more GPUs and a GPU full/short name mapping
 PRESET_GPU_LIST = [
     {
         'Model': 'V100',
```

### Comparing `skypilot-0.5.0/sky/clouds/service_catalog/fluidstack_catalog.py` & `skypilot-0.6.0/sky/clouds/service_catalog/fluidstack_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/clouds/service_catalog/gcp_catalog.py` & `skypilot-0.6.0/sky/clouds/service_catalog/gcp_catalog.py`

 * *Files 2% similar despite different names*

```diff
@@ -2,24 +2,27 @@
 
 For now this service catalog is manually coded. In the future it should be
 queried from GCP API.
 """
 import typing
 from typing import Dict, List, Optional, Tuple
 
-import pandas as pd
-
 from sky import exceptions
 from sky import sky_logging
+from sky.adaptors import common as adaptors_common
 from sky.clouds.service_catalog import common
 from sky.utils import resources_utils
 from sky.utils import ux_utils
 
 if typing.TYPE_CHECKING:
+    import pandas as pd
+
     from sky.clouds import cloud
+else:
+    pd = adaptors_common.LazyImport('pandas')
 
 logger = sky_logging.init_logger(__name__)
 
 # Pull the latest catalog every week.
 # GCP guarantees that the catalog is updated at most once per 30 days, but
 # different VMs can be updated at different time. Thus, we pull the catalog
 # every 7 hours to make sure we have the latest information.
@@ -88,14 +91,17 @@
             'g2-standard-16',
             'g2-standard-32',
         ],
         2: ['g2-standard-24'],
         4: ['g2-standard-48'],
         8: ['g2-standard-96'],
     },
+    'H100': {
+        8: ['a3-highgpu-8g'],
+    }
 }
 
 # Number of CPU cores per GPU based on the AWS setting.
 # GCP A100 has its own instance type mapping.
 # Refer to sky/clouds/service_catalog/gcp_catalog.py
 _NUM_ACC_TO_NUM_CPU = {
     # Based on p2 on AWS.
@@ -316,20 +322,20 @@
 def get_region_zones_for_instance_type(instance_type: str,
                                        use_spot: bool) -> List['cloud.Region']:
     df = _df[_df['InstanceType'] == instance_type]
     return common.get_region_zones(df, use_spot)
 
 
 def _get_accelerator(
-    df: pd.DataFrame,
+    df: 'pd.DataFrame',
     accelerator: str,
     count: int,
     region: Optional[str],
     zone: Optional[str] = None,
-) -> pd.DataFrame:
+) -> 'pd.DataFrame':
     idx = (df['AcceleratorName'].str.fullmatch(
         accelerator, case=False)) & (df['AcceleratorCount'] == count)
     if region is not None:
         idx &= df['Region'] == region
     if zone is not None:
         idx &= df['AvailabilityZone'] == zone
     return df[idx]
```

### Comparing `skypilot-0.5.0/sky/clouds/service_catalog/ibm_catalog.py` & `skypilot-0.6.0/sky/clouds/service_catalog/ibm_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/clouds/service_catalog/lambda_catalog.py` & `skypilot-0.6.0/sky/clouds/service_catalog/lambda_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/clouds/service_catalog/oci_catalog.py` & `skypilot-0.6.0/sky/clouds/service_catalog/oci_catalog.py`

 * *Files 1% similar despite different names*

```diff
@@ -36,31 +36,31 @@
     with _lock:
         global _df
         if _df is not None:
             return _df
 
         df = common.read_catalog('oci/vms.csv')
         try:
-            oci_adaptor.get_oci()
+            oci_adaptor.oci.load_module()
         except ImportError:
             _df = df
             return _df
 
         try:
             config_profile = oci_utils.oci_config.get_profile()
             client = oci_adaptor.get_identity_client(profile=config_profile)
 
             subscriptions = client.list_region_subscriptions(
                 tenancy_id=oci_adaptor.get_oci_config(
                     profile=config_profile)['tenancy']).data
 
             subscribed_regions = [r.region_name for r in subscriptions]
 
-        except (oci_adaptor.get_oci().exceptions.ConfigFileNotFound,
-                oci_adaptor.get_oci().exceptions.InvalidConfig) as e:
+        except (oci_adaptor.oci.exceptions.ConfigFileNotFound,
+                oci_adaptor.oci.exceptions.InvalidConfig) as e:
             # This should only happen in testing where oci config is
             # missing, because it means the 'sky check' will fail if
             # enter here (meaning OCI disabled).
             logger.debug(f'It is OK goes here when testing: {str(e)}')
             subscribed_regions = []
 
         except oci_adaptor.service_exception() as e:
```

### Comparing `skypilot-0.5.0/sky/clouds/service_catalog/runpod_catalog.py` & `skypilot-0.6.0/sky/clouds/service_catalog/runpod_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/clouds/service_catalog/scp_catalog.py` & `skypilot-0.6.0/sky/clouds/service_catalog/scp_catalog.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/clouds/service_catalog/vsphere_catalog.py` & `skypilot-0.6.0/sky/clouds/service_catalog/vsphere_catalog.py`

 * *Files 1% similar despite different names*

```diff
@@ -1,33 +1,36 @@
 """Vsphere catalog."""
 import io
 import os
 import typing
 from typing import Dict, List, Optional, Tuple
 
-import pandas as pd
-
+from sky.adaptors import common as adaptors_common
 from sky.clouds.service_catalog import common
 
 if typing.TYPE_CHECKING:
+    import pandas as pd
+
     from sky.clouds import cloud
+else:
+    pd = adaptors_common.LazyImport('pandas')
 
 _DEFAULT_NUM_VCPUS = 2
 _DEFAULT_MEMORY_CPU_RATIO = 4
 _CLOUD_VSPHERE = 'vsphere'
 
 VSPHERE_CATALOG_HEADER = (
     'InstanceType,AcceleratorName,AcceleratorCount,vCPUs,'
     'MemoryGiB,GpuInfo,Price,SpotPrice,Region,AvailabilityZone')
 
 _LOCAL_CATALOG = common.get_catalog_path('vsphere/vms.csv')
 _df = None
 
 
-def _get_df() -> pd.DataFrame:
+def _get_df() -> 'pd.DataFrame':
     """Returns the catalog as a DataFrame."""
     global _df
     if _df is not None:
         return _df
     if os.path.exists(_LOCAL_CATALOG):
         _df = pd.read_csv(_LOCAL_CATALOG)
     else:
```

### Comparing `skypilot-0.5.0/sky/clouds/utils/gcp_utils.py` & `skypilot-0.6.0/sky/clouds/utils/gcp_utils.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,14 +1,15 @@
 """Utility functions for GCP.
 
 The functions that are used to access GCP APIs and TPU VM. We have the
 reservation-related functions here, so that the cache of the reservations can be
 shared across multiple clouds.GCP() objects.
 """
 
+import copy
 import dataclasses
 import json
 import time
 import typing
 from typing import List, Optional, Set
 
 import cachetools
@@ -135,14 +136,20 @@
 
     TODO: We need to incorporate accelerators because the reserved instance
     can be consumed only when the instance_type + GPU type matches, and in
     GCP GPUs except for A100 and L4 do not have their own instance type.
     For example, if we have a specific reservation with n1-highmem-8
     in us-central1-c. `sky launch --gpus V100` will fail.
     """
+    prioritize_reservations = skypilot_config.get_nested(
+        ('gcp', 'prioritize_reservations'), False)
+    specific_reservations = skypilot_config.get_nested(
+        ('gcp', 'specific_reservations'), [])
+    if not prioritize_reservations and not specific_reservations:
+        return []
     logger.debug(f'Querying GCP reservations for instance {instance_type!r}')
     list_reservations_cmd = (
         'gcloud compute reservations list '
         '--filter="specificReservation.instanceProperties.machineType='
         f'{instance_type} AND status=READY" --format="json('
         'specificReservation.count, specificReservation.inUseCount, '
         'specificReservationRequired, selfLink, zone)"')
@@ -161,13 +168,19 @@
         stderr=stderr,
         stream_logs=True,
     )
     return [GCPReservation.from_dict(r) for r in json.loads(stdout)]
 
 
 def get_minimal_permissions() -> List[str]:
-    if skypilot_config.get_nested(('gcp', 'vpc_name'), None) is not None:
-        return constants.VM_MINIMAL_PERMISSIONS
-    # If custom VPC is not specified, permissions to modify network are
-    # required to ensure SkyPilot to be able to setup the network, and
-    # allow opening ports (e.g., via `resources.ports`).
-    return constants.VM_MINIMAL_PERMISSIONS + constants.FIREWALL_PERMISSIONS
+    permissions = copy.copy(constants.VM_MINIMAL_PERMISSIONS)
+    if skypilot_config.get_nested(('gcp', 'vpc_name'), None) is None:
+        # If custom VPC is not specified, permissions to modify network are
+        # required to ensure SkyPilot to be able to setup the network, and
+        # allow opening ports (e.g., via `resources.ports`).
+        permissions += constants.FIREWALL_PERMISSIONS
+
+    if (skypilot_config.get_nested(('gcp', 'prioritize_reservations'), False) or
+            skypilot_config.get_nested(('gcp', 'specific_reservations'), [])):
+        permissions += constants.RESERVATION_PERMISSIONS
+
+    return permissions
```

### Comparing `skypilot-0.5.0/sky/clouds/utils/lambda_utils.py` & `skypilot-0.6.0/sky/clouds/utils/lambda_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/clouds/utils/oci_utils.py` & `skypilot-0.6.0/sky/clouds/utils/oci_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/clouds/utils/scp_utils.py` & `skypilot-0.6.0/sky/clouds/utils/scp_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/clouds/vsphere.py` & `skypilot-0.6.0/sky/clouds/vsphere.py`

 * *Files 2% similar despite different names*

```diff
@@ -132,18 +132,14 @@
     def get_egress_cost(self, num_gigabytes: float) -> float:
         # vSphere doesn't support this part.
         return 0.0
 
     def __repr__(self):
         return 'vSphere'
 
-    def is_same_cloud(self, other: clouds.Cloud) -> bool:
-        # Returns true if the two clouds are the same cloud type.
-        return isinstance(other, Vsphere)
-
     @classmethod
     def get_default_instance_type(
         cls,
         cpus: Optional[str] = None,
         memory: Optional[str] = None,
         disk_tier: Optional[resources_utils.DiskTier] = None,
     ) -> Optional[str]:
```

### Comparing `skypilot-0.5.0/sky/core.py` & `skypilot-0.6.0/sky/core.py`

 * *Files 16% similar despite different names*

```diff
@@ -1,33 +1,29 @@
 """SDK functions for cluster/job management."""
 import getpass
-import sys
 import typing
 from typing import Any, Dict, List, Optional, Union
 
 import colorama
 
 from sky import backends
 from sky import clouds
 from sky import dag
 from sky import data
 from sky import exceptions
 from sky import global_user_state
 from sky import sky_logging
-from sky import spot
 from sky import status_lib
 from sky import task
 from sky.backends import backend_utils
 from sky.skylet import constants
 from sky.skylet import job_lib
 from sky.usage import usage_lib
 from sky.utils import controller_utils
-from sky.utils import rich_utils
 from sky.utils import subprocess_utils
-from sky.utils import ux_utils
 
 if typing.TYPE_CHECKING:
     from sky import resources as resources_lib
 
 logger = sky_logging.init_logger(__name__)
 
 # ======================
@@ -109,14 +105,34 @@
         be omitted from the returned list.
     """
     return backend_utils.get_clusters(include_controller=True,
                                       refresh=refresh,
                                       cluster_names=cluster_names)
 
 
+def endpoints(cluster: str,
+              port: Optional[Union[int, str]] = None) -> Dict[int, str]:
+    """Gets the endpoint for a given cluster and port number (endpoint).
+
+    Args:
+        cluster: The name of the cluster.
+        port: The port number to get the endpoint for. If None, endpoints
+            for all ports are returned..
+
+    Returns: A dictionary of port numbers to endpoints. If endpoint is None,
+        the dictionary will contain all ports:endpoints exposed on the cluster.
+
+    Raises:
+        ValueError: if the cluster is not UP or the endpoint is not exposed.
+        RuntimeError: if the cluster has no ports to be exposed or no endpoints
+            are exposed yet.
+    """
+    return backend_utils.get_endpoints(cluster=cluster, port=port)
+
+
 @usage_lib.entrypoint
 def cost_report() -> List[Dict[str, Any]]:
     # NOTE(dev): Keep the docstring consistent between the Python API and CLI.
     """Get all cluster cost reports, including those that have been downed.
 
     Each returned value has the following fields:
 
@@ -196,16 +212,14 @@
                 'Passing a custom autostop setting is currently not '
                 'supported when starting SkyPilot controllers. To '
                 'fix: omit the `idle_minutes_to_autostop` argument to use the '
                 f'default autostop settings (got: {idle_minutes_to_autostop}).')
         idle_minutes_to_autostop = (
             constants.CONTROLLER_IDLE_MINUTES_TO_AUTOSTOP)
 
-    # NOTE: if spot_queue() calls _start() and hits here, that entrypoint
-    # would have a cluster name (the controller) filled in.
     usage_lib.record_cluster_name_for_current_operation(cluster_name)
 
     with dag.Dag():
         dummy_task = task.Task().set_resources(handle.launched_resources)
         dummy_task.num_nodes = handle.launched_nodes
     handle = backend.provision(dummy_task,
                                to_provision=handle.launched_resources,
@@ -227,15 +241,15 @@
 @usage_lib.entrypoint
 def start(
     cluster_name: str,
     idle_minutes_to_autostop: Optional[int] = None,
     retry_until_up: bool = False,
     down: bool = False,  # pylint: disable=redefined-outer-name
     force: bool = False,
-) -> None:
+) -> backends.CloudVmRayResourceHandle:
     # NOTE(dev): Keep the docstring consistent between the Python API and CLI.
     """Restart a cluster.
 
     If a cluster is previously stopped (status is STOPPED) or failed in
     provisioning/runtime installation (status is INIT), this function will
     attempt to start the cluster.  In the latter case, provisioning and runtime
     installation will be retried.
@@ -264,31 +278,31 @@
         force: whether to force start the cluster even if it is already up.
             Useful for upgrading SkyPilot runtime.
 
     Raises:
         ValueError: argument values are invalid: (1) the specified cluster does
           not exist; (2) if ``down`` is set to True but
           ``idle_minutes_to_autostop`` is None; (3) if the specified cluster is
-          the managed spot controller, and either ``idle_minutes_to_autostop``
+          the managed jobs controller, and either ``idle_minutes_to_autostop``
           is not None or ``down`` is True (omit them to use the default
           autostop settings).
         sky.exceptions.NotSupportedError: if the cluster to restart was
           launched using a non-default backend that does not support this
           operation.
         sky.exceptions.ClusterOwnerIdentitiesMismatchError: if the cluster to
             restart was launched by a different user.
     """
     if down and idle_minutes_to_autostop is None:
         raise ValueError(
             '`idle_minutes_to_autostop` must be set if `down` is True.')
-    _start(cluster_name,
-           idle_minutes_to_autostop,
-           retry_until_up,
-           down,
-           force=force)
+    return _start(cluster_name,
+                  idle_minutes_to_autostop,
+                  retry_until_up,
+                  down,
+                  force=force)
 
 
 def _stop_not_supported_message(resources: 'resources_lib.Resources') -> str:
     if resources.use_spot:
         message = ('Stopping spot instances is currently not supported on '
                    f'{resources.cloud}')
     else:
@@ -306,21 +320,26 @@
     disks will be reattached when restarting the cluster.
 
     Currently, spot instance clusters cannot be stopped (except for GCP, which
     does allow disk contents to be preserved when stopping spot VMs).
 
     Args:
         cluster_name: name of the cluster to stop.
-        purge: whether to ignore cloud provider errors (if any).
+        purge: (Advanced) Forcefully mark the cluster as stopped in SkyPilot's
+            cluster table, even if the actual cluster stop operation failed on
+            the cloud. WARNING: This flag should only be set sparingly in
+            certain manual troubleshooting scenarios; with it set, it is the
+            user's responsibility to ensure there are no leaked instances and
+            related resources.
 
     Raises:
         ValueError: the specified cluster does not exist.
         RuntimeError: failed to stop the cluster.
         sky.exceptions.NotSupportedError: if the specified cluster is a spot
-          cluster, or a TPU VM Pod cluster, or the managed spot controller.
+          cluster, or a TPU VM Pod cluster, or the managed jobs controller.
     """
     if controller_utils.Controllers.from_name(cluster_name) is not None:
         raise exceptions.NotSupportedError(
             f'Stopping SkyPilot controller {cluster_name!r} '
             f'is not supported.')
     handle = global_user_state.get_handle_from_cluster_name(cluster_name)
     if handle is None:
@@ -356,21 +375,26 @@
 
     Tearing down a cluster will delete all associated resources (all billing
     stops), and any data on the attached disks will be lost.  Accelerators
     (e.g., TPUs) that are part of the cluster will be deleted too.
 
     Args:
         cluster_name: name of the cluster to down.
-        purge: whether to ignore cloud provider errors (if any).
+        purge: (Advanced) Forcefully remove the cluster from SkyPilot's cluster
+            table, even if the actual cluster termination failed on the cloud.
+            WARNING: This flag should only be set sparingly in certain manual
+            troubleshooting scenarios; with it set, it is the user's
+            responsibility to ensure there are no leaked instances and related
+            resources.
 
     Raises:
         ValueError: the specified cluster does not exist.
         RuntimeError: failed to tear down the cluster.
         sky.exceptions.NotSupportedError: the specified cluster is the managed
-          spot controller.
+          jobs controller.
     """
     handle = global_user_state.get_handle_from_cluster_name(cluster_name)
     if handle is None:
         raise ValueError(f'Cluster {cluster_name!r} does not exist.')
 
     usage_lib.record_cluster_name_for_current_operation(cluster_name)
     backend = backend_utils.get_backend_from_handle(handle)
@@ -460,14 +484,27 @@
         except exceptions.NotSupportedError as e:
             raise exceptions.NotSupportedError(
                 f'{colorama.Fore.YELLOW}Scheduling autostop on cluster '
                 f'{cluster_name!r}...skipped.{colorama.Style.RESET_ALL}\n'
                 f'  {_stop_not_supported_message(handle.launched_resources)}.'
             ) from e
 
+    # Check if autodown is required and supported
+    if not is_cancel:
+        try:
+            cloud.check_features_are_supported(
+                handle.launched_resources,
+                {clouds.CloudImplementationFeatures.AUTO_TERMINATE})
+        except exceptions.NotSupportedError as e:
+            raise exceptions.NotSupportedError(
+                f'{colorama.Fore.YELLOW}{operation} on cluster '
+                f'{cluster_name!r}...skipped.{colorama.Style.RESET_ALL}\n'
+                f'  Auto{option_str} is not supported on {cloud!r} - '
+                f'see reason above.') from e
+
     usage_lib.record_cluster_name_for_current_operation(cluster_name)
     backend.set_autostop(handle, idle_minutes, down)
 
 
 # ==================
 # = Job Management =
 # ==================
@@ -549,15 +586,15 @@
     Please refer to the sky.cli.cancel for the document.
 
     When `all` is False and `job_ids` is None, cancel the latest running job.
 
     Additional arguments:
         _try_cancel_if_cluster_is_init: (bool) whether to try cancelling the job
             even if the cluster is not UP, but the head node is still alive.
-            This is used by the spot controller to cancel the job when the
+            This is used by the jobs controller to cancel the job when the
             worker node is preempted in the spot cluster.
 
     Raises:
         ValueError: if arguments are invalid, or the cluster does not exist.
         sky.exceptions.ClusterNotUpError: if the cluster is not UP.
         sky.exceptions.NotSupportedError: if the specified cluster is a
           controller that does not support this operation.
@@ -749,214 +786,14 @@
                       f'{colorama.Style.RESET_ALL}')
 
     usage_lib.record_cluster_name_for_current_operation(cluster_name)
     statuses = backend.get_job_status(handle, job_ids, stream_logs=stream_logs)
     return statuses
 
 
-# =======================
-# = Spot Job Management =
-# =======================
-
-
-@usage_lib.entrypoint
-def spot_status(refresh: bool) -> List[Dict[str, Any]]:
-    """[Deprecated] (alias of spot_queue) Get statuses of managed spot jobs."""
-    sky_logging.print(
-        f'{colorama.Fore.YELLOW}WARNING: `spot_status()` is deprecated. '
-        f'Instead, use: spot_queue(){colorama.Style.RESET_ALL}',
-        file=sys.stderr)
-    return spot_queue(refresh=refresh)
-
-
-@usage_lib.entrypoint
-def spot_queue(refresh: bool,
-               skip_finished: bool = False) -> List[Dict[str, Any]]:
-    # NOTE(dev): Keep the docstring consistent between the Python API and CLI.
-    """Get statuses of managed spot jobs.
-
-    Please refer to the sky.cli.spot_queue for the documentation.
-
-    Returns:
-        [
-            {
-                'job_id': int,
-                'job_name': str,
-                'resources': str,
-                'submitted_at': (float) timestamp of submission,
-                'end_at': (float) timestamp of end,
-                'duration': (float) duration in seconds,
-                'retry_count': int Number of retries,
-                'status': sky.JobStatus status of the job,
-                'cluster_resources': (str) resources of the cluster,
-                'region': (str) region of the cluster,
-            }
-        ]
-    Raises:
-        sky.exceptions.ClusterNotUpError: the spot controller is not up or
-            does not exist.
-        RuntimeError: if failed to get the spot jobs with ssh.
-    """
-
-    stop_msg = ''
-    if not refresh:
-        stop_msg = 'To view the latest job table: sky spot queue --refresh'
-    controller_status, handle = backend_utils.is_controller_up(
-        controller_type=controller_utils.Controllers.SPOT_CONTROLLER,
-        stopped_message=stop_msg)
-
-    if (refresh and controller_status in [
-            status_lib.ClusterStatus.STOPPED, status_lib.ClusterStatus.INIT
-    ]):
-        sky_logging.print(f'{colorama.Fore.YELLOW}'
-                          'Restarting controller for latest status...'
-                          f'{colorama.Style.RESET_ALL}')
-
-        rich_utils.force_update_status('[cyan] Checking spot jobs - restarting '
-                                       'controller[/]')
-        handle = _start(spot.SPOT_CONTROLLER_NAME)
-        controller_status = status_lib.ClusterStatus.UP
-        rich_utils.force_update_status('[cyan] Checking spot jobs[/]')
-
-    if handle is None or handle.head_ip is None:
-        # When the controller is STOPPED, the head_ip will be None, as
-        # it will be set in global_user_state.remove_cluster().
-        # We do not directly check for UP because the controller may be
-        # in INIT state during another spot launch, but still have
-        # head_ip available. In this case, we can still try to ssh
-        # into the controller and fetch the job table.
-        raise exceptions.ClusterNotUpError('Spot controller is not up.',
-                                           cluster_status=controller_status)
-
-    backend = backend_utils.get_backend_from_handle(handle)
-    assert isinstance(backend, backends.CloudVmRayBackend)
-
-    code = spot.SpotCodeGen.get_job_table()
-    returncode, job_table_payload, stderr = backend.run_on_head(
-        handle,
-        code,
-        require_outputs=True,
-        stream_logs=False,
-        separate_stderr=True)
-    try:
-        subprocess_utils.handle_returncode(returncode,
-                                           code,
-                                           'Failed to fetch managed spot jobs',
-                                           stderr,
-                                           stream_logs=False)
-    except exceptions.CommandError as e:
-        raise RuntimeError(e.error_msg) from e
-
-    jobs = spot.load_spot_job_queue(job_table_payload)
-    if skip_finished:
-        # Filter out the finished jobs. If a multi-task job is partially
-        # finished, we will include all its tasks.
-        non_finished_tasks = list(
-            filter(lambda job: not job['status'].is_terminal(), jobs))
-        non_finished_job_ids = {job['job_id'] for job in non_finished_tasks}
-        jobs = list(
-            filter(lambda job: job['job_id'] in non_finished_job_ids, jobs))
-    return jobs
-
-
-@usage_lib.entrypoint
-# pylint: disable=redefined-builtin
-def spot_cancel(name: Optional[str] = None,
-                job_ids: Optional[List[int]] = None,
-                all: bool = False) -> None:
-    # NOTE(dev): Keep the docstring consistent between the Python API and CLI.
-    """Cancel managed spot jobs.
-
-    Please refer to the sky.cli.spot_cancel for the document.
-
-    Raises:
-        sky.exceptions.ClusterNotUpError: the spot controller is not up.
-        RuntimeError: failed to cancel the job.
-    """
-    job_ids = [] if job_ids is None else job_ids
-    cluster_status, handle = backend_utils.is_controller_up(
-        controller_type=controller_utils.Controllers.SPOT_CONTROLLER,
-        stopped_message='All managed spot jobs should have finished.')
-    if handle is None or handle.head_ip is None:
-        # The error message is already printed in
-        # backend_utils.is_controller_up
-        # TODO(zhwu): Move the error message into the exception.
-        with ux_utils.print_exception_no_traceback():
-            raise exceptions.ClusterNotUpError(message='',
-                                               cluster_status=cluster_status)
-
-    job_id_str = ','.join(map(str, job_ids))
-    if sum([len(job_ids) > 0, name is not None, all]) != 1:
-        argument_str = f'job_ids={job_id_str}' if len(job_ids) > 0 else ''
-        argument_str += f' name={name}' if name is not None else ''
-        argument_str += ' all' if all else ''
-        raise ValueError('Can only specify one of JOB_IDS or name or all. '
-                         f'Provided {argument_str!r}.')
-
-    backend = backend_utils.get_backend_from_handle(handle)
-    assert isinstance(backend, backends.CloudVmRayBackend)
-    if all:
-        code = spot.SpotCodeGen.cancel_jobs_by_id(None)
-    elif job_ids:
-        code = spot.SpotCodeGen.cancel_jobs_by_id(job_ids)
-    else:
-        assert name is not None, (job_ids, name, all)
-        code = spot.SpotCodeGen.cancel_job_by_name(name)
-    # The stderr is redirected to stdout
-    returncode, stdout, _ = backend.run_on_head(handle,
-                                                code,
-                                                require_outputs=True,
-                                                stream_logs=False)
-    try:
-        subprocess_utils.handle_returncode(returncode, code,
-                                           'Failed to cancel managed spot job',
-                                           stdout)
-    except exceptions.CommandError as e:
-        raise RuntimeError(e.error_msg) from e
-
-    sky_logging.print(stdout)
-    if 'Multiple jobs found with name' in stdout:
-        with ux_utils.print_exception_no_traceback():
-            raise RuntimeError(
-                'Please specify the job ID instead of the job name.')
-
-
-@usage_lib.entrypoint
-def spot_tail_logs(name: Optional[str], job_id: Optional[int],
-                   follow: bool) -> None:
-    # NOTE(dev): Keep the docstring consistent between the Python API and CLI.
-    """Tail logs of managed spot jobs.
-
-    Please refer to the sky.cli.spot_logs for the document.
-
-    Raises:
-        ValueError: invalid arguments.
-        sky.exceptions.ClusterNotUpError: the spot controller is not up.
-    """
-    # TODO(zhwu): Automatically restart the spot controller
-    controller_status, handle = backend_utils.is_controller_up(
-        controller_type=controller_utils.Controllers.SPOT_CONTROLLER,
-        stopped_message=('Please restart the spot controller with '
-                         f'`sky start {spot.SPOT_CONTROLLER_NAME}`.'))
-    if handle is None or handle.head_ip is None:
-        msg = 'All jobs finished.'
-        if controller_status == status_lib.ClusterStatus.INIT:
-            msg = ''
-        with ux_utils.print_exception_no_traceback():
-            raise exceptions.ClusterNotUpError(msg,
-                                               cluster_status=controller_status)
-
-    if name is not None and job_id is not None:
-        raise ValueError('Cannot specify both name and job_id.')
-    backend = backend_utils.get_backend_from_handle(handle)
-    assert isinstance(backend, backends.CloudVmRayBackend), backend
-    # Stream the realtime logs
-    backend.tail_spot_logs(handle, job_id=job_id, job_name=name, follow=follow)
-
-
 # ======================
 # = Storage Management =
 # ======================
 @usage_lib.entrypoint
 def storage_ls() -> List[Dict[str, Any]]:
     # NOTE(dev): Keep the docstring consistent between the Python API and CLI.
     """Get the storages.
```

### Comparing `skypilot-0.5.0/sky/dag.py` & `skypilot-0.6.0/sky/dag.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/data/data_transfer.py` & `skypilot-0.6.0/sky/data/data_transfer.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/data/data_utils.py` & `skypilot-0.6.0/sky/data/data_utils.py`

 * *Files 2% similar despite different names*

```diff
@@ -86,20 +86,23 @@
 
     if region not in get_cos_regions():
         raise ValueError('region missing/invalid in IBM COS URI.')
 
     return bucket_name, data_path, region
 
 
-def create_s3_client(region: str = 'us-east-2') -> Client:
+def create_s3_client(region: Optional[str] = None) -> Client:
     """Helper method that connects to Boto3 client for S3 Bucket
 
     Args:
-      region: str; Region name, e.g. us-west-1, us-east-2
+      region: str; Region name, e.g. us-west-1, us-east-2. If None, default
+        region us-east-1 is used.
     """
+    if region is None:
+        region = 'us-east-1'
     return aws.client('s3', region_name=region)
 
 
 def verify_s3_bucket(name: str) -> bool:
     """Helper method that checks if the S3 bucket exists
 
     Args:
```

### Comparing `skypilot-0.5.0/sky/data/mounting_utils.py` & `skypilot-0.6.0/sky/data/mounting_utils.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,13 +1,14 @@
 """Helper functions for object store mounting in Sky Storage"""
 import random
 import textwrap
 from typing import Optional
 
 from sky import exceptions
+from sky.utils import command_runner
 
 # Values used to construct mounting commands
 _STAT_CACHE_TTL = '5s'
 _STAT_CACHE_CAPACITY = 4096
 _TYPE_CACHE_TTL = '5s'
 _RENAME_DIR_LIMIT = 10000
 # https://github.com/GoogleCloudPlatform/gcsfuse/releases
@@ -125,14 +126,16 @@
     installed_check = f'[ -x "$(command -v {mount_binary})" ]'
     if version_check_cmd is not None:
         installed_check += f' && {version_check_cmd}'
 
     script = textwrap.dedent(f"""
         #!/usr/bin/env bash
         set -e
+                             
+        {command_runner.ALIAS_SUDO_TO_EMPTY_FOR_ROOT_CMD}
 
         MOUNT_PATH={mount_path}
         MOUNT_BINARY={mount_binary}
 
         # Check if path is already mounted
         if grep -q $MOUNT_PATH /proc/mounts ; then
             echo "Path already mounted - unmounting..."
```

### Comparing `skypilot-0.5.0/sky/data/storage.py` & `skypilot-0.6.0/sky/data/storage.py`

 * *Files 2% similar despite different names*

```diff
@@ -7,15 +7,15 @@
 import time
 import typing
 from typing import Any, Dict, List, Optional, Tuple, Type, Union
 import urllib.parse
 
 import colorama
 
-from sky import check
+from sky import check as sky_check
 from sky import clouds
 from sky import exceptions
 from sky import global_user_state
 from sky import sky_logging
 from sky import status_lib
 from sky.adaptors import aws
 from sky.adaptors import cloudflare
@@ -64,45 +64,74 @@
     'your cloud credentials have access to it.')
 
 _BUCKET_EXTERNALLY_DELETED_DEBUG_MESSAGE = (
     'Bucket {bucket_name!r} does not exist. '
     'It may have been deleted externally.')
 
 
+def get_cached_enabled_storage_clouds_or_refresh(
+        raise_if_no_cloud_access: bool = False) -> List[str]:
+    # This is a temporary solution until https://github.com/skypilot-org/skypilot/issues/1943 # pylint: disable=line-too-long
+    # is resolved by implementing separate 'enabled_storage_clouds'
+    enabled_clouds = sky_check.get_cached_enabled_clouds_or_refresh()
+    enabled_clouds = [str(cloud) for cloud in enabled_clouds]
+
+    enabled_storage_clouds = [
+        cloud for cloud in enabled_clouds if cloud in STORE_ENABLED_CLOUDS
+    ]
+    r2_is_enabled, _ = cloudflare.check_credentials()
+    if r2_is_enabled:
+        enabled_storage_clouds.append(cloudflare.NAME)
+    if raise_if_no_cloud_access and not enabled_storage_clouds:
+        raise exceptions.NoCloudAccessError(
+            'No cloud access available for storage. '
+            'Please check your cloud credentials.')
+    return enabled_storage_clouds
+
+
 def _is_storage_cloud_enabled(cloud_name: str,
                               try_fix_with_sky_check: bool = True) -> bool:
-    enabled_storage_clouds = global_user_state.get_enabled_storage_clouds()
+    enabled_storage_clouds = get_cached_enabled_storage_clouds_or_refresh()
     if cloud_name in enabled_storage_clouds:
         return True
     if try_fix_with_sky_check:
         # TODO(zhwu): Only check the specified cloud to speed up.
-        check.check(quiet=True)
+        sky_check.check(quiet=True)
         return _is_storage_cloud_enabled(cloud_name,
                                          try_fix_with_sky_check=False)
     return False
 
 
 class StoreType(enum.Enum):
     """Enum for the different types of stores."""
     S3 = 'S3'
     GCS = 'GCS'
     AZURE = 'AZURE'
     R2 = 'R2'
     IBM = 'IBM'
 
     @classmethod
-    def from_cloud(cls, cloud: clouds.Cloud) -> 'StoreType':
-        if isinstance(cloud, clouds.AWS):
+    def from_cloud(cls, cloud: str) -> 'StoreType':
+        if cloud.lower() == str(clouds.AWS()).lower():
             return StoreType.S3
-        elif isinstance(cloud, clouds.GCP):
+        elif cloud.lower() == str(clouds.GCP()).lower():
             return StoreType.GCS
-        elif isinstance(cloud, clouds.Azure):
-            return StoreType.AZURE
-        elif isinstance(cloud, clouds.IBM):
+        elif cloud.lower() == str(clouds.IBM()).lower():
             return StoreType.IBM
+        elif cloud.lower() == cloudflare.NAME.lower():
+            return StoreType.R2
+        elif cloud.lower() == str(clouds.Azure()).lower():
+            with ux_utils.print_exception_no_traceback():
+                raise ValueError('Azure Blob Storage is not supported yet.')
+        elif cloud.lower() == str(clouds.Lambda()).lower():
+            with ux_utils.print_exception_no_traceback():
+                raise ValueError('Lambda Cloud does not provide cloud storage.')
+        elif cloud.lower() == str(clouds.SCP()).lower():
+            with ux_utils.print_exception_no_traceback():
+                raise ValueError('SCP does not provide cloud storage.')
 
         raise ValueError(f'Unsupported cloud for StoreType: {cloud}')
 
     @classmethod
     def from_store(cls, store: 'AbstractStore') -> 'StoreType':
         if isinstance(store, S3Store):
             return StoreType.S3
@@ -112,59 +141,36 @@
             return StoreType.R2
         elif isinstance(store, IBMCosStore):
             return StoreType.IBM
         else:
             with ux_utils.print_exception_no_traceback():
                 raise ValueError(f'Unknown store type: {store}')
 
+    def store_prefix(self) -> str:
+        if self == StoreType.S3:
+            return 's3://'
+        elif self == StoreType.GCS:
+            return 'gs://'
+        elif self == StoreType.R2:
+            return 'r2://'
+        elif self == StoreType.IBM:
+            return 'cos://'
+        elif self == StoreType.AZURE:
+            with ux_utils.print_exception_no_traceback():
+                raise ValueError('Azure Blob Storage is not supported yet.')
+        else:
+            with ux_utils.print_exception_no_traceback():
+                raise ValueError(f'Unknown store type: {self}')
+
 
 class StorageMode(enum.Enum):
     MOUNT = 'MOUNT'
     COPY = 'COPY'
 
 
-def get_storetype_from_cloud(cloud: clouds.Cloud) -> StoreType:
-    if isinstance(cloud, clouds.AWS):
-        return StoreType.S3
-    elif isinstance(cloud, clouds.GCP):
-        return StoreType.GCS
-    elif isinstance(cloud, clouds.IBM):
-        return StoreType.IBM
-    elif isinstance(cloud, clouds.Azure):
-        with ux_utils.print_exception_no_traceback():
-            raise ValueError('Azure Blob Storage is not supported yet.')
-    elif isinstance(cloud, clouds.Lambda):
-        with ux_utils.print_exception_no_traceback():
-            raise ValueError('Lambda Cloud does not provide cloud storage.')
-    elif isinstance(cloud, clouds.SCP):
-        with ux_utils.print_exception_no_traceback():
-            raise ValueError('SCP does not provide cloud storage.')
-    else:
-        with ux_utils.print_exception_no_traceback():
-            raise ValueError(f'Unknown cloud type: {cloud}')
-
-
-def get_store_prefix(storetype: StoreType) -> str:
-    if storetype == StoreType.S3:
-        return 's3://'
-    elif storetype == StoreType.GCS:
-        return 'gs://'
-    # R2 storages use 's3://' as a prefix for various aws cli commands
-    elif storetype == StoreType.R2:
-        return 's3://'
-    elif storetype == StoreType.IBM:
-        return 'cos://'
-    elif storetype == StoreType.AZURE:
-        with ux_utils.print_exception_no_traceback():
-            raise ValueError('Azure Blob Storage is not supported yet.')
-    else:
-        with ux_utils.print_exception_no_traceback():
-            raise ValueError(f'Unknown store type: {storetype}')
-
-
 class AbstractStore:
     """AbstractStore abstracts away the different storage types exposed by
     different clouds.
 
     Storage objects are backed by AbstractStores, each representing a store
     present in a cloud.
     """
@@ -329,22 +335,26 @@
             handle = global_user_state.get_handle_from_storage_name(self.name)
             # If handle is None, it implies the bucket is created
             # externally and not managed by Skypilot. For mounting such
             # externally created buckets, users must provide the
             # bucket's URL as 'source'.
             if handle is None:
                 with ux_utils.print_exception_no_traceback():
+                    store_prefix = StoreType.from_store(self).store_prefix()
                     raise exceptions.StorageSpecError(
                         'Attempted to mount a non-sky managed bucket '
                         f'{self.name!r} without specifying the storage source.'
-                        ' To mount an externally created bucket (e.g., '
+                        f' Bucket {self.name!r} already exists. \n'
+                        '     To create a new bucket, specify a unique name.\n'
+                        '     To mount an externally created bucket (e.g., '
                         'created through cloud console or cloud cli), '
                         'specify the bucket URL in the source field '
-                        'instead of its name. E.g., replace `name: external-'
-                        'bucket` with `source: gs://external-bucket`.')
+                        'instead of its name. I.e., replace '
+                        f'`name: {self.name}` with '
+                        f'`source: {store_prefix}{self.name}`.')
 
 
 class Storage(object):
     """Storage objects handle persistent and large volume storage in the sky.
 
     Storage represents an abstract data store containing large data files
     required by the task. Compared to file_mounts, storage is faster and
@@ -783,22 +793,26 @@
         # For backward compatibility
         if hasattr(metadata, 'mode'):
             if metadata.mode:
                 storage_obj.mode = override_args.get('mode', metadata.mode)
 
         return storage_obj
 
-    def add_store(self, store_type: Union[str, StoreType]) -> AbstractStore:
+    def add_store(self,
+                  store_type: Union[str, StoreType],
+                  region: Optional[str] = None) -> AbstractStore:
         """Initializes and adds a new store to the storage.
 
         Invoked by the optimizer after it has selected a store to
         add it to Storage.
 
         Args:
           store_type: StoreType; Type of the storage [S3, GCS, AZURE, R2, IBM]
+          region: str; Region to place the bucket in. Caller must ensure that
+            the region is valid for the chosen store_type.
         """
         if isinstance(store_type, str):
             store_type = StoreType(store_type)
 
         if store_type in self.stores:
             logger.info(f'Storage type {store_type} already exists.')
             return self.stores[store_type]
@@ -818,14 +832,15 @@
                     f'{store_type} not supported as a Store.')
 
         # Initialize store object and get/create bucket
         try:
             store = store_cls(
                 name=self.name,
                 source=self.source,
+                region=region,
                 sync_on_reconstruction=self.sync_on_reconstruction)
         except exceptions.StorageBucketCreateError:
             # Creation failed, so this must be sky managed store. Add failure
             # to state.
             logger.error(f'Could not create {store_type} store '
                          f'with name {self.name}.')
             global_user_state.set_storage_status(self.name,
@@ -1302,15 +1317,15 @@
                     f'{self.source}` to debug.')
 
         # If bucket cannot be found in both private and public settings,
         # the bucket is to be created by Sky. However, creation is skipped if
         # Store object is being reconstructed for deletion or re-mount with
         # sky start, and error is raised instead.
         if self.sync_on_reconstruction:
-            bucket = self._create_s3_bucket(self.name)
+            bucket = self._create_s3_bucket(self.name, self.region)
             return bucket, True
         else:
             # Raised when Storage object is reconstructed for sky storage
             # delete or to re-mount Storages with sky start but the storage
             # is already removed externally.
             raise exceptions.StorageExternalDeletionError(
                 'Attempted to fetch a non-existent bucket: '
@@ -1352,17 +1367,23 @@
           StorageBucketCreateError: If bucket creation fails.
         """
         s3_client = self.client
         try:
             if region is None:
                 s3_client.create_bucket(Bucket=bucket_name)
             else:
-                location = {'LocationConstraint': region}
-                s3_client.create_bucket(Bucket=bucket_name,
-                                        CreateBucketConfiguration=location)
+                if region == 'us-east-1':
+                    # If default us-east-1 region is used, the
+                    # LocationConstraint must not be specified.
+                    # https://stackoverflow.com/a/51912090
+                    s3_client.create_bucket(Bucket=bucket_name)
+                else:
+                    location = {'LocationConstraint': region}
+                    s3_client.create_bucket(Bucket=bucket_name,
+                                            CreateBucketConfiguration=location)
                 logger.info(f'Created S3 bucket {bucket_name} in {region}')
         except aws.botocore_exceptions().ClientError as e:
             with ux_utils.print_exception_no_traceback():
                 raise exceptions.StorageBucketCreateError(
                     f'Attempted to create a bucket '
                     f'{self.name} but failed.') from e
         return aws.resource('s3').Bucket(bucket_name)
@@ -1728,15 +1749,15 @@
                         f'{self.source}') from e
             else:
                 # If bucket cannot be found (i.e., does not exist), it is to be
                 # created by Sky. However, creation is skipped if Store object
                 # is being reconstructed for deletion or re-mount with
                 # sky start, and error is raised instead.
                 if self.sync_on_reconstruction:
-                    bucket = self._create_gcs_bucket(self.name)
+                    bucket = self._create_gcs_bucket(self.name, self.region)
                     return bucket, True
                 else:
                     # This is raised when Storage object is reconstructed for
                     # sky storage delete or to re-mount Storages with sky start
                     # but the storage is already removed externally.
                     raise exceptions.StorageExternalDeletionError(
                         'Attempted to fetch a non-existent bucket: '
```

#### encoding

```diff
@@ -1 +1 @@
-us-ascii
+utf-8
```

### Comparing `skypilot-0.5.0/sky/data/storage_utils.py` & `skypilot-0.6.0/sky/data/storage_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/exceptions.py` & `skypilot-0.6.0/sky/exceptions.py`

 * *Files 2% similar despite different names*

```diff
@@ -48,35 +48,36 @@
 
 class InvalidCloudConfigs(Exception):
     """Raised when invalid configurations are provided for a given cloud."""
     pass
 
 
 class ProvisionPrechecksError(Exception):
-    """Raised when a spot job fails prechecks before provision.
+    """Raised when a managed job fails prechecks before provision.
+
     Developer note: For now this should only be used by managed
-    spot code path (technically, this can/should be raised by the
+    jobs code path (technically, this can/should be raised by the
     lower-level sky.launch()). Please refer to the docstring of
-    `spot.recovery_strategy._launch` for more details about when
+    `jobs.recovery_strategy._launch` for more details about when
     the error will be raised.
 
     Args:
         reasons: (List[Exception]) The reasons why the prechecks failed.
     """
 
     def __init__(self, reasons: List[Exception]) -> None:
         super().__init__()
         self.reasons = list(reasons)
 
 
-class SpotJobReachedMaxRetriesError(Exception):
-    """Raised when a spot job fails to be launched after maximum retries.
+class ManagedJobReachedMaxRetriesError(Exception):
+    """Raised when a managed job fails to be launched after maximum retries.
 
-    Developer note: For now this should only be used by managed spot code
-    path. Please refer to the docstring of `spot.recovery_strategy._launch`
+    Developer note: For now this should only be used by managed jobs code
+    path. Please refer to the docstring of `jobs.recovery_strategy._launch`
     for more details about when the error will be raised.
     """
     pass
 
 
 class ResourcesMismatchError(Exception):
     """Raised when resources are mismatched."""
@@ -185,16 +186,16 @@
 
 class StorageExternalDeletionError(StorageBucketGetError):
     # Error raised when the bucket is attempted to be fetched while it has been
     # deleted externally.
     pass
 
 
-class FetchIPError(Exception):
-    """Raised when fetching the IP fails."""
+class FetchClusterInfoError(Exception):
+    """Raised when fetching the cluster info fails."""
 
     class Reason(enum.Enum):
         HEAD = 'HEAD'
         WORKER = 'WORKER'
 
     def __init__(self, reason: Reason) -> None:
         super().__init__()
@@ -207,16 +208,16 @@
 
 
 class ClusterStatusFetchingError(Exception):
     """Raised when fetching the cluster status fails."""
     pass
 
 
-class SpotUserCancelledError(Exception):
-    """Raised when a spot user cancels the job."""
+class ManagedJobUserCancelledError(Exception):
+    """Raised when a user cancels a managed job."""
     pass
 
 
 class InvalidClusterNameError(Exception):
     """Raised when the cluster name is invalid."""
     pass
```

### Comparing `skypilot-0.5.0/sky/execution.py` & `skypilot-0.6.0/sky/execution.py`

 * *Files 14% similar despite different names*

```diff
@@ -1,88 +1,35 @@
 """Execution layer.
 
 See `Stage` for a Task's life cycle.
 """
-import copy
 import enum
 import os
-import tempfile
-from typing import Any, List, Optional, Tuple, Union
-import uuid
+from typing import List, Optional, Tuple, Union
 
 import colorama
 
 import sky
 from sky import backends
 from sky import clouds
 from sky import global_user_state
 from sky import optimizer
 from sky import sky_logging
-from sky import spot
-from sky import task as task_lib
 from sky.backends import backend_utils
-from sky.skylet import constants
 from sky.usage import usage_lib
-from sky.utils import common_utils
 from sky.utils import controller_utils
 from sky.utils import dag_utils
 from sky.utils import env_options
 from sky.utils import rich_utils
 from sky.utils import subprocess_utils
 from sky.utils import timeline
 from sky.utils import ux_utils
 
 logger = sky_logging.init_logger(__name__)
 
-# Message thrown when APIs sky.{exec,launch,spot_launch}() received a string
-# instead of a Dag.  CLI (cli.py) is implemented by us so should not trigger
-# this.
-_ENTRYPOINT_STRING_AS_DAG_MESSAGE = """\
-Expected a sky.Task or sky.Dag but received a string.
-
-If you meant to run a command, make it a Task's run command:
-
-    task = sky.Task(run=command)
-
-The command can then be run as:
-
-  sky.exec(task, cluster_name=..., ...)
-  # Or use {'V100': 1}, 'V100:0.5', etc.
-  task.set_resources(sky.Resources(accelerators='V100:1'))
-  sky.exec(task, cluster_name=..., ...)
-
-  sky.launch(task, ...)
-
-  sky.spot_launch(task, ...)
-""".strip()
-
-
-def _convert_to_dag(entrypoint: Any) -> 'sky.Dag':
-    """Convert the entrypoint to a sky.Dag.
-
-    Raises TypeError if 'entrypoint' is not a 'sky.Task' or 'sky.Dag'.
-    """
-    # Not suppressing stacktrace: when calling this via API user may want to
-    # see their own program in the stacktrace. Our CLI impl would not trigger
-    # these errors.
-    if isinstance(entrypoint, str):
-        raise TypeError(_ENTRYPOINT_STRING_AS_DAG_MESSAGE)
-    elif isinstance(entrypoint, sky.Dag):
-        return copy.deepcopy(entrypoint)
-    elif isinstance(entrypoint, task_lib.Task):
-        entrypoint = copy.deepcopy(entrypoint)
-        with sky.Dag() as dag:
-            dag.add(entrypoint)
-            dag.name = entrypoint.name
-        return dag
-    else:
-        raise TypeError(
-            'Expected a sky.Task or sky.Dag but received argument of type: '
-            f'{type(entrypoint)}')
-
 
 class Stage(enum.Enum):
     """Stages for a run of a sky.Task."""
     # TODO: rename actual methods to be consistent.
     CLONE_DISK = enum.auto()
     OPTIMIZE = enum.auto()
     PROVISION = enum.auto()
@@ -157,15 +104,15 @@
     detach_setup: bool = False,
     detach_run: bool = False,
     idle_minutes_to_autostop: Optional[int] = None,
     no_setup: bool = False,
     clone_disk_from: Optional[str] = None,
     # Internal only:
     # pylint: disable=invalid-name
-    _is_launched_by_spot_controller: bool = False,
+    _is_launched_by_jobs_controller: bool = False,
     _is_launched_by_sky_serve_controller: bool = False,
 ) -> Tuple[Optional[int], Optional[backends.ResourceHandle]]:
     """Execute an entrypoint.
 
     If sky.Task is given or DAG has not been optimized yet, this will call
     sky.optimize() for the caller.
 
@@ -205,23 +152,23 @@
     Returns:
       job_id: Optional[int]; the job ID of the submitted job. None if the
         backend is not CloudVmRayBackend, or no job is submitted to
         the cluster.
       handle: Optional[backends.ResourceHandle]; the handle to the cluster. None
         if dryrun.
     """
-    dag = _convert_to_dag(entrypoint)
+    dag = dag_utils.convert_entrypoint_to_dag(entrypoint)
     assert len(dag) == 1, f'We support 1 task for now. {dag}'
     task = dag.tasks[0]
 
-    if task.need_spot_recovery:
+    if any(r.job_recovery is not None for r in task.resources):
         with ux_utils.print_exception_no_traceback():
             raise ValueError(
-                'Spot recovery is specified in the task. To launch the '
-                'managed spot job, please use: sky spot launch')
+                'Job recovery is specified in the task. To launch a '
+                'managed job, please use: sky jobs launch')
 
     cluster_exists = False
     if cluster_name is not None:
         existing_handle = global_user_state.get_handle_from_cluster_name(
             cluster_name)
         cluster_exists = existing_handle is not None
         # TODO(woosuk): If the cluster exists, print a warning that
@@ -229,16 +176,20 @@
         # unlike `gpus`.
 
     stages = stages if stages is not None else list(Stage)
 
     # Requested features that some clouds support and others don't.
     requested_features = set()
 
-    if task.num_nodes > 1:
-        requested_features.add(clouds.CloudImplementationFeatures.MULTI_NODE)
+    if controller_utils.Controllers.from_name(cluster_name) is not None:
+        requested_features.add(
+            clouds.CloudImplementationFeatures.HOST_CONTROLLERS)
+
+    # Add requested features from the task
+    requested_features |= task.get_required_cloud_features()
 
     backend = backend if backend is not None else backends.CloudVmRayBackend()
     if isinstance(backend, backends.CloudVmRayBackend):
         if down and idle_minutes_to_autostop is None:
             # Use auto{stop,down} to terminate the cluster after the task is
             # done.
             idle_minutes_to_autostop = 0
@@ -252,16 +203,20 @@
                 verb = 'torn down' if down else 'stopped'
                 logger.info(f'{colorama.Style.DIM}The cluster will '
                             f'be {verb} after 1 minutes of idleness '
                             '(after all jobs finish).'
                             f'{colorama.Style.RESET_ALL}')
                 idle_minutes_to_autostop = 1
             stages.remove(Stage.DOWN)
-            if not down:
-                requested_features.add(clouds.CloudImplementationFeatures.STOP)
+            if idle_minutes_to_autostop >= 0:
+                requested_features.add(
+                    clouds.CloudImplementationFeatures.AUTO_TERMINATE)
+                if not down:
+                    requested_features.add(
+                        clouds.CloudImplementationFeatures.STOP)
         # NOTE: in general we may not have sufficiently specified info
         # (cloud/resource) to check STOP_SPOT_INSTANCE here. This is checked in
         # the backend.
 
     elif idle_minutes_to_autostop is not None:
         # TODO(zhwu): Autostop is not supported for non-CloudVmRayBackend.
         with ux_utils.print_exception_no_traceback():
@@ -270,25 +225,28 @@
                 f' {backends.CloudVmRayBackend.NAME}')
 
     if Stage.CLONE_DISK in stages:
         task = _maybe_clone_disk_from_cluster(clone_disk_from, cluster_name,
                                               task)
 
     if not cluster_exists:
+        # If spot is launched on serve or jobs controller, we don't need to
+        # print out the hint.
         if (Stage.PROVISION in stages and task.use_spot and
-                not _is_launched_by_spot_controller):
+                not _is_launched_by_jobs_controller and
+                not _is_launched_by_sky_serve_controller):
             yellow = colorama.Fore.YELLOW
             bold = colorama.Style.BRIGHT
             reset = colorama.Style.RESET_ALL
             logger.info(
                 f'{yellow}Launching an unmanaged spot task, which does not '
                 f'automatically recover from preemptions.{reset}\n{yellow}To '
-                'get automatic recovery, use managed spot instead: '
-                f'{reset}{bold}sky spot launch{reset} {yellow}or{reset} '
-                f'{bold}sky.spot_launch(){reset}.')
+                'get automatic recovery, use managed job instead: '
+                f'{reset}{bold}sky jobs launch{reset} {yellow}or{reset} '
+                f'{bold}sky.jobs.launch(){reset}.')
 
         if Stage.OPTIMIZE in stages:
             if task.best_resources is None:
                 # TODO: fix this for the situation where number of requested
                 # accelerators is not an integer.
                 if isinstance(backend, backends.CloudVmRayBackend):
                     # TODO: adding this check because docker backend on a
@@ -360,27 +318,27 @@
                 backend.teardown_ephemeral_storage(task)
                 backend.teardown(handle, terminate=True)
     finally:
         controller = controller_utils.Controllers.from_name(cluster_name)
         if controller is None and not _is_launched_by_sky_serve_controller:
             # UX: print live clusters to make users aware (to save costs).
             #
-            # Don't print if this job is launched by the spot controller,
-            # because spot jobs are serverless, there can be many of them, and
-            # users tend to continuously monitor spot jobs using `sky spot
-            # status`. Also don't print if this job is a skyserve controller
+            # Don't print if this job is launched by the jobs controller,
+            # because managed jobs are serverless, there can be many of them,
+            # and users tend to continuously monitor managed jobs using `sky
+            # job queue`. Also don't print if this job is a skyserve controller
             # job or launched by a skyserve controller job, because the
             # redirect for this subprocess.run won't success and it will
             # pollute the controller logs.
             #
             # Disable the usage collection for this status command.
             env = dict(os.environ,
                        **{env_options.Options.DISABLE_LOGGING.value: '1'})
             subprocess_utils.run(
-                'sky status --no-show-spot-jobs --no-show-services', env=env)
+                'sky status --no-show-managed-jobs --no-show-services', env=env)
         print()
         print('\x1b[?25h', end='')  # Show cursor.
     return job_id, handle
 
 
 @timeline.event
 @usage_lib.entrypoint
@@ -396,15 +354,15 @@
     optimize_target: optimizer.OptimizeTarget = optimizer.OptimizeTarget.COST,
     detach_setup: bool = False,
     detach_run: bool = False,
     no_setup: bool = False,
     clone_disk_from: Optional[str] = None,
     # Internal only:
     # pylint: disable=invalid-name
-    _is_launched_by_spot_controller: bool = False,
+    _is_launched_by_jobs_controller: bool = False,
     _is_launched_by_sky_serve_controller: bool = False,
     _disable_controller_check: bool = False,
 ) -> Tuple[Optional[int], Optional[backends.ResourceHandle]]:
     # NOTE(dev): Keep the docstring consistent between the Python API and CLI.
     """Launch a cluster or task.
 
     The task's setup and run commands are executed under the task's workdir
@@ -506,15 +464,15 @@
         optimize_target=optimize_target,
         cluster_name=cluster_name,
         detach_setup=detach_setup,
         detach_run=detach_run,
         idle_minutes_to_autostop=idle_minutes_to_autostop,
         no_setup=no_setup,
         clone_disk_from=clone_disk_from,
-        _is_launched_by_spot_controller=_is_launched_by_spot_controller,
+        _is_launched_by_jobs_controller=_is_launched_by_jobs_controller,
         _is_launched_by_sky_serve_controller=
         _is_launched_by_sky_serve_controller,
     )
 
 
 @usage_lib.entrypoint
 def exec(  # pylint: disable=redefined-builtin
@@ -602,113 +560,7 @@
         stages=[
             Stage.SYNC_WORKDIR,
             Stage.EXEC,
         ],
         cluster_name=cluster_name,
         detach_run=detach_run,
     )
-
-
-@usage_lib.entrypoint
-def spot_launch(
-    task: Union['sky.Task', 'sky.Dag'],
-    name: Optional[str] = None,
-    stream_logs: bool = True,
-    detach_run: bool = False,
-    retry_until_up: bool = False,
-):
-    # NOTE(dev): Keep the docstring consistent between the Python API and CLI.
-    """Launch a managed spot job.
-
-    Please refer to the sky.cli.spot_launch for the document.
-
-    Args:
-        task: sky.Task, or sky.Dag (experimental; 1-task only) to launch as a
-          managed spot job.
-        name: Name of the spot job.
-        detach_run: Whether to detach the run.
-
-    Raises:
-        ValueError: cluster does not exist.
-        sky.exceptions.NotSupportedError: the feature is not supported.
-    """
-    entrypoint = task
-    dag_uuid = str(uuid.uuid4().hex[:4])
-
-    dag = _convert_to_dag(entrypoint)
-    assert dag.is_chain(), ('Only single-task or chain DAG is '
-                            'allowed for spot_launch.', dag)
-
-    dag_utils.maybe_infer_and_fill_dag_and_task_names(dag)
-
-    task_names = set()
-    for task_ in dag.tasks:
-        if task_.name in task_names:
-            raise ValueError(
-                f'Task name {task_.name!r} is duplicated in the DAG. Either '
-                'change task names to be unique, or specify the DAG name only '
-                'and comment out the task names (so that they will be auto-'
-                'generated) .')
-        task_names.add(task_.name)
-
-    dag_utils.fill_default_spot_config_in_dag_for_spot_launch(dag)
-
-    for task_ in dag.tasks:
-        controller_utils.maybe_translate_local_file_mounts_and_sync_up(
-            task_, path='spot')
-
-    with tempfile.NamedTemporaryFile(prefix=f'spot-dag-{dag.name}-',
-                                     mode='w') as f:
-        dag_utils.dump_chain_dag_to_yaml(dag, f.name)
-        controller_name = spot.SPOT_CONTROLLER_NAME
-        prefix = spot.SPOT_TASK_YAML_PREFIX
-        remote_user_yaml_path = f'{prefix}/{dag.name}-{dag_uuid}.yaml'
-        remote_user_config_path = f'{prefix}/{dag.name}-{dag_uuid}.config_yaml'
-        controller_resources = (controller_utils.get_controller_resources(
-            controller_type='spot',
-            controller_resources_config=spot.constants.CONTROLLER_RESOURCES))
-
-        vars_to_fill = {
-            'remote_user_yaml_path': remote_user_yaml_path,
-            'user_yaml_path': f.name,
-            'spot_controller': controller_name,
-            # Note: actual spot cluster name will be <task.name>-<spot job ID>
-            'dag_name': dag.name,
-            'retry_until_up': retry_until_up,
-            'remote_user_config_path': remote_user_config_path,
-            **controller_utils.shared_controller_vars_to_fill(
-                'spot',
-                remote_user_config_path=remote_user_config_path,
-            ),
-        }
-
-        yaml_path = os.path.join(spot.SPOT_CONTROLLER_YAML_PREFIX,
-                                 f'{name}-{dag_uuid}.yaml')
-        common_utils.fill_template(spot.SPOT_CONTROLLER_TEMPLATE,
-                                   vars_to_fill,
-                                   output_path=yaml_path)
-        controller_task = task_lib.Task.from_yaml(yaml_path)
-        assert len(controller_task.resources) == 1, controller_task
-        # Backward compatibility: if the user changed the
-        # spot-controller.yaml.j2 to customize the controller resources,
-        # we should use it.
-        controller_task_resources = list(controller_task.resources)[0]
-        if not controller_task_resources.is_empty():
-            controller_resources = controller_task_resources
-        controller_task.set_resources(controller_resources)
-
-        controller_task.spot_dag = dag
-        assert len(controller_task.resources) == 1
-
-        print(f'{colorama.Fore.YELLOW}'
-              f'Launching managed spot job {dag.name!r} from spot controller...'
-              f'{colorama.Style.RESET_ALL}')
-        print('Launching spot controller...')
-        _execute(
-            entrypoint=controller_task,
-            stream_logs=stream_logs,
-            cluster_name=controller_name,
-            detach_run=detach_run,
-            idle_minutes_to_autostop=constants.
-            CONTROLLER_IDLE_MINUTES_TO_AUTOSTOP,
-            retry_until_up=True,
-        )
```

### Comparing `skypilot-0.5.0/sky/global_user_state.py` & `skypilot-0.6.0/sky/global_user_state.py`

 * *Files 3% similar despite different names*

```diff
@@ -14,16 +14,14 @@
 import time
 import typing
 from typing import Any, Dict, List, Optional, Set, Tuple
 import uuid
 
 from sky import clouds
 from sky import status_lib
-from sky.adaptors import cloudflare
-from sky.data import storage as storage_lib
 from sky.utils import common_utils
 from sky.utils import db_utils
 
 if typing.TYPE_CHECKING:
     from sky import backends
     from sky.data import Storage
 
@@ -324,16 +322,16 @@
     if terminate:
         _DB.cursor.execute('DELETE FROM clusters WHERE name=(?)',
                            (cluster_name,))
     else:
         handle = get_handle_from_cluster_name(cluster_name)
         if handle is None:
             return
-        # Must invalidate IP list: otherwise 'sky cpunode'
-        # on a stopped cpunode will directly try to ssh, which leads to timeout.
+        # Must invalidate IP list to avoid directly trying to ssh into a
+        # stopped VM, which leads to timeout.
         if hasattr(handle, 'stable_internal_external_ips'):
             handle.stable_internal_external_ips = None
         _DB.cursor.execute(
             'UPDATE clusters SET handle=(?), status=(?) '
             'WHERE name=(?)', (
                 pickle.dumps(handle),
                 status_lib.ClusterStatus.STOPPED.value,
@@ -677,15 +675,15 @@
 
 def get_cluster_names_start_with(starts_with: str) -> List[str]:
     rows = _DB.cursor.execute('SELECT name FROM clusters WHERE name LIKE (?)',
                               (f'{starts_with}%',))
     return [row[0] for row in rows]
 
 
-def get_enabled_clouds() -> List[clouds.Cloud]:
+def get_cached_enabled_clouds() -> List[clouds.Cloud]:
     rows = _DB.cursor.execute('SELECT value FROM config WHERE key = ?',
                               (_ENABLED_CLOUDS_KEY,))
     ret = []
     for (value,) in rows:
         ret = json.loads(value)
         break
     enabled_clouds: List[clouds.Cloud] = []
@@ -699,30 +697,14 @@
             # clouds and continue.
             continue
         if cloud is not None:
             enabled_clouds.append(cloud)
     return enabled_clouds
 
 
-def get_enabled_storage_clouds() -> List[str]:
-    # This is a temporary solution until https://github.com/skypilot-org/skypilot/issues/1943 # pylint: disable=line-too-long
-    # is resolved by implementing separate 'enabled_storage_clouds'
-    enabled_clouds = get_enabled_clouds()
-    enabled_clouds = [str(cloud) for cloud in enabled_clouds]
-
-    enabled_storage_clouds = [
-        cloud for cloud in enabled_clouds
-        if cloud in storage_lib.STORE_ENABLED_CLOUDS
-    ]
-    r2_is_enabled, _ = cloudflare.check_credentials()
-    if r2_is_enabled:
-        enabled_storage_clouds.append(cloudflare.NAME)
-    return enabled_storage_clouds
-
-
 def set_enabled_clouds(enabled_clouds: List[str]) -> None:
     _DB.cursor.execute('INSERT OR REPLACE INTO config VALUES (?, ?)',
                        (_ENABLED_CLOUDS_KEY, json.dumps(enabled_clouds)))
     _DB.conn.commit()
 
 
 def add_or_update_storage(storage_name: str,
```

### Comparing `skypilot-0.5.0/sky/optimizer.py` & `skypilot-0.6.0/sky/optimizer.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,35 +1,36 @@
 """Optimizer: assigns best resources to user tasks."""
 import collections
 import copy
 import enum
 import json
 import typing
-from typing import Any, Dict, Iterable, List, Optional, Tuple
+from typing import Any, Dict, Iterable, List, Optional, Set, Tuple
 
 import colorama
-import networkx as nx
 import numpy as np
 import prettytable
 
-from sky import check
+from sky import check as sky_check
 from sky import clouds
 from sky import exceptions
-from sky import global_user_state
 from sky import resources as resources_lib
 from sky import sky_logging
 from sky import task as task_lib
-from sky.backends import backend_utils
+from sky.adaptors import common as adaptors_common
 from sky.utils import env_options
 from sky.utils import log_utils
 from sky.utils import ux_utils
 
 if typing.TYPE_CHECKING:
-    # pylint: disable=ungrouped-imports
+    import networkx as nx
+
     from sky import dag as dag_lib
+else:
+    nx = adaptors_common.LazyImport('networkx')
 
 logger = sky_logging.init_logger(__name__)
 
 _DUMMY_SOURCE_NAME = 'skypilot-dummy-source'
 _DUMMY_SINK_NAME = 'skypilot-dummy-sink'
 
 # task -> resources -> estimated cost or time.
@@ -115,14 +116,16 @@
             quiet: whether to suppress logging.
 
         Raises:
             exceptions.ResourcesUnavailableError: if no resources are available
                 for a task.
             exceptions.NoCloudAccessError: if no public clouds are enabled.
         """
+        _check_specified_clouds(dag)
+
         # This function is effectful: mutates every node in 'dag' by setting
         # node.best_resources if it is None.
         Optimizer._add_dummy_source_sink_nodes(dag)
         try:
             unused_best_plan = Optimizer._optimize_dag(
                 dag=dag,
                 minimize_cost=minimize == OptimizeTarget.COST,
@@ -264,15 +267,14 @@
             fuzzy_candidates: List[str] = []
             if node_i < len(topo_order) - 1:
                 # Convert partial resource labels to launchable resources.
                 launchable_resources, cloud_candidates, fuzzy_candidates = (
                     _fill_in_launchable_resources(
                         task=node,
                         blocked_resources=blocked_resources,
-                        try_fix_with_sky_check=True,
                         quiet=quiet))
                 node_to_candidate_map[node] = cloud_candidates
             else:
                 # Dummy sink node.
                 launchable_resources = {
                     list(node.resources)[0]: list(node.resources)
                 }
@@ -330,16 +332,18 @@
                                 format(estimated_cost_or_time))
                     node_to_cost_map[node][resources] = estimated_cost_or_time
             if not node_to_cost_map[node]:
                 source_hint = 'catalog'
                 # If Kubernetes was included in the search space, then
                 # mention "kubernetes cluster" and/instead of "catalog"
                 # in the error message.
-                enabled_clouds = global_user_state.get_enabled_clouds()
-                if clouds.cloud_in_list(clouds.Kubernetes(), enabled_clouds):
+                enabled_clouds = (
+                    sky_check.get_cached_enabled_clouds_or_refresh())
+                if clouds.cloud_in_iterable(clouds.Kubernetes(),
+                                            enabled_clouds):
                     if any(orig_resources.cloud is None
                            for orig_resources in node.resources):
                         source_hint = 'catalog and kubernetes cluster'
                     elif all(
                             isinstance(orig_resources.cloud, clouds.Kubernetes)
                             for orig_resources in node.resources):
                         source_hint = 'kubernetes cluster'
@@ -802,18 +806,20 @@
                 sort_keys=True)
 
         # Print the list of resouces that the optimizer considered.
         resource_fields = [
             'CLOUD', 'INSTANCE', 'vCPUs', 'Mem(GB)', 'ACCELERATORS',
             'REGION/ZONE'
         ]
-        # Do not print Source or Sink.
-        best_plan_rows = [[t, t.num_nodes] + _get_resources_element_list(r)
-                          for t, r in ordered_best_plan.items()]
-        if len(best_plan_rows) > 1:
+        if len(ordered_best_plan) > 1:
+            best_plan_rows = []
+            for t, r in ordered_best_plan.items():
+                assert t.name is not None, t
+                best_plan_rows.append([t.name, str(t.num_nodes)] +
+                                      _get_resources_element_list(r))
             logger.info(
                 f'{colorama.Style.BRIGHT}Best plan: {colorama.Style.RESET_ALL}')
             best_plan_table = _create_table(['TASK', '#NODES'] +
                                             resource_fields)
             best_plan_table.add_rows(best_plan_rows)
             logger.info(f'{best_plan_table}\n')
 
@@ -828,15 +834,15 @@
             # Hack: convert the dictionary values
             # (resources) to their yaml config
             # For dictionary comparison later.
             v_yaml = {
                 json.dumps(resource.to_yaml_config()): cost
                 for resource, cost in v.items()
             }
-            task_str = (f'for task {repr(task)!r} ' if num_tasks > 1 else '')
+            task_str = (f'for task {task.name!r} ' if num_tasks > 1 else '')
             plural = 's' if task.num_nodes > 1 else ''
             logger.info(
                 f'{colorama.Style.BRIGHT}Considered resources {task_str}'
                 f'({task.num_nodes} node{plural}):'
                 f'{colorama.Style.RESET_ALL}')
 
             # Only print 1 row per cloud.
@@ -983,26 +989,26 @@
                             f'{accelerators_str}')
 
         graph = dag.get_graph()
         local_dag = copy.deepcopy(dag) if has_resources_ordered else dag
         for task_id in range(len(dag.tasks)):
             task = dag.tasks[task_id]
             if isinstance(task.resources, list):
+                # For ordered resources, we try the resources in the order
+                # specified by the user.
                 local_task = local_dag.tasks[task_id]
                 for resources in task.resources:
                     # Check if there exists launchable resources
                     local_task.set_resources(resources)
-                    launchable_resources_map, _ , _ = \
+                    launchable_resources_map, _, _ = (
                         _fill_in_launchable_resources(
-                            task = local_task,
-                            blocked_resources = blocked_resources,
-                            try_fix_with_sky_check = True,
-                            quiet = False
-                    )
-                    if len(launchable_resources_map[resources]) != 0:
+                            task=local_task,
+                            blocked_resources=blocked_resources,
+                            quiet=False))
+                    if launchable_resources_map.get(resources, []):
                         break
 
         local_graph = local_dag.get_graph()
         local_topo_order = list(nx.topological_sort(local_graph))
         local_node_to_cost_map, local_node_to_candidate_map = (
             Optimizer._estimate_nodes_cost_or_time(local_topo_order,
                                                    minimize_cost,
@@ -1034,32 +1040,33 @@
                          '      \'sky check\' to check the enabled clouds.')
             with ux_utils.print_exception_no_traceback():
                 raise exceptions.ResourcesUnavailableError(error_msg)
 
         if has_resources_ordered:
             best_plan = {}
             # We have to manually set the best_resources for the tasks in the
-            # original dag, to pass the optimization results
-            # to the caller, as we deep copied the dag
-            # when the dag has nodes with ordered resources.
+            # original dag, to pass the optimization results to the caller, as
+            # we deep copied the dag when the dag has nodes with ordered
+            # resources.
             for task, resources in local_best_plan.items():
                 task_idx = local_dag.tasks.index(task)
                 dag.tasks[task_idx].best_resources = resources
                 best_plan[dag.tasks[task_idx]] = resources
+
+            topo_order = list(nx.topological_sort(graph))
+            # Get the cost of each specified resources for display purpose.
+            node_to_cost_map, _ = Optimizer._estimate_nodes_cost_or_time(
+                topo_order=topo_order,
+                minimize_cost=minimize_cost,
+                blocked_resources=blocked_resources,
+                quiet=True)
         else:
             best_plan = local_best_plan
-
-        topo_order = list(nx.topological_sort(graph)) if has_resources_ordered \
-            else local_topo_order
-        node_to_cost_map, _ = (Optimizer._estimate_nodes_cost_or_time(
-            topo_order=topo_order,
-            minimize_cost=minimize_cost,
-            blocked_resources=blocked_resources,
-            quiet=True)) if has_resources_ordered else (
-                local_node_to_cost_map, local_node_to_candidate_map)
+            topo_order = local_topo_order
+            node_to_cost_map = local_node_to_cost_map
 
         if not quiet:
             Optimizer.print_optimized_plan(graph, topo_order, best_plan,
                                            total_time, total_cost,
                                            node_to_cost_map, minimize_cost)
             if not env_options.Options.MINIMIZE_LOGGING.get():
                 Optimizer._print_candidates(local_node_to_candidate_map)
@@ -1137,90 +1144,141 @@
             if resources.should_be_blocked_by(blocked):
                 break
         else:  # non-blocked launchable resources. (no break)
             available_resources.append(resources)
     return available_resources
 
 
+def _check_specified_clouds(dag: 'dag_lib.Dag') -> None:
+    """Check if specified clouds are enabled in cache and refresh if needed.
+
+    Our enabled cloud list is cached in a local database, and if a user
+    specified a cloud that is not enabled, we should refresh the cache for that
+    cloud in case the cloud access has been enabled since the last cache update.
+
+    Args:
+        dag: The DAG specified by a user.
+    """
+    enabled_clouds = sky_check.get_cached_enabled_clouds_or_refresh(
+        raise_if_no_cloud_access=True)
+
+    global_disabled_clouds: Set[str] = set()
+    for task in dag.tasks:
+        # Recheck the enabled clouds if the task's requested resources are on a
+        # cloud that is not enabled in the cached enabled_clouds.
+        all_clouds_specified: Set[str] = set()
+        clouds_need_recheck: Set[str] = set()
+        for resources in task.resources:
+            cloud_str = str(resources.cloud)
+            if (resources.cloud is not None and not clouds.cloud_in_iterable(
+                    resources.cloud, enabled_clouds)):
+                # Explicitly check again to update the enabled cloud list.
+                clouds_need_recheck.add(cloud_str)
+            all_clouds_specified.add(cloud_str)
+
+        # Explicitly check again to update the enabled cloud list.
+        sky_check.check(quiet=True,
+                        clouds=list(clouds_need_recheck -
+                                    global_disabled_clouds))
+        enabled_clouds = sky_check.get_cached_enabled_clouds_or_refresh(
+            raise_if_no_cloud_access=True)
+        disabled_clouds = (clouds_need_recheck -
+                           {str(c) for c in enabled_clouds})
+        global_disabled_clouds.update(disabled_clouds)
+        if disabled_clouds:
+            is_or_are = 'is' if len(disabled_clouds) == 1 else 'are'
+            task_name = f' {task.name!r}' if task.name is not None else ''
+            msg = (f'Task{task_name} requires {", ".join(disabled_clouds)} '
+                   f'which {is_or_are} not enabled. To enable access, change '
+                   f'the task cloud requirement or run: {colorama.Style.BRIGHT}'
+                   f'sky check {" ".join(c.lower() for c in disabled_clouds)}'
+                   f'{colorama.Style.RESET_ALL}')
+            if all_clouds_specified == disabled_clouds:
+                # If all resources are specified with a disabled cloud, we
+                # should raise an error as no resource can satisfy the
+                # requirement. Otherwise, we should just skip the resource.
+                with ux_utils.print_exception_no_traceback():
+                    raise exceptions.ResourcesUnavailableError(msg)
+            logger.warning(
+                f'{colorama.Fore.YELLOW}{msg}{colorama.Style.RESET_ALL}')
+
+
 def _fill_in_launchable_resources(
     task: task_lib.Task,
     blocked_resources: Optional[Iterable[resources_lib.Resources]],
-    try_fix_with_sky_check: bool = True,
     quiet: bool = False
 ) -> Tuple[Dict[resources_lib.Resources, List[resources_lib.Resources]],
            _PerCloudCandidates, List[str]]:
     """Fills in the launchable resources for the task.
 
     Returns:
       A tuple of:
         Dict mapping the task's requested Resources to a list of launchable
           Resources,
         Dict mapping Cloud to a list of feasible Resources (for printing),
         Sorted list of fuzzy candidates (alternative GPU names).
+    Raises:
+      ResourcesUnavailableError: if all resources required by the task are on
+        a cloud that is not enabled.
     """
-    backend_utils.check_public_cloud_enabled()
-    enabled_clouds = global_user_state.get_enabled_clouds()
-    launchable = collections.defaultdict(list)
+    enabled_clouds = sky_check.get_cached_enabled_clouds_or_refresh(
+        raise_if_no_cloud_access=True)
+
+    launchable: Dict[resources_lib.Resources, List[resources_lib.Resources]] = (
+        collections.defaultdict(list))
     all_fuzzy_candidates = set()
     cloud_candidates: _PerCloudCandidates = collections.defaultdict(
         List[resources_lib.Resources])
     if blocked_resources is None:
         blocked_resources = []
     for resources in task.resources:
         if (resources.cloud is not None and
-                not clouds.cloud_in_list(resources.cloud, enabled_clouds)):
-            if try_fix_with_sky_check:
-                # Explicitly check again to update the enabled cloud list.
-                check.check(quiet=True)
-                return _fill_in_launchable_resources(task, blocked_resources,
-                                                     False)
-            with ux_utils.print_exception_no_traceback():
-                raise exceptions.ResourcesUnavailableError(
-                    f'Task requires {resources.cloud} which is '
-                    f'not enabled: {task}.\nTo enable access, run '
-                    f'{colorama.Style.BRIGHT}'
-                    f'sky check {colorama.Style.RESET_ALL}, or change the '
-                    'cloud requirement')
-        else:
-            clouds_list = ([resources.cloud]
-                           if resources.cloud is not None else enabled_clouds)
-            for cloud in clouds_list:
-                (feasible_resources, fuzzy_candidate_list) = (
-                    cloud.get_feasible_launchable_resources(
-                        resources, num_nodes=task.num_nodes))
-                if len(feasible_resources) > 0:
-                    # Assume feasible_resources is sorted by prices.
-                    cheapest = feasible_resources[0]
-                    # Generate region/zone-specified resources.
-                    launchable[resources].extend(
-                        _make_launchables_for_valid_region_zones(cheapest))
-                    cloud_candidates[cloud] = feasible_resources
-                else:
-                    all_fuzzy_candidates.update(fuzzy_candidate_list)
-            if len(launchable[resources]) == 0:
-                clouds_str = str(clouds_list) if len(clouds_list) > 1 else str(
-                    clouds_list[0])
-                num_node_str = ''
-                if task.num_nodes > 1:
-                    num_node_str = f'{task.num_nodes}x '
-                if not quiet:
-                    logger.info(
-                        f'No resource satisfying {num_node_str}'
-                        f'{resources.repr_with_region_zone} on {clouds_str}.')
-                if len(all_fuzzy_candidates) > 0:
+                not clouds.cloud_in_iterable(resources.cloud, enabled_clouds)):
+            # Skip the resources that are on a cloud that is not enabled. The
+            # hint has been printed in _check_specified_clouds.
+            launchable[resources] = []
+            continue
+        clouds_list = ([resources.cloud]
+                       if resources.cloud is not None else enabled_clouds)
+        for cloud in clouds_list:
+            (feasible_resources,
+             fuzzy_candidate_list) = cloud.get_feasible_launchable_resources(
+                 resources, num_nodes=task.num_nodes)
+            if len(feasible_resources) > 0:
+                # Assume feasible_resources is sorted by prices. Guaranteed by
+                # the implementation of get_feasible_launchable_resources and
+                # the underlying service_catalog filtering
+                cheapest = feasible_resources[0]
+                # Generate region/zone-specified resources.
+                launchable[resources].extend(
+                    _make_launchables_for_valid_region_zones(cheapest))
+                cloud_candidates[cloud] = feasible_resources
+            else:
+                all_fuzzy_candidates.update(fuzzy_candidate_list)
+        if len(launchable[resources]) == 0:
+            clouds_str = str(clouds_list) if len(clouds_list) > 1 else str(
+                clouds_list[0])
+            num_node_str = ''
+            if task.num_nodes > 1:
+                num_node_str = f'{task.num_nodes}x '
+            if not quiet:
+                logger.info(
+                    f'No resource satisfying {num_node_str}'
+                    f'{resources.repr_with_region_zone} on {clouds_str}.')
+                if all_fuzzy_candidates:
                     logger.info('Did you mean: '
                                 f'{colorama.Fore.CYAN}'
                                 f'{sorted(all_fuzzy_candidates)}'
                                 f'{colorama.Style.RESET_ALL}')
-                else:
-                    if resources.cpus is not None:
-                        logger.info('Try specifying a different CPU count, '
-                                    'or add "+" to the end of the CPU count '
-                                    'to allow for larger instances.')
-                    if resources.memory is not None:
-                        logger.info('Try specifying a different memory size, '
-                                    'or add "+" to the end of the memory size '
-                                    'to allow for larger instances.')
+            else:
+                if resources.cpus is not None:
+                    logger.info('Try specifying a different CPU count, '
+                                'or add "+" to the end of the CPU count '
+                                'to allow for larger instances.')
+                if resources.memory is not None:
+                    logger.info('Try specifying a different memory size, '
+                                'or add "+" to the end of the memory size '
+                                'to allow for larger instances.')
 
         launchable[resources] = _filter_out_blocked_launchable_resources(
             launchable[resources], blocked_resources)
     return launchable, cloud_candidates, list(sorted(all_fuzzy_candidates))
```

### Comparing `skypilot-0.5.0/sky/provision/__init__.py` & `skypilot-0.6.0/sky/provision/__init__.py`

 * *Files 19% similar despite different names*

```diff
@@ -1,15 +1,15 @@
 """Cloud provision interface.
 
 This module provides a standard low-level interface that all
 providers supported by SkyPilot need to follow.
 """
 import functools
 import inspect
-from typing import Any, Dict, List, Optional
+from typing import Any, Dict, List, Optional, Type
 
 from sky import sky_logging
 from sky import status_lib
 # These provision.<cloud> modules should never fail even if underlying cloud SDK
 # dependencies are not installed. This is ensured by using sky.adaptors inside
 # these modules, for lazy loading of cloud SDKs.
 from sky.provision import aws
@@ -17,14 +17,15 @@
 from sky.provision import common
 from sky.provision import cudo
 from sky.provision import fluidstack
 from sky.provision import gcp
 from sky.provision import kubernetes
 from sky.provision import runpod
 from sky.provision import vsphere
+from sky.utils import command_runner
 
 logger = sky_logging.init_logger(__name__)
 
 
 def _route_to_cloud_impl(func):
 
     @functools.wraps(func)
@@ -37,16 +38,20 @@
         else:
             provider_name = kwargs.pop('provider_name')
 
         module_name = provider_name.lower()
         module = globals().get(module_name)
         assert module is not None, f'Unknown provider: {module_name}'
 
-        impl = getattr(module, func.__name__)
-        return impl(*args, **kwargs)
+        impl = getattr(module, func.__name__, None)
+        if impl is not None:
+            return impl(*args, **kwargs)
+
+        # If implementation does not exist, fall back to default implementation
+        return func(provider_name, *args, **kwargs)
 
     return _wrapper
 
 
 # pylint: disable=unused-argument
 
 
@@ -137,21 +142,27 @@
 
 
 @_route_to_cloud_impl
 def query_ports(
     provider_name: str,
     cluster_name_on_cloud: str,
     ports: List[str],
+    head_ip: Optional[str] = None,
     provider_config: Optional[Dict[str, Any]] = None,
 ) -> Dict[int, List[common.Endpoint]]:
     """Query details about ports on a cluster.
 
+    If head_ip is provided, it may be used by the cloud implementation to
+    return the endpoint without querying the cloud provider. If head_ip is not
+    provided, the cloud provider will be queried to get the endpoint info.
+
     Returns a dict with port as the key and a list of common.Endpoint.
     """
-    raise NotImplementedError
+    del provider_name, provider_config, cluster_name_on_cloud  # unused
+    return common.query_ports_passthrough(ports, head_ip)
 
 
 @_route_to_cloud_impl
 def wait_instances(provider_name: str, region: str, cluster_name_on_cloud: str,
                    state: Optional[status_lib.ClusterStatus]) -> None:
     """Wait instances until they ends up in the given state."""
     raise NotImplementedError
@@ -161,7 +172,22 @@
 def get_cluster_info(
         provider_name: str,
         region: str,
         cluster_name_on_cloud: str,
         provider_config: Optional[Dict[str, Any]] = None) -> common.ClusterInfo:
     """Get the metadata of instances in a cluster."""
     raise NotImplementedError
+
+
+@_route_to_cloud_impl
+def get_command_runners(
+    provider_name: str,
+    cluster_info: common.ClusterInfo,
+    **crednetials: Dict[str, Any],
+) -> List[command_runner.CommandRunner]:
+    """Get a command runner for the given cluster."""
+    ip_list = cluster_info.get_feasible_ips()
+    port_list = cluster_info.get_ssh_ports()
+    return command_runner.SSHCommandRunner.make_runner_list(
+        node_list=zip(ip_list, port_list),
+        **crednetials,
+    )
```

### Comparing `skypilot-0.5.0/sky/provision/aws/__init__.py` & `skypilot-0.6.0/sky/provision/aws/__init__.py`

 * *Files 5% similar despite different names*

```diff
@@ -1,15 +1,14 @@
 """AWS provisioner for SkyPilot."""
 
 from sky.provision.aws.config import bootstrap_instances
 from sky.provision.aws.instance import cleanup_ports
 from sky.provision.aws.instance import get_cluster_info
 from sky.provision.aws.instance import open_ports
 from sky.provision.aws.instance import query_instances
-from sky.provision.aws.instance import query_ports
 from sky.provision.aws.instance import run_instances
 from sky.provision.aws.instance import stop_instances
 from sky.provision.aws.instance import terminate_instances
 from sky.provision.aws.instance import wait_instances
 
 __all__ = ('bootstrap_instances', 'run_instances', 'stop_instances',
            'terminate_instances', 'wait_instances', 'get_cluster_info',
```

### Comparing `skypilot-0.5.0/sky/provision/aws/config.py` & `skypilot-0.6.0/sky/provision/aws/config.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/provision/aws/instance.py` & `skypilot-0.6.0/sky/provision/aws/instance.py`

 * *Files 3% similar despite different names*

```diff
@@ -57,34 +57,34 @@
 #  costs $0.01/GB:
 # https://aws.amazon.com/ec2/pricing/on-demand/#Data_Transfer_within_the_same_AWS_Region
 
 
 def _default_ec2_resource(region: str) -> Any:
     if not hasattr(aws, 'version'):
         # For backward compatibility, reload the module if the aws module was
-        # imported before and stale. Used for, e.g., a live spot controller
+        # imported before and stale. Used for, e.g., a live jobs controller
         # running an older version and a new version gets installed by
-        # `sky spot launch`.
+        # `sky jobs launch`.
         #
         # Detailed explanation follows. Assume we're in this situation: an old
-        # spot controller running a spot job and then the code gets updated on
-        # the controller due to a new `sky spot launch` or `sky start`.
+        # jobs controller running a managed job and then the code gets updated
+        # on the controller due to a new `sky jobs launch or `sky start`.
         #
-        # First, controller consists of an outer process (sky.spot.controller's
+        # First, controller consists of an outer process (sky.jobs.controller's
         # main) and an inner process running the controller logic (started as a
-        # multiprocessing.Process in sky.spot.controller). `sky.provision.aws`
+        # multiprocessing.Process in sky.jobs.controller). `sky.provision.aws`
         # is only imported in the inner process due to its load-on-use
         # semantics.
         #
         # At this point in the normal execution, inner process has loaded
         # {old sky.provision.aws, old sky.adaptors.aws}, and outer process has
         # loaded {old sky.adaptors.aws}.
         #
-        # In controller.py's start(), the inner process may exit due to spot job
-        # exits or `sky spot cancel`, entering outer process'
+        # In controller.py's start(), the inner process may exit due to managed
+        # job exits or `sky jobs cancel`, entering outer process'
         # `finally: ... _cleanup()` path. Inside _cleanup(), we eventually call
         # into `sky.provision.aws` which loads this module for the first time
         # for the outer process. At this point, outer process has loaded
         # {old sky.adaptors.aws, new sky.provision.aws}.
         #
         # This version mismatch becomes a "backward compatibility" problem if
         # `new sky.provision.aws` depends on `new sky.adaptors.aws` (assuming
@@ -584,14 +584,16 @@
     provider_config: Optional[Dict[str, Any]] = None,
     worker_only: bool = False,
 ) -> None:
     """See sky/provision/__init__.py"""
     assert provider_config is not None, (cluster_name_on_cloud, provider_config)
     region = provider_config['region']
     sg_name = provider_config['security_group']['GroupName']
+    managed_by_skypilot = provider_config['security_group'].get(
+        'ManagedBySkyPilot', True)
     ec2 = _default_ec2_resource(region)
     filters = [
         {
             'Name': 'instance-state-name',
             # exclude 'shutting-down' or 'terminated' states
             'Values': ['pending', 'running', 'stopping', 'stopped'],
         },
@@ -604,17 +606,19 @@
         })
     # https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/ec2.html#EC2.Instance
     instances = _filter_instances(ec2,
                                   filters,
                                   included_instances=None,
                                   excluded_instances=None)
     instances.terminate()
-    if sg_name == aws_cloud.DEFAULT_SECURITY_GROUP_NAME:
-        # Using default AWS SG. We don't need to wait for the
-        # termination of the instances.
+    if (sg_name == aws_cloud.DEFAULT_SECURITY_GROUP_NAME or
+            not managed_by_skypilot):
+        # Using default AWS SG or user specified security group. We don't need
+        # to wait for the termination of the instances, as we do not need to
+        # delete the SG.
         return
     # If ports are specified, we need to delete the newly created Security
     # Group. Here we wait for all instances to be terminated, since the
     # Security Group dependent on them.
     for instance in instances:
         instance.wait_until_terminated()
     # TODO(suquark): Currently, the implementation of GCP and Azure will
@@ -751,17 +755,21 @@
 ) -> None:
     """See sky/provision/__init__.py"""
     del ports  # Unused.
     assert provider_config is not None, cluster_name_on_cloud
     region = provider_config['region']
     ec2 = _default_ec2_resource(region)
     sg_name = provider_config['security_group']['GroupName']
-    if sg_name == aws_cloud.DEFAULT_SECURITY_GROUP_NAME:
-        # Using default AWS SG. We only want to delete the SG that is dedicated
-        # to this cluster (i.e., this cluster have opened some ports).
+    managed_by_skypilot = provider_config['security_group'].get(
+        'ManagedBySkyPilot', True)
+    if (sg_name == aws_cloud.DEFAULT_SECURITY_GROUP_NAME or
+            not managed_by_skypilot):
+        # 1) Using default AWS SG or 2) the SG is specified by the user.
+        # We only want to delete the SG that is dedicated to this cluster (i.e.,
+        # this cluster have opened some ports).
         return
     sg = _get_sg_from_name(ec2, sg_name)
     if sg is None:
         logger.warning(
             'Find security group failed. Skip cleanup security group.')
         return
     backoff = common_utils.Backoff()
@@ -831,15 +839,14 @@
 
 
 def get_cluster_info(
         region: str,
         cluster_name_on_cloud: str,
         provider_config: Optional[Dict[str, Any]] = None) -> common.ClusterInfo:
     """See sky/provision/__init__.py"""
-    del provider_config  # unused
     ec2 = _default_ec2_resource(region)
     filters = [
         {
             'Name': 'instance-state-name',
             'Values': ['running'],
         },
         {
@@ -863,18 +870,10 @@
                 tags=dict(tags),
             )
         ]
     instances = dict(sorted(instances.items(), key=lambda x: x[0]))
     return common.ClusterInfo(
         instances=instances,
         head_instance_id=head_instance_id,
+        provider_name='aws',
+        provider_config=provider_config,
     )
-
-
-def query_ports(
-    cluster_name_on_cloud: str,
-    ports: List[str],
-    provider_config: Optional[Dict[str, Any]] = None,
-) -> Dict[int, List[common.Endpoint]]:
-    """See sky/provision/__init__.py"""
-    return common.query_ports_passthrough(cluster_name_on_cloud, ports,
-                                          provider_config)
```

### Comparing `skypilot-0.5.0/sky/provision/aws/utils.py` & `skypilot-0.6.0/sky/provision/aws/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/provision/azure/instance.py` & `skypilot-0.6.0/sky/provision/azure/instance.py`

 * *Files 6% similar despite different names*

```diff
@@ -1,14 +1,13 @@
 """Azure instance provisioning."""
 import logging
 from typing import Any, Callable, Dict, List, Optional
 
 from sky import sky_logging
 from sky.adaptors import azure
-from sky.provision import common
 from sky.utils import ux_utils
 
 logger = sky_logging.init_logger(__name__)
 
 # Suppress noisy logs from Azure SDK. Reference:
 # https://github.com/Azure/azure-sdk-for-python/issues/9422
 azure_logger = logging.getLogger('azure')
@@ -75,32 +74,22 @@
             poller = update_network_security_groups(resource_group, nsg.name,
                                                     nsg)
             poller.wait()
             if poller.status() != 'Succeeded':
                 with ux_utils.print_exception_no_traceback():
                     raise ValueError(f'Failed to open ports {ports} in NSG '
                                      f'{nsg.name}: {poller.status()}')
-        except azure.http_error_exception() as e:
+        except azure.exceptions().HttpResponseError as e:
             with ux_utils.print_exception_no_traceback():
                 raise ValueError(
                     f'Failed to open ports {ports} in NSG {nsg.name}.') from e
 
 
 def cleanup_ports(
     cluster_name_on_cloud: str,
     ports: List[str],
     provider_config: Optional[Dict[str, Any]] = None,
 ) -> None:
     """See sky/provision/__init__.py"""
     # Azure will automatically cleanup network security groups when cleanup
     # resource group. So we don't need to do anything here.
     del cluster_name_on_cloud, ports, provider_config  # Unused.
-
-
-def query_ports(
-    cluster_name_on_cloud: str,
-    ports: List[str],
-    provider_config: Optional[Dict[str, Any]] = None,
-) -> Dict[int, List[common.Endpoint]]:
-    """See sky/provision/__init__.py"""
-    return common.query_ports_passthrough(cluster_name_on_cloud, ports,
-                                          provider_config)
```

### Comparing `skypilot-0.5.0/sky/provision/common.py` & `skypilot-0.6.0/sky/provision/common.py`

 * *Files 7% similar despite different names*

```diff
@@ -1,14 +1,14 @@
 """Common data structures for provisioning"""
 import abc
 import dataclasses
 import os
 from typing import Any, Dict, List, Optional, Tuple
 
-from sky.utils.resources_utils import port_ranges_to_set
+from sky.utils import resources_utils
 
 # NOTE: we can use pydantic instead of dataclasses or namedtuples, because
 # pydantic provides more features like validation or parsing from
 # nested dictionaries. This makes our API more extensible and easier
 # to integrate with other frameworks like FastAPI etc.
 
 # -------------------- input data model -------------------- #
@@ -100,14 +100,18 @@
 @dataclasses.dataclass
 class ClusterInfo:
     """Cluster Information."""
     instances: Dict[InstanceId, List[InstanceInfo]]
     # The unique identifier of the head instance, i.e., the
     # `instance_info.instance_id` of the head node.
     head_instance_id: Optional[InstanceId]
+    # Provider related information.
+    provider_name: str
+    provider_config: Optional[Dict[str, Any]] = None
+
     docker_user: Optional[str] = None
     # Override the ssh_user from the cluster config.
     ssh_user: Optional[str] = None
     custom_ray_options: Optional[Dict[str, Any]] = None
 
     @property
     def num_instances(self) -> int:
@@ -147,14 +151,27 @@
                                  head_instance.external_ip)]
         other_ips = []
         for instance in self.get_worker_instances():
             pair = (instance.internal_ip, instance.external_ip)
             other_ips.append(pair)
         return head_instance_ip + other_ips
 
+    def instance_ids(self) -> List[str]:
+        """Return the instance ids in the same order of ip_tuples."""
+        id_list = []
+        if self.head_instance_id is not None:
+            id_list.append(self.head_instance_id + '-0')
+        for inst_id, instances in self.instances.items():
+            start_idx = 0
+            if inst_id == self.head_instance_id:
+                start_idx = 1
+            id_list.extend(
+                [f'{inst_id}-{i}' for i in range(start_idx, len(instances))])
+        return id_list
+
     def has_external_ips(self) -> bool:
         """True if the cluster has external IP."""
         ip_tuples = self.ip_tuples()
         if not ip_tuples:
             return False
         return ip_tuples[0][1] is not None
 
@@ -182,73 +199,72 @@
     def get_feasible_ips(self, force_internal_ips: bool = False) -> List[str]:
         """Get external IPs if they exist, otherwise get internal ones."""
         return self._get_ips(not self.has_external_ips() or force_internal_ips)
 
     def get_ssh_ports(self) -> List[int]:
         """Get the SSH port of all the instances."""
         head_instance = self.get_head_instance()
-        assert head_instance is not None, self
-        head_instance_port = [head_instance.ssh_port]
+
+        head_instance_port = []
+        if head_instance is not None:
+            head_instance_port = [head_instance.ssh_port]
 
         worker_instances = self.get_worker_instances()
         worker_instance_ports = [
             instance.ssh_port for instance in worker_instances
         ]
         return head_instance_port + worker_instance_ports
 
 
 class Endpoint:
     """Base class for endpoints."""
     pass
 
     @abc.abstractmethod
-    def url(self, ip: str):
+    def url(self, override_ip: Optional[str] = None) -> str:
         raise NotImplementedError
 
 
 @dataclasses.dataclass
 class SocketEndpoint(Endpoint):
     """Socket endpoint accesible via a host and a port."""
     port: Optional[int]
     host: str = ''
 
-    def url(self, ip: str):
-        if not self.host:
-            self.host = ip
-        return f'{self.host}{":" + str(self.port) if self.port else ""}'
+    def url(self, override_ip: Optional[str] = None) -> str:
+        host = override_ip if override_ip else self.host
+        return f'{host}{":" + str(self.port) if self.port else ""}'
 
 
 @dataclasses.dataclass
 class HTTPEndpoint(SocketEndpoint):
-    """HTTP endpoint accesible via a url."""
+    """HTTP endpoint accessible via a url."""
     path: str = ''
 
-    def url(self, ip: str):
-        del ip  # Unused.
-        return f'http://{os.path.join(super().url(self.host), self.path)}'
+    def url(self, override_ip: Optional[str] = None) -> str:
+        host = override_ip if override_ip else self.host
+        return f'http://{os.path.join(super().url(host), self.path)}'
 
 
 @dataclasses.dataclass
 class HTTPSEndpoint(SocketEndpoint):
-    """HTTPS endpoint accesible via a url."""
+    """HTTPS endpoint accessible via a url."""
     path: str = ''
 
-    def url(self, ip: str):
-        del ip  # Unused.
-        return f'https://{os.path.join(super().url(self.host), self.path)}'
+    def url(self, override_ip: Optional[str] = None) -> str:
+        host = override_ip if override_ip else self.host
+        return f'https://{os.path.join(super().url(host), self.path)}'
 
 
 def query_ports_passthrough(
-    cluster_name_on_cloud: str,
     ports: List[str],
-    provider_config: Optional[Dict[str, Any]] = None,
+    head_ip: Optional[str],
 ) -> Dict[int, List[Endpoint]]:
-    """Common function to query ports for AWS, GCP and Azure.
+    """Common function to get endpoints for AWS, GCP and Azure.
 
-    Returns a list of socket endpoint with empty host and the input ports."""
-    del cluster_name_on_cloud, provider_config  # Unused.
-    ports = list(port_ranges_to_set(ports))
+    Returns a list of socket endpoint using head_ip and ports."""
+    assert head_ip is not None, head_ip
+    ports = list(resources_utils.port_ranges_to_set(ports))
     result: Dict[int, List[Endpoint]] = {}
     for port in ports:
-        result[port] = [SocketEndpoint(port=port)]
-
+        result[port] = [SocketEndpoint(port=port, host=head_ip)]
     return result
```

### Comparing `skypilot-0.5.0/sky/provision/cudo/__init__.py` & `skypilot-0.6.0/sky/provision/cudo/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/provision/cudo/cudo_machine_type.py` & `skypilot-0.6.0/sky/provision/cudo/cudo_machine_type.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/provision/cudo/cudo_wrapper.py` & `skypilot-0.6.0/sky/provision/cudo/cudo_wrapper.py`

 * *Files 10% similar despite different names*

```diff
@@ -1,111 +1,111 @@
 """Cudo Compute library wrapper for SkyPilot."""
 import time
 from typing import Dict
 
 from sky import sky_logging
-from sky.adaptors.cudo import cudo
+from sky.adaptors import cudo
 
 logger = sky_logging.init_logger(__name__)
 
 
 def launch(name: str, data_center_id: str, ssh_key: str, machine_type: str,
            memory_gib: int, vcpu_count: int, gpu_count: int, gpu_model: str,
            tags: Dict[str, str], disk_size: int):
     """Launches an instance with the given parameters."""
-    disk = cudo().Disk(storage_class='STORAGE_CLASS_NETWORK',
-                       size_gib=disk_size)
+    disk = cudo.cudo.Disk(storage_class='STORAGE_CLASS_NETWORK',
+                          size_gib=disk_size)
 
-    request = cudo().CreateVMBody(ssh_key_source='SSH_KEY_SOURCE_NONE',
-                                  custom_ssh_keys=[ssh_key],
-                                  vm_id=name,
-                                  machine_type=machine_type,
-                                  data_center_id=data_center_id,
-                                  boot_disk_image_id='ubuntu-nvidia-docker',
-                                  memory_gib=memory_gib,
-                                  vcpus=vcpu_count,
-                                  gpus=gpu_count,
-                                  gpu_model=gpu_model,
-                                  boot_disk=disk,
-                                  metadata=tags)
+    request = cudo.cudo.CreateVMBody(ssh_key_source='SSH_KEY_SOURCE_NONE',
+                                     custom_ssh_keys=[ssh_key],
+                                     vm_id=name,
+                                     machine_type=machine_type,
+                                     data_center_id=data_center_id,
+                                     boot_disk_image_id='ubuntu-nvidia-docker',
+                                     memory_gib=memory_gib,
+                                     vcpus=vcpu_count,
+                                     gpus=gpu_count,
+                                     gpu_model=gpu_model,
+                                     boot_disk=disk,
+                                     metadata=tags)
 
     try:
-        api = cudo().cudo_api.virtual_machines()
-        vm = api.create_vm(cudo().cudo_api.project_id(), request)
+        api = cudo.cudo.cudo_api.virtual_machines()
+        vm = api.create_vm(cudo.cudo.cudo_api.project_id_throwable(), request)
         return vm.to_dict()['id']
-    except cudo().rest.ApiException as e:
+    except cudo.cudo.rest.ApiException as e:
         raise e
 
 
 def remove(instance_id: str):
     """Terminates the given instance."""
     terminate_ok = [
         'pend',
         'poff',
         'runn',
         'stop',
         'susp',
         'unde',
         'fail',
     ]
-    api = cudo().cudo_api.virtual_machines()
+    api = cudo.cudo.cudo_api.virtual_machines()
     max_retries = 10
     retry_interval = 5
     retry_count = 0
     state = 'unknown'
-    project_id = cudo().cudo_api.project_id()
+    project_id = cudo.cudo.cudo_api.project_id_throwable()
     while retry_count < max_retries:
         try:
             vm = api.get_vm(project_id, instance_id)
             state = vm.to_dict()['vm']['short_state']
-        except cudo().rest.ApiException as e:
+        except cudo.cudo.rest.ApiException as e:
             raise e
 
         if state in terminate_ok:
             break
         retry_count += 1
         time.sleep(retry_interval)
     else:
         raise Exception(
             'Timeout error, could not terminate due to VM state: {}'.format(
                 state))
 
     try:
         api.terminate_vm(project_id, instance_id)
-    except cudo().rest.ApiException as e:
+    except cudo.cudo.rest.ApiException as e:
         raise e
 
 
 def set_tags(instance_id: str, tags: Dict):
     """Sets the tags for the given instance."""
     try:
-        api = cudo().cudo_api.virtual_machines()
+        api = cudo.cudo.cudo_api.virtual_machines()
         api.update_vm_metadata(
-            cudo().cudo_api.project_id(), instance_id,
-            cudo().UpdateVMMetadataBody(
+            cudo.cudo.cudo_api.project_id(), instance_id,
+            cudo.cudo.UpdateVMMetadataBody(
                 metadata=tags,
                 merge=True))  # TODO (skypilot team) merge or overwrite?
-    except cudo().rest.ApiException as e:
+    except cudo.cudo.rest.ApiException as e:
         raise e
 
 
 def get_instance(vm_id):
     try:
-        api = cudo().cudo_api.virtual_machines()
-        vm = api.get_vm(cudo().cudo_api.project_id(), vm_id)
+        api = cudo.cudo.cudo_api.virtual_machines()
+        vm = api.get_vm(cudo.cudo.cudo_api.project_id_throwable(), vm_id)
         vm_dict = vm.to_dict()
         return vm_dict
-    except cudo().rest.ApiException as e:
+    except cudo.cudo.rest.ApiException as e:
         raise e
 
 
 def list_instances():
     try:
-        api = cudo().cudo_api.virtual_machines()
-        vms = api.list_vms(cudo().cudo_api.project_id())
+        api = cudo.cudo.cudo_api.virtual_machines()
+        vms = api.list_vms(cudo.cudo.cudo_api.project_id_throwable())
         instances = {}
         for vm in vms.to_dict()['vms']:
             ex_ip = vm['external_ip_address']
             in_ip = vm['internal_ip_address']
             if not in_ip:
                 in_ip = ex_ip
             instance = {
@@ -115,9 +115,9 @@
                 'name': vm['id'],
                 'ip': ex_ip,
                 'external_ip': ex_ip,
                 'internal_ip': in_ip
             }
             instances[vm['id']] = instance
         return instances
-    except cudo().rest.ApiException as e:
+    except cudo.cudo.rest.ApiException as e:
         raise e
```

### Comparing `skypilot-0.5.0/sky/provision/cudo/instance.py` & `skypilot-0.6.0/sky/provision/cudo/instance.py`

 * *Files 1% similar despite different names*

```diff
@@ -158,15 +158,15 @@
         cudo_wrapper.remove(inst_id)
 
 
 def get_cluster_info(
         region: str,
         cluster_name_on_cloud: str,
         provider_config: Optional[Dict[str, Any]] = None) -> common.ClusterInfo:
-    del region, provider_config
+    del region
     nodes = _filter_instances(cluster_name_on_cloud, ['runn', 'pend'])
     instances: Dict[str, List[common.InstanceInfo]] = {}
     head_instance_id = None
     for node_id, node_info in nodes.items():
         instances[node_id] = [
             common.InstanceInfo(
                 instance_id=node_id,
@@ -174,18 +174,18 @@
                 external_ip=node_info['external_ip'],
                 tags=node_info['tags'],
             )
         ]
         if node_info['name'].endswith('-head'):
             head_instance_id = node_id
 
-    return common.ClusterInfo(
-        instances=instances,
-        head_instance_id=head_instance_id,
-    )
+    return common.ClusterInfo(instances=instances,
+                              head_instance_id=head_instance_id,
+                              provider_name='cudo',
+                              provider_config=provider_config)
 
 
 def query_instances(
     cluster_name_on_cloud: str,
     provider_config: Optional[Dict[str, Any]] = None,
     non_terminated_only: bool = True,
 ) -> Dict[str, Optional[status_lib.ClusterStatus]]:
```

### Comparing `skypilot-0.5.0/sky/provision/docker_utils.py` & `skypilot-0.6.0/sky/provision/docker_utils.py`

 * *Files 12% similar despite different names*

```diff
@@ -1,27 +1,35 @@
 """Initialize docker containers on a remote node."""
 
 import dataclasses
 import shlex
 import time
-import typing
 from typing import Any, Dict, List
 
 from sky import sky_logging
 from sky.skylet import constants
+from sky.utils import command_runner
 from sky.utils import subprocess_utils
 
-if typing.TYPE_CHECKING:
-    from sky.utils import command_runner
-
 logger = sky_logging.init_logger(__name__)
 
 DOCKER_PERMISSION_DENIED_STR = ('permission denied while trying to connect to '
                                 'the Docker daemon socket')
 
+# Configure environment variables. A docker image can have environment variables
+# set in the Dockerfile with `ENV``. We need to export these variables to the
+# shell environment, so that our ssh session can access them.
+SETUP_ENV_VARS_CMD = (
+    'prefix_cmd() '
+    '{ if [ $(id -u) -ne 0 ]; then echo "sudo"; else echo ""; fi; } && '
+    'printenv | while IFS=\'=\' read -r key value; do echo "export $key=\\\"$value\\\""; done > '  # pylint: disable=line-too-long
+    '~/container_env_var.sh && '
+    '$(prefix_cmd) mv ~/container_env_var.sh /etc/profile.d/container_env_var.sh'
+)
+
 
 @dataclasses.dataclass
 class DockerLoginConfig:
     """Config for docker login. Used for pulling from private registries."""
     username: str
     password: str
     server: str
@@ -90,14 +98,18 @@
         # is executed.
         '--name {}'.format(container_name),
         '-d',
         '-it',
         env_flags,
         user_options_str,
         '--net=host',
+        # SkyPilot: Add following options to enable fuse.
+        '--cap-add=SYS_ADMIN',
+        '--device=/dev/fuse',
+        '--security-opt=apparmor:unconfined',
         image,
         'bash',
     ]
     return ' '.join(docker_run)
 
 
 def _with_interactive(cmd):
@@ -109,15 +121,15 @@
 
 # SkyPilot: New class to initialize docker containers on a remote node.
 # Adopted from ray.autoscaler._private.command_runner.DockerCommandRunner.
 class DockerInitializer:
     """Initializer for docker containers on a remote node."""
 
     def __init__(self, docker_config: Dict[str, Any],
-                 runner: 'command_runner.SSHCommandRunner', log_path: str):
+                 runner: 'command_runner.CommandRunner', log_path: str):
         self.docker_config = docker_config
         self.container_name = docker_config['container_name']
         self.runner = runner
         self.home_dir = None
         self.initialized = False
         # podman is not fully tested yet.
         use_podman = docker_config.get('use_podman', False)
@@ -158,16 +170,15 @@
                 'Failed to run docker command, retrying in 10 seconds... '
                 f'({cnt}/{retry})')
             time.sleep(10)
         subprocess_utils.handle_returncode(
             rc,
             cmd,
             error_msg='Failed to run docker setup commands',
-            stderr=stdout + stderr,
-            stream_logs=False)
+            stderr=stdout + stderr)
         return stdout.strip()
 
     def initialize(self) -> str:
         specific_image = self.docker_config['image']
 
         self._check_docker_installed()
 
@@ -210,48 +221,66 @@
                 f'{self.docker_cmd} pull {specific_image}',
                 wait_for_docker_daemon=True)
 
         logger.info(f'Starting container {self.container_name} with image '
                     f'{specific_image}')
         container_running = self._check_container_status()
         if container_running:
-            running_image = (self._run(
-                check_docker_image(self.container_name, self.docker_cmd)))
+            running_image = self._run(
+                check_docker_image(self.container_name, self.docker_cmd))
             if running_image != specific_image:
                 logger.error(
                     f'A container with name {self.container_name} is running '
                     f'image {running_image} instead of {specific_image} (which '
                     'was provided in the YAML)')
         else:
+            # Edit docker config first to avoid disconnecting the container
+            # from GPUs when a systemctl command is called. This is a known
+            # issue with nvidia container toolkit:
+            # https://github.com/NVIDIA/nvidia-container-toolkit/issues/48
+            self._run(
+                '[ -f /etc/docker/daemon.json ] || '
+                'echo "{}" | sudo tee /etc/docker/daemon.json;'
+                'sudo jq \'.["exec-opts"] = ["native.cgroupdriver=cgroupfs"]\' '
+                '/etc/docker/daemon.json > /tmp/daemon.json;'
+                'sudo mv /tmp/daemon.json /etc/docker/daemon.json;'
+                'sudo systemctl restart docker')
             user_docker_run_options = self.docker_config.get('run_options', [])
             start_command = docker_start_cmds(
                 specific_image,
                 self.container_name,
                 self._configure_runtime(
                     self._auto_configure_shm(user_docker_run_options)),
                 self.docker_cmd,
             )
             self._run(start_command)
 
         # SkyPilot: Setup Commands.
+        # TODO(zhwu): the following setups should be aligned with the kubernetes
+        # pod setup, like provision.kubernetes.instance::_set_env_vars_in_pods
         # TODO(tian): These setup commands assumed that the container is
         # debian-based. We should make it more general.
         # Most of docker images are using root as default user, so we set an
         # alias for sudo to empty string, therefore any sudo in the following
         # commands won't fail.
         # Disable apt-get from asking user input during installation.
         # see https://askubuntu.com/questions/909277/avoiding-user-interaction-with-tzdata-when-installing-certbot-in-a-docker-contai  # pylint: disable=line-too-long
         self._run(
-            'echo \'[ "$(whoami)" == "root" ] && alias sudo=""\' >> ~/.bashrc;'
+            f'echo \'{command_runner.ALIAS_SUDO_TO_EMPTY_FOR_ROOT_CMD}\' '
+            '>> ~/.bashrc;'
             'echo "export DEBIAN_FRONTEND=noninteractive" >> ~/.bashrc;',
             run_env='docker')
         # Install dependencies.
         self._run(
-            'sudo apt-get update; sudo apt-get install -y rsync curl wget '
-            'patch openssh-server python3-pip;',
+            'sudo apt-get update; '
+            # Our mount script will install gcsfuse without fuse package.
+            # We need to install fuse package first to enable storage mount.
+            # The dpkg option is to suppress the prompt for fuse installation.
+            'sudo apt-get -o DPkg::Options::="--force-confnew" install -y '
+            'rsync curl wget patch openssh-server python3-pip fuse;',
             run_env='docker')
 
         # Copy local authorized_keys to docker container.
         # Stop and disable jupyter service. This is to avoid port conflict on
         # 8080 if we use default deep learning image in GCP, and 8888 if we use
         # default deep learning image in Azure.
         # Azure also has a jupyterhub service running on 8081, so we stop and
@@ -276,15 +305,16 @@
         port = constants.DEFAULT_DOCKER_PORT
         # pylint: disable=anomalous-backslash-in-string
         self._run(
             f'sudo sed -i "s/#Port 22/Port {port}/" /etc/ssh/sshd_config;'
             'mkdir -p ~/.ssh;'
             'cat /tmp/host_ssh_authorized_keys >> ~/.ssh/authorized_keys;'
             'sudo service ssh start;'
-            'sudo sed -i "s/mesg n/tty -s \&\& mesg n/" ~/.profile;',
+            'sudo sed -i "s/mesg n/tty -s \&\& mesg n/" ~/.profile;'
+            f'{SETUP_ENV_VARS_CMD}',
             run_env='docker')
 
         # SkyPilot: End of Setup Commands.
         docker_user = self._run('whoami', run_env='docker')
         self.initialized = True
         return docker_user
```

### Comparing `skypilot-0.5.0/sky/provision/fluidstack/__init__.py` & `skypilot-0.6.0/sky/provision/fluidstack/__init__.py`

 * *Files 5% similar despite different names*

```diff
@@ -1,10 +1,11 @@
 """Fluidstack provisioner module."""
 
 from sky.provision.fluidstack.config import bootstrap_instances
 from sky.provision.fluidstack.instance import cleanup_ports
 from sky.provision.fluidstack.instance import get_cluster_info
+from sky.provision.fluidstack.instance import open_ports
 from sky.provision.fluidstack.instance import query_instances
 from sky.provision.fluidstack.instance import run_instances
 from sky.provision.fluidstack.instance import stop_instances
 from sky.provision.fluidstack.instance import terminate_instances
 from sky.provision.fluidstack.instance import wait_instances
```

### Comparing `skypilot-0.5.0/sky/provision/fluidstack/fluidstack_utils.py` & `skypilot-0.6.0/sky/provision/fluidstack/fluidstack_utils.py`

 * *Files 6% similar despite different names*

```diff
@@ -4,16 +4,14 @@
 import json
 import os
 from typing import Any, Dict, List, Optional
 import uuid
 
 import requests
 
-from sky.clouds.service_catalog.data_fetchers import fetch_fluidstack
-
 
 def get_key_suffix():
     return str(uuid.uuid4()).replace('-', '')[:8]
 
 
 ENDPOINT = 'https://api.fluidstack.io/v1/'
 FLUIDSTACK_API_KEY_PATH = '~/.fluidstack/api_key'
@@ -115,25 +113,16 @@
         hostname: str = '',
         region: str = '',
         ssh_pub_key: str = '',
         count: int = 1,
     ) -> List[str]:
         """Launch new instances."""
 
-        config = {}
+        config: Dict[str, Any] = {}
         plans = self.get_plans()
-        if 'custom' in instance_type:
-            values = instance_type.split(':')
-            index = values[1]
-            instance_type = values[2]
-            config = fetch_fluidstack.CUSTOM_PLANS_CONFIG[int(index)]
-            plan = [plan for plan in plans if plan['plan_id'] == instance_type
-                   ][0]
-            config['gpu_model'] = plan['gpu_type']
-
         regions = self.list_regions()
         plans = [
             plan for plan in plans if plan['plan_id'] == instance_type and
             region in [r['id'] for r in plan['regions']]
         ]
         if not plans:
             raise FluidstackAPIError(
@@ -149,15 +138,17 @@
                     multiplicity=count,
                     config=config)
 
         response = requests.post(ENDPOINT + 'server',
                                  auth=(self.api_key, self.api_token),
                                  json=body)
         raise_fluidstack_error(response)
-        return response.json().get('multiple')
+        instance_ids = response.json().get('multiple')
+        assert all(id is not None for id in instance_ids), instance_ids
+        return instance_ids
 
     def list_ssh_keys(self):
         response = requests.get(ENDPOINT + 'ssh',
                                 auth=(self.api_key, self.api_token))
         raise_fluidstack_error(response)
         return response.json()
 
@@ -227,15 +218,24 @@
         raise_fluidstack_error(response)
         return response.json()
 
     def status(self, instance_id: str):
         response = self.info(instance_id)
         return response['status']
 
-    def add_tags(self, instance_id: str, tags: Dict[str, str]):
+    def add_tags(self, instance_id: str, tags: Dict[str, str]) -> str:
         response = requests.patch(
             ENDPOINT + f'server/{instance_id}/tag',
             auth=(self.api_key, self.api_token),
             json=dict(tags=json.dumps(tags)),
         )
         raise_fluidstack_error(response)
         return response.json()
+
+    def rename(self, instance_id: str, hostname: str) -> str:
+        response = requests.patch(
+            ENDPOINT + f'server/{instance_id}/rename',
+            auth=(self.api_key, self.api_token),
+            json=dict(name=hostname),
+        )
+        raise_fluidstack_error(response)
+        return response.json()
```

### Comparing `skypilot-0.5.0/sky/provision/fluidstack/instance.py` & `skypilot-0.6.0/sky/provision/paperspace/instance.py`

 * *Files 21% similar despite different names*

```diff
@@ -1,276 +1,320 @@
-"""FluidStack instance provisioning."""
+"""Paperspace instance provisioning."""
+
 import time
 from typing import Any, Dict, List, Optional
 
-from sky import authentication as auth
-from sky import exceptions
 from sky import sky_logging
 from sky import status_lib
 from sky.provision import common
-from sky.provision.fluidstack import fluidstack_utils as utils
-from sky.utils import command_runner
+from sky.provision.paperspace import utils
 from sky.utils import common_utils
-from sky.utils import subprocess_utils
 from sky.utils import ux_utils
 
-_GET_INTERNAL_IP_CMD = ('ip -4 -br addr show | grep UP | grep -Eo '
-                        r'"(10\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)|'
-                        r'172\.(1[6-9]|2[0-9]|3[0-1]))\.(25[0-5]|'
-                        r'2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|'
-                        r'2[0-4][0-9]|[01]?[0-9][0-9]?)"')
+# The maximum number of times to poll for the status of an operation.
 POLL_INTERVAL = 5
+MAX_POLLS = 60 // POLL_INTERVAL
+# Stopping instances can take several minutes, so we increase the timeout
+MAX_POLLS_FOR_UP_OR_STOP = MAX_POLLS * 8
 
 logger = sky_logging.init_logger(__name__)
 
 
-def get_internal_ip(node_info: Dict[str, Any]) -> None:
-    node_info['internal_ip'] = node_info['ip_address']
-    runner = command_runner.SSHCommandRunner(
-        node_info['ip_address'],
-        ssh_user=node_info['capabilities']['default_user_name'],
-        ssh_private_key=auth.PRIVATE_SSH_KEY_PATH)
-    result = runner.run(_GET_INTERNAL_IP_CMD,
-                        require_outputs=True,
-                        stream_logs=False)
-
-    if result[0] != 0:
-        # Some DCs do not have internal IPs and can fail when getting
-        # the IP. We set the `internal_ip` to the same as
-        # external IP. It should be fine as the `ray cluster`
-        # will also get and use that external IP in that case.
-        logger.debug('Failed get obtain private IP from node')
-    else:
-        node_info['internal_ip'] = result[1].strip()
-
-
 def _filter_instances(cluster_name_on_cloud: str,
                       status_filters: Optional[List[str]]) -> Dict[str, Any]:
-
-    instances = utils.FluidstackClient().list_instances()
+    client = utils.PaperspaceCloudClient()
+    instances = client.list_instances()
     possible_names = [
-        f'{cluster_name_on_cloud}-head', f'{cluster_name_on_cloud}-worker'
+        f'{cluster_name_on_cloud}-head',
+        f'{cluster_name_on_cloud}-worker',
     ]
 
     filtered_instances = {}
     for instance in instances:
-        if (status_filters is not None and
-                instance['status'] not in status_filters):
+        instance_id = instance['id']
+        if status_filters is not None and instance[
+                'state'] not in status_filters:
             continue
-        if instance.get('hostname') in possible_names:
-            filtered_instances[instance['id']] = instance
+        if instance.get('name') in possible_names:
+            filtered_instances[instance_id] = instance
     return filtered_instances
 
 
 def _get_head_instance_id(instances: Dict[str, Any]) -> Optional[str]:
     head_instance_id = None
     for inst_id, inst in instances.items():
-        if inst['hostname'].endswith('-head'):
+        if inst['name'].endswith('-head'):
             head_instance_id = inst_id
             break
     return head_instance_id
 
 
 def run_instances(region: str, cluster_name_on_cloud: str,
                   config: common.ProvisionConfig) -> common.ProvisionRecord:
     """Runs instances for the given cluster."""
 
     pending_status = [
-        'create',
-        'requesting',
-        'provisioning',
-        'customizing',
-        'starting',
-        'stopping',
-        'start',
-        'stop',
-        'reboot',
-        'rebooting',
+        'starting', 'restarting', 'upgrading', 'provisioning', 'stopping'
     ]
+    newly_started_instances = _filter_instances(cluster_name_on_cloud,
+                                                pending_status + ['off'])
+    client = utils.PaperspaceCloudClient()
 
     while True:
         instances = _filter_instances(cluster_name_on_cloud, pending_status)
         if not instances:
             break
-        logger.info(f'Waiting for {len(instances)} instances to be ready.')
+        instance_statuses = [
+            instance['state'] for instance in instances.values()
+        ]
+        logger.info(f'Waiting for {len(instances)} instances to be ready: '
+                    f'{instance_statuses}')
+        time.sleep(POLL_INTERVAL)
+
+    exist_instances = _filter_instances(cluster_name_on_cloud,
+                                        status_filters=pending_status +
+                                        ['ready', 'off'])
+    if len(exist_instances) > config.count:
+        raise RuntimeError(
+            f'Cluster {cluster_name_on_cloud} already has '
+            f'{len(exist_instances)} nodes, but {config.count} are required.')
+
+    stopped_instances = _filter_instances(cluster_name_on_cloud,
+                                          status_filters=['off'])
+    for instance_id in stopped_instances:
+        try:
+            client.start(instance_id=instance_id)
+        except utils.PaperspaceCloudError as e:
+            if 'This machine is currently starting.' in str(e):
+                continue
+            raise e
+    while True:
+        instances = _filter_instances(cluster_name_on_cloud,
+                                      pending_status + ['off'])
+        if not instances:
+            break
+        num_stopped_instances = len(stopped_instances)
+        num_restarted_instances = num_stopped_instances - len(instances)
+        logger.info(
+            f'Waiting for {num_restarted_instances}/{num_stopped_instances} '
+            'stopped instances to be restarted.')
         time.sleep(POLL_INTERVAL)
-    exist_instances = _filter_instances(cluster_name_on_cloud, ['running'])
-    head_instance_id = _get_head_instance_id(exist_instances)
 
+    exist_instances = _filter_instances(cluster_name_on_cloud,
+                                        status_filters=['ready'])
+    head_instance_id = _get_head_instance_id(exist_instances)
     to_start_count = config.count - len(exist_instances)
     if to_start_count < 0:
         raise RuntimeError(
             f'Cluster {cluster_name_on_cloud} already has '
             f'{len(exist_instances)} nodes, but {config.count} are required.')
     if to_start_count == 0:
         if head_instance_id is None:
-            raise RuntimeError(
-                f'Cluster {cluster_name_on_cloud} has no head node.')
+            head_instance_id = list(exist_instances.keys())[0]
+            client.rename(
+                instance_id=head_instance_id,
+                name=f'{cluster_name_on_cloud}-head',
+            )
+        assert head_instance_id is not None, (
+            'head_instance_id should not be None')
         logger.info(f'Cluster {cluster_name_on_cloud} already has '
                     f'{len(exist_instances)} nodes, no need to start more.')
-        return common.ProvisionRecord(provider_name='fluidstack',
-                                      cluster_name=cluster_name_on_cloud,
-                                      region=region,
-                                      zone=None,
-                                      head_instance_id=head_instance_id,
-                                      resumed_instance_ids=[],
-                                      created_instance_ids=[])
+        return common.ProvisionRecord(
+            provider_name='paperspace',
+            cluster_name=cluster_name_on_cloud,
+            region=region,
+            zone=None,
+            head_instance_id=head_instance_id,
+            resumed_instance_ids=list(newly_started_instances.keys()),
+            created_instance_ids=[],
+        )
 
     created_instance_ids = []
     for _ in range(to_start_count):
         node_type = 'head' if head_instance_id is None else 'worker'
         try:
-            instance_ids = utils.FluidstackClient().create_instance(
-                hostname=f'{cluster_name_on_cloud}-{node_type}',
+            instance_id = client.launch(
+                name=f'{cluster_name_on_cloud}-{node_type}',
                 instance_type=config.node_config['InstanceType'],
-                ssh_pub_key=config.node_config['AuthorizedKey'],
-                region=region)
+                network_id=config.node_config['NetworkId'],
+                region=region,
+                disk_size=config.node_config['DiskSize'],
+            )['data']['id']
         except Exception as e:  # pylint: disable=broad-except
             logger.warning(f'run_instances error: {e}')
-            raise
-        logger.info(f'Launched instance {instance_ids[0]}.')
-        created_instance_ids.append(instance_ids[0])
+            raise e
+        logger.info(f'Launched instance {instance_id}.')
+        created_instance_ids.append(instance_id)
         if head_instance_id is None:
-            head_instance_id = instance_ids[0]
+            head_instance_id = instance_id
 
     # Wait for instances to be ready.
-    while True:
-        instances = _filter_instances(cluster_name_on_cloud, ['running'])
-        ready_instance_cnt = len(instances)
+    for _ in range(MAX_POLLS_FOR_UP_OR_STOP):
+        instances = _filter_instances(cluster_name_on_cloud, ['ready'])
         logger.info('Waiting for instances to be ready: '
-                    f'({ready_instance_cnt}/{config.count}).')
-        if ready_instance_cnt == config.count:
+                    f'({len(instances)}/{config.count}).')
+        if len(instances) == config.count:
             break
-        failed_instances = _filter_instances(
-            cluster_name_on_cloud,
-            ['timeout error', 'failed to create', 'out of stock'])
-        if failed_instances:
-            logger.error(f'Failed to create {len(failed_instances)}'
-                         f'instances for cluster {cluster_name_on_cloud}')
-            raise RuntimeError(
-                f'Failed to create {len(failed_instances)} instances.')
 
         time.sleep(POLL_INTERVAL)
+    else:
+        # Failed to launch config.count of instances after max retries
+        msg = ('run_instances: Failed to create the'
+               'instances due to capacity issue.')
+        logger.warning(msg)
+        raise RuntimeError(msg)
     assert head_instance_id is not None, 'head_instance_id should not be None'
-    return common.ProvisionRecord(provider_name='fluidstack',
-                                  cluster_name=cluster_name_on_cloud,
-                                  region=region,
-                                  zone=None,
-                                  head_instance_id=head_instance_id,
-                                  resumed_instance_ids=[],
-                                  created_instance_ids=created_instance_ids)
+    return common.ProvisionRecord(
+        provider_name='paperspace',
+        cluster_name=cluster_name_on_cloud,
+        region=region,
+        zone=None,
+        head_instance_id=head_instance_id,
+        resumed_instance_ids=list(stopped_instances.keys()),
+        created_instance_ids=created_instance_ids,
+    )
 
 
 def wait_instances(region: str, cluster_name_on_cloud: str,
                    state: Optional[status_lib.ClusterStatus]) -> None:
-    del region, cluster_name_on_cloud, state
+    del region, cluster_name_on_cloud, state  # unused
+    # We already wait on ready state in `run_instances` no need
 
 
 def stop_instances(
     cluster_name_on_cloud: str,
     provider_config: Optional[Dict[str, Any]] = None,
     worker_only: bool = False,
 ) -> None:
-    raise NotImplementedError()
+    del provider_config  # unused
+    client = utils.PaperspaceCloudClient()
+    all_instances = _filter_instances(cluster_name_on_cloud, [
+        'ready', 'serviceready', 'upgrading', 'provisioning', 'starting',
+        'restarting'
+    ])
+    num_instances = len(all_instances)
+
+    # Request a stop on all instances
+    for instance_id, instance in all_instances.items():
+        if worker_only and instance['name'].endswith('-head'):
+            num_instances -= 1
+            continue
+        client.stop(instance_id=instance_id)
+
+    # Wait for instances to stop
+    for _ in range(MAX_POLLS_FOR_UP_OR_STOP):
+        all_instances = _filter_instances(cluster_name_on_cloud, ['off'])
+        if len(all_instances) >= num_instances:
+            break
+        time.sleep(POLL_INTERVAL)
+    else:
+        raise RuntimeError(f'Maximum number of polls: '
+                           f'{MAX_POLLS_FOR_UP_OR_STOP} reached. '
+                           f'Instance {all_instances} is still not in '
+                           'STOPPED status.')
 
 
 def terminate_instances(
     cluster_name_on_cloud: str,
     provider_config: Optional[Dict[str, Any]] = None,
     worker_only: bool = False,
 ) -> None:
     """See sky/provision/__init__.py"""
     del provider_config  # unused
+    client = utils.PaperspaceCloudClient()
     instances = _filter_instances(cluster_name_on_cloud, None)
     for inst_id, inst in instances.items():
-        logger.debug(f'Terminating instance {inst_id}: {inst}')
-        if worker_only and inst['hostname'].endswith('-head'):
+        logger.debug(f'Terminating instance {inst_id}')
+        if worker_only and inst['name'].endswith('-head'):
             continue
         try:
-            utils.FluidstackClient().delete(inst_id)
+            client.remove(inst_id)
         except Exception as e:  # pylint: disable=broad-except
-            if (isinstance(e, utils.FluidstackAPIError) and
-                    'Machine is already terminated' in str(e)):
-                logger.debug(f'Instance {inst_id} is already terminated.')
-                continue
             with ux_utils.print_exception_no_traceback():
                 raise RuntimeError(
                     f'Failed to terminate instance {inst_id}: '
                     f'{common_utils.format_exception(e, use_bracket=False)}'
                 ) from e
 
+    # TODO(asaiacai): Possible private network resource leakage for autodown
+    if not worker_only:
+        try:
+            time.sleep(POLL_INTERVAL)
+            network = client.get_network(network_name=cluster_name_on_cloud)
+            client.delete_network(network_id=network['id'])
+        except IndexError:
+            logger.warning(f'Network {cluster_name_on_cloud}'
+                           'already deleted')
+
 
 def get_cluster_info(
-        region: str,
-        cluster_name_on_cloud: str,
-        provider_config: Optional[Dict[str, Any]] = None) -> common.ClusterInfo:
-    del region, provider_config  # unused
-    running_instances = _filter_instances(cluster_name_on_cloud, ['running'])
+    region: str,
+    cluster_name_on_cloud: str,
+    provider_config: Optional[Dict[str, Any]] = None,
+) -> common.ClusterInfo:
+    del region  # unused
+    running_instances = _filter_instances(cluster_name_on_cloud, ['ready'])
     instances: Dict[str, List[common.InstanceInfo]] = {}
-
-    subprocess_utils.run_in_parallel(get_internal_ip,
-                                     list(running_instances.values()))
     head_instance_id = None
     for instance_id, instance_info in running_instances.items():
-        instance_id = instance_info['id']
         instances[instance_id] = [
             common.InstanceInfo(
                 instance_id=instance_id,
-                internal_ip=instance_info['internal_ip'],
-                external_ip=instance_info['ip_address'],
-                ssh_port=instance_info['ssh_port'],
+                internal_ip=instance_info['privateIp'],
+                external_ip=instance_info['publicIp'],
+                ssh_port=22,
                 tags={},
             )
         ]
-        if instance_info['hostname'].endswith('-head'):
+        if instance_info['name'].endswith('-head'):
             head_instance_id = instance_id
 
-    return common.ClusterInfo(instances=instances,
-                              head_instance_id=head_instance_id,
-                              custom_ray_options={'use_external_ip': True})
+    return common.ClusterInfo(
+        instances=instances,
+        head_instance_id=head_instance_id,
+        provider_name='paperspace',
+        provider_config=provider_config,
+    )
 
 
 def query_instances(
     cluster_name_on_cloud: str,
     provider_config: Optional[Dict[str, Any]] = None,
     non_terminated_only: bool = True,
 ) -> Dict[str, Optional[status_lib.ClusterStatus]]:
     """See sky/provision/__init__.py"""
+    del non_terminated_only
     assert provider_config is not None, (cluster_name_on_cloud, provider_config)
     instances = _filter_instances(cluster_name_on_cloud, None)
-    instances = _filter_instances(cluster_name_on_cloud, None)
+
     status_map = {
-        'provisioning': status_lib.ClusterStatus.INIT,
-        'requesting': status_lib.ClusterStatus.INIT,
-        'create': status_lib.ClusterStatus.INIT,
-        'customizing': status_lib.ClusterStatus.INIT,
-        'stopping': status_lib.ClusterStatus.STOPPED,
-        'stop': status_lib.ClusterStatus.STOPPED,
-        'start': status_lib.ClusterStatus.INIT,
-        'reboot': status_lib.ClusterStatus.STOPPED,
-        'rebooting': status_lib.ClusterStatus.STOPPED,
-        'stopped': status_lib.ClusterStatus.STOPPED,
         'starting': status_lib.ClusterStatus.INIT,
-        'running': status_lib.ClusterStatus.UP,
-        'failed to create': status_lib.ClusterStatus.INIT,
-        'timeout error': status_lib.ClusterStatus.INIT,
-        'out of stock': status_lib.ClusterStatus.INIT,
-        'terminated': None,
+        'restarting': status_lib.ClusterStatus.INIT,
+        'upgrading': status_lib.ClusterStatus.INIT,
+        'provisioning': status_lib.ClusterStatus.INIT,
+        'stopping': status_lib.ClusterStatus.INIT,
+        'serviceready': status_lib.ClusterStatus.INIT,
+        'ready': status_lib.ClusterStatus.UP,
+        'off': status_lib.ClusterStatus.STOPPED,
     }
     statuses: Dict[str, Optional[status_lib.ClusterStatus]] = {}
     for inst_id, inst in instances.items():
-        if inst['status'] not in status_map:
-            with ux_utils.print_exception_no_traceback():
-                raise exceptions.ClusterStatusFetchingError(
-                    f'Failed to parse status from Fluidstack: {inst["status"]}')
-        status = status_map.get(inst['status'], None)
-        if non_terminated_only and status is None:
-            continue
+        status = status_map[inst['state']]
         statuses[inst_id] = status
     return statuses
 
 
+def open_ports(
+    cluster_name_on_cloud: str,
+    ports: List[str],
+    provider_config: Optional[Dict[str, Any]] = None,
+) -> None:
+    """See sky/provision/__init__.py"""
+    del cluster_name_on_cloud, provider_config, ports
+
+
 def cleanup_ports(
     cluster_name_on_cloud: str,
+    ports: List[str],
     provider_config: Optional[Dict[str, Any]] = None,
 ) -> None:
-    del cluster_name_on_cloud, provider_config
+    del cluster_name_on_cloud, provider_config, ports
```

### Comparing `skypilot-0.5.0/sky/provision/gcp/__init__.py` & `skypilot-0.6.0/sky/provision/gcp/__init__.py`

 * *Files 8% similar despite different names*

```diff
@@ -1,12 +1,11 @@
 """GCP provisioner for SkyPilot."""
 
 from sky.provision.gcp.config import bootstrap_instances
 from sky.provision.gcp.instance import cleanup_ports
 from sky.provision.gcp.instance import get_cluster_info
 from sky.provision.gcp.instance import open_ports
 from sky.provision.gcp.instance import query_instances
-from sky.provision.gcp.instance import query_ports
 from sky.provision.gcp.instance import run_instances
 from sky.provision.gcp.instance import stop_instances
 from sky.provision.gcp.instance import terminate_instances
 from sky.provision.gcp.instance import wait_instances
```

### Comparing `skypilot-0.5.0/sky/provision/gcp/config.py` & `skypilot-0.6.0/sky/provision/gcp/config.py`

 * *Files 4% similar despite different names*

```diff
@@ -238,32 +238,57 @@
             })
 
     if already_configured:
         # In some managed environments, an admin needs to grant the
         # roles, so only call setIamPolicy if needed.
         return True, policy
 
-    for binding in original_policy['bindings']:
-        if member_id in binding['members']:
-            role = binding['role']
-            try:
-                role_definition = iam.projects().roles().get(
-                    name=role).execute()
-            except TypeError as e:
-                if 'does not match the pattern' in str(e):
-                    logger.info('_configure_iam_role: fail to check permission '
-                                f'for built-in role {role}. skipped.')
-                    permissions = []
+    # TODO(zhwu): It is possible that the permission is only granted at the
+    # service-account level, not at the project level. We should check the
+    # permission at both levels.
+    # For example, `roles/iam.serviceAccountUser` can be granted at the
+    # skypilot-v1 service account level, which can be checked with
+    # service_account_policy = iam.projects().serviceAccounts().getIamPolicy(
+    #    resource=f'projects/{project_id}/serviceAcccounts/{email}').execute()
+    # We now skip the check for `iam.serviceAccounts.actAs` permission for
+    # simplicity as it can be granted at the service account level.
+    def check_permissions(policy, required_permissions):
+        for binding in policy['bindings']:
+            if member_id in binding['members']:
+                role = binding['role']
+                logger.info(f'_configure_iam_role: role {role} is attached to '
+                            f'{member_id}...')
+                try:
+                    role_definition = iam.projects().roles().get(
+                        name=role).execute()
+                except TypeError as e:
+                    if 'does not match the pattern' in str(e):
+                        logger.info(
+                            '_configure_iam_role: fail to check permission '
+                            f'for built-in role {role}. Fallback to predefined '
+                            'permission list.')
+                        # Built-in roles cannot be checked for permissions with
+                        # the current API, so we fallback to predefined list
+                        # to find the implied permissions.
+                        permissions = constants.BUILTIN_ROLE_TO_PERMISSIONS.get(
+                            role, [])
+                    else:
+                        raise
                 else:
-                    raise
-            else:
-                permissions = role_definition['includedPermissions']
-            required_permissions -= set(permissions)
-        if not required_permissions:
-            break
+                    permissions = role_definition['includedPermissions']
+                    logger.info(f'_configure_iam_role: role {role} has '
+                                f'permissions {permissions}.')
+                required_permissions -= set(permissions)
+            if not required_permissions:
+                break
+        return required_permissions
+
+    # Check the permissions
+    required_permissions = check_permissions(original_policy,
+                                             required_permissions)
     if not required_permissions:
         # All required permissions are already granted.
         return True, policy
     logger.info(
         f'_configure_iam_role: missing permisisons {required_permissions}')
 
     return False, policy
```

### Comparing `skypilot-0.5.0/sky/provision/gcp/constants.py` & `skypilot-0.6.0/sky/provision/gcp/constants.py`

 * *Files 4% similar despite different names*

```diff
@@ -161,28 +161,49 @@
     'compute.globalOperations.get',
     'compute.subnetworks.use',
     'compute.subnetworks.list',
     'compute.subnetworks.useExternalIp',
     'compute.projects.get',
     'compute.zoneOperations.get',
     'iam.roles.get',
-    'iam.serviceAccounts.actAs',
+    # We now skip the check for `iam.serviceAccounts.actAs` permission for
+    # simplicity as it can be granted at the service-account level.
+    # Check: sky.provision.gcp.config::_is_permission_satisfied
+    # 'iam.serviceAccounts.actAs',
     'iam.serviceAccounts.get',
     'serviceusage.services.enable',
     'serviceusage.services.list',
     'serviceusage.services.use',
     'resourcemanager.projects.get',
     'resourcemanager.projects.getIamPolicy',
 ]
 
+# Permissions implied by GCP built-in roles. We hardcode these here, as we
+# cannot get the permissions of built-in role from the GCP Python API.
+# The lists are not exhaustive, but should cover the permissions listed in
+# VM_MINIMAL_PERMISSIONS.
+# Check: sky.provision.gcp.config::_is_permission_satisfied
+BUILTIN_ROLE_TO_PERMISSIONS = {
+    'roles/iam.serviceAccountUser': ['iam.serviceAccounts.actAs'],
+    'roles/iam.serviceAccountViewer': [
+        'iam.serviceAccounts.get', 'iam.serviceAccounts.getIamPolicy'
+    ],
+    # TODO(zhwu): Add more built-in roles to make the permission check more
+    # robust.
+}
+
 FIREWALL_PERMISSIONS = [
     'compute.firewalls.create',
     'compute.firewalls.delete',
 ]
 
+RESERVATION_PERMISSIONS = [
+    'compute.reservations.list',
+]
+
 TPU_MINIMAL_PERMISSIONS = [
     'tpu.nodes.create',
     'tpu.nodes.delete',
     'tpu.nodes.list',
     'tpu.nodes.get',
     'tpu.nodes.update',
     'tpu.operations.get',
```

### Comparing `skypilot-0.5.0/sky/provision/gcp/instance.py` & `skypilot-0.6.0/sky/provision/gcp/instance.py`

 * *Files 2% similar despite different names*

```diff
@@ -424,14 +424,16 @@
         if insts and insts[0]:
             head_instance_id = insts[0]
             break
 
     return common.ClusterInfo(
         instances=instances,
         head_instance_id=head_instance_id,
+        provider_name='gcp',
+        provider_config=provider_config,
     )
 
 
 def stop_instances(
     cluster_name_on_cloud: str,
     provider_config: Optional[Dict[str, Any]] = None,
     worker_only: bool = False,
@@ -611,17 +613,7 @@
             firewall_rule_name = f'user-ports-{cluster_name_on_cloud}-{port}'
             instance_utils.GCPComputeInstance.delete_firewall_rule(
                 project_id, firewall_rule_name)
     if 'firewall_rule' in provider_config:
         firewall_rule_name = provider_config['firewall_rule']
         instance_utils.GCPComputeInstance.delete_firewall_rule(
             project_id, firewall_rule_name)
-
-
-def query_ports(
-    cluster_name_on_cloud: str,
-    ports: List[str],
-    provider_config: Optional[Dict[str, Any]] = None,
-) -> Dict[int, List[common.Endpoint]]:
-    """See sky/provision/__init__.py"""
-    return common.query_ports_passthrough(cluster_name_on_cloud, ports,
-                                          provider_config)
```

### Comparing `skypilot-0.5.0/sky/provision/gcp/instance_utils.py` & `skypilot-0.6.0/sky/provision/gcp/instance_utils.py`

 * *Files 1% similar despite different names*

```diff
@@ -408,15 +408,15 @@
         else:
             kwargs = {}
             operation_caller = cls.load_resource().globalOperations()
         logger.debug(
             f'Waiting GCP operation {operation["name"]} to be ready ...')
 
         @_retry_on_http_exception(
-            f'Fail to wait for operation {operation["name"]}')
+            f'Failed to wait for operation {operation["name"]}')
         def call_operation(fn, timeout: int):
             request = fn(
                 project=project_id,
                 operation=operation['name'],
                 **kwargs,
             )
             request.http.timeout = timeout
@@ -646,31 +646,40 @@
                     TAG_RAY_CLUSTER_NAME: cluster_name,
                     TAG_SKYPILOT_CLUSTER_NAME: cluster_name
                 }),
         })
 
         all_names = []
         if 'reservationAffinity' in config:
+            specific_reservations = set(config['reservationAffinity']['values'])
             reservations = gcp_cloud.GCP().get_reservations_available_resources(
                 config['machineType'],
                 region=zone.rpartition('-')[0],
                 zone=zone,
-                specific_reservations=set(
-                    config['reservationAffinity']['values']))
+                specific_reservations=specific_reservations)
+            # Filter the reservations by the user-specified ones, because
+            # reservations contain auto reservations as well, which do not
+            # need to explicitly specify in the config for creating instances.
+            specific_reservations_to_count = {
+                reservation: count
+                for reservation, count in reservations.items()
+                if reservation in specific_reservations
+            }
             # Sort the reservations by the number of available resources
-            reservation_list = sorted(reservations.items(),
-                                      key=lambda x: x[1],
-                                      reverse=True)
+            specified_reservations_list = sorted(
+                specific_reservations_to_count.items(),
+                key=lambda x: x[1],
+                reverse=True)
             # TODO(zhwu): Convert this to parallel execution.
             # TODO(zhwu): This is not atomic as the reservation count may change
             # between the time we check and the time we create the instances, as
             # other users may be creating instances at the same time.
             # Our current implementation will skip the current region if the
             # reservation count is not enough, which is suboptimal.
-            for reservation, reservation_count in reservation_list:
+            for reservation, reservation_count in specified_reservations_list:
                 if reservation_count <= 0:
                     continue
                 reservation_count = min(reservation_count, count)
                 logger.debug(f'Creating {reservation_count} instances '
                              f'with reservation {reservation}')
                 config['reservationAffinity']['values'] = [reservation]
                 created_names = names[:reservation_count]
@@ -952,15 +961,15 @@
     @classmethod
     def wait_for_operation(cls, operation: dict, project_id: str,
                            zone: Optional[str]) -> None:
         """Poll for TPU operation until finished."""
         del project_id, zone  # unused
 
         @_retry_on_http_exception(
-            f'Fail to wait for operation {operation["name"]}')
+            f'Failed to wait for operation {operation["name"]}')
         def call_operation(fn, timeout: int):
             request = fn(name=operation['name'])
             request.http.timeout = timeout
             return request.execute(num_retries=GCP_MAX_RETRIES)
 
         wait_start = time.time()
         while time.time() - wait_start < GCP_TIMEOUT:
@@ -1010,14 +1019,16 @@
             response = (cls.load_resource().projects().locations().nodes().list(
                 parent=path).execute(num_retries=GCP_MAX_RETRIES))
         except gcp.http_error_exception() as e:
             # SKY: Catch HttpError when accessing unauthorized region.
             # Return empty dict instead of raising exception to not break.
             if 'is not found or access is unauthorized.' in str(e):
                 return {}
+            if 'Permission \'tpu.nodes.list\' denied on' in str(e):
+                return {}
             logger.debug(f'filter: googleapiclient.errors.HttpError: {e}')
             raise
 
         instances = response.get('nodes', [])
 
         # filter_expr cannot be passed directly to API
         # so we need to filter the results ourselves
```

### Comparing `skypilot-0.5.0/sky/provision/instance_setup.py` & `skypilot-0.6.0/sky/provision/instance_setup.py`

 * *Files 8% similar despite different names*

```diff
@@ -1,68 +1,75 @@
 """Setup dependencies & services for instances."""
 from concurrent import futures
 import functools
 import hashlib
+import json
 import os
 import resource
 import time
 from typing import Any, Dict, List, Optional, Tuple
 
+from sky import provision
 from sky import sky_logging
 from sky.provision import common
 from sky.provision import docker_utils
 from sky.provision import logging as provision_logging
 from sky.provision import metadata_utils
 from sky.skylet import constants
+from sky.utils import accelerator_registry
 from sky.utils import command_runner
 from sky.utils import common_utils
 from sky.utils import subprocess_utils
 from sky.utils import ux_utils
 
 logger = sky_logging.init_logger(__name__)
 _START_TITLE = '\n' + '-' * 20 + 'Start: {} ' + '-' * 20
 _END_TITLE = '-' * 20 + 'End:   {} ' + '-' * 20 + '\n'
 
-_MAX_RETRY = 5
+_MAX_RETRY = 6
 
 # Increase the limit of the number of open files for the raylet process,
 # as the `ulimit` may not take effect at this point, because it requires
 # all the sessions to be reloaded. This is a workaround.
 _RAY_PRLIMIT = (
     'which prlimit && for id in $(pgrep -f raylet/raylet); '
     'do sudo prlimit --nofile=1048576:1048576 --pid=$id || true; done;')
 
 _DUMP_RAY_PORTS = (
-    'python -c \'import json, os; '
+    f'{constants.SKY_PYTHON_CMD} -c \'import json, os; '
     f'json.dump({constants.SKY_REMOTE_RAY_PORT_DICT_STR}, '
     f'open(os.path.expanduser("{constants.SKY_REMOTE_RAY_PORT_FILE}"), "w", '
     'encoding="utf-8"))\';')
 
 _RAY_PORT_COMMAND = (
-    'RAY_PORT=$(python -c "from sky.skylet import job_lib; '
-    'print(job_lib.get_ray_port())" 2> /dev/null || echo 6379);'
-    'python -c "from sky.utils import common_utils; '
+    f'RAY_PORT=$({constants.SKY_PYTHON_CMD} -c '
+    '"from sky.skylet import job_lib; print(job_lib.get_ray_port())" '
+    '2> /dev/null || echo 6379);'
+    f'{constants.SKY_PYTHON_CMD} -c "from sky.utils import common_utils; '
     'print(common_utils.encode_payload({\'ray_port\': $RAY_PORT}))"')
 
 # Command that calls `ray status` with SkyPilot's Ray port set.
 RAY_STATUS_WITH_SKY_RAY_PORT_COMMAND = (
     f'{_RAY_PORT_COMMAND}; '
-    'RAY_ADDRESS=127.0.0.1:$RAY_PORT ray status')
+    f'RAY_ADDRESS=127.0.0.1:$RAY_PORT {constants.SKY_RAY_CMD} status')
 
 # Command that waits for the ray status to be initialized. Otherwise, a later
 # `sky status -r` may fail due to the ray cluster not being ready.
 RAY_HEAD_WAIT_INITIALIZED_COMMAND = (
-    f'while `RAY_ADDRESS=127.0.0.1:{constants.SKY_REMOTE_RAY_PORT} '
-    'ray status | grep -q "No cluster status."`; do '
+    f'while `{constants.RAY_STATUS} | grep -q "No cluster status."`; do '
     'sleep 0.5; '
     'echo "Waiting ray cluster to be initialized"; '
     'done;')
 
 # Restart skylet when the version does not match to keep the skylet up-to-date.
-MAYBE_SKYLET_RESTART_CMD = 'python3 -m sky.skylet.attempt_skylet;'
+# We need to activate the python environment to make sure autostop in skylet
+# can find the cloud SDK/CLI in PATH.
+MAYBE_SKYLET_RESTART_CMD = (f'{constants.ACTIVATE_SKY_REMOTE_PYTHON_ENV}; '
+                            f'{constants.SKY_PYTHON_CMD} -m '
+                            'sky.skylet.attempt_skylet;')
 
 
 def _auto_retry(func):
     """Decorator that retries the function if it fails.
 
     This decorator is mostly for SSH disconnection issues, which might happen
     during the setup of instances.
@@ -116,49 +123,45 @@
                              max_workers: Optional[int] = None) -> List[Any]:
     if max_workers is None:
         # Not using the default value of `max_workers` in ThreadPoolExecutor,
         # as 32 is too large for some machines.
         max_workers = subprocess_utils.get_parallel_threads()
     with futures.ThreadPoolExecutor(max_workers=max_workers) as pool:
         results = []
-        for instance_id, metadatas in cluster_info.instances.items():
-            for i, metadata in enumerate(metadatas):
-                cache_id = f'{instance_id}-{i}'
-                runner = command_runner.SSHCommandRunner(
-                    metadata.get_feasible_ip(),
-                    port=metadata.ssh_port,
-                    **ssh_credentials)
-                wrapper = metadata_utils.cache_func(cluster_name, cache_id,
-                                                    stage_name, digest)
-                if (cluster_info.head_instance_id == instance_id and i == 0):
-                    # Log the head node's output to the provision.log
-                    log_path_abs = str(provision_logging.get_log_path())
-                else:
-                    log_dir_abs = metadata_utils.get_instance_log_dir(
-                        cluster_name, cache_id)
-                    log_path_abs = str(log_dir_abs / (stage_name + '.log'))
-                results.append(
-                    pool.submit(wrapper(func), runner, metadata, log_path_abs))
+        runners = provision.get_command_runners(cluster_info.provider_name,
+                                                cluster_info, **ssh_credentials)
+        # instance_ids is guaranteed to be in the same order as runners.
+        instance_ids = cluster_info.instance_ids()
+        for i, runner in enumerate(runners):
+            cache_id = instance_ids[i]
+            wrapper = metadata_utils.cache_func(cluster_name, cache_id,
+                                                stage_name, digest)
+            if i == 0:
+                # Log the head node's output to the provision.log
+                log_path_abs = str(provision_logging.get_log_path())
+            else:
+                log_dir_abs = metadata_utils.get_instance_log_dir(
+                    cluster_name, cache_id)
+                log_path_abs = str(log_dir_abs / (stage_name + '.log'))
+            results.append(pool.submit(wrapper(func), runner, log_path_abs))
 
         return [future.result() for future in results]
 
 
 @_log_start_end
 def initialize_docker(cluster_name: str, docker_config: Dict[str, Any],
                       cluster_info: common.ClusterInfo,
                       ssh_credentials: Dict[str, Any]) -> Optional[str]:
     """Setup docker on the cluster."""
     if not docker_config:
         return None
     _hint_worker_log_path(cluster_name, cluster_info, 'initialize_docker')
 
     @_auto_retry
-    def _initialize_docker(runner: command_runner.SSHCommandRunner,
-                           metadata: common.InstanceInfo, log_path: str):
-        del metadata  # Unused.
+    def _initialize_docker(runner: command_runner.CommandRunner, log_path: str):
         docker_user = docker_utils.DockerInitializer(docker_config, runner,
                                                      log_path).initialize()
         logger.debug(f'Initialized docker user: {docker_user}')
         return docker_user
 
     docker_users = _parallel_ssh_with_cache(
         _initialize_docker,
@@ -187,22 +190,42 @@
         digests.append(hashlib.sha256(cmd.encode()).digest())
     hasher = hashlib.sha256()
     for d in digests:
         hasher.update(d)
     digest = hasher.hexdigest()
 
     @_auto_retry
-    def _setup_node(runner: command_runner.SSHCommandRunner,
-                    metadata: common.InstanceInfo, log_path: str):
-        del metadata
+    def _setup_node(runner: command_runner.CommandRunner, log_path: str):
         for cmd in setup_commands:
-            returncode, stdout, stderr = runner.run(cmd,
-                                                    stream_logs=False,
-                                                    log_path=log_path,
-                                                    require_outputs=True)
+            returncode, stdout, stderr = runner.run(
+                cmd,
+                stream_logs=False,
+                log_path=log_path,
+                require_outputs=True,
+                # Installing dependencies requires source bashrc to access
+                # conda.
+                source_bashrc=True)
+            retry_cnt = 0
+            while returncode == 255 and retry_cnt < _MAX_RETRY:
+                # Got network connection issue occur during setup. This could
+                # happen when a setup step requires a reboot, e.g. nvidia-driver
+                # installation (happens for fluidstack). We should retry for it.
+                logger.info('Network connection issue during setup, this is '
+                            'likely due to the reboot of the instance. '
+                            'Retrying setup in 10 seconds.')
+                time.sleep(10)
+                retry_cnt += 1
+                returncode, stdout, stderr = runner.run(cmd,
+                                                        stream_logs=False,
+                                                        log_path=log_path,
+                                                        require_outputs=True,
+                                                        source_bashrc=True)
+                if not returncode:
+                    break
+
             if returncode:
                 raise RuntimeError(
                     'Failed to run setup commands on an instance. '
                     f'(exit code {returncode}). Error: '
                     f'===== stdout ===== \n{stdout}\n'
                     f'===== stderr ====={stderr}')
 
@@ -210,85 +233,103 @@
                              cluster_name,
                              stage_name='setup_runtime_on_cluster',
                              digest=digest,
                              cluster_info=cluster_info,
                              ssh_credentials=ssh_credentials)
 
 
+def _ray_gpu_options(custom_resource: str) -> str:
+    """Returns GPU options for the ray start command.
+
+    For some cases (e.g., within docker container), we need to explicitly set
+    --num-gpus to have ray clusters recognize the schedulable GPUs.
+    """
+    acc_dict = json.loads(custom_resource)
+    assert len(acc_dict) == 1, acc_dict
+    acc_name, acc_count = list(acc_dict.items())[0]
+    if accelerator_registry.is_schedulable_non_gpu_accelerator(acc_name):
+        return ''
+    # We need to manually set the number of GPUs, as it may not automatically
+    # detect the GPUs within the container.
+    return f' --num-gpus={acc_count}'
+
+
 @_log_start_end
 @_auto_retry
 def start_ray_on_head_node(cluster_name: str, custom_resource: Optional[str],
                            cluster_info: common.ClusterInfo,
                            ssh_credentials: Dict[str, Any]) -> None:
     """Start Ray on the head node."""
-    ip_list = cluster_info.get_feasible_ips()
-    port_list = cluster_info.get_ssh_ports()
-    ssh_runner = command_runner.SSHCommandRunner(ip_list[0],
-                                                 port=port_list[0],
-                                                 **ssh_credentials)
+    runners = provision.get_command_runners(cluster_info.provider_name,
+                                            cluster_info, **ssh_credentials)
+    head_runner = runners[0]
     assert cluster_info.head_instance_id is not None, (cluster_name,
                                                        cluster_info)
 
     # Log the head node's output to the provision.log
     log_path_abs = str(provision_logging.get_log_path())
     ray_options = (
         # --disable-usage-stats in `ray start` saves 10 seconds of idle wait.
         f'--disable-usage-stats '
         f'--port={constants.SKY_REMOTE_RAY_PORT} '
         f'--dashboard-port={constants.SKY_REMOTE_RAY_DASHBOARD_PORT} '
         f'--object-manager-port=8076 '
         f'--temp-dir={constants.SKY_REMOTE_RAY_TEMPDIR}')
     if custom_resource:
         ray_options += f' --resources=\'{custom_resource}\''
+        ray_options += _ray_gpu_options(custom_resource)
 
     if cluster_info.custom_ray_options:
         if 'use_external_ip' in cluster_info.custom_ray_options:
             cluster_info.custom_ray_options.pop('use_external_ip')
         for key, value in cluster_info.custom_ray_options.items():
             ray_options += f' --{key}={value}'
 
     # Unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY to avoid using credentials
     # from environment variables set by user. SkyPilot's ray cluster should use
     # the `~/.aws/` credentials, as that is the one used to create the cluster,
     # and the autoscaler module started by the `ray start` command should use
     # the same credentials. Otherwise, `ray status` will fail to fetch the
     # available nodes.
     # Reference: https://github.com/skypilot-org/skypilot/issues/2441
-    cmd = ('ray stop; unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY; '
+    cmd = (f'{constants.SKY_RAY_CMD} stop; '
+           'unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY; '
            'RAY_SCHEDULER_EVENTS=0 RAY_DEDUP_LOGS=0 '
-           f'ray start --head {ray_options} || exit 1;' + _RAY_PRLIMIT +
-           _DUMP_RAY_PORTS + RAY_HEAD_WAIT_INITIALIZED_COMMAND)
+           f'{constants.SKY_RAY_CMD} start --head {ray_options} || exit 1;' +
+           _RAY_PRLIMIT + _DUMP_RAY_PORTS + RAY_HEAD_WAIT_INITIALIZED_COMMAND)
     logger.info(f'Running command on head node: {cmd}')
     # TODO(zhwu): add the output to log files.
-    returncode, stdout, stderr = ssh_runner.run(cmd,
-                                                stream_logs=False,
-                                                log_path=log_path_abs,
-                                                require_outputs=True)
+    returncode, stdout, stderr = head_runner.run(
+        cmd,
+        stream_logs=False,
+        log_path=log_path_abs,
+        require_outputs=True,
+        # Source bashrc for starting ray cluster to make sure actors started by
+        # ray will have the correct PATH.
+        source_bashrc=True)
     if returncode:
         raise RuntimeError('Failed to start ray on the head node '
-                           f'(exit code {returncode}). Error: '
+                           f'(exit code {returncode}). Error: \n'
                            f'===== stdout ===== \n{stdout}\n'
                            f'===== stderr ====={stderr}')
 
 
 @_log_start_end
 @_auto_retry
 def start_ray_on_worker_nodes(cluster_name: str, no_restart: bool,
                               custom_resource: Optional[str], ray_port: int,
                               cluster_info: common.ClusterInfo,
                               ssh_credentials: Dict[str, Any]) -> None:
     """Start Ray on the worker nodes."""
     if cluster_info.num_instances <= 1:
         return
     _hint_worker_log_path(cluster_name, cluster_info, 'ray_cluster')
-    ip_list = cluster_info.get_feasible_ips()
-    ssh_runners = command_runner.SSHCommandRunner.make_runner_list(
-        ip_list[1:],
-        port_list=cluster_info.get_ssh_ports()[1:],
-        **ssh_credentials)
+    runners = provision.get_command_runners(cluster_info.provider_name,
+                                            cluster_info, **ssh_credentials)
+    worker_runners = runners[1:]
     worker_instances = cluster_info.get_worker_instances()
     cache_ids = []
     prev_instance_id = None
     cnt = 0
     for instance in worker_instances:
         if instance.instance_id != prev_instance_id:
             cnt = 0
@@ -309,54 +350,60 @@
                if not use_external_ip else head_instance.external_ip)
 
     ray_options = (f'--address={head_ip}:{constants.SKY_REMOTE_RAY_PORT} '
                    f'--object-manager-port=8076')
 
     if custom_resource:
         ray_options += f' --resources=\'{custom_resource}\''
+        ray_options += _ray_gpu_options(custom_resource)
 
     if cluster_info.custom_ray_options:
         for key, value in cluster_info.custom_ray_options.items():
             ray_options += f' --{key}={value}'
 
     # Unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY, see the comment in
     # `start_ray_on_head_node`.
-    cmd = (f'unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY; '
-           'RAY_SCHEDULER_EVENTS=0 RAY_DEDUP_LOGS=0 '
-           f'ray start --disable-usage-stats {ray_options} || exit 1;' +
-           _RAY_PRLIMIT)
+    cmd = (
+        f'unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY; '
+        'RAY_SCHEDULER_EVENTS=0 RAY_DEDUP_LOGS=0 '
+        f'{constants.SKY_RAY_CMD} start --disable-usage-stats {ray_options} || '
+        'exit 1;' + _RAY_PRLIMIT)
     if no_restart:
         # We do not use ray status to check whether ray is running, because
         # on worker node, if the user started their own ray cluster, ray status
         # will return 0, i.e., we don't know skypilot's ray cluster is running.
         # Instead, we check whether the raylet process is running on gcs address
         # that is connected to the head with the correct port.
         cmd = (f'RAY_PORT={ray_port}; ps aux | grep "ray/raylet/raylet" | '
                f'grep "gcs-address={head_ip}:${{RAY_PORT}}" || '
                f'{{ {cmd} }}')
     else:
-        cmd = 'ray stop; ' + cmd
+        cmd = f'{constants.SKY_RAY_CMD} stop; ' + cmd
 
     logger.info(f'Running command on worker nodes: {cmd}')
 
-    def _setup_ray_worker(runner_and_id: Tuple[command_runner.SSHCommandRunner,
+    def _setup_ray_worker(runner_and_id: Tuple[command_runner.CommandRunner,
                                                str]):
         # for cmd in config_from_yaml['worker_start_ray_commands']:
         #     cmd = cmd.replace('$RAY_HEAD_IP', ip_list[0][0])
         #     runner.run(cmd)
         runner, instance_id = runner_and_id
         log_dir = metadata_utils.get_instance_log_dir(cluster_name, instance_id)
         log_path_abs = str(log_dir / ('ray_cluster' + '.log'))
-        return runner.run(cmd,
-                          stream_logs=False,
-                          require_outputs=True,
-                          log_path=log_path_abs)
+        return runner.run(
+            cmd,
+            stream_logs=False,
+            require_outputs=True,
+            log_path=log_path_abs,
+            # Source bashrc for starting ray cluster to make sure actors started
+            # by ray will have the correct PATH.
+            source_bashrc=True)
 
     results = subprocess_utils.run_in_parallel(
-        _setup_ray_worker, list(zip(ssh_runners, cache_ids)))
+        _setup_ray_worker, list(zip(worker_runners, cache_ids)))
     for returncode, stdout, stderr in results:
         if returncode:
             with ux_utils.print_exception_no_traceback():
                 raise RuntimeError('Failed to start ray on the worker node '
                                    f'(exit code {returncode}). \n'
                                    'Detailed Error: \n'
                                    f'===== stdout ===== \n{stdout}\n'
@@ -366,36 +413,37 @@
 @_log_start_end
 @_auto_retry
 def start_skylet_on_head_node(cluster_name: str,
                               cluster_info: common.ClusterInfo,
                               ssh_credentials: Dict[str, Any]) -> None:
     """Start skylet on the head node."""
     del cluster_name
-    ip_list = cluster_info.get_feasible_ips()
-    port_list = cluster_info.get_ssh_ports()
-    ssh_runner = command_runner.SSHCommandRunner(ip_list[0],
-                                                 port=port_list[0],
-                                                 **ssh_credentials)
+    runners = provision.get_command_runners(cluster_info.provider_name,
+                                            cluster_info, **ssh_credentials)
+    head_runner = runners[0]
     assert cluster_info.head_instance_id is not None, cluster_info
     log_path_abs = str(provision_logging.get_log_path())
     logger.info(f'Running command on head node: {MAYBE_SKYLET_RESTART_CMD}')
-    returncode, stdout, stderr = ssh_runner.run(MAYBE_SKYLET_RESTART_CMD,
-                                                stream_logs=False,
-                                                require_outputs=True,
-                                                log_path=log_path_abs)
+    # We need to source bashrc for skylet to make sure the autostop event can
+    # access the path to the cloud CLIs.
+    returncode, stdout, stderr = head_runner.run(MAYBE_SKYLET_RESTART_CMD,
+                                                 stream_logs=False,
+                                                 require_outputs=True,
+                                                 log_path=log_path_abs,
+                                                 source_bashrc=True)
     if returncode:
         raise RuntimeError('Failed to start skylet on the head node '
                            f'(exit code {returncode}). Error: '
                            f'===== stdout ===== \n{stdout}\n'
                            f'===== stderr ====={stderr}')
 
 
 @_auto_retry
 def _internal_file_mounts(file_mounts: Dict,
-                          runner: command_runner.SSHCommandRunner,
+                          runner: command_runner.CommandRunner,
                           log_path: str) -> None:
     if file_mounts is None or not file_mounts:
         return
 
     for dst, src in file_mounts.items():
         # TODO: We should use this trick to speed up file mounting:
         # https://stackoverflow.com/questions/1636889/how-can-i-configure-rsync-to-create-target-directory-on-remote-server
@@ -449,17 +497,15 @@
 @_log_start_end
 def internal_file_mounts(cluster_name: str, common_file_mounts: Dict[str, str],
                          cluster_info: common.ClusterInfo,
                          ssh_credentials: Dict[str, str]) -> None:
     """Executes file mounts - rsyncing internal local files"""
     _hint_worker_log_path(cluster_name, cluster_info, 'internal_file_mounts')
 
-    def _setup_node(runner: command_runner.SSHCommandRunner,
-                    metadata: common.InstanceInfo, log_path: str):
-        del metadata
+    def _setup_node(runner: command_runner.CommandRunner, log_path: str):
         _internal_file_mounts(common_file_mounts, runner, log_path)
 
     _parallel_ssh_with_cache(
         _setup_node,
         cluster_name,
         stage_name='internal_file_mounts',
         # Do not cache the file mounts, as the cloud
```

### Comparing `skypilot-0.5.0/sky/provision/kubernetes/__init__.py` & `skypilot-0.6.0/sky/provision/kubernetes/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/provision/kubernetes/instance.py` & `skypilot-0.6.0/sky/provision/kubernetes/instance.py`

 * *Files 6% similar despite different names*

```diff
@@ -6,14 +6,15 @@
 
 from sky import exceptions
 from sky import sky_logging
 from sky import skypilot_config
 from sky import status_lib
 from sky.adaptors import kubernetes
 from sky.provision import common
+from sky.provision import docker_utils
 from sky.provision.kubernetes import config as config_lib
 from sky.provision.kubernetes import utils as kubernetes_utils
 from sky.utils import common_utils
 from sky.utils import kubernetes_enums
 from sky.utils import ux_utils
 
 POLL_INTERVAL = 2
@@ -160,17 +161,26 @@
 def _wait_for_pods_to_schedule(namespace, new_nodes, timeout: int):
     """Wait for all pods to be scheduled.
 
     Wait for all pods including jump pod to be scheduled, and if it
     exceeds the timeout, raise an exception. If pod's container
     is ContainerCreating, then we can assume that resources have been
     allocated and we can exit.
+
+    If timeout is set to a negative value, this method will wait indefinitely.
     """
     start_time = time.time()
-    while time.time() - start_time < timeout:
+
+    def _evaluate_timeout() -> bool:
+        # If timeout is negative, retry indefinitely.
+        if timeout < 0:
+            return True
+        return time.time() - start_time < timeout
+
+    while _evaluate_timeout():
         all_pods_scheduled = True
         for node in new_nodes:
             # Iterate over each pod to check their status
             pod = kubernetes.core_api().read_namespaced_pod(
                 node.metadata.name, namespace)
             if pod.status.phase == 'Pending':
                 # If container_statuses is None, then the pod hasn't
@@ -205,15 +215,15 @@
         all_pods_running = True
         # Iterate over each pod to check their status
         for node in new_nodes:
             pod = kubernetes.core_api().read_namespaced_pod(
                 node.metadata.name, namespace)
 
             # Continue if pod and all the containers within the
-            # pod are succesfully created and running.
+            # pod are successfully created and running.
             if pod.status.phase == 'Running' and all(
                     container.state.running
                     for container in pod.status.container_statuses):
                 continue
 
             all_pods_running = False
             if pod.status.phase == 'Pending':
@@ -228,33 +238,52 @@
                     if (waiting is not None and
                             waiting.reason != 'ContainerCreating'):
                         raise config_lib.KubernetesError(
                             'Failed to create container while launching '
                             'the node. Error details: '
                             f'{container_status.state.waiting.message}.')
             # Reaching this point means that one of the pods had an issue,
-            # so break out of the loop
+            # so break out of the loop, and wait until next second.
             break
 
         if all_pods_running:
             break
         time.sleep(1)
 
 
-def _run_command_on_pods(node_name, node_namespace, command):
+def _run_command_on_pods(node_name: str,
+                         node_namespace: str,
+                         command: List[str],
+                         stream_logs: bool = False):
+    """Run command on Kubernetes pods.
+
+    If `stream_logs` is True, we poll for output and error messages while the
+    command is executing, and the stdout and stderr is written to logger.info.
+    When called from the provisioner, this logger.info is written to the
+    provision.log file (see setup_provision_logging()).
+    """
     cmd_output = kubernetes.stream()(
         kubernetes.core_api().connect_get_namespaced_pod_exec,
         node_name,
         node_namespace,
         command=command,
         stderr=True,
         stdin=False,
         stdout=True,
         tty=False,
+        _preload_content=(not stream_logs),
         _request_timeout=kubernetes.API_TIMEOUT)
+    if stream_logs:
+        while cmd_output.is_open():
+            cmd_output.update(timeout=1)
+            if cmd_output.peek_stdout():
+                logger.info(f'{cmd_output.read_stdout().strip()}')
+            if cmd_output.peek_stderr():
+                logger.info(f'{cmd_output.read_stderr().strip()}')
+        cmd_output.close()
     return cmd_output
 
 
 def _set_env_vars_in_pods(namespace: str, new_pods: List):
     """Setting environment variables in pods.
 
     Once all containers are ready, we can exec into them and set env vars.
@@ -267,21 +296,17 @@
     more details.
 
     To do so, we capture env vars from the pod's runtime and write them to
     /etc/profile.d/, making them available for all users in future
     shell sessions.
     """
     set_k8s_env_var_cmd = [
-        '/bin/sh', '-c',
-        ('prefix_cmd() '
-         '{ if [ $(id -u) -ne 0 ]; then echo "sudo"; else echo ""; fi; } && '
-         'printenv | awk -F "=" \'{print "export " $1 "=\\047" $2 "\\047"}\' > '
-         '~/k8s_env_var.sh && '
-         'mv ~/k8s_env_var.sh /etc/profile.d/k8s_env_var.sh || '
-         '$(prefix_cmd) mv ~/k8s_env_var.sh /etc/profile.d/k8s_env_var.sh')
+        '/bin/sh',
+        '-c',
+        docker_utils.SETUP_ENV_VARS_CMD,
     ]
 
     for new_pod in new_pods:
         _run_command_on_pods(new_pod.metadata.name, namespace,
                              set_k8s_env_var_cmd)
 
 
@@ -320,14 +345,15 @@
 def _setup_ssh_in_pods(namespace: str, new_nodes: List) -> None:
     # Setting up ssh for the pod instance. This is already setup for
     # the jump pod so it does not need to be run for it.
     set_k8s_ssh_cmd = [
         '/bin/sh',
         '-c',
         (
+            'set -x; '
             'prefix_cmd() '
             '{ if [ $(id -u) -ne 0 ]; then echo "sudo"; else echo ""; fi; }; '
             'export DEBIAN_FRONTEND=noninteractive;'
             '$(prefix_cmd) apt-get update;'
             '$(prefix_cmd) apt install openssh-server rsync -y; '
             '$(prefix_cmd) mkdir -p /var/run/sshd; '
             '$(prefix_cmd) '
@@ -345,17 +371,23 @@
             '~/.ssh/authorized_keys; '
             '$(prefix_cmd) service ssh restart; '
             # Eliminate the error
             # `mesg: ttyname failed: inappropriate ioctl for device`.
             # See https://www.educative.io/answers/error-mesg-ttyname-failed-inappropriate-ioctl-for-device  # pylint: disable=line-too-long
             '$(prefix_cmd) sed -i "s/mesg n/tty -s \\&\\& mesg n/" ~/.profile;')
     ]
-    # TODO(romilb): We need logging and surface errors here.
+    # TODO(romilb): Parallelize the setup of SSH in pods for multi-node clusters
     for new_node in new_nodes:
-        _run_command_on_pods(new_node.metadata.name, namespace, set_k8s_ssh_cmd)
+        pod_name = new_node.metadata.name
+        logger.info(f'{"-"*20}Start: Set up SSH in pod {pod_name!r} {"-"*20}')
+        _run_command_on_pods(new_node.metadata.name,
+                             namespace,
+                             set_k8s_ssh_cmd,
+                             stream_logs=True)
+        logger.info(f'{"-"*20}End: Set up SSH in pod {pod_name!r} {"-"*20}')
 
 
 def _label_pod(namespace: str, pod_name: str, label: Dict[str, str]) -> None:
     """Label a pod."""
     kubernetes.core_api().patch_namespaced_pod(
         pod_name,
         namespace, {'metadata': {
@@ -421,15 +453,15 @@
             'This is likely a resource leak. '
             'Use "sky down" to terminate the cluster.')
 
     # Add nvidia runtime class if it exists
     nvidia_runtime_exists = False
     try:
         nvidia_runtime_exists = kubernetes_utils.check_nvidia_runtime_class()
-    except kubernetes.get_kubernetes().client.ApiException as e:
+    except kubernetes.kubernetes.client.ApiException as e:
         logger.warning('run_instances: Error occurred while checking for '
                        f'nvidia RuntimeClass - '
                        f'{common_utils.format_exception(e)}'
                        'Continuing without using nvidia RuntimeClass.\n'
                        'If you are on a K3s cluster, manually '
                        'override runtimeClassName in ~/.sky/config.yaml. '
                        'For more details, refer to https://skypilot.readthedocs.io/en/latest/reference/config.html')  # pylint: disable=line-too-long
@@ -455,47 +487,60 @@
             # worker pods on different nodes than the head pod.
             # This is not set as a hard constraint because if different nodes
             # are not available, we still want to be able to schedule worker
             # pods on larger nodes which may be able to fit multiple SkyPilot
             # "nodes".
             pod_spec['spec']['affinity'] = {
                 'podAntiAffinity': {
-                    'requiredDuringSchedulingIgnoredDuringExecution': [{
-                        'labelSelector': {
-                            'matchExpressions': [{
-                                'key': TAG_SKYPILOT_CLUSTER_NAME,
-                                'operator': 'In',
-                                'values': [cluster_name_on_cloud]
-                            }]
-                        },
-                        'topologyKey': 'kubernetes.io/hostname'
+                    # Set as a soft constraint
+                    'preferredDuringSchedulingIgnoredDuringExecution': [{
+                        # Max weight to avoid scheduling on the
+                        # same physical node unless necessary.
+                        'weight': 100,
+                        'podAffinityTerm': {
+                            'labelSelector': {
+                                'matchExpressions': [{
+                                    'key': TAG_SKYPILOT_CLUSTER_NAME,
+                                    'operator': 'In',
+                                    'values': [cluster_name_on_cloud]
+                                }]
+                            },
+                            'topologyKey': 'kubernetes.io/hostname'
+                        }
                     }]
                 }
             }
+
         pod = kubernetes.core_api().create_namespaced_pod(namespace, pod_spec)
         created_pods[pod.metadata.name] = pod
         if head_pod_name is None:
             head_pod_name = pod.metadata.name
 
     # Adding the jump pod to the new_nodes list as well so it can be
     # checked if it's scheduled and running along with other pods.
     ssh_jump_pod_name = pod_spec['metadata']['labels']['skypilot-ssh-jump']
     jump_pod = kubernetes.core_api().read_namespaced_pod(
         ssh_jump_pod_name, namespace)
     wait_pods_dict = _filter_pods(namespace, tags, ['Pending'])
     wait_pods = list(wait_pods_dict.values())
     wait_pods.append(jump_pod)
-    logger.debug('run_instances: waiting for pods to schedule and run: '
-                 f'{list(wait_pods_dict.keys())}')
+    provision_timeout = provider_config['timeout']
+
+    wait_str = ('indefinitely'
+                if provision_timeout < 0 else f'for {provision_timeout}s')
+    logger.debug(f'run_instances: waiting {wait_str} for pods to schedule and '
+                 f'run: {list(wait_pods_dict.keys())}')
 
     # Wait until the pods are scheduled and surface cause for error
     # if there is one
-    _wait_for_pods_to_schedule(namespace, wait_pods, provider_config['timeout'])
+    _wait_for_pods_to_schedule(namespace, wait_pods, provision_timeout)
     # Wait until the pods and their containers are up and running, and
     # fail early if there is an error
+    logger.debug(f'run_instances: waiting for pods to be running (pulling '
+                 f'images): {list(wait_pods_dict.keys())}')
     _wait_for_pods_to_run(namespace, wait_pods)
     logger.debug(f'run_instances: all pods are scheduled and running: '
                  f'{list(wait_pods_dict.keys())}')
 
     running_pods = _filter_pods(namespace, tags, ['Running'])
     initialized_pods = _filter_pods(namespace, {
         TAG_POD_INITIALIZED: 'true',
@@ -506,17 +551,23 @@
         for pod_name, pod in running_pods.items()
         if pod_name not in initialized_pods
     }
     if len(uninitialized_pods) > 0:
         logger.debug(f'run_instances: Initializing {len(uninitialized_pods)} '
                      f'pods: {list(uninitialized_pods.keys())}')
         uninitialized_pods_list = list(uninitialized_pods.values())
+
+        # Setup SSH and environment variables in pods.
+        # Make sure commands used in these methods are generic and work
+        # on most base images. E.g., do not use Python, since that may not
+        # be installed by default.
         _check_user_privilege(namespace, uninitialized_pods_list)
         _setup_ssh_in_pods(namespace, uninitialized_pods_list)
         _set_env_vars_in_pods(namespace, uninitialized_pods_list)
+
         for pod in uninitialized_pods.values():
             _label_pod(namespace,
                        pod.metadata.name,
                        label={
                            TAG_POD_INITIALIZED: 'true',
                            **pod.metadata.labels
                        })
@@ -672,15 +723,17 @@
         ssh_user=ssh_user,
         # We manually set object-store-memory=500000000 to avoid ray from
         # allocating a very large object store in each pod that may cause
         # problems for other pods.
         custom_ray_options={
             'object-store-memory': 500000000,
             'num-cpus': cpu_request,
-        })
+        },
+        provider_name='kubernetes',
+        provider_config=provider_config)
 
 
 def query_instances(
     cluster_name_on_cloud: str,
     provider_config: Optional[Dict[str, Any]] = None,
     non_terminated_only: bool = True
 ) -> Dict[str, Optional[status_lib.ClusterStatus]]:
```

### Comparing `skypilot-0.5.0/sky/provision/kubernetes/network_utils.py` & `skypilot-0.6.0/sky/provision/kubernetes/network_utils.py`

 * *Files 15% similar despite different names*

```diff
@@ -5,24 +5,33 @@
 import jinja2
 import yaml
 
 import sky
 from sky import exceptions
 from sky import skypilot_config
 from sky.adaptors import kubernetes
+from sky.provision.kubernetes import utils as kubernetes_utils
 from sky.utils import kubernetes_enums
 from sky.utils import ux_utils
 
 _INGRESS_TEMPLATE_NAME = 'kubernetes-ingress.yml.j2'
 _LOADBALANCER_TEMPLATE_NAME = 'kubernetes-loadbalancer.yml.j2'
 
 
 def get_port_mode(
         mode_str: Optional[str] = None) -> kubernetes_enums.KubernetesPortMode:
     """Get the port mode from the provider config."""
+
+    curr_kube_config = kubernetes_utils.get_current_kube_config_context_name()
+    running_kind = curr_kube_config == kubernetes_utils.KIND_CONTEXT_NAME
+
+    if running_kind:
+        # If running in kind (`sky local up`), use ingress mode
+        return kubernetes_enums.KubernetesPortMode.INGRESS
+
     mode_str = mode_str or skypilot_config.get_nested(
         ('kubernetes', 'ports'),
         kubernetes_enums.KubernetesPortMode.LOADBALANCER.value)
     try:
         port_mode = kubernetes_enums.KubernetesPortMode(mode_str)
     except ValueError as e:
         with ux_utils.print_exception_no_traceback():
@@ -53,48 +62,56 @@
         selector_key=selector_key,
         selector_value=selector_value,
     )
     content = yaml.safe_load(cont)
     return content
 
 
-def fill_ingress_template(namespace: str, path_prefix: str, service_name: str,
-                          service_port: int, ingress_name: str,
-                          selector_key: str, selector_value: str) -> Dict:
+def fill_ingress_template(namespace: str, service_details: List[Tuple[str, int,
+                                                                      str]],
+                          ingress_name: str, selector_key: str,
+                          selector_value: str) -> Dict:
     template_path = os.path.join(sky.__root_dir__, 'templates',
                                  _INGRESS_TEMPLATE_NAME)
     if not os.path.exists(template_path):
         raise FileNotFoundError(
             f'Template "{_INGRESS_TEMPLATE_NAME}" does not exist.')
     with open(template_path, 'r', encoding='utf-8') as fin:
         template = fin.read()
     j2_template = jinja2.Template(template)
     cont = j2_template.render(
         namespace=namespace,
-        path_prefix=path_prefix.rstrip('/').lstrip('/'),
-        service_name=service_name,
-        service_port=service_port,
+        service_names_and_ports=[{
+            'service_name': name,
+            'service_port': port,
+            'path_prefix': path_prefix
+        } for name, port, path_prefix in service_details],
         ingress_name=ingress_name,
         selector_key=selector_key,
         selector_value=selector_value,
     )
     content = yaml.safe_load(cont)
-    return content
+
+    # Return a dictionary containing both specs
+    return {
+        'ingress_spec': content['ingress_spec'],
+        'services_spec': content['services_spec']
+    }
 
 
 def create_or_replace_namespaced_ingress(
         namespace: str, ingress_name: str,
         ingress_spec: Dict[str, Union[str, int]]) -> None:
     """Creates an ingress resource for the specified service."""
     networking_api = kubernetes.networking_api()
 
     try:
         networking_api.read_namespaced_ingress(
             ingress_name, namespace, _request_timeout=kubernetes.API_TIMEOUT)
-    except kubernetes.get_kubernetes().client.ApiException as e:
+    except kubernetes.kubernetes.client.ApiException as e:
         if e.status == 404:
             networking_api.create_namespaced_ingress(
                 namespace,
                 ingress_spec,
                 _request_timeout=kubernetes.API_TIMEOUT)
             return
         raise e
@@ -108,15 +125,15 @@
 
 def delete_namespaced_ingress(namespace: str, ingress_name: str) -> None:
     """Deletes an ingress resource."""
     networking_api = kubernetes.networking_api()
     try:
         networking_api.delete_namespaced_ingress(
             ingress_name, namespace, _request_timeout=kubernetes.API_TIMEOUT)
-    except kubernetes.get_kubernetes().client.ApiException as e:
+    except kubernetes.kubernetes.client.ApiException as e:
         if e.status == 404:
             raise exceptions.PortDoesNotExistError(
                 f'Port {ingress_name.split("--")[-1]} does not exist.')
         raise e
 
 
 def create_or_replace_namespaced_service(
@@ -124,15 +141,15 @@
         service_spec: Dict[str, Union[str, int]]) -> None:
     """Creates a service resource for the specified service."""
     core_api = kubernetes.core_api()
 
     try:
         core_api.read_namespaced_service(
             service_name, namespace, _request_timeout=kubernetes.API_TIMEOUT)
-    except kubernetes.get_kubernetes().client.ApiException as e:
+    except kubernetes.kubernetes.client.ApiException as e:
         if e.status == 404:
             core_api.create_namespaced_service(
                 namespace,
                 service_spec,
                 _request_timeout=kubernetes.API_TIMEOUT)
             return
         raise e
@@ -146,15 +163,15 @@
 def delete_namespaced_service(namespace: str, service_name: str) -> None:
     """Deletes a service resource."""
     core_api = kubernetes.core_api()
 
     try:
         core_api.delete_namespaced_service(
             service_name, namespace, _request_timeout=kubernetes.API_TIMEOUT)
-    except kubernetes.get_kubernetes().client.ApiException as e:
+    except kubernetes.kubernetes.client.ApiException as e:
         if e.status == 404:
             raise exceptions.PortDoesNotExistError(
                 f'Port {service_name.split("--")[-1]} does not exist.')
         raise e
 
 
 def ingress_controller_exists(ingress_class_name: str = 'nginx') -> bool:
@@ -178,19 +195,25 @@
         if item.metadata.name == 'ingress-nginx-controller'
     ]
     if len(ingress_services) == 0:
         return (None, None)
 
     ingress_service = ingress_services[0]
     if ingress_service.status.load_balancer.ingress is None:
-        # Try to use assigned external IP if it exists,
-        # otherwise return 'localhost'
+        # We try to get an IP/host for the service in the following order:
+        # 1. Try to use assigned external IP if it exists
+        # 2. Use the skypilot.co/external-ip annotation in the service
+        # 3. Otherwise return 'localhost'
+        ip = None
         if ingress_service.spec.external_i_ps is not None:
             ip = ingress_service.spec.external_i_ps[0]
-        else:
+        elif ingress_service.metadata.annotations is not None:
+            ip = ingress_service.metadata.annotations.get(
+                'skypilot.co/external-ip', None)
+        if ip is None:
             ip = 'localhost'
         ports = ingress_service.spec.ports
         http_port = [port for port in ports if port.name == 'http'][0].node_port
         https_port = [port for port in ports if port.name == 'https'
                      ][0].node_port
         return ip, (int(http_port), int(https_port))
 
@@ -207,7 +230,17 @@
 
     if service.status.load_balancer.ingress is None:
         return None
 
     ip = service.status.load_balancer.ingress[
         0].ip or service.status.load_balancer.ingress[0].hostname
     return ip if ip is not None else None
+
+
+def get_pod_ip(namespace: str, pod_name: str) -> Optional[str]:
+    """Returns the IP address of the pod."""
+    core_api = kubernetes.core_api()
+    pod = core_api.read_namespaced_pod(pod_name,
+                                       namespace,
+                                       _request_timeout=kubernetes.API_TIMEOUT)
+
+    return pod.status.pod_ip if pod.status.pod_ip is not None else None
```

### Comparing `skypilot-0.5.0/sky/provision/kubernetes/utils.py` & `skypilot-0.6.0/sky/provision/kubernetes/utils.py`

 * *Files 14% similar despite different names*

```diff
@@ -1,8 +1,9 @@
 """Kubernetes utilities for SkyPilot."""
+import json
 import math
 import os
 import re
 import subprocess
 from typing import Any, Dict, List, Optional, Set, Tuple, Union
 from urllib.parse import urlparse
 
@@ -14,30 +15,40 @@
 from sky import sky_logging
 from sky import skypilot_config
 from sky.adaptors import kubernetes
 from sky.provision.kubernetes import network_utils
 from sky.utils import common_utils
 from sky.utils import env_options
 from sky.utils import kubernetes_enums
+from sky.utils import schemas
 from sky.utils import ux_utils
 
+# TODO(romilb): Move constants to constants.py
 DEFAULT_NAMESPACE = 'default'
 
+DEFAULT_SERVICE_ACCOUNT_NAME = 'skypilot-service-account'
+
 MEMORY_SIZE_UNITS = {
     'B': 1,
     'K': 2**10,
     'M': 2**20,
     'G': 2**30,
     'T': 2**40,
     'P': 2**50,
 }
-NO_GPU_ERROR_MESSAGE = 'No GPUs found in Kubernetes cluster. \
-If your cluster contains GPUs, make sure nvidia.com/gpu resource is available on the nodes and the node labels for identifying GPUs \
-(e.g., skypilot.co/accelerators) are setup correctly. \
-To further debug, run: sky check.'
+NO_GPU_HELP_MESSAGE = ('If your cluster contains GPUs, make sure '
+                       'nvidia.com/gpu resource is available on the nodes and '
+                       'the node labels for identifying GPUs '
+                       '(e.g., skypilot.co/accelerator) are setup correctly. ')
+
+KUBERNETES_AUTOSCALER_NOTE = (
+    'Note: Kubernetes cluster autoscaling is enabled. '
+    'All GPUs that can be provisioned may not be listed '
+    'here. Refer to your autoscaler\'s node pool '
+    'configuration to see the list of supported GPUs.')
 
 # TODO(romilb): Add links to docs for configuration instructions when ready.
 ENDPOINTS_DEBUG_MESSAGE = ('Additionally, make sure your {endpoint_type} '
                            'is configured correctly. '
                            '\nTo debug, run: {debug_cmd}')
 
 KIND_CONTEXT_NAME = 'kind-skypilot'  # Context name used by sky local up
@@ -174,21 +185,39 @@
         elif value.startswith('nvidia-'):
             return value.replace('nvidia-', '').upper()
         else:
             raise ValueError(
                 f'Invalid accelerator name in GKE cluster: {value}')
 
 
+class KarpenterLabelFormatter(SkyPilotLabelFormatter):
+    """Karpeneter label formatter
+    Karpenter uses the label `karpenter.k8s.aws/instance-gpu-name` to identify
+    the GPU type. Details: https://karpenter.sh/docs/reference/instance-types/
+    The naming scheme is same as the SkyPilot formatter, so we inherit from it.
+    """
+    LABEL_KEY = 'karpenter.k8s.aws/instance-gpu-name'
+
+
 # LABEL_FORMATTER_REGISTRY stores the label formats SkyPilot will try to
 # discover the accelerator type from. The order of the list is important, as
-# it will be used to determine the priority of the label formats.
+# it will be used to determine the priority of the label formats when
+# auto-detecting the GPU label type.
 LABEL_FORMATTER_REGISTRY = [
-    SkyPilotLabelFormatter, CoreWeaveLabelFormatter, GKELabelFormatter
+    SkyPilotLabelFormatter, CoreWeaveLabelFormatter, GKELabelFormatter,
+    KarpenterLabelFormatter
 ]
 
+# Mapping of autoscaler type to label formatter
+AUTOSCALER_TO_LABEL_FORMATTER = {
+    kubernetes_enums.KubernetesAutoscalerType.GKE: GKELabelFormatter,
+    kubernetes_enums.KubernetesAutoscalerType.KARPENTER: KarpenterLabelFormatter,  # pylint: disable=line-too-long
+    kubernetes_enums.KubernetesAutoscalerType.GENERIC: SkyPilotLabelFormatter,
+}
+
 
 def detect_gpu_label_formatter(
 ) -> Tuple[Optional[GPULabelFormatter], Dict[str, List[Tuple[str, str]]]]:
     """Detects the GPU label formatter for the Kubernetes cluster
 
     Returns:
         GPULabelFormatter: The GPU label formatter for the cluster, if found.
@@ -247,14 +276,26 @@
     except kubernetes.max_retry_error():
         raise exceptions.ResourcesUnavailableError(
             'Timed out when trying to get node info from Kubernetes cluster. '
             'Please check if the cluster is healthy and retry.') from None
     return nodes
 
 
+def get_kubernetes_pods() -> List[Any]:
+    try:
+        ns = get_current_kube_config_context_namespace()
+        pods = kubernetes.core_api().list_namespaced_pod(
+            ns, _request_timeout=kubernetes.API_TIMEOUT).items
+    except kubernetes.max_retry_error():
+        raise exceptions.ResourcesUnavailableError(
+            'Timed out when trying to get pod info from Kubernetes cluster. '
+            'Please check if the cluster is healthy and retry.') from None
+    return pods
+
+
 def check_instance_fits(instance: str) -> Tuple[bool, Optional[str]]:
     """Checks if the instance fits on the Kubernetes cluster.
 
     If the instance has GPU requirements, checks if the GPU type is
     available on the cluster and if enough CPU/memory is available on any node
     with the GPU type.
 
@@ -344,18 +385,34 @@
             - The cluster does not have GPU resources (nvidia.com/gpu)
             - The cluster does not have GPU labels setup correctly
             - The cluster doesn't have any nodes with acc_type GPU
     """
     # Check if the cluster has GPU resources
     # TODO(romilb): This assumes the accelerator is a nvidia GPU. We
     #  need to support TPUs and other accelerators as well.
-    # TODO(romilb): This will fail early for autoscaling clusters.
-    #  For AS clusters, we may need a way for users to specify GPU node pools
-    #  to use since the cluster may be scaling up from zero nodes and may not
-    #  have any GPU nodes yet.
+    # TODO(romilb): Currently, we broadly disable all GPU checks if autoscaling
+    #  is configured in config.yaml since the cluster may be scaling up from
+    #  zero nodes and may not have any GPU nodes yet. In the future, we should
+    #  support pollingthe clusters for autoscaling information, such as the
+    #  node pools configured etc.
+
+    autoscaler_type = get_autoscaler_type()
+    if autoscaler_type is not None:
+        # If autoscaler is set in config.yaml, override the label key and value
+        # to the autoscaler's format and bypass the GPU checks.
+        if check_mode:
+            # If check mode is enabled and autoscaler is set, we can return
+            # early since we assume the cluster autoscaler will handle GPU
+            # node provisioning.
+            return '', ''
+        formatter = AUTOSCALER_TO_LABEL_FORMATTER.get(autoscaler_type)
+        assert formatter is not None, ('Unsupported autoscaler type:'
+                                       f' {autoscaler_type}')
+        return formatter.get_label_key(), formatter.get_label_value(acc_type)
+
     has_gpus, cluster_resources = detect_gpu_resource()
     if has_gpus:
         # Check if the cluster has GPU labels setup correctly
         label_formatter, node_labels = \
             detect_gpu_label_formatter()
         if label_formatter is None:
             # If none of the GPU labels from LABEL_FORMATTER_REGISTRY are
@@ -505,52 +562,140 @@
                        'Check if your cluster is running and your network '
                        'is stable.')
     except ValueError as e:
         return False, common_utils.format_exception(e)
     except Exception as e:  # pylint: disable=broad-except
         return False, ('An error occurred: '
                        f'{common_utils.format_exception(e, use_bracket=True)}')
-    # If we reach here, the credentials are valid and Kubernetes cluster is up
+
+    # If we reach here, the credentials are valid and Kubernetes cluster is up.
+    # We now do softer checks to check if exec based auth is used and to
+    # see if the cluster is GPU-enabled.
+
+    _, exec_msg = is_kubeconfig_exec_auth()
+
     # We now check if GPUs are available and labels are set correctly on the
     # cluster, and if not we return hints that may help debug any issues.
     # This early check avoids later surprises for user when they try to run
     # `sky launch --gpus <gpu>` and the optimizer does not list Kubernetes as a
     # provider if their cluster GPUs are not setup correctly.
+    gpu_msg = ''
     try:
         _, _ = get_gpu_label_key_value(acc_type='', check_mode=True)
     except exceptions.ResourcesUnavailableError as e:
         # If GPUs are not available, we return cluster as enabled (since it can
         # be a CPU-only cluster) but we also return the exception message which
         # serves as a hint for how to enable GPU access.
-        return True, f'{e}'
-    return True, None
+        gpu_msg = str(e)
+    if exec_msg and gpu_msg:
+        return True, f'{gpu_msg}\n    Additionally, {exec_msg}'
+    elif gpu_msg:
+        return True, gpu_msg
+    elif exec_msg:
+        return True, exec_msg
+    else:
+        return True, None
+
+
+def is_kubeconfig_exec_auth() -> Tuple[bool, Optional[str]]:
+    """Checks if the kubeconfig file uses exec-based authentication
+
+    Exec-based auth is commonly used for authenticating with cloud hosted
+    Kubernetes services, such as GKE. Here is an example snippet from a
+    kubeconfig using exec-based authentication for a GKE cluster:
+    - name: mycluster
+      user:
+        exec:
+          apiVersion: client.authentication.k8s.io/v1beta1
+          command: /Users/romilb/google-cloud-sdk/bin/gke-gcloud-auth-plugin
+          installHint: Install gke-gcloud-auth-plugin ...
+          provideClusterInfo: true
+
+
+    Using exec-based authentication is problematic when used in conjunction
+    with kubernetes.remote_identity = LOCAL_CREDENTIAL in ~/.sky/config.yaml.
+    This is because the exec-based authentication may not have the relevant
+    dependencies installed on the remote cluster or may have hardcoded paths
+    that are not available on the remote cluster.
+
+    Returns:
+        bool: True if exec-based authentication is used and LOCAL_CREDENTIAL
+            mode is used for remote_identity in ~/.sky/config.yaml.
+        str: Error message if exec-based authentication is used, None otherwise
+    """
+    k8s = kubernetes.kubernetes
+    try:
+        k8s.config.load_kube_config()
+    except kubernetes.config_exception():
+        # Using service account token or other auth methods, continue
+        return False, None
+
+    # Get active context and user from kubeconfig using k8s api
+    _, current_context = k8s.config.list_kube_config_contexts()
+    target_username = current_context['context']['user']
+
+    # K8s api does not provide a mechanism to get the user details from the
+    # context. We need to load the kubeconfig file and parse it to get the
+    # user details.
+    kubeconfig_path = os.path.expanduser(
+        os.getenv('KUBECONFIG',
+                  k8s.config.kube_config.KUBE_CONFIG_DEFAULT_LOCATION))
+    # Load the kubeconfig file as a dictionary
+    with open(kubeconfig_path, 'r', encoding='utf-8') as f:
+        kubeconfig = yaml.safe_load(f)
+
+    user_details = kubeconfig['users']
+
+    # Find user matching the target username
+    user_details = next(
+        user for user in user_details if user['name'] == target_username)
+
+    remote_identity = skypilot_config.get_nested(
+        ('kubernetes', 'remote_identity'),
+        schemas.get_default_remote_identity('kubernetes'))
+    if ('exec' in user_details.get('user', {}) and remote_identity
+            == schemas.RemoteIdentityOptions.LOCAL_CREDENTIALS.value):
+        ctx_name = current_context['name']
+        exec_msg = ('exec-based authentication is used for '
+                    f'Kubernetes context {ctx_name!r}.'
+                    ' This may cause issues with autodown or when running '
+                    'Managed Jobs or SkyServe controller on Kubernetes. '
+                    'To fix, configure SkyPilot to create a service account '
+                    'for running pods by setting the following in '
+                    '~/.sky/config.yaml:\n'
+                    '    kubernetes:\n'
+                    '      remote_identity: SERVICE_ACCOUNT\n'
+                    '    More: https://skypilot.readthedocs.io/en/latest/'
+                    'reference/config.html')
+        return True, exec_msg
+    return False, None
 
 
 def get_current_kube_config_context_name() -> Optional[str]:
     """Get the current kubernetes context from the kubeconfig file
 
     Returns:
         str | None: The current kubernetes context if it exists, None otherwise
     """
-    k8s = kubernetes.get_kubernetes()
+    k8s = kubernetes.kubernetes
     try:
         _, current_context = k8s.config.list_kube_config_contexts()
         return current_context['name']
     except k8s.config.config_exception.ConfigException:
         return None
 
 
 def get_current_kube_config_context_namespace() -> str:
     """Get the current kubernetes context namespace from the kubeconfig file
 
     Returns:
         str | None: The current kubernetes context namespace if it exists, else
             the default namespace.
     """
-    k8s = kubernetes.get_kubernetes()
+    k8s = kubernetes.kubernetes
     try:
         _, current_context = k8s.config.list_kube_config_contexts()
         if 'namespace' in current_context['context']:
             return current_context['context']['namespace']
         else:
             return DEFAULT_NAMESPACE
     except k8s.config.config_exception.ConfigException:
@@ -584,31 +729,26 @@
         unit_index = unit_index[0]
         bytes_value = float(number) * MEMORY_SIZE_UNITS[unit_index]
     return bytes_value / MEMORY_SIZE_UNITS[unit]
 
 
 class KubernetesInstanceType:
     """Class to represent the "Instance Type" in a Kubernetes.
-
     Since Kubernetes does not have a notion of instances, we generate
     virtual instance types that represent the resources requested by a
     pod ("node").
-
     This name captures the following resource requests:
         - CPU
         - Memory
         - Accelerators
-
     The name format is "{n}CPU--{k}GB" where n is the number of vCPUs and
     k is the amount of memory in GB. Accelerators can be specified by
     appending "--{a}{type}" where a is the number of accelerators and
     type is the accelerator type.
-
     CPU and memory can be specified as floats. Accelerator count must be int.
-
     Examples:
         - 4CPU--16GB
         - 0.5CPU--1.5GB
         - 4CPU--16GB--1V100
     """
 
     def __init__(self,
@@ -639,15 +779,14 @@
         return bool(pattern.match(name))
 
     @classmethod
     def _parse_instance_type(
             cls,
             name: str) -> Tuple[float, float, Optional[int], Optional[str]]:
         """Parses and returns resources from the given InstanceType name
-
         Returns:
             cpus | float: Number of CPUs
             memory | float: Amount of memory in GB
             accelerator_count | float: Number of accelerators
             accelerator_type | str: Type of accelerator
         """
         pattern = re.compile(
@@ -684,15 +823,14 @@
     @classmethod
     def from_resources(cls,
                        cpus: float,
                        memory: float,
                        accelerator_count: Union[float, int] = 0,
                        accelerator_type: str = '') -> 'KubernetesInstanceType':
         """Returns an instance name object from the given resources.
-
         If accelerator_count is not an int, it will be rounded up since GPU
         requests in Kubernetes must be int.
         """
         name = f'{cpus}CPU--{memory}GB'
         # Round up accelerator_count if it is not an int.
         accelerator_count = math.ceil(accelerator_count)
         if accelerator_count > 0:
@@ -808,14 +946,18 @@
         namespace: Namespace to create the SSH jump service in
         service_type: Networking configuration on either to use NodePort
             or ClusterIP service to ssh in
     """
     # Fill in template - ssh_key_secret and ssh_jump_image are not required for
     # the service spec, so we pass in empty strs.
     content = fill_ssh_jump_template('', '', ssh_jump_name, service_type.value)
+
+    # Add custom metadata from config
+    merge_custom_metadata(content['service_spec']['metadata'])
+
     # Create service
     try:
         kubernetes.core_api().create_namespaced_service(namespace,
                                                         content['service_spec'])
     except kubernetes.api_exception() as e:
         # SSH Jump Pod service already exists.
         if e.status == 409:
@@ -881,14 +1023,19 @@
         ssh_key_secret: Secret name for the SSH key stored in the cluster
         namespace: Namespace to create the SSH jump pod in
     """
     # Fill in template - service is created separately so service_type is not
     # required, so we pass in empty str.
     content = fill_ssh_jump_template(ssh_key_secret, ssh_jump_image,
                                      ssh_jump_name, '')
+
+    # Add custom metadata to all objects
+    for object_type in content.keys():
+        merge_custom_metadata(content[object_type]['metadata'])
+
     # ServiceAccount
     try:
         kubernetes.core_api().create_namespaced_service_account(
             namespace, content['service_account'])
     except kubernetes.api_exception() as e:
         if e.status == 409:
             logger.info(
@@ -1012,36 +1159,72 @@
                               secret=ssh_key_secret,
                               service_type=service_type)
     content = yaml.safe_load(cont)
     return content
 
 
 def check_port_forward_mode_dependencies() -> None:
-    """Checks if 'socat' is installed"""
-    # We store the dependency list as a list of lists. Each inner list
-    # contains the name of the dependency, the command to check if it is
-    # installed, and the package name to install it.
-    dependency_list = [['socat', ['socat', '-V'], 'socat'],
-                       ['nc', ['nc', '-h'], 'netcat']]
-    for name, check_cmd, install_cmd in dependency_list:
-        try:
-            subprocess.run(check_cmd,
-                           stdout=subprocess.DEVNULL,
-                           stderr=subprocess.DEVNULL,
-                           check=True)
-        except (FileNotFoundError, subprocess.CalledProcessError):
+    """Checks if 'socat' and 'nc' are installed"""
+
+    # Construct runtime errors
+    socat_default_error = RuntimeError(
+        f'`socat` is required to setup Kubernetes cloud with '
+        f'`{kubernetes_enums.KubernetesNetworkingMode.PORTFORWARD.value}` '  # pylint: disable=line-too-long
+        'default networking mode and it is not installed. '
+        'On Debian/Ubuntu, install it with:\n'
+        f'  $ sudo apt install socat\n'
+        f'On MacOS, install it with: \n'
+        f'  $ brew install socat')
+    netcat_default_error = RuntimeError(
+        f'`nc` is required to setup Kubernetes cloud with '
+        f'`{kubernetes_enums.KubernetesNetworkingMode.PORTFORWARD.value}` '  # pylint: disable=line-too-long
+        'default networking mode and it is not installed. '
+        'On Debian/Ubuntu, install it with:\n'
+        f'  $ sudo apt install netcat\n'
+        f'On MacOS, install it with: \n'
+        f'  $ brew install netcat')
+    mac_installed_error = RuntimeError(
+        f'The default MacOS `nc` is installed. However, for '
+        f'`{kubernetes_enums.KubernetesNetworkingMode.PORTFORWARD.value}` '  # pylint: disable=line-too-long
+        'default networking mode, GNU netcat is required. '
+        f'On MacOS, install it with: \n'
+        f'  $ brew install netcat')
+
+    # Ensure socat is installed
+    try:
+        subprocess.run(['socat', '-V'],
+                       stdout=subprocess.DEVNULL,
+                       stderr=subprocess.DEVNULL,
+                       check=True)
+    except (FileNotFoundError, subprocess.CalledProcessError):
+        with ux_utils.print_exception_no_traceback():
+            raise socat_default_error from None
+
+    # Ensure netcat is installed
+    #
+    # In some cases, the user may have the default MacOS nc installed, which
+    # does not support the -z flag. To use the -z flag for port scanning,
+    # they need GNU nc installed. We check for this case and raise an error.
+    try:
+        netcat_output = subprocess.run(['nc', '-h'],
+                                       capture_output=True,
+                                       check=False)
+        nc_mac_installed = netcat_output.returncode == 1 and 'apple' in str(
+            netcat_output.stderr)
+
+        if nc_mac_installed:
+            with ux_utils.print_exception_no_traceback():
+                raise mac_installed_error from None
+        elif netcat_output.returncode != 0:
             with ux_utils.print_exception_no_traceback():
-                raise RuntimeError(
-                    f'`{name}` is required to setup Kubernetes cloud with '
-                    f'`{kubernetes_enums.KubernetesNetworkingMode.PORTFORWARD.value}` '  # pylint: disable=line-too-long
-                    'default networking mode and it is not installed. '
-                    'On Debian/Ubuntu, install it with:\n'
-                    f'  $ sudo apt install {install_cmd}\n'
-                    f'On MacOS, install it with: \n'
-                    f'  $ brew install {install_cmd}') from None
+                raise netcat_default_error from None
+
+    except FileNotFoundError:
+        with ux_utils.print_exception_no_traceback():
+            raise netcat_default_error from None
 
 
 def get_endpoint_debug_message() -> str:
     """ Returns a string message for user to debug Kubernetes port opening
 
     Polls the configured ports mode on Kubernetes to produce an
     appropriate error message with debugging hints.
@@ -1051,19 +1234,63 @@
     port_mode = network_utils.get_port_mode()
     if port_mode == kubernetes_enums.KubernetesPortMode.INGRESS:
         endpoint_type = 'Ingress'
         debug_cmd = 'kubectl describe ingress && kubectl describe ingressclass'
     elif port_mode == kubernetes_enums.KubernetesPortMode.LOADBALANCER:
         endpoint_type = 'LoadBalancer'
         debug_cmd = 'kubectl describe service'
+    elif port_mode == kubernetes_enums.KubernetesPortMode.PODIP:
+        endpoint_type = 'PodIP'
+        debug_cmd = 'kubectl describe pod'
     return ENDPOINTS_DEBUG_MESSAGE.format(endpoint_type=endpoint_type,
                                           debug_cmd=debug_cmd)
 
 
-def combine_pod_config_fields(config_yaml_path: str) -> None:
+def merge_dicts(source: Dict[Any, Any], destination: Dict[Any, Any]):
+    """Merge two dictionaries into the destination dictionary.
+
+    Updates nested dictionaries instead of replacing them.
+    If a list is encountered, it will be appended to the destination list.
+
+    An exception is when the key is 'containers', in which case the
+    first container in the list will be fetched and merge_dict will be
+    called on it with the first container in the destination list.
+    """
+    for key, value in source.items():
+        if isinstance(value, dict) and key in destination:
+            merge_dicts(value, destination[key])
+        elif isinstance(value, list) and key in destination:
+            assert isinstance(destination[key], list), \
+                f'Expected {key} to be a list, found {destination[key]}'
+            if key == 'containers':
+                # If the key is 'containers', we take the first and only
+                # container in the list and merge it.
+                assert len(value) == 1, \
+                    f'Expected only one container, found {value}'
+                merge_dicts(value[0], destination[key][0])
+            elif key in ['volumes', 'volumeMounts']:
+                # If the key is 'volumes' or 'volumeMounts', we search for
+                # item with the same name and merge it.
+                for new_volume in value:
+                    new_volume_name = new_volume.get('name')
+                    if new_volume_name is not None:
+                        destination_volume = next(
+                            (v for v in destination[key]
+                             if v.get('name') == new_volume_name), None)
+                        if destination_volume is not None:
+                            merge_dicts(new_volume, destination_volume)
+                        else:
+                            destination[key].append(new_volume)
+            else:
+                destination[key].extend(value)
+        else:
+            destination[key] = value
+
+
+def combine_pod_config_fields(cluster_yaml_path: str) -> None:
     """Adds or updates fields in the YAML with fields from the ~/.sky/config's
     kubernetes.pod_spec dict.
     This can be used to add fields to the YAML that are not supported by
     SkyPilot yet, or require simple configuration (e.g., adding an
     imagePullSecrets field).
     Note that new fields are added and existing ones are updated. Nested fields
     are not completely replaced, instead their objects are merged. Similarly,
@@ -1094,55 +1321,71 @@
                 containers:
                     - name: ray
                     image: rayproject/ray:nightly
                 imagePullSecrets:
                     - name: my-secret
         ```
     """
-
-    def _merge_dicts(source, destination):
-        """Merge two dictionaries.
-
-        Updates nested dictionaries instead of replacing them.
-        If a list is encountered, it will be appended to the destination list.
-
-        An exception is when the key is 'containers', in which case the
-        first container in the list will be fetched and _merge_dict will be
-        called on it with the first container in the destination list.
-        """
-        for key, value in source.items():
-            if isinstance(value, dict) and key in destination:
-                _merge_dicts(value, destination[key])
-            elif isinstance(value, list) and key in destination:
-                assert isinstance(destination[key], list), \
-                    f'Expected {key} to be a list, found {destination[key]}'
-                if key == 'containers':
-                    # If the key is 'containers', we take the first and only
-                    # container in the list and merge it.
-                    assert len(value) == 1, \
-                        f'Expected only one container, found {value}'
-                    _merge_dicts(value[0], destination[key][0])
-                else:
-                    destination[key].extend(value)
-            else:
-                destination[key] = value
-
-    with open(config_yaml_path, 'r', encoding='utf-8') as f:
+    with open(cluster_yaml_path, 'r', encoding='utf-8') as f:
         yaml_content = f.read()
     yaml_obj = yaml.safe_load(yaml_content)
     kubernetes_config = skypilot_config.get_nested(('kubernetes', 'pod_config'),
                                                    {})
 
     # Merge the kubernetes config into the YAML for both head and worker nodes.
-    _merge_dicts(
+    merge_dicts(
         kubernetes_config,
         yaml_obj['available_node_types']['ray_head_default']['node_config'])
 
     # Write the updated YAML back to the file
-    common_utils.dump_yaml(config_yaml_path, yaml_obj)
+    common_utils.dump_yaml(cluster_yaml_path, yaml_obj)
+
+
+def combine_metadata_fields(cluster_yaml_path: str) -> None:
+    """Updates the metadata for all Kubernetes objects created by SkyPilot with
+    fields from the ~/.sky/config's kubernetes.custom_metadata dict.
+
+    Obeys the same add or update semantics as combine_pod_config_fields().
+    """
+
+    with open(cluster_yaml_path, 'r', encoding='utf-8') as f:
+        yaml_content = f.read()
+    yaml_obj = yaml.safe_load(yaml_content)
+    custom_metadata = skypilot_config.get_nested(
+        ('kubernetes', 'custom_metadata'), {})
+
+    # List of objects in the cluster YAML to be updated
+    combination_destinations = [
+        # Service accounts
+        yaml_obj['provider']['autoscaler_service_account']['metadata'],
+        yaml_obj['provider']['autoscaler_role']['metadata'],
+        yaml_obj['provider']['autoscaler_role_binding']['metadata'],
+        yaml_obj['provider']['autoscaler_service_account']['metadata'],
+        # Pod spec
+        yaml_obj['available_node_types']['ray_head_default']['node_config']
+        ['metadata'],
+        # Services for pods
+        *[svc['metadata'] for svc in yaml_obj['provider']['services']]
+    ]
+
+    for destination in combination_destinations:
+        merge_dicts(custom_metadata, destination)
+
+    # Write the updated YAML back to the file
+    common_utils.dump_yaml(cluster_yaml_path, yaml_obj)
+
+
+def merge_custom_metadata(original_metadata: Dict[str, Any]) -> None:
+    """Merges original metadata with custom_metadata from config
+
+    Merge is done in-place, so return is not required
+    """
+    custom_metadata = skypilot_config.get_nested(
+        ('kubernetes', 'custom_metadata'), {})
+    merge_dicts(custom_metadata, original_metadata)
 
 
 def check_nvidia_runtime_class() -> bool:
     """Checks if the 'nvidia' RuntimeClass exists in the cluster"""
     # Fetch the list of available RuntimeClasses
     runtime_classes = kubernetes.node_api().list_runtime_class()
 
@@ -1165,7 +1408,74 @@
             secret_name, namespace, _request_timeout=kubernetes.API_TIMEOUT)
     except kubernetes.api_exception() as e:
         if e.status == 404:
             return False
         raise
     else:
         return True
+
+
+def create_namespace(namespace: str) -> None:
+    """Creates a namespace in the cluster.
+
+    If the namespace already exists, logs a message and does nothing.
+
+    Args:
+        namespace: Name of the namespace to create
+    """
+    kubernetes_client = kubernetes.kubernetes.client
+    ns_metadata = dict(name=namespace, labels={'parent': 'skypilot'})
+    merge_custom_metadata(ns_metadata)
+    namespace_obj = kubernetes_client.V1Namespace(metadata=ns_metadata)
+    try:
+        kubernetes.core_api().create_namespace(namespace_obj)
+    except kubernetes.api_exception() as e:
+        if e.status == 409:
+            logger.info(f'Namespace {namespace} already exists in the cluster.')
+        else:
+            raise
+
+
+def get_head_pod_name(cluster_name_on_cloud: str):
+    """Returns the pod name of the head pod for the given cluster name on cloud
+
+    Args:
+        cluster_name_on_cloud: Name of the cluster on cloud
+
+    Returns:
+        str: Pod name of the head pod
+    """
+    # We could have iterated over all pods in the namespace and checked for the
+    # label, but since we know the naming convention, we can directly return the
+    # head pod name.
+    return f'{cluster_name_on_cloud}-head'
+
+
+def get_autoscaler_type(
+) -> Optional[kubernetes_enums.KubernetesAutoscalerType]:
+    """Returns the autoscaler type by reading from config"""
+    autoscaler_type = skypilot_config.get_nested(['kubernetes', 'autoscaler'],
+                                                 None)
+    if autoscaler_type is not None:
+        autoscaler_type = kubernetes_enums.KubernetesAutoscalerType(
+            autoscaler_type)
+    return autoscaler_type
+
+
+def dict_to_k8s_object(object_dict: Dict[str, Any], object_type: 'str') -> Any:
+    """Converts a dictionary to a Kubernetes object.
+
+    Useful for comparing two Kubernetes objects. Adapted from
+    https://github.com/kubernetes-client/python/issues/977#issuecomment-592030030  # pylint: disable=line-too-long
+
+    Args:
+        object_dict: Dictionary representing the Kubernetes object
+        object_type: Type of the Kubernetes object. E.g., 'V1Pod', 'V1Service'.
+    """
+
+    class FakeKubeResponse:
+
+        def __init__(self, obj):
+            self.data = json.dumps(obj)
+
+    fake_kube_response = FakeKubeResponse(object_dict)
+    return kubernetes.api_client().deserialize(fake_kube_response, object_type)
```

### Comparing `skypilot-0.5.0/sky/provision/logging.py` & `skypilot-0.6.0/sky/provision/logging.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/provision/metadata_utils.py` & `skypilot-0.6.0/sky/provision/metadata_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/provision/provisioner.py` & `skypilot-0.6.0/sky/provision/provisioner.py`

 * *Files 2% similar despite different names*

```diff
@@ -8,26 +8,26 @@
 import subprocess
 import time
 import traceback
 from typing import Dict, List, Optional, Tuple
 
 import colorama
 
+import sky
 from sky import clouds
 from sky import provision
 from sky import sky_logging
 from sky import status_lib
 from sky.adaptors import aws
 from sky.backends import backend_utils
 from sky.provision import common as provision_common
 from sky.provision import instance_setup
 from sky.provision import logging as provision_logging
 from sky.provision import metadata_utils
 from sky.skylet import constants
-from sky.utils import command_runner
 from sky.utils import common_utils
 from sky.utils import rich_utils
 from sky.utils import ux_utils
 
 # Do not use __name__ as we do not want to propagate logs to sky.provision,
 # which will be customized in sky.provision.logging.
 logger = sky_logging.init_logger('sky.provisioner')
@@ -161,14 +161,16 @@
         ['node_config'],
         count=num_nodes,
         tags={},
         resume_stopped_nodes=True)
 
     with provision_logging.setup_provision_logging(log_dir):
         try:
+            logger.debug(f'SkyPilot version: {sky.__version__}; '
+                         f'commit: {sky.__commit__}')
             logger.debug(_TITLE.format('Provisioning'))
             logger.debug(
                 'Provision config:\n'
                 f'{json.dumps(dataclasses.asdict(bootstrap_config), indent=2)}')
             return _bulk_provision(cloud, region, zones, cluster_name,
                                    bootstrap_config)
         except Exception:  # pylint: disable=broad-except
@@ -254,14 +256,16 @@
         ssh_private_key,
         f'{ssh_user}@{ip}',
         '-p',
         str(ssh_port),
         '-o',
         'StrictHostKeyChecking=no',
         '-o',
+        'PasswordAuthentication=no',
+        '-o',
         'ConnectTimeout=10s',
         '-o',
         f'UserKnownHostsFile={os.devnull}',
         '-o',
         'IdentitiesOnly=yes',
         '-o',
         'ExitOnForwardFailure=yes',
@@ -342,26 +346,31 @@
 
     Returns:
         A tuple of (success, stderr).
     """
     del ssh_control_name, kwargs  # unused
     command = _ssh_probe_command(ip, ssh_port, ssh_user, ssh_private_key,
                                  ssh_proxy_command)
-    logger.debug(f'Waiting for SSH using command: {_shlex_join(command)}')
-    proc = subprocess.run(command,
-                          shell=False,
-                          check=False,
-                          stdout=subprocess.DEVNULL,
-                          stderr=subprocess.PIPE)
-    if proc.returncode != 0:
-        stderr = proc.stderr.decode('utf-8')
-        stderr = f'Error: {stderr}'
-        logger.debug(
-            f'Waiting for SSH to {ip} with command: {_shlex_join(command)}\n'
-            f'{stderr}')
+    message = f'Waiting for SSH using command: {_shlex_join(command)}'
+    logger.debug(message)
+    try:
+        proc = subprocess.run(command,
+                              shell=False,
+                              check=False,
+                              timeout=10,
+                              stdout=subprocess.DEVNULL,
+                              stderr=subprocess.PIPE)
+        if proc.returncode != 0:
+            stderr = proc.stderr.decode('utf-8')
+            stderr = f'Error: {stderr}'
+            logger.debug(f'{message}{stderr}')
+            return False, stderr
+    except subprocess.TimeoutExpired as e:
+        stderr = f'Error: {str(e)}'
+        logger.debug(f'{message}Error: {e}')
         return False, stderr
     return True, ''
 
 
 def wait_for_ssh(cluster_info: provision_common.ClusterInfo,
                  ssh_credentials: Dict[str, str]):
     """Wait until SSH is ready.
@@ -430,16 +439,14 @@
     if head_instance is None:
         raise RuntimeError(
             f'Provision failed for cluster {cluster_name!r}. '
             'Could not find any head instance. To fix: refresh '
             'status with: sky status -r; and retry provisioning.')
 
     # TODO(suquark): Move wheel build here in future PRs.
-    ip_list = cluster_info.get_feasible_ips()
-    port_list = cluster_info.get_ssh_ports()
     # We don't set docker_user here, as we are configuring the VM itself.
     ssh_credentials = backend_utils.ssh_credential_from_yaml(
         cluster_yaml, ssh_user=cluster_info.ssh_user)
 
     with rich_utils.safe_status(
             '[bold cyan]Launching - Waiting for SSH access[/]') as status:
 
@@ -451,15 +458,15 @@
         logger.info(f'{colorama.Fore.GREEN}Successfully provisioned '
                     f'or found existing instance{plural}.'
                     f'{colorama.Style.RESET_ALL}')
 
         docker_config = config_from_yaml.get('docker', {})
         if docker_config:
             status.update(
-                '[bold cyan]Lauching - Initializing docker container[/]')
+                '[bold cyan]Launching - Initializing docker container[/]')
             docker_user = instance_setup.initialize_docker(
                 cluster_name.name_on_cloud,
                 docker_config=docker_config,
                 cluster_info=cluster_info,
                 ssh_credentials=ssh_credentials)
             if docker_user is None:
                 raise RuntimeError(
@@ -468,15 +475,15 @@
 
             cluster_info.docker_user = docker_user
             ssh_credentials['docker_user'] = docker_user
             logger.debug(f'Docker user: {docker_user}')
 
         # We mount the metadata with sky wheel for speedup.
         # NOTE: currently we mount all credentials for all nodes, because
-        # (1) spot controllers need permission to launch/down nodes of
+        # (1) jobs controllers need permission to launch/down nodes of
         #     multiple clouds
         # (2) head instances need permission for auto stop or auto down
         #     nodes for the current cloud
         # (3) all instances need permission to mount storage for all clouds
         # It is possible to have a "smaller" permission model, but we leave that
         # for later.
         file_mounts = config_from_yaml.get('file_mounts', {})
@@ -491,17 +498,17 @@
 
         status.update(
             runtime_preparation_str.format(step=2, step_name='dependencies'))
         instance_setup.setup_runtime_on_cluster(
             cluster_name.name_on_cloud, config_from_yaml['setup_commands'],
             cluster_info, ssh_credentials)
 
-        head_runner = command_runner.SSHCommandRunner(ip_list[0],
-                                                      port=port_list[0],
-                                                      **ssh_credentials)
+        runners = provision.get_command_runners(cloud_name, cluster_info,
+                                                **ssh_credentials)
+        head_runner = runners[0]
 
         status.update(
             runtime_preparation_str.format(step=3, step_name='runtime'))
         full_ray_setup = True
         ray_port = constants.SKY_REMOTE_RAY_PORT
         if not provision_record.is_instance_just_booted(
                 head_instance.instance_id):
@@ -530,15 +537,15 @@
         #  nodes like this:
         #
         # worker_ips = []
         # for inst in cluster_info.instances.values():
         #     if provision_record.is_instance_just_booted(inst.instance_id):
         #         worker_ips.append(inst.public_ip)
 
-        if len(ip_list) > 1:
+        if cluster_info.num_instances > 1:
             instance_setup.start_ray_on_worker_nodes(
                 cluster_name.name_on_cloud,
                 no_restart=not full_ray_setup,
                 custom_resource=custom_resource,
                 # Pass the ray_port to worker nodes for backward compatibility
                 # as in some existing clusters the ray_port is not dumped with
                 # instance_setup._DUMP_RAY_PORTS. We should use the ray_port
```

### Comparing `skypilot-0.5.0/sky/provision/runpod/instance.py` & `skypilot-0.6.0/sky/provision/runpod/instance.py`

 * *Files 1% similar despite different names*

```diff
@@ -150,15 +150,15 @@
                 ) from e
 
 
 def get_cluster_info(
         region: str,
         cluster_name_on_cloud: str,
         provider_config: Optional[Dict[str, Any]] = None) -> common.ClusterInfo:
-    del region, provider_config  # unused
+    del region  # unused
     running_instances = _filter_instances(cluster_name_on_cloud, ['RUNNING'])
     instances: Dict[str, List[common.InstanceInfo]] = {}
     head_instance_id = None
     for instance_id, instance_info in running_instances.items():
         instances[instance_id] = [
             common.InstanceInfo(
                 instance_id=instance_id,
@@ -170,14 +170,16 @@
         ]
         if instance_info['name'].endswith('-head'):
             head_instance_id = instance_id
 
     return common.ClusterInfo(
         instances=instances,
         head_instance_id=head_instance_id,
+        provider_name='runpod',
+        provider_config=provider_config,
     )
 
 
 def query_instances(
     cluster_name_on_cloud: str,
     provider_config: Optional[Dict[str, Any]] = None,
     non_terminated_only: bool = True,
```

### Comparing `skypilot-0.5.0/sky/provision/runpod/utils.py` & `skypilot-0.6.0/sky/provision/runpod/utils.py`

 * *Files 3% similar despite different names*

```diff
@@ -50,27 +50,27 @@
 
     def wrapper(*args, **kwargs):
         """Wrapper for retrying a function."""
         cnt = 0
         while True:
             try:
                 return func(*args, **kwargs)
-            except runpod.runpod().error.QueryError as e:
+            except runpod.runpod.error.QueryError as e:
                 if cnt >= 3:
                     raise
                 logger.warning('Retrying for exception: '
                                f'{common_utils.format_exception(e)}.')
                 time.sleep(1)
 
     return wrapper
 
 
 def list_instances() -> Dict[str, Dict[str, Any]]:
     """Lists instances associated with API key."""
-    instances = runpod.runpod().get_pods()
+    instances = runpod.runpod.get_pods()
 
     instance_dict: Dict[str, Dict[str, Any]] = {}
     for instance in instances:
         info = {}
 
         info['status'] = instance['desiredStatus']
         info['name'] = instance['name']
@@ -94,37 +94,38 @@
     Converts the instance_type to the RunPod GPU name, finds the specs for the
     GPU, and launches the instance.
     """
     gpu_type = GPU_NAME_MAP[instance_type.split('_')[1]]
     gpu_quantity = int(instance_type.split('_')[0].replace('x', ''))
     cloud_type = instance_type.split('_')[2]
 
-    gpu_specs = runpod.runpod().get_gpu(gpu_type)
+    gpu_specs = runpod.runpod.get_gpu(gpu_type)
 
-    new_instance = runpod.runpod().create_pod(
+    new_instance = runpod.runpod.create_pod(
         name=name,
         image_name='runpod/base:0.0.2',
         gpu_type_id=gpu_type,
         cloud_type=cloud_type,
         container_disk_in_gb=disk_size,
         min_vcpu_count=4 * gpu_quantity,
         min_memory_in_gb=gpu_specs['memoryInGb'] * gpu_quantity,
+        gpu_count=gpu_quantity,
         country_code=region,
         ports=(f'22/tcp,'
                f'{constants.SKY_REMOTE_RAY_DASHBOARD_PORT}/http,'
                f'{constants.SKY_REMOTE_RAY_PORT}/http'),
         support_public_ip=True,
     )
 
     return new_instance['id']
 
 
 def remove(instance_id: str) -> None:
     """Terminates the given instance."""
-    runpod.runpod().terminate_pod(instance_id)
+    runpod.runpod.terminate_pod(instance_id)
 
 
 def get_ssh_ports(cluster_name) -> List[int]:
     """Gets the SSH ports for the given cluster."""
     logger.debug(f'Getting SSH ports for cluster {cluster_name}.')
 
     instances = list_instances()
```

### Comparing `skypilot-0.5.0/sky/provision/vsphere/__init__.py` & `skypilot-0.6.0/sky/provision/vsphere/__init__.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/provision/vsphere/common/cls_api_client.py` & `skypilot-0.6.0/sky/provision/vsphere/common/cls_api_client.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/provision/vsphere/common/cls_api_helper.py` & `skypilot-0.6.0/sky/provision/vsphere/common/cls_api_helper.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/provision/vsphere/common/metadata_utils.py` & `skypilot-0.6.0/sky/provision/vsphere/common/metadata_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/provision/vsphere/common/service_manager.py` & `skypilot-0.6.0/sky/provision/vsphere/common/service_manager.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/provision/vsphere/common/service_manager_factory.py` & `skypilot-0.6.0/sky/provision/vsphere/common/service_manager_factory.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/provision/vsphere/common/ssl_helper.py` & `skypilot-0.6.0/sky/provision/vsphere/common/ssl_helper.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/provision/vsphere/common/vapiconnect.py` & `skypilot-0.6.0/sky/provision/vsphere/common/vapiconnect.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/provision/vsphere/common/vim_utils.py` & `skypilot-0.6.0/sky/provision/vsphere/common/vim_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/provision/vsphere/instance.py` & `skypilot-0.6.0/sky/provision/vsphere/instance.py`

 * *Files 1% similar despite different names*

```diff
@@ -1,28 +1,33 @@
 """Vsphere instance provisioning."""
 import json
 import os
+import typing
 from typing import Any, Dict, List, Optional
 
-import pandas as pd
-
 from sky import exceptions
 from sky import sky_logging
 from sky import status_lib
+from sky.adaptors import common as adaptors_common
 from sky.adaptors import vsphere as vsphere_adaptor
 from sky.clouds.service_catalog.common import get_catalog_path
 from sky.provision import common
 from sky.provision.vsphere import vsphere_utils
 from sky.provision.vsphere.common import custom_script as custom_script_lib
 from sky.provision.vsphere.common import metadata_utils
 from sky.provision.vsphere.common.vim_utils import poweroff_vm
 from sky.provision.vsphere.common.vim_utils import wait_for_tasks
 from sky.provision.vsphere.common.vim_utils import wait_internal_ip_ready
 from sky.provision.vsphere.vsphere_utils import VsphereClient
 
+if typing.TYPE_CHECKING:
+    import pandas as pd
+else:
+    pd = adaptors_common.LazyImport('pandas')
+
 logger = sky_logging.init_logger(__name__)
 
 TAG_SKYPILOT_CLUSTER_NAME = 'skypilot-cluster-name'
 TAG_SKYPILOT_HEAD_NODE = 'skypilot-head-node'
 HEAD_NODE_VALUE = '1'
 WORKER_NODE_VALUE = '0'
 PUBLIC_SSH_KEY_PATH = '~/.ssh/sky-key.pub'
@@ -562,16 +567,14 @@
 
 
 def get_cluster_info(
         region: str,
         cluster_name: str,
         provider_config: Optional[Dict[str, Any]] = None) -> common.ClusterInfo:
     """See sky/provision/__init__.py"""
-    if provider_config:
-        del provider_config  # unused
     logger.info('New provision of Vsphere: get_cluster_info().')
 
     # Init the vsphere client
     vc_object = _get_vc_object(region)
     vc_object.connect()
 
     filters = _get_cluster_name_filter(cluster_name)
@@ -601,8 +604,10 @@
     # Get head node id
     head_instance_id = _get_head_instance_id(vm_objs)
 
     vc_object.disconnect()
     return common.ClusterInfo(
         instances=instances,
         head_instance_id=head_instance_id,
+        provider_name='vsphere',
+        provider_config=provider_config,
     )
```

### Comparing `skypilot-0.5.0/sky/provision/vsphere/vsphere_utils.py` & `skypilot-0.6.0/sky/provision/vsphere/vsphere_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/resources.py` & `skypilot-0.6.0/sky/resources.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,20 +1,21 @@
 """Resources: compute requirements of Tasks."""
+import dataclasses
 import functools
 import textwrap
 from typing import Any, Dict, List, Optional, Set, Tuple, Union
 
 import colorama
 
+from sky import check as sky_check
 from sky import clouds
 from sky import exceptions
-from sky import global_user_state
+from sky import jobs as managed_jobs
 from sky import sky_logging
 from sky import skypilot_config
-from sky import spot
 from sky.clouds import service_catalog
 from sky.provision import docker_utils
 from sky.skylet import constants
 from sky.utils import accelerator_registry
 from sky.utils import common_utils
 from sky.utils import log_utils
 from sky.utils import resources_utils
@@ -39,36 +40,38 @@
     * as a "filter" to get concrete launchable instances
     * for calculating billing
     * for provisioning on a cloud
 
     """
     # If any fields changed, increment the version. For backward compatibility,
     # modify the __setstate__ method to handle the old version.
-    _VERSION = 15
+    _VERSION = 18
 
     def __init__(
         self,
         cloud: Optional[clouds.Cloud] = None,
         instance_type: Optional[str] = None,
         cpus: Union[None, int, float, str] = None,
         memory: Union[None, int, float, str] = None,
         accelerators: Union[None, str, Dict[str, int]] = None,
         accelerator_args: Optional[Dict[str, str]] = None,
         use_spot: Optional[bool] = None,
-        spot_recovery: Optional[str] = None,
+        job_recovery: Optional[str] = None,
         region: Optional[str] = None,
         zone: Optional[str] = None,
         image_id: Union[Dict[str, str], str, None] = None,
         disk_size: Optional[int] = None,
         disk_tier: Optional[Union[str, resources_utils.DiskTier]] = None,
         ports: Optional[Union[int, str, List[str], Tuple[str]]] = None,
+        labels: Optional[Dict[str, str]] = None,
         # Internal use only.
         # pylint: disable=invalid-name
         _docker_login_config: Optional[docker_utils.DockerLoginConfig] = None,
         _is_image_managed: Optional[bool] = None,
+        _requires_fuse: Optional[bool] = None,
     ):
         """Initialize a Resources object.
 
         All fields are optional.  ``Resources.is_launchable`` decides whether
         the Resources is fully specified to launch an instance.
 
         Examples:
@@ -99,17 +102,17 @@
             a string of the form ``'V100'`` or ``'V100:2'``, where the ``:2``
             indicates that the task requires 2 V100 GPUs. If a dict, must be a
             dict of the form ``{'V100': 2}`` or ``{'tpu-v2-8': 1}``.
           accelerator_args: accelerator-specific arguments. For example,
             ``{'tpu_vm': True, 'runtime_version': 'tpu-vm-base'}`` for TPUs.
           use_spot: whether to use spot instances. If None, defaults to
             False.
-          spot_recovery: the spot recovery strategy to use for the managed
-            spot to recover the cluster from preemption. Refer to
-            `recovery_strategy module <https://github.com/skypilot-org/skypilot/blob/master/sky/spot/recovery_strategy.py>`__ # pylint: disable=line-too-long
+          job_recovery: the job recovery strategy to use for the managed
+            job to recover the cluster from preemption. Refer to
+            `recovery_strategy module <https://github.com/skypilot-org/skypilot/blob/master/sky/jobs/recovery_strategy.py>`__ # pylint: disable=line-too-long
             for more details.
           region: the region to use.
           zone: the zone to use.
           image_id: the image ID to use. If a str, must be a string
             of the image id from the cloud, such as AWS:
             ``'ami-1234567890abcdef0'``, GCP:
             ``'projects/my-project-id/global/images/my-image-name'``;
@@ -124,32 +127,47 @@
                 'us-east1': 'ami-1234567890abcdef0'
               }
 
           disk_size: the size of the OS disk in GiB.
           disk_tier: the disk performance tier to use. If None, defaults to
             ``'medium'``.
           ports: the ports to open on the instance.
-          _docker_login_config: the docker configuration to use. This include
+          labels: the labels to apply to the instance. These are useful for
+            assigning metadata that may be used by external tools.
+            Implementation depends on the chosen cloud - On AWS, labels map to
+            instance tags. On GCP, labels map to instance labels. On
+            Kubernetes, labels map to pod labels. On other clouds, labels are
+            not supported and will be ignored.
+          _docker_login_config: the docker configuration to use. This includes
             the docker username, password, and registry server. If None, skip
             docker login.
+          _requires_fuse: whether the task requires FUSE mounting support. This
+            is used internally by certain cloud implementations to do additional
+            setup for FUSE mounting. This flag also safeguards against using
+            FUSE mounting on existing clusters that do not support it. If None,
+            defaults to False.
+
+        Raises:
+            ValueError: if some attributes are invalid.
+            exceptions.NoCloudAccessError: if no public cloud is enabled.
         """
         self._version = self._VERSION
         self._cloud = cloud
         self._region: Optional[str] = None
         self._zone: Optional[str] = None
         self._validate_and_set_region_zone(region, zone)
 
         self._instance_type = instance_type
 
         self._use_spot_specified = use_spot is not None
         self._use_spot = use_spot if use_spot is not None else False
-        self._spot_recovery = None
-        if spot_recovery is not None:
-            if spot_recovery.strip().lower() != 'none':
-                self._spot_recovery = spot_recovery.upper()
+        self._job_recovery = None
+        if job_recovery is not None:
+            if job_recovery.strip().lower() != 'none':
+                self._job_recovery = job_recovery.upper()
 
         if disk_size is not None:
             if round(disk_size) != disk_size:
                 with ux_utils.print_exception_no_traceback():
                     raise ValueError(
                         f'OS disk size must be an integer. Got: {disk_size}.')
             self._disk_size = int(disk_size)
@@ -190,26 +208,31 @@
                 [str(port) for port in ports])
             if not ports:
                 # Set to None if empty. This is mainly for resources from
                 # cli, which will comes in as an empty tuple.
                 ports = None
         self._ports = ports
 
+        self._labels = labels
+
         self._docker_login_config = _docker_login_config
 
+        self._requires_fuse = _requires_fuse
+
         self._set_cpus(cpus)
         self._set_memory(memory)
         self._set_accelerators(accelerators, accelerator_args)
 
         self._try_validate_instance_type()
         self._try_validate_cpus_mem()
-        self._try_validate_spot()
+        self._try_validate_managed_job_attributes()
         self._try_validate_image_id()
         self._try_validate_disk_tier()
         self._try_validate_ports()
+        self._try_validate_labels()
 
     # When querying the accelerators inside this func (we call self.accelerators
     # which is a @property), we will check the cloud's catalog, which can error
     # if it fails to fetch some account specific catalog information (e.g., AWS
     # zone mapping). It is fine to use the default catalog as this function is
     # only for display purposes.
     @service_catalog.fallback_to_default_catalog
@@ -241,16 +264,16 @@
         accelerator_args = ''
         if self.accelerators is not None:
             accelerators = f', {self.accelerators}'
             if self.accelerator_args is not None:
                 accelerator_args = f', accelerator_args={self.accelerator_args}'
 
         cpus = ''
-        if self.cpus is not None:
-            cpus = f', cpus={self.cpus}'
+        if self._cpus is not None:
+            cpus = f', cpus={self._cpus}'
 
         memory = ''
         if self.memory is not None:
             memory = f', mem={self.memory}'
 
         use_spot = ''
         if self.use_spot:
@@ -326,25 +349,32 @@
         return self._zone
 
     @property
     def instance_type(self):
         return self._instance_type
 
     @property
+    @functools.lru_cache(maxsize=1)
     def cpus(self) -> Optional[str]:
         """Returns the number of vCPUs that each instance must have.
 
         For example, cpus='4' means each instance must have exactly 4 vCPUs,
         and cpus='4+' means each instance must have at least 4 vCPUs.
 
         (Developer note: The cpus field is only used to select the instance type
         at launch time. Thus, Resources in the backend's ResourceHandle will
         always have the cpus field set to None.)
         """
-        return self._cpus
+        if self._cpus is not None:
+            return self._cpus
+        if self.cloud is not None and self._instance_type is not None:
+            vcpus, _ = self.cloud.get_vcpus_mem_from_instance_type(
+                self._instance_type)
+            return str(vcpus)
+        return None
 
     @property
     def memory(self) -> Optional[str]:
         """Returns the memory that each instance must have in GB.
 
         For example, memory='16' means each instance must have exactly 16GB
         memory; memory='16+' means each instance must have at least 16GB
@@ -381,16 +411,16 @@
         return self._use_spot
 
     @property
     def use_spot_specified(self) -> bool:
         return self._use_spot_specified
 
     @property
-    def spot_recovery(self) -> Optional[str]:
-        return self._spot_recovery
+    def job_recovery(self) -> Optional[str]:
+        return self._job_recovery
 
     @property
     def disk_size(self) -> int:
         return self._disk_size
 
     @property
     def image_id(self) -> Optional[Dict[str, str]]:
@@ -401,17 +431,31 @@
         return self._disk_tier
 
     @property
     def ports(self) -> Optional[List[str]]:
         return self._ports
 
     @property
+    def labels(self) -> Optional[Dict[str, str]]:
+        return self._labels
+
+    @property
     def is_image_managed(self) -> Optional[bool]:
         return self._is_image_managed
 
+    @property
+    def requires_fuse(self) -> bool:
+        if self._requires_fuse is None:
+            return False
+        return self._requires_fuse
+
+    @requires_fuse.setter
+    def requires_fuse(self, value: Optional[bool]) -> None:
+        self._requires_fuse = value
+
     def _set_cpus(
         self,
         cpus: Union[None, int, float, str],
     ) -> None:
         if cpus is None:
             self._cpus = None
             return
@@ -446,15 +490,15 @@
             self._memory = None
             return
 
         self._memory = str(memory)
         if isinstance(memory, str):
             if memory.endswith(('+', 'x')):
                 # 'x' is used internally for make sure our resources used by
-                # spot controller (memory: 3x) to have enough memory based on
+                # jobs controller (memory: 3x) to have enough memory based on
                 # the vCPUs.
                 num_memory_gb = memory[:-1]
             else:
                 num_memory_gb = memory
 
             try:
                 memory_gb = float(num_memory_gb)
@@ -535,29 +579,36 @@
 
         self._accelerators = accelerators
         self._accelerator_args = accelerator_args
 
     def is_launchable(self) -> bool:
         return self.cloud is not None and self._instance_type is not None
 
-    def need_cleanup_after_preemption(self) -> bool:
-        """Returns whether a spot resource needs cleanup after preemption."""
+    def need_cleanup_after_preemption_or_failure(self) -> bool:
+        """Whether a resource needs cleanup after preemption or failure."""
         assert self.is_launchable(), self
-        return self.cloud.need_cleanup_after_preemption(self)
+        return self.cloud.need_cleanup_after_preemption_or_failure(self)
 
     def _validate_and_set_region_zone(self, region: Optional[str],
                                       zone: Optional[str]) -> None:
+        """Try to validate and set the region and zone attribute.
+
+        Raises:
+            ValueError: if the attributes are invalid.
+            exceptions.NoCloudAccessError: if no public cloud is enabled.
+        """
         if region is None and zone is None:
             return
 
         if self._cloud is None:
             # Try to infer the cloud from region/zone, if unique. If 0 or >1
             # cloud corresponds to region/zone, errors out.
             valid_clouds = []
-            enabled_clouds = global_user_state.get_enabled_clouds()
+            enabled_clouds = sky_check.get_cached_enabled_clouds_or_refresh(
+                raise_if_no_cloud_access=True)
             cloud_to_errors = {}
             for cloud in enabled_clouds:
                 try:
                     cloud.validate_region_zone(region, zone)
                 except ValueError as e:
                     cloud_to_errors[repr(cloud)] = e
                     continue
@@ -646,29 +697,36 @@
                 f'{yellow}Request {self} cannot be satisfied by any feasible '
                 'region. To fix, check that ssh_proxy_command\'s region keys '
                 f'include the regions to use.{reset}')
 
         return filtered_regions
 
     def _try_validate_instance_type(self) -> None:
+        """Try to validate the instance type attribute.
+
+        Raises:
+            ValueError: if the attribute is invalid.
+            exceptions.NoCloudAccessError: if no public cloud is enabled.
+        """
         if self.instance_type is None:
             return
 
         # Validate instance type
         if self.cloud is not None:
             valid = self.cloud.instance_type_exists(self._instance_type)
             if not valid:
                 with ux_utils.print_exception_no_traceback():
                     raise ValueError(
                         f'Invalid instance type {self._instance_type!r} '
                         f'for cloud {self.cloud}.')
         else:
             # If cloud not specified
             valid_clouds = []
-            enabled_clouds = global_user_state.get_enabled_clouds()
+            enabled_clouds = sky_check.get_cached_enabled_clouds_or_refresh(
+                raise_if_no_cloud_access=True)
             for cloud in enabled_clouds:
                 if cloud.instance_type_exists(self._instance_type):
                     valid_clouds.append(cloud)
             if len(valid_clouds) == 0:
                 if len(enabled_clouds) == 1:
                     cloud_str = f'for cloud {enabled_clouds[0]}'
                 else:
@@ -685,38 +743,43 @@
                     )
             logger.debug(
                 f'Cloud is not specified, using {valid_clouds[0]} '
                 f'inferred from the instance_type {self.instance_type!r}.')
             self._cloud = valid_clouds[0]
 
     def _try_validate_cpus_mem(self) -> None:
-        if self.cpus is None and self.memory is None:
+        """Try to validate the cpus and memory attributes.
+
+        Raises:
+            ValueError: if the attributes are invalid.
+        """
+        if self._cpus is None and self._memory is None:
             return
-        if self.instance_type is not None:
+        if self._instance_type is not None:
             # The assertion should be true because we have already executed
             # _try_validate_instance_type() before this method.
             # The _try_validate_instance_type() method infers and sets
             # self.cloud if self.instance_type is not None.
             assert self.cloud is not None
             cpus, mem = self.cloud.get_vcpus_mem_from_instance_type(
-                self.instance_type)
-            if self.cpus is not None:
-                if self.cpus.endswith('+'):
-                    if cpus < float(self.cpus[:-1]):
+                self._instance_type)
+            if self._cpus is not None:
+                if self._cpus.endswith('+'):
+                    if cpus < float(self._cpus[:-1]):
                         with ux_utils.print_exception_no_traceback():
                             raise ValueError(
                                 f'{self.instance_type} does not have enough '
                                 f'vCPUs. {self.instance_type} has {cpus} '
-                                f'vCPUs, but {self.cpus} is requested.')
-                elif cpus != float(self.cpus):
+                                f'vCPUs, but {self._cpus} is requested.')
+                elif cpus != float(self._cpus):
                     with ux_utils.print_exception_no_traceback():
                         raise ValueError(
                             f'{self.instance_type} does not have the requested '
                             f'number of vCPUs. {self.instance_type} has {cpus} '
-                            f'vCPUs, but {self.cpus} is requested.')
+                            f'vCPUs, but {self._cpus} is requested.')
             if self.memory is not None:
                 if self.memory.endswith(('+', 'x')):
                     if mem < float(self.memory[:-1]):
                         with ux_utils.print_exception_no_traceback():
                             raise ValueError(
                                 f'{self.instance_type} does not have enough '
                                 f'memory. {self.instance_type} has {mem} GB '
@@ -724,39 +787,44 @@
                 elif mem != float(self.memory):
                     with ux_utils.print_exception_no_traceback():
                         raise ValueError(
                             f'{self.instance_type} does not have the requested '
                             f'memory. {self.instance_type} has {mem} GB '
                             f'memory, but {self.memory} is requested.')
 
-    def _try_validate_spot(self) -> None:
-        if self._spot_recovery is None:
+    def _try_validate_managed_job_attributes(self) -> None:
+        """Try to validate managed job related attributes.
+
+        Raises:
+            ValueError: if the attributes are invalid.
+        """
+        if self._job_recovery is None:
             return
-        if not self._use_spot:
+        if self._job_recovery not in managed_jobs.RECOVERY_STRATEGIES:
             with ux_utils.print_exception_no_traceback():
                 raise ValueError(
-                    'Cannot specify spot_recovery without use_spot set to True.'
-                )
-        if self._spot_recovery not in spot.SPOT_STRATEGIES:
-            with ux_utils.print_exception_no_traceback():
-                raise ValueError(
-                    f'Spot recovery strategy {self._spot_recovery} '
+                    f'Spot recovery strategy {self._job_recovery} '
                     'is not supported. The strategy should be among '
-                    f'{list(spot.SPOT_STRATEGIES.keys())}')
+                    f'{list(managed_jobs.RECOVERY_STRATEGIES.keys())}')
 
     def extract_docker_image(self) -> Optional[str]:
         if self.image_id is None:
             return None
         if len(self.image_id) == 1 and self.region in self.image_id:
             image_id = self.image_id[self.region]
             if image_id.startswith('docker:'):
                 return image_id[len('docker:'):]
         return None
 
     def _try_validate_image_id(self) -> None:
+        """Try to validate the image_id attribute.
+
+        Raises:
+            ValueError: if the attribute is invalid.
+        """
         if self._image_id is None:
             return
 
         if self.extract_docker_image() is not None:
             # TODO(tian): validate the docker image exists / of reasonable size
             if self.accelerators is not None:
                 for acc in self.accelerators.keys():
@@ -779,16 +847,16 @@
                 self,
                 requested_features={
                     clouds.CloudImplementationFeatures.IMAGE_ID
                 })
         except exceptions.NotSupportedError as e:
             with ux_utils.print_exception_no_traceback():
                 raise ValueError(
-                    'image_id is only supported for AWS/GCP/IBM/OCI/Kubernetes,'
-                    ' please explicitly specify the cloud.') from e
+                    'image_id is only supported for AWS/GCP/Azure/IBM/OCI/'
+                    'Kubernetes, please explicitly specify the cloud.') from e
 
         if self._region is not None:
             if self._region not in self._image_id:
                 with ux_utils.print_exception_no_traceback():
                     raise ValueError(
                         f'image_id {self._image_id} should contain the image '
                         f'for the specified region {self._region}.')
@@ -822,35 +890,96 @@
                     raise ValueError(
                         f'Image {image_id!r} is {image_size}GB, which is '
                         f'larger than the specified disk_size: {self.disk_size}'
                         ' GB. Please specify a larger disk_size to use this '
                         'image.')
 
     def _try_validate_disk_tier(self) -> None:
+        """Try to validate the disk_tier attribute.
+
+        Raises:
+            ValueError: if the attribute is invalid.
+        """
         if self.disk_tier is None:
             return
         if self.cloud is not None:
-            self.cloud.check_disk_tier_enabled(self.instance_type,
-                                               self.disk_tier)
+            try:
+                self.cloud.check_disk_tier_enabled(self.instance_type,
+                                                   self.disk_tier)
+            except exceptions.NotSupportedError:
+                with ux_utils.print_exception_no_traceback():
+                    raise ValueError(
+                        f'Disk tier {self.disk_tier.value} is not supported '
+                        f'for instance type {self.instance_type}.') from None
 
     def _try_validate_ports(self) -> None:
+        """Try to validate the ports attribute.
+
+        Raises:
+            ValueError: if the attribute is invalid.
+            exceptions.NoCloudAccessError: if no public cloud is enabled.
+        """
         if self.ports is None:
             return
         if skypilot_config.get_nested(('aws', 'security_group_name'),
                                       None) is not None:
             with ux_utils.print_exception_no_traceback():
                 raise ValueError(
                     'Cannot specify ports when AWS security group name is '
                     'specified.')
         if self.cloud is not None:
             self.cloud.check_features_are_supported(
                 self, {clouds.CloudImplementationFeatures.OPEN_PORTS})
+        else:
+            at_least_one_cloud_supports_ports = False
+            for cloud in sky_check.get_cached_enabled_clouds_or_refresh(
+                    raise_if_no_cloud_access=True):
+                try:
+                    cloud.check_features_are_supported(
+                        self, {clouds.CloudImplementationFeatures.OPEN_PORTS})
+                    at_least_one_cloud_supports_ports = True
+                except exceptions.NotSupportedError:
+                    pass
+            if not at_least_one_cloud_supports_ports:
+                with ux_utils.print_exception_no_traceback():
+                    raise ValueError(
+                        'No enabled clouds support opening ports. To fix: '
+                        'do not specify resources.ports, or enable a cloud '
+                        'that does support this feature.')
         # We don't need to check the ports format since we already done it
         # in resources_utils.simplify_ports
 
+    def _try_validate_labels(self) -> None:
+        """Try to validate the labels attribute.
+
+        Raises:
+            ValueError: if the attribute is invalid.
+        """
+        if not self._labels:
+            return
+
+        if self.cloud is None:
+            # Because each cloud has its own label format, we cannot validate
+            # the labels without knowing the cloud.
+            with ux_utils.print_exception_no_traceback():
+                raise ValueError(
+                    'Cloud must be specified when labels are provided.')
+
+        # Check if the label key value pairs are valid.
+        invalid_table = log_utils.create_table(['Label', 'Reason'])
+        for key, value in self._labels.items():
+            valid, err_msg = self.cloud.is_label_valid(key, value)
+            if not valid:
+                invalid_table.add_row([f'{key}: {value}', err_msg])
+        if len(invalid_table.rows) > 0:
+            with ux_utils.print_exception_no_traceback():
+                raise ValueError(
+                    'The following labels are invalid:'
+                    '\n\t' + invalid_table.get_string().replace('\n', '\n\t'))
+
     def get_cost(self, seconds: float) -> float:
         """Returns cost in USD for the runtime in seconds."""
         hours = seconds / 3600
         # Instance.
         hourly_cost = self.cloud.instance_type_to_hourly_cost(
             self._instance_type, self.use_spot, self._region, self._zone)
         # Accelerators (if any).
@@ -1001,14 +1130,21 @@
                 if other.ports is None:
                     return False
                 self_ports = resources_utils.port_ranges_to_set(self.ports)
                 other_ports = resources_utils.port_ranges_to_set(other.ports)
                 if not self_ports <= other_ports:
                     return False
 
+        if self.requires_fuse and not other.requires_fuse:
+            # On Kubernetes, we can't launch a task that requires FUSE on a pod
+            # that wasn't initialized with FUSE support at the start.
+            # Other clouds don't have this limitation.
+            if other.cloud.is_same_cloud(clouds.Kubernetes()):
+                return False
+
         # self <= other
         return True
 
     def should_be_blocked_by(self, blocked: 'Resources') -> bool:
         """Whether this Resources matches the blocked Resources.
 
         If a field in `blocked` is None, it should be considered as a wildcard
@@ -1031,15 +1167,15 @@
         return is_matched
 
     def is_empty(self) -> bool:
         """Is this Resources an empty request (all fields None)?"""
         return all([
             self.cloud is None,
             self._instance_type is None,
-            self.cpus is None,
+            self._cpus is None,
             self.memory is None,
             self.accelerators is None,
             self.accelerator_args is None,
             not self._use_spot_specified,
             self.disk_size == _DEFAULT_DISK_SIZE_GB,
             self.disk_tier is None,
             self._image_id is None,
@@ -1049,31 +1185,33 @@
 
     def copy(self, **override) -> 'Resources':
         """Returns a copy of the given Resources."""
         use_spot = self.use_spot if self._use_spot_specified else None
         resources = Resources(
             cloud=override.pop('cloud', self.cloud),
             instance_type=override.pop('instance_type', self.instance_type),
-            cpus=override.pop('cpus', self.cpus),
+            cpus=override.pop('cpus', self._cpus),
             memory=override.pop('memory', self.memory),
             accelerators=override.pop('accelerators', self.accelerators),
             accelerator_args=override.pop('accelerator_args',
                                           self.accelerator_args),
             use_spot=override.pop('use_spot', use_spot),
-            spot_recovery=override.pop('spot_recovery', self.spot_recovery),
+            job_recovery=override.pop('job_recovery', self.job_recovery),
             disk_size=override.pop('disk_size', self.disk_size),
             region=override.pop('region', self.region),
             zone=override.pop('zone', self.zone),
             image_id=override.pop('image_id', self.image_id),
             disk_tier=override.pop('disk_tier', self.disk_tier),
             ports=override.pop('ports', self.ports),
+            labels=override.pop('labels', self.labels),
             _docker_login_config=override.pop('_docker_login_config',
                                               self._docker_login_config),
             _is_image_managed=override.pop('_is_image_managed',
                                            self._is_image_managed),
+            _requires_fuse=override.pop('_requires_fuse', self._requires_fuse),
         )
         assert len(override) == 0
         return resources
 
     def valid_on_region_zones(self, region: str, zones: List[str]) -> bool:
         """Returns whether this Resources is valid on given region and zones"""
         if self.region is not None and self.region != region:
@@ -1113,15 +1251,26 @@
 
         def _override_resources(
                 base_resource_config: Dict[str, Any],
                 override_configs: List[Dict[str, Any]]) -> List[Resources]:
             resources_list = []
             for override_config in override_configs:
                 new_resource_config = base_resource_config.copy()
+                # Labels are handled separately.
+                override_labels = override_config.pop('labels', None)
                 new_resource_config.update(override_config)
+
+                # Update the labels with the override labels.
+                labels = new_resource_config.get('labels', None)
+                if labels is not None and override_labels is not None:
+                    labels.update(override_labels)
+                elif override_labels is not None:
+                    labels = override_labels
+                new_resource_config['labels'] = labels
+
                 # Call from_yaml_config again instead of
                 # _from_yaml_config_single to handle the case, where both
                 # multiple accelerators and `any_of` is specified.
                 # This will not cause infinite recursion because we have made
                 # sure that `any_of` and `ordered` cannot be specified in the
                 # resource candidates in `any_of` or `ordered`, by the schema
                 # validation above.
@@ -1193,25 +1342,35 @@
         resources_fields['instance_type'] = config.pop('instance_type', None)
         resources_fields['cpus'] = config.pop('cpus', None)
         resources_fields['memory'] = config.pop('memory', None)
         resources_fields['accelerators'] = config.pop('accelerators', None)
         resources_fields['accelerator_args'] = config.pop(
             'accelerator_args', None)
         resources_fields['use_spot'] = config.pop('use_spot', None)
-        resources_fields['spot_recovery'] = config.pop('spot_recovery', None)
+        if config.get('spot_recovery') is not None:
+            logger.warning('spot_recovery is deprecated. Use job_recovery '
+                           'instead (the system is defaulting to that for '
+                           'you).')
+            resources_fields['job_recovery'] = config.pop('spot_recovery', None)
+        else:
+            # spot_recovery and job_recovery are guaranteed to be mutually
+            # exclusive by the schema validation.
+            resources_fields['job_recovery'] = config.pop('job_recovery', None)
         resources_fields['disk_size'] = config.pop('disk_size', None)
         resources_fields['region'] = config.pop('region', None)
         resources_fields['zone'] = config.pop('zone', None)
         resources_fields['image_id'] = config.pop('image_id', None)
         resources_fields['disk_tier'] = config.pop('disk_tier', None)
         resources_fields['ports'] = config.pop('ports', None)
+        resources_fields['labels'] = config.pop('labels', None)
         resources_fields['_docker_login_config'] = config.pop(
             '_docker_login_config', None)
         resources_fields['_is_image_managed'] = config.pop(
             '_is_image_managed', None)
+        resources_fields['_requires_fuse'] = config.pop('_requires_fuse', None)
 
         if resources_fields['cpus'] is not None:
             resources_fields['cpus'] = str(resources_fields['cpus'])
         if resources_fields['memory'] is not None:
             resources_fields['memory'] = str(resources_fields['memory'])
         if resources_fields['accelerator_args'] is not None:
             resources_fields['accelerator_args'] = dict(
@@ -1228,31 +1387,37 @@
 
         def add_if_not_none(key, value):
             if value is not None and value != 'None':
                 config[key] = value
 
         add_if_not_none('cloud', str(self.cloud))
         add_if_not_none('instance_type', self.instance_type)
-        add_if_not_none('cpus', self.cpus)
+        add_if_not_none('cpus', self._cpus)
         add_if_not_none('memory', self.memory)
         add_if_not_none('accelerators', self.accelerators)
         add_if_not_none('accelerator_args', self.accelerator_args)
 
         if self._use_spot_specified:
             add_if_not_none('use_spot', self.use_spot)
-            add_if_not_none('spot_recovery', self.spot_recovery)
+        add_if_not_none('job_recovery', self.job_recovery)
         add_if_not_none('disk_size', self.disk_size)
         add_if_not_none('region', self.region)
         add_if_not_none('zone', self.zone)
         add_if_not_none('image_id', self.image_id)
         if self.disk_tier is not None:
             config['disk_tier'] = self.disk_tier.value
         add_if_not_none('ports', self.ports)
+        add_if_not_none('labels', self.labels)
+        if self._docker_login_config is not None:
+            config['_docker_login_config'] = dataclasses.asdict(
+                self._docker_login_config)
         if self._is_image_managed is not None:
             config['_is_image_managed'] = self._is_image_managed
+        if self._requires_fuse is not None:
+            config['_requires_fuse'] = self._requires_fuse
         return config
 
     def __setstate__(self, state):
         """Set state from pickled state, for backward compatibility."""
         self._version = self._VERSION
 
         # TODO (zhwu): Design our persistent state format with `__getstate__`,
@@ -1276,14 +1441,16 @@
 
             disk_size = state.pop('disk_size', _DEFAULT_DISK_SIZE_GB)
             state['_disk_size'] = disk_size
 
         if version < 2:
             self._region = None
 
+        # spot_recovery is deprecated. We keep the history just for readability,
+        # it should be removed by chunk in the future.
         if version < 3:
             self._spot_recovery = None
 
         if version < 4:
             self._image_id = None
 
         if version < 5:
@@ -1342,8 +1509,20 @@
 
         if version < 15:
             original_disk_tier = state.get('_disk_tier', None)
             if original_disk_tier is not None:
                 state['_disk_tier'] = resources_utils.DiskTier(
                     original_disk_tier)
 
+        if version < 16:
+            # Kubernetes clusters launched prior to version 16 run in privileged
+            # mode and have FUSE support enabled by default. As a result, we
+            # set the default to True for backward compatibility.
+            state['_requires_fuse'] = state.get('_requires_fuse', True)
+
+        if version < 17:
+            state['_labels'] = state.get('_labels', None)
+
+        if version < 18:
+            self._job_recovery = state.pop('_spot_recovery', None)
+
         self.__dict__.update(state)
```

### Comparing `skypilot-0.5.0/sky/serve/__init__.py` & `skypilot-0.6.0/sky/serve/__init__.py`

 * *Files 4% similar despite different names*

```diff
@@ -8,21 +8,23 @@
 from sky.serve.core import down
 from sky.serve.core import status
 from sky.serve.core import tail_logs
 from sky.serve.core import up
 from sky.serve.core import update
 from sky.serve.serve_state import ReplicaStatus
 from sky.serve.serve_state import ServiceStatus
+from sky.serve.serve_utils import DEFAULT_UPDATE_MODE
 from sky.serve.serve_utils import format_service_table
 from sky.serve.serve_utils import generate_replica_cluster_name
 from sky.serve.serve_utils import generate_service_name
 from sky.serve.serve_utils import get_endpoint
 from sky.serve.serve_utils import ServeCodeGen
 from sky.serve.serve_utils import ServiceComponent
 from sky.serve.serve_utils import SKY_SERVE_CONTROLLER_NAME
+from sky.serve.serve_utils import UpdateMode
 from sky.serve.service_spec import SkyServiceSpec
 
 os.makedirs(os.path.expanduser(SKYSERVE_METADATA_DIR), exist_ok=True)
 
 __all__ = [
     'down',
     'ENDPOINT_PROBE_INTERVAL_SECONDS',
@@ -39,8 +41,10 @@
     'SkyServiceSpec',
     'SKY_SERVE_CONTROLLER_NAME',
     'SKYSERVE_METADATA_DIR',
     'status',
     'tail_logs',
     'up',
     'update',
+    'UpdateMode',
+    'DEFAULT_UPDATE_MODE',
 ]
```

### Comparing `skypilot-0.5.0/sky/serve/autoscalers.py` & `skypilot-0.6.0/sky/serve/service_spec.py`

 * *Files 26% similar despite different names*

```diff
@@ -1,317 +1,322 @@
-"""Autoscalers: perform autoscaling by monitoring metrics."""
-import bisect
-import dataclasses
-import enum
-import math
-import time
-import typing
-from typing import Any, Dict, List, Optional, Union
+"""Service specification for SkyServe."""
+import json
+import os
+import textwrap
+from typing import Any, Dict, Optional
 
-from sky import sky_logging
-from sky.serve import constants
-from sky.serve import serve_state
-
-if typing.TYPE_CHECKING:
-    from sky.serve import replica_managers
-    from sky.serve import service_spec
-
-logger = sky_logging.init_logger(__name__)
-
-
-class AutoscalerDecisionOperator(enum.Enum):
-    SCALE_UP = 'scale_up'
-    SCALE_DOWN = 'scale_down'
-
-
-@dataclasses.dataclass
-class AutoscalerDecision:
-    """Autoscaling decisions.
-
-    |------------------------------------------------------------------------|
-    | Operator   | TargetType                | Meaning                       |
-    |------------|---------------------------|-------------------------------|
-    | SCALE_UP   | Optional[Dict[str, Any]   | Resource override to add      |
-    |------------|---------------------------|-------------------------------|
-    | SCALE_DOWN | int                       | Replica id to remove          |
-    |------------------------------------------------------------------------|
-    """
-    operator: AutoscalerDecisionOperator
-    target: Union[Optional[Dict[str, Any]], int]
-
-    # TODO(MaoZiming): Add a doc to elaborate on autoscaling policies.
-    def __init__(self, operator: AutoscalerDecisionOperator,
-                 target: Union[Optional[Dict[str, Any]], int]):
-
-        assert (operator == AutoscalerDecisionOperator.SCALE_UP and
-                (target is None or isinstance(target, dict))) or (
-                    operator == AutoscalerDecisionOperator.SCALE_DOWN and
-                    isinstance(target, int))
-        self.operator = operator
-        self.target = target
-
-    def __repr__(self) -> str:
-        return f'AutoscalerDecision({self.operator}, {self.target})'
+import yaml
 
+from sky.serve import constants
+from sky.utils import common_utils
+from sky.utils import schemas
+from sky.utils import ux_utils
 
-class Autoscaler:
-    """Abstract class for autoscalers."""
-
-    def __init__(self, spec: 'service_spec.SkyServiceSpec') -> None:
-        """Initialize the autoscaler.
 
-        Variables:
-            min_replicas: Minimum number of replicas.
-            max_replicas: Maximum number of replicas. Default to fixed
-                number of replicas, i.e. min_replicas == max_replicas.
-            target_num_replicas: Target number of replicas output by autoscaler.
-            latest_version: latest version of the service.
-        """
-        self.min_replicas: int = spec.min_replicas
-        self.max_replicas: int = (spec.max_replicas if spec.max_replicas
-                                  is not None else spec.min_replicas)
-        # Target number of replicas is initialized to min replicas.
-        self.target_num_replicas: int = spec.min_replicas
-        self.latest_version: int = constants.INITIAL_VERSION
-
-    def update_version(self, version: int,
-                       spec: 'service_spec.SkyServiceSpec') -> None:
-        if version <= self.latest_version:
-            logger.error(f'Invalid version: {version}, '
-                         f'latest version: {self.latest_version}')
-            return
-        self.latest_version = version
-        self.min_replicas = spec.min_replicas
-        self.max_replicas = (spec.max_replicas if spec.max_replicas is not None
-                             else spec.min_replicas)
-        # Reclip self.target_num_replicas with new min and max replicas.
-        self.target_num_replicas = max(
-            self.min_replicas, min(self.max_replicas, self.target_num_replicas))
-
-    def collect_request_information(
-            self, request_aggregator_info: Dict[str, Any]) -> None:
-        """Collect request information from aggregator for autoscaling."""
-        raise NotImplementedError
+class SkyServiceSpec:
+    """SkyServe service specification."""
 
-    def evaluate_scaling(
+    def __init__(
         self,
-        replica_infos: List['replica_managers.ReplicaInfo'],
-    ) -> List[AutoscalerDecision]:
-        """Evaluate autoscale options based on replica information."""
-        raise NotImplementedError
-
-
-class RequestRateAutoscaler(Autoscaler):
-    """RequestRateAutoscaler: Autoscale according to request rate.
-
-    Scales when the number of requests in the given interval is above or below
-    the threshold.
-    """
-
-    def __init__(self, spec: 'service_spec.SkyServiceSpec') -> None:
-        """Initialize the request rate autoscaler.
-
-        Variables:
-            target_qps_per_replica: Target qps per replica for autoscaling.
-            qps_window_size: Window size for qps calculating.
-            request_timestamps: All request timestamps within the window.
-            upscale_counter: counter for upscale number of replicas.
-            downscale_counter: counter for downscale number of replicas.
-            scale_up_consecutive_periods: period for scaling up.
-            scale_down_consecutive_periods: period for scaling down.
-            bootstrap_done: whether bootstrap is done.
-        """
-        super().__init__(spec)
-        self.target_qps_per_replica: Optional[
-            float] = spec.target_qps_per_replica
-        self.qps_window_size: int = constants.AUTOSCALER_QPS_WINDOW_SIZE_SECONDS
-        self.request_timestamps: List[float] = []
-        self.upscale_counter: int = 0
-        self.downscale_counter: int = 0
-        upscale_delay_seconds = (
-            spec.upscale_delay_seconds if spec.upscale_delay_seconds is not None
-            else constants.AUTOSCALER_DEFAULT_UPSCALE_DELAY_SECONDS)
-        self.scale_up_consecutive_periods: int = int(
-            upscale_delay_seconds /
-            constants.AUTOSCALER_DEFAULT_DECISION_INTERVAL_SECONDS)
-        downscale_delay_seconds = (
-            spec.downscale_delay_seconds
-            if spec.downscale_delay_seconds is not None else
-            constants.AUTOSCALER_DEFAULT_DOWNSCALE_DELAY_SECONDS)
-        self.scale_down_consecutive_periods: int = int(
-            downscale_delay_seconds /
-            constants.AUTOSCALER_DEFAULT_DECISION_INTERVAL_SECONDS)
-
-        self.bootstrap_done: bool = False
-
-    def update_version(self, version: int,
-                       spec: 'service_spec.SkyServiceSpec') -> None:
-        super().update_version(version, spec)
-        self.target_qps_per_replica = spec.target_qps_per_replica
-        upscale_delay_seconds = (
-            spec.upscale_delay_seconds if spec.upscale_delay_seconds is not None
-            else constants.AUTOSCALER_DEFAULT_UPSCALE_DELAY_SECONDS)
-        self.scale_up_consecutive_periods = int(
-            upscale_delay_seconds /
-            constants.AUTOSCALER_DEFAULT_DECISION_INTERVAL_SECONDS)
-        downscale_delay_seconds = (
-            spec.downscale_delay_seconds
-            if spec.downscale_delay_seconds is not None else
-            constants.AUTOSCALER_DEFAULT_DOWNSCALE_DELAY_SECONDS)
-        self.scale_down_consecutive_periods = int(
-            downscale_delay_seconds /
-            constants.AUTOSCALER_DEFAULT_DECISION_INTERVAL_SECONDS)
-        self.bootstrap_done = False
-
-    def collect_request_information(
-            self, request_aggregator_info: Dict[str, Any]) -> None:
-        """Collect request information from aggregator for autoscaling.
-
-        request_aggregator_info should be a dict with the following format:
-
-        {
-            'timestamps': [timestamp1 (float), timestamp2 (float), ...]
-        }
-        """
-        self.request_timestamps.extend(
-            request_aggregator_info.get('timestamps', []))
-        current_time = time.time()
-        index = bisect.bisect_left(self.request_timestamps,
-                                   current_time - self.qps_window_size)
-        self.request_timestamps = self.request_timestamps[index:]
-
-    def _get_desired_num_replicas(self) -> int:
-        # Always return self.target_num_replicas when autoscaling
-        # is not enabled, i.e. self.target_qps_per_replica is None.
-        # In this case, self.target_num_replicas will be min_replicas.
-        if self.target_qps_per_replica is None:
-            # self.bootstrap_done will not have effect.
-            self.bootstrap_done = True
-            return self.target_num_replicas
-
-        # Convert to requests per second.
-        num_requests_per_second = len(
-            self.request_timestamps) / self.qps_window_size
-        target_num_replicas = math.ceil(num_requests_per_second /
-                                        self.target_qps_per_replica)
-        target_num_replicas = max(self.min_replicas,
-                                  min(self.max_replicas, target_num_replicas))
-        logger.info(f'Requests per second: {num_requests_per_second}, '
-                    'Current/proposed target number of replicas: '
-                    f'{self.target_num_replicas}/{target_num_replicas}')
-
-        if not self.bootstrap_done or self.target_num_replicas == 0:
-            self.bootstrap_done = True
-            return target_num_replicas
-        elif target_num_replicas > self.target_num_replicas:
-            self.upscale_counter += 1
-            self.downscale_counter = 0
-            if self.upscale_counter >= self.scale_up_consecutive_periods:
-                self.upscale_counter = 0
-                return target_num_replicas
-        elif target_num_replicas < self.target_num_replicas:
-            self.downscale_counter += 1
-            self.upscale_counter = 0
-            if self.downscale_counter >= self.scale_down_consecutive_periods:
-                self.downscale_counter = 0
-                return target_num_replicas
+        readiness_path: str,
+        initial_delay_seconds: int,
+        min_replicas: int,
+        max_replicas: Optional[int] = None,
+        target_qps_per_replica: Optional[float] = None,
+        post_data: Optional[Dict[str, Any]] = None,
+        readiness_headers: Optional[Dict[str, str]] = None,
+        dynamic_ondemand_fallback: Optional[bool] = None,
+        base_ondemand_fallback_replicas: Optional[int] = None,
+        upscale_delay_seconds: Optional[int] = None,
+        downscale_delay_seconds: Optional[int] = None,
+        # The following arguments are deprecated.
+        # TODO(ziming): remove this after 2 minor release, i.e. 0.6.0.
+        # Deprecated: Always be True
+        auto_restart: Optional[bool] = None,
+        # Deprecated: replaced by the target_qps_per_replica.
+        qps_upper_threshold: Optional[float] = None,
+        qps_lower_threshold: Optional[float] = None,
+    ) -> None:
+        if max_replicas is not None and max_replicas < min_replicas:
+            with ux_utils.print_exception_no_traceback():
+                raise ValueError('max_replicas must be greater than or '
+                                 'equal to min_replicas. Found: '
+                                 f'min_replicas={min_replicas}, '
+                                 f'max_replicas={max_replicas}')
+
+        if target_qps_per_replica is not None:
+            if max_replicas is None:
+                with ux_utils.print_exception_no_traceback():
+                    raise ValueError('max_replicas must be set where '
+                                     'target_qps_per_replica is set.')
         else:
-            self.upscale_counter = self.downscale_counter = 0
-        return self.target_num_replicas
-
-    def get_decision_interval(self) -> int:
-        # Reduce autoscaler interval when target_num_replicas = 0.
-        # This will happen when min_replicas = 0 and no traffic.
-        if self.target_num_replicas == 0:
-            return constants.AUTOSCALER_NO_REPLICA_DECISION_INTERVAL_SECONDS
+            if max_replicas is not None and max_replicas != min_replicas:
+                with ux_utils.print_exception_no_traceback():
+                    raise ValueError(
+                        'Detected different min_replicas and max_replicas '
+                        'while target_qps_per_replica is not set. To enable '
+                        'autoscaling, please set target_qps_per_replica.')
+
+        if not readiness_path.startswith('/'):
+            with ux_utils.print_exception_no_traceback():
+                raise ValueError('readiness_path must start with a slash (/). '
+                                 f'Got: {readiness_path}')
+
+        # TODO(tian): Following field are deprecated. Remove after 2 minor
+        # release, i.e. 0.6.0.
+        if qps_upper_threshold is not None or qps_lower_threshold is not None:
+            with ux_utils.print_exception_no_traceback():
+                raise ValueError(
+                    'Field `qps_upper_threshold` and `qps_lower_threshold`'
+                    'under `replica_policy` are deprecated. '
+                    'Please use target_qps_per_replica instead.')
+        if auto_restart is not None:
+            with ux_utils.print_exception_no_traceback():
+                raise ValueError(
+                    'Field `auto_restart` under `replica_policy` is deprecated.'
+                    'Currently, SkyServe will cleanup failed replicas'
+                    'and auto restart it to keep the service running.')
+
+        self._readiness_path: str = readiness_path
+        self._initial_delay_seconds: int = initial_delay_seconds
+        self._min_replicas: int = min_replicas
+        self._max_replicas: Optional[int] = max_replicas
+        self._target_qps_per_replica: Optional[float] = target_qps_per_replica
+        self._post_data: Optional[Dict[str, Any]] = post_data
+        self._readiness_headers: Optional[Dict[str, str]] = readiness_headers
+        self._dynamic_ondemand_fallback: Optional[
+            bool] = dynamic_ondemand_fallback
+        self._base_ondemand_fallback_replicas: Optional[
+            int] = base_ondemand_fallback_replicas
+        self._upscale_delay_seconds: Optional[int] = upscale_delay_seconds
+        self._downscale_delay_seconds: Optional[int] = downscale_delay_seconds
+
+        self._use_ondemand_fallback: bool = (
+            self.dynamic_ondemand_fallback is not None and
+            self.dynamic_ondemand_fallback) or (
+                self.base_ondemand_fallback_replicas is not None and
+                self.base_ondemand_fallback_replicas > 0)
+
+    @staticmethod
+    def from_yaml_config(config: Dict[str, Any]) -> 'SkyServiceSpec':
+        common_utils.validate_schema(config, schemas.get_service_schema(),
+                                     'Invalid service YAML: ')
+        if 'replicas' in config and 'replica_policy' in config:
+            with ux_utils.print_exception_no_traceback():
+                raise ValueError(
+                    'Cannot specify both `replicas` and `replica_policy` in '
+                    'the service YAML. Please use one of them.')
+
+        service_config: Dict[str, Any] = {}
+
+        readiness_section = config['readiness_probe']
+        if isinstance(readiness_section, str):
+            service_config['readiness_path'] = readiness_section
+            initial_delay_seconds = None
+            post_data = None
+            readiness_headers = None
         else:
-            return constants.AUTOSCALER_DEFAULT_DECISION_INTERVAL_SECONDS
-
-    def evaluate_scaling(
-        self,
-        replica_infos: List['replica_managers.ReplicaInfo'],
-    ) -> List[AutoscalerDecision]:
-        """Evaluate Autoscaling decisions based on replica information.
-        If the number of launched replicas is less than the target,
-        Trigger a scale up. Else, trigger a scale down.
-
-        For future compatibility, we return a list of AutoscalerDecision.
-        Scale-up could include both spot and on-demand, each with a resource
-        override dict. Active migration could require returning both SCALE_UP
-        and SCALE_DOWN.
-        """
-        provisioning_and_launched_new_replica: List[
-            'replica_managers.ReplicaInfo'] = []
-        ready_new_replica: List['replica_managers.ReplicaInfo'] = []
-        old_replicas: List['replica_managers.ReplicaInfo'] = []
-        for info in replica_infos:
-            if info.version == self.latest_version:
-                if info.is_launched:
-                    provisioning_and_launched_new_replica.append(info)
-                if info.is_ready:
-                    ready_new_replica.append(info)
+            service_config['readiness_path'] = readiness_section['path']
+            initial_delay_seconds = readiness_section.get(
+                'initial_delay_seconds', None)
+            post_data = readiness_section.get('post_data', None)
+            readiness_headers = readiness_section.get('headers', None)
+        if initial_delay_seconds is None:
+            initial_delay_seconds = constants.DEFAULT_INITIAL_DELAY_SECONDS
+        service_config['initial_delay_seconds'] = initial_delay_seconds
+        if isinstance(post_data, str):
+            try:
+                post_data = json.loads(post_data)
+            except json.JSONDecodeError as e:
+                with ux_utils.print_exception_no_traceback():
+                    raise ValueError(
+                        'Invalid JSON string for `post_data` in the '
+                        '`readiness_probe` section of your service YAML.'
+                    ) from e
+        service_config['post_data'] = post_data
+        service_config['readiness_headers'] = readiness_headers
+
+        policy_section = config.get('replica_policy', None)
+        simplified_policy_section = config.get('replicas', None)
+        if policy_section is None or simplified_policy_section is not None:
+            if simplified_policy_section is not None:
+                min_replicas = simplified_policy_section
             else:
-                old_replicas.append(info)
+                min_replicas = constants.DEFAULT_MIN_REPLICAS
+            service_config['min_replicas'] = min_replicas
+            service_config['max_replicas'] = None
+            service_config['target_qps_per_replica'] = None
+            service_config['upscale_delay_seconds'] = None
+            service_config['downscale_delay_seconds'] = None
+        else:
+            service_config['min_replicas'] = policy_section['min_replicas']
+            service_config['max_replicas'] = policy_section.get(
+                'max_replicas', None)
+            service_config['qps_upper_threshold'] = policy_section.get(
+                'qps_upper_threshold', None)
+            service_config['qps_lower_threshold'] = policy_section.get(
+                'qps_lower_threshold', None)
+            service_config['target_qps_per_replica'] = policy_section.get(
+                'target_qps_per_replica', None)
+            service_config['auto_restart'] = policy_section.get(
+                'auto_restart', None)
+            service_config['upscale_delay_seconds'] = policy_section.get(
+                'upscale_delay_seconds', None)
+            service_config['downscale_delay_seconds'] = policy_section.get(
+                'downscale_delay_seconds', None)
+            service_config[
+                'base_ondemand_fallback_replicas'] = policy_section.get(
+                    'base_ondemand_fallback_replicas', None)
+            service_config['dynamic_ondemand_fallback'] = policy_section.get(
+                'dynamic_ondemand_fallback', None)
+
+        return SkyServiceSpec(**service_config)
+
+    @staticmethod
+    def from_yaml(yaml_path: str) -> 'SkyServiceSpec':
+        with open(os.path.expanduser(yaml_path), 'r', encoding='utf-8') as f:
+            config = yaml.safe_load(f)
+
+        if isinstance(config, str):
+            with ux_utils.print_exception_no_traceback():
+                raise ValueError('YAML loaded as str, not as dict. '
+                                 f'Is it correct? Path: {yaml_path}')
+
+        if config is None:
+            config = {}
+
+        if 'service' not in config:
+            with ux_utils.print_exception_no_traceback():
+                raise ValueError('Service YAML must have a "service" section. '
+                                 f'Is it correct? Path: {yaml_path}')
+
+        return SkyServiceSpec.from_yaml_config(config['service'])
+
+    def to_yaml_config(self) -> Dict[str, Any]:
+        config = dict()
+
+        def add_if_not_none(section, key, value, no_empty: bool = False):
+            if no_empty and not value:
+                return
+            if value is not None:
+                if key is None:
+                    config[section] = value
+                else:
+                    if section not in config:
+                        config[section] = dict()
+                    config[section][key] = value
+
+        add_if_not_none('readiness_probe', 'path', self.readiness_path)
+        add_if_not_none('readiness_probe', 'initial_delay_seconds',
+                        self.initial_delay_seconds)
+        add_if_not_none('readiness_probe', 'post_data', self.post_data)
+        add_if_not_none('readiness_probe', 'headers', self._readiness_headers)
+        add_if_not_none('replica_policy', 'min_replicas', self.min_replicas)
+        add_if_not_none('replica_policy', 'max_replicas', self.max_replicas)
+        add_if_not_none('replica_policy', 'target_qps_per_replica',
+                        self.target_qps_per_replica)
+        add_if_not_none('replica_policy', 'dynamic_ondemand_fallback',
+                        self.dynamic_ondemand_fallback)
+        add_if_not_none('replica_policy', 'base_ondemand_fallback_replicas',
+                        self.base_ondemand_fallback_replicas)
+        add_if_not_none('replica_policy', 'upscale_delay_seconds',
+                        self.upscale_delay_seconds)
+        add_if_not_none('replica_policy', 'downscale_delay_seconds',
+                        self.downscale_delay_seconds)
+        return config
+
+    def probe_str(self):
+        if self.post_data is None:
+            method = f'GET {self.readiness_path}'
+        else:
+            method = f'POST {self.readiness_path} {json.dumps(self.post_data)}'
+        headers = ('' if self.readiness_headers is None else
+                   ' with custom headers')
+        return f'{method}{headers}'
+
+    def spot_policy_str(self):
+        policy_strs = []
+        if (self.dynamic_ondemand_fallback is not None and
+                self.dynamic_ondemand_fallback):
+            policy_strs.append('Dynamic on-demand fallback')
+            if self.base_ondemand_fallback_replicas is not None:
+                policy_strs.append(
+                    f'with {self.base_ondemand_fallback_replicas}'
+                    'base on-demand replicas')
+        else:
+            if self.base_ondemand_fallback_replicas is not None:
+                plural = (''
+                          if self.base_ondemand_fallback_replicas == 1 else 's')
+                policy_strs.append('Static spot mixture with '
+                                   f'{self.base_ondemand_fallback_replicas} '
+                                   f'base on-demand replica{plural}')
+        return ' '.join(policy_strs) if policy_strs else 'No spot policy'
+
+    def autoscaling_policy_str(self):
+        # TODO(MaoZiming): Update policy_str
+        min_plural = '' if self.min_replicas == 1 else 's'
+        if self.max_replicas == self.min_replicas or self.max_replicas is None:
+            return f'Fixed {self.min_replicas} replica{min_plural}'
+        # Already checked in __init__.
+        assert self.target_qps_per_replica is not None
+        # TODO(tian): Refactor to contain more information
+        max_plural = '' if self.max_replicas == 1 else 's'
+        return (f'Autoscaling from {self.min_replicas} to {self.max_replicas} '
+                f'replica{max_plural} (target QPS per replica: '
+                f'{self.target_qps_per_replica})')
 
-        self.target_num_replicas = self._get_desired_num_replicas()
-        logger.info(
-            f'Final target number of replicas: {self.target_num_replicas} '
-            f'Upscale counter: {self.upscale_counter}/'
-            f'{self.scale_up_consecutive_periods}, '
-            f'Downscale counter: {self.downscale_counter}/'
-            f'{self.scale_down_consecutive_periods} '
-            'Number of launched latest replicas: '
-            f'{len(provisioning_and_launched_new_replica)}')
-
-        scaling_options = []
-        all_replica_ids_to_scale_down: List[int] = []
-
-        def _get_replica_ids_to_scale_down(num_limit: int) -> List[int]:
-
-            status_order = serve_state.ReplicaStatus.scale_down_decision_order()
-            launched_replica_infos_sorted = sorted(
-                provisioning_and_launched_new_replica,
-                key=lambda info: status_order.index(info.status)
-                if info.status in status_order else len(status_order))
-
-            return [info.replica_id for info in launched_replica_infos_sorted
-                   ][:num_limit]
-
-        # Case 1. Once there is min_replicas number of
-        # ready new replicas, we will direct all traffic to them,
-        # we can scale down all old replicas.
-        if len(ready_new_replica) >= self.min_replicas:
-            for info in old_replicas:
-                all_replica_ids_to_scale_down.append(info.replica_id)
-
-        # Case 2. when provisioning_and_launched_new_replica is less
-        # than target_num_replicas, we always scale up new replicas.
-        if len(provisioning_and_launched_new_replica
-              ) < self.target_num_replicas:
-            num_replicas_to_scale_up = (
-                self.target_num_replicas -
-                len(provisioning_and_launched_new_replica))
-
-            for _ in range(num_replicas_to_scale_up):
-                scaling_options.append(
-                    AutoscalerDecision(AutoscalerDecisionOperator.SCALE_UP,
-                                       target=None))
-
-        # Case 3: when provisioning_and_launched_new_replica is more
-        # than target_num_replicas, we scale down new replicas.
-        if len(provisioning_and_launched_new_replica
-              ) > self.target_num_replicas:
-            num_replicas_to_scale_down = (
-                len(provisioning_and_launched_new_replica) -
-                self.target_num_replicas)
-            all_replica_ids_to_scale_down.extend(
-                _get_replica_ids_to_scale_down(
-                    num_limit=num_replicas_to_scale_down))
-
-        for replica_id in all_replica_ids_to_scale_down:
-            scaling_options.append(
-                AutoscalerDecision(AutoscalerDecisionOperator.SCALE_DOWN,
-                                   target=replica_id))
-
-        if not scaling_options:
-            logger.info('No scaling needed.')
-        return scaling_options
+    def __repr__(self) -> str:
+        return textwrap.dedent(f"""\
+            Readiness probe method:           {self.probe_str()}
+            Readiness initial delay seconds:  {self.initial_delay_seconds}
+            Replica autoscaling policy:       {self.autoscaling_policy_str()}
+            Spot Policy:                      {self.spot_policy_str()}
+        """)
+
+    @property
+    def readiness_path(self) -> str:
+        return self._readiness_path
+
+    @property
+    def initial_delay_seconds(self) -> int:
+        return self._initial_delay_seconds
+
+    @property
+    def min_replicas(self) -> int:
+        return self._min_replicas
+
+    @property
+    def max_replicas(self) -> Optional[int]:
+        # If None, treated as having the same value of min_replicas.
+        return self._max_replicas
+
+    @property
+    def target_qps_per_replica(self) -> Optional[float]:
+        return self._target_qps_per_replica
+
+    @property
+    def post_data(self) -> Optional[Dict[str, Any]]:
+        return self._post_data
+
+    @property
+    def readiness_headers(self) -> Optional[Dict[str, str]]:
+        return self._readiness_headers
+
+    @property
+    def base_ondemand_fallback_replicas(self) -> Optional[int]:
+        return self._base_ondemand_fallback_replicas
+
+    @property
+    def dynamic_ondemand_fallback(self) -> Optional[bool]:
+        return self._dynamic_ondemand_fallback
+
+    @property
+    def upscale_delay_seconds(self) -> Optional[int]:
+        return self._upscale_delay_seconds
+
+    @property
+    def downscale_delay_seconds(self) -> Optional[int]:
+        return self._downscale_delay_seconds
+
+    @property
+    def use_ondemand_fallback(self) -> bool:
+        return self._use_ondemand_fallback
```

### Comparing `skypilot-0.5.0/sky/serve/controller.py` & `skypilot-0.6.0/sky/serve/controller.py`

 * *Files 18% similar despite different names*

```diff
@@ -1,28 +1,28 @@
 """SkyServeController: the central controller of SkyServe.
 
 Responsible for autoscaling and replica management.
 """
-
 import logging
+import os
 import threading
 import time
 import traceback
+from typing import Any, Dict, List
 
 import fastapi
 import uvicorn
 
 from sky import serve
 from sky import sky_logging
 from sky.serve import autoscalers
 from sky.serve import replica_managers
 from sky.serve import serve_state
 from sky.serve import serve_utils
 from sky.utils import common_utils
-from sky.utils import env_options
 from sky.utils import ux_utils
 
 logger = sky_logging.init_logger(__name__)
 
 
 class SuppressSuccessGetAccessLogsFilter(logging.Filter):
 
@@ -36,38 +36,35 @@
 
     This class is responsible for:
         - Starting and terminating the replica monitor and autoscaler.
         - Providing the HTTP Server API for SkyServe to communicate with.
     """
 
     def __init__(self, service_name: str, service_spec: serve.SkyServiceSpec,
-                 task_yaml: str, port: int) -> None:
+                 task_yaml: str, host: str, port: int) -> None:
         self._service_name = service_name
         self._replica_manager: replica_managers.ReplicaManager = (
             replica_managers.SkyPilotReplicaManager(service_name=service_name,
                                                     spec=service_spec,
                                                     task_yaml_path=task_yaml))
         self._autoscaler: autoscalers.Autoscaler = (
-            autoscalers.RequestRateAutoscaler(service_spec))
+            autoscalers.Autoscaler.from_spec(service_name, service_spec))
+        self._host = host
         self._port = port
         self._app = fastapi.FastAPI()
 
     def _run_autoscaler(self):
         logger.info('Starting autoscaler.')
         while True:
             try:
-                replica_info = serve_state.get_replica_infos(self._service_name)
-                replica_info_dicts = [
-                    info.to_info_dict(
-                        with_handle=env_options.Options.SHOW_DEBUG_INFO.get())
-                    for info in replica_info
-                ]
-                logger.info(f'All replica info: {replica_info_dicts}')
+                replica_infos = serve_state.get_replica_infos(
+                    self._service_name)
+                logger.info(f'All replica info: {replica_infos}')
                 scaling_options = self._autoscaler.evaluate_scaling(
-                    replica_info)
+                    replica_infos)
                 for scaling_option in scaling_options:
                     logger.info(f'Scaling option received: {scaling_option}')
                     if (scaling_option.operator ==
                             autoscalers.AutoscalerDecisionOperator.SCALE_UP):
                         assert (scaling_option.target is None or isinstance(
                             scaling_option.target, dict)), scaling_option
                         self._replica_manager.scale_up(scaling_option.target)
@@ -90,40 +87,60 @@
             time.sleep(self._autoscaler.get_decision_interval())
 
     def run(self) -> None:
 
         @self._app.post('/controller/load_balancer_sync')
         async def load_balancer_sync(request: fastapi.Request):
             request_data = await request.json()
-            request_aggregator = request_data.get('request_aggregator')
-            logger.info(
-                f'Received inflight request information: {request_aggregator}')
+            # TODO(MaoZiming): Check aggregator type.
+            request_aggregator: Dict[str, Any] = request_data.get(
+                'request_aggregator', {})
+            timestamps: List[int] = request_aggregator.get('timestamps', [])
+            logger.info(f'Received {len(timestamps)} inflight requests.')
             self._autoscaler.collect_request_information(request_aggregator)
             return {
                 'ready_replica_urls':
-                    self._replica_manager.get_ready_replica_urls()
+                    self._replica_manager.get_active_replica_urls()
             }
 
         @self._app.post('/controller/update_service')
         async def update_service(request: fastapi.Request):
             request_data = await request.json()
             try:
                 version = request_data.get('version', None)
                 if version is None:
                     return {'message': 'Error: version is not specified.'}
+                update_mode_str = request_data.get(
+                    'mode', serve_utils.DEFAULT_UPDATE_MODE.value)
+                update_mode = serve_utils.UpdateMode(update_mode_str)
+                logger.info(f'Update to new version {version} with '
+                            f'update_mode {update_mode}.')
                 # The yaml with the name latest_task_yaml will be synced
                 # See sky/serve/core.py::update
                 latest_task_yaml = serve_utils.generate_task_yaml_file_name(
                     self._service_name, version)
                 service = serve.SkyServiceSpec.from_yaml(latest_task_yaml)
                 logger.info(
                     f'Update to new version version {version}: {service}')
 
-                self._replica_manager.update_version(version, service)
-                self._autoscaler.update_version(version, service)
+                self._replica_manager.update_version(version,
+                                                     service,
+                                                     update_mode=update_mode)
+                new_autoscaler = autoscalers.Autoscaler.from_spec(
+                    self._service_name, service)
+                if not isinstance(self._autoscaler, type(new_autoscaler)):
+                    logger.info('Autoscaler type changed to '
+                                f'{type(new_autoscaler)}, updating autoscaler.')
+                    old_autoscaler = self._autoscaler
+                    self._autoscaler = new_autoscaler
+                    self._autoscaler.load_dynamic_states(
+                        old_autoscaler.dump_dynamic_states())
+                self._autoscaler.update_version(version,
+                                                service,
+                                                update_mode=update_mode)
                 return {'message': 'Success'}
             except Exception as e:  # pylint: disable=broad-except
                 logger.error(f'Error in update_service: '
                              f'{common_utils.format_exception(e)}')
                 return {'message': 'Error'}
 
         @self._app.on_event('startup')
@@ -131,19 +148,29 @@
             uvicorn_access_logger = logging.getLogger('uvicorn.access')
             for handler in uvicorn_access_logger.handlers:
                 handler.setFormatter(sky_logging.FORMATTER)
 
         threading.Thread(target=self._run_autoscaler).start()
 
         logger.info('SkyServe Controller started on '
-                    f'http://localhost:{self._port}')
+                    f'http://{self._host}:{self._port}')
 
-        uvicorn.run(self._app, host='localhost', port=self._port)
+        uvicorn.run(self._app, host={self._host}, port=self._port)
 
 
 # TODO(tian): Probably we should support service that will stop the VM in
 # specific time period.
 def run_controller(service_name: str, service_spec: serve.SkyServiceSpec,
                    task_yaml: str, controller_port: int):
-    controller = SkyServeController(service_name, service_spec, task_yaml,
+    # We expose the controller to the public network when running inside a
+    # kubernetes cluster to allow external load balancers (example, for
+    # high availability load balancers) to communicate with the controller.
+    def _get_host():
+        if 'KUBERNETES_SERVICE_HOST' in os.environ:
+            return '0.0.0.0'
+        else:
+            return 'localhost'
+
+    host = _get_host()
+    controller = SkyServeController(service_name, service_spec, task_yaml, host,
                                     controller_port)
     controller.run()
```

### Comparing `skypilot-0.5.0/sky/serve/core.py` & `skypilot-0.6.0/sky/serve/core.py`

 * *Files 8% similar despite different names*

```diff
@@ -1,50 +1,116 @@
 """SkyServe core APIs."""
 import re
 import tempfile
-import typing
-from typing import Any, Dict, List, Optional, Union
+from typing import Any, Dict, List, Optional, Tuple, Union
 
 import colorama
 
 import sky
 from sky import backends
 from sky import exceptions
-from sky import global_user_state
 from sky import sky_logging
-from sky import status_lib
 from sky import task as task_lib
 from sky.backends import backend_utils
+from sky.clouds.service_catalog import common as service_catalog_common
 from sky.serve import constants as serve_constants
 from sky.serve import serve_state
 from sky.serve import serve_utils
 from sky.skylet import constants
 from sky.usage import usage_lib
 from sky.utils import common_utils
 from sky.utils import controller_utils
+from sky.utils import resources_utils
 from sky.utils import rich_utils
 from sky.utils import subprocess_utils
 from sky.utils import ux_utils
 
-if typing.TYPE_CHECKING:
-    from sky import clouds
+logger = sky_logging.init_logger(__name__)
+
+
+def _validate_service_task(task: 'sky.Task') -> None:
+    """Validate the task for Sky Serve.
+
+    Args:
+        task: sky.Task to validate
+
+    Raises:
+        ValueError: if the arguments are invalid.
+        RuntimeError: if the task.serve is not found.
+    """
+    spot_resources: List['sky.Resources'] = [
+        resource for resource in task.resources if resource.use_spot
+    ]
+    # TODO(MaoZiming): Allow mixed on-demand and spot specification in resources
+    # On-demand fallback should go to the resources specified as on-demand.
+    if len(spot_resources) not in [0, len(task.resources)]:
+        with ux_utils.print_exception_no_traceback():
+            raise ValueError(
+                'Resources must either all use spot or none use spot. '
+                'To use on-demand and spot instances together, '
+                'use `dynamic_ondemand_fallback` or set '
+                'base_ondemand_fallback_replicas.')
+
+    if task.service is None:
+        with ux_utils.print_exception_no_traceback():
+            raise RuntimeError('Service section not found.')
+
+    policy_description = ('on-demand'
+                          if task.service.dynamic_ondemand_fallback else 'spot')
+    for resource in list(task.resources):
+        if resource.job_recovery is not None:
+            with ux_utils.print_exception_no_traceback():
+                raise ValueError('job_recovery is disabled for SkyServe. '
+                                 'SkyServe will replenish preempted spot '
+                                 f'with {policy_description} instances.')
+
+    replica_ingress_port: Optional[int] = None
+    for requested_resources in task.resources:
+        if (task.service.use_ondemand_fallback and
+                not requested_resources.use_spot):
+            with ux_utils.print_exception_no_traceback():
+                raise ValueError(
+                    '`use_ondemand_fallback` is only supported '
+                    'for spot resources. Please explicitly specify '
+                    '`use_spot: true` in resources for on-demand fallback.')
+        requested_ports = list(
+            resources_utils.port_ranges_to_set(requested_resources.ports))
+        if len(requested_ports) != 1:
+            with ux_utils.print_exception_no_traceback():
+                raise ValueError(
+                    'Must only specify one port in resources. Each replica '
+                    'will use the port specified as application ingress port.')
+        service_port = requested_ports[0]
+        if replica_ingress_port is None:
+            replica_ingress_port = service_port
+        elif service_port != replica_ingress_port:
+            with ux_utils.print_exception_no_traceback():
+                raise ValueError(
+                    f'Got multiple ports: {service_port} and '
+                    f'{replica_ingress_port} in different resources. '
+                    'Please specify the same port instead.')
 
 
 @usage_lib.entrypoint
 def up(
     task: 'sky.Task',
     service_name: Optional[str] = None,
-) -> None:
+) -> Tuple[str, str]:
     """Spin up a service.
 
     Please refer to the sky.cli.serve_up for the document.
 
     Args:
         task: sky.Task to serve up.
         service_name: Name of the service.
+
+    Returns:
+        service_name: str; The name of the service.  Same if passed in as an
+            argument.
+        endpoint: str; The service endpoint.
     """
     if service_name is None:
         service_name = serve_utils.generate_service_name()
 
     # The service name will be used as:
     # 1. controller cluster name: 'sky-serve-controller-<service_name>'
     # 2. replica cluster name: '<service_name>-<replica_id>'
@@ -52,51 +118,15 @@
     if re.fullmatch(constants.CLUSTER_NAME_VALID_REGEX, service_name) is None:
         with ux_utils.print_exception_no_traceback():
             raise ValueError(f'Service name {service_name!r} is invalid: '
                              f'ensure it is fully matched by regex (e.g., '
                              'only contains lower letters, numbers and dash): '
                              f'{constants.CLUSTER_NAME_VALID_REGEX}')
 
-    if task.service is None:
-        with ux_utils.print_exception_no_traceback():
-            raise RuntimeError('Service section not found.')
-
-    # If all resources are from the same cloud, set the cloud of the controller
-    # to be that cloud if it does not exist yet. If the controller and all
-    # replicas are from the same cloud, it should provide better connectivity.
-    requested_cloud: Optional['clouds.Cloud'] = None
-    requested_multiple_clouds: bool = False
-    service_port: Optional[int] = None
-    for requested_resources in task.resources:
-        if requested_resources.ports is None or len(
-                requested_resources.ports) != 1:
-            with ux_utils.print_exception_no_traceback():
-                raise ValueError(
-                    'Must only specify one port in resources. Each replica '
-                    'will use the port specified as application ingress port.')
-        service_port_str = requested_resources.ports[0]
-        if not service_port_str.isdigit():
-            # For the case when the user specified a port range like 10000-10010
-            raise ValueError(f'Port {service_port_str!r} is not a valid port '
-                             'number. Please specify a single port instead. '
-                             f'Got: {service_port_str!r}')
-        resource_port = int(service_port_str)
-        if service_port is None:
-            service_port = resource_port
-        if service_port != resource_port:
-            raise ValueError(
-                f'Got multiple ports: {service_port} and {resource_port} '
-                'in different resources. Please specify single port instead.')
-        if requested_cloud is None:
-            requested_cloud = requested_resources.cloud
-        if requested_cloud != requested_resources.cloud:
-            requested_multiple_clouds = True
-    # If multiple clouds are used, skip this optimization.
-    if requested_multiple_clouds:
-        requested_cloud = None
+    _validate_service_task(task)
 
     controller_utils.maybe_translate_local_file_mounts_and_sync_up(task,
                                                                    path='serve')
 
     with tempfile.NamedTemporaryFile(
             prefix=f'service-task-{service_name}-',
             mode='w',
@@ -109,46 +139,43 @@
         common_utils.dump_yaml(service_file.name, task_config)
         remote_tmp_task_yaml_path = (
             serve_utils.generate_remote_tmp_task_yaml_file_name(service_name))
         remote_config_yaml_path = (
             serve_utils.generate_remote_config_yaml_file_name(service_name))
         controller_log_file = (
             serve_utils.generate_remote_controller_log_file_name(service_name))
-        controller_resources = (controller_utils.get_controller_resources(
-            controller_type='serve',
-            controller_resources_config=serve_constants.CONTROLLER_RESOURCES))
+        controller_resources = controller_utils.get_controller_resources(
+            controller=controller_utils.Controllers.SKY_SERVE_CONTROLLER,
+            task_resources=task.resources)
 
         vars_to_fill = {
             'remote_task_yaml_path': remote_tmp_task_yaml_path,
             'local_task_yaml_path': service_file.name,
             'service_name': service_name,
             'controller_log_file': controller_log_file,
             'remote_user_config_path': remote_config_yaml_path,
+            'modified_catalogs':
+                service_catalog_common.get_modified_catalog_file_mounts(),
             **controller_utils.shared_controller_vars_to_fill(
-                'serve',
+                controller=controller_utils.Controllers.SKY_SERVE_CONTROLLER,
                 remote_user_config_path=remote_config_yaml_path,
             ),
         }
         common_utils.fill_template(serve_constants.CONTROLLER_TEMPLATE,
                                    vars_to_fill,
                                    output_path=controller_file.name)
         controller_task = task_lib.Task.from_yaml(controller_file.name)
-        controller_exist = (
-            global_user_state.get_cluster_from_name(controller_name)
-            is not None)
-        controller_cloud = (requested_cloud if not controller_exist and
-                            controller_resources.cloud is None else
-                            controller_resources.cloud)
         # TODO(tian): Probably run another sky.launch after we get the load
         # balancer port from the controller? So we don't need to open so many
         # ports here. Or, we should have a nginx traffic control to refuse
         # any connection to the unregistered ports.
-        controller_resources = controller_resources.copy(
-            cloud=controller_cloud,
-            ports=[serve_constants.LOAD_BALANCER_PORT_RANGE])
+        controller_resources = {
+            r.copy(ports=[serve_constants.LOAD_BALANCER_PORT_RANGE])
+            for r in controller_resources
+        }
         controller_task.set_resources(controller_resources)
 
         # # Set service_name so the backend will know to modify default ray
         # task CPU usage to custom value instead of default 0.5 vCPU. We need
         # to set it to a smaller value to support a larger number of services.
         controller_task.service_name = service_name
 
@@ -160,21 +187,21 @@
         # successfully write its job id to controller service database;
         # and for all following sky.serve.up(), the controller will throw
         # an exception (name conflict detected) and exit. Therefore the
         # controller job id in database could be use as an indicator of
         # whether the service is already running. If the id is the same
         # with the current job id, we know the service is up and running
         # for the first time; otherwise it is a name conflict.
+        idle_minutes_to_autostop = constants.CONTROLLER_IDLE_MINUTES_TO_AUTOSTOP
         controller_job_id, controller_handle = sky.launch(
             task=controller_task,
             stream_logs=False,
             cluster_name=controller_name,
             detach_run=True,
-            idle_minutes_to_autostop=constants.
-            CONTROLLER_IDLE_MINUTES_TO_AUTOSTOP,
+            idle_minutes_to_autostop=idle_minutes_to_autostop,
             retry_until_up=True,
             _disable_controller_check=True,
         )
 
         style = colorama.Style
         fore = colorama.Fore
 
@@ -227,15 +254,18 @@
                 with ux_utils.print_exception_no_traceback():
                     raise RuntimeError(
                         'Failed to spin up the service. Please '
                         'check the logs above for more details.') from None
         else:
             lb_port = serve_utils.load_service_initialization_result(
                 lb_port_payload)
-            endpoint = f'{controller_handle.head_ip}:{lb_port}'
+            endpoint = backend_utils.get_endpoints(
+                controller_handle.cluster_name, lb_port,
+                skip_status_check=True).get(lb_port)
+            assert endpoint is not None, 'Did not get endpoint for controller.'
 
         sky_logging.print(
             f'{fore.CYAN}Service name: '
             f'{style.BRIGHT}{service_name}{style.RESET_ALL}'
             f'\n{fore.CYAN}Endpoint URL: '
             f'{style.BRIGHT}{endpoint}{style.RESET_ALL}'
             '\nTo see detailed info:\t\t'
@@ -255,45 +285,49 @@
             f'{backend_utils.BOLD}sky serve logs --controller {service_name}'
             f'{backend_utils.RESET_BOLD}'
             '\n'
             '\nTo monitor replica status:\t'
             f'{backend_utils.BOLD}watch -n10 sky serve status {service_name}'
             f'{backend_utils.RESET_BOLD}'
             '\nTo send a test request:\t\t'
-            f'{backend_utils.BOLD}curl -L {endpoint}'
+            f'{backend_utils.BOLD}curl {endpoint}'
             f'{backend_utils.RESET_BOLD}'
             '\n'
             f'\n{fore.GREEN}SkyServe is spinning up your service now.'
             f'{style.RESET_ALL}'
             f'\n{fore.GREEN}The replicas should be ready within a '
             f'short time.{style.RESET_ALL}')
+        return service_name, endpoint
 
 
 @usage_lib.entrypoint
-def update(task: 'sky.Task', service_name: str) -> None:
+def update(
+        task: 'sky.Task',
+        service_name: str,
+        mode: serve_utils.UpdateMode = serve_utils.DEFAULT_UPDATE_MODE) -> None:
+    """Update an existing service.
+
+    Please refer to the sky.cli.serve_update for the document.
 
-    cluster_status, handle = backend_utils.is_controller_up(
-        controller_type=controller_utils.Controllers.SKY_SERVE_CONTROLLER,
+    Args:
+        task: sky.Task to update.
+        service_name: Name of the service.
+    """
+    _validate_service_task(task)
+    handle = backend_utils.is_controller_accessible(
+        controller=controller_utils.Controllers.SKY_SERVE_CONTROLLER,
         stopped_message=
         'Service controller is stopped. There is no service to update. '
         f'To spin up a new service, use {backend_utils.BOLD}'
         f'sky serve up{backend_utils.RESET_BOLD}',
         non_existent_message='Service does not exist. '
         'To spin up a new service, '
         f'use {backend_utils.BOLD}sky serve up{backend_utils.RESET_BOLD}',
     )
 
-    if handle is None or handle.head_ip is None:
-        # The error message is already printed in
-        # backend_utils.is_controller_up
-        # TODO(zhwu): Move the error message into the exception.
-        with ux_utils.print_exception_no_traceback():
-            raise exceptions.ClusterNotUpError(message='',
-                                               cluster_status=cluster_status)
-
     backend = backend_utils.get_backend_from_handle(handle)
     assert isinstance(backend, backends.CloudVmRayBackend)
 
     code = serve_utils.ServeCodeGen.get_service_status([service_name])
     returncode, serve_status_payload, stderr = backend.run_on_head(
         handle,
         code,
@@ -330,18 +364,14 @@
          ):
         prompt = (f'Service {service_name!r} is still initializing '
                   'its controller. Please try again later.')
     if prompt is not None:
         with ux_utils.print_exception_no_traceback():
             raise RuntimeError(prompt)
 
-    if task.service is None:
-        with ux_utils.print_exception_no_traceback():
-            raise ValueError('Service section not found in the task. ')
-
     controller_utils.maybe_translate_local_file_mounts_and_sync_up(task,
                                                                    path='serve')
 
     code = serve_utils.ServeCodeGen.add_version(service_name)
     returncode, version_string_payload, stderr = backend.run_on_head(
         handle,
         code,
@@ -375,15 +405,16 @@
             service_name, current_version, expand_user=False)
 
         backend.sync_file_mounts(handle,
                                  {remote_task_yaml_path: service_file.name},
                                  storage_mounts=None)
 
         code = serve_utils.ServeCodeGen.update_service(service_name,
-                                                       current_version)
+                                                       current_version,
+                                                       mode=mode.value)
         returncode, _, stderr = backend.run_on_head(handle,
                                                     code,
                                                     require_outputs=True,
                                                     stream_logs=False,
                                                     separate_stderr=True)
         try:
             subprocess_utils.handle_returncode(returncode,
@@ -422,24 +453,17 @@
         ValueError: if the arguments are invalid.
         RuntimeError: if failed to terminate the service.
     """
     if service_names is None:
         service_names = []
     if isinstance(service_names, str):
         service_names = [service_names]
-    cluster_status, handle = backend_utils.is_controller_up(
-        controller_type=controller_utils.Controllers.SKY_SERVE_CONTROLLER,
+    handle = backend_utils.is_controller_accessible(
+        controller=controller_utils.Controllers.SKY_SERVE_CONTROLLER,
         stopped_message='All services should have terminated.')
-    if handle is None or handle.head_ip is None:
-        # The error message is already printed in
-        # backend_utils.is_controller_up
-        # TODO(zhwu): Move the error message into the exception.
-        with ux_utils.print_exception_no_traceback():
-            raise exceptions.ClusterNotUpError(message='',
-                                               cluster_status=cluster_status)
 
     service_names_str = ','.join(service_names)
     if sum([len(service_names) > 0, all]) != 1:
         argument_str = f'service_names={service_names_str}' if len(
             service_names) > 0 else ''
         argument_str += ' all' if all else ''
         raise ValueError('Can only specify one of service_names or all. '
@@ -451,15 +475,15 @@
     code = serve_utils.ServeCodeGen.terminate_services(service_names, purge)
 
     try:
         returncode, stdout, _ = backend.run_on_head(handle,
                                                     code,
                                                     require_outputs=True,
                                                     stream_logs=False)
-    except exceptions.FetchIPError as e:
+    except exceptions.FetchClusterInfoError as e:
         raise RuntimeError(
             'Failed to fetch controller IP. Please refresh controller status '
             f'by `sky status -r {serve_utils.SKY_SERVE_CONTROLLER_NAME}` '
             'and try again.') from e
 
     try:
         subprocess_utils.handle_returncode(returncode, code,
@@ -482,14 +506,15 @@
 
     Each returned value has the following fields:
 
     .. code-block:: python
 
         {
             'name': (str) service name,
+            'active_versions': (List[int]) a list of versions that are active,
             'controller_job_id': (int) the job id of the controller,
             'uptime': (int) uptime in seconds,
             'status': (sky.ServiceStatus) service status,
             'controller_port': (Optional[int]) controller port,
             'load_balancer_port': (Optional[int]) load balancer port,
             'policy': (Optional[str]) load balancer policy description,
             'requested_resources': (sky.Resources) requested resources
@@ -534,29 +559,18 @@
     try:
         backend_utils.check_network_connection()
     except exceptions.NetworkError as e:
         with ux_utils.print_exception_no_traceback():
             raise RuntimeError(
                 'Failed to refresh service status due to network error.') from e
 
-    # TODO(tian): This is so slow... It will take ~10s to refresh the status
-    # of controller. Can we optimize this?
-    controller_status, handle = backend_utils.is_controller_up(
-        controller_type=controller_utils.Controllers.SKY_SERVE_CONTROLLER,
-        stopped_message='No service is found.')
-
-    if handle is None or handle.head_ip is None:
-        # When the controller is STOPPED, the head_ip will be None, as
-        # it will be set in global_user_state.remove_cluster().
-        # We do not directly check for UP because the controller may be
-        # in INIT state during another `sky serve up`, but still have
-        # head_ip available. In this case, we can still try to ssh
-        # into the controller and fetch the job table.
-        raise exceptions.ClusterNotUpError('Sky serve controller is not up.',
-                                           cluster_status=controller_status)
+    controller_type = controller_utils.Controllers.SKY_SERVE_CONTROLLER
+    handle = backend_utils.is_controller_accessible(
+        controller=controller_type,
+        stopped_message=controller_type.value.default_hint_if_non_existent)
 
     backend = backend_utils.get_backend_from_handle(handle)
     assert isinstance(backend, backends.CloudVmRayBackend)
 
     code = serve_utils.ServeCodeGen.get_service_status(service_names)
     returncode, serve_status_payload, stderr = backend.run_on_head(
         handle,
@@ -630,23 +644,19 @@
                 raise ValueError(
                     '`replica_id` must be specified when using target=REPLICA.')
     else:
         if replica_id is not None:
             with ux_utils.print_exception_no_traceback():
                 raise ValueError('`replica_id` must be None when using '
                                  'target=CONTROLLER/LOAD_BALANCER.')
-    controller_status, handle = backend_utils.is_controller_up(
-        controller_type=controller_utils.Controllers.SKY_SERVE_CONTROLLER,
-        stopped_message='No service is found.')
-    if handle is None or handle.head_ip is None:
-        msg = 'No service is found.'
-        if controller_status == status_lib.ClusterStatus.INIT:
-            msg = ''
-        raise exceptions.ClusterNotUpError(msg,
-                                           cluster_status=controller_status)
+    handle = backend_utils.is_controller_accessible(
+        controller=controller_utils.Controllers.SKY_SERVE_CONTROLLER,
+        stopped_message=(controller_utils.Controllers.SKY_SERVE_CONTROLLER.
+                         value.default_hint_if_non_existent))
+
     backend = backend_utils.get_backend_from_handle(handle)
     assert isinstance(backend, backends.CloudVmRayBackend), backend
     backend.tail_serve_logs(handle,
                             service_name,
                             target,
                             replica_id,
                             follow=follow)
```

### Comparing `skypilot-0.5.0/sky/serve/load_balancing_policies.py` & `skypilot-0.6.0/sky/serve/load_balancing_policies.py`

 * *Files 8% similar despite different names*

```diff
@@ -7,52 +7,64 @@
 
 if typing.TYPE_CHECKING:
     import fastapi
 
 logger = sky_logging.init_logger(__name__)
 
 
+def _request_repr(request: 'fastapi.Request') -> str:
+    return ('<Request '
+            f'method="{request.method}" '
+            f'url="{request.url}" '
+            f'headers={dict(request.headers)} '
+            f'query_params={dict(request.query_params)}>')
+
+
 class LoadBalancingPolicy:
     """Abstract class for load balancing policies."""
 
     def __init__(self) -> None:
         self.ready_replicas: List[str] = []
 
     def set_ready_replicas(self, ready_replicas: List[str]) -> None:
         raise NotImplementedError
 
+    def select_replica(self, request: 'fastapi.Request') -> Optional[str]:
+        replica = self._select_replica(request)
+        if replica is not None:
+            logger.info(f'Selected replica {replica} '
+                        f'for request {_request_repr(request)}')
+        else:
+            logger.warning('No replica selected for request '
+                           f'{_request_repr(request)}')
+        return replica
+
     # TODO(tian): We should have an abstract class for Request to
     # compatible with all frameworks.
-    def select_replica(self, request: 'fastapi.Request') -> Optional[str]:
+    def _select_replica(self, request: 'fastapi.Request') -> Optional[str]:
         raise NotImplementedError
 
 
 class RoundRobinPolicy(LoadBalancingPolicy):
     """Round-robin load balancing policy."""
 
-    def __init__(self, *args, **kwargs) -> None:
-        super().__init__(*args, **kwargs)
+    def __init__(self) -> None:
+        super().__init__()
         self.index = 0
 
     def set_ready_replicas(self, ready_replicas: List[str]) -> None:
-        if set(ready_replicas) != set(self.ready_replicas):
-            # If the autoscaler keeps scaling up and down the replicas,
-            # we need this shuffle to not let the first replica have the
-            # most of the load.
-            random.shuffle(ready_replicas)
-            self.ready_replicas = ready_replicas
-            self.index = 0
+        if set(self.ready_replicas) == set(ready_replicas):
+            return
+        # If the autoscaler keeps scaling up and down the replicas,
+        # we need this shuffle to not let the first replica have the
+        # most of the load.
+        random.shuffle(ready_replicas)
+        self.ready_replicas = ready_replicas
+        self.index = 0
 
-    def select_replica(self, request: 'fastapi.Request') -> Optional[str]:
+    def _select_replica(self, request: 'fastapi.Request') -> Optional[str]:
+        del request  # Unused.
         if not self.ready_replicas:
             return None
         ready_replica_url = self.ready_replicas[self.index]
         self.index = (self.index + 1) % len(self.ready_replicas)
-        request_repr = ('<Request '
-                        f'method="{request.method}" '
-                        f'url="{request.url}" '
-                        f'headers={dict(request.headers)} '
-                        f'query_params={dict(request.query_params)}'
-                        '>')
-        logger.info(f'Selected replica {ready_replica_url} '
-                    f'for request {request_repr}')
         return ready_replica_url
```

### Comparing `skypilot-0.5.0/sky/serve/replica_managers.py` & `skypilot-0.6.0/sky/serve/replica_managers.py`

 * *Files 17% similar despite different names*

```diff
@@ -1,61 +1,65 @@
 """ReplicaManager: handles the creation and deletion of endpoint replicas."""
-import collections
 import dataclasses
 import enum
 import functools
 import multiprocessing
 from multiprocessing import pool as mp_pool
 import os
 import threading
 import time
 import traceback
 import typing
 from typing import Any, Dict, List, Optional, Tuple
 
+import colorama
 import psutil
 import requests
 
 import sky
 from sky import backends
+from sky import core
 from sky import exceptions
 from sky import global_user_state
 from sky import sky_logging
 from sky import status_lib
 from sky.backends import backend_utils
 from sky.serve import constants as serve_constants
 from sky.serve import serve_state
 from sky.serve import serve_utils
 from sky.serve import service
 from sky.skylet import constants
 from sky.skylet import job_lib
 from sky.usage import usage_lib
 from sky.utils import common_utils
 from sky.utils import controller_utils
+from sky.utils import env_options
 from sky.utils import ux_utils
 
 if typing.TYPE_CHECKING:
     from sky.serve import service_spec
 
 logger = sky_logging.init_logger(__name__)
 
 _JOB_STATUS_FETCH_INTERVAL = 30
 _PROCESS_POOL_REFRESH_INTERVAL = 20
 # TODO(tian): Maybe let user determine this threshold
 _CONSECUTIVE_FAILURE_THRESHOLD_TIMEOUT = 180
 _RETRY_INIT_GAP_SECONDS = 60
+_DEFAULT_DRAIN_SECONDS = 120
 
 # Since sky.launch is very resource demanding, we limit the number of
 # concurrent sky.launch process to avoid overloading the machine.
-_MAX_NUM_LAUNCH = psutil.cpu_count()
+_MAX_NUM_LAUNCH = psutil.cpu_count() * 2
 
 
 # TODO(tian): Combine this with
 # sky/spot/recovery_strategy.py::StrategyExecutor::launch
-def launch_cluster(task_yaml_path: str,
+def launch_cluster(replica_id: int,
+                   task_yaml_path: str,
                    cluster_name: str,
                    resources_override: Optional[Dict[str, Any]] = None,
                    max_retry: int = 3) -> None:
     """Launch a sky serve replica cluster.
 
     This function will not wait for the job starts running. It will return
     immediately after the job is submitted.
@@ -63,19 +67,25 @@
     Raises:
         RuntimeError: If failed to launch the cluster after max_retry retries,
             or some error happened before provisioning and will happen again
             if retry.
     """
     try:
         config = common_utils.read_yaml(os.path.expanduser(task_yaml_path))
-        if resources_override is not None:
-            resource_config = config.get('resources', {})
-            resource_config.update(resources_override)
-            config['resources'] = resource_config
         task = sky.Task.from_yaml_config(config)
+        if resources_override is not None:
+            resources = task.resources
+            overrided_resources = [
+                r.copy(**resources_override) for r in resources
+            ]
+            task.set_resources(type(resources)(overrided_resources))
+        task.update_envs({serve_constants.REPLICA_ID_ENV_VAR: str(replica_id)})
+
+        logger.info(f'Launching replica (id: {replica_id}) cluster '
+                    f'{cluster_name} with resources: {task.resources}')
     except Exception as e:  # pylint: disable=broad-except
         logger.error('Failed to construct task object from yaml file with '
                      f'error {common_utils.format_exception(e)}')
         raise RuntimeError(
             f'Failed to launch the sky serve replica cluster {cluster_name} '
             'due to failing to initialize sky.Task from yaml file.') from e
     retry_cnt = 0
@@ -122,16 +132,19 @@
         logger.info('Retrying to launch the sky serve replica cluster '
                     f'in {gap_seconds:.1f} seconds.')
         time.sleep(gap_seconds)
 
 
 # TODO(tian): Combine this with
 # sky/spot/recovery_strategy.py::terminate_cluster
-def terminate_cluster(cluster_name: str, max_retry: int = 3) -> None:
+def terminate_cluster(cluster_name: str,
+                      replica_drain_delay_seconds: int = 0,
+                      max_retry: int = 3) -> None:
     """Terminate the sky serve replica cluster."""
+    time.sleep(replica_drain_delay_seconds)
     retry_cnt = 0
     backoff = common_utils.Backoff()
     while True:
         retry_cnt += 1
         try:
             usage_lib.messages.usage.set_internal()
             sky.down(cluster_name)
@@ -161,14 +174,31 @@
     assert len(task.resources) >= 1, task
     task_resources = list(task.resources)[0]
     # Already checked the resources have and only have one port
     # before upload the task yaml.
     return task_resources.ports[0]
 
 
+def _should_use_spot(task_yaml: str,
+                     resource_override: Optional[Dict[str, Any]]) -> bool:
+    """Get whether the task should use spot."""
+    if resource_override is not None:
+        use_spot_override = resource_override.get('use_spot')
+        if use_spot_override is not None:
+            assert isinstance(use_spot_override, bool)
+            return use_spot_override
+    task = sky.Task.from_yaml(task_yaml)
+    spot_use_resources = [
+        resources for resources in task.resources if resources.use_spot
+    ]
+    # Either resources all use spot or none use spot.
+    assert len(spot_use_resources) in [0, len(task.resources)]
+    return len(spot_use_resources) == len(task.resources)
+
+
 def with_lock(func):
 
     @functools.wraps(func)
     def wrapper(self, *args, **kwargs):
         with self.lock:
             return func(self, *args, **kwargs)
 
@@ -202,55 +232,67 @@
         first_ready_time: The first time the service is ready.
         sky_down_status: Process status of sky.down.
     """
     # None means sky.launch is not called yet.
     sky_launch_status: Optional[ProcessStatus] = None
     user_app_failed: bool = False
     service_ready_now: bool = False
-    # None means readiness probe is not passed yet.
+    # None means readiness probe is not succeeded yet;
+    # -1 means the initial delay seconds is exceeded.
     first_ready_time: Optional[float] = None
     # None means sky.down is not called yet.
     sky_down_status: Optional[ProcessStatus] = None
+    # Whether the termination is caused by autoscaler's decision
+    is_scale_down: bool = False
     # The replica's spot instance was preempted.
     preempted: bool = False
 
-    def is_scale_down_succeeded(self, initial_delay_seconds: int) -> bool:
+    def remove_terminated_replica(self) -> bool:
         """Whether to remove the replica record from the replica table.
 
         If not, the replica will stay in the replica table permanently to
         notify the user that something is wrong with the user code / setup.
         """
-        if self.sky_launch_status == ProcessStatus.INTERRUPTED:
-            return True
-        if self.sky_launch_status != ProcessStatus.SUCCEEDED:
-            return False
-        if self.sky_down_status != ProcessStatus.SUCCEEDED:
+        return self.is_scale_down
+
+    def unrecoverable_failure(self) -> bool:
+        """Whether the replica fails and cannot be recovered.
+
+        Autoscaler should stop scaling if any of the replica has unrecoverable
+        failure, e.g., the user app fails before the service endpoint being
+        ready for the current version.
+        """
+        replica_status = self.to_replica_status()
+        logger.info(
+            'Check replica unrecorverable: first_ready_time '
+            f'{self.first_ready_time}, user_app_failed {self.user_app_failed}, '
+            f'status {replica_status}')
+        if replica_status not in serve_state.ReplicaStatus.terminal_statuses():
             return False
-        if (self.first_ready_time is not None and
-                time.time() - self.first_ready_time > initial_delay_seconds):
-            # If the service is up for more than `initial_delay_seconds`,
-            # we assume there is no bug in the user code and the scale down
-            # is successful, thus enabling the controller to remove the
-            # replica from the replica table and auto restart the replica.
-            # Here we assume that initial_delay_seconds is larger than
-            # consecutive_failure_threshold_seconds, so if a replica is not
-            # teardown for initial_delay_seconds, it is safe to assume that
-            # it is UP for initial_delay_seconds.
-            # For replica with a failed sky.launch, it is likely due to some
-            # misconfigured resources, so we don't want to auto restart it.
-            # For replica with a failed sky.down, we cannot restart it since
-            # otherwise we will have a resource leak.
-            return True
+        if self.first_ready_time is not None:
+            if self.first_ready_time >= 0:
+                # If the service is ever up, we assume there is no bug in the
+                # user code and the scale down is successful, thus enabling the
+                # controller to remove the replica from the replica table and
+                # auto restart the replica.
+                # For replica with a failed sky.launch, it is likely due to some
+                # misconfigured resources, so we don't want to auto restart it.
+                # For replica with a failed sky.down, we cannot restart it since
+                # otherwise we will have a resource leak.
+                return False
+            else:
+                # If the initial delay exceeded, it is likely the service is not
+                # recoverable.
+                return True
         if self.user_app_failed:
-            return False
-        if self.preempted:
             return True
-        if not self.service_ready_now:
-            return False
-        return self.first_ready_time is not None
+        # TODO(zhwu): launch failures not related to resource unavailability
+        # should be considered as unrecoverable failure. (refer to
+        # `spot.recovery_strategy.StrategyExecutor::_launch`)
+        return False
 
     def should_track_service_status(self) -> bool:
         """Should we track the status of the replica.
 
         This includes:
             (1) Job status;
             (2) Readiness probe.
@@ -267,16 +309,25 @@
 
     def to_replica_status(self) -> serve_state.ReplicaStatus:
         """Convert status property to human-readable replica status."""
         if self.sky_launch_status is None:
             # Pending to launch
             return serve_state.ReplicaStatus.PENDING
         if self.sky_launch_status == ProcessStatus.RUNNING:
+            if self.sky_down_status == ProcessStatus.FAILED:
+                return serve_state.ReplicaStatus.FAILED_CLEANUP
+            if self.sky_down_status == ProcessStatus.SUCCEEDED:
+                # This indicate it is a scale_down with correct teardown.
+                # Should have been cleaned from the replica table.
+                return serve_state.ReplicaStatus.UNKNOWN
             # Still launching
             return serve_state.ReplicaStatus.PROVISIONING
+        if self.sky_launch_status == ProcessStatus.INTERRUPTED:
+            # sky.down is running and a scale down interrupted sky.launch
+            return serve_state.ReplicaStatus.SHUTTING_DOWN
         if self.sky_down_status is not None:
             if self.preempted:
                 # Replica (spot) is preempted
                 return serve_state.ReplicaStatus.PREEMPTED
             if self.sky_down_status == ProcessStatus.RUNNING:
                 # sky.down is running
                 return serve_state.ReplicaStatus.SHUTTING_DOWN
@@ -284,23 +335,27 @@
                 return serve_state.ReplicaStatus.SHUTTING_DOWN
             if self.sky_down_status == ProcessStatus.FAILED:
                 # sky.down failed
                 return serve_state.ReplicaStatus.FAILED_CLEANUP
             if self.user_app_failed:
                 # Failed on user setup/run
                 return serve_state.ReplicaStatus.FAILED
+            if self.sky_launch_status == ProcessStatus.FAILED:
+                # sky.launch failed
+                return serve_state.ReplicaStatus.FAILED_PROVISION
             if self.first_ready_time is None:
+                # readiness probe is not executed yet, but a scale down is
+                # triggered.
+                return serve_state.ReplicaStatus.SHUTTING_DOWN
+            if self.first_ready_time == -1:
                 # initial delay seconds exceeded
-                return serve_state.ReplicaStatus.FAILED
+                return serve_state.ReplicaStatus.FAILED_INITIAL_DELAY
             if not self.service_ready_now:
                 # Max continuous failure exceeded
-                return serve_state.ReplicaStatus.FAILED
-            if self.sky_launch_status == ProcessStatus.FAILED:
-                # sky.launch failed
-                return serve_state.ReplicaStatus.FAILED
+                return serve_state.ReplicaStatus.FAILED_PROBING
             # This indicate it is a scale_down with correct teardown.
             # Should have been cleaned from the replica table.
             return serve_state.ReplicaStatus.UNKNOWN
         if self.sky_launch_status == ProcessStatus.FAILED:
             # sky.launch failed
             # The down process has not been started if it reaches here,
             # due to the `if self.sky_down_status is not None`` check above.
@@ -312,34 +367,38 @@
         if self.user_app_failed:
             # Failed on user setup/run
             # Same as above, the down process should have been started.
             return serve_state.ReplicaStatus.FAILED_CLEANUP
         if self.service_ready_now:
             # Service is ready
             return serve_state.ReplicaStatus.READY
-        if self.first_ready_time is not None:
+        if self.first_ready_time is not None and self.first_ready_time >= 0.0:
             # Service was ready before but not now
             return serve_state.ReplicaStatus.NOT_READY
         else:
             # No readiness probe passed and sky.launch finished
             return serve_state.ReplicaStatus.STARTING
 
 
 class ReplicaInfo:
     """Replica info for each replica."""
 
+    _VERSION = 0
+
     def __init__(self, replica_id: int, cluster_name: str, replica_port: str,
-                 version: int) -> None:
+                 is_spot: bool, version: int) -> None:
+        self._version = self._VERSION
         self.replica_id: int = replica_id
         self.cluster_name: str = cluster_name
         self.version: int = version
         self.replica_port: str = replica_port
         self.first_not_ready_time: Optional[float] = None
         self.consecutive_failure_times: List[float] = []
         self.status_property: ReplicaStatusProperty = ReplicaStatusProperty()
+        self.is_spot: bool = is_spot
 
     def handle(
         self,
         cluster_record: Optional[Dict[str, Any]] = None
     ) -> Optional[backends.CloudVmRayResourceHandle]:
         """Get the handle of the cluster.
 
@@ -354,27 +413,40 @@
         if cluster_record is None:
             return None
         handle = cluster_record['handle']
         assert isinstance(handle, backends.CloudVmRayResourceHandle)
         return handle
 
     @property
-    def is_launched(self) -> bool:
-        return self.status in serve_state.ReplicaStatus.launched_statuses()
+    def is_terminal(self) -> bool:
+        return self.status in serve_state.ReplicaStatus.terminal_statuses()
 
     @property
     def is_ready(self) -> bool:
         return self.status == serve_state.ReplicaStatus.READY
 
     @property
     def url(self) -> Optional[str]:
         handle = self.handle()
         if handle is None:
             return None
-        return f'{handle.head_ip}:{self.replica_port}'
+        replica_port_int = int(self.replica_port)
+        try:
+            endpoint_dict = core.endpoints(handle.cluster_name,
+                                           replica_port_int)
+        except exceptions.ClusterNotUpError:
+            return None
+        endpoint = endpoint_dict.get(replica_port_int, None)
+        if not endpoint:
+            return None
+        assert isinstance(endpoint, str), endpoint
+        # If replica doesn't start with http or https, add http://
+        if not endpoint.startswith('http'):
+            endpoint = 'http://' + endpoint
+        return endpoint
 
     @property
     def status(self) -> serve_state.ReplicaStatus:
         replica_status = self.status_property.to_replica_status()
         if replica_status == serve_state.ReplicaStatus.UNKNOWN:
             logger.error('Detecting UNKNOWN replica status for '
                          f'replica {self.replica_id}.')
@@ -384,105 +456,155 @@
         cluster_record = global_user_state.get_cluster_from_name(
             self.cluster_name)
         info_dict = {
             'replica_id': self.replica_id,
             'name': self.cluster_name,
             'status': self.status,
             'version': self.version,
+            'endpoint': self.url,
+            'is_spot': self.is_spot,
             'launched_at': (cluster_record['launched_at']
                             if cluster_record is not None else None),
         }
         if with_handle:
             info_dict['handle'] = self.handle(cluster_record)
         return info_dict
 
+    def __repr__(self) -> str:
+        info_dict = self.to_info_dict(
+            with_handle=env_options.Options.SHOW_DEBUG_INFO.get())
+        handle_str = ''
+        if 'handle' in info_dict:
+            handle_str = f', handle={info_dict["handle"]}'
+        info = (f'ReplicaInfo(replica_id={self.replica_id}, '
+                f'cluster_name={self.cluster_name}, '
+                f'version={self.version}, '
+                f'replica_port={self.replica_port}, '
+                f'is_spot={self.is_spot}, '
+                f'status={self.status}, '
+                f'launched_at={info_dict["launched_at"]}{handle_str})')
+        return info
+
     def probe(
         self,
         readiness_path: str,
         post_data: Optional[Dict[str, Any]],
+        headers: Optional[Dict[str, str]],
     ) -> Tuple['ReplicaInfo', bool, float]:
         """Probe the readiness of the replica.
 
         Returns:
             Tuple of (self, is_ready, probe_time).
         """
         replica_identity = f'replica {self.replica_id} with url {self.url}'
         # TODO(tian): This requiring the clock on each replica to be aligned,
         # which may not be true when the GCP VMs have run for a long time. We
         # should have a better way to do this. See #2539 for more information.
         probe_time = time.time()
         try:
             msg = ''
             # TODO(tian): Support HTTPS in the future.
-            readiness_path = (f'http://{self.url}{readiness_path}')
+            url = self.url
+            if url is None:
+                logger.info(f'Error when probing {replica_identity}: '
+                            'Cannot get the endpoint.')
+                return self, False, probe_time
+            readiness_path = (f'{url}{readiness_path}')
+            logger.info(f'Probing {replica_identity} with {readiness_path}.')
             if post_data is not None:
                 msg += 'POST'
                 response = requests.post(
                     readiness_path,
+                    headers=headers,
                     json=post_data,
                     timeout=serve_constants.READINESS_PROBE_TIMEOUT_SECONDS)
             else:
                 msg += 'GET'
                 response = requests.get(
                     readiness_path,
+                    headers=headers,
                     timeout=serve_constants.READINESS_PROBE_TIMEOUT_SECONDS)
             msg += (f' request to {replica_identity} returned status '
                     f'code {response.status_code}')
             if response.status_code == 200:
                 msg += '.'
+                log_method = logger.info
             else:
                 msg += f' and response {response.text}.'
-            logger.info(msg)
+                msg = f'{colorama.Fore.YELLOW}{msg}{colorama.Style.RESET_ALL}'
+                log_method = logger.error
+            log_method(msg)
             if response.status_code == 200:
                 logger.debug(f'{replica_identity.capitalize()} is ready.')
                 return self, True, probe_time
         except requests.exceptions.RequestException as e:
-            logger.info(f'Error when probing {replica_identity}: '
-                        f'{common_utils.format_exception(e)}.')
+            logger.error(
+                f'{colorama.Fore.YELLOW}Error when probing {replica_identity}:'
+                f' {common_utils.format_exception(e)}.'
+                f'{colorama.Style.RESET_ALL}')
         return self, False, probe_time
 
+    def __setstate__(self, state):
+        """Set state from pickled state, for backward compatibility."""
+        version = state.pop('_version', None)
+        # Handle old version(s) here.
+        if version is None:
+            version = -1
+
+        if version < 0:
+            # It will be handled with RequestRateAutoscaler.
+            # Treated similar to on-demand instances.
+            self.is_spot = False
+
+        self.__dict__.update(state)
+
 
 class ReplicaManager:
     """Each replica manager monitors one service."""
 
     def __init__(self, service_name: str,
                  spec: 'service_spec.SkyServiceSpec') -> None:
         self.lock = threading.Lock()
         self._next_replica_id: int = 1
         self._service_name: str = service_name
         self._uptime: Optional[float] = None
+        self._update_mode = serve_utils.DEFAULT_UPDATE_MODE
+        header_keys = None
+        if spec.readiness_headers is not None:
+            header_keys = list(spec.readiness_headers.keys())
         logger.info(f'Readiness probe path: {spec.readiness_path}\n'
                     f'Initial delay seconds: {spec.initial_delay_seconds}\n'
-                    f'Post data: {spec.post_data}')
+                    f'Post data: {spec.post_data}\n'
+                    f'Readiness header keys: {header_keys}')
 
         # Newest version among the currently provisioned and launched replicas
         self.latest_version: int = serve_constants.INITIAL_VERSION
         # Oldest version among the currently provisioned and launched replicas
         self.least_recent_version: int = serve_constants.INITIAL_VERSION
         serve_state.add_or_update_version(self._service_name,
                                           self.latest_version, spec)
 
-    def get_ready_replica_urls(self) -> List[str]:
-        """Get all ready replica's IP addresses."""
-        raise NotImplementedError
-
     def scale_up(self,
                  resources_override: Optional[Dict[str, Any]] = None) -> None:
         """Scale up the service by 1 replica with resources_override.
         resources_override is of the same format with resources section
         in skypilot task yaml
         """
         raise NotImplementedError
 
     def scale_down(self, replica_id: int) -> None:
         """Scale down replica with replica_id."""
         raise NotImplementedError
 
-    def update_version(self, version: int,
-                       spec: 'service_spec.SkyServiceSpec') -> None:
+    def update_version(self, version: int, spec: 'service_spec.SkyServiceSpec',
+                       update_mode: serve_utils.UpdateMode) -> None:
+        raise NotImplementedError
+
+    def get_active_replica_urls(self) -> List[str]:
+        """Get the urls of the active replicas."""
         raise NotImplementedError
 
 
 class SkyPilotReplicaManager(ReplicaManager):
     """Replica Manager for SkyPilot clusters.
 
     It will run three daemon to monitor the status of the replicas:
@@ -513,82 +635,71 @@
         threading.Thread(target=self._job_status_fetcher).start()
         threading.Thread(target=self._replica_prober).start()
 
     ################################
     # Replica management functions #
     ################################
 
-    def get_ready_replica_urls(self) -> List[str]:
-        ready_replica_urls = []
-        version2url = collections.defaultdict(list)
-        for info in serve_state.get_replica_infos(self._service_name):
-            if info.status == serve_state.ReplicaStatus.READY:
-                assert info.url is not None
-                version2url[info.version].append(info.url)
-                ready_replica_urls.append(info.url)
-        # Try all version in descending order. There is possibility that
-        # user consecutively update the service several times, and some
-        # version might not have any ready replicas.
-        version = self.latest_version
-        while version >= serve_constants.INITIAL_VERSION:
-            if version in version2url:
-                return version2url[version]
-            version -= 1
-        return []
-
     def _launch_replica(
         self,
         replica_id: int,
         resources_override: Optional[Dict[str, Any]] = None,
     ) -> None:
-
         if replica_id in self._launch_process_pool:
             logger.warning(f'Launch process for replica {replica_id} '
                            'already exists. Skipping.')
             return
         logger.info(f'Launching replica {replica_id}...')
         cluster_name = serve_utils.generate_replica_cluster_name(
             self._service_name, replica_id)
         log_file_name = serve_utils.generate_replica_launch_log_file_name(
             self._service_name, replica_id)
         p = multiprocessing.Process(
             target=ux_utils.RedirectOutputForProcess(
                 launch_cluster,
                 log_file_name,
             ).run,
-            args=(self._task_yaml_path, cluster_name, resources_override),
+            args=(replica_id, self._task_yaml_path, cluster_name,
+                  resources_override),
         )
         replica_port = _get_resources_ports(self._task_yaml_path)
+        use_spot = _should_use_spot(self._task_yaml_path, resources_override)
 
-        info = ReplicaInfo(replica_id, cluster_name, replica_port,
+        info = ReplicaInfo(replica_id, cluster_name, replica_port, use_spot,
                            self.latest_version)
         serve_state.add_or_update_replica(self._service_name, replica_id, info)
         # Don't start right now; we will start it later in _refresh_process_pool
         # to avoid too many sky.launch running at the same time.
         self._launch_process_pool[replica_id] = p
 
     def scale_up(self,
                  resources_override: Optional[Dict[str, Any]] = None) -> None:
         self._launch_replica(self._next_replica_id, resources_override)
         self._next_replica_id += 1
 
-    def _terminate_replica(self, replica_id: int, sync_down_logs: bool) -> None:
+    def _terminate_replica(self,
+                           replica_id: int,
+                           sync_down_logs: bool,
+                           replica_drain_delay_seconds: int,
+                           is_scale_down: bool = False) -> None:
 
         if replica_id in self._launch_process_pool:
+            info = serve_state.get_replica_info_from_id(self._service_name,
+                                                        replica_id)
+            assert info is not None
+            info.status_property.sky_launch_status = ProcessStatus.INTERRUPTED
+            serve_state.add_or_update_replica(self._service_name, replica_id,
+                                              info)
             launch_process = self._launch_process_pool[replica_id]
             if launch_process.is_alive():
                 assert launch_process.pid is not None
                 launch_process.terminate()
                 launch_process.join()
             logger.info(f'Interrupted launch process for replica {replica_id} '
                         'and deleted the cluster.')
-            info = serve_state.get_replica_info_from_id(self._service_name,
-                                                        replica_id)
-            assert info is not None
-            info.status_property.sky_launch_status = ProcessStatus.INTERRUPTED
             del self._launch_process_pool[replica_id]
 
         if replica_id in self._down_process_pool:
             logger.warning(f'Terminate process for replica {replica_id} '
                            'already exists. Skipping.')
             return
 
@@ -645,33 +756,71 @@
             _download_and_stream_logs(info)
 
         logger.info(f'preempted: {info.status_property.preempted}, '
                     f'replica_id: {replica_id}')
         p = multiprocessing.Process(
             target=ux_utils.RedirectOutputForProcess(terminate_cluster,
                                                      log_file_name, 'a').run,
-            args=(info.cluster_name,),
+            args=(info.cluster_name, replica_drain_delay_seconds),
         )
         info.status_property.sky_down_status = ProcessStatus.RUNNING
+        info.status_property.is_scale_down = is_scale_down
         serve_state.add_or_update_replica(self._service_name, replica_id, info)
         p.start()
         self._down_process_pool[replica_id] = p
 
     def scale_down(self, replica_id: int) -> None:
-        self._terminate_replica(replica_id, sync_down_logs=False)
+        self._terminate_replica(
+            replica_id,
+            sync_down_logs=False,
+            replica_drain_delay_seconds=_DEFAULT_DRAIN_SECONDS,
+            is_scale_down=True)
 
-    def _handle_preemption(self, replica_id: int) -> None:
-        logger.info(f'Beginning handle for preempted replica {replica_id}.')
-        # TODO(MaoZiming): Support spot recovery policies
-        info = serve_state.get_replica_info_from_id(self._service_name,
-                                                    replica_id)
-        assert info is not None
+    def _handle_preemption(self, info: ReplicaInfo) -> bool:
+        """Handle preemption of the replica if any error happened.
+
+        Returns:
+            bool: Whether the replica is preempted.
+        """
+        if not info.is_spot:
+            return False
+
+        # Get cluster handle first for zone information. The following
+        # backend_utils.refresh_cluster_status_handle might delete the
+        # cluster record from the cluster table.
+        handle = global_user_state.get_handle_from_cluster_name(
+            info.cluster_name)
+        if handle is None:
+            logger.error(f'Cannot find cluster {info.cluster_name} for '
+                         f'replica {info.replica_id} in the cluster table. '
+                         'Skipping preemption handling.')
+            return False
+        assert isinstance(handle, backends.CloudVmRayResourceHandle)
+        # Pull the actual cluster status from the cloud provider to
+        # determine whether the cluster is preempted.
+        cluster_status, _ = backend_utils.refresh_cluster_status_handle(
+            info.cluster_name,
+            force_refresh_statuses=set(status_lib.ClusterStatus))
+
+        if cluster_status == status_lib.ClusterStatus.UP:
+            return False
+        # The cluster is (partially) preempted. It can be down, INIT or STOPPED,
+        # based on the interruption behavior of the cloud.
+        cluster_status_str = ('' if cluster_status is None else
+                              f' (status: {cluster_status.value})')
+        logger.info(
+            f'Replica {info.replica_id} is preempted{cluster_status_str}.')
         info.status_property.preempted = True
-        serve_state.add_or_update_replica(self._service_name, replica_id, info)
-        self._terminate_replica(replica_id, sync_down_logs=False)
+        serve_state.add_or_update_replica(self._service_name, info.replica_id,
+                                          info)
+        self._terminate_replica(info.replica_id,
+                                sync_down_logs=False,
+                                replica_drain_delay_seconds=0,
+                                is_scale_down=True)
+        return True
 
     #################################
     # ReplicaManager Daemon Threads #
     #################################
 
     @with_lock
     def _refresh_process_pool(self) -> None:
@@ -703,28 +852,30 @@
                     # when we enable user choose whether to retry or not.
                     logger.info(
                         f'Launch process for replica {replica_id} finished.')
                     del self._launch_process_pool[replica_id]
                     if p.exitcode != 0:
                         logger.warning(
                             f'Launch process for replica {replica_id} '
-                            f'exited abnormally with code {p.exitcode}. '
-                            'Terminating...')
+                            f'exited abnormally with code {p.exitcode}.'
+                            ' Terminating...')
                         info.status_property.sky_launch_status = (
                             ProcessStatus.FAILED)
                         error_in_sky_launch = True
                     else:
                         info.status_property.sky_launch_status = (
                             ProcessStatus.SUCCEEDED)
                 serve_state.add_or_update_replica(self._service_name,
                                                   replica_id, info)
                 if error_in_sky_launch:
                     # Teardown after update replica info since
                     # _terminate_replica will update the replica info too.
-                    self._terminate_replica(replica_id, sync_down_logs=True)
+                    self._terminate_replica(replica_id,
+                                            sync_down_logs=True,
+                                            replica_drain_delay_seconds=0)
         for replica_id, p in list(self._down_process_pool.items()):
             if not p.is_alive():
                 logger.info(
                     f'Terminate process for replica {replica_id} finished.')
                 del self._down_process_pool[replica_id]
                 info = serve_state.get_replica_info_from_id(
                     self._service_name, replica_id)
@@ -745,20 +896,18 @@
                 # assume it is just some random failure and we should restart
                 # the replica. Please refer to the implementation of
                 # `is_scale_down_succeeded` for more details.
                 # TODO(tian): Currently, restart replicas that failed within
                 # initial_delay_seconds is not supported. We should add it
                 # later when we support `sky serve update`.
                 removal_reason = None
-                if info.status_property.is_scale_down_succeeded(
-                        self._get_initial_delay_seconds(info.version)):
-                    # This means the cluster is deleted due to
-                    # a scale down or the cluster is recovering
-                    # from preemption. Delete the replica info
-                    # so it won't count as a replica.
+                if info.status_property.is_scale_down:
+                    # This means the cluster is deleted due to an autoscaler
+                    # decision or the cluster is recovering from preemption.
+                    # Delete the replica info so it won't count as a replica.
                     if info.status_property.preempted:
                         removal_reason = 'for preemption recovery'
                     else:
                         removal_reason = 'normally'
                 # Don't keep failed record for version mismatch replicas,
                 # since user should fixed the error before update.
                 elif info.version != self.latest_version:
@@ -824,28 +973,39 @@
                 continue
             # We use backend API to avoid usage collection in the
             # core.job_status.
             backend = backends.CloudVmRayBackend()
             handle = info.handle()
             assert handle is not None, info
             # Use None to fetch latest job, which stands for user task job
-            job_statuses = backend.get_job_status(handle,
-                                                  None,
-                                                  stream_logs=False)
+            try:
+                job_statuses = backend.get_job_status(handle,
+                                                      None,
+                                                      stream_logs=False)
+            except exceptions.CommandError:
+                # If the job status fetch failed, it is likely that the
+                # cluster is preempted.
+                is_preempted = self._handle_preemption(info)
+                if is_preempted:
+                    continue
+                # Re-raise the exception if it is not preempted.
+                raise
             job_status = list(job_statuses.values())[0]
             if job_status in [
                     job_lib.JobStatus.FAILED, job_lib.JobStatus.FAILED_SETUP
             ]:
                 info.status_property.user_app_failed = True
                 serve_state.add_or_update_replica(self._service_name,
                                                   info.replica_id, info)
                 logger.warning(
                     f'Service job for replica {info.replica_id} FAILED. '
                     'Terminating...')
-                self._terminate_replica(info.replica_id, sync_down_logs=True)
+                self._terminate_replica(info.replica_id,
+                                        sync_down_logs=True,
+                                        replica_drain_delay_seconds=0)
 
     def _job_status_fetcher(self) -> None:
         """Periodically fetch the service job status of all replicas."""
         while True:
             logger.debug('Refreshing job status.')
             try:
                 self._fetch_job_status()
@@ -876,16 +1036,19 @@
                 if not info.status_property.should_track_service_status():
                     continue
                 replica_to_probe.append(
                     f'replica_{info.replica_id}(url={info.url})')
                 probe_futures.append(
                     pool.apply_async(
                         info.probe,
-                        (self._get_readiness_path(
-                            info.version), self._get_post_data(info.version)),
+                        (
+                            self._get_readiness_path(info.version),
+                            self._get_post_data(info.version),
+                            self._get_readiness_headers(info.version),
+                        ),
                     ),)
             logger.info(f'Replicas to probe: {", ".join(replica_to_probe)}')
 
             # Since futures.as_completed will return futures in the order of
             # completion, we need the info.probe function to return the info
             # object as well, so that we could update the info object in the
             # same order.
@@ -902,44 +1065,19 @@
                             f'replica. Setting uptime to {self._uptime}.')
                         serve_state.set_service_uptime(self._service_name,
                                                        int(self._uptime))
                     info.consecutive_failure_times.clear()
                     if info.status_property.first_ready_time is None:
                         info.status_property.first_ready_time = probe_time
                 else:
-                    handle = info.handle()
-                    if handle is None:
-                        logger.error('Cannot find handle for '
-                                     f'replica {info.replica_id}.')
-                    elif handle.launched_resources is None:
-                        logger.error('Cannot find launched_resources in '
-                                     f'handle for replica {info.replica_id}.')
-                    elif handle.launched_resources.use_spot:
-                        # Pull the actual cluster status
-                        # from the cloud provider to
-                        # determine whether the cluster is preempted.
-                        (cluster_status,
-                         _) = backend_utils.refresh_cluster_status_handle(
-                             info.cluster_name,
-                             force_refresh_statuses=set(
-                                 status_lib.ClusterStatus))
-
-                        if cluster_status != status_lib.ClusterStatus.UP:
-                            # The cluster is (partially) preempted.
-                            # It can be down, INIT or STOPPED, based on the
-                            # interruption behavior of the cloud.
-                            # Spot recovery is needed.
-                            cluster_status_str = (
-                                '' if cluster_status is None else
-                                f' (status: {cluster_status.value})')
-                            logger.info(f'Replica {info.replica_id} '
-                                        f'is preempted{cluster_status_str}.')
-                            self._handle_preemption(info.replica_id)
-
-                            continue
+                    # TODO(tian): This might take a lot of time. Shouldn't
+                    # blocking probe to other replicas.
+                    is_preempted = self._handle_preemption(info)
+                    if is_preempted:
+                        continue
 
                     if info.first_not_ready_time is None:
                         info.first_not_ready_time = probe_time
                     if info.status_property.first_ready_time is not None:
                         info.consecutive_failure_times.append(probe_time)
                         consecutive_failure_time = (
                             info.consecutive_failure_times[-1] -
@@ -965,72 +1103,130 @@
                                                  info.first_not_ready_time)
                         if current_delay_seconds > initial_delay_seconds:
                             logger.info(
                                 f'Replica {info.replica_id} is not ready and '
                                 'exceeding initial delay seconds. Terminating '
                                 'the replica...')
                             should_teardown = True
+                            info.status_property.first_ready_time = -1.0
                         else:
                             current_delay_seconds = int(current_delay_seconds)
                             logger.info(f'Replica {info.replica_id} is not '
                                         'ready but within initial delay '
                                         f'seconds ({current_delay_seconds}s '
                                         f'/ {initial_delay_seconds}s). '
                                         'Skipping.')
                 serve_state.add_or_update_replica(self._service_name,
                                                   info.replica_id, info)
                 if should_teardown:
                     self._terminate_replica(info.replica_id,
-                                            sync_down_logs=True)
+                                            sync_down_logs=True,
+                                            replica_drain_delay_seconds=0)
 
     def _replica_prober(self) -> None:
         """Periodically probe replicas."""
         while True:
             logger.debug('Running replica prober.')
             try:
                 self._probe_all_replicas()
-                replica_statuses = [
-                    info.status for info in serve_state.get_replica_infos(
-                        self._service_name)
-                ]
-                serve_utils.set_service_status_from_replica_statuses(
-                    self._service_name, replica_statuses)
+                replica_infos = serve_state.get_replica_infos(
+                    self._service_name)
+                # TODO(zhwu): when there are multiple load balancers, we need
+                # to make sure the active_versions are the union of all
+                # versions of all load balancers.
+                serve_utils.set_service_status_and_active_versions_from_replica(
+                    self._service_name, replica_infos, self._update_mode)
 
             except Exception as e:  # pylint: disable=broad-except
                 # No matter what error happens, we should keep the
                 # replica prober running.
                 logger.error('Error in replica prober: '
                              f'{common_utils.format_exception(e)}')
                 with ux_utils.enable_traceback():
                     logger.error(f'  Traceback: {traceback.format_exc()}')
+            # TODO(MaoZiming): Probe cloud for early preemption warning.
             time.sleep(serve_constants.ENDPOINT_PROBE_INTERVAL_SECONDS)
 
+    def get_active_replica_urls(self) -> List[str]:
+        """Get the urls of all active replicas."""
+        record = serve_state.get_service_from_name(self._service_name)
+        assert record is not None, (f'{self._service_name} not found on '
+                                    'controller records.')
+        ready_replica_urls = []
+        active_versions = set(record['active_versions'])
+        for info in serve_state.get_replica_infos(self._service_name):
+            if (info.status == serve_state.ReplicaStatus.READY and
+                    info.version in active_versions):
+                assert info.url is not None, info
+                ready_replica_urls.append(info.url)
+        return ready_replica_urls
+
     ###########################################
     # SkyServe Update and replica versioning. #
     ###########################################
 
-    def update_version(self, version: int,
-                       spec: 'service_spec.SkyServiceSpec') -> None:
+    def update_version(self, version: int, spec: 'service_spec.SkyServiceSpec',
+                       update_mode: serve_utils.UpdateMode) -> None:
         if version <= self.latest_version:
             logger.error(f'Invalid version: {version}, '
                          f'latest version: {self.latest_version}')
             return
         task_yaml_path = serve_utils.generate_task_yaml_file_name(
             self._service_name, version)
         serve_state.add_or_update_version(self._service_name, version, spec)
         self.latest_version = version
         self._task_yaml_path = task_yaml_path
+        self._update_mode = update_mode
+
+        # Reuse all replicas that have the same config as the new version
+        # (except for the `service` field) by directly setting the version to be
+        # the latest version. This can significantly improve the speed
+        # for updating an existing service with only config changes to the
+        # service specs, e.g. scale down the service.
+        new_config = common_utils.read_yaml(os.path.expanduser(task_yaml_path))
+        # Always create new replicas and scale down old ones when file_mounts
+        # are not empty.
+        if new_config.get('file_mounts', None) != {}:
+            return
+        for key in ['service']:
+            new_config.pop(key)
+        replica_infos = serve_state.get_replica_infos(self._service_name)
+        for info in replica_infos:
+            if info.version < version and not info.is_terminal:
+                # Assume user does not change the yaml file on the controller.
+                old_task_yaml_path = serve_utils.generate_task_yaml_file_name(
+                    self._service_name, info.version)
+                old_config = common_utils.read_yaml(
+                    os.path.expanduser(old_task_yaml_path))
+                for key in ['service']:
+                    old_config.pop(key)
+                # Bump replica version if all fields except for service are
+                # the same. File mounts should both be empty, as update always
+                # create new buckets if they are not empty.
+                if (old_config == new_config and
+                        old_config.get('file_mounts', None) == {}):
+                    logger.info(
+                        f'Updating replica {info.replica_id} to version '
+                        f'{version}. Replica {info.replica_id}\'s config '
+                        f'{old_config} is the same as '
+                        f'latest version\'s {new_config}.')
+                    info.version = version
+                    serve_state.add_or_update_replica(self._service_name,
+                                                      info.replica_id, info)
 
     def _get_version_spec(self, version: int) -> 'service_spec.SkyServiceSpec':
         spec = serve_state.get_spec(self._service_name, version)
         if spec is None:
             raise ValueError(f'Version {version} not found.')
         return spec
 
     def _get_readiness_path(self, version: int) -> str:
         return self._get_version_spec(version).readiness_path
 
     def _get_post_data(self, version: int) -> Optional[Dict[str, Any]]:
         return self._get_version_spec(version).post_data
 
+    def _get_readiness_headers(self, version: int) -> Optional[Dict[str, str]]:
+        return self._get_version_spec(version).readiness_headers
+
     def _get_initial_delay_seconds(self, version: int) -> int:
         return self._get_version_spec(version).initial_delay_seconds
```

### Comparing `skypilot-0.5.0/sky/serve/serve_state.py` & `skypilot-0.6.0/sky/serve/serve_state.py`

 * *Files 17% similar despite different names*

```diff
@@ -1,23 +1,23 @@
 """The database for services information."""
 import collections
 import enum
+import json
 import pathlib
 import pickle
 import sqlite3
 import typing
-from typing import Any, Dict, List, Optional
+from typing import Any, Dict, List, Optional, Tuple
 
 import colorama
 
 from sky.serve import constants
 from sky.utils import db_utils
 
 if typing.TYPE_CHECKING:
-    import sky
     from sky.serve import replica_managers
     from sky.serve import service_spec
 
 _DB_PATH = pathlib.Path(constants.SKYSERVE_METADATA_DIR) / 'services.db'
 _DB_PATH = _DB_PATH.expanduser().absolute()
 _DB_PATH.parents[0].mkdir(parents=True, exist_ok=True)
 _DB_PATH = str(_DB_PATH)
@@ -53,17 +53,25 @@
     conn.commit()
 
 
 _DB = db_utils.SQLiteConn(_DB_PATH, create_table)
 # Backward compatibility.
 db_utils.add_column_to_table(_DB.cursor, _DB.conn, 'services',
                              'requested_resources_str', 'TEXT')
+# Deprecated: switched to `active_versions` below for the version considered
+# active by the load balancer. The authscaler/replica_manager version can be
+# found in the version_specs table.
 db_utils.add_column_to_table(_DB.cursor, _DB.conn, 'services',
                              'current_version',
                              f'INTEGER DEFAULT {constants.INITIAL_VERSION}')
+# The versions that is activated for the service. This is a list of integers in
+# json format.
+db_utils.add_column_to_table(_DB.cursor, _DB.conn, 'services',
+                             'active_versions',
+                             f'TEXT DEFAULT {json.dumps([])!r}')
 _UNIQUE_CONSTRAINT_FAILED_ERROR_MSG = 'UNIQUE constraint failed: services.name'
 
 
 # === Statuses ===
 class ReplicaStatus(enum.Enum):
     """Replica status."""
 
@@ -86,55 +94,74 @@
     # The service was ready before, but it becomes not ready now, i.e. the
     # readiness probe fails.
     NOT_READY = 'NOT_READY'
 
     # The replica VM is being shut down. i.e., the `sky down` is still running.
     SHUTTING_DOWN = 'SHUTTING_DOWN'
 
-    # The replica VM is once failed and has been deleted.
+    # The replica fails due to user's run/setup.
     FAILED = 'FAILED'
 
+    # The replica fails due to initial delay exceeded.
+    FAILED_INITIAL_DELAY = 'FAILED_INITIAL_DELAY'
+
+    # The replica fails due to healthiness check.
+    FAILED_PROBING = 'FAILED_PROBING'
+
+    # The replica fails during launching
+    FAILED_PROVISION = 'FAILED_PROVISION'
+
     # `sky.down` failed during service teardown.
     # This could mean resource leakage.
     # TODO(tian): This status should be removed in the future, at which point
     # we should guarantee no resource leakage like regular sky.
     FAILED_CLEANUP = 'FAILED_CLEANUP'
 
     # The replica is a spot VM and it is preempted by the cloud provider.
     PREEMPTED = 'PREEMPTED'
 
     # Unknown. This should never happen (used only for unexpected errors).
     UNKNOWN = 'UNKNOWN'
 
     @classmethod
     def failed_statuses(cls) -> List['ReplicaStatus']:
-        return [cls.FAILED, cls.FAILED_CLEANUP, cls.UNKNOWN]
+        return [
+            cls.FAILED, cls.FAILED_CLEANUP, cls.FAILED_INITIAL_DELAY,
+            cls.FAILED_PROBING, cls.FAILED_PROVISION, cls.UNKNOWN
+        ]
 
     @classmethod
-    def launched_statuses(cls) -> List['ReplicaStatus']:
-        return [cls.PENDING, cls.PROVISIONING, cls.STARTING, cls.READY]
+    def terminal_statuses(cls) -> List['ReplicaStatus']:
+        return [cls.SHUTTING_DOWN, cls.PREEMPTED, cls.UNKNOWN
+               ] + cls.failed_statuses()
 
     @classmethod
     def scale_down_decision_order(cls) -> List['ReplicaStatus']:
         # Scale down replicas in the order of replica initialization
-        return [cls.PENDING, cls.PROVISIONING, cls.STARTING, cls.READY]
+        return [
+            cls.PENDING, cls.PROVISIONING, cls.STARTING, cls.NOT_READY,
+            cls.READY
+        ]
 
     def colored_str(self) -> str:
         color = _REPLICA_STATUS_TO_COLOR[self]
         return f'{color}{self.value}{colorama.Style.RESET_ALL}'
 
 
 _REPLICA_STATUS_TO_COLOR = {
     ReplicaStatus.PENDING: colorama.Fore.YELLOW,
     ReplicaStatus.PROVISIONING: colorama.Fore.BLUE,
     ReplicaStatus.STARTING: colorama.Fore.CYAN,
     ReplicaStatus.READY: colorama.Fore.GREEN,
     ReplicaStatus.NOT_READY: colorama.Fore.YELLOW,
     ReplicaStatus.SHUTTING_DOWN: colorama.Fore.MAGENTA,
     ReplicaStatus.FAILED: colorama.Fore.RED,
+    ReplicaStatus.FAILED_INITIAL_DELAY: colorama.Fore.RED,
+    ReplicaStatus.FAILED_PROBING: colorama.Fore.RED,
+    ReplicaStatus.FAILED_PROVISION: colorama.Fore.RED,
     ReplicaStatus.FAILED_CLEANUP: colorama.Fore.RED,
     ReplicaStatus.PREEMPTED: colorama.Fore.MAGENTA,
     ReplicaStatus.UNKNOWN: colorama.Fore.RED,
 }
 
 
 class ServiceStatus(enum.Enum):
@@ -201,269 +228,300 @@
     ServiceStatus.SHUTTING_DOWN: colorama.Fore.YELLOW,
     ServiceStatus.FAILED: colorama.Fore.RED,
     ServiceStatus.FAILED_CLEANUP: colorama.Fore.RED,
     ServiceStatus.NO_REPLICA: colorama.Fore.MAGENTA,
 }
 
 
-def add_service(name: str, controller_job_id: int, policy: str, version: int,
+def add_service(name: str, controller_job_id: int, policy: str,
                 requested_resources_str: str, status: ServiceStatus) -> bool:
     """Add a service in the database.
 
     Returns:
         True if the service is added successfully, False if the service already
         exists.
     """
     try:
-        _DB.cursor.execute(
-            """\
-            INSERT INTO services
-            (name, controller_job_id, status, policy,
-            requested_resources_str, current_version)
-            VALUES (?, ?, ?, ?, ?, ?)""",
-            (name, controller_job_id, status.value, policy,
-             requested_resources_str, version))
-        _DB.conn.commit()
+        with db_utils.safe_cursor(_DB_PATH) as cursor:
+            cursor.execute(
+                """\
+                INSERT INTO services
+                (name, controller_job_id, status, policy,
+                requested_resources_str)
+                VALUES (?, ?, ?, ?, ?)""",
+                (name, controller_job_id, status.value, policy,
+                 requested_resources_str))
+
     except sqlite3.IntegrityError as e:
         if str(e) != _UNIQUE_CONSTRAINT_FAILED_ERROR_MSG:
             raise RuntimeError('Unexpected database error') from e
         return False
     return True
 
 
 def remove_service(service_name: str) -> None:
     """Removes a service from the database."""
-    _DB.cursor.execute("""\
-        DELETE FROM services WHERE name=(?)""", (service_name,))
-    _DB.conn.commit()
+    with db_utils.safe_cursor(_DB_PATH) as cursor:
+        cursor.execute("""\
+            DELETE FROM services WHERE name=(?)""", (service_name,))
 
 
 def set_service_uptime(service_name: str, uptime: int) -> None:
     """Sets the uptime of a service."""
-    _DB.cursor.execute(
-        """\
-        UPDATE services SET
-        uptime=(?) WHERE name=(?)""", (uptime, service_name))
-    _DB.conn.commit()
+    with db_utils.safe_cursor(_DB_PATH) as cursor:
+        cursor.execute(
+            """\
+            UPDATE services SET
+            uptime=(?) WHERE name=(?)""", (uptime, service_name))
 
 
-def set_service_status(service_name: str, status: ServiceStatus) -> None:
+def set_service_status_and_active_versions(
+        service_name: str,
+        status: ServiceStatus,
+        active_versions: Optional[List[int]] = None) -> None:
     """Sets the service status."""
-    _DB.cursor.execute(
-        """\
-        UPDATE services SET
-        status=(?) WHERE name=(?)""", (status.value, service_name))
-    _DB.conn.commit()
+    vars_to_set = 'status=(?)'
+    values: Tuple[str, ...] = (status.value, service_name)
+    if active_versions is not None:
+        vars_to_set = 'status=(?), active_versions=(?)'
+        values = (status.value, json.dumps(active_versions), service_name)
+    with db_utils.safe_cursor(_DB_PATH) as cursor:
+        cursor.execute(
+            f"""\
+            UPDATE services SET
+            {vars_to_set} WHERE name=(?)""", values)
 
 
 def set_service_controller_port(service_name: str,
                                 controller_port: int) -> None:
     """Sets the controller port of a service."""
-    _DB.cursor.execute(
-        """\
-        UPDATE services SET
-        controller_port=(?) WHERE name=(?)""", (controller_port, service_name))
-    _DB.conn.commit()
+    with db_utils.safe_cursor(_DB_PATH) as cursor:
+        cursor.execute(
+            """\
+            UPDATE services SET
+            controller_port=(?) WHERE name=(?)""",
+            (controller_port, service_name))
 
 
 def set_service_load_balancer_port(service_name: str,
                                    load_balancer_port: int) -> None:
     """Sets the load balancer port of a service."""
-    _DB.cursor.execute(
-        """\
-        UPDATE services SET
-        load_balancer_port=(?) WHERE name=(?)""",
-        (load_balancer_port, service_name))
-    _DB.conn.commit()
+    with db_utils.safe_cursor(_DB_PATH) as cursor:
+        cursor.execute(
+            """\
+            UPDATE services SET
+            load_balancer_port=(?) WHERE name=(?)""",
+            (load_balancer_port, service_name))
 
 
 def _get_service_from_row(row) -> Dict[str, Any]:
-    (name, controller_job_id, controller_port, load_balancer_port, status,
-     uptime, policy, _, requested_resources, requested_resources_str,
-     current_version) = row[:11]
+    (current_version, name, controller_job_id, controller_port,
+     load_balancer_port, status, uptime, policy, _, requested_resources,
+     requested_resources_str, _, active_versions) = row[:13]
     return {
         'name': name,
         'controller_job_id': controller_job_id,
         'controller_port': controller_port,
         'load_balancer_port': load_balancer_port,
         'status': ServiceStatus[status],
         'uptime': uptime,
         'policy': policy,
+        # The version of the autoscaler/replica manager are on. It can be larger
+        # than the active versions as the load balancer may not consider the
+        # latest version to be active for serving traffic.
         'version': current_version,
+        # The versions that is active for the load balancer. This is a list of
+        # integers in json format. This is mainly for display purpose.
+        'active_versions': json.loads(active_versions),
         # TODO(tian): Backward compatibility.
         # Remove after 2 minor release, 0.6.0.
         'requested_resources': pickle.loads(requested_resources)
                                if requested_resources is not None else None,
         'requested_resources_str': requested_resources_str,
     }
 
 
 def get_services() -> List[Dict[str, Any]]:
     """Get all existing service records."""
-    rows = _DB.cursor.execute('SELECT * FROM services').fetchall()
+    with db_utils.safe_cursor(_DB_PATH) as cursor:
+        rows = cursor.execute('SELECT v.max_version, s.* FROM services s '
+                              'JOIN ('
+                              'SELECT service_name, MAX(version) as max_version'
+                              ' FROM version_specs GROUP BY service_name) v '
+                              'ON s.name=v.service_name').fetchall()
     records = []
     for row in rows:
         records.append(_get_service_from_row(row))
     return records
 
 
 def get_service_from_name(service_name: str) -> Optional[Dict[str, Any]]:
     """Get all existing service records."""
-    rows = _DB.cursor.execute('SELECT * FROM services WHERE name=(?)',
-                              (service_name,)).fetchall()
+    with db_utils.safe_cursor(_DB_PATH) as cursor:
+        rows = cursor.execute(
+            'SELECT v.max_version, s.* FROM services s '
+            'JOIN ('
+            'SELECT service_name, MAX(version) as max_version '
+            'FROM version_specs WHERE service_name=(?)) v '
+            'ON s.name=v.service_name WHERE name=(?)',
+            (service_name, service_name)).fetchall()
     for row in rows:
         return _get_service_from_row(row)
     return None
 
 
-def get_service_version(service_name: str) -> Optional[int]:
-    """Get the version of a service."""
-    service = get_service_from_name(service_name)
-    if service is None:
-        return None
-    return service['version']
+def get_service_versions(service_name: str) -> List[int]:
+    """Gets all versions of a service."""
+    with db_utils.safe_cursor(_DB_PATH) as cursor:
+        rows = cursor.execute(
+            """\
+            SELECT DISTINCT version FROM version_specs
+            WHERE service_name=(?)""", (service_name,)).fetchall()
+    return [row[0] for row in rows]
 
 
 def get_glob_service_names(
         service_names: Optional[List[str]] = None) -> List[str]:
     """Get service names matching the glob patterns.
 
     Args:
         service_names: A list of glob patterns. If None, return all service
             names.
 
     Returns:
         A list of non-duplicated service names.
     """
-    if service_names is None:
-        rows = _DB.cursor.execute('SELECT name FROM services').fetchall()
-    else:
-        rows = []
-        for service_name in service_names:
-            rows.extend(
-                _DB.cursor.execute(
-                    'SELECT name FROM services WHERE name GLOB (?)',
-                    (service_name,)).fetchall())
+    with db_utils.safe_cursor(_DB_PATH) as cursor:
+        if service_names is None:
+            rows = cursor.execute('SELECT name FROM services').fetchall()
+        else:
+            rows = []
+            for service_name in service_names:
+                rows.extend(
+                    cursor.execute(
+                        'SELECT name FROM services WHERE name GLOB (?)',
+                        (service_name,)).fetchall())
     return list({row[0] for row in rows})
 
 
 # === Replica functions ===
 def add_or_update_replica(service_name: str, replica_id: int,
                           replica_info: 'replica_managers.ReplicaInfo') -> None:
     """Adds a replica to the database."""
-    _DB.cursor.execute(
-        """\
-        INSERT OR REPLACE INTO replicas
-        (service_name, replica_id, replica_info)
-        VALUES (?, ?, ?)""",
-        (service_name, replica_id, pickle.dumps(replica_info)))
-    _DB.conn.commit()
+    with db_utils.safe_cursor(_DB_PATH) as cursor:
+        cursor.execute(
+            """\
+            INSERT OR REPLACE INTO replicas
+            (service_name, replica_id, replica_info)
+            VALUES (?, ?, ?)""",
+            (service_name, replica_id, pickle.dumps(replica_info)))
 
 
 def remove_replica(service_name: str, replica_id: int) -> None:
     """Removes a replica from the database."""
-    _DB.cursor.execute(
-        """\
-        DELETE FROM replicas
-        WHERE service_name=(?)
-        AND replica_id=(?)""", (service_name, replica_id))
-    _DB.conn.commit()
+    with db_utils.safe_cursor(_DB_PATH) as cursor:
+        cursor.execute(
+            """\
+            DELETE FROM replicas
+            WHERE service_name=(?)
+            AND replica_id=(?)""", (service_name, replica_id))
 
 
 def get_replica_info_from_id(
         service_name: str,
         replica_id: int) -> Optional['replica_managers.ReplicaInfo']:
     """Gets a replica info from the database."""
-    rows = _DB.cursor.execute(
-        """\
-        SELECT replica_info FROM replicas
-        WHERE service_name=(?)
-        AND replica_id=(?)""", (service_name, replica_id)).fetchall()
+    with db_utils.safe_cursor(_DB_PATH) as cursor:
+        rows = cursor.execute(
+            """\
+            SELECT replica_info FROM replicas
+            WHERE service_name=(?)
+            AND replica_id=(?)""", (service_name, replica_id)).fetchall()
     for row in rows:
         return pickle.loads(row[0])
     return None
 
 
 def get_replica_infos(
         service_name: str) -> List['replica_managers.ReplicaInfo']:
     """Gets all replica infos of a service."""
-    rows = _DB.cursor.execute(
-        """\
-        SELECT replica_info FROM replicas
-        WHERE service_name=(?)""", (service_name,)).fetchall()
+    with db_utils.safe_cursor(_DB_PATH) as cursor:
+        rows = cursor.execute(
+            """\
+            SELECT replica_info FROM replicas
+            WHERE service_name=(?)""", (service_name,)).fetchall()
     return [pickle.loads(row[0]) for row in rows]
 
 
 def total_number_provisioning_replicas() -> int:
     """Returns the total number of provisioning replicas."""
-    rows = _DB.cursor.execute('SELECT replica_info FROM replicas').fetchall()
+    with db_utils.safe_cursor(_DB_PATH) as cursor:
+        rows = cursor.execute('SELECT replica_info FROM replicas').fetchall()
     provisioning_count = 0
     for row in rows:
         replica_info: 'replica_managers.ReplicaInfo' = pickle.loads(row[0])
         if replica_info.status == ReplicaStatus.PROVISIONING:
             provisioning_count += 1
     return provisioning_count
 
 
 # === Version functions ===
 def add_version(service_name: str) -> int:
     """Adds a version to the database."""
 
-    _DB.cursor.execute(
-        """\
-        INSERT INTO version_specs
-        (version, service_name, spec)
-        VALUES (
-            (SELECT COALESCE(MAX(version), 0) + 1 FROM
-            version_specs WHERE service_name = ?), ?, ?)
-        RETURNING version""", (service_name, service_name, pickle.dumps(None)))
+    with db_utils.safe_cursor(_DB_PATH) as cursor:
+        cursor.execute(
+            """\
+            INSERT INTO version_specs
+            (version, service_name, spec)
+            VALUES (
+                (SELECT COALESCE(MAX(version), 0) + 1 FROM
+                version_specs WHERE service_name = ?), ?, ?)
+            RETURNING version""",
+            (service_name, service_name, pickle.dumps(None)))
 
-    inserted_version = _DB.cursor.fetchone()[0]
-    _DB.conn.commit()
+        inserted_version = cursor.fetchone()[0]
 
     return inserted_version
 
 
 def add_or_update_version(service_name: str, version: int,
                           spec: 'service_spec.SkyServiceSpec') -> None:
-    _DB.cursor.execute(
-        """\
+    with db_utils.safe_cursor(_DB_PATH) as cursor:
+        cursor.execute(
+            """\
         INSERT or REPLACE INTO version_specs
         (service_name, version, spec)
         VALUES (?, ?, ?)""", (service_name, version, pickle.dumps(spec)))
-    _DB.cursor.execute(
-        """\
-        UPDATE services SET
-        current_version=(?) WHERE name=(?)""", (version, service_name))
-    _DB.conn.commit()
 
 
 def remove_service_versions(service_name: str) -> None:
     """Removes a replica from the database."""
-    _DB.cursor.execute(
-        """\
-        DELETE FROM version_specs
-        WHERE service_name=(?)""", (service_name,))
-    _DB.conn.commit()
+    with db_utils.safe_cursor(_DB_PATH) as cursor:
+        cursor.execute(
+            """\
+            DELETE FROM version_specs
+            WHERE service_name=(?)""", (service_name,))
 
 
 def get_spec(service_name: str,
              version: int) -> Optional['service_spec.SkyServiceSpec']:
     """Gets spec from the database."""
-    rows = _DB.cursor.execute(
-        """\
-        SELECT spec FROM version_specs
-        WHERE service_name=(?)
-        AND version=(?)""", (service_name, version)).fetchall()
+    with db_utils.safe_cursor(_DB_PATH) as cursor:
+        rows = cursor.execute(
+            """\
+            SELECT spec FROM version_specs
+            WHERE service_name=(?)
+            AND version=(?)""", (service_name, version)).fetchall()
     for row in rows:
         return pickle.loads(row[0])
     return None
 
 
 def delete_version(service_name: str, version: int) -> None:
     """Deletes a version from the database."""
-    _DB.cursor.execute(
-        """\
-        DELETE FROM version_specs
-        WHERE service_name=(?)
-        AND version=(?)""", (service_name, version))
-    _DB.conn.commit()
+    with db_utils.safe_cursor(_DB_PATH) as cursor:
+        cursor.execute(
+            """\
+            DELETE FROM version_specs
+            WHERE service_name=(?)
+            AND version=(?)""", (service_name, version))
```

### Comparing `skypilot-0.5.0/sky/serve/serve_utils.py` & `skypilot-0.6.0/sky/serve/serve_utils.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,43 +1,48 @@
 """User interface with the SkyServe."""
 import base64
+import collections
 import enum
 import os
 import pathlib
 import pickle
 import re
 import shlex
 import shutil
 import threading
 import time
 import typing
-from typing import (Any, Callable, Dict, Generic, Iterator, List, Optional,
-                    TextIO, Type, TypeVar)
+from typing import (Any, Callable, DefaultDict, Dict, Generic, Iterator, List,
+                    Optional, TextIO, Type, TypeVar)
 import uuid
 
 import colorama
 import filelock
 import psutil
 import requests
 
 from sky import backends
 from sky import exceptions
 from sky import global_user_state
 from sky import status_lib
+from sky.backends import backend_utils
 from sky.serve import constants
 from sky.serve import serve_state
+from sky.skylet import constants as skylet_constants
 from sky.skylet import job_lib
 from sky.utils import common_utils
 from sky.utils import log_utils
 from sky.utils import resources_utils
 from sky.utils import ux_utils
 
 if typing.TYPE_CHECKING:
     import fastapi
 
+    from sky.serve import replica_managers
+
 SKY_SERVE_CONTROLLER_NAME: str = (
     f'sky-serve-controller-{common_utils.get_user_hash()}')
 _SYSTEM_MEMORY_GB = psutil.virtual_memory().total // (1024**3)
 NUM_SERVICE_THRESHOLD = (_SYSTEM_MEMORY_GB //
                          constants.CONTROLLER_MEMORY_USAGE_GB)
 _CONTROLLER_URL = 'http://localhost:{CONTROLLER_PORT}'
 
@@ -71,14 +76,22 @@
     # TODO(tian): Add more signals, such as pause.
 
     def error_type(self) -> Type[Exception]:
         """Get the error corresponding to the signal."""
         return _SIGNAL_TO_ERROR[self]
 
 
+class UpdateMode(enum.Enum):
+    """Update mode for updating a service."""
+    ROLLING = 'rolling'
+    BLUE_GREEN = 'blue_green'
+
+
+DEFAULT_UPDATE_MODE = UpdateMode.ROLLING
+
 _SIGNAL_TO_ERROR = {
     UserSignal.TERMINATE: exceptions.ServeUserTerminatedError,
 }
 
 # pylint: disable=invalid-name
 KeyType = TypeVar('KeyType')
 ValueType = TypeVar('ValueType')
@@ -224,58 +237,70 @@
     return os.path.join(dir_name, f'replica_{replica_id}.log')
 
 
 def generate_replica_cluster_name(service_name: str, replica_id: int) -> str:
     return f'{service_name}-{replica_id}'
 
 
-def set_service_status_from_replica_statuses(
-        service_name: str,
-        replica_statuses: List[serve_state.ReplicaStatus]) -> None:
+def set_service_status_and_active_versions_from_replica(
+        service_name: str, replica_infos: List['replica_managers.ReplicaInfo'],
+        update_mode: UpdateMode) -> None:
     record = serve_state.get_service_from_name(service_name)
     if record is None:
         raise ValueError('The service is up-ed in an old version and does not '
                          'support update. Please `sky serve down` '
                          'it first and relaunch the service.')
     if record['status'] == serve_state.ServiceStatus.SHUTTING_DOWN:
         # When the service is shutting down, there is a period of time which the
         # controller still responds to the request, and the replica is not
         # terminated, the service status will still be READY, but we don't want
         # change service status to READY.
         return
-    serve_state.set_service_status(
+
+    ready_replicas = list(filter(lambda info: info.is_ready, replica_infos))
+    if update_mode == UpdateMode.ROLLING:
+        active_versions = sorted(
+            list(set(info.version for info in ready_replicas)))
+    else:
+        chosen_version = get_latest_version_with_min_replicas(
+            service_name, replica_infos)
+        active_versions = [chosen_version] if chosen_version is not None else []
+    serve_state.set_service_status_and_active_versions(
         service_name,
-        serve_state.ServiceStatus.from_replica_statuses(replica_statuses))
+        serve_state.ServiceStatus.from_replica_statuses(
+            [info.status for info in ready_replicas]),
+        active_versions=active_versions)
 
 
 def update_service_status() -> None:
     services = serve_state.get_services()
     for record in services:
         if record['status'] == serve_state.ServiceStatus.SHUTTING_DOWN:
             # Skip services that is shutting down.
             continue
         controller_job_id = record['controller_job_id']
         assert controller_job_id is not None
         controller_status = job_lib.get_status(controller_job_id)
         if controller_status is None or controller_status.is_terminal():
             # If controller job is not running, set it as controller failed.
-            serve_state.set_service_status(
+            serve_state.set_service_status_and_active_versions(
                 record['name'], serve_state.ServiceStatus.CONTROLLER_FAILED)
 
 
-def update_service_encoded(service_name: str, version: int) -> str:
+def update_service_encoded(service_name: str, version: int, mode: str) -> str:
     service_status = _get_service_status(service_name)
     if service_status is None:
         raise ValueError(f'Service {service_name!r} does not exist.')
     controller_port = service_status['controller_port']
     resp = requests.post(
         _CONTROLLER_URL.format(CONTROLLER_PORT=controller_port) +
         '/controller/update_service',
         json={
             'version': version,
+            'mode': mode,
         })
     if resp.status_code == 404:
         raise ValueError('The service is up-ed in an old version and does not '
                          'support update. Please `sky serve down` '
                          'it first and relaunch the service. ')
     elif resp.status_code != 200:
         raise ValueError(f'Failed to update service: {resp.text}')
@@ -492,14 +517,32 @@
         return f'Service {service_name!r} does not exist.'
     if service_record['status'] == serve_state.ServiceStatus.CONTROLLER_INIT:
         return (f'Service {service_name!r} is still initializing its '
                 'controller. Please try again later.')
     return None
 
 
+def get_latest_version_with_min_replicas(
+        service_name: str,
+        replica_infos: List['replica_managers.ReplicaInfo']) -> Optional[int]:
+    # Find the latest version with at least min_replicas replicas.
+    version2count: DefaultDict[int, int] = collections.defaultdict(int)
+    for info in replica_infos:
+        if info.is_ready:
+            version2count[info.version] += 1
+
+    active_versions = sorted(version2count.keys(), reverse=True)
+    for version in active_versions:
+        spec = serve_state.get_spec(service_name, version)
+        if (spec is not None and version2count[version] >= spec.min_replicas):
+            return version
+    # Use the oldest version if no version has enough replicas.
+    return active_versions[-1] if active_versions else None
+
+
 def _follow_replica_logs(
         file: TextIO,
         cluster_name: str,
         *,
         finish_stream: Callable[[], bool],
         exit_if_stream_end: bool = False,
         no_new_content_timeout: Optional[int] = None) -> Iterator[str]:
@@ -669,30 +712,39 @@
 
 def _get_replicas(service_record: Dict[str, Any]) -> str:
     ready_replica_num, total_replica_num = 0, 0
     for info in service_record['replica_info']:
         if info['status'] == serve_state.ReplicaStatus.READY:
             ready_replica_num += 1
         # TODO(MaoZiming): add a column showing failed replicas number.
-        if info['status'] != serve_state.ReplicaStatus.FAILED:
+        if info['status'] not in serve_state.ReplicaStatus.failed_statuses():
             total_replica_num += 1
     return f'{ready_replica_num}/{total_replica_num}'
 
 
 def get_endpoint(service_record: Dict[str, Any]) -> str:
     # Don't use backend_utils.is_controller_up since it is too slow.
     handle = global_user_state.get_handle_from_cluster_name(
         SKY_SERVE_CONTROLLER_NAME)
     assert isinstance(handle, backends.CloudVmRayResourceHandle)
-    if handle is None or handle.head_ip is None:
+    if handle is None:
         return '-'
     load_balancer_port = service_record['load_balancer_port']
     if load_balancer_port is None:
         return '-'
-    return f'{handle.head_ip}:{load_balancer_port}'
+    try:
+        endpoint = backend_utils.get_endpoints(handle.cluster_name,
+                                               load_balancer_port).get(
+                                                   load_balancer_port, None)
+    except exceptions.ClusterNotUpError:
+        return '-'
+    if endpoint is None:
+        return '-'
+    assert isinstance(endpoint, str), endpoint
+    return endpoint
 
 
 def format_service_table(service_records: List[Dict[str, Any]],
                          show_all: bool) -> str:
     if not service_records:
         return 'No existing services.'
 
@@ -706,15 +758,17 @@
     replica_infos = []
     for record in service_records:
         for replica in record['replica_info']:
             replica['service_name'] = record['name']
             replica_infos.append(replica)
 
         service_name = record['name']
-        version = record['version'] if 'version' in record else '-'
+        version = ','.join(
+            str(v) for v in record['active_versions']
+        ) if 'active_versions' in record and record['active_versions'] else '-'
         uptime = log_utils.readable_time_duration(record['uptime'],
                                                   absolute=True)
         service_status = record['status']
         status_str = service_status.colored_str()
         replicas = _get_replicas(record)
         endpoint = get_endpoint(record)
         policy = record['policy']
@@ -746,55 +800,54 @@
 
 def _format_replica_table(replica_records: List[Dict[str, Any]],
                           show_all: bool) -> str:
     if not replica_records:
         return 'No existing replicas.'
 
     replica_columns = [
-        'SERVICE_NAME', 'ID', 'VERSION', 'IP', 'LAUNCHED', 'RESOURCES',
+        'SERVICE_NAME', 'ID', 'VERSION', 'ENDPOINT', 'LAUNCHED', 'RESOURCES',
         'STATUS', 'REGION'
     ]
     if show_all:
         replica_columns.append('ZONE')
     replica_table = log_utils.create_table(replica_columns)
 
     truncate_hint = ''
     if not show_all:
         if len(replica_records) > _REPLICA_TRUNC_NUM:
             truncate_hint = '\n... (use --all to show all replicas)'
         replica_records = replica_records[:_REPLICA_TRUNC_NUM]
 
     for record in replica_records:
+        endpoint = record.get('endpoint', '-')
         service_name = record['service_name']
         replica_id = record['replica_id']
         version = (record['version'] if 'version' in record else '-')
-        replica_ip = '-'
+        replica_endpoint = endpoint if endpoint else '-'
         launched_at = log_utils.readable_time_duration(record['launched_at'])
         resources_str = '-'
         replica_status = record['status']
         status_str = replica_status.colored_str()
         region = '-'
         zone = '-'
 
         replica_handle: 'backends.CloudVmRayResourceHandle' = record['handle']
         if replica_handle is not None:
-            if replica_handle.head_ip is not None:
-                replica_ip = replica_handle.head_ip
             resources_str = resources_utils.get_readable_resources_repr(
                 replica_handle, simplify=not show_all)
             if replica_handle.launched_resources.region is not None:
                 region = replica_handle.launched_resources.region
             if replica_handle.launched_resources.zone is not None:
                 zone = replica_handle.launched_resources.zone
 
         replica_values = [
             service_name,
             replica_id,
             version,
-            replica_ip,
+            replica_endpoint,
             launched_at,
             resources_str,
             status_str,
             region,
         ]
         if show_all:
             replica_values.append(zone)
@@ -811,17 +864,21 @@
 # to implement some authentication mechanism.
 class ServeCodeGen:
     """Code generator for SkyServe.
 
     Usage:
       >> code = ServeCodeGen.get_service_status(service_name)
     """
+
+    # TODO(zhwu): When any API is changed, we should update the
+    # constants.SERVE_VERSION.
     _PREFIX = [
         'from sky.serve import serve_state',
         'from sky.serve import serve_utils',
+        'from sky.serve import constants',
     ]
 
     @classmethod
     def get_service_status(cls, service_names: Optional[List[str]]) -> str:
         code = [
             f'msg = serve_utils.get_service_status_encoded({service_names!r})',
             'print(msg, end="", flush=True)'
@@ -872,16 +929,25 @@
         ]
         return cls._build(code)
 
     @classmethod
     def _build(cls, code: List[str]) -> str:
         code = cls._PREFIX + code
         generated_code = '; '.join(code)
-        return f'python3 -u -c {shlex.quote(generated_code)}'
+        return (f'{skylet_constants.SKY_PYTHON_CMD} '
+                f'-u -c {shlex.quote(generated_code)}')
 
     @classmethod
-    def update_service(cls, service_name: str, version: int) -> str:
+    def update_service(cls, service_name: str, version: int, mode: str) -> str:
         code = [
+            # Backward compatibility for old serve version on the remote
+            # machine. The `mode` argument was added in #3249, and if the remote
+            # machine has an old SkyPilot version before that, we need to avoid
+            # passing the `mode` argument to the job_lib functions.
+            # TODO(zhwu): Remove this in 0.7.0 release.
+            f'mode_kwargs = {{"mode": {mode!r}}} '
+            'if getattr(constants, "SERVE_VERSION", 0) >= 1 else {}',
             f'msg = serve_utils.update_service_encoded({service_name!r}, '
-            f'{version})', 'print(msg, end="", flush=True)'
+            f'{version}, **mode_kwargs)',
+            'print(msg, end="", flush=True)',
         ]
         return cls._build(code)
```

### Comparing `skypilot-0.5.0/sky/serve/service.py` & `skypilot-0.6.0/sky/serve/service.py`

 * *Files 1% similar despite different names*

```diff
@@ -79,15 +79,15 @@
                      f'{common_utils.format_exception(e)}')
         with ux_utils.enable_traceback():
             logger.error(f'  Traceback: {traceback.format_exc()}')
         return False
     return True
 
 
-def _cleanup(service_name: str, task_yaml: str) -> bool:
+def _cleanup(service_name: str) -> bool:
     """Clean up all service related resources, i.e. replicas and storage."""
     failed = False
     replica_infos = serve_state.get_replica_infos(service_name)
     info2proc: Dict[replica_managers.ReplicaInfo,
                     multiprocessing.Process] = dict()
     for info in replica_infos:
         p = multiprocessing.Process(target=replica_managers.terminate_cluster,
@@ -97,36 +97,35 @@
         # Set replica status to `SHUTTING_DOWN`
         info.status_property.sky_launch_status = (
             replica_managers.ProcessStatus.SUCCEEDED)
         info.status_property.sky_down_status = (
             replica_managers.ProcessStatus.RUNNING)
         serve_state.add_or_update_replica(service_name, info.replica_id, info)
         logger.info(f'Terminating replica {info.replica_id} ...')
-    versions = set()
     for info, p in info2proc.items():
         p.join()
         if p.exitcode == 0:
             serve_state.remove_replica(service_name, info.replica_id)
-            versions.add(info.version)
             logger.info(f'Replica {info.replica_id} terminated successfully.')
         else:
             # Set replica status to `FAILED_CLEANUP`
             info.status_property.sky_down_status = (
                 replica_managers.ProcessStatus.FAILED)
             serve_state.add_or_update_replica(service_name, info.replica_id,
                                               info)
             failed = True
             logger.error(f'Replica {info.replica_id} failed to terminate.')
+    versions = serve_state.get_service_versions(service_name)
     serve_state.remove_service_versions(service_name)
     success = True
     for version in versions:
+        task_yaml: str = serve_utils.generate_task_yaml_file_name(
+            service_name, version)
         logger.info(f'Cleaning up storage for version {version}, '
                     f'task_yaml: {task_yaml}')
-        task_yaml = serve_utils.generate_task_yaml_file_name(
-            service_name, version)
         success = success and cleanup_storage(task_yaml)
     if not success:
         failed = True
     return failed
 
 
 def _start(service_name: str, tmp_task_yaml: str, job_id: int):
@@ -143,16 +142,15 @@
     if len(serve_state.get_services()) >= serve_utils.NUM_SERVICE_THRESHOLD:
         cleanup_storage(tmp_task_yaml)
         with ux_utils.print_exception_no_traceback():
             raise RuntimeError('Max number of services reached.')
     success = serve_state.add_service(
         service_name,
         controller_job_id=job_id,
-        policy=service_spec.policy_str(),
-        version=constants.INITIAL_VERSION,
+        policy=service_spec.autoscaling_policy_str(),
         requested_resources_str=backend_utils.get_task_resources_str(task),
         status=serve_state.ServiceStatus.CONTROLLER_INIT)
     # Directly throw an error here. See sky/serve/api.py::up
     # for more details.
     if not success:
         cleanup_storage(tmp_task_yaml)
         with ux_utils.print_exception_no_traceback():
@@ -210,31 +208,31 @@
             serve_state.set_service_load_balancer_port(service_name,
                                                        load_balancer_port)
 
         while True:
             _handle_signal(service_name)
             time.sleep(1)
     except exceptions.ServeUserTerminatedError:
-        serve_state.set_service_status(service_name,
-                                       serve_state.ServiceStatus.SHUTTING_DOWN)
+        serve_state.set_service_status_and_active_versions(
+            service_name, serve_state.ServiceStatus.SHUTTING_DOWN)
     finally:
         process_to_kill: List[multiprocessing.Process] = []
         if load_balancer_process is not None:
             process_to_kill.append(load_balancer_process)
         if controller_process is not None:
             process_to_kill.append(controller_process)
         # Kill load balancer process first since it will raise errors if failed
         # to connect to the controller. Then the controller process.
         subprocess_utils.kill_children_processes(
             [process.pid for process in process_to_kill], force=True)
         for process in process_to_kill:
             process.join()
-        failed = _cleanup(service_name, task_yaml)
+        failed = _cleanup(service_name)
         if failed:
-            serve_state.set_service_status(
+            serve_state.set_service_status_and_active_versions(
                 service_name, serve_state.ServiceStatus.FAILED_CLEANUP)
             logger.error(f'Service {service_name} failed to clean up.')
         else:
             shutil.rmtree(service_dir)
             serve_state.remove_service(service_name)
             logger.info(f'Service {service_name} terminated successfully.')
```

### Comparing `skypilot-0.5.0/sky/setup_files/MANIFEST.in` & `skypilot-0.6.0/sky/setup_files/MANIFEST.in`

 * *Files 13% similar despite different names*

```diff
@@ -1,19 +1,20 @@
 include sky/backends/monkey_patches/*.py
 exclude sky/clouds/service_catalog/data_fetchers/analyze.py
+include sky/provision/kubernetes/manifests/*
 include sky/setup_files/*
 include sky/skylet/*.sh
 include sky/skylet/LICENSE
 include sky/skylet/providers/azure/*
 include sky/skylet/providers/gcp/*
 include sky/skylet/providers/ibm/*
 include sky/skylet/providers/kubernetes/*
 include sky/skylet/providers/lambda_cloud/*
 include sky/skylet/providers/oci/*
 include sky/skylet/providers/scp/*
 include sky/skylet/providers/*.py
 include sky/skylet/ray_patches/*.patch
-include sky/spot/dashboard/*
-include sky/spot/dashboard/templates/*
-include sky/spot/dashboard/static/*
+include sky/jobs/dashboard/*
+include sky/jobs/dashboard/templates/*
+include sky/jobs/dashboard/static/*
 include sky/templates/*
 include sky/utils/kubernetes/*
```

### Comparing `skypilot-0.5.0/sky/setup_files/setup.py` & `skypilot-0.6.0/sky/setup_files/setup.py`

 * *Files 2% similar despite different names*

```diff
@@ -165,38 +165,36 @@
 ]
 
 local_ray = [
     # Lower version of ray will cause dependency conflict for
     # click/grpcio/protobuf.
     # Excluded 2.6.0 as it has a bug in the cluster launcher:
     # https://github.com/ray-project/ray/releases/tag/ray-2.6.1
-    'ray[default] >= 2.2.0, <= 2.6.3, != 2.6.0',
+    'ray[default] >= 2.2.0, != 2.6.0',
 ]
 
 remote = [
     # Adopted from ray's setup.py: https://github.com/ray-project/ray/blob/ray-2.4.0/python/setup.py
     # SkyPilot: != 1.48.0 is required to avoid the error where ray dashboard fails to start when
     # ray start is called (#2054).
     # Tracking issue: https://github.com/ray-project/ray/issues/30984
     "grpcio >= 1.32.0, <= 1.49.1, != 1.48.0; python_version < '3.10' and sys_platform == 'darwin'",  # noqa:E501
     "grpcio >= 1.42.0, <= 1.49.1, != 1.48.0; python_version >= '3.10' and sys_platform == 'darwin'",  # noqa:E501
     # Original issue: https://github.com/ray-project/ray/issues/33833
     "grpcio >= 1.32.0, <= 1.51.3, != 1.48.0; python_version < '3.10' and sys_platform != 'darwin'",  # noqa:E501
     "grpcio >= 1.42.0, <= 1.51.3, != 1.48.0; python_version >= '3.10' and sys_platform != 'darwin'",  # noqa:E501
     # Adopted from ray's setup.py:
-    # https://github.com/ray-project/ray/blob/86fab1764e618215d8131e8e5068f0d493c77023/python/setup.py#L326
+    # https://github.com/ray-project/ray/blob/ray-2.9.3/python/setup.py#L343
     'protobuf >= 3.15.3, != 3.19.5',
-    # Ray job has an issue with pydantic>2.0.0, due to API changes of pydantic. See
-    # https://github.com/ray-project/ray/issues/36990
-    # >=1.10.8 is needed for ray>=2.6. See
-    # https://github.com/ray-project/ray/issues/35661
-    'pydantic <2.0, >=1.10.8',
+    # Some pydantic versions are not compatible with ray. Adopted from ray's
+    # setup.py: https://github.com/ray-project/ray/blob/ray-2.9.3/python/setup.py#L254
+    'pydantic!=2.0.*,!=2.1.*,!=2.2.*,!=2.3.*,!=2.4.*,<3',
 ]
 
-# NOTE: Change the templates/spot-controller.yaml.j2 file if any of the
+# NOTE: Change the templates/jobs-controller.yaml.j2 file if any of the
 # following packages dependencies are changed.
 aws_dependencies = [
     # botocore does not work with urllib3>=2.0.0, according to https://github.com/boto/botocore/issues/2926
     # We have to explicitly pin the version to optimize the time for
     # poetry install. See https://github.com/orgs/python-poetry/discussions/7937
     'urllib3<2',
     # NOTE: this installs CLI V1. To use AWS SSO (e.g., `aws sso login`), users
@@ -233,15 +231,16 @@
     'cloudflare': aws_dependencies,
     'scp': local_ray,
     'oci': ['oci'] + local_ray,
     'kubernetes': ['kubernetes>=20.0.0'],
     'remote': remote,
     'runpod': ['runpod>=1.5.1'],
     'fluidstack': [],  # No dependencies needed for fluidstack
-    'cudo': ['cudo-compute>=0.1.8'],
+    'cudo': ['cudo-compute>=0.1.10'],
+    'paperspace': [],  # No dependencies needed for paperspace
     'vsphere': [
         'pyvmomi==8.0.1.0.2',
         # vsphere-automation-sdk is also required, but it does not have
         # pypi release, which cause failure of our pypi release.
         # https://peps.python.org/pep-0440/#direct-references
         # We have the instruction for its installation in our
         # docs instead.
@@ -284,14 +283,15 @@
     },
     include_package_data=True,
     classifiers=[
         'Programming Language :: Python :: 3.7',
         'Programming Language :: Python :: 3.8',
         'Programming Language :: Python :: 3.9',
         'Programming Language :: Python :: 3.10',
+        'Programming Language :: Python :: 3.11',
         'License :: OSI Approved :: Apache Software License',
         'Operating System :: OS Independent',
         'Topic :: Software Development :: Libraries :: Python Modules',
         'Topic :: System :: Distributed Computing',
     ],
     project_urls={
         'Homepage': 'https://github.com/skypilot-org/skypilot',
```

### Comparing `skypilot-0.5.0/sky/sky_logging.py` & `skypilot-0.6.0/sky/sky_logging.py`

 * *Files 2% similar despite different names*

```diff
@@ -107,20 +107,21 @@
     previous_is_silent = is_silent()
     previous_print = print
 
     # Turn off logger
     _root_logger.setLevel(logging.ERROR)
     _logging_config.is_silent = True
     print = lambda *args, **kwargs: None
-    yield
-
-    # Restore logger
-    print = previous_print
-    _root_logger.setLevel(previous_level)
-    _logging_config.is_silent = previous_is_silent
+    try:
+        yield
+    finally:
+        # Restore logger
+        print = previous_print
+        _root_logger.setLevel(previous_level)
+        _logging_config.is_silent = previous_is_silent
 
 
 def is_silent():
     if not hasattr(_logging_config, 'is_silent'):
         # Should not set it globally, as the global assignment
         # will be executed only once if the module is imported
         # in the main thread, and will not be executed in other
```

### Comparing `skypilot-0.5.0/sky/skylet/LICENSE` & `skypilot-0.6.0/sky/skylet/LICENSE`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/skylet/attempt_skylet.py` & `skypilot-0.6.0/sky/skylet/attempt_skylet.py`

 * *Files 23% similar despite different names*

```diff
@@ -9,29 +9,35 @@
 
 
 def restart_skylet():
     # Kills old skylet if it is running.
     # TODO(zhwu): make the killing graceful, e.g., use a signal to tell
     # skylet to exit, instead of directly killing it.
     subprocess.run(
-        'ps aux | grep "sky.skylet.skylet" | grep "python3 -m"'
+        # We use -m to grep instead of {constants.SKY_PYTHON_CMD} -m to grep
+        # because need to handle the backward compatibility of the old skylet
+        # started before #3326, which does not use the full path to python.
+        'ps aux | grep "sky.skylet.skylet" | grep " -m "'
         '| awk \'{print $2}\' | xargs kill >> ~/.sky/skylet.log 2>&1',
         shell=True,
         check=False)
     subprocess.run(
-        'nohup python3 -m sky.skylet.skylet'
+        # We have made sure that `attempt_skylet.py` is executed with the
+        # skypilot runtime env activated, so that skylet can access the cloud
+        # CLI tools.
+        f'nohup {constants.SKY_PYTHON_CMD} -m sky.skylet.skylet'
         ' >> ~/.sky/skylet.log 2>&1 &',
         shell=True,
         check=True)
     with open(VERSION_FILE, 'w', encoding='utf-8') as v_f:
         v_f.write(constants.SKYLET_VERSION)
 
 
 proc = subprocess.run(
-    'ps aux | grep -v "grep" | grep "sky.skylet.skylet" | grep "python3 -m"',
+    'ps aux | grep -v "grep" | grep "sky.skylet.skylet" | grep " -m"',
     shell=True,
     check=False)
 
 running = (proc.returncode == 0)
 
 version_match = False
 found_version = None
```

### Comparing `skypilot-0.5.0/sky/skylet/autostop_lib.py` & `skypilot-0.6.0/sky/skylet/autostop_lib.py`

 * *Files 6% similar despite different names*

```diff
@@ -4,14 +4,15 @@
 import time
 from typing import List, Optional
 
 import psutil
 
 from sky import sky_logging
 from sky.skylet import configs
+from sky.skylet import constants
 from sky.utils import common_utils
 
 logger = sky_logging.init_logger(__name__)
 
 _AUTOSTOP_CONFIG_KEY = 'autostop_config'
 
 # This key-value is stored inside the 'configs' sqlite3 database, because both
@@ -50,21 +51,19 @@
         return AutostopConfig(-1, -1, None)
     return pickle.loads(config_str)
 
 
 def set_autostop(idle_minutes: int, backend: Optional[str], down: bool) -> None:
     boot_time = psutil.boot_time()
     autostop_config = AutostopConfig(idle_minutes, boot_time, backend, down)
-    prev_autostop_config = get_autostop_config()
     configs.set_config(_AUTOSTOP_CONFIG_KEY, pickle.dumps(autostop_config))
     logger.debug(f'set_autostop(): idle_minutes {idle_minutes}, down {down}.')
-    if (prev_autostop_config.autostop_idle_minutes < 0 or
-            prev_autostop_config.boot_time != psutil.boot_time()):
-        # Either autostop never set, or has been canceled. Reset timer.
-        set_last_active_time_to_now()
+    # Reset timer whenever an autostop setting is submitted, i.e. the idle
+    # time will be counted from now.
+    set_last_active_time_to_now()
 
 
 def set_autostopping_started() -> None:
     """Sets the boot time of the machine when autostop starts.
 
     This function should be called when the cluster is started to autostop,
     and the boot time of the machine will be stored in the configs database
@@ -72,18 +71,24 @@
     is in the process of autostopping. The indicator is valid only when the
     machine has the same boot time as the one stored in the indicator.
     """
     logger.debug('Setting is_autostopping.')
     configs.set_config(_AUTOSTOP_INDICATOR, str(psutil.boot_time()))
 
 
-def get_is_autostopping_payload() -> str:
+def get_is_autostopping() -> bool:
     """Returns whether the cluster is in the process of autostopping."""
     result = configs.get_config(_AUTOSTOP_INDICATOR)
     is_autostopping = (result == str(psutil.boot_time()))
+    return is_autostopping
+
+
+def get_is_autostopping_payload() -> str:
+    """Payload for whether the cluster is in the process of autostopping."""
+    is_autostopping = get_is_autostopping()
     return common_utils.encode_payload(is_autostopping)
 
 
 def get_last_active_time() -> float:
     """Returns the last active time, or -1 if none has been set."""
     result = configs.get_config(_AUTOSTOP_LAST_ACTIVE_TIME)
     if result is not None:
@@ -119,8 +124,8 @@
         code = ['print(autostop_lib.get_is_autostopping_payload())']
         return cls._build(code)
 
     @classmethod
     def _build(cls, code: List[str]) -> str:
         code = cls._PREFIX + code
         code = ';'.join(code)
-        return f'python3 -u -c {shlex.quote(code)}'
+        return f'{constants.SKY_PYTHON_CMD} -u -c {shlex.quote(code)}'
```

### Comparing `skypilot-0.5.0/sky/skylet/configs.py` & `skypilot-0.6.0/sky/skylet/configs.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/skylet/events.py` & `skypilot-0.6.0/sky/skylet/events.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,27 +1,27 @@
 """skylet events"""
 import math
 import os
 import re
 import subprocess
-import sys
 import time
 import traceback
 
 import psutil
 import yaml
 
 from sky import clouds
 from sky import sky_logging
 from sky.backends import cloud_vm_ray_backend
 from sky.clouds import cloud_registry
+from sky.jobs import utils as managed_job_utils
 from sky.serve import serve_utils
 from sky.skylet import autostop_lib
+from sky.skylet import constants
 from sky.skylet import job_lib
-from sky.spot import spot_utils
 from sky.utils import cluster_yaml_utils
 from sky.utils import common_utils
 from sky.utils import ux_utils
 
 # Seconds of sleep between the processing of skylet events.
 EVENT_CHECKING_INTERVAL_SECONDS = 20
 logger = sky_logging.init_logger(__name__)
@@ -60,23 +60,23 @@
 
 
 class JobSchedulerEvent(SkyletEvent):
     """Skylet event for scheduling jobs"""
     EVENT_INTERVAL_SECONDS = 300
 
     def _run(self):
-        job_lib.scheduler.schedule_step()
+        job_lib.scheduler.schedule_step(force_update_jobs=True)
 
 
-class SpotJobUpdateEvent(SkyletEvent):
-    """Skylet event for updating spot job status."""
+class ManagedJobUpdateEvent(SkyletEvent):
+    """Skylet event for updating managed job status."""
     EVENT_INTERVAL_SECONDS = 300
 
     def _run(self):
-        spot_utils.update_spot_job_status()
+        managed_job_utils.update_managed_job_status()
 
 
 class ServiceUpdateEvent(SkyletEvent):
     """Skylet event for updating sky serve service status.
 
     This is needed to handle the case that controller process is somehow
     terminated and the service status is not updated.
@@ -188,29 +188,44 @@
                 script = (cloud_vm_ray_backend.
                           write_ray_up_script_with_patched_launch_hash_fn(
                               config_path,
                               ray_up_kwargs={'restart_only': True}))
                 # Passing env inherited from os.environ is technically not
                 # needed, because we call `python <script>` rather than `ray
                 # <cmd>`. We just need the {RAY_USAGE_STATS_ENABLED: 0} part.
-                subprocess.run([sys.executable, script], check=True, env=env)
+                subprocess.run(f'{constants.SKY_PYTHON_CMD} {script}',
+                               check=True,
+                               shell=True,
+                               env=env)
 
                 logger.info('Running ray down.')
                 # Stop the workers first to avoid orphan workers.
                 subprocess.run(
-                    ['ray', 'down', '-y', '--workers-only', config_path],
+                    f'{constants.SKY_RAY_CMD} down -y --workers-only '
+                    f'{config_path}',
                     check=True,
+                    shell=True,
                     # We pass env inherited from os.environ due to calling `ray
                     # <cmd>`.
                     env=env)
 
+            # Stop the ray autoscaler to avoid scaling up, during
+            # stopping/terminating of the cluster. We do not rely `ray down`
+            # below for stopping ray cluster, as it will not use the correct
+            # ray path.
+            logger.info('Stopping the ray cluster.')
+            subprocess.run(f'{constants.SKY_RAY_CMD} stop',
+                           shell=True,
+                           check=True)
+
             logger.info('Running final ray down.')
             subprocess.run(
-                ['ray', 'down', '-y', config_path],
+                f'{constants.SKY_RAY_CMD} down -y {config_path}',
                 check=True,
+                shell=True,
                 # We pass env inherited from os.environ due to calling `ray
                 # <cmd>`.
                 env=env)
         else:
             raise NotImplementedError
 
     def _stop_cluster_with_new_provisioner(self, autostop_config,
@@ -224,15 +239,15 @@
 
         os.environ.pop('AWS_ACCESS_KEY_ID', None)
         os.environ.pop('AWS_SECRET_ACCESS_KEY', None)
 
         # Stop the ray autoscaler to avoid scaling up, during
         # stopping/terminating of the cluster.
         logger.info('Stopping the ray cluster.')
-        subprocess.run('ray stop', shell=True, check=True)
+        subprocess.run(f'{constants.SKY_RAY_CMD} stop', shell=True, check=True)
 
         operation_fn = provision_lib.stop_instances
         if autostop_config.down:
             operation_fn = provision_lib.terminate_instances
 
         if is_cluster_multinode:
             logger.info('Terminating worker nodes first.')
```

### Comparing `skypilot-0.5.0/sky/skylet/job_lib.py` & `skypilot-0.6.0/sky/skylet/job_lib.py`

 * *Files 1% similar despite different names*

```diff
@@ -1,8 +1,8 @@
-"""Sky job lib, backed by a sqlite database.
+"""Utilities for jobs on a remote cluster, backed by a sqlite database.
 
 This is a remote utility module that provides job queue functionality.
 """
 import enum
 import getpass
 import json
 import os
@@ -161,17 +161,17 @@
 
     def _run_job(self, job_id: int, run_cmd: str):
         _CURSOR.execute((f'UPDATE pending_jobs SET submit={int(time.time())} '
                          f'WHERE job_id={job_id!r}'))
         _CONN.commit()
         subprocess.Popen(run_cmd, shell=True, stdout=subprocess.DEVNULL)
 
-    def schedule_step(self) -> None:
+    def schedule_step(self, force_update_jobs: bool = False) -> None:
         jobs = self._get_jobs()
-        if len(jobs) > 0:
+        if len(jobs) > 0 or force_update_jobs:
             update_status()
         # TODO(zhwu, mraheja): One optimization can be allowing more than one
         # job staying in the pending state after ray job submit, so that to be
         # faster to schedule a large amount of jobs.
         for job_id, run_cmd, submit, created_time in jobs:
             with filelock.FileLock(_get_lock_path(job_id)):
                 status = get_status_no_lock(job_id)
@@ -388,23 +388,22 @@
     return None
 
 
 def get_job_submitted_or_ended_timestamp_payload(job_id: int,
                                                  get_ended_time: bool) -> str:
     """Get the job submitted/ended timestamp.
 
-    This function should only be called by the spot controller,
-    which is ok to use `submitted_at` instead of `start_at`,
-    because the spot job duration need to include both setup
-    and running time and the job will not stay in PENDING
-    state.
-
-    The normal job duration will use `start_at` instead of
-    `submitted_at` (in `format_job_queue()`), because the job
-    may stay in PENDING if the cluster is busy.
+    This function should only be called by the jobs controller, which is ok to
+    use `submitted_at` instead of `start_at`, because the managed job duration
+    need to include both setup and running time and the job will not stay in
+    PENDING state.
+
+    The normal job duration will use `start_at` instead of `submitted_at` (in
+    `format_job_queue()`), because the job may stay in PENDING if the cluster is
+    busy.
     """
     field = 'end_at' if get_ended_time else 'submitted_at'
     rows = _CURSOR.execute(f'SELECT {field} FROM jobs WHERE job_id=(?)',
                            (job_id,))
     for (timestamp,) in rows:
         return common_utils.encode_payload(timestamp)
     return common_utils.encode_payload(None)
@@ -876,23 +875,23 @@
         # Used only for restarting a cluster.
         code = ['job_lib.fail_all_jobs_in_progress()']
         return cls._build(code)
 
     @classmethod
     def tail_logs(cls,
                   job_id: Optional[int],
-                  spot_job_id: Optional[int],
+                  managed_job_id: Optional[int],
                   follow: bool = True) -> str:
         # pylint: disable=line-too-long
         code = [
-            f'job_id = {job_id} if {job_id} is not None else job_lib.get_latest_job_id()',
+            f'job_id = {job_id} if {job_id} != None else job_lib.get_latest_job_id()',
             'run_timestamp = job_lib.get_run_timestamp(job_id)',
             f'log_dir = None if run_timestamp is None else os.path.join({constants.SKY_LOGS_DIRECTORY!r}, run_timestamp)',
             f'log_lib.tail_logs(job_id=job_id, log_dir=log_dir, '
-            f'spot_job_id={spot_job_id!r}, follow={follow}, **job_owner_kwargs)',
+            f'managed_job_id={managed_job_id!r}, follow={follow}, **job_owner_kwargs)',
         ]
         return cls._build(code)
 
     @classmethod
     def get_job_status(cls, job_ids: Optional[List[int]] = None) -> str:
         # Prints "Job <id> <status>" for UX; caller should parse the last token.
         code = [
@@ -929,8 +928,8 @@
         ]
         return cls._build(code)
 
     @classmethod
     def _build(cls, code: List[str]) -> str:
         code = cls._PREFIX + code
         code = ';'.join(code)
-        return f'python3 -u -c {shlex.quote(code)}'
+        return f'{constants.SKY_PYTHON_CMD} -u -c {shlex.quote(code)}'
```

### Comparing `skypilot-0.5.0/sky/skylet/log_lib.py` & `skypilot-0.6.0/sky/skylet/log_lib.py`

 * *Files 2% similar despite different names*

```diff
@@ -2,14 +2,15 @@
 
 This is a remote utility module that provides logging functionality.
 """
 import copy
 import io
 import multiprocessing.pool
 import os
+import shlex
 import subprocess
 import sys
 import tempfile
 import textwrap
 import time
 from typing import Dict, Iterator, List, Optional, Tuple, Union
 
@@ -180,16 +181,30 @@
             # open a new subprocess to gracefully kill the proc, SIGTERM
             # and then SIGKILL the process group.
             # Adapted from ray/dashboard/modules/job/job_manager.py#L154
             parent_pid = os.getpid()
             daemon_script = os.path.join(
                 os.path.dirname(os.path.abspath(job_lib.__file__)),
                 'subprocess_daemon.py')
+            if not hasattr(constants, 'SKY_GET_PYTHON_PATH_CMD'):
+                # Backward compatibility: for cluster started before #3326, this
+                # constant does not exist. Since we generate the job script
+                # in backends.cloud_vm_ray_backend with inspect, so the
+                # the lates `run_with_log` will be used, but the `constants` is
+                # not updated. We fallback to `python3` in this case.
+                # TODO(zhwu): remove this after 0.7.0.
+                python_path = 'python3'
+            else:
+                python_path = subprocess.check_output(
+                    constants.SKY_GET_PYTHON_PATH_CMD,
+                    shell=True,
+                    stderr=subprocess.DEVNULL,
+                    encoding='utf-8').strip()
             daemon_cmd = [
-                'python3',
+                python_path,
                 daemon_script,
                 '--parent-pid',
                 str(parent_pid),
                 '--proc-pid',
                 str(proc.pid),
             ]
 
@@ -257,15 +272,15 @@
             . $(conda info --base 2> /dev/null)/etc/profile.d/conda.sh > /dev/null 2>&1 || true
             set +a
             export PYTHONUNBUFFERED=1
             cd {constants.SKY_REMOTE_WORKDIR}"""),
     ]
     if env_vars is not None:
         for k, v in env_vars.items():
-            script.append(f'export {k}="{v}"')
+            script.append(f'export {k}={shlex.quote(str(v))}')
     script += [
         codegen,
         '',  # New line at EOF.
     ]
     script = '\n'.join(script)
     return script
 
@@ -360,39 +375,40 @@
 
             time.sleep(_SKY_LOG_TAILING_GAP_SECONDS)
             status = job_lib.get_status_no_lock(job_id)
 
 
 def tail_logs(job_id: Optional[int],
               log_dir: Optional[str],
-              spot_job_id: Optional[int] = None,
+              managed_job_id: Optional[int] = None,
               follow: bool = True) -> None:
     """Tail the logs of a job.
 
     Args:
         job_id: The job id.
         log_dir: The log directory of the job.
-        spot_job_id: The spot job id (for logging info only to avoid confusion).
+        managed_job_id: The managed job id (for logging info only to avoid
+            confusion).
         follow: Whether to follow the logs or print the logs so far and exit.
     """
     if job_id is None:
         # This only happens when job_lib.get_latest_job_id() returns None,
         # which means no job has been submitted to this cluster. See
         # sky.skylet.job_lib.JobLibCodeGen.tail_logs for more details.
         logger.info('Skip streaming logs as no job has been submitted.')
         return
     job_str = f'job {job_id}'
-    if spot_job_id is not None:
-        job_str = f'spot job {spot_job_id}'
+    if managed_job_id is not None:
+        job_str = f'managed job {managed_job_id}'
     if log_dir is None:
         print(f'{job_str.capitalize()} not found (see `sky queue`).',
               file=sys.stderr)
         return
-    logger.debug(f'Tailing logs for job, real job_id {job_id}, spot_job_id '
-                 f'{spot_job_id}.')
+    logger.debug(f'Tailing logs for job, real job_id {job_id}, managed_job_id '
+                 f'{managed_job_id}.')
     logger.info(f'{colorama.Fore.YELLOW}Start streaming logs for {job_str}.'
                 f'{colorama.Style.RESET_ALL}')
     log_path = os.path.join(log_dir, 'run.log')
     log_path = os.path.expanduser(log_path)
 
     status = job_lib.update_job_status([job_id], silent=True)[0]
```

### Comparing `skypilot-0.5.0/sky/skylet/log_lib.pyi` & `skypilot-0.6.0/sky/skylet/log_lib.pyi`

 * *Files 4% similar despite different names*

```diff
@@ -116,10 +116,10 @@
                               stream_logs: bool = ...,
                               with_ray: bool = ...):
     ...
 
 
 def tail_logs(job_id: int,
               log_dir: Optional[str],
-              spot_job_id: Optional[int] = ...,
+              managed_job_id: Optional[int] = ...,
               follow: bool = ...) -> None:
     ...
```

### Comparing `skypilot-0.5.0/sky/skylet/providers/azure/azure-config-template.json` & `skypilot-0.6.0/sky/skylet/providers/azure/azure-config-template.json`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/skylet/providers/azure/azure-vm-template.json` & `skypilot-0.6.0/sky/skylet/providers/azure/azure-vm-template.json`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/skylet/providers/azure/config.py` & `skypilot-0.6.0/sky/skylet/providers/azure/config.py`

 * *Files 2% similar despite different names*

```diff
@@ -116,14 +116,16 @@
             },
         }
     }
 
     create_or_update = get_azure_sdk_function(
         client=resource_client.deployments, function_name="create_or_update"
     )
+    # TODO (skypilot): this takes a long time (> 40 seconds) for stopping an
+    # azure VM, and this can be called twice during ray down.
     outputs = (
         create_or_update(
             resource_group_name=resource_group,
             deployment_name="ray-config",
             parameters=parameters,
         )
         .result()
```

### Comparing `skypilot-0.5.0/sky/skylet/providers/azure/node_provider.py` & `skypilot-0.6.0/sky/skylet/providers/azure/node_provider.py`

 * *Files 3% similar despite different names*

```diff
@@ -11,14 +11,15 @@
 from azure.mgmt.resource import ResourceManagementClient
 from azure.mgmt.resource.resources.models import DeploymentMode
 
 from sky.skylet.providers.azure.config import (
     bootstrap_azure,
     get_azure_sdk_function,
 )
+from sky.skylet import autostop_lib
 from sky.skylet.providers.command_runner import SkyDockerCommandRunner
 from sky.provision import docker_utils
 
 from ray.autoscaler._private.command_runner import SSHCommandRunner
 from ray.autoscaler.node_provider import NodeProvider
 from ray.autoscaler.tags import (
     TAG_RAY_CLUSTER_NAME,
@@ -57,24 +58,31 @@
     Nodes may be in one of three states: {pending, running, terminated}. Nodes
     appear immediately once started by ``create_node``, and transition
     immediately to terminated when ``terminate_node`` is called.
     """
 
     def __init__(self, provider_config, cluster_name):
         NodeProvider.__init__(self, provider_config, cluster_name)
-        # TODO(suquark): This is a temporary patch for resource group.
-        # By default, Ray autoscaler assumes the resource group is still here even
-        # after the whole cluster is destroyed. However, now we deletes the resource
-        # group after tearing down the cluster. To comfort the autoscaler, we need
-        # to create/update it here, so the resource group always exists.
-        from sky.skylet.providers.azure.config import _configure_resource_group
-
-        _configure_resource_group(
-            {"cluster_name": cluster_name, "provider": provider_config}
-        )
+        if not autostop_lib.get_is_autostopping():
+            # TODO(suquark): This is a temporary patch for resource group.
+            # By default, Ray autoscaler assumes the resource group is still
+            # here even after the whole cluster is destroyed. However, now we
+            # deletes the resource group after tearing down the cluster. To
+            # comfort the autoscaler, we need to create/update it here, so the
+            # resource group always exists.
+            #
+            # We should not re-configure the resource group again, when it is
+            # running on the remote VM and the autostopping is in progress,
+            # because the VM is running which guarantees the resource group
+            # exists.
+            from sky.skylet.providers.azure.config import _configure_resource_group
+
+            _configure_resource_group(
+                {"cluster_name": cluster_name, "provider": provider_config}
+            )
         subscription_id = provider_config["subscription_id"]
         self.cache_stopped_nodes = provider_config.get("cache_stopped_nodes", True)
         # Sky only supports Azure CLI credential for now.
         # Increase the timeout to fix the Azure get-access-token (used by ray azure
         # node_provider) timeout issue.
         # Tracked in https://github.com/Azure/azure-cli/issues/20404#issuecomment-1249575110
         credential = AzureCliCredential(process_timeout=30)
@@ -112,15 +120,20 @@
 
         # get status
         resource_group = self.provider_config["resource_group"]
         instance = self.compute_client.virtual_machines.instance_view(
             resource_group_name=resource_group, vm_name=vm.name
         ).as_dict()
         for status in instance["statuses"]:
-            code, state = status["code"].split("/")
+            code_state = status["code"].split("/")
+            # It is possible that sometimes the 'code' is empty string, and we
+            # should skip them.
+            if len(code_state) != 2:
+                continue
+            code, state = code_state
             # skip provisioning status
             if code == "PowerState":
                 metadata["status"] = state
                 break
 
         # get ip data
         nic_id = vm.network_profile.network_interfaces[0].id
```

### Comparing `skypilot-0.5.0/sky/skylet/providers/command_runner.py` & `skypilot-0.6.0/sky/skylet/providers/command_runner.py`

 * *Files 4% similar despite different names*

```diff
@@ -225,14 +225,27 @@
                         break
             except json.JSONDecodeError as e:
                 cli_logger.error(
                     'Unable to deserialize `image_env` to Python object. '
                     f'The `image_env` is:\n{image_env}')
                 raise e
 
+            # Edit docker config first to avoid disconnecting the container
+            # from GPUs when a systemctl command is called. This is a known
+            # issue with nvidia container toolkit:
+            # https://github.com/NVIDIA/nvidia-container-toolkit/issues/48
+            self.run(
+                '[ -f /etc/docker/daemon.json ] || '
+                'echo "{}" | sudo tee /etc/docker/daemon.json;'
+                'sudo jq \'.["exec-opts"] = ["native.cgroupdriver=cgroupfs"]\' '
+                '/etc/docker/daemon.json > /tmp/daemon.json;'
+                'sudo mv /tmp/daemon.json /etc/docker/daemon.json;'
+                'sudo systemctl restart docker',
+                run_env='host')
+
             user_docker_run_options = self.docker_config.get(
                 'run_options', []) + self.docker_config.get(
                     f'{"head" if as_head else "worker"}_run_options', [])
             start_command = docker_start_cmds(
                 self.ssh_command_runner.ssh_user,
                 specific_image,
                 cleaned_bind_mounts,
```

### Comparing `skypilot-0.5.0/sky/skylet/providers/gcp/config.py` & `skypilot-0.6.0/sky/skylet/providers/ibm/vpc_provider.py`

 * *Files 26% similar despite different names*

```diff
@@ -1,1152 +1,837 @@
+"""
+module allocating VPC - network namespace and configuration
+for Ray's cluster. used by the node_provider module to group the
+nodes under the same subnet, tagged by the same cluster name.
+"""
+
 import copy
 import json
-import logging
-import os
+import textwrap
 import time
-from functools import partial
-import typing
-from typing import Dict, List, Set, Tuple
-
-from cryptography.hazmat.backends import default_backend
-from cryptography.hazmat.primitives import serialization
-from cryptography.hazmat.primitives.asymmetric import rsa
-from google.oauth2 import service_account
-from google.oauth2.credentials import Credentials as OAuthCredentials
-from googleapiclient import discovery, errors
-
-if typing.TYPE_CHECKING:
-    import google
-
-from sky.skylet.providers.gcp.node import (
-    MAX_POLLS,
-    POLL_INTERVAL,
-    GCPNodeType,
-    GCPCompute,
-)
-from sky.skylet.providers.gcp.constants import (
-    SKYPILOT_VPC_NAME,
-    VPC_TEMPLATE,
-    FIREWALL_RULES_TEMPLATE,
-    FIREWALL_RULES_REQUIRED,
-    VM_MINIMAL_PERMISSIONS,
-    TPU_MINIMAL_PERMISSIONS,
-)
-from sky.utils import common_utils
-from ray.autoscaler._private.util import check_legacy_fields
-
-logger = logging.getLogger(__name__)
-
-VERSION = "v1"
-TPU_VERSION = "v2alpha"  # change once v2 is stable
-
-RAY = "ray-autoscaler"
-DEFAULT_SERVICE_ACCOUNT_ID = RAY + "-sa-" + VERSION
-SERVICE_ACCOUNT_EMAIL_TEMPLATE = "{account_id}@{project_id}.iam.gserviceaccount.com"
-DEFAULT_SERVICE_ACCOUNT_CONFIG = {
-    "displayName": "Ray Autoscaler Service Account ({})".format(VERSION),
-}
-
-SKYPILOT = "skypilot"
-SKYPILOT_SERVICE_ACCOUNT_ID = SKYPILOT + "-" + VERSION
-SKYPILOT_SERVICE_ACCOUNT_EMAIL_TEMPLATE = (
-    "{account_id}@{project_id}.iam.gserviceaccount.com"
-)
-SKYPILOT_SERVICE_ACCOUNT_CONFIG = {
-    "displayName": "SkyPilot Service Account ({})".format(VERSION),
-}
+import uuid
+from concurrent.futures import ThreadPoolExecutor
 
-# Those roles will be always added.
-# NOTE: `serviceAccountUser` allows the head node to create workers with
-# a serviceAccount. `roleViewer` allows the head node to run bootstrap_gcp.
-DEFAULT_SERVICE_ACCOUNT_ROLES = [
-    "roles/storage.objectAdmin",
-    "roles/compute.admin",
-    "roles/iam.serviceAccountUser",
-    "roles/iam.roleViewer",
-]
-# Those roles will only be added if there are TPU nodes defined in config.
-TPU_SERVICE_ACCOUNT_ROLES = ["roles/tpu.admin"]
-
-# If there are TPU nodes in config, this field will be set
-# to True in config["provider"].
-HAS_TPU_PROVIDER_FIELD = "_has_tpus"
+import requests
 
-# NOTE: iam.serviceAccountUser allows the Head Node to create worker nodes
-# with ServiceAccounts.
+from sky.adaptors import ibm
+from sky.skylet.providers.ibm.utils import RAY_RECYCLABLE, get_logger
 
+# pylint: disable=line-too-long
+logger = get_logger("vpc_provider_")
+REQUIRED_RULES = {
+    "outbound_tcp_all": "selected security group is missing rule permitting outbound TCP access\n",
+    "outbound_udp_all": "selected security group is missing rule permitting outbound UDP access\n",
+    "inbound_tcp_sg": "selected security group is missing rule permitting inbound tcp traffic inside selected security group\n",
+    "inbound_tcp_22": "selected security group is missing rule permitting inbound traffic to tcp port 22 required for ssh\n",
+}
+INSECURE_RULES = {
+    "inbound_tcp_6379": "selected security group is missing rule permitting inbound traffic to tcp port 6379 required for Redis\n",
+    "inbound_tcp_8265": "selected security group is missing rule permitting inbound traffic to tcp port 8265 required to access Ray Dashboard\n",
+}
+REQUIRED_RULES.update(INSECURE_RULES)
 
-def _skypilot_log_error_and_exit_for_failover(error: str) -> None:
-    """Logs an message then raises a specific RuntimeError to trigger failover.
 
-    Mainly used for handling VPC/subnet errors before nodes are launched.
+class IBMVPCProvider:
     """
-    # NOTE: keep. The backend looks for this to know no nodes are launched.
-    prefix = "SKYPILOT_ERROR_NO_NODES_LAUNCHED: "
-    raise RuntimeError(prefix + error)
-
-
-def get_node_type(node: dict) -> GCPNodeType:
-    """Returns node type based on the keys in ``node``.
-
-    This is a very simple check. If we have a ``machineType`` key,
-    this is a Compute instance. If we don't have a ``machineType`` key,
-    but we have ``acceleratorType``, this is a TPU. Otherwise, it's
-    invalid and an exception is raised.
-
-    This works for both node configs and API returned nodes.
+    Manages a vpc containing the network configuration for the cluster's nodes.
     """
 
-    if "machineType" not in node and "acceleratorType" not in node:
-        raise ValueError(
-            "Invalid node. For a Compute instance, 'machineType' is "
-            "required. "
-            "For a TPU instance, 'acceleratorType' and no 'machineType' "
-            "is required. "
-            f"Got {list(node)}"
-        )
-
-    if "machineType" not in node and "acceleratorType" in node:
-        return GCPNodeType.TPU
-    return GCPNodeType.COMPUTE
-
-
-def wait_for_crm_operation(operation, crm):
-    """Poll for cloud resource manager operation until finished."""
-    logger.info(
-        "wait_for_crm_operation: "
-        "Waiting for operation {} to finish...".format(operation)
-    )
-
-    for _ in range(MAX_POLLS):
-        result = crm.operations().get(name=operation["name"]).execute()
-        if "error" in result:
-            raise Exception(result["error"])
+    def __init__(self, resource_group_id, region, cluster_name):
+        self.vpc_client = ibm.client(region=region)
+        self.search_client = ibm.search_client()
+        self.tagging_client = ibm.tagging_client()
+        self.resource_group_id = resource_group_id
+        self.cluster_name = cluster_name
+        ## region and zone might change between failovers
+        self.region = None
+        self.zone = None
 
-        if "done" in result and result["done"]:
-            logger.info("wait_for_crm_operation: Operation done.")
-            break
+    def create_or_fetch_vpc(self, region, zone):
+        """
+        returns a cluster with tag matching the cluster name if exists, else creates one.
+        an entry point (out of 2) to this module.
+        """
 
-        time.sleep(POLL_INTERVAL)
+        # refresh client region scope if region changed.
+        if self.region and self.region != region:
+            self.vpc_client = ibm.client(region=region)
+        self.region = region
+        self.zone = zone
+        reused_vpc_data = None
+        # pylint: disable=line-too-long
+        vpcs_filtered_by_tags_and_region = self.search_client.search(
+            query=f"type:vpc AND tags:{self.cluster_name} AND region:{self.region}",
+            fields=["tags", "region", "type"],
+            limit=1000,
+        ).get_result()["items"]
+        for vpc in vpcs_filtered_by_tags_and_region:
+            vpc_id = vpc["crn"].rsplit(":", 1)[-1]
+            vpc_data = self.get_vpc_data(vpc_id, self.region)
+            if vpc_data["status"] == "available":
+                reused_vpc_data = vpc_data
+                break
+        # found vpc tagged with cluster name in the required region
+        if reused_vpc_data:
+            # using self.region since tagged vpc is in the same region
+            subnets = self.get_vpc_subnets(reused_vpc_data, self.region)
+            subnet_in_zone = next(
+                (subnet for subnet in subnets if subnet["zone"]["name"] == self.zone),
+                None,
+            )
+            # found a subnet in the required zone
+            if subnet_in_zone:
+                subnet_id = subnet_in_zone["id"]
+                public_gateway = subnet_in_zone.get("public_gateway")
+                if not public_gateway:
+                    public_gateway = self.create_public_gateway(
+                        reused_vpc_data["id"], self.zone, subnet_in_zone
+                    )
+            # tagged vpc found doesn't have a subnet in the required zone
+            else:
+                subnet_data = self.create_subnet(reused_vpc_data["id"], self.zone)
+                subnet_id = subnet_data["id"]
+                public_gateway = self.create_public_gateway(
+                    reused_vpc_data["id"], self.zone, subnet_data
+                )
 
-    return result
+            # add missing security group rules if needed
+            security_group = reused_vpc_data.get("default_security_group")
+            if security_group:
+                sg_id = security_group["id"]
+                self.add_missing_sg_rules(sg_id)
+
+                # managed to reuse found VPC
+                logger.info(
+                    f"Reusing VPC {reused_vpc_data['id']} named: {reused_vpc_data['name']}"
+                )
+                return {
+                    "vpc_id": reused_vpc_data["id"],
+                    "subnet_id": subnet_id,
+                    "security_group_id": sg_id,
+                }
 
+        # delete a tagged vpc that doesn't meet requirements
+        if reused_vpc_data:
+            self.delete_vpc(reused_vpc_data["id"], self.region)
+        # create a new vpc
+        vpc_tags = self.create_vpc()
+        return vpc_tags
+
+    def create_vpc(self):
+        """creates a vpc, tags it and return key values pertaining it.
+
+        uuid is added to vpc name to avoid naming collision.
+        vpc is tagged using the exact cluster name, as appears on
+            the cluster's config file.
 
-def wait_for_compute_global_operation(project_name, operation, compute):
-    """Poll for global compute operation until finished."""
-    logger.info(
-        "wait_for_compute_global_operation: "
-        "Waiting for operation {} to finish...".format(operation["name"])
-    )
+        Returns:
+            dict: containing the keys: vpc_id, subnet_id
+                    and security_group_id
+        """
+        vpc_data = self.vpc_client.create_vpc(
+            address_prefix_management="auto",
+            classic_access=False,
+            name=f"sky-vpc-{self.cluster_name}-{str(uuid.uuid4())[:5]}",
+            resource_group={"id": self.resource_group_id},
+        ).get_result()
+        subnet_data = self.create_subnet(vpc_data["id"], self.zone)
+        self.create_public_gateway(vpc_data["id"], self.zone, subnet_data)
+        sg_id = self.create_sg_rules(vpc_data)
+
+        # tag vpc with the cluster's name
+        resource_model = {"resource_id": vpc_data["crn"]}
+        self.tagging_client.attach_tag(
+            resources=[resource_model], tag_names=[self.cluster_name], tag_type="user"
+        ).get_result()
+
+        return {
+            "vpc_id": vpc_data["id"],
+            "subnet_id": subnet_data["id"],
+            "security_group_id": sg_id,
+        }
 
-    for _ in range(MAX_POLLS):
-        result = (
-            compute.globalOperations()
-            .get(
-                project=project_name,
-                operation=operation["name"],
+    def create_subnet(self, vpc_id, zone_name):
+        ipv4_cidr_block = None
+        subnet_name = f"sky-subnet-{self.cluster_name}-{str(uuid.uuid4())[:5]}"
+        res = self.vpc_client.list_vpc_address_prefixes(vpc_id).get_result()
+
+        # searching for the CIDR block (internal ip range) matching the
+        # specified zone of a VPC (whose region has already been set)
+        address_prefixes = res["address_prefixes"]
+        ipv4_cidr_block = next(
+            (
+                address_prefix["cidr"]
+                for address_prefix in address_prefixes
+                if address_prefix["zone"]["name"] == zone_name
+            ),
+            None,
+        )
+        if not ipv4_cidr_block:
+            raise Exception(
+                "Failed to locate a cidr block "
+                f"Matching the zone name: {zone_name} to create "
+                "a subnet"
             )
-            .execute()
-        )
-        if "error" in result:
-            raise Exception(result["error"])
-
-        if result["status"] == "DONE":
-            logger.info("wait_for_compute_global_operation: Operation done.")
-            break
-
-        time.sleep(POLL_INTERVAL)
-
-    return result
 
+        subnet_prototype = {}
+        subnet_prototype["zone"] = {"name": zone_name}
+        subnet_prototype["ip_version"] = "ipv4"
+        subnet_prototype["name"] = subnet_name
+        subnet_prototype["resource_group"] = {"id": self.resource_group_id}
+        subnet_prototype["vpc"] = {"id": vpc_id}
+        subnet_prototype["ipv4_cidr_block"] = ipv4_cidr_block
+
+        subnet_data = self.vpc_client.create_subnet(subnet_prototype).get_result()
+        return subnet_data
+
+    def create_public_gateway(self, vpc_id, zone_name, subnet_data):
+
+        gateway_prototype = {}
+        gateway_prototype["vpc"] = {"id": vpc_id}
+        gateway_prototype["zone"] = {"name": zone_name}
+        gateway_prototype["name"] = f"{subnet_data['name']}-gw"
+        gateway_prototype["resource_group"] = {"id": self.resource_group_id}
+        gateway_data = self.vpc_client.create_public_gateway(
+            **gateway_prototype
+        ).get_result()
+        gateway_id = gateway_data["id"]
+
+        self.vpc_client.set_subnet_public_gateway(subnet_data["id"], {"id": gateway_id})
+        return gateway_id
+
+    def create_sg_rules(self, vpc_data):
+
+        sg_id = vpc_data["default_security_group"]["id"]
+        sg_name = f"{self.cluster_name}-{str(uuid.uuid4())[:5]}-sg"
+
+        # update sg name
+        self.vpc_client.update_security_group(
+            sg_id, security_group_patch={"name": sg_name}
+        )
+
+        # open private tcp traffic between VSIs within the security group
+        sg_rule_prototype = _build_security_group_rule_prototype_model(
+            "inbound_tcp_sg", sg_id=sg_id
+        )
+        self.vpc_client.create_security_group_rule(
+            sg_id, sg_rule_prototype
+        ).get_result()
+
+        # add all other required rules configured by the specific backend
+        for rule in REQUIRED_RULES.keys():
+            sg_rule_prototype = _build_security_group_rule_prototype_model(rule)
+            if sg_rule_prototype:
+                self.vpc_client.create_security_group_rule(
+                    sg_id, sg_rule_prototype
+                ).get_result()
+
+        return sg_id
+
+    def get_vpc_data(self, vpc_id, region):
+        """returns vpc data if exists, else None"""
+        if not vpc_id:
+            return None
+        tmp_vpc_client = ibm.client(region=region)
+        try:
+            vpc_data = tmp_vpc_client.get_vpc(vpc_id).result
+            return vpc_data
+        except ibm.ibm_cloud_sdk_core.ApiException as e:
+            if e.code == 404:
+                logger.debug("VPC doesn't exist.")
+                return None
+            else:
+                raise
 
-def key_pair_name(i, region, project_id, ssh_user):
-    """Returns the ith default gcp_key_pair_name."""
-    key_name = "{}_gcp_{}_{}_{}_{}".format(SKYPILOT, region, project_id, ssh_user, i)
-    return key_name
+    def get_vpc_subnets(self, vpc_data, region, field=""):
+        """return data on subnets belonging to specified vpc within
+        the specified region.
+
+        if 'field' is specified narrowing data returned to
+        data['field'] (for each subnet)
+
+        Args:
+            vpc_data (str): vpc data as received from vpc client.
+            region (str): ibm vpc region.
+            field (str, optional): field within the subnet data response from vpc
+              client's list_subnets()/get_subnet() response. Defaults to ''.
 
+        Returns:
+            str: data on all subnets belonging to the specified vpc.
+        """
+        if not vpc_data:
+            return None
+        # pylint: disable=line-too-long
+        tmp_vpc_client = ibm.client(region=region)
+        subnets_attached_to_routing_table = tmp_vpc_client.list_subnets(
+            routing_table_id=vpc_data["default_routing_table"]["id"]
+        ).get_result()["subnets"]
+        if field:
+            return [subnet[field] for subnet in subnets_attached_to_routing_table]
+        else:
+            return subnets_attached_to_routing_table
 
-def key_pair_paths(key_name):
-    """Returns public and private key paths for a given key_name."""
-    public_key_path = os.path.expanduser("~/.ssh/{}.pub".format(key_name))
-    private_key_path = os.path.expanduser("~/.ssh/{}.pem".format(key_name))
-    return public_key_path, private_key_path
+    def delete_vpc(self, vpc_id, region):
+        """
+        deletes a vpc with the specified id and region.
+        an entry point to this module (alongside create_or_fetch_vpc)
+        """
+        logger.debug(f"Deleting vpc: {vpc_id}")
+        tmp_vpc_client = ibm.client(region=region)
+        vpc_data = self.get_vpc_data(vpc_id, region)
+        if not vpc_data:
+            logger.warn(f"vpc:{vpc_id} is set for deletion, but wasn't found")
+            return None
+        self.delete_vms(tmp_vpc_client, vpc_id)
+        self.delete_subnets(tmp_vpc_client, vpc_data, region)
+        self.delete_gateways(tmp_vpc_client, vpc_id)
+        # at this point vpc was already verified to be existing
+        # thus no relevant exception to catch when deleting.
+        tmp_vpc_client.delete_vpc(vpc_id)
+
+    def delete_vms(self, vpc_client, vpc_id):
+        def _poll_vpc_contains_vms(vpc_id):
+            tries = 60
+            sleep_interval = 3
+            while tries:
+                # list_instances() never raise an exception, check values instead
+                res = vpc_client.list_instances(vpc_id=vpc_id).get_result()
+                if not res["total_count"]:
+                    return True
+                else:
+                    tries -= 1
+                    time.sleep(sleep_interval)
+            raise Exception(
+                "Failed to delete VPC's instances within "
+                "the expected time frame. Cannot "
+                "continue to delete VPC."
+            )
 
+        def _del_instance(vm_data):
+            # first delete ips created by node_provider
+            nic_id = vm_data["network_interfaces"][0]["id"]
+            res = vpc_client.list_instance_network_interface_floating_ips(
+                vm_data["id"], nic_id
+            ).get_result()
+            floating_ips = res.get("floating_ips", [])
+            for ip in floating_ips:
+                if ip["name"].startswith(RAY_RECYCLABLE):
+                    logger.debug(f"Deleting IP: {ip['id']}")
+                    vpc_client.delete_floating_ip(ip["id"])
+            logger.debug(f"Deleting VM: {vm_data['id']}")
+            vpc_client.delete_instance(id=vm_data["id"])
+
+        # pylint: disable=line-too-long E1136
+        res = vpc_client.list_instances(vpc_id=vpc_id).get_result()
+        num_instances = res["total_count"]
+
+        # Delete VSIs if exist
+        if num_instances:
+            instances = res["instances"]
+            with ThreadPoolExecutor(num_instances) as ex:
+                for i in range(num_instances):
+                    ex.submit(_del_instance, instances[i])
+            # wait until all vms are deleted to proceed
+            _poll_vpc_contains_vms(vpc_id)
+
+    def delete_subnets(self, vpc_client, vpc_data, region):
+        def _poll_subnet_deleted(subnet_id):
+            tries = 10
+            sleep_interval = 2
+            while tries:
+                try:
+                    vpc_client.get_subnet(subnet_id).get_result()
+                except ibm.ibm_cloud_sdk_core.ApiException:
+                    logger.debug(f"Deleted subnet id: {subnet_id}")
+                    return True
+                tries -= 1
+                time.sleep(sleep_interval)
+            logger.error("Failed to delete instance within the alloted time\n")
+            return False
 
-def generate_rsa_key_pair():
-    """Create public and private ssh-keys."""
+        for subnet_id in self.get_vpc_subnets(vpc_data, region, field="id"):
+            # get_result() used for synchronization
+            logger.debug(f"Deleting subnet: {subnet_id}")
+            vpc_client.delete_subnet(subnet_id).get_result()
+            _poll_subnet_deleted(subnet_id)
+
+    def delete_gateways(self, vpc_client, vpc_id):
+        """deletes all gateways attached to the specified vpc"""
+        # pylint: disable=line-too-long
+        gateways = vpc_client.list_public_gateways(
+            resource_group_id=self.resource_group_id
+        ).get_result()["public_gateways"]
+        gateways_ids_of_vpc = [
+            gateway["id"] for gateway in gateways if gateway["vpc"]["id"] == vpc_id
+        ]
+        for gateway_id in gateways_ids_of_vpc:
+            # get_result() used for synchronization
+            logger.debug(f"Deleting gateway: {gateway_id}")
+            vpc_client.delete_public_gateway(gateway_id).get_result()
+
+    def add_missing_sg_rules(self, sec_group_id):
+        missing_rules = self.get_unsatisfied_security_group_rules(sec_group_id)
+
+        if missing_rules:
+            for val in missing_rules.values():
+                logger.debug(f"missing {val}")
+            for missing_rule in missing_rules.keys():
+                sg_rule_prototype = _build_security_group_rule_prototype_model(
+                    missing_rule, sec_group_id
+                )
+                self.vpc_client.create_security_group_rule(
+                    sec_group_id, sg_rule_prototype
+                ).get_result()
 
-    key = rsa.generate_private_key(
-        backend=default_backend(), public_exponent=65537, key_size=2048
-    )
+    def get_unsatisfied_security_group_rules(self, sg_id):
+        """
+        returns unsatisfied security group rules.
+        """
 
-    public_key = (
-        key.public_key()
-        .public_bytes(
-            serialization.Encoding.OpenSSH, serialization.PublicFormat.OpenSSH
-        )
-        .decode("utf-8")
-    )
+        unsatisfied_rules = copy.deepcopy(REQUIRED_RULES)
+        sg = self.vpc_client.get_security_group(sg_id).get_result()
 
-    pem = key.private_bytes(
-        encoding=serialization.Encoding.PEM,
-        format=serialization.PrivateFormat.TraditionalOpenSSL,
-        encryption_algorithm=serialization.NoEncryption(),
-    ).decode("utf-8")
-
-    return public_key, pem
-
-
-def _has_tpus_in_node_configs(config: dict) -> bool:
-    """Check if any nodes in config are TPUs."""
-    node_configs = [
-        node_type["node_config"]
-        for node_type in config["available_node_types"].values()
-    ]
-    return any(get_node_type(node) == GCPNodeType.TPU for node in node_configs)
-
-
-def _is_head_node_a_tpu(config: dict) -> bool:
-    """Check if the head node is a TPU."""
-    node_configs = {
-        node_id: node_type["node_config"]
-        for node_id, node_type in config["available_node_types"].items()
+        for rule in sg["rules"]:
+            # pylint: disable=line-too-long
+            # check outbound rules that are not associated with a specific IP address range
+            if rule["direction"] == "outbound" and rule["remote"] == {
+                "cidr_block": "0.0.0.0/0"
+            }:
+                if rule["protocol"] == "all":
+                    # outbound is fine!
+                    unsatisfied_rules.pop("outbound_tcp_all", None)
+                    unsatisfied_rules.pop("outbound_udp_all", None)
+                elif rule["protocol"] == "tcp":
+                    unsatisfied_rules.pop("outbound_tcp_all", None)
+                elif rule["protocol"] == "udp":
+                    unsatisfied_rules.pop("outbound_udp_all", None)
+
+            # Check inbound rules
+            elif rule["direction"] == "inbound":
+                # check rules that are not associated with a specific IP address range
+                if rule["remote"] == {"cidr_block": "0.0.0.0/0"}:
+                    # we interested only in all or tcp protocols
+                    if rule["protocol"] == "all":
+                        # there a rule permitting all traffic
+                        unsatisfied_rules.pop("inbound_tcp_sg", None)
+                        unsatisfied_rules.pop("inbound_tcp_22", None)
+                        unsatisfied_rules.pop("inbound_tcp_6379", None)
+                        unsatisfied_rules.pop("inbound_tcp_8265", None)
+
+                    elif rule["protocol"] == "tcp":
+                        if rule["port_min"] == 1 and rule["port_max"] == 65535:
+                            # all ports are open
+                            unsatisfied_rules.pop("inbound_tcp_sg", None)
+                            unsatisfied_rules.pop("inbound_tcp_22", None)
+                            unsatisfied_rules.pop("inbound_tcp_6379", None)
+                            unsatisfied_rules.pop("inbound_tcp_8265", None)
+                        else:
+                            port_min = rule["port_min"]
+                            port_max = rule["port_max"]
+                            if port_min <= 22 and port_max >= 22:
+                                unsatisfied_rules.pop("inbound_tcp_22", None)
+                            elif port_min <= 6379 and port_max >= 6379:
+                                unsatisfied_rules.pop("inbound_tcp_6379", None)
+                            elif port_min <= 8265 and port_max >= 8265:
+                                unsatisfied_rules.pop("inbound_tcp_8265", None)
+
+                # rule regards private traffic within the VSIs associated with the security group
+                elif rule["remote"].get("id") == sg["id"]:
+                    # validate that inbound traffic inside group available
+                    if rule["protocol"] == "all" or rule["protocol"] == "tcp":
+                        unsatisfied_rules.pop("inbound_tcp_sg", None)
+
+        return unsatisfied_rules
+
+    def remote_cluster_removal(self, vpc_id, region):
+        """deletes the vpc and its associated resources
+        using the FaaS service: ibm cloud functions.
+        Used only when cluster is set to be deleted
+        remotely, e.g. by `sky autostop --down`"""
+        cc = ClusterCleaner(self.resource_group_id, vpc_id, region)
+        cc.delete_cluster()
+
+
+def _build_security_group_rule_prototype_model(missing_rule, sg_id=None):
+    direction, protocol, port = missing_rule.split("_")
+    remote = {"cidr_block": "0.0.0.0/0"}
+
+    try:  # port number was specified
+        port = int(port)
+        port_min = port
+        port_max = port
+    # pylint: disable=W0703
+    except Exception:
+        port_min = 1
+        port_max = 65535
+
+        # only valid if security group already exists
+        if port == "sg":
+            if not sg_id:
+                return None
+            remote = {"id": sg_id}
+
+    return {
+        "direction": direction,
+        "ip_version": "ipv4",
+        "protocol": protocol,
+        "remote": remote,
+        "port_min": port_min,
+        "port_max": port_max,
     }
-    return get_node_type(node_configs[config["head_node_type"]]) == GCPNodeType.TPU
 
 
-def _create_crm(gcp_credentials=None):
-    return discovery.build(
-        "cloudresourcemanager", "v1", credentials=gcp_credentials, cache_discovery=False
-    )
-
-
-def _create_iam(gcp_credentials=None):
-    return discovery.build(
-        "iam", "v1", credentials=gcp_credentials, cache_discovery=False
-    )
-
-
-def _create_compute(gcp_credentials=None):
-    return discovery.build(
-        "compute", "v1", credentials=gcp_credentials, cache_discovery=False
-    )
-
-
-def _create_tpu(gcp_credentials=None):
-    return discovery.build(
-        "tpu",
-        TPU_VERSION,
-        credentials=gcp_credentials,
-        cache_discovery=False,
-        discoveryServiceUrl="https://tpu.googleapis.com/$discovery/rest",
-    )
+class ClusterCleaner:
+    """Responsible for deleting a cluster with all its associated
+    resources. Used when the remote cluster head is requested to
+    dismantle its cluster."""
+
+    # default region for the cloud function namespace
+    namespace_region = "us-east"
+    # default name for the cloud function namespace (cf doesn't support tagging)
+    namespace_name = "skypilot-namespace"
+    # default name for the cloud function action.
+    action_name = "skypilot-vpc-cleaner-action"
+    # url to cloud function's namespaces in the chosen region: `namespace_region`
+    cf_namespaces_url = (
+        f"https://{namespace_region}.functions.cloud.ibm.com/api/v1/namespaces"
+    )
+
+    def __init__(self, resource_group_id, vpc_id, vpc_region) -> None:
+        self.resource_group_id = resource_group_id
+        self.vpc_id = vpc_id
+        self.vpc_region = vpc_region
 
+    function_code = textwrap.dedent(
+        """
+    import subprocess
+    import time
+    from concurrent.futures import ThreadPoolExecutor
+    RAY_RECYCLABLE = "ray-recyclable"
+    ibm_vpc_client = None
+    # modules installed and imported entry point
+    ibm_vpc = None
+    ibm_cloud_sdk_core = None
 
-def construct_clients_from_provider_config(provider_config):
-    """
-    Attempt to fetch and parse the JSON GCP credentials from the provider
-    config yaml file.
+    def get_vpc_data(vpc_id):
 
-    tpu resource (the last element of the tuple) will be None if
-    `_has_tpus` in provider config is not set or False.
-    """
-    gcp_credentials = provider_config.get("gcp_credentials")
-    if gcp_credentials is None:
-        logger.debug(
-            "gcp_credentials not found in cluster yaml file. "
-            "Falling back to GOOGLE_APPLICATION_CREDENTIALS "
-            "environment variable."
-        )
-        tpu_resource = (
-            _create_tpu()
-            if provider_config.get(HAS_TPU_PROVIDER_FIELD, False)
-            else None
-        )
-        # If gcp_credentials is None, then discovery.build will search for
-        # credentials in the local environment.
-        return _create_crm(), _create_iam(), _create_compute(), tpu_resource
-
-    assert (
-        "type" in gcp_credentials
-    ), "gcp_credentials cluster yaml field missing 'type' field."
-    assert (
-        "credentials" in gcp_credentials
-    ), "gcp_credentials cluster yaml field missing 'credentials' field."
-
-    cred_type = gcp_credentials["type"]
-    credentials_field = gcp_credentials["credentials"]
-
-    if cred_type == "service_account":
-        # If parsing the gcp_credentials failed, then the user likely made a
-        # mistake in copying the credentials into the config yaml.
+        if not vpc_id: return None
         try:
-            service_account_info = json.loads(credentials_field)
-        except json.decoder.JSONDecodeError:
-            raise RuntimeError(
-                "gcp_credentials found in cluster yaml file but "
-                "formatted improperly."
-            )
-        credentials = service_account.Credentials.from_service_account_info(
-            service_account_info
-        )
-    elif cred_type == "credentials_token":
-        # Otherwise the credentials type must be credentials_token.
-        credentials = OAuthCredentials(credentials_field)
-
-    tpu_resource = (
-        _create_tpu(credentials)
-        if provider_config.get(HAS_TPU_PROVIDER_FIELD, False)
-        else None
-    )
-
-    return (
-        _create_crm(credentials),
-        _create_iam(credentials),
-        _create_compute(credentials),
-        tpu_resource,
-    )
-
-
-def bootstrap_gcp(config):
-    config = copy.deepcopy(config)
-    check_legacy_fields(config)
-    # Used internally to store head IAM role.
-    config["head_node"] = {}
-
-    # Check if we have any TPUs defined, and if so,
-    # insert that information into the provider config
-    if _has_tpus_in_node_configs(config):
-        config["provider"][HAS_TPU_PROVIDER_FIELD] = True
-
-    crm, iam, compute, tpu = construct_clients_from_provider_config(config["provider"])
-
-    config = _configure_project(config, crm)
-    config = _configure_iam_role(config, crm, iam)
-    config = _configure_key_pair(config, compute)
-    config = _configure_subnet(config, compute)
-
-    return config
-
-
-def _configure_project(config, crm):
-    """Setup a Google Cloud Platform Project.
-
-    Google Compute Platform organizes all the resources, such as storage
-    buckets, users, and instances under projects. This is different from
-    aws ec2 where everything is global.
-    """
-    config = copy.deepcopy(config)
-
-    project_id = config["provider"].get("project_id")
-    assert config["provider"]["project_id"] is not None, (
-        "'project_id' must be set in the 'provider' section of the autoscaler"
-        " config. Notice that the project id must be globally unique."
-    )
-    project = _get_project(project_id, crm)
-
-    if project is None:
-        #  Project not found, try creating it
-        _create_project(project_id, crm)
-        project = _get_project(project_id, crm)
-
-    assert project is not None, "Failed to create project"
-    assert (
-        project["lifecycleState"] == "ACTIVE"
-    ), "Project status needs to be ACTIVE, got {}".format(project["lifecycleState"])
-
-    config["provider"]["project_id"] = project["projectId"]
-
-    return config
-
-
-def _is_permission_satisfied(
-    service_account, crm, iam, required_permissions, required_roles
-):
-    """Check if either of the roles or permissions are satisfied."""
-    if service_account is None:
-        return False, None
-
-    project_id = service_account["projectId"]
-    email = service_account["email"]
-
-    member_id = "serviceAccount:" + email
-
-    required_permissions = set(required_permissions)
-    policy = crm.projects().getIamPolicy(resource=project_id, body={}).execute()
-    original_policy = copy.deepcopy(policy)
-    already_configured = True
-
-    logger.info(f"_configure_iam_role: Checking permissions for {email}...")
-
-    # Check the roles first, as checking the permission requires more API calls and
-    # permissions.
-    for role in required_roles:
-        role_exists = False
-        for binding in policy["bindings"]:
-            if binding["role"] == role:
-                if member_id not in binding["members"]:
-                    logger.info(
-                        f"_configure_iam_role: role {role} is not attached to {member_id}..."
-                    )
-                    binding["members"].append(member_id)
-                    already_configured = False
-                role_exists = True
-
-        if not role_exists:
-            logger.info(f"_configure_iam_role: role {role} does not exist.")
-            already_configured = False
-            policy["bindings"].append(
-                {
-                    "members": [member_id],
-                    "role": role,
-                }
-            )
+            vpc_data = ibm_vpc_client.get_vpc(vpc_id).result
+            return vpc_data
+        except ibm_cloud_sdk_core.ApiException as e:
+            if e.code == 404:
+                print(("VPC doesn't exist."))
+                return None
+            else: raise 
+
+    def delete_subnets(vpc_data):
+        def _poll_subnet_exists(subnet_id):
+            tries = 30 # waits up to 5 min with 10 sec interval
+            sleep_interval = 10
+            while tries:
+                try:
+                    subnet_data = ibm_vpc_client.get_subnet(subnet_id).result
+                except Exception:
+                    print('Deleted subnet id: {}'.format(subnet_id))
+                    return True
+                tries -= 1
+                time.sleep(sleep_interval)
+            print(f"Failed to delete instance within expected time frame of {tries*sleep_interval/60} minutes.")
+            return False
 
-    if already_configured:
-        # In some managed environments, an admin needs to grant the
-        # roles, so only call setIamPolicy if needed.
-        return True, policy
-
-    for binding in original_policy["bindings"]:
-        if member_id in binding["members"]:
-            role = binding["role"]
+        subnets_attached_to_routing_table = ibm_vpc_client.list_subnets(routing_table_id = vpc_data['default_routing_table']['id']).get_result()['subnets']
+        subnets_ids = [subnet['id'] for subnet in subnets_attached_to_routing_table]
+        for id in subnets_ids:
             try:
-                role_definition = iam.projects().roles().get(name=role).execute()
-            except TypeError as e:
-                if "does not match the pattern" in str(e):
-                    logger.info(
-                        f"_configure_iam_role: fail to check permission for built-in role {role}. skipped."
-                    )
-                    permissions = []
+                ibm_vpc_client.delete_subnet(id).get_result()
+                _poll_subnet_exists(id)
+            except ibm_cloud_sdk_core.ApiException as e:
+                if e.code == 404:
+                    print("subnet doesn't exist.")
+
+    def delete_gateways(vpc_id):
+        gateways = ibm_vpc_client.list_public_gateways(resource_group_id=RESOURCE_GROUP_ID).get_result()['public_gateways']
+        gateways_ids_of_vpc = [gateway['id'] for gateway in gateways if gateway['vpc']['id']== vpc_id]
+        for gateway_id in gateways_ids_of_vpc:
+            deleting_resource = True
+            while deleting_resource:
+                try:
+                    ibm_vpc_client.delete_public_gateway(gateway_id).get_result()
+                    deleting_resource = False
+                except ibm_cloud_sdk_core.ApiException as e:
+                    if e.code == 404:
+                        print("gateway doesn't exist.") 
+                        deleting_resource = False
+                    if e.code == 409:
+                        print("gateway still in use.")
+                        # will retry until cloud functions timeout. 
+                        time.sleep(5) 
+
+    def delete_vms(vpc_id):
+        def _poll_vpc_contains_vms(vpc_id):
+            tries = 60
+            sleep_interval = 3
+            while tries:
+                # list_instances() never raise an exception, check values instead
+                res = ibm_vpc_client.list_instances(vpc_id=vpc_id).get_result()
+                if not res["total_count"]:
+                    return True
                 else:
-                    raise
-            else:
-                permissions = role_definition["includedPermissions"]
-            required_permissions -= set(permissions)
-        if not required_permissions:
-            break
-    if not required_permissions:
-        # All required permissions are already granted.
-        return True, policy
-    logger.info(f"_configure_iam_role: missing permisisons {required_permissions}")
-
-    return False, policy
-
-
-def _configure_iam_role(config, crm, iam):
-    """Setup a gcp service account with IAM roles.
-
-    Creates a gcp service acconut and binds IAM roles which allow it to control
-    control storage/compute services. Specifically, the head node needs to have
-    an IAM role that allows it to create further gce instances and store items
-    in google cloud storage.
+                    tries -= 1
+                    time.sleep(sleep_interval)
+            raise Exception(
+                "Failed to delete VPC's instances within "
+                "the expected time frame. Cannot "
+                "continue to delete VPC."
+            )
 
-    TODO: Allow the name/id of the service account to be configured
-    """
-    config = copy.deepcopy(config)
+        def _del_instance(vm_data):
+            # first delete ips created by node_provider 
+            nic_id = vm_data["network_interfaces"][0]["id"]
+            res = ibm_vpc_client.list_instance_network_interface_floating_ips(
+                vm_data["id"], nic_id
+            ).get_result()
+            floating_ips = res.get("floating_ips", [])
+            for ip in floating_ips:
+                if ip["name"].startswith(RAY_RECYCLABLE):
+                    print(f"Deleting IP: {ip['id']}")
+                    ibm_vpc_client.delete_floating_ip(ip["id"])
+            print(f"Deleting VM: {vm_data['id']}")
+            ibm_vpc_client.delete_instance(id=vm_data["id"])
+            
+        res = ibm_vpc_client.list_instances(vpc_id=vpc_id).get_result()
+        num_instances = res["total_count"]
+
+        # Delete VSIs if exist
+        if num_instances:
+            instances = res["instances"]
+            with ThreadPoolExecutor(num_instances) as ex:
+                for i in range(num_instances):
+                    ex.submit(_del_instance, instances[i])
+            # wait until all vms are deleted to proceed
+            _poll_vpc_contains_vms(vpc_id)
+
+    def delete_unbound_vpc(vpc_id):
+        deleting_resource = True
+        while deleting_resource:
+            try:
+                ibm_vpc_client.delete_vpc(vpc_id).get_result()
+                deleting_resource = False
+            except ibm_cloud_sdk_core.ApiException as e:
+                if e.code == 404:
+                    print("VPC doesn't exist.") 
+                    deleting_resource = False
+                if e.code == 409:
+                    print("VPC still in use.")
+                    # will retry until cloud functions timeout. 
+                    time.sleep(5) 
+
+    def delete_vpc(vpc_id):
+        vpc_data = get_vpc_data(vpc_id)
+        if not vpc_data:
+            print((f"Failed to find a VPC with id={vpc_id}"))
+            return
+        print(f"Deleting vpc:{vpc_data['name']} with id:{vpc_id}")
+        delete_vms(vpc_id)
+        delete_subnets(vpc_data)
+        delete_gateways(vpc_id)
+        delete_unbound_vpc(vpc_id)
+        print(f"VPC {vpc_data['name']} and its attached resources were deleted successfully")
+
+
+    def main(dict):
+        global ibm_vpc_client, RESOURCE_GROUP_ID, ibm_cloud_sdk_core, ibm_vpc
+        def install_package(package):
+            pip_location_stdout = subprocess.run(['which', 'pip'], capture_output=True, text=True)
+            pip_location = pip_location_stdout.stdout.strip()
+            subprocess.call([pip_location, 'install', package], stdout=subprocess.DEVNULL, stderr=subprocess.STDOUT)
+
+        for package in ["ibm-vpc", "ibm-cloud-sdk-core"]:
+            install_package(package)
+
+        import ibm_vpc as _ibm_vpc
+        import ibm_cloud_sdk_core as _ibm_cloud_sdk_core
+        ibm_vpc = _ibm_vpc
+        ibm_cloud_sdk_core = _ibm_cloud_sdk_core
+
+        iam_api_key, RESOURCE_GROUP_ID, vpc_id, region = dict['iam_api_key'], dict['resource_group_id'], dict['vpc_id'], dict['region']
+
+        authenticator = ibm_cloud_sdk_core.authenticators.IAMAuthenticator(iam_api_key, url=None)
+        ibm_vpc_client = ibm_vpc.VpcV1('2022-06-30',authenticator=authenticator)
 
-    email = SKYPILOT_SERVICE_ACCOUNT_EMAIL_TEMPLATE.format(
-        account_id=SKYPILOT_SERVICE_ACCOUNT_ID,
-        project_id=config["provider"]["project_id"],
-    )
-    service_account = _get_service_account(email, config, iam)
+        if not region:
+            raise Exception("VPC not found in any region")
 
-    permissions = VM_MINIMAL_PERMISSIONS
-    roles = DEFAULT_SERVICE_ACCOUNT_ROLES
-    if config["provider"].get(HAS_TPU_PROVIDER_FIELD, False):
-        roles = DEFAULT_SERVICE_ACCOUNT_ROLES + TPU_SERVICE_ACCOUNT_ROLES
-        permissions = VM_MINIMAL_PERMISSIONS + TPU_MINIMAL_PERMISSIONS
+        ibm_vpc_client.set_service_url(f'https://{region}.iaas.cloud.ibm.com/v1')
 
-    satisfied, policy = _is_permission_satisfied(
-        service_account, crm, iam, permissions, roles
+        delete_vpc(vpc_id=vpc_id)
+        return {"Status": "Success"}
+    """
     )
 
-    if not satisfied:
-        # SkyPilot: Fallback to the old ray service account name for
-        # backwards compatibility. Users using GCP before #2112 have
-        # the old service account setup setup in their GCP project,
-        # and the user may not have the permissions to create the
-        # new service account. This is to ensure that the old service
-        # account is still usable.
-        email = SERVICE_ACCOUNT_EMAIL_TEMPLATE.format(
-            account_id=DEFAULT_SERVICE_ACCOUNT_ID,
-            project_id=config["provider"]["project_id"],
-        )
-        logger.info(f"_configure_iam_role: Fallback to service account {email}")
+    def get_headers(self):
+        return {
+            "Content-Type": "application/json",
+            "Accept": "application/json",
+            "Authorization": "Bearer " + ibm.get_oauth_token(),
+        }
 
-        ray_service_account = _get_service_account(email, config, iam)
-        ray_satisfied, _ = _is_permission_satisfied(
-            ray_service_account, crm, iam, permissions, roles
-        )
-        logger.info(
-            "_configure_iam_role: "
-            f"Fallback to service account {email} succeeded? {ray_satisfied}"
-        )
+    def create_or_fetch_namespace(self):
+        """returns namespace id.
+        creates a namespace with given name in specified region.
+        if namespace exists returns its id instead."""
 
-        if ray_satisfied:
-            service_account = ray_service_account
-            satisfied = ray_satisfied
-        elif service_account is None:
+        def _create_new_namespace():
             logger.info(
-                "_configure_iam_role: "
-                "Creating new service account {}".format(SKYPILOT_SERVICE_ACCOUNT_ID)
-            )
-            # SkyPilot: a GCP user without the permission to create a service
-            # account will fail here.
-            service_account = _create_service_account(
-                SKYPILOT_SERVICE_ACCOUNT_ID,
-                SKYPILOT_SERVICE_ACCOUNT_CONFIG,
-                config,
-                iam,
+                f"Creating a new namespace: {self.namespace_name} in {self.namespace_region}"
             )
-            satisfied, policy = _is_permission_satisfied(
-                service_account, crm, iam, permissions, roles
-            )
-
-    assert service_account is not None, "Failed to create service account"
-
-    if not satisfied:
-        logger.info(
-            "_configure_iam_role: " f"Adding roles to service account {email}..."
-        )
-        _add_iam_policy_binding(service_account, policy, crm, iam)
-
-    account_dict = {
-        "email": service_account["email"],
-        # NOTE: The amount of access is determined by the scope + IAM
-        # role of the service account. Even if the cloud-platform scope
-        # gives (scope) access to the whole cloud-platform, the service
-        # account is limited by the IAM rights specified below.
-        "scopes": ["https://www.googleapis.com/auth/cloud-platform"],
-    }
-    if _is_head_node_a_tpu(config):
-        # SKY: The API for TPU VM is slightly different from normal compute instances.
-        # See https://cloud.google.com/tpu/docs/reference/rest/v2alpha1/projects.locations.nodes#Node
-        account_dict["scope"] = account_dict["scopes"]
-        account_dict.pop("scopes")
-        config["head_node"]["serviceAccount"] = account_dict
-    else:
-        config["head_node"]["serviceAccounts"] = [account_dict]
-
-    return config
-
-
-def _configure_key_pair(config, compute):
-    """Configure SSH access, using an existing key pair if possible.
-
-    Creates a project-wide ssh key that can be used to access all the instances
-    unless explicitly prohibited by instance config.
-
-    The ssh-keys created by ray are of format:
 
-      [USERNAME]:ssh-rsa [KEY_VALUE] [USERNAME]
-
-    where:
-
-      [USERNAME] is the user for the SSH key, specified in the config.
-      [KEY_VALUE] is the public SSH key value.
-    """
-    config = copy.deepcopy(config)
-
-    if "ssh_private_key" in config["auth"]:
-        return config
-
-    ssh_user = config["auth"]["ssh_user"]
-
-    project = compute.projects().get(project=config["provider"]["project_id"]).execute()
-
-    # Key pairs associated with project meta data. The key pairs are general,
-    # and not just ssh keys.
-    ssh_keys_str = next(
-        (
-            item
-            for item in project["commonInstanceMetadata"].get("items", [])
-            if item["key"] == "ssh-keys"
-        ),
-        {},
-    ).get("value", "")
-
-    ssh_keys = ssh_keys_str.split("\n") if ssh_keys_str else []
-
-    # Try a few times to get or create a good key pair.
-    key_found = False
-    for i in range(10):
-        key_name = key_pair_name(
-            i, config["provider"]["region"], config["provider"]["project_id"], ssh_user
-        )
-        public_key_path, private_key_path = key_pair_paths(key_name)
-
-        for ssh_key in ssh_keys:
-            key_parts = ssh_key.split(" ")
-            if len(key_parts) != 3:
-                continue
-
-            if key_parts[2] == ssh_user and os.path.exists(private_key_path):
-                # Found a key
-                key_found = True
-                break
-
-        # Writing the new ssh key to the filesystem fails if the ~/.ssh
-        # directory doesn't already exist.
-        os.makedirs(os.path.expanduser("~/.ssh"), exist_ok=True)
+            data = {
+                "name": self.namespace_name,
+                "resource_group_id": self.resource_group_id,
+                "resource_plan_id": "functions-base-plan",
+            }
+
+            res = requests.post(
+                self.cf_namespaces_url, headers=self.get_headers(), json=data
+            ).json()
+            if res.status_code != 200:
+                logger.error(res.text)
+            namespace_id = res["id"]
+            logger.info(f"Created new namespace with id: {namespace_id}")
+            return namespace_id
+
+        def _get_cloud_function_namespaces_metadata(offset=0):
+            """returns meta data on namespaces of ibm cloud functions within a specified region
+            :param offset - offset from the beginning of the list of results attained from the GET request,
+                            which may contain up to 200 namespaces per http response"""
+
+            res = requests.get(
+                f"{self.cf_namespaces_url}?limit=200&offset={offset}",
+                headers=self.get_headers(),
+            )
+            return json.loads(res.text)
 
-        # Create a key since it doesn't exist locally or in GCP
-        if not key_found and not os.path.exists(private_key_path):
+        def _get_cloud_function_namespaces():
+            """returns relevant metadata on existing namespaces within a given region."""
             logger.info(
-                "_configure_key_pair: Creating new key pair {}".format(key_name)
+                f"Obtaining Cloud Function namespaces in {self.namespace_region}"
             )
-            public_key, private_key = generate_rsa_key_pair()
-
-            _create_project_ssh_key_pair(project, public_key, ssh_user, compute)
-
-            # Create the directory if it doesn't exists
-            private_key_dir = os.path.dirname(private_key_path)
-            os.makedirs(private_key_dir, exist_ok=True)
 
-            # We need to make sure to _create_ the file with the right
-            # permissions. In order to do that we need to change the default
-            # os.open behavior to include the mode we want.
-            with open(
-                private_key_path,
-                "w",
-                opener=partial(os.open, mode=0o600),
-            ) as f:
-                f.write(private_key)
-
-            with open(public_key_path, "w") as f:
-                f.write(public_key)
-
-            key_found = True
-
-            break
-
-        if key_found:
-            break
-
-    assert key_found, "SSH keypair for user {} not found for {}".format(
-        ssh_user, private_key_path
-    )
-    assert os.path.exists(
-        private_key_path
-    ), "Private key file {} not found for user {}".format(private_key_path, ssh_user)
-
-    logger.info(
-        "_configure_key_pair: "
-        "Private key not specified in config, using"
-        "{}".format(private_key_path)
-    )
-
-    config["auth"]["ssh_private_key"] = private_key_path
-
-    return config
-
-
-def _check_firewall_rules(vpc_name, config, compute):
-    """Check if the firewall rules in the VPC are sufficient."""
-    required_rules = FIREWALL_RULES_REQUIRED.copy()
-
-    operation = compute.networks().getEffectiveFirewalls(
-        project=config["provider"]["project_id"], network=vpc_name
-    )
-    response = operation.execute()
-    if len(response) == 0:
-        return False
-    effective_rules = response["firewalls"]
-
-    def _merge_and_refine_rule(rules):
-        """Returns the reformatted rules from the firewall rules
-
-        The function translates firewall rules fetched from the cloud provider
-        to a format for simple comparison.
-
-        Example of firewall rules from the cloud:
-        [
-            {
-                ...
-                "direction": "INGRESS",
-                "allowed": [
-                    {"IPProtocol": "tcp", "ports": ['80', '443']},
-                    {"IPProtocol": "udp", "ports": ['53']},
-                ],
-                "sourceRanges": ["10.128.0.0/9"],
-            },
-            {
-                ...
-                "direction": "INGRESS",
-                "allowed": [{
-                    "IPProtocol": "tcp",
-                    "ports": ["22"],
-                }],
-                "sourceRanges": ["0.0.0.0/0"],
-            },
-        ]
+            namespaces = []
 
-        Returns:
-            source2rules: Dict[(direction, sourceRanges) -> Dict(protocol -> Set[ports])]
-                Example {
-                    ("INGRESS", "10.128.0.0/9"): {"tcp": {80, 443}, "udp": {53}},
-                    ("INGRESS", "0.0.0.0/0"): {"tcp": {22}},
-                }
-        """
-        source2rules: Dict[Tuple[str, str], Dict[str, Set[int]]] = {}
-        source2allowed_list: Dict[Tuple[str, str], List[Dict[str, str]]] = {}
-        for rule in rules:
-            # Rules applied to specific VM (targetTags) may not work for the
-            # current VM, so should be skipped.
-            # Filter by targetTags == ['cluster_name']
-            # See https://developers.google.com/resources/api-libraries/documentation/compute/alpha/python/latest/compute_alpha.networks.html#getEffectiveFirewalls # pylint: disable=line-too-long
-            tags = rule.get("targetTags", None)
-            if tags is not None:
-                if len(tags) != 1:
-                    continue
-                if tags[0] != config["cluster_name"]:
-                    continue
-            direction = rule.get("direction", "")
-            sources = rule.get("sourceRanges", [])
-            allowed = rule.get("allowed", [])
-            for source in sources:
-                key = (direction, source)
-                source2allowed_list[key] = source2allowed_list.get(key, []) + allowed
-        for direction_source, allowed_list in source2allowed_list.items():
-            source2rules[direction_source] = {}
-            for allowed in allowed_list:
-                # Example of port_list: ["20", "50-60"]
-                # If list is empty, it means all ports
-                port_list = allowed.get("ports", [])
-                port_set = set()
-                if port_list == []:
-                    port_set.update(set(range(1, 65536)))
+            collecting_namespaces = True
+            max_limit = 200
+            offset = 0
+
+            #  request for namespaces is limited to 200 at a time, thus the request is fulfilled in increments of 200s.
+            while collecting_namespaces:
+                namespace_metadata = _get_cloud_function_namespaces_metadata(offset)
+                if namespace_metadata["total_count"] == max_limit:
+                    offset += max_limit
                 else:
-                    for port_range in port_list:
-                        parse_ports = port_range.split("-")
-                        if len(parse_ports) == 1:
-                            port_set.add(int(parse_ports[0]))
-                        else:
-                            assert (
-                                len(parse_ports) == 2
-                            ), f"Failed to parse the port range: {port_range}"
-                            port_set.update(
-                                set(range(int(parse_ports[0]), int(parse_ports[1]) + 1))
-                            )
-                if allowed["IPProtocol"] not in source2rules[direction_source]:
-                    source2rules[direction_source][allowed["IPProtocol"]] = set()
-                source2rules[direction_source][allowed["IPProtocol"]].update(port_set)
-        return source2rules
-
-    effective_rules = _merge_and_refine_rule(effective_rules)
-    required_rules = _merge_and_refine_rule(required_rules)
-
-    for direction_source, allowed_req in required_rules.items():
-        if direction_source not in effective_rules:
-            return False
-        allowed_eff = effective_rules[direction_source]
-        # Special case: "all" means allowing all traffic
-        if "all" in allowed_eff:
-            continue
-        # Check if the required ports are a subset of the effective ports
-        for protocol, ports_req in allowed_req.items():
-            ports_eff = allowed_eff.get(protocol, set())
-            if not ports_req.issubset(ports_eff):
-                return False
-    return True
-
-
-def _create_rules(config, compute, rules, VPC_NAME, PROJ_ID):
-    opertaions = []
-    for rule in rules:
-        # Query firewall rule by its name (unique in a project).
-        # If the rule already exists, delete it first.
-        rule_name = rule["name"].format(VPC_NAME=VPC_NAME)
-        rule_list = _list_firewall_rules(config, compute, filter=f"(name={rule_name})")
-        if len(rule_list) > 0:
-            _delete_firewall_rule(config, compute, rule_name)
-
-        body = rule.copy()
-        body["name"] = body["name"].format(VPC_NAME=VPC_NAME)
-        body["network"] = body["network"].format(PROJ_ID=PROJ_ID, VPC_NAME=VPC_NAME)
-        body["selfLink"] = body["selfLink"].format(PROJ_ID=PROJ_ID, VPC_NAME=VPC_NAME)
-        op = _create_firewall_rule_submit(config, compute, body)
-        opertaions.append(op)
-    for op in opertaions:
-        wait_for_compute_global_operation(config["provider"]["project_id"], op, compute)
-
-
-def _network_interface_to_vpc_name(network_interface: Dict[str, str]) -> str:
-    """Returns the VPC name of a network interface."""
-    return network_interface["network"].split("/")[-1]
-
-
-def get_usable_vpc_and_subnet(
-    config,
-) -> Tuple[str, "google.cloud.compute_v1.types.compute.Subnetwork"]:
-    """Return a usable VPC and the subnet in it.
-
-    If config['provider']['vpc_name'] is set, return the VPC with the name
-    (errors out if not found). When this field is set, no firewall rules
-    checking or overrides will take place; it is the user's responsibility to
-    properly set up the VPC.
-
-    If not found, create a new one with sufficient firewall rules.
-
-    Returns:
-        vpc_name: The name of the VPC network.
-        subnet_name: The name of the subnet in the VPC network for the specific
-            region.
+                    collecting_namespaces = False
 
-    Raises:
-      RuntimeError: if the user has specified a VPC name but the VPC is not found.
-    """
-    _, _, compute, _ = construct_clients_from_provider_config(config["provider"])
-
-    # For existing cluster, it is ok to return a VPC and subnet not used by
-    # the cluster, as AWS will ignore them.
-    # There is a corner case where the multi-node cluster was partially
-    # launched, launching the cluster again can cause the nodes located on
-    # different VPCs, if VPCs in the project have changed. It should be fine to
-    # not handle this special case as we don't want to sacrifice the performance
-    # for every launch just for this rare case.
-
-    specific_vpc_to_use = config["provider"].get("vpc_name", None)
-    if specific_vpc_to_use is not None:
-        vpcnets_all = _list_vpcnets(
-            config, compute, filter=f"name={specific_vpc_to_use}"
-        )
-        # On GCP, VPC names are unique, so it'd be 0 or 1 VPC found.
-        assert (
-            len(vpcnets_all) <= 1
-        ), f"{len(vpcnets_all)} VPCs found with the same name {specific_vpc_to_use}"
-        if len(vpcnets_all) == 1:
-            # Skip checking any firewall rules if the user has specified a VPC.
-            logger.info(f"Using user-specified VPC {specific_vpc_to_use!r}.")
-            subnets = _list_subnets(config, compute, network=specific_vpc_to_use)
-            if not subnets:
-                _skypilot_log_error_and_exit_for_failover(
-                    f"No subnet for region {config['provider']['region']} found for specified VPC {specific_vpc_to_use!r}. "
-                    f"Check the subnets of VPC {specific_vpc_to_use!r} at https://console.cloud.google.com/networking/networks"
-                )
-            return specific_vpc_to_use, subnets[0]
-        else:
-            # VPC with this name not found. Error out and let SkyPilot failover.
-            _skypilot_log_error_and_exit_for_failover(
-                f"No VPC with name {specific_vpc_to_use!r} is found. "
-                "To fix: specify a correct VPC name."
+                for name_space in namespace_metadata["namespaces"]:
+                    if "name" in name_space:  # API based namespace
+                        namespaces.append(
+                            {
+                                "name": name_space["name"],
+                                "type": "API_based",
+                                "id": name_space["id"],
+                                "region": name_space["location"],
+                            }
+                        )
+
+                    else:  # cloud foundry based namespace
+                        namespaces.append(
+                            {
+                                "name": name_space["id"],
+                                "type": "CF_based",
+                                "region": name_space["location"],
+                            }
+                        )
+
+            return namespaces
+
+        namespaces_in_region = _get_cloud_function_namespaces()
+        target_namespace_id = None
+        if namespaces_in_region:
+            target_namespace_id = next(
+                (
+                    namespace["id"]
+                    for namespace in namespaces_in_region
+                    if namespace["name"] == self.namespace_name
+                ),
+                None,
             )
-            # Should not reach here.
-
-    subnets_all = _list_subnets(config, compute)
-
-    # Check if VPC for subnet has sufficient firewall rules.
-    insufficient_vpcs = set()
-    for subnet in subnets_all:
-        vpc_name = _network_interface_to_vpc_name(subnet)
-        if vpc_name in insufficient_vpcs:
-            continue
-        if _check_firewall_rules(vpc_name, config, compute):
-            logger.info(f"get_usable_vpc: Found a usable VPC network {vpc_name!r}.")
-            return vpc_name, subnet
+        if not target_namespace_id:
+            target_namespace_id = _create_new_namespace()
         else:
-            insufficient_vpcs.add(vpc_name)
+            logger.info(f"Reusing namespace: {target_namespace_id}")
+        return target_namespace_id
 
-    # No usable VPC found. Try to create one.
-    proj_id = config["provider"]["project_id"]
-    logger.info(f"Creating a default VPC network, {SKYPILOT_VPC_NAME}...")
-
-    # Create a SkyPilot VPC network if it doesn't exist
-    vpc_list = _list_vpcnets(config, compute, filter=f"name={SKYPILOT_VPC_NAME}")
-    if len(vpc_list) == 0:
-        body = VPC_TEMPLATE.copy()
-        body["name"] = body["name"].format(VPC_NAME=SKYPILOT_VPC_NAME)
-        body["selfLink"] = body["selfLink"].format(
-            PROJ_ID=proj_id, VPC_NAME=SKYPILOT_VPC_NAME
-        )
-        _create_vpcnet(config, compute, body)
-
-    _create_rules(config, compute, FIREWALL_RULES_TEMPLATE, SKYPILOT_VPC_NAME, proj_id)
-
-    usable_vpc_name = SKYPILOT_VPC_NAME
-    subnets = _list_subnets(config, compute, network=usable_vpc_name)
-    if not subnets:
-        _skypilot_log_error_and_exit_for_failover(
-            f"No subnet for region {config['provider']['region']} found for generated VPC {usable_vpc_name!r}. "
-            "This is probably due to the region being disabled in the account/project_id."
-        )
-    usable_subnet = subnets[0]
-    logger.info(f"A VPC network {SKYPILOT_VPC_NAME} created.")
-
-    return usable_vpc_name, usable_subnet
-
-
-def _configure_subnet(config, compute):
-    """Pick a reasonable subnet if not specified by the config."""
-    config = copy.deepcopy(config)
-
-    node_configs = [
-        node_type["node_config"]
-        for node_type in config["available_node_types"].values()
-    ]
-    # Rationale: avoid subnet lookup if the network is already
-    # completely manually configured
-
-    # networkInterfaces is compute, networkConfig is TPU
-    if all(
-        "networkInterfaces" in node_config or "networkConfig" in node_config
-        for node_config in node_configs
-    ):
-        return config
-
-    # SkyPilot: make sure there's a usable VPC
-    _, default_subnet = get_usable_vpc_and_subnet(config)
-
-    default_interfaces = [
-        {
-            "subnetwork": default_subnet["selfLink"],
-            "accessConfigs": [
-                {
-                    "name": "External NAT",
-                    "type": "ONE_TO_ONE_NAT",
-                }
-            ],
+    def _get_cloud_functions_actions(self, namespace_id):
+        """returns meta data on namespaces of ibm cloud functions within a specified region
+        :param offset - offset from the beginning of the list of results attained from the GET request,
+                        which may contain up to 200 namespaces per http response"""
+
+        res = requests.get(
+            f"{self.cf_namespaces_url}/{namespace_id}/actions?limit=200",
+            headers=self.get_headers(),
+        )
+        return json.loads(res.text)
+
+    def create_action(self, namespace_id):
+        logger.info(f"creating action on namespace: {namespace_id}")
+        # Define the function parameters
+        function_params = {
+            "exec": {"kind": "python:3.9", "code": self.function_code},
+            "limits": {"timeout": 600000},
         }
-    ]
-    if config["provider"].get("use_internal_ips", False):
-        # Removing this key means the VM will not be assigned an external IP.
-        default_interfaces[0].pop("accessConfigs")
-
-    for node_config in node_configs:
-        # The not applicable key will be removed during node creation
-
-        # compute
-        if "networkInterfaces" not in node_config:
-            node_config["networkInterfaces"] = copy.deepcopy(default_interfaces)
-        # TPU
-        if "networkConfig" not in node_config:
-            node_config["networkConfig"] = copy.deepcopy(default_interfaces)[0]
-            # TPU doesn't have accessConfigs
-            node_config["networkConfig"].pop("accessConfigs", None)
-            if config["provider"].get("use_internal_ips", False):
-                node_config["networkConfig"]["enableExternalIps"] = False
-
-    return config
-
-
-def _create_firewall_rule_submit(config, compute, body):
-    operation = (
-        compute.firewalls()
-        .insert(project=config["provider"]["project_id"], body=body)
-        .execute()
-    )
-    return operation
-
-
-def _delete_firewall_rule(config, compute, name):
-    operation = (
-        compute.firewalls()
-        .delete(project=config["provider"]["project_id"], firewall=name)
-        .execute()
-    )
-    response = wait_for_compute_global_operation(
-        config["provider"]["project_id"], operation, compute
-    )
-    return response
-
-
-def _list_firewall_rules(config, compute, filter=None):
-    response = (
-        compute.firewalls()
-        .list(
-            project=config["provider"]["project_id"],
-            filter=filter,
-        )
-        .execute()
-    )
-    return response["items"] if "items" in response else []
-
-
-def _create_vpcnet(config, compute, body):
-    operation = (
-        compute.networks()
-        .insert(project=config["provider"]["project_id"], body=body)
-        .execute()
-    )
-    response = wait_for_compute_global_operation(
-        config["provider"]["project_id"], operation, compute
-    )
-    return response
-
-
-def _list_vpcnets(config, compute, filter=None):
-    response = (
-        compute.networks()
-        .list(
-            project=config["provider"]["project_id"],
-            filter=filter,
-        )
-        .execute()
-    )
-
-    return (
-        list(sorted(response["items"], key=lambda x: x["name"]))
-        if "items" in response
-        else []
-    )
-
-
-def _list_subnets(
-    config, compute, network=None
-) -> List["google.cloud.compute_v1.types.compute.Subnetwork"]:
-    response = (
-        compute.subnetworks()
-        .list(
-            project=config["provider"]["project_id"],
-            region=config["provider"]["region"],
-        )
-        .execute()
-    )
-
-    items = response["items"] if "items" in response else []
-    if network is None:
-        return items
-
-    # Filter by network (VPC) name.
-    #
-    # Note we do not directly use the filter (network=<...>) arg of the list()
-    # call above, because it'd involve constructing a long URL of the following
-    # format and passing it as the filter value:
-    # 'https://www.googleapis.com/compute/v1/projects/<project_id>/global/networks/<network_name>'
-    matched_items = []
-    for item in items:
-        if network == _network_interface_to_vpc_name(item):
-            matched_items.append(item)
-    return matched_items
-
-
-def _get_subnet(config, subnet_id, compute):
-    subnet = (
-        compute.subnetworks()
-        .get(
-            project=config["provider"]["project_id"],
-            region=config["provider"]["region"],
-            subnetwork=subnet_id,
-        )
-        .execute()
-    )
-
-    return subnet
-
-
-def _get_project(project_id, crm):
-    try:
-        project = crm.projects().get(projectId=project_id).execute()
-    except errors.HttpError as e:
-        if e.resp.status != 403:
-            raise
-        project = None
-
-    return project
-
-
-def _create_project(project_id, crm):
-    operation = (
-        crm.projects()
-        .create(body={"projectId": project_id, "name": project_id})
-        .execute()
-    )
-
-    result = wait_for_crm_operation(operation, crm)
-
-    return result
-
-
-def _get_service_account(account, config, iam):
-    project_id = config["provider"]["project_id"]
-    full_name = "projects/{project_id}/serviceAccounts/{account}".format(
-        project_id=project_id, account=account
-    )
-    try:
-        service_account = iam.projects().serviceAccounts().get(name=full_name).execute()
-    except errors.HttpError as e:
-        if e.resp.status not in [403, 404]:
-            # SkyPilot: added 403, which means the service account doesn't exist,
-            # or not accessible by the current account, which is fine, as we do the
-            # fallback in the caller.
-            raise
-        service_account = None
-
-    return service_account
-
-
-def _create_service_account(account_id, account_config, config, iam):
-    project_id = config["provider"]["project_id"]
-
-    service_account = (
-        iam.projects()
-        .serviceAccounts()
-        .create(
-            name="projects/{project_id}".format(project_id=project_id),
-            body={
-                "accountId": account_id,
-                "serviceAccount": account_config,
-            },
-        )
-        .execute()
-    )
-
-    return service_account
-
-
-def _add_iam_policy_binding(service_account, policy, crm, iam):
-    """Add new IAM roles for the service account."""
-    project_id = service_account["projectId"]
-
-    result = (
-        crm.projects()
-        .setIamPolicy(
-            resource=project_id,
-            body={
-                "policy": policy,
-            },
-        )
-        .execute()
-    )
-
-    return result
-
-
-def _create_project_ssh_key_pair(project, public_key, ssh_user, compute):
-    """Inserts an ssh-key into project commonInstanceMetadata"""
-
-    key_parts = public_key.split(" ")
-
-    # Sanity checks to make sure that the generated key matches expectation
-    assert len(key_parts) == 2, key_parts
-    assert key_parts[0] == "ssh-rsa", key_parts
-
-    new_ssh_meta = "{ssh_user}:ssh-rsa {key_value} {ssh_user}".format(
-        ssh_user=ssh_user, key_value=key_parts[1]
-    )
-
-    common_instance_info = project["commonInstanceMetadata"]
-    items = common_instance_info.get("items", [])
-
-    ssh_keys_i = next(
-        (i for i, item in enumerate(items) if item["key"] == "ssh-keys"), None
-    )
-
-    if ssh_keys_i is None:
-        items.append({"key": "ssh-keys", "value": new_ssh_meta})
-    else:
-        ssh_keys = items[ssh_keys_i]
-        ssh_keys["value"] += "\n" + new_ssh_meta
-        items[ssh_keys_i] = ssh_keys
-
-    common_instance_info["items"] = items
-
-    operation = (
-        compute.projects()
-        .setCommonInstanceMetadata(project=project["name"], body=common_instance_info)
-        .execute()
-    )
-
-    response = wait_for_compute_global_operation(project["name"], operation, compute)
-
-    return response
+        res = requests.put(
+            f"{self.cf_namespaces_url}/{namespace_id}/actions/{self.action_name}?blocking=true&overwrite=true",
+            headers=self.get_headers(),
+            data=json.dumps(function_params),
+        )
+        if res.status_code != 200:
+            logger.error(res.text)
+        return json.loads(res.text)
+
+    def delete_action(self, namespace_id):
+        """return the deleted function's metadata if it existed."""
+        logger.info(f"deleting action on namespace: {namespace_id}")
+        res = requests.delete(
+            f"{self.cf_namespaces_url}/{namespace_id}/actions/{self.action_name}?blocking=true",
+            headers=self.get_headers(),
+        )
+        if res.status_code != 200:
+            logger.warn(res.text)
+        return json.loads(res.text)
+
+    def invoke_action(self, namespace_id: str):
+        logger.info(f"invoking action on namespace: {namespace_id}")
+        payload = {
+            "iam_api_key": ibm.get_api_key(),
+            "resource_group_id": self.resource_group_id,
+            "vpc_id": self.vpc_id,
+            "region": self.vpc_region,
+        }
+        res = requests.post(
+            f"{self.cf_namespaces_url}/{namespace_id}/actions/{self.action_name}?blocking=true",
+            headers=self.get_headers(),
+            data=json.dumps(payload),
+        )
+        if res.status_code != 200:
+            logger.error(res.text)
+        return json.loads(res.text)
+
+    def delete_cluster(self):
+        """Deletes VPC with id==self.vpc_id.
+        1. creates a CloudFunctions namespace named ClusterCleaner.namespace_name if doesn't exists.
+        2. using idempotent function that deletes an action named ClusterCleaner.action_name if exists.
+        3. invokes the action to delete the VPC and all its resources."""
+        cf_namespace_id = self.create_or_fetch_namespace()
+        self.delete_action(cf_namespace_id)
+        self.create_action(cf_namespace_id)
+        self.invoke_action(cf_namespace_id)
```

### Comparing `skypilot-0.5.0/sky/skylet/providers/gcp/node_provider.py` & `skypilot-0.6.0/sky/skylet/providers/lambda_cloud/node_provider.py`

 * *Files 24% similar despite different names*

```diff
@@ -1,400 +1,320 @@
 import logging
-import time
-import copy
-from functools import wraps
+import os
 from threading import RLock
-from typing import Dict, List
-
-import googleapiclient
+import time
+from typing import Any, Dict, List, Optional
 
-from sky.skylet.providers.gcp.config import (
-    bootstrap_gcp,
-    construct_clients_from_provider_config,
-    get_node_type,
-)
-from sky.skylet.providers.command_runner import SkyDockerCommandRunner
-from sky.provision import docker_utils
-
-from ray.autoscaler._private.command_runner import SSHCommandRunner
-from ray.autoscaler.tags import (
-    TAG_RAY_LAUNCH_CONFIG,
-    TAG_RAY_NODE_KIND,
-    TAG_RAY_USER_NODE_TYPE,
-)
-from ray.autoscaler._private.cli_logger import cf, cli_logger
-
-
-# The logic has been abstracted away here to allow for different GCP resources
-# (API endpoints), which can differ widely, making it impossible to use
-# the same logic for everything.
-from sky.skylet.providers.gcp.node import (  # noqa
-    GCPCompute,
-    GCPNode,
-    GCPNodeType,
-    GCPResource,
-    GCPTPU,
-    # Added by SkyPilot
-    INSTANCE_NAME_MAX_LEN,
-    INSTANCE_NAME_UUID_LEN,
-    MAX_POLLS_STOP,
-    POLL_INTERVAL,
-)
 from ray.autoscaler.node_provider import NodeProvider
+from ray.autoscaler.tags import NODE_KIND_HEAD
+from ray.autoscaler.tags import NODE_KIND_WORKER
+from ray.autoscaler.tags import STATUS_UP_TO_DATE
+from ray.autoscaler.tags import TAG_RAY_CLUSTER_NAME
+from ray.autoscaler.tags import TAG_RAY_NODE_KIND
+from ray.autoscaler.tags import TAG_RAY_NODE_NAME
+from ray.autoscaler.tags import TAG_RAY_NODE_STATUS
+from ray.autoscaler.tags import TAG_RAY_USER_NODE_TYPE
+
+from sky import authentication as auth
+from sky.clouds.utils import lambda_utils
+from sky.utils import command_runner
+from sky.utils import common_utils
+from sky.utils import subprocess_utils
+from sky.utils import ux_utils
+
+_TAG_PATH_PREFIX = '~/.sky/generated/lambda_cloud/metadata'
+_REMOTE_SSH_KEY_NAME = '~/.lambda_cloud/ssh_key_name'
+_REMOTE_RAY_SSH_KEY = '~/ray_bootstrap_key.pem'
+_REMOTE_RAY_YAML = '~/ray_bootstrap_config.yaml'
+_GET_INTERNAL_IP_CMD = 'ip -4 -br addr show | grep UP | grep -Eo "(10\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)|172\.(1[6-9]|2[0-9]|3[0-1]))\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)"'
 
 logger = logging.getLogger(__name__)
 
 
-def _retry(method, max_tries=5, backoff_s=1):
-    """Retry decorator for methods of GCPNodeProvider.
+def synchronized(f):
 
-    Upon catching BrokenPipeError, API clients are rebuilt and
-    decorated methods are retried.
+    def wrapper(self, *args, **kwargs):
+        self.lock.acquire()
+        try:
+            return f(self, *args, **kwargs)
+        finally:
+            self.lock.release()
 
-    Work-around for https://github.com/ray-project/ray/issues/16072.
-    Based on https://github.com/kubeflow/pipelines/pull/5250/files.
-    """
+    return wrapper
 
-    @wraps(method)
-    def method_with_retries(self, *args, **kwargs):
-        try_count = 0
-        while try_count < max_tries:
-            try:
-                return method(self, *args, **kwargs)
-            except BrokenPipeError:
-                logger.warning("Caught a BrokenPipeError. Retrying.")
-                try_count += 1
-                if try_count < max_tries:
-                    self._construct_clients()
-                    time.sleep(backoff_s)
-                else:
-                    raise
 
-    return method_with_retries
+class LambdaNodeProvider(NodeProvider):
+    """Node Provider for Lambda Cloud.
 
+    This provider assumes Lambda Cloud credentials are set.
+    """
 
-class GCPNodeProvider(NodeProvider):
-    def __init__(self, provider_config: dict, cluster_name: str):
+    def __init__(self, provider_config: Dict[str, Any],
+                 cluster_name: str) -> None:
         NodeProvider.__init__(self, provider_config, cluster_name)
         self.lock = RLock()
-        self._construct_clients()
-
-        # Cache of node objects from the last nodes() call. This avoids
-        # excessive DescribeInstances requests.
-        self.cached_nodes: Dict[str, GCPNode] = {}
-        self.cache_stopped_nodes = provider_config.get("cache_stopped_nodes", True)
-
-    def _construct_clients(self):
-        _, _, compute, tpu = construct_clients_from_provider_config(
-            self.provider_config
-        )
-
-        # Dict of different resources provided by GCP.
-        # At this moment - Compute and TPUs
-        self.resources: Dict[GCPNodeType, GCPResource] = {}
-
-        # Compute is always required
-        self.resources[GCPNodeType.COMPUTE] = GCPCompute(
-            compute,
-            self.provider_config["project_id"],
-            self.provider_config["availability_zone"],
-            self.cluster_name,
-        )
-
-        # if there are no TPU nodes defined in config, tpu will be None.
-        if tpu is not None:
-            self.resources[GCPNodeType.TPU] = GCPTPU(
-                tpu,
-                self.provider_config["project_id"],
-                self.provider_config["availability_zone"],
-                self.cluster_name,
-            )
-
-    def _get_resource_depending_on_node_name(self, node_name: str) -> GCPResource:
-        """Return the resource responsible for the node, based on node_name.
-
-        This expects the name to be in format '[NAME]-[UUID]-[TYPE]',
-        where [TYPE] is either 'compute' or 'tpu' (see ``GCPNodeType``).
+        self.lambda_client = lambda_utils.LambdaCloudClient()
+        self.cached_nodes: Dict[str, Dict[str, Any]] = {}
+        self.metadata = lambda_utils.Metadata(_TAG_PATH_PREFIX, cluster_name)
+        self.ssh_key_path = os.path.expanduser(auth.PRIVATE_SSH_KEY_PATH)
+
+        def _get_ssh_key_name(prefix: str) -> str:
+            public_key_path = os.path.expanduser(auth.PUBLIC_SSH_KEY_PATH)
+            with open(public_key_path, 'r') as f:
+                public_key = f.read()
+            name, exists = self.lambda_client.get_unique_ssh_key_name(
+                prefix, public_key)
+            if not exists:
+                raise lambda_utils.LambdaCloudError('SSH key not found')
+            return name
+
+        ray_yaml_path = os.path.expanduser(_REMOTE_RAY_YAML)
+        self.on_head = (os.path.exists(ray_yaml_path) and
+                        common_utils.read_yaml(ray_yaml_path)['cluster_name']
+                        == cluster_name)
+
+        if self.on_head:
+            self.ssh_key_path = os.path.expanduser(_REMOTE_RAY_SSH_KEY)
+            ssh_key_name_path = os.path.expanduser(_REMOTE_SSH_KEY_NAME)
+            if os.path.exists(ssh_key_name_path):
+                with open(ssh_key_name_path, 'r') as f:
+                    self.ssh_key_name = f.read()
+            else:
+                # At this point, `~/.ssh/sky-key.pub` contains the public
+                # key used to launch this cluster. Use it to determine
+                # ssh key name and store the name in _REMOTE_SSH_KEY_NAME.
+                # Note: this case only runs during cluster launch, so it is
+                # not possible for ~/.ssh/sky-key.pub to already be regenerated
+                # by the user.
+                self.ssh_key_name = _get_ssh_key_name('')
+                with open(ssh_key_name_path, 'w', encoding='utf-8') as f:
+                    f.write(self.ssh_key_name)
+        else:
+            # On local
+            self.ssh_key_name = _get_ssh_key_name(
+                f'sky-key-{common_utils.get_user_hash()}')
+
+    def _guess_and_add_missing_tags(self, vms: List[Dict[str, Any]]) -> None:
+        """Adds missing vms to local tag file and guesses their tags."""
+        for node in vms:
+            if self.metadata.get(node['id']) is not None:
+                pass
+            elif node['name'] == f'{self.cluster_name}-head':
+                self.metadata.set(
+                    node['id'], {
+                        'tags': {
+                            TAG_RAY_CLUSTER_NAME: self.cluster_name,
+                            TAG_RAY_NODE_STATUS: STATUS_UP_TO_DATE,
+                            TAG_RAY_NODE_KIND: NODE_KIND_HEAD,
+                            TAG_RAY_USER_NODE_TYPE: 'ray_head_default',
+                            TAG_RAY_NODE_NAME: f'ray-{self.cluster_name}-head',
+                        }
+                    })
+            elif node['name'] == f'{self.cluster_name}-worker':
+                self.metadata.set(
+                    node['id'], {
+                        'tags': {
+                            TAG_RAY_CLUSTER_NAME: self.cluster_name,
+                            TAG_RAY_NODE_STATUS: STATUS_UP_TO_DATE,
+                            TAG_RAY_NODE_KIND: NODE_KIND_WORKER,
+                            TAG_RAY_USER_NODE_TYPE: 'ray_worker_default',
+                            TAG_RAY_NODE_NAME: f'ray-{self.cluster_name}-worker',
+                        }
+                    })
+
+    def _list_instances_in_cluster(self) -> List[Dict[str, Any]]:
+        """List running instances in cluster."""
+        vms = self.lambda_client.list_instances()
+        possible_names = [
+            f'{self.cluster_name}-head', f'{self.cluster_name}-worker'
+        ]
+        return [node for node in vms if node.get('name') in possible_names]
+
+    @synchronized
+    def _get_filtered_nodes(self, tag_filters: Dict[str,
+                                                    str]) -> Dict[str, Any]:
+
+        def _extract_metadata(vm: Dict[str, Any]) -> Dict[str, Any]:
+            metadata = {'id': vm['id'], 'status': vm['status'], 'tags': {}}
+            instance_info = self.metadata.get(vm['id'])
+            if instance_info is not None:
+                metadata['tags'] = instance_info['tags']
+            metadata['external_ip'] = vm.get('ip')
+            return metadata
+
+        def _match_tags(vm: Dict[str, Any]):
+            vm_info = self.metadata.get(vm['id'])
+            tags = {} if vm_info is None else vm_info['tags']
+            for k, v in tag_filters.items():
+                if tags.get(k) != v:
+                    return False
+            return True
+
+        def _get_internal_ip(node: Dict[str, Any]):
+            # TODO(ewzeng): cache internal ips in metadata file to reduce
+            # ssh overhead.
+            if node['external_ip'] is None or node['status'] != 'active':
+                node['internal_ip'] = None
+                return
+            runner = command_runner.SSHCommandRunner(
+                node=(node['external_ip'], 22),
+                ssh_user='ubuntu',
+                ssh_private_key=self.ssh_key_path)
+            rc, stdout, stderr = runner.run(_GET_INTERNAL_IP_CMD,
+                                            require_outputs=True,
+                                            stream_logs=False)
+            subprocess_utils.handle_returncode(
+                rc,
+                _GET_INTERNAL_IP_CMD,
+                'Failed get obtain private IP from node',
+                stderr=stdout + stderr)
+            node['internal_ip'] = stdout.strip()
+
+        vms = self._list_instances_in_cluster()
+        self.metadata.refresh([node['id'] for node in vms])
+        self._guess_and_add_missing_tags(vms)
+        nodes = [_extract_metadata(vm) for vm in filter(_match_tags, vms)]
+        nodes = [
+            node for node in nodes
+            if node['status'] not in ['terminating', 'terminated']
+        ]
+        subprocess_utils.run_in_parallel(_get_internal_ip, nodes)
+        self.cached_nodes = {node['id']: node for node in nodes}
+        return self.cached_nodes
+
+    def non_terminated_nodes(self, tag_filters: Dict[str, str]) -> List[str]:
+        """Return a list of node ids filtered by the specified tags dict.
+
+        This list must not include terminated nodes. For performance reasons,
+        providers are allowed to cache the result of a call to
+        non_terminated_nodes() to serve single-node queries
+        (e.g. is_running(node_id)). This means that non_terminated_nodes() must
+        be called again to refresh results.
+
+        Examples:
+            >>> provider.non_terminated_nodes({TAG_RAY_NODE_KIND: "worker"})
+            ["node-1", "node-2"]
         """
-        return self.resources[GCPNodeType.name_to_type(node_name)]
-
-    @_retry
-    def non_terminated_nodes(self, tag_filters: dict):
-        with self.lock:
-            instances = []
-
-            for resource in self.resources.values():
-                node_instances = resource.list_instances(tag_filters)
-                instances += node_instances
-
-            # Note: All the operations use "name" as the unique instance id
-            self.cached_nodes = {i["name"]: i for i in instances}
-            return [i["name"] for i in instances]
-
-    def is_running(self, node_id: str):
-        with self.lock:
-            node = self._get_cached_node(node_id)
-            return node.is_running()
-
-    def is_terminated(self, node_id: str):
-        with self.lock:
-            node = self._get_cached_node(node_id)
-            return node.is_terminated()
-
-    def node_tags(self, node_id: str):
-        with self.lock:
-            node = self._get_cached_node(node_id)
-            return node.get_labels()
-
-    @_retry
-    def set_node_tags(self, node_id: str, tags: dict):
-        with self.lock:
-            labels = tags
-            node = self._get_node(node_id)
+        nodes = self._get_filtered_nodes(tag_filters=tag_filters)
+        return [k for k, _ in nodes.items()]
 
-            resource = self._get_resource_depending_on_node_name(node_id)
-
-            result = resource.set_labels(node=node, labels=labels)
-
-            return result
-
-    def external_ip(self, node_id: str):
-        with self.lock:
-            node = self._get_cached_node(node_id)
-
-            ip = node.get_external_ip()
+    def is_running(self, node_id: str) -> bool:
+        """Return whether the specified node is running."""
+        return self._get_cached_node(node_id=node_id) is not None
+
+    def is_terminated(self, node_id: str) -> bool:
+        """Return whether the specified node is terminated."""
+        return self._get_cached_node(node_id=node_id) is None
+
+    def node_tags(self, node_id: str) -> Dict[str, str]:
+        """Returns the tags of the given node (string dict)."""
+        node = self._get_cached_node(node_id=node_id)
+        if node is None:
+            return {}
+        return node['tags']
+
+    def external_ip(self, node_id: str) -> Optional[str]:
+        """Returns the external ip of the given node."""
+        node = self._get_cached_node(node_id=node_id)
+        if node is None:
+            return None
+        ip = node.get('external_ip')
+        with ux_utils.print_exception_no_traceback():
             if ip is None:
-                node = self._get_node(node_id)
-                ip = node.get_external_ip()
-
-            return ip
-
-    def internal_ip(self, node_id: str):
-        with self.lock:
-            node = self._get_cached_node(node_id)
-
-            ip = node.get_internal_ip()
+                raise lambda_utils.LambdaCloudError(
+                    'A node ip address was not found. Either '
+                    '(1) Lambda Cloud has internally errored, or '
+                    '(2) the cluster is still booting. '
+                    'You can manually terminate the cluster on the '
+                    'Lambda Cloud console or (in case 2) wait for '
+                    'booting to finish (~2 minutes).')
+        return ip
+
+    def internal_ip(self, node_id: str) -> Optional[str]:
+        """Returns the internal ip (Ray ip) of the given node."""
+        node = self._get_cached_node(node_id=node_id)
+        if node is None:
+            return None
+        ip = node.get('internal_ip')
+        with ux_utils.print_exception_no_traceback():
             if ip is None:
-                node = self._get_node(node_id)
-                ip = node.get_internal_ip()
-
-            return ip
-
-    @_retry
-    def create_node(self, base_config: dict, tags: dict, count: int) -> Dict[str, dict]:
-        """Creates instances.
-
-        Returns dict mapping instance id to each create operation result for the created
-        instances.
-        """
-        with self.lock:
-            result_dict = {}
-            labels = tags  # gcp uses "labels" instead of aws "tags"
-            labels = dict(sorted(copy.deepcopy(labels).items()))
-
-            node_type = get_node_type(base_config)
-            resource = self.resources[node_type]
-
-            # Try to reuse previously stopped nodes with compatible configs
-            if self.cache_stopped_nodes:
-                filters = {
-                    TAG_RAY_NODE_KIND: labels[TAG_RAY_NODE_KIND],
-                    # SkyPilot: removed TAG_RAY_LAUNCH_CONFIG to allow reusing nodes
-                    # with different launch configs.
-                    # Reference: https://github.com/skypilot-org/skypilot/pull/1671
-                }
-                # This tag may not always be present.
-                if TAG_RAY_USER_NODE_TYPE in labels:
-                    filters[TAG_RAY_USER_NODE_TYPE] = labels[TAG_RAY_USER_NODE_TYPE]
-                filters_with_launch_config = copy.copy(filters)
-                filters_with_launch_config[TAG_RAY_LAUNCH_CONFIG] = labels[
-                    TAG_RAY_LAUNCH_CONFIG
-                ]
-
-                # SKY: "TERMINATED" for compute VM, "STOPPED" for TPU VM
-                # "STOPPING" means the VM is being stopped, which needs
-                # to be included to avoid creating a new VM.
-                if isinstance(resource, GCPCompute):
-                    STOPPED_STATUS = ["TERMINATED", "STOPPING"]
-                else:
-                    STOPPED_STATUS = ["STOPPED", "STOPPING"]
-
-                # SkyPilot: We try to use the instances with the same matching launch_config first. If
-                # there is not enough instances with matching launch_config, we then use all the
-                # instances with the same matching launch_config plus some instances with wrong
-                # launch_config.
-                def get_order_key(node):
-                    import datetime
-
-                    timestamp = node.get("lastStartTimestamp")
-                    if timestamp is not None:
-                        return datetime.datetime.strptime(
-                            timestamp, "%Y-%m-%dT%H:%M:%S.%f%z"
-                        )
-                    return node.id
-
-                nodes_matching_launch_config = resource._list_instances(
-                    filters_with_launch_config, STOPPED_STATUS
-                )
-                nodes_matching_launch_config.sort(
-                    key=lambda n: get_order_key(n), reverse=True
-                )
-                if len(nodes_matching_launch_config) >= count:
-                    reuse_nodes = nodes_matching_launch_config[:count]
-                else:
-                    nodes_all = resource._list_instances(filters, STOPPED_STATUS)
-                    nodes_matching_launch_config_ids = set(
-                        n.id for n in nodes_matching_launch_config
-                    )
-                    nodes_non_matching_launch_config = [
-                        n
-                        for n in nodes_all
-                        if n.id not in nodes_matching_launch_config_ids
-                    ]
-                    # This is for backward compatibility, where the uesr already has leaked
-                    # stopped nodes with the different launch config before update to #1671,
-                    # and the total number of the leaked nodes is greater than the number of
-                    # nodes to be created. With this, we will make sure we will reuse the
-                    # most recently used nodes.
-                    # This can be removed in the future when we are sure all the users
-                    # have updated to #1671.
-                    nodes_non_matching_launch_config.sort(
-                        key=lambda n: get_order_key(n), reverse=True
-                    )
-                    reuse_nodes = (
-                        nodes_matching_launch_config + nodes_non_matching_launch_config
-                    )
-                    # The total number of reusable nodes can be less than the number of nodes to be created.
-                    # This `[:count]` is fine, as it will get all the reusable nodes, even if there are
-                    # less nodes.
-                    reuse_nodes = reuse_nodes[:count]
-
-                reuse_node_ids = [n.id for n in reuse_nodes]
-                if reuse_nodes:
-                    # TODO(suquark): Some instances could still be stopping.
-                    # We may wait until these instances stop.
-                    cli_logger.print(
-                        # TODO: handle plural vs singular?
-                        f"Reusing nodes {cli_logger.render_list(reuse_node_ids)}. "
-                        "To disable reuse, set `cache_stopped_nodes: False` "
-                        "under `provider` in the cluster configuration."
-                    )
-                    for node_id in reuse_node_ids:
-                        result = resource.start_instance(node_id)
-                        result_dict[node_id] = {node_id: result}
-                    for node_id in reuse_node_ids:
-                        self.set_node_tags(node_id, tags)
-                    count -= len(reuse_node_ids)
-            if count:
-                results = resource.create_instances(base_config, labels, count)
-                if "sourceMachineImage" in base_config:
-                    for _, instance_id in results:
-                        resource.resize_disk(base_config, instance_id)
-                result_dict.update(
-                    {instance_id: result for result, instance_id in results}
-                )
-            return result_dict
-
-    @_retry
-    def terminate_node(self, node_id: str):
-        with self.lock:
-            result = None
-            resource = self._get_resource_depending_on_node_name(node_id)
-            try:
-                if self.cache_stopped_nodes:
-                    cli_logger.print(
-                        f"Stopping instance {node_id} "
-                        + cf.dimmed(
-                            "(to terminate instead, "
-                            "set `cache_stopped_nodes: False` "
-                            "under `provider` in the cluster configuration)"
-                        ),
-                    )
-                    result = resource.stop_instance(node_id=node_id)
-
-                    # Check if the instance is actually stopped.
-                    # GCP does not fully stop an instance even after
-                    # the stop operation is finished.
-                    for _ in range(MAX_POLLS_STOP):
-                        instance = resource.get_instance(node_id=node_id)
-                        if instance.is_stopped():
-                            logger.info(f"Instance {node_id} is stopped.")
-                            break
-                        elif instance.is_stopping():
-                            time.sleep(POLL_INTERVAL)
-                        else:
-                            raise RuntimeError(
-                                f"Unexpected instance status." " Details: {instance}"
-                            )
-
-                    if instance.is_stopping():
-                        raise RuntimeError(
-                            f"Maximum number of polls: "
-                            f"{MAX_POLLS_STOP} reached. "
-                            f"Instance {node_id} is still in "
-                            "STOPPING status."
-                        )
-                else:
-                    result = resource.delete_instance(
-                        node_id=node_id,
-                    )
-            except googleapiclient.errors.HttpError as http_error:
-                if http_error.resp.status == 404:
-                    logger.warning(
-                        f"Tried to delete the node with id {node_id} "
-                        "but it was already gone."
-                    )
-                else:
-                    raise http_error from None
-
-        return result
-
-    @_retry
-    def _get_node(self, node_id: str) -> GCPNode:
-        self.non_terminated_nodes({})  # Side effect: updates cache
-
-        with self.lock:
-            if node_id in self.cached_nodes:
-                return self.cached_nodes[node_id]
-
-            resource = self._get_resource_depending_on_node_name(node_id)
-            instance = resource.get_instance(node_id=node_id)
+                raise lambda_utils.LambdaCloudError(
+                    'A node ip address was not found. Either '
+                    '(1) Lambda Cloud has internally errored, or '
+                    '(2) the cluster is still booting. '
+                    'You can manually terminate the cluster on the '
+                    'Lambda Cloud console or (in case 2) wait for '
+                    'booting to finish (~2 minutes).')
+        return ip
+
+    def create_node(self, node_config: Dict[str, Any], tags: Dict[str, str],
+                    count: int) -> None:
+        """Creates a number of nodes within the namespace."""
+        # Get tags
+        config_tags = node_config.get('tags', {}).copy()
+        config_tags.update(tags)
+        config_tags[TAG_RAY_CLUSTER_NAME] = self.cluster_name
+
+        # Create nodes
+        instance_type = node_config['InstanceType']
+        region = self.provider_config['region']
+
+        if config_tags[TAG_RAY_NODE_KIND] == NODE_KIND_HEAD:
+            name = f'{self.cluster_name}-head'
+            # Occasionally, the head node will continue running for a short
+            # period after termination. This can lead to the following bug:
+            #   1. Head node autodowns but continues running.
+            #   2. The next autodown event is triggered, which executes ray up.
+            #   3. Head node stops running.
+            # In this case, a new head node is created after the cluster has
+            # terminated. We avoid this with the following check:
+            if self.on_head:
+                raise lambda_utils.LambdaCloudError('Head already exists.')
+        else:
+            name = f'{self.cluster_name}-worker'
 
-            return instance
+        # Lambda launch api only supports launching one node at a time,
+        # so we do a loop. Remove loop when launch api allows quantity > 1
+        booting_list = []
+        for _ in range(count):
+            vm_id = self.lambda_client.create_instances(
+                instance_type=instance_type,
+                region=region,
+                quantity=1,
+                name=name,
+                ssh_key_name=self.ssh_key_name)[0]
+            self.metadata.set(vm_id, {'tags': config_tags})
+            booting_list.append(vm_id)
+            time.sleep(10)  # Avoid api rate limits
+
+        # Wait for nodes to finish booting
+        while True:
+            vms = self._list_instances_in_cluster()
+            for vm_id in booting_list.copy():
+                for vm in vms:
+                    if vm['id'] == vm_id and vm['status'] == 'active':
+                        booting_list.remove(vm_id)
+            if len(booting_list) == 0:
+                return
+            time.sleep(10)
+
+    @synchronized
+    def set_node_tags(self, node_id: str, tags: Dict[str, str]) -> None:
+        """Sets the tag values (string dict) for the specified node."""
+        node = self._get_node(node_id)
+        assert node is not None, node_id
+        node['tags'].update(tags)
+        self.metadata.set(node_id, {'tags': node['tags']})
+
+    def terminate_node(self, node_id: str) -> None:
+        """Terminates the specified node."""
+        self.lambda_client.remove_instances(node_id)
+        self.metadata.set(node_id, None)
+
+    def _get_node(self, node_id: str) -> Optional[Dict[str, Any]]:
+        self._get_filtered_nodes({})  # Side effect: updates cache
+        return self.cached_nodes.get(node_id, None)
 
-    def _get_cached_node(self, node_id: str) -> GCPNode:
+    def _get_cached_node(self, node_id: str) -> Optional[Dict[str, Any]]:
         if node_id in self.cached_nodes:
             return self.cached_nodes[node_id]
-
-        return self._get_node(node_id)
-
-    @staticmethod
-    def bootstrap_config(cluster_config):
-        return bootstrap_gcp(cluster_config)
-
-    def get_command_runner(
-        self,
-        log_prefix,
-        node_id,
-        auth_config,
-        cluster_name,
-        process_runner,
-        use_internal_ip,
-        docker_config=None,
-    ):
-        common_args = {
-            "log_prefix": log_prefix,
-            "node_id": node_id,
-            "provider": self,
-            "auth_config": auth_config,
-            "cluster_name": cluster_name,
-            "process_runner": process_runner,
-            "use_internal_ip": use_internal_ip,
-        }
-        if docker_config and docker_config["container_name"] != "":
-            if "docker_login_config" in self.provider_config:
-                docker_config["docker_login_config"] = docker_utils.DockerLoginConfig(
-                    **self.provider_config["docker_login_config"]
-                )
-            return SkyDockerCommandRunner(docker_config, **common_args)
-        else:
-            return SSHCommandRunner(**common_args)
+        return self._get_node(node_id=node_id)
```

### Comparing `skypilot-0.5.0/sky/skylet/providers/ibm/node_provider.py` & `skypilot-0.6.0/sky/skylet/providers/ibm/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/skylet/providers/ibm/utils.py` & `skypilot-0.6.0/sky/skylet/providers/ibm/utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/skylet/providers/oci/node_provider.py` & `skypilot-0.6.0/sky/skylet/providers/oci/node_provider.py`

 * *Files 2% similar despite different names*

```diff
@@ -204,15 +204,15 @@
 
             for reuse_node in reuse_nodes:
                 if reuse_node["status"] == "STOPPING":
                     get_instance_response = oci_adaptor.get_core_client(
                         self.region,
                         oci_utils.oci_config.get_profile()).get_instance(
                             instance_id=reuse_node["id"])
-                    oci_adaptor.get_oci().wait_until(
+                    oci_adaptor.oci.wait_until(
                         oci_adaptor.get_core_client(
                             self.region, oci_utils.oci_config.get_profile()),
                         get_instance_response,
                         "lifecycle_state",
                         "STOPPED",
                     )
 
@@ -262,29 +262,29 @@
             ocpu_count = 1 if (ocpu_count > 0 and
                                ocpu_count < 1) else ocpu_count
 
             machine_shape_config = None
             if ocpu_count > 0:
                 mem = node_config["MemoryInGbs"]
                 if mem is not None and mem != "None":
-                    machine_shape_config = (oci_adaptor.get_oci().core.models.
+                    machine_shape_config = (oci_adaptor.oci.core.models.
                                             LaunchInstanceShapeConfigDetails(
                                                 ocpus=ocpu_count,
                                                 memory_in_gbs=mem))
                 else:
-                    machine_shape_config = (oci_adaptor.get_oci().core.models.
+                    machine_shape_config = (oci_adaptor.oci.core.models.
                                             LaunchInstanceShapeConfigDetails(
                                                 ocpus=ocpu_count))
 
-            preempitible_config = (oci_adaptor.get_oci(
-            ).core.models.PreemptibleInstanceConfigDetails(
-                preemption_action=oci_adaptor.get_oci().core.models.
-                TerminatePreemptionAction(type="TERMINATE",
-                                          preserve_boot_volume=False))
-                                   if node_config["Preemptible"] else None)
+            preempitible_config = (
+                oci_adaptor.oci.core.models.PreemptibleInstanceConfigDetails(
+                    preemption_action=oci_adaptor.oci.core.models.
+                    TerminatePreemptionAction(type="TERMINATE",
+                                              preserve_boot_volume=False))
+                if node_config["Preemptible"] else None)
 
             logger.debug(f"Shape: {instance_type_str}, ocpu: {ocpu_count}")
             logger.debug(f"Shape config is {machine_shape_config}")
             logger.debug(f"Spot config is {preempitible_config}")
 
             vm_tags = {
                 **tags,
@@ -302,41 +302,43 @@
                 region=self.region,
             )
 
             start_time1 = round(time.time() * 1000)
             for seq in range(1, count + 1):
                 launch_instance_response = oci_adaptor.get_core_client(
                     self.region, oci_utils.oci_config.get_profile()
-                ).launch_instance(launch_instance_details=oci_adaptor.get_oci(
-                ).core.models.LaunchInstanceDetails(
-                    availability_domain=node_config["AvailabilityDomain"],
-                    compartment_id=compartment,
-                    shape=instance_type_str,
-                    display_name=
-                    f"{self.cluster_name}_{node_type}_{batch_id}_{seq}",
-                    freeform_tags=vm_tags,
-                    metadata={
-                        "ssh_authorized_keys": node_config["AuthorizedKey"]
-                    },
-                    source_details=oci_adaptor.get_oci(
-                    ).core.models.InstanceSourceViaImageDetails(
-                        source_type="image",
-                        image_id=node_config["ImageId"],
-                        boot_volume_size_in_gbs=node_config["BootVolumeSize"],
-                        boot_volume_vpus_per_gb=int(
-                            node_config["BootVolumePerf"]),
-                    ),
-                    create_vnic_details=oci_adaptor.get_oci(
-                    ).core.models.CreateVnicDetails(
-                        assign_public_ip=True,
-                        subnet_id=vcn,
-                    ),
-                    shape_config=machine_shape_config,
-                    preemptible_instance_config=preempitible_config,
-                ))
+                ).launch_instance(
+                    launch_instance_details=oci_adaptor.oci.core.models.
+                    LaunchInstanceDetails(
+                        availability_domain=node_config["AvailabilityDomain"],
+                        compartment_id=compartment,
+                        shape=instance_type_str,
+                        display_name=
+                        f"{self.cluster_name}_{node_type}_{batch_id}_{seq}",
+                        freeform_tags=vm_tags,
+                        metadata={
+                            "ssh_authorized_keys": node_config["AuthorizedKey"]
+                        },
+                        source_details=oci_adaptor.oci.core.models.
+                        InstanceSourceViaImageDetails(
+                            source_type="image",
+                            image_id=node_config["ImageId"],
+                            boot_volume_size_in_gbs=node_config[
+                                "BootVolumeSize"],
+                            boot_volume_vpus_per_gb=int(
+                                node_config["BootVolumePerf"]),
+                        ),
+                        create_vnic_details=oci_adaptor.oci.core.models.
+                        CreateVnicDetails(
+                            assign_public_ip=True,
+                            subnet_id=vcn,
+                        ),
+                        shape_config=machine_shape_config,
+                        preemptible_instance_config=preempitible_config,
+                    ))
 
                 new_inst = launch_instance_response.data
                 starting_insts.append({
                     "inst_id": new_inst.id,
                     "ad": new_inst.availability_domain,
                     "compartment": new_inst.compartment_id,
                     "lifecycle_state": new_inst.lifecycle_state,
@@ -350,15 +352,15 @@
         # end if count > 0:...
 
         for ninst in starting_insts:
             # Waiting for the instance to be RUNNING state
             get_instance_response = oci_adaptor.get_core_client(
                 self.region, oci_utils.oci_config.get_profile()).get_instance(
                     instance_id=ninst["inst_id"])
-            oci_adaptor.get_oci().wait_until(
+            oci_adaptor.oci.wait_until(
                 oci_adaptor.get_core_client(self.region,
                                             oci_utils.oci_config.get_profile()),
                 get_instance_response,
                 "lifecycle_state",
                 "RUNNING",
             )
             ninst["lifecycle_state"] = "RUNNING"
@@ -405,17 +407,16 @@
         retry_count = 0
         while retry_count < oci_utils.oci_config.MAX_RETRY_COUNT:
             try:
                 oci_adaptor.get_core_client(
                     self.region,
                     oci_utils.oci_config.get_profile()).update_instance(
                         instance_id=node_id,
-                        update_instance_details=oci_adaptor.get_oci().core.
-                        models.UpdateInstanceDetails(
-                            freeform_tags=combined_tags),
+                        update_instance_details=oci_adaptor.oci.core.models.
+                        UpdateInstanceDetails(freeform_tags=combined_tags),
                     )
                 logger.info(f"Tags are well set for node {node_id}")
                 break
             except Exception as e:
                 retry_count = retry_count + 1
                 wait_seconds = oci_utils.oci_config.RETRY_INTERVAL_BASE_SECONDS * retry_count
                 logger.warn(
```

### Comparing `skypilot-0.5.0/sky/skylet/providers/oci/query_helper.py` & `skypilot-0.6.0/sky/skylet/providers/oci/query_helper.py`

 * *Files 4% similar despite different names*

```diff
@@ -8,22 +8,27 @@
 """
 
 from datetime import datetime
 import logging
 import re
 import time
 import traceback
+import typing
 from typing import Optional
 
-import pandas as pd
-
+from sky.adaptors import common as adaptors_common
 from sky.adaptors import oci as oci_adaptor
 from sky.clouds.utils import oci_utils
 from sky.skylet.providers.oci import utils
 
+if typing.TYPE_CHECKING:
+    import pandas as pd
+else:
+    pd = adaptors_common.LazyImport('pandas')
+
 logger = logging.getLogger(__name__)
 
 
 class oci_query_helper:
 
     # Call Cloud API to try getting the satisfied nodes.
     @classmethod
@@ -39,19 +44,18 @@
             where_clause_tags += (f"(freeformTags.key = '{tag_key}'"
                                   f" && freeformTags.value = '{tag_value}')")
 
         qv_str = (f"query instance resources where {where_clause_tags}"
                   f" && (lifecycleState != 'TERMINATED'"
                   f" && lifecycleState != 'TERMINATING')")
 
-        qv = oci_adaptor.get_oci(
-        ).resource_search.models.StructuredSearchDetails(
+        qv = oci_adaptor.oci.resource_search.models.StructuredSearchDetails(
             query=qv_str,
             type="Structured",
-            matching_context_type=oci_adaptor.get_oci().resource_search.models.
+            matching_context_type=oci_adaptor.oci.resource_search.models.
             SearchDetails.MATCHING_CONTEXT_TYPE_NONE,
         )
 
         list_instances_response = oci_adaptor.get_search_client(
             region, oci_utils.oci_config.get_profile()).search_resources(qv)
         result_set = list_instances_response.data.items
 
@@ -95,16 +99,16 @@
             region, oci_utils.oci_config.get_profile())
         try:
             agreements_response = core_client.get_app_catalog_listing_agreements(
                 listing_id=listing_id, resource_version=resource_version)
             agreements = agreements_response.data
 
             core_client.create_app_catalog_subscription(
-                create_app_catalog_subscription_details=oci_adaptor.get_oci(
-                ).core.models.CreateAppCatalogSubscriptionDetails(
+                create_app_catalog_subscription_details=oci_adaptor.oci.core.
+                models.CreateAppCatalogSubscriptionDetails(
                     compartment_id=compartment_id,
                     listing_id=listing_id,
                     listing_resource_version=agreements.
                     listing_resource_version,
                     oracle_terms_of_use_link=agreements.
                     oracle_terms_of_use_link,
                     time_retrieved=datetime.strptime(
@@ -198,44 +202,44 @@
 
     @classmethod
     @utils.debug_enabled(logger=logger)
     def create_vcn_subnet(cls, net_client,
                           skypilot_compartment) -> Optional[str]:
         try:
             create_vcn_response = net_client.create_vcn(
-                create_vcn_details=oci_adaptor.get_oci().core.models.
-                CreateVcnDetails(compartment_id=skypilot_compartment,
-                                 cidr_blocks=[oci_utils.oci_config.VCN_CIDR],
-                                 display_name=oci_utils.oci_config.VCN_NAME,
-                                 is_ipv6_enabled=False,
-                                 dns_label=oci_utils.oci_config.VCN_DNS_LABEL))
+                create_vcn_details=oci_adaptor.oci.core.models.CreateVcnDetails(
+                    compartment_id=skypilot_compartment,
+                    cidr_blocks=[oci_utils.oci_config.VCN_CIDR],
+                    display_name=oci_utils.oci_config.VCN_NAME,
+                    is_ipv6_enabled=False,
+                    dns_label=oci_utils.oci_config.VCN_DNS_LABEL))
             vcn_data = create_vcn_response.data
             logger.debug(f'Created VCN \n{vcn_data}')
             skypilot_vcn = vcn_data.id
             route_table = vcn_data.default_route_table_id
             security_list = vcn_data.default_security_list_id
             dhcp_options_id = vcn_data.default_dhcp_options_id
 
             # Create internet gateway for internet access
             create_ig_response = net_client.create_internet_gateway(
-                create_internet_gateway_details=oci_adaptor.get_oci(
-                ).core.models.CreateInternetGatewayDetails(
+                create_internet_gateway_details=oci_adaptor.oci.core.models.
+                CreateInternetGatewayDetails(
                     compartment_id=skypilot_compartment,
                     is_enabled=True,
                     vcn_id=skypilot_vcn,
-                    display_name=oci_utils.oci_config.VCN_INTERNET_GATEWAY_NAME)
-            )
+                    display_name=oci_utils.oci_config.VCN_INTERNET_GATEWAY_NAME
+                ))
             logger.debug(
                 f'Created internet gateway \n{create_ig_response.data}')
             ig = create_ig_response.data.id
 
             # Create a public subnet.
             create_subnet_response = net_client.create_subnet(
-                create_subnet_details=oci_adaptor.get_oci(
-                ).core.models.CreateSubnetDetails(
+                create_subnet_details=oci_adaptor.oci.core.models.
+                CreateSubnetDetails(
                     cidr_block=oci_utils.oci_config.VCN_SUBNET_CIDR,
                     compartment_id=skypilot_compartment,
                     vcn_id=skypilot_vcn,
                     dhcp_options_id=dhcp_options_id,
                     display_name=oci_utils.oci_config.VCN_SUBNET_NAME,
                     prohibit_internet_ingress=False,
                     prohibit_public_ip_on_vnic=False,
@@ -249,74 +253,74 @@
                 s for s in list_services_response.data
                 if str(s.cidr_block).startswith('all-') and str(s.cidr_block).
                 endswith('-services-in-oracle-services-network')
             ]
             if len(services) > 0:
                 # Create service gateway for regional services.
                 create_sg_response = net_client.create_service_gateway(
-                    create_service_gateway_details=oci_adaptor.get_oci(
-                    ).core.models.CreateServiceGatewayDetails(
+                    create_service_gateway_details=oci_adaptor.oci.core.models.
+                    CreateServiceGatewayDetails(
                         compartment_id=skypilot_compartment,
                         services=[
-                            oci_adaptor.get_oci().core.models.
-                            ServiceIdRequestDetails(service_id=services[0].id)
+                            oci_adaptor.oci.core.models.ServiceIdRequestDetails(
+                                service_id=services[0].id)
                         ],
                         vcn_id=skypilot_vcn))
                 logger.debug(f'Service Gateway: \n{create_sg_response.data}')
                 sg = create_sg_response.data.id
 
             # Update security list: Allow all traffic in the same subnet
             update_security_list_response = net_client.update_security_list(
                 security_list_id=security_list,
-                update_security_list_details=oci_adaptor.get_oci(
-                ).core.models.UpdateSecurityListDetails(ingress_security_rules=[
-                    oci_adaptor.get_oci().core.models.IngressSecurityRule(
+                update_security_list_details=oci_adaptor.oci.core.models.
+                UpdateSecurityListDetails(ingress_security_rules=[
+                    oci_adaptor.oci.core.models.IngressSecurityRule(
                         protocol="6",
                         source=oci_utils.oci_config.VCN_CIDR_INTERNET,
                         is_stateless=False,
                         source_type="CIDR_BLOCK",
-                        tcp_options=oci_adaptor.get_oci().core.models.
-                        TcpOptions(destination_port_range=oci_adaptor.get_oci().
-                                   core.models.PortRange(max=22, min=22),
-                                   source_port_range=oci_adaptor.get_oci(
-                                   ).core.models.PortRange(max=65535, min=1)),
+                        tcp_options=oci_adaptor.oci.core.models.TcpOptions(
+                            destination_port_range=oci_adaptor.oci.core.models.
+                            PortRange(max=22, min=22),
+                            source_port_range=oci_adaptor.oci.core.models.
+                            PortRange(max=65535, min=1)),
                         description="Allow SSH port."),
-                    oci_adaptor.get_oci().core.models.IngressSecurityRule(
+                    oci_adaptor.oci.core.models.IngressSecurityRule(
                         protocol="all",
                         source=oci_utils.oci_config.VCN_SUBNET_CIDR,
                         is_stateless=False,
                         source_type="CIDR_BLOCK",
                         description="Allow all traffic from/to same subnet."),
-                    oci_adaptor.get_oci().core.models.IngressSecurityRule(
+                    oci_adaptor.oci.core.models.IngressSecurityRule(
                         protocol="1",
                         source=oci_utils.oci_config.VCN_CIDR_INTERNET,
                         is_stateless=False,
                         source_type="CIDR_BLOCK",
-                        icmp_options=oci_adaptor.get_oci(
-                        ).core.models.IcmpOptions(type=3, code=4),
+                        icmp_options=oci_adaptor.oci.core.models.IcmpOptions(
+                            type=3, code=4),
                         description="ICMP traffic."),
-                    oci_adaptor.get_oci().core.models.IngressSecurityRule(
+                    oci_adaptor.oci.core.models.IngressSecurityRule(
                         protocol="1",
                         source=oci_utils.oci_config.VCN_CIDR,
                         is_stateless=False,
                         source_type="CIDR_BLOCK",
-                        icmp_options=oci_adaptor.get_oci(
-                        ).core.models.IcmpOptions(type=3),
+                        icmp_options=oci_adaptor.oci.core.models.IcmpOptions(
+                            type=3),
                         description="ICMP traffic (VCN)."),
                 ]))
             logger.debug(
                 f'Updated security_list: \n{update_security_list_response.data}'
             )
 
             # Update route table: bind to the internet gateway
             update_route_table_response = net_client.update_route_table(
                 rt_id=route_table,
-                update_route_table_details=oci_adaptor.get_oci(
-                ).core.models.UpdateRouteTableDetails(route_rules=[
-                    oci_adaptor.get_oci().core.models.RouteRule(
+                update_route_table_details=oci_adaptor.oci.core.models.
+                UpdateRouteTableDetails(route_rules=[
+                    oci_adaptor.oci.core.models.RouteRule(
                         network_entity_id=create_ig_response.data.id,
                         destination='0.0.0.0/0',
                         destination_type='CIDR_BLOCK',
                         description='Route table for SkyPilot VCN',
                         route_type='STATIC')
                 ]))
             logger.debug(f'Route table: \n{update_route_table_response.data}')
```

### Comparing `skypilot-0.5.0/sky/skylet/providers/scp/config.py` & `skypilot-0.6.0/sky/skylet/providers/scp/config.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/skylet/providers/scp/node_provider.py` & `skypilot-0.6.0/sky/skylet/providers/scp/node_provider.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/skylet/ray_patches/__init__.py` & `skypilot-0.6.0/sky/skylet/ray_patches/__init__.py`

 * *Files 5% similar despite different names*

```diff
@@ -23,16 +23,14 @@
 
   >> # Inspect command_runner.py.patch.
   >> # Edit this file to include command_runner.py.patch.
 """
 import os
 import subprocess
 
-import pkg_resources
-
 from sky.skylet import constants
 
 
 def _to_absolute(pwd_file):
     return os.path.join(os.path.dirname(os.path.abspath(__file__)), pwd_file)
 
 
@@ -77,10 +75,7 @@
 
     from ray.autoscaler._private import resource_demand_scheduler
     _run_patch(resource_demand_scheduler.__file__,
                _to_absolute('resource_demand_scheduler.py.patch'))
 
     from ray.autoscaler._private import updater
     _run_patch(updater.__file__, _to_absolute('updater.py.patch'))
-
-    from ray.dashboard.modules.job import job_head
-    _run_patch(job_head.__file__, _to_absolute('job_head.py.patch'))
```

### Comparing `skypilot-0.5.0/sky/skylet/ray_patches/resource_demand_scheduler.py.patch` & `skypilot-0.6.0/sky/skylet/ray_patches/resource_demand_scheduler.py.patch`

 * *Files 21% similar despite different names*

```diff
@@ -1,17 +1,17 @@
 0a1,5
-> # From https://github.com/ray-project/ray/blob/ray-2.4.0/python/ray/autoscaler/_private/resource_demand_scheduler.py
+> # From https://github.com/ray-project/ray/blob/ray-2.9.3/python/ray/autoscaler/_private/resource_demand_scheduler.py
 > # Sky patch changes:
 > #  - no new nodes are allowed to be launched launched when the upscaling_speed is 0
 > #  - comment out "assert not unfulfilled": this seems a buggy assert
 > 
-450c455,458
+451c456,459
 <             if upper_bound > 0:
 ---
 >             # NOTE(sky): do not autoscale when upsclaing speed is 0.
 >             if self.upscaling_speed == 0:
 >                 upper_bound = 0
 >             if upper_bound >= 0:
-594c602
+595c603
 <             assert not unfulfilled
 ---
 >             # assert not unfulfilled  # NOTE(sky): buggy assert.
```

### Comparing `skypilot-0.5.0/sky/skylet/ray_patches/worker.py.patch` & `skypilot-0.6.0/sky/skylet/ray_patches/worker.py.patch`

 * *Files 9% similar despite different names*

```diff
@@ -1,18 +1,18 @@
 0a1,4
-> # Adapted from https://github.com/ray-project/ray/blob/ray-2.4.0/python/ray/_private/worker.py
+> # Adapted from https://github.com/ray-project/ray/blob/ray-2.9.3/python/ray/_private/worker.py
 > # Fixed the problem in ray's issue https://github.com/ray-project/ray/issues/9233
 > # Tracked in PR https://github.com/ray-project/ray/pull/21977/files.
 > 
-1872a1877,1884
-> 
+2022a2027,2034
 >     def end_for(line: str) -> str:
 >         if sys.platform == "win32":
 >             return "\n"
 >         if line.endswith("\r"):
 >             return ""
 >         return "\n"
 > 
-1896a1909
+> 
+2037a2050
 >                     end=end_for(line),
-1914a1928
+2054a2068
 >                     end=end_for(line),
```

### Comparing `skypilot-0.5.0/sky/skylet/skylet.py` & `skypilot-0.6.0/sky/skylet/skylet.py`

 * *Files 9% similar despite different names*

```diff
@@ -13,18 +13,18 @@
 logger = sky_logging.init_logger('sky.skylet.skylet')
 logger.info(f'Skylet started with version {constants.SKYLET_VERSION}; '
             f'SkyPilot v{sky.__version__} (commit: {sky.__commit__})')
 
 EVENTS = [
     events.AutostopEvent(),
     events.JobSchedulerEvent(),
-    # The spot job update event should be after the job update event.
-    # Otherwise, the abnormal spot job status update will be delayed
+    # The managed job update event should be after the job update event.
+    # Otherwise, the abnormal managed job status update will be delayed
     # until the next job update event.
-    events.SpotJobUpdateEvent(),
+    events.ManagedJobUpdateEvent(),
     # This is for monitoring controller job status. If it becomes
     # unhealthy, this event will correctly update the controller
     # status to CONTROLLER_FAILED.
     events.ServiceUpdateEvent(),
 ]
 
 while True:
```

### Comparing `skypilot-0.5.0/sky/skylet/subprocess_daemon.py` & `skypilot-0.6.0/sky/skylet/subprocess_daemon.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/skypilot_config.py` & `skypilot-0.6.0/sky/skypilot_config.py`

 * *Files 10% similar despite different names*

```diff
@@ -47,26 +47,27 @@
 from typing import Any, Dict, Iterable, Optional
 
 import yaml
 
 from sky import sky_logging
 from sky.utils import common_utils
 from sky.utils import schemas
+from sky.utils import ux_utils
 
 # The config path is discovered in this order:
 #
 # (1) (Used internally) If env var {ENV_VAR_SKYPILOT_CONFIG} exists, use its
 #     path;
 # (2) If file {CONFIG_PATH} exists, use this file.
 #
 # If the path discovered by (1) fails to load, we do not attempt to go to step
 # 2 in the list.
 
 # (Used internally) An env var holding the path to the local config file. This
-# is only used by spot controller tasks to ensure recoveries of the same job
+# is only used by jobs controller tasks to ensure recoveries of the same job
 # use the same config file.
 ENV_VAR_SKYPILOT_CONFIG = 'SKYPILOT_CONFIG'
 
 # Path to the local config file.
 CONFIG_PATH = '~/.sky/config.yaml'
 
 logger = sky_logging.init_logger(__name__)
@@ -124,15 +125,22 @@
     return {}
 
 
 def _try_load_config() -> None:
     global _dict, _loaded_config_path
     config_path_via_env_var = os.environ.get(ENV_VAR_SKYPILOT_CONFIG)
     if config_path_via_env_var is not None:
-        config_path = config_path_via_env_var
+        config_path = os.path.expanduser(config_path_via_env_var)
+        if not os.path.exists(config_path):
+            with ux_utils.print_exception_no_traceback():
+                raise FileNotFoundError(
+                    'Config file specified by env var '
+                    f'{ENV_VAR_SKYPILOT_CONFIG} ({config_path!r}) does not '
+                    'exist. Please double check the path or unset the env var: '
+                    f'unset {ENV_VAR_SKYPILOT_CONFIG}')
     else:
         config_path = CONFIG_PATH
     config_path = os.path.expanduser(config_path)
     if os.path.exists(config_path):
         logger.debug(f'Using config path: {config_path}')
         _loaded_config_path = config_path
         try:
@@ -140,15 +148,17 @@
             logger.debug(f'Config loaded:\n{pprint.pformat(_dict)}')
         except yaml.YAMLError as e:
             logger.error(f'Error in loading config file ({config_path}):', e)
         if _dict is not None:
             common_utils.validate_schema(
                 _dict,
                 schemas.get_config_schema(),
-                f'Invalid config YAML ({config_path}): ',
+                f'Invalid config YAML ({config_path}). See: '
+                'https://skypilot.readthedocs.io/en/latest/reference/config.html. '  # pylint: disable=line-too-long
+                'Error: ',
                 skip_none=False)
 
         logger.debug('Config syntax check passed.')
 
 
 def loaded_config_path() -> Optional[str]:
     """Returns the path to the loaded config file."""
```

### Comparing `skypilot-0.5.0/sky/spot/constants.py` & `skypilot-0.6.0/sky/jobs/constants.py`

 * *Files 24% similar despite different names*

```diff
@@ -1,22 +1,27 @@
-"""Constants used for Managed Spot."""
+"""Constants used for Managed Jobs."""
 
-SPOT_CONTROLLER_TEMPLATE = 'spot-controller.yaml.j2'
-SPOT_CONTROLLER_YAML_PREFIX = '~/.sky/spot_controller'
+JOBS_CONTROLLER_TEMPLATE = 'jobs-controller.yaml.j2'
+JOBS_CONTROLLER_YAML_PREFIX = '~/.sky/jobs_controller'
 
-SPOT_TASK_YAML_PREFIX = '~/.sky/spot_tasks'
+JOBS_TASK_YAML_PREFIX = '~/.sky/managed_jobs'
 
-# Resources as a dict for the spot controller.
-# Use default CPU instance type for spot controller with >= 24GB, i.e.
+# Resources as a dict for the jobs controller.
+# Use default CPU instance type for jobs controller with >= 24GB, i.e.
 # m6i.2xlarge (8vCPUs, 32 GB) for AWS, Standard_D8s_v4 (8vCPUs, 32 GB)
 # for Azure, and n1-standard-8 (8 vCPUs, 32 GB) for GCP, etc.
 # Based on profiling, memory should be at least 3x (in GB) as num vCPUs to avoid
-# OOM (each vCPU can have 4 spot controller processes as we set the CPU
-# requirement to 0.25, and 3 GB is barely enough for 4 spot processes).
+# OOM (each vCPU can have 4 jobs controller processes as we set the CPU
+# requirement to 0.25, and 3 GB is barely enough for 4 job processes).
 # We use 50 GB disk size to reduce the cost.
 CONTROLLER_RESOURCES = {'cpus': '8+', 'memory': '3x', 'disk_size': 50}
 
 # Max length of the cluster name for GCP is 35, the user hash to be attached is
 # 4+1 chars, and we assume the maximum length of the job id is 4+1, so the max
 # length of the cluster name prefix is 25 to avoid the cluster name being too
 # long and truncated twice during the cluster creation.
-SPOT_CLUSTER_NAME_PREFIX_LENGTH = 25
+JOBS_CLUSTER_NAME_PREFIX_LENGTH = 25
+
+# The version of the lib files that jobs/utils use. Whenever there is an API
+# change for the jobs/utils, we need to bump this version and update
+# job.utils.ManagedJobCodeGen to handle the version update.
+MANAGED_JOBS_VERSION = 1
```

### Comparing `skypilot-0.5.0/sky/spot/controller.py` & `skypilot-0.6.0/sky/jobs/controller.py`

 * *Files 18% similar despite different names*

```diff
@@ -1,8 +1,8 @@
-"""Controller: handles the life cycle of a managed spot cluster (job)."""
+"""Controller: handles the life cycle of a managed job."""
 import argparse
 import multiprocessing
 import os
 import pathlib
 import time
 import traceback
 import typing
@@ -11,95 +11,104 @@
 import filelock
 
 from sky import exceptions
 from sky import sky_logging
 from sky import status_lib
 from sky.backends import backend_utils
 from sky.backends import cloud_vm_ray_backend
+from sky.jobs import recovery_strategy
+from sky.jobs import state as managed_job_state
+from sky.jobs import utils as managed_job_utils
 from sky.skylet import constants
 from sky.skylet import job_lib
-from sky.spot import recovery_strategy
-from sky.spot import spot_state
-from sky.spot import spot_utils
 from sky.usage import usage_lib
 from sky.utils import common_utils
 from sky.utils import controller_utils
 from sky.utils import dag_utils
 from sky.utils import subprocess_utils
 from sky.utils import ux_utils
 
 if typing.TYPE_CHECKING:
     import sky
 
 # Use the explicit logger name so that the logger is under the
-# `sky.spot.controller` namespace when executed directly, so as
+# `sky.jobs.controller` namespace when executed directly, so as
 # to inherit the setup from the `sky` logger.
-logger = sky_logging.init_logger('sky.spot.controller')
+logger = sky_logging.init_logger('sky.jobs.controller')
 
 
 def _get_dag_and_name(dag_yaml: str) -> Tuple['sky.Dag', str]:
     dag = dag_utils.load_chain_dag_from_yaml(dag_yaml)
     dag_name = dag.name
     assert dag_name is not None, dag
     return dag, dag_name
 
 
-class SpotController:
-    """Each spot controller manages the life cycle of one spot job."""
+class JobsController:
+    """Each jobs controller manages the life cycle of one managed job."""
 
     def __init__(self, job_id: int, dag_yaml: str,
                  retry_until_up: bool) -> None:
         self._job_id = job_id
         self._dag, self._dag_name = _get_dag_and_name(dag_yaml)
         logger.info(self._dag)
         self._retry_until_up = retry_until_up
         # TODO(zhwu): this assumes the specific backend.
         self._backend = cloud_vm_ray_backend.CloudVmRayBackend()
 
         # pylint: disable=line-too-long
         # Add a unique identifier to the task environment variables, so that
         # the user can have the same id for multiple recoveries.
-        #   Example value: sky-2022-10-04-22-46-52-467694_spot_id-17-1
+        #   Example value: sky-2022-10-04-22-46-52-467694_my-spot-name_spot_id-17-0
         job_id_env_vars = []
-        for i in range(len(self._dag.tasks)):
+        for i, task in enumerate(self._dag.tasks):
+            if len(self._dag.tasks) <= 1:
+                task_name = self._dag_name
+            else:
+                task_name = task.name
+                # This is guaranteed by the spot_launch API, where we fill in
+                # the task.name with
+                # dag_utils.maybe_infer_and_fill_dag_and_task_names.
+                assert task_name is not None, self._dag
+                task_name = f'{self._dag_name}_{task_name}'
             job_id_env_var = common_utils.get_global_job_id(
                 self._backend.run_timestamp,
-                'spot',
+                f'{task_name}',
                 str(self._job_id),
-                task_id=i)
+                task_id=i,
+                is_managed_job=True)
             job_id_env_vars.append(job_id_env_var)
 
         for i, task in enumerate(self._dag.tasks):
             task_envs = task.envs or {}
-            task_envs[constants.TASK_ID_ENV_VAR_DEPRECATED] = job_id_env_vars[i]
             task_envs[constants.TASK_ID_ENV_VAR] = job_id_env_vars[i]
             task_envs[constants.TASK_ID_LIST_ENV_VAR] = '\n'.join(
                 job_id_env_vars)
             task.update_envs(task_envs)
 
     def _download_log_and_stream(
             self,
             handle: cloud_vm_ray_backend.CloudVmRayResourceHandle) -> None:
-        """Downloads and streams the logs of the latest job of a spot cluster.
+        """Downloads and streams the logs of the latest job.
 
-        We do not stream the logs from the spot cluster directly, as the
+        We do not stream the logs from the cluster directly, as the
         donwload and stream should be faster, and more robust against
         preemptions or ssh disconnection during the streaming.
         """
-        spot_job_logs_dir = os.path.join(constants.SKY_LOGS_DIRECTORY,
-                                         'spot_jobs')
+        managed_job_logs_dir = os.path.join(constants.SKY_LOGS_DIRECTORY,
+                                            'managed_jobs')
         controller_utils.download_and_stream_latest_job_log(
-            self._backend, handle, spot_job_logs_dir)
+            self._backend, handle, managed_job_logs_dir)
         logger.info(f'\n== End of logs (ID: {self._job_id}) ==')
 
     def _run_one_task(self, task_id: int, task: 'sky.Task') -> bool:
-        """Busy loop monitoring spot cluster status and handling recovery.
+        """Busy loop monitoring cluster status and handling recovery.
 
         When the task is successfully completed, this function returns True,
-        and will terminate the spot cluster before returning.
+        and will terminate the cluster before returning.
 
         If the user program fails, i.e. the task is set to FAILED or
         FAILED_SETUP, this function will return False.
         In other cases, the function will raise exceptions.
         All the failure cases will rely on the caller to clean up the spot
         cluster(s) and storages.
 
@@ -117,192 +126,205 @@
                 cloud user identity, or unsupported feature.
             exceptions.SpotJobReachedMaxRetryError: This will be raised when
                 all prechecks passed but the maximum number of retries is
                 reached for `sky.launch`. The failure of `sky.launch` can be
                 due to:
                 1. Any of the underlying failover exceptions is due to resources
                 unavailability.
-                2. The cluster is preempted before the job is submitted.
+                2. The cluster is preempted or failed before the job is
+                submitted.
                 3. Any unexpected error happens during the `sky.launch`.
         Other exceptions may be raised depending on the backend.
         """
 
-        callback_func = spot_utils.event_callback_func(job_id=self._job_id,
-                                                       task_id=task_id,
-                                                       task=task)
+        callback_func = managed_job_utils.event_callback_func(
+            job_id=self._job_id, task_id=task_id, task=task)
         if task.run is None:
             logger.info(f'Skip running task {task_id} ({task.name}) due to its '
                         'run commands being empty.')
             # Call set_started first to initialize columns in the state table,
             # including start_at and last_recovery_at to avoid issues for
             # uninitialized columns.
-            spot_state.set_started(job_id=self._job_id,
-                                   task_id=task_id,
-                                   start_time=time.time(),
-                                   callback_func=callback_func)
-            spot_state.set_succeeded(job_id=self._job_id,
-                                     task_id=task_id,
-                                     end_time=time.time(),
-                                     callback_func=callback_func)
+            managed_job_state.set_started(job_id=self._job_id,
+                                          task_id=task_id,
+                                          start_time=time.time(),
+                                          callback_func=callback_func)
+            managed_job_state.set_succeeded(job_id=self._job_id,
+                                            task_id=task_id,
+                                            end_time=time.time(),
+                                            callback_func=callback_func)
             return True
         usage_lib.messages.usage.update_task_id(task_id)
         task_id_env_var = task.envs[constants.TASK_ID_ENV_VAR]
         submitted_at = time.time()
         if task_id == 0:
             submitted_at = backend_utils.get_timestamp_from_run_timestamp(
                 self._backend.run_timestamp)
-        spot_state.set_submitted(
+        managed_job_state.set_submitted(
             self._job_id,
             task_id,
             self._backend.run_timestamp,
             submitted_at,
-            resources_str=backend_utils.get_task_resources_str(task),
+            resources_str=backend_utils.get_task_resources_str(
+                task, is_managed_job=True),
             callback_func=callback_func)
         logger.info(
-            f'Submitted spot job {self._job_id} (task: {task_id}, name: '
+            f'Submitted managed job {self._job_id} (task: {task_id}, name: '
             f'{task.name!r}); {constants.TASK_ID_ENV_VAR}: {task_id_env_var}')
         assert task.name is not None, task
-        cluster_name = spot_utils.generate_spot_cluster_name(
+        cluster_name = managed_job_utils.generate_managed_job_cluster_name(
             task.name, self._job_id)
         self._strategy_executor = recovery_strategy.StrategyExecutor.make(
             cluster_name, self._backend, task, self._retry_until_up)
 
         logger.info('Started monitoring.')
-        spot_state.set_starting(job_id=self._job_id,
-                                task_id=task_id,
-                                callback_func=callback_func)
+        managed_job_state.set_starting(job_id=self._job_id,
+                                       task_id=task_id,
+                                       callback_func=callback_func)
         remote_job_submitted_at = self._strategy_executor.launch()
         assert remote_job_submitted_at is not None, remote_job_submitted_at
 
-        spot_state.set_started(job_id=self._job_id,
-                               task_id=task_id,
-                               start_time=remote_job_submitted_at,
-                               callback_func=callback_func)
+        managed_job_state.set_started(job_id=self._job_id,
+                                      task_id=task_id,
+                                      start_time=remote_job_submitted_at,
+                                      callback_func=callback_func)
         while True:
-            time.sleep(spot_utils.JOB_STATUS_CHECK_GAP_SECONDS)
+            time.sleep(managed_job_utils.JOB_STATUS_CHECK_GAP_SECONDS)
 
             # Check the network connection to avoid false alarm for job failure.
             # Network glitch was observed even in the VM.
             try:
                 backend_utils.check_network_connection()
             except exceptions.NetworkError:
-                logger.info(
-                    'Network is not available. Retrying again in '
-                    f'{spot_utils.JOB_STATUS_CHECK_GAP_SECONDS} seconds.')
+                logger.info('Network is not available. Retrying again in '
+                            f'{managed_job_utils.JOB_STATUS_CHECK_GAP_SECONDS} '
+                            'seconds.')
                 continue
 
             # NOTE: we do not check cluster status first because race condition
             # can occur, i.e. cluster can be down during the job status check.
-            job_status = spot_utils.get_job_status(self._backend, cluster_name)
+            job_status = managed_job_utils.get_job_status(
+                self._backend, cluster_name)
 
             if job_status == job_lib.JobStatus.SUCCEEDED:
-                end_time = spot_utils.get_job_timestamp(self._backend,
-                                                        cluster_name,
-                                                        get_end_time=True)
+                end_time = managed_job_utils.get_job_timestamp(
+                    self._backend, cluster_name, get_end_time=True)
                 # The job is done.
-                spot_state.set_succeeded(self._job_id,
-                                         task_id,
-                                         end_time=end_time,
-                                         callback_func=callback_func)
+                managed_job_state.set_succeeded(self._job_id,
+                                                task_id,
+                                                end_time=end_time,
+                                                callback_func=callback_func)
                 logger.info(
                     f'Spot job {self._job_id} (task: {task_id}) SUCCEEDED. '
-                    f'Cleaning up the spot cluster {cluster_name}.')
-                # Only clean up the spot cluster, not the storages, because
-                # tasks may share storages.
+                    f'Cleaning up the cluster {cluster_name}.')
+                # Only clean up the cluster, not the storages, because tasks may
+                # share storages.
                 recovery_strategy.terminate_cluster(cluster_name=cluster_name)
                 return True
 
             # For single-node jobs, nonterminated job_status indicates a
             # healthy cluster. We can safely continue monitoring.
             # For multi-node jobs, since the job may not be set to FAILED
             # immediately (depending on user program) when only some of the
-            # nodes are preempted, need to check the actual cluster status.
+            # nodes are preempted or failed, need to check the actual cluster
+            # status.
             if (job_status is not None and not job_status.is_terminal() and
                     task.num_nodes == 1):
                 continue
 
             if job_status in [
                     job_lib.JobStatus.FAILED, job_lib.JobStatus.FAILED_SETUP
             ]:
                 # Add a grace period before the check of preemption to avoid
                 # false alarm for job failure.
                 time.sleep(5)
+
             # Pull the actual cluster status from the cloud provider to
-            # determine whether the cluster is preempted.
+            # determine whether the cluster is preempted or failed.
+            # TODO(zhwu): For hardware failure, such as GPU failure, it may not
+            # be reflected in the cluster status, depending on the cloud, which
+            # can also cause failure of the job, and we need to recover it
+            # rather than fail immediately.
             (cluster_status,
              handle) = backend_utils.refresh_cluster_status_handle(
                  cluster_name,
                  force_refresh_statuses=set(status_lib.ClusterStatus))
 
             if cluster_status != status_lib.ClusterStatus.UP:
-                # The cluster is (partially) preempted. It can be down, INIT
-                # or STOPPED, based on the interruption behavior of the cloud.
-                # Spot recovery is needed (will be done later in the code).
+                # The cluster is (partially) preempted or failed. It can be
+                # down, INIT or STOPPED, based on the interruption behavior of
+                # the cloud. Spot recovery is needed (will be done later in the
+                # code).
                 cluster_status_str = ('' if cluster_status is None else
                                       f' (status: {cluster_status.value})')
                 logger.info(
-                    f'Cluster is preempted{cluster_status_str}. Recovering...')
+                    f'Cluster is preempted or failed{cluster_status_str}. '
+                    'Recovering...')
             else:
                 if job_status is not None and not job_status.is_terminal():
                     # The multi-node job is still running, continue monitoring.
                     continue
                 elif job_status in [
                         job_lib.JobStatus.FAILED, job_lib.JobStatus.FAILED_SETUP
                 ]:
                     # The user code has probably crashed, fail immediately.
-                    end_time = spot_utils.get_job_timestamp(self._backend,
-                                                            cluster_name,
-                                                            get_end_time=True)
+                    end_time = managed_job_utils.get_job_timestamp(
+                        self._backend, cluster_name, get_end_time=True)
                     logger.info(
                         'The user job failed. Please check the logs below.\n'
                         f'== Logs of the user job (ID: {self._job_id}) ==\n')
 
                     self._download_log_and_stream(handle)
-                    spot_status_to_set = spot_state.SpotStatus.FAILED
+                    managed_job_status = (
+                        managed_job_state.ManagedJobStatus.FAILED)
                     if job_status == job_lib.JobStatus.FAILED_SETUP:
-                        spot_status_to_set = spot_state.SpotStatus.FAILED_SETUP
+                        managed_job_status = (
+                            managed_job_state.ManagedJobStatus.FAILED_SETUP)
                     failure_reason = (
                         'To see the details, run: '
-                        f'sky spot logs --controller {self._job_id}')
+                        f'sky jobs logs --controller {self._job_id}')
 
-                    spot_state.set_failed(self._job_id,
-                                          task_id,
-                                          failure_type=spot_status_to_set,
-                                          failure_reason=failure_reason,
-                                          end_time=end_time,
-                                          callback_func=callback_func)
+                    managed_job_state.set_failed(
+                        self._job_id,
+                        task_id,
+                        failure_type=managed_job_status,
+                        failure_reason=failure_reason,
+                        end_time=end_time,
+                        callback_func=callback_func)
                     return False
                 # Although the cluster is healthy, we fail to access the
                 # job status. Try to recover the job (will not restart the
                 # cluster, if the cluster is healthy).
                 assert job_status is None, job_status
                 logger.info('Failed to fetch the job status while the '
                             'cluster is healthy. Try to recover the job '
                             '(the cluster will not be restarted).')
 
             # When the handle is None, the cluster should be cleaned up already.
             if handle is not None:
                 resources = handle.launched_resources
                 assert resources is not None, handle
-                if resources.need_cleanup_after_preemption():
+                if resources.need_cleanup_after_preemption_or_failure():
                     # Some spot resource (e.g., Spot TPU VM) may need to be
-                    # cleaned up after preemption.
-                    logger.info('Cleaning up the preempted spot cluster...')
+                    # cleaned up after preemption, as running launch again on
+                    # those clusters again may fail.
+                    logger.info('Cleaning up the preempted or failed cluster'
+                                '...')
                     recovery_strategy.terminate_cluster(cluster_name)
 
-            # Try to recover the spot jobs, when the cluster is preempted
-            # or the job status is failed to be fetched.
-            spot_state.set_recovering(job_id=self._job_id,
-                                      task_id=task_id,
-                                      callback_func=callback_func)
+            # Try to recover the managed jobs, when the cluster is preempted or
+            # failed or the job status is failed to be fetched.
+            managed_job_state.set_recovering(job_id=self._job_id,
+                                             task_id=task_id,
+                                             callback_func=callback_func)
             recovered_time = self._strategy_executor.recover()
-            spot_state.set_recovered(self._job_id,
-                                     task_id,
-                                     recovered_time=recovered_time,
-                                     callback_func=callback_func)
+            managed_job_state.set_recovered(self._job_id,
+                                            task_id,
+                                            recovered_time=recovered_time,
+                                            callback_func=callback_func)
 
     def run(self):
         """Run controller logic and handle exceptions."""
         task_id = 0
         try:
             succeeded = True
             # We support chain DAGs only for now.
@@ -313,122 +335,124 @@
         except exceptions.ProvisionPrechecksError as e:
             # Please refer to the docstring of self._run for the cases when
             # this exception can occur.
             failure_reason = ('; '.join(
                 common_utils.format_exception(reason, use_bracket=True)
                 for reason in e.reasons))
             logger.error(failure_reason)
-            spot_state.set_failed(
+            managed_job_state.set_failed(
                 self._job_id,
                 task_id=task_id,
-                failure_type=spot_state.SpotStatus.FAILED_PRECHECKS,
+                failure_type=managed_job_state.ManagedJobStatus.
+                FAILED_PRECHECKS,
                 failure_reason=failure_reason,
-                callback_func=spot_utils.event_callback_func(
+                callback_func=managed_job_utils.event_callback_func(
                     job_id=self._job_id,
                     task_id=task_id,
                     task=self._dag.tasks[task_id]))
-        except exceptions.SpotJobReachedMaxRetriesError as e:
+        except exceptions.ManagedJobReachedMaxRetriesError as e:
             # Please refer to the docstring of self._run for the cases when
             # this exception can occur.
             logger.error(common_utils.format_exception(e))
-            # The spot job should be marked as FAILED_NO_RESOURCE, as the
-            # spot job may be able to launch next time.
-            spot_state.set_failed(
+            # The managed job should be marked as FAILED_NO_RESOURCE, as the
+            # managed job may be able to launch next time.
+            managed_job_state.set_failed(
                 self._job_id,
                 task_id=task_id,
-                failure_type=spot_state.SpotStatus.FAILED_NO_RESOURCE,
+                failure_type=managed_job_state.ManagedJobStatus.
+                FAILED_NO_RESOURCE,
                 failure_reason=common_utils.format_exception(e),
-                callback_func=spot_utils.event_callback_func(
+                callback_func=managed_job_utils.event_callback_func(
                     job_id=self._job_id,
                     task_id=task_id,
                     task=self._dag.tasks[task_id]))
         except (Exception, SystemExit) as e:  # pylint: disable=broad-except
             with ux_utils.enable_traceback():
                 logger.error(traceback.format_exc())
             msg = ('Unexpected error occurred: '
                    f'{common_utils.format_exception(e, use_bracket=True)}')
             logger.error(msg)
-            spot_state.set_failed(
+            managed_job_state.set_failed(
                 self._job_id,
                 task_id=task_id,
-                failure_type=spot_state.SpotStatus.FAILED_CONTROLLER,
+                failure_type=managed_job_state.ManagedJobStatus.
+                FAILED_CONTROLLER,
                 failure_reason=msg,
-                callback_func=spot_utils.event_callback_func(
+                callback_func=managed_job_utils.event_callback_func(
                     job_id=self._job_id,
                     task_id=task_id,
                     task=self._dag.tasks[task_id]))
         finally:
             # This will set all unfinished tasks to CANCELLING, and will not
             # affect the jobs in terminal states.
             # We need to call set_cancelling before set_cancelled to make sure
             # the table entries are correctly set.
-            callback_func = spot_utils.event_callback_func(
+            callback_func = managed_job_utils.event_callback_func(
                 job_id=self._job_id,
                 task_id=task_id,
                 task=self._dag.tasks[task_id])
-            spot_state.set_cancelling(job_id=self._job_id,
-                                      callback_func=callback_func)
-            spot_state.set_cancelled(job_id=self._job_id,
-                                     callback_func=callback_func)
+            managed_job_state.set_cancelling(job_id=self._job_id,
+                                             callback_func=callback_func)
+            managed_job_state.set_cancelled(job_id=self._job_id,
+                                            callback_func=callback_func)
 
 
 def _run_controller(job_id: int, dag_yaml: str, retry_until_up: bool):
     """Runs the controller in a remote process for interruption."""
     # The controller needs to be instantiated in the remote process, since
     # the controller is not serializable.
-    spot_controller = SpotController(job_id, dag_yaml, retry_until_up)
-    spot_controller.run()
+    jobs_controller = JobsController(job_id, dag_yaml, retry_until_up)
+    jobs_controller.run()
 
 
 def _handle_signal(job_id):
     """Handle the signal if the user sent it."""
-    signal_file = pathlib.Path(spot_utils.SIGNAL_FILE_PREFIX.format(job_id))
+    signal_file = pathlib.Path(
+        managed_job_utils.SIGNAL_FILE_PREFIX.format(job_id))
     user_signal = None
     if signal_file.exists():
         # Filelock is needed to prevent race condition with concurrent
         # signal writing.
-        # TODO(mraheja): remove pylint disabling when filelock version
-        # updated
-        # pylint: disable=abstract-class-instantiated
         with filelock.FileLock(str(signal_file) + '.lock'):
             with signal_file.open(mode='r', encoding='utf-8') as f:
                 user_signal = f.read().strip()
                 try:
-                    user_signal = spot_utils.UserSignal(user_signal)
+                    user_signal = managed_job_utils.UserSignal(user_signal)
                 except ValueError:
                     logger.warning(
                         f'Unknown signal received: {user_signal}. Ignoring.')
                     user_signal = None
             # Remove the signal file, after reading the signal.
             signal_file.unlink()
     if user_signal is None:
         # None or empty string.
         return
-    assert user_signal == spot_utils.UserSignal.CANCEL, (
+    assert user_signal == managed_job_utils.UserSignal.CANCEL, (
         f'Only cancel signal is supported, but {user_signal} got.')
-    raise exceptions.SpotUserCancelledError(
+    raise exceptions.ManagedJobUserCancelledError(
         f'User sent {user_signal.value} signal.')
 
 
 def _cleanup(job_id: int, dag_yaml: str):
-    """Clean up the spot cluster(s) and storages.
+    """Clean up the cluster(s) and storages.
 
     (1) Clean up the succeeded task(s)' ephemeral storage. The storage has
         to be cleaned up after the whole job is finished, as the tasks
         may share the same storage.
-    (2) Clean up the spot cluster(s) that are not cleaned up yet, which
-        can happen when the spot task failed or cancelled. At most one
-        spot cluster should be left when reaching here, as we currently
-        only support chain DAGs, and only spot task is executed at a time.
+    (2) Clean up the cluster(s) that are not cleaned up yet, which can happen
+        when the task failed or cancelled. At most one cluster should be left
+        when reaching here, as we currently only support chain DAGs, and only
+        task is executed at a time.
     """
     # NOTE: The code to get cluster name is same as what we did in the spot
-    # controller, we should keep it in sync with SpotController.__init__()
+    # controller, we should keep it in sync with JobsController.__init__()
     dag, _ = _get_dag_and_name(dag_yaml)
     for task in dag.tasks:
-        cluster_name = spot_utils.generate_spot_cluster_name(task.name, job_id)
+        cluster_name = managed_job_utils.generate_managed_job_cluster_name(
+            task.name, job_id)
         recovery_strategy.terminate_cluster(cluster_name)
         # Clean up Storages with persistent=False.
         # TODO(zhwu): this assumes the specific backend.
         backend = cloud_vm_ray_backend.CloudVmRayBackend()
         backend.teardown_ephemeral_storage(task)
 
 
@@ -447,80 +471,80 @@
         controller_process = multiprocessing.Process(target=_run_controller,
                                                      args=(job_id, dag_yaml,
                                                            retry_until_up))
         controller_process.start()
         while controller_process.is_alive():
             _handle_signal(job_id)
             time.sleep(1)
-    except exceptions.SpotUserCancelledError:
+    except exceptions.ManagedJobUserCancelledError:
         dag, _ = _get_dag_and_name(dag_yaml)
-        task_id, _ = (spot_state.get_latest_task_id_status(job_id))
+        task_id, _ = managed_job_state.get_latest_task_id_status(job_id)
         logger.info(
-            f'Cancelling spot job, job_id: {job_id}, task_id: {task_id}')
-        spot_state.set_cancelling(job_id=job_id,
-                                  callback_func=spot_utils.event_callback_func(
-                                      job_id=job_id,
-                                      task_id=task_id,
-                                      task=dag.tasks[task_id]))
+            f'Cancelling managed job, job_id: {job_id}, task_id: {task_id}')
+        managed_job_state.set_cancelling(
+            job_id=job_id,
+            callback_func=managed_job_utils.event_callback_func(
+                job_id=job_id, task_id=task_id, task=dag.tasks[task_id]))
         cancelling = True
     finally:
         if controller_process is not None:
             logger.info(f'Killing controller process {controller_process.pid}.')
             # NOTE: it is ok to kill or join a killed process.
             # Kill the controller process first; if its child process is
             # killed first, then the controller process will raise errors.
             # Kill any possible remaining children processes recursively.
             subprocess_utils.kill_children_processes(controller_process.pid,
                                                      force=True)
             controller_process.join()
             logger.info(f'Controller process {controller_process.pid} killed.')
 
-        logger.info(f'Cleaning up any spot cluster for job {job_id}.')
+        logger.info(f'Cleaning up any cluster for job {job_id}.')
         # NOTE: Originally, we send an interruption signal to the controller
         # process and the controller process handles cleanup. However, we
         # figure out the behavior differs from cloud to cloud
         # (e.g., GCP ignores 'SIGINT'). A possible explanation is
         # https://unix.stackexchange.com/questions/356408/strange-problem-with-trap-and-sigint
         # But anyway, a clean solution is killing the controller process
-        # directly, and then cleanup the cluster state.
+        # directly, and then cleanup the cluster job_state.
         _cleanup(job_id, dag_yaml=dag_yaml)
-        logger.info(f'Spot cluster of job {job_id} has been cleaned up.')
+        logger.info(f'Cluster of managed job {job_id} has been cleaned up.')
 
         if cancelling:
-            spot_state.set_cancelled(
+            managed_job_state.set_cancelled(
                 job_id=job_id,
-                callback_func=spot_utils.event_callback_func(
+                callback_func=managed_job_utils.event_callback_func(
                     job_id=job_id, task_id=task_id, task=dag.tasks[task_id]))
 
         # We should check job status after 'set_cancelled', otherwise
         # the job status is not terminal.
-        job_status = spot_state.get_status(job_id)
+        job_status = managed_job_state.get_status(job_id)
         assert job_status is not None
         # The job can be non-terminal if the controller exited abnormally,
         # e.g. failed to launch cluster after reaching the MAX_RETRY.
         if not job_status.is_terminal():
-            logger.info(f'Previous spot job status: {job_status.value}')
-            spot_state.set_failed(
+            logger.info(f'Previous job status: {job_status.value}')
+            managed_job_state.set_failed(
                 job_id,
                 task_id=None,
-                failure_type=spot_state.SpotStatus.FAILED_CONTROLLER,
+                failure_type=managed_job_state.ManagedJobStatus.
+                FAILED_CONTROLLER,
                 failure_reason=('Unexpected error occurred. For details, '
-                                f'run: sky spot logs --controller {job_id}'))
+                                f'run: sky jobs logs --controller {job_id}'))
 
 
 if __name__ == '__main__':
     parser = argparse.ArgumentParser()
     parser.add_argument('--job-id',
                         required=True,
                         type=int,
                         help='Job id for the controller job.')
     parser.add_argument('--retry-until-up',
                         action='store_true',
-                        help='Retry until the spot cluster is up.')
+                        help='Retry until the cluster is up.')
     parser.add_argument('dag_yaml',
                         type=str,
-                        help='The path to the user spot task yaml file.')
+                        help='The path to the user job yaml file.')
     args = parser.parse_args()
     # We start process with 'spawn', because 'fork' could result in weird
     # behaviors; 'spawn' is also cross-platform.
     multiprocessing.set_start_method('spawn', force=True)
     start(args.job_id, args.dag_yaml, args.retry_until_up)
```

### Comparing `skypilot-0.5.0/sky/spot/dashboard/dashboard.py` & `skypilot-0.6.0/sky/jobs/dashboard/dashboard.py`

 * *Files 24% similar despite different names*

```diff
@@ -1,62 +1,76 @@
-"""Dashboard for spot jobs based on Flask.
+"""Dashboard for managed jobs based on Flask.
 
 TODO(zongheng): This is a basic version. In the future we can beef up the web
 frameworks used (e.g.,
 https://github.com/ray-project/ray/tree/master/dashboard/client/src) and/or get
-rid of the SSH port-forwarding business (see cli.py's spot_dashboard()
+rid of the SSH port-forwarding business (see cli.py's job_dashboard()
 comment).
 """
 import datetime
 import pathlib
 
 import flask
 import yaml
 
-import sky
-from sky import spot
+from sky import jobs as managed_jobs
 from sky.utils import common_utils
+from sky.utils import controller_utils
 
 app = flask.Flask(__name__)
 
 
-def _is_running_on_spot_controller() -> bool:
-    """Am I running on spot controller?
+def _is_running_on_jobs_controller() -> bool:
+    """Am I running on jobs controller?
 
     Loads ~/.sky/sky_ray.yml and check cluster_name.
     """
     if pathlib.Path('~/.sky/sky_ray.yml').expanduser().exists():
         config = yaml.safe_load(
             pathlib.Path('~/.sky/sky_ray.yml').expanduser().read_text())
-        return config.get('cluster_name', '').startswith('sky-spot-controller-')
+        cluster_name = config.get('cluster_name', '')
+        candidate_controller_names = (
+            controller_utils.Controllers.JOBS_CONTROLLER.value.
+            candidate_cluster_names)
+        # We use startswith instead of exact match because the cluster name in
+        # the yaml file is cluster_name_on_cloud which may have additional
+        # suffices.
+        return any(
+            cluster_name.startswith(name)
+            for name in candidate_controller_names)
     return False
 
 
 @app.route('/')
 def home():
-    if not _is_running_on_spot_controller():
+    if not _is_running_on_jobs_controller():
         # Experimental: run on laptop (refresh is very slow).
-        all_spot_jobs = sky.spot_queue(refresh=True, skip_finished=False)
+        all_managed_jobs = managed_jobs.queue(refresh=True, skip_finished=False)
     else:
-        job_table = spot.dump_spot_job_queue()
-        all_spot_jobs = spot.load_spot_job_queue(job_table)
+        job_table = managed_jobs.dump_managed_job_queue()
+        all_managed_jobs = managed_jobs.load_managed_job_queue(job_table)
 
-    timestamp = datetime.datetime.utcnow()
-    rows = spot.format_job_table(all_spot_jobs, show_all=True, return_rows=True)
+    timestamp = datetime.datetime.now(datetime.timezone.utc)
+    rows = managed_jobs.format_job_table(all_managed_jobs,
+                                         show_all=True,
+                                         return_rows=True)
+    # Add an empty column for the dropdown button. This will be added in the
+    # jobs/templates/index.html file.
+    rows = [[''] + row for row in rows]
 
     # FIXME(zongheng): make the job table/queue funcs return structured info so
     # that we don't have to do things like row[-5] below.
     columns = [
-        'ID', 'Task', 'Name', 'Resources', 'Submitted', 'Total Duration',
+        '', 'ID', 'Task', 'Name', 'Resources', 'Submitted', 'Total Duration',
         'Job Duration', 'Recoveries', 'Status', 'Started', 'Cluster', 'Region',
         'Failure'
     ]
     if rows and len(rows[0]) != len(columns):
         raise RuntimeError(
-            'Dashboard code and spot queue code are out of sync.')
+            'Dashboard code and managed job queue code are out of sync.')
 
     # Fix STATUS color codes: '\x1b[33mCANCELLED\x1b[0m' -> 'CANCELLED'.
     for row in rows:
         row[-5] = common_utils.remove_color(row[-5])
     # Remove filler rows ([''], ..., ['-']).
     rows = [row for row in rows if ''.join(map(str, row)) != '']
```

### Comparing `skypilot-0.5.0/sky/spot/dashboard/static/favicon.ico` & `skypilot-0.6.0/sky/jobs/dashboard/static/favicon.ico`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/spot/recovery_strategy.py` & `skypilot-0.6.0/sky/jobs/recovery_strategy.py`

 * *Files 3% similar despite different names*

```diff
@@ -1,70 +1,70 @@
-"""The strategy to handle launching/recovery/termination of spot clusters.
+"""Strategies to handle launching/recovery/termination of managed job clusters.
 
-In the YAML file, the user can specify the strategy to use for spot jobs.
+In the YAML file, the user can specify the strategy to use for managed jobs.
 
 resources:
-    spot_recovery: EAGER_NEXT_REGION
+    job_recovery: EAGER_NEXT_REGION
 """
 import time
 import traceback
 import typing
 from typing import Optional
 
 import sky
 from sky import backends
 from sky import exceptions
 from sky import global_user_state
 from sky import sky_logging
 from sky import status_lib
 from sky.backends import backend_utils
+from sky.jobs import utils as managed_job_utils
 from sky.skylet import job_lib
-from sky.spot import spot_utils
 from sky.usage import usage_lib
 from sky.utils import common_utils
 from sky.utils import ux_utils
 
 if typing.TYPE_CHECKING:
     from sky import task as task_lib
 
 logger = sky_logging.init_logger(__name__)
 
-SPOT_STRATEGIES = {}
-SPOT_DEFAULT_STRATEGY = None
+RECOVERY_STRATEGIES = {}
+DEFAULT_RECOVERY_STRATEGY = None
 
 # Waiting time for job from INIT/PENDING to RUNNING
 # 10 * JOB_STARTED_STATUS_CHECK_GAP_SECONDS = 10 * 5 = 50 seconds
 MAX_JOB_CHECKING_RETRY = 10
 
 
 def terminate_cluster(cluster_name: str, max_retry: int = 3) -> None:
-    """Terminate the spot cluster."""
+    """Terminate the cluster."""
     retry_cnt = 0
     while True:
         try:
             usage_lib.messages.usage.set_internal()
             sky.down(cluster_name)
             return
         except ValueError:
             # The cluster is already down.
             return
         except Exception as e:  # pylint: disable=broad-except
             retry_cnt += 1
             if retry_cnt >= max_retry:
-                raise RuntimeError('Failed to terminate the spot cluster '
-                                   f'{cluster_name}.') from e
-            logger.error('Failed to terminate the spot cluster '
-                         f'{cluster_name}. Retrying.'
-                         f'Details: {common_utils.format_exception(e)}')
+                raise RuntimeError(
+                    f'Failed to terminate the cluster {cluster_name}.') from e
+            logger.error(
+                f'Failed to terminate the cluster {cluster_name}. Retrying.'
+                f'Details: {common_utils.format_exception(e)}')
             with ux_utils.enable_traceback():
                 logger.error(f'  Traceback: {traceback.format_exc()}')
 
 
 class StrategyExecutor:
-    """Handle each launching, recovery and termination of the spot clusters."""
+    """Handle the launching, recovery and termination of managed job clusters"""
 
     RETRY_INIT_GAP_SECONDS = 60
 
     def __init__(self, cluster_name: str, backend: 'backends.Backend',
                  task: 'task_lib.Task', retry_until_up: bool) -> None:
         """Initialize the strategy executor.
 
@@ -79,44 +79,44 @@
         self.dag = sky.Dag()
         self.dag.add(task)
         self.cluster_name = cluster_name
         self.backend = backend
         self.retry_until_up = retry_until_up
 
     def __init_subclass__(cls, name: str, default: bool = False):
-        SPOT_STRATEGIES[name] = cls
+        RECOVERY_STRATEGIES[name] = cls
         if default:
-            global SPOT_DEFAULT_STRATEGY
-            assert SPOT_DEFAULT_STRATEGY is None, (
+            global DEFAULT_RECOVERY_STRATEGY
+            assert DEFAULT_RECOVERY_STRATEGY is None, (
                 'Only one strategy can be default.')
-            SPOT_DEFAULT_STRATEGY = name
+            DEFAULT_RECOVERY_STRATEGY = name
 
     @classmethod
     def make(cls, cluster_name: str, backend: 'backends.Backend',
              task: 'task_lib.Task', retry_until_up: bool) -> 'StrategyExecutor':
         """Create a strategy from a task."""
 
         resource_list = list(task.resources)
-        spot_recovery = resource_list[0].spot_recovery
+        job_recovery = resource_list[0].job_recovery
         for resource in resource_list:
-            if resource.spot_recovery != spot_recovery:
+            if resource.job_recovery != job_recovery:
                 raise ValueError(
-                    'The spot recovery strategy should be the same for all '
+                    'The job recovery strategy should be the same for all '
                     'resources.')
-        # Remove the spot_recovery field from the resources, as the strategy
+        # Remove the job_recovery field from the resources, as the strategy
         # will be handled by the strategy class.
-        new_resources_list = [r.copy(spot_recovery=None) for r in resource_list]
+        new_resources_list = [r.copy(job_recovery=None) for r in resource_list]
         # set the new_task_resources to be the same type (list or set) as the
         # original task.resources
         task.set_resources(type(task.resources)(new_resources_list))
-        return SPOT_STRATEGIES[spot_recovery](cluster_name, backend, task,
-                                              retry_until_up)
+        return RECOVERY_STRATEGIES[job_recovery](cluster_name, backend, task,
+                                                 retry_until_up)
 
     def launch(self) -> float:
-        """Launch the spot cluster for the first time.
+        """Launch the cluster for the first time.
 
         It can fail if resource is not available. Need to check the cluster
         status, after calling.
 
         Returns: The job's submit timestamp, on success (otherwise, an
             exception is raised).
 
@@ -127,15 +127,15 @@
             job_submit_at = self._launch(max_retry=None)
         else:
             job_submit_at = self._launch()
         assert job_submit_at is not None
         return job_submit_at
 
     def recover(self) -> float:
-        """Relaunch the spot cluster after failure and wait until job starts.
+        """Relaunch the cluster after failure and wait until job starts.
 
         When recover() is called the cluster should be in STOPPED status (i.e.
         partially down).
 
         Returns: The timestamp job started.
         """
         raise NotImplementedError
@@ -210,41 +210,41 @@
                 logger.info('The cluster is preempted before the job '
                             'is submitted.')
                 # TODO(zhwu): we should recover the preemption with the
                 # recovery strategy instead of the current while loop.
                 break
 
             try:
-                status = spot_utils.get_job_status(self.backend,
-                                                   self.cluster_name)
+                status = managed_job_utils.get_job_status(
+                    self.backend, self.cluster_name)
             except Exception as e:  # pylint: disable=broad-except
                 # If any unexpected error happens, retry the job checking
                 # loop.
                 # Note: the CommandError is already handled in the
                 # get_job_status, so it should not happen here.
                 # TODO(zhwu): log the unexpected error to usage collection
                 # for future debugging.
                 logger.info(f'Unexpected exception: {e}\nFailed to get the '
                             'job status. Retrying.')
                 continue
 
             # Check the job status until it is not in initialized status
             if status is not None and status > job_lib.JobStatus.INIT:
                 try:
-                    job_submitted_at = spot_utils.get_job_timestamp(
+                    job_submitted_at = managed_job_utils.get_job_timestamp(
                         self.backend, self.cluster_name, get_end_time=False)
                     return job_submitted_at
                 except Exception as e:  # pylint: disable=broad-except
                     # If we failed to get the job timestamp, we will retry
                     # job checking loop.
                     logger.info(f'Unexpected Exception: {e}\nFailed to get '
                                 'the job start timestamp. Retrying.')
                     continue
             # Wait for the job to be started
-            time.sleep(spot_utils.JOB_STARTED_STATUS_CHECK_GAP_SECONDS)
+            time.sleep(managed_job_utils.JOB_STARTED_STATUS_CHECK_GAP_SECONDS)
         return None
 
     def _launch(self,
                 max_retry: Optional[int] = 3,
                 raise_on_failure: bool = True) -> Optional[float]:
         """Implementation of launch().
 
@@ -289,16 +289,16 @@
                 usage_lib.messages.usage.set_internal()
                 # Detach setup, so that the setup failure can be detected
                 # by the controller process (job_status -> FAILED_SETUP).
                 sky.launch(self.dag,
                            cluster_name=self.cluster_name,
                            detach_setup=True,
                            detach_run=True,
-                           _is_launched_by_spot_controller=True)
-                logger.info('Spot cluster launched.')
+                           _is_launched_by_jobs_controller=True)
+                logger.info('Managed job cluster launched.')
             except (exceptions.InvalidClusterNameError,
                     exceptions.NoCloudAccessError,
                     exceptions.ResourcesMismatchError) as e:
                 logger.error('Failure happened before provisioning. '
                              f'{common_utils.format_exception(e)}')
                 if raise_on_failure:
                     raise exceptions.ProvisionPrechecksError(reasons=[e])
@@ -326,49 +326,49 @@
                     logger.error(
                         'Failure happened before provisioning. Failover '
                         f'reasons: {reasons_str}')
                     if raise_on_failure:
                         raise exceptions.ProvisionPrechecksError(
                             reasons=reasons)
                     return None
-                logger.info('Failed to launch the spot cluster with error: '
+                logger.info('Failed to launch a cluster with error: '
                             f'{common_utils.format_exception(e)})')
             except Exception as e:  # pylint: disable=broad-except
                 # If the launch fails, it will be recovered by the following
                 # code.
-                logger.info('Failed to launch the spot cluster with error: '
+                logger.info('Failed to launch a cluster with error: '
                             f'{common_utils.format_exception(e)})')
                 with ux_utils.enable_traceback():
                     logger.info(f'  Traceback: {traceback.format_exc()}')
             else:  # No exception, the launch succeeds.
                 # At this point, a sky.launch() has succeeded. Cluster may be
                 # UP (no preemption since) or DOWN (newly preempted).
                 job_submitted_at = self._wait_until_job_starts_on_cluster()
                 if job_submitted_at is not None:
                     return job_submitted_at
-                # The job fails to start on the spot cluster, retry the launch.
+                # The job fails to start on the cluster, retry the launch.
                 # TODO(zhwu): log the unexpected error to usage collection
                 # for future debugging.
                 logger.info(
                     'Failed to successfully submit the job to the '
                     'launched cluster, due to unexpected submission errors or '
                     'the cluster being preempted during job submission.')
 
             terminate_cluster(self.cluster_name)
             if max_retry is not None and retry_cnt >= max_retry:
                 # Retry forever if max_retry is None.
                 if raise_on_failure:
                     with ux_utils.print_exception_no_traceback():
-                        raise exceptions.SpotJobReachedMaxRetriesError(
-                            'Resources unavailable: failed to launch the spot '
-                            f'cluster after {max_retry} retries.')
+                        raise exceptions.ManagedJobReachedMaxRetriesError(
+                            'Resources unavailable: failed to launch clusters '
+                            f'after {max_retry} retries.')
                 else:
                     return None
             gap_seconds = backoff.current_backoff()
-            logger.info('Retrying to launch the spot cluster in '
+            logger.info('Retrying to launch the cluster in '
                         f'{gap_seconds:.1f} seconds.')
             time.sleep(gap_seconds)
 
 
 class FailoverStrategyExecutor(StrategyExecutor, name='FAILOVER',
                                default=False):
     """Failover strategy: wait in same region and failover after timeout."""
@@ -425,35 +425,35 @@
                 job_submitted_at = self._launch(raise_on_failure=False)
                 # Restore the original dag, i.e. reset the region constraint.
                 task.set_resources(original_resources)
                 if job_submitted_at is not None:
                     return job_submitted_at
 
             # Step 2
-            logger.debug('Terminating unhealthy spot cluster and '
-                         'reset cloud region.')
+            logger.debug('Terminating unhealthy cluster and reset cloud '
+                         'region.')
             terminate_cluster(self.cluster_name)
 
             # Step 3
             logger.debug('Relaunch the cluster  without constraining to prior '
                          'cloud/region.')
             # Not using self.launch to avoid the retry until up logic.
             job_submitted_at = self._launch(max_retry=self._MAX_RETRY_CNT,
                                             raise_on_failure=False)
             if job_submitted_at is None:
                 # Failed to launch the cluster.
                 if self.retry_until_up:
                     gap_seconds = self.RETRY_INIT_GAP_SECONDS
-                    logger.info('Retrying to recover the spot cluster in '
+                    logger.info('Retrying to recover the cluster in '
                                 f'{gap_seconds:.1f} seconds.')
                     time.sleep(gap_seconds)
                     continue
                 with ux_utils.print_exception_no_traceback():
                     raise exceptions.ResourcesUnavailableError(
-                        f'Failed to recover the spot cluster after retrying '
+                        f'Failed to recover the cluster after retrying '
                         f'{self._MAX_RETRY_CNT} times.')
 
             return job_submitted_at
 
 
 class EagerFailoverStrategyExecutor(FailoverStrategyExecutor,
                                     name='EAGER_NEXT_REGION',
@@ -489,16 +489,15 @@
         # 3. (If step 2 failed) Retry forever: Launch again with no blocked
         # locations (this will failover through the entire search space)
         #
         # The entire search space is defined by the original task request,
         # task.resources.
 
         # Step 1
-        logger.debug('Terminating unhealthy spot cluster and '
-                     'reset cloud region.')
+        logger.debug('Terminating unhealthy cluster and reset cloud region.')
         terminate_cluster(self.cluster_name)
 
         # Step 2
         logger.debug('Relaunch the cluster skipping the previously launched '
                      'cloud/region.')
         if self._launched_resources is not None:
             task = self.dag.tasks[0]
@@ -528,17 +527,17 @@
             # Not using self.launch to avoid the retry until up logic.
             job_submitted_at = self._launch(max_retry=self._MAX_RETRY_CNT,
                                             raise_on_failure=False)
             if job_submitted_at is None:
                 # Failed to launch the cluster.
                 if self.retry_until_up:
                     gap_seconds = self.RETRY_INIT_GAP_SECONDS
-                    logger.info('Retrying to recover the spot cluster in '
+                    logger.info('Retrying to recover the cluster in '
                                 f'{gap_seconds:.1f} seconds.')
                     time.sleep(gap_seconds)
                     continue
                 with ux_utils.print_exception_no_traceback():
                     raise exceptions.ResourcesUnavailableError(
-                        f'Failed to recover the spot cluster after retrying '
+                        f'Failed to recover the cluster after retrying '
                         f'{self._MAX_RETRY_CNT} times.')
 
             return job_submitted_at
```

### Comparing `skypilot-0.5.0/sky/spot/spot_state.py` & `skypilot-0.6.0/sky/jobs/state.py`

 * *Files 8% similar despite different names*

```diff
@@ -1,8 +1,8 @@
-"""The database for spot jobs status."""
+"""The database for managed jobs status."""
 # TODO(zhwu): maybe use file based status instead of database, so
 # that we can easily switch to a s3-based storage.
 import enum
 import pathlib
 import sqlite3
 import time
 import typing
@@ -26,17 +26,19 @@
 _DB_PATH = str(_DB_PATH)
 
 # Module-level connection/cursor; thread-safe as the module is only imported
 # once.
 _CONN = sqlite3.connect(_DB_PATH)
 _CURSOR = _CONN.cursor()
 
+# === Database schema ===
 # `spot` table contains all the finest-grained tasks, including all the
-# tasks of a spot job. All tasks of the same job will have the same
-# `spot_job_id`.
+# tasks of a managed job (called spot for legacy reason, as it is generalized
+# from the previous managed spot jobs). All tasks of the same job will have the
+# same `spot_job_id`.
 # The `job_name` column is now deprecated. It now holds the task's name, i.e.,
 # the same content as the `task_name` column.
 # The `job_id` is now not really a job id, but a only a unique
 # identifier/primary key for all the tasks. We will use `spot_job_id`
 # to identify the spot job.
 # TODO(zhwu): schema migration may be needed.
 _CURSOR.execute("""\
@@ -56,15 +58,15 @@
     spot_job_id INTEGER,
     task_id INTEGER DEFAULT 0,
     task_name TEXT)""")
 _CONN.commit()
 
 db_utils.add_column_to_table(_CURSOR, _CONN, 'spot', 'failure_reason', 'TEXT')
 # Create a new column `spot_job_id`, which is the same for tasks of the
-# same spot job.
+# same managed job.
 # The original `job_id` no longer has an actual meaning, but only a legacy
 # identifier for all tasks in database.
 db_utils.add_column_to_table(_CURSOR,
                              _CONN,
                              'spot',
                              'spot_job_id',
                              'INTEGER',
@@ -95,15 +97,15 @@
 # and recovery time.
 # If the job is not finished:
 # total_job_duration = now() - last_recovered_at + job_duration
 # If the job is not finished:
 # total_job_duration = end_at - last_recovered_at + job_duration
 #
 # Column names to be used in the jobs dict returned to the caller,
-# e.g., via sky spot queue. These may not correspond to actual
+# e.g., via sky jobs queue. These may not correspond to actual
 # column names in the DB and it corresponds to the combined view
 # by joining the spot and job_info tables.
 columns = [
     '_job_id',
     '_task_name',
     'resources',
     'submitted_at',
@@ -120,136 +122,136 @@
     'task_name',
     # columns from the job_info table
     '_job_info_job_id',  # This should be the same as job_id
     'job_name'
 ]
 
 
-class SpotStatus(enum.Enum):
-    """Spot job status, designed to be in serverless style.
+class ManagedJobStatus(enum.Enum):
+    """Managed job status, designed to be in serverless style.
 
-    The SpotStatus is a higher level status than the JobStatus.
-    Each spot job submitted to the spot cluster, will have a JobStatus
-    on that spot cluster:
+    The ManagedJobStatus is a higher level status than the JobStatus.
+    Each managed job submitted to a cluster will have a JobStatus
+    on that cluster:
         JobStatus = [INIT, SETTING_UP, PENDING, RUNNING, ...]
-    Whenever the spot cluster is preempted and recovered, the JobStatus
+    Whenever the cluster is preempted and recovered, the JobStatus
     will go through the statuses above again.
-    That means during the lifetime of a spot job, its JobsStatus could be
+    That means during the lifetime of a managed job, its JobsStatus could be
     reset to INIT or SETTING_UP multiple times (depending on the preemptions).
 
-    However, a spot job only has one SpotStatus on the spot controller.
-        SpotStatus = [PENDING, SUBMITTED, STARTING, RUNNING, ...]
-    Mapping from JobStatus to SpotStatus:
+    However, a managed job only has one ManagedJobStatus on the jobs controller.
+        ManagedJobStatus = [PENDING, SUBMITTED, STARTING, RUNNING, ...]
+    Mapping from JobStatus to ManagedJobStatus:
         INIT            ->  STARTING/RECOVERING
         SETTING_UP      ->  RUNNING
         PENDING         ->  RUNNING
         RUNNING         ->  RUNNING
         SUCCEEDED       ->  SUCCEEDED
         FAILED          ->  FAILED
         FAILED_SETUP    ->  FAILED_SETUP
-    Note that the JobStatus will not be stuck in PENDING, because each spot
-    cluster is dedicated to a spot job, i.e. there should always be enough
-    resource to run the job and the job will be immediately transitioned to
-    RUNNING.
+    Note that the JobStatus will not be stuck in PENDING, because each cluster
+    is dedicated to a managed job, i.e. there should always be enough resource
+    to run the job and the job will be immediately transitioned to RUNNING.
     """
-    # PENDING: Waiting for the spot controller to have a slot to run the
+    # PENDING: Waiting for the jobs controller to have a slot to run the
     # controller process.
-    # The submitted_at timestamp of the spot job in the 'spot' table will be
+    # The submitted_at timestamp of the managed job in the 'spot' table will be
     # set to the time when the job is firstly submitted by the user (set to
     # PENDING).
     PENDING = 'PENDING'
-    # SUBMITTED: The spot controller starts the controller process.
+    # SUBMITTED: The jobs controller starts the controller process.
     SUBMITTED = 'SUBMITTED'
-    # STARTING: The controller process is launching the spot cluster for
-    # the spot job.
+    # STARTING: The controller process is launching the cluster for the managed
+    # job.
     STARTING = 'STARTING'
-    # RUNNING: The job is submitted to the spot cluster, and is setting up
-    # or running.
-    # The start_at timestamp of the spot job in the 'spot' table will be set
+    # RUNNING: The job is submitted to the cluster, and is setting up or
+    # running.
+    # The start_at timestamp of the managed job in the 'spot' table will be set
     # to the time when the job is firstly transitioned to RUNNING.
     RUNNING = 'RUNNING'
-    # RECOVERING: The spot cluster is preempted, and the controller process
-    # is recovering the spot cluster (relaunching/failover).
+    # RECOVERING: The cluster is preempted, and the controller process is
+    # recovering the cluster (relaunching/failover).
     RECOVERING = 'RECOVERING'
     # Terminal statuses
     # SUCCEEDED: The job is finished successfully.
     SUCCEEDED = 'SUCCEEDED'
     # CANCELLING: The job is requested to be cancelled by the user, and the
-    # controller is cleaning up the spot cluster.
+    # controller is cleaning up the cluster.
     CANCELLING = 'CANCELLING'
-    # CANCELLED: The job is cancelled by the user. When the spot job is in
-    # CANCELLED status, the spot cluster has been cleaned up.
+    # CANCELLED: The job is cancelled by the user. When the managed job is in
+    # CANCELLED status, the cluster has been cleaned up.
     CANCELLED = 'CANCELLED'
     # FAILED: The job is finished with failure from the user's program.
     FAILED = 'FAILED'
     # FAILED_SETUP: The job is finished with failure from the user's setup
     # script.
     FAILED_SETUP = 'FAILED_SETUP'
     # FAILED_PRECHECKS: the underlying `sky.launch` fails due to precheck
     # errors only. I.e., none of the failover exceptions, if any, is due to
     # resources unavailability. This exception includes the following cases:
     # 1. The optimizer cannot find a feasible solution.
     # 2. Precheck errors: invalid cluster name, failure in getting cloud user
     #    identity, or unsupported feature.
     FAILED_PRECHECKS = 'FAILED_PRECHECKS'
     # FAILED_NO_RESOURCE: The job is finished with failure because there is no
-    # resource available in the cloud provider(s) to launch the spot cluster.
+    # resource available in the cloud provider(s) to launch the cluster.
     FAILED_NO_RESOURCE = 'FAILED_NO_RESOURCE'
     # FAILED_CONTROLLER: The job is finished with failure because of unexpected
     # error in the controller process.
     FAILED_CONTROLLER = 'FAILED_CONTROLLER'
 
     def is_terminal(self) -> bool:
         return self in self.terminal_statuses()
 
     def is_failed(self) -> bool:
         return self in self.failure_statuses()
 
-    def colored_str(self):
+    def colored_str(self) -> str:
         color = _SPOT_STATUS_TO_COLOR[self]
         return f'{color}{self.value}{colorama.Style.RESET_ALL}'
 
-    def __lt__(self, other):
-        return list(SpotStatus).index(self) < list(SpotStatus).index(other)
+    def __lt__(self, other) -> bool:
+        status_list = list(ManagedJobStatus)
+        return status_list.index(self) < status_list.index(other)
 
     @classmethod
-    def terminal_statuses(cls) -> List['SpotStatus']:
+    def terminal_statuses(cls) -> List['ManagedJobStatus']:
         return [
             cls.SUCCEEDED,
             cls.FAILED,
             cls.FAILED_SETUP,
             cls.FAILED_PRECHECKS,
             cls.FAILED_NO_RESOURCE,
             cls.FAILED_CONTROLLER,
             cls.CANCELLING,
             cls.CANCELLED,
         ]
 
     @classmethod
-    def failure_statuses(cls) -> List['SpotStatus']:
+    def failure_statuses(cls) -> List['ManagedJobStatus']:
         return [
             cls.FAILED, cls.FAILED_SETUP, cls.FAILED_PRECHECKS,
             cls.FAILED_NO_RESOURCE, cls.FAILED_CONTROLLER
         ]
 
 
 _SPOT_STATUS_TO_COLOR = {
-    SpotStatus.PENDING: colorama.Fore.BLUE,
-    SpotStatus.SUBMITTED: colorama.Fore.BLUE,
-    SpotStatus.STARTING: colorama.Fore.BLUE,
-    SpotStatus.RUNNING: colorama.Fore.GREEN,
-    SpotStatus.RECOVERING: colorama.Fore.CYAN,
-    SpotStatus.SUCCEEDED: colorama.Fore.GREEN,
-    SpotStatus.FAILED: colorama.Fore.RED,
-    SpotStatus.FAILED_PRECHECKS: colorama.Fore.RED,
-    SpotStatus.FAILED_SETUP: colorama.Fore.RED,
-    SpotStatus.FAILED_NO_RESOURCE: colorama.Fore.RED,
-    SpotStatus.FAILED_CONTROLLER: colorama.Fore.RED,
-    SpotStatus.CANCELLING: colorama.Fore.YELLOW,
-    SpotStatus.CANCELLED: colorama.Fore.YELLOW,
+    ManagedJobStatus.PENDING: colorama.Fore.BLUE,
+    ManagedJobStatus.SUBMITTED: colorama.Fore.BLUE,
+    ManagedJobStatus.STARTING: colorama.Fore.BLUE,
+    ManagedJobStatus.RUNNING: colorama.Fore.GREEN,
+    ManagedJobStatus.RECOVERING: colorama.Fore.CYAN,
+    ManagedJobStatus.SUCCEEDED: colorama.Fore.GREEN,
+    ManagedJobStatus.FAILED: colorama.Fore.RED,
+    ManagedJobStatus.FAILED_PRECHECKS: colorama.Fore.RED,
+    ManagedJobStatus.FAILED_SETUP: colorama.Fore.RED,
+    ManagedJobStatus.FAILED_NO_RESOURCE: colorama.Fore.RED,
+    ManagedJobStatus.FAILED_CONTROLLER: colorama.Fore.RED,
+    ManagedJobStatus.CANCELLING: colorama.Fore.YELLOW,
+    ManagedJobStatus.CANCELLED: colorama.Fore.YELLOW,
 }
 
 
 # === Status transition functions ===
 def set_job_name(job_id: int, name: str):
     with db_utils.safe_cursor(_DB_PATH) as cursor:
         cursor.execute(
@@ -264,136 +266,143 @@
     with db_utils.safe_cursor(_DB_PATH) as cursor:
         cursor.execute(
             """\
             INSERT INTO spot
             (spot_job_id, task_id, task_name, resources, status)
             VALUES (?, ?, ?, ?, ?)""",
             (job_id, task_id, task_name, resources_str,
-             SpotStatus.PENDING.value))
+             ManagedJobStatus.PENDING.value))
 
 
 def set_submitted(job_id: int, task_id: int, run_timestamp: str,
                   submit_time: float, resources_str: str,
                   callback_func: CallbackType):
     """Set the task to submitted.
 
     Args:
-        job_id: The spot job ID.
+        job_id: The managed job ID.
         task_id: The task ID.
         run_timestamp: The run_timestamp of the run. This will be used to
-            determine the log directory of the spot task.
-        submit_time: The time when the spot task is submitted.
-        resources_str: The resources string of the spot task.
+            determine the log directory of the managed task.
+        submit_time: The time when the managed task is submitted.
+        resources_str: The resources string of the managed task.
     """
     # Use the timestamp in the `run_timestamp` ('sky-2022-10...'), to make
     # the log directory and submission time align with each other, so as to
     # make it easier to find them based on one of the values.
     # Also, using the earlier timestamp should be closer to the term
-    # `submit_at`, which represents the time the spot task is submitted.
+    # `submit_at`, which represents the time the managed task is submitted.
     with db_utils.safe_cursor(_DB_PATH) as cursor:
         cursor.execute(
             """\
             UPDATE spot SET
             resources=(?),
             submitted_at=(?),
             status=(?),
             run_timestamp=(?)
             WHERE spot_job_id=(?) AND
             task_id=(?)""",
-            (resources_str, submit_time, SpotStatus.SUBMITTED.value,
+            (resources_str, submit_time, ManagedJobStatus.SUBMITTED.value,
              run_timestamp, job_id, task_id))
     callback_func('SUBMITTED')
 
 
 def set_starting(job_id: int, task_id: int, callback_func: CallbackType):
     """Set the task to starting state."""
     logger.info('Launching the spot cluster...')
     with db_utils.safe_cursor(_DB_PATH) as cursor:
         cursor.execute(
             """\
             UPDATE spot SET status=(?)
             WHERE spot_job_id=(?) AND
-            task_id=(?)""", (SpotStatus.STARTING.value, job_id, task_id))
+            task_id=(?)""", (ManagedJobStatus.STARTING.value, job_id, task_id))
     callback_func('STARTING')
 
 
 def set_started(job_id: int, task_id: int, start_time: float,
                 callback_func: CallbackType):
     """Set the task to started state."""
     logger.info('Job started.')
     with db_utils.safe_cursor(_DB_PATH) as cursor:
         cursor.execute(
             """\
             UPDATE spot SET status=(?), start_at=(?), last_recovered_at=(?)
             WHERE spot_job_id=(?) AND
             task_id=(?)""",
-            (SpotStatus.RUNNING.value, start_time, start_time, job_id, task_id))
+            (
+                ManagedJobStatus.RUNNING.value,
+                start_time,
+                start_time,
+                job_id,
+                task_id,
+            ),
+        )
     callback_func('STARTED')
 
 
 def set_recovering(job_id: int, task_id: int, callback_func: CallbackType):
     """Set the task to recovering state, and update the job duration."""
     logger.info('=== Recovering... ===')
     with db_utils.safe_cursor(_DB_PATH) as cursor:
         cursor.execute(
             """\
                 UPDATE spot SET
                 status=(?), job_duration=job_duration+(?)-last_recovered_at
                 WHERE spot_job_id=(?) AND
                 task_id=(?)""",
-            (SpotStatus.RECOVERING.value, time.time(), job_id, task_id))
+            (ManagedJobStatus.RECOVERING.value, time.time(), job_id, task_id))
     callback_func('RECOVERING')
 
 
 def set_recovered(job_id: int, task_id: int, recovered_time: float,
                   callback_func: CallbackType):
     """Set the task to recovered."""
     with db_utils.safe_cursor(_DB_PATH) as cursor:
         cursor.execute(
             """\
             UPDATE spot SET
             status=(?), last_recovered_at=(?), recovery_count=recovery_count+1
             WHERE spot_job_id=(?) AND
             task_id=(?)""",
-            (SpotStatus.RUNNING.value, recovered_time, job_id, task_id))
+            (ManagedJobStatus.RUNNING.value, recovered_time, job_id, task_id))
     logger.info('==== Recovered. ====')
     callback_func('RECOVERED')
 
 
 def set_succeeded(job_id: int, task_id: int, end_time: float,
                   callback_func: CallbackType):
     """Set the task to succeeded, if it is in a non-terminal state."""
     with db_utils.safe_cursor(_DB_PATH) as cursor:
         cursor.execute(
             """\
             UPDATE spot SET
             status=(?), end_at=(?)
             WHERE spot_job_id=(?) AND task_id=(?)
             AND end_at IS null""",
-            (SpotStatus.SUCCEEDED.value, end_time, job_id, task_id))
+            (ManagedJobStatus.SUCCEEDED.value, end_time, job_id, task_id))
 
     callback_func('SUCCEEDED')
     logger.info('Job succeeded.')
 
 
 def set_failed(
     job_id: int,
     task_id: Optional[int],
-    failure_type: SpotStatus,
+    failure_type: ManagedJobStatus,
     failure_reason: str,
     callback_func: Optional[CallbackType] = None,
     end_time: Optional[float] = None,
 ):
     """Set an entire job or task to failed, if they are in non-terminal states.
 
     Args:
         job_id: The job id.
         task_id: The task id. If None, all non-finished tasks of the job will
             be set to failed.
-        failure_type: The failure type. One of SpotStatus.FAILED_*.
+        failure_type: The failure type. One of ManagedJobStatus.FAILED_*.
         failure_reason: The failure reason.
         end_time: The end time. If None, the current time will be used.
     """
     assert failure_type.is_failed(), failure_type
     end_time = time.time() if end_time is None else end_time
 
     fields_to_set = {
@@ -401,16 +410,16 @@
         'status': failure_type.value,
         'failure_reason': failure_reason,
     }
     with db_utils.safe_cursor(_DB_PATH) as cursor:
         previous_status = cursor.execute(
             'SELECT status FROM spot WHERE spot_job_id=(?)',
             (job_id,)).fetchone()
-        previous_status = SpotStatus(previous_status[0])
-        if previous_status in [SpotStatus.RECOVERING]:
+        previous_status = ManagedJobStatus(previous_status[0])
+        if previous_status in [ManagedJobStatus.RECOVERING]:
             # If the job is recovering, we should set the
             # last_recovered_at to the end_time, so that the
             # end_at - last_recovered_at will not be affect the job duration
             # calculation.
             fields_to_set['last_recovered_at'] = end_time
         set_str = ', '.join(f'{k}=(?)' for k in fields_to_set)
         task_str = '' if task_id is None else f' AND task_id={task_id}'
@@ -434,15 +443,15 @@
     """
     with db_utils.safe_cursor(_DB_PATH) as cursor:
         rows = cursor.execute(
             """\
             UPDATE spot SET
             status=(?), end_at=(?)
             WHERE spot_job_id=(?) AND end_at IS null""",
-            (SpotStatus.CANCELLING.value, time.time(), job_id))
+            (ManagedJobStatus.CANCELLING.value, time.time(), job_id))
         if rows.rowcount > 0:
             logger.info('Cancelling the job...')
             callback_func('CANCELLING')
 
 
 def set_cancelled(job_id: int, callback_func: CallbackType):
     """Set tasks in the job as cancelled, if they are in CANCELLING state.
@@ -451,38 +460,40 @@
     """
     with db_utils.safe_cursor(_DB_PATH) as cursor:
         rows = cursor.execute(
             """\
             UPDATE spot SET
             status=(?), end_at=(?)
             WHERE spot_job_id=(?) AND status=(?)""",
-            (SpotStatus.CANCELLED.value, time.time(), job_id,
-             SpotStatus.CANCELLING.value))
+            (ManagedJobStatus.CANCELLED.value, time.time(), job_id,
+             ManagedJobStatus.CANCELLING.value))
         if rows.rowcount > 0:
             logger.info('Job cancelled.')
             callback_func('CANCELLED')
 
 
 # ======== utility functions ========
 def get_nonterminal_job_ids_by_name(name: Optional[str]) -> List[int]:
     """Get non-terminal job ids by name."""
-    statuses = ', '.join(['?'] * len(SpotStatus.terminal_statuses()))
-    field_values = [status.value for status in SpotStatus.terminal_statuses()]
+    statuses = ', '.join(['?'] * len(ManagedJobStatus.terminal_statuses()))
+    field_values = [
+        status.value for status in ManagedJobStatus.terminal_statuses()
+    ]
 
     name_filter = ''
     if name is not None:
         # We match the job name from `job_info` for the jobs submitted after
         # #1982, and from `spot` for the jobs submitted before #1982, whose
         # job_info is not available.
         name_filter = ('AND (job_info.name=(?) OR '
                        '(job_info.name IS NULL AND spot.task_name=(?)))')
         field_values.extend([name, name])
 
     # Left outer join is used here instead of join, because the job_info does
-    # not contain the spot jobs submitted before #1982.
+    # not contain the managed jobs submitted before #1982.
     with db_utils.safe_cursor(_DB_PATH) as cursor:
         rows = cursor.execute(
             f"""\
             SELECT DISTINCT spot.spot_job_id
             FROM spot
             LEFT OUTER JOIN job_info
             ON spot.spot_job_id=job_info.spot_job_id
@@ -490,50 +501,51 @@
             ({statuses})
             {name_filter}
             ORDER BY spot.spot_job_id DESC""", field_values).fetchall()
         job_ids = [row[0] for row in rows if row[0] is not None]
         return job_ids
 
 
-def _get_all_task_ids_statuses(job_id: int) -> List[Tuple[int, SpotStatus]]:
+def _get_all_task_ids_statuses(
+        job_id: int) -> List[Tuple[int, ManagedJobStatus]]:
     with db_utils.safe_cursor(_DB_PATH) as cursor:
         id_statuses = cursor.execute(
             """\
             SELECT task_id, status FROM spot
             WHERE spot_job_id=(?)
             ORDER BY task_id ASC""", (job_id,)).fetchall()
-        return [(row[0], SpotStatus(row[1])) for row in id_statuses]
+        return [(row[0], ManagedJobStatus(row[1])) for row in id_statuses]
 
 
 def get_num_tasks(job_id: int) -> int:
     return len(_get_all_task_ids_statuses(job_id))
 
 
 def get_latest_task_id_status(
-        job_id: int) -> Union[Tuple[int, SpotStatus], Tuple[None, None]]:
+        job_id: int) -> Union[Tuple[int, ManagedJobStatus], Tuple[None, None]]:
     """Returns the (task id, status) of the latest task of a job.
 
-    The latest means the task that is currently being executed or to be
-    started by the controller process. For example, in a spot job with
-    3 tasks, the first task is succeeded, and the second task is being
-    executed. This will return (1, SpotStatus.RUNNING).
+    The latest means the task that is currently being executed or to be started
+    by the controller process. For example, in a managed job with 3 tasks, the
+    first task is succeeded, and the second task is being executed. This will
+    return (1, ManagedJobStatus.RUNNING).
 
     If the job_id does not exist, (None, None) will be returned.
     """
     id_statuses = _get_all_task_ids_statuses(job_id)
     if len(id_statuses) == 0:
         return None, None
     task_id, status = id_statuses[-1]
     for task_id, status in id_statuses:
         if not status.is_terminal():
             break
     return task_id, status
 
 
-def get_status(job_id: int) -> Optional[SpotStatus]:
+def get_status(job_id: int) -> Optional[ManagedJobStatus]:
     _, status = get_latest_task_id_status(job_id)
     return status
 
 
 def get_failure_reason(job_id: int) -> Optional[str]:
     """Get the failure reason of a job.
 
@@ -547,35 +559,35 @@
             ORDER BY task_id ASC""", (job_id,)).fetchall()
         reason = [r[0] for r in reason if r[0] is not None]
         if len(reason) == 0:
             return None
         return reason[0]
 
 
-def get_spot_jobs(job_id: Optional[int] = None) -> List[Dict[str, Any]]:
-    """Get spot clusters' status."""
+def get_managed_jobs(job_id: Optional[int] = None) -> List[Dict[str, Any]]:
+    """Get managed jobs from the database."""
     job_filter = '' if job_id is None else f'WHERE spot.spot_job_id={job_id}'
 
-    # Join the spot and job_info tables to get the job name for each task.
+    # Join spot and job_info tables to get the job name for each task.
     # We use LEFT OUTER JOIN mainly for backward compatibility, as for an
     # existing controller before #1982, the job_info table may not exist,
-    # and all the spot jobs created before will not present in the
+    # and all the managed jobs created before will not present in the
     # job_info.
     with db_utils.safe_cursor(_DB_PATH) as cursor:
         rows = cursor.execute(f"""\
             SELECT *
             FROM spot
             LEFT OUTER JOIN job_info
             ON spot.spot_job_id=job_info.spot_job_id
             {job_filter}
             ORDER BY spot.spot_job_id DESC, spot.task_id ASC""").fetchall()
         jobs = []
         for row in rows:
             job_dict = dict(zip(columns, row))
-            job_dict['status'] = SpotStatus(job_dict['status'])
+            job_dict['status'] = ManagedJobStatus(job_dict['status'])
             if job_dict['job_name'] is None:
                 job_dict['job_name'] = job_dict['task_name']
             jobs.append(job_dict)
         return jobs
 
 
 def get_task_name(job_id: int, task_id: int) -> str:
```

### Comparing `skypilot-0.5.0/sky/spot/spot_utils.py` & `skypilot-0.6.0/sky/jobs/utils.py`

 * *Files 26% similar despite different names*

```diff
@@ -1,82 +1,90 @@
-"""User interfaces with managed spot jobs."""
+"""User interfaces with managed jobs.
+
+NOTE: whenever an API change is made in this file, we need to bump the
+jobs.constants.MANAGED_JOBS_VERSION and handle the API change in the
+ManagedJobCodeGen.
+"""
 import collections
 import enum
-import json
+import inspect
 import os
 import pathlib
 import shlex
+import shutil
+import textwrap
 import time
 import typing
 from typing import Any, Dict, List, Optional, Tuple, Union
 
 import colorama
 import filelock
 from typing_extensions import Literal
 
 from sky import backends
 from sky import exceptions
 from sky import global_user_state
 from sky import sky_logging
 from sky.backends import backend_utils
+from sky.jobs import constants as managed_job_constants
+from sky.jobs import state as managed_job_state
 from sky.skylet import constants
 from sky.skylet import job_lib
-from sky.skylet.log_lib import run_bash_command_with_log
-from sky.spot import constants as spot_constants
-from sky.spot import spot_state
+from sky.skylet import log_lib
 from sky.utils import common_utils
 from sky.utils import log_utils
 from sky.utils import rich_utils
 from sky.utils import subprocess_utils
 
 if typing.TYPE_CHECKING:
     import sky
     from sky import dag as dag_lib
 
 logger = sky_logging.init_logger(__name__)
 
 # Add user hash so that two users don't have the same controller VM on
 # shared-account clouds such as GCP.
-SPOT_CONTROLLER_NAME: str = (
+JOB_CONTROLLER_NAME: str = (
+    f'sky-jobs-controller-{common_utils.get_user_hash()}')
+LEGACY_JOB_CONTROLLER_NAME: str = (
     f'sky-spot-controller-{common_utils.get_user_hash()}')
-SIGNAL_FILE_PREFIX = '/tmp/sky_spot_controller_signal_{}'
+SIGNAL_FILE_PREFIX = '/tmp/sky_jobs_controller_signal_{}'
+LEGACY_SIGNAL_FILE_PREFIX = '/tmp/sky_spot_controller_signal_{}'
 # Controller checks its job's status every this many seconds.
 JOB_STATUS_CHECK_GAP_SECONDS = 20
 
 # Controller checks if its job has started every this many seconds.
 JOB_STARTED_STATUS_CHECK_GAP_SECONDS = 5
 
-_SPOT_STATUS_CACHE = '~/.sky/spot_status_cache.txt'
-
 _LOG_STREAM_CHECK_CONTROLLER_GAP_SECONDS = 5
 
 _JOB_WAITING_STATUS_MESSAGE = ('[bold cyan]Waiting for the task to start'
                                '{status_str}.[/] It may take a few minutes.')
 _JOB_CANCELLED_MESSAGE = (
     '[bold cyan]Waiting for the task status to be updated.'
     '[/] It may take a minute.')
 
-# The maximum time to wait for the spot job status to transition to terminal
+# The maximum time to wait for the managed job status to transition to terminal
 # state, after the job finished. This is a safeguard to avoid the case where
-# the spot job status fails to be updated and keep the `sky spot logs` blocking
-# for a long time.
-_FINAL_SPOT_STATUS_WAIT_TIMEOUT_SECONDS = 20
+# the managed job status fails to be updated and keep the `sky jobs logs`
+# blocking for a long time.
+_FINAL_JOB_STATUS_WAIT_TIMEOUT_SECONDS = 20
 
 
 class UserSignal(enum.Enum):
     """The signal to be sent to the user."""
     CANCEL = 'CANCEL'
     # NOTE: We can have more communication signals here if needed
     # in the future.
 
 
 # ====== internal functions ======
 def get_job_status(backend: 'backends.CloudVmRayBackend',
                    cluster_name: str) -> Optional['job_lib.JobStatus']:
-    """Check the status of the job running on the spot cluster.
+    """Check the status of the job running on a managed job cluster.
 
     It can be None, INIT, RUNNING, SUCCEEDED, FAILED, FAILED_SETUP or CANCELLED.
     """
     handle = global_user_state.get_handle_from_cluster_name(cluster_name)
     assert isinstance(handle, backends.CloudVmRayResourceHandle), handle
     status = None
     try:
@@ -89,63 +97,65 @@
             logger.info(f'Job status: {status}')
     except exceptions.CommandError:
         logger.info('Failed to connect to the cluster.')
     logger.info('=' * 34)
     return status
 
 
-def update_spot_job_status(job_id: Optional[int] = None):
-    """Update spot job status if the controller job failed abnormally.
+def update_managed_job_status(job_id: Optional[int] = None):
+    """Update managed job status if the controller job failed abnormally.
 
     Check the status of the controller job. If it is not running, it must have
     exited abnormally, and we should set the job status to FAILED_CONTROLLER.
     `end_at` will be set to the current timestamp for the job when above
     happens, which could be not accurate based on the frequency this function
     is called.
     """
     if job_id is None:
-        job_ids = spot_state.get_nonterminal_job_ids_by_name(None)
+        job_ids = managed_job_state.get_nonterminal_job_ids_by_name(None)
     else:
         job_ids = [job_id]
     for job_id_ in job_ids:
         controller_status = job_lib.get_status(job_id_)
         if controller_status is None or controller_status.is_terminal():
             logger.error(f'Controller for job {job_id_} has exited abnormally. '
                          'Setting the job status to FAILED_CONTROLLER.')
-            tasks = spot_state.get_spot_jobs(job_id_)
+            tasks = managed_job_state.get_managed_jobs(job_id_)
             for task in tasks:
                 task_name = task['job_name']
-                # Tear down the abnormal spot cluster to avoid resource leakage.
-                cluster_name = generate_spot_cluster_name(task_name, job_id_)
+                # Tear down the abnormal cluster to avoid resource leakage.
+                cluster_name = generate_managed_job_cluster_name(
+                    task_name, job_id_)
                 handle = global_user_state.get_handle_from_cluster_name(
                     cluster_name)
                 if handle is not None:
                     backend = backend_utils.get_backend_from_handle(handle)
                     max_retry = 3
                     for retry_cnt in range(max_retry):
                         try:
                             backend.teardown(handle, terminate=True)
                             break
                         except RuntimeError:
-                            logger.error('Failed to tear down the spot cluster '
+                            logger.error('Failed to tear down the cluster '
                                          f'{cluster_name!r}. Retrying '
                                          f'[{retry_cnt}/{max_retry}].')
 
-            # The controller job for this spot job is not running: it must
+            # The controller job for this managed job is not running: it must
             # have exited abnormally, and we should set the job status to
             # FAILED_CONTROLLER.
             # The `set_failed` will only update the task's status if the
             # status is non-terminal.
-            spot_state.set_failed(
+            managed_job_state.set_failed(
                 job_id_,
                 task_id=None,
-                failure_type=spot_state.SpotStatus.FAILED_CONTROLLER,
+                failure_type=managed_job_state.ManagedJobStatus.
+                FAILED_CONTROLLER,
                 failure_reason=
                 'Controller process has exited abnormally. For more details,'
-                f' run: sky spot logs --controller {job_id_}')
+                f' run: sky jobs logs --controller {job_id_}')
 
 
 def get_job_timestamp(backend: 'backends.CloudVmRayBackend', cluster_name: str,
                       get_end_time: bool) -> float:
     """Get the submitted/ended time of the job."""
     code = job_lib.JobLibCodeGen.get_job_submitted_or_ended_timestamp_payload(
         job_id=None, get_ended_time=get_end_time)
@@ -160,116 +170,117 @@
     stdout = common_utils.decode_payload(stdout)
     return float(stdout)
 
 
 def event_callback_func(job_id: int, task_id: int, task: 'sky.Task'):
     """Run event callback for the task."""
 
-    def callback_func(state: str):
+    def callback_func(status: str):
         event_callback = task.event_callback if task else None
         if event_callback is None or task is None:
             return
         event_callback = event_callback.strip()
-        cluster_name = generate_spot_cluster_name(task.name,
-                                                  job_id) if task.name else None
-        logger.info(f'=== START: event callback for {state!r} ===')
-        log_path = os.path.join(constants.SKY_LOGS_DIRECTORY, 'spot_event',
-                                f'spot-callback-{job_id}-{task_id}.log')
-        result = run_bash_command_with_log(
+        cluster_name = generate_managed_job_cluster_name(
+            task.name, job_id) if task.name else None
+        logger.info(f'=== START: event callback for {status!r} ===')
+        log_path = os.path.join(constants.SKY_LOGS_DIRECTORY,
+                                'managed_job_event',
+                                f'jobs-callback-{job_id}-{task_id}.log')
+        result = log_lib.run_bash_command_with_log(
             bash_command=event_callback,
             log_path=log_path,
             env_vars=dict(
-                SKYPILOT_JOB_ID=str(
-                    task.envs.get(constants.TASK_ID_ENV_VAR_DEPRECATED,
-                                  'N.A.')),
                 SKYPILOT_TASK_ID=str(
                     task.envs.get(constants.TASK_ID_ENV_VAR, 'N.A.')),
                 SKYPILOT_TASK_IDS=str(
                     task.envs.get(constants.TASK_ID_LIST_ENV_VAR, 'N.A.')),
                 TASK_ID=str(task_id),
                 JOB_ID=str(job_id),
-                JOB_STATUS=state,
+                JOB_STATUS=status,
                 CLUSTER_NAME=cluster_name or '',
                 TASK_NAME=task.name or '',
                 # TODO(MaoZiming): Future event type Job or Spot.
                 EVENT_TYPE='Spot'))
         logger.info(
             f'Bash:{event_callback},log_path:{log_path},result:{result}')
-        logger.info(f'=== END: event callback for {state!r} ===')
+        logger.info(f'=== END: event callback for {status!r} ===')
 
     return callback_func
 
 
 # ======== user functions ========
 
 
-def generate_spot_cluster_name(task_name: str, job_id: int) -> str:
-    """Generate spot cluster name."""
+def generate_managed_job_cluster_name(task_name: str, job_id: int) -> str:
+    """Generate managed job cluster name."""
     # Truncate the task name to 30 chars to avoid the cluster name being too
     # long after appending the job id, which will cause another truncation in
     # the underlying sky.launch, hiding the `job_id` in the cluster name.
     cluster_name = common_utils.make_cluster_name_on_cloud(
         task_name,
-        spot_constants.SPOT_CLUSTER_NAME_PREFIX_LENGTH,
+        managed_job_constants.JOBS_CLUSTER_NAME_PREFIX_LENGTH,
         add_user_hash=False)
     return f'{cluster_name}-{job_id}'
 
 
 def cancel_jobs_by_id(job_ids: Optional[List[int]]) -> str:
     """Cancel jobs by id.
 
     If job_ids is None, cancel all jobs.
     """
     if job_ids is None:
-        job_ids = spot_state.get_nonterminal_job_ids_by_name(None)
+        job_ids = managed_job_state.get_nonterminal_job_ids_by_name(None)
     job_ids = list(set(job_ids))
     if len(job_ids) == 0:
         return 'No job to cancel.'
     job_id_str = ', '.join(map(str, job_ids))
     logger.info(f'Cancelling jobs {job_id_str}.')
     cancelled_job_ids = []
     for job_id in job_ids:
-        # Check the status of the managed spot job status. If it is in
+        # Check the status of the managed job status. If it is in
         # terminal state, we can safely skip it.
-        job_status = spot_state.get_status(job_id)
+        job_status = managed_job_state.get_status(job_id)
         if job_status is None:
             logger.info(f'Job {job_id} not found. Skipped.')
             continue
         elif job_status.is_terminal():
             logger.info(f'Job {job_id} is already in terminal state '
                         f'{job_status.value}. Skipped.')
             continue
 
-        update_spot_job_status(job_id)
+        update_managed_job_status(job_id)
 
-        # Send the signal to the spot job controller.
+        # Send the signal to the jobs controller.
         signal_file = pathlib.Path(SIGNAL_FILE_PREFIX.format(job_id))
+        legacy_signal_file = pathlib.Path(
+            LEGACY_SIGNAL_FILE_PREFIX.format(job_id))
         # Filelock is needed to prevent race condition between signal
         # check/removal and signal writing.
-        # TODO(mraheja): remove pylint disabling when filelock version updated
-        # pylint: disable=abstract-class-instantiated
         with filelock.FileLock(str(signal_file) + '.lock'):
             with signal_file.open('w', encoding='utf-8') as f:
                 f.write(UserSignal.CANCEL.value)
                 f.flush()
+            # Backward compatibility for managed jobs launched before #3419. It
+            # can be removed in the future 0.8.0 release.
+            shutil.copy(str(signal_file), str(legacy_signal_file))
         cancelled_job_ids.append(job_id)
 
     if len(cancelled_job_ids) == 0:
         return 'No job to cancel.'
     identity_str = f'Job with ID {cancelled_job_ids[0]} is'
     if len(cancelled_job_ids) > 1:
         cancelled_job_ids_str = ', '.join(map(str, cancelled_job_ids))
         identity_str = f'Jobs with IDs {cancelled_job_ids_str} are'
 
     return f'{identity_str} scheduled to be cancelled.'
 
 
 def cancel_job_by_name(job_name: str) -> str:
     """Cancel a job by name."""
-    job_ids = spot_state.get_nonterminal_job_ids_by_name(job_name)
+    job_ids = managed_job_state.get_nonterminal_job_ids_by_name(job_name)
     if len(job_ids) == 0:
         return f'No running job found with name {job_name!r}.'
     if len(job_ids) > 1:
         return (f'{colorama.Fore.RED}Multiple running jobs found '
                 f'with name {job_name!r}.\n'
                 f'Job IDs: {job_ids}{colorama.Style.RESET_ALL}')
     cancel_jobs_by_id(job_ids)
@@ -278,15 +289,15 @@
 
 def stream_logs_by_id(job_id: int, follow: bool = True) -> str:
     """Stream logs by job id."""
     controller_status = job_lib.get_status(job_id)
     status_msg = ('[bold cyan]Waiting for controller process to be RUNNING'
                   '{status_str}[/].')
     status_display = rich_utils.safe_status(status_msg.format(status_str=''))
-    num_tasks = spot_state.get_num_tasks(job_id)
+    num_tasks = managed_job_state.get_num_tasks(job_id)
 
     with status_display:
         prev_msg = None
         while (controller_status != job_lib.JobStatus.RUNNING and
                (controller_status is None or
                 not controller_status.is_terminal())):
             status_str = 'None'
@@ -298,74 +309,77 @@
                 prev_msg = msg
             time.sleep(_LOG_STREAM_CHECK_CONTROLLER_GAP_SECONDS)
             controller_status = job_lib.get_status(job_id)
 
         msg = _JOB_WAITING_STATUS_MESSAGE.format(status_str='')
         status_display.update(msg)
         prev_msg = msg
-        spot_job_status = spot_state.get_status(job_id)
-        while spot_job_status is None:
+        managed_job_status = managed_job_state.get_status(job_id)
+        while managed_job_status is None:
             time.sleep(1)
-            spot_job_status = spot_state.get_status(job_id)
+            managed_job_status = managed_job_state.get_status(job_id)
 
-        if spot_job_status.is_terminal():
+        if managed_job_status.is_terminal():
             job_msg = ''
-            if spot_job_status.is_failed():
-                job_msg = (
-                    f'\nFailure reason: {spot_state.get_failure_reason(job_id)}'
-                )
+            if managed_job_status.is_failed():
+                job_msg = ('\nFailure reason: '
+                           f'{managed_job_state.get_failure_reason(job_id)}')
             return (f'{colorama.Fore.YELLOW}'
                     f'Job {job_id} is already in terminal state '
-                    f'{spot_job_status.value}. Logs will not be shown.'
+                    f'{managed_job_status.value}. Logs will not be shown.'
                     f'{colorama.Style.RESET_ALL}{job_msg}')
         backend = backends.CloudVmRayBackend()
-        task_id, spot_status = spot_state.get_latest_task_id_status(job_id)
+        task_id, managed_job_status = (
+            managed_job_state.get_latest_task_id_status(job_id))
 
-        # task_id and spot_status can be None if the controller process just
-        # started and the spot status has not set to PENDING yet.
-        while spot_status is None or not spot_status.is_terminal():
+        # task_id and managed_job_status can be None if the controller process
+        # just started and the managed job status has not set to PENDING yet.
+        while (managed_job_status is None or
+               not managed_job_status.is_terminal()):
             handle = None
             if task_id is not None:
-                task_name = spot_state.get_task_name(job_id, task_id)
-                cluster_name = generate_spot_cluster_name(task_name, job_id)
+                task_name = managed_job_state.get_task_name(job_id, task_id)
+                cluster_name = generate_managed_job_cluster_name(
+                    task_name, job_id)
                 handle = global_user_state.get_handle_from_cluster_name(
                     cluster_name)
 
             # Check the handle: The cluster can be preempted and removed from
-            # the table before the spot state is updated by the controller. In
-            # this case, we should skip the logging, and wait for the next
-            # round of status check.
-            if handle is None or spot_status != spot_state.SpotStatus.RUNNING:
+            # the table before the managed job state is updated by the
+            # controller. In this case, we should skip the logging, and wait for
+            # the next round of status check.
+            if (handle is None or managed_job_status !=
+                    managed_job_state.ManagedJobStatus.RUNNING):
                 status_str = ''
-                if (spot_status is not None and
-                        spot_status != spot_state.SpotStatus.RUNNING):
-                    status_str = f' (status: {spot_status.value})'
+                if (managed_job_status is not None and managed_job_status !=
+                        managed_job_state.ManagedJobStatus.RUNNING):
+                    status_str = f' (status: {managed_job_status.value})'
                 logger.debug(
                     f'INFO: The log is not ready yet{status_str}. '
                     f'Waiting for {JOB_STATUS_CHECK_GAP_SECONDS} seconds.')
                 msg = _JOB_WAITING_STATUS_MESSAGE.format(status_str=status_str)
                 if msg != prev_msg:
                     status_display.update(msg)
                     prev_msg = msg
                 time.sleep(JOB_STATUS_CHECK_GAP_SECONDS)
-                task_id, spot_status = (
-                    spot_state.get_latest_task_id_status(job_id))
+                task_id, managed_job_status = (
+                    managed_job_state.get_latest_task_id_status(job_id))
                 continue
-            assert spot_status is not None
+            assert managed_job_status is not None
             assert isinstance(handle, backends.CloudVmRayResourceHandle), handle
             status_display.stop()
             returncode = backend.tail_logs(handle,
                                            job_id=None,
-                                           spot_job_id=job_id,
+                                           managed_job_id=job_id,
                                            follow=follow)
             if returncode == 0:
                 # If the log tailing exit successfully (the real job can be
                 # SUCCEEDED or FAILED), we can safely break the loop. We use the
-                # status in job queue to show the information, as the spot_state
-                # is not updated yet.
+                # status in job queue to show the information, as the
+                # ManagedJobStatus is not updated yet.
                 job_statuses = backend.get_job_status(handle, stream_logs=False)
                 job_status = list(job_statuses.values())[0]
                 assert job_status is not None, 'No job found.'
                 if job_status != job_lib.JobStatus.CANCELLED:
                     assert task_id is not None, job_id
                     if task_id < num_tasks - 1 and follow:
                         # The log for the current job is finished. We need to
@@ -375,16 +389,17 @@
                             'is finished. Waiting for the next task\'s log '
                             'to be started.')
                         status_display.update('Waiting for the next task: '
                                               f'{task_id + 1}.')
                         status_display.start()
                         original_task_id = task_id
                         while True:
-                            task_id, spot_status = (
-                                spot_state.get_latest_task_id_status(job_id))
+                            task_id, managed_job_status = (
+                                managed_job_state.get_latest_task_id_status(
+                                    job_id))
                             if original_task_id != task_id:
                                 break
                             time.sleep(JOB_STATUS_CHECK_GAP_SECONDS)
                         continue
                     else:
                         break
                 # The job can be cancelled by the user or the controller (when
@@ -392,110 +407,168 @@
                 logger.debug(
                     'INFO: Job is cancelled. Waiting for the status update in '
                     f'{JOB_STATUS_CHECK_GAP_SECONDS} seconds.')
             else:
                 logger.debug(
                     f'INFO: (Log streaming) Got return code {returncode}. '
                     f'Retrying in {JOB_STATUS_CHECK_GAP_SECONDS} seconds.')
-            # Finish early if the spot status is already in terminal state.
-            spot_status = spot_state.get_status(job_id)
-            assert spot_status is not None, job_id
-            if spot_status.is_terminal():
+            # Finish early if the managed job status is already in terminal
+            # state.
+            managed_job_status = managed_job_state.get_status(job_id)
+            assert managed_job_status is not None, job_id
+            if managed_job_status.is_terminal():
                 break
-            logger.info(f'{colorama.Fore.YELLOW}The job is preempted.'
-                        f'{colorama.Style.RESET_ALL}')
+            logger.info(f'{colorama.Fore.YELLOW}The job cluster is preempted '
+                        f'or failed.{colorama.Style.RESET_ALL}')
             msg = _JOB_CANCELLED_MESSAGE
             status_display.update(msg)
             prev_msg = msg
             status_display.start()
             # If the tailing fails, it is likely that the cluster fails, so we
-            # wait a while to make sure the spot state is updated by the
-            # controller, and check the spot queue again.
+            # wait a while to make sure the managed job state is updated by the
+            # controller, and check the managed job queue again.
             # Wait a bit longer than the controller, so as to make sure the
-            # spot state is updated.
+            # managed job state is updated.
             time.sleep(3 * JOB_STATUS_CHECK_GAP_SECONDS)
-            spot_status = spot_state.get_status(job_id)
+            managed_job_status = managed_job_state.get_status(job_id)
 
-    # The spot_status may not be in terminal status yet, since the controllerhas
-    # not updated the spot state yet. We wait for a while, until the spot state
-    # is updated.
+    # The managed_job_status may not be in terminal status yet, since the
+    # controller has not updated the managed job state yet. We wait for a while,
+    # until the managed job state is updated.
     wait_seconds = 0
-    spot_status = spot_state.get_status(job_id)
-    assert spot_status is not None, job_id
-    while (not spot_status.is_terminal() and follow and
-           wait_seconds < _FINAL_SPOT_STATUS_WAIT_TIMEOUT_SECONDS):
+    managed_job_status = managed_job_state.get_status(job_id)
+    assert managed_job_status is not None, job_id
+    while (not managed_job_status.is_terminal() and follow and
+           wait_seconds < _FINAL_JOB_STATUS_WAIT_TIMEOUT_SECONDS):
         time.sleep(1)
         wait_seconds += 1
-        spot_status = spot_state.get_status(job_id)
-        assert spot_status is not None, job_id
+        managed_job_status = managed_job_state.get_status(job_id)
+        assert managed_job_status is not None, job_id
 
     logger.info(f'Logs finished for job {job_id} '
-                f'(status: {spot_status.value}).')
+                f'(status: {managed_job_status.value}).')
     return ''
 
 
-def stream_logs_by_name(job_name: str, follow: bool = True) -> str:
-    """Stream logs by name."""
-    job_ids = spot_state.get_nonterminal_job_ids_by_name(job_name)
-    if len(job_ids) == 0:
-        return (f'{colorama.Fore.RED}No job found with name {job_name!r}.'
-                f'{colorama.Style.RESET_ALL}')
-    if len(job_ids) > 1:
-        return (f'{colorama.Fore.RED}Multiple running jobs found '
-                f'with name {job_name!r}.\n'
-                f'Job IDs: {job_ids}{colorama.Style.RESET_ALL}')
-    stream_logs_by_id(job_ids[0], follow)
-    return ''
+def stream_logs(job_id: Optional[int],
+                job_name: Optional[str],
+                controller: bool = False,
+                follow: bool = True) -> str:
+    """Stream logs by job id or job name."""
+    if job_id is None and job_name is None:
+        job_id = managed_job_state.get_latest_job_id()
+        if job_id is None:
+            return 'No managed job found.'
+    if controller:
+        if job_id is None:
+            assert job_name is not None
+            managed_jobs = managed_job_state.get_managed_jobs()
+            # We manually filter the jobs by name, instead of using
+            # get_nonterminal_job_ids_by_name, as with `controller=True`, we
+            # should be able to show the logs for jobs in terminal states.
+            managed_jobs = list(
+                filter(lambda job: job['job_name'] == job_name, managed_jobs))
+            if len(managed_jobs) == 0:
+                return f'No managed job found with name {job_name!r}.'
+            if len(managed_jobs) > 1:
+                job_ids_str = ', '.join(job['job_id'] for job in managed_jobs)
+                raise ValueError(
+                    f'Multiple managed jobs found with name {job_name!r} (Job '
+                    f'IDs: {job_ids_str}). Please specify the job_id instead.')
+            job_id = managed_jobs[0]['job_id']
+        assert job_id is not None, (job_id, job_name)
+        # TODO: keep the following code sync with
+        # job_lib.JobLibCodeGen.tail_logs, we do not directly call that function
+        # as the following code need to be run in the current machine, instead
+        # of running remotely.
+        run_timestamp = job_lib.get_run_timestamp(job_id)
+        if run_timestamp is None:
+            return f'No managed job contrller log found with job_id {job_id}.'
+        log_dir = os.path.join(constants.SKY_LOGS_DIRECTORY, run_timestamp)
+        log_lib.tail_logs(job_id=job_id, log_dir=log_dir, follow=follow)
+        return ''
 
+    if job_id is None:
+        assert job_name is not None
+        job_ids = managed_job_state.get_nonterminal_job_ids_by_name(job_name)
+        if len(job_ids) == 0:
+            return f'No running managed job found with name {job_name!r}.'
+        if len(job_ids) > 1:
+            raise ValueError(
+                f'Multiple running jobs found with name {job_name!r}.')
+        job_id = job_ids[0]
+
+    return stream_logs_by_id(job_id, follow)
 
-def dump_spot_job_queue() -> str:
-    jobs = spot_state.get_spot_jobs()
+
+def dump_managed_job_queue() -> str:
+    jobs = managed_job_state.get_managed_jobs()
 
     for job in jobs:
         end_at = job['end_at']
         if end_at is None:
             end_at = time.time()
 
         job_submitted_at = job['last_recovered_at'] - job['job_duration']
-        if job['status'] == spot_state.SpotStatus.RECOVERING:
+        if job['status'] == managed_job_state.ManagedJobStatus.RECOVERING:
             # When job is recovering, the duration is exact job['job_duration']
             job_duration = job['job_duration']
         elif job_submitted_at > 0:
             job_duration = end_at - job_submitted_at
         else:
             # When job_start_at <= 0, that means the last_recovered_at is not
             # set yet, i.e. the job is not started.
             job_duration = 0
         job['job_duration'] = job_duration
         job['status'] = job['status'].value
 
-        cluster_name = generate_spot_cluster_name(job['task_name'],
-                                                  job['job_id'])
+        cluster_name = generate_managed_job_cluster_name(
+            job['task_name'], job['job_id'])
         handle = global_user_state.get_handle_from_cluster_name(cluster_name)
         if handle is not None:
             assert isinstance(handle, backends.CloudVmRayResourceHandle)
             job['cluster_resources'] = (
                 f'{handle.launched_nodes}x {handle.launched_resources}')
             job['region'] = handle.launched_resources.region
         else:
             # FIXME(zongheng): display the last cached values for these.
             job['cluster_resources'] = '-'
             job['region'] = '-'
 
     return common_utils.encode_payload(jobs)
 
 
-def load_spot_job_queue(payload: str) -> List[Dict[str, Any]]:
+def load_managed_job_queue(payload: str) -> List[Dict[str, Any]]:
     """Load job queue from json string."""
     jobs = common_utils.decode_payload(payload)
     for job in jobs:
-        job['status'] = spot_state.SpotStatus(job['status'])
+        job['status'] = managed_job_state.ManagedJobStatus(job['status'])
     return jobs
 
 
+def _get_job_status_from_tasks(
+    job_tasks: List[Dict[str, Any]]
+) -> Tuple[managed_job_state.ManagedJobStatus, int]:
+    """Get the current task status and the current task id for a job."""
+    managed_task_status = managed_job_state.ManagedJobStatus.SUCCEEDED
+    current_task_id = 0
+    for task in job_tasks:
+        managed_task_status = task['status']
+        current_task_id = task['task_id']
+
+        # Use the first non-succeeded status.
+        if managed_task_status != managed_job_state.ManagedJobStatus.SUCCEEDED:
+            # TODO(zhwu): we should not blindly use the first non-
+            # succeeded as the status could be changed to SUBMITTED
+            # when going from one task to the next one, which can be
+            # confusing.
+            break
+    return managed_task_status, current_task_id
+
+
 @typing.overload
 def format_job_table(tasks: List[Dict[str, Any]],
                      show_all: bool,
                      return_rows: Literal[False] = False,
                      max_jobs: Optional[int] = None) -> str:
     ...
 
@@ -509,26 +582,44 @@
 
 
 def format_job_table(
         tasks: List[Dict[str, Any]],
         show_all: bool,
         return_rows: bool = False,
         max_jobs: Optional[int] = None) -> Union[str, List[List[str]]]:
-    """Returns spot jobs as a formatted string.
+    """Returns managed jobs as a formatted string.
 
     Args:
-        jobs: A list of spot jobs.
+        jobs: A list of managed jobs.
         show_all: Whether to show all columns.
         max_jobs: The maximum number of jobs to show in the table.
         return_rows: If True, return the rows as a list of strings instead of
           all rows concatenated into a single string.
 
-    Returns: A formatted string of spot jobs, if not `return_rows`; otherwise a
-      list of "rows" (each of which is a list of str).
+    Returns: A formatted string of managed jobs, if not `return_rows`; otherwise
+      a list of "rows" (each of which is a list of str).
     """
+    jobs = collections.defaultdict(list)
+    for task in tasks:
+        # The tasks within the same job_id are already sorted
+        # by the task_id.
+        jobs[task['job_id']].append(task)
+    jobs = dict(jobs)
+
+    status_counts: Dict[str, int] = collections.defaultdict(int)
+    for job_tasks in jobs.values():
+        managed_job_status = _get_job_status_from_tasks(job_tasks)[0]
+        if not managed_job_status.is_terminal():
+            status_counts[managed_job_status.value] += 1
+
+    if max_jobs is not None:
+        job_ids = sorted(jobs.keys(), reverse=True)
+        job_ids = job_ids[:max_jobs]
+        jobs = {job_id: jobs[job_id] for job_id in job_ids}
+
     columns = [
         'ID', 'TASK', 'NAME', 'RESOURCES', 'SUBMITTED', 'TOT. DURATION',
         'JOB DURATION', '#RECOVERIES', 'STATUS'
     ]
     if show_all:
         columns += ['STARTED', 'CLUSTER', 'REGION', 'FAILURE']
     job_table = log_utils.create_table(columns)
@@ -551,53 +642,40 @@
         if len(job_tasks) > 1:
             # Aggregate the tasks into a new row in the table.
             job_name = job_tasks[0]['job_name']
             job_duration = 0
             submitted_at = None
             end_at: Optional[int] = 0
             recovery_cnt = 0
-            spot_status = spot_state.SpotStatus.SUCCEEDED
-            failure_reason = None
-            current_task_id = len(job_tasks) - 1
+            managed_job_status, current_task_id = _get_job_status_from_tasks(
+                job_tasks)
             for task in job_tasks:
                 job_duration += task['job_duration']
                 if task['submitted_at'] is not None:
                     if (submitted_at is None or
                             submitted_at > task['submitted_at']):
                         submitted_at = task['submitted_at']
                 if task['end_at'] is not None:
                     if end_at is not None and end_at < task['end_at']:
                         end_at = task['end_at']
                 else:
                     end_at = None
                 recovery_cnt += task['recovery_count']
-                if spot_status == spot_state.SpotStatus.SUCCEEDED:
-                    # Use the first non-succeeded status.
-                    # TODO(zhwu): we should not blindly use the first non-
-                    # succeeded as the status could be changed to SUBMITTED
-                    # when going from one task to the next one, which can be
-                    # confusing.
-                    spot_status = task['status']
-                    current_task_id = task['task_id']
-
-                if (failure_reason is None and
-                        task['status'] > spot_state.SpotStatus.SUCCEEDED):
-                    failure_reason = task['failure_reason']
 
+            failure_reason = job_tasks[current_task_id]['failure_reason']
             job_duration = log_utils.readable_time_duration(0,
                                                             job_duration,
                                                             absolute=True)
             submitted = log_utils.readable_time_duration(submitted_at)
             total_duration = log_utils.readable_time_duration(submitted_at,
                                                               end_at,
                                                               absolute=True)
 
-            status_str = spot_status.colored_str()
-            if (spot_status < spot_state.SpotStatus.RUNNING and
-                    current_task_id > 0):
+            status_str = managed_job_status.colored_str()
+            if not managed_job_status.is_terminal():
                 status_str += f' (task: {current_task_id})'
 
             job_values = [
                 job_id,
                 '',
                 job_name,
                 '-',
@@ -614,15 +692,15 @@
                     '-',
                     failure_reason if failure_reason is not None else '-',
                 ])
             job_table.add_row(job_values)
 
         for task in job_tasks:
             # The job['job_duration'] is already calculated in
-            # dump_spot_job_queue().
+            # dump_managed_job_queue().
             job_duration = log_utils.readable_time_duration(
                 0, task['job_duration'], absolute=True)
             submitted = log_utils.readable_time_duration(task['submitted_at'])
             values = [
                 task['job_id'] if len(job_tasks) == 1 else ' \u21B3',
                 task['task_id'] if len(job_tasks) > 1 else '-',
                 task['task_name'],
@@ -653,118 +731,116 @@
             job_table.add_row([''] * len(columns))
     status_str = ', '.join([
         f'{count} {status}' for status, count in sorted(status_counts.items())
     ])
     if status_str:
         status_str = f'In progress tasks: {status_str}'
     else:
-        status_str = 'No in progress tasks.'
+        status_str = 'No in-progress managed jobs.'
     output = status_str
     if str(job_table):
         output += f'\n{job_table}'
     if return_rows:
         return job_table.rows
     return output
 
 
-class SpotCodeGen:
-    """Code generator for managed spot job utility functions.
+class ManagedJobCodeGen:
+    """Code generator for managed job utility functions.
 
     Usage:
 
-      >> codegen = SpotCodegen.show_jobs(...)
+      >> codegen = ManagedJobCodeGen.show_jobs(...)
     """
-    _PREFIX = [
-        'from sky.spot import spot_state',
-        'from sky.spot import spot_utils',
-    ]
+    # TODO: the try..except.. block is for backward compatibility. Remove it in
+    # v0.8.0.
+    _PREFIX = textwrap.dedent("""\
+        managed_job_version = 0
+        try:
+            from sky.jobs import utils
+            from sky.jobs import constants as managed_job_constants
+            from sky.jobs import state as managed_job_state
+
+            managed_job_version = managed_job_constants.MANAGED_JOBS_VERSION
+        except ImportError:
+            from sky.spot import spot_state as managed_job_state
+            from sky.spot import spot_utils as utils
+        """)
 
     @classmethod
     def get_job_table(cls) -> str:
-        code = [
-            'job_table = spot_utils.dump_spot_job_queue()',
-            'print(job_table, flush=True)',
-        ]
+        code = textwrap.dedent("""\
+        if managed_job_version < 1:
+            job_table = utils.dump_spot_job_queue()
+        else:
+            job_table = utils.dump_managed_job_queue()
+        print(job_table, flush=True)
+        """)
         return cls._build(code)
 
     @classmethod
     def cancel_jobs_by_id(cls, job_ids: Optional[List[int]]) -> str:
-        code = [
-            f'msg = spot_utils.cancel_jobs_by_id({job_ids})',
-            'print(msg, end="", flush=True)',
-        ]
+        code = textwrap.dedent(f"""\
+        msg = utils.cancel_jobs_by_id({job_ids})
+        print(msg, end="", flush=True)
+        """)
         return cls._build(code)
 
     @classmethod
     def cancel_job_by_name(cls, job_name: str) -> str:
-        code = [
-            f'msg = spot_utils.cancel_job_by_name({job_name!r})',
-            'print(msg, end="", flush=True)',
-        ]
+        code = textwrap.dedent(f"""\
+        msg = utils.cancel_job_by_name({job_name!r})
+        print(msg, end="", flush=True)
+        """)
         return cls._build(code)
 
     @classmethod
-    def stream_logs_by_name(cls, job_name: str, follow: bool = True) -> str:
-        code = [
-            f'msg = spot_utils.stream_logs_by_name({job_name!r}, '
-            f'follow={follow})',
-            'print(msg, flush=True)',
-        ]
+    def stream_logs(cls,
+                    job_name: Optional[str],
+                    job_id: Optional[int],
+                    follow: bool = True,
+                    controller: bool = False) -> str:
+        # We inspect the source code of the function here for backward
+        # compatibility.
+        # TODO: change to utils.stream_logs(job_id, job_name, follow) in v0.8.0.
+        # Import libraries required by `stream_logs`. The try...except... block
+        # should be removed in v0.8.0.
+        code = textwrap.dedent("""\
+        import os
+
+        from sky.skylet import job_lib, log_lib
+        from sky.skylet import constants
+        try:
+            from sky.jobs.utils import stream_logs_by_id
+        except ImportError:
+            from sky.spot.spot_utils import stream_logs_by_id
+        from typing import Optional
+        """)
+        code += inspect.getsource(stream_logs)
+        code += textwrap.dedent(f"""\
+
+        msg = stream_logs({job_id!r}, {job_name!r}, 
+                           follow={follow}, controller={controller})
+        print(msg, flush=True)
+        """)
         return cls._build(code)
 
     @classmethod
-    def stream_logs_by_id(cls,
-                          job_id: Optional[int],
-                          follow: bool = True) -> str:
-        code = [
-            f'job_id = {job_id} if {job_id} is not None '
-            'else spot_state.get_latest_job_id()',
-            f'msg = spot_utils.stream_logs_by_id(job_id, follow={follow})',
-            'print(msg, flush=True)',
-        ]
+    def set_pending(cls, job_id: int, managed_job_dag: 'dag_lib.Dag') -> str:
+        dag_name = managed_job_dag.name
+        # Add the managed job to queue table.
+        code = textwrap.dedent(f"""\
+            managed_job_state.set_job_name({job_id}, {dag_name!r})
+            """)
+        for task_id, task in enumerate(managed_job_dag.tasks):
+            resources_str = backend_utils.get_task_resources_str(
+                task, is_managed_job=True)
+            code += textwrap.dedent(f"""\
+                managed_job_state.set_pending({job_id}, {task_id}, 
+                                  {task.name!r}, {resources_str!r})
+                """)
         return cls._build(code)
 
     @classmethod
-    def set_pending(cls, job_id: int, spot_dag: 'dag_lib.Dag') -> str:
-        dag_name = spot_dag.name
-        # Add the spot job to spot queue table.
-        code = [
-            f'spot_state.set_job_name('
-            f'{job_id}, {dag_name!r})',
-        ]
-        for task_id, task in enumerate(spot_dag.tasks):
-            resources_str = backend_utils.get_task_resources_str(task)
-            code += [
-                f'spot_state.set_pending('
-                f'{job_id}, {task_id}, {task.name!r}, '
-                f'{resources_str!r})',
-            ]
-        return cls._build(code)
-
-    @classmethod
-    def _build(cls, code: List[str]) -> str:
-        code = cls._PREFIX + code
-        generated_code = '; '.join(code)
-        return f'python3 -u -c {shlex.quote(generated_code)}'
-
-
-def dump_job_table_cache(job_table: str):
-    """Dump job table cache to file."""
-    cache_file = pathlib.Path(_SPOT_STATUS_CACHE).expanduser()
-    with cache_file.open('w', encoding='utf-8') as f:
-        json.dump((time.time(), job_table), f)
-
-
-def load_job_table_cache() -> Optional[Tuple[float, str]]:
-    """Load job table cache from file.
-
-    Returns:
-        A tuple of (timestamp, job_table), where the timestamp is
-        the time when the job table is dumped and the job_table is
-        the dumped job table in string.
-        None if the cache file does not exist.
-    """
-    cache_file = pathlib.Path(_SPOT_STATUS_CACHE).expanduser()
-    if not cache_file.exists():
-        return None
-    with cache_file.open('r', encoding='utf-8') as f:
-        return json.load(f)
+    def _build(cls, code: str) -> str:
+        generated_code = cls._PREFIX + '\n' + code
+        return f'{constants.SKY_PYTHON_CMD} -u -c {shlex.quote(generated_code)}'
```

### Comparing `skypilot-0.5.0/sky/status_lib.py` & `skypilot-0.6.0/sky/status_lib.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/task.py` & `skypilot-0.6.0/sky/task.py`

 * *Files 6% similar despite different names*

```diff
@@ -9,17 +9,15 @@
 
 import colorama
 import yaml
 
 import sky
 from sky import clouds
 from sky import exceptions
-from sky import global_user_state
 from sky import sky_logging
-from sky.backends import backend_utils
 import sky.dag
 from sky.data import data_utils
 from sky.data import storage as storage_lib
 from sky.provision import docker_utils
 from sky.serve import service_spec
 from sky.skylet import constants
 from sky.utils import common_utils
@@ -31,15 +29,15 @@
 
 logger = sky_logging.init_logger(__name__)
 
 # A lambda generating commands (node rank_i, node addrs -> cmd_i).
 CommandGen = Callable[[int, List[str]], Optional[str]]
 CommandOrCommandGen = Union[str, CommandGen]
 
-_VALID_NAME_REGEX = '[a-z0-9]+(?:[._-]{1,2}[a-z0-9]+)*'
+_VALID_NAME_REGEX = '[a-zA-Z0-9]+(?:[._-]{1,2}[a-zA-Z0-9]+)*'
 _VALID_NAME_DESCR = ('ASCII characters and may contain lowercase and'
                      ' uppercase letters, digits, underscores, periods,'
                      ' and dashes. Must start and end with alphanumeric'
                      ' characters. No triple dashes or underscores.')
 
 _RUN_FN_CHECK_FAIL_MSG = (
     'run command generator must take exactly 2 arguments: node_rank (int) and'
@@ -251,34 +249,35 @@
         self._envs = envs or {}
         self.workdir = workdir
         self.docker_image = (docker_image if docker_image else
                              'gpuci/miniforge-cuda:11.4-devel-ubuntu18.04')
         self.event_callback = event_callback
         # Ignore type error due to a mypy bug.
         # https://github.com/python/mypy/issues/3004
+        self._num_nodes = 1
         self.num_nodes = num_nodes  # type: ignore
 
         self.inputs: Optional[str] = None
         self.outputs: Optional[str] = None
         self.estimated_inputs_size_gigabytes: Optional[float] = None
         self.estimated_outputs_size_gigabytes: Optional[float] = None
-        # Default to CPUNode
+        # Default to CPU VM
         self.resources: Union[List[sky.Resources],
                               Set[sky.Resources]] = {sky.Resources()}
         self._service: Optional[service_spec.SkyServiceSpec] = None
         # Resources that this task cannot run on.
         self.blocked_resources = blocked_resources
 
         self.time_estimator_func: Optional[Callable[['sky.Resources'],
                                                     int]] = None
         self.file_mounts: Optional[Dict[str, str]] = None
 
-        # Only set when 'self' is a spot controller task: 'self.spot_dag' is
-        # the underlying managed spot dag (sky.Dag object).
-        self.spot_dag: Optional['sky.Dag'] = None
+        # Only set when 'self' is a jobs controller task: 'self.managed_job_dag'
+        # is the underlying managed job dag (sky.Dag object).
+        self.managed_job_dag: Optional['sky.Dag'] = None
 
         # Only set when 'self' is a sky serve controller task.
         self.service_name: Optional[str] = None
 
         # Filled in by the optimizer.  If None, this Task is not planned.
         self.best_resources = None
         # Check if the task is legal.
@@ -345,34 +344,47 @@
                         f'a symlink to a directory). {self.workdir} not found.')
 
     @staticmethod
     def from_yaml_config(
         config: Dict[str, Any],
         env_overrides: Optional[List[Tuple[str, str]]] = None,
     ) -> 'Task':
+        # More robust handling for 'envs': explicitly convert keys and values to
+        # str, since users may pass '123' as keys/values which will get parsed
+        # as int causing validate_schema() to fail.
+        envs = config.get('envs')
+        if envs is not None and isinstance(envs, dict):
+            new_envs: Dict[str, Optional[str]] = {}
+            for k, v in envs.items():
+                if v is not None:
+                    new_envs[str(k)] = str(v)
+                else:
+                    new_envs[str(k)] = None
+            config['envs'] = new_envs
+        common_utils.validate_schema(config, schemas.get_task_schema(),
+                                     'Invalid task YAML: ')
         if env_overrides is not None:
             # We must override env vars before constructing the Task, because
             # the Storage object creation is eager and it (its name/source
             # fields) may depend on env vars.
             #
             # FIXME(zongheng): The eagerness / how we construct Task's from
             # entrypoint (YAML, CLI args) should be fixed.
             new_envs = config.get('envs', {})
             new_envs.update(env_overrides)
             config['envs'] = new_envs
 
-        # More robust handling for 'envs': explicitly convert keys and values to
-        # str, since users may pass '123' as keys/values which will get parsed
-        # as int causing validate_schema() to fail.
-        envs = config.get('envs')
-        if envs is not None and isinstance(envs, dict):
-            config['envs'] = {str(k): str(v) for k, v in envs.items()}
-
-        common_utils.validate_schema(config, schemas.get_task_schema(),
-                                     'Invalid task YAML: ')
+        for k, v in config.get('envs', {}).items():
+            if v is None:
+                with ux_utils.print_exception_no_traceback():
+                    raise ValueError(
+                        f'Environment variable {k!r} is None. Please set a '
+                        'value for it in task YAML or with --env flag. '
+                        f'To set it to be empty, use an empty string ({k}: "" '
+                        f'in task YAML or --env {k}="" in CLI).')
 
         # Fill in any Task.envs into file_mounts (src/dst paths, storage
         # name/source).
         if config.get('file_mounts') is not None:
             config['file_mounts'] = _fill_in_env_vars(config['file_mounts'],
                                                       config.get('envs', {}))
 
@@ -547,18 +559,14 @@
         # docker login envs are newly added.
         if _check_docker_login_config(self._envs):
             self.resources = _with_docker_login_config(self.resources,
                                                        self._envs)
         return self
 
     @property
-    def need_spot_recovery(self) -> bool:
-        return any(r.spot_recovery is not None for r in self.resources)
-
-    @property
     def use_spot(self) -> bool:
         return any(r.use_spot for r in self.resources)
 
     def set_inputs(self, inputs: str,
                    estimated_size_gigabytes: float) -> 'Task':
         # E.g., 's3://bucket', 'gs://bucket', or None.
         self.inputs = inputs
@@ -613,14 +621,22 @@
         Returns:
           self: The current task, with resources set.
         """
         if isinstance(resources, sky.Resources):
             resources = {resources}
         # TODO(woosuk): Check if the resources are None.
         self.resources = _with_docker_login_config(resources, self.envs)
+
+        # Evaluate if the task requires FUSE and set the requires_fuse flag
+        for _, storage_obj in self.storage_mounts.items():
+            if storage_obj.mode == storage_lib.StorageMode.MOUNT:
+                for r in self.resources:
+                    r.requires_fuse = True
+                break
+
         return self
 
     def set_resources_override(self, override_params: Dict[str, Any]) -> 'Task':
         """Sets the override parameters for the resources."""
         new_resources_list = []
         for res in list(self.resources):
             new_resources = res.copy(**override_params)
@@ -802,16 +818,19 @@
           self: The current task, with storage mounts set.
 
         Raises:
           ValueError: if input paths are invalid.
         """
         if storage_mounts is None:
             self.storage_mounts = {}
+            # Clear the requires_fuse flag if no storage mounts are set.
+            for r in self.resources:
+                r.requires_fuse = False
             return self
-        for target, _ in storage_mounts.items():
+        for target, storage_obj in storage_mounts.items():
             # TODO(zhwu): /home/username/sky_workdir as the target path need
             # to be filtered out as well.
             if (target == constants.SKY_REMOTE_WORKDIR and
                     self.workdir is not None):
                 with ux_utils.print_exception_no_traceback():
                     raise ValueError(
                         f'Cannot use {constants.SKY_REMOTE_WORKDIR!r} as a '
@@ -821,14 +840,20 @@
                         'the file/folder.')
 
             if data_utils.is_cloud_store_url(target):
                 with ux_utils.print_exception_no_traceback():
                     raise ValueError(
                         'Storage mount destination path cannot be cloud storage'
                     )
+
+            if storage_obj.mode == storage_lib.StorageMode.MOUNT:
+                # If any storage is using MOUNT mode, we need to enable FUSE in
+                # the resources.
+                for r in self.resources:
+                    r.requires_fuse = True
         # Storage source validation is done in Storage object
         self.storage_mounts = storage_mounts
         return self
 
     def update_storage_mounts(
             self, storage_mounts: Dict[str, storage_lib.Storage]) -> 'Task':
         """Updates the storage mounts for this task.
@@ -852,64 +877,71 @@
         """
         if not storage_mounts:
             return self
         task_storage_mounts = self.storage_mounts if self.storage_mounts else {}
         task_storage_mounts.update(storage_mounts)
         return self.set_storage_mounts(task_storage_mounts)
 
-    def get_preferred_store_type(self) -> storage_lib.StoreType:
+    def _get_preferred_store(
+            self) -> Tuple[storage_lib.StoreType, Optional[str]]:
+        """Returns the preferred store type and region for this task."""
         # TODO(zhwu, romilb): The optimizer should look at the source and
         #  destination to figure out the right stores to use. For now, we
         #  use a heuristic solution to find the store type by the following
         #  order:
-        #  1. cloud decided in best_resources.
-        #  2. cloud specified in the task resources.
+        #  1. cloud/region decided in best_resources.
+        #  2. cloud/region specified in the task resources.
         #  3. if not specified or the task's cloud does not support storage,
-        #     use the first enabled storage cloud.
+        #     use the first enabled storage cloud with default region.
         # This should be refactored and moved to the optimizer.
 
         # This check is not needed to support multiple accelerators;
         # We just need to get the storage_cloud.
         # assert len(self.resources) == 1, self.resources
         storage_cloud = None
 
-        backend_utils.check_public_cloud_enabled()
-        enabled_storage_clouds = global_user_state.get_enabled_storage_clouds()
-        if not enabled_storage_clouds:
-            raise ValueError('No enabled cloud for storage, run: sky check')
+        enabled_storage_clouds = (
+            storage_lib.get_cached_enabled_storage_clouds_or_refresh(
+                raise_if_no_cloud_access=True))
 
         if self.best_resources is not None:
             storage_cloud = self.best_resources.cloud
+            storage_region = self.best_resources.region
         else:
             resources = list(self.resources)[0]
             storage_cloud = resources.cloud
+            storage_region = resources.region
+
         if storage_cloud is not None:
             if str(storage_cloud) not in enabled_storage_clouds:
                 storage_cloud = None
 
+        storage_cloud_str = None
         if storage_cloud is None:
-            storage_cloud = clouds.CLOUD_REGISTRY.from_str(
-                enabled_storage_clouds[0])
-            assert storage_cloud is not None, enabled_storage_clouds[0]
+            storage_cloud_str = enabled_storage_clouds[0]
+            assert storage_cloud_str is not None, enabled_storage_clouds[0]
+            storage_region = None  # Use default region in the Store class
+        else:
+            storage_cloud_str = str(storage_cloud)
 
-        store_type = storage_lib.get_storetype_from_cloud(storage_cloud)
-        return store_type
+        store_type = storage_lib.StoreType.from_cloud(storage_cloud_str)
+        return store_type, storage_region
 
     def sync_storage_mounts(self) -> None:
         """(INTERNAL) Eagerly syncs storage mounts to cloud storage.
 
         After syncing up, COPY-mode storage mounts are translated into regular
         file_mounts of the form ``{ /remote/path: {s3,gs,..}://<bucket path>
         }``.
         """
         for storage in self.storage_mounts.values():
             if len(storage.stores) == 0:
-                store_type = self.get_preferred_store_type()
+                store_type, store_region = self._get_preferred_store()
                 self.storage_plans[storage] = store_type
-                storage.add_store(store_type)
+                storage.add_store(store_type, store_region)
             else:
                 # We will download the first store that is added to remote.
                 self.storage_plans[storage] = list(storage.stores.keys())[0]
 
         storage_mounts = self.storage_mounts
         storage_plans = self.storage_plans
         for mnt_path, storage in storage_mounts.items():
@@ -981,16 +1013,16 @@
         for k, v in self.file_mounts.items():
             if not data_utils.is_cloud_store_url(
                     k) and not data_utils.is_cloud_store_url(v):
                 d[k] = v
         return d
 
     def is_controller_task(self) -> bool:
-        """Returns whether this task is a spot/serve controller process."""
-        return self.spot_dag is not None or self.service_name is not None
+        """Returns whether this task is a jobs/serve controller process."""
+        return self.managed_job_dag is not None or self.service_name is not None
 
     def get_cloud_to_remote_file_mounts(self) -> Optional[Dict[str, str]]:
         """Returns file mounts of the form (dst=VM path, src=cloud URL).
 
         Local-to-remote file mounts are excluded (handled by
         get_local_to_remote_file_mounts()).
 
@@ -1059,14 +1091,38 @@
         if self.storage_mounts is not None:
             config['file_mounts'].update({
                 mount_path: storage.to_yaml_config()
                 for mount_path, storage in self.storage_mounts.items()
             })
         return config
 
+    def get_required_cloud_features(
+            self) -> Set[clouds.CloudImplementationFeatures]:
+        """Returns the required features for this task (but not for resources).
+
+        Features required by the resources are checked separately in
+        cloud.get_feasible_launchable_resources().
+
+        INTERNAL: this method is internal-facing.
+        """
+        required_features = set()
+
+        # Multi-node
+        if self.num_nodes > 1:
+            required_features.add(clouds.CloudImplementationFeatures.MULTI_NODE)
+
+        # Storage mounting
+        for _, storage_mount in self.storage_mounts.items():
+            if storage_mount.mode == storage_lib.StorageMode.MOUNT:
+                required_features.add(
+                    clouds.CloudImplementationFeatures.STORAGE_MOUNTING)
+                break
+
+        return required_features
+
     def __rshift__(self, b):
         sky.dag.get_current_dag().add_edge(self, b)
 
     def __repr__(self):
         if isinstance(self.run, str):
             run_msg = self.run.replace('\n', '\\n')
             if len(run_msg) > 20:
```

### Comparing `skypilot-0.5.0/sky/templates/aws-ray.yml.j2` & `skypilot-0.6.0/sky/templates/aws-ray.yml.j2`

 * *Files 8% similar despite different names*

```diff
@@ -32,14 +32,15 @@
   availability_zone: {{zones}}
   # Keep (otherwise cannot reuse when re-provisioning).
   # teardown(terminate=True) will override this.
   cache_stopped_nodes: True
   security_group:
     # AWS config file must include security group name
     GroupName: {{security_group}}
+    ManagedBySkyPilot: {{security_group_managed_by_skypilot}}
 {% if vpc_name is not none %}
   # NOTE: This is a new field added by SkyPilot to force use a specific VPC.
   vpc_name: {{vpc_name}}
 {% endif %}
   use_internal_ips: {{use_internal_ips}}
   # Disable launch config check for worker nodes as it can cause resource
   # leakage.
@@ -55,14 +56,18 @@
   ssh_proxy_command: {{ssh_proxy_command}}
 {% endif %}
 
 available_node_types:
   ray.head.default:
     resources: {}
     node_config:
+      {% if remote_identity not in ['LOCAL_CREDENTIALS', 'SERVICE_ACCOUNT'] %}
+      IamInstanceProfile:
+        Name: {{remote_identity}}
+      {% endif %}
       InstanceType: {{instance_type}}
       ImageId: {{image_id}}  # Deep Learning AMI (Ubuntu 18.04); see aws.py.
       # https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/ec2.html#EC2.ServiceResource.create_instances
       BlockDeviceMappings:
         - DeviceName: /dev/sda1
           Ebs:
             VolumeSize: {{disk_size}}
@@ -109,18 +114,18 @@
             content: |
               APT::Periodic::Enable "0";
       TagSpecifications:
         - ResourceType: instance
           Tags:
             - Key: skypilot-user
               Value: {{ user }}
-{%- for tag_key, tag_value in instance_tags.items() %}
-            - Key: {{ tag_key }}
-              Value: {{ tag_value }}
-{%- endfor %}
+            {%- for label_key, label_value in labels.items() %}
+            - Key: {{ label_key }}
+              Value: {{ label_value|tojson }}
+            {%- endfor %}
 
 head_node_type: ray.head.default
 
 # Format: `REMOTE_PATH : LOCAL_PATH`
 file_mounts: {
   "{{sky_ray_yaml_remote_path}}": "{{sky_ray_yaml_local_path}}",
   "{{sky_remote_path}}/{{sky_wheel_hash}}": "{{sky_local_path}}",
@@ -145,26 +150,18 @@
   #    UnavailableInvalidChannel: HTTP 404 NOT FOUND for channel  <https://aws-ml-conda-ec2.s3.us-west-2.amazonaws.com>
   # Line 'sudo bash ..': set the ulimit as suggested by ray docs for performance. https://docs.ray.io/en/latest/cluster/vms/user-guides/large-cluster-best-practices.html#system-configuration
   # Line 'sudo grep ..': set the number of threads per process to unlimited to avoid ray job submit stucking issue when the number of running ray jobs increase.
   # Line 'mkdir -p ..': disable host key check
   # Line 'python3 -c ..': patch the buggy ray files and enable `-o allow_other` option for `goofys`
   - mkdir -p ~/.ssh; touch ~/.ssh/config;
     {{ conda_installation_commands }}
-    (type -a python | grep -q python3) || echo 'alias python=python3' >> ~/.bashrc;
-    (type -a pip | grep -q pip3) || echo 'alias pip=pip3' >> ~/.bashrc;
-    source ~/.bashrc;
-    conda config --remove channels "https://aws-ml-conda-ec2.s3.us-west-2.amazonaws.com";
-    mkdir -p ~/sky_workdir && mkdir -p ~/.sky/sky_app;
-    (pip3 list | grep "ray " | grep {{ray_version}} 2>&1 > /dev/null || pip3 install --exists-action w -U ray[default]=={{ray_version}});
-    (pip3 list | grep "skypilot " && [ "$(cat {{sky_remote_path}}/current_sky_wheel_hash)" == "{{sky_wheel_hash}}" ]) || (pip3 uninstall skypilot -y; pip3 install "$(echo {{sky_remote_path}}/{{sky_wheel_hash}}/skypilot-{{sky_version}}*.whl)[aws, remote]" && echo "{{sky_wheel_hash}}" > {{sky_remote_path}}/current_sky_wheel_hash || exit 1);
+    conda config --remove channels "https://aws-ml-conda-ec2.s3.us-west-2.amazonaws.com" || true;
+    {{ ray_skypilot_installation_commands }}
     sudo bash -c 'rm -rf /etc/security/limits.d; echo "* soft nofile 1048576" >> /etc/security/limits.conf; echo "* hard nofile 1048576" >> /etc/security/limits.conf';
     {%- if docker_image is none %}
     sudo grep -e '^DefaultTasksMax' /etc/systemd/system.conf || (sudo bash -c 'echo "DefaultTasksMax=infinity" >> /etc/systemd/system.conf'); sudo systemctl set-property user-$(id -u $(whoami)).slice TasksMax=infinity; sudo systemctl daemon-reload;
     {%- endif %}
     mkdir -p ~/.ssh; (grep -Pzo -q "Host \*\n  StrictHostKeyChecking no" ~/.ssh/config) || printf "Host *\n  StrictHostKeyChecking no\n" >> ~/.ssh/config;
-    python3 -c "from sky.skylet.ray_patches import patch; patch()" || exit 1;
     [ -f /etc/fuse.conf ] && sudo sed -i 's/#user_allow_other/user_allow_other/g' /etc/fuse.conf || (sudo sh -c 'echo "user_allow_other" > /etc/fuse.conf'); # This is needed for `-o allow_other` option for `goofys`;
 
 # Command to start ray clusters are now placed in `sky.provision.instance_setup`.
 # We do not need to list it here anymore.
-
-
```

### Comparing `skypilot-0.5.0/sky/templates/azure-ray.yml.j2` & `skypilot-0.6.0/sky/templates/azure-ray.yml.j2`

 * *Files 7% similar despite different names*

```diff
@@ -137,50 +137,45 @@
   # Line 'sudo systemctl stop jupyterhub ..': stop jupyterhub service to avoid port conflict on 8081
   # Line 'mkdir -p ..': disable host key check
   # Line 'python3 -c ..': patch the buggy ray files and enable `-o allow_other` option for `goofys`
   # This also kills the service that is holding the lock on dpkg (problem only exists on aws/azure, not gcp)
   # Line 'sudo mv /etc/nccl.conf /etc/nccl.conf.bak' removes the default nccl.conf which is wrongly configured on many multi-GPU Azure VM, causing failure for multi-GPU workloads using NCCL.
   - mkdir -p ~/.ssh; touch ~/.ssh/config;
     {{ conda_installation_commands }}
-    (type -a python | grep -q python3) || echo 'alias python=python3' >> ~/.bashrc;
-    (type -a pip | grep -q pip3) || echo 'alias pip=pip3' >> ~/.bashrc;
-    source ~/.bashrc;
-    mkdir -p ~/sky_workdir && mkdir -p ~/.sky/sky_app && touch ~/.sudo_as_admin_successful;
-    (pip3 list | grep "ray " | grep {{ray_version}} 2>&1 > /dev/null || pip3 install --exists-action w -U ray[default]=={{ray_version}});
-    (pip3 list | grep "skypilot " && [ "$(cat {{sky_remote_path}}/current_sky_wheel_hash)" == "{{sky_wheel_hash}}" ]) || (pip3 uninstall skypilot -y; pip3 install "$(echo {{sky_remote_path}}/{{sky_wheel_hash}}/skypilot-{{sky_version}}*.whl)[azure, remote]" && echo "{{sky_wheel_hash}}" > {{sky_remote_path}}/current_sky_wheel_hash || exit 1);
+    {{ ray_skypilot_installation_commands }}
+    touch ~/.sudo_as_admin_successful;
     sudo bash -c 'rm -rf /etc/security/limits.d; echo "* soft nofile 1048576" >> /etc/security/limits.conf; echo "* hard nofile 1048576" >> /etc/security/limits.conf';
     {%- if docker_image is none %}
     sudo grep -e '^DefaultTasksMax' /etc/systemd/system.conf || (sudo bash -c 'echo "DefaultTasksMax=infinity" >> /etc/systemd/system.conf'); sudo systemctl set-property user-$(id -u $(whoami)).slice TasksMax=infinity; sudo systemctl daemon-reload;
     sudo systemctl stop jupyter > /dev/null 2>&1 || true;
     sudo systemctl disable jupyter > /dev/null 2>&1 || true;
     sudo systemctl stop jupyterhub > /dev/null 2>&1 || true;
     sudo systemctl disable jupyterhub > /dev/null 2>&1 || true;
     {%- endif %}
     mkdir -p ~/.ssh; (grep -Pzo -q "Host \*\n  StrictHostKeyChecking no" ~/.ssh/config) || printf "Host *\n  StrictHostKeyChecking no\n" >> ~/.ssh/config;
-    python3 -c "from sky.skylet.ray_patches import patch; patch()" || exit 1;
     [ -f /etc/fuse.conf ] && sudo sed -i 's/#user_allow_other/user_allow_other/g' /etc/fuse.conf || (sudo sh -c 'echo "user_allow_other" > /etc/fuse.conf');
     sudo mv /etc/nccl.conf /etc/nccl.conf.bak || true;
 
 # Command to start ray on the head node. You don't need to change this.
 # NOTE: these are very performance-sensitive. Each new item opens/closes an SSH
 # connection, which is expensive. Try your best to co-locate commands into fewer
 # items! The same comment applies for worker_start_ray_commands.
 #
 # Increment the following for catching performance bugs easier:
 #   current num items (num SSH connections): 2
 head_start_ray_commands:
   # NOTE: --disable-usage-stats in `ray start` saves 10 seconds of idle wait.
-  - ray stop; RAY_SCHEDULER_EVENTS=0 RAY_DEDUP_LOGS=0 ray start --disable-usage-stats --head --port={{ray_port}} --dashboard-port={{ray_dashboard_port}} --object-manager-port=8076 --autoscaling-config=~/ray_bootstrap_config.yaml {{"--resources='%s'" % custom_resources if custom_resources}} --temp-dir {{ray_temp_dir}} || exit 1; 
+  - {{ sky_activate_python_env }}; {{ sky_ray_cmd }} stop; RAY_SCHEDULER_EVENTS=0 RAY_DEDUP_LOGS=0 {{ sky_ray_cmd }} start --disable-usage-stats --head --port={{ray_port}} --dashboard-port={{ray_dashboard_port}} --object-manager-port=8076 --autoscaling-config=~/ray_bootstrap_config.yaml {{"--num-gpus=%s" % num_gpus if num_gpus}} {{"--resources='%s'" % custom_resources if custom_resources}} --temp-dir {{ray_temp_dir}} || exit 1; 
     which prlimit && for id in $(pgrep -f raylet/raylet); do sudo prlimit --nofile=1048576:1048576 --pid=$id || true; done; 
     {{dump_port_command}}; 
     {{ray_head_wait_initialized_command}}
 
 {%- if num_nodes > 1 %}
 worker_start_ray_commands:
-  - ray stop; RAY_SCHEDULER_EVENTS=0 RAY_DEDUP_LOGS=0 ray start --disable-usage-stats --address=$RAY_HEAD_IP:{{ray_port}} --object-manager-port=8076 {{"--resources='%s'" % custom_resources if custom_resources}} --temp-dir {{ray_temp_dir}} || exit 1;
+  - {{ sky_activate_python_env }}; {{ sky_ray_cmd }} stop; RAY_SCHEDULER_EVENTS=0 RAY_DEDUP_LOGS=0 {{ sky_ray_cmd }} start --disable-usage-stats --address=$RAY_HEAD_IP:{{ray_port}} --object-manager-port=8076 {{"--num-gpus=%s" % num_gpus if num_gpus}} {{"--resources='%s'" % custom_resources if custom_resources}} --temp-dir {{ray_temp_dir}} || exit 1;
     which prlimit && for id in $(pgrep -f raylet/raylet); do sudo prlimit --nofile=1048576:1048576 --pid=$id || true; done;
 {%- else %}
 worker_start_ray_commands: []
 {%- endif %}
 
 head_node: {}
 worker_nodes: {}
```

### Comparing `skypilot-0.5.0/sky/templates/cudo-ray.yml.j2` & `skypilot-0.6.0/sky/templates/runpod-ray.yml.j2`

 * *Files 14% similar despite different names*

```diff
@@ -3,45 +3,43 @@
 # The maximum number of workers nodes to launch in addition to the head node.
 max_workers: {{num_nodes - 1}}
 upscaling_speed: {{num_nodes - 1}}
 idle_timeout_minutes: 60
 
 provider:
   type: external
-  module: sky.provision.cudo
+  module: sky.provision.runpod
   region: "{{region}}"
   disable_launch_config_check: true
 
 auth:
   ssh_user: root
   ssh_private_key: {{ssh_private_key}}
 
 available_node_types:
   ray_head_default:
-    resources: { }
+    resources: {}
     node_config:
-      AuthorizedKey: |
-        skypilot:ssh_public_key_content
       InstanceType: {{instance_type}}
       DiskSize: {{disk_size}}
 
 head_node_type: ray_head_default
 
 # Format: `REMOTE_PATH : LOCAL_PATH`
 file_mounts: {
   "{{sky_ray_yaml_remote_path}}": "{{sky_ray_yaml_local_path}}",
   "{{sky_remote_path}}/{{sky_wheel_hash}}": "{{sky_local_path}}",
 {%- for remote_path, local_path in credentials.items() %}
   "{{remote_path}}": "{{local_path}}",
 {%- endfor %}
 }
 
-rsync_exclude: [ ]
+rsync_exclude: []
 
-initialization_commands: [ ]
+initialization_commands: []
 
 # List of shell commands to run to set up nodes.
 # NOTE: these are very performance-sensitive. Each new item opens/closes an SSH
 # connection, which is expensive. Try your best to co-locate commands into fewer
 # items!
 #
 # Increment the following for catching performance bugs easier:
@@ -59,17 +57,16 @@
     sudo sed -i 's/Unattended-Upgrade "1"/Unattended-Upgrade "0"/g' /etc/apt/apt.conf.d/20auto-upgrades || true;
     sudo kill -9 `sudo lsof /var/lib/dpkg/lock-frontend | awk '{print $2}' | tail -n 1` || true;
     sudo pkill -9 apt-get;
     sudo pkill -9 dpkg;
     sudo dpkg --configure -a;
     mkdir -p ~/.ssh; touch ~/.ssh/config;
     {{ conda_installation_commands }}
-    (type -a python | grep -q python3) || echo 'alias python=python3' >> ~/.bashrc;
-    (type -a pip | grep -q pip3) || echo 'alias pip=pip3' >> ~/.bashrc;
-    source ~/.bashrc;
-    (pip3 list | grep ray | grep {{ray_version}} 2>&1 > /dev/null || pip3 install -U ray[default]=={{ray_version}}) && mkdir -p ~/sky_workdir && mkdir -p ~/.sky/sky_app && touch ~/.sudo_as_admin_successful;
-    (pip3 list | grep skypilot && [ "$(cat {{sky_remote_path}}/current_sky_wheel_hash)" == "{{sky_wheel_hash}}" ]) || (pip3 uninstall skypilot -y; pip3 install "$(echo {{sky_remote_path}}/{{sky_wheel_hash}}/skypilot-{{sky_version}}*.whl)[cudo,remote]" && echo "{{sky_wheel_hash}}" > {{sky_remote_path}}/current_sky_wheel_hash || exit 1);
+    {{ ray_skypilot_installation_commands }}
+    touch ~/.sudo_as_admin_successful;
     sudo bash -c 'rm -rf /etc/security/limits.d; echo "* soft nofile 1048576" >> /etc/security/limits.conf; echo "* hard nofile 1048576" >> /etc/security/limits.conf';
     sudo grep -e '^DefaultTasksMax' /etc/systemd/system.conf || (sudo bash -c 'echo "DefaultTasksMax=infinity" >> /etc/systemd/system.conf'); sudo systemctl set-property user-$(id -u $(whoami)).slice TasksMax=infinity; sudo systemctl daemon-reload;
     mkdir -p ~/.ssh; (grep -Pzo -q "Host \*\n  StrictHostKeyChecking no" ~/.ssh/config) || printf "Host *\n  StrictHostKeyChecking no\n" >> ~/.ssh/config;
-    python3 -c "from sky.skylet.ray_patches import patch; patch()" || exit 1;
     [ -f /etc/fuse.conf ] && sudo sed -i 's/#user_allow_other/user_allow_other/g' /etc/fuse.conf || (sudo sh -c 'echo "user_allow_other" > /etc/fuse.conf');
+
+# Command to start ray clusters are now placed in `sky.provision.instance_setup`.
+# We do not need to list it here anymore.
```

### Comparing `skypilot-0.5.0/sky/templates/fluidstack-ray.yml.j2` & `skypilot-0.6.0/sky/templates/paperspace-ray.yml.j2`

 * *Files 15% similar despite different names*

```diff
@@ -1,33 +1,51 @@
 cluster_name: {{cluster_name_on_cloud}}
 
 # The maximum number of workers nodes to launch in addition to the head node.
 max_workers: {{num_nodes - 1}}
 upscaling_speed: {{num_nodes - 1}}
 idle_timeout_minutes: 60
 
+{%- if docker_image is not none %}
+docker:
+  image: {{docker_image}}
+  container_name: {{docker_container_name}}
+  run_options:
+    - --ulimit nofile=1048576:1048576
+    {%- if custom_resources is not none %}
+      --gpus all
+    {%- endif %}
+  {%- if docker_login_config is not none %}
+  docker_login_config:
+    username: |-
+      {{docker_login_config.username}}
+    password: |-
+      {{docker_login_config.password}}
+    server: |-
+      {{docker_login_config.server}}
+  {%- endif %}
+{%- endif %}
+
 provider:
   type: external
-  module: sky.provision.fluidstack
-  region: {{region}}
-  disable_launch_config_check: true
-
+  module: sky.skylet.providers.paperspace.PaperspaceNodeProvider
+  region: "{{region}}"
 
 auth:
-  ssh_user: {{fluidstack_username}}
+  ssh_user: paperspace
   ssh_private_key: {{ssh_private_key}}
+  ssh_public_key: |-
+      skypilot:ssh_public_key_content
 
 available_node_types:
   ray_head_default:
     resources: {}
     node_config:
       InstanceType: {{instance_type}}
-      AuthorizedKey: |
-        skypilot:ssh_public_key_content
-
+      DiskSize: {{disk_size}}
 
 head_node_type: ray_head_default
 
 # Format: `REMOTE_PATH : LOCAL_PATH`
 file_mounts: {
   "{{sky_ray_yaml_remote_path}}": "{{sky_ray_yaml_local_path}}",
   "{{sky_remote_path}}/{{sky_wheel_hash}}": "{{sky_local_path}}",
@@ -58,21 +76,14 @@
   - sudo systemctl stop unattended-upgrades || true;
     sudo systemctl disable unattended-upgrades || true;
     sudo sed -i 's/Unattended-Upgrade "1"/Unattended-Upgrade "0"/g' /etc/apt/apt.conf.d/20auto-upgrades || true;
     sudo kill -9 `sudo lsof /var/lib/dpkg/lock-frontend | awk '{print $2}' | tail -n 1` || true;
     sudo pkill -9 apt-get;
     sudo pkill -9 dpkg;
     sudo dpkg --configure -a;
-    {{ cuda_installation_commands }}
     mkdir -p ~/.ssh; touch ~/.ssh/config;
     {{ conda_installation_commands }}
-    (type -a python | grep -q python3) || echo 'alias python=python3' >> ~/.bashrc;
-    (type -a pip | grep -q pip3) || echo 'alias pip=pip3' >> ~/.bashrc;
-    source ~/.bashrc;
-    (pip3 list | grep ray | grep {{ray_version}} 2>&1 > /dev/null || pip3 install -U ray[default]=={{ray_version}}) && mkdir -p ~/sky_workdir && mkdir -p ~/.sky/sky_app && touch ~/.sudo_as_admin_successful;
-    (pip3 list | grep "skypilot " && [ "$(cat {{sky_remote_path}}/current_sky_wheel_hash)" == "{{sky_wheel_hash}}" ]) || (pip3 uninstall skypilot -y; pip3 install "$(echo {{sky_remote_path}}/{{sky_wheel_hash}}/skypilot-{{sky_version}}*.whl)[aws, remote]" && echo "{{sky_wheel_hash}}" > {{sky_remote_path}}/current_sky_wheel_hash || exit 1);
+    {{ ray_skypilot_installation_commands }}
     sudo bash -c 'rm -rf /etc/security/limits.d; echo "* soft nofile 1048576" >> /etc/security/limits.conf; echo "* hard nofile 1048576" >> /etc/security/limits.conf';
     sudo grep -e '^DefaultTasksMax' /etc/systemd/system.conf || (sudo bash -c 'echo "DefaultTasksMax=infinity" >> /etc/systemd/system.conf'); sudo systemctl set-property user-$(id -u $(whoami)).slice TasksMax=infinity; sudo systemctl daemon-reload;
     mkdir -p ~/.ssh; (grep -Pzo -q "Host \*\n  StrictHostKeyChecking no" ~/.ssh/config) || printf "Host *\n  StrictHostKeyChecking no\n" >> ~/.ssh/config;
-    python3 -c "from sky.skylet.ray_patches import patch; patch()" || exit 1;
     [ -f /etc/fuse.conf ] && sudo sed -i 's/#user_allow_other/user_allow_other/g' /etc/fuse.conf || (sudo sh -c 'echo "user_allow_other" > /etc/fuse.conf');
-
```

### Comparing `skypilot-0.5.0/sky/templates/gcp-ray.yml.j2` & `skypilot-0.6.0/sky/templates/gcp-ray.yml.j2`

 * *Files 6% similar despite different names*

```diff
@@ -72,16 +72,16 @@
 
 available_node_types:
   ray_head_default:
     resources: {}
     node_config:
       labels:
         skypilot-user: {{ user }}
-      {%- for tag_key, tag_value in instance_tags.items() %}
-        {{ tag_key }}: {{ tag_value }}
+      {%- for label_key, label_value in labels.items() %}
+        {{ label_key }}: {{ label_value|tojson }}
       {%- endfor %}
       {%- if specific_reservations %}
       reservationAffinity:
         consumeReservationType: SPECIFIC_RESERVATION
         key: compute.googleapis.com/reservation-name
         values: {{ specific_reservations }}
       {%- endif %}
@@ -184,32 +184,27 @@
     sudo kill -9 `echo "$p" | tail -n 1` || true;
     sudo rm /var/lib/dpkg/lock-frontend;
     sudo pkill -9 dpkg;
     sudo pkill -9 apt-get;
     sudo dpkg --configure --force-overwrite -a;
     mkdir -p ~/.ssh; touch ~/.ssh/config;
     {{ conda_installation_commands }}
-    (type -a python | grep -q python3) || echo 'alias python=python3' >> ~/.bashrc;
-    (type -a pip | grep -q pip3) || echo 'alias pip=pip3' >> ~/.bashrc;
     source ~/.bashrc;
   {%- if tpu_vm %}
     test -f ~/miniconda3/etc/profile.d/conda.sh && source ~/miniconda3/etc/profile.d/conda.sh && conda activate base || true;
-    pip3 install --upgrade google-api-python-client;
+    {{ sky_pip_cmd }} install --upgrade google-api-python-client;
   {%- endif %}
   {%- if tpu_node_name %}
     grep "export TPU_NAME=" ~/.bashrc && echo "TPU_NAME already set" || echo "export TPU_NAME={{tpu_node_name}}" >> ~/.bashrc;
   {%- endif %}
-    mkdir -p ~/sky_workdir && mkdir -p ~/.sky/sky_app;
-    pip3 list | grep "ray " | grep {{ray_version}} 2>&1 > /dev/null || pip3 install --exists-action w -U ray[default]=={{ray_version}};
-    (pip3 list | grep "skypilot " && [ "$(cat {{sky_remote_path}}/current_sky_wheel_hash)" == "{{sky_wheel_hash}}" ]) || (pip3 uninstall skypilot -y; pip3 install "$(echo {{sky_remote_path}}/{{sky_wheel_hash}}/skypilot-{{sky_version}}*.whl)[gcp, remote]" && echo "{{sky_wheel_hash}}" > {{sky_remote_path}}/current_sky_wheel_hash || exit 1);
+    {{ ray_skypilot_installation_commands }}
     sudo bash -c 'rm -rf /etc/security/limits.d; echo "* soft nofile 1048576" >> /etc/security/limits.conf; echo "* hard nofile 1048576" >> /etc/security/limits.conf';
     {%- if docker_image is none %}
     sudo grep -e '^DefaultTasksMax' /etc/systemd/system.conf || (sudo bash -c 'echo "DefaultTasksMax=infinity" >> /etc/systemd/system.conf'); sudo systemctl set-property user-$(id -u $(whoami)).slice TasksMax=infinity; sudo systemctl daemon-reload;
     sudo systemctl stop jupyter > /dev/null 2>&1 || true;
     sudo systemctl disable jupyter > /dev/null 2>&1 || true;
     {%- endif %}
     mkdir -p ~/.ssh; (grep -Pzo -q "Host \*\n  StrictHostKeyChecking no" ~/.ssh/config) || printf "Host *\n  StrictHostKeyChecking no\n" >> ~/.ssh/config;
-    python3 -c "from sky.skylet.ray_patches import patch; patch()" || exit 1;
     [ -f /etc/fuse.conf ] && sudo sed -i 's/#user_allow_other/user_allow_other/g' /etc/fuse.conf || (sudo sh -c 'echo "user_allow_other" > /etc/fuse.conf');
 
 # Command to start ray clusters are now placed in `sky.provision.instance_setup`.
 # We do not need to list it here anymore.
```

### Comparing `skypilot-0.5.0/sky/templates/ibm-ray.yml.j2` & `skypilot-0.6.0/sky/templates/ibm-ray.yml.j2`

 * *Files 10% similar despite different names*

```diff
@@ -96,45 +96,39 @@
     sudo sed -i 's/Unattended-Upgrade "1"/Unattended-Upgrade "0"/g' /etc/apt/apt.conf.d/20auto-upgrades || true;
     sudo kill -9 `sudo lsof /var/lib/dpkg/lock-frontend | awk '{print $2}' | tail -n 1` || true;
     sudo pkill -9 apt-get;
     sudo pkill -9 dpkg;
     sudo dpkg --configure -a;
     mkdir -p ~/.ssh; touch ~/.ssh/config;
     {{ conda_installation_commands }}
-    (type -a python | grep -q python3) || echo 'alias python=python3' >> ~/.bashrc;
-    (type -a pip | grep -q pip3) || echo 'alias pip=pip3' >> ~/.bashrc;
-    source ~/.bashrc;
-    mkdir -p ~/sky_workdir && mkdir -p ~/.sky/sky_app;
-    (pip3 list | grep ray | grep {{ray_version}} 2>&1 > /dev/null || pip3 install -U ray[default]=={{ray_version}});
-    (pip3 list | grep skypilot && [ "$(cat {{sky_remote_path}}/current_sky_wheel_hash)" == "{{sky_wheel_hash}}" ]) || (pip3 uninstall skypilot -y; pip3 install "$(echo {{sky_remote_path}}/{{sky_wheel_hash}}/skypilot-{{sky_version}}*.whl)[ibm, remote]" && echo "{{sky_wheel_hash}}" > {{sky_remote_path}}/current_sky_wheel_hash || exit 1);
+    {{ ray_skypilot_installation_commands }}
     sudo bash -c 'rm -rf /etc/security/limits.d; echo "* soft nofile 1048576" >> /etc/security/limits.conf; echo "* hard nofile 1048576" >> /etc/security/limits.conf';
     sudo grep -e '^DefaultTasksMax' /etc/systemd/system.conf || (sudo bash -c 'echo "DefaultTasksMax=infinity" >> /etc/systemd/system.conf'); sudo systemctl set-property user-$(id -u $(whoami)).slice TasksMax=infinity; sudo systemctl daemon-reload;
     mkdir -p ~/.ssh; (grep -Pzo -q "Host \*\n  StrictHostKeyChecking no" ~/.ssh/config) || printf "Host *\n  StrictHostKeyChecking no\n" >> ~/.ssh/config;
-    python3 -c "from sky.skylet.ray_patches import patch; patch()" || exit 1;
     [ -f /etc/fuse.conf ] && sudo sed -i 's/#user_allow_other/user_allow_other/g' /etc/fuse.conf || (sudo sh -c 'echo "user_allow_other" > /etc/fuse.conf'); # This is needed for `-o allow_other` option for `goofys`;
 
 
 # Command to start ray on the head node. You don't need to change this.
 # NOTE: these are very performance-sensitive. Each new item opens/closes an SSH
 # connection, which is expensive. Try your best to co-locate commands into fewer
 # items! The same comment applies for worker_start_ray_commands.
 #
 # Increment the following for catching performance bugs easier:
 #   current num items (num SSH connections): 1
 head_start_ray_commands:
   # NOTE: --disable-usage-stats in `ray start` saves 10 seconds of idle wait.
   # Line "which prlimit ..": increase the limit of the number of open files for the raylet process, as the `ulimit` may not take effect at this point, because it requires
   # all the sessions to be reloaded. This is a workaround.
-  - ray stop; RAY_SCHEDULER_EVENTS=0 RAY_DEDUP_LOGS=0 ray start --disable-usage-stats --head --port={{ray_port}} --dashboard-port={{ray_dashboard_port}} --object-manager-port=8076 --autoscaling-config=~/ray_bootstrap_config.yaml {{"--resources='%s'" % custom_resources if custom_resources}} --temp-dir {{ray_temp_dir}} || exit 1;
+  - {{ sky_activate_python_env }}; {{ sky_ray_cmd }} stop; RAY_SCHEDULER_EVENTS=0 RAY_DEDUP_LOGS=0 {{ sky_ray_cmd }} start --disable-usage-stats --head --port={{ray_port}} --dashboard-port={{ray_dashboard_port}} --object-manager-port=8076 --autoscaling-config=~/ray_bootstrap_config.yaml {{"--resources='%s'" % custom_resources if custom_resources}} --temp-dir {{ray_temp_dir}} || exit 1;
     which prlimit && for id in $(pgrep -f raylet/raylet); do sudo prlimit --nofile=1048576:1048576 --pid=$id || true; done;
     {{dump_port_command}}; {{ray_head_wait_initialized_command}}
 
 {%- if num_nodes > 1 %}
 worker_start_ray_commands:
-  - ray stop; RAY_SCHEDULER_EVENTS=0 RAY_DEDUP_LOGS=0 ray start --disable-usage-stats --address=$RAY_HEAD_IP:{{ray_port}} --object-manager-port=8076 {{"--resources='%s'" % custom_resources if custom_resources}} --temp-dir {{ray_temp_dir}} || exit 1;
+  - {{ sky_activate_python_env }}; {{ sky_ray_cmd }} stop; RAY_SCHEDULER_EVENTS=0 RAY_DEDUP_LOGS=0 {{ sky_ray_cmd }} start --disable-usage-stats --address=$RAY_HEAD_IP:{{ray_port}} --object-manager-port=8076 {{"--resources='%s'" % custom_resources if custom_resources}} --temp-dir {{ray_temp_dir}} || exit 1;
     which prlimit && for id in $(pgrep -f raylet/raylet); do sudo prlimit --nofile=1048576:1048576 --pid=$id || true; done;
 {%- else %}
 worker_start_ray_commands: []
 {%- endif %}
 
 head_node: {}
 worker_nodes: {}
```

### Comparing `skypilot-0.5.0/sky/templates/kubernetes-port-forward-proxy-command.sh.j2` & `skypilot-0.6.0/sky/templates/kubernetes-port-forward-proxy-command.sh.j2`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/templates/kubernetes-ssh-jump.yml.j2` & `skypilot-0.6.0/sky/templates/kubernetes-ssh-jump.yml.j2`

 * *Files 2% similar despite different names*

```diff
@@ -61,30 +61,34 @@
 # The following ServiceAccount/Role/RoleBinding sets up an RBAC for life cycle
 # management of the jump pod/service
 service_account:
     apiVersion: v1
     kind: ServiceAccount
     metadata:
         name: sky-ssh-jump-sa
-        parent: skypilot
+        labels:
+          parent: skypilot
 role:
     kind: Role
     apiVersion: rbac.authorization.k8s.io/v1
     metadata:
         name: sky-ssh-jump-role
+        labels:
+          parent: skypilot
     rules:
       - apiGroups: [""]
         resources: ["pods", "pods/status", "pods/exec", "services"]
         verbs: ["get", "list", "create", "delete"]
 role_binding:
     apiVersion: rbac.authorization.k8s.io/v1
     kind: RoleBinding
     metadata:
         name: sky-ssh-jump-rb
-        parent: skypilot
+        labels:
+          parent: skypilot
     subjects:
     - kind: ServiceAccount
       name: sky-ssh-jump-sa
     roleRef:
         kind: Role
         name: sky-ssh-jump-role
         apiGroup: rbac.authorization.k8s.io
```

### Comparing `skypilot-0.5.0/sky/templates/lambda-ray.yml.j2` & `skypilot-0.6.0/sky/templates/lambda-ray.yml.j2`

 * *Files 13% similar despite different names*

```diff
@@ -70,41 +70,36 @@
     sudo kill -9 `sudo lsof /var/lib/dpkg/lock-frontend | awk '{print $2}' | tail -n 1` || true;
     sudo pkill -9 apt-get;
     sudo pkill -9 dpkg;
     sudo dpkg --configure -a;
     mkdir -p ~/.ssh; touch ~/.ssh/config;
     rm ~/.local/bin/pip ~/.local/bin/pip3 ~/.local/bin/pip3.8 ~/.local/bin/pip3.10;
     {{ conda_installation_commands }}
-    (type -a python | grep -q python3) || echo 'alias python=python3' >> ~/.bashrc;
-    (type -a pip | grep -q pip3) || echo 'alias pip=pip3' >> ~/.bashrc;
-    source ~/.bashrc;
-    mkdir -p ~/sky_workdir && mkdir -p ~/.sky/sky_app && touch ~/.sudo_as_admin_successful;
-    (pip3 list | grep "ray " | grep {{ray_version}} 2>&1 > /dev/null || pip3 install --exists-action w -U ray[default]=={{ray_version}});
-    (pip3 list | grep "skypilot " && [ "$(cat {{sky_remote_path}}/current_sky_wheel_hash)" == "{{sky_wheel_hash}}" ]) || (pip3 uninstall skypilot -y; pip3 install "$(echo {{sky_remote_path}}/{{sky_wheel_hash}}/skypilot-{{sky_version}}*.whl)[lambda, remote]" && echo "{{sky_wheel_hash}}" > {{sky_remote_path}}/current_sky_wheel_hash || exit 1);
+    {{ ray_skypilot_installation_commands }}
+    touch ~/.sudo_as_admin_successful;
     sudo bash -c 'rm -rf /etc/security/limits.d; echo "* soft nofile 1048576" >> /etc/security/limits.conf; echo "* hard nofile 1048576" >> /etc/security/limits.conf';
     sudo grep -e '^DefaultTasksMax' /etc/systemd/system.conf || (sudo bash -c 'echo "DefaultTasksMax=infinity" >> /etc/systemd/system.conf'); sudo systemctl set-property user-$(id -u $(whoami)).slice TasksMax=infinity; sudo systemctl daemon-reload;
     mkdir -p ~/.ssh; (grep -Pzo -q "Host \*\n  StrictHostKeyChecking no" ~/.ssh/config) || printf "Host *\n  StrictHostKeyChecking no\n" >> ~/.ssh/config;
-    python3 -c "from sky.skylet.ray_patches import patch; patch()" || exit 1;
     [ -f /etc/fuse.conf ] && sudo sed -i 's/#user_allow_other/user_allow_other/g' /etc/fuse.conf || (sudo sh -c 'echo "user_allow_other" > /etc/fuse.conf');
 
 # Command to start ray on the head node. You don't need to change this.
 # NOTE: these are very performance-sensitive. Each new item opens/closes an SSH
 # connection, which is expensive. Try your best to co-locate commands into fewer
 # items! The same comment applies for worker_start_ray_commands.
 #
 # Increment the following for catching performance bugs easier:
 #   current num items (num SSH connections): 2
 head_start_ray_commands:
-  - ray stop; RAY_SCHEDULER_EVENTS=0 RAY_DEDUP_LOGS=0 ray start --disable-usage-stats --head --port={{ray_port}} --dashboard-port={{ray_dashboard_port}} --object-manager-port=8076 --autoscaling-config=~/ray_bootstrap_config.yaml {{"--resources='%s'" % custom_resources if custom_resources}} --temp-dir {{ray_temp_dir}} || exit 1;
+  - {{ sky_activate_python_env }}; {{ sky_ray_cmd }} stop; RAY_SCHEDULER_EVENTS=0 RAY_DEDUP_LOGS=0 {{ sky_ray_cmd }} start --disable-usage-stats --head --port={{ray_port}} --dashboard-port={{ray_dashboard_port}} --object-manager-port=8076 --autoscaling-config=~/ray_bootstrap_config.yaml {{"--resources='%s'" % custom_resources if custom_resources}} --temp-dir {{ray_temp_dir}} || exit 1;
     which prlimit && for id in $(pgrep -f raylet/raylet); do sudo prlimit --nofile=1048576:1048576 --pid=$id || true; done;
     {{dump_port_command}}; {{ray_head_wait_initialized_command}}
 
 {%- if num_nodes > 1 %}
 worker_start_ray_commands:
-  - ray stop; RAY_SCHEDULER_EVENTS=0 RAY_DEDUP_LOGS=0 ray start --disable-usage-stats --address=$RAY_HEAD_IP:{{ray_port}} --object-manager-port=8076 {{"--resources='%s'" % custom_resources if custom_resources}} --temp-dir {{ray_temp_dir}} || exit 1;
+  - {{ sky_activate_python_env }}; {{ sky_ray_cmd }} stop; RAY_SCHEDULER_EVENTS=0 RAY_DEDUP_LOGS=0 {{ sky_ray_cmd }} start --disable-usage-stats --address=$RAY_HEAD_IP:{{ray_port}} --object-manager-port=8076 {{"--resources='%s'" % custom_resources if custom_resources}} --temp-dir {{ray_temp_dir}} || exit 1;
     which prlimit && for id in $(pgrep -f raylet/raylet); do sudo prlimit --nofile=1048576:1048576 --pid=$id || true; done;
 {%- else %}
 worker_start_ray_commands: []
 {%- endif %}
 
 head_node: {}
 worker_nodes: {}
```

### Comparing `skypilot-0.5.0/sky/templates/local-ray.yml.j2` & `skypilot-0.6.0/sky/templates/local-ray.yml.j2`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/templates/oci-ray.yml.j2` & `skypilot-0.6.0/sky/templates/oci-ray.yml.j2`

 * *Files 7% similar despite different names*

```diff
@@ -91,45 +91,40 @@
     sudo kill -9 `sudo lsof /var/lib/dpkg/lock-frontend | awk '{print $2}' | tail -n 1` || true;
     sudo pkill -9 apt-get;
     sudo pkill -9 dpkg;
     sudo dpkg --configure -a;
     ([ `sudo lshw -class display | grep "NVIDIA Corporation" | wc -l` -gt 0 ]) && (sudo which nvidia-smi > /dev/null || ( sudo apt-get install nvidia-driver-530-open -y && sudo apt-get install nvidia-driver-525-server -y ) || true);
     mkdir -p ~/.ssh; touch ~/.ssh/config;
     {{ conda_installation_commands }}
-    (type -a python | grep -q python3) || echo 'alias python=python3' >> ~/.bashrc;
-    (type -a pip | grep -q pip3) || echo 'alias pip=pip3' >> ~/.bashrc;
-    source ~/.bashrc;
-    mkdir -p ~/sky_workdir && mkdir -p ~/.sky/sky_app && touch ~/.sudo_as_admin_successful;
-    (pip3 list | grep ray | grep {{ray_version}} 2>&1 > /dev/null || pip3 install -U ray[default]=={{ray_version}});
-    (pip3 list | grep skypilot && [ "$(cat {{sky_remote_path}}/current_sky_wheel_hash)" == "{{sky_wheel_hash}}" ]) || (pip3 uninstall skypilot -y; pip3 install "$(echo {{sky_remote_path}}/{{sky_wheel_hash}}/skypilot-{{sky_version}}*.whl)[oci, remote]" && echo "{{sky_wheel_hash}}" > {{sky_remote_path}}/current_sky_wheel_hash || exit 1);
+    {{ ray_skypilot_installation_commands }}
+    touch ~/.sudo_as_admin_successful;
     sudo bash -c 'rm -rf /etc/security/limits.d; echo "* soft nofile 1048576" >> /etc/security/limits.conf; echo "* hard nofile 1048576" >> /etc/security/limits.conf';
     sudo grep -e '^DefaultTasksMax' /etc/systemd/system.conf || (sudo bash -c 'echo "DefaultTasksMax=infinity" >> /etc/systemd/system.conf'); sudo systemctl set-property user-$(id -u $(whoami)).slice TasksMax=infinity; sudo systemctl daemon-reload;
     mkdir -p ~/.ssh; (grep -Pzo -q "Host \*\n  StrictHostKeyChecking no" ~/.ssh/config) || printf "Host *\n  StrictHostKeyChecking no\n" >> ~/.ssh/config;
-    python3 -c "from sky.skylet.ray_patches import patch; patch()" || exit 1;
     [ -f /etc/fuse.conf ] && sudo sed -i 's/#user_allow_other/user_allow_other/g' /etc/fuse.conf || (sudo sh -c 'echo "user_allow_other" > /etc/fuse.conf');
     sudo iptables -I INPUT -i ens3 -m state --state ESTABLISHED,RELATED,NEW -j ACCEPT;
 
 # Command to start ray on the head node. You don't need to change this.
 # NOTE: these are very performance-sensitive. Each new item opens/closes an SSH
 # connection, which is expensive. Try your best to co-locate commands into fewer
 # items! The same comment applies for worker_start_ray_commands.
 #
 # Increment the following for catching performance bugs easier:
 #   current num items (num SSH connections): 2
 head_start_ray_commands:
   # NOTE: --disable-usage-stats in `ray start` saves 10 seconds of idle wait.
   # Line "which prlimit ..": increase the limit of the number of open files for the raylet process, as the `ulimit` may not take effect at this point, because it requires
   # all the sessions to be reloaded. This is a workaround.
-  - ray stop; RAY_SCHEDULER_EVENTS=0 RAY_DEDUP_LOGS=0 ray start --disable-usage-stats --head --port={{ray_port}} --dashboard-port={{ray_dashboard_port}} --object-manager-port=8076 --autoscaling-config=~/ray_bootstrap_config.yaml {{"--resources='%s'" % custom_resources if custom_resources}} --temp-dir {{ray_temp_dir}} || exit 1;
+  - {{ sky_activate_python_env }}; {{ sky_ray_cmd }} stop; RAY_SCHEDULER_EVENTS=0 RAY_DEDUP_LOGS=0 {{ sky_ray_cmd }} start --disable-usage-stats --head --port={{ray_port}} --dashboard-port={{ray_dashboard_port}} --object-manager-port=8076 --autoscaling-config=~/ray_bootstrap_config.yaml {{"--resources='%s'" % custom_resources if custom_resources}} --temp-dir {{ray_temp_dir}} || exit 1;
     which prlimit && for id in $(pgrep -f raylet/raylet); do sudo prlimit --nofile=1048576:1048576 --pid=$id || true; done;
     {{dump_port_command}}; {{ray_head_wait_initialized_command}}
 
 {%- if num_nodes > 1 %}
 worker_start_ray_commands:
-  - ray stop; RAY_SCHEDULER_EVENTS=0 RAY_DEDUP_LOGS=0 ray start --disable-usage-stats --address=$RAY_HEAD_IP:{{ray_port}} --object-manager-port=8076 {{"--resources='%s'" % custom_resources if custom_resources}} --temp-dir {{ray_temp_dir}} || exit 1;
+  - {{ sky_activate_python_env }}; {{ sky_ray_cmd }} stop; RAY_SCHEDULER_EVENTS=0 RAY_DEDUP_LOGS=0 {{ sky_ray_cmd }} start --disable-usage-stats --address=$RAY_HEAD_IP:{{ray_port}} --object-manager-port=8076 {{"--resources='%s'" % custom_resources if custom_resources}} --temp-dir {{ray_temp_dir}} || exit 1;
     which prlimit && for id in $(pgrep -f raylet/raylet); do sudo prlimit --nofile=1048576:1048576 --pid=$id || true; done;
 {%- else %}
 worker_start_ray_commands: []
 {%- endif %}
 
 head_node: {}
 worker_nodes: {}
```

### Comparing `skypilot-0.5.0/sky/templates/runpod-ray.yml.j2` & `skypilot-0.6.0/sky/templates/fluidstack-ray.yml.j2`

 * *Files 21% similar despite different names*

```diff
@@ -3,28 +3,31 @@
 # The maximum number of workers nodes to launch in addition to the head node.
 max_workers: {{num_nodes - 1}}
 upscaling_speed: {{num_nodes - 1}}
 idle_timeout_minutes: 60
 
 provider:
   type: external
-  module: sky.provision.runpod
-  region: "{{region}}"
+  module: sky.provision.fluidstack
+  region: {{region}}
   disable_launch_config_check: true
 
+
 auth:
-  ssh_user: root
+  ssh_user: {{fluidstack_username}}
   ssh_private_key: {{ssh_private_key}}
 
 available_node_types:
   ray_head_default:
     resources: {}
     node_config:
       InstanceType: {{instance_type}}
-      DiskSize: {{disk_size}}
+      AuthorizedKey: |
+        skypilot:ssh_public_key_content
+
 
 head_node_type: ray_head_default
 
 # Format: `REMOTE_PATH : LOCAL_PATH`
 file_mounts: {
   "{{sky_ray_yaml_remote_path}}": "{{sky_ray_yaml_local_path}}",
   "{{sky_remote_path}}/{{sky_wheel_hash}}": "{{sky_local_path}}",
@@ -55,22 +58,17 @@
   - sudo systemctl stop unattended-upgrades || true;
     sudo systemctl disable unattended-upgrades || true;
     sudo sed -i 's/Unattended-Upgrade "1"/Unattended-Upgrade "0"/g' /etc/apt/apt.conf.d/20auto-upgrades || true;
     sudo kill -9 `sudo lsof /var/lib/dpkg/lock-frontend | awk '{print $2}' | tail -n 1` || true;
     sudo pkill -9 apt-get;
     sudo pkill -9 dpkg;
     sudo dpkg --configure -a;
+    {{ cuda_installation_commands }}
     mkdir -p ~/.ssh; touch ~/.ssh/config;
     {{ conda_installation_commands }}
-    (type -a python | grep -q python3) || echo 'alias python=python3' >> ~/.bashrc;
-    (type -a pip | grep -q pip3) || echo 'alias pip=pip3' >> ~/.bashrc;
-    source ~/.bashrc;
-    (pip3 list | grep ray | grep {{ray_version}} 2>&1 > /dev/null || pip3 install -U ray[default]=={{ray_version}}) && mkdir -p ~/sky_workdir && mkdir -p ~/.sky/sky_app && touch ~/.sudo_as_admin_successful;
-    (pip3 list | grep skypilot && [ "$(cat {{sky_remote_path}}/current_sky_wheel_hash)" == "{{sky_wheel_hash}}" ]) || (pip3 uninstall skypilot -y; pip3 install "$(echo {{sky_remote_path}}/{{sky_wheel_hash}}/skypilot-{{sky_version}}*.whl)[runpod,remote]" && echo "{{sky_wheel_hash}}" > {{sky_remote_path}}/current_sky_wheel_hash || exit 1);
+    {{ ray_skypilot_installation_commands }}
+    touch ~/.sudo_as_admin_successful;
     sudo bash -c 'rm -rf /etc/security/limits.d; echo "* soft nofile 1048576" >> /etc/security/limits.conf; echo "* hard nofile 1048576" >> /etc/security/limits.conf';
     sudo grep -e '^DefaultTasksMax' /etc/systemd/system.conf || (sudo bash -c 'echo "DefaultTasksMax=infinity" >> /etc/systemd/system.conf'); sudo systemctl set-property user-$(id -u $(whoami)).slice TasksMax=infinity; sudo systemctl daemon-reload;
     mkdir -p ~/.ssh; (grep -Pzo -q "Host \*\n  StrictHostKeyChecking no" ~/.ssh/config) || printf "Host *\n  StrictHostKeyChecking no\n" >> ~/.ssh/config;
-    python3 -c "from sky.skylet.ray_patches import patch; patch()" || exit 1;
     [ -f /etc/fuse.conf ] && sudo sed -i 's/#user_allow_other/user_allow_other/g' /etc/fuse.conf || (sudo sh -c 'echo "user_allow_other" > /etc/fuse.conf');
 
-# Command to start ray clusters are now placed in `sky.provision.instance_setup`.
-# We do not need to list it here anymore.
```

### Comparing `skypilot-0.5.0/sky/templates/scp-ray.yml.j2` & `skypilot-0.6.0/sky/templates/scp-ray.yml.j2`

 * *Files 11% similar despite different names*

```diff
@@ -67,44 +67,38 @@
   # This also kills the service that is holding the lock on dpkg (problem only exists on aws/azure, not gcp)
   # Line 'sudo bash ..': set the ulimit as suggested by ray docs for performance. https://docs.ray.io/en/latest/cluster/vms/user-guides/large-cluster-best-practices.html#system-configuration
   # Line 'sudo grep ..': set the number of threads per process to unlimited to avoid ray job submit stucking issue when the number of running ray jobs increase.
   # Line 'mkdir -p ..': disable host key check
   # Line 'python3 -c ..': patch the buggy ray files and enable `-o allow_other` option for `goofys`
   - mkdir -p ~/.ssh; touch ~/.ssh/config;
     {{ conda_installation_commands }}
-    (type -a python | grep -q python3) || echo 'alias python=python3' >> ~/.bashrc;
-    (type -a pip | grep -q pip3) || echo 'alias pip=pip3' >> ~/.bashrc;
-    source ~/.bashrc;
-    mkdir -p ~/sky_workdir && mkdir -p ~/.sky/sky_app;
-    (pip3 list | grep "ray " | grep {{ray_version}} 2>&1 > /dev/null || pip3 install --exists-action w -U ray[default]=={{ray_version}});
-    (pip3 list | grep "skypilot " && [ "$(cat {{sky_remote_path}}/current_sky_wheel_hash)" == "{{sky_wheel_hash}}" ]) || (pip3 uninstall skypilot -y; pip3 install "$(echo {{sky_remote_path}}/{{sky_wheel_hash}}/skypilot-{{sky_version}}*.whl)[scp, remote]" && echo "{{sky_wheel_hash}}" > {{sky_remote_path}}/current_sky_wheel_hash || exit 1);
+    {{ ray_skypilot_installation_commands }}
     sudo bash -c 'rm -rf /etc/security/limits.d; echo "* soft nofile 1048576" >> /etc/security/limits.conf; echo "* hard nofile 1048576" >> /etc/security/limits.conf';
     sudo grep -e '^DefaultTasksMax' /etc/systemd/system.conf || (sudo bash -c 'echo "DefaultTasksMax=infinity" >> /etc/systemd/system.conf'); sudo systemctl set-property user-$(id -u $(whoami)).slice TasksMax=infinity; sudo systemctl daemon-reload;
     mkdir -p ~/.ssh; (grep -Pzo -q "Host \*\n  StrictHostKeyChecking no" ~/.ssh/config) || printf "Host *\n  StrictHostKeyChecking no\n" >> ~/.ssh/config;
-    python3 -c "from sky.skylet.ray_patches import patch; patch()" || exit 1;
     [ -f /etc/fuse.conf ] && sudo sed -i 's/#user_allow_other/user_allow_other/g' /etc/fuse.conf || (sudo sh -c 'echo "user_allow_other" > /etc/fuse.conf'); # This is needed for `-o allow_other` option for `goofys`;
 
 # Command to start ray on the head node. You don't need to change this.
 # NOTE: these are very performance-sensitive. Each new item opens/closes an SSH
 # connection, which is expensive. Try your best to co-locate commands into fewer
 # items! The same comment applies for worker_start_ray_commands.
 #
 # Increment the following for catching performance bugs easier:
 #   current num items (num SSH connections): 1
 head_start_ray_commands:
   # NOTE: --disable-usage-stats in `ray start` saves 10 seconds of idle wait.
   # Line "which prlimit ..": increase the limit of the number of open files for the raylet process, as the `ulimit` may not take effect at this point, because it requires
   # all the sessions to be reloaded. This is a workaround.
-  - ray stop; RAY_SCHEDULER_EVENTS=0 RAY_DEDUP_LOGS=0 ray start --disable-usage-stats --head --port={{ray_port}} --dashboard-port={{ray_dashboard_port}} --object-manager-port=8076 --autoscaling-config=~/ray_bootstrap_config.yaml {{"--resources='%s'" % custom_resources if custom_resources}} --temp-dir {{ray_temp_dir}} || exit 1;
+  - {{ sky_activate_python_env }}; {{ sky_ray_cmd }} stop; RAY_SCHEDULER_EVENTS=0 RAY_DEDUP_LOGS=0 {{ sky_ray_cmd }} start --disable-usage-stats --head --port={{ray_port}} --dashboard-port={{ray_dashboard_port}} --object-manager-port=8076 --autoscaling-config=~/ray_bootstrap_config.yaml {{"--resources='%s'" % custom_resources if custom_resources}} --temp-dir {{ray_temp_dir}} || exit 1;
     which prlimit && for id in $(pgrep -f raylet/raylet); do sudo prlimit --nofile=1048576:1048576 --pid=$id || true; done;
     {{dump_port_command}}; {{ray_head_wait_initialized_command}}
 
 {%- if num_nodes > 1 %}
 worker_start_ray_commands:
-  - ray stop; RAY_SCHEDULER_EVENTS=0 RAY_DEDUP_LOGS=0 ray start --disable-usage-stats --address=$RAY_HEAD_IP:{{ray_port}} --object-manager-port=8076 {{"--resources='%s'" % custom_resources if custom_resources}} --temp-dir {{ray_temp_dir}} || exit 1;
+  - {{ sky_activate_python_env }}; {{ sky_ray_cmd }} stop; RAY_SCHEDULER_EVENTS=0 RAY_DEDUP_LOGS=0 {{ sky_ray_cmd }} start --disable-usage-stats --address=$RAY_HEAD_IP:{{ray_port}} --object-manager-port=8076 {{"--resources='%s'" % custom_resources if custom_resources}} --temp-dir {{ray_temp_dir}} || exit 1;
     which prlimit && for id in $(pgrep -f raylet/raylet); do sudo prlimit --nofile=1048576:1048576 --pid=$id || true; done;
 {%- else %}
 worker_start_ray_commands: []
 {%- endif %}
 
 head_node: {}
 worker_nodes: {}
```

### Comparing `skypilot-0.5.0/sky/templates/vsphere-ray.yml.j2` & `skypilot-0.6.0/sky/templates/vsphere-ray.yml.j2`

 * *Files 25% similar despite different names*

```diff
@@ -57,17 +57,12 @@
     sudo kill -9 `sudo lsof /var/lib/dpkg/lock-frontend | awk '{print $2}' | tail -n 1` || true;
     sudo pkill -9 apt-get;
     sudo pkill -9 dpkg;
     sudo dpkg --configure -a;
     mkdir -p ~/.ssh; touch ~/.ssh/config;
     pip3 --version > /dev/null 2>&1 || (curl -sSL https://bootstrap.pypa.io/get-pip.py -o get-pip.py && python3 get-pip.py && echo "PATH=$HOME/.local/bin:$PATH" >> ~/.bashrc);
     {{ conda_installation_commands }}
-    (type -a python | grep -q python3) || echo 'alias python=python3' >> ~/.bashrc;
-    (type -a pip | grep -q pip3) || echo 'alias pip=pip3' >> ~/.bashrc;
-    source ~/.bashrc;
-    (pip3 list | grep ray | grep {{ray_version}} 2>&1 > /dev/null || pip3 install -U ray[default]=={{ray_version}}) && mkdir -p ~/sky_workdir && mkdir -p ~/.sky/sky_app && touch ~/.sudo_as_admin_successful;
-    (pip3 list | grep skypilot && [ "$(cat {{sky_remote_path}}/current_sky_wheel_hash)" == "{{sky_wheel_hash}}" ]) || (pip3 uninstall skypilot -y; pip3 install "$(echo {{sky_remote_path}}/{{sky_wheel_hash}}/skypilot-{{sky_version}}*.whl)[vsphere, remote]" && echo "{{sky_wheel_hash}}" > {{sky_remote_path}}/current_sky_wheel_hash || exit 1);
+    {{ ray_skypilot_installation_commands }}
     sudo bash -c 'rm -rf /etc/security/limits.d; echo "* soft nofile 1048576" >> /etc/security/limits.conf; echo "* hard nofile 1048576" >> /etc/security/limits.conf';
     sudo grep -e '^DefaultTasksMax' /etc/systemd/system.conf || (sudo bash -c 'echo "DefaultTasksMax=infinity" >> /etc/systemd/system.conf'); sudo systemctl set-property user-$(id -u $(whoami)).slice TasksMax=infinity; sudo systemctl daemon-reload;
     mkdir -p ~/.ssh; (grep -Pzo -q "Host \*\n  StrictHostKeyChecking no" ~/.ssh/config) || printf "Host *\n  StrictHostKeyChecking no\n" >> ~/.ssh/config;
-    python3 -c "from sky.skylet.ray_patches import patch; patch()" || exit 1;
     [ -f /etc/fuse.conf ] && sudo sed -i 's/#user_allow_other/user_allow_other/g' /etc/fuse.conf || (sudo sh -c 'echo "user_allow_other" > /etc/fuse.conf');
```

### Comparing `skypilot-0.5.0/sky/usage/constants.py` & `skypilot-0.6.0/sky/usage/constants.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/usage/usage_lib.py` & `skypilot-0.6.0/sky/usage/usage_lib.py`

 * *Files 2% similar despite different names*

```diff
@@ -186,14 +186,17 @@
                 # Not None and not empty.
                 if len(resources.accelerators) > 1:
                     logger.debug('Multiple accelerators are not supported: '
                                  f'{resources.accelerators}.')
                 self.task_accelerators = list(resources.accelerators.keys())[0]
                 self.task_num_accelerators = resources.accelerators[
                     self.task_accelerators]
+            else:
+                self.task_accelerators = None
+                self.task_num_accelerators = None
 
     def update_task_id(self, task_id: int):
         self.task_id = task_id
 
     def update_ray_yaml(self, yaml_config_or_path: Union[Dict, str]):
         if self.ray_yamls is None:
             self.ray_yamls = []
@@ -220,14 +223,17 @@
         if resources.accelerators:
             # Not None and not empty.
             if len(resources.accelerators) > 1:
                 logger.debug('Multiple accelerators are not supported: '
                              f'{resources.accelerators}.')
             self.accelerators = list(resources.accelerators.keys())[0]
             self.num_accelerators = resources.accelerators[self.accelerators]
+        else:
+            self.accelerators = None
+            self.num_accelerators = None
 
         self.num_nodes = num_nodes
         self.resources = resources.to_yaml_config()
 
     def update_local_cluster_resources(
             self, local_resources: List['resources_lib.Resources']):
         self.local_resources = [r.to_yaml_config() for r in local_resources]
```

### Comparing `skypilot-0.5.0/sky/utils/accelerator_registry.py` & `skypilot-0.6.0/sky/utils/accelerator_registry.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/utils/cli_utils/status_utils.py` & `skypilot-0.6.0/sky/utils/cli_utils/status_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/utils/cluster_yaml_utils.py` & `skypilot-0.6.0/sky/utils/cluster_yaml_utils.py`

 * *Files 18% similar despite different names*

```diff
@@ -14,8 +14,11 @@
     # Examples:
     #   'sky.skylet.providers.aws.AWSNodeProviderV2' -> 'aws'
     #   'sky.provision.aws' -> 'aws'
     provider_search = re.search(r'(?:providers|provision)\.(\w+)\.?',
                                 provider_module)
     assert provider_search is not None, config
     provider_name = provider_search.group(1).lower()
+    # Special handling for lambda_cloud as Lambda cloud is registered as lambda.
+    if provider_name == 'lambda_cloud':
+        provider_name = 'lambda'
     return provider_name
```

### Comparing `skypilot-0.5.0/sky/utils/command_runner.py` & `skypilot-0.6.0/sky/utils/command_runner.py`

 * *Files 14% similar despite different names*

```diff
@@ -1,21 +1,22 @@
 """Runner for commands to be executed on the cluster."""
 import enum
 import hashlib
 import os
 import pathlib
 import shlex
 import time
-from typing import List, Optional, Tuple, Union
+from typing import Any, Iterable, List, Optional, Tuple, Type, Union
 
 from sky import sky_logging
 from sky.skylet import constants
 from sky.skylet import log_lib
 from sky.utils import common_utils
 from sky.utils import subprocess_utils
+from sky.utils import timeline
 
 logger = sky_logging.init_logger(__name__)
 
 # The git exclude file to support.
 GIT_EXCLUDE = '.git/info/exclude'
 # Rsync options
 RSYNC_DISPLAY_OPTION = '-Pavz'
@@ -37,49 +38,61 @@
         return None
     user_hash = common_utils.get_user_hash()
     path = f'/tmp/skypilot_ssh_{user_hash}/{ssh_control_filename}'
     os.makedirs(path, exist_ok=True)
     return path
 
 
+# Disable sudo for root user. This is useful when the command is running in a
+# docker container, i.e. image_id is a docker image.
+ALIAS_SUDO_TO_EMPTY_FOR_ROOT_CMD = (
+    '{ [ "$(whoami)" == "root" ] && function sudo() { "$@"; } || true; }')
+
+
 def ssh_options_list(
     ssh_private_key: Optional[str],
     ssh_control_name: Optional[str],
     *,
     ssh_proxy_command: Optional[str] = None,
     docker_ssh_proxy_command: Optional[str] = None,
-    timeout: int = 30,
+    connect_timeout: Optional[int] = None,
     port: int = 22,
     disable_control_master: Optional[bool] = False,
 ) -> List[str]:
     """Returns a list of sane options for 'ssh'."""
+    if connect_timeout is None:
+        connect_timeout = 30
     # Forked from Ray SSHOptions:
     # https://github.com/ray-project/ray/blob/master/python/ray/autoscaler/_private/command_runner.py
     arg_dict = {
         # SSH port
         'Port': port,
-        # Supresses initial fingerprint verification.
+        # Suppresses initial fingerprint verification.
         'StrictHostKeyChecking': 'no',
         # SSH IP and fingerprint pairs no longer added to known_hosts.
         # This is to remove a 'REMOTE HOST IDENTIFICATION HAS CHANGED'
         # warning if a new node has the same IP as a previously
         # deleted node, because the fingerprints will not match in
         # that case.
         'UserKnownHostsFile': os.devnull,
+        # Suppresses the warning messages, such as:
+        #   Warning: Permanently added '34.69.216.203' (ED25519) to the list of
+        #   known hosts.
+        'LogLevel': 'ERROR',
         # Try fewer extraneous key pairs.
         'IdentitiesOnly': 'yes',
         # Abort if port forwarding fails (instead of just printing to
         # stderr).
         'ExitOnForwardFailure': 'yes',
         # Quickly kill the connection if network connection breaks (as
         # opposed to hanging/blocking).
         'ServerAliveInterval': 5,
         'ServerAliveCountMax': 3,
         # ConnectTimeout.
-        'ConnectTimeout': f'{timeout}s',
+        'ConnectTimeout': f'{connect_timeout}s',
         # Agent forwarding for git.
         'ForwardAgent': 'yes',
     }
     # SSH Control will have a severe delay when using docker_ssh_proxy_command.
     # TODO(tian): Investigate why.
     # We also do not use ControlMaster when we use `kubectl port-forward`
     # to access Kubernetes pods over SSH+Proxycommand. This is because the
@@ -128,37 +141,185 @@
     # Allocate a pseudo-tty, quit the ssh session after the cmd finishes.
     # Be careful of this mode, as ctrl-c will be passed to remote process.
     INTERACTIVE = 1
     # Allocate a pseudo-tty and log into the ssh session.
     LOGIN = 2
 
 
-class SSHCommandRunner:
+class CommandRunner:
+    """Runner for commands to be executed on the cluster."""
+
+    def __init__(self, node: Tuple[Any, Any], **kwargs):
+        del kwargs  # Unused.
+        self.node = node
+
+    @property
+    def node_id(self) -> str:
+        return '-'.join(str(x) for x in self.node)
+
+    def _get_command_to_run(
+        self,
+        cmd: Union[str, List[str]],
+        process_stream: bool,
+        separate_stderr: bool,
+        skip_lines: int,
+        source_bashrc: bool = False,
+    ) -> str:
+        """Returns the command to run."""
+        if isinstance(cmd, list):
+            cmd = ' '.join(cmd)
+
+        # We need this to correctly run the cmd, and get the output.
+        command = [
+            'bash',
+            '--login',
+            '-c',
+        ]
+        if source_bashrc:
+            command += [
+                # Need this `-i` option to make sure `source ~/.bashrc` work.
+                # Sourcing bashrc may take a few seconds causing overheads.
+                '-i',
+                shlex.quote(
+                    f'true && source ~/.bashrc && export OMP_NUM_THREADS=1 '
+                    f'PYTHONWARNINGS=ignore && ({cmd})'),
+            ]
+        else:
+            # Optimization: this reduces the time for connecting to the remote
+            # cluster by 1 second.
+            # sourcing ~/.bashrc is not required for internal executions
+            command += [
+                shlex.quote('true && export OMP_NUM_THREADS=1 '
+                            f'PYTHONWARNINGS=ignore && ({cmd})')
+            ]
+        if not separate_stderr:
+            command.append('2>&1')
+        if not process_stream and skip_lines:
+            command += [
+                # A hack to remove the following bash warnings (twice):
+                #  bash: cannot set terminal process group
+                #  bash: no job control in this shell
+                f'| stdbuf -o0 tail -n +{skip_lines}',
+                # This is required to make sure the executor of command can get
+                # correct returncode, since linux pipe is used.
+                '; exit ${PIPESTATUS[0]}'
+            ]
+
+        command_str = ' '.join(command)
+        return command_str
+
+    @timeline.event
+    def run(
+            self,
+            cmd: Union[str, List[str]],
+            *,
+            require_outputs: bool = False,
+            # Advanced options.
+            log_path: str = os.devnull,
+            # If False, do not redirect stdout/stderr to optimize performance.
+            process_stream: bool = True,
+            stream_logs: bool = True,
+            ssh_mode: SshMode = SshMode.NON_INTERACTIVE,
+            separate_stderr: bool = False,
+            connect_timeout: Optional[int] = None,
+            source_bashrc: bool = False,
+            skip_lines: int = 0,
+            **kwargs) -> Union[int, Tuple[int, str, str]]:
+        """Runs the command on the cluster.
+
+        Args:
+            cmd: The command to run.
+            require_outputs: Whether to return the stdout/stderr of the command.
+            log_path: Redirect stdout/stderr to the log_path.
+            stream_logs: Stream logs to the stdout/stderr.
+            ssh_mode: The mode to use for ssh.
+                See SSHMode for more details.
+            separate_stderr: Whether to separate stderr from stdout.
+            connect_timeout: timeout in seconds for the ssh connection.
+            source_bashrc: Whether to source the ~/.bashrc before running the
+                command.
+            skip_lines: The number of lines to skip at the beginning of the
+                output. This is used when the output is not processed by
+                SkyPilot but we still want to get rid of some warning messages,
+                such as SSH warnings.
+
+
+        Returns:
+            returncode
+            or
+            A tuple of (returncode, stdout, stderr).
+        """
+        raise NotImplementedError
+
+    @timeline.event
+    def rsync(
+        self,
+        source: str,
+        target: str,
+        *,
+        up: bool,
+        # Advanced options.
+        log_path: str = os.devnull,
+        stream_logs: bool = True,
+        max_retry: int = 1,
+    ) -> None:
+        """Uses 'rsync' to sync 'source' to 'target'.
+
+        Args:
+            source: The source path.
+            target: The target path.
+            up: The direction of the sync, True for local to cluster, False
+              for cluster to local.
+            log_path: Redirect stdout/stderr to the log_path.
+            stream_logs: Stream logs to the stdout/stderr.
+            max_retry: The maximum number of retries for the rsync command.
+              This value should be non-negative.
+
+        Raises:
+            exceptions.CommandError: rsync command failed.
+        """
+        raise NotImplementedError
+
+    @classmethod
+    def make_runner_list(
+        cls: Type['CommandRunner'],
+        node_list: Iterable[Any],
+        **kwargs,
+    ) -> List['CommandRunner']:
+        """Helper function for creating runners with the same credentials"""
+        return [cls(node, **kwargs) for node in node_list]
+
+    def check_connection(self) -> bool:
+        """Check if the connection to the remote machine is successful."""
+        returncode = self.run('true', connect_timeout=5, stream_logs=False)
+        return returncode == 0
+
+
+class SSHCommandRunner(CommandRunner):
     """Runner for SSH commands."""
 
     def __init__(
         self,
-        ip: str,
+        node: Tuple[str, int],
         ssh_user: str,
         ssh_private_key: str,
         ssh_control_name: Optional[str] = '__default__',
         ssh_proxy_command: Optional[str] = None,
-        port: int = 22,
         docker_user: Optional[str] = None,
         disable_control_master: Optional[bool] = False,
     ):
         """Initialize SSHCommandRunner.
 
         Example Usage:
             runner = SSHCommandRunner(ip, ssh_user, ssh_private_key)
             runner.run('ls -l', mode=SshMode.NON_INTERACTIVE)
             runner.rsync(source, target, up=True)
 
         Args:
-            ip: The IP address of the remote machine.
+            node: (ip, port) The IP address and port of the remote machine.
             ssh_private_key: The path to the private key to use for ssh.
             ssh_user: The user to use for ssh.
             ssh_control_name: The files name of the ssh_control to use. This is
                 used to avoid confliction between clusters for creating ssh
                 control files. It can simply be the cluster_name or any name
                 that can distinguish between clusters.
             ssh_proxy_command: Optional, the value to pass to '-o
@@ -168,14 +329,16 @@
             docker_user: The docker user to use for ssh. If specified, the
                 command will be run inside a docker container which have a ssh
                 server running at port sky.skylet.constants.DEFAULT_DOCKER_PORT
             disable_control_master: bool; specifies either or not the ssh
                 command will utilize ControlMaster. We currently disable
                 it for k8s instance.
         """
+        super().__init__(node)
+        ip, port = node
         self.ssh_private_key = ssh_private_key
         self.ssh_control_name = (
             None if ssh_control_name is None else hashlib.md5(
                 ssh_control_name.encode()).hexdigest()[:_HASH_MAX_LENGTH])
         self._ssh_proxy_command = ssh_proxy_command
         self.disable_control_master = disable_control_master
         if docker_user is not None:
@@ -192,37 +355,17 @@
                                       ) + ['-W', '%h:%p', f'{ssh_user}@{ip}'])
         else:
             self.ip = ip
             self.ssh_user = ssh_user
             self.port = port
             self._docker_ssh_proxy_command = None
 
-    @staticmethod
-    def make_runner_list(
-        ip_list: List[str],
-        ssh_user: str,
-        ssh_private_key: str,
-        ssh_control_name: Optional[str] = None,
-        ssh_proxy_command: Optional[str] = None,
-        disable_control_master: Optional[bool] = False,
-        port_list: Optional[List[int]] = None,
-        docker_user: Optional[str] = None,
-    ) -> List['SSHCommandRunner']:
-        """Helper function for creating runners with the same ssh credentials"""
-        if not port_list:
-            port_list = [22] * len(ip_list)
-        return [
-            SSHCommandRunner(ip, ssh_user, ssh_private_key, ssh_control_name,
-                             ssh_proxy_command, port, docker_user,
-                             disable_control_master)
-            for ip, port in zip(ip_list, port_list)
-        ]
-
     def _ssh_base_command(self, *, ssh_mode: SshMode,
-                          port_forward: Optional[List[int]]) -> List[str]:
+                          port_forward: Optional[List[int]],
+                          connect_timeout: Optional[int]) -> List[str]:
         ssh = ['ssh']
         if ssh_mode == SshMode.NON_INTERACTIVE:
             # Disable pseudo-terminal allocation. Otherwise, the output of
             # ssh will be corrupted by the user's input.
             ssh += ['-T']
         else:
             # Force pseudo-terminal allocation for interactive/login mode.
@@ -239,96 +382,85 @@
             docker_ssh_proxy_command = None
         return ssh + ssh_options_list(
             self.ssh_private_key,
             self.ssh_control_name,
             ssh_proxy_command=self._ssh_proxy_command,
             docker_ssh_proxy_command=docker_ssh_proxy_command,
             port=self.port,
+            connect_timeout=connect_timeout,
             disable_control_master=self.disable_control_master) + [
                 f'{self.ssh_user}@{self.ip}'
             ]
 
+    @timeline.event
     def run(
             self,
             cmd: Union[str, List[str]],
             *,
             require_outputs: bool = False,
             port_forward: Optional[List[int]] = None,
             # Advanced options.
             log_path: str = os.devnull,
             # If False, do not redirect stdout/stderr to optimize performance.
             process_stream: bool = True,
             stream_logs: bool = True,
             ssh_mode: SshMode = SshMode.NON_INTERACTIVE,
             separate_stderr: bool = False,
+            connect_timeout: Optional[int] = None,
+            source_bashrc: bool = False,
+            skip_lines: int = 0,
             **kwargs) -> Union[int, Tuple[int, str, str]]:
         """Uses 'ssh' to run 'cmd' on a node with ip.
 
         Args:
-            ip: The IP address of the node.
             cmd: The command to run.
             port_forward: A list of ports to forward from the localhost to the
             remote host.
 
             Advanced options:
 
             require_outputs: Whether to return the stdout/stderr of the command.
             log_path: Redirect stdout/stderr to the log_path.
             stream_logs: Stream logs to the stdout/stderr.
             check: Check the success of the command.
             ssh_mode: The mode to use for ssh.
                 See SSHMode for more details.
             separate_stderr: Whether to separate stderr from stdout.
-
+            connect_timeout: timeout in seconds for the ssh connection.
+            source_bashrc: Whether to source the bashrc before running the
+                command.
+            skip_lines: The number of lines to skip at the beginning of the
+                output. This is used when the output is not processed by
+                SkyPilot but we still want to get rid of some warning messages,
+                such as SSH warnings.
 
         Returns:
             returncode
             or
             A tuple of (returncode, stdout, stderr).
         """
-        base_ssh_command = self._ssh_base_command(ssh_mode=ssh_mode,
-                                                  port_forward=port_forward)
+        base_ssh_command = self._ssh_base_command(
+            ssh_mode=ssh_mode,
+            port_forward=port_forward,
+            connect_timeout=connect_timeout)
         if ssh_mode == SshMode.LOGIN:
             assert isinstance(cmd, list), 'cmd must be a list for login mode.'
             command = base_ssh_command + cmd
             proc = subprocess_utils.run(command, shell=False, check=False)
             return proc.returncode, '', ''
-        if isinstance(cmd, list):
-            cmd = ' '.join(cmd)
+
+        command_str = self._get_command_to_run(cmd,
+                                               process_stream,
+                                               separate_stderr,
+                                               skip_lines=skip_lines,
+                                               source_bashrc=source_bashrc)
+        command = base_ssh_command + [shlex.quote(command_str)]
 
         log_dir = os.path.expanduser(os.path.dirname(log_path))
         os.makedirs(log_dir, exist_ok=True)
-        # We need this to correctly run the cmd, and get the output.
-        command = [
-            'bash',
-            '--login',
-            '-c',
-            # Need this `-i` option to make sure `source ~/.bashrc` work.
-            '-i',
-        ]
-
-        command += [
-            shlex.quote(f'true && source ~/.bashrc && export OMP_NUM_THREADS=1 '
-                        f'PYTHONWARNINGS=ignore && ({cmd})'),
-        ]
-        if not separate_stderr:
-            command.append('2>&1')
-        if not process_stream and ssh_mode == SshMode.NON_INTERACTIVE:
-            command += [
-                # A hack to remove the following bash warnings (twice):
-                #  bash: cannot set terminal process group
-                #  bash: no job control in this shell
-                '| stdbuf -o0 tail -n +5',
-                # This is required to make sure the executor of command can get
-                # correct returncode, since linux pipe is used.
-                '; exit ${PIPESTATUS[0]}'
-            ]
-
-        command_str = ' '.join(command)
-        command = base_ssh_command + [shlex.quote(command_str)]
 
         executable = None
         if not process_stream:
             if stream_logs:
                 command += [
                     f'| tee {log_path}',
                     # This also requires the executor to be '/bin/bash' instead
@@ -343,14 +475,15 @@
                                     require_outputs=require_outputs,
                                     stream_logs=stream_logs,
                                     process_stream=process_stream,
                                     shell=True,
                                     executable=executable,
                                     **kwargs)
 
+    @timeline.event
     def rsync(
         self,
         source: str,
         target: str,
         *,
         up: bool,
         # Advanced options.
@@ -426,15 +559,15 @@
                 f'{self.ssh_user}@{self.ip}:{source!r}',
                 f'{os.path.expanduser(target)!r}',
             ])
         command = ' '.join(rsync_command)
 
         backoff = common_utils.Backoff(initial_backoff=5, max_backoff_factor=5)
         while max_retry >= 0:
-            returncode, _, stderr = log_lib.run_with_log(
+            returncode, stdout, stderr = log_lib.run_with_log(
                 command,
                 log_path=log_path,
                 stream_logs=stream_logs,
                 shell=True,
                 require_outputs=True)
             if returncode == 0:
                 break
@@ -443,9 +576,9 @@
 
         direction = 'up' if up else 'down'
         error_msg = (f'Failed to rsync {direction}: {source} -> {target}. '
                      'Ensure that the network is stable, then retry.')
         subprocess_utils.handle_returncode(returncode,
                                            command,
                                            error_msg,
-                                           stderr=stderr,
+                                           stderr=stdout + stderr,
                                            stream_logs=stream_logs)
```

### Comparing `skypilot-0.5.0/sky/utils/common_utils.py` & `skypilot-0.6.0/sky/utils/common_utils.py`

 * *Files 4% similar despite different names*

```diff
@@ -57,51 +57,64 @@
     """
     global _usage_run_id
     if _usage_run_id is None:
         _usage_run_id = str(uuid.uuid4())
     return _usage_run_id
 
 
-def get_user_hash() -> str:
+def get_user_hash(force_fresh_hash: bool = False) -> str:
     """Returns a unique user-machine specific hash as a user id.
 
     We cache the user hash in a file to avoid potential user_name or
     hostname changes causing a new user hash to be generated.
+
+    Args:
+        force_fresh_hash: Bypasses the cached hash in USER_HASH_FILE and the
+            hash in the USER_ID_ENV_VAR and forces a fresh user-machine hash
+            to be generated. Used by `kubernetes.ssh_key_secret_field_name` to
+            avoid controllers sharing the same ssh key field name as the
+            local client.
     """
 
     def _is_valid_user_hash(user_hash: Optional[str]) -> bool:
         if user_hash is None:
             return False
         try:
             int(user_hash, 16)
         except (TypeError, ValueError):
             return False
         return len(user_hash) == USER_HASH_LENGTH
 
-    user_hash = os.getenv(constants.USER_ID_ENV_VAR)
-    if _is_valid_user_hash(user_hash):
-        assert user_hash is not None
-        return user_hash
+    if not force_fresh_hash:
+        user_hash = os.getenv(constants.USER_ID_ENV_VAR)
+        if _is_valid_user_hash(user_hash):
+            assert user_hash is not None
+            return user_hash
 
-    if os.path.exists(_USER_HASH_FILE):
+    if not force_fresh_hash and os.path.exists(_USER_HASH_FILE):
         # Read from cached user hash file.
         with open(_USER_HASH_FILE, 'r', encoding='utf-8') as f:
             # Remove invalid characters.
             user_hash = f.read().strip()
         if _is_valid_user_hash(user_hash):
             return user_hash
 
     hash_str = user_and_hostname_hash()
     user_hash = hashlib.md5(hash_str.encode()).hexdigest()[:USER_HASH_LENGTH]
     if not _is_valid_user_hash(user_hash):
         # A fallback in case the hash is invalid.
         user_hash = uuid.uuid4().hex[:USER_HASH_LENGTH]
     os.makedirs(os.path.dirname(_USER_HASH_FILE), exist_ok=True)
-    with open(_USER_HASH_FILE, 'w', encoding='utf-8') as f:
-        f.write(user_hash)
+    if not force_fresh_hash:
+        # Do not cache to file if force_fresh_hash is True since the file may
+        # be intentionally using a different hash, e.g. we want to keep the
+        # user_hash for usage collection the same on the jobs/serve controller
+        # as users' local client.
+        with open(_USER_HASH_FILE, 'w', encoding='utf-8') as f:
+            f.write(user_hash)
     return user_hash
 
 
 def base36_encode(hex_str: str) -> str:
     """Converts a hex string to a base36 string."""
     int_value = int(hex_str, 16)
 
@@ -196,20 +209,24 @@
         return repr(cluster_name)
     return f'{cluster_name!r} (name on cloud: {cluster_name_on_cloud!r})'
 
 
 def get_global_job_id(job_timestamp: str,
                       cluster_name: Optional[str],
                       job_id: str,
-                      task_id: Optional[int] = None) -> str:
+                      task_id: Optional[int] = None,
+                      is_managed_job: bool = False) -> str:
     """Returns a unique job run id for each job run.
 
     A job run is defined as the lifetime of a job that has been launched.
     """
-    global_job_id = f'{job_timestamp}_{cluster_name}_id-{job_id}'
+    managed_job_str = 'managed-' if is_managed_job else ''
+    _, sep, timestamp = job_timestamp.partition('sky-')
+    job_timestamp = f'{sep}{managed_job_str}{timestamp}'
+    global_job_id = f'{job_timestamp}_{cluster_name}_{job_id}'
     if task_id is not None:
         global_job_id += f'-{task_id}'
     return global_job_id
 
 
 class Backoff:
     """Exponential backoff with jittering."""
@@ -239,15 +256,14 @@
 
 
 def get_pretty_entry_point() -> str:
     """Returns the prettified entry point of this process (sys.argv).
 
     Example return values:
         $ sky launch app.yaml  # 'sky launch app.yaml'
-        $ sky gpunode  # 'sky gpunode'
         $ python examples/app.py  # 'app.py'
     """
     argv = sys.argv
     basename = os.path.basename(argv[0])
     if basename == 'sky':
         # Turn '/.../anaconda/envs/py36/bin/sky' into 'sky', but keep other
         # things like 'examples/app.py'.
@@ -320,15 +336,16 @@
         dump_func = yaml.dump
     return dump_func(config,
                      Dumper=LineBreakDumper,
                      sort_keys=False,
                      default_flow_style=False)
 
 
-def make_decorator(cls, name_or_fn: Union[str, Callable], **ctx_kwargs):
+def make_decorator(cls, name_or_fn: Union[str, Callable],
+                   **ctx_kwargs) -> Callable:
     """Make the cls a decorator.
 
     class cls:
         def __init__(self, name, **kwargs):
             pass
         def __enter__(self):
             pass
@@ -431,17 +448,17 @@
     return payload
 
 
 def class_fullname(cls, skip_builtins: bool = True):
     """Get the full name of a class.
 
     Example:
-        >>> e = sky.exceptions.FetchIPError()
+        >>> e = sky.exceptions.FetchClusterInfoError()
         >>> class_fullname(e.__class__)
-        'sky.exceptions.FetchIPError'
+        'sky.exceptions.FetchClusterInfoError'
 
     Args:
         cls: The class to get the full name.
 
     Returns:
         The full name of the class.
     """
@@ -559,56 +576,65 @@
                 #
                 # This will print something like:
                 # 'hello world' does not match any of the regexes: <regex>
                 err_msg = (err_msg_prefix +
                            'The `envs` field contains invalid keys:\n' +
                            e.message)
             else:
-                err_msg = err_msg_prefix + 'The following fields are invalid:'
+                err_msg = err_msg_prefix
                 known_fields = set(e.schema.get('properties', {}).keys())
                 for field in e.instance:
                     if field not in known_fields:
                         most_similar_field = difflib.get_close_matches(
                             field, known_fields, 1)
                         if most_similar_field:
-                            err_msg += (f'\nInstead of {field!r}, did you mean '
+                            err_msg += (f'Instead of {field!r}, did you mean '
                                         f'{most_similar_field[0]!r}?')
                         else:
-                            err_msg += f'\nFound unsupported field {field!r}.'
+                            err_msg += f'Found unsupported field {field!r}.'
         else:
+            message = e.message
+            # Object in jsonschema is represented as dict in Python. Replace
+            # 'object' with 'dict' for better readability.
+            message = message.replace('type \'object\'', 'type \'dict\'')
             # Example e.json_path value: '$.resources'
-            err_msg = (err_msg_prefix + e.message +
+            err_msg = (err_msg_prefix + message +
                        f'. Check problematic field(s): {e.json_path}')
 
     if err_msg:
         with ux_utils.print_exception_no_traceback():
             raise ValueError(err_msg)
 
 
 def get_cleaned_username(username: str = '') -> str:
-    """Cleans the username. Dots and underscores are allowed, as we will
+    """Cleans the username. Underscores are allowed, as we will
      handle it when mapping to the cluster_name_on_cloud in
      common_utils.make_cluster_name_on_cloud.
 
     Clean up includes:
      1. Making all characters lowercase
-     2. Removing any non-alphanumeric characters (excluding hyphens)
+     2. Removing any non-alphanumeric characters (excluding hyphens and
+        underscores)
      3. Removing any numbers and/or hyphens at the start of the username.
      4. Removing any hyphens at the end of the username
+     5. Truncate the username to 63 characters, as requested by GCP labels
+
+    Dots are removed due to: https://cloud.google.com/compute/docs/labeling-resources#requirements # pylint: disable=line-too-long
 
     e.g. 1SkY-PiLot2- becomes sky-pilot2
 
     Returns:
       A cleaned username.
     """
     username = username or getpass.getuser()
     username = username.lower()
-    username = re.sub(r'[^a-z0-9-._]', '', username)
+    username = re.sub(r'[^a-z0-9-_]', '', username)
     username = re.sub(r'^[0-9-]+', '', username)
     username = re.sub(r'-$', '', username)
+    username = username[:63]
     return username
 
 
 def fill_template(template_name: str, variables: Dict,
                   output_path: str) -> None:
     """Create a file from a Jinja template and return the filename."""
     assert template_name.endswith('.j2'), template_name
@@ -622,7 +648,33 @@
     os.makedirs(os.path.dirname(output_path), exist_ok=True)
 
     # Write out yaml config.
     j2_template = jinja2.Template(template)
     content = j2_template.render(**variables)
     with open(output_path, 'w', encoding='utf-8') as fout:
         fout.write(content)
+
+
+def deprecated_function(
+        func: Callable,
+        name: str,
+        deprecated_name: str,
+        removing_version: str,
+        override_argument: Optional[Dict[str, Any]] = None) -> Callable:
+    """Decorator for creating deprecated functions, for backward compatibility.
+
+    It will result in a warning being emitted when the function is used.
+    """
+
+    @functools.wraps(func)
+    def new_func(*args, **kwargs):
+        override_argument_str = ''
+        if override_argument:
+            override_argument_str = ', '.join(
+                f'{k}={v}' for k, v in override_argument.items())
+        logger.warning(
+            f'Call to deprecated function {deprecated_name}, which will be '
+            f'removed in {removing_version}. Please use '
+            f'{name}({override_argument_str}) instead.')
+        return func(*args, **kwargs)
+
+    return new_func
```

### Comparing `skypilot-0.5.0/sky/utils/db_utils.py` & `skypilot-0.6.0/sky/utils/db_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/utils/env_options.py` & `skypilot-0.6.0/sky/utils/env_options.py`

 * *Files 16% similar despite different names*

```diff
@@ -5,17 +5,17 @@
 
 class Options(enum.Enum):
     """Environment variables for SkyPilot."""
     IS_DEVELOPER = 'SKYPILOT_DEV'
     SHOW_DEBUG_INFO = 'SKYPILOT_DEBUG'
     DISABLE_LOGGING = 'SKYPILOT_DISABLE_USAGE_COLLECTION'
     MINIMIZE_LOGGING = 'SKYPILOT_MINIMIZE_LOGGING'
-    # Internal: this is used to skip the cloud user identity check,
-    # which is used to protect cluster operations in a multi-identity
-    # scenario. Currently, this is only used in the spot controller,
-    # as there will not be multiple identities, and skipping the check
-    # can increase robustness.
+    # Internal: this is used to skip the cloud user identity check, which is
+    # used to protect cluster operations in a multi-identity scenario.
+    # Currently, this is only used in the job and serve controller, as there
+    # will not be multiple identities, and skipping the check can increase
+    # robustness.
     SKIP_CLOUD_IDENTITY_CHECK = 'SKYPILOT_SKIP_CLOUD_IDENTITY_CHECK'
 
     def get(self):
         """Check if an environment variable is set to True."""
         return os.getenv(self.value, 'False').lower() in ('true', '1')
```

### Comparing `skypilot-0.5.0/sky/utils/kubernetes/create_cluster.sh` & `skypilot-0.6.0/sky/utils/kubernetes/create_cluster.sh`

 * *Files 9% similar despite different names*

```diff
@@ -162,19 +162,44 @@
     echo "Pulling SkyPilot CPU image..."
     docker pull ${IMAGE}
     echo "Loading SkyPilot CPU image into kind cluster..."
     kind load docker-image --name skypilot ${IMAGE}
     echo "SkyPilot CPU image loaded into kind cluster."
 }
 
+wait_for_nginx_ingress_controller_install() {
+    echo "Starting installation of Nginx Ingress Controller..."
+
+    SECONDS=0
+    TIMEOUT=600  # 10 minutes in seconds
+
+    kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml
+
+    while true; do
+        if kubectl get pod -n ingress-nginx -l app.kubernetes.io/component=controller -o wide | grep 'Running'; then
+            echo "Nginx Ingress Controller installed."
+            break
+        elif [ $SECONDS -ge $TIMEOUT ]; then
+            echo "Timed out waiting for installation of Nginx Ingress Controller."
+            exit 1
+        else
+            echo "Waiting for Nginx Ingress Controller Installation..."
+            echo "To check status, check Nginx Ingress Controller pods:"
+            echo "kubectl get pod -n ingress-nginx -l app.kubernetes.io/component=controller -o wide"
+            sleep 5
+        fi
+    done
+
+}
+
 if $ENABLE_GPUS; then
     echo "Enabling GPU support..."
     # Run patch for missing ldconfig.real
     # https://github.com/NVIDIA/nvidia-docker/issues/614#issuecomment-423991632
-    docker exec -ti skypilot-control-plane ln -s /sbin/ldconfig /sbin/ldconfig.real
+    docker exec -ti skypilot-control-plane /bin/bash -c '[ ! -f /sbin/ldconfig.real ] && ln -s /sbin/ldconfig /sbin/ldconfig.real || echo "/sbin/ldconfig.real already exists"'
 
     echo "Installing NVIDIA GPU operator..."
     # Install the NVIDIA GPU operator
     helm repo add nvidia https://helm.ngc.nvidia.com/nvidia || true
     helm repo update
     helm install --wait --generate-name \
          -n gpu-operator --create-namespace \
@@ -192,14 +217,17 @@
     # Wait for all the GPU labeling jobs to complete
     wait_for_gpu_labeling_jobs
 fi
 
 # Load local skypilot image on to the cluster for faster startup
 wait_for_skypilot_cpu_image_pull
 
+# Install the Nginx Ingress Controller
+wait_for_nginx_ingress_controller_install
+
 # Print CPUs available on the local cluster
 NUM_CPUS=$(kubectl get nodes -o jsonpath='{.items[0].status.capacity.cpu}')
 echo "Kubernetes cluster ready! Run `sky check` to setup Kubernetes access."
 if $ENABLE_GPUS; then
     # As a sanity check, verify if GPU support is enabled
     if ! kubectl describe nodes | grep -q nvidia.com/gpu; then
         >&2 echo "GPU support was not enabled. Please check for any errors above."
```

### Comparing `skypilot-0.5.0/sky/utils/kubernetes/delete_cluster.sh` & `skypilot-0.6.0/sky/utils/kubernetes/delete_cluster.sh`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/utils/kubernetes/generate_kind_config.py` & `skypilot-0.6.0/sky/utils/kubernetes/generate_kind_config.py`

 * *Files 10% similar despite different names*

```diff
@@ -27,15 +27,22 @@
     kubeadmConfigPatches:
     - |
       kind: ClusterConfiguration
       apiServer:
         extraArgs:
           "service-node-port-range": {port_start}-{port_end}
     nodes:
-    - role: control-plane""")
+    - role: control-plane
+      kubeadmConfigPatches:
+      - |
+        kind: InitConfiguration
+        nodeRegistration:
+          kubeletExtraArgs:
+            node-labels: "ingress-ready=true"
+    """)
     if gpus:
         preamble += textwrap.indent(
             textwrap.dedent("""
         extraMounts:
         - hostPath: /dev/null
           containerPath: /var/run/nvidia-container-devices/all"""), ' ' * 2)
     preamble += textwrap.indent(
```

### Comparing `skypilot-0.5.0/sky/utils/kubernetes/gpu_labeler.py` & `skypilot-0.6.0/sky/utils/kubernetes/gpu_labeler.py`

 * *Files 2% similar despite different names*

```diff
@@ -140,29 +140,29 @@
             batch_v1.create_namespaced_job(namespace, job_manifest)
             print(f'Created GPU labeler job for node {node_name}')
     if len(gpu_nodes) == 0:
         print('No GPU nodes found in the cluster. If you have GPU nodes, '
               'please ensure that they have the label '
               '`nvidia.com/gpu: <number of GPUs>`')
     else:
-        print('GPU labeling started - this may take a few minutes to complete.'
+        print('GPU labeling started - this may take 10 min or more to complete.'
               '\nTo check the status of GPU labeling jobs, run '
               '`kubectl get jobs -n kube-system -l job=sky-gpu-labeler`'
               '\nYou can check if nodes have been labeled by running '
               '`kubectl describe nodes` and looking for labels of the format '
-              '`skypilot.co/accelerators: <gpu_name>`. ')
+              '`skypilot.co/accelerator: <gpu_name>`. ')
 
 
 def main():
     parser = argparse.ArgumentParser(
         description='Labels GPU nodes in a Kubernetes cluster for use with '
         'SkyPilot. Operates by running a job on each node that '
         'parses nvidia-smi and patches the node with new labels. '
         'Labels created are of the format '
-        'skypilot.co/accelerators: <gpu_name>. Automatically '
+        'skypilot.co/accelerator: <gpu_name>. Automatically '
         'creates a service account and cluster role binding with '
         'permissions to list nodes and create labels.')
     parser.add_argument('--cleanup',
                         action='store_true',
                         help='delete all GPU labeler resources in the '
                         'Kubernetes cluster.')
     args = parser.parse_args()
```

### Comparing `skypilot-0.5.0/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml` & `skypilot-0.6.0/sky/utils/kubernetes/k8s_gpu_labeler_job.yaml`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml` & `skypilot-0.6.0/sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml`

 * *Files 7% similar despite different names*

```diff
@@ -55,15 +55,15 @@
     from typing import Optional
     
     from kubernetes import client
     from kubernetes import config
     
     canonical_gpu_names = [
         'A100-80GB', 'A100', 'A10G', 'H100', 'K80', 'M60', 'T4g', 'T4', 'V100', 
-        'A10', 'P100', 'P40', 'P4', 'L4', 'A6000'
+        'A10', 'P100', 'P40', 'P4', 'L4'
     ]
     
     
     def get_gpu_name() -> Optional[str]:
         try:
             result = subprocess.run(
                 ['nvidia-smi', '--query-gpu=name', '--format=csv,noheader,nounits'],
@@ -104,17 +104,21 @@
             labelled = False
             for canonical_name in canonical_gpu_names:
                 if canonical_name.lower() in gpu_name.lower():
                     label_node(canonical_name.lower())
                     labelled = True
                     break
             if not labelled:
-                # If we didn't find a canonical name, just use the GPU name
-                # with spaces replaced by dashes
-                gpu_label = gpu_name.lower().replace(' ', '-')
+                # If we didn't find a canonical name:
+                # 1. remove 'NVIDIA ' if present (e.g., 'NVIDIA RTX A6000' -> 'RTX A6000')
+                # 2. remove 'GeForce ' if present (e.g., 'NVIDIA GeForce RTX 3070' -> 'RTX 3070')
+                # 3. replace 'RTX ' with 'RTX' (without spaces) (e.g., 'RTX 6000' -> 'RTX6000')
+                # 4. replace any other spaces with dashes (e.g. 'RTX 2080 Ti' -> 'RTX2080-Ti')
+                gpu_name = gpu_name.lower().replace('nvidia ', '').replace('geforce ', '').replace('rtx ', 'rtx').replace(' ', '-')
+                gpu_label = gpu_name
                 label_node(gpu_label)
                 labelled = True
         else:
             print('No GPU detected. Try running nvidia-smi in the container.')
     
     
     if __name__ == '__main__':
```

### Comparing `skypilot-0.5.0/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py` & `skypilot-0.6.0/sky/utils/kubernetes/ssh_jump_lifecycle_manager.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/utils/kubernetes_enums.py` & `skypilot-0.6.0/sky/utils/kubernetes_enums.py`

 * *Files 8% similar despite different names*

```diff
@@ -31,7 +31,15 @@
 
 class KubernetesPortMode(enum.Enum):
     """Enum for the different types of modes supported for opening
     ports on Kubernetes.
     """
     INGRESS = 'ingress'
     LOADBALANCER = 'loadbalancer'
+    PODIP = 'podip'
+
+
+class KubernetesAutoscalerType(enum.Enum):
+    """Enum for the different types of cluster autoscalers for Kubernetes."""
+    GKE = 'gke'
+    KARPENTER = 'karpenter'
+    GENERIC = 'generic'
```

### Comparing `skypilot-0.5.0/sky/utils/log_utils.py` & `skypilot-0.6.0/sky/utils/log_utils.py`

 * *Files 5% similar despite different names*

```diff
@@ -112,14 +112,21 @@
                         f'{colorama.Style.RESET_ALL}')
         if 'Pulling SkyPilot CPU image...' in log_line:
             self.status_display.update('[bold cyan]Creating local cluster - '
                                        'pulling and loading SkyPilot CPU image')
         if 'SkyPilot CPU image loaded into kind cluster' in log_line:
             logger.info(f'{colorama.Fore.GREEN}SkyPilot CPU image pulled.'
                         f'{colorama.Style.RESET_ALL}')
+        if 'Starting installation of Nginx Ingress Controller...' in log_line:
+            self.status_display.update(
+                '[bold cyan]Creating Nginx Ingress Controller')
+        if 'Nginx Ingress Controller installed' in log_line:
+            logger.info(
+                f'{colorama.Fore.GREEN}Nginx Ingress Controller installed.'
+                f'{colorama.Style.RESET_ALL}')
 
     def __exit__(self, except_type, except_value, traceback):
         del except_type, except_value, traceback  # unused
         self.status_display.stop()
 
 
 def create_table(field_names: List[str], **kwargs) -> prettytable.PrettyTable:
```

### Comparing `skypilot-0.5.0/sky/utils/resources_utils.py` & `skypilot-0.6.0/sky/utils/resources_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/utils/rich_utils.py` & `skypilot-0.6.0/sky/utils/rich_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/utils/subprocess_utils.py` & `skypilot-0.6.0/sky/utils/subprocess_utils.py`

 * *Files 1% similar despite different names*

```diff
@@ -163,14 +163,16 @@
         returncode, stdout, stderr = log_lib.run_with_log(cmd,
                                                           '/dev/null',
                                                           require_outputs=True,
                                                           shell=True)
         if retry_cnt < max_retry:
             if (retry_returncode is not None and
                     returncode in retry_returncode):
+                logger.debug(
+                    f'Retrying command due to returncode {returncode}: {cmd}')
                 retry_cnt += 1
                 time.sleep(random.uniform(0, 1) * 2)
                 continue
 
             if retry_stderrs is None:
                 break
```

### Comparing `skypilot-0.5.0/sky/utils/timeline.py` & `skypilot-0.6.0/sky/utils/timeline.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/utils/ux_utils.py` & `skypilot-0.6.0/sky/utils/ux_utils.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/sky/utils/validator.py` & `skypilot-0.6.0/sky/utils/validator.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/skypilot.egg-info/PKG-INFO` & `skypilot-0.6.0/skypilot.egg-info/PKG-INFO`

 * *Files 4% similar despite different names*

```diff
@@ -1,21 +1,22 @@
 Metadata-Version: 2.1
 Name: skypilot
-Version: 0.5.0
+Version: 0.6.0
 Summary: SkyPilot: An intercloud broker for the clouds
 Author: SkyPilot Team
 License: Apache 2.0
 Project-URL: Homepage, https://github.com/skypilot-org/skypilot
 Project-URL: Issues, https://github.com/skypilot-org/skypilot/issues
 Project-URL: Discussion, https://github.com/skypilot-org/skypilot/discussions
 Project-URL: Documentation, https://skypilot.readthedocs.io/en/latest/
 Classifier: Programming Language :: Python :: 3.7
 Classifier: Programming Language :: Python :: 3.8
 Classifier: Programming Language :: Python :: 3.9
 Classifier: Programming Language :: Python :: 3.10
+Classifier: Programming Language :: Python :: 3.11
 Classifier: License :: OSI Approved :: Apache Software License
 Classifier: Operating System :: OS Independent
 Classifier: Topic :: Software Development :: Libraries :: Python Modules
 Classifier: Topic :: System :: Distributed Computing
 Description-Content-Type: text/markdown
 License-File: LICENSE
 Requires-Dist: wheel
@@ -46,94 +47,95 @@
 Requires-Dist: boto3>=1.26.1; extra == "aws"
 Requires-Dist: colorama<0.4.5; extra == "aws"
 Provides-Extra: azure
 Requires-Dist: azure-cli>=2.31.0; extra == "azure"
 Requires-Dist: azure-core; extra == "azure"
 Requires-Dist: azure-identity>=1.13.0; extra == "azure"
 Requires-Dist: azure-mgmt-network; extra == "azure"
-Requires-Dist: ray[default]!=2.6.0,<=2.6.3,>=2.2.0; extra == "azure"
+Requires-Dist: ray[default]!=2.6.0,>=2.2.0; extra == "azure"
 Provides-Extra: gcp
 Requires-Dist: google-api-python-client>=2.69.0; extra == "gcp"
 Requires-Dist: google-cloud-storage; extra == "gcp"
 Provides-Extra: ibm
 Requires-Dist: ibm-cloud-sdk-core; extra == "ibm"
 Requires-Dist: ibm-vpc; extra == "ibm"
 Requires-Dist: ibm-platform-services; extra == "ibm"
 Requires-Dist: ibm-cos-sdk; extra == "ibm"
-Requires-Dist: ray[default]!=2.6.0,<=2.6.3,>=2.2.0; extra == "ibm"
+Requires-Dist: ray[default]!=2.6.0,>=2.2.0; extra == "ibm"
 Provides-Extra: docker
 Requires-Dist: docker; extra == "docker"
-Requires-Dist: ray[default]!=2.6.0,<=2.6.3,>=2.2.0; extra == "docker"
+Requires-Dist: ray[default]!=2.6.0,>=2.2.0; extra == "docker"
 Provides-Extra: lambda
-Requires-Dist: ray[default]!=2.6.0,<=2.6.3,>=2.2.0; extra == "lambda"
+Requires-Dist: ray[default]!=2.6.0,>=2.2.0; extra == "lambda"
 Provides-Extra: cloudflare
 Requires-Dist: urllib3<2; extra == "cloudflare"
 Requires-Dist: awscli>=1.27.10; extra == "cloudflare"
 Requires-Dist: botocore>=1.29.10; extra == "cloudflare"
 Requires-Dist: boto3>=1.26.1; extra == "cloudflare"
 Requires-Dist: colorama<0.4.5; extra == "cloudflare"
 Provides-Extra: scp
-Requires-Dist: ray[default]!=2.6.0,<=2.6.3,>=2.2.0; extra == "scp"
+Requires-Dist: ray[default]!=2.6.0,>=2.2.0; extra == "scp"
 Provides-Extra: oci
 Requires-Dist: oci; extra == "oci"
-Requires-Dist: ray[default]!=2.6.0,<=2.6.3,>=2.2.0; extra == "oci"
+Requires-Dist: ray[default]!=2.6.0,>=2.2.0; extra == "oci"
 Provides-Extra: kubernetes
 Requires-Dist: kubernetes>=20.0.0; extra == "kubernetes"
 Provides-Extra: remote
 Requires-Dist: grpcio!=1.48.0,<=1.49.1,>=1.32.0; (python_version < "3.10" and sys_platform == "darwin") and extra == "remote"
 Requires-Dist: grpcio!=1.48.0,<=1.49.1,>=1.42.0; (python_version >= "3.10" and sys_platform == "darwin") and extra == "remote"
 Requires-Dist: grpcio!=1.48.0,<=1.51.3,>=1.32.0; (python_version < "3.10" and sys_platform != "darwin") and extra == "remote"
 Requires-Dist: grpcio!=1.48.0,<=1.51.3,>=1.42.0; (python_version >= "3.10" and sys_platform != "darwin") and extra == "remote"
 Requires-Dist: protobuf!=3.19.5,>=3.15.3; extra == "remote"
-Requires-Dist: pydantic<2.0,>=1.10.8; extra == "remote"
+Requires-Dist: pydantic!=2.0.*,!=2.1.*,!=2.2.*,!=2.3.*,!=2.4.*,<3; extra == "remote"
 Provides-Extra: runpod
 Requires-Dist: runpod>=1.5.1; extra == "runpod"
 Provides-Extra: fluidstack
 Provides-Extra: cudo
-Requires-Dist: cudo-compute>=0.1.8; extra == "cudo"
+Requires-Dist: cudo-compute>=0.1.10; extra == "cudo"
+Provides-Extra: paperspace
 Provides-Extra: vsphere
 Requires-Dist: pyvmomi==8.0.1.0.2; extra == "vsphere"
 Provides-Extra: all
 Requires-Dist: urllib3<2; extra == "all"
 Requires-Dist: awscli>=1.27.10; extra == "all"
 Requires-Dist: botocore>=1.29.10; extra == "all"
 Requires-Dist: boto3>=1.26.1; extra == "all"
 Requires-Dist: colorama<0.4.5; extra == "all"
 Requires-Dist: azure-cli>=2.31.0; extra == "all"
 Requires-Dist: azure-core; extra == "all"
 Requires-Dist: azure-identity>=1.13.0; extra == "all"
 Requires-Dist: azure-mgmt-network; extra == "all"
-Requires-Dist: ray[default]!=2.6.0,<=2.6.3,>=2.2.0; extra == "all"
+Requires-Dist: ray[default]!=2.6.0,>=2.2.0; extra == "all"
 Requires-Dist: google-api-python-client>=2.69.0; extra == "all"
 Requires-Dist: google-cloud-storage; extra == "all"
 Requires-Dist: ibm-cloud-sdk-core; extra == "all"
 Requires-Dist: ibm-vpc; extra == "all"
 Requires-Dist: ibm-platform-services; extra == "all"
 Requires-Dist: ibm-cos-sdk; extra == "all"
-Requires-Dist: ray[default]!=2.6.0,<=2.6.3,>=2.2.0; extra == "all"
+Requires-Dist: ray[default]!=2.6.0,>=2.2.0; extra == "all"
 Requires-Dist: docker; extra == "all"
-Requires-Dist: ray[default]!=2.6.0,<=2.6.3,>=2.2.0; extra == "all"
-Requires-Dist: ray[default]!=2.6.0,<=2.6.3,>=2.2.0; extra == "all"
+Requires-Dist: ray[default]!=2.6.0,>=2.2.0; extra == "all"
+Requires-Dist: ray[default]!=2.6.0,>=2.2.0; extra == "all"
 Requires-Dist: urllib3<2; extra == "all"
 Requires-Dist: awscli>=1.27.10; extra == "all"
 Requires-Dist: botocore>=1.29.10; extra == "all"
 Requires-Dist: boto3>=1.26.1; extra == "all"
 Requires-Dist: colorama<0.4.5; extra == "all"
-Requires-Dist: ray[default]!=2.6.0,<=2.6.3,>=2.2.0; extra == "all"
+Requires-Dist: ray[default]!=2.6.0,>=2.2.0; extra == "all"
 Requires-Dist: oci; extra == "all"
-Requires-Dist: ray[default]!=2.6.0,<=2.6.3,>=2.2.0; extra == "all"
+Requires-Dist: ray[default]!=2.6.0,>=2.2.0; extra == "all"
 Requires-Dist: kubernetes>=20.0.0; extra == "all"
 Requires-Dist: grpcio!=1.48.0,<=1.49.1,>=1.32.0; (python_version < "3.10" and sys_platform == "darwin") and extra == "all"
 Requires-Dist: grpcio!=1.48.0,<=1.49.1,>=1.42.0; (python_version >= "3.10" and sys_platform == "darwin") and extra == "all"
 Requires-Dist: grpcio!=1.48.0,<=1.51.3,>=1.32.0; (python_version < "3.10" and sys_platform != "darwin") and extra == "all"
 Requires-Dist: grpcio!=1.48.0,<=1.51.3,>=1.42.0; (python_version >= "3.10" and sys_platform != "darwin") and extra == "all"
 Requires-Dist: protobuf!=3.19.5,>=3.15.3; extra == "all"
-Requires-Dist: pydantic<2.0,>=1.10.8; extra == "all"
+Requires-Dist: pydantic!=2.0.*,!=2.1.*,!=2.2.*,!=2.3.*,!=2.4.*,<3; extra == "all"
 Requires-Dist: runpod>=1.5.1; extra == "all"
-Requires-Dist: cudo-compute>=0.1.8; extra == "all"
+Requires-Dist: cudo-compute>=0.1.10; extra == "all"
 Requires-Dist: pyvmomi==8.0.1.0.2; extra == "all"
 
 <p align="center">
   <img alt="SkyPilot" src="https://raw.githubusercontent.com/skypilot-org/skypilot/master/docs/source/images/skypilot-wide-light-1k.png" width=55%>
 </p>
 
 <p align="center">
@@ -154,28 +156,32 @@
 
 <h3 align="center">
     Run LLMs and AI on Any Cloud
 </h3>
 
 ----
 :fire: *News* :fire:
+- [Apr, 2024] Serve and finetune [**Llama 3**](https://skypilot.readthedocs.io/en/latest/gallery/llms/llama-3.html) on any cloud or Kubernetes: [**example**](./llm/llama-3/)
+- [Apr, 2024] Serve [**Qwen-110B**](https://qwenlm.github.io/blog/qwen1.5-110b/) on your infra: [**example**](./llm/qwen/)
+- [Apr, 2024] Using [**Ollama**](https://github.com/ollama/ollama) to deploy quantized LLMs on CPUs and GPUs: [**example**](./llm/ollama/)
+- [Mar, 2024] Serve and deploy [**Databricks DBRX**](https://www.databricks.com/blog/introducing-dbrx-new-state-art-open-llm) on your infra: [**example**](./llm/dbrx/)
 - [Feb, 2024] Deploying and scaling [**Gemma**](https://blog.google/technology/developers/gemma-open-models/) with SkyServe: [**example**](./llm/gemma/)
 - [Feb, 2024] Speed up your LLM deployments with [**SGLang**](https://github.com/sgl-project/sglang) for 5x throughput on SkyServe: [**example**](./llm/sglang/)
 - [Feb, 2024] Serving [**Code Llama 70B**](https://ai.meta.com/blog/code-llama-large-language-model-coding/) with vLLM and SkyServe: [**example**](./llm/codellama/)
-- [Dec, 2023] Using [**LoRAX**](https://github.com/predibase/lorax) to serve 1000s of finetuned LLMs on a single instance in the cloud: [**example**](./llm/lorax/)
 - [Dec, 2023] [**Mixtral 8x7B**](https://mistral.ai/news/mixtral-of-experts/), a high quality sparse mixture-of-experts model, was released by Mistral AI! Deploy via SkyPilot on any cloud: [**example**](./llm/mixtral/)
 - [Nov, 2023] Using [**Axolotl**](https://github.com/OpenAccess-AI-Collective/axolotl) to finetune Mistral 7B on the cloud (on-demand and spot): [**example**](./llm/axolotl/)
-- [Sep, 2023] [**Mistral 7B**](https://mistral.ai/news/announcing-mistral-7b/), a high-quality open LLM, was released! Deploy via SkyPilot on any cloud: [**Mistral docs**](https://docs.mistral.ai/self-deployment/skypilot)
 - [Sep, 2023] Case study: [**Covariant**](https://covariant.ai/) transformed AI development on the cloud using SkyPilot, delivering models 4x faster cost-effectively: [**read the case study**](https://blog.skypilot.co/covariant/)
-- [Aug, 2023] Cookbook: Finetuning Llama 2 in your own cloud environment, privately: [**example**](./llm/vicuna-llama-2/), [**blog post**](https://blog.skypilot.co/finetuning-llama2-operational-guide/)
+- [Aug, 2023] **Finetuning Cookbook**: Finetuning Llama 2 in your own cloud environment, privately: [**example**](./llm/vicuna-llama-2/), [**blog post**](https://blog.skypilot.co/finetuning-llama2-operational-guide/)
 - [June, 2023] Serving LLM 24x Faster On the Cloud [**with vLLM**](https://vllm.ai/) and SkyPilot: [**example**](./llm/vllm/), [**blog post**](https://blog.skypilot.co/serving-llm-24x-faster-on-the-cloud-with-vllm-and-skypilot/)
 
 <details>
   <summary>Archived</summary>
-  
+
+- [Dec, 2023] Using [**LoRAX**](https://github.com/predibase/lorax) to serve 1000s of finetuned LLMs on a single instance in the cloud: [**example**](./llm/lorax/)
+- [Sep, 2023] [**Mistral 7B**](https://mistral.ai/news/announcing-mistral-7b/), a high-quality open LLM, was released! Deploy via SkyPilot on any cloud: [**Mistral docs**](https://docs.mistral.ai/self-deployment/skypilot)
 - [July, 2023] Self-Hosted **Llama-2 Chatbot** on Any Cloud: [**example**](./llm/llama-2/)
 - [April, 2023] [SkyPilot YAMLs](./llm/vicuna/) for finetuning & serving the [Vicuna LLM](https://lmsys.org/blog/2023-03-30-vicuna/) with a single command!
 
 </details>
 
 ----
 
@@ -194,22 +200,22 @@
 * [Optimizer](https://skypilot.readthedocs.io/en/latest/examples/auto-failover.html): 2x cost savings by auto-picking the cheapest VM/zone/region/cloud
 * [Autostop](https://skypilot.readthedocs.io/en/latest/reference/auto-stop.html): hands-free cleanup of idle clusters
 
 SkyPilot supports your existing GPU, TPU, and CPU workloads, with no code changes.
 
 Install with pip (we recommend the nightly build for the latest features or [from source](https://skypilot.readthedocs.io/en/latest/getting-started/installation.html)):
 ```bash
-pip install "skypilot-nightly[aws,gcp,azure,oci,lambda,runpod,fluidstack,cudo,ibm,scp,kubernetes]"  # choose your clouds
+pip install "skypilot-nightly[aws,gcp,azure,oci,lambda,runpod,fluidstack,paperspace,cudo,ibm,scp,kubernetes]"  # choose your clouds
 ```
 To get the last release, use:
 ```bash
-pip install -U "skypilot[aws,gcp,azure,oci,lambda,runpod,fluidstack,cudo,ibm,scp,kubernetes]"  # choose your clouds
+pip install -U "skypilot[aws,gcp,azure,oci,lambda,runpod,fluidstack,paperspace,cudo,ibm,scp,kubernetes]"  # choose your clouds
 ```
 
-Current supported providers (AWS, Azure, GCP, OCI, Lambda Cloud, RunPod, Fluidstack, Cudo, IBM, Samsung, Cloudflare, any Kubernetes cluster):
+Current supported providers (AWS, Azure, GCP, OCI, Lambda Cloud, RunPod, Fluidstack, Paperspace, Cudo, IBM, Samsung, Cloudflare, any Kubernetes cluster):
 <p align="center">
   <img alt="SkyPilot" src="https://raw.githubusercontent.com/skypilot-org/skypilot/master/docs/source/images/cloud-logos-light.png" width=85%>
 </p>
 
 
 ## Getting Started
 You can find our documentation [here](https://skypilot.readthedocs.io/en/latest/).
@@ -273,30 +279,34 @@
 
 ## More Information
 To learn more, see our [Documentation](https://skypilot.readthedocs.io/en/latest/) and [Tutorials](https://github.com/skypilot-org/skypilot-tutorial).
 
 <!-- Keep this section in sync with index.rst in SkyPilot Docs -->
 Runnable examples:
 - LLMs on SkyPilot
+  - [Llama 3](./llm/llama-3/)
+  - [Qwen](./llm/qwen/) 
+  - [Databricks DBRX](./llm/dbrx/)
   - [Gemma](./llm/gemma/)
   - [Mixtral 8x7B](./llm/mixtral/); [Mistral 7B](https://docs.mistral.ai/self-deployment/skypilot/) (from official Mistral team)
   - [Code Llama](./llm/codellama/)
   - [vLLM: Serving LLM 24x Faster On the Cloud](./llm/vllm/) (from official vLLM team)
   - [SGLang: Fast and Expressive LLM Serving On the Cloud](./llm/sglang/) (from official SGLang team)
   - [Vicuna chatbots: Training & Serving](./llm/vicuna/) (from official Vicuna team)
   - [Train your own Vicuna on Llama-2](./llm/vicuna-llama-2/)
   - [Self-Hosted Llama-2 Chatbot](./llm/llama-2/)
+  - [Ollama: Quantized LLMs on CPUs](./llm/ollama/)
   - [LoRAX](./llm/lorax/)
   - [QLoRA](https://github.com/artidoro/qlora/pull/132)
   - [LLaMA-LoRA-Tuner](https://github.com/zetavg/LLaMA-LoRA-Tuner#run-on-a-cloud-service-via-skypilot)
   - [Tabby: Self-hosted AI coding assistant](https://github.com/TabbyML/tabby/blob/bed723fcedb44a6b867ce22a7b1f03d2f3531c1e/experimental/eval/skypilot.yaml)
   - [LocalGPT](./llm/localgpt)
   - [Falcon](./llm/falcon)
   - Add yours here & see more in [`llm/`](./llm)!
-- Framework examples: [PyTorch DDP](https://github.com/skypilot-org/skypilot/blob/master/examples/resnet_distributed_torch.yaml), [DeepSpeed](./examples/deepspeed-multinode/sky.yaml), [JAX/Flax on TPU](https://github.com/skypilot-org/skypilot/blob/master/examples/tpu/tpuvm_mnist.yaml), [Stable Diffusion](https://github.com/skypilot-org/skypilot/tree/master/examples/stable_diffusion), [Detectron2](https://github.com/skypilot-org/skypilot/blob/master/examples/detectron2_docker.yaml), [Distributed](https://github.com/skypilot-org/skypilot/blob/master/examples/resnet_distributed_tf_app.py) [TensorFlow](https://github.com/skypilot-org/skypilot/blob/master/examples/resnet_app_storage.yaml), [Ray Train](examples/distributed_ray_train/ray_train.yaml), [NeMo](https://github.com/skypilot-org/skypilot/blob/master/examples/nemo/nemo.yaml), [programmatic grid search](https://github.com/skypilot-org/skypilot/blob/master/examples/huggingface_glue_imdb_grid_search_app.py), [Docker](https://github.com/skypilot-org/skypilot/blob/master/examples/docker/echo_app.yaml), and [many more (`examples/`)](./examples).
+- Framework examples: [PyTorch DDP](https://github.com/skypilot-org/skypilot/blob/master/examples/resnet_distributed_torch.yaml), [DeepSpeed](./examples/deepspeed-multinode/sky.yaml), [JAX/Flax on TPU](https://github.com/skypilot-org/skypilot/blob/master/examples/tpu/tpuvm_mnist.yaml), [Stable Diffusion](https://github.com/skypilot-org/skypilot/tree/master/examples/stable_diffusion), [Detectron2](https://github.com/skypilot-org/skypilot/blob/master/examples/detectron2_docker.yaml), [Distributed](https://github.com/skypilot-org/skypilot/blob/master/examples/resnet_distributed_tf_app.py) [TensorFlow](https://github.com/skypilot-org/skypilot/blob/master/examples/resnet_app_storage.yaml), [Ray Train](examples/distributed_ray_train/ray_train.yaml), [NeMo](https://github.com/skypilot-org/skypilot/blob/master/examples/nemo/nemo.yaml), [programmatic grid search](https://github.com/skypilot-org/skypilot/blob/master/examples/huggingface_glue_imdb_grid_search_app.py), [Docker](https://github.com/skypilot-org/skypilot/blob/master/examples/docker/echo_app.yaml), [Cog](https://github.com/skypilot-org/skypilot/blob/master/examples/cog/), [Unsloth](https://github.com/skypilot-org/skypilot/blob/master/examples/unsloth/unsloth.yaml), [Ollama](https://github.com/skypilot-org/skypilot/blob/master/llm/ollama) and [many more (`examples/`)](./examples).
 
 Follow updates:
 - [Twitter](https://twitter.com/skypilot_org)
 - [Slack](http://slack.skypilot.co)
 - [SkyPilot Blog](https://blog.skypilot.co/) ([Introductory blog post](https://blog.skypilot.co/introducing-skypilot/))
 
 Read the research:
```

### Comparing `skypilot-0.5.0/skypilot.egg-info/SOURCES.txt` & `skypilot-0.6.0/skypilot.egg-info/SOURCES.txt`

 * *Files 7% similar despite different names*

```diff
@@ -19,14 +19,15 @@
 sky/skypilot_config.py
 sky/status_lib.py
 sky/task.py
 sky/adaptors/__init__.py
 sky/adaptors/aws.py
 sky/adaptors/azure.py
 sky/adaptors/cloudflare.py
+sky/adaptors/common.py
 sky/adaptors/cudo.py
 sky/adaptors/docker.py
 sky/adaptors/gcp.py
 sky/adaptors/ibm.py
 sky/adaptors/kubernetes.py
 sky/adaptors/oci.py
 sky/adaptors/runpod.py
@@ -50,14 +51,15 @@
 sky/clouds/cudo.py
 sky/clouds/fluidstack.py
 sky/clouds/gcp.py
 sky/clouds/ibm.py
 sky/clouds/kubernetes.py
 sky/clouds/lambda_cloud.py
 sky/clouds/oci.py
+sky/clouds/paperspace.py
 sky/clouds/runpod.py
 sky/clouds/scp.py
 sky/clouds/vsphere.py
 sky/clouds/service_catalog/__init__.py
 sky/clouds/service_catalog/aws_catalog.py
 sky/clouds/service_catalog/azure_catalog.py
 sky/clouds/service_catalog/common.py
@@ -66,14 +68,15 @@
 sky/clouds/service_catalog/cudo_catalog.py
 sky/clouds/service_catalog/fluidstack_catalog.py
 sky/clouds/service_catalog/gcp_catalog.py
 sky/clouds/service_catalog/ibm_catalog.py
 sky/clouds/service_catalog/kubernetes_catalog.py
 sky/clouds/service_catalog/lambda_catalog.py
 sky/clouds/service_catalog/oci_catalog.py
+sky/clouds/service_catalog/paperspace_catalog.py
 sky/clouds/service_catalog/runpod_catalog.py
 sky/clouds/service_catalog/scp_catalog.py
 sky/clouds/service_catalog/vsphere_catalog.py
 sky/clouds/service_catalog/data_fetchers/__init__.py
 sky/clouds/service_catalog/data_fetchers/fetch_aws.py
 sky/clouds/service_catalog/data_fetchers/fetch_azure.py
 sky/clouds/service_catalog/data_fetchers/fetch_cudo.py
@@ -88,14 +91,24 @@
 sky/clouds/utils/scp_utils.py
 sky/data/__init__.py
 sky/data/data_transfer.py
 sky/data/data_utils.py
 sky/data/mounting_utils.py
 sky/data/storage.py
 sky/data/storage_utils.py
+sky/jobs/__init__.py
+sky/jobs/constants.py
+sky/jobs/controller.py
+sky/jobs/core.py
+sky/jobs/recovery_strategy.py
+sky/jobs/state.py
+sky/jobs/utils.py
+sky/jobs/dashboard/dashboard.py
+sky/jobs/dashboard/static/favicon.ico
+sky/jobs/dashboard/templates/index.html
 sky/provision/__init__.py
 sky/provision/common.py
 sky/provision/docker_utils.py
 sky/provision/instance_setup.py
 sky/provision/logging.py
 sky/provision/metadata_utils.py
 sky/provision/provisioner.py
@@ -121,14 +134,21 @@
 sky/provision/gcp/instance_utils.py
 sky/provision/kubernetes/__init__.py
 sky/provision/kubernetes/config.py
 sky/provision/kubernetes/instance.py
 sky/provision/kubernetes/network.py
 sky/provision/kubernetes/network_utils.py
 sky/provision/kubernetes/utils.py
+sky/provision/kubernetes/manifests/smarter-device-manager-configmap.yaml
+sky/provision/kubernetes/manifests/smarter-device-manager-daemonset.yaml
+sky/provision/paperspace/__init__.py
+sky/provision/paperspace/config.py
+sky/provision/paperspace/constants.py
+sky/provision/paperspace/instance.py
+sky/provision/paperspace/utils.py
 sky/provision/runpod/__init__.py
 sky/provision/runpod/config.py
 sky/provision/runpod/instance.py
 sky/provision/runpod/utils.py
 sky/provision/vsphere/__init__.py
 sky/provision/vsphere/config.py
 sky/provision/vsphere/instance.py
@@ -173,71 +193,54 @@
 sky/skylet/providers/__init__.py
 sky/skylet/providers/command_runner.py
 sky/skylet/providers/azure/__init__.py
 sky/skylet/providers/azure/azure-config-template.json
 sky/skylet/providers/azure/azure-vm-template.json
 sky/skylet/providers/azure/config.py
 sky/skylet/providers/azure/node_provider.py
-sky/skylet/providers/gcp/__init__.py
-sky/skylet/providers/gcp/config.py
-sky/skylet/providers/gcp/constants.py
-sky/skylet/providers/gcp/node.py
-sky/skylet/providers/gcp/node_provider.py
 sky/skylet/providers/ibm/__init__.py
 sky/skylet/providers/ibm/node_provider.py
 sky/skylet/providers/ibm/utils.py
 sky/skylet/providers/ibm/vpc_provider.py
-sky/skylet/providers/kubernetes/__init__.py
-sky/skylet/providers/kubernetes/config.py
-sky/skylet/providers/kubernetes/node_provider.py
 sky/skylet/providers/lambda_cloud/__init__.py
 sky/skylet/providers/lambda_cloud/node_provider.py
 sky/skylet/providers/oci/__init__.py
 sky/skylet/providers/oci/node_provider.py
 sky/skylet/providers/oci/query_helper.py
 sky/skylet/providers/oci/utils.py
 sky/skylet/providers/scp/__init__.py
 sky/skylet/providers/scp/config.py
 sky/skylet/providers/scp/node_provider.py
 sky/skylet/ray_patches/__init__.py
 sky/skylet/ray_patches/autoscaler.py.patch
 sky/skylet/ray_patches/cli.py.patch
 sky/skylet/ray_patches/command_runner.py.patch
-sky/skylet/ray_patches/job_head.py.patch
 sky/skylet/ray_patches/log_monitor.py.patch
 sky/skylet/ray_patches/resource_demand_scheduler.py.patch
 sky/skylet/ray_patches/updater.py.patch
 sky/skylet/ray_patches/worker.py.patch
-sky/spot/__init__.py
-sky/spot/constants.py
-sky/spot/controller.py
-sky/spot/recovery_strategy.py
-sky/spot/spot_state.py
-sky/spot/spot_utils.py
-sky/spot/dashboard/dashboard.py
-sky/spot/dashboard/static/favicon.ico
-sky/spot/dashboard/templates/index.html
 sky/templates/aws-ray.yml.j2
 sky/templates/azure-ray.yml.j2
 sky/templates/cudo-ray.yml.j2
 sky/templates/fluidstack-ray.yml.j2
 sky/templates/gcp-ray.yml.j2
 sky/templates/ibm-ray.yml.j2
+sky/templates/jobs-controller.yaml.j2
 sky/templates/kubernetes-ingress.yml.j2
 sky/templates/kubernetes-loadbalancer.yml.j2
 sky/templates/kubernetes-port-forward-proxy-command.sh.j2
 sky/templates/kubernetes-ray.yml.j2
 sky/templates/kubernetes-ssh-jump.yml.j2
 sky/templates/lambda-ray.yml.j2
 sky/templates/local-ray.yml.j2
 sky/templates/oci-ray.yml.j2
+sky/templates/paperspace-ray.yml.j2
 sky/templates/runpod-ray.yml.j2
 sky/templates/scp-ray.yml.j2
 sky/templates/sky-serve-controller.yaml.j2
-sky/templates/spot-controller.yaml.j2
 sky/templates/vsphere-ray.yml.j2
 sky/usage/__init__.py
 sky/usage/constants.py
 sky/usage/usage_lib.py
 sky/utils/__init__.py
 sky/utils/accelerator_registry.py
 sky/utils/cluster_yaml_utils.py
@@ -259,14 +262,15 @@
 sky/utils/validator.py
 sky/utils/cli_utils/__init__.py
 sky/utils/cli_utils/status_utils.py
 sky/utils/kubernetes/__init__.py
 sky/utils/kubernetes/create_cluster.sh
 sky/utils/kubernetes/delete_cluster.sh
 sky/utils/kubernetes/generate_kind_config.py
+sky/utils/kubernetes/generate_static_kubeconfig.sh
 sky/utils/kubernetes/gpu_labeler.py
 sky/utils/kubernetes/k8s_gpu_labeler_job.yaml
 sky/utils/kubernetes/k8s_gpu_labeler_setup.yaml
 sky/utils/kubernetes/ssh_jump_lifecycle_manager.py
 skypilot.egg-info/PKG-INFO
 skypilot.egg-info/SOURCES.txt
 skypilot.egg-info/dependency_links.txt
@@ -274,16 +278,16 @@
 skypilot.egg-info/requires.txt
 skypilot.egg-info/top_level.txt
 tests/test_api.py
 tests/test_cli.py
 tests/test_config.py
 tests/test_global_user_state.py
 tests/test_jobs.py
+tests/test_jobs_and_serve.py
 tests/test_list_accelerators.py
 tests/test_optimizer_dryruns.py
 tests/test_optimizer_random_dag.py
 tests/test_serve_autoscaler.py
 tests/test_smoke.py
-tests/test_spot.py
 tests/test_storage.py
 tests/test_wheels.py
 tests/test_yaml_parser.py
```

### Comparing `skypilot-0.5.0/skypilot.egg-info/requires.txt` & `skypilot-0.6.0/skypilot.egg-info/requires.txt`

 * *Files 6% similar despite different names*

```diff
@@ -26,28 +26,28 @@
 botocore>=1.29.10
 boto3>=1.26.1
 colorama<0.4.5
 azure-cli>=2.31.0
 azure-core
 azure-identity>=1.13.0
 azure-mgmt-network
-ray[default]!=2.6.0,<=2.6.3,>=2.2.0
+ray[default]!=2.6.0,>=2.2.0
 google-api-python-client>=2.69.0
 google-cloud-storage
 ibm-cloud-sdk-core
 ibm-vpc
 ibm-platform-services
 ibm-cos-sdk
 docker
 oci
 kubernetes>=20.0.0
 protobuf!=3.19.5,>=3.15.3
-pydantic<2.0,>=1.10.8
+pydantic!=2.0.*,!=2.1.*,!=2.2.*,!=2.3.*,!=2.4.*,<3
 runpod>=1.5.1
-cudo-compute>=0.1.8
+cudo-compute>=0.1.10
 pyvmomi==8.0.1.0.2
 
 [all:python_version < "3.10" and sys_platform != "darwin"]
 grpcio!=1.48.0,<=1.51.3,>=1.32.0
 
 [all:python_version < "3.10" and sys_platform == "darwin"]
 grpcio!=1.48.0,<=1.49.1,>=1.32.0
@@ -66,56 +66,58 @@
 colorama<0.4.5
 
 [azure]
 azure-cli>=2.31.0
 azure-core
 azure-identity>=1.13.0
 azure-mgmt-network
-ray[default]!=2.6.0,<=2.6.3,>=2.2.0
+ray[default]!=2.6.0,>=2.2.0
 
 [cloudflare]
 urllib3<2
 awscli>=1.27.10
 botocore>=1.29.10
 boto3>=1.26.1
 colorama<0.4.5
 
 [cudo]
-cudo-compute>=0.1.8
+cudo-compute>=0.1.10
 
 [docker]
 docker
-ray[default]!=2.6.0,<=2.6.3,>=2.2.0
+ray[default]!=2.6.0,>=2.2.0
 
 [fluidstack]
 
 [gcp]
 google-api-python-client>=2.69.0
 google-cloud-storage
 
 [ibm]
 ibm-cloud-sdk-core
 ibm-vpc
 ibm-platform-services
 ibm-cos-sdk
-ray[default]!=2.6.0,<=2.6.3,>=2.2.0
+ray[default]!=2.6.0,>=2.2.0
 
 [kubernetes]
 kubernetes>=20.0.0
 
 [lambda]
-ray[default]!=2.6.0,<=2.6.3,>=2.2.0
+ray[default]!=2.6.0,>=2.2.0
 
 [oci]
 oci
-ray[default]!=2.6.0,<=2.6.3,>=2.2.0
+ray[default]!=2.6.0,>=2.2.0
+
+[paperspace]
 
 [remote]
 protobuf!=3.19.5,>=3.15.3
-pydantic<2.0,>=1.10.8
+pydantic!=2.0.*,!=2.1.*,!=2.2.*,!=2.3.*,!=2.4.*,<3
 
 [remote:python_version < "3.10" and sys_platform != "darwin"]
 grpcio!=1.48.0,<=1.51.3,>=1.32.0
 
 [remote:python_version < "3.10" and sys_platform == "darwin"]
 grpcio!=1.48.0,<=1.49.1,>=1.32.0
 
@@ -125,11 +127,11 @@
 [remote:python_version >= "3.10" and sys_platform == "darwin"]
 grpcio!=1.48.0,<=1.49.1,>=1.42.0
 
 [runpod]
 runpod>=1.5.1
 
 [scp]
-ray[default]!=2.6.0,<=2.6.3,>=2.2.0
+ray[default]!=2.6.0,>=2.2.0
 
 [vsphere]
 pyvmomi==8.0.1.0.2
```

### Comparing `skypilot-0.5.0/tests/test_cli.py` & `skypilot-0.6.0/tests/test_cli.py`

 * *Files 23% similar despite different names*

```diff
@@ -8,47 +8,14 @@
 import sky.cli as cli
 
 CLOUDS_TO_TEST = [
     'aws', 'gcp', 'ibm', 'azure', 'lambda', 'scp', 'oci', 'vsphere'
 ]
 
 
-def test_infer_gpunode_type():
-    resources = [
-        sky.Resources(cloud=sky.AWS(), instance_type='p3.2xlarge'),
-        sky.Resources(cloud=sky.GCP(), accelerators='K80'),
-        sky.Resources(accelerators={'V100': 8}),
-        sky.Resources(cloud=sky.Azure(), accelerators='A100'),
-    ]
-    for spec in resources:
-        assert cli._infer_interactive_node_type(spec) == 'gpunode', spec
-
-
-def test_infer_cpunode_type():
-    resources = [
-        sky.Resources(cloud=sky.AWS(), instance_type='m5.2xlarge'),
-        sky.Resources(cloud=sky.GCP()),
-        sky.Resources(),
-    ]
-    for spec in resources:
-        assert cli._infer_interactive_node_type(spec) == 'cpunode', spec
-
-
-def test_infer_tpunode_type():
-    resources = [
-        sky.Resources(cloud=sky.GCP(), accelerators='tpu-v3-8'),
-        sky.Resources(cloud=sky.GCP(), accelerators='tpu-v2-32'),
-        sky.Resources(cloud=sky.GCP(),
-                      accelerators={'tpu-v2-128': 1},
-                      accelerator_args={'tpu_name': 'tpu'}),
-    ]
-    for spec in resources:
-        assert cli._infer_interactive_node_type(spec) == 'tpunode', spec
-
-
 def test_accelerator_mismatch(enable_all_clouds):
     """Test the specified accelerator does not match the instance_type."""
 
     spec = textwrap.dedent("""\
         resources:
           cloud: aws
           instance_type: p3.2xlarge""")
@@ -77,18 +44,17 @@
 
         _capture_match_gpus_spec(f.name, 'V100:1')
         _capture_match_gpus_spec(f.name, 'v100:1')
         _capture_match_gpus_spec(f.name, 'V100')
 
 
 def test_show_gpus():
-    """
-    This is a test suite for `sky show-gpus` to check functionality (but not correctness).
-    The tests below correspond to the following terminal commands,
-    in order:
+    """Tests `sky show-gpus` can be invoked (but not correctness).
+
+    Tests below correspond to the following terminal commands, in order:
 
     -> sky show-gpus
     -> sky show-gpus --all
     -> sky show-gpus V100:4
     -> sky show-gpus :4
     -> sky show-gpus V100:0
     -> sky show-gpus V100:-2
```

### Comparing `skypilot-0.5.0/tests/test_config.py` & `skypilot-0.6.0/tests/test_config.py`

 * *Files 1% similar despite different names*

```diff
@@ -64,15 +64,15 @@
 
 
 def test_valid_null_proxy_config(monkeypatch, tmp_path) -> None:
     """Test that the config is not loaded if the config file is empty."""
     with open(tmp_path / 'valid.yaml', 'w', encoding='utf-8') as f:
         f.write(f"""\
         aws:
-            instance_tags:
+            labels:
                 mytag: myvalue
             ssh_proxy_command:
                 eu-west-1: null
                 us-east-1: null
             use_internal_ips: true
             vpc_name: abc
```

### Comparing `skypilot-0.5.0/tests/test_jobs.py` & `skypilot-0.6.0/tests/test_jobs.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/tests/test_list_accelerators.py` & `skypilot-0.6.0/tests/test_list_accelerators.py`

 * *Files 0% similar despite different names*

```diff
@@ -10,15 +10,15 @@
     assert 'V100' in result, result
     assert 'tpu-v3' in result, result
     assert 'Inferentia' not in result, result
     assert 'Trainium' not in result, result
     assert 'A100-80GB' in result, result
 
 
-def test_list_ccelerators_all():
+def test_list_accelerators_all():
     result = sky.list_accelerators(gpus_only=False)
     assert 'V100' in result, result
     assert 'tpu-v3' in result, result
     assert 'Inferentia' in result, result
     assert 'Trainium' in result, result
     assert 'A100-80GB' in result, result
```

### Comparing `skypilot-0.5.0/tests/test_optimizer_dryruns.py` & `skypilot-0.6.0/tests/test_optimizer_dryruns.py`

 * *Files 0% similar despite different names*

```diff
@@ -464,16 +464,16 @@
     assert 'in a specific region' in str(e.value)
 
     with pytest.raises(ValueError) as e:
         _test_resources(monkeypatch, image_id='ami-0868a20f5a3bf9702')
     assert 'Cloud must be specified' in str(e.value)
 
     with pytest.raises(ValueError) as e:
-        _test_resources(monkeypatch, cloud=sky.Azure(), image_id='some-image')
-    assert 'only supported for AWS/GCP/IBM/OCI' in str(e.value)
+        _test_resources(monkeypatch, cloud=sky.Lambda(), image_id='some-image')
+    assert 'only supported for AWS/GCP/Azure/IBM/OCI/Kubernetes' in str(e.value)
 
 
 def test_valid_image(monkeypatch):
     _test_resources(monkeypatch,
                     cloud=sky.AWS(),
                     region='us-east-1',
                     image_id='ami-0868a20f5a3bf9702')
@@ -734,15 +734,15 @@
 
 def test_disk_tier_mismatch(enable_all_clouds):
     for cloud in clouds.CLOUD_REGISTRY.values():
         for tier in cloud._SUPPORTED_DISK_TIERS:
             sky.Resources(cloud=cloud, disk_tier=tier)
         for unsupported_tier in (set(resources_utils.DiskTier) -
                                  cloud._SUPPORTED_DISK_TIERS):
-            with pytest.raises(exceptions.NotSupportedError) as e:
+            with pytest.raises(ValueError) as e:
                 sky.Resources(cloud=cloud, disk_tier=unsupported_tier)
             assert f'is not supported' in str(e.value), str(e.value)
 
 
 def test_optimize_disk_tier(enable_all_clouds):
 
     def _get_all_candidate_cloud(r: sky.Resources) -> Set[clouds.Cloud]:
```

### Comparing `skypilot-0.5.0/tests/test_optimizer_random_dag.py` & `skypilot-0.6.0/tests/test_optimizer_random_dag.py`

 * *Files 2% similar despite different names*

```diff
@@ -83,14 +83,16 @@
                         instance_type = 'TPU-VM'
                 resources = sky.Resources(
                     cloud=clouds.CLOUD_REGISTRY.from_str(candidate.cloud),
                     instance_type=instance_type,
                     accelerators={
                         candidate.accelerator_name: candidate.accelerator_count
                     })
+                if not resources.get_valid_regions_for_launchable():
+                    continue
                 requested_features = set()
                 if op.num_nodes > 1:
                     requested_features.add(
                         clouds.CloudImplementationFeatures.MULTI_NODE)
                 try:
                     resources.cloud.check_features_are_supported(
                         resources, requested_features)
```

### Comparing `skypilot-0.5.0/tests/test_serve_autoscaler.py` & `skypilot-0.6.0/tests/test_serve_autoscaler.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/tests/test_smoke.py` & `skypilot-0.6.0/tests/test_smoke.py`

 * *Files 10% similar despite different names*

```diff
@@ -19,11451 +19,13754 @@
 00000120: 6169 6c65 6420 7465 7374 730a 2320 3e20  ailed tests.# > 
 00000130: 7079 7465 7374 202d 2d6c 660a 230a 2320  pytest --lf.#.# 
 00000140: 5275 6e20 6f6e 6520 6f66 2074 6865 2073  Run one of the s
 00000150: 6d6f 6b65 2074 6573 7473 0a23 203e 2070  moke tests.# > p
 00000160: 7974 6573 7420 7465 7374 732f 7465 7374  ytest tests/test
 00000170: 5f73 6d6f 6b65 2e70 793a 3a74 6573 745f  _smoke.py::test_
 00000180: 6d69 6e69 6d61 6c0a 230a 2320 4f6e 6c79  minimal.#.# Only
-00000190: 2072 756e 206d 616e 6167 6564 2073 706f   run managed spo
-000001a0: 7420 7465 7374 730a 2320 3e20 7079 7465  t tests.# > pyte
-000001b0: 7374 2074 6573 7473 2f74 6573 745f 736d  st tests/test_sm
-000001c0: 6f6b 652e 7079 202d 2d6d 616e 6167 6564  oke.py --managed
-000001d0: 2d73 706f 740a 230a 2320 4f6e 6c79 2072  -spot.#.# Only r
-000001e0: 756e 2073 6b79 2073 6572 7665 2074 6573  un sky serve tes
-000001f0: 7473 0a23 203e 2070 7974 6573 7420 7465  ts.# > pytest te
-00000200: 7374 732f 7465 7374 5f73 6d6f 6b65 2e70  sts/test_smoke.p
-00000210: 7920 2d2d 736b 792d 7365 7276 650a 230a  y --sky-serve.#.
-00000220: 2320 4f6e 6c79 2072 756e 2074 6573 7420  # Only run test 
-00000230: 666f 7220 4157 5320 2b20 6765 6e65 7269  for AWS + generi
-00000240: 6320 7465 7374 730a 2320 3e20 7079 7465  c tests.# > pyte
-00000250: 7374 2074 6573 7473 2f74 6573 745f 736d  st tests/test_sm
-00000260: 6f6b 652e 7079 202d 2d61 7773 0a23 0a23  oke.py --aws.#.#
-00000270: 2043 6861 6e67 6520 636c 6f75 6420 666f   Change cloud fo
-00000280: 7220 6765 6e65 7269 6320 7465 7374 7320  r generic tests 
-00000290: 746f 2061 7773 0a23 203e 2070 7974 6573  to aws.# > pytes
-000002a0: 7420 7465 7374 732f 7465 7374 5f73 6d6f  t tests/test_smo
-000002b0: 6b65 2e70 7920 2d2d 6765 6e65 7269 632d  ke.py --generic-
-000002c0: 636c 6f75 6420 6177 730a 0a69 6d70 6f72  cloud aws..impor
-000002d0: 7420 696e 7370 6563 740a 696d 706f 7274  t inspect.import
-000002e0: 206a 736f 6e0a 696d 706f 7274 206f 730a   json.import os.
-000002f0: 696d 706f 7274 2070 6174 686c 6962 0a69  import pathlib.i
-00000300: 6d70 6f72 7420 7368 6c65 780a 696d 706f  mport shlex.impo
-00000310: 7274 2073 6875 7469 6c0a 696d 706f 7274  rt shutil.import
-00000320: 2073 7562 7072 6f63 6573 730a 696d 706f   subprocess.impo
-00000330: 7274 2073 7973 0a69 6d70 6f72 7420 7465  rt sys.import te
-00000340: 6d70 6669 6c65 0a69 6d70 6f72 7420 7469  mpfile.import ti
-00000350: 6d65 0a66 726f 6d20 7479 7069 6e67 2069  me.from typing i
-00000360: 6d70 6f72 7420 4469 6374 2c20 4c69 7374  mport Dict, List
-00000370: 2c20 4e61 6d65 6454 7570 6c65 2c20 4f70  , NamedTuple, Op
-00000380: 7469 6f6e 616c 2c20 5475 706c 650a 696d  tional, Tuple.im
-00000390: 706f 7274 2075 726c 6c69 622e 7061 7273  port urllib.pars
-000003a0: 650a 696d 706f 7274 2075 7569 640a 0a69  e.import uuid..i
-000003b0: 6d70 6f72 7420 636f 6c6f 7261 6d61 0a69  mport colorama.i
-000003c0: 6d70 6f72 7420 6a69 6e6a 6132 0a69 6d70  mport jinja2.imp
-000003d0: 6f72 7420 7079 7465 7374 0a0a 696d 706f  ort pytest..impo
-000003e0: 7274 2073 6b79 0a66 726f 6d20 736b 7920  rt sky.from sky 
-000003f0: 696d 706f 7274 2067 6c6f 6261 6c5f 7573  import global_us
-00000400: 6572 5f73 7461 7465 0a66 726f 6d20 736b  er_state.from sk
-00000410: 7920 696d 706f 7274 2073 6572 7665 0a66  y import serve.f
-00000420: 726f 6d20 736b 7920 696d 706f 7274 2073  rom sky import s
-00000430: 706f 740a 6672 6f6d 2073 6b79 2e61 6461  pot.from sky.ada
-00000440: 7074 6f72 7320 696d 706f 7274 2063 6c6f  ptors import clo
-00000450: 7564 666c 6172 650a 6672 6f6d 2073 6b79  udflare.from sky
-00000460: 2e61 6461 7074 6f72 7320 696d 706f 7274  .adaptors import
-00000470: 2069 626d 0a66 726f 6d20 736b 792e 636c   ibm.from sky.cl
-00000480: 6f75 6473 2069 6d70 6f72 7420 4157 530a  ouds import AWS.
-00000490: 6672 6f6d 2073 6b79 2e63 6c6f 7564 7320  from sky.clouds 
-000004a0: 696d 706f 7274 2041 7a75 7265 0a66 726f  import Azure.fro
-000004b0: 6d20 736b 792e 636c 6f75 6473 2069 6d70  m sky.clouds imp
-000004c0: 6f72 7420 4743 500a 6672 6f6d 2073 6b79  ort GCP.from sky
-000004d0: 2e64 6174 6120 696d 706f 7274 2064 6174  .data import dat
-000004e0: 615f 7574 696c 730a 6672 6f6d 2073 6b79  a_utils.from sky
-000004f0: 2e64 6174 6120 696d 706f 7274 2073 746f  .data import sto
-00000500: 7261 6765 2061 7320 7374 6f72 6167 655f  rage as storage_
-00000510: 6c69 620a 6672 6f6d 2073 6b79 2e64 6174  lib.from sky.dat
-00000520: 612e 6461 7461 5f75 7469 6c73 2069 6d70  a.data_utils imp
-00000530: 6f72 7420 5263 6c6f 6e65 0a66 726f 6d20  ort Rclone.from 
-00000540: 736b 792e 736b 796c 6574 2069 6d70 6f72  sky.skylet impor
-00000550: 7420 6576 656e 7473 0a66 726f 6d20 736b  t events.from sk
-00000560: 792e 7574 696c 7320 696d 706f 7274 2063  y.utils import c
-00000570: 6f6d 6d6f 6e5f 7574 696c 730a 6672 6f6d  ommon_utils.from
-00000580: 2073 6b79 2e75 7469 6c73 2069 6d70 6f72   sky.utils impor
-00000590: 7420 7265 736f 7572 6365 735f 7574 696c  t resources_util
-000005a0: 730a 6672 6f6d 2073 6b79 2e75 7469 6c73  s.from sky.utils
-000005b0: 2069 6d70 6f72 7420 7375 6270 726f 6365   import subproce
-000005c0: 7373 5f75 7469 6c73 0a0a 2320 546f 2061  ss_utils..# To a
-000005d0: 766f 6964 2074 6865 2073 6563 6f6e 6420  void the second 
-000005e0: 736d 6f6b 6520 7465 7374 2072 6575 7369  smoke test reusi
-000005f0: 6e67 2074 6865 2063 6c75 7374 6572 206c  ng the cluster l
-00000600: 6175 6e63 6865 6420 696e 2074 6865 2066  aunched in the f
-00000610: 6972 7374 0a23 2073 6d6f 6b65 2074 6573  irst.# smoke tes
-00000620: 742e 2041 6c73 6f20 7265 7175 6972 6564  t. Also required
-00000630: 2066 6f72 2074 6573 745f 7370 6f74 5f72   for test_spot_r
-00000640: 6563 6f76 6572 7920 746f 206d 616b 6520  ecovery to make 
-00000650: 7375 7265 2074 6865 206d 616e 7561 6c0a  sure the manual.
-00000660: 2320 7465 726d 696e 6174 696f 6e20 7769  # termination wi
-00000670: 7468 2061 7773 2065 6332 2064 6f65 7320  th aws ec2 does 
-00000680: 6e6f 7420 6163 6369 6465 6e74 616c 6c79  not accidentally
-00000690: 2074 6572 6d69 6e61 7465 206f 7468 6572   terminate other
-000006a0: 2073 706f 7420 636c 7573 7465 7273 0a23   spot clusters.#
-000006b0: 2066 726f 6d20 7468 6520 6469 6666 6572   from the differ
-000006c0: 656e 7420 7370 6f74 206c 6175 6e63 6820  ent spot launch 
-000006d0: 7769 7468 2074 6865 2073 616d 6520 636c  with the same cl
-000006e0: 7573 7465 7220 6e61 6d65 2062 7574 2061  uster name but a
-000006f0: 2064 6966 6665 7265 6e74 206a 6f62 0a23   different job.#
-00000700: 2069 642e 0a74 6573 745f 6964 203d 2073   id..test_id = s
-00000710: 7472 2875 7569 642e 7575 6964 3428 2929  tr(uuid.uuid4())
-00000720: 5b2d 323a 5d0a 0a4c 414d 4244 415f 5459  [-2:]..LAMBDA_TY
-00000730: 5045 203d 2027 2d2d 636c 6f75 6420 6c61  PE = '--cloud la
-00000740: 6d62 6461 202d 2d67 7075 7320 4131 3027  mbda --gpus A10'
-00000750: 0a46 4c55 4944 5354 4143 4b5f 5459 5045  .FLUIDSTACK_TYPE
-00000760: 203d 2027 2d2d 636c 6f75 6420 666c 7569   = '--cloud flui
-00000770: 6473 7461 636b 202d 2d67 7075 7320 5254  dstack --gpus RT
-00000780: 5841 3430 3030 270a 0a53 4350 5f54 5950  XA4000'..SCP_TYP
-00000790: 4520 3d20 272d 2d63 6c6f 7564 2073 6370  E = '--cloud scp
-000007a0: 270a 5343 505f 4750 555f 5631 3030 203d  '.SCP_GPU_V100 =
-000007b0: 2027 2d2d 6770 7573 2056 3130 302d 3332   '--gpus V100-32
-000007c0: 4742 270a 0a73 746f 7261 6765 5f73 6574  GB'..storage_set
-000007d0: 7570 5f63 6f6d 6d61 6e64 7320 3d20 5b0a  up_commands = [.
-000007e0: 2020 2020 2774 6f75 6368 207e 2f74 6d70      'touch ~/tmp
-000007f0: 6669 6c65 272c 2027 6d6b 6469 7220 2d70  file', 'mkdir -p
-00000800: 207e 2f74 6d70 2d77 6f72 6b64 6972 272c   ~/tmp-workdir',
-00000810: 0a20 2020 2027 746f 7563 6820 7e2f 746d  .    'touch ~/tm
-00000820: 702d 776f 726b 6469 722f 746d 705c 2066  p-workdir/tmp\ f
-00000830: 696c 6527 2c20 2774 6f75 6368 207e 2f74  ile', 'touch ~/t
-00000840: 6d70 2d77 6f72 6b64 6972 2f74 6d70 5c20  mp-workdir/tmp\ 
-00000850: 6669 6c65 3227 2c0a 2020 2020 2774 6f75  file2',.    'tou
-00000860: 6368 207e 2f74 6d70 2d77 6f72 6b64 6972  ch ~/tmp-workdir
-00000870: 2f66 6f6f 272c 0a20 2020 2027 6c6e 202d  /foo',.    'ln -
-00000880: 6620 2d73 207e 2f74 6d70 2d77 6f72 6b64  f -s ~/tmp-workd
-00000890: 6972 2f20 7e2f 746d 702d 776f 726b 6469  ir/ ~/tmp-workdi
-000008a0: 722f 6369 7263 6c65 2d6c 696e 6b27 2c0a  r/circle-link',.
-000008b0: 2020 2020 2774 6f75 6368 207e 2f2e 7373      'touch ~/.ss
-000008c0: 682f 6964 5f72 7361 2e70 7562 270a 5d0a  h/id_rsa.pub'.].
-000008d0: 0a23 2057 6169 7420 756e 7469 6c20 7468  .# Wait until th
-000008e0: 6520 7370 6f74 2063 6f6e 7472 6f6c 6c65  e spot controlle
-000008f0: 7220 6973 206e 6f74 2069 6e20 494e 4954  r is not in INIT
-00000900: 2073 7461 7465 2e0a 2320 5468 6973 2069   state..# This i
-00000910: 7320 6120 776f 726b 6172 6f75 6e64 2066  s a workaround f
-00000920: 6f72 2074 6865 2069 7373 7565 2074 6861  or the issue tha
-00000930: 7420 7768 656e 206d 756c 7469 706c 6520  t when multiple 
-00000940: 7370 6f74 2074 6573 7473 0a23 2061 7265  spot tests.# are
-00000950: 2072 756e 6e69 6e67 2069 6e20 7061 7261   running in para
-00000960: 6c6c 656c 2c20 7468 6520 7370 6f74 2063  llel, the spot c
-00000970: 6f6e 7472 6f6c 6c65 7220 6d61 7920 6265  ontroller may be
-00000980: 2069 6e20 494e 4954 2061 6e64 0a23 2074   in INIT and.# t
-00000990: 6865 2073 706f 7420 7175 6575 652f 6361  he spot queue/ca
-000009a0: 6e63 656c 2063 6f6d 6d61 6e64 2077 696c  ncel command wil
-000009b0: 6c20 7265 7475 726e 2073 7461 6c65 6420  l return staled 
-000009c0: 7461 626c 652e 0a5f 5350 4f54 5f51 5545  table.._SPOT_QUE
-000009d0: 5545 5f57 4149 5420 3d20 2827 733d 2428  UE_WAIT = ('s=$(
-000009e0: 736b 7920 7370 6f74 2071 7565 7565 293b  sky spot queue);
-000009f0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-00000a00: 2020 2020 2020 2027 756e 7469 6c20 5b20         'until [ 
-00000a10: 6065 6368 6f20 2224 7322 2027 0a20 2020  `echo "$s" '.   
-00000a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000a30: 2027 7c20 6772 6570 2022 6a6f 6273 2077   '| grep "jobs w
-00000a40: 696c 6c20 6e6f 7420 6265 2073 686f 776e  ill not be shown
-00000a50: 2075 6e74 696c 2069 7420 6265 636f 6d65   until it become
-00000a60: 7320 5550 2e22 2027 0a20 2020 2020 2020  s UP." '.       
-00000a70: 2020 2020 2020 2020 2020 2020 2027 7c20               '| 
-00000a80: 7763 202d 6c60 202d 6571 2030 205d 3b20  wc -l` -eq 0 ]; 
-00000a90: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00000aa0: 2020 2020 2020 2764 6f20 6563 686f 2022        'do echo "
-00000ab0: 5761 6974 696e 6720 666f 7220 7370 6f74  Waiting for spot
-00000ac0: 2071 7565 7565 2074 6f20 6265 2072 6561   queue to be rea
-00000ad0: 6479 2e2e 2e22 3b20 270a 2020 2020 2020  dy..."; '.      
-00000ae0: 2020 2020 2020 2020 2020 2020 2020 2773                's
-00000af0: 6c65 6570 2035 3b20 733d 2428 736b 7920  leep 5; s=$(sky 
-00000b00: 7370 6f74 2071 7565 7565 293b 2064 6f6e  spot queue); don
-00000b10: 653b 2065 6368 6f20 2224 7322 3b20 270a  e; echo "$s"; '.
-00000b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000b30: 2020 2020 2765 6368 6f3b 2065 6368 6f3b      'echo; echo;
-00000b40: 2065 6368 6f20 2224 7322 2729 0a5f 5350   echo "$s"')._SP
-00000b50: 4f54 5f43 414e 4345 4c5f 5741 4954 203d  OT_CANCEL_WAIT =
-00000b60: 2028 0a20 2020 2027 733d 2428 736b 7920   (.    's=$(sky 
-00000b70: 7370 6f74 2063 616e 6365 6c20 2d79 202d  spot cancel -y -
-00000b80: 6e20 7b6a 6f62 5f6e 616d 657d 293b 2075  n {job_name}); u
-00000b90: 6e74 696c 205b 2060 6563 686f 2022 2473  ntil [ `echo "$s
-00000ba0: 2220 270a 2020 2020 277c 2067 7265 7020  " '.    '| grep 
-00000bb0: 2250 6c65 6173 6520 7761 6974 2066 6f72  "Please wait for
-00000bc0: 2074 6865 2063 6f6e 7472 6f6c 6c65 7220   the controller 
-00000bd0: 746f 2062 6520 7265 6164 792e 2220 270a  to be ready." '.
-00000be0: 2020 2020 277c 2077 6320 2d6c 6020 2d65      '| wc -l` -e
-00000bf0: 7120 3020 5d3b 2064 6f20 6563 686f 2022  q 0 ]; do echo "
-00000c00: 5761 6974 696e 6720 666f 7220 7468 6520  Waiting for the 
-00000c10: 7370 6f74 2063 6f6e 7472 6f6c 6c65 7220  spot controller 
-00000c20: 270a 2020 2020 2774 6f20 6265 2072 6561  '.    'to be rea
-00000c30: 6479 223b 2073 6c65 6570 2035 3b20 733d  dy"; sleep 5; s=
-00000c40: 2428 736b 7920 7370 6f74 2063 616e 6365  $(sky spot cance
-00000c50: 6c20 2d79 202d 6e20 7b6a 6f62 5f6e 616d  l -y -n {job_nam
-00000c60: 657d 293b 2027 0a20 2020 2027 646f 6e65  e}); '.    'done
-00000c70: 3b20 6563 686f 2022 2473 223b 2065 6368  ; echo "$s"; ech
-00000c80: 6f3b 2065 6368 6f3b 2065 6368 6f20 2224  o; echo; echo "$
-00000c90: 7322 2729 0a23 2054 4f44 4f28 7a68 7775  s"').# TODO(zhwu
-00000ca0: 293a 206d 616b 6520 7468 6520 7370 6f74  ): make the spot
-00000cb0: 2063 6f6e 7472 6f6c 6c65 7220 6f6e 2047   controller on G
-00000cc0: 4350 2e0a 0a44 4546 4155 4c54 5f43 4d44  CP...DEFAULT_CMD
-00000cd0: 5f54 494d 454f 5554 203d 2031 3520 2a20  _TIMEOUT = 15 * 
-00000ce0: 3630 0a0a 0a63 6c61 7373 2054 6573 7428  60...class Test(
-00000cf0: 4e61 6d65 6454 7570 6c65 293a 0a20 2020  NamedTuple):.   
-00000d00: 206e 616d 653a 2073 7472 0a20 2020 2023   name: str.    #
-00000d10: 2045 6163 6820 636f 6d6d 616e 6420 6973   Each command is
-00000d20: 2065 7865 6375 7465 6420 7365 7269 616c   executed serial
-00000d30: 6c79 2e20 2049 6620 616e 7920 6661 696c  ly.  If any fail
-00000d40: 6564 2c20 7468 6520 7265 6d61 696e 696e  ed, the remainin
-00000d50: 6720 636f 6d6d 616e 6473 0a20 2020 2023  g commands.    #
-00000d60: 2061 7265 206e 6f74 2072 756e 2061 6e64   are not run and
-00000d70: 2074 6865 2074 6573 7420 6973 2074 7265   the test is tre
-00000d80: 6174 6564 2061 7320 6661 696c 6564 2e0a  ated as failed..
-00000d90: 2020 2020 636f 6d6d 616e 6473 3a20 4c69      commands: Li
-00000da0: 7374 5b73 7472 5d0a 2020 2020 7465 6172  st[str].    tear
-00000db0: 646f 776e 3a20 4f70 7469 6f6e 616c 5b73  down: Optional[s
-00000dc0: 7472 5d20 3d20 4e6f 6e65 0a20 2020 2023  tr] = None.    #
-00000dd0: 2054 696d 656f 7574 2066 6f72 2065 6163   Timeout for eac
-00000de0: 6820 636f 6d6d 616e 6420 696e 2073 6563  h command in sec
-00000df0: 6f6e 6473 2e0a 2020 2020 7469 6d65 6f75  onds..    timeou
-00000e00: 743a 2069 6e74 203d 2044 4546 4155 4c54  t: int = DEFAULT
-00000e10: 5f43 4d44 5f54 494d 454f 5554 0a0a 2020  _CMD_TIMEOUT..  
-00000e20: 2020 6465 6620 6563 686f 2873 656c 662c    def echo(self,
-00000e30: 206d 6573 7361 6765 3a20 7374 7229 3a0a   message: str):.
-00000e40: 2020 2020 2020 2020 2320 7079 7465 7374          # pytest
-00000e50: 2773 2078 6469 7374 2070 6c75 6769 6e20  's xdist plugin 
-00000e60: 6361 7074 7572 6573 2073 7464 6f75 743b  captures stdout;
-00000e70: 2070 7269 6e74 2074 6f20 7374 6465 7272   print to stderr
-00000e80: 2073 6f20 7468 6174 2074 6865 0a20 2020   so that the.   
-00000e90: 2020 2020 2023 206c 6f67 7320 6172 6520       # logs are 
-00000ea0: 7374 7265 616d 696e 6720 7768 696c 6520  streaming while 
-00000eb0: 7468 6520 7465 7374 7320 6172 6520 7275  the tests are ru
-00000ec0: 6e6e 696e 672e 0a20 2020 2020 2020 2070  nning..        p
-00000ed0: 7265 6669 7820 3d20 6627 5b7b 7365 6c66  refix = f'[{self
-00000ee0: 2e6e 616d 657d 5d27 0a20 2020 2020 2020  .name}]'.       
-00000ef0: 206d 6573 7361 6765 203d 2066 277b 7072   message = f'{pr
-00000f00: 6566 6978 7d20 7b6d 6573 7361 6765 7d27  efix} {message}'
-00000f10: 0a20 2020 2020 2020 206d 6573 7361 6765  .        message
-00000f20: 203d 206d 6573 7361 6765 2e72 6570 6c61   = message.repla
-00000f30: 6365 2827 5c6e 272c 2066 275c 6e7b 7072  ce('\n', f'\n{pr
-00000f40: 6566 6978 7d20 2729 0a20 2020 2020 2020  efix} ').       
-00000f50: 2070 7269 6e74 286d 6573 7361 6765 2c20   print(message, 
-00000f60: 6669 6c65 3d73 7973 2e73 7464 6572 722c  file=sys.stderr,
-00000f70: 2066 6c75 7368 3d54 7275 6529 0a0a 0a64   flush=True)...d
-00000f80: 6566 205f 6765 745f 7469 6d65 6f75 7428  ef _get_timeout(
-00000f90: 6765 6e65 7269 635f 636c 6f75 643a 2073  generic_cloud: s
-00000fa0: 7472 2c0a 2020 2020 2020 2020 2020 2020  tr,.            
-00000fb0: 2020 2020 206f 7665 7272 6964 655f 7469       override_ti
-00000fc0: 6d65 6f75 743a 2069 6e74 203d 2044 4546  meout: int = DEF
-00000fd0: 4155 4c54 5f43 4d44 5f54 494d 454f 5554  AULT_CMD_TIMEOUT
-00000fe0: 293a 0a20 2020 2074 696d 656f 7574 7320  ):.    timeouts 
-00000ff0: 3d20 7b27 666c 7569 6473 7461 636b 273a  = {'fluidstack':
-00001000: 2036 3020 2a20 3630 7d20 2023 2066 696c   60 * 60}  # fil
-00001010: 655f 6d6f 756e 7473 0a20 2020 2072 6574  e_mounts.    ret
-00001020: 7572 6e20 7469 6d65 6f75 7473 2e67 6574  urn timeouts.get
-00001030: 2867 656e 6572 6963 5f63 6c6f 7564 2c20  (generic_cloud, 
-00001040: 6f76 6572 7269 6465 5f74 696d 656f 7574  override_timeout
-00001050: 290a 0a0a 6465 6620 5f67 6574 5f63 6c75  )...def _get_clu
-00001060: 7374 6572 5f6e 616d 6528 2920 2d3e 2073  ster_name() -> s
-00001070: 7472 3a0a 2020 2020 2222 2252 6574 7572  tr:.    """Retur
-00001080: 6e73 2061 2075 7365 722d 756e 6971 7565  ns a user-unique
-00001090: 2063 6c75 7374 6572 206e 616d 6520 666f   cluster name fo
-000010a0: 7220 6561 6368 2074 6573 745f 3c6e 616d  r each test_<nam
-000010b0: 653e 2829 2e0a 0a20 2020 204d 7573 7420  e>()...    Must 
-000010c0: 6265 2063 616c 6c65 6420 6672 6f6d 2065  be called from e
-000010d0: 6163 6820 7465 7374 5f3c 6e61 6d65 3e28  ach test_<name>(
-000010e0: 292e 0a20 2020 2022 2222 0a20 2020 2063  )..    """.    c
-000010f0: 616c 6c65 725f 6675 6e63 5f6e 616d 6520  aller_func_name 
-00001100: 3d20 696e 7370 6563 742e 7374 6163 6b28  = inspect.stack(
-00001110: 295b 315d 5b33 5d0a 2020 2020 7465 7374  )[1][3].    test
-00001120: 5f6e 616d 6520 3d20 6361 6c6c 6572 5f66  _name = caller_f
-00001130: 756e 635f 6e61 6d65 2e72 6570 6c61 6365  unc_name.replace
-00001140: 2827 5f27 2c20 272d 2729 2e72 6570 6c61  ('_', '-').repla
-00001150: 6365 2827 7465 7374 2d27 2c20 2774 2d27  ce('test-', 't-'
-00001160: 290a 2020 2020 7465 7374 5f6e 616d 6520  ).    test_name 
-00001170: 3d20 636f 6d6d 6f6e 5f75 7469 6c73 2e6d  = common_utils.m
-00001180: 616b 655f 636c 7573 7465 725f 6e61 6d65  ake_cluster_name
-00001190: 5f6f 6e5f 636c 6f75 6428 7465 7374 5f6e  _on_cloud(test_n
-000011a0: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
-000011b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000011c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000011d0: 2020 2020 2020 2020 2020 2020 2032 342c               24,
+00000190: 2072 756e 206d 616e 6167 6564 206a 6f62   run managed job
+000001a0: 2074 6573 7473 0a23 203e 2070 7974 6573   tests.# > pytes
+000001b0: 7420 7465 7374 732f 7465 7374 5f73 6d6f  t tests/test_smo
+000001c0: 6b65 2e70 7920 2d2d 6d61 6e61 6765 642d  ke.py --managed-
+000001d0: 6a6f 6273 0a23 0a23 204f 6e6c 7920 7275  jobs.#.# Only ru
+000001e0: 6e20 736b 7920 7365 7276 6520 7465 7374  n sky serve test
+000001f0: 730a 2320 3e20 7079 7465 7374 2074 6573  s.# > pytest tes
+00000200: 7473 2f74 6573 745f 736d 6f6b 652e 7079  ts/test_smoke.py
+00000210: 202d 2d73 6b79 2d73 6572 7665 0a23 0a23   --sky-serve.#.#
+00000220: 204f 6e6c 7920 7275 6e20 7465 7374 2066   Only run test f
+00000230: 6f72 2041 5753 202b 2067 656e 6572 6963  or AWS + generic
+00000240: 2074 6573 7473 0a23 203e 2070 7974 6573   tests.# > pytes
+00000250: 7420 7465 7374 732f 7465 7374 5f73 6d6f  t tests/test_smo
+00000260: 6b65 2e70 7920 2d2d 6177 730a 230a 2320  ke.py --aws.#.# 
+00000270: 4368 616e 6765 2063 6c6f 7564 2066 6f72  Change cloud for
+00000280: 2067 656e 6572 6963 2074 6573 7473 2074   generic tests t
+00000290: 6f20 6177 730a 2320 3e20 7079 7465 7374  o aws.# > pytest
+000002a0: 2074 6573 7473 2f74 6573 745f 736d 6f6b   tests/test_smok
+000002b0: 652e 7079 202d 2d67 656e 6572 6963 2d63  e.py --generic-c
+000002c0: 6c6f 7564 2061 7773 0a0a 696d 706f 7274  loud aws..import
+000002d0: 2069 6e73 7065 6374 0a69 6d70 6f72 7420   inspect.import 
+000002e0: 6a73 6f6e 0a69 6d70 6f72 7420 6f73 0a69  json.import os.i
+000002f0: 6d70 6f72 7420 7061 7468 6c69 620a 696d  mport pathlib.im
+00000300: 706f 7274 2073 686c 6578 0a69 6d70 6f72  port shlex.impor
+00000310: 7420 7368 7574 696c 0a69 6d70 6f72 7420  t shutil.import 
+00000320: 7375 6270 726f 6365 7373 0a69 6d70 6f72  subprocess.impor
+00000330: 7420 7379 730a 696d 706f 7274 2074 656d  t sys.import tem
+00000340: 7066 696c 650a 696d 706f 7274 2074 696d  pfile.import tim
+00000350: 650a 6672 6f6d 2074 7970 696e 6720 696d  e.from typing im
+00000360: 706f 7274 2044 6963 742c 204c 6973 742c  port Dict, List,
+00000370: 204e 616d 6564 5475 706c 652c 204f 7074   NamedTuple, Opt
+00000380: 696f 6e61 6c2c 2054 7570 6c65 0a69 6d70  ional, Tuple.imp
+00000390: 6f72 7420 7572 6c6c 6962 2e70 6172 7365  ort urllib.parse
+000003a0: 0a69 6d70 6f72 7420 7575 6964 0a0a 696d  .import uuid..im
+000003b0: 706f 7274 2063 6f6c 6f72 616d 610a 696d  port colorama.im
+000003c0: 706f 7274 206a 696e 6a61 320a 696d 706f  port jinja2.impo
+000003d0: 7274 2070 7974 6573 740a 0a69 6d70 6f72  rt pytest..impor
+000003e0: 7420 736b 790a 6672 6f6d 2073 6b79 2069  t sky.from sky i
+000003f0: 6d70 6f72 7420 676c 6f62 616c 5f75 7365  mport global_use
+00000400: 725f 7374 6174 650a 6672 6f6d 2073 6b79  r_state.from sky
+00000410: 2069 6d70 6f72 7420 6a6f 6273 0a66 726f   import jobs.fro
+00000420: 6d20 736b 7920 696d 706f 7274 2073 6572  m sky import ser
+00000430: 7665 0a66 726f 6d20 736b 792e 6164 6170  ve.from sky.adap
+00000440: 746f 7273 2069 6d70 6f72 7420 636c 6f75  tors import clou
+00000450: 6466 6c61 7265 0a66 726f 6d20 736b 792e  dflare.from sky.
+00000460: 6164 6170 746f 7273 2069 6d70 6f72 7420  adaptors import 
+00000470: 6962 6d0a 6672 6f6d 2073 6b79 2e63 6c6f  ibm.from sky.clo
+00000480: 7564 7320 696d 706f 7274 2041 5753 0a66  uds import AWS.f
+00000490: 726f 6d20 736b 792e 636c 6f75 6473 2069  rom sky.clouds i
+000004a0: 6d70 6f72 7420 417a 7572 650a 6672 6f6d  mport Azure.from
+000004b0: 2073 6b79 2e63 6c6f 7564 7320 696d 706f   sky.clouds impo
+000004c0: 7274 2047 4350 0a66 726f 6d20 736b 792e  rt GCP.from sky.
+000004d0: 6461 7461 2069 6d70 6f72 7420 6461 7461  data import data
+000004e0: 5f75 7469 6c73 0a66 726f 6d20 736b 792e  _utils.from sky.
+000004f0: 6461 7461 2069 6d70 6f72 7420 7374 6f72  data import stor
+00000500: 6167 6520 6173 2073 746f 7261 6765 5f6c  age as storage_l
+00000510: 6962 0a66 726f 6d20 736b 792e 6461 7461  ib.from sky.data
+00000520: 2e64 6174 615f 7574 696c 7320 696d 706f  .data_utils impo
+00000530: 7274 2052 636c 6f6e 650a 6672 6f6d 2073  rt Rclone.from s
+00000540: 6b79 2e73 6b79 6c65 7420 696d 706f 7274  ky.skylet import
+00000550: 2065 7665 6e74 730a 6672 6f6d 2073 6b79   events.from sky
+00000560: 2e75 7469 6c73 2069 6d70 6f72 7420 636f  .utils import co
+00000570: 6d6d 6f6e 5f75 7469 6c73 0a66 726f 6d20  mmon_utils.from 
+00000580: 736b 792e 7574 696c 7320 696d 706f 7274  sky.utils import
+00000590: 2072 6573 6f75 7263 6573 5f75 7469 6c73   resources_utils
+000005a0: 0a66 726f 6d20 736b 792e 7574 696c 7320  .from sky.utils 
+000005b0: 696d 706f 7274 2073 7562 7072 6f63 6573  import subproces
+000005c0: 735f 7574 696c 730a 0a23 2054 6f20 6176  s_utils..# To av
+000005d0: 6f69 6420 7468 6520 7365 636f 6e64 2073  oid the second s
+000005e0: 6d6f 6b65 2074 6573 7420 7265 7573 696e  moke test reusin
+000005f0: 6720 7468 6520 636c 7573 7465 7220 6c61  g the cluster la
+00000600: 756e 6368 6564 2069 6e20 7468 6520 6669  unched in the fi
+00000610: 7273 740a 2320 736d 6f6b 6520 7465 7374  rst.# smoke test
+00000620: 2e20 416c 736f 2072 6571 7569 7265 6420  . Also required 
+00000630: 666f 7220 7465 7374 5f6d 616e 6167 6564  for test_managed
+00000640: 5f6a 6f62 735f 7265 636f 7665 7279 2074  _jobs_recovery t
+00000650: 6f20 6d61 6b65 2073 7572 6520 7468 650a  o make sure the.
+00000660: 2320 6d61 6e75 616c 2074 6572 6d69 6e61  # manual termina
+00000670: 7469 6f6e 2077 6974 6820 6177 7320 6563  tion with aws ec
+00000680: 3220 646f 6573 206e 6f74 2061 6363 6964  2 does not accid
+00000690: 656e 7461 6c6c 7920 7465 726d 696e 6174  entally terminat
+000006a0: 6520 6f74 6865 7220 636c 7573 7465 7273  e other clusters
+000006b0: 0a23 2066 6f72 2066 6f72 2074 6865 2064  .# for for the d
+000006c0: 6966 6665 7265 6e74 206d 616e 6167 6564  ifferent managed
+000006d0: 206a 6f62 7320 6c61 756e 6368 2077 6974   jobs launch wit
+000006e0: 6820 7468 6520 7361 6d65 206a 6f62 206e  h the same job n
+000006f0: 616d 6520 6275 7420 610a 2320 6469 6666  ame but a.# diff
+00000700: 6572 656e 7420 6a6f 6220 6964 2e0a 7465  erent job id..te
+00000710: 7374 5f69 6420 3d20 7374 7228 7575 6964  st_id = str(uuid
+00000720: 2e75 7569 6434 2829 295b 2d32 3a5d 0a0a  .uuid4())[-2:]..
+00000730: 4c41 4d42 4441 5f54 5950 4520 3d20 272d  LAMBDA_TYPE = '-
+00000740: 2d63 6c6f 7564 206c 616d 6264 6120 2d2d  -cloud lambda --
+00000750: 6770 7573 2041 3130 270a 464c 5549 4453  gpus A10'.FLUIDS
+00000760: 5441 434b 5f54 5950 4520 3d20 272d 2d63  TACK_TYPE = '--c
+00000770: 6c6f 7564 2066 6c75 6964 7374 6163 6b20  loud fluidstack 
+00000780: 2d2d 6770 7573 2052 5458 4134 3030 3027  --gpus RTXA4000'
+00000790: 0a0a 5343 505f 5459 5045 203d 2027 2d2d  ..SCP_TYPE = '--
+000007a0: 636c 6f75 6420 7363 7027 0a53 4350 5f47  cloud scp'.SCP_G
+000007b0: 5055 5f56 3130 3020 3d20 272d 2d67 7075  PU_V100 = '--gpu
+000007c0: 7320 5631 3030 2d33 3247 4227 0a0a 7374  s V100-32GB'..st
+000007d0: 6f72 6167 655f 7365 7475 705f 636f 6d6d  orage_setup_comm
+000007e0: 616e 6473 203d 205b 0a20 2020 2027 746f  ands = [.    'to
+000007f0: 7563 6820 7e2f 746d 7066 696c 6527 2c20  uch ~/tmpfile', 
+00000800: 276d 6b64 6972 202d 7020 7e2f 746d 702d  'mkdir -p ~/tmp-
+00000810: 776f 726b 6469 7227 2c0a 2020 2020 2774  workdir',.    't
+00000820: 6f75 6368 207e 2f74 6d70 2d77 6f72 6b64  ouch ~/tmp-workd
+00000830: 6972 2f74 6d70 5c20 6669 6c65 272c 2027  ir/tmp\ file', '
+00000840: 746f 7563 6820 7e2f 746d 702d 776f 726b  touch ~/tmp-work
+00000850: 6469 722f 746d 705c 2066 696c 6532 272c  dir/tmp\ file2',
+00000860: 0a20 2020 2027 746f 7563 6820 7e2f 746d  .    'touch ~/tm
+00000870: 702d 776f 726b 6469 722f 666f 6f27 2c0a  p-workdir/foo',.
+00000880: 2020 2020 275b 2021 202d 6520 7e2f 746d      '[ ! -e ~/tm
+00000890: 702d 776f 726b 6469 722f 6369 7263 6c65  p-workdir/circle
+000008a0: 2d6c 696e 6b20 5d20 2626 206c 6e20 2d73  -link ] && ln -s
+000008b0: 207e 2f74 6d70 2d77 6f72 6b64 6972 2f20   ~/tmp-workdir/ 
+000008c0: 7e2f 746d 702d 776f 726b 6469 722f 6369  ~/tmp-workdir/ci
+000008d0: 7263 6c65 2d6c 696e 6b20 7c7c 2074 7275  rcle-link || tru
+000008e0: 6527 2c0a 2020 2020 2774 6f75 6368 207e  e',.    'touch ~
+000008f0: 2f2e 7373 682f 6964 5f72 7361 2e70 7562  /.ssh/id_rsa.pub
+00000900: 270a 5d0a 0a23 2057 6169 7420 756e 7469  '.]..# Wait unti
+00000910: 6c20 7468 6520 6a6f 6273 2063 6f6e 7472  l the jobs contr
+00000920: 6f6c 6c65 7220 6973 206e 6f74 2069 6e20  oller is not in 
+00000930: 494e 4954 2073 7461 7465 2e0a 2320 5468  INIT state..# Th
+00000940: 6973 2069 7320 6120 776f 726b 6172 6f75  is is a workarou
+00000950: 6e64 2066 6f72 2074 6865 2069 7373 7565  nd for the issue
+00000960: 2074 6861 7420 7768 656e 206d 756c 7469   that when multi
+00000970: 706c 6520 6a6f 6220 7465 7374 730a 2320  ple job tests.# 
+00000980: 6172 6520 7275 6e6e 696e 6720 696e 2070  are running in p
+00000990: 6172 616c 6c65 6c2c 2074 6865 206a 6f62  arallel, the job
+000009a0: 7320 636f 6e74 726f 6c6c 6572 206d 6179  s controller may
+000009b0: 2062 6520 696e 2049 4e49 5420 616e 640a   be in INIT and.
+000009c0: 2320 7468 6520 6a6f 6220 7175 6575 652f  # the job queue/
+000009d0: 6361 6e63 656c 2063 6f6d 6d61 6e64 2077  cancel command w
+000009e0: 696c 6c20 7265 7475 726e 2073 7461 6c65  ill return stale
+000009f0: 6420 7461 626c 652e 0a5f 4a4f 425f 5155  d table.._JOB_QU
+00000a00: 4555 455f 5741 4954 203d 2028 2773 3d24  EUE_WAIT = ('s=$
+00000a10: 2873 6b79 206a 6f62 7320 7175 6575 6529  (sky jobs queue)
+00000a20: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
+00000a30: 2020 2020 2020 2027 756e 7469 6c20 2120         'until ! 
+00000a40: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
+00000a50: 2022 6a6f 6273 2077 696c 6c20 6e6f 7420   "jobs will not 
+00000a60: 6265 2073 686f 776e 2075 6e74 696c 223b  be shown until";
+00000a70: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+00000a80: 2020 2020 2020 2764 6f20 6563 686f 2022        'do echo "
+00000a90: 5761 6974 696e 6720 666f 7220 6a6f 6220  Waiting for job 
+00000aa0: 7175 6575 6520 746f 2062 6520 7265 6164  queue to be read
+00000ab0: 792e 2e2e 223b 2027 0a20 2020 2020 2020  y..."; '.       
+00000ac0: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+00000ad0: 6570 2035 3b20 733d 2428 736b 7920 6a6f  ep 5; s=$(sky jo
+00000ae0: 6273 2071 7565 7565 293b 2064 6f6e 653b  bs queue); done;
+00000af0: 2065 6368 6f20 2224 7322 3b20 270a 2020   echo "$s"; '.  
+00000b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000b10: 2027 6563 686f 3b20 6563 686f 3b20 6563   'echo; echo; ec
+00000b20: 686f 2022 2473 2227 290a 5f4a 4f42 5f43  ho "$s"')._JOB_C
+00000b30: 414e 4345 4c5f 5741 4954 203d 2028 0a20  ANCEL_WAIT = (. 
+00000b40: 2020 2027 733d 2428 736b 7920 6a6f 6273     's=$(sky jobs
+00000b50: 2063 616e 6365 6c20 2d79 202d 6e20 7b6a   cancel -y -n {j
+00000b60: 6f62 5f6e 616d 657d 293b 2027 0a20 2020  ob_name}); '.   
+00000b70: 2027 756e 7469 6c20 2120 6563 686f 2022   'until ! echo "
+00000b80: 2473 2220 7c20 6772 6570 2022 506c 6561  $s" | grep "Plea
+00000b90: 7365 2077 6169 7420 666f 7220 7468 6520  se wait for the 
+00000ba0: 636f 6e74 726f 6c6c 6572 2074 6f20 6265  controller to be
+00000bb0: 2072 6561 6479 2e22 3b20 270a 2020 2020   ready."; '.    
+00000bc0: 2764 6f20 6563 686f 2022 5761 6974 696e  'do echo "Waitin
+00000bd0: 6720 666f 7220 7468 6520 6a6f 6273 2063  g for the jobs c
+00000be0: 6f6e 7472 6f6c 6c65 7220 270a 2020 2020  ontroller '.    
+00000bf0: 2774 6f20 6265 2072 6561 6479 223b 2073  'to be ready"; s
+00000c00: 6c65 6570 2035 3b20 733d 2428 736b 7920  leep 5; s=$(sky 
+00000c10: 6a6f 6273 2063 616e 6365 6c20 2d79 202d  jobs cancel -y -
+00000c20: 6e20 7b6a 6f62 5f6e 616d 657d 293b 2027  n {job_name}); '
+00000c30: 0a20 2020 2027 646f 6e65 3b20 6563 686f  .    'done; echo
+00000c40: 2022 2473 223b 2065 6368 6f3b 2065 6368   "$s"; echo; ech
+00000c50: 6f3b 2065 6368 6f20 2224 7322 2729 0a23  o; echo "$s"').#
+00000c60: 2054 4f44 4f28 7a68 7775 293a 206d 616b   TODO(zhwu): mak
+00000c70: 6520 7468 6520 6a6f 6273 2063 6f6e 7472  e the jobs contr
+00000c80: 6f6c 6c65 7220 6f6e 2047 4350 2c20 746f  oller on GCP, to
+00000c90: 2061 766f 6964 2070 6172 616c 6c65 6c20   avoid parallel 
+00000ca0: 7465 7374 2069 7373 7565 730a 2320 7768  test issues.# wh
+00000cb0: 656e 2074 6865 2063 6f6e 7472 6f6c 6c65  en the controlle
+00000cc0: 7220 6265 696e 6720 6f6e 2041 7a75 7265  r being on Azure
+00000cd0: 2c20 7768 6963 6820 7461 6b65 7320 6120  , which takes a 
+00000ce0: 6c6f 6e67 2074 696d 6520 666f 7220 6c61  long time for la
+00000cf0: 756e 6368 696e 670a 2320 7374 6570 2e0a  unching.# step..
+00000d00: 0a44 4546 4155 4c54 5f43 4d44 5f54 494d  .DEFAULT_CMD_TIM
+00000d10: 454f 5554 203d 2031 3520 2a20 3630 0a0a  EOUT = 15 * 60..
+00000d20: 0a63 6c61 7373 2054 6573 7428 4e61 6d65  .class Test(Name
+00000d30: 6454 7570 6c65 293a 0a20 2020 206e 616d  dTuple):.    nam
+00000d40: 653a 2073 7472 0a20 2020 2023 2045 6163  e: str.    # Eac
+00000d50: 6820 636f 6d6d 616e 6420 6973 2065 7865  h command is exe
+00000d60: 6375 7465 6420 7365 7269 616c 6c79 2e20  cuted serially. 
+00000d70: 2049 6620 616e 7920 6661 696c 6564 2c20   If any failed, 
+00000d80: 7468 6520 7265 6d61 696e 696e 6720 636f  the remaining co
+00000d90: 6d6d 616e 6473 0a20 2020 2023 2061 7265  mmands.    # are
+00000da0: 206e 6f74 2072 756e 2061 6e64 2074 6865   not run and the
+00000db0: 2074 6573 7420 6973 2074 7265 6174 6564   test is treated
+00000dc0: 2061 7320 6661 696c 6564 2e0a 2020 2020   as failed..    
+00000dd0: 636f 6d6d 616e 6473 3a20 4c69 7374 5b73  commands: List[s
+00000de0: 7472 5d0a 2020 2020 7465 6172 646f 776e  tr].    teardown
+00000df0: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
+00000e00: 3d20 4e6f 6e65 0a20 2020 2023 2054 696d  = None.    # Tim
+00000e10: 656f 7574 2066 6f72 2065 6163 6820 636f  eout for each co
+00000e20: 6d6d 616e 6420 696e 2073 6563 6f6e 6473  mmand in seconds
+00000e30: 2e0a 2020 2020 7469 6d65 6f75 743a 2069  ..    timeout: i
+00000e40: 6e74 203d 2044 4546 4155 4c54 5f43 4d44  nt = DEFAULT_CMD
+00000e50: 5f54 494d 454f 5554 0a0a 2020 2020 6465  _TIMEOUT..    de
+00000e60: 6620 6563 686f 2873 656c 662c 206d 6573  f echo(self, mes
+00000e70: 7361 6765 3a20 7374 7229 3a0a 2020 2020  sage: str):.    
+00000e80: 2020 2020 2320 7079 7465 7374 2773 2078      # pytest's x
+00000e90: 6469 7374 2070 6c75 6769 6e20 6361 7074  dist plugin capt
+00000ea0: 7572 6573 2073 7464 6f75 743b 2070 7269  ures stdout; pri
+00000eb0: 6e74 2074 6f20 7374 6465 7272 2073 6f20  nt to stderr so 
+00000ec0: 7468 6174 2074 6865 0a20 2020 2020 2020  that the.       
+00000ed0: 2023 206c 6f67 7320 6172 6520 7374 7265   # logs are stre
+00000ee0: 616d 696e 6720 7768 696c 6520 7468 6520  aming while the 
+00000ef0: 7465 7374 7320 6172 6520 7275 6e6e 696e  tests are runnin
+00000f00: 672e 0a20 2020 2020 2020 2070 7265 6669  g..        prefi
+00000f10: 7820 3d20 6627 5b7b 7365 6c66 2e6e 616d  x = f'[{self.nam
+00000f20: 657d 5d27 0a20 2020 2020 2020 206d 6573  e}]'.        mes
+00000f30: 7361 6765 203d 2066 277b 7072 6566 6978  sage = f'{prefix
+00000f40: 7d20 7b6d 6573 7361 6765 7d27 0a20 2020  } {message}'.   
+00000f50: 2020 2020 206d 6573 7361 6765 203d 206d       message = m
+00000f60: 6573 7361 6765 2e72 6570 6c61 6365 2827  essage.replace('
+00000f70: 5c6e 272c 2066 275c 6e7b 7072 6566 6978  \n', f'\n{prefix
+00000f80: 7d20 2729 0a20 2020 2020 2020 2070 7269  } ').        pri
+00000f90: 6e74 286d 6573 7361 6765 2c20 6669 6c65  nt(message, file
+00000fa0: 3d73 7973 2e73 7464 6572 722c 2066 6c75  =sys.stderr, flu
+00000fb0: 7368 3d54 7275 6529 0a0a 0a64 6566 205f  sh=True)...def _
+00000fc0: 6765 745f 7469 6d65 6f75 7428 6765 6e65  get_timeout(gene
+00000fd0: 7269 635f 636c 6f75 643a 2073 7472 2c0a  ric_cloud: str,.
+00000fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000ff0: 206f 7665 7272 6964 655f 7469 6d65 6f75   override_timeou
+00001000: 743a 2069 6e74 203d 2044 4546 4155 4c54  t: int = DEFAULT
+00001010: 5f43 4d44 5f54 494d 454f 5554 293a 0a20  _CMD_TIMEOUT):. 
+00001020: 2020 2074 696d 656f 7574 7320 3d20 7b27     timeouts = {'
+00001030: 666c 7569 6473 7461 636b 273a 2036 3020  fluidstack': 60 
+00001040: 2a20 3630 7d20 2023 2066 696c 655f 6d6f  * 60}  # file_mo
+00001050: 756e 7473 0a20 2020 2072 6574 7572 6e20  unts.    return 
+00001060: 7469 6d65 6f75 7473 2e67 6574 2867 656e  timeouts.get(gen
+00001070: 6572 6963 5f63 6c6f 7564 2c20 6f76 6572  eric_cloud, over
+00001080: 7269 6465 5f74 696d 656f 7574 290a 0a0a  ride_timeout)...
+00001090: 6465 6620 5f67 6574 5f63 6c75 7374 6572  def _get_cluster
+000010a0: 5f6e 616d 6528 2920 2d3e 2073 7472 3a0a  _name() -> str:.
+000010b0: 2020 2020 2222 2252 6574 7572 6e73 2061      """Returns a
+000010c0: 2075 7365 722d 756e 6971 7565 2063 6c75   user-unique clu
+000010d0: 7374 6572 206e 616d 6520 666f 7220 6561  ster name for ea
+000010e0: 6368 2074 6573 745f 3c6e 616d 653e 2829  ch test_<name>()
+000010f0: 2e0a 0a20 2020 204d 7573 7420 6265 2063  ...    Must be c
+00001100: 616c 6c65 6420 6672 6f6d 2065 6163 6820  alled from each 
+00001110: 7465 7374 5f3c 6e61 6d65 3e28 292e 0a20  test_<name>().. 
+00001120: 2020 2022 2222 0a20 2020 2063 616c 6c65     """.    calle
+00001130: 725f 6675 6e63 5f6e 616d 6520 3d20 696e  r_func_name = in
+00001140: 7370 6563 742e 7374 6163 6b28 295b 315d  spect.stack()[1]
+00001150: 5b33 5d0a 2020 2020 7465 7374 5f6e 616d  [3].    test_nam
+00001160: 6520 3d20 6361 6c6c 6572 5f66 756e 635f  e = caller_func_
+00001170: 6e61 6d65 2e72 6570 6c61 6365 2827 5f27  name.replace('_'
+00001180: 2c20 272d 2729 2e72 6570 6c61 6365 2827  , '-').replace('
+00001190: 7465 7374 2d27 2c20 2774 2d27 290a 2020  test-', 't-').  
+000011a0: 2020 7465 7374 5f6e 616d 6520 3d20 636f    test_name = co
+000011b0: 6d6d 6f6e 5f75 7469 6c73 2e6d 616b 655f  mmon_utils.make_
+000011c0: 636c 7573 7465 725f 6e61 6d65 5f6f 6e5f  cluster_name_on_
+000011d0: 636c 6f75 6428 7465 7374 5f6e 616d 652c  cloud(test_name,
 000011e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 000011f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00001200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001210: 2020 2020 2020 2020 2061 6464 5f75 7365           add_use
-00001220: 725f 6861 7368 3d46 616c 7365 290a 2020  r_hash=False).  
-00001230: 2020 7265 7475 726e 2066 277b 7465 7374    return f'{test
-00001240: 5f6e 616d 657d 2d7b 7465 7374 5f69 647d  _name}-{test_id}
-00001250: 270a 0a0a 6465 6620 7275 6e5f 6f6e 655f  '...def run_one_
-00001260: 7465 7374 2874 6573 743a 2054 6573 7429  test(test: Test)
-00001270: 202d 3e20 5475 706c 655b 696e 742c 2073   -> Tuple[int, s
-00001280: 7472 2c20 7374 725d 3a0a 2020 2020 2320  tr, str]:.    # 
-00001290: 4661 696c 2066 6173 7420 6966 2060 736b  Fail fast if `sk
-000012a0: 7960 2043 4c49 2073 6f6d 6568 6f77 2065  y` CLI somehow e
-000012b0: 7272 6f72 7320 6f75 742e 0a20 2020 2073  rrors out..    s
-000012c0: 7562 7072 6f63 6573 732e 7275 6e28 5b27  ubprocess.run(['
-000012d0: 736b 7927 2c20 2773 7461 7475 7327 5d2c  sky', 'status'],
-000012e0: 2073 7464 6f75 743d 7375 6270 726f 6365   stdout=subproce
-000012f0: 7373 2e44 4556 4e55 4c4c 2c20 6368 6563  ss.DEVNULL, chec
-00001300: 6b3d 5472 7565 290a 2020 2020 6c6f 675f  k=True).    log_
-00001310: 6669 6c65 203d 2074 656d 7066 696c 652e  file = tempfile.
-00001320: 4e61 6d65 6454 656d 706f 7261 7279 4669  NamedTemporaryFi
-00001330: 6c65 2827 6127 2c0a 2020 2020 2020 2020  le('a',.        
-00001340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001360: 2020 2070 7265 6669 783d 6627 7b74 6573     prefix=f'{tes
-00001370: 742e 6e61 6d65 7d2d 272c 0a20 2020 2020  t.name}-',.     
-00001380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000013a0: 2020 2020 2020 7375 6666 6978 3d27 2e6c        suffix='.l
-000013b0: 6f67 272c 0a20 2020 2020 2020 2020 2020  og',.           
-000013c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000013d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000013e0: 6465 6c65 7465 3d46 616c 7365 290a 2020  delete=False).  
-000013f0: 2020 7465 7374 2e65 6368 6f28 6627 5465    test.echo(f'Te
-00001400: 7374 2073 7461 7274 6564 2e20 4c6f 673a  st started. Log:
-00001410: 206c 6573 7320 7b6c 6f67 5f66 696c 652e   less {log_file.
-00001420: 6e61 6d65 7d27 290a 2020 2020 666f 7220  name}').    for 
-00001430: 636f 6d6d 616e 6420 696e 2074 6573 742e  command in test.
-00001440: 636f 6d6d 616e 6473 3a0a 2020 2020 2020  commands:.      
-00001450: 2020 6c6f 675f 6669 6c65 2e77 7269 7465    log_file.write
-00001460: 2866 272b 207b 636f 6d6d 616e 647d 5c6e  (f'+ {command}\n
-00001470: 2729 0a20 2020 2020 2020 206c 6f67 5f66  ').        log_f
-00001480: 696c 652e 666c 7573 6828 290a 2020 2020  ile.flush().    
-00001490: 2020 2020 7072 6f63 203d 2073 7562 7072      proc = subpr
-000014a0: 6f63 6573 732e 506f 7065 6e28 0a20 2020  ocess.Popen(.   
-000014b0: 2020 2020 2020 2020 2063 6f6d 6d61 6e64           command
-000014c0: 2c0a 2020 2020 2020 2020 2020 2020 7374  ,.            st
-000014d0: 646f 7574 3d6c 6f67 5f66 696c 652c 0a20  dout=log_file,. 
-000014e0: 2020 2020 2020 2020 2020 2073 7464 6572             stder
-000014f0: 723d 7375 6270 726f 6365 7373 2e53 5444  r=subprocess.STD
-00001500: 4f55 542c 0a20 2020 2020 2020 2020 2020  OUT,.           
-00001510: 2073 6865 6c6c 3d54 7275 652c 0a20 2020   shell=True,.   
-00001520: 2020 2020 2020 2020 2065 7865 6375 7461           executa
-00001530: 626c 653d 272f 6269 6e2f 6261 7368 272c  ble='/bin/bash',
-00001540: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00001550: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00001560: 2020 2020 7072 6f63 2e77 6169 7428 7469      proc.wait(ti
-00001570: 6d65 6f75 743d 7465 7374 2e74 696d 656f  meout=test.timeo
-00001580: 7574 290a 2020 2020 2020 2020 6578 6365  ut).        exce
-00001590: 7074 2073 7562 7072 6f63 6573 732e 5469  pt subprocess.Ti
-000015a0: 6d65 6f75 7445 7870 6972 6564 2061 7320  meoutExpired as 
-000015b0: 653a 0a20 2020 2020 2020 2020 2020 206c  e:.            l
-000015c0: 6f67 5f66 696c 652e 666c 7573 6828 290a  og_file.flush().
-000015d0: 2020 2020 2020 2020 2020 2020 7465 7374              test
-000015e0: 2e65 6368 6f28 6627 5469 6d65 6f75 7420  .echo(f'Timeout 
-000015f0: 6166 7465 7220 7b74 6573 742e 7469 6d65  after {test.time
-00001600: 6f75 747d 2073 6563 6f6e 6473 2e27 290a  out} seconds.').
-00001610: 2020 2020 2020 2020 2020 2020 7465 7374              test
-00001620: 2e65 6368 6f28 7374 7228 6529 290a 2020  .echo(str(e)).  
-00001630: 2020 2020 2020 2020 2020 6c6f 675f 6669            log_fi
-00001640: 6c65 2e77 7269 7465 2866 2754 696d 656f  le.write(f'Timeo
-00001650: 7574 2061 6674 6572 207b 7465 7374 2e74  ut after {test.t
-00001660: 696d 656f 7574 7d20 7365 636f 6e64 732e  imeout} seconds.
-00001670: 5c6e 2729 0a20 2020 2020 2020 2020 2020  \n').           
-00001680: 206c 6f67 5f66 696c 652e 666c 7573 6828   log_file.flush(
-00001690: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
-000016a0: 4b69 6c6c 2074 6865 2063 7572 7265 6e74  Kill the current
-000016b0: 2070 726f 6365 7373 2e0a 2020 2020 2020   process..      
-000016c0: 2020 2020 2020 7072 6f63 2e74 6572 6d69        proc.termi
-000016d0: 6e61 7465 2829 0a20 2020 2020 2020 2020  nate().         
-000016e0: 2020 2070 726f 632e 7265 7475 726e 636f     proc.returnco
-000016f0: 6465 203d 2031 2020 2320 4e6f 6e65 2069  de = 1  # None i
-00001700: 6620 7765 2064 6f6e 2774 2073 6574 2069  f we don't set i
-00001710: 742e 0a20 2020 2020 2020 2020 2020 2062  t..            b
-00001720: 7265 616b 0a0a 2020 2020 2020 2020 6966  reak..        if
-00001730: 2070 726f 632e 7265 7475 726e 636f 6465   proc.returncode
-00001740: 3a0a 2020 2020 2020 2020 2020 2020 6272  :.            br
-00001750: 6561 6b0a 0a20 2020 2073 7479 6c65 203d  eak..    style =
-00001760: 2063 6f6c 6f72 616d 612e 5374 796c 650a   colorama.Style.
-00001770: 2020 2020 666f 7265 203d 2063 6f6c 6f72      fore = color
-00001780: 616d 612e 466f 7265 0a20 2020 206f 7574  ama.Fore.    out
-00001790: 636f 6d65 203d 2028 6627 7b66 6f72 652e  come = (f'{fore.
-000017a0: 5245 447d 4661 696c 6564 7b73 7479 6c65  RED}Failed{style
-000017b0: 2e52 4553 4554 5f41 4c4c 7d27 0a20 2020  .RESET_ALL}'.   
-000017c0: 2020 2020 2020 2020 2020 2020 6966 2070              if p
-000017d0: 726f 632e 7265 7475 726e 636f 6465 2065  roc.returncode e
-000017e0: 6c73 6520 6627 7b66 6f72 652e 4752 4545  lse f'{fore.GREE
-000017f0: 4e7d 5061 7373 6564 7b73 7479 6c65 2e52  N}Passed{style.R
-00001800: 4553 4554 5f41 4c4c 7d27 290a 2020 2020  ESET_ALL}').    
-00001810: 7265 6173 6f6e 203d 2066 275c 6e52 6561  reason = f'\nRea
-00001820: 736f 6e3a 207b 636f 6d6d 616e 647d 2720  son: {command}' 
-00001830: 6966 2070 726f 632e 7265 7475 726e 636f  if proc.returnco
-00001840: 6465 2065 6c73 6520 2727 0a20 2020 206d  de else ''.    m
-00001850: 7367 203d 2028 6627 7b6f 7574 636f 6d65  sg = (f'{outcome
-00001860: 7d2e 270a 2020 2020 2020 2020 2020 2066  }.'.           f
-00001870: 277b 7265 6173 6f6e 7d27 0a20 2020 2020  '{reason}'.     
-00001880: 2020 2020 2020 6627 5c6e 4c6f 673a 206c        f'\nLog: l
-00001890: 6573 7320 7b6c 6f67 5f66 696c 652e 6e61  ess {log_file.na
-000018a0: 6d65 7d5c 6e27 290a 2020 2020 7465 7374  me}\n').    test
-000018b0: 2e65 6368 6f28 6d73 6729 0a20 2020 206c  .echo(msg).    l
-000018c0: 6f67 5f66 696c 652e 7772 6974 6528 6d73  og_file.write(ms
-000018d0: 6729 0a20 2020 2069 6620 2870 726f 632e  g).    if (proc.
-000018e0: 7265 7475 726e 636f 6465 203d 3d20 3020  returncode == 0 
-000018f0: 6f72 0a20 2020 2020 2020 2020 2020 2070  or.            p
-00001900: 7974 6573 742e 7465 726d 696e 6174 655f  ytest.terminate_
-00001910: 6f6e 5f66 6169 6c75 7265 2920 616e 6420  on_failure) and 
-00001920: 7465 7374 2e74 6561 7264 6f77 6e20 6973  test.teardown is
-00001930: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-00001940: 2020 2073 7562 7072 6f63 6573 735f 7574     subprocess_ut
-00001950: 696c 732e 7275 6e28 0a20 2020 2020 2020  ils.run(.       
-00001960: 2020 2020 2074 6573 742e 7465 6172 646f       test.teardo
-00001970: 776e 2c0a 2020 2020 2020 2020 2020 2020  wn,.            
-00001980: 7374 646f 7574 3d6c 6f67 5f66 696c 652c  stdout=log_file,
-00001990: 0a20 2020 2020 2020 2020 2020 2073 7464  .            std
-000019a0: 6572 723d 7375 6270 726f 6365 7373 2e53  err=subprocess.S
-000019b0: 5444 4f55 542c 0a20 2020 2020 2020 2020  TDOUT,.         
-000019c0: 2020 2074 696d 656f 7574 3d31 3020 2a20     timeout=10 * 
-000019d0: 3630 2c20 2023 2031 3020 6d69 6e73 0a20  60,  # 10 mins. 
-000019e0: 2020 2020 2020 2020 2020 2073 6865 6c6c             shell
-000019f0: 3d54 7275 652c 0a20 2020 2020 2020 2029  =True,.        )
-00001a00: 0a0a 2020 2020 6966 2070 726f 632e 7265  ..    if proc.re
-00001a10: 7475 726e 636f 6465 3a0a 2020 2020 2020  turncode:.      
-00001a20: 2020 7261 6973 6520 4578 6365 7074 696f    raise Exceptio
-00001a30: 6e28 6627 7465 7374 2066 6169 6c65 643a  n(f'test failed:
-00001a40: 206c 6573 7320 7b6c 6f67 5f66 696c 652e   less {log_file.
-00001a50: 6e61 6d65 7d27 290a 0a0a 6465 6620 6765  name}')...def ge
-00001a60: 745f 6177 735f 7265 6769 6f6e 5f66 6f72  t_aws_region_for
-00001a70: 5f71 756f 7461 5f66 6169 6c6f 7665 7228  _quota_failover(
-00001a80: 2920 2d3e 204f 7074 696f 6e61 6c5b 7374  ) -> Optional[st
-00001a90: 725d 3a0a 2020 2020 6361 6e64 6964 6174  r]:.    candidat
-00001aa0: 655f 7265 6769 6f6e 7320 3d20 4157 532e  e_regions = AWS.
-00001ab0: 7265 6769 6f6e 735f 7769 7468 5f6f 6666  regions_with_off
-00001ac0: 6572 696e 6728 696e 7374 616e 6365 5f74  ering(instance_t
-00001ad0: 7970 653d 2770 332e 3136 786c 6172 6765  ype='p3.16xlarge
-00001ae0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00001af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001b10: 2020 2020 2061 6363 656c 6572 6174 6f72       accelerator
-00001b20: 733d 4e6f 6e65 2c0a 2020 2020 2020 2020  s=None,.        
-00001b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001b50: 2020 2020 2020 2020 2020 7573 655f 7370            use_sp
-00001b60: 6f74 3d54 7275 652c 0a20 2020 2020 2020  ot=True,.       
-00001b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001b90: 2020 2020 2020 2020 2020 2072 6567 696f             regio
-00001ba0: 6e3d 4e6f 6e65 2c0a 2020 2020 2020 2020  n=None,.        
-00001bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001bd0: 2020 2020 2020 2020 2020 7a6f 6e65 3d4e            zone=N
-00001be0: 6f6e 6529 0a20 2020 206f 7269 6769 6e61  one).    origina
-00001bf0: 6c5f 7265 736f 7572 6365 7320 3d20 736b  l_resources = sk
-00001c00: 792e 5265 736f 7572 6365 7328 636c 6f75  y.Resources(clou
-00001c10: 643d 736b 792e 4157 5328 292c 0a20 2020  d=sky.AWS(),.   
-00001c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001c40: 2020 2020 696e 7374 616e 6365 5f74 7970      instance_typ
-00001c50: 653d 2770 332e 3136 786c 6172 6765 272c  e='p3.16xlarge',
-00001c60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00001c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001c80: 2020 2020 2020 2020 7573 655f 7370 6f74          use_spot
-00001c90: 3d54 7275 6529 0a0a 2020 2020 2320 4669  =True)..    # Fi
-00001ca0: 6c74 6572 2074 6865 2072 6567 696f 6e73  lter the regions
-00001cb0: 2077 6974 6820 7072 6f78 7920 636f 6d6d   with proxy comm
-00001cc0: 616e 6420 696e 207e 2f2e 736b 792f 636f  and in ~/.sky/co
-00001cd0: 6e66 6967 2e79 616d 6c2e 0a20 2020 2066  nfig.yaml..    f
-00001ce0: 696c 7465 7265 645f 7265 6769 6f6e 7320  iltered_regions 
-00001cf0: 3d20 6f72 6967 696e 616c 5f72 6573 6f75  = original_resou
-00001d00: 7263 6573 2e67 6574 5f76 616c 6964 5f72  rces.get_valid_r
-00001d10: 6567 696f 6e73 5f66 6f72 5f6c 6175 6e63  egions_for_launc
-00001d20: 6861 626c 6528 290a 2020 2020 6361 6e64  hable().    cand
-00001d30: 6964 6174 655f 7265 6769 6f6e 7320 3d20  idate_regions = 
-00001d40: 5b0a 2020 2020 2020 2020 7265 6769 6f6e  [.        region
-00001d50: 2066 6f72 2072 6567 696f 6e20 696e 2063   for region in c
-00001d60: 616e 6469 6461 7465 5f72 6567 696f 6e73  andidate_regions
-00001d70: 0a20 2020 2020 2020 2069 6620 7265 6769  .        if regi
-00001d80: 6f6e 2e6e 616d 6520 696e 2066 696c 7465  on.name in filte
-00001d90: 7265 645f 7265 6769 6f6e 730a 2020 2020  red_regions.    
-00001da0: 5d0a 0a20 2020 2066 6f72 2072 6567 696f  ]..    for regio
-00001db0: 6e20 696e 2063 616e 6469 6461 7465 5f72  n in candidate_r
-00001dc0: 6567 696f 6e73 3a0a 2020 2020 2020 2020  egions:.        
-00001dd0: 7265 736f 7572 6365 7320 3d20 6f72 6967  resources = orig
-00001de0: 696e 616c 5f72 6573 6f75 7263 6573 2e63  inal_resources.c
-00001df0: 6f70 7928 7265 6769 6f6e 3d72 6567 696f  opy(region=regio
-00001e00: 6e2e 6e61 6d65 290a 2020 2020 2020 2020  n.name).        
-00001e10: 6966 206e 6f74 2041 5753 2e63 6865 636b  if not AWS.check
-00001e20: 5f71 756f 7461 5f61 7661 696c 6162 6c65  _quota_available
-00001e30: 2872 6573 6f75 7263 6573 293a 0a20 2020  (resources):.   
-00001e40: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00001e50: 7265 6769 6f6e 2e6e 616d 650a 0a20 2020  region.name..   
-00001e60: 2072 6574 7572 6e20 4e6f 6e65 0a0a 0a64   return None...d
-00001e70: 6566 2067 6574 5f67 6370 5f72 6567 696f  ef get_gcp_regio
-00001e80: 6e5f 666f 725f 7175 6f74 615f 6661 696c  n_for_quota_fail
-00001e90: 6f76 6572 2829 202d 3e20 4f70 7469 6f6e  over() -> Option
-00001ea0: 616c 5b73 7472 5d3a 0a0a 2020 2020 6361  al[str]:..    ca
-00001eb0: 6e64 6964 6174 655f 7265 6769 6f6e 7320  ndidate_regions 
-00001ec0: 3d20 4743 502e 7265 6769 6f6e 735f 7769  = GCP.regions_wi
-00001ed0: 7468 5f6f 6666 6572 696e 6728 696e 7374  th_offering(inst
-00001ee0: 616e 6365 5f74 7970 653d 4e6f 6e65 2c0a  ance_type=None,.
-00001ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001f20: 2020 6163 6365 6c65 7261 746f 7273 3d7b    accelerators={
-00001f30: 2741 3130 302d 3830 4742 273a 2031 7d2c  'A100-80GB': 1},
-00001f40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00001f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001f70: 2020 2075 7365 5f73 706f 743d 5472 7565     use_spot=True
-00001f80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00001f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001fb0: 2020 2020 7265 6769 6f6e 3d4e 6f6e 652c      region=None,
-00001fc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00001fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001ff0: 2020 207a 6f6e 653d 4e6f 6e65 290a 0a20     zone=None).. 
-00002000: 2020 206f 7269 6769 6e61 6c5f 7265 736f     original_reso
-00002010: 7572 6365 7320 3d20 736b 792e 5265 736f  urces = sky.Reso
-00002020: 7572 6365 7328 636c 6f75 643d 736b 792e  urces(cloud=sky.
-00002030: 4743 5028 292c 0a20 2020 2020 2020 2020  GCP(),.         
-00002040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002050: 2020 2020 2020 2020 2020 2020 2020 696e                in
-00002060: 7374 616e 6365 5f74 7970 653d 2761 322d  stance_type='a2-
-00002070: 756c 7472 6167 7075 2d31 6727 2c0a 2020  ultragpu-1g',.  
-00002080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000020a0: 2020 2020 2061 6363 656c 6572 6174 6f72       accelerator
-000020b0: 733d 7b27 4131 3030 2d38 3047 4227 3a20  s={'A100-80GB': 
-000020c0: 317d 2c0a 2020 2020 2020 2020 2020 2020  1},.            
-000020d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000020e0: 2020 2020 2020 2020 2020 2075 7365 5f73             use_s
-000020f0: 706f 743d 5472 7565 290a 0a20 2020 2023  pot=True)..    #
-00002100: 2046 696c 7465 7220 7468 6520 7265 6769   Filter the regi
-00002110: 6f6e 7320 7769 7468 2070 726f 7879 2063  ons with proxy c
-00002120: 6f6d 6d61 6e64 2069 6e20 7e2f 2e73 6b79  ommand in ~/.sky
-00002130: 2f63 6f6e 6669 672e 7961 6d6c 2e0a 2020  /config.yaml..  
-00002140: 2020 6669 6c74 6572 6564 5f72 6567 696f    filtered_regio
-00002150: 6e73 203d 206f 7269 6769 6e61 6c5f 7265  ns = original_re
-00002160: 736f 7572 6365 732e 6765 745f 7661 6c69  sources.get_vali
-00002170: 645f 7265 6769 6f6e 735f 666f 725f 6c61  d_regions_for_la
-00002180: 756e 6368 6162 6c65 2829 0a20 2020 2063  unchable().    c
-00002190: 616e 6469 6461 7465 5f72 6567 696f 6e73  andidate_regions
-000021a0: 203d 205b 0a20 2020 2020 2020 2072 6567   = [.        reg
-000021b0: 696f 6e20 666f 7220 7265 6769 6f6e 2069  ion for region i
-000021c0: 6e20 6361 6e64 6964 6174 655f 7265 6769  n candidate_regi
-000021d0: 6f6e 730a 2020 2020 2020 2020 6966 2072  ons.        if r
-000021e0: 6567 696f 6e2e 6e61 6d65 2069 6e20 6669  egion.name in fi
-000021f0: 6c74 6572 6564 5f72 6567 696f 6e73 0a20  ltered_regions. 
-00002200: 2020 205d 0a0a 2020 2020 666f 7220 7265     ]..    for re
-00002210: 6769 6f6e 2069 6e20 6361 6e64 6964 6174  gion in candidat
-00002220: 655f 7265 6769 6f6e 733a 0a20 2020 2020  e_regions:.     
-00002230: 2020 2069 6620 6e6f 7420 4743 502e 6368     if not GCP.ch
-00002240: 6563 6b5f 7175 6f74 615f 6176 6169 6c61  eck_quota_availa
-00002250: 626c 6528 0a20 2020 2020 2020 2020 2020  ble(.           
-00002260: 2020 2020 206f 7269 6769 6e61 6c5f 7265       original_re
-00002270: 736f 7572 6365 732e 636f 7079 2872 6567  sources.copy(reg
-00002280: 696f 6e3d 7265 6769 6f6e 2e6e 616d 6529  ion=region.name)
-00002290: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-000022a0: 6574 7572 6e20 7265 6769 6f6e 2e6e 616d  eturn region.nam
-000022b0: 650a 0a20 2020 2072 6574 7572 6e20 4e6f  e..    return No
-000022c0: 6e65 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  ne...# ---------
-000022d0: 2d20 4472 7920 7275 6e3a 2032 2054 6173  - Dry run: 2 Tas
-000022e0: 6b73 2069 6e20 6120 6368 6169 6e2e 202d  ks in a chain. -
-000022f0: 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974 6573  ---------.@pytes
-00002300: 742e 6d61 726b 2e6e 6f5f 666c 7569 6473  t.mark.no_fluids
-00002310: 7461 636b 2020 2372 6571 7569 7265 7320  tack  #requires 
-00002320: 4743 5020 616e 6420 4157 5320 7365 7420  GCP and AWS set 
-00002330: 7570 0a64 6566 2074 6573 745f 6578 616d  up.def test_exam
-00002340: 706c 655f 6170 7028 293a 0a20 2020 2074  ple_app():.    t
-00002350: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-00002360: 2020 2020 2765 7861 6d70 6c65 5f61 7070      'example_app
-00002370: 272c 0a20 2020 2020 2020 205b 2770 7974  ',.        ['pyt
-00002380: 686f 6e20 6578 616d 706c 6573 2f65 7861  hon examples/exa
-00002390: 6d70 6c65 5f61 7070 2e70 7927 5d2c 0a20  mple_app.py'],. 
-000023a0: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-000023b0: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
-000023c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2041 206d 696e  ---------- A min
-000023d0: 696d 616c 2074 6173 6b20 2d2d 2d2d 2d2d  imal task ------
-000023e0: 2d2d 2d2d 0a64 6566 2074 6573 745f 6d69  ----.def test_mi
-000023f0: 6e69 6d61 6c28 6765 6e65 7269 635f 636c  nimal(generic_cl
-00002400: 6f75 643a 2073 7472 293a 0a20 2020 206e  oud: str):.    n
-00002410: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-00002420: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
-00002430: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-00002440: 2020 2027 6d69 6e69 6d61 6c27 2c0a 2020     'minimal',.  
-00002450: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-00002460: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-00002470: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
-00002480: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
-00002490: 6c6f 7564 7d20 7465 7374 732f 7465 7374  loud} tests/test
-000024a0: 5f79 616d 6c73 2f6d 696e 696d 616c 2e79  _yamls/minimal.y
-000024b0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-000024c0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-000024d0: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
-000024e0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-000024f0: 6b79 206c 6f67 7320 7b6e 616d 657d 202d  ky logs {name} -
-00002500: 2d73 7461 7475 7320 7c20 6772 6570 2022  -status | grep "
-00002510: 4a6f 6220 313a 2053 5543 4345 4544 4544  Job 1: SUCCEEDED
-00002520: 2227 2c20 2023 2045 7175 6976 616c 656e  "',  # Equivalen
-00002530: 742e 0a20 2020 2020 2020 2020 2020 2023  t..            #
-00002540: 2043 6865 636b 2074 6865 206c 6f67 7320   Check the logs 
-00002550: 646f 776e 6c6f 6164 696e 670a 2020 2020  downloading.    
-00002560: 2020 2020 2020 2020 6627 6c6f 675f 7061          f'log_pa
-00002570: 7468 3d24 2873 6b79 206c 6f67 7320 7b6e  th=$(sky logs {n
-00002580: 616d 657d 2031 202d 2d73 796e 632d 646f  ame} 1 --sync-do
-00002590: 776e 207c 2067 7265 7020 224a 6f62 2031  wn | grep "Job 1
-000025a0: 206c 6f67 733a 2220 7c20 7365 6420 2d45   logs:" | sed -E
-000025b0: 2022 732f 5e2e 2a4a 6f62 2031 206c 6f67   "s/^.*Job 1 log
-000025c0: 733a 2028 2e2a 295c 5c78 3162 5c5c 5b30  s: (.*)\\x1b\\[0
-000025d0: 6d2f 5c5c 312f 6722 2920 2626 2065 6368  m/\\1/g") && ech
-000025e0: 6f20 246c 6f67 5f70 6174 6820 2626 2074  o $log_path && t
-000025f0: 6573 7420 2d66 2024 6c6f 675f 7061 7468  est -f $log_path
-00002600: 2f72 756e 2e6c 6f67 272c 0a20 2020 2020  /run.log',.     
-00002610: 2020 2020 2020 2023 2045 6e73 7572 6520         # Ensure 
-00002620: 7468 6520 7261 796c 6574 2070 726f 6365  the raylet proce
-00002630: 7373 2068 6173 2074 6865 2063 6f72 7265  ss has the corre
-00002640: 6374 2066 696c 6520 6465 7363 7269 7074  ct file descript
-00002650: 6f72 206c 696d 6974 2e0a 2020 2020 2020  or limit..      
-00002660: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
-00002670: 207b 6e61 6d65 7d20 2270 726c 696d 6974   {name} "prlimit
-00002680: 202d 6e20 2d2d 7069 643d 5c24 2870 6772   -n --pid=\$(pgr
-00002690: 6570 202d 6620 5c27 7261 796c 6574 2f72  ep -f \'raylet/r
-000026a0: 6179 6c65 7420 2d2d 7261 796c 6574 5f73  aylet --raylet_s
-000026b0: 6f63 6b65 745f 6e61 6d65 5c27 2920 7c20  ocket_name\') | 
-000026c0: 6772 6570 205c 2722 5c27 3130 3438 3537  grep \'"\'104857
-000026d0: 3620 3130 3438 3537 365c 2722 5c27 2227  6 1048576\'"\'"'
-000026e0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-000026f0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-00002700: 3220 2d2d 7374 6174 7573 272c 2020 2320  2 --status',  # 
-00002710: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
-00002720: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
-00002730: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
-00002740: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-00002750: 7d27 2c0a 2020 2020 2020 2020 5f67 6574  }',.        _get
-00002760: 5f74 696d 656f 7574 2867 656e 6572 6963  _timeout(generic
-00002770: 5f63 6c6f 7564 292c 0a20 2020 2029 0a20  _cloud),.    ). 
-00002780: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00002790: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
-000027a0: 2d2d 2d2d 2054 6573 7420 7265 6769 6f6e  ---- Test region
-000027b0: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974   ----------.@pyt
-000027c0: 6573 742e 6d61 726b 2e61 7773 0a64 6566  est.mark.aws.def
-000027d0: 2074 6573 745f 6177 735f 7265 6769 6f6e   test_aws_region
-000027e0: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
-000027f0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-00002800: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
-00002810: 7374 280a 2020 2020 2020 2020 2761 7773  st(.        'aws
-00002820: 5f72 6567 696f 6e27 2c0a 2020 2020 2020  _region',.      
-00002830: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-00002840: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-00002850: 2d63 207b 6e61 6d65 7d20 2d2d 7265 6769  -c {name} --regi
-00002860: 6f6e 2075 732d 6561 7374 2d32 2065 7861  on us-east-2 exa
-00002870: 6d70 6c65 732f 6d69 6e69 6d61 6c2e 7961  mples/minimal.ya
-00002880: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-00002890: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-000028a0: 657d 2065 7861 6d70 6c65 732f 6d69 6e69  e} examples/mini
-000028b0: 6d61 6c2e 7961 6d6c 272c 0a20 2020 2020  mal.yaml',.     
-000028c0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-000028d0: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
-000028e0: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
-000028f0: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
-00002900: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
-00002910: 2773 6b79 2073 7461 7475 7320 2d2d 616c  'sky status --al
-00002920: 6c20 7c20 6772 6570 207b 6e61 6d65 7d20  l | grep {name} 
-00002930: 7c20 6772 6570 2075 732d 6561 7374 2d32  | grep us-east-2
-00002940: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
-00002950: 2072 6567 696f 6e20 6973 2063 6f72 7265   region is corre
-00002960: 6374 2e0a 2020 2020 2020 2020 5d2c 0a20  ct..        ],. 
-00002970: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
-00002980: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
-00002990: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-000029a0: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
-000029b0: 7465 7374 2e6d 6172 6b2e 6763 700a 6465  test.mark.gcp.de
-000029c0: 6620 7465 7374 5f67 6370 5f72 6567 696f  f test_gcp_regio
-000029d0: 6e5f 616e 645f 7365 7276 6963 655f 6163  n_and_service_ac
-000029e0: 636f 756e 7428 293a 0a20 2020 206e 616d  count():.    nam
-000029f0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-00002a00: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-00002a10: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-00002a20: 2027 6763 705f 7265 6769 6f6e 272c 0a20   'gcp_region',. 
-00002a30: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-00002a40: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-00002a50: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
-00002a60: 2d72 6567 696f 6e20 7573 2d63 656e 7472  -region us-centr
-00002a70: 616c 3120 2d2d 636c 6f75 6420 6763 7020  al1 --cloud gcp 
-00002a80: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
-00002a90: 2f6d 696e 696d 616c 2e79 616d 6c27 2c0a  /minimal.yaml',.
-00002aa0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00002ab0: 7920 6578 6563 207b 6e61 6d65 7d20 7465  y exec {name} te
-00002ac0: 7374 732f 7465 7374 5f79 616d 6c73 2f6d  sts/test_yamls/m
-00002ad0: 696e 696d 616c 2e79 616d 6c27 2c0a 2020  inimal.yaml',.  
-00002ae0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00002af0: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
-00002b00: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
-00002b10: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
-00002b20: 6564 6564 2e0a 2020 2020 2020 2020 2020  eded..          
-00002b30: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-00002b40: 6d65 7d20 5c27 6375 726c 202d 4820 224d  me} \'curl -H "M
-00002b50: 6574 6164 6174 612d 466c 6176 6f72 3a20  etadata-Flavor: 
-00002b60: 476f 6f67 6c65 2220 2268 7474 703a 2f2f  Google" "http://
-00002b70: 6d65 7461 6461 7461 2e67 6f6f 676c 652e  metadata.google.
-00002b80: 696e 7465 726e 616c 2f63 6f6d 7075 7465  internal/compute
-00002b90: 4d65 7461 6461 7461 2f76 312f 696e 7374  Metadata/v1/inst
-00002ba0: 616e 6365 2f73 6572 7669 6365 2d61 6363  ance/service-acc
-00002bb0: 6f75 6e74 732f 6465 6661 756c 742f 6964  ounts/default/id
-00002bc0: 656e 7469 7479 3f66 6f72 6d61 743d 7374  entity?format=st
-00002bd0: 616e 6461 7264 2661 7564 6965 6e63 653d  andard&audience=
-00002be0: 6763 7022 5c27 272c 0a20 2020 2020 2020  gcp"\'',.       
-00002bf0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-00002c00: 7b6e 616d 657d 2032 202d 2d73 7461 7475  {name} 2 --statu
-00002c10: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
-00002c20: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
-00002c30: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00002c40: 6b79 2073 7461 7475 7320 2d2d 616c 6c20  ky status --all 
-00002c50: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
-00002c60: 6772 6570 2075 732d 6365 6e74 7261 6c31  grep us-central1
-00002c70: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
-00002c80: 2072 6567 696f 6e20 6973 2063 6f72 7265   region is corre
-00002c90: 6374 2e0a 2020 2020 2020 2020 5d2c 0a20  ct..        ],. 
-00002ca0: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
-00002cb0: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
-00002cc0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-00002cd0: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
-00002ce0: 7465 7374 2e6d 6172 6b2e 6962 6d0a 6465  test.mark.ibm.de
-00002cf0: 6620 7465 7374 5f69 626d 5f72 6567 696f  f test_ibm_regio
-00002d00: 6e28 293a 0a20 2020 206e 616d 6520 3d20  n():.    name = 
-00002d10: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-00002d20: 6528 290a 2020 2020 7265 6769 6f6e 203d  e().    region =
-00002d30: 2027 6575 2d64 6527 0a20 2020 2074 6573   'eu-de'.    tes
-00002d40: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-00002d50: 2020 2772 6567 696f 6e27 2c0a 2020 2020    'region',.    
-00002d60: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-00002d70: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-00002d80: 7920 2d63 207b 6e61 6d65 7d20 2d2d 636c  y -c {name} --cl
-00002d90: 6f75 6420 6962 6d20 2d2d 7265 6769 6f6e  oud ibm --region
-00002da0: 207b 7265 6769 6f6e 7d20 6578 616d 706c   {region} exampl
-00002db0: 6573 2f6d 696e 696d 616c 2e79 616d 6c27  es/minimal.yaml'
-00002dc0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00002dd0: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
-00002de0: 2d2d 636c 6f75 6420 6962 6d20 6578 616d  --cloud ibm exam
-00002df0: 706c 6573 2f6d 696e 696d 616c 2e79 616d  ples/minimal.yam
-00002e00: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-00002e10: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-00002e20: 7d20 3120 2d2d 7374 6174 7573 272c 2020  } 1 --status',  
-00002e30: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
-00002e40: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
-00002e50: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
-00002e60: 6174 7573 202d 2d61 6c6c 207c 2067 7265  atus --all | gre
-00002e70: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
-00002e80: 7b72 6567 696f 6e7d 272c 2020 2320 456e  {region}',  # En
-00002e90: 7375 7265 2074 6865 2072 6567 696f 6e20  sure the region 
-00002ea0: 6973 2063 6f72 7265 6374 2e0a 2020 2020  is correct..    
-00002eb0: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-00002ec0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-00002ed0: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
-00002ee0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-00002ef0: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-00002f00: 6b2e 617a 7572 650a 6465 6620 7465 7374  k.azure.def test
-00002f10: 5f61 7a75 7265 5f72 6567 696f 6e28 293a  _azure_region():
-00002f20: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-00002f30: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-00002f40: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-00002f50: 0a20 2020 2020 2020 2027 617a 7572 655f  .        'azure_
-00002f60: 7265 6769 6f6e 272c 0a20 2020 2020 2020  region',.       
-00002f70: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-00002f80: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-00002f90: 6320 7b6e 616d 657d 202d 2d72 6567 696f  c {name} --regio
-00002fa0: 6e20 6561 7374 7573 3220 2d2d 636c 6f75  n eastus2 --clou
-00002fb0: 6420 617a 7572 6520 7465 7374 732f 7465  d azure tests/te
-00002fc0: 7374 5f79 616d 6c73 2f6d 696e 696d 616c  st_yamls/minimal
-00002fd0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-00002fe0: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-00002ff0: 6e61 6d65 7d20 7465 7374 732f 7465 7374  name} tests/test
-00003000: 5f79 616d 6c73 2f6d 696e 696d 616c 2e79  _yamls/minimal.y
-00003010: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-00003020: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-00003030: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
-00003040: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
-00003050: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
-00003060: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00003070: 7374 6174 7573 202d 2d61 6c6c 207c 2067  status --all | g
-00003080: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
-00003090: 7020 6561 7374 7573 3227 2c20 2023 2045  p eastus2',  # E
-000030a0: 6e73 7572 6520 7468 6520 7265 6769 6f6e  nsure the region
-000030b0: 2069 7320 636f 7272 6563 742e 0a20 2020   is correct..   
-000030c0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-000030d0: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-000030e0: 616d 657d 272c 0a20 2020 2029 0a20 2020  ame}',.    ).   
-000030f0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00003100: 7374 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d  st)...# --------
-00003110: 2d2d 2054 6573 7420 7a6f 6e65 202d 2d2d  -- Test zone ---
-00003120: 2d2d 2d2d 2d2d 2d0a 4070 7974 6573 742e  -------.@pytest.
-00003130: 6d61 726b 2e61 7773 0a64 6566 2074 6573  mark.aws.def tes
-00003140: 745f 6177 735f 7a6f 6e65 2829 3a0a 2020  t_aws_zone():.  
-00003150: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-00003160: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-00003170: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-00003180: 2020 2020 2020 2761 7773 5f7a 6f6e 6527        'aws_zone'
-00003190: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-000031a0: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-000031b0: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
-000031c0: 7d20 6578 616d 706c 6573 2f6d 696e 696d  } examples/minim
-000031d0: 616c 2e79 616d 6c20 2d2d 7a6f 6e65 2075  al.yaml --zone u
-000031e0: 732d 6561 7374 2d32 6227 2c0a 2020 2020  s-east-2b',.    
-000031f0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-00003200: 6563 207b 6e61 6d65 7d20 6578 616d 706c  ec {name} exampl
-00003210: 6573 2f6d 696e 696d 616c 2e79 616d 6c20  es/minimal.yaml 
-00003220: 2d2d 7a6f 6e65 2075 732d 6561 7374 2d32  --zone us-east-2
-00003230: 6227 2c0a 2020 2020 2020 2020 2020 2020  b',.            
-00003240: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-00003250: 7d20 3120 2d2d 7374 6174 7573 272c 2020  } 1 --status',  
-00003260: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
-00003270: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
-00003280: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
-00003290: 6174 7573 202d 2d61 6c6c 207c 2067 7265  atus --all | gre
-000032a0: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
-000032b0: 7573 2d65 6173 742d 3262 272c 2020 2320  us-east-2b',  # 
-000032c0: 456e 7375 7265 2074 6865 207a 6f6e 6520  Ensure the zone 
-000032d0: 6973 2063 6f72 7265 6374 2e0a 2020 2020  is correct..    
-000032e0: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-000032f0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-00003300: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
-00003310: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-00003320: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-00003330: 6b2e 6962 6d0a 6465 6620 7465 7374 5f69  k.ibm.def test_i
-00003340: 626d 5f7a 6f6e 6528 293a 0a20 2020 206e  bm_zone():.    n
-00003350: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-00003360: 6572 5f6e 616d 6528 290a 2020 2020 7a6f  er_name().    zo
-00003370: 6e65 203d 2027 6575 2d64 652d 3227 0a20  ne = 'eu-de-2'. 
-00003380: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-00003390: 2020 2020 2020 2020 277a 6f6e 6527 2c0a          'zone',.
-000033a0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-000033b0: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-000033c0: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
-000033d0: 2d2d 636c 6f75 6420 6962 6d20 6578 616d  --cloud ibm exam
-000033e0: 706c 6573 2f6d 696e 696d 616c 2e79 616d  ples/minimal.yam
-000033f0: 6c20 2d2d 7a6f 6e65 207b 7a6f 6e65 7d27  l --zone {zone}'
-00003400: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00003410: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
-00003420: 2d2d 636c 6f75 6420 6962 6d20 6578 616d  --cloud ibm exam
-00003430: 706c 6573 2f6d 696e 696d 616c 2e79 616d  ples/minimal.yam
-00003440: 6c20 2d2d 7a6f 6e65 207b 7a6f 6e65 7d27  l --zone {zone}'
-00003450: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00003460: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-00003470: 3120 2d2d 7374 6174 7573 272c 2020 2320  1 --status',  # 
-00003480: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
-00003490: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
-000034a0: 2020 2020 2020 6627 736b 7920 7374 6174        f'sky stat
-000034b0: 7573 202d 2d61 6c6c 207c 2067 7265 7020  us --all | grep 
-000034c0: 7b6e 616d 657d 207c 2067 7265 7020 7b7a  {name} | grep {z
-000034d0: 6f6e 657d 272c 2020 2320 456e 7375 7265  one}',  # Ensure
-000034e0: 2074 6865 207a 6f6e 6520 6973 2063 6f72   the zone is cor
-000034f0: 7265 6374 2e0a 2020 2020 2020 2020 5d2c  rect..        ],
-00003500: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
-00003510: 6f77 6e20 2d79 207b 6e61 6d65 7d20 7b6e  own -y {name} {n
-00003520: 616d 657d 2d32 207b 6e61 6d65 7d2d 3327  ame}-2 {name}-3'
-00003530: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
-00003540: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-00003550: 0a40 7079 7465 7374 2e6d 6172 6b2e 6763  .@pytest.mark.gc
-00003560: 700a 6465 6620 7465 7374 5f67 6370 5f7a  p.def test_gcp_z
-00003570: 6f6e 6528 293a 0a20 2020 206e 616d 6520  one():.    name 
-00003580: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-00003590: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
-000035a0: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-000035b0: 6763 705f 7a6f 6e65 272c 0a20 2020 2020  gcp_zone',.     
-000035c0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-000035d0: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
-000035e0: 202d 6320 7b6e 616d 657d 202d 2d7a 6f6e   -c {name} --zon
-000035f0: 6520 7573 2d63 656e 7472 616c 312d 6120  e us-central1-a 
-00003600: 2d2d 636c 6f75 6420 6763 7020 7465 7374  --cloud gcp test
-00003610: 732f 7465 7374 5f79 616d 6c73 2f6d 696e  s/test_yamls/min
-00003620: 696d 616c 2e79 616d 6c27 2c0a 2020 2020  imal.yaml',.    
-00003630: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-00003640: 6563 207b 6e61 6d65 7d20 2d2d 7a6f 6e65  ec {name} --zone
-00003650: 2075 732d 6365 6e74 7261 6c31 2d61 202d   us-central1-a -
-00003660: 2d63 6c6f 7564 2067 6370 2074 6573 7473  -cloud gcp tests
-00003670: 2f74 6573 745f 7961 6d6c 732f 6d69 6e69  /test_yamls/mini
-00003680: 6d61 6c2e 7961 6d6c 272c 0a20 2020 2020  mal.yaml',.     
-00003690: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-000036a0: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
-000036b0: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
-000036c0: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
-000036d0: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
-000036e0: 2773 6b79 2073 7461 7475 7320 2d2d 616c  'sky status --al
-000036f0: 6c20 7c20 6772 6570 207b 6e61 6d65 7d20  l | grep {name} 
-00003700: 7c20 6772 6570 2075 732d 6365 6e74 7261  | grep us-centra
-00003710: 6c31 2d61 272c 2020 2320 456e 7375 7265  l1-a',  # Ensure
-00003720: 2074 6865 207a 6f6e 6520 6973 2063 6f72   the zone is cor
-00003730: 7265 6374 2e0a 2020 2020 2020 2020 5d2c  rect..        ],
-00003740: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
-00003750: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
-00003760: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-00003770: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
-00003780: 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374   ---------- Test
-00003790: 2074 6865 2069 6d61 6765 202d 2d2d 2d2d   the image -----
-000037a0: 2d2d 2d2d 2d0a 4070 7974 6573 742e 6d61  -----.@pytest.ma
-000037b0: 726b 2e61 7773 0a64 6566 2074 6573 745f  rk.aws.def test_
-000037c0: 6177 735f 696d 6167 6573 2829 3a0a 2020  aws_images():.  
-000037d0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-000037e0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-000037f0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-00003800: 2020 2020 2020 2761 7773 5f69 6d61 6765        'aws_image
-00003810: 7327 2c0a 2020 2020 2020 2020 5b0a 2020  s',.        [.  
-00003820: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00003830: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
-00003840: 6d65 7d20 2d2d 696d 6167 652d 6964 2073  me} --image-id s
-00003850: 6b79 7069 6c6f 743a 6770 752d 7562 756e  kypilot:gpu-ubun
-00003860: 7475 2d31 3830 3420 6578 616d 706c 6573  tu-1804 examples
-00003870: 2f6d 696e 696d 616c 2e79 616d 6c27 2c0a  /minimal.yaml',.
-00003880: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00003890: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
-000038a0: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
-000038b0: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
-000038c0: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
-000038d0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-000038e0: 202d 6320 7b6e 616d 657d 202d 2d69 6d61   -c {name} --ima
-000038f0: 6765 2d69 6420 736b 7970 696c 6f74 3a67  ge-id skypilot:g
-00003900: 7075 2d75 6275 6e74 752d 3230 3034 2065  pu-ubuntu-2004 e
-00003910: 7861 6d70 6c65 732f 6d69 6e69 6d61 6c2e  xamples/minimal.
-00003920: 7961 6d6c 2026 2620 6578 6974 2031 207c  yaml && exit 1 |
-00003930: 7c20 7472 7565 272c 0a20 2020 2020 2020  | true',.       
-00003940: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-00003950: 6820 2d79 202d 6320 7b6e 616d 657d 2065  h -y -c {name} e
-00003960: 7861 6d70 6c65 732f 6d69 6e69 6d61 6c2e  xamples/minimal.
-00003970: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-00003980: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-00003990: 616d 657d 2032 202d 2d73 7461 7475 7327  ame} 2 --status'
-000039a0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-000039b0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-000039c0: 2d2d 7374 6174 7573 207c 2067 7265 7020  --status | grep 
-000039d0: 224a 6f62 2032 3a20 5355 4343 4545 4445  "Job 2: SUCCEEDE
-000039e0: 4422 272c 2020 2320 4571 7569 7661 6c65  D"',  # Equivale
-000039f0: 6e74 2e0a 2020 2020 2020 2020 5d2c 0a20  nt..        ],. 
-00003a00: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
-00003a10: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
-00003a20: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-00003a30: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
-00003a40: 7465 7374 2e6d 6172 6b2e 6763 700a 6465  test.mark.gcp.de
-00003a50: 6620 7465 7374 5f67 6370 5f69 6d61 6765  f test_gcp_image
-00003a60: 7328 293a 0a20 2020 206e 616d 6520 3d20  s():.    name = 
-00003a70: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-00003a80: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
-00003a90: 6573 7428 0a20 2020 2020 2020 2027 6763  est(.        'gc
-00003aa0: 705f 696d 6167 6573 272c 0a20 2020 2020  p_images',.     
-00003ab0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-00003ac0: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
-00003ad0: 202d 6320 7b6e 616d 657d 202d 2d69 6d61   -c {name} --ima
-00003ae0: 6765 2d69 6420 736b 7970 696c 6f74 3a67  ge-id skypilot:g
-00003af0: 7075 2d64 6562 6961 6e2d 3130 202d 2d63  pu-debian-10 --c
-00003b00: 6c6f 7564 2067 6370 2074 6573 7473 2f74  loud gcp tests/t
-00003b10: 6573 745f 7961 6d6c 732f 6d69 6e69 6d61  est_yamls/minima
-00003b20: 6c2e 7961 6d6c 272c 0a20 2020 2020 2020  l.yaml',.       
-00003b30: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-00003b40: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
-00003b50: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
-00003b60: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
-00003b70: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00003b80: 6b79 206c 6175 6e63 6820 2d63 207b 6e61  ky launch -c {na
-00003b90: 6d65 7d20 2d2d 696d 6167 652d 6964 2073  me} --image-id s
-00003ba0: 6b79 7069 6c6f 743a 6370 752d 6465 6269  kypilot:cpu-debi
-00003bb0: 616e 2d31 3020 2d2d 636c 6f75 6420 6763  an-10 --cloud gc
-00003bc0: 7020 7465 7374 732f 7465 7374 5f79 616d  p tests/test_yam
-00003bd0: 6c73 2f6d 696e 696d 616c 2e79 616d 6c20  ls/minimal.yaml 
-00003be0: 2626 2065 7869 7420 3120 7c7c 2074 7275  && exit 1 || tru
-00003bf0: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
-00003c00: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-00003c10: 2d63 207b 6e61 6d65 7d20 7465 7374 732f  -c {name} tests/
-00003c20: 7465 7374 5f79 616d 6c73 2f6d 696e 696d  test_yamls/minim
-00003c30: 616c 2e79 616d 6c27 2c0a 2020 2020 2020  al.yaml',.      
-00003c40: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-00003c50: 207b 6e61 6d65 7d20 3220 2d2d 7374 6174   {name} 2 --stat
-00003c60: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
-00003c70: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00003c80: 657d 202d 2d73 7461 7475 7320 7c20 6772  e} --status | gr
-00003c90: 6570 2022 4a6f 6220 323a 2053 5543 4345  ep "Job 2: SUCCE
-00003ca0: 4544 4544 2227 2c20 2023 2045 7175 6976  EDED"',  # Equiv
-00003cb0: 616c 656e 742e 0a20 2020 2020 2020 205d  alent..        ]
-00003cc0: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-00003cd0: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
-00003ce0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-00003cf0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-00003d00: 4070 7974 6573 742e 6d61 726b 2e61 7773  @pytest.mark.aws
-00003d10: 0a64 6566 2074 6573 745f 6177 735f 696d  .def test_aws_im
-00003d20: 6167 655f 6964 5f64 6963 7428 293a 0a20  age_id_dict():. 
-00003d30: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-00003d40: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-00003d50: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-00003d60: 2020 2020 2020 2027 6177 735f 696d 6167         'aws_imag
-00003d70: 655f 6964 5f64 6963 7427 2c0a 2020 2020  e_id_dict',.    
-00003d80: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-00003d90: 2020 2320 5573 6520 696d 6167 6520 6964    # Use image id
-00003da0: 2064 6963 742e 0a20 2020 2020 2020 2020   dict..         
-00003db0: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-00003dc0: 2d79 202d 6320 7b6e 616d 657d 2065 7861  -y -c {name} exa
-00003dd0: 6d70 6c65 732f 7065 725f 7265 6769 6f6e  mples/per_region
-00003de0: 5f69 6d61 6765 732e 7961 6d6c 272c 0a20  _images.yaml',. 
-00003df0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00003e00: 2065 7865 6320 7b6e 616d 657d 2065 7861   exec {name} exa
-00003e10: 6d70 6c65 732f 7065 725f 7265 6769 6f6e  mples/per_region
-00003e20: 5f69 6d61 6765 732e 7961 6d6c 272c 0a20  _images.yaml',. 
-00003e30: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00003e40: 2065 7865 6320 7b6e 616d 657d 2022 6c73   exec {name} "ls
-00003e50: 207e 2227 2c0a 2020 2020 2020 2020 2020   ~"',.          
-00003e60: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-00003e70: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
-00003e80: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00003e90: 6b79 206c 6f67 7320 7b6e 616d 657d 2032  ky logs {name} 2
-00003ea0: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
-00003eb0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-00003ec0: 6773 207b 6e61 6d65 7d20 3320 2d2d 7374  gs {name} 3 --st
-00003ed0: 6174 7573 272c 0a20 2020 2020 2020 205d  atus',.        ]
-00003ee0: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-00003ef0: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
-00003f00: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-00003f10: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-00003f20: 4070 7974 6573 742e 6d61 726b 2e67 6370  @pytest.mark.gcp
-00003f30: 0a64 6566 2074 6573 745f 6763 705f 696d  .def test_gcp_im
-00003f40: 6167 655f 6964 5f64 6963 7428 293a 0a20  age_id_dict():. 
-00003f50: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-00003f60: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-00003f70: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-00003f80: 2020 2020 2020 2027 6763 705f 696d 6167         'gcp_imag
-00003f90: 655f 6964 5f64 6963 7427 2c0a 2020 2020  e_id_dict',.    
-00003fa0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-00003fb0: 2020 2320 5573 6520 696d 6167 6520 6964    # Use image id
-00003fc0: 2064 6963 742e 0a20 2020 2020 2020 2020   dict..         
-00003fd0: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-00003fe0: 2d79 202d 6320 7b6e 616d 657d 2074 6573  -y -c {name} tes
-00003ff0: 7473 2f74 6573 745f 7961 6d6c 732f 6763  ts/test_yamls/gc
-00004000: 705f 7065 725f 7265 6769 6f6e 5f69 6d61  p_per_region_ima
-00004010: 6765 732e 7961 6d6c 272c 0a20 2020 2020  ges.yaml',.     
-00004020: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-00004030: 6320 7b6e 616d 657d 2074 6573 7473 2f74  c {name} tests/t
-00004040: 6573 745f 7961 6d6c 732f 6763 705f 7065  est_yamls/gcp_pe
-00004050: 725f 7265 6769 6f6e 5f69 6d61 6765 732e  r_region_images.
-00004060: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-00004070: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-00004080: 616d 657d 2022 6c73 207e 2227 2c0a 2020  ame} "ls ~"',.  
-00004090: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000040a0: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
-000040b0: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
-000040c0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-000040d0: 7b6e 616d 657d 2032 202d 2d73 7461 7475  {name} 2 --statu
-000040e0: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
-000040f0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-00004100: 7d20 3320 2d2d 7374 6174 7573 272c 0a20  } 3 --status',. 
-00004110: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00004120: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-00004130: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
-00004140: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00004150: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-00004160: 6d61 726b 2e61 7773 0a64 6566 2074 6573  mark.aws.def tes
-00004170: 745f 6177 735f 696d 6167 655f 6964 5f64  t_aws_image_id_d
-00004180: 6963 745f 7265 6769 6f6e 2829 3a0a 2020  ict_region():.  
-00004190: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-000041a0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-000041b0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-000041c0: 2020 2020 2020 2761 7773 5f69 6d61 6765        'aws_image
-000041d0: 5f69 645f 6469 6374 5f72 6567 696f 6e27  _id_dict_region'
-000041e0: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-000041f0: 2020 2020 2020 2020 2320 5941 4d4c 2068          # YAML h
-00004200: 6173 0a20 2020 2020 2020 2020 2020 2023  as.            #
-00004210: 2020 2069 6d61 6765 5f69 643a 0a20 2020     image_id:.   
-00004220: 2020 2020 2020 2020 2023 2020 2020 2020           #      
-00004230: 2075 732d 7765 7374 2d32 3a20 736b 7970   us-west-2: skyp
-00004240: 696c 6f74 3a67 7075 2d75 6275 6e74 752d  ilot:gpu-ubuntu-
-00004250: 3138 3034 0a20 2020 2020 2020 2020 2020  1804.           
-00004260: 2023 2020 2020 2020 2075 732d 6561 7374   #       us-east
-00004270: 2d32 3a20 736b 7970 696c 6f74 3a67 7075  -2: skypilot:gpu
-00004280: 2d75 6275 6e74 752d 3230 3034 0a20 2020  -ubuntu-2004.   
-00004290: 2020 2020 2020 2020 2023 2055 7365 2072           # Use r
-000042a0: 6567 696f 6e20 746f 2066 696c 7465 7220  egion to filter 
-000042b0: 696d 6167 655f 6964 2064 6963 742e 0a20  image_id dict.. 
-000042c0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-000042d0: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
-000042e0: 616d 657d 202d 2d72 6567 696f 6e20 7573  ame} --region us
-000042f0: 2d65 6173 742d 3120 6578 616d 706c 6573  -east-1 examples
-00004300: 2f70 6572 5f72 6567 696f 6e5f 696d 6167  /per_region_imag
-00004310: 6573 2e79 616d 6c20 2626 2065 7869 7420  es.yaml && exit 
-00004320: 3120 7c7c 2074 7275 6527 2c0a 2020 2020  1 || true',.    
-00004330: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
-00004340: 6174 7573 207c 2067 7265 7020 7b6e 616d  atus | grep {nam
-00004350: 657d 2026 2620 6578 6974 2031 207c 7c20  e} && exit 1 || 
-00004360: 7472 7565 272c 2020 2320 456e 7375 7265  true',  # Ensure
-00004370: 2074 6865 2063 6c75 7374 6572 2069 7320   the cluster is 
-00004380: 6e6f 7420 6372 6561 7465 642e 0a20 2020  not created..   
-00004390: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-000043a0: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-000043b0: 657d 202d 2d72 6567 696f 6e20 7573 2d65  e} --region us-e
-000043c0: 6173 742d 3220 6578 616d 706c 6573 2f70  ast-2 examples/p
-000043d0: 6572 5f72 6567 696f 6e5f 696d 6167 6573  er_region_images
-000043e0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-000043f0: 2020 2020 2320 5368 6f75 6c64 2073 7563      # Should suc
-00004400: 6365 7373 2062 6563 6175 7365 2074 6865  cess because the
-00004410: 2069 6d61 6765 2069 6420 6d61 7463 6820   image id match 
-00004420: 666f 7220 7468 6520 7265 6769 6f6e 2e0a  for the region..
-00004430: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00004440: 7920 6c61 756e 6368 202d 6320 7b6e 616d  y launch -c {nam
-00004450: 657d 202d 2d69 6d61 6765 2d69 6420 736b  e} --image-id sk
-00004460: 7970 696c 6f74 3a67 7075 2d75 6275 6e74  ypilot:gpu-ubunt
-00004470: 752d 3230 3034 2065 7861 6d70 6c65 732f  u-2004 examples/
-00004480: 6d69 6e69 6d61 6c2e 7961 6d6c 272c 0a20  minimal.yaml',. 
-00004490: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-000044a0: 2065 7865 6320 7b6e 616d 657d 202d 2d69   exec {name} --i
-000044b0: 6d61 6765 2d69 6420 736b 7970 696c 6f74  mage-id skypilot
-000044c0: 3a67 7075 2d75 6275 6e74 752d 3230 3034  :gpu-ubuntu-2004
-000044d0: 2065 7861 6d70 6c65 732f 6d69 6e69 6d61   examples/minima
-000044e0: 6c2e 7961 6d6c 272c 0a20 2020 2020 2020  l.yaml',.       
-000044f0: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-00004500: 7b6e 616d 657d 202d 2d69 6d61 6765 2d69  {name} --image-i
-00004510: 6420 736b 7970 696c 6f74 3a67 7075 2d75  d skypilot:gpu-u
-00004520: 6275 6e74 752d 3138 3034 2065 7861 6d70  buntu-1804 examp
-00004530: 6c65 732f 6d69 6e69 6d61 6c2e 7961 6d6c  les/minimal.yaml
-00004540: 2026 2620 6578 6974 2031 207c 7c20 7472   && exit 1 || tr
-00004550: 7565 272c 0a20 2020 2020 2020 2020 2020  ue',.           
-00004560: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00004570: 657d 2031 202d 2d73 7461 7475 7327 2c0a  e} 1 --status',.
-00004580: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00004590: 7920 6c6f 6773 207b 6e61 6d65 7d20 3220  y logs {name} 2 
-000045a0: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
-000045b0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-000045c0: 7320 7b6e 616d 657d 2033 202d 2d73 7461  s {name} 3 --sta
-000045d0: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
-000045e0: 2020 6627 736b 7920 7374 6174 7573 202d    f'sky status -
-000045f0: 2d61 6c6c 207c 2067 7265 7020 7b6e 616d  -all | grep {nam
-00004600: 657d 207c 2067 7265 7020 7573 2d65 6173  e} | grep us-eas
-00004610: 742d 3227 2c20 2023 2045 6e73 7572 6520  t-2',  # Ensure 
-00004620: 7468 6520 7265 6769 6f6e 2069 7320 636f  the region is co
-00004630: 7272 6563 742e 0a20 2020 2020 2020 2020  rrect..         
-00004640: 2020 2023 2045 6e73 7572 6520 6578 6563     # Ensure exec
-00004650: 2077 6f72 6b73 2e0a 2020 2020 2020 2020   works..        
-00004660: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-00004670: 6e61 6d65 7d20 2d2d 7265 6769 6f6e 2075  name} --region u
-00004680: 732d 6561 7374 2d32 2065 7861 6d70 6c65  s-east-2 example
-00004690: 732f 7065 725f 7265 6769 6f6e 5f69 6d61  s/per_region_ima
-000046a0: 6765 732e 7961 6d6c 272c 0a20 2020 2020  ges.yaml',.     
-000046b0: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-000046c0: 6320 7b6e 616d 657d 2065 7861 6d70 6c65  c {name} example
-000046d0: 732f 7065 725f 7265 6769 6f6e 5f69 6d61  s/per_region_ima
-000046e0: 6765 732e 7961 6d6c 272c 0a20 2020 2020  ges.yaml',.     
-000046f0: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-00004700: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
-00004710: 2061 7773 202d 2d72 6567 696f 6e20 7573   aws --region us
-00004720: 2d65 6173 742d 3220 226c 7320 7e22 272c  -east-2 "ls ~"',
-00004730: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00004740: 6b79 2065 7865 6320 7b6e 616d 657d 2022  ky exec {name} "
-00004750: 6c73 207e 2227 2c0a 2020 2020 2020 2020  ls ~"',.        
-00004760: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-00004770: 6e61 6d65 7d20 3420 2d2d 7374 6174 7573  name} 4 --status
-00004780: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00004790: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-000047a0: 2035 202d 2d73 7461 7475 7327 2c0a 2020   5 --status',.  
+00001210: 2020 2020 2020 2020 2032 342c 0a20 2020           24,.   
+00001220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001250: 2020 2020 2061 6464 5f75 7365 725f 6861       add_user_ha
+00001260: 7368 3d46 616c 7365 290a 2020 2020 7265  sh=False).    re
+00001270: 7475 726e 2066 277b 7465 7374 5f6e 616d  turn f'{test_nam
+00001280: 657d 2d7b 7465 7374 5f69 647d 270a 0a0a  e}-{test_id}'...
+00001290: 6465 6620 5f74 6572 6d69 6e61 7465 5f67  def _terminate_g
+000012a0: 6370 5f72 6570 6c69 6361 286e 616d 653a  cp_replica(name:
+000012b0: 2073 7472 2c20 7a6f 6e65 3a20 7374 722c   str, zone: str,
+000012c0: 2072 6570 6c69 6361 5f69 643a 2069 6e74   replica_id: int
+000012d0: 2920 2d3e 2073 7472 3a0a 2020 2020 636c  ) -> str:.    cl
+000012e0: 7573 7465 725f 6e61 6d65 203d 2073 6572  uster_name = ser
+000012f0: 7665 2e67 656e 6572 6174 655f 7265 706c  ve.generate_repl
+00001300: 6963 615f 636c 7573 7465 725f 6e61 6d65  ica_cluster_name
+00001310: 286e 616d 652c 2072 6570 6c69 6361 5f69  (name, replica_i
+00001320: 6429 0a20 2020 2071 7565 7279 5f63 6d64  d).    query_cmd
+00001330: 203d 2028 6627 6763 6c6f 7564 2063 6f6d   = (f'gcloud com
+00001340: 7075 7465 2069 6e73 7461 6e63 6573 206c  pute instances l
+00001350: 6973 7420 2d2d 6669 6c74 6572 3d27 0a20  ist --filter='. 
+00001360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001370: 6627 2228 6c61 6265 6c73 2e72 6179 2d63  f'"(labels.ray-c
+00001380: 6c75 7374 6572 2d6e 616d 653a 7b63 6c75  luster-name:{clu
+00001390: 7374 6572 5f6e 616d 657d 2922 2027 0a20  ster_name})" '. 
+000013a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000013b0: 6627 2d2d 7a6f 6e65 733d 7b7a 6f6e 657d  f'--zones={zone}
+000013c0: 202d 2d66 6f72 6d61 743d 2276 616c 7565   --format="value
+000013d0: 286e 616d 6529 2227 290a 2020 2020 7265  (name)"').    re
+000013e0: 7475 726e 2028 6627 6763 6c6f 7564 2063  turn (f'gcloud c
+000013f0: 6f6d 7075 7465 2069 6e73 7461 6e63 6573  ompute instances
+00001400: 2064 656c 6574 6520 2d2d 7a6f 6e65 3d7b   delete --zone={
+00001410: 7a6f 6e65 7d27 0a20 2020 2020 2020 2020  zone}'.         
+00001420: 2020 2066 2720 2d2d 7175 6965 7420 2428     f' --quiet $(
+00001430: 7b71 7565 7279 5f63 6d64 7d29 2729 0a0a  {query_cmd})')..
+00001440: 0a64 6566 2072 756e 5f6f 6e65 5f74 6573  .def run_one_tes
+00001450: 7428 7465 7374 3a20 5465 7374 2920 2d3e  t(test: Test) ->
+00001460: 2054 7570 6c65 5b69 6e74 2c20 7374 722c   Tuple[int, str,
+00001470: 2073 7472 5d3a 0a20 2020 2023 2046 6169   str]:.    # Fai
+00001480: 6c20 6661 7374 2069 6620 6073 6b79 6020  l fast if `sky` 
+00001490: 434c 4920 736f 6d65 686f 7720 6572 726f  CLI somehow erro
+000014a0: 7273 206f 7574 2e0a 2020 2020 7375 6270  rs out..    subp
+000014b0: 726f 6365 7373 2e72 756e 285b 2773 6b79  rocess.run(['sky
+000014c0: 272c 2027 7374 6174 7573 275d 2c20 7374  ', 'status'], st
+000014d0: 646f 7574 3d73 7562 7072 6f63 6573 732e  dout=subprocess.
+000014e0: 4445 564e 554c 4c2c 2063 6865 636b 3d54  DEVNULL, check=T
+000014f0: 7275 6529 0a20 2020 206c 6f67 5f66 696c  rue).    log_fil
+00001500: 6520 3d20 7465 6d70 6669 6c65 2e4e 616d  e = tempfile.Nam
+00001510: 6564 5465 6d70 6f72 6172 7946 696c 6528  edTemporaryFile(
+00001520: 2761 272c 0a20 2020 2020 2020 2020 2020  'a',.           
+00001530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001550: 7072 6566 6978 3d66 277b 7465 7374 2e6e  prefix=f'{test.n
+00001560: 616d 657d 2d27 2c0a 2020 2020 2020 2020  ame}-',.        
+00001570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001590: 2020 2073 7566 6669 783d 272e 6c6f 6727     suffix='.log'
+000015a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000015b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000015c0: 2020 2020 2020 2020 2020 2020 2064 656c               del
+000015d0: 6574 653d 4661 6c73 6529 0a20 2020 2074  ete=False).    t
+000015e0: 6573 742e 6563 686f 2866 2754 6573 7420  est.echo(f'Test 
+000015f0: 7374 6172 7465 642e 204c 6f67 3a20 6c65  started. Log: le
+00001600: 7373 207b 6c6f 675f 6669 6c65 2e6e 616d  ss {log_file.nam
+00001610: 657d 2729 0a20 2020 2066 6f72 2063 6f6d  e}').    for com
+00001620: 6d61 6e64 2069 6e20 7465 7374 2e63 6f6d  mand in test.com
+00001630: 6d61 6e64 733a 0a20 2020 2020 2020 206c  mands:.        l
+00001640: 6f67 5f66 696c 652e 7772 6974 6528 6627  og_file.write(f'
+00001650: 2b20 7b63 6f6d 6d61 6e64 7d5c 6e27 290a  + {command}\n').
+00001660: 2020 2020 2020 2020 6c6f 675f 6669 6c65          log_file
+00001670: 2e66 6c75 7368 2829 0a20 2020 2020 2020  .flush().       
+00001680: 2070 726f 6320 3d20 7375 6270 726f 6365   proc = subproce
+00001690: 7373 2e50 6f70 656e 280a 2020 2020 2020  ss.Popen(.      
+000016a0: 2020 2020 2020 636f 6d6d 616e 642c 0a20        command,. 
+000016b0: 2020 2020 2020 2020 2020 2073 7464 6f75             stdou
+000016c0: 743d 6c6f 675f 6669 6c65 2c0a 2020 2020  t=log_file,.    
+000016d0: 2020 2020 2020 2020 7374 6465 7272 3d73          stderr=s
+000016e0: 7562 7072 6f63 6573 732e 5354 444f 5554  ubprocess.STDOUT
+000016f0: 2c0a 2020 2020 2020 2020 2020 2020 7368  ,.            sh
+00001700: 656c 6c3d 5472 7565 2c0a 2020 2020 2020  ell=True,.      
+00001710: 2020 2020 2020 6578 6563 7574 6162 6c65        executable
+00001720: 3d27 2f62 696e 2f62 6173 6827 2c0a 2020  ='/bin/bash',.  
+00001730: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00001740: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00001750: 2070 726f 632e 7761 6974 2874 696d 656f   proc.wait(timeo
+00001760: 7574 3d74 6573 742e 7469 6d65 6f75 7429  ut=test.timeout)
+00001770: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+00001780: 7375 6270 726f 6365 7373 2e54 696d 656f  subprocess.Timeo
+00001790: 7574 4578 7069 7265 6420 6173 2065 3a0a  utExpired as e:.
+000017a0: 2020 2020 2020 2020 2020 2020 6c6f 675f              log_
+000017b0: 6669 6c65 2e66 6c75 7368 2829 0a20 2020  file.flush().   
+000017c0: 2020 2020 2020 2020 2074 6573 742e 6563           test.ec
+000017d0: 686f 2866 2754 696d 656f 7574 2061 6674  ho(f'Timeout aft
+000017e0: 6572 207b 7465 7374 2e74 696d 656f 7574  er {test.timeout
+000017f0: 7d20 7365 636f 6e64 732e 2729 0a20 2020  } seconds.').   
+00001800: 2020 2020 2020 2020 2074 6573 742e 6563           test.ec
+00001810: 686f 2873 7472 2865 2929 0a20 2020 2020  ho(str(e)).     
+00001820: 2020 2020 2020 206c 6f67 5f66 696c 652e         log_file.
+00001830: 7772 6974 6528 6627 5469 6d65 6f75 7420  write(f'Timeout 
+00001840: 6166 7465 7220 7b74 6573 742e 7469 6d65  after {test.time
+00001850: 6f75 747d 2073 6563 6f6e 6473 2e5c 6e27  out} seconds.\n'
+00001860: 290a 2020 2020 2020 2020 2020 2020 6c6f  ).            lo
+00001870: 675f 6669 6c65 2e66 6c75 7368 2829 0a20  g_file.flush(). 
+00001880: 2020 2020 2020 2020 2020 2023 204b 696c             # Kil
+00001890: 6c20 7468 6520 6375 7272 656e 7420 7072  l the current pr
+000018a0: 6f63 6573 732e 0a20 2020 2020 2020 2020  ocess..         
+000018b0: 2020 2070 726f 632e 7465 726d 696e 6174     proc.terminat
+000018c0: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
+000018d0: 7072 6f63 2e72 6574 7572 6e63 6f64 6520  proc.returncode 
+000018e0: 3d20 3120 2023 204e 6f6e 6520 6966 2077  = 1  # None if w
+000018f0: 6520 646f 6e27 7420 7365 7420 6974 2e0a  e don't set it..
+00001900: 2020 2020 2020 2020 2020 2020 6272 6561              brea
+00001910: 6b0a 0a20 2020 2020 2020 2069 6620 7072  k..        if pr
+00001920: 6f63 2e72 6574 7572 6e63 6f64 653a 0a20  oc.returncode:. 
+00001930: 2020 2020 2020 2020 2020 2062 7265 616b             break
+00001940: 0a0a 2020 2020 7374 796c 6520 3d20 636f  ..    style = co
+00001950: 6c6f 7261 6d61 2e53 7479 6c65 0a20 2020  lorama.Style.   
+00001960: 2066 6f72 6520 3d20 636f 6c6f 7261 6d61   fore = colorama
+00001970: 2e46 6f72 650a 2020 2020 6f75 7463 6f6d  .Fore.    outcom
+00001980: 6520 3d20 2866 277b 666f 7265 2e52 4544  e = (f'{fore.RED
+00001990: 7d46 6169 6c65 647b 7374 796c 652e 5245  }Failed{style.RE
+000019a0: 5345 545f 414c 4c7d 270a 2020 2020 2020  SET_ALL}'.      
+000019b0: 2020 2020 2020 2020 2069 6620 7072 6f63           if proc
+000019c0: 2e72 6574 7572 6e63 6f64 6520 656c 7365  .returncode else
+000019d0: 2066 277b 666f 7265 2e47 5245 454e 7d50   f'{fore.GREEN}P
+000019e0: 6173 7365 647b 7374 796c 652e 5245 5345  assed{style.RESE
+000019f0: 545f 414c 4c7d 2729 0a20 2020 2072 6561  T_ALL}').    rea
+00001a00: 736f 6e20 3d20 6627 5c6e 5265 6173 6f6e  son = f'\nReason
+00001a10: 3a20 7b63 6f6d 6d61 6e64 7d27 2069 6620  : {command}' if 
+00001a20: 7072 6f63 2e72 6574 7572 6e63 6f64 6520  proc.returncode 
+00001a30: 656c 7365 2027 270a 2020 2020 6d73 6720  else ''.    msg 
+00001a40: 3d20 2866 277b 6f75 7463 6f6d 657d 2e27  = (f'{outcome}.'
+00001a50: 0a20 2020 2020 2020 2020 2020 6627 7b72  .           f'{r
+00001a60: 6561 736f 6e7d 270a 2020 2020 2020 2020  eason}'.        
+00001a70: 2020 2066 275c 6e4c 6f67 3a20 6c65 7373     f'\nLog: less
+00001a80: 207b 6c6f 675f 6669 6c65 2e6e 616d 657d   {log_file.name}
+00001a90: 5c6e 2729 0a20 2020 2074 6573 742e 6563  \n').    test.ec
+00001aa0: 686f 286d 7367 290a 2020 2020 6c6f 675f  ho(msg).    log_
+00001ab0: 6669 6c65 2e77 7269 7465 286d 7367 290a  file.write(msg).
+00001ac0: 2020 2020 6966 2028 7072 6f63 2e72 6574      if (proc.ret
+00001ad0: 7572 6e63 6f64 6520 3d3d 2030 206f 720a  urncode == 0 or.
+00001ae0: 2020 2020 2020 2020 2020 2020 7079 7465              pyte
+00001af0: 7374 2e74 6572 6d69 6e61 7465 5f6f 6e5f  st.terminate_on_
+00001b00: 6661 696c 7572 6529 2061 6e64 2074 6573  failure) and tes
+00001b10: 742e 7465 6172 646f 776e 2069 7320 6e6f  t.teardown is no
+00001b20: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00001b30: 7375 6270 726f 6365 7373 5f75 7469 6c73  subprocess_utils
+00001b40: 2e72 756e 280a 2020 2020 2020 2020 2020  .run(.          
+00001b50: 2020 7465 7374 2e74 6561 7264 6f77 6e2c    test.teardown,
+00001b60: 0a20 2020 2020 2020 2020 2020 2073 7464  .            std
+00001b70: 6f75 743d 6c6f 675f 6669 6c65 2c0a 2020  out=log_file,.  
+00001b80: 2020 2020 2020 2020 2020 7374 6465 7272            stderr
+00001b90: 3d73 7562 7072 6f63 6573 732e 5354 444f  =subprocess.STDO
+00001ba0: 5554 2c0a 2020 2020 2020 2020 2020 2020  UT,.            
+00001bb0: 7469 6d65 6f75 743d 3130 202a 2036 302c  timeout=10 * 60,
+00001bc0: 2020 2320 3130 206d 696e 730a 2020 2020    # 10 mins.    
+00001bd0: 2020 2020 2020 2020 7368 656c 6c3d 5472          shell=Tr
+00001be0: 7565 2c0a 2020 2020 2020 2020 290a 0a20  ue,.        ).. 
+00001bf0: 2020 2069 6620 7072 6f63 2e72 6574 7572     if proc.retur
+00001c00: 6e63 6f64 653a 0a20 2020 2020 2020 2072  ncode:.        r
+00001c10: 6169 7365 2045 7863 6570 7469 6f6e 2866  aise Exception(f
+00001c20: 2774 6573 7420 6661 696c 6564 3a20 6c65  'test failed: le
+00001c30: 7373 207b 6c6f 675f 6669 6c65 2e6e 616d  ss {log_file.nam
+00001c40: 657d 2729 0a0a 0a64 6566 2067 6574 5f61  e}')...def get_a
+00001c50: 7773 5f72 6567 696f 6e5f 666f 725f 7175  ws_region_for_qu
+00001c60: 6f74 615f 6661 696c 6f76 6572 2829 202d  ota_failover() -
+00001c70: 3e20 4f70 7469 6f6e 616c 5b73 7472 5d3a  > Optional[str]:
+00001c80: 0a20 2020 2063 616e 6469 6461 7465 5f72  .    candidate_r
+00001c90: 6567 696f 6e73 203d 2041 5753 2e72 6567  egions = AWS.reg
+00001ca0: 696f 6e73 5f77 6974 685f 6f66 6665 7269  ions_with_offeri
+00001cb0: 6e67 2869 6e73 7461 6e63 655f 7479 7065  ng(instance_type
+00001cc0: 3d27 7033 2e31 3678 6c61 7267 6527 2c0a  ='p3.16xlarge',.
+00001cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001d00: 2020 6163 6365 6c65 7261 746f 7273 3d4e    accelerators=N
+00001d10: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+00001d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001d40: 2020 2020 2020 2075 7365 5f73 706f 743d         use_spot=
+00001d50: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
+00001d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001d80: 2020 2020 2020 2020 7265 6769 6f6e 3d4e          region=N
+00001d90: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+00001da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001dc0: 2020 2020 2020 207a 6f6e 653d 4e6f 6e65         zone=None
+00001dd0: 290a 2020 2020 6f72 6967 696e 616c 5f72  ).    original_r
+00001de0: 6573 6f75 7263 6573 203d 2073 6b79 2e52  esources = sky.R
+00001df0: 6573 6f75 7263 6573 2863 6c6f 7564 3d73  esources(cloud=s
+00001e00: 6b79 2e41 5753 2829 2c0a 2020 2020 2020  ky.AWS(),.      
+00001e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001e30: 2069 6e73 7461 6e63 655f 7479 7065 3d27   instance_type='
+00001e40: 7033 2e31 3678 6c61 7267 6527 2c0a 2020  p3.16xlarge',.  
+00001e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001e70: 2020 2020 2075 7365 5f73 706f 743d 5472       use_spot=Tr
+00001e80: 7565 290a 0a20 2020 2023 2046 696c 7465  ue)..    # Filte
+00001e90: 7220 7468 6520 7265 6769 6f6e 7320 7769  r the regions wi
+00001ea0: 7468 2070 726f 7879 2063 6f6d 6d61 6e64  th proxy command
+00001eb0: 2069 6e20 7e2f 2e73 6b79 2f63 6f6e 6669   in ~/.sky/confi
+00001ec0: 672e 7961 6d6c 2e0a 2020 2020 6669 6c74  g.yaml..    filt
+00001ed0: 6572 6564 5f72 6567 696f 6e73 203d 206f  ered_regions = o
+00001ee0: 7269 6769 6e61 6c5f 7265 736f 7572 6365  riginal_resource
+00001ef0: 732e 6765 745f 7661 6c69 645f 7265 6769  s.get_valid_regi
+00001f00: 6f6e 735f 666f 725f 6c61 756e 6368 6162  ons_for_launchab
+00001f10: 6c65 2829 0a20 2020 2063 616e 6469 6461  le().    candida
+00001f20: 7465 5f72 6567 696f 6e73 203d 205b 0a20  te_regions = [. 
+00001f30: 2020 2020 2020 2072 6567 696f 6e20 666f         region fo
+00001f40: 7220 7265 6769 6f6e 2069 6e20 6361 6e64  r region in cand
+00001f50: 6964 6174 655f 7265 6769 6f6e 730a 2020  idate_regions.  
+00001f60: 2020 2020 2020 6966 2072 6567 696f 6e2e        if region.
+00001f70: 6e61 6d65 2069 6e20 6669 6c74 6572 6564  name in filtered
+00001f80: 5f72 6567 696f 6e73 0a20 2020 205d 0a0a  _regions.    ]..
+00001f90: 2020 2020 666f 7220 7265 6769 6f6e 2069      for region i
+00001fa0: 6e20 6361 6e64 6964 6174 655f 7265 6769  n candidate_regi
+00001fb0: 6f6e 733a 0a20 2020 2020 2020 2072 6573  ons:.        res
+00001fc0: 6f75 7263 6573 203d 206f 7269 6769 6e61  ources = origina
+00001fd0: 6c5f 7265 736f 7572 6365 732e 636f 7079  l_resources.copy
+00001fe0: 2872 6567 696f 6e3d 7265 6769 6f6e 2e6e  (region=region.n
+00001ff0: 616d 6529 0a20 2020 2020 2020 2069 6620  ame).        if 
+00002000: 6e6f 7420 4157 532e 6368 6563 6b5f 7175  not AWS.check_qu
+00002010: 6f74 615f 6176 6169 6c61 626c 6528 7265  ota_available(re
+00002020: 736f 7572 6365 7329 3a0a 2020 2020 2020  sources):.      
+00002030: 2020 2020 2020 7265 7475 726e 2072 6567        return reg
+00002040: 696f 6e2e 6e61 6d65 0a0a 2020 2020 7265  ion.name..    re
+00002050: 7475 726e 204e 6f6e 650a 0a0a 6465 6620  turn None...def 
+00002060: 6765 745f 6763 705f 7265 6769 6f6e 5f66  get_gcp_region_f
+00002070: 6f72 5f71 756f 7461 5f66 6169 6c6f 7665  or_quota_failove
+00002080: 7228 2920 2d3e 204f 7074 696f 6e61 6c5b  r() -> Optional[
+00002090: 7374 725d 3a0a 0a20 2020 2063 616e 6469  str]:..    candi
+000020a0: 6461 7465 5f72 6567 696f 6e73 203d 2047  date_regions = G
+000020b0: 4350 2e72 6567 696f 6e73 5f77 6974 685f  CP.regions_with_
+000020c0: 6f66 6665 7269 6e67 2869 6e73 7461 6e63  offering(instanc
+000020d0: 655f 7479 7065 3d4e 6f6e 652c 0a20 2020  e_type=None,.   
+000020e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000020f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002100: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00002110: 6363 656c 6572 6174 6f72 733d 7b27 4131  ccelerators={'A1
+00002120: 3030 2d38 3047 4227 3a20 317d 2c0a 2020  00-80GB': 1},.  
+00002130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002160: 7573 655f 7370 6f74 3d54 7275 652c 0a20  use_spot=True,. 
+00002170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000021a0: 2072 6567 696f 6e3d 4e6f 6e65 2c0a 2020   region=None,.  
+000021b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000021c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000021d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000021e0: 7a6f 6e65 3d4e 6f6e 6529 0a0a 2020 2020  zone=None)..    
+000021f0: 6f72 6967 696e 616c 5f72 6573 6f75 7263  original_resourc
+00002200: 6573 203d 2073 6b79 2e52 6573 6f75 7263  es = sky.Resourc
+00002210: 6573 2863 6c6f 7564 3d73 6b79 2e47 4350  es(cloud=sky.GCP
+00002220: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
+00002230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002240: 2020 2020 2020 2020 2020 2069 6e73 7461             insta
+00002250: 6e63 655f 7479 7065 3d27 6132 2d75 6c74  nce_type='a2-ult
+00002260: 7261 6770 752d 3167 272c 0a20 2020 2020  ragpu-1g',.     
+00002270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002290: 2020 6163 6365 6c65 7261 746f 7273 3d7b    accelerators={
+000022a0: 2741 3130 302d 3830 4742 273a 2031 7d2c  'A100-80GB': 1},
+000022b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000022c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000022d0: 2020 2020 2020 2020 7573 655f 7370 6f74          use_spot
+000022e0: 3d54 7275 6529 0a0a 2020 2020 2320 4669  =True)..    # Fi
+000022f0: 6c74 6572 2074 6865 2072 6567 696f 6e73  lter the regions
+00002300: 2077 6974 6820 7072 6f78 7920 636f 6d6d   with proxy comm
+00002310: 616e 6420 696e 207e 2f2e 736b 792f 636f  and in ~/.sky/co
+00002320: 6e66 6967 2e79 616d 6c2e 0a20 2020 2066  nfig.yaml..    f
+00002330: 696c 7465 7265 645f 7265 6769 6f6e 7320  iltered_regions 
+00002340: 3d20 6f72 6967 696e 616c 5f72 6573 6f75  = original_resou
+00002350: 7263 6573 2e67 6574 5f76 616c 6964 5f72  rces.get_valid_r
+00002360: 6567 696f 6e73 5f66 6f72 5f6c 6175 6e63  egions_for_launc
+00002370: 6861 626c 6528 290a 2020 2020 6361 6e64  hable().    cand
+00002380: 6964 6174 655f 7265 6769 6f6e 7320 3d20  idate_regions = 
+00002390: 5b0a 2020 2020 2020 2020 7265 6769 6f6e  [.        region
+000023a0: 2066 6f72 2072 6567 696f 6e20 696e 2063   for region in c
+000023b0: 616e 6469 6461 7465 5f72 6567 696f 6e73  andidate_regions
+000023c0: 0a20 2020 2020 2020 2069 6620 7265 6769  .        if regi
+000023d0: 6f6e 2e6e 616d 6520 696e 2066 696c 7465  on.name in filte
+000023e0: 7265 645f 7265 6769 6f6e 730a 2020 2020  red_regions.    
+000023f0: 5d0a 0a20 2020 2066 6f72 2072 6567 696f  ]..    for regio
+00002400: 6e20 696e 2063 616e 6469 6461 7465 5f72  n in candidate_r
+00002410: 6567 696f 6e73 3a0a 2020 2020 2020 2020  egions:.        
+00002420: 6966 206e 6f74 2047 4350 2e63 6865 636b  if not GCP.check
+00002430: 5f71 756f 7461 5f61 7661 696c 6162 6c65  _quota_available
+00002440: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00002450: 2020 6f72 6967 696e 616c 5f72 6573 6f75    original_resou
+00002460: 7263 6573 2e63 6f70 7928 7265 6769 6f6e  rces.copy(region
+00002470: 3d72 6567 696f 6e2e 6e61 6d65 2929 3a0a  =region.name)):.
+00002480: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00002490: 726e 2072 6567 696f 6e2e 6e61 6d65 0a0a  rn region.name..
+000024a0: 2020 2020 7265 7475 726e 204e 6f6e 650a      return None.
+000024b0: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2044  ..# ---------- D
+000024c0: 7279 2072 756e 3a20 3220 5461 736b 7320  ry run: 2 Tasks 
+000024d0: 696e 2061 2063 6861 696e 2e20 2d2d 2d2d  in a chain. ----
+000024e0: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
+000024f0: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
+00002500: 6b20 2023 7265 7175 6972 6573 2047 4350  k  #requires GCP
+00002510: 2061 6e64 2041 5753 2073 6574 2075 700a   and AWS set up.
+00002520: 6465 6620 7465 7374 5f65 7861 6d70 6c65  def test_example
+00002530: 5f61 7070 2829 3a0a 2020 2020 7465 7374  _app():.    test
+00002540: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+00002550: 2027 6578 616d 706c 655f 6170 7027 2c0a   'example_app',.
+00002560: 2020 2020 2020 2020 5b27 7079 7468 6f6e          ['python
+00002570: 2065 7861 6d70 6c65 732f 6578 616d 706c   examples/exampl
+00002580: 655f 6170 702e 7079 275d 2c0a 2020 2020  e_app.py'],.    
+00002590: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+000025a0: 7374 2874 6573 7429 0a0a 0a5f 5641 4c49  st(test)..._VALI
+000025b0: 4441 5445 5f4c 4155 4e43 485f 4f55 5450  DATE_LAUNCH_OUTP
+000025c0: 5554 203d 2028 0a20 2020 2023 2056 616c  UT = (.    # Val
+000025d0: 6964 6174 6520 7468 6520 6f75 7470 7574  idate the output
+000025e0: 206f 6620 7468 6520 6a6f 6220 7375 626d   of the job subm
+000025f0: 6973 7369 6f6e 3a0a 2020 2020 2320 4920  ission:.    # I 
+00002600: 3035 2d32 3320 3037 3a35 323a 3437 2063  05-23 07:52:47 c
+00002610: 6c6f 7564 5f76 6d5f 7261 795f 6261 636b  loud_vm_ray_back
+00002620: 656e 642e 7079 3a33 3231 375d 2052 756e  end.py:3217] Run
+00002630: 6e69 6e67 2073 6574 7570 206f 6e20 3120  ning setup on 1 
+00002640: 6e6f 6465 2e0a 2020 2020 2320 7275 6e6e  node..    # runn
+00002650: 696e 6720 7365 7475 700a 2020 2020 2320  ing setup.    # 
+00002660: 4920 3035 2d32 3320 3037 3a35 323a 3439  I 05-23 07:52:49
+00002670: 2063 6c6f 7564 5f76 6d5f 7261 795f 6261   cloud_vm_ray_ba
+00002680: 636b 656e 642e 7079 3a33 3233 305d 2053  ckend.py:3230] S
+00002690: 6574 7570 2063 6f6d 706c 6574 6564 2e0a  etup completed..
+000026a0: 2020 2020 2320 4920 3035 2d32 3320 3037      # I 05-23 07
+000026b0: 3a35 323a 3535 2063 6c6f 7564 5f76 6d5f  :52:55 cloud_vm_
+000026c0: 7261 795f 6261 636b 656e 642e 7079 3a33  ray_backend.py:3
+000026d0: 3331 395d 204a 6f62 2073 7562 6d69 7474  319] Job submitt
+000026e0: 6564 2077 6974 6820 4a6f 6220 4944 3a20  ed with Job ID: 
+000026f0: 310a 2020 2020 2320 4920 3035 2d32 3320  1.    # I 05-23 
+00002700: 3037 3a35 323a 3538 206c 6f67 5f6c 6962  07:52:58 log_lib
+00002710: 2e70 793a 3430 385d 2053 7461 7274 2073  .py:408] Start s
+00002720: 7472 6561 6d69 6e67 206c 6f67 7320 666f  treaming logs fo
+00002730: 7220 6a6f 6220 312e 0a20 2020 2023 2049  r job 1..    # I
+00002740: 4e46 4f3a 2054 6970 3a20 7573 6520 4374  NFO: Tip: use Ct
+00002750: 726c 2d43 2074 6f20 6578 6974 206c 6f67  rl-C to exit log
+00002760: 2073 7472 6561 6d69 6e67 2028 7461 736b   streaming (task
+00002770: 2077 696c 6c20 6e6f 7420 6265 206b 696c   will not be kil
+00002780: 6c65 6429 2e0a 2020 2020 2320 494e 464f  led)..    # INFO
+00002790: 3a20 5761 6974 696e 6720 666f 7220 7461  : Waiting for ta
+000027a0: 736b 2072 6573 6f75 7263 6573 206f 6e20  sk resources on 
+000027b0: 3120 6e6f 6465 2e20 5468 6973 2077 696c  1 node. This wil
+000027c0: 6c20 626c 6f63 6b20 6966 2074 6865 2063  l block if the c
+000027d0: 6c75 7374 6572 2069 7320 6675 6c6c 2e0a  luster is full..
+000027e0: 2020 2020 2320 494e 464f 3a20 416c 6c20      # INFO: All 
+000027f0: 7461 736b 2072 6573 6f75 7263 6573 2072  task resources r
+00002800: 6573 6572 7665 642e 0a20 2020 2023 2049  eserved..    # I
+00002810: 4e46 4f3a 2052 6573 6572 7665 6420 4950  NFO: Reserved IP
+00002820: 733a 205b 2731 302e 3132 382e 302e 3132  s: ['10.128.0.12
+00002830: 3727 5d0a 2020 2020 2320 286d 696e 2c20  7'].    # (min, 
+00002840: 7069 643d 3431 3634 2920 2320 636f 6e64  pid=4164) # cond
+00002850: 6120 656e 7669 726f 6e6d 656e 7473 3a0a  a environments:.
+00002860: 2020 2020 2320 286d 696e 2c20 7069 643d      # (min, pid=
+00002870: 3431 3634 2920 230a 2020 2020 2320 286d  4164) #.    # (m
+00002880: 696e 2c20 7069 643d 3431 3634 2920 6261  in, pid=4164) ba
+00002890: 7365 2020 2020 2020 2020 2020 2020 2020  se              
+000028a0: 2020 2020 2a20 202f 6f70 742f 636f 6e64      *  /opt/cond
+000028b0: 610a 2020 2020 2320 286d 696e 2c20 7069  a.    # (min, pi
+000028c0: 643d 3431 3634 290a 2020 2020 2320 286d  d=4164).    # (m
+000028d0: 696e 2c20 7069 643d 3431 3634 2920 7461  in, pid=4164) ta
+000028e0: 736b 2072 756e 2066 696e 6973 680a 2020  sk run finish.  
+000028f0: 2020 2320 494e 464f 3a20 4a6f 6220 6669    # INFO: Job fi
+00002900: 6e69 7368 6564 2028 7374 6174 7573 3a20  nished (status: 
+00002910: 5355 4343 4545 4445 4429 2e0a 2020 2020  SUCCEEDED)..    
+00002920: 2765 6368 6f20 2224 7322 2026 2620 6563  'echo "$s" && ec
+00002930: 686f 2022 3d3d 5661 6c69 6461 7469 6e67  ho "==Validating
+00002940: 2073 6574 7570 206f 7574 7075 743d 3d22   setup output=="
+00002950: 2026 2620 270a 2020 2020 2765 6368 6f20   && '.    'echo 
+00002960: 2224 7322 207c 2067 7265 7020 2d41 2031  "$s" | grep -A 1
+00002970: 2022 5275 6e6e 696e 6720 7365 7475 7020   "Running setup 
+00002980: 6f6e 2220 7c20 6772 6570 2022 7275 6e6e  on" | grep "runn
+00002990: 696e 6720 7365 7475 7022 2026 2620 270a  ing setup" && '.
+000029a0: 2020 2020 2765 6368 6f20 223d 3d56 616c      'echo "==Val
+000029b0: 6964 6174 696e 6720 7275 6e6e 696e 6720  idating running 
+000029c0: 6f75 7470 7574 2068 696e 7473 3d3d 2220  output hints==" 
+000029d0: 2626 2065 6368 6f20 2224 7322 207c 2027  && echo "$s" | '
+000029e0: 0a20 2020 2027 6772 6570 202d 4120 3120  .    'grep -A 1 
+000029f0: 224a 6f62 2073 7562 6d69 7474 6564 2077  "Job submitted w
+00002a00: 6974 6820 4a6f 6220 4944 3a22 207c 2027  ith Job ID:" | '
+00002a10: 0a20 2020 2027 6772 6570 2022 5374 6172  .    'grep "Star
+00002a20: 7420 7374 7265 616d 696e 6720 6c6f 6773  t streaming logs
+00002a30: 2066 6f72 206a 6f62 2220 2626 2027 0a20   for job" && '. 
+00002a40: 2020 2027 6563 686f 2022 3d3d 5661 6c69     'echo "==Vali
+00002a50: 6461 7469 6e67 2074 6173 6b20 6f75 7470  dating task outp
+00002a60: 7574 2073 7461 7274 696e 673d 3d22 2026  ut starting==" &
+00002a70: 2620 6563 686f 2022 2473 2220 7c20 270a  & echo "$s" | '.
+00002a80: 2020 2020 2767 7265 7020 2d41 2031 2022      'grep -A 1 "
+00002a90: 494e 464f 3a20 5265 7365 7276 6564 2049  INFO: Reserved I
+00002aa0: 5073 2220 7c20 6772 6570 2022 286d 696e  Ps" | grep "(min
+00002ab0: 2c20 7069 643d 2220 2626 2027 0a20 2020  , pid=" && '.   
+00002ac0: 2027 6563 686f 2022 3d3d 5661 6c69 6461   'echo "==Valida
+00002ad0: 7469 6e67 2074 6173 6b20 6f75 7470 7574  ting task output
+00002ae0: 2065 6e64 696e 673d 3d22 2026 2620 270a   ending==" && '.
+00002af0: 2020 2020 2765 6368 6f20 2224 7322 207c      'echo "$s" |
+00002b00: 2067 7265 7020 2d41 2031 2022 7461 736b   grep -A 1 "task
+00002b10: 2072 756e 2066 696e 6973 6822 207c 2027   run finish" | '
+00002b20: 0a20 2020 2027 6772 6570 2022 494e 464f  .    'grep "INFO
+00002b30: 3a20 4a6f 6220 6669 6e69 7368 6564 2028  : Job finished (
+00002b40: 7374 6174 7573 3a20 5355 4343 4545 4445  status: SUCCEEDE
+00002b50: 4429 2220 2626 2027 0a20 2020 2027 6563  D)" && '.    'ec
+00002b60: 686f 2022 3d3d 5661 6c69 6461 7469 6e67  ho "==Validating
+00002b70: 2074 6173 6b20 6f75 7470 7574 2065 6e64   task output end
+00002b80: 696e 6720 323d 3d22 2026 2620 270a 2020  ing 2==" && '.  
+00002b90: 2020 2765 6368 6f20 2224 7322 207c 2067    'echo "$s" | g
+00002ba0: 7265 7020 2d41 2031 2022 494e 464f 3a20  rep -A 1 "INFO: 
+00002bb0: 4a6f 6220 6669 6e69 7368 6564 2028 7374  Job finished (st
+00002bc0: 6174 7573 3a20 5355 4343 4545 4445 4429  atus: SUCCEEDED)
+00002bd0: 2220 7c20 270a 2020 2020 2767 7265 7020  " | '.    'grep 
+00002be0: 224a 6f62 2049 443a 2227 290a 0a0a 2320  "Job ID:"')...# 
+00002bf0: 2d2d 2d2d 2d2d 2d2d 2d2d 2041 206d 696e  ---------- A min
+00002c00: 696d 616c 2074 6173 6b20 2d2d 2d2d 2d2d  imal task ------
+00002c10: 2d2d 2d2d 0a64 6566 2074 6573 745f 6d69  ----.def test_mi
+00002c20: 6e69 6d61 6c28 6765 6e65 7269 635f 636c  nimal(generic_cl
+00002c30: 6f75 643a 2073 7472 293a 0a20 2020 206e  oud: str):.    n
+00002c40: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+00002c50: 6572 5f6e 616d 6528 290a 2020 2020 7661  er_name().    va
+00002c60: 6c69 6461 7465 5f6f 7574 7075 7420 3d20  lidate_output = 
+00002c70: 5f56 414c 4944 4154 455f 4c41 554e 4348  _VALIDATE_LAUNCH
+00002c80: 5f4f 5554 5055 540a 2020 2020 2320 4b75  _OUTPUT.    # Ku
+00002c90: 6265 726e 6574 6573 2077 696c 6c20 6f75  bernetes will ou
+00002ca0: 7470 7574 2061 2053 5348 2057 6172 6e69  tput a SSH Warni
+00002cb0: 6e67 2066 6f72 2070 726f 7879 206a 756d  ng for proxy jum
+00002cc0: 702c 2077 6869 6368 2077 696c 6c20 6361  p, which will ca
+00002cd0: 7573 650a 2020 2020 2320 7468 6520 6f75  use.    # the ou
+00002ce0: 7470 7574 2076 616c 6964 6174 696f 6e20  tput validation 
+00002cf0: 6661 696c 2e20 5765 2073 6b69 7020 7468  fail. We skip th
+00002d00: 6520 6368 6563 6b20 666f 7220 6b75 6265  e check for kube
+00002d10: 726e 6574 6573 2066 6f72 206e 6f77 2e0a  rnetes for now..
+00002d20: 2020 2020 6966 2067 656e 6572 6963 5f63      if generic_c
+00002d30: 6c6f 7564 2e6c 6f77 6572 2829 203d 3d20  loud.lower() == 
+00002d40: 276b 7562 6572 6e65 7465 7327 3a0a 2020  'kubernetes':.  
+00002d50: 2020 2020 2020 7661 6c69 6461 7465 5f6f        validate_o
+00002d60: 7574 7075 7420 3d20 2774 7275 6527 0a20  utput = 'true'. 
+00002d70: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+00002d80: 2020 2020 2020 2020 276d 696e 696d 616c          'minimal
+00002d90: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+00002da0: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
+00002db0: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+00002dc0: 7b6e 616d 657d 202d 2d63 6c6f 7564 207b  {name} --cloud {
+00002dd0: 6765 6e65 7269 635f 636c 6f75 647d 2074  generic_cloud} t
+00002de0: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
+00002df0: 6d69 6e69 6d61 6c2e 7961 6d6c 2920 2626  minimal.yaml) &&
+00002e00: 207b 7661 6c69 6461 7465 5f6f 7574 7075   {validate_outpu
+00002e10: 747d 272c 0a20 2020 2020 2020 2020 2020  t}',.           
+00002e20: 2023 204f 7574 7075 7420 7661 6c69 6461   # Output valida
+00002e30: 7469 6f6e 2064 6f6e 652e 0a20 2020 2020  tion done..     
+00002e40: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00002e50: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
+00002e60: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
+00002e70: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+00002e80: 6d65 7d20 2d2d 7374 6174 7573 207c 2067  me} --status | g
+00002e90: 7265 7020 224a 6f62 2031 3a20 5355 4343  rep "Job 1: SUCC
+00002ea0: 4545 4445 4422 272c 2020 2320 4571 7569  EEDED"',  # Equi
+00002eb0: 7661 6c65 6e74 2e0a 2020 2020 2020 2020  valent..        
+00002ec0: 2020 2020 2320 5465 7374 206c 6175 6e63      # Test launc
+00002ed0: 6820 6f75 7470 7574 2061 6761 696e 206f  h output again o
+00002ee0: 6e20 6578 6973 7469 6e67 2063 6c75 7374  n existing clust
+00002ef0: 6572 0a20 2020 2020 2020 2020 2020 2066  er.            f
+00002f00: 2773 3d24 2873 6b79 206c 6175 6e63 6820  's=$(sky launch 
+00002f10: 2d79 202d 6320 7b6e 616d 657d 202d 2d63  -y -c {name} --c
+00002f20: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
+00002f30: 6f75 647d 2074 6573 7473 2f74 6573 745f  oud} tests/test_
+00002f40: 7961 6d6c 732f 6d69 6e69 6d61 6c2e 7961  yamls/minimal.ya
+00002f50: 6d6c 2920 2626 207b 7661 6c69 6461 7465  ml) && {validate
+00002f60: 5f6f 7574 7075 747d 272c 0a20 2020 2020  _output}',.     
+00002f70: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00002f80: 7320 7b6e 616d 657d 2032 202d 2d73 7461  s {name} 2 --sta
+00002f90: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
+00002fa0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+00002fb0: 6d65 7d20 2d2d 7374 6174 7573 207c 2067  me} --status | g
+00002fc0: 7265 7020 224a 6f62 2032 3a20 5355 4343  rep "Job 2: SUCC
+00002fd0: 4545 4445 4422 272c 2020 2320 4571 7569  EEDED"',  # Equi
+00002fe0: 7661 6c65 6e74 2e0a 2020 2020 2020 2020  valent..        
+00002ff0: 2020 2020 2320 4368 6563 6b20 7468 6520      # Check the 
+00003000: 6c6f 6773 2064 6f77 6e6c 6f61 6469 6e67  logs downloading
+00003010: 0a20 2020 2020 2020 2020 2020 2066 276c  .            f'l
+00003020: 6f67 5f70 6174 683d 2428 736b 7920 6c6f  og_path=$(sky lo
+00003030: 6773 207b 6e61 6d65 7d20 3120 2d2d 7379  gs {name} 1 --sy
+00003040: 6e63 2d64 6f77 6e20 7c20 6772 6570 2022  nc-down | grep "
+00003050: 4a6f 6220 3120 6c6f 6773 3a22 207c 2073  Job 1 logs:" | s
+00003060: 6564 202d 4520 2273 2f5e 2e2a 4a6f 6220  ed -E "s/^.*Job 
+00003070: 3120 6c6f 6773 3a20 282e 2a29 5c5c 7831  1 logs: (.*)\\x1
+00003080: 625c 5c5b 306d 2f5c 5c31 2f67 2229 2026  b\\[0m/\\1/g") &
+00003090: 2620 6563 686f 2022 246c 6f67 5f70 6174  & echo "$log_pat
+000030a0: 6822 2026 2620 7465 7374 202d 6620 246c  h" && test -f $l
+000030b0: 6f67 5f70 6174 682f 7275 6e2e 6c6f 6727  og_path/run.log'
+000030c0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+000030d0: 456e 7375 7265 2074 6865 2072 6179 6c65  Ensure the rayle
+000030e0: 7420 7072 6f63 6573 7320 6861 7320 7468  t process has th
+000030f0: 6520 636f 7272 6563 7420 6669 6c65 2064  e correct file d
+00003100: 6573 6372 6970 746f 7220 6c69 6d69 742e  escriptor limit.
+00003110: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00003120: 6b79 2065 7865 6320 7b6e 616d 657d 2022  ky exec {name} "
+00003130: 7072 6c69 6d69 7420 2d6e 202d 2d70 6964  prlimit -n --pid
+00003140: 3d5c 2428 7067 7265 7020 2d66 205c 2772  =\$(pgrep -f \'r
+00003150: 6179 6c65 742f 7261 796c 6574 202d 2d72  aylet/raylet --r
+00003160: 6179 6c65 745f 736f 636b 6574 5f6e 616d  aylet_socket_nam
+00003170: 655c 2729 207c 2067 7265 7020 5c27 225c  e\') | grep \'"\
+00003180: 2731 3034 3835 3736 2031 3034 3835 3736  '1048576 1048576
+00003190: 5c27 225c 2722 272c 0a20 2020 2020 2020  \'"\'"',.       
+000031a0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+000031b0: 7b6e 616d 657d 2033 202d 2d73 7461 7475  {name} 3 --statu
+000031c0: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
+000031d0: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
+000031e0: 0a20 2020 2020 2020 2020 2020 2023 2049  .            # I
+000031f0: 6e73 7461 6c6c 206a 7120 666f 7220 7468  nstall jq for th
+00003200: 6520 6e65 7874 2074 6573 742e 0a20 2020  e next test..   
+00003210: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+00003220: 7865 6320 7b6e 616d 657d 205c 2773 7564  xec {name} \'sud
+00003230: 6f20 6170 742d 6765 7420 7570 6461 7465  o apt-get update
+00003240: 2026 2620 7375 646f 2061 7074 2d67 6574   && sudo apt-get
+00003250: 2069 6e73 7461 6c6c 202d 7920 6a71 5c27   install -y jq\'
+00003260: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
+00003270: 2043 6865 636b 2074 6865 2063 6c75 7374   Check the clust
+00003280: 6572 2069 6e66 6f0a 2020 2020 2020 2020  er info.        
+00003290: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+000032a0: 6e61 6d65 7d20 5c27 6563 686f 2022 2453  name} \'echo "$S
+000032b0: 4b59 5049 4c4f 545f 434c 5553 5445 525f  KYPILOT_CLUSTER_
+000032c0: 494e 464f 2220 7c20 6a71 202e 636c 7573  INFO" | jq .clus
+000032d0: 7465 725f 6e61 6d65 207c 2067 7265 7020  ter_name | grep 
+000032e0: 7b6e 616d 657d 5c27 272c 0a20 2020 2020  {name}\'',.     
+000032f0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00003300: 7320 7b6e 616d 657d 2035 202d 2d73 7461  s {name} 5 --sta
+00003310: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
+00003320: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
+00003330: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
+00003340: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+00003350: 205c 2765 6368 6f20 2224 534b 5950 494c   \'echo "$SKYPIL
+00003360: 4f54 5f43 4c55 5354 4552 5f49 4e46 4f22  OT_CLUSTER_INFO"
+00003370: 207c 206a 7120 2e63 6c6f 7564 207c 2067   | jq .cloud | g
+00003380: 7265 7020 2d69 207b 6765 6e65 7269 635f  rep -i {generic_
+00003390: 636c 6f75 647d 5c27 272c 0a20 2020 2020  cloud}\'',.     
+000033a0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+000033b0: 7320 7b6e 616d 657d 2036 202d 2d73 7461  s {name} 6 --sta
+000033c0: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
+000033d0: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
+000033e0: 642e 0a20 2020 2020 2020 2020 2020 2023  d..            #
+000033f0: 2054 6573 7420 272d 6327 2066 6f72 2065   Test '-c' for e
+00003400: 7865 630a 2020 2020 2020 2020 2020 2020  xec.            
+00003410: 6627 736b 7920 6578 6563 202d 6320 7b6e  f'sky exec -c {n
+00003420: 616d 657d 2065 6368 6f27 2c0a 2020 2020  ame} echo',.    
+00003430: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+00003440: 6773 207b 6e61 6d65 7d20 3720 2d2d 7374  gs {name} 7 --st
+00003450: 6174 7573 272c 0a20 2020 2020 2020 2020  atus',.         
+00003460: 2020 2066 2773 6b79 2065 7865 6320 6563     f'sky exec ec
+00003470: 686f 202d 6320 7b6e 616d 657d 272c 0a20  ho -c {name}',. 
+00003480: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00003490: 206c 6f67 7320 7b6e 616d 657d 2038 202d   logs {name} 8 -
+000034a0: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
+000034b0: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+000034c0: 202d 6320 7b6e 616d 657d 2065 6368 6f20   -c {name} echo 
+000034d0: 6869 2074 6573 7427 2c0a 2020 2020 2020  hi test',.      
+000034e0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+000034f0: 207b 6e61 6d65 7d20 3920 7c20 6772 6570   {name} 9 | grep
+00003500: 2022 6869 2074 6573 7422 272c 0a20 2020   "hi test"',.   
+00003510: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+00003520: 7865 6320 7b6e 616d 657d 2026 2620 6578  xec {name} && ex
+00003530: 6974 2031 207c 7c20 7472 7565 272c 0a20  it 1 || true',. 
+00003540: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00003550: 2065 7865 6320 2d63 207b 6e61 6d65 7d20   exec -c {name} 
+00003560: 2626 2065 7869 7420 3120 7c7c 2074 7275  && exit 1 || tru
+00003570: 6527 2c0a 2020 2020 2020 2020 5d2c 0a20  e',.        ],. 
+00003580: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
+00003590: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
+000035a0: 2020 2020 2020 5f67 6574 5f74 696d 656f        _get_timeo
+000035b0: 7574 2867 656e 6572 6963 5f63 6c6f 7564  ut(generic_cloud
+000035c0: 292c 0a20 2020 2029 0a20 2020 2072 756e  ),.    ).    run
+000035d0: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+000035e0: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054  ..# ---------- T
+000035f0: 6573 7420 7265 6769 6f6e 202d 2d2d 2d2d  est region -----
+00003600: 2d2d 2d2d 2d0a 4070 7974 6573 742e 6d61  -----.@pytest.ma
+00003610: 726b 2e61 7773 0a64 6566 2074 6573 745f  rk.aws.def test_
+00003620: 6177 735f 7265 6769 6f6e 2829 3a0a 2020  aws_region():.  
+00003630: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+00003640: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+00003650: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+00003660: 2020 2020 2020 2761 7773 5f72 6567 696f        'aws_regio
+00003670: 6e27 2c0a 2020 2020 2020 2020 5b0a 2020  n',.        [.  
+00003680: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00003690: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
+000036a0: 6d65 7d20 2d2d 7265 6769 6f6e 2075 732d  me} --region us-
+000036b0: 6561 7374 2d32 2065 7861 6d70 6c65 732f  east-2 examples/
+000036c0: 6d69 6e69 6d61 6c2e 7961 6d6c 272c 0a20  minimal.yaml',. 
+000036d0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000036e0: 2065 7865 6320 7b6e 616d 657d 2065 7861   exec {name} exa
+000036f0: 6d70 6c65 732f 6d69 6e69 6d61 6c2e 7961  mples/minimal.ya
+00003700: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+00003710: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+00003720: 657d 2031 202d 2d73 7461 7475 7327 2c20  e} 1 --status', 
+00003730: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
+00003740: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
+00003750: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
+00003760: 7461 7475 7320 2d2d 616c 6c20 7c20 6772  tatus --all | gr
+00003770: 6570 207b 6e61 6d65 7d20 7c20 6772 6570  ep {name} | grep
+00003780: 2075 732d 6561 7374 2d32 272c 2020 2320   us-east-2',  # 
+00003790: 456e 7375 7265 2074 6865 2072 6567 696f  Ensure the regio
+000037a0: 6e20 6973 2063 6f72 7265 6374 2e0a 2020  n is correct..  
+000037b0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000037c0: 6578 6563 207b 6e61 6d65 7d20 5c27 6563  exec {name} \'ec
+000037d0: 686f 2024 534b 5950 494c 4f54 5f43 4c55  ho $SKYPILOT_CLU
+000037e0: 5354 4552 5f49 4e46 4f20 7c20 6a71 202e  STER_INFO | jq .
+000037f0: 7265 6769 6f6e 207c 2067 7265 7020 7573  region | grep us
+00003800: 2d65 6173 742d 325c 2727 2c0a 2020 2020  -east-2\'',.    
+00003810: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+00003820: 6773 207b 6e61 6d65 7d20 3220 2d2d 7374  gs {name} 2 --st
+00003830: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
+00003840: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
+00003850: 6564 2e0a 2020 2020 2020 2020 5d2c 0a20  ed..        ],. 
+00003860: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
+00003870: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
+00003880: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+00003890: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
+000038a0: 7465 7374 2e6d 6172 6b2e 6763 700a 6465  test.mark.gcp.de
+000038b0: 6620 7465 7374 5f67 6370 5f72 6567 696f  f test_gcp_regio
+000038c0: 6e5f 616e 645f 7365 7276 6963 655f 6163  n_and_service_ac
+000038d0: 636f 756e 7428 293a 0a20 2020 206e 616d  count():.    nam
+000038e0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+000038f0: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+00003900: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+00003910: 2027 6763 705f 7265 6769 6f6e 272c 0a20   'gcp_region',. 
+00003920: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+00003930: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+00003940: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
+00003950: 2d72 6567 696f 6e20 7573 2d63 656e 7472  -region us-centr
+00003960: 616c 3120 2d2d 636c 6f75 6420 6763 7020  al1 --cloud gcp 
+00003970: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
+00003980: 2f6d 696e 696d 616c 2e79 616d 6c27 2c0a  /minimal.yaml',.
+00003990: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+000039a0: 7920 6578 6563 207b 6e61 6d65 7d20 7465  y exec {name} te
+000039b0: 7374 732f 7465 7374 5f79 616d 6c73 2f6d  sts/test_yamls/m
+000039c0: 696e 696d 616c 2e79 616d 6c27 2c0a 2020  inimal.yaml',.  
+000039d0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000039e0: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
+000039f0: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
+00003a00: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
+00003a10: 6564 6564 2e0a 2020 2020 2020 2020 2020  eded..          
+00003a20: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+00003a30: 6d65 7d20 5c27 6375 726c 202d 4820 224d  me} \'curl -H "M
+00003a40: 6574 6164 6174 612d 466c 6176 6f72 3a20  etadata-Flavor: 
+00003a50: 476f 6f67 6c65 2220 2268 7474 703a 2f2f  Google" "http://
+00003a60: 6d65 7461 6461 7461 2e67 6f6f 676c 652e  metadata.google.
+00003a70: 696e 7465 726e 616c 2f63 6f6d 7075 7465  internal/compute
+00003a80: 4d65 7461 6461 7461 2f76 312f 696e 7374  Metadata/v1/inst
+00003a90: 616e 6365 2f73 6572 7669 6365 2d61 6363  ance/service-acc
+00003aa0: 6f75 6e74 732f 6465 6661 756c 742f 6964  ounts/default/id
+00003ab0: 656e 7469 7479 3f66 6f72 6d61 743d 7374  entity?format=st
+00003ac0: 616e 6461 7264 2661 7564 6965 6e63 653d  andard&audience=
+00003ad0: 6763 7022 5c27 272c 0a20 2020 2020 2020  gcp"\'',.       
+00003ae0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00003af0: 7b6e 616d 657d 2032 202d 2d73 7461 7475  {name} 2 --statu
+00003b00: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
+00003b10: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
+00003b20: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00003b30: 6b79 2073 7461 7475 7320 2d2d 616c 6c20  ky status --all 
+00003b40: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
+00003b50: 6772 6570 2075 732d 6365 6e74 7261 6c31  grep us-central1
+00003b60: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
+00003b70: 2072 6567 696f 6e20 6973 2063 6f72 7265   region is corre
+00003b80: 6374 2e0a 2020 2020 2020 2020 2020 2020  ct..            
+00003b90: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+00003ba0: 7d20 5c27 6563 686f 2024 534b 5950 494c  } \'echo $SKYPIL
+00003bb0: 4f54 5f43 4c55 5354 4552 5f49 4e46 4f20  OT_CLUSTER_INFO 
+00003bc0: 7c20 6a71 202e 7265 6769 6f6e 207c 2067  | jq .region | g
+00003bd0: 7265 7020 7573 2d63 656e 7472 616c 315c  rep us-central1\
+00003be0: 2727 2c0a 2020 2020 2020 2020 2020 2020  '',.            
+00003bf0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00003c00: 7d20 3320 2d2d 7374 6174 7573 272c 2020  } 3 --status',  
+00003c10: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
+00003c20: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
+00003c30: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+00003c40: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+00003c50: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
+00003c60: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+00003c70: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+00003c80: 6b2e 6962 6d0a 6465 6620 7465 7374 5f69  k.ibm.def test_i
+00003c90: 626d 5f72 6567 696f 6e28 293a 0a20 2020  bm_region():.   
+00003ca0: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+00003cb0: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+00003cc0: 7265 6769 6f6e 203d 2027 6575 2d64 6527  region = 'eu-de'
+00003cd0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+00003ce0: 280a 2020 2020 2020 2020 2772 6567 696f  (.        'regio
+00003cf0: 6e27 2c0a 2020 2020 2020 2020 5b0a 2020  n',.        [.  
+00003d00: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00003d10: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
+00003d20: 6d65 7d20 2d2d 636c 6f75 6420 6962 6d20  me} --cloud ibm 
+00003d30: 2d2d 7265 6769 6f6e 207b 7265 6769 6f6e  --region {region
+00003d40: 7d20 6578 616d 706c 6573 2f6d 696e 696d  } examples/minim
+00003d50: 616c 2e79 616d 6c27 2c0a 2020 2020 2020  al.yaml',.      
+00003d60: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+00003d70: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+00003d80: 6962 6d20 6578 616d 706c 6573 2f6d 696e  ibm examples/min
+00003d90: 696d 616c 2e79 616d 6c27 2c0a 2020 2020  imal.yaml',.    
+00003da0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+00003db0: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
+00003dc0: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
+00003dd0: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
+00003de0: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+00003df0: 6627 736b 7920 7374 6174 7573 202d 2d61  f'sky status --a
+00003e00: 6c6c 207c 2067 7265 7020 7b6e 616d 657d  ll | grep {name}
+00003e10: 207c 2067 7265 7020 7b72 6567 696f 6e7d   | grep {region}
+00003e20: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
+00003e30: 2072 6567 696f 6e20 6973 2063 6f72 7265   region is corre
+00003e40: 6374 2e0a 2020 2020 2020 2020 5d2c 0a20  ct..        ],. 
+00003e50: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
+00003e60: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
+00003e70: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+00003e80: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
+00003e90: 7465 7374 2e6d 6172 6b2e 617a 7572 650a  test.mark.azure.
+00003ea0: 6465 6620 7465 7374 5f61 7a75 7265 5f72  def test_azure_r
+00003eb0: 6567 696f 6e28 293a 0a20 2020 206e 616d  egion():.    nam
+00003ec0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+00003ed0: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+00003ee0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+00003ef0: 2027 617a 7572 655f 7265 6769 6f6e 272c   'azure_region',
+00003f00: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+00003f10: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
+00003f20: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
+00003f30: 202d 2d72 6567 696f 6e20 6561 7374 7573   --region eastus
+00003f40: 3220 2d2d 636c 6f75 6420 617a 7572 6520  2 --cloud azure 
+00003f50: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
+00003f60: 2f6d 696e 696d 616c 2e79 616d 6c27 2c0a  /minimal.yaml',.
+00003f70: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00003f80: 7920 6578 6563 207b 6e61 6d65 7d20 7465  y exec {name} te
+00003f90: 7374 732f 7465 7374 5f79 616d 6c73 2f6d  sts/test_yamls/m
+00003fa0: 696e 696d 616c 2e79 616d 6c27 2c0a 2020  inimal.yaml',.  
+00003fb0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00003fc0: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
+00003fd0: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
+00003fe0: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
+00003ff0: 6564 6564 2e0a 2020 2020 2020 2020 2020  eded..          
+00004000: 2020 6627 736b 7920 7374 6174 7573 202d    f'sky status -
+00004010: 2d61 6c6c 207c 2067 7265 7020 7b6e 616d  -all | grep {nam
+00004020: 657d 207c 2067 7265 7020 6561 7374 7573  e} | grep eastus
+00004030: 3227 2c20 2023 2045 6e73 7572 6520 7468  2',  # Ensure th
+00004040: 6520 7265 6769 6f6e 2069 7320 636f 7272  e region is corr
+00004050: 6563 742e 0a20 2020 2020 2020 2020 2020  ect..           
+00004060: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+00004070: 657d 205c 2765 6368 6f20 2453 4b59 5049  e} \'echo $SKYPI
+00004080: 4c4f 545f 434c 5553 5445 525f 494e 464f  LOT_CLUSTER_INFO
+00004090: 207c 206a 7120 2e72 6567 696f 6e20 7c20   | jq .region | 
+000040a0: 6772 6570 2065 6173 7475 7332 5c27 272c  grep eastus2\'',
+000040b0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000040c0: 6b79 206c 6f67 7320 7b6e 616d 657d 2032  ky logs {name} 2
+000040d0: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+000040e0: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+000040f0: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
+00004100: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+00004110: 7b6e 616d 657d 205c 2765 6368 6f20 2453  {name} \'echo $S
+00004120: 4b59 5049 4c4f 545f 434c 5553 5445 525f  KYPILOT_CLUSTER_
+00004130: 494e 464f 207c 206a 7120 2e7a 6f6e 6520  INFO | jq .zone 
+00004140: 7c20 6772 6570 206e 756c 6c5c 2727 2c0a  | grep null\'',.
+00004150: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00004160: 7920 6c6f 6773 207b 6e61 6d65 7d20 3320  y logs {name} 3 
+00004170: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
+00004180: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
+00004190: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
+000041a0: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
+000041b0: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
+000041c0: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
+000041d0: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+000041e0: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465  .# ---------- Te
+000041f0: 7374 207a 6f6e 6520 2d2d 2d2d 2d2d 2d2d  st zone --------
+00004200: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
+00004210: 6177 730a 6465 6620 7465 7374 5f61 7773  aws.def test_aws
+00004220: 5f7a 6f6e 6528 293a 0a20 2020 206e 616d  _zone():.    nam
+00004230: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+00004240: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+00004250: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+00004260: 2027 6177 735f 7a6f 6e65 272c 0a20 2020   'aws_zone',.   
+00004270: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+00004280: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+00004290: 2d79 202d 6320 7b6e 616d 657d 2065 7861  -y -c {name} exa
+000042a0: 6d70 6c65 732f 6d69 6e69 6d61 6c2e 7961  mples/minimal.ya
+000042b0: 6d6c 202d 2d7a 6f6e 6520 7573 2d65 6173  ml --zone us-eas
+000042c0: 742d 3262 272c 0a20 2020 2020 2020 2020  t-2b',.         
+000042d0: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+000042e0: 616d 657d 2065 7861 6d70 6c65 732f 6d69  ame} examples/mi
+000042f0: 6e69 6d61 6c2e 7961 6d6c 202d 2d7a 6f6e  nimal.yaml --zon
+00004300: 6520 7573 2d65 6173 742d 3262 272c 0a20  e us-east-2b',. 
+00004310: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00004320: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
+00004330: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
+00004340: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
+00004350: 6565 6465 642e 0a20 2020 2020 2020 2020  eeded..         
+00004360: 2020 2066 2773 6b79 2073 7461 7475 7320     f'sky status 
+00004370: 2d2d 616c 6c20 7c20 6772 6570 207b 6e61  --all | grep {na
+00004380: 6d65 7d20 7c20 6772 6570 2075 732d 6561  me} | grep us-ea
+00004390: 7374 2d32 6227 2c20 2023 2045 6e73 7572  st-2b',  # Ensur
+000043a0: 6520 7468 6520 7a6f 6e65 2069 7320 636f  e the zone is co
+000043b0: 7272 6563 742e 0a20 2020 2020 2020 205d  rrect..        ]
+000043c0: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+000043d0: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+000043e0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+000043f0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00004400: 4070 7974 6573 742e 6d61 726b 2e69 626d  @pytest.mark.ibm
+00004410: 0a64 6566 2074 6573 745f 6962 6d5f 7a6f  .def test_ibm_zo
+00004420: 6e65 2829 3a0a 2020 2020 6e61 6d65 203d  ne():.    name =
+00004430: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+00004440: 6d65 2829 0a20 2020 207a 6f6e 6520 3d20  me().    zone = 
+00004450: 2765 752d 6465 2d32 270a 2020 2020 7465  'eu-de-2'.    te
+00004460: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00004470: 2020 2027 7a6f 6e65 272c 0a20 2020 2020     'zone',.     
+00004480: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00004490: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+000044a0: 202d 6320 7b6e 616d 657d 202d 2d63 6c6f   -c {name} --clo
+000044b0: 7564 2069 626d 2065 7861 6d70 6c65 732f  ud ibm examples/
+000044c0: 6d69 6e69 6d61 6c2e 7961 6d6c 202d 2d7a  minimal.yaml --z
+000044d0: 6f6e 6520 7b7a 6f6e 657d 272c 0a20 2020  one {zone}',.   
+000044e0: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+000044f0: 7865 6320 7b6e 616d 657d 202d 2d63 6c6f  xec {name} --clo
+00004500: 7564 2069 626d 2065 7861 6d70 6c65 732f  ud ibm examples/
+00004510: 6d69 6e69 6d61 6c2e 7961 6d6c 202d 2d7a  minimal.yaml --z
+00004520: 6f6e 6520 7b7a 6f6e 657d 272c 0a20 2020  one {zone}',.   
+00004530: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00004540: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
+00004550: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
+00004560: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
+00004570: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
+00004580: 2066 2773 6b79 2073 7461 7475 7320 2d2d   f'sky status --
+00004590: 616c 6c20 7c20 6772 6570 207b 6e61 6d65  all | grep {name
+000045a0: 7d20 7c20 6772 6570 207b 7a6f 6e65 7d27  } | grep {zone}'
+000045b0: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
+000045c0: 7a6f 6e65 2069 7320 636f 7272 6563 742e  zone is correct.
+000045d0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+000045e0: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
+000045f0: 7920 7b6e 616d 657d 207b 6e61 6d65 7d2d  y {name} {name}-
+00004600: 3220 7b6e 616d 657d 2d33 272c 0a20 2020  2 {name}-3',.   
+00004610: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+00004620: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
+00004630: 6573 742e 6d61 726b 2e67 6370 0a64 6566  est.mark.gcp.def
+00004640: 2074 6573 745f 6763 705f 7a6f 6e65 2829   test_gcp_zone()
+00004650: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+00004660: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+00004670: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+00004680: 280a 2020 2020 2020 2020 2767 6370 5f7a  (.        'gcp_z
+00004690: 6f6e 6527 2c0a 2020 2020 2020 2020 5b0a  one',.        [.
+000046a0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+000046b0: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+000046c0: 6e61 6d65 7d20 2d2d 7a6f 6e65 2075 732d  name} --zone us-
+000046d0: 6365 6e74 7261 6c31 2d61 202d 2d63 6c6f  central1-a --clo
+000046e0: 7564 2067 6370 2074 6573 7473 2f74 6573  ud gcp tests/tes
+000046f0: 745f 7961 6d6c 732f 6d69 6e69 6d61 6c2e  t_yamls/minimal.
+00004700: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00004710: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+00004720: 616d 657d 202d 2d7a 6f6e 6520 7573 2d63  ame} --zone us-c
+00004730: 656e 7472 616c 312d 6120 2d2d 636c 6f75  entral1-a --clou
+00004740: 6420 6763 7020 7465 7374 732f 7465 7374  d gcp tests/test
+00004750: 5f79 616d 6c73 2f6d 696e 696d 616c 2e79  _yamls/minimal.y
+00004760: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+00004770: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+00004780: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
+00004790: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
+000047a0: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
 000047b0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000047c0: 6c6f 6773 207b 6e61 6d65 7d20 3620 2d2d  logs {name} 6 --
-000047d0: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
-000047e0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-000047f0: 7b6e 616d 657d 2037 202d 2d73 7461 7475  {name} 7 --statu
-00004800: 7327 2c0a 2020 2020 2020 2020 5d2c 0a20  s',.        ],. 
-00004810: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
-00004820: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
-00004830: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-00004840: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
-00004850: 7465 7374 2e6d 6172 6b2e 6763 700a 6465  test.mark.gcp.de
-00004860: 6620 7465 7374 5f67 6370 5f69 6d61 6765  f test_gcp_image
-00004870: 5f69 645f 6469 6374 5f72 6567 696f 6e28  _id_dict_region(
-00004880: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
-00004890: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-000048a0: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
-000048b0: 7428 0a20 2020 2020 2020 2027 6763 705f  t(.        'gcp_
-000048c0: 696d 6167 655f 6964 5f64 6963 745f 7265  image_id_dict_re
-000048d0: 6769 6f6e 272c 0a20 2020 2020 2020 205b  gion',.        [
-000048e0: 0a20 2020 2020 2020 2020 2020 2023 2055  .            # U
-000048f0: 7365 2072 6567 696f 6e20 746f 2066 696c  se region to fil
-00004900: 7465 7220 696d 6167 655f 6964 2064 6963  ter image_id dic
-00004910: 742e 0a20 2020 2020 2020 2020 2020 2066  t..            f
-00004920: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-00004930: 6320 7b6e 616d 657d 202d 2d72 6567 696f  c {name} --regio
-00004940: 6e20 7573 2d65 6173 7431 2074 6573 7473  n us-east1 tests
-00004950: 2f74 6573 745f 7961 6d6c 732f 6763 705f  /test_yamls/gcp_
-00004960: 7065 725f 7265 6769 6f6e 5f69 6d61 6765  per_region_image
-00004970: 732e 7961 6d6c 2026 2620 6578 6974 2031  s.yaml && exit 1
-00004980: 207c 7c20 7472 7565 272c 0a20 2020 2020   || true',.     
-00004990: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
-000049a0: 7475 7320 7c20 6772 6570 207b 6e61 6d65  tus | grep {name
-000049b0: 7d20 2626 2065 7869 7420 3120 7c7c 2074  } && exit 1 || t
-000049c0: 7275 6527 2c20 2023 2045 6e73 7572 6520  rue',  # Ensure 
-000049d0: 7468 6520 636c 7573 7465 7220 6973 206e  the cluster is n
-000049e0: 6f74 2063 7265 6174 6564 2e0a 2020 2020  ot created..    
-000049f0: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-00004a00: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
-00004a10: 7d20 2d2d 7265 6769 6f6e 2075 732d 7765  } --region us-we
-00004a20: 7374 3320 7465 7374 732f 7465 7374 5f79  st3 tests/test_y
-00004a30: 616d 6c73 2f67 6370 5f70 6572 5f72 6567  amls/gcp_per_reg
-00004a40: 696f 6e5f 696d 6167 6573 2e79 616d 6c27  ion_images.yaml'
-00004a50: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00004a60: 5368 6f75 6c64 2073 7563 6365 7373 2062  Should success b
-00004a70: 6563 6175 7365 2074 6865 2069 6d61 6765  ecause the image
-00004a80: 2069 6420 6d61 7463 6820 666f 7220 7468   id match for th
-00004a90: 6520 7265 6769 6f6e 2e0a 2020 2020 2020  e region..      
-00004aa0: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-00004ab0: 6368 202d 6320 7b6e 616d 657d 202d 2d63  ch -c {name} --c
-00004ac0: 6c6f 7564 2067 6370 202d 2d69 6d61 6765  loud gcp --image
-00004ad0: 2d69 6420 7072 6f6a 6563 7473 2f75 6275  -id projects/ubu
-00004ae0: 6e74 752d 6f73 2d63 6c6f 7564 2f67 6c6f  ntu-os-cloud/glo
-00004af0: 6261 6c2f 696d 6167 6573 2f75 6275 6e74  bal/images/ubunt
-00004b00: 752d 3138 3034 2d62 696f 6e69 632d 7632  u-1804-bionic-v2
-00004b10: 3032 3330 3131 3220 7465 7374 732f 7465  0230112 tests/te
-00004b20: 7374 5f79 616d 6c73 2f6d 696e 696d 616c  st_yamls/minimal
-00004b30: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-00004b40: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-00004b50: 6e61 6d65 7d20 2d2d 636c 6f75 6420 6763  name} --cloud gc
-00004b60: 7020 2d2d 696d 6167 652d 6964 2070 726f  p --image-id pro
-00004b70: 6a65 6374 732f 7562 756e 7475 2d6f 732d  jects/ubuntu-os-
-00004b80: 636c 6f75 642f 676c 6f62 616c 2f69 6d61  cloud/global/ima
-00004b90: 6765 732f 7562 756e 7475 2d31 3830 342d  ges/ubuntu-1804-
-00004ba0: 6269 6f6e 6963 2d76 3230 3233 3031 3132  bionic-v20230112
-00004bb0: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
-00004bc0: 732f 6d69 6e69 6d61 6c2e 7961 6d6c 272c  s/minimal.yaml',
-00004bd0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00004be0: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
-00004bf0: 2d63 6c6f 7564 2067 6370 202d 2d69 6d61  -cloud gcp --ima
-00004c00: 6765 2d69 6420 736b 7970 696c 6f74 3a63  ge-id skypilot:c
-00004c10: 7075 2d64 6562 6961 6e2d 3130 2074 6573  pu-debian-10 tes
-00004c20: 7473 2f74 6573 745f 7961 6d6c 732f 6d69  ts/test_yamls/mi
-00004c30: 6e69 6d61 6c2e 7961 6d6c 2026 2620 6578  nimal.yaml && ex
-00004c40: 6974 2031 207c 7c20 7472 7565 272c 0a20  it 1 || true',. 
-00004c50: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00004c60: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
-00004c70: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
-00004c80: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-00004c90: 207b 6e61 6d65 7d20 3220 2d2d 7374 6174   {name} 2 --stat
-00004ca0: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
-00004cb0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00004cc0: 657d 2033 202d 2d73 7461 7475 7327 2c0a  e} 3 --status',.
-00004cd0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00004ce0: 7920 7374 6174 7573 202d 2d61 6c6c 207c  y status --all |
-00004cf0: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
-00004d00: 7265 7020 7573 2d77 6573 7433 272c 2020  rep us-west3',  
-00004d10: 2320 456e 7375 7265 2074 6865 2072 6567  # Ensure the reg
-00004d20: 696f 6e20 6973 2063 6f72 7265 6374 2e0a  ion is correct..
-00004d30: 2020 2020 2020 2020 2020 2020 2320 456e              # En
-00004d40: 7375 7265 2065 7865 6320 776f 726b 732e  sure exec works.
-00004d50: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00004d60: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
-00004d70: 2d72 6567 696f 6e20 7573 2d77 6573 7433  -region us-west3
-00004d80: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
-00004d90: 732f 6763 705f 7065 725f 7265 6769 6f6e  s/gcp_per_region
-00004da0: 5f69 6d61 6765 732e 7961 6d6c 272c 0a20  _images.yaml',. 
-00004db0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00004dc0: 2065 7865 6320 7b6e 616d 657d 2074 6573   exec {name} tes
-00004dd0: 7473 2f74 6573 745f 7961 6d6c 732f 6763  ts/test_yamls/gc
-00004de0: 705f 7065 725f 7265 6769 6f6e 5f69 6d61  p_per_region_ima
-00004df0: 6765 732e 7961 6d6c 272c 0a20 2020 2020  ges.yaml',.     
-00004e00: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-00004e10: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
-00004e20: 2067 6370 202d 2d72 6567 696f 6e20 7573   gcp --region us
-00004e30: 2d77 6573 7433 2022 6c73 207e 2227 2c0a  -west3 "ls ~"',.
-00004e40: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00004e50: 7920 6578 6563 207b 6e61 6d65 7d20 226c  y exec {name} "l
-00004e60: 7320 7e22 272c 0a20 2020 2020 2020 2020  s ~"',.         
-00004e70: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-00004e80: 616d 657d 2034 202d 2d73 7461 7475 7327  ame} 4 --status'
-00004e90: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00004ea0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-00004eb0: 3520 2d2d 7374 6174 7573 272c 0a20 2020  5 --status',.   
-00004ec0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00004ed0: 6f67 7320 7b6e 616d 657d 2036 202d 2d73  ogs {name} 6 --s
-00004ee0: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
-00004ef0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-00004f00: 6e61 6d65 7d20 3720 2d2d 7374 6174 7573  name} 7 --status
-00004f10: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-00004f20: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-00004f30: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-00004f40: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-00004f50: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
-00004f60: 6573 742e 6d61 726b 2e61 7773 0a64 6566  est.mark.aws.def
-00004f70: 2074 6573 745f 6177 735f 696d 6167 655f   test_aws_image_
-00004f80: 6964 5f64 6963 745f 7a6f 6e65 2829 3a0a  id_dict_zone():.
-00004f90: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-00004fa0: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-00004fb0: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-00004fc0: 2020 2020 2020 2020 2761 7773 5f69 6d61          'aws_ima
-00004fd0: 6765 5f69 645f 6469 6374 5f7a 6f6e 6527  ge_id_dict_zone'
-00004fe0: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-00004ff0: 2020 2020 2020 2020 2320 5941 4d4c 2068          # YAML h
-00005000: 6173 0a20 2020 2020 2020 2020 2020 2023  as.            #
-00005010: 2020 2069 6d61 6765 5f69 643a 0a20 2020     image_id:.   
-00005020: 2020 2020 2020 2020 2023 2020 2020 2020           #      
-00005030: 2075 732d 7765 7374 2d32 3a20 736b 7970   us-west-2: skyp
-00005040: 696c 6f74 3a67 7075 2d75 6275 6e74 752d  ilot:gpu-ubuntu-
-00005050: 3138 3034 0a20 2020 2020 2020 2020 2020  1804.           
-00005060: 2023 2020 2020 2020 2075 732d 6561 7374   #       us-east
-00005070: 2d32 3a20 736b 7970 696c 6f74 3a67 7075  -2: skypilot:gpu
-00005080: 2d75 6275 6e74 752d 3230 3034 0a20 2020  -ubuntu-2004.   
-00005090: 2020 2020 2020 2020 2023 2055 7365 207a           # Use z
-000050a0: 6f6e 6520 746f 2066 696c 7465 7220 696d  one to filter im
-000050b0: 6167 655f 6964 2064 6963 742e 0a20 2020  age_id dict..   
-000050c0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-000050d0: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-000050e0: 657d 202d 2d7a 6f6e 6520 7573 2d65 6173  e} --zone us-eas
-000050f0: 742d 3162 2065 7861 6d70 6c65 732f 7065  t-1b examples/pe
-00005100: 725f 7265 6769 6f6e 5f69 6d61 6765 732e  r_region_images.
-00005110: 7961 6d6c 2026 2620 6578 6974 2031 207c  yaml && exit 1 |
-00005120: 7c20 7472 7565 272c 0a20 2020 2020 2020  | true',.       
-00005130: 2020 2020 2066 2773 6b79 2073 7461 7475       f'sky statu
-00005140: 7320 7c20 6772 6570 207b 6e61 6d65 7d20  s | grep {name} 
-00005150: 2626 2065 7869 7420 3120 7c7c 2074 7275  && exit 1 || tru
-00005160: 6527 2c20 2023 2045 6e73 7572 6520 7468  e',  # Ensure th
-00005170: 6520 636c 7573 7465 7220 6973 206e 6f74  e cluster is not
-00005180: 2063 7265 6174 6564 2e0a 2020 2020 2020   created..      
-00005190: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-000051a0: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
-000051b0: 2d2d 7a6f 6e65 2075 732d 6561 7374 2d32  --zone us-east-2
-000051c0: 6120 6578 616d 706c 6573 2f70 6572 5f72  a examples/per_r
-000051d0: 6567 696f 6e5f 696d 6167 6573 2e79 616d  egion_images.yam
-000051e0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-000051f0: 2320 5368 6f75 6c64 2073 7563 6365 7373  # Should success
-00005200: 2062 6563 6175 7365 2074 6865 2069 6d61   because the ima
-00005210: 6765 2069 6420 6d61 7463 6820 666f 7220  ge id match for 
-00005220: 7468 6520 7a6f 6e65 2e0a 2020 2020 2020  the zone..      
-00005230: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-00005240: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
-00005250: 2d2d 696d 6167 652d 6964 2073 6b79 7069  --image-id skypi
-00005260: 6c6f 743a 6770 752d 7562 756e 7475 2d32  lot:gpu-ubuntu-2
-00005270: 3030 3420 6578 616d 706c 6573 2f6d 696e  004 examples/min
-00005280: 696d 616c 2e79 616d 6c27 2c0a 2020 2020  imal.yaml',.    
-00005290: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-000052a0: 6563 207b 6e61 6d65 7d20 2d2d 696d 6167  ec {name} --imag
-000052b0: 652d 6964 2073 6b79 7069 6c6f 743a 6770  e-id skypilot:gp
-000052c0: 752d 7562 756e 7475 2d32 3030 3420 6578  u-ubuntu-2004 ex
-000052d0: 616d 706c 6573 2f6d 696e 696d 616c 2e79  amples/minimal.y
-000052e0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-000052f0: 2020 2320 4661 696c 2064 7565 2074 6f20    # Fail due to 
-00005300: 696d 6167 6520 6964 206d 6973 6d61 7463  image id mismatc
-00005310: 682e 0a20 2020 2020 2020 2020 2020 2066  h..            f
-00005320: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-00005330: 202d 2d69 6d61 6765 2d69 6420 736b 7970   --image-id skyp
-00005340: 696c 6f74 3a67 7075 2d75 6275 6e74 752d  ilot:gpu-ubuntu-
-00005350: 3138 3034 2065 7861 6d70 6c65 732f 6d69  1804 examples/mi
-00005360: 6e69 6d61 6c2e 7961 6d6c 2026 2620 6578  nimal.yaml && ex
-00005370: 6974 2031 207c 7c20 7472 7565 272c 0a20  it 1 || true',. 
-00005380: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00005390: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
-000053a0: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
-000053b0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-000053c0: 207b 6e61 6d65 7d20 3220 2d2d 7374 6174   {name} 2 --stat
-000053d0: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
-000053e0: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-000053f0: 657d 2033 202d 2d73 7461 7475 7327 2c0a  e} 3 --status',.
-00005400: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00005410: 7920 7374 6174 7573 202d 2d61 6c6c 207c  y status --all |
-00005420: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
-00005430: 7265 7020 7573 2d65 6173 742d 3261 272c  rep us-east-2a',
-00005440: 2020 2320 456e 7375 7265 2074 6865 207a    # Ensure the z
-00005450: 6f6e 6520 6973 2063 6f72 7265 6374 2e0a  one is correct..
-00005460: 2020 2020 2020 2020 2020 2020 2320 456e              # En
-00005470: 7375 7265 2065 7865 6320 776f 726b 732e  sure exec works.
-00005480: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00005490: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
-000054a0: 2d7a 6f6e 6520 7573 2d65 6173 742d 3261  -zone us-east-2a
-000054b0: 2065 7861 6d70 6c65 732f 7065 725f 7265   examples/per_re
-000054c0: 6769 6f6e 5f69 6d61 6765 732e 7961 6d6c  gion_images.yaml
-000054d0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-000054e0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-000054f0: 2065 7861 6d70 6c65 732f 7065 725f 7265   examples/per_re
-00005500: 6769 6f6e 5f69 6d61 6765 732e 7961 6d6c  gion_images.yaml
-00005510: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00005520: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-00005530: 202d 2d63 6c6f 7564 2061 7773 202d 2d72   --cloud aws --r
-00005540: 6567 696f 6e20 7573 2d65 6173 742d 3220  egion us-east-2 
-00005550: 226c 7320 7e22 272c 0a20 2020 2020 2020  "ls ~"',.       
-00005560: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-00005570: 7b6e 616d 657d 2022 6c73 207e 2227 2c0a  {name} "ls ~"',.
-00005580: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00005590: 7920 6c6f 6773 207b 6e61 6d65 7d20 3420  y logs {name} 4 
-000055a0: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
-000055b0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-000055c0: 7320 7b6e 616d 657d 2035 202d 2d73 7461  s {name} 5 --sta
-000055d0: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
-000055e0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-000055f0: 6d65 7d20 3620 2d2d 7374 6174 7573 272c  me} 6 --status',
-00005600: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00005610: 6b79 206c 6f67 7320 7b6e 616d 657d 2037  ky logs {name} 7
-00005620: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
-00005630: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-00005640: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-00005650: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
-00005660: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-00005670: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-00005680: 6b2e 6763 700a 6465 6620 7465 7374 5f67  k.gcp.def test_g
-00005690: 6370 5f69 6d61 6765 5f69 645f 6469 6374  cp_image_id_dict
-000056a0: 5f7a 6f6e 6528 293a 0a20 2020 206e 616d  _zone():.    nam
-000056b0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-000056c0: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-000056d0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-000056e0: 2027 6763 705f 696d 6167 655f 6964 5f64   'gcp_image_id_d
-000056f0: 6963 745f 7a6f 6e65 272c 0a20 2020 2020  ict_zone',.     
-00005700: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-00005710: 2023 2055 7365 207a 6f6e 6520 746f 2066   # Use zone to f
-00005720: 696c 7465 7220 696d 6167 655f 6964 2064  ilter image_id d
-00005730: 6963 742e 0a20 2020 2020 2020 2020 2020  ict..           
-00005740: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
-00005750: 202d 6320 7b6e 616d 657d 202d 2d7a 6f6e   -c {name} --zon
-00005760: 6520 7573 2d65 6173 7431 2d61 2074 6573  e us-east1-a tes
-00005770: 7473 2f74 6573 745f 7961 6d6c 732f 6763  ts/test_yamls/gc
-00005780: 705f 7065 725f 7265 6769 6f6e 5f69 6d61  p_per_region_ima
-00005790: 6765 732e 7961 6d6c 2026 2620 6578 6974  ges.yaml && exit
-000057a0: 2031 207c 7c20 7472 7565 272c 0a20 2020   1 || true',.   
-000057b0: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-000057c0: 7461 7475 7320 7c20 6772 6570 207b 6e61  tatus | grep {na
-000057d0: 6d65 7d20 2626 2065 7869 7420 3120 7c7c  me} && exit 1 ||
-000057e0: 2074 7275 6527 2c20 2023 2045 6e73 7572   true',  # Ensur
-000057f0: 6520 7468 6520 636c 7573 7465 7220 6973  e the cluster is
-00005800: 206e 6f74 2063 7265 6174 6564 2e0a 2020   not created..  
-00005810: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00005820: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
-00005830: 6d65 7d20 2d2d 7a6f 6e65 2075 732d 6365  me} --zone us-ce
-00005840: 6e74 7261 6c31 2d61 2074 6573 7473 2f74  ntral1-a tests/t
-00005850: 6573 745f 7961 6d6c 732f 6763 705f 7065  est_yamls/gcp_pe
-00005860: 725f 7265 6769 6f6e 5f69 6d61 6765 732e  r_region_images.
-00005870: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-00005880: 2020 2023 2053 686f 756c 6420 7375 6363     # Should succ
-00005890: 6573 7320 6265 6361 7573 6520 7468 6520  ess because the 
-000058a0: 696d 6167 6520 6964 206d 6174 6368 2066  image id match f
-000058b0: 6f72 2074 6865 207a 6f6e 652e 0a20 2020  or the zone..   
-000058c0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-000058d0: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-000058e0: 657d 202d 2d63 6c6f 7564 2067 6370 202d  e} --cloud gcp -
-000058f0: 2d69 6d61 6765 2d69 6420 736b 7970 696c  -image-id skypil
-00005900: 6f74 3a63 7075 2d64 6562 6961 6e2d 3130  ot:cpu-debian-10
-00005910: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
-00005920: 732f 6d69 6e69 6d61 6c2e 7961 6d6c 272c  s/minimal.yaml',
-00005930: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00005940: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
-00005950: 2d63 6c6f 7564 2067 6370 202d 2d69 6d61  -cloud gcp --ima
-00005960: 6765 2d69 6420 736b 7970 696c 6f74 3a63  ge-id skypilot:c
-00005970: 7075 2d64 6562 6961 6e2d 3130 2074 6573  pu-debian-10 tes
-00005980: 7473 2f74 6573 745f 7961 6d6c 732f 6d69  ts/test_yamls/mi
-00005990: 6e69 6d61 6c2e 7961 6d6c 272c 0a20 2020  nimal.yaml',.   
-000059a0: 2020 2020 2020 2020 2023 2046 6169 6c20           # Fail 
-000059b0: 6475 6520 746f 2069 6d61 6765 2069 6420  due to image id 
-000059c0: 6d69 736d 6174 6368 2e0a 2020 2020 2020  mismatch..      
-000059d0: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
-000059e0: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
-000059f0: 6763 7020 2d2d 696d 6167 652d 6964 2073  gcp --image-id s
-00005a00: 6b79 7069 6c6f 743a 6770 752d 6465 6269  kypilot:gpu-debi
-00005a10: 616e 2d31 3020 7465 7374 732f 7465 7374  an-10 tests/test
-00005a20: 5f79 616d 6c73 2f6d 696e 696d 616c 2e79  _yamls/minimal.y
-00005a30: 616d 6c20 2626 2065 7869 7420 3120 7c7c  aml && exit 1 ||
-00005a40: 2074 7275 6527 2c0a 2020 2020 2020 2020   true',.        
-00005a50: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-00005a60: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
-00005a70: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00005a80: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00005a90: 2032 202d 2d73 7461 7475 7327 2c0a 2020   2 --status',.  
-00005aa0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00005ab0: 6c6f 6773 207b 6e61 6d65 7d20 3320 2d2d  logs {name} 3 --
-00005ac0: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
-00005ad0: 2020 2020 2066 2773 6b79 2073 7461 7475       f'sky statu
-00005ae0: 7320 2d2d 616c 6c20 7c20 6772 6570 207b  s --all | grep {
-00005af0: 6e61 6d65 7d20 7c20 6772 6570 2075 732d  name} | grep us-
-00005b00: 6365 6e74 7261 6c31 272c 2020 2320 456e  central1',  # En
-00005b10: 7375 7265 2074 6865 207a 6f6e 6520 6973  sure the zone is
-00005b20: 2063 6f72 7265 6374 2e0a 2020 2020 2020   correct..      
-00005b30: 2020 2020 2020 2320 456e 7375 7265 2065        # Ensure e
-00005b40: 7865 6320 776f 726b 732e 0a20 2020 2020  xec works..     
-00005b50: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-00005b60: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
-00005b70: 2067 6370 202d 2d7a 6f6e 6520 7573 2d63   gcp --zone us-c
-00005b80: 656e 7472 616c 312d 6120 7465 7374 732f  entral1-a tests/
-00005b90: 7465 7374 5f79 616d 6c73 2f67 6370 5f70  test_yamls/gcp_p
-00005ba0: 6572 5f72 6567 696f 6e5f 696d 6167 6573  er_region_images
-00005bb0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-00005bc0: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-00005bd0: 6e61 6d65 7d20 7465 7374 732f 7465 7374  name} tests/test
-00005be0: 5f79 616d 6c73 2f67 6370 5f70 6572 5f72  _yamls/gcp_per_r
-00005bf0: 6567 696f 6e5f 696d 6167 6573 2e79 616d  egion_images.yam
-00005c00: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-00005c10: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-00005c20: 7d20 2d2d 636c 6f75 6420 6763 7020 2d2d  } --cloud gcp --
-00005c30: 7265 6769 6f6e 2075 732d 6365 6e74 7261  region us-centra
-00005c40: 6c31 2022 6c73 207e 2227 2c0a 2020 2020  l1 "ls ~"',.    
-00005c50: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-00005c60: 6563 207b 6e61 6d65 7d20 226c 7320 7e22  ec {name} "ls ~"
-00005c70: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00005c80: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00005c90: 2034 202d 2d73 7461 7475 7327 2c0a 2020   4 --status',.  
-00005ca0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00005cb0: 6c6f 6773 207b 6e61 6d65 7d20 3520 2d2d  logs {name} 5 --
-00005cc0: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
-00005cd0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-00005ce0: 7b6e 616d 657d 2036 202d 2d73 7461 7475  {name} 6 --statu
-00005cf0: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
-00005d00: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-00005d10: 7d20 3720 2d2d 7374 6174 7573 272c 0a20  } 7 --status',. 
-00005d20: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00005d30: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-00005d40: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
-00005d50: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00005d60: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-00005d70: 6d61 726b 2e61 7773 0a64 6566 2074 6573  mark.aws.def tes
-00005d80: 745f 636c 6f6e 655f 6469 736b 5f61 7773  t_clone_disk_aws
-00005d90: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
-00005da0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-00005db0: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
-00005dc0: 7374 280a 2020 2020 2020 2020 2763 6c6f  st(.        'clo
-00005dd0: 6e65 5f64 6973 6b5f 6177 7327 2c0a 2020  ne_disk_aws',.  
-00005de0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-00005df0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-00005e00: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
-00005e10: 636c 6f75 6420 6177 7320 2d2d 7265 6769  cloud aws --regi
-00005e20: 6f6e 2075 732d 6561 7374 2d32 202d 2d72  on us-east-2 --r
-00005e30: 6574 7279 2d75 6e74 696c 2d75 7020 2265  etry-until-up "e
-00005e40: 6368 6f20 6865 6c6c 6f20 3e20 7e2f 7573  cho hello > ~/us
-00005e50: 6572 5f66 696c 652e 7478 7422 272c 0a20  er_file.txt"',. 
-00005e60: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00005e70: 206c 6175 6e63 6820 2d2d 636c 6f6e 652d   launch --clone-
-00005e80: 6469 736b 2d66 726f 6d20 7b6e 616d 657d  disk-from {name}
-00005e90: 202d 7920 2d63 207b 6e61 6d65 7d2d 636c   -y -c {name}-cl
-00005ea0: 6f6e 6520 2626 2065 7869 7420 3120 7c7c  one && exit 1 ||
-00005eb0: 2074 7275 6527 2c0a 2020 2020 2020 2020   true',.        
-00005ec0: 2020 2020 6627 736b 7920 7374 6f70 207b      f'sky stop {
-00005ed0: 6e61 6d65 7d20 2d79 272c 0a20 2020 2020  name} -y',.     
-00005ee0: 2020 2020 2020 2027 736c 6565 7020 3630         'sleep 60
-00005ef0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00005f00: 2773 6b79 206c 6175 6e63 6820 2d2d 636c  'sky launch --cl
-00005f10: 6f6e 652d 6469 736b 2d66 726f 6d20 7b6e  one-disk-from {n
-00005f20: 616d 657d 202d 7920 2d63 207b 6e61 6d65  ame} -y -c {name
-00005f30: 7d2d 636c 6f6e 6520 2d2d 636c 6f75 6420  }-clone --cloud 
-00005f40: 6177 7320 2d64 202d 2d72 6567 696f 6e20  aws -d --region 
-00005f50: 7573 2d65 6173 742d 3220 2263 6174 207e  us-east-2 "cat ~
-00005f60: 2f75 7365 725f 6669 6c65 2e74 7874 207c  /user_file.txt |
-00005f70: 2067 7265 7020 6865 6c6c 6f22 272c 0a20   grep hello"',. 
+000047c0: 7374 6174 7573 202d 2d61 6c6c 207c 2067  status --all | g
+000047d0: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
+000047e0: 7020 7573 2d63 656e 7472 616c 312d 6127  p us-central1-a'
+000047f0: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
+00004800: 7a6f 6e65 2069 7320 636f 7272 6563 742e  zone is correct.
+00004810: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+00004820: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
+00004830: 7920 7b6e 616d 657d 272c 0a20 2020 2029  y {name}',.    )
+00004840: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00004850: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
+00004860: 2d2d 2d2d 2d2d 2054 6573 7420 7468 6520  ------ Test the 
+00004870: 696d 6167 6520 2d2d 2d2d 2d2d 2d2d 2d2d  image ----------
+00004880: 0a40 7079 7465 7374 2e6d 6172 6b2e 6177  .@pytest.mark.aw
+00004890: 730a 6465 6620 7465 7374 5f61 7773 5f69  s.def test_aws_i
+000048a0: 6d61 6765 7328 293a 0a20 2020 206e 616d  mages():.    nam
+000048b0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+000048c0: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+000048d0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+000048e0: 2027 6177 735f 696d 6167 6573 272c 0a20   'aws_images',. 
+000048f0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+00004900: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+00004910: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
+00004920: 2d69 6d61 6765 2d69 6420 736b 7970 696c  -image-id skypil
+00004930: 6f74 3a67 7075 2d75 6275 6e74 752d 3138  ot:gpu-ubuntu-18
+00004940: 3034 2065 7861 6d70 6c65 732f 6d69 6e69  04 examples/mini
+00004950: 6d61 6c2e 7961 6d6c 272c 0a20 2020 2020  mal.yaml',.     
+00004960: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00004970: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
+00004980: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
+00004990: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
+000049a0: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
+000049b0: 2773 6b79 206c 6175 6e63 6820 2d63 207b  'sky launch -c {
+000049c0: 6e61 6d65 7d20 2d2d 696d 6167 652d 6964  name} --image-id
+000049d0: 2073 6b79 7069 6c6f 743a 6770 752d 7562   skypilot:gpu-ub
+000049e0: 756e 7475 2d32 3030 3420 6578 616d 706c  untu-2004 exampl
+000049f0: 6573 2f6d 696e 696d 616c 2e79 616d 6c20  es/minimal.yaml 
+00004a00: 2626 2065 7869 7420 3120 7c7c 2074 7275  && exit 1 || tru
+00004a10: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
+00004a20: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
+00004a30: 2d63 207b 6e61 6d65 7d20 6578 616d 706c  -c {name} exampl
+00004a40: 6573 2f6d 696e 696d 616c 2e79 616d 6c27  es/minimal.yaml'
+00004a50: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00004a60: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+00004a70: 3220 2d2d 7374 6174 7573 272c 0a20 2020  2 --status',.   
+00004a80: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00004a90: 6f67 7320 7b6e 616d 657d 202d 2d73 7461  ogs {name} --sta
+00004aa0: 7475 7320 7c20 6772 6570 2022 4a6f 6220  tus | grep "Job 
+00004ab0: 323a 2053 5543 4345 4544 4544 2227 2c20  2: SUCCEEDED"', 
+00004ac0: 2023 2045 7175 6976 616c 656e 742e 0a20   # Equivalent.. 
+00004ad0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00004ae0: 2065 7865 6320 7b6e 616d 657d 205c 2765   exec {name} \'e
+00004af0: 6368 6f20 2453 4b59 5049 4c4f 545f 434c  cho $SKYPILOT_CL
+00004b00: 5553 5445 525f 494e 464f 207c 206a 7120  USTER_INFO | jq 
+00004b10: 2e63 6c6f 7564 207c 2067 7265 7020 2d69  .cloud | grep -i
+00004b20: 2061 7773 5c27 272c 0a20 2020 2020 2020   aws\'',.       
+00004b30: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00004b40: 7b6e 616d 657d 2033 202d 2d73 7461 7475  {name} 3 --statu
+00004b50: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
+00004b60: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
+00004b70: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+00004b80: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
+00004b90: 7920 7b6e 616d 657d 272c 0a20 2020 2029  y {name}',.    )
+00004ba0: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00004bb0: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
+00004bc0: 742e 6d61 726b 2e67 6370 0a64 6566 2074  t.mark.gcp.def t
+00004bd0: 6573 745f 6763 705f 696d 6167 6573 2829  est_gcp_images()
+00004be0: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+00004bf0: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+00004c00: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+00004c10: 280a 2020 2020 2020 2020 2767 6370 5f69  (.        'gcp_i
+00004c20: 6d61 6765 7327 2c0a 2020 2020 2020 2020  mages',.        
+00004c30: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+00004c40: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+00004c50: 207b 6e61 6d65 7d20 2d2d 696d 6167 652d   {name} --image-
+00004c60: 6964 2073 6b79 7069 6c6f 743a 6770 752d  id skypilot:gpu-
+00004c70: 6465 6269 616e 2d31 3020 2d2d 636c 6f75  debian-10 --clou
+00004c80: 6420 6763 7020 7465 7374 732f 7465 7374  d gcp tests/test
+00004c90: 5f79 616d 6c73 2f6d 696e 696d 616c 2e79  _yamls/minimal.y
+00004ca0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+00004cb0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+00004cc0: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
+00004cd0: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
+00004ce0: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
+00004cf0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00004d00: 6c61 756e 6368 202d 6320 7b6e 616d 657d  launch -c {name}
+00004d10: 202d 2d69 6d61 6765 2d69 6420 736b 7970   --image-id skyp
+00004d20: 696c 6f74 3a63 7075 2d64 6562 6961 6e2d  ilot:cpu-debian-
+00004d30: 3130 202d 2d63 6c6f 7564 2067 6370 2074  10 --cloud gcp t
+00004d40: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
+00004d50: 6d69 6e69 6d61 6c2e 7961 6d6c 2026 2620  minimal.yaml && 
+00004d60: 6578 6974 2031 207c 7c20 7472 7565 272c  exit 1 || true',
+00004d70: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00004d80: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+00004d90: 7b6e 616d 657d 2074 6573 7473 2f74 6573  {name} tests/tes
+00004da0: 745f 7961 6d6c 732f 6d69 6e69 6d61 6c2e  t_yamls/minimal.
+00004db0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00004dc0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+00004dd0: 616d 657d 2032 202d 2d73 7461 7475 7327  ame} 2 --status'
+00004de0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00004df0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+00004e00: 2d2d 7374 6174 7573 207c 2067 7265 7020  --status | grep 
+00004e10: 224a 6f62 2032 3a20 5355 4343 4545 4445  "Job 2: SUCCEEDE
+00004e20: 4422 272c 2020 2320 4571 7569 7661 6c65  D"',  # Equivale
+00004e30: 6e74 2e0a 2020 2020 2020 2020 2020 2020  nt..            
+00004e40: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+00004e50: 7d20 5c27 6563 686f 2024 534b 5950 494c  } \'echo $SKYPIL
+00004e60: 4f54 5f43 4c55 5354 4552 5f49 4e46 4f20  OT_CLUSTER_INFO 
+00004e70: 7c20 6a71 202e 636c 6f75 6420 7c20 6772  | jq .cloud | gr
+00004e80: 6570 202d 6920 6763 705c 2727 2c0a 2020  ep -i gcp\'',.  
+00004e90: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00004ea0: 6c6f 6773 207b 6e61 6d65 7d20 3320 2d2d  logs {name} 3 --
+00004eb0: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
+00004ec0: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
+00004ed0: 6564 6564 2e0a 2020 2020 2020 2020 5d2c  eded..        ],
+00004ee0: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
+00004ef0: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
+00004f00: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+00004f10: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
+00004f20: 7079 7465 7374 2e6d 6172 6b2e 617a 7572  pytest.mark.azur
+00004f30: 650a 6465 6620 7465 7374 5f61 7a75 7265  e.def test_azure
+00004f40: 5f69 6d61 6765 7328 293a 0a20 2020 206e  _images():.    n
+00004f50: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+00004f60: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
+00004f70: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00004f80: 2020 2027 617a 7572 655f 696d 6167 6573     'azure_images
+00004f90: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+00004fa0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00004fb0: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
+00004fc0: 657d 202d 2d69 6d61 6765 2d69 6420 736b  e} --image-id sk
+00004fd0: 7970 696c 6f74 3a67 7075 2d75 6275 6e74  ypilot:gpu-ubunt
+00004fe0: 752d 3232 3034 202d 2d63 6c6f 7564 2061  u-2204 --cloud a
+00004ff0: 7a75 7265 2074 6573 7473 2f74 6573 745f  zure tests/test_
+00005000: 7961 6d6c 732f 6d69 6e69 6d61 6c2e 7961  yamls/minimal.ya
+00005010: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+00005020: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+00005030: 657d 2031 202d 2d73 7461 7475 7327 2c20  e} 1 --status', 
+00005040: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
+00005050: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
+00005060: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00005070: 6175 6e63 6820 2d63 207b 6e61 6d65 7d20  aunch -c {name} 
+00005080: 2d2d 696d 6167 652d 6964 2073 6b79 7069  --image-id skypi
+00005090: 6c6f 743a 7631 2d75 6275 6e74 752d 3230  lot:v1-ubuntu-20
+000050a0: 3034 202d 2d63 6c6f 7564 2061 7a75 7265  04 --cloud azure
+000050b0: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
+000050c0: 732f 6d69 6e69 6d61 6c2e 7961 6d6c 2026  s/minimal.yaml &
+000050d0: 2620 6578 6974 2031 207c 7c20 7472 7565  & exit 1 || true
+000050e0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000050f0: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+00005100: 6320 7b6e 616d 657d 2074 6573 7473 2f74  c {name} tests/t
+00005110: 6573 745f 7961 6d6c 732f 6d69 6e69 6d61  est_yamls/minima
+00005120: 6c2e 7961 6d6c 272c 0a20 2020 2020 2020  l.yaml',.       
+00005130: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00005140: 7b6e 616d 657d 2032 202d 2d73 7461 7475  {name} 2 --statu
+00005150: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
+00005160: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00005170: 7d20 2d2d 7374 6174 7573 207c 2067 7265  } --status | gre
+00005180: 7020 224a 6f62 2032 3a20 5355 4343 4545  p "Job 2: SUCCEE
+00005190: 4445 4422 272c 2020 2320 4571 7569 7661  DED"',  # Equiva
+000051a0: 6c65 6e74 2e0a 2020 2020 2020 2020 2020  lent..          
+000051b0: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+000051c0: 6d65 7d20 5c27 6563 686f 2024 534b 5950  me} \'echo $SKYP
+000051d0: 494c 4f54 5f43 4c55 5354 4552 5f49 4e46  ILOT_CLUSTER_INF
+000051e0: 4f20 7c20 6a71 202e 636c 6f75 6420 7c20  O | jq .cloud | 
+000051f0: 6772 6570 202d 6920 617a 7572 655c 2727  grep -i azure\''
+00005200: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00005210: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+00005220: 3320 2d2d 7374 6174 7573 272c 2020 2320  3 --status',  # 
+00005230: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
+00005240: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
+00005250: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
+00005260: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+00005270: 7d27 2c0a 2020 2020 290a 2020 2020 7275  }',.    ).    ru
+00005280: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+00005290: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+000052a0: 6177 730a 6465 6620 7465 7374 5f61 7773  aws.def test_aws
+000052b0: 5f69 6d61 6765 5f69 645f 6469 6374 2829  _image_id_dict()
+000052c0: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+000052d0: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+000052e0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+000052f0: 280a 2020 2020 2020 2020 2761 7773 5f69  (.        'aws_i
+00005300: 6d61 6765 5f69 645f 6469 6374 272c 0a20  mage_id_dict',. 
+00005310: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+00005320: 2020 2020 2023 2055 7365 2069 6d61 6765       # Use image
+00005330: 2069 6420 6469 6374 2e0a 2020 2020 2020   id dict..      
+00005340: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+00005350: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
+00005360: 6578 616d 706c 6573 2f70 6572 5f72 6567  examples/per_reg
+00005370: 696f 6e5f 696d 6167 6573 2e79 616d 6c27  ion_images.yaml'
+00005380: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00005390: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+000053a0: 6578 616d 706c 6573 2f70 6572 5f72 6567  examples/per_reg
+000053b0: 696f 6e5f 696d 6167 6573 2e79 616d 6c27  ion_images.yaml'
+000053c0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+000053d0: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+000053e0: 226c 7320 7e22 272c 0a20 2020 2020 2020  "ls ~"',.       
+000053f0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00005400: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
+00005410: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
+00005420: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00005430: 7d20 3220 2d2d 7374 6174 7573 272c 0a20  } 2 --status',. 
+00005440: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00005450: 206c 6f67 7320 7b6e 616d 657d 2033 202d   logs {name} 3 -
+00005460: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
+00005470: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
+00005480: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+00005490: 7d27 2c0a 2020 2020 290a 2020 2020 7275  }',.    ).    ru
+000054a0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+000054b0: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+000054c0: 6763 700a 6465 6620 7465 7374 5f67 6370  gcp.def test_gcp
+000054d0: 5f69 6d61 6765 5f69 645f 6469 6374 2829  _image_id_dict()
+000054e0: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+000054f0: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+00005500: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+00005510: 280a 2020 2020 2020 2020 2767 6370 5f69  (.        'gcp_i
+00005520: 6d61 6765 5f69 645f 6469 6374 272c 0a20  mage_id_dict',. 
+00005530: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+00005540: 2020 2020 2023 2055 7365 2069 6d61 6765       # Use image
+00005550: 2069 6420 6469 6374 2e0a 2020 2020 2020   id dict..      
+00005560: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+00005570: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
+00005580: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
+00005590: 2f67 6370 5f70 6572 5f72 6567 696f 6e5f  /gcp_per_region_
+000055a0: 696d 6167 6573 2e79 616d 6c27 2c0a 2020  images.yaml',.  
+000055b0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000055c0: 6578 6563 207b 6e61 6d65 7d20 7465 7374  exec {name} test
+000055d0: 732f 7465 7374 5f79 616d 6c73 2f67 6370  s/test_yamls/gcp
+000055e0: 5f70 6572 5f72 6567 696f 6e5f 696d 6167  _per_region_imag
+000055f0: 6573 2e79 616d 6c27 2c0a 2020 2020 2020  es.yaml',.      
+00005600: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+00005610: 207b 6e61 6d65 7d20 226c 7320 7e22 272c   {name} "ls ~"',
+00005620: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00005630: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
+00005640: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+00005650: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+00005660: 6773 207b 6e61 6d65 7d20 3220 2d2d 7374  gs {name} 2 --st
+00005670: 6174 7573 272c 0a20 2020 2020 2020 2020  atus',.         
+00005680: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+00005690: 616d 657d 2033 202d 2d73 7461 7475 7327  ame} 3 --status'
+000056a0: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+000056b0: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
+000056c0: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+000056d0: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+000056e0: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
+000056f0: 7374 2e6d 6172 6b2e 6177 730a 6465 6620  st.mark.aws.def 
+00005700: 7465 7374 5f61 7773 5f69 6d61 6765 5f69  test_aws_image_i
+00005710: 645f 6469 6374 5f72 6567 696f 6e28 293a  d_dict_region():
+00005720: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+00005730: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+00005740: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+00005750: 0a20 2020 2020 2020 2027 6177 735f 696d  .        'aws_im
+00005760: 6167 655f 6964 5f64 6963 745f 7265 6769  age_id_dict_regi
+00005770: 6f6e 272c 0a20 2020 2020 2020 205b 0a20  on',.        [. 
+00005780: 2020 2020 2020 2020 2020 2023 2059 414d             # YAM
+00005790: 4c20 6861 730a 2020 2020 2020 2020 2020  L has.          
+000057a0: 2020 2320 2020 696d 6167 655f 6964 3a0a    #   image_id:.
+000057b0: 2020 2020 2020 2020 2020 2020 2320 2020              #   
+000057c0: 2020 2020 7573 2d77 6573 742d 323a 2073      us-west-2: s
+000057d0: 6b79 7069 6c6f 743a 6770 752d 7562 756e  kypilot:gpu-ubun
+000057e0: 7475 2d31 3830 340a 2020 2020 2020 2020  tu-1804.        
+000057f0: 2020 2020 2320 2020 2020 2020 7573 2d65      #       us-e
+00005800: 6173 742d 323a 2073 6b79 7069 6c6f 743a  ast-2: skypilot:
+00005810: 6770 752d 7562 756e 7475 2d32 3030 340a  gpu-ubuntu-2004.
+00005820: 2020 2020 2020 2020 2020 2020 2320 5573              # Us
+00005830: 6520 7265 6769 6f6e 2074 6f20 6669 6c74  e region to filt
+00005840: 6572 2069 6d61 6765 5f69 6420 6469 6374  er image_id dict
+00005850: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00005860: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+00005870: 207b 6e61 6d65 7d20 2d2d 7265 6769 6f6e   {name} --region
+00005880: 2075 732d 6561 7374 2d31 2065 7861 6d70   us-east-1 examp
+00005890: 6c65 732f 7065 725f 7265 6769 6f6e 5f69  les/per_region_i
+000058a0: 6d61 6765 732e 7961 6d6c 2026 2620 6578  mages.yaml && ex
+000058b0: 6974 2031 207c 7c20 7472 7565 272c 0a20  it 1 || true',. 
+000058c0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000058d0: 2073 7461 7475 7320 7c20 6772 6570 207b   status | grep {
+000058e0: 6e61 6d65 7d20 2626 2065 7869 7420 3120  name} && exit 1 
+000058f0: 7c7c 2074 7275 6527 2c20 2023 2045 6e73  || true',  # Ens
+00005900: 7572 6520 7468 6520 636c 7573 7465 7220  ure the cluster 
+00005910: 6973 206e 6f74 2063 7265 6174 6564 2e0a  is not created..
+00005920: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00005930: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+00005940: 6e61 6d65 7d20 2d2d 7265 6769 6f6e 2075  name} --region u
+00005950: 732d 6561 7374 2d32 2065 7861 6d70 6c65  s-east-2 example
+00005960: 732f 7065 725f 7265 6769 6f6e 5f69 6d61  s/per_region_ima
+00005970: 6765 732e 7961 6d6c 272c 0a20 2020 2020  ges.yaml',.     
+00005980: 2020 2020 2020 2023 2053 686f 756c 6420         # Should 
+00005990: 7375 6363 6573 7320 6265 6361 7573 6520  success because 
+000059a0: 7468 6520 696d 6167 6520 6964 206d 6174  the image id mat
+000059b0: 6368 2066 6f72 2074 6865 2072 6567 696f  ch for the regio
+000059c0: 6e2e 0a20 2020 2020 2020 2020 2020 2066  n..            f
+000059d0: 2773 6b79 206c 6175 6e63 6820 2d63 207b  'sky launch -c {
+000059e0: 6e61 6d65 7d20 2d2d 696d 6167 652d 6964  name} --image-id
+000059f0: 2073 6b79 7069 6c6f 743a 6770 752d 7562   skypilot:gpu-ub
+00005a00: 756e 7475 2d32 3030 3420 6578 616d 706c  untu-2004 exampl
+00005a10: 6573 2f6d 696e 696d 616c 2e79 616d 6c27  es/minimal.yaml'
+00005a20: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00005a30: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+00005a40: 2d2d 696d 6167 652d 6964 2073 6b79 7069  --image-id skypi
+00005a50: 6c6f 743a 6770 752d 7562 756e 7475 2d32  lot:gpu-ubuntu-2
+00005a60: 3030 3420 6578 616d 706c 6573 2f6d 696e  004 examples/min
+00005a70: 696d 616c 2e79 616d 6c27 2c0a 2020 2020  imal.yaml',.    
+00005a80: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+00005a90: 6563 207b 6e61 6d65 7d20 2d2d 696d 6167  ec {name} --imag
+00005aa0: 652d 6964 2073 6b79 7069 6c6f 743a 6770  e-id skypilot:gp
+00005ab0: 752d 7562 756e 7475 2d31 3830 3420 6578  u-ubuntu-1804 ex
+00005ac0: 616d 706c 6573 2f6d 696e 696d 616c 2e79  amples/minimal.y
+00005ad0: 616d 6c20 2626 2065 7869 7420 3120 7c7c  aml && exit 1 ||
+00005ae0: 2074 7275 6527 2c0a 2020 2020 2020 2020   true',.        
+00005af0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+00005b00: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
+00005b10: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00005b20: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+00005b30: 2032 202d 2d73 7461 7475 7327 2c0a 2020   2 --status',.  
+00005b40: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00005b50: 6c6f 6773 207b 6e61 6d65 7d20 3320 2d2d  logs {name} 3 --
+00005b60: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
+00005b70: 2020 2020 2066 2773 6b79 2073 7461 7475       f'sky statu
+00005b80: 7320 2d2d 616c 6c20 7c20 6772 6570 207b  s --all | grep {
+00005b90: 6e61 6d65 7d20 7c20 6772 6570 2075 732d  name} | grep us-
+00005ba0: 6561 7374 2d32 272c 2020 2320 456e 7375  east-2',  # Ensu
+00005bb0: 7265 2074 6865 2072 6567 696f 6e20 6973  re the region is
+00005bc0: 2063 6f72 7265 6374 2e0a 2020 2020 2020   correct..      
+00005bd0: 2020 2020 2020 2320 456e 7375 7265 2065        # Ensure e
+00005be0: 7865 6320 776f 726b 732e 0a20 2020 2020  xec works..     
+00005bf0: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+00005c00: 6320 7b6e 616d 657d 202d 2d72 6567 696f  c {name} --regio
+00005c10: 6e20 7573 2d65 6173 742d 3220 6578 616d  n us-east-2 exam
+00005c20: 706c 6573 2f70 6572 5f72 6567 696f 6e5f  ples/per_region_
+00005c30: 696d 6167 6573 2e79 616d 6c27 2c0a 2020  images.yaml',.  
+00005c40: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00005c50: 6578 6563 207b 6e61 6d65 7d20 6578 616d  exec {name} exam
+00005c60: 706c 6573 2f70 6572 5f72 6567 696f 6e5f  ples/per_region_
+00005c70: 696d 6167 6573 2e79 616d 6c27 2c0a 2020  images.yaml',.  
+00005c80: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00005c90: 6578 6563 207b 6e61 6d65 7d20 2d2d 636c  exec {name} --cl
+00005ca0: 6f75 6420 6177 7320 2d2d 7265 6769 6f6e  oud aws --region
+00005cb0: 2075 732d 6561 7374 2d32 2022 6c73 207e   us-east-2 "ls ~
+00005cc0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+00005cd0: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+00005ce0: 7d20 226c 7320 7e22 272c 0a20 2020 2020  } "ls ~"',.     
+00005cf0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00005d00: 7320 7b6e 616d 657d 2034 202d 2d73 7461  s {name} 4 --sta
+00005d10: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
+00005d20: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+00005d30: 6d65 7d20 3520 2d2d 7374 6174 7573 272c  me} 5 --status',
+00005d40: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00005d50: 6b79 206c 6f67 7320 7b6e 616d 657d 2036  ky logs {name} 6
+00005d60: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+00005d70: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+00005d80: 6773 207b 6e61 6d65 7d20 3720 2d2d 7374  gs {name} 7 --st
+00005d90: 6174 7573 272c 0a20 2020 2020 2020 205d  atus',.        ]
+00005da0: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+00005db0: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+00005dc0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00005dd0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00005de0: 4070 7974 6573 742e 6d61 726b 2e67 6370  @pytest.mark.gcp
+00005df0: 0a64 6566 2074 6573 745f 6763 705f 696d  .def test_gcp_im
+00005e00: 6167 655f 6964 5f64 6963 745f 7265 6769  age_id_dict_regi
+00005e10: 6f6e 2829 3a0a 2020 2020 6e61 6d65 203d  on():.    name =
+00005e20: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+00005e30: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
+00005e40: 5465 7374 280a 2020 2020 2020 2020 2767  Test(.        'g
+00005e50: 6370 5f69 6d61 6765 5f69 645f 6469 6374  cp_image_id_dict
+00005e60: 5f72 6567 696f 6e27 2c0a 2020 2020 2020  _region',.      
+00005e70: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+00005e80: 2320 5573 6520 7265 6769 6f6e 2074 6f20  # Use region to 
+00005e90: 6669 6c74 6572 2069 6d61 6765 5f69 6420  filter image_id 
+00005ea0: 6469 6374 2e0a 2020 2020 2020 2020 2020  dict..          
+00005eb0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+00005ec0: 7920 2d63 207b 6e61 6d65 7d20 2d2d 7265  y -c {name} --re
+00005ed0: 6769 6f6e 2075 732d 6561 7374 3120 7465  gion us-east1 te
+00005ee0: 7374 732f 7465 7374 5f79 616d 6c73 2f67  sts/test_yamls/g
+00005ef0: 6370 5f70 6572 5f72 6567 696f 6e5f 696d  cp_per_region_im
+00005f00: 6167 6573 2e79 616d 6c20 2626 2065 7869  ages.yaml && exi
+00005f10: 7420 3120 7c7c 2074 7275 6527 2c0a 2020  t 1 || true',.  
+00005f20: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00005f30: 7374 6174 7573 207c 2067 7265 7020 7b6e  status | grep {n
+00005f40: 616d 657d 2026 2620 6578 6974 2031 207c  ame} && exit 1 |
+00005f50: 7c20 7472 7565 272c 2020 2320 456e 7375  | true',  # Ensu
+00005f60: 7265 2074 6865 2063 6c75 7374 6572 2069  re the cluster i
+00005f70: 7320 6e6f 7420 6372 6561 7465 642e 0a20  s not created.. 
 00005f80: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00005f90: 206c 6175 6e63 6820 2d2d 636c 6f6e 652d   launch --clone-
-00005fa0: 6469 736b 2d66 726f 6d20 7b6e 616d 657d  disk-from {name}
-00005fb0: 202d 7920 2d63 207b 6e61 6d65 7d2d 636c   -y -c {name}-cl
-00005fc0: 6f6e 652d 3220 2d2d 636c 6f75 6420 6177  one-2 --cloud aw
-00005fd0: 7320 2d64 202d 2d72 6567 696f 6e20 7573  s -d --region us
-00005fe0: 2d65 6173 742d 3220 2263 6174 207e 2f75  -east-2 "cat ~/u
-00005ff0: 7365 725f 6669 6c65 2e74 7874 207c 2067  ser_file.txt | g
-00006000: 7265 7020 6865 6c6c 6f22 272c 0a20 2020  rep hello"',.   
-00006010: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00006020: 6f67 7320 7b6e 616d 657d 2d63 6c6f 6e65  ogs {name}-clone
-00006030: 2031 202d 2d73 7461 7475 7327 2c0a 2020   1 --status',.  
-00006040: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00006050: 6c6f 6773 207b 6e61 6d65 7d2d 636c 6f6e  logs {name}-clon
-00006060: 652d 3220 3120 2d2d 7374 6174 7573 272c  e-2 1 --status',
-00006070: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-00006080: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
-00006090: 7920 7b6e 616d 657d 207b 6e61 6d65 7d2d  y {name} {name}-
-000060a0: 636c 6f6e 6520 7b6e 616d 657d 2d63 6c6f  clone {name}-clo
-000060b0: 6e65 2d32 272c 0a20 2020 2020 2020 2074  ne-2',.        t
-000060c0: 696d 656f 7574 3d33 3020 2a20 3630 2c0a  imeout=30 * 60,.
-000060d0: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-000060e0: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-000060f0: 7079 7465 7374 2e6d 6172 6b2e 6763 700a  pytest.mark.gcp.
-00006100: 6465 6620 7465 7374 5f63 6c6f 6e65 5f64  def test_clone_d
-00006110: 6973 6b5f 6763 7028 293a 0a20 2020 206e  isk_gcp():.    n
-00006120: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-00006130: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
-00006140: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-00006150: 2020 2027 636c 6f6e 655f 6469 736b 5f67     'clone_disk_g
-00006160: 6370 272c 0a20 2020 2020 2020 205b 0a20  cp',.        [. 
-00006170: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00006180: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
-00006190: 616d 657d 202d 2d63 6c6f 7564 2067 6370  ame} --cloud gcp
-000061a0: 202d 2d7a 6f6e 6520 7573 2d65 6173 7431   --zone us-east1
-000061b0: 2d62 202d 2d72 6574 7279 2d75 6e74 696c  -b --retry-until
-000061c0: 2d75 7020 2265 6368 6f20 6865 6c6c 6f20  -up "echo hello 
-000061d0: 3e20 7e2f 7573 6572 5f66 696c 652e 7478  > ~/user_file.tx
-000061e0: 7422 272c 0a20 2020 2020 2020 2020 2020  t"',.           
-000061f0: 2066 2773 6b79 206c 6175 6e63 6820 2d2d   f'sky launch --
-00006200: 636c 6f6e 652d 6469 736b 2d66 726f 6d20  clone-disk-from 
-00006210: 7b6e 616d 657d 202d 7920 2d63 207b 6e61  {name} -y -c {na
-00006220: 6d65 7d2d 636c 6f6e 6520 2626 2065 7869  me}-clone && exi
-00006230: 7420 3120 7c7c 2074 7275 6527 2c0a 2020  t 1 || true',.  
-00006240: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00006250: 7374 6f70 207b 6e61 6d65 7d20 2d79 272c  stop {name} -y',
-00006260: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00006270: 6b79 206c 6175 6e63 6820 2d2d 636c 6f6e  ky launch --clon
-00006280: 652d 6469 736b 2d66 726f 6d20 7b6e 616d  e-disk-from {nam
-00006290: 657d 202d 7920 2d63 207b 6e61 6d65 7d2d  e} -y -c {name}-
-000062a0: 636c 6f6e 6520 2d2d 636c 6f75 6420 6763  clone --cloud gc
-000062b0: 7020 2d2d 7a6f 6e65 2075 732d 6365 6e74  p --zone us-cent
-000062c0: 7261 6c31 2d61 2022 6361 7420 7e2f 7573  ral1-a "cat ~/us
-000062d0: 6572 5f66 696c 652e 7478 7420 7c20 6772  er_file.txt | gr
-000062e0: 6570 2068 656c 6c6f 2227 2c0a 2020 2020  ep hello"',.    
-000062f0: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-00006300: 756e 6368 202d 2d63 6c6f 6e65 2d64 6973  unch --clone-dis
-00006310: 6b2d 6672 6f6d 207b 6e61 6d65 7d20 2d79  k-from {name} -y
-00006320: 202d 6320 7b6e 616d 657d 2d63 6c6f 6e65   -c {name}-clone
-00006330: 2d32 202d 2d63 6c6f 7564 2067 6370 202d  -2 --cloud gcp -
-00006340: 2d7a 6f6e 6520 7573 2d65 6173 7431 2d62  -zone us-east1-b
-00006350: 2022 6361 7420 7e2f 7573 6572 5f66 696c   "cat ~/user_fil
-00006360: 652e 7478 7420 7c20 6772 6570 2068 656c  e.txt | grep hel
-00006370: 6c6f 2227 2c0a 2020 2020 2020 2020 2020  lo"',.          
-00006380: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-00006390: 6d65 7d2d 636c 6f6e 6520 3120 2d2d 7374  me}-clone 1 --st
-000063a0: 6174 7573 272c 0a20 2020 2020 2020 2020  atus',.         
-000063b0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-000063c0: 616d 657d 2d63 6c6f 6e65 2d32 2031 202d  ame}-clone-2 1 -
-000063d0: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
-000063e0: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
-000063f0: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-00006400: 7d20 7b6e 616d 657d 2d63 6c6f 6e65 207b  } {name}-clone {
-00006410: 6e61 6d65 7d2d 636c 6f6e 652d 3227 2c0a  name}-clone-2',.
-00006420: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-00006430: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-00006440: 7079 7465 7374 2e6d 6172 6b2e 6177 730a  pytest.mark.aws.
-00006450: 6465 6620 7465 7374 5f69 6d61 6765 5f6e  def test_image_n
-00006460: 6f5f 636f 6e64 6128 293a 0a20 2020 206e  o_conda():.    n
-00006470: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-00006480: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
-00006490: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-000064a0: 2020 2027 696d 6167 655f 6e6f 5f63 6f6e     'image_no_con
-000064b0: 6461 272c 0a20 2020 2020 2020 205b 0a20  da',.        [. 
-000064c0: 2020 2020 2020 2020 2020 2023 2055 7365             # Use
-000064d0: 2069 6d61 6765 2069 6420 6469 6374 2e0a   image id dict..
-000064e0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000064f0: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-00006500: 6e61 6d65 7d20 2d2d 7265 6769 6f6e 2075  name} --region u
-00006510: 732d 6561 7374 2d32 2065 7861 6d70 6c65  s-east-2 example
-00006520: 732f 7065 725f 7265 6769 6f6e 5f69 6d61  s/per_region_ima
-00006530: 6765 732e 7961 6d6c 272c 0a20 2020 2020  ges.yaml',.     
-00006540: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-00006550: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
-00006560: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
-00006570: 2020 6627 736b 7920 7374 6f70 207b 6e61    f'sky stop {na
-00006580: 6d65 7d20 2d79 272c 0a20 2020 2020 2020  me} -y',.       
-00006590: 2020 2020 2066 2773 6b79 2073 7461 7274       f'sky start
-000065a0: 207b 6e61 6d65 7d20 2d79 272c 0a20 2020   {name} -y',.   
-000065b0: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
-000065c0: 7865 6320 7b6e 616d 657d 2065 7861 6d70  xec {name} examp
-000065d0: 6c65 732f 7065 725f 7265 6769 6f6e 5f69  les/per_region_i
-000065e0: 6d61 6765 732e 7961 6d6c 272c 0a20 2020  mages.yaml',.   
-000065f0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00006600: 6f67 7320 7b6e 616d 657d 2032 202d 2d73  ogs {name} 2 --s
-00006610: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
-00006620: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
-00006630: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-00006640: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
-00006650: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-00006660: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d2d 2d20  .# ------------ 
-00006670: 5465 7374 2073 7461 6c65 206a 6f62 202d  Test stale job -
-00006680: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974  -----------.@pyt
-00006690: 6573 742e 6d61 726b 2e6e 6f5f 666c 7569  est.mark.no_flui
-000066a0: 6473 7461 636b 2020 2320 466c 7569 6453  dstack  # FluidS
-000066b0: 7461 636b 2064 6f65 7320 6e6f 7420 7375  tack does not su
-000066c0: 7070 6f72 7420 7374 6f70 7069 6e67 2069  pport stopping i
-000066d0: 6e73 7461 6e63 6573 2069 6e20 536b 7950  nstances in SkyP
-000066e0: 696c 6f74 2069 6d70 6c65 6d65 6e74 6174  ilot implementat
-000066f0: 696f 6e0a 4070 7974 6573 742e 6d61 726b  ion.@pytest.mark
-00006700: 2e6e 6f5f 6c61 6d62 6461 5f63 6c6f 7564  .no_lambda_cloud
-00006710: 2020 2320 4c61 6d62 6461 2043 6c6f 7564    # Lambda Cloud
-00006720: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-00006730: 7420 7374 6f70 7069 6e67 2069 6e73 7461  t stopping insta
-00006740: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
-00006750: 6b2e 6e6f 5f6b 7562 6572 6e65 7465 7320  k.no_kubernetes 
-00006760: 2023 204b 7562 6572 6e65 7465 7320 646f   # Kubernetes do
-00006770: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
-00006780: 746f 7070 696e 6720 696e 7374 616e 6365  topping instance
-00006790: 730a 6465 6620 7465 7374 5f73 7461 6c65  s.def test_stale
-000067a0: 5f6a 6f62 2867 656e 6572 6963 5f63 6c6f  _job(generic_clo
-000067b0: 7564 3a20 7374 7229 3a0a 2020 2020 6e61  ud: str):.    na
-000067c0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-000067d0: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
-000067e0: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-000067f0: 2020 2773 7461 6c65 5f6a 6f62 272c 0a20    'stale_job',. 
-00006800: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-00006810: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-00006820: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
-00006830: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
-00006840: 636c 6f75 647d 2022 6563 686f 2068 6922  cloud} "echo hi"
-00006850: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00006860: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-00006870: 202d 6420 2265 6368 6f20 7374 6172 743b   -d "echo start;
-00006880: 2073 6c65 6570 2031 3030 3030 2227 2c0a   sleep 10000"',.
-00006890: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000068a0: 7920 7374 6f70 207b 6e61 6d65 7d20 2d79  y stop {name} -y
-000068b0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-000068c0: 736c 6565 7020 3130 3027 2c20 2023 2045  sleep 100',  # E
-000068d0: 6e73 7572 6520 7468 6973 2069 7320 6c61  nsure this is la
-000068e0: 7267 6520 656e 6f75 6768 2c20 656c 7365  rge enough, else
-000068f0: 2047 4350 206c 6561 6b73 2e0a 2020 2020   GCP leaks..    
-00006900: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
-00006910: 6172 7420 7b6e 616d 657d 202d 7927 2c0a  art {name} -y',.
-00006920: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00006930: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
-00006940: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
-00006950: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
-00006960: 2071 7565 7565 207b 6e61 6d65 7d29 3b20   queue {name}); 
-00006970: 6563 686f 2022 2473 223b 2065 6368 6f3b  echo "$s"; echo;
-00006980: 2065 6368 6f3b 2065 6368 6f20 2224 7322   echo; echo "$s"
-00006990: 207c 2067 7265 7020 4641 494c 4544 272c   | grep FAILED',
-000069a0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-000069b0: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
-000069c0: 7920 7b6e 616d 657d 272c 0a20 2020 2029  y {name}',.    )
-000069d0: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-000069e0: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-000069f0: 742e 6d61 726b 2e61 7773 0a64 6566 2074  t.mark.aws.def t
-00006a00: 6573 745f 6177 735f 7374 616c 655f 6a6f  est_aws_stale_jo
-00006a10: 625f 6d61 6e75 616c 5f72 6573 7461 7274  b_manual_restart
-00006a20: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
-00006a30: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-00006a40: 2829 0a20 2020 206e 616d 655f 6f6e 5f63  ().    name_on_c
-00006a50: 6c6f 7564 203d 2063 6f6d 6d6f 6e5f 7574  loud = common_ut
-00006a60: 696c 732e 6d61 6b65 5f63 6c75 7374 6572  ils.make_cluster
-00006a70: 5f6e 616d 655f 6f6e 5f63 6c6f 7564 280a  _name_on_cloud(.
-00006a80: 2020 2020 2020 2020 6e61 6d65 2c20 736b          name, sk
-00006a90: 792e 4157 532e 6d61 785f 636c 7573 7465  y.AWS.max_cluste
-00006aa0: 725f 6e61 6d65 5f6c 656e 6774 6828 2929  r_name_length())
-00006ab0: 0a20 2020 2072 6567 696f 6e20 3d20 2775  .    region = 'u
-00006ac0: 732d 6561 7374 2d32 270a 2020 2020 7465  s-east-2'.    te
-00006ad0: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-00006ae0: 2020 2027 6177 735f 7374 616c 655f 6a6f     'aws_stale_jo
-00006af0: 625f 6d61 6e75 616c 5f72 6573 7461 7274  b_manual_restart
-00006b00: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-00006b10: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00006b20: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-00006b30: 657d 202d 2d63 6c6f 7564 2061 7773 202d  e} --cloud aws -
-00006b40: 2d72 6567 696f 6e20 7b72 6567 696f 6e7d  -region {region}
-00006b50: 2022 6563 686f 2068 6922 272c 0a20 2020   "echo hi"',.   
-00006b60: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
-00006b70: 7865 6320 7b6e 616d 657d 202d 6420 2265  xec {name} -d "e
-00006b80: 6368 6f20 7374 6172 743b 2073 6c65 6570  cho start; sleep
-00006b90: 2031 3030 3030 2227 2c0a 2020 2020 2020   10000"',.      
-00006ba0: 2020 2020 2020 2320 5374 6f70 2074 6865        # Stop the
-00006bb0: 2063 6c75 7374 6572 206d 616e 7561 6c6c   cluster manuall
-00006bc0: 792e 0a20 2020 2020 2020 2020 2020 2066  y..            f
-00006bd0: 2769 643d 6061 7773 2065 6332 2064 6573  'id=`aws ec2 des
-00006be0: 6372 6962 652d 696e 7374 616e 6365 7320  cribe-instances 
-00006bf0: 2d2d 7265 6769 6f6e 207b 7265 6769 6f6e  --region {region
-00006c00: 7d20 2d2d 6669 6c74 6572 7320 270a 2020  } --filters '.  
-00006c10: 2020 2020 2020 2020 2020 6627 4e61 6d65            f'Name
-00006c20: 3d74 6167 3a72 6179 2d63 6c75 7374 6572  =tag:ray-cluster
-00006c30: 2d6e 616d 652c 5661 6c75 6573 3d7b 6e61  -name,Values={na
-00006c40: 6d65 5f6f 6e5f 636c 6f75 647d 2027 0a20  me_on_cloud} '. 
-00006c50: 2020 2020 2020 2020 2020 2066 272d 2d71             f'--q
-00006c60: 7565 7279 2052 6573 6572 7661 7469 6f6e  uery Reservation
-00006c70: 735b 5d2e 496e 7374 616e 6365 735b 5d2e  s[].Instances[].
-00006c80: 496e 7374 616e 6365 4964 2027 0a20 2020  InstanceId '.   
-00006c90: 2020 2020 2020 2020 2027 2d2d 6f75 7470           '--outp
-00006ca0: 7574 2074 6578 7460 3b20 270a 2020 2020  ut text`; '.    
-00006cb0: 2020 2020 2020 2020 6627 6177 7320 6563          f'aws ec
-00006cc0: 3220 7374 6f70 2d69 6e73 7461 6e63 6573  2 stop-instances
-00006cd0: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
-00006ce0: 6e7d 2027 0a20 2020 2020 2020 2020 2020  n} '.           
-00006cf0: 2027 2d2d 696e 7374 616e 6365 2d69 6473   '--instance-ids
-00006d00: 2024 6964 272c 0a20 2020 2020 2020 2020   $id',.         
-00006d10: 2020 2027 736c 6565 7020 3430 272c 0a20     'sleep 40',. 
-00006d20: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00006d30: 206c 6175 6e63 6820 2d63 207b 6e61 6d65   launch -c {name
-00006d40: 7d20 2d79 2022 6563 686f 2068 6922 272c  } -y "echo hi"',
-00006d50: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00006d60: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
-00006d70: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
-00006d80: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-00006d90: 6773 207b 6e61 6d65 7d20 3320 2d2d 7374  gs {name} 3 --st
-00006da0: 6174 7573 272c 0a20 2020 2020 2020 2020  atus',.         
-00006db0: 2020 2023 2045 6e73 7572 6520 7468 6520     # Ensure the 
-00006dc0: 736b 796c 6574 2075 7064 6174 6564 2074  skylet updated t
-00006dd0: 6865 2073 7461 6c65 206a 6f62 2073 7461  he stale job sta
-00006de0: 7475 732e 0a20 2020 2020 2020 2020 2020  tus..           
-00006df0: 2066 2773 6c65 6570 207b 6576 656e 7473   f'sleep {events
-00006e00: 2e4a 6f62 5363 6865 6475 6c65 7245 7665  .JobSchedulerEve
-00006e10: 6e74 2e45 5645 4e54 5f49 4e54 4552 5641  nt.EVENT_INTERVA
-00006e20: 4c5f 5345 434f 4e44 537d 272c 0a20 2020  L_SECONDS}',.   
-00006e30: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
-00006e40: 6b79 2071 7565 7565 207b 6e61 6d65 7d29  ky queue {name})
-00006e50: 3b20 6563 686f 2022 2473 223b 2065 6368  ; echo "$s"; ech
-00006e60: 6f3b 2065 6368 6f3b 2065 6368 6f20 2224  o; echo; echo "$
-00006e70: 7322 207c 2067 7265 7020 4641 494c 4544  s" | grep FAILED
-00006e80: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-00006e90: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-00006ea0: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-00006eb0: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-00006ec0: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
-00006ed0: 6573 742e 6d61 726b 2e67 6370 0a64 6566  est.mark.gcp.def
-00006ee0: 2074 6573 745f 6763 705f 7374 616c 655f   test_gcp_stale_
-00006ef0: 6a6f 625f 6d61 6e75 616c 5f72 6573 7461  job_manual_resta
-00006f00: 7274 2829 3a0a 2020 2020 6e61 6d65 203d  rt():.    name =
-00006f10: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-00006f20: 6d65 2829 0a20 2020 206e 616d 655f 6f6e  me().    name_on
-00006f30: 5f63 6c6f 7564 203d 2063 6f6d 6d6f 6e5f  _cloud = common_
-00006f40: 7574 696c 732e 6d61 6b65 5f63 6c75 7374  utils.make_clust
-00006f50: 6572 5f6e 616d 655f 6f6e 5f63 6c6f 7564  er_name_on_cloud
-00006f60: 280a 2020 2020 2020 2020 6e61 6d65 2c20  (.        name, 
-00006f70: 736b 792e 4743 502e 6d61 785f 636c 7573  sky.GCP.max_clus
-00006f80: 7465 725f 6e61 6d65 5f6c 656e 6774 6828  ter_name_length(
-00006f90: 2929 0a20 2020 207a 6f6e 6520 3d20 2775  )).    zone = 'u
-00006fa0: 732d 7765 7374 322d 6127 0a20 2020 2071  s-west2-a'.    q
-00006fb0: 7565 7279 5f63 6d64 203d 2028 6627 6763  uery_cmd = (f'gc
-00006fc0: 6c6f 7564 2063 6f6d 7075 7465 2069 6e73  loud compute ins
-00006fd0: 7461 6e63 6573 206c 6973 7420 2d2d 6669  tances list --fi
-00006fe0: 6c74 6572 3d27 0a20 2020 2020 2020 2020  lter='.         
-00006ff0: 2020 2020 2020 2020 6627 2228 6c61 6265          f'"(labe
-00007000: 6c73 2e72 6179 2d63 6c75 7374 6572 2d6e  ls.ray-cluster-n
-00007010: 616d 653d 7b6e 616d 655f 6f6e 5f63 6c6f  ame={name_on_clo
-00007020: 7564 7d29 2220 270a 2020 2020 2020 2020  ud})" '.        
-00007030: 2020 2020 2020 2020 2066 272d 2d7a 6f6e           f'--zon
-00007040: 6573 3d7b 7a6f 6e65 7d20 2d2d 666f 726d  es={zone} --form
-00007050: 6174 3d22 7661 6c75 6528 6e61 6d65 2922  at="value(name)"
-00007060: 2729 0a20 2020 2073 746f 705f 636d 6420  ').    stop_cmd 
-00007070: 3d20 2866 2767 636c 6f75 6420 636f 6d70  = (f'gcloud comp
-00007080: 7574 6520 696e 7374 616e 6365 7320 7374  ute instances st
-00007090: 6f70 202d 2d7a 6f6e 653d 7b7a 6f6e 657d  op --zone={zone}
-000070a0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-000070b0: 2020 6627 202d 2d71 7569 6574 2024 287b    f' --quiet $({
-000070c0: 7175 6572 795f 636d 647d 2927 290a 2020  query_cmd})').  
-000070d0: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-000070e0: 2020 2020 2020 2027 6763 705f 7374 616c         'gcp_stal
-000070f0: 655f 6a6f 625f 6d61 6e75 616c 5f72 6573  e_job_manual_res
-00007100: 7461 7274 272c 0a20 2020 2020 2020 205b  tart',.        [
-00007110: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00007120: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
-00007130: 7b6e 616d 657d 202d 2d63 6c6f 7564 2067  {name} --cloud g
-00007140: 6370 202d 2d7a 6f6e 6520 7b7a 6f6e 657d  cp --zone {zone}
-00007150: 2022 6563 686f 2068 6922 272c 0a20 2020   "echo hi"',.   
-00007160: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
-00007170: 7865 6320 7b6e 616d 657d 202d 6420 2265  xec {name} -d "e
-00007180: 6368 6f20 7374 6172 743b 2073 6c65 6570  cho start; sleep
-00007190: 2031 3030 3030 2227 2c0a 2020 2020 2020   10000"',.      
-000071a0: 2020 2020 2020 2320 5374 6f70 2074 6865        # Stop the
-000071b0: 2063 6c75 7374 6572 206d 616e 7561 6c6c   cluster manuall
-000071c0: 792e 0a20 2020 2020 2020 2020 2020 2073  y..            s
-000071d0: 746f 705f 636d 642c 0a20 2020 2020 2020  top_cmd,.       
-000071e0: 2020 2020 2027 736c 6565 7020 3430 272c       'sleep 40',
-000071f0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00007200: 6b79 206c 6175 6e63 6820 2d63 207b 6e61  ky launch -c {na
-00007210: 6d65 7d20 2d79 2022 6563 686f 2068 6922  me} -y "echo hi"
-00007220: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00007230: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00007240: 2031 202d 2d73 7461 7475 7327 2c0a 2020   1 --status',.  
-00007250: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00007260: 6c6f 6773 207b 6e61 6d65 7d20 3320 2d2d  logs {name} 3 --
-00007270: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
-00007280: 2020 2020 2023 2045 6e73 7572 6520 7468       # Ensure th
-00007290: 6520 736b 796c 6574 2075 7064 6174 6564  e skylet updated
-000072a0: 2074 6865 2073 7461 6c65 206a 6f62 2073   the stale job s
-000072b0: 7461 7475 732e 0a20 2020 2020 2020 2020  tatus..         
-000072c0: 2020 2066 2773 6c65 6570 207b 6576 656e     f'sleep {even
-000072d0: 7473 2e4a 6f62 5363 6865 6475 6c65 7245  ts.JobSchedulerE
-000072e0: 7665 6e74 2e45 5645 4e54 5f49 4e54 4552  vent.EVENT_INTER
-000072f0: 5641 4c5f 5345 434f 4e44 537d 272c 0a20  VAL_SECONDS}',. 
-00007300: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
-00007310: 2873 6b79 2071 7565 7565 207b 6e61 6d65  (sky queue {name
-00007320: 7d29 3b20 6563 686f 2022 2473 223b 2065  }); echo "$s"; e
-00007330: 6368 6f3b 2065 6368 6f3b 2065 6368 6f20  cho; echo; echo 
-00007340: 2224 7322 207c 2067 7265 7020 4641 494c  "$s" | grep FAIL
-00007350: 4544 272c 0a20 2020 2020 2020 205d 2c0a  ED',.        ],.
-00007360: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-00007370: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
-00007380: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-00007390: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
-000073a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2043 6865 636b  ---------- Check
-000073b0: 2053 6b79 2773 2065 6e76 6972 6f6e 6d65   Sky's environme
-000073c0: 6e74 2076 6172 6961 626c 6573 3b20 776f  nt variables; wo
-000073d0: 726b 6469 722e 202d 2d2d 2d2d 2d2d 2d2d  rkdir. ---------
-000073e0: 2d0a 4070 7974 6573 742e 6d61 726b 2e6e  -.@pytest.mark.n
-000073f0: 6f5f 666c 7569 6473 7461 636b 2020 2320  o_fluidstack  # 
-00007400: 5265 7175 6972 6573 2061 6d61 7a6f 6e20  Requires amazon 
-00007410: 5333 0a40 7079 7465 7374 2e6d 6172 6b2e  S3.@pytest.mark.
-00007420: 6e6f 5f73 6370 2020 2320 5343 5020 646f  no_scp  # SCP do
-00007430: 6573 206e 6f74 2073 7570 706f 7274 206e  es not support n
-00007440: 756d 5f6e 6f64 6573 203e 2031 2079 6574  um_nodes > 1 yet
-00007450: 0a64 6566 2074 6573 745f 656e 765f 6368  .def test_env_ch
-00007460: 6563 6b28 6765 6e65 7269 635f 636c 6f75  eck(generic_clou
-00007470: 643a 2073 7472 293a 0a20 2020 206e 616d  d: str):.    nam
-00007480: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-00007490: 5f6e 616d 6528 290a 2020 2020 746f 7461  _name().    tota
-000074a0: 6c5f 7469 6d65 6f75 745f 6d69 6e75 7465  l_timeout_minute
-000074b0: 7320 3d20 3235 2069 6620 6765 6e65 7269  s = 25 if generi
-000074c0: 635f 636c 6f75 6420 3d3d 2027 617a 7572  c_cloud == 'azur
-000074d0: 6527 2065 6c73 6520 3135 0a20 2020 2074  e' else 15.    t
-000074e0: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-000074f0: 2020 2020 2765 6e76 5f63 6865 636b 272c      'env_check',
-00007500: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-00007510: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-00007520: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
-00007530: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
-00007540: 635f 636c 6f75 647d 202d 2d64 6574 6163  c_cloud} --detac
-00007550: 682d 7365 7475 7020 6578 616d 706c 6573  h-setup examples
-00007560: 2f65 6e76 5f63 6865 636b 2e79 616d 6c27  /env_check.yaml'
-00007570: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00007580: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-00007590: 3120 2d2d 7374 6174 7573 272c 2020 2320  1 --status',  # 
-000075a0: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
-000075b0: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
-000075c0: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
-000075d0: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-000075e0: 7d27 2c0a 2020 2020 2020 2020 7469 6d65  }',.        time
-000075f0: 6f75 743d 746f 7461 6c5f 7469 6d65 6f75  out=total_timeou
-00007600: 745f 6d69 6e75 7465 7320 2a20 3630 2c0a  t_minutes * 60,.
-00007610: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-00007620: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
-00007630: 202d 2d2d 2d2d 2d2d 2d2d 2d20 6669 6c65   ---------- file
-00007640: 5f6d 6f75 6e74 7320 2d2d 2d2d 2d2d 2d2d  _mounts --------
-00007650: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
-00007660: 6e6f 5f73 6370 2020 2320 5343 5020 646f  no_scp  # SCP do
-00007670: 6573 206e 6f74 2073 7570 706f 7274 206e  es not support n
-00007680: 756d 5f6e 6f64 6573 203e 2031 2079 6574  um_nodes > 1 yet
-00007690: 2e20 5275 6e20 7465 7374 5f73 6370 5f66  . Run test_scp_f
-000076a0: 696c 655f 6d6f 756e 7473 2069 6e73 7465  ile_mounts inste
-000076b0: 6164 2e0a 6465 6620 7465 7374 5f66 696c  ad..def test_fil
-000076c0: 655f 6d6f 756e 7473 2867 656e 6572 6963  e_mounts(generic
-000076d0: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
-000076e0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-000076f0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-00007700: 2065 7874 7261 5f66 6c61 6773 203d 2027   extra_flags = '
-00007710: 270a 2020 2020 6966 2067 656e 6572 6963  '.    if generic
-00007720: 5f63 6c6f 7564 2069 6e20 276b 7562 6572  _cloud in 'kuber
-00007730: 6e65 7465 7327 3a0a 2020 2020 2020 2020  netes':.        
-00007740: 2320 4b75 6265 726e 6574 6573 2064 6f65  # Kubernetes doe
-00007750: 7320 6e6f 7420 7375 7070 6f72 7420 6d75  s not support mu
-00007760: 6c74 692d 6e6f 6465 0a20 2020 2020 2020  lti-node.       
-00007770: 2023 204e 4f54 453a 2054 6869 7320 7465   # NOTE: This te
-00007780: 7374 2077 696c 6c20 6661 696c 2069 6620  st will fail if 
-00007790: 796f 7520 6861 7665 2061 204b 7562 6572  you have a Kuber
-000077a0: 6e65 7465 7320 636c 7573 7465 7220 7275  netes cluster ru
-000077b0: 6e6e 696e 6720 6f6e 0a20 2020 2020 2020  nning on.       
-000077c0: 2023 2020 6172 6d36 3420 2865 2e67 2e2c   #  arm64 (e.g.,
-000077d0: 2041 7070 6c65 2053 696c 6963 6f6e 2920   Apple Silicon) 
-000077e0: 7369 6e63 6520 676f 6f66 7973 2064 6f65  since goofys doe
-000077f0: 7320 6e6f 7420 776f 726b 206f 6e20 6172  s not work on ar
-00007800: 6d36 342e 0a20 2020 2020 2020 2065 7874  m64..        ext
-00007810: 7261 5f66 6c61 6773 203d 2027 2d2d 6e75  ra_flags = '--nu
-00007820: 6d2d 6e6f 6465 7320 3127 0a20 2020 2074  m-nodes 1'.    t
-00007830: 6573 745f 636f 6d6d 616e 6473 203d 205b  est_commands = [
-00007840: 0a20 2020 2020 2020 202a 7374 6f72 6167  .        *storag
-00007850: 655f 7365 7475 705f 636f 6d6d 616e 6473  e_setup_commands
-00007860: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-00007870: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
-00007880: 6d65 7d20 2d2d 636c 6f75 6420 7b67 656e  me} --cloud {gen
-00007890: 6572 6963 5f63 6c6f 7564 7d20 7b65 7874  eric_cloud} {ext
-000078a0: 7261 5f66 6c61 6773 7d20 6578 616d 706c  ra_flags} exampl
-000078b0: 6573 2f75 7369 6e67 5f66 696c 655f 6d6f  es/using_file_mo
-000078c0: 756e 7473 2e79 616d 6c27 2c0a 2020 2020  unts.yaml',.    
-000078d0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-000078e0: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
-000078f0: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
-00007900: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
-00007910: 2020 2020 5d0a 2020 2020 7465 7374 203d      ].    test =
-00007920: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-00007930: 7573 696e 675f 6669 6c65 5f6d 6f75 6e74  using_file_mount
-00007940: 7327 2c0a 2020 2020 2020 2020 7465 7374  s',.        test
-00007950: 5f63 6f6d 6d61 6e64 732c 0a20 2020 2020  _commands,.     
-00007960: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
-00007970: 207b 6e61 6d65 7d27 2c0a 2020 2020 2020   {name}',.      
-00007980: 2020 5f67 6574 5f74 696d 656f 7574 2867    _get_timeout(g
-00007990: 656e 6572 6963 5f63 6c6f 7564 2c20 3230  eneric_cloud, 20
-000079a0: 202a 2036 3029 2c20 2023 2032 3020 6d69   * 60),  # 20 mi
-000079b0: 6e73 0a20 2020 2029 0a20 2020 2072 756e  ns.    ).    run
+00005f90: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
+00005fa0: 616d 657d 202d 2d72 6567 696f 6e20 7573  ame} --region us
+00005fb0: 2d77 6573 7433 2074 6573 7473 2f74 6573  -west3 tests/tes
+00005fc0: 745f 7961 6d6c 732f 6763 705f 7065 725f  t_yamls/gcp_per_
+00005fd0: 7265 6769 6f6e 5f69 6d61 6765 732e 7961  region_images.ya
+00005fe0: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+00005ff0: 2023 2053 686f 756c 6420 7375 6363 6573   # Should succes
+00006000: 7320 6265 6361 7573 6520 7468 6520 696d  s because the im
+00006010: 6167 6520 6964 206d 6174 6368 2066 6f72  age id match for
+00006020: 2074 6865 2072 6567 696f 6e2e 0a20 2020   the region..   
+00006030: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00006040: 6175 6e63 6820 2d63 207b 6e61 6d65 7d20  aunch -c {name} 
+00006050: 2d2d 636c 6f75 6420 6763 7020 2d2d 696d  --cloud gcp --im
+00006060: 6167 652d 6964 2070 726f 6a65 6374 732f  age-id projects/
+00006070: 7562 756e 7475 2d6f 732d 636c 6f75 642f  ubuntu-os-cloud/
+00006080: 676c 6f62 616c 2f69 6d61 6765 732f 7562  global/images/ub
+00006090: 756e 7475 2d31 3830 342d 6269 6f6e 6963  untu-1804-bionic
+000060a0: 2d76 3230 3233 3031 3132 2074 6573 7473  -v20230112 tests
+000060b0: 2f74 6573 745f 7961 6d6c 732f 6d69 6e69  /test_yamls/mini
+000060c0: 6d61 6c2e 7961 6d6c 272c 0a20 2020 2020  mal.yaml',.     
+000060d0: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+000060e0: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
+000060f0: 2067 6370 202d 2d69 6d61 6765 2d69 6420   gcp --image-id 
+00006100: 7072 6f6a 6563 7473 2f75 6275 6e74 752d  projects/ubuntu-
+00006110: 6f73 2d63 6c6f 7564 2f67 6c6f 6261 6c2f  os-cloud/global/
+00006120: 696d 6167 6573 2f75 6275 6e74 752d 3138  images/ubuntu-18
+00006130: 3034 2d62 696f 6e69 632d 7632 3032 3330  04-bionic-v20230
+00006140: 3131 3220 7465 7374 732f 7465 7374 5f79  112 tests/test_y
+00006150: 616d 6c73 2f6d 696e 696d 616c 2e79 616d  amls/minimal.yam
+00006160: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00006170: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+00006180: 7d20 2d2d 636c 6f75 6420 6763 7020 2d2d  } --cloud gcp --
+00006190: 696d 6167 652d 6964 2073 6b79 7069 6c6f  image-id skypilo
+000061a0: 743a 6370 752d 6465 6269 616e 2d31 3020  t:cpu-debian-10 
+000061b0: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
+000061c0: 2f6d 696e 696d 616c 2e79 616d 6c20 2626  /minimal.yaml &&
+000061d0: 2065 7869 7420 3120 7c7c 2074 7275 6527   exit 1 || true'
+000061e0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+000061f0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+00006200: 3120 2d2d 7374 6174 7573 272c 0a20 2020  1 --status',.   
+00006210: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00006220: 6f67 7320 7b6e 616d 657d 2032 202d 2d73  ogs {name} 2 --s
+00006230: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
+00006240: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+00006250: 6e61 6d65 7d20 3320 2d2d 7374 6174 7573  name} 3 --status
+00006260: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00006270: 2773 6b79 2073 7461 7475 7320 2d2d 616c  'sky status --al
+00006280: 6c20 7c20 6772 6570 207b 6e61 6d65 7d20  l | grep {name} 
+00006290: 7c20 6772 6570 2075 732d 7765 7374 3327  | grep us-west3'
+000062a0: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
+000062b0: 7265 6769 6f6e 2069 7320 636f 7272 6563  region is correc
+000062c0: 742e 0a20 2020 2020 2020 2020 2020 2023  t..            #
+000062d0: 2045 6e73 7572 6520 6578 6563 2077 6f72   Ensure exec wor
+000062e0: 6b73 2e0a 2020 2020 2020 2020 2020 2020  ks..            
+000062f0: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+00006300: 7d20 2d2d 7265 6769 6f6e 2075 732d 7765  } --region us-we
+00006310: 7374 3320 7465 7374 732f 7465 7374 5f79  st3 tests/test_y
+00006320: 616d 6c73 2f67 6370 5f70 6572 5f72 6567  amls/gcp_per_reg
+00006330: 696f 6e5f 696d 6167 6573 2e79 616d 6c27  ion_images.yaml'
+00006340: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00006350: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+00006360: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
+00006370: 2f67 6370 5f70 6572 5f72 6567 696f 6e5f  /gcp_per_region_
+00006380: 696d 6167 6573 2e79 616d 6c27 2c0a 2020  images.yaml',.  
+00006390: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000063a0: 6578 6563 207b 6e61 6d65 7d20 2d2d 636c  exec {name} --cl
+000063b0: 6f75 6420 6763 7020 2d2d 7265 6769 6f6e  oud gcp --region
+000063c0: 2075 732d 7765 7374 3320 226c 7320 7e22   us-west3 "ls ~"
+000063d0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000063e0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+000063f0: 2022 6c73 207e 2227 2c0a 2020 2020 2020   "ls ~"',.      
+00006400: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+00006410: 207b 6e61 6d65 7d20 3420 2d2d 7374 6174   {name} 4 --stat
+00006420: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
+00006430: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+00006440: 657d 2035 202d 2d73 7461 7475 7327 2c0a  e} 5 --status',.
+00006450: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00006460: 7920 6c6f 6773 207b 6e61 6d65 7d20 3620  y logs {name} 6 
+00006470: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
+00006480: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00006490: 7320 7b6e 616d 657d 2037 202d 2d73 7461  s {name} 7 --sta
+000064a0: 7475 7327 2c0a 2020 2020 2020 2020 5d2c  tus',.        ],
+000064b0: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
+000064c0: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
+000064d0: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+000064e0: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
+000064f0: 7079 7465 7374 2e6d 6172 6b2e 6177 730a  pytest.mark.aws.
+00006500: 6465 6620 7465 7374 5f61 7773 5f69 6d61  def test_aws_ima
+00006510: 6765 5f69 645f 6469 6374 5f7a 6f6e 6528  ge_id_dict_zone(
+00006520: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
+00006530: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+00006540: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
+00006550: 7428 0a20 2020 2020 2020 2027 6177 735f  t(.        'aws_
+00006560: 696d 6167 655f 6964 5f64 6963 745f 7a6f  image_id_dict_zo
+00006570: 6e65 272c 0a20 2020 2020 2020 205b 0a20  ne',.        [. 
+00006580: 2020 2020 2020 2020 2020 2023 2059 414d             # YAM
+00006590: 4c20 6861 730a 2020 2020 2020 2020 2020  L has.          
+000065a0: 2020 2320 2020 696d 6167 655f 6964 3a0a    #   image_id:.
+000065b0: 2020 2020 2020 2020 2020 2020 2320 2020              #   
+000065c0: 2020 2020 7573 2d77 6573 742d 323a 2073      us-west-2: s
+000065d0: 6b79 7069 6c6f 743a 6770 752d 7562 756e  kypilot:gpu-ubun
+000065e0: 7475 2d31 3830 340a 2020 2020 2020 2020  tu-1804.        
+000065f0: 2020 2020 2320 2020 2020 2020 7573 2d65      #       us-e
+00006600: 6173 742d 323a 2073 6b79 7069 6c6f 743a  ast-2: skypilot:
+00006610: 6770 752d 7562 756e 7475 2d32 3030 340a  gpu-ubuntu-2004.
+00006620: 2020 2020 2020 2020 2020 2020 2320 5573              # Us
+00006630: 6520 7a6f 6e65 2074 6f20 6669 6c74 6572  e zone to filter
+00006640: 2069 6d61 6765 5f69 6420 6469 6374 2e0a   image_id dict..
+00006650: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00006660: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+00006670: 6e61 6d65 7d20 2d2d 7a6f 6e65 2075 732d  name} --zone us-
+00006680: 6561 7374 2d31 6220 6578 616d 706c 6573  east-1b examples
+00006690: 2f70 6572 5f72 6567 696f 6e5f 696d 6167  /per_region_imag
+000066a0: 6573 2e79 616d 6c20 2626 2065 7869 7420  es.yaml && exit 
+000066b0: 3120 7c7c 2074 7275 6527 2c0a 2020 2020  1 || true',.    
+000066c0: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
+000066d0: 6174 7573 207c 2067 7265 7020 7b6e 616d  atus | grep {nam
+000066e0: 657d 2026 2620 6578 6974 2031 207c 7c20  e} && exit 1 || 
+000066f0: 7472 7565 272c 2020 2320 456e 7375 7265  true',  # Ensure
+00006700: 2074 6865 2063 6c75 7374 6572 2069 7320   the cluster is 
+00006710: 6e6f 7420 6372 6561 7465 642e 0a20 2020  not created..   
+00006720: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00006730: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
+00006740: 657d 202d 2d7a 6f6e 6520 7573 2d65 6173  e} --zone us-eas
+00006750: 742d 3261 2065 7861 6d70 6c65 732f 7065  t-2a examples/pe
+00006760: 725f 7265 6769 6f6e 5f69 6d61 6765 732e  r_region_images.
+00006770: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00006780: 2020 2023 2053 686f 756c 6420 7375 6363     # Should succ
+00006790: 6573 7320 6265 6361 7573 6520 7468 6520  ess because the 
+000067a0: 696d 6167 6520 6964 206d 6174 6368 2066  image id match f
+000067b0: 6f72 2074 6865 207a 6f6e 652e 0a20 2020  or the zone..   
+000067c0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+000067d0: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
+000067e0: 657d 202d 2d69 6d61 6765 2d69 6420 736b  e} --image-id sk
+000067f0: 7970 696c 6f74 3a67 7075 2d75 6275 6e74  ypilot:gpu-ubunt
+00006800: 752d 3230 3034 2065 7861 6d70 6c65 732f  u-2004 examples/
+00006810: 6d69 6e69 6d61 6c2e 7961 6d6c 272c 0a20  minimal.yaml',. 
+00006820: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00006830: 2065 7865 6320 7b6e 616d 657d 202d 2d69   exec {name} --i
+00006840: 6d61 6765 2d69 6420 736b 7970 696c 6f74  mage-id skypilot
+00006850: 3a67 7075 2d75 6275 6e74 752d 3230 3034  :gpu-ubuntu-2004
+00006860: 2065 7861 6d70 6c65 732f 6d69 6e69 6d61   examples/minima
+00006870: 6c2e 7961 6d6c 272c 0a20 2020 2020 2020  l.yaml',.       
+00006880: 2020 2020 2023 2046 6169 6c20 6475 6520       # Fail due 
+00006890: 746f 2069 6d61 6765 2069 6420 6d69 736d  to image id mism
+000068a0: 6174 6368 2e0a 2020 2020 2020 2020 2020  atch..          
+000068b0: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+000068c0: 6d65 7d20 2d2d 696d 6167 652d 6964 2073  me} --image-id s
+000068d0: 6b79 7069 6c6f 743a 6770 752d 7562 756e  kypilot:gpu-ubun
+000068e0: 7475 2d31 3830 3420 6578 616d 706c 6573  tu-1804 examples
+000068f0: 2f6d 696e 696d 616c 2e79 616d 6c20 2626  /minimal.yaml &&
+00006900: 2065 7869 7420 3120 7c7c 2074 7275 6527   exit 1 || true'
+00006910: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00006920: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+00006930: 3120 2d2d 7374 6174 7573 272c 0a20 2020  1 --status',.   
+00006940: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+00006950: 6f67 7320 7b6e 616d 657d 2032 202d 2d73  ogs {name} 2 --s
+00006960: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
+00006970: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+00006980: 6e61 6d65 7d20 3320 2d2d 7374 6174 7573  name} 3 --status
+00006990: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000069a0: 2773 6b79 2073 7461 7475 7320 2d2d 616c  'sky status --al
+000069b0: 6c20 7c20 6772 6570 207b 6e61 6d65 7d20  l | grep {name} 
+000069c0: 7c20 6772 6570 2075 732d 6561 7374 2d32  | grep us-east-2
+000069d0: 6127 2c20 2023 2045 6e73 7572 6520 7468  a',  # Ensure th
+000069e0: 6520 7a6f 6e65 2069 7320 636f 7272 6563  e zone is correc
+000069f0: 742e 0a20 2020 2020 2020 2020 2020 2023  t..            #
+00006a00: 2045 6e73 7572 6520 6578 6563 2077 6f72   Ensure exec wor
+00006a10: 6b73 2e0a 2020 2020 2020 2020 2020 2020  ks..            
+00006a20: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+00006a30: 7d20 2d2d 7a6f 6e65 2075 732d 6561 7374  } --zone us-east
+00006a40: 2d32 6120 6578 616d 706c 6573 2f70 6572  -2a examples/per
+00006a50: 5f72 6567 696f 6e5f 696d 6167 6573 2e79  _region_images.y
+00006a60: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+00006a70: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+00006a80: 6d65 7d20 6578 616d 706c 6573 2f70 6572  me} examples/per
+00006a90: 5f72 6567 696f 6e5f 696d 6167 6573 2e79  _region_images.y
+00006aa0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+00006ab0: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+00006ac0: 6d65 7d20 2d2d 636c 6f75 6420 6177 7320  me} --cloud aws 
+00006ad0: 2d2d 7265 6769 6f6e 2075 732d 6561 7374  --region us-east
+00006ae0: 2d32 2022 6c73 207e 2227 2c0a 2020 2020  -2 "ls ~"',.    
+00006af0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+00006b00: 6563 207b 6e61 6d65 7d20 226c 7320 7e22  ec {name} "ls ~"
+00006b10: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00006b20: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+00006b30: 2034 202d 2d73 7461 7475 7327 2c0a 2020   4 --status',.  
+00006b40: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00006b50: 6c6f 6773 207b 6e61 6d65 7d20 3520 2d2d  logs {name} 5 --
+00006b60: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
+00006b70: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00006b80: 7b6e 616d 657d 2036 202d 2d73 7461 7475  {name} 6 --statu
+00006b90: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
+00006ba0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00006bb0: 7d20 3720 2d2d 7374 6174 7573 272c 0a20  } 7 --status',. 
+00006bc0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00006bd0: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+00006be0: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
+00006bf0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00006c00: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+00006c10: 6d61 726b 2e67 6370 0a64 6566 2074 6573  mark.gcp.def tes
+00006c20: 745f 6763 705f 696d 6167 655f 6964 5f64  t_gcp_image_id_d
+00006c30: 6963 745f 7a6f 6e65 2829 3a0a 2020 2020  ict_zone():.    
+00006c40: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+00006c50: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+00006c60: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+00006c70: 2020 2020 2767 6370 5f69 6d61 6765 5f69      'gcp_image_i
+00006c80: 645f 6469 6374 5f7a 6f6e 6527 2c0a 2020  d_dict_zone',.  
+00006c90: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+00006ca0: 2020 2020 2320 5573 6520 7a6f 6e65 2074      # Use zone t
+00006cb0: 6f20 6669 6c74 6572 2069 6d61 6765 5f69  o filter image_i
+00006cc0: 6420 6469 6374 2e0a 2020 2020 2020 2020  d dict..        
+00006cd0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+00006ce0: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
+00006cf0: 7a6f 6e65 2075 732d 6561 7374 312d 6120  zone us-east1-a 
+00006d00: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
+00006d10: 2f67 6370 5f70 6572 5f72 6567 696f 6e5f  /gcp_per_region_
+00006d20: 696d 6167 6573 2e79 616d 6c20 2626 2065  images.yaml && e
+00006d30: 7869 7420 3120 7c7c 2074 7275 6527 2c0a  xit 1 || true',.
+00006d40: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00006d50: 7920 7374 6174 7573 207c 2067 7265 7020  y status | grep 
+00006d60: 7b6e 616d 657d 2026 2620 6578 6974 2031  {name} && exit 1
+00006d70: 207c 7c20 7472 7565 272c 2020 2320 456e   || true',  # En
+00006d80: 7375 7265 2074 6865 2063 6c75 7374 6572  sure the cluster
+00006d90: 2069 7320 6e6f 7420 6372 6561 7465 642e   is not created.
+00006da0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00006db0: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+00006dc0: 7b6e 616d 657d 202d 2d7a 6f6e 6520 7573  {name} --zone us
+00006dd0: 2d63 656e 7472 616c 312d 6120 7465 7374  -central1-a test
+00006de0: 732f 7465 7374 5f79 616d 6c73 2f67 6370  s/test_yamls/gcp
+00006df0: 5f70 6572 5f72 6567 696f 6e5f 696d 6167  _per_region_imag
+00006e00: 6573 2e79 616d 6c27 2c0a 2020 2020 2020  es.yaml',.      
+00006e10: 2020 2020 2020 2320 5368 6f75 6c64 2073        # Should s
+00006e20: 7563 6365 7373 2062 6563 6175 7365 2074  uccess because t
+00006e30: 6865 2069 6d61 6765 2069 6420 6d61 7463  he image id matc
+00006e40: 6820 666f 7220 7468 6520 7a6f 6e65 2e0a  h for the zone..
+00006e50: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00006e60: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+00006e70: 6e61 6d65 7d20 2d2d 636c 6f75 6420 6763  name} --cloud gc
+00006e80: 7020 2d2d 696d 6167 652d 6964 2073 6b79  p --image-id sky
+00006e90: 7069 6c6f 743a 6370 752d 6465 6269 616e  pilot:cpu-debian
+00006ea0: 2d31 3020 7465 7374 732f 7465 7374 5f79  -10 tests/test_y
+00006eb0: 616d 6c73 2f6d 696e 696d 616c 2e79 616d  amls/minimal.yam
+00006ec0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00006ed0: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+00006ee0: 7d20 2d2d 636c 6f75 6420 6763 7020 2d2d  } --cloud gcp --
+00006ef0: 696d 6167 652d 6964 2073 6b79 7069 6c6f  image-id skypilo
+00006f00: 743a 6370 752d 6465 6269 616e 2d31 3020  t:cpu-debian-10 
+00006f10: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
+00006f20: 2f6d 696e 696d 616c 2e79 616d 6c27 2c0a  /minimal.yaml',.
+00006f30: 2020 2020 2020 2020 2020 2020 2320 4661              # Fa
+00006f40: 696c 2064 7565 2074 6f20 696d 6167 6520  il due to image 
+00006f50: 6964 206d 6973 6d61 7463 682e 0a20 2020  id mismatch..   
+00006f60: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+00006f70: 7865 6320 7b6e 616d 657d 202d 2d63 6c6f  xec {name} --clo
+00006f80: 7564 2067 6370 202d 2d69 6d61 6765 2d69  ud gcp --image-i
+00006f90: 6420 736b 7970 696c 6f74 3a67 7075 2d64  d skypilot:gpu-d
+00006fa0: 6562 6961 6e2d 3130 2074 6573 7473 2f74  ebian-10 tests/t
+00006fb0: 6573 745f 7961 6d6c 732f 6d69 6e69 6d61  est_yamls/minima
+00006fc0: 6c2e 7961 6d6c 2026 2620 6578 6974 2031  l.yaml && exit 1
+00006fd0: 207c 7c20 7472 7565 272c 0a20 2020 2020   || true',.     
+00006fe0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00006ff0: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
+00007000: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
+00007010: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+00007020: 6d65 7d20 3220 2d2d 7374 6174 7573 272c  me} 2 --status',
+00007030: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00007040: 6b79 206c 6f67 7320 7b6e 616d 657d 2033  ky logs {name} 3
+00007050: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+00007060: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
+00007070: 6174 7573 202d 2d61 6c6c 207c 2067 7265  atus --all | gre
+00007080: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
+00007090: 7573 2d63 656e 7472 616c 3127 2c20 2023  us-central1',  #
+000070a0: 2045 6e73 7572 6520 7468 6520 7a6f 6e65   Ensure the zone
+000070b0: 2069 7320 636f 7272 6563 742e 0a20 2020   is correct..   
+000070c0: 2020 2020 2020 2020 2023 2045 6e73 7572           # Ensur
+000070d0: 6520 6578 6563 2077 6f72 6b73 2e0a 2020  e exec works..  
+000070e0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000070f0: 6578 6563 207b 6e61 6d65 7d20 2d2d 636c  exec {name} --cl
+00007100: 6f75 6420 6763 7020 2d2d 7a6f 6e65 2075  oud gcp --zone u
+00007110: 732d 6365 6e74 7261 6c31 2d61 2074 6573  s-central1-a tes
+00007120: 7473 2f74 6573 745f 7961 6d6c 732f 6763  ts/test_yamls/gc
+00007130: 705f 7065 725f 7265 6769 6f6e 5f69 6d61  p_per_region_ima
+00007140: 6765 732e 7961 6d6c 272c 0a20 2020 2020  ges.yaml',.     
+00007150: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+00007160: 6320 7b6e 616d 657d 2074 6573 7473 2f74  c {name} tests/t
+00007170: 6573 745f 7961 6d6c 732f 6763 705f 7065  est_yamls/gcp_pe
+00007180: 725f 7265 6769 6f6e 5f69 6d61 6765 732e  r_region_images.
+00007190: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+000071a0: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+000071b0: 616d 657d 202d 2d63 6c6f 7564 2067 6370  ame} --cloud gcp
+000071c0: 202d 2d72 6567 696f 6e20 7573 2d63 656e   --region us-cen
+000071d0: 7472 616c 3120 226c 7320 7e22 272c 0a20  tral1 "ls ~"',. 
+000071e0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000071f0: 2065 7865 6320 7b6e 616d 657d 2022 6c73   exec {name} "ls
+00007200: 207e 2227 2c0a 2020 2020 2020 2020 2020   ~"',.          
+00007210: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+00007220: 6d65 7d20 3420 2d2d 7374 6174 7573 272c  me} 4 --status',
+00007230: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00007240: 6b79 206c 6f67 7320 7b6e 616d 657d 2035  ky logs {name} 5
+00007250: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+00007260: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+00007270: 6773 207b 6e61 6d65 7d20 3620 2d2d 7374  gs {name} 6 --st
+00007280: 6174 7573 272c 0a20 2020 2020 2020 2020  atus',.         
+00007290: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+000072a0: 616d 657d 2037 202d 2d73 7461 7475 7327  ame} 7 --status'
+000072b0: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+000072c0: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
+000072d0: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+000072e0: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+000072f0: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
+00007300: 7374 2e6d 6172 6b2e 6177 730a 6465 6620  st.mark.aws.def 
+00007310: 7465 7374 5f63 6c6f 6e65 5f64 6973 6b5f  test_clone_disk_
+00007320: 6177 7328 293a 0a20 2020 206e 616d 6520  aws():.    name 
+00007330: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+00007340: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
+00007350: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
+00007360: 636c 6f6e 655f 6469 736b 5f61 7773 272c  clone_disk_aws',
+00007370: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+00007380: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
+00007390: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
+000073a0: 202d 2d63 6c6f 7564 2061 7773 202d 2d72   --cloud aws --r
+000073b0: 6567 696f 6e20 7573 2d65 6173 742d 3220  egion us-east-2 
+000073c0: 2d2d 7265 7472 792d 756e 7469 6c2d 7570  --retry-until-up
+000073d0: 2022 6563 686f 2068 656c 6c6f 203e 207e   "echo hello > ~
+000073e0: 2f75 7365 725f 6669 6c65 2e74 7874 2227  /user_file.txt"'
+000073f0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00007400: 736b 7920 6c61 756e 6368 202d 2d63 6c6f  sky launch --clo
+00007410: 6e65 2d64 6973 6b2d 6672 6f6d 207b 6e61  ne-disk-from {na
+00007420: 6d65 7d20 2d79 202d 6320 7b6e 616d 657d  me} -y -c {name}
+00007430: 2d63 6c6f 6e65 2026 2620 6578 6974 2031  -clone && exit 1
+00007440: 207c 7c20 7472 7565 272c 0a20 2020 2020   || true',.     
+00007450: 2020 2020 2020 2066 2773 6b79 2073 746f         f'sky sto
+00007460: 7020 7b6e 616d 657d 202d 7927 2c0a 2020  p {name} -y',.  
+00007470: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+00007480: 2036 3027 2c0a 2020 2020 2020 2020 2020   60',.          
+00007490: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+000074a0: 2d63 6c6f 6e65 2d64 6973 6b2d 6672 6f6d  -clone-disk-from
+000074b0: 207b 6e61 6d65 7d20 2d79 202d 6320 7b6e   {name} -y -c {n
+000074c0: 616d 657d 2d63 6c6f 6e65 202d 2d63 6c6f  ame}-clone --clo
+000074d0: 7564 2061 7773 202d 6420 2d2d 7265 6769  ud aws -d --regi
+000074e0: 6f6e 2075 732d 6561 7374 2d32 2022 6361  on us-east-2 "ca
+000074f0: 7420 7e2f 7573 6572 5f66 696c 652e 7478  t ~/user_file.tx
+00007500: 7420 7c20 6772 6570 2068 656c 6c6f 2227  t | grep hello"'
+00007510: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00007520: 736b 7920 6c61 756e 6368 202d 2d63 6c6f  sky launch --clo
+00007530: 6e65 2d64 6973 6b2d 6672 6f6d 207b 6e61  ne-disk-from {na
+00007540: 6d65 7d20 2d79 202d 6320 7b6e 616d 657d  me} -y -c {name}
+00007550: 2d63 6c6f 6e65 2d32 202d 2d63 6c6f 7564  -clone-2 --cloud
+00007560: 2061 7773 202d 6420 2d2d 7265 6769 6f6e   aws -d --region
+00007570: 2075 732d 6561 7374 2d32 2022 6361 7420   us-east-2 "cat 
+00007580: 7e2f 7573 6572 5f66 696c 652e 7478 7420  ~/user_file.txt 
+00007590: 7c20 6772 6570 2068 656c 6c6f 2227 2c0a  | grep hello"',.
+000075a0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+000075b0: 7920 6c6f 6773 207b 6e61 6d65 7d2d 636c  y logs {name}-cl
+000075c0: 6f6e 6520 3120 2d2d 7374 6174 7573 272c  one 1 --status',
+000075d0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000075e0: 6b79 206c 6f67 7320 7b6e 616d 657d 2d63  ky logs {name}-c
+000075f0: 6c6f 6e65 2d32 2031 202d 2d73 7461 7475  lone-2 1 --statu
+00007600: 7327 2c0a 2020 2020 2020 2020 5d2c 0a20  s',.        ],. 
+00007610: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
+00007620: 6e20 2d79 207b 6e61 6d65 7d20 7b6e 616d  n -y {name} {nam
+00007630: 657d 2d63 6c6f 6e65 207b 6e61 6d65 7d2d  e}-clone {name}-
+00007640: 636c 6f6e 652d 3227 2c0a 2020 2020 2020  clone-2',.      
+00007650: 2020 7469 6d65 6f75 743d 3330 202a 2036    timeout=30 * 6
+00007660: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
+00007670: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+00007680: 0a0a 4070 7974 6573 742e 6d61 726b 2e67  ..@pytest.mark.g
+00007690: 6370 0a64 6566 2074 6573 745f 636c 6f6e  cp.def test_clon
+000076a0: 655f 6469 736b 5f67 6370 2829 3a0a 2020  e_disk_gcp():.  
+000076b0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+000076c0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+000076d0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+000076e0: 2020 2020 2020 2763 6c6f 6e65 5f64 6973        'clone_dis
+000076f0: 6b5f 6763 7027 2c0a 2020 2020 2020 2020  k_gcp',.        
+00007700: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+00007710: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+00007720: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+00007730: 6763 7020 2d2d 7a6f 6e65 2075 732d 6561  gcp --zone us-ea
+00007740: 7374 312d 6220 2d2d 7265 7472 792d 756e  st1-b --retry-un
+00007750: 7469 6c2d 7570 2022 6563 686f 2068 656c  til-up "echo hel
+00007760: 6c6f 203e 207e 2f75 7365 725f 6669 6c65  lo > ~/user_file
+00007770: 2e74 7874 2227 2c0a 2020 2020 2020 2020  .txt"',.        
+00007780: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+00007790: 202d 2d63 6c6f 6e65 2d64 6973 6b2d 6672   --clone-disk-fr
+000077a0: 6f6d 207b 6e61 6d65 7d20 2d79 202d 6320  om {name} -y -c 
+000077b0: 7b6e 616d 657d 2d63 6c6f 6e65 2026 2620  {name}-clone && 
+000077c0: 6578 6974 2031 207c 7c20 7472 7565 272c  exit 1 || true',
+000077d0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000077e0: 6b79 2073 746f 7020 7b6e 616d 657d 202d  ky stop {name} -
+000077f0: 7927 2c0a 2020 2020 2020 2020 2020 2020  y',.            
+00007800: 6627 736b 7920 6c61 756e 6368 202d 2d63  f'sky launch --c
+00007810: 6c6f 6e65 2d64 6973 6b2d 6672 6f6d 207b  lone-disk-from {
+00007820: 6e61 6d65 7d20 2d79 202d 6320 7b6e 616d  name} -y -c {nam
+00007830: 657d 2d63 6c6f 6e65 202d 2d63 6c6f 7564  e}-clone --cloud
+00007840: 2067 6370 202d 2d7a 6f6e 6520 7573 2d63   gcp --zone us-c
+00007850: 656e 7472 616c 312d 6120 2263 6174 207e  entral1-a "cat ~
+00007860: 2f75 7365 725f 6669 6c65 2e74 7874 207c  /user_file.txt |
+00007870: 2067 7265 7020 6865 6c6c 6f22 272c 0a20   grep hello"',. 
+00007880: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00007890: 206c 6175 6e63 6820 2d2d 636c 6f6e 652d   launch --clone-
+000078a0: 6469 736b 2d66 726f 6d20 7b6e 616d 657d  disk-from {name}
+000078b0: 202d 7920 2d63 207b 6e61 6d65 7d2d 636c   -y -c {name}-cl
+000078c0: 6f6e 652d 3220 2d2d 636c 6f75 6420 6763  one-2 --cloud gc
+000078d0: 7020 2d2d 7a6f 6e65 2075 732d 6561 7374  p --zone us-east
+000078e0: 312d 6220 2263 6174 207e 2f75 7365 725f  1-b "cat ~/user_
+000078f0: 6669 6c65 2e74 7874 207c 2067 7265 7020  file.txt | grep 
+00007900: 6865 6c6c 6f22 272c 0a20 2020 2020 2020  hello"',.       
+00007910: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00007920: 7b6e 616d 657d 2d63 6c6f 6e65 2031 202d  {name}-clone 1 -
+00007930: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
+00007940: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+00007950: 207b 6e61 6d65 7d2d 636c 6f6e 652d 3220   {name}-clone-2 
+00007960: 3120 2d2d 7374 6174 7573 272c 0a20 2020  1 --status',.   
+00007970: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+00007980: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
+00007990: 616d 657d 207b 6e61 6d65 7d2d 636c 6f6e  ame} {name}-clon
+000079a0: 6520 7b6e 616d 657d 2d63 6c6f 6e65 2d32  e {name}-clone-2
+000079b0: 272c 0a20 2020 2029 0a20 2020 2072 756e  ',.    ).    run
 000079c0: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-000079d0: 0a0a 4070 7974 6573 742e 6d61 726b 2e73  ..@pytest.mark.s
-000079e0: 6370 0a64 6566 2074 6573 745f 7363 705f  cp.def test_scp_
-000079f0: 6669 6c65 5f6d 6f75 6e74 7328 293a 0a20  file_mounts():. 
-00007a00: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-00007a10: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-00007a20: 2020 7465 7374 5f63 6f6d 6d61 6e64 7320    test_commands 
-00007a30: 3d20 5b0a 2020 2020 2020 2020 2a73 746f  = [.        *sto
-00007a40: 7261 6765 5f73 6574 7570 5f63 6f6d 6d61  rage_setup_comma
-00007a50: 6e64 732c 0a20 2020 2020 2020 2066 2773  nds,.        f's
-00007a60: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
-00007a70: 7b6e 616d 657d 207b 5343 505f 5459 5045  {name} {SCP_TYPE
-00007a80: 7d20 2d2d 6e75 6d2d 6e6f 6465 7320 3120  } --num-nodes 1 
-00007a90: 6578 616d 706c 6573 2f75 7369 6e67 5f66  examples/using_f
-00007aa0: 696c 655f 6d6f 756e 7473 2e79 616d 6c27  ile_mounts.yaml'
-00007ab0: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-00007ac0: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
-00007ad0: 7374 6174 7573 272c 2020 2320 456e 7375  status',  # Ensu
-00007ae0: 7265 2074 6865 206a 6f62 2073 7563 6365  re the job succe
-00007af0: 6564 6564 2e0a 2020 2020 5d0a 2020 2020  eded..    ].    
-00007b00: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-00007b10: 2020 2020 2027 5343 505f 7573 696e 675f       'SCP_using_
-00007b20: 6669 6c65 5f6d 6f75 6e74 7327 2c0a 2020  file_mounts',.  
-00007b30: 2020 2020 2020 7465 7374 5f63 6f6d 6d61        test_comma
-00007b40: 6e64 732c 0a20 2020 2020 2020 2066 2773  nds,.        f's
-00007b50: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-00007b60: 7d27 2c0a 2020 2020 2020 2020 7469 6d65  }',.        time
-00007b70: 6f75 743d 3230 202a 2036 302c 2020 2320  out=20 * 60,  # 
-00007b80: 3230 206d 696e 730a 2020 2020 290a 2020  20 mins.    ).  
-00007b90: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-00007ba0: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
-00007bb0: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
-00007bc0: 6b20 2023 2052 6571 7569 7265 7320 4743  k  # Requires GC
-00007bd0: 5020 746f 2062 6520 656e 6162 6c65 640a  P to be enabled.
-00007be0: 6465 6620 7465 7374 5f75 7369 6e67 5f66  def test_using_f
-00007bf0: 696c 655f 6d6f 756e 7473 5f77 6974 685f  ile_mounts_with_
-00007c00: 656e 765f 7661 7273 2867 656e 6572 6963  env_vars(generic
-00007c10: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
-00007c20: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-00007c30: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-00007c40: 2073 746f 7261 6765 5f6e 616d 6520 3d20   storage_name = 
-00007c50: 5465 7374 5374 6f72 6167 6557 6974 6843  TestStorageWithC
-00007c60: 7265 6465 6e74 6961 6c73 2e67 656e 6572  redentials.gener
-00007c70: 6174 655f 6275 636b 6574 5f6e 616d 6528  ate_bucket_name(
-00007c80: 290a 2020 2020 7465 7374 5f63 6f6d 6d61  ).    test_comma
-00007c90: 6e64 7320 3d20 5b0a 2020 2020 2020 2020  nds = [.        
-00007ca0: 2a73 746f 7261 6765 5f73 6574 7570 5f63  *storage_setup_c
-00007cb0: 6f6d 6d61 6e64 732c 0a20 2020 2020 2020  ommands,.       
-00007cc0: 2028 6627 736b 7920 6c61 756e 6368 202d   (f'sky launch -
-00007cd0: 7920 2d63 207b 6e61 6d65 7d20 2d2d 6370  y -c {name} --cp
-00007ce0: 7573 2032 2b20 2d2d 636c 6f75 6420 7b67  us 2+ --cloud {g
-00007cf0: 656e 6572 6963 5f63 6c6f 7564 7d20 270a  eneric_cloud} '.
-00007d00: 2020 2020 2020 2020 2027 6578 616d 706c           'exampl
-00007d10: 6573 2f75 7369 6e67 5f66 696c 655f 6d6f  es/using_file_mo
-00007d20: 756e 7473 5f77 6974 685f 656e 765f 7661  unts_with_env_va
-00007d30: 7273 2e79 616d 6c20 270a 2020 2020 2020  rs.yaml '.      
-00007d40: 2020 2066 272d 2d65 6e76 204d 595f 4255     f'--env MY_BU
-00007d50: 434b 4554 3d7b 7374 6f72 6167 655f 6e61  CKET={storage_na
-00007d60: 6d65 7d27 292c 0a20 2020 2020 2020 2066  me}'),.        f
-00007d70: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00007d80: 2031 202d 2d73 7461 7475 7327 2c20 2023   1 --status',  #
-00007d90: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
-00007da0: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
-00007db0: 2020 2023 204f 7665 7272 6964 6520 7769     # Override wi
-00007dc0: 7468 202d 2d65 6e76 3a0a 2020 2020 2020  th --env:.      
-00007dd0: 2020 2866 2773 6b79 206c 6175 6e63 6820    (f'sky launch 
-00007de0: 2d79 202d 6320 7b6e 616d 657d 2d32 202d  -y -c {name}-2 -
-00007df0: 2d63 7075 7320 322b 202d 2d63 6c6f 7564  -cpus 2+ --cloud
-00007e00: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
-00007e10: 2027 0a20 2020 2020 2020 2020 2765 7861   '.         'exa
-00007e20: 6d70 6c65 732f 7573 696e 675f 6669 6c65  mples/using_file
-00007e30: 5f6d 6f75 6e74 735f 7769 7468 5f65 6e76  _mounts_with_env
-00007e40: 5f76 6172 732e 7961 6d6c 2027 0a20 2020  _vars.yaml '.   
-00007e50: 2020 2020 2020 6627 2d2d 656e 7620 4d59        f'--env MY
-00007e60: 5f42 5543 4b45 543d 7b73 746f 7261 6765  _BUCKET={storage
-00007e70: 5f6e 616d 657d 2027 0a20 2020 2020 2020  _name} '.       
-00007e80: 2020 272d 2d65 6e76 204d 595f 4c4f 4341    '--env MY_LOCA
-00007e90: 4c5f 5041 5448 3d74 6d70 6669 6c65 2729  L_PATH=tmpfile')
-00007ea0: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-00007eb0: 6c6f 6773 207b 6e61 6d65 7d2d 3220 3120  logs {name}-2 1 
-00007ec0: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
-00007ed0: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
-00007ee0: 6365 6564 6564 2e0a 2020 2020 5d0a 2020  ceeded..    ].  
-00007ef0: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-00007f00: 2020 2020 2020 2027 7573 696e 675f 6669         'using_fi
-00007f10: 6c65 5f6d 6f75 6e74 735f 7769 7468 5f65  le_mounts_with_e
-00007f20: 6e76 5f76 6172 7327 2c0a 2020 2020 2020  nv_vars',.      
-00007f30: 2020 7465 7374 5f63 6f6d 6d61 6e64 732c    test_commands,
-00007f40: 0a20 2020 2020 2020 2028 6627 736b 7920  .        (f'sky 
-00007f50: 646f 776e 202d 7920 7b6e 616d 657d 207b  down -y {name} {
-00007f60: 6e61 6d65 7d2d 3227 2c0a 2020 2020 2020  name}-2',.      
-00007f70: 2020 2066 2773 6b79 2073 746f 7261 6765     f'sky storage
-00007f80: 2064 656c 6574 6520 2d79 207b 7374 6f72   delete -y {stor
-00007f90: 6167 655f 6e61 6d65 7d20 7b73 746f 7261  age_name} {stora
-00007fa0: 6765 5f6e 616d 657d 2d32 2729 2c0a 2020  ge_name}-2'),.  
-00007fb0: 2020 2020 2020 7469 6d65 6f75 743d 3230        timeout=20
-00007fc0: 202a 2036 302c 2020 2320 3230 206d 696e   * 60,  # 20 min
-00007fd0: 730a 2020 2020 290a 2020 2020 7275 6e5f  s.    ).    run_
-00007fe0: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-00007ff0: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 7374  .# ---------- st
-00008000: 6f72 6167 6520 2d2d 2d2d 2d2d 2d2d 2d2d  orage ----------
-00008010: 0a40 7079 7465 7374 2e6d 6172 6b2e 6177  .@pytest.mark.aw
-00008020: 730a 6465 6620 7465 7374 5f61 7773 5f73  s.def test_aws_s
-00008030: 746f 7261 6765 5f6d 6f75 6e74 735f 7769  torage_mounts_wi
-00008040: 7468 5f73 746f 7028 293a 0a20 2020 206e  th_stop():.    n
-00008050: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-00008060: 6572 5f6e 616d 6528 290a 2020 2020 7374  er_name().    st
-00008070: 6f72 6167 655f 6e61 6d65 203d 2066 2773  orage_name = f's
-00008080: 6b79 2d74 6573 742d 7b69 6e74 2874 696d  ky-test-{int(tim
-00008090: 652e 7469 6d65 2829 297d 270a 2020 2020  e.time())}'.    
-000080a0: 7465 6d70 6c61 7465 5f73 7472 203d 2070  template_str = p
-000080b0: 6174 686c 6962 2e50 6174 6828 0a20 2020  athlib.Path(.   
-000080c0: 2020 2020 2027 7465 7374 732f 7465 7374       'tests/test
-000080d0: 5f79 616d 6c73 2f74 6573 745f 7374 6f72  _yamls/test_stor
-000080e0: 6167 655f 6d6f 756e 7469 6e67 2e79 616d  age_mounting.yam
-000080f0: 6c2e 6a32 2729 2e72 6561 645f 7465 7874  l.j2').read_text
-00008100: 2829 0a20 2020 2074 656d 706c 6174 6520  ().    template 
-00008110: 3d20 6a69 6e6a 6132 2e54 656d 706c 6174  = jinja2.Templat
-00008120: 6528 7465 6d70 6c61 7465 5f73 7472 290a  e(template_str).
-00008130: 2020 2020 636f 6e74 656e 7420 3d20 7465      content = te
-00008140: 6d70 6c61 7465 2e72 656e 6465 7228 7374  mplate.render(st
-00008150: 6f72 6167 655f 6e61 6d65 3d73 746f 7261  orage_name=stora
-00008160: 6765 5f6e 616d 6529 0a20 2020 2077 6974  ge_name).    wit
-00008170: 6820 7465 6d70 6669 6c65 2e4e 616d 6564  h tempfile.Named
-00008180: 5465 6d70 6f72 6172 7946 696c 6528 7375  TemporaryFile(su
-00008190: 6666 6978 3d27 2e79 616d 6c27 2c20 6d6f  ffix='.yaml', mo
-000081a0: 6465 3d27 7727 2920 6173 2066 3a0a 2020  de='w') as f:.  
-000081b0: 2020 2020 2020 662e 7772 6974 6528 636f        f.write(co
-000081c0: 6e74 656e 7429 0a20 2020 2020 2020 2066  ntent).        f
-000081d0: 2e66 6c75 7368 2829 0a20 2020 2020 2020  .flush().       
-000081e0: 2066 696c 655f 7061 7468 203d 2066 2e6e   file_path = f.n
-000081f0: 616d 650a 2020 2020 2020 2020 7465 7374  ame.        test
-00008200: 5f63 6f6d 6d61 6e64 7320 3d20 5b0a 2020  _commands = [.  
-00008210: 2020 2020 2020 2020 2020 2a73 746f 7261            *stora
-00008220: 6765 5f73 6574 7570 5f63 6f6d 6d61 6e64  ge_setup_command
-00008230: 732c 0a20 2020 2020 2020 2020 2020 2066  s,.            f
-00008240: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-00008250: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
-00008260: 2061 7773 207b 6669 6c65 5f70 6174 687d   aws {file_path}
-00008270: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00008280: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00008290: 2031 202d 2d73 7461 7475 7327 2c20 2023   1 --status',  #
-000082a0: 2045 6e73 7572 6520 6a6f 6220 7375 6363   Ensure job succ
-000082b0: 6565 6465 642e 0a20 2020 2020 2020 2020  eeded..         
-000082c0: 2020 2066 2761 7773 2073 3320 6c73 207b     f'aws s3 ls {
-000082d0: 7374 6f72 6167 655f 6e61 6d65 7d2f 6865  storage_name}/he
-000082e0: 6c6c 6f2e 7478 7427 2c0a 2020 2020 2020  llo.txt',.      
-000082f0: 2020 2020 2020 6627 736b 7920 7374 6f70        f'sky stop
-00008300: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-00008310: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-00008320: 7461 7274 202d 7920 7b6e 616d 657d 272c  tart -y {name}',
-00008330: 0a20 2020 2020 2020 2020 2020 2023 2043  .            # C
-00008340: 6865 636b 2069 6620 6865 6c6c 6f2e 7478  heck if hello.tx
-00008350: 7420 6672 6f6d 206d 6f75 6e74 696e 6720  t from mounting 
-00008360: 6275 636b 6574 2065 7869 7374 7320 6166  bucket exists af
-00008370: 7465 7220 7265 7374 6172 7420 696e 0a20  ter restart in. 
-00008380: 2020 2020 2020 2020 2020 2023 2074 6865             # the
-00008390: 206d 6f75 6e74 6564 2064 6972 6563 746f   mounted directo
-000083a0: 7279 0a20 2020 2020 2020 2020 2020 2066  ry.            f
-000083b0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-000083c0: 202d 2d20 2273 6574 202d 6578 3b20 6c73   -- "set -ex; ls
-000083d0: 202f 6d6f 756e 745f 7072 6976 6174 655f   /mount_private_
-000083e0: 6d6f 756e 742f 6865 6c6c 6f2e 7478 7422  mount/hello.txt"
-000083f0: 270a 2020 2020 2020 2020 5d0a 2020 2020  '.        ].    
-00008400: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-00008410: 0a20 2020 2020 2020 2020 2020 2027 6177  .            'aw
-00008420: 735f 7374 6f72 6167 655f 6d6f 756e 7473  s_storage_mounts
-00008430: 272c 0a20 2020 2020 2020 2020 2020 2074  ',.            t
-00008440: 6573 745f 636f 6d6d 616e 6473 2c0a 2020  est_commands,.  
-00008450: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00008460: 646f 776e 202d 7920 7b6e 616d 657d 3b20  down -y {name}; 
-00008470: 736b 7920 7374 6f72 6167 6520 6465 6c65  sky storage dele
-00008480: 7465 202d 7920 7b73 746f 7261 6765 5f6e  te -y {storage_n
-00008490: 616d 657d 272c 0a20 2020 2020 2020 2020  ame}',.         
-000084a0: 2020 2074 696d 656f 7574 3d32 3020 2a20     timeout=20 * 
-000084b0: 3630 2c20 2023 2032 3020 6d69 6e73 0a20  60,  # 20 mins. 
-000084c0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000084d0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-000084e0: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-000084f0: 726b 2e67 6370 0a64 6566 2074 6573 745f  rk.gcp.def test_
-00008500: 6763 705f 7374 6f72 6167 655f 6d6f 756e  gcp_storage_moun
-00008510: 7473 5f77 6974 685f 7374 6f70 2829 3a0a  ts_with_stop():.
-00008520: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-00008530: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-00008540: 2020 2073 746f 7261 6765 5f6e 616d 6520     storage_name 
-00008550: 3d20 6627 736b 792d 7465 7374 2d7b 696e  = f'sky-test-{in
-00008560: 7428 7469 6d65 2e74 696d 6528 2929 7d27  t(time.time())}'
-00008570: 0a20 2020 2074 656d 706c 6174 655f 7374  .    template_st
-00008580: 7220 3d20 7061 7468 6c69 622e 5061 7468  r = pathlib.Path
-00008590: 280a 2020 2020 2020 2020 2774 6573 7473  (.        'tests
-000085a0: 2f74 6573 745f 7961 6d6c 732f 7465 7374  /test_yamls/test
-000085b0: 5f73 746f 7261 6765 5f6d 6f75 6e74 696e  _storage_mountin
-000085c0: 672e 7961 6d6c 2e6a 3227 292e 7265 6164  g.yaml.j2').read
-000085d0: 5f74 6578 7428 290a 2020 2020 7465 6d70  _text().    temp
-000085e0: 6c61 7465 203d 206a 696e 6a61 322e 5465  late = jinja2.Te
-000085f0: 6d70 6c61 7465 2874 656d 706c 6174 655f  mplate(template_
-00008600: 7374 7229 0a20 2020 2063 6f6e 7465 6e74  str).    content
-00008610: 203d 2074 656d 706c 6174 652e 7265 6e64   = template.rend
-00008620: 6572 2873 746f 7261 6765 5f6e 616d 653d  er(storage_name=
-00008630: 7374 6f72 6167 655f 6e61 6d65 290a 2020  storage_name).  
-00008640: 2020 7769 7468 2074 656d 7066 696c 652e    with tempfile.
-00008650: 4e61 6d65 6454 656d 706f 7261 7279 4669  NamedTemporaryFi
-00008660: 6c65 2873 7566 6669 783d 272e 7961 6d6c  le(suffix='.yaml
-00008670: 272c 206d 6f64 653d 2777 2729 2061 7320  ', mode='w') as 
-00008680: 663a 0a20 2020 2020 2020 2066 2e77 7269  f:.        f.wri
-00008690: 7465 2863 6f6e 7465 6e74 290a 2020 2020  te(content).    
-000086a0: 2020 2020 662e 666c 7573 6828 290a 2020      f.flush().  
-000086b0: 2020 2020 2020 6669 6c65 5f70 6174 6820        file_path 
-000086c0: 3d20 662e 6e61 6d65 0a20 2020 2020 2020  = f.name.       
-000086d0: 2074 6573 745f 636f 6d6d 616e 6473 203d   test_commands =
-000086e0: 205b 0a20 2020 2020 2020 2020 2020 202a   [.            *
-000086f0: 7374 6f72 6167 655f 7365 7475 705f 636f  storage_setup_co
-00008700: 6d6d 616e 6473 2c0a 2020 2020 2020 2020  mmands,.        
-00008710: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-00008720: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
-00008730: 636c 6f75 6420 6763 7020 7b66 696c 655f  cloud gcp {file_
-00008740: 7061 7468 7d27 2c0a 2020 2020 2020 2020  path}',.        
-00008750: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-00008760: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
-00008770: 272c 2020 2320 456e 7375 7265 206a 6f62  ',  # Ensure job
-00008780: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
-00008790: 2020 2020 2020 2020 6627 6773 7574 696c          f'gsutil
-000087a0: 206c 7320 6773 3a2f 2f7b 7374 6f72 6167   ls gs://{storag
-000087b0: 655f 6e61 6d65 7d2f 6865 6c6c 6f2e 7478  e_name}/hello.tx
-000087c0: 7427 2c0a 2020 2020 2020 2020 2020 2020  t',.            
-000087d0: 6627 736b 7920 7374 6f70 202d 7920 7b6e  f'sky stop -y {n
-000087e0: 616d 657d 272c 0a20 2020 2020 2020 2020  ame}',.         
-000087f0: 2020 2066 2773 6b79 2073 7461 7274 202d     f'sky start -
-00008800: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
-00008810: 2020 2020 2020 2023 2043 6865 636b 2069         # Check i
-00008820: 6620 6865 6c6c 6f2e 7478 7420 6672 6f6d  f hello.txt from
-00008830: 206d 6f75 6e74 696e 6720 6275 636b 6574   mounting bucket
-00008840: 2065 7869 7374 7320 6166 7465 7220 7265   exists after re
-00008850: 7374 6172 7420 696e 0a20 2020 2020 2020  start in.       
-00008860: 2020 2020 2023 2074 6865 206d 6f75 6e74       # the mount
-00008870: 6564 2064 6972 6563 746f 7279 0a20 2020  ed directory.   
-00008880: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
-00008890: 7865 6320 7b6e 616d 657d 202d 2d20 2273  xec {name} -- "s
-000088a0: 6574 202d 6578 3b20 6c73 202f 6d6f 756e  et -ex; ls /moun
-000088b0: 745f 7072 6976 6174 655f 6d6f 756e 742f  t_private_mount/
-000088c0: 6865 6c6c 6f2e 7478 7422 270a 2020 2020  hello.txt"'.    
-000088d0: 2020 2020 5d0a 2020 2020 2020 2020 7465      ].        te
-000088e0: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-000088f0: 2020 2020 2020 2027 6763 705f 7374 6f72         'gcp_stor
-00008900: 6167 655f 6d6f 756e 7473 272c 0a20 2020  age_mounts',.   
-00008910: 2020 2020 2020 2020 2074 6573 745f 636f           test_co
-00008920: 6d6d 616e 6473 2c0a 2020 2020 2020 2020  mmands,.        
-00008930: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
-00008940: 7920 7b6e 616d 657d 3b20 736b 7920 7374  y {name}; sky st
-00008950: 6f72 6167 6520 6465 6c65 7465 202d 7920  orage delete -y 
-00008960: 7b73 746f 7261 6765 5f6e 616d 657d 272c  {storage_name}',
-00008970: 0a20 2020 2020 2020 2020 2020 2074 696d  .            tim
-00008980: 656f 7574 3d32 3020 2a20 3630 2c20 2023  eout=20 * 60,  #
-00008990: 2032 3020 6d69 6e73 0a20 2020 2020 2020   20 mins.       
-000089a0: 2029 0a20 2020 2020 2020 2072 756e 5f6f   ).        run_o
-000089b0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-000089c0: 4070 7974 6573 742e 6d61 726b 2e6b 7562  @pytest.mark.kub
-000089d0: 6572 6e65 7465 730a 6465 6620 7465 7374  ernetes.def test
-000089e0: 5f6b 7562 6572 6e65 7465 735f 7374 6f72  _kubernetes_stor
-000089f0: 6167 655f 6d6f 756e 7473 2829 3a0a 2020  age_mounts():.  
-00008a00: 2020 2320 5465 7374 7320 6275 636b 6574    # Tests bucket
-00008a10: 206d 6f75 6e74 696e 6720 6f6e 206b 3873   mounting on k8s
-00008a20: 2c20 6173 7375 6d69 6e67 2053 3320 6973  , assuming S3 is
-00008a30: 2063 6f6e 6669 6775 7265 642e 0a20 2020   configured..   
-00008a40: 2023 2054 6869 7320 7465 7374 2077 696c   # This test wil
-00008a50: 6c20 6661 696c 2069 6620 7275 6e20 6f6e  l fail if run on
-00008a60: 206e 6f6e 2078 3836 5f36 3420 6172 6368   non x86_64 arch
-00008a70: 6974 6563 7475 7265 2c20 7369 6e63 6520  itecture, since 
-00008a80: 676f 6f66 7973 2069 730a 2020 2020 2320  goofys is.    # 
-00008a90: 6275 696c 7420 666f 7220 7838 365f 3634  built for x86_64
-00008aa0: 206f 6e6c 792e 0a20 2020 206e 616d 6520   only..    name 
-00008ab0: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-00008ac0: 616d 6528 290a 2020 2020 7374 6f72 6167  ame().    storag
-00008ad0: 655f 6e61 6d65 203d 2066 2773 6b79 2d74  e_name = f'sky-t
-00008ae0: 6573 742d 7b69 6e74 2874 696d 652e 7469  est-{int(time.ti
-00008af0: 6d65 2829 297d 270a 2020 2020 7465 6d70  me())}'.    temp
-00008b00: 6c61 7465 5f73 7472 203d 2070 6174 686c  late_str = pathl
-00008b10: 6962 2e50 6174 6828 0a20 2020 2020 2020  ib.Path(.       
-00008b20: 2027 7465 7374 732f 7465 7374 5f79 616d   'tests/test_yam
-00008b30: 6c73 2f74 6573 745f 7374 6f72 6167 655f  ls/test_storage_
-00008b40: 6d6f 756e 7469 6e67 2e79 616d 6c2e 6a32  mounting.yaml.j2
-00008b50: 2729 2e72 6561 645f 7465 7874 2829 0a20  ').read_text(). 
-00008b60: 2020 2074 656d 706c 6174 6520 3d20 6a69     template = ji
-00008b70: 6e6a 6132 2e54 656d 706c 6174 6528 7465  nja2.Template(te
-00008b80: 6d70 6c61 7465 5f73 7472 290a 2020 2020  mplate_str).    
-00008b90: 636f 6e74 656e 7420 3d20 7465 6d70 6c61  content = templa
-00008ba0: 7465 2e72 656e 6465 7228 7374 6f72 6167  te.render(storag
-00008bb0: 655f 6e61 6d65 3d73 746f 7261 6765 5f6e  e_name=storage_n
-00008bc0: 616d 6529 0a20 2020 2077 6974 6820 7465  ame).    with te
-00008bd0: 6d70 6669 6c65 2e4e 616d 6564 5465 6d70  mpfile.NamedTemp
-00008be0: 6f72 6172 7946 696c 6528 7375 6666 6978  oraryFile(suffix
-00008bf0: 3d27 2e79 616d 6c27 2c20 6d6f 6465 3d27  ='.yaml', mode='
-00008c00: 7727 2920 6173 2066 3a0a 2020 2020 2020  w') as f:.      
-00008c10: 2020 662e 7772 6974 6528 636f 6e74 656e    f.write(conten
-00008c20: 7429 0a20 2020 2020 2020 2066 2e66 6c75  t).        f.flu
-00008c30: 7368 2829 0a20 2020 2020 2020 2066 696c  sh().        fil
-00008c40: 655f 7061 7468 203d 2066 2e6e 616d 650a  e_path = f.name.
-00008c50: 2020 2020 2020 2020 7465 7374 5f63 6f6d          test_com
-00008c60: 6d61 6e64 7320 3d20 5b0a 2020 2020 2020  mands = [.      
-00008c70: 2020 2020 2020 2a73 746f 7261 6765 5f73        *storage_s
-00008c80: 6574 7570 5f63 6f6d 6d61 6e64 732c 0a20  etup_commands,. 
-00008c90: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00008ca0: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
-00008cb0: 616d 657d 202d 2d63 6c6f 7564 206b 7562  ame} --cloud kub
-00008cc0: 6572 6e65 7465 7320 7b66 696c 655f 7061  ernetes {file_pa
-00008cd0: 7468 7d27 2c0a 2020 2020 2020 2020 2020  th}',.          
-00008ce0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-00008cf0: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
-00008d00: 2020 2320 456e 7375 7265 206a 6f62 2073    # Ensure job s
-00008d10: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
-00008d20: 2020 2020 2020 6627 6177 7320 7333 206c        f'aws s3 l
-00008d30: 7320 7b73 746f 7261 6765 5f6e 616d 657d  s {storage_name}
-00008d40: 2f68 656c 6c6f 2e74 7874 207c 7c20 270a  /hello.txt || '.
-00008d50: 2020 2020 2020 2020 2020 2020 6627 6773              f'gs
-00008d60: 7574 696c 206c 7320 6773 3a2f 2f7b 7374  util ls gs://{st
-00008d70: 6f72 6167 655f 6e61 6d65 7d2f 6865 6c6c  orage_name}/hell
-00008d80: 6f2e 7478 7427 2c0a 2020 2020 2020 2020  o.txt',.        
-00008d90: 5d0a 2020 2020 2020 2020 7465 7374 203d  ].        test =
-00008da0: 2054 6573 7428 0a20 2020 2020 2020 2020   Test(.         
-00008db0: 2020 2027 6b75 6265 726e 6574 6573 5f73     'kubernetes_s
-00008dc0: 746f 7261 6765 5f6d 6f75 6e74 7327 2c0a  torage_mounts',.
-00008dd0: 2020 2020 2020 2020 2020 2020 7465 7374              test
-00008de0: 5f63 6f6d 6d61 6e64 732c 0a20 2020 2020  _commands,.     
-00008df0: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
-00008e00: 6e20 2d79 207b 6e61 6d65 7d3b 2073 6b79  n -y {name}; sky
-00008e10: 2073 746f 7261 6765 2064 656c 6574 6520   storage delete 
-00008e20: 2d79 207b 7374 6f72 6167 655f 6e61 6d65  -y {storage_name
-00008e30: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
-00008e40: 7469 6d65 6f75 743d 3230 202a 2036 302c  timeout=20 * 60,
-00008e50: 2020 2320 3230 206d 696e 730a 2020 2020    # 20 mins.    
-00008e60: 2020 2020 290a 2020 2020 2020 2020 7275      ).        ru
-00008e70: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-00008e80: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-00008e90: 636c 6f75 6466 6c61 7265 0a64 6566 2074  cloudflare.def t
-00008ea0: 6573 745f 636c 6f75 6466 6c61 7265 5f73  est_cloudflare_s
-00008eb0: 746f 7261 6765 5f6d 6f75 6e74 7328 6765  torage_mounts(ge
-00008ec0: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
-00008ed0: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
-00008ee0: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-00008ef0: 290a 2020 2020 7374 6f72 6167 655f 6e61  ).    storage_na
-00008f00: 6d65 203d 2066 2773 6b79 2d74 6573 742d  me = f'sky-test-
-00008f10: 7b69 6e74 2874 696d 652e 7469 6d65 2829  {int(time.time()
-00008f20: 297d 270a 2020 2020 7465 6d70 6c61 7465  )}'.    template
-00008f30: 5f73 7472 203d 2070 6174 686c 6962 2e50  _str = pathlib.P
-00008f40: 6174 6828 0a20 2020 2020 2020 2027 7465  ath(.        'te
-00008f50: 7374 732f 7465 7374 5f79 616d 6c73 2f74  sts/test_yamls/t
-00008f60: 6573 745f 7232 5f73 746f 7261 6765 5f6d  est_r2_storage_m
-00008f70: 6f75 6e74 696e 672e 7961 6d6c 2729 2e72  ounting.yaml').r
-00008f80: 6561 645f 7465 7874 2829 0a20 2020 2074  ead_text().    t
-00008f90: 656d 706c 6174 6520 3d20 6a69 6e6a 6132  emplate = jinja2
-00008fa0: 2e54 656d 706c 6174 6528 7465 6d70 6c61  .Template(templa
-00008fb0: 7465 5f73 7472 290a 2020 2020 636f 6e74  te_str).    cont
-00008fc0: 656e 7420 3d20 7465 6d70 6c61 7465 2e72  ent = template.r
-00008fd0: 656e 6465 7228 7374 6f72 6167 655f 6e61  ender(storage_na
-00008fe0: 6d65 3d73 746f 7261 6765 5f6e 616d 6529  me=storage_name)
-00008ff0: 0a20 2020 2065 6e64 706f 696e 745f 7572  .    endpoint_ur
-00009000: 6c20 3d20 636c 6f75 6466 6c61 7265 2e63  l = cloudflare.c
-00009010: 7265 6174 655f 656e 6470 6f69 6e74 2829  reate_endpoint()
-00009020: 0a20 2020 2077 6974 6820 7465 6d70 6669  .    with tempfi
-00009030: 6c65 2e4e 616d 6564 5465 6d70 6f72 6172  le.NamedTemporar
-00009040: 7946 696c 6528 7375 6666 6978 3d27 2e79  yFile(suffix='.y
-00009050: 616d 6c27 2c20 6d6f 6465 3d27 7727 2920  aml', mode='w') 
-00009060: 6173 2066 3a0a 2020 2020 2020 2020 662e  as f:.        f.
-00009070: 7772 6974 6528 636f 6e74 656e 7429 0a20  write(content). 
-00009080: 2020 2020 2020 2066 2e66 6c75 7368 2829         f.flush()
-00009090: 0a20 2020 2020 2020 2066 696c 655f 7061  .        file_pa
-000090a0: 7468 203d 2066 2e6e 616d 650a 2020 2020  th = f.name.    
-000090b0: 2020 2020 7465 7374 5f63 6f6d 6d61 6e64      test_command
-000090c0: 7320 3d20 5b0a 2020 2020 2020 2020 2020  s = [.          
-000090d0: 2020 2a73 746f 7261 6765 5f73 6574 7570    *storage_setup
-000090e0: 5f63 6f6d 6d61 6e64 732c 0a20 2020 2020  _commands,.     
-000090f0: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-00009100: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
-00009110: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
-00009120: 635f 636c 6f75 647d 207b 6669 6c65 5f70  c_cloud} {file_p
-00009130: 6174 687d 272c 0a20 2020 2020 2020 2020  ath}',.         
-00009140: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-00009150: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
-00009160: 2c20 2023 2045 6e73 7572 6520 6a6f 6220  ,  # Ensure job 
-00009170: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
-00009180: 2020 2020 2020 2066 2741 5753 5f53 4841         f'AWS_SHA
-00009190: 5245 445f 4352 4544 454e 5449 414c 535f  RED_CREDENTIALS_
-000091a0: 4649 4c45 3d7b 636c 6f75 6466 6c61 7265  FILE={cloudflare
-000091b0: 2e52 325f 4352 4544 454e 5449 414c 535f  .R2_CREDENTIALS_
-000091c0: 5041 5448 7d20 6177 7320 7333 206c 7320  PATH} aws s3 ls 
-000091d0: 7333 3a2f 2f7b 7374 6f72 6167 655f 6e61  s3://{storage_na
-000091e0: 6d65 7d2f 6865 6c6c 6f2e 7478 7420 2d2d  me}/hello.txt --
-000091f0: 656e 6470 6f69 6e74 207b 656e 6470 6f69  endpoint {endpoi
-00009200: 6e74 5f75 726c 7d20 2d2d 7072 6f66 696c  nt_url} --profil
-00009210: 653d 7232 270a 2020 2020 2020 2020 5d0a  e=r2'.        ].
-00009220: 0a20 2020 2020 2020 2074 6573 7420 3d20  .        test = 
-00009230: 5465 7374 280a 2020 2020 2020 2020 2020  Test(.          
-00009240: 2020 2763 6c6f 7564 666c 6172 655f 7374    'cloudflare_st
-00009250: 6f72 6167 655f 6d6f 756e 7473 272c 0a20  orage_mounts',. 
-00009260: 2020 2020 2020 2020 2020 2074 6573 745f             test_
-00009270: 636f 6d6d 616e 6473 2c0a 2020 2020 2020  commands,.      
-00009280: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-00009290: 202d 7920 7b6e 616d 657d 3b20 736b 7920   -y {name}; sky 
-000092a0: 7374 6f72 6167 6520 6465 6c65 7465 202d  storage delete -
-000092b0: 7920 7b73 746f 7261 6765 5f6e 616d 657d  y {storage_name}
-000092c0: 272c 0a20 2020 2020 2020 2020 2020 2074  ',.            t
-000092d0: 696d 656f 7574 3d32 3020 2a20 3630 2c20  imeout=20 * 60, 
-000092e0: 2023 2032 3020 6d69 6e73 0a20 2020 2020   # 20 mins.     
-000092f0: 2020 2029 0a20 2020 2020 2020 2072 756e     ).        run
-00009300: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-00009310: 0a0a 4070 7974 6573 742e 6d61 726b 2e69  ..@pytest.mark.i
-00009320: 626d 0a64 6566 2074 6573 745f 6962 6d5f  bm.def test_ibm_
-00009330: 7374 6f72 6167 655f 6d6f 756e 7473 2829  storage_mounts()
-00009340: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
-00009350: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
-00009360: 0a20 2020 2073 746f 7261 6765 5f6e 616d  .    storage_nam
-00009370: 6520 3d20 6627 736b 792d 7465 7374 2d7b  e = f'sky-test-{
-00009380: 696e 7428 7469 6d65 2e74 696d 6528 2929  int(time.time())
-00009390: 7d27 0a20 2020 2062 7563 6b65 745f 7263  }'.    bucket_rc
-000093a0: 6c6f 6e65 5f70 726f 6669 6c65 203d 2052  lone_profile = R
-000093b0: 636c 6f6e 652e 6765 6e65 7261 7465 5f72  clone.generate_r
-000093c0: 636c 6f6e 655f 6275 636b 6574 5f70 726f  clone_bucket_pro
-000093d0: 6669 6c65 5f6e 616d 6528 0a20 2020 2020  file_name(.     
-000093e0: 2020 2073 746f 7261 6765 5f6e 616d 652c     storage_name,
-000093f0: 2052 636c 6f6e 652e 5263 6c6f 6e65 436c   Rclone.RcloneCl
-00009400: 6f75 6473 2e49 424d 290a 2020 2020 7465  ouds.IBM).    te
-00009410: 6d70 6c61 7465 5f73 7472 203d 2070 6174  mplate_str = pat
-00009420: 686c 6962 2e50 6174 6828 0a20 2020 2020  hlib.Path(.     
-00009430: 2020 2027 7465 7374 732f 7465 7374 5f79     'tests/test_y
-00009440: 616d 6c73 2f74 6573 745f 6962 6d5f 636f  amls/test_ibm_co
-00009450: 735f 7374 6f72 6167 655f 6d6f 756e 7469  s_storage_mounti
-00009460: 6e67 2e79 616d 6c27 292e 7265 6164 5f74  ng.yaml').read_t
-00009470: 6578 7428 290a 2020 2020 7465 6d70 6c61  ext().    templa
-00009480: 7465 203d 206a 696e 6a61 322e 5465 6d70  te = jinja2.Temp
-00009490: 6c61 7465 2874 656d 706c 6174 655f 7374  late(template_st
-000094a0: 7229 0a20 2020 2063 6f6e 7465 6e74 203d  r).    content =
-000094b0: 2074 656d 706c 6174 652e 7265 6e64 6572   template.render
-000094c0: 2873 746f 7261 6765 5f6e 616d 653d 7374  (storage_name=st
-000094d0: 6f72 6167 655f 6e61 6d65 290a 2020 2020  orage_name).    
-000094e0: 7769 7468 2074 656d 7066 696c 652e 4e61  with tempfile.Na
-000094f0: 6d65 6454 656d 706f 7261 7279 4669 6c65  medTemporaryFile
-00009500: 2873 7566 6669 783d 272e 7961 6d6c 272c  (suffix='.yaml',
-00009510: 206d 6f64 653d 2777 2729 2061 7320 663a   mode='w') as f:
-00009520: 0a20 2020 2020 2020 2066 2e77 7269 7465  .        f.write
-00009530: 2863 6f6e 7465 6e74 290a 2020 2020 2020  (content).      
-00009540: 2020 662e 666c 7573 6828 290a 2020 2020    f.flush().    
-00009550: 2020 2020 6669 6c65 5f70 6174 6820 3d20      file_path = 
-00009560: 662e 6e61 6d65 0a20 2020 2020 2020 2074  f.name.        t
-00009570: 6573 745f 636f 6d6d 616e 6473 203d 205b  est_commands = [
-00009580: 0a20 2020 2020 2020 2020 2020 202a 7374  .            *st
-00009590: 6f72 6167 655f 7365 7475 705f 636f 6d6d  orage_setup_comm
-000095a0: 616e 6473 2c0a 2020 2020 2020 2020 2020  ands,.          
-000095b0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-000095c0: 7920 2d63 207b 6e61 6d65 7d20 2d2d 636c  y -c {name} --cl
-000095d0: 6f75 6420 6962 6d20 7b66 696c 655f 7061  oud ibm {file_pa
-000095e0: 7468 7d27 2c0a 2020 2020 2020 2020 2020  th}',.          
-000095f0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-00009600: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
-00009610: 2020 2320 456e 7375 7265 206a 6f62 2073    # Ensure job s
-00009620: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
-00009630: 2020 2020 2020 6627 7263 6c6f 6e65 206c        f'rclone l
-00009640: 7320 7b62 7563 6b65 745f 7263 6c6f 6e65  s {bucket_rclone
-00009650: 5f70 726f 6669 6c65 7d3a 7b73 746f 7261  _profile}:{stora
-00009660: 6765 5f6e 616d 657d 2f68 656c 6c6f 2e74  ge_name}/hello.t
-00009670: 7874 272c 0a20 2020 2020 2020 205d 0a20  xt',.        ]. 
-00009680: 2020 2020 2020 2074 6573 7420 3d20 5465         test = Te
-00009690: 7374 280a 2020 2020 2020 2020 2020 2020  st(.            
-000096a0: 2769 626d 5f73 746f 7261 6765 5f6d 6f75  'ibm_storage_mou
-000096b0: 6e74 7327 2c0a 2020 2020 2020 2020 2020  nts',.          
-000096c0: 2020 7465 7374 5f63 6f6d 6d61 6e64 732c    test_commands,
-000096d0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-000096e0: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-000096f0: 7d3b 2073 6b79 2073 746f 7261 6765 2064  }; sky storage d
-00009700: 656c 6574 6520 2d79 207b 7374 6f72 6167  elete -y {storag
-00009710: 655f 6e61 6d65 7d27 2c0a 2020 2020 2020  e_name}',.      
-00009720: 2020 2020 2020 7469 6d65 6f75 743d 3230        timeout=20
-00009730: 202a 2036 302c 2020 2320 3230 206d 696e   * 60,  # 20 min
-00009740: 730a 2020 2020 2020 2020 290a 2020 2020  s.        ).    
-00009750: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-00009760: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
-00009770: 2d2d 2d2d 2d20 434c 4920 6c6f 6773 202d  ----- CLI logs -
-00009780: 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974 6573  ---------.@pytes
-00009790: 742e 6d61 726b 2e6e 6f5f 7363 7020 2023  t.mark.no_scp  #
-000097a0: 2053 4350 2064 6f65 7320 6e6f 7420 7375   SCP does not su
-000097b0: 7070 6f72 7420 6e75 6d5f 6e6f 6465 7320  pport num_nodes 
-000097c0: 3e20 3120 7965 742e 2052 756e 2074 6573  > 1 yet. Run tes
-000097d0: 745f 7363 705f 6c6f 6773 2069 6e73 7465  t_scp_logs inste
-000097e0: 6164 2e0a 6465 6620 7465 7374 5f63 6c69  ad..def test_cli
-000097f0: 5f6c 6f67 7328 6765 6e65 7269 635f 636c  _logs(generic_cl
-00009800: 6f75 643a 2073 7472 293a 0a20 2020 206e  oud: str):.    n
-00009810: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-00009820: 6572 5f6e 616d 6528 290a 2020 2020 6e75  er_name().    nu
-00009830: 6d5f 6e6f 6465 7320 3d20 320a 2020 2020  m_nodes = 2.    
-00009840: 6966 2067 656e 6572 6963 5f63 6c6f 7564  if generic_cloud
-00009850: 203d 3d20 276b 7562 6572 6e65 7465 7327   == 'kubernetes'
-00009860: 3a0a 2020 2020 2020 2020 2320 4b75 6265  :.        # Kube
-00009870: 726e 6574 6573 2064 6f65 7320 6e6f 7420  rnetes does not 
-00009880: 7375 7070 6f72 7420 6d75 6c74 692d 6e6f  support multi-no
-00009890: 6465 0a20 2020 2020 2020 206e 756d 5f6e  de.        num_n
-000098a0: 6f64 6573 203d 2031 0a20 2020 2074 696d  odes = 1.    tim
-000098b0: 6573 7461 6d70 203d 2074 696d 652e 7469  estamp = time.ti
-000098c0: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-000098d0: 5465 7374 2827 636c 695f 6c6f 6773 272c  Test('cli_logs',
-000098e0: 205b 0a20 2020 2020 2020 2066 2773 6b79   [.        f'sky
-000098f0: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
-00009900: 616d 657d 202d 2d63 6c6f 7564 207b 6765  ame} --cloud {ge
-00009910: 6e65 7269 635f 636c 6f75 647d 202d 2d6e  neric_cloud} --n
-00009920: 756d 2d6e 6f64 6573 207b 6e75 6d5f 6e6f  um-nodes {num_no
-00009930: 6465 737d 2022 6563 686f 207b 7469 6d65  des} "echo {time
-00009940: 7374 616d 707d 2031 2227 2c0a 2020 2020  stamp} 1"',.    
-00009950: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-00009960: 6e61 6d65 7d20 2265 6368 6f20 7b74 696d  name} "echo {tim
-00009970: 6573 7461 6d70 7d20 3222 272c 0a20 2020  estamp} 2"',.   
-00009980: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-00009990: 7b6e 616d 657d 2022 6563 686f 207b 7469  {name} "echo {ti
-000099a0: 6d65 7374 616d 707d 2033 2227 2c0a 2020  mestamp} 3"',.  
-000099b0: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
-000099c0: 207b 6e61 6d65 7d20 2265 6368 6f20 7b74   {name} "echo {t
-000099d0: 696d 6573 7461 6d70 7d20 3422 272c 0a20  imestamp} 4"',. 
-000099e0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-000099f0: 7320 7b6e 616d 657d 2032 202d 2d73 7461  s {name} 2 --sta
-00009a00: 7475 7327 2c0a 2020 2020 2020 2020 6627  tus',.        f'
-00009a10: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-00009a20: 3320 3420 2d2d 7379 6e63 2d64 6f77 6e27  3 4 --sync-down'
-00009a30: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-00009a40: 6c6f 6773 207b 6e61 6d65 7d20 2a20 2d2d  logs {name} * --
-00009a50: 7379 6e63 2d64 6f77 6e27 2c0a 2020 2020  sync-down',.    
-00009a60: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-00009a70: 6e61 6d65 7d20 3120 7c20 6772 6570 2022  name} 1 | grep "
-00009a80: 7b74 696d 6573 7461 6d70 7d20 3122 272c  {timestamp} 1"',
-00009a90: 0a20 2020 2020 2020 2066 2773 6b79 206c  .        f'sky l
-00009aa0: 6f67 7320 7b6e 616d 657d 207c 2067 7265  ogs {name} | gre
-00009ab0: 7020 227b 7469 6d65 7374 616d 707d 2034  p "{timestamp} 4
-00009ac0: 2227 2c0a 2020 2020 5d2c 2066 2773 6b79  "',.    ], f'sky
-00009ad0: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-00009ae0: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-00009af0: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
-00009b00: 7374 2e6d 6172 6b2e 7363 700a 6465 6620  st.mark.scp.def 
-00009b10: 7465 7374 5f73 6370 5f6c 6f67 7328 293a  test_scp_logs():
-00009b20: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-00009b30: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-00009b40: 2020 2020 7469 6d65 7374 616d 7020 3d20      timestamp = 
-00009b50: 7469 6d65 2e74 696d 6528 290a 2020 2020  time.time().    
-00009b60: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-00009b70: 2020 2020 2027 5343 505f 636c 695f 6c6f       'SCP_cli_lo
-00009b80: 6773 272c 0a20 2020 2020 2020 205b 0a20  gs',.        [. 
-00009b90: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00009ba0: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
-00009bb0: 616d 657d 207b 5343 505f 5459 5045 7d20  ame} {SCP_TYPE} 
-00009bc0: 2265 6368 6f20 7b74 696d 6573 7461 6d70  "echo {timestamp
-00009bd0: 7d20 3122 272c 0a20 2020 2020 2020 2020  } 1"',.         
-00009be0: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-00009bf0: 616d 657d 2022 6563 686f 207b 7469 6d65  ame} "echo {time
-00009c00: 7374 616d 707d 2032 2227 2c0a 2020 2020  stamp} 2"',.    
-00009c10: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-00009c20: 6563 207b 6e61 6d65 7d20 2265 6368 6f20  ec {name} "echo 
-00009c30: 7b74 696d 6573 7461 6d70 7d20 3322 272c  {timestamp} 3"',
-00009c40: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00009c50: 6b79 2065 7865 6320 7b6e 616d 657d 2022  ky exec {name} "
-00009c60: 6563 686f 207b 7469 6d65 7374 616d 707d  echo {timestamp}
-00009c70: 2034 2227 2c0a 2020 2020 2020 2020 2020   4"',.          
-00009c80: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-00009c90: 6d65 7d20 3220 2d2d 7374 6174 7573 272c  me} 2 --status',
-00009ca0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00009cb0: 6b79 206c 6f67 7320 7b6e 616d 657d 2033  ky logs {name} 3
-00009cc0: 2034 202d 2d73 796e 632d 646f 776e 272c   4 --sync-down',
-00009cd0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00009ce0: 6b79 206c 6f67 7320 7b6e 616d 657d 202a  ky logs {name} *
-00009cf0: 202d 2d73 796e 632d 646f 776e 272c 0a20   --sync-down',. 
-00009d00: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00009d10: 206c 6f67 7320 7b6e 616d 657d 2031 207c   logs {name} 1 |
-00009d20: 2067 7265 7020 227b 7469 6d65 7374 616d   grep "{timestam
-00009d30: 707d 2031 2227 2c0a 2020 2020 2020 2020  p} 1"',.        
-00009d40: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-00009d50: 6e61 6d65 7d20 7c20 6772 6570 2022 7b74  name} | grep "{t
-00009d60: 696d 6573 7461 6d70 7d20 3422 272c 0a20  imestamp} 4"',. 
-00009d70: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00009d80: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-00009d90: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
-00009da0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00009db0: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
-00009dc0: 2d2d 2d2d 204a 6f62 2051 7565 7565 2e20  ---- Job Queue. 
-00009dd0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
-00009de0: 7374 2e6d 6172 6b2e 6e6f 5f66 6c75 6964  st.mark.no_fluid
-00009df0: 7374 6163 6b20 2023 2046 6c75 6964 5374  stack  # FluidSt
-00009e00: 6163 6b20 4443 2068 6173 206c 6f77 2061  ack DC has low a
-00009e10: 7661 696c 6162 696c 6974 7920 6f66 2054  vailability of T
-00009e20: 3420 4750 5573 0a40 7079 7465 7374 2e6d  4 GPUs.@pytest.m
-00009e30: 6172 6b2e 6e6f 5f6c 616d 6264 615f 636c  ark.no_lambda_cl
-00009e40: 6f75 6420 2023 204c 616d 6264 6120 436c  oud  # Lambda Cl
-00009e50: 6f75 6420 646f 6573 206e 6f74 2068 6176  oud does not hav
-00009e60: 6520 5434 2067 7075 730a 4070 7974 6573  e T4 gpus.@pytes
-00009e70: 742e 6d61 726b 2e6e 6f5f 6962 6d20 2023  t.mark.no_ibm  #
-00009e80: 2049 424d 2043 6c6f 7564 2064 6f65 7320   IBM Cloud does 
-00009e90: 6e6f 7420 6861 7665 2054 3420 6770 7573  not have T4 gpus
-00009ea0: 2e20 7275 6e20 7465 7374 5f69 626d 5f6a  . run test_ibm_j
-00009eb0: 6f62 5f71 7565 7565 2069 6e73 7465 6164  ob_queue instead
-00009ec0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-00009ed0: 5f73 6370 2020 2320 5343 5020 646f 6573  _scp  # SCP does
-00009ee0: 206e 6f74 2068 6176 6520 5434 2067 7075   not have T4 gpu
-00009ef0: 732e 2052 756e 2074 6573 745f 7363 705f  s. Run test_scp_
-00009f00: 6a6f 625f 7175 6575 6520 696e 7374 6561  job_queue instea
-00009f10: 640a 4070 7974 6573 742e 6d61 726b 2e6e  d.@pytest.mark.n
-00009f20: 6f5f 6f63 6920 2023 204f 4349 2064 6f65  o_oci  # OCI doe
-00009f30: 7320 6e6f 7420 6861 7665 2054 3420 6770  s not have T4 gp
-00009f40: 7573 0a64 6566 2074 6573 745f 6a6f 625f  us.def test_job_
-00009f50: 7175 6575 6528 6765 6e65 7269 635f 636c  queue(generic_cl
-00009f60: 6f75 643a 2073 7472 293a 0a20 2020 206e  oud: str):.    n
-00009f70: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-00009f80: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
-00009f90: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-00009fa0: 2020 2027 6a6f 625f 7175 6575 6527 2c0a     'job_queue',.
-00009fb0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-00009fc0: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-00009fd0: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
-00009fe0: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
-00009ff0: 5f63 6c6f 7564 7d20 6578 616d 706c 6573  _cloud} examples
-0000a000: 2f6a 6f62 5f71 7565 7565 2f63 6c75 7374  /job_queue/clust
-0000a010: 6572 2e79 616d 6c27 2c0a 2020 2020 2020  er.yaml',.      
-0000a020: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
-0000a030: 207b 6e61 6d65 7d20 2d6e 207b 6e61 6d65   {name} -n {name
-0000a040: 7d2d 3120 2d64 2065 7861 6d70 6c65 732f  }-1 -d examples/
-0000a050: 6a6f 625f 7175 6575 652f 6a6f 622e 7961  job_queue/job.ya
-0000a060: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-0000a070: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-0000a080: 657d 202d 6e20 7b6e 616d 657d 2d32 202d  e} -n {name}-2 -
-0000a090: 6420 6578 616d 706c 6573 2f6a 6f62 5f71  d examples/job_q
-0000a0a0: 7565 7565 2f6a 6f62 2e79 616d 6c27 2c0a  ueue/job.yaml',.
-0000a0b0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000a0c0: 7920 6578 6563 207b 6e61 6d65 7d20 2d6e  y exec {name} -n
-0000a0d0: 207b 6e61 6d65 7d2d 3320 2d64 2065 7861   {name}-3 -d exa
-0000a0e0: 6d70 6c65 732f 6a6f 625f 7175 6575 652f  mples/job_queue/
-0000a0f0: 6a6f 622e 7961 6d6c 272c 0a20 2020 2020  job.yaml',.     
-0000a100: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
-0000a110: 2071 7565 7565 207b 6e61 6d65 7d29 3b20   queue {name}); 
-0000a120: 6563 686f 2022 2473 223b 2065 6368 6f3b  echo "$s"; echo;
-0000a130: 2065 6368 6f3b 2065 6368 6f20 2224 7322   echo; echo "$s"
-0000a140: 207c 2067 7265 7020 7b6e 616d 657d 2d31   | grep {name}-1
-0000a150: 207c 2067 7265 7020 5255 4e4e 494e 4727   | grep RUNNING'
-0000a160: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000a170: 733d 2428 736b 7920 7175 6575 6520 7b6e  s=$(sky queue {n
-0000a180: 616d 657d 293b 2065 6368 6f20 2224 7322  ame}); echo "$s"
-0000a190: 3b20 6563 686f 3b20 6563 686f 3b20 6563  ; echo; echo; ec
-0000a1a0: 686f 2022 2473 2220 7c20 6772 6570 207b  ho "$s" | grep {
-0000a1b0: 6e61 6d65 7d2d 3220 7c20 6772 6570 2052  name}-2 | grep R
-0000a1c0: 554e 4e49 4e47 272c 0a20 2020 2020 2020  UNNING',.       
-0000a1d0: 2020 2020 2066 2773 3d24 2873 6b79 2071       f's=$(sky q
-0000a1e0: 7565 7565 207b 6e61 6d65 7d29 3b20 6563  ueue {name}); ec
-0000a1f0: 686f 2022 2473 223b 2065 6368 6f3b 2065  ho "$s"; echo; e
-0000a200: 6368 6f3b 2065 6368 6f20 2224 7322 207c  cho; echo "$s" |
-0000a210: 2067 7265 7020 7b6e 616d 657d 2d33 207c   grep {name}-3 |
-0000a220: 2067 7265 7020 5045 4e44 494e 4727 2c0a   grep PENDING',.
-0000a230: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000a240: 7920 6361 6e63 656c 202d 7920 7b6e 616d  y cancel -y {nam
-0000a250: 657d 2032 272c 0a20 2020 2020 2020 2020  e} 2',.         
-0000a260: 2020 2027 736c 6565 7020 3527 2c0a 2020     'sleep 5',.  
-0000a270: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
-0000a280: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
-0000a290: 293b 2065 6368 6f20 2224 7322 3b20 6563  ); echo "$s"; ec
-0000a2a0: 686f 3b20 6563 686f 3b20 6563 686f 2022  ho; echo; echo "
-0000a2b0: 2473 2220 7c20 6772 6570 207b 6e61 6d65  $s" | grep {name
-0000a2c0: 7d2d 3320 7c20 6772 6570 2052 554e 4e49  }-3 | grep RUNNI
-0000a2d0: 4e47 272c 0a20 2020 2020 2020 2020 2020  NG',.           
-0000a2e0: 2066 2773 6b79 2063 616e 6365 6c20 2d79   f'sky cancel -y
-0000a2f0: 207b 6e61 6d65 7d20 3327 2c0a 2020 2020   {name} 3',.    
-0000a300: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-0000a310: 6563 207b 6e61 6d65 7d20 2d2d 6770 7573  ec {name} --gpus
-0000a320: 2054 343a 302e 3220 225b 5b20 5c24 534b   T4:0.2 "[[ \$SK
-0000a330: 5950 494c 4f54 5f4e 554d 5f47 5055 535f  YPILOT_NUM_GPUS_
-0000a340: 5045 525f 4e4f 4445 202d 6571 2031 205d  PER_NODE -eq 1 ]
-0000a350: 5d20 7c7c 2065 7869 7420 3122 272c 0a20  ] || exit 1"',. 
-0000a360: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000a370: 2065 7865 6320 7b6e 616d 657d 202d 2d67   exec {name} --g
-0000a380: 7075 7320 5434 3a31 2022 5b5b 205c 2453  pus T4:1 "[[ \$S
-0000a390: 4b59 5049 4c4f 545f 4e55 4d5f 4750 5553  KYPILOT_NUM_GPUS
-0000a3a0: 5f50 4552 5f4e 4f44 4520 2d65 7120 3120  _PER_NODE -eq 1 
-0000a3b0: 5d5d 207c 7c20 6578 6974 2031 2227 2c0a  ]] || exit 1"',.
-0000a3c0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000a3d0: 7920 6c6f 6773 207b 6e61 6d65 7d20 3420  y logs {name} 4 
-0000a3e0: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
-0000a3f0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-0000a400: 7320 7b6e 616d 657d 2035 202d 2d73 7461  s {name} 5 --sta
-0000a410: 7475 7327 2c0a 2020 2020 2020 2020 5d2c  tus',.        ],
-0000a420: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
-0000a430: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
-0000a440: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-0000a450: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
-0000a460: 202d 2d2d 2d2d 2d2d 2d2d 2d20 4a6f 6220   ---------- Job 
-0000a470: 5175 6575 6520 7769 7468 2044 6f63 6b65  Queue with Docke
-0000a480: 722e 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070  r. ----------.@p
-0000a490: 7974 6573 742e 6d61 726b 2e6e 6f5f 666c  ytest.mark.no_fl
-0000a4a0: 7569 6473 7461 636b 2020 2320 466c 7569  uidstack  # Flui
-0000a4b0: 6453 7461 636b 2064 6f65 7320 6e6f 7420  dStack does not 
-0000a4c0: 7375 7070 6f72 7420 646f 636b 6572 2066  support docker f
-0000a4d0: 6f72 206e 6f77 0a40 7079 7465 7374 2e6d  or now.@pytest.m
-0000a4e0: 6172 6b2e 6e6f 5f6c 616d 6264 615f 636c  ark.no_lambda_cl
-0000a4f0: 6f75 6420 2023 2044 6f65 736e 2774 2073  oud  # Doesn't s
-0000a500: 7570 706f 7274 204c 616d 6264 6120 436c  upport Lambda Cl
-0000a510: 6f75 6420 666f 7220 6e6f 770a 4070 7974  oud for now.@pyt
-0000a520: 6573 742e 6d61 726b 2e6e 6f5f 6962 6d20  est.mark.no_ibm 
-0000a530: 2023 2044 6f65 736e 2774 2073 7570 706f   # Doesn't suppo
-0000a540: 7274 2049 424d 2043 6c6f 7564 2066 6f72  rt IBM Cloud for
-0000a550: 206e 6f77 0a40 7079 7465 7374 2e6d 6172   now.@pytest.mar
-0000a560: 6b2e 6e6f 5f73 6370 2020 2320 446f 6573  k.no_scp  # Does
-0000a570: 6e27 7420 7375 7070 6f72 7420 5343 5020  n't support SCP 
-0000a580: 666f 7220 6e6f 770a 4070 7974 6573 742e  for now.@pytest.
-0000a590: 6d61 726b 2e6e 6f5f 6f63 6920 2023 2044  mark.no_oci  # D
-0000a5a0: 6f65 736e 2774 2073 7570 706f 7274 204f  oesn't support O
-0000a5b0: 4349 2066 6f72 206e 6f77 0a40 7079 7465  CI for now.@pyte
-0000a5c0: 7374 2e6d 6172 6b2e 6e6f 5f6b 7562 6572  st.mark.no_kuber
-0000a5d0: 6e65 7465 7320 2023 2044 6f65 736e 2774  netes  # Doesn't
-0000a5e0: 2073 7570 706f 7274 204b 7562 6572 6e65   support Kuberne
-0000a5f0: 7465 7320 666f 7220 6e6f 770a 6465 6620  tes for now.def 
-0000a600: 7465 7374 5f6a 6f62 5f71 7565 7565 5f77  test_job_queue_w
-0000a610: 6974 685f 646f 636b 6572 2867 656e 6572  ith_docker(gener
-0000a620: 6963 5f63 6c6f 7564 3a20 7374 7229 3a0a  ic_cloud: str):.
-0000a630: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-0000a640: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-0000a650: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-0000a660: 2020 2020 2020 2020 276a 6f62 5f71 7565          'job_que
-0000a670: 7565 5f77 6974 685f 646f 636b 6572 272c  ue_with_docker',
-0000a680: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-0000a690: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-0000a6a0: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
-0000a6b0: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
-0000a6c0: 635f 636c 6f75 647d 2065 7861 6d70 6c65  c_cloud} example
-0000a6d0: 732f 6a6f 625f 7175 6575 652f 636c 7573  s/job_queue/clus
-0000a6e0: 7465 725f 646f 636b 6572 2e79 616d 6c27  ter_docker.yaml'
-0000a6f0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000a700: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
-0000a710: 2d6e 207b 6e61 6d65 7d2d 3120 2d64 2065  -n {name}-1 -d e
-0000a720: 7861 6d70 6c65 732f 6a6f 625f 7175 6575  xamples/job_queu
-0000a730: 652f 6a6f 625f 646f 636b 6572 2e79 616d  e/job_docker.yam
-0000a740: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-0000a750: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-0000a760: 7d20 2d6e 207b 6e61 6d65 7d2d 3220 2d64  } -n {name}-2 -d
-0000a770: 2065 7861 6d70 6c65 732f 6a6f 625f 7175   examples/job_qu
-0000a780: 6575 652f 6a6f 625f 646f 636b 6572 2e79  eue/job_docker.y
-0000a790: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-0000a7a0: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-0000a7b0: 6d65 7d20 2d6e 207b 6e61 6d65 7d2d 3320  me} -n {name}-3 
-0000a7c0: 2d64 2065 7861 6d70 6c65 732f 6a6f 625f  -d examples/job_
-0000a7d0: 7175 6575 652f 6a6f 625f 646f 636b 6572  queue/job_docker
-0000a7e0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-0000a7f0: 2020 2020 6627 733d 2428 736b 7920 7175      f's=$(sky qu
-0000a800: 6575 6520 7b6e 616d 657d 293b 2065 6368  eue {name}); ech
-0000a810: 6f20 2224 7322 3b20 6563 686f 3b20 6563  o "$s"; echo; ec
-0000a820: 686f 3b20 6563 686f 2022 2473 2220 7c20  ho; echo "$s" | 
-0000a830: 6772 6570 207b 6e61 6d65 7d2d 3120 7c20  grep {name}-1 | 
-0000a840: 6772 6570 2052 554e 4e49 4e47 272c 0a20  grep RUNNING',. 
-0000a850: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
-0000a860: 2873 6b79 2071 7565 7565 207b 6e61 6d65  (sky queue {name
-0000a870: 7d29 3b20 6563 686f 2022 2473 223b 2065  }); echo "$s"; e
-0000a880: 6368 6f3b 2065 6368 6f3b 2065 6368 6f20  cho; echo; echo 
-0000a890: 2224 7322 207c 2067 7265 7020 7b6e 616d  "$s" | grep {nam
-0000a8a0: 657d 2d32 207c 2067 7265 7020 5255 4e4e  e}-2 | grep RUNN
-0000a8b0: 494e 4727 2c0a 2020 2020 2020 2020 2020  ING',.          
-0000a8c0: 2020 6627 733d 2428 736b 7920 7175 6575    f's=$(sky queu
-0000a8d0: 6520 7b6e 616d 657d 293b 2065 6368 6f20  e {name}); echo 
-0000a8e0: 2224 7322 3b20 6563 686f 3b20 6563 686f  "$s"; echo; echo
-0000a8f0: 3b20 6563 686f 2022 2473 2220 7c20 6772  ; echo "$s" | gr
-0000a900: 6570 207b 6e61 6d65 7d2d 3320 7c20 6772  ep {name}-3 | gr
-0000a910: 6570 2050 454e 4449 4e47 272c 0a20 2020  ep PENDING',.   
-0000a920: 2020 2020 2020 2020 2066 2773 6b79 2063           f'sky c
-0000a930: 616e 6365 6c20 2d79 207b 6e61 6d65 7d20  ancel -y {name} 
-0000a940: 3227 2c0a 2020 2020 2020 2020 2020 2020  2',.            
-0000a950: 2773 6c65 6570 2035 272c 0a20 2020 2020  'sleep 5',.     
-0000a960: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
-0000a970: 2071 7565 7565 207b 6e61 6d65 7d29 3b20   queue {name}); 
-0000a980: 6563 686f 2022 2473 223b 2065 6368 6f3b  echo "$s"; echo;
-0000a990: 2065 6368 6f3b 2065 6368 6f20 2224 7322   echo; echo "$s"
-0000a9a0: 207c 2067 7265 7020 7b6e 616d 657d 2d33   | grep {name}-3
-0000a9b0: 207c 2067 7265 7020 5255 4e4e 494e 4727   | grep RUNNING'
-0000a9c0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000a9d0: 736b 7920 6361 6e63 656c 202d 7920 7b6e  sky cancel -y {n
-0000a9e0: 616d 657d 2033 272c 0a20 2020 2020 2020  ame} 3',.       
-0000a9f0: 2020 2020 2066 2773 6b79 2073 746f 7020       f'sky stop 
-0000aa00: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-0000aa10: 2020 2020 2020 2020 2320 4d61 6b65 2073          # Make s
-0000aa20: 7572 6520 7468 6520 6a6f 6220 7374 6174  ure the job stat
-0000aa30: 7573 2070 7265 7365 7276 6520 6166 7465  us preserve afte
-0000aa40: 7220 7374 6f70 2061 6e64 2073 7461 7274  r stop and start
-0000aa50: 2074 6865 0a20 2020 2020 2020 2020 2020   the.           
-0000aa60: 2023 2063 6c75 7374 6572 2e20 5468 6973   # cluster. This
-0000aa70: 2069 7320 616c 736f 2061 2074 6573 7420   is also a test 
-0000aa80: 666f 7220 7468 6520 646f 636b 6572 2063  for the docker c
-0000aa90: 6f6e 7461 696e 6572 2074 6f20 6265 0a20  ontainer to be. 
-0000aaa0: 2020 2020 2020 2020 2020 2023 2070 7265             # pre
-0000aab0: 7365 7276 6564 2061 6674 6572 2073 746f  served after sto
-0000aac0: 7020 616e 6420 7374 6172 742e 0a20 2020  p and start..   
-0000aad0: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-0000aae0: 7461 7274 202d 7920 7b6e 616d 657d 272c  tart -y {name}',
-0000aaf0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000ab00: 3d24 2873 6b79 2071 7565 7565 207b 6e61  =$(sky queue {na
-0000ab10: 6d65 7d29 3b20 6563 686f 2022 2473 223b  me}); echo "$s";
-0000ab20: 2065 6368 6f3b 2065 6368 6f3b 2065 6368   echo; echo; ech
-0000ab30: 6f20 2224 7322 207c 2067 7265 7020 7b6e  o "$s" | grep {n
-0000ab40: 616d 657d 2d31 207c 2067 7265 7020 4641  ame}-1 | grep FA
-0000ab50: 494c 4544 272c 0a20 2020 2020 2020 2020  ILED',.         
-0000ab60: 2020 2066 2773 3d24 2873 6b79 2071 7565     f's=$(sky que
-0000ab70: 7565 207b 6e61 6d65 7d29 3b20 6563 686f  ue {name}); echo
-0000ab80: 2022 2473 223b 2065 6368 6f3b 2065 6368   "$s"; echo; ech
-0000ab90: 6f3b 2065 6368 6f20 2224 7322 207c 2067  o; echo "$s" | g
-0000aba0: 7265 7020 7b6e 616d 657d 2d32 207c 2067  rep {name}-2 | g
-0000abb0: 7265 7020 4341 4e43 454c 4c45 4427 2c0a  rep CANCELLED',.
-0000abc0: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
-0000abd0: 2428 736b 7920 7175 6575 6520 7b6e 616d  $(sky queue {nam
-0000abe0: 657d 293b 2065 6368 6f20 2224 7322 3b20  e}); echo "$s"; 
-0000abf0: 6563 686f 3b20 6563 686f 3b20 6563 686f  echo; echo; echo
-0000ac00: 2022 2473 2220 7c20 6772 6570 207b 6e61   "$s" | grep {na
-0000ac10: 6d65 7d2d 3320 7c20 6772 6570 2043 414e  me}-3 | grep CAN
-0000ac20: 4345 4c4c 4544 272c 0a20 2020 2020 2020  CELLED',.       
-0000ac30: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-0000ac40: 7b6e 616d 657d 202d 2d67 7075 7320 5434  {name} --gpus T4
-0000ac50: 3a30 2e32 2022 5b5b 205c 2453 4b59 5049  :0.2 "[[ \$SKYPI
-0000ac60: 4c4f 545f 4e55 4d5f 4750 5553 5f50 4552  LOT_NUM_GPUS_PER
-0000ac70: 5f4e 4f44 4520 2d65 7120 3120 5d5d 207c  _NODE -eq 1 ]] |
-0000ac80: 7c20 6578 6974 2031 2227 2c0a 2020 2020  | exit 1"',.    
-0000ac90: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-0000aca0: 6563 207b 6e61 6d65 7d20 2d2d 6770 7573  ec {name} --gpus
-0000acb0: 2054 343a 3120 225b 5b20 5c24 534b 5950   T4:1 "[[ \$SKYP
-0000acc0: 494c 4f54 5f4e 554d 5f47 5055 535f 5045  ILOT_NUM_GPUS_PE
-0000acd0: 525f 4e4f 4445 202d 6571 2031 205d 5d20  R_NODE -eq 1 ]] 
-0000ace0: 7c7c 2065 7869 7420 3122 272c 0a20 2020  || exit 1"',.   
-0000acf0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-0000ad00: 6f67 7320 7b6e 616d 657d 2034 202d 2d73  ogs {name} 4 --s
-0000ad10: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
-0000ad20: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-0000ad30: 6e61 6d65 7d20 3520 2d2d 7374 6174 7573  name} 5 --status
-0000ad40: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-0000ad50: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-0000ad60: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-0000ad70: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-0000ad80: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
-0000ad90: 6573 742e 6d61 726b 2e6c 616d 6264 615f  est.mark.lambda_
-0000ada0: 636c 6f75 640a 6465 6620 7465 7374 5f6c  cloud.def test_l
-0000adb0: 616d 6264 615f 6a6f 625f 7175 6575 6528  ambda_job_queue(
-0000adc0: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
-0000add0: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-0000ade0: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
-0000adf0: 7428 0a20 2020 2020 2020 2027 6c61 6d62  t(.        'lamb
-0000ae00: 6461 5f6a 6f62 5f71 7565 7565 272c 0a20  da_job_queue',. 
-0000ae10: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-0000ae20: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-0000ae30: 6820 2d79 202d 6320 7b6e 616d 657d 207b  h -y -c {name} {
-0000ae40: 4c41 4d42 4441 5f54 5950 457d 2065 7861  LAMBDA_TYPE} exa
-0000ae50: 6d70 6c65 732f 6a6f 625f 7175 6575 652f  mples/job_queue/
-0000ae60: 636c 7573 7465 722e 7961 6d6c 272c 0a20  cluster.yaml',. 
-0000ae70: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000ae80: 2065 7865 6320 7b6e 616d 657d 202d 6e20   exec {name} -n 
-0000ae90: 7b6e 616d 657d 2d31 202d 2d67 7075 7320  {name}-1 --gpus 
-0000aea0: 4131 303a 302e 3520 2d64 2065 7861 6d70  A10:0.5 -d examp
-0000aeb0: 6c65 732f 6a6f 625f 7175 6575 652f 6a6f  les/job_queue/jo
-0000aec0: 622e 7961 6d6c 272c 0a20 2020 2020 2020  b.yaml',.       
-0000aed0: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-0000aee0: 7b6e 616d 657d 202d 6e20 7b6e 616d 657d  {name} -n {name}
-0000aef0: 2d32 202d 2d67 7075 7320 4131 303a 302e  -2 --gpus A10:0.
-0000af00: 3520 2d64 2065 7861 6d70 6c65 732f 6a6f  5 -d examples/jo
-0000af10: 625f 7175 6575 652f 6a6f 622e 7961 6d6c  b_queue/job.yaml
-0000af20: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000af30: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-0000af40: 202d 6e20 7b6e 616d 657d 2d33 202d 2d67   -n {name}-3 --g
-0000af50: 7075 7320 4131 303a 302e 3520 2d64 2065  pus A10:0.5 -d e
-0000af60: 7861 6d70 6c65 732f 6a6f 625f 7175 6575  xamples/job_queu
-0000af70: 652f 6a6f 622e 7961 6d6c 272c 0a20 2020  e/job.yaml',.   
-0000af80: 2020 2020 2020 2020 2066 2773 6b79 2071           f'sky q
-0000af90: 7565 7565 207b 6e61 6d65 7d20 7c20 6772  ueue {name} | gr
-0000afa0: 6570 207b 6e61 6d65 7d2d 3120 7c20 6772  ep {name}-1 | gr
-0000afb0: 6570 2052 554e 4e49 4e47 272c 0a20 2020  ep RUNNING',.   
-0000afc0: 2020 2020 2020 2020 2066 2773 6b79 2071           f'sky q
-0000afd0: 7565 7565 207b 6e61 6d65 7d20 7c20 6772  ueue {name} | gr
-0000afe0: 6570 207b 6e61 6d65 7d2d 3220 7c20 6772  ep {name}-2 | gr
-0000aff0: 6570 2052 554e 4e49 4e47 272c 0a20 2020  ep RUNNING',.   
-0000b000: 2020 2020 2020 2020 2066 2773 6b79 2071           f'sky q
-0000b010: 7565 7565 207b 6e61 6d65 7d20 7c20 6772  ueue {name} | gr
-0000b020: 6570 207b 6e61 6d65 7d2d 3320 7c20 6772  ep {name}-3 | gr
-0000b030: 6570 2050 454e 4449 4e47 272c 0a20 2020  ep PENDING',.   
-0000b040: 2020 2020 2020 2020 2066 2773 6b79 2063           f'sky c
-0000b050: 616e 6365 6c20 2d79 207b 6e61 6d65 7d20  ancel -y {name} 
-0000b060: 3227 2c0a 2020 2020 2020 2020 2020 2020  2',.            
-0000b070: 2773 6c65 6570 2035 272c 0a20 2020 2020  'sleep 5',.     
-0000b080: 2020 2020 2020 2066 2773 6b79 2071 7565         f'sky que
-0000b090: 7565 207b 6e61 6d65 7d20 7c20 6772 6570  ue {name} | grep
-0000b0a0: 207b 6e61 6d65 7d2d 3320 7c20 6772 6570   {name}-3 | grep
-0000b0b0: 2052 554e 4e49 4e47 272c 0a20 2020 2020   RUNNING',.     
-0000b0c0: 2020 2020 2020 2066 2773 6b79 2063 616e         f'sky can
-0000b0d0: 6365 6c20 2d79 207b 6e61 6d65 7d20 3327  cel -y {name} 3'
-0000b0e0: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-0000b0f0: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
-0000b100: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-0000b110: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-0000b120: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
-0000b130: 7374 2e6d 6172 6b2e 6962 6d0a 6465 6620  st.mark.ibm.def 
-0000b140: 7465 7374 5f69 626d 5f6a 6f62 5f71 7565  test_ibm_job_que
-0000b150: 7565 2829 3a0a 2020 2020 6e61 6d65 203d  ue():.    name =
-0000b160: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-0000b170: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-0000b180: 5465 7374 280a 2020 2020 2020 2020 2769  Test(.        'i
-0000b190: 626d 5f6a 6f62 5f71 7565 7565 272c 0a20  bm_job_queue',. 
-0000b1a0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-0000b1b0: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-0000b1c0: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
-0000b1d0: 2d63 6c6f 7564 2069 626d 202d 2d67 7075  -cloud ibm --gpu
-0000b1e0: 7320 7631 3030 272c 0a20 2020 2020 2020  s v100',.       
-0000b1f0: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-0000b200: 7b6e 616d 657d 202d 6e20 7b6e 616d 657d  {name} -n {name}
-0000b210: 2d31 202d 2d63 6c6f 7564 2069 626d 202d  -1 --cloud ibm -
-0000b220: 6420 6578 616d 706c 6573 2f6a 6f62 5f71  d examples/job_q
-0000b230: 7565 7565 2f6a 6f62 5f69 626d 2e79 616d  ueue/job_ibm.yam
-0000b240: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-0000b250: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-0000b260: 7d20 2d6e 207b 6e61 6d65 7d2d 3220 2d2d  } -n {name}-2 --
-0000b270: 636c 6f75 6420 6962 6d20 2d64 2065 7861  cloud ibm -d exa
-0000b280: 6d70 6c65 732f 6a6f 625f 7175 6575 652f  mples/job_queue/
-0000b290: 6a6f 625f 6962 6d2e 7961 6d6c 272c 0a20  job_ibm.yaml',. 
-0000b2a0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000b2b0: 2065 7865 6320 7b6e 616d 657d 202d 6e20   exec {name} -n 
-0000b2c0: 7b6e 616d 657d 2d33 202d 2d63 6c6f 7564  {name}-3 --cloud
-0000b2d0: 2069 626d 202d 6420 6578 616d 706c 6573   ibm -d examples
-0000b2e0: 2f6a 6f62 5f71 7565 7565 2f6a 6f62 5f69  /job_queue/job_i
-0000b2f0: 626d 2e79 616d 6c27 2c0a 2020 2020 2020  bm.yaml',.      
-0000b300: 2020 2020 2020 6627 736b 7920 7175 6575        f'sky queu
-0000b310: 6520 7b6e 616d 657d 207c 2067 7265 7020  e {name} | grep 
-0000b320: 7b6e 616d 657d 2d31 207c 2067 7265 7020  {name}-1 | grep 
-0000b330: 5255 4e4e 494e 4727 2c0a 2020 2020 2020  RUNNING',.      
-0000b340: 2020 2020 2020 6627 736b 7920 7175 6575        f'sky queu
-0000b350: 6520 7b6e 616d 657d 207c 2067 7265 7020  e {name} | grep 
-0000b360: 7b6e 616d 657d 2d32 207c 2067 7265 7020  {name}-2 | grep 
-0000b370: 5255 4e4e 494e 4727 2c0a 2020 2020 2020  RUNNING',.      
-0000b380: 2020 2020 2020 6627 736b 7920 7175 6575        f'sky queu
-0000b390: 6520 7b6e 616d 657d 207c 2067 7265 7020  e {name} | grep 
-0000b3a0: 7b6e 616d 657d 2d33 207c 2067 7265 7020  {name}-3 | grep 
-0000b3b0: 5045 4e44 494e 4727 2c0a 2020 2020 2020  PENDING',.      
-0000b3c0: 2020 2020 2020 6627 736b 7920 6361 6e63        f'sky canc
-0000b3d0: 656c 202d 7920 7b6e 616d 657d 2032 272c  el -y {name} 2',
-0000b3e0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-0000b3f0: 6565 7020 3527 2c0a 2020 2020 2020 2020  eep 5',.        
-0000b400: 2020 2020 6627 736b 7920 7175 6575 6520      f'sky queue 
-0000b410: 7b6e 616d 657d 207c 2067 7265 7020 7b6e  {name} | grep {n
-0000b420: 616d 657d 2d33 207c 2067 7265 7020 5255  ame}-3 | grep RU
-0000b430: 4e4e 494e 4727 2c0a 2020 2020 2020 2020  NNING',.        
-0000b440: 2020 2020 6627 736b 7920 6361 6e63 656c      f'sky cancel
-0000b450: 202d 7920 7b6e 616d 657d 2033 272c 0a20   -y {name} 3',. 
-0000b460: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-0000b470: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-0000b480: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
-0000b490: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-0000b4a0: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-0000b4b0: 6d61 726b 2e73 6370 0a64 6566 2074 6573  mark.scp.def tes
-0000b4c0: 745f 7363 705f 6a6f 625f 7175 6575 6528  t_scp_job_queue(
-0000b4d0: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
-0000b4e0: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-0000b4f0: 290a 2020 2020 6e75 6d5f 6f66 5f67 7075  ).    num_of_gpu
-0000b500: 5f6c 6175 6e63 6820 3d20 310a 2020 2020  _launch = 1.    
-0000b510: 6e75 6d5f 6f66 5f67 7075 5f65 7865 6320  num_of_gpu_exec 
-0000b520: 3d20 302e 350a 2020 2020 7465 7374 203d  = 0.5.    test =
-0000b530: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-0000b540: 5343 505f 6a6f 625f 7175 6575 6527 2c0a  SCP_job_queue',.
-0000b550: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-0000b560: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-0000b570: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
-0000b580: 7b53 4350 5f54 5950 457d 207b 5343 505f  {SCP_TYPE} {SCP_
-0000b590: 4750 555f 5631 3030 7d3a 7b6e 756d 5f6f  GPU_V100}:{num_o
-0000b5a0: 665f 6770 755f 6c61 756e 6368 7d20 6578  f_gpu_launch} ex
-0000b5b0: 616d 706c 6573 2f6a 6f62 5f71 7565 7565  amples/job_queue
-0000b5c0: 2f63 6c75 7374 6572 2e79 616d 6c27 2c0a  /cluster.yaml',.
-0000b5d0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000b5e0: 7920 6578 6563 207b 6e61 6d65 7d20 2d6e  y exec {name} -n
-0000b5f0: 207b 6e61 6d65 7d2d 3120 7b53 4350 5f47   {name}-1 {SCP_G
-0000b600: 5055 5f56 3130 307d 3a7b 6e75 6d5f 6f66  PU_V100}:{num_of
-0000b610: 5f67 7075 5f65 7865 637d 202d 6420 6578  _gpu_exec} -d ex
-0000b620: 616d 706c 6573 2f6a 6f62 5f71 7565 7565  amples/job_queue
-0000b630: 2f6a 6f62 2e79 616d 6c27 2c0a 2020 2020  /job.yaml',.    
-0000b640: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-0000b650: 6563 207b 6e61 6d65 7d20 2d6e 207b 6e61  ec {name} -n {na
-0000b660: 6d65 7d2d 3220 7b53 4350 5f47 5055 5f56  me}-2 {SCP_GPU_V
-0000b670: 3130 307d 3a7b 6e75 6d5f 6f66 5f67 7075  100}:{num_of_gpu
-0000b680: 5f65 7865 637d 202d 6420 6578 616d 706c  _exec} -d exampl
-0000b690: 6573 2f6a 6f62 5f71 7565 7565 2f6a 6f62  es/job_queue/job
-0000b6a0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-0000b6b0: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-0000b6c0: 6e61 6d65 7d20 2d6e 207b 6e61 6d65 7d2d  name} -n {name}-
-0000b6d0: 3320 7b53 4350 5f47 5055 5f56 3130 307d  3 {SCP_GPU_V100}
-0000b6e0: 3a7b 6e75 6d5f 6f66 5f67 7075 5f65 7865  :{num_of_gpu_exe
-0000b6f0: 637d 202d 6420 6578 616d 706c 6573 2f6a  c} -d examples/j
-0000b700: 6f62 5f71 7565 7565 2f6a 6f62 2e79 616d  ob_queue/job.yam
-0000b710: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-0000b720: 6627 736b 7920 7175 6575 6520 7b6e 616d  f'sky queue {nam
-0000b730: 657d 207c 2067 7265 7020 7b6e 616d 657d  e} | grep {name}
-0000b740: 2d31 207c 2067 7265 7020 5255 4e4e 494e  -1 | grep RUNNIN
-0000b750: 4727 2c0a 2020 2020 2020 2020 2020 2020  G',.            
-0000b760: 6627 736b 7920 7175 6575 6520 7b6e 616d  f'sky queue {nam
-0000b770: 657d 207c 2067 7265 7020 7b6e 616d 657d  e} | grep {name}
-0000b780: 2d32 207c 2067 7265 7020 5255 4e4e 494e  -2 | grep RUNNIN
-0000b790: 4727 2c0a 2020 2020 2020 2020 2020 2020  G',.            
-0000b7a0: 6627 736b 7920 7175 6575 6520 7b6e 616d  f'sky queue {nam
-0000b7b0: 657d 207c 2067 7265 7020 7b6e 616d 657d  e} | grep {name}
-0000b7c0: 2d33 207c 2067 7265 7020 5045 4e44 494e  -3 | grep PENDIN
-0000b7d0: 4727 2c0a 2020 2020 2020 2020 2020 2020  G',.            
-0000b7e0: 6627 736b 7920 6361 6e63 656c 202d 7920  f'sky cancel -y 
-0000b7f0: 7b6e 616d 657d 2032 272c 0a20 2020 2020  {name} 2',.     
-0000b800: 2020 2020 2020 2027 736c 6565 7020 3527         'sleep 5'
-0000b810: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000b820: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
-0000b830: 207c 2067 7265 7020 7b6e 616d 657d 2d33   | grep {name}-3
-0000b840: 207c 2067 7265 7020 5255 4e4e 494e 4727   | grep RUNNING'
-0000b850: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000b860: 736b 7920 6361 6e63 656c 202d 7920 7b6e  sky cancel -y {n
-0000b870: 616d 657d 2033 272c 0a20 2020 2020 2020  ame} 3',.       
-0000b880: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
-0000b890: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
-0000b8a0: 272c 0a20 2020 2029 0a20 2020 2072 756e  ',.    ).    run
-0000b8b0: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-0000b8c0: 0a0a 4070 7974 6573 742e 6d61 726b 2e6e  ..@pytest.mark.n
-0000b8d0: 6f5f 666c 7569 6473 7461 636b 2020 2320  o_fluidstack  # 
-0000b8e0: 466c 7569 6453 7461 636b 2044 4320 6861  FluidStack DC ha
-0000b8f0: 7320 6c6f 7720 6176 6169 6c61 6269 6c69  s low availabili
-0000b900: 7479 206f 6620 5434 2047 5055 730a 4070  ty of T4 GPUs.@p
-0000b910: 7974 6573 742e 6d61 726b 2e6e 6f5f 6c61  ytest.mark.no_la
-0000b920: 6d62 6461 5f63 6c6f 7564 2020 2320 4c61  mbda_cloud  # La
-0000b930: 6d62 6461 2043 6c6f 7564 2064 6f65 7320  mbda Cloud does 
-0000b940: 6e6f 7420 6861 7665 2054 3420 6770 7573  not have T4 gpus
-0000b950: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-0000b960: 5f69 626d 2020 2320 4942 4d20 436c 6f75  _ibm  # IBM Clou
-0000b970: 6420 646f 6573 206e 6f74 2068 6176 6520  d does not have 
-0000b980: 5434 2067 7075 732e 2072 756e 2074 6573  T4 gpus. run tes
-0000b990: 745f 6962 6d5f 6a6f 625f 7175 6575 655f  t_ibm_job_queue_
-0000b9a0: 6d75 6c74 696e 6f64 6520 696e 7374 6561  multinode instea
-0000b9b0: 640a 4070 7974 6573 742e 6d61 726b 2e6e  d.@pytest.mark.n
-0000b9c0: 6f5f 7363 7020 2023 2053 4350 2064 6f65  o_scp  # SCP doe
-0000b9d0: 7320 6e6f 7420 7375 7070 6f72 7420 6e75  s not support nu
-0000b9e0: 6d5f 6e6f 6465 7320 3e20 3120 7965 740a  m_nodes > 1 yet.
-0000b9f0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-0000ba00: 6f63 6920 2023 204f 4349 2043 6c6f 7564  oci  # OCI Cloud
-0000ba10: 2064 6f65 7320 6e6f 7420 6861 7665 2054   does not have T
-0000ba20: 3420 6770 7573 2e0a 4070 7974 6573 742e  4 gpus..@pytest.
-0000ba30: 6d61 726b 2e6e 6f5f 6b75 6265 726e 6574  mark.no_kubernet
-0000ba40: 6573 2020 2320 4b75 6265 726e 6574 6573  es  # Kubernetes
-0000ba50: 206e 6f74 2073 7570 706f 7274 206e 756d   not support num
-0000ba60: 5f6e 6f64 6573 203e 2031 2079 6574 0a64  _nodes > 1 yet.d
-0000ba70: 6566 2074 6573 745f 6a6f 625f 7175 6575  ef test_job_queu
-0000ba80: 655f 6d75 6c74 696e 6f64 6528 6765 6e65  e_multinode(gene
-0000ba90: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
-0000baa0: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-0000bab0: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-0000bac0: 2020 2020 746f 7461 6c5f 7469 6d65 6f75      total_timeou
-0000bad0: 745f 6d69 6e75 7465 7320 3d20 3330 2069  t_minutes = 30 i
-0000bae0: 6620 6765 6e65 7269 635f 636c 6f75 6420  f generic_cloud 
-0000baf0: 3d3d 2027 617a 7572 6527 2065 6c73 6520  == 'azure' else 
-0000bb00: 3135 0a20 2020 2074 6573 7420 3d20 5465  15.    test = Te
-0000bb10: 7374 280a 2020 2020 2020 2020 276a 6f62  st(.        'job
-0000bb20: 5f71 7565 7565 5f6d 756c 7469 6e6f 6465  _queue_multinode
-0000bb30: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-0000bb40: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-0000bb50: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-0000bb60: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
-0000bb70: 7269 635f 636c 6f75 647d 2065 7861 6d70  ric_cloud} examp
-0000bb80: 6c65 732f 6a6f 625f 7175 6575 652f 636c  les/job_queue/cl
-0000bb90: 7573 7465 725f 6d75 6c74 696e 6f64 652e  uster_multinode.
-0000bba0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-0000bbb0: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-0000bbc0: 616d 657d 202d 6e20 7b6e 616d 657d 2d31  ame} -n {name}-1
-0000bbd0: 202d 6420 6578 616d 706c 6573 2f6a 6f62   -d examples/job
-0000bbe0: 5f71 7565 7565 2f6a 6f62 5f6d 756c 7469  _queue/job_multi
-0000bbf0: 6e6f 6465 2e79 616d 6c27 2c0a 2020 2020  node.yaml',.    
-0000bc00: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-0000bc10: 6563 207b 6e61 6d65 7d20 2d6e 207b 6e61  ec {name} -n {na
-0000bc20: 6d65 7d2d 3220 2d64 2065 7861 6d70 6c65  me}-2 -d example
-0000bc30: 732f 6a6f 625f 7175 6575 652f 6a6f 625f  s/job_queue/job_
-0000bc40: 6d75 6c74 696e 6f64 652e 7961 6d6c 272c  multinode.yaml',
-0000bc50: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000bc60: 6b79 206c 6175 6e63 6820 2d63 207b 6e61  ky launch -c {na
-0000bc70: 6d65 7d20 2d6e 207b 6e61 6d65 7d2d 3320  me} -n {name}-3 
-0000bc80: 2d2d 6465 7461 6368 2d73 6574 7570 202d  --detach-setup -
-0000bc90: 6420 6578 616d 706c 6573 2f6a 6f62 5f71  d examples/job_q
-0000bca0: 7565 7565 2f6a 6f62 5f6d 756c 7469 6e6f  ueue/job_multino
-0000bcb0: 6465 2e79 616d 6c27 2c0a 2020 2020 2020  de.yaml',.      
-0000bcc0: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
-0000bcd0: 7175 6575 6520 7b6e 616d 657d 2920 2626  queue {name}) &&
-0000bce0: 2065 6368 6f20 2224 7322 2026 2620 2865   echo "$s" && (e
-0000bcf0: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
-0000bd00: 7b6e 616d 657d 2d31 207c 2067 7265 7020  {name}-1 | grep 
-0000bd10: 5255 4e4e 494e 4729 272c 0a20 2020 2020  RUNNING)',.     
-0000bd20: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
-0000bd30: 2071 7565 7565 207b 6e61 6d65 7d29 2026   queue {name}) &
-0000bd40: 2620 6563 686f 2022 2473 2220 2626 2028  & echo "$s" && (
-0000bd50: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
-0000bd60: 207b 6e61 6d65 7d2d 3220 7c20 6772 6570   {name}-2 | grep
-0000bd70: 2052 554e 4e49 4e47 2927 2c0a 2020 2020   RUNNING)',.    
-0000bd80: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
-0000bd90: 7920 7175 6575 6520 7b6e 616d 657d 2920  y queue {name}) 
-0000bda0: 2626 2065 6368 6f20 2224 7322 2026 2620  && echo "$s" && 
-0000bdb0: 2865 6368 6f20 2224 7322 207c 2067 7265  (echo "$s" | gre
-0000bdc0: 7020 7b6e 616d 657d 2d33 207c 2067 7265  p {name}-3 | gre
-0000bdd0: 7020 5045 4e44 494e 4729 272c 0a20 2020  p PENDING)',.   
-0000bde0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-0000bdf0: 3930 272c 0a20 2020 2020 2020 2020 2020  90',.           
-0000be00: 2066 2773 6b79 2063 616e 6365 6c20 2d79   f'sky cancel -y
-0000be10: 207b 6e61 6d65 7d20 3127 2c0a 2020 2020   {name} 1',.    
-0000be20: 2020 2020 2020 2020 2773 6c65 6570 2035          'sleep 5
-0000be30: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000be40: 2773 3d24 2873 6b79 2071 7565 7565 207b  's=$(sky queue {
-0000be50: 6e61 6d65 7d29 3b20 6563 686f 2022 2473  name}); echo "$s
-0000be60: 223b 2065 6368 6f3b 2065 6368 6f3b 2065  "; echo; echo; e
-0000be70: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
-0000be80: 7b6e 616d 657d 2d33 207c 2067 7265 7020  {name}-3 | grep 
-0000be90: 5345 5454 494e 475f 5550 272c 0a20 2020  SETTING_UP',.   
-0000bea0: 2020 2020 2020 2020 2066 2773 6b79 2063           f'sky c
-0000beb0: 616e 6365 6c20 2d79 207b 6e61 6d65 7d20  ancel -y {name} 
-0000bec0: 3120 3220 3327 2c0a 2020 2020 2020 2020  1 2 3',.        
-0000bed0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-0000bee0: 202d 6320 7b6e 616d 657d 202d 6e20 7b6e   -c {name} -n {n
-0000bef0: 616d 657d 2d34 202d 2d64 6574 6163 682d  ame}-4 --detach-
-0000bf00: 7365 7475 7020 2d64 2065 7861 6d70 6c65  setup -d example
-0000bf10: 732f 6a6f 625f 7175 6575 652f 6a6f 625f  s/job_queue/job_
-0000bf20: 6d75 6c74 696e 6f64 652e 7961 6d6c 272c  multinode.yaml',
-0000bf30: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-0000bf40: 6573 7420 7468 6520 6a6f 6220 7374 6174  est the job stat
-0000bf50: 7573 2069 7320 636f 7272 6563 746c 7920  us is correctly 
-0000bf60: 7365 7420 746f 2053 4554 5449 4e47 5f55  set to SETTING_U
-0000bf70: 502c 2064 7572 696e 6720 7468 6520 7365  P, during the se
-0000bf80: 7475 7020 6973 2072 756e 6e69 6e67 2c0a  tup is running,.
-0000bf90: 2020 2020 2020 2020 2020 2020 2320 616e              # an
-0000bfa0: 6420 7468 6520 6a6f 6220 6361 6e20 6265  d the job can be
-0000bfb0: 2063 616e 6365 6c6c 6564 2064 7572 696e   cancelled durin
-0000bfc0: 6720 7468 6520 7365 7475 702e 0a20 2020  g the setup..   
-0000bfd0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-0000bfe0: 3527 2c0a 2020 2020 2020 2020 2020 2020  5',.            
-0000bff0: 6627 733d 2428 736b 7920 7175 6575 6520  f's=$(sky queue 
-0000c000: 7b6e 616d 657d 2920 2626 2065 6368 6f20  {name}) && echo 
-0000c010: 2224 7322 2026 2620 2865 6368 6f20 2224  "$s" && (echo "$
-0000c020: 7322 207c 2067 7265 7020 7b6e 616d 657d  s" | grep {name}
-0000c030: 2d34 207c 2067 7265 7020 5345 5454 494e  -4 | grep SETTIN
-0000c040: 475f 5550 2927 2c0a 2020 2020 2020 2020  G_UP)',.        
-0000c050: 2020 2020 6627 736b 7920 6361 6e63 656c      f'sky cancel
-0000c060: 202d 7920 7b6e 616d 657d 2034 272c 0a20   -y {name} 4',. 
-0000c070: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
-0000c080: 2873 6b79 2071 7565 7565 207b 6e61 6d65  (sky queue {name
-0000c090: 7d29 2026 2620 6563 686f 2022 2473 2220  }) && echo "$s" 
-0000c0a0: 2626 2028 6563 686f 2022 2473 2220 7c20  && (echo "$s" | 
-0000c0b0: 6772 6570 207b 6e61 6d65 7d2d 3420 7c20  grep {name}-4 | 
-0000c0c0: 6772 6570 2043 414e 4345 4c4c 4544 2927  grep CANCELLED)'
-0000c0d0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000c0e0: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
-0000c0f0: 2d2d 6770 7573 2054 343a 302e 3220 225b  --gpus T4:0.2 "[
-0000c100: 5b20 5c24 534b 5950 494c 4f54 5f4e 554d  [ \$SKYPILOT_NUM
-0000c110: 5f47 5055 535f 5045 525f 4e4f 4445 202d  _GPUS_PER_NODE -
-0000c120: 6571 2031 205d 5d20 7c7c 2065 7869 7420  eq 1 ]] || exit 
-0000c130: 3122 272c 0a20 2020 2020 2020 2020 2020  1"',.           
-0000c140: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-0000c150: 657d 202d 2d67 7075 7320 5434 3a30 2e32  e} --gpus T4:0.2
-0000c160: 202d 2d6e 756d 2d6e 6f64 6573 2032 2022   --num-nodes 2 "
-0000c170: 5b5b 205c 2453 4b59 5049 4c4f 545f 4e55  [[ \$SKYPILOT_NU
-0000c180: 4d5f 4750 5553 5f50 4552 5f4e 4f44 4520  M_GPUS_PER_NODE 
-0000c190: 2d65 7120 3120 5d5d 207c 7c20 6578 6974  -eq 1 ]] || exit
-0000c1a0: 2031 2227 2c0a 2020 2020 2020 2020 2020   1"',.          
-0000c1b0: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-0000c1c0: 6d65 7d20 2d2d 6770 7573 2054 343a 3120  me} --gpus T4:1 
-0000c1d0: 2d2d 6e75 6d2d 6e6f 6465 7320 3220 225b  --num-nodes 2 "[
-0000c1e0: 5b20 5c24 534b 5950 494c 4f54 5f4e 554d  [ \$SKYPILOT_NUM
-0000c1f0: 5f47 5055 535f 5045 525f 4e4f 4445 202d  _GPUS_PER_NODE -
-0000c200: 6571 2031 205d 5d20 7c7c 2065 7869 7420  eq 1 ]] || exit 
-0000c210: 3122 272c 0a20 2020 2020 2020 2020 2020  1"',.           
-0000c220: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-0000c230: 657d 2035 202d 2d73 7461 7475 7327 2c0a  e} 5 --status',.
-0000c240: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000c250: 7920 6c6f 6773 207b 6e61 6d65 7d20 3620  y logs {name} 6 
-0000c260: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
-0000c270: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-0000c280: 7320 7b6e 616d 657d 2037 202d 2d73 7461  s {name} 7 --sta
-0000c290: 7475 7327 2c0a 2020 2020 2020 2020 5d2c  tus',.        ],
-0000c2a0: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
-0000c2b0: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
-0000c2c0: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
-0000c2d0: 746f 7461 6c5f 7469 6d65 6f75 745f 6d69  total_timeout_mi
-0000c2e0: 6e75 7465 7320 2a20 3630 2c0a 2020 2020  nutes * 60,.    
-0000c2f0: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-0000c300: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
-0000c310: 7374 2e6d 6172 6b2e 6e6f 5f6c 616d 6264  st.mark.no_lambd
-0000c320: 615f 636c 6f75 6420 2023 204e 6f20 4c61  a_cloud  # No La
-0000c330: 6d62 6461 2043 6c6f 7564 2056 4d20 6861  mbda Cloud VM ha
-0000c340: 7320 3820 4350 5573 0a64 6566 2074 6573  s 8 CPUs.def tes
-0000c350: 745f 6c61 7267 655f 6a6f 625f 7175 6575  t_large_job_queu
-0000c360: 6528 6765 6e65 7269 635f 636c 6f75 643a  e(generic_cloud:
-0000c370: 2073 7472 293a 0a20 2020 206e 616d 6520   str):.    name 
-0000c380: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-0000c390: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
-0000c3a0: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-0000c3b0: 6c61 7267 655f 6a6f 625f 7175 6575 6527  large_job_queue'
-0000c3c0: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-0000c3d0: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-0000c3e0: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
-0000c3f0: 7d20 2d2d 6370 7573 2038 202d 2d63 6c6f  } --cpus 8 --clo
-0000c400: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
-0000c410: 647d 272c 0a20 2020 2020 2020 2020 2020  d}',.           
-0000c420: 2066 2766 6f72 2069 2069 6e20 6073 6571   f'for i in `seq
-0000c430: 2031 2037 3560 3b20 646f 2073 6b79 2065   1 75`; do sky e
-0000c440: 7865 6320 7b6e 616d 657d 202d 6e20 7b6e  xec {name} -n {n
-0000c450: 616d 657d 2d24 6920 2d64 2022 6563 686f  ame}-$i -d "echo
-0000c460: 2024 693b 2073 6c65 6570 2031 3030 3030   $i; sleep 10000
-0000c470: 3030 3030 223b 2064 6f6e 6527 2c0a 2020  0000"; done',.  
-0000c480: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000c490: 6361 6e63 656c 202d 7920 7b6e 616d 657d  cancel -y {name}
-0000c4a0: 2031 2032 2033 2034 2035 2036 2037 2038   1 2 3 4 5 6 7 8
-0000c4b0: 2039 2031 3020 3131 2031 3220 3133 2031   9 10 11 12 13 1
-0000c4c0: 3420 3135 2031 3627 2c0a 2020 2020 2020  4 15 16',.      
-0000c4d0: 2020 2020 2020 2773 6c65 6570 2039 3027        'sleep 90'
-0000c4e0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-0000c4f0: 4561 6368 206a 6f62 2074 616b 6573 2030  Each job takes 0
-0000c500: 2e35 2043 5055 2061 6e64 2074 6865 2064  .5 CPU and the d
-0000c510: 6566 6175 6c74 2056 4d20 6861 7320 3820  efault VM has 8 
-0000c520: 4350 5573 2c20 736f 2074 6865 7265 2073  CPUs, so there s
-0000c530: 686f 756c 6420 6265 2038 202f 2030 2e35  hould be 8 / 0.5
-0000c540: 203d 2031 3620 6a6f 6273 2072 756e 6e69   = 16 jobs runni
-0000c550: 6e67 2e0a 2020 2020 2020 2020 2020 2020  ng..            
-0000c560: 2320 5468 6520 6669 7273 7420 3136 206a  # The first 16 j
-0000c570: 6f62 7320 6172 6520 6361 6e63 656c 6564  obs are canceled
-0000c580: 2c20 736f 2074 6865 7265 2073 686f 756c  , so there shoul
-0000c590: 6420 6265 2037 3520 2d20 3332 203d 2034  d be 75 - 32 = 4
-0000c5a0: 3320 6a6f 6273 2050 454e 4449 4e47 2e0a  3 jobs PENDING..
-0000c5b0: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
-0000c5c0: 2428 736b 7920 7175 6575 6520 7b6e 616d  $(sky queue {nam
-0000c5d0: 657d 293b 2065 6368 6f20 2224 7322 3b20  e}); echo "$s"; 
-0000c5e0: 6563 686f 3b20 6563 686f 3b20 6563 686f  echo; echo; echo
-0000c5f0: 2022 2473 2220 7c20 6772 6570 202d 7620   "$s" | grep -v 
-0000c600: 6772 6570 207c 2067 7265 7020 5045 4e44  grep | grep PEND
-0000c610: 494e 4720 7c20 7763 202d 6c20 7c20 6772  ING | wc -l | gr
-0000c620: 6570 2034 3327 2c0a 2020 2020 2020 2020  ep 43',.        
-0000c630: 2020 2020 2320 4d61 6b65 2073 7572 6520      # Make sure 
-0000c640: 7468 6520 6a6f 6273 2061 7265 2073 6368  the jobs are sch
-0000c650: 6564 756c 6564 2069 6e20 4649 464f 206f  eduled in FIFO o
-0000c660: 7264 6572 0a20 2020 2020 2020 2020 2020  rder.           
-0000c670: 202a 5b0a 2020 2020 2020 2020 2020 2020   *[.            
-0000c680: 2020 2020 6627 733d 2428 736b 7920 7175      f's=$(sky qu
-0000c690: 6575 6520 7b6e 616d 657d 293b 2065 6368  eue {name}); ech
-0000c6a0: 6f20 2224 7322 3b20 6563 686f 3b20 6563  o "$s"; echo; ec
-0000c6b0: 686f 3b20 6563 686f 2022 2473 2220 7c20  ho; echo "$s" | 
-0000c6c0: 6772 6570 207b 6e61 6d65 7d2d 7b69 7d20  grep {name}-{i} 
-0000c6d0: 7c20 6772 6570 2043 414e 4345 4c4c 4544  | grep CANCELLED
-0000c6e0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0000c6f0: 2020 666f 7220 6920 696e 2072 616e 6765    for i in range
-0000c700: 2831 2c20 3137 290a 2020 2020 2020 2020  (1, 17).        
-0000c710: 2020 2020 5d2c 0a20 2020 2020 2020 2020      ],.         
-0000c720: 2020 202a 5b0a 2020 2020 2020 2020 2020     *[.          
-0000c730: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
-0000c740: 7175 6575 6520 7b6e 616d 657d 293b 2065  queue {name}); e
-0000c750: 6368 6f20 2224 7322 3b20 6563 686f 3b20  cho "$s"; echo; 
-0000c760: 6563 686f 3b20 6563 686f 2022 2473 2220  echo; echo "$s" 
-0000c770: 7c20 6772 6570 207b 6e61 6d65 7d2d 7b69  | grep {name}-{i
-0000c780: 7d20 7c20 6772 6570 2052 554e 4e49 4e47  } | grep RUNNING
-0000c790: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0000c7a0: 2020 666f 7220 6920 696e 2072 616e 6765    for i in range
-0000c7b0: 2831 372c 2033 3329 0a20 2020 2020 2020  (17, 33).       
-0000c7c0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-0000c7d0: 2020 2020 2a5b 0a20 2020 2020 2020 2020      *[.         
-0000c7e0: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
-0000c7f0: 2071 7565 7565 207b 6e61 6d65 7d29 3b20   queue {name}); 
-0000c800: 6563 686f 2022 2473 223b 2065 6368 6f3b  echo "$s"; echo;
-0000c810: 2065 6368 6f3b 2065 6368 6f20 2224 7322   echo; echo "$s"
-0000c820: 207c 2067 7265 7020 7b6e 616d 657d 2d7b   | grep {name}-{
-0000c830: 697d 207c 2067 7265 7020 5045 4e44 494e  i} | grep PENDIN
-0000c840: 4727 0a20 2020 2020 2020 2020 2020 2020  G'.             
-0000c850: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
-0000c860: 6528 3333 2c20 3735 290a 2020 2020 2020  e(33, 75).      
-0000c870: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-0000c880: 2020 2020 2066 2773 6b79 2063 616e 6365       f'sky cance
-0000c890: 6c20 2d79 207b 6e61 6d65 7d20 3333 2033  l -y {name} 33 3
-0000c8a0: 3520 3337 2033 3920 3137 2031 3820 3139  5 37 39 17 18 19
-0000c8b0: 272c 0a20 2020 2020 2020 2020 2020 202a  ',.            *
-0000c8c0: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
-0000c8d0: 2020 6627 733d 2428 736b 7920 7175 6575    f's=$(sky queu
-0000c8e0: 6520 7b6e 616d 657d 293b 2065 6368 6f20  e {name}); echo 
-0000c8f0: 2224 7322 3b20 6563 686f 3b20 6563 686f  "$s"; echo; echo
-0000c900: 3b20 6563 686f 2022 2473 2220 7c20 6772  ; echo "$s" | gr
-0000c910: 6570 207b 6e61 6d65 7d2d 7b69 7d20 7c20  ep {name}-{i} | 
-0000c920: 6772 6570 2043 414e 4345 4c4c 4544 270a  grep CANCELLED'.
-0000c930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c940: 666f 7220 6920 696e 2072 616e 6765 2833  for i in range(3
-0000c950: 332c 2034 302c 2032 290a 2020 2020 2020  3, 40, 2).      
-0000c960: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-0000c970: 2020 2020 2027 736c 6565 7020 3130 272c       'sleep 10',
-0000c980: 0a20 2020 2020 2020 2020 2020 202a 5b0a  .            *[.
-0000c990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c9a0: 6627 733d 2428 736b 7920 7175 6575 6520  f's=$(sky queue 
-0000c9b0: 7b6e 616d 657d 293b 2065 6368 6f20 2224  {name}); echo "$
-0000c9c0: 7322 3b20 6563 686f 3b20 6563 686f 3b20  s"; echo; echo; 
-0000c9d0: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
-0000c9e0: 207b 6e61 6d65 7d2d 7b69 7d20 7c20 6772   {name}-{i} | gr
-0000c9f0: 6570 2052 554e 4e49 4e47 270a 2020 2020  ep RUNNING'.    
-0000ca00: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0000ca10: 6920 696e 205b 3334 2c20 3336 2c20 3338  i in [34, 36, 38
-0000ca20: 5d0a 2020 2020 2020 2020 2020 2020 5d2c  ].            ],
-0000ca30: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-0000ca40: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
-0000ca50: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
-0000ca60: 2020 2074 696d 656f 7574 3d32 3520 2a20     timeout=25 * 
-0000ca70: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
-0000ca80: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-0000ca90: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-0000caa0: 6e6f 5f6c 616d 6264 615f 636c 6f75 6420  no_lambda_cloud 
-0000cab0: 2023 204e 6f20 4c61 6d62 6461 2043 6c6f   # No Lambda Clo
-0000cac0: 7564 2056 4d20 6861 7320 3820 4350 5573  ud VM has 8 CPUs
-0000cad0: 0a64 6566 2074 6573 745f 6661 7374 5f6c  .def test_fast_l
-0000cae0: 6172 6765 5f6a 6f62 5f71 7565 7565 2867  arge_job_queue(g
-0000caf0: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
-0000cb00: 7229 3a0a 2020 2020 2320 5468 6973 2069  r):.    # This i
-0000cb10: 7320 746f 2074 6573 7420 7468 6520 6a6f  s to test the jo
-0000cb20: 6273 2063 616e 2062 6520 7363 6865 6475  bs can be schedu
-0000cb30: 6c65 6420 7175 6963 6b6c 7920 7768 656e  led quickly when
-0000cb40: 2074 6865 7265 2061 7265 206d 616e 7920   there are many 
-0000cb50: 6a6f 6273 2069 6e20 7468 6520 7175 6575  jobs in the queu
-0000cb60: 652e 0a20 2020 206e 616d 6520 3d20 5f67  e..    name = _g
-0000cb70: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-0000cb80: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
-0000cb90: 7428 0a20 2020 2020 2020 2027 6661 7374  t(.        'fast
-0000cba0: 5f6c 6172 6765 5f6a 6f62 5f71 7565 7565  _large_job_queue
-0000cbb0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-0000cbc0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-0000cbd0: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-0000cbe0: 657d 202d 2d63 7075 7320 3820 2d2d 636c  e} --cpus 8 --cl
-0000cbf0: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
-0000cc00: 7564 7d27 2c0a 2020 2020 2020 2020 2020  ud}',.          
-0000cc10: 2020 6627 666f 7220 6920 696e 2060 7365    f'for i in `se
-0000cc20: 7120 3120 3332 603b 2064 6f20 736b 7920  q 1 32`; do sky 
-0000cc30: 6578 6563 207b 6e61 6d65 7d20 2d6e 207b  exec {name} -n {
-0000cc40: 6e61 6d65 7d2d 2469 202d 6420 2265 6368  name}-$i -d "ech
-0000cc50: 6f20 2469 223b 2064 6f6e 6527 2c0a 2020  o $i"; done',.  
-0000cc60: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-0000cc70: 2036 3027 2c0a 2020 2020 2020 2020 2020   60',.          
-0000cc80: 2020 6627 733d 2428 736b 7920 7175 6575    f's=$(sky queu
-0000cc90: 6520 7b6e 616d 657d 293b 2065 6368 6f20  e {name}); echo 
-0000cca0: 2224 7322 3b20 6563 686f 3b20 6563 686f  "$s"; echo; echo
-0000ccb0: 3b20 6563 686f 2022 2473 2220 7c20 6772  ; echo "$s" | gr
-0000ccc0: 6570 202d 7620 6772 6570 207c 2067 7265  ep -v grep | gre
-0000ccd0: 7020 5355 4343 4545 4445 4420 7c20 7763  p SUCCEEDED | wc
-0000cce0: 202d 6c20 7c20 6772 6570 2033 3227 2c0a   -l | grep 32',.
-0000ccf0: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-0000cd00: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
-0000cd10: 207b 6e61 6d65 7d27 2c0a 2020 2020 2020   {name}',.      
-0000cd20: 2020 7469 6d65 6f75 743d 3230 202a 2036    timeout=20 * 6
-0000cd30: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
-0000cd40: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-0000cd50: 0a0a 4070 7974 6573 742e 6d61 726b 2e69  ..@pytest.mark.i
-0000cd60: 626d 0a64 6566 2074 6573 745f 6962 6d5f  bm.def test_ibm_
-0000cd70: 6a6f 625f 7175 6575 655f 6d75 6c74 696e  job_queue_multin
-0000cd80: 6f64 6528 293a 0a20 2020 206e 616d 6520  ode():.    name 
-0000cd90: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-0000cda0: 616d 6528 290a 2020 2020 7461 736b 5f66  ame().    task_f
-0000cdb0: 696c 6520 3d20 2765 7861 6d70 6c65 732f  ile = 'examples/
-0000cdc0: 6a6f 625f 7175 6575 652f 6a6f 625f 6d75  job_queue/job_mu
-0000cdd0: 6c74 696e 6f64 655f 6962 6d2e 7961 6d6c  ltinode_ibm.yaml
-0000cde0: 270a 2020 2020 7465 7374 203d 2054 6573  '.    test = Tes
-0000cdf0: 7428 0a20 2020 2020 2020 2027 6962 6d5f  t(.        'ibm_
-0000ce00: 6a6f 625f 7175 6575 655f 6d75 6c74 696e  job_queue_multin
-0000ce10: 6f64 6527 2c0a 2020 2020 2020 2020 5b0a  ode',.        [.
-0000ce20: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000ce30: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-0000ce40: 6e61 6d65 7d20 2d2d 636c 6f75 6420 6962  name} --cloud ib
-0000ce50: 6d20 2d2d 6770 7573 2076 3130 3020 2d2d  m --gpus v100 --
-0000ce60: 6e75 6d2d 6e6f 6465 7320 3227 2c0a 2020  num-nodes 2',.  
-0000ce70: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000ce80: 6578 6563 207b 6e61 6d65 7d20 2d6e 207b  exec {name} -n {
-0000ce90: 6e61 6d65 7d2d 3120 2d64 207b 7461 736b  name}-1 -d {task
-0000cea0: 5f66 696c 657d 272c 0a20 2020 2020 2020  _file}',.       
-0000ceb0: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-0000cec0: 7b6e 616d 657d 202d 6e20 7b6e 616d 657d  {name} -n {name}
-0000ced0: 2d32 202d 6420 7b74 6173 6b5f 6669 6c65  -2 -d {task_file
-0000cee0: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
-0000cef0: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-0000cf00: 2d63 207b 6e61 6d65 7d20 2d6e 207b 6e61  -c {name} -n {na
-0000cf10: 6d65 7d2d 3320 2d2d 6465 7461 6368 2d73  me}-3 --detach-s
-0000cf20: 6574 7570 202d 6420 7b74 6173 6b5f 6669  etup -d {task_fi
-0000cf30: 6c65 7d27 2c0a 2020 2020 2020 2020 2020  le}',.          
-0000cf40: 2020 6627 733d 2428 736b 7920 7175 6575    f's=$(sky queu
-0000cf50: 6520 7b6e 616d 657d 2920 2626 2070 7269  e {name}) && pri
-0000cf60: 6e74 6620 2224 7322 2026 2620 2865 6368  ntf "$s" && (ech
-0000cf70: 6f20 2224 7322 207c 2067 7265 7020 7b6e  o "$s" | grep {n
-0000cf80: 616d 657d 2d31 207c 2067 7265 7020 5255  ame}-1 | grep RU
-0000cf90: 4e4e 494e 4729 272c 0a20 2020 2020 2020  NNING)',.       
-0000cfa0: 2020 2020 2066 2773 3d24 2873 6b79 2071       f's=$(sky q
-0000cfb0: 7565 7565 207b 6e61 6d65 7d29 2026 2620  ueue {name}) && 
-0000cfc0: 7072 696e 7466 2022 2473 2220 2626 2028  printf "$s" && (
-0000cfd0: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
-0000cfe0: 207b 6e61 6d65 7d2d 3220 7c20 6772 6570   {name}-2 | grep
-0000cff0: 2052 554e 4e49 4e47 2927 2c0a 2020 2020   RUNNING)',.    
-0000d000: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
-0000d010: 7920 7175 6575 6520 7b6e 616d 657d 2920  y queue {name}) 
-0000d020: 2626 2070 7269 6e74 6620 2224 7322 2026  && printf "$s" &
-0000d030: 2620 2865 6368 6f20 2224 7322 207c 2067  & (echo "$s" | g
-0000d040: 7265 7020 7b6e 616d 657d 2d33 207c 2067  rep {name}-3 | g
-0000d050: 7265 7020 5345 5454 494e 475f 5550 2927  rep SETTING_UP)'
-0000d060: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-0000d070: 6c65 6570 2039 3027 2c0a 2020 2020 2020  leep 90',.      
-0000d080: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
-0000d090: 7175 6575 6520 7b6e 616d 657d 2920 2626  queue {name}) &&
-0000d0a0: 2070 7269 6e74 6620 2224 7322 2026 2620   printf "$s" && 
-0000d0b0: 2865 6368 6f20 2224 7322 207c 2067 7265  (echo "$s" | gre
-0000d0c0: 7020 7b6e 616d 657d 2d33 207c 2067 7265  p {name}-3 | gre
-0000d0d0: 7020 5045 4e44 494e 4729 272c 0a20 2020  p PENDING)',.   
-0000d0e0: 2020 2020 2020 2020 2066 2773 6b79 2063           f'sky c
-0000d0f0: 616e 6365 6c20 2d79 207b 6e61 6d65 7d20  ancel -y {name} 
-0000d100: 3127 2c0a 2020 2020 2020 2020 2020 2020  1',.            
-0000d110: 2773 6c65 6570 2035 272c 0a20 2020 2020  'sleep 5',.     
-0000d120: 2020 2020 2020 2066 2773 6b79 2071 7565         f'sky que
-0000d130: 7565 207b 6e61 6d65 7d20 7c20 6772 6570  ue {name} | grep
-0000d140: 207b 6e61 6d65 7d2d 3320 7c20 6772 6570   {name}-3 | grep
-0000d150: 2052 554e 4e49 4e47 272c 0a20 2020 2020   RUNNING',.     
-0000d160: 2020 2020 2020 2066 2773 6b79 2063 616e         f'sky can
-0000d170: 6365 6c20 2d79 207b 6e61 6d65 7d20 3120  cel -y {name} 1 
-0000d180: 3220 3327 2c0a 2020 2020 2020 2020 2020  2 3',.          
-0000d190: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-0000d1a0: 6320 7b6e 616d 657d 202d 6e20 7b6e 616d  c {name} -n {nam
-0000d1b0: 657d 2d34 202d 2d64 6574 6163 682d 7365  e}-4 --detach-se
-0000d1c0: 7475 7020 2d64 207b 7461 736b 5f66 696c  tup -d {task_fil
-0000d1d0: 657d 272c 0a20 2020 2020 2020 2020 2020  e}',.           
-0000d1e0: 2023 2054 6573 7420 7468 6520 6a6f 6220   # Test the job 
-0000d1f0: 7374 6174 7573 2069 7320 636f 7272 6563  status is correc
-0000d200: 746c 7920 7365 7420 746f 2053 4554 5449  tly set to SETTI
-0000d210: 4e47 5f55 502c 2064 7572 696e 6720 7468  NG_UP, during th
-0000d220: 6520 7365 7475 7020 6973 2072 756e 6e69  e setup is runni
-0000d230: 6e67 2c0a 2020 2020 2020 2020 2020 2020  ng,.            
-0000d240: 2320 616e 6420 7468 6520 6a6f 6220 6361  # and the job ca
-0000d250: 6e20 6265 2063 616e 6365 6c6c 6564 2064  n be cancelled d
-0000d260: 7572 696e 6720 7468 6520 7365 7475 702e  uring the setup.
-0000d270: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000d280: 3d24 2873 6b79 2071 7565 7565 207b 6e61  =$(sky queue {na
-0000d290: 6d65 7d29 2026 2620 7072 696e 7466 2022  me}) && printf "
-0000d2a0: 2473 2220 2626 2028 6563 686f 2022 2473  $s" && (echo "$s
-0000d2b0: 2220 7c20 6772 6570 207b 6e61 6d65 7d2d  " | grep {name}-
-0000d2c0: 3420 7c20 6772 6570 2053 4554 5449 4e47  4 | grep SETTING
-0000d2d0: 5f55 5029 272c 0a20 2020 2020 2020 2020  _UP)',.         
-0000d2e0: 2020 2066 2773 6b79 2063 616e 6365 6c20     f'sky cancel 
-0000d2f0: 2d79 207b 6e61 6d65 7d20 3427 2c0a 2020  -y {name} 4',.  
-0000d300: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
-0000d310: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
-0000d320: 2920 2626 2070 7269 6e74 6620 2224 7322  ) && printf "$s"
-0000d330: 2026 2620 2865 6368 6f20 2224 7322 207c   && (echo "$s" |
-0000d340: 2067 7265 7020 7b6e 616d 657d 2d34 207c   grep {name}-4 |
-0000d350: 2067 7265 7020 4341 4e43 454c 4c45 4429   grep CANCELLED)
-0000d360: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0000d370: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-0000d380: 202d 2d67 7075 7320 7631 3030 3a30 2e32   --gpus v100:0.2
-0000d390: 2022 5b5b 205c 2453 4b59 5049 4c4f 545f   "[[ \$SKYPILOT_
-0000d3a0: 4e55 4d5f 4750 5553 5f50 4552 5f4e 4f44  NUM_GPUS_PER_NOD
-0000d3b0: 4520 2d65 7120 3120 5d5d 207c 7c20 6578  E -eq 1 ]] || ex
-0000d3c0: 6974 2031 2227 2c0a 2020 2020 2020 2020  it 1"',.        
-0000d3d0: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-0000d3e0: 6e61 6d65 7d20 2d2d 6770 7573 2076 3130  name} --gpus v10
-0000d3f0: 303a 302e 3220 2d2d 6e75 6d2d 6e6f 6465  0:0.2 --num-node
-0000d400: 7320 3220 225b 5b20 5c24 534b 5950 494c  s 2 "[[ \$SKYPIL
-0000d410: 4f54 5f4e 554d 5f47 5055 535f 5045 525f  OT_NUM_GPUS_PER_
-0000d420: 4e4f 4445 202d 6571 2031 205d 5d20 7c7c  NODE -eq 1 ]] ||
-0000d430: 2065 7869 7420 3122 272c 0a20 2020 2020   exit 1"',.     
-0000d440: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-0000d450: 6320 7b6e 616d 657d 202d 2d67 7075 7320  c {name} --gpus 
-0000d460: 7631 3030 3a31 202d 2d6e 756d 2d6e 6f64  v100:1 --num-nod
-0000d470: 6573 2032 2022 5b5b 205c 2453 4b59 5049  es 2 "[[ \$SKYPI
-0000d480: 4c4f 545f 4e55 4d5f 4750 5553 5f50 4552  LOT_NUM_GPUS_PER
-0000d490: 5f4e 4f44 4520 2d65 7120 3120 5d5d 207c  _NODE -eq 1 ]] |
-0000d4a0: 7c20 6578 6974 2031 2227 2c0a 2020 2020  | exit 1"',.    
-0000d4b0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-0000d4c0: 6773 207b 6e61 6d65 7d20 3520 2d2d 7374  gs {name} 5 --st
-0000d4d0: 6174 7573 272c 0a20 2020 2020 2020 2020  atus',.         
-0000d4e0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-0000d4f0: 616d 657d 2036 202d 2d73 7461 7475 7327  ame} 6 --status'
-0000d500: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000d510: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-0000d520: 3720 2d2d 7374 6174 7573 272c 0a20 2020  7 --status',.   
-0000d530: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-0000d540: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-0000d550: 616d 657d 272c 0a20 2020 2020 2020 2074  ame}',.        t
-0000d560: 696d 656f 7574 3d32 3020 2a20 3630 2c20  imeout=20 * 60, 
-0000d570: 2023 2032 3020 6d69 6e73 0a20 2020 2029   # 20 mins.    )
-0000d580: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-0000d590: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
-0000d5a0: 2d2d 2d2d 2d2d 2044 6f63 6b65 7220 7769  ------ Docker wi
-0000d5b0: 7468 2070 7265 696e 7374 616c 6c65 6420  th preinstalled 
-0000d5c0: 7061 636b 6167 652e 202d 2d2d 2d2d 2d2d  package. -------
-0000d5d0: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
-0000d5e0: 2e6e 6f5f 666c 7569 6473 7461 636b 2020  .no_fluidstack  
-0000d5f0: 2320 446f 6573 6e27 7420 7375 7070 6f72  # Doesn't suppor
-0000d600: 7420 466c 7569 6473 7461 636b 2066 6f72  t Fluidstack for
-0000d610: 206e 6f77 0a40 7079 7465 7374 2e6d 6172   now.@pytest.mar
-0000d620: 6b2e 6e6f 5f6c 616d 6264 615f 636c 6f75  k.no_lambda_clou
-0000d630: 6420 2023 2044 6f65 736e 2774 2073 7570  d  # Doesn't sup
-0000d640: 706f 7274 204c 616d 6264 6120 436c 6f75  port Lambda Clou
-0000d650: 6420 666f 7220 6e6f 770a 4070 7974 6573  d for now.@pytes
-0000d660: 742e 6d61 726b 2e6e 6f5f 6962 6d20 2023  t.mark.no_ibm  #
-0000d670: 2044 6f65 736e 2774 2073 7570 706f 7274   Doesn't support
-0000d680: 2049 424d 2043 6c6f 7564 2066 6f72 206e   IBM Cloud for n
-0000d690: 6f77 0a40 7079 7465 7374 2e6d 6172 6b2e  ow.@pytest.mark.
-0000d6a0: 6e6f 5f73 6370 2020 2320 446f 6573 6e27  no_scp  # Doesn'
-0000d6b0: 7420 7375 7070 6f72 7420 5343 5020 666f  t support SCP fo
-0000d6c0: 7220 6e6f 770a 4070 7974 6573 742e 6d61  r now.@pytest.ma
-0000d6d0: 726b 2e6e 6f5f 6f63 6920 2023 2044 6f65  rk.no_oci  # Doe
-0000d6e0: 736e 2774 2073 7570 706f 7274 204f 4349  sn't support OCI
-0000d6f0: 2066 6f72 206e 6f77 0a40 7079 7465 7374   for now.@pytest
-0000d700: 2e6d 6172 6b2e 6e6f 5f6b 7562 6572 6e65  .mark.no_kuberne
-0000d710: 7465 7320 2023 2044 6f65 736e 2774 2073  tes  # Doesn't s
-0000d720: 7570 706f 7274 204b 7562 6572 6e65 7465  upport Kubernete
-0000d730: 7320 666f 7220 6e6f 770a 6465 6620 7465  s for now.def te
-0000d740: 7374 5f64 6f63 6b65 725f 7072 6569 6e73  st_docker_preins
-0000d750: 7461 6c6c 6564 5f70 6163 6b61 6765 2867  talled_package(g
-0000d760: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
-0000d770: 7229 3a0a 2020 2020 6e61 6d65 203d 205f  r):.    name = _
-0000d780: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-0000d790: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
-0000d7a0: 7374 280a 2020 2020 2020 2020 2764 6f63  st(.        'doc
-0000d7b0: 6b65 725f 7769 7468 5f70 7265 696e 7374  ker_with_preinst
-0000d7c0: 616c 6c65 645f 7061 636b 6167 6527 2c0a  alled_package',.
-0000d7d0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-0000d7e0: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-0000d7f0: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
-0000d800: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
-0000d810: 5f63 6c6f 7564 7d20 2d2d 696d 6167 652d  _cloud} --image-
-0000d820: 6964 2064 6f63 6b65 723a 6e67 696e 7827  id docker:nginx'
-0000d830: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0000d840: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
-0000d850: 226e 6769 6e78 202d 5622 272c 0a20 2020  "nginx -V"',.   
-0000d860: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-0000d870: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
-0000d880: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
-0000d890: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-0000d8a0: 6e61 6d65 7d20 7768 6f61 6d69 207c 2067  name} whoami | g
-0000d8b0: 7265 7020 726f 6f74 272c 0a20 2020 2020  rep root',.     
-0000d8c0: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
-0000d8d0: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
-0000d8e0: 657d 272c 0a20 2020 2029 0a20 2020 2072  e}',.    ).    r
-0000d8f0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-0000d900: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
-0000d910: 2053 7562 6d69 7474 696e 6720 6d75 6c74   Submitting mult
-0000d920: 6970 6c65 2074 6173 6b73 2074 6f20 7468  iple tasks to th
-0000d930: 6520 7361 6d65 2063 6c75 7374 6572 2e20  e same cluster. 
-0000d940: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
-0000d950: 7374 2e6d 6172 6b2e 6e6f 5f66 6c75 6964  st.mark.no_fluid
-0000d960: 7374 6163 6b20 2023 2046 6c75 6964 5374  stack  # FluidSt
-0000d970: 6163 6b20 4443 2068 6173 206c 6f77 2061  ack DC has low a
-0000d980: 7661 696c 6162 696c 6974 7920 6f66 2054  vailability of T
-0000d990: 3420 4750 5573 0a40 7079 7465 7374 2e6d  4 GPUs.@pytest.m
-0000d9a0: 6172 6b2e 6e6f 5f6c 616d 6264 615f 636c  ark.no_lambda_cl
-0000d9b0: 6f75 6420 2023 204c 616d 6264 6120 436c  oud  # Lambda Cl
-0000d9c0: 6f75 6420 646f 6573 206e 6f74 2068 6176  oud does not hav
-0000d9d0: 6520 5434 2067 7075 730a 4070 7974 6573  e T4 gpus.@pytes
-0000d9e0: 742e 6d61 726b 2e6e 6f5f 6962 6d20 2023  t.mark.no_ibm  #
-0000d9f0: 2049 424d 2043 6c6f 7564 2064 6f65 7320   IBM Cloud does 
-0000da00: 6e6f 7420 6861 7665 2054 3420 6770 7573  not have T4 gpus
-0000da10: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-0000da20: 5f73 6370 2020 2320 5343 5020 646f 6573  _scp  # SCP does
-0000da30: 206e 6f74 2073 7570 706f 7274 206e 756d   not support num
-0000da40: 5f6e 6f64 6573 203e 2031 2079 6574 0a40  _nodes > 1 yet.@
-0000da50: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f6f  pytest.mark.no_o
-0000da60: 6369 2020 2320 4f43 4920 436c 6f75 6420  ci  # OCI Cloud 
-0000da70: 646f 6573 206e 6f74 2068 6176 6520 5434  does not have T4
-0000da80: 2067 7075 730a 6465 6620 7465 7374 5f6d   gpus.def test_m
-0000da90: 756c 7469 5f65 6368 6f28 6765 6e65 7269  ulti_echo(generi
-0000daa0: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
-0000dab0: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-0000dac0: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-0000dad0: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
-0000dae0: 2020 2020 2020 2027 6d75 6c74 695f 6563         'multi_ec
-0000daf0: 686f 272c 0a20 2020 2020 2020 205b 0a20  ho',.        [. 
-0000db00: 2020 2020 2020 2020 2020 2066 2770 7974             f'pyt
-0000db10: 686f 6e20 6578 616d 706c 6573 2f6d 756c  hon examples/mul
-0000db20: 7469 5f65 6368 6f2e 7079 207b 6e61 6d65  ti_echo.py {name
-0000db30: 7d20 7b67 656e 6572 6963 5f63 6c6f 7564  } {generic_cloud
-0000db40: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
-0000db50: 2773 6c65 6570 2031 3230 272c 0a20 2020  'sleep 120',.   
-0000db60: 2020 2020 205d 202b 0a20 2020 2020 2020       ] +.       
-0000db70: 2023 2045 6e73 7572 6520 6a6f 6273 2073   # Ensure jobs s
-0000db80: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
-0000db90: 2020 5b66 2773 6b79 206c 6f67 7320 7b6e    [f'sky logs {n
-0000dba0: 616d 657d 207b 6920 2b20 317d 202d 2d73  ame} {i + 1} --s
-0000dbb0: 7461 7475 7327 2066 6f72 2069 2069 6e20  tatus' for i in 
-0000dbc0: 7261 6e67 6528 3332 295d 202b 0a20 2020  range(32)] +.   
-0000dbd0: 2020 2020 2023 2045 6e73 7572 6520 6d6f       # Ensure mo
-0000dbe0: 6e69 746f 722f 6175 746f 7363 616c 6572  nitor/autoscaler
-0000dbf0: 2064 6964 6e27 7420 6372 6173 6820 6f6e   didn't crash on
-0000dc00: 2074 6865 2027 6173 7365 7274 206e 6f74   the 'assert not
-0000dc10: 0a20 2020 2020 2020 2023 2075 6e66 756c  .        # unful
-0000dc20: 6669 6c6c 6564 2720 6572 726f 722e 2020  filled' error.  
-0000dc30: 4966 2070 726f 6365 7373 206e 6f74 2066  If process not f
-0000dc40: 6f75 6e64 2c20 6772 6570 2d3e 7373 6820  ound, grep->ssh 
-0000dc50: 7265 7475 726e 7320 312e 0a20 2020 2020  returns 1..     
-0000dc60: 2020 205b 6627 7373 6820 7b6e 616d 657d     [f'ssh {name}
-0000dc70: 205c 2770 7320 6175 7820 7c20 6772 6570   \'ps aux | grep
-0000dc80: 2022 5b2f 5d22 6d6f 6e69 746f 722e 7079   "[/]"monitor.py
-0000dc90: 5c27 275d 2c0a 2020 2020 2020 2020 6627  \''],.        f'
-0000dca0: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
-0000dcb0: 657d 272c 0a20 2020 2020 2020 2074 696d  e}',.        tim
-0000dcc0: 656f 7574 3d32 3020 2a20 3630 2c0a 2020  eout=20 * 60,.  
-0000dcd0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-0000dce0: 7465 7374 2874 6573 7429 0a0a 0a23 202d  test(test)...# -
-0000dcf0: 2d2d 2d2d 2d2d 2d2d 2d20 5461 736b 3a20  --------- Task: 
-0000dd00: 3120 6e6f 6465 2074 7261 696e 696e 672e  1 node training.
-0000dd10: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974   ----------.@pyt
-0000dd20: 6573 742e 6d61 726b 2e6e 6f5f 6c61 6d62  est.mark.no_lamb
-0000dd30: 6461 5f63 6c6f 7564 2020 2320 4c61 6d62  da_cloud  # Lamb
-0000dd40: 6461 2043 6c6f 7564 2064 6f65 7320 6e6f  da Cloud does no
-0000dd50: 7420 6861 7665 2056 3130 3020 6770 7573  t have V100 gpus
-0000dd60: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-0000dd70: 5f69 626d 2020 2320 4942 4d20 636c 6f75  _ibm  # IBM clou
-0000dd80: 6420 6375 7272 656e 746c 7920 646f 6573  d currently does
-0000dd90: 6e27 7420 7072 6f76 6964 6520 7075 626c  n't provide publ
-0000dda0: 6963 2069 6d61 6765 2077 6974 6820 4355  ic image with CU
-0000ddb0: 4441 0a40 7079 7465 7374 2e6d 6172 6b2e  DA.@pytest.mark.
-0000ddc0: 6e6f 5f73 6370 2020 2320 5343 5020 646f  no_scp  # SCP do
-0000ddd0: 6573 206e 6f74 2068 6176 6520 5631 3030  es not have V100
-0000dde0: 2028 3136 4742 2920 4750 5573 2e20 5275   (16GB) GPUs. Ru
-0000ddf0: 6e20 7465 7374 5f73 6370 5f68 7567 6769  n test_scp_huggi
-0000de00: 6e67 6661 6365 2069 6e73 7465 6164 2e0a  ngface instead..
-0000de10: 6465 6620 7465 7374 5f68 7567 6769 6e67  def test_hugging
-0000de20: 6661 6365 2867 656e 6572 6963 5f63 6c6f  face(generic_clo
-0000de30: 7564 3a20 7374 7229 3a0a 2020 2020 6e61  ud: str):.    na
-0000de40: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-0000de50: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
-0000de60: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-0000de70: 2020 2768 7567 6769 6e67 6661 6365 5f67    'huggingface_g
-0000de80: 6c75 655f 696d 6462 5f61 7070 272c 0a20  lue_imdb_app',. 
-0000de90: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-0000dea0: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-0000deb0: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
-0000dec0: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
-0000ded0: 636c 6f75 647d 2065 7861 6d70 6c65 732f  cloud} examples/
-0000dee0: 6875 6767 696e 6766 6163 655f 676c 7565  huggingface_glue
-0000def0: 5f69 6d64 625f 6170 702e 7961 6d6c 272c  _imdb_app.yaml',
-0000df00: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000df10: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
-0000df20: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
-0000df30: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
-0000df40: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
-0000df50: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-0000df60: 7b6e 616d 657d 2065 7861 6d70 6c65 732f  {name} examples/
-0000df70: 6875 6767 696e 6766 6163 655f 676c 7565  huggingface_glue
-0000df80: 5f69 6d64 625f 6170 702e 7961 6d6c 272c  _imdb_app.yaml',
-0000df90: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000dfa0: 6b79 206c 6f67 7320 7b6e 616d 657d 2032  ky logs {name} 2
-0000dfb0: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
-0000dfc0: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
-0000dfd0: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
-0000dfe0: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
-0000dff0: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
-0000e000: 272c 0a20 2020 2029 0a20 2020 2072 756e  ',.    ).    run
-0000e010: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-0000e020: 0a0a 4070 7974 6573 742e 6d61 726b 2e6c  ..@pytest.mark.l
-0000e030: 616d 6264 615f 636c 6f75 640a 6465 6620  ambda_cloud.def 
-0000e040: 7465 7374 5f6c 616d 6264 615f 6875 6767  test_lambda_hugg
-0000e050: 696e 6766 6163 6528 6765 6e65 7269 635f  ingface(generic_
-0000e060: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
-0000e070: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-0000e080: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-0000e090: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-0000e0a0: 2020 2020 2027 6c61 6d62 6461 5f68 7567       'lambda_hug
-0000e0b0: 6769 6e67 6661 6365 5f67 6c75 655f 696d  gingface_glue_im
-0000e0c0: 6462 5f61 7070 272c 0a20 2020 2020 2020  db_app',.       
-0000e0d0: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-0000e0e0: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-0000e0f0: 6320 7b6e 616d 657d 207b 4c41 4d42 4441  c {name} {LAMBDA
-0000e100: 5f54 5950 457d 2065 7861 6d70 6c65 732f  _TYPE} examples/
-0000e110: 6875 6767 696e 6766 6163 655f 676c 7565  huggingface_glue
-0000e120: 5f69 6d64 625f 6170 702e 7961 6d6c 272c  _imdb_app.yaml',
-0000e130: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000e140: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
-0000e150: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
-0000e160: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
-0000e170: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
-0000e180: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-0000e190: 7b6e 616d 657d 207b 4c41 4d42 4441 5f54  {name} {LAMBDA_T
-0000e1a0: 5950 457d 2065 7861 6d70 6c65 732f 6875  YPE} examples/hu
-0000e1b0: 6767 696e 6766 6163 655f 676c 7565 5f69  ggingface_glue_i
-0000e1c0: 6d64 625f 6170 702e 7961 6d6c 272c 0a20  mdb_app.yaml',. 
-0000e1d0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000e1e0: 206c 6f67 7320 7b6e 616d 657d 2032 202d   logs {name} 2 -
-0000e1f0: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
-0000e200: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
-0000e210: 6565 6465 642e 0a20 2020 2020 2020 205d  eeded..        ]
-0000e220: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-0000e230: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
-0000e240: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-0000e250: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-0000e260: 4070 7974 6573 742e 6d61 726b 2e73 6370  @pytest.mark.scp
-0000e270: 0a64 6566 2074 6573 745f 7363 705f 6875  .def test_scp_hu
-0000e280: 6767 696e 6766 6163 6528 6765 6e65 7269  ggingface(generi
-0000e290: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
-0000e2a0: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-0000e2b0: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-0000e2c0: 2020 6e75 6d5f 6f66 5f67 7075 5f6c 6175    num_of_gpu_lau
-0000e2d0: 6e63 6820 3d20 310a 2020 2020 7465 7374  nch = 1.    test
-0000e2e0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-0000e2f0: 2027 5343 505f 6875 6767 696e 6766 6163   'SCP_huggingfac
-0000e300: 655f 676c 7565 5f69 6d64 625f 6170 7027  e_glue_imdb_app'
-0000e310: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-0000e320: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-0000e330: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
-0000e340: 7d20 7b53 4350 5f54 5950 457d 207b 5343  } {SCP_TYPE} {SC
-0000e350: 505f 4750 555f 5631 3030 7d3a 7b6e 756d  P_GPU_V100}:{num
-0000e360: 5f6f 665f 6770 755f 6c61 756e 6368 7d20  _of_gpu_launch} 
-0000e370: 6578 616d 706c 6573 2f68 7567 6769 6e67  examples/hugging
-0000e380: 6661 6365 5f67 6c75 655f 696d 6462 5f61  face_glue_imdb_a
-0000e390: 7070 2e79 616d 6c27 2c0a 2020 2020 2020  pp.yaml',.      
-0000e3a0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-0000e3b0: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
-0000e3c0: 7573 272c 2020 2320 456e 7375 7265 2074  us',  # Ensure t
-0000e3d0: 6865 206a 6f62 2073 7563 6365 6564 6564  he job succeeded
-0000e3e0: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
-0000e3f0: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
-0000e400: 7b53 4350 5f54 5950 457d 207b 5343 505f  {SCP_TYPE} {SCP_
-0000e410: 4750 555f 5631 3030 7d3a 7b6e 756d 5f6f  GPU_V100}:{num_o
-0000e420: 665f 6770 755f 6c61 756e 6368 7d20 6578  f_gpu_launch} ex
-0000e430: 616d 706c 6573 2f68 7567 6769 6e67 6661  amples/huggingfa
-0000e440: 6365 5f67 6c75 655f 696d 6462 5f61 7070  ce_glue_imdb_app
-0000e450: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-0000e460: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-0000e470: 6e61 6d65 7d20 3220 2d2d 7374 6174 7573  name} 2 --status
-0000e480: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
-0000e490: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
-0000e4a0: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-0000e4b0: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
-0000e4c0: 207b 6e61 6d65 7d27 2c0a 2020 2020 290a   {name}',.    ).
-0000e4d0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-0000e4e0: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
-0000e4f0: 2d2d 2d2d 2d20 496e 6665 7265 6e74 6961  ----- Inferentia
-0000e500: 2e20 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079  . ----------.@py
-0000e510: 7465 7374 2e6d 6172 6b2e 6177 730a 6465  test.mark.aws.de
-0000e520: 6620 7465 7374 5f69 6e66 6572 656e 7469  f test_inferenti
-0000e530: 6128 293a 0a20 2020 206e 616d 6520 3d20  a():.    name = 
-0000e540: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-0000e550: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
-0000e560: 6573 7428 0a20 2020 2020 2020 2027 7465  est(.        'te
-0000e570: 7374 5f69 6e66 6572 656e 7469 6127 2c0a  st_inferentia',.
-0000e580: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-0000e590: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-0000e5a0: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
-0000e5b0: 2d74 2069 6e66 322e 786c 6172 6765 202d  -t inf2.xlarge -
-0000e5c0: 2d20 6563 686f 2068 6927 2c0a 2020 2020  - echo hi',.    
-0000e5d0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-0000e5e0: 6563 207b 6e61 6d65 7d20 2d2d 6770 7573  ec {name} --gpus
-0000e5f0: 2049 6e66 6572 656e 7469 613a 3120 6563   Inferentia:1 ec
-0000e600: 686f 2068 6927 2c0a 2020 2020 2020 2020  ho hi',.        
-0000e610: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-0000e620: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
-0000e630: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
-0000e640: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
-0000e650: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000e660: 7920 6c6f 6773 207b 6e61 6d65 7d20 3220  y logs {name} 2 
-0000e670: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
-0000e680: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
-0000e690: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
-0000e6a0: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
-0000e6b0: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-0000e6c0: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
-0000e6d0: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-0000e6e0: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5450  .# ---------- TP
-0000e6f0: 552e 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070  U. ----------.@p
-0000e700: 7974 6573 742e 6d61 726b 2e67 6370 0a40  ytest.mark.gcp.@
-0000e710: 7079 7465 7374 2e6d 6172 6b2e 7470 750a  pytest.mark.tpu.
-0000e720: 6465 6620 7465 7374 5f74 7075 2829 3a0a  def test_tpu():.
-0000e730: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-0000e740: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-0000e750: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-0000e760: 2020 2020 2020 2020 2774 7075 5f61 7070          'tpu_app
-0000e770: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-0000e780: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-0000e790: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-0000e7a0: 657d 2065 7861 6d70 6c65 732f 7470 752f  e} examples/tpu/
-0000e7b0: 7470 755f 6170 702e 7961 6d6c 272c 0a20  tpu_app.yaml',. 
-0000e7c0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0000e7d0: 206c 6f67 7320 7b6e 616d 657d 2031 272c   logs {name} 1',
-0000e7e0: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
-0000e7f0: 6f62 2066 696e 6973 6865 642e 0a20 2020  ob finished..   
-0000e800: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-0000e810: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
-0000e820: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
-0000e830: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
-0000e840: 6465 642e 0a20 2020 2020 2020 2020 2020  ded..           
-0000e850: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
-0000e860: 202d 6320 7b6e 616d 657d 2065 7861 6d70   -c {name} examp
-0000e870: 6c65 732f 7470 752f 7470 755f 6170 702e  les/tpu/tpu_app.
-0000e880: 7961 6d6c 207c 2067 7265 7020 2254 5055  yaml | grep "TPU
-0000e890: 202e 2a20 616c 7265 6164 7920 6578 6973   .* already exis
-0000e8a0: 7473 2227 2c20 2023 2045 6e73 7572 6520  ts"',  # Ensure 
-0000e8b0: 736b 7920 6c61 756e 6368 2077 6f6e 2774  sky launch won't
-0000e8c0: 2063 7265 6174 6520 616e 6f74 6865 7220   create another 
-0000e8d0: 5450 552e 0a20 2020 2020 2020 205d 2c0a  TPU..        ],.
-0000e8e0: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-0000e8f0: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
-0000e900: 2020 2020 2020 2074 696d 656f 7574 3d33         timeout=3
-0000e910: 3020 2a20 3630 2c20 2023 2063 616e 2074  0 * 60,  # can t
-0000e920: 616b 6520 3e32 3020 6d69 6e73 0a20 2020  ake >20 mins.   
-0000e930: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-0000e940: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
-0000e950: 2d2d 2d2d 2d2d 2d2d 2054 5055 2056 4d2e  -------- TPU VM.
-0000e960: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974   ----------.@pyt
-0000e970: 6573 742e 6d61 726b 2e67 6370 0a40 7079  est.mark.gcp.@py
-0000e980: 7465 7374 2e6d 6172 6b2e 7470 750a 6465  test.mark.tpu.de
-0000e990: 6620 7465 7374 5f74 7075 5f76 6d28 293a  f test_tpu_vm():
-0000e9a0: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-0000e9b0: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-0000e9c0: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-0000e9d0: 0a20 2020 2020 2020 2027 7470 755f 766d  .        'tpu_vm
-0000e9e0: 5f61 7070 272c 0a20 2020 2020 2020 205b  _app',.        [
-0000e9f0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000ea00: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
-0000ea10: 7b6e 616d 657d 2065 7861 6d70 6c65 732f  {name} examples/
-0000ea20: 7470 752f 7470 7576 6d5f 6d6e 6973 742e  tpu/tpuvm_mnist.
-0000ea30: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-0000ea40: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-0000ea50: 616d 657d 2031 272c 2020 2320 456e 7375  ame} 1',  # Ensu
-0000ea60: 7265 2074 6865 206a 6f62 2066 696e 6973  re the job finis
-0000ea70: 6865 642e 0a20 2020 2020 2020 2020 2020  hed..           
-0000ea80: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-0000ea90: 657d 2031 202d 2d73 7461 7475 7327 2c20  e} 1 --status', 
-0000eaa0: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
-0000eab0: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
-0000eac0: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-0000ead0: 746f 7020 2d79 207b 6e61 6d65 7d27 2c0a  top -y {name}',.
-0000eae0: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
-0000eaf0: 2428 736b 7920 7374 6174 7573 207b 6e61  $(sky status {na
-0000eb00: 6d65 7d20 2d2d 7265 6672 6573 6829 3b20  me} --refresh); 
-0000eb10: 6563 686f 2022 2473 223b 2065 6368 6f3b  echo "$s"; echo;
-0000eb20: 2065 6368 6f3b 2065 6368 6f20 2224 7322   echo; echo "$s"
-0000eb30: 2020 7c20 6772 6570 207b 6e61 6d65 7d20    | grep {name} 
-0000eb40: 7c20 6772 6570 2053 544f 5050 4544 272c  | grep STOPPED',
-0000eb50: 2020 2320 456e 7375 7265 2074 6865 2063    # Ensure the c
-0000eb60: 6c75 7374 6572 2069 7320 5354 4f50 5045  luster is STOPPE
-0000eb70: 442e 0a20 2020 2020 2020 2020 2020 2023  D..            #
-0000eb80: 2055 7365 2072 6574 7279 3a20 6775 6172   Use retry: guar
-0000eb90: 6420 6167 6169 6e73 7420 7472 616e 7369  d against transi
-0000eba0: 656e 7420 6572 726f 7273 206f 6273 6572  ent errors obser
-0000ebb0: 7665 6420 666f 720a 2020 2020 2020 2020  ved for.        
-0000ebc0: 2020 2020 2320 6a75 7374 2d73 746f 7070      # just-stopp
-0000ebd0: 6564 2054 5055 2056 4d73 2028 2339 3632  ed TPU VMs (#962
-0000ebe0: 292e 0a20 2020 2020 2020 2020 2020 2066  )..            f
-0000ebf0: 2773 6b79 2073 7461 7274 202d 2d72 6574  'sky start --ret
-0000ec00: 7279 2d75 6e74 696c 2d75 7020 2d79 207b  ry-until-up -y {
-0000ec10: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
-0000ec20: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-0000ec30: 6e61 6d65 7d20 6578 616d 706c 6573 2f74  name} examples/t
-0000ec40: 7075 2f74 7075 766d 5f6d 6e69 7374 2e79  pu/tpuvm_mnist.y
-0000ec50: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-0000ec60: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-0000ec70: 6d65 7d20 3220 2d2d 7374 6174 7573 272c  me} 2 --status',
-0000ec80: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
-0000ec90: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
-0000eca0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0000ecb0: 7374 6f70 202d 7920 7b6e 616d 657d 272c  stop -y {name}',
-0000ecc0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-0000ecd0: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
-0000ece0: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
-0000ecf0: 2020 2074 696d 656f 7574 3d33 3020 2a20     timeout=30 * 
-0000ed00: 3630 2c20 2023 2063 616e 2074 616b 6520  60,  # can take 
-0000ed10: 3330 206d 696e 730a 2020 2020 290a 2020  30 mins.    ).  
-0000ed20: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-0000ed30: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
-0000ed40: 2d2d 2d20 5450 5520 564d 2050 6f64 2e20  --- TPU VM Pod. 
-0000ed50: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
-0000ed60: 7374 2e6d 6172 6b2e 6763 700a 4070 7974  st.mark.gcp.@pyt
-0000ed70: 6573 742e 6d61 726b 2e74 7075 0a64 6566  est.mark.tpu.def
-0000ed80: 2074 6573 745f 7470 755f 766d 5f70 6f64   test_tpu_vm_pod
-0000ed90: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
-0000eda0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-0000edb0: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
-0000edc0: 7374 280a 2020 2020 2020 2020 2774 7075  st(.        'tpu
-0000edd0: 5f70 6f64 272c 0a20 2020 2020 2020 205b  _pod',.        [
-0000ede0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000edf0: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
-0000ee00: 7b6e 616d 657d 2065 7861 6d70 6c65 732f  {name} examples/
-0000ee10: 7470 752f 7470 7576 6d5f 6d6e 6973 742e  tpu/tpuvm_mnist.
-0000ee20: 7961 6d6c 202d 2d67 7075 7320 7470 752d  yaml --gpus tpu-
-0000ee30: 7632 2d33 3220 2d2d 7573 652d 7370 6f74  v2-32 --use-spot
-0000ee40: 202d 2d7a 6f6e 6520 6575 726f 7065 2d77   --zone europe-w
-0000ee50: 6573 7434 2d61 272c 0a20 2020 2020 2020  est4-a',.       
-0000ee60: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-0000ee70: 7b6e 616d 657d 2031 272c 2020 2320 456e  {name} 1',  # En
-0000ee80: 7375 7265 2074 6865 206a 6f62 2066 696e  sure the job fin
-0000ee90: 6973 6865 642e 0a20 2020 2020 2020 2020  ished..         
-0000eea0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-0000eeb0: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
-0000eec0: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
-0000eed0: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
-0000eee0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-0000eef0: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-0000ef00: 7b6e 616d 657d 272c 0a20 2020 2020 2020  {name}',.       
-0000ef10: 2074 696d 656f 7574 3d33 3020 2a20 3630   timeout=30 * 60
-0000ef20: 2c20 2023 2063 616e 2074 616b 6520 3330  ,  # can take 30
-0000ef30: 206d 696e 730a 2020 2020 290a 2020 2020   mins.    ).    
-0000ef40: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-0000ef50: 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  t)...# ---------
-0000ef60: 2d20 5369 6d70 6c65 2061 7070 732e 202d  - Simple apps. -
-0000ef70: 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974 6573  ---------.@pytes
-0000ef80: 742e 6d61 726b 2e6e 6f5f 7363 7020 2023  t.mark.no_scp  #
-0000ef90: 2053 4350 2064 6f65 7320 6e6f 7420 7375   SCP does not su
-0000efa0: 7070 6f72 7420 6e75 6d5f 6e6f 6465 7320  pport num_nodes 
-0000efb0: 3e20 3120 7965 740a 6465 6620 7465 7374  > 1 yet.def test
-0000efc0: 5f6d 756c 7469 5f68 6f73 746e 616d 6528  _multi_hostname(
-0000efd0: 6765 6e65 7269 635f 636c 6f75 643a 2073  generic_cloud: s
-0000efe0: 7472 293a 0a20 2020 206e 616d 6520 3d20  tr):.    name = 
-0000eff0: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-0000f000: 6528 290a 2020 2020 746f 7461 6c5f 7469  e().    total_ti
-0000f010: 6d65 6f75 745f 6d69 6e75 7465 7320 3d20  meout_minutes = 
-0000f020: 3235 2069 6620 6765 6e65 7269 635f 636c  25 if generic_cl
-0000f030: 6f75 6420 3d3d 2027 617a 7572 6527 2065  oud == 'azure' e
-0000f040: 6c73 6520 3135 0a20 2020 2074 6573 7420  lse 15.    test 
-0000f050: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-0000f060: 276d 756c 7469 5f68 6f73 746e 616d 6527  'multi_hostname'
-0000f070: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-0000f080: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
-0000f090: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
-0000f0a0: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
-0000f0b0: 6963 5f63 6c6f 7564 7d20 6578 616d 706c  ic_cloud} exampl
-0000f0c0: 6573 2f6d 756c 7469 5f68 6f73 746e 616d  es/multi_hostnam
-0000f0d0: 652e 7961 6d6c 272c 0a20 2020 2020 2020  e.yaml',.       
-0000f0e0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-0000f0f0: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
-0000f100: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
-0000f110: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
-0000f120: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-0000f130: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
-0000f140: 207c 2067 7265 7020 224d 7920 686f 7374   | grep "My host
-0000f150: 6e61 6d65 3a22 207c 2077 6320 2d6c 207c  name:" | wc -l |
-0000f160: 2067 7265 7020 3227 2c20 2023 2045 6e73   grep 2',  # Ens
-0000f170: 7572 6520 7468 6572 6520 6172 6520 3220  ure there are 2 
-0000f180: 686f 7374 732e 0a20 2020 2020 2020 2020  hosts..         
-0000f190: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-0000f1a0: 616d 657d 2065 7861 6d70 6c65 732f 6d75  ame} examples/mu
-0000f1b0: 6c74 695f 686f 7374 6e61 6d65 2e79 616d  lti_hostname.yam
-0000f1c0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-0000f1d0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-0000f1e0: 7d20 3220 2d2d 7374 6174 7573 272c 2020  } 2 --status',  
-0000f1f0: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
-0000f200: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
-0000f210: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-0000f220: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-0000f230: 6d65 7d27 2c0a 2020 2020 2020 2020 7469  me}',.        ti
-0000f240: 6d65 6f75 743d 5f67 6574 5f74 696d 656f  meout=_get_timeo
-0000f250: 7574 2867 656e 6572 6963 5f63 6c6f 7564  ut(generic_cloud
-0000f260: 2c20 746f 7461 6c5f 7469 6d65 6f75 745f  , total_timeout_
-0000f270: 6d69 6e75 7465 7320 2a20 3630 292c 0a20  minutes * 60),. 
-0000f280: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-0000f290: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
-0000f2a0: 7974 6573 742e 6d61 726b 2e6e 6f5f 7363  ytest.mark.no_sc
-0000f2b0: 7020 2023 2053 4350 2064 6f65 7320 6e6f  p  # SCP does no
-0000f2c0: 7420 7375 7070 6f72 7420 6e75 6d5f 6e6f  t support num_no
-0000f2d0: 6465 7320 3e20 3120 7965 740a 6465 6620  des > 1 yet.def 
-0000f2e0: 7465 7374 5f6d 756c 7469 5f6e 6f64 655f  test_multi_node_
-0000f2f0: 6661 696c 7572 6528 6765 6e65 7269 635f  failure(generic_
-0000f300: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
-0000f310: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-0000f320: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-0000f330: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-0000f340: 2020 2020 2027 6d75 6c74 695f 6e6f 6465       'multi_node
-0000f350: 5f66 6169 6c75 7265 272c 0a20 2020 2020  _failure',.     
-0000f360: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-0000f370: 2023 2054 4f44 4f28 7a68 7775 293a 2077   # TODO(zhwu): w
-0000f380: 6520 7573 6520 6d75 6c74 692d 7468 7265  e use multi-thre
-0000f390: 6164 2074 6f20 7275 6e20 7468 6520 636f  ad to run the co
-0000f3a0: 6d6d 616e 6473 2069 6e20 7365 7475 700a  mmands in setup.
-0000f3b0: 2020 2020 2020 2020 2020 2020 2320 636f              # co
-0000f3c0: 6d6d 616e 6473 2069 6e20 7061 7261 6c6c  mmands in parall
-0000f3d0: 656c 2c20 7768 6963 6820 6d61 6b65 7320  el, which makes 
-0000f3e0: 6974 2069 6d70 6f73 7369 626c 6520 746f  it impossible to
-0000f3f0: 2066 6169 6c20 6661 7374 0a20 2020 2020   fail fast.     
-0000f400: 2020 2020 2020 2023 2077 6865 6e20 6f6e         # when on
-0000f410: 6520 6f66 2074 6865 206e 6f64 6573 2066  e of the nodes f
-0000f420: 6169 6c73 2e20 5765 2073 686f 756c 6420  ails. We should 
-0000f430: 6669 7820 7468 6973 2069 6e20 7468 6520  fix this in the 
-0000f440: 6675 7475 7265 2e0a 2020 2020 2020 2020  future..        
-0000f450: 2020 2020 2320 5468 6520 2d2d 6465 7461      # The --deta
-0000f460: 6368 2d73 6574 7570 2076 6572 7369 6f6e  ch-setup version
-0000f470: 2063 616e 2066 6169 6c20 6661 7374 2c20   can fail fast, 
-0000f480: 6173 2074 6865 2073 6574 7570 2069 730a  as the setup is.
-0000f490: 2020 2020 2020 2020 2020 2020 2320 7375              # su
-0000f4a0: 626d 6974 7465 6420 746f 2074 6865 2072  bmitted to the r
-0000f4b0: 656d 6f74 6520 6d61 6368 696e 652c 2077  emote machine, w
-0000f4c0: 6869 6368 2064 6f65 7320 6e6f 7420 7573  hich does not us
-0000f4d0: 6520 6d75 6c74 692d 7468 7265 6164 2e0a  e multi-thread..
-0000f4e0: 2020 2020 2020 2020 2020 2020 2320 5265              # Re
-0000f4f0: 6665 7220 746f 2074 6865 2063 6f6d 6d65  fer to the comme
-0000f500: 6e74 2069 6e20 6073 7562 7072 6f63 6573  nt in `subproces
-0000f510: 735f 7574 696c 732e 7275 6e5f 696e 5f70  s_utils.run_in_p
-0000f520: 6172 616c 6c65 6c60 2e0a 2020 2020 2020  arallel`..      
-0000f530: 2020 2020 2020 2320 6627 736b 7920 6c61        # f'sky la
-0000f540: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
-0000f550: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
-0000f560: 6963 5f63 6c6f 7564 7d20 7465 7374 732f  ic_cloud} tests/
-0000f570: 7465 7374 5f79 616d 6c73 2f66 6169 6c65  test_yamls/faile
-0000f580: 645f 776f 726b 6572 5f73 6574 7570 2e79  d_worker_setup.y
-0000f590: 616d 6c20 2626 2065 7869 7420 3127 2c20  aml && exit 1', 
-0000f5a0: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
-0000f5b0: 6220 7365 7475 7020 6661 696c 6564 2e0a  b setup failed..
-0000f5c0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000f5d0: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
-0000f5e0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
-0000f5f0: 656e 6572 6963 5f63 6c6f 7564 7d20 2d2d  eneric_cloud} --
-0000f600: 6465 7461 6368 2d73 6574 7570 2074 6573  detach-setup tes
-0000f610: 7473 2f74 6573 745f 7961 6d6c 732f 6661  ts/test_yamls/fa
-0000f620: 696c 6564 5f77 6f72 6b65 725f 7365 7475  iled_worker_setu
-0000f630: 702e 7961 6d6c 272c 0a20 2020 2020 2020  p.yaml',.       
-0000f640: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-0000f650: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
-0000f660: 7320 7c20 6772 6570 2046 4149 4c45 445f  s | grep FAILED_
-0000f670: 5345 5455 5027 2c20 2023 2045 6e73 7572  SETUP',  # Ensur
-0000f680: 6520 7468 6520 6a6f 6220 7365 7475 7020  e the job setup 
-0000f690: 6661 696c 6564 2e0a 2020 2020 2020 2020  failed..        
-0000f6a0: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-0000f6b0: 6e61 6d65 7d20 7465 7374 732f 7465 7374  name} tests/test
-0000f6c0: 5f79 616d 6c73 2f66 6169 6c65 645f 776f  _yamls/failed_wo
-0000f6d0: 726b 6572 5f72 756e 2e79 616d 6c27 2c0a  rker_run.yaml',.
-0000f6e0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0000f6f0: 7920 6c6f 6773 207b 6e61 6d65 7d20 3220  y logs {name} 2 
-0000f700: 2d2d 7374 6174 7573 207c 2067 7265 7020  --status | grep 
-0000f710: 4641 494c 4544 272c 2020 2320 456e 7375  FAILED',  # Ensu
-0000f720: 7265 2074 6865 206a 6f62 2066 6169 6c65  re the job faile
-0000f730: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
-0000f740: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-0000f750: 2032 207c 2067 7265 7020 224d 7920 686f   2 | grep "My ho
-0000f760: 7374 6e61 6d65 3a22 207c 2077 6320 2d6c  stname:" | wc -l
-0000f770: 207c 2067 7265 7020 3227 2c20 2023 2045   | grep 2',  # E
-0000f780: 6e73 7572 6520 7468 6572 6520 3220 6f66  nsure there 2 of
-0000f790: 2074 6865 2068 6f73 7473 2070 7269 6e74   the hosts print
-0000f7a0: 6564 2074 6865 6972 2068 6f73 746e 616d  ed their hostnam
-0000f7b0: 652e 0a20 2020 2020 2020 205d 2c0a 2020  e..        ],.  
-0000f7c0: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-0000f7d0: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-0000f7e0: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-0000f7f0: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
-0000f800: 2d2d 2d2d 2d2d 2d2d 2057 6562 2061 7070  -------- Web app
-0000f810: 7320 7769 7468 2063 7573 746f 6d20 706f  s with custom po
-0000f820: 7274 7320 6f6e 2047 4350 2e20 2d2d 2d2d  rts on GCP. ----
-0000f830: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
-0000f840: 6172 6b2e 6763 700a 6465 6620 7465 7374  ark.gcp.def test
-0000f850: 5f67 6370 5f68 7474 705f 7365 7276 6572  _gcp_http_server
-0000f860: 5f77 6974 685f 6375 7374 6f6d 5f70 6f72  _with_custom_por
-0000f870: 7473 2829 3a0a 2020 2020 6e61 6d65 203d  ts():.    name =
-0000f880: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-0000f890: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-0000f8a0: 5465 7374 280a 2020 2020 2020 2020 2767  Test(.        'g
-0000f8b0: 6370 5f68 7474 705f 7365 7276 6572 5f77  cp_http_server_w
-0000f8c0: 6974 685f 6375 7374 6f6d 5f70 6f72 7473  ith_custom_ports
-0000f8d0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-0000f8e0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-0000f8f0: 6175 6e63 6820 2d79 202d 6420 2d63 207b  aunch -y -d -c {
-0000f900: 6e61 6d65 7d20 2d2d 636c 6f75 6420 6763  name} --cloud gc
-0000f910: 7020 6578 616d 706c 6573 2f68 7474 705f  p examples/http_
-0000f920: 7365 7276 6572 5f77 6974 685f 6375 7374  server_with_cust
-0000f930: 6f6d 5f70 6f72 7473 2f74 6173 6b2e 7961  om_ports/task.ya
-0000f940: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-0000f950: 2066 2775 6e74 696c 2053 4b59 5049 4c4f   f'until SKYPILO
-0000f960: 545f 4445 4255 473d 3020 736b 7920 7374  T_DEBUG=0 sky st
-0000f970: 6174 7573 202d 2d65 6e64 706f 696e 7420  atus --endpoint 
-0000f980: 3333 3832 3820 7b6e 616d 657d 3b20 646f  33828 {name}; do
-0000f990: 2073 6c65 6570 2031 303b 2064 6f6e 6527   sleep 10; done'
-0000f9a0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-0000f9b0: 5265 7472 7920 6120 6665 7720 7469 6d65  Retry a few time
-0000f9c0: 7320 746f 2061 766f 6964 2066 6c61 6b69  s to avoid flaki
-0000f9d0: 6e65 7373 2069 6e20 706f 7274 7320 6265  ness in ports be
-0000f9e0: 696e 6720 6f70 656e 2e0a 2020 2020 2020  ing open..      
-0000f9f0: 2020 2020 2020 6627 6970 3d24 2853 4b59        f'ip=$(SKY
-0000fa00: 5049 4c4f 545f 4445 4255 473d 3020 736b  PILOT_DEBUG=0 sk
-0000fa10: 7920 7374 6174 7573 202d 2d65 6e64 706f  y status --endpo
-0000fa20: 696e 7420 3333 3832 3820 7b6e 616d 657d  int 33828 {name}
-0000fa30: 293b 2073 7563 6365 7373 3d66 616c 7365  ); success=false
-0000fa40: 3b20 666f 7220 6920 696e 2024 2873 6571  ; for i in $(seq
-0000fa50: 2031 2035 293b 2064 6f20 6966 2063 7572   1 5); do if cur
-0000fa60: 6c20 2469 7020 7c20 6772 6570 2022 3c68  l $ip | grep "<h
-0000fa70: 313e 5468 6973 2069 7320 6120 6465 6d6f  1>This is a demo
-0000fa80: 2048 544d 4c20 7061 6765 2e3c 2f68 313e   HTML page.</h1>
-0000fa90: 223b 2074 6865 6e20 7375 6363 6573 733d  "; then success=
-0000faa0: 7472 7565 3b20 6272 6561 6b3b 2066 693b  true; break; fi;
-0000fab0: 2073 6c65 6570 2031 303b 2064 6f6e 653b   sleep 10; done;
-0000fac0: 2069 6620 5b20 2224 7375 6363 6573 7322   if [ "$success"
-0000fad0: 203d 2066 616c 7365 205d 3b20 7468 656e   = false ]; then
-0000fae0: 2065 7869 7420 313b 2066 6927 2c0a 2020   exit 1; fi',.  
-0000faf0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-0000fb00: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
-0000fb10: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
-0000fb20: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
-0000fb30: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
-0000fb40: 2d2d 2d20 5765 6220 6170 7073 2077 6974  --- Web apps wit
-0000fb50: 6820 6375 7374 6f6d 2070 6f72 7473 206f  h custom ports o
-0000fb60: 6e20 4157 532e 202d 2d2d 2d2d 2d2d 2d2d  n AWS. ---------
-0000fb70: 2d0a 4070 7974 6573 742e 6d61 726b 2e61  -.@pytest.mark.a
-0000fb80: 7773 0a64 6566 2074 6573 745f 6177 735f  ws.def test_aws_
-0000fb90: 6874 7470 5f73 6572 7665 725f 7769 7468  http_server_with
-0000fba0: 5f63 7573 746f 6d5f 706f 7274 7328 293a  _custom_ports():
-0000fbb0: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-0000fbc0: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-0000fbd0: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-0000fbe0: 0a20 2020 2020 2020 2027 6177 735f 6874  .        'aws_ht
-0000fbf0: 7470 5f73 6572 7665 725f 7769 7468 5f63  tp_server_with_c
-0000fc00: 7573 746f 6d5f 706f 7274 7327 2c0a 2020  ustom_ports',.  
-0000fc10: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-0000fc20: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-0000fc30: 202d 7920 2d64 202d 6320 7b6e 616d 657d   -y -d -c {name}
-0000fc40: 202d 2d63 6c6f 7564 2061 7773 2065 7861   --cloud aws exa
-0000fc50: 6d70 6c65 732f 6874 7470 5f73 6572 7665  mples/http_serve
-0000fc60: 725f 7769 7468 5f63 7573 746f 6d5f 706f  r_with_custom_po
-0000fc70: 7274 732f 7461 736b 2e79 616d 6c27 2c0a  rts/task.yaml',.
-0000fc80: 2020 2020 2020 2020 2020 2020 6627 756e              f'un
-0000fc90: 7469 6c20 534b 5950 494c 4f54 5f44 4542  til SKYPILOT_DEB
-0000fca0: 5547 3d30 2073 6b79 2073 7461 7475 7320  UG=0 sky status 
-0000fcb0: 2d2d 656e 6470 6f69 6e74 2033 3338 3238  --endpoint 33828
-0000fcc0: 207b 6e61 6d65 7d3b 2064 6f20 736c 6565   {name}; do slee
-0000fcd0: 7020 3130 3b20 646f 6e65 272c 0a20 2020  p 10; done',.   
-0000fce0: 2020 2020 2020 2020 2023 2052 6574 7279           # Retry
-0000fcf0: 2061 2066 6577 2074 696d 6573 2074 6f20   a few times to 
-0000fd00: 6176 6f69 6420 666c 616b 696e 6573 7320  avoid flakiness 
-0000fd10: 696e 2070 6f72 7473 2062 6569 6e67 206f  in ports being o
-0000fd20: 7065 6e2e 0a20 2020 2020 2020 2020 2020  pen..           
-0000fd30: 2066 2769 703d 2428 534b 5950 494c 4f54   f'ip=$(SKYPILOT
-0000fd40: 5f44 4542 5547 3d30 2073 6b79 2073 7461  _DEBUG=0 sky sta
-0000fd50: 7475 7320 2d2d 656e 6470 6f69 6e74 2033  tus --endpoint 3
-0000fd60: 3338 3238 207b 6e61 6d65 7d29 3b20 7375  3828 {name}); su
-0000fd70: 6363 6573 733d 6661 6c73 653b 2066 6f72  ccess=false; for
-0000fd80: 2069 2069 6e20 2428 7365 7120 3120 3529   i in $(seq 1 5)
-0000fd90: 3b20 646f 2069 6620 6375 726c 2024 6970  ; do if curl $ip
-0000fda0: 207c 2067 7265 7020 223c 6831 3e54 6869   | grep "<h1>Thi
-0000fdb0: 7320 6973 2061 2064 656d 6f20 4854 4d4c  s is a demo HTML
-0000fdc0: 2070 6167 652e 3c2f 6831 3e22 3b20 7468   page.</h1>"; th
-0000fdd0: 656e 2073 7563 6365 7373 3d74 7275 653b  en success=true;
-0000fde0: 2062 7265 616b 3b20 6669 3b20 736c 6565   break; fi; slee
-0000fdf0: 7020 3130 3b20 646f 6e65 3b20 6966 205b  p 10; done; if [
-0000fe00: 2022 2473 7563 6365 7373 2220 3d20 6661   "$success" = fa
-0000fe10: 6c73 6520 5d3b 2074 6865 6e20 6578 6974  lse ]; then exit
-0000fe20: 2031 3b20 6669 270a 2020 2020 2020 2020   1; fi'.        
-0000fe30: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
-0000fe40: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-0000fe50: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
-0000fe60: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-0000fe70: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5765  .# ---------- We
-0000fe80: 6220 6170 7073 2077 6974 6820 6375 7374  b apps with cust
-0000fe90: 6f6d 2070 6f72 7473 206f 6e20 417a 7572  om ports on Azur
-0000fea0: 652e 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070  e. ----------.@p
-0000feb0: 7974 6573 742e 6d61 726b 2e61 7a75 7265  ytest.mark.azure
-0000fec0: 0a64 6566 2074 6573 745f 617a 7572 655f  .def test_azure_
-0000fed0: 6874 7470 5f73 6572 7665 725f 7769 7468  http_server_with
-0000fee0: 5f63 7573 746f 6d5f 706f 7274 7328 293a  _custom_ports():
-0000fef0: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-0000ff00: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-0000ff10: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-0000ff20: 0a20 2020 2020 2020 2027 617a 7572 655f  .        'azure_
-0000ff30: 6874 7470 5f73 6572 7665 725f 7769 7468  http_server_with
-0000ff40: 5f63 7573 746f 6d5f 706f 7274 7327 2c0a  _custom_ports',.
-0000ff50: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-0000ff60: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-0000ff70: 6368 202d 7920 2d64 202d 6320 7b6e 616d  ch -y -d -c {nam
-0000ff80: 657d 202d 2d63 6c6f 7564 2061 7a75 7265  e} --cloud azure
-0000ff90: 2065 7861 6d70 6c65 732f 6874 7470 5f73   examples/http_s
-0000ffa0: 6572 7665 725f 7769 7468 5f63 7573 746f  erver_with_custo
-0000ffb0: 6d5f 706f 7274 732f 7461 736b 2e79 616d  m_ports/task.yam
-0000ffc0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-0000ffd0: 6627 756e 7469 6c20 534b 5950 494c 4f54  f'until SKYPILOT
-0000ffe0: 5f44 4542 5547 3d30 2073 6b79 2073 7461  _DEBUG=0 sky sta
-0000fff0: 7475 7320 2d2d 656e 6470 6f69 6e74 2033  tus --endpoint 3
-00010000: 3338 3238 207b 6e61 6d65 7d3b 2064 6f20  3828 {name}; do 
-00010010: 736c 6565 7020 3130 3b20 646f 6e65 272c  sleep 10; done',
-00010020: 0a20 2020 2020 2020 2020 2020 2023 2052  .            # R
-00010030: 6574 7279 2061 2066 6577 2074 696d 6573  etry a few times
-00010040: 2074 6f20 6176 6f69 6420 666c 616b 696e   to avoid flakin
-00010050: 6573 7320 696e 2070 6f72 7473 2062 6569  ess in ports bei
-00010060: 6e67 206f 7065 6e2e 0a20 2020 2020 2020  ng open..       
-00010070: 2020 2020 2066 2769 703d 2428 534b 5950       f'ip=$(SKYP
-00010080: 494c 4f54 5f44 4542 5547 3d30 2073 6b79  ILOT_DEBUG=0 sky
-00010090: 2073 7461 7475 7320 2d2d 656e 6470 6f69   status --endpoi
-000100a0: 6e74 2033 3338 3238 207b 6e61 6d65 7d29  nt 33828 {name})
-000100b0: 3b20 7375 6363 6573 733d 6661 6c73 653b  ; success=false;
-000100c0: 2066 6f72 2069 2069 6e20 2428 7365 7120   for i in $(seq 
-000100d0: 3120 3529 3b20 646f 2069 6620 6375 726c  1 5); do if curl
-000100e0: 2024 6970 207c 2067 7265 7020 223c 6831   $ip | grep "<h1
-000100f0: 3e54 6869 7320 6973 2061 2064 656d 6f20  >This is a demo 
-00010100: 4854 4d4c 2070 6167 652e 3c2f 6831 3e22  HTML page.</h1>"
-00010110: 3b20 7468 656e 2073 7563 6365 7373 3d74  ; then success=t
-00010120: 7275 653b 2062 7265 616b 3b20 6669 3b20  rue; break; fi; 
-00010130: 736c 6565 7020 3130 3b20 646f 6e65 3b20  sleep 10; done; 
-00010140: 6966 205b 2022 2473 7563 6365 7373 2220  if [ "$success" 
-00010150: 3d20 6661 6c73 6520 5d3b 2074 6865 6e20  = false ]; then 
-00010160: 6578 6974 2031 3b20 6669 270a 2020 2020  exit 1; fi'.    
-00010170: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-00010180: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-00010190: 6d65 7d27 2c0a 2020 2020 290a 2020 2020  me}',.    ).    
-000101a0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-000101b0: 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  t)...# ---------
-000101c0: 2d20 5765 6220 6170 7073 2077 6974 6820  - Web apps with 
-000101d0: 6375 7374 6f6d 2070 6f72 7473 206f 6e20  custom ports on 
-000101e0: 4b75 6265 726e 6574 6573 2e20 2d2d 2d2d  Kubernetes. ----
-000101f0: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
-00010200: 6172 6b2e 6b75 6265 726e 6574 6573 0a64  ark.kubernetes.d
-00010210: 6566 2074 6573 745f 6b75 6265 726e 6574  ef test_kubernet
-00010220: 6573 5f68 7474 705f 7365 7276 6572 5f77  es_http_server_w
-00010230: 6974 685f 6375 7374 6f6d 5f70 6f72 7473  ith_custom_ports
-00010240: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
-00010250: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-00010260: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
-00010270: 7374 280a 2020 2020 2020 2020 276b 7562  st(.        'kub
-00010280: 6572 6e65 7465 735f 6874 7470 5f73 6572  ernetes_http_ser
-00010290: 7665 725f 7769 7468 5f63 7573 746f 6d5f  ver_with_custom_
-000102a0: 706f 7274 7327 2c0a 2020 2020 2020 2020  ports',.        
-000102b0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
-000102c0: 736b 7920 6c61 756e 6368 202d 7920 2d64  sky launch -y -d
-000102d0: 202d 6320 7b6e 616d 657d 202d 2d63 6c6f   -c {name} --clo
-000102e0: 7564 206b 7562 6572 6e65 7465 7320 6578  ud kubernetes ex
-000102f0: 616d 706c 6573 2f68 7474 705f 7365 7276  amples/http_serv
-00010300: 6572 5f77 6974 685f 6375 7374 6f6d 5f70  er_with_custom_p
-00010310: 6f72 7473 2f74 6173 6b2e 7961 6d6c 272c  orts/task.yaml',
-00010320: 0a20 2020 2020 2020 2020 2020 2066 2775  .            f'u
-00010330: 6e74 696c 2053 4b59 5049 4c4f 545f 4445  ntil SKYPILOT_DE
-00010340: 4255 473d 3020 736b 7920 7374 6174 7573  BUG=0 sky status
-00010350: 202d 2d65 6e64 706f 696e 7420 3333 3832   --endpoint 3382
-00010360: 3820 7b6e 616d 657d 3b20 646f 2073 6c65  8 {name}; do sle
-00010370: 6570 2031 303b 2064 6f6e 6527 2c0a 2020  ep 10; done',.  
-00010380: 2020 2020 2020 2020 2020 2320 5265 7472            # Retr
-00010390: 7920 6120 6665 7720 7469 6d65 7320 746f  y a few times to
-000103a0: 2061 766f 6964 2066 6c61 6b69 6e65 7373   avoid flakiness
-000103b0: 2069 6e20 706f 7274 7320 6265 696e 6720   in ports being 
-000103c0: 6f70 656e 2e0a 2020 2020 2020 2020 2020  open..          
-000103d0: 2020 6627 6970 3d24 2853 4b59 5049 4c4f    f'ip=$(SKYPILO
-000103e0: 545f 4445 4255 473d 3020 736b 7920 7374  T_DEBUG=0 sky st
-000103f0: 6174 7573 202d 2d65 6e64 706f 696e 7420  atus --endpoint 
-00010400: 3333 3832 3820 7b6e 616d 657d 293b 2073  33828 {name}); s
-00010410: 7563 6365 7373 3d66 616c 7365 3b20 666f  uccess=false; fo
-00010420: 7220 6920 696e 2024 2873 6571 2031 2031  r i in $(seq 1 1
-00010430: 3030 293b 2064 6f20 6966 2063 7572 6c20  00); do if curl 
-00010440: 2469 7020 7c20 6772 6570 2022 3c68 313e  $ip | grep "<h1>
-00010450: 5468 6973 2069 7320 6120 6465 6d6f 2048  This is a demo H
-00010460: 544d 4c20 7061 6765 2e3c 2f68 313e 223b  TML page.</h1>";
-00010470: 2074 6865 6e20 7375 6363 6573 733d 7472   then success=tr
-00010480: 7565 3b20 6272 6561 6b3b 2066 693b 2073  ue; break; fi; s
-00010490: 6c65 6570 2035 3b20 646f 6e65 3b20 6966  leep 5; done; if
-000104a0: 205b 2022 2473 7563 6365 7373 2220 3d20   [ "$success" = 
-000104b0: 6661 6c73 6520 5d3b 2074 6865 6e20 6578  false ]; then ex
-000104c0: 6974 2031 3b20 6669 270a 2020 2020 2020  it 1; fi'.      
-000104d0: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
-000104e0: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-000104f0: 7d27 2c0a 2020 2020 290a 2020 2020 7275  }',.    ).    ru
-00010500: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-00010510: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
-00010520: 5461 736b 3a20 6e3d 3220 6e6f 6465 7320  Task: n=2 nodes 
-00010530: 7769 7468 2073 6574 7570 732e 202d 2d2d  with setups. ---
-00010540: 2d2d 2d2d 2d2d 2d0a 4070 7974 6573 742e  -------.@pytest.
-00010550: 6d61 726b 2e6e 6f5f 6c61 6d62 6461 5f63  mark.no_lambda_c
-00010560: 6c6f 7564 2020 2320 4c61 6d62 6461 2043  loud  # Lambda C
-00010570: 6c6f 7564 2064 6f65 7320 6e6f 7420 6861  loud does not ha
-00010580: 7665 2056 3130 3020 6770 7573 0a40 7079  ve V100 gpus.@py
-00010590: 7465 7374 2e6d 6172 6b2e 6e6f 5f69 626d  test.mark.no_ibm
-000105a0: 2020 2320 4942 4d20 636c 6f75 6420 6375    # IBM cloud cu
-000105b0: 7272 656e 746c 7920 646f 6573 6e27 7420  rrently doesn't 
-000105c0: 7072 6f76 6964 6520 7075 626c 6963 2069  provide public i
-000105d0: 6d61 6765 2077 6974 6820 4355 4441 0a40  mage with CUDA.@
-000105e0: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f73  pytest.mark.no_s
-000105f0: 6370 2020 2320 5343 5020 646f 6573 206e  cp  # SCP does n
-00010600: 6f74 2073 7570 706f 7274 206e 756d 5f6e  ot support num_n
-00010610: 6f64 6573 203e 2031 2079 6574 0a40 7079  odes > 1 yet.@py
-00010620: 7465 7374 2e6d 6172 6b2e 736b 6970 280a  test.mark.skip(.
-00010630: 2020 2020 7265 6173 6f6e 3d0a 2020 2020      reason=.    
-00010640: 2754 6865 2072 6573 6e65 745f 6469 7374  'The resnet_dist
-00010650: 7269 6275 7465 645f 7466 5f61 7070 2069  ributed_tf_app i
-00010660: 7320 666c 616b 792c 2064 7565 2074 6f20  s flaky, due to 
-00010670: 6974 2066 6169 6c69 6e67 2074 6f20 6465  it failing to de
-00010680: 7465 6374 2047 5055 732e 2729 0a64 6566  tect GPUs.').def
-00010690: 2074 6573 745f 6469 7374 7269 6275 7465   test_distribute
-000106a0: 645f 7466 2867 656e 6572 6963 5f63 6c6f  d_tf(generic_clo
-000106b0: 7564 3a20 7374 7229 3a0a 2020 2020 6e61  ud: str):.    na
-000106c0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-000106d0: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
-000106e0: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-000106f0: 2020 2772 6573 6e65 745f 6469 7374 7269    'resnet_distri
-00010700: 6275 7465 645f 7466 5f61 7070 272c 0a20  buted_tf_app',. 
-00010710: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-00010720: 2020 2020 2023 204e 4f54 453a 2072 756e       # NOTE: run
-00010730: 6e69 6e67 2069 7420 7477 6963 6520 7769  ning it twice wi
-00010740: 6c6c 2068 616e 6720 2873 6f6d 6574 696d  ll hang (sometim
-00010750: 6573 3f29 202d 2061 6e20 6170 702d 6c65  es?) - an app-le
-00010760: 7665 6c20 6275 672e 0a20 2020 2020 2020  vel bug..       
-00010770: 2020 2020 2066 2770 7974 686f 6e20 6578       f'python ex
-00010780: 616d 706c 6573 2f72 6573 6e65 745f 6469  amples/resnet_di
-00010790: 7374 7269 6275 7465 645f 7466 5f61 7070  stributed_tf_app
-000107a0: 2e70 7920 7b6e 616d 657d 207b 6765 6e65  .py {name} {gene
-000107b0: 7269 635f 636c 6f75 647d 272c 0a20 2020  ric_cloud}',.   
-000107c0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-000107d0: 6f67 7320 7b6e 616d 657d 2031 202d 2d73  ogs {name} 1 --s
-000107e0: 7461 7475 7327 2c20 2023 2045 6e73 7572  tatus',  # Ensur
-000107f0: 6520 7468 6520 6a6f 6220 7375 6363 6565  e the job succee
-00010800: 6465 642e 0a20 2020 2020 2020 205d 2c0a  ded..        ],.
-00010810: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
-00010820: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
-00010830: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
-00010840: 3520 2a20 3630 2c20 2023 2032 3520 6d69  5 * 60,  # 25 mi
-00010850: 6e73 2028 6974 2074 616b 6573 2061 726f  ns (it takes aro
-00010860: 756e 6420 7e31 3920 6d69 6e73 290a 2020  und ~19 mins).  
-00010870: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-00010880: 7465 7374 2874 6573 7429 0a0a 0a23 202d  test(test)...# -
-00010890: 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374 696e  --------- Testin
-000108a0: 6720 4743 5020 7374 6172 7420 616e 6420  g GCP start and 
-000108b0: 7374 6f70 2069 6e73 7461 6e63 6573 202d  stop instances -
-000108c0: 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974 6573  ---------.@pytes
-000108d0: 742e 6d61 726b 2e67 6370 0a64 6566 2074  t.mark.gcp.def t
-000108e0: 6573 745f 6763 705f 7374 6172 745f 7374  est_gcp_start_st
-000108f0: 6f70 2829 3a0a 2020 2020 6e61 6d65 203d  op():.    name =
-00010900: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-00010910: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-00010920: 5465 7374 280a 2020 2020 2020 2020 2767  Test(.        'g
-00010930: 6370 2d73 7461 7274 2d73 746f 7027 2c0a  cp-start-stop',.
-00010940: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-00010950: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-00010960: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
-00010970: 6578 616d 706c 6573 2f67 6370 5f73 7461  examples/gcp_sta
-00010980: 7274 5f73 746f 702e 7961 6d6c 272c 0a20  rt_stop.yaml',. 
-00010990: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-000109a0: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
-000109b0: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
-000109c0: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
-000109d0: 6565 6465 642e 0a20 2020 2020 2020 2020  eeded..         
-000109e0: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-000109f0: 616d 657d 2065 7861 6d70 6c65 732f 6763  ame} examples/gc
-00010a00: 705f 7374 6172 745f 7374 6f70 2e79 616d  p_start_stop.yam
-00010a10: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-00010a20: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-00010a30: 7d20 3220 2d2d 7374 6174 7573 272c 2020  } 2 --status',  
-00010a40: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
-00010a50: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
-00010a60: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-00010a70: 6563 207b 6e61 6d65 7d20 2270 726c 696d  ec {name} "prlim
-00010a80: 6974 202d 6e20 2d2d 7069 643d 5c24 2870  it -n --pid=\$(p
-00010a90: 6772 6570 202d 6620 5c27 7261 796c 6574  grep -f \'raylet
-00010aa0: 2f72 6179 6c65 7420 2d2d 7261 796c 6574  /raylet --raylet
-00010ab0: 5f73 6f63 6b65 745f 6e61 6d65 5c27 2920  _socket_name\') 
-00010ac0: 7c20 6772 6570 205c 2722 5c27 3130 3438  | grep \'"\'1048
-00010ad0: 3537 3620 3130 3438 3537 365c 2722 5c27  576 1048576\'"\'
-00010ae0: 2227 2c20 2023 2045 6e73 7572 6520 7468  "',  # Ensure th
-00010af0: 6520 7261 796c 6574 2070 726f 6365 7373  e raylet process
-00010b00: 2068 6173 2074 6865 2063 6f72 7265 6374   has the correct
-00010b10: 2066 696c 6520 6465 7363 7269 7074 6f72   file descriptor
-00010b20: 206c 696d 6974 2e0a 2020 2020 2020 2020   limit..        
-00010b30: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
-00010b40: 6e61 6d65 7d20 3320 2d2d 7374 6174 7573  name} 3 --status
-00010b50: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
-00010b60: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
-00010b70: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00010b80: 7920 7374 6f70 202d 7920 7b6e 616d 657d  y stop -y {name}
-00010b90: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00010ba0: 2773 6c65 6570 2032 3027 2c0a 2020 2020  'sleep 20',.    
-00010bb0: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
-00010bc0: 6172 7420 2d79 207b 6e61 6d65 7d20 2d69  art -y {name} -i
-00010bd0: 2031 272c 0a20 2020 2020 2020 2020 2020   1',.           
-00010be0: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-00010bf0: 657d 2065 7861 6d70 6c65 732f 6763 705f  e} examples/gcp_
-00010c00: 7374 6172 745f 7374 6f70 2e79 616d 6c27  start_stop.yaml'
-00010c10: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00010c20: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-00010c30: 3420 2d2d 7374 6174 7573 272c 2020 2320  4 --status',  # 
-00010c40: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
-00010c50: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
-00010c60: 2020 2020 2020 2773 6c65 6570 2031 3830        'sleep 180
-00010c70: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00010c80: 2773 6b79 2073 7461 7475 7320 2d72 207b  'sky status -r {
-00010c90: 6e61 6d65 7d20 7c20 6772 6570 2022 494e  name} | grep "IN
-00010ca0: 4954 5c7c 5354 4f50 5045 4422 272c 0a20  IT\|STOPPED"',. 
-00010cb0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00010cc0: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-00010cd0: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
-00010ce0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00010cf0: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
-00010d00: 2d2d 2d2d 2054 6573 7469 6e67 2041 7a75  ---- Testing Azu
-00010d10: 7265 2073 7461 7274 2061 6e64 2073 746f  re start and sto
-00010d20: 7020 696e 7374 616e 6365 7320 2d2d 2d2d  p instances ----
-00010d30: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
-00010d40: 6172 6b2e 617a 7572 650a 6465 6620 7465  ark.azure.def te
-00010d50: 7374 5f61 7a75 7265 5f73 7461 7274 5f73  st_azure_start_s
-00010d60: 746f 7028 293a 0a20 2020 206e 616d 6520  top():.    name 
-00010d70: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-00010d80: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
-00010d90: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-00010da0: 617a 7572 652d 7374 6172 742d 7374 6f70  azure-start-stop
-00010db0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-00010dc0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
-00010dd0: 6175 6e63 6820 2d79 202d 6320 7b6e 616d  aunch -y -c {nam
-00010de0: 657d 2065 7861 6d70 6c65 732f 617a 7572  e} examples/azur
-00010df0: 655f 7374 6172 745f 7374 6f70 2e79 616d  e_start_stop.yam
-00010e00: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
-00010e10: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
-00010e20: 7d20 6578 616d 706c 6573 2f61 7a75 7265  } examples/azure
-00010e30: 5f73 7461 7274 5f73 746f 702e 7961 6d6c  _start_stop.yaml
-00010e40: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00010e50: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00010e60: 2031 202d 2d73 7461 7475 7327 2c20 2023   1 --status',  #
-00010e70: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
-00010e80: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
-00010e90: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-00010ea0: 6320 7b6e 616d 657d 2022 7072 6c69 6d69  c {name} "prlimi
-00010eb0: 7420 2d6e 202d 2d70 6964 3d5c 2428 7067  t -n --pid=\$(pg
-00010ec0: 7265 7020 2d66 205c 2772 6179 6c65 742f  rep -f \'raylet/
-00010ed0: 7261 796c 6574 202d 2d72 6179 6c65 745f  raylet --raylet_
-00010ee0: 736f 636b 6574 5f6e 616d 655c 2729 207c  socket_name\') |
-00010ef0: 2067 7265 7020 5c27 225c 2731 3034 3835   grep \'"\'10485
-00010f00: 3736 2031 3034 3835 3736 5c27 225c 2722  76 1048576\'"\'"
+000079d0: 0a0a 4070 7974 6573 742e 6d61 726b 2e61  ..@pytest.mark.a
+000079e0: 7773 0a64 6566 2074 6573 745f 696d 6167  ws.def test_imag
+000079f0: 655f 6e6f 5f63 6f6e 6461 2829 3a0a 2020  e_no_conda():.  
+00007a00: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+00007a10: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+00007a20: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+00007a30: 2020 2020 2020 2769 6d61 6765 5f6e 6f5f        'image_no_
+00007a40: 636f 6e64 6127 2c0a 2020 2020 2020 2020  conda',.        
+00007a50: 5b0a 2020 2020 2020 2020 2020 2020 2320  [.            # 
+00007a60: 5573 6520 696d 6167 6520 6964 2064 6963  Use image id dic
+00007a70: 742e 0a20 2020 2020 2020 2020 2020 2066  t..            f
+00007a80: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+00007a90: 6320 7b6e 616d 657d 202d 2d72 6567 696f  c {name} --regio
+00007aa0: 6e20 7573 2d65 6173 742d 3220 6578 616d  n us-east-2 exam
+00007ab0: 706c 6573 2f70 6572 5f72 6567 696f 6e5f  ples/per_region_
+00007ac0: 696d 6167 6573 2e79 616d 6c27 2c0a 2020  images.yaml',.  
+00007ad0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00007ae0: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
+00007af0: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
+00007b00: 2020 2020 2066 2773 6b79 2073 746f 7020       f'sky stop 
+00007b10: 7b6e 616d 657d 202d 7927 2c0a 2020 2020  {name} -y',.    
+00007b20: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
+00007b30: 6172 7420 7b6e 616d 657d 202d 7927 2c0a  art {name} -y',.
+00007b40: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00007b50: 7920 6578 6563 207b 6e61 6d65 7d20 6578  y exec {name} ex
+00007b60: 616d 706c 6573 2f70 6572 5f72 6567 696f  amples/per_regio
+00007b70: 6e5f 696d 6167 6573 2e79 616d 6c27 2c0a  n_images.yaml',.
+00007b80: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00007b90: 7920 6c6f 6773 207b 6e61 6d65 7d20 3220  y logs {name} 2 
+00007ba0: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
+00007bb0: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
+00007bc0: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
+00007bd0: 657d 272c 0a20 2020 2029 0a20 2020 2072  e}',.    ).    r
+00007be0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+00007bf0: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+00007c00: 2e6e 6f5f 6b75 6265 726e 6574 6573 2020  .no_kubernetes  
+00007c10: 2320 4b75 6265 726e 6574 6573 2064 6f65  # Kubernetes doe
+00007c20: 7320 6e6f 7420 7375 7070 6f72 7420 7374  s not support st
+00007c30: 6f70 7069 6e67 2069 6e73 7461 6e63 6573  opping instances
+00007c40: 0a64 6566 2074 6573 745f 6375 7374 6f6d  .def test_custom
+00007c50: 5f64 6566 6175 6c74 5f63 6f6e 6461 5f65  _default_conda_e
+00007c60: 6e76 2867 656e 6572 6963 5f63 6c6f 7564  nv(generic_cloud
+00007c70: 3a20 7374 7229 3a0a 2020 2020 6e61 6d65  : str):.    name
+00007c80: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+00007c90: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+00007ca0: 3d20 5465 7374 2827 6375 7374 6f6d 5f64  = Test('custom_d
+00007cb0: 6566 6175 6c74 5f63 6f6e 6461 5f65 6e76  efault_conda_env
+00007cc0: 272c 205b 0a20 2020 2020 2020 2066 2773  ', [.        f's
+00007cd0: 6b79 206c 6175 6e63 6820 2d63 207b 6e61  ky launch -c {na
+00007ce0: 6d65 7d20 2d79 202d 2d63 6c6f 7564 207b  me} -y --cloud {
+00007cf0: 6765 6e65 7269 635f 636c 6f75 647d 2074  generic_cloud} t
+00007d00: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
+00007d10: 7465 7374 5f63 7573 746f 6d5f 6465 6661  test_custom_defa
+00007d20: 756c 745f 636f 6e64 615f 656e 762e 7961  ult_conda_env.ya
+00007d30: 6d6c 272c 0a20 2020 2020 2020 2066 2773  ml',.        f's
+00007d40: 6b79 2073 7461 7475 7320 2d72 207b 6e61  ky status -r {na
+00007d50: 6d65 7d20 7c20 6772 6570 2022 5550 2227  me} | grep "UP"'
+00007d60: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+00007d70: 6c6f 6773 207b 6e61 6d65 7d20 3120 2d2d  logs {name} 1 --
+00007d80: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
+00007d90: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+00007da0: 657d 2031 202d 2d6e 6f2d 666f 6c6c 6f77  e} 1 --no-follow
+00007db0: 207c 2067 7265 7020 2d50 2022 6d79 656e   | grep -P "myen
+00007dc0: 765c 5c73 2b5c 5c2a 2227 2c0a 2020 2020  v\\s+\\*"',.    
+00007dd0: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+00007de0: 6e61 6d65 7d20 7465 7374 732f 7465 7374  name} tests/test
+00007df0: 5f79 616d 6c73 2f74 6573 745f 6375 7374  _yamls/test_cust
+00007e00: 6f6d 5f64 6566 6175 6c74 5f63 6f6e 6461  om_default_conda
+00007e10: 5f65 6e76 2e79 616d 6c27 2c0a 2020 2020  _env.yaml',.    
+00007e20: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+00007e30: 6e61 6d65 7d20 3220 2d2d 7374 6174 7573  name} 2 --status
+00007e40: 272c 0a20 2020 2020 2020 2066 2773 6b79  ',.        f'sky
+00007e50: 2061 7574 6f73 746f 7020 2d79 202d 6920   autostop -y -i 
+00007e60: 3020 7b6e 616d 657d 272c 0a20 2020 2020  0 {name}',.     
+00007e70: 2020 2027 736c 6565 7020 3630 272c 0a20     'sleep 60',. 
+00007e80: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
+00007e90: 7475 7320 2d72 207b 6e61 6d65 7d20 7c20  tus -r {name} | 
+00007ea0: 6772 6570 2022 5354 4f50 5045 4422 272c  grep "STOPPED"',
+00007eb0: 0a20 2020 2020 2020 2066 2773 6b79 2073  .        f'sky s
+00007ec0: 7461 7274 202d 7920 7b6e 616d 657d 272c  tart -y {name}',
+00007ed0: 0a20 2020 2020 2020 2066 2773 6b79 206c  .        f'sky l
+00007ee0: 6f67 7320 7b6e 616d 657d 2032 202d 2d6e  ogs {name} 2 --n
+00007ef0: 6f2d 666f 6c6c 6f77 207c 2067 7265 7020  o-follow | grep 
+00007f00: 2d50 2022 6d79 656e 765c 5c73 2b5c 5c2a  -P "myenv\\s+\\*
+00007f10: 2227 2c0a 2020 2020 2020 2020 6627 736b  "',.        f'sk
+00007f20: 7920 6578 6563 207b 6e61 6d65 7d20 7465  y exec {name} te
+00007f30: 7374 732f 7465 7374 5f79 616d 6c73 2f74  sts/test_yamls/t
+00007f40: 6573 745f 6375 7374 6f6d 5f64 6566 6175  est_custom_defau
+00007f50: 6c74 5f63 6f6e 6461 5f65 6e76 2e79 616d  lt_conda_env.yam
+00007f60: 6c27 2c0a 2020 2020 2020 2020 6627 736b  l',.        f'sk
+00007f70: 7920 6c6f 6773 207b 6e61 6d65 7d20 3320  y logs {name} 3 
+00007f80: 2d2d 7374 6174 7573 272c 0a20 2020 205d  --status',.    ]
+00007f90: 2c20 6627 736b 7920 646f 776e 202d 7920  , f'sky down -y 
+00007fa0: 7b6e 616d 657d 2729 0a20 2020 2072 756e  {name}').    run
+00007fb0: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+00007fc0: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ..# ------------
+00007fd0: 2054 6573 7420 7374 616c 6520 6a6f 6220   Test stale job 
+00007fe0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079  ------------.@py
+00007ff0: 7465 7374 2e6d 6172 6b2e 6e6f 5f66 6c75  test.mark.no_flu
+00008000: 6964 7374 6163 6b20 2023 2046 6c75 6964  idstack  # Fluid
+00008010: 5374 6163 6b20 646f 6573 206e 6f74 2073  Stack does not s
+00008020: 7570 706f 7274 2073 746f 7070 696e 6720  upport stopping 
+00008030: 696e 7374 616e 6365 7320 696e 2053 6b79  instances in Sky
+00008040: 5069 6c6f 7420 696d 706c 656d 656e 7461  Pilot implementa
+00008050: 7469 6f6e 0a40 7079 7465 7374 2e6d 6172  tion.@pytest.mar
+00008060: 6b2e 6e6f 5f6c 616d 6264 615f 636c 6f75  k.no_lambda_clou
+00008070: 6420 2023 204c 616d 6264 6120 436c 6f75  d  # Lambda Clou
+00008080: 6420 646f 6573 206e 6f74 2073 7570 706f  d does not suppo
+00008090: 7274 2073 746f 7070 696e 6720 696e 7374  rt stopping inst
+000080a0: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
+000080b0: 726b 2e6e 6f5f 6b75 6265 726e 6574 6573  rk.no_kubernetes
+000080c0: 2020 2320 4b75 6265 726e 6574 6573 2064    # Kubernetes d
+000080d0: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
+000080e0: 7374 6f70 7069 6e67 2069 6e73 7461 6e63  stopping instanc
+000080f0: 6573 0a64 6566 2074 6573 745f 7374 616c  es.def test_stal
+00008100: 655f 6a6f 6228 6765 6e65 7269 635f 636c  e_job(generic_cl
+00008110: 6f75 643a 2073 7472 293a 0a20 2020 206e  oud: str):.    n
+00008120: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+00008130: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
+00008140: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00008150: 2020 2027 7374 616c 655f 6a6f 6227 2c0a     'stale_job',.
+00008160: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+00008170: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+00008180: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
+00008190: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
+000081a0: 5f63 6c6f 7564 7d20 2265 6368 6f20 6869  _cloud} "echo hi
+000081b0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+000081c0: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+000081d0: 7d20 2d64 2022 6563 686f 2073 7461 7274  } -d "echo start
+000081e0: 3b20 736c 6565 7020 3130 3030 3022 272c  ; sleep 10000"',
+000081f0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00008200: 6b79 2073 746f 7020 7b6e 616d 657d 202d  ky stop {name} -
+00008210: 7927 2c0a 2020 2020 2020 2020 2020 2020  y',.            
+00008220: 2773 6c65 6570 2031 3030 272c 2020 2320  'sleep 100',  # 
+00008230: 456e 7375 7265 2074 6869 7320 6973 206c  Ensure this is l
+00008240: 6172 6765 2065 6e6f 7567 682c 2065 6c73  arge enough, els
+00008250: 6520 4743 5020 6c65 616b 732e 0a20 2020  e GCP leaks..   
+00008260: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
+00008270: 7461 7274 207b 6e61 6d65 7d20 2d79 272c  tart {name} -y',
+00008280: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00008290: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
+000082a0: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+000082b0: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
+000082c0: 7920 7175 6575 6520 7b6e 616d 657d 293b  y queue {name});
+000082d0: 2065 6368 6f20 2224 7322 3b20 6563 686f   echo "$s"; echo
+000082e0: 3b20 6563 686f 3b20 6563 686f 2022 2473  ; echo; echo "$s
+000082f0: 2220 7c20 6772 6570 2046 4149 4c45 4427  " | grep FAILED'
+00008300: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+00008310: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
+00008320: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+00008330: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+00008340: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
+00008350: 7374 2e6d 6172 6b2e 6177 730a 6465 6620  st.mark.aws.def 
+00008360: 7465 7374 5f61 7773 5f73 7461 6c65 5f6a  test_aws_stale_j
+00008370: 6f62 5f6d 616e 7561 6c5f 7265 7374 6172  ob_manual_restar
+00008380: 7428 293a 0a20 2020 206e 616d 6520 3d20  t():.    name = 
+00008390: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+000083a0: 6528 290a 2020 2020 6e61 6d65 5f6f 6e5f  e().    name_on_
+000083b0: 636c 6f75 6420 3d20 636f 6d6d 6f6e 5f75  cloud = common_u
+000083c0: 7469 6c73 2e6d 616b 655f 636c 7573 7465  tils.make_cluste
+000083d0: 725f 6e61 6d65 5f6f 6e5f 636c 6f75 6428  r_name_on_cloud(
+000083e0: 0a20 2020 2020 2020 206e 616d 652c 2073  .        name, s
+000083f0: 6b79 2e41 5753 2e6d 6178 5f63 6c75 7374  ky.AWS.max_clust
+00008400: 6572 5f6e 616d 655f 6c65 6e67 7468 2829  er_name_length()
+00008410: 290a 2020 2020 7265 6769 6f6e 203d 2027  ).    region = '
+00008420: 7573 2d65 6173 742d 3227 0a20 2020 2074  us-east-2'.    t
+00008430: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+00008440: 2020 2020 2761 7773 5f73 7461 6c65 5f6a      'aws_stale_j
+00008450: 6f62 5f6d 616e 7561 6c5f 7265 7374 6172  ob_manual_restar
+00008460: 7427 2c0a 2020 2020 2020 2020 5b0a 2020  t',.        [.  
+00008470: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00008480: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
+00008490: 6d65 7d20 2d2d 636c 6f75 6420 6177 7320  me} --cloud aws 
+000084a0: 2d2d 7265 6769 6f6e 207b 7265 6769 6f6e  --region {region
+000084b0: 7d20 2265 6368 6f20 6869 2227 2c0a 2020  } "echo hi"',.  
+000084c0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000084d0: 6578 6563 207b 6e61 6d65 7d20 2d64 2022  exec {name} -d "
+000084e0: 6563 686f 2073 7461 7274 3b20 736c 6565  echo start; slee
+000084f0: 7020 3130 3030 3022 272c 0a20 2020 2020  p 10000"',.     
+00008500: 2020 2020 2020 2023 2053 746f 7020 7468         # Stop th
+00008510: 6520 636c 7573 7465 7220 6d61 6e75 616c  e cluster manual
+00008520: 6c79 2e0a 2020 2020 2020 2020 2020 2020  ly..            
+00008530: 6627 6964 3d60 6177 7320 6563 3220 6465  f'id=`aws ec2 de
+00008540: 7363 7269 6265 2d69 6e73 7461 6e63 6573  scribe-instances
+00008550: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
+00008560: 6e7d 202d 2d66 696c 7465 7273 2027 0a20  n} --filters '. 
+00008570: 2020 2020 2020 2020 2020 2066 274e 616d             f'Nam
+00008580: 653d 7461 673a 7261 792d 636c 7573 7465  e=tag:ray-cluste
+00008590: 722d 6e61 6d65 2c56 616c 7565 733d 7b6e  r-name,Values={n
+000085a0: 616d 655f 6f6e 5f63 6c6f 7564 7d20 270a  ame_on_cloud} '.
+000085b0: 2020 2020 2020 2020 2020 2020 6627 2d2d              f'--
+000085c0: 7175 6572 7920 5265 7365 7276 6174 696f  query Reservatio
+000085d0: 6e73 5b5d 2e49 6e73 7461 6e63 6573 5b5d  ns[].Instances[]
+000085e0: 2e49 6e73 7461 6e63 6549 6420 270a 2020  .InstanceId '.  
+000085f0: 2020 2020 2020 2020 2020 272d 2d6f 7574            '--out
+00008600: 7075 7420 7465 7874 603b 2027 0a20 2020  put text`; '.   
+00008610: 2020 2020 2020 2020 2066 2761 7773 2065           f'aws e
+00008620: 6332 2073 746f 702d 696e 7374 616e 6365  c2 stop-instance
+00008630: 7320 2d2d 7265 6769 6f6e 207b 7265 6769  s --region {regi
+00008640: 6f6e 7d20 270a 2020 2020 2020 2020 2020  on} '.          
+00008650: 2020 272d 2d69 6e73 7461 6e63 652d 6964    '--instance-id
+00008660: 7320 2469 6427 2c0a 2020 2020 2020 2020  s $id',.        
+00008670: 2020 2020 2773 6c65 6570 2034 3027 2c0a      'sleep 40',.
+00008680: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00008690: 7920 6c61 756e 6368 202d 6320 7b6e 616d  y launch -c {nam
+000086a0: 657d 202d 7920 2265 6368 6f20 6869 2227  e} -y "echo hi"'
+000086b0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+000086c0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+000086d0: 3120 2d2d 7374 6174 7573 272c 0a20 2020  1 --status',.   
+000086e0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+000086f0: 6f67 7320 7b6e 616d 657d 2033 202d 2d73  ogs {name} 3 --s
+00008700: 7461 7475 7327 2c0a 2020 2020 2020 2020  tatus',.        
+00008710: 2020 2020 2320 456e 7375 7265 2074 6865      # Ensure the
+00008720: 2073 6b79 6c65 7420 7570 6461 7465 6420   skylet updated 
+00008730: 7468 6520 7374 616c 6520 6a6f 6220 7374  the stale job st
+00008740: 6174 7573 2e0a 2020 2020 2020 2020 2020  atus..          
+00008750: 2020 6627 736c 6565 7020 7b65 7665 6e74    f'sleep {event
+00008760: 732e 4a6f 6253 6368 6564 756c 6572 4576  s.JobSchedulerEv
+00008770: 656e 742e 4556 454e 545f 494e 5445 5256  ent.EVENT_INTERV
+00008780: 414c 5f53 4543 4f4e 4453 7d27 2c0a 2020  AL_SECONDS}',.  
+00008790: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
+000087a0: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
+000087b0: 293b 2065 6368 6f20 2224 7322 3b20 6563  ); echo "$s"; ec
+000087c0: 686f 3b20 6563 686f 3b20 6563 686f 2022  ho; echo; echo "
+000087d0: 2473 2220 7c20 6772 6570 2046 4149 4c45  $s" | grep FAILE
+000087e0: 4427 2c0a 2020 2020 2020 2020 5d2c 0a20  D',.        ],. 
+000087f0: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
+00008800: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
+00008810: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+00008820: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
+00008830: 7465 7374 2e6d 6172 6b2e 6763 700a 6465  test.mark.gcp.de
+00008840: 6620 7465 7374 5f67 6370 5f73 7461 6c65  f test_gcp_stale
+00008850: 5f6a 6f62 5f6d 616e 7561 6c5f 7265 7374  _job_manual_rest
+00008860: 6172 7428 293a 0a20 2020 206e 616d 6520  art():.    name 
+00008870: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+00008880: 616d 6528 290a 2020 2020 6e61 6d65 5f6f  ame().    name_o
+00008890: 6e5f 636c 6f75 6420 3d20 636f 6d6d 6f6e  n_cloud = common
+000088a0: 5f75 7469 6c73 2e6d 616b 655f 636c 7573  _utils.make_clus
+000088b0: 7465 725f 6e61 6d65 5f6f 6e5f 636c 6f75  ter_name_on_clou
+000088c0: 6428 0a20 2020 2020 2020 206e 616d 652c  d(.        name,
+000088d0: 2073 6b79 2e47 4350 2e6d 6178 5f63 6c75   sky.GCP.max_clu
+000088e0: 7374 6572 5f6e 616d 655f 6c65 6e67 7468  ster_name_length
+000088f0: 2829 290a 2020 2020 7a6f 6e65 203d 2027  ()).    zone = '
+00008900: 7573 2d77 6573 7432 2d61 270a 2020 2020  us-west2-a'.    
+00008910: 7175 6572 795f 636d 6420 3d20 2866 2767  query_cmd = (f'g
+00008920: 636c 6f75 6420 636f 6d70 7574 6520 696e  cloud compute in
+00008930: 7374 616e 6365 7320 6c69 7374 202d 2d66  stances list --f
+00008940: 696c 7465 723d 270a 2020 2020 2020 2020  ilter='.        
+00008950: 2020 2020 2020 2020 2066 2722 286c 6162           f'"(lab
+00008960: 656c 732e 7261 792d 636c 7573 7465 722d  els.ray-cluster-
+00008970: 6e61 6d65 3d7b 6e61 6d65 5f6f 6e5f 636c  name={name_on_cl
+00008980: 6f75 647d 2922 2027 0a20 2020 2020 2020  oud})" '.       
+00008990: 2020 2020 2020 2020 2020 6627 2d2d 7a6f            f'--zo
+000089a0: 6e65 733d 7b7a 6f6e 657d 202d 2d66 6f72  nes={zone} --for
+000089b0: 6d61 743d 2276 616c 7565 286e 616d 6529  mat="value(name)
+000089c0: 2227 290a 2020 2020 7374 6f70 5f63 6d64  "').    stop_cmd
+000089d0: 203d 2028 6627 6763 6c6f 7564 2063 6f6d   = (f'gcloud com
+000089e0: 7075 7465 2069 6e73 7461 6e63 6573 2073  pute instances s
+000089f0: 746f 7020 2d2d 7a6f 6e65 3d7b 7a6f 6e65  top --zone={zone
+00008a00: 7d27 0a20 2020 2020 2020 2020 2020 2020  }'.             
+00008a10: 2020 2066 2720 2d2d 7175 6965 7420 2428     f' --quiet $(
+00008a20: 7b71 7565 7279 5f63 6d64 7d29 2729 0a20  {query_cmd})'). 
+00008a30: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+00008a40: 2020 2020 2020 2020 2767 6370 5f73 7461          'gcp_sta
+00008a50: 6c65 5f6a 6f62 5f6d 616e 7561 6c5f 7265  le_job_manual_re
+00008a60: 7374 6172 7427 2c0a 2020 2020 2020 2020  start',.        
+00008a70: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+00008a80: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+00008a90: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+00008aa0: 6763 7020 2d2d 7a6f 6e65 207b 7a6f 6e65  gcp --zone {zone
+00008ab0: 7d20 2265 6368 6f20 6869 2227 2c0a 2020  } "echo hi"',.  
+00008ac0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00008ad0: 6578 6563 207b 6e61 6d65 7d20 2d64 2022  exec {name} -d "
+00008ae0: 6563 686f 2073 7461 7274 3b20 736c 6565  echo start; slee
+00008af0: 7020 3130 3030 3022 272c 0a20 2020 2020  p 10000"',.     
+00008b00: 2020 2020 2020 2023 2053 746f 7020 7468         # Stop th
+00008b10: 6520 636c 7573 7465 7220 6d61 6e75 616c  e cluster manual
+00008b20: 6c79 2e0a 2020 2020 2020 2020 2020 2020  ly..            
+00008b30: 7374 6f70 5f63 6d64 2c0a 2020 2020 2020  stop_cmd,.      
+00008b40: 2020 2020 2020 2773 6c65 6570 2034 3027        'sleep 40'
+00008b50: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00008b60: 736b 7920 6c61 756e 6368 202d 6320 7b6e  sky launch -c {n
+00008b70: 616d 657d 202d 7920 2265 6368 6f20 6869  ame} -y "echo hi
+00008b80: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+00008b90: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00008ba0: 7d20 3120 2d2d 7374 6174 7573 272c 0a20  } 1 --status',. 
+00008bb0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00008bc0: 206c 6f67 7320 7b6e 616d 657d 2033 202d   logs {name} 3 -
+00008bd0: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
+00008be0: 2020 2020 2020 2320 456e 7375 7265 2074        # Ensure t
+00008bf0: 6865 2073 6b79 6c65 7420 7570 6461 7465  he skylet update
+00008c00: 6420 7468 6520 7374 616c 6520 6a6f 6220  d the stale job 
+00008c10: 7374 6174 7573 2e0a 2020 2020 2020 2020  status..        
+00008c20: 2020 2020 6627 736c 6565 7020 7b65 7665      f'sleep {eve
+00008c30: 6e74 732e 4a6f 6253 6368 6564 756c 6572  nts.JobScheduler
+00008c40: 4576 656e 742e 4556 454e 545f 494e 5445  Event.EVENT_INTE
+00008c50: 5256 414c 5f53 4543 4f4e 4453 7d27 2c0a  RVAL_SECONDS}',.
+00008c60: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
+00008c70: 2428 736b 7920 7175 6575 6520 7b6e 616d  $(sky queue {nam
+00008c80: 657d 293b 2065 6368 6f20 2224 7322 3b20  e}); echo "$s"; 
+00008c90: 6563 686f 3b20 6563 686f 3b20 6563 686f  echo; echo; echo
+00008ca0: 2022 2473 2220 7c20 6772 6570 2046 4149   "$s" | grep FAI
+00008cb0: 4c45 4427 2c0a 2020 2020 2020 2020 5d2c  LED',.        ],
+00008cc0: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
+00008cd0: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
+00008ce0: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+00008cf0: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
+00008d00: 202d 2d2d 2d2d 2d2d 2d2d 2d20 4368 6563   ---------- Chec
+00008d10: 6b20 536b 7927 7320 656e 7669 726f 6e6d  k Sky's environm
+00008d20: 656e 7420 7661 7269 6162 6c65 733b 2077  ent variables; w
+00008d30: 6f72 6b64 6972 2e20 2d2d 2d2d 2d2d 2d2d  orkdir. --------
+00008d40: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
+00008d50: 6e6f 5f66 6c75 6964 7374 6163 6b20 2023  no_fluidstack  #
+00008d60: 2052 6571 7569 7265 7320 616d 617a 6f6e   Requires amazon
+00008d70: 2053 330a 4070 7974 6573 742e 6d61 726b   S3.@pytest.mark
+00008d80: 2e6e 6f5f 7363 7020 2023 2053 4350 2064  .no_scp  # SCP d
+00008d90: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
+00008da0: 6e75 6d5f 6e6f 6465 7320 3e20 3120 7965  num_nodes > 1 ye
+00008db0: 740a 6465 6620 7465 7374 5f65 6e76 5f63  t.def test_env_c
+00008dc0: 6865 636b 2867 656e 6572 6963 5f63 6c6f  heck(generic_clo
+00008dd0: 7564 3a20 7374 7229 3a0a 2020 2020 6e61  ud: str):.    na
+00008de0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+00008df0: 725f 6e61 6d65 2829 0a20 2020 2074 6f74  r_name().    tot
+00008e00: 616c 5f74 696d 656f 7574 5f6d 696e 7574  al_timeout_minut
+00008e10: 6573 203d 2032 3520 6966 2067 656e 6572  es = 25 if gener
+00008e20: 6963 5f63 6c6f 7564 203d 3d20 2761 7a75  ic_cloud == 'azu
+00008e30: 7265 2720 656c 7365 2031 350a 2020 2020  re' else 15.    
+00008e40: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+00008e50: 2020 2020 2027 656e 765f 6368 6563 6b27       'env_check'
+00008e60: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+00008e70: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+00008e80: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
+00008e90: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
+00008ea0: 6963 5f63 6c6f 7564 7d20 2d2d 6465 7461  ic_cloud} --deta
+00008eb0: 6368 2d73 6574 7570 2065 7861 6d70 6c65  ch-setup example
+00008ec0: 732f 656e 765f 6368 6563 6b2e 7961 6d6c  s/env_check.yaml
+00008ed0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00008ee0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+00008ef0: 2031 202d 2d73 7461 7475 7327 2c20 2023   1 --status',  #
+00008f00: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
+00008f10: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
+00008f20: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
+00008f30: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
+00008f40: 657d 272c 0a20 2020 2020 2020 2074 696d  e}',.        tim
+00008f50: 656f 7574 3d74 6f74 616c 5f74 696d 656f  eout=total_timeo
+00008f60: 7574 5f6d 696e 7574 6573 202a 2036 302c  ut_minutes * 60,
+00008f70: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00008f80: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00008f90: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2066 696c  # ---------- fil
+00008fa0: 655f 6d6f 756e 7473 202d 2d2d 2d2d 2d2d  e_mounts -------
+00008fb0: 2d2d 2d0a 4070 7974 6573 742e 6d61 726b  ---.@pytest.mark
+00008fc0: 2e6e 6f5f 7363 7020 2023 2053 4350 2064  .no_scp  # SCP d
+00008fd0: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
+00008fe0: 6e75 6d5f 6e6f 6465 7320 3e20 3120 7965  num_nodes > 1 ye
+00008ff0: 742e 2052 756e 2074 6573 745f 7363 705f  t. Run test_scp_
+00009000: 6669 6c65 5f6d 6f75 6e74 7320 696e 7374  file_mounts inst
+00009010: 6561 642e 0a64 6566 2074 6573 745f 6669  ead..def test_fi
+00009020: 6c65 5f6d 6f75 6e74 7328 6765 6e65 7269  le_mounts(generi
+00009030: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
+00009040: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+00009050: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+00009060: 2020 6578 7472 615f 666c 6167 7320 3d20    extra_flags = 
+00009070: 2727 0a20 2020 2069 6620 6765 6e65 7269  ''.    if generi
+00009080: 635f 636c 6f75 6420 696e 2027 6b75 6265  c_cloud in 'kube
+00009090: 726e 6574 6573 273a 0a20 2020 2020 2020  rnetes':.       
+000090a0: 2023 204b 7562 6572 6e65 7465 7320 646f   # Kubernetes do
+000090b0: 6573 206e 6f74 2073 7570 706f 7274 206d  es not support m
+000090c0: 756c 7469 2d6e 6f64 650a 2020 2020 2020  ulti-node.      
+000090d0: 2020 2320 4e4f 5445 3a20 5468 6973 2074    # NOTE: This t
+000090e0: 6573 7420 7769 6c6c 2066 6169 6c20 6966  est will fail if
+000090f0: 2079 6f75 2068 6176 6520 6120 4b75 6265   you have a Kube
+00009100: 726e 6574 6573 2063 6c75 7374 6572 2072  rnetes cluster r
+00009110: 756e 6e69 6e67 206f 6e0a 2020 2020 2020  unning on.      
+00009120: 2020 2320 2061 726d 3634 2028 652e 672e    #  arm64 (e.g.
+00009130: 2c20 4170 706c 6520 5369 6c69 636f 6e29  , Apple Silicon)
+00009140: 2073 696e 6365 2067 6f6f 6679 7320 646f   since goofys do
+00009150: 6573 206e 6f74 2077 6f72 6b20 6f6e 2061  es not work on a
+00009160: 726d 3634 2e0a 2020 2020 2020 2020 6578  rm64..        ex
+00009170: 7472 615f 666c 6167 7320 3d20 272d 2d6e  tra_flags = '--n
+00009180: 756d 2d6e 6f64 6573 2031 270a 2020 2020  um-nodes 1'.    
+00009190: 7465 7374 5f63 6f6d 6d61 6e64 7320 3d20  test_commands = 
+000091a0: 5b0a 2020 2020 2020 2020 2a73 746f 7261  [.        *stora
+000091b0: 6765 5f73 6574 7570 5f63 6f6d 6d61 6e64  ge_setup_command
+000091c0: 732c 0a20 2020 2020 2020 2066 2773 6b79  s,.        f'sky
+000091d0: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
+000091e0: 616d 657d 202d 2d63 6c6f 7564 207b 6765  ame} --cloud {ge
+000091f0: 6e65 7269 635f 636c 6f75 647d 207b 6578  neric_cloud} {ex
+00009200: 7472 615f 666c 6167 737d 2065 7861 6d70  tra_flags} examp
+00009210: 6c65 732f 7573 696e 675f 6669 6c65 5f6d  les/using_file_m
+00009220: 6f75 6e74 732e 7961 6d6c 272c 0a20 2020  ounts.yaml',.   
+00009230: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00009240: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
+00009250: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
+00009260: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
+00009270: 0a20 2020 205d 0a20 2020 2074 6573 7420  .    ].    test 
+00009280: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+00009290: 2775 7369 6e67 5f66 696c 655f 6d6f 756e  'using_file_moun
+000092a0: 7473 272c 0a20 2020 2020 2020 2074 6573  ts',.        tes
+000092b0: 745f 636f 6d6d 616e 6473 2c0a 2020 2020  t_commands,.    
+000092c0: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
+000092d0: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
+000092e0: 2020 205f 6765 745f 7469 6d65 6f75 7428     _get_timeout(
+000092f0: 6765 6e65 7269 635f 636c 6f75 642c 2032  generic_cloud, 2
+00009300: 3020 2a20 3630 292c 2020 2320 3230 206d  0 * 60),  # 20 m
+00009310: 696e 730a 2020 2020 290a 2020 2020 7275  ins.    ).    ru
+00009320: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+00009330: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+00009340: 7363 700a 6465 6620 7465 7374 5f73 6370  scp.def test_scp
+00009350: 5f66 696c 655f 6d6f 756e 7473 2829 3a0a  _file_mounts():.
+00009360: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+00009370: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+00009380: 2020 2074 6573 745f 636f 6d6d 616e 6473     test_commands
+00009390: 203d 205b 0a20 2020 2020 2020 202a 7374   = [.        *st
+000093a0: 6f72 6167 655f 7365 7475 705f 636f 6d6d  orage_setup_comm
+000093b0: 616e 6473 2c0a 2020 2020 2020 2020 6627  ands,.        f'
+000093c0: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+000093d0: 207b 6e61 6d65 7d20 7b53 4350 5f54 5950   {name} {SCP_TYP
+000093e0: 457d 202d 2d6e 756d 2d6e 6f64 6573 2031  E} --num-nodes 1
+000093f0: 2065 7861 6d70 6c65 732f 7573 696e 675f   examples/using_
+00009400: 6669 6c65 5f6d 6f75 6e74 732e 7961 6d6c  file_mounts.yaml
+00009410: 272c 0a20 2020 2020 2020 2066 2773 6b79  ',.        f'sky
+00009420: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
+00009430: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
+00009440: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
+00009450: 6565 6465 642e 0a20 2020 205d 0a20 2020  eeded..    ].   
+00009460: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+00009470: 2020 2020 2020 2753 4350 5f75 7369 6e67        'SCP_using
+00009480: 5f66 696c 655f 6d6f 756e 7473 272c 0a20  _file_mounts',. 
+00009490: 2020 2020 2020 2074 6573 745f 636f 6d6d         test_comm
+000094a0: 616e 6473 2c0a 2020 2020 2020 2020 6627  ands,.        f'
+000094b0: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
+000094c0: 657d 272c 0a20 2020 2020 2020 2074 696d  e}',.        tim
+000094d0: 656f 7574 3d32 3020 2a20 3630 2c20 2023  eout=20 * 60,  #
+000094e0: 2032 3020 6d69 6e73 0a20 2020 2029 0a20   20 mins.    ). 
+000094f0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00009500: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+00009510: 6d61 726b 2e6e 6f5f 666c 7569 6473 7461  mark.no_fluidsta
+00009520: 636b 2020 2320 5265 7175 6972 6573 2047  ck  # Requires G
+00009530: 4350 2074 6f20 6265 2065 6e61 626c 6564  CP to be enabled
+00009540: 0a64 6566 2074 6573 745f 7573 696e 675f  .def test_using_
+00009550: 6669 6c65 5f6d 6f75 6e74 735f 7769 7468  file_mounts_with
+00009560: 5f65 6e76 5f76 6172 7328 6765 6e65 7269  _env_vars(generi
+00009570: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
+00009580: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+00009590: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+000095a0: 2020 7374 6f72 6167 655f 6e61 6d65 203d    storage_name =
+000095b0: 2054 6573 7453 746f 7261 6765 5769 7468   TestStorageWith
+000095c0: 4372 6564 656e 7469 616c 732e 6765 6e65  Credentials.gene
+000095d0: 7261 7465 5f62 7563 6b65 745f 6e61 6d65  rate_bucket_name
+000095e0: 2829 0a20 2020 2074 6573 745f 636f 6d6d  ().    test_comm
+000095f0: 616e 6473 203d 205b 0a20 2020 2020 2020  ands = [.       
+00009600: 202a 7374 6f72 6167 655f 7365 7475 705f   *storage_setup_
+00009610: 636f 6d6d 616e 6473 2c0a 2020 2020 2020  commands,.      
+00009620: 2020 2866 2773 6b79 206c 6175 6e63 6820    (f'sky launch 
+00009630: 2d79 202d 6320 7b6e 616d 657d 202d 2d63  -y -c {name} --c
+00009640: 7075 7320 322b 202d 2d63 6c6f 7564 207b  pus 2+ --cloud {
+00009650: 6765 6e65 7269 635f 636c 6f75 647d 2027  generic_cloud} '
+00009660: 0a20 2020 2020 2020 2020 2765 7861 6d70  .         'examp
+00009670: 6c65 732f 7573 696e 675f 6669 6c65 5f6d  les/using_file_m
+00009680: 6f75 6e74 735f 7769 7468 5f65 6e76 5f76  ounts_with_env_v
+00009690: 6172 732e 7961 6d6c 2027 0a20 2020 2020  ars.yaml '.     
+000096a0: 2020 2020 6627 2d2d 656e 7620 4d59 5f42      f'--env MY_B
+000096b0: 5543 4b45 543d 7b73 746f 7261 6765 5f6e  UCKET={storage_n
+000096c0: 616d 657d 2729 2c0a 2020 2020 2020 2020  ame}'),.        
+000096d0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+000096e0: 7d20 3120 2d2d 7374 6174 7573 272c 2020  } 1 --status',  
+000096f0: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
+00009700: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
+00009710: 2020 2020 2320 4f76 6572 7269 6465 2077      # Override w
+00009720: 6974 6820 2d2d 656e 763a 0a20 2020 2020  ith --env:.     
+00009730: 2020 2028 6627 736b 7920 6c61 756e 6368     (f'sky launch
+00009740: 202d 7920 2d63 207b 6e61 6d65 7d2d 3220   -y -c {name}-2 
+00009750: 2d2d 6370 7573 2032 2b20 2d2d 636c 6f75  --cpus 2+ --clou
+00009760: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
+00009770: 7d20 270a 2020 2020 2020 2020 2027 6578  } '.         'ex
+00009780: 616d 706c 6573 2f75 7369 6e67 5f66 696c  amples/using_fil
+00009790: 655f 6d6f 756e 7473 5f77 6974 685f 656e  e_mounts_with_en
+000097a0: 765f 7661 7273 2e79 616d 6c20 270a 2020  v_vars.yaml '.  
+000097b0: 2020 2020 2020 2066 272d 2d65 6e76 204d         f'--env M
+000097c0: 595f 4255 434b 4554 3d7b 7374 6f72 6167  Y_BUCKET={storag
+000097d0: 655f 6e61 6d65 7d20 270a 2020 2020 2020  e_name} '.      
+000097e0: 2020 2027 2d2d 656e 7620 4d59 5f4c 4f43     '--env MY_LOC
+000097f0: 414c 5f50 4154 483d 746d 7066 696c 6527  AL_PATH=tmpfile'
+00009800: 292c 0a20 2020 2020 2020 2066 2773 6b79  ),.        f'sky
+00009810: 206c 6f67 7320 7b6e 616d 657d 2d32 2031   logs {name}-2 1
+00009820: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+00009830: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+00009840: 6363 6565 6465 642e 0a20 2020 205d 0a20  cceeded..    ]. 
+00009850: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+00009860: 2020 2020 2020 2020 2775 7369 6e67 5f66          'using_f
+00009870: 696c 655f 6d6f 756e 7473 5f77 6974 685f  ile_mounts_with_
+00009880: 656e 765f 7661 7273 272c 0a20 2020 2020  env_vars',.     
+00009890: 2020 2074 6573 745f 636f 6d6d 616e 6473     test_commands
+000098a0: 2c0a 2020 2020 2020 2020 2866 2773 6b79  ,.        (f'sky
+000098b0: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d20   down -y {name} 
+000098c0: 7b6e 616d 657d 2d32 272c 0a20 2020 2020  {name}-2',.     
+000098d0: 2020 2020 6627 736b 7920 7374 6f72 6167      f'sky storag
+000098e0: 6520 6465 6c65 7465 202d 7920 7b73 746f  e delete -y {sto
+000098f0: 7261 6765 5f6e 616d 657d 207b 7374 6f72  rage_name} {stor
+00009900: 6167 655f 6e61 6d65 7d2d 3227 292c 0a20  age_name}-2'),. 
+00009910: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
+00009920: 3020 2a20 3630 2c20 2023 2032 3020 6d69  0 * 60,  # 20 mi
+00009930: 6e73 0a20 2020 2029 0a20 2020 2072 756e  ns.    ).    run
+00009940: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+00009950: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2073  ..# ---------- s
+00009960: 746f 7261 6765 202d 2d2d 2d2d 2d2d 2d2d  torage ---------
+00009970: 2d0a 4070 7974 6573 742e 6d61 726b 2e61  -.@pytest.mark.a
+00009980: 7773 0a64 6566 2074 6573 745f 6177 735f  ws.def test_aws_
+00009990: 7374 6f72 6167 655f 6d6f 756e 7473 5f77  storage_mounts_w
+000099a0: 6974 685f 7374 6f70 2829 3a0a 2020 2020  ith_stop():.    
+000099b0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+000099c0: 7465 725f 6e61 6d65 2829 0a20 2020 2073  ter_name().    s
+000099d0: 746f 7261 6765 5f6e 616d 6520 3d20 6627  torage_name = f'
+000099e0: 736b 792d 7465 7374 2d7b 696e 7428 7469  sky-test-{int(ti
+000099f0: 6d65 2e74 696d 6528 2929 7d27 0a20 2020  me.time())}'.   
+00009a00: 2074 656d 706c 6174 655f 7374 7220 3d20   template_str = 
+00009a10: 7061 7468 6c69 622e 5061 7468 280a 2020  pathlib.Path(.  
+00009a20: 2020 2020 2020 2774 6573 7473 2f74 6573        'tests/tes
+00009a30: 745f 7961 6d6c 732f 7465 7374 5f73 746f  t_yamls/test_sto
+00009a40: 7261 6765 5f6d 6f75 6e74 696e 672e 7961  rage_mounting.ya
+00009a50: 6d6c 2e6a 3227 292e 7265 6164 5f74 6578  ml.j2').read_tex
+00009a60: 7428 290a 2020 2020 7465 6d70 6c61 7465  t().    template
+00009a70: 203d 206a 696e 6a61 322e 5465 6d70 6c61   = jinja2.Templa
+00009a80: 7465 2874 656d 706c 6174 655f 7374 7229  te(template_str)
+00009a90: 0a20 2020 2063 6f6e 7465 6e74 203d 2074  .    content = t
+00009aa0: 656d 706c 6174 652e 7265 6e64 6572 2873  emplate.render(s
+00009ab0: 746f 7261 6765 5f6e 616d 653d 7374 6f72  torage_name=stor
+00009ac0: 6167 655f 6e61 6d65 290a 2020 2020 7769  age_name).    wi
+00009ad0: 7468 2074 656d 7066 696c 652e 4e61 6d65  th tempfile.Name
+00009ae0: 6454 656d 706f 7261 7279 4669 6c65 2873  dTemporaryFile(s
+00009af0: 7566 6669 783d 272e 7961 6d6c 272c 206d  uffix='.yaml', m
+00009b00: 6f64 653d 2777 2729 2061 7320 663a 0a20  ode='w') as f:. 
+00009b10: 2020 2020 2020 2066 2e77 7269 7465 2863         f.write(c
+00009b20: 6f6e 7465 6e74 290a 2020 2020 2020 2020  ontent).        
+00009b30: 662e 666c 7573 6828 290a 2020 2020 2020  f.flush().      
+00009b40: 2020 6669 6c65 5f70 6174 6820 3d20 662e    file_path = f.
+00009b50: 6e61 6d65 0a20 2020 2020 2020 2074 6573  name.        tes
+00009b60: 745f 636f 6d6d 616e 6473 203d 205b 0a20  t_commands = [. 
+00009b70: 2020 2020 2020 2020 2020 202a 7374 6f72             *stor
+00009b80: 6167 655f 7365 7475 705f 636f 6d6d 616e  age_setup_comman
+00009b90: 6473 2c0a 2020 2020 2020 2020 2020 2020  ds,.            
+00009ba0: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
+00009bb0: 2d63 207b 6e61 6d65 7d20 2d2d 636c 6f75  -c {name} --clou
+00009bc0: 6420 6177 7320 7b66 696c 655f 7061 7468  d aws {file_path
+00009bd0: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
+00009be0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00009bf0: 7d20 3120 2d2d 7374 6174 7573 272c 2020  } 1 --status',  
+00009c00: 2320 456e 7375 7265 206a 6f62 2073 7563  # Ensure job suc
+00009c10: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
+00009c20: 2020 2020 6627 6177 7320 7333 206c 7320      f'aws s3 ls 
+00009c30: 7b73 746f 7261 6765 5f6e 616d 657d 2f68  {storage_name}/h
+00009c40: 656c 6c6f 2e74 7874 272c 0a20 2020 2020  ello.txt',.     
+00009c50: 2020 2020 2020 2066 2773 6b79 2073 746f         f'sky sto
+00009c60: 7020 2d79 207b 6e61 6d65 7d27 2c0a 2020  p -y {name}',.  
+00009c70: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00009c80: 7374 6172 7420 2d79 207b 6e61 6d65 7d27  start -y {name}'
+00009c90: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+00009ca0: 4368 6563 6b20 6966 2068 656c 6c6f 2e74  Check if hello.t
+00009cb0: 7874 2066 726f 6d20 6d6f 756e 7469 6e67  xt from mounting
+00009cc0: 2062 7563 6b65 7420 6578 6973 7473 2061   bucket exists a
+00009cd0: 6674 6572 2072 6573 7461 7274 2069 6e0a  fter restart in.
+00009ce0: 2020 2020 2020 2020 2020 2020 2320 7468              # th
+00009cf0: 6520 6d6f 756e 7465 6420 6469 7265 6374  e mounted direct
+00009d00: 6f72 790a 2020 2020 2020 2020 2020 2020  ory.            
+00009d10: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+00009d20: 7d20 2d2d 2022 7365 7420 2d65 783b 206c  } -- "set -ex; l
+00009d30: 7320 2f6d 6f75 6e74 5f70 7269 7661 7465  s /mount_private
+00009d40: 5f6d 6f75 6e74 2f68 656c 6c6f 2e74 7874  _mount/hello.txt
+00009d50: 2227 0a20 2020 2020 2020 205d 0a20 2020  "'.        ].   
+00009d60: 2020 2020 2074 6573 7420 3d20 5465 7374       test = Test
+00009d70: 280a 2020 2020 2020 2020 2020 2020 2761  (.            'a
+00009d80: 7773 5f73 746f 7261 6765 5f6d 6f75 6e74  ws_storage_mount
+00009d90: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
+00009da0: 7465 7374 5f63 6f6d 6d61 6e64 732c 0a20  test_commands,. 
+00009db0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00009dc0: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d3b   down -y {name};
+00009dd0: 2073 6b79 2073 746f 7261 6765 2064 656c   sky storage del
+00009de0: 6574 6520 2d79 207b 7374 6f72 6167 655f  ete -y {storage_
+00009df0: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
+00009e00: 2020 2020 7469 6d65 6f75 743d 3230 202a      timeout=20 *
+00009e10: 2036 302c 2020 2320 3230 206d 696e 730a   60,  # 20 mins.
+00009e20: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00009e30: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00009e40: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+00009e50: 6172 6b2e 6763 700a 6465 6620 7465 7374  ark.gcp.def test
+00009e60: 5f67 6370 5f73 746f 7261 6765 5f6d 6f75  _gcp_storage_mou
+00009e70: 6e74 735f 7769 7468 5f73 746f 7028 293a  nts_with_stop():
+00009e80: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+00009e90: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+00009ea0: 2020 2020 7374 6f72 6167 655f 6e61 6d65      storage_name
+00009eb0: 203d 2066 2773 6b79 2d74 6573 742d 7b69   = f'sky-test-{i
+00009ec0: 6e74 2874 696d 652e 7469 6d65 2829 297d  nt(time.time())}
+00009ed0: 270a 2020 2020 7465 6d70 6c61 7465 5f73  '.    template_s
+00009ee0: 7472 203d 2070 6174 686c 6962 2e50 6174  tr = pathlib.Pat
+00009ef0: 6828 0a20 2020 2020 2020 2027 7465 7374  h(.        'test
+00009f00: 732f 7465 7374 5f79 616d 6c73 2f74 6573  s/test_yamls/tes
+00009f10: 745f 7374 6f72 6167 655f 6d6f 756e 7469  t_storage_mounti
+00009f20: 6e67 2e79 616d 6c2e 6a32 2729 2e72 6561  ng.yaml.j2').rea
+00009f30: 645f 7465 7874 2829 0a20 2020 2074 656d  d_text().    tem
+00009f40: 706c 6174 6520 3d20 6a69 6e6a 6132 2e54  plate = jinja2.T
+00009f50: 656d 706c 6174 6528 7465 6d70 6c61 7465  emplate(template
+00009f60: 5f73 7472 290a 2020 2020 636f 6e74 656e  _str).    conten
+00009f70: 7420 3d20 7465 6d70 6c61 7465 2e72 656e  t = template.ren
+00009f80: 6465 7228 7374 6f72 6167 655f 6e61 6d65  der(storage_name
+00009f90: 3d73 746f 7261 6765 5f6e 616d 6529 0a20  =storage_name). 
+00009fa0: 2020 2077 6974 6820 7465 6d70 6669 6c65     with tempfile
+00009fb0: 2e4e 616d 6564 5465 6d70 6f72 6172 7946  .NamedTemporaryF
+00009fc0: 696c 6528 7375 6666 6978 3d27 2e79 616d  ile(suffix='.yam
+00009fd0: 6c27 2c20 6d6f 6465 3d27 7727 2920 6173  l', mode='w') as
+00009fe0: 2066 3a0a 2020 2020 2020 2020 662e 7772   f:.        f.wr
+00009ff0: 6974 6528 636f 6e74 656e 7429 0a20 2020  ite(content).   
+0000a000: 2020 2020 2066 2e66 6c75 7368 2829 0a20       f.flush(). 
+0000a010: 2020 2020 2020 2066 696c 655f 7061 7468         file_path
+0000a020: 203d 2066 2e6e 616d 650a 2020 2020 2020   = f.name.      
+0000a030: 2020 7465 7374 5f63 6f6d 6d61 6e64 7320    test_commands 
+0000a040: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+0000a050: 2a73 746f 7261 6765 5f73 6574 7570 5f63  *storage_setup_c
+0000a060: 6f6d 6d61 6e64 732c 0a20 2020 2020 2020  ommands,.       
+0000a070: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+0000a080: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
+0000a090: 2d63 6c6f 7564 2067 6370 207b 6669 6c65  -cloud gcp {file
+0000a0a0: 5f70 6174 687d 272c 0a20 2020 2020 2020  _path}',.       
+0000a0b0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+0000a0c0: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
+0000a0d0: 7327 2c20 2023 2045 6e73 7572 6520 6a6f  s',  # Ensure jo
+0000a0e0: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
+0000a0f0: 2020 2020 2020 2020 2066 2767 7375 7469           f'gsuti
+0000a100: 6c20 6c73 2067 733a 2f2f 7b73 746f 7261  l ls gs://{stora
+0000a110: 6765 5f6e 616d 657d 2f68 656c 6c6f 2e74  ge_name}/hello.t
+0000a120: 7874 272c 0a20 2020 2020 2020 2020 2020  xt',.           
+0000a130: 2066 2773 6b79 2073 746f 7020 2d79 207b   f'sky stop -y {
+0000a140: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
+0000a150: 2020 2020 6627 736b 7920 7374 6172 7420      f'sky start 
+0000a160: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+0000a170: 2020 2020 2020 2020 2320 4368 6563 6b20          # Check 
+0000a180: 6966 2068 656c 6c6f 2e74 7874 2066 726f  if hello.txt fro
+0000a190: 6d20 6d6f 756e 7469 6e67 2062 7563 6b65  m mounting bucke
+0000a1a0: 7420 6578 6973 7473 2061 6674 6572 2072  t exists after r
+0000a1b0: 6573 7461 7274 2069 6e0a 2020 2020 2020  estart in.      
+0000a1c0: 2020 2020 2020 2320 7468 6520 6d6f 756e        # the moun
+0000a1d0: 7465 6420 6469 7265 6374 6f72 790a 2020  ted directory.  
+0000a1e0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000a1f0: 6578 6563 207b 6e61 6d65 7d20 2d2d 2022  exec {name} -- "
+0000a200: 7365 7420 2d65 783b 206c 7320 2f6d 6f75  set -ex; ls /mou
+0000a210: 6e74 5f70 7269 7661 7465 5f6d 6f75 6e74  nt_private_mount
+0000a220: 2f68 656c 6c6f 2e74 7874 2227 0a20 2020  /hello.txt"'.   
+0000a230: 2020 2020 205d 0a20 2020 2020 2020 2074       ].        t
+0000a240: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+0000a250: 2020 2020 2020 2020 2767 6370 5f73 746f          'gcp_sto
+0000a260: 7261 6765 5f6d 6f75 6e74 7327 2c0a 2020  rage_mounts',.  
+0000a270: 2020 2020 2020 2020 2020 7465 7374 5f63            test_c
+0000a280: 6f6d 6d61 6e64 732c 0a20 2020 2020 2020  ommands,.       
+0000a290: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
+0000a2a0: 2d79 207b 6e61 6d65 7d3b 2073 6b79 2073  -y {name}; sky s
+0000a2b0: 746f 7261 6765 2064 656c 6574 6520 2d79  torage delete -y
+0000a2c0: 207b 7374 6f72 6167 655f 6e61 6d65 7d27   {storage_name}'
+0000a2d0: 2c0a 2020 2020 2020 2020 2020 2020 7469  ,.            ti
+0000a2e0: 6d65 6f75 743d 3230 202a 2036 302c 2020  meout=20 * 60,  
+0000a2f0: 2320 3230 206d 696e 730a 2020 2020 2020  # 20 mins.      
+0000a300: 2020 290a 2020 2020 2020 2020 7275 6e5f    ).        run_
+0000a310: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+0000a320: 0a40 7079 7465 7374 2e6d 6172 6b2e 6b75  .@pytest.mark.ku
+0000a330: 6265 726e 6574 6573 0a64 6566 2074 6573  bernetes.def tes
+0000a340: 745f 6b75 6265 726e 6574 6573 5f73 746f  t_kubernetes_sto
+0000a350: 7261 6765 5f6d 6f75 6e74 7328 293a 0a20  rage_mounts():. 
+0000a360: 2020 2023 2054 6573 7473 2062 7563 6b65     # Tests bucke
+0000a370: 7420 6d6f 756e 7469 6e67 206f 6e20 6b38  t mounting on k8
+0000a380: 732c 2061 7373 756d 696e 6720 5333 2069  s, assuming S3 i
+0000a390: 7320 636f 6e66 6967 7572 6564 2e0a 2020  s configured..  
+0000a3a0: 2020 2320 5468 6973 2074 6573 7420 7769    # This test wi
+0000a3b0: 6c6c 2066 6169 6c20 6966 2072 756e 206f  ll fail if run o
+0000a3c0: 6e20 6e6f 6e20 7838 365f 3634 2061 7263  n non x86_64 arc
+0000a3d0: 6869 7465 6374 7572 652c 2073 696e 6365  hitecture, since
+0000a3e0: 2067 6f6f 6679 7320 6973 0a20 2020 2023   goofys is.    #
+0000a3f0: 2062 7569 6c74 2066 6f72 2078 3836 5f36   built for x86_6
+0000a400: 3420 6f6e 6c79 2e0a 2020 2020 6e61 6d65  4 only..    name
+0000a410: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+0000a420: 6e61 6d65 2829 0a20 2020 2073 746f 7261  name().    stora
+0000a430: 6765 5f6e 616d 6520 3d20 6627 736b 792d  ge_name = f'sky-
+0000a440: 7465 7374 2d7b 696e 7428 7469 6d65 2e74  test-{int(time.t
+0000a450: 696d 6528 2929 7d27 0a20 2020 2074 656d  ime())}'.    tem
+0000a460: 706c 6174 655f 7374 7220 3d20 7061 7468  plate_str = path
+0000a470: 6c69 622e 5061 7468 280a 2020 2020 2020  lib.Path(.      
+0000a480: 2020 2774 6573 7473 2f74 6573 745f 7961    'tests/test_ya
+0000a490: 6d6c 732f 7465 7374 5f73 746f 7261 6765  mls/test_storage
+0000a4a0: 5f6d 6f75 6e74 696e 672e 7961 6d6c 2e6a  _mounting.yaml.j
+0000a4b0: 3227 292e 7265 6164 5f74 6578 7428 290a  2').read_text().
+0000a4c0: 2020 2020 7465 6d70 6c61 7465 203d 206a      template = j
+0000a4d0: 696e 6a61 322e 5465 6d70 6c61 7465 2874  inja2.Template(t
+0000a4e0: 656d 706c 6174 655f 7374 7229 0a20 2020  emplate_str).   
+0000a4f0: 2063 6f6e 7465 6e74 203d 2074 656d 706c   content = templ
+0000a500: 6174 652e 7265 6e64 6572 2873 746f 7261  ate.render(stora
+0000a510: 6765 5f6e 616d 653d 7374 6f72 6167 655f  ge_name=storage_
+0000a520: 6e61 6d65 290a 2020 2020 7769 7468 2074  name).    with t
+0000a530: 656d 7066 696c 652e 4e61 6d65 6454 656d  empfile.NamedTem
+0000a540: 706f 7261 7279 4669 6c65 2873 7566 6669  poraryFile(suffi
+0000a550: 783d 272e 7961 6d6c 272c 206d 6f64 653d  x='.yaml', mode=
+0000a560: 2777 2729 2061 7320 663a 0a20 2020 2020  'w') as f:.     
+0000a570: 2020 2066 2e77 7269 7465 2863 6f6e 7465     f.write(conte
+0000a580: 6e74 290a 2020 2020 2020 2020 662e 666c  nt).        f.fl
+0000a590: 7573 6828 290a 2020 2020 2020 2020 6669  ush().        fi
+0000a5a0: 6c65 5f70 6174 6820 3d20 662e 6e61 6d65  le_path = f.name
+0000a5b0: 0a20 2020 2020 2020 2074 6573 745f 636f  .        test_co
+0000a5c0: 6d6d 616e 6473 203d 205b 0a20 2020 2020  mmands = [.     
+0000a5d0: 2020 2020 2020 202a 7374 6f72 6167 655f         *storage_
+0000a5e0: 7365 7475 705f 636f 6d6d 616e 6473 2c0a  setup_commands,.
+0000a5f0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000a600: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+0000a610: 6e61 6d65 7d20 2d2d 636c 6f75 6420 6b75  name} --cloud ku
+0000a620: 6265 726e 6574 6573 207b 6669 6c65 5f70  bernetes {file_p
+0000a630: 6174 687d 272c 0a20 2020 2020 2020 2020  ath}',.         
+0000a640: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+0000a650: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
+0000a660: 2c20 2023 2045 6e73 7572 6520 6a6f 6220  ,  # Ensure job 
+0000a670: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
+0000a680: 2020 2020 2020 2066 2761 7773 2073 3320         f'aws s3 
+0000a690: 6c73 207b 7374 6f72 6167 655f 6e61 6d65  ls {storage_name
+0000a6a0: 7d2f 6865 6c6c 6f2e 7478 7420 7c7c 2027  }/hello.txt || '
+0000a6b0: 0a20 2020 2020 2020 2020 2020 2066 2767  .            f'g
+0000a6c0: 7375 7469 6c20 6c73 2067 733a 2f2f 7b73  sutil ls gs://{s
+0000a6d0: 746f 7261 6765 5f6e 616d 657d 2f68 656c  torage_name}/hel
+0000a6e0: 6c6f 2e74 7874 272c 0a20 2020 2020 2020  lo.txt',.       
+0000a6f0: 205d 0a20 2020 2020 2020 2074 6573 7420   ].        test 
+0000a700: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+0000a710: 2020 2020 276b 7562 6572 6e65 7465 735f      'kubernetes_
+0000a720: 7374 6f72 6167 655f 6d6f 756e 7473 272c  storage_mounts',
+0000a730: 0a20 2020 2020 2020 2020 2020 2074 6573  .            tes
+0000a740: 745f 636f 6d6d 616e 6473 2c0a 2020 2020  t_commands,.    
+0000a750: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+0000a760: 776e 202d 7920 7b6e 616d 657d 3b20 736b  wn -y {name}; sk
+0000a770: 7920 7374 6f72 6167 6520 6465 6c65 7465  y storage delete
+0000a780: 202d 7920 7b73 746f 7261 6765 5f6e 616d   -y {storage_nam
+0000a790: 657d 272c 0a20 2020 2020 2020 2020 2020  e}',.           
+0000a7a0: 2074 696d 656f 7574 3d32 3020 2a20 3630   timeout=20 * 60
+0000a7b0: 2c20 2023 2032 3020 6d69 6e73 0a20 2020  ,  # 20 mins.   
+0000a7c0: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
+0000a7d0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+0000a7e0: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+0000a7f0: 2e70 6172 616d 6574 7269 7a65 280a 2020  .parametrize(.  
+0000a800: 2020 2769 6d61 6765 5f69 6427 2c0a 2020    'image_id',.  
+0000a810: 2020 5b0a 2020 2020 2020 2020 2764 6f63    [.        'doc
+0000a820: 6b65 723a 6e76 6964 6961 2f63 7564 613a  ker:nvidia/cuda:
+0000a830: 3131 2e38 2e30 2d64 6576 656c 2d75 6275  11.8.0-devel-ubu
+0000a840: 6e74 7531 382e 3034 272c 0a20 2020 2020  ntu18.04',.     
+0000a850: 2020 2027 646f 636b 6572 3a75 6275 6e74     'docker:ubunt
+0000a860: 753a 3138 2e30 3427 2c0a 2020 2020 2020  u:18.04',.      
+0000a870: 2020 2320 5465 7374 2069 6d61 6765 2077    # Test image w
+0000a880: 6974 6820 7079 7468 6f6e 2033 2e31 3120  ith python 3.11 
+0000a890: 696e 7374 616c 6c65 6420 6279 2064 6566  installed by def
+0000a8a0: 6175 6c74 2e0a 2020 2020 2020 2020 2764  ault..        'd
+0000a8b0: 6f63 6b65 723a 636f 6e74 696e 7575 6d69  ocker:continuumi
+0000a8c0: 6f2f 6d69 6e69 636f 6e64 6133 3a32 342e  o/miniconda3:24.
+0000a8d0: 312e 322d 3027 2c0a 2020 2020 2020 2020  1.2-0',.        
+0000a8e0: 2320 5465 7374 2070 7974 686f 6e3e 3d33  # Test python>=3
+0000a8f0: 2e31 3220 7768 6572 6520 536b 7950 696c  .12 where SkyPil
+0000a900: 6f74 2073 686f 756c 6420 6175 746f 6d61  ot should automa
+0000a910: 7469 6361 6c6c 7920 6372 6561 7465 2061  tically create a
+0000a920: 2073 6570 6172 6174 650a 2020 2020 2020   separate.      
+0000a930: 2020 2320 636f 6e64 6120 656e 7620 666f    # conda env fo
+0000a940: 7220 7275 6e74 696d 6520 7769 7468 2070  r runtime with p
+0000a950: 7974 686f 6e20 332e 3130 2e0a 2020 2020  ython 3.10..    
+0000a960: 2020 2020 2764 6f63 6b65 723a 636f 6e74      'docker:cont
+0000a970: 696e 7575 6d69 6f2f 6d69 6e69 636f 6e64  inuumio/minicond
+0000a980: 6133 3a6c 6174 6573 7427 2c0a 2020 2020  a3:latest',.    
+0000a990: 5d29 0a64 6566 2074 6573 745f 646f 636b  ]).def test_dock
+0000a9a0: 6572 5f73 746f 7261 6765 5f6d 6f75 6e74  er_storage_mount
+0000a9b0: 7328 6765 6e65 7269 635f 636c 6f75 643a  s(generic_cloud:
+0000a9c0: 2073 7472 2c20 696d 6167 655f 6964 3a20   str, image_id: 
+0000a9d0: 7374 7229 3a0a 2020 2020 2320 5465 7374  str):.    # Test
+0000a9e0: 7320 6275 636b 6574 206d 6f75 6e74 696e  s bucket mountin
+0000a9f0: 6720 6f6e 2064 6f63 6b65 7220 636f 6e74  g on docker cont
+0000aa00: 6169 6e65 720a 2020 2020 6e61 6d65 203d  ainer.    name =
+0000aa10: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+0000aa20: 6d65 2829 0a20 2020 2074 696d 6573 7461  me().    timesta
+0000aa30: 6d70 203d 2073 7472 2874 696d 652e 7469  mp = str(time.ti
+0000aa40: 6d65 2829 292e 7265 706c 6163 6528 272e  me()).replace('.
+0000aa50: 272c 2027 2729 0a20 2020 2073 746f 7261  ', '').    stora
+0000aa60: 6765 5f6e 616d 6520 3d20 6627 736b 792d  ge_name = f'sky-
+0000aa70: 7465 7374 2d7b 7469 6d65 7374 616d 707d  test-{timestamp}
+0000aa80: 270a 2020 2020 7465 6d70 6c61 7465 5f73  '.    template_s
+0000aa90: 7472 203d 2070 6174 686c 6962 2e50 6174  tr = pathlib.Pat
+0000aaa0: 6828 0a20 2020 2020 2020 2027 7465 7374  h(.        'test
+0000aab0: 732f 7465 7374 5f79 616d 6c73 2f74 6573  s/test_yamls/tes
+0000aac0: 745f 7374 6f72 6167 655f 6d6f 756e 7469  t_storage_mounti
+0000aad0: 6e67 2e79 616d 6c2e 6a32 2729 2e72 6561  ng.yaml.j2').rea
+0000aae0: 645f 7465 7874 2829 0a20 2020 2074 656d  d_text().    tem
+0000aaf0: 706c 6174 6520 3d20 6a69 6e6a 6132 2e54  plate = jinja2.T
+0000ab00: 656d 706c 6174 6528 7465 6d70 6c61 7465  emplate(template
+0000ab10: 5f73 7472 290a 2020 2020 636f 6e74 656e  _str).    conten
+0000ab20: 7420 3d20 7465 6d70 6c61 7465 2e72 656e  t = template.ren
+0000ab30: 6465 7228 7374 6f72 6167 655f 6e61 6d65  der(storage_name
+0000ab40: 3d73 746f 7261 6765 5f6e 616d 6529 0a20  =storage_name). 
+0000ab50: 2020 2077 6974 6820 7465 6d70 6669 6c65     with tempfile
+0000ab60: 2e4e 616d 6564 5465 6d70 6f72 6172 7946  .NamedTemporaryF
+0000ab70: 696c 6528 7375 6666 6978 3d27 2e79 616d  ile(suffix='.yam
+0000ab80: 6c27 2c20 6d6f 6465 3d27 7727 2920 6173  l', mode='w') as
+0000ab90: 2066 3a0a 2020 2020 2020 2020 662e 7772   f:.        f.wr
+0000aba0: 6974 6528 636f 6e74 656e 7429 0a20 2020  ite(content).   
+0000abb0: 2020 2020 2066 2e66 6c75 7368 2829 0a20       f.flush(). 
+0000abc0: 2020 2020 2020 2066 696c 655f 7061 7468         file_path
+0000abd0: 203d 2066 2e6e 616d 650a 2020 2020 2020   = f.name.      
+0000abe0: 2020 7465 7374 5f63 6f6d 6d61 6e64 7320    test_commands 
+0000abf0: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+0000ac00: 2a73 746f 7261 6765 5f73 6574 7570 5f63  *storage_setup_c
+0000ac10: 6f6d 6d61 6e64 732c 0a20 2020 2020 2020  ommands,.       
+0000ac20: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+0000ac30: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
+0000ac40: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
+0000ac50: 636c 6f75 647d 202d 2d69 6d61 6765 2d69  cloud} --image-i
+0000ac60: 6420 7b69 6d61 6765 5f69 647d 207b 6669  d {image_id} {fi
+0000ac70: 6c65 5f70 6174 687d 272c 0a20 2020 2020  le_path}',.     
+0000ac80: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+0000ac90: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
+0000aca0: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
+0000acb0: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
+0000acc0: 2020 2020 2020 2020 2020 2066 2761 7773             f'aws
+0000acd0: 2073 3320 6c73 207b 7374 6f72 6167 655f   s3 ls {storage_
+0000ace0: 6e61 6d65 7d2f 6865 6c6c 6f2e 7478 7420  name}/hello.txt 
+0000acf0: 7c7c 2027 0a20 2020 2020 2020 2020 2020  || '.           
+0000ad00: 2066 2767 7375 7469 6c20 6c73 2067 733a   f'gsutil ls gs:
+0000ad10: 2f2f 7b73 746f 7261 6765 5f6e 616d 657d  //{storage_name}
+0000ad20: 2f68 656c 6c6f 2e74 7874 272c 0a20 2020  /hello.txt',.   
+0000ad30: 2020 2020 205d 0a20 2020 2020 2020 2074       ].        t
+0000ad40: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+0000ad50: 2020 2020 2020 2020 2764 6f63 6b65 725f          'docker_
+0000ad60: 7374 6f72 6167 655f 6d6f 756e 7473 272c  storage_mounts',
+0000ad70: 0a20 2020 2020 2020 2020 2020 2074 6573  .            tes
+0000ad80: 745f 636f 6d6d 616e 6473 2c0a 2020 2020  t_commands,.    
+0000ad90: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+0000ada0: 776e 202d 7920 7b6e 616d 657d 3b20 736b  wn -y {name}; sk
+0000adb0: 7920 7374 6f72 6167 6520 6465 6c65 7465  y storage delete
+0000adc0: 202d 7920 7b73 746f 7261 6765 5f6e 616d   -y {storage_nam
+0000add0: 657d 272c 0a20 2020 2020 2020 2020 2020  e}',.           
+0000ade0: 2074 696d 656f 7574 3d32 3020 2a20 3630   timeout=20 * 60
+0000adf0: 2c20 2023 2032 3020 6d69 6e73 0a20 2020  ,  # 20 mins.   
+0000ae00: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
+0000ae10: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+0000ae20: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+0000ae30: 2e63 6c6f 7564 666c 6172 650a 6465 6620  .cloudflare.def 
+0000ae40: 7465 7374 5f63 6c6f 7564 666c 6172 655f  test_cloudflare_
+0000ae50: 7374 6f72 6167 655f 6d6f 756e 7473 2867  storage_mounts(g
+0000ae60: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
+0000ae70: 7229 3a0a 2020 2020 6e61 6d65 203d 205f  r):.    name = _
+0000ae80: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+0000ae90: 2829 0a20 2020 2073 746f 7261 6765 5f6e  ().    storage_n
+0000aea0: 616d 6520 3d20 6627 736b 792d 7465 7374  ame = f'sky-test
+0000aeb0: 2d7b 696e 7428 7469 6d65 2e74 696d 6528  -{int(time.time(
+0000aec0: 2929 7d27 0a20 2020 2074 656d 706c 6174  ))}'.    templat
+0000aed0: 655f 7374 7220 3d20 7061 7468 6c69 622e  e_str = pathlib.
+0000aee0: 5061 7468 280a 2020 2020 2020 2020 2774  Path(.        't
+0000aef0: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
+0000af00: 7465 7374 5f72 325f 7374 6f72 6167 655f  test_r2_storage_
+0000af10: 6d6f 756e 7469 6e67 2e79 616d 6c27 292e  mounting.yaml').
+0000af20: 7265 6164 5f74 6578 7428 290a 2020 2020  read_text().    
+0000af30: 7465 6d70 6c61 7465 203d 206a 696e 6a61  template = jinja
+0000af40: 322e 5465 6d70 6c61 7465 2874 656d 706c  2.Template(templ
+0000af50: 6174 655f 7374 7229 0a20 2020 2063 6f6e  ate_str).    con
+0000af60: 7465 6e74 203d 2074 656d 706c 6174 652e  tent = template.
+0000af70: 7265 6e64 6572 2873 746f 7261 6765 5f6e  render(storage_n
+0000af80: 616d 653d 7374 6f72 6167 655f 6e61 6d65  ame=storage_name
+0000af90: 290a 2020 2020 656e 6470 6f69 6e74 5f75  ).    endpoint_u
+0000afa0: 726c 203d 2063 6c6f 7564 666c 6172 652e  rl = cloudflare.
+0000afb0: 6372 6561 7465 5f65 6e64 706f 696e 7428  create_endpoint(
+0000afc0: 290a 2020 2020 7769 7468 2074 656d 7066  ).    with tempf
+0000afd0: 696c 652e 4e61 6d65 6454 656d 706f 7261  ile.NamedTempora
+0000afe0: 7279 4669 6c65 2873 7566 6669 783d 272e  ryFile(suffix='.
+0000aff0: 7961 6d6c 272c 206d 6f64 653d 2777 2729  yaml', mode='w')
+0000b000: 2061 7320 663a 0a20 2020 2020 2020 2066   as f:.        f
+0000b010: 2e77 7269 7465 2863 6f6e 7465 6e74 290a  .write(content).
+0000b020: 2020 2020 2020 2020 662e 666c 7573 6828          f.flush(
+0000b030: 290a 2020 2020 2020 2020 6669 6c65 5f70  ).        file_p
+0000b040: 6174 6820 3d20 662e 6e61 6d65 0a20 2020  ath = f.name.   
+0000b050: 2020 2020 2074 6573 745f 636f 6d6d 616e       test_comman
+0000b060: 6473 203d 205b 0a20 2020 2020 2020 2020  ds = [.         
+0000b070: 2020 202a 7374 6f72 6167 655f 7365 7475     *storage_setu
+0000b080: 705f 636f 6d6d 616e 6473 2c0a 2020 2020  p_commands,.    
+0000b090: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+0000b0a0: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
+0000b0b0: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
+0000b0c0: 6963 5f63 6c6f 7564 7d20 7b66 696c 655f  ic_cloud} {file_
+0000b0d0: 7061 7468 7d27 2c0a 2020 2020 2020 2020  path}',.        
+0000b0e0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+0000b0f0: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
+0000b100: 272c 2020 2320 456e 7375 7265 206a 6f62  ',  # Ensure job
+0000b110: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
+0000b120: 2020 2020 2020 2020 6627 4157 535f 5348          f'AWS_SH
+0000b130: 4152 4544 5f43 5245 4445 4e54 4941 4c53  ARED_CREDENTIALS
+0000b140: 5f46 494c 453d 7b63 6c6f 7564 666c 6172  _FILE={cloudflar
+0000b150: 652e 5232 5f43 5245 4445 4e54 4941 4c53  e.R2_CREDENTIALS
+0000b160: 5f50 4154 487d 2061 7773 2073 3320 6c73  _PATH} aws s3 ls
+0000b170: 2073 333a 2f2f 7b73 746f 7261 6765 5f6e   s3://{storage_n
+0000b180: 616d 657d 2f68 656c 6c6f 2e74 7874 202d  ame}/hello.txt -
+0000b190: 2d65 6e64 706f 696e 7420 7b65 6e64 706f  -endpoint {endpo
+0000b1a0: 696e 745f 7572 6c7d 202d 2d70 726f 6669  int_url} --profi
+0000b1b0: 6c65 3d72 3227 0a20 2020 2020 2020 205d  le=r2'.        ]
+0000b1c0: 0a0a 2020 2020 2020 2020 7465 7374 203d  ..        test =
+0000b1d0: 2054 6573 7428 0a20 2020 2020 2020 2020   Test(.         
+0000b1e0: 2020 2027 636c 6f75 6466 6c61 7265 5f73     'cloudflare_s
+0000b1f0: 746f 7261 6765 5f6d 6f75 6e74 7327 2c0a  torage_mounts',.
+0000b200: 2020 2020 2020 2020 2020 2020 7465 7374              test
+0000b210: 5f63 6f6d 6d61 6e64 732c 0a20 2020 2020  _commands,.     
+0000b220: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
+0000b230: 6e20 2d79 207b 6e61 6d65 7d3b 2073 6b79  n -y {name}; sky
+0000b240: 2073 746f 7261 6765 2064 656c 6574 6520   storage delete 
+0000b250: 2d79 207b 7374 6f72 6167 655f 6e61 6d65  -y {storage_name
+0000b260: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
+0000b270: 7469 6d65 6f75 743d 3230 202a 2036 302c  timeout=20 * 60,
+0000b280: 2020 2320 3230 206d 696e 730a 2020 2020    # 20 mins.    
+0000b290: 2020 2020 290a 2020 2020 2020 2020 7275      ).        ru
+0000b2a0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+0000b2b0: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+0000b2c0: 6962 6d0a 6465 6620 7465 7374 5f69 626d  ibm.def test_ibm
+0000b2d0: 5f73 746f 7261 6765 5f6d 6f75 6e74 7328  _storage_mounts(
+0000b2e0: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
+0000b2f0: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+0000b300: 290a 2020 2020 7374 6f72 6167 655f 6e61  ).    storage_na
+0000b310: 6d65 203d 2066 2773 6b79 2d74 6573 742d  me = f'sky-test-
+0000b320: 7b69 6e74 2874 696d 652e 7469 6d65 2829  {int(time.time()
+0000b330: 297d 270a 2020 2020 6275 636b 6574 5f72  )}'.    bucket_r
+0000b340: 636c 6f6e 655f 7072 6f66 696c 6520 3d20  clone_profile = 
+0000b350: 5263 6c6f 6e65 2e67 656e 6572 6174 655f  Rclone.generate_
+0000b360: 7263 6c6f 6e65 5f62 7563 6b65 745f 7072  rclone_bucket_pr
+0000b370: 6f66 696c 655f 6e61 6d65 280a 2020 2020  ofile_name(.    
+0000b380: 2020 2020 7374 6f72 6167 655f 6e61 6d65      storage_name
+0000b390: 2c20 5263 6c6f 6e65 2e52 636c 6f6e 6543  , Rclone.RcloneC
+0000b3a0: 6c6f 7564 732e 4942 4d29 0a20 2020 2074  louds.IBM).    t
+0000b3b0: 656d 706c 6174 655f 7374 7220 3d20 7061  emplate_str = pa
+0000b3c0: 7468 6c69 622e 5061 7468 280a 2020 2020  thlib.Path(.    
+0000b3d0: 2020 2020 2774 6573 7473 2f74 6573 745f      'tests/test_
+0000b3e0: 7961 6d6c 732f 7465 7374 5f69 626d 5f63  yamls/test_ibm_c
+0000b3f0: 6f73 5f73 746f 7261 6765 5f6d 6f75 6e74  os_storage_mount
+0000b400: 696e 672e 7961 6d6c 2729 2e72 6561 645f  ing.yaml').read_
+0000b410: 7465 7874 2829 0a20 2020 2074 656d 706c  text().    templ
+0000b420: 6174 6520 3d20 6a69 6e6a 6132 2e54 656d  ate = jinja2.Tem
+0000b430: 706c 6174 6528 7465 6d70 6c61 7465 5f73  plate(template_s
+0000b440: 7472 290a 2020 2020 636f 6e74 656e 7420  tr).    content 
+0000b450: 3d20 7465 6d70 6c61 7465 2e72 656e 6465  = template.rende
+0000b460: 7228 7374 6f72 6167 655f 6e61 6d65 3d73  r(storage_name=s
+0000b470: 746f 7261 6765 5f6e 616d 6529 0a20 2020  torage_name).   
+0000b480: 2077 6974 6820 7465 6d70 6669 6c65 2e4e   with tempfile.N
+0000b490: 616d 6564 5465 6d70 6f72 6172 7946 696c  amedTemporaryFil
+0000b4a0: 6528 7375 6666 6978 3d27 2e79 616d 6c27  e(suffix='.yaml'
+0000b4b0: 2c20 6d6f 6465 3d27 7727 2920 6173 2066  , mode='w') as f
+0000b4c0: 3a0a 2020 2020 2020 2020 662e 7772 6974  :.        f.writ
+0000b4d0: 6528 636f 6e74 656e 7429 0a20 2020 2020  e(content).     
+0000b4e0: 2020 2066 2e66 6c75 7368 2829 0a20 2020     f.flush().   
+0000b4f0: 2020 2020 2066 696c 655f 7061 7468 203d       file_path =
+0000b500: 2066 2e6e 616d 650a 2020 2020 2020 2020   f.name.        
+0000b510: 7465 7374 5f63 6f6d 6d61 6e64 7320 3d20  test_commands = 
+0000b520: 5b0a 2020 2020 2020 2020 2020 2020 2a73  [.            *s
+0000b530: 746f 7261 6765 5f73 6574 7570 5f63 6f6d  torage_setup_com
+0000b540: 6d61 6e64 732c 0a20 2020 2020 2020 2020  mands,.         
+0000b550: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+0000b560: 2d79 202d 6320 7b6e 616d 657d 202d 2d63  -y -c {name} --c
+0000b570: 6c6f 7564 2069 626d 207b 6669 6c65 5f70  loud ibm {file_p
+0000b580: 6174 687d 272c 0a20 2020 2020 2020 2020  ath}',.         
+0000b590: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+0000b5a0: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
+0000b5b0: 2c20 2023 2045 6e73 7572 6520 6a6f 6220  ,  # Ensure job 
+0000b5c0: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
+0000b5d0: 2020 2020 2020 2066 2772 636c 6f6e 6520         f'rclone 
+0000b5e0: 6c73 207b 6275 636b 6574 5f72 636c 6f6e  ls {bucket_rclon
+0000b5f0: 655f 7072 6f66 696c 657d 3a7b 7374 6f72  e_profile}:{stor
+0000b600: 6167 655f 6e61 6d65 7d2f 6865 6c6c 6f2e  age_name}/hello.
+0000b610: 7478 7427 2c0a 2020 2020 2020 2020 5d0a  txt',.        ].
+0000b620: 2020 2020 2020 2020 7465 7374 203d 2054          test = T
+0000b630: 6573 7428 0a20 2020 2020 2020 2020 2020  est(.           
+0000b640: 2027 6962 6d5f 7374 6f72 6167 655f 6d6f   'ibm_storage_mo
+0000b650: 756e 7473 272c 0a20 2020 2020 2020 2020  unts',.         
+0000b660: 2020 2074 6573 745f 636f 6d6d 616e 6473     test_commands
+0000b670: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000b680: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
+0000b690: 657d 3b20 736b 7920 7374 6f72 6167 6520  e}; sky storage 
+0000b6a0: 6465 6c65 7465 202d 7920 7b73 746f 7261  delete -y {stora
+0000b6b0: 6765 5f6e 616d 657d 272c 0a20 2020 2020  ge_name}',.     
+0000b6c0: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
+0000b6d0: 3020 2a20 3630 2c20 2023 2032 3020 6d69  0 * 60,  # 20 mi
+0000b6e0: 6e73 0a20 2020 2020 2020 2029 0a20 2020  ns.        ).   
+0000b6f0: 2020 2020 2072 756e 5f6f 6e65 5f74 6573       run_one_tes
+0000b700: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
+0000b710: 2d2d 2d2d 2d2d 2043 4c49 206c 6f67 7320  ------ CLI logs 
+0000b720: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
+0000b730: 7374 2e6d 6172 6b2e 6e6f 5f73 6370 2020  st.mark.no_scp  
+0000b740: 2320 5343 5020 646f 6573 206e 6f74 2073  # SCP does not s
+0000b750: 7570 706f 7274 206e 756d 5f6e 6f64 6573  upport num_nodes
+0000b760: 203e 2031 2079 6574 2e20 5275 6e20 7465   > 1 yet. Run te
+0000b770: 7374 5f73 6370 5f6c 6f67 7320 696e 7374  st_scp_logs inst
+0000b780: 6561 642e 0a64 6566 2074 6573 745f 636c  ead..def test_cl
+0000b790: 695f 6c6f 6773 2867 656e 6572 6963 5f63  i_logs(generic_c
+0000b7a0: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
+0000b7b0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+0000b7c0: 7465 725f 6e61 6d65 2829 0a20 2020 206e  ter_name().    n
+0000b7d0: 756d 5f6e 6f64 6573 203d 2032 0a20 2020  um_nodes = 2.   
+0000b7e0: 2069 6620 6765 6e65 7269 635f 636c 6f75   if generic_clou
+0000b7f0: 6420 3d3d 2027 6b75 6265 726e 6574 6573  d == 'kubernetes
+0000b800: 273a 0a20 2020 2020 2020 2023 204b 7562  ':.        # Kub
+0000b810: 6572 6e65 7465 7320 646f 6573 206e 6f74  ernetes does not
+0000b820: 2073 7570 706f 7274 206d 756c 7469 2d6e   support multi-n
+0000b830: 6f64 650a 2020 2020 2020 2020 6e75 6d5f  ode.        num_
+0000b840: 6e6f 6465 7320 3d20 310a 2020 2020 7469  nodes = 1.    ti
+0000b850: 6d65 7374 616d 7020 3d20 7469 6d65 2e74  mestamp = time.t
+0000b860: 696d 6528 290a 2020 2020 7465 7374 203d  ime().    test =
+0000b870: 2054 6573 7428 2763 6c69 5f6c 6f67 7327   Test('cli_logs'
+0000b880: 2c20 5b0a 2020 2020 2020 2020 6627 736b  , [.        f'sk
+0000b890: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+0000b8a0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
+0000b8b0: 656e 6572 6963 5f63 6c6f 7564 7d20 2d2d  eneric_cloud} --
+0000b8c0: 6e75 6d2d 6e6f 6465 7320 7b6e 756d 5f6e  num-nodes {num_n
+0000b8d0: 6f64 6573 7d20 2265 6368 6f20 7b74 696d  odes} "echo {tim
+0000b8e0: 6573 7461 6d70 7d20 3122 272c 0a20 2020  estamp} 1"',.   
+0000b8f0: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+0000b900: 7b6e 616d 657d 2022 6563 686f 207b 7469  {name} "echo {ti
+0000b910: 6d65 7374 616d 707d 2032 2227 2c0a 2020  mestamp} 2"',.  
+0000b920: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+0000b930: 207b 6e61 6d65 7d20 2265 6368 6f20 7b74   {name} "echo {t
+0000b940: 696d 6573 7461 6d70 7d20 3322 272c 0a20  imestamp} 3"',. 
+0000b950: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+0000b960: 6320 7b6e 616d 657d 2022 6563 686f 207b  c {name} "echo {
+0000b970: 7469 6d65 7374 616d 707d 2034 2227 2c0a  timestamp} 4"',.
+0000b980: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+0000b990: 6773 207b 6e61 6d65 7d20 3220 2d2d 7374  gs {name} 2 --st
+0000b9a0: 6174 7573 272c 0a20 2020 2020 2020 2066  atus',.        f
+0000b9b0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+0000b9c0: 2033 2034 202d 2d73 796e 632d 646f 776e   3 4 --sync-down
+0000b9d0: 272c 0a20 2020 2020 2020 2066 2773 6b79  ',.        f'sky
+0000b9e0: 206c 6f67 7320 7b6e 616d 657d 202a 202d   logs {name} * -
+0000b9f0: 2d73 796e 632d 646f 776e 272c 0a20 2020  -sync-down',.   
+0000ba00: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+0000ba10: 7b6e 616d 657d 2031 207c 2067 7265 7020  {name} 1 | grep 
+0000ba20: 227b 7469 6d65 7374 616d 707d 2031 2227  "{timestamp} 1"'
+0000ba30: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+0000ba40: 6c6f 6773 207b 6e61 6d65 7d20 7c20 6772  logs {name} | gr
+0000ba50: 6570 2022 7b74 696d 6573 7461 6d70 7d20  ep "{timestamp} 
+0000ba60: 3422 272c 0a20 2020 205d 2c20 6627 736b  4"',.    ], f'sk
+0000ba70: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+0000ba80: 2729 0a20 2020 2072 756e 5f6f 6e65 5f74  ').    run_one_t
+0000ba90: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
+0000baa0: 6573 742e 6d61 726b 2e73 6370 0a64 6566  est.mark.scp.def
+0000bab0: 2074 6573 745f 7363 705f 6c6f 6773 2829   test_scp_logs()
+0000bac0: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+0000bad0: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+0000bae0: 0a20 2020 2074 696d 6573 7461 6d70 203d  .    timestamp =
+0000baf0: 2074 696d 652e 7469 6d65 2829 0a20 2020   time.time().   
+0000bb00: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+0000bb10: 2020 2020 2020 2753 4350 5f63 6c69 5f6c        'SCP_cli_l
+0000bb20: 6f67 7327 2c0a 2020 2020 2020 2020 5b0a  ogs',.        [.
+0000bb30: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000bb40: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+0000bb50: 6e61 6d65 7d20 7b53 4350 5f54 5950 457d  name} {SCP_TYPE}
+0000bb60: 2022 6563 686f 207b 7469 6d65 7374 616d   "echo {timestam
+0000bb70: 707d 2031 2227 2c0a 2020 2020 2020 2020  p} 1"',.        
+0000bb80: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+0000bb90: 6e61 6d65 7d20 2265 6368 6f20 7b74 696d  name} "echo {tim
+0000bba0: 6573 7461 6d70 7d20 3222 272c 0a20 2020  estamp} 2"',.   
+0000bbb0: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+0000bbc0: 7865 6320 7b6e 616d 657d 2022 6563 686f  xec {name} "echo
+0000bbd0: 207b 7469 6d65 7374 616d 707d 2033 2227   {timestamp} 3"'
+0000bbe0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000bbf0: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+0000bc00: 2265 6368 6f20 7b74 696d 6573 7461 6d70  "echo {timestamp
+0000bc10: 7d20 3422 272c 0a20 2020 2020 2020 2020  } 4"',.         
+0000bc20: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+0000bc30: 616d 657d 2032 202d 2d73 7461 7475 7327  ame} 2 --status'
+0000bc40: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000bc50: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+0000bc60: 3320 3420 2d2d 7379 6e63 2d64 6f77 6e27  3 4 --sync-down'
+0000bc70: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000bc80: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+0000bc90: 2a20 2d2d 7379 6e63 2d64 6f77 6e27 2c0a  * --sync-down',.
+0000bca0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000bcb0: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
+0000bcc0: 7c20 6772 6570 2022 7b74 696d 6573 7461  | grep "{timesta
+0000bcd0: 6d70 7d20 3122 272c 0a20 2020 2020 2020  mp} 1"',.       
+0000bce0: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+0000bcf0: 7b6e 616d 657d 207c 2067 7265 7020 227b  {name} | grep "{
+0000bd00: 7469 6d65 7374 616d 707d 2034 2227 2c0a  timestamp} 4"',.
+0000bd10: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+0000bd20: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
+0000bd30: 207b 6e61 6d65 7d27 2c0a 2020 2020 290a   {name}',.    ).
+0000bd40: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+0000bd50: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
+0000bd60: 2d2d 2d2d 2d20 4a6f 6220 5175 6575 652e  ----- Job Queue.
+0000bd70: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974   ----------.@pyt
+0000bd80: 6573 742e 6d61 726b 2e6e 6f5f 666c 7569  est.mark.no_flui
+0000bd90: 6473 7461 636b 2020 2320 466c 7569 6453  dstack  # FluidS
+0000bda0: 7461 636b 2044 4320 6861 7320 6c6f 7720  tack DC has low 
+0000bdb0: 6176 6169 6c61 6269 6c69 7479 206f 6620  availability of 
+0000bdc0: 5434 2047 5055 730a 4070 7974 6573 742e  T4 GPUs.@pytest.
+0000bdd0: 6d61 726b 2e6e 6f5f 6c61 6d62 6461 5f63  mark.no_lambda_c
+0000bde0: 6c6f 7564 2020 2320 4c61 6d62 6461 2043  loud  # Lambda C
+0000bdf0: 6c6f 7564 2064 6f65 7320 6e6f 7420 6861  loud does not ha
+0000be00: 7665 2054 3420 6770 7573 0a40 7079 7465  ve T4 gpus.@pyte
+0000be10: 7374 2e6d 6172 6b2e 6e6f 5f69 626d 2020  st.mark.no_ibm  
+0000be20: 2320 4942 4d20 436c 6f75 6420 646f 6573  # IBM Cloud does
+0000be30: 206e 6f74 2068 6176 6520 5434 2067 7075   not have T4 gpu
+0000be40: 732e 2072 756e 2074 6573 745f 6962 6d5f  s. run test_ibm_
+0000be50: 6a6f 625f 7175 6575 6520 696e 7374 6561  job_queue instea
+0000be60: 640a 4070 7974 6573 742e 6d61 726b 2e6e  d.@pytest.mark.n
+0000be70: 6f5f 7363 7020 2023 2053 4350 2064 6f65  o_scp  # SCP doe
+0000be80: 7320 6e6f 7420 6861 7665 2054 3420 6770  s not have T4 gp
+0000be90: 7573 2e20 5275 6e20 7465 7374 5f73 6370  us. Run test_scp
+0000bea0: 5f6a 6f62 5f71 7565 7565 2069 6e73 7465  _job_queue inste
+0000beb0: 6164 0a40 7079 7465 7374 2e6d 6172 6b2e  ad.@pytest.mark.
+0000bec0: 6e6f 5f70 6170 6572 7370 6163 6520 2023  no_paperspace  #
+0000bed0: 2050 6170 6572 7370 6163 6520 646f 6573   Paperspace does
+0000bee0: 206e 6f74 2068 6176 6520 5434 2067 7075   not have T4 gpu
+0000bef0: 732e 0a40 7079 7465 7374 2e6d 6172 6b2e  s..@pytest.mark.
+0000bf00: 6e6f 5f6f 6369 2020 2320 4f43 4920 646f  no_oci  # OCI do
+0000bf10: 6573 206e 6f74 2068 6176 6520 5434 2067  es not have T4 g
+0000bf20: 7075 730a 6465 6620 7465 7374 5f6a 6f62  pus.def test_job
+0000bf30: 5f71 7565 7565 2867 656e 6572 6963 5f63  _queue(generic_c
+0000bf40: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
+0000bf50: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+0000bf60: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+0000bf70: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+0000bf80: 2020 2020 276a 6f62 5f71 7565 7565 272c      'job_queue',
+0000bf90: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+0000bfa0: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
+0000bfb0: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
+0000bfc0: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
+0000bfd0: 635f 636c 6f75 647d 2065 7861 6d70 6c65  c_cloud} example
+0000bfe0: 732f 6a6f 625f 7175 6575 652f 636c 7573  s/job_queue/clus
+0000bff0: 7465 722e 7961 6d6c 272c 0a20 2020 2020  ter.yaml',.     
+0000c000: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+0000c010: 6320 7b6e 616d 657d 202d 6e20 7b6e 616d  c {name} -n {nam
+0000c020: 657d 2d31 202d 6420 6578 616d 706c 6573  e}-1 -d examples
+0000c030: 2f6a 6f62 5f71 7565 7565 2f6a 6f62 2e79  /job_queue/job.y
+0000c040: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+0000c050: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+0000c060: 6d65 7d20 2d6e 207b 6e61 6d65 7d2d 3220  me} -n {name}-2 
+0000c070: 2d64 2065 7861 6d70 6c65 732f 6a6f 625f  -d examples/job_
+0000c080: 7175 6575 652f 6a6f 622e 7961 6d6c 272c  queue/job.yaml',
+0000c090: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000c0a0: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
+0000c0b0: 6e20 7b6e 616d 657d 2d33 202d 6420 6578  n {name}-3 -d ex
+0000c0c0: 616d 706c 6573 2f6a 6f62 5f71 7565 7565  amples/job_queue
+0000c0d0: 2f6a 6f62 2e79 616d 6c27 2c0a 2020 2020  /job.yaml',.    
+0000c0e0: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
+0000c0f0: 7920 7175 6575 6520 7b6e 616d 657d 293b  y queue {name});
+0000c100: 2065 6368 6f20 2224 7322 3b20 6563 686f   echo "$s"; echo
+0000c110: 3b20 6563 686f 3b20 6563 686f 2022 2473  ; echo; echo "$s
+0000c120: 2220 7c20 6772 6570 207b 6e61 6d65 7d2d  " | grep {name}-
+0000c130: 3120 7c20 6772 6570 2052 554e 4e49 4e47  1 | grep RUNNING
+0000c140: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000c150: 2773 3d24 2873 6b79 2071 7565 7565 207b  's=$(sky queue {
+0000c160: 6e61 6d65 7d29 3b20 6563 686f 2022 2473  name}); echo "$s
+0000c170: 223b 2065 6368 6f3b 2065 6368 6f3b 2065  "; echo; echo; e
+0000c180: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
+0000c190: 7b6e 616d 657d 2d32 207c 2067 7265 7020  {name}-2 | grep 
+0000c1a0: 5255 4e4e 494e 4727 2c0a 2020 2020 2020  RUNNING',.      
+0000c1b0: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
+0000c1c0: 7175 6575 6520 7b6e 616d 657d 293b 2065  queue {name}); e
+0000c1d0: 6368 6f20 2224 7322 3b20 6563 686f 3b20  cho "$s"; echo; 
+0000c1e0: 6563 686f 3b20 6563 686f 2022 2473 2220  echo; echo "$s" 
+0000c1f0: 7c20 6772 6570 207b 6e61 6d65 7d2d 3320  | grep {name}-3 
+0000c200: 7c20 6772 6570 2050 454e 4449 4e47 272c  | grep PENDING',
+0000c210: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000c220: 6b79 2063 616e 6365 6c20 2d79 207b 6e61  ky cancel -y {na
+0000c230: 6d65 7d20 3227 2c0a 2020 2020 2020 2020  me} 2',.        
+0000c240: 2020 2020 2773 6c65 6570 2035 272c 0a20      'sleep 5',. 
+0000c250: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
+0000c260: 2873 6b79 2071 7565 7565 207b 6e61 6d65  (sky queue {name
+0000c270: 7d29 3b20 6563 686f 2022 2473 223b 2065  }); echo "$s"; e
+0000c280: 6368 6f3b 2065 6368 6f3b 2065 6368 6f20  cho; echo; echo 
+0000c290: 2224 7322 207c 2067 7265 7020 7b6e 616d  "$s" | grep {nam
+0000c2a0: 657d 2d33 207c 2067 7265 7020 5255 4e4e  e}-3 | grep RUNN
+0000c2b0: 494e 4727 2c0a 2020 2020 2020 2020 2020  ING',.          
+0000c2c0: 2020 6627 736b 7920 6361 6e63 656c 202d    f'sky cancel -
+0000c2d0: 7920 7b6e 616d 657d 2033 272c 0a20 2020  y {name} 3',.   
+0000c2e0: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+0000c2f0: 7865 6320 7b6e 616d 657d 202d 2d67 7075  xec {name} --gpu
+0000c300: 7320 5434 3a30 2e32 2022 5b5b 205c 2453  s T4:0.2 "[[ \$S
+0000c310: 4b59 5049 4c4f 545f 4e55 4d5f 4750 5553  KYPILOT_NUM_GPUS
+0000c320: 5f50 4552 5f4e 4f44 4520 2d65 7120 3120  _PER_NODE -eq 1 
+0000c330: 5d5d 207c 7c20 6578 6974 2031 2227 2c0a  ]] || exit 1"',.
+0000c340: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000c350: 7920 6578 6563 207b 6e61 6d65 7d20 2d2d  y exec {name} --
+0000c360: 6770 7573 2054 343a 3120 225b 5b20 5c24  gpus T4:1 "[[ \$
+0000c370: 534b 5950 494c 4f54 5f4e 554d 5f47 5055  SKYPILOT_NUM_GPU
+0000c380: 535f 5045 525f 4e4f 4445 202d 6571 2031  S_PER_NODE -eq 1
+0000c390: 205d 5d20 7c7c 2065 7869 7420 3122 272c   ]] || exit 1"',
+0000c3a0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000c3b0: 6b79 206c 6f67 7320 7b6e 616d 657d 2034  ky logs {name} 4
+0000c3c0: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+0000c3d0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+0000c3e0: 6773 207b 6e61 6d65 7d20 3520 2d2d 7374  gs {name} 5 --st
+0000c3f0: 6174 7573 272c 0a20 2020 2020 2020 205d  atus',.        ]
+0000c400: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+0000c410: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+0000c420: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+0000c430: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+0000c440: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 204a 6f62  # ---------- Job
+0000c450: 2051 7565 7565 2077 6974 6820 446f 636b   Queue with Dock
+0000c460: 6572 2e20 2d2d 2d2d 2d2d 2d2d 2d2d 0a40  er. ----------.@
+0000c470: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f66  pytest.mark.no_f
+0000c480: 6c75 6964 7374 6163 6b20 2023 2046 6c75  luidstack  # Flu
+0000c490: 6964 5374 6163 6b20 646f 6573 206e 6f74  idStack does not
+0000c4a0: 2073 7570 706f 7274 2064 6f63 6b65 7220   support docker 
+0000c4b0: 666f 7220 6e6f 770a 4070 7974 6573 742e  for now.@pytest.
+0000c4c0: 6d61 726b 2e6e 6f5f 6c61 6d62 6461 5f63  mark.no_lambda_c
+0000c4d0: 6c6f 7564 2020 2320 446f 6573 6e27 7420  loud  # Doesn't 
+0000c4e0: 7375 7070 6f72 7420 4c61 6d62 6461 2043  support Lambda C
+0000c4f0: 6c6f 7564 2066 6f72 206e 6f77 0a40 7079  loud for now.@py
+0000c500: 7465 7374 2e6d 6172 6b2e 6e6f 5f69 626d  test.mark.no_ibm
+0000c510: 2020 2320 446f 6573 6e27 7420 7375 7070    # Doesn't supp
+0000c520: 6f72 7420 4942 4d20 436c 6f75 6420 666f  ort IBM Cloud fo
+0000c530: 7220 6e6f 770a 4070 7974 6573 742e 6d61  r now.@pytest.ma
+0000c540: 726b 2e6e 6f5f 7061 7065 7273 7061 6365  rk.no_paperspace
+0000c550: 2020 2320 5061 7065 7273 7061 6365 2064    # Paperspace d
+0000c560: 6f65 736e 2774 2068 6176 6520 5434 2047  oesn't have T4 G
+0000c570: 5055 730a 4070 7974 6573 742e 6d61 726b  PUs.@pytest.mark
+0000c580: 2e6e 6f5f 7363 7020 2023 2044 6f65 736e  .no_scp  # Doesn
+0000c590: 2774 2073 7570 706f 7274 2053 4350 2066  't support SCP f
+0000c5a0: 6f72 206e 6f77 0a40 7079 7465 7374 2e6d  or now.@pytest.m
+0000c5b0: 6172 6b2e 6e6f 5f6f 6369 2020 2320 446f  ark.no_oci  # Do
+0000c5c0: 6573 6e27 7420 7375 7070 6f72 7420 4f43  esn't support OC
+0000c5d0: 4920 666f 7220 6e6f 770a 4070 7974 6573  I for now.@pytes
+0000c5e0: 742e 6d61 726b 2e6e 6f5f 6b75 6265 726e  t.mark.no_kubern
+0000c5f0: 6574 6573 2020 2320 446f 6573 6e27 7420  etes  # Doesn't 
+0000c600: 7375 7070 6f72 7420 4b75 6265 726e 6574  support Kubernet
+0000c610: 6573 2066 6f72 206e 6f77 0a40 7079 7465  es for now.@pyte
+0000c620: 7374 2e6d 6172 6b2e 7061 7261 6d65 7472  st.mark.parametr
+0000c630: 697a 6528 0a20 2020 2027 696d 6167 655f  ize(.    'image_
+0000c640: 6964 272c 0a20 2020 205b 0a20 2020 2020  id',.    [.     
+0000c650: 2020 2027 646f 636b 6572 3a6e 7669 6469     'docker:nvidi
+0000c660: 612f 6375 6461 3a31 312e 382e 302d 6465  a/cuda:11.8.0-de
+0000c670: 7665 6c2d 7562 756e 7475 3138 2e30 3427  vel-ubuntu18.04'
+0000c680: 2c0a 2020 2020 2020 2020 2764 6f63 6b65  ,.        'docke
+0000c690: 723a 7562 756e 7475 3a31 382e 3034 272c  r:ubuntu:18.04',
+0000c6a0: 0a20 2020 2020 2020 2023 2054 6573 7420  .        # Test 
+0000c6b0: 6c61 7465 7374 2069 6d61 6765 2077 6974  latest image wit
+0000c6c0: 6820 7079 7468 6f6e 2033 2e31 3120 696e  h python 3.11 in
+0000c6d0: 7374 616c 6c65 6420 6279 2064 6566 6175  stalled by defau
+0000c6e0: 6c74 2e0a 2020 2020 2020 2020 2764 6f63  lt..        'doc
+0000c6f0: 6b65 723a 636f 6e74 696e 7575 6d69 6f2f  ker:continuumio/
+0000c700: 6d69 6e69 636f 6e64 6133 3a32 342e 312e  miniconda3:24.1.
+0000c710: 322d 3027 2c0a 2020 2020 2020 2020 2320  2-0',.        # 
+0000c720: 5465 7374 2070 7974 686f 6e3e 3d33 2e31  Test python>=3.1
+0000c730: 3220 7768 6572 6520 536b 7950 696c 6f74  2 where SkyPilot
+0000c740: 2073 686f 756c 6420 6175 746f 6d61 7469   should automati
+0000c750: 6361 6c6c 7920 6372 6561 7465 2061 2073  cally create a s
+0000c760: 6570 6172 6174 650a 2020 2020 2020 2020  eparate.        
+0000c770: 2320 636f 6e64 6120 656e 7620 666f 7220  # conda env for 
+0000c780: 7275 6e74 696d 6520 7769 7468 2070 7974  runtime with pyt
+0000c790: 686f 6e20 332e 3130 2e0a 2020 2020 2020  hon 3.10..      
+0000c7a0: 2020 2764 6f63 6b65 723a 636f 6e74 696e    'docker:contin
+0000c7b0: 7575 6d69 6f2f 6d69 6e69 636f 6e64 6133  uumio/miniconda3
+0000c7c0: 3a6c 6174 6573 7427 2c0a 2020 2020 2020  :latest',.      
+0000c7d0: 2020 2320 4178 6f6c 6f74 6c20 696d 6167    # Axolotl imag
+0000c7e0: 6520 6973 2061 2067 6f6f 6420 6578 616d  e is a good exam
+0000c7f0: 706c 6520 6375 7374 6f6d 2069 6d61 6765  ple custom image
+0000c800: 2074 6861 7420 6861 7320 6974 7320 636f   that has its co
+0000c810: 6e64 6120 7061 7468 0a20 2020 2020 2020  nda path.       
+0000c820: 2023 2073 6574 2069 6e20 5041 5448 2077   # set in PATH w
+0000c830: 6974 6820 646f 636b 6572 6669 6c65 2061  ith dockerfile a
+0000c840: 6e64 2075 7365 7320 7079 7468 6f6e 3e3d  nd uses python>=
+0000c850: 332e 3132 2e20 4974 2063 6f75 6c64 2074  3.12. It could t
+0000c860: 6573 743a 0a20 2020 2020 2020 2023 2020  est:.        #  
+0000c870: 312e 2077 6520 6861 6e64 6c65 2074 6865  1. we handle the
+0000c880: 2065 6e76 2076 6172 2073 6574 2069 6e20   env var set in 
+0000c890: 646f 636b 6572 6669 6c65 2063 6f72 7265  dockerfile corre
+0000c8a0: 6374 6c79 0a20 2020 2020 2020 2023 2020  ctly.        #  
+0000c8b0: 322e 2070 7974 686f 6e3e 3d33 2e31 3220  2. python>=3.12 
+0000c8c0: 776f 726b 7320 7769 7468 2053 6b79 5069  works with SkyPi
+0000c8d0: 6c6f 7420 7275 6e74 696d 652e 0a20 2020  lot runtime..   
+0000c8e0: 2020 2020 2027 646f 636b 6572 3a77 696e       'docker:win
+0000c8f0: 676c 6961 6e2f 6178 6f6c 6f74 6c3a 6d61  glian/axolotl:ma
+0000c900: 696e 2d6c 6174 6573 7427 0a20 2020 205d  in-latest'.    ]
+0000c910: 290a 6465 6620 7465 7374 5f6a 6f62 5f71  ).def test_job_q
+0000c920: 7565 7565 5f77 6974 685f 646f 636b 6572  ueue_with_docker
+0000c930: 2867 656e 6572 6963 5f63 6c6f 7564 3a20  (generic_cloud: 
+0000c940: 7374 722c 2069 6d61 6765 5f69 643a 2073  str, image_id: s
+0000c950: 7472 293a 0a20 2020 206e 616d 6520 3d20  tr):.    name = 
+0000c960: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+0000c970: 6528 2920 2b20 696d 6167 655f 6964 5b6c  e() + image_id[l
+0000c980: 656e 2827 646f 636b 6572 3a27 293a 5d5b  en('docker:'):][
+0000c990: 3a34 5d0a 2020 2020 746f 7461 6c5f 7469  :4].    total_ti
+0000c9a0: 6d65 6f75 745f 6d69 6e75 7465 7320 3d20  meout_minutes = 
+0000c9b0: 3430 2069 6620 6765 6e65 7269 635f 636c  40 if generic_cl
+0000c9c0: 6f75 6420 3d3d 2027 617a 7572 6527 2065  oud == 'azure' e
+0000c9d0: 6c73 6520 3135 0a20 2020 2074 696d 655f  lse 15.    time_
+0000c9e0: 746f 5f73 6c65 6570 203d 2033 3030 2069  to_sleep = 300 i
+0000c9f0: 6620 6765 6e65 7269 635f 636c 6f75 6420  f generic_cloud 
+0000ca00: 3d3d 2027 617a 7572 6527 2065 6c73 6520  == 'azure' else 
+0000ca10: 3138 300a 2020 2020 7465 7374 203d 2054  180.    test = T
+0000ca20: 6573 7428 0a20 2020 2020 2020 2027 6a6f  est(.        'jo
+0000ca30: 625f 7175 6575 655f 7769 7468 5f64 6f63  b_queue_with_doc
+0000ca40: 6b65 7227 2c0a 2020 2020 2020 2020 5b0a  ker',.        [.
+0000ca50: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000ca60: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+0000ca70: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
+0000ca80: 656e 6572 6963 5f63 6c6f 7564 7d20 2d2d  eneric_cloud} --
+0000ca90: 696d 6167 652d 6964 207b 696d 6167 655f  image-id {image_
+0000caa0: 6964 7d20 6578 616d 706c 6573 2f6a 6f62  id} examples/job
+0000cab0: 5f71 7565 7565 2f63 6c75 7374 6572 5f64  _queue/cluster_d
+0000cac0: 6f63 6b65 722e 7961 6d6c 272c 0a20 2020  ocker.yaml',.   
+0000cad0: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+0000cae0: 7865 6320 7b6e 616d 657d 202d 6e20 7b6e  xec {name} -n {n
+0000caf0: 616d 657d 2d31 202d 6420 2d2d 696d 6167  ame}-1 -d --imag
+0000cb00: 652d 6964 207b 696d 6167 655f 6964 7d20  e-id {image_id} 
+0000cb10: 2d2d 656e 7620 5449 4d45 5f54 4f5f 534c  --env TIME_TO_SL
+0000cb20: 4545 503d 7b74 696d 655f 746f 5f73 6c65  EEP={time_to_sle
+0000cb30: 6570 7d20 6578 616d 706c 6573 2f6a 6f62  ep} examples/job
+0000cb40: 5f71 7565 7565 2f6a 6f62 5f64 6f63 6b65  _queue/job_docke
+0000cb50: 722e 7961 6d6c 272c 0a20 2020 2020 2020  r.yaml',.       
+0000cb60: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+0000cb70: 7b6e 616d 657d 202d 6e20 7b6e 616d 657d  {name} -n {name}
+0000cb80: 2d32 202d 6420 2d2d 696d 6167 652d 6964  -2 -d --image-id
+0000cb90: 207b 696d 6167 655f 6964 7d20 2d2d 656e   {image_id} --en
+0000cba0: 7620 5449 4d45 5f54 4f5f 534c 4545 503d  v TIME_TO_SLEEP=
+0000cbb0: 7b74 696d 655f 746f 5f73 6c65 6570 7d20  {time_to_sleep} 
+0000cbc0: 6578 616d 706c 6573 2f6a 6f62 5f71 7565  examples/job_que
+0000cbd0: 7565 2f6a 6f62 5f64 6f63 6b65 722e 7961  ue/job_docker.ya
+0000cbe0: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+0000cbf0: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+0000cc00: 657d 202d 6e20 7b6e 616d 657d 2d33 202d  e} -n {name}-3 -
+0000cc10: 6420 2d2d 696d 6167 652d 6964 207b 696d  d --image-id {im
+0000cc20: 6167 655f 6964 7d20 2d2d 656e 7620 5449  age_id} --env TI
+0000cc30: 4d45 5f54 4f5f 534c 4545 503d 7b74 696d  ME_TO_SLEEP={tim
+0000cc40: 655f 746f 5f73 6c65 6570 7d20 6578 616d  e_to_sleep} exam
+0000cc50: 706c 6573 2f6a 6f62 5f71 7565 7565 2f6a  ples/job_queue/j
+0000cc60: 6f62 5f64 6f63 6b65 722e 7961 6d6c 272c  ob_docker.yaml',
+0000cc70: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000cc80: 3d24 2873 6b79 2071 7565 7565 207b 6e61  =$(sky queue {na
+0000cc90: 6d65 7d29 3b20 6563 686f 2022 2473 223b  me}); echo "$s";
+0000cca0: 2065 6368 6f3b 2065 6368 6f3b 2065 6368   echo; echo; ech
+0000ccb0: 6f20 2224 7322 207c 2067 7265 7020 7b6e  o "$s" | grep {n
+0000ccc0: 616d 657d 2d31 207c 2067 7265 7020 5255  ame}-1 | grep RU
+0000ccd0: 4e4e 494e 4727 2c0a 2020 2020 2020 2020  NNING',.        
+0000cce0: 2020 2020 6627 733d 2428 736b 7920 7175      f's=$(sky qu
+0000ccf0: 6575 6520 7b6e 616d 657d 293b 2065 6368  eue {name}); ech
+0000cd00: 6f20 2224 7322 3b20 6563 686f 3b20 6563  o "$s"; echo; ec
+0000cd10: 686f 3b20 6563 686f 2022 2473 2220 7c20  ho; echo "$s" | 
+0000cd20: 6772 6570 207b 6e61 6d65 7d2d 3220 7c20  grep {name}-2 | 
+0000cd30: 6772 6570 2052 554e 4e49 4e47 272c 0a20  grep RUNNING',. 
+0000cd40: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
+0000cd50: 2873 6b79 2071 7565 7565 207b 6e61 6d65  (sky queue {name
+0000cd60: 7d29 3b20 6563 686f 2022 2473 223b 2065  }); echo "$s"; e
+0000cd70: 6368 6f3b 2065 6368 6f3b 2065 6368 6f20  cho; echo; echo 
+0000cd80: 2224 7322 207c 2067 7265 7020 7b6e 616d  "$s" | grep {nam
+0000cd90: 657d 2d33 207c 2067 7265 7020 5045 4e44  e}-3 | grep PEND
+0000cda0: 494e 4727 2c0a 2020 2020 2020 2020 2020  ING',.          
+0000cdb0: 2020 6627 736b 7920 6361 6e63 656c 202d    f'sky cancel -
+0000cdc0: 7920 7b6e 616d 657d 2032 272c 0a20 2020  y {name} 2',.   
+0000cdd0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+0000cde0: 3527 2c0a 2020 2020 2020 2020 2020 2020  5',.            
+0000cdf0: 6627 733d 2428 736b 7920 7175 6575 6520  f's=$(sky queue 
+0000ce00: 7b6e 616d 657d 293b 2065 6368 6f20 2224  {name}); echo "$
+0000ce10: 7322 3b20 6563 686f 3b20 6563 686f 3b20  s"; echo; echo; 
+0000ce20: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
+0000ce30: 207b 6e61 6d65 7d2d 3320 7c20 6772 6570   {name}-3 | grep
+0000ce40: 2052 554e 4e49 4e47 272c 0a20 2020 2020   RUNNING',.     
+0000ce50: 2020 2020 2020 2066 2773 6b79 2063 616e         f'sky can
+0000ce60: 6365 6c20 2d79 207b 6e61 6d65 7d20 3327  cel -y {name} 3'
+0000ce70: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+0000ce80: 4d61 6b65 2073 7572 6520 7468 6520 4750  Make sure the GP
+0000ce90: 5520 6973 2073 7469 6c6c 2076 6973 6962  U is still visib
+0000cea0: 6c65 2074 6f20 7468 6520 636f 6e74 6169  le to the contai
+0000ceb0: 6e65 722e 0a20 2020 2020 2020 2020 2020  ner..           
+0000cec0: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+0000ced0: 657d 202d 2d69 6d61 6765 2d69 6420 7b69  e} --image-id {i
+0000cee0: 6d61 6765 5f69 647d 206e 7669 6469 612d  mage_id} nvidia-
+0000cef0: 736d 6920 7c20 6772 6570 2022 5465 736c  smi | grep "Tesl
+0000cf00: 6120 5434 2227 2c0a 2020 2020 2020 2020  a T4"',.        
+0000cf10: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+0000cf20: 6e61 6d65 7d20 3420 2d2d 7374 6174 7573  name} 4 --status
+0000cf30: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000cf40: 2773 6b79 2073 746f 7020 2d79 207b 6e61  'sky stop -y {na
+0000cf50: 6d65 7d27 2c0a 2020 2020 2020 2020 2020  me}',.          
+0000cf60: 2020 2320 4d61 6b65 2073 7572 6520 7468    # Make sure th
+0000cf70: 6520 6a6f 6220 7374 6174 7573 2070 7265  e job status pre
+0000cf80: 7365 7276 6520 6166 7465 7220 7374 6f70  serve after stop
+0000cf90: 2061 6e64 2073 7461 7274 2074 6865 0a20   and start the. 
+0000cfa0: 2020 2020 2020 2020 2020 2023 2063 6c75             # clu
+0000cfb0: 7374 6572 2e20 5468 6973 2069 7320 616c  ster. This is al
+0000cfc0: 736f 2061 2074 6573 7420 666f 7220 7468  so a test for th
+0000cfd0: 6520 646f 636b 6572 2063 6f6e 7461 696e  e docker contain
+0000cfe0: 6572 2074 6f20 6265 0a20 2020 2020 2020  er to be.       
+0000cff0: 2020 2020 2023 2070 7265 7365 7276 6564       # preserved
+0000d000: 2061 6674 6572 2073 746f 7020 616e 6420   after stop and 
+0000d010: 7374 6172 742e 0a20 2020 2020 2020 2020  start..         
+0000d020: 2020 2066 2773 6b79 2073 7461 7274 202d     f'sky start -
+0000d030: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
+0000d040: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
+0000d050: 2071 7565 7565 207b 6e61 6d65 7d29 3b20   queue {name}); 
+0000d060: 6563 686f 2022 2473 223b 2065 6368 6f3b  echo "$s"; echo;
+0000d070: 2065 6368 6f3b 2065 6368 6f20 2224 7322   echo; echo "$s"
+0000d080: 207c 2067 7265 7020 7b6e 616d 657d 2d31   | grep {name}-1
+0000d090: 207c 2067 7265 7020 4641 494c 4544 272c   | grep FAILED',
+0000d0a0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000d0b0: 3d24 2873 6b79 2071 7565 7565 207b 6e61  =$(sky queue {na
+0000d0c0: 6d65 7d29 3b20 6563 686f 2022 2473 223b  me}); echo "$s";
+0000d0d0: 2065 6368 6f3b 2065 6368 6f3b 2065 6368   echo; echo; ech
+0000d0e0: 6f20 2224 7322 207c 2067 7265 7020 7b6e  o "$s" | grep {n
+0000d0f0: 616d 657d 2d32 207c 2067 7265 7020 4341  ame}-2 | grep CA
+0000d100: 4e43 454c 4c45 4427 2c0a 2020 2020 2020  NCELLED',.      
+0000d110: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
+0000d120: 7175 6575 6520 7b6e 616d 657d 293b 2065  queue {name}); e
+0000d130: 6368 6f20 2224 7322 3b20 6563 686f 3b20  cho "$s"; echo; 
+0000d140: 6563 686f 3b20 6563 686f 2022 2473 2220  echo; echo "$s" 
+0000d150: 7c20 6772 6570 207b 6e61 6d65 7d2d 3320  | grep {name}-3 
+0000d160: 7c20 6772 6570 2043 414e 4345 4c4c 4544  | grep CANCELLED
+0000d170: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000d180: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+0000d190: 202d 2d67 7075 7320 5434 3a30 2e32 2022   --gpus T4:0.2 "
+0000d1a0: 5b5b 205c 2453 4b59 5049 4c4f 545f 4e55  [[ \$SKYPILOT_NU
+0000d1b0: 4d5f 4750 5553 5f50 4552 5f4e 4f44 4520  M_GPUS_PER_NODE 
+0000d1c0: 2d65 7120 3120 5d5d 207c 7c20 6578 6974  -eq 1 ]] || exit
+0000d1d0: 2031 2227 2c0a 2020 2020 2020 2020 2020   1"',.          
+0000d1e0: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+0000d1f0: 6d65 7d20 2d2d 6770 7573 2054 343a 3120  me} --gpus T4:1 
+0000d200: 225b 5b20 5c24 534b 5950 494c 4f54 5f4e  "[[ \$SKYPILOT_N
+0000d210: 554d 5f47 5055 535f 5045 525f 4e4f 4445  UM_GPUS_PER_NODE
+0000d220: 202d 6571 2031 205d 5d20 7c7c 2065 7869   -eq 1 ]] || exi
+0000d230: 7420 3122 272c 0a20 2020 2020 2020 2020  t 1"',.         
+0000d240: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+0000d250: 616d 657d 2035 202d 2d73 7461 7475 7327  ame} 5 --status'
+0000d260: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000d270: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+0000d280: 3620 2d2d 7374 6174 7573 272c 0a20 2020  6 --status',.   
+0000d290: 2020 2020 2020 2020 2023 204d 616b 6520           # Make 
+0000d2a0: 7375 7265 2069 7420 6973 2073 7469 6c6c  sure it is still
+0000d2b0: 2076 6973 6962 6c65 2061 6674 6572 2061   visible after a
+0000d2c0: 6e20 7374 6f70 2026 2073 7461 7274 2063  n stop & start c
+0000d2d0: 7963 6c65 2e0a 2020 2020 2020 2020 2020  ycle..          
+0000d2e0: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+0000d2f0: 6d65 7d20 2d2d 696d 6167 652d 6964 207b  me} --image-id {
+0000d300: 696d 6167 655f 6964 7d20 6e76 6964 6961  image_id} nvidia
+0000d310: 2d73 6d69 207c 2067 7265 7020 2254 6573  -smi | grep "Tes
+0000d320: 6c61 2054 3422 272c 0a20 2020 2020 2020  la T4"',.       
+0000d330: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+0000d340: 7b6e 616d 657d 2037 202d 2d73 7461 7475  {name} 7 --statu
+0000d350: 7327 0a20 2020 2020 2020 205d 2c0a 2020  s'.        ],.  
+0000d360: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+0000d370: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+0000d380: 2020 2020 2074 696d 656f 7574 3d74 6f74       timeout=tot
+0000d390: 616c 5f74 696d 656f 7574 5f6d 696e 7574  al_timeout_minut
+0000d3a0: 6573 202a 2036 302c 0a20 2020 2029 0a20  es * 60,.    ). 
+0000d3b0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+0000d3c0: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+0000d3d0: 6d61 726b 2e6c 616d 6264 615f 636c 6f75  mark.lambda_clou
+0000d3e0: 640a 6465 6620 7465 7374 5f6c 616d 6264  d.def test_lambd
+0000d3f0: 615f 6a6f 625f 7175 6575 6528 293a 0a20  a_job_queue():. 
+0000d400: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+0000d410: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+0000d420: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+0000d430: 2020 2020 2020 2027 6c61 6d62 6461 5f6a         'lambda_j
+0000d440: 6f62 5f71 7565 7565 272c 0a20 2020 2020  ob_queue',.     
+0000d450: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+0000d460: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+0000d470: 202d 6320 7b6e 616d 657d 207b 4c41 4d42   -c {name} {LAMB
+0000d480: 4441 5f54 5950 457d 2065 7861 6d70 6c65  DA_TYPE} example
+0000d490: 732f 6a6f 625f 7175 6575 652f 636c 7573  s/job_queue/clus
+0000d4a0: 7465 722e 7961 6d6c 272c 0a20 2020 2020  ter.yaml',.     
+0000d4b0: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+0000d4c0: 6320 7b6e 616d 657d 202d 6e20 7b6e 616d  c {name} -n {nam
+0000d4d0: 657d 2d31 202d 2d67 7075 7320 4131 303a  e}-1 --gpus A10:
+0000d4e0: 302e 3520 2d64 2065 7861 6d70 6c65 732f  0.5 -d examples/
+0000d4f0: 6a6f 625f 7175 6575 652f 6a6f 622e 7961  job_queue/job.ya
+0000d500: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+0000d510: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+0000d520: 657d 202d 6e20 7b6e 616d 657d 2d32 202d  e} -n {name}-2 -
+0000d530: 2d67 7075 7320 4131 303a 302e 3520 2d64  -gpus A10:0.5 -d
+0000d540: 2065 7861 6d70 6c65 732f 6a6f 625f 7175   examples/job_qu
+0000d550: 6575 652f 6a6f 622e 7961 6d6c 272c 0a20  eue/job.yaml',. 
+0000d560: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000d570: 2065 7865 6320 7b6e 616d 657d 202d 6e20   exec {name} -n 
+0000d580: 7b6e 616d 657d 2d33 202d 2d67 7075 7320  {name}-3 --gpus 
+0000d590: 4131 303a 302e 3520 2d64 2065 7861 6d70  A10:0.5 -d examp
+0000d5a0: 6c65 732f 6a6f 625f 7175 6575 652f 6a6f  les/job_queue/jo
+0000d5b0: 622e 7961 6d6c 272c 0a20 2020 2020 2020  b.yaml',.       
+0000d5c0: 2020 2020 2066 2773 6b79 2071 7565 7565       f'sky queue
+0000d5d0: 207b 6e61 6d65 7d20 7c20 6772 6570 207b   {name} | grep {
+0000d5e0: 6e61 6d65 7d2d 3120 7c20 6772 6570 2052  name}-1 | grep R
+0000d5f0: 554e 4e49 4e47 272c 0a20 2020 2020 2020  UNNING',.       
+0000d600: 2020 2020 2066 2773 6b79 2071 7565 7565       f'sky queue
+0000d610: 207b 6e61 6d65 7d20 7c20 6772 6570 207b   {name} | grep {
+0000d620: 6e61 6d65 7d2d 3220 7c20 6772 6570 2052  name}-2 | grep R
+0000d630: 554e 4e49 4e47 272c 0a20 2020 2020 2020  UNNING',.       
+0000d640: 2020 2020 2066 2773 6b79 2071 7565 7565       f'sky queue
+0000d650: 207b 6e61 6d65 7d20 7c20 6772 6570 207b   {name} | grep {
+0000d660: 6e61 6d65 7d2d 3320 7c20 6772 6570 2050  name}-3 | grep P
+0000d670: 454e 4449 4e47 272c 0a20 2020 2020 2020  ENDING',.       
+0000d680: 2020 2020 2066 2773 6b79 2063 616e 6365       f'sky cance
+0000d690: 6c20 2d79 207b 6e61 6d65 7d20 3227 2c0a  l -y {name} 2',.
+0000d6a0: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+0000d6b0: 6570 2035 272c 0a20 2020 2020 2020 2020  ep 5',.         
+0000d6c0: 2020 2066 2773 6b79 2071 7565 7565 207b     f'sky queue {
+0000d6d0: 6e61 6d65 7d20 7c20 6772 6570 207b 6e61  name} | grep {na
+0000d6e0: 6d65 7d2d 3320 7c20 6772 6570 2052 554e  me}-3 | grep RUN
+0000d6f0: 4e49 4e47 272c 0a20 2020 2020 2020 2020  NING',.         
+0000d700: 2020 2066 2773 6b79 2063 616e 6365 6c20     f'sky cancel 
+0000d710: 2d79 207b 6e61 6d65 7d20 3327 2c0a 2020  -y {name} 3',.  
+0000d720: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+0000d730: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+0000d740: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
+0000d750: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+0000d760: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+0000d770: 6172 6b2e 6962 6d0a 6465 6620 7465 7374  ark.ibm.def test
+0000d780: 5f69 626d 5f6a 6f62 5f71 7565 7565 2829  _ibm_job_queue()
+0000d790: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+0000d7a0: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+0000d7b0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+0000d7c0: 280a 2020 2020 2020 2020 2769 626d 5f6a  (.        'ibm_j
+0000d7d0: 6f62 5f71 7565 7565 272c 0a20 2020 2020  ob_queue',.     
+0000d7e0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+0000d7f0: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+0000d800: 202d 6320 7b6e 616d 657d 202d 2d63 6c6f   -c {name} --clo
+0000d810: 7564 2069 626d 202d 2d67 7075 7320 7631  ud ibm --gpus v1
+0000d820: 3030 272c 0a20 2020 2020 2020 2020 2020  00',.           
+0000d830: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+0000d840: 657d 202d 6e20 7b6e 616d 657d 2d31 202d  e} -n {name}-1 -
+0000d850: 2d63 6c6f 7564 2069 626d 202d 6420 6578  -cloud ibm -d ex
+0000d860: 616d 706c 6573 2f6a 6f62 5f71 7565 7565  amples/job_queue
+0000d870: 2f6a 6f62 5f69 626d 2e79 616d 6c27 2c0a  /job_ibm.yaml',.
+0000d880: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000d890: 7920 6578 6563 207b 6e61 6d65 7d20 2d6e  y exec {name} -n
+0000d8a0: 207b 6e61 6d65 7d2d 3220 2d2d 636c 6f75   {name}-2 --clou
+0000d8b0: 6420 6962 6d20 2d64 2065 7861 6d70 6c65  d ibm -d example
+0000d8c0: 732f 6a6f 625f 7175 6575 652f 6a6f 625f  s/job_queue/job_
+0000d8d0: 6962 6d2e 7961 6d6c 272c 0a20 2020 2020  ibm.yaml',.     
+0000d8e0: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
+0000d8f0: 6320 7b6e 616d 657d 202d 6e20 7b6e 616d  c {name} -n {nam
+0000d900: 657d 2d33 202d 2d63 6c6f 7564 2069 626d  e}-3 --cloud ibm
+0000d910: 202d 6420 6578 616d 706c 6573 2f6a 6f62   -d examples/job
+0000d920: 5f71 7565 7565 2f6a 6f62 5f69 626d 2e79  _queue/job_ibm.y
+0000d930: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+0000d940: 2020 6627 736b 7920 7175 6575 6520 7b6e    f'sky queue {n
+0000d950: 616d 657d 207c 2067 7265 7020 7b6e 616d  ame} | grep {nam
+0000d960: 657d 2d31 207c 2067 7265 7020 5255 4e4e  e}-1 | grep RUNN
+0000d970: 494e 4727 2c0a 2020 2020 2020 2020 2020  ING',.          
+0000d980: 2020 6627 736b 7920 7175 6575 6520 7b6e    f'sky queue {n
+0000d990: 616d 657d 207c 2067 7265 7020 7b6e 616d  ame} | grep {nam
+0000d9a0: 657d 2d32 207c 2067 7265 7020 5255 4e4e  e}-2 | grep RUNN
+0000d9b0: 494e 4727 2c0a 2020 2020 2020 2020 2020  ING',.          
+0000d9c0: 2020 6627 736b 7920 7175 6575 6520 7b6e    f'sky queue {n
+0000d9d0: 616d 657d 207c 2067 7265 7020 7b6e 616d  ame} | grep {nam
+0000d9e0: 657d 2d33 207c 2067 7265 7020 5045 4e44  e}-3 | grep PEND
+0000d9f0: 494e 4727 2c0a 2020 2020 2020 2020 2020  ING',.          
+0000da00: 2020 6627 736b 7920 6361 6e63 656c 202d    f'sky cancel -
+0000da10: 7920 7b6e 616d 657d 2032 272c 0a20 2020  y {name} 2',.   
+0000da20: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+0000da30: 3527 2c0a 2020 2020 2020 2020 2020 2020  5',.            
+0000da40: 6627 736b 7920 7175 6575 6520 7b6e 616d  f'sky queue {nam
+0000da50: 657d 207c 2067 7265 7020 7b6e 616d 657d  e} | grep {name}
+0000da60: 2d33 207c 2067 7265 7020 5255 4e4e 494e  -3 | grep RUNNIN
+0000da70: 4727 2c0a 2020 2020 2020 2020 2020 2020  G',.            
+0000da80: 6627 736b 7920 6361 6e63 656c 202d 7920  f'sky cancel -y 
+0000da90: 7b6e 616d 657d 2033 272c 0a20 2020 2020  {name} 3',.     
+0000daa0: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
+0000dab0: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
+0000dac0: 657d 272c 0a20 2020 2029 0a20 2020 2072  e}',.    ).    r
+0000dad0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+0000dae0: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+0000daf0: 2e73 6370 0a64 6566 2074 6573 745f 7363  .scp.def test_sc
+0000db00: 705f 6a6f 625f 7175 6575 6528 293a 0a20  p_job_queue():. 
+0000db10: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+0000db20: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+0000db30: 2020 6e75 6d5f 6f66 5f67 7075 5f6c 6175    num_of_gpu_lau
+0000db40: 6e63 6820 3d20 310a 2020 2020 6e75 6d5f  nch = 1.    num_
+0000db50: 6f66 5f67 7075 5f65 7865 6320 3d20 302e  of_gpu_exec = 0.
+0000db60: 350a 2020 2020 7465 7374 203d 2054 6573  5.    test = Tes
+0000db70: 7428 0a20 2020 2020 2020 2027 5343 505f  t(.        'SCP_
+0000db80: 6a6f 625f 7175 6575 6527 2c0a 2020 2020  job_queue',.    
+0000db90: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+0000dba0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+0000dbb0: 7920 2d63 207b 6e61 6d65 7d20 7b53 4350  y -c {name} {SCP
+0000dbc0: 5f54 5950 457d 207b 5343 505f 4750 555f  _TYPE} {SCP_GPU_
+0000dbd0: 5631 3030 7d3a 7b6e 756d 5f6f 665f 6770  V100}:{num_of_gp
+0000dbe0: 755f 6c61 756e 6368 7d20 6578 616d 706c  u_launch} exampl
+0000dbf0: 6573 2f6a 6f62 5f71 7565 7565 2f63 6c75  es/job_queue/clu
+0000dc00: 7374 6572 2e79 616d 6c27 2c0a 2020 2020  ster.yaml',.    
+0000dc10: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+0000dc20: 6563 207b 6e61 6d65 7d20 2d6e 207b 6e61  ec {name} -n {na
+0000dc30: 6d65 7d2d 3120 7b53 4350 5f47 5055 5f56  me}-1 {SCP_GPU_V
+0000dc40: 3130 307d 3a7b 6e75 6d5f 6f66 5f67 7075  100}:{num_of_gpu
+0000dc50: 5f65 7865 637d 202d 6420 6578 616d 706c  _exec} -d exampl
+0000dc60: 6573 2f6a 6f62 5f71 7565 7565 2f6a 6f62  es/job_queue/job
+0000dc70: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+0000dc80: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+0000dc90: 6e61 6d65 7d20 2d6e 207b 6e61 6d65 7d2d  name} -n {name}-
+0000dca0: 3220 7b53 4350 5f47 5055 5f56 3130 307d  2 {SCP_GPU_V100}
+0000dcb0: 3a7b 6e75 6d5f 6f66 5f67 7075 5f65 7865  :{num_of_gpu_exe
+0000dcc0: 637d 202d 6420 6578 616d 706c 6573 2f6a  c} -d examples/j
+0000dcd0: 6f62 5f71 7565 7565 2f6a 6f62 2e79 616d  ob_queue/job.yam
+0000dce0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+0000dcf0: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+0000dd00: 7d20 2d6e 207b 6e61 6d65 7d2d 3320 7b53  } -n {name}-3 {S
+0000dd10: 4350 5f47 5055 5f56 3130 307d 3a7b 6e75  CP_GPU_V100}:{nu
+0000dd20: 6d5f 6f66 5f67 7075 5f65 7865 637d 202d  m_of_gpu_exec} -
+0000dd30: 6420 6578 616d 706c 6573 2f6a 6f62 5f71  d examples/job_q
+0000dd40: 7565 7565 2f6a 6f62 2e79 616d 6c27 2c0a  ueue/job.yaml',.
+0000dd50: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000dd60: 7920 7175 6575 6520 7b6e 616d 657d 207c  y queue {name} |
+0000dd70: 2067 7265 7020 7b6e 616d 657d 2d31 207c   grep {name}-1 |
+0000dd80: 2067 7265 7020 5255 4e4e 494e 4727 2c0a   grep RUNNING',.
+0000dd90: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000dda0: 7920 7175 6575 6520 7b6e 616d 657d 207c  y queue {name} |
+0000ddb0: 2067 7265 7020 7b6e 616d 657d 2d32 207c   grep {name}-2 |
+0000ddc0: 2067 7265 7020 5255 4e4e 494e 4727 2c0a   grep RUNNING',.
+0000ddd0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000dde0: 7920 7175 6575 6520 7b6e 616d 657d 207c  y queue {name} |
+0000ddf0: 2067 7265 7020 7b6e 616d 657d 2d33 207c   grep {name}-3 |
+0000de00: 2067 7265 7020 5045 4e44 494e 4727 2c0a   grep PENDING',.
+0000de10: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000de20: 7920 6361 6e63 656c 202d 7920 7b6e 616d  y cancel -y {nam
+0000de30: 657d 2032 272c 0a20 2020 2020 2020 2020  e} 2',.         
+0000de40: 2020 2027 736c 6565 7020 3527 2c0a 2020     'sleep 5',.  
+0000de50: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000de60: 7175 6575 6520 7b6e 616d 657d 207c 2067  queue {name} | g
+0000de70: 7265 7020 7b6e 616d 657d 2d33 207c 2067  rep {name}-3 | g
+0000de80: 7265 7020 5255 4e4e 494e 4727 2c0a 2020  rep RUNNING',.  
+0000de90: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000dea0: 6361 6e63 656c 202d 7920 7b6e 616d 657d  cancel -y {name}
+0000deb0: 2033 272c 0a20 2020 2020 2020 205d 2c0a   3',.        ],.
+0000dec0: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+0000ded0: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
+0000dee0: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+0000def0: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
+0000df00: 7974 6573 742e 6d61 726b 2e6e 6f5f 666c  ytest.mark.no_fl
+0000df10: 7569 6473 7461 636b 2020 2320 466c 7569  uidstack  # Flui
+0000df20: 6453 7461 636b 2044 4320 6861 7320 6c6f  dStack DC has lo
+0000df30: 7720 6176 6169 6c61 6269 6c69 7479 206f  w availability o
+0000df40: 6620 5434 2047 5055 730a 4070 7974 6573  f T4 GPUs.@pytes
+0000df50: 742e 6d61 726b 2e6e 6f5f 6c61 6d62 6461  t.mark.no_lambda
+0000df60: 5f63 6c6f 7564 2020 2320 4c61 6d62 6461  _cloud  # Lambda
+0000df70: 2043 6c6f 7564 2064 6f65 7320 6e6f 7420   Cloud does not 
+0000df80: 6861 7665 2054 3420 6770 7573 0a40 7079  have T4 gpus.@py
+0000df90: 7465 7374 2e6d 6172 6b2e 6e6f 5f69 626d  test.mark.no_ibm
+0000dfa0: 2020 2320 4942 4d20 436c 6f75 6420 646f    # IBM Cloud do
+0000dfb0: 6573 206e 6f74 2068 6176 6520 5434 2067  es not have T4 g
+0000dfc0: 7075 732e 2072 756e 2074 6573 745f 6962  pus. run test_ib
+0000dfd0: 6d5f 6a6f 625f 7175 6575 655f 6d75 6c74  m_job_queue_mult
+0000dfe0: 696e 6f64 6520 696e 7374 6561 640a 4070  inode instead.@p
+0000dff0: 7974 6573 742e 6d61 726b 2e6e 6f5f 7061  ytest.mark.no_pa
+0000e000: 7065 7273 7061 6365 2020 2320 5061 7065  perspace  # Pape
+0000e010: 7273 7061 6365 2064 6f65 7320 6e6f 7420  rspace does not 
+0000e020: 6861 7665 2054 3420 6770 7573 2e0a 4070  have T4 gpus..@p
+0000e030: 7974 6573 742e 6d61 726b 2e6e 6f5f 7363  ytest.mark.no_sc
+0000e040: 7020 2023 2053 4350 2064 6f65 7320 6e6f  p  # SCP does no
+0000e050: 7420 7375 7070 6f72 7420 6e75 6d5f 6e6f  t support num_no
+0000e060: 6465 7320 3e20 3120 7965 740a 4070 7974  des > 1 yet.@pyt
+0000e070: 6573 742e 6d61 726b 2e6e 6f5f 6f63 6920  est.mark.no_oci 
+0000e080: 2023 204f 4349 2043 6c6f 7564 2064 6f65   # OCI Cloud doe
+0000e090: 7320 6e6f 7420 6861 7665 2054 3420 6770  s not have T4 gp
+0000e0a0: 7573 2e0a 4070 7974 6573 742e 6d61 726b  us..@pytest.mark
+0000e0b0: 2e6e 6f5f 6b75 6265 726e 6574 6573 2020  .no_kubernetes  
+0000e0c0: 2320 4b75 6265 726e 6574 6573 206e 6f74  # Kubernetes not
+0000e0d0: 2073 7570 706f 7274 206e 756d 5f6e 6f64   support num_nod
+0000e0e0: 6573 203e 2031 2079 6574 0a64 6566 2074  es > 1 yet.def t
+0000e0f0: 6573 745f 6a6f 625f 7175 6575 655f 6d75  est_job_queue_mu
+0000e100: 6c74 696e 6f64 6528 6765 6e65 7269 635f  ltinode(generic_
+0000e110: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
+0000e120: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+0000e130: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+0000e140: 746f 7461 6c5f 7469 6d65 6f75 745f 6d69  total_timeout_mi
+0000e150: 6e75 7465 7320 3d20 3330 2069 6620 6765  nutes = 30 if ge
+0000e160: 6e65 7269 635f 636c 6f75 6420 3d3d 2027  neric_cloud == '
+0000e170: 617a 7572 6527 2065 6c73 6520 3135 0a20  azure' else 15. 
+0000e180: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+0000e190: 2020 2020 2020 2020 276a 6f62 5f71 7565          'job_que
+0000e1a0: 7565 5f6d 756c 7469 6e6f 6465 272c 0a20  ue_multinode',. 
+0000e1b0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+0000e1c0: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+0000e1d0: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
+0000e1e0: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
+0000e1f0: 636c 6f75 647d 2065 7861 6d70 6c65 732f  cloud} examples/
+0000e200: 6a6f 625f 7175 6575 652f 636c 7573 7465  job_queue/cluste
+0000e210: 725f 6d75 6c74 696e 6f64 652e 7961 6d6c  r_multinode.yaml
+0000e220: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000e230: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+0000e240: 202d 6e20 7b6e 616d 657d 2d31 202d 6420   -n {name}-1 -d 
+0000e250: 6578 616d 706c 6573 2f6a 6f62 5f71 7565  examples/job_que
+0000e260: 7565 2f6a 6f62 5f6d 756c 7469 6e6f 6465  ue/job_multinode
+0000e270: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+0000e280: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
+0000e290: 6e61 6d65 7d20 2d6e 207b 6e61 6d65 7d2d  name} -n {name}-
+0000e2a0: 3220 2d64 2065 7861 6d70 6c65 732f 6a6f  2 -d examples/jo
+0000e2b0: 625f 7175 6575 652f 6a6f 625f 6d75 6c74  b_queue/job_mult
+0000e2c0: 696e 6f64 652e 7961 6d6c 272c 0a20 2020  inode.yaml',.   
+0000e2d0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+0000e2e0: 6175 6e63 6820 2d63 207b 6e61 6d65 7d20  aunch -c {name} 
+0000e2f0: 2d6e 207b 6e61 6d65 7d2d 3320 2d2d 6465  -n {name}-3 --de
+0000e300: 7461 6368 2d73 6574 7570 202d 6420 6578  tach-setup -d ex
+0000e310: 616d 706c 6573 2f6a 6f62 5f71 7565 7565  amples/job_queue
+0000e320: 2f6a 6f62 5f6d 756c 7469 6e6f 6465 2e79  /job_multinode.y
+0000e330: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+0000e340: 2020 6627 733d 2428 736b 7920 7175 6575    f's=$(sky queu
+0000e350: 6520 7b6e 616d 657d 2920 2626 2065 6368  e {name}) && ech
+0000e360: 6f20 2224 7322 2026 2620 2865 6368 6f20  o "$s" && (echo 
+0000e370: 2224 7322 207c 2067 7265 7020 7b6e 616d  "$s" | grep {nam
+0000e380: 657d 2d31 207c 2067 7265 7020 5255 4e4e  e}-1 | grep RUNN
+0000e390: 494e 4729 272c 0a20 2020 2020 2020 2020  ING)',.         
+0000e3a0: 2020 2066 2773 3d24 2873 6b79 2071 7565     f's=$(sky que
+0000e3b0: 7565 207b 6e61 6d65 7d29 2026 2620 6563  ue {name}) && ec
+0000e3c0: 686f 2022 2473 2220 2626 2028 6563 686f  ho "$s" && (echo
+0000e3d0: 2022 2473 2220 7c20 6772 6570 207b 6e61   "$s" | grep {na
+0000e3e0: 6d65 7d2d 3220 7c20 6772 6570 2052 554e  me}-2 | grep RUN
+0000e3f0: 4e49 4e47 2927 2c0a 2020 2020 2020 2020  NING)',.        
+0000e400: 2020 2020 6627 733d 2428 736b 7920 7175      f's=$(sky qu
+0000e410: 6575 6520 7b6e 616d 657d 2920 2626 2065  eue {name}) && e
+0000e420: 6368 6f20 2224 7322 2026 2620 2865 6368  cho "$s" && (ech
+0000e430: 6f20 2224 7322 207c 2067 7265 7020 7b6e  o "$s" | grep {n
+0000e440: 616d 657d 2d33 207c 2067 7265 7020 5045  ame}-3 | grep PE
+0000e450: 4e44 494e 4729 272c 0a20 2020 2020 2020  NDING)',.       
+0000e460: 2020 2020 2027 736c 6565 7020 3930 272c       'sleep 90',
+0000e470: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000e480: 6b79 2063 616e 6365 6c20 2d79 207b 6e61  ky cancel -y {na
+0000e490: 6d65 7d20 3127 2c0a 2020 2020 2020 2020  me} 1',.        
+0000e4a0: 2020 2020 2773 6c65 6570 2035 272c 0a20      'sleep 5',. 
+0000e4b0: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
+0000e4c0: 2873 6b79 2071 7565 7565 207b 6e61 6d65  (sky queue {name
+0000e4d0: 7d29 3b20 6563 686f 2022 2473 223b 2065  }); echo "$s"; e
+0000e4e0: 6368 6f3b 2065 6368 6f3b 2065 6368 6f20  cho; echo; echo 
+0000e4f0: 2224 7322 207c 2067 7265 7020 7b6e 616d  "$s" | grep {nam
+0000e500: 657d 2d33 207c 2067 7265 7020 5345 5454  e}-3 | grep SETT
+0000e510: 494e 475f 5550 272c 0a20 2020 2020 2020  ING_UP',.       
+0000e520: 2020 2020 2066 2773 6b79 2063 616e 6365       f'sky cance
+0000e530: 6c20 2d79 207b 6e61 6d65 7d20 3120 3220  l -y {name} 1 2 
+0000e540: 3327 2c0a 2020 2020 2020 2020 2020 2020  3',.            
+0000e550: 6627 736b 7920 6c61 756e 6368 202d 6320  f'sky launch -c 
+0000e560: 7b6e 616d 657d 202d 6e20 7b6e 616d 657d  {name} -n {name}
+0000e570: 2d34 202d 2d64 6574 6163 682d 7365 7475  -4 --detach-setu
+0000e580: 7020 2d64 2065 7861 6d70 6c65 732f 6a6f  p -d examples/jo
+0000e590: 625f 7175 6575 652f 6a6f 625f 6d75 6c74  b_queue/job_mult
+0000e5a0: 696e 6f64 652e 7961 6d6c 272c 0a20 2020  inode.yaml',.   
+0000e5b0: 2020 2020 2020 2020 2023 2054 6573 7420           # Test 
+0000e5c0: 7468 6520 6a6f 6220 7374 6174 7573 2069  the job status i
+0000e5d0: 7320 636f 7272 6563 746c 7920 7365 7420  s correctly set 
+0000e5e0: 746f 2053 4554 5449 4e47 5f55 502c 2064  to SETTING_UP, d
+0000e5f0: 7572 696e 6720 7468 6520 7365 7475 7020  uring the setup 
+0000e600: 6973 2072 756e 6e69 6e67 2c0a 2020 2020  is running,.    
+0000e610: 2020 2020 2020 2020 2320 616e 6420 7468          # and th
+0000e620: 6520 6a6f 6220 6361 6e20 6265 2063 616e  e job can be can
+0000e630: 6365 6c6c 6564 2064 7572 696e 6720 7468  celled during th
+0000e640: 6520 7365 7475 702e 0a20 2020 2020 2020  e setup..       
+0000e650: 2020 2020 2027 736c 6565 7020 3527 2c0a       'sleep 5',.
+0000e660: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
+0000e670: 2428 736b 7920 7175 6575 6520 7b6e 616d  $(sky queue {nam
+0000e680: 657d 2920 2626 2065 6368 6f20 2224 7322  e}) && echo "$s"
+0000e690: 2026 2620 2865 6368 6f20 2224 7322 207c   && (echo "$s" |
+0000e6a0: 2067 7265 7020 7b6e 616d 657d 2d34 207c   grep {name}-4 |
+0000e6b0: 2067 7265 7020 5345 5454 494e 475f 5550   grep SETTING_UP
+0000e6c0: 2927 2c0a 2020 2020 2020 2020 2020 2020  )',.            
+0000e6d0: 6627 736b 7920 6361 6e63 656c 202d 7920  f'sky cancel -y 
+0000e6e0: 7b6e 616d 657d 2034 272c 0a20 2020 2020  {name} 4',.     
+0000e6f0: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
+0000e700: 2071 7565 7565 207b 6e61 6d65 7d29 2026   queue {name}) &
+0000e710: 2620 6563 686f 2022 2473 2220 2626 2028  & echo "$s" && (
+0000e720: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
+0000e730: 207b 6e61 6d65 7d2d 3420 7c20 6772 6570   {name}-4 | grep
+0000e740: 2043 414e 4345 4c4c 4544 2927 2c0a 2020   CANCELLED)',.  
+0000e750: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000e760: 6578 6563 207b 6e61 6d65 7d20 2d2d 6770  exec {name} --gp
+0000e770: 7573 2054 343a 302e 3220 225b 5b20 5c24  us T4:0.2 "[[ \$
+0000e780: 534b 5950 494c 4f54 5f4e 554d 5f47 5055  SKYPILOT_NUM_GPU
+0000e790: 535f 5045 525f 4e4f 4445 202d 6571 2031  S_PER_NODE -eq 1
+0000e7a0: 205d 5d20 7c7c 2065 7869 7420 3122 272c   ]] || exit 1"',
+0000e7b0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000e7c0: 6b79 2065 7865 6320 7b6e 616d 657d 202d  ky exec {name} -
+0000e7d0: 2d67 7075 7320 5434 3a30 2e32 202d 2d6e  -gpus T4:0.2 --n
+0000e7e0: 756d 2d6e 6f64 6573 2032 2022 5b5b 205c  um-nodes 2 "[[ \
+0000e7f0: 2453 4b59 5049 4c4f 545f 4e55 4d5f 4750  $SKYPILOT_NUM_GP
+0000e800: 5553 5f50 4552 5f4e 4f44 4520 2d65 7120  US_PER_NODE -eq 
+0000e810: 3120 5d5d 207c 7c20 6578 6974 2031 2227  1 ]] || exit 1"'
+0000e820: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000e830: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+0000e840: 2d2d 6770 7573 2054 343a 3120 2d2d 6e75  --gpus T4:1 --nu
+0000e850: 6d2d 6e6f 6465 7320 3220 225b 5b20 5c24  m-nodes 2 "[[ \$
+0000e860: 534b 5950 494c 4f54 5f4e 554d 5f47 5055  SKYPILOT_NUM_GPU
+0000e870: 535f 5045 525f 4e4f 4445 202d 6571 2031  S_PER_NODE -eq 1
+0000e880: 205d 5d20 7c7c 2065 7869 7420 3122 272c   ]] || exit 1"',
+0000e890: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0000e8a0: 6b79 206c 6f67 7320 7b6e 616d 657d 2035  ky logs {name} 5
+0000e8b0: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+0000e8c0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+0000e8d0: 6773 207b 6e61 6d65 7d20 3620 2d2d 7374  gs {name} 6 --st
+0000e8e0: 6174 7573 272c 0a20 2020 2020 2020 2020  atus',.         
+0000e8f0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+0000e900: 616d 657d 2037 202d 2d73 7461 7475 7327  ame} 7 --status'
+0000e910: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+0000e920: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
+0000e930: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+0000e940: 2020 2020 7469 6d65 6f75 743d 746f 7461      timeout=tota
+0000e950: 6c5f 7469 6d65 6f75 745f 6d69 6e75 7465  l_timeout_minute
+0000e960: 7320 2a20 3630 2c0a 2020 2020 290a 2020  s * 60,.    ).  
+0000e970: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+0000e980: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+0000e990: 6172 6b2e 6e6f 5f6c 616d 6264 615f 636c  ark.no_lambda_cl
+0000e9a0: 6f75 6420 2023 204e 6f20 4c61 6d62 6461  oud  # No Lambda
+0000e9b0: 2043 6c6f 7564 2056 4d20 6861 7320 3820   Cloud VM has 8 
+0000e9c0: 4350 5573 0a64 6566 2074 6573 745f 6c61  CPUs.def test_la
+0000e9d0: 7267 655f 6a6f 625f 7175 6575 6528 6765  rge_job_queue(ge
+0000e9e0: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
+0000e9f0: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
+0000ea00: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+0000ea10: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
+0000ea20: 7428 0a20 2020 2020 2020 2027 6c61 7267  t(.        'larg
+0000ea30: 655f 6a6f 625f 7175 6575 6527 2c0a 2020  e_job_queue',.  
+0000ea40: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+0000ea50: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+0000ea60: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
+0000ea70: 6370 7573 2038 202d 2d63 6c6f 7564 207b  cpus 8 --cloud {
+0000ea80: 6765 6e65 7269 635f 636c 6f75 647d 272c  generic_cloud}',
+0000ea90: 0a20 2020 2020 2020 2020 2020 2066 2766  .            f'f
+0000eaa0: 6f72 2069 2069 6e20 6073 6571 2031 2037  or i in `seq 1 7
+0000eab0: 3560 3b20 646f 2073 6b79 2065 7865 6320  5`; do sky exec 
+0000eac0: 7b6e 616d 657d 202d 6e20 7b6e 616d 657d  {name} -n {name}
+0000ead0: 2d24 6920 2d64 2022 6563 686f 2024 693b  -$i -d "echo $i;
+0000eae0: 2073 6c65 6570 2031 3030 3030 3030 3030   sleep 100000000
+0000eaf0: 223b 2064 6f6e 6527 2c0a 2020 2020 2020  "; done',.      
+0000eb00: 2020 2020 2020 6627 736b 7920 6361 6e63        f'sky canc
+0000eb10: 656c 202d 7920 7b6e 616d 657d 2031 2032  el -y {name} 1 2
+0000eb20: 2033 2034 2035 2036 2037 2038 2039 2031   3 4 5 6 7 8 9 1
+0000eb30: 3020 3131 2031 3220 3133 2031 3420 3135  0 11 12 13 14 15
+0000eb40: 2031 3627 2c0a 2020 2020 2020 2020 2020   16',.          
+0000eb50: 2020 2773 6c65 6570 2039 3027 2c0a 2020    'sleep 90',.  
+0000eb60: 2020 2020 2020 2020 2020 2320 4561 6368            # Each
+0000eb70: 206a 6f62 2074 616b 6573 2030 2e35 2043   job takes 0.5 C
+0000eb80: 5055 2061 6e64 2074 6865 2064 6566 6175  PU and the defau
+0000eb90: 6c74 2056 4d20 6861 7320 3820 4350 5573  lt VM has 8 CPUs
+0000eba0: 2c20 736f 2074 6865 7265 2073 686f 756c  , so there shoul
+0000ebb0: 6420 6265 2038 202f 2030 2e35 203d 2031  d be 8 / 0.5 = 1
+0000ebc0: 3620 6a6f 6273 2072 756e 6e69 6e67 2e0a  6 jobs running..
+0000ebd0: 2020 2020 2020 2020 2020 2020 2320 5468              # Th
+0000ebe0: 6520 6669 7273 7420 3136 206a 6f62 7320  e first 16 jobs 
+0000ebf0: 6172 6520 6361 6e63 656c 6564 2c20 736f  are canceled, so
+0000ec00: 2074 6865 7265 2073 686f 756c 6420 6265   there should be
+0000ec10: 2037 3520 2d20 3332 203d 2034 3320 6a6f   75 - 32 = 43 jo
+0000ec20: 6273 2050 454e 4449 4e47 2e0a 2020 2020  bs PENDING..    
+0000ec30: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
+0000ec40: 7920 7175 6575 6520 7b6e 616d 657d 293b  y queue {name});
+0000ec50: 2065 6368 6f20 2224 7322 3b20 6563 686f   echo "$s"; echo
+0000ec60: 3b20 6563 686f 3b20 6563 686f 2022 2473  ; echo; echo "$s
+0000ec70: 2220 7c20 6772 6570 202d 7620 6772 6570  " | grep -v grep
+0000ec80: 207c 2067 7265 7020 5045 4e44 494e 4720   | grep PENDING 
+0000ec90: 7c20 7763 202d 6c20 7c20 6772 6570 2034  | wc -l | grep 4
+0000eca0: 3327 2c0a 2020 2020 2020 2020 2020 2020  3',.            
+0000ecb0: 2320 4d61 6b65 2073 7572 6520 7468 6520  # Make sure the 
+0000ecc0: 6a6f 6273 2061 7265 2073 6368 6564 756c  jobs are schedul
+0000ecd0: 6564 2069 6e20 4649 464f 206f 7264 6572  ed in FIFO order
+0000ece0: 0a20 2020 2020 2020 2020 2020 202a 5b0a  .            *[.
+0000ecf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ed00: 6627 733d 2428 736b 7920 7175 6575 6520  f's=$(sky queue 
+0000ed10: 7b6e 616d 657d 293b 2065 6368 6f20 2224  {name}); echo "$
+0000ed20: 7322 3b20 6563 686f 3b20 6563 686f 3b20  s"; echo; echo; 
+0000ed30: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
+0000ed40: 207b 6e61 6d65 7d2d 7b69 7d20 7c20 6772   {name}-{i} | gr
+0000ed50: 6570 2043 414e 4345 4c4c 4544 270a 2020  ep CANCELLED'.  
+0000ed60: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+0000ed70: 7220 6920 696e 2072 616e 6765 2831 2c20  r i in range(1, 
+0000ed80: 3137 290a 2020 2020 2020 2020 2020 2020  17).            
+0000ed90: 5d2c 0a20 2020 2020 2020 2020 2020 202a  ],.            *
+0000eda0: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+0000edb0: 2020 6627 733d 2428 736b 7920 7175 6575    f's=$(sky queu
+0000edc0: 6520 7b6e 616d 657d 293b 2065 6368 6f20  e {name}); echo 
+0000edd0: 2224 7322 3b20 6563 686f 3b20 6563 686f  "$s"; echo; echo
+0000ede0: 3b20 6563 686f 2022 2473 2220 7c20 6772  ; echo "$s" | gr
+0000edf0: 6570 207b 6e61 6d65 7d2d 7b69 7d20 7c20  ep {name}-{i} | 
+0000ee00: 6772 6570 2052 554e 4e49 4e47 270a 2020  grep RUNNING'.  
+0000ee10: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+0000ee20: 7220 6920 696e 2072 616e 6765 2831 372c  r i in range(17,
+0000ee30: 2033 3329 0a20 2020 2020 2020 2020 2020   33).           
+0000ee40: 205d 2c0a 2020 2020 2020 2020 2020 2020   ],.            
+0000ee50: 2a5b 0a20 2020 2020 2020 2020 2020 2020  *[.             
+0000ee60: 2020 2066 2773 3d24 2873 6b79 2071 7565     f's=$(sky que
+0000ee70: 7565 207b 6e61 6d65 7d29 3b20 6563 686f  ue {name}); echo
+0000ee80: 2022 2473 223b 2065 6368 6f3b 2065 6368   "$s"; echo; ech
+0000ee90: 6f3b 2065 6368 6f20 2224 7322 207c 2067  o; echo "$s" | g
+0000eea0: 7265 7020 7b6e 616d 657d 2d7b 697d 207c  rep {name}-{i} |
+0000eeb0: 2067 7265 7020 5045 4e44 494e 4727 0a20   grep PENDING'. 
+0000eec0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000eed0: 6f72 2069 2069 6e20 7261 6e67 6528 3333  or i in range(33
+0000eee0: 2c20 3735 290a 2020 2020 2020 2020 2020  , 75).          
+0000eef0: 2020 5d2c 0a20 2020 2020 2020 2020 2020    ],.           
+0000ef00: 2066 2773 6b79 2063 616e 6365 6c20 2d79   f'sky cancel -y
+0000ef10: 207b 6e61 6d65 7d20 3333 2033 3520 3337   {name} 33 35 37
+0000ef20: 2033 3920 3137 2031 3820 3139 272c 0a20   39 17 18 19',. 
+0000ef30: 2020 2020 2020 2020 2020 202a 5b0a 2020             *[.  
+0000ef40: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+0000ef50: 733d 2428 736b 7920 7175 6575 6520 7b6e  s=$(sky queue {n
+0000ef60: 616d 657d 293b 2065 6368 6f20 2224 7322  ame}); echo "$s"
+0000ef70: 3b20 6563 686f 3b20 6563 686f 3b20 6563  ; echo; echo; ec
+0000ef80: 686f 2022 2473 2220 7c20 6772 6570 207b  ho "$s" | grep {
+0000ef90: 6e61 6d65 7d2d 7b69 7d20 7c20 6772 6570  name}-{i} | grep
+0000efa0: 2043 414e 4345 4c4c 4544 270a 2020 2020   CANCELLED'.    
+0000efb0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0000efc0: 6920 696e 2072 616e 6765 2833 332c 2034  i in range(33, 4
+0000efd0: 302c 2032 290a 2020 2020 2020 2020 2020  0, 2).          
+0000efe0: 2020 5d2c 0a20 2020 2020 2020 2020 2020    ],.           
+0000eff0: 2027 736c 6565 7020 3130 272c 0a20 2020   'sleep 10',.   
+0000f000: 2020 2020 2020 2020 202a 5b0a 2020 2020           *[.    
+0000f010: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
+0000f020: 2428 736b 7920 7175 6575 6520 7b6e 616d  $(sky queue {nam
+0000f030: 657d 293b 2065 6368 6f20 2224 7322 3b20  e}); echo "$s"; 
+0000f040: 6563 686f 3b20 6563 686f 3b20 6563 686f  echo; echo; echo
+0000f050: 2022 2473 2220 7c20 6772 6570 207b 6e61   "$s" | grep {na
+0000f060: 6d65 7d2d 7b69 7d20 7c20 6772 6570 2052  me}-{i} | grep R
+0000f070: 554e 4e49 4e47 270a 2020 2020 2020 2020  UNNING'.        
+0000f080: 2020 2020 2020 2020 666f 7220 6920 696e          for i in
+0000f090: 205b 3334 2c20 3336 2c20 3338 5d0a 2020   [34, 36, 38].  
+0000f0a0: 2020 2020 2020 2020 2020 5d2c 0a20 2020            ],.   
+0000f0b0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+0000f0c0: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
+0000f0d0: 616d 657d 272c 0a20 2020 2020 2020 2074  ame}',.        t
+0000f0e0: 696d 656f 7574 3d32 3520 2a20 3630 2c0a  imeout=25 * 60,.
+0000f0f0: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+0000f100: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
+0000f110: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f6c  pytest.mark.no_l
+0000f120: 616d 6264 615f 636c 6f75 6420 2023 204e  ambda_cloud  # N
+0000f130: 6f20 4c61 6d62 6461 2043 6c6f 7564 2056  o Lambda Cloud V
+0000f140: 4d20 6861 7320 3820 4350 5573 0a64 6566  M has 8 CPUs.def
+0000f150: 2074 6573 745f 6661 7374 5f6c 6172 6765   test_fast_large
+0000f160: 5f6a 6f62 5f71 7565 7565 2867 656e 6572  _job_queue(gener
+0000f170: 6963 5f63 6c6f 7564 3a20 7374 7229 3a0a  ic_cloud: str):.
+0000f180: 2020 2020 2320 5468 6973 2069 7320 746f      # This is to
+0000f190: 2074 6573 7420 7468 6520 6a6f 6273 2063   test the jobs c
+0000f1a0: 616e 2062 6520 7363 6865 6475 6c65 6420  an be scheduled 
+0000f1b0: 7175 6963 6b6c 7920 7768 656e 2074 6865  quickly when the
+0000f1c0: 7265 2061 7265 206d 616e 7920 6a6f 6273  re are many jobs
+0000f1d0: 2069 6e20 7468 6520 7175 6575 652e 0a20   in the queue.. 
+0000f1e0: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+0000f1f0: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+0000f200: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+0000f210: 2020 2020 2020 2027 6661 7374 5f6c 6172         'fast_lar
+0000f220: 6765 5f6a 6f62 5f71 7565 7565 272c 0a20  ge_job_queue',. 
+0000f230: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+0000f240: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+0000f250: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
+0000f260: 2d63 7075 7320 3820 2d2d 636c 6f75 6420  -cpus 8 --cloud 
+0000f270: 7b67 656e 6572 6963 5f63 6c6f 7564 7d27  {generic_cloud}'
+0000f280: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000f290: 666f 7220 6920 696e 2060 7365 7120 3120  for i in `seq 1 
+0000f2a0: 3332 603b 2064 6f20 736b 7920 6578 6563  32`; do sky exec
+0000f2b0: 207b 6e61 6d65 7d20 2d6e 207b 6e61 6d65   {name} -n {name
+0000f2c0: 7d2d 2469 202d 6420 2265 6368 6f20 2469  }-$i -d "echo $i
+0000f2d0: 223b 2064 6f6e 6527 2c0a 2020 2020 2020  "; done',.      
+0000f2e0: 2020 2020 2020 2773 6c65 6570 2036 3027        'sleep 60'
+0000f2f0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000f300: 733d 2428 736b 7920 7175 6575 6520 7b6e  s=$(sky queue {n
+0000f310: 616d 657d 293b 2065 6368 6f20 2224 7322  ame}); echo "$s"
+0000f320: 3b20 6563 686f 3b20 6563 686f 3b20 6563  ; echo; echo; ec
+0000f330: 686f 2022 2473 2220 7c20 6772 6570 202d  ho "$s" | grep -
+0000f340: 7620 6772 6570 207c 2067 7265 7020 5355  v grep | grep SU
+0000f350: 4343 4545 4445 4420 7c20 7763 202d 6c20  CCEEDED | wc -l 
+0000f360: 7c20 6772 6570 2033 3227 2c0a 2020 2020  | grep 32',.    
+0000f370: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+0000f380: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+0000f390: 6d65 7d27 2c0a 2020 2020 2020 2020 7469  me}',.        ti
+0000f3a0: 6d65 6f75 743d 3230 202a 2036 302c 0a20  meout=20 * 60,. 
+0000f3b0: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+0000f3c0: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
+0000f3d0: 7974 6573 742e 6d61 726b 2e69 626d 0a64  ytest.mark.ibm.d
+0000f3e0: 6566 2074 6573 745f 6962 6d5f 6a6f 625f  ef test_ibm_job_
+0000f3f0: 7175 6575 655f 6d75 6c74 696e 6f64 6528  queue_multinode(
+0000f400: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
+0000f410: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+0000f420: 290a 2020 2020 7461 736b 5f66 696c 6520  ).    task_file 
+0000f430: 3d20 2765 7861 6d70 6c65 732f 6a6f 625f  = 'examples/job_
+0000f440: 7175 6575 652f 6a6f 625f 6d75 6c74 696e  queue/job_multin
+0000f450: 6f64 655f 6962 6d2e 7961 6d6c 270a 2020  ode_ibm.yaml'.  
+0000f460: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+0000f470: 2020 2020 2020 2027 6962 6d5f 6a6f 625f         'ibm_job_
+0000f480: 7175 6575 655f 6d75 6c74 696e 6f64 6527  queue_multinode'
+0000f490: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+0000f4a0: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+0000f4b0: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
+0000f4c0: 7d20 2d2d 636c 6f75 6420 6962 6d20 2d2d  } --cloud ibm --
+0000f4d0: 6770 7573 2076 3130 3020 2d2d 6e75 6d2d  gpus v100 --num-
+0000f4e0: 6e6f 6465 7320 3227 2c0a 2020 2020 2020  nodes 2',.      
+0000f4f0: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+0000f500: 207b 6e61 6d65 7d20 2d6e 207b 6e61 6d65   {name} -n {name
+0000f510: 7d2d 3120 2d64 207b 7461 736b 5f66 696c  }-1 -d {task_fil
+0000f520: 657d 272c 0a20 2020 2020 2020 2020 2020  e}',.           
+0000f530: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+0000f540: 657d 202d 6e20 7b6e 616d 657d 2d32 202d  e} -n {name}-2 -
+0000f550: 6420 7b74 6173 6b5f 6669 6c65 7d27 2c0a  d {task_file}',.
+0000f560: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0000f570: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+0000f580: 6e61 6d65 7d20 2d6e 207b 6e61 6d65 7d2d  name} -n {name}-
+0000f590: 3320 2d2d 6465 7461 6368 2d73 6574 7570  3 --detach-setup
+0000f5a0: 202d 6420 7b74 6173 6b5f 6669 6c65 7d27   -d {task_file}'
+0000f5b0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000f5c0: 733d 2428 736b 7920 7175 6575 6520 7b6e  s=$(sky queue {n
+0000f5d0: 616d 657d 2920 2626 2070 7269 6e74 6620  ame}) && printf 
+0000f5e0: 2224 7322 2026 2620 2865 6368 6f20 2224  "$s" && (echo "$
+0000f5f0: 7322 207c 2067 7265 7020 7b6e 616d 657d  s" | grep {name}
+0000f600: 2d31 207c 2067 7265 7020 5255 4e4e 494e  -1 | grep RUNNIN
+0000f610: 4729 272c 0a20 2020 2020 2020 2020 2020  G)',.           
+0000f620: 2066 2773 3d24 2873 6b79 2071 7565 7565   f's=$(sky queue
+0000f630: 207b 6e61 6d65 7d29 2026 2620 7072 696e   {name}) && prin
+0000f640: 7466 2022 2473 2220 2626 2028 6563 686f  tf "$s" && (echo
+0000f650: 2022 2473 2220 7c20 6772 6570 207b 6e61   "$s" | grep {na
+0000f660: 6d65 7d2d 3220 7c20 6772 6570 2052 554e  me}-2 | grep RUN
+0000f670: 4e49 4e47 2927 2c0a 2020 2020 2020 2020  NING)',.        
+0000f680: 2020 2020 6627 733d 2428 736b 7920 7175      f's=$(sky qu
+0000f690: 6575 6520 7b6e 616d 657d 2920 2626 2070  eue {name}) && p
+0000f6a0: 7269 6e74 6620 2224 7322 2026 2620 2865  rintf "$s" && (e
+0000f6b0: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
+0000f6c0: 7b6e 616d 657d 2d33 207c 2067 7265 7020  {name}-3 | grep 
+0000f6d0: 5345 5454 494e 475f 5550 2927 2c0a 2020  SETTING_UP)',.  
+0000f6e0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+0000f6f0: 2039 3027 2c0a 2020 2020 2020 2020 2020   90',.          
+0000f700: 2020 6627 733d 2428 736b 7920 7175 6575    f's=$(sky queu
+0000f710: 6520 7b6e 616d 657d 2920 2626 2070 7269  e {name}) && pri
+0000f720: 6e74 6620 2224 7322 2026 2620 2865 6368  ntf "$s" && (ech
+0000f730: 6f20 2224 7322 207c 2067 7265 7020 7b6e  o "$s" | grep {n
+0000f740: 616d 657d 2d33 207c 2067 7265 7020 5045  ame}-3 | grep PE
+0000f750: 4e44 494e 4729 272c 0a20 2020 2020 2020  NDING)',.       
+0000f760: 2020 2020 2066 2773 6b79 2063 616e 6365       f'sky cance
+0000f770: 6c20 2d79 207b 6e61 6d65 7d20 3127 2c0a  l -y {name} 1',.
+0000f780: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+0000f790: 6570 2035 272c 0a20 2020 2020 2020 2020  ep 5',.         
+0000f7a0: 2020 2066 2773 6b79 2071 7565 7565 207b     f'sky queue {
+0000f7b0: 6e61 6d65 7d20 7c20 6772 6570 207b 6e61  name} | grep {na
+0000f7c0: 6d65 7d2d 3320 7c20 6772 6570 2052 554e  me}-3 | grep RUN
+0000f7d0: 4e49 4e47 272c 0a20 2020 2020 2020 2020  NING',.         
+0000f7e0: 2020 2066 2773 6b79 2063 616e 6365 6c20     f'sky cancel 
+0000f7f0: 2d79 207b 6e61 6d65 7d20 3120 3220 3327  -y {name} 1 2 3'
+0000f800: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0000f810: 736b 7920 6c61 756e 6368 202d 6320 7b6e  sky launch -c {n
+0000f820: 616d 657d 202d 6e20 7b6e 616d 657d 2d34  ame} -n {name}-4
+0000f830: 202d 2d64 6574 6163 682d 7365 7475 7020   --detach-setup 
+0000f840: 2d64 207b 7461 736b 5f66 696c 657d 272c  -d {task_file}',
+0000f850: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
+0000f860: 6573 7420 7468 6520 6a6f 6220 7374 6174  est the job stat
+0000f870: 7573 2069 7320 636f 7272 6563 746c 7920  us is correctly 
+0000f880: 7365 7420 746f 2053 4554 5449 4e47 5f55  set to SETTING_U
+0000f890: 502c 2064 7572 696e 6720 7468 6520 7365  P, during the se
+0000f8a0: 7475 7020 6973 2072 756e 6e69 6e67 2c0a  tup is running,.
+0000f8b0: 2020 2020 2020 2020 2020 2020 2320 616e              # an
+0000f8c0: 6420 7468 6520 6a6f 6220 6361 6e20 6265  d the job can be
+0000f8d0: 2063 616e 6365 6c6c 6564 2064 7572 696e   cancelled durin
+0000f8e0: 6720 7468 6520 7365 7475 702e 0a20 2020  g the setup..   
+0000f8f0: 2020 2020 2020 2020 2066 2773 3d24 2873           f's=$(s
+0000f900: 6b79 2071 7565 7565 207b 6e61 6d65 7d29  ky queue {name})
+0000f910: 2026 2620 7072 696e 7466 2022 2473 2220   && printf "$s" 
+0000f920: 2626 2028 6563 686f 2022 2473 2220 7c20  && (echo "$s" | 
+0000f930: 6772 6570 207b 6e61 6d65 7d2d 3420 7c20  grep {name}-4 | 
+0000f940: 6772 6570 2053 4554 5449 4e47 5f55 5029  grep SETTING_UP)
+0000f950: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000f960: 2773 6b79 2063 616e 6365 6c20 2d79 207b  'sky cancel -y {
+0000f970: 6e61 6d65 7d20 3427 2c0a 2020 2020 2020  name} 4',.      
+0000f980: 2020 2020 2020 6627 733d 2428 736b 7920        f's=$(sky 
+0000f990: 7175 6575 6520 7b6e 616d 657d 2920 2626  queue {name}) &&
+0000f9a0: 2070 7269 6e74 6620 2224 7322 2026 2620   printf "$s" && 
+0000f9b0: 2865 6368 6f20 2224 7322 207c 2067 7265  (echo "$s" | gre
+0000f9c0: 7020 7b6e 616d 657d 2d34 207c 2067 7265  p {name}-4 | gre
+0000f9d0: 7020 4341 4e43 454c 4c45 4429 272c 0a20  p CANCELLED)',. 
+0000f9e0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0000f9f0: 2065 7865 6320 7b6e 616d 657d 202d 2d67   exec {name} --g
+0000fa00: 7075 7320 7631 3030 3a30 2e32 2022 5b5b  pus v100:0.2 "[[
+0000fa10: 205c 2453 4b59 5049 4c4f 545f 4e55 4d5f   \$SKYPILOT_NUM_
+0000fa20: 4750 5553 5f50 4552 5f4e 4f44 4520 2d65  GPUS_PER_NODE -e
+0000fa30: 7120 3120 5d5d 207c 7c20 6578 6974 2031  q 1 ]] || exit 1
+0000fa40: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+0000fa50: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+0000fa60: 7d20 2d2d 6770 7573 2076 3130 303a 302e  } --gpus v100:0.
+0000fa70: 3220 2d2d 6e75 6d2d 6e6f 6465 7320 3220  2 --num-nodes 2 
+0000fa80: 225b 5b20 5c24 534b 5950 494c 4f54 5f4e  "[[ \$SKYPILOT_N
+0000fa90: 554d 5f47 5055 535f 5045 525f 4e4f 4445  UM_GPUS_PER_NODE
+0000faa0: 202d 6571 2031 205d 5d20 7c7c 2065 7869   -eq 1 ]] || exi
+0000fab0: 7420 3122 272c 0a20 2020 2020 2020 2020  t 1"',.         
+0000fac0: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+0000fad0: 616d 657d 202d 2d67 7075 7320 7631 3030  ame} --gpus v100
+0000fae0: 3a31 202d 2d6e 756d 2d6e 6f64 6573 2032  :1 --num-nodes 2
+0000faf0: 2022 5b5b 205c 2453 4b59 5049 4c4f 545f   "[[ \$SKYPILOT_
+0000fb00: 4e55 4d5f 4750 5553 5f50 4552 5f4e 4f44  NUM_GPUS_PER_NOD
+0000fb10: 4520 2d65 7120 3120 5d5d 207c 7c20 6578  E -eq 1 ]] || ex
+0000fb20: 6974 2031 2227 2c0a 2020 2020 2020 2020  it 1"',.        
+0000fb30: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+0000fb40: 6e61 6d65 7d20 3520 2d2d 7374 6174 7573  name} 5 --status
+0000fb50: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0000fb60: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+0000fb70: 2036 202d 2d73 7461 7475 7327 2c0a 2020   6 --status',.  
+0000fb80: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000fb90: 6c6f 6773 207b 6e61 6d65 7d20 3720 2d2d  logs {name} 7 --
+0000fba0: 7374 6174 7573 272c 0a20 2020 2020 2020  status',.       
+0000fbb0: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
+0000fbc0: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+0000fbd0: 272c 0a20 2020 2020 2020 2074 696d 656f  ',.        timeo
+0000fbe0: 7574 3d32 3020 2a20 3630 2c20 2023 2032  ut=20 * 60,  # 2
+0000fbf0: 3020 6d69 6e73 0a20 2020 2029 0a20 2020  0 mins.    ).   
+0000fc00: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+0000fc10: 7374 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d  st)...# --------
+0000fc20: 2d2d 2044 6f63 6b65 7220 7769 7468 2070  -- Docker with p
+0000fc30: 7265 696e 7374 616c 6c65 6420 7061 636b  reinstalled pack
+0000fc40: 6167 652e 202d 2d2d 2d2d 2d2d 2d2d 2d0a  age. ----------.
+0000fc50: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+0000fc60: 666c 7569 6473 7461 636b 2020 2320 446f  fluidstack  # Do
+0000fc70: 6573 6e27 7420 7375 7070 6f72 7420 466c  esn't support Fl
+0000fc80: 7569 6473 7461 636b 2066 6f72 206e 6f77  uidstack for now
+0000fc90: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+0000fca0: 5f6c 616d 6264 615f 636c 6f75 6420 2023  _lambda_cloud  #
+0000fcb0: 2044 6f65 736e 2774 2073 7570 706f 7274   Doesn't support
+0000fcc0: 204c 616d 6264 6120 436c 6f75 6420 666f   Lambda Cloud fo
+0000fcd0: 7220 6e6f 770a 4070 7974 6573 742e 6d61  r now.@pytest.ma
+0000fce0: 726b 2e6e 6f5f 6962 6d20 2023 2044 6f65  rk.no_ibm  # Doe
+0000fcf0: 736e 2774 2073 7570 706f 7274 2049 424d  sn't support IBM
+0000fd00: 2043 6c6f 7564 2066 6f72 206e 6f77 0a40   Cloud for now.@
+0000fd10: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f73  pytest.mark.no_s
+0000fd20: 6370 2020 2320 446f 6573 6e27 7420 7375  cp  # Doesn't su
+0000fd30: 7070 6f72 7420 5343 5020 666f 7220 6e6f  pport SCP for no
+0000fd40: 770a 4070 7974 6573 742e 6d61 726b 2e6e  w.@pytest.mark.n
+0000fd50: 6f5f 6f63 6920 2023 2044 6f65 736e 2774  o_oci  # Doesn't
+0000fd60: 2073 7570 706f 7274 204f 4349 2066 6f72   support OCI for
+0000fd70: 206e 6f77 0a40 7079 7465 7374 2e6d 6172   now.@pytest.mar
+0000fd80: 6b2e 6e6f 5f6b 7562 6572 6e65 7465 7320  k.no_kubernetes 
+0000fd90: 2023 2044 6f65 736e 2774 2073 7570 706f   # Doesn't suppo
+0000fda0: 7274 204b 7562 6572 6e65 7465 7320 666f  rt Kubernetes fo
+0000fdb0: 7220 6e6f 770a 2320 544f 444f 287a 6877  r now.# TODO(zhw
+0000fdc0: 7529 3a20 7765 2073 686f 756c 6420 6669  u): we should fi
+0000fdd0: 7820 7468 6973 2066 6f72 206b 7562 6572  x this for kuber
+0000fde0: 6e65 7465 730a 6465 6620 7465 7374 5f64  netes.def test_d
+0000fdf0: 6f63 6b65 725f 7072 6569 6e73 7461 6c6c  ocker_preinstall
+0000fe00: 6564 5f70 6163 6b61 6765 2867 656e 6572  ed_package(gener
+0000fe10: 6963 5f63 6c6f 7564 3a20 7374 7229 3a0a  ic_cloud: str):.
+0000fe20: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+0000fe30: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+0000fe40: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+0000fe50: 2020 2020 2020 2020 2764 6f63 6b65 725f          'docker_
+0000fe60: 7769 7468 5f70 7265 696e 7374 616c 6c65  with_preinstalle
+0000fe70: 645f 7061 636b 6167 6527 2c0a 2020 2020  d_package',.    
+0000fe80: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+0000fe90: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
+0000fea0: 7920 2d63 207b 6e61 6d65 7d20 2d2d 636c  y -c {name} --cl
+0000feb0: 6f75 6420 7b67 656e 6572 6963 5f63 6c6f  oud {generic_clo
+0000fec0: 7564 7d20 2d2d 696d 6167 652d 6964 2064  ud} --image-id d
+0000fed0: 6f63 6b65 723a 6e67 696e 7827 2c0a 2020  ocker:nginx',.  
+0000fee0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+0000fef0: 6578 6563 207b 6e61 6d65 7d20 226e 6769  exec {name} "ngi
+0000ff00: 6e78 202d 5622 272c 0a20 2020 2020 2020  nx -V"',.       
+0000ff10: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+0000ff20: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
+0000ff30: 7327 2c0a 2020 2020 2020 2020 2020 2020  s',.            
+0000ff40: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+0000ff50: 7d20 7768 6f61 6d69 207c 2067 7265 7020  } whoami | grep 
+0000ff60: 726f 6f74 272c 0a20 2020 2020 2020 205d  root',.        ]
+0000ff70: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+0000ff80: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+0000ff90: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+0000ffa0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+0000ffb0: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2053 7562  # ---------- Sub
+0000ffc0: 6d69 7474 696e 6720 6d75 6c74 6970 6c65  mitting multiple
+0000ffd0: 2074 6173 6b73 2074 6f20 7468 6520 7361   tasks to the sa
+0000ffe0: 6d65 2063 6c75 7374 6572 2e20 2d2d 2d2d  me cluster. ----
+0000fff0: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
+00010000: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
+00010010: 6b20 2023 2046 6c75 6964 5374 6163 6b20  k  # FluidStack 
+00010020: 4443 2068 6173 206c 6f77 2061 7661 696c  DC has low avail
+00010030: 6162 696c 6974 7920 6f66 2054 3420 4750  ability of T4 GP
+00010040: 5573 0a40 7079 7465 7374 2e6d 6172 6b2e  Us.@pytest.mark.
+00010050: 6e6f 5f6c 616d 6264 615f 636c 6f75 6420  no_lambda_cloud 
+00010060: 2023 204c 616d 6264 6120 436c 6f75 6420   # Lambda Cloud 
+00010070: 646f 6573 206e 6f74 2068 6176 6520 5434  does not have T4
+00010080: 2067 7075 730a 4070 7974 6573 742e 6d61   gpus.@pytest.ma
+00010090: 726b 2e6e 6f5f 7061 7065 7273 7061 6365  rk.no_paperspace
+000100a0: 2020 2320 5061 7065 7273 7061 6365 2064    # Paperspace d
+000100b0: 6f65 7320 6e6f 7420 6861 7665 2054 3420  oes not have T4 
+000100c0: 6770 7573 0a40 7079 7465 7374 2e6d 6172  gpus.@pytest.mar
+000100d0: 6b2e 6e6f 5f69 626d 2020 2320 4942 4d20  k.no_ibm  # IBM 
+000100e0: 436c 6f75 6420 646f 6573 206e 6f74 2068  Cloud does not h
+000100f0: 6176 6520 5434 2067 7075 730a 4070 7974  ave T4 gpus.@pyt
+00010100: 6573 742e 6d61 726b 2e6e 6f5f 7363 7020  est.mark.no_scp 
+00010110: 2023 2053 4350 2064 6f65 7320 6e6f 7420   # SCP does not 
+00010120: 7375 7070 6f72 7420 6e75 6d5f 6e6f 6465  support num_node
+00010130: 7320 3e20 3120 7965 740a 4070 7974 6573  s > 1 yet.@pytes
+00010140: 742e 6d61 726b 2e6e 6f5f 6f63 6920 2023  t.mark.no_oci  #
+00010150: 204f 4349 2043 6c6f 7564 2064 6f65 7320   OCI Cloud does 
+00010160: 6e6f 7420 6861 7665 2054 3420 6770 7573  not have T4 gpus
+00010170: 0a64 6566 2074 6573 745f 6d75 6c74 695f  .def test_multi_
+00010180: 6563 686f 2867 656e 6572 6963 5f63 6c6f  echo(generic_clo
+00010190: 7564 3a20 7374 7229 3a0a 2020 2020 6e61  ud: str):.    na
+000101a0: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+000101b0: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
+000101c0: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+000101d0: 2020 276d 756c 7469 5f65 6368 6f27 2c0a    'multi_echo',.
+000101e0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+000101f0: 2020 2020 2020 6627 7079 7468 6f6e 2065        f'python e
+00010200: 7861 6d70 6c65 732f 6d75 6c74 695f 6563  xamples/multi_ec
+00010210: 686f 2e70 7920 7b6e 616d 657d 207b 6765  ho.py {name} {ge
+00010220: 6e65 7269 635f 636c 6f75 647d 272c 0a20  neric_cloud}',. 
+00010230: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+00010240: 7020 3132 3027 2c0a 2020 2020 2020 2020  p 120',.        
+00010250: 5d20 2b0a 2020 2020 2020 2020 2320 456e  ] +.        # En
+00010260: 7375 7265 206a 6f62 7320 7375 6363 6565  sure jobs succee
+00010270: 6465 642e 0a20 2020 2020 2020 205b 6627  ded..        [f'
+00010280: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+00010290: 7b69 202b 2031 7d20 2d2d 7374 6174 7573  {i + 1} --status
+000102a0: 2720 666f 7220 6920 696e 2072 616e 6765  ' for i in range
+000102b0: 2833 3229 5d20 2b0a 2020 2020 2020 2020  (32)] +.        
+000102c0: 2320 456e 7375 7265 206d 6f6e 6974 6f72  # Ensure monitor
+000102d0: 2f61 7574 6f73 6361 6c65 7220 6469 646e  /autoscaler didn
+000102e0: 2774 2063 7261 7368 206f 6e20 7468 6520  't crash on the 
+000102f0: 2761 7373 6572 7420 6e6f 740a 2020 2020  'assert not.    
+00010300: 2020 2020 2320 756e 6675 6c66 696c 6c65      # unfulfille
+00010310: 6427 2065 7272 6f72 2e20 2049 6620 7072  d' error.  If pr
+00010320: 6f63 6573 7320 6e6f 7420 666f 756e 642c  ocess not found,
+00010330: 2067 7265 702d 3e73 7368 2072 6574 7572   grep->ssh retur
+00010340: 6e73 2031 2e0a 2020 2020 2020 2020 5b66  ns 1..        [f
+00010350: 2773 7368 207b 6e61 6d65 7d20 5c27 7073  'ssh {name} \'ps
+00010360: 2061 7578 207c 2067 7265 7020 225b 2f5d   aux | grep "[/]
+00010370: 226d 6f6e 6974 6f72 2e70 795c 2727 5d2c  "monitor.py\''],
+00010380: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
+00010390: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
+000103a0: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
+000103b0: 3230 202a 2036 302c 0a20 2020 2029 0a20  20 * 60,.    ). 
+000103c0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+000103d0: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
+000103e0: 2d2d 2d2d 2054 6173 6b3a 2031 206e 6f64  ---- Task: 1 nod
+000103f0: 6520 7472 6169 6e69 6e67 2e20 2d2d 2d2d  e training. ----
+00010400: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
+00010410: 6172 6b2e 6e6f 5f6c 616d 6264 615f 636c  ark.no_lambda_cl
+00010420: 6f75 6420 2023 204c 616d 6264 6120 436c  oud  # Lambda Cl
+00010430: 6f75 6420 646f 6573 206e 6f74 2068 6176  oud does not hav
+00010440: 6520 5631 3030 2067 7075 730a 4070 7974  e V100 gpus.@pyt
+00010450: 6573 742e 6d61 726b 2e6e 6f5f 6962 6d20  est.mark.no_ibm 
+00010460: 2023 2049 424d 2063 6c6f 7564 2063 7572   # IBM cloud cur
+00010470: 7265 6e74 6c79 2064 6f65 736e 2774 2070  rently doesn't p
+00010480: 726f 7669 6465 2070 7562 6c69 6320 696d  rovide public im
+00010490: 6167 6520 7769 7468 2043 5544 410a 4070  age with CUDA.@p
+000104a0: 7974 6573 742e 6d61 726b 2e6e 6f5f 7363  ytest.mark.no_sc
+000104b0: 7020 2023 2053 4350 2064 6f65 7320 6e6f  p  # SCP does no
+000104c0: 7420 6861 7665 2056 3130 3020 2831 3647  t have V100 (16G
+000104d0: 4229 2047 5055 732e 2052 756e 2074 6573  B) GPUs. Run tes
+000104e0: 745f 7363 705f 6875 6767 696e 6766 6163  t_scp_huggingfac
+000104f0: 6520 696e 7374 6561 642e 0a64 6566 2074  e instead..def t
+00010500: 6573 745f 6875 6767 696e 6766 6163 6528  est_huggingface(
+00010510: 6765 6e65 7269 635f 636c 6f75 643a 2073  generic_cloud: s
+00010520: 7472 293a 0a20 2020 206e 616d 6520 3d20  tr):.    name = 
+00010530: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+00010540: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
+00010550: 6573 7428 0a20 2020 2020 2020 2027 6875  est(.        'hu
+00010560: 6767 696e 6766 6163 655f 676c 7565 5f69  ggingface_glue_i
+00010570: 6d64 625f 6170 7027 2c0a 2020 2020 2020  mdb_app',.      
+00010580: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+00010590: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
+000105a0: 2d63 207b 6e61 6d65 7d20 2d2d 636c 6f75  -c {name} --clou
+000105b0: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
+000105c0: 7d20 6578 616d 706c 6573 2f68 7567 6769  } examples/huggi
+000105d0: 6e67 6661 6365 5f67 6c75 655f 696d 6462  ngface_glue_imdb
+000105e0: 5f61 7070 2e79 616d 6c27 2c0a 2020 2020  _app.yaml',.    
+000105f0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+00010600: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
+00010610: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
+00010620: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
+00010630: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+00010640: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+00010650: 7d20 6578 616d 706c 6573 2f68 7567 6769  } examples/huggi
+00010660: 6e67 6661 6365 5f67 6c75 655f 696d 6462  ngface_glue_imdb
+00010670: 5f61 7070 2e79 616d 6c27 2c0a 2020 2020  _app.yaml',.    
+00010680: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+00010690: 6773 207b 6e61 6d65 7d20 3220 2d2d 7374  gs {name} 2 --st
+000106a0: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
+000106b0: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
+000106c0: 6564 2e0a 2020 2020 2020 2020 5d2c 0a20  ed..        ],. 
+000106d0: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
+000106e0: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
+000106f0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+00010700: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
+00010710: 7465 7374 2e6d 6172 6b2e 6c61 6d62 6461  test.mark.lambda
+00010720: 5f63 6c6f 7564 0a64 6566 2074 6573 745f  _cloud.def test_
+00010730: 6c61 6d62 6461 5f68 7567 6769 6e67 6661  lambda_huggingfa
+00010740: 6365 2867 656e 6572 6963 5f63 6c6f 7564  ce(generic_cloud
+00010750: 3a20 7374 7229 3a0a 2020 2020 6e61 6d65  : str):.    name
+00010760: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+00010770: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+00010780: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+00010790: 276c 616d 6264 615f 6875 6767 696e 6766  'lambda_huggingf
+000107a0: 6163 655f 676c 7565 5f69 6d64 625f 6170  ace_glue_imdb_ap
+000107b0: 7027 2c0a 2020 2020 2020 2020 5b0a 2020  p',.        [.  
+000107c0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000107d0: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
+000107e0: 6d65 7d20 7b4c 414d 4244 415f 5459 5045  me} {LAMBDA_TYPE
+000107f0: 7d20 6578 616d 706c 6573 2f68 7567 6769  } examples/huggi
+00010800: 6e67 6661 6365 5f67 6c75 655f 696d 6462  ngface_glue_imdb
+00010810: 5f61 7070 2e79 616d 6c27 2c0a 2020 2020  _app.yaml',.    
+00010820: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+00010830: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
+00010840: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
+00010850: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
+00010860: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+00010870: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+00010880: 7d20 7b4c 414d 4244 415f 5459 5045 7d20  } {LAMBDA_TYPE} 
+00010890: 6578 616d 706c 6573 2f68 7567 6769 6e67  examples/hugging
+000108a0: 6661 6365 5f67 6c75 655f 696d 6462 5f61  face_glue_imdb_a
+000108b0: 7070 2e79 616d 6c27 2c0a 2020 2020 2020  pp.yaml',.      
+000108c0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+000108d0: 207b 6e61 6d65 7d20 3220 2d2d 7374 6174   {name} 2 --stat
+000108e0: 7573 272c 2020 2320 456e 7375 7265 2074  us',  # Ensure t
+000108f0: 6865 206a 6f62 2073 7563 6365 6564 6564  he job succeeded
+00010900: 2e0a 2020 2020 2020 2020 5d2c 0a20 2020  ..        ],.   
+00010910: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
+00010920: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+00010930: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+00010940: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
+00010950: 7374 2e6d 6172 6b2e 7363 700a 6465 6620  st.mark.scp.def 
+00010960: 7465 7374 5f73 6370 5f68 7567 6769 6e67  test_scp_hugging
+00010970: 6661 6365 2867 656e 6572 6963 5f63 6c6f  face(generic_clo
+00010980: 7564 3a20 7374 7229 3a0a 2020 2020 6e61  ud: str):.    na
+00010990: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+000109a0: 725f 6e61 6d65 2829 0a20 2020 206e 756d  r_name().    num
+000109b0: 5f6f 665f 6770 755f 6c61 756e 6368 203d  _of_gpu_launch =
+000109c0: 2031 0a20 2020 2074 6573 7420 3d20 5465   1.    test = Te
+000109d0: 7374 280a 2020 2020 2020 2020 2753 4350  st(.        'SCP
+000109e0: 5f68 7567 6769 6e67 6661 6365 5f67 6c75  _huggingface_glu
+000109f0: 655f 696d 6462 5f61 7070 272c 0a20 2020  e_imdb_app',.   
+00010a00: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+00010a10: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+00010a20: 2d79 202d 6320 7b6e 616d 657d 207b 5343  -y -c {name} {SC
+00010a30: 505f 5459 5045 7d20 7b53 4350 5f47 5055  P_TYPE} {SCP_GPU
+00010a40: 5f56 3130 307d 3a7b 6e75 6d5f 6f66 5f67  _V100}:{num_of_g
+00010a50: 7075 5f6c 6175 6e63 687d 2065 7861 6d70  pu_launch} examp
+00010a60: 6c65 732f 6875 6767 696e 6766 6163 655f  les/huggingface_
+00010a70: 676c 7565 5f69 6d64 625f 6170 702e 7961  glue_imdb_app.ya
+00010a80: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
+00010a90: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+00010aa0: 657d 2031 202d 2d73 7461 7475 7327 2c20  e} 1 --status', 
+00010ab0: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
+00010ac0: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
+00010ad0: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+00010ae0: 7865 6320 7b6e 616d 657d 207b 5343 505f  xec {name} {SCP_
+00010af0: 5459 5045 7d20 7b53 4350 5f47 5055 5f56  TYPE} {SCP_GPU_V
+00010b00: 3130 307d 3a7b 6e75 6d5f 6f66 5f67 7075  100}:{num_of_gpu
+00010b10: 5f6c 6175 6e63 687d 2065 7861 6d70 6c65  _launch} example
+00010b20: 732f 6875 6767 696e 6766 6163 655f 676c  s/huggingface_gl
+00010b30: 7565 5f69 6d64 625f 6170 702e 7961 6d6c  ue_imdb_app.yaml
+00010b40: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00010b50: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+00010b60: 2032 202d 2d73 7461 7475 7327 2c20 2023   2 --status',  #
+00010b70: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
+00010b80: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
+00010b90: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
+00010ba0: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
+00010bb0: 657d 272c 0a20 2020 2029 0a20 2020 2072  e}',.    ).    r
+00010bc0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+00010bd0: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
+00010be0: 2049 6e66 6572 656e 7469 612e 202d 2d2d   Inferentia. ---
+00010bf0: 2d2d 2d2d 2d2d 2d0a 4070 7974 6573 742e  -------.@pytest.
+00010c00: 6d61 726b 2e61 7773 0a64 6566 2074 6573  mark.aws.def tes
+00010c10: 745f 696e 6665 7265 6e74 6961 2829 3a0a  t_inferentia():.
+00010c20: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+00010c30: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+00010c40: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+00010c50: 2020 2020 2020 2020 2774 6573 745f 696e          'test_in
+00010c60: 6665 7265 6e74 6961 272c 0a20 2020 2020  ferentia',.     
+00010c70: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00010c80: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+00010c90: 202d 6320 7b6e 616d 657d 202d 7420 696e   -c {name} -t in
+00010ca0: 6632 2e78 6c61 7267 6520 2d2d 2065 6368  f2.xlarge -- ech
+00010cb0: 6f20 6869 272c 0a20 2020 2020 2020 2020  o hi',.         
+00010cc0: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+00010cd0: 616d 657d 202d 2d67 7075 7320 496e 6665  ame} --gpus Infe
+00010ce0: 7265 6e74 6961 3a31 2065 6368 6f20 6869  rentia:1 echo hi
+00010cf0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00010d00: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
+00010d10: 2031 202d 2d73 7461 7475 7327 2c20 2023   1 --status',  #
+00010d20: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
+00010d30: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
+00010d40: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00010d50: 7320 7b6e 616d 657d 2032 202d 2d73 7461  s {name} 2 --sta
+00010d60: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
+00010d70: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
+00010d80: 642e 0a20 2020 2020 2020 205d 2c0a 2020  d..        ],.  
+00010d90: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+00010da0: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+00010db0: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+00010dc0: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
+00010dd0: 2d2d 2d2d 2d2d 2d2d 2054 5055 2e20 2d2d  -------- TPU. --
+00010de0: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
+00010df0: 2e6d 6172 6b2e 6763 700a 4070 7974 6573  .mark.gcp.@pytes
+00010e00: 742e 6d61 726b 2e74 7075 0a64 6566 2074  t.mark.tpu.def t
+00010e10: 6573 745f 7470 7528 293a 0a20 2020 206e  est_tpu():.    n
+00010e20: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
+00010e30: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
+00010e40: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00010e50: 2020 2027 7470 755f 6170 7027 2c0a 2020     'tpu_app',.  
+00010e60: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+00010e70: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+00010e80: 202d 7920 2d63 207b 6e61 6d65 7d20 6578   -y -c {name} ex
+00010e90: 616d 706c 6573 2f74 7075 2f74 7075 5f61  amples/tpu/tpu_a
+00010ea0: 7070 2e79 616d 6c27 2c0a 2020 2020 2020  pp.yaml',.      
+00010eb0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+00010ec0: 207b 6e61 6d65 7d20 3127 2c20 2023 2045   {name} 1',  # E
+00010ed0: 6e73 7572 6520 7468 6520 6a6f 6220 6669  nsure the job fi
+00010ee0: 6e69 7368 6564 2e0a 2020 2020 2020 2020  nished..        
+00010ef0: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+00010f00: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
 00010f10: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
-00010f20: 2072 6179 6c65 7420 7072 6f63 6573 7320   raylet process 
-00010f30: 6861 7320 7468 6520 636f 7272 6563 7420  has the correct 
-00010f40: 6669 6c65 2064 6573 6372 6970 746f 7220  file descriptor 
-00010f50: 6c69 6d69 742e 0a20 2020 2020 2020 2020  limit..         
-00010f60: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-00010f70: 616d 657d 2032 202d 2d73 7461 7475 7327  ame} 2 --status'
-00010f80: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
-00010f90: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
-00010fa0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00010fb0: 2073 746f 7020 2d79 207b 6e61 6d65 7d27   stop -y {name}'
-00010fc0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00010fd0: 736b 7920 7374 6172 7420 2d79 207b 6e61  sky start -y {na
-00010fe0: 6d65 7d20 2d69 2031 272c 0a20 2020 2020  me} -i 1',.     
-00010ff0: 2020 2020 2020 2066 2773 6b79 2065 7865         f'sky exe
-00011000: 6320 7b6e 616d 657d 2065 7861 6d70 6c65  c {name} example
-00011010: 732f 617a 7572 655f 7374 6172 745f 7374  s/azure_start_st
-00011020: 6f70 2e79 616d 6c27 2c0a 2020 2020 2020  op.yaml',.      
-00011030: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-00011040: 207b 6e61 6d65 7d20 3320 2d2d 7374 6174   {name} 3 --stat
-00011050: 7573 272c 2020 2320 456e 7375 7265 2074  us',  # Ensure t
-00011060: 6865 206a 6f62 2073 7563 6365 6564 6564  he job succeeded
-00011070: 2e0a 2020 2020 2020 2020 2020 2020 2773  ..            's
-00011080: 6c65 6570 2032 3030 272c 0a20 2020 2020  leep 200',.     
-00011090: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
-000110a0: 2073 7461 7475 7320 2d72 207b 6e61 6d65   status -r {name
-000110b0: 7d29 2026 2620 6563 686f 2024 7320 2626  }) && echo $s &&
-000110c0: 2065 6368 6f20 2473 207c 2067 7265 7020   echo $s | grep 
-000110d0: 2249 4e49 545c 7c53 544f 5050 4544 2227  "INIT\|STOPPED"'
-000110e0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-000110f0: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
-00011100: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
-00011110: 2020 2074 696d 656f 7574 3d33 3020 2a20     timeout=30 * 
-00011120: 3630 2c20 2023 2033 3020 6d69 6e73 0a20  60,  # 30 mins. 
-00011130: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-00011140: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
-00011150: 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573 7469  ---------- Testi
-00011160: 6e67 2041 7574 6f73 746f 7070 696e 6720  ng Autostopping 
-00011170: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
-00011180: 7374 2e6d 6172 6b2e 6e6f 5f66 6c75 6964  st.mark.no_fluid
-00011190: 7374 6163 6b20 2023 2046 6c75 6964 5374  stack  # FluidSt
-000111a0: 6163 6b20 646f 6573 206e 6f74 2073 7570  ack does not sup
-000111b0: 706f 7274 2073 746f 7070 696e 6720 696e  port stopping in
-000111c0: 2053 6b79 5069 6c6f 7420 696d 706c 656d   SkyPilot implem
-000111d0: 656e 7461 7469 6f6e 0a40 7079 7465 7374  entation.@pytest
-000111e0: 2e6d 6172 6b2e 6e6f 5f6c 616d 6264 615f  .mark.no_lambda_
-000111f0: 636c 6f75 6420 2023 204c 616d 6264 6120  cloud  # Lambda 
-00011200: 436c 6f75 6420 646f 6573 206e 6f74 2073  Cloud does not s
-00011210: 7570 706f 7274 2073 746f 7070 696e 6720  upport stopping 
-00011220: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
-00011230: 742e 6d61 726b 2e6e 6f5f 6962 6d20 2023  t.mark.no_ibm  #
-00011240: 2046 4958 2849 424d 2920 7370 6f72 6164   FIX(IBM) sporad
-00011250: 6963 616c 6c79 2066 6169 6c73 2c20 6173  ically fails, as
-00011260: 2072 6573 7461 7274 6564 2077 6f72 6b65   restarted worke
-00011270: 7273 2073 7461 7920 756e 696e 6974 6961  rs stay uninitia
-00011280: 6c69 7a65 6420 696e 6465 6669 6e69 7465  lized indefinite
-00011290: 6c79 0a40 7079 7465 7374 2e6d 6172 6b2e  ly.@pytest.mark.
-000112a0: 6e6f 5f73 6370 2020 2320 5343 5020 646f  no_scp  # SCP do
-000112b0: 6573 206e 6f74 2073 7570 706f 7274 206e  es not support n
-000112c0: 756d 5f6e 6f64 6573 203e 2031 2079 6574  um_nodes > 1 yet
-000112d0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-000112e0: 5f6b 7562 6572 6e65 7465 7320 2023 204b  _kubernetes  # K
-000112f0: 7562 6572 6e65 7465 7320 646f 6573 206e  ubernetes does n
-00011300: 6f74 2061 7574 6f73 746f 7020 7965 740a  ot autostop yet.
-00011310: 6465 6620 7465 7374 5f61 7574 6f73 746f  def test_autosto
-00011320: 7028 6765 6e65 7269 635f 636c 6f75 643a  p(generic_cloud:
-00011330: 2073 7472 293a 0a20 2020 206e 616d 6520   str):.    name 
-00011340: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-00011350: 616d 6528 290a 2020 2020 2320 417a 7572  ame().    # Azur
-00011360: 6520 7461 6b65 7320 7e20 376d 3135 7320  e takes ~ 7m15s 
-00011370: 2834 3335 7329 2074 6f20 6175 746f 7374  (435s) to autost
-00011380: 6f70 2061 2056 4d2c 2073 6f20 6865 7265  op a VM, so here
-00011390: 2077 6520 7573 6520 3630 3020 746f 2065   we use 600 to e
-000113a0: 6e73 7572 650a 2020 2020 2320 7468 6520  nsure.    # the 
-000113b0: 564d 2069 7320 7374 6f70 7065 642e 0a20  VM is stopped.. 
-000113c0: 2020 2061 7574 6f73 746f 705f 7469 6d65     autostop_time
-000113d0: 6f75 7420 3d20 3630 3020 6966 2067 656e  out = 600 if gen
-000113e0: 6572 6963 5f63 6c6f 7564 203d 3d20 2761  eric_cloud == 'a
-000113f0: 7a75 7265 2720 656c 7365 2032 3530 0a20  zure' else 250. 
-00011400: 2020 2023 204c 6175 6e63 6869 6e67 2061     # Launching a
-00011410: 6e64 2073 7461 7274 696e 6720 417a 7572  nd starting Azur
-00011420: 6520 636c 7573 7465 7273 2063 616e 2074  e clusters can t
-00011430: 616b 6520 6120 6c6f 6e67 2074 696d 6520  ake a long time 
-00011440: 746f 6f2e 2065 2e67 2e2c 2072 6573 7461  too. e.g., resta
-00011450: 7274 0a20 2020 2023 2061 2073 746f 7070  rt.    # a stopp
-00011460: 6564 2041 7a75 7265 2063 6c75 7374 6572  ed Azure cluster
-00011470: 2063 616e 2074 616b 6520 376d 2e20 536f   can take 7m. So
-00011480: 2077 6520 7365 7420 7468 6520 746f 7461   we set the tota
-00011490: 6c20 7469 6d65 6f75 7420 746f 2037 306d  l timeout to 70m
-000114a0: 2e0a 2020 2020 746f 7461 6c5f 7469 6d65  ..    total_time
-000114b0: 6f75 745f 6d69 6e75 7465 7320 3d20 3730  out_minutes = 70
-000114c0: 2069 6620 6765 6e65 7269 635f 636c 6f75   if generic_clou
-000114d0: 6420 3d3d 2027 617a 7572 6527 2065 6c73  d == 'azure' els
-000114e0: 6520 3230 0a20 2020 2074 6573 7420 3d20  e 20.    test = 
-000114f0: 5465 7374 280a 2020 2020 2020 2020 2761  Test(.        'a
-00011500: 7574 6f73 746f 7027 2c0a 2020 2020 2020  utostop',.      
-00011510: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-00011520: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-00011530: 2d64 202d 6320 7b6e 616d 657d 202d 2d6e  -d -c {name} --n
-00011540: 756d 2d6e 6f64 6573 2032 202d 2d63 6c6f  um-nodes 2 --clo
-00011550: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
-00011560: 647d 2074 6573 7473 2f74 6573 745f 7961  d} tests/test_ya
-00011570: 6d6c 732f 6d69 6e69 6d61 6c2e 7961 6d6c  mls/minimal.yaml
-00011580: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00011590: 2773 6b79 2061 7574 6f73 746f 7020 2d79  'sky autostop -y
-000115a0: 207b 6e61 6d65 7d20 2d69 2031 272c 0a0a   {name} -i 1',..
-000115b0: 2020 2020 2020 2020 2020 2020 2320 456e              # En
-000115c0: 7375 7265 2061 7574 6f73 746f 7020 6973  sure autostop is
-000115d0: 2073 6574 2e0a 2020 2020 2020 2020 2020   set..          
-000115e0: 2020 6627 736b 7920 7374 6174 7573 207c    f'sky status |
-000115f0: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
-00011600: 7265 7020 2231 6d22 272c 0a0a 2020 2020  rep "1m"',..    
-00011610: 2020 2020 2020 2020 2320 456e 7375 7265          # Ensure
-00011620: 2074 6865 2063 6c75 7374 6572 2069 7320   the cluster is 
-00011630: 6e6f 7420 7374 6f70 7065 6420 6561 726c  not stopped earl
-00011640: 792e 0a20 2020 2020 2020 2020 2020 2027  y..            '
-00011650: 736c 6565 7020 3230 272c 0a20 2020 2020  sleep 20',.     
-00011660: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
-00011670: 2073 7461 7475 7320 7b6e 616d 657d 202d   status {name} -
-00011680: 2d72 6566 7265 7368 293b 2065 6368 6f20  -refresh); echo 
-00011690: 2224 7322 3b20 6563 686f 3b20 6563 686f  "$s"; echo; echo
-000116a0: 3b20 6563 686f 2022 2473 2220 207c 2067  ; echo "$s"  | g
-000116b0: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
-000116c0: 7020 5550 272c 0a0a 2020 2020 2020 2020  p UP',..        
-000116d0: 2020 2020 2320 456e 7375 7265 2074 6865      # Ensure the
-000116e0: 2063 6c75 7374 6572 2069 7320 5354 4f50   cluster is STOP
-000116f0: 5045 442e 0a20 2020 2020 2020 2020 2020  PED..           
-00011700: 2066 2773 6c65 6570 207b 6175 746f 7374   f'sleep {autost
-00011710: 6f70 5f74 696d 656f 7574 7d27 2c0a 2020  op_timeout}',.  
-00011720: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
-00011730: 736b 7920 7374 6174 7573 207b 6e61 6d65  sky status {name
-00011740: 7d20 2d2d 7265 6672 6573 6829 3b20 6563  } --refresh); ec
-00011750: 686f 2022 2473 223b 2065 6368 6f3b 2065  ho "$s"; echo; e
-00011760: 6368 6f3b 2065 6368 6f20 2224 7322 2020  cho; echo "$s"  
-00011770: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
-00011780: 6772 6570 2053 544f 5050 4544 272c 0a0a  grep STOPPED',..
-00011790: 2020 2020 2020 2020 2020 2020 2320 456e              # En
-000117a0: 7375 7265 2074 6865 2063 6c75 7374 6572  sure the cluster
-000117b0: 2069 7320 5550 2061 6e64 2074 6865 2061   is UP and the a
-000117c0: 7574 6f73 746f 7020 7365 7474 696e 6720  utostop setting 
-000117d0: 6973 2072 6573 6574 2028 272d 2729 2e0a  is reset ('-')..
-000117e0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000117f0: 7920 7374 6172 7420 2d79 207b 6e61 6d65  y start -y {name
-00011800: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
-00011810: 6627 736b 7920 7374 6174 7573 207c 2067  f'sky status | g
-00011820: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
-00011830: 7020 2d45 2022 5550 5c73 2b2d 2227 2c0a  p -E "UP\s+-"',.
-00011840: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
-00011850: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
-00011860: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
-00011870: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
-00011880: 7b6e 616d 657d 2074 6573 7473 2f74 6573  {name} tests/tes
-00011890: 745f 7961 6d6c 732f 6d69 6e69 6d61 6c2e  t_yamls/minimal.
-000118a0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-000118b0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-000118c0: 616d 657d 2032 202d 2d73 7461 7475 7327  ame} 2 --status'
-000118d0: 2c0a 0a20 2020 2020 2020 2020 2020 2023  ,..            #
-000118e0: 2054 6573 7420 7265 7374 6172 7469 6e67   Test restarting
-000118f0: 2074 6865 2069 646c 656e 6573 7320 7469   the idleness ti
-00011900: 6d65 7220 7669 6120 6361 6e63 656c 202b  mer via cancel +
-00011910: 2072 6573 6574 3a0a 2020 2020 2020 2020   reset:.        
-00011920: 2020 2020 6627 736b 7920 6175 746f 7374      f'sky autost
-00011930: 6f70 202d 7920 7b6e 616d 657d 202d 6920  op -y {name} -i 
-00011940: 3127 2c20 2023 2049 646c 656e 6573 7320  1',  # Idleness 
-00011950: 7374 6172 7473 2063 6f75 6e74 696e 672e  starts counting.
-00011960: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-00011970: 6565 7020 3330 272c 2020 2320 416c 6d6f  eep 30',  # Almo
-00011980: 7374 2072 6561 6368 6564 2074 6865 2074  st reached the t
-00011990: 6872 6573 686f 6c64 2e0a 2020 2020 2020  hreshold..      
-000119a0: 2020 2020 2020 6627 736b 7920 6175 746f        f'sky auto
-000119b0: 7374 6f70 202d 7920 7b6e 616d 657d 202d  stop -y {name} -
-000119c0: 2d63 616e 6365 6c27 2c0a 2020 2020 2020  -cancel',.      
-000119d0: 2020 2020 2020 6627 736b 7920 6175 746f        f'sky auto
-000119e0: 7374 6f70 202d 7920 7b6e 616d 657d 202d  stop -y {name} -
-000119f0: 6920 3127 2c20 2023 2053 686f 756c 6420  i 1',  # Should 
-00011a00: 7265 7374 6172 7420 7468 6520 7469 6d65  restart the time
-00011a10: 722e 0a20 2020 2020 2020 2020 2020 2027  r..            '
-00011a20: 736c 6565 7020 3330 272c 0a20 2020 2020  sleep 30',.     
-00011a30: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
-00011a40: 2073 7461 7475 7320 7b6e 616d 657d 202d   status {name} -
-00011a50: 2d72 6566 7265 7368 293b 2065 6368 6f20  -refresh); echo 
-00011a60: 2224 7322 3b20 6563 686f 3b20 6563 686f  "$s"; echo; echo
-00011a70: 3b20 6563 686f 2022 2473 2220 7c20 6772  ; echo "$s" | gr
-00011a80: 6570 207b 6e61 6d65 7d20 7c20 6772 6570  ep {name} | grep
-00011a90: 2055 5027 2c0a 2020 2020 2020 2020 2020   UP',.          
-00011aa0: 2020 6627 736c 6565 7020 7b61 7574 6f73    f'sleep {autos
-00011ab0: 746f 705f 7469 6d65 6f75 747d 272c 0a20  top_timeout}',. 
-00011ac0: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
-00011ad0: 2873 6b79 2073 7461 7475 7320 7b6e 616d  (sky status {nam
-00011ae0: 657d 202d 2d72 6566 7265 7368 293b 2065  e} --refresh); e
-00011af0: 6368 6f20 2224 7322 3b20 6563 686f 3b20  cho "$s"; echo; 
-00011b00: 6563 686f 3b20 6563 686f 2022 2473 2220  echo; echo "$s" 
-00011b10: 207c 2067 7265 7020 7b6e 616d 657d 207c   | grep {name} |
-00011b20: 2067 7265 7020 5354 4f50 5045 4427 2c0a   grep STOPPED',.
-00011b30: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-00011b40: 6573 7420 7265 7374 6172 7469 6e67 2074  est restarting t
-00011b50: 6865 2069 646c 656e 6573 7320 7469 6d65  he idleness time
-00011b60: 7220 7669 6120 6578 6563 3a0a 2020 2020  r via exec:.    
-00011b70: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
-00011b80: 6172 7420 2d79 207b 6e61 6d65 7d27 2c0a  art -y {name}',.
-00011b90: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00011ba0: 7920 7374 6174 7573 207c 2067 7265 7020  y status | grep 
-00011bb0: 7b6e 616d 657d 207c 2067 7265 7020 2d45  {name} | grep -E
-00011bc0: 2022 5550 5c73 2b2d 2227 2c0a 2020 2020   "UP\s+-"',.    
-00011bd0: 2020 2020 2020 2020 6627 736b 7920 6175          f'sky au
-00011be0: 746f 7374 6f70 202d 7920 7b6e 616d 657d  tostop -y {name}
-00011bf0: 202d 6920 3127 2c20 2023 2049 646c 656e   -i 1',  # Idlen
-00011c00: 6573 7320 7374 6172 7473 2063 6f75 6e74  ess starts count
-00011c10: 696e 672e 0a20 2020 2020 2020 2020 2020  ing..           
-00011c20: 2027 736c 6565 7020 3435 272c 2020 2320   'sleep 45',  # 
-00011c30: 416c 6d6f 7374 2072 6561 6368 6564 2074  Almost reached t
-00011c40: 6865 2074 6872 6573 686f 6c64 2e0a 2020  he threshold..  
-00011c50: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00011c60: 6578 6563 207b 6e61 6d65 7d20 6563 686f  exec {name} echo
-00011c70: 2068 6927 2c20 2023 2053 686f 756c 6420   hi',  # Should 
-00011c80: 7265 7374 6172 7420 7468 6520 7469 6d65  restart the time
-00011c90: 722e 0a20 2020 2020 2020 2020 2020 2027  r..            '
-00011ca0: 736c 6565 7020 3435 272c 0a20 2020 2020  sleep 45',.     
-00011cb0: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
-00011cc0: 2073 7461 7475 7320 7b6e 616d 657d 202d   status {name} -
-00011cd0: 2d72 6566 7265 7368 293b 2065 6368 6f20  -refresh); echo 
-00011ce0: 2224 7322 3b20 6563 686f 3b20 6563 686f  "$s"; echo; echo
-00011cf0: 3b20 6563 686f 2022 2473 2220 207c 2067  ; echo "$s"  | g
-00011d00: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
-00011d10: 7020 5550 272c 0a20 2020 2020 2020 2020  p UP',.         
-00011d20: 2020 2066 2773 6c65 6570 207b 6175 746f     f'sleep {auto
-00011d30: 7374 6f70 5f74 696d 656f 7574 7d27 2c0a  stop_timeout}',.
-00011d40: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
-00011d50: 2428 736b 7920 7374 6174 7573 207b 6e61  $(sky status {na
-00011d60: 6d65 7d20 2d2d 7265 6672 6573 6829 3b20  me} --refresh); 
-00011d70: 6563 686f 2022 2473 223b 2065 6368 6f3b  echo "$s"; echo;
-00011d80: 2065 6368 6f3b 2065 6368 6f20 2224 7322   echo; echo "$s"
-00011d90: 2020 7c20 6772 6570 207b 6e61 6d65 7d20    | grep {name} 
-00011da0: 7c20 6772 6570 2053 544f 5050 4544 272c  | grep STOPPED',
-00011db0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-00011dc0: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
-00011dd0: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
-00011de0: 2020 2074 696d 656f 7574 3d74 6f74 616c     timeout=total
-00011df0: 5f74 696d 656f 7574 5f6d 696e 7574 6573  _timeout_minutes
-00011e00: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
-00011e10: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00011e20: 7374 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d  st)...# --------
-00011e30: 2d2d 2054 6573 7469 6e67 2041 7574 6f64  -- Testing Autod
-00011e40: 6f77 6e69 6e67 202d 2d2d 2d2d 2d2d 2d2d  owning ---------
-00011e50: 2d0a 4070 7974 6573 742e 6d61 726b 2e6e  -.@pytest.mark.n
-00011e60: 6f5f 666c 7569 6473 7461 636b 2020 2320  o_fluidstack  # 
-00011e70: 466c 7569 6453 7461 636b 2064 6f65 7320  FluidStack does 
-00011e80: 6e6f 7420 7375 7070 6f72 7420 7374 6f70  not support stop
-00011e90: 7069 6e67 2069 6e20 536b 7950 696c 6f74  ping in SkyPilot
-00011ea0: 2069 6d70 6c65 6d65 6e74 6174 696f 6e0a   implementation.
-00011eb0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-00011ec0: 7363 7020 2023 2053 4350 2064 6f65 7320  scp  # SCP does 
-00011ed0: 6e6f 7420 7375 7070 6f72 7420 6e75 6d5f  not support num_
-00011ee0: 6e6f 6465 7320 3e20 3120 7965 742e 2052  nodes > 1 yet. R
-00011ef0: 756e 2074 6573 745f 7363 705f 6175 746f  un test_scp_auto
-00011f00: 646f 776e 2069 6e73 7465 6164 2e0a 6465  down instead..de
-00011f10: 6620 7465 7374 5f61 7574 6f64 6f77 6e28  f test_autodown(
-00011f20: 6765 6e65 7269 635f 636c 6f75 643a 2073  generic_cloud: s
-00011f30: 7472 293a 0a20 2020 206e 616d 6520 3d20  tr):.    name = 
-00011f40: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-00011f50: 6528 290a 2020 2020 2320 417a 7572 6520  e().    # Azure 
-00011f60: 7461 6b65 7320 7e20 3133 6d33 3073 2028  takes ~ 13m30s (
-00011f70: 3831 3073 2920 746f 2061 7574 6f64 6f77  810s) to autodow
-00011f80: 6e20 6120 564d 2c20 736f 2068 6572 6520  n a VM, so here 
-00011f90: 7765 2075 7365 2039 3030 2074 6f20 656e  we use 900 to en
-00011fa0: 7375 7265 0a20 2020 2023 2074 6865 2056  sure.    # the V
-00011fb0: 4d20 6973 2074 6572 6d69 6e61 7465 642e  M is terminated.
-00011fc0: 0a20 2020 2061 7574 6f64 6f77 6e5f 7469  .    autodown_ti
-00011fd0: 6d65 6f75 7420 3d20 3930 3020 6966 2067  meout = 900 if g
-00011fe0: 656e 6572 6963 5f63 6c6f 7564 203d 3d20  eneric_cloud == 
-00011ff0: 2761 7a75 7265 2720 656c 7365 2032 3430  'azure' else 240
-00012000: 0a20 2020 2074 6f74 616c 5f74 696d 656f  .    total_timeo
-00012010: 7574 5f6d 696e 7574 6573 203d 2039 3020  ut_minutes = 90 
-00012020: 6966 2067 656e 6572 6963 5f63 6c6f 7564  if generic_cloud
-00012030: 203d 3d20 2761 7a75 7265 2720 656c 7365   == 'azure' else
-00012040: 2032 300a 2020 2020 7465 7374 203d 2054   20.    test = T
-00012050: 6573 7428 0a20 2020 2020 2020 2027 6175  est(.        'au
-00012060: 746f 646f 776e 272c 0a20 2020 2020 2020  todown',.       
-00012070: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-00012080: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-00012090: 6420 2d63 207b 6e61 6d65 7d20 2d2d 6e75  d -c {name} --nu
-000120a0: 6d2d 6e6f 6465 7320 3220 2d2d 636c 6f75  m-nodes 2 --clou
-000120b0: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
-000120c0: 7d20 7465 7374 732f 7465 7374 5f79 616d  } tests/test_yam
-000120d0: 6c73 2f6d 696e 696d 616c 2e79 616d 6c27  ls/minimal.yaml'
-000120e0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-000120f0: 736b 7920 6175 746f 7374 6f70 202d 7920  sky autostop -y 
-00012100: 7b6e 616d 657d 202d 2d64 6f77 6e20 2d69  {name} --down -i
-00012110: 2031 272c 0a20 2020 2020 2020 2020 2020   1',.           
-00012120: 2023 2045 6e73 7572 6520 6175 746f 7374   # Ensure autost
-00012130: 6f70 2069 7320 7365 742e 0a20 2020 2020  op is set..     
-00012140: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
-00012150: 7475 7320 7c20 6772 6570 207b 6e61 6d65  tus | grep {name
-00012160: 7d20 7c20 6772 6570 2022 316d 2028 646f  } | grep "1m (do
-00012170: 776e 2922 272c 0a20 2020 2020 2020 2020  wn)"',.         
-00012180: 2020 2023 2045 6e73 7572 6520 7468 6520     # Ensure the 
-00012190: 636c 7573 7465 7220 6973 206e 6f74 2074  cluster is not t
-000121a0: 6572 6d69 6e61 7465 6420 6561 726c 792e  erminated early.
-000121b0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-000121c0: 6565 7020 3330 272c 0a20 2020 2020 2020  eep 30',.       
-000121d0: 2020 2020 2066 2773 3d24 2873 6b79 2073       f's=$(sky s
-000121e0: 7461 7475 7320 7b6e 616d 657d 202d 2d72  tatus {name} --r
-000121f0: 6566 7265 7368 293b 2065 6368 6f20 2224  efresh); echo "$
-00012200: 7322 3b20 6563 686f 3b20 6563 686f 3b20  s"; echo; echo; 
-00012210: 6563 686f 2022 2473 2220 207c 2067 7265  echo "$s"  | gre
-00012220: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
-00012230: 5550 272c 0a20 2020 2020 2020 2020 2020  UP',.           
-00012240: 2023 2045 6e73 7572 6520 7468 6520 636c   # Ensure the cl
-00012250: 7573 7465 7220 6973 2074 6572 6d69 6e61  uster is termina
-00012260: 7465 642e 0a20 2020 2020 2020 2020 2020  ted..           
-00012270: 2066 2773 6c65 6570 207b 6175 746f 646f   f'sleep {autodo
-00012280: 776e 5f74 696d 656f 7574 7d27 2c0a 2020  wn_timeout}',.  
-00012290: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
-000122a0: 534b 5950 494c 4f54 5f44 4542 5547 3d30  SKYPILOT_DEBUG=0
-000122b0: 2073 6b79 2073 7461 7475 7320 7b6e 616d   sky status {nam
-000122c0: 657d 202d 2d72 6566 7265 7368 2920 2626  e} --refresh) &&
-000122d0: 2065 6368 6f20 2224 7322 2026 2620 7b7b   echo "$s" && {{
-000122e0: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
-000122f0: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
-00012300: 2241 7574 6f64 6f77 6e65 6420 636c 7573  "Autodowned clus
-00012310: 7465 725c 7c74 6572 6d69 6e61 7465 6420  ter\|terminated 
-00012320: 6f6e 2074 6865 2063 6c6f 7564 223b 207d  on the cloud"; }
-00012330: 7d20 7c7c 207b 7b20 6563 686f 2022 2473  } || {{ echo "$s
-00012340: 2220 7c20 6772 6570 207b 6e61 6d65 7d20  " | grep {name} 
-00012350: 2626 2065 7869 7420 3120 7c7c 2065 7869  && exit 1 || exi
-00012360: 7420 303b 207d 7d27 2c0a 2020 2020 2020  t 0; }}',.      
-00012370: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-00012380: 6368 202d 7920 2d64 202d 6320 7b6e 616d  ch -y -d -c {nam
-00012390: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
-000123a0: 7269 635f 636c 6f75 647d 202d 2d6e 756d  ric_cloud} --num
-000123b0: 2d6e 6f64 6573 2032 202d 2d64 6f77 6e20  -nodes 2 --down 
-000123c0: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
-000123d0: 2f6d 696e 696d 616c 2e79 616d 6c27 2c0a  /minimal.yaml',.
-000123e0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-000123f0: 7920 7374 6174 7573 207c 2067 7265 7020  y status | grep 
-00012400: 7b6e 616d 657d 207c 2067 7265 7020 5550  {name} | grep UP
-00012410: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
-00012420: 2063 6c75 7374 6572 2069 7320 5550 2e0a   cluster is UP..
-00012430: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00012440: 7920 6578 6563 207b 6e61 6d65 7d20 2d2d  y exec {name} --
-00012450: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
-00012460: 6c6f 7564 7d20 7465 7374 732f 7465 7374  loud} tests/test
-00012470: 5f79 616d 6c73 2f6d 696e 696d 616c 2e79  _yamls/minimal.y
-00012480: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-00012490: 2020 6627 736b 7920 7374 6174 7573 207c    f'sky status |
-000124a0: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
-000124b0: 7265 7020 2231 6d20 2864 6f77 6e29 2227  rep "1m (down)"'
-000124c0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-000124d0: 736c 6565 7020 7b61 7574 6f64 6f77 6e5f  sleep {autodown_
-000124e0: 7469 6d65 6f75 747d 272c 0a20 2020 2020  timeout}',.     
-000124f0: 2020 2020 2020 2023 2045 6e73 7572 6520         # Ensure 
-00012500: 7468 6520 636c 7573 7465 7220 6973 2074  the cluster is t
-00012510: 6572 6d69 6e61 7465 642e 0a20 2020 2020  erminated..     
-00012520: 2020 2020 2020 2066 2773 3d24 2853 4b59         f's=$(SKY
-00012530: 5049 4c4f 545f 4445 4255 473d 3020 736b  PILOT_DEBUG=0 sk
-00012540: 7920 7374 6174 7573 207b 6e61 6d65 7d20  y status {name} 
-00012550: 2d2d 7265 6672 6573 6829 2026 2620 6563  --refresh) && ec
-00012560: 686f 2022 2473 2220 2626 207b 7b20 6563  ho "$s" && {{ ec
-00012570: 686f 2022 2473 2220 7c20 6772 6570 207b  ho "$s" | grep {
-00012580: 6e61 6d65 7d20 7c20 6772 6570 2022 4175  name} | grep "Au
-00012590: 746f 646f 776e 6564 2063 6c75 7374 6572  todowned cluster
-000125a0: 5c7c 7465 726d 696e 6174 6564 206f 6e20  \|terminated on 
-000125b0: 7468 6520 636c 6f75 6422 3b20 7d7d 207c  the cloud"; }} |
-000125c0: 7c20 7b7b 2065 6368 6f20 2224 7322 207c  | {{ echo "$s" |
-000125d0: 2067 7265 7020 7b6e 616d 657d 2026 2620   grep {name} && 
-000125e0: 6578 6974 2031 207c 7c20 6578 6974 2030  exit 1 || exit 0
-000125f0: 3b20 7d7d 272c 0a20 2020 2020 2020 2020  ; }}',.         
-00012600: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-00012610: 2d79 202d 6420 2d63 207b 6e61 6d65 7d20  -y -d -c {name} 
-00012620: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
-00012630: 5f63 6c6f 7564 7d20 2d2d 6e75 6d2d 6e6f  _cloud} --num-no
-00012640: 6465 7320 3220 2d2d 646f 776e 2074 6573  des 2 --down tes
-00012650: 7473 2f74 6573 745f 7961 6d6c 732f 6d69  ts/test_yamls/mi
-00012660: 6e69 6d61 6c2e 7961 6d6c 272c 0a20 2020  nimal.yaml',.   
-00012670: 2020 2020 2020 2020 2066 2773 6b79 2061           f'sky a
-00012680: 7574 6f73 746f 7020 2d79 207b 6e61 6d65  utostop -y {name
-00012690: 7d20 2d2d 6361 6e63 656c 272c 0a20 2020  } --cancel',.   
-000126a0: 2020 2020 2020 2020 2066 2773 6c65 6570           f'sleep
-000126b0: 207b 6175 746f 646f 776e 5f74 696d 656f   {autodown_timeo
-000126c0: 7574 7d27 2c0a 2020 2020 2020 2020 2020  ut}',.          
-000126d0: 2020 2320 456e 7375 7265 2074 6865 2063    # Ensure the c
-000126e0: 6c75 7374 6572 2069 7320 7374 696c 6c20  luster is still 
-000126f0: 5550 2e0a 2020 2020 2020 2020 2020 2020  UP..            
-00012700: 6627 733d 2428 534b 5950 494c 4f54 5f44  f's=$(SKYPILOT_D
-00012710: 4542 5547 3d30 2073 6b79 2073 7461 7475  EBUG=0 sky statu
-00012720: 7320 7b6e 616d 657d 202d 2d72 6566 7265  s {name} --refre
-00012730: 7368 2920 2626 2065 6368 6f20 2224 7322  sh) && echo "$s"
-00012740: 2026 2620 6563 686f 2022 2473 2220 7c20   && echo "$s" | 
-00012750: 6772 6570 207b 6e61 6d65 7d20 7c20 6772  grep {name} | gr
-00012760: 6570 2055 5027 2c0a 2020 2020 2020 2020  ep UP',.        
-00012770: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
-00012780: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-00012790: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
-000127a0: 743d 746f 7461 6c5f 7469 6d65 6f75 745f  t=total_timeout_
-000127b0: 6d69 6e75 7465 7320 2a20 3630 2c0a 2020  minutes * 60,.  
-000127c0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-000127d0: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
-000127e0: 7465 7374 2e6d 6172 6b2e 7363 700a 6465  test.mark.scp.de
-000127f0: 6620 7465 7374 5f73 6370 5f61 7574 6f64  f test_scp_autod
-00012800: 6f77 6e28 293a 0a20 2020 206e 616d 6520  own():.    name 
-00012810: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-00012820: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
-00012830: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-00012840: 5343 505f 6175 746f 646f 776e 272c 0a20  SCP_autodown',. 
-00012850: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-00012860: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-00012870: 6820 2d79 202d 6420 2d63 207b 6e61 6d65  h -y -d -c {name
-00012880: 7d20 7b53 4350 5f54 5950 457d 2074 6573  } {SCP_TYPE} tes
-00012890: 7473 2f74 6573 745f 7961 6d6c 732f 6d69  ts/test_yamls/mi
-000128a0: 6e69 6d61 6c2e 7961 6d6c 272c 0a20 2020  nimal.yaml',.   
-000128b0: 2020 2020 2020 2020 2066 2773 6b79 2061           f'sky a
-000128c0: 7574 6f73 746f 7020 2d79 207b 6e61 6d65  utostop -y {name
-000128d0: 7d20 2d2d 646f 776e 202d 6920 3127 2c0a  } --down -i 1',.
-000128e0: 2020 2020 2020 2020 2020 2020 2320 456e              # En
-000128f0: 7375 7265 2061 7574 6f73 746f 7020 6973  sure autostop is
-00012900: 2073 6574 2e0a 2020 2020 2020 2020 2020   set..          
-00012910: 2020 6627 736b 7920 7374 6174 7573 207c    f'sky status |
-00012920: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
-00012930: 7265 7020 2231 6d20 2864 6f77 6e29 2227  rep "1m (down)"'
-00012940: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00012950: 456e 7375 7265 2074 6865 2063 6c75 7374  Ensure the clust
-00012960: 6572 2069 7320 6e6f 7420 7465 726d 696e  er is not termin
-00012970: 6174 6564 2065 6172 6c79 2e0a 2020 2020  ated early..    
-00012980: 2020 2020 2020 2020 2773 6c65 6570 2034          'sleep 4
-00012990: 3527 2c0a 2020 2020 2020 2020 2020 2020  5',.            
-000129a0: 6627 736b 7920 7374 6174 7573 202d 2d72  f'sky status --r
-000129b0: 6566 7265 7368 207c 2067 7265 7020 7b6e  efresh | grep {n
-000129c0: 616d 657d 207c 2067 7265 7020 5550 272c  ame} | grep UP',
-000129d0: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
-000129e0: 6e73 7572 6520 7468 6520 636c 7573 7465  nsure the cluste
-000129f0: 7220 6973 2074 6572 6d69 6e61 7465 642e  r is terminated.
-00012a00: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-00012a10: 6565 7020 3230 3027 2c0a 2020 2020 2020  eep 200',.      
-00012a20: 2020 2020 2020 6627 733d 2428 534b 5950        f's=$(SKYP
-00012a30: 494c 4f54 5f44 4542 5547 3d30 2073 6b79  ILOT_DEBUG=0 sky
-00012a40: 2073 7461 7475 7320 2d2d 7265 6672 6573   status --refres
-00012a50: 6829 2026 2620 7072 696e 7466 2022 2473  h) && printf "$s
-00012a60: 2220 2626 207b 7b20 6563 686f 2022 2473  " && {{ echo "$s
-00012a70: 2220 7c20 6772 6570 207b 6e61 6d65 7d20  " | grep {name} 
-00012a80: 7c20 6772 6570 2022 4175 746f 646f 776e  | grep "Autodown
-00012a90: 6564 2063 6c75 7374 6572 5c7c 7465 726d  ed cluster\|term
-00012aa0: 696e 6174 6564 206f 6e20 7468 6520 636c  inated on the cl
-00012ab0: 6f75 6422 3b20 7d7d 207c 7c20 7b7b 2065  oud"; }} || {{ e
-00012ac0: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
-00012ad0: 7b6e 616d 657d 2026 2620 6578 6974 2031  {name} && exit 1
-00012ae0: 207c 7c20 6578 6974 2030 3b20 7d7d 272c   || exit 0; }}',
-00012af0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00012b00: 6b79 206c 6175 6e63 6820 2d79 202d 6420  ky launch -y -d 
-00012b10: 2d63 207b 6e61 6d65 7d20 7b53 4350 5f54  -c {name} {SCP_T
-00012b20: 5950 457d 202d 2d64 6f77 6e20 7465 7374  YPE} --down test
-00012b30: 732f 7465 7374 5f79 616d 6c73 2f6d 696e  s/test_yamls/min
-00012b40: 696d 616c 2e79 616d 6c27 2c0a 2020 2020  imal.yaml',.    
-00012b50: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
-00012b60: 6174 7573 207c 2067 7265 7020 7b6e 616d  atus | grep {nam
-00012b70: 657d 207c 2067 7265 7020 5550 272c 2020  e} | grep UP',  
-00012b80: 2320 456e 7375 7265 2074 6865 2063 6c75  # Ensure the clu
-00012b90: 7374 6572 2069 7320 5550 2e0a 2020 2020  ster is UP..    
-00012ba0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
-00012bb0: 6563 207b 6e61 6d65 7d20 7b53 4350 5f54  ec {name} {SCP_T
-00012bc0: 5950 457d 2074 6573 7473 2f74 6573 745f  YPE} tests/test_
-00012bd0: 7961 6d6c 732f 6d69 6e69 6d61 6c2e 7961  yamls/minimal.ya
-00012be0: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-00012bf0: 2066 2773 6b79 2073 7461 7475 7320 7c20   f'sky status | 
-00012c00: 6772 6570 207b 6e61 6d65 7d20 7c20 6772  grep {name} | gr
-00012c10: 6570 2022 316d 2028 646f 776e 2922 272c  ep "1m (down)"',
-00012c20: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-00012c30: 6565 7020 3230 3027 2c0a 2020 2020 2020  eep 200',.      
-00012c40: 2020 2020 2020 2320 456e 7375 7265 2074        # Ensure t
-00012c50: 6865 2063 6c75 7374 6572 2069 7320 7465  he cluster is te
-00012c60: 726d 696e 6174 6564 2e0a 2020 2020 2020  rminated..      
-00012c70: 2020 2020 2020 6627 733d 2428 534b 5950        f's=$(SKYP
-00012c80: 494c 4f54 5f44 4542 5547 3d30 2073 6b79  ILOT_DEBUG=0 sky
-00012c90: 2073 7461 7475 7320 2d2d 7265 6672 6573   status --refres
-00012ca0: 6829 2026 2620 7072 696e 7466 2022 2473  h) && printf "$s
-00012cb0: 2220 2626 207b 7b20 6563 686f 2022 2473  " && {{ echo "$s
-00012cc0: 2220 7c20 6772 6570 207b 6e61 6d65 7d20  " | grep {name} 
-00012cd0: 7c20 6772 6570 2022 4175 746f 646f 776e  | grep "Autodown
-00012ce0: 6564 2063 6c75 7374 6572 5c7c 7465 726d  ed cluster\|term
-00012cf0: 696e 6174 6564 206f 6e20 7468 6520 636c  inated on the cl
-00012d00: 6f75 6422 3b20 7d7d 207c 7c20 7b7b 2065  oud"; }} || {{ e
-00012d10: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
-00012d20: 7b6e 616d 657d 2026 2620 6578 6974 2031  {name} && exit 1
-00012d30: 207c 7c20 6578 6974 2030 3b20 7d7d 272c   || exit 0; }}',
-00012d40: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00012d50: 6b79 206c 6175 6e63 6820 2d79 202d 6420  ky launch -y -d 
-00012d60: 2d63 207b 6e61 6d65 7d20 7b53 4350 5f54  -c {name} {SCP_T
-00012d70: 5950 457d 202d 2d64 6f77 6e20 7465 7374  YPE} --down test
-00012d80: 732f 7465 7374 5f79 616d 6c73 2f6d 696e  s/test_yamls/min
-00012d90: 696d 616c 2e79 616d 6c27 2c0a 2020 2020  imal.yaml',.    
-00012da0: 2020 2020 2020 2020 6627 736b 7920 6175          f'sky au
-00012db0: 746f 7374 6f70 202d 7920 7b6e 616d 657d  tostop -y {name}
-00012dc0: 202d 2d63 616e 6365 6c27 2c0a 2020 2020   --cancel',.    
-00012dd0: 2020 2020 2020 2020 2773 6c65 6570 2032          'sleep 2
-00012de0: 3030 272c 0a20 2020 2020 2020 2020 2020  00',.           
-00012df0: 2023 2045 6e73 7572 6520 7468 6520 636c   # Ensure the cl
-00012e00: 7573 7465 7220 6973 2073 7469 6c6c 2055  uster is still U
-00012e10: 502e 0a20 2020 2020 2020 2020 2020 2066  P..            f
-00012e20: 2773 3d24 2853 4b59 5049 4c4f 545f 4445  's=$(SKYPILOT_DE
-00012e30: 4255 473d 3020 736b 7920 7374 6174 7573  BUG=0 sky status
-00012e40: 202d 2d72 6566 7265 7368 2920 2626 2070   --refresh) && p
-00012e50: 7269 6e74 6620 2224 7322 2026 2620 6563  rintf "$s" && ec
-00012e60: 686f 2022 2473 2220 7c20 6772 6570 207b  ho "$s" | grep {
-00012e70: 6e61 6d65 7d20 7c20 6772 6570 2055 5027  name} | grep UP'
-00012e80: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-00012e90: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
-00012ea0: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-00012eb0: 2020 2020 7469 6d65 6f75 743d 3235 202a      timeout=25 *
-00012ec0: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
-00012ed0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-00012ee0: 290a 0a0a 6465 6620 5f67 6574 5f63 616e  )...def _get_can
-00012ef0: 6365 6c5f 7461 736b 5f77 6974 685f 636c  cel_task_with_cl
-00012f00: 6f75 6428 6e61 6d65 2c20 636c 6f75 642c  oud(name, cloud,
-00012f10: 2074 696d 656f 7574 3d31 3520 2a20 3630   timeout=15 * 60
-00012f20: 293a 0a20 2020 2074 6573 7420 3d20 5465  ):.    test = Te
-00012f30: 7374 280a 2020 2020 2020 2020 6627 7b63  st(.        f'{c
-00012f40: 6c6f 7564 7d2d 6361 6e63 656c 2d74 6173  loud}-cancel-tas
-00012f50: 6b27 2c0a 2020 2020 2020 2020 5b0a 2020  k',.        [.  
-00012f60: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00012f70: 6c61 756e 6368 202d 6320 7b6e 616d 657d  launch -c {name}
-00012f80: 2065 7861 6d70 6c65 732f 7265 736e 6574   examples/resnet
-00012f90: 5f61 7070 2e79 616d 6c20 2d2d 636c 6f75  _app.yaml --clou
-00012fa0: 6420 7b63 6c6f 7564 7d20 2d79 202d 6427  d {cloud} -y -d'
-00012fb0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00012fc0: 5761 6974 2074 6865 2047 5055 2070 726f  Wait the GPU pro
-00012fd0: 6365 7373 2074 6f20 7374 6172 742e 0a20  cess to start.. 
-00012fe0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-00012ff0: 7020 3630 272c 0a20 2020 2020 2020 2020  p 60',.         
-00013000: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
-00013010: 616d 657d 2022 6e76 6964 6961 2d73 6d69  ame} "nvidia-smi
-00013020: 207c 2067 7265 7020 7079 7468 6f6e 2227   | grep python"'
-00013030: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00013040: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-00013050: 3220 2d2d 7374 6174 7573 272c 2020 2320  2 --status',  # 
-00013060: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
-00013070: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
-00013080: 2020 2020 2020 6627 736b 7920 6361 6e63        f'sky canc
-00013090: 656c 202d 7920 7b6e 616d 657d 2031 272c  el -y {name} 1',
-000130a0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-000130b0: 6565 7020 3630 272c 0a20 2020 2020 2020  eep 60',.       
-000130c0: 2020 2020 2023 2063 6865 636b 2069 6620       # check if 
-000130d0: 7468 6520 7079 7468 6f6e 206a 6f62 2069  the python job i
-000130e0: 7320 676f 6e65 2e0a 2020 2020 2020 2020  s gone..        
-000130f0: 2020 2020 6627 736b 7920 6578 6563 207b      f'sky exec {
-00013100: 6e61 6d65 7d20 2221 206e 7669 6469 612d  name} "! nvidia-
-00013110: 736d 6920 7c20 6772 6570 2070 7974 686f  smi | grep pytho
-00013120: 6e22 272c 0a20 2020 2020 2020 2020 2020  n"',.           
-00013130: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00013140: 657d 2033 202d 2d73 7461 7475 7327 2c20  e} 3 --status', 
-00013150: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
-00013160: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
-00013170: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-00013180: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-00013190: 616d 657d 272c 0a20 2020 2020 2020 2074  ame}',.        t
-000131a0: 696d 656f 7574 3d74 696d 656f 7574 2c0a  imeout=timeout,.
-000131b0: 2020 2020 290a 2020 2020 7265 7475 726e      ).    return
-000131c0: 2074 6573 740a 0a0a 2320 2d2d 2d2d 2d2d   test...# ------
-000131d0: 2d2d 2d2d 2054 6573 7469 6e67 2060 736b  ---- Testing `sk
-000131e0: 7920 6361 6e63 656c 6020 2d2d 2d2d 2d2d  y cancel` ------
-000131f0: 2d2d 2d2d 0a40 7079 7465 7374 2e6d 6172  ----.@pytest.mar
-00013200: 6b2e 6177 730a 4070 7974 6573 742e 6d61  k.aws.@pytest.ma
-00013210: 726b 2e73 6b69 7028 0a20 2020 2072 6561  rk.skip(.    rea
-00013220: 736f 6e3d 2754 6865 2072 6573 6e65 745f  son='The resnet_
-00013230: 6170 7020 6973 2066 6c61 6b79 2c20 6475  app is flaky, du
-00013240: 6520 746f 2054 4620 6661 696c 696e 6720  e to TF failing 
-00013250: 746f 2064 6574 6563 7420 4750 5573 2e27  to detect GPUs.'
-00013260: 290a 6465 6620 7465 7374 5f63 616e 6365  ).def test_cance
-00013270: 6c5f 6177 7328 293a 0a20 2020 206e 616d  l_aws():.    nam
-00013280: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-00013290: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-000132a0: 203d 205f 6765 745f 6361 6e63 656c 5f74   = _get_cancel_t
-000132b0: 6173 6b5f 7769 7468 5f63 6c6f 7564 286e  ask_with_cloud(n
-000132c0: 616d 652c 2027 6177 7327 290a 2020 2020  ame, 'aws').    
-000132d0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-000132e0: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-000132f0: 6b2e 6763 700a 4070 7974 6573 742e 6d61  k.gcp.@pytest.ma
-00013300: 726b 2e73 6b69 7028 0a20 2020 2072 6561  rk.skip(.    rea
-00013310: 736f 6e3d 2754 6865 2072 6573 6e65 745f  son='The resnet_
-00013320: 6170 7020 6973 2066 6c61 6b79 2c20 6475  app is flaky, du
-00013330: 6520 746f 2054 4620 6661 696c 696e 6720  e to TF failing 
-00013340: 746f 2064 6574 6563 7420 4750 5573 2e27  to detect GPUs.'
-00013350: 290a 6465 6620 7465 7374 5f63 616e 6365  ).def test_cance
-00013360: 6c5f 6763 7028 293a 0a20 2020 206e 616d  l_gcp():.    nam
-00013370: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-00013380: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-00013390: 203d 205f 6765 745f 6361 6e63 656c 5f74   = _get_cancel_t
-000133a0: 6173 6b5f 7769 7468 5f63 6c6f 7564 286e  ask_with_cloud(n
-000133b0: 616d 652c 2027 6763 7027 290a 2020 2020  ame, 'gcp').    
-000133c0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-000133d0: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-000133e0: 6b2e 617a 7572 650a 4070 7974 6573 742e  k.azure.@pytest.
-000133f0: 6d61 726b 2e73 6b69 7028 0a20 2020 2072  mark.skip(.    r
-00013400: 6561 736f 6e3d 2754 6865 2072 6573 6e65  eason='The resne
-00013410: 745f 6170 7020 6973 2066 6c61 6b79 2c20  t_app is flaky, 
-00013420: 6475 6520 746f 2054 4620 6661 696c 696e  due to TF failin
-00013430: 6720 746f 2064 6574 6563 7420 4750 5573  g to detect GPUs
-00013440: 2e27 290a 6465 6620 7465 7374 5f63 616e  .').def test_can
-00013450: 6365 6c5f 617a 7572 6528 293a 0a20 2020  cel_azure():.   
-00013460: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-00013470: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-00013480: 7465 7374 203d 205f 6765 745f 6361 6e63  test = _get_canc
-00013490: 656c 5f74 6173 6b5f 7769 7468 5f63 6c6f  el_task_with_clo
-000134a0: 7564 286e 616d 652c 2027 617a 7572 6527  ud(name, 'azure'
-000134b0: 2c20 7469 6d65 6f75 743d 3330 202a 2036  , timeout=30 * 6
-000134c0: 3029 0a20 2020 2072 756e 5f6f 6e65 5f74  0).    run_one_t
-000134d0: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
-000134e0: 6573 742e 6d61 726b 2e6e 6f5f 6c61 6d62  est.mark.no_lamb
-000134f0: 6461 5f63 6c6f 7564 2020 2320 4c61 6d62  da_cloud  # Lamb
-00013500: 6461 2043 6c6f 7564 2064 6f65 7320 6e6f  da Cloud does no
-00013510: 7420 6861 7665 2056 3130 3020 6770 7573  t have V100 gpus
-00013520: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-00013530: 5f69 626d 2020 2320 4942 4d20 636c 6f75  _ibm  # IBM clou
-00013540: 6420 6375 7272 656e 746c 7920 646f 6573  d currently does
-00013550: 6e27 7420 7072 6f76 6964 6520 7075 626c  n't provide publ
-00013560: 6963 2069 6d61 6765 2077 6974 6820 4355  ic image with CU
-00013570: 4441 0a40 7079 7465 7374 2e6d 6172 6b2e  DA.@pytest.mark.
-00013580: 6e6f 5f73 6370 2020 2320 5343 5020 646f  no_scp  # SCP do
-00013590: 6573 206e 6f74 2073 7570 706f 7274 206e  es not support n
-000135a0: 756d 5f6e 6f64 6573 203e 2031 2079 6574  um_nodes > 1 yet
-000135b0: 0a64 6566 2074 6573 745f 6361 6e63 656c  .def test_cancel
-000135c0: 5f70 7974 6f72 6368 2867 656e 6572 6963  _pytorch(generic
-000135d0: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
-000135e0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-000135f0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-00013600: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-00013610: 2020 2020 2020 2763 616e 6365 6c2d 7079        'cancel-py
-00013620: 746f 7263 6827 2c0a 2020 2020 2020 2020  torch',.        
-00013630: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
-00013640: 736b 7920 6c61 756e 6368 202d 6320 7b6e  sky launch -c {n
-00013650: 616d 657d 202d 2d63 6c6f 7564 207b 6765  ame} --cloud {ge
-00013660: 6e65 7269 635f 636c 6f75 647d 2065 7861  neric_cloud} exa
-00013670: 6d70 6c65 732f 7265 736e 6574 5f64 6973  mples/resnet_dis
-00013680: 7472 6962 7574 6564 5f74 6f72 6368 2e79  tributed_torch.y
-00013690: 616d 6c20 2d79 202d 6427 2c0a 2020 2020  aml -y -d',.    
-000136a0: 2020 2020 2020 2020 2320 5761 6974 2074          # Wait t
-000136b0: 6865 2047 5055 2070 726f 6365 7373 2074  he GPU process t
-000136c0: 6f20 7374 6172 742e 0a20 2020 2020 2020  o start..       
-000136d0: 2020 2020 2027 736c 6565 7020 3930 272c       'sleep 90',
-000136e0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-000136f0: 6b79 2065 7865 6320 7b6e 616d 657d 2022  ky exec {name} "
-00013700: 286e 7669 6469 612d 736d 6920 7c20 6772  (nvidia-smi | gr
-00013710: 6570 2070 7974 686f 6e29 207c 7c20 270a  ep python) || '.
-00013720: 2020 2020 2020 2020 2020 2020 2320 5768              # Wh
-00013730: 656e 2072 756e 2069 6e73 6964 6520 636f  en run inside co
-00013740: 6e74 6169 6e65 722f 6b38 732c 206e 7669  ntainer/k8s, nvi
-00013750: 6469 612d 736d 6920 6361 6e6e 6f74 2073  dia-smi cannot s
-00013760: 686f 7720 7072 6f63 6573 7320 6964 732e  how process ids.
-00013770: 0a20 2020 2020 2020 2020 2020 2023 2053  .            # S
-00013780: 6565 2068 7474 7073 3a2f 2f67 6974 6875  ee https://githu
-00013790: 622e 636f 6d2f 4e56 4944 4941 2f6e 7669  b.com/NVIDIA/nvi
-000137a0: 6469 612d 646f 636b 6572 2f69 7373 7565  dia-docker/issue
-000137b0: 732f 3137 390a 2020 2020 2020 2020 2020  s/179.          
-000137c0: 2020 2320 546f 2077 6f72 6b20 6172 6f75    # To work arou
-000137d0: 6e64 2c20 7765 2063 6865 636b 2069 6620  nd, we check if 
-000137e0: 4750 5520 7574 696c 697a 6174 696f 6e20  GPU utilization 
-000137f0: 6973 2067 7265 6174 6572 2074 6861 6e20  is greater than 
-00013800: 302e 0a20 2020 2020 2020 2020 2020 2066  0..            f
-00013810: 275b 205c 2428 6e76 6964 6961 2d73 6d69  '[ \$(nvidia-smi
-00013820: 202d 2d71 7565 7279 2d67 7075 3d75 7469   --query-gpu=uti
-00013830: 6c69 7a61 7469 6f6e 2e67 7075 202d 2d66  lization.gpu --f
-00013840: 6f72 6d61 743d 6373 762c 6e6f 6865 6164  ormat=csv,nohead
-00013850: 6572 2c6e 6f75 6e69 7473 2920 2d67 7420  er,nounits) -gt 
-00013860: 3020 5d22 272c 0a20 2020 2020 2020 2020  0 ]"',.         
-00013870: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-00013880: 616d 657d 2032 202d 2d73 7461 7475 7327  ame} 2 --status'
-00013890: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
-000138a0: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
-000138b0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-000138c0: 2063 616e 6365 6c20 2d79 207b 6e61 6d65   cancel -y {name
-000138d0: 7d20 3127 2c0a 2020 2020 2020 2020 2020  } 1',.          
-000138e0: 2020 2773 6c65 6570 2036 3027 2c0a 2020    'sleep 60',.  
-000138f0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00013900: 6578 6563 207b 6e61 6d65 7d20 2228 6e76  exec {name} "(nv
-00013910: 6964 6961 2d73 6d69 207c 2067 7265 7020  idia-smi | grep 
-00013920: 5c27 4e6f 2072 756e 6e69 6e67 2070 726f  \'No running pro
-00013930: 6365 7373 5c27 2920 7c7c 2027 0a20 2020  cess\') || '.   
-00013940: 2020 2020 2020 2020 2023 2045 6e73 7572           # Ensur
-00013950: 6520 586f 7267 2069 7320 7468 6520 6f6e  e Xorg is the on
-00013960: 6c79 2070 726f 6365 7373 2072 756e 6e69  ly process runni
-00013970: 6e67 2e0a 2020 2020 2020 2020 2020 2020  ng..            
-00013980: 275b 205c 2428 6e76 6964 6961 2d73 6d69  '[ \$(nvidia-smi
-00013990: 207c 2067 7265 7020 2d41 2031 3020 5072   | grep -A 10 Pr
-000139a0: 6f63 6573 7365 7320 7c20 6772 6570 202d  ocesses | grep -
-000139b0: 4120 3130 203d 3d3d 207c 2067 7265 7020  A 10 === | grep 
-000139c0: 2d76 2058 6f72 6729 202d 6571 2032 205d  -v Xorg) -eq 2 ]
-000139d0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-000139e0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
-000139f0: 7d20 3320 2d2d 7374 6174 7573 272c 2020  } 3 --status',  
-00013a00: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
-00013a10: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
-00013a20: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
-00013a30: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
-00013a40: 6d65 7d27 2c0a 2020 2020 2020 2020 7469  me}',.        ti
-00013a50: 6d65 6f75 743d 3230 202a 2036 302c 0a20  meout=20 * 60,. 
-00013a60: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-00013a70: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
-00013a80: 6361 6e27 7420 7573 6520 605f 6765 745f  can't use `_get_
-00013a90: 6361 6e63 656c 5f74 6173 6b5f 7769 7468  cancel_task_with
-00013aa0: 5f63 6c6f 7564 2829 602c 2061 7320 636f  _cloud()`, as co
-00013ab0: 6d6d 616e 6420 606e 7669 6469 612d 736d  mmand `nvidia-sm
-00013ac0: 6960 0a23 2072 6571 7569 7265 7320 6120  i`.# requires a 
-00013ad0: 4355 4441 2070 7562 6c69 6320 696d 6167  CUDA public imag
-00013ae0: 652c 2077 6869 6368 2049 424d 2064 6f65  e, which IBM doe
-00013af0: 736e 2774 206f 6666 6572 0a40 7079 7465  sn't offer.@pyte
-00013b00: 7374 2e6d 6172 6b2e 6962 6d0a 6465 6620  st.mark.ibm.def 
-00013b10: 7465 7374 5f63 616e 6365 6c5f 6962 6d28  test_cancel_ibm(
-00013b20: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
-00013b30: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-00013b40: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
-00013b50: 7428 0a20 2020 2020 2020 2027 6962 6d2d  t(.        'ibm-
-00013b60: 6361 6e63 656c 2d74 6173 6b27 2c0a 2020  cancel-task',.  
-00013b70: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-00013b80: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-00013b90: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
-00013ba0: 636c 6f75 6420 6962 6d20 6578 616d 706c  cloud ibm exampl
-00013bb0: 6573 2f6d 696e 696d 616c 2e79 616d 6c27  es/minimal.yaml'
-00013bc0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00013bd0: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
-00013be0: 2d6e 207b 6e61 6d65 7d2d 3120 2d64 2020  -n {name}-1 -d  
-00013bf0: 2277 6869 6c65 2074 7275 653b 2064 6f20  "while true; do 
-00013c00: 6563 686f 205c 2748 656c 6c6f 2053 6b79  echo \'Hello Sky
-00013c10: 5069 6c6f 745c 273b 2073 6c65 6570 2032  Pilot\'; sleep 2
-00013c20: 3b20 646f 6e65 2227 2c0a 2020 2020 2020  ; done"',.      
-00013c30: 2020 2020 2020 2773 6c65 6570 2032 3027        'sleep 20'
-00013c40: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00013c50: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
-00013c60: 207c 2067 7265 7020 7b6e 616d 657d 2d31   | grep {name}-1
-00013c70: 207c 2067 7265 7020 5255 4e4e 494e 4727   | grep RUNNING'
-00013c80: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00013c90: 736b 7920 6361 6e63 656c 202d 7920 7b6e  sky cancel -y {n
-00013ca0: 616d 657d 2032 272c 0a20 2020 2020 2020  ame} 2',.       
-00013cb0: 2020 2020 2066 2773 6c65 6570 2035 272c       f'sleep 5',
-00013cc0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
-00013cd0: 6b79 2071 7565 7565 207b 6e61 6d65 7d20  ky queue {name} 
-00013ce0: 7c20 6772 6570 207b 6e61 6d65 7d2d 3120  | grep {name}-1 
-00013cf0: 7c20 6772 6570 2043 414e 4345 4c4c 4544  | grep CANCELLED
-00013d00: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
-00013d10: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-00013d20: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-00013d30: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-00013d40: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
-00013d50: 2d2d 2d2d 2d2d 2d2d 2054 6573 7469 6e67  -------- Testing
-00013d60: 2075 7365 2d73 706f 7420 6f70 7469 6f6e   use-spot option
-00013d70: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974   ----------.@pyt
-00013d80: 6573 742e 6d61 726b 2e6e 6f5f 666c 7569  est.mark.no_flui
-00013d90: 6473 7461 636b 2020 2320 466c 7569 6453  dstack  # FluidS
-00013da0: 7461 636b 2064 6f65 7320 6e6f 7420 7375  tack does not su
-00013db0: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
-00013dc0: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
-00013dd0: 6b2e 6e6f 5f61 7a75 7265 2020 2320 417a  k.no_azure  # Az
-00013de0: 7572 6520 646f 6573 206e 6f74 2073 7570  ure does not sup
-00013df0: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
-00013e00: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
-00013e10: 2e6e 6f5f 6c61 6d62 6461 5f63 6c6f 7564  .no_lambda_cloud
-00013e20: 2020 2320 4c61 6d62 6461 2043 6c6f 7564    # Lambda Cloud
-00013e30: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-00013e40: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
-00013e50: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-00013e60: 5f69 626d 2020 2320 4942 4d20 436c 6f75  _ibm  # IBM Clou
-00013e70: 6420 646f 6573 206e 6f74 2073 7570 706f  d does not suppo
-00013e80: 7274 2073 706f 7420 696e 7374 616e 6365  rt spot instance
-00013e90: 730a 4070 7974 6573 742e 6d61 726b 2e6e  s.@pytest.mark.n
-00013ea0: 6f5f 7363 7020 2023 2053 4350 2064 6f65  o_scp  # SCP doe
-00013eb0: 7320 6e6f 7420 7375 7070 6f72 7420 7370  s not support sp
-00013ec0: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
-00013ed0: 7465 7374 2e6d 6172 6b2e 6e6f 5f6b 7562  test.mark.no_kub
-00013ee0: 6572 6e65 7465 7320 2023 204b 7562 6572  ernetes  # Kuber
-00013ef0: 6e65 7465 7320 646f 6573 206e 6f74 2068  netes does not h
-00013f00: 6176 6520 6120 6e6f 7469 6f6e 206f 6620  ave a notion of 
-00013f10: 7370 6f74 2069 6e73 7461 6e63 6573 0a64  spot instances.d
-00013f20: 6566 2074 6573 745f 7573 655f 7370 6f74  ef test_use_spot
-00013f30: 2867 656e 6572 6963 5f63 6c6f 7564 3a20  (generic_cloud: 
-00013f40: 7374 7229 3a0a 2020 2020 2222 2254 6573  str):.    """Tes
-00013f50: 7420 7573 652d 7370 6f74 2061 6e64 2073  t use-spot and s
-00013f60: 6b79 2065 7865 632e 2222 220a 2020 2020  ky exec.""".    
-00013f70: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-00013f80: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
-00013f90: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-00013fa0: 2020 2020 2775 7365 2d73 706f 7427 2c0a      'use-spot',.
-00013fb0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-00013fc0: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-00013fd0: 6368 202d 6320 7b6e 616d 657d 202d 2d63  ch -c {name} --c
-00013fe0: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
-00013ff0: 6f75 647d 2074 6573 7473 2f74 6573 745f  oud} tests/test_
-00014000: 7961 6d6c 732f 6d69 6e69 6d61 6c2e 7961  yamls/minimal.ya
-00014010: 6d6c 202d 2d75 7365 2d73 706f 7420 2d79  ml --use-spot -y
-00014020: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00014030: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-00014040: 2031 202d 2d73 7461 7475 7327 2c0a 2020   1 --status',.  
-00014050: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00014060: 6578 6563 207b 6e61 6d65 7d20 6563 686f  exec {name} echo
-00014070: 2068 6927 2c0a 2020 2020 2020 2020 2020   hi',.          
-00014080: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
-00014090: 6d65 7d20 3220 2d2d 7374 6174 7573 272c  me} 2 --status',
-000140a0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-000140b0: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
-000140c0: 7920 7b6e 616d 657d 272c 0a20 2020 2029  y {name}',.    )
-000140d0: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-000140e0: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-000140f0: 742e 6d61 726b 2e67 6370 0a64 6566 2074  t.mark.gcp.def t
-00014100: 6573 745f 7374 6f70 5f67 6370 5f73 706f  est_stop_gcp_spo
-00014110: 7428 293a 0a20 2020 2022 2222 5465 7374  t():.    """Test
-00014120: 2047 4350 2073 706f 7420 6361 6e20 6265   GCP spot can be
-00014130: 2073 746f 7070 6564 2c20 6175 746f 7374   stopped, autost
-00014140: 6f70 7065 642c 2072 6573 7461 7274 6564  opped, restarted
-00014150: 2e22 2222 0a20 2020 206e 616d 6520 3d20  .""".    name = 
-00014160: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-00014170: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
-00014180: 6573 7428 0a20 2020 2020 2020 2027 7374  est(.        'st
-00014190: 6f70 5f67 6370 5f73 706f 7427 2c0a 2020  op_gcp_spot',.  
-000141a0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-000141b0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-000141c0: 202d 6320 7b6e 616d 657d 202d 2d63 6c6f   -c {name} --clo
-000141d0: 7564 2067 6370 202d 2d75 7365 2d73 706f  ud gcp --use-spo
-000141e0: 7420 2d2d 6370 7573 2032 2b20 2d79 202d  t --cpus 2+ -y -
-000141f0: 2d20 746f 7563 6820 6d79 6669 6c65 272c  - touch myfile',
-00014200: 0a20 2020 2020 2020 2020 2020 2023 2073  .            # s
-00014210: 746f 7020 7368 6f75 6c64 2067 6f20 7468  top should go th
-00014220: 726f 7567 683a 0a20 2020 2020 2020 2020  rough:.         
-00014230: 2020 2066 2773 6b79 2073 746f 7020 7b6e     f'sky stop {n
-00014240: 616d 657d 202d 7927 2c0a 2020 2020 2020  ame} -y',.      
-00014250: 2020 2020 2020 6627 736b 7920 7374 6172        f'sky star
-00014260: 7420 7b6e 616d 657d 202d 7927 2c0a 2020  t {name} -y',.  
-00014270: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00014280: 6578 6563 207b 6e61 6d65 7d20 2d2d 206c  exec {name} -- l
-00014290: 7320 6d79 6669 6c65 272c 0a20 2020 2020  s myfile',.     
-000142a0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-000142b0: 7320 7b6e 616d 657d 2032 202d 2d73 7461  s {name} 2 --sta
-000142c0: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
-000142d0: 2020 6627 736b 7920 6175 746f 7374 6f70    f'sky autostop
-000142e0: 207b 6e61 6d65 7d20 2d69 3020 2d79 272c   {name} -i0 -y',
-000142f0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-00014300: 6565 7020 3930 272c 0a20 2020 2020 2020  eep 90',.       
-00014310: 2020 2020 2066 2773 3d24 2873 6b79 2073       f's=$(sky s
-00014320: 7461 7475 7320 7b6e 616d 657d 202d 2d72  tatus {name} --r
-00014330: 6566 7265 7368 293b 2065 6368 6f20 2224  efresh); echo "$
-00014340: 7322 3b20 6563 686f 3b20 6563 686f 3b20  s"; echo; echo; 
-00014350: 6563 686f 2022 2473 2220 207c 2067 7265  echo "$s"  | gre
-00014360: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
-00014370: 5354 4f50 5045 4427 2c0a 2020 2020 2020  STOPPED',.      
-00014380: 2020 2020 2020 6627 736b 7920 7374 6172        f'sky star
-00014390: 7420 7b6e 616d 657d 202d 7927 2c0a 2020  t {name} -y',.  
-000143a0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-000143b0: 6578 6563 207b 6e61 6d65 7d20 2d2d 206c  exec {name} -- l
-000143c0: 7320 6d79 6669 6c65 272c 0a20 2020 2020  s myfile',.     
-000143d0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-000143e0: 7320 7b6e 616d 657d 2033 202d 2d73 7461  s {name} 3 --sta
-000143f0: 7475 7327 2c0a 2020 2020 2020 2020 2020  tus',.          
-00014400: 2020 2320 2d69 206f 7074 696f 6e20 6174    # -i option at
-00014410: 206c 6175 6e63 6820 7368 6f75 6c64 2067   launch should g
-00014420: 6f20 7468 726f 7567 683a 0a20 2020 2020  o through:.     
-00014430: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-00014440: 6e63 6820 2d63 207b 6e61 6d65 7d20 2d69  nch -c {name} -i
-00014450: 3020 2d79 272c 0a20 2020 2020 2020 2020  0 -y',.         
-00014460: 2020 2027 736c 6565 7020 3132 3027 2c0a     'sleep 120',.
-00014470: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
-00014480: 2428 736b 7920 7374 6174 7573 207b 6e61  $(sky status {na
-00014490: 6d65 7d20 2d2d 7265 6672 6573 6829 3b20  me} --refresh); 
-000144a0: 6563 686f 2022 2473 223b 2065 6368 6f3b  echo "$s"; echo;
-000144b0: 2065 6368 6f3b 2065 6368 6f20 2224 7322   echo; echo "$s"
-000144c0: 2020 7c20 6772 6570 207b 6e61 6d65 7d20    | grep {name} 
-000144d0: 7c20 6772 6570 2053 544f 5050 4544 272c  | grep STOPPED',
-000144e0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-000144f0: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
-00014500: 7920 7b6e 616d 657d 272c 0a20 2020 2029  y {name}',.    )
-00014510: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-00014520: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
-00014530: 2d2d 2d2d 2d2d 2054 6573 7469 6e67 206d  ------ Testing m
-00014540: 616e 6167 6564 2073 706f 7420 2d2d 2d2d  anaged spot ----
-00014550: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
-00014560: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
-00014570: 6b20 2023 2046 6c75 6964 5374 6163 6b20  k  # FluidStack 
-00014580: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
-00014590: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
-000145a0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-000145b0: 617a 7572 6520 2023 2041 7a75 7265 2064  azure  # Azure d
-000145c0: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
-000145d0: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
-000145e0: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f6c  pytest.mark.no_l
-000145f0: 616d 6264 615f 636c 6f75 6420 2023 204c  ambda_cloud  # L
-00014600: 616d 6264 6120 436c 6f75 6420 646f 6573  ambda Cloud does
-00014610: 206e 6f74 2073 7570 706f 7274 2073 706f   not support spo
-00014620: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
-00014630: 6573 742e 6d61 726b 2e6e 6f5f 6962 6d20  est.mark.no_ibm 
-00014640: 2023 2049 424d 2043 6c6f 7564 2064 6f65   # IBM Cloud doe
-00014650: 7320 6e6f 7420 7375 7070 6f72 7420 7370  s not support sp
-00014660: 6f74 2069 6e73 7461 6e63 6573 0a40 7079  ot instances.@py
-00014670: 7465 7374 2e6d 6172 6b2e 6e6f 5f73 6370  test.mark.no_scp
-00014680: 2020 2320 5343 5020 646f 6573 206e 6f74    # SCP does not
-00014690: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
-000146a0: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
-000146b0: 6d61 726b 2e6e 6f5f 6b75 6265 726e 6574  mark.no_kubernet
-000146c0: 6573 2020 2320 4b75 6265 726e 6574 6573  es  # Kubernetes
-000146d0: 2064 6f65 7320 6e6f 7420 6861 7665 2061   does not have a
-000146e0: 206e 6f74 696f 6e20 6f66 2073 706f 7420   notion of spot 
-000146f0: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
-00014700: 742e 6d61 726b 2e6d 616e 6167 6564 5f73  t.mark.managed_s
-00014710: 706f 740a 6465 6620 7465 7374 5f73 706f  pot.def test_spo
-00014720: 7428 6765 6e65 7269 635f 636c 6f75 643a  t(generic_cloud:
-00014730: 2073 7472 293a 0a20 2020 2022 2222 5465   str):.    """Te
-00014740: 7374 2074 6865 2073 706f 7420 7961 6d6c  st the spot yaml
-00014750: 2e22 2222 0a20 2020 206e 616d 6520 3d20  .""".    name = 
-00014760: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-00014770: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
-00014780: 6573 7428 0a20 2020 2020 2020 2027 6d61  est(.        'ma
-00014790: 6e61 6765 642d 7370 6f74 272c 0a20 2020  naged-spot',.   
-000147a0: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-000147b0: 2020 2066 2773 6b79 2073 706f 7420 6c61     f'sky spot la
-000147c0: 756e 6368 202d 6e20 7b6e 616d 657d 2d31  unch -n {name}-1
-000147d0: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
-000147e0: 635f 636c 6f75 647d 2065 7861 6d70 6c65  c_cloud} example
-000147f0: 732f 6d61 6e61 6765 645f 7370 6f74 2e79  s/managed_spot.y
-00014800: 616d 6c20 2d79 202d 6427 2c0a 2020 2020  aml -y -d',.    
-00014810: 2020 2020 2020 2020 6627 736b 7920 7370          f'sky sp
-00014820: 6f74 206c 6175 6e63 6820 2d6e 207b 6e61  ot launch -n {na
-00014830: 6d65 7d2d 3220 2d2d 636c 6f75 6420 7b67  me}-2 --cloud {g
-00014840: 656e 6572 6963 5f63 6c6f 7564 7d20 6578  eneric_cloud} ex
-00014850: 616d 706c 6573 2f6d 616e 6167 6564 5f73  amples/managed_s
-00014860: 706f 742e 7961 6d6c 202d 7920 2d64 272c  pot.yaml -y -d',
-00014870: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-00014880: 6565 7020 3527 2c0a 2020 2020 2020 2020  eep 5',.        
-00014890: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
-000148a0: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
-000148b0: 6e61 6d65 7d2d 3120 7c20 6865 6164 202d  name}-1 | head -
-000148c0: 6e31 207c 2067 7265 7020 2253 5441 5254  n1 | grep "START
-000148d0: 494e 475c 7c52 554e 4e49 4e47 2227 2c0a  ING\|RUNNING"',.
-000148e0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-000148f0: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
-00014900: 7c20 6772 6570 207b 6e61 6d65 7d2d 3220  | grep {name}-2 
-00014910: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
-00014920: 7020 2253 5441 5254 494e 475c 7c52 554e  p "STARTING\|RUN
-00014930: 4e49 4e47 2227 2c0a 2020 2020 2020 2020  NING"',.        
-00014940: 2020 2020 5f53 504f 545f 4341 4e43 454c      _SPOT_CANCEL
-00014950: 5f57 4149 542e 666f 726d 6174 286a 6f62  _WAIT.format(job
-00014960: 5f6e 616d 653d 6627 7b6e 616d 657d 2d31  _name=f'{name}-1
-00014970: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
-00014980: 2773 6c65 6570 2035 272c 0a20 2020 2020  'sleep 5',.     
-00014990: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
-000149a0: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
-000149b0: 7020 7b6e 616d 657d 2d31 207c 2068 6561  p {name}-1 | hea
-000149c0: 6420 2d6e 3120 7c20 6772 6570 2022 4341  d -n1 | grep "CA
-000149d0: 4e43 454c 4c49 4e47 5c7c 4341 4e43 454c  NCELLING\|CANCEL
-000149e0: 4c45 4422 272c 0a20 2020 2020 2020 2020  LED"',.         
-000149f0: 2020 2027 736c 6565 7020 3230 3027 2c0a     'sleep 200',.
-00014a00: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-00014a10: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
-00014a20: 7c20 6772 6570 207b 6e61 6d65 7d2d 3120  | grep {name}-1 
-00014a30: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
-00014a40: 7020 4341 4e43 454c 4c45 4427 2c0a 2020  p CANCELLED',.  
-00014a50: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-00014a60: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
-00014a70: 6772 6570 207b 6e61 6d65 7d2d 3220 7c20  grep {name}-2 | 
-00014a80: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
-00014a90: 2252 554e 4e49 4e47 5c7c 5355 4343 4545  "RUNNING\|SUCCEE
-00014aa0: 4445 4422 272c 0a20 2020 2020 2020 205d  DED"',.        ]
-00014ab0: 2c0a 2020 2020 2020 2020 2320 544f 444f  ,.        # TODO
-00014ac0: 287a 6877 7529 3a20 4368 616e 6765 2074  (zhwu): Change t
-00014ad0: 6f20 5f53 504f 545f 4341 4e43 454c 5f57  o _SPOT_CANCEL_W
-00014ae0: 4149 542e 666f 726d 6174 286a 6f62 5f6e  AIT.format(job_n
-00014af0: 616d 653d 6627 7b6e 616d 657d 2d31 202d  ame=f'{name}-1 -
-00014b00: 6e20 7b6e 616d 657d 2d32 2729 2077 6865  n {name}-2') whe
-00014b10: 6e0a 2020 2020 2020 2020 2320 6361 6e63  n.        # canc
-00014b20: 656c 696e 6720 6d75 6c74 6970 6c65 206a  eling multiple j
-00014b30: 6f62 206e 616d 6573 2069 7320 7375 7070  ob names is supp
-00014b40: 6f72 7465 642e 0a20 2020 2020 2020 2028  orted..        (
-00014b50: 5f53 504f 545f 4341 4e43 454c 5f57 4149  _SPOT_CANCEL_WAI
-00014b60: 542e 666f 726d 6174 286a 6f62 5f6e 616d  T.format(job_nam
-00014b70: 653d 6627 7b6e 616d 657d 2d31 2729 202b  e=f'{name}-1') +
-00014b80: 2027 3b20 2720 2b0a 2020 2020 2020 2020   '; ' +.        
-00014b90: 205f 5350 4f54 5f43 414e 4345 4c5f 5741   _SPOT_CANCEL_WA
-00014ba0: 4954 2e66 6f72 6d61 7428 6a6f 625f 6e61  IT.format(job_na
-00014bb0: 6d65 3d66 277b 6e61 6d65 7d2d 3227 2929  me=f'{name}-2'))
-00014bc0: 2c0a 2020 2020 2020 2020 2320 496e 6372  ,.        # Incr
-00014bd0: 6561 7365 2074 696d 656f 7574 2073 696e  ease timeout sin
-00014be0: 6365 2073 6b79 2073 706f 7420 7175 6575  ce sky spot queu
-00014bf0: 6520 2d72 2063 616e 2062 6520 626c 6f63  e -r can be bloc
-00014c00: 6b65 6420 6279 206f 7468 6572 2073 706f  ked by other spo
-00014c10: 7420 7465 7374 732e 0a20 2020 2020 2020  t tests..       
-00014c20: 2074 696d 656f 7574 3d32 3020 2a20 3630   timeout=20 * 60
-00014c30: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
-00014c40: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-00014c50: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-00014c60: 5f66 6c75 6964 7374 6163 6b20 2023 666c  _fluidstack  #fl
-00014c70: 7569 6473 7461 636b 2064 6f65 7320 6e6f  uidstack does no
-00014c80: 7420 7375 7070 6f72 7420 7370 6f74 2069  t support spot i
-00014c90: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
-00014ca0: 2e6d 6172 6b2e 6e6f 5f61 7a75 7265 2020  .mark.no_azure  
-00014cb0: 2320 417a 7572 6520 646f 6573 206e 6f74  # Azure does not
-00014cc0: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
-00014cd0: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
-00014ce0: 6d61 726b 2e6e 6f5f 6c61 6d62 6461 5f63  mark.no_lambda_c
-00014cf0: 6c6f 7564 2020 2320 4c61 6d62 6461 2043  loud  # Lambda C
-00014d00: 6c6f 7564 2064 6f65 7320 6e6f 7420 7375  loud does not su
-00014d10: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
-00014d20: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
-00014d30: 6b2e 6e6f 5f69 626d 2020 2320 4942 4d20  k.no_ibm  # IBM 
-00014d40: 436c 6f75 6420 646f 6573 206e 6f74 2073  Cloud does not s
-00014d50: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
-00014d60: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
-00014d70: 726b 2e6e 6f5f 7363 7020 2023 2053 4350  rk.no_scp  # SCP
-00014d80: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-00014d90: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
-00014da0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-00014db0: 5f6b 7562 6572 6e65 7465 7320 2023 204b  _kubernetes  # K
-00014dc0: 7562 6572 6e65 7465 7320 646f 6573 206e  ubernetes does n
-00014dd0: 6f74 2068 6176 6520 6120 6e6f 7469 6f6e  ot have a notion
-00014de0: 206f 6620 7370 6f74 2069 6e73 7461 6e63   of spot instanc
-00014df0: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
-00014e00: 6d61 6e61 6765 645f 7370 6f74 0a64 6566  managed_spot.def
-00014e10: 2074 6573 745f 7370 6f74 5f70 6970 656c   test_spot_pipel
-00014e20: 696e 6528 6765 6e65 7269 635f 636c 6f75  ine(generic_clou
-00014e30: 643a 2073 7472 293a 0a20 2020 2022 2222  d: str):.    """
-00014e40: 5465 7374 2061 2073 706f 74c2 a070 6970  Test a spot..pip
-00014e50: 656c 696e 652e 2222 220a 2020 2020 6e61  eline.""".    na
-00014e60: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-00014e70: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
-00014e80: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-00014e90: 2020 2773 706f 742d 7069 7065 6c69 6e65    'spot-pipeline
-00014ea0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-00014eb0: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-00014ec0: 706f 7420 6c61 756e 6368 202d 6e20 7b6e  pot launch -n {n
-00014ed0: 616d 657d 2074 6573 7473 2f74 6573 745f  ame} tests/test_
-00014ee0: 7961 6d6c 732f 7069 7065 6c69 6e65 2e79  yamls/pipeline.y
-00014ef0: 616d 6c20 2d79 202d 6427 2c0a 2020 2020  aml -y -d',.    
-00014f00: 2020 2020 2020 2020 2773 6c65 6570 2035          'sleep 5
-00014f10: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00014f20: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
-00014f30: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
-00014f40: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
-00014f50: 6570 2022 5354 4152 5449 4e47 5c7c 5255  ep "STARTING\|RU
-00014f60: 4e4e 494e 4722 272c 0a20 2020 2020 2020  NNING"',.       
-00014f70: 2020 2020 2023 2060 6772 6570 202d 4120       # `grep -A 
-00014f80: 3420 7b6e 616d 657d 6020 6669 6e64 7320  4 {name}` finds 
-00014f90: 7468 6520 6a6f 6220 7769 7468 207b 6e61  the job with {na
-00014fa0: 6d65 7d20 616e 6420 7468 6520 3420 6c69  me} and the 4 li
-00014fb0: 6e65 730a 2020 2020 2020 2020 2020 2020  nes.            
-00014fc0: 2320 6166 7465 7220 6974 2c20 692e 652e  # after it, i.e.
-00014fd0: 2074 6865 2034 2074 6173 6b73 2077 6974   the 4 tasks wit
-00014fe0: 6869 6e20 7468 6520 6a6f 622e 0a20 2020  hin the job..   
-00014ff0: 2020 2020 2020 2020 2023 2060 7365 6420           # `sed 
-00015000: 2d6e 2032 7060 2067 6574 7320 7468 6520  -n 2p` gets the 
-00015010: 7365 636f 6e64 206c 696e 6520 6f66 2074  second line of t
-00015020: 6865 2034 206c 696e 6573 2c20 692e 652e  he 4 lines, i.e.
-00015030: 2074 6865 2066 6972 7374 0a20 2020 2020   the first.     
-00015040: 2020 2020 2020 2023 2074 6173 6b20 7769         # task wi
-00015050: 7468 696e 2074 6865 206a 6f62 2e0a 2020  thin the job..  
-00015060: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-00015070: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
-00015080: 6772 6570 202d 4120 3420 7b6e 616d 657d  grep -A 4 {name}
-00015090: 7c20 7365 6420 2d6e 2032 7020 7c20 6772  | sed -n 2p | gr
-000150a0: 6570 2022 5354 4152 5449 4e47 5c7c 5255  ep "STARTING\|RU
-000150b0: 4e4e 494e 4722 272c 0a20 2020 2020 2020  NNING"',.       
-000150c0: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
-000150d0: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
-000150e0: 2d41 2034 207b 6e61 6d65 7d7c 2073 6564  -A 4 {name}| sed
-000150f0: 202d 6e20 3370 207c 2067 7265 7020 2250   -n 3p | grep "P
-00015100: 454e 4449 4e47 2227 2c0a 2020 2020 2020  ENDING"',.      
-00015110: 2020 2020 2020 5f53 504f 545f 4341 4e43        _SPOT_CANC
-00015120: 454c 5f57 4149 542e 666f 726d 6174 286a  EL_WAIT.format(j
-00015130: 6f62 5f6e 616d 653d 6627 7b6e 616d 657d  ob_name=f'{name}
-00015140: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
-00015150: 2773 6c65 6570 2035 272c 0a20 2020 2020  'sleep 5',.     
-00015160: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
-00015170: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
-00015180: 7020 2d41 2034 207b 6e61 6d65 7d7c 2073  p -A 4 {name}| s
-00015190: 6564 202d 6e20 3270 207c 2067 7265 7020  ed -n 2p | grep 
-000151a0: 2243 414e 4345 4c4c 494e 475c 7c43 414e  "CANCELLING\|CAN
-000151b0: 4345 4c4c 4544 2227 2c0a 2020 2020 2020  CELLED"',.      
-000151c0: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
-000151d0: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
-000151e0: 202d 4120 3420 7b6e 616d 657d 7c20 7365   -A 4 {name}| se
-000151f0: 6420 2d6e 2033 7020 7c20 6772 6570 2022  d -n 3p | grep "
-00015200: 4341 4e43 454c 4c49 4e47 5c7c 4341 4e43  CANCELLING\|CANC
-00015210: 454c 4c45 4422 272c 0a20 2020 2020 2020  ELLED"',.       
-00015220: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
-00015230: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
-00015240: 2d41 2034 207b 6e61 6d65 7d7c 2073 6564  -A 4 {name}| sed
-00015250: 202d 6e20 3470 207c 2067 7265 7020 2243   -n 4p | grep "C
-00015260: 414e 4345 4c4c 494e 475c 7c43 414e 4345  ANCELLING\|CANCE
-00015270: 4c4c 4544 2227 2c0a 2020 2020 2020 2020  LLED"',.        
-00015280: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
-00015290: 5545 5f57 4149 547d 7c20 6772 6570 202d  UE_WAIT}| grep -
-000152a0: 4120 3420 7b6e 616d 657d 7c20 7365 6420  A 4 {name}| sed 
-000152b0: 2d6e 2035 7020 7c20 6772 6570 2022 4341  -n 5p | grep "CA
-000152c0: 4e43 454c 4c49 4e47 5c7c 4341 4e43 454c  NCELLING\|CANCEL
-000152d0: 4c45 4422 272c 0a20 2020 2020 2020 2020  LED"',.         
-000152e0: 2020 2027 736c 6565 7020 3230 3027 2c0a     'sleep 200',.
-000152f0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-00015300: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
-00015310: 7c20 6772 6570 202d 4120 3420 7b6e 616d  | grep -A 4 {nam
-00015320: 657d 7c20 7365 6420 2d6e 2032 7020 7c20  e}| sed -n 2p | 
-00015330: 6772 6570 2022 4341 4e43 454c 4c45 4422  grep "CANCELLED"
-00015340: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00015350: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
-00015360: 4954 7d7c 2067 7265 7020 2d41 2034 207b  IT}| grep -A 4 {
-00015370: 6e61 6d65 7d7c 2073 6564 202d 6e20 3370  name}| sed -n 3p
-00015380: 207c 2067 7265 7020 2243 414e 4345 4c4c   | grep "CANCELL
-00015390: 4544 2227 2c0a 2020 2020 2020 2020 2020  ED"',.          
-000153a0: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
-000153b0: 5f57 4149 547d 7c20 6772 6570 202d 4120  _WAIT}| grep -A 
-000153c0: 3420 7b6e 616d 657d 7c20 7365 6420 2d6e  4 {name}| sed -n
-000153d0: 2034 7020 7c20 6772 6570 2022 4341 4e43   4p | grep "CANC
-000153e0: 454c 4c45 4422 272c 0a20 2020 2020 2020  ELLED"',.       
-000153f0: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
-00015400: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
-00015410: 2d41 2034 207b 6e61 6d65 7d7c 2073 6564  -A 4 {name}| sed
-00015420: 202d 6e20 3570 207c 2067 7265 7020 2243   -n 5p | grep "C
-00015430: 414e 4345 4c4c 4544 2227 2c0a 2020 2020  ANCELLED"',.    
-00015440: 2020 2020 5d2c 0a20 2020 2020 2020 205f      ],.        _
-00015450: 5350 4f54 5f43 414e 4345 4c5f 5741 4954  SPOT_CANCEL_WAIT
-00015460: 2e66 6f72 6d61 7428 6a6f 625f 6e61 6d65  .format(job_name
-00015470: 3d66 277b 6e61 6d65 7d27 292c 0a20 2020  =f'{name}'),.   
-00015480: 2020 2020 2023 2049 6e63 7265 6173 6520       # Increase 
-00015490: 7469 6d65 6f75 7420 7369 6e63 6520 736b  timeout since sk
-000154a0: 7920 7370 6f74 2071 7565 7565 202d 7220  y spot queue -r 
-000154b0: 6361 6e20 6265 2062 6c6f 636b 6564 2062  can be blocked b
-000154c0: 7920 6f74 6865 7220 7370 6f74 2074 6573  y other spot tes
-000154d0: 7473 2e0a 2020 2020 2020 2020 7469 6d65  ts..        time
-000154e0: 6f75 743d 3330 202a 2036 302c 0a20 2020  out=30 * 60,.   
-000154f0: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-00015500: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
-00015510: 6573 742e 6d61 726b 2e6e 6f5f 666c 7569  est.mark.no_flui
-00015520: 6473 7461 636b 2020 2366 6c75 6964 7374  dstack  #fluidst
-00015530: 6163 6b20 646f 6573 206e 6f74 2073 7570  ack does not sup
-00015540: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
-00015550: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
-00015560: 2e6e 6f5f 617a 7572 6520 2023 2041 7a75  .no_azure  # Azu
-00015570: 7265 2064 6f65 7320 6e6f 7420 7375 7070  re does not supp
-00015580: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
-00015590: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
-000155a0: 6e6f 5f6c 616d 6264 615f 636c 6f75 6420  no_lambda_cloud 
-000155b0: 2023 204c 616d 6264 6120 436c 6f75 6420   # Lambda Cloud 
-000155c0: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
-000155d0: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
-000155e0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-000155f0: 6962 6d20 2023 2049 424d 2043 6c6f 7564  ibm  # IBM Cloud
-00015600: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-00015610: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
-00015620: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-00015630: 5f73 6370 2020 2320 5343 5020 646f 6573  _scp  # SCP does
-00015640: 206e 6f74 2073 7570 706f 7274 2073 706f   not support spo
-00015650: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
-00015660: 6573 742e 6d61 726b 2e6e 6f5f 6b75 6265  est.mark.no_kube
-00015670: 726e 6574 6573 2020 2320 4b75 6265 726e  rnetes  # Kubern
-00015680: 6574 6573 2064 6f65 7320 6e6f 7420 6861  etes does not ha
-00015690: 7665 2061 206e 6f74 696f 6e20 6f66 2073  ve a notion of s
-000156a0: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
-000156b0: 7974 6573 742e 6d61 726b 2e6d 616e 6167  ytest.mark.manag
-000156c0: 6564 5f73 706f 740a 6465 6620 7465 7374  ed_spot.def test
-000156d0: 5f73 706f 745f 6661 696c 6564 5f73 6574  _spot_failed_set
-000156e0: 7570 2867 656e 6572 6963 5f63 6c6f 7564  up(generic_cloud
-000156f0: 3a20 7374 7229 3a0a 2020 2020 2222 2254  : str):.    """T
-00015700: 6573 7420 6d61 6e61 6765 6420 7370 6f74  est managed spot
-00015710: 206a 6f62 2077 6974 6820 6661 696c 6564   job with failed
-00015720: 2073 6574 7570 2e22 2222 0a20 2020 206e   setup.""".    n
-00015730: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-00015740: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
-00015750: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-00015760: 2020 2027 7370 6f74 5f66 6169 6c65 645f     'spot_failed_
-00015770: 7365 7475 7027 2c0a 2020 2020 2020 2020  setup',.        
-00015780: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
-00015790: 736b 7920 7370 6f74 206c 6175 6e63 6820  sky spot launch 
-000157a0: 2d6e 207b 6e61 6d65 7d20 2d2d 636c 6f75  -n {name} --clou
-000157b0: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
-000157c0: 7d20 2d79 202d 6420 7465 7374 732f 7465  } -y -d tests/te
-000157d0: 7374 5f79 616d 6c73 2f66 6169 6c65 645f  st_yamls/failed_
-000157e0: 7365 7475 702e 7961 6d6c 272c 0a20 2020  setup.yaml',.   
-000157f0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-00015800: 3333 3027 2c0a 2020 2020 2020 2020 2020  330',.          
-00015810: 2020 2320 4d61 6b65 2073 7572 6520 7468    # Make sure th
-00015820: 6520 6a6f 6220 6661 696c 6564 2071 7569  e job failed qui
-00015830: 636b 6c79 2e0a 2020 2020 2020 2020 2020  ckly..          
-00015840: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
-00015850: 5f57 4149 547d 207c 2067 7265 7020 7b6e  _WAIT} | grep {n
-00015860: 616d 657d 207c 2068 6561 6420 2d6e 3120  ame} | head -n1 
-00015870: 7c20 6772 6570 2022 4641 494c 4544 5f53  | grep "FAILED_S
-00015880: 4554 5550 2227 2c0a 2020 2020 2020 2020  ETUP"',.        
-00015890: 5d2c 0a20 2020 2020 2020 205f 5350 4f54  ],.        _SPOT
-000158a0: 5f43 414e 4345 4c5f 5741 4954 2e66 6f72  _CANCEL_WAIT.for
-000158b0: 6d61 7428 6a6f 625f 6e61 6d65 3d6e 616d  mat(job_name=nam
-000158c0: 6529 2c0a 2020 2020 2020 2020 2320 496e  e),.        # In
-000158d0: 6372 6561 7365 2074 696d 656f 7574 2073  crease timeout s
-000158e0: 696e 6365 2073 6b79 2073 706f 7420 7175  ince sky spot qu
-000158f0: 6575 6520 2d72 2063 616e 2062 6520 626c  eue -r can be bl
-00015900: 6f63 6b65 6420 6279 206f 7468 6572 2073  ocked by other s
-00015910: 706f 7420 7465 7374 732e 0a20 2020 2020  pot tests..     
-00015920: 2020 2074 696d 656f 7574 3d32 3020 2a20     timeout=20 * 
-00015930: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
-00015940: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-00015950: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-00015960: 6e6f 5f66 6c75 6964 7374 6163 6b20 2023  no_fluidstack  #
-00015970: 666c 7569 6473 7461 636b 2064 6f65 7320  fluidstack does 
-00015980: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
-00015990: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
-000159a0: 7374 2e6d 6172 6b2e 6e6f 5f61 7a75 7265  st.mark.no_azure
-000159b0: 2020 2320 417a 7572 6520 646f 6573 206e    # Azure does n
-000159c0: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
-000159d0: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
-000159e0: 742e 6d61 726b 2e6e 6f5f 6c61 6d62 6461  t.mark.no_lambda
-000159f0: 5f63 6c6f 7564 2020 2320 4c61 6d62 6461  _cloud  # Lambda
-00015a00: 2043 6c6f 7564 2064 6f65 7320 6e6f 7420   Cloud does not 
-00015a10: 7375 7070 6f72 7420 7370 6f74 2069 6e73  support spot ins
-00015a20: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
-00015a30: 6172 6b2e 6e6f 5f69 626d 2020 2320 4942  ark.no_ibm  # IB
-00015a40: 4d20 436c 6f75 6420 646f 6573 206e 6f74  M Cloud does not
-00015a50: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
-00015a60: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
-00015a70: 6d61 726b 2e6e 6f5f 7363 7020 2023 2053  mark.no_scp  # S
-00015a80: 4350 2064 6f65 7320 6e6f 7420 7375 7070  CP does not supp
-00015a90: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
-00015aa0: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
-00015ab0: 6e6f 5f6b 7562 6572 6e65 7465 7320 2023  no_kubernetes  #
-00015ac0: 204b 7562 6572 6e65 7465 7320 646f 6573   Kubernetes does
-00015ad0: 206e 6f74 2068 6176 6520 6120 6e6f 7469   not have a noti
-00015ae0: 6f6e 206f 6620 7370 6f74 2069 6e73 7461  on of spot insta
-00015af0: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
-00015b00: 6b2e 6d61 6e61 6765 645f 7370 6f74 0a64  k.managed_spot.d
-00015b10: 6566 2074 6573 745f 7370 6f74 5f70 6970  ef test_spot_pip
-00015b20: 656c 696e 655f 6661 696c 6564 5f73 6574  eline_failed_set
-00015b30: 7570 2867 656e 6572 6963 5f63 6c6f 7564  up(generic_cloud
-00015b40: 3a20 7374 7229 3a0a 2020 2020 2222 2254  : str):.    """T
-00015b50: 6573 7420 6d61 6e61 6765 6420 7370 6f74  est managed spot
-00015b60: 206a 6f62 2077 6974 6820 6661 696c 6564   job with failed
-00015b70: 2073 6574 7570 2066 6f72 2061 2070 6970   setup for a pip
-00015b80: 656c 696e 652e 2222 220a 2020 2020 6e61  eline.""".    na
-00015b90: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
-00015ba0: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
-00015bb0: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
-00015bc0: 2020 2773 706f 745f 7069 7065 6c69 6e65    'spot_pipeline
-00015bd0: 5f66 6169 6c65 645f 7365 7475 7027 2c0a  _failed_setup',.
-00015be0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-00015bf0: 2020 2020 2020 6627 736b 7920 7370 6f74        f'sky spot
-00015c00: 206c 6175 6e63 6820 2d6e 207b 6e61 6d65   launch -n {name
-00015c10: 7d20 2d79 202d 6420 7465 7374 732f 7465  } -y -d tests/te
-00015c20: 7374 5f79 616d 6c73 2f66 6169 6c65 645f  st_yamls/failed_
-00015c30: 7365 7475 705f 7069 7065 6c69 6e65 2e79  setup_pipeline.y
-00015c40: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-00015c50: 2020 2773 6c65 6570 2038 3030 272c 0a20    'sleep 800',. 
-00015c60: 2020 2020 2020 2020 2020 2023 204d 616b             # Mak
-00015c70: 6520 7375 7265 2074 6865 206a 6f62 2066  e sure the job f
-00015c80: 6169 6c65 6420 7175 6963 6b6c 792e 0a20  ailed quickly.. 
-00015c90: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-00015ca0: 504f 545f 5155 4555 455f 5741 4954 7d20  POT_QUEUE_WAIT} 
-00015cb0: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
-00015cc0: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
-00015cd0: 2246 4149 4c45 445f 5345 5455 5022 272c  "FAILED_SETUP"',
-00015ce0: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-00015cf0: 6173 6b20 3020 7368 6f75 6c64 2062 6520  ask 0 should be 
-00015d00: 5355 4343 4545 4445 442e 0a20 2020 2020  SUCCEEDED..     
-00015d10: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
-00015d20: 5155 4555 455f 5741 4954 7d20 7c20 6772  QUEUE_WAIT} | gr
-00015d30: 6570 202d 4120 3420 7b6e 616d 657d 7c20  ep -A 4 {name}| 
-00015d40: 7365 6420 2d6e 2032 7020 7c20 6772 6570  sed -n 2p | grep
-00015d50: 2022 5355 4343 4545 4445 4422 272c 0a20   "SUCCEEDED"',. 
-00015d60: 2020 2020 2020 2020 2020 2023 2054 6173             # Tas
-00015d70: 6b20 3120 7368 6f75 6c64 2062 6520 4641  k 1 should be FA
-00015d80: 494c 4544 5f53 4554 5550 2e0a 2020 2020  ILED_SETUP..    
-00015d90: 2020 2020 2020 2020 6627 7b5f 5350 4f54          f'{_SPOT
-00015da0: 5f51 5545 5545 5f57 4149 547d 207c 2067  _QUEUE_WAIT} | g
-00015db0: 7265 7020 2d41 2034 207b 6e61 6d65 7d7c  rep -A 4 {name}|
-00015dc0: 2073 6564 202d 6e20 3370 207c 2067 7265   sed -n 3p | gre
-00015dd0: 7020 2246 4149 4c45 445f 5345 5455 5022  p "FAILED_SETUP"
-00015de0: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
-00015df0: 2054 6173 6b20 3220 7368 6f75 6c64 2062   Task 2 should b
-00015e00: 6520 4341 4e43 454c 4c45 442e 0a20 2020  e CANCELLED..   
-00015e10: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
-00015e20: 545f 5155 4555 455f 5741 4954 7d20 7c20  T_QUEUE_WAIT} | 
-00015e30: 6772 6570 202d 4120 3420 7b6e 616d 657d  grep -A 4 {name}
-00015e40: 7c20 7365 6420 2d6e 2034 7020 7c20 6772  | sed -n 4p | gr
-00015e50: 6570 2022 4341 4e43 454c 4c45 4422 272c  ep "CANCELLED"',
-00015e60: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-00015e70: 6173 6b20 3320 7368 6f75 6c64 2062 6520  ask 3 should be 
-00015e80: 4341 4e43 454c 4c45 442e 0a20 2020 2020  CANCELLED..     
-00015e90: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
-00015ea0: 5155 4555 455f 5741 4954 7d20 7c20 6772  QUEUE_WAIT} | gr
-00015eb0: 6570 202d 4120 3420 7b6e 616d 657d 7c20  ep -A 4 {name}| 
-00015ec0: 7365 6420 2d6e 2035 7020 7c20 6772 6570  sed -n 5p | grep
-00015ed0: 2022 4341 4e43 454c 4c45 4422 272c 0a20   "CANCELLED"',. 
-00015ee0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-00015ef0: 2020 5f53 504f 545f 4341 4e43 454c 5f57    _SPOT_CANCEL_W
-00015f00: 4149 542e 666f 726d 6174 286a 6f62 5f6e  AIT.format(job_n
-00015f10: 616d 653d 6e61 6d65 292c 0a20 2020 2020  ame=name),.     
-00015f20: 2020 2023 2049 6e63 7265 6173 6520 7469     # Increase ti
-00015f30: 6d65 6f75 7420 7369 6e63 6520 736b 7920  meout since sky 
-00015f40: 7370 6f74 2071 7565 7565 202d 7220 6361  spot queue -r ca
-00015f50: 6e20 6265 2062 6c6f 636b 6564 2062 7920  n be blocked by 
-00015f60: 6f74 6865 7220 7370 6f74 2074 6573 7473  other spot tests
-00015f70: 2e0a 2020 2020 2020 2020 7469 6d65 6f75  ..        timeou
-00015f80: 743d 3330 202a 2036 302c 0a20 2020 2029  t=30 * 60,.    )
-00015f90: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-00015fa0: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
-00015fb0: 2d2d 2d2d 2d2d 2054 6573 7469 6e67 206d  ------ Testing m
-00015fc0: 616e 6167 6564 2073 706f 7420 7265 636f  anaged spot reco
-00015fd0: 7665 7279 202d 2d2d 2d2d 2d2d 2d2d 2d0a  very ----------.
-00015fe0: 0a0a 4070 7974 6573 742e 6d61 726b 2e61  ..@pytest.mark.a
-00015ff0: 7773 0a40 7079 7465 7374 2e6d 6172 6b2e  ws.@pytest.mark.
-00016000: 6d61 6e61 6765 645f 7370 6f74 0a64 6566  managed_spot.def
-00016010: 2074 6573 745f 7370 6f74 5f72 6563 6f76   test_spot_recov
-00016020: 6572 795f 6177 7328 6177 735f 636f 6e66  ery_aws(aws_conf
-00016030: 6967 5f72 6567 696f 6e29 3a0a 2020 2020  ig_region):.    
-00016040: 2222 2254 6573 7420 6d61 6e61 6765 6420  """Test managed 
-00016050: 7370 6f74 2072 6563 6f76 6572 792e 2222  spot recovery.""
-00016060: 220a 2020 2020 6e61 6d65 203d 205f 6765  ".    name = _ge
-00016070: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
-00016080: 0a20 2020 206e 616d 655f 6f6e 5f63 6c6f  .    name_on_clo
-00016090: 7564 203d 2063 6f6d 6d6f 6e5f 7574 696c  ud = common_util
-000160a0: 732e 6d61 6b65 5f63 6c75 7374 6572 5f6e  s.make_cluster_n
-000160b0: 616d 655f 6f6e 5f63 6c6f 7564 280a 2020  ame_on_cloud(.  
-000160c0: 2020 2020 2020 6e61 6d65 2c20 7370 6f74        name, spot
-000160d0: 2e53 504f 545f 434c 5553 5445 525f 4e41  .SPOT_CLUSTER_NA
-000160e0: 4d45 5f50 5245 4649 585f 4c45 4e47 5448  ME_PREFIX_LENGTH
-000160f0: 2c20 6164 645f 7573 6572 5f68 6173 683d  , add_user_hash=
-00016100: 4661 6c73 6529 0a20 2020 2072 6567 696f  False).    regio
-00016110: 6e20 3d20 6177 735f 636f 6e66 6967 5f72  n = aws_config_r
-00016120: 6567 696f 6e0a 2020 2020 7465 7374 203d  egion.    test =
-00016130: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-00016140: 7370 6f74 5f72 6563 6f76 6572 795f 6177  spot_recovery_aw
-00016150: 7327 2c0a 2020 2020 2020 2020 5b0a 2020  s',.        [.  
-00016160: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-00016170: 7370 6f74 206c 6175 6e63 6820 2d2d 636c  spot launch --cl
-00016180: 6f75 6420 6177 7320 2d2d 7265 6769 6f6e  oud aws --region
-00016190: 207b 7265 6769 6f6e 7d20 2d6e 207b 6e61   {region} -n {na
-000161a0: 6d65 7d20 2265 6368 6f20 534b 5950 494c  me} "echo SKYPIL
-000161b0: 4f54 5f54 4153 4b5f 4944 3a20 5c24 534b  OT_TASK_ID: \$SK
-000161c0: 5950 494c 4f54 5f54 4153 4b5f 4944 3b20  YPILOT_TASK_ID; 
-000161d0: 736c 6565 7020 3138 3030 2220 202d 7920  sleep 1800"  -y 
-000161e0: 2d64 272c 0a20 2020 2020 2020 2020 2020  -d',.           
-000161f0: 2027 736c 6565 7020 3336 3027 2c0a 2020   'sleep 360',.  
-00016200: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-00016210: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
-00016220: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
-00016230: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
-00016240: 554e 4e49 4e47 2227 2c0a 2020 2020 2020  UNNING"',.      
-00016250: 2020 2020 2020 6627 5255 4e5f 4944 3d24        f'RUN_ID=$
-00016260: 2873 6b79 2073 706f 7420 6c6f 6773 202d  (sky spot logs -
-00016270: 6e20 7b6e 616d 657d 202d 2d6e 6f2d 666f  n {name} --no-fo
-00016280: 6c6c 6f77 207c 2067 7265 7020 534b 5950  llow | grep SKYP
-00016290: 494c 4f54 5f54 4153 4b5f 4944 207c 2063  ILOT_TASK_ID | c
-000162a0: 7574 202d 643a 202d 6632 293b 2065 6368  ut -d: -f2); ech
-000162b0: 6f20 2224 5255 4e5f 4944 2220 7c20 7465  o "$RUN_ID" | te
-000162c0: 6520 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  e /tmp/{name}-ru
-000162d0: 6e2d 6964 272c 0a20 2020 2020 2020 2020  n-id',.         
-000162e0: 2020 2023 2054 6572 6d69 6e61 7465 2074     # Terminate t
-000162f0: 6865 2063 6c75 7374 6572 206d 616e 7561  he cluster manua
-00016300: 6c6c 792e 0a20 2020 2020 2020 2020 2020  lly..           
-00016310: 2028 6627 6177 7320 6563 3220 7465 726d   (f'aws ec2 term
-00016320: 696e 6174 652d 696e 7374 616e 6365 7320  inate-instances 
-00016330: 2d2d 7265 6769 6f6e 207b 7265 6769 6f6e  --region {region
-00016340: 7d20 2d2d 696e 7374 616e 6365 2d69 6473  } --instance-ids
-00016350: 2024 2827 0a20 2020 2020 2020 2020 2020   $('.           
-00016360: 2020 6627 6177 7320 6563 3220 6465 7363    f'aws ec2 desc
-00016370: 7269 6265 2d69 6e73 7461 6e63 6573 202d  ribe-instances -
-00016380: 2d72 6567 696f 6e20 7b72 6567 696f 6e7d  -region {region}
-00016390: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-000163a0: 6627 2d2d 6669 6c74 6572 7320 4e61 6d65  f'--filters Name
-000163b0: 3d74 6167 3a72 6179 2d63 6c75 7374 6572  =tag:ray-cluster
-000163c0: 2d6e 616d 652c 5661 6c75 6573 3d7b 6e61  -name,Values={na
-000163d0: 6d65 5f6f 6e5f 636c 6f75 647d 2a20 270a  me_on_cloud}* '.
-000163e0: 2020 2020 2020 2020 2020 2020 2066 272d               f'-
-000163f0: 2d71 7565 7279 2052 6573 6572 7661 7469  -query Reservati
-00016400: 6f6e 735b 5d2e 496e 7374 616e 6365 735b  ons[].Instances[
-00016410: 5d2e 496e 7374 616e 6365 4964 2027 0a20  ].InstanceId '. 
-00016420: 2020 2020 2020 2020 2020 2020 272d 2d6f              '--o
-00016430: 7574 7075 7420 7465 7874 2927 292c 0a20  utput text)'),. 
-00016440: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-00016450: 7020 3130 3027 2c0a 2020 2020 2020 2020  p 100',.        
-00016460: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
-00016470: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
-00016480: 6e61 6d65 7d20 7c20 6865 6164 202d 6e31  name} | head -n1
-00016490: 207c 2067 7265 7020 2252 4543 4f56 4552   | grep "RECOVER
-000164a0: 494e 4722 272c 0a20 2020 2020 2020 2020  ING"',.         
-000164b0: 2020 2027 736c 6565 7020 3230 3027 2c0a     'sleep 200',.
-000164c0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-000164d0: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
-000164e0: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
-000164f0: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
-00016500: 2252 554e 4e49 4e47 2227 2c0a 2020 2020  "RUNNING"',.    
-00016510: 2020 2020 2020 2020 6627 5255 4e5f 4944          f'RUN_ID
-00016520: 3d24 2863 6174 202f 746d 702f 7b6e 616d  =$(cat /tmp/{nam
-00016530: 657d 2d72 756e 2d69 6429 3b20 6563 686f  e}-run-id); echo
-00016540: 2024 5255 4e5f 4944 3b20 736b 7920 7370   $RUN_ID; sky sp
-00016550: 6f74 206c 6f67 7320 2d6e 207b 6e61 6d65  ot logs -n {name
-00016560: 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20  } --no-follow | 
-00016570: 6772 6570 2053 4b59 5049 4c4f 545f 5441  grep SKYPILOT_TA
-00016580: 534b 5f49 4420 7c20 6772 6570 2022 2452  SK_ID | grep "$R
-00016590: 554e 5f49 4422 272c 0a20 2020 2020 2020  UN_ID"',.       
-000165a0: 205d 2c0a 2020 2020 2020 2020 5f53 504f   ],.        _SPO
-000165b0: 545f 4341 4e43 454c 5f57 4149 542e 666f  T_CANCEL_WAIT.fo
-000165c0: 726d 6174 286a 6f62 5f6e 616d 653d 6e61  rmat(job_name=na
-000165d0: 6d65 292c 0a20 2020 2020 2020 2074 696d  me),.        tim
-000165e0: 656f 7574 3d32 3520 2a20 3630 2c0a 2020  eout=25 * 60,.  
-000165f0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
-00016600: 7465 7374 2874 6573 7429 0a0a 0a40 7079  test(test)...@py
-00016610: 7465 7374 2e6d 6172 6b2e 6763 700a 4070  test.mark.gcp.@p
-00016620: 7974 6573 742e 6d61 726b 2e6d 616e 6167  ytest.mark.manag
-00016630: 6564 5f73 706f 740a 6465 6620 7465 7374  ed_spot.def test
-00016640: 5f73 706f 745f 7265 636f 7665 7279 5f67  _spot_recovery_g
-00016650: 6370 2829 3a0a 2020 2020 2222 2254 6573  cp():.    """Tes
-00016660: 7420 6d61 6e61 6765 6420 7370 6f74 2072  t managed spot r
-00016670: 6563 6f76 6572 792e 2222 220a 2020 2020  ecovery.""".    
-00016680: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-00016690: 7465 725f 6e61 6d65 2829 0a20 2020 206e  ter_name().    n
-000166a0: 616d 655f 6f6e 5f63 6c6f 7564 203d 2063  ame_on_cloud = c
-000166b0: 6f6d 6d6f 6e5f 7574 696c 732e 6d61 6b65  ommon_utils.make
-000166c0: 5f63 6c75 7374 6572 5f6e 616d 655f 6f6e  _cluster_name_on
-000166d0: 5f63 6c6f 7564 280a 2020 2020 2020 2020  _cloud(.        
-000166e0: 6e61 6d65 2c20 7370 6f74 2e53 504f 545f  name, spot.SPOT_
-000166f0: 434c 5553 5445 525f 4e41 4d45 5f50 5245  CLUSTER_NAME_PRE
-00016700: 4649 585f 4c45 4e47 5448 2c20 6164 645f  FIX_LENGTH, add_
-00016710: 7573 6572 5f68 6173 683d 4661 6c73 6529  user_hash=False)
-00016720: 0a20 2020 207a 6f6e 6520 3d20 2775 732d  .    zone = 'us-
-00016730: 6561 7374 342d 6227 0a20 2020 2071 7565  east4-b'.    que
-00016740: 7279 5f63 6d64 203d 2028 0a20 2020 2020  ry_cmd = (.     
-00016750: 2020 2066 2767 636c 6f75 6420 636f 6d70     f'gcloud comp
-00016760: 7574 6520 696e 7374 616e 6365 7320 6c69  ute instances li
-00016770: 7374 202d 2d66 696c 7465 723d 270a 2020  st --filter='.  
-00016780: 2020 2020 2020 2320 603a 6020 6d65 616e        # `:` mean
-00016790: 7320 7072 6566 6978 206d 6174 6368 2e0a  s prefix match..
-000167a0: 2020 2020 2020 2020 6627 2228 6c61 6265          f'"(labe
-000167b0: 6c73 2e72 6179 2d63 6c75 7374 6572 2d6e  ls.ray-cluster-n
-000167c0: 616d 653a 7b6e 616d 655f 6f6e 5f63 6c6f  ame:{name_on_clo
-000167d0: 7564 7d29 2220 270a 2020 2020 2020 2020  ud})" '.        
-000167e0: 6627 2d2d 7a6f 6e65 733d 7b7a 6f6e 657d  f'--zones={zone}
-000167f0: 202d 2d66 6f72 6d61 743d 2276 616c 7565   --format="value
-00016800: 286e 616d 6529 2227 290a 2020 2020 7465  (name)"').    te
-00016810: 726d 696e 6174 655f 636d 6420 3d20 2866  rminate_cmd = (f
-00016820: 2767 636c 6f75 6420 636f 6d70 7574 6520  'gcloud compute 
-00016830: 696e 7374 616e 6365 7320 6465 6c65 7465  instances delete
-00016840: 202d 2d7a 6f6e 653d 7b7a 6f6e 657d 270a   --zone={zone}'.
-00016850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016860: 2020 2020 2066 2720 2d2d 7175 6965 7420       f' --quiet 
-00016870: 2428 7b71 7565 7279 5f63 6d64 7d29 2729  $({query_cmd})')
-00016880: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-00016890: 280a 2020 2020 2020 2020 2773 706f 745f  (.        'spot_
-000168a0: 7265 636f 7665 7279 5f67 6370 272c 0a20  recovery_gcp',. 
-000168b0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-000168c0: 2020 2020 2066 2773 6b79 2073 706f 7420       f'sky spot 
-000168d0: 6c61 756e 6368 202d 2d63 6c6f 7564 2067  launch --cloud g
-000168e0: 6370 202d 2d7a 6f6e 6520 7b7a 6f6e 657d  cp --zone {zone}
-000168f0: 202d 6e20 7b6e 616d 657d 202d 2d63 7075   -n {name} --cpu
-00016900: 7320 3220 2265 6368 6f20 534b 5950 494c  s 2 "echo SKYPIL
-00016910: 4f54 5f54 4153 4b5f 4944 3a20 5c24 534b  OT_TASK_ID: \$SK
-00016920: 5950 494c 4f54 5f54 4153 4b5f 4944 3b20  YPILOT_TASK_ID; 
-00016930: 736c 6565 7020 3138 3030 2220 202d 7920  sleep 1800"  -y 
-00016940: 2d64 272c 0a20 2020 2020 2020 2020 2020  -d',.           
-00016950: 2027 736c 6565 7020 3336 3027 2c0a 2020   'sleep 360',.  
-00016960: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-00016970: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
-00016980: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
-00016990: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
-000169a0: 554e 4e49 4e47 2227 2c0a 2020 2020 2020  UNNING"',.      
-000169b0: 2020 2020 2020 6627 5255 4e5f 4944 3d24        f'RUN_ID=$
-000169c0: 2873 6b79 2073 706f 7420 6c6f 6773 202d  (sky spot logs -
-000169d0: 6e20 7b6e 616d 657d 202d 2d6e 6f2d 666f  n {name} --no-fo
-000169e0: 6c6c 6f77 207c 2067 7265 7020 534b 5950  llow | grep SKYP
-000169f0: 494c 4f54 5f54 4153 4b5f 4944 207c 2063  ILOT_TASK_ID | c
-00016a00: 7574 202d 643a 202d 6632 293b 2065 6368  ut -d: -f2); ech
-00016a10: 6f20 2224 5255 4e5f 4944 2220 7c20 7465  o "$RUN_ID" | te
-00016a20: 6520 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  e /tmp/{name}-ru
-00016a30: 6e2d 6964 272c 0a20 2020 2020 2020 2020  n-id',.         
-00016a40: 2020 2023 2054 6572 6d69 6e61 7465 2074     # Terminate t
-00016a50: 6865 2063 6c75 7374 6572 206d 616e 7561  he cluster manua
-00016a60: 6c6c 792e 0a20 2020 2020 2020 2020 2020  lly..           
-00016a70: 2074 6572 6d69 6e61 7465 5f63 6d64 2c0a   terminate_cmd,.
-00016a80: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-00016a90: 6570 2036 3027 2c0a 2020 2020 2020 2020  ep 60',.        
-00016aa0: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
-00016ab0: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
-00016ac0: 6e61 6d65 7d20 7c20 6865 6164 202d 6e31  name} | head -n1
-00016ad0: 207c 2067 7265 7020 2252 4543 4f56 4552   | grep "RECOVER
-00016ae0: 494e 4722 272c 0a20 2020 2020 2020 2020  ING"',.         
-00016af0: 2020 2027 736c 6565 7020 3230 3027 2c0a     'sleep 200',.
-00016b00: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-00016b10: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
-00016b20: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
-00016b30: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
-00016b40: 2252 554e 4e49 4e47 2227 2c0a 2020 2020  "RUNNING"',.    
-00016b50: 2020 2020 2020 2020 6627 5255 4e5f 4944          f'RUN_ID
-00016b60: 3d24 2863 6174 202f 746d 702f 7b6e 616d  =$(cat /tmp/{nam
-00016b70: 657d 2d72 756e 2d69 6429 3b20 6563 686f  e}-run-id); echo
-00016b80: 2024 5255 4e5f 4944 3b20 736b 7920 7370   $RUN_ID; sky sp
-00016b90: 6f74 206c 6f67 7320 2d6e 207b 6e61 6d65  ot logs -n {name
-00016ba0: 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20  } --no-follow | 
-00016bb0: 6772 6570 2053 4b59 5049 4c4f 545f 5441  grep SKYPILOT_TA
-00016bc0: 534b 5f49 443a 207c 2067 7265 7020 2224  SK_ID: | grep "$
-00016bd0: 5255 4e5f 4944 2227 2c0a 2020 2020 2020  RUN_ID"',.      
-00016be0: 2020 5d2c 0a20 2020 2020 2020 205f 5350    ],.        _SP
-00016bf0: 4f54 5f43 414e 4345 4c5f 5741 4954 2e66  OT_CANCEL_WAIT.f
-00016c00: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d6e  ormat(job_name=n
-00016c10: 616d 6529 2c0a 2020 2020 2020 2020 7469  ame),.        ti
-00016c20: 6d65 6f75 743d 3235 202a 2036 302c 0a20  meout=25 * 60,. 
-00016c30: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
-00016c40: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
-00016c50: 7974 6573 742e 6d61 726b 2e61 7773 0a40  ytest.mark.aws.@
-00016c60: 7079 7465 7374 2e6d 6172 6b2e 6d61 6e61  pytest.mark.mana
-00016c70: 6765 645f 7370 6f74 0a64 6566 2074 6573  ged_spot.def tes
-00016c80: 745f 7370 6f74 5f70 6970 656c 696e 655f  t_spot_pipeline_
-00016c90: 7265 636f 7665 7279 5f61 7773 2861 7773  recovery_aws(aws
-00016ca0: 5f63 6f6e 6669 675f 7265 6769 6f6e 293a  _config_region):
-00016cb0: 0a20 2020 2022 2222 5465 7374 206d 616e  .    """Test man
-00016cc0: 6167 6564 2073 706f 7420 7265 636f 7665  aged spot recove
-00016cd0: 7279 2066 6f72 2061 2070 6970 656c 696e  ry for a pipelin
-00016ce0: 652e 2222 220a 2020 2020 6e61 6d65 203d  e.""".    name =
-00016cf0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-00016d00: 6d65 2829 0a20 2020 2075 7365 725f 6861  me().    user_ha
-00016d10: 7368 203d 2063 6f6d 6d6f 6e5f 7574 696c  sh = common_util
-00016d20: 732e 6765 745f 7573 6572 5f68 6173 6828  s.get_user_hash(
-00016d30: 290a 2020 2020 7573 6572 5f68 6173 6820  ).    user_hash 
-00016d40: 3d20 7573 6572 5f68 6173 685b 3a63 6f6d  = user_hash[:com
-00016d50: 6d6f 6e5f 7574 696c 732e 5553 4552 5f48  mon_utils.USER_H
-00016d60: 4153 485f 4c45 4e47 5448 5f49 4e5f 434c  ASH_LENGTH_IN_CL
-00016d70: 5553 5445 525f 4e41 4d45 5d0a 2020 2020  USTER_NAME].    
-00016d80: 7265 6769 6f6e 203d 2061 7773 5f63 6f6e  region = aws_con
-00016d90: 6669 675f 7265 6769 6f6e 0a20 2020 2069  fig_region.    i
-00016da0: 6620 7265 6769 6f6e 2021 3d20 2775 732d  f region != 'us-
-00016db0: 6561 7374 2d32 273a 0a20 2020 2020 2020  east-2':.       
-00016dc0: 2070 7974 6573 742e 736b 6970 2827 4f6e   pytest.skip('On
-00016dd0: 6c79 2072 756e 2073 706f 7420 7069 7065  ly run spot pipe
-00016de0: 6c69 6e65 2072 6563 6f76 6572 7920 7465  line recovery te
-00016df0: 7374 2069 6e20 7573 2d65 6173 742d 3227  st in us-east-2'
-00016e00: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
-00016e10: 7428 0a20 2020 2020 2020 2027 7370 6f74  t(.        'spot
-00016e20: 5f70 6970 656c 696e 655f 7265 636f 7665  _pipeline_recove
-00016e30: 7279 5f61 7773 272c 0a20 2020 2020 2020  ry_aws',.       
-00016e40: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-00016e50: 2773 6b79 2073 706f 7420 6c61 756e 6368  'sky spot launch
-00016e60: 202d 6e20 7b6e 616d 657d 2074 6573 7473   -n {name} tests
-00016e70: 2f74 6573 745f 7961 6d6c 732f 7069 7065  /test_yamls/pipe
-00016e80: 6c69 6e65 5f61 7773 2e79 616d 6c20 202d  line_aws.yaml  -
-00016e90: 7920 2d64 272c 0a20 2020 2020 2020 2020  y -d',.         
-00016ea0: 2020 2027 736c 6565 7020 3430 3027 2c0a     'sleep 400',.
-00016eb0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-00016ec0: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
-00016ed0: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
-00016ee0: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
-00016ef0: 2252 554e 4e49 4e47 2227 2c0a 2020 2020  "RUNNING"',.    
-00016f00: 2020 2020 2020 2020 6627 5255 4e5f 4944          f'RUN_ID
-00016f10: 3d24 2873 6b79 2073 706f 7420 6c6f 6773  =$(sky spot logs
-00016f20: 202d 6e20 7b6e 616d 657d 202d 2d6e 6f2d   -n {name} --no-
-00016f30: 666f 6c6c 6f77 207c 2067 7265 7020 534b  follow | grep SK
-00016f40: 5950 494c 4f54 5f54 4153 4b5f 4944 3a20  YPILOT_TASK_ID: 
-00016f50: 7c20 6375 7420 2d64 3a20 2d66 3229 3b20  | cut -d: -f2); 
-00016f60: 6563 686f 2022 2452 554e 5f49 4422 207c  echo "$RUN_ID" |
-00016f70: 2074 6565 202f 746d 702f 7b6e 616d 657d   tee /tmp/{name}
-00016f80: 2d72 756e 2d69 6427 2c0a 2020 2020 2020  -run-id',.      
-00016f90: 2020 2020 2020 6627 5255 4e5f 4944 533d        f'RUN_IDS=
-00016fa0: 2428 736b 7920 7370 6f74 206c 6f67 7320  $(sky spot logs 
-00016fb0: 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f 2d66  -n {name} --no-f
-00016fc0: 6f6c 6c6f 7720 7c20 6772 6570 202d 4120  ollow | grep -A 
-00016fd0: 3420 534b 5950 494c 4f54 5f54 4153 4b5f  4 SKYPILOT_TASK_
-00016fe0: 4944 5320 7c20 6375 7420 2d64 2229 2220  IDS | cut -d")" 
-00016ff0: 2d66 3229 3b20 6563 686f 2022 2452 554e  -f2); echo "$RUN
-00017000: 5f49 4453 2220 7c20 7465 6520 2f74 6d70  _IDS" | tee /tmp
-00017010: 2f7b 6e61 6d65 7d2d 7275 6e2d 6964 7327  /{name}-run-ids'
-00017020: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00017030: 5465 726d 696e 6174 6520 7468 6520 636c  Terminate the cl
-00017040: 7573 7465 7220 6d61 6e75 616c 6c79 2e0a  uster manually..
-00017050: 2020 2020 2020 2020 2020 2020 2320 5468              # Th
-00017060: 6520 6063 6174 202e 2e2e 7c20 7265 7660  e `cat ...| rev`
-00017070: 2069 7320 746f 2072 6574 7269 6576 6520   is to retrieve 
-00017080: 7468 6520 6a6f 625f 6964 2066 726f 6d20  the job_id from 
-00017090: 7468 650a 2020 2020 2020 2020 2020 2020  the.            
-000170a0: 2320 534b 5950 494c 4f54 5f54 4153 4b5f  # SKYPILOT_TASK_
-000170b0: 4944 2c20 7768 6963 6820 6765 7473 2074  ID, which gets t
-000170c0: 6865 2073 6563 6f6e 6420 746f 206c 6173  he second to las
-000170d0: 7420 6669 656c 640a 2020 2020 2020 2020  t field.        
-000170e0: 2020 2020 2320 7365 7061 7261 7465 6420      # separated 
-000170f0: 6279 2060 2d60 2e0a 2020 2020 2020 2020  by `-`..        
-00017100: 2020 2020 280a 2020 2020 2020 2020 2020      (.          
-00017110: 2020 2020 2020 6627 5350 4f54 5f4a 4f42        f'SPOT_JOB
-00017120: 5f49 443d 6063 6174 202f 746d 702f 7b6e  _ID=`cat /tmp/{n
-00017130: 616d 657d 2d72 756e 2d69 6420 7c20 7265  ame}-run-id | re
-00017140: 7620 7c20 270a 2020 2020 2020 2020 2020  v | '.          
-00017150: 2020 2020 2020 2763 7574 202d 645c 272d        'cut -d\'-
-00017160: 5c27 202d 6632 207c 2072 6576 603b 270a  \' -f2 | rev`;'.
-00017170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017180: 6627 6177 7320 6563 3220 7465 726d 696e  f'aws ec2 termin
-00017190: 6174 652d 696e 7374 616e 6365 7320 2d2d  ate-instances --
-000171a0: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
-000171b0: 2d2d 696e 7374 616e 6365 2d69 6473 2024  --instance-ids $
-000171c0: 2827 0a20 2020 2020 2020 2020 2020 2020  ('.             
-000171d0: 2020 2066 2761 7773 2065 6332 2064 6573     f'aws ec2 des
-000171e0: 6372 6962 652d 696e 7374 616e 6365 7320  cribe-instances 
-000171f0: 2d2d 7265 6769 6f6e 207b 7265 6769 6f6e  --region {region
-00017200: 7d20 270a 2020 2020 2020 2020 2020 2020  } '.            
-00017210: 2020 2020 2320 544f 444f 287a 6877 7529      # TODO(zhwu)
-00017220: 3a20 6669 7820 7468 6520 6e61 6d65 2066  : fix the name f
-00017230: 6f72 2073 706f 7420 636c 7573 7465 722e  or spot cluster.
-00017240: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017250: 2027 2d2d 6669 6c74 6572 7320 4e61 6d65   '--filters Name
-00017260: 3d74 6167 3a72 6179 2d63 6c75 7374 6572  =tag:ray-cluster
-00017270: 2d6e 616d 652c 5661 6c75 6573 3d2a 2d24  -name,Values=*-$
-00017280: 7b53 504f 545f 4a4f 425f 4944 7d27 0a20  {SPOT_JOB_ID}'. 
-00017290: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000172a0: 272d 7b75 7365 725f 6861 7368 7d20 270a  '-{user_hash} '.
-000172b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000172c0: 6627 2d2d 7175 6572 7920 5265 7365 7276  f'--query Reserv
-000172d0: 6174 696f 6e73 5b5d 2e49 6e73 7461 6e63  ations[].Instanc
-000172e0: 6573 5b5d 2e49 6e73 7461 6e63 6549 6420  es[].InstanceId 
-000172f0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00017300: 2020 272d 2d6f 7574 7075 7420 7465 7874    '--output text
-00017310: 2927 292c 0a20 2020 2020 2020 2020 2020  )'),.           
-00017320: 2027 736c 6565 7020 3130 3027 2c0a 2020   'sleep 100',.  
-00017330: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-00017340: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
-00017350: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
-00017360: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
-00017370: 4543 4f56 4552 494e 4722 272c 0a20 2020  ECOVERING"',.   
-00017380: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-00017390: 3230 3027 2c0a 2020 2020 2020 2020 2020  200',.          
-000173a0: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
-000173b0: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
-000173c0: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
-000173d0: 2067 7265 7020 2252 554e 4e49 4e47 2227   grep "RUNNING"'
-000173e0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-000173f0: 5255 4e5f 4944 3d24 2863 6174 202f 746d  RUN_ID=$(cat /tm
-00017400: 702f 7b6e 616d 657d 2d72 756e 2d69 6429  p/{name}-run-id)
-00017410: 3b20 6563 686f 2024 5255 4e5f 4944 3b20  ; echo $RUN_ID; 
-00017420: 736b 7920 7370 6f74 206c 6f67 7320 2d6e  sky spot logs -n
-00017430: 207b 6e61 6d65 7d20 2d2d 6e6f 2d66 6f6c   {name} --no-fol
-00017440: 6c6f 7720 7c20 6772 6570 2053 4b59 5049  low | grep SKYPI
-00017450: 4c4f 545f 5441 534b 5f49 443a 207c 2067  LOT_TASK_ID: | g
-00017460: 7265 7020 2224 5255 4e5f 4944 2227 2c0a  rep "$RUN_ID"',.
-00017470: 2020 2020 2020 2020 2020 2020 6627 5255              f'RU
-00017480: 4e5f 4944 533d 2428 736b 7920 7370 6f74  N_IDS=$(sky spot
-00017490: 206c 6f67 7320 2d6e 207b 6e61 6d65 7d20   logs -n {name} 
-000174a0: 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20 6772  --no-follow | gr
-000174b0: 6570 202d 4120 3420 534b 5950 494c 4f54  ep -A 4 SKYPILOT
-000174c0: 5f54 4153 4b5f 4944 5320 7c20 6375 7420  _TASK_IDS | cut 
-000174d0: 2d64 2229 2220 2d66 3229 3b20 6563 686f  -d")" -f2); echo
-000174e0: 2022 2452 554e 5f49 4453 2220 7c20 7465   "$RUN_IDS" | te
-000174f0: 6520 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  e /tmp/{name}-ru
-00017500: 6e2d 6964 732d 6e65 7727 2c0a 2020 2020  n-ids-new',.    
-00017510: 2020 2020 2020 2020 6627 6469 6666 202f          f'diff /
-00017520: 746d 702f 7b6e 616d 657d 2d72 756e 2d69  tmp/{name}-run-i
-00017530: 6473 202f 746d 702f 7b6e 616d 657d 2d72  ds /tmp/{name}-r
-00017540: 756e 2d69 6473 2d6e 6577 272c 0a20 2020  un-ids-new',.   
-00017550: 2020 2020 2020 2020 2066 2763 6174 202f           f'cat /
-00017560: 746d 702f 7b6e 616d 657d 2d72 756e 2d69  tmp/{name}-run-i
-00017570: 6473 207c 2073 6564 202d 6e20 3270 207c  ds | sed -n 2p |
-00017580: 2067 7265 7020 6063 6174 202f 746d 702f   grep `cat /tmp/
-00017590: 7b6e 616d 657d 2d72 756e 2d69 6460 272c  {name}-run-id`',
-000175a0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-000175b0: 2020 2020 5f53 504f 545f 4341 4e43 454c      _SPOT_CANCEL
-000175c0: 5f57 4149 542e 666f 726d 6174 286a 6f62  _WAIT.format(job
-000175d0: 5f6e 616d 653d 6e61 6d65 292c 0a20 2020  _name=name),.   
-000175e0: 2020 2020 2074 696d 656f 7574 3d32 3520       timeout=25 
-000175f0: 2a20 3630 2c0a 2020 2020 290a 2020 2020  * 60,.    ).    
-00017600: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-00017610: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
-00017620: 6b2e 6763 700a 4070 7974 6573 742e 6d61  k.gcp.@pytest.ma
-00017630: 726b 2e6d 616e 6167 6564 5f73 706f 740a  rk.managed_spot.
-00017640: 6465 6620 7465 7374 5f73 706f 745f 7069  def test_spot_pi
-00017650: 7065 6c69 6e65 5f72 6563 6f76 6572 795f  peline_recovery_
-00017660: 6763 7028 293a 0a20 2020 2022 2222 5465  gcp():.    """Te
-00017670: 7374 206d 616e 6167 6564 2073 706f 7420  st managed spot 
-00017680: 7265 636f 7665 7279 2066 6f72 2061 2070  recovery for a p
-00017690: 6970 656c 696e 652e 2222 220a 2020 2020  ipeline.""".    
-000176a0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-000176b0: 7465 725f 6e61 6d65 2829 0a20 2020 207a  ter_name().    z
-000176c0: 6f6e 6520 3d20 2775 732d 6561 7374 342d  one = 'us-east4-
-000176d0: 6227 0a20 2020 2075 7365 725f 6861 7368  b'.    user_hash
-000176e0: 203d 2063 6f6d 6d6f 6e5f 7574 696c 732e   = common_utils.
-000176f0: 6765 745f 7573 6572 5f68 6173 6828 290a  get_user_hash().
-00017700: 2020 2020 7573 6572 5f68 6173 6820 3d20      user_hash = 
-00017710: 7573 6572 5f68 6173 685b 3a63 6f6d 6d6f  user_hash[:commo
-00017720: 6e5f 7574 696c 732e 5553 4552 5f48 4153  n_utils.USER_HAS
-00017730: 485f 4c45 4e47 5448 5f49 4e5f 434c 5553  H_LENGTH_IN_CLUS
-00017740: 5445 525f 4e41 4d45 5d0a 2020 2020 7175  TER_NAME].    qu
-00017750: 6572 795f 636d 6420 3d20 2827 6763 6c6f  ery_cmd = ('gclo
-00017760: 7564 2063 6f6d 7075 7465 2069 6e73 7461  ud compute insta
-00017770: 6e63 6573 206c 6973 7420 2d2d 6669 6c74  nces list --filt
-00017780: 6572 3d27 0a20 2020 2020 2020 2020 2020  er='.           
-00017790: 2020 2020 2020 6627 2228 6c61 6265 6c73        f'"(labels
-000177a0: 2e72 6179 2d63 6c75 7374 6572 2d6e 616d  .ray-cluster-nam
-000177b0: 653a 2a2d 247b 7b53 504f 545f 4a4f 425f  e:*-${{SPOT_JOB_
-000177c0: 4944 7d7d 2d7b 7573 6572 5f68 6173 687d  ID}}-{user_hash}
-000177d0: 2922 2027 0a20 2020 2020 2020 2020 2020  )" '.           
-000177e0: 2020 2020 2020 6627 2d2d 7a6f 6e65 733d        f'--zones=
-000177f0: 7b7a 6f6e 657d 202d 2d66 6f72 6d61 743d  {zone} --format=
-00017800: 2276 616c 7565 286e 616d 6529 2227 290a  "value(name)"').
-00017810: 2020 2020 7465 726d 696e 6174 655f 636d      terminate_cm
-00017820: 6420 3d20 2866 2767 636c 6f75 6420 636f  d = (f'gcloud co
-00017830: 6d70 7574 6520 696e 7374 616e 6365 7320  mpute instances 
-00017840: 6465 6c65 7465 202d 2d7a 6f6e 653d 7b7a  delete --zone={z
-00017850: 6f6e 657d 270a 2020 2020 2020 2020 2020  one}'.          
-00017860: 2020 2020 2020 2020 2020 2066 2720 2d2d             f' --
-00017870: 7175 6965 7420 2428 7b71 7565 7279 5f63  quiet $({query_c
-00017880: 6d64 7d29 2729 0a20 2020 2074 6573 7420  md})').    test 
-00017890: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
-000178a0: 2773 706f 745f 7069 7065 6c69 6e65 5f72  'spot_pipeline_r
-000178b0: 6563 6f76 6572 795f 6763 7027 2c0a 2020  ecovery_gcp',.  
-000178c0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-000178d0: 2020 2020 6627 736b 7920 7370 6f74 206c      f'sky spot l
-000178e0: 6175 6e63 6820 2d6e 207b 6e61 6d65 7d20  aunch -n {name} 
-000178f0: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
-00017900: 2f70 6970 656c 696e 655f 6763 702e 7961  /pipeline_gcp.ya
-00017910: 6d6c 2020 2d79 202d 6427 2c0a 2020 2020  ml  -y -d',.    
-00017920: 2020 2020 2020 2020 2773 6c65 6570 2034          'sleep 4
-00017930: 3030 272c 0a20 2020 2020 2020 2020 2020  00',.           
-00017940: 2066 277b 5f53 504f 545f 5155 4555 455f   f'{_SPOT_QUEUE_
-00017950: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
-00017960: 657d 207c 2068 6561 6420 2d6e 3120 7c20  e} | head -n1 | 
-00017970: 6772 6570 2022 5255 4e4e 494e 4722 272c  grep "RUNNING"',
-00017980: 0a20 2020 2020 2020 2020 2020 2066 2752  .            f'R
-00017990: 554e 5f49 443d 2428 736b 7920 7370 6f74  UN_ID=$(sky spot
-000179a0: 206c 6f67 7320 2d6e 207b 6e61 6d65 7d20   logs -n {name} 
-000179b0: 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20 6772  --no-follow | gr
-000179c0: 6570 2053 4b59 5049 4c4f 545f 5441 534b  ep SKYPILOT_TASK
-000179d0: 5f49 443a 207c 2063 7574 202d 643a 202d  _ID: | cut -d: -
-000179e0: 6632 293b 2065 6368 6f20 2224 5255 4e5f  f2); echo "$RUN_
-000179f0: 4944 2220 7c20 7465 6520 2f74 6d70 2f7b  ID" | tee /tmp/{
-00017a00: 6e61 6d65 7d2d 7275 6e2d 6964 272c 0a20  name}-run-id',. 
-00017a10: 2020 2020 2020 2020 2020 2066 2752 554e             f'RUN
-00017a20: 5f49 4453 3d24 2873 6b79 2073 706f 7420  _IDS=$(sky spot 
-00017a30: 6c6f 6773 202d 6e20 7b6e 616d 657d 202d  logs -n {name} -
-00017a40: 2d6e 6f2d 666f 6c6c 6f77 207c 2067 7265  -no-follow | gre
-00017a50: 7020 2d41 2034 2053 4b59 5049 4c4f 545f  p -A 4 SKYPILOT_
-00017a60: 5441 534b 5f49 4453 207c 2063 7574 202d  TASK_IDS | cut -
-00017a70: 6422 2922 202d 6632 293b 2065 6368 6f20  d")" -f2); echo 
-00017a80: 2224 5255 4e5f 4944 5322 207c 2074 6565  "$RUN_IDS" | tee
-00017a90: 202f 746d 702f 7b6e 616d 657d 2d72 756e   /tmp/{name}-run
-00017aa0: 2d69 6473 272c 0a20 2020 2020 2020 2020  -ids',.         
-00017ab0: 2020 2023 2054 6572 6d69 6e61 7465 2074     # Terminate t
-00017ac0: 6865 2063 6c75 7374 6572 206d 616e 7561  he cluster manua
-00017ad0: 6c6c 792e 0a20 2020 2020 2020 2020 2020  lly..           
-00017ae0: 2023 2054 6865 2060 6361 7420 2e2e 2e7c   # The `cat ...|
-00017af0: 2072 6576 6020 6973 2074 6f20 7265 7472   rev` is to retr
-00017b00: 6965 7665 2074 6865 206a 6f62 5f69 6420  ieve the job_id 
-00017b10: 6672 6f6d 2074 6865 0a20 2020 2020 2020  from the.       
-00017b20: 2020 2020 2023 2053 4b59 5049 4c4f 545f       # SKYPILOT_
-00017b30: 5441 534b 5f49 442c 2077 6869 6368 2067  TASK_ID, which g
-00017b40: 6574 7320 7468 6520 7365 636f 6e64 2074  ets the second t
-00017b50: 6f20 6c61 7374 2066 6965 6c64 0a20 2020  o last field.   
-00017b60: 2020 2020 2020 2020 2023 2073 6570 6172           # separ
-00017b70: 6174 6564 2062 7920 602d 602e 0a20 2020  ated by `-`..   
-00017b80: 2020 2020 2020 2020 2028 6627 5350 4f54           (f'SPOT
-00017b90: 5f4a 4f42 5f49 443d 6063 6174 202f 746d  _JOB_ID=`cat /tm
-00017ba0: 702f 7b6e 616d 657d 2d72 756e 2d69 6420  p/{name}-run-id 
-00017bb0: 7c20 7265 7620 7c20 270a 2020 2020 2020  | rev | '.      
-00017bc0: 2020 2020 2020 2066 2763 7574 202d 645c         f'cut -d\
-00017bd0: 272d 5c27 202d 6632 207c 2072 6576 603b  '-\' -f2 | rev`;
-00017be0: 7b74 6572 6d69 6e61 7465 5f63 6d64 7d27  {terminate_cmd}'
-00017bf0: 292c 0a20 2020 2020 2020 2020 2020 2027  ),.            '
-00017c00: 736c 6565 7020 3630 272c 0a20 2020 2020  sleep 60',.     
-00017c10: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
-00017c20: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
-00017c30: 7020 7b6e 616d 657d 207c 2068 6561 6420  p {name} | head 
-00017c40: 2d6e 3120 7c20 6772 6570 2022 5245 434f  -n1 | grep "RECO
-00017c50: 5645 5249 4e47 2227 2c0a 2020 2020 2020  VERING"',.      
-00017c60: 2020 2020 2020 2773 6c65 6570 2032 3030        'sleep 200
-00017c70: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00017c80: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
-00017c90: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
-00017ca0: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
-00017cb0: 6570 2022 5255 4e4e 494e 4722 272c 0a20  ep "RUNNING"',. 
-00017cc0: 2020 2020 2020 2020 2020 2066 2752 554e             f'RUN
-00017cd0: 5f49 443d 2428 6361 7420 2f74 6d70 2f7b  _ID=$(cat /tmp/{
-00017ce0: 6e61 6d65 7d2d 7275 6e2d 6964 293b 2065  name}-run-id); e
-00017cf0: 6368 6f20 2452 554e 5f49 443b 2073 6b79  cho $RUN_ID; sky
-00017d00: 2073 706f 7420 6c6f 6773 202d 6e20 7b6e   spot logs -n {n
-00017d10: 616d 657d 202d 2d6e 6f2d 666f 6c6c 6f77  ame} --no-follow
-00017d20: 207c 2067 7265 7020 534b 5950 494c 4f54   | grep SKYPILOT
-00017d30: 5f54 4153 4b5f 4944 3a20 7c20 6772 6570  _TASK_ID: | grep
-00017d40: 2022 2452 554e 5f49 4422 272c 0a20 2020   "$RUN_ID"',.   
-00017d50: 2020 2020 2020 2020 2066 2752 554e 5f49           f'RUN_I
-00017d60: 4453 3d24 2873 6b79 2073 706f 7420 6c6f  DS=$(sky spot lo
-00017d70: 6773 202d 6e20 7b6e 616d 657d 202d 2d6e  gs -n {name} --n
-00017d80: 6f2d 666f 6c6c 6f77 207c 2067 7265 7020  o-follow | grep 
-00017d90: 2d41 2034 2053 4b59 5049 4c4f 545f 5441  -A 4 SKYPILOT_TA
-00017da0: 534b 5f49 4453 207c 2063 7574 202d 6422  SK_IDS | cut -d"
-00017db0: 2922 202d 6632 293b 2065 6368 6f20 2224  )" -f2); echo "$
-00017dc0: 5255 4e5f 4944 5322 207c 2074 6565 202f  RUN_IDS" | tee /
-00017dd0: 746d 702f 7b6e 616d 657d 2d72 756e 2d69  tmp/{name}-run-i
-00017de0: 6473 2d6e 6577 272c 0a20 2020 2020 2020  ds-new',.       
-00017df0: 2020 2020 2066 2764 6966 6620 2f74 6d70       f'diff /tmp
-00017e00: 2f7b 6e61 6d65 7d2d 7275 6e2d 6964 7320  /{name}-run-ids 
-00017e10: 2f74 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d  /tmp/{name}-run-
-00017e20: 6964 732d 6e65 7727 2c0a 2020 2020 2020  ids-new',.      
-00017e30: 2020 2020 2020 6627 6361 7420 2f74 6d70        f'cat /tmp
-00017e40: 2f7b 6e61 6d65 7d2d 7275 6e2d 6964 7320  /{name}-run-ids 
-00017e50: 7c20 7365 6420 2d6e 2032 7020 7c20 6772  | sed -n 2p | gr
-00017e60: 6570 2060 6361 7420 2f74 6d70 2f7b 6e61  ep `cat /tmp/{na
-00017e70: 6d65 7d2d 7275 6e2d 6964 6027 2c0a 2020  me}-run-id`',.  
-00017e80: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-00017e90: 205f 5350 4f54 5f43 414e 4345 4c5f 5741   _SPOT_CANCEL_WA
-00017ea0: 4954 2e66 6f72 6d61 7428 6a6f 625f 6e61  IT.format(job_na
-00017eb0: 6d65 3d6e 616d 6529 2c0a 2020 2020 2020  me=name),.      
-00017ec0: 2020 7469 6d65 6f75 743d 3235 202a 2036    timeout=25 * 6
-00017ed0: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
-00017ee0: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-00017ef0: 0a0a 4070 7974 6573 742e 6d61 726b 2e6e  ..@pytest.mark.n
-00017f00: 6f5f 666c 7569 6473 7461 636b 2020 2320  o_fluidstack  # 
-00017f10: 466c 7569 6473 7461 636b 2064 6f65 7320  Fluidstack does 
-00017f20: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
-00017f30: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
-00017f40: 7374 2e6d 6172 6b2e 6e6f 5f61 7a75 7265  st.mark.no_azure
-00017f50: 2020 2320 417a 7572 6520 646f 6573 206e    # Azure does n
-00017f60: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
-00017f70: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
-00017f80: 742e 6d61 726b 2e6e 6f5f 6c61 6d62 6461  t.mark.no_lambda
-00017f90: 5f63 6c6f 7564 2020 2320 4c61 6d62 6461  _cloud  # Lambda
-00017fa0: 2043 6c6f 7564 2064 6f65 7320 6e6f 7420   Cloud does not 
-00017fb0: 7375 7070 6f72 7420 7370 6f74 2069 6e73  support spot ins
-00017fc0: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
-00017fd0: 6172 6b2e 6e6f 5f69 626d 2020 2320 4942  ark.no_ibm  # IB
-00017fe0: 4d20 436c 6f75 6420 646f 6573 206e 6f74  M Cloud does not
-00017ff0: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
-00018000: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
-00018010: 6d61 726b 2e6e 6f5f 7363 7020 2023 2053  mark.no_scp  # S
-00018020: 4350 2064 6f65 7320 6e6f 7420 7375 7070  CP does not supp
-00018030: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
-00018040: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
-00018050: 6e6f 5f6b 7562 6572 6e65 7465 7320 2023  no_kubernetes  #
-00018060: 204b 7562 6572 6e65 7465 7320 646f 6573   Kubernetes does
-00018070: 206e 6f74 2068 6176 6520 6120 6e6f 7469   not have a noti
-00018080: 6f6e 206f 6620 7370 6f74 2069 6e73 7461  on of spot insta
-00018090: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
-000180a0: 6b2e 6d61 6e61 6765 645f 7370 6f74 0a64  k.managed_spot.d
-000180b0: 6566 2074 6573 745f 7370 6f74 5f72 6563  ef test_spot_rec
-000180c0: 6f76 6572 795f 6465 6661 756c 745f 7265  overy_default_re
-000180d0: 736f 7572 6365 7328 6765 6e65 7269 635f  sources(generic_
-000180e0: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
-000180f0: 2022 2222 5465 7374 206d 616e 6167 6564   """Test managed
-00018100: 2073 706f 7420 7265 636f 7665 7279 2066   spot recovery f
-00018110: 6f72 2064 6566 6175 6c74 2072 6573 6f75  or default resou
-00018120: 7263 6573 2e22 2222 0a20 2020 206e 616d  rces.""".    nam
-00018130: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
-00018140: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
-00018150: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-00018160: 2027 6d61 6e61 6765 642d 7370 6f74 2d72   'managed-spot-r
-00018170: 6563 6f76 6572 792d 6465 6661 756c 742d  ecovery-default-
-00018180: 7265 736f 7572 6365 7327 2c0a 2020 2020  resources',.    
-00018190: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-000181a0: 2020 6627 736b 7920 7370 6f74 206c 6175    f'sky spot lau
-000181b0: 6e63 6820 2d6e 207b 6e61 6d65 7d20 2d2d  nch -n {name} --
-000181c0: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
-000181d0: 6c6f 7564 7d20 2273 6c65 6570 2033 3020  loud} "sleep 30 
-000181e0: 2626 2073 7564 6f20 7368 7574 646f 776e  && sudo shutdown
-000181f0: 206e 6f77 2026 2620 736c 6565 7020 3130   now && sleep 10
-00018200: 3030 2220 2d79 202d 6427 2c0a 2020 2020  00" -y -d',.    
-00018210: 2020 2020 2020 2020 2773 6c65 6570 2033          'sleep 3
-00018220: 3630 272c 0a20 2020 2020 2020 2020 2020  60',.           
-00018230: 2066 277b 5f53 504f 545f 5155 4555 455f   f'{_SPOT_QUEUE_
-00018240: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
-00018250: 657d 207c 2068 6561 6420 2d6e 3120 7c20  e} | head -n1 | 
-00018260: 6772 6570 2022 5255 4e4e 494e 475c 7c52  grep "RUNNING\|R
-00018270: 4543 4f56 4552 494e 4722 272c 0a20 2020  ECOVERING"',.   
-00018280: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-00018290: 5f53 504f 545f 4341 4e43 454c 5f57 4149  _SPOT_CANCEL_WAI
-000182a0: 542e 666f 726d 6174 286a 6f62 5f6e 616d  T.format(job_nam
-000182b0: 653d 6e61 6d65 292c 0a20 2020 2020 2020  e=name),.       
-000182c0: 2074 696d 656f 7574 3d32 3520 2a20 3630   timeout=25 * 60
-000182d0: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
-000182e0: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-000182f0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6177  .@pytest.mark.aw
-00018300: 730a 4070 7974 6573 742e 6d61 726b 2e6d  s.@pytest.mark.m
-00018310: 616e 6167 6564 5f73 706f 740a 6465 6620  anaged_spot.def 
-00018320: 7465 7374 5f73 706f 745f 7265 636f 7665  test_spot_recove
-00018330: 7279 5f6d 756c 7469 5f6e 6f64 655f 6177  ry_multi_node_aw
-00018340: 7328 6177 735f 636f 6e66 6967 5f72 6567  s(aws_config_reg
-00018350: 696f 6e29 3a0a 2020 2020 2222 2254 6573  ion):.    """Tes
-00018360: 7420 6d61 6e61 6765 6420 7370 6f74 2072  t managed spot r
-00018370: 6563 6f76 6572 792e 2222 220a 2020 2020  ecovery.""".    
-00018380: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-00018390: 7465 725f 6e61 6d65 2829 0a20 2020 206e  ter_name().    n
-000183a0: 616d 655f 6f6e 5f63 6c6f 7564 203d 2063  ame_on_cloud = c
-000183b0: 6f6d 6d6f 6e5f 7574 696c 732e 6d61 6b65  ommon_utils.make
-000183c0: 5f63 6c75 7374 6572 5f6e 616d 655f 6f6e  _cluster_name_on
-000183d0: 5f63 6c6f 7564 280a 2020 2020 2020 2020  _cloud(.        
-000183e0: 6e61 6d65 2c20 7370 6f74 2e53 504f 545f  name, spot.SPOT_
-000183f0: 434c 5553 5445 525f 4e41 4d45 5f50 5245  CLUSTER_NAME_PRE
-00018400: 4649 585f 4c45 4e47 5448 2c20 6164 645f  FIX_LENGTH, add_
-00018410: 7573 6572 5f68 6173 683d 4661 6c73 6529  user_hash=False)
-00018420: 0a20 2020 2072 6567 696f 6e20 3d20 6177  .    region = aw
-00018430: 735f 636f 6e66 6967 5f72 6567 696f 6e0a  s_config_region.
-00018440: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-00018450: 0a20 2020 2020 2020 2027 7370 6f74 5f72  .        'spot_r
-00018460: 6563 6f76 6572 795f 6d75 6c74 695f 6e6f  ecovery_multi_no
-00018470: 6465 5f61 7773 272c 0a20 2020 2020 2020  de_aws',.       
-00018480: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-00018490: 2773 6b79 2073 706f 7420 6c61 756e 6368  'sky spot launch
-000184a0: 202d 2d63 6c6f 7564 2061 7773 202d 2d72   --cloud aws --r
-000184b0: 6567 696f 6e20 7b72 6567 696f 6e7d 202d  egion {region} -
-000184c0: 6e20 7b6e 616d 657d 202d 2d6e 756d 2d6e  n {name} --num-n
-000184d0: 6f64 6573 2032 2022 6563 686f 2053 4b59  odes 2 "echo SKY
-000184e0: 5049 4c4f 545f 5441 534b 5f49 443a 205c  PILOT_TASK_ID: \
-000184f0: 2453 4b59 5049 4c4f 545f 5441 534b 5f49  $SKYPILOT_TASK_I
-00018500: 443b 2073 6c65 6570 2031 3830 3022 2020  D; sleep 1800"  
-00018510: 2d79 202d 6427 2c0a 2020 2020 2020 2020  -y -d',.        
-00018520: 2020 2020 2773 6c65 6570 2034 3530 272c      'sleep 450',
-00018530: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-00018540: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
-00018550: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
-00018560: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
-00018570: 2022 5255 4e4e 494e 4722 272c 0a20 2020   "RUNNING"',.   
-00018580: 2020 2020 2020 2020 2066 2752 554e 5f49           f'RUN_I
-00018590: 443d 2428 736b 7920 7370 6f74 206c 6f67  D=$(sky spot log
-000185a0: 7320 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f  s -n {name} --no
-000185b0: 2d66 6f6c 6c6f 7720 7c20 6772 6570 2053  -follow | grep S
-000185c0: 4b59 5049 4c4f 545f 5441 534b 5f49 4420  KYPILOT_TASK_ID 
-000185d0: 7c20 6375 7420 2d64 3a20 2d66 3229 3b20  | cut -d: -f2); 
-000185e0: 6563 686f 2022 2452 554e 5f49 4422 207c  echo "$RUN_ID" |
-000185f0: 2074 6565 202f 746d 702f 7b6e 616d 657d   tee /tmp/{name}
-00018600: 2d72 756e 2d69 6427 2c0a 2020 2020 2020  -run-id',.      
-00018610: 2020 2020 2020 2320 5465 726d 696e 6174        # Terminat
-00018620: 6520 7468 6520 776f 726b 6572 206d 616e  e the worker man
-00018630: 7561 6c6c 792e 0a20 2020 2020 2020 2020  ually..         
-00018640: 2020 2028 6627 6177 7320 6563 3220 7465     (f'aws ec2 te
-00018650: 726d 696e 6174 652d 696e 7374 616e 6365  rminate-instance
-00018660: 7320 2d2d 7265 6769 6f6e 207b 7265 6769  s --region {regi
-00018670: 6f6e 7d20 2d2d 696e 7374 616e 6365 2d69  on} --instance-i
-00018680: 6473 2024 2827 0a20 2020 2020 2020 2020  ds $('.         
-00018690: 2020 2020 6627 6177 7320 6563 3220 6465      f'aws ec2 de
-000186a0: 7363 7269 6265 2d69 6e73 7461 6e63 6573  scribe-instances
-000186b0: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
-000186c0: 6e7d 2027 0a20 2020 2020 2020 2020 2020  n} '.           
-000186d0: 2020 6627 2d2d 6669 6c74 6572 7320 4e61    f'--filters Na
-000186e0: 6d65 3d74 6167 3a72 6179 2d63 6c75 7374  me=tag:ray-clust
-000186f0: 6572 2d6e 616d 652c 5661 6c75 6573 3d7b  er-name,Values={
-00018700: 6e61 6d65 5f6f 6e5f 636c 6f75 647d 2a20  name_on_cloud}* 
-00018710: 270a 2020 2020 2020 2020 2020 2020 2027  '.             '
-00018720: 4e61 6d65 3d74 6167 3a72 6179 2d6e 6f64  Name=tag:ray-nod
-00018730: 652d 7479 7065 2c56 616c 7565 733d 776f  e-type,Values=wo
-00018740: 726b 6572 2027 0a20 2020 2020 2020 2020  rker '.         
-00018750: 2020 2020 6627 2d2d 7175 6572 7920 5265      f'--query Re
-00018760: 7365 7276 6174 696f 6e73 5b5d 2e49 6e73  servations[].Ins
-00018770: 7461 6e63 6573 5b5d 2e49 6e73 7461 6e63  tances[].Instanc
-00018780: 6549 6420 270a 2020 2020 2020 2020 2020  eId '.          
-00018790: 2020 2027 2d2d 6f75 7470 7574 2074 6578     '--output tex
-000187a0: 7429 2729 2c0a 2020 2020 2020 2020 2020  t)'),.          
-000187b0: 2020 2773 6c65 6570 2035 3027 2c0a 2020    'sleep 50',.  
-000187c0: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-000187d0: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
-000187e0: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
-000187f0: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
-00018800: 4543 4f56 4552 494e 4722 272c 0a20 2020  ECOVERING"',.   
-00018810: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-00018820: 3536 3027 2c0a 2020 2020 2020 2020 2020  560',.          
-00018830: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
-00018840: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
-00018850: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
-00018860: 2067 7265 7020 2252 554e 4e49 4e47 2227   grep "RUNNING"'
-00018870: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00018880: 5255 4e5f 4944 3d24 2863 6174 202f 746d  RUN_ID=$(cat /tm
-00018890: 702f 7b6e 616d 657d 2d72 756e 2d69 6429  p/{name}-run-id)
-000188a0: 3b20 6563 686f 2024 5255 4e5f 4944 3b20  ; echo $RUN_ID; 
-000188b0: 736b 7920 7370 6f74 206c 6f67 7320 2d6e  sky spot logs -n
-000188c0: 207b 6e61 6d65 7d20 2d2d 6e6f 2d66 6f6c   {name} --no-fol
-000188d0: 6c6f 7720 7c20 6772 6570 2053 4b59 5049  low | grep SKYPI
-000188e0: 4c4f 545f 5441 534b 5f49 4420 7c20 6375  LOT_TASK_ID | cu
-000188f0: 7420 2d64 3a20 2d66 3220 7c20 6772 6570  t -d: -f2 | grep
-00018900: 2022 2452 554e 5f49 4422 272c 0a20 2020   "$RUN_ID"',.   
-00018910: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
-00018920: 5f53 504f 545f 4341 4e43 454c 5f57 4149  _SPOT_CANCEL_WAI
-00018930: 542e 666f 726d 6174 286a 6f62 5f6e 616d  T.format(job_nam
-00018940: 653d 6e61 6d65 292c 0a20 2020 2020 2020  e=name),.       
-00018950: 2074 696d 656f 7574 3d33 3020 2a20 3630   timeout=30 * 60
-00018960: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
-00018970: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-00018980: 0a40 7079 7465 7374 2e6d 6172 6b2e 6763  .@pytest.mark.gc
-00018990: 700a 4070 7974 6573 742e 6d61 726b 2e6d  p.@pytest.mark.m
-000189a0: 616e 6167 6564 5f73 706f 740a 6465 6620  anaged_spot.def 
-000189b0: 7465 7374 5f73 706f 745f 7265 636f 7665  test_spot_recove
-000189c0: 7279 5f6d 756c 7469 5f6e 6f64 655f 6763  ry_multi_node_gc
-000189d0: 7028 293a 0a20 2020 2022 2222 5465 7374  p():.    """Test
-000189e0: 206d 616e 6167 6564 2073 706f 7420 7265   managed spot re
-000189f0: 636f 7665 7279 2e22 2222 0a20 2020 206e  covery.""".    n
-00018a00: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-00018a10: 6572 5f6e 616d 6528 290a 2020 2020 6e61  er_name().    na
-00018a20: 6d65 5f6f 6e5f 636c 6f75 6420 3d20 636f  me_on_cloud = co
-00018a30: 6d6d 6f6e 5f75 7469 6c73 2e6d 616b 655f  mmon_utils.make_
-00018a40: 636c 7573 7465 725f 6e61 6d65 5f6f 6e5f  cluster_name_on_
-00018a50: 636c 6f75 6428 0a20 2020 2020 2020 206e  cloud(.        n
-00018a60: 616d 652c 2073 706f 742e 5350 4f54 5f43  ame, spot.SPOT_C
-00018a70: 4c55 5354 4552 5f4e 414d 455f 5052 4546  LUSTER_NAME_PREF
-00018a80: 4958 5f4c 454e 4754 482c 2061 6464 5f75  IX_LENGTH, add_u
-00018a90: 7365 725f 6861 7368 3d46 616c 7365 290a  ser_hash=False).
-00018aa0: 2020 2020 7a6f 6e65 203d 2027 7573 2d77      zone = 'us-w
-00018ab0: 6573 7432 2d61 270a 2020 2020 2320 5573  est2-a'.    # Us
-00018ac0: 6520 273a 2720 746f 206d 6174 6368 2061  e ':' to match a
-00018ad0: 7320 7468 6520 636c 7573 7465 7220 6e61  s the cluster na
-00018ae0: 6d65 2077 696c 6c20 636f 6e74 6169 6e20  me will contain 
-00018af0: 7468 6520 7375 6666 6978 2077 6974 6820  the suffix with 
-00018b00: 6a6f 6220 6964 0a20 2020 2071 7565 7279  job id.    query
-00018b10: 5f63 6d64 203d 2028 0a20 2020 2020 2020  _cmd = (.       
-00018b20: 2066 2767 636c 6f75 6420 636f 6d70 7574   f'gcloud comput
-00018b30: 6520 696e 7374 616e 6365 7320 6c69 7374  e instances list
-00018b40: 202d 2d66 696c 7465 723d 270a 2020 2020   --filter='.    
-00018b50: 2020 2020 6627 2228 6c61 6265 6c73 2e72      f'"(labels.r
-00018b60: 6179 2d63 6c75 7374 6572 2d6e 616d 653a  ay-cluster-name:
-00018b70: 7b6e 616d 655f 6f6e 5f63 6c6f 7564 7d20  {name_on_cloud} 
-00018b80: 414e 4420 270a 2020 2020 2020 2020 6627  AND '.        f'
-00018b90: 6c61 6265 6c73 2e72 6179 2d6e 6f64 652d  labels.ray-node-
-00018ba0: 7479 7065 3d77 6f72 6b65 7229 2220 2d2d  type=worker)" --
-00018bb0: 7a6f 6e65 733d 7b7a 6f6e 657d 202d 2d66  zones={zone} --f
-00018bc0: 6f72 6d61 743d 2276 616c 7565 286e 616d  ormat="value(nam
-00018bd0: 6529 2227 290a 2020 2020 7465 726d 696e  e)"').    termin
-00018be0: 6174 655f 636d 6420 3d20 2866 2767 636c  ate_cmd = (f'gcl
-00018bf0: 6f75 6420 636f 6d70 7574 6520 696e 7374  oud compute inst
-00018c00: 616e 6365 7320 6465 6c65 7465 202d 2d7a  ances delete --z
-00018c10: 6f6e 653d 7b7a 6f6e 657d 270a 2020 2020  one={zone}'.    
-00018c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018c30: 2066 2720 2d2d 7175 6965 7420 2428 7b71   f' --quiet $({q
-00018c40: 7565 7279 5f63 6d64 7d29 2729 0a20 2020  uery_cmd})').   
-00018c50: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-00018c60: 2020 2020 2020 2773 706f 745f 7265 636f        'spot_reco
-00018c70: 7665 7279 5f6d 756c 7469 5f6e 6f64 655f  very_multi_node_
-00018c80: 6763 7027 2c0a 2020 2020 2020 2020 5b0a  gcp',.        [.
-00018c90: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00018ca0: 7920 7370 6f74 206c 6175 6e63 6820 2d2d  y spot launch --
-00018cb0: 636c 6f75 6420 6763 7020 2d2d 7a6f 6e65  cloud gcp --zone
-00018cc0: 207b 7a6f 6e65 7d20 2d6e 207b 6e61 6d65   {zone} -n {name
-00018cd0: 7d20 2d2d 6e75 6d2d 6e6f 6465 7320 3220  } --num-nodes 2 
-00018ce0: 2265 6368 6f20 534b 5950 494c 4f54 5f54  "echo SKYPILOT_T
-00018cf0: 4153 4b5f 4944 3a20 5c24 534b 5950 494c  ASK_ID: \$SKYPIL
-00018d00: 4f54 5f54 4153 4b5f 4944 3b20 736c 6565  OT_TASK_ID; slee
-00018d10: 7020 3138 3030 2220 202d 7920 2d64 272c  p 1800"  -y -d',
-00018d20: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
-00018d30: 6565 7020 3430 3027 2c0a 2020 2020 2020  eep 400',.      
-00018d40: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
-00018d50: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
-00018d60: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
-00018d70: 6e31 207c 2067 7265 7020 2252 554e 4e49  n1 | grep "RUNNI
-00018d80: 4e47 2227 2c0a 2020 2020 2020 2020 2020  NG"',.          
-00018d90: 2020 6627 5255 4e5f 4944 3d24 2873 6b79    f'RUN_ID=$(sky
-00018da0: 2073 706f 7420 6c6f 6773 202d 6e20 7b6e   spot logs -n {n
-00018db0: 616d 657d 202d 2d6e 6f2d 666f 6c6c 6f77  ame} --no-follow
-00018dc0: 207c 2067 7265 7020 534b 5950 494c 4f54   | grep SKYPILOT
-00018dd0: 5f54 4153 4b5f 4944 207c 2063 7574 202d  _TASK_ID | cut -
-00018de0: 643a 202d 6632 293b 2065 6368 6f20 2224  d: -f2); echo "$
-00018df0: 5255 4e5f 4944 2220 7c20 7465 6520 2f74  RUN_ID" | tee /t
-00018e00: 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d 6964  mp/{name}-run-id
-00018e10: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
-00018e20: 2054 6572 6d69 6e61 7465 2074 6865 2077   Terminate the w
-00018e30: 6f72 6b65 7220 6d61 6e75 616c 6c79 2e0a  orker manually..
-00018e40: 2020 2020 2020 2020 2020 2020 7465 726d              term
-00018e50: 696e 6174 655f 636d 642c 0a20 2020 2020  inate_cmd,.     
-00018e60: 2020 2020 2020 2027 736c 6565 7020 3530         'sleep 50
-00018e70: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00018e80: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
-00018e90: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
-00018ea0: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
-00018eb0: 6570 2022 5245 434f 5645 5249 4e47 2227  ep "RECOVERING"'
-00018ec0: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-00018ed0: 6c65 6570 2034 3230 272c 0a20 2020 2020  leep 420',.     
-00018ee0: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
-00018ef0: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
-00018f00: 7020 7b6e 616d 657d 207c 2068 6561 6420  p {name} | head 
-00018f10: 2d6e 3120 7c20 6772 6570 2022 5255 4e4e  -n1 | grep "RUNN
-00018f20: 494e 4722 272c 0a20 2020 2020 2020 2020  ING"',.         
-00018f30: 2020 2066 2752 554e 5f49 443d 2428 6361     f'RUN_ID=$(ca
-00018f40: 7420 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  t /tmp/{name}-ru
-00018f50: 6e2d 6964 293b 2065 6368 6f20 2452 554e  n-id); echo $RUN
-00018f60: 5f49 443b 2073 6b79 2073 706f 7420 6c6f  _ID; sky spot lo
-00018f70: 6773 202d 6e20 7b6e 616d 657d 202d 2d6e  gs -n {name} --n
-00018f80: 6f2d 666f 6c6c 6f77 207c 2067 7265 7020  o-follow | grep 
-00018f90: 534b 5950 494c 4f54 5f54 4153 4b5f 4944  SKYPILOT_TASK_ID
-00018fa0: 207c 2063 7574 202d 643a 202d 6632 207c   | cut -d: -f2 |
-00018fb0: 2067 7265 7020 2224 5255 4e5f 4944 2227   grep "$RUN_ID"'
-00018fc0: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-00018fd0: 2020 2020 205f 5350 4f54 5f43 414e 4345       _SPOT_CANCE
-00018fe0: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
-00018ff0: 625f 6e61 6d65 3d6e 616d 6529 2c0a 2020  b_name=name),.  
-00019000: 2020 2020 2020 7469 6d65 6f75 743d 3235        timeout=25
-00019010: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
-00019020: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
-00019030: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
-00019040: 726b 2e61 7773 0a40 7079 7465 7374 2e6d  rk.aws.@pytest.m
-00019050: 6172 6b2e 6d61 6e61 6765 645f 7370 6f74  ark.managed_spot
-00019060: 0a64 6566 2074 6573 745f 7370 6f74 5f63  .def test_spot_c
-00019070: 616e 6365 6c6c 6174 696f 6e5f 6177 7328  ancellation_aws(
-00019080: 6177 735f 636f 6e66 6967 5f72 6567 696f  aws_config_regio
-00019090: 6e29 3a0a 2020 2020 6e61 6d65 203d 205f  n):.    name = _
-000190a0: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-000190b0: 2829 0a20 2020 206e 616d 655f 6f6e 5f63  ().    name_on_c
-000190c0: 6c6f 7564 203d 2063 6f6d 6d6f 6e5f 7574  loud = common_ut
-000190d0: 696c 732e 6d61 6b65 5f63 6c75 7374 6572  ils.make_cluster
-000190e0: 5f6e 616d 655f 6f6e 5f63 6c6f 7564 280a  _name_on_cloud(.
-000190f0: 2020 2020 2020 2020 6e61 6d65 2c20 7370          name, sp
-00019100: 6f74 2e53 504f 545f 434c 5553 5445 525f  ot.SPOT_CLUSTER_
-00019110: 4e41 4d45 5f50 5245 4649 585f 4c45 4e47  NAME_PREFIX_LENG
-00019120: 5448 2c20 6164 645f 7573 6572 5f68 6173  TH, add_user_has
-00019130: 683d 4661 6c73 6529 0a20 2020 206e 616d  h=False).    nam
-00019140: 655f 325f 6f6e 5f63 6c6f 7564 203d 2063  e_2_on_cloud = c
-00019150: 6f6d 6d6f 6e5f 7574 696c 732e 6d61 6b65  ommon_utils.make
-00019160: 5f63 6c75 7374 6572 5f6e 616d 655f 6f6e  _cluster_name_on
-00019170: 5f63 6c6f 7564 280a 2020 2020 2020 2020  _cloud(.        
-00019180: 6627 7b6e 616d 657d 2d32 272c 2073 706f  f'{name}-2', spo
-00019190: 742e 5350 4f54 5f43 4c55 5354 4552 5f4e  t.SPOT_CLUSTER_N
-000191a0: 414d 455f 5052 4546 4958 5f4c 454e 4754  AME_PREFIX_LENGT
-000191b0: 482c 2061 6464 5f75 7365 725f 6861 7368  H, add_user_hash
-000191c0: 3d46 616c 7365 290a 2020 2020 6e61 6d65  =False).    name
-000191d0: 5f33 5f6f 6e5f 636c 6f75 6420 3d20 636f  _3_on_cloud = co
-000191e0: 6d6d 6f6e 5f75 7469 6c73 2e6d 616b 655f  mmon_utils.make_
-000191f0: 636c 7573 7465 725f 6e61 6d65 5f6f 6e5f  cluster_name_on_
-00019200: 636c 6f75 6428 0a20 2020 2020 2020 2066  cloud(.        f
-00019210: 277b 6e61 6d65 7d2d 3327 2c20 7370 6f74  '{name}-3', spot
-00019220: 2e53 504f 545f 434c 5553 5445 525f 4e41  .SPOT_CLUSTER_NA
-00019230: 4d45 5f50 5245 4649 585f 4c45 4e47 5448  ME_PREFIX_LENGTH
-00019240: 2c20 6164 645f 7573 6572 5f68 6173 683d  , add_user_hash=
-00019250: 4661 6c73 6529 0a20 2020 2072 6567 696f  False).    regio
-00019260: 6e20 3d20 6177 735f 636f 6e66 6967 5f72  n = aws_config_r
-00019270: 6567 696f 6e0a 2020 2020 7465 7374 203d  egion.    test =
-00019280: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-00019290: 7370 6f74 5f63 616e 6365 6c6c 6174 696f  spot_cancellatio
-000192a0: 6e5f 6177 7327 2c0a 2020 2020 2020 2020  n_aws',.        
-000192b0: 5b0a 2020 2020 2020 2020 2020 2020 2320  [.            # 
-000192c0: 5465 7374 2063 616e 6365 6c6c 6174 696f  Test cancellatio
-000192d0: 6e20 6475 7269 6e67 2073 706f 7420 636c  n during spot cl
-000192e0: 7573 7465 7220 6265 696e 6720 6c61 756e  uster being laun
-000192f0: 6368 6564 2e0a 2020 2020 2020 2020 2020  ched..          
-00019300: 2020 6627 736b 7920 7370 6f74 206c 6175    f'sky spot lau
-00019310: 6e63 6820 2d2d 636c 6f75 6420 6177 7320  nch --cloud aws 
-00019320: 2d2d 7265 6769 6f6e 207b 7265 6769 6f6e  --region {region
-00019330: 7d20 2d6e 207b 6e61 6d65 7d20 2273 6c65  } -n {name} "sle
-00019340: 6570 2031 3030 3022 2020 2d79 202d 6427  ep 1000"  -y -d'
-00019350: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-00019360: 6c65 6570 2036 3027 2c0a 2020 2020 2020  leep 60',.      
-00019370: 2020 2020 2020 6627 7b5f 5350 4f54 5f51        f'{_SPOT_Q
-00019380: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
-00019390: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
-000193a0: 6e31 207c 2067 7265 7020 2253 5441 5254  n1 | grep "START
-000193b0: 494e 4722 272c 0a20 2020 2020 2020 2020  ING"',.         
-000193c0: 2020 205f 5350 4f54 5f43 414e 4345 4c5f     _SPOT_CANCEL_
-000193d0: 5741 4954 2e66 6f72 6d61 7428 6a6f 625f  WAIT.format(job_
-000193e0: 6e61 6d65 3d6e 616d 6529 2c0a 2020 2020  name=name),.    
-000193f0: 2020 2020 2020 2020 2773 6c65 6570 2035          'sleep 5
-00019400: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-00019410: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
-00019420: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
-00019430: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
-00019440: 6570 2022 4341 4e43 454c 4c49 4e47 5c7c  ep "CANCELLING\|
-00019450: 4341 4e43 454c 4c45 4422 272c 0a20 2020  CANCELLED"',.   
-00019460: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-00019470: 3132 3027 2c0a 2020 2020 2020 2020 2020  120',.          
-00019480: 2020 6627 7b5f 5350 4f54 5f51 5545 5545    f'{_SPOT_QUEUE
-00019490: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
-000194a0: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
-000194b0: 2067 7265 7020 2243 414e 4345 4c4c 4544   grep "CANCELLED
-000194c0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-000194d0: 2866 2773 3d24 2861 7773 2065 6332 2064  (f's=$(aws ec2 d
-000194e0: 6573 6372 6962 652d 696e 7374 616e 6365  escribe-instance
-000194f0: 7320 2d2d 7265 6769 6f6e 207b 7265 6769  s --region {regi
-00019500: 6f6e 7d20 270a 2020 2020 2020 2020 2020  on} '.          
-00019510: 2020 2066 272d 2d66 696c 7465 7273 204e     f'--filters N
-00019520: 616d 653d 7461 673a 7261 792d 636c 7573  ame=tag:ray-clus
-00019530: 7465 722d 6e61 6d65 2c56 616c 7565 733d  ter-name,Values=
-00019540: 7b6e 616d 655f 6f6e 5f63 6c6f 7564 7d2d  {name_on_cloud}-
-00019550: 2a20 270a 2020 2020 2020 2020 2020 2020  * '.            
-00019560: 2066 272d 2d71 7565 7279 2052 6573 6572   f'--query Reser
-00019570: 7661 7469 6f6e 735b 5d2e 496e 7374 616e  vations[].Instan
-00019580: 6365 735b 5d2e 5374 6174 655b 5d2e 4e61  ces[].State[].Na
-00019590: 6d65 2027 0a20 2020 2020 2020 2020 2020  me '.           
-000195a0: 2020 272d 2d6f 7574 7075 7420 7465 7874    '--output text
-000195b0: 2920 2626 2065 6368 6f20 2224 7322 2026  ) && echo "$s" &
-000195c0: 2620 6563 686f 3b20 5b5b 202d 7a20 2224  & echo; [[ -z "$
-000195d0: 7322 205d 5d20 7c7c 205b 5b20 2224 7322  s" ]] || [[ "$s"
-000195e0: 203d 2022 7465 726d 696e 6174 6564 2220   = "terminated" 
-000195f0: 5d5d 207c 7c20 5b5b 2022 2473 2220 3d20  ]] || [[ "$s" = 
-00019600: 2273 6875 7474 696e 672d 646f 776e 2220  "shutting-down" 
-00019610: 5d5d 270a 2020 2020 2020 2020 2020 2020  ]]'.            
-00019620: 292c 0a20 2020 2020 2020 2020 2020 2023  ),.            #
-00019630: 2054 6573 7420 6361 6e63 656c 6c69 6e67   Test cancelling
-00019640: 2074 6865 2073 706f 7420 636c 7573 7465   the spot cluste
-00019650: 7220 6475 7269 6e67 2073 706f 7420 6a6f  r during spot jo
-00019660: 6220 6265 696e 6720 7365 7475 702e 0a20  b being setup.. 
-00019670: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-00019680: 2073 706f 7420 6c61 756e 6368 202d 2d63   spot launch --c
-00019690: 6c6f 7564 2061 7773 202d 2d72 6567 696f  loud aws --regio
-000196a0: 6e20 7b72 6567 696f 6e7d 202d 6e20 7b6e  n {region} -n {n
-000196b0: 616d 657d 2d32 2074 6573 7473 2f74 6573  ame}-2 tests/tes
-000196c0: 745f 7961 6d6c 732f 7465 7374 5f6c 6f6e  t_yamls/test_lon
-000196d0: 675f 7365 7475 702e 7961 6d6c 2020 2d79  g_setup.yaml  -y
-000196e0: 202d 6427 2c0a 2020 2020 2020 2020 2020   -d',.          
-000196f0: 2020 2773 6c65 6570 2033 3030 272c 0a20    'sleep 300',. 
-00019700: 2020 2020 2020 2020 2020 205f 5350 4f54             _SPOT
-00019710: 5f43 414e 4345 4c5f 5741 4954 2e66 6f72  _CANCEL_WAIT.for
-00019720: 6d61 7428 6a6f 625f 6e61 6d65 3d66 277b  mat(job_name=f'{
-00019730: 6e61 6d65 7d2d 3227 292c 0a20 2020 2020  name}-2'),.     
-00019740: 2020 2020 2020 2027 736c 6565 7020 3527         'sleep 5'
-00019750: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00019760: 7b5f 5350 4f54 5f51 5545 5545 5f57 4149  {_SPOT_QUEUE_WAI
-00019770: 547d 7c20 6772 6570 207b 6e61 6d65 7d2d  T}| grep {name}-
-00019780: 3220 7c20 6865 6164 202d 6e31 207c 2067  2 | head -n1 | g
-00019790: 7265 7020 2243 414e 4345 4c4c 494e 475c  rep "CANCELLING\
-000197a0: 7c43 414e 4345 4c4c 4544 2227 2c0a 2020  |CANCELLED"',.  
-000197b0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
-000197c0: 2031 3230 272c 0a20 2020 2020 2020 2020   120',.         
-000197d0: 2020 2066 277b 5f53 504f 545f 5155 4555     f'{_SPOT_QUEU
-000197e0: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
-000197f0: 616d 657d 2d32 207c 2068 6561 6420 2d6e  ame}-2 | head -n
-00019800: 3120 7c20 6772 6570 2022 4341 4e43 454c  1 | grep "CANCEL
-00019810: 4c45 4422 272c 0a20 2020 2020 2020 2020  LED"',.         
-00019820: 2020 2028 6627 733d 2428 6177 7320 6563     (f's=$(aws ec
-00019830: 3220 6465 7363 7269 6265 2d69 6e73 7461  2 describe-insta
-00019840: 6e63 6573 202d 2d72 6567 696f 6e20 7b72  nces --region {r
-00019850: 6567 696f 6e7d 2027 0a20 2020 2020 2020  egion} '.       
-00019860: 2020 2020 2020 6627 2d2d 6669 6c74 6572        f'--filter
-00019870: 7320 4e61 6d65 3d74 6167 3a72 6179 2d63  s Name=tag:ray-c
-00019880: 6c75 7374 6572 2d6e 616d 652c 5661 6c75  luster-name,Valu
-00019890: 6573 3d7b 6e61 6d65 5f32 5f6f 6e5f 636c  es={name_2_on_cl
-000198a0: 6f75 647d 2d2a 2027 0a20 2020 2020 2020  oud}-* '.       
-000198b0: 2020 2020 2020 6627 2d2d 7175 6572 7920        f'--query 
-000198c0: 5265 7365 7276 6174 696f 6e73 5b5d 2e49  Reservations[].I
-000198d0: 6e73 7461 6e63 6573 5b5d 2e53 7461 7465  nstances[].State
-000198e0: 5b5d 2e4e 616d 6520 270a 2020 2020 2020  [].Name '.      
-000198f0: 2020 2020 2020 2027 2d2d 6f75 7470 7574         '--output
-00019900: 2074 6578 7429 2026 2620 6563 686f 2022   text) && echo "
-00019910: 2473 2220 2626 2065 6368 6f3b 205b 5b20  $s" && echo; [[ 
-00019920: 2d7a 2022 2473 2220 5d5d 207c 7c20 5b5b  -z "$s" ]] || [[
-00019930: 2022 2473 2220 3d20 2274 6572 6d69 6e61   "$s" = "termina
-00019940: 7465 6422 205d 5d20 7c7c 205b 5b20 2224  ted" ]] || [[ "$
-00019950: 7322 203d 2022 7368 7574 7469 6e67 2d64  s" = "shutting-d
-00019960: 6f77 6e22 205d 5d27 0a20 2020 2020 2020  own" ]]'.       
-00019970: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
-00019980: 2020 2020 2320 5465 7374 2063 616e 6365      # Test cance
-00019990: 6c6c 6174 696f 6e20 6475 7269 6e67 2073  llation during s
-000199a0: 706f 7420 6a6f 6220 6973 2072 6563 6f76  pot job is recov
-000199b0: 6572 696e 672e 0a20 2020 2020 2020 2020  ering..         
-000199c0: 2020 2066 2773 6b79 2073 706f 7420 6c61     f'sky spot la
-000199d0: 756e 6368 202d 2d63 6c6f 7564 2061 7773  unch --cloud aws
-000199e0: 202d 2d72 6567 696f 6e20 7b72 6567 696f   --region {regio
-000199f0: 6e7d 202d 6e20 7b6e 616d 657d 2d33 2022  n} -n {name}-3 "
-00019a00: 736c 6565 7020 3130 3030 2220 202d 7920  sleep 1000"  -y 
-00019a10: 2d64 272c 0a20 2020 2020 2020 2020 2020  -d',.           
-00019a20: 2027 736c 6565 7020 3330 3027 2c0a 2020   'sleep 300',.  
-00019a30: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-00019a40: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
-00019a50: 6772 6570 207b 6e61 6d65 7d2d 3320 7c20  grep {name}-3 | 
-00019a60: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
-00019a70: 2252 554e 4e49 4e47 2227 2c0a 2020 2020  "RUNNING"',.    
-00019a80: 2020 2020 2020 2020 2320 5465 726d 696e          # Termin
-00019a90: 6174 6520 7468 6520 636c 7573 7465 7220  ate the cluster 
-00019aa0: 6d61 6e75 616c 6c79 2e0a 2020 2020 2020  manually..      
-00019ab0: 2020 2020 2020 2866 2761 7773 2065 6332        (f'aws ec2
-00019ac0: 2074 6572 6d69 6e61 7465 2d69 6e73 7461   terminate-insta
-00019ad0: 6e63 6573 202d 2d72 6567 696f 6e20 7b72  nces --region {r
-00019ae0: 6567 696f 6e7d 202d 2d69 6e73 7461 6e63  egion} --instanc
-00019af0: 652d 6964 7320 2428 270a 2020 2020 2020  e-ids $('.      
-00019b00: 2020 2020 2020 2066 2761 7773 2065 6332         f'aws ec2
-00019b10: 2064 6573 6372 6962 652d 696e 7374 616e   describe-instan
-00019b20: 6365 7320 2d2d 7265 6769 6f6e 207b 7265  ces --region {re
-00019b30: 6769 6f6e 7d20 270a 2020 2020 2020 2020  gion} '.        
-00019b40: 2020 2020 2066 272d 2d66 696c 7465 7273       f'--filters
-00019b50: 204e 616d 653d 7461 673a 7261 792d 636c   Name=tag:ray-cl
-00019b60: 7573 7465 722d 6e61 6d65 2c56 616c 7565  uster-name,Value
-00019b70: 733d 7b6e 616d 655f 335f 6f6e 5f63 6c6f  s={name_3_on_clo
-00019b80: 7564 7d2d 2a20 270a 2020 2020 2020 2020  ud}-* '.        
-00019b90: 2020 2020 2066 272d 2d71 7565 7279 2052       f'--query R
-00019ba0: 6573 6572 7661 7469 6f6e 735b 5d2e 496e  eservations[].In
-00019bb0: 7374 616e 6365 735b 5d2e 496e 7374 616e  stances[].Instan
-00019bc0: 6365 4964 2027 0a20 2020 2020 2020 2020  ceId '.         
-00019bd0: 2020 2020 272d 2d6f 7574 7075 7420 7465      '--output te
-00019be0: 7874 2927 292c 0a20 2020 2020 2020 2020  xt)'),.         
-00019bf0: 2020 2027 736c 6565 7020 3132 3027 2c0a     'sleep 120',.
-00019c00: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-00019c10: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
-00019c20: 7c20 6772 6570 207b 6e61 6d65 7d2d 3320  | grep {name}-3 
-00019c30: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
-00019c40: 7020 2252 4543 4f56 4552 494e 4722 272c  p "RECOVERING"',
-00019c50: 0a20 2020 2020 2020 2020 2020 205f 5350  .            _SP
-00019c60: 4f54 5f43 414e 4345 4c5f 5741 4954 2e66  OT_CANCEL_WAIT.f
-00019c70: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d66  ormat(job_name=f
-00019c80: 277b 6e61 6d65 7d2d 3327 292c 0a20 2020  '{name}-3'),.   
-00019c90: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-00019ca0: 3527 2c0a 2020 2020 2020 2020 2020 2020  5',.            
-00019cb0: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
-00019cc0: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
-00019cd0: 7d2d 3320 7c20 6865 6164 202d 6e31 207c  }-3 | head -n1 |
-00019ce0: 2067 7265 7020 2243 414e 4345 4c4c 494e   grep "CANCELLIN
-00019cf0: 475c 7c43 414e 4345 4c4c 4544 2227 2c0a  G\|CANCELLED"',.
-00019d00: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
-00019d10: 6570 2031 3230 272c 0a20 2020 2020 2020  ep 120',.       
-00019d20: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
-00019d30: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
-00019d40: 7b6e 616d 657d 2d33 207c 2068 6561 6420  {name}-3 | head 
-00019d50: 2d6e 3120 7c20 6772 6570 2022 4341 4e43  -n1 | grep "CANC
-00019d60: 454c 4c45 4422 272c 0a20 2020 2020 2020  ELLED"',.       
-00019d70: 2020 2020 2023 2054 6865 2063 6c75 7374       # The clust
-00019d80: 6572 2073 686f 756c 6420 6265 2074 6572  er should be ter
-00019d90: 6d69 6e61 7465 6420 2873 6875 7474 696e  minated (shuttin
-00019da0: 672d 646f 776e 2920 6166 7465 7220 6361  g-down) after ca
-00019db0: 6e63 656c 6c61 7469 6f6e 2e20 5765 2064  ncellation. We d
-00019dc0: 6f6e 2774 2075 7365 2074 6865 2060 3d60  on't use the `=`
-00019dd0: 206f 7065 7261 746f 7220 6865 7265 2062   operator here b
-00019de0: 6563 6175 7365 0a20 2020 2020 2020 2020  ecause.         
-00019df0: 2020 2023 2074 6865 7265 2063 616e 2062     # there can b
-00019e00: 6520 6d75 6c74 6970 6c65 2056 4d20 7769  e multiple VM wi
-00019e10: 7468 2074 6865 2073 616d 6520 6e61 6d65  th the same name
-00019e20: 2064 7565 2074 6f20 7468 6520 7265 636f   due to the reco
-00019e30: 7665 7279 2e0a 2020 2020 2020 2020 2020  very..          
-00019e40: 2020 2866 2773 3d24 2861 7773 2065 6332    (f's=$(aws ec2
-00019e50: 2064 6573 6372 6962 652d 696e 7374 616e   describe-instan
-00019e60: 6365 7320 2d2d 7265 6769 6f6e 207b 7265  ces --region {re
-00019e70: 6769 6f6e 7d20 270a 2020 2020 2020 2020  gion} '.        
-00019e80: 2020 2020 2066 272d 2d66 696c 7465 7273       f'--filters
-00019e90: 204e 616d 653d 7461 673a 7261 792d 636c   Name=tag:ray-cl
-00019ea0: 7573 7465 722d 6e61 6d65 2c56 616c 7565  uster-name,Value
-00019eb0: 733d 7b6e 616d 655f 335f 6f6e 5f63 6c6f  s={name_3_on_clo
-00019ec0: 7564 7d2d 2a20 270a 2020 2020 2020 2020  ud}-* '.        
-00019ed0: 2020 2020 2066 272d 2d71 7565 7279 2052       f'--query R
-00019ee0: 6573 6572 7661 7469 6f6e 735b 5d2e 496e  eservations[].In
-00019ef0: 7374 616e 6365 735b 5d2e 5374 6174 655b  stances[].State[
-00019f00: 5d2e 4e61 6d65 2027 0a20 2020 2020 2020  ].Name '.       
-00019f10: 2020 2020 2020 272d 2d6f 7574 7075 7420        '--output 
-00019f20: 7465 7874 2920 2626 2065 6368 6f20 2224  text) && echo "$
-00019f30: 7322 2026 2620 6563 686f 3b20 5b5b 202d  s" && echo; [[ -
-00019f40: 7a20 2224 7322 205d 5d20 7c7c 2065 6368  z "$s" ]] || ech
-00019f50: 6f20 2224 7322 207c 2067 7265 7020 2d76  o "$s" | grep -v
-00019f60: 202d 4520 2270 656e 6469 6e67 7c72 756e   -E "pending|run
-00019f70: 6e69 6e67 7c73 746f 7070 6564 7c73 746f  ning|stopped|sto
-00019f80: 7070 696e 6722 270a 2020 2020 2020 2020  pping"'.        
-00019f90: 2020 2020 292c 0a20 2020 2020 2020 205d      ),.        ]
-00019fa0: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
-00019fb0: 743d 3235 202a 2036 3029 0a20 2020 2072  t=25 * 60).    r
-00019fc0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-00019fd0: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
-00019fe0: 2e67 6370 0a40 7079 7465 7374 2e6d 6172  .gcp.@pytest.mar
-00019ff0: 6b2e 6d61 6e61 6765 645f 7370 6f74 0a64  k.managed_spot.d
-0001a000: 6566 2074 6573 745f 7370 6f74 5f63 616e  ef test_spot_can
-0001a010: 6365 6c6c 6174 696f 6e5f 6763 7028 293a  cellation_gcp():
-0001a020: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-0001a030: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-0001a040: 2020 2020 6e61 6d65 5f33 203d 2066 277b      name_3 = f'{
-0001a050: 6e61 6d65 7d2d 3327 0a20 2020 206e 616d  name}-3'.    nam
-0001a060: 655f 335f 6f6e 5f63 6c6f 7564 203d 2063  e_3_on_cloud = c
-0001a070: 6f6d 6d6f 6e5f 7574 696c 732e 6d61 6b65  ommon_utils.make
-0001a080: 5f63 6c75 7374 6572 5f6e 616d 655f 6f6e  _cluster_name_on
-0001a090: 5f63 6c6f 7564 280a 2020 2020 2020 2020  _cloud(.        
-0001a0a0: 6e61 6d65 5f33 2c20 7370 6f74 2e53 504f  name_3, spot.SPO
-0001a0b0: 545f 434c 5553 5445 525f 4e41 4d45 5f50  T_CLUSTER_NAME_P
-0001a0c0: 5245 4649 585f 4c45 4e47 5448 2c20 6164  REFIX_LENGTH, ad
-0001a0d0: 645f 7573 6572 5f68 6173 683d 4661 6c73  d_user_hash=Fals
-0001a0e0: 6529 0a20 2020 207a 6f6e 6520 3d20 2775  e).    zone = 'u
-0001a0f0: 732d 7765 7374 332d 6227 0a20 2020 2071  s-west3-b'.    q
-0001a100: 7565 7279 5f73 7461 7465 5f63 6d64 203d  uery_state_cmd =
-0001a110: 2028 0a20 2020 2020 2020 2027 6763 6c6f   (.        'gclo
-0001a120: 7564 2063 6f6d 7075 7465 2069 6e73 7461  ud compute insta
-0001a130: 6e63 6573 206c 6973 7420 270a 2020 2020  nces list '.    
-0001a140: 2020 2020 6627 2d2d 6669 6c74 6572 3d22      f'--filter="
-0001a150: 286c 6162 656c 732e 7261 792d 636c 7573  (labels.ray-clus
-0001a160: 7465 722d 6e61 6d65 3a7b 6e61 6d65 5f33  ter-name:{name_3
-0001a170: 5f6f 6e5f 636c 6f75 647d 2922 2027 0a20  _on_cloud})" '. 
-0001a180: 2020 2020 2020 2027 2d2d 666f 726d 6174         '--format
-0001a190: 3d22 7661 6c75 6528 7374 6174 7573 2922  ="value(status)"
-0001a1a0: 2729 0a20 2020 2071 7565 7279 5f63 6d64  ').    query_cmd
-0001a1b0: 203d 2028 6627 6763 6c6f 7564 2063 6f6d   = (f'gcloud com
-0001a1c0: 7075 7465 2069 6e73 7461 6e63 6573 206c  pute instances l
-0001a1d0: 6973 7420 2d2d 6669 6c74 6572 3d27 0a20  ist --filter='. 
-0001a1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a1f0: 6627 2228 6c61 6265 6c73 2e72 6179 2d63  f'"(labels.ray-c
-0001a200: 6c75 7374 6572 2d6e 616d 653a 7b6e 616d  luster-name:{nam
-0001a210: 655f 335f 6f6e 5f63 6c6f 7564 7d29 2220  e_3_on_cloud})" 
-0001a220: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0001a230: 2020 2066 272d 2d7a 6f6e 6573 3d7b 7a6f     f'--zones={zo
-0001a240: 6e65 7d20 2d2d 666f 726d 6174 3d22 7661  ne} --format="va
-0001a250: 6c75 6528 6e61 6d65 2922 2729 0a20 2020  lue(name)"').   
-0001a260: 2074 6572 6d69 6e61 7465 5f63 6d64 203d   terminate_cmd =
-0001a270: 2028 6627 6763 6c6f 7564 2063 6f6d 7075   (f'gcloud compu
-0001a280: 7465 2069 6e73 7461 6e63 6573 2064 656c  te instances del
-0001a290: 6574 6520 2d2d 7a6f 6e65 3d7b 7a6f 6e65  ete --zone={zone
-0001a2a0: 7d27 0a20 2020 2020 2020 2020 2020 2020  }'.             
-0001a2b0: 2020 2020 2020 2020 6627 202d 2d71 7569          f' --qui
-0001a2c0: 6574 2024 287b 7175 6572 795f 636d 647d  et $({query_cmd}
-0001a2d0: 2927 290a 2020 2020 7465 7374 203d 2054  )').    test = T
-0001a2e0: 6573 7428 0a20 2020 2020 2020 2027 7370  est(.        'sp
-0001a2f0: 6f74 5f63 616e 6365 6c6c 6174 696f 6e5f  ot_cancellation_
-0001a300: 6763 7027 2c0a 2020 2020 2020 2020 5b0a  gcp',.        [.
-0001a310: 2020 2020 2020 2020 2020 2020 2320 5465              # Te
-0001a320: 7374 2063 616e 6365 6c6c 6174 696f 6e20  st cancellation 
-0001a330: 6475 7269 6e67 2073 706f 7420 636c 7573  during spot clus
-0001a340: 7465 7220 6265 696e 6720 6c61 756e 6368  ter being launch
-0001a350: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
-0001a360: 6627 736b 7920 7370 6f74 206c 6175 6e63  f'sky spot launc
-0001a370: 6820 2d2d 636c 6f75 6420 6763 7020 2d2d  h --cloud gcp --
-0001a380: 7a6f 6e65 207b 7a6f 6e65 7d20 2d6e 207b  zone {zone} -n {
-0001a390: 6e61 6d65 7d20 2273 6c65 6570 2031 3030  name} "sleep 100
-0001a3a0: 3022 2020 2d79 202d 6427 2c0a 2020 2020  0"  -y -d',.    
-0001a3b0: 2020 2020 2020 2020 2773 6c65 6570 2036          'sleep 6
-0001a3c0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
-0001a3d0: 6627 7b5f 5350 4f54 5f51 5545 5545 5f57  f'{_SPOT_QUEUE_W
-0001a3e0: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
-0001a3f0: 7d20 7c20 6865 6164 202d 6e31 207c 2067  } | head -n1 | g
-0001a400: 7265 7020 2253 5441 5254 494e 4722 272c  rep "STARTING"',
-0001a410: 0a20 2020 2020 2020 2020 2020 205f 5350  .            _SP
-0001a420: 4f54 5f43 414e 4345 4c5f 5741 4954 2e66  OT_CANCEL_WAIT.f
-0001a430: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d6e  ormat(job_name=n
-0001a440: 616d 6529 2c0a 2020 2020 2020 2020 2020  ame),.          
-0001a450: 2020 2773 6c65 6570 2035 272c 0a20 2020    'sleep 5',.   
-0001a460: 2020 2020 2020 2020 2066 277b 5f53 504f           f'{_SPO
-0001a470: 545f 5155 4555 455f 5741 4954 7d7c 2067  T_QUEUE_WAIT}| g
-0001a480: 7265 7020 7b6e 616d 657d 207c 2068 6561  rep {name} | hea
-0001a490: 6420 2d6e 3120 7c20 6772 6570 2022 4341  d -n1 | grep "CA
-0001a4a0: 4e43 454c 4c49 4e47 5c7c 4341 4e43 454c  NCELLING\|CANCEL
-0001a4b0: 4c45 4422 272c 0a20 2020 2020 2020 2020  LED"',.         
-0001a4c0: 2020 2027 736c 6565 7020 3132 3027 2c0a     'sleep 120',.
-0001a4d0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-0001a4e0: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
-0001a4f0: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
-0001a500: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
-0001a510: 2243 414e 4345 4c4c 4544 2227 2c0a 2020  "CANCELLED"',.  
-0001a520: 2020 2020 2020 2020 2020 2320 5465 7374            # Test
-0001a530: 2063 616e 6365 6c6c 696e 6720 7468 6520   cancelling the 
-0001a540: 7370 6f74 2063 6c75 7374 6572 2064 7572  spot cluster dur
-0001a550: 696e 6720 7370 6f74 206a 6f62 2062 6569  ing spot job bei
-0001a560: 6e67 2073 6574 7570 2e0a 2020 2020 2020  ng setup..      
-0001a570: 2020 2020 2020 6627 736b 7920 7370 6f74        f'sky spot
-0001a580: 206c 6175 6e63 6820 2d2d 636c 6f75 6420   launch --cloud 
-0001a590: 6763 7020 2d2d 7a6f 6e65 207b 7a6f 6e65  gcp --zone {zone
-0001a5a0: 7d20 2d6e 207b 6e61 6d65 7d2d 3220 7465  } -n {name}-2 te
-0001a5b0: 7374 732f 7465 7374 5f79 616d 6c73 2f74  sts/test_yamls/t
-0001a5c0: 6573 745f 6c6f 6e67 5f73 6574 7570 2e79  est_long_setup.y
-0001a5d0: 616d 6c20 202d 7920 2d64 272c 0a20 2020  aml  -y -d',.   
-0001a5e0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-0001a5f0: 3330 3027 2c0a 2020 2020 2020 2020 2020  300',.          
-0001a600: 2020 5f53 504f 545f 4341 4e43 454c 5f57    _SPOT_CANCEL_W
-0001a610: 4149 542e 666f 726d 6174 286a 6f62 5f6e  AIT.format(job_n
-0001a620: 616d 653d 6627 7b6e 616d 657d 2d32 2729  ame=f'{name}-2')
-0001a630: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-0001a640: 6c65 6570 2035 272c 0a20 2020 2020 2020  leep 5',.       
-0001a650: 2020 2020 2066 277b 5f53 504f 545f 5155       f'{_SPOT_QU
-0001a660: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
-0001a670: 7b6e 616d 657d 2d32 207c 2068 6561 6420  {name}-2 | head 
-0001a680: 2d6e 3120 7c20 6772 6570 2022 4341 4e43  -n1 | grep "CANC
-0001a690: 454c 4c49 4e47 5c7c 4341 4e43 454c 4c45  ELLING\|CANCELLE
-0001a6a0: 4422 272c 0a20 2020 2020 2020 2020 2020  D"',.           
-0001a6b0: 2027 736c 6565 7020 3132 3027 2c0a 2020   'sleep 120',.  
-0001a6c0: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-0001a6d0: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
-0001a6e0: 6772 6570 207b 6e61 6d65 7d2d 3220 7c20  grep {name}-2 | 
-0001a6f0: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
-0001a700: 2243 414e 4345 4c4c 4544 2227 2c0a 2020  "CANCELLED"',.  
-0001a710: 2020 2020 2020 2020 2020 2320 5465 7374            # Test
-0001a720: 2063 616e 6365 6c6c 6174 696f 6e20 6475   cancellation du
-0001a730: 7269 6e67 2073 706f 7420 6a6f 6220 6973  ring spot job is
-0001a740: 2072 6563 6f76 6572 696e 672e 0a20 2020   recovering..   
-0001a750: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-0001a760: 706f 7420 6c61 756e 6368 202d 2d63 6c6f  pot launch --clo
-0001a770: 7564 2067 6370 202d 2d7a 6f6e 6520 7b7a  ud gcp --zone {z
-0001a780: 6f6e 657d 202d 6e20 7b6e 616d 657d 2d33  one} -n {name}-3
-0001a790: 2022 736c 6565 7020 3130 3030 2220 202d   "sleep 1000"  -
-0001a7a0: 7920 2d64 272c 0a20 2020 2020 2020 2020  y -d',.         
-0001a7b0: 2020 2027 736c 6565 7020 3330 3027 2c0a     'sleep 300',.
-0001a7c0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-0001a7d0: 5350 4f54 5f51 5545 5545 5f57 4149 547d  SPOT_QUEUE_WAIT}
-0001a7e0: 7c20 6772 6570 207b 6e61 6d65 7d2d 3320  | grep {name}-3 
-0001a7f0: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
-0001a800: 7020 2252 554e 4e49 4e47 2227 2c0a 2020  p "RUNNING"',.  
-0001a810: 2020 2020 2020 2020 2020 2320 5465 726d            # Term
-0001a820: 696e 6174 6520 7468 6520 636c 7573 7465  inate the cluste
-0001a830: 7220 6d61 6e75 616c 6c79 2e0a 2020 2020  r manually..    
-0001a840: 2020 2020 2020 2020 7465 726d 696e 6174          terminat
-0001a850: 655f 636d 642c 0a20 2020 2020 2020 2020  e_cmd,.         
-0001a860: 2020 2027 736c 6565 7020 3830 272c 0a20     'sleep 80',. 
-0001a870: 2020 2020 2020 2020 2020 2066 277b 5f53             f'{_S
-0001a880: 504f 545f 5155 4555 455f 5741 4954 7d7c  POT_QUEUE_WAIT}|
-0001a890: 2067 7265 7020 7b6e 616d 657d 2d33 207c   grep {name}-3 |
-0001a8a0: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
-0001a8b0: 2022 5245 434f 5645 5249 4e47 2227 2c0a   "RECOVERING"',.
-0001a8c0: 2020 2020 2020 2020 2020 2020 5f53 504f              _SPO
-0001a8d0: 545f 4341 4e43 454c 5f57 4149 542e 666f  T_CANCEL_WAIT.fo
-0001a8e0: 726d 6174 286a 6f62 5f6e 616d 653d 6627  rmat(job_name=f'
-0001a8f0: 7b6e 616d 657d 2d33 2729 2c0a 2020 2020  {name}-3'),.    
-0001a900: 2020 2020 2020 2020 2773 6c65 6570 2035          'sleep 5
-0001a910: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0001a920: 277b 5f53 504f 545f 5155 4555 455f 5741  '{_SPOT_QUEUE_WA
-0001a930: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
-0001a940: 2d33 207c 2068 6561 6420 2d6e 3120 7c20  -3 | head -n1 | 
-0001a950: 6772 6570 2022 4341 4e43 454c 4c49 4e47  grep "CANCELLING
-0001a960: 5c7c 4341 4e43 454c 4c45 4422 272c 0a20  \|CANCELLED"',. 
-0001a970: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-0001a980: 7020 3132 3027 2c0a 2020 2020 2020 2020  p 120',.        
-0001a990: 2020 2020 6627 7b5f 5350 4f54 5f51 5545      f'{_SPOT_QUE
-0001a9a0: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
-0001a9b0: 6e61 6d65 7d2d 3320 7c20 6865 6164 202d  name}-3 | head -
-0001a9c0: 6e31 207c 2067 7265 7020 2243 414e 4345  n1 | grep "CANCE
-0001a9d0: 4c4c 4544 2227 2c0a 2020 2020 2020 2020  LLED"',.        
-0001a9e0: 2020 2020 2320 5468 6520 636c 7573 7465      # The cluste
-0001a9f0: 7220 7368 6f75 6c64 2062 6520 7465 726d  r should be term
-0001aa00: 696e 6174 6564 2028 5354 4f50 5049 4e47  inated (STOPPING
-0001aa10: 2920 6166 7465 7220 6361 6e63 656c 6c61  ) after cancella
-0001aa20: 7469 6f6e 2e20 5765 2064 6f6e 2774 2075  tion. We don't u
-0001aa30: 7365 2074 6865 2060 3d60 206f 7065 7261  se the `=` opera
-0001aa40: 746f 7220 6865 7265 2062 6563 6175 7365  tor here because
-0001aa50: 0a20 2020 2020 2020 2020 2020 2023 2074  .            # t
-0001aa60: 6865 7265 2063 616e 2062 6520 6d75 6c74  here can be mult
-0001aa70: 6970 6c65 2056 4d20 7769 7468 2074 6865  iple VM with the
-0001aa80: 2073 616d 6520 6e61 6d65 2064 7565 2074   same name due t
-0001aa90: 6f20 7468 6520 7265 636f 7665 7279 2e0a  o the recovery..
-0001aaa0: 2020 2020 2020 2020 2020 2020 2866 2773              (f's
-0001aab0: 3d24 287b 7175 6572 795f 7374 6174 655f  =$({query_state_
-0001aac0: 636d 647d 2920 2626 2065 6368 6f20 2224  cmd}) && echo "$
-0001aad0: 7322 2026 2620 6563 686f 3b20 5b5b 202d  s" && echo; [[ -
-0001aae0: 7a20 2224 7322 205d 5d20 7c7c 2065 6368  z "$s" ]] || ech
-0001aaf0: 6f20 2224 7322 207c 2067 7265 7020 2d76  o "$s" | grep -v
-0001ab00: 202d 4520 2250 524f 5649 5349 4f4e 494e   -E "PROVISIONIN
-0001ab10: 477c 5354 4147 494e 477c 5255 4e4e 494e  G|STAGING|RUNNIN
-0001ab20: 477c 5245 5041 4952 494e 477c 5445 524d  G|REPAIRING|TERM
-0001ab30: 494e 4154 4544 7c53 5553 5045 4e44 494e  INATED|SUSPENDIN
-0001ab40: 477c 5355 5350 454e 4445 447c 5355 5350  G|SUSPENDED|SUSP
-0001ab50: 454e 4445 4422 270a 2020 2020 2020 2020  ENDED"'.        
-0001ab60: 2020 2020 292c 0a20 2020 2020 2020 205d      ),.        ]
-0001ab70: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
-0001ab80: 743d 3235 202a 2036 3029 0a20 2020 2072  t=25 * 60).    r
-0001ab90: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-0001aba0: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
-0001abb0: 2054 6573 7469 6e67 2073 746f 7261 6765   Testing storage
-0001abc0: 2066 6f72 206d 616e 6167 6564 2073 706f   for managed spo
-0001abd0: 7420 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079  t ----------.@py
-0001abe0: 7465 7374 2e6d 6172 6b2e 6e6f 5f66 6c75  test.mark.no_flu
-0001abf0: 6964 7374 6163 6b20 2023 2046 6c75 6964  idstack  # Fluid
-0001ac00: 7374 6163 6b20 646f 6573 206e 6f74 2073  stack does not s
-0001ac10: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
-0001ac20: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
-0001ac30: 726b 2e6e 6f5f 617a 7572 6520 2023 2041  rk.no_azure  # A
-0001ac40: 7a75 7265 2064 6f65 7320 6e6f 7420 7375  zure does not su
-0001ac50: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
-0001ac60: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
-0001ac70: 6b2e 6e6f 5f6c 616d 6264 615f 636c 6f75  k.no_lambda_clou
-0001ac80: 6420 2023 204c 616d 6264 6120 436c 6f75  d  # Lambda Clou
-0001ac90: 6420 646f 6573 206e 6f74 2073 7570 706f  d does not suppo
-0001aca0: 7274 2073 706f 7420 696e 7374 616e 6365  rt spot instance
-0001acb0: 730a 4070 7974 6573 742e 6d61 726b 2e6e  s.@pytest.mark.n
-0001acc0: 6f5f 6962 6d20 2023 2049 424d 2043 6c6f  o_ibm  # IBM Clo
-0001acd0: 7564 2064 6f65 7320 6e6f 7420 7375 7070  ud does not supp
-0001ace0: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
-0001acf0: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
-0001ad00: 6e6f 5f73 6370 2020 2320 5343 5020 646f  no_scp  # SCP do
-0001ad10: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
-0001ad20: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
-0001ad30: 7974 6573 742e 6d61 726b 2e6e 6f5f 6b75  ytest.mark.no_ku
-0001ad40: 6265 726e 6574 6573 2020 2320 4b75 6265  bernetes  # Kube
-0001ad50: 726e 6574 6573 2064 6f65 7320 6e6f 7420  rnetes does not 
-0001ad60: 6861 7665 2061 206e 6f74 696f 6e20 6f66  have a notion of
-0001ad70: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
-0001ad80: 4070 7974 6573 742e 6d61 726b 2e6d 616e  @pytest.mark.man
-0001ad90: 6167 6564 5f73 706f 740a 6465 6620 7465  aged_spot.def te
-0001ada0: 7374 5f73 706f 745f 7374 6f72 6167 6528  st_spot_storage(
-0001adb0: 6765 6e65 7269 635f 636c 6f75 643a 2073  generic_cloud: s
-0001adc0: 7472 293a 0a20 2020 2022 2222 5465 7374  tr):.    """Test
-0001add0: 2073 746f 7261 6765 2077 6974 6820 6d61   storage with ma
-0001ade0: 6e61 6765 6420 7370 6f74 2222 220a 2020  naged spot""".  
-0001adf0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-0001ae00: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-0001ae10: 2079 616d 6c5f 7374 7220 3d20 7061 7468   yaml_str = path
-0001ae20: 6c69 622e 5061 7468 280a 2020 2020 2020  lib.Path(.      
-0001ae30: 2020 2765 7861 6d70 6c65 732f 6d61 6e61    'examples/mana
-0001ae40: 6765 645f 7370 6f74 5f77 6974 685f 7374  ged_spot_with_st
-0001ae50: 6f72 6167 652e 7961 6d6c 2729 2e72 6561  orage.yaml').rea
-0001ae60: 645f 7465 7874 2829 0a20 2020 2073 746f  d_text().    sto
-0001ae70: 7261 6765 5f6e 616d 6520 3d20 6627 736b  rage_name = f'sk
-0001ae80: 792d 7465 7374 2d7b 696e 7428 7469 6d65  y-test-{int(time
-0001ae90: 2e74 696d 6528 2929 7d27 0a20 2020 2079  .time())}'.    y
-0001aea0: 616d 6c5f 7374 7220 3d20 7961 6d6c 5f73  aml_str = yaml_s
-0001aeb0: 7472 2e72 6570 6c61 6365 2827 736b 792d  tr.replace('sky-
-0001aec0: 776f 726b 6469 722d 7a68 7775 272c 2073  workdir-zhwu', s
-0001aed0: 746f 7261 6765 5f6e 616d 6529 0a20 2020  torage_name).   
-0001aee0: 2077 6974 6820 7465 6d70 6669 6c65 2e4e   with tempfile.N
-0001aef0: 616d 6564 5465 6d70 6f72 6172 7946 696c  amedTemporaryFil
-0001af00: 6528 7375 6666 6978 3d27 2e79 616d 6c27  e(suffix='.yaml'
-0001af10: 2c20 6d6f 6465 3d27 7727 2920 6173 2066  , mode='w') as f
-0001af20: 3a0a 2020 2020 2020 2020 662e 7772 6974  :.        f.writ
-0001af30: 6528 7961 6d6c 5f73 7472 290a 2020 2020  e(yaml_str).    
-0001af40: 2020 2020 662e 666c 7573 6828 290a 2020      f.flush().  
-0001af50: 2020 2020 2020 6669 6c65 5f70 6174 6820        file_path 
-0001af60: 3d20 662e 6e61 6d65 0a20 2020 2020 2020  = f.name.       
-0001af70: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-0001af80: 2020 2020 2020 2020 2020 2773 706f 745f            'spot_
-0001af90: 7374 6f72 6167 6527 2c0a 2020 2020 2020  storage',.      
-0001afa0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-0001afb0: 2020 2020 2020 2020 2a73 746f 7261 6765          *storage
-0001afc0: 5f73 6574 7570 5f63 6f6d 6d61 6e64 732c  _setup_commands,
-0001afd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001afe0: 2066 2773 6b79 2073 706f 7420 6c61 756e   f'sky spot laun
-0001aff0: 6368 202d 6e20 7b6e 616d 657d 202d 2d63  ch -n {name} --c
-0001b000: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
-0001b010: 6f75 647d 207b 6669 6c65 5f70 6174 687d  oud} {file_path}
-0001b020: 202d 7927 2c0a 2020 2020 2020 2020 2020   -y',.          
-0001b030: 2020 2020 2020 2773 6c65 6570 2036 3027        'sleep 60'
-0001b040: 2c20 2023 2057 6169 7420 7468 6520 7370  ,  # Wait the sp
-0001b050: 6f74 2071 7565 7565 2074 6f20 6265 2075  ot queue to be u
-0001b060: 7064 6174 6564 0a20 2020 2020 2020 2020  pdated.         
-0001b070: 2020 2020 2020 2066 277b 5f53 504f 545f         f'{_SPOT_
-0001b080: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
-0001b090: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
-0001b0a0: 5355 4343 4545 4445 4427 2c0a 2020 2020  SUCCEEDED',.    
-0001b0b0: 2020 2020 2020 2020 2020 2020 6627 5b20              f'[ 
-0001b0c0: 2428 6177 7320 7333 6170 6920 6c69 7374  $(aws s3api list
-0001b0d0: 2d62 7563 6b65 7473 202d 2d71 7565 7279  -buckets --query
-0001b0e0: 2022 4275 636b 6574 735b 3f63 6f6e 7461   "Buckets[?conta
-0001b0f0: 696e 7328 4e61 6d65 2c20 5c27 7b73 746f  ins(Name, \'{sto
-0001b100: 7261 6765 5f6e 616d 657d 5c27 295d 2e4e  rage_name}\')].N
-0001b110: 616d 6522 202d 2d6f 7574 7075 7420 7465  ame" --output te
-0001b120: 7874 207c 2077 6320 2d6c 2920 2d65 7120  xt | wc -l) -eq 
-0001b130: 3020 5d27 0a20 2020 2020 2020 2020 2020  0 ]'.           
-0001b140: 205d 2c0a 2020 2020 2020 2020 2020 2020   ],.            
-0001b150: 5f53 504f 545f 4341 4e43 454c 5f57 4149  _SPOT_CANCEL_WAI
-0001b160: 542e 666f 726d 6174 286a 6f62 5f6e 616d  T.format(job_nam
-0001b170: 653d 6e61 6d65 292c 0a20 2020 2020 2020  e=name),.       
-0001b180: 2020 2020 2023 2049 6e63 7265 6173 6520       # Increase 
-0001b190: 7469 6d65 6f75 7420 7369 6e63 6520 736b  timeout since sk
-0001b1a0: 7920 7370 6f74 2071 7565 7565 202d 7220  y spot queue -r 
-0001b1b0: 6361 6e20 6265 2062 6c6f 636b 6564 2062  can be blocked b
-0001b1c0: 7920 6f74 6865 7220 7370 6f74 2074 6573  y other spot tes
-0001b1d0: 7473 2e0a 2020 2020 2020 2020 2020 2020  ts..            
-0001b1e0: 7469 6d65 6f75 743d 3230 202a 2036 302c  timeout=20 * 60,
-0001b1f0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-0001b200: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-0001b210: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
-0001b220: 2d2d 2d2d 2054 6573 7469 6e67 2073 706f  ---- Testing spo
-0001b230: 7420 5450 5520 2d2d 2d2d 2d2d 2d2d 2d2d  t TPU ----------
-0001b240: 0a40 7079 7465 7374 2e6d 6172 6b2e 6763  .@pytest.mark.gc
-0001b250: 700a 4070 7974 6573 742e 6d61 726b 2e6d  p.@pytest.mark.m
-0001b260: 616e 6167 6564 5f73 706f 740a 4070 7974  anaged_spot.@pyt
-0001b270: 6573 742e 6d61 726b 2e74 7075 0a64 6566  est.mark.tpu.def
-0001b280: 2074 6573 745f 7370 6f74 5f74 7075 2829   test_spot_tpu()
-0001b290: 3a0a 2020 2020 2222 2254 6573 7420 6d61  :.    """Test ma
-0001b2a0: 6e61 6765 6420 7370 6f74 206f 6e20 5450  naged spot on TP
-0001b2b0: 552e 2222 220a 2020 2020 6e61 6d65 203d  U.""".    name =
-0001b2c0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
-0001b2d0: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
-0001b2e0: 5465 7374 280a 2020 2020 2020 2020 2774  Test(.        't
-0001b2f0: 6573 742d 7370 6f74 2d74 7075 272c 0a20  est-spot-tpu',. 
-0001b300: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-0001b310: 2020 2020 2066 2773 6b79 2073 706f 7420       f'sky spot 
-0001b320: 6c61 756e 6368 202d 6e20 7b6e 616d 657d  launch -n {name}
-0001b330: 2065 7861 6d70 6c65 732f 7470 752f 7470   examples/tpu/tp
-0001b340: 7576 6d5f 6d6e 6973 742e 7961 6d6c 202d  uvm_mnist.yaml -
-0001b350: 7920 2d64 272c 0a20 2020 2020 2020 2020  y -d',.         
-0001b360: 2020 2027 736c 6565 7020 3527 2c0a 2020     'sleep 5',.  
-0001b370: 2020 2020 2020 2020 2020 6627 7b5f 5350            f'{_SP
-0001b380: 4f54 5f51 5545 5545 5f57 4149 547d 7c20  OT_QUEUE_WAIT}| 
-0001b390: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
-0001b3a0: 6164 202d 6e31 207c 2067 7265 7020 5354  ad -n1 | grep ST
-0001b3b0: 4152 5449 4e47 272c 0a20 2020 2020 2020  ARTING',.       
-0001b3c0: 2020 2020 2027 736c 6565 7020 3834 3027       'sleep 840'
-0001b3d0: 2c20 2023 2054 5055 2074 616b 6573 2061  ,  # TPU takes a
-0001b3e0: 2077 6869 6c65 2074 6f20 6c61 756e 6368   while to launch
-0001b3f0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-0001b400: 5f53 504f 545f 5155 4555 455f 5741 4954  _SPOT_QUEUE_WAIT
-0001b410: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
-0001b420: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
-0001b430: 2022 5255 4e4e 494e 475c 7c53 5543 4345   "RUNNING\|SUCCE
-0001b440: 4544 4544 2227 2c0a 2020 2020 2020 2020  EDED"',.        
-0001b450: 5d2c 0a20 2020 2020 2020 205f 5350 4f54  ],.        _SPOT
-0001b460: 5f43 414e 4345 4c5f 5741 4954 2e66 6f72  _CANCEL_WAIT.for
-0001b470: 6d61 7428 6a6f 625f 6e61 6d65 3d6e 616d  mat(job_name=nam
-0001b480: 6529 2c0a 2020 2020 2020 2020 2320 496e  e),.        # In
-0001b490: 6372 6561 7365 2074 696d 656f 7574 2073  crease timeout s
-0001b4a0: 696e 6365 2073 6b79 2073 706f 7420 7175  ince sky spot qu
-0001b4b0: 6575 6520 2d72 2063 616e 2062 6520 626c  eue -r can be bl
-0001b4c0: 6f63 6b65 6420 6279 206f 7468 6572 2073  ocked by other s
-0001b4d0: 706f 7420 7465 7374 732e 0a20 2020 2020  pot tests..     
-0001b4e0: 2020 2074 696d 656f 7574 3d32 3020 2a20     timeout=20 * 
-0001b4f0: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
-0001b500: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-0001b510: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
-0001b520: 5465 7374 696e 6720 656e 7620 666f 7220  Testing env for 
-0001b530: 7370 6f74 202d 2d2d 2d2d 2d2d 2d2d 2d0a  spot ----------.
-0001b540: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
-0001b550: 666c 7569 6473 7461 636b 2020 2320 466c  fluidstack  # Fl
-0001b560: 7569 6473 7461 636b 2064 6f65 7320 6e6f  uidstack does no
-0001b570: 7420 7375 7070 6f72 7420 7370 6f74 2069  t support spot i
-0001b580: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
-0001b590: 2e6d 6172 6b2e 6e6f 5f61 7a75 7265 2020  .mark.no_azure  
-0001b5a0: 2320 417a 7572 6520 646f 6573 206e 6f74  # Azure does not
-0001b5b0: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
-0001b5c0: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
-0001b5d0: 6d61 726b 2e6e 6f5f 6c61 6d62 6461 5f63  mark.no_lambda_c
-0001b5e0: 6c6f 7564 2020 2320 4c61 6d62 6461 2043  loud  # Lambda C
-0001b5f0: 6c6f 7564 2064 6f65 7320 6e6f 7420 7375  loud does not su
-0001b600: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
-0001b610: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
-0001b620: 6b2e 6e6f 5f69 626d 2020 2320 4942 4d20  k.no_ibm  # IBM 
-0001b630: 436c 6f75 6420 646f 6573 206e 6f74 2073  Cloud does not s
-0001b640: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
-0001b650: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
-0001b660: 726b 2e6e 6f5f 7363 7020 2023 2053 4350  rk.no_scp  # SCP
-0001b670: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
-0001b680: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
-0001b690: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-0001b6a0: 5f6b 7562 6572 6e65 7465 7320 2023 204b  _kubernetes  # K
-0001b6b0: 7562 6572 6e65 7465 7320 646f 6573 206e  ubernetes does n
-0001b6c0: 6f74 2068 6176 6520 6120 6e6f 7469 6f6e  ot have a notion
-0001b6d0: 206f 6620 7370 6f74 2069 6e73 7461 6e63   of spot instanc
-0001b6e0: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
-0001b6f0: 6d61 6e61 6765 645f 7370 6f74 0a64 6566  managed_spot.def
-0001b700: 2074 6573 745f 7370 6f74 5f69 6e6c 696e   test_spot_inlin
-0001b710: 655f 656e 7628 6765 6e65 7269 635f 636c  e_env(generic_cl
-0001b720: 6f75 643a 2073 7472 293a 0a20 2020 2022  oud: str):.    "
-0001b730: 2222 5465 7374 2073 706f 7420 656e 7622  ""Test spot env"
-0001b740: 2222 0a20 2020 206e 616d 6520 3d20 5f67  "".    name = _g
-0001b750: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-0001b760: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
-0001b770: 7428 0a20 2020 2020 2020 2027 7465 7374  t(.        'test
-0001b780: 2d73 706f 742d 696e 6c69 6e65 2d65 6e76  -spot-inline-env
-0001b790: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
-0001b7a0: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
-0001b7b0: 706f 7420 6c61 756e 6368 202d 6e20 7b6e  pot launch -n {n
-0001b7c0: 616d 657d 202d 7920 2d2d 636c 6f75 6420  ame} -y --cloud 
-0001b7d0: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
-0001b7e0: 2d2d 656e 7620 5445 5354 5f45 4e56 3d22  --env TEST_ENV="
-0001b7f0: 6865 6c6c 6f20 776f 726c 6422 202d 2d20  hello world" -- 
-0001b800: 2228 5b5b 2021 202d 7a20 5c5c 225c 2454  "([[ ! -z \\"\$T
-0001b810: 4553 545f 454e 565c 5c22 205d 5d20 2626  EST_ENV\\" ]] &&
-0001b820: 205b 5b20 2120 2d7a 205c 5c22 5c24 534b   [[ ! -z \\"\$SK
-0001b830: 5950 494c 4f54 5f4e 4f44 455f 4950 535c  YPILOT_NODE_IPS\
-0001b840: 5c22 205d 5d20 2626 205b 5b20 2120 2d7a  \" ]] && [[ ! -z
-0001b850: 205c 5c22 5c24 534b 5950 494c 4f54 5f4e   \\"\$SKYPILOT_N
-0001b860: 4f44 455f 5241 4e4b 5c5c 2220 5d5d 2920  ODE_RANK\\" ]]) 
-0001b870: 7c7c 2065 7869 7420 3122 272c 0a20 2020  || exit 1"',.   
-0001b880: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
-0001b890: 3230 272c 0a20 2020 2020 2020 2020 2020  20',.           
-0001b8a0: 2066 277b 5f53 504f 545f 5155 4555 455f   f'{_SPOT_QUEUE_
-0001b8b0: 5741 4954 7d20 7c20 6772 6570 207b 6e61  WAIT} | grep {na
-0001b8c0: 6d65 7d20 7c20 6772 6570 2053 5543 4345  me} | grep SUCCE
-0001b8d0: 4544 4544 272c 0a20 2020 2020 2020 205d  EDED',.        ]
-0001b8e0: 2c0a 2020 2020 2020 2020 5f53 504f 545f  ,.        _SPOT_
-0001b8f0: 4341 4e43 454c 5f57 4149 542e 666f 726d  CANCEL_WAIT.form
-0001b900: 6174 286a 6f62 5f6e 616d 653d 6e61 6d65  at(job_name=name
-0001b910: 292c 0a20 2020 2020 2020 2023 2049 6e63  ),.        # Inc
-0001b920: 7265 6173 6520 7469 6d65 6f75 7420 7369  rease timeout si
-0001b930: 6e63 6520 736b 7920 7370 6f74 2071 7565  nce sky spot que
-0001b940: 7565 202d 7220 6361 6e20 6265 2062 6c6f  ue -r can be blo
-0001b950: 636b 6564 2062 7920 6f74 6865 7220 7370  cked by other sp
-0001b960: 6f74 2074 6573 7473 2e0a 2020 2020 2020  ot tests..      
-0001b970: 2020 7469 6d65 6f75 743d 3230 202a 2036    timeout=20 * 6
-0001b980: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
-0001b990: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-0001b9a0: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054  ..# ---------- T
-0001b9b0: 6573 7469 6e67 2065 6e76 202d 2d2d 2d2d  esting env -----
-0001b9c0: 2d2d 2d2d 2d0a 6465 6620 7465 7374 5f69  -----.def test_i
-0001b9d0: 6e6c 696e 655f 656e 7628 6765 6e65 7269  nline_env(generi
-0001b9e0: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
-0001b9f0: 2020 2022 2222 5465 7374 2065 6e76 2222     """Test env""
-0001ba00: 220a 2020 2020 6e61 6d65 203d 205f 6765  ".    name = _ge
-0001ba10: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
-0001ba20: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-0001ba30: 280a 2020 2020 2020 2020 2774 6573 742d  (.        'test-
-0001ba40: 696e 6c69 6e65 2d65 6e76 272c 0a20 2020  inline-env',.   
-0001ba50: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-0001ba60: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
-0001ba70: 2d63 207b 6e61 6d65 7d20 2d79 202d 2d63  -c {name} -y --c
-0001ba80: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
-0001ba90: 6f75 647d 202d 2d65 6e76 2054 4553 545f  oud} --env TEST_
-0001baa0: 454e 563d 2268 656c 6c6f 2077 6f72 6c64  ENV="hello world
-0001bab0: 2220 2d2d 2022 285b 5b20 2120 2d7a 205c  " -- "([[ ! -z \
-0001bac0: 5c22 5c24 5445 5354 5f45 4e56 5c5c 2220  \"\$TEST_ENV\\" 
-0001bad0: 5d5d 2026 2620 5b5b 2021 202d 7a20 5c5c  ]] && [[ ! -z \\
-0001bae0: 225c 2453 4b59 5049 4c4f 545f 4e4f 4445  "\$SKYPILOT_NODE
-0001baf0: 5f49 5053 5c5c 2220 5d5d 2026 2620 5b5b  _IPS\\" ]] && [[
-0001bb00: 2021 202d 7a20 5c5c 225c 2453 4b59 5049   ! -z \\"\$SKYPI
-0001bb10: 4c4f 545f 4e4f 4445 5f52 414e 4b5c 5c22  LOT_NODE_RANK\\"
-0001bb20: 205d 5d29 207c 7c20 6578 6974 2031 2227   ]]) || exit 1"'
-0001bb30: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
-0001bb40: 6c65 6570 2032 3027 2c0a 2020 2020 2020  leep 20',.      
-0001bb50: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
-0001bb60: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
-0001bb70: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
-0001bb80: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
-0001bb90: 657d 202d 2d65 6e76 2054 4553 545f 454e  e} --env TEST_EN
-0001bba0: 5632 3d22 7375 6363 6573 7322 2022 285b  V2="success" "([
-0001bbb0: 5b20 2120 2d7a 205c 5c22 5c24 5445 5354  [ ! -z \\"\$TEST
-0001bbc0: 5f45 4e56 325c 5c22 205d 5d20 2626 205b  _ENV2\\" ]] && [
-0001bbd0: 5b20 2120 2d7a 205c 5c22 5c24 534b 5950  [ ! -z \\"\$SKYP
-0001bbe0: 494c 4f54 5f4e 4f44 455f 4950 535c 5c22  ILOT_NODE_IPS\\"
-0001bbf0: 205d 5d20 2626 205b 5b20 2120 2d7a 205c   ]] && [[ ! -z \
-0001bc00: 5c22 5c24 534b 5950 494c 4f54 5f4e 4f44  \"\$SKYPILOT_NOD
-0001bc10: 455f 5241 4e4b 5c5c 2220 5d5d 2920 7c7c  E_RANK\\" ]]) ||
-0001bc20: 2065 7869 7420 3122 272c 0a20 2020 2020   exit 1"',.     
-0001bc30: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
-0001bc40: 7320 7b6e 616d 657d 2032 202d 2d73 7461  s {name} 2 --sta
-0001bc50: 7475 7327 2c0a 2020 2020 2020 2020 5d2c  tus',.        ],
-0001bc60: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
-0001bc70: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
-0001bc80: 2020 2020 2020 2020 5f67 6574 5f74 696d          _get_tim
-0001bc90: 656f 7574 2867 656e 6572 6963 5f63 6c6f  eout(generic_clo
-0001bca0: 7564 292c 0a20 2020 2029 0a20 2020 2072  ud),.    ).    r
-0001bcb0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-0001bcc0: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
-0001bcd0: 2054 6573 7469 6e67 2065 6e76 2066 696c   Testing env fil
-0001bce0: 6520 2d2d 2d2d 2d2d 2d2d 2d2d 0a64 6566  e ----------.def
-0001bcf0: 2074 6573 745f 696e 6c69 6e65 5f65 6e76   test_inline_env
-0001bd00: 5f66 696c 6528 6765 6e65 7269 635f 636c  _file(generic_cl
-0001bd10: 6f75 643a 2073 7472 293a 0a20 2020 2022  oud: str):.    "
-0001bd20: 2222 5465 7374 2065 6e76 2222 220a 2020  ""Test env""".  
-0001bd30: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-0001bd40: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-0001bd50: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
-0001bd60: 2020 2020 2020 2774 6573 742d 696e 6c69        'test-inli
-0001bd70: 6e65 2d65 6e76 2d66 696c 6527 2c0a 2020  ne-env-file',.  
-0001bd80: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
-0001bd90: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
-0001bda0: 202d 6320 7b6e 616d 657d 202d 7920 2d2d   -c {name} -y --
-0001bdb0: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
-0001bdc0: 6c6f 7564 7d20 2d2d 656e 7620 5445 5354  loud} --env TEST
-0001bdd0: 5f45 4e56 3d22 6865 6c6c 6f20 776f 726c  _ENV="hello worl
-0001bde0: 6422 202d 2d20 2228 5b5b 2021 202d 7a20  d" -- "([[ ! -z 
-0001bdf0: 5c5c 225c 2454 4553 545f 454e 565c 5c22  \\"\$TEST_ENV\\"
-0001be00: 205d 5d20 2626 205b 5b20 2120 2d7a 205c   ]] && [[ ! -z \
-0001be10: 5c22 5c24 534b 5950 494c 4f54 5f4e 4f44  \"\$SKYPILOT_NOD
-0001be20: 455f 4950 535c 5c22 205d 5d20 2626 205b  E_IPS\\" ]] && [
-0001be30: 5b20 2120 2d7a 205c 5c22 5c24 534b 5950  [ ! -z \\"\$SKYP
-0001be40: 494c 4f54 5f4e 4f44 455f 5241 4e4b 5c5c  ILOT_NODE_RANK\\
-0001be50: 2220 5d5d 2920 7c7c 2065 7869 7420 3122  " ]]) || exit 1"
-0001be60: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0001be70: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-0001be80: 2031 202d 2d73 7461 7475 7327 2c0a 2020   1 --status',.  
-0001be90: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0001bea0: 6578 6563 207b 6e61 6d65 7d20 2d2d 656e  exec {name} --en
-0001beb0: 762d 6669 6c65 2065 7861 6d70 6c65 732f  v-file examples/
-0001bec0: 7361 6d70 6c65 5f64 6f74 656e 7620 2228  sample_dotenv "(
-0001bed0: 5b5b 2021 202d 7a20 5c5c 225c 2454 4553  [[ ! -z \\"\$TES
-0001bee0: 545f 454e 5632 5c5c 2220 5d5d 2026 2620  T_ENV2\\" ]] && 
-0001bef0: 5b5b 2021 202d 7a20 5c5c 225c 2453 4b59  [[ ! -z \\"\$SKY
-0001bf00: 5049 4c4f 545f 4e4f 4445 5f49 5053 5c5c  PILOT_NODE_IPS\\
-0001bf10: 2220 5d5d 2026 2620 5b5b 2021 202d 7a20  " ]] && [[ ! -z 
-0001bf20: 5c5c 225c 2453 4b59 5049 4c4f 545f 4e4f  \\"\$SKYPILOT_NO
-0001bf30: 4445 5f52 414e 4b5c 5c22 205d 5d29 207c  DE_RANK\\" ]]) |
-0001bf40: 7c20 6578 6974 2031 2227 2c0a 2020 2020  | exit 1"',.    
-0001bf50: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-0001bf60: 6773 207b 6e61 6d65 7d20 3220 2d2d 7374  gs {name} 2 --st
-0001bf70: 6174 7573 272c 0a20 2020 2020 2020 205d  atus',.        ]
-0001bf80: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-0001bf90: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
-0001bfa0: 0a20 2020 2020 2020 205f 6765 745f 7469  .        _get_ti
-0001bfb0: 6d65 6f75 7428 6765 6e65 7269 635f 636c  meout(generic_cl
-0001bfc0: 6f75 6429 2c0a 2020 2020 290a 2020 2020  oud),.    ).    
-0001bfd0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-0001bfe0: 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  t)...# ---------
-0001bff0: 2d20 5465 7374 696e 6720 6375 7374 6f6d  - Testing custom
-0001c000: 2069 6d61 6765 202d 2d2d 2d2d 2d2d 2d2d   image ---------
-0001c010: 2d0a 4070 7974 6573 742e 6d61 726b 2e61  -.@pytest.mark.a
-0001c020: 7773 0a64 6566 2074 6573 745f 6177 735f  ws.def test_aws_
-0001c030: 6375 7374 6f6d 5f69 6d61 6765 2829 3a0a  custom_image():.
-0001c040: 2020 2020 2222 2254 6573 7420 4157 5320      """Test AWS 
-0001c050: 6375 7374 6f6d 2069 6d61 6765 2222 220a  custom image""".
-0001c060: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-0001c070: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
-0001c080: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
-0001c090: 2020 2020 2020 2020 2774 6573 742d 6177          'test-aw
-0001c0a0: 732d 6375 7374 6f6d 2d69 6d61 6765 272c  s-custom-image',
-0001c0b0: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-0001c0c0: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
-0001c0d0: 6e63 6820 2d63 207b 6e61 6d65 7d20 2d2d  nch -c {name} --
-0001c0e0: 7265 7472 792d 756e 7469 6c2d 7570 202d  retry-until-up -
-0001c0f0: 7920 7465 7374 732f 7465 7374 5f79 616d  y tests/test_yam
-0001c100: 6c73 2f74 6573 745f 6375 7374 6f6d 5f69  ls/test_custom_i
-0001c110: 6d61 6765 2e79 616d 6c20 2d2d 636c 6f75  mage.yaml --clou
-0001c120: 6420 6177 7320 2d2d 7265 6769 6f6e 2075  d aws --region u
-0001c130: 732d 6561 7374 2d32 202d 2d69 6d61 6765  s-east-2 --image
-0001c140: 2d69 6420 616d 692d 3036 3264 6464 3930  -id ami-062ddd90
-0001c150: 6662 3666 3832 3637 6127 2c20 2023 204e  fb6f8267a',  # N
-0001c160: 7669 6469 6120 696d 6167 650a 2020 2020  vidia image.    
-0001c170: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-0001c180: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
-0001c190: 6174 7573 272c 0a20 2020 2020 2020 205d  atus',.        ]
-0001c1a0: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-0001c1b0: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
-0001c1c0: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
-0001c1d0: 3d33 3020 2a20 3630 2c0a 2020 2020 290a  =30 * 60,.    ).
-0001c1e0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-0001c1f0: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
-0001c200: 2e6d 6172 6b2e 6b75 6265 726e 6574 6573  .mark.kubernetes
-0001c210: 0a40 7079 7465 7374 2e6d 6172 6b2e 7061  .@pytest.mark.pa
-0001c220: 7261 6d65 7472 697a 6528 2269 6d61 6765  rametrize("image
-0001c230: 5f69 6422 2c20 5b0a 2020 2020 2264 6f63  _id", [.    "doc
-0001c240: 6b65 723a 6e76 6964 6961 2f63 7564 613a  ker:nvidia/cuda:
-0001c250: 3131 2e38 2e30 2d64 6576 656c 2d75 6275  11.8.0-devel-ubu
-0001c260: 6e74 7531 382e 3034 222c 0a20 2020 2022  ntu18.04",.    "
-0001c270: 646f 636b 6572 3a75 6275 6e74 753a 3138  docker:ubuntu:18
-0001c280: 2e30 3422 2c0a 5d29 0a64 6566 2074 6573  .04",.]).def tes
-0001c290: 745f 6b75 6265 726e 6574 6573 5f63 7573  t_kubernetes_cus
-0001c2a0: 746f 6d5f 696d 6167 6528 696d 6167 655f  tom_image(image_
-0001c2b0: 6964 293a 0a20 2020 2022 2222 5465 7374  id):.    """Test
-0001c2c0: 204b 7562 6572 6e65 7465 7320 6375 7374   Kubernetes cust
-0001c2d0: 6f6d 2069 6d61 6765 2222 220a 2020 2020  om image""".    
-0001c2e0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-0001c2f0: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
-0001c300: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-0001c310: 2020 2020 2774 6573 742d 6b75 6265 726e      'test-kubern
-0001c320: 6574 6573 2d63 7573 746f 6d2d 696d 6167  etes-custom-imag
-0001c330: 6527 2c0a 2020 2020 2020 2020 5b0a 2020  e',.        [.  
-0001c340: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0001c350: 6c61 756e 6368 202d 6320 7b6e 616d 657d  launch -c {name}
-0001c360: 202d 2d72 6574 7279 2d75 6e74 696c 2d75   --retry-until-u
-0001c370: 7020 2d79 2074 6573 7473 2f74 6573 745f  p -y tests/test_
-0001c380: 7961 6d6c 732f 7465 7374 5f63 7573 746f  yamls/test_custo
-0001c390: 6d5f 696d 6167 652e 7961 6d6c 202d 2d63  m_image.yaml --c
-0001c3a0: 6c6f 7564 206b 7562 6572 6e65 7465 7320  loud kubernetes 
-0001c3b0: 2d2d 696d 6167 652d 6964 207b 696d 6167  --image-id {imag
-0001c3c0: 655f 6964 7d20 2d2d 7265 6769 6f6e 204e  e_id} --region N
-0001c3d0: 6f6e 6520 2d2d 6770 7573 2054 343a 3127  one --gpus T4:1'
-0001c3e0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0001c3f0: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-0001c400: 3120 2d2d 7374 6174 7573 272c 0a20 2020  1 --status',.   
-0001c410: 2020 2020 2020 2020 2023 2054 7279 2065           # Try e
-0001c420: 7865 6320 746f 2072 756e 2061 6761 696e  xec to run again
-0001c430: 2061 6e64 2063 6865 636b 2069 6620 7468   and check if th
-0001c440: 6520 6c6f 6773 2061 7265 2070 7269 6e74  e logs are print
-0001c450: 6564 0a20 2020 2020 2020 2020 2020 2066  ed.            f
-0001c460: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
-0001c470: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
-0001c480: 732f 7465 7374 5f63 7573 746f 6d5f 696d  s/test_custom_im
-0001c490: 6167 652e 7961 6d6c 202d 2d63 6c6f 7564  age.yaml --cloud
-0001c4a0: 206b 7562 6572 6e65 7465 7320 2d2d 696d   kubernetes --im
-0001c4b0: 6167 652d 6964 207b 696d 6167 655f 6964  age-id {image_id
-0001c4c0: 7d20 2d2d 7265 6769 6f6e 204e 6f6e 6520  } --region None 
-0001c4d0: 2d2d 6770 7573 2054 343a 3120 7c20 6772  --gpus T4:1 | gr
-0001c4e0: 6570 2022 4865 6c6c 6f20 3130 3022 272c  ep "Hello 100"',
-0001c4f0: 0a20 2020 2020 2020 2020 2020 2023 204d  .            # M
-0001c500: 616b 6520 7375 7265 2073 7368 2069 7320  ake sure ssh is 
-0001c510: 776f 726b 696e 6720 7769 7468 2063 7573  working with cus
-0001c520: 746f 6d20 7573 6572 6e61 6d65 0a20 2020  tom username.   
-0001c530: 2020 2020 2020 2020 2066 2773 7368 207b           f'ssh {
-0001c540: 6e61 6d65 7d20 6563 686f 2068 6920 7c20  name} echo hi | 
-0001c550: 6772 6570 2068 6927 2c0a 2020 2020 2020  grep hi',.      
-0001c560: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
-0001c570: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
-0001c580: 7d27 2c0a 2020 2020 2020 2020 7469 6d65  }',.        time
-0001c590: 6f75 743d 3330 202a 2036 302c 0a20 2020  out=30 * 60,.   
-0001c5a0: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
-0001c5b0: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
-0001c5c0: 6573 742e 6d61 726b 2e73 6c6f 770a 6465  est.mark.slow.de
-0001c5d0: 6620 7465 7374 5f61 7a75 7265 5f73 7461  f test_azure_sta
-0001c5e0: 7274 5f73 746f 705f 7477 6f5f 6e6f 6465  rt_stop_two_node
-0001c5f0: 7328 293a 0a20 2020 206e 616d 6520 3d20  s():.    name = 
-0001c600: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-0001c610: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
-0001c620: 6573 7428 0a20 2020 2020 2020 2027 617a  est(.        'az
-0001c630: 7572 652d 7374 6172 742d 7374 6f70 2d74  ure-start-stop-t
-0001c640: 776f 2d6e 6f64 6573 272c 0a20 2020 2020  wo-nodes',.     
-0001c650: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-0001c660: 2066 2773 6b79 206c 6175 6e63 6820 2d2d   f'sky launch --
-0001c670: 6e75 6d2d 6e6f 6465 733d 3220 2d79 202d  num-nodes=2 -y -
-0001c680: 6320 7b6e 616d 657d 2065 7861 6d70 6c65  c {name} example
-0001c690: 732f 617a 7572 655f 7374 6172 745f 7374  s/azure_start_st
-0001c6a0: 6f70 2e79 616d 6c27 2c0a 2020 2020 2020  op.yaml',.      
-0001c6b0: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
-0001c6c0: 202d 2d6e 756d 2d6e 6f64 6573 3d32 207b   --num-nodes=2 {
-0001c6d0: 6e61 6d65 7d20 6578 616d 706c 6573 2f61  name} examples/a
-0001c6e0: 7a75 7265 5f73 7461 7274 5f73 746f 702e  zure_start_stop.
-0001c6f0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
-0001c700: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
-0001c710: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
-0001c720: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
-0001c730: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
-0001c740: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0001c750: 2073 746f 7020 2d79 207b 6e61 6d65 7d27   stop -y {name}'
-0001c760: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0001c770: 736b 7920 7374 6172 7420 2d79 207b 6e61  sky start -y {na
-0001c780: 6d65 7d27 2c0a 2020 2020 2020 2020 2020  me}',.          
-0001c790: 2020 6627 736b 7920 6578 6563 202d 2d6e    f'sky exec --n
-0001c7a0: 756d 2d6e 6f64 6573 3d32 207b 6e61 6d65  um-nodes=2 {name
-0001c7b0: 7d20 6578 616d 706c 6573 2f61 7a75 7265  } examples/azure
-0001c7c0: 5f73 7461 7274 5f73 746f 702e 7961 6d6c  _start_stop.yaml
-0001c7d0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
-0001c7e0: 2773 6b79 206c 6f67 7320 7b6e 616d 657d  'sky logs {name}
-0001c7f0: 2032 202d 2d73 7461 7475 7327 2c20 2023   2 --status',  #
-0001c800: 2045 6e73 7572 6520 7468 6520 6a6f 6220   Ensure the job 
-0001c810: 7375 6363 6565 6465 642e 0a20 2020 2020  succeeded..     
-0001c820: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
-0001c830: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
-0001c840: 657d 272c 0a20 2020 2020 2020 2074 696d  e}',.        tim
-0001c850: 656f 7574 3d33 3020 2a20 3630 2c20 2023  eout=30 * 60,  #
-0001c860: 2033 3020 6d69 6e73 2020 2869 7420 7461   30 mins  (it ta
-0001c870: 6b65 7320 6172 6f75 6e64 207e 3233 206d  kes around ~23 m
-0001c880: 696e 7329 0a20 2020 2029 0a20 2020 2072  ins).    ).    r
-0001c890: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
-0001c8a0: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
-0001c8b0: 2054 6573 7469 6e67 2065 6e76 2066 6f72   Testing env for
-0001c8c0: 2064 6973 6b20 7469 6572 202d 2d2d 2d2d   disk tier -----
-0001c8d0: 2d2d 2d2d 2d0a 4070 7974 6573 742e 6d61  -----.@pytest.ma
-0001c8e0: 726b 2e61 7773 0a64 6566 2074 6573 745f  rk.aws.def test_
-0001c8f0: 6177 735f 6469 736b 5f74 6965 7228 293a  aws_disk_tier():
-0001c900: 0a0a 2020 2020 6465 6620 5f67 6574 5f61  ..    def _get_a
-0001c910: 7773 5f71 7565 7279 5f63 6f6d 6d61 6e64  ws_query_command
-0001c920: 2872 6567 696f 6e2c 2069 6e73 7461 6e63  (region, instanc
-0001c930: 655f 6964 2c20 6669 656c 642c 2065 7870  e_id, field, exp
-0001c940: 6563 7465 6429 3a0a 2020 2020 2020 2020  ected):.        
-0001c950: 7265 7475 726e 2028 6627 6177 7320 6563  return (f'aws ec
-0001c960: 3220 6465 7363 7269 6265 2d76 6f6c 756d  2 describe-volum
-0001c970: 6573 202d 2d72 6567 696f 6e20 7b72 6567  es --region {reg
-0001c980: 696f 6e7d 2027 0a20 2020 2020 2020 2020  ion} '.         
-0001c990: 2020 2020 2020 2066 272d 2d66 696c 7465         f'--filte
-0001c9a0: 7273 204e 616d 653d 6174 7461 6368 6d65  rs Name=attachme
-0001c9b0: 6e74 2e69 6e73 7461 6e63 652d 6964 2c56  nt.instance-id,V
-0001c9c0: 616c 7565 733d 7b69 6e73 7461 6e63 655f  alues={instance_
-0001c9d0: 6964 7d20 270a 2020 2020 2020 2020 2020  id} '.          
-0001c9e0: 2020 2020 2020 6627 2d2d 7175 6572 7920        f'--query 
-0001c9f0: 566f 6c75 6d65 735b 2a5d 2e7b 6669 656c  Volumes[*].{fiel
-0001ca00: 647d 207c 2067 7265 7020 7b65 7870 6563  d} | grep {expec
-0001ca10: 7465 647d 203b 2027 290a 0a20 2020 2066  ted} ; ')..    f
-0001ca20: 6f72 2064 6973 6b5f 7469 6572 2069 6e20  or disk_tier in 
-0001ca30: 6c69 7374 2872 6573 6f75 7263 6573 5f75  list(resources_u
-0001ca40: 7469 6c73 2e44 6973 6b54 6965 7229 3a0a  tils.DiskTier):.
-0001ca50: 2020 2020 2020 2020 7370 6563 7320 3d20          specs = 
-0001ca60: 4157 532e 5f67 6574 5f64 6973 6b5f 7370  AWS._get_disk_sp
-0001ca70: 6563 7328 6469 736b 5f74 6965 7229 0a20  ecs(disk_tier). 
-0001ca80: 2020 2020 2020 206e 616d 6520 3d20 5f67         name = _g
-0001ca90: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
-0001caa0: 2920 2b20 272d 2720 2b20 6469 736b 5f74  ) + '-' + disk_t
-0001cab0: 6965 722e 7661 6c75 650a 2020 2020 2020  ier.value.      
-0001cac0: 2020 6e61 6d65 5f6f 6e5f 636c 6f75 6420    name_on_cloud 
-0001cad0: 3d20 636f 6d6d 6f6e 5f75 7469 6c73 2e6d  = common_utils.m
-0001cae0: 616b 655f 636c 7573 7465 725f 6e61 6d65  ake_cluster_name
-0001caf0: 5f6f 6e5f 636c 6f75 6428 0a20 2020 2020  _on_cloud(.     
-0001cb00: 2020 2020 2020 206e 616d 652c 2073 6b79         name, sky
-0001cb10: 2e41 5753 2e6d 6178 5f63 6c75 7374 6572  .AWS.max_cluster
-0001cb20: 5f6e 616d 655f 6c65 6e67 7468 2829 290a  _name_length()).
-0001cb30: 2020 2020 2020 2020 7265 6769 6f6e 203d          region =
-0001cb40: 2027 7573 2d65 6173 742d 3227 0a20 2020   'us-east-2'.   
-0001cb50: 2020 2020 2074 6573 7420 3d20 5465 7374       test = Test
-0001cb60: 280a 2020 2020 2020 2020 2020 2020 2761  (.            'a
-0001cb70: 7773 2d64 6973 6b2d 7469 6572 2d27 202b  ws-disk-tier-' +
-0001cb80: 2064 6973 6b5f 7469 6572 2e76 616c 7565   disk_tier.value
-0001cb90: 2c0a 2020 2020 2020 2020 2020 2020 5b0a  ,.            [.
-0001cba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cbb0: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-0001cbc0: 2d63 207b 6e61 6d65 7d20 2d2d 636c 6f75  -c {name} --clou
-0001cbd0: 6420 6177 7320 2d2d 7265 6769 6f6e 207b  d aws --region {
-0001cbe0: 7265 6769 6f6e 7d20 270a 2020 2020 2020  region} '.      
-0001cbf0: 2020 2020 2020 2020 2020 6627 2d2d 6469            f'--di
-0001cc00: 736b 2d74 6965 7220 7b64 6973 6b5f 7469  sk-tier {disk_ti
-0001cc10: 6572 2e76 616c 7565 7d20 6563 686f 2022  er.value} echo "
-0001cc20: 6865 6c6c 6f20 736b 7922 272c 0a20 2020  hello sky"',.   
-0001cc30: 2020 2020 2020 2020 2020 2020 2066 2769               f'i
-0001cc40: 643d 6061 7773 2065 6332 2064 6573 6372  d=`aws ec2 descr
-0001cc50: 6962 652d 696e 7374 616e 6365 7320 2d2d  ibe-instances --
-0001cc60: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
-0001cc70: 2d2d 6669 6c74 6572 7320 270a 2020 2020  --filters '.    
-0001cc80: 2020 2020 2020 2020 2020 2020 6627 4e61              f'Na
-0001cc90: 6d65 3d74 6167 3a72 6179 2d63 6c75 7374  me=tag:ray-clust
-0001cca0: 6572 2d6e 616d 652c 5661 6c75 6573 3d7b  er-name,Values={
-0001ccb0: 6e61 6d65 5f6f 6e5f 636c 6f75 647d 202d  name_on_cloud} -
-0001ccc0: 2d71 7565 7279 2027 0a20 2020 2020 2020  -query '.       
-0001ccd0: 2020 2020 2020 2020 2066 2752 6573 6572           f'Reser
-0001cce0: 7661 7469 6f6e 735b 5d2e 496e 7374 616e  vations[].Instan
-0001ccf0: 6365 735b 5d2e 496e 7374 616e 6365 4964  ces[].InstanceId
-0001cd00: 202d 2d6f 7574 7075 7420 7465 7874 603b   --output text`;
-0001cd10: 2027 202b 0a20 2020 2020 2020 2020 2020   ' +.           
-0001cd20: 2020 2020 205f 6765 745f 6177 735f 7175       _get_aws_qu
-0001cd30: 6572 795f 636f 6d6d 616e 6428 7265 6769  ery_command(regi
-0001cd40: 6f6e 2c20 2724 6964 272c 2027 566f 6c75  on, '$id', 'Volu
-0001cd50: 6d65 5479 7065 272c 0a20 2020 2020 2020  meType',.       
-0001cd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cd80: 7370 6563 735b 2764 6973 6b5f 7469 6572  specs['disk_tier
-0001cd90: 275d 2920 2b0a 2020 2020 2020 2020 2020  ']) +.          
-0001cda0: 2020 2020 2020 2827 2720 6966 2064 6973        ('' if dis
-0001cdb0: 6b5f 7469 6572 203d 3d20 7265 736f 7572  k_tier == resour
-0001cdc0: 6365 735f 7574 696c 732e 4469 736b 5469  ces_utils.DiskTi
-0001cdd0: 6572 2e4c 4f57 2065 6c73 650a 2020 2020  er.LOW else.    
-0001cde0: 2020 2020 2020 2020 2020 2020 2028 5f67               (_g
-0001cdf0: 6574 5f61 7773 5f71 7565 7279 5f63 6f6d  et_aws_query_com
-0001ce00: 6d61 6e64 2872 6567 696f 6e2c 2027 2469  mand(region, '$i
-0001ce10: 6427 2c20 2749 6f70 7327 2c0a 2020 2020  d', 'Iops',.    
-0001ce20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ce30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ce40: 2020 2020 2073 7065 6373 5b27 6469 736b       specs['disk
-0001ce50: 5f69 6f70 7327 5d29 202b 0a20 2020 2020  _iops']) +.     
-0001ce60: 2020 2020 2020 2020 2020 2020 205f 6765               _ge
-0001ce70: 745f 6177 735f 7175 6572 795f 636f 6d6d  t_aws_query_comm
-0001ce80: 616e 6428 7265 6769 6f6e 2c20 2724 6964  and(region, '$id
-0001ce90: 272c 2027 5468 726f 7567 6870 7574 272c  ', 'Throughput',
-0001cea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ceb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cec0: 2020 2020 2020 2020 2020 7370 6563 735b            specs[
-0001ced0: 2764 6973 6b5f 7468 726f 7567 6870 7574  'disk_throughput
-0001cee0: 275d 2929 292c 0a20 2020 2020 2020 2020  ']))),.         
-0001cef0: 2020 205d 2c0a 2020 2020 2020 2020 2020     ],.          
-0001cf00: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
-0001cf10: 7b6e 616d 657d 272c 0a20 2020 2020 2020  {name}',.       
-0001cf20: 2020 2020 2074 696d 656f 7574 3d31 3020       timeout=10 
-0001cf30: 2a20 3630 2c20 2023 2031 3020 6d69 6e73  * 60,  # 10 mins
-0001cf40: 2020 2869 7420 7461 6b65 7320 6172 6f75    (it takes arou
-0001cf50: 6e64 207e 3620 6d69 6e73 290a 2020 2020  nd ~6 mins).    
-0001cf60: 2020 2020 290a 2020 2020 2020 2020 7275      ).        ru
-0001cf70: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-0001cf80: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-0001cf90: 6763 700a 6465 6620 7465 7374 5f67 6370  gcp.def test_gcp
-0001cfa0: 5f64 6973 6b5f 7469 6572 2829 3a0a 2020  _disk_tier():.  
-0001cfb0: 2020 666f 7220 6469 736b 5f74 6965 7220    for disk_tier 
-0001cfc0: 696e 206c 6973 7428 7265 736f 7572 6365  in list(resource
-0001cfd0: 735f 7574 696c 732e 4469 736b 5469 6572  s_utils.DiskTier
-0001cfe0: 293a 0a20 2020 2020 2020 2074 7970 6520  ):.        type 
-0001cff0: 3d20 4743 502e 5f67 6574 5f64 6973 6b5f  = GCP._get_disk_
-0001d000: 7479 7065 2864 6973 6b5f 7469 6572 290a  type(disk_tier).
-0001d010: 2020 2020 2020 2020 6e61 6d65 203d 205f          name = _
-0001d020: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
-0001d030: 2829 202b 2027 2d27 202b 2064 6973 6b5f  () + '-' + disk_
-0001d040: 7469 6572 2e76 616c 7565 0a20 2020 2020  tier.value.     
-0001d050: 2020 206e 616d 655f 6f6e 5f63 6c6f 7564     name_on_cloud
-0001d060: 203d 2063 6f6d 6d6f 6e5f 7574 696c 732e   = common_utils.
-0001d070: 6d61 6b65 5f63 6c75 7374 6572 5f6e 616d  make_cluster_nam
-0001d080: 655f 6f6e 5f63 6c6f 7564 280a 2020 2020  e_on_cloud(.    
-0001d090: 2020 2020 2020 2020 6e61 6d65 2c20 736b          name, sk
-0001d0a0: 792e 4743 502e 6d61 785f 636c 7573 7465  y.GCP.max_cluste
-0001d0b0: 725f 6e61 6d65 5f6c 656e 6774 6828 2929  r_name_length())
-0001d0c0: 0a20 2020 2020 2020 2072 6567 696f 6e20  .        region 
-0001d0d0: 3d20 2775 732d 7765 7374 3227 0a20 2020  = 'us-west2'.   
-0001d0e0: 2020 2020 2074 6573 7420 3d20 5465 7374       test = Test
-0001d0f0: 280a 2020 2020 2020 2020 2020 2020 2767  (.            'g
-0001d100: 6370 2d64 6973 6b2d 7469 6572 2d27 202b  cp-disk-tier-' +
-0001d110: 2064 6973 6b5f 7469 6572 2e76 616c 7565   disk_tier.value
-0001d120: 2c0a 2020 2020 2020 2020 2020 2020 5b0a  ,.            [.
-0001d130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d140: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-0001d150: 2d63 207b 6e61 6d65 7d20 2d2d 636c 6f75  -c {name} --clou
-0001d160: 6420 6763 7020 2d2d 7265 6769 6f6e 207b  d gcp --region {
-0001d170: 7265 6769 6f6e 7d20 270a 2020 2020 2020  region} '.      
-0001d180: 2020 2020 2020 2020 2020 6627 2d2d 6469            f'--di
-0001d190: 736b 2d74 6965 7220 7b64 6973 6b5f 7469  sk-tier {disk_ti
-0001d1a0: 6572 2e76 616c 7565 7d20 6563 686f 2022  er.value} echo "
-0001d1b0: 6865 6c6c 6f20 736b 7922 272c 0a20 2020  hello sky"',.   
-0001d1c0: 2020 2020 2020 2020 2020 2020 2066 276e               f'n
-0001d1d0: 616d 653d 6067 636c 6f75 6420 636f 6d70  ame=`gcloud comp
-0001d1e0: 7574 6520 696e 7374 616e 6365 7320 6c69  ute instances li
-0001d1f0: 7374 202d 2d66 696c 7465 723d 270a 2020  st --filter='.  
-0001d200: 2020 2020 2020 2020 2020 2020 2020 6627                f'
-0001d210: 226c 6162 656c 732e 7261 792d 636c 7573  "labels.ray-clus
-0001d220: 7465 722d 6e61 6d65 3a7b 6e61 6d65 5f6f  ter-name:{name_o
-0001d230: 6e5f 636c 6f75 647d 2220 270a 2020 2020  n_cloud}" '.    
-0001d240: 2020 2020 2020 2020 2020 2020 272d 2d66              '--f
-0001d250: 6f72 6d61 743d 2276 616c 7565 286e 616d  ormat="value(nam
-0001d260: 6529 2260 3b20 270a 2020 2020 2020 2020  e)"`; '.        
-0001d270: 2020 2020 2020 2020 6627 6763 6c6f 7564          f'gcloud
-0001d280: 2063 6f6d 7075 7465 2064 6973 6b73 206c   compute disks l
-0001d290: 6973 7420 2d2d 6669 6c74 6572 3d22 6e61  ist --filter="na
-0001d2a0: 6d65 3d24 6e61 6d65 2220 270a 2020 2020  me=$name" '.    
-0001d2b0: 2020 2020 2020 2020 2020 2020 6627 2d2d              f'--
-0001d2c0: 666f 726d 6174 3d22 7661 6c75 6528 7479  format="value(ty
-0001d2d0: 7065 2922 207c 2067 7265 7020 7b74 7970  pe)" | grep {typ
-0001d2e0: 657d 2027 0a20 2020 2020 2020 2020 2020  e} '.           
-0001d2f0: 205d 2c0a 2020 2020 2020 2020 2020 2020   ],.            
-0001d300: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
-0001d310: 616d 657d 272c 0a20 2020 2020 2020 2020  ame}',.         
-0001d320: 2020 2074 696d 656f 7574 3d36 202a 2036     timeout=6 * 6
-0001d330: 302c 2020 2320 3620 6d69 6e73 2020 2869  0,  # 6 mins  (i
-0001d340: 7420 7461 6b65 7320 6172 6f75 6e64 207e  t takes around ~
-0001d350: 3320 6d69 6e73 290a 2020 2020 2020 2020  3 mins).        
-0001d360: 290a 2020 2020 2020 2020 7275 6e5f 6f6e  ).        run_on
-0001d370: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-0001d380: 7079 7465 7374 2e6d 6172 6b2e 617a 7572  pytest.mark.azur
-0001d390: 650a 6465 6620 7465 7374 5f61 7a75 7265  e.def test_azure
-0001d3a0: 5f64 6973 6b5f 7469 6572 2829 3a0a 2020  _disk_tier():.  
-0001d3b0: 2020 666f 7220 6469 736b 5f74 6965 7220    for disk_tier 
-0001d3c0: 696e 206c 6973 7428 7265 736f 7572 6365  in list(resource
-0001d3d0: 735f 7574 696c 732e 4469 736b 5469 6572  s_utils.DiskTier
-0001d3e0: 293a 0a20 2020 2020 2020 2069 6620 6469  ):.        if di
-0001d3f0: 736b 5f74 6965 7220 3d3d 2072 6573 6f75  sk_tier == resou
-0001d400: 7263 6573 5f75 7469 6c73 2e44 6973 6b54  rces_utils.DiskT
-0001d410: 6965 722e 4849 4748 3a0a 2020 2020 2020  ier.HIGH:.      
-0001d420: 2020 2020 2020 2320 417a 7572 6520 646f        # Azure do
-0001d430: 6573 206e 6f74 2073 7570 706f 7274 2068  es not support h
-0001d440: 6967 6820 6469 736b 2074 6965 722e 0a20  igh disk tier.. 
-0001d450: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-0001d460: 6e75 650a 2020 2020 2020 2020 7479 7065  nue.        type
-0001d470: 203d 2041 7a75 7265 2e5f 6765 745f 6469   = Azure._get_di
-0001d480: 736b 5f74 7970 6528 6469 736b 5f74 6965  sk_type(disk_tie
-0001d490: 7229 0a20 2020 2020 2020 206e 616d 6520  r).        name 
-0001d4a0: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
-0001d4b0: 616d 6528 2920 2b20 272d 2720 2b20 6469  ame() + '-' + di
-0001d4c0: 736b 5f74 6965 722e 7661 6c75 650a 2020  sk_tier.value.  
-0001d4d0: 2020 2020 2020 6e61 6d65 5f6f 6e5f 636c        name_on_cl
-0001d4e0: 6f75 6420 3d20 636f 6d6d 6f6e 5f75 7469  oud = common_uti
-0001d4f0: 6c73 2e6d 616b 655f 636c 7573 7465 725f  ls.make_cluster_
-0001d500: 6e61 6d65 5f6f 6e5f 636c 6f75 6428 0a20  name_on_cloud(. 
-0001d510: 2020 2020 2020 2020 2020 206e 616d 652c             name,
-0001d520: 2073 6b79 2e41 7a75 7265 2e6d 6178 5f63   sky.Azure.max_c
-0001d530: 6c75 7374 6572 5f6e 616d 655f 6c65 6e67  luster_name_leng
-0001d540: 7468 2829 290a 2020 2020 2020 2020 7265  th()).        re
-0001d550: 6769 6f6e 203d 2027 7765 7374 7573 3227  gion = 'westus2'
-0001d560: 0a20 2020 2020 2020 2074 6573 7420 3d20  .        test = 
-0001d570: 5465 7374 280a 2020 2020 2020 2020 2020  Test(.          
-0001d580: 2020 2761 7a75 7265 2d64 6973 6b2d 7469    'azure-disk-ti
-0001d590: 6572 2d27 202b 2064 6973 6b5f 7469 6572  er-' + disk_tier
-0001d5a0: 2e76 616c 7565 2c0a 2020 2020 2020 2020  .value,.        
-0001d5b0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-0001d5c0: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-0001d5d0: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
-0001d5e0: 2d2d 636c 6f75 6420 617a 7572 6520 2d2d  --cloud azure --
-0001d5f0: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
-0001d600: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0001d610: 2020 6627 2d2d 6469 736b 2d74 6965 7220    f'--disk-tier 
-0001d620: 7b64 6973 6b5f 7469 6572 2e76 616c 7565  {disk_tier.value
-0001d630: 7d20 6563 686f 2022 6865 6c6c 6f20 736b  } echo "hello sk
-0001d640: 7922 272c 0a20 2020 2020 2020 2020 2020  y"',.           
-0001d650: 2020 2020 2066 2761 7a20 7265 736f 7572       f'az resour
-0001d660: 6365 206c 6973 7420 2d2d 7461 6720 7261  ce list --tag ra
-0001d670: 792d 636c 7573 7465 722d 6e61 6d65 3d7b  y-cluster-name={
-0001d680: 6e61 6d65 5f6f 6e5f 636c 6f75 647d 202d  name_on_cloud} -
-0001d690: 2d71 7565 7279 2027 0a20 2020 2020 2020  -query '.       
-0001d6a0: 2020 2020 2020 2020 2066 2722 5b3f 7479           f'"[?ty
-0001d6b0: 7065 3d3d 5c27 4d69 6372 6f73 6f66 742e  pe==\'Microsoft.
-0001d6c0: 436f 6d70 7574 652f 6469 736b 735c 275d  Compute/disks\']
-0001d6d0: 2e73 6b75 2e6e 616d 6522 2027 0a20 2020  .sku.name" '.   
-0001d6e0: 2020 2020 2020 2020 2020 2020 2066 272d               f'-
-0001d6f0: 2d6f 7574 7075 7420 7473 7620 7c20 6772  -output tsv | gr
-0001d700: 6570 207b 7479 7065 7d27 0a20 2020 2020  ep {type}'.     
-0001d710: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-0001d720: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
-0001d730: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
-0001d740: 2020 2020 2020 2020 2074 696d 656f 7574           timeout
-0001d750: 3d32 3020 2a20 3630 2c20 2023 2032 3020  =20 * 60,  # 20 
-0001d760: 6d69 6e73 2020 2869 7420 7461 6b65 7320  mins  (it takes 
-0001d770: 6172 6f75 6e64 207e 3132 206d 696e 7329  around ~12 mins)
-0001d780: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-0001d790: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-0001d7a0: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-0001d7b0: 6d61 726b 2e61 7a75 7265 0a64 6566 2074  mark.azure.def t
-0001d7c0: 6573 745f 617a 7572 655f 6265 7374 5f74  est_azure_best_t
-0001d7d0: 6965 725f 6661 696c 6f76 6572 2829 3a0a  ier_failover():.
-0001d7e0: 2020 2020 7479 7065 203d 2041 7a75 7265      type = Azure
-0001d7f0: 2e5f 6765 745f 6469 736b 5f74 7970 6528  ._get_disk_type(
-0001d800: 7265 736f 7572 6365 735f 7574 696c 732e  resources_utils.
-0001d810: 4469 736b 5469 6572 2e4c 4f57 290a 2020  DiskTier.LOW).  
-0001d820: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
-0001d830: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
-0001d840: 206e 616d 655f 6f6e 5f63 6c6f 7564 203d   name_on_cloud =
-0001d850: 2063 6f6d 6d6f 6e5f 7574 696c 732e 6d61   common_utils.ma
-0001d860: 6b65 5f63 6c75 7374 6572 5f6e 616d 655f  ke_cluster_name_
-0001d870: 6f6e 5f63 6c6f 7564 280a 2020 2020 2020  on_cloud(.      
-0001d880: 2020 6e61 6d65 2c20 736b 792e 417a 7572    name, sky.Azur
-0001d890: 652e 6d61 785f 636c 7573 7465 725f 6e61  e.max_cluster_na
-0001d8a0: 6d65 5f6c 656e 6774 6828 2929 0a20 2020  me_length()).   
-0001d8b0: 2072 6567 696f 6e20 3d20 2777 6573 7475   region = 'westu
-0001d8c0: 7332 270a 2020 2020 7465 7374 203d 2054  s2'.    test = T
-0001d8d0: 6573 7428 0a20 2020 2020 2020 2027 617a  est(.        'az
-0001d8e0: 7572 652d 6265 7374 2d74 6965 722d 6661  ure-best-tier-fa
-0001d8f0: 696c 6f76 6572 272c 0a20 2020 2020 2020  ilover',.       
-0001d900: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-0001d910: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-0001d920: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
-0001d930: 2061 7a75 7265 202d 2d72 6567 696f 6e20   azure --region 
-0001d940: 7b72 6567 696f 6e7d 2027 0a20 2020 2020  {region} '.     
-0001d950: 2020 2020 2020 2066 272d 2d64 6973 6b2d         f'--disk-
-0001d960: 7469 6572 2062 6573 7420 2d2d 696e 7374  tier best --inst
-0001d970: 616e 6365 2d74 7970 6520 5374 616e 6461  ance-type Standa
-0001d980: 7264 5f44 385f 7635 2065 6368 6f20 2268  rd_D8_v5 echo "h
-0001d990: 656c 6c6f 2073 6b79 2227 2c0a 2020 2020  ello sky"',.    
-0001d9a0: 2020 2020 2020 2020 6627 617a 2072 6573          f'az res
-0001d9b0: 6f75 7263 6520 6c69 7374 202d 2d74 6167  ource list --tag
-0001d9c0: 2072 6179 2d63 6c75 7374 6572 2d6e 616d   ray-cluster-nam
-0001d9d0: 653d 7b6e 616d 655f 6f6e 5f63 6c6f 7564  e={name_on_cloud
-0001d9e0: 7d20 2d2d 7175 6572 7920 270a 2020 2020  } --query '.    
-0001d9f0: 2020 2020 2020 2020 6627 225b 3f74 7970          f'"[?typ
-0001da00: 653d 3d5c 274d 6963 726f 736f 6674 2e43  e==\'Microsoft.C
-0001da10: 6f6d 7075 7465 2f64 6973 6b73 5c27 5d2e  ompute/disks\'].
-0001da20: 736b 752e 6e61 6d65 2220 270a 2020 2020  sku.name" '.    
-0001da30: 2020 2020 2020 2020 6627 2d2d 6f75 7470          f'--outp
-0001da40: 7574 2074 7376 207c 2067 7265 7020 7b74  ut tsv | grep {t
-0001da50: 7970 657d 272c 0a20 2020 2020 2020 205d  ype}',.        ]
-0001da60: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
-0001da70: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
-0001da80: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
-0001da90: 3d32 3020 2a20 3630 2c20 2023 2032 3020  =20 * 60,  # 20 
-0001daa0: 6d69 6e73 2020 2869 7420 7461 6b65 7320  mins  (it takes 
-0001dab0: 6172 6f75 6e64 207e 3132 206d 696e 7329  around ~12 mins)
-0001dac0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
-0001dad0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
-0001dae0: 2320 2d2d 2d2d 2d2d 2054 6573 7469 6e67  # ------ Testing
-0001daf0: 205a 6572 6f20 5175 6f74 6120 4661 696c   Zero Quota Fail
-0001db00: 6f76 6572 202d 2d2d 2d2d 2d0a 4070 7974  over ------.@pyt
-0001db10: 6573 742e 6d61 726b 2e61 7773 0a64 6566  est.mark.aws.def
-0001db20: 2074 6573 745f 6177 735f 7a65 726f 5f71   test_aws_zero_q
-0001db30: 756f 7461 5f66 6169 6c6f 7665 7228 293a  uota_failover():
-0001db40: 0a0a 2020 2020 6e61 6d65 203d 205f 6765  ..    name = _ge
-0001db50: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
-0001db60: 0a20 2020 2072 6567 696f 6e20 3d20 6765  .    region = ge
-0001db70: 745f 6177 735f 7265 6769 6f6e 5f66 6f72  t_aws_region_for
-0001db80: 5f71 756f 7461 5f66 6169 6c6f 7665 7228  _quota_failover(
-0001db90: 290a 0a20 2020 2069 6620 6e6f 7420 7265  )..    if not re
-0001dba0: 6769 6f6e 3a0a 2020 2020 2020 2020 7079  gion:.        py
-0001dbb0: 7465 7374 2e78 6661 696c 280a 2020 2020  test.xfail(.    
-0001dbc0: 2020 2020 2020 2020 2755 6e61 626c 6520          'Unable 
-0001dbd0: 746f 2074 6573 7420 7a65 726f 2071 756f  to test zero quo
-0001dbe0: 7461 2066 6169 6c6f 7665 7220 6f70 7469  ta failover opti
-0001dbf0: 6d69 7a61 7469 6f6e 20e2 8094 2071 756f  mization ... quo
-0001dc00: 7461 7320 270a 2020 2020 2020 2020 2020  tas '.          
-0001dc10: 2020 2766 6f72 2045 4332 2050 3320 696e    'for EC2 P3 in
-0001dc20: 7374 616e 6365 7320 7765 7265 2066 6f75  stances were fou
-0001dc30: 6e64 206f 6e20 616c 6c20 4157 5320 7265  nd on all AWS re
-0001dc40: 6769 6f6e 732e 2049 7320 7468 6973 2027  gions. Is this '
-0001dc50: 0a20 2020 2020 2020 2020 2020 2027 6578  .            'ex
-0001dc60: 7065 6374 6564 2066 6f72 2079 6f75 7220  pected for your 
-0001dc70: 6163 636f 756e 743f 2729 0a20 2020 2020  account?').     
-0001dc80: 2020 2072 6574 7572 6e0a 0a20 2020 2074     return..    t
-0001dc90: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-0001dca0: 2020 2020 2761 7773 2d7a 6572 6f2d 7175      'aws-zero-qu
-0001dcb0: 6f74 612d 6661 696c 6f76 6572 272c 0a20  ota-failover',. 
-0001dcc0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-0001dcd0: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
-0001dce0: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
-0001dcf0: 2d63 6c6f 7564 2061 7773 202d 2d72 6567  -cloud aws --reg
-0001dd00: 696f 6e20 7b72 6567 696f 6e7d 202d 2d67  ion {region} --g
-0001dd10: 7075 7320 5631 3030 3a38 202d 2d75 7365  pus V100:8 --use
-0001dd20: 2d73 706f 7420 7c20 6772 6570 2022 466f  -spot | grep "Fo
-0001dd30: 756e 6420 6e6f 2071 756f 7461 2227 2c0a  und no quota"',.
-0001dd40: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-0001dd50: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
-0001dd60: 207b 6e61 6d65 7d27 2c0a 2020 2020 290a   {name}',.    ).
-0001dd70: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-0001dd80: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
-0001dd90: 2e6d 6172 6b2e 6763 700a 6465 6620 7465  .mark.gcp.def te
-0001dda0: 7374 5f67 6370 5f7a 6572 6f5f 7175 6f74  st_gcp_zero_quot
-0001ddb0: 615f 6661 696c 6f76 6572 2829 3a0a 0a20  a_failover():.. 
-0001ddc0: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
-0001ddd0: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
-0001dde0: 2020 7265 6769 6f6e 203d 2067 6574 5f67    region = get_g
-0001ddf0: 6370 5f72 6567 696f 6e5f 666f 725f 7175  cp_region_for_qu
-0001de00: 6f74 615f 6661 696c 6f76 6572 2829 0a0a  ota_failover()..
-0001de10: 2020 2020 6966 206e 6f74 2072 6567 696f      if not regio
-0001de20: 6e3a 0a20 2020 2020 2020 2070 7974 6573  n:.        pytes
-0001de30: 742e 7866 6169 6c28 0a20 2020 2020 2020  t.xfail(.       
-0001de40: 2020 2020 2027 556e 6162 6c65 2074 6f20       'Unable to 
-0001de50: 7465 7374 207a 6572 6f20 7175 6f74 6120  test zero quota 
-0001de60: 6661 696c 6f76 6572 206f 7074 696d 697a  failover optimiz
-0001de70: 6174 696f 6e20 e280 9420 7175 6f74 6173  ation ... quotas
-0001de80: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
-0001de90: 666f 7220 4131 3030 2d38 3047 4220 4750  for A100-80GB GP
-0001dea0: 5573 2077 6572 6520 666f 756e 6420 6f6e  Us were found on
-0001deb0: 2061 6c6c 2047 4350 2072 6567 696f 6e73   all GCP regions
-0001dec0: 2e20 4973 2074 6869 7320 270a 2020 2020  . Is this '.    
-0001ded0: 2020 2020 2020 2020 2765 7870 6563 7465          'expecte
-0001dee0: 6420 666f 7220 796f 7572 2061 6363 6f75  d for your accou
-0001def0: 6e74 3f27 290a 2020 2020 2020 2020 7265  nt?').        re
-0001df00: 7475 726e 0a0a 2020 2020 7465 7374 203d  turn..    test =
-0001df10: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
-0001df20: 6763 702d 7a65 726f 2d71 756f 7461 2d66  gcp-zero-quota-f
-0001df30: 6169 6c6f 7665 7227 2c0a 2020 2020 2020  ailover',.      
-0001df40: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
-0001df50: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
-0001df60: 2d63 207b 6e61 6d65 7d20 2d2d 636c 6f75  -c {name} --clou
-0001df70: 6420 6763 7020 2d2d 7265 6769 6f6e 207b  d gcp --region {
-0001df80: 7265 6769 6f6e 7d20 2d2d 6770 7573 2041  region} --gpus A
-0001df90: 3130 302d 3830 4742 3a31 202d 2d75 7365  100-80GB:1 --use
-0001dfa0: 2d73 706f 7420 7c20 6772 6570 2022 466f  -spot | grep "Fo
-0001dfb0: 756e 6420 6e6f 2071 756f 7461 2227 2c0a  und no quota"',.
-0001dfc0: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-0001dfd0: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
-0001dfe0: 207b 6e61 6d65 7d27 2c0a 2020 2020 290a   {name}',.    ).
-0001dff0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-0001e000: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
-0001e010: 2d2d 2d2d 2d20 5465 7374 696e 6720 736b  ----- Testing sk
-0001e020: 7973 6572 7665 202d 2d2d 2d2d 2d2d 2d2d  yserve ---------
-0001e030: 2d0a 0a0a 6465 6620 5f67 6574 5f73 6572  -...def _get_ser
-0001e040: 7669 6365 5f6e 616d 6528 2920 2d3e 2073  vice_name() -> s
-0001e050: 7472 3a0a 2020 2020 2222 2252 6574 7572  tr:.    """Retur
-0001e060: 6e73 2061 2075 7365 722d 756e 6971 7565  ns a user-unique
-0001e070: 2073 6572 7669 6365 206e 616d 6520 666f   service name fo
-0001e080: 7220 6561 6368 2074 6573 745f 736b 7973  r each test_skys
-0001e090: 6572 7665 5f3c 6e61 6d65 3e28 292e 0a0a  erve_<name>()...
-0001e0a0: 2020 2020 4d75 7374 2062 6520 6361 6c6c      Must be call
-0001e0b0: 6564 2066 726f 6d20 6561 6368 2074 6573  ed from each tes
-0001e0c0: 745f 736b 7973 6572 7665 5f3c 6e61 6d65  t_skyserve_<name
-0001e0d0: 3e28 292e 0a20 2020 2022 2222 0a20 2020  >()..    """.   
-0001e0e0: 2063 616c 6c65 725f 6675 6e63 5f6e 616d   caller_func_nam
-0001e0f0: 6520 3d20 696e 7370 6563 742e 7374 6163  e = inspect.stac
-0001e100: 6b28 295b 315d 5b33 5d0a 2020 2020 7465  k()[1][3].    te
-0001e110: 7374 5f6e 616d 6520 3d20 6361 6c6c 6572  st_name = caller
-0001e120: 5f66 756e 635f 6e61 6d65 2e72 6570 6c61  _func_name.repla
-0001e130: 6365 2827 5f27 2c20 272d 2729 2e72 6570  ce('_', '-').rep
-0001e140: 6c61 6365 2827 7465 7374 2d27 2c20 2774  lace('test-', 't
-0001e150: 2d27 290a 2020 2020 7465 7374 5f6e 616d  -').    test_nam
-0001e160: 6520 3d20 7465 7374 5f6e 616d 652e 7265  e = test_name.re
-0001e170: 706c 6163 6528 2773 6b79 7365 7276 652d  place('skyserve-
-0001e180: 272c 2027 7373 2d27 290a 2020 2020 7465  ', 'ss-').    te
-0001e190: 7374 5f6e 616d 6520 3d20 636f 6d6d 6f6e  st_name = common
-0001e1a0: 5f75 7469 6c73 2e6d 616b 655f 636c 7573  _utils.make_clus
-0001e1b0: 7465 725f 6e61 6d65 5f6f 6e5f 636c 6f75  ter_name_on_clou
-0001e1c0: 6428 7465 7374 5f6e 616d 652c 2032 3429  d(test_name, 24)
-0001e1d0: 0a20 2020 2072 6574 7572 6e20 6627 7b74  .    return f'{t
-0001e1e0: 6573 745f 6e61 6d65 7d2d 7b74 6573 745f  est_name}-{test_
-0001e1f0: 6964 7d27 0a0a 0a23 2057 6520 6368 6563  id}'...# We chec
-0001e200: 6b20 7468 6520 6f75 7470 7574 206f 6620  k the output of 
-0001e210: 7468 6520 736b 7973 6572 7665 2073 6572  the skyserve ser
-0001e220: 7669 6365 2074 6f20 7365 6520 6966 2069  vice to see if i
-0001e230: 7420 6973 2072 6561 6479 2e20 4f75 7470  t is ready. Outp
-0001e240: 7574 206f 660a 2320 6052 4550 4c49 4341  ut of.# `REPLICA
-0001e250: 5360 2069 7320 696e 2074 6865 2066 6f72  S` is in the for
-0001e260: 6d20 6f66 2060 312f 3260 2077 6865 7265  m of `1/2` where
-0001e270: 2074 6865 2066 6972 7374 206e 756d 6265   the first numbe
-0001e280: 7220 6973 2074 6865 206e 756d 6265 7220  r is the number 
-0001e290: 6f66 0a23 2072 6561 6479 2072 6570 6c69  of.# ready repli
-0001e2a0: 6361 7320 616e 6420 7468 6520 7365 636f  cas and the seco
-0001e2b0: 6e64 206e 756d 6265 7220 6973 2074 6865  nd number is the
-0001e2c0: 206e 756d 6265 7220 6f66 2074 6f74 616c   number of total
-0001e2d0: 2072 6570 6c69 6361 732e 2057 650a 2320   replicas. We.# 
-0001e2e0: 6772 6570 2073 7563 6820 666f 726d 6174  grep such format
-0001e2f0: 2074 6f20 656e 7375 7265 2074 6861 7420   to ensure that 
-0001e300: 7468 6520 7365 7276 6963 6520 6973 2072  the service is r
-0001e310: 6561 6479 2c20 616e 6420 6561 726c 7920  eady, and early 
-0001e320: 6578 6974 2069 6620 616e 790a 2320 6661  exit if any.# fa
-0001e330: 696c 7572 6520 6465 7465 6374 6564 2e20  ilure detected. 
-0001e340: 496e 2074 6865 2065 6e64 2077 6520 736c  In the end we sl
-0001e350: 6565 7020 666f 720a 2320 7365 7276 652e  eep for.# serve.
-0001e360: 4c42 5f43 4f4e 5452 4f4c 4c45 525f 5359  LB_CONTROLLER_SY
-0001e370: 4e43 5f49 4e54 4552 5641 4c5f 5345 434f  NC_INTERVAL_SECO
-0001e380: 4e44 5320 746f 206d 616b 6520 7375 7265  NDS to make sure
-0001e390: 206c 6f61 6420 6261 6c61 6e63 6572 2068   load balancer h
-0001e3a0: 6176 650a 2320 656e 6f75 6768 2074 696d  ave.# enough tim
-0001e3b0: 6520 746f 2073 796e 6320 7769 7468 2074  e to sync with t
-0001e3c0: 6865 2063 6f6e 7472 6f6c 6c65 7220 616e  he controller an
-0001e3d0: 6420 6765 7420 616c 6c20 7265 6164 7920  d get all ready 
-0001e3e0: 7265 706c 6963 6120 4950 732e 0a5f 5345  replica IPs.._SE
-0001e3f0: 5256 455f 5741 4954 5f55 4e54 494c 5f52  RVE_WAIT_UNTIL_R
-0001e400: 4541 4459 203d 2028 0a20 2020 2027 2877  EADY = (.    '(w
-0001e410: 6869 6c65 2074 7275 653b 2064 6f27 0a20  hile true; do'. 
-0001e420: 2020 2027 2020 2020 206f 7574 7075 743d     '     output=
-0001e430: 2428 736b 7920 7365 7276 6520 7374 6174  $(sky serve stat
-0001e440: 7573 207b 6e61 6d65 7d29 3b27 0a20 2020  us {name});'.   
-0001e450: 2027 2020 2020 2065 6368 6f20 2224 6f75   '     echo "$ou
-0001e460: 7470 7574 2220 7c20 6772 6570 202d 7120  tput" | grep -q 
-0001e470: 227b 7265 706c 6963 615f 6e75 6d7d 2f7b  "{replica_num}/{
-0001e480: 7265 706c 6963 615f 6e75 6d7d 2220 2626  replica_num}" &&
-0001e490: 2062 7265 616b 3b27 0a20 2020 2027 2020   break;'.    '  
-0001e4a0: 2020 2065 6368 6f20 2224 6f75 7470 7574     echo "$output
-0001e4b0: 2220 7c20 6772 6570 202d 7120 2246 4149  " | grep -q "FAI
-0001e4c0: 4c45 4422 2026 2620 6578 6974 2031 3b27  LED" && exit 1;'
-0001e4d0: 0a20 2020 2027 2020 2020 2073 6c65 6570  .    '     sleep
-0001e4e0: 2031 303b 270a 2020 2020 6627 2064 6f6e   10;'.    f' don
-0001e4f0: 6529 3b20 736c 6565 7020 7b73 6572 7665  e); sleep {serve
-0001e500: 2e4c 425f 434f 4e54 524f 4c4c 4552 5f53  .LB_CONTROLLER_S
-0001e510: 594e 435f 494e 5445 5256 414c 5f53 4543  YNC_INTERVAL_SEC
-0001e520: 4f4e 4453 7d3b 2729 0a5f 4950 5f52 4547  ONDS};')._IP_REG
-0001e530: 4558 203d 2072 2728 5b30 2d39 5d7b 312c  EX = r'([0-9]{1,
-0001e540: 337d 5c2e 297b 337d 5b30 2d39 5d7b 312c  3}\.){3}[0-9]{1,
-0001e550: 337d 270a 5f45 4e44 504f 494e 545f 5245  3}'._ENDPOINT_RE
-0001e560: 4745 5820 3d20 5f49 505f 5245 4745 5820  GEX = _IP_REGEX 
-0001e570: 2b20 7227 3a5b 302d 395d 7b31 2c35 7d27  + r':[0-9]{1,5}'
-0001e580: 0a5f 4157 4b5f 414c 4c5f 4c49 4e45 535f  ._AWK_ALL_LINES_
-0001e590: 4245 4c4f 575f 5245 504c 4943 4153 203d  BELOW_REPLICAS =
-0001e5a0: 2072 272f 5265 706c 6963 6173 2f7b 666c   r'/Replicas/{fl
-0001e5b0: 6167 3d31 3b20 6e65 7874 7d20 666c 6167  ag=1; next} flag
-0001e5c0: 270a 2320 5369 6e63 6520 7765 2064 6f6e  '.# Since we don
-0001e5d0: 2774 2061 6c6c 6f77 2074 6572 6d69 6e61  't allow termina
-0001e5e0: 7465 2074 6865 2073 6572 7669 6365 2069  te the service i
-0001e5f0: 6620 7468 6520 636f 6e74 726f 6c6c 6572  f the controller
-0001e600: 2069 7320 494e 4954 2c0a 2320 7768 6963   is INIT,.# whic
-0001e610: 6820 6973 2063 6f6d 6d6f 6e20 666f 7220  h is common for 
-0001e620: 7369 6d75 6c74 616e 656f 7573 2070 7974  simultaneous pyt
-0001e630: 6573 742c 2077 6520 6e65 6564 2074 6f20  est, we need to 
-0001e640: 7761 6974 2075 6e74 696c 2074 6865 0a23  wait until the.#
-0001e650: 2063 6f6e 7472 6f6c 6c65 7220 6973 2055   controller is U
-0001e660: 5020 6265 666f 7265 2077 6520 6361 6e20  P before we can 
-0001e670: 7465 726d 696e 6174 6520 7468 6520 7365  terminate the se
-0001e680: 7276 6963 652e 0a23 2054 6865 2074 6561  rvice..# The tea
-0001e690: 7264 6f77 6e20 636f 6d6d 616e 6420 6861  rdown command ha
-0001e6a0: 7320 6120 3130 2d6d 696e 7320 7469 6d65  s a 10-mins time
-0001e6b0: 6f75 742c 2073 6f20 7765 2064 6f6e 2774  out, so we don't
-0001e6c0: 206e 6565 6420 746f 2064 6f0a 2320 7468   need to do.# th
-0001e6d0: 6520 7469 6d65 6f75 7420 6865 7265 2e20  e timeout here. 
-0001e6e0: 5365 6520 696d 706c 656d 656e 7461 7469  See implementati
-0001e6f0: 6f6e 206f 6620 7275 6e5f 6f6e 655f 7465  on of run_one_te
-0001e700: 7374 2829 2066 6f72 2064 6574 6169 6c73  st() for details
-0001e710: 2e0a 5f54 4541 5244 4f57 4e5f 5345 5256  .._TEARDOWN_SERV
-0001e720: 4943 4520 3d20 280a 2020 2020 2728 7768  ICE = (.    '(wh
-0001e730: 696c 6520 7472 7565 3b20 646f 270a 2020  ile true; do'.  
-0001e740: 2020 2720 2020 2020 6f75 7470 7574 3d24    '     output=$
-0001e750: 2873 6b79 2073 6572 7665 2064 6f77 6e20  (sky serve down 
-0001e760: 2d79 207b 6e61 6d65 7d29 3b27 0a20 2020  -y {name});'.   
-0001e770: 2027 2020 2020 2065 6368 6f20 2224 6f75   '     echo "$ou
-0001e780: 7470 7574 2220 7c20 6772 6570 202d 7120  tput" | grep -q 
-0001e790: 2273 6368 6564 756c 6564 2074 6f20 6265  "scheduled to be
-0001e7a0: 2074 6572 6d69 6e61 7465 6422 2026 2620   terminated" && 
-0001e7b0: 6272 6561 6b3b 270a 2020 2020 2720 2020  break;'.    '   
-0001e7c0: 2020 736c 6565 7020 3130 3b27 0a20 2020    sleep 10;'.   
-0001e7d0: 2027 646f 6e65 2927 290a 0a0a 6465 6620   'done)')...def 
-0001e7e0: 5f67 6574 5f73 6572 7665 5f65 6e64 706f  _get_serve_endpo
-0001e7f0: 696e 7428 6e61 6d65 3a20 7374 7229 202d  int(name: str) -
-0001e800: 3e20 7374 723a 0a20 2020 2072 6574 7572  > str:.    retur
-0001e810: 6e20 6627 656e 6470 6f69 6e74 3d24 2873  n f'endpoint=$(s
-0001e820: 6b79 2073 6572 7665 2073 7461 7475 7320  ky serve status 
-0001e830: 7b6e 616d 657d 207c 2067 7265 7020 2d45  {name} | grep -E
-0001e840: 6f20 227b 5f45 4e44 504f 494e 545f 5245  o "{_ENDPOINT_RE
-0001e850: 4745 587d 2229 270a 0a0a 6465 6620 5f67  GEX}")'...def _g
-0001e860: 6574 5f72 6570 6c69 6361 5f6c 696e 6528  et_replica_line(
-0001e870: 6e61 6d65 3a20 7374 722c 2072 6570 6c69  name: str, repli
-0001e880: 6361 5f69 643a 2069 6e74 2920 2d3e 2073  ca_id: int) -> s
-0001e890: 7472 3a0a 2020 2020 7265 7475 726e 2028  tr:.    return (
-0001e8a0: 6627 736b 7920 7365 7276 6520 7374 6174  f'sky serve stat
-0001e8b0: 7573 207b 6e61 6d65 7d20 7c20 6177 6b20  us {name} | awk 
-0001e8c0: 227b 5f41 574b 5f41 4c4c 5f4c 494e 4553  "{_AWK_ALL_LINES
-0001e8d0: 5f42 454c 4f57 5f52 4550 4c49 4341 537d  _BELOW_REPLICAS}
-0001e8e0: 2227 0a20 2020 2020 2020 2020 2020 2066  "'.            f
-0001e8f0: 2720 7c20 6772 6570 202d 4520 227b 6e61  ' | grep -E "{na
-0001e900: 6d65 7d5c 732b 7b72 6570 6c69 6361 5f69  me}\s+{replica_i
-0001e910: 647d 2227 290a 0a0a 6465 6620 5f67 6574  d}"')...def _get
-0001e920: 5f72 6570 6c69 6361 5f69 7028 6e61 6d65  _replica_ip(name
-0001e930: 3a20 7374 722c 2072 6570 6c69 6361 5f69  : str, replica_i
-0001e940: 643a 2069 6e74 2920 2d3e 2073 7472 3a0a  d: int) -> str:.
-0001e950: 2020 2020 7265 7475 726e 2028 6627 6970      return (f'ip
-0001e960: 7b72 6570 6c69 6361 5f69 647d 3d24 287b  {replica_id}=$({
-0001e970: 5f67 6574 5f72 6570 6c69 6361 5f6c 696e  _get_replica_lin
-0001e980: 6528 6e61 6d65 2c20 7265 706c 6963 615f  e(name, replica_
-0001e990: 6964 297d 270a 2020 2020 2020 2020 2020  id)}'.          
-0001e9a0: 2020 6627 207c 2067 7265 7020 2d45 6f20    f' | grep -Eo 
-0001e9b0: 227b 5f49 505f 5245 4745 587d 2229 2729  "{_IP_REGEX}")')
-0001e9c0: 0a0a 0a64 6566 205f 6765 745f 736b 7973  ...def _get_skys
-0001e9d0: 6572 7665 5f68 7474 705f 7465 7374 286e  erve_http_test(n
-0001e9e0: 616d 653a 2073 7472 2c20 636c 6f75 643a  ame: str, cloud:
-0001e9f0: 2073 7472 2c0a 2020 2020 2020 2020 2020   str,.          
-0001ea00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ea10: 2020 7469 6d65 6f75 745f 6d69 6e75 7465    timeout_minute
-0001ea20: 733a 2069 6e74 2920 2d3e 2054 6573 743a  s: int) -> Test:
-0001ea30: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-0001ea40: 280a 2020 2020 2020 2020 6627 7465 7374  (.        f'test
-0001ea50: 2d73 6b79 7365 7276 652d 7b63 6c6f 7564  -skyserve-{cloud
-0001ea60: 2e72 6570 6c61 6365 2822 5f22 2c20 222d  .replace("_", "-
-0001ea70: 2229 7d27 2c0a 2020 2020 2020 2020 5b0a  ")}',.        [.
-0001ea80: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0001ea90: 7920 7365 7276 6520 7570 202d 6e20 7b6e  y serve up -n {n
-0001eaa0: 616d 657d 202d 7920 7465 7374 732f 736b  ame} -y tests/sk
-0001eab0: 7973 6572 7665 2f68 7474 702f 7b63 6c6f  yserve/http/{clo
-0001eac0: 7564 7d2e 7961 6d6c 272c 0a20 2020 2020  ud}.yaml',.     
-0001ead0: 2020 2020 2020 205f 5345 5256 455f 5741         _SERVE_WA
-0001eae0: 4954 5f55 4e54 494c 5f52 4541 4459 2e66  IT_UNTIL_READY.f
-0001eaf0: 6f72 6d61 7428 6e61 6d65 3d6e 616d 652c  ormat(name=name,
-0001eb00: 2072 6570 6c69 6361 5f6e 756d 3d32 292c   replica_num=2),
-0001eb10: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-0001eb20: 5f67 6574 5f73 6572 7665 5f65 6e64 706f  _get_serve_endpo
-0001eb30: 696e 7428 6e61 6d65 297d 3b20 6375 726c  int(name)}; curl
-0001eb40: 202d 4c20 6874 7470 3a2f 2f24 656e 6470   -L http://$endp
-0001eb50: 6f69 6e74 207c 2067 7265 7020 2248 692c  oint | grep "Hi,
-0001eb60: 2053 6b79 5069 6c6f 7420 6865 7265 2227   SkyPilot here"'
-0001eb70: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-0001eb80: 2020 2020 205f 5445 4152 444f 574e 5f53       _TEARDOWN_S
-0001eb90: 4552 5649 4345 2e66 6f72 6d61 7428 6e61  ERVICE.format(na
-0001eba0: 6d65 3d6e 616d 6529 2c0a 2020 2020 2020  me=name),.      
-0001ebb0: 2020 7469 6d65 6f75 743d 7469 6d65 6f75    timeout=timeou
-0001ebc0: 745f 6d69 6e75 7465 7320 2a20 3630 2c0a  t_minutes * 60,.
-0001ebd0: 2020 2020 290a 2020 2020 7265 7475 726e      ).    return
-0001ebe0: 2074 6573 740a 0a0a 4070 7974 6573 742e   test...@pytest.
-0001ebf0: 6d61 726b 2e67 6370 0a40 7079 7465 7374  mark.gcp.@pytest
-0001ec00: 2e6d 6172 6b2e 736b 795f 7365 7276 650a  .mark.sky_serve.
-0001ec10: 6465 6620 7465 7374 5f73 6b79 7365 7276  def test_skyserv
-0001ec20: 655f 6763 705f 6874 7470 2829 3a0a 2020  e_gcp_http():.  
-0001ec30: 2020 2222 2254 6573 7420 736b 7973 6572    """Test skyser
-0001ec40: 7665 206f 6e20 4743 5022 2222 0a20 2020  ve on GCP""".   
-0001ec50: 206e 616d 6520 3d20 5f67 6574 5f73 6572   name = _get_ser
-0001ec60: 7669 6365 5f6e 616d 6528 290a 2020 2020  vice_name().    
-0001ec70: 7465 7374 203d 205f 6765 745f 736b 7973  test = _get_skys
-0001ec80: 6572 7665 5f68 7474 705f 7465 7374 286e  erve_http_test(n
-0001ec90: 616d 652c 2027 6763 7027 2c20 3230 290a  ame, 'gcp', 20).
-0001eca0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-0001ecb0: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
-0001ecc0: 2e6d 6172 6b2e 6177 730a 4070 7974 6573  .mark.aws.@pytes
-0001ecd0: 742e 6d61 726b 2e73 6b79 5f73 6572 7665  t.mark.sky_serve
-0001ece0: 0a64 6566 2074 6573 745f 736b 7973 6572  .def test_skyser
-0001ecf0: 7665 5f61 7773 5f68 7474 7028 293a 0a20  ve_aws_http():. 
-0001ed00: 2020 2022 2222 5465 7374 2073 6b79 7365     """Test skyse
-0001ed10: 7276 6520 6f6e 2041 5753 2222 220a 2020  rve on AWS""".  
-0001ed20: 2020 6e61 6d65 203d 205f 6765 745f 7365    name = _get_se
-0001ed30: 7276 6963 655f 6e61 6d65 2829 0a20 2020  rvice_name().   
-0001ed40: 2074 6573 7420 3d20 5f67 6574 5f73 6b79   test = _get_sky
-0001ed50: 7365 7276 655f 6874 7470 5f74 6573 7428  serve_http_test(
-0001ed60: 6e61 6d65 2c20 2761 7773 272c 2032 3029  name, 'aws', 20)
-0001ed70: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-0001ed80: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-0001ed90: 742e 6d61 726b 2e61 7a75 7265 0a40 7079  t.mark.azure.@py
-0001eda0: 7465 7374 2e6d 6172 6b2e 736b 795f 7365  test.mark.sky_se
-0001edb0: 7276 650a 6465 6620 7465 7374 5f73 6b79  rve.def test_sky
-0001edc0: 7365 7276 655f 617a 7572 655f 6874 7470  serve_azure_http
-0001edd0: 2829 3a0a 2020 2020 2222 2254 6573 7420  ():.    """Test 
-0001ede0: 736b 7973 6572 7665 206f 6e20 417a 7572  skyserve on Azur
-0001edf0: 6522 2222 0a20 2020 206e 616d 6520 3d20  e""".    name = 
-0001ee00: 5f67 6574 5f73 6572 7669 6365 5f6e 616d  _get_service_nam
-0001ee10: 6528 290a 2020 2020 7465 7374 203d 205f  e().    test = _
-0001ee20: 6765 745f 736b 7973 6572 7665 5f68 7474  get_skyserve_htt
-0001ee30: 705f 7465 7374 286e 616d 652c 2027 617a  p_test(name, 'az
-0001ee40: 7572 6527 2c20 3330 290a 2020 2020 7275  ure', 30).    ru
-0001ee50: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
-0001ee60: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-0001ee70: 6763 700a 4070 7974 6573 742e 6d61 726b  gcp.@pytest.mark
-0001ee80: 2e73 6b79 5f73 6572 7665 0a64 6566 2074  .sky_serve.def t
-0001ee90: 6573 745f 736b 7973 6572 7665 5f6c 6c6d  est_skyserve_llm
-0001eea0: 2829 3a0a 2020 2020 2222 2254 6573 7420  ():.    """Test 
-0001eeb0: 736b 7973 6572 7665 2077 6974 6820 7265  skyserve with re
-0001eec0: 616c 204c 4c4d 2075 7365 6361 7365 2222  al LLM usecase""
-0001eed0: 220a 2020 2020 6e61 6d65 203d 205f 6765  ".    name = _ge
-0001eee0: 745f 7365 7276 6963 655f 6e61 6d65 2829  t_service_name()
-0001eef0: 0a0a 2020 2020 6465 6620 6765 6e65 7261  ..    def genera
-0001ef00: 7465 5f6c 6c6d 5f74 6573 745f 636f 6d6d  te_llm_test_comm
-0001ef10: 616e 6428 7072 6f6d 7074 3a20 7374 722c  and(prompt: str,
-0001ef20: 2065 7870 6563 7465 645f 6f75 7470 7574   expected_output
-0001ef30: 3a20 7374 7229 202d 3e20 7374 723a 0a20  : str) -> str:. 
-0001ef40: 2020 2020 2020 2070 726f 6d70 7420 3d20         prompt = 
-0001ef50: 7368 6c65 782e 7175 6f74 6528 7072 6f6d  shlex.quote(prom
-0001ef60: 7074 290a 2020 2020 2020 2020 6578 7065  pt).        expe
-0001ef70: 6374 6564 5f6f 7574 7075 7420 3d20 7368  cted_output = sh
-0001ef80: 6c65 782e 7175 6f74 6528 6578 7065 6374  lex.quote(expect
-0001ef90: 6564 5f6f 7574 7075 7429 0a20 2020 2020  ed_output).     
-0001efa0: 2020 2072 6574 7572 6e20 280a 2020 2020     return (.    
-0001efb0: 2020 2020 2020 2020 6627 7b5f 6765 745f          f'{_get_
-0001efc0: 7365 7276 655f 656e 6470 6f69 6e74 286e  serve_endpoint(n
-0001efd0: 616d 6529 7d3b 2070 7974 686f 6e20 7465  ame)}; python te
-0001efe0: 7374 732f 736b 7973 6572 7665 2f6c 6c6d  sts/skyserve/llm
-0001eff0: 2f67 6574 5f72 6573 706f 6e73 652e 7079  /get_response.py
-0001f000: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
-0001f010: 202d 2d65 6e64 706f 696e 7420 2465 6e64   --endpoint $end
-0001f020: 706f 696e 7420 2d2d 7072 6f6d 7074 207b  point --prompt {
-0001f030: 7072 6f6d 7074 7d20 7c20 6772 6570 207b  prompt} | grep {
-0001f040: 6578 7065 6374 6564 5f6f 7574 7075 747d  expected_output}
-0001f050: 2729 0a0a 2020 2020 7769 7468 206f 7065  ')..    with ope
-0001f060: 6e28 2774 6573 7473 2f73 6b79 7365 7276  n('tests/skyserv
-0001f070: 652f 6c6c 6d2f 7072 6f6d 7074 5f6f 7574  e/llm/prompt_out
-0001f080: 7075 742e 6a73 6f6e 272c 2027 7227 2c0a  put.json', 'r',.
-0001f090: 2020 2020 2020 2020 2020 2020 2020 656e                en
-0001f0a0: 636f 6469 6e67 3d27 7574 662d 3827 2920  coding='utf-8') 
-0001f0b0: 6173 2066 3a0a 2020 2020 2020 2020 7072  as f:.        pr
-0001f0c0: 6f6d 7074 326f 7574 7075 7420 3d20 6a73  ompt2output = js
-0001f0d0: 6f6e 2e6c 6f61 6428 6629 0a0a 2020 2020  on.load(f)..    
-0001f0e0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-0001f0f0: 2020 2020 2066 2774 6573 742d 736b 7973       f'test-skys
-0001f100: 6572 7665 2d6c 6c6d 272c 0a20 2020 2020  erve-llm',.     
-0001f110: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-0001f120: 2066 2773 6b79 2073 6572 7665 2075 7020   f'sky serve up 
-0001f130: 2d6e 207b 6e61 6d65 7d20 2d79 2074 6573  -n {name} -y tes
-0001f140: 7473 2f73 6b79 7365 7276 652f 6c6c 6d2f  ts/skyserve/llm/
-0001f150: 7365 7276 6963 652e 7961 6d6c 272c 0a20  service.yaml',. 
-0001f160: 2020 2020 2020 2020 2020 205f 5345 5256             _SERV
-0001f170: 455f 5741 4954 5f55 4e54 494c 5f52 4541  E_WAIT_UNTIL_REA
-0001f180: 4459 2e66 6f72 6d61 7428 6e61 6d65 3d6e  DY.format(name=n
-0001f190: 616d 652c 2072 6570 6c69 6361 5f6e 756d  ame, replica_num
-0001f1a0: 3d31 292c 0a20 2020 2020 2020 2020 2020  =1),.           
-0001f1b0: 202a 5b0a 2020 2020 2020 2020 2020 2020   *[.            
-0001f1c0: 2020 2020 6765 6e65 7261 7465 5f6c 6c6d      generate_llm
-0001f1d0: 5f74 6573 745f 636f 6d6d 616e 6428 7072  _test_command(pr
-0001f1e0: 6f6d 7074 2c20 6f75 7470 7574 290a 2020  ompt, output).  
-0001f1f0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0001f200: 7220 7072 6f6d 7074 2c20 6f75 7470 7574  r prompt, output
-0001f210: 2069 6e20 7072 6f6d 7074 326f 7574 7075   in prompt2outpu
-0001f220: 742e 6974 656d 7328 290a 2020 2020 2020  t.items().      
-0001f230: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
-0001f240: 205d 2c0a 2020 2020 2020 2020 5f54 4541   ],.        _TEA
-0001f250: 5244 4f57 4e5f 5345 5256 4943 452e 666f  RDOWN_SERVICE.fo
-0001f260: 726d 6174 286e 616d 653d 6e61 6d65 292c  rmat(name=name),
-0001f270: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
-0001f280: 3d32 3020 2a20 3630 2c0a 2020 2020 290a  =20 * 60,.    ).
-0001f290: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-0001f2a0: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
-0001f2b0: 2e6d 6172 6b2e 6763 700a 4070 7974 6573  .mark.gcp.@pytes
-0001f2c0: 742e 6d61 726b 2e73 6b79 5f73 6572 7665  t.mark.sky_serve
-0001f2d0: 0a64 6566 2074 6573 745f 736b 7973 6572  .def test_skyser
-0001f2e0: 7665 5f73 706f 745f 7265 636f 7665 7279  ve_spot_recovery
-0001f2f0: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
-0001f300: 6765 745f 7365 7276 6963 655f 6e61 6d65  get_service_name
-0001f310: 2829 0a20 2020 207a 6f6e 6520 3d20 2775  ().    zone = 'u
-0001f320: 732d 6365 6e74 7261 6c31 2d61 270a 0a20  s-central1-a'.. 
-0001f330: 2020 2023 2052 6566 6572 656e 6365 3a20     # Reference: 
-0001f340: 7465 7374 5f73 706f 745f 7265 636f 7665  test_spot_recove
-0001f350: 7279 5f67 6370 0a20 2020 2064 6566 2074  ry_gcp.    def t
-0001f360: 6572 6d69 6e61 7465 5f72 6570 6c69 6361  erminate_replica
-0001f370: 2872 6570 6c69 6361 5f69 643a 2069 6e74  (replica_id: int
-0001f380: 2920 2d3e 2073 7472 3a0a 2020 2020 2020  ) -> str:.      
-0001f390: 2020 636c 7573 7465 725f 6e61 6d65 203d    cluster_name =
-0001f3a0: 2073 6572 7665 2e67 656e 6572 6174 655f   serve.generate_
-0001f3b0: 7265 706c 6963 615f 636c 7573 7465 725f  replica_cluster_
-0001f3c0: 6e61 6d65 286e 616d 652c 2072 6570 6c69  name(name, repli
-0001f3d0: 6361 5f69 6429 0a20 2020 2020 2020 2071  ca_id).        q
-0001f3e0: 7565 7279 5f63 6d64 203d 2028 6627 6763  uery_cmd = (f'gc
-0001f3f0: 6c6f 7564 2063 6f6d 7075 7465 2069 6e73  loud compute ins
-0001f400: 7461 6e63 6573 206c 6973 7420 2d2d 6669  tances list --fi
-0001f410: 6c74 6572 3d27 0a20 2020 2020 2020 2020  lter='.         
-0001f420: 2020 2020 2020 2020 2020 2020 6627 2228              f'"(
-0001f430: 6c61 6265 6c73 2e72 6179 2d63 6c75 7374  labels.ray-clust
-0001f440: 6572 2d6e 616d 653a 7b63 6c75 7374 6572  er-name:{cluster
-0001f450: 5f6e 616d 657d 2922 2027 0a20 2020 2020  _name})" '.     
-0001f460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f470: 6627 2d2d 7a6f 6e65 733d 7b7a 6f6e 657d  f'--zones={zone}
-0001f480: 202d 2d66 6f72 6d61 743d 2276 616c 7565   --format="value
-0001f490: 286e 616d 6529 2227 290a 2020 2020 2020  (name)"').      
-0001f4a0: 2020 7265 7475 726e 2028 6627 6763 6c6f    return (f'gclo
-0001f4b0: 7564 2063 6f6d 7075 7465 2069 6e73 7461  ud compute insta
-0001f4c0: 6e63 6573 2064 656c 6574 6520 2d2d 7a6f  nces delete --zo
-0001f4d0: 6e65 3d7b 7a6f 6e65 7d27 0a20 2020 2020  ne={zone}'.     
-0001f4e0: 2020 2020 2020 2020 2020 2066 2720 2d2d             f' --
-0001f4f0: 7175 6965 7420 2428 7b71 7565 7279 5f63  quiet $({query_c
-0001f500: 6d64 7d29 2729 0a0a 2020 2020 7465 7374  md})')..    test
-0001f510: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
-0001f520: 2066 2774 6573 742d 736b 7973 6572 7665   f'test-skyserve
-0001f530: 2d73 706f 742d 7265 636f 7665 7279 2d67  -spot-recovery-g
-0001f540: 6370 272c 0a20 2020 2020 2020 205b 0a20  cp',.        [. 
-0001f550: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0001f560: 2073 6572 7665 2075 7020 2d6e 207b 6e61   serve up -n {na
-0001f570: 6d65 7d20 2d79 2074 6573 7473 2f73 6b79  me} -y tests/sky
-0001f580: 7365 7276 652f 7370 6f74 2f72 6563 6f76  serve/spot/recov
-0001f590: 6572 792e 7961 6d6c 272c 0a20 2020 2020  ery.yaml',.     
-0001f5a0: 2020 2020 2020 205f 5345 5256 455f 5741         _SERVE_WA
-0001f5b0: 4954 5f55 4e54 494c 5f52 4541 4459 2e66  IT_UNTIL_READY.f
-0001f5c0: 6f72 6d61 7428 6e61 6d65 3d6e 616d 652c  ormat(name=name,
-0001f5d0: 2072 6570 6c69 6361 5f6e 756d 3d31 292c   replica_num=1),
-0001f5e0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
-0001f5f0: 5f67 6574 5f73 6572 7665 5f65 6e64 706f  _get_serve_endpo
-0001f600: 696e 7428 6e61 6d65 297d 3b20 6375 726c  int(name)}; curl
-0001f610: 202d 4c20 6874 7470 3a2f 2f24 656e 6470   -L http://$endp
-0001f620: 6f69 6e74 207c 2067 7265 7020 2248 692c  oint | grep "Hi,
-0001f630: 2053 6b79 5069 6c6f 7420 6865 7265 2227   SkyPilot here"'
-0001f640: 2c0a 2020 2020 2020 2020 2020 2020 7465  ,.            te
-0001f650: 726d 696e 6174 655f 7265 706c 6963 6128  rminate_replica(
-0001f660: 3129 2c0a 2020 2020 2020 2020 2020 2020  1),.            
-0001f670: 5f53 4552 5645 5f57 4149 545f 554e 5449  _SERVE_WAIT_UNTI
-0001f680: 4c5f 5245 4144 592e 666f 726d 6174 286e  L_READY.format(n
-0001f690: 616d 653d 6e61 6d65 2c20 7265 706c 6963  ame=name, replic
-0001f6a0: 615f 6e75 6d3d 3129 2c0a 2020 2020 2020  a_num=1),.      
-0001f6b0: 2020 2020 2020 6627 7b5f 6765 745f 7365        f'{_get_se
-0001f6c0: 7276 655f 656e 6470 6f69 6e74 286e 616d  rve_endpoint(nam
-0001f6d0: 6529 7d3b 2063 7572 6c20 2d4c 2068 7474  e)}; curl -L htt
-0001f6e0: 703a 2f2f 2465 6e64 706f 696e 7420 7c20  p://$endpoint | 
-0001f6f0: 6772 6570 2022 4869 2c20 536b 7950 696c  grep "Hi, SkyPil
-0001f700: 6f74 2068 6572 6522 272c 0a20 2020 2020  ot here"',.     
-0001f710: 2020 205d 2c0a 2020 2020 2020 2020 5f54     ],.        _T
-0001f720: 4541 5244 4f57 4e5f 5345 5256 4943 452e  EARDOWN_SERVICE.
-0001f730: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
-0001f740: 292c 0a20 2020 2020 2020 2074 696d 656f  ),.        timeo
-0001f750: 7574 3d32 3020 2a20 3630 2c0a 2020 2020  ut=20 * 60,.    
-0001f760: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-0001f770: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
-0001f780: 7374 2e6d 6172 6b2e 6763 700a 4070 7974  st.mark.gcp.@pyt
-0001f790: 6573 742e 6d61 726b 2e73 6b79 5f73 6572  est.mark.sky_ser
-0001f7a0: 7665 0a64 6566 2074 6573 745f 736b 7973  ve.def test_skys
-0001f7b0: 6572 7665 5f73 706f 745f 7573 6572 5f62  erve_spot_user_b
-0001f7c0: 7567 2829 3a0a 2020 2020 2222 2254 6573  ug():.    """Tes
-0001f7d0: 7473 2074 6861 7420 7370 6f74 2072 6563  ts that spot rec
-0001f7e0: 6f76 6572 7920 646f 6573 6e27 7420 6f63  overy doesn't oc
-0001f7f0: 6375 7220 666f 7220 6e6f 6e2d 7072 6565  cur for non-pree
-0001f800: 6d70 7469 6f6e 2066 6169 6c75 7265 7322  mption failures"
-0001f810: 2222 0a20 2020 206e 616d 6520 3d20 5f67  "".    name = _g
-0001f820: 6574 5f73 6572 7669 6365 5f6e 616d 6528  et_service_name(
-0001f830: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
-0001f840: 7428 0a20 2020 2020 2020 2066 2774 6573  t(.        f'tes
-0001f850: 742d 736b 7973 6572 7665 2d73 706f 742d  t-skyserve-spot-
-0001f860: 7573 6572 2d62 7567 2d67 6370 272c 0a20  user-bug-gcp',. 
-0001f870: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
-0001f880: 2020 2020 2066 2773 6b79 2073 6572 7665       f'sky serve
-0001f890: 2075 7020 2d6e 207b 6e61 6d65 7d20 2d79   up -n {name} -y
-0001f8a0: 2074 6573 7473 2f73 6b79 7365 7276 652f   tests/skyserve/
-0001f8b0: 7370 6f74 2f75 7365 725f 6275 672e 7961  spot/user_bug.ya
-0001f8c0: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-0001f8d0: 205f 5345 5256 455f 5741 4954 5f55 4e54   _SERVE_WAIT_UNT
-0001f8e0: 494c 5f52 4541 4459 2e66 6f72 6d61 7428  IL_READY.format(
-0001f8f0: 6e61 6d65 3d6e 616d 652c 2072 6570 6c69  name=name, repli
-0001f900: 6361 5f6e 756d 3d31 292c 0a20 2020 2020  ca_num=1),.     
-0001f910: 2020 2020 2020 2023 2041 6674 6572 2066         # After f
-0001f920: 6169 6c75 7265 2064 7565 2074 6f20 7573  ailure due to us
-0001f930: 6572 2062 7567 2c20 7468 6520 7365 7276  er bug, the serv
-0001f940: 6963 6520 7368 6f75 6c64 2066 6169 6c20  ice should fail 
-0001f950: 696e 7374 6561 6420 6f66 0a20 2020 2020  instead of.     
-0001f960: 2020 2020 2020 2023 2074 7269 6767 6572         # trigger
-0001f970: 696e 6720 7370 6f74 2072 6563 6f76 6572  ing spot recover
-0001f980: 792e 0a20 2020 2020 2020 2020 2020 2027  y..            '
-0001f990: 2877 6869 6c65 2074 7275 653b 2064 6f27  (while true; do'
-0001f9a0: 0a20 2020 2020 2020 2020 2020 2066 2720  .            f' 
-0001f9b0: 2020 206f 7574 7075 743d 2428 736b 7920     output=$(sky 
-0001f9c0: 7365 7276 6520 7374 6174 7573 207b 6e61  serve status {na
-0001f9d0: 6d65 7d29 3b27 0a20 2020 2020 2020 2020  me});'.         
-0001f9e0: 2020 2027 2020 2020 2065 6368 6f20 2224     '     echo "$
-0001f9f0: 6f75 7470 7574 2220 7c20 6772 6570 202d  output" | grep -
-0001fa00: 7120 2246 4149 4c45 4422 2026 2620 6272  q "FAILED" && br
-0001fa10: 6561 6b3b 270a 2020 2020 2020 2020 2020  eak;'.          
-0001fa20: 2020 2720 2020 2020 6563 686f 2022 246f    '     echo "$o
-0001fa30: 7574 7075 7422 207c 2067 7265 7020 2d71  utput" | grep -q
-0001fa40: 2022 5052 4f56 4953 494f 4e49 4e47 2220   "PROVISIONING" 
-0001fa50: 2626 2065 7869 7420 313b 270a 2020 2020  && exit 1;'.    
-0001fa60: 2020 2020 2020 2020 2720 2020 2020 736c          '     sl
-0001fa70: 6565 7020 3130 3b27 0a20 2020 2020 2020  eep 10;'.       
-0001fa80: 2020 2020 2066 2764 6f6e 6529 272c 0a20       f'done)',. 
-0001fa90: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
-0001faa0: 2020 5f54 4541 5244 4f57 4e5f 5345 5256    _TEARDOWN_SERV
-0001fab0: 4943 452e 666f 726d 6174 286e 616d 653d  ICE.format(name=
-0001fac0: 6e61 6d65 292c 0a20 2020 2020 2020 2074  name),.        t
-0001fad0: 696d 656f 7574 3d32 3020 2a20 3630 2c0a  imeout=20 * 60,.
-0001fae0: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
-0001faf0: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
-0001fb00: 7079 7465 7374 2e6d 6172 6b2e 6763 700a  pytest.mark.gcp.
-0001fb10: 4070 7974 6573 742e 6d61 726b 2e73 6b79  @pytest.mark.sky
-0001fb20: 5f73 6572 7665 0a64 6566 2074 6573 745f  _serve.def test_
-0001fb30: 736b 7973 6572 7665 5f6c 6f61 645f 6261  skyserve_load_ba
-0001fb40: 6c61 6e63 6572 2829 3a0a 2020 2020 2222  lancer():.    ""
-0001fb50: 2254 6573 7420 736b 7973 6572 7665 206c  "Test skyserve l
-0001fb60: 6f61 6420 6261 6c61 6e63 6572 2072 6f75  oad balancer rou
-0001fb70: 6e64 2d72 6f62 696e 2070 6f6c 6963 7922  nd-robin policy"
-0001fb80: 2222 0a20 2020 206e 616d 6520 3d20 5f67  "".    name = _g
-0001fb90: 6574 5f73 6572 7669 6365 5f6e 616d 6528  et_service_name(
-0001fba0: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
-0001fbb0: 7428 0a20 2020 2020 2020 2066 2774 6573  t(.        f'tes
-0001fbc0: 742d 736b 7973 6572 7665 2d6c 6f61 642d  t-skyserve-load-
-0001fbd0: 6261 6c61 6e63 6572 272c 0a20 2020 2020  balancer',.     
-0001fbe0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
-0001fbf0: 2066 2773 6b79 2073 6572 7665 2075 7020   f'sky serve up 
-0001fc00: 2d6e 207b 6e61 6d65 7d20 2d79 2074 6573  -n {name} -y tes
-0001fc10: 7473 2f73 6b79 7365 7276 652f 6c6f 6164  ts/skyserve/load
-0001fc20: 5f62 616c 616e 6365 722f 7365 7276 6963  _balancer/servic
-0001fc30: 652e 7961 6d6c 272c 0a20 2020 2020 2020  e.yaml',.       
-0001fc40: 2020 2020 205f 5345 5256 455f 5741 4954       _SERVE_WAIT
-0001fc50: 5f55 4e54 494c 5f52 4541 4459 2e66 6f72  _UNTIL_READY.for
-0001fc60: 6d61 7428 6e61 6d65 3d6e 616d 652c 2072  mat(name=name, r
-0001fc70: 6570 6c69 6361 5f6e 756d 3d33 292c 0a20  eplica_num=3),. 
-0001fc80: 2020 2020 2020 2020 2020 2066 277b 5f67             f'{_g
-0001fc90: 6574 5f73 6572 7665 5f65 6e64 706f 696e  et_serve_endpoin
-0001fca0: 7428 6e61 6d65 297d 3b20 7b5f 6765 745f  t(name)}; {_get_
-0001fcb0: 7265 706c 6963 615f 6970 286e 616d 652c  replica_ip(name,
-0001fcc0: 2031 297d 3b20 270a 2020 2020 2020 2020   1)}; '.        
-0001fcd0: 2020 2020 6627 7b5f 6765 745f 7265 706c      f'{_get_repl
-0001fce0: 6963 615f 6970 286e 616d 652c 2032 297d  ica_ip(name, 2)}
-0001fcf0: 3b20 7b5f 6765 745f 7265 706c 6963 615f  ; {_get_replica_
-0001fd00: 6970 286e 616d 652c 2033 297d 3b20 270a  ip(name, 3)}; '.
-0001fd10: 2020 2020 2020 2020 2020 2020 2770 7974              'pyt
-0001fd20: 686f 6e20 7465 7374 732f 736b 7973 6572  hon tests/skyser
-0001fd30: 7665 2f6c 6f61 645f 6261 6c61 6e63 6572  ve/load_balancer
-0001fd40: 2f74 6573 745f 726f 756e 645f 726f 6269  /test_round_robi
-0001fd50: 6e2e 7079 2027 0a20 2020 2020 2020 2020  n.py '.         
-0001fd60: 2020 2027 2d2d 656e 6470 6f69 6e74 2024     '--endpoint $
-0001fd70: 656e 6470 6f69 6e74 202d 2d72 6570 6c69  endpoint --repli
-0001fd80: 6361 2d6e 756d 2033 202d 2d72 6570 6c69  ca-num 3 --repli
-0001fd90: 6361 2d69 7073 2024 6970 3120 2469 7032  ca-ips $ip1 $ip2
-0001fda0: 2024 6970 3327 2c0a 2020 2020 2020 2020   $ip3',.        
-0001fdb0: 5d2c 0a20 2020 2020 2020 205f 5445 4152  ],.        _TEAR
-0001fdc0: 444f 574e 5f53 4552 5649 4345 2e66 6f72  DOWN_SERVICE.for
-0001fdd0: 6d61 7428 6e61 6d65 3d6e 616d 6529 2c0a  mat(name=name),.
-0001fde0: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
-0001fdf0: 3230 202a 2036 302c 0a20 2020 2029 0a20  20 * 60,.    ). 
-0001fe00: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-0001fe10: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-0001fe20: 6d61 726b 2e67 6370 0a40 7079 7465 7374  mark.gcp.@pytest
-0001fe30: 2e6d 6172 6b2e 736b 795f 7365 7276 650a  .mark.sky_serve.
-0001fe40: 6465 6620 7465 7374 5f73 6b79 7365 7276  def test_skyserv
-0001fe50: 655f 6175 746f 5f72 6573 7461 7274 2829  e_auto_restart()
-0001fe60: 3a0a 2020 2020 2222 2254 6573 7420 736b  :.    """Test sk
-0001fe70: 7973 6572 7665 2077 6974 6820 6175 746f  yserve with auto
-0001fe80: 2072 6573 7461 7274 2222 220a 2020 2020   restart""".    
-0001fe90: 6e61 6d65 203d 205f 6765 745f 7365 7276  name = _get_serv
-0001fea0: 6963 655f 6e61 6d65 2829 0a20 2020 207a  ice_name().    z
-0001feb0: 6f6e 6520 3d20 2775 732d 6365 6e74 7261  one = 'us-centra
-0001fec0: 6c31 2d61 270a 0a20 2020 2023 2052 6566  l1-a'..    # Ref
-0001fed0: 6572 656e 6365 3a20 7465 7374 5f73 706f  erence: test_spo
-0001fee0: 745f 7265 636f 7665 7279 5f67 6370 0a20  t_recovery_gcp. 
-0001fef0: 2020 2064 6566 2074 6572 6d69 6e61 7465     def terminate
-0001ff00: 5f72 6570 6c69 6361 2872 6570 6c69 6361  _replica(replica
-0001ff10: 5f69 643a 2069 6e74 2920 2d3e 2073 7472  _id: int) -> str
-0001ff20: 3a0a 2020 2020 2020 2020 636c 7573 7465  :.        cluste
-0001ff30: 725f 6e61 6d65 203d 2073 6572 7665 2e67  r_name = serve.g
-0001ff40: 656e 6572 6174 655f 7265 706c 6963 615f  enerate_replica_
-0001ff50: 636c 7573 7465 725f 6e61 6d65 286e 616d  cluster_name(nam
-0001ff60: 652c 2072 6570 6c69 6361 5f69 6429 0a20  e, replica_id). 
-0001ff70: 2020 2020 2020 2071 7565 7279 5f63 6d64         query_cmd
-0001ff80: 203d 2028 6627 6763 6c6f 7564 2063 6f6d   = (f'gcloud com
-0001ff90: 7075 7465 2069 6e73 7461 6e63 6573 206c  pute instances l
-0001ffa0: 6973 7420 2d2d 6669 6c74 6572 3d27 0a20  ist --filter='. 
-0001ffb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ffc0: 2020 2020 6627 2228 6c61 6265 6c73 2e72      f'"(labels.r
-0001ffd0: 6179 2d63 6c75 7374 6572 2d6e 616d 653a  ay-cluster-name:
-0001ffe0: 7b63 6c75 7374 6572 5f6e 616d 657d 2922  {cluster_name})"
-0001fff0: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-00020000: 2020 2020 2020 2020 6627 2d2d 7a6f 6e65          f'--zone
-00020010: 733d 7b7a 6f6e 657d 202d 2d66 6f72 6d61  s={zone} --forma
-00020020: 743d 2276 616c 7565 286e 616d 6529 2227  t="value(name)"'
-00020030: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00020040: 2028 6627 6763 6c6f 7564 2063 6f6d 7075   (f'gcloud compu
-00020050: 7465 2069 6e73 7461 6e63 6573 2064 656c  te instances del
-00020060: 6574 6520 2d2d 7a6f 6e65 3d7b 7a6f 6e65  ete --zone={zone
-00020070: 7d27 0a20 2020 2020 2020 2020 2020 2020  }'.             
-00020080: 2020 2066 2720 2d2d 7175 6965 7420 2428     f' --quiet $(
-00020090: 7b71 7565 7279 5f63 6d64 7d29 2729 0a0a  {query_cmd})')..
-000200a0: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-000200b0: 0a20 2020 2020 2020 2066 2774 6573 742d  .        f'test-
-000200c0: 736b 7973 6572 7665 2d61 7574 6f2d 7265  skyserve-auto-re
-000200d0: 7374 6172 7427 2c0a 2020 2020 2020 2020  start',.        
-000200e0: 5b0a 2020 2020 2020 2020 2020 2020 2320  [.            # 
-000200f0: 544f 444f 2874 6961 6e29 3a20 7765 2063  TODO(tian): we c
-00020100: 616e 2064 796e 616d 6963 616c 6c79 2067  an dynamically g
-00020110: 656e 6572 6174 6520 5941 4d4c 2066 726f  enerate YAML fro
-00020120: 6d20 7465 6d70 6c61 7465 2074 6f0a 2020  m template to.  
-00020130: 2020 2020 2020 2020 2020 2320 6176 6f69            # avoi
-00020140: 6420 6d61 696e 7461 696e 696e 6720 746f  d maintaining to
-00020150: 6f20 6d61 6e79 2059 414d 4c20 6669 6c65  o many YAML file
-00020160: 730a 2020 2020 2020 2020 2020 2020 6627  s.            f'
-00020170: 736b 7920 7365 7276 6520 7570 202d 6e20  sky serve up -n 
-00020180: 7b6e 616d 657d 202d 7920 7465 7374 732f  {name} -y tests/
-00020190: 736b 7973 6572 7665 2f61 7574 6f5f 7265  skyserve/auto_re
-000201a0: 7374 6172 742e 7961 6d6c 272c 0a20 2020  start.yaml',.   
-000201b0: 2020 2020 2020 2020 205f 5345 5256 455f           _SERVE_
-000201c0: 5741 4954 5f55 4e54 494c 5f52 4541 4459  WAIT_UNTIL_READY
-000201d0: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
-000201e0: 652c 2072 6570 6c69 6361 5f6e 756d 3d31  e, replica_num=1
-000201f0: 292c 0a20 2020 2020 2020 2020 2020 2066  ),.            f
-00020200: 277b 5f67 6574 5f73 6572 7665 5f65 6e64  '{_get_serve_end
-00020210: 706f 696e 7428 6e61 6d65 297d 3b20 6375  point(name)}; cu
-00020220: 726c 202d 4c20 6874 7470 3a2f 2f24 656e  rl -L http://$en
-00020230: 6470 6f69 6e74 207c 2067 7265 7020 2248  dpoint | grep "H
-00020240: 692c 2053 6b79 5069 6c6f 7420 6865 7265  i, SkyPilot here
-00020250: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-00020260: 2320 736c 6565 7020 666f 7220 3230 2073  # sleep for 20 s
-00020270: 6563 6f6e 6473 2028 696e 6974 6961 6c20  econds (initial 
-00020280: 6465 6c61 7929 2074 6f20 6d61 6b65 2073  delay) to make s
-00020290: 7572 6520 6974 2077 696c 6c0a 2020 2020  ure it will.    
-000202a0: 2020 2020 2020 2020 2320 6265 2072 6573          # be res
-000202b0: 7461 7274 6564 0a20 2020 2020 2020 2020  tarted.         
-000202c0: 2020 2066 2773 6c65 6570 2032 3027 2c0a     f'sleep 20',.
-000202d0: 2020 2020 2020 2020 2020 2020 7465 726d              term
-000202e0: 696e 6174 655f 7265 706c 6963 6128 3129  inate_replica(1)
-000202f0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00020300: 5761 6974 2066 6f72 2063 6f6e 7365 6375  Wait for consecu
-00020310: 7469 7665 2066 6169 6c75 7265 2074 696d  tive failure tim
-00020320: 656f 7574 2070 6173 7365 642e 0a20 2020  eout passed..   
-00020330: 2020 2020 2020 2020 2023 2049 6620 7468           # If th
-00020340: 6520 636c 7573 7465 7220 6973 206e 6f74  e cluster is not
-00020350: 2075 7369 6e67 2073 706f 742c 2069 7420   using spot, it 
-00020360: 776f 6e27 7420 6368 6563 6b20 7468 6520  won't check the 
-00020370: 636c 7573 7465 7220 7374 6174 7573 0a20  cluster status. 
-00020380: 2020 2020 2020 2020 2020 2023 206f 6e20             # on 
-00020390: 7468 6520 636c 6f75 6420 2873 696e 6365  the cloud (since
-000203a0: 206d 616e 7561 6c20 7368 7574 646f 776e   manual shutdown
-000203b0: 2069 7320 6e6f 7420 6120 636f 6d6d 6f6e   is not a common
-000203c0: 2062 6568 6176 696f 7220 616e 6420 7375   behavior and su
-000203d0: 6368 0a20 2020 2020 2020 2020 2020 2023  ch.            #
-000203e0: 2071 7565 7269 6573 2074 616b 6573 2061   queries takes a
-000203f0: 206c 6f74 206f 6620 7469 6d65 292e 2049   lot of time). I
-00020400: 6e73 7465 6164 2c20 7765 2074 6869 6e6b  nstead, we think
-00020410: 2063 6f6e 7469 6e75 6f75 7320 3320 6d69   continuous 3 mi
-00020420: 6e20 7072 6f62 650a 2020 2020 2020 2020  n probe.        
-00020430: 2020 2020 2320 6661 696c 7572 6520 6973      # failure is
-00020440: 206e 6f74 2061 2074 656d 706f 7261 7279   not a temporary
-00020450: 2070 726f 626c 656d 2062 7574 2069 6e64   problem but ind
-00020460: 6565 6420 6120 6661 696c 7572 652e 0a20  eed a failure.. 
-00020470: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
-00020480: 7020 3138 3027 2c0a 2020 2020 2020 2020  p 180',.        
-00020490: 2020 2020 2320 5765 2063 616e 6e6f 7420      # We cannot 
-000204a0: 7573 6520 5f53 4552 5645 5f57 4149 545f  use _SERVE_WAIT_
-000204b0: 554e 5449 4c5f 5245 4144 593b 2074 6865  UNTIL_READY; the
-000204c0: 7265 2077 696c 6c20 6265 2061 2069 6e74  re will be a int
-000204d0: 6572 6d65 6469 6174 6520 7469 6d65 0a20  ermediate time. 
-000204e0: 2020 2020 2020 2020 2020 2023 2074 6861             # tha
-000204f0: 7420 7468 6520 6f75 7470 7574 206f 6620  t the output of 
-00020500: 6073 6b79 2073 6572 7665 2073 7461 7475  `sky serve statu
-00020510: 7360 2073 686f 7773 2046 4149 4c45 4420  s` shows FAILED 
-00020520: 616e 6420 7468 6973 2073 7461 7475 7320  and this status 
-00020530: 7769 6c6c 0a20 2020 2020 2020 2020 2020  will.           
-00020540: 2023 2063 6175 7365 205f 5345 5256 455f   # cause _SERVE_
-00020550: 5741 4954 5f55 4e54 494c 5f52 4541 4459  WAIT_UNTIL_READY
-00020560: 2074 6f20 6561 726c 7920 7175 6974 2e0a   to early quit..
-00020570: 2020 2020 2020 2020 2020 2020 2728 7768              '(wh
-00020580: 696c 6520 7472 7565 3b20 646f 270a 2020  ile true; do'.  
-00020590: 2020 2020 2020 2020 2020 6627 2020 2020            f'    
-000205a0: 6f75 7470 7574 3d24 2873 6b79 2073 6572  output=$(sky ser
-000205b0: 7665 2073 7461 7475 7320 7b6e 616d 657d  ve status {name}
-000205c0: 293b 270a 2020 2020 2020 2020 2020 2020  );'.            
-000205d0: 2720 2020 2020 6563 686f 2022 246f 7574  '     echo "$out
-000205e0: 7075 7422 207c 2067 7265 7020 2d71 2022  put" | grep -q "
-000205f0: 312f 3122 2026 2620 6272 6561 6b3b 270a  1/1" && break;'.
-00020600: 2020 2020 2020 2020 2020 2020 2720 2020              '   
-00020610: 2020 736c 6565 7020 3130 3b27 0a20 2020    sleep 10;'.   
-00020620: 2020 2020 2020 2020 2066 2764 6f6e 6529           f'done)
-00020630: 3b20 736c 6565 7020 7b73 6572 7665 2e4c  ; sleep {serve.L
-00020640: 425f 434f 4e54 524f 4c4c 4552 5f53 594e  B_CONTROLLER_SYN
-00020650: 435f 494e 5445 5256 414c 5f53 4543 4f4e  C_INTERVAL_SECON
-00020660: 4453 7d3b 272c 0a20 2020 2020 2020 2020  DS};',.         
-00020670: 2020 2066 277b 5f67 6574 5f73 6572 7665     f'{_get_serve
-00020680: 5f65 6e64 706f 696e 7428 6e61 6d65 297d  _endpoint(name)}
-00020690: 3b20 6375 726c 202d 4c20 6874 7470 3a2f  ; curl -L http:/
-000206a0: 2f24 656e 6470 6f69 6e74 207c 2067 7265  /$endpoint | gre
-000206b0: 7020 2248 692c 2053 6b79 5069 6c6f 7420  p "Hi, SkyPilot 
-000206c0: 6865 7265 2227 2c0a 2020 2020 2020 2020  here"',.        
-000206d0: 5d2c 0a20 2020 2020 2020 205f 5445 4152  ],.        _TEAR
-000206e0: 444f 574e 5f53 4552 5649 4345 2e66 6f72  DOWN_SERVICE.for
-000206f0: 6d61 7428 6e61 6d65 3d6e 616d 6529 2c0a  mat(name=name),.
-00020700: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
-00020710: 3230 202a 2036 302c 0a20 2020 2029 0a20  20 * 60,.    ). 
-00020720: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
-00020730: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
-00020740: 6d61 726b 2e67 6370 0a40 7079 7465 7374  mark.gcp.@pytest
-00020750: 2e6d 6172 6b2e 736b 795f 7365 7276 650a  .mark.sky_serve.
-00020760: 6465 6620 7465 7374 5f73 6b79 7365 7276  def test_skyserv
-00020770: 655f 6361 6e63 656c 2829 3a0a 2020 2020  e_cancel():.    
-00020780: 2222 2254 6573 7420 736b 7973 6572 7665  """Test skyserve
-00020790: 2077 6974 6820 6361 6e63 656c 2222 220a   with cancel""".
-000207a0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
-000207b0: 7365 7276 6963 655f 6e61 6d65 2829 0a0a  service_name()..
-000207c0: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-000207d0: 0a20 2020 2020 2020 2066 2774 6573 742d  .        f'test-
-000207e0: 736b 7973 6572 7665 2d63 616e 6365 6c27  skyserve-cancel'
-000207f0: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-00020800: 2020 2020 2020 2020 6627 736b 7920 7365          f'sky se
-00020810: 7276 6520 7570 202d 6e20 7b6e 616d 657d  rve up -n {name}
-00020820: 202d 7920 7465 7374 732f 736b 7973 6572   -y tests/skyser
-00020830: 7665 2f63 616e 6365 6c2f 6361 6e63 656c  ve/cancel/cancel
-00020840: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
-00020850: 2020 2020 5f53 4552 5645 5f57 4149 545f      _SERVE_WAIT_
-00020860: 554e 5449 4c5f 5245 4144 592e 666f 726d  UNTIL_READY.form
-00020870: 6174 286e 616d 653d 6e61 6d65 2c20 7265  at(name=name, re
-00020880: 706c 6963 615f 6e75 6d3d 3129 2c0a 2020  plica_num=1),.  
-00020890: 2020 2020 2020 2020 2020 6627 7b5f 6765            f'{_ge
-000208a0: 745f 7365 7276 655f 656e 6470 6f69 6e74  t_serve_endpoint
-000208b0: 286e 616d 6529 7d3b 2070 7974 686f 6e33  (name)}; python3
-000208c0: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
-000208d0: 7465 7374 732f 736b 7973 6572 7665 2f63  tests/skyserve/c
-000208e0: 616e 6365 6c2f 7365 6e64 5f63 616e 6365  ancel/send_cance
-000208f0: 6c5f 7265 7175 6573 742e 7079 2027 0a20  l_request.py '. 
-00020900: 2020 2020 2020 2020 2020 2027 2d2d 656e             '--en
-00020910: 6470 6f69 6e74 2024 656e 6470 6f69 6e74  dpoint $endpoint
-00020920: 207c 2067 7265 7020 2252 6571 7565 7374   | grep "Request
-00020930: 2077 6173 2063 616e 6365 6c6c 6564 2227   was cancelled"'
-00020940: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-00020950: 736b 7920 7365 7276 6520 6c6f 6773 207b  sky serve logs {
-00020960: 6e61 6d65 7d20 3120 2d2d 6e6f 2d66 6f6c  name} 1 --no-fol
-00020970: 6c6f 7720 7c20 6772 6570 2022 436c 6965  low | grep "Clie
-00020980: 6e74 2064 6973 636f 6e6e 6563 7465 642c  nt disconnected,
-00020990: 2073 746f 7070 696e 6720 636f 6d70 7574   stopping comput
-000209a0: 6174 696f 6e22 272c 0a20 2020 2020 2020  ation"',.       
-000209b0: 205d 2c0a 2020 2020 2020 2020 5f54 4541   ],.        _TEA
-000209c0: 5244 4f57 4e5f 5345 5256 4943 452e 666f  RDOWN_SERVICE.fo
-000209d0: 726d 6174 286e 616d 653d 6e61 6d65 292c  rmat(name=name),
-000209e0: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
-000209f0: 3d32 3020 2a20 3630 2c0a 2020 2020 290a  =20 * 60,.    ).
-00020a00: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-00020a10: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
-00020a20: 2e6d 6172 6b2e 6763 700a 4070 7974 6573  .mark.gcp.@pytes
-00020a30: 742e 6d61 726b 2e73 6b79 5f73 6572 7665  t.mark.sky_serve
-00020a40: 0a64 6566 2074 6573 745f 736b 7973 6572  .def test_skyser
-00020a50: 7665 5f75 7064 6174 6528 293a 0a20 2020  ve_update():.   
-00020a60: 2022 2222 5465 7374 2073 6b79 7365 7276   """Test skyserv
-00020a70: 6520 7769 7468 2075 7064 6174 6522 2222  e with update"""
-00020a80: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-00020a90: 5f73 6572 7669 6365 5f6e 616d 6528 290a  _service_name().
-00020aa0: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-00020ab0: 0a20 2020 2020 2020 2066 2774 6573 742d  .        f'test-
-00020ac0: 736b 7973 6572 7665 2d75 7064 6174 6527  skyserve-update'
-00020ad0: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-00020ae0: 2020 2020 2020 2020 6627 736b 7920 7365          f'sky se
-00020af0: 7276 6520 7570 202d 6e20 7b6e 616d 657d  rve up -n {name}
-00020b00: 202d 7920 7465 7374 732f 736b 7973 6572   -y tests/skyser
-00020b10: 7665 2f75 7064 6174 652f 6f6c 642e 7961  ve/update/old.ya
-00020b20: 6d6c 272c 0a20 2020 2020 2020 2020 2020  ml',.           
-00020b30: 205f 5345 5256 455f 5741 4954 5f55 4e54   _SERVE_WAIT_UNT
-00020b40: 494c 5f52 4541 4459 2e66 6f72 6d61 7428  IL_READY.format(
-00020b50: 6e61 6d65 3d6e 616d 652c 2072 6570 6c69  name=name, repli
-00020b60: 6361 5f6e 756d 3d31 292c 0a20 2020 2020  ca_num=1),.     
-00020b70: 2020 2020 2020 2066 277b 5f67 6574 5f73         f'{_get_s
-00020b80: 6572 7665 5f65 6e64 706f 696e 7428 6e61  erve_endpoint(na
-00020b90: 6d65 297d 3b20 6375 726c 202d 4c20 6874  me)}; curl -L ht
-00020ba0: 7470 3a2f 2f24 656e 6470 6f69 6e74 207c  tp://$endpoint |
-00020bb0: 2067 7265 7020 2248 692c 2053 6b79 5069   grep "Hi, SkyPi
-00020bc0: 6c6f 7420 6865 7265 2227 2c0a 2020 2020  lot here"',.    
-00020bd0: 2020 2020 2020 2020 6627 736b 7920 7365          f'sky se
-00020be0: 7276 6520 7570 6461 7465 207b 6e61 6d65  rve update {name
-00020bf0: 7d20 2d79 2074 6573 7473 2f73 6b79 7365  } -y tests/skyse
-00020c00: 7276 652f 7570 6461 7465 2f6e 6577 2e79  rve/update/new.y
-00020c10: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-00020c20: 2020 2320 736c 6565 7020 6265 666f 7265    # sleep before
-00020c30: 2075 7064 6174 6520 6973 2072 6567 6973   update is regis
-00020c40: 7465 7265 642e 0a20 2020 2020 2020 2020  tered..         
-00020c50: 2020 2027 736c 6565 7020 3230 272c 0a20     'sleep 20',. 
-00020c60: 2020 2020 2020 2020 2020 205f 5345 5256             _SERV
-00020c70: 455f 5741 4954 5f55 4e54 494c 5f52 4541  E_WAIT_UNTIL_REA
-00020c80: 4459 2e66 6f72 6d61 7428 6e61 6d65 3d6e  DY.format(name=n
-00020c90: 616d 652c 2072 6570 6c69 6361 5f6e 756d  ame, replica_num
-00020ca0: 3d31 292c 0a20 2020 2020 2020 2020 2020  =1),.           
-00020cb0: 2066 277b 5f67 6574 5f73 6572 7665 5f65   f'{_get_serve_e
-00020cc0: 6e64 706f 696e 7428 6e61 6d65 297d 3b20  ndpoint(name)}; 
-00020cd0: 6375 726c 202d 4c20 6874 7470 3a2f 2f24  curl -L http://$
-00020ce0: 656e 6470 6f69 6e74 207c 2067 7265 7020  endpoint | grep 
-00020cf0: 2248 692c 206e 6577 2053 6b79 5069 6c6f  "Hi, new SkyPilo
-00020d00: 7420 6865 7265 2122 272c 0a20 2020 2020  t here!"',.     
-00020d10: 2020 205d 2c0a 2020 2020 2020 2020 5f54     ],.        _T
-00020d20: 4541 5244 4f57 4e5f 5345 5256 4943 452e  EARDOWN_SERVICE.
-00020d30: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
-00020d40: 292c 0a20 2020 2020 2020 2074 696d 656f  ),.        timeo
-00020d50: 7574 3d32 3020 2a20 3630 2c0a 2020 2020  ut=20 * 60,.    
-00020d60: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-00020d70: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
-00020d80: 7374 2e6d 6172 6b2e 6763 700a 4070 7974  st.mark.gcp.@pyt
-00020d90: 6573 742e 6d61 726b 2e73 6b79 5f73 6572  est.mark.sky_ser
-00020da0: 7665 0a64 6566 2074 6573 745f 736b 7973  ve.def test_skys
-00020db0: 6572 7665 5f75 7064 6174 655f 6175 746f  erve_update_auto
-00020dc0: 7363 616c 6528 293a 0a20 2020 2022 2222  scale():.    """
-00020dd0: 5465 7374 2073 6b79 7365 7276 6520 7570  Test skyserve up
-00020de0: 6461 7465 2077 6974 6820 6175 746f 7363  date with autosc
-00020df0: 616c 6522 2222 0a20 2020 206e 616d 6520  ale""".    name 
-00020e00: 3d20 5f67 6574 5f73 6572 7669 6365 5f6e  = _get_service_n
-00020e10: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
-00020e20: 2054 6573 7428 0a20 2020 2020 2020 2066   Test(.        f
-00020e30: 2774 6573 742d 736b 7973 6572 7665 2d75  'test-skyserve-u
-00020e40: 7064 6174 652d 6175 746f 7363 616c 6527  pdate-autoscale'
-00020e50: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
-00020e60: 2020 2020 2020 2020 6627 736b 7920 7365          f'sky se
-00020e70: 7276 6520 7570 202d 6e20 7b6e 616d 657d  rve up -n {name}
-00020e80: 202d 7920 7465 7374 732f 736b 7973 6572   -y tests/skyser
-00020e90: 7665 2f75 7064 6174 652f 6e75 6d5f 6d69  ve/update/num_mi
-00020ea0: 6e5f 7477 6f2e 7961 6d6c 272c 0a20 2020  n_two.yaml',.   
-00020eb0: 2020 2020 2020 2020 205f 5345 5256 455f           _SERVE_
-00020ec0: 5741 4954 5f55 4e54 494c 5f52 4541 4459  WAIT_UNTIL_READY
-00020ed0: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
-00020ee0: 652c 2072 6570 6c69 6361 5f6e 756d 3d32  e, replica_num=2
-00020ef0: 292c 0a20 2020 2020 2020 2020 2020 2066  ),.            f
-00020f00: 277b 5f67 6574 5f73 6572 7665 5f65 6e64  '{_get_serve_end
-00020f10: 706f 696e 7428 6e61 6d65 297d 3b20 6375  point(name)}; cu
-00020f20: 726c 202d 4c20 6874 7470 3a2f 2f24 656e  rl -L http://$en
-00020f30: 6470 6f69 6e74 207c 2067 7265 7020 2248  dpoint | grep "H
-00020f40: 692c 2053 6b79 5069 6c6f 7420 6865 7265  i, SkyPilot here
-00020f50: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
-00020f60: 6627 736b 7920 7365 7276 6520 7570 6461  f'sky serve upda
-00020f70: 7465 207b 6e61 6d65 7d20 2d79 2074 6573  te {name} -y tes
-00020f80: 7473 2f73 6b79 7365 7276 652f 7570 6461  ts/skyserve/upda
-00020f90: 7465 2f6e 756d 5f6d 696e 5f6f 6e65 2e79  te/num_min_one.y
-00020fa0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
-00020fb0: 2020 2320 736c 6565 7020 6265 666f 7265    # sleep before
-00020fc0: 2075 7064 6174 6520 6973 2072 6567 6973   update is regis
-00020fd0: 7465 7265 642e 0a20 2020 2020 2020 2020  tered..         
-00020fe0: 2020 2027 736c 6565 7020 3230 272c 0a20     'sleep 20',. 
-00020ff0: 2020 2020 2020 2020 2020 2023 2054 696d             # Tim
-00021000: 656f 7574 2077 696c 6c20 6265 2074 7269  eout will be tri
-00021010: 6767 6572 6564 2077 6865 6e20 7570 6461  ggered when upda
-00021020: 7465 2066 6169 6c73 2e0a 2020 2020 2020  te fails..      
-00021030: 2020 2020 2020 5f53 4552 5645 5f57 4149        _SERVE_WAI
-00021040: 545f 554e 5449 4c5f 5245 4144 592e 666f  T_UNTIL_READY.fo
-00021050: 726d 6174 286e 616d 653d 6e61 6d65 2c20  rmat(name=name, 
-00021060: 7265 706c 6963 615f 6e75 6d3d 3129 2c0a  replica_num=1),.
-00021070: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
-00021080: 6765 745f 7365 7276 655f 656e 6470 6f69  get_serve_endpoi
-00021090: 6e74 286e 616d 6529 7d3b 2063 7572 6c20  nt(name)}; curl 
-000210a0: 2d4c 2068 7474 703a 2f2f 2465 6e64 706f  -L http://$endpo
-000210b0: 696e 7420 7c20 6772 6570 2022 4869 2c20  int | grep "Hi, 
-000210c0: 536b 7950 696c 6f74 2068 6572 6521 2227  SkyPilot here!"'
-000210d0: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-000210e0: 2020 2020 205f 5445 4152 444f 574e 5f53       _TEARDOWN_S
-000210f0: 4552 5649 4345 2e66 6f72 6d61 7428 6e61  ERVICE.format(na
-00021100: 6d65 3d6e 616d 6529 2c0a 2020 2020 2020  me=name),.      
-00021110: 2020 7469 6d65 6f75 743d 3230 202a 2036    timeout=20 * 6
-00021120: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
-00021130: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
-00021140: 0a0a 2320 2d2d 2d2d 2d2d 2d20 5465 7374  ..# ------- Test
-00021150: 696e 6720 7573 6572 2072 6179 2063 6c75  ing user ray clu
-00021160: 7374 6572 202d 2d2d 2d2d 2d2d 2d0a 6465  ster --------.de
-00021170: 6620 7465 7374 5f75 7365 725f 7261 795f  f test_user_ray_
-00021180: 636c 7573 7465 7228 6765 6e65 7269 635f  cluster(generic_
-00021190: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
-000211a0: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-000211b0: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-000211c0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-000211d0: 2020 2020 2027 7573 6572 2d72 6179 2d63       'user-ray-c
-000211e0: 6c75 7374 6572 272c 0a20 2020 2020 2020  luster',.       
-000211f0: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
-00021200: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
-00021210: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
-00021220: 207b 6765 6e65 7269 635f 636c 6f75 647d   {generic_cloud}
-00021230: 2022 7261 7920 7374 6172 7420 2d2d 6865   "ray start --he
-00021240: 6164 2227 2c0a 2020 2020 2020 2020 2020  ad"',.          
-00021250: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
-00021260: 6d65 7d20 2265 6368 6f20 6869 2227 2c0a  me} "echo hi"',.
-00021270: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-00021280: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
-00021290: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
-000212a0: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
-000212b0: 7475 7320 2d72 207b 6e61 6d65 7d20 7c20  tus -r {name} | 
-000212c0: 6772 6570 2055 5027 2c0a 2020 2020 2020  grep UP',.      
-000212d0: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
-000212e0: 207b 6e61 6d65 7d20 2265 6368 6f20 6279   {name} "echo by
-000212f0: 6522 272c 0a20 2020 2020 2020 2020 2020  e"',.           
-00021300: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
-00021310: 657d 2032 202d 2d73 7461 7475 7327 2c0a  e} 2 --status',.
-00021320: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-00021330: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
-00021340: 207b 6e61 6d65 7d27 2c0a 2020 2020 290a   {name}',.    ).
-00021350: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
-00021360: 2874 6573 7429 0a0a 0a5f 434f 4445 5f50  (test)..._CODE_P
-00021370: 5245 4649 5820 3d20 5b27 696d 706f 7274  REFIX = ['import
-00021380: 2073 6b79 275d 0a0a 0a64 6566 205f 6275   sky']...def _bu
-00021390: 696c 6428 636f 6465 3a20 4c69 7374 5b73  ild(code: List[s
-000213a0: 7472 5d29 202d 3e20 7374 723a 0a20 2020  tr]) -> str:.   
-000213b0: 2063 6f64 6520 3d20 5f43 4f44 455f 5052   code = _CODE_PR
-000213c0: 4546 4958 202b 2063 6f64 650a 2020 2020  EFIX + code.    
-000213d0: 636f 6465 203d 2027 3b27 2e6a 6f69 6e28  code = ';'.join(
-000213e0: 636f 6465 290a 2020 2020 7265 7475 726e  code).    return
-000213f0: 2066 2770 7974 686f 6e33 202d 7520 2d63   f'python3 -u -c
-00021400: 207b 7368 6c65 782e 7175 6f74 6528 636f   {shlex.quote(co
-00021410: 6465 297d 270a 0a0a 2320 2d2d 2d2d 2d2d  de)}'...# ------
-00021420: 2d20 5465 7374 696e 6720 7468 6520 636f  - Testing the co
-00021430: 7265 2041 5049 202d 2d2d 2d2d 2d2d 2d0a  re API --------.
-00021440: 2320 4d6f 7374 206f 6620 7468 6520 636f  # Most of the co
-00021450: 7265 2041 5049 7320 6861 7665 2062 6565  re APIs have bee
-00021460: 6e20 7465 7374 6564 2069 6e20 7468 6520  n tested in the 
-00021470: 434c 4920 7465 7374 732e 0a23 2054 6865  CLI tests..# The
-00021480: 7365 2074 6573 7473 2061 7265 2066 6f72  se tests are for
-00021490: 2074 6573 7469 6e67 2074 6865 2072 6574   testing the ret
-000214a0: 7572 6e20 7661 6c75 6520 6f66 2074 6865  urn value of the
-000214b0: 2041 5049 7320 6e6f 7420 6675 6c6c 7920   APIs not fully 
-000214c0: 7573 6564 2069 6e20 434c 492e 0a0a 0a40  used in CLI....@
-000214d0: 7079 7465 7374 2e6d 6172 6b2e 6763 700a  pytest.mark.gcp.
-000214e0: 6465 6620 7465 7374 5f63 6f72 655f 6170  def test_core_ap
-000214f0: 695f 736b 795f 6c61 756e 6368 5f65 7865  i_sky_launch_exe
-00021500: 6328 293a 0a20 2020 206e 616d 6520 3d20  c():.    name = 
-00021510: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
-00021520: 6528 290a 2020 2020 7461 736b 203d 2073  e().    task = s
-00021530: 6b79 2e54 6173 6b28 7275 6e3d 2277 686f  ky.Task(run="who
-00021540: 616d 6922 290a 2020 2020 7461 736b 2e73  ami").    task.s
-00021550: 6574 5f72 6573 6f75 7263 6573 2873 6b79  et_resources(sky
-00021560: 2e52 6573 6f75 7263 6573 2863 6c6f 7564  .Resources(cloud
-00021570: 3d73 6b79 2e47 4350 2829 2929 0a20 2020  =sky.GCP())).   
-00021580: 206a 6f62 5f69 642c 2068 616e 646c 6520   job_id, handle 
-00021590: 3d20 736b 792e 6c61 756e 6368 2874 6173  = sky.launch(tas
-000215a0: 6b2c 2063 6c75 7374 6572 5f6e 616d 653d  k, cluster_name=
-000215b0: 6e61 6d65 290a 2020 2020 6173 7365 7274  name).    assert
-000215c0: 206a 6f62 5f69 6420 3d3d 2031 0a20 2020   job_id == 1.   
-000215d0: 2061 7373 6572 7420 6861 6e64 6c65 2069   assert handle i
-000215e0: 7320 6e6f 7420 4e6f 6e65 0a20 2020 2061  s not None.    a
-000215f0: 7373 6572 7420 6861 6e64 6c65 2e63 6c75  ssert handle.clu
-00021600: 7374 6572 5f6e 616d 6520 3d3d 206e 616d  ster_name == nam
-00021610: 650a 2020 2020 6173 7365 7274 2068 616e  e.    assert han
-00021620: 646c 652e 6c61 756e 6368 6564 5f72 6573  dle.launched_res
-00021630: 6f75 7263 6573 2e63 6c6f 7564 2e69 735f  ources.cloud.is_
-00021640: 7361 6d65 5f63 6c6f 7564 2873 6b79 2e47  same_cloud(sky.G
-00021650: 4350 2829 290a 2020 2020 6a6f 625f 6964  CP()).    job_id
-00021660: 5f65 7865 632c 2068 616e 646c 655f 6578  _exec, handle_ex
-00021670: 6563 203d 2073 6b79 2e65 7865 6328 7461  ec = sky.exec(ta
-00021680: 736b 2c20 636c 7573 7465 725f 6e61 6d65  sk, cluster_name
-00021690: 3d6e 616d 6529 0a20 2020 2061 7373 6572  =name).    asser
-000216a0: 7420 6a6f 625f 6964 5f65 7865 6320 3d3d  t job_id_exec ==
-000216b0: 2032 0a20 2020 2061 7373 6572 7420 6861   2.    assert ha
-000216c0: 6e64 6c65 5f65 7865 6320 6973 206e 6f74  ndle_exec is not
-000216d0: 204e 6f6e 650a 2020 2020 6173 7365 7274   None.    assert
-000216e0: 2068 616e 646c 655f 6578 6563 2e63 6c75   handle_exec.clu
-000216f0: 7374 6572 5f6e 616d 6520 3d3d 206e 616d  ster_name == nam
-00021700: 650a 2020 2020 6173 7365 7274 2068 616e  e.    assert han
-00021710: 646c 655f 6578 6563 2e6c 6175 6e63 6865  dle_exec.launche
-00021720: 645f 7265 736f 7572 6365 732e 636c 6f75  d_resources.clou
-00021730: 642e 6973 5f73 616d 655f 636c 6f75 6428  d.is_same_cloud(
-00021740: 736b 792e 4743 5028 2929 0a20 2020 2023  sky.GCP()).    #
-00021750: 2046 6f72 2064 756d 6d79 2074 6173 6b20   For dummy task 
-00021760: 2869 2e65 2e20 7461 736b 2e72 756e 2069  (i.e. task.run i
-00021770: 7320 4e6f 6e65 292c 2074 6865 206a 6f62  s None), the job
-00021780: 2077 6f6e 2774 2062 6520 7375 626d 6974   won't be submit
-00021790: 7465 642e 0a20 2020 2064 756d 6d79 5f74  ted..    dummy_t
-000217a0: 6173 6b20 3d20 736b 792e 5461 736b 2829  ask = sky.Task()
-000217b0: 0a20 2020 206a 6f62 5f69 645f 6475 6d6d  .    job_id_dumm
-000217c0: 792c 205f 203d 2073 6b79 2e65 7865 6328  y, _ = sky.exec(
-000217d0: 6475 6d6d 795f 7461 736b 2c20 636c 7573  dummy_task, clus
-000217e0: 7465 725f 6e61 6d65 3d6e 616d 6529 0a20  ter_name=name). 
-000217f0: 2020 2061 7373 6572 7420 6a6f 625f 6964     assert job_id
-00021800: 5f64 756d 6d79 2069 7320 4e6f 6e65 0a20  _dummy is None. 
-00021810: 2020 2073 6b79 2e64 6f77 6e28 6e61 6d65     sky.down(name
-00021820: 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d  )...# ----------
-00021830: 2054 6573 7469 6e67 2053 746f 7261 6765   Testing Storage
-00021840: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 636c 6173   ----------.clas
-00021850: 7320 5465 7374 5374 6f72 6167 6557 6974  s TestStorageWit
-00021860: 6843 7265 6465 6e74 6961 6c73 3a0a 2020  hCredentials:.  
-00021870: 2020 2222 2253 746f 7261 6765 2074 6573    """Storage tes
-00021880: 7473 2077 6869 6368 2072 6571 7569 7265  ts which require
-00021890: 2063 7265 6465 6e74 6961 6c73 2061 6e64   credentials and
-000218a0: 206e 6574 776f 726b 2063 6f6e 6e65 6374   network connect
-000218b0: 696f 6e22 2222 0a0a 2020 2020 4157 535f  ion"""..    AWS_
-000218c0: 494e 5641 4c49 445f 4e41 4d45 5320 3d20  INVALID_NAMES = 
-000218d0: 5b0a 2020 2020 2020 2020 2761 6227 2c20  [.        'ab', 
-000218e0: 2023 206c 6573 7320 7468 616e 2033 2063   # less than 3 c
-000218f0: 6861 7261 6374 6572 730a 2020 2020 2020  haracters.      
-00021900: 2020 2761 6263 6465 6667 6869 6a6b 6c6d    'abcdefghijklm
-00021910: 6e6f 7071 7273 7475 7677 7879 7a61 6263  nopqrstuvwxyzabc
-00021920: 6465 6667 6869 6a6b 6c6d 6e6f 7071 7273  defghijklmnopqrs
-00021930: 7475 7677 7879 7a61 6263 6465 6667 6869  tuvwxyzabcdefghi
-00021940: 6a6b 6c6d 6e6f 7071 7273 7475 7677 7879  jklmnopqrstuvwxy
-00021950: 7a31 272c 0a20 2020 2020 2020 2023 206d  z1',.        # m
-00021960: 6f72 6520 7468 616e 2036 3320 6368 6172  ore than 63 char
-00021970: 6163 7465 7273 0a20 2020 2020 2020 2027  acters.        '
-00021980: 4162 6364 6566 272c 2020 2320 636f 6e74  Abcdef',  # cont
-00021990: 6169 6e73 2061 6e20 7570 7065 7263 6173  ains an uppercas
-000219a0: 6520 6c65 7474 6572 0a20 2020 2020 2020  e letter.       
-000219b0: 2027 6162 6320 6465 6627 2c20 2023 2063   'abc def',  # c
-000219c0: 6f6e 7461 696e 7320 6120 7370 6163 650a  ontains a space.
-000219d0: 2020 2020 2020 2020 2761 6263 2e2e 6465          'abc..de
-000219e0: 6627 2c20 2023 2074 776f 2061 646a 6163  f',  # two adjac
-000219f0: 656e 7420 7065 7269 6f64 730a 2020 2020  ent periods.    
-00021a00: 2020 2020 2731 3932 2e31 3638 2e35 2e34      '192.168.5.4
-00021a10: 272c 2020 2320 666f 726d 6174 7465 6420  ',  # formatted 
-00021a20: 6173 2061 6e20 4950 2061 6464 7265 7373  as an IP address
-00021a30: 0a20 2020 2020 2020 2027 786e 2d2d 6275  .        'xn--bu
-00021a40: 636b 6574 272c 2020 2320 7374 6172 7473  cket',  # starts
-00021a50: 2077 6974 6820 2778 6e2d 2d27 2070 7265   with 'xn--' pre
-00021a60: 6669 780a 2020 2020 2020 2020 2762 7563  fix.        'buc
-00021a70: 6b65 742d 7333 616c 6961 7327 2c20 2023  ket-s3alias',  #
-00021a80: 2065 6e64 7320 7769 7468 2027 2d73 3361   ends with '-s3a
-00021a90: 6c69 6173 2720 7375 6666 6978 0a20 2020  lias' suffix.   
-00021aa0: 2020 2020 2027 6275 636b 6574 2d2d 6f6c       'bucket--ol
-00021ab0: 2d73 3327 2c20 2023 2065 6e64 7320 7769  -s3',  # ends wi
-00021ac0: 7468 2027 2d2d 6f6c 2d73 3327 2073 7566  th '--ol-s3' suf
-00021ad0: 6669 780a 2020 2020 2020 2020 272e 6162  fix.        '.ab
-00021ae0: 6327 2c20 2023 2073 7461 7274 7320 7769  c',  # starts wi
-00021af0: 7468 2061 2064 6f74 0a20 2020 2020 2020  th a dot.       
-00021b00: 2027 6162 632e 272c 2020 2320 656e 6473   'abc.',  # ends
-00021b10: 2077 6974 6820 6120 646f 740a 2020 2020   with a dot.    
-00021b20: 2020 2020 272d 6162 6327 2c20 2023 2073      '-abc',  # s
-00021b30: 7461 7274 7320 7769 7468 2061 2068 7970  tarts with a hyp
-00021b40: 6865 6e0a 2020 2020 2020 2020 2761 6263  hen.        'abc
-00021b50: 2d27 2c20 2023 2065 6e64 7320 7769 7468  -',  # ends with
-00021b60: 2061 2068 7970 6865 6e0a 2020 2020 5d0a   a hyphen.    ].
-00021b70: 0a20 2020 2047 4353 5f49 4e56 414c 4944  .    GCS_INVALID
-00021b80: 5f4e 414d 4553 203d 205b 0a20 2020 2020  _NAMES = [.     
-00021b90: 2020 2027 6162 272c 2020 2320 6c65 7373     'ab',  # less
-00021ba0: 2074 6861 6e20 3320 6368 6172 6163 7465   than 3 characte
-00021bb0: 7273 0a20 2020 2020 2020 2027 6162 6364  rs.        'abcd
-00021bc0: 6566 6768 696a 6b6c 6d6e 6f70 7172 7374  efghijklmnopqrst
-00021bd0: 7576 7778 797a 6162 6364 6566 6768 696a  uvwxyzabcdefghij
-00021be0: 6b6c 6d6e 6f70 7172 7374 7576 7778 797a  klmnopqrstuvwxyz
-00021bf0: 6162 6364 6566 6768 696a 6b6c 6d6e 6f70  abcdefghijklmnop
-00021c00: 7172 7374 7576 7778 797a 3127 2c0a 2020  qrstuvwxyz1',.  
-00021c10: 2020 2020 2020 2320 6d6f 7265 2074 6861        # more tha
-00021c20: 6e20 3633 2063 6861 7261 6374 6572 7320  n 63 characters 
-00021c30: 2877 6974 686f 7574 2064 6f74 7329 0a20  (without dots). 
-00021c40: 2020 2020 2020 2027 4162 6364 6566 272c         'Abcdef',
-00021c50: 2020 2320 636f 6e74 6169 6e73 2061 6e20    # contains an 
-00021c60: 7570 7065 7263 6173 6520 6c65 7474 6572  uppercase letter
-00021c70: 0a20 2020 2020 2020 2027 6162 6320 6465  .        'abc de
-00021c80: 6627 2c20 2023 2063 6f6e 7461 696e 7320  f',  # contains 
-00021c90: 6120 7370 6163 650a 2020 2020 2020 2020  a space.        
-00021ca0: 2761 6263 2e2e 6465 6627 2c20 2023 2074  'abc..def',  # t
-00021cb0: 776f 2061 646a 6163 656e 7420 7065 7269  wo adjacent peri
-00021cc0: 6f64 730a 2020 2020 2020 2020 2761 6263  ods.        'abc
-00021cd0: 5f2e 6465 662e 6768 692e 6a6b 6c6d 6e6f  _.def.ghi.jklmno
-00021ce0: 7071 7273 7475 7677 7879 7a61 6263 6465  pqrstuvwxyzabcde
-00021cf0: 6667 6869 6a6b 6c6d 6e6f 7071 7273 7475  fghijklmnopqrstu
-00021d00: 7677 7879 7a61 6263 6465 6667 6869 6a6b  vwxyzabcdefghijk
-00021d10: 6c6d 6e6f 7071 7273 7475 7677 7879 7a31  lmnopqrstuvwxyz1
-00021d20: 270a 2020 2020 2020 2020 2320 4d6f 7265  '.        # More
-00021d30: 2074 6861 6e20 3633 2063 6861 7261 6374   than 63 charact
-00021d40: 6572 7320 6265 7477 6565 6e20 646f 7473  ers between dots
-00021d50: 0a20 2020 2020 2020 2027 6162 635f 2e64  .        'abc_.d
-00021d60: 6566 2e67 6869 2e6a 6b6c 6d6e 6f70 7172  ef.ghi.jklmnopqr
-00021d70: 7374 7576 7778 797a 6162 6364 6566 6768  stuvwxyzabcdefgh
-00021d80: 696a 6b6c 6d6e 6f70 7166 6768 696a 6b6c  ijklmnopqfghijkl
-00021d90: 6d6e 6f70 7172 7374 7576 7727 202a 2035  mnopqrstuvw' * 5
-00021da0: 2c0a 2020 2020 2020 2020 2320 6d6f 7265  ,.        # more
-00021db0: 2074 6861 6e20 3232 3220 6368 6172 6163   than 222 charac
-00021dc0: 7465 7273 2028 7769 7468 2064 6f74 7329  ters (with dots)
-00021dd0: 0a20 2020 2020 2020 2027 3139 322e 3136  .        '192.16
-00021de0: 382e 352e 3427 2c20 2023 2066 6f72 6d61  8.5.4',  # forma
-00021df0: 7474 6564 2061 7320 616e 2049 5020 6164  tted as an IP ad
-00021e00: 6472 6573 730a 2020 2020 2020 2020 2767  dress.        'g
-00021e10: 6f6f 6762 7563 6b65 7427 2c20 2023 2073  oogbucket',  # s
-00021e20: 7461 7274 7320 7769 7468 2027 676f 6f67  tarts with 'goog
-00021e30: 2720 7072 6566 6978 0a20 2020 2020 2020  ' prefix.       
-00021e40: 2027 676f 6f67 6c65 6275 636b 6574 272c   'googlebucket',
-00021e50: 2020 2320 636f 6e74 6169 6e73 2027 676f    # contains 'go
-00021e60: 6f67 6c65 270a 2020 2020 2020 2020 2767  ogle'.        'g
-00021e70: 3030 676c 6562 7563 6b65 7427 2c20 2023  00glebucket',  #
-00021e80: 2076 6172 6961 6e74 206f 6620 2767 6f6f   variant of 'goo
-00021e90: 676c 6527 0a20 2020 2020 2020 2027 676f  gle'.        'go
-00021ea0: 3067 6c65 6275 636b 6574 272c 2020 2320  0glebucket',  # 
-00021eb0: 7661 7269 616e 7420 6f66 2027 676f 6f67  variant of 'goog
-00021ec0: 6c65 270a 2020 2020 2020 2020 2767 306f  le'.        'g0o
-00021ed0: 676c 6562 7563 6b65 7427 2c20 2023 2076  glebucket',  # v
-00021ee0: 6172 6961 6e74 206f 6620 2767 6f6f 676c  ariant of 'googl
-00021ef0: 6527 0a20 2020 2020 2020 2027 2e61 6263  e'.        '.abc
-00021f00: 272c 2020 2320 7374 6172 7473 2077 6974  ',  # starts wit
-00021f10: 6820 6120 646f 740a 2020 2020 2020 2020  h a dot.        
-00021f20: 2761 6263 2e27 2c20 2023 2065 6e64 7320  'abc.',  # ends 
-00021f30: 7769 7468 2061 2064 6f74 0a20 2020 2020  with a dot.     
-00021f40: 2020 2027 5f61 6263 272c 2020 2320 7374     '_abc',  # st
-00021f50: 6172 7473 2077 6974 6820 616e 2075 6e64  arts with an und
-00021f60: 6572 7363 6f72 650a 2020 2020 2020 2020  erscore.        
-00021f70: 2761 6263 5f27 2c20 2023 2065 6e64 7320  'abc_',  # ends 
-00021f80: 7769 7468 2061 6e20 756e 6465 7273 636f  with an undersco
-00021f90: 7265 0a20 2020 205d 0a0a 2020 2020 4942  re.    ]..    IB
-00021fa0: 4d5f 494e 5641 4c49 445f 4e41 4d45 5320  M_INVALID_NAMES 
-00021fb0: 3d20 5b0a 2020 2020 2020 2020 2761 6227  = [.        'ab'
-00021fc0: 2c20 2023 206c 6573 7320 7468 616e 2033  ,  # less than 3
-00021fd0: 2063 6861 7261 6374 6572 730a 2020 2020   characters.    
-00021fe0: 2020 2020 2761 6263 6465 6667 6869 6a6b      'abcdefghijk
-00021ff0: 6c6d 6e6f 7071 7273 7475 7677 7879 7a61  lmnopqrstuvwxyza
-00022000: 6263 6465 6667 6869 6a6b 6c6d 6e6f 7071  bcdefghijklmnopq
-00022010: 7273 7475 7677 7879 7a61 6263 6465 6667  rstuvwxyzabcdefg
-00022020: 6869 6a6b 6c6d 6e6f 7071 7273 7475 7677  hijklmnopqrstuvw
-00022030: 7879 7a31 272c 0a20 2020 2020 2020 2023  xyz1',.        #
-00022040: 206d 6f72 6520 7468 616e 2036 3320 6368   more than 63 ch
-00022050: 6172 6163 7465 7273 0a20 2020 2020 2020  aracters.       
-00022060: 2027 4162 6364 6566 272c 2020 2320 636f   'Abcdef',  # co
-00022070: 6e74 6169 6e73 2061 6e20 7570 7065 7263  ntains an upperc
-00022080: 6173 6520 6c65 7474 6572 0a20 2020 2020  ase letter.     
-00022090: 2020 2027 6162 6320 6465 6627 2c20 2023     'abc def',  #
-000220a0: 2063 6f6e 7461 696e 7320 6120 7370 6163   contains a spac
-000220b0: 650a 2020 2020 2020 2020 2761 6263 2e2e  e.        'abc..
-000220c0: 6465 6627 2c20 2023 2074 776f 2061 646a  def',  # two adj
-000220d0: 6163 656e 7420 7065 7269 6f64 730a 2020  acent periods.  
-000220e0: 2020 2020 2020 2731 3932 2e31 3638 2e35        '192.168.5
-000220f0: 2e34 272c 2020 2320 666f 726d 6174 7465  .4',  # formatte
-00022100: 6420 6173 2061 6e20 4950 2061 6464 7265  d as an IP addre
-00022110: 7373 0a20 2020 2020 2020 2027 786e 2d2d  ss.        'xn--
-00022120: 6275 636b 6574 272c 2020 2320 7374 6172  bucket',  # star
-00022130: 7473 2077 6974 6820 2778 6e2d 2d27 2070  ts with 'xn--' p
-00022140: 7265 6669 780a 2020 2020 2020 2020 272e  refix.        '.
-00022150: 6162 6327 2c20 2023 2073 7461 7274 7320  abc',  # starts 
-00022160: 7769 7468 2061 2064 6f74 0a20 2020 2020  with a dot.     
-00022170: 2020 2027 6162 632e 272c 2020 2320 656e     'abc.',  # en
-00022180: 6473 2077 6974 6820 6120 646f 740a 2020  ds with a dot.  
-00022190: 2020 2020 2020 272d 6162 6327 2c20 2023        '-abc',  #
-000221a0: 2073 7461 7274 7320 7769 7468 2061 2068   starts with a h
-000221b0: 7970 6865 6e0a 2020 2020 2020 2020 2761  yphen.        'a
-000221c0: 6263 2d27 2c20 2023 2065 6e64 7320 7769  bc-',  # ends wi
-000221d0: 7468 2061 2068 7970 6865 6e0a 2020 2020  th a hyphen.    
-000221e0: 2020 2020 2761 2e2d 6263 272c 2020 2320      'a.-bc',  # 
-000221f0: 636f 6e74 6169 6e73 2074 6865 2073 6571  contains the seq
-00022200: 7565 6e63 6520 272e 2d27 0a20 2020 2020  uence '.-'.     
-00022210: 2020 2027 612d 2e62 6327 2c20 2023 2063     'a-.bc',  # c
-00022220: 6f6e 7461 696e 7320 7468 6520 7365 7175  ontains the sequ
-00022230: 656e 6365 2027 2d2e 270a 2020 2020 2020  ence '-.'.      
-00022240: 2020 2761 2662 6327 2020 2320 636f 6e74    'a&bc'  # cont
-00022250: 6169 6e73 2073 7065 6369 616c 2063 6861  ains special cha
-00022260: 7261 6374 6572 730a 2020 2020 2020 2020  racters.        
-00022270: 2761 625e 6327 2020 2320 636f 6e74 6169  'ab^c'  # contai
-00022280: 6e73 2073 7065 6369 616c 2063 6861 7261  ns special chara
-00022290: 6374 6572 730a 2020 2020 5d0a 2020 2020  cters.    ].    
-000222a0: 4749 5449 474e 4f52 455f 5359 4e43 5f54  GITIGNORE_SYNC_T
-000222b0: 4553 545f 4449 525f 5354 5255 4354 5552  EST_DIR_STRUCTUR
-000222c0: 4520 3d20 7b0a 2020 2020 2020 2020 2764  E = {.        'd
-000222d0: 6f75 626c 655f 6173 7465 7269 736b 273a  ouble_asterisk':
-000222e0: 207b 0a20 2020 2020 2020 2020 2020 2027   {.            '
-000222f0: 646f 7562 6c65 5f61 7374 6572 6973 6b5f  double_asterisk_
-00022300: 6578 636c 7564 6564 273a 204e 6f6e 652c  excluded': None,
-00022310: 0a20 2020 2020 2020 2020 2020 2027 646f  .            'do
-00022320: 7562 6c65 5f61 7374 6572 6973 6b5f 6578  uble_asterisk_ex
-00022330: 636c 7564 6564 5f64 6972 273a 207b 0a20  cluded_dir': {. 
-00022340: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00022350: 6469 725f 6578 636c 7564 6564 273a 204e  dir_excluded': N
-00022360: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
-00022370: 207d 2c0a 2020 2020 2020 2020 7d2c 0a20   },.        },. 
-00022380: 2020 2020 2020 2027 646f 7562 6c65 5f61         'double_a
-00022390: 7374 6572 6973 6b5f 7061 7265 6e74 273a  sterisk_parent':
-000223a0: 207b 0a20 2020 2020 2020 2020 2020 2027   {.            '
-000223b0: 7061 7265 6e74 273a 207b 0a20 2020 2020  parent': {.     
-000223c0: 2020 2020 2020 2020 2020 2027 616c 736f             'also
-000223d0: 5f65 7863 6c75 6465 642e 7478 7427 3a20  _excluded.txt': 
-000223e0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
-000223f0: 2020 2020 2020 2763 6869 6c64 273a 207b        'child': {
-00022400: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022410: 2020 2020 2027 646f 7562 6c65 5f61 7374       'double_ast
-00022420: 6572 6973 6b5f 7061 7265 6e74 5f63 6869  erisk_parent_chi
-00022430: 6c64 5f65 7863 6c75 6465 642e 7478 7427  ld_excluded.txt'
-00022440: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
-00022450: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
-00022460: 2020 2020 2020 2020 2020 2027 646f 7562             'doub
-00022470: 6c65 5f61 7374 6572 6973 6b5f 7061 7265  le_asterisk_pare
-00022480: 6e74 5f65 7863 6c75 6465 642e 7478 7427  nt_excluded.txt'
-00022490: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
-000224a0: 2020 2020 7d2c 0a20 2020 2020 2020 207d      },.        }
-000224b0: 2c0a 2020 2020 2020 2020 2765 7863 6c75  ,.        'exclu
-000224c0: 6465 642e 6c6f 6727 3a20 4e6f 6e65 2c0a  ded.log': None,.
-000224d0: 2020 2020 2020 2020 2765 7863 6c75 6465          'exclude
-000224e0: 645f 6469 7227 3a20 7b0a 2020 2020 2020  d_dir': {.      
-000224f0: 2020 2020 2020 2765 7863 6c75 6465 642e        'excluded.
-00022500: 7478 7427 3a20 4e6f 6e65 2c0a 2020 2020  txt': None,.    
-00022510: 2020 2020 2020 2020 276e 6573 7465 645f          'nested_
-00022520: 6578 636c 7564 6564 273a 207b 0a20 2020  excluded': {.   
-00022530: 2020 2020 2020 2020 2020 2020 2027 6578               'ex
-00022540: 636c 7564 6564 273a 204e 6f6e 652c 0a20  cluded': None,. 
-00022550: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
-00022560: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
-00022570: 2027 6578 702d 3127 3a20 7b0a 2020 2020   'exp-1': {.    
-00022580: 2020 2020 2020 2020 2762 655f 6578 636c          'be_excl
-00022590: 7564 6564 273a 204e 6f6e 652c 0a20 2020  uded': None,.   
-000225a0: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
-000225b0: 2765 7870 2d32 273a 207b 0a20 2020 2020  'exp-2': {.     
-000225c0: 2020 2020 2020 2027 6265 5f65 7863 6c75         'be_exclu
-000225d0: 6465 6427 3a20 4e6f 6e65 2c0a 2020 2020  ded': None,.    
-000225e0: 2020 2020 7d2c 0a20 2020 2020 2020 2027      },.        '
-000225f0: 6672 6f6e 745f 736c 6173 685f 6578 636c  front_slash_excl
-00022600: 7564 6564 273a 204e 6f6e 652c 0a20 2020  uded': None,.   
-00022610: 2020 2020 2027 696e 636c 7564 6564 2e6c       'included.l
-00022620: 6f67 273a 204e 6f6e 652c 0a20 2020 2020  og': None,.     
-00022630: 2020 2027 696e 636c 7564 6564 2e74 7874     'included.txt
-00022640: 273a 204e 6f6e 652c 0a20 2020 2020 2020  ': None,.       
-00022650: 2027 696e 636c 7564 655f 6469 7227 3a20   'include_dir': 
-00022660: 7b0a 2020 2020 2020 2020 2020 2020 2765  {.            'e
-00022670: 7863 6c75 6465 642e 6c6f 6727 3a20 4e6f  xcluded.log': No
-00022680: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-00022690: 2769 6e63 6c75 6465 642e 6c6f 6727 3a20  'included.log': 
-000226a0: 4e6f 6e65 2c0a 2020 2020 2020 2020 7d2c  None,.        },
-000226b0: 0a20 2020 2020 2020 2027 6e65 7374 6564  .        'nested
-000226c0: 5f64 6f75 626c 655f 6173 7465 7269 736b  _double_asterisk
-000226d0: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
-000226e0: 2027 6f6e 6527 3a20 7b0a 2020 2020 2020   'one': {.      
-000226f0: 2020 2020 2020 2020 2020 2761 6c73 6f5f            'also_
-00022700: 6578 636c 7564 652e 7478 7427 3a20 4e6f  exclude.txt': No
-00022710: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-00022720: 7d2c 0a20 2020 2020 2020 2020 2020 2027  },.            '
-00022730: 7477 6f27 3a20 7b0a 2020 2020 2020 2020  two': {.        
-00022740: 2020 2020 2020 2020 2761 6c73 6f5f 6578          'also_ex
-00022750: 636c 7564 652e 7478 7427 3a20 4e6f 6e65  clude.txt': None
-00022760: 2c0a 2020 2020 2020 2020 2020 2020 7d2c  ,.            },
-00022770: 0a20 2020 2020 2020 207d 2c0a 2020 2020  .        },.    
-00022780: 2020 2020 276e 6573 7465 645f 7769 6c64      'nested_wild
-00022790: 6361 7264 5f64 6972 273a 207b 0a20 2020  card_dir': {.   
-000227a0: 2020 2020 2020 2020 2027 6d6f 6e64 6179           'monday
-000227b0: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
-000227c0: 2020 2020 2027 616c 736f 5f65 7863 6c75       'also_exclu
-000227d0: 6465 2e74 7874 273a 204e 6f6e 652c 0a20  de.txt': None,. 
-000227e0: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
-000227f0: 2020 2020 2020 2020 2020 2774 7565 7364            'tuesd
-00022800: 6179 273a 207b 0a20 2020 2020 2020 2020  ay': {.         
-00022810: 2020 2020 2020 2027 616c 736f 5f65 7863         'also_exc
-00022820: 6c75 6465 2e74 7874 273a 204e 6f6e 652c  lude.txt': None,
-00022830: 0a20 2020 2020 2020 2020 2020 207d 2c0a  .            },.
-00022840: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
-00022850: 2020 2027 6e6f 5f73 6c61 7368 5f65 7863     'no_slash_exc
-00022860: 6c75 6465 6427 3a20 4e6f 6e65 2c0a 2020  luded': None,.  
-00022870: 2020 2020 2020 276e 6f5f 736c 6173 685f        'no_slash_
-00022880: 7465 7374 7327 3a20 7b0a 2020 2020 2020  tests': {.      
-00022890: 2020 2020 2020 276e 6f5f 736c 6173 685f        'no_slash_
-000228a0: 6578 636c 7564 6564 273a 207b 0a20 2020  excluded': {.   
-000228b0: 2020 2020 2020 2020 2020 2020 2027 616c               'al
-000228c0: 736f 5f65 7863 6c75 6465 642e 7478 7427  so_excluded.txt'
-000228d0: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
-000228e0: 2020 2020 7d2c 0a20 2020 2020 2020 207d      },.        }
-000228f0: 2c0a 2020 2020 2020 2020 2771 7565 7374  ,.        'quest
-00022900: 696f 6e5f 6d61 726b 273a 207b 0a20 2020  ion_mark': {.   
-00022910: 2020 2020 2020 2020 2027 6578 636c 7564           'exclud
-00022920: 6564 312e 7478 7427 3a20 4e6f 6e65 2c0a  ed1.txt': None,.
-00022930: 2020 2020 2020 2020 2020 2020 2765 7863              'exc
-00022940: 6c75 6465 6440 2e74 7874 273a 204e 6f6e  luded@.txt': Non
-00022950: 652c 0a20 2020 2020 2020 207d 2c0a 2020  e,.        },.  
-00022960: 2020 2020 2020 2773 7175 6172 655f 6272        'square_br
-00022970: 6163 6b65 7427 3a20 7b0a 2020 2020 2020  acket': {.      
-00022980: 2020 2020 2020 2765 7863 6c75 6465 6431        'excluded1
-00022990: 2e74 7874 273a 204e 6f6e 652c 0a20 2020  .txt': None,.   
-000229a0: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
-000229b0: 2773 7175 6172 655f 6272 6163 6b65 745f  'square_bracket_
-000229c0: 616c 7068 6127 3a20 7b0a 2020 2020 2020  alpha': {.      
-000229d0: 2020 2020 2020 2765 7863 6c75 6465 647a        'excludedz
-000229e0: 2e74 7874 273a 204e 6f6e 652c 0a20 2020  .txt': None,.   
-000229f0: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
-00022a00: 2773 7175 6172 655f 6272 6163 6b65 745f  'square_bracket_
-00022a10: 6578 636c 6127 3a20 7b0a 2020 2020 2020  excla': {.      
-00022a20: 2020 2020 2020 2765 7863 6c75 6465 6432        'excluded2
-00022a30: 2e74 7874 273a 204e 6f6e 652c 0a20 2020  .txt': None,.   
-00022a40: 2020 2020 2020 2020 2027 6578 636c 7564           'exclud
-00022a50: 6564 402e 7478 7427 3a20 4e6f 6e65 2c0a  ed@.txt': None,.
-00022a60: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
-00022a70: 2020 2027 7371 7561 7265 5f62 7261 636b     'square_brack
-00022a80: 6574 5f73 696e 676c 6527 3a20 7b0a 2020  et_single': {.  
-00022a90: 2020 2020 2020 2020 2020 2765 7863 6c75            'exclu
-00022aa0: 6465 6430 2e74 7874 273a 204e 6f6e 652c  ded0.txt': None,
-00022ab0: 0a20 2020 2020 2020 207d 2c0a 2020 2020  .        },.    
-00022ac0: 7d0a 0a20 2020 2040 7374 6174 6963 6d65  }..    @staticme
-00022ad0: 7468 6f64 0a20 2020 2064 6566 2063 7265  thod.    def cre
-00022ae0: 6174 655f 6469 725f 7374 7275 6374 7572  ate_dir_structur
-00022af0: 6528 6261 7365 5f70 6174 682c 2073 7472  e(base_path, str
-00022b00: 7563 7475 7265 293a 0a20 2020 2020 2020  ucture):.       
-00022b10: 2023 2063 7265 6174 6573 2061 2067 6976   # creates a giv
-00022b20: 656e 2066 696c 6520 5354 5255 4354 5552  en file STRUCTUR
-00022b30: 4520 696e 2042 4153 455f 5041 5448 0a20  E in BASE_PATH. 
-00022b40: 2020 2020 2020 2066 6f72 206e 616d 652c         for name,
-00022b50: 2073 7562 7374 7275 6374 7572 6520 696e   substructure in
-00022b60: 2073 7472 7563 7475 7265 2e69 7465 6d73   structure.items
-00022b70: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00022b80: 7061 7468 203d 206f 732e 7061 7468 2e6a  path = os.path.j
-00022b90: 6f69 6e28 6261 7365 5f70 6174 682c 206e  oin(base_path, n
-00022ba0: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
-00022bb0: 2069 6620 7375 6273 7472 7563 7475 7265   if substructure
-00022bc0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-00022bd0: 2020 2020 2020 2020 2020 2320 4372 6561            # Crea
-00022be0: 7465 2061 2066 696c 650a 2020 2020 2020  te a file.      
-00022bf0: 2020 2020 2020 2020 2020 6f70 656e 2870            open(p
-00022c00: 6174 682c 2027 6127 2c20 656e 636f 6469  ath, 'a', encodi
-00022c10: 6e67 3d27 7574 662d 3827 292e 636c 6f73  ng='utf-8').clos
-00022c20: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
-00022c30: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00022c40: 2020 2020 2020 2320 4372 6561 7465 2061        # Create a
-00022c50: 2073 7562 6469 7265 6374 6f72 790a 2020   subdirectory.  
-00022c60: 2020 2020 2020 2020 2020 2020 2020 6f73                os
-00022c70: 2e6d 6b64 6972 2870 6174 6829 0a20 2020  .mkdir(path).   
-00022c80: 2020 2020 2020 2020 2020 2020 2054 6573               Tes
-00022c90: 7453 746f 7261 6765 5769 7468 4372 6564  tStorageWithCred
-00022ca0: 656e 7469 616c 732e 6372 6561 7465 5f64  entials.create_d
-00022cb0: 6972 5f73 7472 7563 7475 7265 280a 2020  ir_structure(.  
-00022cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022cd0: 2020 7061 7468 2c20 7375 6273 7472 7563    path, substruc
-00022ce0: 7475 7265 290a 0a20 2020 2040 7374 6174  ture)..    @stat
-00022cf0: 6963 6d65 7468 6f64 0a20 2020 2064 6566  icmethod.    def
-00022d00: 2063 6c69 5f64 656c 6574 655f 636d 6428   cli_delete_cmd(
-00022d10: 7374 6f72 655f 7479 7065 2c20 6275 636b  store_type, buck
-00022d20: 6574 5f6e 616d 6529 3a0a 2020 2020 2020  et_name):.      
-00022d30: 2020 6966 2073 746f 7265 5f74 7970 6520    if store_type 
-00022d40: 3d3d 2073 746f 7261 6765 5f6c 6962 2e53  == storage_lib.S
-00022d50: 746f 7265 5479 7065 2e53 333a 0a20 2020  toreType.S3:.   
-00022d60: 2020 2020 2020 2020 2075 726c 203d 2066           url = f
-00022d70: 2773 333a 2f2f 7b62 7563 6b65 745f 6e61  's3://{bucket_na
-00022d80: 6d65 7d27 0a20 2020 2020 2020 2020 2020  me}'.           
-00022d90: 2072 6574 7572 6e20 6627 6177 7320 7333   return f'aws s3
-00022da0: 2072 6220 7b75 726c 7d20 2d2d 666f 7263   rb {url} --forc
-00022db0: 6527 0a20 2020 2020 2020 2069 6620 7374  e'.        if st
-00022dc0: 6f72 655f 7479 7065 203d 3d20 7374 6f72  ore_type == stor
-00022dd0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-00022de0: 652e 4743 533a 0a20 2020 2020 2020 2020  e.GCS:.         
-00022df0: 2020 2075 726c 203d 2066 2767 733a 2f2f     url = f'gs://
-00022e00: 7b62 7563 6b65 745f 6e61 6d65 7d27 0a20  {bucket_name}'. 
-00022e10: 2020 2020 2020 2020 2020 2067 7375 7469             gsuti
-00022e20: 6c5f 616c 6961 732c 2061 6c69 6173 5f67  l_alias, alias_g
-00022e30: 656e 203d 2064 6174 615f 7574 696c 732e  en = data_utils.
-00022e40: 6765 745f 6773 7574 696c 5f63 6f6d 6d61  get_gsutil_comma
-00022e50: 6e64 2829 0a20 2020 2020 2020 2020 2020  nd().           
-00022e60: 2072 6574 7572 6e20 6627 7b61 6c69 6173   return f'{alias
-00022e70: 5f67 656e 7d3b 207b 6773 7574 696c 5f61  _gen}; {gsutil_a
-00022e80: 6c69 6173 7d20 726d 202d 7220 7b75 726c  lias} rm -r {url
-00022e90: 7d27 0a20 2020 2020 2020 2069 6620 7374  }'.        if st
-00022ea0: 6f72 655f 7479 7065 203d 3d20 7374 6f72  ore_type == stor
-00022eb0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-00022ec0: 652e 5232 3a0a 2020 2020 2020 2020 2020  e.R2:.          
-00022ed0: 2020 656e 6470 6f69 6e74 5f75 726c 203d    endpoint_url =
-00022ee0: 2063 6c6f 7564 666c 6172 652e 6372 6561   cloudflare.crea
-00022ef0: 7465 5f65 6e64 706f 696e 7428 290a 2020  te_endpoint().  
-00022f00: 2020 2020 2020 2020 2020 7572 6c20 3d20            url = 
-00022f10: 6627 7333 3a2f 2f7b 6275 636b 6574 5f6e  f's3://{bucket_n
-00022f20: 616d 657d 270a 2020 2020 2020 2020 2020  ame}'.          
-00022f30: 2020 7265 7475 726e 2066 2741 5753 5f53    return f'AWS_S
-00022f40: 4841 5245 445f 4352 4544 454e 5449 414c  HARED_CREDENTIAL
-00022f50: 535f 4649 4c45 3d7b 636c 6f75 6466 6c61  S_FILE={cloudfla
-00022f60: 7265 2e52 325f 4352 4544 454e 5449 414c  re.R2_CREDENTIAL
-00022f70: 535f 5041 5448 7d20 6177 7320 7333 2072  S_PATH} aws s3 r
-00022f80: 6220 7b75 726c 7d20 2d2d 666f 7263 6520  b {url} --force 
-00022f90: 2d2d 656e 6470 6f69 6e74 207b 656e 6470  --endpoint {endp
-00022fa0: 6f69 6e74 5f75 726c 7d20 2d2d 7072 6f66  oint_url} --prof
-00022fb0: 696c 653d 7232 270a 2020 2020 2020 2020  ile=r2'.        
-00022fc0: 6966 2073 746f 7265 5f74 7970 6520 3d3d  if store_type ==
-00022fd0: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
-00022fe0: 7265 5479 7065 2e49 424d 3a0a 2020 2020  reType.IBM:.    
-00022ff0: 2020 2020 2020 2020 6275 636b 6574 5f72          bucket_r
-00023000: 636c 6f6e 655f 7072 6f66 696c 6520 3d20  clone_profile = 
-00023010: 5263 6c6f 6e65 2e67 656e 6572 6174 655f  Rclone.generate_
-00023020: 7263 6c6f 6e65 5f62 7563 6b65 745f 7072  rclone_bucket_pr
-00023030: 6f66 696c 655f 6e61 6d65 280a 2020 2020  ofile_name(.    
-00023040: 2020 2020 2020 2020 2020 2020 6275 636b              buck
-00023050: 6574 5f6e 616d 652c 2052 636c 6f6e 652e  et_name, Rclone.
-00023060: 5263 6c6f 6e65 436c 6f75 6473 2e49 424d  RcloneClouds.IBM
-00023070: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-00023080: 7475 726e 2066 2772 636c 6f6e 6520 7075  turn f'rclone pu
-00023090: 7267 6520 7b62 7563 6b65 745f 7263 6c6f  rge {bucket_rclo
-000230a0: 6e65 5f70 726f 6669 6c65 7d3a 7b62 7563  ne_profile}:{buc
-000230b0: 6b65 745f 6e61 6d65 7d20 2626 2072 636c  ket_name} && rcl
-000230c0: 6f6e 6520 636f 6e66 6967 2064 656c 6574  one config delet
-000230d0: 6520 7b62 7563 6b65 745f 7263 6c6f 6e65  e {bucket_rclone
-000230e0: 5f70 726f 6669 6c65 7d27 0a0a 2020 2020  _profile}'..    
-000230f0: 4073 7461 7469 636d 6574 686f 640a 2020  @staticmethod.  
-00023100: 2020 6465 6620 636c 695f 6c73 5f63 6d64    def cli_ls_cmd
-00023110: 2873 746f 7265 5f74 7970 652c 2062 7563  (store_type, buc
-00023120: 6b65 745f 6e61 6d65 2c20 7375 6666 6978  ket_name, suffix
-00023130: 3d27 2729 3a0a 2020 2020 2020 2020 6966  =''):.        if
-00023140: 2073 746f 7265 5f74 7970 6520 3d3d 2073   store_type == s
-00023150: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
-00023160: 5479 7065 2e53 333a 0a20 2020 2020 2020  Type.S3:.       
-00023170: 2020 2020 2069 6620 7375 6666 6978 3a0a       if suffix:.
-00023180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023190: 7572 6c20 3d20 6627 7333 3a2f 2f7b 6275  url = f's3://{bu
-000231a0: 636b 6574 5f6e 616d 657d 2f7b 7375 6666  cket_name}/{suff
-000231b0: 6978 7d27 0a20 2020 2020 2020 2020 2020  ix}'.           
-000231c0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000231d0: 2020 2020 2020 2075 726c 203d 2066 2773         url = f's
-000231e0: 333a 2f2f 7b62 7563 6b65 745f 6e61 6d65  3://{bucket_name
-000231f0: 7d27 0a20 2020 2020 2020 2020 2020 2072  }'.            r
-00023200: 6574 7572 6e20 6627 6177 7320 7333 206c  eturn f'aws s3 l
-00023210: 7320 7b75 726c 7d27 0a20 2020 2020 2020  s {url}'.       
-00023220: 2069 6620 7374 6f72 655f 7479 7065 203d   if store_type =
-00023230: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
-00023240: 6f72 6554 7970 652e 4743 533a 0a20 2020  oreType.GCS:.   
-00023250: 2020 2020 2020 2020 2069 6620 7375 6666           if suff
-00023260: 6978 3a0a 2020 2020 2020 2020 2020 2020  ix:.            
-00023270: 2020 2020 7572 6c20 3d20 6627 6773 3a2f      url = f'gs:/
-00023280: 2f7b 6275 636b 6574 5f6e 616d 657d 2f7b  /{bucket_name}/{
-00023290: 7375 6666 6978 7d27 0a20 2020 2020 2020  suffix}'.       
-000232a0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-000232b0: 2020 2020 2020 2020 2020 2075 726c 203d             url =
-000232c0: 2066 2767 733a 2f2f 7b62 7563 6b65 745f   f'gs://{bucket_
-000232d0: 6e61 6d65 7d27 0a20 2020 2020 2020 2020  name}'.         
-000232e0: 2020 2072 6574 7572 6e20 6627 6773 7574     return f'gsut
-000232f0: 696c 206c 7320 7b75 726c 7d27 0a20 2020  il ls {url}'.   
-00023300: 2020 2020 2069 6620 7374 6f72 655f 7479       if store_ty
-00023310: 7065 203d 3d20 7374 6f72 6167 655f 6c69  pe == storage_li
-00023320: 622e 5374 6f72 6554 7970 652e 5232 3a0a  b.StoreType.R2:.
-00023330: 2020 2020 2020 2020 2020 2020 656e 6470              endp
-00023340: 6f69 6e74 5f75 726c 203d 2063 6c6f 7564  oint_url = cloud
-00023350: 666c 6172 652e 6372 6561 7465 5f65 6e64  flare.create_end
-00023360: 706f 696e 7428 290a 2020 2020 2020 2020  point().        
-00023370: 2020 2020 6966 2073 7566 6669 783a 0a20      if suffix:. 
-00023380: 2020 2020 2020 2020 2020 2020 2020 2075                 u
-00023390: 726c 203d 2066 2773 333a 2f2f 7b62 7563  rl = f's3://{buc
-000233a0: 6b65 745f 6e61 6d65 7d2f 7b73 7566 6669  ket_name}/{suffi
-000233b0: 787d 270a 2020 2020 2020 2020 2020 2020  x}'.            
-000233c0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-000233d0: 2020 2020 2020 7572 6c20 3d20 6627 7333        url = f's3
-000233e0: 3a2f 2f7b 6275 636b 6574 5f6e 616d 657d  ://{bucket_name}
-000233f0: 270a 2020 2020 2020 2020 2020 2020 7265  '.            re
-00023400: 7475 726e 2066 2741 5753 5f53 4841 5245  turn f'AWS_SHARE
-00023410: 445f 4352 4544 454e 5449 414c 535f 4649  D_CREDENTIALS_FI
-00023420: 4c45 3d7b 636c 6f75 6466 6c61 7265 2e52  LE={cloudflare.R
-00023430: 325f 4352 4544 454e 5449 414c 535f 5041  2_CREDENTIALS_PA
-00023440: 5448 7d20 6177 7320 7333 206c 7320 7b75  TH} aws s3 ls {u
-00023450: 726c 7d20 2d2d 656e 6470 6f69 6e74 207b  rl} --endpoint {
-00023460: 656e 6470 6f69 6e74 5f75 726c 7d20 2d2d  endpoint_url} --
-00023470: 7072 6f66 696c 653d 7232 270a 2020 2020  profile=r2'.    
-00023480: 2020 2020 6966 2073 746f 7265 5f74 7970      if store_typ
-00023490: 6520 3d3d 2073 746f 7261 6765 5f6c 6962  e == storage_lib
-000234a0: 2e53 746f 7265 5479 7065 2e49 424d 3a0a  .StoreType.IBM:.
-000234b0: 2020 2020 2020 2020 2020 2020 6275 636b              buck
-000234c0: 6574 5f72 636c 6f6e 655f 7072 6f66 696c  et_rclone_profil
-000234d0: 6520 3d20 5263 6c6f 6e65 2e67 656e 6572  e = Rclone.gener
-000234e0: 6174 655f 7263 6c6f 6e65 5f62 7563 6b65  ate_rclone_bucke
-000234f0: 745f 7072 6f66 696c 655f 6e61 6d65 280a  t_profile_name(.
-00023500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023510: 6275 636b 6574 5f6e 616d 652c 2052 636c  bucket_name, Rcl
-00023520: 6f6e 652e 5263 6c6f 6e65 436c 6f75 6473  one.RcloneClouds
-00023530: 2e49 424d 290a 2020 2020 2020 2020 2020  .IBM).          
-00023540: 2020 7265 7475 726e 2066 2772 636c 6f6e    return f'rclon
-00023550: 6520 6c73 207b 6275 636b 6574 5f72 636c  e ls {bucket_rcl
-00023560: 6f6e 655f 7072 6f66 696c 657d 3a7b 6275  one_profile}:{bu
-00023570: 636b 6574 5f6e 616d 657d 2f7b 7375 6666  cket_name}/{suff
-00023580: 6978 7d27 0a0a 2020 2020 4073 7461 7469  ix}'..    @stati
-00023590: 636d 6574 686f 640a 2020 2020 6465 6620  cmethod.    def 
-000235a0: 636c 695f 636f 756e 745f 6e61 6d65 5f69  cli_count_name_i
-000235b0: 6e5f 6275 636b 6574 2873 746f 7265 5f74  n_bucket(store_t
-000235c0: 7970 652c 2062 7563 6b65 745f 6e61 6d65  ype, bucket_name
-000235d0: 2c20 6669 6c65 5f6e 616d 652c 2073 7566  , file_name, suf
-000235e0: 6669 783d 2727 293a 0a20 2020 2020 2020  fix=''):.       
-000235f0: 2069 6620 7374 6f72 655f 7479 7065 203d   if store_type =
-00023600: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
-00023610: 6f72 6554 7970 652e 5333 3a0a 2020 2020  oreType.S3:.    
-00023620: 2020 2020 2020 2020 6966 2073 7566 6669          if suffi
-00023630: 783a 0a20 2020 2020 2020 2020 2020 2020  x:.             
-00023640: 2020 2072 6574 7572 6e20 6627 6177 7320     return f'aws 
-00023650: 7333 6170 6920 6c69 7374 2d6f 626a 6563  s3api list-objec
-00023660: 7473 202d 2d62 7563 6b65 7420 227b 6275  ts --bucket "{bu
-00023670: 636b 6574 5f6e 616d 657d 2220 2d2d 7072  cket_name}" --pr
-00023680: 6566 6978 207b 7375 6666 6978 7d20 2d2d  efix {suffix} --
-00023690: 7175 6572 7920 226c 656e 6774 6828 436f  query "length(Co
-000236a0: 6e74 656e 7473 5b3f 636f 6e74 6169 6e73  ntents[?contains
-000236b0: 284b 6579 2c5c 277b 6669 6c65 5f6e 616d  (Key,\'{file_nam
-000236c0: 657d 5c27 295d 2e4b 6579 2922 270a 2020  e}\')].Key)"'.  
-000236d0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-000236e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000236f0: 7265 7475 726e 2066 2761 7773 2073 3361  return f'aws s3a
-00023700: 7069 206c 6973 742d 6f62 6a65 6374 7320  pi list-objects 
-00023710: 2d2d 6275 636b 6574 2022 7b62 7563 6b65  --bucket "{bucke
-00023720: 745f 6e61 6d65 7d22 202d 2d71 7565 7279  t_name}" --query
-00023730: 2022 6c65 6e67 7468 2843 6f6e 7465 6e74   "length(Content
-00023740: 735b 3f63 6f6e 7461 696e 7328 4b65 792c  s[?contains(Key,
-00023750: 5c27 7b66 696c 655f 6e61 6d65 7d5c 2729  \'{file_name}\')
-00023760: 5d2e 4b65 7929 2227 0a20 2020 2020 2020  ].Key)"'.       
-00023770: 2065 6c69 6620 7374 6f72 655f 7479 7065   elif store_type
-00023780: 203d 3d20 7374 6f72 6167 655f 6c69 622e   == storage_lib.
-00023790: 5374 6f72 6554 7970 652e 4743 533a 0a20  StoreType.GCS:. 
-000237a0: 2020 2020 2020 2020 2020 2069 6620 7375             if su
-000237b0: 6666 6978 3a0a 2020 2020 2020 2020 2020  ffix:.          
-000237c0: 2020 2020 2020 7265 7475 726e 2066 2767        return f'g
-000237d0: 7375 7469 6c20 6c73 202d 7220 6773 3a2f  sutil ls -r gs:/
-000237e0: 2f7b 6275 636b 6574 5f6e 616d 657d 2f7b  /{bucket_name}/{
-000237f0: 7375 6666 6978 7d20 7c20 6772 6570 2022  suffix} | grep "
-00023800: 7b66 696c 655f 6e61 6d65 7d22 207c 2077  {file_name}" | w
-00023810: 6320 2d6c 270a 2020 2020 2020 2020 2020  c -l'.          
-00023820: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00023830: 2020 2020 2020 2020 7265 7475 726e 2066          return f
-00023840: 2767 7375 7469 6c20 6c73 202d 7220 6773  'gsutil ls -r gs
-00023850: 3a2f 2f7b 6275 636b 6574 5f6e 616d 657d  ://{bucket_name}
-00023860: 207c 2067 7265 7020 227b 6669 6c65 5f6e   | grep "{file_n
-00023870: 616d 657d 2220 7c20 7763 202d 6c27 0a20  ame}" | wc -l'. 
-00023880: 2020 2020 2020 2065 6c69 6620 7374 6f72         elif stor
-00023890: 655f 7479 7065 203d 3d20 7374 6f72 6167  e_type == storag
-000238a0: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
-000238b0: 5232 3a0a 2020 2020 2020 2020 2020 2020  R2:.            
-000238c0: 656e 6470 6f69 6e74 5f75 726c 203d 2063  endpoint_url = c
-000238d0: 6c6f 7564 666c 6172 652e 6372 6561 7465  loudflare.create
-000238e0: 5f65 6e64 706f 696e 7428 290a 2020 2020  _endpoint().    
-000238f0: 2020 2020 2020 2020 6966 2073 7566 6669          if suffi
-00023900: 783a 0a20 2020 2020 2020 2020 2020 2020  x:.             
-00023910: 2020 2072 6574 7572 6e20 6627 4157 535f     return f'AWS_
-00023920: 5348 4152 4544 5f43 5245 4445 4e54 4941  SHARED_CREDENTIA
-00023930: 4c53 5f46 494c 453d 7b63 6c6f 7564 666c  LS_FILE={cloudfl
-00023940: 6172 652e 5232 5f43 5245 4445 4e54 4941  are.R2_CREDENTIA
-00023950: 4c53 5f50 4154 487d 2061 7773 2073 3361  LS_PATH} aws s3a
-00023960: 7069 206c 6973 742d 6f62 6a65 6374 7320  pi list-objects 
-00023970: 2d2d 6275 636b 6574 2022 7b62 7563 6b65  --bucket "{bucke
-00023980: 745f 6e61 6d65 7d22 202d 2d70 7265 6669  t_name}" --prefi
-00023990: 7820 7b73 7566 6669 787d 202d 2d71 7565  x {suffix} --que
-000239a0: 7279 2022 6c65 6e67 7468 2843 6f6e 7465  ry "length(Conte
-000239b0: 6e74 735b 3f63 6f6e 7461 696e 7328 4b65  nts[?contains(Ke
-000239c0: 792c 5c27 7b66 696c 655f 6e61 6d65 7d5c  y,\'{file_name}\
-000239d0: 2729 5d2e 4b65 7929 2220 2d2d 656e 6470  ')].Key)" --endp
-000239e0: 6f69 6e74 207b 656e 6470 6f69 6e74 5f75  oint {endpoint_u
-000239f0: 726c 7d20 2d2d 7072 6f66 696c 653d 7232  rl} --profile=r2
-00023a00: 270a 2020 2020 2020 2020 2020 2020 656c  '.            el
-00023a10: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00023a20: 2020 2020 7265 7475 726e 2066 2741 5753      return f'AWS
-00023a30: 5f53 4841 5245 445f 4352 4544 454e 5449  _SHARED_CREDENTI
-00023a40: 414c 535f 4649 4c45 3d7b 636c 6f75 6466  ALS_FILE={cloudf
-00023a50: 6c61 7265 2e52 325f 4352 4544 454e 5449  lare.R2_CREDENTI
-00023a60: 414c 535f 5041 5448 7d20 6177 7320 7333  ALS_PATH} aws s3
-00023a70: 6170 6920 6c69 7374 2d6f 626a 6563 7473  api list-objects
-00023a80: 202d 2d62 7563 6b65 7420 227b 6275 636b   --bucket "{buck
-00023a90: 6574 5f6e 616d 657d 2220 2d2d 7175 6572  et_name}" --quer
-00023aa0: 7920 226c 656e 6774 6828 436f 6e74 656e  y "length(Conten
-00023ab0: 7473 5b3f 636f 6e74 6169 6e73 284b 6579  ts[?contains(Key
-00023ac0: 2c5c 277b 6669 6c65 5f6e 616d 657d 5c27  ,\'{file_name}\'
-00023ad0: 295d 2e4b 6579 2922 202d 2d65 6e64 706f  )].Key)" --endpo
-00023ae0: 696e 7420 7b65 6e64 706f 696e 745f 7572  int {endpoint_ur
-00023af0: 6c7d 202d 2d70 726f 6669 6c65 3d72 3227  l} --profile=r2'
-00023b00: 0a0a 2020 2020 4073 7461 7469 636d 6574  ..    @staticmet
-00023b10: 686f 640a 2020 2020 6465 6620 636c 695f  hod.    def cli_
-00023b20: 636f 756e 745f 6669 6c65 5f69 6e5f 6275  count_file_in_bu
-00023b30: 636b 6574 2873 746f 7265 5f74 7970 652c  cket(store_type,
-00023b40: 2062 7563 6b65 745f 6e61 6d65 293a 0a20   bucket_name):. 
-00023b50: 2020 2020 2020 2069 6620 7374 6f72 655f         if store_
-00023b60: 7479 7065 203d 3d20 7374 6f72 6167 655f  type == storage_
-00023b70: 6c69 622e 5374 6f72 6554 7970 652e 5333  lib.StoreType.S3
-00023b80: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00023b90: 7475 726e 2066 2761 7773 2073 3320 6c73  turn f'aws s3 ls
-00023ba0: 2073 333a 2f2f 7b62 7563 6b65 745f 6e61   s3://{bucket_na
-00023bb0: 6d65 7d20 2d2d 7265 6375 7273 6976 6520  me} --recursive 
-00023bc0: 7c20 7763 202d 6c27 0a20 2020 2020 2020  | wc -l'.       
-00023bd0: 2065 6c69 6620 7374 6f72 655f 7479 7065   elif store_type
-00023be0: 203d 3d20 7374 6f72 6167 655f 6c69 622e   == storage_lib.
-00023bf0: 5374 6f72 6554 7970 652e 4743 533a 0a20  StoreType.GCS:. 
-00023c00: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00023c10: 6e20 6627 6773 7574 696c 206c 7320 2d72  n f'gsutil ls -r
-00023c20: 2067 733a 2f2f 7b62 7563 6b65 745f 6e61   gs://{bucket_na
-00023c30: 6d65 7d2f 2a2a 207c 2077 6320 2d6c 270a  me}/** | wc -l'.
-00023c40: 2020 2020 2020 2020 656c 6966 2073 746f          elif sto
-00023c50: 7265 5f74 7970 6520 3d3d 2073 746f 7261  re_type == stora
-00023c60: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
-00023c70: 2e52 323a 0a20 2020 2020 2020 2020 2020  .R2:.           
-00023c80: 2065 6e64 706f 696e 745f 7572 6c20 3d20   endpoint_url = 
-00023c90: 636c 6f75 6466 6c61 7265 2e63 7265 6174  cloudflare.creat
-00023ca0: 655f 656e 6470 6f69 6e74 2829 0a20 2020  e_endpoint().   
-00023cb0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00023cc0: 6627 4157 535f 5348 4152 4544 5f43 5245  f'AWS_SHARED_CRE
-00023cd0: 4445 4e54 4941 4c53 5f46 494c 453d 7b63  DENTIALS_FILE={c
-00023ce0: 6c6f 7564 666c 6172 652e 5232 5f43 5245  loudflare.R2_CRE
-00023cf0: 4445 4e54 4941 4c53 5f50 4154 487d 2061  DENTIALS_PATH} a
-00023d00: 7773 2073 3320 6c73 2073 333a 2f2f 7b62  ws s3 ls s3://{b
-00023d10: 7563 6b65 745f 6e61 6d65 7d20 2d2d 7265  ucket_name} --re
-00023d20: 6375 7273 6976 6520 2d2d 656e 6470 6f69  cursive --endpoi
-00023d30: 6e74 207b 656e 6470 6f69 6e74 5f75 726c  nt {endpoint_url
-00023d40: 7d20 2d2d 7072 6f66 696c 653d 7232 207c  } --profile=r2 |
-00023d50: 2077 6320 2d6c 270a 0a20 2020 2040 7079   wc -l'..    @py
-00023d60: 7465 7374 2e66 6978 7475 7265 0a20 2020  test.fixture.   
-00023d70: 2064 6566 2074 6d70 5f73 6f75 7263 6528   def tmp_source(
-00023d80: 7365 6c66 2c20 746d 705f 7061 7468 293a  self, tmp_path):
-00023d90: 0a20 2020 2020 2020 2023 2043 7265 6174  .        # Creat
-00023da0: 6573 2061 2074 656d 706f 7261 7279 2064  es a temporary d
-00023db0: 6972 6563 746f 7279 2077 6974 6820 6120  irectory with a 
-00023dc0: 6669 6c65 2069 6e20 6974 0a20 2020 2020  file in it.     
-00023dd0: 2020 2074 6d70 5f64 6972 203d 2074 6d70     tmp_dir = tmp
-00023de0: 5f70 6174 6820 2f20 2774 6d70 2d73 6f75  _path / 'tmp-sou
-00023df0: 7263 6527 0a20 2020 2020 2020 2074 6d70  rce'.        tmp
-00023e00: 5f64 6972 2e6d 6b64 6972 2829 0a20 2020  _dir.mkdir().   
-00023e10: 2020 2020 2074 6d70 5f66 696c 6520 3d20       tmp_file = 
-00023e20: 746d 705f 6469 7220 2f20 2774 6d70 2d66  tmp_dir / 'tmp-f
-00023e30: 696c 6527 0a20 2020 2020 2020 2074 6d70  ile'.        tmp
-00023e40: 5f66 696c 652e 7772 6974 655f 7465 7874  _file.write_text
-00023e50: 2827 7465 7374 2729 0a20 2020 2020 2020  ('test').       
-00023e60: 2063 6972 636c 655f 6c69 6e6b 203d 2074   circle_link = t
-00023e70: 6d70 5f64 6972 202f 2027 6369 7263 6c65  mp_dir / 'circle
-00023e80: 2d6c 696e 6b27 0a20 2020 2020 2020 2063  -link'.        c
-00023e90: 6972 636c 655f 6c69 6e6b 2e73 796d 6c69  ircle_link.symli
-00023ea0: 6e6b 5f74 6f28 746d 705f 6469 722c 2074  nk_to(tmp_dir, t
-00023eb0: 6172 6765 745f 6973 5f64 6972 6563 746f  arget_is_directo
-00023ec0: 7279 3d54 7275 6529 0a20 2020 2020 2020  ry=True).       
-00023ed0: 2079 6965 6c64 2073 7472 2874 6d70 5f64   yield str(tmp_d
-00023ee0: 6972 290a 0a20 2020 2040 7374 6174 6963  ir)..    @static
-00023ef0: 6d65 7468 6f64 0a20 2020 2064 6566 2067  method.    def g
-00023f00: 656e 6572 6174 655f 6275 636b 6574 5f6e  enerate_bucket_n
-00023f10: 616d 6528 293a 0a20 2020 2020 2020 2023  ame():.        #
-00023f20: 2043 7265 6174 6573 2061 2074 656d 706f   Creates a tempo
-00023f30: 7261 7279 2062 7563 6b65 7420 6e61 6d65  rary bucket name
-00023f40: 0a20 2020 2020 2020 2023 2074 696d 652e  .        # time.
-00023f50: 7469 6d65 2829 2072 6574 7572 6e73 2076  time() returns v
-00023f60: 6172 7969 6e67 2070 7265 6369 7369 6f6e  arying precision
-00023f70: 206f 6e20 6469 6666 6572 656e 7420 7379   on different sy
-00023f80: 7374 656d 732c 2073 6f20 7765 0a20 2020  stems, so we.   
-00023f90: 2020 2020 2023 2072 6570 6c61 6365 2074       # replace t
-00023fa0: 6865 2064 6563 696d 616c 2070 6f69 6e74  he decimal point
-00023fb0: 2061 6e64 2075 7365 2077 6861 7465 7665   and use whateve
-00023fc0: 7220 7072 6563 6973 696f 6e20 7765 2063  r precision we c
-00023fd0: 616e 2067 6574 2e0a 2020 2020 2020 2020  an get..        
-00023fe0: 7469 6d65 7374 616d 7020 3d20 7374 7228  timestamp = str(
-00023ff0: 7469 6d65 2e74 696d 6528 2929 2e72 6570  time.time()).rep
-00024000: 6c61 6365 2827 2e27 2c20 2727 290a 2020  lace('.', '').  
-00024010: 2020 2020 2020 7265 7475 726e 2066 2773        return f's
-00024020: 6b79 2d74 6573 742d 7b74 696d 6573 7461  ky-test-{timesta
-00024030: 6d70 7d27 0a0a 2020 2020 4070 7974 6573  mp}'..    @pytes
-00024040: 742e 6669 7874 7572 650a 2020 2020 6465  t.fixture.    de
-00024050: 6620 746d 705f 6275 636b 6574 5f6e 616d  f tmp_bucket_nam
-00024060: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
-00024070: 2079 6965 6c64 2073 656c 662e 6765 6e65   yield self.gene
-00024080: 7261 7465 5f62 7563 6b65 745f 6e61 6d65  rate_bucket_name
-00024090: 2829 0a0a 2020 2020 4073 7461 7469 636d  ()..    @staticm
-000240a0: 6574 686f 640a 2020 2020 6465 6620 7969  ethod.    def yi
-000240b0: 656c 645f 7374 6f72 6167 655f 6f62 6a65  eld_storage_obje
-000240c0: 6374 280a 2020 2020 2020 2020 2020 2020  ct(.            
-000240d0: 6e61 6d65 3a20 4f70 7469 6f6e 616c 5b73  name: Optional[s
-000240e0: 7472 5d20 3d20 4e6f 6e65 2c0a 2020 2020  tr] = None,.    
-000240f0: 2020 2020 2020 2020 736f 7572 6365 3a20          source: 
-00024100: 4f70 7469 6f6e 616c 5b73 746f 7261 6765  Optional[storage
-00024110: 5f6c 6962 2e50 6174 685d 203d 204e 6f6e  _lib.Path] = Non
-00024120: 652c 0a20 2020 2020 2020 2020 2020 2073  e,.            s
-00024130: 746f 7265 733a 204f 7074 696f 6e61 6c5b  tores: Optional[
-00024140: 4469 6374 5b73 746f 7261 6765 5f6c 6962  Dict[storage_lib
-00024150: 2e53 746f 7265 5479 7065 2c0a 2020 2020  .StoreType,.    
-00024160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024170: 2020 2020 2020 2020 2020 2020 2020 7374                st
-00024180: 6f72 6167 655f 6c69 622e 4162 7374 7261  orage_lib.Abstra
-00024190: 6374 5374 6f72 655d 5d20 3d20 4e6f 6e65  ctStore]] = None
-000241a0: 2c0a 2020 2020 2020 2020 2020 2020 7065  ,.            pe
-000241b0: 7273 6973 7465 6e74 3a20 4f70 7469 6f6e  rsistent: Option
-000241c0: 616c 5b62 6f6f 6c5d 203d 2054 7275 652c  al[bool] = True,
-000241d0: 0a20 2020 2020 2020 2020 2020 206d 6f64  .            mod
-000241e0: 653a 2073 746f 7261 6765 5f6c 6962 2e53  e: storage_lib.S
-000241f0: 746f 7261 6765 4d6f 6465 203d 2073 746f  torageMode = sto
-00024200: 7261 6765 5f6c 6962 2e53 746f 7261 6765  rage_lib.Storage
-00024210: 4d6f 6465 2e4d 4f55 4e54 293a 0a20 2020  Mode.MOUNT):.   
-00024220: 2020 2020 2023 2043 7265 6174 6573 2061       # Creates a
-00024230: 2074 656d 706f 7261 7279 2073 746f 7261   temporary stora
-00024240: 6765 206f 626a 6563 742e 2053 746f 7265  ge object. Store
-00024250: 7320 6d75 7374 2062 6520 6164 6465 6420  s must be added 
-00024260: 696e 2074 6865 2074 6573 742e 0a20 2020  in the test..   
-00024270: 2020 2020 2073 746f 7261 6765 5f6f 626a       storage_obj
-00024280: 203d 2073 746f 7261 6765 5f6c 6962 2e53   = storage_lib.S
-00024290: 746f 7261 6765 286e 616d 653d 6e61 6d65  torage(name=name
-000242a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000242b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000242c0: 2020 2020 2020 2020 2020 2020 736f 7572              sour
-000242d0: 6365 3d73 6f75 7263 652c 0a20 2020 2020  ce=source,.     
-000242e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000242f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024300: 2020 2020 2073 746f 7265 733d 7374 6f72       stores=stor
-00024310: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
-00024320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024330: 2020 2020 2020 2020 2020 2020 2020 7065                pe
-00024340: 7273 6973 7465 6e74 3d70 6572 7369 7374  rsistent=persist
-00024350: 656e 742c 0a20 2020 2020 2020 2020 2020  ent,.           
-00024360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024370: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00024380: 6f64 653d 6d6f 6465 290a 2020 2020 2020  ode=mode).      
-00024390: 2020 7969 656c 6420 7374 6f72 6167 655f    yield storage_
-000243a0: 6f62 6a0a 2020 2020 2020 2020 6861 6e64  obj.        hand
-000243b0: 6c65 203d 2067 6c6f 6261 6c5f 7573 6572  le = global_user
-000243c0: 5f73 7461 7465 2e67 6574 5f68 616e 646c  _state.get_handl
-000243d0: 655f 6672 6f6d 5f73 746f 7261 6765 5f6e  e_from_storage_n
-000243e0: 616d 6528 0a20 2020 2020 2020 2020 2020  ame(.           
-000243f0: 2073 746f 7261 6765 5f6f 626a 2e6e 616d   storage_obj.nam
-00024400: 6529 0a20 2020 2020 2020 2069 6620 6861  e).        if ha
-00024410: 6e64 6c65 3a0a 2020 2020 2020 2020 2020  ndle:.          
-00024420: 2020 2320 4966 2068 616e 646c 6520 6578    # If handle ex
-00024430: 6973 7473 2c20 6465 6c65 7465 206d 616e  ists, delete man
-00024440: 7561 6c6c 790a 2020 2020 2020 2020 2020  ually.          
-00024450: 2020 2320 544f 444f 2872 6f6d 696c 6229    # TODO(romilb)
-00024460: 3a20 5468 6973 2069 7320 706f 7465 6e74  : This is potent
-00024470: 6961 6c6c 7920 7269 736b 7920 2d20 6966  ially risky - if
-00024480: 2074 6865 2064 656c 6574 6520 6d65 7468   the delete meth
-00024490: 6f64 2068 6173 0a20 2020 2020 2020 2020  od has.         
-000244a0: 2020 2023 2020 2062 7567 732c 2074 6869     #   bugs, thi
-000244b0: 7320 6361 6e20 6361 7573 6520 7265 736f  s can cause reso
-000244c0: 7572 6365 206c 6561 6b73 2e20 4964 6561  urce leaks. Idea
-000244d0: 6c6c 7920 7765 2073 686f 756c 6420 6d61  lly we should ma
-000244e0: 6e75 616c 6c79 0a20 2020 2020 2020 2020  nually.         
-000244f0: 2020 2023 2020 2065 6a65 6374 2073 746f     #   eject sto
-00024500: 7261 6765 2066 726f 6d20 676c 6f62 616c  rage from global
-00024510: 5f75 7365 725f 7374 6174 6520 616e 6420  _user_state and 
-00024520: 6465 6c65 7465 2074 6865 2062 7563 6b65  delete the bucke
-00024530: 7420 7573 696e 670a 2020 2020 2020 2020  t using.        
-00024540: 2020 2020 2320 2020 626f 746f 3320 6469      #   boto3 di
-00024550: 7265 6374 6c79 2e0a 2020 2020 2020 2020  rectly..        
-00024560: 2020 2020 7374 6f72 6167 655f 6f62 6a2e      storage_obj.
-00024570: 6465 6c65 7465 2829 0a0a 2020 2020 4070  delete()..    @p
-00024580: 7974 6573 742e 6669 7874 7572 650a 2020  ytest.fixture.  
-00024590: 2020 6465 6620 746d 705f 7363 7261 7463    def tmp_scratc
-000245a0: 685f 7374 6f72 6167 655f 6f62 6a28 7365  h_storage_obj(se
-000245b0: 6c66 2c20 746d 705f 6275 636b 6574 5f6e  lf, tmp_bucket_n
-000245c0: 616d 6529 3a0a 2020 2020 2020 2020 2320  ame):.        # 
-000245d0: 4372 6561 7465 7320 6120 7374 6f72 6167  Creates a storag
-000245e0: 6520 6f62 6a65 6374 2077 6974 6820 6e6f  e object with no
-000245f0: 2073 6f75 7263 6520 746f 2063 7265 6174   source to creat
-00024600: 6520 6120 7363 7261 7463 6820 7374 6f72  e a scratch stor
-00024610: 6167 652e 0a20 2020 2020 2020 2023 2053  age..        # S
-00024620: 746f 7265 7320 6d75 7374 2062 6520 6164  tores must be ad
-00024630: 6465 6420 696e 2074 6865 2074 6573 742e  ded in the test.
-00024640: 0a20 2020 2020 2020 2079 6965 6c64 2066  .        yield f
-00024650: 726f 6d20 7365 6c66 2e79 6965 6c64 5f73  rom self.yield_s
-00024660: 746f 7261 6765 5f6f 626a 6563 7428 6e61  torage_object(na
-00024670: 6d65 3d74 6d70 5f62 7563 6b65 745f 6e61  me=tmp_bucket_na
-00024680: 6d65 290a 0a20 2020 2040 7079 7465 7374  me)..    @pytest
-00024690: 2e66 6978 7475 7265 0a20 2020 2064 6566  .fixture.    def
-000246a0: 2074 6d70 5f6d 756c 7469 706c 655f 7363   tmp_multiple_sc
-000246b0: 7261 7463 685f 7374 6f72 6167 655f 6f62  ratch_storage_ob
-000246c0: 6a28 7365 6c66 293a 0a20 2020 2020 2020  j(self):.       
-000246d0: 2023 2043 7265 6174 6573 2061 206c 6973   # Creates a lis
-000246e0: 7420 6f66 2035 2073 746f 7261 6765 206f  t of 5 storage o
-000246f0: 626a 6563 7473 2077 6974 6820 6e6f 2073  bjects with no s
-00024700: 6f75 7263 6520 746f 2063 7265 6174 650a  ource to create.
-00024710: 2020 2020 2020 2020 2320 6d75 6c74 6970          # multip
-00024720: 6c65 2073 6372 6174 6368 2073 746f 7261  le scratch stora
-00024730: 6765 732e 0a20 2020 2020 2020 2023 2053  ges..        # S
-00024740: 746f 7265 7320 666f 7220 6561 6368 206f  tores for each o
-00024750: 626a 6563 7420 696e 2074 6865 206c 6973  bject in the lis
-00024760: 7420 6d75 7374 2062 6520 6164 6465 6420  t must be added 
-00024770: 696e 2074 6865 2074 6573 742e 0a20 2020  in the test..   
-00024780: 2020 2020 2073 746f 7261 6765 5f6d 756c       storage_mul
-00024790: 745f 6f62 6a20 3d20 5b5d 0a20 2020 2020  t_obj = [].     
-000247a0: 2020 2066 6f72 205f 2069 6e20 7261 6e67     for _ in rang
-000247b0: 6528 3529 3a0a 2020 2020 2020 2020 2020  e(5):.          
-000247c0: 2020 7469 6d65 7374 616d 7020 3d20 7374    timestamp = st
-000247d0: 7228 7469 6d65 2e74 696d 6528 2929 2e72  r(time.time()).r
-000247e0: 6570 6c61 6365 2827 2e27 2c20 2727 290a  eplace('.', '').
-000247f0: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
-00024800: 655f 6f62 6a20 3d20 7374 6f72 6167 655f  e_obj = storage_
-00024810: 6c69 622e 5374 6f72 6167 6528 6e61 6d65  lib.Storage(name
-00024820: 3d66 2773 6b79 2d74 6573 742d 7b74 696d  =f'sky-test-{tim
-00024830: 6573 7461 6d70 7d27 290a 2020 2020 2020  estamp}').      
-00024840: 2020 2020 2020 7374 6f72 6167 655f 6d75        storage_mu
-00024850: 6c74 5f6f 626a 2e61 7070 656e 6428 7374  lt_obj.append(st
-00024860: 6f72 655f 6f62 6a29 0a20 2020 2020 2020  ore_obj).       
-00024870: 2079 6965 6c64 2073 746f 7261 6765 5f6d   yield storage_m
-00024880: 756c 745f 6f62 6a0a 2020 2020 2020 2020  ult_obj.        
-00024890: 666f 7220 7374 6f72 6167 655f 6f62 6a20  for storage_obj 
-000248a0: 696e 2073 746f 7261 6765 5f6d 756c 745f  in storage_mult_
-000248b0: 6f62 6a3a 0a20 2020 2020 2020 2020 2020  obj:.           
-000248c0: 2068 616e 646c 6520 3d20 676c 6f62 616c   handle = global
-000248d0: 5f75 7365 725f 7374 6174 652e 6765 745f  _user_state.get_
-000248e0: 6861 6e64 6c65 5f66 726f 6d5f 7374 6f72  handle_from_stor
-000248f0: 6167 655f 6e61 6d65 280a 2020 2020 2020  age_name(.      
-00024900: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
-00024910: 655f 6f62 6a2e 6e61 6d65 290a 2020 2020  e_obj.name).    
-00024920: 2020 2020 2020 2020 6966 2068 616e 646c          if handl
-00024930: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00024940: 2020 2023 2049 6620 6861 6e64 6c65 2065     # If handle e
-00024950: 7869 7374 732c 2064 656c 6574 6520 6d61  xists, delete ma
-00024960: 6e75 616c 6c79 0a20 2020 2020 2020 2020  nually.         
-00024970: 2020 2020 2020 2023 2054 4f44 4f28 726f         # TODO(ro
-00024980: 6d69 6c62 293a 2054 6869 7320 6973 2070  milb): This is p
-00024990: 6f74 656e 7469 616c 6c79 2072 6973 6b79  otentially risky
-000249a0: 202d 2069 6620 7468 6520 6465 6c65 7465   - if the delete
-000249b0: 206d 6574 686f 6420 6861 730a 2020 2020   method has.    
-000249c0: 2020 2020 2020 2020 2020 2020 2320 6275              # bu
-000249d0: 6773 2c20 7468 6973 2063 616e 2063 6175  gs, this can cau
-000249e0: 7365 2072 6573 6f75 7263 6520 6c65 616b  se resource leak
-000249f0: 732e 2049 6465 616c 6c79 2077 6520 7368  s. Ideally we sh
-00024a00: 6f75 6c64 206d 616e 7561 6c6c 790a 2020  ould manually.  
-00024a10: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00024a20: 656a 6563 7420 7374 6f72 6167 6520 6672  eject storage fr
-00024a30: 6f6d 2067 6c6f 6261 6c5f 7573 6572 5f73  om global_user_s
-00024a40: 7461 7465 2061 6e64 2064 656c 6574 6520  tate and delete 
-00024a50: 7468 6520 6275 636b 6574 2075 7369 6e67  the bucket using
-00024a60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00024a70: 2023 2062 6f74 6f33 2064 6972 6563 746c   # boto3 directl
-00024a80: 792e 0a20 2020 2020 2020 2020 2020 2020  y..             
-00024a90: 2020 2073 746f 7261 6765 5f6f 626a 2e64     storage_obj.d
-00024aa0: 656c 6574 6528 290a 0a20 2020 2040 7079  elete()..    @py
-00024ab0: 7465 7374 2e66 6978 7475 7265 0a20 2020  test.fixture.   
-00024ac0: 2064 6566 2074 6d70 5f6d 756c 7469 706c   def tmp_multipl
-00024ad0: 655f 6375 7374 6f6d 5f73 6f75 7263 655f  e_custom_source_
-00024ae0: 7374 6f72 6167 655f 6f62 6a28 7365 6c66  storage_obj(self
-00024af0: 293a 0a20 2020 2020 2020 2023 2043 7265  ):.        # Cre
-00024b00: 6174 6573 2061 206c 6973 7420 6f66 2073  ates a list of s
-00024b10: 746f 7261 6765 206f 626a 6563 7473 2077  torage objects w
-00024b20: 6974 6820 6375 7374 6f6d 2073 6f75 7263  ith custom sourc
-00024b30: 6520 6e61 6d65 7320 746f 0a20 2020 2020  e names to.     
-00024b40: 2020 2023 2063 7265 6174 6520 6d75 6c74     # create mult
-00024b50: 6970 6c65 2073 6372 6174 6368 2073 746f  iple scratch sto
-00024b60: 7261 6765 732e 0a20 2020 2020 2020 2023  rages..        #
-00024b70: 2053 746f 7265 7320 666f 7220 6561 6368   Stores for each
-00024b80: 206f 626a 6563 7420 696e 2074 6865 206c   object in the l
-00024b90: 6973 7420 6d75 7374 2062 6520 6164 6465  ist must be adde
-00024ba0: 6420 696e 2074 6865 2074 6573 742e 0a20  d in the test.. 
-00024bb0: 2020 2020 2020 2063 7573 746f 6d5f 736f         custom_so
-00024bc0: 7572 6365 5f6e 616d 6573 203d 205b 2722  urce_names = ['"
-00024bd0: 7061 7468 2057 6974 6820 5370 6163 6573  path With Spaces
-00024be0: 2227 2c20 2770 6174 6820 5769 7468 2053  "', 'path With S
-00024bf0: 7061 6365 7327 5d0a 2020 2020 2020 2020  paces'].        
-00024c00: 7374 6f72 6167 655f 6d75 6c74 5f6f 626a  storage_mult_obj
-00024c10: 203d 205b 5d0a 2020 2020 2020 2020 666f   = [].        fo
-00024c20: 7220 6e61 6d65 2069 6e20 6375 7374 6f6d  r name in custom
-00024c30: 5f73 6f75 7263 655f 6e61 6d65 733a 0a20  _source_names:. 
-00024c40: 2020 2020 2020 2020 2020 2073 7263 5f70             src_p
-00024c50: 6174 6820 3d20 6f73 2e70 6174 682e 6578  ath = os.path.ex
-00024c60: 7061 6e64 7573 6572 2866 277e 2f7b 6e61  panduser(f'~/{na
-00024c70: 6d65 7d27 290a 2020 2020 2020 2020 2020  me}').          
-00024c80: 2020 7061 7468 6c69 622e 5061 7468 2873    pathlib.Path(s
-00024c90: 7263 5f70 6174 6829 2e65 7870 616e 6475  rc_path).expandu
-00024ca0: 7365 7228 292e 6d6b 6469 7228 6578 6973  ser().mkdir(exis
-00024cb0: 745f 6f6b 3d54 7275 6529 0a20 2020 2020  t_ok=True).     
-00024cc0: 2020 2020 2020 2074 696d 6573 7461 6d70         timestamp
-00024cd0: 203d 2073 7472 2874 696d 652e 7469 6d65   = str(time.time
-00024ce0: 2829 292e 7265 706c 6163 6528 272e 272c  ()).replace('.',
-00024cf0: 2027 2729 0a20 2020 2020 2020 2020 2020   '').           
-00024d00: 2073 746f 7265 5f6f 626a 203d 2073 746f   store_obj = sto
-00024d10: 7261 6765 5f6c 6962 2e53 746f 7261 6765  rage_lib.Storage
-00024d20: 286e 616d 653d 6627 736b 792d 7465 7374  (name=f'sky-test
-00024d30: 2d7b 7469 6d65 7374 616d 707d 272c 0a20  -{timestamp}',. 
-00024d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024d60: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
-00024d70: 653d 7372 635f 7061 7468 290a 2020 2020  e=src_path).    
-00024d80: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
-00024d90: 6d75 6c74 5f6f 626a 2e61 7070 656e 6428  mult_obj.append(
-00024da0: 7374 6f72 655f 6f62 6a29 0a20 2020 2020  store_obj).     
-00024db0: 2020 2079 6965 6c64 2073 746f 7261 6765     yield storage
-00024dc0: 5f6d 756c 745f 6f62 6a0a 2020 2020 2020  _mult_obj.      
-00024dd0: 2020 666f 7220 7374 6f72 6167 655f 6f62    for storage_ob
-00024de0: 6a20 696e 2073 746f 7261 6765 5f6d 756c  j in storage_mul
-00024df0: 745f 6f62 6a3a 0a20 2020 2020 2020 2020  t_obj:.         
-00024e00: 2020 2068 616e 646c 6520 3d20 676c 6f62     handle = glob
-00024e10: 616c 5f75 7365 725f 7374 6174 652e 6765  al_user_state.ge
-00024e20: 745f 6861 6e64 6c65 5f66 726f 6d5f 7374  t_handle_from_st
-00024e30: 6f72 6167 655f 6e61 6d65 280a 2020 2020  orage_name(.    
-00024e40: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
-00024e50: 6167 655f 6f62 6a2e 6e61 6d65 290a 2020  age_obj.name).  
-00024e60: 2020 2020 2020 2020 2020 6966 2068 616e            if han
-00024e70: 646c 653a 0a20 2020 2020 2020 2020 2020  dle:.           
-00024e80: 2020 2020 2073 746f 7261 6765 5f6f 626a       storage_obj
-00024e90: 2e64 656c 6574 6528 290a 0a20 2020 2040  .delete()..    @
-00024ea0: 7079 7465 7374 2e66 6978 7475 7265 0a20  pytest.fixture. 
-00024eb0: 2020 2064 6566 2074 6d70 5f6c 6f63 616c     def tmp_local
-00024ec0: 5f73 746f 7261 6765 5f6f 626a 2873 656c  _storage_obj(sel
-00024ed0: 662c 2074 6d70 5f62 7563 6b65 745f 6e61  f, tmp_bucket_na
-00024ee0: 6d65 2c20 746d 705f 736f 7572 6365 293a  me, tmp_source):
-00024ef0: 0a20 2020 2020 2020 2023 2043 7265 6174  .        # Creat
-00024f00: 6573 2061 2074 656d 706f 7261 7279 2073  es a temporary s
-00024f10: 746f 7261 6765 206f 626a 6563 742e 2053  torage object. S
-00024f20: 746f 7265 7320 6d75 7374 2062 6520 6164  tores must be ad
-00024f30: 6465 6420 696e 2074 6865 2074 6573 742e  ded in the test.
-00024f40: 0a20 2020 2020 2020 2079 6965 6c64 2066  .        yield f
-00024f50: 726f 6d20 7365 6c66 2e79 6965 6c64 5f73  rom self.yield_s
-00024f60: 746f 7261 6765 5f6f 626a 6563 7428 6e61  torage_object(na
-00024f70: 6d65 3d74 6d70 5f62 7563 6b65 745f 6e61  me=tmp_bucket_na
-00024f80: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
-00024f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024fb0: 2073 6f75 7263 653d 746d 705f 736f 7572   source=tmp_sour
-00024fc0: 6365 290a 0a20 2020 2040 7079 7465 7374  ce)..    @pytest
-00024fd0: 2e66 6978 7475 7265 0a20 2020 2064 6566  .fixture.    def
-00024fe0: 2074 6d70 5f6c 6f63 616c 5f6c 6973 745f   tmp_local_list_
-00024ff0: 7374 6f72 6167 655f 6f62 6a28 7365 6c66  storage_obj(self
-00025000: 2c20 746d 705f 6275 636b 6574 5f6e 616d  , tmp_bucket_nam
-00025010: 652c 2074 6d70 5f73 6f75 7263 6529 3a0a  e, tmp_source):.
-00025020: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
-00025030: 7320 6120 7465 6d70 2073 746f 7261 6765  s a temp storage
-00025040: 206f 626a 6563 7420 7768 6963 6820 7573   object which us
-00025050: 6573 2061 206c 6973 7420 6f66 2070 6174  es a list of pat
-00025060: 6873 2061 7320 736f 7572 6365 2e0a 2020  hs as source..  
-00025070: 2020 2020 2020 2320 5374 6f72 6573 206d        # Stores m
-00025080: 7573 7420 6265 2061 6464 6564 2069 6e20  ust be added in 
-00025090: 7468 6520 7465 7374 2e20 4166 7465 7220  the test. After 
-000250a0: 7570 6c6f 6164 2c20 7468 6520 6275 636b  upload, the buck
-000250b0: 6574 2073 686f 756c 640a 2020 2020 2020  et should.      
-000250c0: 2020 2320 6861 7665 2074 776f 2066 696c    # have two fil
-000250d0: 6573 202d 202f 746d 702d 6669 6c65 2061  es - /tmp-file a
-000250e0: 6e64 202f 746d 702d 736f 7572 6365 2f74  nd /tmp-source/t
-000250f0: 6d70 2d66 696c 650a 2020 2020 2020 2020  mp-file.        
-00025100: 6c69 7374 5f73 6f75 7263 6520 3d20 5b74  list_source = [t
-00025110: 6d70 5f73 6f75 7263 652c 2074 6d70 5f73  mp_source, tmp_s
-00025120: 6f75 7263 6520 2b20 272f 746d 702d 6669  ource + '/tmp-fi
-00025130: 6c65 275d 0a20 2020 2020 2020 2079 6965  le'].        yie
-00025140: 6c64 2066 726f 6d20 7365 6c66 2e79 6965  ld from self.yie
-00025150: 6c64 5f73 746f 7261 6765 5f6f 626a 6563  ld_storage_objec
-00025160: 7428 6e61 6d65 3d74 6d70 5f62 7563 6b65  t(name=tmp_bucke
-00025170: 745f 6e61 6d65 2c0a 2020 2020 2020 2020  t_name,.        
-00025180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000251a0: 2020 2020 2073 6f75 7263 653d 6c69 7374       source=list
-000251b0: 5f73 6f75 7263 6529 0a0a 2020 2020 4070  _source)..    @p
-000251c0: 7974 6573 742e 6669 7874 7572 650a 2020  ytest.fixture.  
-000251d0: 2020 6465 6620 746d 705f 6275 6c6b 5f64    def tmp_bulk_d
-000251e0: 656c 5f73 746f 7261 6765 5f6f 626a 2873  el_storage_obj(s
-000251f0: 656c 662c 2074 6d70 5f62 7563 6b65 745f  elf, tmp_bucket_
-00025200: 6e61 6d65 293a 0a20 2020 2020 2020 2023  name):.        #
-00025210: 2043 7265 6174 6573 2061 2074 656d 706f   Creates a tempo
-00025220: 7261 7279 2073 746f 7261 6765 206f 626a  rary storage obj
-00025230: 6563 7420 666f 7220 7465 7374 696e 6720  ect for testing 
-00025240: 6275 6c6b 2064 656c 6574 696f 6e2e 0a20  bulk deletion.. 
-00025250: 2020 2020 2020 2023 2053 746f 7265 7320         # Stores 
-00025260: 6d75 7374 2062 6520 6164 6465 6420 696e  must be added in
-00025270: 2074 6865 2074 6573 742e 0a20 2020 2020   the test..     
-00025280: 2020 2077 6974 6820 7465 6d70 6669 6c65     with tempfile
-00025290: 2e54 656d 706f 7261 7279 4469 7265 6374  .TemporaryDirect
-000252a0: 6f72 7928 2920 6173 2074 6d70 6469 723a  ory() as tmpdir:
-000252b0: 0a20 2020 2020 2020 2020 2020 2073 7562  .            sub
-000252c0: 7072 6f63 6573 732e 6368 6563 6b5f 6f75  process.check_ou
-000252d0: 7470 7574 2866 276d 6b64 6972 202d 7020  tput(f'mkdir -p 
-000252e0: 7b74 6d70 6469 727d 2f66 6f6c 6465 727b  {tmpdir}/folder{
-000252f0: 7b30 3030 2e2e 3235 357d 7d27 2c0a 2020  {000..255}}',.  
-00025300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025320: 2020 7368 656c 6c3d 5472 7565 290a 2020    shell=True).  
-00025330: 2020 2020 2020 2020 2020 7375 6270 726f            subpro
-00025340: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
-00025350: 7428 6627 746f 7563 6820 7b74 6d70 6469  t(f'touch {tmpdi
-00025360: 727d 2f74 6573 747b 7b30 3030 2e2e 3235  r}/test{{000..25
-00025370: 357d 7d2e 7478 7427 2c0a 2020 2020 2020  5}}.txt',.      
-00025380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025390: 2020 2020 2020 2020 2020 2020 2020 7368                sh
-000253a0: 656c 6c3d 5472 7565 290a 2020 2020 2020  ell=True).      
-000253b0: 2020 2020 2020 7375 6270 726f 6365 7373        subprocess
-000253c0: 2e63 6865 636b 5f6f 7574 7075 7428 0a20  .check_output(. 
-000253d0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000253e0: 2774 6f75 6368 207b 746d 7064 6972 7d2f  'touch {tmpdir}/
-000253f0: 666f 6c64 6572 7b7b 3030 302e 2e32 3535  folder{{000..255
-00025400: 7d7d 2f74 6573 742e 7478 7427 2c20 7368  }}/test.txt', sh
-00025410: 656c 6c3d 5472 7565 290a 2020 2020 2020  ell=True).      
-00025420: 2020 2020 2020 7969 656c 6420 6672 6f6d        yield from
-00025430: 2073 656c 662e 7969 656c 645f 7374 6f72   self.yield_stor
-00025440: 6167 655f 6f62 6a65 6374 286e 616d 653d  age_object(name=
-00025450: 746d 705f 6275 636b 6574 5f6e 616d 652c  tmp_bucket_name,
-00025460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00025470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025490: 2020 736f 7572 6365 3d74 6d70 6469 7229    source=tmpdir)
-000254a0: 0a0a 2020 2020 4070 7974 6573 742e 6669  ..    @pytest.fi
-000254b0: 7874 7572 650a 2020 2020 6465 6620 746d  xture.    def tm
-000254c0: 705f 636f 7079 5f6d 6e74 5f65 7869 7374  p_copy_mnt_exist
-000254d0: 696e 675f 7374 6f72 6167 655f 6f62 6a28  ing_storage_obj(
-000254e0: 7365 6c66 2c20 746d 705f 7363 7261 7463  self, tmp_scratc
-000254f0: 685f 7374 6f72 6167 655f 6f62 6a29 3a0a  h_storage_obj):.
-00025500: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
-00025510: 7320 6120 636f 7079 206d 6f75 6e74 2073  s a copy mount s
-00025520: 746f 7261 6765 2077 6869 6368 2072 6575  torage which reu
-00025530: 7365 7320 616e 2065 7869 7374 696e 6720  ses an existing 
-00025540: 7374 6f72 6167 6520 6f62 6a65 6374 2e0a  storage object..
-00025550: 2020 2020 2020 2020 746d 705f 7363 7261          tmp_scra
-00025560: 7463 685f 7374 6f72 6167 655f 6f62 6a2e  tch_storage_obj.
-00025570: 6164 645f 7374 6f72 6528 7374 6f72 6167  add_store(storag
-00025580: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
-00025590: 5333 290a 2020 2020 2020 2020 7374 6f72  S3).        stor
-000255a0: 6167 655f 6e61 6d65 203d 2074 6d70 5f73  age_name = tmp_s
-000255b0: 6372 6174 6368 5f73 746f 7261 6765 5f6f  cratch_storage_o
-000255c0: 626a 2e6e 616d 650a 0a20 2020 2020 2020  bj.name..       
-000255d0: 2023 2054 7279 2074 6f20 696e 6974 6961   # Try to initia
-000255e0: 6c69 7a65 2061 6e6f 7468 6572 2073 746f  lize another sto
-000255f0: 7261 6765 2077 6974 6820 7468 6520 7374  rage with the st
-00025600: 6f72 6167 6520 6f62 6a65 6374 2063 7265  orage object cre
-00025610: 6174 6564 0a20 2020 2020 2020 2023 2061  ated.        # a
-00025620: 626f 7665 2c20 6275 7420 6e6f 7720 696e  bove, but now in
-00025630: 2043 4f50 5920 6d6f 6465 2e20 5468 6973   COPY mode. This
-00025640: 2073 686f 756c 6420 7375 6363 6565 642e   should succeed.
-00025650: 0a20 2020 2020 2020 2079 6965 6c64 2066  .        yield f
-00025660: 726f 6d20 7365 6c66 2e79 6965 6c64 5f73  rom self.yield_s
-00025670: 746f 7261 6765 5f6f 626a 6563 7428 6e61  torage_object(na
-00025680: 6d65 3d73 746f 7261 6765 5f6e 616d 652c  me=storage_name,
-00025690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000256a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000256b0: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
-000256c0: 6465 3d73 746f 7261 6765 5f6c 6962 2e53  de=storage_lib.S
-000256d0: 746f 7261 6765 4d6f 6465 2e43 4f50 5929  torageMode.COPY)
-000256e0: 0a0a 2020 2020 4070 7974 6573 742e 6669  ..    @pytest.fi
-000256f0: 7874 7572 650a 2020 2020 6465 6620 746d  xture.    def tm
-00025700: 705f 6769 7469 676e 6f72 655f 7374 6f72  p_gitignore_stor
-00025710: 6167 655f 6f62 6a28 7365 6c66 2c20 746d  age_obj(self, tm
-00025720: 705f 6275 636b 6574 5f6e 616d 652c 2067  p_bucket_name, g
-00025730: 6974 6967 6e6f 7265 5f73 7472 7563 7475  itignore_structu
-00025740: 7265 293a 0a20 2020 2020 2020 2023 2043  re):.        # C
-00025750: 7265 6174 6573 2061 2074 656d 706f 7261  reates a tempora
-00025760: 7279 2073 746f 7261 6765 206f 626a 6563  ry storage objec
-00025770: 7420 666f 7220 7465 7374 696e 6720 2e67  t for testing .g
-00025780: 6974 6967 6e6f 7265 2066 696c 7465 722e  itignore filter.
-00025790: 0a20 2020 2020 2020 2023 2047 4954 4947  .        # GITIG
-000257a0: 494e 4f52 455f 5354 5255 4354 5552 4520  INORE_STRUCTURE 
-000257b0: 6973 2072 6570 7265 7365 6e74 696e 6720  is representing 
-000257c0: 6120 6669 6c65 2073 7472 7563 7475 7265  a file structure
-000257d0: 2069 6e20 6120 6469 6374 696f 6e61 7279   in a dictionary
-000257e0: 0a20 2020 2020 2020 2023 2066 6f72 6d61  .        # forma
-000257f0: 742e 2043 7265 6174 6564 2073 746f 7261  t. Created stora
-00025800: 6765 206f 626a 6563 7420 7769 6c6c 2063  ge object will c
-00025810: 6f6e 7461 696e 2074 6865 2066 696c 6520  ontain the file 
-00025820: 7374 7275 6374 7572 6520 616c 6f6e 670a  structure along.
-00025830: 2020 2020 2020 2020 2320 7769 7468 202e          # with .
-00025840: 6769 7469 676e 6f72 6520 616e 6420 2e67  gitignore and .g
-00025850: 6974 2f69 6e66 6f2f 6578 636c 7564 6520  it/info/exclude 
-00025860: 6669 6c65 7320 746f 2074 6573 7420 6578  files to test ex
-00025870: 636c 7564 6520 6669 6c74 6572 2e0a 2020  clude filter..  
-00025880: 2020 2020 2020 2320 5374 6f72 6573 206d        # Stores m
-00025890: 7573 7420 6265 2061 6464 6564 2069 6e20  ust be added in 
-000258a0: 7468 6520 7465 7374 2e0a 2020 2020 2020  the test..      
-000258b0: 2020 7769 7468 2074 656d 7066 696c 652e    with tempfile.
-000258c0: 5465 6d70 6f72 6172 7944 6972 6563 746f  TemporaryDirecto
-000258d0: 7279 2829 2061 7320 746d 7064 6972 3a0a  ry() as tmpdir:.
-000258e0: 2020 2020 2020 2020 2020 2020 2320 4372              # Cr
-000258f0: 6561 7465 7320 6669 6c65 2073 7472 7563  eates file struc
-00025900: 7475 7265 2074 6f20 6265 2075 706c 6f61  ture to be uploa
-00025910: 6465 6420 696e 2074 6865 2053 746f 7261  ded in the Stora
-00025920: 6765 0a20 2020 2020 2020 2020 2020 2073  ge.            s
-00025930: 656c 662e 6372 6561 7465 5f64 6972 5f73  elf.create_dir_s
-00025940: 7472 7563 7475 7265 2874 6d70 6469 722c  tructure(tmpdir,
-00025950: 2067 6974 6967 6e6f 7265 5f73 7472 7563   gitignore_struc
-00025960: 7475 7265 290a 0a20 2020 2020 2020 2020  ture)..         
-00025970: 2020 2023 2043 7265 6174 6520 2e67 6974     # Create .git
-00025980: 6967 6e6f 7265 2061 6e64 206c 6973 7420  ignore and list 
-00025990: 6669 6c65 732f 6469 7273 2074 6f20 6265  files/dirs to be
-000259a0: 2065 7863 6c75 6465 6420 696e 2069 740a   excluded in it.
-000259b0: 2020 2020 2020 2020 2020 2020 736b 7970              skyp
-000259c0: 696c 6f74 5f70 6174 6820 3d20 6f73 2e70  ilot_path = os.p
-000259d0: 6174 682e 6469 726e 616d 6528 6f73 2e70  ath.dirname(os.p
-000259e0: 6174 682e 6469 726e 616d 6528 736b 792e  ath.dirname(sky.
-000259f0: 5f5f 6669 6c65 5f5f 2929 0a20 2020 2020  __file__)).     
-00025a00: 2020 2020 2020 2074 656d 705f 7061 7468         temp_path
-00025a10: 203d 2066 277b 746d 7064 6972 7d2f 2e67   = f'{tmpdir}/.g
-00025a20: 6974 6967 6e6f 7265 270a 2020 2020 2020  itignore'.      
-00025a30: 2020 2020 2020 6669 6c65 5f70 6174 6820        file_path 
-00025a40: 3d20 6f73 2e70 6174 682e 6a6f 696e 2873  = os.path.join(s
-00025a50: 6b79 7069 6c6f 745f 7061 7468 2c20 2774  kypilot_path, 't
-00025a60: 6573 7473 2f67 6974 6967 6e6f 7265 5f74  ests/gitignore_t
-00025a70: 6573 7427 290a 2020 2020 2020 2020 2020  est').          
-00025a80: 2020 7368 7574 696c 2e63 6f70 7966 696c    shutil.copyfil
-00025a90: 6528 6669 6c65 5f70 6174 682c 2074 656d  e(file_path, tem
-00025aa0: 705f 7061 7468 290a 0a20 2020 2020 2020  p_path)..       
-00025ab0: 2020 2020 2023 2043 7265 6174 6520 2e67       # Create .g
-00025ac0: 6974 2f69 6e66 6f2f 6578 636c 7564 6520  it/info/exclude 
-00025ad0: 616e 6420 6c69 7374 2066 696c 6573 2f64  and list files/d
-00025ae0: 6972 7320 746f 2062 6520 6578 636c 7564  irs to be exclud
-00025af0: 6564 2069 6e20 6974 0a20 2020 2020 2020  ed in it.       
-00025b00: 2020 2020 2074 656d 705f 7061 7468 203d       temp_path =
-00025b10: 2066 277b 746d 7064 6972 7d2f 2e67 6974   f'{tmpdir}/.git
-00025b20: 2f69 6e66 6f2f 270a 2020 2020 2020 2020  /info/'.        
-00025b30: 2020 2020 6f73 2e6d 616b 6564 6972 7328      os.makedirs(
-00025b40: 7465 6d70 5f70 6174 6829 0a20 2020 2020  temp_path).     
-00025b50: 2020 2020 2020 2074 656d 705f 6578 636c         temp_excl
-00025b60: 7564 655f 7061 7468 203d 206f 732e 7061  ude_path = os.pa
-00025b70: 7468 2e6a 6f69 6e28 7465 6d70 5f70 6174  th.join(temp_pat
-00025b80: 682c 2027 6578 636c 7564 6527 290a 2020  h, 'exclude').  
-00025b90: 2020 2020 2020 2020 2020 6669 6c65 5f70            file_p
-00025ba0: 6174 6820 3d20 6f73 2e70 6174 682e 6a6f  ath = os.path.jo
-00025bb0: 696e 2873 6b79 7069 6c6f 745f 7061 7468  in(skypilot_path
-00025bc0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00025bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025be0: 2020 2020 2020 2027 7465 7374 732f 6769         'tests/gi
-00025bf0: 745f 696e 666f 5f65 7863 6c75 6465 5f74  t_info_exclude_t
-00025c00: 6573 7427 290a 2020 2020 2020 2020 2020  est').          
-00025c10: 2020 7368 7574 696c 2e63 6f70 7966 696c    shutil.copyfil
-00025c20: 6528 6669 6c65 5f70 6174 682c 2074 656d  e(file_path, tem
-00025c30: 705f 6578 636c 7564 655f 7061 7468 290a  p_exclude_path).
-00025c40: 0a20 2020 2020 2020 2020 2020 2023 2043  .            # C
-00025c50: 7265 6174 6520 736b 7920 5374 6f72 6167  reate sky Storag
-00025c60: 6520 7769 7468 2074 6865 2066 696c 6573  e with the files
-00025c70: 2063 7265 6174 6564 0a20 2020 2020 2020   created.       
-00025c80: 2020 2020 2079 6965 6c64 2066 726f 6d20       yield from 
-00025c90: 7365 6c66 2e79 6965 6c64 5f73 746f 7261  self.yield_stora
-00025ca0: 6765 5f6f 626a 6563 7428 0a20 2020 2020  ge_object(.     
-00025cb0: 2020 2020 2020 2020 2020 206e 616d 653d             name=
-00025cc0: 746d 705f 6275 636b 6574 5f6e 616d 652c  tmp_bucket_name,
-00025cd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00025ce0: 2073 6f75 7263 653d 746d 7064 6972 2c0a   source=tmpdir,.
-00025cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025d00: 6d6f 6465 3d73 746f 7261 6765 5f6c 6962  mode=storage_lib
-00025d10: 2e53 746f 7261 6765 4d6f 6465 2e43 4f50  .StorageMode.COP
-00025d20: 5929 0a0a 2020 2020 4070 7974 6573 742e  Y)..    @pytest.
-00025d30: 6669 7874 7572 650a 2020 2020 6465 6620  fixture.    def 
-00025d40: 746d 705f 6177 7363 6c69 5f62 7563 6b65  tmp_awscli_bucke
-00025d50: 7428 7365 6c66 2c20 746d 705f 6275 636b  t(self, tmp_buck
-00025d60: 6574 5f6e 616d 6529 3a0a 2020 2020 2020  et_name):.      
-00025d70: 2020 2320 4372 6561 7465 7320 6120 7465    # Creates a te
-00025d80: 6d70 6f72 6172 7920 6275 636b 6574 2075  mporary bucket u
-00025d90: 7369 6e67 2061 7773 636c 690a 2020 2020  sing awscli.    
-00025da0: 2020 2020 6275 636b 6574 5f75 7269 203d      bucket_uri =
-00025db0: 2066 2773 333a 2f2f 7b74 6d70 5f62 7563   f's3://{tmp_buc
-00025dc0: 6b65 745f 6e61 6d65 7d27 0a20 2020 2020  ket_name}'.     
-00025dd0: 2020 2073 7562 7072 6f63 6573 732e 6368     subprocess.ch
-00025de0: 6563 6b5f 6361 6c6c 285b 2761 7773 272c  eck_call(['aws',
-00025df0: 2027 7333 272c 2027 6d62 272c 2062 7563   's3', 'mb', buc
-00025e00: 6b65 745f 7572 695d 290a 2020 2020 2020  ket_uri]).      
-00025e10: 2020 7969 656c 6420 746d 705f 6275 636b    yield tmp_buck
-00025e20: 6574 5f6e 616d 652c 2062 7563 6b65 745f  et_name, bucket_
-00025e30: 7572 690a 2020 2020 2020 2020 7375 6270  uri.        subp
-00025e40: 726f 6365 7373 2e63 6865 636b 5f63 616c  rocess.check_cal
-00025e50: 6c28 5b27 6177 7327 2c20 2773 3327 2c20  l(['aws', 's3', 
-00025e60: 2772 6227 2c20 6275 636b 6574 5f75 7269  'rb', bucket_uri
-00025e70: 2c20 272d 2d66 6f72 6365 275d 290a 0a20  , '--force']).. 
-00025e80: 2020 2040 7079 7465 7374 2e66 6978 7475     @pytest.fixtu
-00025e90: 7265 0a20 2020 2064 6566 2074 6d70 5f67  re.    def tmp_g
-00025ea0: 7375 7469 6c5f 6275 636b 6574 2873 656c  sutil_bucket(sel
-00025eb0: 662c 2074 6d70 5f62 7563 6b65 745f 6e61  f, tmp_bucket_na
-00025ec0: 6d65 293a 0a20 2020 2020 2020 2023 2043  me):.        # C
-00025ed0: 7265 6174 6573 2061 2074 656d 706f 7261  reates a tempora
-00025ee0: 7279 2062 7563 6b65 7420 7573 696e 6720  ry bucket using 
-00025ef0: 6773 7574 696c 0a20 2020 2020 2020 2062  gsutil.        b
-00025f00: 7563 6b65 745f 7572 6920 3d20 6627 6773  ucket_uri = f'gs
-00025f10: 3a2f 2f7b 746d 705f 6275 636b 6574 5f6e  ://{tmp_bucket_n
-00025f20: 616d 657d 270a 2020 2020 2020 2020 7375  ame}'.        su
-00025f30: 6270 726f 6365 7373 2e63 6865 636b 5f63  bprocess.check_c
-00025f40: 616c 6c28 5b27 6773 7574 696c 272c 2027  all(['gsutil', '
-00025f50: 6d62 272c 2062 7563 6b65 745f 7572 695d  mb', bucket_uri]
-00025f60: 290a 2020 2020 2020 2020 7969 656c 6420  ).        yield 
-00025f70: 746d 705f 6275 636b 6574 5f6e 616d 652c  tmp_bucket_name,
-00025f80: 2062 7563 6b65 745f 7572 690a 2020 2020   bucket_uri.    
-00025f90: 2020 2020 7375 6270 726f 6365 7373 2e63      subprocess.c
-00025fa0: 6865 636b 5f63 616c 6c28 5b27 6773 7574  heck_call(['gsut
-00025fb0: 696c 272c 2027 726d 272c 2027 2d72 272c  il', 'rm', '-r',
-00025fc0: 2062 7563 6b65 745f 7572 695d 290a 0a20   bucket_uri]).. 
-00025fd0: 2020 2040 7079 7465 7374 2e66 6978 7475     @pytest.fixtu
-00025fe0: 7265 0a20 2020 2064 6566 2074 6d70 5f61  re.    def tmp_a
-00025ff0: 7773 636c 695f 6275 636b 6574 5f72 3228  wscli_bucket_r2(
-00026000: 7365 6c66 2c20 746d 705f 6275 636b 6574  self, tmp_bucket
-00026010: 5f6e 616d 6529 3a0a 2020 2020 2020 2020  _name):.        
-00026020: 2320 4372 6561 7465 7320 6120 7465 6d70  # Creates a temp
-00026030: 6f72 6172 7920 6275 636b 6574 2075 7369  orary bucket usi
-00026040: 6e67 2061 7773 636c 690a 2020 2020 2020  ng awscli.      
-00026050: 2020 656e 6470 6f69 6e74 5f75 726c 203d    endpoint_url =
-00026060: 2063 6c6f 7564 666c 6172 652e 6372 6561   cloudflare.crea
-00026070: 7465 5f65 6e64 706f 696e 7428 290a 2020  te_endpoint().  
-00026080: 2020 2020 2020 6275 636b 6574 5f75 7269        bucket_uri
-00026090: 203d 2066 2773 333a 2f2f 7b74 6d70 5f62   = f's3://{tmp_b
-000260a0: 7563 6b65 745f 6e61 6d65 7d27 0a20 2020  ucket_name}'.   
-000260b0: 2020 2020 2073 7562 7072 6f63 6573 732e       subprocess.
-000260c0: 6368 6563 6b5f 6361 6c6c 280a 2020 2020  check_call(.    
-000260d0: 2020 2020 2020 2020 6627 4157 535f 5348          f'AWS_SH
-000260e0: 4152 4544 5f43 5245 4445 4e54 4941 4c53  ARED_CREDENTIALS
-000260f0: 5f46 494c 453d 7b63 6c6f 7564 666c 6172  _FILE={cloudflar
-00026100: 652e 5232 5f43 5245 4445 4e54 4941 4c53  e.R2_CREDENTIALS
-00026110: 5f50 4154 487d 2061 7773 2073 3320 6d62  _PATH} aws s3 mb
-00026120: 207b 6275 636b 6574 5f75 7269 7d20 2d2d   {bucket_uri} --
-00026130: 656e 6470 6f69 6e74 207b 656e 6470 6f69  endpoint {endpoi
-00026140: 6e74 5f75 726c 7d20 2d2d 7072 6f66 696c  nt_url} --profil
-00026150: 653d 7232 272c 0a20 2020 2020 2020 2020  e=r2',.         
-00026160: 2020 2073 6865 6c6c 3d54 7275 6529 0a20     shell=True). 
-00026170: 2020 2020 2020 2079 6965 6c64 2074 6d70         yield tmp
-00026180: 5f62 7563 6b65 745f 6e61 6d65 2c20 6275  _bucket_name, bu
-00026190: 636b 6574 5f75 7269 0a20 2020 2020 2020  cket_uri.       
-000261a0: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
-000261b0: 6b5f 6361 6c6c 280a 2020 2020 2020 2020  k_call(.        
-000261c0: 2020 2020 6627 4157 535f 5348 4152 4544      f'AWS_SHARED
-000261d0: 5f43 5245 4445 4e54 4941 4c53 5f46 494c  _CREDENTIALS_FIL
-000261e0: 453d 7b63 6c6f 7564 666c 6172 652e 5232  E={cloudflare.R2
-000261f0: 5f43 5245 4445 4e54 4941 4c53 5f50 4154  _CREDENTIALS_PAT
-00026200: 487d 2061 7773 2073 3320 7262 207b 6275  H} aws s3 rb {bu
-00026210: 636b 6574 5f75 7269 7d20 2d2d 666f 7263  cket_uri} --forc
-00026220: 6520 2d2d 656e 6470 6f69 6e74 207b 656e  e --endpoint {en
-00026230: 6470 6f69 6e74 5f75 726c 7d20 2d2d 7072  dpoint_url} --pr
-00026240: 6f66 696c 653d 7232 272c 0a20 2020 2020  ofile=r2',.     
-00026250: 2020 2020 2020 2073 6865 6c6c 3d54 7275         shell=Tru
-00026260: 6529 0a0a 2020 2020 4070 7974 6573 742e  e)..    @pytest.
-00026270: 6669 7874 7572 650a 2020 2020 6465 6620  fixture.    def 
-00026280: 746d 705f 6962 6d5f 636f 735f 6275 636b  tmp_ibm_cos_buck
-00026290: 6574 2873 656c 662c 2074 6d70 5f62 7563  et(self, tmp_buc
-000262a0: 6b65 745f 6e61 6d65 293a 0a20 2020 2020  ket_name):.     
-000262b0: 2020 2023 2043 7265 6174 6573 2061 2074     # Creates a t
-000262c0: 656d 706f 7261 7279 2062 7563 6b65 7420  emporary bucket 
-000262d0: 7573 696e 6720 4942 4d20 434f 5320 4150  using IBM COS AP
-000262e0: 490a 2020 2020 2020 2020 7374 6f72 6167  I.        storag
-000262f0: 655f 6f62 6a20 3d20 7374 6f72 6167 655f  e_obj = storage_
-00026300: 6c69 622e 4942 4d43 6f73 5374 6f72 6528  lib.IBMCosStore(
-00026310: 736f 7572 6365 3d22 222c 206e 616d 653d  source="", name=
-00026320: 746d 705f 6275 636b 6574 5f6e 616d 6529  tmp_bucket_name)
-00026330: 0a20 2020 2020 2020 2079 6965 6c64 2074  .        yield t
-00026340: 6d70 5f62 7563 6b65 745f 6e61 6d65 0a20  mp_bucket_name. 
-00026350: 2020 2020 2020 2073 746f 7261 6765 5f6f         storage_o
-00026360: 626a 2e64 656c 6574 6528 290a 0a20 2020  bj.delete()..   
-00026370: 2040 7079 7465 7374 2e66 6978 7475 7265   @pytest.fixture
-00026380: 0a20 2020 2064 6566 2074 6d70 5f70 7562  .    def tmp_pub
-00026390: 6c69 635f 7374 6f72 6167 655f 6f62 6a28  lic_storage_obj(
-000263a0: 7365 6c66 2c20 7265 7175 6573 7429 3a0a  self, request):.
-000263b0: 2020 2020 2020 2020 2320 496e 6974 6961          # Initia
-000263c0: 6c69 7a65 7320 6120 7374 6f72 6167 6520  lizes a storage 
-000263d0: 6f62 6a65 6374 2077 6974 6820 6120 7075  object with a pu
-000263e0: 626c 6963 2062 7563 6b65 740a 2020 2020  blic bucket.    
-000263f0: 2020 2020 7374 6f72 6167 655f 6f62 6a20      storage_obj 
-00026400: 3d20 7374 6f72 6167 655f 6c69 622e 5374  = storage_lib.St
-00026410: 6f72 6167 6528 736f 7572 6365 3d72 6571  orage(source=req
-00026420: 7565 7374 2e70 6172 616d 290a 2020 2020  uest.param).    
-00026430: 2020 2020 7969 656c 6420 7374 6f72 6167      yield storag
-00026440: 655f 6f62 6a0a 2020 2020 2020 2020 2320  e_obj.        # 
-00026450: 5468 6973 2064 6f65 7320 6e6f 7420 7265  This does not re
-00026460: 7175 6972 6520 616e 7920 6465 6c65 7469  quire any deleti
-00026470: 6f6e 206c 6f67 6963 2062 6563 6175 7365  on logic because
-00026480: 2069 7420 6973 2061 2070 7562 6c69 6320   it is a public 
-00026490: 6275 636b 6574 0a20 2020 2020 2020 2023  bucket.        #
-000264a0: 2061 6e64 2073 686f 756c 6420 6e6f 7420   and should not 
-000264b0: 6765 7420 6164 6465 6420 746f 2067 6c6f  get added to glo
-000264c0: 6261 6c5f 7573 6572 5f73 7461 7465 2e0a  bal_user_state..
-000264d0: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
-000264e0: 6b2e 6e6f 5f66 6c75 6964 7374 6163 6b0a  k.no_fluidstack.
-000264f0: 2020 2020 4070 7974 6573 742e 6d61 726b      @pytest.mark
-00026500: 2e70 6172 616d 6574 7269 7a65 2827 7374  .parametrize('st
-00026510: 6f72 655f 7479 7065 272c 205b 0a20 2020  ore_type', [.   
-00026520: 2020 2020 2073 746f 7261 6765 5f6c 6962       storage_lib
-00026530: 2e53 746f 7265 5479 7065 2e53 332c 2073  .StoreType.S3, s
-00026540: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
-00026550: 5479 7065 2e47 4353 2c0a 2020 2020 2020  Type.GCS,.      
-00026560: 2020 7079 7465 7374 2e70 6172 616d 2873    pytest.param(s
-00026570: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
-00026580: 5479 7065 2e49 424d 2c20 6d61 726b 733d  Type.IBM, marks=
-00026590: 7079 7465 7374 2e6d 6172 6b2e 6962 6d29  pytest.mark.ibm)
-000265a0: 2c0a 2020 2020 2020 2020 7079 7465 7374  ,.        pytest
-000265b0: 2e70 6172 616d 2873 746f 7261 6765 5f6c  .param(storage_l
-000265c0: 6962 2e53 746f 7265 5479 7065 2e52 322c  ib.StoreType.R2,
-000265d0: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
-000265e0: 726b 2e63 6c6f 7564 666c 6172 6529 0a20  rk.cloudflare). 
-000265f0: 2020 205d 290a 2020 2020 6465 6620 7465     ]).    def te
-00026600: 7374 5f6e 6577 5f62 7563 6b65 745f 6372  st_new_bucket_cr
-00026610: 6561 7469 6f6e 5f61 6e64 5f64 656c 6574  eation_and_delet
-00026620: 696f 6e28 7365 6c66 2c20 746d 705f 6c6f  ion(self, tmp_lo
-00026630: 6361 6c5f 7374 6f72 6167 655f 6f62 6a2c  cal_storage_obj,
-00026640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00026650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026660: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00026670: 746f 7265 5f74 7970 6529 3a0a 2020 2020  tore_type):.    
-00026680: 2020 2020 2320 4372 6561 7465 7320 6120      # Creates a 
-00026690: 6e65 7720 6275 636b 6574 2077 6974 6820  new bucket with 
-000266a0: 6120 6c6f 6361 6c20 736f 7572 6365 2c20  a local source, 
-000266b0: 7570 6c6f 6164 7320 6669 6c65 7320 746f  uploads files to
-000266c0: 2069 740a 2020 2020 2020 2020 2320 616e   it.        # an
-000266d0: 6420 6465 6c65 7465 7320 6974 2e0a 2020  d deletes it..  
-000266e0: 2020 2020 2020 746d 705f 6c6f 6361 6c5f        tmp_local_
-000266f0: 7374 6f72 6167 655f 6f62 6a2e 6164 645f  storage_obj.add_
-00026700: 7374 6f72 6528 7374 6f72 655f 7479 7065  store(store_type
-00026710: 290a 0a20 2020 2020 2020 2023 2052 756e  )..        # Run
-00026720: 2073 6b79 2073 746f 7261 6765 206c 7320   sky storage ls 
-00026730: 746f 2063 6865 636b 2069 6620 7374 6f72  to check if stor
-00026740: 6167 6520 6f62 6a65 6374 2065 7869 7374  age object exist
-00026750: 7320 696e 2074 6865 206f 7574 7075 740a  s in the output.
-00026760: 2020 2020 2020 2020 6f75 7420 3d20 7375          out = su
-00026770: 6270 726f 6365 7373 2e63 6865 636b 5f6f  bprocess.check_o
-00026780: 7574 7075 7428 5b27 736b 7927 2c20 2773  utput(['sky', 's
-00026790: 746f 7261 6765 272c 2027 6c73 275d 290a  torage', 'ls']).
-000267a0: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
-000267b0: 6d70 5f6c 6f63 616c 5f73 746f 7261 6765  mp_local_storage
-000267c0: 5f6f 626a 2e6e 616d 6520 696e 206f 7574  _obj.name in out
-000267d0: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
-000267e0: 0a0a 2020 2020 2020 2020 2320 5275 6e20  ..        # Run 
-000267f0: 736b 7920 7374 6f72 6167 6520 6465 6c65  sky storage dele
-00026800: 7465 2074 6f20 6465 6c65 7465 2074 6865  te to delete the
-00026810: 2073 746f 7261 6765 206f 626a 6563 740a   storage object.
-00026820: 2020 2020 2020 2020 7375 6270 726f 6365          subproce
-00026830: 7373 2e63 6865 636b 5f6f 7574 7075 7428  ss.check_output(
-00026840: 0a20 2020 2020 2020 2020 2020 205b 2773  .            ['s
-00026850: 6b79 272c 2027 7374 6f72 6167 6527 2c20  ky', 'storage', 
-00026860: 2764 656c 6574 6527 2c20 746d 705f 6c6f  'delete', tmp_lo
-00026870: 6361 6c5f 7374 6f72 6167 655f 6f62 6a2e  cal_storage_obj.
-00026880: 6e61 6d65 2c20 272d 2d79 6573 275d 290a  name, '--yes']).
-00026890: 0a20 2020 2020 2020 2023 2052 756e 2073  .        # Run s
-000268a0: 6b79 2073 746f 7261 6765 206c 7320 746f  ky storage ls to
-000268b0: 2063 6865 636b 2069 6620 7374 6f72 6167   check if storag
-000268c0: 6520 6f62 6a65 6374 2069 7320 6465 6c65  e object is dele
-000268d0: 7465 640a 2020 2020 2020 2020 6f75 7420  ted.        out 
-000268e0: 3d20 7375 6270 726f 6365 7373 2e63 6865  = subprocess.che
-000268f0: 636b 5f6f 7574 7075 7428 5b27 736b 7927  ck_output(['sky'
-00026900: 2c20 2773 746f 7261 6765 272c 2027 6c73  , 'storage', 'ls
-00026910: 275d 290a 2020 2020 2020 2020 6173 7365  ']).        asse
-00026920: 7274 2074 6d70 5f6c 6f63 616c 5f73 746f  rt tmp_local_sto
-00026930: 7261 6765 5f6f 626a 2e6e 616d 6520 6e6f  rage_obj.name no
-00026940: 7420 696e 206f 7574 2e64 6563 6f64 6528  t in out.decode(
-00026950: 2775 7466 2d38 2729 0a0a 2020 2020 4070  'utf-8')..    @p
-00026960: 7974 6573 742e 6d61 726b 2e6e 6f5f 666c  ytest.mark.no_fl
-00026970: 7569 6473 7461 636b 0a20 2020 2040 7079  uidstack.    @py
-00026980: 7465 7374 2e6d 6172 6b2e 7864 6973 745f  test.mark.xdist_
-00026990: 6772 6f75 7028 276d 756c 7469 706c 655f  group('multiple_
-000269a0: 6275 636b 6574 5f64 656c 6574 696f 6e27  bucket_deletion'
-000269b0: 290a 2020 2020 4070 7974 6573 742e 6d61  ).    @pytest.ma
-000269c0: 726b 2e70 6172 616d 6574 7269 7a65 2827  rk.parametrize('
-000269d0: 7374 6f72 655f 7479 7065 272c 205b 0a20  store_type', [. 
-000269e0: 2020 2020 2020 2073 746f 7261 6765 5f6c         storage_l
-000269f0: 6962 2e53 746f 7265 5479 7065 2e53 332c  ib.StoreType.S3,
-00026a00: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
-00026a10: 7265 5479 7065 2e47 4353 2c0a 2020 2020  reType.GCS,.    
-00026a20: 2020 2020 7079 7465 7374 2e70 6172 616d      pytest.param
-00026a30: 2873 746f 7261 6765 5f6c 6962 2e53 746f  (storage_lib.Sto
-00026a40: 7265 5479 7065 2e52 322c 206d 6172 6b73  reType.R2, marks
-00026a50: 3d70 7974 6573 742e 6d61 726b 2e63 6c6f  =pytest.mark.clo
-00026a60: 7564 666c 6172 6529 2c0a 2020 2020 2020  udflare),.      
-00026a70: 2020 7079 7465 7374 2e70 6172 616d 2873    pytest.param(s
-00026a80: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
-00026a90: 5479 7065 2e49 424d 2c20 6d61 726b 733d  Type.IBM, marks=
-00026aa0: 7079 7465 7374 2e6d 6172 6b2e 6962 6d29  pytest.mark.ibm)
-00026ab0: 0a20 2020 205d 290a 2020 2020 6465 6620  .    ]).    def 
-00026ac0: 7465 7374 5f6d 756c 7469 706c 655f 6275  test_multiple_bu
-00026ad0: 636b 6574 735f 6372 6561 7469 6f6e 5f61  ckets_creation_a
-00026ae0: 6e64 5f64 656c 6574 696f 6e28 0a20 2020  nd_deletion(.   
-00026af0: 2020 2020 2020 2020 2073 656c 662c 2074           self, t
-00026b00: 6d70 5f6d 756c 7469 706c 655f 7363 7261  mp_multiple_scra
-00026b10: 7463 685f 7374 6f72 6167 655f 6f62 6a2c  tch_storage_obj,
-00026b20: 2073 746f 7265 5f74 7970 6529 3a0a 2020   store_type):.  
-00026b30: 2020 2020 2020 2320 4372 6561 7465 7320        # Creates 
-00026b40: 6d75 6c74 6970 6c65 206e 6577 2062 7563  multiple new buc
-00026b50: 6b65 7473 2835 2062 7563 6b65 7473 2920  kets(5 buckets) 
-00026b60: 7769 7468 2061 206c 6f63 616c 2073 6f75  with a local sou
-00026b70: 7263 650a 2020 2020 2020 2020 2320 616e  rce.        # an
-00026b80: 6420 6465 6c65 7465 7320 7468 656d 2e0a  d deletes them..
-00026b90: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
-00026ba0: 6f62 6a5f 6e61 6d65 203d 205b 5d0a 2020  obj_name = [].  
-00026bb0: 2020 2020 2020 666f 7220 7374 6f72 655f        for store_
-00026bc0: 6f62 6a20 696e 2074 6d70 5f6d 756c 7469  obj in tmp_multi
-00026bd0: 706c 655f 7363 7261 7463 685f 7374 6f72  ple_scratch_stor
-00026be0: 6167 655f 6f62 6a3a 0a20 2020 2020 2020  age_obj:.       
-00026bf0: 2020 2020 2073 746f 7265 5f6f 626a 2e61       store_obj.a
-00026c00: 6464 5f73 746f 7265 2873 746f 7265 5f74  dd_store(store_t
-00026c10: 7970 6529 0a20 2020 2020 2020 2020 2020  ype).           
-00026c20: 2073 746f 7261 6765 5f6f 626a 5f6e 616d   storage_obj_nam
-00026c30: 652e 6170 7065 6e64 2873 746f 7265 5f6f  e.append(store_o
-00026c40: 626a 2e6e 616d 6529 0a0a 2020 2020 2020  bj.name)..      
-00026c50: 2020 2320 5275 6e20 736b 7920 7374 6f72    # Run sky stor
-00026c60: 6167 6520 6c73 2074 6f20 6368 6563 6b20  age ls to check 
-00026c70: 6966 2061 6c6c 2073 746f 7261 6765 206f  if all storage o
-00026c80: 626a 6563 7473 2065 7869 7374 7320 696e  bjects exists in
-00026c90: 2074 6865 0a20 2020 2020 2020 2023 206f   the.        # o
-00026ca0: 7574 7075 7420 6669 6c74 6572 6564 2062  utput filtered b
-00026cb0: 7920 7374 6f72 6520 7479 7065 0a20 2020  y store type.   
-00026cc0: 2020 2020 206f 7574 5f61 6c6c 203d 2073       out_all = s
-00026cd0: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
-00026ce0: 6f75 7470 7574 285b 2773 6b79 272c 2027  output(['sky', '
-00026cf0: 7374 6f72 6167 6527 2c20 276c 7327 5d29  storage', 'ls'])
-00026d00: 0a20 2020 2020 2020 206f 7574 203d 205b  .        out = [
-00026d10: 0a20 2020 2020 2020 2020 2020 2069 7465  .            ite
-00026d20: 6d2e 7370 6c69 7428 295b 305d 0a20 2020  m.split()[0].   
-00026d30: 2020 2020 2020 2020 2066 6f72 2069 7465           for ite
-00026d40: 6d20 696e 206f 7574 5f61 6c6c 2e64 6563  m in out_all.dec
-00026d50: 6f64 6528 2775 7466 2d38 2729 2e73 706c  ode('utf-8').spl
-00026d60: 6974 6c69 6e65 7328 290a 2020 2020 2020  itlines().      
-00026d70: 2020 2020 2020 6966 2073 746f 7265 5f74        if store_t
-00026d80: 7970 652e 7661 6c75 6520 696e 2069 7465  ype.value in ite
-00026d90: 6d0a 2020 2020 2020 2020 5d0a 2020 2020  m.        ].    
-00026da0: 2020 2020 6173 7365 7274 2061 6c6c 285b      assert all([
-00026db0: 6974 656d 2069 6e20 6f75 7420 666f 7220  item in out for 
-00026dc0: 6974 656d 2069 6e20 7374 6f72 6167 655f  item in storage_
-00026dd0: 6f62 6a5f 6e61 6d65 5d29 0a0a 2020 2020  obj_name])..    
-00026de0: 2020 2020 2320 5275 6e20 736b 7920 7374      # Run sky st
-00026df0: 6f72 6167 6520 6465 6c65 7465 2061 6c6c  orage delete all
-00026e00: 2074 6f20 6465 6c65 7465 2061 6c6c 2073   to delete all s
-00026e10: 746f 7261 6765 206f 626a 6563 7473 0a20  torage objects. 
-00026e20: 2020 2020 2020 2064 656c 6574 655f 636d         delete_cm
-00026e30: 6420 3d20 5b27 736b 7927 2c20 2773 746f  d = ['sky', 'sto
-00026e40: 7261 6765 272c 2027 6465 6c65 7465 272c  rage', 'delete',
-00026e50: 2027 2d2d 7965 7327 5d0a 2020 2020 2020   '--yes'].      
-00026e60: 2020 6465 6c65 7465 5f63 6d64 202b 3d20    delete_cmd += 
-00026e70: 7374 6f72 6167 655f 6f62 6a5f 6e61 6d65  storage_obj_name
-00026e80: 0a20 2020 2020 2020 2073 7562 7072 6f63  .        subproc
-00026e90: 6573 732e 6368 6563 6b5f 6f75 7470 7574  ess.check_output
-00026ea0: 2864 656c 6574 655f 636d 6429 0a0a 2020  (delete_cmd)..  
-00026eb0: 2020 2020 2020 2320 5275 6e20 736b 7920        # Run sky 
-00026ec0: 7374 6f72 6167 6520 6c73 2074 6f20 6368  storage ls to ch
-00026ed0: 6563 6b20 6966 2061 6c6c 2073 746f 7261  eck if all stora
-00026ee0: 6765 206f 626a 6563 7473 2066 696c 7465  ge objects filte
-00026ef0: 7265 6420 6279 2073 746f 7265 0a20 2020  red by store.   
-00026f00: 2020 2020 2023 2074 7970 6520 6172 6520       # type are 
-00026f10: 6465 6c65 7465 640a 2020 2020 2020 2020  deleted.        
-00026f20: 6f75 745f 616c 6c20 3d20 7375 6270 726f  out_all = subpro
-00026f30: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
-00026f40: 7428 5b27 736b 7927 2c20 2773 746f 7261  t(['sky', 'stora
-00026f50: 6765 272c 2027 6c73 275d 290a 2020 2020  ge', 'ls']).    
-00026f60: 2020 2020 6f75 7420 3d20 5b0a 2020 2020      out = [.    
-00026f70: 2020 2020 2020 2020 6974 656d 2e73 706c          item.spl
-00026f80: 6974 2829 5b30 5d0a 2020 2020 2020 2020  it()[0].        
-00026f90: 2020 2020 666f 7220 6974 656d 2069 6e20      for item in 
-00026fa0: 6f75 745f 616c 6c2e 6465 636f 6465 2827  out_all.decode('
-00026fb0: 7574 662d 3827 292e 7370 6c69 746c 696e  utf-8').splitlin
-00026fc0: 6573 2829 0a20 2020 2020 2020 2020 2020  es().           
-00026fd0: 2069 6620 7374 6f72 655f 7479 7065 2e76   if store_type.v
-00026fe0: 616c 7565 2069 6e20 6974 656d 0a20 2020  alue in item.   
-00026ff0: 2020 2020 205d 0a20 2020 2020 2020 2061       ].        a
-00027000: 7373 6572 7420 616c 6c28 5b69 7465 6d20  ssert all([item 
-00027010: 6e6f 7420 696e 206f 7574 2066 6f72 2069  not in out for i
-00027020: 7465 6d20 696e 2073 746f 7261 6765 5f6f  tem in storage_o
-00027030: 626a 5f6e 616d 655d 290a 0a20 2020 2040  bj_name])..    @
-00027040: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f66  pytest.mark.no_f
-00027050: 6c75 6964 7374 6163 6b0a 2020 2020 4070  luidstack.    @p
-00027060: 7974 6573 742e 6d61 726b 2e70 6172 616d  ytest.mark.param
-00027070: 6574 7269 7a65 2827 7374 6f72 655f 7479  etrize('store_ty
-00027080: 7065 272c 205b 0a20 2020 2020 2020 2073  pe', [.        s
-00027090: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
-000270a0: 5479 7065 2e53 332c 2073 746f 7261 6765  Type.S3, storage
-000270b0: 5f6c 6962 2e53 746f 7265 5479 7065 2e47  _lib.StoreType.G
-000270c0: 4353 2c0a 2020 2020 2020 2020 7079 7465  CS,.        pyte
-000270d0: 7374 2e70 6172 616d 2873 746f 7261 6765  st.param(storage
-000270e0: 5f6c 6962 2e53 746f 7265 5479 7065 2e49  _lib.StoreType.I
-000270f0: 424d 2c20 6d61 726b 733d 7079 7465 7374  BM, marks=pytest
-00027100: 2e6d 6172 6b2e 6962 6d29 2c0a 2020 2020  .mark.ibm),.    
-00027110: 2020 2020 7079 7465 7374 2e70 6172 616d      pytest.param
-00027120: 2873 746f 7261 6765 5f6c 6962 2e53 746f  (storage_lib.Sto
-00027130: 7265 5479 7065 2e52 322c 206d 6172 6b73  reType.R2, marks
-00027140: 3d70 7974 6573 742e 6d61 726b 2e63 6c6f  =pytest.mark.clo
-00027150: 7564 666c 6172 6529 0a20 2020 205d 290a  udflare).    ]).
-00027160: 2020 2020 6465 6620 7465 7374 5f75 706c      def test_upl
-00027170: 6f61 645f 736f 7572 6365 5f77 6974 685f  oad_source_with_
-00027180: 7370 6163 6573 2873 656c 662c 2073 746f  spaces(self, sto
-00027190: 7265 5f74 7970 652c 0a20 2020 2020 2020  re_type,.       
-000271a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000271b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000271c0: 746d 705f 6d75 6c74 6970 6c65 5f63 7573  tmp_multiple_cus
-000271d0: 746f 6d5f 736f 7572 6365 5f73 746f 7261  tom_source_stora
-000271e0: 6765 5f6f 626a 293a 0a20 2020 2020 2020  ge_obj):.       
-000271f0: 2023 2043 7265 6174 6573 2074 776f 2062   # Creates two b
-00027200: 7563 6b65 7473 2077 6974 6820 7370 6563  uckets with spec
-00027210: 6966 6965 6420 6c6f 6361 6c20 736f 7572  ified local sour
-00027220: 6365 730a 2020 2020 2020 2020 2320 7769  ces.        # wi
-00027230: 7468 2073 7061 6365 7320 696e 2074 6865  th spaces in the
-00027240: 206e 616d 650a 2020 2020 2020 2020 7374   name.        st
-00027250: 6f72 6167 655f 6f62 6a5f 6e61 6d65 7320  orage_obj_names 
-00027260: 3d20 5b5d 0a20 2020 2020 2020 2066 6f72  = [].        for
-00027270: 2073 746f 7261 6765 5f6f 626a 2069 6e20   storage_obj in 
-00027280: 746d 705f 6d75 6c74 6970 6c65 5f63 7573  tmp_multiple_cus
-00027290: 746f 6d5f 736f 7572 6365 5f73 746f 7261  tom_source_stora
-000272a0: 6765 5f6f 626a 3a0a 2020 2020 2020 2020  ge_obj:.        
-000272b0: 2020 2020 7374 6f72 6167 655f 6f62 6a2e      storage_obj.
-000272c0: 6164 645f 7374 6f72 6528 7374 6f72 655f  add_store(store_
-000272d0: 7479 7065 290a 2020 2020 2020 2020 2020  type).          
-000272e0: 2020 7374 6f72 6167 655f 6f62 6a5f 6e61    storage_obj_na
-000272f0: 6d65 732e 6170 7065 6e64 2873 746f 7261  mes.append(stora
-00027300: 6765 5f6f 626a 2e6e 616d 6529 0a0a 2020  ge_obj.name)..  
-00027310: 2020 2020 2020 2320 5275 6e20 736b 7920        # Run sky 
-00027320: 7374 6f72 6167 6520 6c73 2074 6f20 6368  storage ls to ch
-00027330: 6563 6b20 6966 2061 6c6c 2073 746f 7261  eck if all stora
-00027340: 6765 206f 626a 6563 7473 2065 7869 7374  ge objects exist
-00027350: 7320 696e 2074 6865 0a20 2020 2020 2020  s in the.       
-00027360: 2023 206f 7574 7075 7420 6669 6c74 6572   # output filter
-00027370: 6564 2062 7920 7374 6f72 6520 7479 7065  ed by store type
-00027380: 0a20 2020 2020 2020 206f 7574 5f61 6c6c  .        out_all
-00027390: 203d 2073 7562 7072 6f63 6573 732e 6368   = subprocess.ch
-000273a0: 6563 6b5f 6f75 7470 7574 285b 2773 6b79  eck_output(['sky
-000273b0: 272c 2027 7374 6f72 6167 6527 2c20 276c  ', 'storage', 'l
-000273c0: 7327 5d29 0a20 2020 2020 2020 206f 7574  s']).        out
-000273d0: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
-000273e0: 2069 7465 6d2e 7370 6c69 7428 295b 305d   item.split()[0]
-000273f0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00027400: 2069 7465 6d20 696e 206f 7574 5f61 6c6c   item in out_all
-00027410: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
-00027420: 2e73 706c 6974 6c69 6e65 7328 290a 2020  .splitlines().  
-00027430: 2020 2020 2020 2020 2020 6966 2073 746f            if sto
-00027440: 7265 5f74 7970 652e 7661 6c75 6520 696e  re_type.value in
-00027450: 2069 7465 6d0a 2020 2020 2020 2020 5d0a   item.        ].
-00027460: 2020 2020 2020 2020 6173 7365 7274 2061          assert a
-00027470: 6c6c 285b 6974 656d 2069 6e20 6f75 7420  ll([item in out 
-00027480: 666f 7220 6974 656d 2069 6e20 7374 6f72  for item in stor
-00027490: 6167 655f 6f62 6a5f 6e61 6d65 735d 290a  age_obj_names]).
-000274a0: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
-000274b0: 6b2e 6e6f 5f66 6c75 6964 7374 6163 6b0a  k.no_fluidstack.
-000274c0: 2020 2020 4070 7974 6573 742e 6d61 726b      @pytest.mark
-000274d0: 2e70 6172 616d 6574 7269 7a65 2827 7374  .parametrize('st
-000274e0: 6f72 655f 7479 7065 272c 205b 0a20 2020  ore_type', [.   
-000274f0: 2020 2020 2073 746f 7261 6765 5f6c 6962       storage_lib
-00027500: 2e53 746f 7265 5479 7065 2e53 332c 2073  .StoreType.S3, s
-00027510: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
-00027520: 5479 7065 2e47 4353 2c0a 2020 2020 2020  Type.GCS,.      
-00027530: 2020 7079 7465 7374 2e70 6172 616d 2873    pytest.param(s
-00027540: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
-00027550: 5479 7065 2e49 424d 2c20 6d61 726b 733d  Type.IBM, marks=
-00027560: 7079 7465 7374 2e6d 6172 6b2e 6962 6d29  pytest.mark.ibm)
-00027570: 2c0a 2020 2020 2020 2020 7079 7465 7374  ,.        pytest
-00027580: 2e70 6172 616d 2873 746f 7261 6765 5f6c  .param(storage_l
-00027590: 6962 2e53 746f 7265 5479 7065 2e52 322c  ib.StoreType.R2,
-000275a0: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
-000275b0: 726b 2e63 6c6f 7564 666c 6172 6529 0a20  rk.cloudflare). 
-000275c0: 2020 205d 290a 2020 2020 6465 6620 7465     ]).    def te
-000275d0: 7374 5f62 7563 6b65 745f 6578 7465 726e  st_bucket_extern
-000275e0: 616c 5f64 656c 6574 696f 6e28 7365 6c66  al_deletion(self
-000275f0: 2c20 746d 705f 7363 7261 7463 685f 7374  , tmp_scratch_st
-00027600: 6f72 6167 655f 6f62 6a2c 0a20 2020 2020  orage_obj,.     
-00027610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027630: 2073 746f 7265 5f74 7970 6529 3a0a 2020   store_type):.  
-00027640: 2020 2020 2020 2320 4372 6561 7465 7320        # Creates 
-00027650: 6120 6275 636b 6574 2c20 6465 6c65 7465  a bucket, delete
-00027660: 7320 6974 2065 7874 6572 6e61 6c6c 7920  s it externally 
-00027670: 7573 696e 6720 636c 6f75 6420 636c 6920  using cloud cli 
-00027680: 636f 6d6d 616e 6473 0a20 2020 2020 2020  commands.       
-00027690: 2023 2061 6e64 2074 6865 6e20 7472 6965   # and then trie
-000276a0: 7320 746f 2064 656c 6574 6520 6974 2075  s to delete it u
-000276b0: 7369 6e67 2073 6b79 2073 746f 7261 6765  sing sky storage
-000276c0: 2064 656c 6574 652e 0a20 2020 2020 2020   delete..       
-000276d0: 2074 6d70 5f73 6372 6174 6368 5f73 746f   tmp_scratch_sto
-000276e0: 7261 6765 5f6f 626a 2e61 6464 5f73 746f  rage_obj.add_sto
-000276f0: 7265 2873 746f 7265 5f74 7970 6529 0a0a  re(store_type)..
-00027700: 2020 2020 2020 2020 2320 5275 6e20 736b          # Run sk
-00027710: 7920 7374 6f72 6167 6520 6c73 2074 6f20  y storage ls to 
-00027720: 6368 6563 6b20 6966 2073 746f 7261 6765  check if storage
-00027730: 206f 626a 6563 7420 6578 6973 7473 2069   object exists i
-00027740: 6e20 7468 6520 6f75 7470 7574 0a20 2020  n the output.   
-00027750: 2020 2020 206f 7574 203d 2073 7562 7072       out = subpr
-00027760: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
-00027770: 7574 285b 2773 6b79 272c 2027 7374 6f72  ut(['sky', 'stor
-00027780: 6167 6527 2c20 276c 7327 5d29 0a20 2020  age', 'ls']).   
-00027790: 2020 2020 2061 7373 6572 7420 746d 705f       assert tmp_
-000277a0: 7363 7261 7463 685f 7374 6f72 6167 655f  scratch_storage_
-000277b0: 6f62 6a2e 6e61 6d65 2069 6e20 6f75 742e  obj.name in out.
-000277c0: 6465 636f 6465 2827 7574 662d 3827 290a  decode('utf-8').
-000277d0: 0a20 2020 2020 2020 2023 2044 656c 6574  .        # Delet
-000277e0: 6520 6275 636b 6574 2065 7874 6572 6e61  e bucket externa
-000277f0: 6c6c 790a 2020 2020 2020 2020 636d 6420  lly.        cmd 
-00027800: 3d20 7365 6c66 2e63 6c69 5f64 656c 6574  = self.cli_delet
-00027810: 655f 636d 6428 7374 6f72 655f 7479 7065  e_cmd(store_type
-00027820: 2c20 746d 705f 7363 7261 7463 685f 7374  , tmp_scratch_st
-00027830: 6f72 6167 655f 6f62 6a2e 6e61 6d65 290a  orage_obj.name).
-00027840: 2020 2020 2020 2020 7375 6270 726f 6365          subproce
-00027850: 7373 2e63 6865 636b 5f6f 7574 7075 7428  ss.check_output(
-00027860: 636d 642c 2073 6865 6c6c 3d54 7275 6529  cmd, shell=True)
-00027870: 0a0a 2020 2020 2020 2020 2320 5275 6e20  ..        # Run 
-00027880: 736b 7920 7374 6f72 6167 6520 6465 6c65  sky storage dele
-00027890: 7465 2074 6f20 6465 6c65 7465 2074 6865  te to delete the
-000278a0: 2073 746f 7261 6765 206f 626a 6563 740a   storage object.
-000278b0: 2020 2020 2020 2020 6f75 7420 3d20 7375          out = su
-000278c0: 6270 726f 6365 7373 2e63 6865 636b 5f6f  bprocess.check_o
-000278d0: 7574 7075 7428 0a20 2020 2020 2020 2020  utput(.         
-000278e0: 2020 205b 2773 6b79 272c 2027 7374 6f72     ['sky', 'stor
-000278f0: 6167 6527 2c20 2764 656c 6574 6527 2c20  age', 'delete', 
-00027900: 746d 705f 7363 7261 7463 685f 7374 6f72  tmp_scratch_stor
-00027910: 6167 655f 6f62 6a2e 6e61 6d65 2c20 272d  age_obj.name, '-
-00027920: 2d79 6573 275d 290a 2020 2020 2020 2020  -yes']).        
-00027930: 2320 4d61 6b65 2073 7572 6520 6275 636b  # Make sure buck
-00027940: 6574 2077 6173 206e 6f74 2063 7265 6174  et was not creat
-00027950: 6564 2064 7572 696e 6720 6465 6c65 7469  ed during deleti
-00027960: 6f6e 2028 7365 6520 6973 7375 6520 2331  on (see issue #1
-00027970: 3332 3229 0a20 2020 2020 2020 2061 7373  322).        ass
-00027980: 6572 7420 2763 7265 6174 6564 2720 6e6f  ert 'created' no
-00027990: 7420 696e 206f 7574 2e64 6563 6f64 6528  t in out.decode(
-000279a0: 2775 7466 2d38 2729 2e6c 6f77 6572 2829  'utf-8').lower()
-000279b0: 0a0a 2020 2020 2020 2020 2320 5275 6e20  ..        # Run 
-000279c0: 736b 7920 7374 6f72 6167 6520 6c73 2074  sky storage ls t
-000279d0: 6f20 6368 6563 6b20 6966 2073 746f 7261  o check if stora
-000279e0: 6765 206f 626a 6563 7420 6973 2064 656c  ge object is del
-000279f0: 6574 6564 0a20 2020 2020 2020 206f 7574  eted.        out
-00027a00: 203d 2073 7562 7072 6f63 6573 732e 6368   = subprocess.ch
-00027a10: 6563 6b5f 6f75 7470 7574 285b 2773 6b79  eck_output(['sky
-00027a20: 272c 2027 7374 6f72 6167 6527 2c20 276c  ', 'storage', 'l
-00027a30: 7327 5d29 0a20 2020 2020 2020 2061 7373  s']).        ass
-00027a40: 6572 7420 746d 705f 7363 7261 7463 685f  ert tmp_scratch_
-00027a50: 7374 6f72 6167 655f 6f62 6a2e 6e61 6d65  storage_obj.name
-00027a60: 206e 6f74 2069 6e20 6f75 742e 6465 636f   not in out.deco
-00027a70: 6465 2827 7574 662d 3827 290a 0a20 2020  de('utf-8')..   
-00027a80: 2040 7079 7465 7374 2e6d 6172 6b2e 6e6f   @pytest.mark.no
-00027a90: 5f66 6c75 6964 7374 6163 6b0a 2020 2020  _fluidstack.    
-00027aa0: 4070 7974 6573 742e 6d61 726b 2e70 6172  @pytest.mark.par
-00027ab0: 616d 6574 7269 7a65 2827 7374 6f72 655f  ametrize('store_
-00027ac0: 7479 7065 272c 205b 0a20 2020 2020 2020  type', [.       
-00027ad0: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
-00027ae0: 7265 5479 7065 2e53 332c 2073 746f 7261  reType.S3, stora
-00027af0: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
-00027b00: 2e47 4353 2c0a 2020 2020 2020 2020 7079  .GCS,.        py
-00027b10: 7465 7374 2e70 6172 616d 2873 746f 7261  test.param(stora
-00027b20: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
-00027b30: 2e49 424d 2c20 6d61 726b 733d 7079 7465  .IBM, marks=pyte
-00027b40: 7374 2e6d 6172 6b2e 6962 6d29 2c0a 2020  st.mark.ibm),.  
-00027b50: 2020 2020 2020 7079 7465 7374 2e70 6172        pytest.par
-00027b60: 616d 2873 746f 7261 6765 5f6c 6962 2e53  am(storage_lib.S
-00027b70: 746f 7265 5479 7065 2e52 322c 206d 6172  toreType.R2, mar
-00027b80: 6b73 3d70 7974 6573 742e 6d61 726b 2e63  ks=pytest.mark.c
-00027b90: 6c6f 7564 666c 6172 6529 0a20 2020 205d  loudflare).    ]
-00027ba0: 290a 2020 2020 6465 6620 7465 7374 5f62  ).    def test_b
-00027bb0: 7563 6b65 745f 6275 6c6b 5f64 656c 6574  ucket_bulk_delet
-00027bc0: 696f 6e28 7365 6c66 2c20 7374 6f72 655f  ion(self, store_
-00027bd0: 7479 7065 2c20 746d 705f 6275 6c6b 5f64  type, tmp_bulk_d
-00027be0: 656c 5f73 746f 7261 6765 5f6f 626a 293a  el_storage_obj):
-00027bf0: 0a20 2020 2020 2020 2023 2043 7265 6174  .        # Creat
-00027c00: 6573 2061 2074 656d 7020 666f 6c64 6572  es a temp folder
-00027c10: 2077 6974 6820 6f76 6572 2032 3536 2066   with over 256 f
-00027c20: 696c 6573 2061 6e64 2066 6f6c 6465 7273  iles and folders
-00027c30: 2c20 7570 6c6f 6164 0a20 2020 2020 2020  , upload.       
-00027c40: 2023 2066 696c 6573 2061 6e64 2066 6f6c   # files and fol
-00027c50: 6465 7273 2074 6f20 6120 6e65 7720 6275  ders to a new bu
-00027c60: 636b 6574 2c20 7468 656e 2064 656c 6574  cket, then delet
-00027c70: 6520 6275 636b 6574 2e0a 2020 2020 2020  e bucket..      
-00027c80: 2020 746d 705f 6275 6c6b 5f64 656c 5f73    tmp_bulk_del_s
-00027c90: 746f 7261 6765 5f6f 626a 2e61 6464 5f73  torage_obj.add_s
-00027ca0: 746f 7265 2873 746f 7265 5f74 7970 6529  tore(store_type)
-00027cb0: 0a0a 2020 2020 2020 2020 7375 6270 726f  ..        subpro
-00027cc0: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
-00027cd0: 7428 5b0a 2020 2020 2020 2020 2020 2020  t([.            
-00027ce0: 2773 6b79 272c 2027 7374 6f72 6167 6527  'sky', 'storage'
-00027cf0: 2c20 2764 656c 6574 6527 2c20 746d 705f  , 'delete', tmp_
-00027d00: 6275 6c6b 5f64 656c 5f73 746f 7261 6765  bulk_del_storage
-00027d10: 5f6f 626a 2e6e 616d 652c 2027 2d2d 7965  _obj.name, '--ye
-00027d20: 7327 0a20 2020 2020 2020 205d 290a 0a20  s'.        ]).. 
-00027d30: 2020 2020 2020 206f 7574 7075 7420 3d20         output = 
-00027d40: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
-00027d50: 5f6f 7574 7075 7428 5b27 736b 7927 2c20  _output(['sky', 
-00027d60: 2773 746f 7261 6765 272c 2027 6c73 275d  'storage', 'ls']
-00027d70: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
-00027d80: 2074 6d70 5f62 756c 6b5f 6465 6c5f 7374   tmp_bulk_del_st
-00027d90: 6f72 6167 655f 6f62 6a2e 6e61 6d65 206e  orage_obj.name n
-00027da0: 6f74 2069 6e20 6f75 7470 7574 2e64 6563  ot in output.dec
-00027db0: 6f64 6528 2775 7466 2d38 2729 0a0a 2020  ode('utf-8')..  
-00027dc0: 2020 4070 7974 6573 742e 6d61 726b 2e6e    @pytest.mark.n
-00027dd0: 6f5f 666c 7569 6473 7461 636b 0a20 2020  o_fluidstack.   
-00027de0: 2040 7079 7465 7374 2e6d 6172 6b2e 7061   @pytest.mark.pa
-00027df0: 7261 6d65 7472 697a 6528 0a20 2020 2020  rametrize(.     
-00027e00: 2020 2027 746d 705f 7075 626c 6963 5f73     'tmp_public_s
-00027e10: 746f 7261 6765 5f6f 626a 2c20 7374 6f72  torage_obj, stor
-00027e20: 655f 7479 7065 272c 0a20 2020 2020 2020  e_type',.       
-00027e30: 205b 2827 7333 3a2f 2f74 6367 612d 322d   [('s3://tcga-2-
-00027e40: 6f70 656e 272c 2073 746f 7261 6765 5f6c  open', storage_l
-00027e50: 6962 2e53 746f 7265 5479 7065 2e53 3329  ib.StoreType.S3)
-00027e60: 2c0a 2020 2020 2020 2020 2028 2773 333a  ,.         ('s3:
-00027e70: 2f2f 6469 6769 7461 6c63 6f72 706f 7261  //digitalcorpora
-00027e80: 272c 2073 746f 7261 6765 5f6c 6962 2e53  ', storage_lib.S
-00027e90: 746f 7265 5479 7065 2e53 3329 2c0a 2020  toreType.S3),.  
-00027ea0: 2020 2020 2020 2028 2767 733a 2f2f 6763         ('gs://gc
-00027eb0: 702d 7075 626c 6963 2d64 6174 612d 7365  p-public-data-se
-00027ec0: 6e74 696e 656c 2d32 272c 2073 746f 7261  ntinel-2', stora
-00027ed0: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
-00027ee0: 2e47 4353 295d 2c0a 2020 2020 2020 2020  .GCS)],.        
-00027ef0: 696e 6469 7265 6374 3d5b 2774 6d70 5f70  indirect=['tmp_p
-00027f00: 7562 6c69 635f 7374 6f72 6167 655f 6f62  ublic_storage_ob
-00027f10: 6a27 5d29 0a20 2020 2064 6566 2074 6573  j']).    def tes
-00027f20: 745f 7075 626c 6963 5f62 7563 6b65 7428  t_public_bucket(
-00027f30: 7365 6c66 2c20 746d 705f 7075 626c 6963  self, tmp_public
-00027f40: 5f73 746f 7261 6765 5f6f 626a 2c20 7374  _storage_obj, st
-00027f50: 6f72 655f 7479 7065 293a 0a20 2020 2020  ore_type):.     
-00027f60: 2020 2023 2043 7265 6174 6573 2061 206e     # Creates a n
-00027f70: 6577 2062 7563 6b65 7420 7769 7468 2061  ew bucket with a
-00027f80: 2070 7562 6c69 6320 736f 7572 6365 2061   public source a
-00027f90: 6e64 2076 6572 6966 6965 7320 7468 6174  nd verifies that
-00027fa0: 2069 7420 6973 206e 6f74 0a20 2020 2020   it is not.     
-00027fb0: 2020 2023 2061 6464 6564 2074 6f20 676c     # added to gl
-00027fc0: 6f62 616c 5f75 7365 725f 7374 6174 652e  obal_user_state.
-00027fd0: 0a20 2020 2020 2020 2074 6d70 5f70 7562  .        tmp_pub
-00027fe0: 6c69 635f 7374 6f72 6167 655f 6f62 6a2e  lic_storage_obj.
-00027ff0: 6164 645f 7374 6f72 6528 7374 6f72 655f  add_store(store_
-00028000: 7479 7065 290a 0a20 2020 2020 2020 2023  type)..        #
-00028010: 2052 756e 2073 6b79 2073 746f 7261 6765   Run sky storage
-00028020: 206c 7320 746f 2063 6865 636b 2069 6620   ls to check if 
-00028030: 7374 6f72 6167 6520 6f62 6a65 6374 2065  storage object e
-00028040: 7869 7374 7320 696e 2074 6865 206f 7574  xists in the out
-00028050: 7075 740a 2020 2020 2020 2020 6f75 7420  put.        out 
-00028060: 3d20 7375 6270 726f 6365 7373 2e63 6865  = subprocess.che
-00028070: 636b 5f6f 7574 7075 7428 5b27 736b 7927  ck_output(['sky'
-00028080: 2c20 2773 746f 7261 6765 272c 2027 6c73  , 'storage', 'ls
-00028090: 275d 290a 2020 2020 2020 2020 6173 7365  ']).        asse
-000280a0: 7274 2074 6d70 5f70 7562 6c69 635f 7374  rt tmp_public_st
-000280b0: 6f72 6167 655f 6f62 6a2e 6e61 6d65 206e  orage_obj.name n
-000280c0: 6f74 2069 6e20 6f75 742e 6465 636f 6465  ot in out.decode
-000280d0: 2827 7574 662d 3827 290a 0a20 2020 2040  ('utf-8')..    @
-000280e0: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f66  pytest.mark.no_f
-000280f0: 6c75 6964 7374 6163 6b0a 2020 2020 4070  luidstack.    @p
-00028100: 7974 6573 742e 6d61 726b 2e70 6172 616d  ytest.mark.param
-00028110: 6574 7269 7a65 2827 6e6f 6e65 7869 7374  etrize('nonexist
-00028120: 5f62 7563 6b65 745f 7572 6c27 2c20 5b0a  _bucket_url', [.
-00028130: 2020 2020 2020 2020 2773 333a 2f2f 7b72          's3://{r
-00028140: 616e 646f 6d5f 6e61 6d65 7d27 2c20 2767  andom_name}', 'g
-00028150: 733a 2f2f 7b72 616e 646f 6d5f 6e61 6d65  s://{random_name
-00028160: 7d27 2c0a 2020 2020 2020 2020 7079 7465  }',.        pyte
-00028170: 7374 2e70 6172 616d 2827 636f 733a 2f2f  st.param('cos://
-00028180: 7573 2d65 6173 742f 7b72 616e 646f 6d5f  us-east/{random_
-00028190: 6e61 6d65 7d27 2c20 6d61 726b 733d 7079  name}', marks=py
-000281a0: 7465 7374 2e6d 6172 6b2e 6962 6d29 2c0a  test.mark.ibm),.
-000281b0: 2020 2020 2020 2020 7079 7465 7374 2e70          pytest.p
-000281c0: 6172 616d 2827 7232 3a2f 2f7b 7261 6e64  aram('r2://{rand
-000281d0: 6f6d 5f6e 616d 657d 272c 206d 6172 6b73  om_name}', marks
-000281e0: 3d70 7974 6573 742e 6d61 726b 2e63 6c6f  =pytest.mark.clo
-000281f0: 7564 666c 6172 6529 0a20 2020 205d 290a  udflare).    ]).
-00028200: 2020 2020 6465 6620 7465 7374 5f6e 6f6e      def test_non
-00028210: 6578 6973 7465 6e74 5f62 7563 6b65 7428  existent_bucket(
-00028220: 7365 6c66 2c20 6e6f 6e65 7869 7374 5f62  self, nonexist_b
-00028230: 7563 6b65 745f 7572 6c29 3a0a 2020 2020  ucket_url):.    
-00028240: 2020 2020 2320 4174 7465 6d70 7473 2074      # Attempts t
-00028250: 6f20 6372 6561 7465 2066 6574 6368 2061  o create fetch a
-00028260: 2073 7472 6f61 6765 2077 6974 6820 6120   stroage with a 
-00028270: 6e6f 6e2d 6578 6973 7465 6e74 2073 6f75  non-existent sou
-00028280: 7263 652e 0a20 2020 2020 2020 2023 2047  rce..        # G
-00028290: 656e 6572 6174 6520 6120 7261 6e64 6f6d  enerate a random
-000282a0: 2062 7563 6b65 7420 6e61 6d65 2061 6e64   bucket name and
-000282b0: 2076 6572 6966 7920 6974 2064 6f65 736e   verify it doesn
-000282c0: 2774 2065 7869 7374 3a0a 2020 2020 2020  't exist:.      
-000282d0: 2020 7265 7472 795f 636f 756e 7420 3d20    retry_count = 
-000282e0: 300a 2020 2020 2020 2020 7768 696c 6520  0.        while 
-000282f0: 5472 7565 3a0a 2020 2020 2020 2020 2020  True:.          
-00028300: 2020 6e6f 6e65 7869 7374 5f62 7563 6b65    nonexist_bucke
-00028310: 745f 6e61 6d65 203d 2073 7472 2875 7569  t_name = str(uui
-00028320: 642e 7575 6964 3428 2929 0a20 2020 2020  d.uuid4()).     
-00028330: 2020 2020 2020 2069 6620 6e6f 6e65 7869         if nonexi
-00028340: 7374 5f62 7563 6b65 745f 7572 6c2e 7374  st_bucket_url.st
-00028350: 6172 7473 7769 7468 2827 7333 2729 3a0a  artswith('s3'):.
-00028360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028370: 636f 6d6d 616e 6420 3d20 6627 6177 7320  command = f'aws 
-00028380: 7333 6170 6920 6865 6164 2d62 7563 6b65  s3api head-bucke
-00028390: 7420 2d2d 6275 636b 6574 207b 6e6f 6e65  t --bucket {none
-000283a0: 7869 7374 5f62 7563 6b65 745f 6e61 6d65  xist_bucket_name
-000283b0: 7d27 0a20 2020 2020 2020 2020 2020 2020  }'.             
-000283c0: 2020 2065 7870 6563 7465 645f 6f75 7470     expected_outp
-000283d0: 7574 203d 2027 3430 3427 0a20 2020 2020  ut = '404'.     
-000283e0: 2020 2020 2020 2065 6c69 6620 6e6f 6e65         elif none
-000283f0: 7869 7374 5f62 7563 6b65 745f 7572 6c2e  xist_bucket_url.
-00028400: 7374 6172 7473 7769 7468 2827 6773 2729  startswith('gs')
-00028410: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00028420: 2020 636f 6d6d 616e 6420 3d20 6627 6773    command = f'gs
-00028430: 7574 696c 206c 7320 7b6e 6f6e 6578 6973  util ls {nonexis
-00028440: 745f 6275 636b 6574 5f75 726c 2e66 6f72  t_bucket_url.for
-00028450: 6d61 7428 7261 6e64 6f6d 5f6e 616d 653d  mat(random_name=
-00028460: 6e6f 6e65 7869 7374 5f62 7563 6b65 745f  nonexist_bucket_
-00028470: 6e61 6d65 297d 270a 2020 2020 2020 2020  name)}'.        
-00028480: 2020 2020 2020 2020 6578 7065 6374 6564          expected
-00028490: 5f6f 7574 7075 7420 3d20 2742 7563 6b65  _output = 'Bucke
-000284a0: 744e 6f74 466f 756e 6445 7863 6570 7469  tNotFoundExcepti
-000284b0: 6f6e 270a 2020 2020 2020 2020 2020 2020  on'.            
-000284c0: 656c 6966 206e 6f6e 6578 6973 745f 6275  elif nonexist_bu
-000284d0: 636b 6574 5f75 726c 2e73 7461 7274 7377  cket_url.startsw
-000284e0: 6974 6828 2772 3227 293a 0a20 2020 2020  ith('r2'):.     
-000284f0: 2020 2020 2020 2020 2020 2065 6e64 706f             endpo
-00028500: 696e 745f 7572 6c20 3d20 636c 6f75 6466  int_url = cloudf
-00028510: 6c61 7265 2e63 7265 6174 655f 656e 6470  lare.create_endp
-00028520: 6f69 6e74 2829 0a20 2020 2020 2020 2020  oint().         
-00028530: 2020 2020 2020 2063 6f6d 6d61 6e64 203d         command =
-00028540: 2066 2741 5753 5f53 4841 5245 445f 4352   f'AWS_SHARED_CR
-00028550: 4544 454e 5449 414c 535f 4649 4c45 3d7b  EDENTIALS_FILE={
-00028560: 636c 6f75 6466 6c61 7265 2e52 325f 4352  cloudflare.R2_CR
-00028570: 4544 454e 5449 414c 535f 5041 5448 7d20  EDENTIALS_PATH} 
-00028580: 6177 7320 7333 6170 6920 6865 6164 2d62  aws s3api head-b
-00028590: 7563 6b65 7420 2d2d 6275 636b 6574 207b  ucket --bucket {
-000285a0: 6e6f 6e65 7869 7374 5f62 7563 6b65 745f  nonexist_bucket_
-000285b0: 6e61 6d65 7d20 2d2d 656e 6470 6f69 6e74  name} --endpoint
-000285c0: 207b 656e 6470 6f69 6e74 5f75 726c 7d20   {endpoint_url} 
-000285d0: 2d2d 7072 6f66 696c 653d 7232 270a 2020  --profile=r2'.  
-000285e0: 2020 2020 2020 2020 2020 2020 2020 6578                ex
-000285f0: 7065 6374 6564 5f6f 7574 7075 7420 3d20  pected_output = 
-00028600: 2734 3034 270a 2020 2020 2020 2020 2020  '404'.          
-00028610: 2020 656c 6966 206e 6f6e 6578 6973 745f    elif nonexist_
-00028620: 6275 636b 6574 5f75 726c 2e73 7461 7274  bucket_url.start
-00028630: 7377 6974 6828 2763 6f73 2729 3a0a 2020  swith('cos'):.  
-00028640: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00028650: 5573 696e 6720 4150 4920 6361 6c6c 732c  Using API calls,
-00028660: 2073 696e 6365 2075 7369 6e67 2072 636c   since using rcl
-00028670: 6f6e 6520 7265 7175 6972 6573 2061 2070  one requires a p
-00028680: 726f 6669 6c65 2773 206e 616d 650a 2020  rofile's name.  
-00028690: 2020 2020 2020 2020 2020 2020 2020 7472                tr
-000286a0: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-000286b0: 2020 2020 2020 2065 7870 6563 7465 645f         expected_
-000286c0: 6f75 7470 7574 203d 2063 6f6d 6d61 6e64  output = command
-000286d0: 203d 2022 6563 686f 2220 2023 2061 766f   = "echo"  # avo
-000286e0: 6964 2075 6e72 656c 6174 6564 2065 7863  id unrelated exc
-000286f0: 6570 7469 6f6e 2069 6e20 6361 7365 206f  eption in case o
-00028700: 6620 6661 696c 7572 652e 0a20 2020 2020  f failure..     
-00028710: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-00028720: 7563 6b65 745f 6e61 6d65 203d 2075 726c  ucket_name = url
-00028730: 6c69 622e 7061 7273 652e 7572 6c73 706c  lib.parse.urlspl
-00028740: 6974 280a 2020 2020 2020 2020 2020 2020  it(.            
-00028750: 2020 2020 2020 2020 2020 2020 6e6f 6e65              none
-00028760: 7869 7374 5f62 7563 6b65 745f 7572 6c2e  xist_bucket_url.
-00028770: 666f 726d 6174 280a 2020 2020 2020 2020  format(.        
-00028780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028790: 2020 2020 7261 6e64 6f6d 5f6e 616d 653d      random_name=
-000287a0: 6e6f 6e65 7869 7374 5f62 7563 6b65 745f  nonexist_bucket_
-000287b0: 6e61 6d65 2929 2e70 6174 682e 7374 7269  name)).path.stri
-000287c0: 7028 272f 2729 0a20 2020 2020 2020 2020  p('/').         
-000287d0: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
-000287e0: 7420 3d20 6962 6d2e 6765 745f 636f 735f  t = ibm.get_cos_
-000287f0: 636c 6965 6e74 2827 7573 2d65 6173 7427  client('us-east'
-00028800: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00028810: 2020 2020 2020 636c 6965 6e74 2e68 6561        client.hea
-00028820: 645f 6275 636b 6574 2842 7563 6b65 743d  d_bucket(Bucket=
-00028830: 6275 636b 6574 5f6e 616d 6529 0a20 2020  bucket_name).   
-00028840: 2020 2020 2020 2020 2020 2020 2065 7863               exc
-00028850: 6570 7420 6962 6d2e 6962 6d5f 626f 746f  ept ibm.ibm_boto
-00028860: 636f 7265 2e65 7863 6570 7469 6f6e 732e  core.exceptions.
-00028870: 436c 6965 6e74 4572 726f 7220 6173 2065  ClientError as e
-00028880: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00028890: 2020 2020 2020 6966 2065 2e72 6573 706f        if e.respo
-000288a0: 6e73 655b 2745 7272 6f72 275d 5b27 436f  nse['Error']['Co
-000288b0: 6465 275d 203d 3d20 2734 3034 273a 0a20  de'] == '404':. 
-000288c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000288d0: 2020 2020 2020 2023 2073 7563 6365 7373         # success
-000288e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000288f0: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
-00028900: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00028910: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00028920: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
-00028930: 6f72 2827 556e 7375 7070 6f72 7465 6420  or('Unsupported 
-00028940: 6275 636b 6574 2074 7970 6520 270a 2020  bucket type '.  
-00028950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028960: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00028970: 277b 6e6f 6e65 7869 7374 5f62 7563 6b65  '{nonexist_bucke
-00028980: 745f 7572 6c7d 2729 0a0a 2020 2020 2020  t_url}')..      
-00028990: 2020 2020 2020 2320 4368 6563 6b20 6966        # Check if
-000289a0: 2062 7563 6b65 7420 6578 6973 7473 2075   bucket exists u
-000289b0: 7369 6e67 2074 6865 2063 6c69 3a0a 2020  sing the cli:.  
-000289c0: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-000289d0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-000289e0: 7574 203d 2073 7562 7072 6f63 6573 732e  ut = subprocess.
-000289f0: 6368 6563 6b5f 6f75 7470 7574 2863 6f6d  check_output(com
-00028a00: 6d61 6e64 2c0a 2020 2020 2020 2020 2020  mand,.          
-00028a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028a30: 2020 2020 7374 6465 7272 3d73 7562 7072      stderr=subpr
-00028a40: 6f63 6573 732e 5354 444f 5554 2c0a 2020  ocess.STDOUT,.  
-00028a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028a70: 2020 2020 2020 2020 2020 2020 7368 656c              shel
-00028a80: 6c3d 5472 7565 290a 2020 2020 2020 2020  l=True).        
-00028a90: 2020 2020 6578 6365 7074 2073 7562 7072      except subpr
-00028aa0: 6f63 6573 732e 4361 6c6c 6564 5072 6f63  ocess.CalledProc
-00028ab0: 6573 7345 7272 6f72 2061 7320 653a 0a20  essError as e:. 
-00028ac0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-00028ad0: 7574 203d 2065 2e6f 7574 7075 740a 2020  ut = e.output.  
-00028ae0: 2020 2020 2020 2020 2020 6f75 7420 3d20            out = 
-00028af0: 6f75 742e 6465 636f 6465 2827 7574 662d  out.decode('utf-
-00028b00: 3827 290a 2020 2020 2020 2020 2020 2020  8').            
-00028b10: 6966 2065 7870 6563 7465 645f 6f75 7470  if expected_outp
-00028b20: 7574 2069 6e20 6f75 743a 0a20 2020 2020  ut in out:.     
-00028b30: 2020 2020 2020 2020 2020 2062 7265 616b             break
-00028b40: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00028b50: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00028b60: 2020 2072 6574 7279 5f63 6f75 6e74 202b     retry_count +
-00028b70: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
-00028b80: 2020 2020 6966 2072 6574 7279 5f63 6f75      if retry_cou
-00028b90: 6e74 203e 2033 3a0a 2020 2020 2020 2020  nt > 3:.        
-00028ba0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00028bb0: 6520 5275 6e74 696d 6545 7272 6f72 2827  e RuntimeError('
-00028bc0: 556e 6162 6c65 2074 6f20 6669 6e64 2061  Unable to find a
-00028bd0: 206e 6f6e 6578 6973 7465 6e74 2062 7563   nonexistent buc
-00028be0: 6b65 7420 270a 2020 2020 2020 2020 2020  ket '.          
-00028bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028c00: 2020 2020 2020 2020 2020 2020 2027 746f               'to
-00028c10: 2075 7365 2e20 5468 6973 2069 7320 6869   use. This is hi
-00028c20: 676c 7920 756e 6c69 6b65 6c79 202d 2027  gly unlikely - '
-00028c30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00028c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028c50: 2020 2020 2020 2020 2763 6865 636b 2069          'check i
-00028c60: 6620 7468 6520 7465 7374 7320 6172 6520  f the tests are 
-00028c70: 636f 7272 6563 742e 2729 0a0a 2020 2020  correct.')..    
-00028c80: 2020 2020 7769 7468 2070 7974 6573 742e      with pytest.
-00028c90: 7261 6973 6573 280a 2020 2020 2020 2020  raises(.        
-00028ca0: 2020 2020 2020 2020 736b 792e 6578 6365          sky.exce
-00028cb0: 7074 696f 6e73 2e53 746f 7261 6765 4275  ptions.StorageBu
-00028cc0: 636b 6574 4765 7445 7272 6f72 2c0a 2020  cketGetError,.  
-00028cd0: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
-00028ce0: 7463 683d 2741 7474 656d 7074 6564 2074  tch='Attempted t
-00028cf0: 6f20 7573 6520 6120 6e6f 6e2d 6578 6973  o use a non-exis
-00028d00: 7465 6e74 2062 7563 6b65 7420 6173 2061  tent bucket as a
-00028d10: 2073 6f75 7263 6527 293a 0a20 2020 2020   source'):.     
-00028d20: 2020 2020 2020 2073 746f 7261 6765 5f6f         storage_o
-00028d30: 626a 203d 2073 746f 7261 6765 5f6c 6962  bj = storage_lib
-00028d40: 2e53 746f 7261 6765 2873 6f75 7263 653d  .Storage(source=
-00028d50: 6e6f 6e65 7869 7374 5f62 7563 6b65 745f  nonexist_bucket_
-00028d60: 7572 6c2e 666f 726d 6174 280a 2020 2020  url.format(.    
-00028d70: 2020 2020 2020 2020 2020 2020 7261 6e64              rand
-00028d80: 6f6d 5f6e 616d 653d 6e6f 6e65 7869 7374  om_name=nonexist
-00028d90: 5f62 7563 6b65 745f 6e61 6d65 2929 0a0a  _bucket_name))..
-00028da0: 2020 2020 4070 7974 6573 742e 6d61 726b      @pytest.mark
-00028db0: 2e6e 6f5f 666c 7569 6473 7461 636b 0a20  .no_fluidstack. 
-00028dc0: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
-00028dd0: 7061 7261 6d65 7472 697a 6528 2770 7269  parametrize('pri
-00028de0: 7661 7465 5f62 7563 6b65 7427 2c20 5b0a  vate_bucket', [.
-00028df0: 2020 2020 2020 2020 6627 7333 3a2f 2f69          f's3://i
-00028e00: 6d61 6765 6e65 7427 2c20 6627 6773 3a2f  magenet', f'gs:/
-00028e10: 2f69 6d61 6765 6e65 7427 2c0a 2020 2020  /imagenet',.    
-00028e20: 2020 2020 7079 7465 7374 2e70 6172 616d      pytest.param
-00028e30: 2827 636f 733a 2f2f 7573 2d65 6173 742f  ('cos://us-east/
-00028e40: 6275 636b 6574 3127 2c20 6d61 726b 733d  bucket1', marks=
-00028e50: 7079 7465 7374 2e6d 6172 6b2e 6962 6d29  pytest.mark.ibm)
-00028e60: 0a20 2020 205d 290a 2020 2020 6465 6620  .    ]).    def 
-00028e70: 7465 7374 5f70 7269 7661 7465 5f62 7563  test_private_buc
-00028e80: 6b65 7428 7365 6c66 2c20 7072 6976 6174  ket(self, privat
-00028e90: 655f 6275 636b 6574 293a 0a20 2020 2020  e_bucket):.     
-00028ea0: 2020 2023 2041 7474 656d 7074 7320 746f     # Attempts to
-00028eb0: 2061 6363 6573 7320 7072 6976 6174 6520   access private 
-00028ec0: 6275 636b 6574 7320 6e6f 7420 6265 6c6f  buckets not belo
-00028ed0: 6e67 696e 6720 746f 2074 6865 2075 7365  nging to the use
-00028ee0: 722e 0a20 2020 2020 2020 2023 2054 6865  r..        # The
-00028ef0: 7365 2062 7563 6b65 7473 2061 7265 206b  se buckets are k
-00028f00: 6e6f 776e 2074 6f20 6265 2070 7269 7661  nown to be priva
-00028f10: 7465 2c20 6275 7420 6d61 7920 6e65 6564  te, but may need
-00028f20: 2074 6f20 6265 2075 7064 6174 6564 2069   to be updated i
-00028f30: 660a 2020 2020 2020 2020 2320 7468 6579  f.        # they
-00028f40: 2061 7265 2072 656d 6f76 6564 2062 7920   are removed by 
-00028f50: 7468 6569 7220 6f77 6e65 7273 2e0a 2020  their owners..  
-00028f60: 2020 2020 2020 7072 6976 6174 655f 6275        private_bu
-00028f70: 636b 6574 5f6e 616d 6520 3d20 7572 6c6c  cket_name = urll
-00028f80: 6962 2e70 6172 7365 2e75 726c 7370 6c69  ib.parse.urlspli
-00028f90: 7428 7072 6976 6174 655f 6275 636b 6574  t(private_bucket
-00028fa0: 292e 6e65 746c 6f63 2069 6620 5c0a 2020  ).netloc if \.  
-00028fb0: 2020 2020 2020 2020 2020 2020 7572 6c6c              urll
-00028fc0: 6962 2e70 6172 7365 2e75 726c 7370 6c69  ib.parse.urlspli
-00028fd0: 7428 7072 6976 6174 655f 6275 636b 6574  t(private_bucket
-00028fe0: 292e 7363 6865 6d65 2021 3d20 2763 6f73  ).scheme != 'cos
-00028ff0: 2720 656c 7365 205c 0a20 2020 2020 2020  ' else \.       
-00029000: 2020 2020 2020 2020 2020 2075 726c 6c69             urlli
-00029010: 622e 7061 7273 652e 7572 6c73 706c 6974  b.parse.urlsplit
-00029020: 2870 7269 7661 7465 5f62 7563 6b65 7429  (private_bucket)
-00029030: 2e70 6174 682e 7374 7269 7028 272f 2729  .path.strip('/')
-00029040: 0a20 2020 2020 2020 2077 6974 6820 7079  .        with py
-00029050: 7465 7374 2e72 6169 7365 7328 0a20 2020  test.raises(.   
-00029060: 2020 2020 2020 2020 2020 2020 2073 6b79               sky
-00029070: 2e65 7863 6570 7469 6f6e 732e 5374 6f72  .exceptions.Stor
-00029080: 6167 6542 7563 6b65 7447 6574 4572 726f  ageBucketGetErro
-00029090: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
-000290a0: 2020 206d 6174 6368 3d73 746f 7261 6765     match=storage
-000290b0: 5f6c 6962 2e5f 4255 434b 4554 5f46 4149  _lib._BUCKET_FAI
-000290c0: 4c5f 544f 5f43 4f4e 4e45 4354 5f4d 4553  L_TO_CONNECT_MES
-000290d0: 5341 4745 2e66 6f72 6d61 7428 0a20 2020  SAGE.format(.   
-000290e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000290f0: 206e 616d 653d 7072 6976 6174 655f 6275   name=private_bu
-00029100: 636b 6574 5f6e 616d 6529 293a 0a20 2020  cket_name)):.   
-00029110: 2020 2020 2020 2020 2073 746f 7261 6765           storage
-00029120: 5f6f 626a 203d 2073 746f 7261 6765 5f6c  _obj = storage_l
-00029130: 6962 2e53 746f 7261 6765 2873 6f75 7263  ib.Storage(sourc
-00029140: 653d 7072 6976 6174 655f 6275 636b 6574  e=private_bucket
-00029150: 290a 0a20 2020 2040 7079 7465 7374 2e6d  )..    @pytest.m
-00029160: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
-00029170: 6b0a 2020 2020 4070 7974 6573 742e 6d61  k.    @pytest.ma
-00029180: 726b 2e70 6172 616d 6574 7269 7a65 2827  rk.parametrize('
-00029190: 6578 745f 6275 636b 6574 5f66 6978 7475  ext_bucket_fixtu
-000291a0: 7265 2c20 7374 6f72 655f 7479 7065 272c  re, store_type',
-000291b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000291c0: 2020 2020 2020 2020 2020 2020 2020 5b28                [(
-000291d0: 2774 6d70 5f61 7773 636c 695f 6275 636b  'tmp_awscli_buck
-000291e0: 6574 272c 2073 746f 7261 6765 5f6c 6962  et', storage_lib
-000291f0: 2e53 746f 7265 5479 7065 2e53 3329 2c0a  .StoreType.S3),.
-00029200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029210: 2020 2020 2020 2020 2020 2020 2020 2827                ('
-00029220: 746d 705f 6773 7574 696c 5f62 7563 6b65  tmp_gsutil_bucke
-00029230: 7427 2c20 7374 6f72 6167 655f 6c69 622e  t', storage_lib.
-00029240: 5374 6f72 6554 7970 652e 4743 5329 2c0a  StoreType.GCS),.
-00029250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029260: 2020 2020 2020 2020 2020 2020 2020 7079                py
-00029270: 7465 7374 2e70 6172 616d 2827 746d 705f  test.param('tmp_
-00029280: 6962 6d5f 636f 735f 6275 636b 6574 272c  ibm_cos_bucket',
-00029290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000292a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000292b0: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
-000292c0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
-000292d0: 652e 4942 4d2c 0a20 2020 2020 2020 2020  e.IBM,.         
-000292e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000292f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029300: 2020 6d61 726b 733d 7079 7465 7374 2e6d    marks=pytest.m
-00029310: 6172 6b2e 6962 6d29 2c0a 2020 2020 2020  ark.ibm),.      
-00029320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029330: 2020 2020 2020 2020 7079 7465 7374 2e70          pytest.p
-00029340: 6172 616d 2827 746d 705f 6177 7363 6c69  aram('tmp_awscli
-00029350: 5f62 7563 6b65 745f 7232 272c 0a20 2020  _bucket_r2',.   
-00029360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029380: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
-00029390: 6c69 622e 5374 6f72 6554 7970 652e 5232  lib.StoreType.R2
-000293a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000293b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000293c0: 2020 2020 2020 2020 2020 2020 206d 6172               mar
-000293d0: 6b73 3d70 7974 6573 742e 6d61 726b 2e63  ks=pytest.mark.c
-000293e0: 6c6f 7564 666c 6172 6529 5d29 0a20 2020  loudflare)]).   
-000293f0: 2064 6566 2074 6573 745f 7570 6c6f 6164   def test_upload
-00029400: 5f74 6f5f 6578 6973 7469 6e67 5f62 7563  _to_existing_buc
-00029410: 6b65 7428 7365 6c66 2c20 6578 745f 6275  ket(self, ext_bu
-00029420: 636b 6574 5f66 6978 7475 7265 2c20 7265  cket_fixture, re
-00029430: 7175 6573 742c 0a20 2020 2020 2020 2020  quest,.         
-00029440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029450: 2020 2020 2020 2020 2020 2020 2020 746d                tm
-00029460: 705f 736f 7572 6365 2c20 7374 6f72 655f  p_source, store_
-00029470: 7479 7065 293a 0a20 2020 2020 2020 2023  type):.        #
-00029480: 2054 7269 6573 2075 706c 6f61 6469 6e67   Tries uploading
-00029490: 2065 7869 7374 696e 6720 6669 6c65 7320   existing files 
-000294a0: 746f 206e 6577 6c79 2063 7265 6174 6564  to newly created
-000294b0: 2062 7563 6b65 7420 286f 7574 7369 6465   bucket (outside
-000294c0: 206f 660a 2020 2020 2020 2020 2320 736b   of.        # sk
-000294d0: 7929 2061 6e64 2076 6572 6966 6965 7320  y) and verifies 
-000294e0: 7468 6174 2066 696c 6573 2061 7265 2077  that files are w
-000294f0: 7269 7474 656e 2e0a 2020 2020 2020 2020  ritten..        
-00029500: 6275 636b 6574 5f6e 616d 652c 205f 203d  bucket_name, _ =
-00029510: 2072 6571 7565 7374 2e67 6574 6669 7874   request.getfixt
-00029520: 7572 6576 616c 7565 2865 7874 5f62 7563  urevalue(ext_buc
-00029530: 6b65 745f 6669 7874 7572 6529 0a20 2020  ket_fixture).   
-00029540: 2020 2020 2073 746f 7261 6765 5f6f 626a       storage_obj
-00029550: 203d 2073 746f 7261 6765 5f6c 6962 2e53   = storage_lib.S
-00029560: 746f 7261 6765 286e 616d 653d 6275 636b  torage(name=buck
-00029570: 6574 5f6e 616d 652c 2073 6f75 7263 653d  et_name, source=
-00029580: 746d 705f 736f 7572 6365 290a 2020 2020  tmp_source).    
-00029590: 2020 2020 7374 6f72 6167 655f 6f62 6a2e      storage_obj.
-000295a0: 6164 645f 7374 6f72 6528 7374 6f72 655f  add_store(store_
-000295b0: 7479 7065 290a 0a20 2020 2020 2020 2023  type)..        #
-000295c0: 2043 6865 636b 2069 6620 746d 705f 736f   Check if tmp_so
-000295d0: 7572 6365 2f74 6d70 2d66 696c 6520 6578  urce/tmp-file ex
-000295e0: 6973 7473 2069 6e20 7468 6520 6275 636b  ists in the buck
-000295f0: 6574 2075 7369 6e67 2061 7773 2063 6c69  et using aws cli
-00029600: 0a20 2020 2020 2020 206f 7574 203d 2073  .        out = s
-00029610: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
-00029620: 6f75 7470 7574 2873 656c 662e 636c 695f  output(self.cli_
-00029630: 6c73 5f63 6d64 2873 746f 7265 5f74 7970  ls_cmd(store_typ
-00029640: 652c 2062 7563 6b65 745f 6e61 6d65 292c  e, bucket_name),
-00029650: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00029660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029670: 2020 2020 2020 2073 6865 6c6c 3d54 7275         shell=Tru
-00029680: 6529 0a20 2020 2020 2020 2061 7373 6572  e).        asser
-00029690: 7420 2774 6d70 2d66 696c 6527 2069 6e20  t 'tmp-file' in 
-000296a0: 6f75 742e 6465 636f 6465 2827 7574 662d  out.decode('utf-
-000296b0: 3827 292c 205c 0a20 2020 2020 2020 2020  8'), \.         
-000296c0: 2020 2027 4669 6c65 206e 6f74 2066 6f75     'File not fou
-000296d0: 6e64 2069 6e20 6275 636b 6574 202d 206f  nd in bucket - o
-000296e0: 7574 7075 7420 7761 7320 3a20 7b7d 272e  utput was : {}'.
-000296f0: 666f 726d 6174 286f 7574 2e64 6563 6f64  format(out.decod
-00029700: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00029710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029740: 2020 2827 7574 662d 3827 2929 0a0a 2020    ('utf-8'))..  
-00029750: 2020 2020 2020 2320 4368 6563 6b20 7379        # Check sy
-00029760: 6d6c 696e 6b73 202d 2073 796d 6c69 6e6b  mlinks - symlink
-00029770: 7320 646f 6e27 7420 6765 7420 636f 7069  s don't get copi
-00029780: 6564 2062 7920 736b 7920 7374 6f72 6167  ed by sky storag
-00029790: 650a 2020 2020 2020 2020 6173 7365 7274  e.        assert
-000297a0: 2028 7061 7468 6c69 622e 5061 7468 2874   (pathlib.Path(t
-000297b0: 6d70 5f73 6f75 7263 6529 202f 2027 6369  mp_source) / 'ci
-000297c0: 7263 6c65 2d6c 696e 6b27 292e 6973 5f73  rcle-link').is_s
-000297d0: 796d 6c69 6e6b 2829 2c20 280a 2020 2020  ymlink(), (.    
-000297e0: 2020 2020 2020 2020 2763 6972 636c 652d          'circle-
-000297f0: 6c69 6e6b 2077 6173 206e 6f74 2066 6f75  link was not fou
-00029800: 6e64 2069 6e20 7468 6520 7570 6c6f 6164  nd in the upload
-00029810: 2073 6f75 7263 6520 2d20 270a 2020 2020   source - '.    
-00029820: 2020 2020 2020 2020 2761 7265 2074 6865          'are the
-00029830: 2074 6573 7420 6669 7874 7572 6573 2063   test fixtures c
-00029840: 6f72 7265 6374 3f27 290a 2020 2020 2020  orrect?').      
-00029850: 2020 6173 7365 7274 2027 6369 7263 6c65    assert 'circle
-00029860: 2d6c 696e 6b27 206e 6f74 2069 6e20 6f75  -link' not in ou
-00029870: 742e 6465 636f 6465 2827 7574 662d 3827  t.decode('utf-8'
-00029880: 292c 2028 0a20 2020 2020 2020 2020 2020  ), (.           
-00029890: 2027 5379 6d6c 696e 6b20 666f 756e 6420   'Symlink found 
-000298a0: 696e 2062 7563 6b65 7420 2d20 6c73 206f  in bucket - ls o
-000298b0: 7574 7075 7420 7761 7320 3a20 7b7d 272e  utput was : {}'.
-000298c0: 666f 726d 6174 280a 2020 2020 2020 2020  format(.        
-000298d0: 2020 2020 2020 2020 6f75 742e 6465 636f          out.deco
-000298e0: 6465 2827 7574 662d 3827 2929 290a 0a20  de('utf-8'))).. 
-000298f0: 2020 2020 2020 2023 2052 756e 2073 6b79         # Run sky
-00029900: 2073 746f 7261 6765 206c 7320 746f 2063   storage ls to c
-00029910: 6865 636b 2069 6620 7374 6f72 6167 6520  heck if storage 
-00029920: 6f62 6a65 6374 2065 7869 7374 7320 696e  object exists in
-00029930: 2074 6865 206f 7574 7075 742e 0a20 2020   the output..   
-00029940: 2020 2020 2023 2049 7420 7368 6f75 6c64       # It should
-00029950: 206e 6f74 2065 7869 7374 2062 6563 6175   not exist becau
-00029960: 7365 2074 6865 2062 7563 6b65 7420 7761  se the bucket wa
-00029970: 7320 6372 6561 7465 6420 6578 7465 726e  s created extern
-00029980: 616c 6c79 2e0a 2020 2020 2020 2020 6f75  ally..        ou
-00029990: 7420 3d20 7375 6270 726f 6365 7373 2e63  t = subprocess.c
-000299a0: 6865 636b 5f6f 7574 7075 7428 5b27 736b  heck_output(['sk
-000299b0: 7927 2c20 2773 746f 7261 6765 272c 2027  y', 'storage', '
-000299c0: 6c73 275d 290a 2020 2020 2020 2020 6173  ls']).        as
-000299d0: 7365 7274 2073 746f 7261 6765 5f6f 626a  sert storage_obj
-000299e0: 2e6e 616d 6520 6e6f 7420 696e 206f 7574  .name not in out
-000299f0: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
-00029a00: 0a0a 2020 2020 4070 7974 6573 742e 6d61  ..    @pytest.ma
-00029a10: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
-00029a20: 0a20 2020 2064 6566 2074 6573 745f 636f  .    def test_co
-00029a30: 7079 5f6d 6f75 6e74 5f65 7869 7374 696e  py_mount_existin
-00029a40: 675f 7374 6f72 6167 6528 7365 6c66 2c0a  g_storage(self,.
-00029a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029a70: 2020 2020 2020 2020 2074 6d70 5f63 6f70           tmp_cop
-00029a80: 795f 6d6e 745f 6578 6973 7469 6e67 5f73  y_mnt_existing_s
-00029a90: 746f 7261 6765 5f6f 626a 293a 0a20 2020  torage_obj):.   
-00029aa0: 2020 2020 2023 2043 7265 6174 6573 2061       # Creates a
-00029ab0: 2062 7563 6b65 7420 7769 7468 206e 6f20   bucket with no 
-00029ac0: 736f 7572 6365 2069 6e20 4d4f 554e 5420  source in MOUNT 
-00029ad0: 6d6f 6465 2028 656d 7074 7920 6275 636b  mode (empty buck
-00029ae0: 6574 292c 2061 6e64 0a20 2020 2020 2020  et), and.       
-00029af0: 2023 2074 6865 6e20 7472 6965 7320 746f   # then tries to
-00029b00: 206c 6f61 6420 7468 6520 7361 6d65 2073   load the same s
-00029b10: 746f 7261 6765 2069 6e20 434f 5059 206d  torage in COPY m
-00029b20: 6f64 652e 0a20 2020 2020 2020 2074 6d70  ode..        tmp
-00029b30: 5f63 6f70 795f 6d6e 745f 6578 6973 7469  _copy_mnt_existi
-00029b40: 6e67 5f73 746f 7261 6765 5f6f 626a 2e61  ng_storage_obj.a
-00029b50: 6464 5f73 746f 7265 2873 746f 7261 6765  dd_store(storage
-00029b60: 5f6c 6962 2e53 746f 7265 5479 7065 2e53  _lib.StoreType.S
-00029b70: 3329 0a20 2020 2020 2020 2073 746f 7261  3).        stora
-00029b80: 6765 5f6e 616d 6520 3d20 746d 705f 636f  ge_name = tmp_co
-00029b90: 7079 5f6d 6e74 5f65 7869 7374 696e 675f  py_mnt_existing_
-00029ba0: 7374 6f72 6167 655f 6f62 6a2e 6e61 6d65  storage_obj.name
-00029bb0: 0a0a 2020 2020 2020 2020 2320 4368 6563  ..        # Chec
-00029bc0: 6b20 6073 6b79 2073 746f 7261 6765 206c  k `sky storage l
-00029bd0: 7360 2074 6f20 656e 7375 7265 2073 746f  s` to ensure sto
-00029be0: 7261 6765 206f 626a 6563 7420 6578 6973  rage object exis
-00029bf0: 7473 0a20 2020 2020 2020 206f 7574 203d  ts.        out =
-00029c00: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
-00029c10: 6b5f 6f75 7470 7574 285b 2773 6b79 272c  k_output(['sky',
-00029c20: 2027 7374 6f72 6167 6527 2c20 276c 7327   'storage', 'ls'
-00029c30: 5d29 2e64 6563 6f64 6528 2775 7466 2d38  ]).decode('utf-8
-00029c40: 2729 0a20 2020 2020 2020 2061 7373 6572  ').        asser
-00029c50: 7420 7374 6f72 6167 655f 6e61 6d65 2069  t storage_name i
-00029c60: 6e20 6f75 742c 2066 2753 746f 7261 6765  n out, f'Storage
-00029c70: 207b 7374 6f72 6167 655f 6e61 6d65 7d20   {storage_name} 
-00029c80: 6e6f 7420 666f 756e 6420 696e 2073 6b79  not found in sky
-00029c90: 2073 746f 7261 6765 206c 732e 270a 0a20   storage ls.'.. 
-00029ca0: 2020 2040 7079 7465 7374 2e6d 6172 6b2e     @pytest.mark.
-00029cb0: 6e6f 5f66 6c75 6964 7374 6163 6b0a 2020  no_fluidstack.  
-00029cc0: 2020 4070 7974 6573 742e 6d61 726b 2e70    @pytest.mark.p
-00029cd0: 6172 616d 6574 7269 7a65 2827 7374 6f72  arametrize('stor
-00029ce0: 655f 7479 7065 272c 205b 0a20 2020 2020  e_type', [.     
-00029cf0: 2020 2073 746f 7261 6765 5f6c 6962 2e53     storage_lib.S
-00029d00: 746f 7265 5479 7065 2e53 332c 2073 746f  toreType.S3, sto
-00029d10: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
-00029d20: 7065 2e47 4353 2c0a 2020 2020 2020 2020  pe.GCS,.        
-00029d30: 7079 7465 7374 2e70 6172 616d 2873 746f  pytest.param(sto
-00029d40: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
-00029d50: 7065 2e49 424d 2c20 6d61 726b 733d 7079  pe.IBM, marks=py
-00029d60: 7465 7374 2e6d 6172 6b2e 6962 6d29 2c0a  test.mark.ibm),.
-00029d70: 2020 2020 2020 2020 7079 7465 7374 2e70          pytest.p
-00029d80: 6172 616d 2873 746f 7261 6765 5f6c 6962  aram(storage_lib
-00029d90: 2e53 746f 7265 5479 7065 2e52 322c 206d  .StoreType.R2, m
-00029da0: 6172 6b73 3d70 7974 6573 742e 6d61 726b  arks=pytest.mark
-00029db0: 2e63 6c6f 7564 666c 6172 6529 0a20 2020  .cloudflare).   
-00029dc0: 205d 290a 2020 2020 6465 6620 7465 7374   ]).    def test
-00029dd0: 5f6c 6973 745f 736f 7572 6365 2873 656c  _list_source(sel
-00029de0: 662c 2074 6d70 5f6c 6f63 616c 5f6c 6973  f, tmp_local_lis
-00029df0: 745f 7374 6f72 6167 655f 6f62 6a2c 2073  t_storage_obj, s
-00029e00: 746f 7265 5f74 7970 6529 3a0a 2020 2020  tore_type):.    
-00029e10: 2020 2020 2320 5573 6573 2061 206c 6973      # Uses a lis
-00029e20: 7420 696e 2074 6865 2073 6f75 7263 6520  t in the source 
-00029e30: 6669 656c 6420 746f 2073 7065 6369 6679  field to specify
-00029e40: 2061 2066 696c 6520 616e 6420 6120 6469   a file and a di
-00029e50: 7265 6374 6f72 7920 746f 0a20 2020 2020  rectory to.     
-00029e60: 2020 2023 2062 6520 7570 6c6f 6164 6564     # be uploaded
-00029e70: 2074 6f20 7468 6520 7374 6f72 6167 6520   to the storage 
-00029e80: 6f62 6a65 6374 2e0a 2020 2020 2020 2020  object..        
-00029e90: 746d 705f 6c6f 6361 6c5f 6c69 7374 5f73  tmp_local_list_s
-00029ea0: 746f 7261 6765 5f6f 626a 2e61 6464 5f73  torage_obj.add_s
-00029eb0: 746f 7265 2873 746f 7265 5f74 7970 6529  tore(store_type)
-00029ec0: 0a0a 2020 2020 2020 2020 2320 4368 6563  ..        # Chec
-00029ed0: 6b20 6966 2074 6d70 2d66 696c 6520 6578  k if tmp-file ex
-00029ee0: 6973 7473 2069 6e20 7468 6520 6275 636b  ists in the buck
-00029ef0: 6574 2072 6f6f 7420 7573 696e 6720 636c  et root using cl
-00029f00: 690a 2020 2020 2020 2020 6f75 7420 3d20  i.        out = 
-00029f10: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
-00029f20: 5f6f 7574 7075 7428 7365 6c66 2e63 6c69  _output(self.cli
-00029f30: 5f6c 735f 636d 6428 0a20 2020 2020 2020  _ls_cmd(.       
-00029f40: 2020 2020 2073 746f 7265 5f74 7970 652c       store_type,
-00029f50: 2074 6d70 5f6c 6f63 616c 5f6c 6973 745f   tmp_local_list_
-00029f60: 7374 6f72 6167 655f 6f62 6a2e 6e61 6d65  storage_obj.name
-00029f70: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00029f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029f90: 2020 2020 2020 2020 2073 6865 6c6c 3d54           shell=T
-00029fa0: 7275 6529 0a20 2020 2020 2020 2061 7373  rue).        ass
-00029fb0: 6572 7420 2774 6d70 2d66 696c 6527 2069  ert 'tmp-file' i
-00029fc0: 6e20 6f75 742e 6465 636f 6465 2827 7574  n out.decode('ut
-00029fd0: 662d 3827 292c 205c 0a20 2020 2020 2020  f-8'), \.       
-00029fe0: 2020 2020 2027 4669 6c65 206e 6f74 2066       'File not f
-00029ff0: 6f75 6e64 2069 6e20 6275 636b 6574 202d  ound in bucket -
-0002a000: 206f 7574 7075 7420 7761 7320 3a20 7b7d   output was : {}
-0002a010: 272e 666f 726d 6174 286f 7574 2e64 6563  '.format(out.dec
-0002a020: 6f64 650a 2020 2020 2020 2020 2020 2020  ode.            
-0002a030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a060: 2020 2020 2827 7574 662d 3827 2929 0a0a      ('utf-8'))..
-0002a070: 2020 2020 2020 2020 2320 4368 6563 6b20          # Check 
-0002a080: 6966 2074 6d70 2d66 696c 6520 6578 6973  if tmp-file exis
-0002a090: 7473 2069 6e20 7468 6520 6275 636b 6574  ts in the bucket
-0002a0a0: 2f74 6d70 2d73 6f75 7263 6520 7573 696e  /tmp-source usin
-0002a0b0: 6720 636c 690a 2020 2020 2020 2020 6f75  g cli.        ou
-0002a0c0: 7420 3d20 7375 6270 726f 6365 7373 2e63  t = subprocess.c
-0002a0d0: 6865 636b 5f6f 7574 7075 7428 7365 6c66  heck_output(self
-0002a0e0: 2e63 6c69 5f6c 735f 636d 6428 0a20 2020  .cli_ls_cmd(.   
-0002a0f0: 2020 2020 2020 2020 2073 746f 7265 5f74           store_t
-0002a100: 7970 652c 2074 6d70 5f6c 6f63 616c 5f6c  ype, tmp_local_l
-0002a110: 6973 745f 7374 6f72 6167 655f 6f62 6a2e  ist_storage_obj.
-0002a120: 6e61 6d65 2c20 2774 6d70 2d73 6f75 7263  name, 'tmp-sourc
-0002a130: 652f 2729 2c0a 2020 2020 2020 2020 2020  e/'),.          
-0002a140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a150: 2020 2020 2020 2020 2020 2020 7368 656c              shel
-0002a160: 6c3d 5472 7565 290a 2020 2020 2020 2020  l=True).        
-0002a170: 6173 7365 7274 2027 746d 702d 6669 6c65  assert 'tmp-file
-0002a180: 2720 696e 206f 7574 2e64 6563 6f64 6528  ' in out.decode(
-0002a190: 2775 7466 2d38 2729 2c20 5c0a 2020 2020  'utf-8'), \.    
-0002a1a0: 2020 2020 2020 2020 2746 696c 6520 6e6f          'File no
-0002a1b0: 7420 666f 756e 6420 696e 2062 7563 6b65  t found in bucke
-0002a1c0: 7420 2d20 6f75 7470 7574 2077 6173 203a  t - output was :
-0002a1d0: 207b 7d27 2e66 6f72 6d61 7428 6f75 742e   {}'.format(out.
-0002a1e0: 6465 636f 6465 0a20 2020 2020 2020 2020  decode.         
-0002a1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a220: 2020 2020 2020 2028 2775 7466 2d38 2729         ('utf-8')
-0002a230: 290a 0a20 2020 2040 7079 7465 7374 2e6d  )..    @pytest.m
-0002a240: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
-0002a250: 6b0a 2020 2020 4070 7974 6573 742e 6d61  k.    @pytest.ma
-0002a260: 726b 2e70 6172 616d 6574 7269 7a65 2827  rk.parametrize('
-0002a270: 696e 7661 6c69 645f 6e61 6d65 5f6c 6973  invalid_name_lis
-0002a280: 742c 2073 746f 7265 5f74 7970 6527 2c0a  t, store_type',.
-0002a290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a2a0: 2020 2020 2020 2020 2020 2020 205b 2841               [(A
-0002a2b0: 5753 5f49 4e56 414c 4944 5f4e 414d 4553  WS_INVALID_NAMES
-0002a2c0: 2c20 7374 6f72 6167 655f 6c69 622e 5374  , storage_lib.St
-0002a2d0: 6f72 6554 7970 652e 5333 292c 0a20 2020  oreType.S3),.   
-0002a2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a2f0: 2020 2020 2020 2020 2020 2028 4743 535f             (GCS_
-0002a300: 494e 5641 4c49 445f 4e41 4d45 532c 2073  INVALID_NAMES, s
-0002a310: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
-0002a320: 5479 7065 2e47 4353 292c 0a20 2020 2020  Type.GCS),.     
-0002a330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a340: 2020 2020 2020 2020 2070 7974 6573 742e           pytest.
-0002a350: 7061 7261 6d28 4942 4d5f 494e 5641 4c49  param(IBM_INVALI
-0002a360: 445f 4e41 4d45 532c 0a20 2020 2020 2020  D_NAMES,.       
-0002a370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a390: 2020 2020 7374 6f72 6167 655f 6c69 622e      storage_lib.
-0002a3a0: 5374 6f72 6554 7970 652e 4942 4d2c 0a20  StoreType.IBM,. 
-0002a3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a3d0: 2020 2020 2020 2020 2020 6d61 726b 733d            marks=
-0002a3e0: 7079 7465 7374 2e6d 6172 6b2e 6962 6d29  pytest.mark.ibm)
-0002a3f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002a400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a410: 7079 7465 7374 2e70 6172 616d 2841 5753  pytest.param(AWS
-0002a420: 5f49 4e56 414c 4944 5f4e 414d 4553 2c0a  _INVALID_NAMES,.
-0002a430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a450: 2020 2020 2020 2020 2020 2073 746f 7261             stora
-0002a460: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
-0002a470: 2e52 322c 0a20 2020 2020 2020 2020 2020  .R2,.           
-0002a480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a4a0: 6d61 726b 733d 7079 7465 7374 2e6d 6172  marks=pytest.mar
-0002a4b0: 6b2e 636c 6f75 6466 6c61 7265 295d 290a  k.cloudflare)]).
-0002a4c0: 2020 2020 6465 6620 7465 7374 5f69 6e76      def test_inv
-0002a4d0: 616c 6964 5f6e 616d 6573 2873 656c 662c  alid_names(self,
-0002a4e0: 2069 6e76 616c 6964 5f6e 616d 655f 6c69   invalid_name_li
-0002a4f0: 7374 2c20 7374 6f72 655f 7479 7065 293a  st, store_type):
-0002a500: 0a20 2020 2020 2020 2023 2055 7365 7320  .        # Uses 
-0002a510: 6120 6c69 7374 2069 6e20 7468 6520 736f  a list in the so
-0002a520: 7572 6365 2066 6965 6c64 2074 6f20 7370  urce field to sp
-0002a530: 6563 6966 7920 6120 6669 6c65 2061 6e64  ecify a file and
-0002a540: 2061 2064 6972 6563 746f 7279 2074 6f0a   a directory to.
-0002a550: 2020 2020 2020 2020 2320 6265 2075 706c          # be upl
-0002a560: 6f61 6465 6420 746f 2074 6865 2073 746f  oaded to the sto
-0002a570: 7261 6765 206f 626a 6563 742e 0a20 2020  rage object..   
-0002a580: 2020 2020 2066 6f72 206e 616d 6520 696e       for name in
-0002a590: 2069 6e76 616c 6964 5f6e 616d 655f 6c69   invalid_name_li
-0002a5a0: 7374 3a0a 2020 2020 2020 2020 2020 2020  st:.            
-0002a5b0: 7769 7468 2070 7974 6573 742e 7261 6973  with pytest.rais
-0002a5c0: 6573 2873 6b79 2e65 7863 6570 7469 6f6e  es(sky.exception
-0002a5d0: 732e 5374 6f72 6167 654e 616d 6545 7272  s.StorageNameErr
-0002a5e0: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-0002a5f0: 2020 2020 2073 746f 7261 6765 5f6f 626a       storage_obj
-0002a600: 203d 2073 746f 7261 6765 5f6c 6962 2e53   = storage_lib.S
-0002a610: 746f 7261 6765 286e 616d 653d 6e61 6d65  torage(name=name
-0002a620: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0002a630: 2020 7374 6f72 6167 655f 6f62 6a2e 6164    storage_obj.ad
-0002a640: 645f 7374 6f72 6528 7374 6f72 655f 7479  d_store(store_ty
-0002a650: 7065 290a 0a20 2020 2040 7079 7465 7374  pe)..    @pytest
-0002a660: 2e6d 6172 6b2e 6e6f 5f66 6c75 6964 7374  .mark.no_fluidst
-0002a670: 6163 6b0a 2020 2020 4070 7974 6573 742e  ack.    @pytest.
-0002a680: 6d61 726b 2e70 6172 616d 6574 7269 7a65  mark.parametrize
-0002a690: 280a 2020 2020 2020 2020 2767 6974 6967  (.        'gitig
-0002a6a0: 6e6f 7265 5f73 7472 7563 7475 7265 2c20  nore_structure, 
-0002a6b0: 7374 6f72 655f 7479 7065 272c 0a20 2020  store_type',.   
-0002a6c0: 2020 2020 205b 2847 4954 4947 4e4f 5245       [(GITIGNORE
-0002a6d0: 5f53 594e 435f 5445 5354 5f44 4952 5f53  _SYNC_TEST_DIR_S
-0002a6e0: 5452 5543 5455 5245 2c20 7374 6f72 6167  TRUCTURE, storag
-0002a6f0: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
-0002a700: 5333 292c 0a20 2020 2020 2020 2020 2847  S3),.         (G
-0002a710: 4954 4947 4e4f 5245 5f53 594e 435f 5445  ITIGNORE_SYNC_TE
-0002a720: 5354 5f44 4952 5f53 5452 5543 5455 5245  ST_DIR_STRUCTURE
-0002a730: 2c20 7374 6f72 6167 655f 6c69 622e 5374  , storage_lib.St
-0002a740: 6f72 6554 7970 652e 4743 5329 2c0a 2020  oreType.GCS),.  
-0002a750: 2020 2020 2020 2070 7974 6573 742e 7061         pytest.pa
-0002a760: 7261 6d28 4749 5449 474e 4f52 455f 5359  ram(GITIGNORE_SY
-0002a770: 4e43 5f54 4553 545f 4449 525f 5354 5255  NC_TEST_DIR_STRU
-0002a780: 4354 5552 452c 0a20 2020 2020 2020 2020  CTURE,.         
-0002a790: 2020 2020 2020 2020 2020 2020 2073 746f               sto
-0002a7a0: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
-0002a7b0: 7065 2e52 322c 0a20 2020 2020 2020 2020  pe.R2,.         
-0002a7c0: 2020 2020 2020 2020 2020 2020 206d 6172               mar
-0002a7d0: 6b73 3d70 7974 6573 742e 6d61 726b 2e63  ks=pytest.mark.c
-0002a7e0: 6c6f 7564 666c 6172 6529 5d29 0a20 2020  loudflare)]).   
-0002a7f0: 2064 6566 2074 6573 745f 6578 636c 7564   def test_exclud
-0002a800: 6564 5f66 696c 655f 636c 6f75 645f 7374  ed_file_cloud_st
-0002a810: 6f72 6167 655f 7570 6c6f 6164 5f63 6f70  orage_upload_cop
-0002a820: 7928 7365 6c66 2c20 6769 7469 676e 6f72  y(self, gitignor
-0002a830: 655f 7374 7275 6374 7572 652c 0a20 2020  e_structure,.   
-0002a840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a870: 2020 7374 6f72 655f 7479 7065 2c0a 2020    store_type,.  
-0002a880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a8b0: 2020 2074 6d70 5f67 6974 6967 6e6f 7265     tmp_gitignore
-0002a8c0: 5f73 746f 7261 6765 5f6f 626a 293a 0a20  _storage_obj):. 
-0002a8d0: 2020 2020 2020 2023 2074 6573 7473 2069         # tests i
-0002a8e0: 6620 6669 6c65 7320 696e 636c 7564 6564  f files included
-0002a8f0: 2069 6e20 2e67 6974 6967 6e6f 7265 2061   in .gitignore a
-0002a900: 6e64 202e 6769 742f 696e 666f 2f65 7863  nd .git/info/exc
-0002a910: 6c75 6465 2061 7265 0a20 2020 2020 2020  lude are.       
-0002a920: 2023 2065 7863 6c75 6465 6420 6672 6f6d   # excluded from
-0002a930: 2062 6569 6e67 2074 7261 6e73 6665 7272   being transferr
-0002a940: 6564 2074 6f20 5374 6f72 6167 650a 0a20  ed to Storage.. 
-0002a950: 2020 2020 2020 2074 6d70 5f67 6974 6967         tmp_gitig
-0002a960: 6e6f 7265 5f73 746f 7261 6765 5f6f 626a  nore_storage_obj
-0002a970: 2e61 6464 5f73 746f 7265 2873 746f 7265  .add_store(store
-0002a980: 5f74 7970 6529 0a0a 2020 2020 2020 2020  _type)..        
-0002a990: 7570 6c6f 6164 5f66 696c 655f 6e61 6d65  upload_file_name
-0002a9a0: 203d 2027 696e 636c 7564 6564 270a 2020   = 'included'.  
-0002a9b0: 2020 2020 2020 2320 436f 756e 7420 7468        # Count th
-0002a9c0: 6520 6e75 6d62 6572 206f 6620 6669 6c65  e number of file
-0002a9d0: 7320 7769 7468 2074 6865 2067 6976 656e  s with the given
-0002a9e0: 2066 696c 6520 6e61 6d65 0a20 2020 2020   file name.     
-0002a9f0: 2020 2075 705f 636d 6420 3d20 7365 6c66     up_cmd = self
-0002aa00: 2e63 6c69 5f63 6f75 6e74 5f6e 616d 655f  .cli_count_name_
-0002aa10: 696e 5f62 7563 6b65 7428 7374 6f72 655f  in_bucket(store_
-0002aa20: 7479 7065 2c20 5c0a 2020 2020 2020 2020  type, \.        
-0002aa30: 2020 2020 746d 705f 6769 7469 676e 6f72      tmp_gitignor
-0002aa40: 655f 7374 6f72 6167 655f 6f62 6a2e 6e61  e_storage_obj.na
-0002aa50: 6d65 2c20 6669 6c65 5f6e 616d 653d 7570  me, file_name=up
-0002aa60: 6c6f 6164 5f66 696c 655f 6e61 6d65 290a  load_file_name).
-0002aa70: 2020 2020 2020 2020 6769 745f 6578 636c          git_excl
-0002aa80: 7564 655f 636d 6420 3d20 7365 6c66 2e63  ude_cmd = self.c
-0002aa90: 6c69 5f63 6f75 6e74 5f6e 616d 655f 696e  li_count_name_in
-0002aaa0: 5f62 7563 6b65 7428 7374 6f72 655f 7479  _bucket(store_ty
-0002aab0: 7065 2c20 5c0a 2020 2020 2020 2020 2020  pe, \.          
-0002aac0: 2020 746d 705f 6769 7469 676e 6f72 655f    tmp_gitignore_
-0002aad0: 7374 6f72 6167 655f 6f62 6a2e 6e61 6d65  storage_obj.name
-0002aae0: 2c20 6669 6c65 5f6e 616d 653d 272e 6769  , file_name='.gi
-0002aaf0: 7427 290a 2020 2020 2020 2020 636e 745f  t').        cnt_
-0002ab00: 6e75 6d5f 6669 6c65 5f63 6d64 203d 2073  num_file_cmd = s
-0002ab10: 656c 662e 636c 695f 636f 756e 745f 6669  elf.cli_count_fi
-0002ab20: 6c65 5f69 6e5f 6275 636b 6574 280a 2020  le_in_bucket(.  
-0002ab30: 2020 2020 2020 2020 2020 7374 6f72 655f            store_
-0002ab40: 7479 7065 2c20 746d 705f 6769 7469 676e  type, tmp_gitign
-0002ab50: 6f72 655f 7374 6f72 6167 655f 6f62 6a2e  ore_storage_obj.
-0002ab60: 6e61 6d65 290a 0a20 2020 2020 2020 2075  name)..        u
-0002ab70: 705f 6f75 7470 7574 203d 2073 7562 7072  p_output = subpr
-0002ab80: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
-0002ab90: 7574 2875 705f 636d 642c 2073 6865 6c6c  ut(up_cmd, shell
-0002aba0: 3d54 7275 6529 0a20 2020 2020 2020 2067  =True).        g
-0002abb0: 6974 5f65 7863 6c75 6465 5f6f 7574 7075  it_exclude_outpu
-0002abc0: 7420 3d20 7375 6270 726f 6365 7373 2e63  t = subprocess.c
-0002abd0: 6865 636b 5f6f 7574 7075 7428 6769 745f  heck_output(git_
-0002abe0: 6578 636c 7564 655f 636d 642c 0a20 2020  exclude_cmd,.   
-0002abf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ac00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ac10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ac20: 2020 7368 656c 6c3d 5472 7565 290a 2020    shell=True).  
-0002ac30: 2020 2020 2020 636e 745f 6f75 7470 7574        cnt_output
-0002ac40: 203d 2073 7562 7072 6f63 6573 732e 6368   = subprocess.ch
-0002ac50: 6563 6b5f 6f75 7470 7574 2863 6e74 5f6e  eck_output(cnt_n
-0002ac60: 756d 5f66 696c 655f 636d 642c 2073 6865  um_file_cmd, she
-0002ac70: 6c6c 3d54 7275 6529 0a0a 2020 2020 2020  ll=True)..      
-0002ac80: 2020 6173 7365 7274 2027 3327 2069 6e20    assert '3' in 
-0002ac90: 7570 5f6f 7574 7075 742e 6465 636f 6465  up_output.decode
-0002aca0: 2827 7574 662d 3827 292c 205c 0a20 2020  ('utf-8'), \.   
-0002acb0: 2020 2020 2020 2020 2020 2020 2027 4669               'Fi
-0002acc0: 6c65 7320 746f 2062 6520 696e 636c 7564  les to be includ
-0002acd0: 6564 2061 7265 206e 6f74 2063 6f6d 706c  ed are not compl
-0002ace0: 6574 656c 7920 7570 6c6f 6164 6564 2e27  etely uploaded.'
-0002acf0: 0a20 2020 2020 2020 2023 2031 2069 7320  .        # 1 is 
-0002ad00: 7265 6164 2061 7320 2e67 6974 6967 6e6f  read as .gitigno
-0002ad10: 7265 2069 7320 7570 6c6f 6164 6564 0a20  re is uploaded. 
-0002ad20: 2020 2020 2020 2061 7373 6572 7420 2731         assert '1
-0002ad30: 2720 696e 2067 6974 5f65 7863 6c75 6465  ' in git_exclude
-0002ad40: 5f6f 7574 7075 742e 6465 636f 6465 2827  _output.decode('
-0002ad50: 7574 662d 3827 292c 205c 0a20 2020 2020  utf-8'), \.     
-0002ad60: 2020 2020 2020 2020 2020 272e 6769 7420            '.git 
-0002ad70: 6469 7265 6374 6f72 7920 7368 6f75 6c64  directory should
-0002ad80: 206e 6f74 2062 6520 7570 6c6f 6164 6564   not be uploaded
-0002ad90: 2e27 0a20 2020 2020 2020 2023 2034 2066  .'.        # 4 f
-0002ada0: 696c 6573 2069 6e63 6c75 6465 202e 6769  iles include .gi
-0002adb0: 7469 676e 6f72 652c 2069 6e63 6c75 6465  tignore, include
-0002adc0: 642e 6c6f 672c 2069 6e63 6c75 6465 642e  d.log, included.
-0002add0: 7478 742c 2069 6e63 6c75 6465 5f64 6972  txt, include_dir
-0002ade0: 2f69 6e63 6c75 6465 642e 6c6f 670a 2020  /included.log.  
-0002adf0: 2020 2020 2020 6173 7365 7274 2027 3427        assert '4'
-0002ae00: 2069 6e20 636e 745f 6f75 7470 7574 2e64   in cnt_output.d
-0002ae10: 6563 6f64 6528 2775 7466 2d38 2729 2c20  ecode('utf-8'), 
-0002ae20: 5c0a 2020 2020 2020 2020 2020 2020 2020  \.              
-0002ae30: 2027 536f 6d65 2069 7465 6d73 206c 6973   'Some items lis
-0002ae40: 7465 6420 696e 202e 6769 7469 676e 6f72  ted in .gitignor
-0002ae50: 6520 616e 6420 2e67 6974 2f69 6e66 6f2f  e and .git/info/
-0002ae60: 6578 636c 7564 6520 6172 6520 6e6f 7420  exclude are not 
-0002ae70: 6578 636c 7564 6564 2e27 0a0a 2020 2020  excluded.'..    
-0002ae80: 4070 7974 6573 742e 6d61 726b 2e70 6172  @pytest.mark.par
-0002ae90: 616d 6574 7269 7a65 2827 6578 745f 6275  ametrize('ext_bu
-0002aea0: 636b 6574 5f66 6978 7475 7265 2c20 7374  cket_fixture, st
-0002aeb0: 6f72 655f 7479 7065 272c 0a20 2020 2020  ore_type',.     
-0002aec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002aed0: 2020 2020 2020 2020 5b28 2774 6d70 5f61          [('tmp_a
-0002aee0: 7773 636c 695f 6275 636b 6574 272c 2073  wscli_bucket', s
-0002aef0: 746f 7261 6765 5f6c 6962 2e53 746f 7265  torage_lib.Store
-0002af00: 5479 7065 2e53 3329 2c0a 2020 2020 2020  Type.S3),.      
-0002af10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002af20: 2020 2020 2020 2020 2827 746d 705f 6773          ('tmp_gs
-0002af30: 7574 696c 5f62 7563 6b65 7427 2c20 7374  util_bucket', st
-0002af40: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
-0002af50: 7970 652e 4743 5329 2c0a 2020 2020 2020  ype.GCS),.      
-0002af60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002af70: 2020 2020 2020 2020 7079 7465 7374 2e70          pytest.p
-0002af80: 6172 616d 2827 746d 705f 6177 7363 6c69  aram('tmp_awscli
-0002af90: 5f62 7563 6b65 745f 7232 272c 0a20 2020  _bucket_r2',.   
-0002afa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002afb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002afc0: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
-0002afd0: 6c69 622e 5374 6f72 6554 7970 652e 5232  lib.StoreType.R2
-0002afe0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002aff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b000: 2020 2020 2020 2020 2020 2020 206d 6172               mar
-0002b010: 6b73 3d70 7974 6573 742e 6d61 726b 2e63  ks=pytest.mark.c
-0002b020: 6c6f 7564 666c 6172 6529 5d29 0a20 2020  loudflare)]).   
-0002b030: 2064 6566 2074 6573 745f 6578 7465 726e   def test_extern
-0002b040: 616c 6c79 5f63 7265 6174 6564 5f62 7563  ally_created_buc
-0002b050: 6b65 745f 6d6f 756e 745f 7769 7468 6f75  ket_mount_withou
-0002b060: 745f 736f 7572 6365 280a 2020 2020 2020  t_source(.      
-0002b070: 2020 2020 2020 7365 6c66 2c20 6578 745f        self, ext_
-0002b080: 6275 636b 6574 5f66 6978 7475 7265 2c20  bucket_fixture, 
-0002b090: 7265 7175 6573 742c 2073 746f 7265 5f74  request, store_t
-0002b0a0: 7970 6529 3a0a 2020 2020 2020 2020 2320  ype):.        # 
-0002b0b0: 4e6f 6e2d 736b 7920 6d61 6e61 6765 6420  Non-sky managed 
-0002b0c0: 6275 636b 6574 7328 6275 636b 6574 7320  buckets(buckets 
-0002b0d0: 6372 6561 7465 6420 6f75 7473 6964 6520  created outside 
-0002b0e0: 6f66 2053 6b79 7069 6c6f 7420 434c 4929  of Skypilot CLI)
-0002b0f0: 0a20 2020 2020 2020 2023 2061 7265 2061  .        # are a
-0002b100: 6c6c 6f77 6564 2074 6f20 6265 204d 4f55  llowed to be MOU
-0002b110: 4e54 6564 2062 7920 7370 6563 6966 7969  NTed by specifyi
-0002b120: 6e67 2074 6865 2055 5249 206f 6620 7468  ng the URI of th
-0002b130: 6520 6275 636b 6574 2074 6f0a 2020 2020  e bucket to.    
-0002b140: 2020 2020 2320 736f 7572 6365 2066 6965      # source fie
-0002b150: 6c64 206f 6e6c 792e 2057 6865 6e20 6974  ld only. When it
-0002b160: 2069 7320 6174 7465 6d70 7465 6420 6279   is attempted by
-0002b170: 2073 7065 6369 6679 696e 6720 7468 6520   specifying the 
-0002b180: 6e61 6d65 206f 660a 2020 2020 2020 2020  name of.        
-0002b190: 2320 7468 6520 6275 636b 6574 206f 6e6c  # the bucket onl
-0002b1a0: 792c 2069 7420 7368 6f75 6c64 2065 7272  y, it should err
-0002b1b0: 6f72 206f 7574 2e0a 2020 2020 2020 2020  or out..        
-0002b1c0: 230a 2020 2020 2020 2020 2320 544f 444f  #.        # TODO
-0002b1d0: 2864 6f79 6f75 6e67 293a 2041 6464 2074  (doyoung): Add t
-0002b1e0: 6573 7420 666f 7220 4942 4d20 434f 532e  est for IBM COS.
-0002b1f0: 2043 7572 7265 6e74 6c79 2c20 7468 6973   Currently, this
-0002b200: 2069 7320 626c 6f63 6b65 640a 2020 2020   is blocked.    
-0002b210: 2020 2020 2320 6173 2072 636c 6f6e 6520      # as rclone 
-0002b220: 7573 6564 2074 6f20 696e 7465 7261 6374  used to interact
-0002b230: 2077 6974 6820 4942 4d20 434f 5320 646f   with IBM COS do
-0002b240: 6573 206e 6f74 2073 7570 706f 7274 2066  es not support f
-0002b250: 6561 7475 7265 2074 6f0a 2020 2020 2020  eature to.      
-0002b260: 2020 2320 6372 6561 7465 2061 2062 7563    # create a buc
-0002b270: 6b65 742c 2061 6e64 2074 6865 2069 626d  ket, and the ibm
-0002b280: 636c 6f75 6420 434c 4920 6973 206e 6f74  cloud CLI is not
-0002b290: 2073 7570 706f 7274 6564 2069 6e20 536b   supported in Sk
-0002b2a0: 7970 696c 6f74 2e0a 2020 2020 2020 2020  ypilot..        
-0002b2b0: 2320 4569 7468 6572 206f 6620 7468 6520  # Either of the 
-0002b2c0: 6665 6174 7572 6520 6973 206e 6563 6573  feature is neces
-0002b2d0: 7361 7279 2074 6f20 7369 6d75 6c61 7465  sary to simulate
-0002b2e0: 2061 6e20 6578 7465 726e 616c 2062 7563   an external buc
-0002b2f0: 6b65 740a 2020 2020 2020 2020 2320 6372  ket.        # cr
-0002b300: 6561 7469 6f6e 2066 6f72 2049 424d 2043  eation for IBM C
-0002b310: 4f53 2e0a 2020 2020 2020 2020 2320 6874  OS..        # ht
-0002b320: 7470 733a 2f2f 6769 7468 7562 2e63 6f6d  tps://github.com
-0002b330: 2f73 6b79 7069 6c6f 742d 6f72 672f 736b  /skypilot-org/sk
-0002b340: 7970 696c 6f74 2f70 756c 6c2f 3139 3636  ypilot/pull/1966
-0002b350: 2f66 696c 6573 2372 3132 3533 3433 3938  /files#r12534398
-0002b360: 3337 0a0a 2020 2020 2020 2020 6578 745f  37..        ext_
-0002b370: 6275 636b 6574 5f6e 616d 652c 2065 7874  bucket_name, ext
-0002b380: 5f62 7563 6b65 745f 7572 6920 3d20 7265  _bucket_uri = re
-0002b390: 7175 6573 742e 6765 7466 6978 7475 7265  quest.getfixture
-0002b3a0: 7661 6c75 6528 0a20 2020 2020 2020 2020  value(.         
-0002b3b0: 2020 2065 7874 5f62 7563 6b65 745f 6669     ext_bucket_fi
-0002b3c0: 7874 7572 6529 0a20 2020 2020 2020 2023  xture).        #
-0002b3d0: 2069 6e76 616c 6964 2073 7065 630a 2020   invalid spec.  
-0002b3e0: 2020 2020 2020 7769 7468 2070 7974 6573        with pytes
-0002b3f0: 742e 7261 6973 6573 2873 6b79 2e65 7863  t.raises(sky.exc
-0002b400: 6570 7469 6f6e 732e 5374 6f72 6167 6553  eptions.StorageS
-0002b410: 7065 6345 7272 6f72 2920 6173 2065 3a0a  pecError) as e:.
-0002b420: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
-0002b430: 6167 655f 6f62 6a20 3d20 7374 6f72 6167  age_obj = storag
-0002b440: 655f 6c69 622e 5374 6f72 6167 6528 0a20  e_lib.Storage(. 
-0002b450: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0002b460: 616d 653d 6578 745f 6275 636b 6574 5f6e  ame=ext_bucket_n
-0002b470: 616d 652c 206d 6f64 653d 7374 6f72 6167  ame, mode=storag
-0002b480: 655f 6c69 622e 5374 6f72 6167 654d 6f64  e_lib.StorageMod
-0002b490: 652e 4d4f 554e 5429 0a20 2020 2020 2020  e.MOUNT).       
-0002b4a0: 2020 2020 2073 746f 7261 6765 5f6f 626a       storage_obj
-0002b4b0: 2e61 6464 5f73 746f 7265 2873 746f 7265  .add_store(store
-0002b4c0: 5f74 7970 6529 0a0a 2020 2020 2020 2020  _type)..        
-0002b4d0: 6173 7365 7274 2027 4174 7465 6d70 7465  assert 'Attempte
-0002b4e0: 6420 746f 206d 6f75 6e74 2061 206e 6f6e  d to mount a non
-0002b4f0: 2d73 6b79 206d 616e 6167 6564 2062 7563  -sky managed buc
-0002b500: 6b65 7427 2069 6e20 7374 7228 6529 0a0a  ket' in str(e)..
-0002b510: 2020 2020 2020 2020 2320 7661 6c69 6420          # valid 
-0002b520: 7370 6563 0a20 2020 2020 2020 2073 746f  spec.        sto
-0002b530: 7261 6765 5f6f 626a 203d 2073 746f 7261  rage_obj = stora
-0002b540: 6765 5f6c 6962 2e53 746f 7261 6765 2873  ge_lib.Storage(s
-0002b550: 6f75 7263 653d 6578 745f 6275 636b 6574  ource=ext_bucket
-0002b560: 5f75 7269 2c0a 2020 2020 2020 2020 2020  _uri,.          
-0002b570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b590: 6d6f 6465 3d73 746f 7261 6765 5f6c 6962  mode=storage_lib
-0002b5a0: 2e53 746f 7261 6765 4d6f 6465 2e4d 4f55  .StorageMode.MOU
-0002b5b0: 4e54 290a 2020 2020 2020 2020 6861 6e64  NT).        hand
-0002b5c0: 6c65 203d 2067 6c6f 6261 6c5f 7573 6572  le = global_user
-0002b5d0: 5f73 7461 7465 2e67 6574 5f68 616e 646c  _state.get_handl
-0002b5e0: 655f 6672 6f6d 5f73 746f 7261 6765 5f6e  e_from_storage_n
-0002b5f0: 616d 6528 0a20 2020 2020 2020 2020 2020  ame(.           
-0002b600: 2073 746f 7261 6765 5f6f 626a 2e6e 616d   storage_obj.nam
-0002b610: 6529 0a20 2020 2020 2020 2069 6620 6861  e).        if ha
-0002b620: 6e64 6c65 3a0a 2020 2020 2020 2020 2020  ndle:.          
-0002b630: 2020 7374 6f72 6167 655f 6f62 6a2e 6465    storage_obj.de
-0002b640: 6c65 7465 2829 0a0a 0a23 202d 2d2d 2d2d  lete()...# -----
-0002b650: 2d2d 2d2d 2d20 5465 7374 696e 6720 5941  ----- Testing YA
-0002b660: 4d4c 2053 7065 6373 202d 2d2d 2d2d 2d2d  ML Specs -------
-0002b670: 2d2d 2d0a 2320 4f75 7220 736b 7920 7374  ---.# Our sky st
-0002b680: 6f72 6167 6520 7265 7175 6972 6573 2063  orage requires c
-0002b690: 7265 6465 6e74 6961 6c73 2074 6f20 6368  redentials to ch
-0002b6a0: 6563 6b20 7468 6520 6275 636b 6574 2065  eck the bucket e
-0002b6b0: 7869 7374 616e 6365 2077 6865 6e0a 2320  xistance when.# 
-0002b6c0: 6c6f 6164 696e 6720 6120 7461 736b 2066  loading a task f
-0002b6d0: 726f 6d20 7468 6520 7961 6d6c 2066 696c  rom the yaml fil
-0002b6e0: 652c 2073 6f20 7765 2063 616e 6e6f 7420  e, so we cannot 
-0002b6f0: 6d61 6b65 2069 7420 6120 756e 6974 2074  make it a unit t
-0002b700: 6573 742e 0a63 6c61 7373 2054 6573 7459  est..class TestY
-0002b710: 616d 6c53 7065 6373 3a0a 2020 2020 2320  amlSpecs:.    # 
-0002b720: 544f 444f 287a 6877 7529 3a20 4164 6420  TODO(zhwu): Add 
-0002b730: 7465 7374 2066 6f72 2060 746f 5f79 616d  test for `to_yam
-0002b740: 6c5f 636f 6e66 6967 6020 666f 7220 7468  l_config` for th
-0002b750: 6520 5374 6f72 6167 6520 6f62 6a65 6374  e Storage object
-0002b760: 2e0a 2020 2020 2320 2057 6520 7368 6f75  ..    #  We shou
-0002b770: 6c64 206e 6f74 2075 7365 2060 6578 616d  ld not use `exam
-0002b780: 706c 6573 2f73 746f 7261 6765 5f64 656d  ples/storage_dem
-0002b790: 6f2e 7961 6d6c 6020 6865 7265 2c20 7369  o.yaml` here, si
-0002b7a0: 6e63 6520 6974 2072 6571 7569 7265 730a  nce it requires.
-0002b7b0: 2020 2020 2320 2075 7365 7273 2074 6f20      #  users to 
-0002b7c0: 656e 7375 7265 2062 7563 6b65 7420 6e61  ensure bucket na
-0002b7d0: 6d65 7320 746f 206e 6f74 2065 7869 7374  mes to not exist
-0002b7e0: 2061 6e64 2f6f 7220 6265 2075 6e69 7175   and/or be uniqu
-0002b7f0: 652e 0a20 2020 205f 5445 5354 5f59 414d  e..    _TEST_YAM
-0002b800: 4c5f 5041 5448 5320 3d20 5b0a 2020 2020  L_PATHS = [.    
-0002b810: 2020 2020 2765 7861 6d70 6c65 732f 6d69      'examples/mi
-0002b820: 6e69 6d61 6c2e 7961 6d6c 272c 2027 6578  nimal.yaml', 'ex
-0002b830: 616d 706c 6573 2f6d 616e 6167 6564 5f73  amples/managed_s
-0002b840: 706f 742e 7961 6d6c 272c 0a20 2020 2020  pot.yaml',.     
-0002b850: 2020 2027 6578 616d 706c 6573 2f75 7369     'examples/usi
-0002b860: 6e67 5f66 696c 655f 6d6f 756e 7473 2e79  ng_file_mounts.y
-0002b870: 616d 6c27 2c20 2765 7861 6d70 6c65 732f  aml', 'examples/
-0002b880: 7265 736e 6574 5f61 7070 2e79 616d 6c27  resnet_app.yaml'
-0002b890: 2c0a 2020 2020 2020 2020 2765 7861 6d70  ,.        'examp
-0002b8a0: 6c65 732f 6d75 6c74 695f 686f 7374 6e61  les/multi_hostna
-0002b8b0: 6d65 2e79 616d 6c27 0a20 2020 205d 0a0a  me.yaml'.    ]..
-0002b8c0: 2020 2020 6465 6620 5f69 735f 6469 6374      def _is_dict
-0002b8d0: 5f73 7562 7365 7428 7365 6c66 2c20 6431  _subset(self, d1
-0002b8e0: 2c20 6432 293a 0a20 2020 2020 2020 2022  , d2):.        "
-0002b8f0: 2222 4368 6563 6b20 6966 2064 3120 6973  ""Check if d1 is
-0002b900: 2074 6865 2073 7562 7365 7420 6f66 2064   the subset of d
-0002b910: 322e 2222 220a 2020 2020 2020 2020 666f  2.""".        fo
-0002b920: 7220 6b2c 2076 2069 6e20 6431 2e69 7465  r k, v in d1.ite
-0002b930: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
-0002b940: 2020 6966 206b 206e 6f74 2069 6e20 6432    if k not in d2
-0002b950: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002b960: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-0002b970: 762c 206c 6973 7429 206f 7220 6973 696e  v, list) or isin
-0002b980: 7374 616e 6365 2876 2c20 6469 6374 293a  stance(v, dict):
-0002b990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002b9a0: 2020 2020 2061 7373 6572 7420 6c65 6e28       assert len(
-0002b9b0: 7629 203d 3d20 302c 2028 6b2c 2076 290a  v) == 0, (k, v).
-0002b9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b9d0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0002b9e0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0002b9f0: 2046 616c 7365 2c20 286b 2c20 7629 0a20   False, (k, v). 
-0002ba00: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-0002ba10: 6973 696e 7374 616e 6365 2876 2c20 6469  isinstance(v, di
-0002ba20: 6374 293a 0a20 2020 2020 2020 2020 2020  ct):.           
-0002ba30: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
-0002ba40: 7374 616e 6365 2864 325b 6b5d 2c20 6469  stance(d2[k], di
-0002ba50: 6374 292c 2028 6b2c 2076 2c20 6432 290a  ct), (k, v, d2).
-0002ba60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ba70: 7365 6c66 2e5f 6973 5f64 6963 745f 7375  self._is_dict_su
-0002ba80: 6273 6574 2876 2c20 6432 5b6b 5d29 0a20  bset(v, d2[k]). 
-0002ba90: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-0002baa0: 6973 696e 7374 616e 6365 2876 2c20 7374  isinstance(v, st
-0002bab0: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-0002bac0: 2020 2020 6966 206b 203d 3d20 2761 6363      if k == 'acc
-0002bad0: 656c 6572 6174 6f72 7327 3a0a 2020 2020  elerators':.    
-0002bae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002baf0: 7265 736f 7572 6365 7320 3d20 736b 792e  resources = sky.
-0002bb00: 5265 736f 7572 6365 7328 290a 2020 2020  Resources().    
-0002bb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bb20: 7265 736f 7572 6365 732e 5f73 6574 5f61  resources._set_a
-0002bb30: 6363 656c 6572 6174 6f72 7328 762c 204e  ccelerators(v, N
-0002bb40: 6f6e 6529 0a20 2020 2020 2020 2020 2020  one).           
-0002bb50: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-0002bb60: 7265 736f 7572 6365 732e 6163 6365 6c65  resources.accele
-0002bb70: 7261 746f 7273 203d 3d20 6432 5b6b 5d2c  rators == d2[k],
-0002bb80: 2028 6b2c 2076 2c20 6432 290a 2020 2020   (k, v, d2).    
-0002bb90: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0002bba0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002bbb0: 2020 2020 2020 6173 7365 7274 2076 2e6c        assert v.l
-0002bbc0: 6f77 6572 2829 203d 3d20 6432 5b6b 5d2e  ower() == d2[k].
-0002bbd0: 6c6f 7765 7228 292c 2028 6b2c 2076 2c20  lower(), (k, v, 
-0002bbe0: 6432 5b6b 5d29 0a20 2020 2020 2020 2020  d2[k]).         
-0002bbf0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0002bc00: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-0002bc10: 7620 3d3d 2064 325b 6b5d 2c20 286b 2c20  v == d2[k], (k, 
-0002bc20: 762c 2064 325b 6b5d 290a 0a20 2020 2064  v, d2[k])..    d
-0002bc30: 6566 205f 6368 6563 6b5f 6571 7569 7661  ef _check_equiva
-0002bc40: 6c65 6e74 2873 656c 662c 2079 616d 6c5f  lent(self, yaml_
-0002bc50: 7061 7468 293a 0a20 2020 2020 2020 2022  path):.        "
-0002bc60: 2222 4368 6563 6b20 6966 2074 6865 2079  ""Check if the y
-0002bc70: 616d 6c20 6973 2065 7175 6976 616c 656e  aml is equivalen
-0002bc80: 7420 6166 7465 7220 6c6f 6164 2061 6e64  t after load and
-0002bc90: 2064 756d 7020 6167 6169 6e2e 2222 220a   dump again.""".
-0002bca0: 2020 2020 2020 2020 6f72 6967 696e 5f74          origin_t
-0002bcb0: 6173 6b5f 636f 6e66 6967 203d 2063 6f6d  ask_config = com
-0002bcc0: 6d6f 6e5f 7574 696c 732e 7265 6164 5f79  mon_utils.read_y
-0002bcd0: 616d 6c28 7961 6d6c 5f70 6174 6829 0a0a  aml(yaml_path)..
-0002bce0: 2020 2020 2020 2020 7461 736b 203d 2073          task = s
-0002bcf0: 6b79 2e54 6173 6b2e 6672 6f6d 5f79 616d  ky.Task.from_yam
-0002bd00: 6c28 7961 6d6c 5f70 6174 6829 0a20 2020  l(yaml_path).   
-0002bd10: 2020 2020 206e 6577 5f74 6173 6b5f 636f       new_task_co
-0002bd20: 6e66 6967 203d 2074 6173 6b2e 746f 5f79  nfig = task.to_y
-0002bd30: 616d 6c5f 636f 6e66 6967 2829 0a20 2020  aml_config().   
-0002bd40: 2020 2020 2023 2064 3120 3c3d 2064 320a       # d1 <= d2.
-0002bd50: 2020 2020 2020 2020 7072 696e 7428 6f72          print(or
-0002bd60: 6967 696e 5f74 6173 6b5f 636f 6e66 6967  igin_task_config
-0002bd70: 2c20 6e65 775f 7461 736b 5f63 6f6e 6669  , new_task_confi
-0002bd80: 6729 0a20 2020 2020 2020 2073 656c 662e  g).        self.
-0002bd90: 5f69 735f 6469 6374 5f73 7562 7365 7428  _is_dict_subset(
-0002bda0: 6f72 6967 696e 5f74 6173 6b5f 636f 6e66  origin_task_conf
-0002bdb0: 6967 2c20 6e65 775f 7461 736b 5f63 6f6e  ig, new_task_con
-0002bdc0: 6669 6729 0a0a 2020 2020 6465 6620 7465  fig)..    def te
-0002bdd0: 7374 5f6c 6f61 645f 6475 6d70 5f79 616d  st_load_dump_yam
-0002bde0: 6c5f 636f 6e66 6967 5f65 7175 6976 616c  l_config_equival
-0002bdf0: 656e 7428 7365 6c66 293a 0a20 2020 2020  ent(self):.     
-0002be00: 2020 2022 2222 5465 7374 2069 6620 7468     """Test if th
-0002be10: 6520 7961 6d6c 2063 6f6e 6669 6720 6973  e yaml config is
-0002be20: 2065 7175 6976 616c 656e 7420 6166 7465   equivalent afte
-0002be30: 7220 6c6f 6164 2061 6e64 2064 756d 7020  r load and dump 
-0002be40: 6167 6169 6e2e 2222 220a 2020 2020 2020  again.""".      
-0002be50: 2020 7061 7468 6c69 622e 5061 7468 2827    pathlib.Path('
-0002be60: 7e2f 6461 7461 7365 7473 2729 2e65 7870  ~/datasets').exp
-0002be70: 616e 6475 7365 7228 292e 6d6b 6469 7228  anduser().mkdir(
-0002be80: 6578 6973 745f 6f6b 3d54 7275 6529 0a20  exist_ok=True). 
-0002be90: 2020 2020 2020 2070 6174 686c 6962 2e50         pathlib.P
-0002bea0: 6174 6828 277e 2f74 6d70 6669 6c65 2729  ath('~/tmpfile')
-0002beb0: 2e65 7870 616e 6475 7365 7228 292e 746f  .expanduser().to
-0002bec0: 7563 6828 290a 2020 2020 2020 2020 7061  uch().        pa
-0002bed0: 7468 6c69 622e 5061 7468 2827 7e2f 2e73  thlib.Path('~/.s
-0002bee0: 7368 2729 2e65 7870 616e 6475 7365 7228  sh').expanduser(
-0002bef0: 292e 6d6b 6469 7228 6578 6973 745f 6f6b  ).mkdir(exist_ok
-0002bf00: 3d54 7275 6529 0a20 2020 2020 2020 2070  =True).        p
-0002bf10: 6174 686c 6962 2e50 6174 6828 277e 2f2e  athlib.Path('~/.
-0002bf20: 7373 682f 6964 5f72 7361 2e70 7562 2729  ssh/id_rsa.pub')
-0002bf30: 2e65 7870 616e 6475 7365 7228 292e 746f  .expanduser().to
-0002bf40: 7563 6828 290a 2020 2020 2020 2020 7061  uch().        pa
-0002bf50: 7468 6c69 622e 5061 7468 2827 7e2f 746d  thlib.Path('~/tm
-0002bf60: 702d 776f 726b 6469 7227 292e 6578 7061  p-workdir').expa
-0002bf70: 6e64 7573 6572 2829 2e6d 6b64 6972 2865  nduser().mkdir(e
-0002bf80: 7869 7374 5f6f 6b3d 5472 7565 290a 2020  xist_ok=True).  
-0002bf90: 2020 2020 2020 7061 7468 6c69 622e 5061        pathlib.Pa
-0002bfa0: 7468 2827 7e2f 446f 776e 6c6f 6164 732f  th('~/Downloads/
-0002bfb0: 7470 7527 292e 6578 7061 6e64 7573 6572  tpu').expanduser
-0002bfc0: 2829 2e6d 6b64 6972 2870 6172 656e 7473  ().mkdir(parents
-0002bfd0: 3d54 7275 652c 0a20 2020 2020 2020 2020  =True,.         
-0002bfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c010: 2020 6578 6973 745f 6f6b 3d54 7275 6529    exist_ok=True)
-0002c020: 0a20 2020 2020 2020 2066 6f72 2079 616d  .        for yam
-0002c030: 6c5f 7061 7468 2069 6e20 7365 6c66 2e5f  l_path in self._
-0002c040: 5445 5354 5f59 414d 4c5f 5041 5448 533a  TEST_YAML_PATHS:
-0002c050: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0002c060: 662e 5f63 6865 636b 5f65 7175 6976 616c  f._check_equival
-0002c070: 656e 7428 7961 6d6c 5f70 6174 6829 0a0a  ent(yaml_path)..
-0002c080: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465  .# ---------- Te
-0002c090: 7374 696e 6720 4d75 6c74 6970 6c65 2041  sting Multiple A
-0002c0a0: 6363 656c 6572 6174 6f72 7320 2d2d 2d2d  ccelerators ----
-0002c0b0: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
-0002c0c0: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
-0002c0d0: 6b20 2023 2046 6c75 6964 7374 6163 6b20  k  # Fluidstack 
-0002c0e0: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
-0002c0f0: 204b 3830 2067 7075 7320 666f 7220 6e6f   K80 gpus for no
-0002c100: 770a 6465 6620 7465 7374 5f6d 756c 7469  w.def test_multi
-0002c110: 706c 655f 6163 6365 6c65 7261 746f 7273  ple_accelerators
-0002c120: 5f6f 7264 6572 6564 2829 3a0a 2020 2020  _ordered():.    
-0002c130: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-0002c140: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
-0002c150: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-0002c160: 2020 2020 276d 756c 7469 706c 652d 6163      'multiple-ac
-0002c170: 6365 6c65 7261 746f 7273 2d6f 7264 6572  celerators-order
-0002c180: 6564 272c 0a20 2020 2020 2020 205b 0a20  ed',.        [. 
-0002c190: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
-0002c1a0: 206c 6175 6e63 6820 2d79 202d 6320 7b6e   launch -y -c {n
-0002c1b0: 616d 657d 2074 6573 7473 2f74 6573 745f  ame} tests/test_
-0002c1c0: 7961 6d6c 732f 7465 7374 5f6d 756c 7469  yamls/test_multi
-0002c1d0: 706c 655f 6163 6365 6c65 7261 746f 7273  ple_accelerators
-0002c1e0: 5f6f 7264 6572 6564 2e79 616d 6c20 7c20  _ordered.yaml | 
-0002c1f0: 6772 6570 2022 5573 696e 6720 7573 6572  grep "Using user
-0002c200: 2d73 7065 6369 6669 6564 2061 6363 656c  -specified accel
-0002c210: 6572 6174 6f72 7320 6c69 7374 2227 2c0a  erators list"',.
-0002c220: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0002c230: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
-0002c240: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
-0002c250: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
-0002c260: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
-0002c270: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
-0002c280: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-0002c290: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
-0002c2a0: 743d 3230 202a 2036 302c 0a20 2020 2029  t=20 * 60,.    )
-0002c2b0: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-0002c2c0: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-0002c2d0: 742e 6d61 726b 2e6e 6f5f 666c 7569 6473  t.mark.no_fluids
-0002c2e0: 7461 636b 2020 2320 466c 7569 6473 7461  tack  # Fluidsta
-0002c2f0: 636b 2068 6173 206c 6f77 2061 7661 696c  ck has low avail
-0002c300: 6162 696c 6974 7920 666f 7220 5434 2047  ability for T4 G
-0002c310: 5055 730a 6465 6620 7465 7374 5f6d 756c  PUs.def test_mul
-0002c320: 7469 706c 655f 6163 6365 6c65 7261 746f  tiple_accelerato
-0002c330: 7273 5f6f 7264 6572 6564 5f77 6974 685f  rs_ordered_with_
-0002c340: 6465 6661 756c 7428 293a 0a20 2020 206e  default():.    n
-0002c350: 616d 6520 3d20 5f67 6574 5f63 6c75 7374  ame = _get_clust
-0002c360: 6572 5f6e 616d 6528 290a 2020 2020 7465  er_name().    te
-0002c370: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
-0002c380: 2020 2027 6d75 6c74 6970 6c65 2d61 6363     'multiple-acc
-0002c390: 656c 6572 6174 6f72 732d 6f72 6465 7265  elerators-ordere
-0002c3a0: 6427 2c0a 2020 2020 2020 2020 5b0a 2020  d',.        [.  
-0002c3b0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
-0002c3c0: 6c61 756e 6368 202d 7920 2d63 207b 6e61  launch -y -c {na
-0002c3d0: 6d65 7d20 7465 7374 732f 7465 7374 5f79  me} tests/test_y
-0002c3e0: 616d 6c73 2f74 6573 745f 6d75 6c74 6970  amls/test_multip
-0002c3f0: 6c65 5f61 6363 656c 6572 6174 6f72 735f  le_accelerators_
-0002c400: 6f72 6465 7265 645f 7769 7468 5f64 6566  ordered_with_def
-0002c410: 6175 6c74 2e79 616d 6c20 7c20 6772 6570  ault.yaml | grep
-0002c420: 2022 5573 696e 6720 7573 6572 2d73 7065   "Using user-spe
-0002c430: 6369 6669 6564 2061 6363 656c 6572 6174  cified accelerat
-0002c440: 6f72 7320 6c69 7374 2227 2c0a 2020 2020  ors list"',.    
-0002c450: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
-0002c460: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
-0002c470: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
-0002c480: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
-0002c490: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
-0002c4a0: 6627 736b 7920 7374 6174 7573 207b 6e61  f'sky status {na
-0002c4b0: 6d65 7d20 7c20 6772 6570 2053 706f 7427  me} | grep Spot'
-0002c4c0: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
-0002c4d0: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
-0002c4e0: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
-0002c4f0: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
-0002c500: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
-0002c510: 7374 2e6d 6172 6b2e 6e6f 5f66 6c75 6964  st.mark.no_fluid
-0002c520: 7374 6163 6b20 2023 2046 6c75 6964 7374  stack  # Fluidst
-0002c530: 6163 6b20 6861 7320 6c6f 7720 6176 6169  ack has low avai
-0002c540: 6c61 6269 6c69 7479 2066 6f72 2054 3420  lability for T4 
-0002c550: 4750 5573 0a64 6566 2074 6573 745f 6d75  GPUs.def test_mu
-0002c560: 6c74 6970 6c65 5f61 6363 656c 6572 6174  ltiple_accelerat
-0002c570: 6f72 735f 756e 6f72 6465 7265 6428 293a  ors_unordered():
-0002c580: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
-0002c590: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
-0002c5a0: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
-0002c5b0: 0a20 2020 2020 2020 2027 6d75 6c74 6970  .        'multip
-0002c5c0: 6c65 2d61 6363 656c 6572 6174 6f72 732d  le-accelerators-
-0002c5d0: 756e 6f72 6465 7265 6427 2c0a 2020 2020  unordered',.    
-0002c5e0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
-0002c5f0: 2020 6627 736b 7920 6c61 756e 6368 202d    f'sky launch -
-0002c600: 7920 2d63 207b 6e61 6d65 7d20 7465 7374  y -c {name} test
-0002c610: 732f 7465 7374 5f79 616d 6c73 2f74 6573  s/test_yamls/tes
-0002c620: 745f 6d75 6c74 6970 6c65 5f61 6363 656c  t_multiple_accel
-0002c630: 6572 6174 6f72 735f 756e 6f72 6465 7265  erators_unordere
-0002c640: 642e 7961 6d6c 272c 0a20 2020 2020 2020  d.yaml',.       
-0002c650: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
-0002c660: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
-0002c670: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
-0002c680: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
-0002c690: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
-0002c6a0: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
-0002c6b0: 7920 7b6e 616d 657d 272c 0a20 2020 2029  y {name}',.    )
-0002c6c0: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
-0002c6d0: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
-0002c6e0: 742e 6d61 726b 2e6e 6f5f 666c 7569 6473  t.mark.no_fluids
-0002c6f0: 7461 636b 2020 2320 466c 7569 6473 7461  tack  # Fluidsta
-0002c700: 636b 2068 6173 206c 6f77 2061 7661 696c  ck has low avail
-0002c710: 6162 696c 6974 7920 666f 7220 5434 2047  ability for T4 G
-0002c720: 5055 730a 6465 6620 7465 7374 5f6d 756c  PUs.def test_mul
-0002c730: 7469 706c 655f 6163 6365 6c65 7261 746f  tiple_accelerato
-0002c740: 7273 5f75 6e6f 7264 6572 6564 5f77 6974  rs_unordered_wit
-0002c750: 685f 6465 6661 756c 7428 293a 0a20 2020  h_default():.   
-0002c760: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
-0002c770: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
-0002c780: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
-0002c790: 2020 2020 2027 6d75 6c74 6970 6c65 2d61       'multiple-a
-0002c7a0: 6363 656c 6572 6174 6f72 732d 756e 6f72  ccelerators-unor
-0002c7b0: 6465 7265 6427 2c0a 2020 2020 2020 2020  dered',.        
-0002c7c0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
-0002c7d0: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
-0002c7e0: 207b 6e61 6d65 7d20 7465 7374 732f 7465   {name} tests/te
-0002c7f0: 7374 5f79 616d 6c73 2f74 6573 745f 6d75  st_yamls/test_mu
-0002c800: 6c74 6970 6c65 5f61 6363 656c 6572 6174  ltiple_accelerat
-0002c810: 6f72 735f 756e 6f72 6465 7265 645f 7769  ors_unordered_wi
-0002c820: 7468 5f64 6566 6175 6c74 2e79 616d 6c27  th_default.yaml'
-0002c830: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
-0002c840: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
-0002c850: 3120 2d2d 7374 6174 7573 272c 2020 2320  1 --status',  # 
-0002c860: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
-0002c870: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
-0002c880: 2020 2020 2020 6627 736b 7920 7374 6174        f'sky stat
-0002c890: 7573 207b 6e61 6d65 7d20 7c20 6772 6570  us {name} | grep
-0002c8a0: 2053 706f 7427 2c0a 2020 2020 2020 2020   Spot',.        
-0002c8b0: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
-0002c8c0: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-0002c8d0: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
-0002c8e0: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-0002c8f0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
-0002c900: 5f66 6c75 6964 7374 6163 6b20 2023 2052  _fluidstack  # R
-0002c910: 6571 7569 7265 7320 6f74 6865 7220 636c  equires other cl
-0002c920: 6f75 6473 2074 6f20 6265 2065 6e61 626c  ouds to be enabl
-0002c930: 6564 0a64 6566 2074 6573 745f 6d75 6c74  ed.def test_mult
-0002c940: 6970 6c65 5f72 6573 6f75 7263 6573 2829  iple_resources()
-0002c950: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
-0002c960: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
-0002c970: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
-0002c980: 280a 2020 2020 2020 2020 276d 756c 7469  (.        'multi
-0002c990: 706c 652d 7265 736f 7572 6365 7327 2c0a  ple-resources',.
-0002c9a0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-0002c9b0: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
-0002c9c0: 6368 202d 7920 2d63 207b 6e61 6d65 7d20  ch -y -c {name} 
-0002c9d0: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
-0002c9e0: 2f74 6573 745f 6d75 6c74 6970 6c65 5f72  /test_multiple_r
-0002c9f0: 6573 6f75 7263 6573 2e79 616d 6c27 2c0a  esources.yaml',.
-0002ca00: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
-0002ca10: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
-0002ca20: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
-0002ca30: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
-0002ca40: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
-0002ca50: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
-0002ca60: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
-0002ca70: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
-0002ca80: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
-0002ca90: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 536b  .# ---------- Sk
-0002caa0: 7920 4265 6e63 686d 6172 6b20 2d2d 2d2d  y Benchmark ----
-0002cab0: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
-0002cac0: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
-0002cad0: 6b20 2023 2052 6571 7569 7265 7320 6f74  k  # Requires ot
-0002cae0: 6865 7220 636c 6f75 6473 2074 6f20 6265  her clouds to be
-0002caf0: 2065 6e61 626c 6564 0a40 7079 7465 7374   enabled.@pytest
-0002cb00: 2e6d 6172 6b2e 6e6f 5f6b 7562 6572 6e65  .mark.no_kuberne
-0002cb10: 7465 730a 6465 6620 7465 7374 5f73 6b79  tes.def test_sky
-0002cb20: 5f62 656e 6368 2867 656e 6572 6963 5f63  _bench(generic_c
-0002cb30: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
-0002cb40: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
-0002cb50: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
-0002cb60: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
-0002cb70: 2020 2020 2773 6b79 2d62 656e 6368 272c      'sky-bench',
-0002cb80: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
-0002cb90: 2020 2020 2020 2066 2773 6b79 2062 656e         f'sky ben
-0002cba0: 6368 206c 6175 6e63 6820 2d79 202d 6220  ch launch -y -b 
-0002cbb0: 7b6e 616d 657d 202d 2d63 6c6f 7564 207b  {name} --cloud {
-0002cbc0: 6765 6e65 7269 635f 636c 6f75 647d 202d  generic_cloud} -
-0002cbd0: 6930 2074 6573 7473 2f74 6573 745f 7961  i0 tests/test_ya
-0002cbe0: 6d6c 732f 6d69 6e69 6d61 6c2e 7961 6d6c  mls/minimal.yaml
-0002cbf0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
-0002cc00: 736c 6565 7020 3132 3027 2c0a 2020 2020  sleep 120',.    
-0002cc10: 2020 2020 2020 2020 6627 736b 7920 6265          f'sky be
-0002cc20: 6e63 6820 7368 6f77 207b 6e61 6d65 7d20  nch show {name} 
-0002cc30: 7c20 6772 6570 2073 6b79 2d62 656e 6368  | grep sky-bench
-0002cc40: 2d7b 6e61 6d65 7d20 7c20 6772 6570 2046  -{name} | grep F
-0002cc50: 494e 4953 4845 4427 2c0a 2020 2020 2020  INISHED',.      
-0002cc60: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
-0002cc70: 6b79 2062 656e 6368 2064 6f77 6e20 7b6e  ky bench down {n
-0002cc80: 616d 657d 202d 793b 2073 6b79 2062 656e  ame} -y; sky ben
-0002cc90: 6368 2064 656c 6574 6520 7b6e 616d 657d  ch delete {name}
-0002cca0: 202d 7927 2c0a 2020 2020 290a 2020 2020   -y',.    ).    
-0002ccb0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
-0002ccc0: 7429 0a                                  t).
+00010f20: 206a 6f62 2073 7563 6365 6564 6564 2e0a   job succeeded..
+00010f30: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00010f40: 7920 6c61 756e 6368 202d 7920 2d63 207b  y launch -y -c {
+00010f50: 6e61 6d65 7d20 6578 616d 706c 6573 2f74  name} examples/t
+00010f60: 7075 2f74 7075 5f61 7070 2e79 616d 6c20  pu/tpu_app.yaml 
+00010f70: 7c20 6772 6570 2022 5450 5520 2e2a 2061  | grep "TPU .* a
+00010f80: 6c72 6561 6479 2065 7869 7374 7322 272c  lready exists"',
+00010f90: 2020 2320 456e 7375 7265 2073 6b79 206c    # Ensure sky l
+00010fa0: 6175 6e63 6820 776f 6e27 7420 6372 6561  aunch won't crea
+00010fb0: 7465 2061 6e6f 7468 6572 2054 5055 2e0a  te another TPU..
+00010fc0: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+00010fd0: 2020 2066 2773 6b79 2064 6f77 6e20 2d79     f'sky down -y
+00010fe0: 207b 6e61 6d65 7d27 2c0a 2020 2020 2020   {name}',.      
+00010ff0: 2020 7469 6d65 6f75 743d 3330 202a 2036    timeout=30 * 6
+00011000: 302c 2020 2320 6361 6e20 7461 6b65 203e  0,  # can take >
+00011010: 3230 206d 696e 730a 2020 2020 290a 2020  20 mins.    ).  
+00011020: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00011030: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
+00011040: 2d2d 2d20 5450 5520 564d 2e20 2d2d 2d2d  --- TPU VM. ----
+00011050: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
+00011060: 6172 6b2e 6763 700a 4070 7974 6573 742e  ark.gcp.@pytest.
+00011070: 6d61 726b 2e74 7075 0a64 6566 2074 6573  mark.tpu.def tes
+00011080: 745f 7470 755f 766d 2829 3a0a 2020 2020  t_tpu_vm():.    
+00011090: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+000110a0: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+000110b0: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+000110c0: 2020 2020 2774 7075 5f76 6d5f 6170 7027      'tpu_vm_app'
+000110d0: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+000110e0: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+000110f0: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
+00011100: 7d20 6578 616d 706c 6573 2f74 7075 2f74  } examples/tpu/t
+00011110: 7075 766d 5f6d 6e69 7374 2e79 616d 6c27  puvm_mnist.yaml'
+00011120: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00011130: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+00011140: 3127 2c20 2023 2045 6e73 7572 6520 7468  1',  # Ensure th
+00011150: 6520 6a6f 6220 6669 6e69 7368 6564 2e0a  e job finished..
+00011160: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00011170: 7920 6c6f 6773 207b 6e61 6d65 7d20 3120  y logs {name} 1 
+00011180: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
+00011190: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
+000111a0: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
+000111b0: 2020 2020 6627 736b 7920 7374 6f70 202d      f'sky stop -
+000111c0: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
+000111d0: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
+000111e0: 2073 7461 7475 7320 7b6e 616d 657d 202d   status {name} -
+000111f0: 2d72 6566 7265 7368 293b 2065 6368 6f20  -refresh); echo 
+00011200: 2224 7322 3b20 6563 686f 3b20 6563 686f  "$s"; echo; echo
+00011210: 3b20 6563 686f 2022 2473 2220 207c 2067  ; echo "$s"  | g
+00011220: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
+00011230: 7020 5354 4f50 5045 4427 2c20 2023 2045  p STOPPED',  # E
+00011240: 6e73 7572 6520 7468 6520 636c 7573 7465  nsure the cluste
+00011250: 7220 6973 2053 544f 5050 4544 2e0a 2020  r is STOPPED..  
+00011260: 2020 2020 2020 2020 2020 2320 5573 6520            # Use 
+00011270: 7265 7472 793a 2067 7561 7264 2061 6761  retry: guard aga
+00011280: 696e 7374 2074 7261 6e73 6965 6e74 2065  inst transient e
+00011290: 7272 6f72 7320 6f62 7365 7276 6564 2066  rrors observed f
+000112a0: 6f72 0a20 2020 2020 2020 2020 2020 2023  or.            #
+000112b0: 206a 7573 742d 7374 6f70 7065 6420 5450   just-stopped TP
+000112c0: 5520 564d 7320 2823 3936 3229 2e0a 2020  U VMs (#962)..  
+000112d0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000112e0: 7374 6172 7420 2d2d 7265 7472 792d 756e  start --retry-un
+000112f0: 7469 6c2d 7570 202d 7920 7b6e 616d 657d  til-up -y {name}
+00011300: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00011310: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+00011320: 2065 7861 6d70 6c65 732f 7470 752f 7470   examples/tpu/tp
+00011330: 7576 6d5f 6d6e 6973 742e 7961 6d6c 272c  uvm_mnist.yaml',
+00011340: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00011350: 6b79 206c 6f67 7320 7b6e 616d 657d 2032  ky logs {name} 2
+00011360: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+00011370: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+00011380: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
+00011390: 2020 2020 2066 2773 6b79 2073 746f 7020       f'sky stop 
+000113a0: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+000113b0: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+000113c0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+000113d0: 6d65 7d27 2c0a 2020 2020 2020 2020 7469  me}',.        ti
+000113e0: 6d65 6f75 743d 3330 202a 2036 302c 2020  meout=30 * 60,  
+000113f0: 2320 6361 6e20 7461 6b65 2033 3020 6d69  # can take 30 mi
+00011400: 6e73 0a20 2020 2029 0a20 2020 2072 756e  ns.    ).    run
+00011410: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+00011420: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054  ..# ---------- T
+00011430: 5055 2056 4d20 506f 642e 202d 2d2d 2d2d  PU VM Pod. -----
+00011440: 2d2d 2d2d 2d0a 4070 7974 6573 742e 6d61  -----.@pytest.ma
+00011450: 726b 2e67 6370 0a40 7079 7465 7374 2e6d  rk.gcp.@pytest.m
+00011460: 6172 6b2e 7470 750a 6465 6620 7465 7374  ark.tpu.def test
+00011470: 5f74 7075 5f76 6d5f 706f 6428 293a 0a20  _tpu_vm_pod():. 
+00011480: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+00011490: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+000114a0: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+000114b0: 2020 2020 2020 2027 7470 755f 706f 6427         'tpu_pod'
+000114c0: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+000114d0: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+000114e0: 756e 6368 202d 7920 2d63 207b 6e61 6d65  unch -y -c {name
+000114f0: 7d20 6578 616d 706c 6573 2f74 7075 2f74  } examples/tpu/t
+00011500: 7075 766d 5f6d 6e69 7374 2e79 616d 6c20  puvm_mnist.yaml 
+00011510: 2d2d 6770 7573 2074 7075 2d76 322d 3332  --gpus tpu-v2-32
+00011520: 202d 2d75 7365 2d73 706f 7420 2d2d 7a6f   --use-spot --zo
+00011530: 6e65 2065 7572 6f70 652d 7765 7374 342d  ne europe-west4-
+00011540: 6127 2c0a 2020 2020 2020 2020 2020 2020  a',.            
+00011550: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00011560: 7d20 3127 2c20 2023 2045 6e73 7572 6520  } 1',  # Ensure 
+00011570: 7468 6520 6a6f 6220 6669 6e69 7368 6564  the job finished
+00011580: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00011590: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+000115a0: 3120 2d2d 7374 6174 7573 272c 2020 2320  1 --status',  # 
+000115b0: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
+000115c0: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
+000115d0: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
+000115e0: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+000115f0: 7d27 2c0a 2020 2020 2020 2020 7469 6d65  }',.        time
+00011600: 6f75 743d 3330 202a 2036 302c 2020 2320  out=30 * 60,  # 
+00011610: 6361 6e20 7461 6b65 2033 3020 6d69 6e73  can take 30 mins
+00011620: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00011630: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00011640: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2053 696d  # ---------- Sim
+00011650: 706c 6520 6170 7073 2e20 2d2d 2d2d 2d2d  ple apps. ------
+00011660: 2d2d 2d2d 0a40 7079 7465 7374 2e6d 6172  ----.@pytest.mar
+00011670: 6b2e 6e6f 5f73 6370 2020 2320 5343 5020  k.no_scp  # SCP 
+00011680: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
+00011690: 206e 756d 5f6e 6f64 6573 203e 2031 2079   num_nodes > 1 y
+000116a0: 6574 0a64 6566 2074 6573 745f 6d75 6c74  et.def test_mult
+000116b0: 695f 686f 7374 6e61 6d65 2867 656e 6572  i_hostname(gener
+000116c0: 6963 5f63 6c6f 7564 3a20 7374 7229 3a0a  ic_cloud: str):.
+000116d0: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+000116e0: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+000116f0: 2020 2074 6f74 616c 5f74 696d 656f 7574     total_timeout
+00011700: 5f6d 696e 7574 6573 203d 2032 3520 6966  _minutes = 25 if
+00011710: 2067 656e 6572 6963 5f63 6c6f 7564 203d   generic_cloud =
+00011720: 3d20 2761 7a75 7265 2720 656c 7365 2031  = 'azure' else 1
+00011730: 350a 2020 2020 7465 7374 203d 2054 6573  5.    test = Tes
+00011740: 7428 0a20 2020 2020 2020 2027 6d75 6c74  t(.        'mult
+00011750: 695f 686f 7374 6e61 6d65 272c 0a20 2020  i_hostname',.   
+00011760: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+00011770: 2020 2066 2773 6b79 206c 6175 6e63 6820     f'sky launch 
+00011780: 2d79 202d 6320 7b6e 616d 657d 202d 2d63  -y -c {name} --c
+00011790: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
+000117a0: 6f75 647d 2065 7861 6d70 6c65 732f 6d75  oud} examples/mu
+000117b0: 6c74 695f 686f 7374 6e61 6d65 2e79 616d  lti_hostname.yam
+000117c0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+000117d0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+000117e0: 7d20 3120 2d2d 7374 6174 7573 272c 2020  } 1 --status',  
+000117f0: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
+00011800: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
+00011810: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+00011820: 6773 207b 6e61 6d65 7d20 3120 7c20 6772  gs {name} 1 | gr
+00011830: 6570 2022 4d79 2068 6f73 746e 616d 653a  ep "My hostname:
+00011840: 2220 7c20 7763 202d 6c20 7c20 6772 6570  " | wc -l | grep
+00011850: 2032 272c 2020 2320 456e 7375 7265 2074   2',  # Ensure t
+00011860: 6865 7265 2061 7265 2032 2068 6f73 7473  here are 2 hosts
+00011870: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00011880: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+00011890: 6578 616d 706c 6573 2f6d 756c 7469 5f68  examples/multi_h
+000118a0: 6f73 746e 616d 652e 7961 6d6c 272c 0a20  ostname.yaml',. 
+000118b0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000118c0: 206c 6f67 7320 7b6e 616d 657d 2032 202d   logs {name} 2 -
+000118d0: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
+000118e0: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
+000118f0: 6565 6465 642e 0a20 2020 2020 2020 205d  eeded..        ]
+00011900: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+00011910: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+00011920: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
+00011930: 3d5f 6765 745f 7469 6d65 6f75 7428 6765  =_get_timeout(ge
+00011940: 6e65 7269 635f 636c 6f75 642c 2074 6f74  neric_cloud, tot
+00011950: 616c 5f74 696d 656f 7574 5f6d 696e 7574  al_timeout_minut
+00011960: 6573 202a 2036 3029 2c0a 2020 2020 290a  es * 60),.    ).
+00011970: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+00011980: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
+00011990: 2e6d 6172 6b2e 6e6f 5f73 6370 2020 2320  .mark.no_scp  # 
+000119a0: 5343 5020 646f 6573 206e 6f74 2073 7570  SCP does not sup
+000119b0: 706f 7274 206e 756d 5f6e 6f64 6573 203e  port num_nodes >
+000119c0: 2031 2079 6574 0a64 6566 2074 6573 745f   1 yet.def test_
+000119d0: 6d75 6c74 695f 6e6f 6465 5f66 6169 6c75  multi_node_failu
+000119e0: 7265 2867 656e 6572 6963 5f63 6c6f 7564  re(generic_cloud
+000119f0: 3a20 7374 7229 3a0a 2020 2020 6e61 6d65  : str):.    name
+00011a00: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+00011a10: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+00011a20: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+00011a30: 276d 756c 7469 5f6e 6f64 655f 6661 696c  'multi_node_fail
+00011a40: 7572 6527 2c0a 2020 2020 2020 2020 5b0a  ure',.        [.
+00011a50: 2020 2020 2020 2020 2020 2020 2320 544f              # TO
+00011a60: 444f 287a 6877 7529 3a20 7765 2075 7365  DO(zhwu): we use
+00011a70: 206d 756c 7469 2d74 6872 6561 6420 746f   multi-thread to
+00011a80: 2072 756e 2074 6865 2063 6f6d 6d61 6e64   run the command
+00011a90: 7320 696e 2073 6574 7570 0a20 2020 2020  s in setup.     
+00011aa0: 2020 2020 2020 2023 2063 6f6d 6d61 6e64         # command
+00011ab0: 7320 696e 2070 6172 616c 6c65 6c2c 2077  s in parallel, w
+00011ac0: 6869 6368 206d 616b 6573 2069 7420 696d  hich makes it im
+00011ad0: 706f 7373 6962 6c65 2074 6f20 6661 696c  possible to fail
+00011ae0: 2066 6173 740a 2020 2020 2020 2020 2020   fast.          
+00011af0: 2020 2320 7768 656e 206f 6e65 206f 6620    # when one of 
+00011b00: 7468 6520 6e6f 6465 7320 6661 696c 732e  the nodes fails.
+00011b10: 2057 6520 7368 6f75 6c64 2066 6978 2074   We should fix t
+00011b20: 6869 7320 696e 2074 6865 2066 7574 7572  his in the futur
+00011b30: 652e 0a20 2020 2020 2020 2020 2020 2023  e..            #
+00011b40: 2054 6865 202d 2d64 6574 6163 682d 7365   The --detach-se
+00011b50: 7475 7020 7665 7273 696f 6e20 6361 6e20  tup version can 
+00011b60: 6661 696c 2066 6173 742c 2061 7320 7468  fail fast, as th
+00011b70: 6520 7365 7475 7020 6973 0a20 2020 2020  e setup is.     
+00011b80: 2020 2020 2020 2023 2073 7562 6d69 7474         # submitt
+00011b90: 6564 2074 6f20 7468 6520 7265 6d6f 7465  ed to the remote
+00011ba0: 206d 6163 6869 6e65 2c20 7768 6963 6820   machine, which 
+00011bb0: 646f 6573 206e 6f74 2075 7365 206d 756c  does not use mul
+00011bc0: 7469 2d74 6872 6561 642e 0a20 2020 2020  ti-thread..     
+00011bd0: 2020 2020 2020 2023 2052 6566 6572 2074         # Refer t
+00011be0: 6f20 7468 6520 636f 6d6d 656e 7420 696e  o the comment in
+00011bf0: 2060 7375 6270 726f 6365 7373 5f75 7469   `subprocess_uti
+00011c00: 6c73 2e72 756e 5f69 6e5f 7061 7261 6c6c  ls.run_in_parall
+00011c10: 656c 602e 0a20 2020 2020 2020 2020 2020  el`..           
+00011c20: 2023 2066 2773 6b79 206c 6175 6e63 6820   # f'sky launch 
+00011c30: 2d79 202d 6320 7b6e 616d 657d 202d 2d63  -y -c {name} --c
+00011c40: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
+00011c50: 6f75 647d 2074 6573 7473 2f74 6573 745f  oud} tests/test_
+00011c60: 7961 6d6c 732f 6661 696c 6564 5f77 6f72  yamls/failed_wor
+00011c70: 6b65 725f 7365 7475 702e 7961 6d6c 2026  ker_setup.yaml &
+00011c80: 2620 6578 6974 2031 272c 2020 2320 456e  & exit 1',  # En
+00011c90: 7375 7265 2074 6865 206a 6f62 2073 6574  sure the job set
+00011ca0: 7570 2066 6169 6c65 642e 0a20 2020 2020  up failed..     
+00011cb0: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
+00011cc0: 6e63 6820 2d79 202d 6320 7b6e 616d 657d  nch -y -c {name}
+00011cd0: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
+00011ce0: 635f 636c 6f75 647d 202d 2d64 6574 6163  c_cloud} --detac
+00011cf0: 682d 7365 7475 7020 7465 7374 732f 7465  h-setup tests/te
+00011d00: 7374 5f79 616d 6c73 2f66 6169 6c65 645f  st_yamls/failed_
+00011d10: 776f 726b 6572 5f73 6574 7570 2e79 616d  worker_setup.yam
+00011d20: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00011d30: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00011d40: 7d20 3120 2d2d 7374 6174 7573 207c 2067  } 1 --status | g
+00011d50: 7265 7020 4641 494c 4544 5f53 4554 5550  rep FAILED_SETUP
+00011d60: 272c 2020 2320 456e 7375 7265 2074 6865  ',  # Ensure the
+00011d70: 206a 6f62 2073 6574 7570 2066 6169 6c65   job setup faile
+00011d80: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
+00011d90: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+00011da0: 2074 6573 7473 2f74 6573 745f 7961 6d6c   tests/test_yaml
+00011db0: 732f 6661 696c 6564 5f77 6f72 6b65 725f  s/failed_worker_
+00011dc0: 7275 6e2e 7961 6d6c 272c 0a20 2020 2020  run.yaml',.     
+00011dd0: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00011de0: 7320 7b6e 616d 657d 2032 202d 2d73 7461  s {name} 2 --sta
+00011df0: 7475 7320 7c20 6772 6570 2046 4149 4c45  tus | grep FAILE
+00011e00: 4427 2c20 2023 2045 6e73 7572 6520 7468  D',  # Ensure th
+00011e10: 6520 6a6f 6220 6661 696c 6564 2e0a 2020  e job failed..  
+00011e20: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00011e30: 6c6f 6773 207b 6e61 6d65 7d20 3220 7c20  logs {name} 2 | 
+00011e40: 6772 6570 2022 4d79 2068 6f73 746e 616d  grep "My hostnam
+00011e50: 653a 2220 7c20 7763 202d 6c20 7c20 6772  e:" | wc -l | gr
+00011e60: 6570 2032 272c 2020 2320 456e 7375 7265  ep 2',  # Ensure
+00011e70: 2074 6865 7265 2032 206f 6620 7468 6520   there 2 of the 
+00011e80: 686f 7374 7320 7072 696e 7465 6420 7468  hosts printed th
+00011e90: 6569 7220 686f 7374 6e61 6d65 2e0a 2020  eir hostname..  
+00011ea0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+00011eb0: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+00011ec0: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
+00011ed0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00011ee0: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
+00011ef0: 2d2d 2d20 5765 6220 6170 7073 2077 6974  --- Web apps wit
+00011f00: 6820 6375 7374 6f6d 2070 6f72 7473 206f  h custom ports o
+00011f10: 6e20 4743 502e 202d 2d2d 2d2d 2d2d 2d2d  n GCP. ---------
+00011f20: 2d0a 4070 7974 6573 742e 6d61 726b 2e67  -.@pytest.mark.g
+00011f30: 6370 0a64 6566 2074 6573 745f 6763 705f  cp.def test_gcp_
+00011f40: 6874 7470 5f73 6572 7665 725f 7769 7468  http_server_with
+00011f50: 5f63 7573 746f 6d5f 706f 7274 7328 293a  _custom_ports():
+00011f60: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+00011f70: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+00011f80: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+00011f90: 0a20 2020 2020 2020 2027 6763 705f 6874  .        'gcp_ht
+00011fa0: 7470 5f73 6572 7665 725f 7769 7468 5f63  tp_server_with_c
+00011fb0: 7573 746f 6d5f 706f 7274 7327 2c0a 2020  ustom_ports',.  
+00011fc0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+00011fd0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+00011fe0: 202d 7920 2d64 202d 6320 7b6e 616d 657d   -y -d -c {name}
+00011ff0: 202d 2d63 6c6f 7564 2067 6370 2065 7861   --cloud gcp exa
+00012000: 6d70 6c65 732f 6874 7470 5f73 6572 7665  mples/http_serve
+00012010: 725f 7769 7468 5f63 7573 746f 6d5f 706f  r_with_custom_po
+00012020: 7274 732f 7461 736b 2e79 616d 6c27 2c0a  rts/task.yaml',.
+00012030: 2020 2020 2020 2020 2020 2020 6627 756e              f'un
+00012040: 7469 6c20 534b 5950 494c 4f54 5f44 4542  til SKYPILOT_DEB
+00012050: 5547 3d30 2073 6b79 2073 7461 7475 7320  UG=0 sky status 
+00012060: 2d2d 656e 6470 6f69 6e74 2033 3338 3238  --endpoint 33828
+00012070: 207b 6e61 6d65 7d3b 2064 6f20 736c 6565   {name}; do slee
+00012080: 7020 3130 3b20 646f 6e65 272c 0a20 2020  p 10; done',.   
+00012090: 2020 2020 2020 2020 2023 2052 6574 7279           # Retry
+000120a0: 2061 2066 6577 2074 696d 6573 2074 6f20   a few times to 
+000120b0: 6176 6f69 6420 666c 616b 696e 6573 7320  avoid flakiness 
+000120c0: 696e 2070 6f72 7473 2062 6569 6e67 206f  in ports being o
+000120d0: 7065 6e2e 0a20 2020 2020 2020 2020 2020  pen..           
+000120e0: 2066 2769 703d 2428 534b 5950 494c 4f54   f'ip=$(SKYPILOT
+000120f0: 5f44 4542 5547 3d30 2073 6b79 2073 7461  _DEBUG=0 sky sta
+00012100: 7475 7320 2d2d 656e 6470 6f69 6e74 2033  tus --endpoint 3
+00012110: 3338 3238 207b 6e61 6d65 7d29 3b20 7375  3828 {name}); su
+00012120: 6363 6573 733d 6661 6c73 653b 2066 6f72  ccess=false; for
+00012130: 2069 2069 6e20 2428 7365 7120 3120 3529   i in $(seq 1 5)
+00012140: 3b20 646f 2069 6620 6375 726c 2024 6970  ; do if curl $ip
+00012150: 207c 2067 7265 7020 223c 6831 3e54 6869   | grep "<h1>Thi
+00012160: 7320 6973 2061 2064 656d 6f20 4854 4d4c  s is a demo HTML
+00012170: 2070 6167 652e 3c2f 6831 3e22 3b20 7468   page.</h1>"; th
+00012180: 656e 2073 7563 6365 7373 3d74 7275 653b  en success=true;
+00012190: 2062 7265 616b 3b20 6669 3b20 736c 6565   break; fi; slee
+000121a0: 7020 3130 3b20 646f 6e65 3b20 6966 205b  p 10; done; if [
+000121b0: 2022 2473 7563 6365 7373 2220 3d20 6661   "$success" = fa
+000121c0: 6c73 6520 5d3b 2074 6865 6e20 6578 6974  lse ]; then exit
+000121d0: 2031 3b20 6669 272c 0a20 2020 2020 2020   1; fi',.       
+000121e0: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
+000121f0: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+00012200: 272c 0a20 2020 2029 0a20 2020 2072 756e  ',.    ).    run
+00012210: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+00012220: 0a0a 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2057  ..# ---------- W
+00012230: 6562 2061 7070 7320 7769 7468 2063 7573  eb apps with cus
+00012240: 746f 6d20 706f 7274 7320 6f6e 2041 5753  tom ports on AWS
+00012250: 2e20 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079  . ----------.@py
+00012260: 7465 7374 2e6d 6172 6b2e 6177 730a 6465  test.mark.aws.de
+00012270: 6620 7465 7374 5f61 7773 5f68 7474 705f  f test_aws_http_
+00012280: 7365 7276 6572 5f77 6974 685f 6375 7374  server_with_cust
+00012290: 6f6d 5f70 6f72 7473 2829 3a0a 2020 2020  om_ports():.    
+000122a0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+000122b0: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+000122c0: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+000122d0: 2020 2020 2761 7773 5f68 7474 705f 7365      'aws_http_se
+000122e0: 7276 6572 5f77 6974 685f 6375 7374 6f6d  rver_with_custom
+000122f0: 5f70 6f72 7473 272c 0a20 2020 2020 2020  _ports',.       
+00012300: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+00012310: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+00012320: 6420 2d63 207b 6e61 6d65 7d20 2d2d 636c  d -c {name} --cl
+00012330: 6f75 6420 6177 7320 6578 616d 706c 6573  oud aws examples
+00012340: 2f68 7474 705f 7365 7276 6572 5f77 6974  /http_server_wit
+00012350: 685f 6375 7374 6f6d 5f70 6f72 7473 2f74  h_custom_ports/t
+00012360: 6173 6b2e 7961 6d6c 272c 0a20 2020 2020  ask.yaml',.     
+00012370: 2020 2020 2020 2066 2775 6e74 696c 2053         f'until S
+00012380: 4b59 5049 4c4f 545f 4445 4255 473d 3020  KYPILOT_DEBUG=0 
+00012390: 736b 7920 7374 6174 7573 202d 2d65 6e64  sky status --end
+000123a0: 706f 696e 7420 3333 3832 3820 7b6e 616d  point 33828 {nam
+000123b0: 657d 3b20 646f 2073 6c65 6570 2031 303b  e}; do sleep 10;
+000123c0: 2064 6f6e 6527 2c0a 2020 2020 2020 2020   done',.        
+000123d0: 2020 2020 2320 5265 7472 7920 6120 6665      # Retry a fe
+000123e0: 7720 7469 6d65 7320 746f 2061 766f 6964  w times to avoid
+000123f0: 2066 6c61 6b69 6e65 7373 2069 6e20 706f   flakiness in po
+00012400: 7274 7320 6265 696e 6720 6f70 656e 2e0a  rts being open..
+00012410: 2020 2020 2020 2020 2020 2020 6627 6970              f'ip
+00012420: 3d24 2853 4b59 5049 4c4f 545f 4445 4255  =$(SKYPILOT_DEBU
+00012430: 473d 3020 736b 7920 7374 6174 7573 202d  G=0 sky status -
+00012440: 2d65 6e64 706f 696e 7420 3333 3832 3820  -endpoint 33828 
+00012450: 7b6e 616d 657d 293b 2073 7563 6365 7373  {name}); success
+00012460: 3d66 616c 7365 3b20 666f 7220 6920 696e  =false; for i in
+00012470: 2024 2873 6571 2031 2035 293b 2064 6f20   $(seq 1 5); do 
+00012480: 6966 2063 7572 6c20 2469 7020 7c20 6772  if curl $ip | gr
+00012490: 6570 2022 3c68 313e 5468 6973 2069 7320  ep "<h1>This is 
+000124a0: 6120 6465 6d6f 2048 544d 4c20 7061 6765  a demo HTML page
+000124b0: 2e3c 2f68 313e 223b 2074 6865 6e20 7375  .</h1>"; then su
+000124c0: 6363 6573 733d 7472 7565 3b20 6272 6561  ccess=true; brea
+000124d0: 6b3b 2066 693b 2073 6c65 6570 2031 303b  k; fi; sleep 10;
+000124e0: 2064 6f6e 653b 2069 6620 5b20 2224 7375   done; if [ "$su
+000124f0: 6363 6573 7322 203d 2066 616c 7365 205d  ccess" = false ]
+00012500: 3b20 7468 656e 2065 7869 7420 313b 2066  ; then exit 1; f
+00012510: 6927 0a20 2020 2020 2020 205d 2c0a 2020  i'.        ],.  
+00012520: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+00012530: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+00012540: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+00012550: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
+00012560: 2d2d 2d2d 2d2d 2d2d 2057 6562 2061 7070  -------- Web app
+00012570: 7320 7769 7468 2063 7573 746f 6d20 706f  s with custom po
+00012580: 7274 7320 6f6e 2041 7a75 7265 2e20 2d2d  rts on Azure. --
+00012590: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
+000125a0: 2e6d 6172 6b2e 617a 7572 650a 6465 6620  .mark.azure.def 
+000125b0: 7465 7374 5f61 7a75 7265 5f68 7474 705f  test_azure_http_
+000125c0: 7365 7276 6572 5f77 6974 685f 6375 7374  server_with_cust
+000125d0: 6f6d 5f70 6f72 7473 2829 3a0a 2020 2020  om_ports():.    
+000125e0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+000125f0: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+00012600: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+00012610: 2020 2020 2761 7a75 7265 5f68 7474 705f      'azure_http_
+00012620: 7365 7276 6572 5f77 6974 685f 6375 7374  server_with_cust
+00012630: 6f6d 5f70 6f72 7473 272c 0a20 2020 2020  om_ports',.     
+00012640: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00012650: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+00012660: 202d 6420 2d63 207b 6e61 6d65 7d20 2d2d   -d -c {name} --
+00012670: 636c 6f75 6420 617a 7572 6520 6578 616d  cloud azure exam
+00012680: 706c 6573 2f68 7474 705f 7365 7276 6572  ples/http_server
+00012690: 5f77 6974 685f 6375 7374 6f6d 5f70 6f72  _with_custom_por
+000126a0: 7473 2f74 6173 6b2e 7961 6d6c 272c 0a20  ts/task.yaml',. 
+000126b0: 2020 2020 2020 2020 2020 2066 2775 6e74             f'unt
+000126c0: 696c 2053 4b59 5049 4c4f 545f 4445 4255  il SKYPILOT_DEBU
+000126d0: 473d 3020 736b 7920 7374 6174 7573 202d  G=0 sky status -
+000126e0: 2d65 6e64 706f 696e 7420 3333 3832 3820  -endpoint 33828 
+000126f0: 7b6e 616d 657d 3b20 646f 2073 6c65 6570  {name}; do sleep
+00012700: 2031 303b 2064 6f6e 6527 2c0a 2020 2020   10; done',.    
+00012710: 2020 2020 2020 2020 2320 5265 7472 7920          # Retry 
+00012720: 6120 6665 7720 7469 6d65 7320 746f 2061  a few times to a
+00012730: 766f 6964 2066 6c61 6b69 6e65 7373 2069  void flakiness i
+00012740: 6e20 706f 7274 7320 6265 696e 6720 6f70  n ports being op
+00012750: 656e 2e0a 2020 2020 2020 2020 2020 2020  en..            
+00012760: 6627 6970 3d24 2853 4b59 5049 4c4f 545f  f'ip=$(SKYPILOT_
+00012770: 4445 4255 473d 3020 736b 7920 7374 6174  DEBUG=0 sky stat
+00012780: 7573 202d 2d65 6e64 706f 696e 7420 3333  us --endpoint 33
+00012790: 3832 3820 7b6e 616d 657d 293b 2073 7563  828 {name}); suc
+000127a0: 6365 7373 3d66 616c 7365 3b20 666f 7220  cess=false; for 
+000127b0: 6920 696e 2024 2873 6571 2031 2035 293b  i in $(seq 1 5);
+000127c0: 2064 6f20 6966 2063 7572 6c20 2469 7020   do if curl $ip 
+000127d0: 7c20 6772 6570 2022 3c68 313e 5468 6973  | grep "<h1>This
+000127e0: 2069 7320 6120 6465 6d6f 2048 544d 4c20   is a demo HTML 
+000127f0: 7061 6765 2e3c 2f68 313e 223b 2074 6865  page.</h1>"; the
+00012800: 6e20 7375 6363 6573 733d 7472 7565 3b20  n success=true; 
+00012810: 6272 6561 6b3b 2066 693b 2073 6c65 6570  break; fi; sleep
+00012820: 2031 303b 2064 6f6e 653b 2069 6620 5b20   10; done; if [ 
+00012830: 2224 7375 6363 6573 7322 203d 2066 616c  "$success" = fal
+00012840: 7365 205d 3b20 7468 656e 2065 7869 7420  se ]; then exit 
+00012850: 313b 2066 6927 0a20 2020 2020 2020 205d  1; fi'.        ]
+00012860: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+00012870: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+00012880: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00012890: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+000128a0: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2057 6562  # ---------- Web
+000128b0: 2061 7070 7320 7769 7468 2063 7573 746f   apps with custo
+000128c0: 6d20 706f 7274 7320 6f6e 204b 7562 6572  m ports on Kuber
+000128d0: 6e65 7465 732e 202d 2d2d 2d2d 2d2d 2d2d  netes. ---------
+000128e0: 2d0a 4070 7974 6573 742e 6d61 726b 2e6b  -.@pytest.mark.k
+000128f0: 7562 6572 6e65 7465 730a 6465 6620 7465  ubernetes.def te
+00012900: 7374 5f6b 7562 6572 6e65 7465 735f 6874  st_kubernetes_ht
+00012910: 7470 5f73 6572 7665 725f 7769 7468 5f63  tp_server_with_c
+00012920: 7573 746f 6d5f 706f 7274 7328 293a 0a20  ustom_ports():. 
+00012930: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+00012940: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+00012950: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+00012960: 2020 2020 2020 2027 6b75 6265 726e 6574         'kubernet
+00012970: 6573 5f68 7474 705f 7365 7276 6572 5f77  es_http_server_w
+00012980: 6974 685f 6375 7374 6f6d 5f70 6f72 7473  ith_custom_ports
+00012990: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+000129a0: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+000129b0: 6175 6e63 6820 2d79 202d 6420 2d63 207b  aunch -y -d -c {
+000129c0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 6b75  name} --cloud ku
+000129d0: 6265 726e 6574 6573 2065 7861 6d70 6c65  bernetes example
+000129e0: 732f 6874 7470 5f73 6572 7665 725f 7769  s/http_server_wi
+000129f0: 7468 5f63 7573 746f 6d5f 706f 7274 732f  th_custom_ports/
+00012a00: 7461 736b 2e79 616d 6c27 2c0a 2020 2020  task.yaml',.    
+00012a10: 2020 2020 2020 2020 6627 756e 7469 6c20          f'until 
+00012a20: 534b 5950 494c 4f54 5f44 4542 5547 3d30  SKYPILOT_DEBUG=0
+00012a30: 2073 6b79 2073 7461 7475 7320 2d2d 656e   sky status --en
+00012a40: 6470 6f69 6e74 2033 3338 3238 207b 6e61  dpoint 33828 {na
+00012a50: 6d65 7d3b 2064 6f20 736c 6565 7020 3130  me}; do sleep 10
+00012a60: 3b20 646f 6e65 272c 0a20 2020 2020 2020  ; done',.       
+00012a70: 2020 2020 2023 2052 6574 7279 2061 2066       # Retry a f
+00012a80: 6577 2074 696d 6573 2074 6f20 6176 6f69  ew times to avoi
+00012a90: 6420 666c 616b 696e 6573 7320 696e 2070  d flakiness in p
+00012aa0: 6f72 7473 2062 6569 6e67 206f 7065 6e2e  orts being open.
+00012ab0: 0a20 2020 2020 2020 2020 2020 2066 2769  .            f'i
+00012ac0: 703d 2428 534b 5950 494c 4f54 5f44 4542  p=$(SKYPILOT_DEB
+00012ad0: 5547 3d30 2073 6b79 2073 7461 7475 7320  UG=0 sky status 
+00012ae0: 2d2d 656e 6470 6f69 6e74 2033 3338 3238  --endpoint 33828
+00012af0: 207b 6e61 6d65 7d29 3b20 7375 6363 6573   {name}); succes
+00012b00: 733d 6661 6c73 653b 2066 6f72 2069 2069  s=false; for i i
+00012b10: 6e20 2428 7365 7120 3120 3130 3029 3b20  n $(seq 1 100); 
+00012b20: 646f 2069 6620 6375 726c 2024 6970 207c  do if curl $ip |
+00012b30: 2067 7265 7020 223c 6831 3e54 6869 7320   grep "<h1>This 
+00012b40: 6973 2061 2064 656d 6f20 4854 4d4c 2070  is a demo HTML p
+00012b50: 6167 652e 3c2f 6831 3e22 3b20 7468 656e  age.</h1>"; then
+00012b60: 2073 7563 6365 7373 3d74 7275 653b 2062   success=true; b
+00012b70: 7265 616b 3b20 6669 3b20 736c 6565 7020  reak; fi; sleep 
+00012b80: 353b 2064 6f6e 653b 2069 6620 5b20 2224  5; done; if [ "$
+00012b90: 7375 6363 6573 7322 203d 2066 616c 7365  success" = false
+00012ba0: 205d 3b20 7468 656e 2065 7869 7420 313b   ]; then exit 1;
+00012bb0: 2066 6927 0a20 2020 2020 2020 205d 2c0a   fi'.        ],.
+00012bc0: 2020 2020 2020 2020 6627 736b 7920 646f          f'sky do
+00012bd0: 776e 202d 7920 7b6e 616d 657d 272c 0a20  wn -y {name}',. 
+00012be0: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+00012bf0: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
+00012c00: 2d2d 2d2d 2d2d 2d2d 2d2d 2057 6562 2061  ---------- Web a
+00012c10: 7070 7320 7769 7468 2063 7573 746f 6d20  pps with custom 
+00012c20: 706f 7274 7320 6f6e 2050 6170 6572 7370  ports on Papersp
+00012c30: 6163 652e 202d 2d2d 2d2d 2d2d 2d2d 2d0a  ace. ----------.
+00012c40: 4070 7974 6573 742e 6d61 726b 2e70 6170  @pytest.mark.pap
+00012c50: 6572 7370 6163 650a 6465 6620 7465 7374  erspace.def test
+00012c60: 5f70 6170 6572 7370 6163 655f 6874 7470  _paperspace_http
+00012c70: 5f73 6572 7665 725f 7769 7468 5f63 7573  _server_with_cus
+00012c80: 746f 6d5f 706f 7274 7328 293a 0a20 2020  tom_ports():.   
+00012c90: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+00012ca0: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+00012cb0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+00012cc0: 2020 2020 2027 7061 7065 7273 7061 6365       'paperspace
+00012cd0: 5f68 7474 705f 7365 7276 6572 5f77 6974  _http_server_wit
+00012ce0: 685f 6375 7374 6f6d 5f70 6f72 7473 272c  h_custom_ports',
+00012cf0: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+00012d00: 2020 2020 2020 2066 2773 6b79 206c 6175         f'sky lau
+00012d10: 6e63 6820 2d79 202d 6420 2d63 207b 6e61  nch -y -d -c {na
+00012d20: 6d65 7d20 2d2d 636c 6f75 6420 7061 7065  me} --cloud pape
+00012d30: 7273 7061 6365 2065 7861 6d70 6c65 732f  rspace examples/
+00012d40: 6874 7470 5f73 6572 7665 725f 7769 7468  http_server_with
+00012d50: 5f63 7573 746f 6d5f 706f 7274 732f 7461  _custom_ports/ta
+00012d60: 736b 2e79 616d 6c27 2c0a 2020 2020 2020  sk.yaml',.      
+00012d70: 2020 2020 2020 6627 756e 7469 6c20 534b        f'until SK
+00012d80: 5950 494c 4f54 5f44 4542 5547 3d30 2073  YPILOT_DEBUG=0 s
+00012d90: 6b79 2073 7461 7475 7320 2d2d 656e 6470  ky status --endp
+00012da0: 6f69 6e74 2033 3338 3238 207b 6e61 6d65  oint 33828 {name
+00012db0: 7d3b 2064 6f20 736c 6565 7020 3130 3b20  }; do sleep 10; 
+00012dc0: 646f 6e65 272c 0a20 2020 2020 2020 2020  done',.         
+00012dd0: 2020 2023 2052 6574 7279 2061 2066 6577     # Retry a few
+00012de0: 2074 696d 6573 2074 6f20 6176 6f69 6420   times to avoid 
+00012df0: 666c 616b 696e 6573 7320 696e 2070 6f72  flakiness in por
+00012e00: 7473 2062 6569 6e67 206f 7065 6e2e 0a20  ts being open.. 
+00012e10: 2020 2020 2020 2020 2020 2066 2769 703d             f'ip=
+00012e20: 2428 534b 5950 494c 4f54 5f44 4542 5547  $(SKYPILOT_DEBUG
+00012e30: 3d30 2073 6b79 2073 7461 7475 7320 2d2d  =0 sky status --
+00012e40: 656e 6470 6f69 6e74 2033 3338 3238 207b  endpoint 33828 {
+00012e50: 6e61 6d65 7d29 3b20 7375 6363 6573 733d  name}); success=
+00012e60: 6661 6c73 653b 2066 6f72 2069 2069 6e20  false; for i in 
+00012e70: 2428 7365 7120 3120 3529 3b20 646f 2069  $(seq 1 5); do i
+00012e80: 6620 6375 726c 2024 6970 207c 2067 7265  f curl $ip | gre
+00012e90: 7020 223c 6831 3e54 6869 7320 6973 2061  p "<h1>This is a
+00012ea0: 2064 656d 6f20 4854 4d4c 2070 6167 652e   demo HTML page.
+00012eb0: 3c2f 6831 3e22 3b20 7468 656e 2073 7563  </h1>"; then suc
+00012ec0: 6365 7373 3d74 7275 653b 2062 7265 616b  cess=true; break
+00012ed0: 3b20 6669 3b20 736c 6565 7020 3130 3b20  ; fi; sleep 10; 
+00012ee0: 646f 6e65 3b20 6966 205b 2022 2473 7563  done; if [ "$suc
+00012ef0: 6365 7373 2220 3d20 6661 6c73 6520 5d3b  cess" = false ];
+00012f00: 2074 6865 6e20 6578 6974 2031 3b20 6669   then exit 1; fi
+00012f10: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+00012f20: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+00012f30: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+00012f40: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+00012f50: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
+00012f60: 2d2d 2d2d 2d2d 2d2d 204c 6162 656c 7320  -------- Labels 
+00012f70: 6672 6f6d 2074 6173 6b20 6f6e 2041 5753  from task on AWS
+00012f80: 2028 696e 7374 616e 6365 5f74 6167 7329   (instance_tags)
+00012f90: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974   ----------.@pyt
+00012fa0: 6573 742e 6d61 726b 2e61 7773 0a64 6566  est.mark.aws.def
+00012fb0: 2074 6573 745f 7461 736b 5f6c 6162 656c   test_task_label
+00012fc0: 735f 6177 7328 293a 0a20 2020 206e 616d  s_aws():.    nam
+00012fd0: 6520 3d20 5f67 6574 5f63 6c75 7374 6572  e = _get_cluster
+00012fe0: 5f6e 616d 6528 290a 2020 2020 7465 6d70  _name().    temp
+00012ff0: 6c61 7465 5f73 7472 203d 2070 6174 686c  late_str = pathl
+00013000: 6962 2e50 6174 6828 0a20 2020 2020 2020  ib.Path(.       
+00013010: 2027 7465 7374 732f 7465 7374 5f79 616d   'tests/test_yam
+00013020: 6c73 2f74 6573 745f 6c61 6265 6c73 2e79  ls/test_labels.y
+00013030: 616d 6c2e 6a32 2729 2e72 6561 645f 7465  aml.j2').read_te
+00013040: 7874 2829 0a20 2020 2074 656d 706c 6174  xt().    templat
+00013050: 6520 3d20 6a69 6e6a 6132 2e54 656d 706c  e = jinja2.Templ
+00013060: 6174 6528 7465 6d70 6c61 7465 5f73 7472  ate(template_str
+00013070: 290a 2020 2020 636f 6e74 656e 7420 3d20  ).    content = 
+00013080: 7465 6d70 6c61 7465 2e72 656e 6465 7228  template.render(
+00013090: 636c 6f75 643d 2761 7773 272c 2072 6567  cloud='aws', reg
+000130a0: 696f 6e3d 2775 732d 6561 7374 2d31 2729  ion='us-east-1')
+000130b0: 0a20 2020 2077 6974 6820 7465 6d70 6669  .    with tempfi
+000130c0: 6c65 2e4e 616d 6564 5465 6d70 6f72 6172  le.NamedTemporar
+000130d0: 7946 696c 6528 7375 6666 6978 3d27 2e79  yFile(suffix='.y
+000130e0: 616d 6c27 2c20 6d6f 6465 3d27 7727 2920  aml', mode='w') 
+000130f0: 6173 2066 3a0a 2020 2020 2020 2020 662e  as f:.        f.
+00013100: 7772 6974 6528 636f 6e74 656e 7429 0a20  write(content). 
+00013110: 2020 2020 2020 2066 2e66 6c75 7368 2829         f.flush()
+00013120: 0a20 2020 2020 2020 2066 696c 655f 7061  .        file_pa
+00013130: 7468 203d 2066 2e6e 616d 650a 2020 2020  th = f.name.    
+00013140: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+00013150: 0a20 2020 2020 2020 2020 2020 2027 7461  .            'ta
+00013160: 736b 5f6c 6162 656c 735f 6177 7327 2c0a  sk_labels_aws',.
+00013170: 2020 2020 2020 2020 2020 2020 5b0a 2020              [.  
+00013180: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+00013190: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+000131a0: 207b 6e61 6d65 7d20 7b66 696c 655f 7061   {name} {file_pa
+000131b0: 7468 7d27 2c0a 2020 2020 2020 2020 2020  th}',.          
+000131c0: 2020 2020 2020 2320 5665 7269 6679 2077        # Verify w
+000131d0: 6974 6820 6177 7320 636c 6920 7468 6174  ith aws cli that
+000131e0: 2074 6865 2074 6167 7320 6172 6520 7365   the tags are se
+000131f0: 742e 0a20 2020 2020 2020 2020 2020 2020  t..             
+00013200: 2020 2027 6177 7320 6563 3220 6465 7363     'aws ec2 desc
+00013210: 7269 6265 2d69 6e73 7461 6e63 6573 2027  ribe-instances '
+00013220: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013230: 2027 2d2d 7175 6572 7920 2252 6573 6572   '--query "Reser
+00013240: 7661 7469 6f6e 735b 2a5d 2e49 6e73 7461  vations[*].Insta
+00013250: 6e63 6573 5b2a 5d2e 496e 7374 616e 6365  nces[*].Instance
+00013260: 4964 2220 270a 2020 2020 2020 2020 2020  Id" '.          
+00013270: 2020 2020 2020 272d 2d66 696c 7465 7273        '--filters
+00013280: 2022 4e61 6d65 3d69 6e73 7461 6e63 652d   "Name=instance-
+00013290: 7374 6174 652d 6e61 6d65 2c56 616c 7565  state-name,Value
+000132a0: 733d 7275 6e6e 696e 6722 2027 0a20 2020  s=running" '.   
+000132b0: 2020 2020 2020 2020 2020 2020 2066 272d               f'-
+000132c0: 2d66 696c 7465 7273 2022 4e61 6d65 3d74  -filters "Name=t
+000132d0: 6167 3a73 6b79 7069 6c6f 742d 636c 7573  ag:skypilot-clus
+000132e0: 7465 722d 6e61 6d65 2c56 616c 7565 733d  ter-name,Values=
+000132f0: 7b6e 616d 657d 2a22 2027 0a20 2020 2020  {name}*" '.     
+00013300: 2020 2020 2020 2020 2020 2027 2d2d 6669             '--fi
+00013310: 6c74 6572 7320 224e 616d 653d 7461 673a  lters "Name=tag:
+00013320: 696e 6c69 6e65 6c61 6265 6c31 2c56 616c  inlinelabel1,Val
+00013330: 7565 733d 696e 6c69 6e65 7661 6c75 6531  ues=inlinevalue1
+00013340: 2220 270a 2020 2020 2020 2020 2020 2020  " '.            
+00013350: 2020 2020 272d 2d66 696c 7465 7273 2022      '--filters "
+00013360: 4e61 6d65 3d74 6167 3a69 6e6c 696e 656c  Name=tag:inlinel
+00013370: 6162 656c 322c 5661 6c75 6573 3d69 6e6c  abel2,Values=inl
+00013380: 696e 6576 616c 7565 3222 2027 0a20 2020  inevalue2" '.   
+00013390: 2020 2020 2020 2020 2020 2020 2027 2d2d               '--
+000133a0: 7265 6769 6f6e 2075 732d 6561 7374 2d31  region us-east-1
+000133b0: 202d 2d6f 7574 7075 7420 7465 7874 272c   --output text',
+000133c0: 0a20 2020 2020 2020 2020 2020 205d 2c0a  .            ],.
+000133d0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+000133e0: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+000133f0: 272c 0a20 2020 2020 2020 2029 0a20 2020  ',.        ).   
+00013400: 2020 2020 2072 756e 5f6f 6e65 5f74 6573       run_one_tes
+00013410: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
+00013420: 2d2d 2d2d 2d2d 204c 6162 656c 7320 6672  ------ Labels fr
+00013430: 6f6d 2074 6173 6b20 6f6e 2047 4350 2028  om task on GCP (
+00013440: 6c61 6265 6c73 2920 2d2d 2d2d 2d2d 2d2d  labels) --------
+00013450: 2d2d 0a40 7079 7465 7374 2e6d 6172 6b2e  --.@pytest.mark.
+00013460: 6763 700a 6465 6620 7465 7374 5f74 6173  gcp.def test_tas
+00013470: 6b5f 6c61 6265 6c73 5f67 6370 2829 3a0a  k_labels_gcp():.
+00013480: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+00013490: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+000134a0: 2020 2074 656d 706c 6174 655f 7374 7220     template_str 
+000134b0: 3d20 7061 7468 6c69 622e 5061 7468 280a  = pathlib.Path(.
+000134c0: 2020 2020 2020 2020 2774 6573 7473 2f74          'tests/t
+000134d0: 6573 745f 7961 6d6c 732f 7465 7374 5f6c  est_yamls/test_l
+000134e0: 6162 656c 732e 7961 6d6c 2e6a 3227 292e  abels.yaml.j2').
+000134f0: 7265 6164 5f74 6578 7428 290a 2020 2020  read_text().    
+00013500: 7465 6d70 6c61 7465 203d 206a 696e 6a61  template = jinja
+00013510: 322e 5465 6d70 6c61 7465 2874 656d 706c  2.Template(templ
+00013520: 6174 655f 7374 7229 0a20 2020 2063 6f6e  ate_str).    con
+00013530: 7465 6e74 203d 2074 656d 706c 6174 652e  tent = template.
+00013540: 7265 6e64 6572 2863 6c6f 7564 3d27 6763  render(cloud='gc
+00013550: 7027 290a 2020 2020 7769 7468 2074 656d  p').    with tem
+00013560: 7066 696c 652e 4e61 6d65 6454 656d 706f  pfile.NamedTempo
+00013570: 7261 7279 4669 6c65 2873 7566 6669 783d  raryFile(suffix=
+00013580: 272e 7961 6d6c 272c 206d 6f64 653d 2777  '.yaml', mode='w
+00013590: 2729 2061 7320 663a 0a20 2020 2020 2020  ') as f:.       
+000135a0: 2066 2e77 7269 7465 2863 6f6e 7465 6e74   f.write(content
+000135b0: 290a 2020 2020 2020 2020 662e 666c 7573  ).        f.flus
+000135c0: 6828 290a 2020 2020 2020 2020 6669 6c65  h().        file
+000135d0: 5f70 6174 6820 3d20 662e 6e61 6d65 0a20  _path = f.name. 
+000135e0: 2020 2020 2020 2074 6573 7420 3d20 5465         test = Te
+000135f0: 7374 280a 2020 2020 2020 2020 2020 2020  st(.            
+00013600: 2774 6173 6b5f 6c61 6265 6c73 5f67 6370  'task_labels_gcp
+00013610: 272c 0a20 2020 2020 2020 2020 2020 205b  ',.            [
+00013620: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013630: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+00013640: 202d 6320 7b6e 616d 657d 207b 6669 6c65   -c {name} {file
+00013650: 5f70 6174 687d 272c 0a20 2020 2020 2020  _path}',.       
+00013660: 2020 2020 2020 2020 2023 2056 6572 6966           # Verif
+00013670: 7920 7769 7468 2067 636c 6f75 6420 636c  y with gcloud cl
+00013680: 6920 7468 6174 2074 6865 2074 6167 7320  i that the tags 
+00013690: 6172 6520 7365 740a 2020 2020 2020 2020  are set.        
+000136a0: 2020 2020 2020 2020 6627 6763 6c6f 7564          f'gcloud
+000136b0: 2063 6f6d 7075 7465 2069 6e73 7461 6e63   compute instanc
+000136c0: 6573 206c 6973 7420 2d2d 6669 6c74 6572  es list --filter
+000136d0: 3d22 6e61 6d65 7e5c 275e 7b6e 616d 657d  ="name~\'^{name}
+000136e0: 5c27 2041 4e44 2027 0a20 2020 2020 2020  \' AND '.       
+000136f0: 2020 2020 2020 2020 2027 6c61 6265 6c73           'labels
+00013700: 2e69 6e6c 696e 656c 6162 656c 313d 5c27  .inlinelabel1=\'
+00013710: 696e 6c69 6e65 7661 6c75 6531 5c27 2041  inlinevalue1\' A
+00013720: 4e44 2027 0a20 2020 2020 2020 2020 2020  ND '.           
+00013730: 2020 2020 2027 6c61 6265 6c73 2e69 6e6c       'labels.inl
+00013740: 696e 656c 6162 656c 323d 5c27 696e 6c69  inelabel2=\'inli
+00013750: 6e65 7661 6c75 6532 5c27 2220 270a 2020  nevalue2\'" '.  
+00013760: 2020 2020 2020 2020 2020 2020 2020 272d                '-
+00013770: 2d66 6f72 6d61 743d 2276 616c 7565 286e  -format="value(n
+00013780: 616d 6529 2220 7c20 6772 6570 202e 272c  ame)" | grep .',
+00013790: 0a20 2020 2020 2020 2020 2020 205d 2c0a  .            ],.
+000137a0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+000137b0: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+000137c0: 272c 0a20 2020 2020 2020 2029 0a20 2020  ',.        ).   
+000137d0: 2020 2020 2072 756e 5f6f 6e65 5f74 6573       run_one_tes
+000137e0: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
+000137f0: 2d2d 2d2d 2d2d 204c 6162 656c 7320 6672  ------ Labels fr
+00013800: 6f6d 2074 6173 6b20 6f6e 204b 7562 6572  om task on Kuber
+00013810: 6e65 7465 7320 286c 6162 656c 7329 202d  netes (labels) -
+00013820: 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974 6573  ---------.@pytes
+00013830: 742e 6d61 726b 2e6b 7562 6572 6e65 7465  t.mark.kubernete
+00013840: 730a 6465 6620 7465 7374 5f74 6173 6b5f  s.def test_task_
+00013850: 6c61 6265 6c73 5f6b 7562 6572 6e65 7465  labels_kubernete
+00013860: 7328 293a 0a20 2020 206e 616d 6520 3d20  s():.    name = 
+00013870: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+00013880: 6528 290a 2020 2020 7465 6d70 6c61 7465  e().    template
+00013890: 5f73 7472 203d 2070 6174 686c 6962 2e50  _str = pathlib.P
+000138a0: 6174 6828 0a20 2020 2020 2020 2027 7465  ath(.        'te
+000138b0: 7374 732f 7465 7374 5f79 616d 6c73 2f74  sts/test_yamls/t
+000138c0: 6573 745f 6c61 6265 6c73 2e79 616d 6c2e  est_labels.yaml.
+000138d0: 6a32 2729 2e72 6561 645f 7465 7874 2829  j2').read_text()
+000138e0: 0a20 2020 2074 656d 706c 6174 6520 3d20  .    template = 
+000138f0: 6a69 6e6a 6132 2e54 656d 706c 6174 6528  jinja2.Template(
+00013900: 7465 6d70 6c61 7465 5f73 7472 290a 2020  template_str).  
+00013910: 2020 636f 6e74 656e 7420 3d20 7465 6d70    content = temp
+00013920: 6c61 7465 2e72 656e 6465 7228 636c 6f75  late.render(clou
+00013930: 643d 276b 7562 6572 6e65 7465 7327 290a  d='kubernetes').
+00013940: 2020 2020 7769 7468 2074 656d 7066 696c      with tempfil
+00013950: 652e 4e61 6d65 6454 656d 706f 7261 7279  e.NamedTemporary
+00013960: 4669 6c65 2873 7566 6669 783d 272e 7961  File(suffix='.ya
+00013970: 6d6c 272c 206d 6f64 653d 2777 2729 2061  ml', mode='w') a
+00013980: 7320 663a 0a20 2020 2020 2020 2066 2e77  s f:.        f.w
+00013990: 7269 7465 2863 6f6e 7465 6e74 290a 2020  rite(content).  
+000139a0: 2020 2020 2020 662e 666c 7573 6828 290a        f.flush().
+000139b0: 2020 2020 2020 2020 6669 6c65 5f70 6174          file_pat
+000139c0: 6820 3d20 662e 6e61 6d65 0a20 2020 2020  h = f.name.     
+000139d0: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+000139e0: 2020 2020 2020 2020 2020 2020 2774 6173              'tas
+000139f0: 6b5f 6c61 6265 6c73 5f6b 7562 6572 6e65  k_labels_kuberne
+00013a00: 7465 7327 2c0a 2020 2020 2020 2020 2020  tes',.          
+00013a10: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+00013a20: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+00013a30: 202d 7920 2d63 207b 6e61 6d65 7d20 7b66   -y -c {name} {f
+00013a40: 696c 655f 7061 7468 7d27 2c0a 2020 2020  ile_path}',.    
+00013a50: 2020 2020 2020 2020 2020 2020 2320 5665              # Ve
+00013a60: 7269 6679 2077 6974 6820 6b75 6265 6374  rify with kubect
+00013a70: 6c20 7468 6174 2074 6865 206c 6162 656c  l that the label
+00013a80: 7320 6172 6520 7365 742e 0a20 2020 2020  s are set..     
+00013a90: 2020 2020 2020 2020 2020 2027 6b75 6265             'kube
+00013aa0: 6374 6c20 6765 7420 706f 6473 2027 0a20  ctl get pods '. 
+00013ab0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00013ac0: 2d2d 7365 6c65 6374 6f72 2069 6e6c 696e  --selector inlin
+00013ad0: 656c 6162 656c 313d 696e 6c69 6e65 7661  elabel1=inlineva
+00013ae0: 6c75 6531 2027 0a20 2020 2020 2020 2020  lue1 '.         
+00013af0: 2020 2020 2020 2027 2d2d 7365 6c65 6374         '--select
+00013b00: 6f72 2069 6e6c 696e 656c 6162 656c 323d  or inlinelabel2=
+00013b10: 696e 6c69 6e65 7661 6c75 6532 2027 0a20  inlinevalue2 '. 
+00013b20: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00013b30: 2d6f 206a 736f 6e70 6174 683d 5c27 7b2e  -o jsonpath=\'{.
+00013b40: 6974 656d 735b 2a5d 2e6d 6574 6164 6174  items[*].metadat
+00013b50: 612e 6e61 6d65 7d5c 2720 7c20 270a 2020  a.name}\' | '.  
+00013b60: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+00013b70: 6772 6570 205c 275e 7b6e 616d 657d 5c27  grep \'^{name}\'
+00013b80: 270a 2020 2020 2020 2020 2020 2020 5d2c  '.            ],
+00013b90: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00013ba0: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+00013bb0: 7d27 2c0a 2020 2020 2020 2020 290a 2020  }',.        ).  
+00013bc0: 2020 2020 2020 7275 6e5f 6f6e 655f 7465        run_one_te
+00013bd0: 7374 2874 6573 7429 0a0a 0a23 202d 2d2d  st(test)...# ---
+00013be0: 2d2d 2d2d 2d2d 2d20 5461 736b 3a20 6e3d  ------- Task: n=
+00013bf0: 3220 6e6f 6465 7320 7769 7468 2073 6574  2 nodes with set
+00013c00: 7570 732e 202d 2d2d 2d2d 2d2d 2d2d 2d0a  ups. ----------.
+00013c10: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00013c20: 6c61 6d62 6461 5f63 6c6f 7564 2020 2320  lambda_cloud  # 
+00013c30: 4c61 6d62 6461 2043 6c6f 7564 2064 6f65  Lambda Cloud doe
+00013c40: 7320 6e6f 7420 6861 7665 2056 3130 3020  s not have V100 
+00013c50: 6770 7573 0a40 7079 7465 7374 2e6d 6172  gpus.@pytest.mar
+00013c60: 6b2e 6e6f 5f69 626d 2020 2320 4942 4d20  k.no_ibm  # IBM 
+00013c70: 636c 6f75 6420 6375 7272 656e 746c 7920  cloud currently 
+00013c80: 646f 6573 6e27 7420 7072 6f76 6964 6520  doesn't provide 
+00013c90: 7075 626c 6963 2069 6d61 6765 2077 6974  public image wit
+00013ca0: 6820 4355 4441 0a40 7079 7465 7374 2e6d  h CUDA.@pytest.m
+00013cb0: 6172 6b2e 6e6f 5f73 6370 2020 2320 5343  ark.no_scp  # SC
+00013cc0: 5020 646f 6573 206e 6f74 2073 7570 706f  P does not suppo
+00013cd0: 7274 206e 756d 5f6e 6f64 6573 203e 2031  rt num_nodes > 1
+00013ce0: 2079 6574 0a40 7079 7465 7374 2e6d 6172   yet.@pytest.mar
+00013cf0: 6b2e 736b 6970 280a 2020 2020 7265 6173  k.skip(.    reas
+00013d00: 6f6e 3d0a 2020 2020 2754 6865 2072 6573  on=.    'The res
+00013d10: 6e65 745f 6469 7374 7269 6275 7465 645f  net_distributed_
+00013d20: 7466 5f61 7070 2069 7320 666c 616b 792c  tf_app is flaky,
+00013d30: 2064 7565 2074 6f20 6974 2066 6169 6c69   due to it faili
+00013d40: 6e67 2074 6f20 6465 7465 6374 2047 5055  ng to detect GPU
+00013d50: 732e 2729 0a64 6566 2074 6573 745f 6469  s.').def test_di
+00013d60: 7374 7269 6275 7465 645f 7466 2867 656e  stributed_tf(gen
+00013d70: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
+00013d80: 3a0a 2020 2020 6e61 6d65 203d 205f 6765  :.    name = _ge
+00013d90: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+00013da0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+00013db0: 280a 2020 2020 2020 2020 2772 6573 6e65  (.        'resne
+00013dc0: 745f 6469 7374 7269 6275 7465 645f 7466  t_distributed_tf
+00013dd0: 5f61 7070 272c 0a20 2020 2020 2020 205b  _app',.        [
+00013de0: 0a20 2020 2020 2020 2020 2020 2023 204e  .            # N
+00013df0: 4f54 453a 2072 756e 6e69 6e67 2069 7420  OTE: running it 
+00013e00: 7477 6963 6520 7769 6c6c 2068 616e 6720  twice will hang 
+00013e10: 2873 6f6d 6574 696d 6573 3f29 202d 2061  (sometimes?) - a
+00013e20: 6e20 6170 702d 6c65 7665 6c20 6275 672e  n app-level bug.
+00013e30: 0a20 2020 2020 2020 2020 2020 2066 2770  .            f'p
+00013e40: 7974 686f 6e20 6578 616d 706c 6573 2f72  ython examples/r
+00013e50: 6573 6e65 745f 6469 7374 7269 6275 7465  esnet_distribute
+00013e60: 645f 7466 5f61 7070 2e70 7920 7b6e 616d  d_tf_app.py {nam
+00013e70: 657d 207b 6765 6e65 7269 635f 636c 6f75  e} {generic_clou
+00013e80: 647d 272c 0a20 2020 2020 2020 2020 2020  d}',.           
+00013e90: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+00013ea0: 657d 2031 202d 2d73 7461 7475 7327 2c20  e} 1 --status', 
+00013eb0: 2023 2045 6e73 7572 6520 7468 6520 6a6f   # Ensure the jo
+00013ec0: 6220 7375 6363 6565 6465 642e 0a20 2020  b succeeded..   
+00013ed0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+00013ee0: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
+00013ef0: 616d 657d 272c 0a20 2020 2020 2020 2074  ame}',.        t
+00013f00: 696d 656f 7574 3d32 3520 2a20 3630 2c20  imeout=25 * 60, 
+00013f10: 2023 2032 3520 6d69 6e73 2028 6974 2074   # 25 mins (it t
+00013f20: 616b 6573 2061 726f 756e 6420 7e31 3920  akes around ~19 
+00013f30: 6d69 6e73 290a 2020 2020 290a 2020 2020  mins).    ).    
+00013f40: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+00013f50: 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d  t)...# ---------
+00013f60: 2d20 5465 7374 696e 6720 4743 5020 7374  - Testing GCP st
+00013f70: 6172 7420 616e 6420 7374 6f70 2069 6e73  art and stop ins
+00013f80: 7461 6e63 6573 202d 2d2d 2d2d 2d2d 2d2d  tances ---------
+00013f90: 2d0a 4070 7974 6573 742e 6d61 726b 2e67  -.@pytest.mark.g
+00013fa0: 6370 0a64 6566 2074 6573 745f 6763 705f  cp.def test_gcp_
+00013fb0: 7374 6172 745f 7374 6f70 2829 3a0a 2020  start_stop():.  
+00013fc0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+00013fd0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+00013fe0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+00013ff0: 2020 2020 2020 2767 6370 2d73 7461 7274        'gcp-start
+00014000: 2d73 746f 7027 2c0a 2020 2020 2020 2020  -stop',.        
+00014010: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+00014020: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+00014030: 207b 6e61 6d65 7d20 6578 616d 706c 6573   {name} examples
+00014040: 2f67 6370 5f73 7461 7274 5f73 746f 702e  /gcp_start_stop.
+00014050: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00014060: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+00014070: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
+00014080: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
+00014090: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
+000140a0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000140b0: 2065 7865 6320 7b6e 616d 657d 2065 7861   exec {name} exa
+000140c0: 6d70 6c65 732f 6763 705f 7374 6172 745f  mples/gcp_start_
+000140d0: 7374 6f70 2e79 616d 6c27 2c0a 2020 2020  stop.yaml',.    
+000140e0: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+000140f0: 6773 207b 6e61 6d65 7d20 3220 2d2d 7374  gs {name} 2 --st
+00014100: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
+00014110: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
+00014120: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+00014130: 6627 736b 7920 6578 6563 207b 6e61 6d65  f'sky exec {name
+00014140: 7d20 2270 726c 696d 6974 202d 6e20 2d2d  } "prlimit -n --
+00014150: 7069 643d 5c24 2870 6772 6570 202d 6620  pid=\$(pgrep -f 
+00014160: 5c27 7261 796c 6574 2f72 6179 6c65 7420  \'raylet/raylet 
+00014170: 2d2d 7261 796c 6574 5f73 6f63 6b65 745f  --raylet_socket_
+00014180: 6e61 6d65 5c27 2920 7c20 6772 6570 205c  name\') | grep \
+00014190: 2722 5c27 3130 3438 3537 3620 3130 3438  '"\'1048576 1048
+000141a0: 3537 365c 2722 5c27 2227 2c20 2023 2045  576\'"\'"',  # E
+000141b0: 6e73 7572 6520 7468 6520 7261 796c 6574  nsure the raylet
+000141c0: 2070 726f 6365 7373 2068 6173 2074 6865   process has the
+000141d0: 2063 6f72 7265 6374 2066 696c 6520 6465   correct file de
+000141e0: 7363 7269 7074 6f72 206c 696d 6974 2e0a  scriptor limit..
+000141f0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00014200: 7920 6c6f 6773 207b 6e61 6d65 7d20 3320  y logs {name} 3 
+00014210: 2d2d 7374 6174 7573 272c 2020 2320 456e  --status',  # En
+00014220: 7375 7265 2074 6865 206a 6f62 2073 7563  sure the job suc
+00014230: 6365 6564 6564 2e0a 2020 2020 2020 2020  ceeded..        
+00014240: 2020 2020 6627 736b 7920 7374 6f70 202d      f'sky stop -
+00014250: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
+00014260: 2020 2020 2020 2066 2773 6c65 6570 2032         f'sleep 2
+00014270: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+00014280: 6627 736b 7920 7374 6172 7420 2d79 207b  f'sky start -y {
+00014290: 6e61 6d65 7d20 2d69 2031 272c 0a20 2020  name} -i 1',.   
+000142a0: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+000142b0: 7865 6320 7b6e 616d 657d 2065 7861 6d70  xec {name} examp
+000142c0: 6c65 732f 6763 705f 7374 6172 745f 7374  les/gcp_start_st
+000142d0: 6f70 2e79 616d 6c27 2c0a 2020 2020 2020  op.yaml',.      
+000142e0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+000142f0: 207b 6e61 6d65 7d20 3420 2d2d 7374 6174   {name} 4 --stat
+00014300: 7573 272c 2020 2320 456e 7375 7265 2074  us',  # Ensure t
+00014310: 6865 206a 6f62 2073 7563 6365 6564 6564  he job succeeded
+00014320: 2e0a 2020 2020 2020 2020 2020 2020 2773  ..            's
+00014330: 6c65 6570 2031 3830 272c 0a20 2020 2020  leep 180',.     
+00014340: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
+00014350: 7475 7320 2d72 207b 6e61 6d65 7d20 7c20  tus -r {name} | 
+00014360: 6772 6570 2022 494e 4954 5c7c 5354 4f50  grep "INIT\|STOP
+00014370: 5045 4422 272c 0a20 2020 2020 2020 205d  PED"',.        ]
+00014380: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+00014390: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+000143a0: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+000143b0: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+000143c0: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573  # ---------- Tes
+000143d0: 7469 6e67 2041 7a75 7265 2073 7461 7274  ting Azure start
+000143e0: 2061 6e64 2073 746f 7020 696e 7374 616e   and stop instan
+000143f0: 6365 7320 2d2d 2d2d 2d2d 2d2d 2d2d 0a40  ces ----------.@
+00014400: 7079 7465 7374 2e6d 6172 6b2e 617a 7572  pytest.mark.azur
+00014410: 650a 6465 6620 7465 7374 5f61 7a75 7265  e.def test_azure
+00014420: 5f73 7461 7274 5f73 746f 7028 293a 0a20  _start_stop():. 
+00014430: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+00014440: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+00014450: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+00014460: 2020 2020 2020 2027 617a 7572 652d 7374         'azure-st
+00014470: 6172 742d 7374 6f70 272c 0a20 2020 2020  art-stop',.     
+00014480: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00014490: 2066 2773 6b79 206c 6175 6e63 6820 2d79   f'sky launch -y
+000144a0: 202d 6320 7b6e 616d 657d 2065 7861 6d70   -c {name} examp
+000144b0: 6c65 732f 617a 7572 655f 7374 6172 745f  les/azure_start_
+000144c0: 7374 6f70 2e79 616d 6c27 2c0a 2020 2020  stop.yaml',.    
+000144d0: 2020 2020 2020 2020 6627 736b 7920 6578          f'sky ex
+000144e0: 6563 207b 6e61 6d65 7d20 6578 616d 706c  ec {name} exampl
+000144f0: 6573 2f61 7a75 7265 5f73 7461 7274 5f73  es/azure_start_s
+00014500: 746f 702e 7961 6d6c 272c 0a20 2020 2020  top.yaml',.     
+00014510: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00014520: 7320 7b6e 616d 657d 2031 202d 2d73 7461  s {name} 1 --sta
+00014530: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
+00014540: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
+00014550: 642e 0a20 2020 2020 2020 2020 2020 2066  d..            f
+00014560: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+00014570: 2022 7072 6c69 6d69 7420 2d6e 202d 2d70   "prlimit -n --p
+00014580: 6964 3d5c 2428 7067 7265 7020 2d66 205c  id=\$(pgrep -f \
+00014590: 2772 6179 6c65 742f 7261 796c 6574 202d  'raylet/raylet -
+000145a0: 2d72 6179 6c65 745f 736f 636b 6574 5f6e  -raylet_socket_n
+000145b0: 616d 655c 2729 207c 2067 7265 7020 5c27  ame\') | grep \'
+000145c0: 225c 2731 3034 3835 3736 2031 3034 3835  "\'1048576 10485
+000145d0: 3736 5c27 225c 2722 272c 2020 2320 456e  76\'"\'"',  # En
+000145e0: 7375 7265 2074 6865 2072 6179 6c65 7420  sure the raylet 
+000145f0: 7072 6f63 6573 7320 6861 7320 7468 6520  process has the 
+00014600: 636f 7272 6563 7420 6669 6c65 2064 6573  correct file des
+00014610: 6372 6970 746f 7220 6c69 6d69 742e 0a20  criptor limit.. 
+00014620: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00014630: 206c 6f67 7320 7b6e 616d 657d 2032 202d   logs {name} 2 -
+00014640: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
+00014650: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
+00014660: 6565 6465 642e 0a20 2020 2020 2020 2020  eeded..         
+00014670: 2020 2066 2773 6b79 2073 746f 7020 2d79     f'sky stop -y
+00014680: 207b 6e61 6d65 7d27 2c0a 2020 2020 2020   {name}',.      
+00014690: 2020 2020 2020 6627 736b 7920 7374 6172        f'sky star
+000146a0: 7420 2d79 207b 6e61 6d65 7d20 2d69 2031  t -y {name} -i 1
+000146b0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000146c0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+000146d0: 2065 7861 6d70 6c65 732f 617a 7572 655f   examples/azure_
+000146e0: 7374 6172 745f 7374 6f70 2e79 616d 6c27  start_stop.yaml'
+000146f0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00014700: 736b 7920 6c6f 6773 207b 6e61 6d65 7d20  sky logs {name} 
+00014710: 3320 2d2d 7374 6174 7573 272c 2020 2320  3 --status',  # 
+00014720: 456e 7375 7265 2074 6865 206a 6f62 2073  Ensure the job s
+00014730: 7563 6365 6564 6564 2e0a 2020 2020 2020  ucceeded..      
+00014740: 2020 2020 2020 2773 6c65 6570 2032 3630        'sleep 260
+00014750: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00014760: 2773 3d24 2873 6b79 2073 7461 7475 7320  's=$(sky status 
+00014770: 2d72 207b 6e61 6d65 7d29 2026 2620 6563  -r {name}) && ec
+00014780: 686f 2022 2473 2220 2626 2065 6368 6f20  ho "$s" && echo 
+00014790: 2224 7322 207c 2067 7265 7020 2249 4e49  "$s" | grep "INI
+000147a0: 545c 7c53 544f 5050 4544 2227 0a20 2020  T\|STOPPED"'.   
+000147b0: 2020 2020 2020 2020 2066 277c 7c20 7b7b           f'|| {{
+000147c0: 2073 7368 207b 6e61 6d65 7d20 2263 6174   ssh {name} "cat
+000147d0: 207e 2f2e 736b 792f 736b 796c 6574 2e6c   ~/.sky/skylet.l
+000147e0: 6f67 223b 2065 7869 7420 313b 207d 7d27  og"; exit 1; }}'
+000147f0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+00014800: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
+00014810: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
+00014820: 2020 2074 696d 656f 7574 3d33 3020 2a20     timeout=30 * 
+00014830: 3630 2c20 2023 2033 3020 6d69 6e73 0a20  60,  # 30 mins. 
+00014840: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+00014850: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
+00014860: 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573 7469  ---------- Testi
+00014870: 6e67 2041 7574 6f73 746f 7070 696e 6720  ng Autostopping 
+00014880: 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465  ----------.@pyte
+00014890: 7374 2e6d 6172 6b2e 6e6f 5f66 6c75 6964  st.mark.no_fluid
+000148a0: 7374 6163 6b20 2023 2046 6c75 6964 5374  stack  # FluidSt
+000148b0: 6163 6b20 646f 6573 206e 6f74 2073 7570  ack does not sup
+000148c0: 706f 7274 2073 746f 7070 696e 6720 696e  port stopping in
+000148d0: 2053 6b79 5069 6c6f 7420 696d 706c 656d   SkyPilot implem
+000148e0: 656e 7461 7469 6f6e 0a40 7079 7465 7374  entation.@pytest
+000148f0: 2e6d 6172 6b2e 6e6f 5f6c 616d 6264 615f  .mark.no_lambda_
+00014900: 636c 6f75 6420 2023 204c 616d 6264 6120  cloud  # Lambda 
+00014910: 436c 6f75 6420 646f 6573 206e 6f74 2073  Cloud does not s
+00014920: 7570 706f 7274 2073 746f 7070 696e 6720  upport stopping 
+00014930: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
+00014940: 742e 6d61 726b 2e6e 6f5f 6962 6d20 2023  t.mark.no_ibm  #
+00014950: 2046 4958 2849 424d 2920 7370 6f72 6164   FIX(IBM) sporad
+00014960: 6963 616c 6c79 2066 6169 6c73 2c20 6173  ically fails, as
+00014970: 2072 6573 7461 7274 6564 2077 6f72 6b65   restarted worke
+00014980: 7273 2073 7461 7920 756e 696e 6974 6961  rs stay uninitia
+00014990: 6c69 7a65 6420 696e 6465 6669 6e69 7465  lized indefinite
+000149a0: 6c79 0a40 7079 7465 7374 2e6d 6172 6b2e  ly.@pytest.mark.
+000149b0: 6e6f 5f73 6370 2020 2320 5343 5020 646f  no_scp  # SCP do
+000149c0: 6573 206e 6f74 2073 7570 706f 7274 206e  es not support n
+000149d0: 756d 5f6e 6f64 6573 203e 2031 2079 6574  um_nodes > 1 yet
+000149e0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+000149f0: 5f6b 7562 6572 6e65 7465 7320 2023 204b  _kubernetes  # K
+00014a00: 7562 6572 6e65 7465 7320 646f 6573 206e  ubernetes does n
+00014a10: 6f74 2061 7574 6f73 746f 7020 7965 740a  ot autostop yet.
+00014a20: 6465 6620 7465 7374 5f61 7574 6f73 746f  def test_autosto
+00014a30: 7028 6765 6e65 7269 635f 636c 6f75 643a  p(generic_cloud:
+00014a40: 2073 7472 293a 0a20 2020 206e 616d 6520   str):.    name 
+00014a50: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+00014a60: 616d 6528 290a 2020 2020 2320 417a 7572  ame().    # Azur
+00014a70: 6520 7461 6b65 7320 7e20 376d 3135 7320  e takes ~ 7m15s 
+00014a80: 2834 3335 7329 2074 6f20 6175 746f 7374  (435s) to autost
+00014a90: 6f70 2061 2056 4d2c 2073 6f20 6865 7265  op a VM, so here
+00014aa0: 2077 6520 7573 6520 3630 3020 746f 2065   we use 600 to e
+00014ab0: 6e73 7572 650a 2020 2020 2320 7468 6520  nsure.    # the 
+00014ac0: 564d 2069 7320 7374 6f70 7065 642e 0a20  VM is stopped.. 
+00014ad0: 2020 2061 7574 6f73 746f 705f 7469 6d65     autostop_time
+00014ae0: 6f75 7420 3d20 3630 3020 6966 2067 656e  out = 600 if gen
+00014af0: 6572 6963 5f63 6c6f 7564 203d 3d20 2761  eric_cloud == 'a
+00014b00: 7a75 7265 2720 656c 7365 2032 3530 0a20  zure' else 250. 
+00014b10: 2020 2023 204c 6175 6e63 6869 6e67 2061     # Launching a
+00014b20: 6e64 2073 7461 7274 696e 6720 417a 7572  nd starting Azur
+00014b30: 6520 636c 7573 7465 7273 2063 616e 2074  e clusters can t
+00014b40: 616b 6520 6120 6c6f 6e67 2074 696d 6520  ake a long time 
+00014b50: 746f 6f2e 2065 2e67 2e2c 2072 6573 7461  too. e.g., resta
+00014b60: 7274 0a20 2020 2023 2061 2073 746f 7070  rt.    # a stopp
+00014b70: 6564 2041 7a75 7265 2063 6c75 7374 6572  ed Azure cluster
+00014b80: 2063 616e 2074 616b 6520 376d 2e20 536f   can take 7m. So
+00014b90: 2077 6520 7365 7420 7468 6520 746f 7461   we set the tota
+00014ba0: 6c20 7469 6d65 6f75 7420 746f 2037 306d  l timeout to 70m
+00014bb0: 2e0a 2020 2020 746f 7461 6c5f 7469 6d65  ..    total_time
+00014bc0: 6f75 745f 6d69 6e75 7465 7320 3d20 3730  out_minutes = 70
+00014bd0: 2069 6620 6765 6e65 7269 635f 636c 6f75   if generic_clou
+00014be0: 6420 3d3d 2027 617a 7572 6527 2065 6c73  d == 'azure' els
+00014bf0: 6520 3230 0a20 2020 2074 6573 7420 3d20  e 20.    test = 
+00014c00: 5465 7374 280a 2020 2020 2020 2020 2761  Test(.        'a
+00014c10: 7574 6f73 746f 7027 2c0a 2020 2020 2020  utostop',.      
+00014c20: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+00014c30: 6627 736b 7920 6c61 756e 6368 202d 7920  f'sky launch -y 
+00014c40: 2d64 202d 6320 7b6e 616d 657d 202d 2d6e  -d -c {name} --n
+00014c50: 756d 2d6e 6f64 6573 2032 202d 2d63 6c6f  um-nodes 2 --clo
+00014c60: 7564 207b 6765 6e65 7269 635f 636c 6f75  ud {generic_clou
+00014c70: 647d 2074 6573 7473 2f74 6573 745f 7961  d} tests/test_ya
+00014c80: 6d6c 732f 6d69 6e69 6d61 6c2e 7961 6d6c  mls/minimal.yaml
+00014c90: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00014ca0: 2773 6b79 2061 7574 6f73 746f 7020 2d79  'sky autostop -y
+00014cb0: 207b 6e61 6d65 7d20 2d69 2031 272c 0a0a   {name} -i 1',..
+00014cc0: 2020 2020 2020 2020 2020 2020 2320 456e              # En
+00014cd0: 7375 7265 2061 7574 6f73 746f 7020 6973  sure autostop is
+00014ce0: 2073 6574 2e0a 2020 2020 2020 2020 2020   set..          
+00014cf0: 2020 6627 736b 7920 7374 6174 7573 207c    f'sky status |
+00014d00: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
+00014d10: 7265 7020 2231 6d22 272c 0a0a 2020 2020  rep "1m"',..    
+00014d20: 2020 2020 2020 2020 2320 456e 7375 7265          # Ensure
+00014d30: 2074 6865 2063 6c75 7374 6572 2069 7320   the cluster is 
+00014d40: 6e6f 7420 7374 6f70 7065 6420 6561 726c  not stopped earl
+00014d50: 792e 0a20 2020 2020 2020 2020 2020 2027  y..            '
+00014d60: 736c 6565 7020 3430 272c 0a20 2020 2020  sleep 40',.     
+00014d70: 2020 2020 2020 2066 2773 3d24 2873 6b79         f's=$(sky
+00014d80: 2073 7461 7475 7320 7b6e 616d 657d 202d   status {name} -
+00014d90: 2d72 6566 7265 7368 293b 2065 6368 6f20  -refresh); echo 
+00014da0: 2224 7322 3b20 6563 686f 3b20 6563 686f  "$s"; echo; echo
+00014db0: 3b20 6563 686f 2022 2473 2220 207c 2067  ; echo "$s"  | g
+00014dc0: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
+00014dd0: 7020 5550 272c 0a0a 2020 2020 2020 2020  p UP',..        
+00014de0: 2020 2020 2320 456e 7375 7265 2074 6865      # Ensure the
+00014df0: 2063 6c75 7374 6572 2069 7320 5354 4f50   cluster is STOP
+00014e00: 5045 442e 0a20 2020 2020 2020 2020 2020  PED..           
+00014e10: 2066 2773 6c65 6570 207b 6175 746f 7374   f'sleep {autost
+00014e20: 6f70 5f74 696d 656f 7574 7d27 2c0a 2020  op_timeout}',.  
+00014e30: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
+00014e40: 736b 7920 7374 6174 7573 207b 6e61 6d65  sky status {name
+00014e50: 7d20 2d2d 7265 6672 6573 6829 3b20 6563  } --refresh); ec
+00014e60: 686f 2022 2473 223b 2065 6368 6f3b 2065  ho "$s"; echo; e
+00014e70: 6368 6f3b 2065 6368 6f20 2224 7322 2020  cho; echo "$s"  
+00014e80: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
+00014e90: 6772 6570 2053 544f 5050 4544 272c 0a0a  grep STOPPED',..
+00014ea0: 2020 2020 2020 2020 2020 2020 2320 456e              # En
+00014eb0: 7375 7265 2074 6865 2063 6c75 7374 6572  sure the cluster
+00014ec0: 2069 7320 5550 2061 6e64 2074 6865 2061   is UP and the a
+00014ed0: 7574 6f73 746f 7020 7365 7474 696e 6720  utostop setting 
+00014ee0: 6973 2072 6573 6574 2028 272d 2729 2e0a  is reset ('-')..
+00014ef0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00014f00: 7920 7374 6172 7420 2d79 207b 6e61 6d65  y start -y {name
+00014f10: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
+00014f20: 6627 736b 7920 7374 6174 7573 207c 2067  f'sky status | g
+00014f30: 7265 7020 7b6e 616d 657d 207c 2067 7265  rep {name} | gre
+00014f40: 7020 2d45 2022 5550 5c73 2b2d 2227 2c0a  p -E "UP\s+-"',.
+00014f50: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
+00014f60: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+00014f70: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
+00014f80: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+00014f90: 7b6e 616d 657d 2074 6573 7473 2f74 6573  {name} tests/tes
+00014fa0: 745f 7961 6d6c 732f 6d69 6e69 6d61 6c2e  t_yamls/minimal.
+00014fb0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00014fc0: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+00014fd0: 616d 657d 2032 202d 2d73 7461 7475 7327  ame} 2 --status'
+00014fe0: 2c0a 0a20 2020 2020 2020 2020 2020 2023  ,..            #
+00014ff0: 2054 6573 7420 7265 7374 6172 7469 6e67   Test restarting
+00015000: 2074 6865 2069 646c 656e 6573 7320 7469   the idleness ti
+00015010: 6d65 7220 7669 6120 7265 7365 743a 0a20  mer via reset:. 
+00015020: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00015030: 2061 7574 6f73 746f 7020 2d79 207b 6e61   autostop -y {na
+00015040: 6d65 7d20 2d69 2031 272c 2020 2320 4964  me} -i 1',  # Id
+00015050: 6c65 6e65 7373 2073 7461 7274 7320 636f  leness starts co
+00015060: 756e 7469 6e67 2e0a 2020 2020 2020 2020  unting..        
+00015070: 2020 2020 2773 6c65 6570 2034 3027 2c20      'sleep 40', 
+00015080: 2023 2041 6c6d 6f73 7420 7265 6163 6865   # Almost reache
+00015090: 6420 7468 6520 7468 7265 7368 6f6c 642e  d the threshold.
+000150a0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000150b0: 6b79 2061 7574 6f73 746f 7020 2d79 207b  ky autostop -y {
+000150c0: 6e61 6d65 7d20 2d69 2031 272c 2020 2320  name} -i 1',  # 
+000150d0: 5368 6f75 6c64 2072 6573 7461 7274 2074  Should restart t
+000150e0: 6865 2074 696d 6572 2e0a 2020 2020 2020  he timer..      
+000150f0: 2020 2020 2020 2773 6c65 6570 2034 3027        'sleep 40'
+00015100: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00015110: 733d 2428 736b 7920 7374 6174 7573 207b  s=$(sky status {
+00015120: 6e61 6d65 7d20 2d2d 7265 6672 6573 6829  name} --refresh)
+00015130: 3b20 6563 686f 2022 2473 223b 2065 6368  ; echo "$s"; ech
+00015140: 6f3b 2065 6368 6f3b 2065 6368 6f20 2224  o; echo; echo "$
+00015150: 7322 207c 2067 7265 7020 7b6e 616d 657d  s" | grep {name}
+00015160: 207c 2067 7265 7020 5550 272c 0a20 2020   | grep UP',.   
+00015170: 2020 2020 2020 2020 2066 2773 6c65 6570           f'sleep
+00015180: 207b 6175 746f 7374 6f70 5f74 696d 656f   {autostop_timeo
+00015190: 7574 7d27 2c0a 2020 2020 2020 2020 2020  ut}',.          
+000151a0: 2020 6627 733d 2428 736b 7920 7374 6174    f's=$(sky stat
+000151b0: 7573 207b 6e61 6d65 7d20 2d2d 7265 6672  us {name} --refr
+000151c0: 6573 6829 3b20 6563 686f 2022 2473 223b  esh); echo "$s";
+000151d0: 2065 6368 6f3b 2065 6368 6f3b 2065 6368   echo; echo; ech
+000151e0: 6f20 2224 7322 2020 7c20 6772 6570 207b  o "$s"  | grep {
+000151f0: 6e61 6d65 7d20 7c20 6772 6570 2053 544f  name} | grep STO
+00015200: 5050 4544 272c 0a0a 2020 2020 2020 2020  PPED',..        
+00015210: 2020 2020 2320 5465 7374 2072 6573 7461      # Test resta
+00015220: 7274 696e 6720 7468 6520 6964 6c65 6e65  rting the idlene
+00015230: 7373 2074 696d 6572 2076 6961 2065 7865  ss timer via exe
+00015240: 633a 0a20 2020 2020 2020 2020 2020 2066  c:.            f
+00015250: 2773 6b79 2073 7461 7274 202d 7920 7b6e  'sky start -y {n
+00015260: 616d 657d 272c 0a20 2020 2020 2020 2020  ame}',.         
+00015270: 2020 2066 2773 6b79 2073 7461 7475 7320     f'sky status 
+00015280: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
+00015290: 6772 6570 202d 4520 2255 505c 732b 2d22  grep -E "UP\s+-"
+000152a0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000152b0: 2773 6b79 2061 7574 6f73 746f 7020 2d79  'sky autostop -y
+000152c0: 207b 6e61 6d65 7d20 2d69 2031 272c 2020   {name} -i 1',  
+000152d0: 2320 4964 6c65 6e65 7373 2073 7461 7274  # Idleness start
+000152e0: 7320 636f 756e 7469 6e67 2e0a 2020 2020  s counting..    
+000152f0: 2020 2020 2020 2020 2773 6c65 6570 2034          'sleep 4
+00015300: 3527 2c20 2023 2041 6c6d 6f73 7420 7265  5',  # Almost re
+00015310: 6163 6865 6420 7468 6520 7468 7265 7368  ached the thresh
+00015320: 6f6c 642e 0a20 2020 2020 2020 2020 2020  old..           
+00015330: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+00015340: 657d 2065 6368 6f20 6869 272c 2020 2320  e} echo hi',  # 
+00015350: 5368 6f75 6c64 2072 6573 7461 7274 2074  Should restart t
+00015360: 6865 2074 696d 6572 2e0a 2020 2020 2020  he timer..      
+00015370: 2020 2020 2020 2773 6c65 6570 2034 3527        'sleep 45'
+00015380: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00015390: 733d 2428 736b 7920 7374 6174 7573 207b  s=$(sky status {
+000153a0: 6e61 6d65 7d20 2d2d 7265 6672 6573 6829  name} --refresh)
+000153b0: 3b20 6563 686f 2022 2473 223b 2065 6368  ; echo "$s"; ech
+000153c0: 6f3b 2065 6368 6f3b 2065 6368 6f20 2224  o; echo; echo "$
+000153d0: 7322 2020 7c20 6772 6570 207b 6e61 6d65  s"  | grep {name
+000153e0: 7d20 7c20 6772 6570 2055 5027 2c0a 2020  } | grep UP',.  
+000153f0: 2020 2020 2020 2020 2020 6627 736c 6565            f'slee
+00015400: 7020 7b61 7574 6f73 746f 705f 7469 6d65  p {autostop_time
+00015410: 6f75 747d 272c 0a20 2020 2020 2020 2020  out}',.         
+00015420: 2020 2066 2773 3d24 2873 6b79 2073 7461     f's=$(sky sta
+00015430: 7475 7320 7b6e 616d 657d 202d 2d72 6566  tus {name} --ref
+00015440: 7265 7368 293b 2065 6368 6f20 2224 7322  resh); echo "$s"
+00015450: 3b20 6563 686f 3b20 6563 686f 3b20 6563  ; echo; echo; ec
+00015460: 686f 2022 2473 2220 207c 2067 7265 7020  ho "$s"  | grep 
+00015470: 7b6e 616d 657d 207c 2067 7265 7020 5354  {name} | grep ST
+00015480: 4f50 5045 4427 2c0a 2020 2020 2020 2020  OPPED',.        
+00015490: 5d2c 0a20 2020 2020 2020 2066 2773 6b79  ],.        f'sky
+000154a0: 2064 6f77 6e20 2d79 207b 6e61 6d65 7d27   down -y {name}'
+000154b0: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
+000154c0: 743d 746f 7461 6c5f 7469 6d65 6f75 745f  t=total_timeout_
+000154d0: 6d69 6e75 7465 7320 2a20 3630 2c0a 2020  minutes * 60,.  
+000154e0: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+000154f0: 7465 7374 2874 6573 7429 0a0a 0a23 202d  test(test)...# -
+00015500: 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374 696e  --------- Testin
+00015510: 6720 4175 746f 646f 776e 696e 6720 2d2d  g Autodowning --
+00015520: 2d2d 2d2d 2d2d 2d2d 0a40 7079 7465 7374  --------.@pytest
+00015530: 2e6d 6172 6b2e 6e6f 5f66 6c75 6964 7374  .mark.no_fluidst
+00015540: 6163 6b20 2023 2046 6c75 6964 5374 6163  ack  # FluidStac
+00015550: 6b20 646f 6573 206e 6f74 2073 7570 706f  k does not suppo
+00015560: 7274 2073 746f 7070 696e 6720 696e 2053  rt stopping in S
+00015570: 6b79 5069 6c6f 7420 696d 706c 656d 656e  kyPilot implemen
+00015580: 7461 7469 6f6e 0a40 7079 7465 7374 2e6d  tation.@pytest.m
+00015590: 6172 6b2e 6e6f 5f73 6370 2020 2320 5343  ark.no_scp  # SC
+000155a0: 5020 646f 6573 206e 6f74 2073 7570 706f  P does not suppo
+000155b0: 7274 206e 756d 5f6e 6f64 6573 203e 2031  rt num_nodes > 1
+000155c0: 2079 6574 2e20 5275 6e20 7465 7374 5f73   yet. Run test_s
+000155d0: 6370 5f61 7574 6f64 6f77 6e20 696e 7374  cp_autodown inst
+000155e0: 6561 642e 0a64 6566 2074 6573 745f 6175  ead..def test_au
+000155f0: 746f 646f 776e 2867 656e 6572 6963 5f63  todown(generic_c
+00015600: 6c6f 7564 3a20 7374 7229 3a0a 2020 2020  loud: str):.    
+00015610: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+00015620: 7465 725f 6e61 6d65 2829 0a20 2020 2023  ter_name().    #
+00015630: 2041 7a75 7265 2074 616b 6573 207e 2031   Azure takes ~ 1
+00015640: 336d 3330 7320 2838 3130 7329 2074 6f20  3m30s (810s) to 
+00015650: 6175 746f 646f 776e 2061 2056 4d2c 2073  autodown a VM, s
+00015660: 6f20 6865 7265 2077 6520 7573 6520 3930  o here we use 90
+00015670: 3020 746f 2065 6e73 7572 650a 2020 2020  0 to ensure.    
+00015680: 2320 7468 6520 564d 2069 7320 7465 726d  # the VM is term
+00015690: 696e 6174 6564 2e0a 2020 2020 6175 746f  inated..    auto
+000156a0: 646f 776e 5f74 696d 656f 7574 203d 2039  down_timeout = 9
+000156b0: 3030 2069 6620 6765 6e65 7269 635f 636c  00 if generic_cl
+000156c0: 6f75 6420 3d3d 2027 617a 7572 6527 2065  oud == 'azure' e
+000156d0: 6c73 6520 3234 300a 2020 2020 746f 7461  lse 240.    tota
+000156e0: 6c5f 7469 6d65 6f75 745f 6d69 6e75 7465  l_timeout_minute
+000156f0: 7320 3d20 3930 2069 6620 6765 6e65 7269  s = 90 if generi
+00015700: 635f 636c 6f75 6420 3d3d 2027 617a 7572  c_cloud == 'azur
+00015710: 6527 2065 6c73 6520 3230 0a20 2020 2074  e' else 20.    t
+00015720: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+00015730: 2020 2020 2761 7574 6f64 6f77 6e27 2c0a      'autodown',.
+00015740: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+00015750: 2020 2020 2020 6627 736b 7920 6c61 756e        f'sky laun
+00015760: 6368 202d 7920 2d64 202d 6320 7b6e 616d  ch -y -d -c {nam
+00015770: 657d 202d 2d6e 756d 2d6e 6f64 6573 2032  e} --num-nodes 2
+00015780: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
+00015790: 635f 636c 6f75 647d 2074 6573 7473 2f74  c_cloud} tests/t
+000157a0: 6573 745f 7961 6d6c 732f 6d69 6e69 6d61  est_yamls/minima
+000157b0: 6c2e 7961 6d6c 272c 0a20 2020 2020 2020  l.yaml',.       
+000157c0: 2020 2020 2066 2773 6b79 2061 7574 6f73       f'sky autos
+000157d0: 746f 7020 2d79 207b 6e61 6d65 7d20 2d2d  top -y {name} --
+000157e0: 646f 776e 202d 6920 3127 2c0a 2020 2020  down -i 1',.    
+000157f0: 2020 2020 2020 2020 2320 456e 7375 7265          # Ensure
+00015800: 2061 7574 6f73 746f 7020 6973 2073 6574   autostop is set
+00015810: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00015820: 736b 7920 7374 6174 7573 207c 2067 7265  sky status | gre
+00015830: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
+00015840: 2231 6d20 2864 6f77 6e29 2227 2c0a 2020  "1m (down)"',.  
+00015850: 2020 2020 2020 2020 2020 2320 456e 7375            # Ensu
+00015860: 7265 2074 6865 2063 6c75 7374 6572 2069  re the cluster i
+00015870: 7320 6e6f 7420 7465 726d 696e 6174 6564  s not terminated
+00015880: 2065 6172 6c79 2e0a 2020 2020 2020 2020   early..        
+00015890: 2020 2020 2773 6c65 6570 2034 3027 2c0a      'sleep 40',.
+000158a0: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
+000158b0: 2428 736b 7920 7374 6174 7573 207b 6e61  $(sky status {na
+000158c0: 6d65 7d20 2d2d 7265 6672 6573 6829 3b20  me} --refresh); 
+000158d0: 6563 686f 2022 2473 223b 2065 6368 6f3b  echo "$s"; echo;
+000158e0: 2065 6368 6f3b 2065 6368 6f20 2224 7322   echo; echo "$s"
+000158f0: 2020 7c20 6772 6570 207b 6e61 6d65 7d20    | grep {name} 
+00015900: 7c20 6772 6570 2055 5027 2c0a 2020 2020  | grep UP',.    
+00015910: 2020 2020 2020 2020 2320 456e 7375 7265          # Ensure
+00015920: 2074 6865 2063 6c75 7374 6572 2069 7320   the cluster is 
+00015930: 7465 726d 696e 6174 6564 2e0a 2020 2020  terminated..    
+00015940: 2020 2020 2020 2020 6627 736c 6565 7020          f'sleep 
+00015950: 7b61 7574 6f64 6f77 6e5f 7469 6d65 6f75  {autodown_timeou
+00015960: 747d 272c 0a20 2020 2020 2020 2020 2020  t}',.           
+00015970: 2066 2773 3d24 2853 4b59 5049 4c4f 545f   f's=$(SKYPILOT_
+00015980: 4445 4255 473d 3020 736b 7920 7374 6174  DEBUG=0 sky stat
+00015990: 7573 207b 6e61 6d65 7d20 2d2d 7265 6672  us {name} --refr
+000159a0: 6573 6829 2026 2620 6563 686f 2022 2473  esh) && echo "$s
+000159b0: 2220 2626 207b 7b20 6563 686f 2022 2473  " && {{ echo "$s
+000159c0: 2220 7c20 6772 6570 207b 6e61 6d65 7d20  " | grep {name} 
+000159d0: 7c20 6772 6570 2022 4175 746f 646f 776e  | grep "Autodown
+000159e0: 6564 2063 6c75 7374 6572 5c7c 7465 726d  ed cluster\|term
+000159f0: 696e 6174 6564 206f 6e20 7468 6520 636c  inated on the cl
+00015a00: 6f75 6422 3b20 7d7d 207c 7c20 7b7b 2065  oud"; }} || {{ e
+00015a10: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
+00015a20: 7b6e 616d 657d 2026 2620 6578 6974 2031  {name} && exit 1
+00015a30: 207c 7c20 6578 6974 2030 3b20 7d7d 272c   || exit 0; }}',
+00015a40: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00015a50: 6b79 206c 6175 6e63 6820 2d79 202d 6420  ky launch -y -d 
+00015a60: 2d63 207b 6e61 6d65 7d20 2d2d 636c 6f75  -c {name} --clou
+00015a70: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
+00015a80: 7d20 2d2d 6e75 6d2d 6e6f 6465 7320 3220  } --num-nodes 2 
+00015a90: 2d2d 646f 776e 2074 6573 7473 2f74 6573  --down tests/tes
+00015aa0: 745f 7961 6d6c 732f 6d69 6e69 6d61 6c2e  t_yamls/minimal.
+00015ab0: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00015ac0: 2020 2066 2773 6b79 2073 7461 7475 7320     f'sky status 
+00015ad0: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
+00015ae0: 6772 6570 2055 5027 2c20 2023 2045 6e73  grep UP',  # Ens
+00015af0: 7572 6520 7468 6520 636c 7573 7465 7220  ure the cluster 
+00015b00: 6973 2055 502e 0a20 2020 2020 2020 2020  is UP..         
+00015b10: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+00015b20: 616d 657d 202d 2d63 6c6f 7564 207b 6765  ame} --cloud {ge
+00015b30: 6e65 7269 635f 636c 6f75 647d 2074 6573  neric_cloud} tes
+00015b40: 7473 2f74 6573 745f 7961 6d6c 732f 6d69  ts/test_yamls/mi
+00015b50: 6e69 6d61 6c2e 7961 6d6c 272c 0a20 2020  nimal.yaml',.   
+00015b60: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
+00015b70: 7461 7475 7320 7c20 6772 6570 207b 6e61  tatus | grep {na
+00015b80: 6d65 7d20 7c20 6772 6570 2022 316d 2028  me} | grep "1m (
+00015b90: 646f 776e 2922 272c 0a20 2020 2020 2020  down)"',.       
+00015ba0: 2020 2020 2066 2773 6c65 6570 207b 6175       f'sleep {au
+00015bb0: 746f 646f 776e 5f74 696d 656f 7574 7d27  todown_timeout}'
+00015bc0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+00015bd0: 456e 7375 7265 2074 6865 2063 6c75 7374  Ensure the clust
+00015be0: 6572 2069 7320 7465 726d 696e 6174 6564  er is terminated
+00015bf0: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00015c00: 733d 2428 534b 5950 494c 4f54 5f44 4542  s=$(SKYPILOT_DEB
+00015c10: 5547 3d30 2073 6b79 2073 7461 7475 7320  UG=0 sky status 
+00015c20: 7b6e 616d 657d 202d 2d72 6566 7265 7368  {name} --refresh
+00015c30: 2920 2626 2065 6368 6f20 2224 7322 2026  ) && echo "$s" &
+00015c40: 2620 7b7b 2065 6368 6f20 2224 7322 207c  & {{ echo "$s" |
+00015c50: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
+00015c60: 7265 7020 2241 7574 6f64 6f77 6e65 6420  rep "Autodowned 
+00015c70: 636c 7573 7465 725c 7c74 6572 6d69 6e61  cluster\|termina
+00015c80: 7465 6420 6f6e 2074 6865 2063 6c6f 7564  ted on the cloud
+00015c90: 223b 207d 7d20 7c7c 207b 7b20 6563 686f  "; }} || {{ echo
+00015ca0: 2022 2473 2220 7c20 6772 6570 207b 6e61   "$s" | grep {na
+00015cb0: 6d65 7d20 2626 2065 7869 7420 3120 7c7c  me} && exit 1 ||
+00015cc0: 2065 7869 7420 303b 207d 7d27 2c0a 2020   exit 0; }}',.  
+00015cd0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00015ce0: 6c61 756e 6368 202d 7920 2d64 202d 6320  launch -y -d -c 
+00015cf0: 7b6e 616d 657d 202d 2d63 6c6f 7564 207b  {name} --cloud {
+00015d00: 6765 6e65 7269 635f 636c 6f75 647d 202d  generic_cloud} -
+00015d10: 2d6e 756d 2d6e 6f64 6573 2032 202d 2d64  -num-nodes 2 --d
+00015d20: 6f77 6e20 7465 7374 732f 7465 7374 5f79  own tests/test_y
+00015d30: 616d 6c73 2f6d 696e 696d 616c 2e79 616d  amls/minimal.yam
+00015d40: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00015d50: 6627 736b 7920 6175 746f 7374 6f70 202d  f'sky autostop -
+00015d60: 7920 7b6e 616d 657d 202d 2d63 616e 6365  y {name} --cance
+00015d70: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00015d80: 6627 736c 6565 7020 7b61 7574 6f64 6f77  f'sleep {autodow
+00015d90: 6e5f 7469 6d65 6f75 747d 272c 0a20 2020  n_timeout}',.   
+00015da0: 2020 2020 2020 2020 2023 2045 6e73 7572           # Ensur
+00015db0: 6520 7468 6520 636c 7573 7465 7220 6973  e the cluster is
+00015dc0: 2073 7469 6c6c 2055 502e 0a20 2020 2020   still UP..     
+00015dd0: 2020 2020 2020 2066 2773 3d24 2853 4b59         f's=$(SKY
+00015de0: 5049 4c4f 545f 4445 4255 473d 3020 736b  PILOT_DEBUG=0 sk
+00015df0: 7920 7374 6174 7573 207b 6e61 6d65 7d20  y status {name} 
+00015e00: 2d2d 7265 6672 6573 6829 2026 2620 6563  --refresh) && ec
+00015e10: 686f 2022 2473 2220 2626 2065 6368 6f20  ho "$s" && echo 
+00015e20: 2224 7322 207c 2067 7265 7020 7b6e 616d  "$s" | grep {nam
+00015e30: 657d 207c 2067 7265 7020 5550 272c 0a20  e} | grep UP',. 
+00015e40: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00015e50: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+00015e60: 7b6e 616d 657d 272c 0a20 2020 2020 2020  {name}',.       
+00015e70: 2074 696d 656f 7574 3d74 6f74 616c 5f74   timeout=total_t
+00015e80: 696d 656f 7574 5f6d 696e 7574 6573 202a  imeout_minutes *
+00015e90: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
+00015ea0: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+00015eb0: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+00015ec0: 2e73 6370 0a64 6566 2074 6573 745f 7363  .scp.def test_sc
+00015ed0: 705f 6175 746f 646f 776e 2829 3a0a 2020  p_autodown():.  
+00015ee0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+00015ef0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+00015f00: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+00015f10: 2020 2020 2020 2753 4350 5f61 7574 6f64        'SCP_autod
+00015f20: 6f77 6e27 2c0a 2020 2020 2020 2020 5b0a  own',.        [.
+00015f30: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00015f40: 7920 6c61 756e 6368 202d 7920 2d64 202d  y launch -y -d -
+00015f50: 6320 7b6e 616d 657d 207b 5343 505f 5459  c {name} {SCP_TY
+00015f60: 5045 7d20 7465 7374 732f 7465 7374 5f79  PE} tests/test_y
+00015f70: 616d 6c73 2f6d 696e 696d 616c 2e79 616d  amls/minimal.yam
+00015f80: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00015f90: 6627 736b 7920 6175 746f 7374 6f70 202d  f'sky autostop -
+00015fa0: 7920 7b6e 616d 657d 202d 2d64 6f77 6e20  y {name} --down 
+00015fb0: 2d69 2031 272c 0a20 2020 2020 2020 2020  -i 1',.         
+00015fc0: 2020 2023 2045 6e73 7572 6520 6175 746f     # Ensure auto
+00015fd0: 7374 6f70 2069 7320 7365 742e 0a20 2020  stop is set..   
+00015fe0: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
+00015ff0: 7461 7475 7320 7c20 6772 6570 207b 6e61  tatus | grep {na
+00016000: 6d65 7d20 7c20 6772 6570 2022 316d 2028  me} | grep "1m (
+00016010: 646f 776e 2922 272c 0a20 2020 2020 2020  down)"',.       
+00016020: 2020 2020 2023 2045 6e73 7572 6520 7468       # Ensure th
+00016030: 6520 636c 7573 7465 7220 6973 206e 6f74  e cluster is not
+00016040: 2074 6572 6d69 6e61 7465 6420 6561 726c   terminated earl
+00016050: 792e 0a20 2020 2020 2020 2020 2020 2027  y..            '
+00016060: 736c 6565 7020 3435 272c 0a20 2020 2020  sleep 45',.     
+00016070: 2020 2020 2020 2066 2773 6b79 2073 7461         f'sky sta
+00016080: 7475 7320 2d2d 7265 6672 6573 6820 7c20  tus --refresh | 
+00016090: 6772 6570 207b 6e61 6d65 7d20 7c20 6772  grep {name} | gr
+000160a0: 6570 2055 5027 2c0a 2020 2020 2020 2020  ep UP',.        
+000160b0: 2020 2020 2320 456e 7375 7265 2074 6865      # Ensure the
+000160c0: 2063 6c75 7374 6572 2069 7320 7465 726d   cluster is term
+000160d0: 696e 6174 6564 2e0a 2020 2020 2020 2020  inated..        
+000160e0: 2020 2020 2773 6c65 6570 2032 3030 272c      'sleep 200',
+000160f0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00016100: 3d24 2853 4b59 5049 4c4f 545f 4445 4255  =$(SKYPILOT_DEBU
+00016110: 473d 3020 736b 7920 7374 6174 7573 202d  G=0 sky status -
+00016120: 2d72 6566 7265 7368 2920 2626 2070 7269  -refresh) && pri
+00016130: 6e74 6620 2224 7322 2026 2620 7b7b 2065  ntf "$s" && {{ e
+00016140: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
+00016150: 7b6e 616d 657d 207c 2067 7265 7020 2241  {name} | grep "A
+00016160: 7574 6f64 6f77 6e65 6420 636c 7573 7465  utodowned cluste
+00016170: 725c 7c74 6572 6d69 6e61 7465 6420 6f6e  r\|terminated on
+00016180: 2074 6865 2063 6c6f 7564 223b 207d 7d20   the cloud"; }} 
+00016190: 7c7c 207b 7b20 6563 686f 2022 2473 2220  || {{ echo "$s" 
+000161a0: 7c20 6772 6570 207b 6e61 6d65 7d20 2626  | grep {name} &&
+000161b0: 2065 7869 7420 3120 7c7c 2065 7869 7420   exit 1 || exit 
+000161c0: 303b 207d 7d27 2c0a 2020 2020 2020 2020  0; }}',.        
+000161d0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+000161e0: 202d 7920 2d64 202d 6320 7b6e 616d 657d   -y -d -c {name}
+000161f0: 207b 5343 505f 5459 5045 7d20 2d2d 646f   {SCP_TYPE} --do
+00016200: 776e 2074 6573 7473 2f74 6573 745f 7961  wn tests/test_ya
+00016210: 6d6c 732f 6d69 6e69 6d61 6c2e 7961 6d6c  mls/minimal.yaml
+00016220: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00016230: 2773 6b79 2073 7461 7475 7320 7c20 6772  'sky status | gr
+00016240: 6570 207b 6e61 6d65 7d20 7c20 6772 6570  ep {name} | grep
+00016250: 2055 5027 2c20 2023 2045 6e73 7572 6520   UP',  # Ensure 
+00016260: 7468 6520 636c 7573 7465 7220 6973 2055  the cluster is U
+00016270: 502e 0a20 2020 2020 2020 2020 2020 2066  P..            f
+00016280: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+00016290: 207b 5343 505f 5459 5045 7d20 7465 7374   {SCP_TYPE} test
+000162a0: 732f 7465 7374 5f79 616d 6c73 2f6d 696e  s/test_yamls/min
+000162b0: 696d 616c 2e79 616d 6c27 2c0a 2020 2020  imal.yaml',.    
+000162c0: 2020 2020 2020 2020 6627 736b 7920 7374          f'sky st
+000162d0: 6174 7573 207c 2067 7265 7020 7b6e 616d  atus | grep {nam
+000162e0: 657d 207c 2067 7265 7020 2231 6d20 2864  e} | grep "1m (d
+000162f0: 6f77 6e29 2227 2c0a 2020 2020 2020 2020  own)"',.        
+00016300: 2020 2020 2773 6c65 6570 2032 3030 272c      'sleep 200',
+00016310: 0a20 2020 2020 2020 2020 2020 2023 2045  .            # E
+00016320: 6e73 7572 6520 7468 6520 636c 7573 7465  nsure the cluste
+00016330: 7220 6973 2074 6572 6d69 6e61 7465 642e  r is terminated.
+00016340: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00016350: 3d24 2853 4b59 5049 4c4f 545f 4445 4255  =$(SKYPILOT_DEBU
+00016360: 473d 3020 736b 7920 7374 6174 7573 202d  G=0 sky status -
+00016370: 2d72 6566 7265 7368 2920 2626 2070 7269  -refresh) && pri
+00016380: 6e74 6620 2224 7322 2026 2620 7b7b 2065  ntf "$s" && {{ e
+00016390: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
+000163a0: 7b6e 616d 657d 207c 2067 7265 7020 2241  {name} | grep "A
+000163b0: 7574 6f64 6f77 6e65 6420 636c 7573 7465  utodowned cluste
+000163c0: 725c 7c74 6572 6d69 6e61 7465 6420 6f6e  r\|terminated on
+000163d0: 2074 6865 2063 6c6f 7564 223b 207d 7d20   the cloud"; }} 
+000163e0: 7c7c 207b 7b20 6563 686f 2022 2473 2220  || {{ echo "$s" 
+000163f0: 7c20 6772 6570 207b 6e61 6d65 7d20 2626  | grep {name} &&
+00016400: 2065 7869 7420 3120 7c7c 2065 7869 7420   exit 1 || exit 
+00016410: 303b 207d 7d27 2c0a 2020 2020 2020 2020  0; }}',.        
+00016420: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+00016430: 202d 7920 2d64 202d 6320 7b6e 616d 657d   -y -d -c {name}
+00016440: 207b 5343 505f 5459 5045 7d20 2d2d 646f   {SCP_TYPE} --do
+00016450: 776e 2074 6573 7473 2f74 6573 745f 7961  wn tests/test_ya
+00016460: 6d6c 732f 6d69 6e69 6d61 6c2e 7961 6d6c  mls/minimal.yaml
+00016470: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00016480: 2773 6b79 2061 7574 6f73 746f 7020 2d79  'sky autostop -y
+00016490: 207b 6e61 6d65 7d20 2d2d 6361 6e63 656c   {name} --cancel
+000164a0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+000164b0: 736c 6565 7020 3230 3027 2c0a 2020 2020  sleep 200',.    
+000164c0: 2020 2020 2020 2020 2320 456e 7375 7265          # Ensure
+000164d0: 2074 6865 2063 6c75 7374 6572 2069 7320   the cluster is 
+000164e0: 7374 696c 6c20 5550 2e0a 2020 2020 2020  still UP..      
+000164f0: 2020 2020 2020 6627 733d 2428 534b 5950        f's=$(SKYP
+00016500: 494c 4f54 5f44 4542 5547 3d30 2073 6b79  ILOT_DEBUG=0 sky
+00016510: 2073 7461 7475 7320 2d2d 7265 6672 6573   status --refres
+00016520: 6829 2026 2620 7072 696e 7466 2022 2473  h) && printf "$s
+00016530: 2220 2626 2065 6368 6f20 2224 7322 207c  " && echo "$s" |
+00016540: 2067 7265 7020 7b6e 616d 657d 207c 2067   grep {name} | g
+00016550: 7265 7020 5550 272c 0a20 2020 2020 2020  rep UP',.       
+00016560: 205d 2c0a 2020 2020 2020 2020 6627 736b   ],.        f'sk
+00016570: 7920 646f 776e 202d 7920 7b6e 616d 657d  y down -y {name}
+00016580: 272c 0a20 2020 2020 2020 2074 696d 656f  ',.        timeo
+00016590: 7574 3d32 3520 2a20 3630 2c0a 2020 2020  ut=25 * 60,.    
+000165a0: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+000165b0: 7374 2874 6573 7429 0a0a 0a64 6566 205f  st(test)...def _
+000165c0: 6765 745f 6361 6e63 656c 5f74 6173 6b5f  get_cancel_task_
+000165d0: 7769 7468 5f63 6c6f 7564 286e 616d 652c  with_cloud(name,
+000165e0: 2063 6c6f 7564 2c20 7469 6d65 6f75 743d   cloud, timeout=
+000165f0: 3135 202a 2036 3029 3a0a 2020 2020 7465  15 * 60):.    te
+00016600: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00016610: 2020 2066 277b 636c 6f75 647d 2d63 616e     f'{cloud}-can
+00016620: 6365 6c2d 7461 736b 272c 0a20 2020 2020  cel-task',.     
+00016630: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00016640: 2066 2773 6b79 206c 6175 6e63 6820 2d63   f'sky launch -c
+00016650: 207b 6e61 6d65 7d20 6578 616d 706c 6573   {name} examples
+00016660: 2f72 6573 6e65 745f 6170 702e 7961 6d6c  /resnet_app.yaml
+00016670: 202d 2d63 6c6f 7564 207b 636c 6f75 647d   --cloud {cloud}
+00016680: 202d 7920 2d64 272c 0a20 2020 2020 2020   -y -d',.       
+00016690: 2020 2020 2023 2057 6169 7420 7468 6520       # Wait the 
+000166a0: 4750 5520 7072 6f63 6573 7320 746f 2073  GPU process to s
+000166b0: 7461 7274 2e0a 2020 2020 2020 2020 2020  tart..          
+000166c0: 2020 2773 6c65 6570 2036 3027 2c0a 2020    'sleep 60',.  
+000166d0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000166e0: 6578 6563 207b 6e61 6d65 7d20 226e 7669  exec {name} "nvi
+000166f0: 6469 612d 736d 6920 7c20 6772 6570 2070  dia-smi | grep p
+00016700: 7974 686f 6e22 272c 0a20 2020 2020 2020  ython"',.       
+00016710: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00016720: 7b6e 616d 657d 2032 202d 2d73 7461 7475  {name} 2 --statu
+00016730: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
+00016740: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
+00016750: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00016760: 6b79 2063 616e 6365 6c20 2d79 207b 6e61  ky cancel -y {na
+00016770: 6d65 7d20 3127 2c0a 2020 2020 2020 2020  me} 1',.        
+00016780: 2020 2020 2773 6c65 6570 2036 3027 2c0a      'sleep 60',.
+00016790: 2020 2020 2020 2020 2020 2020 2320 6368              # ch
+000167a0: 6563 6b20 6966 2074 6865 2070 7974 686f  eck if the pytho
+000167b0: 6e20 6a6f 6220 6973 2067 6f6e 652e 0a20  n job is gone.. 
+000167c0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000167d0: 2065 7865 6320 7b6e 616d 657d 2022 2120   exec {name} "! 
+000167e0: 6e76 6964 6961 2d73 6d69 207c 2067 7265  nvidia-smi | gre
+000167f0: 7020 7079 7468 6f6e 2227 2c0a 2020 2020  p python"',.    
+00016800: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+00016810: 6773 207b 6e61 6d65 7d20 3320 2d2d 7374  gs {name} 3 --st
+00016820: 6174 7573 272c 2020 2320 456e 7375 7265  atus',  # Ensure
+00016830: 2074 6865 206a 6f62 2073 7563 6365 6564   the job succeed
+00016840: 6564 2e0a 2020 2020 2020 2020 5d2c 0a20  ed..        ],. 
+00016850: 2020 2020 2020 2066 2773 6b79 2064 6f77         f'sky dow
+00016860: 6e20 2d79 207b 6e61 6d65 7d27 2c0a 2020  n -y {name}',.  
+00016870: 2020 2020 2020 7469 6d65 6f75 743d 7469        timeout=ti
+00016880: 6d65 6f75 742c 0a20 2020 2029 0a20 2020  meout,.    ).   
+00016890: 2072 6574 7572 6e20 7465 7374 0a0a 0a23   return test...#
+000168a0: 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374   ---------- Test
+000168b0: 696e 6720 6073 6b79 2063 616e 6365 6c60  ing `sky cancel`
+000168c0: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974   ----------.@pyt
+000168d0: 6573 742e 6d61 726b 2e61 7773 0a40 7079  est.mark.aws.@py
+000168e0: 7465 7374 2e6d 6172 6b2e 736b 6970 280a  test.mark.skip(.
+000168f0: 2020 2020 7265 6173 6f6e 3d27 5468 6520      reason='The 
+00016900: 7265 736e 6574 5f61 7070 2069 7320 666c  resnet_app is fl
+00016910: 616b 792c 2064 7565 2074 6f20 5446 2066  aky, due to TF f
+00016920: 6169 6c69 6e67 2074 6f20 6465 7465 6374  ailing to detect
+00016930: 2047 5055 732e 2729 0a64 6566 2074 6573   GPUs.').def tes
+00016940: 745f 6361 6e63 656c 5f61 7773 2829 3a0a  t_cancel_aws():.
+00016950: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+00016960: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+00016970: 2020 2074 6573 7420 3d20 5f67 6574 5f63     test = _get_c
+00016980: 616e 6365 6c5f 7461 736b 5f77 6974 685f  ancel_task_with_
+00016990: 636c 6f75 6428 6e61 6d65 2c20 2761 7773  cloud(name, 'aws
+000169a0: 2729 0a20 2020 2072 756e 5f6f 6e65 5f74  ').    run_one_t
+000169b0: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
+000169c0: 6573 742e 6d61 726b 2e67 6370 0a40 7079  est.mark.gcp.@py
+000169d0: 7465 7374 2e6d 6172 6b2e 736b 6970 280a  test.mark.skip(.
+000169e0: 2020 2020 7265 6173 6f6e 3d27 5468 6520      reason='The 
+000169f0: 7265 736e 6574 5f61 7070 2069 7320 666c  resnet_app is fl
+00016a00: 616b 792c 2064 7565 2074 6f20 5446 2066  aky, due to TF f
+00016a10: 6169 6c69 6e67 2074 6f20 6465 7465 6374  ailing to detect
+00016a20: 2047 5055 732e 2729 0a64 6566 2074 6573   GPUs.').def tes
+00016a30: 745f 6361 6e63 656c 5f67 6370 2829 3a0a  t_cancel_gcp():.
+00016a40: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+00016a50: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+00016a60: 2020 2074 6573 7420 3d20 5f67 6574 5f63     test = _get_c
+00016a70: 616e 6365 6c5f 7461 736b 5f77 6974 685f  ancel_task_with_
+00016a80: 636c 6f75 6428 6e61 6d65 2c20 2767 6370  cloud(name, 'gcp
+00016a90: 2729 0a20 2020 2072 756e 5f6f 6e65 5f74  ').    run_one_t
+00016aa0: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
+00016ab0: 6573 742e 6d61 726b 2e61 7a75 7265 0a40  est.mark.azure.@
+00016ac0: 7079 7465 7374 2e6d 6172 6b2e 736b 6970  pytest.mark.skip
+00016ad0: 280a 2020 2020 7265 6173 6f6e 3d27 5468  (.    reason='Th
+00016ae0: 6520 7265 736e 6574 5f61 7070 2069 7320  e resnet_app is 
+00016af0: 666c 616b 792c 2064 7565 2074 6f20 5446  flaky, due to TF
+00016b00: 2066 6169 6c69 6e67 2074 6f20 6465 7465   failing to dete
+00016b10: 6374 2047 5055 732e 2729 0a64 6566 2074  ct GPUs.').def t
+00016b20: 6573 745f 6361 6e63 656c 5f61 7a75 7265  est_cancel_azure
+00016b30: 2829 3a0a 2020 2020 6e61 6d65 203d 205f  ():.    name = _
+00016b40: 6765 745f 636c 7573 7465 725f 6e61 6d65  get_cluster_name
+00016b50: 2829 0a20 2020 2074 6573 7420 3d20 5f67  ().    test = _g
+00016b60: 6574 5f63 616e 6365 6c5f 7461 736b 5f77  et_cancel_task_w
+00016b70: 6974 685f 636c 6f75 6428 6e61 6d65 2c20  ith_cloud(name, 
+00016b80: 2761 7a75 7265 272c 2074 696d 656f 7574  'azure', timeout
+00016b90: 3d33 3020 2a20 3630 290a 2020 2020 7275  =30 * 60).    ru
+00016ba0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+00016bb0: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+00016bc0: 6e6f 5f6c 616d 6264 615f 636c 6f75 6420  no_lambda_cloud 
+00016bd0: 2023 204c 616d 6264 6120 436c 6f75 6420   # Lambda Cloud 
+00016be0: 646f 6573 206e 6f74 2068 6176 6520 5631  does not have V1
+00016bf0: 3030 2067 7075 730a 4070 7974 6573 742e  00 gpus.@pytest.
+00016c00: 6d61 726b 2e6e 6f5f 6962 6d20 2023 2049  mark.no_ibm  # I
+00016c10: 424d 2063 6c6f 7564 2063 7572 7265 6e74  BM cloud current
+00016c20: 6c79 2064 6f65 736e 2774 2070 726f 7669  ly doesn't provi
+00016c30: 6465 2070 7562 6c69 6320 696d 6167 6520  de public image 
+00016c40: 7769 7468 2043 5544 410a 4070 7974 6573  with CUDA.@pytes
+00016c50: 742e 6d61 726b 2e6e 6f5f 7061 7065 7273  t.mark.no_papers
+00016c60: 7061 6365 2020 2320 5061 7065 7273 7061  pace  # Paperspa
+00016c70: 6365 2068 6173 2060 676e 6f6d 652d 7368  ce has `gnome-sh
+00016c80: 656c 6c60 206f 6e20 6e76 6964 6961 2d73  ell` on nvidia-s
+00016c90: 6d69 0a40 7079 7465 7374 2e6d 6172 6b2e  mi.@pytest.mark.
+00016ca0: 6e6f 5f73 6370 2020 2320 5343 5020 646f  no_scp  # SCP do
+00016cb0: 6573 206e 6f74 2073 7570 706f 7274 206e  es not support n
+00016cc0: 756d 5f6e 6f64 6573 203e 2031 2079 6574  um_nodes > 1 yet
+00016cd0: 0a64 6566 2074 6573 745f 6361 6e63 656c  .def test_cancel
+00016ce0: 5f70 7974 6f72 6368 2867 656e 6572 6963  _pytorch(generic
+00016cf0: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
+00016d00: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+00016d10: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+00016d20: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+00016d30: 2020 2020 2020 2763 616e 6365 6c2d 7079        'cancel-py
+00016d40: 746f 7263 6827 2c0a 2020 2020 2020 2020  torch',.        
+00016d50: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+00016d60: 736b 7920 6c61 756e 6368 202d 6320 7b6e  sky launch -c {n
+00016d70: 616d 657d 202d 2d63 6c6f 7564 207b 6765  ame} --cloud {ge
+00016d80: 6e65 7269 635f 636c 6f75 647d 2065 7861  neric_cloud} exa
+00016d90: 6d70 6c65 732f 7265 736e 6574 5f64 6973  mples/resnet_dis
+00016da0: 7472 6962 7574 6564 5f74 6f72 6368 2e79  tributed_torch.y
+00016db0: 616d 6c20 2d79 202d 6427 2c0a 2020 2020  aml -y -d',.    
+00016dc0: 2020 2020 2020 2020 2320 5761 6974 2074          # Wait t
+00016dd0: 6865 2047 5055 2070 726f 6365 7373 2074  he GPU process t
+00016de0: 6f20 7374 6172 742e 0a20 2020 2020 2020  o start..       
+00016df0: 2020 2020 2027 736c 6565 7020 3930 272c       'sleep 90',
+00016e00: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00016e10: 6b79 2065 7865 6320 7b6e 616d 657d 2022  ky exec {name} "
+00016e20: 286e 7669 6469 612d 736d 6920 7c20 6772  (nvidia-smi | gr
+00016e30: 6570 2070 7974 686f 6e29 207c 7c20 270a  ep python) || '.
+00016e40: 2020 2020 2020 2020 2020 2020 2320 5768              # Wh
+00016e50: 656e 2072 756e 2069 6e73 6964 6520 636f  en run inside co
+00016e60: 6e74 6169 6e65 722f 6b38 732c 206e 7669  ntainer/k8s, nvi
+00016e70: 6469 612d 736d 6920 6361 6e6e 6f74 2073  dia-smi cannot s
+00016e80: 686f 7720 7072 6f63 6573 7320 6964 732e  how process ids.
+00016e90: 0a20 2020 2020 2020 2020 2020 2023 2053  .            # S
+00016ea0: 6565 2068 7474 7073 3a2f 2f67 6974 6875  ee https://githu
+00016eb0: 622e 636f 6d2f 4e56 4944 4941 2f6e 7669  b.com/NVIDIA/nvi
+00016ec0: 6469 612d 646f 636b 6572 2f69 7373 7565  dia-docker/issue
+00016ed0: 732f 3137 390a 2020 2020 2020 2020 2020  s/179.          
+00016ee0: 2020 2320 546f 2077 6f72 6b20 6172 6f75    # To work arou
+00016ef0: 6e64 2c20 7765 2063 6865 636b 2069 6620  nd, we check if 
+00016f00: 4750 5520 7574 696c 697a 6174 696f 6e20  GPU utilization 
+00016f10: 6973 2067 7265 6174 6572 2074 6861 6e20  is greater than 
+00016f20: 302e 0a20 2020 2020 2020 2020 2020 2066  0..            f
+00016f30: 275b 205c 2428 6e76 6964 6961 2d73 6d69  '[ \$(nvidia-smi
+00016f40: 202d 2d71 7565 7279 2d67 7075 3d75 7469   --query-gpu=uti
+00016f50: 6c69 7a61 7469 6f6e 2e67 7075 202d 2d66  lization.gpu --f
+00016f60: 6f72 6d61 743d 6373 762c 6e6f 6865 6164  ormat=csv,nohead
+00016f70: 6572 2c6e 6f75 6e69 7473 2920 2d67 7420  er,nounits) -gt 
+00016f80: 3020 5d22 272c 0a20 2020 2020 2020 2020  0 ]"',.         
+00016f90: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+00016fa0: 616d 657d 2032 202d 2d73 7461 7475 7327  ame} 2 --status'
+00016fb0: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
+00016fc0: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
+00016fd0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00016fe0: 2063 616e 6365 6c20 2d79 207b 6e61 6d65   cancel -y {name
+00016ff0: 7d20 3127 2c0a 2020 2020 2020 2020 2020  } 1',.          
+00017000: 2020 2773 6c65 6570 2036 3027 2c0a 2020    'sleep 60',.  
+00017010: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00017020: 6578 6563 207b 6e61 6d65 7d20 2228 6e76  exec {name} "(nv
+00017030: 6964 6961 2d73 6d69 207c 2067 7265 7020  idia-smi | grep 
+00017040: 5c27 4e6f 2072 756e 6e69 6e67 2070 726f  \'No running pro
+00017050: 6365 7373 5c27 2920 7c7c 2027 0a20 2020  cess\') || '.   
+00017060: 2020 2020 2020 2020 2023 2045 6e73 7572           # Ensur
+00017070: 6520 586f 7267 2069 7320 7468 6520 6f6e  e Xorg is the on
+00017080: 6c79 2070 726f 6365 7373 2072 756e 6e69  ly process runni
+00017090: 6e67 2e0a 2020 2020 2020 2020 2020 2020  ng..            
+000170a0: 275b 205c 2428 6e76 6964 6961 2d73 6d69  '[ \$(nvidia-smi
+000170b0: 207c 2067 7265 7020 2d41 2031 3020 5072   | grep -A 10 Pr
+000170c0: 6f63 6573 7365 7320 7c20 6772 6570 202d  ocesses | grep -
+000170d0: 4120 3130 203d 3d3d 207c 2067 7265 7020  A 10 === | grep 
+000170e0: 2d76 2058 6f72 6729 202d 6571 2032 205d  -v Xorg) -eq 2 ]
+000170f0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+00017100: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00017110: 7d20 3320 2d2d 7374 6174 7573 272c 2020  } 3 --status',  
+00017120: 2320 456e 7375 7265 2074 6865 206a 6f62  # Ensure the job
+00017130: 2073 7563 6365 6564 6564 2e0a 2020 2020   succeeded..    
+00017140: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+00017150: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+00017160: 6d65 7d27 2c0a 2020 2020 2020 2020 7469  me}',.        ti
+00017170: 6d65 6f75 743d 3230 202a 2036 302c 0a20  meout=20 * 60,. 
+00017180: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+00017190: 5f74 6573 7428 7465 7374 290a 0a0a 2320  _test(test)...# 
+000171a0: 6361 6e27 7420 7573 6520 605f 6765 745f  can't use `_get_
+000171b0: 6361 6e63 656c 5f74 6173 6b5f 7769 7468  cancel_task_with
+000171c0: 5f63 6c6f 7564 2829 602c 2061 7320 636f  _cloud()`, as co
+000171d0: 6d6d 616e 6420 606e 7669 6469 612d 736d  mmand `nvidia-sm
+000171e0: 6960 0a23 2072 6571 7569 7265 7320 6120  i`.# requires a 
+000171f0: 4355 4441 2070 7562 6c69 6320 696d 6167  CUDA public imag
+00017200: 652c 2077 6869 6368 2049 424d 2064 6f65  e, which IBM doe
+00017210: 736e 2774 206f 6666 6572 0a40 7079 7465  sn't offer.@pyte
+00017220: 7374 2e6d 6172 6b2e 6962 6d0a 6465 6620  st.mark.ibm.def 
+00017230: 7465 7374 5f63 616e 6365 6c5f 6962 6d28  test_cancel_ibm(
+00017240: 293a 0a20 2020 206e 616d 6520 3d20 5f67  ):.    name = _g
+00017250: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+00017260: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
+00017270: 7428 0a20 2020 2020 2020 2027 6962 6d2d  t(.        'ibm-
+00017280: 6361 6e63 656c 2d74 6173 6b27 2c0a 2020  cancel-task',.  
+00017290: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+000172a0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+000172b0: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
+000172c0: 636c 6f75 6420 6962 6d20 6578 616d 706c  cloud ibm exampl
+000172d0: 6573 2f6d 696e 696d 616c 2e79 616d 6c27  es/minimal.yaml'
+000172e0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+000172f0: 736b 7920 6578 6563 207b 6e61 6d65 7d20  sky exec {name} 
+00017300: 2d6e 207b 6e61 6d65 7d2d 3120 2d64 2020  -n {name}-1 -d  
+00017310: 2277 6869 6c65 2074 7275 653b 2064 6f20  "while true; do 
+00017320: 6563 686f 205c 2748 656c 6c6f 2053 6b79  echo \'Hello Sky
+00017330: 5069 6c6f 745c 273b 2073 6c65 6570 2032  Pilot\'; sleep 2
+00017340: 3b20 646f 6e65 2227 2c0a 2020 2020 2020  ; done"',.      
+00017350: 2020 2020 2020 2773 6c65 6570 2032 3027        'sleep 20'
+00017360: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00017370: 736b 7920 7175 6575 6520 7b6e 616d 657d  sky queue {name}
+00017380: 207c 2067 7265 7020 7b6e 616d 657d 2d31   | grep {name}-1
+00017390: 207c 2067 7265 7020 5255 4e4e 494e 4727   | grep RUNNING'
+000173a0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+000173b0: 736b 7920 6361 6e63 656c 202d 7920 7b6e  sky cancel -y {n
+000173c0: 616d 657d 2032 272c 0a20 2020 2020 2020  ame} 2',.       
+000173d0: 2020 2020 2066 2773 6c65 6570 2035 272c       f'sleep 5',
+000173e0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000173f0: 6b79 2071 7565 7565 207b 6e61 6d65 7d20  ky queue {name} 
+00017400: 7c20 6772 6570 207b 6e61 6d65 7d2d 3120  | grep {name}-1 
+00017410: 7c20 6772 6570 2043 414e 4345 4c4c 4544  | grep CANCELLED
+00017420: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+00017430: 2020 2020 2020 6627 736b 7920 646f 776e        f'sky down
+00017440: 202d 7920 7b6e 616d 657d 272c 0a20 2020   -y {name}',.   
+00017450: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+00017460: 6573 7428 7465 7374 290a 0a0a 2320 2d2d  est(test)...# --
+00017470: 2d2d 2d2d 2d2d 2d2d 2054 6573 7469 6e67  -------- Testing
+00017480: 2075 7365 2d73 706f 7420 6f70 7469 6f6e   use-spot option
+00017490: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974   ----------.@pyt
+000174a0: 6573 742e 6d61 726b 2e6e 6f5f 666c 7569  est.mark.no_flui
+000174b0: 6473 7461 636b 2020 2320 466c 7569 6453  dstack  # FluidS
+000174c0: 7461 636b 2064 6f65 7320 6e6f 7420 7375  tack does not su
+000174d0: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
+000174e0: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
+000174f0: 6b2e 6e6f 5f61 7a75 7265 2020 2320 417a  k.no_azure  # Az
+00017500: 7572 6520 646f 6573 206e 6f74 2073 7570  ure does not sup
+00017510: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
+00017520: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
+00017530: 2e6e 6f5f 6c61 6d62 6461 5f63 6c6f 7564  .no_lambda_cloud
+00017540: 2020 2320 4c61 6d62 6461 2043 6c6f 7564    # Lambda Cloud
+00017550: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
+00017560: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
+00017570: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+00017580: 5f70 6170 6572 7370 6163 6520 2023 2050  _paperspace  # P
+00017590: 6170 6572 7370 6163 6520 646f 6573 206e  aperspace does n
+000175a0: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
+000175b0: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
+000175c0: 742e 6d61 726b 2e6e 6f5f 6962 6d20 2023  t.mark.no_ibm  #
+000175d0: 2049 424d 2043 6c6f 7564 2064 6f65 7320   IBM Cloud does 
+000175e0: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
+000175f0: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
+00017600: 7374 2e6d 6172 6b2e 6e6f 5f73 6370 2020  st.mark.no_scp  
+00017610: 2320 5343 5020 646f 6573 206e 6f74 2073  # SCP does not s
+00017620: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
+00017630: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
+00017640: 726b 2e6e 6f5f 6b75 6265 726e 6574 6573  rk.no_kubernetes
+00017650: 2020 2320 4b75 6265 726e 6574 6573 2064    # Kubernetes d
+00017660: 6f65 7320 6e6f 7420 6861 7665 2061 206e  oes not have a n
+00017670: 6f74 696f 6e20 6f66 2073 706f 7420 696e  otion of spot in
+00017680: 7374 616e 6365 730a 6465 6620 7465 7374  stances.def test
+00017690: 5f75 7365 5f73 706f 7428 6765 6e65 7269  _use_spot(generi
+000176a0: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
+000176b0: 2020 2022 2222 5465 7374 2075 7365 2d73     """Test use-s
+000176c0: 706f 7420 616e 6420 736b 7920 6578 6563  pot and sky exec
+000176d0: 2e22 2222 0a20 2020 206e 616d 6520 3d20  .""".    name = 
+000176e0: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+000176f0: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
+00017700: 6573 7428 0a20 2020 2020 2020 2027 7573  est(.        'us
+00017710: 652d 7370 6f74 272c 0a20 2020 2020 2020  e-spot',.       
+00017720: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+00017730: 2773 6b79 206c 6175 6e63 6820 2d63 207b  'sky launch -c {
+00017740: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
+00017750: 656e 6572 6963 5f63 6c6f 7564 7d20 7465  eneric_cloud} te
+00017760: 7374 732f 7465 7374 5f79 616d 6c73 2f6d  sts/test_yamls/m
+00017770: 696e 696d 616c 2e79 616d 6c20 2d2d 7573  inimal.yaml --us
+00017780: 652d 7370 6f74 202d 7927 2c0a 2020 2020  e-spot -y',.    
+00017790: 2020 2020 2020 2020 6627 736b 7920 6c6f          f'sky lo
+000177a0: 6773 207b 6e61 6d65 7d20 3120 2d2d 7374  gs {name} 1 --st
+000177b0: 6174 7573 272c 0a20 2020 2020 2020 2020  atus',.         
+000177c0: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+000177d0: 616d 657d 2065 6368 6f20 6869 272c 0a20  ame} echo hi',. 
+000177e0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000177f0: 206c 6f67 7320 7b6e 616d 657d 2032 202d   logs {name} 2 -
+00017800: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
+00017810: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
+00017820: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+00017830: 7d27 2c0a 2020 2020 290a 2020 2020 7275  }',.    ).    ru
+00017840: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+00017850: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+00017860: 6763 700a 6465 6620 7465 7374 5f73 746f  gcp.def test_sto
+00017870: 705f 6763 705f 7370 6f74 2829 3a0a 2020  p_gcp_spot():.  
+00017880: 2020 2222 2254 6573 7420 4743 5020 7370    """Test GCP sp
+00017890: 6f74 2063 616e 2062 6520 7374 6f70 7065  ot can be stoppe
+000178a0: 642c 2061 7574 6f73 746f 7070 6564 2c20  d, autostopped, 
+000178b0: 7265 7374 6172 7465 642e 2222 220a 2020  restarted.""".  
+000178c0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+000178d0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+000178e0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+000178f0: 2020 2020 2020 2773 746f 705f 6763 705f        'stop_gcp_
+00017900: 7370 6f74 272c 0a20 2020 2020 2020 205b  spot',.        [
+00017910: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00017920: 6b79 206c 6175 6e63 6820 2d63 207b 6e61  ky launch -c {na
+00017930: 6d65 7d20 2d2d 636c 6f75 6420 6763 7020  me} --cloud gcp 
+00017940: 2d2d 7573 652d 7370 6f74 202d 2d63 7075  --use-spot --cpu
+00017950: 7320 322b 202d 7920 2d2d 2074 6f75 6368  s 2+ -y -- touch
+00017960: 206d 7966 696c 6527 2c0a 2020 2020 2020   myfile',.      
+00017970: 2020 2020 2020 2320 7374 6f70 2073 686f        # stop sho
+00017980: 756c 6420 676f 2074 6872 6f75 6768 3a0a  uld go through:.
+00017990: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+000179a0: 7920 7374 6f70 207b 6e61 6d65 7d20 2d79  y stop {name} -y
+000179b0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+000179c0: 2773 6b79 2073 7461 7274 207b 6e61 6d65  'sky start {name
+000179d0: 7d20 2d79 272c 0a20 2020 2020 2020 2020  } -y',.         
+000179e0: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+000179f0: 616d 657d 202d 2d20 6c73 206d 7966 696c  ame} -- ls myfil
+00017a00: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
+00017a10: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00017a20: 7d20 3220 2d2d 7374 6174 7573 272c 0a20  } 2 --status',. 
+00017a30: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00017a40: 2061 7574 6f73 746f 7020 7b6e 616d 657d   autostop {name}
+00017a50: 202d 6930 202d 7927 2c0a 2020 2020 2020   -i0 -y',.      
+00017a60: 2020 2020 2020 2773 6c65 6570 2039 3027        'sleep 90'
+00017a70: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00017a80: 733d 2428 736b 7920 7374 6174 7573 207b  s=$(sky status {
+00017a90: 6e61 6d65 7d20 2d2d 7265 6672 6573 6829  name} --refresh)
+00017aa0: 3b20 6563 686f 2022 2473 223b 2065 6368  ; echo "$s"; ech
+00017ab0: 6f3b 2065 6368 6f3b 2065 6368 6f20 2224  o; echo; echo "$
+00017ac0: 7322 2020 7c20 6772 6570 207b 6e61 6d65  s"  | grep {name
+00017ad0: 7d20 7c20 6772 6570 2053 544f 5050 4544  } | grep STOPPED
+00017ae0: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+00017af0: 2773 6b79 2073 7461 7274 207b 6e61 6d65  'sky start {name
+00017b00: 7d20 2d79 272c 0a20 2020 2020 2020 2020  } -y',.         
+00017b10: 2020 2066 2773 6b79 2065 7865 6320 7b6e     f'sky exec {n
+00017b20: 616d 657d 202d 2d20 6c73 206d 7966 696c  ame} -- ls myfil
+00017b30: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
+00017b40: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+00017b50: 7d20 3320 2d2d 7374 6174 7573 272c 0a20  } 3 --status',. 
+00017b60: 2020 2020 2020 2020 2020 2023 202d 6920             # -i 
+00017b70: 6f70 7469 6f6e 2061 7420 6c61 756e 6368  option at launch
+00017b80: 2073 686f 756c 6420 676f 2074 6872 6f75   should go throu
+00017b90: 6768 3a0a 2020 2020 2020 2020 2020 2020  gh:.            
+00017ba0: 6627 736b 7920 6c61 756e 6368 202d 6320  f'sky launch -c 
+00017bb0: 7b6e 616d 657d 202d 6930 202d 7927 2c0a  {name} -i0 -y',.
+00017bc0: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+00017bd0: 6570 2031 3230 272c 0a20 2020 2020 2020  ep 120',.       
+00017be0: 2020 2020 2066 2773 3d24 2873 6b79 2073       f's=$(sky s
+00017bf0: 7461 7475 7320 7b6e 616d 657d 202d 2d72  tatus {name} --r
+00017c00: 6566 7265 7368 293b 2065 6368 6f20 2224  efresh); echo "$
+00017c10: 7322 3b20 6563 686f 3b20 6563 686f 3b20  s"; echo; echo; 
+00017c20: 6563 686f 2022 2473 2220 207c 2067 7265  echo "$s"  | gre
+00017c30: 7020 7b6e 616d 657d 207c 2067 7265 7020  p {name} | grep 
+00017c40: 5354 4f50 5045 4427 2c0a 2020 2020 2020  STOPPED',.      
+00017c50: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
+00017c60: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+00017c70: 7d27 2c0a 2020 2020 290a 2020 2020 7275  }',.    ).    ru
+00017c80: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+00017c90: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
+00017ca0: 5465 7374 696e 6720 6d61 6e61 6765 6420  Testing managed 
+00017cb0: 6a6f 6220 2d2d 2d2d 2d2d 2d2d 2d2d 0a40  job ----------.@
+00017cc0: 7079 7465 7374 2e6d 6172 6b2e 6d61 6e61  pytest.mark.mana
+00017cd0: 6765 645f 6a6f 6273 0a64 6566 2074 6573  ged_jobs.def tes
+00017ce0: 745f 6d61 6e61 6765 645f 6a6f 6273 2867  t_managed_jobs(g
+00017cf0: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
+00017d00: 7229 3a0a 2020 2020 2222 2254 6573 7420  r):.    """Test 
+00017d10: 7468 6520 6d61 6e61 6765 6420 6a6f 6273  the managed jobs
+00017d20: 2079 616d 6c2e 2222 220a 2020 2020 6e61   yaml.""".    na
+00017d30: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+00017d40: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
+00017d50: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+00017d60: 2020 276d 616e 6167 6564 2d6a 6f62 7327    'managed-jobs'
+00017d70: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+00017d80: 2020 2020 2020 2020 6627 736b 7920 6a6f          f'sky jo
+00017d90: 6273 206c 6175 6e63 6820 2d6e 207b 6e61  bs launch -n {na
+00017da0: 6d65 7d2d 3120 2d2d 636c 6f75 6420 7b67  me}-1 --cloud {g
+00017db0: 656e 6572 6963 5f63 6c6f 7564 7d20 6578  eneric_cloud} ex
+00017dc0: 616d 706c 6573 2f6d 616e 6167 6564 5f6a  amples/managed_j
+00017dd0: 6f62 2e79 616d 6c20 2d79 202d 6427 2c0a  ob.yaml -y -d',.
+00017de0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00017df0: 7920 6a6f 6273 206c 6175 6e63 6820 2d6e  y jobs launch -n
+00017e00: 207b 6e61 6d65 7d2d 3220 2d2d 636c 6f75   {name}-2 --clou
+00017e10: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
+00017e20: 7d20 6578 616d 706c 6573 2f6d 616e 6167  } examples/manag
+00017e30: 6564 5f6a 6f62 2e79 616d 6c20 2d79 202d  ed_job.yaml -y -
+00017e40: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
+00017e50: 2773 6c65 6570 2035 272c 0a20 2020 2020  'sleep 5',.     
+00017e60: 2020 2020 2020 2066 277b 5f4a 4f42 5f51         f'{_JOB_Q
+00017e70: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+00017e80: 207b 6e61 6d65 7d2d 3120 7c20 6865 6164   {name}-1 | head
+00017e90: 202d 6e31 207c 2067 7265 7020 2253 5441   -n1 | grep "STA
+00017ea0: 5254 494e 475c 7c52 554e 4e49 4e47 2227  RTING\|RUNNING"'
+00017eb0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00017ec0: 7b5f 4a4f 425f 5155 4555 455f 5741 4954  {_JOB_QUEUE_WAIT
+00017ed0: 7d7c 2067 7265 7020 7b6e 616d 657d 2d32  }| grep {name}-2
+00017ee0: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
+00017ef0: 6570 2022 5354 4152 5449 4e47 5c7c 5255  ep "STARTING\|RU
+00017f00: 4e4e 494e 4722 272c 0a20 2020 2020 2020  NNING"',.       
+00017f10: 2020 2020 205f 4a4f 425f 4341 4e43 454c       _JOB_CANCEL
+00017f20: 5f57 4149 542e 666f 726d 6174 286a 6f62  _WAIT.format(job
+00017f30: 5f6e 616d 653d 6627 7b6e 616d 657d 2d31  _name=f'{name}-1
+00017f40: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
+00017f50: 2773 6c65 6570 2035 272c 0a20 2020 2020  'sleep 5',.     
+00017f60: 2020 2020 2020 2066 277b 5f4a 4f42 5f51         f'{_JOB_Q
+00017f70: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+00017f80: 207b 6e61 6d65 7d2d 3120 7c20 6865 6164   {name}-1 | head
+00017f90: 202d 6e31 207c 2067 7265 7020 2243 414e   -n1 | grep "CAN
+00017fa0: 4345 4c4c 494e 475c 7c43 414e 4345 4c4c  CELLING\|CANCELL
+00017fb0: 4544 2227 2c0a 2020 2020 2020 2020 2020  ED"',.          
+00017fc0: 2020 2773 6c65 6570 2032 3030 272c 0a20    'sleep 200',. 
+00017fd0: 2020 2020 2020 2020 2020 2066 277b 5f4a             f'{_J
+00017fe0: 4f42 5f51 5545 5545 5f57 4149 547d 7c20  OB_QUEUE_WAIT}| 
+00017ff0: 6772 6570 207b 6e61 6d65 7d2d 3120 7c20  grep {name}-1 | 
+00018000: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
+00018010: 4341 4e43 454c 4c45 4427 2c0a 2020 2020  CANCELLED',.    
+00018020: 2020 2020 2020 2020 2320 5465 7374 2074          # Test t
+00018030: 6865 2066 756e 6374 696f 6e61 6c69 7479  he functionality
+00018040: 2066 6f72 206c 6f67 6769 6e67 2e0a 2020   for logging..  
+00018050: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
+00018060: 736b 7920 6a6f 6273 206c 6f67 7320 2d6e  sky jobs logs -n
+00018070: 207b 6e61 6d65 7d2d 3220 2d2d 6e6f 2d66   {name}-2 --no-f
+00018080: 6f6c 6c6f 7729 3b20 6563 686f 2022 2473  ollow); echo "$s
+00018090: 223b 2065 6368 6f20 2224 7322 207c 2067  "; echo "$s" | g
+000180a0: 7265 7020 2273 7461 7274 2063 6f75 6e74  rep "start count
+000180b0: 696e 6722 272c 0a20 2020 2020 2020 2020  ing"',.         
+000180c0: 2020 2066 2773 3d24 2873 6b79 206a 6f62     f's=$(sky job
+000180d0: 7320 6c6f 6773 202d 2d63 6f6e 7472 6f6c  s logs --control
+000180e0: 6c65 7220 2d6e 207b 6e61 6d65 7d2d 3220  ler -n {name}-2 
+000180f0: 2d2d 6e6f 2d66 6f6c 6c6f 7729 3b20 6563  --no-follow); ec
+00018100: 686f 2022 2473 223b 2065 6368 6f20 2224  ho "$s"; echo "$
+00018110: 7322 207c 2067 7265 7020 2253 7563 6365  s" | grep "Succe
+00018120: 7373 6675 6c6c 7920 7072 6f76 6973 696f  ssfully provisio
+00018130: 6e65 6420 636c 7573 7465 723a 2227 2c0a  ned cluster:"',.
+00018140: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+00018150: 4a4f 425f 5155 4555 455f 5741 4954 7d7c  JOB_QUEUE_WAIT}|
+00018160: 2067 7265 7020 7b6e 616d 657d 2d32 207c   grep {name}-2 |
+00018170: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+00018180: 2022 5255 4e4e 494e 475c 7c53 5543 4345   "RUNNING\|SUCCE
+00018190: 4544 4544 2227 2c0a 2020 2020 2020 2020  EDED"',.        
+000181a0: 5d2c 0a20 2020 2020 2020 2023 2054 4f44  ],.        # TOD
+000181b0: 4f28 7a68 7775 293a 2043 6861 6e67 6520  O(zhwu): Change 
+000181c0: 746f 205f 4a4f 425f 4341 4e43 454c 5f57  to _JOB_CANCEL_W
+000181d0: 4149 542e 666f 726d 6174 286a 6f62 5f6e  AIT.format(job_n
+000181e0: 616d 653d 6627 7b6e 616d 657d 2d31 202d  ame=f'{name}-1 -
+000181f0: 6e20 7b6e 616d 657d 2d32 2729 2077 6865  n {name}-2') whe
+00018200: 6e0a 2020 2020 2020 2020 2320 6361 6e63  n.        # canc
+00018210: 656c 696e 6720 6d75 6c74 6970 6c65 206a  eling multiple j
+00018220: 6f62 206e 616d 6573 2069 7320 7375 7070  ob names is supp
+00018230: 6f72 7465 642e 0a20 2020 2020 2020 2028  orted..        (
+00018240: 5f4a 4f42 5f43 414e 4345 4c5f 5741 4954  _JOB_CANCEL_WAIT
+00018250: 2e66 6f72 6d61 7428 6a6f 625f 6e61 6d65  .format(job_name
+00018260: 3d66 277b 6e61 6d65 7d2d 3127 2920 2b20  =f'{name}-1') + 
+00018270: 273b 2027 202b 0a20 2020 2020 2020 2020  '; ' +.         
+00018280: 5f4a 4f42 5f43 414e 4345 4c5f 5741 4954  _JOB_CANCEL_WAIT
+00018290: 2e66 6f72 6d61 7428 6a6f 625f 6e61 6d65  .format(job_name
+000182a0: 3d66 277b 6e61 6d65 7d2d 3227 2929 2c0a  =f'{name}-2')),.
+000182b0: 2020 2020 2020 2020 2320 496e 6372 6561          # Increa
+000182c0: 7365 2074 696d 656f 7574 2073 696e 6365  se timeout since
+000182d0: 2073 6b79 206a 6f62 7320 7175 6575 6520   sky jobs queue 
+000182e0: 2d72 2063 616e 2062 6520 626c 6f63 6b65  -r can be blocke
+000182f0: 6420 6279 206f 7468 6572 2073 706f 7420  d by other spot 
+00018300: 7465 7374 732e 0a20 2020 2020 2020 2074  tests..        t
+00018310: 696d 656f 7574 3d32 3020 2a20 3630 2c0a  imeout=20 * 60,.
+00018320: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+00018330: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
+00018340: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f66  pytest.mark.no_f
+00018350: 6c75 6964 7374 6163 6b20 2023 666c 7569  luidstack  #flui
+00018360: 6473 7461 636b 2064 6f65 7320 6e6f 7420  dstack does not 
+00018370: 7375 7070 6f72 7420 7370 6f74 2069 6e73  support spot ins
+00018380: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
+00018390: 6172 6b2e 6e6f 5f61 7a75 7265 2020 2320  ark.no_azure  # 
+000183a0: 417a 7572 6520 646f 6573 206e 6f74 2073  Azure does not s
+000183b0: 7570 706f 7274 2073 706f 7420 696e 7374  upport spot inst
+000183c0: 616e 6365 730a 4070 7974 6573 742e 6d61  ances.@pytest.ma
+000183d0: 726b 2e6e 6f5f 6c61 6d62 6461 5f63 6c6f  rk.no_lambda_clo
+000183e0: 7564 2020 2320 4c61 6d62 6461 2043 6c6f  ud  # Lambda Clo
+000183f0: 7564 2064 6f65 7320 6e6f 7420 7375 7070  ud does not supp
+00018400: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
+00018410: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
+00018420: 6e6f 5f69 626d 2020 2320 4942 4d20 436c  no_ibm  # IBM Cl
+00018430: 6f75 6420 646f 6573 206e 6f74 2073 7570  oud does not sup
+00018440: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
+00018450: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
+00018460: 2e6e 6f5f 7363 7020 2023 2053 4350 2064  .no_scp  # SCP d
+00018470: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
+00018480: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
+00018490: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f70  pytest.mark.no_p
+000184a0: 6170 6572 7370 6163 6520 2023 2050 6170  aperspace  # Pap
+000184b0: 6572 7370 6163 6520 646f 6573 206e 6f74  erspace does not
+000184c0: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
+000184d0: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
+000184e0: 6d61 726b 2e6e 6f5f 6b75 6265 726e 6574  mark.no_kubernet
+000184f0: 6573 2020 2320 4b75 6265 726e 6574 6573  es  # Kubernetes
+00018500: 2064 6f65 7320 6e6f 7420 6861 7665 2061   does not have a
+00018510: 206e 6f74 696f 6e20 6f66 2073 706f 7420   notion of spot 
+00018520: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
+00018530: 742e 6d61 726b 2e6d 616e 6167 6564 5f6a  t.mark.managed_j
+00018540: 6f62 730a 6465 6620 7465 7374 5f6a 6f62  obs.def test_job
+00018550: 5f70 6970 656c 696e 6528 6765 6e65 7269  _pipeline(generi
+00018560: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
+00018570: 2020 2022 2222 5465 7374 2061 206a 6f62     """Test a job
+00018580: 2070 6970 656c 696e 652e 2222 220a 2020   pipeline.""".  
+00018590: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+000185a0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+000185b0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+000185c0: 2020 2020 2020 2773 706f 742d 7069 7065        'spot-pipe
+000185d0: 6c69 6e65 272c 0a20 2020 2020 2020 205b  line',.        [
+000185e0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000185f0: 6b79 206a 6f62 7320 6c61 756e 6368 202d  ky jobs launch -
+00018600: 6e20 7b6e 616d 657d 2074 6573 7473 2f74  n {name} tests/t
+00018610: 6573 745f 7961 6d6c 732f 7069 7065 6c69  est_yamls/pipeli
+00018620: 6e65 2e79 616d 6c20 2d79 202d 6427 2c0a  ne.yaml -y -d',.
+00018630: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+00018640: 6570 2035 272c 0a20 2020 2020 2020 2020  ep 5',.         
+00018650: 2020 2066 277b 5f4a 4f42 5f51 5545 5545     f'{_JOB_QUEUE
+00018660: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+00018670: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
+00018680: 2067 7265 7020 2253 5441 5254 494e 475c   grep "STARTING\
+00018690: 7c52 554e 4e49 4e47 2227 2c0a 2020 2020  |RUNNING"',.    
+000186a0: 2020 2020 2020 2020 2320 6067 7265 7020          # `grep 
+000186b0: 2d41 2034 207b 6e61 6d65 7d60 2066 696e  -A 4 {name}` fin
+000186c0: 6473 2074 6865 206a 6f62 2077 6974 6820  ds the job with 
+000186d0: 7b6e 616d 657d 2061 6e64 2074 6865 2034  {name} and the 4
+000186e0: 206c 696e 6573 0a20 2020 2020 2020 2020   lines.         
+000186f0: 2020 2023 2061 6674 6572 2069 742c 2069     # after it, i
+00018700: 2e65 2e20 7468 6520 3420 7461 736b 7320  .e. the 4 tasks 
+00018710: 7769 7468 696e 2074 6865 206a 6f62 2e0a  within the job..
+00018720: 2020 2020 2020 2020 2020 2020 2320 6073              # `s
+00018730: 6564 202d 6e20 3270 6020 6765 7473 2074  ed -n 2p` gets t
+00018740: 6865 2073 6563 6f6e 6420 6c69 6e65 206f  he second line o
+00018750: 6620 7468 6520 3420 6c69 6e65 732c 2069  f the 4 lines, i
+00018760: 2e65 2e20 7468 6520 6669 7273 740a 2020  .e. the first.  
+00018770: 2020 2020 2020 2020 2020 2320 7461 736b            # task
+00018780: 2077 6974 6869 6e20 7468 6520 6a6f 622e   within the job.
+00018790: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+000187a0: 5f4a 4f42 5f51 5545 5545 5f57 4149 547d  _JOB_QUEUE_WAIT}
+000187b0: 7c20 6772 6570 202d 4120 3420 7b6e 616d  | grep -A 4 {nam
+000187c0: 657d 7c20 7365 6420 2d6e 2032 7020 7c20  e}| sed -n 2p | 
+000187d0: 6772 6570 2022 5354 4152 5449 4e47 5c7c  grep "STARTING\|
+000187e0: 5255 4e4e 494e 4722 272c 0a20 2020 2020  RUNNING"',.     
+000187f0: 2020 2020 2020 2066 277b 5f4a 4f42 5f51         f'{_JOB_Q
+00018800: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+00018810: 202d 4120 3420 7b6e 616d 657d 7c20 7365   -A 4 {name}| se
+00018820: 6420 2d6e 2033 7020 7c20 6772 6570 2022  d -n 3p | grep "
+00018830: 5045 4e44 494e 4722 272c 0a20 2020 2020  PENDING"',.     
+00018840: 2020 2020 2020 205f 4a4f 425f 4341 4e43         _JOB_CANC
+00018850: 454c 5f57 4149 542e 666f 726d 6174 286a  EL_WAIT.format(j
+00018860: 6f62 5f6e 616d 653d 6627 7b6e 616d 657d  ob_name=f'{name}
+00018870: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
+00018880: 2773 6c65 6570 2035 272c 0a20 2020 2020  'sleep 5',.     
+00018890: 2020 2020 2020 2066 277b 5f4a 4f42 5f51         f'{_JOB_Q
+000188a0: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+000188b0: 202d 4120 3420 7b6e 616d 657d 7c20 7365   -A 4 {name}| se
+000188c0: 6420 2d6e 2032 7020 7c20 6772 6570 2022  d -n 2p | grep "
+000188d0: 4341 4e43 454c 4c49 4e47 5c7c 4341 4e43  CANCELLING\|CANC
+000188e0: 454c 4c45 4422 272c 0a20 2020 2020 2020  ELLED"',.       
+000188f0: 2020 2020 2066 277b 5f4a 4f42 5f51 5545       f'{_JOB_QUE
+00018900: 5545 5f57 4149 547d 7c20 6772 6570 202d  UE_WAIT}| grep -
+00018910: 4120 3420 7b6e 616d 657d 7c20 7365 6420  A 4 {name}| sed 
+00018920: 2d6e 2033 7020 7c20 6772 6570 2022 4341  -n 3p | grep "CA
+00018930: 4e43 454c 4c49 4e47 5c7c 4341 4e43 454c  NCELLING\|CANCEL
+00018940: 4c45 4422 272c 0a20 2020 2020 2020 2020  LED"',.         
+00018950: 2020 2066 277b 5f4a 4f42 5f51 5545 5545     f'{_JOB_QUEUE
+00018960: 5f57 4149 547d 7c20 6772 6570 202d 4120  _WAIT}| grep -A 
+00018970: 3420 7b6e 616d 657d 7c20 7365 6420 2d6e  4 {name}| sed -n
+00018980: 2034 7020 7c20 6772 6570 2022 4341 4e43   4p | grep "CANC
+00018990: 454c 4c49 4e47 5c7c 4341 4e43 454c 4c45  ELLING\|CANCELLE
+000189a0: 4422 272c 0a20 2020 2020 2020 2020 2020  D"',.           
+000189b0: 2066 277b 5f4a 4f42 5f51 5545 5545 5f57   f'{_JOB_QUEUE_W
+000189c0: 4149 547d 7c20 6772 6570 202d 4120 3420  AIT}| grep -A 4 
+000189d0: 7b6e 616d 657d 7c20 7365 6420 2d6e 2035  {name}| sed -n 5
+000189e0: 7020 7c20 6772 6570 2022 4341 4e43 454c  p | grep "CANCEL
+000189f0: 4c49 4e47 5c7c 4341 4e43 454c 4c45 4422  LING\|CANCELLED"
+00018a00: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+00018a10: 736c 6565 7020 3230 3027 2c0a 2020 2020  sleep 200',.    
+00018a20: 2020 2020 2020 2020 6627 7b5f 4a4f 425f          f'{_JOB_
+00018a30: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
+00018a40: 7020 2d41 2034 207b 6e61 6d65 7d7c 2073  p -A 4 {name}| s
+00018a50: 6564 202d 6e20 3270 207c 2067 7265 7020  ed -n 2p | grep 
+00018a60: 2243 414e 4345 4c4c 4544 2227 2c0a 2020  "CANCELLED"',.  
+00018a70: 2020 2020 2020 2020 2020 6627 7b5f 4a4f            f'{_JO
+00018a80: 425f 5155 4555 455f 5741 4954 7d7c 2067  B_QUEUE_WAIT}| g
+00018a90: 7265 7020 2d41 2034 207b 6e61 6d65 7d7c  rep -A 4 {name}|
+00018aa0: 2073 6564 202d 6e20 3370 207c 2067 7265   sed -n 3p | gre
+00018ab0: 7020 2243 414e 4345 4c4c 4544 2227 2c0a  p "CANCELLED"',.
+00018ac0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+00018ad0: 4a4f 425f 5155 4555 455f 5741 4954 7d7c  JOB_QUEUE_WAIT}|
+00018ae0: 2067 7265 7020 2d41 2034 207b 6e61 6d65   grep -A 4 {name
+00018af0: 7d7c 2073 6564 202d 6e20 3470 207c 2067  }| sed -n 4p | g
+00018b00: 7265 7020 2243 414e 4345 4c4c 4544 2227  rep "CANCELLED"'
+00018b10: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00018b20: 7b5f 4a4f 425f 5155 4555 455f 5741 4954  {_JOB_QUEUE_WAIT
+00018b30: 7d7c 2067 7265 7020 2d41 2034 207b 6e61  }| grep -A 4 {na
+00018b40: 6d65 7d7c 2073 6564 202d 6e20 3570 207c  me}| sed -n 5p |
+00018b50: 2067 7265 7020 2243 414e 4345 4c4c 4544   grep "CANCELLED
+00018b60: 2227 2c0a 2020 2020 2020 2020 5d2c 0a20  "',.        ],. 
+00018b70: 2020 2020 2020 205f 4a4f 425f 4341 4e43         _JOB_CANC
+00018b80: 454c 5f57 4149 542e 666f 726d 6174 286a  EL_WAIT.format(j
+00018b90: 6f62 5f6e 616d 653d 6627 7b6e 616d 657d  ob_name=f'{name}
+00018ba0: 2729 2c0a 2020 2020 2020 2020 2320 496e  '),.        # In
+00018bb0: 6372 6561 7365 2074 696d 656f 7574 2073  crease timeout s
+00018bc0: 696e 6365 2073 6b79 206a 6f62 7320 7175  ince sky jobs qu
+00018bd0: 6575 6520 2d72 2063 616e 2062 6520 626c  eue -r can be bl
+00018be0: 6f63 6b65 6420 6279 206f 7468 6572 2073  ocked by other s
+00018bf0: 706f 7420 7465 7374 732e 0a20 2020 2020  pot tests..     
+00018c00: 2020 2074 696d 656f 7574 3d33 3020 2a20     timeout=30 * 
+00018c10: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
+00018c20: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+00018c30: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+00018c40: 6e6f 5f66 6c75 6964 7374 6163 6b20 2023  no_fluidstack  #
+00018c50: 666c 7569 6473 7461 636b 2064 6f65 7320  fluidstack does 
+00018c60: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
+00018c70: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
+00018c80: 7374 2e6d 6172 6b2e 6e6f 5f61 7a75 7265  st.mark.no_azure
+00018c90: 2020 2320 417a 7572 6520 646f 6573 206e    # Azure does n
+00018ca0: 6f74 2073 7570 706f 7274 2073 706f 7420  ot support spot 
+00018cb0: 696e 7374 616e 6365 730a 4070 7974 6573  instances.@pytes
+00018cc0: 742e 6d61 726b 2e6e 6f5f 6c61 6d62 6461  t.mark.no_lambda
+00018cd0: 5f63 6c6f 7564 2020 2320 4c61 6d62 6461  _cloud  # Lambda
+00018ce0: 2043 6c6f 7564 2064 6f65 7320 6e6f 7420   Cloud does not 
+00018cf0: 7375 7070 6f72 7420 7370 6f74 2069 6e73  support spot ins
+00018d00: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
+00018d10: 6172 6b2e 6e6f 5f69 626d 2020 2320 4942  ark.no_ibm  # IB
+00018d20: 4d20 436c 6f75 6420 646f 6573 206e 6f74  M Cloud does not
+00018d30: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
+00018d40: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
+00018d50: 6d61 726b 2e6e 6f5f 7363 7020 2023 2053  mark.no_scp  # S
+00018d60: 4350 2064 6f65 7320 6e6f 7420 7375 7070  CP does not supp
+00018d70: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
+00018d80: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
+00018d90: 6e6f 5f70 6170 6572 7370 6163 6520 2023  no_paperspace  #
+00018da0: 2050 6170 6572 7370 6163 6520 646f 6573   Paperspace does
+00018db0: 206e 6f74 2073 7570 706f 7274 2073 706f   not support spo
+00018dc0: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
+00018dd0: 6573 742e 6d61 726b 2e6e 6f5f 6b75 6265  est.mark.no_kube
+00018de0: 726e 6574 6573 2020 2320 4b75 6265 726e  rnetes  # Kubern
+00018df0: 6574 6573 2064 6f65 7320 6e6f 7420 6861  etes does not ha
+00018e00: 7665 2061 206e 6f74 696f 6e20 6f66 2073  ve a notion of s
+00018e10: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
+00018e20: 7974 6573 742e 6d61 726b 2e6d 616e 6167  ytest.mark.manag
+00018e30: 6564 5f6a 6f62 730a 6465 6620 7465 7374  ed_jobs.def test
+00018e40: 5f6d 616e 6167 6564 5f6a 6f62 735f 6661  _managed_jobs_fa
+00018e50: 696c 6564 5f73 6574 7570 2867 656e 6572  iled_setup(gener
+00018e60: 6963 5f63 6c6f 7564 3a20 7374 7229 3a0a  ic_cloud: str):.
+00018e70: 2020 2020 2222 2254 6573 7420 6d61 6e61      """Test mana
+00018e80: 6765 6420 6a6f 6220 7769 7468 2066 6169  ged job with fai
+00018e90: 6c65 6420 7365 7475 702e 2222 220a 2020  led setup.""".  
+00018ea0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+00018eb0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+00018ec0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+00018ed0: 2020 2020 2020 276d 616e 6167 6564 5f6a        'managed_j
+00018ee0: 6f62 735f 6661 696c 6564 5f73 6574 7570  obs_failed_setup
+00018ef0: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+00018f00: 2020 2020 2020 2020 2066 2773 6b79 206a           f'sky j
+00018f10: 6f62 7320 6c61 756e 6368 202d 6e20 7b6e  obs launch -n {n
+00018f20: 616d 657d 202d 2d63 6c6f 7564 207b 6765  ame} --cloud {ge
+00018f30: 6e65 7269 635f 636c 6f75 647d 202d 7920  neric_cloud} -y 
+00018f40: 2d64 2074 6573 7473 2f74 6573 745f 7961  -d tests/test_ya
+00018f50: 6d6c 732f 6661 696c 6564 5f73 6574 7570  mls/failed_setup
+00018f60: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+00018f70: 2020 2020 2773 6c65 6570 2033 3330 272c      'sleep 330',
+00018f80: 0a20 2020 2020 2020 2020 2020 2023 204d  .            # M
+00018f90: 616b 6520 7375 7265 2074 6865 206a 6f62  ake sure the job
+00018fa0: 2066 6169 6c65 6420 7175 6963 6b6c 792e   failed quickly.
+00018fb0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+00018fc0: 5f4a 4f42 5f51 5545 5545 5f57 4149 547d  _JOB_QUEUE_WAIT}
+00018fd0: 207c 2067 7265 7020 7b6e 616d 657d 207c   | grep {name} |
+00018fe0: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+00018ff0: 2022 4641 494c 4544 5f53 4554 5550 2227   "FAILED_SETUP"'
+00019000: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+00019010: 2020 2020 205f 4a4f 425f 4341 4e43 454c       _JOB_CANCEL
+00019020: 5f57 4149 542e 666f 726d 6174 286a 6f62  _WAIT.format(job
+00019030: 5f6e 616d 653d 6e61 6d65 292c 0a20 2020  _name=name),.   
+00019040: 2020 2020 2023 2049 6e63 7265 6173 6520       # Increase 
+00019050: 7469 6d65 6f75 7420 7369 6e63 6520 736b  timeout since sk
+00019060: 7920 6a6f 6273 2071 7565 7565 202d 7220  y jobs queue -r 
+00019070: 6361 6e20 6265 2062 6c6f 636b 6564 2062  can be blocked b
+00019080: 7920 6f74 6865 7220 7370 6f74 2074 6573  y other spot tes
+00019090: 7473 2e0a 2020 2020 2020 2020 7469 6d65  ts..        time
+000190a0: 6f75 743d 3230 202a 2036 302c 0a20 2020  out=20 * 60,.   
+000190b0: 2029 0a20 2020 2072 756e 5f6f 6e65 5f74   ).    run_one_t
+000190c0: 6573 7428 7465 7374 290a 0a0a 4070 7974  est(test)...@pyt
+000190d0: 6573 742e 6d61 726b 2e6e 6f5f 666c 7569  est.mark.no_flui
+000190e0: 6473 7461 636b 2020 2366 6c75 6964 7374  dstack  #fluidst
+000190f0: 6163 6b20 646f 6573 206e 6f74 2073 7570  ack does not sup
+00019100: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
+00019110: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
+00019120: 2e6e 6f5f 617a 7572 6520 2023 2041 7a75  .no_azure  # Azu
+00019130: 7265 2064 6f65 7320 6e6f 7420 7375 7070  re does not supp
+00019140: 6f72 7420 7370 6f74 2069 6e73 7461 6e63  ort spot instanc
+00019150: 6573 0a40 7079 7465 7374 2e6d 6172 6b2e  es.@pytest.mark.
+00019160: 6e6f 5f6c 616d 6264 615f 636c 6f75 6420  no_lambda_cloud 
+00019170: 2023 204c 616d 6264 6120 436c 6f75 6420   # Lambda Cloud 
+00019180: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
+00019190: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
+000191a0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+000191b0: 6962 6d20 2023 2049 424d 2043 6c6f 7564  ibm  # IBM Cloud
+000191c0: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
+000191d0: 7420 7370 6f74 2069 6e73 7461 6e63 6573  t spot instances
+000191e0: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+000191f0: 5f73 6370 2020 2320 5343 5020 646f 6573  _scp  # SCP does
+00019200: 206e 6f74 2073 7570 706f 7274 2073 706f   not support spo
+00019210: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
+00019220: 6573 742e 6d61 726b 2e6e 6f5f 7061 7065  est.mark.no_pape
+00019230: 7273 7061 6365 2020 2320 5061 7065 7273  rspace  # Papers
+00019240: 7061 6365 2064 6f65 7320 6e6f 7420 7375  pace does not su
+00019250: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
+00019260: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
+00019270: 6b2e 6e6f 5f6b 7562 6572 6e65 7465 7320  k.no_kubernetes 
+00019280: 2023 204b 7562 6572 6e65 7465 7320 646f   # Kubernetes do
+00019290: 6573 206e 6f74 2068 6176 6520 6120 6e6f  es not have a no
+000192a0: 7469 6f6e 206f 6620 7370 6f74 2069 6e73  tion of spot ins
+000192b0: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
+000192c0: 6172 6b2e 6d61 6e61 6765 645f 6a6f 6273  ark.managed_jobs
+000192d0: 0a64 6566 2074 6573 745f 6d61 6e61 6765  .def test_manage
+000192e0: 645f 6a6f 6273 5f70 6970 656c 696e 655f  d_jobs_pipeline_
+000192f0: 6661 696c 6564 5f73 6574 7570 2867 656e  failed_setup(gen
+00019300: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
+00019310: 3a0a 2020 2020 2222 2254 6573 7420 6d61  :.    """Test ma
+00019320: 6e61 6765 6420 6a6f 6220 7769 7468 2066  naged job with f
+00019330: 6169 6c65 6420 7365 7475 7020 666f 7220  ailed setup for 
+00019340: 6120 7069 7065 6c69 6e65 2e22 2222 0a20  a pipeline.""". 
+00019350: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+00019360: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+00019370: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+00019380: 2020 2020 2020 2027 6d61 6e61 6765 645f         'managed_
+00019390: 6a6f 6273 5f70 6970 656c 696e 655f 6661  jobs_pipeline_fa
+000193a0: 696c 6564 5f73 6574 7570 272c 0a20 2020  iled_setup',.   
+000193b0: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+000193c0: 2020 2066 2773 6b79 206a 6f62 7320 6c61     f'sky jobs la
+000193d0: 756e 6368 202d 6e20 7b6e 616d 657d 202d  unch -n {name} -
+000193e0: 7920 2d64 2074 6573 7473 2f74 6573 745f  y -d tests/test_
+000193f0: 7961 6d6c 732f 6661 696c 6564 5f73 6574  yamls/failed_set
+00019400: 7570 5f70 6970 656c 696e 652e 7961 6d6c  up_pipeline.yaml
+00019410: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+00019420: 736c 6565 7020 3630 3027 2c0a 2020 2020  sleep 600',.    
+00019430: 2020 2020 2020 2020 2320 4d61 6b65 2073          # Make s
+00019440: 7572 6520 7468 6520 6a6f 6220 6661 696c  ure the job fail
+00019450: 6564 2071 7569 636b 6c79 2e0a 2020 2020  ed quickly..    
+00019460: 2020 2020 2020 2020 6627 7b5f 4a4f 425f          f'{_JOB_
+00019470: 5155 4555 455f 5741 4954 7d20 7c20 6772  QUEUE_WAIT} | gr
+00019480: 6570 207b 6e61 6d65 7d20 7c20 6865 6164  ep {name} | head
+00019490: 202d 6e31 207c 2067 7265 7020 2246 4149   -n1 | grep "FAI
+000194a0: 4c45 445f 5345 5455 5022 272c 0a20 2020  LED_SETUP"',.   
+000194b0: 2020 2020 2020 2020 2023 2054 6173 6b20           # Task 
+000194c0: 3020 7368 6f75 6c64 2062 6520 5355 4343  0 should be SUCC
+000194d0: 4545 4445 442e 0a20 2020 2020 2020 2020  EEDED..         
+000194e0: 2020 2066 277b 5f4a 4f42 5f51 5545 5545     f'{_JOB_QUEUE
+000194f0: 5f57 4149 547d 207c 2067 7265 7020 2d41  _WAIT} | grep -A
+00019500: 2034 207b 6e61 6d65 7d7c 2073 6564 202d   4 {name}| sed -
+00019510: 6e20 3270 207c 2067 7265 7020 2253 5543  n 2p | grep "SUC
+00019520: 4345 4544 4544 2227 2c0a 2020 2020 2020  CEEDED"',.      
+00019530: 2020 2020 2020 2320 5461 736b 2031 2073        # Task 1 s
+00019540: 686f 756c 6420 6265 2046 4149 4c45 445f  hould be FAILED_
+00019550: 5345 5455 502e 0a20 2020 2020 2020 2020  SETUP..         
+00019560: 2020 2066 277b 5f4a 4f42 5f51 5545 5545     f'{_JOB_QUEUE
+00019570: 5f57 4149 547d 207c 2067 7265 7020 2d41  _WAIT} | grep -A
+00019580: 2034 207b 6e61 6d65 7d7c 2073 6564 202d   4 {name}| sed -
+00019590: 6e20 3370 207c 2067 7265 7020 2246 4149  n 3p | grep "FAI
+000195a0: 4c45 445f 5345 5455 5022 272c 0a20 2020  LED_SETUP"',.   
+000195b0: 2020 2020 2020 2020 2023 2054 6173 6b20           # Task 
+000195c0: 3220 7368 6f75 6c64 2062 6520 4341 4e43  2 should be CANC
+000195d0: 454c 4c45 442e 0a20 2020 2020 2020 2020  ELLED..         
+000195e0: 2020 2066 277b 5f4a 4f42 5f51 5545 5545     f'{_JOB_QUEUE
+000195f0: 5f57 4149 547d 207c 2067 7265 7020 2d41  _WAIT} | grep -A
+00019600: 2034 207b 6e61 6d65 7d7c 2073 6564 202d   4 {name}| sed -
+00019610: 6e20 3470 207c 2067 7265 7020 2243 414e  n 4p | grep "CAN
+00019620: 4345 4c4c 4544 2227 2c0a 2020 2020 2020  CELLED"',.      
+00019630: 2020 2020 2020 2320 5461 736b 2033 2073        # Task 3 s
+00019640: 686f 756c 6420 6265 2043 414e 4345 4c4c  hould be CANCELL
+00019650: 4544 2e0a 2020 2020 2020 2020 2020 2020  ED..            
+00019660: 6627 7b5f 4a4f 425f 5155 4555 455f 5741  f'{_JOB_QUEUE_WA
+00019670: 4954 7d20 7c20 6772 6570 202d 4120 3420  IT} | grep -A 4 
+00019680: 7b6e 616d 657d 7c20 7365 6420 2d6e 2035  {name}| sed -n 5
+00019690: 7020 7c20 6772 6570 2022 4341 4e43 454c  p | grep "CANCEL
+000196a0: 4c45 4422 272c 0a20 2020 2020 2020 205d  LED"',.        ]
+000196b0: 2c0a 2020 2020 2020 2020 5f4a 4f42 5f43  ,.        _JOB_C
+000196c0: 414e 4345 4c5f 5741 4954 2e66 6f72 6d61  ANCEL_WAIT.forma
+000196d0: 7428 6a6f 625f 6e61 6d65 3d6e 616d 6529  t(job_name=name)
+000196e0: 2c0a 2020 2020 2020 2020 2320 496e 6372  ,.        # Incr
+000196f0: 6561 7365 2074 696d 656f 7574 2073 696e  ease timeout sin
+00019700: 6365 2073 6b79 206a 6f62 7320 7175 6575  ce sky jobs queu
+00019710: 6520 2d72 2063 616e 2062 6520 626c 6f63  e -r can be bloc
+00019720: 6b65 6420 6279 206f 7468 6572 2073 706f  ked by other spo
+00019730: 7420 7465 7374 732e 0a20 2020 2020 2020  t tests..       
+00019740: 2074 696d 656f 7574 3d33 3020 2a20 3630   timeout=30 * 60
+00019750: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
+00019760: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+00019770: 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20 5465  .# ---------- Te
+00019780: 7374 696e 6720 6d61 6e61 6765 6420 6a6f  sting managed jo
+00019790: 6220 7265 636f 7665 7279 202d 2d2d 2d2d  b recovery -----
+000197a0: 2d2d 2d2d 2d0a 0a0a 4070 7974 6573 742e  -----...@pytest.
+000197b0: 6d61 726b 2e61 7773 0a40 7079 7465 7374  mark.aws.@pytest
+000197c0: 2e6d 6172 6b2e 6d61 6e61 6765 645f 6a6f  .mark.managed_jo
+000197d0: 6273 0a64 6566 2074 6573 745f 6d61 6e61  bs.def test_mana
+000197e0: 6765 645f 6a6f 6273 5f72 6563 6f76 6572  ged_jobs_recover
+000197f0: 795f 6177 7328 6177 735f 636f 6e66 6967  y_aws(aws_config
+00019800: 5f72 6567 696f 6e29 3a0a 2020 2020 2222  _region):.    ""
+00019810: 2254 6573 7420 6d61 6e61 6765 6420 6a6f  "Test managed jo
+00019820: 6220 7265 636f 7665 7279 2e22 2222 0a20  b recovery.""". 
+00019830: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+00019840: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+00019850: 2020 6e61 6d65 5f6f 6e5f 636c 6f75 6420    name_on_cloud 
+00019860: 3d20 636f 6d6d 6f6e 5f75 7469 6c73 2e6d  = common_utils.m
+00019870: 616b 655f 636c 7573 7465 725f 6e61 6d65  ake_cluster_name
+00019880: 5f6f 6e5f 636c 6f75 6428 0a20 2020 2020  _on_cloud(.     
+00019890: 2020 206e 616d 652c 206a 6f62 732e 4a4f     name, jobs.JO
+000198a0: 4253 5f43 4c55 5354 4552 5f4e 414d 455f  BS_CLUSTER_NAME_
+000198b0: 5052 4546 4958 5f4c 454e 4754 482c 2061  PREFIX_LENGTH, a
+000198c0: 6464 5f75 7365 725f 6861 7368 3d46 616c  dd_user_hash=Fal
+000198d0: 7365 290a 2020 2020 7265 6769 6f6e 203d  se).    region =
+000198e0: 2061 7773 5f63 6f6e 6669 675f 7265 6769   aws_config_regi
+000198f0: 6f6e 0a20 2020 2074 6573 7420 3d20 5465  on.    test = Te
+00019900: 7374 280a 2020 2020 2020 2020 276d 616e  st(.        'man
+00019910: 6167 6564 5f6a 6f62 735f 7265 636f 7665  aged_jobs_recove
+00019920: 7279 5f61 7773 272c 0a20 2020 2020 2020  ry_aws',.       
+00019930: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+00019940: 2773 6b79 206a 6f62 7320 6c61 756e 6368  'sky jobs launch
+00019950: 202d 2d63 6c6f 7564 2061 7773 202d 2d72   --cloud aws --r
+00019960: 6567 696f 6e20 7b72 6567 696f 6e7d 202d  egion {region} -
+00019970: 2d75 7365 2d73 706f 7420 2d6e 207b 6e61  -use-spot -n {na
+00019980: 6d65 7d20 2265 6368 6f20 534b 5950 494c  me} "echo SKYPIL
+00019990: 4f54 5f54 4153 4b5f 4944 3a20 5c24 534b  OT_TASK_ID: \$SK
+000199a0: 5950 494c 4f54 5f54 4153 4b5f 4944 3b20  YPILOT_TASK_ID; 
+000199b0: 736c 6565 7020 3138 3030 2220 202d 7920  sleep 1800"  -y 
+000199c0: 2d64 272c 0a20 2020 2020 2020 2020 2020  -d',.           
+000199d0: 2027 736c 6565 7020 3336 3027 2c0a 2020   'sleep 360',.  
+000199e0: 2020 2020 2020 2020 2020 6627 7b5f 4a4f            f'{_JO
+000199f0: 425f 5155 4555 455f 5741 4954 7d7c 2067  B_QUEUE_WAIT}| g
+00019a00: 7265 7020 7b6e 616d 657d 207c 2068 6561  rep {name} | hea
+00019a10: 6420 2d6e 3120 7c20 6772 6570 2022 5255  d -n1 | grep "RU
+00019a20: 4e4e 494e 4722 272c 0a20 2020 2020 2020  NNING"',.       
+00019a30: 2020 2020 2066 2752 554e 5f49 443d 2428       f'RUN_ID=$(
+00019a40: 736b 7920 6a6f 6273 206c 6f67 7320 2d6e  sky jobs logs -n
+00019a50: 207b 6e61 6d65 7d20 2d2d 6e6f 2d66 6f6c   {name} --no-fol
+00019a60: 6c6f 7720 7c20 6772 6570 2053 4b59 5049  low | grep SKYPI
+00019a70: 4c4f 545f 5441 534b 5f49 4420 7c20 6375  LOT_TASK_ID | cu
+00019a80: 7420 2d64 3a20 2d66 3229 3b20 6563 686f  t -d: -f2); echo
+00019a90: 2022 2452 554e 5f49 4422 207c 2074 6565   "$RUN_ID" | tee
+00019aa0: 202f 746d 702f 7b6e 616d 657d 2d72 756e   /tmp/{name}-run
+00019ab0: 2d69 6427 2c0a 2020 2020 2020 2020 2020  -id',.          
+00019ac0: 2020 2320 5465 726d 696e 6174 6520 7468    # Terminate th
+00019ad0: 6520 636c 7573 7465 7220 6d61 6e75 616c  e cluster manual
+00019ae0: 6c79 2e0a 2020 2020 2020 2020 2020 2020  ly..            
+00019af0: 2866 2761 7773 2065 6332 2074 6572 6d69  (f'aws ec2 termi
+00019b00: 6e61 7465 2d69 6e73 7461 6e63 6573 202d  nate-instances -
+00019b10: 2d72 6567 696f 6e20 7b72 6567 696f 6e7d  -region {region}
+00019b20: 202d 2d69 6e73 7461 6e63 652d 6964 7320   --instance-ids 
+00019b30: 2428 270a 2020 2020 2020 2020 2020 2020  $('.            
+00019b40: 2066 2761 7773 2065 6332 2064 6573 6372   f'aws ec2 descr
+00019b50: 6962 652d 696e 7374 616e 6365 7320 2d2d  ibe-instances --
+00019b60: 7265 6769 6f6e 207b 7265 6769 6f6e 7d20  region {region} 
+00019b70: 270a 2020 2020 2020 2020 2020 2020 2066  '.             f
+00019b80: 272d 2d66 696c 7465 7273 204e 616d 653d  '--filters Name=
+00019b90: 7461 673a 7261 792d 636c 7573 7465 722d  tag:ray-cluster-
+00019ba0: 6e61 6d65 2c56 616c 7565 733d 7b6e 616d  name,Values={nam
+00019bb0: 655f 6f6e 5f63 6c6f 7564 7d2a 2027 0a20  e_on_cloud}* '. 
+00019bc0: 2020 2020 2020 2020 2020 2020 6627 2d2d              f'--
+00019bd0: 7175 6572 7920 5265 7365 7276 6174 696f  query Reservatio
+00019be0: 6e73 5b5d 2e49 6e73 7461 6e63 6573 5b5d  ns[].Instances[]
+00019bf0: 2e49 6e73 7461 6e63 6549 6420 270a 2020  .InstanceId '.  
+00019c00: 2020 2020 2020 2020 2020 2027 2d2d 6f75             '--ou
+00019c10: 7470 7574 2074 6578 7429 2729 2c0a 2020  tput text)'),.  
+00019c20: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+00019c30: 2031 3030 272c 0a20 2020 2020 2020 2020   100',.         
+00019c40: 2020 2066 277b 5f4a 4f42 5f51 5545 5545     f'{_JOB_QUEUE
+00019c50: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+00019c60: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
+00019c70: 2067 7265 7020 2252 4543 4f56 4552 494e   grep "RECOVERIN
+00019c80: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
+00019c90: 2027 736c 6565 7020 3230 3027 2c0a 2020   'sleep 200',.  
+00019ca0: 2020 2020 2020 2020 2020 6627 7b5f 4a4f            f'{_JO
+00019cb0: 425f 5155 4555 455f 5741 4954 7d7c 2067  B_QUEUE_WAIT}| g
+00019cc0: 7265 7020 7b6e 616d 657d 207c 2068 6561  rep {name} | hea
+00019cd0: 6420 2d6e 3120 7c20 6772 6570 2022 5255  d -n1 | grep "RU
+00019ce0: 4e4e 494e 4722 272c 0a20 2020 2020 2020  NNING"',.       
+00019cf0: 2020 2020 2066 2752 554e 5f49 443d 2428       f'RUN_ID=$(
+00019d00: 6361 7420 2f74 6d70 2f7b 6e61 6d65 7d2d  cat /tmp/{name}-
+00019d10: 7275 6e2d 6964 293b 2065 6368 6f20 2224  run-id); echo "$
+00019d20: 5255 4e5f 4944 223b 2073 6b79 206a 6f62  RUN_ID"; sky job
+00019d30: 7320 6c6f 6773 202d 6e20 7b6e 616d 657d  s logs -n {name}
+00019d40: 202d 2d6e 6f2d 666f 6c6c 6f77 207c 2067   --no-follow | g
+00019d50: 7265 7020 534b 5950 494c 4f54 5f54 4153  rep SKYPILOT_TAS
+00019d60: 4b5f 4944 207c 2067 7265 7020 2224 5255  K_ID | grep "$RU
+00019d70: 4e5f 4944 2227 2c0a 2020 2020 2020 2020  N_ID"',.        
+00019d80: 5d2c 0a20 2020 2020 2020 205f 4a4f 425f  ],.        _JOB_
+00019d90: 4341 4e43 454c 5f57 4149 542e 666f 726d  CANCEL_WAIT.form
+00019da0: 6174 286a 6f62 5f6e 616d 653d 6e61 6d65  at(job_name=name
+00019db0: 292c 0a20 2020 2020 2020 2074 696d 656f  ),.        timeo
+00019dc0: 7574 3d32 3520 2a20 3630 2c0a 2020 2020  ut=25 * 60,.    
+00019dd0: 290a 2020 2020 7275 6e5f 6f6e 655f 7465  ).    run_one_te
+00019de0: 7374 2874 6573 7429 0a0a 0a40 7079 7465  st(test)...@pyte
+00019df0: 7374 2e6d 6172 6b2e 6763 700a 4070 7974  st.mark.gcp.@pyt
+00019e00: 6573 742e 6d61 726b 2e6d 616e 6167 6564  est.mark.managed
+00019e10: 5f6a 6f62 730a 6465 6620 7465 7374 5f6d  _jobs.def test_m
+00019e20: 616e 6167 6564 5f6a 6f62 735f 7265 636f  anaged_jobs_reco
+00019e30: 7665 7279 5f67 6370 2829 3a0a 2020 2020  very_gcp():.    
+00019e40: 2222 2254 6573 7420 6d61 6e61 6765 6420  """Test managed 
+00019e50: 6a6f 6220 7265 636f 7665 7279 2e22 2222  job recovery."""
+00019e60: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+00019e70: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+00019e80: 2020 2020 6e61 6d65 5f6f 6e5f 636c 6f75      name_on_clou
+00019e90: 6420 3d20 636f 6d6d 6f6e 5f75 7469 6c73  d = common_utils
+00019ea0: 2e6d 616b 655f 636c 7573 7465 725f 6e61  .make_cluster_na
+00019eb0: 6d65 5f6f 6e5f 636c 6f75 6428 0a20 2020  me_on_cloud(.   
+00019ec0: 2020 2020 206e 616d 652c 206a 6f62 732e       name, jobs.
+00019ed0: 4a4f 4253 5f43 4c55 5354 4552 5f4e 414d  JOBS_CLUSTER_NAM
+00019ee0: 455f 5052 4546 4958 5f4c 454e 4754 482c  E_PREFIX_LENGTH,
+00019ef0: 2061 6464 5f75 7365 725f 6861 7368 3d46   add_user_hash=F
+00019f00: 616c 7365 290a 2020 2020 7a6f 6e65 203d  alse).    zone =
+00019f10: 2027 7573 2d65 6173 7434 2d62 270a 2020   'us-east4-b'.  
+00019f20: 2020 7175 6572 795f 636d 6420 3d20 280a    query_cmd = (.
+00019f30: 2020 2020 2020 2020 6627 6763 6c6f 7564          f'gcloud
+00019f40: 2063 6f6d 7075 7465 2069 6e73 7461 6e63   compute instanc
+00019f50: 6573 206c 6973 7420 2d2d 6669 6c74 6572  es list --filter
+00019f60: 3d27 0a20 2020 2020 2020 2023 2060 3a60  ='.        # `:`
+00019f70: 206d 6561 6e73 2070 7265 6669 7820 6d61   means prefix ma
+00019f80: 7463 682e 0a20 2020 2020 2020 2066 2722  tch..        f'"
+00019f90: 286c 6162 656c 732e 7261 792d 636c 7573  (labels.ray-clus
+00019fa0: 7465 722d 6e61 6d65 3a7b 6e61 6d65 5f6f  ter-name:{name_o
+00019fb0: 6e5f 636c 6f75 647d 2922 2027 0a20 2020  n_cloud})" '.   
+00019fc0: 2020 2020 2066 272d 2d7a 6f6e 6573 3d7b       f'--zones={
+00019fd0: 7a6f 6e65 7d20 2d2d 666f 726d 6174 3d22  zone} --format="
+00019fe0: 7661 6c75 6528 6e61 6d65 2922 2729 0a20  value(name)"'). 
+00019ff0: 2020 2074 6572 6d69 6e61 7465 5f63 6d64     terminate_cmd
+0001a000: 203d 2028 6627 6763 6c6f 7564 2063 6f6d   = (f'gcloud com
+0001a010: 7075 7465 2069 6e73 7461 6e63 6573 2064  pute instances d
+0001a020: 656c 6574 6520 2d2d 7a6f 6e65 3d7b 7a6f  elete --zone={zo
+0001a030: 6e65 7d27 0a20 2020 2020 2020 2020 2020  ne}'.           
+0001a040: 2020 2020 2020 2020 2020 6627 202d 2d71            f' --q
+0001a050: 7569 6574 2024 287b 7175 6572 795f 636d  uiet $({query_cm
+0001a060: 647d 2927 290a 2020 2020 7465 7374 203d  d})').    test =
+0001a070: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
+0001a080: 6d61 6e61 6765 645f 6a6f 6273 5f72 6563  managed_jobs_rec
+0001a090: 6f76 6572 795f 6763 7027 2c0a 2020 2020  overy_gcp',.    
+0001a0a0: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+0001a0b0: 2020 6627 736b 7920 6a6f 6273 206c 6175    f'sky jobs lau
+0001a0c0: 6e63 6820 2d2d 636c 6f75 6420 6763 7020  nch --cloud gcp 
+0001a0d0: 2d2d 7a6f 6e65 207b 7a6f 6e65 7d20 2d6e  --zone {zone} -n
+0001a0e0: 207b 6e61 6d65 7d20 2d2d 7573 652d 7370   {name} --use-sp
+0001a0f0: 6f74 202d 2d63 7075 7320 3220 2265 6368  ot --cpus 2 "ech
+0001a100: 6f20 534b 5950 494c 4f54 5f54 4153 4b5f  o SKYPILOT_TASK_
+0001a110: 4944 3a20 5c24 534b 5950 494c 4f54 5f54  ID: \$SKYPILOT_T
+0001a120: 4153 4b5f 4944 3b20 736c 6565 7020 3138  ASK_ID; sleep 18
+0001a130: 3030 2220 202d 7920 2d64 272c 0a20 2020  00"  -y -d',.   
+0001a140: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+0001a150: 3336 3027 2c0a 2020 2020 2020 2020 2020  360',.          
+0001a160: 2020 6627 7b5f 4a4f 425f 5155 4555 455f    f'{_JOB_QUEUE_
+0001a170: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
+0001a180: 657d 207c 2068 6561 6420 2d6e 3120 7c20  e} | head -n1 | 
+0001a190: 6772 6570 2022 5255 4e4e 494e 4722 272c  grep "RUNNING"',
+0001a1a0: 0a20 2020 2020 2020 2020 2020 2066 2752  .            f'R
+0001a1b0: 554e 5f49 443d 2428 736b 7920 6a6f 6273  UN_ID=$(sky jobs
+0001a1c0: 206c 6f67 7320 2d6e 207b 6e61 6d65 7d20   logs -n {name} 
+0001a1d0: 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20 6772  --no-follow | gr
+0001a1e0: 6570 2053 4b59 5049 4c4f 545f 5441 534b  ep SKYPILOT_TASK
+0001a1f0: 5f49 4420 7c20 6375 7420 2d64 3a20 2d66  _ID | cut -d: -f
+0001a200: 3229 3b20 6563 686f 2022 2452 554e 5f49  2); echo "$RUN_I
+0001a210: 4422 207c 2074 6565 202f 746d 702f 7b6e  D" | tee /tmp/{n
+0001a220: 616d 657d 2d72 756e 2d69 6427 2c0a 2020  ame}-run-id',.  
+0001a230: 2020 2020 2020 2020 2020 2320 5465 726d            # Term
+0001a240: 696e 6174 6520 7468 6520 636c 7573 7465  inate the cluste
+0001a250: 7220 6d61 6e75 616c 6c79 2e0a 2020 2020  r manually..    
+0001a260: 2020 2020 2020 2020 7465 726d 696e 6174          terminat
+0001a270: 655f 636d 642c 0a20 2020 2020 2020 2020  e_cmd,.         
+0001a280: 2020 2027 736c 6565 7020 3630 272c 0a20     'sleep 60',. 
+0001a290: 2020 2020 2020 2020 2020 2066 277b 5f4a             f'{_J
+0001a2a0: 4f42 5f51 5545 5545 5f57 4149 547d 7c20  OB_QUEUE_WAIT}| 
+0001a2b0: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
+0001a2c0: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
+0001a2d0: 4543 4f56 4552 494e 4722 272c 0a20 2020  ECOVERING"',.   
+0001a2e0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+0001a2f0: 3230 3027 2c0a 2020 2020 2020 2020 2020  200',.          
+0001a300: 2020 6627 7b5f 4a4f 425f 5155 4555 455f    f'{_JOB_QUEUE_
+0001a310: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
+0001a320: 657d 207c 2068 6561 6420 2d6e 3120 7c20  e} | head -n1 | 
+0001a330: 6772 6570 2022 5255 4e4e 494e 4722 272c  grep "RUNNING"',
+0001a340: 0a20 2020 2020 2020 2020 2020 2066 2752  .            f'R
+0001a350: 554e 5f49 443d 2428 6361 7420 2f74 6d70  UN_ID=$(cat /tmp
+0001a360: 2f7b 6e61 6d65 7d2d 7275 6e2d 6964 293b  /{name}-run-id);
+0001a370: 2065 6368 6f20 2224 5255 4e5f 4944 223b   echo "$RUN_ID";
+0001a380: 2073 6b79 206a 6f62 7320 6c6f 6773 202d   sky jobs logs -
+0001a390: 6e20 7b6e 616d 657d 202d 2d6e 6f2d 666f  n {name} --no-fo
+0001a3a0: 6c6c 6f77 207c 2067 7265 7020 534b 5950  llow | grep SKYP
+0001a3b0: 494c 4f54 5f54 4153 4b5f 4944 3a20 7c20  ILOT_TASK_ID: | 
+0001a3c0: 6772 6570 2022 2452 554e 5f49 4422 272c  grep "$RUN_ID"',
+0001a3d0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+0001a3e0: 2020 2020 5f4a 4f42 5f43 414e 4345 4c5f      _JOB_CANCEL_
+0001a3f0: 5741 4954 2e66 6f72 6d61 7428 6a6f 625f  WAIT.format(job_
+0001a400: 6e61 6d65 3d6e 616d 6529 2c0a 2020 2020  name=name),.    
+0001a410: 2020 2020 7469 6d65 6f75 743d 3235 202a      timeout=25 *
+0001a420: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
+0001a430: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+0001a440: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+0001a450: 2e61 7773 0a40 7079 7465 7374 2e6d 6172  .aws.@pytest.mar
+0001a460: 6b2e 6d61 6e61 6765 645f 6a6f 6273 0a64  k.managed_jobs.d
+0001a470: 6566 2074 6573 745f 6d61 6e61 6765 645f  ef test_managed_
+0001a480: 6a6f 6273 5f70 6970 656c 696e 655f 7265  jobs_pipeline_re
+0001a490: 636f 7665 7279 5f61 7773 2861 7773 5f63  covery_aws(aws_c
+0001a4a0: 6f6e 6669 675f 7265 6769 6f6e 293a 0a20  onfig_region):. 
+0001a4b0: 2020 2022 2222 5465 7374 206d 616e 6167     """Test manag
+0001a4c0: 6564 206a 6f62 2072 6563 6f76 6572 7920  ed job recovery 
+0001a4d0: 666f 7220 6120 7069 7065 6c69 6e65 2e22  for a pipeline."
+0001a4e0: 2222 0a20 2020 206e 616d 6520 3d20 5f67  "".    name = _g
+0001a4f0: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+0001a500: 290a 2020 2020 7573 6572 5f68 6173 6820  ).    user_hash 
+0001a510: 3d20 636f 6d6d 6f6e 5f75 7469 6c73 2e67  = common_utils.g
+0001a520: 6574 5f75 7365 725f 6861 7368 2829 0a20  et_user_hash(). 
+0001a530: 2020 2075 7365 725f 6861 7368 203d 2075     user_hash = u
+0001a540: 7365 725f 6861 7368 5b3a 636f 6d6d 6f6e  ser_hash[:common
+0001a550: 5f75 7469 6c73 2e55 5345 525f 4841 5348  _utils.USER_HASH
+0001a560: 5f4c 454e 4754 485f 494e 5f43 4c55 5354  _LENGTH_IN_CLUST
+0001a570: 4552 5f4e 414d 455d 0a20 2020 2072 6567  ER_NAME].    reg
+0001a580: 696f 6e20 3d20 6177 735f 636f 6e66 6967  ion = aws_config
+0001a590: 5f72 6567 696f 6e0a 2020 2020 6966 2072  _region.    if r
+0001a5a0: 6567 696f 6e20 213d 2027 7573 2d65 6173  egion != 'us-eas
+0001a5b0: 742d 3227 3a0a 2020 2020 2020 2020 7079  t-2':.        py
+0001a5c0: 7465 7374 2e73 6b69 7028 274f 6e6c 7920  test.skip('Only 
+0001a5d0: 7275 6e20 7370 6f74 2070 6970 656c 696e  run spot pipelin
+0001a5e0: 6520 7265 636f 7665 7279 2074 6573 7420  e recovery test 
+0001a5f0: 696e 2075 732d 6561 7374 2d32 2729 0a20  in us-east-2'). 
+0001a600: 2020 2074 6573 7420 3d20 5465 7374 280a     test = Test(.
+0001a610: 2020 2020 2020 2020 276d 616e 6167 6564          'managed
+0001a620: 5f6a 6f62 735f 7069 7065 6c69 6e65 5f72  _jobs_pipeline_r
+0001a630: 6563 6f76 6572 795f 6177 7327 2c0a 2020  ecovery_aws',.  
+0001a640: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+0001a650: 2020 2020 6627 736b 7920 6a6f 6273 206c      f'sky jobs l
+0001a660: 6175 6e63 6820 2d6e 207b 6e61 6d65 7d20  aunch -n {name} 
+0001a670: 7465 7374 732f 7465 7374 5f79 616d 6c73  tests/test_yamls
+0001a680: 2f70 6970 656c 696e 655f 6177 732e 7961  /pipeline_aws.ya
+0001a690: 6d6c 2020 2d79 202d 6427 2c0a 2020 2020  ml  -y -d',.    
+0001a6a0: 2020 2020 2020 2020 2773 6c65 6570 2034          'sleep 4
+0001a6b0: 3030 272c 0a20 2020 2020 2020 2020 2020  00',.           
+0001a6c0: 2066 277b 5f4a 4f42 5f51 5545 5545 5f57   f'{_JOB_QUEUE_W
+0001a6d0: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
+0001a6e0: 7d20 7c20 6865 6164 202d 6e31 207c 2067  } | head -n1 | g
+0001a6f0: 7265 7020 2252 554e 4e49 4e47 2227 2c0a  rep "RUNNING"',.
+0001a700: 2020 2020 2020 2020 2020 2020 6627 5255              f'RU
+0001a710: 4e5f 4944 3d24 2873 6b79 206a 6f62 7320  N_ID=$(sky jobs 
+0001a720: 6c6f 6773 202d 6e20 7b6e 616d 657d 202d  logs -n {name} -
+0001a730: 2d6e 6f2d 666f 6c6c 6f77 207c 2067 7265  -no-follow | gre
+0001a740: 7020 534b 5950 494c 4f54 5f54 4153 4b5f  p SKYPILOT_TASK_
+0001a750: 4944 3a20 7c20 6375 7420 2d64 3a20 2d66  ID: | cut -d: -f
+0001a760: 3229 3b20 6563 686f 2022 2452 554e 5f49  2); echo "$RUN_I
+0001a770: 4422 207c 2074 6565 202f 746d 702f 7b6e  D" | tee /tmp/{n
+0001a780: 616d 657d 2d72 756e 2d69 6427 2c0a 2020  ame}-run-id',.  
+0001a790: 2020 2020 2020 2020 2020 6627 5255 4e5f            f'RUN_
+0001a7a0: 4944 533d 2428 736b 7920 6a6f 6273 206c  IDS=$(sky jobs l
+0001a7b0: 6f67 7320 2d6e 207b 6e61 6d65 7d20 2d2d  ogs -n {name} --
+0001a7c0: 6e6f 2d66 6f6c 6c6f 7720 7c20 6772 6570  no-follow | grep
+0001a7d0: 202d 4120 3420 534b 5950 494c 4f54 5f54   -A 4 SKYPILOT_T
+0001a7e0: 4153 4b5f 4944 5320 7c20 6375 7420 2d64  ASK_IDS | cut -d
+0001a7f0: 2229 2220 2d66 3229 3b20 6563 686f 2022  ")" -f2); echo "
+0001a800: 2452 554e 5f49 4453 2220 7c20 7465 6520  $RUN_IDS" | tee 
+0001a810: 2f74 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d  /tmp/{name}-run-
+0001a820: 6964 7327 2c0a 2020 2020 2020 2020 2020  ids',.          
+0001a830: 2020 2320 5465 726d 696e 6174 6520 7468    # Terminate th
+0001a840: 6520 636c 7573 7465 7220 6d61 6e75 616c  e cluster manual
+0001a850: 6c79 2e0a 2020 2020 2020 2020 2020 2020  ly..            
+0001a860: 2320 5468 6520 6063 6174 202e 2e2e 7c20  # The `cat ...| 
+0001a870: 7265 7660 2069 7320 746f 2072 6574 7269  rev` is to retri
+0001a880: 6576 6520 7468 6520 6a6f 625f 6964 2066  eve the job_id f
+0001a890: 726f 6d20 7468 650a 2020 2020 2020 2020  rom the.        
+0001a8a0: 2020 2020 2320 534b 5950 494c 4f54 5f54      # SKYPILOT_T
+0001a8b0: 4153 4b5f 4944 2c20 7768 6963 6820 6765  ASK_ID, which ge
+0001a8c0: 7473 2074 6865 2073 6563 6f6e 6420 746f  ts the second to
+0001a8d0: 206c 6173 7420 6669 656c 640a 2020 2020   last field.    
+0001a8e0: 2020 2020 2020 2020 2320 7365 7061 7261          # separa
+0001a8f0: 7465 6420 6279 2060 2d60 2e0a 2020 2020  ted by `-`..    
+0001a900: 2020 2020 2020 2020 280a 2020 2020 2020          (.      
+0001a910: 2020 2020 2020 2020 2020 6627 4d41 4e41            f'MANA
+0001a920: 4745 445f 4a4f 425f 4944 3d60 6361 7420  GED_JOB_ID=`cat 
+0001a930: 2f74 6d70 2f7b 6e61 6d65 7d2d 7275 6e2d  /tmp/{name}-run-
+0001a940: 6964 207c 2072 6576 207c 2027 0a20 2020  id | rev | '.   
+0001a950: 2020 2020 2020 2020 2020 2020 2027 6375               'cu
+0001a960: 7420 2d64 5c27 5f5c 2720 2d66 3120 7c20  t -d\'_\' -f1 | 
+0001a970: 7265 7620 7c20 6375 7420 2d64 5c27 2d5c  rev | cut -d\'-\
+0001a980: 2720 2d66 3160 3b27 0a20 2020 2020 2020  ' -f1`;'.       
+0001a990: 2020 2020 2020 2020 2066 2761 7773 2065           f'aws e
+0001a9a0: 6332 2074 6572 6d69 6e61 7465 2d69 6e73  c2 terminate-ins
+0001a9b0: 7461 6e63 6573 202d 2d72 6567 696f 6e20  tances --region 
+0001a9c0: 7b72 6567 696f 6e7d 202d 2d69 6e73 7461  {region} --insta
+0001a9d0: 6e63 652d 6964 7320 2428 270a 2020 2020  nce-ids $('.    
+0001a9e0: 2020 2020 2020 2020 2020 2020 6627 6177              f'aw
+0001a9f0: 7320 6563 3220 6465 7363 7269 6265 2d69  s ec2 describe-i
+0001aa00: 6e73 7461 6e63 6573 202d 2d72 6567 696f  nstances --regio
+0001aa10: 6e20 7b72 6567 696f 6e7d 2027 0a20 2020  n {region} '.   
+0001aa20: 2020 2020 2020 2020 2020 2020 2023 2054               # T
+0001aa30: 4f44 4f28 7a68 7775 293a 2066 6978 2074  ODO(zhwu): fix t
+0001aa40: 6865 206e 616d 6520 666f 7220 7370 6f74  he name for spot
+0001aa50: 2063 6c75 7374 6572 2e0a 2020 2020 2020   cluster..      
+0001aa60: 2020 2020 2020 2020 2020 272d 2d66 696c            '--fil
+0001aa70: 7465 7273 204e 616d 653d 7461 673a 7261  ters Name=tag:ra
+0001aa80: 792d 636c 7573 7465 722d 6e61 6d65 2c56  y-cluster-name,V
+0001aa90: 616c 7565 733d 2a2d 247b 4d41 4e41 4745  alues=*-${MANAGE
+0001aaa0: 445f 4a4f 425f 4944 7d27 0a20 2020 2020  D_JOB_ID}'.     
+0001aab0: 2020 2020 2020 2020 2020 2066 272d 7b75             f'-{u
+0001aac0: 7365 725f 6861 7368 7d20 270a 2020 2020  ser_hash} '.    
+0001aad0: 2020 2020 2020 2020 2020 2020 6627 2d2d              f'--
+0001aae0: 7175 6572 7920 5265 7365 7276 6174 696f  query Reservatio
+0001aaf0: 6e73 5b5d 2e49 6e73 7461 6e63 6573 5b5d  ns[].Instances[]
+0001ab00: 2e49 6e73 7461 6e63 6549 6420 270a 2020  .InstanceId '.  
+0001ab10: 2020 2020 2020 2020 2020 2020 2020 272d                '-
+0001ab20: 2d6f 7574 7075 7420 7465 7874 2927 292c  -output text)'),
+0001ab30: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+0001ab40: 6565 7020 3130 3027 2c0a 2020 2020 2020  eep 100',.      
+0001ab50: 2020 2020 2020 6627 7b5f 4a4f 425f 5155        f'{_JOB_QU
+0001ab60: 4555 455f 5741 4954 7d7c 2067 7265 7020  EUE_WAIT}| grep 
+0001ab70: 7b6e 616d 657d 207c 2068 6561 6420 2d6e  {name} | head -n
+0001ab80: 3120 7c20 6772 6570 2022 5245 434f 5645  1 | grep "RECOVE
+0001ab90: 5249 4e47 2227 2c0a 2020 2020 2020 2020  RING"',.        
+0001aba0: 2020 2020 2773 6c65 6570 2032 3030 272c      'sleep 200',
+0001abb0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+0001abc0: 5f4a 4f42 5f51 5545 5545 5f57 4149 547d  _JOB_QUEUE_WAIT}
+0001abd0: 7c20 6772 6570 207b 6e61 6d65 7d20 7c20  | grep {name} | 
+0001abe0: 6865 6164 202d 6e31 207c 2067 7265 7020  head -n1 | grep 
+0001abf0: 2252 554e 4e49 4e47 2227 2c0a 2020 2020  "RUNNING"',.    
+0001ac00: 2020 2020 2020 2020 6627 5255 4e5f 4944          f'RUN_ID
+0001ac10: 3d24 2863 6174 202f 746d 702f 7b6e 616d  =$(cat /tmp/{nam
+0001ac20: 657d 2d72 756e 2d69 6429 3b20 6563 686f  e}-run-id); echo
+0001ac30: 2024 5255 4e5f 4944 3b20 736b 7920 6a6f   $RUN_ID; sky jo
+0001ac40: 6273 206c 6f67 7320 2d6e 207b 6e61 6d65  bs logs -n {name
+0001ac50: 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20  } --no-follow | 
+0001ac60: 6772 6570 2053 4b59 5049 4c4f 545f 5441  grep SKYPILOT_TA
+0001ac70: 534b 5f49 443a 207c 2067 7265 7020 2224  SK_ID: | grep "$
+0001ac80: 5255 4e5f 4944 2227 2c0a 2020 2020 2020  RUN_ID"',.      
+0001ac90: 2020 2020 2020 6627 5255 4e5f 4944 533d        f'RUN_IDS=
+0001aca0: 2428 736b 7920 6a6f 6273 206c 6f67 7320  $(sky jobs logs 
+0001acb0: 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f 2d66  -n {name} --no-f
+0001acc0: 6f6c 6c6f 7720 7c20 6772 6570 202d 4120  ollow | grep -A 
+0001acd0: 3420 534b 5950 494c 4f54 5f54 4153 4b5f  4 SKYPILOT_TASK_
+0001ace0: 4944 5320 7c20 6375 7420 2d64 2229 2220  IDS | cut -d")" 
+0001acf0: 2d66 3229 3b20 6563 686f 2022 2452 554e  -f2); echo "$RUN
+0001ad00: 5f49 4453 2220 7c20 7465 6520 2f74 6d70  _IDS" | tee /tmp
+0001ad10: 2f7b 6e61 6d65 7d2d 7275 6e2d 6964 732d  /{name}-run-ids-
+0001ad20: 6e65 7727 2c0a 2020 2020 2020 2020 2020  new',.          
+0001ad30: 2020 6627 6469 6666 202f 746d 702f 7b6e    f'diff /tmp/{n
+0001ad40: 616d 657d 2d72 756e 2d69 6473 202f 746d  ame}-run-ids /tm
+0001ad50: 702f 7b6e 616d 657d 2d72 756e 2d69 6473  p/{name}-run-ids
+0001ad60: 2d6e 6577 272c 0a20 2020 2020 2020 2020  -new',.         
+0001ad70: 2020 2066 2763 6174 202f 746d 702f 7b6e     f'cat /tmp/{n
+0001ad80: 616d 657d 2d72 756e 2d69 6473 207c 2073  ame}-run-ids | s
+0001ad90: 6564 202d 6e20 3270 207c 2067 7265 7020  ed -n 2p | grep 
+0001ada0: 6063 6174 202f 746d 702f 7b6e 616d 657d  `cat /tmp/{name}
+0001adb0: 2d72 756e 2d69 6460 272c 0a20 2020 2020  -run-id`',.     
+0001adc0: 2020 205d 2c0a 2020 2020 2020 2020 5f4a     ],.        _J
+0001add0: 4f42 5f43 414e 4345 4c5f 5741 4954 2e66  OB_CANCEL_WAIT.f
+0001ade0: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d6e  ormat(job_name=n
+0001adf0: 616d 6529 2c0a 2020 2020 2020 2020 7469  ame),.        ti
+0001ae00: 6d65 6f75 743d 3235 202a 2036 302c 0a20  meout=25 * 60,. 
+0001ae10: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+0001ae20: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
+0001ae30: 7974 6573 742e 6d61 726b 2e67 6370 0a40  ytest.mark.gcp.@
+0001ae40: 7079 7465 7374 2e6d 6172 6b2e 6d61 6e61  pytest.mark.mana
+0001ae50: 6765 645f 6a6f 6273 0a64 6566 2074 6573  ged_jobs.def tes
+0001ae60: 745f 6d61 6e61 6765 645f 6a6f 6273 5f70  t_managed_jobs_p
+0001ae70: 6970 656c 696e 655f 7265 636f 7665 7279  ipeline_recovery
+0001ae80: 5f67 6370 2829 3a0a 2020 2020 2222 2254  _gcp():.    """T
+0001ae90: 6573 7420 6d61 6e61 6765 6420 6a6f 6220  est managed job 
+0001aea0: 7265 636f 7665 7279 2066 6f72 2061 2070  recovery for a p
+0001aeb0: 6970 656c 696e 652e 2222 220a 2020 2020  ipeline.""".    
+0001aec0: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+0001aed0: 7465 725f 6e61 6d65 2829 0a20 2020 207a  ter_name().    z
+0001aee0: 6f6e 6520 3d20 2775 732d 6561 7374 342d  one = 'us-east4-
+0001aef0: 6227 0a20 2020 2075 7365 725f 6861 7368  b'.    user_hash
+0001af00: 203d 2063 6f6d 6d6f 6e5f 7574 696c 732e   = common_utils.
+0001af10: 6765 745f 7573 6572 5f68 6173 6828 290a  get_user_hash().
+0001af20: 2020 2020 7573 6572 5f68 6173 6820 3d20      user_hash = 
+0001af30: 7573 6572 5f68 6173 685b 3a63 6f6d 6d6f  user_hash[:commo
+0001af40: 6e5f 7574 696c 732e 5553 4552 5f48 4153  n_utils.USER_HAS
+0001af50: 485f 4c45 4e47 5448 5f49 4e5f 434c 5553  H_LENGTH_IN_CLUS
+0001af60: 5445 525f 4e41 4d45 5d0a 2020 2020 7175  TER_NAME].    qu
+0001af70: 6572 795f 636d 6420 3d20 280a 2020 2020  ery_cmd = (.    
+0001af80: 2020 2020 2767 636c 6f75 6420 636f 6d70      'gcloud comp
+0001af90: 7574 6520 696e 7374 616e 6365 7320 6c69  ute instances li
+0001afa0: 7374 202d 2d66 696c 7465 723d 270a 2020  st --filter='.  
+0001afb0: 2020 2020 2020 6627 2228 6c61 6265 6c73        f'"(labels
+0001afc0: 2e72 6179 2d63 6c75 7374 6572 2d6e 616d  .ray-cluster-nam
+0001afd0: 653a 2a2d 247b 7b4d 414e 4147 4544 5f4a  e:*-${{MANAGED_J
+0001afe0: 4f42 5f49 447d 7d2d 7b75 7365 725f 6861  OB_ID}}-{user_ha
+0001aff0: 7368 7d29 2220 270a 2020 2020 2020 2020  sh})" '.        
+0001b000: 6627 2d2d 7a6f 6e65 733d 7b7a 6f6e 657d  f'--zones={zone}
+0001b010: 202d 2d66 6f72 6d61 743d 2276 616c 7565   --format="value
+0001b020: 286e 616d 6529 2227 290a 2020 2020 7465  (name)"').    te
+0001b030: 726d 696e 6174 655f 636d 6420 3d20 2866  rminate_cmd = (f
+0001b040: 2767 636c 6f75 6420 636f 6d70 7574 6520  'gcloud compute 
+0001b050: 696e 7374 616e 6365 7320 6465 6c65 7465  instances delete
+0001b060: 202d 2d7a 6f6e 653d 7b7a 6f6e 657d 270a   --zone={zone}'.
+0001b070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b080: 2020 2020 2066 2720 2d2d 7175 6965 7420       f' --quiet 
+0001b090: 2428 7b71 7565 7279 5f63 6d64 7d29 2729  $({query_cmd})')
+0001b0a0: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+0001b0b0: 280a 2020 2020 2020 2020 276d 616e 6167  (.        'manag
+0001b0c0: 6564 5f6a 6f62 735f 7069 7065 6c69 6e65  ed_jobs_pipeline
+0001b0d0: 5f72 6563 6f76 6572 795f 6763 7027 2c0a  _recovery_gcp',.
+0001b0e0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+0001b0f0: 2020 2020 2020 6627 736b 7920 6a6f 6273        f'sky jobs
+0001b100: 206c 6175 6e63 6820 2d6e 207b 6e61 6d65   launch -n {name
+0001b110: 7d20 7465 7374 732f 7465 7374 5f79 616d  } tests/test_yam
+0001b120: 6c73 2f70 6970 656c 696e 655f 6763 702e  ls/pipeline_gcp.
+0001b130: 7961 6d6c 2020 2d79 202d 6427 2c0a 2020  yaml  -y -d',.  
+0001b140: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+0001b150: 2034 3030 272c 0a20 2020 2020 2020 2020   400',.         
+0001b160: 2020 2066 277b 5f4a 4f42 5f51 5545 5545     f'{_JOB_QUEUE
+0001b170: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+0001b180: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
+0001b190: 2067 7265 7020 2252 554e 4e49 4e47 2227   grep "RUNNING"'
+0001b1a0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0001b1b0: 5255 4e5f 4944 3d24 2873 6b79 206a 6f62  RUN_ID=$(sky job
+0001b1c0: 7320 6c6f 6773 202d 6e20 7b6e 616d 657d  s logs -n {name}
+0001b1d0: 202d 2d6e 6f2d 666f 6c6c 6f77 207c 2067   --no-follow | g
+0001b1e0: 7265 7020 534b 5950 494c 4f54 5f54 4153  rep SKYPILOT_TAS
+0001b1f0: 4b5f 4944 3a20 7c20 6375 7420 2d64 3a20  K_ID: | cut -d: 
+0001b200: 2d66 3229 3b20 6563 686f 2022 2452 554e  -f2); echo "$RUN
+0001b210: 5f49 4422 207c 2074 6565 202f 746d 702f  _ID" | tee /tmp/
+0001b220: 7b6e 616d 657d 2d72 756e 2d69 6427 2c0a  {name}-run-id',.
+0001b230: 2020 2020 2020 2020 2020 2020 6627 5255              f'RU
+0001b240: 4e5f 4944 533d 2428 736b 7920 6a6f 6273  N_IDS=$(sky jobs
+0001b250: 206c 6f67 7320 2d6e 207b 6e61 6d65 7d20   logs -n {name} 
+0001b260: 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20 6772  --no-follow | gr
+0001b270: 6570 202d 4120 3420 534b 5950 494c 4f54  ep -A 4 SKYPILOT
+0001b280: 5f54 4153 4b5f 4944 5320 7c20 6375 7420  _TASK_IDS | cut 
+0001b290: 2d64 2229 2220 2d66 3229 3b20 6563 686f  -d")" -f2); echo
+0001b2a0: 2022 2452 554e 5f49 4453 2220 7c20 7465   "$RUN_IDS" | te
+0001b2b0: 6520 2f74 6d70 2f7b 6e61 6d65 7d2d 7275  e /tmp/{name}-ru
+0001b2c0: 6e2d 6964 7327 2c0a 2020 2020 2020 2020  n-ids',.        
+0001b2d0: 2020 2020 2320 5465 726d 696e 6174 6520      # Terminate 
+0001b2e0: 7468 6520 636c 7573 7465 7220 6d61 6e75  the cluster manu
+0001b2f0: 616c 6c79 2e0a 2020 2020 2020 2020 2020  ally..          
+0001b300: 2020 2320 5468 6520 6063 6174 202e 2e2e    # The `cat ...
+0001b310: 7c20 7265 7660 2069 7320 746f 2072 6574  | rev` is to ret
+0001b320: 7269 6576 6520 7468 6520 6a6f 625f 6964  rieve the job_id
+0001b330: 2066 726f 6d20 7468 650a 2020 2020 2020   from the.      
+0001b340: 2020 2020 2020 2320 534b 5950 494c 4f54        # SKYPILOT
+0001b350: 5f54 4153 4b5f 4944 2c20 7768 6963 6820  _TASK_ID, which 
+0001b360: 6765 7473 2074 6865 2073 6563 6f6e 6420  gets the second 
+0001b370: 746f 206c 6173 7420 6669 656c 640a 2020  to last field.  
+0001b380: 2020 2020 2020 2020 2020 2320 7365 7061            # sepa
+0001b390: 7261 7465 6420 6279 2060 2d60 2e0a 2020  rated by `-`..  
+0001b3a0: 2020 2020 2020 2020 2020 2866 274d 414e            (f'MAN
+0001b3b0: 4147 4544 5f4a 4f42 5f49 443d 6063 6174  AGED_JOB_ID=`cat
+0001b3c0: 202f 746d 702f 7b6e 616d 657d 2d72 756e   /tmp/{name}-run
+0001b3d0: 2d69 6420 7c20 7265 7620 7c20 270a 2020  -id | rev | '.  
+0001b3e0: 2020 2020 2020 2020 2020 2066 2763 7574             f'cut
+0001b3f0: 202d 645c 275f 5c27 202d 6631 207c 2072   -d\'_\' -f1 | r
+0001b400: 6576 207c 2063 7574 202d 645c 272d 5c27  ev | cut -d\'-\'
+0001b410: 202d 6631 603b 207b 7465 726d 696e 6174   -f1`; {terminat
+0001b420: 655f 636d 647d 2729 2c0a 2020 2020 2020  e_cmd}'),.      
+0001b430: 2020 2020 2020 2773 6c65 6570 2036 3027        'sleep 60'
+0001b440: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0001b450: 7b5f 4a4f 425f 5155 4555 455f 5741 4954  {_JOB_QUEUE_WAIT
+0001b460: 7d7c 2067 7265 7020 7b6e 616d 657d 207c  }| grep {name} |
+0001b470: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+0001b480: 2022 5245 434f 5645 5249 4e47 2227 2c0a   "RECOVERING"',.
+0001b490: 2020 2020 2020 2020 2020 2020 2773 6c65              'sle
+0001b4a0: 6570 2032 3030 272c 0a20 2020 2020 2020  ep 200',.       
+0001b4b0: 2020 2020 2066 277b 5f4a 4f42 5f51 5545       f'{_JOB_QUE
+0001b4c0: 5545 5f57 4149 547d 7c20 6772 6570 207b  UE_WAIT}| grep {
+0001b4d0: 6e61 6d65 7d20 7c20 6865 6164 202d 6e31  name} | head -n1
+0001b4e0: 207c 2067 7265 7020 2252 554e 4e49 4e47   | grep "RUNNING
+0001b4f0: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+0001b500: 6627 5255 4e5f 4944 3d24 2863 6174 202f  f'RUN_ID=$(cat /
+0001b510: 746d 702f 7b6e 616d 657d 2d72 756e 2d69  tmp/{name}-run-i
+0001b520: 6429 3b20 6563 686f 2024 5255 4e5f 4944  d); echo $RUN_ID
+0001b530: 3b20 736b 7920 6a6f 6273 206c 6f67 7320  ; sky jobs logs 
+0001b540: 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f 2d66  -n {name} --no-f
+0001b550: 6f6c 6c6f 7720 7c20 6772 6570 2053 4b59  ollow | grep SKY
+0001b560: 5049 4c4f 545f 5441 534b 5f49 443a 207c  PILOT_TASK_ID: |
+0001b570: 2067 7265 7020 2224 5255 4e5f 4944 2227   grep "$RUN_ID"'
+0001b580: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0001b590: 5255 4e5f 4944 533d 2428 736b 7920 6a6f  RUN_IDS=$(sky jo
+0001b5a0: 6273 206c 6f67 7320 2d6e 207b 6e61 6d65  bs logs -n {name
+0001b5b0: 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20  } --no-follow | 
+0001b5c0: 6772 6570 202d 4120 3420 534b 5950 494c  grep -A 4 SKYPIL
+0001b5d0: 4f54 5f54 4153 4b5f 4944 5320 7c20 6375  OT_TASK_IDS | cu
+0001b5e0: 7420 2d64 2229 2220 2d66 3229 3b20 6563  t -d")" -f2); ec
+0001b5f0: 686f 2022 2452 554e 5f49 4453 2220 7c20  ho "$RUN_IDS" | 
+0001b600: 7465 6520 2f74 6d70 2f7b 6e61 6d65 7d2d  tee /tmp/{name}-
+0001b610: 7275 6e2d 6964 732d 6e65 7727 2c0a 2020  run-ids-new',.  
+0001b620: 2020 2020 2020 2020 2020 6627 6469 6666            f'diff
+0001b630: 202f 746d 702f 7b6e 616d 657d 2d72 756e   /tmp/{name}-run
+0001b640: 2d69 6473 202f 746d 702f 7b6e 616d 657d  -ids /tmp/{name}
+0001b650: 2d72 756e 2d69 6473 2d6e 6577 272c 0a20  -run-ids-new',. 
+0001b660: 2020 2020 2020 2020 2020 2066 2763 6174             f'cat
+0001b670: 202f 746d 702f 7b6e 616d 657d 2d72 756e   /tmp/{name}-run
+0001b680: 2d69 6473 207c 2073 6564 202d 6e20 3270  -ids | sed -n 2p
+0001b690: 207c 2067 7265 7020 6063 6174 202f 746d   | grep `cat /tm
+0001b6a0: 702f 7b6e 616d 657d 2d72 756e 2d69 6460  p/{name}-run-id`
+0001b6b0: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+0001b6c0: 2020 2020 2020 5f4a 4f42 5f43 414e 4345        _JOB_CANCE
+0001b6d0: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
+0001b6e0: 625f 6e61 6d65 3d6e 616d 6529 2c0a 2020  b_name=name),.  
+0001b6f0: 2020 2020 2020 7469 6d65 6f75 743d 3235        timeout=25
+0001b700: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
+0001b710: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+0001b720: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+0001b730: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
+0001b740: 2020 2320 466c 7569 6473 7461 636b 2064    # Fluidstack d
+0001b750: 6f65 7320 6e6f 7420 7375 7070 6f72 7420  oes not support 
+0001b760: 7370 6f74 2069 6e73 7461 6e63 6573 0a40  spot instances.@
+0001b770: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f61  pytest.mark.no_a
+0001b780: 7a75 7265 2020 2320 417a 7572 6520 646f  zure  # Azure do
+0001b790: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
+0001b7a0: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
+0001b7b0: 7974 6573 742e 6d61 726b 2e6e 6f5f 6c61  ytest.mark.no_la
+0001b7c0: 6d62 6461 5f63 6c6f 7564 2020 2320 4c61  mbda_cloud  # La
+0001b7d0: 6d62 6461 2043 6c6f 7564 2064 6f65 7320  mbda Cloud does 
+0001b7e0: 6e6f 7420 7375 7070 6f72 7420 7370 6f74  not support spot
+0001b7f0: 2069 6e73 7461 6e63 6573 0a40 7079 7465   instances.@pyte
+0001b800: 7374 2e6d 6172 6b2e 6e6f 5f69 626d 2020  st.mark.no_ibm  
+0001b810: 2320 4942 4d20 436c 6f75 6420 646f 6573  # IBM Cloud does
+0001b820: 206e 6f74 2073 7570 706f 7274 2073 706f   not support spo
+0001b830: 7420 696e 7374 616e 6365 730a 4070 7974  t instances.@pyt
+0001b840: 6573 742e 6d61 726b 2e6e 6f5f 7363 7020  est.mark.no_scp 
+0001b850: 2023 2053 4350 2064 6f65 7320 6e6f 7420   # SCP does not 
+0001b860: 7375 7070 6f72 7420 7370 6f74 2069 6e73  support spot ins
+0001b870: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
+0001b880: 6172 6b2e 6e6f 5f70 6170 6572 7370 6163  ark.no_paperspac
+0001b890: 6520 2023 2050 6170 6572 7370 6163 6520  e  # Paperspace 
+0001b8a0: 646f 6573 206e 6f74 2073 7570 706f 7274  does not support
+0001b8b0: 2073 706f 7420 696e 7374 616e 6365 730a   spot instances.
+0001b8c0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+0001b8d0: 6b75 6265 726e 6574 6573 2020 2320 4b75  kubernetes  # Ku
+0001b8e0: 6265 726e 6574 6573 2064 6f65 7320 6e6f  bernetes does no
+0001b8f0: 7420 6861 7665 2061 206e 6f74 696f 6e20  t have a notion 
+0001b900: 6f66 2073 706f 7420 696e 7374 616e 6365  of spot instance
+0001b910: 730a 4070 7974 6573 742e 6d61 726b 2e6d  s.@pytest.mark.m
+0001b920: 616e 6167 6564 5f6a 6f62 730a 6465 6620  anaged_jobs.def 
+0001b930: 7465 7374 5f6d 616e 6167 6564 5f6a 6f62  test_managed_job
+0001b940: 735f 7265 636f 7665 7279 5f64 6566 6175  s_recovery_defau
+0001b950: 6c74 5f72 6573 6f75 7263 6573 2867 656e  lt_resources(gen
+0001b960: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
+0001b970: 3a0a 2020 2020 2222 2254 6573 7420 6d61  :.    """Test ma
+0001b980: 6e61 6765 6420 6a6f 6220 7265 636f 7665  naged job recove
+0001b990: 7279 2066 6f72 2064 6566 6175 6c74 2072  ry for default r
+0001b9a0: 6573 6f75 7263 6573 2e22 2222 0a20 2020  esources.""".   
+0001b9b0: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+0001b9c0: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+0001b9d0: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+0001b9e0: 2020 2020 2027 6d61 6e61 6765 642d 7370       'managed-sp
+0001b9f0: 6f74 2d72 6563 6f76 6572 792d 6465 6661  ot-recovery-defa
+0001ba00: 756c 742d 7265 736f 7572 6365 7327 2c0a  ult-resources',.
+0001ba10: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+0001ba20: 2020 2020 2020 6627 736b 7920 6a6f 6273        f'sky jobs
+0001ba30: 206c 6175 6e63 6820 2d6e 207b 6e61 6d65   launch -n {name
+0001ba40: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
+0001ba50: 6963 5f63 6c6f 7564 7d20 2d2d 7573 652d  ic_cloud} --use-
+0001ba60: 7370 6f74 2022 736c 6565 7020 3330 2026  spot "sleep 30 &
+0001ba70: 2620 7375 646f 2073 6875 7464 6f77 6e20  & sudo shutdown 
+0001ba80: 6e6f 7720 2626 2073 6c65 6570 2031 3030  now && sleep 100
+0001ba90: 3022 202d 7920 2d64 272c 0a20 2020 2020  0" -y -d',.     
+0001baa0: 2020 2020 2020 2027 736c 6565 7020 3336         'sleep 36
+0001bab0: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+0001bac0: 6627 7b5f 4a4f 425f 5155 4555 455f 5741  f'{_JOB_QUEUE_WA
+0001bad0: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
+0001bae0: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
+0001baf0: 6570 2022 5255 4e4e 494e 475c 7c52 4543  ep "RUNNING\|REC
+0001bb00: 4f56 4552 494e 4722 272c 0a20 2020 2020  OVERING"',.     
+0001bb10: 2020 205d 2c0a 2020 2020 2020 2020 5f4a     ],.        _J
+0001bb20: 4f42 5f43 414e 4345 4c5f 5741 4954 2e66  OB_CANCEL_WAIT.f
+0001bb30: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d6e  ormat(job_name=n
+0001bb40: 616d 6529 2c0a 2020 2020 2020 2020 7469  ame),.        ti
+0001bb50: 6d65 6f75 743d 3235 202a 2036 302c 0a20  meout=25 * 60,. 
+0001bb60: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+0001bb70: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
+0001bb80: 7974 6573 742e 6d61 726b 2e61 7773 0a40  ytest.mark.aws.@
+0001bb90: 7079 7465 7374 2e6d 6172 6b2e 6d61 6e61  pytest.mark.mana
+0001bba0: 6765 645f 6a6f 6273 0a64 6566 2074 6573  ged_jobs.def tes
+0001bbb0: 745f 6d61 6e61 6765 645f 6a6f 6273 5f72  t_managed_jobs_r
+0001bbc0: 6563 6f76 6572 795f 6d75 6c74 695f 6e6f  ecovery_multi_no
+0001bbd0: 6465 5f61 7773 2861 7773 5f63 6f6e 6669  de_aws(aws_confi
+0001bbe0: 675f 7265 6769 6f6e 293a 0a20 2020 2022  g_region):.    "
+0001bbf0: 2222 5465 7374 206d 616e 6167 6564 206a  ""Test managed j
+0001bc00: 6f62 2072 6563 6f76 6572 792e 2222 220a  ob recovery.""".
+0001bc10: 2020 2020 6e61 6d65 203d 205f 6765 745f      name = _get_
+0001bc20: 636c 7573 7465 725f 6e61 6d65 2829 0a20  cluster_name(). 
+0001bc30: 2020 206e 616d 655f 6f6e 5f63 6c6f 7564     name_on_cloud
+0001bc40: 203d 2063 6f6d 6d6f 6e5f 7574 696c 732e   = common_utils.
+0001bc50: 6d61 6b65 5f63 6c75 7374 6572 5f6e 616d  make_cluster_nam
+0001bc60: 655f 6f6e 5f63 6c6f 7564 280a 2020 2020  e_on_cloud(.    
+0001bc70: 2020 2020 6e61 6d65 2c20 6a6f 6273 2e4a      name, jobs.J
+0001bc80: 4f42 535f 434c 5553 5445 525f 4e41 4d45  OBS_CLUSTER_NAME
+0001bc90: 5f50 5245 4649 585f 4c45 4e47 5448 2c20  _PREFIX_LENGTH, 
+0001bca0: 6164 645f 7573 6572 5f68 6173 683d 4661  add_user_hash=Fa
+0001bcb0: 6c73 6529 0a20 2020 2072 6567 696f 6e20  lse).    region 
+0001bcc0: 3d20 6177 735f 636f 6e66 6967 5f72 6567  = aws_config_reg
+0001bcd0: 696f 6e0a 2020 2020 7465 7374 203d 2054  ion.    test = T
+0001bce0: 6573 7428 0a20 2020 2020 2020 2027 6d61  est(.        'ma
+0001bcf0: 6e61 6765 645f 6a6f 6273 5f72 6563 6f76  naged_jobs_recov
+0001bd00: 6572 795f 6d75 6c74 695f 6e6f 6465 5f61  ery_multi_node_a
+0001bd10: 7773 272c 0a20 2020 2020 2020 205b 0a20  ws',.        [. 
+0001bd20: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0001bd30: 206a 6f62 7320 6c61 756e 6368 202d 2d63   jobs launch --c
+0001bd40: 6c6f 7564 2061 7773 202d 2d72 6567 696f  loud aws --regio
+0001bd50: 6e20 7b72 6567 696f 6e7d 202d 6e20 7b6e  n {region} -n {n
+0001bd60: 616d 657d 202d 2d75 7365 2d73 706f 7420  ame} --use-spot 
+0001bd70: 2d2d 6e75 6d2d 6e6f 6465 7320 3220 2265  --num-nodes 2 "e
+0001bd80: 6368 6f20 534b 5950 494c 4f54 5f54 4153  cho SKYPILOT_TAS
+0001bd90: 4b5f 4944 3a20 5c24 534b 5950 494c 4f54  K_ID: \$SKYPILOT
+0001bda0: 5f54 4153 4b5f 4944 3b20 736c 6565 7020  _TASK_ID; sleep 
+0001bdb0: 3138 3030 2220 202d 7920 2d64 272c 0a20  1800"  -y -d',. 
+0001bdc0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+0001bdd0: 7020 3435 3027 2c0a 2020 2020 2020 2020  p 450',.        
+0001bde0: 2020 2020 6627 7b5f 4a4f 425f 5155 4555      f'{_JOB_QUEU
+0001bdf0: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
+0001be00: 616d 657d 207c 2068 6561 6420 2d6e 3120  ame} | head -n1 
+0001be10: 7c20 6772 6570 2022 5255 4e4e 494e 4722  | grep "RUNNING"
+0001be20: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0001be30: 2752 554e 5f49 443d 2428 736b 7920 6a6f  'RUN_ID=$(sky jo
+0001be40: 6273 206c 6f67 7320 2d6e 207b 6e61 6d65  bs logs -n {name
+0001be50: 7d20 2d2d 6e6f 2d66 6f6c 6c6f 7720 7c20  } --no-follow | 
+0001be60: 6772 6570 2053 4b59 5049 4c4f 545f 5441  grep SKYPILOT_TA
+0001be70: 534b 5f49 4420 7c20 6375 7420 2d64 3a20  SK_ID | cut -d: 
+0001be80: 2d66 3229 3b20 6563 686f 2022 2452 554e  -f2); echo "$RUN
+0001be90: 5f49 4422 207c 2074 6565 202f 746d 702f  _ID" | tee /tmp/
+0001bea0: 7b6e 616d 657d 2d72 756e 2d69 6427 2c0a  {name}-run-id',.
+0001beb0: 2020 2020 2020 2020 2020 2020 2320 5465              # Te
+0001bec0: 726d 696e 6174 6520 7468 6520 776f 726b  rminate the work
+0001bed0: 6572 206d 616e 7561 6c6c 792e 0a20 2020  er manually..   
+0001bee0: 2020 2020 2020 2020 2028 6627 6177 7320           (f'aws 
+0001bef0: 6563 3220 7465 726d 696e 6174 652d 696e  ec2 terminate-in
+0001bf00: 7374 616e 6365 7320 2d2d 7265 6769 6f6e  stances --region
+0001bf10: 207b 7265 6769 6f6e 7d20 2d2d 696e 7374   {region} --inst
+0001bf20: 616e 6365 2d69 6473 2024 2827 0a20 2020  ance-ids $('.   
+0001bf30: 2020 2020 2020 2020 2020 6627 6177 7320            f'aws 
+0001bf40: 6563 3220 6465 7363 7269 6265 2d69 6e73  ec2 describe-ins
+0001bf50: 7461 6e63 6573 202d 2d72 6567 696f 6e20  tances --region 
+0001bf60: 7b72 6567 696f 6e7d 2027 0a20 2020 2020  {region} '.     
+0001bf70: 2020 2020 2020 2020 6627 2d2d 6669 6c74          f'--filt
+0001bf80: 6572 7320 4e61 6d65 3d74 6167 3a72 6179  ers Name=tag:ray
+0001bf90: 2d63 6c75 7374 6572 2d6e 616d 652c 5661  -cluster-name,Va
+0001bfa0: 6c75 6573 3d7b 6e61 6d65 5f6f 6e5f 636c  lues={name_on_cl
+0001bfb0: 6f75 647d 2a20 270a 2020 2020 2020 2020  oud}* '.        
+0001bfc0: 2020 2020 2027 4e61 6d65 3d74 6167 3a72       'Name=tag:r
+0001bfd0: 6179 2d6e 6f64 652d 7479 7065 2c56 616c  ay-node-type,Val
+0001bfe0: 7565 733d 776f 726b 6572 2027 0a20 2020  ues=worker '.   
+0001bff0: 2020 2020 2020 2020 2020 6627 2d2d 7175            f'--qu
+0001c000: 6572 7920 5265 7365 7276 6174 696f 6e73  ery Reservations
+0001c010: 5b5d 2e49 6e73 7461 6e63 6573 5b5d 2e49  [].Instances[].I
+0001c020: 6e73 7461 6e63 6549 6420 270a 2020 2020  nstanceId '.    
+0001c030: 2020 2020 2020 2020 2027 2d2d 6f75 7470           '--outp
+0001c040: 7574 2074 6578 7429 2729 2c0a 2020 2020  ut text)'),.    
+0001c050: 2020 2020 2020 2020 2773 6c65 6570 2035          'sleep 5
+0001c060: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+0001c070: 6627 7b5f 4a4f 425f 5155 4555 455f 5741  f'{_JOB_QUEUE_WA
+0001c080: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
+0001c090: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
+0001c0a0: 6570 2022 5245 434f 5645 5249 4e47 2227  ep "RECOVERING"'
+0001c0b0: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+0001c0c0: 6c65 6570 2035 3630 272c 0a20 2020 2020  leep 560',.     
+0001c0d0: 2020 2020 2020 2066 277b 5f4a 4f42 5f51         f'{_JOB_Q
+0001c0e0: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+0001c0f0: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
+0001c100: 6e31 207c 2067 7265 7020 2252 554e 4e49  n1 | grep "RUNNI
+0001c110: 4e47 2227 2c0a 2020 2020 2020 2020 2020  NG"',.          
+0001c120: 2020 6627 5255 4e5f 4944 3d24 2863 6174    f'RUN_ID=$(cat
+0001c130: 202f 746d 702f 7b6e 616d 657d 2d72 756e   /tmp/{name}-run
+0001c140: 2d69 6429 3b20 6563 686f 2024 5255 4e5f  -id); echo $RUN_
+0001c150: 4944 3b20 736b 7920 6a6f 6273 206c 6f67  ID; sky jobs log
+0001c160: 7320 2d6e 207b 6e61 6d65 7d20 2d2d 6e6f  s -n {name} --no
+0001c170: 2d66 6f6c 6c6f 7720 7c20 6772 6570 2053  -follow | grep S
+0001c180: 4b59 5049 4c4f 545f 5441 534b 5f49 4420  KYPILOT_TASK_ID 
+0001c190: 7c20 6375 7420 2d64 3a20 2d66 3220 7c20  | cut -d: -f2 | 
+0001c1a0: 6772 6570 2022 2452 554e 5f49 4422 272c  grep "$RUN_ID"',
+0001c1b0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+0001c1c0: 2020 2020 5f4a 4f42 5f43 414e 4345 4c5f      _JOB_CANCEL_
+0001c1d0: 5741 4954 2e66 6f72 6d61 7428 6a6f 625f  WAIT.format(job_
+0001c1e0: 6e61 6d65 3d6e 616d 6529 2c0a 2020 2020  name=name),.    
+0001c1f0: 2020 2020 7469 6d65 6f75 743d 3330 202a      timeout=30 *
+0001c200: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
+0001c210: 756e 5f6f 6e65 5f74 6573 7428 7465 7374  un_one_test(test
+0001c220: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
+0001c230: 2e67 6370 0a40 7079 7465 7374 2e6d 6172  .gcp.@pytest.mar
+0001c240: 6b2e 6d61 6e61 6765 645f 6a6f 6273 0a64  k.managed_jobs.d
+0001c250: 6566 2074 6573 745f 6d61 6e61 6765 645f  ef test_managed_
+0001c260: 6a6f 6273 5f72 6563 6f76 6572 795f 6d75  jobs_recovery_mu
+0001c270: 6c74 695f 6e6f 6465 5f67 6370 2829 3a0a  lti_node_gcp():.
+0001c280: 2020 2020 2222 2254 6573 7420 6d61 6e61      """Test mana
+0001c290: 6765 6420 6a6f 6220 7265 636f 7665 7279  ged job recovery
+0001c2a0: 2e22 2222 0a20 2020 206e 616d 6520 3d20  .""".    name = 
+0001c2b0: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+0001c2c0: 6528 290a 2020 2020 6e61 6d65 5f6f 6e5f  e().    name_on_
+0001c2d0: 636c 6f75 6420 3d20 636f 6d6d 6f6e 5f75  cloud = common_u
+0001c2e0: 7469 6c73 2e6d 616b 655f 636c 7573 7465  tils.make_cluste
+0001c2f0: 725f 6e61 6d65 5f6f 6e5f 636c 6f75 6428  r_name_on_cloud(
+0001c300: 0a20 2020 2020 2020 206e 616d 652c 206a  .        name, j
+0001c310: 6f62 732e 4a4f 4253 5f43 4c55 5354 4552  obs.JOBS_CLUSTER
+0001c320: 5f4e 414d 455f 5052 4546 4958 5f4c 454e  _NAME_PREFIX_LEN
+0001c330: 4754 482c 2061 6464 5f75 7365 725f 6861  GTH, add_user_ha
+0001c340: 7368 3d46 616c 7365 290a 2020 2020 7a6f  sh=False).    zo
+0001c350: 6e65 203d 2027 7573 2d77 6573 7432 2d61  ne = 'us-west2-a
+0001c360: 270a 2020 2020 2320 5573 6520 273a 2720  '.    # Use ':' 
+0001c370: 746f 206d 6174 6368 2061 7320 7468 6520  to match as the 
+0001c380: 636c 7573 7465 7220 6e61 6d65 2077 696c  cluster name wil
+0001c390: 6c20 636f 6e74 6169 6e20 7468 6520 7375  l contain the su
+0001c3a0: 6666 6978 2077 6974 6820 6a6f 6220 6964  ffix with job id
+0001c3b0: 0a20 2020 2071 7565 7279 5f63 6d64 203d  .    query_cmd =
+0001c3c0: 2028 0a20 2020 2020 2020 2066 2767 636c   (.        f'gcl
+0001c3d0: 6f75 6420 636f 6d70 7574 6520 696e 7374  oud compute inst
+0001c3e0: 616e 6365 7320 6c69 7374 202d 2d66 696c  ances list --fil
+0001c3f0: 7465 723d 270a 2020 2020 2020 2020 6627  ter='.        f'
+0001c400: 2228 6c61 6265 6c73 2e72 6179 2d63 6c75  "(labels.ray-clu
+0001c410: 7374 6572 2d6e 616d 653a 7b6e 616d 655f  ster-name:{name_
+0001c420: 6f6e 5f63 6c6f 7564 7d20 414e 4420 270a  on_cloud} AND '.
+0001c430: 2020 2020 2020 2020 6627 6c61 6265 6c73          f'labels
+0001c440: 2e72 6179 2d6e 6f64 652d 7479 7065 3d77  .ray-node-type=w
+0001c450: 6f72 6b65 7229 2220 2d2d 7a6f 6e65 733d  orker)" --zones=
+0001c460: 7b7a 6f6e 657d 202d 2d66 6f72 6d61 743d  {zone} --format=
+0001c470: 2276 616c 7565 286e 616d 6529 2227 290a  "value(name)"').
+0001c480: 2020 2020 7465 726d 696e 6174 655f 636d      terminate_cm
+0001c490: 6420 3d20 2866 2767 636c 6f75 6420 636f  d = (f'gcloud co
+0001c4a0: 6d70 7574 6520 696e 7374 616e 6365 7320  mpute instances 
+0001c4b0: 6465 6c65 7465 202d 2d7a 6f6e 653d 7b7a  delete --zone={z
+0001c4c0: 6f6e 657d 270a 2020 2020 2020 2020 2020  one}'.          
+0001c4d0: 2020 2020 2020 2020 2020 2066 2720 2d2d             f' --
+0001c4e0: 7175 6965 7420 2428 7b71 7565 7279 5f63  quiet $({query_c
+0001c4f0: 6d64 7d29 2729 0a20 2020 2074 6573 7420  md})').    test 
+0001c500: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+0001c510: 276d 616e 6167 6564 5f6a 6f62 735f 7265  'managed_jobs_re
+0001c520: 636f 7665 7279 5f6d 756c 7469 5f6e 6f64  covery_multi_nod
+0001c530: 655f 6763 7027 2c0a 2020 2020 2020 2020  e_gcp',.        
+0001c540: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+0001c550: 736b 7920 6a6f 6273 206c 6175 6e63 6820  sky jobs launch 
+0001c560: 2d2d 636c 6f75 6420 6763 7020 2d2d 7a6f  --cloud gcp --zo
+0001c570: 6e65 207b 7a6f 6e65 7d20 2d6e 207b 6e61  ne {zone} -n {na
+0001c580: 6d65 7d20 2d2d 7573 652d 7370 6f74 202d  me} --use-spot -
+0001c590: 2d6e 756d 2d6e 6f64 6573 2032 2022 6563  -num-nodes 2 "ec
+0001c5a0: 686f 2053 4b59 5049 4c4f 545f 5441 534b  ho SKYPILOT_TASK
+0001c5b0: 5f49 443a 205c 2453 4b59 5049 4c4f 545f  _ID: \$SKYPILOT_
+0001c5c0: 5441 534b 5f49 443b 2073 6c65 6570 2031  TASK_ID; sleep 1
+0001c5d0: 3830 3022 2020 2d79 202d 6427 2c0a 2020  800"  -y -d',.  
+0001c5e0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+0001c5f0: 2034 3030 272c 0a20 2020 2020 2020 2020   400',.         
+0001c600: 2020 2066 277b 5f4a 4f42 5f51 5545 5545     f'{_JOB_QUEUE
+0001c610: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+0001c620: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
+0001c630: 2067 7265 7020 2252 554e 4e49 4e47 2227   grep "RUNNING"'
+0001c640: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0001c650: 5255 4e5f 4944 3d24 2873 6b79 206a 6f62  RUN_ID=$(sky job
+0001c660: 7320 6c6f 6773 202d 6e20 7b6e 616d 657d  s logs -n {name}
+0001c670: 202d 2d6e 6f2d 666f 6c6c 6f77 207c 2067   --no-follow | g
+0001c680: 7265 7020 534b 5950 494c 4f54 5f54 4153  rep SKYPILOT_TAS
+0001c690: 4b5f 4944 207c 2063 7574 202d 643a 202d  K_ID | cut -d: -
+0001c6a0: 6632 293b 2065 6368 6f20 2224 5255 4e5f  f2); echo "$RUN_
+0001c6b0: 4944 2220 7c20 7465 6520 2f74 6d70 2f7b  ID" | tee /tmp/{
+0001c6c0: 6e61 6d65 7d2d 7275 6e2d 6964 272c 0a20  name}-run-id',. 
+0001c6d0: 2020 2020 2020 2020 2020 2023 2054 6572             # Ter
+0001c6e0: 6d69 6e61 7465 2074 6865 2077 6f72 6b65  minate the worke
+0001c6f0: 7220 6d61 6e75 616c 6c79 2e0a 2020 2020  r manually..    
+0001c700: 2020 2020 2020 2020 7465 726d 696e 6174          terminat
+0001c710: 655f 636d 642c 0a20 2020 2020 2020 2020  e_cmd,.         
+0001c720: 2020 2027 736c 6565 7020 3530 272c 0a20     'sleep 50',. 
+0001c730: 2020 2020 2020 2020 2020 2066 277b 5f4a             f'{_J
+0001c740: 4f42 5f51 5545 5545 5f57 4149 547d 7c20  OB_QUEUE_WAIT}| 
+0001c750: 6772 6570 207b 6e61 6d65 7d20 7c20 6865  grep {name} | he
+0001c760: 6164 202d 6e31 207c 2067 7265 7020 2252  ad -n1 | grep "R
+0001c770: 4543 4f56 4552 494e 4722 272c 0a20 2020  ECOVERING"',.   
+0001c780: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+0001c790: 3432 3027 2c0a 2020 2020 2020 2020 2020  420',.          
+0001c7a0: 2020 6627 7b5f 4a4f 425f 5155 4555 455f    f'{_JOB_QUEUE_
+0001c7b0: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
+0001c7c0: 657d 207c 2068 6561 6420 2d6e 3120 7c20  e} | head -n1 | 
+0001c7d0: 6772 6570 2022 5255 4e4e 494e 4722 272c  grep "RUNNING"',
+0001c7e0: 0a20 2020 2020 2020 2020 2020 2066 2752  .            f'R
+0001c7f0: 554e 5f49 443d 2428 6361 7420 2f74 6d70  UN_ID=$(cat /tmp
+0001c800: 2f7b 6e61 6d65 7d2d 7275 6e2d 6964 293b  /{name}-run-id);
+0001c810: 2065 6368 6f20 2452 554e 5f49 443b 2073   echo $RUN_ID; s
+0001c820: 6b79 206a 6f62 7320 6c6f 6773 202d 6e20  ky jobs logs -n 
+0001c830: 7b6e 616d 657d 202d 2d6e 6f2d 666f 6c6c  {name} --no-foll
+0001c840: 6f77 207c 2067 7265 7020 534b 5950 494c  ow | grep SKYPIL
+0001c850: 4f54 5f54 4153 4b5f 4944 207c 2063 7574  OT_TASK_ID | cut
+0001c860: 202d 643a 202d 6632 207c 2067 7265 7020   -d: -f2 | grep 
+0001c870: 2224 5255 4e5f 4944 2227 2c0a 2020 2020  "$RUN_ID"',.    
+0001c880: 2020 2020 5d2c 0a20 2020 2020 2020 205f      ],.        _
+0001c890: 4a4f 425f 4341 4e43 454c 5f57 4149 542e  JOB_CANCEL_WAIT.
+0001c8a0: 666f 726d 6174 286a 6f62 5f6e 616d 653d  format(job_name=
+0001c8b0: 6e61 6d65 292c 0a20 2020 2020 2020 2074  name),.        t
+0001c8c0: 696d 656f 7574 3d32 3520 2a20 3630 2c0a  imeout=25 * 60,.
+0001c8d0: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+0001c8e0: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
+0001c8f0: 7079 7465 7374 2e6d 6172 6b2e 6177 730a  pytest.mark.aws.
+0001c900: 4070 7974 6573 742e 6d61 726b 2e6d 616e  @pytest.mark.man
+0001c910: 6167 6564 5f6a 6f62 730a 6465 6620 7465  aged_jobs.def te
+0001c920: 7374 5f6d 616e 6167 6564 5f6a 6f62 735f  st_managed_jobs_
+0001c930: 6361 6e63 656c 6c61 7469 6f6e 5f61 7773  cancellation_aws
+0001c940: 2861 7773 5f63 6f6e 6669 675f 7265 6769  (aws_config_regi
+0001c950: 6f6e 293a 0a20 2020 206e 616d 6520 3d20  on):.    name = 
+0001c960: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+0001c970: 6528 290a 2020 2020 6e61 6d65 5f6f 6e5f  e().    name_on_
+0001c980: 636c 6f75 6420 3d20 636f 6d6d 6f6e 5f75  cloud = common_u
+0001c990: 7469 6c73 2e6d 616b 655f 636c 7573 7465  tils.make_cluste
+0001c9a0: 725f 6e61 6d65 5f6f 6e5f 636c 6f75 6428  r_name_on_cloud(
+0001c9b0: 0a20 2020 2020 2020 206e 616d 652c 206a  .        name, j
+0001c9c0: 6f62 732e 4a4f 4253 5f43 4c55 5354 4552  obs.JOBS_CLUSTER
+0001c9d0: 5f4e 414d 455f 5052 4546 4958 5f4c 454e  _NAME_PREFIX_LEN
+0001c9e0: 4754 482c 2061 6464 5f75 7365 725f 6861  GTH, add_user_ha
+0001c9f0: 7368 3d46 616c 7365 290a 2020 2020 6e61  sh=False).    na
+0001ca00: 6d65 5f32 5f6f 6e5f 636c 6f75 6420 3d20  me_2_on_cloud = 
+0001ca10: 636f 6d6d 6f6e 5f75 7469 6c73 2e6d 616b  common_utils.mak
+0001ca20: 655f 636c 7573 7465 725f 6e61 6d65 5f6f  e_cluster_name_o
+0001ca30: 6e5f 636c 6f75 6428 0a20 2020 2020 2020  n_cloud(.       
+0001ca40: 2066 277b 6e61 6d65 7d2d 3227 2c20 6a6f   f'{name}-2', jo
+0001ca50: 6273 2e4a 4f42 535f 434c 5553 5445 525f  bs.JOBS_CLUSTER_
+0001ca60: 4e41 4d45 5f50 5245 4649 585f 4c45 4e47  NAME_PREFIX_LENG
+0001ca70: 5448 2c20 6164 645f 7573 6572 5f68 6173  TH, add_user_has
+0001ca80: 683d 4661 6c73 6529 0a20 2020 206e 616d  h=False).    nam
+0001ca90: 655f 335f 6f6e 5f63 6c6f 7564 203d 2063  e_3_on_cloud = c
+0001caa0: 6f6d 6d6f 6e5f 7574 696c 732e 6d61 6b65  ommon_utils.make
+0001cab0: 5f63 6c75 7374 6572 5f6e 616d 655f 6f6e  _cluster_name_on
+0001cac0: 5f63 6c6f 7564 280a 2020 2020 2020 2020  _cloud(.        
+0001cad0: 6627 7b6e 616d 657d 2d33 272c 206a 6f62  f'{name}-3', job
+0001cae0: 732e 4a4f 4253 5f43 4c55 5354 4552 5f4e  s.JOBS_CLUSTER_N
+0001caf0: 414d 455f 5052 4546 4958 5f4c 454e 4754  AME_PREFIX_LENGT
+0001cb00: 482c 2061 6464 5f75 7365 725f 6861 7368  H, add_user_hash
+0001cb10: 3d46 616c 7365 290a 2020 2020 7265 6769  =False).    regi
+0001cb20: 6f6e 203d 2061 7773 5f63 6f6e 6669 675f  on = aws_config_
+0001cb30: 7265 6769 6f6e 0a20 2020 2074 6573 7420  region.    test 
+0001cb40: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+0001cb50: 276d 616e 6167 6564 5f6a 6f62 735f 6361  'managed_jobs_ca
+0001cb60: 6e63 656c 6c61 7469 6f6e 5f61 7773 272c  ncellation_aws',
+0001cb70: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+0001cb80: 2020 2020 2020 2023 2054 6573 7420 6361         # Test ca
+0001cb90: 6e63 656c 6c61 7469 6f6e 2064 7572 696e  ncellation durin
+0001cba0: 6720 7370 6f74 2063 6c75 7374 6572 2062  g spot cluster b
+0001cbb0: 6569 6e67 206c 6175 6e63 6865 642e 0a20  eing launched.. 
+0001cbc0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0001cbd0: 206a 6f62 7320 6c61 756e 6368 202d 2d63   jobs launch --c
+0001cbe0: 6c6f 7564 2061 7773 202d 2d72 6567 696f  loud aws --regio
+0001cbf0: 6e20 7b72 6567 696f 6e7d 202d 6e20 7b6e  n {region} -n {n
+0001cc00: 616d 657d 202d 2d75 7365 2d73 706f 7420  ame} --use-spot 
+0001cc10: 2273 6c65 6570 2031 3030 3022 2020 2d79  "sleep 1000"  -y
+0001cc20: 202d 6427 2c0a 2020 2020 2020 2020 2020   -d',.          
+0001cc30: 2020 2773 6c65 6570 2036 3027 2c0a 2020    'sleep 60',.  
+0001cc40: 2020 2020 2020 2020 2020 6627 7b5f 4a4f            f'{_JO
+0001cc50: 425f 5155 4555 455f 5741 4954 7d7c 2067  B_QUEUE_WAIT}| g
+0001cc60: 7265 7020 7b6e 616d 657d 207c 2068 6561  rep {name} | hea
+0001cc70: 6420 2d6e 3120 7c20 6772 6570 2022 5354  d -n1 | grep "ST
+0001cc80: 4152 5449 4e47 2227 2c0a 2020 2020 2020  ARTING"',.      
+0001cc90: 2020 2020 2020 5f4a 4f42 5f43 414e 4345        _JOB_CANCE
+0001cca0: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
+0001ccb0: 625f 6e61 6d65 3d6e 616d 6529 2c0a 2020  b_name=name),.  
+0001ccc0: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+0001ccd0: 2035 272c 0a20 2020 2020 2020 2020 2020   5',.           
+0001cce0: 2066 277b 5f4a 4f42 5f51 5545 5545 5f57   f'{_JOB_QUEUE_W
+0001ccf0: 4149 547d 7c20 6772 6570 207b 6e61 6d65  AIT}| grep {name
+0001cd00: 7d20 7c20 6865 6164 202d 6e31 207c 2067  } | head -n1 | g
+0001cd10: 7265 7020 2243 414e 4345 4c4c 494e 475c  rep "CANCELLING\
+0001cd20: 7c43 414e 4345 4c4c 4544 2227 2c0a 2020  |CANCELLED"',.  
+0001cd30: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+0001cd40: 2031 3230 272c 0a20 2020 2020 2020 2020   120',.         
+0001cd50: 2020 2066 277b 5f4a 4f42 5f51 5545 5545     f'{_JOB_QUEUE
+0001cd60: 5f57 4149 547d 7c20 6772 6570 207b 6e61  _WAIT}| grep {na
+0001cd70: 6d65 7d20 7c20 6865 6164 202d 6e31 207c  me} | head -n1 |
+0001cd80: 2067 7265 7020 2243 414e 4345 4c4c 4544   grep "CANCELLED
+0001cd90: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+0001cda0: 2866 2773 3d24 2861 7773 2065 6332 2064  (f's=$(aws ec2 d
+0001cdb0: 6573 6372 6962 652d 696e 7374 616e 6365  escribe-instance
+0001cdc0: 7320 2d2d 7265 6769 6f6e 207b 7265 6769  s --region {regi
+0001cdd0: 6f6e 7d20 270a 2020 2020 2020 2020 2020  on} '.          
+0001cde0: 2020 2066 272d 2d66 696c 7465 7273 204e     f'--filters N
+0001cdf0: 616d 653d 7461 673a 7261 792d 636c 7573  ame=tag:ray-clus
+0001ce00: 7465 722d 6e61 6d65 2c56 616c 7565 733d  ter-name,Values=
+0001ce10: 7b6e 616d 655f 6f6e 5f63 6c6f 7564 7d2d  {name_on_cloud}-
+0001ce20: 2a20 270a 2020 2020 2020 2020 2020 2020  * '.            
+0001ce30: 2066 272d 2d71 7565 7279 2052 6573 6572   f'--query Reser
+0001ce40: 7661 7469 6f6e 735b 5d2e 496e 7374 616e  vations[].Instan
+0001ce50: 6365 735b 5d2e 5374 6174 655b 5d2e 4e61  ces[].State[].Na
+0001ce60: 6d65 2027 0a20 2020 2020 2020 2020 2020  me '.           
+0001ce70: 2020 272d 2d6f 7574 7075 7420 7465 7874    '--output text
+0001ce80: 2920 2626 2065 6368 6f20 2224 7322 2026  ) && echo "$s" &
+0001ce90: 2620 6563 686f 3b20 5b5b 202d 7a20 2224  & echo; [[ -z "$
+0001cea0: 7322 205d 5d20 7c7c 205b 5b20 2224 7322  s" ]] || [[ "$s"
+0001ceb0: 203d 2022 7465 726d 696e 6174 6564 2220   = "terminated" 
+0001cec0: 5d5d 207c 7c20 5b5b 2022 2473 2220 3d20  ]] || [[ "$s" = 
+0001ced0: 2273 6875 7474 696e 672d 646f 776e 2220  "shutting-down" 
+0001cee0: 5d5d 270a 2020 2020 2020 2020 2020 2020  ]]'.            
+0001cef0: 292c 0a20 2020 2020 2020 2020 2020 2023  ),.            #
+0001cf00: 2054 6573 7420 6361 6e63 656c 6c69 6e67   Test cancelling
+0001cf10: 2074 6865 2073 706f 7420 636c 7573 7465   the spot cluste
+0001cf20: 7220 6475 7269 6e67 2073 706f 7420 6a6f  r during spot jo
+0001cf30: 6220 6265 696e 6720 7365 7475 702e 0a20  b being setup.. 
+0001cf40: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0001cf50: 206a 6f62 7320 6c61 756e 6368 202d 2d63   jobs launch --c
+0001cf60: 6c6f 7564 2061 7773 202d 2d72 6567 696f  loud aws --regio
+0001cf70: 6e20 7b72 6567 696f 6e7d 202d 6e20 7b6e  n {region} -n {n
+0001cf80: 616d 657d 2d32 202d 2d75 7365 2d73 706f  ame}-2 --use-spo
+0001cf90: 7420 7465 7374 732f 7465 7374 5f79 616d  t tests/test_yam
+0001cfa0: 6c73 2f74 6573 745f 6c6f 6e67 5f73 6574  ls/test_long_set
+0001cfb0: 7570 2e79 616d 6c20 202d 7920 2d64 272c  up.yaml  -y -d',
+0001cfc0: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+0001cfd0: 6565 7020 3330 3027 2c0a 2020 2020 2020  eep 300',.      
+0001cfe0: 2020 2020 2020 5f4a 4f42 5f43 414e 4345        _JOB_CANCE
+0001cff0: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
+0001d000: 625f 6e61 6d65 3d66 277b 6e61 6d65 7d2d  b_name=f'{name}-
+0001d010: 3227 292c 0a20 2020 2020 2020 2020 2020  2'),.           
+0001d020: 2027 736c 6565 7020 3527 2c0a 2020 2020   'sleep 5',.    
+0001d030: 2020 2020 2020 2020 6627 7b5f 4a4f 425f          f'{_JOB_
+0001d040: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
+0001d050: 7020 7b6e 616d 657d 2d32 207c 2068 6561  p {name}-2 | hea
+0001d060: 6420 2d6e 3120 7c20 6772 6570 2022 4341  d -n1 | grep "CA
+0001d070: 4e43 454c 4c49 4e47 5c7c 4341 4e43 454c  NCELLING\|CANCEL
+0001d080: 4c45 4422 272c 0a20 2020 2020 2020 2020  LED"',.         
+0001d090: 2020 2027 736c 6565 7020 3132 3027 2c0a     'sleep 120',.
+0001d0a0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+0001d0b0: 4a4f 425f 5155 4555 455f 5741 4954 7d7c  JOB_QUEUE_WAIT}|
+0001d0c0: 2067 7265 7020 7b6e 616d 657d 2d32 207c   grep {name}-2 |
+0001d0d0: 2068 6561 6420 2d6e 3120 7c20 6772 6570   head -n1 | grep
+0001d0e0: 2022 4341 4e43 454c 4c45 4422 272c 0a20   "CANCELLED"',. 
+0001d0f0: 2020 2020 2020 2020 2020 2028 6627 733d             (f's=
+0001d100: 2428 6177 7320 6563 3220 6465 7363 7269  $(aws ec2 descri
+0001d110: 6265 2d69 6e73 7461 6e63 6573 202d 2d72  be-instances --r
+0001d120: 6567 696f 6e20 7b72 6567 696f 6e7d 2027  egion {region} '
+0001d130: 0a20 2020 2020 2020 2020 2020 2020 6627  .             f'
+0001d140: 2d2d 6669 6c74 6572 7320 4e61 6d65 3d74  --filters Name=t
+0001d150: 6167 3a72 6179 2d63 6c75 7374 6572 2d6e  ag:ray-cluster-n
+0001d160: 616d 652c 5661 6c75 6573 3d7b 6e61 6d65  ame,Values={name
+0001d170: 5f32 5f6f 6e5f 636c 6f75 647d 2d2a 2027  _2_on_cloud}-* '
+0001d180: 0a20 2020 2020 2020 2020 2020 2020 6627  .             f'
+0001d190: 2d2d 7175 6572 7920 5265 7365 7276 6174  --query Reservat
+0001d1a0: 696f 6e73 5b5d 2e49 6e73 7461 6e63 6573  ions[].Instances
+0001d1b0: 5b5d 2e53 7461 7465 5b5d 2e4e 616d 6520  [].State[].Name 
+0001d1c0: 270a 2020 2020 2020 2020 2020 2020 2027  '.             '
+0001d1d0: 2d2d 6f75 7470 7574 2074 6578 7429 2026  --output text) &
+0001d1e0: 2620 6563 686f 2022 2473 2220 2626 2065  & echo "$s" && e
+0001d1f0: 6368 6f3b 205b 5b20 2d7a 2022 2473 2220  cho; [[ -z "$s" 
+0001d200: 5d5d 207c 7c20 5b5b 2022 2473 2220 3d20  ]] || [[ "$s" = 
+0001d210: 2274 6572 6d69 6e61 7465 6422 205d 5d20  "terminated" ]] 
+0001d220: 7c7c 205b 5b20 2224 7322 203d 2022 7368  || [[ "$s" = "sh
+0001d230: 7574 7469 6e67 2d64 6f77 6e22 205d 5d27  utting-down" ]]'
+0001d240: 0a20 2020 2020 2020 2020 2020 2029 2c0a  .            ),.
+0001d250: 2020 2020 2020 2020 2020 2020 2320 5465              # Te
+0001d260: 7374 2063 616e 6365 6c6c 6174 696f 6e20  st cancellation 
+0001d270: 6475 7269 6e67 2073 706f 7420 6a6f 6220  during spot job 
+0001d280: 6973 2072 6563 6f76 6572 696e 672e 0a20  is recovering.. 
+0001d290: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0001d2a0: 206a 6f62 7320 6c61 756e 6368 202d 2d63   jobs launch --c
+0001d2b0: 6c6f 7564 2061 7773 202d 2d72 6567 696f  loud aws --regio
+0001d2c0: 6e20 7b72 6567 696f 6e7d 202d 6e20 7b6e  n {region} -n {n
+0001d2d0: 616d 657d 2d33 202d 2d75 7365 2d73 706f  ame}-3 --use-spo
+0001d2e0: 7420 2273 6c65 6570 2031 3030 3022 2020  t "sleep 1000"  
+0001d2f0: 2d79 202d 6427 2c0a 2020 2020 2020 2020  -y -d',.        
+0001d300: 2020 2020 2773 6c65 6570 2033 3030 272c      'sleep 300',
+0001d310: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+0001d320: 5f4a 4f42 5f51 5545 5545 5f57 4149 547d  _JOB_QUEUE_WAIT}
+0001d330: 7c20 6772 6570 207b 6e61 6d65 7d2d 3320  | grep {name}-3 
+0001d340: 7c20 6865 6164 202d 6e31 207c 2067 7265  | head -n1 | gre
+0001d350: 7020 2252 554e 4e49 4e47 2227 2c0a 2020  p "RUNNING"',.  
+0001d360: 2020 2020 2020 2020 2020 2320 5465 726d            # Term
+0001d370: 696e 6174 6520 7468 6520 636c 7573 7465  inate the cluste
+0001d380: 7220 6d61 6e75 616c 6c79 2e0a 2020 2020  r manually..    
+0001d390: 2020 2020 2020 2020 2866 2761 7773 2065          (f'aws e
+0001d3a0: 6332 2074 6572 6d69 6e61 7465 2d69 6e73  c2 terminate-ins
+0001d3b0: 7461 6e63 6573 202d 2d72 6567 696f 6e20  tances --region 
+0001d3c0: 7b72 6567 696f 6e7d 202d 2d69 6e73 7461  {region} --insta
+0001d3d0: 6e63 652d 6964 7320 2428 270a 2020 2020  nce-ids $('.    
+0001d3e0: 2020 2020 2020 2020 2066 2761 7773 2065           f'aws e
+0001d3f0: 6332 2064 6573 6372 6962 652d 696e 7374  c2 describe-inst
+0001d400: 616e 6365 7320 2d2d 7265 6769 6f6e 207b  ances --region {
+0001d410: 7265 6769 6f6e 7d20 270a 2020 2020 2020  region} '.      
+0001d420: 2020 2020 2020 2066 272d 2d66 696c 7465         f'--filte
+0001d430: 7273 204e 616d 653d 7461 673a 7261 792d  rs Name=tag:ray-
+0001d440: 636c 7573 7465 722d 6e61 6d65 2c56 616c  cluster-name,Val
+0001d450: 7565 733d 7b6e 616d 655f 335f 6f6e 5f63  ues={name_3_on_c
+0001d460: 6c6f 7564 7d2d 2a20 270a 2020 2020 2020  loud}-* '.      
+0001d470: 2020 2020 2020 2066 272d 2d71 7565 7279         f'--query
+0001d480: 2052 6573 6572 7661 7469 6f6e 735b 5d2e   Reservations[].
+0001d490: 496e 7374 616e 6365 735b 5d2e 496e 7374  Instances[].Inst
+0001d4a0: 616e 6365 4964 2027 0a20 2020 2020 2020  anceId '.       
+0001d4b0: 2020 2020 2020 272d 2d6f 7574 7075 7420        '--output 
+0001d4c0: 7465 7874 2927 292c 0a20 2020 2020 2020  text)'),.       
+0001d4d0: 2020 2020 2027 736c 6565 7020 3132 3027       'sleep 120'
+0001d4e0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+0001d4f0: 7b5f 4a4f 425f 5155 4555 455f 5741 4954  {_JOB_QUEUE_WAIT
+0001d500: 7d7c 2067 7265 7020 7b6e 616d 657d 2d33  }| grep {name}-3
+0001d510: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
+0001d520: 6570 2022 5245 434f 5645 5249 4e47 2227  ep "RECOVERING"'
+0001d530: 2c0a 2020 2020 2020 2020 2020 2020 5f4a  ,.            _J
+0001d540: 4f42 5f43 414e 4345 4c5f 5741 4954 2e66  OB_CANCEL_WAIT.f
+0001d550: 6f72 6d61 7428 6a6f 625f 6e61 6d65 3d66  ormat(job_name=f
+0001d560: 277b 6e61 6d65 7d2d 3327 292c 0a20 2020  '{name}-3'),.   
+0001d570: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+0001d580: 3527 2c0a 2020 2020 2020 2020 2020 2020  5',.            
+0001d590: 6627 7b5f 4a4f 425f 5155 4555 455f 5741  f'{_JOB_QUEUE_WA
+0001d5a0: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
+0001d5b0: 2d33 207c 2068 6561 6420 2d6e 3120 7c20  -3 | head -n1 | 
+0001d5c0: 6772 6570 2022 4341 4e43 454c 4c49 4e47  grep "CANCELLING
+0001d5d0: 5c7c 4341 4e43 454c 4c45 4422 272c 0a20  \|CANCELLED"',. 
+0001d5e0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+0001d5f0: 7020 3132 3027 2c0a 2020 2020 2020 2020  p 120',.        
+0001d600: 2020 2020 6627 7b5f 4a4f 425f 5155 4555      f'{_JOB_QUEU
+0001d610: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
+0001d620: 616d 657d 2d33 207c 2068 6561 6420 2d6e  ame}-3 | head -n
+0001d630: 3120 7c20 6772 6570 2022 4341 4e43 454c  1 | grep "CANCEL
+0001d640: 4c45 4422 272c 0a20 2020 2020 2020 2020  LED"',.         
+0001d650: 2020 2023 2054 6865 2063 6c75 7374 6572     # The cluster
+0001d660: 2073 686f 756c 6420 6265 2074 6572 6d69   should be termi
+0001d670: 6e61 7465 6420 2873 6875 7474 696e 672d  nated (shutting-
+0001d680: 646f 776e 2920 6166 7465 7220 6361 6e63  down) after canc
+0001d690: 656c 6c61 7469 6f6e 2e20 5765 2064 6f6e  ellation. We don
+0001d6a0: 2774 2075 7365 2074 6865 2060 3d60 206f  't use the `=` o
+0001d6b0: 7065 7261 746f 7220 6865 7265 2062 6563  perator here bec
+0001d6c0: 6175 7365 0a20 2020 2020 2020 2020 2020  ause.           
+0001d6d0: 2023 2074 6865 7265 2063 616e 2062 6520   # there can be 
+0001d6e0: 6d75 6c74 6970 6c65 2056 4d20 7769 7468  multiple VM with
+0001d6f0: 2074 6865 2073 616d 6520 6e61 6d65 2064   the same name d
+0001d700: 7565 2074 6f20 7468 6520 7265 636f 7665  ue to the recove
+0001d710: 7279 2e0a 2020 2020 2020 2020 2020 2020  ry..            
+0001d720: 2866 2773 3d24 2861 7773 2065 6332 2064  (f's=$(aws ec2 d
+0001d730: 6573 6372 6962 652d 696e 7374 616e 6365  escribe-instance
+0001d740: 7320 2d2d 7265 6769 6f6e 207b 7265 6769  s --region {regi
+0001d750: 6f6e 7d20 270a 2020 2020 2020 2020 2020  on} '.          
+0001d760: 2020 2066 272d 2d66 696c 7465 7273 204e     f'--filters N
+0001d770: 616d 653d 7461 673a 7261 792d 636c 7573  ame=tag:ray-clus
+0001d780: 7465 722d 6e61 6d65 2c56 616c 7565 733d  ter-name,Values=
+0001d790: 7b6e 616d 655f 335f 6f6e 5f63 6c6f 7564  {name_3_on_cloud
+0001d7a0: 7d2d 2a20 270a 2020 2020 2020 2020 2020  }-* '.          
+0001d7b0: 2020 2066 272d 2d71 7565 7279 2052 6573     f'--query Res
+0001d7c0: 6572 7661 7469 6f6e 735b 5d2e 496e 7374  ervations[].Inst
+0001d7d0: 616e 6365 735b 5d2e 5374 6174 655b 5d2e  ances[].State[].
+0001d7e0: 4e61 6d65 2027 0a20 2020 2020 2020 2020  Name '.         
+0001d7f0: 2020 2020 272d 2d6f 7574 7075 7420 7465      '--output te
+0001d800: 7874 2920 2626 2065 6368 6f20 2224 7322  xt) && echo "$s"
+0001d810: 2026 2620 6563 686f 3b20 5b5b 202d 7a20   && echo; [[ -z 
+0001d820: 2224 7322 205d 5d20 7c7c 2065 6368 6f20  "$s" ]] || echo 
+0001d830: 2224 7322 207c 2067 7265 7020 2d76 202d  "$s" | grep -v -
+0001d840: 4520 2270 656e 6469 6e67 7c72 756e 6e69  E "pending|runni
+0001d850: 6e67 7c73 746f 7070 6564 7c73 746f 7070  ng|stopped|stopp
+0001d860: 696e 6722 270a 2020 2020 2020 2020 2020  ing"'.          
+0001d870: 2020 292c 0a20 2020 2020 2020 205d 2c0a    ),.        ],.
+0001d880: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
+0001d890: 3235 202a 2036 3029 0a20 2020 2072 756e  25 * 60).    run
+0001d8a0: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+0001d8b0: 0a0a 4070 7974 6573 742e 6d61 726b 2e67  ..@pytest.mark.g
+0001d8c0: 6370 0a40 7079 7465 7374 2e6d 6172 6b2e  cp.@pytest.mark.
+0001d8d0: 6d61 6e61 6765 645f 6a6f 6273 0a64 6566  managed_jobs.def
+0001d8e0: 2074 6573 745f 6d61 6e61 6765 645f 6a6f   test_managed_jo
+0001d8f0: 6273 5f63 616e 6365 6c6c 6174 696f 6e5f  bs_cancellation_
+0001d900: 6763 7028 293a 0a20 2020 206e 616d 6520  gcp():.    name 
+0001d910: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+0001d920: 616d 6528 290a 2020 2020 6e61 6d65 5f33  ame().    name_3
+0001d930: 203d 2066 277b 6e61 6d65 7d2d 3327 0a20   = f'{name}-3'. 
+0001d940: 2020 206e 616d 655f 335f 6f6e 5f63 6c6f     name_3_on_clo
+0001d950: 7564 203d 2063 6f6d 6d6f 6e5f 7574 696c  ud = common_util
+0001d960: 732e 6d61 6b65 5f63 6c75 7374 6572 5f6e  s.make_cluster_n
+0001d970: 616d 655f 6f6e 5f63 6c6f 7564 280a 2020  ame_on_cloud(.  
+0001d980: 2020 2020 2020 6e61 6d65 5f33 2c20 6a6f        name_3, jo
+0001d990: 6273 2e4a 4f42 535f 434c 5553 5445 525f  bs.JOBS_CLUSTER_
+0001d9a0: 4e41 4d45 5f50 5245 4649 585f 4c45 4e47  NAME_PREFIX_LENG
+0001d9b0: 5448 2c20 6164 645f 7573 6572 5f68 6173  TH, add_user_has
+0001d9c0: 683d 4661 6c73 6529 0a20 2020 207a 6f6e  h=False).    zon
+0001d9d0: 6520 3d20 2775 732d 7765 7374 332d 6227  e = 'us-west3-b'
+0001d9e0: 0a20 2020 2071 7565 7279 5f73 7461 7465  .    query_state
+0001d9f0: 5f63 6d64 203d 2028 0a20 2020 2020 2020  _cmd = (.       
+0001da00: 2027 6763 6c6f 7564 2063 6f6d 7075 7465   'gcloud compute
+0001da10: 2069 6e73 7461 6e63 6573 206c 6973 7420   instances list 
+0001da20: 270a 2020 2020 2020 2020 6627 2d2d 6669  '.        f'--fi
+0001da30: 6c74 6572 3d22 286c 6162 656c 732e 7261  lter="(labels.ra
+0001da40: 792d 636c 7573 7465 722d 6e61 6d65 3a7b  y-cluster-name:{
+0001da50: 6e61 6d65 5f33 5f6f 6e5f 636c 6f75 647d  name_3_on_cloud}
+0001da60: 2922 2027 0a20 2020 2020 2020 2027 2d2d  )" '.        '--
+0001da70: 666f 726d 6174 3d22 7661 6c75 6528 7374  format="value(st
+0001da80: 6174 7573 2922 2729 0a20 2020 2071 7565  atus)"').    que
+0001da90: 7279 5f63 6d64 203d 2028 6627 6763 6c6f  ry_cmd = (f'gclo
+0001daa0: 7564 2063 6f6d 7075 7465 2069 6e73 7461  ud compute insta
+0001dab0: 6e63 6573 206c 6973 7420 2d2d 6669 6c74  nces list --filt
+0001dac0: 6572 3d27 0a20 2020 2020 2020 2020 2020  er='.           
+0001dad0: 2020 2020 2020 6627 2228 6c61 6265 6c73        f'"(labels
+0001dae0: 2e72 6179 2d63 6c75 7374 6572 2d6e 616d  .ray-cluster-nam
+0001daf0: 653a 7b6e 616d 655f 335f 6f6e 5f63 6c6f  e:{name_3_on_clo
+0001db00: 7564 7d29 2220 270a 2020 2020 2020 2020  ud})" '.        
+0001db10: 2020 2020 2020 2020 2066 272d 2d7a 6f6e           f'--zon
+0001db20: 6573 3d7b 7a6f 6e65 7d20 2d2d 666f 726d  es={zone} --form
+0001db30: 6174 3d22 7661 6c75 6528 6e61 6d65 2922  at="value(name)"
+0001db40: 2729 0a20 2020 2074 6572 6d69 6e61 7465  ').    terminate
+0001db50: 5f63 6d64 203d 2028 6627 6763 6c6f 7564  _cmd = (f'gcloud
+0001db60: 2063 6f6d 7075 7465 2069 6e73 7461 6e63   compute instanc
+0001db70: 6573 2064 656c 6574 6520 2d2d 7a6f 6e65  es delete --zone
+0001db80: 3d7b 7a6f 6e65 7d27 0a20 2020 2020 2020  ={zone}'.       
+0001db90: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+0001dba0: 202d 2d71 7569 6574 2024 287b 7175 6572   --quiet $({quer
+0001dbb0: 795f 636d 647d 2927 290a 2020 2020 7465  y_cmd})').    te
+0001dbc0: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+0001dbd0: 2020 2027 6d61 6e61 6765 645f 6a6f 6273     'managed_jobs
+0001dbe0: 5f63 616e 6365 6c6c 6174 696f 6e5f 6763  _cancellation_gc
+0001dbf0: 7027 2c0a 2020 2020 2020 2020 5b0a 2020  p',.        [.  
+0001dc00: 2020 2020 2020 2020 2020 2320 5465 7374            # Test
+0001dc10: 2063 616e 6365 6c6c 6174 696f 6e20 6475   cancellation du
+0001dc20: 7269 6e67 2073 706f 7420 636c 7573 7465  ring spot cluste
+0001dc30: 7220 6265 696e 6720 6c61 756e 6368 6564  r being launched
+0001dc40: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+0001dc50: 736b 7920 6a6f 6273 206c 6175 6e63 6820  sky jobs launch 
+0001dc60: 2d2d 636c 6f75 6420 6763 7020 2d2d 7a6f  --cloud gcp --zo
+0001dc70: 6e65 207b 7a6f 6e65 7d20 2d6e 207b 6e61  ne {zone} -n {na
+0001dc80: 6d65 7d20 2d2d 7573 652d 7370 6f74 2022  me} --use-spot "
+0001dc90: 736c 6565 7020 3130 3030 2220 202d 7920  sleep 1000"  -y 
+0001dca0: 2d64 272c 0a20 2020 2020 2020 2020 2020  -d',.           
+0001dcb0: 2027 736c 6565 7020 3630 272c 0a20 2020   'sleep 60',.   
+0001dcc0: 2020 2020 2020 2020 2066 277b 5f4a 4f42           f'{_JOB
+0001dcd0: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
+0001dce0: 6570 207b 6e61 6d65 7d20 7c20 6865 6164  ep {name} | head
+0001dcf0: 202d 6e31 207c 2067 7265 7020 2253 5441   -n1 | grep "STA
+0001dd00: 5254 494e 4722 272c 0a20 2020 2020 2020  RTING"',.       
+0001dd10: 2020 2020 205f 4a4f 425f 4341 4e43 454c       _JOB_CANCEL
+0001dd20: 5f57 4149 542e 666f 726d 6174 286a 6f62  _WAIT.format(job
+0001dd30: 5f6e 616d 653d 6e61 6d65 292c 0a20 2020  _name=name),.   
+0001dd40: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+0001dd50: 3527 2c0a 2020 2020 2020 2020 2020 2020  5',.            
+0001dd60: 6627 7b5f 4a4f 425f 5155 4555 455f 5741  f'{_JOB_QUEUE_WA
+0001dd70: 4954 7d7c 2067 7265 7020 7b6e 616d 657d  IT}| grep {name}
+0001dd80: 207c 2068 6561 6420 2d6e 3120 7c20 6772   | head -n1 | gr
+0001dd90: 6570 2022 4341 4e43 454c 4c49 4e47 5c7c  ep "CANCELLING\|
+0001dda0: 4341 4e43 454c 4c45 4422 272c 0a20 2020  CANCELLED"',.   
+0001ddb0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+0001ddc0: 3132 3027 2c0a 2020 2020 2020 2020 2020  120',.          
+0001ddd0: 2020 6627 7b5f 4a4f 425f 5155 4555 455f    f'{_JOB_QUEUE_
+0001dde0: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
+0001ddf0: 657d 207c 2068 6561 6420 2d6e 3120 7c20  e} | head -n1 | 
+0001de00: 6772 6570 2022 4341 4e43 454c 4c45 4422  grep "CANCELLED"
+0001de10: 272c 0a20 2020 2020 2020 2020 2020 2023  ',.            #
+0001de20: 2054 6573 7420 6361 6e63 656c 6c69 6e67   Test cancelling
+0001de30: 2074 6865 2073 706f 7420 636c 7573 7465   the spot cluste
+0001de40: 7220 6475 7269 6e67 2073 706f 7420 6a6f  r during spot jo
+0001de50: 6220 6265 696e 6720 7365 7475 702e 0a20  b being setup.. 
+0001de60: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0001de70: 206a 6f62 7320 6c61 756e 6368 202d 2d63   jobs launch --c
+0001de80: 6c6f 7564 2067 6370 202d 2d7a 6f6e 6520  loud gcp --zone 
+0001de90: 7b7a 6f6e 657d 202d 6e20 7b6e 616d 657d  {zone} -n {name}
+0001dea0: 2d32 202d 2d75 7365 2d73 706f 7420 7465  -2 --use-spot te
+0001deb0: 7374 732f 7465 7374 5f79 616d 6c73 2f74  sts/test_yamls/t
+0001dec0: 6573 745f 6c6f 6e67 5f73 6574 7570 2e79  est_long_setup.y
+0001ded0: 616d 6c20 202d 7920 2d64 272c 0a20 2020  aml  -y -d',.   
+0001dee0: 2020 2020 2020 2020 2027 736c 6565 7020           'sleep 
+0001def0: 3330 3027 2c0a 2020 2020 2020 2020 2020  300',.          
+0001df00: 2020 5f4a 4f42 5f43 414e 4345 4c5f 5741    _JOB_CANCEL_WA
+0001df10: 4954 2e66 6f72 6d61 7428 6a6f 625f 6e61  IT.format(job_na
+0001df20: 6d65 3d66 277b 6e61 6d65 7d2d 3227 292c  me=f'{name}-2'),
+0001df30: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+0001df40: 6565 7020 3527 2c0a 2020 2020 2020 2020  eep 5',.        
+0001df50: 2020 2020 6627 7b5f 4a4f 425f 5155 4555      f'{_JOB_QUEU
+0001df60: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
+0001df70: 616d 657d 2d32 207c 2068 6561 6420 2d6e  ame}-2 | head -n
+0001df80: 3120 7c20 6772 6570 2022 4341 4e43 454c  1 | grep "CANCEL
+0001df90: 4c49 4e47 5c7c 4341 4e43 454c 4c45 4422  LING\|CANCELLED"
+0001dfa0: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+0001dfb0: 736c 6565 7020 3132 3027 2c0a 2020 2020  sleep 120',.    
+0001dfc0: 2020 2020 2020 2020 6627 7b5f 4a4f 425f          f'{_JOB_
+0001dfd0: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
+0001dfe0: 7020 7b6e 616d 657d 2d32 207c 2068 6561  p {name}-2 | hea
+0001dff0: 6420 2d6e 3120 7c20 6772 6570 2022 4341  d -n1 | grep "CA
+0001e000: 4e43 454c 4c45 4422 272c 0a20 2020 2020  NCELLED"',.     
+0001e010: 2020 2020 2020 2023 2054 6573 7420 6361         # Test ca
+0001e020: 6e63 656c 6c61 7469 6f6e 2064 7572 696e  ncellation durin
+0001e030: 6720 7370 6f74 206a 6f62 2069 7320 7265  g spot job is re
+0001e040: 636f 7665 7269 6e67 2e0a 2020 2020 2020  covering..      
+0001e050: 2020 2020 2020 6627 736b 7920 6a6f 6273        f'sky jobs
+0001e060: 206c 6175 6e63 6820 2d2d 636c 6f75 6420   launch --cloud 
+0001e070: 6763 7020 2d2d 7a6f 6e65 207b 7a6f 6e65  gcp --zone {zone
+0001e080: 7d20 2d6e 207b 6e61 6d65 7d2d 3320 2d2d  } -n {name}-3 --
+0001e090: 7573 652d 7370 6f74 2022 736c 6565 7020  use-spot "sleep 
+0001e0a0: 3130 3030 2220 202d 7920 2d64 272c 0a20  1000"  -y -d',. 
+0001e0b0: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+0001e0c0: 7020 3330 3027 2c0a 2020 2020 2020 2020  p 300',.        
+0001e0d0: 2020 2020 6627 7b5f 4a4f 425f 5155 4555      f'{_JOB_QUEU
+0001e0e0: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
+0001e0f0: 616d 657d 2d33 207c 2068 6561 6420 2d6e  ame}-3 | head -n
+0001e100: 3120 7c20 6772 6570 2022 5255 4e4e 494e  1 | grep "RUNNIN
+0001e110: 4722 272c 0a20 2020 2020 2020 2020 2020  G"',.           
+0001e120: 2023 2054 6572 6d69 6e61 7465 2074 6865   # Terminate the
+0001e130: 2063 6c75 7374 6572 206d 616e 7561 6c6c   cluster manuall
+0001e140: 792e 0a20 2020 2020 2020 2020 2020 2074  y..            t
+0001e150: 6572 6d69 6e61 7465 5f63 6d64 2c0a 2020  erminate_cmd,.  
+0001e160: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+0001e170: 2038 3027 2c0a 2020 2020 2020 2020 2020   80',.          
+0001e180: 2020 6627 7b5f 4a4f 425f 5155 4555 455f    f'{_JOB_QUEUE_
+0001e190: 5741 4954 7d7c 2067 7265 7020 7b6e 616d  WAIT}| grep {nam
+0001e1a0: 657d 2d33 207c 2068 6561 6420 2d6e 3120  e}-3 | head -n1 
+0001e1b0: 7c20 6772 6570 2022 5245 434f 5645 5249  | grep "RECOVERI
+0001e1c0: 4e47 2227 2c0a 2020 2020 2020 2020 2020  NG"',.          
+0001e1d0: 2020 5f4a 4f42 5f43 414e 4345 4c5f 5741    _JOB_CANCEL_WA
+0001e1e0: 4954 2e66 6f72 6d61 7428 6a6f 625f 6e61  IT.format(job_na
+0001e1f0: 6d65 3d66 277b 6e61 6d65 7d2d 3327 292c  me=f'{name}-3'),
+0001e200: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+0001e210: 6565 7020 3527 2c0a 2020 2020 2020 2020  eep 5',.        
+0001e220: 2020 2020 6627 7b5f 4a4f 425f 5155 4555      f'{_JOB_QUEU
+0001e230: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
+0001e240: 616d 657d 2d33 207c 2068 6561 6420 2d6e  ame}-3 | head -n
+0001e250: 3120 7c20 6772 6570 2022 4341 4e43 454c  1 | grep "CANCEL
+0001e260: 4c49 4e47 5c7c 4341 4e43 454c 4c45 4422  LING\|CANCELLED"
+0001e270: 272c 0a20 2020 2020 2020 2020 2020 2027  ',.            '
+0001e280: 736c 6565 7020 3132 3027 2c0a 2020 2020  sleep 120',.    
+0001e290: 2020 2020 2020 2020 6627 7b5f 4a4f 425f          f'{_JOB_
+0001e2a0: 5155 4555 455f 5741 4954 7d7c 2067 7265  QUEUE_WAIT}| gre
+0001e2b0: 7020 7b6e 616d 657d 2d33 207c 2068 6561  p {name}-3 | hea
+0001e2c0: 6420 2d6e 3120 7c20 6772 6570 2022 4341  d -n1 | grep "CA
+0001e2d0: 4e43 454c 4c45 4422 272c 0a20 2020 2020  NCELLED"',.     
+0001e2e0: 2020 2020 2020 2023 2054 6865 2063 6c75         # The clu
+0001e2f0: 7374 6572 2073 686f 756c 6420 6265 2074  ster should be t
+0001e300: 6572 6d69 6e61 7465 6420 2853 544f 5050  erminated (STOPP
+0001e310: 494e 4729 2061 6674 6572 2063 616e 6365  ING) after cance
+0001e320: 6c6c 6174 696f 6e2e 2057 6520 646f 6e27  llation. We don'
+0001e330: 7420 7573 6520 7468 6520 603d 6020 6f70  t use the `=` op
+0001e340: 6572 6174 6f72 2068 6572 6520 6265 6361  erator here beca
+0001e350: 7573 650a 2020 2020 2020 2020 2020 2020  use.            
+0001e360: 2320 7468 6572 6520 6361 6e20 6265 206d  # there can be m
+0001e370: 756c 7469 706c 6520 564d 2077 6974 6820  ultiple VM with 
+0001e380: 7468 6520 7361 6d65 206e 616d 6520 6475  the same name du
+0001e390: 6520 746f 2074 6865 2072 6563 6f76 6572  e to the recover
+0001e3a0: 792e 0a20 2020 2020 2020 2020 2020 2028  y..            (
+0001e3b0: 6627 733d 2428 7b71 7565 7279 5f73 7461  f's=$({query_sta
+0001e3c0: 7465 5f63 6d64 7d29 2026 2620 6563 686f  te_cmd}) && echo
+0001e3d0: 2022 2473 2220 2626 2065 6368 6f3b 205b   "$s" && echo; [
+0001e3e0: 5b20 2d7a 2022 2473 2220 5d5d 207c 7c20  [ -z "$s" ]] || 
+0001e3f0: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
+0001e400: 202d 7620 2d45 2022 5052 4f56 4953 494f   -v -E "PROVISIO
+0001e410: 4e49 4e47 7c53 5441 4749 4e47 7c52 554e  NING|STAGING|RUN
+0001e420: 4e49 4e47 7c52 4550 4149 5249 4e47 7c54  NING|REPAIRING|T
+0001e430: 4552 4d49 4e41 5445 447c 5355 5350 454e  ERMINATED|SUSPEN
+0001e440: 4449 4e47 7c53 5553 5045 4e44 4544 7c53  DING|SUSPENDED|S
+0001e450: 5553 5045 4e44 4544 2227 0a20 2020 2020  USPENDED"'.     
+0001e460: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
+0001e470: 2020 5d2c 0a20 2020 2020 2020 2074 696d    ],.        tim
+0001e480: 656f 7574 3d32 3520 2a20 3630 290a 2020  eout=25 * 60).  
+0001e490: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+0001e4a0: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
+0001e4b0: 2d2d 2d20 5465 7374 696e 6720 7374 6f72  --- Testing stor
+0001e4c0: 6167 6520 666f 7220 6d61 6e61 6765 6420  age for managed 
+0001e4d0: 6a6f 6220 2d2d 2d2d 2d2d 2d2d 2d2d 0a40  job ----------.@
+0001e4e0: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f66  pytest.mark.no_f
+0001e4f0: 6c75 6964 7374 6163 6b20 2023 2046 6c75  luidstack  # Flu
+0001e500: 6964 7374 6163 6b20 646f 6573 206e 6f74  idstack does not
+0001e510: 2073 7570 706f 7274 2073 706f 7420 696e   support spot in
+0001e520: 7374 616e 6365 730a 4070 7974 6573 742e  stances.@pytest.
+0001e530: 6d61 726b 2e6e 6f5f 617a 7572 6520 2023  mark.no_azure  #
+0001e540: 2041 7a75 7265 2064 6f65 7320 6e6f 7420   Azure does not 
+0001e550: 7375 7070 6f72 7420 7370 6f74 2069 6e73  support spot ins
+0001e560: 7461 6e63 6573 0a40 7079 7465 7374 2e6d  tances.@pytest.m
+0001e570: 6172 6b2e 6e6f 5f6c 616d 6264 615f 636c  ark.no_lambda_cl
+0001e580: 6f75 6420 2023 204c 616d 6264 6120 436c  oud  # Lambda Cl
+0001e590: 6f75 6420 646f 6573 206e 6f74 2073 7570  oud does not sup
+0001e5a0: 706f 7274 2073 706f 7420 696e 7374 616e  port spot instan
+0001e5b0: 6365 730a 4070 7974 6573 742e 6d61 726b  ces.@pytest.mark
+0001e5c0: 2e6e 6f5f 6962 6d20 2023 2049 424d 2043  .no_ibm  # IBM C
+0001e5d0: 6c6f 7564 2064 6f65 7320 6e6f 7420 7375  loud does not su
+0001e5e0: 7070 6f72 7420 7370 6f74 2069 6e73 7461  pport spot insta
+0001e5f0: 6e63 6573 0a40 7079 7465 7374 2e6d 6172  nces.@pytest.mar
+0001e600: 6b2e 6e6f 5f70 6170 6572 7370 6163 6520  k.no_paperspace 
+0001e610: 2023 2050 6170 6572 7370 6163 6520 646f   # Paperspace do
+0001e620: 6573 206e 6f74 2073 7570 706f 7274 2073  es not support s
+0001e630: 706f 7420 696e 7374 616e 6365 730a 4070  pot instances.@p
+0001e640: 7974 6573 742e 6d61 726b 2e6e 6f5f 7363  ytest.mark.no_sc
+0001e650: 7020 2023 2053 4350 2064 6f65 7320 6e6f  p  # SCP does no
+0001e660: 7420 7375 7070 6f72 7420 7370 6f74 2069  t support spot i
+0001e670: 6e73 7461 6e63 6573 0a40 7079 7465 7374  nstances.@pytest
+0001e680: 2e6d 6172 6b2e 6d61 6e61 6765 645f 6a6f  .mark.managed_jo
+0001e690: 6273 0a64 6566 2074 6573 745f 6d61 6e61  bs.def test_mana
+0001e6a0: 6765 645f 6a6f 6273 5f73 746f 7261 6765  ged_jobs_storage
+0001e6b0: 2867 656e 6572 6963 5f63 6c6f 7564 3a20  (generic_cloud: 
+0001e6c0: 7374 7229 3a0a 2020 2020 2222 2254 6573  str):.    """Tes
+0001e6d0: 7420 7374 6f72 6167 6520 7769 7468 206d  t storage with m
+0001e6e0: 616e 6167 6564 206a 6f62 2222 220a 2020  anaged job""".  
+0001e6f0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+0001e700: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+0001e710: 2079 616d 6c5f 7374 7220 3d20 7061 7468   yaml_str = path
+0001e720: 6c69 622e 5061 7468 280a 2020 2020 2020  lib.Path(.      
+0001e730: 2020 2765 7861 6d70 6c65 732f 6d61 6e61    'examples/mana
+0001e740: 6765 645f 6a6f 625f 7769 7468 5f73 746f  ged_job_with_sto
+0001e750: 7261 6765 2e79 616d 6c27 292e 7265 6164  rage.yaml').read
+0001e760: 5f74 6578 7428 290a 2020 2020 7374 6f72  _text().    stor
+0001e770: 6167 655f 6e61 6d65 203d 2066 2773 6b79  age_name = f'sky
+0001e780: 2d74 6573 742d 7b69 6e74 2874 696d 652e  -test-{int(time.
+0001e790: 7469 6d65 2829 297d 270a 0a20 2020 2023  time())}'..    #
+0001e7a0: 2041 6c73 6f20 7065 7266 6f72 6d20 7265   Also perform re
+0001e7b0: 6769 6f6e 2074 6573 7469 6e67 2066 6f72  gion testing for
+0001e7c0: 2062 7563 6b65 7420 6372 6561 7469 6f6e   bucket creation
+0001e7d0: 2074 6f20 7661 6c69 6461 7465 2069 6620   to validate if 
+0001e7e0: 6275 636b 6574 7320 6172 650a 2020 2020  buckets are.    
+0001e7f0: 2320 6372 6561 7465 6420 696e 2074 6865  # created in the
+0001e800: 2063 6f72 7265 6374 2072 6567 696f 6e20   correct region 
+0001e810: 616e 6420 636f 7272 6563 746c 7920 6d6f  and correctly mo
+0001e820: 756e 7465 6420 696e 206d 616e 6167 6564  unted in managed
+0001e830: 206a 6f62 732e 0a20 2020 2023 2048 6f77   jobs..    # How
+0001e840: 6576 6572 2c20 7765 2069 6e6a 6563 7420  ever, we inject 
+0001e850: 7468 6973 2074 6573 7469 6e67 206f 6e6c  this testing onl
+0001e860: 7920 666f 7220 4157 5320 616e 6420 4743  y for AWS and GC
+0001e870: 5020 7369 6e63 6520 7468 6579 2061 7265  P since they are
+0001e880: 2074 6865 0a20 2020 2023 2073 7570 706f   the.    # suppo
+0001e890: 7274 6564 206f 626a 6563 7420 7374 6f72  rted object stor
+0001e8a0: 6167 6520 7072 6f76 6964 6572 7320 696e  age providers in
+0001e8b0: 2053 6b79 5069 6c6f 742e 0a20 2020 2072   SkyPilot..    r
+0001e8c0: 6567 696f 6e5f 666c 6167 203d 2027 270a  egion_flag = ''.
+0001e8d0: 2020 2020 7265 6769 6f6e 5f76 616c 6964      region_valid
+0001e8e0: 6174 696f 6e5f 636d 6420 3d20 2774 7275  ation_cmd = 'tru
+0001e8f0: 6527 0a20 2020 2075 7365 5f73 706f 7420  e'.    use_spot 
+0001e900: 3d20 2720 2d2d 7573 652d 7370 6f74 270a  = ' --use-spot'.
+0001e910: 2020 2020 6966 2067 656e 6572 6963 5f63      if generic_c
+0001e920: 6c6f 7564 203d 3d20 2761 7773 273a 0a20  loud == 'aws':. 
+0001e930: 2020 2020 2020 2072 6567 696f 6e20 3d20         region = 
+0001e940: 2765 752d 6365 6e74 7261 6c2d 3127 0a20  'eu-central-1'. 
+0001e950: 2020 2020 2020 2072 6567 696f 6e5f 666c         region_fl
+0001e960: 6167 203d 2066 2720 2d2d 7265 6769 6f6e  ag = f' --region
+0001e970: 207b 7265 6769 6f6e 7d27 0a20 2020 2020   {region}'.     
+0001e980: 2020 2072 6567 696f 6e5f 636d 6420 3d20     region_cmd = 
+0001e990: 5465 7374 5374 6f72 6167 6557 6974 6843  TestStorageWithC
+0001e9a0: 7265 6465 6e74 6961 6c73 2e63 6c69 5f72  redentials.cli_r
+0001e9b0: 6567 696f 6e5f 636d 6428 0a20 2020 2020  egion_cmd(.     
+0001e9c0: 2020 2020 2020 2073 746f 7261 6765 5f6c         storage_l
+0001e9d0: 6962 2e53 746f 7265 5479 7065 2e53 332c  ib.StoreType.S3,
+0001e9e0: 2073 746f 7261 6765 5f6e 616d 6529 0a20   storage_name). 
+0001e9f0: 2020 2020 2020 2072 6567 696f 6e5f 7661         region_va
+0001ea00: 6c69 6461 7469 6f6e 5f63 6d64 203d 2066  lidation_cmd = f
+0001ea10: 277b 7265 6769 6f6e 5f63 6d64 7d20 7c20  '{region_cmd} | 
+0001ea20: 6772 6570 207b 7265 6769 6f6e 7d27 0a20  grep {region}'. 
+0001ea30: 2020 2065 6c69 6620 6765 6e65 7269 635f     elif generic_
+0001ea40: 636c 6f75 6420 3d3d 2027 6763 7027 3a0a  cloud == 'gcp':.
+0001ea50: 2020 2020 2020 2020 7265 6769 6f6e 203d          region =
+0001ea60: 2027 7573 2d77 6573 7432 270a 2020 2020   'us-west2'.    
+0001ea70: 2020 2020 7265 6769 6f6e 5f66 6c61 6720      region_flag 
+0001ea80: 3d20 6627 202d 2d72 6567 696f 6e20 7b72  = f' --region {r
+0001ea90: 6567 696f 6e7d 270a 2020 2020 2020 2020  egion}'.        
+0001eaa0: 7265 6769 6f6e 5f63 6d64 203d 2054 6573  region_cmd = Tes
+0001eab0: 7453 746f 7261 6765 5769 7468 4372 6564  tStorageWithCred
+0001eac0: 656e 7469 616c 732e 636c 695f 7265 6769  entials.cli_regi
+0001ead0: 6f6e 5f63 6d64 280a 2020 2020 2020 2020  on_cmd(.        
+0001eae0: 2020 2020 7374 6f72 6167 655f 6c69 622e      storage_lib.
+0001eaf0: 5374 6f72 6554 7970 652e 4743 532c 2073  StoreType.GCS, s
+0001eb00: 746f 7261 6765 5f6e 616d 6529 0a20 2020  torage_name).   
+0001eb10: 2020 2020 2072 6567 696f 6e5f 7661 6c69       region_vali
+0001eb20: 6461 7469 6f6e 5f63 6d64 203d 2066 277b  dation_cmd = f'{
+0001eb30: 7265 6769 6f6e 5f63 6d64 7d20 7c20 6772  region_cmd} | gr
+0001eb40: 6570 207b 7265 6769 6f6e 7d27 0a20 2020  ep {region}'.   
+0001eb50: 2065 6c69 6620 6765 6e65 7269 635f 636c   elif generic_cl
+0001eb60: 6f75 6420 3d3d 2027 6b75 6265 726e 6574  oud == 'kubernet
+0001eb70: 6573 273a 0a20 2020 2020 2020 2075 7365  es':.        use
+0001eb80: 5f73 706f 7420 3d20 2720 2d2d 6e6f 2d75  _spot = ' --no-u
+0001eb90: 7365 2d73 706f 7427 0a0a 2020 2020 7961  se-spot'..    ya
+0001eba0: 6d6c 5f73 7472 203d 2079 616d 6c5f 7374  ml_str = yaml_st
+0001ebb0: 722e 7265 706c 6163 6528 2773 6b79 2d77  r.replace('sky-w
+0001ebc0: 6f72 6b64 6972 2d7a 6877 7527 2c20 7374  orkdir-zhwu', st
+0001ebd0: 6f72 6167 655f 6e61 6d65 290a 2020 2020  orage_name).    
+0001ebe0: 7769 7468 2074 656d 7066 696c 652e 4e61  with tempfile.Na
+0001ebf0: 6d65 6454 656d 706f 7261 7279 4669 6c65  medTemporaryFile
+0001ec00: 2873 7566 6669 783d 272e 7961 6d6c 272c  (suffix='.yaml',
+0001ec10: 206d 6f64 653d 2777 2729 2061 7320 663a   mode='w') as f:
+0001ec20: 0a20 2020 2020 2020 2066 2e77 7269 7465  .        f.write
+0001ec30: 2879 616d 6c5f 7374 7229 0a20 2020 2020  (yaml_str).     
+0001ec40: 2020 2066 2e66 6c75 7368 2829 0a20 2020     f.flush().   
+0001ec50: 2020 2020 2066 696c 655f 7061 7468 203d       file_path =
+0001ec60: 2066 2e6e 616d 650a 2020 2020 2020 2020   f.name.        
+0001ec70: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+0001ec80: 2020 2020 2020 2020 2027 6d61 6e61 6765           'manage
+0001ec90: 645f 6a6f 6273 5f73 746f 7261 6765 272c  d_jobs_storage',
+0001eca0: 0a20 2020 2020 2020 2020 2020 205b 0a20  .            [. 
+0001ecb0: 2020 2020 2020 2020 2020 2020 2020 202a                 *
+0001ecc0: 7374 6f72 6167 655f 7365 7475 705f 636f  storage_setup_co
+0001ecd0: 6d6d 616e 6473 2c0a 2020 2020 2020 2020  mmands,.        
+0001ece0: 2020 2020 2020 2020 6627 736b 7920 6a6f          f'sky jo
+0001ecf0: 6273 206c 6175 6e63 6820 2d6e 207b 6e61  bs launch -n {na
+0001ed00: 6d65 7d7b 7573 655f 7370 6f74 7d20 2d2d  me}{use_spot} --
+0001ed10: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
+0001ed20: 6c6f 7564 7d7b 7265 6769 6f6e 5f66 6c61  loud}{region_fla
+0001ed30: 677d 207b 6669 6c65 5f70 6174 687d 202d  g} {file_path} -
+0001ed40: 7927 2c0a 2020 2020 2020 2020 2020 2020  y',.            
+0001ed50: 2020 2020 7265 6769 6f6e 5f76 616c 6964      region_valid
+0001ed60: 6174 696f 6e5f 636d 642c 2020 2320 4368  ation_cmd,  # Ch
+0001ed70: 6563 6b20 6966 2074 6865 2062 7563 6b65  eck if the bucke
+0001ed80: 7420 6973 2063 7265 6174 6564 2069 6e20  t is created in 
+0001ed90: 7468 6520 636f 7272 6563 7420 7265 6769  the correct regi
+0001eda0: 6f6e 0a20 2020 2020 2020 2020 2020 2020  on.             
+0001edb0: 2020 2027 736c 6565 7020 3630 272c 2020     'sleep 60',  
+0001edc0: 2320 5761 6974 2074 6865 2073 706f 7420  # Wait the spot 
+0001edd0: 7175 6575 6520 746f 2062 6520 7570 6461  queue to be upda
+0001ede0: 7465 640a 2020 2020 2020 2020 2020 2020  ted.            
+0001edf0: 2020 2020 6627 7b5f 4a4f 425f 5155 4555      f'{_JOB_QUEU
+0001ee00: 455f 5741 4954 7d7c 2067 7265 7020 7b6e  E_WAIT}| grep {n
+0001ee10: 616d 657d 207c 2067 7265 7020 5355 4343  ame} | grep SUCC
+0001ee20: 4545 4445 4427 2c0a 2020 2020 2020 2020  EEDED',.        
+0001ee30: 2020 2020 2020 2020 6627 5b20 2428 6177          f'[ $(aw
+0001ee40: 7320 7333 6170 6920 6c69 7374 2d62 7563  s s3api list-buc
+0001ee50: 6b65 7473 202d 2d71 7565 7279 2022 4275  kets --query "Bu
+0001ee60: 636b 6574 735b 3f63 6f6e 7461 696e 7328  ckets[?contains(
+0001ee70: 4e61 6d65 2c20 5c27 7b73 746f 7261 6765  Name, \'{storage
+0001ee80: 5f6e 616d 657d 5c27 295d 2e4e 616d 6522  _name}\')].Name"
+0001ee90: 202d 2d6f 7574 7075 7420 7465 7874 207c   --output text |
+0001eea0: 2077 6320 2d6c 2920 2d65 7120 3020 5d27   wc -l) -eq 0 ]'
+0001eeb0: 0a20 2020 2020 2020 2020 2020 205d 2c0a  .            ],.
+0001eec0: 2020 2020 2020 2020 2020 2020 5f4a 4f42              _JOB
+0001eed0: 5f43 414e 4345 4c5f 5741 4954 2e66 6f72  _CANCEL_WAIT.for
+0001eee0: 6d61 7428 6a6f 625f 6e61 6d65 3d6e 616d  mat(job_name=nam
+0001eef0: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
+0001ef00: 2320 496e 6372 6561 7365 2074 696d 656f  # Increase timeo
+0001ef10: 7574 2073 696e 6365 2073 6b79 206a 6f62  ut since sky job
+0001ef20: 7320 7175 6575 6520 2d72 2063 616e 2062  s queue -r can b
+0001ef30: 6520 626c 6f63 6b65 6420 6279 206f 7468  e blocked by oth
+0001ef40: 6572 2073 706f 7420 7465 7374 732e 0a20  er spot tests.. 
+0001ef50: 2020 2020 2020 2020 2020 2074 696d 656f             timeo
+0001ef60: 7574 3d32 3020 2a20 3630 2c0a 2020 2020  ut=20 * 60,.    
+0001ef70: 2020 2020 290a 2020 2020 2020 2020 7275      ).        ru
+0001ef80: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+0001ef90: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
+0001efa0: 5465 7374 696e 6720 7370 6f74 2054 5055  Testing spot TPU
+0001efb0: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 4070 7974   ----------.@pyt
+0001efc0: 6573 742e 6d61 726b 2e67 6370 0a40 7079  est.mark.gcp.@py
+0001efd0: 7465 7374 2e6d 6172 6b2e 6d61 6e61 6765  test.mark.manage
+0001efe0: 645f 6a6f 6273 0a40 7079 7465 7374 2e6d  d_jobs.@pytest.m
+0001eff0: 6172 6b2e 7470 750a 6465 6620 7465 7374  ark.tpu.def test
+0001f000: 5f6d 616e 6167 6564 5f6a 6f62 735f 7470  _managed_jobs_tp
+0001f010: 7528 293a 0a20 2020 2022 2222 5465 7374  u():.    """Test
+0001f020: 206d 616e 6167 6564 206a 6f62 206f 6e20   managed job on 
+0001f030: 5450 552e 2222 220a 2020 2020 6e61 6d65  TPU.""".    name
+0001f040: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+0001f050: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+0001f060: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+0001f070: 2774 6573 742d 7370 6f74 2d74 7075 272c  'test-spot-tpu',
+0001f080: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+0001f090: 2020 2020 2020 2066 2773 6b79 206a 6f62         f'sky job
+0001f0a0: 7320 6c61 756e 6368 202d 6e20 7b6e 616d  s launch -n {nam
+0001f0b0: 657d 202d 2d75 7365 2d73 706f 7420 6578  e} --use-spot ex
+0001f0c0: 616d 706c 6573 2f74 7075 2f74 7075 766d  amples/tpu/tpuvm
+0001f0d0: 5f6d 6e69 7374 2e79 616d 6c20 2d79 202d  _mnist.yaml -y -
+0001f0e0: 6427 2c0a 2020 2020 2020 2020 2020 2020  d',.            
+0001f0f0: 2773 6c65 6570 2035 272c 0a20 2020 2020  'sleep 5',.     
+0001f100: 2020 2020 2020 2066 277b 5f4a 4f42 5f51         f'{_JOB_Q
+0001f110: 5545 5545 5f57 4149 547d 7c20 6772 6570  UEUE_WAIT}| grep
+0001f120: 207b 6e61 6d65 7d20 7c20 6865 6164 202d   {name} | head -
+0001f130: 6e31 207c 2067 7265 7020 5354 4152 5449  n1 | grep STARTI
+0001f140: 4e47 272c 0a20 2020 2020 2020 2020 2020  NG',.           
+0001f150: 2027 736c 6565 7020 3930 3027 2c20 2023   'sleep 900',  #
+0001f160: 2054 5055 2074 616b 6573 2061 2077 6869   TPU takes a whi
+0001f170: 6c65 2074 6f20 6c61 756e 6368 0a20 2020  le to launch.   
+0001f180: 2020 2020 2020 2020 2066 277b 5f4a 4f42           f'{_JOB
+0001f190: 5f51 5545 5545 5f57 4149 547d 7c20 6772  _QUEUE_WAIT}| gr
+0001f1a0: 6570 207b 6e61 6d65 7d20 7c20 6865 6164  ep {name} | head
+0001f1b0: 202d 6e31 207c 2067 7265 7020 2252 554e   -n1 | grep "RUN
+0001f1c0: 4e49 4e47 5c7c 5355 4343 4545 4445 4422  NING\|SUCCEEDED"
+0001f1d0: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+0001f1e0: 2020 2020 2020 5f4a 4f42 5f43 414e 4345        _JOB_CANCE
+0001f1f0: 4c5f 5741 4954 2e66 6f72 6d61 7428 6a6f  L_WAIT.format(jo
+0001f200: 625f 6e61 6d65 3d6e 616d 6529 2c0a 2020  b_name=name),.  
+0001f210: 2020 2020 2020 2320 496e 6372 6561 7365        # Increase
+0001f220: 2074 696d 656f 7574 2073 696e 6365 2073   timeout since s
+0001f230: 6b79 206a 6f62 7320 7175 6575 6520 2d72  ky jobs queue -r
+0001f240: 2063 616e 2062 6520 626c 6f63 6b65 6420   can be blocked 
+0001f250: 6279 206f 7468 6572 2073 706f 7420 7465  by other spot te
+0001f260: 7374 732e 0a20 2020 2020 2020 2074 696d  sts..        tim
+0001f270: 656f 7574 3d32 3020 2a20 3630 2c0a 2020  eout=20 * 60,.  
+0001f280: 2020 290a 2020 2020 7275 6e5f 6f6e 655f    ).    run_one_
+0001f290: 7465 7374 2874 6573 7429 0a0a 0a23 202d  test(test)...# -
+0001f2a0: 2d2d 2d2d 2d2d 2d2d 2d20 5465 7374 696e  --------- Testin
+0001f2b0: 6720 656e 7620 666f 7220 6d61 6e61 6765  g env for manage
+0001f2c0: 6420 6a6f 6273 202d 2d2d 2d2d 2d2d 2d2d  d jobs ---------
+0001f2d0: 2d0a 4070 7974 6573 742e 6d61 726b 2e6d  -.@pytest.mark.m
+0001f2e0: 616e 6167 6564 5f6a 6f62 730a 6465 6620  anaged_jobs.def 
+0001f2f0: 7465 7374 5f6d 616e 6167 6564 5f6a 6f62  test_managed_job
+0001f300: 735f 696e 6c69 6e65 5f65 6e76 2867 656e  s_inline_env(gen
+0001f310: 6572 6963 5f63 6c6f 7564 3a20 7374 7229  eric_cloud: str)
+0001f320: 3a0a 2020 2020 2222 2254 6573 7420 6d61  :.    """Test ma
+0001f330: 6e61 6765 6420 6a6f 6273 2065 6e76 2222  naged jobs env""
+0001f340: 220a 2020 2020 6e61 6d65 203d 205f 6765  ".    name = _ge
+0001f350: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+0001f360: 0a20 2020 2074 6573 7420 3d20 5465 7374  .    test = Test
+0001f370: 280a 2020 2020 2020 2020 2774 6573 742d  (.        'test-
+0001f380: 6d61 6e61 6765 642d 6a6f 6273 2d69 6e6c  managed-jobs-inl
+0001f390: 696e 652d 656e 7627 2c0a 2020 2020 2020  ine-env',.      
+0001f3a0: 2020 5b0a 2020 2020 2020 2020 2020 2020    [.            
+0001f3b0: 6627 736b 7920 6a6f 6273 206c 6175 6e63  f'sky jobs launc
+0001f3c0: 6820 2d6e 207b 6e61 6d65 7d20 2d79 202d  h -n {name} -y -
+0001f3d0: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
+0001f3e0: 636c 6f75 647d 202d 2d65 6e76 2054 4553  cloud} --env TES
+0001f3f0: 545f 454e 563d 2268 656c 6c6f 2077 6f72  T_ENV="hello wor
+0001f400: 6c64 2220 2d2d 2022 285b 5b20 2120 2d7a  ld" -- "([[ ! -z
+0001f410: 205c 5c22 5c24 5445 5354 5f45 4e56 5c5c   \\"\$TEST_ENV\\
+0001f420: 2220 5d5d 2026 2620 5b5b 2021 202d 7a20  " ]] && [[ ! -z 
+0001f430: 5c5c 225c 2453 4b59 5049 4c4f 545f 4e4f  \\"\$SKYPILOT_NO
+0001f440: 4445 5f49 5053 5c5c 2220 5d5d 2026 2620  DE_IPS\\" ]] && 
+0001f450: 5b5b 2021 202d 7a20 5c5c 225c 2453 4b59  [[ ! -z \\"\$SKY
+0001f460: 5049 4c4f 545f 4e4f 4445 5f52 414e 4b5c  PILOT_NODE_RANK\
+0001f470: 5c22 205d 5d29 207c 7c20 6578 6974 2031  \" ]]) || exit 1
+0001f480: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+0001f490: 2773 6c65 6570 2032 3027 2c0a 2020 2020  'sleep 20',.    
+0001f4a0: 2020 2020 2020 2020 6627 7b5f 4a4f 425f          f'{_JOB_
+0001f4b0: 5155 4555 455f 5741 4954 7d20 7c20 6772  QUEUE_WAIT} | gr
+0001f4c0: 6570 207b 6e61 6d65 7d20 7c20 6772 6570  ep {name} | grep
+0001f4d0: 2053 5543 4345 4544 4544 272c 0a20 2020   SUCCEEDED',.   
+0001f4e0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+0001f4f0: 5f4a 4f42 5f43 414e 4345 4c5f 5741 4954  _JOB_CANCEL_WAIT
+0001f500: 2e66 6f72 6d61 7428 6a6f 625f 6e61 6d65  .format(job_name
+0001f510: 3d6e 616d 6529 2c0a 2020 2020 2020 2020  =name),.        
+0001f520: 2320 496e 6372 6561 7365 2074 696d 656f  # Increase timeo
+0001f530: 7574 2073 696e 6365 2073 6b79 206a 6f62  ut since sky job
+0001f540: 7320 7175 6575 6520 2d72 2063 616e 2062  s queue -r can b
+0001f550: 6520 626c 6f63 6b65 6420 6279 206f 7468  e blocked by oth
+0001f560: 6572 2073 706f 7420 7465 7374 732e 0a20  er spot tests.. 
+0001f570: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
+0001f580: 3020 2a20 3630 2c0a 2020 2020 290a 2020  0 * 60,.    ).  
+0001f590: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+0001f5a0: 6573 7429 0a0a 0a23 202d 2d2d 2d2d 2d2d  est)...# -------
+0001f5b0: 2d2d 2d20 5465 7374 696e 6720 656e 7620  --- Testing env 
+0001f5c0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a64 6566 2074  ----------.def t
+0001f5d0: 6573 745f 696e 6c69 6e65 5f65 6e76 2867  est_inline_env(g
+0001f5e0: 656e 6572 6963 5f63 6c6f 7564 3a20 7374  eneric_cloud: st
+0001f5f0: 7229 3a0a 2020 2020 2222 2254 6573 7420  r):.    """Test 
+0001f600: 656e 7622 2222 0a20 2020 206e 616d 6520  env""".    name 
+0001f610: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+0001f620: 616d 6528 290a 2020 2020 7465 7374 203d  ame().    test =
+0001f630: 2054 6573 7428 0a20 2020 2020 2020 2027   Test(.        '
+0001f640: 7465 7374 2d69 6e6c 696e 652d 656e 7627  test-inline-env'
+0001f650: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+0001f660: 2020 2020 2020 2020 6627 736b 7920 6c61          f'sky la
+0001f670: 756e 6368 202d 6320 7b6e 616d 657d 202d  unch -c {name} -
+0001f680: 7920 2d2d 636c 6f75 6420 7b67 656e 6572  y --cloud {gener
+0001f690: 6963 5f63 6c6f 7564 7d20 2d2d 656e 7620  ic_cloud} --env 
+0001f6a0: 5445 5354 5f45 4e56 3d22 6865 6c6c 6f20  TEST_ENV="hello 
+0001f6b0: 776f 726c 6422 202d 2d20 2228 5b5b 2021  world" -- "([[ !
+0001f6c0: 202d 7a20 5c5c 225c 2454 4553 545f 454e   -z \\"\$TEST_EN
+0001f6d0: 565c 5c22 205d 5d20 2626 205b 5b20 2120  V\\" ]] && [[ ! 
+0001f6e0: 2d7a 205c 5c22 5c24 534b 5950 494c 4f54  -z \\"\$SKYPILOT
+0001f6f0: 5f4e 4f44 455f 4950 535c 5c22 205d 5d20  _NODE_IPS\\" ]] 
+0001f700: 2626 205b 5b20 2120 2d7a 205c 5c22 5c24  && [[ ! -z \\"\$
+0001f710: 534b 5950 494c 4f54 5f4e 4f44 455f 5241  SKYPILOT_NODE_RA
+0001f720: 4e4b 5c5c 2220 5d5d 2920 7c7c 2065 7869  NK\\" ]]) || exi
+0001f730: 7420 3122 272c 0a20 2020 2020 2020 2020  t 1"',.         
+0001f740: 2020 2027 736c 6565 7020 3230 272c 0a20     'sleep 20',. 
+0001f750: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+0001f760: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
+0001f770: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
+0001f780: 2020 2020 2020 6627 736b 7920 6578 6563        f'sky exec
+0001f790: 207b 6e61 6d65 7d20 2d2d 656e 7620 5445   {name} --env TE
+0001f7a0: 5354 5f45 4e56 323d 2273 7563 6365 7373  ST_ENV2="success
+0001f7b0: 2220 2228 5b5b 2021 202d 7a20 5c5c 225c  " "([[ ! -z \\"\
+0001f7c0: 2454 4553 545f 454e 5632 5c5c 2220 5d5d  $TEST_ENV2\\" ]]
+0001f7d0: 2026 2620 5b5b 2021 202d 7a20 5c5c 225c   && [[ ! -z \\"\
+0001f7e0: 2453 4b59 5049 4c4f 545f 4e4f 4445 5f49  $SKYPILOT_NODE_I
+0001f7f0: 5053 5c5c 2220 5d5d 2026 2620 5b5b 2021  PS\\" ]] && [[ !
+0001f800: 202d 7a20 5c5c 225c 2453 4b59 5049 4c4f   -z \\"\$SKYPILO
+0001f810: 545f 4e4f 4445 5f52 414e 4b5c 5c22 205d  T_NODE_RANK\\" ]
+0001f820: 5d29 207c 7c20 6578 6974 2031 2227 2c0a  ]) || exit 1"',.
+0001f830: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0001f840: 7920 6c6f 6773 207b 6e61 6d65 7d20 3220  y logs {name} 2 
+0001f850: 2d2d 7374 6174 7573 272c 0a20 2020 2020  --status',.     
+0001f860: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
+0001f870: 736b 7920 646f 776e 202d 7920 7b6e 616d  sky down -y {nam
+0001f880: 657d 272c 0a20 2020 2020 2020 205f 6765  e}',.        _ge
+0001f890: 745f 7469 6d65 6f75 7428 6765 6e65 7269  t_timeout(generi
+0001f8a0: 635f 636c 6f75 6429 2c0a 2020 2020 290a  c_cloud),.    ).
+0001f8b0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+0001f8c0: 2874 6573 7429 0a0a 0a23 202d 2d2d 2d2d  (test)...# -----
+0001f8d0: 2d2d 2d2d 2d20 5465 7374 696e 6720 656e  ----- Testing en
+0001f8e0: 7620 6669 6c65 202d 2d2d 2d2d 2d2d 2d2d  v file ---------
+0001f8f0: 2d0a 6465 6620 7465 7374 5f69 6e6c 696e  -.def test_inlin
+0001f900: 655f 656e 765f 6669 6c65 2867 656e 6572  e_env_file(gener
+0001f910: 6963 5f63 6c6f 7564 3a20 7374 7229 3a0a  ic_cloud: str):.
+0001f920: 2020 2020 2222 2254 6573 7420 656e 7622      """Test env"
+0001f930: 2222 0a20 2020 206e 616d 6520 3d20 5f67  "".    name = _g
+0001f940: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+0001f950: 290a 2020 2020 7465 7374 203d 2054 6573  ).    test = Tes
+0001f960: 7428 0a20 2020 2020 2020 2027 7465 7374  t(.        'test
+0001f970: 2d69 6e6c 696e 652d 656e 762d 6669 6c65  -inline-env-file
+0001f980: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+0001f990: 2020 2020 2020 2020 2066 2773 6b79 206c           f'sky l
+0001f9a0: 6175 6e63 6820 2d63 207b 6e61 6d65 7d20  aunch -c {name} 
+0001f9b0: 2d79 202d 2d63 6c6f 7564 207b 6765 6e65  -y --cloud {gene
+0001f9c0: 7269 635f 636c 6f75 647d 202d 2d65 6e76  ric_cloud} --env
+0001f9d0: 2054 4553 545f 454e 563d 2268 656c 6c6f   TEST_ENV="hello
+0001f9e0: 2077 6f72 6c64 2220 2d2d 2022 285b 5b20   world" -- "([[ 
+0001f9f0: 2120 2d7a 205c 5c22 5c24 5445 5354 5f45  ! -z \\"\$TEST_E
+0001fa00: 4e56 5c5c 2220 5d5d 2026 2620 5b5b 2021  NV\\" ]] && [[ !
+0001fa10: 202d 7a20 5c5c 225c 2453 4b59 5049 4c4f   -z \\"\$SKYPILO
+0001fa20: 545f 4e4f 4445 5f49 5053 5c5c 2220 5d5d  T_NODE_IPS\\" ]]
+0001fa30: 2026 2620 5b5b 2021 202d 7a20 5c5c 225c   && [[ ! -z \\"\
+0001fa40: 2453 4b59 5049 4c4f 545f 4e4f 4445 5f52  $SKYPILOT_NODE_R
+0001fa50: 414e 4b5c 5c22 205d 5d29 207c 7c20 6578  ANK\\" ]]) || ex
+0001fa60: 6974 2031 2227 2c0a 2020 2020 2020 2020  it 1"',.        
+0001fa70: 2020 2020 6627 736b 7920 6c6f 6773 207b      f'sky logs {
+0001fa80: 6e61 6d65 7d20 3120 2d2d 7374 6174 7573  name} 1 --status
+0001fa90: 272c 0a20 2020 2020 2020 2020 2020 2066  ',.            f
+0001faa0: 2773 6b79 2065 7865 6320 7b6e 616d 657d  'sky exec {name}
+0001fab0: 202d 2d65 6e76 2d66 696c 6520 6578 616d   --env-file exam
+0001fac0: 706c 6573 2f73 616d 706c 655f 646f 7465  ples/sample_dote
+0001fad0: 6e76 2022 285b 5b20 2120 2d7a 205c 5c22  nv "([[ ! -z \\"
+0001fae0: 5c24 5445 5354 5f45 4e56 325c 5c22 205d  \$TEST_ENV2\\" ]
+0001faf0: 5d20 2626 205b 5b20 2120 2d7a 205c 5c22  ] && [[ ! -z \\"
+0001fb00: 5c24 534b 5950 494c 4f54 5f4e 4f44 455f  \$SKYPILOT_NODE_
+0001fb10: 4950 535c 5c22 205d 5d20 2626 205b 5b20  IPS\\" ]] && [[ 
+0001fb20: 2120 2d7a 205c 5c22 5c24 534b 5950 494c  ! -z \\"\$SKYPIL
+0001fb30: 4f54 5f4e 4f44 455f 5241 4e4b 5c5c 2220  OT_NODE_RANK\\" 
+0001fb40: 5d5d 2920 7c7c 2065 7869 7420 3122 272c  ]]) || exit 1"',
+0001fb50: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0001fb60: 6b79 206c 6f67 7320 7b6e 616d 657d 2032  ky logs {name} 2
+0001fb70: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+0001fb80: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+0001fb90: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+0001fba0: 6d65 7d27 2c0a 2020 2020 2020 2020 5f67  me}',.        _g
+0001fbb0: 6574 5f74 696d 656f 7574 2867 656e 6572  et_timeout(gener
+0001fbc0: 6963 5f63 6c6f 7564 292c 0a20 2020 2029  ic_cloud),.    )
+0001fbd0: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+0001fbe0: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
+0001fbf0: 2d2d 2d2d 2d2d 2054 6573 7469 6e67 2063  ------ Testing c
+0001fc00: 7573 746f 6d20 696d 6167 6520 2d2d 2d2d  ustom image ----
+0001fc10: 2d2d 2d2d 2d2d 0a40 7079 7465 7374 2e6d  ------.@pytest.m
+0001fc20: 6172 6b2e 6177 730a 6465 6620 7465 7374  ark.aws.def test
+0001fc30: 5f61 7773 5f63 7573 746f 6d5f 696d 6167  _aws_custom_imag
+0001fc40: 6528 293a 0a20 2020 2022 2222 5465 7374  e():.    """Test
+0001fc50: 2041 5753 2063 7573 746f 6d20 696d 6167   AWS custom imag
+0001fc60: 6522 2222 0a20 2020 206e 616d 6520 3d20  e""".    name = 
+0001fc70: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+0001fc80: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
+0001fc90: 6573 7428 0a20 2020 2020 2020 2027 7465  est(.        'te
+0001fca0: 7374 2d61 7773 2d63 7573 746f 6d2d 696d  st-aws-custom-im
+0001fcb0: 6167 6527 2c0a 2020 2020 2020 2020 5b0a  age',.        [.
+0001fcc0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+0001fcd0: 7920 6c61 756e 6368 202d 6320 7b6e 616d  y launch -c {nam
+0001fce0: 657d 202d 2d72 6574 7279 2d75 6e74 696c  e} --retry-until
+0001fcf0: 2d75 7020 2d79 2074 6573 7473 2f74 6573  -up -y tests/tes
+0001fd00: 745f 7961 6d6c 732f 7465 7374 5f63 7573  t_yamls/test_cus
+0001fd10: 746f 6d5f 696d 6167 652e 7961 6d6c 202d  tom_image.yaml -
+0001fd20: 2d63 6c6f 7564 2061 7773 202d 2d72 6567  -cloud aws --reg
+0001fd30: 696f 6e20 7573 2d65 6173 742d 3220 2d2d  ion us-east-2 --
+0001fd40: 696d 6167 652d 6964 2061 6d69 2d30 3632  image-id ami-062
+0001fd50: 6464 6439 3066 6236 6638 3236 3761 272c  ddd90fb6f8267a',
+0001fd60: 2020 2320 4e76 6964 6961 2069 6d61 6765    # Nvidia image
+0001fd70: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+0001fd80: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
+0001fd90: 202d 2d73 7461 7475 7327 2c0a 2020 2020   --status',.    
+0001fda0: 2020 2020 5d2c 0a20 2020 2020 2020 2066      ],.        f
+0001fdb0: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+0001fdc0: 6d65 7d27 2c0a 2020 2020 2020 2020 7469  me}',.        ti
+0001fdd0: 6d65 6f75 743d 3330 202a 2036 302c 0a20  meout=30 * 60,. 
+0001fde0: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+0001fdf0: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
+0001fe00: 7974 6573 742e 6d61 726b 2e6b 7562 6572  ytest.mark.kuber
+0001fe10: 6e65 7465 730a 4070 7974 6573 742e 6d61  netes.@pytest.ma
+0001fe20: 726b 2e70 6172 616d 6574 7269 7a65 280a  rk.parametrize(.
+0001fe30: 2020 2020 2769 6d61 6765 5f69 6427 2c0a      'image_id',.
+0001fe40: 2020 2020 5b0a 2020 2020 2020 2020 2764      [.        'd
+0001fe50: 6f63 6b65 723a 6e76 6964 6961 2f63 7564  ocker:nvidia/cud
+0001fe60: 613a 3131 2e38 2e30 2d64 6576 656c 2d75  a:11.8.0-devel-u
+0001fe70: 6275 6e74 7531 382e 3034 272c 0a20 2020  buntu18.04',.   
+0001fe80: 2020 2020 2027 646f 636b 6572 3a75 6275       'docker:ubu
+0001fe90: 6e74 753a 3138 2e30 3427 2c0a 2020 2020  ntu:18.04',.    
+0001fea0: 2020 2020 2320 5465 7374 206c 6174 6573      # Test lates
+0001feb0: 7420 696d 6167 6520 7769 7468 2070 7974  t image with pyt
+0001fec0: 686f 6e20 332e 3131 2069 6e73 7461 6c6c  hon 3.11 install
+0001fed0: 6564 2062 7920 6465 6661 756c 742e 0a20  ed by default.. 
+0001fee0: 2020 2020 2020 2027 646f 636b 6572 3a63         'docker:c
+0001fef0: 6f6e 7469 6e75 756d 696f 2f6d 696e 6963  ontinuumio/minic
+0001ff00: 6f6e 6461 333a 3234 2e31 2e32 2d30 272c  onda3:24.1.2-0',
+0001ff10: 0a20 2020 2020 2020 2023 2054 6573 7420  .        # Test 
+0001ff20: 7079 7468 6f6e 3e3d 332e 3132 2077 6865  python>=3.12 whe
+0001ff30: 7265 2053 6b79 5069 6c6f 7420 7368 6f75  re SkyPilot shou
+0001ff40: 6c64 2061 7574 6f6d 6174 6963 616c 6c79  ld automatically
+0001ff50: 2063 7265 6174 6520 6120 7365 7061 7261   create a separa
+0001ff60: 7465 0a20 2020 2020 2020 2023 2063 6f6e  te.        # con
+0001ff70: 6461 2065 6e76 2066 6f72 2072 756e 7469  da env for runti
+0001ff80: 6d65 2077 6974 6820 7079 7468 6f6e 2033  me with python 3
+0001ff90: 2e31 302e 0a20 2020 2020 2020 2027 646f  .10..        'do
+0001ffa0: 636b 6572 3a63 6f6e 7469 6e75 756d 696f  cker:continuumio
+0001ffb0: 2f6d 696e 6963 6f6e 6461 333a 6c61 7465  /miniconda3:late
+0001ffc0: 7374 272c 0a20 2020 205d 290a 6465 6620  st',.    ]).def 
+0001ffd0: 7465 7374 5f6b 7562 6572 6e65 7465 735f  test_kubernetes_
+0001ffe0: 6375 7374 6f6d 5f69 6d61 6765 2869 6d61  custom_image(ima
+0001fff0: 6765 5f69 6429 3a0a 2020 2020 2222 2254  ge_id):.    """T
+00020000: 6573 7420 4b75 6265 726e 6574 6573 2063  est Kubernetes c
+00020010: 7573 746f 6d20 696d 6167 6522 2222 0a20  ustom image""". 
+00020020: 2020 206e 616d 6520 3d20 5f67 6574 5f63     name = _get_c
+00020030: 6c75 7374 6572 5f6e 616d 6528 290a 2020  luster_name().  
+00020040: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+00020050: 2020 2020 2020 2027 7465 7374 2d6b 7562         'test-kub
+00020060: 6572 6e65 7465 732d 6375 7374 6f6d 2d69  ernetes-custom-i
+00020070: 6d61 6765 272c 0a20 2020 2020 2020 205b  mage',.        [
+00020080: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00020090: 6b79 206c 6175 6e63 6820 2d63 207b 6e61  ky launch -c {na
+000200a0: 6d65 7d20 2d2d 7265 7472 792d 756e 7469  me} --retry-unti
+000200b0: 6c2d 7570 202d 7920 7465 7374 732f 7465  l-up -y tests/te
+000200c0: 7374 5f79 616d 6c73 2f74 6573 745f 6375  st_yamls/test_cu
+000200d0: 7374 6f6d 5f69 6d61 6765 2e79 616d 6c20  stom_image.yaml 
+000200e0: 2d2d 636c 6f75 6420 6b75 6265 726e 6574  --cloud kubernet
+000200f0: 6573 202d 2d69 6d61 6765 2d69 6420 7b69  es --image-id {i
+00020100: 6d61 6765 5f69 647d 202d 2d72 6567 696f  mage_id} --regio
+00020110: 6e20 4e6f 6e65 202d 2d67 7075 7320 5434  n None --gpus T4
+00020120: 3a31 272c 0a20 2020 2020 2020 2020 2020  :1',.           
+00020130: 2066 2773 6b79 206c 6f67 7320 7b6e 616d   f'sky logs {nam
+00020140: 657d 2031 202d 2d73 7461 7475 7327 2c0a  e} 1 --status',.
+00020150: 2020 2020 2020 2020 2020 2020 2320 5472              # Tr
+00020160: 7920 6578 6563 2074 6f20 7275 6e20 6167  y exec to run ag
+00020170: 6169 6e20 616e 6420 6368 6563 6b20 6966  ain and check if
+00020180: 2074 6865 206c 6f67 7320 6172 6520 7072   the logs are pr
+00020190: 696e 7465 640a 2020 2020 2020 2020 2020  inted.          
+000201a0: 2020 6627 736b 7920 6578 6563 207b 6e61    f'sky exec {na
+000201b0: 6d65 7d20 7465 7374 732f 7465 7374 5f79  me} tests/test_y
+000201c0: 616d 6c73 2f74 6573 745f 6375 7374 6f6d  amls/test_custom
+000201d0: 5f69 6d61 6765 2e79 616d 6c20 2d2d 636c  _image.yaml --cl
+000201e0: 6f75 6420 6b75 6265 726e 6574 6573 202d  oud kubernetes -
+000201f0: 2d69 6d61 6765 2d69 6420 7b69 6d61 6765  -image-id {image
+00020200: 5f69 647d 202d 2d72 6567 696f 6e20 4e6f  _id} --region No
+00020210: 6e65 202d 2d67 7075 7320 5434 3a31 207c  ne --gpus T4:1 |
+00020220: 2067 7265 7020 2248 656c 6c6f 2031 3030   grep "Hello 100
+00020230: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+00020240: 2320 4d61 6b65 2073 7572 6520 7373 6820  # Make sure ssh 
+00020250: 6973 2077 6f72 6b69 6e67 2077 6974 6820  is working with 
+00020260: 6375 7374 6f6d 2075 7365 726e 616d 650a  custom username.
+00020270: 2020 2020 2020 2020 2020 2020 6627 7373              f'ss
+00020280: 6820 7b6e 616d 657d 2065 6368 6f20 6869  h {name} echo hi
+00020290: 207c 2067 7265 7020 6869 272c 0a20 2020   | grep hi',.   
+000202a0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+000202b0: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
+000202c0: 616d 657d 272c 0a20 2020 2020 2020 2074  ame}',.        t
+000202d0: 696d 656f 7574 3d33 3020 2a20 3630 2c0a  imeout=30 * 60,.
+000202e0: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+000202f0: 655f 7465 7374 2874 6573 7429 0a0a 0a40  e_test(test)...@
+00020300: 7079 7465 7374 2e6d 6172 6b2e 736c 6f77  pytest.mark.slow
+00020310: 0a64 6566 2074 6573 745f 617a 7572 655f  .def test_azure_
+00020320: 7374 6172 745f 7374 6f70 5f74 776f 5f6e  start_stop_two_n
+00020330: 6f64 6573 2829 3a0a 2020 2020 6e61 6d65  odes():.    name
+00020340: 203d 205f 6765 745f 636c 7573 7465 725f   = _get_cluster_
+00020350: 6e61 6d65 2829 0a20 2020 2074 6573 7420  name().    test 
+00020360: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+00020370: 2761 7a75 7265 2d73 7461 7274 2d73 746f  'azure-start-sto
+00020380: 702d 7477 6f2d 6e6f 6465 7327 2c0a 2020  p-two-nodes',.  
+00020390: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+000203a0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+000203b0: 202d 2d6e 756d 2d6e 6f64 6573 3d32 202d   --num-nodes=2 -
+000203c0: 7920 2d63 207b 6e61 6d65 7d20 6578 616d  y -c {name} exam
+000203d0: 706c 6573 2f61 7a75 7265 5f73 7461 7274  ples/azure_start
+000203e0: 5f73 746f 702e 7961 6d6c 272c 0a20 2020  _stop.yaml',.   
+000203f0: 2020 2020 2020 2020 2066 2773 6b79 2065           f'sky e
+00020400: 7865 6320 2d2d 6e75 6d2d 6e6f 6465 733d  xec --num-nodes=
+00020410: 3220 7b6e 616d 657d 2065 7861 6d70 6c65  2 {name} example
+00020420: 732f 617a 7572 655f 7374 6172 745f 7374  s/azure_start_st
+00020430: 6f70 2e79 616d 6c27 2c0a 2020 2020 2020  op.yaml',.      
+00020440: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+00020450: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
+00020460: 7573 272c 2020 2320 456e 7375 7265 2074  us',  # Ensure t
+00020470: 6865 206a 6f62 2073 7563 6365 6564 6564  he job succeeded
+00020480: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00020490: 736b 7920 7374 6f70 202d 7920 7b6e 616d  sky stop -y {nam
+000204a0: 657d 272c 0a20 2020 2020 2020 2020 2020  e}',.           
+000204b0: 2066 2773 6b79 2073 7461 7274 202d 7920   f'sky start -y 
+000204c0: 7b6e 616d 657d 202d 6920 3127 2c0a 2020  {name} -i 1',.  
+000204d0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+000204e0: 6578 6563 202d 2d6e 756d 2d6e 6f64 6573  exec --num-nodes
+000204f0: 3d32 207b 6e61 6d65 7d20 6578 616d 706c  =2 {name} exampl
+00020500: 6573 2f61 7a75 7265 5f73 7461 7274 5f73  es/azure_start_s
+00020510: 746f 702e 7961 6d6c 272c 0a20 2020 2020  top.yaml',.     
+00020520: 2020 2020 2020 2066 2773 6b79 206c 6f67         f'sky log
+00020530: 7320 7b6e 616d 657d 2032 202d 2d73 7461  s {name} 2 --sta
+00020540: 7475 7327 2c20 2023 2045 6e73 7572 6520  tus',  # Ensure 
+00020550: 7468 6520 6a6f 6220 7375 6363 6565 6465  the job succeede
+00020560: 642e 0a20 2020 2020 2020 2020 2020 2027  d..            '
+00020570: 736c 6565 7020 3230 3027 2c0a 2020 2020  sleep 200',.    
+00020580: 2020 2020 2020 2020 6627 733d 2428 736b          f's=$(sk
+00020590: 7920 7374 6174 7573 202d 7220 7b6e 616d  y status -r {nam
+000205a0: 657d 2920 2626 2065 6368 6f20 2224 7322  e}) && echo "$s"
+000205b0: 2026 2620 6563 686f 2022 2473 2220 7c20   && echo "$s" | 
+000205c0: 6772 6570 2022 494e 4954 5c7c 5354 4f50  grep "INIT\|STOP
+000205d0: 5045 4422 270a 2020 2020 2020 2020 2020  PED"'.          
+000205e0: 2020 6627 7c7c 207b 7b20 7373 6820 7b6e    f'|| {{ ssh {n
+000205f0: 616d 657d 2022 6361 7420 7e2f 2e73 6b79  ame} "cat ~/.sky
+00020600: 2f73 6b79 6c65 742e 6c6f 6722 3b20 6578  /skylet.log"; ex
+00020610: 6974 2031 3b20 7d7d 270a 2020 2020 2020  it 1; }}'.      
+00020620: 2020 5d2c 0a20 2020 2020 2020 2066 2773    ],.        f's
+00020630: 6b79 2064 6f77 6e20 2d79 207b 6e61 6d65  ky down -y {name
+00020640: 7d27 2c0a 2020 2020 2020 2020 7469 6d65  }',.        time
+00020650: 6f75 743d 3330 202a 2036 302c 2020 2320  out=30 * 60,  # 
+00020660: 3330 206d 696e 7320 2028 6974 2074 616b  30 mins  (it tak
+00020670: 6573 2061 726f 756e 6420 7e32 3320 6d69  es around ~23 mi
+00020680: 6e73 290a 2020 2020 290a 2020 2020 7275  ns).    ).    ru
+00020690: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+000206a0: 0a0a 0a23 202d 2d2d 2d2d 2d2d 2d2d 2d20  ...# ---------- 
+000206b0: 5465 7374 696e 6720 656e 7620 666f 7220  Testing env for 
+000206c0: 6469 736b 2074 6965 7220 2d2d 2d2d 2d2d  disk tier ------
+000206d0: 2d2d 2d2d 0a40 7079 7465 7374 2e6d 6172  ----.@pytest.mar
+000206e0: 6b2e 6177 730a 6465 6620 7465 7374 5f61  k.aws.def test_a
+000206f0: 7773 5f64 6973 6b5f 7469 6572 2829 3a0a  ws_disk_tier():.
+00020700: 0a20 2020 2064 6566 205f 6765 745f 6177  .    def _get_aw
+00020710: 735f 7175 6572 795f 636f 6d6d 616e 6428  s_query_command(
+00020720: 7265 6769 6f6e 2c20 696e 7374 616e 6365  region, instance
+00020730: 5f69 642c 2066 6965 6c64 2c20 6578 7065  _id, field, expe
+00020740: 6374 6564 293a 0a20 2020 2020 2020 2072  cted):.        r
+00020750: 6574 7572 6e20 2866 2761 7773 2065 6332  eturn (f'aws ec2
+00020760: 2064 6573 6372 6962 652d 766f 6c75 6d65   describe-volume
+00020770: 7320 2d2d 7265 6769 6f6e 207b 7265 6769  s --region {regi
+00020780: 6f6e 7d20 270a 2020 2020 2020 2020 2020  on} '.          
+00020790: 2020 2020 2020 6627 2d2d 6669 6c74 6572        f'--filter
+000207a0: 7320 4e61 6d65 3d61 7474 6163 686d 656e  s Name=attachmen
+000207b0: 742e 696e 7374 616e 6365 2d69 642c 5661  t.instance-id,Va
+000207c0: 6c75 6573 3d7b 696e 7374 616e 6365 5f69  lues={instance_i
+000207d0: 647d 2027 0a20 2020 2020 2020 2020 2020  d} '.           
+000207e0: 2020 2020 2066 272d 2d71 7565 7279 2056       f'--query V
+000207f0: 6f6c 756d 6573 5b2a 5d2e 7b66 6965 6c64  olumes[*].{field
+00020800: 7d20 7c20 6772 6570 207b 6578 7065 6374  } | grep {expect
+00020810: 6564 7d20 3b20 2729 0a0a 2020 2020 666f  ed} ; ')..    fo
+00020820: 7220 6469 736b 5f74 6965 7220 696e 206c  r disk_tier in l
+00020830: 6973 7428 7265 736f 7572 6365 735f 7574  ist(resources_ut
+00020840: 696c 732e 4469 736b 5469 6572 293a 0a20  ils.DiskTier):. 
+00020850: 2020 2020 2020 2073 7065 6373 203d 2041         specs = A
+00020860: 5753 2e5f 6765 745f 6469 736b 5f73 7065  WS._get_disk_spe
+00020870: 6373 2864 6973 6b5f 7469 6572 290a 2020  cs(disk_tier).  
+00020880: 2020 2020 2020 6e61 6d65 203d 205f 6765        name = _ge
+00020890: 745f 636c 7573 7465 725f 6e61 6d65 2829  t_cluster_name()
+000208a0: 202b 2027 2d27 202b 2064 6973 6b5f 7469   + '-' + disk_ti
+000208b0: 6572 2e76 616c 7565 0a20 2020 2020 2020  er.value.       
+000208c0: 206e 616d 655f 6f6e 5f63 6c6f 7564 203d   name_on_cloud =
+000208d0: 2063 6f6d 6d6f 6e5f 7574 696c 732e 6d61   common_utils.ma
+000208e0: 6b65 5f63 6c75 7374 6572 5f6e 616d 655f  ke_cluster_name_
+000208f0: 6f6e 5f63 6c6f 7564 280a 2020 2020 2020  on_cloud(.      
+00020900: 2020 2020 2020 6e61 6d65 2c20 736b 792e        name, sky.
+00020910: 4157 532e 6d61 785f 636c 7573 7465 725f  AWS.max_cluster_
+00020920: 6e61 6d65 5f6c 656e 6774 6828 2929 0a20  name_length()). 
+00020930: 2020 2020 2020 2072 6567 696f 6e20 3d20         region = 
+00020940: 2775 732d 6561 7374 2d32 270a 2020 2020  'us-east-2'.    
+00020950: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+00020960: 0a20 2020 2020 2020 2020 2020 2027 6177  .            'aw
+00020970: 732d 6469 736b 2d74 6965 722d 2720 2b20  s-disk-tier-' + 
+00020980: 6469 736b 5f74 6965 722e 7661 6c75 652c  disk_tier.value,
+00020990: 0a20 2020 2020 2020 2020 2020 205b 0a20  .            [. 
+000209a0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000209b0: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+000209c0: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
+000209d0: 2061 7773 202d 2d72 6567 696f 6e20 7b72   aws --region {r
+000209e0: 6567 696f 6e7d 2027 0a20 2020 2020 2020  egion} '.       
+000209f0: 2020 2020 2020 2020 2066 272d 2d64 6973           f'--dis
+00020a00: 6b2d 7469 6572 207b 6469 736b 5f74 6965  k-tier {disk_tie
+00020a10: 722e 7661 6c75 657d 2065 6368 6f20 2268  r.value} echo "h
+00020a20: 656c 6c6f 2073 6b79 2227 2c0a 2020 2020  ello sky"',.    
+00020a30: 2020 2020 2020 2020 2020 2020 6627 6964              f'id
+00020a40: 3d60 6177 7320 6563 3220 6465 7363 7269  =`aws ec2 descri
+00020a50: 6265 2d69 6e73 7461 6e63 6573 202d 2d72  be-instances --r
+00020a60: 6567 696f 6e20 7b72 6567 696f 6e7d 202d  egion {region} -
+00020a70: 2d66 696c 7465 7273 2027 0a20 2020 2020  -filters '.     
+00020a80: 2020 2020 2020 2020 2020 2066 274e 616d             f'Nam
+00020a90: 653d 7461 673a 7261 792d 636c 7573 7465  e=tag:ray-cluste
+00020aa0: 722d 6e61 6d65 2c56 616c 7565 733d 7b6e  r-name,Values={n
+00020ab0: 616d 655f 6f6e 5f63 6c6f 7564 7d20 2d2d  ame_on_cloud} --
+00020ac0: 7175 6572 7920 270a 2020 2020 2020 2020  query '.        
+00020ad0: 2020 2020 2020 2020 6627 5265 7365 7276          f'Reserv
+00020ae0: 6174 696f 6e73 5b5d 2e49 6e73 7461 6e63  ations[].Instanc
+00020af0: 6573 5b5d 2e49 6e73 7461 6e63 6549 6420  es[].InstanceId 
+00020b00: 2d2d 6f75 7470 7574 2074 6578 7460 3b20  --output text`; 
+00020b10: 2720 2b0a 2020 2020 2020 2020 2020 2020  ' +.            
+00020b20: 2020 2020 5f67 6574 5f61 7773 5f71 7565      _get_aws_que
+00020b30: 7279 5f63 6f6d 6d61 6e64 2872 6567 696f  ry_command(regio
+00020b40: 6e2c 2027 2469 6427 2c20 2756 6f6c 756d  n, '$id', 'Volum
+00020b50: 6554 7970 6527 2c0a 2020 2020 2020 2020  eType',.        
+00020b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020b70: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00020b80: 7065 6373 5b27 6469 736b 5f74 6965 7227  pecs['disk_tier'
+00020b90: 5d29 202b 0a20 2020 2020 2020 2020 2020  ]) +.           
+00020ba0: 2020 2020 2028 2727 2069 6620 6469 736b       ('' if disk
+00020bb0: 5f74 6965 7220 3d3d 2072 6573 6f75 7263  _tier == resourc
+00020bc0: 6573 5f75 7469 6c73 2e44 6973 6b54 6965  es_utils.DiskTie
+00020bd0: 722e 4c4f 5720 656c 7365 0a20 2020 2020  r.LOW else.     
+00020be0: 2020 2020 2020 2020 2020 2020 285f 6765              (_ge
+00020bf0: 745f 6177 735f 7175 6572 795f 636f 6d6d  t_aws_query_comm
+00020c00: 616e 6428 7265 6769 6f6e 2c20 2724 6964  and(region, '$id
+00020c10: 272c 2027 496f 7073 272c 0a20 2020 2020  ', 'Iops',.     
+00020c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020c40: 2020 2020 7370 6563 735b 2764 6973 6b5f      specs['disk_
+00020c50: 696f 7073 275d 2920 2b0a 2020 2020 2020  iops']) +.      
+00020c60: 2020 2020 2020 2020 2020 2020 5f67 6574              _get
+00020c70: 5f61 7773 5f71 7565 7279 5f63 6f6d 6d61  _aws_query_comma
+00020c80: 6e64 2872 6567 696f 6e2c 2027 2469 6427  nd(region, '$id'
+00020c90: 2c20 2754 6872 6f75 6768 7075 7427 2c0a  , 'Throughput',.
+00020ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020cc0: 2020 2020 2020 2020 2073 7065 6373 5b27           specs['
+00020cd0: 6469 736b 5f74 6872 6f75 6768 7075 7427  disk_throughput'
+00020ce0: 5d29 2929 2c0a 2020 2020 2020 2020 2020  ]))),.          
+00020cf0: 2020 5d2c 0a20 2020 2020 2020 2020 2020    ],.           
+00020d00: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+00020d10: 6e61 6d65 7d27 2c0a 2020 2020 2020 2020  name}',.        
+00020d20: 2020 2020 7469 6d65 6f75 743d 3130 202a      timeout=10 *
+00020d30: 2036 302c 2020 2320 3130 206d 696e 7320   60,  # 10 mins 
+00020d40: 2028 6974 2074 616b 6573 2061 726f 756e   (it takes aroun
+00020d50: 6420 7e36 206d 696e 7329 0a20 2020 2020  d ~6 mins).     
+00020d60: 2020 2029 0a20 2020 2020 2020 2072 756e     ).        run
+00020d70: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+00020d80: 0a0a 4070 7974 6573 742e 6d61 726b 2e67  ..@pytest.mark.g
+00020d90: 6370 0a64 6566 2074 6573 745f 6763 705f  cp.def test_gcp_
+00020da0: 6469 736b 5f74 6965 7228 293a 0a20 2020  disk_tier():.   
+00020db0: 2066 6f72 2064 6973 6b5f 7469 6572 2069   for disk_tier i
+00020dc0: 6e20 6c69 7374 2872 6573 6f75 7263 6573  n list(resources
+00020dd0: 5f75 7469 6c73 2e44 6973 6b54 6965 7229  _utils.DiskTier)
+00020de0: 3a0a 2020 2020 2020 2020 7479 7065 203d  :.        type =
+00020df0: 2047 4350 2e5f 6765 745f 6469 736b 5f74   GCP._get_disk_t
+00020e00: 7970 6528 6469 736b 5f74 6965 7229 0a20  ype(disk_tier). 
+00020e10: 2020 2020 2020 206e 616d 6520 3d20 5f67         name = _g
+00020e20: 6574 5f63 6c75 7374 6572 5f6e 616d 6528  et_cluster_name(
+00020e30: 2920 2b20 272d 2720 2b20 6469 736b 5f74  ) + '-' + disk_t
+00020e40: 6965 722e 7661 6c75 650a 2020 2020 2020  ier.value.      
+00020e50: 2020 6e61 6d65 5f6f 6e5f 636c 6f75 6420    name_on_cloud 
+00020e60: 3d20 636f 6d6d 6f6e 5f75 7469 6c73 2e6d  = common_utils.m
+00020e70: 616b 655f 636c 7573 7465 725f 6e61 6d65  ake_cluster_name
+00020e80: 5f6f 6e5f 636c 6f75 6428 0a20 2020 2020  _on_cloud(.     
+00020e90: 2020 2020 2020 206e 616d 652c 2073 6b79         name, sky
+00020ea0: 2e47 4350 2e6d 6178 5f63 6c75 7374 6572  .GCP.max_cluster
+00020eb0: 5f6e 616d 655f 6c65 6e67 7468 2829 290a  _name_length()).
+00020ec0: 2020 2020 2020 2020 7265 6769 6f6e 203d          region =
+00020ed0: 2027 7573 2d77 6573 7432 270a 2020 2020   'us-west2'.    
+00020ee0: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+00020ef0: 0a20 2020 2020 2020 2020 2020 2027 6763  .            'gc
+00020f00: 702d 6469 736b 2d74 6965 722d 2720 2b20  p-disk-tier-' + 
+00020f10: 6469 736b 5f74 6965 722e 7661 6c75 652c  disk_tier.value,
+00020f20: 0a20 2020 2020 2020 2020 2020 205b 0a20  .            [. 
+00020f30: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00020f40: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+00020f50: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
+00020f60: 2067 6370 202d 2d72 6567 696f 6e20 7b72   gcp --region {r
+00020f70: 6567 696f 6e7d 2027 0a20 2020 2020 2020  egion} '.       
+00020f80: 2020 2020 2020 2020 2066 272d 2d64 6973           f'--dis
+00020f90: 6b2d 7469 6572 207b 6469 736b 5f74 6965  k-tier {disk_tie
+00020fa0: 722e 7661 6c75 657d 2065 6368 6f20 2268  r.value} echo "h
+00020fb0: 656c 6c6f 2073 6b79 2227 2c0a 2020 2020  ello sky"',.    
+00020fc0: 2020 2020 2020 2020 2020 2020 6627 6e61              f'na
+00020fd0: 6d65 3d60 6763 6c6f 7564 2063 6f6d 7075  me=`gcloud compu
+00020fe0: 7465 2069 6e73 7461 6e63 6573 206c 6973  te instances lis
+00020ff0: 7420 2d2d 6669 6c74 6572 3d27 0a20 2020  t --filter='.   
+00021000: 2020 2020 2020 2020 2020 2020 2066 2722               f'"
+00021010: 6c61 6265 6c73 2e72 6179 2d63 6c75 7374  labels.ray-clust
+00021020: 6572 2d6e 616d 653a 7b6e 616d 655f 6f6e  er-name:{name_on
+00021030: 5f63 6c6f 7564 7d22 2027 0a20 2020 2020  _cloud}" '.     
+00021040: 2020 2020 2020 2020 2020 2027 2d2d 666f             '--fo
+00021050: 726d 6174 3d22 7661 6c75 6528 6e61 6d65  rmat="value(name
+00021060: 2922 603b 2027 0a20 2020 2020 2020 2020  )"`; '.         
+00021070: 2020 2020 2020 2066 2767 636c 6f75 6420         f'gcloud 
+00021080: 636f 6d70 7574 6520 6469 736b 7320 6c69  compute disks li
+00021090: 7374 202d 2d66 696c 7465 723d 226e 616d  st --filter="nam
+000210a0: 653d 246e 616d 6522 2027 0a20 2020 2020  e=$name" '.     
+000210b0: 2020 2020 2020 2020 2020 2066 272d 2d66             f'--f
+000210c0: 6f72 6d61 743d 2276 616c 7565 2874 7970  ormat="value(typ
+000210d0: 6529 2220 7c20 6772 6570 207b 7479 7065  e)" | grep {type
+000210e0: 7d20 270a 2020 2020 2020 2020 2020 2020  } '.            
+000210f0: 5d2c 0a20 2020 2020 2020 2020 2020 2066  ],.            f
+00021100: 2773 6b79 2064 6f77 6e20 2d79 207b 6e61  'sky down -y {na
+00021110: 6d65 7d27 2c0a 2020 2020 2020 2020 2020  me}',.          
+00021120: 2020 7469 6d65 6f75 743d 3620 2a20 3630    timeout=6 * 60
+00021130: 2c20 2023 2036 206d 696e 7320 2028 6974  ,  # 6 mins  (it
+00021140: 2074 616b 6573 2061 726f 756e 6420 7e33   takes around ~3
+00021150: 206d 696e 7329 0a20 2020 2020 2020 2029   mins).        )
+00021160: 0a20 2020 2020 2020 2072 756e 5f6f 6e65  .        run_one
+00021170: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
+00021180: 7974 6573 742e 6d61 726b 2e61 7a75 7265  ytest.mark.azure
+00021190: 0a64 6566 2074 6573 745f 617a 7572 655f  .def test_azure_
+000211a0: 6469 736b 5f74 6965 7228 293a 0a20 2020  disk_tier():.   
+000211b0: 2066 6f72 2064 6973 6b5f 7469 6572 2069   for disk_tier i
+000211c0: 6e20 6c69 7374 2872 6573 6f75 7263 6573  n list(resources
+000211d0: 5f75 7469 6c73 2e44 6973 6b54 6965 7229  _utils.DiskTier)
+000211e0: 3a0a 2020 2020 2020 2020 6966 2064 6973  :.        if dis
+000211f0: 6b5f 7469 6572 203d 3d20 7265 736f 7572  k_tier == resour
+00021200: 6365 735f 7574 696c 732e 4469 736b 5469  ces_utils.DiskTi
+00021210: 6572 2e48 4947 483a 0a20 2020 2020 2020  er.HIGH:.       
+00021220: 2020 2020 2023 2041 7a75 7265 2064 6f65       # Azure doe
+00021230: 7320 6e6f 7420 7375 7070 6f72 7420 6869  s not support hi
+00021240: 6768 2064 6973 6b20 7469 6572 2e0a 2020  gh disk tier..  
+00021250: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
+00021260: 7565 0a20 2020 2020 2020 2074 7970 6520  ue.        type 
+00021270: 3d20 417a 7572 652e 5f67 6574 5f64 6973  = Azure._get_dis
+00021280: 6b5f 7479 7065 2864 6973 6b5f 7469 6572  k_type(disk_tier
+00021290: 290a 2020 2020 2020 2020 6e61 6d65 203d  ).        name =
+000212a0: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+000212b0: 6d65 2829 202b 2027 2d27 202b 2064 6973  me() + '-' + dis
+000212c0: 6b5f 7469 6572 2e76 616c 7565 0a20 2020  k_tier.value.   
+000212d0: 2020 2020 206e 616d 655f 6f6e 5f63 6c6f       name_on_clo
+000212e0: 7564 203d 2063 6f6d 6d6f 6e5f 7574 696c  ud = common_util
+000212f0: 732e 6d61 6b65 5f63 6c75 7374 6572 5f6e  s.make_cluster_n
+00021300: 616d 655f 6f6e 5f63 6c6f 7564 280a 2020  ame_on_cloud(.  
+00021310: 2020 2020 2020 2020 2020 6e61 6d65 2c20            name, 
+00021320: 736b 792e 417a 7572 652e 6d61 785f 636c  sky.Azure.max_cl
+00021330: 7573 7465 725f 6e61 6d65 5f6c 656e 6774  uster_name_lengt
+00021340: 6828 2929 0a20 2020 2020 2020 2072 6567  h()).        reg
+00021350: 696f 6e20 3d20 2777 6573 7475 7332 270a  ion = 'westus2'.
+00021360: 2020 2020 2020 2020 7465 7374 203d 2054          test = T
+00021370: 6573 7428 0a20 2020 2020 2020 2020 2020  est(.           
+00021380: 2027 617a 7572 652d 6469 736b 2d74 6965   'azure-disk-tie
+00021390: 722d 2720 2b20 6469 736b 5f74 6965 722e  r-' + disk_tier.
+000213a0: 7661 6c75 652c 0a20 2020 2020 2020 2020  value,.         
+000213b0: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+000213c0: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+000213d0: 6820 2d79 202d 6320 7b6e 616d 657d 202d  h -y -c {name} -
+000213e0: 2d63 6c6f 7564 2061 7a75 7265 202d 2d72  -cloud azure --r
+000213f0: 6567 696f 6e20 7b72 6567 696f 6e7d 2027  egion {region} '
+00021400: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021410: 2066 272d 2d64 6973 6b2d 7469 6572 207b   f'--disk-tier {
+00021420: 6469 736b 5f74 6965 722e 7661 6c75 657d  disk_tier.value}
+00021430: 2065 6368 6f20 2268 656c 6c6f 2073 6b79   echo "hello sky
+00021440: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+00021450: 2020 2020 6627 617a 2072 6573 6f75 7263      f'az resourc
+00021460: 6520 6c69 7374 202d 2d74 6167 2072 6179  e list --tag ray
+00021470: 2d63 6c75 7374 6572 2d6e 616d 653d 7b6e  -cluster-name={n
+00021480: 616d 655f 6f6e 5f63 6c6f 7564 7d20 2d2d  ame_on_cloud} --
+00021490: 7175 6572 7920 270a 2020 2020 2020 2020  query '.        
+000214a0: 2020 2020 2020 2020 6627 225b 3f74 7970          f'"[?typ
+000214b0: 653d 3d5c 274d 6963 726f 736f 6674 2e43  e==\'Microsoft.C
+000214c0: 6f6d 7075 7465 2f64 6973 6b73 5c27 5d2e  ompute/disks\'].
+000214d0: 736b 752e 6e61 6d65 2220 270a 2020 2020  sku.name" '.    
+000214e0: 2020 2020 2020 2020 2020 2020 6627 2d2d              f'--
+000214f0: 6f75 7470 7574 2074 7376 207c 2067 7265  output tsv | gre
+00021500: 7020 7b74 7970 657d 270a 2020 2020 2020  p {type}'.      
+00021510: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+00021520: 2020 2020 2066 2773 6b79 2064 6f77 6e20       f'sky down 
+00021530: 2d79 207b 6e61 6d65 7d27 2c0a 2020 2020  -y {name}',.    
+00021540: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
+00021550: 3230 202a 2036 302c 2020 2320 3230 206d  20 * 60,  # 20 m
+00021560: 696e 7320 2028 6974 2074 616b 6573 2061  ins  (it takes a
+00021570: 726f 756e 6420 7e31 3220 6d69 6e73 290a  round ~12 mins).
+00021580: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00021590: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+000215a0: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+000215b0: 6172 6b2e 617a 7572 650a 6465 6620 7465  ark.azure.def te
+000215c0: 7374 5f61 7a75 7265 5f62 6573 745f 7469  st_azure_best_ti
+000215d0: 6572 5f66 6169 6c6f 7665 7228 293a 0a20  er_failover():. 
+000215e0: 2020 2074 7970 6520 3d20 417a 7572 652e     type = Azure.
+000215f0: 5f67 6574 5f64 6973 6b5f 7479 7065 2872  _get_disk_type(r
+00021600: 6573 6f75 7263 6573 5f75 7469 6c73 2e44  esources_utils.D
+00021610: 6973 6b54 6965 722e 4c4f 5729 0a20 2020  iskTier.LOW).   
+00021620: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+00021630: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+00021640: 6e61 6d65 5f6f 6e5f 636c 6f75 6420 3d20  name_on_cloud = 
+00021650: 636f 6d6d 6f6e 5f75 7469 6c73 2e6d 616b  common_utils.mak
+00021660: 655f 636c 7573 7465 725f 6e61 6d65 5f6f  e_cluster_name_o
+00021670: 6e5f 636c 6f75 6428 0a20 2020 2020 2020  n_cloud(.       
+00021680: 206e 616d 652c 2073 6b79 2e41 7a75 7265   name, sky.Azure
+00021690: 2e6d 6178 5f63 6c75 7374 6572 5f6e 616d  .max_cluster_nam
+000216a0: 655f 6c65 6e67 7468 2829 290a 2020 2020  e_length()).    
+000216b0: 7265 6769 6f6e 203d 2027 7765 7374 7573  region = 'westus
+000216c0: 3227 0a20 2020 2074 6573 7420 3d20 5465  2'.    test = Te
+000216d0: 7374 280a 2020 2020 2020 2020 2761 7a75  st(.        'azu
+000216e0: 7265 2d62 6573 742d 7469 6572 2d66 6169  re-best-tier-fai
+000216f0: 6c6f 7665 7227 2c0a 2020 2020 2020 2020  lover',.        
+00021700: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+00021710: 736b 7920 6c61 756e 6368 202d 7920 2d63  sky launch -y -c
+00021720: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+00021730: 617a 7572 6520 2d2d 7265 6769 6f6e 207b  azure --region {
+00021740: 7265 6769 6f6e 7d20 270a 2020 2020 2020  region} '.      
+00021750: 2020 2020 2020 6627 2d2d 6469 736b 2d74        f'--disk-t
+00021760: 6965 7220 6265 7374 202d 2d69 6e73 7461  ier best --insta
+00021770: 6e63 652d 7479 7065 2053 7461 6e64 6172  nce-type Standar
+00021780: 645f 4438 5f76 3520 6563 686f 2022 6865  d_D8_v5 echo "he
+00021790: 6c6c 6f20 736b 7922 272c 0a20 2020 2020  llo sky"',.     
+000217a0: 2020 2020 2020 2066 2761 7a20 7265 736f         f'az reso
+000217b0: 7572 6365 206c 6973 7420 2d2d 7461 6720  urce list --tag 
+000217c0: 7261 792d 636c 7573 7465 722d 6e61 6d65  ray-cluster-name
+000217d0: 3d7b 6e61 6d65 5f6f 6e5f 636c 6f75 647d  ={name_on_cloud}
+000217e0: 202d 2d71 7565 7279 2027 0a20 2020 2020   --query '.     
+000217f0: 2020 2020 2020 2066 2722 5b3f 7479 7065         f'"[?type
+00021800: 3d3d 5c27 4d69 6372 6f73 6f66 742e 436f  ==\'Microsoft.Co
+00021810: 6d70 7574 652f 6469 736b 735c 275d 2e73  mpute/disks\'].s
+00021820: 6b75 2e6e 616d 6522 2027 0a20 2020 2020  ku.name" '.     
+00021830: 2020 2020 2020 2066 272d 2d6f 7574 7075         f'--outpu
+00021840: 7420 7473 7620 7c20 6772 6570 207b 7479  t tsv | grep {ty
+00021850: 7065 7d27 2c0a 2020 2020 2020 2020 5d2c  pe}',.        ],
+00021860: 0a20 2020 2020 2020 2066 2773 6b79 2064  .        f'sky d
+00021870: 6f77 6e20 2d79 207b 6e61 6d65 7d27 2c0a  own -y {name}',.
+00021880: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
+00021890: 3230 202a 2036 302c 2020 2320 3230 206d  20 * 60,  # 20 m
+000218a0: 696e 7320 2028 6974 2074 616b 6573 2061  ins  (it takes a
+000218b0: 726f 756e 6420 7e31 3220 6d69 6e73 290a  round ~12 mins).
+000218c0: 2020 2020 290a 2020 2020 7275 6e5f 6f6e      ).    run_on
+000218d0: 655f 7465 7374 2874 6573 7429 0a0a 0a23  e_test(test)...#
+000218e0: 202d 2d2d 2d2d 2d20 5465 7374 696e 6720   ------ Testing 
+000218f0: 5a65 726f 2051 756f 7461 2046 6169 6c6f  Zero Quota Failo
+00021900: 7665 7220 2d2d 2d2d 2d2d 0a40 7079 7465  ver ------.@pyte
+00021910: 7374 2e6d 6172 6b2e 6177 730a 6465 6620  st.mark.aws.def 
+00021920: 7465 7374 5f61 7773 5f7a 6572 6f5f 7175  test_aws_zero_qu
+00021930: 6f74 615f 6661 696c 6f76 6572 2829 3a0a  ota_failover():.
+00021940: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+00021950: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+00021960: 2020 2020 7265 6769 6f6e 203d 2067 6574      region = get
+00021970: 5f61 7773 5f72 6567 696f 6e5f 666f 725f  _aws_region_for_
+00021980: 7175 6f74 615f 6661 696c 6f76 6572 2829  quota_failover()
+00021990: 0a0a 2020 2020 6966 206e 6f74 2072 6567  ..    if not reg
+000219a0: 696f 6e3a 0a20 2020 2020 2020 2070 7974  ion:.        pyt
+000219b0: 6573 742e 7866 6169 6c28 0a20 2020 2020  est.xfail(.     
+000219c0: 2020 2020 2020 2027 556e 6162 6c65 2074         'Unable t
+000219d0: 6f20 7465 7374 207a 6572 6f20 7175 6f74  o test zero quot
+000219e0: 6120 6661 696c 6f76 6572 206f 7074 696d  a failover optim
+000219f0: 697a 6174 696f 6e20 e280 9420 7175 6f74  ization ... quot
+00021a00: 6173 2027 0a20 2020 2020 2020 2020 2020  as '.           
+00021a10: 2027 666f 7220 4543 3220 5033 2069 6e73   'for EC2 P3 ins
+00021a20: 7461 6e63 6573 2077 6572 6520 666f 756e  tances were foun
+00021a30: 6420 6f6e 2061 6c6c 2041 5753 2072 6567  d on all AWS reg
+00021a40: 696f 6e73 2e20 4973 2074 6869 7320 270a  ions. Is this '.
+00021a50: 2020 2020 2020 2020 2020 2020 2765 7870              'exp
+00021a60: 6563 7465 6420 666f 7220 796f 7572 2061  ected for your a
+00021a70: 6363 6f75 6e74 3f27 290a 2020 2020 2020  ccount?').      
+00021a80: 2020 7265 7475 726e 0a0a 2020 2020 7465    return..    te
+00021a90: 7374 203d 2054 6573 7428 0a20 2020 2020  st = Test(.     
+00021aa0: 2020 2027 6177 732d 7a65 726f 2d71 756f     'aws-zero-quo
+00021ab0: 7461 2d66 6169 6c6f 7665 7227 2c0a 2020  ta-failover',.  
+00021ac0: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+00021ad0: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+00021ae0: 202d 7920 2d63 207b 6e61 6d65 7d20 2d2d   -y -c {name} --
+00021af0: 636c 6f75 6420 6177 7320 2d2d 7265 6769  cloud aws --regi
+00021b00: 6f6e 207b 7265 6769 6f6e 7d20 2d2d 6770  on {region} --gp
+00021b10: 7573 2056 3130 303a 3820 2d2d 7573 652d  us V100:8 --use-
+00021b20: 7370 6f74 207c 2067 7265 7020 2246 6f75  spot | grep "Fou
+00021b30: 6e64 206e 6f20 7175 6f74 6122 272c 0a20  nd no quota"',. 
+00021b40: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00021b50: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+00021b60: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
+00021b70: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00021b80: 7465 7374 290a 0a0a 4070 7974 6573 742e  test)...@pytest.
+00021b90: 6d61 726b 2e67 6370 0a64 6566 2074 6573  mark.gcp.def tes
+00021ba0: 745f 6763 705f 7a65 726f 5f71 756f 7461  t_gcp_zero_quota
+00021bb0: 5f66 6169 6c6f 7665 7228 293a 0a0a 2020  _failover():..  
+00021bc0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+00021bd0: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+00021be0: 2072 6567 696f 6e20 3d20 6765 745f 6763   region = get_gc
+00021bf0: 705f 7265 6769 6f6e 5f66 6f72 5f71 756f  p_region_for_quo
+00021c00: 7461 5f66 6169 6c6f 7665 7228 290a 0a20  ta_failover().. 
+00021c10: 2020 2069 6620 6e6f 7420 7265 6769 6f6e     if not region
+00021c20: 3a0a 2020 2020 2020 2020 7079 7465 7374  :.        pytest
+00021c30: 2e78 6661 696c 280a 2020 2020 2020 2020  .xfail(.        
+00021c40: 2020 2020 2755 6e61 626c 6520 746f 2074      'Unable to t
+00021c50: 6573 7420 7a65 726f 2071 756f 7461 2066  est zero quota f
+00021c60: 6169 6c6f 7665 7220 6f70 7469 6d69 7a61  ailover optimiza
+00021c70: 7469 6f6e 20e2 8094 2071 756f 7461 7320  tion ... quotas 
+00021c80: 270a 2020 2020 2020 2020 2020 2020 2766  '.            'f
+00021c90: 6f72 2041 3130 302d 3830 4742 2047 5055  or A100-80GB GPU
+00021ca0: 7320 7765 7265 2066 6f75 6e64 206f 6e20  s were found on 
+00021cb0: 616c 6c20 4743 5020 7265 6769 6f6e 732e  all GCP regions.
+00021cc0: 2049 7320 7468 6973 2027 0a20 2020 2020   Is this '.     
+00021cd0: 2020 2020 2020 2027 6578 7065 6374 6564         'expected
+00021ce0: 2066 6f72 2079 6f75 7220 6163 636f 756e   for your accoun
+00021cf0: 743f 2729 0a20 2020 2020 2020 2072 6574  t?').        ret
+00021d00: 7572 6e0a 0a20 2020 2074 6573 7420 3d20  urn..    test = 
+00021d10: 5465 7374 280a 2020 2020 2020 2020 2767  Test(.        'g
+00021d20: 6370 2d7a 6572 6f2d 7175 6f74 612d 6661  cp-zero-quota-fa
+00021d30: 696c 6f76 6572 272c 0a20 2020 2020 2020  ilover',.       
+00021d40: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+00021d50: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+00021d60: 6320 7b6e 616d 657d 202d 2d63 6c6f 7564  c {name} --cloud
+00021d70: 2067 6370 202d 2d72 6567 696f 6e20 7b72   gcp --region {r
+00021d80: 6567 696f 6e7d 202d 2d67 7075 7320 4131  egion} --gpus A1
+00021d90: 3030 2d38 3047 423a 3120 2d2d 7573 652d  00-80GB:1 --use-
+00021da0: 7370 6f74 207c 2067 7265 7020 2246 6f75  spot | grep "Fou
+00021db0: 6e64 206e 6f20 7175 6f74 6122 272c 0a20  nd no quota"',. 
+00021dc0: 2020 2020 2020 205d 2c0a 2020 2020 2020         ],.      
+00021dd0: 2020 6627 736b 7920 646f 776e 202d 7920    f'sky down -y 
+00021de0: 7b6e 616d 657d 272c 0a20 2020 2029 0a20  {name}',.    ). 
+00021df0: 2020 2072 756e 5f6f 6e65 5f74 6573 7428     run_one_test(
+00021e00: 7465 7374 290a 0a0a 2320 2d2d 2d2d 2d2d  test)...# ------
+00021e10: 2d2d 2d2d 2054 6573 7469 6e67 2073 6b79  ---- Testing sky
+00021e20: 7365 7276 6520 2d2d 2d2d 2d2d 2d2d 2d2d  serve ----------
+00021e30: 0a0a 0a64 6566 205f 6765 745f 7365 7276  ...def _get_serv
+00021e40: 6963 655f 6e61 6d65 2829 202d 3e20 7374  ice_name() -> st
+00021e50: 723a 0a20 2020 2022 2222 5265 7475 726e  r:.    """Return
+00021e60: 7320 6120 7573 6572 2d75 6e69 7175 6520  s a user-unique 
+00021e70: 7365 7276 6963 6520 6e61 6d65 2066 6f72  service name for
+00021e80: 2065 6163 6820 7465 7374 5f73 6b79 7365   each test_skyse
+00021e90: 7276 655f 3c6e 616d 653e 2829 2e0a 0a20  rve_<name>()... 
+00021ea0: 2020 204d 7573 7420 6265 2063 616c 6c65     Must be calle
+00021eb0: 6420 6672 6f6d 2065 6163 6820 7465 7374  d from each test
+00021ec0: 5f73 6b79 7365 7276 655f 3c6e 616d 653e  _skyserve_<name>
+00021ed0: 2829 2e0a 2020 2020 2222 220a 2020 2020  ()..    """.    
+00021ee0: 6361 6c6c 6572 5f66 756e 635f 6e61 6d65  caller_func_name
+00021ef0: 203d 2069 6e73 7065 6374 2e73 7461 636b   = inspect.stack
+00021f00: 2829 5b31 5d5b 335d 0a20 2020 2074 6573  ()[1][3].    tes
+00021f10: 745f 6e61 6d65 203d 2063 616c 6c65 725f  t_name = caller_
+00021f20: 6675 6e63 5f6e 616d 652e 7265 706c 6163  func_name.replac
+00021f30: 6528 275f 272c 2027 2d27 292e 7265 706c  e('_', '-').repl
+00021f40: 6163 6528 2774 6573 742d 272c 2027 742d  ace('test-', 't-
+00021f50: 2729 0a20 2020 2074 6573 745f 6e61 6d65  ').    test_name
+00021f60: 203d 2074 6573 745f 6e61 6d65 2e72 6570   = test_name.rep
+00021f70: 6c61 6365 2827 736b 7973 6572 7665 2d27  lace('skyserve-'
+00021f80: 2c20 2773 732d 2729 0a20 2020 2074 6573  , 'ss-').    tes
+00021f90: 745f 6e61 6d65 203d 2063 6f6d 6d6f 6e5f  t_name = common_
+00021fa0: 7574 696c 732e 6d61 6b65 5f63 6c75 7374  utils.make_clust
+00021fb0: 6572 5f6e 616d 655f 6f6e 5f63 6c6f 7564  er_name_on_cloud
+00021fc0: 2874 6573 745f 6e61 6d65 2c20 3234 290a  (test_name, 24).
+00021fd0: 2020 2020 7265 7475 726e 2066 277b 7465      return f'{te
+00021fe0: 7374 5f6e 616d 657d 2d7b 7465 7374 5f69  st_name}-{test_i
+00021ff0: 647d 270a 0a0a 2320 5765 2063 6865 636b  d}'...# We check
+00022000: 2074 6865 206f 7574 7075 7420 6f66 2074   the output of t
+00022010: 6865 2073 6b79 7365 7276 6520 7365 7276  he skyserve serv
+00022020: 6963 6520 746f 2073 6565 2069 6620 6974  ice to see if it
+00022030: 2069 7320 7265 6164 792e 204f 7574 7075   is ready. Outpu
+00022040: 7420 6f66 0a23 2060 5245 504c 4943 4153  t of.# `REPLICAS
+00022050: 6020 6973 2069 6e20 7468 6520 666f 726d  ` is in the form
+00022060: 206f 6620 6031 2f32 6020 7768 6572 6520   of `1/2` where 
+00022070: 7468 6520 6669 7273 7420 6e75 6d62 6572  the first number
+00022080: 2069 7320 7468 6520 6e75 6d62 6572 206f   is the number o
+00022090: 660a 2320 7265 6164 7920 7265 706c 6963  f.# ready replic
+000220a0: 6173 2061 6e64 2074 6865 2073 6563 6f6e  as and the secon
+000220b0: 6420 6e75 6d62 6572 2069 7320 7468 6520  d number is the 
+000220c0: 6e75 6d62 6572 206f 6620 746f 7461 6c20  number of total 
+000220d0: 7265 706c 6963 6173 2e20 5765 0a23 2067  replicas. We.# g
+000220e0: 7265 7020 7375 6368 2066 6f72 6d61 7420  rep such format 
+000220f0: 746f 2065 6e73 7572 6520 7468 6174 2074  to ensure that t
+00022100: 6865 2073 6572 7669 6365 2069 7320 7265  he service is re
+00022110: 6164 792c 2061 6e64 2065 6172 6c79 2065  ady, and early e
+00022120: 7869 7420 6966 2061 6e79 0a23 2066 6169  xit if any.# fai
+00022130: 6c75 7265 2064 6574 6563 7465 642e 2049  lure detected. I
+00022140: 6e20 7468 6520 656e 6420 7765 2073 6c65  n the end we sle
+00022150: 6570 2066 6f72 0a23 2073 6572 7665 2e4c  ep for.# serve.L
+00022160: 425f 434f 4e54 524f 4c4c 4552 5f53 594e  B_CONTROLLER_SYN
+00022170: 435f 494e 5445 5256 414c 5f53 4543 4f4e  C_INTERVAL_SECON
+00022180: 4453 2074 6f20 6d61 6b65 2073 7572 6520  DS to make sure 
+00022190: 6c6f 6164 2062 616c 616e 6365 7220 6861  load balancer ha
+000221a0: 7665 0a23 2065 6e6f 7567 6820 7469 6d65  ve.# enough time
+000221b0: 2074 6f20 7379 6e63 2077 6974 6820 7468   to sync with th
+000221c0: 6520 636f 6e74 726f 6c6c 6572 2061 6e64  e controller and
+000221d0: 2067 6574 2061 6c6c 2072 6561 6479 2072   get all ready r
+000221e0: 6570 6c69 6361 2049 5073 2e0a 5f53 4552  eplica IPs.._SER
+000221f0: 5645 5f57 4149 545f 554e 5449 4c5f 5245  VE_WAIT_UNTIL_RE
+00022200: 4144 5920 3d20 280a 2020 2020 277b 7b20  ADY = (.    '{{ 
+00022210: 7768 696c 6520 7472 7565 3b20 646f 270a  while true; do'.
+00022220: 2020 2020 2720 2020 2020 733d 2428 736b      '     s=$(sk
+00022230: 7920 7365 7276 6520 7374 6174 7573 207b  y serve status {
+00022240: 6e61 6d65 7d29 3b20 6563 686f 2022 2473  name}); echo "$s
+00022250: 223b 270a 2020 2020 2720 2020 2020 6563  ";'.    '     ec
+00022260: 686f 2022 2473 2220 7c20 6772 6570 202d  ho "$s" | grep -
+00022270: 7120 227b 7265 706c 6963 615f 6e75 6d7d  q "{replica_num}
+00022280: 2f7b 7265 706c 6963 615f 6e75 6d7d 2220  /{replica_num}" 
+00022290: 2626 2062 7265 616b 3b27 0a20 2020 2027  && break;'.    '
+000222a0: 2020 2020 2065 6368 6f20 2224 7322 207c       echo "$s" |
+000222b0: 2067 7265 7020 2d71 2022 4641 494c 4544   grep -q "FAILED
+000222c0: 2220 2626 2065 7869 7420 313b 270a 2020  " && exit 1;'.  
+000222d0: 2020 2720 2020 2020 736c 6565 7020 3130    '     sleep 10
+000222e0: 3b27 0a20 2020 2027 2064 6f6e 653b 207d  ;'.    ' done; }
+000222f0: 7d3b 2065 6368 6f20 2247 6f74 2073 6572  }; echo "Got ser
+00022300: 7669 6365 2073 7461 7475 7320 2473 223b  vice status $s";
+00022310: 270a 2020 2020 6627 736c 6565 7020 7b73  '.    f'sleep {s
+00022320: 6572 7665 2e4c 425f 434f 4e54 524f 4c4c  erve.LB_CONTROLL
+00022330: 4552 5f53 594e 435f 494e 5445 5256 414c  ER_SYNC_INTERVAL
+00022340: 5f53 4543 4f4e 4453 202b 2032 7d3b 2729  _SECONDS + 2};')
+00022350: 0a5f 4950 5f52 4547 4558 203d 2072 2728  ._IP_REGEX = r'(
+00022360: 5b30 2d39 5d7b 312c 337d 5c2e 297b 337d  [0-9]{1,3}\.){3}
+00022370: 5b30 2d39 5d7b 312c 337d 270a 5f41 574b  [0-9]{1,3}'._AWK
+00022380: 5f41 4c4c 5f4c 494e 4553 5f42 454c 4f57  _ALL_LINES_BELOW
+00022390: 5f52 4550 4c49 4341 5320 3d20 7227 2f52  _REPLICAS = r'/R
+000223a0: 6570 6c69 6361 732f 7b66 6c61 673d 313b  eplicas/{flag=1;
+000223b0: 206e 6578 747d 2066 6c61 6727 0a5f 5345   next} flag'._SE
+000223c0: 5256 4943 455f 4c41 554e 4348 494e 475f  RVICE_LAUNCHING_
+000223d0: 5354 4154 5553 5f52 4547 4558 203d 2027  STATUS_REGEX = '
+000223e0: 5052 4f56 4953 494f 4e49 4e47 5c7c 5354  PROVISIONING\|ST
+000223f0: 4152 5449 4e47 270a 2320 5369 6e63 6520  ARTING'.# Since 
+00022400: 7765 2064 6f6e 2774 2061 6c6c 6f77 2074  we don't allow t
+00022410: 6572 6d69 6e61 7465 2074 6865 2073 6572  erminate the ser
+00022420: 7669 6365 2069 6620 7468 6520 636f 6e74  vice if the cont
+00022430: 726f 6c6c 6572 2069 7320 494e 4954 2c0a  roller is INIT,.
+00022440: 2320 7768 6963 6820 6973 2063 6f6d 6d6f  # which is commo
+00022450: 6e20 666f 7220 7369 6d75 6c74 616e 656f  n for simultaneo
+00022460: 7573 2070 7974 6573 742c 2077 6520 6e65  us pytest, we ne
+00022470: 6564 2074 6f20 7761 6974 2075 6e74 696c  ed to wait until
+00022480: 2074 6865 0a23 2063 6f6e 7472 6f6c 6c65   the.# controlle
+00022490: 7220 6973 2055 5020 6265 666f 7265 2077  r is UP before w
+000224a0: 6520 6361 6e20 7465 726d 696e 6174 6520  e can terminate 
+000224b0: 7468 6520 7365 7276 6963 652e 0a23 2054  the service..# T
+000224c0: 6865 2074 6561 7264 6f77 6e20 636f 6d6d  he teardown comm
+000224d0: 616e 6420 6861 7320 6120 3130 2d6d 696e  and has a 10-min
+000224e0: 7320 7469 6d65 6f75 742c 2073 6f20 7765  s timeout, so we
+000224f0: 2064 6f6e 2774 206e 6565 6420 746f 2064   don't need to d
+00022500: 6f0a 2320 7468 6520 7469 6d65 6f75 7420  o.# the timeout 
+00022510: 6865 7265 2e20 5365 6520 696d 706c 656d  here. See implem
+00022520: 656e 7461 7469 6f6e 206f 6620 7275 6e5f  entation of run_
+00022530: 6f6e 655f 7465 7374 2829 2066 6f72 2064  one_test() for d
+00022540: 6574 6169 6c73 2e0a 5f54 4541 5244 4f57  etails.._TEARDOW
+00022550: 4e5f 5345 5256 4943 4520 3d20 280a 2020  N_SERVICE = (.  
+00022560: 2020 2728 666f 7220 6920 696e 2060 7365    '(for i in `se
+00022570: 7120 3120 3230 603b 2064 6f27 0a20 2020  q 1 20`; do'.   
+00022580: 2027 2020 2020 2073 3d24 2873 6b79 2073   '     s=$(sky s
+00022590: 6572 7665 2064 6f77 6e20 2d79 207b 6e61  erve down -y {na
+000225a0: 6d65 7d29 3b27 0a20 2020 2027 2020 2020  me});'.    '    
+000225b0: 2065 6368 6f20 2254 7279 696e 6720 746f   echo "Trying to
+000225c0: 2074 6572 6d69 6e61 7465 207b 6e61 6d65   terminate {name
+000225d0: 7d22 3b27 0a20 2020 2027 2020 2020 2065  }";'.    '     e
+000225e0: 6368 6f20 2224 7322 3b27 0a20 2020 2027  cho "$s";'.    '
+000225f0: 2020 2020 2065 6368 6f20 2224 7322 207c       echo "$s" |
+00022600: 2067 7265 7020 2d71 2022 7363 6865 6475   grep -q "schedu
+00022610: 6c65 6420 746f 2062 6520 7465 726d 696e  led to be termin
+00022620: 6174 6564 5c7c 4e6f 2073 6572 7669 6365  ated\|No service
+00022630: 2074 6f20 7465 726d 696e 6174 6522 2026   to terminate" &
+00022640: 2620 6272 6561 6b3b 270a 2020 2020 2720  & break;'.    ' 
+00022650: 2020 2020 736c 6565 7020 3130 3b27 0a20      sleep 10;'. 
+00022660: 2020 2027 2020 2020 205b 2024 6920 2d65     '     [ $i -e
+00022670: 7120 3230 205d 2026 2620 6563 686f 2022  q 20 ] && echo "
+00022680: 4661 696c 6564 2074 6f20 7465 726d 696e  Failed to termin
+00022690: 6174 6520 7365 7276 6963 6520 7b6e 616d  ate service {nam
+000226a0: 657d 223b 270a 2020 2020 2764 6f6e 6529  e}";'.    'done)
+000226b0: 2729 0a0a 5f53 4552 5645 5f45 4e44 504f  ').._SERVE_ENDPO
+000226c0: 494e 545f 5741 4954 203d 2028 0a20 2020  INT_WAIT = (.   
+000226d0: 2027 6578 706f 7274 204f 5249 4749 4e5f   'export ORIGIN_
+000226e0: 534b 5950 494c 4f54 5f44 4542 5547 3d24  SKYPILOT_DEBUG=$
+000226f0: 534b 5950 494c 4f54 5f44 4542 5547 3b20  SKYPILOT_DEBUG; 
+00022700: 6578 706f 7274 2053 4b59 5049 4c4f 545f  export SKYPILOT_
+00022710: 4445 4255 473d 303b 2027 0a20 2020 2027  DEBUG=0; '.    '
+00022720: 656e 6470 6f69 6e74 3d24 2873 6b79 2073  endpoint=$(sky s
+00022730: 6572 7665 2073 7461 7475 7320 2d2d 656e  erve status --en
+00022740: 6470 6f69 6e74 207b 6e61 6d65 7d29 3b20  dpoint {name}); 
+00022750: 270a 2020 2020 2775 6e74 696c 2021 2065  '.    'until ! e
+00022760: 6368 6f20 2224 656e 6470 6f69 6e74 2220  cho "$endpoint" 
+00022770: 7c20 6772 6570 2022 436f 6e74 726f 6c6c  | grep "Controll
+00022780: 6572 2069 7320 696e 6974 6961 6c69 7a69  er is initializi
+00022790: 6e67 223b 2027 0a20 2020 2027 646f 2065  ng"; '.    'do e
+000227a0: 6368 6f20 2257 6169 7469 6e67 2066 6f72  cho "Waiting for
+000227b0: 2073 6572 7665 2065 6e64 706f 696e 7420   serve endpoint 
+000227c0: 746f 2062 6520 7265 6164 792e 2e2e 223b  to be ready...";
+000227d0: 2027 0a20 2020 2027 736c 6565 7020 353b   '.    'sleep 5;
+000227e0: 2065 6e64 706f 696e 743d 2428 736b 7920   endpoint=$(sky 
+000227f0: 7365 7276 6520 7374 6174 7573 202d 2d65  serve status --e
+00022800: 6e64 706f 696e 7420 7b6e 616d 657d 293b  ndpoint {name});
+00022810: 2064 6f6e 653b 2027 0a20 2020 2027 6578   done; '.    'ex
+00022820: 706f 7274 2053 4b59 5049 4c4f 545f 4445  port SKYPILOT_DE
+00022830: 4255 473d 244f 5249 4749 4e5f 534b 5950  BUG=$ORIGIN_SKYP
+00022840: 494c 4f54 5f44 4542 5547 3b20 6563 686f  ILOT_DEBUG; echo
+00022850: 2022 2465 6e64 706f 696e 7422 2729 0a0a   "$endpoint"')..
+00022860: 5f53 4552 5645 5f53 5441 5455 535f 5741  _SERVE_STATUS_WA
+00022870: 4954 203d 2028 2773 3d24 2873 6b79 2073  IT = ('s=$(sky s
+00022880: 6572 7665 2073 7461 7475 7320 7b6e 616d  erve status {nam
+00022890: 657d 293b 2027 0a20 2020 2020 2020 2020  e}); '.         
+000228a0: 2020 2020 2020 2020 2020 2020 2027 756e               'un
+000228b0: 7469 6c20 2120 6563 686f 2022 2473 2220  til ! echo "$s" 
+000228c0: 7c20 6772 6570 2022 436f 6e74 726f 6c6c  | grep "Controll
+000228d0: 6572 2069 7320 696e 6974 6961 6c69 7a69  er is initializi
+000228e0: 6e67 2e22 3b20 270a 2020 2020 2020 2020  ng."; '.        
+000228f0: 2020 2020 2020 2020 2020 2020 2020 2764                'd
+00022900: 6f20 6563 686f 2022 5761 6974 696e 6720  o echo "Waiting 
+00022910: 666f 7220 7365 7276 6520 7374 6174 7573  for serve status
+00022920: 2074 6f20 6265 2072 6561 6479 2e2e 2e22   to be ready..."
+00022930: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
+00022940: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+00022950: 2035 3b20 733d 2428 736b 7920 7365 7276   5; s=$(sky serv
+00022960: 6520 7374 6174 7573 207b 6e61 6d65 7d29  e status {name})
+00022970: 3b20 646f 6e65 3b20 6563 686f 2022 2473  ; done; echo "$s
+00022980: 2227 290a 0a0a 6465 6620 5f67 6574 5f72  "')...def _get_r
+00022990: 6570 6c69 6361 5f69 7028 6e61 6d65 3a20  eplica_ip(name: 
+000229a0: 7374 722c 2072 6570 6c69 6361 5f69 643a  str, replica_id:
+000229b0: 2069 6e74 2920 2d3e 2073 7472 3a0a 2020   int) -> str:.  
+000229c0: 2020 7265 7475 726e 2028 6627 6970 7b72    return (f'ip{r
+000229d0: 6570 6c69 6361 5f69 647d 3d24 2865 6368  eplica_id}=$(ech
+000229e0: 6f20 2224 7322 207c 2027 0a20 2020 2020  o "$s" | '.     
+000229f0: 2020 2020 2020 2066 2761 776b 2022 7b5f         f'awk "{_
+00022a00: 4157 4b5f 414c 4c5f 4c49 4e45 535f 4245  AWK_ALL_LINES_BE
+00022a10: 4c4f 575f 5245 504c 4943 4153 7d22 207c  LOW_REPLICAS}" |
+00022a20: 2027 0a20 2020 2020 2020 2020 2020 2066   '.            f
+00022a30: 2767 7265 7020 2d45 2022 7b6e 616d 657d  'grep -E "{name}
+00022a40: 5c73 2b7b 7265 706c 6963 615f 6964 7d22  \s+{replica_id}"
+00022a50: 207c 2027 0a20 2020 2020 2020 2020 2020   | '.           
+00022a60: 2066 2767 7265 7020 2d45 6f20 227b 5f49   f'grep -Eo "{_I
+00022a70: 505f 5245 4745 587d 2229 2729 0a0a 0a64  P_REGEX}")')...d
+00022a80: 6566 205f 6765 745f 736b 7973 6572 7665  ef _get_skyserve
+00022a90: 5f68 7474 705f 7465 7374 286e 616d 653a  _http_test(name:
+00022aa0: 2073 7472 2c20 636c 6f75 643a 2073 7472   str, cloud: str
+00022ab0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00022ac0: 2020 2020 2020 2020 2020 2020 2020 7469                ti
+00022ad0: 6d65 6f75 745f 6d69 6e75 7465 733a 2069  meout_minutes: i
+00022ae0: 6e74 2920 2d3e 2054 6573 743a 0a20 2020  nt) -> Test:.   
+00022af0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+00022b00: 2020 2020 2020 6627 7465 7374 2d73 6b79        f'test-sky
+00022b10: 7365 7276 652d 7b63 6c6f 7564 2e72 6570  serve-{cloud.rep
+00022b20: 6c61 6365 2822 5f22 2c20 222d 2229 7d27  lace("_", "-")}'
+00022b30: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+00022b40: 2020 2020 2020 2020 6627 736b 7920 7365          f'sky se
+00022b50: 7276 6520 7570 202d 6e20 7b6e 616d 657d  rve up -n {name}
+00022b60: 202d 7920 7465 7374 732f 736b 7973 6572   -y tests/skyser
+00022b70: 7665 2f68 7474 702f 7b63 6c6f 7564 7d2e  ve/http/{cloud}.
+00022b80: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00022b90: 2020 205f 5345 5256 455f 5741 4954 5f55     _SERVE_WAIT_U
+00022ba0: 4e54 494c 5f52 4541 4459 2e66 6f72 6d61  NTIL_READY.forma
+00022bb0: 7428 6e61 6d65 3d6e 616d 652c 2072 6570  t(name=name, rep
+00022bc0: 6c69 6361 5f6e 756d 3d32 292c 0a20 2020  lica_num=2),.   
+00022bd0: 2020 2020 2020 2020 2066 277b 5f53 4552           f'{_SER
+00022be0: 5645 5f45 4e44 504f 494e 545f 5741 4954  VE_ENDPOINT_WAIT
+00022bf0: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
+00022c00: 6529 7d3b 2027 0a20 2020 2020 2020 2020  e)}; '.         
+00022c10: 2020 2027 6375 726c 2068 7474 703a 2f2f     'curl http://
+00022c20: 2465 6e64 706f 696e 7420 7c20 6772 6570  $endpoint | grep
+00022c30: 2022 4869 2c20 536b 7950 696c 6f74 2068   "Hi, SkyPilot h
+00022c40: 6572 6522 272c 0a20 2020 2020 2020 205d  ere"',.        ]
+00022c50: 2c0a 2020 2020 2020 2020 5f54 4541 5244  ,.        _TEARD
+00022c60: 4f57 4e5f 5345 5256 4943 452e 666f 726d  OWN_SERVICE.form
+00022c70: 6174 286e 616d 653d 6e61 6d65 292c 0a20  at(name=name),. 
+00022c80: 2020 2020 2020 2074 696d 656f 7574 3d74         timeout=t
+00022c90: 696d 656f 7574 5f6d 696e 7574 6573 202a  imeout_minutes *
+00022ca0: 2036 302c 0a20 2020 2029 0a20 2020 2072   60,.    ).    r
+00022cb0: 6574 7572 6e20 7465 7374 0a0a 0a64 6566  eturn test...def
+00022cc0: 205f 6368 6563 6b5f 7265 706c 6963 615f   _check_replica_
+00022cd0: 696e 5f73 7461 7475 7328 6e61 6d65 3a20  in_status(name: 
+00022ce0: 7374 722c 2063 6865 636b 5f74 7570 6c65  str, check_tuple
+00022cf0: 733a 204c 6973 745b 5475 706c 655b 696e  s: List[Tuple[in
+00022d00: 742c 2062 6f6f 6c2c 0a20 2020 2020 2020  t, bool,.       
+00022d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022d40: 2020 2020 2020 2020 2020 7374 725d 5d29            str]])
+00022d50: 202d 3e20 7374 723a 0a20 2020 2022 2222   -> str:.    """
+00022d60: 4368 6563 6b20 7265 706c 6963 6173 2720  Check replicas' 
+00022d70: 7374 6174 7573 2061 6e64 2063 6f75 6e74  status and count
+00022d80: 2069 6e20 736b 7920 7365 7276 6520 7374   in sky serve st
+00022d90: 6174 7573 0a0a 2020 2020 5765 2077 696c  atus..    We wil
+00022da0: 6c20 6368 6563 6b20 7643 5055 3d32 2c20  l check vCPU=2, 
+00022db0: 6173 2061 6c6c 206f 7572 2074 6573 7473  as all our tests
+00022dc0: 2075 7365 2076 4350 553d 322e 0a20 2020   use vCPU=2..   
+00022dd0: 200a 2020 2020 4172 6773 3a0a 2020 2020   .    Args:.    
+00022de0: 2020 2020 6e61 6d65 3a20 7468 6520 6e61      name: the na
+00022df0: 6d65 206f 6620 7468 6520 7365 7276 6963  me of the servic
+00022e00: 650a 2020 2020 2020 2020 6368 6563 6b5f  e.        check_
+00022e10: 7475 706c 6573 3a20 4120 6c69 7374 206f  tuples: A list o
+00022e20: 6620 7265 706c 6963 6120 7072 6f70 6572  f replica proper
+00022e30: 7479 2074 6f20 6368 6563 6b2e 2045 6163  ty to check. Eac
+00022e40: 6820 7475 706c 6520 6973 0a20 2020 2020  h tuple is.     
+00022e50: 2020 2020 2020 2028 636f 756e 742c 2069         (count, i
+00022e60: 735f 7370 6f74 2c20 7374 6174 7573 290a  s_spot, status).
+00022e70: 2020 2020 2222 220a 2020 2020 6368 6563      """.    chec
+00022e80: 6b5f 636d 6420 3d20 2727 0a20 2020 2066  k_cmd = ''.    f
+00022e90: 6f72 2063 6865 636b 5f74 7570 6c65 2069  or check_tuple i
+00022ea0: 6e20 6368 6563 6b5f 7475 706c 6573 3a0a  n check_tuples:.
+00022eb0: 2020 2020 2020 2020 636f 756e 742c 2069          count, i
+00022ec0: 735f 7370 6f74 2c20 7374 6174 7573 203d  s_spot, status =
+00022ed0: 2063 6865 636b 5f74 7570 6c65 0a20 2020   check_tuple.   
+00022ee0: 2020 2020 2072 6573 6f75 7263 655f 7374       resource_st
+00022ef0: 7220 3d20 2727 0a20 2020 2020 2020 2069  r = ''.        i
+00022f00: 6620 7374 6174 7573 206e 6f74 2069 6e20  f status not in 
+00022f10: 5b27 5045 4e44 494e 4727 2c20 2753 4855  ['PENDING', 'SHU
+00022f20: 5454 494e 475f 444f 574e 270a 2020 2020  TTING_DOWN'.    
+00022f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022f40: 2020 2020 205d 2061 6e64 206e 6f74 2073       ] and not s
+00022f50: 7461 7475 732e 7374 6172 7473 7769 7468  tatus.startswith
+00022f60: 2827 4641 494c 4544 2729 3a0a 2020 2020  ('FAILED'):.    
+00022f70: 2020 2020 2020 2020 7370 6f74 5f73 7472          spot_str
+00022f80: 203d 2027 270a 2020 2020 2020 2020 2020   = ''.          
+00022f90: 2020 6966 2069 735f 7370 6f74 3a0a 2020    if is_spot:.  
+00022fa0: 2020 2020 2020 2020 2020 2020 2020 7370                sp
+00022fb0: 6f74 5f73 7472 203d 2027 5c5b 5370 6f74  ot_str = '\[Spot
+00022fc0: 5c5d 270a 2020 2020 2020 2020 2020 2020  \]'.            
+00022fd0: 7265 736f 7572 6365 5f73 7472 203d 2066  resource_str = f
+00022fe0: 2728 7b73 706f 745f 7374 727d 7643 5055  '({spot_str}vCPU
+00022ff0: 3d32 2927 0a20 2020 2020 2020 2063 6865  =2)'.        che
+00023000: 636b 5f63 6d64 202b 3d20 2866 2720 6563  ck_cmd += (f' ec
+00023010: 686f 2022 2473 2220 7c20 6772 6570 2022  ho "$s" | grep "
+00023020: 7b72 6573 6f75 7263 655f 7374 727d 2220  {resource_str}" 
+00023030: 7c20 270a 2020 2020 2020 2020 2020 2020  | '.            
+00023040: 2020 2020 2020 2020 2020 6627 6772 6570            f'grep
+00023050: 2022 7b73 7461 7475 737d 2220 7c20 7763   "{status}" | wc
+00023060: 202d 6c20 7c20 6772 6570 207b 636f 756e   -l | grep {coun
+00023070: 747d 207c 7c20 6578 6974 2031 3b27 290a  t} || exit 1;').
+00023080: 2020 2020 7265 7475 726e 2028 6627 7b5f      return (f'{_
+00023090: 5345 5256 455f 5354 4154 5553 5f57 4149  SERVE_STATUS_WAI
+000230a0: 542e 666f 726d 6174 286e 616d 653d 6e61  T.format(name=na
+000230b0: 6d65 297d 3b20 6563 686f 2022 2473 223b  me)}; echo "$s";
+000230c0: 2027 202b 2063 6865 636b 5f63 6d64 290a   ' + check_cmd).
+000230d0: 0a0a 6465 6620 5f63 6865 636b 5f73 6572  ..def _check_ser
+000230e0: 7669 6365 5f76 6572 7369 6f6e 2873 6572  vice_version(ser
+000230f0: 7669 6365 5f6e 616d 653a 2073 7472 2c20  vice_name: str, 
+00023100: 7665 7273 696f 6e3a 2073 7472 2920 2d3e  version: str) ->
+00023110: 2073 7472 3a0a 2020 2020 2320 4772 6570   str:.    # Grep
+00023120: 2074 6865 206c 696e 6573 2062 6566 6f72   the lines befor
+00023130: 6520 2753 6572 7669 6365 2052 6570 6c69  e 'Service Repli
+00023140: 6361 7327 2061 6e64 2063 6865 636b 2069  cas' and check i
+00023150: 6620 7468 6520 7365 7276 6963 6520 7665  f the service ve
+00023160: 7273 696f 6e0a 2020 2020 2320 6973 2063  rsion.    # is c
+00023170: 6f72 7265 6374 2e0a 2020 2020 7265 7475  orrect..    retu
+00023180: 726e 2028 6627 6563 686f 2022 2473 2220  rn (f'echo "$s" 
+00023190: 7c20 6772 6570 202d 4231 3030 3020 2253  | grep -B1000 "S
+000231a0: 6572 7669 6365 2052 6570 6c69 6361 7322  ervice Replicas"
+000231b0: 207c 2027 0a20 2020 2020 2020 2020 2020   | '.           
+000231c0: 2066 2767 7265 7020 2d45 2022 7b73 6572   f'grep -E "{ser
+000231d0: 7669 6365 5f6e 616d 657d 5c73 2b7b 7665  vice_name}\s+{ve
+000231e0: 7273 696f 6e7d 2220 7c7c 2065 7869 7420  rsion}" || exit 
+000231f0: 313b 2027 290a 0a0a 4070 7974 6573 742e  1; ')...@pytest.
+00023200: 6d61 726b 2e67 6370 0a40 7079 7465 7374  mark.gcp.@pytest
+00023210: 2e6d 6172 6b2e 7365 7276 650a 6465 6620  .mark.serve.def 
+00023220: 7465 7374 5f73 6b79 7365 7276 655f 6763  test_skyserve_gc
+00023230: 705f 6874 7470 2829 3a0a 2020 2020 2222  p_http():.    ""
+00023240: 2254 6573 7420 736b 7973 6572 7665 206f  "Test skyserve o
+00023250: 6e20 4743 5022 2222 0a20 2020 206e 616d  n GCP""".    nam
+00023260: 6520 3d20 5f67 6574 5f73 6572 7669 6365  e = _get_service
+00023270: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+00023280: 203d 205f 6765 745f 736b 7973 6572 7665   = _get_skyserve
+00023290: 5f68 7474 705f 7465 7374 286e 616d 652c  _http_test(name,
+000232a0: 2027 6763 7027 2c20 3230 290a 2020 2020   'gcp', 20).    
+000232b0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+000232c0: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+000232d0: 6b2e 6177 730a 4070 7974 6573 742e 6d61  k.aws.@pytest.ma
+000232e0: 726b 2e73 6572 7665 0a64 6566 2074 6573  rk.serve.def tes
+000232f0: 745f 736b 7973 6572 7665 5f61 7773 5f68  t_skyserve_aws_h
+00023300: 7474 7028 293a 0a20 2020 2022 2222 5465  ttp():.    """Te
+00023310: 7374 2073 6b79 7365 7276 6520 6f6e 2041  st skyserve on A
+00023320: 5753 2222 220a 2020 2020 6e61 6d65 203d  WS""".    name =
+00023330: 205f 6765 745f 7365 7276 6963 655f 6e61   _get_service_na
+00023340: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
+00023350: 5f67 6574 5f73 6b79 7365 7276 655f 6874  _get_skyserve_ht
+00023360: 7470 5f74 6573 7428 6e61 6d65 2c20 2761  tp_test(name, 'a
+00023370: 7773 272c 2032 3029 0a20 2020 2072 756e  ws', 20).    run
+00023380: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+00023390: 0a0a 4070 7974 6573 742e 6d61 726b 2e61  ..@pytest.mark.a
+000233a0: 7a75 7265 0a40 7079 7465 7374 2e6d 6172  zure.@pytest.mar
+000233b0: 6b2e 7365 7276 650a 6465 6620 7465 7374  k.serve.def test
+000233c0: 5f73 6b79 7365 7276 655f 617a 7572 655f  _skyserve_azure_
+000233d0: 6874 7470 2829 3a0a 2020 2020 2222 2254  http():.    """T
+000233e0: 6573 7420 736b 7973 6572 7665 206f 6e20  est skyserve on 
+000233f0: 417a 7572 6522 2222 0a20 2020 206e 616d  Azure""".    nam
+00023400: 6520 3d20 5f67 6574 5f73 6572 7669 6365  e = _get_service
+00023410: 5f6e 616d 6528 290a 2020 2020 7465 7374  _name().    test
+00023420: 203d 205f 6765 745f 736b 7973 6572 7665   = _get_skyserve
+00023430: 5f68 7474 705f 7465 7374 286e 616d 652c  _http_test(name,
+00023440: 2027 617a 7572 6527 2c20 3330 290a 2020   'azure', 30).  
+00023450: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00023460: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+00023470: 6172 6b2e 6b75 6265 726e 6574 6573 0a40  ark.kubernetes.@
+00023480: 7079 7465 7374 2e6d 6172 6b2e 7365 7276  pytest.mark.serv
+00023490: 650a 6465 6620 7465 7374 5f73 6b79 7365  e.def test_skyse
+000234a0: 7276 655f 6b75 6265 726e 6574 6573 5f68  rve_kubernetes_h
+000234b0: 7474 7028 293a 0a20 2020 2022 2222 5465  ttp():.    """Te
+000234c0: 7374 2073 6b79 7365 7276 6520 6f6e 204b  st skyserve on K
+000234d0: 7562 6572 6e65 7465 7322 2222 0a20 2020  ubernetes""".   
+000234e0: 206e 616d 6520 3d20 5f67 6574 5f73 6572   name = _get_ser
+000234f0: 7669 6365 5f6e 616d 6528 290a 2020 2020  vice_name().    
+00023500: 7465 7374 203d 205f 6765 745f 736b 7973  test = _get_skys
+00023510: 6572 7665 5f68 7474 705f 7465 7374 286e  erve_http_test(n
+00023520: 616d 652c 2027 6b75 6265 726e 6574 6573  ame, 'kubernetes
+00023530: 272c 2033 3029 0a20 2020 2072 756e 5f6f  ', 30).    run_o
+00023540: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00023550: 4070 7974 6573 742e 6d61 726b 2e73 6572  @pytest.mark.ser
+00023560: 7665 0a64 6566 2074 6573 745f 736b 7973  ve.def test_skys
+00023570: 6572 7665 5f6c 6c6d 2867 656e 6572 6963  erve_llm(generic
+00023580: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
+00023590: 2020 2222 2254 6573 7420 736b 7973 6572    """Test skyser
+000235a0: 7665 2077 6974 6820 7265 616c 204c 4c4d  ve with real LLM
+000235b0: 2075 7365 6361 7365 2222 220a 2020 2020   usecase""".    
+000235c0: 6e61 6d65 203d 205f 6765 745f 7365 7276  name = _get_serv
+000235d0: 6963 655f 6e61 6d65 2829 0a0a 2020 2020  ice_name()..    
+000235e0: 6465 6620 6765 6e65 7261 7465 5f6c 6c6d  def generate_llm
+000235f0: 5f74 6573 745f 636f 6d6d 616e 6428 7072  _test_command(pr
+00023600: 6f6d 7074 3a20 7374 722c 2065 7870 6563  ompt: str, expec
+00023610: 7465 645f 6f75 7470 7574 3a20 7374 7229  ted_output: str)
+00023620: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
+00023630: 2070 726f 6d70 7420 3d20 7368 6c65 782e   prompt = shlex.
+00023640: 7175 6f74 6528 7072 6f6d 7074 290a 2020  quote(prompt).  
+00023650: 2020 2020 2020 6578 7065 6374 6564 5f6f        expected_o
+00023660: 7574 7075 7420 3d20 7368 6c65 782e 7175  utput = shlex.qu
+00023670: 6f74 6528 6578 7065 6374 6564 5f6f 7574  ote(expected_out
+00023680: 7075 7429 0a20 2020 2020 2020 2072 6574  put).        ret
+00023690: 7572 6e20 280a 2020 2020 2020 2020 2020  urn (.          
+000236a0: 2020 6627 7b5f 5345 5256 455f 454e 4450    f'{_SERVE_ENDP
+000236b0: 4f49 4e54 5f57 4149 542e 666f 726d 6174  OINT_WAIT.format
+000236c0: 286e 616d 653d 6e61 6d65 297d 3b20 270a  (name=name)}; '.
+000236d0: 2020 2020 2020 2020 2020 2020 2770 7974              'pyt
+000236e0: 686f 6e20 7465 7374 732f 736b 7973 6572  hon tests/skyser
+000236f0: 7665 2f6c 6c6d 2f67 6574 5f72 6573 706f  ve/llm/get_respo
+00023700: 6e73 652e 7079 202d 2d65 6e64 706f 696e  nse.py --endpoin
+00023710: 7420 2465 6e64 706f 696e 7420 270a 2020  t $endpoint '.  
+00023720: 2020 2020 2020 2020 2020 6627 2d2d 7072            f'--pr
+00023730: 6f6d 7074 207b 7072 6f6d 7074 7d20 7c20  ompt {prompt} | 
+00023740: 6772 6570 207b 6578 7065 6374 6564 5f6f  grep {expected_o
+00023750: 7574 7075 747d 2729 0a0a 2020 2020 7769  utput}')..    wi
+00023760: 7468 206f 7065 6e28 2774 6573 7473 2f73  th open('tests/s
+00023770: 6b79 7365 7276 652f 6c6c 6d2f 7072 6f6d  kyserve/llm/prom
+00023780: 7074 5f6f 7574 7075 742e 6a73 6f6e 272c  pt_output.json',
+00023790: 2027 7227 2c0a 2020 2020 2020 2020 2020   'r',.          
+000237a0: 2020 2020 656e 636f 6469 6e67 3d27 7574      encoding='ut
+000237b0: 662d 3827 2920 6173 2066 3a0a 2020 2020  f-8') as f:.    
+000237c0: 2020 2020 7072 6f6d 7074 326f 7574 7075      prompt2outpu
+000237d0: 7420 3d20 6a73 6f6e 2e6c 6f61 6428 6629  t = json.load(f)
+000237e0: 0a0a 2020 2020 7465 7374 203d 2054 6573  ..    test = Tes
+000237f0: 7428 0a20 2020 2020 2020 2066 2774 6573  t(.        f'tes
+00023800: 742d 736b 7973 6572 7665 2d6c 6c6d 272c  t-skyserve-llm',
+00023810: 0a20 2020 2020 2020 205b 0a20 2020 2020  .        [.     
+00023820: 2020 2020 2020 2066 2773 6b79 2073 6572         f'sky ser
+00023830: 7665 2075 7020 2d6e 207b 6e61 6d65 7d20  ve up -n {name} 
+00023840: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
+00023850: 5f63 6c6f 7564 7d20 2d79 2074 6573 7473  _cloud} -y tests
+00023860: 2f73 6b79 7365 7276 652f 6c6c 6d2f 7365  /skyserve/llm/se
+00023870: 7276 6963 652e 7961 6d6c 272c 0a20 2020  rvice.yaml',.   
+00023880: 2020 2020 2020 2020 205f 5345 5256 455f           _SERVE_
+00023890: 5741 4954 5f55 4e54 494c 5f52 4541 4459  WAIT_UNTIL_READY
+000238a0: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
+000238b0: 652c 2072 6570 6c69 6361 5f6e 756d 3d31  e, replica_num=1
+000238c0: 292c 0a20 2020 2020 2020 2020 2020 202a  ),.            *
+000238d0: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+000238e0: 2020 6765 6e65 7261 7465 5f6c 6c6d 5f74    generate_llm_t
+000238f0: 6573 745f 636f 6d6d 616e 6428 7072 6f6d  est_command(prom
+00023900: 7074 2c20 6f75 7470 7574 290a 2020 2020  pt, output).    
+00023910: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00023920: 7072 6f6d 7074 2c20 6f75 7470 7574 2069  prompt, output i
+00023930: 6e20 7072 6f6d 7074 326f 7574 7075 742e  n prompt2output.
+00023940: 6974 656d 7328 290a 2020 2020 2020 2020  items().        
+00023950: 2020 2020 5d2c 0a20 2020 2020 2020 205d      ],.        ]
+00023960: 2c0a 2020 2020 2020 2020 5f54 4541 5244  ,.        _TEARD
+00023970: 4f57 4e5f 5345 5256 4943 452e 666f 726d  OWN_SERVICE.form
+00023980: 6174 286e 616d 653d 6e61 6d65 292c 0a20  at(name=name),. 
+00023990: 2020 2020 2020 2074 696d 656f 7574 3d34         timeout=4
+000239a0: 3020 2a20 3630 2c0a 2020 2020 290a 2020  0 * 60,.    ).  
+000239b0: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+000239c0: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+000239d0: 6172 6b2e 6763 700a 4070 7974 6573 742e  ark.gcp.@pytest.
+000239e0: 6d61 726b 2e73 6572 7665 0a64 6566 2074  mark.serve.def t
+000239f0: 6573 745f 736b 7973 6572 7665 5f73 706f  est_skyserve_spo
+00023a00: 745f 7265 636f 7665 7279 2829 3a0a 2020  t_recovery():.  
+00023a10: 2020 6e61 6d65 203d 205f 6765 745f 7365    name = _get_se
+00023a20: 7276 6963 655f 6e61 6d65 2829 0a20 2020  rvice_name().   
+00023a30: 207a 6f6e 6520 3d20 2775 732d 6365 6e74   zone = 'us-cent
+00023a40: 7261 6c31 2d61 270a 0a20 2020 2074 6573  ral1-a'..    tes
+00023a50: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+00023a60: 2020 6627 7465 7374 2d73 6b79 7365 7276    f'test-skyserv
+00023a70: 652d 7370 6f74 2d72 6563 6f76 6572 792d  e-spot-recovery-
+00023a80: 6763 7027 2c0a 2020 2020 2020 2020 5b0a  gcp',.        [.
+00023a90: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00023aa0: 7920 7365 7276 6520 7570 202d 6e20 7b6e  y serve up -n {n
+00023ab0: 616d 657d 202d 7920 7465 7374 732f 736b  ame} -y tests/sk
+00023ac0: 7973 6572 7665 2f73 706f 742f 7265 636f  yserve/spot/reco
+00023ad0: 7665 7279 2e79 616d 6c27 2c0a 2020 2020  very.yaml',.    
+00023ae0: 2020 2020 2020 2020 5f53 4552 5645 5f57          _SERVE_W
+00023af0: 4149 545f 554e 5449 4c5f 5245 4144 592e  AIT_UNTIL_READY.
+00023b00: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
+00023b10: 2c20 7265 706c 6963 615f 6e75 6d3d 3129  , replica_num=1)
+00023b20: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00023b30: 7b5f 5345 5256 455f 454e 4450 4f49 4e54  {_SERVE_ENDPOINT
+00023b40: 5f57 4149 542e 666f 726d 6174 286e 616d  _WAIT.format(nam
+00023b50: 653d 6e61 6d65 297d 3b20 270a 2020 2020  e=name)}; '.    
+00023b60: 2020 2020 2020 2020 2772 6571 7565 7374          'request
+00023b70: 5f6f 7574 7075 743d 2428 6375 726c 2068  _output=$(curl h
+00023b80: 7474 703a 2f2f 2465 6e64 706f 696e 7429  ttp://$endpoint)
+00023b90: 3b20 6563 686f 2022 2472 6571 7565 7374  ; echo "$request
+00023ba0: 5f6f 7574 7075 7422 3b20 6563 686f 2022  _output"; echo "
+00023bb0: 2472 6571 7565 7374 5f6f 7574 7075 7422  $request_output"
+00023bc0: 207c 2067 7265 7020 2248 692c 2053 6b79   | grep "Hi, Sky
+00023bd0: 5069 6c6f 7420 6865 7265 2227 2c0a 2020  Pilot here"',.  
+00023be0: 2020 2020 2020 2020 2020 5f74 6572 6d69            _termi
+00023bf0: 6e61 7465 5f67 6370 5f72 6570 6c69 6361  nate_gcp_replica
+00023c00: 286e 616d 652c 207a 6f6e 652c 2031 292c  (name, zone, 1),
+00023c10: 0a20 2020 2020 2020 2020 2020 205f 5345  .            _SE
+00023c20: 5256 455f 5741 4954 5f55 4e54 494c 5f52  RVE_WAIT_UNTIL_R
+00023c30: 4541 4459 2e66 6f72 6d61 7428 6e61 6d65  EADY.format(name
+00023c40: 3d6e 616d 652c 2072 6570 6c69 6361 5f6e  =name, replica_n
+00023c50: 756d 3d31 292c 0a20 2020 2020 2020 2020  um=1),.         
+00023c60: 2020 2066 277b 5f53 4552 5645 5f45 4e44     f'{_SERVE_END
+00023c70: 504f 494e 545f 5741 4954 2e66 6f72 6d61  POINT_WAIT.forma
+00023c80: 7428 6e61 6d65 3d6e 616d 6529 7d3b 2027  t(name=name)}; '
+00023c90: 0a20 2020 2020 2020 2020 2020 2027 7265  .            're
+00023ca0: 7175 6573 745f 6f75 7470 7574 3d24 2863  quest_output=$(c
+00023cb0: 7572 6c20 6874 7470 3a2f 2f24 656e 6470  url http://$endp
+00023cc0: 6f69 6e74 293b 2065 6368 6f20 2224 7265  oint); echo "$re
+00023cd0: 7175 6573 745f 6f75 7470 7574 223b 2065  quest_output"; e
+00023ce0: 6368 6f20 2224 7265 7175 6573 745f 6f75  cho "$request_ou
+00023cf0: 7470 7574 2220 7c20 6772 6570 2022 4869  tput" | grep "Hi
+00023d00: 2c20 536b 7950 696c 6f74 2068 6572 6522  , SkyPilot here"
+00023d10: 272c 0a20 2020 2020 2020 205d 2c0a 2020  ',.        ],.  
+00023d20: 2020 2020 2020 5f54 4541 5244 4f57 4e5f        _TEARDOWN_
+00023d30: 5345 5256 4943 452e 666f 726d 6174 286e  SERVICE.format(n
+00023d40: 616d 653d 6e61 6d65 292c 0a20 2020 2020  ame=name),.     
+00023d50: 2020 2074 696d 656f 7574 3d32 3020 2a20     timeout=20 * 
+00023d60: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
+00023d70: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+00023d80: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+00023d90: 7365 7276 650a 4070 7974 6573 742e 6d61  serve.@pytest.ma
+00023da0: 726b 2e6e 6f5f 6b75 6265 726e 6574 6573  rk.no_kubernetes
+00023db0: 0a64 6566 2074 6573 745f 736b 7973 6572  .def test_skyser
+00023dc0: 7665 5f62 6173 655f 6f6e 6465 6d61 6e64  ve_base_ondemand
+00023dd0: 5f66 616c 6c62 6163 6b28 6765 6e65 7269  _fallback(generi
+00023de0: 635f 636c 6f75 643a 2073 7472 293a 0a20  c_cloud: str):. 
+00023df0: 2020 206e 616d 6520 3d20 5f67 6574 5f73     name = _get_s
+00023e00: 6572 7669 6365 5f6e 616d 6528 290a 2020  ervice_name().  
+00023e10: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+00023e20: 2020 2020 2020 2066 2774 6573 742d 736b         f'test-sk
+00023e30: 7973 6572 7665 2d62 6173 652d 6f6e 6465  yserve-base-onde
+00023e40: 6d61 6e64 2d66 616c 6c62 6163 6b27 2c0a  mand-fallback',.
+00023e50: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+00023e60: 2020 2020 2020 6627 736b 7920 7365 7276        f'sky serv
+00023e70: 6520 7570 202d 6e20 7b6e 616d 657d 202d  e up -n {name} -
+00023e80: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
+00023e90: 636c 6f75 647d 202d 7920 7465 7374 732f  cloud} -y tests/
+00023ea0: 736b 7973 6572 7665 2f73 706f 742f 6261  skyserve/spot/ba
+00023eb0: 7365 5f6f 6e64 656d 616e 645f 6661 6c6c  se_ondemand_fall
+00023ec0: 6261 636b 2e79 616d 6c27 2c0a 2020 2020  back.yaml',.    
+00023ed0: 2020 2020 2020 2020 5f53 4552 5645 5f57          _SERVE_W
+00023ee0: 4149 545f 554e 5449 4c5f 5245 4144 592e  AIT_UNTIL_READY.
+00023ef0: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
+00023f00: 2c20 7265 706c 6963 615f 6e75 6d3d 3229  , replica_num=2)
+00023f10: 2c0a 2020 2020 2020 2020 2020 2020 5f63  ,.            _c
+00023f20: 6865 636b 5f72 6570 6c69 6361 5f69 6e5f  heck_replica_in_
+00023f30: 7374 6174 7573 286e 616d 652c 205b 2831  status(name, [(1
+00023f40: 2c20 5472 7565 2c20 2752 4541 4459 2729  , True, 'READY')
+00023f50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00023f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023f70: 2020 2020 2020 2020 2020 2020 2020 2831                (1
+00023f80: 2c20 4661 6c73 652c 2027 5245 4144 5927  , False, 'READY'
+00023f90: 295d 292c 0a20 2020 2020 2020 205d 2c0a  )]),.        ],.
+00023fa0: 2020 2020 2020 2020 5f54 4541 5244 4f57          _TEARDOW
+00023fb0: 4e5f 5345 5256 4943 452e 666f 726d 6174  N_SERVICE.format
+00023fc0: 286e 616d 653d 6e61 6d65 292c 0a20 2020  (name=name),.   
+00023fd0: 2020 2020 2074 696d 656f 7574 3d32 3020       timeout=20 
+00023fe0: 2a20 3630 2c0a 2020 2020 290a 2020 2020  * 60,.    ).    
+00023ff0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+00024000: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+00024010: 6b2e 6763 700a 4070 7974 6573 742e 6d61  k.gcp.@pytest.ma
+00024020: 726b 2e73 6572 7665 0a64 6566 2074 6573  rk.serve.def tes
+00024030: 745f 736b 7973 6572 7665 5f64 796e 616d  t_skyserve_dynam
+00024040: 6963 5f6f 6e64 656d 616e 645f 6661 6c6c  ic_ondemand_fall
+00024050: 6261 636b 2829 3a0a 2020 2020 6e61 6d65  back():.    name
+00024060: 203d 205f 6765 745f 7365 7276 6963 655f   = _get_service_
+00024070: 6e61 6d65 2829 0a20 2020 207a 6f6e 6520  name().    zone 
+00024080: 3d20 2775 732d 6365 6e74 7261 6c31 2d61  = 'us-central1-a
+00024090: 270a 0a20 2020 2074 6573 7420 3d20 5465  '..    test = Te
+000240a0: 7374 280a 2020 2020 2020 2020 6627 7465  st(.        f'te
+000240b0: 7374 2d73 6b79 7365 7276 652d 6479 6e61  st-skyserve-dyna
+000240c0: 6d69 632d 6f6e 6465 6d61 6e64 2d66 616c  mic-ondemand-fal
+000240d0: 6c62 6163 6b27 2c0a 2020 2020 2020 2020  lback',.        
+000240e0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+000240f0: 736b 7920 7365 7276 6520 7570 202d 6e20  sky serve up -n 
+00024100: 7b6e 616d 657d 202d 2d63 6c6f 7564 2067  {name} --cloud g
+00024110: 6370 202d 7920 7465 7374 732f 736b 7973  cp -y tests/skys
+00024120: 6572 7665 2f73 706f 742f 6479 6e61 6d69  erve/spot/dynami
+00024130: 635f 6f6e 6465 6d61 6e64 5f66 616c 6c62  c_ondemand_fallb
+00024140: 6163 6b2e 7961 6d6c 272c 0a20 2020 2020  ack.yaml',.     
+00024150: 2020 2020 2020 2066 2773 6c65 6570 2034         f'sleep 4
+00024160: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+00024170: 2320 3220 6f6e 2d64 656d 616e 6420 2870  # 2 on-demand (p
+00024180: 726f 7669 7369 6f6e 696e 6729 202b 2032  rovisioning) + 2
+00024190: 2053 706f 7420 2870 726f 7669 7369 6f6e   Spot (provision
+000241a0: 696e 6729 2e0a 2020 2020 2020 2020 2020  ing)..          
+000241b0: 2020 6627 7b5f 5345 5256 455f 5354 4154    f'{_SERVE_STAT
+000241c0: 5553 5f57 4149 542e 666f 726d 6174 286e  US_WAIT.format(n
+000241d0: 616d 653d 6e61 6d65 297d 3b20 6563 686f  ame=name)}; echo
+000241e0: 2022 2473 223b 270a 2020 2020 2020 2020   "$s";'.        
+000241f0: 2020 2020 2765 6368 6f20 2224 7322 207c      'echo "$s" |
+00024200: 2067 7265 7020 2d71 2022 302f 3422 207c   grep -q "0/4" |
+00024210: 7c20 6578 6974 2031 272c 0a20 2020 2020  | exit 1',.     
+00024220: 2020 2020 2020 2023 2057 6169 7420 666f         # Wait fo
+00024230: 7220 7468 6520 7072 6f76 6973 696f 6e69  r the provisioni
+00024240: 6e67 2073 7461 7274 730a 2020 2020 2020  ng starts.      
+00024250: 2020 2020 2020 6627 736c 6565 7020 3430        f'sleep 40
+00024260: 272c 0a20 2020 2020 2020 2020 2020 205f  ',.            _
+00024270: 6368 6563 6b5f 7265 706c 6963 615f 696e  check_replica_in
+00024280: 5f73 7461 7475 7328 6e61 6d65 2c20 5b0a  _status(name, [.
+00024290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000242a0: 2832 2c20 5472 7565 2c20 5f53 4552 5649  (2, True, _SERVI
+000242b0: 4345 5f4c 4155 4e43 4849 4e47 5f53 5441  CE_LAUNCHING_STA
+000242c0: 5455 535f 5245 4745 5820 2b20 275c 7c52  TUS_REGEX + '\|R
+000242d0: 4541 4459 2729 2c0a 2020 2020 2020 2020  EADY'),.        
+000242e0: 2020 2020 2020 2020 2832 2c20 4661 6c73          (2, Fals
+000242f0: 652c 205f 5345 5256 4943 455f 4c41 554e  e, _SERVICE_LAUN
+00024300: 4348 494e 475f 5354 4154 5553 5f52 4547  CHING_STATUS_REG
+00024310: 4558 202b 2027 5c7c 5348 5554 5449 4e47  EX + '\|SHUTTING
+00024320: 5f44 4f57 4e27 290a 2020 2020 2020 2020  _DOWN').        
+00024330: 2020 2020 5d29 2c0a 0a20 2020 2020 2020      ]),..       
+00024340: 2020 2020 2023 2057 6169 7420 756e 7469       # Wait unti
+00024350: 6c20 3220 7370 6f74 2069 6e73 7461 6e63  l 2 spot instanc
+00024360: 6573 2061 7265 2072 6561 6479 2e0a 2020  es are ready..  
+00024370: 2020 2020 2020 2020 2020 5f53 4552 5645            _SERVE
+00024380: 5f57 4149 545f 554e 5449 4c5f 5245 4144  _WAIT_UNTIL_READ
+00024390: 592e 666f 726d 6174 286e 616d 653d 6e61  Y.format(name=na
+000243a0: 6d65 2c20 7265 706c 6963 615f 6e75 6d3d  me, replica_num=
+000243b0: 3229 2c0a 2020 2020 2020 2020 2020 2020  2),.            
+000243c0: 5f63 6865 636b 5f72 6570 6c69 6361 5f69  _check_replica_i
+000243d0: 6e5f 7374 6174 7573 286e 616d 652c 205b  n_status(name, [
+000243e0: 2832 2c20 5472 7565 2c20 2752 4541 4459  (2, True, 'READY
+000243f0: 2729 2c0a 2020 2020 2020 2020 2020 2020  '),.            
+00024400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024420: 2830 2c20 4661 6c73 652c 2027 2729 5d29  (0, False, '')])
+00024430: 2c0a 2020 2020 2020 2020 2020 2020 5f74  ,.            _t
+00024440: 6572 6d69 6e61 7465 5f67 6370 5f72 6570  erminate_gcp_rep
+00024450: 6c69 6361 286e 616d 652c 207a 6f6e 652c  lica(name, zone,
+00024460: 2031 292c 0a20 2020 2020 2020 2020 2020   1),.           
+00024470: 2066 2773 6c65 6570 2034 3027 2c0a 2020   f'sleep 40',.  
+00024480: 2020 2020 2020 2020 2020 2320 3120 6f6e            # 1 on
+00024490: 2d64 656d 616e 6420 2870 726f 7669 7369  -demand (provisi
+000244a0: 6f6e 696e 6729 202b 2031 2053 706f 7420  oning) + 1 Spot 
+000244b0: 2872 6561 6479 2920 2b20 3120 7370 6f74  (ready) + 1 spot
+000244c0: 2028 7072 6f76 6973 696f 6e69 6e67 292e   (provisioning).
+000244d0: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+000244e0: 5f53 4552 5645 5f53 5441 5455 535f 5741  _SERVE_STATUS_WA
+000244f0: 4954 2e66 6f72 6d61 7428 6e61 6d65 3d6e  IT.format(name=n
+00024500: 616d 6529 7d3b 2027 0a20 2020 2020 2020  ame)}; '.       
+00024510: 2020 2020 2027 6563 686f 2022 2473 2220       'echo "$s" 
+00024520: 7c20 6772 6570 202d 7120 2231 2f33 2227  | grep -q "1/3"'
+00024530: 2c0a 2020 2020 2020 2020 2020 2020 5f63  ,.            _c
+00024540: 6865 636b 5f72 6570 6c69 6361 5f69 6e5f  heck_replica_in_
+00024550: 7374 6174 7573 280a 2020 2020 2020 2020  status(.        
+00024560: 2020 2020 2020 2020 6e61 6d65 2c20 5b28          name, [(
+00024570: 312c 2054 7275 652c 2027 5245 4144 5927  1, True, 'READY'
+00024580: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00024590: 2020 2020 2020 2020 2020 2831 2c20 5472            (1, Tr
+000245a0: 7565 2c20 5f53 4552 5649 4345 5f4c 4155  ue, _SERVICE_LAU
+000245b0: 4e43 4849 4e47 5f53 5441 5455 535f 5245  NCHING_STATUS_RE
+000245c0: 4745 5829 2c0a 2020 2020 2020 2020 2020  GEX),.          
+000245d0: 2020 2020 2020 2020 2020 2020 2028 312c               (1,
+000245e0: 2046 616c 7365 2c20 5f53 4552 5649 4345   False, _SERVICE
+000245f0: 5f4c 4155 4e43 4849 4e47 5f53 5441 5455  _LAUNCHING_STATU
+00024600: 535f 5245 4745 5829 5d29 2c0a 0a20 2020  S_REGEX)]),..   
+00024610: 2020 2020 2020 2020 2023 2057 6169 7420           # Wait 
+00024620: 756e 7469 6c20 3220 7370 6f74 2069 6e73  until 2 spot ins
+00024630: 7461 6e63 6573 2061 7265 2072 6561 6479  tances are ready
+00024640: 2e0a 2020 2020 2020 2020 2020 2020 5f53  ..            _S
+00024650: 4552 5645 5f57 4149 545f 554e 5449 4c5f  ERVE_WAIT_UNTIL_
+00024660: 5245 4144 592e 666f 726d 6174 286e 616d  READY.format(nam
+00024670: 653d 6e61 6d65 2c20 7265 706c 6963 615f  e=name, replica_
+00024680: 6e75 6d3d 3229 2c0a 2020 2020 2020 2020  num=2),.        
+00024690: 2020 2020 5f63 6865 636b 5f72 6570 6c69      _check_repli
+000246a0: 6361 5f69 6e5f 7374 6174 7573 286e 616d  ca_in_status(nam
+000246b0: 652c 205b 2832 2c20 5472 7565 2c20 2752  e, [(2, True, 'R
+000246c0: 4541 4459 2729 2c0a 2020 2020 2020 2020  EADY'),.        
+000246d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000246e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000246f0: 2020 2020 2830 2c20 4661 6c73 652c 2027      (0, False, '
+00024700: 2729 5d29 2c0a 2020 2020 2020 2020 5d2c  ')]),.        ],
+00024710: 0a20 2020 2020 2020 205f 5445 4152 444f  .        _TEARDO
+00024720: 574e 5f53 4552 5649 4345 2e66 6f72 6d61  WN_SERVICE.forma
+00024730: 7428 6e61 6d65 3d6e 616d 6529 2c0a 2020  t(name=name),.  
+00024740: 2020 2020 2020 7469 6d65 6f75 743d 3230        timeout=20
+00024750: 202a 2036 302c 0a20 2020 2029 0a20 2020   * 60,.    ).   
+00024760: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+00024770: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+00024780: 726b 2e73 6572 7665 0a64 6566 2074 6573  rk.serve.def tes
+00024790: 745f 736b 7973 6572 7665 5f75 7365 725f  t_skyserve_user_
+000247a0: 6275 675f 7265 7374 6172 7428 6765 6e65  bug_restart(gene
+000247b0: 7269 635f 636c 6f75 643a 2073 7472 293a  ric_cloud: str):
+000247c0: 0a20 2020 2022 2222 5465 7374 7320 7468  .    """Tests th
+000247d0: 6174 2077 6520 7265 7374 6172 7420 7468  at we restart th
+000247e0: 6520 7365 7276 6963 6520 6166 7465 7220  e service after 
+000247f0: 7573 6572 2062 7567 2e22 2222 0a20 2020  user bug.""".   
+00024800: 2023 2054 4f44 4f28 7a68 7775 293a 2074   # TODO(zhwu): t
+00024810: 6869 7320 6265 6861 7669 6f72 206e 6565  his behavior nee
+00024820: 6473 2073 6f6d 6520 7265 7468 696e 6b69  ds some rethinki
+00024830: 6e67 2e0a 2020 2020 6e61 6d65 203d 205f  ng..    name = _
+00024840: 6765 745f 7365 7276 6963 655f 6e61 6d65  get_service_name
+00024850: 2829 0a20 2020 2074 6573 7420 3d20 5465  ().    test = Te
+00024860: 7374 280a 2020 2020 2020 2020 6627 7465  st(.        f'te
+00024870: 7374 2d73 6b79 7365 7276 652d 7573 6572  st-skyserve-user
+00024880: 2d62 7567 2d72 6573 7461 7274 272c 0a20  -bug-restart',. 
+00024890: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+000248a0: 2020 2020 2066 2773 6b79 2073 6572 7665       f'sky serve
+000248b0: 2075 7020 2d6e 207b 6e61 6d65 7d20 2d2d   up -n {name} --
+000248c0: 636c 6f75 6420 7b67 656e 6572 6963 5f63  cloud {generic_c
+000248d0: 6c6f 7564 7d20 2d79 2074 6573 7473 2f73  loud} -y tests/s
+000248e0: 6b79 7365 7276 652f 7265 7374 6172 742f  kyserve/restart/
+000248f0: 7573 6572 5f62 7567 2e79 616d 6c27 2c0a  user_bug.yaml',.
+00024900: 2020 2020 2020 2020 2020 2020 6627 733d              f's=
+00024910: 2428 736b 7920 7365 7276 6520 7374 6174  $(sky serve stat
+00024920: 7573 207b 6e61 6d65 7d29 3b20 6563 686f  us {name}); echo
+00024930: 2022 2473 223b 270a 2020 2020 2020 2020   "$s";'.        
+00024940: 2020 2020 2775 6e74 696c 2065 6368 6f20      'until echo 
+00024950: 2224 7322 207c 2067 7265 7020 2d41 2031  "$s" | grep -A 1
+00024960: 3030 2022 5365 7276 6963 6520 5265 706c  00 "Service Repl
+00024970: 6963 6173 2220 7c20 6772 6570 2022 5348  icas" | grep "SH
+00024980: 5554 5449 4e47 5f44 4f57 4e22 3b20 270a  UTTING_DOWN"; '.
+00024990: 2020 2020 2020 2020 2020 2020 2764 6f20              'do 
+000249a0: 6563 686f 2022 5761 6974 696e 6720 666f  echo "Waiting fo
+000249b0: 7220 6669 7273 7420 7365 7276 6963 6520  r first service 
+000249c0: 746f 2062 6520 5348 5554 5449 4e47 2044  to be SHUTTING D
+000249d0: 4f57 4e2e 2e2e 223b 2027 0a20 2020 2020  OWN..."; '.     
+000249e0: 2020 2020 2020 2066 2773 6c65 6570 2035         f'sleep 5
+000249f0: 3b20 733d 2428 736b 7920 7365 7276 6520  ; s=$(sky serve 
+00024a00: 7374 6174 7573 207b 6e61 6d65 7d29 3b20  status {name}); 
+00024a10: 6563 686f 2022 2473 223b 2064 6f6e 653b  echo "$s"; done;
+00024a20: 2027 2c0a 2020 2020 2020 2020 2020 2020   ',.            
+00024a30: 6627 733d 2428 736b 7920 7365 7276 6520  f's=$(sky serve 
+00024a40: 7374 6174 7573 207b 6e61 6d65 7d29 3b20  status {name}); 
+00024a50: 6563 686f 2022 2473 223b 270a 2020 2020  echo "$s";'.    
+00024a60: 2020 2020 2020 2020 2775 6e74 696c 2065          'until e
+00024a70: 6368 6f20 2224 7322 207c 2067 7265 7020  cho "$s" | grep 
+00024a80: 2d41 2031 3030 2022 5365 7276 6963 6520  -A 100 "Service 
+00024a90: 5265 706c 6963 6173 2220 7c20 6772 6570  Replicas" | grep
+00024aa0: 2022 4641 494c 4544 223b 2027 0a20 2020   "FAILED"; '.   
+00024ab0: 2020 2020 2020 2020 2027 646f 2065 6368           'do ech
+00024ac0: 6f20 2257 6169 7469 6e67 2066 6f72 2066  o "Waiting for f
+00024ad0: 6972 7374 2073 6572 7669 6365 2074 6f20  irst service to 
+00024ae0: 6265 2046 4149 4c45 442e 2e2e 223b 2027  be FAILED..."; '
+00024af0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00024b00: 6c65 6570 2035 3b20 733d 2428 736b 7920  leep 5; s=$(sky 
+00024b10: 7365 7276 6520 7374 6174 7573 207b 6e61  serve status {na
+00024b20: 6d65 7d29 3b20 6563 686f 2022 2473 223b  me}); echo "$s";
+00024b30: 2064 6f6e 653b 2065 6368 6f20 2224 7322   done; echo "$s"
+00024b40: 3b20 270a 2020 2020 2020 2020 2020 2020  ; '.            
+00024b50: 2b20 5f63 6865 636b 5f72 6570 6c69 6361  + _check_replica
+00024b60: 5f69 6e5f 7374 6174 7573 286e 616d 652c  _in_status(name,
+00024b70: 205b 2831 2c20 5472 7565 2c20 2746 4149   [(1, True, 'FAI
+00024b80: 4c45 4427 295d 2920 2b0a 2020 2020 2020  LED')]) +.      
+00024b90: 2020 2020 2020 2320 5573 6572 2062 7567        # User bug
+00024ba0: 2066 6169 6c75 7265 2077 696c 6c20 6361   failure will ca
+00024bb0: 7573 6520 6e6f 2066 7572 7468 6572 2073  use no further s
+00024bc0: 6361 6c69 6e67 2e0a 2020 2020 2020 2020  caling..        
+00024bd0: 2020 2020 6627 6563 686f 2022 2473 2220      f'echo "$s" 
+00024be0: 7c20 6772 6570 202d 4120 3130 3020 2253  | grep -A 100 "S
+00024bf0: 6572 7669 6365 2052 6570 6c69 6361 7322  ervice Replicas"
+00024c00: 207c 2067 7265 7020 227b 6e61 6d65 7d22   | grep "{name}"
+00024c10: 207c 2077 6320 2d6c 207c 2067 7265 7020   | wc -l | grep 
+00024c20: 313b 2027 0a20 2020 2020 2020 2020 2020  1; '.           
+00024c30: 2066 2765 6368 6f20 2224 7322 207c 2067   f'echo "$s" | g
+00024c40: 7265 7020 2d42 2031 3030 2022 4e4f 5f52  rep -B 100 "NO_R
+00024c50: 4550 4c49 4341 2220 7c20 6772 6570 2022  EPLICA" | grep "
+00024c60: 302f 3022 272c 0a20 2020 2020 2020 2020  0/0"',.         
+00024c70: 2020 2066 2773 6b79 2073 6572 7665 2075     f'sky serve u
+00024c80: 7064 6174 6520 7b6e 616d 657d 202d 2d63  pdate {name} --c
+00024c90: 6c6f 7564 207b 6765 6e65 7269 635f 636c  loud {generic_cl
+00024ca0: 6f75 647d 202d 7920 7465 7374 732f 736b  oud} -y tests/sk
+00024cb0: 7973 6572 7665 2f61 7574 6f5f 7265 7374  yserve/auto_rest
+00024cc0: 6172 742e 7961 6d6c 272c 0a20 2020 2020  art.yaml',.     
+00024cd0: 2020 2020 2020 2066 277b 5f53 4552 5645         f'{_SERVE
+00024ce0: 5f45 4e44 504f 494e 545f 5741 4954 2e66  _ENDPOINT_WAIT.f
+00024cf0: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
+00024d00: 7d3b 2027 0a20 2020 2020 2020 2020 2020  }; '.           
+00024d10: 2027 756e 7469 6c20 6375 726c 2068 7474   'until curl htt
+00024d20: 703a 2f2f 2465 6e64 706f 696e 7420 7c20  p://$endpoint | 
+00024d30: 6772 6570 2022 4869 2c20 536b 7950 696c  grep "Hi, SkyPil
+00024d40: 6f74 2068 6572 6521 223b 2064 6f20 736c  ot here!"; do sl
+00024d50: 6565 7020 323b 2064 6f6e 653b 2073 6c65  eep 2; done; sle
+00024d60: 6570 2032 3b20 270a 2020 2020 2020 2020  ep 2; '.        
+00024d70: 2020 2020 2b20 5f63 6865 636b 5f72 6570      + _check_rep
+00024d80: 6c69 6361 5f69 6e5f 7374 6174 7573 286e  lica_in_status(n
+00024d90: 616d 652c 205b 2831 2c20 4661 6c73 652c  ame, [(1, False,
+00024da0: 2027 5245 4144 5927 292c 0a20 2020 2020   'READY'),.     
+00024db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024dd0: 2020 2020 2020 2020 2028 312c 2046 616c           (1, Fal
+00024de0: 7365 2c20 2746 4149 4c45 4427 295d 292c  se, 'FAILED')]),
+00024df0: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+00024e00: 2020 2020 5f54 4541 5244 4f57 4e5f 5345      _TEARDOWN_SE
+00024e10: 5256 4943 452e 666f 726d 6174 286e 616d  RVICE.format(nam
+00024e20: 653d 6e61 6d65 292c 0a20 2020 2020 2020  e=name),.       
+00024e30: 2074 696d 656f 7574 3d32 3020 2a20 3630   timeout=20 * 60
+00024e40: 2c0a 2020 2020 290a 2020 2020 7275 6e5f  ,.    ).    run_
+00024e50: 6f6e 655f 7465 7374 2874 6573 7429 0a0a  one_test(test)..
+00024e60: 0a40 7079 7465 7374 2e6d 6172 6b2e 7365  .@pytest.mark.se
+00024e70: 7276 650a 4070 7974 6573 742e 6d61 726b  rve.@pytest.mark
+00024e80: 2e6e 6f5f 6b75 6265 726e 6574 6573 2020  .no_kubernetes  
+00024e90: 2320 5265 706c 6963 6173 206f 6e20 6b38  # Replicas on k8
+00024ea0: 7320 6d61 7920 6265 2072 756e 6e69 6e67  s may be running
+00024eb0: 206f 6e20 7468 6520 7361 6d65 206e 6f64   on the same nod
+00024ec0: 6520 616e 6420 6861 7665 2074 6865 2073  e and have the s
+00024ed0: 616d 6520 7075 626c 6963 2049 500a 6465  ame public IP.de
+00024ee0: 6620 7465 7374 5f73 6b79 7365 7276 655f  f test_skyserve_
+00024ef0: 6c6f 6164 5f62 616c 616e 6365 7228 6765  load_balancer(ge
+00024f00: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
+00024f10: 293a 0a20 2020 2022 2222 5465 7374 2073  ):.    """Test s
+00024f20: 6b79 7365 7276 6520 6c6f 6164 2062 616c  kyserve load bal
+00024f30: 616e 6365 7220 726f 756e 642d 726f 6269  ancer round-robi
+00024f40: 6e20 706f 6c69 6379 2222 220a 2020 2020  n policy""".    
+00024f50: 6e61 6d65 203d 205f 6765 745f 7365 7276  name = _get_serv
+00024f60: 6963 655f 6e61 6d65 2829 0a20 2020 2074  ice_name().    t
+00024f70: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+00024f80: 2020 2020 6627 7465 7374 2d73 6b79 7365      f'test-skyse
+00024f90: 7276 652d 6c6f 6164 2d62 616c 616e 6365  rve-load-balance
+00024fa0: 7227 2c0a 2020 2020 2020 2020 5b0a 2020  r',.        [.  
+00024fb0: 2020 2020 2020 2020 2020 6627 736b 7920            f'sky 
+00024fc0: 7365 7276 6520 7570 202d 6e20 7b6e 616d  serve up -n {nam
+00024fd0: 657d 202d 2d63 6c6f 7564 207b 6765 6e65  e} --cloud {gene
+00024fe0: 7269 635f 636c 6f75 647d 202d 7920 7465  ric_cloud} -y te
+00024ff0: 7374 732f 736b 7973 6572 7665 2f6c 6f61  sts/skyserve/loa
+00025000: 645f 6261 6c61 6e63 6572 2f73 6572 7669  d_balancer/servi
+00025010: 6365 2e79 616d 6c27 2c0a 2020 2020 2020  ce.yaml',.      
+00025020: 2020 2020 2020 5f53 4552 5645 5f57 4149        _SERVE_WAI
+00025030: 545f 554e 5449 4c5f 5245 4144 592e 666f  T_UNTIL_READY.fo
+00025040: 726d 6174 286e 616d 653d 6e61 6d65 2c20  rmat(name=name, 
+00025050: 7265 706c 6963 615f 6e75 6d3d 3329 2c0a  replica_num=3),.
+00025060: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+00025070: 5345 5256 455f 454e 4450 4f49 4e54 5f57  SERVE_ENDPOINT_W
+00025080: 4149 542e 666f 726d 6174 286e 616d 653d  AIT.format(name=
+00025090: 6e61 6d65 297d 3b20 270a 2020 2020 2020  name)}; '.      
+000250a0: 2020 2020 2020 6627 7b5f 5345 5256 455f        f'{_SERVE_
+000250b0: 5354 4154 5553 5f57 4149 542e 666f 726d  STATUS_WAIT.form
+000250c0: 6174 286e 616d 653d 6e61 6d65 297d 3b20  at(name=name)}; 
+000250d0: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
+000250e0: 7b5f 6765 745f 7265 706c 6963 615f 6970  {_get_replica_ip
+000250f0: 286e 616d 652c 2031 297d 3b20 270a 2020  (name, 1)}; '.  
+00025100: 2020 2020 2020 2020 2020 6627 7b5f 6765            f'{_ge
+00025110: 745f 7265 706c 6963 615f 6970 286e 616d  t_replica_ip(nam
+00025120: 652c 2032 297d 3b20 7b5f 6765 745f 7265  e, 2)}; {_get_re
+00025130: 706c 6963 615f 6970 286e 616d 652c 2033  plica_ip(name, 3
+00025140: 297d 3b20 270a 2020 2020 2020 2020 2020  )}; '.          
+00025150: 2020 2770 7974 686f 6e20 7465 7374 732f    'python tests/
+00025160: 736b 7973 6572 7665 2f6c 6f61 645f 6261  skyserve/load_ba
+00025170: 6c61 6e63 6572 2f74 6573 745f 726f 756e  lancer/test_roun
+00025180: 645f 726f 6269 6e2e 7079 2027 0a20 2020  d_robin.py '.   
+00025190: 2020 2020 2020 2020 2027 2d2d 656e 6470           '--endp
+000251a0: 6f69 6e74 2024 656e 6470 6f69 6e74 202d  oint $endpoint -
+000251b0: 2d72 6570 6c69 6361 2d6e 756d 2033 202d  -replica-num 3 -
+000251c0: 2d72 6570 6c69 6361 2d69 7073 2024 6970  -replica-ips $ip
+000251d0: 3120 2469 7032 2024 6970 3327 2c0a 2020  1 $ip2 $ip3',.  
+000251e0: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+000251f0: 205f 5445 4152 444f 574e 5f53 4552 5649   _TEARDOWN_SERVI
+00025200: 4345 2e66 6f72 6d61 7428 6e61 6d65 3d6e  CE.format(name=n
+00025210: 616d 6529 2c0a 2020 2020 2020 2020 7469  ame),.        ti
+00025220: 6d65 6f75 743d 3230 202a 2036 302c 0a20  meout=20 * 60,. 
+00025230: 2020 2029 0a20 2020 2072 756e 5f6f 6e65     ).    run_one
+00025240: 5f74 6573 7428 7465 7374 290a 0a0a 4070  _test(test)...@p
+00025250: 7974 6573 742e 6d61 726b 2e67 6370 0a40  ytest.mark.gcp.@
+00025260: 7079 7465 7374 2e6d 6172 6b2e 7365 7276  pytest.mark.serv
+00025270: 650a 4070 7974 6573 742e 6d61 726b 2e6e  e.@pytest.mark.n
+00025280: 6f5f 6b75 6265 726e 6574 6573 0a64 6566  o_kubernetes.def
+00025290: 2074 6573 745f 736b 7973 6572 7665 5f61   test_skyserve_a
+000252a0: 7574 6f5f 7265 7374 6172 7428 293a 0a20  uto_restart():. 
+000252b0: 2020 2022 2222 5465 7374 2073 6b79 7365     """Test skyse
+000252c0: 7276 6520 7769 7468 2061 7574 6f20 7265  rve with auto re
+000252d0: 7374 6172 7422 2222 0a20 2020 206e 616d  start""".    nam
+000252e0: 6520 3d20 5f67 6574 5f73 6572 7669 6365  e = _get_service
+000252f0: 5f6e 616d 6528 290a 2020 2020 7a6f 6e65  _name().    zone
+00025300: 203d 2027 7573 2d63 656e 7472 616c 312d   = 'us-central1-
+00025310: 6127 0a20 2020 2074 6573 7420 3d20 5465  a'.    test = Te
+00025320: 7374 280a 2020 2020 2020 2020 6627 7465  st(.        f'te
+00025330: 7374 2d73 6b79 7365 7276 652d 6175 746f  st-skyserve-auto
+00025340: 2d72 6573 7461 7274 272c 0a20 2020 2020  -restart',.     
+00025350: 2020 205b 0a20 2020 2020 2020 2020 2020     [.           
+00025360: 2023 2054 4f44 4f28 7469 616e 293a 2077   # TODO(tian): w
+00025370: 6520 6361 6e20 6479 6e61 6d69 6361 6c6c  e can dynamicall
+00025380: 7920 6765 6e65 7261 7465 2059 414d 4c20  y generate YAML 
+00025390: 6672 6f6d 2074 656d 706c 6174 6520 746f  from template to
+000253a0: 0a20 2020 2020 2020 2020 2020 2023 2061  .            # a
+000253b0: 766f 6964 206d 6169 6e74 6169 6e69 6e67  void maintaining
+000253c0: 2074 6f6f 206d 616e 7920 5941 4d4c 2066   too many YAML f
+000253d0: 696c 6573 0a20 2020 2020 2020 2020 2020  iles.           
+000253e0: 2066 2773 6b79 2073 6572 7665 2075 7020   f'sky serve up 
+000253f0: 2d6e 207b 6e61 6d65 7d20 2d79 2074 6573  -n {name} -y tes
+00025400: 7473 2f73 6b79 7365 7276 652f 6175 746f  ts/skyserve/auto
+00025410: 5f72 6573 7461 7274 2e79 616d 6c27 2c0a  _restart.yaml',.
+00025420: 2020 2020 2020 2020 2020 2020 5f53 4552              _SER
+00025430: 5645 5f57 4149 545f 554e 5449 4c5f 5245  VE_WAIT_UNTIL_RE
+00025440: 4144 592e 666f 726d 6174 286e 616d 653d  ADY.format(name=
+00025450: 6e61 6d65 2c20 7265 706c 6963 615f 6e75  name, replica_nu
+00025460: 6d3d 3129 2c0a 2020 2020 2020 2020 2020  m=1),.          
+00025470: 2020 6627 7b5f 5345 5256 455f 454e 4450    f'{_SERVE_ENDP
+00025480: 4f49 4e54 5f57 4149 542e 666f 726d 6174  OINT_WAIT.format
+00025490: 286e 616d 653d 6e61 6d65 297d 3b20 270a  (name=name)}; '.
+000254a0: 2020 2020 2020 2020 2020 2020 2772 6571              'req
+000254b0: 7565 7374 5f6f 7574 7075 743d 2428 6375  uest_output=$(cu
+000254c0: 726c 2068 7474 703a 2f2f 2465 6e64 706f  rl http://$endpo
+000254d0: 696e 7429 3b20 6563 686f 2022 2472 6571  int); echo "$req
+000254e0: 7565 7374 5f6f 7574 7075 7422 3b20 6563  uest_output"; ec
+000254f0: 686f 2022 2472 6571 7565 7374 5f6f 7574  ho "$request_out
+00025500: 7075 7422 207c 2067 7265 7020 2248 692c  put" | grep "Hi,
+00025510: 2053 6b79 5069 6c6f 7420 6865 7265 2227   SkyPilot here"'
+00025520: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+00025530: 736c 6565 7020 666f 7220 3230 2073 6563  sleep for 20 sec
+00025540: 6f6e 6473 2028 696e 6974 6961 6c20 6465  onds (initial de
+00025550: 6c61 7929 2074 6f20 6d61 6b65 2073 7572  lay) to make sur
+00025560: 6520 6974 2077 696c 6c0a 2020 2020 2020  e it will.      
+00025570: 2020 2020 2020 2320 6265 2072 6573 7461        # be resta
+00025580: 7274 6564 0a20 2020 2020 2020 2020 2020  rted.           
+00025590: 2066 2773 6c65 6570 2032 3027 2c0a 2020   f'sleep 20',.  
+000255a0: 2020 2020 2020 2020 2020 5f74 6572 6d69            _termi
+000255b0: 6e61 7465 5f67 6370 5f72 6570 6c69 6361  nate_gcp_replica
+000255c0: 286e 616d 652c 207a 6f6e 652c 2031 292c  (name, zone, 1),
+000255d0: 0a20 2020 2020 2020 2020 2020 2023 2057  .            # W
+000255e0: 6169 7420 666f 7220 636f 6e73 6563 7574  ait for consecut
+000255f0: 6976 6520 6661 696c 7572 6520 7469 6d65  ive failure time
+00025600: 6f75 7420 7061 7373 6564 2e0a 2020 2020  out passed..    
+00025610: 2020 2020 2020 2020 2320 4966 2074 6865          # If the
+00025620: 2063 6c75 7374 6572 2069 7320 6e6f 7420   cluster is not 
+00025630: 7573 696e 6720 7370 6f74 2c20 6974 2077  using spot, it w
+00025640: 6f6e 2774 2063 6865 636b 2074 6865 2063  on't check the c
+00025650: 6c75 7374 6572 2073 7461 7475 730a 2020  luster status.  
+00025660: 2020 2020 2020 2020 2020 2320 6f6e 2074            # on t
+00025670: 6865 2063 6c6f 7564 2028 7369 6e63 6520  he cloud (since 
+00025680: 6d61 6e75 616c 2073 6875 7464 6f77 6e20  manual shutdown 
+00025690: 6973 206e 6f74 2061 2063 6f6d 6d6f 6e20  is not a common 
+000256a0: 6265 6861 7669 6f72 2061 6e64 2073 7563  behavior and suc
+000256b0: 680a 2020 2020 2020 2020 2020 2020 2320  h.            # 
+000256c0: 7175 6572 6965 7320 7461 6b65 7320 6120  queries takes a 
+000256d0: 6c6f 7420 6f66 2074 696d 6529 2e20 496e  lot of time). In
+000256e0: 7374 6561 642c 2077 6520 7468 696e 6b20  stead, we think 
+000256f0: 636f 6e74 696e 756f 7573 2033 206d 696e  continuous 3 min
+00025700: 2070 726f 6265 0a20 2020 2020 2020 2020   probe.         
+00025710: 2020 2023 2066 6169 6c75 7265 2069 7320     # failure is 
+00025720: 6e6f 7420 6120 7465 6d70 6f72 6172 7920  not a temporary 
+00025730: 7072 6f62 6c65 6d20 6275 7420 696e 6465  problem but inde
+00025740: 6564 2061 2066 6169 6c75 7265 2e0a 2020  ed a failure..  
+00025750: 2020 2020 2020 2020 2020 2773 6c65 6570            'sleep
+00025760: 2031 3830 272c 0a20 2020 2020 2020 2020   180',.         
+00025770: 2020 2023 2057 6520 6361 6e6e 6f74 2075     # We cannot u
+00025780: 7365 205f 5345 5256 455f 5741 4954 5f55  se _SERVE_WAIT_U
+00025790: 4e54 494c 5f52 4541 4459 3b20 7468 6572  NTIL_READY; ther
+000257a0: 6520 7769 6c6c 2062 6520 6120 696e 7465  e will be a inte
+000257b0: 726d 6564 6961 7465 2074 696d 650a 2020  rmediate time.  
+000257c0: 2020 2020 2020 2020 2020 2320 7468 6174            # that
+000257d0: 2074 6865 206f 7574 7075 7420 6f66 2060   the output of `
+000257e0: 736b 7920 7365 7276 6520 7374 6174 7573  sky serve status
+000257f0: 6020 7368 6f77 7320 4641 494c 4544 2061  ` shows FAILED a
+00025800: 6e64 2074 6869 7320 7374 6174 7573 2077  nd this status w
+00025810: 696c 6c0a 2020 2020 2020 2020 2020 2020  ill.            
+00025820: 2320 6361 7573 6520 5f53 4552 5645 5f57  # cause _SERVE_W
+00025830: 4149 545f 554e 5449 4c5f 5245 4144 5920  AIT_UNTIL_READY 
+00025840: 746f 2065 6172 6c79 2071 7569 742e 0a20  to early quit.. 
+00025850: 2020 2020 2020 2020 2020 2027 2877 6869             '(whi
+00025860: 6c65 2074 7275 653b 2064 6f27 0a20 2020  le true; do'.   
+00025870: 2020 2020 2020 2020 2066 2720 2020 206f           f'    o
+00025880: 7574 7075 743d 2428 736b 7920 7365 7276  utput=$(sky serv
+00025890: 6520 7374 6174 7573 207b 6e61 6d65 7d29  e status {name})
+000258a0: 3b27 0a20 2020 2020 2020 2020 2020 2027  ;'.            '
+000258b0: 2020 2020 2065 6368 6f20 2224 6f75 7470       echo "$outp
+000258c0: 7574 2220 7c20 6772 6570 202d 7120 2231  ut" | grep -q "1
+000258d0: 2f31 2220 2626 2062 7265 616b 3b27 0a20  /1" && break;'. 
+000258e0: 2020 2020 2020 2020 2020 2027 2020 2020             '    
+000258f0: 2073 6c65 6570 2031 303b 270a 2020 2020   sleep 10;'.    
+00025900: 2020 2020 2020 2020 6627 646f 6e65 293b          f'done);
+00025910: 2073 6c65 6570 207b 7365 7276 652e 4c42   sleep {serve.LB
+00025920: 5f43 4f4e 5452 4f4c 4c45 525f 5359 4e43  _CONTROLLER_SYNC
+00025930: 5f49 4e54 4552 5641 4c5f 5345 434f 4e44  _INTERVAL_SECOND
+00025940: 537d 3b27 2c0a 2020 2020 2020 2020 2020  S};',.          
+00025950: 2020 6627 7b5f 5345 5256 455f 454e 4450    f'{_SERVE_ENDP
+00025960: 4f49 4e54 5f57 4149 542e 666f 726d 6174  OINT_WAIT.format
+00025970: 286e 616d 653d 6e61 6d65 297d 3b20 270a  (name=name)}; '.
+00025980: 2020 2020 2020 2020 2020 2020 2772 6571              'req
+00025990: 7565 7374 5f6f 7574 7075 743d 2428 6375  uest_output=$(cu
+000259a0: 726c 2068 7474 703a 2f2f 2465 6e64 706f  rl http://$endpo
+000259b0: 696e 7429 3b20 6563 686f 2022 2472 6571  int); echo "$req
+000259c0: 7565 7374 5f6f 7574 7075 7422 3b20 6563  uest_output"; ec
+000259d0: 686f 2022 2472 6571 7565 7374 5f6f 7574  ho "$request_out
+000259e0: 7075 7422 207c 2067 7265 7020 2248 692c  put" | grep "Hi,
+000259f0: 2053 6b79 5069 6c6f 7420 6865 7265 2227   SkyPilot here"'
+00025a00: 2c0a 2020 2020 2020 2020 5d2c 0a20 2020  ,.        ],.   
+00025a10: 2020 2020 205f 5445 4152 444f 574e 5f53       _TEARDOWN_S
+00025a20: 4552 5649 4345 2e66 6f72 6d61 7428 6e61  ERVICE.format(na
+00025a30: 6d65 3d6e 616d 6529 2c0a 2020 2020 2020  me=name),.      
+00025a40: 2020 7469 6d65 6f75 743d 3230 202a 2036    timeout=20 * 6
+00025a50: 302c 0a20 2020 2029 0a20 2020 2072 756e  0,.    ).    run
+00025a60: 5f6f 6e65 5f74 6573 7428 7465 7374 290a  _one_test(test).
+00025a70: 0a0a 4070 7974 6573 742e 6d61 726b 2e73  ..@pytest.mark.s
+00025a80: 6572 7665 0a64 6566 2074 6573 745f 736b  erve.def test_sk
+00025a90: 7973 6572 7665 5f63 616e 6365 6c28 6765  yserve_cancel(ge
+00025aa0: 6e65 7269 635f 636c 6f75 643a 2073 7472  neric_cloud: str
+00025ab0: 293a 0a20 2020 2022 2222 5465 7374 2073  ):.    """Test s
+00025ac0: 6b79 7365 7276 6520 7769 7468 2063 616e  kyserve with can
+00025ad0: 6365 6c22 2222 0a20 2020 206e 616d 6520  cel""".    name 
+00025ae0: 3d20 5f67 6574 5f73 6572 7669 6365 5f6e  = _get_service_n
+00025af0: 616d 6528 290a 0a20 2020 2074 6573 7420  ame()..    test 
+00025b00: 3d20 5465 7374 280a 2020 2020 2020 2020  = Test(.        
+00025b10: 6627 7465 7374 2d73 6b79 7365 7276 652d  f'test-skyserve-
+00025b20: 6361 6e63 656c 272c 0a20 2020 2020 2020  cancel',.       
+00025b30: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+00025b40: 2773 6b79 2073 6572 7665 2075 7020 2d6e  'sky serve up -n
+00025b50: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+00025b60: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
+00025b70: 2d79 2074 6573 7473 2f73 6b79 7365 7276  -y tests/skyserv
+00025b80: 652f 6361 6e63 656c 2f63 616e 6365 6c2e  e/cancel/cancel.
+00025b90: 7961 6d6c 272c 0a20 2020 2020 2020 2020  yaml',.         
+00025ba0: 2020 205f 5345 5256 455f 5741 4954 5f55     _SERVE_WAIT_U
+00025bb0: 4e54 494c 5f52 4541 4459 2e66 6f72 6d61  NTIL_READY.forma
+00025bc0: 7428 6e61 6d65 3d6e 616d 652c 2072 6570  t(name=name, rep
+00025bd0: 6c69 6361 5f6e 756d 3d31 292c 0a20 2020  lica_num=1),.   
+00025be0: 2020 2020 2020 2020 2066 277b 5f53 4552           f'{_SER
+00025bf0: 5645 5f45 4e44 504f 494e 545f 5741 4954  VE_ENDPOINT_WAIT
+00025c00: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
+00025c10: 6529 7d3b 2070 7974 686f 6e33 2027 0a20  e)}; python3 '. 
+00025c20: 2020 2020 2020 2020 2020 2027 7465 7374             'test
+00025c30: 732f 736b 7973 6572 7665 2f63 616e 6365  s/skyserve/cance
+00025c40: 6c2f 7365 6e64 5f63 616e 6365 6c5f 7265  l/send_cancel_re
+00025c50: 7175 6573 742e 7079 2027 0a20 2020 2020  quest.py '.     
+00025c60: 2020 2020 2020 2027 2d2d 656e 6470 6f69         '--endpoi
+00025c70: 6e74 2024 656e 6470 6f69 6e74 207c 2067  nt $endpoint | g
+00025c80: 7265 7020 2252 6571 7565 7374 2077 6173  rep "Request was
+00025c90: 2063 616e 6365 6c6c 6564 2227 2c0a 2020   cancelled"',.  
+00025ca0: 2020 2020 2020 2020 2020 6627 733d 2428            f's=$(
+00025cb0: 736b 7920 7365 7276 6520 6c6f 6773 207b  sky serve logs {
+00025cc0: 6e61 6d65 7d20 3120 2d2d 6e6f 2d66 6f6c  name} 1 --no-fol
+00025cd0: 6c6f 7729 3b20 270a 2020 2020 2020 2020  low); '.        
+00025ce0: 2020 2020 2775 6e74 696c 2021 2065 6368      'until ! ech
+00025cf0: 6f20 2224 7322 207c 2067 7265 7020 2250  o "$s" | grep "P
+00025d00: 6c65 6173 6520 7761 6974 2066 6f72 2074  lease wait for t
+00025d10: 6865 2063 6f6e 7472 6f6c 6c65 7220 746f  he controller to
+00025d20: 2062 6522 3b20 270a 2020 2020 2020 2020   be"; '.        
+00025d30: 2020 2020 2764 6f20 6563 686f 2022 5761      'do echo "Wa
+00025d40: 6974 696e 6720 666f 7220 7365 7276 6520  iting for serve 
+00025d50: 6c6f 6773 223b 2073 6c65 6570 2031 303b  logs"; sleep 10;
+00025d60: 2027 0a20 2020 2020 2020 2020 2020 2066   '.            f
+00025d70: 2773 3d24 2873 6b79 2073 6572 7665 206c  's=$(sky serve l
+00025d80: 6f67 7320 7b6e 616d 657d 2031 202d 2d6e  ogs {name} 1 --n
+00025d90: 6f2d 666f 6c6c 6f77 293b 2064 6f6e 653b  o-follow); done;
+00025da0: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
+00025db0: 6563 686f 2022 2473 223b 2065 6368 6f20  echo "$s"; echo 
+00025dc0: 2224 7322 207c 2067 7265 7020 2243 6c69  "$s" | grep "Cli
+00025dd0: 656e 7420 6469 7363 6f6e 6e65 6374 6564  ent disconnected
+00025de0: 2c20 7374 6f70 7069 6e67 2063 6f6d 7075  , stopping compu
+00025df0: 7461 7469 6f6e 2227 2c0a 2020 2020 2020  tation"',.      
+00025e00: 2020 5d2c 0a20 2020 2020 2020 205f 5445    ],.        _TE
+00025e10: 4152 444f 574e 5f53 4552 5649 4345 2e66  ARDOWN_SERVICE.f
+00025e20: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
+00025e30: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
+00025e40: 743d 3230 202a 2036 302c 0a20 2020 2029  t=20 * 60,.    )
+00025e50: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00025e60: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
+00025e70: 742e 6d61 726b 2e73 6572 7665 0a64 6566  t.mark.serve.def
+00025e80: 2074 6573 745f 736b 7973 6572 7665 5f73   test_skyserve_s
+00025e90: 7472 6561 6d69 6e67 2867 656e 6572 6963  treaming(generic
+00025ea0: 5f63 6c6f 7564 3a20 7374 7229 3a0a 2020  _cloud: str):.  
+00025eb0: 2020 2222 2254 6573 7420 736b 7973 6572    """Test skyser
+00025ec0: 7665 2077 6974 6820 7374 7265 616d 696e  ve with streamin
+00025ed0: 6722 2222 0a20 2020 206e 616d 6520 3d20  g""".    name = 
+00025ee0: 5f67 6574 5f73 6572 7669 6365 5f6e 616d  _get_service_nam
+00025ef0: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
+00025f00: 6573 7428 0a20 2020 2020 2020 2066 2774  est(.        f't
+00025f10: 6573 742d 736b 7973 6572 7665 2d73 7472  est-skyserve-str
+00025f20: 6561 6d69 6e67 272c 0a20 2020 2020 2020  eaming',.       
+00025f30: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+00025f40: 2773 6b79 2073 6572 7665 2075 7020 2d6e  'sky serve up -n
+00025f50: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+00025f60: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
+00025f70: 2d79 2074 6573 7473 2f73 6b79 7365 7276  -y tests/skyserv
+00025f80: 652f 7374 7265 616d 696e 672f 7374 7265  e/streaming/stre
+00025f90: 616d 696e 672e 7961 6d6c 272c 0a20 2020  aming.yaml',.   
+00025fa0: 2020 2020 2020 2020 205f 5345 5256 455f           _SERVE_
+00025fb0: 5741 4954 5f55 4e54 494c 5f52 4541 4459  WAIT_UNTIL_READY
+00025fc0: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
+00025fd0: 652c 2072 6570 6c69 6361 5f6e 756d 3d31  e, replica_num=1
+00025fe0: 292c 0a20 2020 2020 2020 2020 2020 2066  ),.            f
+00025ff0: 277b 5f53 4552 5645 5f45 4e44 504f 494e  '{_SERVE_ENDPOIN
+00026000: 545f 5741 4954 2e66 6f72 6d61 7428 6e61  T_WAIT.format(na
+00026010: 6d65 3d6e 616d 6529 7d3b 2027 0a20 2020  me=name)}; '.   
+00026020: 2020 2020 2020 2020 2027 7079 7468 6f6e           'python
+00026030: 3320 7465 7374 732f 736b 7973 6572 7665  3 tests/skyserve
+00026040: 2f73 7472 6561 6d69 6e67 2f73 656e 645f  /streaming/send_
+00026050: 7374 7265 616d 696e 675f 7265 7175 6573  streaming_reques
+00026060: 742e 7079 2027 0a20 2020 2020 2020 2020  t.py '.         
+00026070: 2020 2027 2d2d 656e 6470 6f69 6e74 2024     '--endpoint $
+00026080: 656e 6470 6f69 6e74 207c 2067 7265 7020  endpoint | grep 
+00026090: 2253 7472 6561 6d69 6e67 2074 6573 7420  "Streaming test 
+000260a0: 7061 7373 6564 2227 2c0a 2020 2020 2020  passed"',.      
+000260b0: 2020 5d2c 0a20 2020 2020 2020 205f 5445    ],.        _TE
+000260c0: 4152 444f 574e 5f53 4552 5649 4345 2e66  ARDOWN_SERVICE.f
+000260d0: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
+000260e0: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
+000260f0: 743d 3230 202a 2036 302c 0a20 2020 2029  t=20 * 60,.    )
+00026100: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00026110: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
+00026120: 742e 6d61 726b 2e73 6572 7665 0a64 6566  t.mark.serve.def
+00026130: 2074 6573 745f 736b 7973 6572 7665 5f75   test_skyserve_u
+00026140: 7064 6174 6528 6765 6e65 7269 635f 636c  pdate(generic_cl
+00026150: 6f75 643a 2073 7472 293a 0a20 2020 2022  oud: str):.    "
+00026160: 2222 5465 7374 2073 6b79 7365 7276 6520  ""Test skyserve 
+00026170: 7769 7468 2075 7064 6174 6522 2222 0a20  with update""". 
+00026180: 2020 206e 616d 6520 3d20 5f67 6574 5f73     name = _get_s
+00026190: 6572 7669 6365 5f6e 616d 6528 290a 2020  ervice_name().  
+000261a0: 2020 7465 7374 203d 2054 6573 7428 0a20    test = Test(. 
+000261b0: 2020 2020 2020 2066 2774 6573 742d 736b         f'test-sk
+000261c0: 7973 6572 7665 2d75 7064 6174 6527 2c0a  yserve-update',.
+000261d0: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
+000261e0: 2020 2020 2020 6627 736b 7920 7365 7276        f'sky serv
+000261f0: 6520 7570 202d 6e20 7b6e 616d 657d 202d  e up -n {name} -
+00026200: 2d63 6c6f 7564 207b 6765 6e65 7269 635f  -cloud {generic_
+00026210: 636c 6f75 647d 202d 7920 7465 7374 732f  cloud} -y tests/
+00026220: 736b 7973 6572 7665 2f75 7064 6174 652f  skyserve/update/
+00026230: 6f6c 642e 7961 6d6c 272c 0a20 2020 2020  old.yaml',.     
+00026240: 2020 2020 2020 205f 5345 5256 455f 5741         _SERVE_WA
+00026250: 4954 5f55 4e54 494c 5f52 4541 4459 2e66  IT_UNTIL_READY.f
+00026260: 6f72 6d61 7428 6e61 6d65 3d6e 616d 652c  ormat(name=name,
+00026270: 2072 6570 6c69 6361 5f6e 756d 3d32 292c   replica_num=2),
+00026280: 0a20 2020 2020 2020 2020 2020 2066 277b  .            f'{
+00026290: 5f53 4552 5645 5f45 4e44 504f 494e 545f  _SERVE_ENDPOINT_
+000262a0: 5741 4954 2e66 6f72 6d61 7428 6e61 6d65  WAIT.format(name
+000262b0: 3d6e 616d 6529 7d3b 2063 7572 6c20 6874  =name)}; curl ht
+000262c0: 7470 3a2f 2f24 656e 6470 6f69 6e74 207c  tp://$endpoint |
+000262d0: 2067 7265 7020 2248 692c 2053 6b79 5069   grep "Hi, SkyPi
+000262e0: 6c6f 7420 6865 7265 2227 2c0a 2020 2020  lot here"',.    
+000262f0: 2020 2020 2020 2020 6627 736b 7920 7365          f'sky se
+00026300: 7276 6520 7570 6461 7465 207b 6e61 6d65  rve update {name
+00026310: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
+00026320: 6963 5f63 6c6f 7564 7d20 2d2d 6d6f 6465  ic_cloud} --mode
+00026330: 2062 6c75 655f 6772 6565 6e20 2d79 2074   blue_green -y t
+00026340: 6573 7473 2f73 6b79 7365 7276 652f 7570  ests/skyserve/up
+00026350: 6461 7465 2f6e 6577 2e79 616d 6c27 2c0a  date/new.yaml',.
+00026360: 2020 2020 2020 2020 2020 2020 2320 736c              # sl
+00026370: 6565 7020 6265 666f 7265 2075 7064 6174  eep before updat
+00026380: 6520 6973 2072 6567 6973 7465 7265 642e  e is registered.
+00026390: 0a20 2020 2020 2020 2020 2020 2027 736c  .            'sl
+000263a0: 6565 7020 3230 272c 0a20 2020 2020 2020  eep 20',.       
+000263b0: 2020 2020 2066 277b 5f53 4552 5645 5f45       f'{_SERVE_E
+000263c0: 4e44 504f 494e 545f 5741 4954 2e66 6f72  NDPOINT_WAIT.for
+000263d0: 6d61 7428 6e61 6d65 3d6e 616d 6529 7d3b  mat(name=name)};
+000263e0: 2027 0a20 2020 2020 2020 2020 2020 2027   '.            '
+000263f0: 756e 7469 6c20 6375 726c 2068 7474 703a  until curl http:
+00026400: 2f2f 2465 6e64 706f 696e 7420 7c20 6772  //$endpoint | gr
+00026410: 6570 2022 4869 2c20 6e65 7720 536b 7950  ep "Hi, new SkyP
+00026420: 696c 6f74 2068 6572 6521 223b 2064 6f20  ilot here!"; do 
+00026430: 736c 6565 7020 323b 2064 6f6e 653b 270a  sleep 2; done;'.
+00026440: 2020 2020 2020 2020 2020 2020 2320 4d61              # Ma
+00026450: 6b65 2073 7572 6520 7468 6520 7472 6166  ke sure the traf
+00026460: 6669 6320 6973 206e 6f74 206d 6978 6564  fic is not mixed
+00026470: 0a20 2020 2020 2020 2020 2020 2027 6375  .            'cu
+00026480: 726c 2068 7474 703a 2f2f 2465 6e64 706f  rl http://$endpo
+00026490: 696e 7420 7c20 6772 6570 2022 4869 2c20  int | grep "Hi, 
+000264a0: 6e65 7720 536b 7950 696c 6f74 2068 6572  new SkyPilot her
+000264b0: 6522 272c 0a20 2020 2020 2020 2020 2020  e"',.           
+000264c0: 2023 2054 6865 206c 6174 6573 7420 3220   # The latest 2 
+000264d0: 7665 7273 696f 6e20 7368 6f75 6c64 2062  version should b
+000264e0: 6520 5245 4144 5920 616e 6420 7468 6520  e READY and the 
+000264f0: 6f6c 6465 7220 7665 7273 696f 6e73 2073  older versions s
+00026500: 686f 756c 6420 6265 2073 6875 7474 696e  hould be shuttin
+00026510: 6720 646f 776e 0a20 2020 2020 2020 2020  g down.         
+00026520: 2020 2028 5f63 6865 636b 5f72 6570 6c69     (_check_repli
+00026530: 6361 5f69 6e5f 7374 6174 7573 286e 616d  ca_in_status(nam
+00026540: 652c 205b 2832 2c20 4661 6c73 652c 2027  e, [(2, False, '
+00026550: 5245 4144 5927 292c 0a20 2020 2020 2020  READY'),.       
+00026560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026580: 2020 2020 2020 2832 2c20 4661 6c73 652c        (2, False,
+00026590: 2027 5348 5554 5449 4e47 5f44 4f57 4e27   'SHUTTING_DOWN'
+000265a0: 295d 2920 2b0a 2020 2020 2020 2020 2020  )]) +.          
+000265b0: 2020 205f 6368 6563 6b5f 7365 7276 6963     _check_servic
+000265c0: 655f 7665 7273 696f 6e28 6e61 6d65 2c20  e_version(name, 
+000265d0: 2232 2229 292c 0a20 2020 2020 2020 205d  "2")),.        ]
+000265e0: 2c0a 2020 2020 2020 2020 5f54 4541 5244  ,.        _TEARD
+000265f0: 4f57 4e5f 5345 5256 4943 452e 666f 726d  OWN_SERVICE.form
+00026600: 6174 286e 616d 653d 6e61 6d65 292c 0a20  at(name=name),. 
+00026610: 2020 2020 2020 2074 696d 656f 7574 3d32         timeout=2
+00026620: 3020 2a20 3630 2c0a 2020 2020 290a 2020  0 * 60,.    ).  
+00026630: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00026640: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+00026650: 6172 6b2e 7365 7276 650a 6465 6620 7465  ark.serve.def te
+00026660: 7374 5f73 6b79 7365 7276 655f 726f 6c6c  st_skyserve_roll
+00026670: 696e 675f 7570 6461 7465 2867 656e 6572  ing_update(gener
+00026680: 6963 5f63 6c6f 7564 3a20 7374 7229 3a0a  ic_cloud: str):.
+00026690: 2020 2020 2222 2254 6573 7420 736b 7973      """Test skys
+000266a0: 6572 7665 2077 6974 6820 726f 6c6c 696e  erve with rollin
+000266b0: 6720 7570 6461 7465 2222 220a 2020 2020  g update""".    
+000266c0: 6e61 6d65 203d 205f 6765 745f 7365 7276  name = _get_serv
+000266d0: 6963 655f 6e61 6d65 2829 0a20 2020 2073  ice_name().    s
+000266e0: 696e 676c 655f 6e65 775f 7265 706c 6963  ingle_new_replic
+000266f0: 6120 3d20 5f63 6865 636b 5f72 6570 6c69  a = _check_repli
+00026700: 6361 5f69 6e5f 7374 6174 7573 280a 2020  ca_in_status(.  
+00026710: 2020 2020 2020 6e61 6d65 2c20 5b28 322c        name, [(2,
+00026720: 2046 616c 7365 2c20 2752 4541 4459 2729   False, 'READY')
+00026730: 2c20 2831 2c20 4661 6c73 652c 205f 5345  , (1, False, _SE
+00026740: 5256 4943 455f 4c41 554e 4348 494e 475f  RVICE_LAUNCHING_
+00026750: 5354 4154 5553 5f52 4547 4558 292c 0a20  STATUS_REGEX),. 
+00026760: 2020 2020 2020 2020 2020 2020 2020 2831                (1
+00026770: 2c20 4661 6c73 652c 2027 5348 5554 5449  , False, 'SHUTTI
+00026780: 4e47 5f44 4f57 4e27 295d 290a 2020 2020  NG_DOWN')]).    
+00026790: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+000267a0: 2020 2020 2066 2774 6573 742d 736b 7973       f'test-skys
+000267b0: 6572 7665 2d72 6f6c 6c69 6e67 2d75 7064  erve-rolling-upd
+000267c0: 6174 6527 2c0a 2020 2020 2020 2020 5b0a  ate',.        [.
+000267d0: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+000267e0: 7920 7365 7276 6520 7570 202d 6e20 7b6e  y serve up -n {n
+000267f0: 616d 657d 202d 2d63 6c6f 7564 207b 6765  ame} --cloud {ge
+00026800: 6e65 7269 635f 636c 6f75 647d 202d 7920  neric_cloud} -y 
+00026810: 7465 7374 732f 736b 7973 6572 7665 2f75  tests/skyserve/u
+00026820: 7064 6174 652f 6f6c 642e 7961 6d6c 272c  pdate/old.yaml',
+00026830: 0a20 2020 2020 2020 2020 2020 205f 5345  .            _SE
+00026840: 5256 455f 5741 4954 5f55 4e54 494c 5f52  RVE_WAIT_UNTIL_R
+00026850: 4541 4459 2e66 6f72 6d61 7428 6e61 6d65  EADY.format(name
+00026860: 3d6e 616d 652c 2072 6570 6c69 6361 5f6e  =name, replica_n
+00026870: 756d 3d32 292c 0a20 2020 2020 2020 2020  um=2),.         
+00026880: 2020 2066 277b 5f53 4552 5645 5f45 4e44     f'{_SERVE_END
+00026890: 504f 494e 545f 5741 4954 2e66 6f72 6d61  POINT_WAIT.forma
+000268a0: 7428 6e61 6d65 3d6e 616d 6529 7d3b 2063  t(name=name)}; c
+000268b0: 7572 6c20 6874 7470 3a2f 2f24 656e 6470  url http://$endp
+000268c0: 6f69 6e74 207c 2067 7265 7020 2248 692c  oint | grep "Hi,
+000268d0: 2053 6b79 5069 6c6f 7420 6865 7265 2227   SkyPilot here"'
+000268e0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+000268f0: 736b 7920 7365 7276 6520 7570 6461 7465  sky serve update
+00026900: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+00026910: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
+00026920: 2d79 2074 6573 7473 2f73 6b79 7365 7276  -y tests/skyserv
+00026930: 652f 7570 6461 7465 2f6e 6577 2e79 616d  e/update/new.yam
+00026940: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00026950: 2320 4d61 6b65 2073 7572 6520 7468 6520  # Make sure the 
+00026960: 7472 6166 6669 6320 6973 206d 6978 6564  traffic is mixed
+00026970: 2061 6372 6f73 7320 7477 6f20 7665 7273   across two vers
+00026980: 696f 6e73 2c20 7468 6520 7265 706c 6963  ions, the replic
+00026990: 6173 0a20 2020 2020 2020 2020 2020 2023  as.            #
+000269a0: 2077 6974 6820 6576 656e 2069 6420 7769   with even id wi
+000269b0: 6c6c 2073 6c65 6570 2036 3020 7365 636f  ll sleep 60 seco
+000269c0: 6e64 7320 6265 666f 7265 2062 6569 6e67  nds before being
+000269d0: 2072 6561 6479 2c20 736f 2077 650a 2020   ready, so we.  
+000269e0: 2020 2020 2020 2020 2020 2320 7368 6f75            # shou
+000269f0: 6c64 2062 6520 6162 6c65 2074 6f20 6765  ld be able to ge
+00026a00: 7420 6f62 7365 7276 6520 7468 6520 7065  t observe the pe
+00026a10: 7269 6f64 2074 6861 7420 7468 6520 7472  riod that the tr
+00026a20: 6166 6669 6320 6973 206d 6978 6564 0a20  affic is mixed. 
+00026a30: 2020 2020 2020 2020 2020 2023 2061 6372             # acr
+00026a40: 6f73 7320 7477 6f20 7665 7273 696f 6e73  oss two versions
+00026a50: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00026a60: 7b5f 5345 5256 455f 454e 4450 4f49 4e54  {_SERVE_ENDPOINT
+00026a70: 5f57 4149 542e 666f 726d 6174 286e 616d  _WAIT.format(nam
+00026a80: 653d 6e61 6d65 297d 3b20 270a 2020 2020  e=name)}; '.    
+00026a90: 2020 2020 2020 2020 2775 6e74 696c 2063          'until c
+00026aa0: 7572 6c20 6874 7470 3a2f 2f24 656e 6470  url http://$endp
+00026ab0: 6f69 6e74 207c 2067 7265 7020 2248 692c  oint | grep "Hi,
+00026ac0: 206e 6577 2053 6b79 5069 6c6f 7420 6865   new SkyPilot he
+00026ad0: 7265 2122 3b20 646f 2073 6c65 6570 2032  re!"; do sleep 2
+00026ae0: 3b20 646f 6e65 3b20 736c 6565 7020 323b  ; done; sleep 2;
+00026af0: 2027 0a20 2020 2020 2020 2020 2020 2023   '.            #
+00026b00: 2054 6865 206c 6174 6573 7420 7665 7273   The latest vers
+00026b10: 696f 6e20 7368 6f75 6c64 2068 6176 6520  ion should have 
+00026b20: 6f6e 6520 5245 4144 5920 616e 6420 7468  one READY and th
+00026b30: 6520 6f6e 6520 6f66 2074 6865 206f 6c64  e one of the old
+00026b40: 6572 2076 6572 7369 6f6e 7320 7368 6f75  er versions shou
+00026b50: 6c64 2062 6520 7368 7574 7469 6e67 2064  ld be shutting d
+00026b60: 6f77 6e0a 2020 2020 2020 2020 2020 2020  own.            
+00026b70: 6627 7b73 696e 676c 655f 6e65 775f 7265  f'{single_new_re
+00026b80: 706c 6963 617d 207b 5f63 6865 636b 5f73  plica} {_check_s
+00026b90: 6572 7669 6365 5f76 6572 7369 6f6e 286e  ervice_version(n
+00026ba0: 616d 652c 2022 312c 3222 297d 2027 0a20  ame, "1,2")} '. 
+00026bb0: 2020 2020 2020 2020 2020 2023 2043 6865             # Che
+00026bc0: 636b 2074 6865 206f 7574 7075 7420 6672  ck the output fr
+00026bd0: 6f6d 2074 6865 206f 6c64 2076 6572 7369  om the old versi
+00026be0: 6f6e 2c20 696d 6d65 6469 6174 656c 7920  on, immediately 
+00026bf0: 6166 7465 7220 7468 650a 2020 2020 2020  after the.      
+00026c00: 2020 2020 2020 2320 6f75 7470 7574 2066        # output f
+00026c10: 726f 6d20 7468 6520 6e65 7720 7665 7273  rom the new vers
+00026c20: 696f 6e20 6170 7065 6172 732e 2054 6869  ion appears. Thi
+00026c30: 7320 6973 2067 7561 7261 6e74 6565 6420  s is guaranteed 
+00026c40: 6279 2074 6865 0a20 2020 2020 2020 2020  by the.         
+00026c50: 2020 2023 2072 6f75 6e64 2072 6f62 696e     # round robin
+00026c60: 206c 6f61 6420 6261 6c61 6e63 696e 6720   load balancing 
+00026c70: 706f 6c69 6379 2e0a 2020 2020 2020 2020  policy..        
+00026c80: 2020 2020 2320 544f 444f 287a 6877 7529      # TODO(zhwu)
+00026c90: 3a20 7765 2073 686f 756c 6420 6861 7665  : we should have
+00026ca0: 2061 206d 6f72 6520 6765 6e65 7261 6c69   a more generali
+00026cb0: 7a65 6420 7761 7920 666f 7220 6368 6563  zed way for chec
+00026cc0: 6b69 6e67 2074 6865 0a20 2020 2020 2020  king the.       
+00026cd0: 2020 2020 2023 206d 6978 6564 2076 6572       # mixed ver
+00026ce0: 7369 6f6e 206f 6620 7265 706c 6963 6173  sion of replicas
+00026cf0: 2074 6f20 6176 6f69 6420 6465 7065 6e64   to avoid depend
+00026d00: 696e 6720 6f6e 2074 6865 2073 7065 6369  ing on the speci
+00026d10: 6669 630a 2020 2020 2020 2020 2020 2020  fic.            
+00026d20: 2320 726f 756e 6420 726f 6269 6e20 6c6f  # round robin lo
+00026d30: 6164 2062 616c 616e 6369 6e67 2070 6f6c  ad balancing pol
+00026d40: 6963 792e 0a20 2020 2020 2020 2020 2020  icy..           
+00026d50: 2027 6375 726c 2068 7474 703a 2f2f 2465   'curl http://$e
+00026d60: 6e64 706f 696e 7420 7c20 6772 6570 2022  ndpoint | grep "
+00026d70: 4869 2c20 536b 7950 696c 6f74 2068 6572  Hi, SkyPilot her
+00026d80: 6522 272c 0a20 2020 2020 2020 205d 2c0a  e"',.        ],.
+00026d90: 2020 2020 2020 2020 5f54 4541 5244 4f57          _TEARDOW
+00026da0: 4e5f 5345 5256 4943 452e 666f 726d 6174  N_SERVICE.format
+00026db0: 286e 616d 653d 6e61 6d65 292c 0a20 2020  (name=name),.   
+00026dc0: 2020 2020 2074 696d 656f 7574 3d32 3020       timeout=20 
+00026dd0: 2a20 3630 2c0a 2020 2020 290a 2020 2020  * 60,.    ).    
+00026de0: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+00026df0: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+00026e00: 6b2e 7365 7276 650a 6465 6620 7465 7374  k.serve.def test
+00026e10: 5f73 6b79 7365 7276 655f 6661 7374 5f75  _skyserve_fast_u
+00026e20: 7064 6174 6528 6765 6e65 7269 635f 636c  pdate(generic_cl
+00026e30: 6f75 643a 2073 7472 293a 0a20 2020 2022  oud: str):.    "
+00026e40: 2222 5465 7374 2073 6b79 7365 7276 6520  ""Test skyserve 
+00026e50: 7769 7468 2066 6173 7420 7570 6461 7465  with fast update
+00026e60: 2028 496e 6372 656d 656e 7420 7665 7273   (Increment vers
+00026e70: 696f 6e20 6f66 206f 6c64 2072 6570 6c69  ion of old repli
+00026e80: 6361 7329 2222 220a 2020 2020 6e61 6d65  cas)""".    name
+00026e90: 203d 205f 6765 745f 7365 7276 6963 655f   = _get_service_
+00026ea0: 6e61 6d65 2829 0a0a 2020 2020 7465 7374  name()..    test
+00026eb0: 203d 2054 6573 7428 0a20 2020 2020 2020   = Test(.       
+00026ec0: 2066 2774 6573 742d 736b 7973 6572 7665   f'test-skyserve
+00026ed0: 2d66 6173 742d 7570 6461 7465 272c 0a20  -fast-update',. 
+00026ee0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+00026ef0: 2020 2020 2066 2773 6b79 2073 6572 7665       f'sky serve
+00026f00: 2075 7020 2d6e 207b 6e61 6d65 7d20 2d79   up -n {name} -y
+00026f10: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
+00026f20: 635f 636c 6f75 647d 2074 6573 7473 2f73  c_cloud} tests/s
+00026f30: 6b79 7365 7276 652f 7570 6461 7465 2f62  kyserve/update/b
+00026f40: 756d 705f 7665 7273 696f 6e5f 6265 666f  ump_version_befo
+00026f50: 7265 2e79 616d 6c27 2c0a 2020 2020 2020  re.yaml',.      
+00026f60: 2020 2020 2020 5f53 4552 5645 5f57 4149        _SERVE_WAI
+00026f70: 545f 554e 5449 4c5f 5245 4144 592e 666f  T_UNTIL_READY.fo
+00026f80: 726d 6174 286e 616d 653d 6e61 6d65 2c20  rmat(name=name, 
+00026f90: 7265 706c 6963 615f 6e75 6d3d 3229 2c0a  replica_num=2),.
+00026fa0: 2020 2020 2020 2020 2020 2020 6627 7b5f              f'{_
+00026fb0: 5345 5256 455f 454e 4450 4f49 4e54 5f57  SERVE_ENDPOINT_W
+00026fc0: 4149 542e 666f 726d 6174 286e 616d 653d  AIT.format(name=
+00026fd0: 6e61 6d65 297d 3b20 6375 726c 2068 7474  name)}; curl htt
+00026fe0: 703a 2f2f 2465 6e64 706f 696e 7420 7c20  p://$endpoint | 
+00026ff0: 6772 6570 2022 4869 2c20 536b 7950 696c  grep "Hi, SkyPil
+00027000: 6f74 2068 6572 6522 272c 0a20 2020 2020  ot here"',.     
+00027010: 2020 2020 2020 2066 2773 6b79 2073 6572         f'sky ser
+00027020: 7665 2075 7064 6174 6520 7b6e 616d 657d  ve update {name}
+00027030: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
+00027040: 635f 636c 6f75 647d 202d 2d6d 6f64 6520  c_cloud} --mode 
+00027050: 626c 7565 5f67 7265 656e 202d 7920 7465  blue_green -y te
+00027060: 7374 732f 736b 7973 6572 7665 2f75 7064  sts/skyserve/upd
+00027070: 6174 652f 6275 6d70 5f76 6572 7369 6f6e  ate/bump_version
+00027080: 5f61 6674 6572 2e79 616d 6c27 2c0a 2020  _after.yaml',.  
+00027090: 2020 2020 2020 2020 2020 2320 736c 6565            # slee
+000270a0: 7020 746f 2077 6169 7420 666f 7220 7570  p to wait for up
+000270b0: 6461 7465 2074 6f20 6265 2072 6567 6973  date to be regis
+000270c0: 7465 7265 642e 0a20 2020 2020 2020 2020  tered..         
+000270d0: 2020 2027 736c 6565 7020 3330 272c 0a20     'sleep 30',. 
+000270e0: 2020 2020 2020 2020 2020 2023 2032 206f             # 2 o
+000270f0: 6e2d 6465 616d 6e64 2028 7265 6164 7929  n-deamnd (ready)
+00027100: 202b 2031 206f 6e2d 6465 6d61 6e64 2028   + 1 on-demand (
+00027110: 7072 6f76 6973 696f 6e69 6e67 292e 0a20  provisioning).. 
+00027120: 2020 2020 2020 2020 2020 2028 0a20 2020             (.   
+00027130: 2020 2020 2020 2020 2020 2020 205f 6368               _ch
+00027140: 6563 6b5f 7265 706c 6963 615f 696e 5f73  eck_replica_in_s
+00027150: 7461 7475 7328 0a20 2020 2020 2020 2020  tatus(.         
+00027160: 2020 2020 2020 2020 2020 206e 616d 652c             name,
+00027170: 205b 2832 2c20 4661 6c73 652c 2027 5245   [(2, False, 'RE
+00027180: 4144 5927 292c 0a20 2020 2020 2020 2020  ADY'),.         
+00027190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000271a0: 2020 2831 2c20 4661 6c73 652c 205f 5345    (1, False, _SE
+000271b0: 5256 4943 455f 4c41 554e 4348 494e 475f  RVICE_LAUNCHING_
+000271c0: 5354 4154 5553 5f52 4547 4558 295d 2920  STATUS_REGEX)]) 
+000271d0: 2b0a 2020 2020 2020 2020 2020 2020 2020  +.              
+000271e0: 2020 2320 4661 7374 2075 7064 6174 6520    # Fast update 
+000271f0: 7769 6c6c 2064 6972 6563 746c 7920 6861  will directly ha
+00027200: 7665 2074 6865 206c 6174 6573 7420 7665  ve the latest ve
+00027210: 7273 696f 6e20 7265 6164 792e 0a20 2020  rsion ready..   
+00027220: 2020 2020 2020 2020 2020 2020 205f 6368               _ch
+00027230: 6563 6b5f 7365 7276 6963 655f 7665 7273  eck_service_vers
+00027240: 696f 6e28 6e61 6d65 2c20 2232 2229 292c  ion(name, "2")),
+00027250: 0a20 2020 2020 2020 2020 2020 205f 5345  .            _SE
+00027260: 5256 455f 5741 4954 5f55 4e54 494c 5f52  RVE_WAIT_UNTIL_R
+00027270: 4541 4459 2e66 6f72 6d61 7428 6e61 6d65  EADY.format(name
+00027280: 3d6e 616d 652c 2072 6570 6c69 6361 5f6e  =name, replica_n
+00027290: 756d 3d33 2920 2b0a 2020 2020 2020 2020  um=3) +.        
+000272a0: 2020 2020 5f63 6865 636b 5f73 6572 7669      _check_servi
+000272b0: 6365 5f76 6572 7369 6f6e 286e 616d 652c  ce_version(name,
+000272c0: 2022 3222 292c 0a20 2020 2020 2020 2020   "2"),.         
+000272d0: 2020 2066 277b 5f53 4552 5645 5f45 4e44     f'{_SERVE_END
+000272e0: 504f 494e 545f 5741 4954 2e66 6f72 6d61  POINT_WAIT.forma
+000272f0: 7428 6e61 6d65 3d6e 616d 6529 7d3b 2063  t(name=name)}; c
+00027300: 7572 6c20 6874 7470 3a2f 2f24 656e 6470  url http://$endp
+00027310: 6f69 6e74 207c 2067 7265 7020 2248 692c  oint | grep "Hi,
+00027320: 2053 6b79 5069 6c6f 7420 6865 7265 2227   SkyPilot here"'
+00027330: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+00027340: 5465 7374 2072 6f6c 6c69 6e67 2075 7064  Test rolling upd
+00027350: 6174 650a 2020 2020 2020 2020 2020 2020  ate.            
+00027360: 6627 736b 7920 7365 7276 6520 7570 6461  f'sky serve upda
+00027370: 7465 207b 6e61 6d65 7d20 2d2d 636c 6f75  te {name} --clou
+00027380: 6420 7b67 656e 6572 6963 5f63 6c6f 7564  d {generic_cloud
+00027390: 7d20 2d79 2074 6573 7473 2f73 6b79 7365  } -y tests/skyse
+000273a0: 7276 652f 7570 6461 7465 2f62 756d 705f  rve/update/bump_
+000273b0: 7665 7273 696f 6e5f 6265 666f 7265 2e79  version_before.y
+000273c0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+000273d0: 2020 2320 736c 6565 7020 746f 2077 6169    # sleep to wai
+000273e0: 7420 666f 7220 7570 6461 7465 2074 6f20  t for update to 
+000273f0: 6265 2072 6567 6973 7465 7265 642e 0a20  be registered.. 
+00027400: 2020 2020 2020 2020 2020 2027 736c 6565             'slee
+00027410: 7020 3135 272c 0a20 2020 2020 2020 2020  p 15',.         
+00027420: 2020 2023 2032 206f 6e2d 6465 616d 6e64     # 2 on-deamnd
+00027430: 2028 7265 6164 7929 202b 2031 206f 6e2d   (ready) + 1 on-
+00027440: 6465 6d61 6e64 2028 7368 7574 7469 6e67  demand (shutting
+00027450: 2064 6f77 6e29 2e0a 2020 2020 2020 2020   down)..        
+00027460: 2020 2020 5f63 6865 636b 5f72 6570 6c69      _check_repli
+00027470: 6361 5f69 6e5f 7374 6174 7573 286e 616d  ca_in_status(nam
+00027480: 652c 205b 2832 2c20 4661 6c73 652c 2027  e, [(2, False, '
+00027490: 5245 4144 5927 292c 0a20 2020 2020 2020  READY'),.       
+000274a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000274b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000274c0: 2020 2020 2028 312c 2046 616c 7365 2c20       (1, False, 
+000274d0: 2753 4855 5454 494e 475f 444f 574e 2729  'SHUTTING_DOWN')
+000274e0: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
+000274f0: 5f53 4552 5645 5f57 4149 545f 554e 5449  _SERVE_WAIT_UNTI
+00027500: 4c5f 5245 4144 592e 666f 726d 6174 286e  L_READY.format(n
+00027510: 616d 653d 6e61 6d65 2c20 7265 706c 6963  ame=name, replic
+00027520: 615f 6e75 6d3d 3229 202b 0a20 2020 2020  a_num=2) +.     
+00027530: 2020 2020 2020 205f 6368 6563 6b5f 7365         _check_se
+00027540: 7276 6963 655f 7665 7273 696f 6e28 6e61  rvice_version(na
+00027550: 6d65 2c20 2233 2229 2c0a 2020 2020 2020  me, "3"),.      
+00027560: 2020 2020 2020 6627 7b5f 5345 5256 455f        f'{_SERVE_
+00027570: 454e 4450 4f49 4e54 5f57 4149 542e 666f  ENDPOINT_WAIT.fo
+00027580: 726d 6174 286e 616d 653d 6e61 6d65 297d  rmat(name=name)}
+00027590: 3b20 6375 726c 2068 7474 703a 2f2f 2465  ; curl http://$e
+000275a0: 6e64 706f 696e 7420 7c20 6772 6570 2022  ndpoint | grep "
+000275b0: 4869 2c20 536b 7950 696c 6f74 2068 6572  Hi, SkyPilot her
+000275c0: 6522 272c 0a20 2020 2020 2020 205d 2c0a  e"',.        ],.
+000275d0: 2020 2020 2020 2020 5f54 4541 5244 4f57          _TEARDOW
+000275e0: 4e5f 5345 5256 4943 452e 666f 726d 6174  N_SERVICE.format
+000275f0: 286e 616d 653d 6e61 6d65 292c 0a20 2020  (name=name),.   
+00027600: 2020 2020 2074 696d 656f 7574 3d33 3020       timeout=30 
+00027610: 2a20 3630 2c0a 2020 2020 290a 2020 2020  * 60,.    ).    
+00027620: 7275 6e5f 6f6e 655f 7465 7374 2874 6573  run_one_test(tes
+00027630: 7429 0a0a 0a40 7079 7465 7374 2e6d 6172  t)...@pytest.mar
+00027640: 6b2e 7365 7276 650a 6465 6620 7465 7374  k.serve.def test
+00027650: 5f73 6b79 7365 7276 655f 7570 6461 7465  _skyserve_update
+00027660: 5f61 7574 6f73 6361 6c65 2867 656e 6572  _autoscale(gener
+00027670: 6963 5f63 6c6f 7564 3a20 7374 7229 3a0a  ic_cloud: str):.
+00027680: 2020 2020 2222 2254 6573 7420 736b 7973      """Test skys
+00027690: 6572 7665 2075 7064 6174 6520 7769 7468  erve update with
+000276a0: 2061 7574 6f73 6361 6c65 2222 220a 2020   autoscale""".  
+000276b0: 2020 6e61 6d65 203d 205f 6765 745f 7365    name = _get_se
+000276c0: 7276 6963 655f 6e61 6d65 2829 0a20 2020  rvice_name().   
+000276d0: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+000276e0: 2020 2020 2020 6627 7465 7374 2d73 6b79        f'test-sky
+000276f0: 7365 7276 652d 7570 6461 7465 2d61 7574  serve-update-aut
+00027700: 6f73 6361 6c65 272c 0a20 2020 2020 2020  oscale',.       
+00027710: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+00027720: 2773 6b79 2073 6572 7665 2075 7020 2d6e  'sky serve up -n
+00027730: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+00027740: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
+00027750: 2d79 2074 6573 7473 2f73 6b79 7365 7276  -y tests/skyserv
+00027760: 652f 7570 6461 7465 2f6e 756d 5f6d 696e  e/update/num_min
+00027770: 5f74 776f 2e79 616d 6c27 2c0a 2020 2020  _two.yaml',.    
+00027780: 2020 2020 2020 2020 5f53 4552 5645 5f57          _SERVE_W
+00027790: 4149 545f 554e 5449 4c5f 5245 4144 592e  AIT_UNTIL_READY.
+000277a0: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
+000277b0: 2c20 7265 706c 6963 615f 6e75 6d3d 3229  , replica_num=2)
+000277c0: 202b 0a20 2020 2020 2020 2020 2020 205f   +.            _
+000277d0: 6368 6563 6b5f 7365 7276 6963 655f 7665  check_service_ve
+000277e0: 7273 696f 6e28 6e61 6d65 2c20 2231 2229  rsion(name, "1")
+000277f0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+00027800: 7b5f 5345 5256 455f 454e 4450 4f49 4e54  {_SERVE_ENDPOINT
+00027810: 5f57 4149 542e 666f 726d 6174 286e 616d  _WAIT.format(nam
+00027820: 653d 6e61 6d65 297d 3b20 270a 2020 2020  e=name)}; '.    
+00027830: 2020 2020 2020 2020 2763 7572 6c20 6874          'curl ht
+00027840: 7470 3a2f 2f24 656e 6470 6f69 6e74 207c  tp://$endpoint |
+00027850: 2067 7265 7020 2248 692c 2053 6b79 5069   grep "Hi, SkyPi
+00027860: 6c6f 7420 6865 7265 2227 2c0a 2020 2020  lot here"',.    
+00027870: 2020 2020 2020 2020 6627 736b 7920 7365          f'sky se
+00027880: 7276 6520 7570 6461 7465 207b 6e61 6d65  rve update {name
+00027890: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
+000278a0: 6963 5f63 6c6f 7564 7d20 2d2d 6d6f 6465  ic_cloud} --mode
+000278b0: 2062 6c75 655f 6772 6565 6e20 2d79 2074   blue_green -y t
+000278c0: 6573 7473 2f73 6b79 7365 7276 652f 7570  ests/skyserve/up
+000278d0: 6461 7465 2f6e 756d 5f6d 696e 5f6f 6e65  date/num_min_one
+000278e0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+000278f0: 2020 2020 2320 736c 6565 7020 6265 666f      # sleep befo
+00027900: 7265 2075 7064 6174 6520 6973 2072 6567  re update is reg
+00027910: 6973 7465 7265 642e 0a20 2020 2020 2020  istered..       
+00027920: 2020 2020 2027 736c 6565 7020 3230 272c       'sleep 20',
+00027930: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
+00027940: 696d 656f 7574 2077 696c 6c20 6265 2074  imeout will be t
+00027950: 7269 6767 6572 6564 2077 6865 6e20 7570  riggered when up
+00027960: 6461 7465 2066 6169 6c73 2e0a 2020 2020  date fails..    
+00027970: 2020 2020 2020 2020 5f53 4552 5645 5f57          _SERVE_W
+00027980: 4149 545f 554e 5449 4c5f 5245 4144 592e  AIT_UNTIL_READY.
+00027990: 666f 726d 6174 286e 616d 653d 6e61 6d65  format(name=name
+000279a0: 2c20 7265 706c 6963 615f 6e75 6d3d 3129  , replica_num=1)
+000279b0: 202b 0a20 2020 2020 2020 2020 2020 205f   +.            _
+000279c0: 6368 6563 6b5f 7365 7276 6963 655f 7665  check_service_ve
+000279d0: 7273 696f 6e28 6e61 6d65 2c20 2232 2229  rsion(name, "2")
+000279e0: 2c0a 2020 2020 2020 2020 2020 2020 6627  ,.            f'
+000279f0: 7b5f 5345 5256 455f 454e 4450 4f49 4e54  {_SERVE_ENDPOINT
+00027a00: 5f57 4149 542e 666f 726d 6174 286e 616d  _WAIT.format(nam
+00027a10: 653d 6e61 6d65 297d 3b20 270a 2020 2020  e=name)}; '.    
+00027a20: 2020 2020 2020 2020 2763 7572 6c20 6874          'curl ht
+00027a30: 7470 3a2f 2f24 656e 6470 6f69 6e74 207c  tp://$endpoint |
+00027a40: 2067 7265 7020 2248 692c 2053 6b79 5069   grep "Hi, SkyPi
+00027a50: 6c6f 7420 6865 7265 2122 272c 0a20 2020  lot here!"',.   
+00027a60: 2020 2020 2020 2020 2023 2052 6f6c 6c69           # Rolli
+00027a70: 6e67 2055 7064 6174 650a 2020 2020 2020  ng Update.      
+00027a80: 2020 2020 2020 6627 736b 7920 7365 7276        f'sky serv
+00027a90: 6520 7570 6461 7465 207b 6e61 6d65 7d20  e update {name} 
+00027aa0: 2d2d 636c 6f75 6420 7b67 656e 6572 6963  --cloud {generic
+00027ab0: 5f63 6c6f 7564 7d20 2d79 2074 6573 7473  _cloud} -y tests
+00027ac0: 2f73 6b79 7365 7276 652f 7570 6461 7465  /skyserve/update
+00027ad0: 2f6e 756d 5f6d 696e 5f74 776f 2e79 616d  /num_min_two.yam
+00027ae0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00027af0: 2320 736c 6565 7020 6265 666f 7265 2075  # sleep before u
+00027b00: 7064 6174 6520 6973 2072 6567 6973 7465  pdate is registe
+00027b10: 7265 642e 0a20 2020 2020 2020 2020 2020  red..           
+00027b20: 2027 736c 6565 7020 3230 272c 0a20 2020   'sleep 20',.   
+00027b30: 2020 2020 2020 2020 2023 2054 696d 656f           # Timeo
+00027b40: 7574 2077 696c 6c20 6265 2074 7269 6767  ut will be trigg
+00027b50: 6572 6564 2077 6865 6e20 7570 6461 7465  ered when update
+00027b60: 2066 6169 6c73 2e0a 2020 2020 2020 2020   fails..        
+00027b70: 2020 2020 5f53 4552 5645 5f57 4149 545f      _SERVE_WAIT_
+00027b80: 554e 5449 4c5f 5245 4144 592e 666f 726d  UNTIL_READY.form
+00027b90: 6174 286e 616d 653d 6e61 6d65 2c20 7265  at(name=name, re
+00027ba0: 706c 6963 615f 6e75 6d3d 3229 202b 0a20  plica_num=2) +. 
+00027bb0: 2020 2020 2020 2020 2020 205f 6368 6563             _chec
+00027bc0: 6b5f 7365 7276 6963 655f 7665 7273 696f  k_service_versio
+00027bd0: 6e28 6e61 6d65 2c20 2233 2229 2c0a 2020  n(name, "3"),.  
+00027be0: 2020 2020 2020 2020 2020 6627 7b5f 5345            f'{_SE
+00027bf0: 5256 455f 454e 4450 4f49 4e54 5f57 4149  RVE_ENDPOINT_WAI
+00027c00: 542e 666f 726d 6174 286e 616d 653d 6e61  T.format(name=na
+00027c10: 6d65 297d 3b20 270a 2020 2020 2020 2020  me)}; '.        
+00027c20: 2020 2020 2763 7572 6c20 6874 7470 3a2f      'curl http:/
+00027c30: 2f24 656e 6470 6f69 6e74 207c 2067 7265  /$endpoint | gre
+00027c40: 7020 2248 692c 2053 6b79 5069 6c6f 7420  p "Hi, SkyPilot 
+00027c50: 6865 7265 2122 272c 0a20 2020 2020 2020  here!"',.       
+00027c60: 205d 2c0a 2020 2020 2020 2020 5f54 4541   ],.        _TEA
+00027c70: 5244 4f57 4e5f 5345 5256 4943 452e 666f  RDOWN_SERVICE.fo
+00027c80: 726d 6174 286e 616d 653d 6e61 6d65 292c  rmat(name=name),
+00027c90: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
+00027ca0: 3d33 3020 2a20 3630 2c0a 2020 2020 290a  =30 * 60,.    ).
+00027cb0: 2020 2020 7275 6e5f 6f6e 655f 7465 7374      run_one_test
+00027cc0: 2874 6573 7429 0a0a 0a40 7079 7465 7374  (test)...@pytest
+00027cd0: 2e6d 6172 6b2e 7365 7276 650a 4070 7974  .mark.serve.@pyt
+00027ce0: 6573 742e 6d61 726b 2e6e 6f5f 6b75 6265  est.mark.no_kube
+00027cf0: 726e 6574 6573 2020 2320 5370 6f74 2069  rnetes  # Spot i
+00027d00: 6e73 7461 6e63 6573 2061 7265 206e 6f74  nstances are not
+00027d10: 2073 7570 706f 7274 6564 2069 6e20 4b75   supported in Ku
+00027d20: 6265 726e 6574 6573 0a40 7079 7465 7374  bernetes.@pytest
+00027d30: 2e6d 6172 6b2e 7061 7261 6d65 7472 697a  .mark.parametriz
+00027d40: 6528 276d 6f64 6527 2c20 5b27 726f 6c6c  e('mode', ['roll
+00027d50: 696e 6727 2c20 2762 6c75 655f 6772 6565  ing', 'blue_gree
+00027d60: 6e27 5d29 0a64 6566 2074 6573 745f 736b  n']).def test_sk
+00027d70: 7973 6572 7665 5f6e 6577 5f61 7574 6f73  yserve_new_autos
+00027d80: 6361 6c65 725f 7570 6461 7465 286d 6f64  caler_update(mod
+00027d90: 653a 2073 7472 2c20 6765 6e65 7269 635f  e: str, generic_
+00027da0: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
+00027db0: 2022 2222 5465 7374 2073 6b79 7365 7276   """Test skyserv
+00027dc0: 6520 7769 7468 2075 7064 6174 6520 7468  e with update th
+00027dd0: 6174 2063 6861 6e67 6573 2061 7574 6f73  at changes autos
+00027de0: 6361 6c65 7222 2222 0a20 2020 206e 616d  caler""".    nam
+00027df0: 6520 3d20 5f67 6574 5f73 6572 7669 6365  e = _get_service
+00027e00: 5f6e 616d 6528 2920 2b20 6d6f 6465 0a0a  _name() + mode..
+00027e10: 2020 2020 666f 7572 5f73 706f 745f 7570      four_spot_up
+00027e20: 5f63 6d64 203d 205f 6368 6563 6b5f 7265  _cmd = _check_re
+00027e30: 706c 6963 615f 696e 5f73 7461 7475 7328  plica_in_status(
+00027e40: 6e61 6d65 2c20 5b28 342c 2054 7275 652c  name, [(4, True,
+00027e50: 2027 5245 4144 5927 295d 290a 2020 2020   'READY')]).    
+00027e60: 7570 6461 7465 5f63 6865 636b 203d 205b  update_check = [
+00027e70: 6627 756e 7469 6c20 287b 666f 7572 5f73  f'until ({four_s
+00027e80: 706f 745f 7570 5f63 6d64 7d29 3b20 646f  pot_up_cmd}); do
+00027e90: 2073 6c65 6570 2035 3b20 646f 6e65 3b20   sleep 5; done; 
+00027ea0: 736c 6565 7020 3130 3b27 5d0a 2020 2020  sleep 10;'].    
+00027eb0: 6966 206d 6f64 6520 3d3d 2027 726f 6c6c  if mode == 'roll
+00027ec0: 696e 6727 3a0a 2020 2020 2020 2020 2320  ing':.        # 
+00027ed0: 4368 6563 6b20 726f 6c6c 696e 6720 7570  Check rolling up
+00027ee0: 6461 7465 2c20 6974 2077 696c 6c20 7465  date, it will te
+00027ef0: 726d 696e 6174 6520 6f6e 6520 6f66 2074  rminate one of t
+00027f00: 6865 206f 6c64 206f 6e2d 6465 6d61 6e64  he old on-demand
+00027f10: 0a20 2020 2020 2020 2023 2069 6e73 7461  .        # insta
+00027f20: 6e63 6573 2c20 6f6e 6365 2074 6865 7265  nces, once there
+00027f30: 2061 7265 2034 2073 706f 7420 696e 7374   are 4 spot inst
+00027f40: 616e 6365 2072 6561 6479 2e0a 2020 2020  ance ready..    
+00027f50: 2020 2020 7570 6461 7465 5f63 6865 636b      update_check
+00027f60: 202b 3d20 5b0a 2020 2020 2020 2020 2020   += [.          
+00027f70: 2020 5f63 6865 636b 5f72 6570 6c69 6361    _check_replica
+00027f80: 5f69 6e5f 7374 6174 7573 280a 2020 2020  _in_status(.    
+00027f90: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+00027fa0: 2c20 5b28 312c 2046 616c 7365 2c20 5f53  , [(1, False, _S
+00027fb0: 4552 5649 4345 5f4c 4155 4e43 4849 4e47  ERVICE_LAUNCHING
+00027fc0: 5f53 5441 5455 535f 5245 4745 5829 2c0a  _STATUS_REGEX),.
+00027fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027fe0: 2020 2020 2020 2028 312c 2046 616c 7365         (1, False
+00027ff0: 2c20 2753 4855 5454 494e 475f 444f 574e  , 'SHUTTING_DOWN
+00028000: 2729 2c20 2831 2c20 4661 6c73 652c 2027  '), (1, False, '
+00028010: 5245 4144 5927 295d 2920 2b0a 2020 2020  READY')]) +.    
+00028020: 2020 2020 2020 2020 5f63 6865 636b 5f73          _check_s
+00028030: 6572 7669 6365 5f76 6572 7369 6f6e 286e  ervice_version(n
+00028040: 616d 652c 2022 312c 3222 292c 0a20 2020  ame, "1,2"),.   
+00028050: 2020 2020 205d 0a20 2020 2065 6c73 653a       ].    else:
+00028060: 0a20 2020 2020 2020 2023 2043 6865 636b  .        # Check
+00028070: 2062 6c75 6520 6772 6565 6e20 7570 6461   blue green upda
+00028080: 7465 2c20 6974 2077 696c 6c20 6b65 6570  te, it will keep
+00028090: 2062 6f74 6820 6f6c 6420 6f6e 2d64 656d   both old on-dem
+000280a0: 616e 6420 696e 7374 616e 6365 730a 2020  and instances.  
+000280b0: 2020 2020 2020 2320 7275 6e6e 696e 672c        # running,
+000280c0: 206f 6e63 6520 7468 6572 6520 6172 6520   once there are 
+000280d0: 3420 7370 6f74 2069 6e73 7461 6e63 6520  4 spot instance 
+000280e0: 7265 6164 792e 0a20 2020 2020 2020 2075  ready..        u
+000280f0: 7064 6174 655f 6368 6563 6b20 2b3d 205b  pdate_check += [
+00028100: 0a20 2020 2020 2020 2020 2020 205f 6368  .            _ch
+00028110: 6563 6b5f 7265 706c 6963 615f 696e 5f73  eck_replica_in_s
+00028120: 7461 7475 7328 0a20 2020 2020 2020 2020  tatus(.         
+00028130: 2020 2020 2020 206e 616d 652c 205b 2831         name, [(1
+00028140: 2c20 4661 6c73 652c 205f 5345 5256 4943  , False, _SERVIC
+00028150: 455f 4c41 554e 4348 494e 475f 5354 4154  E_LAUNCHING_STAT
+00028160: 5553 5f52 4547 4558 292c 0a20 2020 2020  US_REGEX),.     
+00028170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028180: 2020 2832 2c20 4661 6c73 652c 2027 5245    (2, False, 'RE
+00028190: 4144 5927 295d 2920 2b0a 2020 2020 2020  ADY')]) +.      
+000281a0: 2020 2020 2020 5f63 6865 636b 5f73 6572        _check_ser
+000281b0: 7669 6365 5f76 6572 7369 6f6e 286e 616d  vice_version(nam
+000281c0: 652c 2022 3122 292c 0a20 2020 2020 2020  e, "1"),.       
+000281d0: 205d 0a20 2020 2074 6573 7420 3d20 5465   ].    test = Te
+000281e0: 7374 280a 2020 2020 2020 2020 2774 6573  st(.        'tes
+000281f0: 742d 736b 7973 6572 7665 2d6e 6577 2d61  t-skyserve-new-a
+00028200: 7574 6f73 6361 6c65 722d 7570 6461 7465  utoscaler-update
+00028210: 272c 0a20 2020 2020 2020 205b 0a20 2020  ',.        [.   
+00028220: 2020 2020 2020 2020 2066 2773 6b79 2073           f'sky s
+00028230: 6572 7665 2075 7020 2d6e 207b 6e61 6d65  erve up -n {name
+00028240: 7d20 2d2d 636c 6f75 6420 7b67 656e 6572  } --cloud {gener
+00028250: 6963 5f63 6c6f 7564 7d20 2d79 2074 6573  ic_cloud} -y tes
+00028260: 7473 2f73 6b79 7365 7276 652f 7570 6461  ts/skyserve/upda
+00028270: 7465 2f6e 6577 5f61 7574 6f73 6361 6c65  te/new_autoscale
+00028280: 725f 6265 666f 7265 2e79 616d 6c27 2c0a  r_before.yaml',.
+00028290: 2020 2020 2020 2020 2020 2020 5f53 4552              _SER
+000282a0: 5645 5f57 4149 545f 554e 5449 4c5f 5245  VE_WAIT_UNTIL_RE
+000282b0: 4144 592e 666f 726d 6174 286e 616d 653d  ADY.format(name=
+000282c0: 6e61 6d65 2c20 7265 706c 6963 615f 6e75  name, replica_nu
+000282d0: 6d3d 3229 202b 0a20 2020 2020 2020 2020  m=2) +.         
+000282e0: 2020 205f 6368 6563 6b5f 7365 7276 6963     _check_servic
+000282f0: 655f 7665 7273 696f 6e28 6e61 6d65 2c20  e_version(name, 
+00028300: 2231 2229 2c0a 2020 2020 2020 2020 2020  "1"),.          
+00028310: 2020 6627 7b5f 5345 5256 455f 454e 4450    f'{_SERVE_ENDP
+00028320: 4f49 4e54 5f57 4149 542e 666f 726d 6174  OINT_WAIT.format
+00028330: 286e 616d 653d 6e61 6d65 297d 3b20 270a  (name=name)}; '.
+00028340: 2020 2020 2020 2020 2020 2020 2773 3d24              's=$
+00028350: 2863 7572 6c20 6874 7470 3a2f 2f24 656e  (curl http://$en
+00028360: 6470 6f69 6e74 293b 2065 6368 6f20 2224  dpoint); echo "$
+00028370: 7322 3b20 6563 686f 2022 2473 2220 7c20  s"; echo "$s" | 
+00028380: 6772 6570 2022 4869 2c20 536b 7950 696c  grep "Hi, SkyPil
+00028390: 6f74 2068 6572 6522 272c 0a20 2020 2020  ot here"',.     
+000283a0: 2020 2020 2020 2066 2773 6b79 2073 6572         f'sky ser
+000283b0: 7665 2075 7064 6174 6520 7b6e 616d 657d  ve update {name}
+000283c0: 202d 2d63 6c6f 7564 207b 6765 6e65 7269   --cloud {generi
+000283d0: 635f 636c 6f75 647d 202d 2d6d 6f64 6520  c_cloud} --mode 
+000283e0: 7b6d 6f64 657d 202d 7920 7465 7374 732f  {mode} -y tests/
+000283f0: 736b 7973 6572 7665 2f75 7064 6174 652f  skyserve/update/
+00028400: 6e65 775f 6175 746f 7363 616c 6572 5f61  new_autoscaler_a
+00028410: 6674 6572 2e79 616d 6c27 2c0a 2020 2020  fter.yaml',.    
+00028420: 2020 2020 2020 2020 2320 5761 6974 2066          # Wait f
+00028430: 6f72 2075 7064 6174 6520 746f 2062 6520  or update to be 
+00028440: 7265 6769 7374 6572 6564 0a20 2020 2020  registered.     
+00028450: 2020 2020 2020 2066 2773 6c65 6570 2031         f'sleep 1
+00028460: 3230 272c 0a20 2020 2020 2020 2020 2020  20',.           
+00028470: 205f 6368 6563 6b5f 7265 706c 6963 615f   _check_replica_
+00028480: 696e 5f73 7461 7475 7328 0a20 2020 2020  in_status(.     
+00028490: 2020 2020 2020 2020 2020 206e 616d 652c             name,
+000284a0: 205b 2834 2c20 5472 7565 2c20 5f53 4552   [(4, True, _SER
+000284b0: 5649 4345 5f4c 4155 4e43 4849 4e47 5f53  VICE_LAUNCHING_S
+000284c0: 5441 5455 535f 5245 4745 5820 2b20 275c  TATUS_REGEX + '\
+000284d0: 7c52 4541 4459 2729 2c0a 2020 2020 2020  |READY'),.      
+000284e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000284f0: 2028 312c 2046 616c 7365 2c20 5f53 4552   (1, False, _SER
+00028500: 5649 4345 5f4c 4155 4e43 4849 4e47 5f53  VICE_LAUNCHING_S
+00028510: 5441 5455 535f 5245 4745 5829 2c0a 2020  TATUS_REGEX),.  
+00028520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028530: 2020 2020 2028 322c 2046 616c 7365 2c20       (2, False, 
+00028540: 2752 4541 4459 2729 5d29 2c0a 2020 2020  'READY')]),.    
+00028550: 2020 2020 2020 2020 2a75 7064 6174 655f          *update_
+00028560: 6368 6563 6b2c 0a20 2020 2020 2020 2020  check,.         
+00028570: 2020 205f 5345 5256 455f 5741 4954 5f55     _SERVE_WAIT_U
+00028580: 4e54 494c 5f52 4541 4459 2e66 6f72 6d61  NTIL_READY.forma
+00028590: 7428 6e61 6d65 3d6e 616d 652c 2072 6570  t(name=name, rep
+000285a0: 6c69 6361 5f6e 756d 3d35 292c 0a20 2020  lica_num=5),.   
+000285b0: 2020 2020 2020 2020 2066 277b 5f53 4552           f'{_SER
+000285c0: 5645 5f45 4e44 504f 494e 545f 5741 4954  VE_ENDPOINT_WAIT
+000285d0: 2e66 6f72 6d61 7428 6e61 6d65 3d6e 616d  .format(name=nam
+000285e0: 6529 7d3b 2027 0a20 2020 2020 2020 2020  e)}; '.         
+000285f0: 2020 2027 6375 726c 2068 7474 703a 2f2f     'curl http://
+00028600: 2465 6e64 706f 696e 7420 7c20 6772 6570  $endpoint | grep
+00028610: 2022 4869 2c20 536b 7950 696c 6f74 2068   "Hi, SkyPilot h
+00028620: 6572 6522 272c 0a20 2020 2020 2020 2020  ere"',.         
+00028630: 2020 205f 6368 6563 6b5f 7265 706c 6963     _check_replic
+00028640: 615f 696e 5f73 7461 7475 7328 6e61 6d65  a_in_status(name
+00028650: 2c20 5b28 342c 2054 7275 652c 2027 5245  , [(4, True, 'RE
+00028660: 4144 5927 292c 0a20 2020 2020 2020 2020  ADY'),.         
+00028670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028690: 2020 2028 312c 2046 616c 7365 2c20 2752     (1, False, 'R
+000286a0: 4541 4459 2729 5d29 2c0a 2020 2020 2020  EADY')]),.      
+000286b0: 2020 5d2c 0a20 2020 2020 2020 205f 5445    ],.        _TE
+000286c0: 4152 444f 574e 5f53 4552 5649 4345 2e66  ARDOWN_SERVICE.f
+000286d0: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
+000286e0: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
+000286f0: 743d 3230 202a 2036 302c 0a20 2020 2029  t=20 * 60,.    )
+00028700: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00028710: 7428 7465 7374 290a 0a0a 4070 7974 6573  t(test)...@pytes
+00028720: 742e 6d61 726b 2e73 6572 7665 0a64 6566  t.mark.serve.def
+00028730: 2074 6573 745f 736b 7973 6572 7665 5f66   test_skyserve_f
+00028740: 6169 6c75 7265 7328 6765 6e65 7269 635f  ailures(generic_
+00028750: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
+00028760: 2022 2222 5465 7374 2072 6570 6c69 6361   """Test replica
+00028770: 2066 6169 6c75 7265 2073 7461 7475 7365   failure statuse
+00028780: 7322 2222 0a20 2020 206e 616d 6520 3d20  s""".    name = 
+00028790: 5f67 6574 5f73 6572 7669 6365 5f6e 616d  _get_service_nam
+000287a0: 6528 290a 0a20 2020 2074 6573 7420 3d20  e()..    test = 
+000287b0: 5465 7374 280a 2020 2020 2020 2020 2774  Test(.        't
+000287c0: 6573 742d 736b 7973 6572 7665 2d66 6169  est-skyserve-fai
+000287d0: 6c75 7265 7327 2c0a 2020 2020 2020 2020  lures',.        
+000287e0: 5b0a 2020 2020 2020 2020 2020 2020 6627  [.            f'
+000287f0: 736b 7920 7365 7276 6520 7570 202d 6e20  sky serve up -n 
+00028800: 7b6e 616d 657d 202d 2d63 6c6f 7564 207b  {name} --cloud {
+00028810: 6765 6e65 7269 635f 636c 6f75 647d 202d  generic_cloud} -
+00028820: 7920 7465 7374 732f 736b 7973 6572 7665  y tests/skyserve
+00028830: 2f66 6169 6c75 7265 732f 696e 6974 6961  /failures/initia
+00028840: 6c5f 6465 6c61 792e 7961 6d6c 272c 0a20  l_delay.yaml',. 
+00028850: 2020 2020 2020 2020 2020 2066 2773 3d24             f's=$
+00028860: 2873 6b79 2073 6572 7665 2073 7461 7475  (sky serve statu
+00028870: 7320 7b6e 616d 657d 293b 2027 0a20 2020  s {name}); '.   
+00028880: 2020 2020 2020 2020 2066 2775 6e74 696c           f'until
+00028890: 2065 6368 6f20 2224 7322 207c 2067 7265   echo "$s" | gre
+000288a0: 7020 2246 4149 4c45 445f 494e 4954 4941  p "FAILED_INITIA
+000288b0: 4c5f 4445 4c41 5922 3b20 646f 2027 0a20  L_DELAY"; do '. 
+000288c0: 2020 2020 2020 2020 2020 2027 6563 686f             'echo
+000288d0: 2022 5761 6974 696e 6720 666f 7220 7265   "Waiting for re
+000288e0: 706c 6963 6120 746f 2062 6520 6661 696c  plica to be fail
+000288f0: 6564 2e2e 2e22 3b20 736c 6565 7020 353b  ed..."; sleep 5;
+00028900: 2027 0a20 2020 2020 2020 2020 2020 2066   '.            f
+00028910: 2773 3d24 2873 6b79 2073 6572 7665 2073  's=$(sky serve s
+00028920: 7461 7475 7320 7b6e 616d 657d 293b 2065  tatus {name}); e
+00028930: 6368 6f20 2224 7322 3b20 646f 6e65 3b27  cho "$s"; done;'
+00028940: 2c0a 2020 2020 2020 2020 2020 2020 2773  ,.            's
+00028950: 6c65 6570 2036 3027 2c0a 2020 2020 2020  leep 60',.      
+00028960: 2020 2020 2020 6627 7b5f 5345 5256 455f        f'{_SERVE_
+00028970: 5354 4154 5553 5f57 4149 542e 666f 726d  STATUS_WAIT.form
+00028980: 6174 286e 616d 653d 6e61 6d65 297d 3b20  at(name=name)}; 
+00028990: 6563 686f 2022 2473 2220 7c20 6772 6570  echo "$s" | grep
+000289a0: 2022 7b6e 616d 657d 2220 7c20 6772 6570   "{name}" | grep
+000289b0: 2022 4641 494c 4544 5f49 4e49 5449 414c   "FAILED_INITIAL
+000289c0: 5f44 454c 4159 2220 7c20 7763 202d 6c20  _DELAY" | wc -l 
+000289d0: 7c20 6772 6570 2032 3b20 270a 2020 2020  | grep 2; '.    
+000289e0: 2020 2020 2020 2020 2320 4d61 6b65 2073          # Make s
+000289f0: 7572 6520 6e6f 206e 6577 2072 6570 6c69  ure no new repli
+00028a00: 6361 7320 6172 6520 7374 6172 7465 6420  cas are started 
+00028a10: 666f 7220 6561 726c 7920 6661 696c 7572  for early failur
+00028a20: 652e 0a20 2020 2020 2020 2020 2020 2066  e..            f
+00028a30: 2765 6368 6f20 2224 7322 207c 2067 7265  'echo "$s" | gre
+00028a40: 7020 2d41 2031 3030 2022 5365 7276 6963  p -A 100 "Servic
+00028a50: 6520 5265 706c 6963 6173 2220 7c20 6772  e Replicas" | gr
+00028a60: 6570 2022 7b6e 616d 657d 2220 7c20 7763  ep "{name}" | wc
+00028a70: 202d 6c20 7c20 6772 6570 2032 3b27 2c0a   -l | grep 2;',.
+00028a80: 2020 2020 2020 2020 2020 2020 6627 736b              f'sk
+00028a90: 7920 7365 7276 6520 7570 6461 7465 207b  y serve update {
+00028aa0: 6e61 6d65 7d20 2d2d 636c 6f75 6420 7b67  name} --cloud {g
+00028ab0: 656e 6572 6963 5f63 6c6f 7564 7d20 2d79  eneric_cloud} -y
+00028ac0: 2074 6573 7473 2f73 6b79 7365 7276 652f   tests/skyserve/
+00028ad0: 6661 696c 7572 6573 2f70 726f 6269 6e67  failures/probing
+00028ae0: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+00028af0: 2020 2020 6627 733d 2428 736b 7920 7365      f's=$(sky se
+00028b00: 7276 6520 7374 6174 7573 207b 6e61 6d65  rve status {name
+00028b10: 7d29 3b20 270a 2020 2020 2020 2020 2020  }); '.          
+00028b20: 2020 2320 5761 6974 2066 6f72 2072 6570    # Wait for rep
+00028b30: 6c69 6361 2074 6f20 6265 2072 6561 6479  lica to be ready
+00028b40: 2e0a 2020 2020 2020 2020 2020 2020 6627  ..            f'
+00028b50: 756e 7469 6c20 6563 686f 2022 2473 2220  until echo "$s" 
+00028b60: 7c20 6772 6570 2022 5245 4144 5922 3b20  | grep "READY"; 
+00028b70: 646f 2027 0a20 2020 2020 2020 2020 2020  do '.           
+00028b80: 2027 6563 686f 2022 5761 6974 696e 6720   'echo "Waiting 
+00028b90: 666f 7220 7265 706c 6963 6120 746f 2062  for replica to b
+00028ba0: 6520 6661 696c 6564 2e2e 2e22 3b20 736c  e failed..."; sl
+00028bb0: 6565 7020 353b 2027 0a20 2020 2020 2020  eep 5; '.       
+00028bc0: 2020 2020 2066 2773 3d24 2873 6b79 2073       f's=$(sky s
+00028bd0: 6572 7665 2073 7461 7475 7320 7b6e 616d  erve status {nam
+00028be0: 657d 293b 2065 6368 6f20 2224 7322 3b20  e}); echo "$s"; 
+00028bf0: 646f 6e65 3b27 2c0a 2020 2020 2020 2020  done;',.        
+00028c00: 2020 2020 2320 5761 6974 2066 6f72 2072      # Wait for r
+00028c10: 6570 6c69 6361 2074 6f20 6368 616e 6765  eplica to change
+00028c20: 2074 6f20 4641 494c 4544 5f50 524f 4249   to FAILED_PROBI
+00028c30: 4e47 0a20 2020 2020 2020 2020 2020 2066  NG.            f
+00028c40: 2773 3d24 2873 6b79 2073 6572 7665 2073  's=$(sky serve s
+00028c50: 7461 7475 7320 7b6e 616d 657d 293b 2027  tatus {name}); '
+00028c60: 0a20 2020 2020 2020 2020 2020 2066 2775  .            f'u
+00028c70: 6e74 696c 2065 6368 6f20 2224 7322 207c  ntil echo "$s" |
+00028c80: 2067 7265 7020 2246 4149 4c45 445f 5052   grep "FAILED_PR
+00028c90: 4f42 494e 4722 3b20 646f 2027 0a20 2020  OBING"; do '.   
+00028ca0: 2020 2020 2020 2020 2027 6563 686f 2022           'echo "
+00028cb0: 5761 6974 696e 6720 666f 7220 7265 706c  Waiting for repl
+00028cc0: 6963 6120 746f 2062 6520 6661 696c 6564  ica to be failed
+00028cd0: 2e2e 2e22 3b20 736c 6565 7020 353b 2027  ..."; sleep 5; '
+00028ce0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00028cf0: 3d24 2873 6b79 2073 6572 7665 2073 7461  =$(sky serve sta
+00028d00: 7475 7320 7b6e 616d 657d 293b 2065 6368  tus {name}); ech
+00028d10: 6f20 2224 7322 3b20 646f 6e65 3b27 202b  o "$s"; done;' +
+00028d20: 0a20 2020 2020 2020 2020 2020 205f 6368  .            _ch
+00028d30: 6563 6b5f 7265 706c 6963 615f 696e 5f73  eck_replica_in_s
+00028d40: 7461 7475 7328 0a20 2020 2020 2020 2020  tatus(.         
+00028d50: 2020 2020 2020 206e 616d 652c 205b 2831         name, [(1
+00028d60: 2c20 4661 6c73 652c 2027 4641 494c 4544  , False, 'FAILED
+00028d70: 5f50 524f 4249 4e47 2729 2c0a 2020 2020  _PROBING'),.    
+00028d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028d90: 2020 2028 312c 2046 616c 7365 2c20 5f53     (1, False, _S
+00028da0: 4552 5649 4345 5f4c 4155 4e43 4849 4e47  ERVICE_LAUNCHING
+00028db0: 5f53 5441 5455 535f 5245 4745 5829 5d29  _STATUS_REGEX)])
+00028dc0: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
+00028dd0: 544f 444f 287a 6877 7529 3a20 6164 6420  TODO(zhwu): add 
+00028de0: 7465 7374 2066 6f72 2046 4149 4c45 445f  test for FAILED_
+00028df0: 5052 4f56 4953 494f 4e0a 2020 2020 2020  PROVISION.      
+00028e00: 2020 5d2c 0a20 2020 2020 2020 205f 5445    ],.        _TE
+00028e10: 4152 444f 574e 5f53 4552 5649 4345 2e66  ARDOWN_SERVICE.f
+00028e20: 6f72 6d61 7428 6e61 6d65 3d6e 616d 6529  ormat(name=name)
+00028e30: 2c0a 2020 2020 2020 2020 7469 6d65 6f75  ,.        timeou
+00028e40: 743d 3230 202a 2036 302c 0a20 2020 2029  t=20 * 60,.    )
+00028e50: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00028e60: 7428 7465 7374 290a 0a0a 2320 544f 444f  t(test)...# TODO
+00028e70: 285a 696d 696e 672c 2054 6961 6e29 3a20  (Ziming, Tian): 
+00028e80: 4164 6420 7465 7374 7320 666f 7220 6175  Add tests for au
+00028e90: 746f 7363 616c 696e 672e 0a0a 0a23 202d  toscaling....# -
+00028ea0: 2d2d 2d2d 2d2d 2054 6573 7469 6e67 2075  ------ Testing u
+00028eb0: 7365 7220 6465 7065 6e64 656e 6369 6573  ser dependencies
+00028ec0: 202d 2d2d 2d2d 2d2d 2d0a 6465 6620 7465   --------.def te
+00028ed0: 7374 5f75 7365 725f 6465 7065 6e64 656e  st_user_dependen
+00028ee0: 6369 6573 2867 656e 6572 6963 5f63 6c6f  cies(generic_clo
+00028ef0: 7564 3a20 7374 7229 3a0a 2020 2020 6e61  ud: str):.    na
+00028f00: 6d65 203d 205f 6765 745f 636c 7573 7465  me = _get_cluste
+00028f10: 725f 6e61 6d65 2829 0a20 2020 2074 6573  r_name().    tes
+00028f20: 7420 3d20 5465 7374 280a 2020 2020 2020  t = Test(.      
+00028f30: 2020 2775 7365 722d 6465 7065 6e64 656e    'user-dependen
+00028f40: 6369 6573 272c 0a20 2020 2020 2020 205b  cies',.        [
+00028f50: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00028f60: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+00028f70: 7b6e 616d 657d 202d 2d63 6c6f 7564 207b  {name} --cloud {
+00028f80: 6765 6e65 7269 635f 636c 6f75 647d 2022  generic_cloud} "
+00028f90: 7069 7020 696e 7374 616c 6c20 7261 793e  pip install ray>
+00028fa0: 322e 3131 3b20 7261 7920 7374 6172 7420  2.11; ray start 
+00028fb0: 2d2d 6865 6164 2227 2c0a 2020 2020 2020  --head"',.      
+00028fc0: 2020 2020 2020 6627 736b 7920 6c6f 6773        f'sky logs
+00028fd0: 207b 6e61 6d65 7d20 3120 2d2d 7374 6174   {name} 1 --stat
+00028fe0: 7573 272c 0a20 2020 2020 2020 2020 2020  us',.           
+00028ff0: 2066 2773 6b79 2065 7865 6320 7b6e 616d   f'sky exec {nam
+00029000: 657d 2022 6563 686f 2068 6922 272c 0a20  e} "echo hi"',. 
+00029010: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+00029020: 206c 6f67 7320 7b6e 616d 657d 2032 202d   logs {name} 2 -
+00029030: 2d73 7461 7475 7327 2c0a 2020 2020 2020  -status',.      
+00029040: 2020 2020 2020 6627 736b 7920 7374 6174        f'sky stat
+00029050: 7573 202d 7220 7b6e 616d 657d 207c 2067  us -r {name} | g
+00029060: 7265 7020 5550 272c 0a20 2020 2020 2020  rep UP',.       
+00029070: 2020 2020 2066 2773 6b79 2065 7865 6320       f'sky exec 
+00029080: 7b6e 616d 657d 2022 6563 686f 2062 7965  {name} "echo bye
+00029090: 2227 2c0a 2020 2020 2020 2020 2020 2020  "',.            
+000290a0: 6627 736b 7920 6c6f 6773 207b 6e61 6d65  f'sky logs {name
+000290b0: 7d20 3320 2d2d 7374 6174 7573 272c 0a20  } 3 --status',. 
+000290c0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000290d0: 206c 6175 6e63 6820 2d63 207b 6e61 6d65   launch -c {name
+000290e0: 7d20 7465 7374 732f 7465 7374 5f79 616d  } tests/test_yam
+000290f0: 6c73 2f64 6966 6665 7265 6e74 5f64 6566  ls/different_def
+00029100: 6175 6c74 5f63 6f6e 6461 5f65 6e76 2e79  ault_conda_env.y
+00029110: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+00029120: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+00029130: 6d65 7d20 3420 2d2d 7374 6174 7573 272c  me} 4 --status',
+00029140: 0a20 2020 2020 2020 2020 2020 2023 204c  .            # L
+00029150: 6175 6e63 6820 6167 6169 6e20 746f 2074  aunch again to t
+00029160: 6573 7420 7468 6520 6465 6661 756c 7420  est the default 
+00029170: 656e 7620 646f 6573 206e 6f74 2061 6666  env does not aff
+00029180: 6563 7420 536b 7950 696c 6f74 0a20 2020  ect SkyPilot.   
+00029190: 2020 2020 2020 2020 2023 2072 756e 7469           # runti
+000291a0: 6d65 2073 6574 7570 0a20 2020 2020 2020  me setup.       
+000291b0: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+000291c0: 6820 2d63 207b 6e61 6d65 7d20 2270 7974  h -c {name} "pyt
+000291d0: 686f 6e20 2d2d 7665 7273 696f 6e20 323e  hon --version 2>
+000291e0: 2631 207c 2067 7265 7020 5c27 5079 7468  &1 | grep \'Pyth
+000291f0: 6f6e 2033 2e36 5c27 207c 7c20 6578 6974  on 3.6\' || exit
+00029200: 2031 2227 2c0a 2020 2020 2020 2020 2020   1"',.          
+00029210: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+00029220: 6d65 7d20 3520 2d2d 7374 6174 7573 272c  me} 5 --status',
+00029230: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+00029240: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
+00029250: 7920 7b6e 616d 657d 272c 0a20 2020 2029  y {name}',.    )
+00029260: 0a20 2020 2072 756e 5f6f 6e65 5f74 6573  .    run_one_tes
+00029270: 7428 7465 7374 290a 0a0a 2320 2d2d 2d2d  t(test)...# ----
+00029280: 2d2d 2d20 5465 7374 696e 6720 7468 6520  --- Testing the 
+00029290: 636f 7265 2041 5049 202d 2d2d 2d2d 2d2d  core API -------
+000292a0: 2d0a 2320 4d6f 7374 206f 6620 7468 6520  -.# Most of the 
+000292b0: 636f 7265 2041 5049 7320 6861 7665 2062  core APIs have b
+000292c0: 6565 6e20 7465 7374 6564 2069 6e20 7468  een tested in th
+000292d0: 6520 434c 4920 7465 7374 732e 0a23 2054  e CLI tests..# T
+000292e0: 6865 7365 2074 6573 7473 2061 7265 2066  hese tests are f
+000292f0: 6f72 2074 6573 7469 6e67 2074 6865 2072  or testing the r
+00029300: 6574 7572 6e20 7661 6c75 6520 6f66 2074  eturn value of t
+00029310: 6865 2041 5049 7320 6e6f 7420 6675 6c6c  he APIs not full
+00029320: 7920 7573 6564 2069 6e20 434c 492e 0a0a  y used in CLI...
+00029330: 0a40 7079 7465 7374 2e6d 6172 6b2e 6763  .@pytest.mark.gc
+00029340: 700a 6465 6620 7465 7374 5f63 6f72 655f  p.def test_core_
+00029350: 6170 695f 736b 795f 6c61 756e 6368 5f65  api_sky_launch_e
+00029360: 7865 6328 293a 0a20 2020 206e 616d 6520  xec():.    name 
+00029370: 3d20 5f67 6574 5f63 6c75 7374 6572 5f6e  = _get_cluster_n
+00029380: 616d 6528 290a 2020 2020 7461 736b 203d  ame().    task =
+00029390: 2073 6b79 2e54 6173 6b28 7275 6e3d 2277   sky.Task(run="w
+000293a0: 686f 616d 6922 290a 2020 2020 7461 736b  hoami").    task
+000293b0: 2e73 6574 5f72 6573 6f75 7263 6573 2873  .set_resources(s
+000293c0: 6b79 2e52 6573 6f75 7263 6573 2863 6c6f  ky.Resources(clo
+000293d0: 7564 3d73 6b79 2e47 4350 2829 2929 0a20  ud=sky.GCP())). 
+000293e0: 2020 206a 6f62 5f69 642c 2068 616e 646c     job_id, handl
+000293f0: 6520 3d20 736b 792e 6c61 756e 6368 2874  e = sky.launch(t
+00029400: 6173 6b2c 2063 6c75 7374 6572 5f6e 616d  ask, cluster_nam
+00029410: 653d 6e61 6d65 290a 2020 2020 6173 7365  e=name).    asse
+00029420: 7274 206a 6f62 5f69 6420 3d3d 2031 0a20  rt job_id == 1. 
+00029430: 2020 2061 7373 6572 7420 6861 6e64 6c65     assert handle
+00029440: 2069 7320 6e6f 7420 4e6f 6e65 0a20 2020   is not None.   
+00029450: 2061 7373 6572 7420 6861 6e64 6c65 2e63   assert handle.c
+00029460: 6c75 7374 6572 5f6e 616d 6520 3d3d 206e  luster_name == n
+00029470: 616d 650a 2020 2020 6173 7365 7274 2068  ame.    assert h
+00029480: 616e 646c 652e 6c61 756e 6368 6564 5f72  andle.launched_r
+00029490: 6573 6f75 7263 6573 2e63 6c6f 7564 2e69  esources.cloud.i
+000294a0: 735f 7361 6d65 5f63 6c6f 7564 2873 6b79  s_same_cloud(sky
+000294b0: 2e47 4350 2829 290a 2020 2020 6a6f 625f  .GCP()).    job_
+000294c0: 6964 5f65 7865 632c 2068 616e 646c 655f  id_exec, handle_
+000294d0: 6578 6563 203d 2073 6b79 2e65 7865 6328  exec = sky.exec(
+000294e0: 7461 736b 2c20 636c 7573 7465 725f 6e61  task, cluster_na
+000294f0: 6d65 3d6e 616d 6529 0a20 2020 2061 7373  me=name).    ass
+00029500: 6572 7420 6a6f 625f 6964 5f65 7865 6320  ert job_id_exec 
+00029510: 3d3d 2032 0a20 2020 2061 7373 6572 7420  == 2.    assert 
+00029520: 6861 6e64 6c65 5f65 7865 6320 6973 206e  handle_exec is n
+00029530: 6f74 204e 6f6e 650a 2020 2020 6173 7365  ot None.    asse
+00029540: 7274 2068 616e 646c 655f 6578 6563 2e63  rt handle_exec.c
+00029550: 6c75 7374 6572 5f6e 616d 6520 3d3d 206e  luster_name == n
+00029560: 616d 650a 2020 2020 6173 7365 7274 2068  ame.    assert h
+00029570: 616e 646c 655f 6578 6563 2e6c 6175 6e63  andle_exec.launc
+00029580: 6865 645f 7265 736f 7572 6365 732e 636c  hed_resources.cl
+00029590: 6f75 642e 6973 5f73 616d 655f 636c 6f75  oud.is_same_clou
+000295a0: 6428 736b 792e 4743 5028 2929 0a20 2020  d(sky.GCP()).   
+000295b0: 2023 2046 6f72 2064 756d 6d79 2074 6173   # For dummy tas
+000295c0: 6b20 2869 2e65 2e20 7461 736b 2e72 756e  k (i.e. task.run
+000295d0: 2069 7320 4e6f 6e65 292c 2074 6865 206a   is None), the j
+000295e0: 6f62 2077 6f6e 2774 2062 6520 7375 626d  ob won't be subm
+000295f0: 6974 7465 642e 0a20 2020 2064 756d 6d79  itted..    dummy
+00029600: 5f74 6173 6b20 3d20 736b 792e 5461 736b  _task = sky.Task
+00029610: 2829 0a20 2020 206a 6f62 5f69 645f 6475  ().    job_id_du
+00029620: 6d6d 792c 205f 203d 2073 6b79 2e65 7865  mmy, _ = sky.exe
+00029630: 6328 6475 6d6d 795f 7461 736b 2c20 636c  c(dummy_task, cl
+00029640: 7573 7465 725f 6e61 6d65 3d6e 616d 6529  uster_name=name)
+00029650: 0a20 2020 2061 7373 6572 7420 6a6f 625f  .    assert job_
+00029660: 6964 5f64 756d 6d79 2069 7320 4e6f 6e65  id_dummy is None
+00029670: 0a20 2020 2073 6b79 2e64 6f77 6e28 6e61  .    sky.down(na
+00029680: 6d65 290a 0a0a 2320 2d2d 2d2d 2d2d 2d2d  me)...# --------
+00029690: 2d2d 2054 6573 7469 6e67 2053 746f 7261  -- Testing Stora
+000296a0: 6765 202d 2d2d 2d2d 2d2d 2d2d 2d0a 636c  ge ----------.cl
+000296b0: 6173 7320 5465 7374 5374 6f72 6167 6557  ass TestStorageW
+000296c0: 6974 6843 7265 6465 6e74 6961 6c73 3a0a  ithCredentials:.
+000296d0: 2020 2020 2222 2253 746f 7261 6765 2074      """Storage t
+000296e0: 6573 7473 2077 6869 6368 2072 6571 7569  ests which requi
+000296f0: 7265 2063 7265 6465 6e74 6961 6c73 2061  re credentials a
+00029700: 6e64 206e 6574 776f 726b 2063 6f6e 6e65  nd network conne
+00029710: 6374 696f 6e22 2222 0a0a 2020 2020 4157  ction"""..    AW
+00029720: 535f 494e 5641 4c49 445f 4e41 4d45 5320  S_INVALID_NAMES 
+00029730: 3d20 5b0a 2020 2020 2020 2020 2761 6227  = [.        'ab'
+00029740: 2c20 2023 206c 6573 7320 7468 616e 2033  ,  # less than 3
+00029750: 2063 6861 7261 6374 6572 730a 2020 2020   characters.    
+00029760: 2020 2020 2761 6263 6465 6667 6869 6a6b      'abcdefghijk
+00029770: 6c6d 6e6f 7071 7273 7475 7677 7879 7a61  lmnopqrstuvwxyza
+00029780: 6263 6465 6667 6869 6a6b 6c6d 6e6f 7071  bcdefghijklmnopq
+00029790: 7273 7475 7677 7879 7a61 6263 6465 6667  rstuvwxyzabcdefg
+000297a0: 6869 6a6b 6c6d 6e6f 7071 7273 7475 7677  hijklmnopqrstuvw
+000297b0: 7879 7a31 272c 0a20 2020 2020 2020 2023  xyz1',.        #
+000297c0: 206d 6f72 6520 7468 616e 2036 3320 6368   more than 63 ch
+000297d0: 6172 6163 7465 7273 0a20 2020 2020 2020  aracters.       
+000297e0: 2027 4162 6364 6566 272c 2020 2320 636f   'Abcdef',  # co
+000297f0: 6e74 6169 6e73 2061 6e20 7570 7065 7263  ntains an upperc
+00029800: 6173 6520 6c65 7474 6572 0a20 2020 2020  ase letter.     
+00029810: 2020 2027 6162 6320 6465 6627 2c20 2023     'abc def',  #
+00029820: 2063 6f6e 7461 696e 7320 6120 7370 6163   contains a spac
+00029830: 650a 2020 2020 2020 2020 2761 6263 2e2e  e.        'abc..
+00029840: 6465 6627 2c20 2023 2074 776f 2061 646a  def',  # two adj
+00029850: 6163 656e 7420 7065 7269 6f64 730a 2020  acent periods.  
+00029860: 2020 2020 2020 2731 3932 2e31 3638 2e35        '192.168.5
+00029870: 2e34 272c 2020 2320 666f 726d 6174 7465  .4',  # formatte
+00029880: 6420 6173 2061 6e20 4950 2061 6464 7265  d as an IP addre
+00029890: 7373 0a20 2020 2020 2020 2027 786e 2d2d  ss.        'xn--
+000298a0: 6275 636b 6574 272c 2020 2320 7374 6172  bucket',  # star
+000298b0: 7473 2077 6974 6820 2778 6e2d 2d27 2070  ts with 'xn--' p
+000298c0: 7265 6669 780a 2020 2020 2020 2020 2762  refix.        'b
+000298d0: 7563 6b65 742d 7333 616c 6961 7327 2c20  ucket-s3alias', 
+000298e0: 2023 2065 6e64 7320 7769 7468 2027 2d73   # ends with '-s
+000298f0: 3361 6c69 6173 2720 7375 6666 6978 0a20  3alias' suffix. 
+00029900: 2020 2020 2020 2027 6275 636b 6574 2d2d         'bucket--
+00029910: 6f6c 2d73 3327 2c20 2023 2065 6e64 7320  ol-s3',  # ends 
+00029920: 7769 7468 2027 2d2d 6f6c 2d73 3327 2073  with '--ol-s3' s
+00029930: 7566 6669 780a 2020 2020 2020 2020 272e  uffix.        '.
+00029940: 6162 6327 2c20 2023 2073 7461 7274 7320  abc',  # starts 
+00029950: 7769 7468 2061 2064 6f74 0a20 2020 2020  with a dot.     
+00029960: 2020 2027 6162 632e 272c 2020 2320 656e     'abc.',  # en
+00029970: 6473 2077 6974 6820 6120 646f 740a 2020  ds with a dot.  
+00029980: 2020 2020 2020 272d 6162 6327 2c20 2023        '-abc',  #
+00029990: 2073 7461 7274 7320 7769 7468 2061 2068   starts with a h
+000299a0: 7970 6865 6e0a 2020 2020 2020 2020 2761  yphen.        'a
+000299b0: 6263 2d27 2c20 2023 2065 6e64 7320 7769  bc-',  # ends wi
+000299c0: 7468 2061 2068 7970 6865 6e0a 2020 2020  th a hyphen.    
+000299d0: 5d0a 0a20 2020 2047 4353 5f49 4e56 414c  ]..    GCS_INVAL
+000299e0: 4944 5f4e 414d 4553 203d 205b 0a20 2020  ID_NAMES = [.   
+000299f0: 2020 2020 2027 6162 272c 2020 2320 6c65       'ab',  # le
+00029a00: 7373 2074 6861 6e20 3320 6368 6172 6163  ss than 3 charac
+00029a10: 7465 7273 0a20 2020 2020 2020 2027 6162  ters.        'ab
+00029a20: 6364 6566 6768 696a 6b6c 6d6e 6f70 7172  cdefghijklmnopqr
+00029a30: 7374 7576 7778 797a 6162 6364 6566 6768  stuvwxyzabcdefgh
+00029a40: 696a 6b6c 6d6e 6f70 7172 7374 7576 7778  ijklmnopqrstuvwx
+00029a50: 797a 6162 6364 6566 6768 696a 6b6c 6d6e  yzabcdefghijklmn
+00029a60: 6f70 7172 7374 7576 7778 797a 3127 2c0a  opqrstuvwxyz1',.
+00029a70: 2020 2020 2020 2020 2320 6d6f 7265 2074          # more t
+00029a80: 6861 6e20 3633 2063 6861 7261 6374 6572  han 63 character
+00029a90: 7320 2877 6974 686f 7574 2064 6f74 7329  s (without dots)
+00029aa0: 0a20 2020 2020 2020 2027 4162 6364 6566  .        'Abcdef
+00029ab0: 272c 2020 2320 636f 6e74 6169 6e73 2061  ',  # contains a
+00029ac0: 6e20 7570 7065 7263 6173 6520 6c65 7474  n uppercase lett
+00029ad0: 6572 0a20 2020 2020 2020 2027 6162 6320  er.        'abc 
+00029ae0: 6465 6627 2c20 2023 2063 6f6e 7461 696e  def',  # contain
+00029af0: 7320 6120 7370 6163 650a 2020 2020 2020  s a space.      
+00029b00: 2020 2761 6263 2e2e 6465 6627 2c20 2023    'abc..def',  #
+00029b10: 2074 776f 2061 646a 6163 656e 7420 7065   two adjacent pe
+00029b20: 7269 6f64 730a 2020 2020 2020 2020 2761  riods.        'a
+00029b30: 6263 5f2e 6465 662e 6768 692e 6a6b 6c6d  bc_.def.ghi.jklm
+00029b40: 6e6f 7071 7273 7475 7677 7879 7a61 6263  nopqrstuvwxyzabc
+00029b50: 6465 6667 6869 6a6b 6c6d 6e6f 7071 7273  defghijklmnopqrs
+00029b60: 7475 7677 7879 7a61 6263 6465 6667 6869  tuvwxyzabcdefghi
+00029b70: 6a6b 6c6d 6e6f 7071 7273 7475 7677 7879  jklmnopqrstuvwxy
+00029b80: 7a31 270a 2020 2020 2020 2020 2320 4d6f  z1'.        # Mo
+00029b90: 7265 2074 6861 6e20 3633 2063 6861 7261  re than 63 chara
+00029ba0: 6374 6572 7320 6265 7477 6565 6e20 646f  cters between do
+00029bb0: 7473 0a20 2020 2020 2020 2027 6162 635f  ts.        'abc_
+00029bc0: 2e64 6566 2e67 6869 2e6a 6b6c 6d6e 6f70  .def.ghi.jklmnop
+00029bd0: 7172 7374 7576 7778 797a 6162 6364 6566  qrstuvwxyzabcdef
+00029be0: 6768 696a 6b6c 6d6e 6f70 7166 6768 696a  ghijklmnopqfghij
+00029bf0: 6b6c 6d6e 6f70 7172 7374 7576 7727 202a  klmnopqrstuvw' *
+00029c00: 2035 2c0a 2020 2020 2020 2020 2320 6d6f   5,.        # mo
+00029c10: 7265 2074 6861 6e20 3232 3220 6368 6172  re than 222 char
+00029c20: 6163 7465 7273 2028 7769 7468 2064 6f74  acters (with dot
+00029c30: 7329 0a20 2020 2020 2020 2027 3139 322e  s).        '192.
+00029c40: 3136 382e 352e 3427 2c20 2023 2066 6f72  168.5.4',  # for
+00029c50: 6d61 7474 6564 2061 7320 616e 2049 5020  matted as an IP 
+00029c60: 6164 6472 6573 730a 2020 2020 2020 2020  address.        
+00029c70: 2767 6f6f 6762 7563 6b65 7427 2c20 2023  'googbucket',  #
+00029c80: 2073 7461 7274 7320 7769 7468 2027 676f   starts with 'go
+00029c90: 6f67 2720 7072 6566 6978 0a20 2020 2020  og' prefix.     
+00029ca0: 2020 2027 676f 6f67 6c65 6275 636b 6574     'googlebucket
+00029cb0: 272c 2020 2320 636f 6e74 6169 6e73 2027  ',  # contains '
+00029cc0: 676f 6f67 6c65 270a 2020 2020 2020 2020  google'.        
+00029cd0: 2767 3030 676c 6562 7563 6b65 7427 2c20  'g00glebucket', 
+00029ce0: 2023 2076 6172 6961 6e74 206f 6620 2767   # variant of 'g
+00029cf0: 6f6f 676c 6527 0a20 2020 2020 2020 2027  oogle'.        '
+00029d00: 676f 3067 6c65 6275 636b 6574 272c 2020  go0glebucket',  
+00029d10: 2320 7661 7269 616e 7420 6f66 2027 676f  # variant of 'go
+00029d20: 6f67 6c65 270a 2020 2020 2020 2020 2767  ogle'.        'g
+00029d30: 306f 676c 6562 7563 6b65 7427 2c20 2023  0oglebucket',  #
+00029d40: 2076 6172 6961 6e74 206f 6620 2767 6f6f   variant of 'goo
+00029d50: 676c 6527 0a20 2020 2020 2020 2027 2e61  gle'.        '.a
+00029d60: 6263 272c 2020 2320 7374 6172 7473 2077  bc',  # starts w
+00029d70: 6974 6820 6120 646f 740a 2020 2020 2020  ith a dot.      
+00029d80: 2020 2761 6263 2e27 2c20 2023 2065 6e64    'abc.',  # end
+00029d90: 7320 7769 7468 2061 2064 6f74 0a20 2020  s with a dot.   
+00029da0: 2020 2020 2027 5f61 6263 272c 2020 2320       '_abc',  # 
+00029db0: 7374 6172 7473 2077 6974 6820 616e 2075  starts with an u
+00029dc0: 6e64 6572 7363 6f72 650a 2020 2020 2020  nderscore.      
+00029dd0: 2020 2761 6263 5f27 2c20 2023 2065 6e64    'abc_',  # end
+00029de0: 7320 7769 7468 2061 6e20 756e 6465 7273  s with an unders
+00029df0: 636f 7265 0a20 2020 205d 0a0a 2020 2020  core.    ]..    
+00029e00: 4942 4d5f 494e 5641 4c49 445f 4e41 4d45  IBM_INVALID_NAME
+00029e10: 5320 3d20 5b0a 2020 2020 2020 2020 2761  S = [.        'a
+00029e20: 6227 2c20 2023 206c 6573 7320 7468 616e  b',  # less than
+00029e30: 2033 2063 6861 7261 6374 6572 730a 2020   3 characters.  
+00029e40: 2020 2020 2020 2761 6263 6465 6667 6869        'abcdefghi
+00029e50: 6a6b 6c6d 6e6f 7071 7273 7475 7677 7879  jklmnopqrstuvwxy
+00029e60: 7a61 6263 6465 6667 6869 6a6b 6c6d 6e6f  zabcdefghijklmno
+00029e70: 7071 7273 7475 7677 7879 7a61 6263 6465  pqrstuvwxyzabcde
+00029e80: 6667 6869 6a6b 6c6d 6e6f 7071 7273 7475  fghijklmnopqrstu
+00029e90: 7677 7879 7a31 272c 0a20 2020 2020 2020  vwxyz1',.       
+00029ea0: 2023 206d 6f72 6520 7468 616e 2036 3320   # more than 63 
+00029eb0: 6368 6172 6163 7465 7273 0a20 2020 2020  characters.     
+00029ec0: 2020 2027 4162 6364 6566 272c 2020 2320     'Abcdef',  # 
+00029ed0: 636f 6e74 6169 6e73 2061 6e20 7570 7065  contains an uppe
+00029ee0: 7263 6173 6520 6c65 7474 6572 0a20 2020  rcase letter.   
+00029ef0: 2020 2020 2027 6162 6320 6465 6627 2c20       'abc def', 
+00029f00: 2023 2063 6f6e 7461 696e 7320 6120 7370   # contains a sp
+00029f10: 6163 650a 2020 2020 2020 2020 2761 6263  ace.        'abc
+00029f20: 2e2e 6465 6627 2c20 2023 2074 776f 2061  ..def',  # two a
+00029f30: 646a 6163 656e 7420 7065 7269 6f64 730a  djacent periods.
+00029f40: 2020 2020 2020 2020 2731 3932 2e31 3638          '192.168
+00029f50: 2e35 2e34 272c 2020 2320 666f 726d 6174  .5.4',  # format
+00029f60: 7465 6420 6173 2061 6e20 4950 2061 6464  ted as an IP add
+00029f70: 7265 7373 0a20 2020 2020 2020 2027 786e  ress.        'xn
+00029f80: 2d2d 6275 636b 6574 272c 2020 2320 7374  --bucket',  # st
+00029f90: 6172 7473 2077 6974 6820 2778 6e2d 2d27  arts with 'xn--'
+00029fa0: 2070 7265 6669 780a 2020 2020 2020 2020   prefix.        
+00029fb0: 272e 6162 6327 2c20 2023 2073 7461 7274  '.abc',  # start
+00029fc0: 7320 7769 7468 2061 2064 6f74 0a20 2020  s with a dot.   
+00029fd0: 2020 2020 2027 6162 632e 272c 2020 2320       'abc.',  # 
+00029fe0: 656e 6473 2077 6974 6820 6120 646f 740a  ends with a dot.
+00029ff0: 2020 2020 2020 2020 272d 6162 6327 2c20          '-abc', 
+0002a000: 2023 2073 7461 7274 7320 7769 7468 2061   # starts with a
+0002a010: 2068 7970 6865 6e0a 2020 2020 2020 2020   hyphen.        
+0002a020: 2761 6263 2d27 2c20 2023 2065 6e64 7320  'abc-',  # ends 
+0002a030: 7769 7468 2061 2068 7970 6865 6e0a 2020  with a hyphen.  
+0002a040: 2020 2020 2020 2761 2e2d 6263 272c 2020        'a.-bc',  
+0002a050: 2320 636f 6e74 6169 6e73 2074 6865 2073  # contains the s
+0002a060: 6571 7565 6e63 6520 272e 2d27 0a20 2020  equence '.-'.   
+0002a070: 2020 2020 2027 612d 2e62 6327 2c20 2023       'a-.bc',  #
+0002a080: 2063 6f6e 7461 696e 7320 7468 6520 7365   contains the se
+0002a090: 7175 656e 6365 2027 2d2e 270a 2020 2020  quence '-.'.    
+0002a0a0: 2020 2020 2761 2662 6327 2020 2320 636f      'a&bc'  # co
+0002a0b0: 6e74 6169 6e73 2073 7065 6369 616c 2063  ntains special c
+0002a0c0: 6861 7261 6374 6572 730a 2020 2020 2020  haracters.      
+0002a0d0: 2020 2761 625e 6327 2020 2320 636f 6e74    'ab^c'  # cont
+0002a0e0: 6169 6e73 2073 7065 6369 616c 2063 6861  ains special cha
+0002a0f0: 7261 6374 6572 730a 2020 2020 5d0a 2020  racters.    ].  
+0002a100: 2020 4749 5449 474e 4f52 455f 5359 4e43    GITIGNORE_SYNC
+0002a110: 5f54 4553 545f 4449 525f 5354 5255 4354  _TEST_DIR_STRUCT
+0002a120: 5552 4520 3d20 7b0a 2020 2020 2020 2020  URE = {.        
+0002a130: 2764 6f75 626c 655f 6173 7465 7269 736b  'double_asterisk
+0002a140: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
+0002a150: 2027 646f 7562 6c65 5f61 7374 6572 6973   'double_asteris
+0002a160: 6b5f 6578 636c 7564 6564 273a 204e 6f6e  k_excluded': Non
+0002a170: 652c 0a20 2020 2020 2020 2020 2020 2027  e,.            '
+0002a180: 646f 7562 6c65 5f61 7374 6572 6973 6b5f  double_asterisk_
+0002a190: 6578 636c 7564 6564 5f64 6972 273a 207b  excluded_dir': {
+0002a1a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a1b0: 2027 6469 725f 6578 636c 7564 6564 273a   'dir_excluded':
+0002a1c0: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
+0002a1d0: 2020 207d 2c0a 2020 2020 2020 2020 7d2c     },.        },
+0002a1e0: 0a20 2020 2020 2020 2027 646f 7562 6c65  .        'double
+0002a1f0: 5f61 7374 6572 6973 6b5f 7061 7265 6e74  _asterisk_parent
+0002a200: 273a 207b 0a20 2020 2020 2020 2020 2020  ': {.           
+0002a210: 2027 7061 7265 6e74 273a 207b 0a20 2020   'parent': {.   
+0002a220: 2020 2020 2020 2020 2020 2020 2027 616c               'al
+0002a230: 736f 5f65 7863 6c75 6465 642e 7478 7427  so_excluded.txt'
+0002a240: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
+0002a250: 2020 2020 2020 2020 2763 6869 6c64 273a          'child':
+0002a260: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0002a270: 2020 2020 2020 2027 646f 7562 6c65 5f61         'double_a
+0002a280: 7374 6572 6973 6b5f 7061 7265 6e74 5f63  sterisk_parent_c
+0002a290: 6869 6c64 5f65 7863 6c75 6465 642e 7478  hild_excluded.tx
+0002a2a0: 7427 3a20 4e6f 6e65 2c0a 2020 2020 2020  t': None,.      
+0002a2b0: 2020 2020 2020 2020 2020 7d2c 0a20 2020            },.   
+0002a2c0: 2020 2020 2020 2020 2020 2020 2027 646f               'do
+0002a2d0: 7562 6c65 5f61 7374 6572 6973 6b5f 7061  uble_asterisk_pa
+0002a2e0: 7265 6e74 5f65 7863 6c75 6465 642e 7478  rent_excluded.tx
+0002a2f0: 7427 3a20 4e6f 6e65 2c0a 2020 2020 2020  t': None,.      
+0002a300: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
+0002a310: 207d 2c0a 2020 2020 2020 2020 2765 7863   },.        'exc
+0002a320: 6c75 6465 642e 6c6f 6727 3a20 4e6f 6e65  luded.log': None
+0002a330: 2c0a 2020 2020 2020 2020 2765 7863 6c75  ,.        'exclu
+0002a340: 6465 645f 6469 7227 3a20 7b0a 2020 2020  ded_dir': {.    
+0002a350: 2020 2020 2020 2020 2765 7863 6c75 6465          'exclude
+0002a360: 642e 7478 7427 3a20 4e6f 6e65 2c0a 2020  d.txt': None,.  
+0002a370: 2020 2020 2020 2020 2020 276e 6573 7465            'neste
+0002a380: 645f 6578 636c 7564 6564 273a 207b 0a20  d_excluded': {. 
+0002a390: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0002a3a0: 6578 636c 7564 6564 273a 204e 6f6e 652c  excluded': None,
+0002a3b0: 0a20 2020 2020 2020 2020 2020 207d 2c0a  .            },.
+0002a3c0: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
+0002a3d0: 2020 2027 6578 702d 3127 3a20 7b0a 2020     'exp-1': {.  
+0002a3e0: 2020 2020 2020 2020 2020 2762 655f 6578            'be_ex
+0002a3f0: 636c 7564 6564 273a 204e 6f6e 652c 0a20  cluded': None,. 
+0002a400: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
+0002a410: 2020 2765 7870 2d32 273a 207b 0a20 2020    'exp-2': {.   
+0002a420: 2020 2020 2020 2020 2027 6265 5f65 7863           'be_exc
+0002a430: 6c75 6465 6427 3a20 4e6f 6e65 2c0a 2020  luded': None,.  
+0002a440: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
+0002a450: 2027 6672 6f6e 745f 736c 6173 685f 6578   'front_slash_ex
+0002a460: 636c 7564 6564 273a 204e 6f6e 652c 0a20  cluded': None,. 
+0002a470: 2020 2020 2020 2027 696e 636c 7564 6564         'included
+0002a480: 2e6c 6f67 273a 204e 6f6e 652c 0a20 2020  .log': None,.   
+0002a490: 2020 2020 2027 696e 636c 7564 6564 2e74       'included.t
+0002a4a0: 7874 273a 204e 6f6e 652c 0a20 2020 2020  xt': None,.     
+0002a4b0: 2020 2027 696e 636c 7564 655f 6469 7227     'include_dir'
+0002a4c0: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
+0002a4d0: 2765 7863 6c75 6465 642e 6c6f 6727 3a20  'excluded.log': 
+0002a4e0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+0002a4f0: 2020 2769 6e63 6c75 6465 642e 6c6f 6727    'included.log'
+0002a500: 3a20 4e6f 6e65 2c0a 2020 2020 2020 2020  : None,.        
+0002a510: 7d2c 0a20 2020 2020 2020 2027 6e65 7374  },.        'nest
+0002a520: 6564 5f64 6f75 626c 655f 6173 7465 7269  ed_double_asteri
+0002a530: 736b 273a 207b 0a20 2020 2020 2020 2020  sk': {.         
+0002a540: 2020 2027 6f6e 6527 3a20 7b0a 2020 2020     'one': {.    
+0002a550: 2020 2020 2020 2020 2020 2020 2761 6c73              'als
+0002a560: 6f5f 6578 636c 7564 652e 7478 7427 3a20  o_exclude.txt': 
+0002a570: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
+0002a580: 2020 7d2c 0a20 2020 2020 2020 2020 2020    },.           
+0002a590: 2027 7477 6f27 3a20 7b0a 2020 2020 2020   'two': {.      
+0002a5a0: 2020 2020 2020 2020 2020 2761 6c73 6f5f            'also_
+0002a5b0: 6578 636c 7564 652e 7478 7427 3a20 4e6f  exclude.txt': No
+0002a5c0: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+0002a5d0: 7d2c 0a20 2020 2020 2020 207d 2c0a 2020  },.        },.  
+0002a5e0: 2020 2020 2020 276e 6573 7465 645f 7769        'nested_wi
+0002a5f0: 6c64 6361 7264 5f64 6972 273a 207b 0a20  ldcard_dir': {. 
+0002a600: 2020 2020 2020 2020 2020 2027 6d6f 6e64             'mond
+0002a610: 6179 273a 207b 0a20 2020 2020 2020 2020  ay': {.         
+0002a620: 2020 2020 2020 2027 616c 736f 5f65 7863         'also_exc
+0002a630: 6c75 6465 2e74 7874 273a 204e 6f6e 652c  lude.txt': None,
+0002a640: 0a20 2020 2020 2020 2020 2020 207d 2c0a  .            },.
+0002a650: 2020 2020 2020 2020 2020 2020 2774 7565              'tue
+0002a660: 7364 6179 273a 207b 0a20 2020 2020 2020  sday': {.       
+0002a670: 2020 2020 2020 2020 2027 616c 736f 5f65           'also_e
+0002a680: 7863 6c75 6465 2e74 7874 273a 204e 6f6e  xclude.txt': Non
+0002a690: 652c 0a20 2020 2020 2020 2020 2020 207d  e,.            }
+0002a6a0: 2c0a 2020 2020 2020 2020 7d2c 0a20 2020  ,.        },.   
+0002a6b0: 2020 2020 2027 6e6f 5f73 6c61 7368 5f65       'no_slash_e
+0002a6c0: 7863 6c75 6465 6427 3a20 4e6f 6e65 2c0a  xcluded': None,.
+0002a6d0: 2020 2020 2020 2020 276e 6f5f 736c 6173          'no_slas
+0002a6e0: 685f 7465 7374 7327 3a20 7b0a 2020 2020  h_tests': {.    
+0002a6f0: 2020 2020 2020 2020 276e 6f5f 736c 6173          'no_slas
+0002a700: 685f 6578 636c 7564 6564 273a 207b 0a20  h_excluded': {. 
+0002a710: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0002a720: 616c 736f 5f65 7863 6c75 6465 642e 7478  also_excluded.tx
+0002a730: 7427 3a20 4e6f 6e65 2c0a 2020 2020 2020  t': None,.      
+0002a740: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
+0002a750: 207d 2c0a 2020 2020 2020 2020 2771 7565   },.        'que
+0002a760: 7374 696f 6e5f 6d61 726b 273a 207b 0a20  stion_mark': {. 
+0002a770: 2020 2020 2020 2020 2020 2027 6578 636c             'excl
+0002a780: 7564 6564 312e 7478 7427 3a20 4e6f 6e65  uded1.txt': None
+0002a790: 2c0a 2020 2020 2020 2020 2020 2020 2765  ,.            'e
+0002a7a0: 7863 6c75 6465 6440 2e74 7874 273a 204e  xcluded@.txt': N
+0002a7b0: 6f6e 652c 0a20 2020 2020 2020 207d 2c0a  one,.        },.
+0002a7c0: 2020 2020 2020 2020 2773 7175 6172 655f          'square_
+0002a7d0: 6272 6163 6b65 7427 3a20 7b0a 2020 2020  bracket': {.    
+0002a7e0: 2020 2020 2020 2020 2765 7863 6c75 6465          'exclude
+0002a7f0: 6431 2e74 7874 273a 204e 6f6e 652c 0a20  d1.txt': None,. 
+0002a800: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
+0002a810: 2020 2773 7175 6172 655f 6272 6163 6b65    'square_bracke
+0002a820: 745f 616c 7068 6127 3a20 7b0a 2020 2020  t_alpha': {.    
+0002a830: 2020 2020 2020 2020 2765 7863 6c75 6465          'exclude
+0002a840: 647a 2e74 7874 273a 204e 6f6e 652c 0a20  dz.txt': None,. 
+0002a850: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
+0002a860: 2020 2773 7175 6172 655f 6272 6163 6b65    'square_bracke
+0002a870: 745f 6578 636c 6127 3a20 7b0a 2020 2020  t_excla': {.    
+0002a880: 2020 2020 2020 2020 2765 7863 6c75 6465          'exclude
+0002a890: 6432 2e74 7874 273a 204e 6f6e 652c 0a20  d2.txt': None,. 
+0002a8a0: 2020 2020 2020 2020 2020 2027 6578 636c             'excl
+0002a8b0: 7564 6564 402e 7478 7427 3a20 4e6f 6e65  uded@.txt': None
+0002a8c0: 2c0a 2020 2020 2020 2020 7d2c 0a20 2020  ,.        },.   
+0002a8d0: 2020 2020 2027 7371 7561 7265 5f62 7261       'square_bra
+0002a8e0: 636b 6574 5f73 696e 676c 6527 3a20 7b0a  cket_single': {.
+0002a8f0: 2020 2020 2020 2020 2020 2020 2765 7863              'exc
+0002a900: 6c75 6465 6430 2e74 7874 273a 204e 6f6e  luded0.txt': Non
+0002a910: 652c 0a20 2020 2020 2020 207d 2c0a 2020  e,.        },.  
+0002a920: 2020 7d0a 0a20 2020 2040 7374 6174 6963    }..    @static
+0002a930: 6d65 7468 6f64 0a20 2020 2064 6566 2063  method.    def c
+0002a940: 7265 6174 655f 6469 725f 7374 7275 6374  reate_dir_struct
+0002a950: 7572 6528 6261 7365 5f70 6174 682c 2073  ure(base_path, s
+0002a960: 7472 7563 7475 7265 293a 0a20 2020 2020  tructure):.     
+0002a970: 2020 2023 2063 7265 6174 6573 2061 2067     # creates a g
+0002a980: 6976 656e 2066 696c 6520 5354 5255 4354  iven file STRUCT
+0002a990: 5552 4520 696e 2042 4153 455f 5041 5448  URE in BASE_PATH
+0002a9a0: 0a20 2020 2020 2020 2066 6f72 206e 616d  .        for nam
+0002a9b0: 652c 2073 7562 7374 7275 6374 7572 6520  e, substructure 
+0002a9c0: 696e 2073 7472 7563 7475 7265 2e69 7465  in structure.ite
+0002a9d0: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
+0002a9e0: 2020 7061 7468 203d 206f 732e 7061 7468    path = os.path
+0002a9f0: 2e6a 6f69 6e28 6261 7365 5f70 6174 682c  .join(base_path,
+0002aa00: 206e 616d 6529 0a20 2020 2020 2020 2020   name).         
+0002aa10: 2020 2069 6620 7375 6273 7472 7563 7475     if substructu
+0002aa20: 7265 2069 7320 4e6f 6e65 3a0a 2020 2020  re is None:.    
+0002aa30: 2020 2020 2020 2020 2020 2020 2320 4372              # Cr
+0002aa40: 6561 7465 2061 2066 696c 650a 2020 2020  eate a file.    
+0002aa50: 2020 2020 2020 2020 2020 2020 6f70 656e              open
+0002aa60: 2870 6174 682c 2027 6127 2c20 656e 636f  (path, 'a', enco
+0002aa70: 6469 6e67 3d27 7574 662d 3827 292e 636c  ding='utf-8').cl
+0002aa80: 6f73 6528 290a 2020 2020 2020 2020 2020  ose().          
+0002aa90: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0002aaa0: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
+0002aab0: 2061 2073 7562 6469 7265 6374 6f72 790a   a subdirectory.
+0002aac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002aad0: 6f73 2e6d 6b64 6972 2870 6174 6829 0a20  os.mkdir(path). 
+0002aae0: 2020 2020 2020 2020 2020 2020 2020 2054                 T
+0002aaf0: 6573 7453 746f 7261 6765 5769 7468 4372  estStorageWithCr
+0002ab00: 6564 656e 7469 616c 732e 6372 6561 7465  edentials.create
+0002ab10: 5f64 6972 5f73 7472 7563 7475 7265 280a  _dir_structure(.
+0002ab20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ab30: 2020 2020 7061 7468 2c20 7375 6273 7472      path, substr
+0002ab40: 7563 7475 7265 290a 0a20 2020 2040 7374  ucture)..    @st
+0002ab50: 6174 6963 6d65 7468 6f64 0a20 2020 2064  aticmethod.    d
+0002ab60: 6566 2063 6c69 5f64 656c 6574 655f 636d  ef cli_delete_cm
+0002ab70: 6428 7374 6f72 655f 7479 7065 2c20 6275  d(store_type, bu
+0002ab80: 636b 6574 5f6e 616d 6529 3a0a 2020 2020  cket_name):.    
+0002ab90: 2020 2020 6966 2073 746f 7265 5f74 7970      if store_typ
+0002aba0: 6520 3d3d 2073 746f 7261 6765 5f6c 6962  e == storage_lib
+0002abb0: 2e53 746f 7265 5479 7065 2e53 333a 0a20  .StoreType.S3:. 
+0002abc0: 2020 2020 2020 2020 2020 2075 726c 203d             url =
+0002abd0: 2066 2773 333a 2f2f 7b62 7563 6b65 745f   f's3://{bucket_
+0002abe0: 6e61 6d65 7d27 0a20 2020 2020 2020 2020  name}'.         
+0002abf0: 2020 2072 6574 7572 6e20 6627 6177 7320     return f'aws 
+0002ac00: 7333 2072 6220 7b75 726c 7d20 2d2d 666f  s3 rb {url} --fo
+0002ac10: 7263 6527 0a20 2020 2020 2020 2069 6620  rce'.        if 
+0002ac20: 7374 6f72 655f 7479 7065 203d 3d20 7374  store_type == st
+0002ac30: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+0002ac40: 7970 652e 4743 533a 0a20 2020 2020 2020  ype.GCS:.       
+0002ac50: 2020 2020 2075 726c 203d 2066 2767 733a       url = f'gs:
+0002ac60: 2f2f 7b62 7563 6b65 745f 6e61 6d65 7d27  //{bucket_name}'
+0002ac70: 0a20 2020 2020 2020 2020 2020 2067 7375  .            gsu
+0002ac80: 7469 6c5f 616c 6961 732c 2061 6c69 6173  til_alias, alias
+0002ac90: 5f67 656e 203d 2064 6174 615f 7574 696c  _gen = data_util
+0002aca0: 732e 6765 745f 6773 7574 696c 5f63 6f6d  s.get_gsutil_com
+0002acb0: 6d61 6e64 2829 0a20 2020 2020 2020 2020  mand().         
+0002acc0: 2020 2072 6574 7572 6e20 6627 7b61 6c69     return f'{ali
+0002acd0: 6173 5f67 656e 7d3b 207b 6773 7574 696c  as_gen}; {gsutil
+0002ace0: 5f61 6c69 6173 7d20 726d 202d 7220 7b75  _alias} rm -r {u
+0002acf0: 726c 7d27 0a20 2020 2020 2020 2069 6620  rl}'.        if 
+0002ad00: 7374 6f72 655f 7479 7065 203d 3d20 7374  store_type == st
+0002ad10: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+0002ad20: 7970 652e 5232 3a0a 2020 2020 2020 2020  ype.R2:.        
+0002ad30: 2020 2020 656e 6470 6f69 6e74 5f75 726c      endpoint_url
+0002ad40: 203d 2063 6c6f 7564 666c 6172 652e 6372   = cloudflare.cr
+0002ad50: 6561 7465 5f65 6e64 706f 696e 7428 290a  eate_endpoint().
+0002ad60: 2020 2020 2020 2020 2020 2020 7572 6c20              url 
+0002ad70: 3d20 6627 7333 3a2f 2f7b 6275 636b 6574  = f's3://{bucket
+0002ad80: 5f6e 616d 657d 270a 2020 2020 2020 2020  _name}'.        
+0002ad90: 2020 2020 7265 7475 726e 2066 2741 5753      return f'AWS
+0002ada0: 5f53 4841 5245 445f 4352 4544 454e 5449  _SHARED_CREDENTI
+0002adb0: 414c 535f 4649 4c45 3d7b 636c 6f75 6466  ALS_FILE={cloudf
+0002adc0: 6c61 7265 2e52 325f 4352 4544 454e 5449  lare.R2_CREDENTI
+0002add0: 414c 535f 5041 5448 7d20 6177 7320 7333  ALS_PATH} aws s3
+0002ade0: 2072 6220 7b75 726c 7d20 2d2d 666f 7263   rb {url} --forc
+0002adf0: 6520 2d2d 656e 6470 6f69 6e74 207b 656e  e --endpoint {en
+0002ae00: 6470 6f69 6e74 5f75 726c 7d20 2d2d 7072  dpoint_url} --pr
+0002ae10: 6f66 696c 653d 7232 270a 2020 2020 2020  ofile=r2'.      
+0002ae20: 2020 6966 2073 746f 7265 5f74 7970 6520    if store_type 
+0002ae30: 3d3d 2073 746f 7261 6765 5f6c 6962 2e53  == storage_lib.S
+0002ae40: 746f 7265 5479 7065 2e49 424d 3a0a 2020  toreType.IBM:.  
+0002ae50: 2020 2020 2020 2020 2020 6275 636b 6574            bucket
+0002ae60: 5f72 636c 6f6e 655f 7072 6f66 696c 6520  _rclone_profile 
+0002ae70: 3d20 5263 6c6f 6e65 2e67 656e 6572 6174  = Rclone.generat
+0002ae80: 655f 7263 6c6f 6e65 5f62 7563 6b65 745f  e_rclone_bucket_
+0002ae90: 7072 6f66 696c 655f 6e61 6d65 280a 2020  profile_name(.  
+0002aea0: 2020 2020 2020 2020 2020 2020 2020 6275                bu
+0002aeb0: 636b 6574 5f6e 616d 652c 2052 636c 6f6e  cket_name, Rclon
+0002aec0: 652e 5263 6c6f 6e65 436c 6f75 6473 2e49  e.RcloneClouds.I
+0002aed0: 424d 290a 2020 2020 2020 2020 2020 2020  BM).            
+0002aee0: 7265 7475 726e 2066 2772 636c 6f6e 6520  return f'rclone 
+0002aef0: 7075 7267 6520 7b62 7563 6b65 745f 7263  purge {bucket_rc
+0002af00: 6c6f 6e65 5f70 726f 6669 6c65 7d3a 7b62  lone_profile}:{b
+0002af10: 7563 6b65 745f 6e61 6d65 7d20 2626 2072  ucket_name} && r
+0002af20: 636c 6f6e 6520 636f 6e66 6967 2064 656c  clone config del
+0002af30: 6574 6520 7b62 7563 6b65 745f 7263 6c6f  ete {bucket_rclo
+0002af40: 6e65 5f70 726f 6669 6c65 7d27 0a0a 2020  ne_profile}'..  
+0002af50: 2020 4073 7461 7469 636d 6574 686f 640a    @staticmethod.
+0002af60: 2020 2020 6465 6620 636c 695f 6c73 5f63      def cli_ls_c
+0002af70: 6d64 2873 746f 7265 5f74 7970 652c 2062  md(store_type, b
+0002af80: 7563 6b65 745f 6e61 6d65 2c20 7375 6666  ucket_name, suff
+0002af90: 6978 3d27 2729 3a0a 2020 2020 2020 2020  ix=''):.        
+0002afa0: 6966 2073 746f 7265 5f74 7970 6520 3d3d  if store_type ==
+0002afb0: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+0002afc0: 7265 5479 7065 2e53 333a 0a20 2020 2020  reType.S3:.     
+0002afd0: 2020 2020 2020 2069 6620 7375 6666 6978         if suffix
+0002afe0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002aff0: 2020 7572 6c20 3d20 6627 7333 3a2f 2f7b    url = f's3://{
+0002b000: 6275 636b 6574 5f6e 616d 657d 2f7b 7375  bucket_name}/{su
+0002b010: 6666 6978 7d27 0a20 2020 2020 2020 2020  ffix}'.         
+0002b020: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0002b030: 2020 2020 2020 2020 2075 726c 203d 2066           url = f
+0002b040: 2773 333a 2f2f 7b62 7563 6b65 745f 6e61  's3://{bucket_na
+0002b050: 6d65 7d27 0a20 2020 2020 2020 2020 2020  me}'.           
+0002b060: 2072 6574 7572 6e20 6627 6177 7320 7333   return f'aws s3
+0002b070: 206c 7320 7b75 726c 7d27 0a20 2020 2020   ls {url}'.     
+0002b080: 2020 2069 6620 7374 6f72 655f 7479 7065     if store_type
+0002b090: 203d 3d20 7374 6f72 6167 655f 6c69 622e   == storage_lib.
+0002b0a0: 5374 6f72 6554 7970 652e 4743 533a 0a20  StoreType.GCS:. 
+0002b0b0: 2020 2020 2020 2020 2020 2069 6620 7375             if su
+0002b0c0: 6666 6978 3a0a 2020 2020 2020 2020 2020  ffix:.          
+0002b0d0: 2020 2020 2020 7572 6c20 3d20 6627 6773        url = f'gs
+0002b0e0: 3a2f 2f7b 6275 636b 6574 5f6e 616d 657d  ://{bucket_name}
+0002b0f0: 2f7b 7375 6666 6978 7d27 0a20 2020 2020  /{suffix}'.     
+0002b100: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0002b110: 2020 2020 2020 2020 2020 2020 2075 726c               url
+0002b120: 203d 2066 2767 733a 2f2f 7b62 7563 6b65   = f'gs://{bucke
+0002b130: 745f 6e61 6d65 7d27 0a20 2020 2020 2020  t_name}'.       
+0002b140: 2020 2020 2072 6574 7572 6e20 6627 6773       return f'gs
+0002b150: 7574 696c 206c 7320 7b75 726c 7d27 0a20  util ls {url}'. 
+0002b160: 2020 2020 2020 2069 6620 7374 6f72 655f         if store_
+0002b170: 7479 7065 203d 3d20 7374 6f72 6167 655f  type == storage_
+0002b180: 6c69 622e 5374 6f72 6554 7970 652e 5232  lib.StoreType.R2
+0002b190: 3a0a 2020 2020 2020 2020 2020 2020 656e  :.            en
+0002b1a0: 6470 6f69 6e74 5f75 726c 203d 2063 6c6f  dpoint_url = clo
+0002b1b0: 7564 666c 6172 652e 6372 6561 7465 5f65  udflare.create_e
+0002b1c0: 6e64 706f 696e 7428 290a 2020 2020 2020  ndpoint().      
+0002b1d0: 2020 2020 2020 6966 2073 7566 6669 783a        if suffix:
+0002b1e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002b1f0: 2075 726c 203d 2066 2773 333a 2f2f 7b62   url = f's3://{b
+0002b200: 7563 6b65 745f 6e61 6d65 7d2f 7b73 7566  ucket_name}/{suf
+0002b210: 6669 787d 270a 2020 2020 2020 2020 2020  fix}'.          
+0002b220: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0002b230: 2020 2020 2020 2020 7572 6c20 3d20 6627          url = f'
+0002b240: 7333 3a2f 2f7b 6275 636b 6574 5f6e 616d  s3://{bucket_nam
+0002b250: 657d 270a 2020 2020 2020 2020 2020 2020  e}'.            
+0002b260: 7265 7475 726e 2066 2741 5753 5f53 4841  return f'AWS_SHA
+0002b270: 5245 445f 4352 4544 454e 5449 414c 535f  RED_CREDENTIALS_
+0002b280: 4649 4c45 3d7b 636c 6f75 6466 6c61 7265  FILE={cloudflare
+0002b290: 2e52 325f 4352 4544 454e 5449 414c 535f  .R2_CREDENTIALS_
+0002b2a0: 5041 5448 7d20 6177 7320 7333 206c 7320  PATH} aws s3 ls 
+0002b2b0: 7b75 726c 7d20 2d2d 656e 6470 6f69 6e74  {url} --endpoint
+0002b2c0: 207b 656e 6470 6f69 6e74 5f75 726c 7d20   {endpoint_url} 
+0002b2d0: 2d2d 7072 6f66 696c 653d 7232 270a 2020  --profile=r2'.  
+0002b2e0: 2020 2020 2020 6966 2073 746f 7265 5f74        if store_t
+0002b2f0: 7970 6520 3d3d 2073 746f 7261 6765 5f6c  ype == storage_l
+0002b300: 6962 2e53 746f 7265 5479 7065 2e49 424d  ib.StoreType.IBM
+0002b310: 3a0a 2020 2020 2020 2020 2020 2020 6275  :.            bu
+0002b320: 636b 6574 5f72 636c 6f6e 655f 7072 6f66  cket_rclone_prof
+0002b330: 696c 6520 3d20 5263 6c6f 6e65 2e67 656e  ile = Rclone.gen
+0002b340: 6572 6174 655f 7263 6c6f 6e65 5f62 7563  erate_rclone_buc
+0002b350: 6b65 745f 7072 6f66 696c 655f 6e61 6d65  ket_profile_name
+0002b360: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0002b370: 2020 6275 636b 6574 5f6e 616d 652c 2052    bucket_name, R
+0002b380: 636c 6f6e 652e 5263 6c6f 6e65 436c 6f75  clone.RcloneClou
+0002b390: 6473 2e49 424d 290a 2020 2020 2020 2020  ds.IBM).        
+0002b3a0: 2020 2020 7265 7475 726e 2066 2772 636c      return f'rcl
+0002b3b0: 6f6e 6520 6c73 207b 6275 636b 6574 5f72  one ls {bucket_r
+0002b3c0: 636c 6f6e 655f 7072 6f66 696c 657d 3a7b  clone_profile}:{
+0002b3d0: 6275 636b 6574 5f6e 616d 657d 2f7b 7375  bucket_name}/{su
+0002b3e0: 6666 6978 7d27 0a0a 2020 2020 4073 7461  ffix}'..    @sta
+0002b3f0: 7469 636d 6574 686f 640a 2020 2020 6465  ticmethod.    de
+0002b400: 6620 636c 695f 7265 6769 6f6e 5f63 6d64  f cli_region_cmd
+0002b410: 2873 746f 7265 5f74 7970 652c 2062 7563  (store_type, buc
+0002b420: 6b65 745f 6e61 6d65 293a 0a20 2020 2020  ket_name):.     
+0002b430: 2020 2069 6620 7374 6f72 655f 7479 7065     if store_type
+0002b440: 203d 3d20 7374 6f72 6167 655f 6c69 622e   == storage_lib.
+0002b450: 5374 6f72 6554 7970 652e 5333 3a0a 2020  StoreType.S3:.  
+0002b460: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0002b470: 2028 2761 7773 2073 3361 7069 2067 6574   ('aws s3api get
+0002b480: 2d62 7563 6b65 742d 6c6f 6361 7469 6f6e  -bucket-location
+0002b490: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+0002b4a0: 2020 2020 2020 2066 272d 2d62 7563 6b65         f'--bucke
+0002b4b0: 7420 7b62 7563 6b65 745f 6e61 6d65 7d20  t {bucket_name} 
+0002b4c0: 2d2d 6f75 7470 7574 2074 6578 7427 290a  --output text').
+0002b4d0: 2020 2020 2020 2020 656c 6966 2073 746f          elif sto
+0002b4e0: 7265 5f74 7970 6520 3d3d 2073 746f 7261  re_type == stora
+0002b4f0: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
+0002b500: 2e47 4353 3a0a 2020 2020 2020 2020 2020  .GCS:.          
+0002b510: 2020 7265 7475 726e 2028 6627 6773 7574    return (f'gsut
+0002b520: 696c 206c 7320 2d4c 202d 6220 6773 3a2f  il ls -L -b gs:/
+0002b530: 2f7b 6275 636b 6574 5f6e 616d 657d 2f20  /{bucket_name}/ 
+0002b540: 7c20 270a 2020 2020 2020 2020 2020 2020  | '.            
+0002b550: 2020 2020 2020 2020 2767 7265 7020 224c          'grep "L
+0002b560: 6f63 6174 696f 6e20 636f 6e73 7472 6169  ocation constrai
+0002b570: 6e74 2220 7c20 270a 2020 2020 2020 2020  nt" | '.        
+0002b580: 2020 2020 2020 2020 2020 2020 2761 776b              'awk
+0002b590: 205c 277b 7072 696e 7420 746f 6c6f 7765   \'{print tolowe
+0002b5a0: 7228 244e 4629 7d5c 2727 290a 2020 2020  r($NF)}\'').    
+0002b5b0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0002b5c0: 2020 2020 2020 7261 6973 6520 4e6f 7449        raise NotI
+0002b5d0: 6d70 6c65 6d65 6e74 6564 4572 726f 7228  mplementedError(
+0002b5e0: 6627 5265 6769 6f6e 2063 6f6d 6d61 6e64  f'Region command
+0002b5f0: 206e 6f74 2069 6d70 6c65 6d65 6e74 6564   not implemented
+0002b600: 2066 6f72 2027 0a20 2020 2020 2020 2020   for '.         
+0002b610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b620: 2020 2020 2020 2020 2020 2020 2066 277b               f'{
+0002b630: 7374 6f72 655f 7479 7065 7d27 290a 0a20  store_type}').. 
+0002b640: 2020 2040 7374 6174 6963 6d65 7468 6f64     @staticmethod
+0002b650: 0a20 2020 2064 6566 2063 6c69 5f63 6f75  .    def cli_cou
+0002b660: 6e74 5f6e 616d 655f 696e 5f62 7563 6b65  nt_name_in_bucke
+0002b670: 7428 7374 6f72 655f 7479 7065 2c20 6275  t(store_type, bu
+0002b680: 636b 6574 5f6e 616d 652c 2066 696c 655f  cket_name, file_
+0002b690: 6e61 6d65 2c20 7375 6666 6978 3d27 2729  name, suffix='')
+0002b6a0: 3a0a 2020 2020 2020 2020 6966 2073 746f  :.        if sto
+0002b6b0: 7265 5f74 7970 6520 3d3d 2073 746f 7261  re_type == stora
+0002b6c0: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
+0002b6d0: 2e53 333a 0a20 2020 2020 2020 2020 2020  .S3:.           
+0002b6e0: 2069 6620 7375 6666 6978 3a0a 2020 2020   if suffix:.    
+0002b6f0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0002b700: 726e 2066 2761 7773 2073 3361 7069 206c  rn f'aws s3api l
+0002b710: 6973 742d 6f62 6a65 6374 7320 2d2d 6275  ist-objects --bu
+0002b720: 636b 6574 2022 7b62 7563 6b65 745f 6e61  cket "{bucket_na
+0002b730: 6d65 7d22 202d 2d70 7265 6669 7820 7b73  me}" --prefix {s
+0002b740: 7566 6669 787d 202d 2d71 7565 7279 2022  uffix} --query "
+0002b750: 6c65 6e67 7468 2843 6f6e 7465 6e74 735b  length(Contents[
+0002b760: 3f63 6f6e 7461 696e 7328 4b65 792c 5c27  ?contains(Key,\'
+0002b770: 7b66 696c 655f 6e61 6d65 7d5c 2729 5d2e  {file_name}\')].
+0002b780: 4b65 7929 2227 0a20 2020 2020 2020 2020  Key)"'.         
+0002b790: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0002b7a0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0002b7b0: 6627 6177 7320 7333 6170 6920 6c69 7374  f'aws s3api list
+0002b7c0: 2d6f 626a 6563 7473 202d 2d62 7563 6b65  -objects --bucke
+0002b7d0: 7420 227b 6275 636b 6574 5f6e 616d 657d  t "{bucket_name}
+0002b7e0: 2220 2d2d 7175 6572 7920 226c 656e 6774  " --query "lengt
+0002b7f0: 6828 436f 6e74 656e 7473 5b3f 636f 6e74  h(Contents[?cont
+0002b800: 6169 6e73 284b 6579 2c5c 277b 6669 6c65  ains(Key,\'{file
+0002b810: 5f6e 616d 657d 5c27 295d 2e4b 6579 2922  _name}\')].Key)"
+0002b820: 270a 2020 2020 2020 2020 656c 6966 2073  '.        elif s
+0002b830: 746f 7265 5f74 7970 6520 3d3d 2073 746f  tore_type == sto
+0002b840: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+0002b850: 7065 2e47 4353 3a0a 2020 2020 2020 2020  pe.GCS:.        
+0002b860: 2020 2020 6966 2073 7566 6669 783a 0a20      if suffix:. 
+0002b870: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0002b880: 6574 7572 6e20 6627 6773 7574 696c 206c  eturn f'gsutil l
+0002b890: 7320 2d72 2067 733a 2f2f 7b62 7563 6b65  s -r gs://{bucke
+0002b8a0: 745f 6e61 6d65 7d2f 7b73 7566 6669 787d  t_name}/{suffix}
+0002b8b0: 207c 2067 7265 7020 227b 6669 6c65 5f6e   | grep "{file_n
+0002b8c0: 616d 657d 2220 7c20 7763 202d 6c27 0a20  ame}" | wc -l'. 
+0002b8d0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0002b8e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002b8f0: 2072 6574 7572 6e20 6627 6773 7574 696c   return f'gsutil
+0002b900: 206c 7320 2d72 2067 733a 2f2f 7b62 7563   ls -r gs://{buc
+0002b910: 6b65 745f 6e61 6d65 7d20 7c20 6772 6570  ket_name} | grep
+0002b920: 2022 7b66 696c 655f 6e61 6d65 7d22 207c   "{file_name}" |
+0002b930: 2077 6320 2d6c 270a 2020 2020 2020 2020   wc -l'.        
+0002b940: 656c 6966 2073 746f 7265 5f74 7970 6520  elif store_type 
+0002b950: 3d3d 2073 746f 7261 6765 5f6c 6962 2e53  == storage_lib.S
+0002b960: 746f 7265 5479 7065 2e52 323a 0a20 2020  toreType.R2:.   
+0002b970: 2020 2020 2020 2020 2065 6e64 706f 696e           endpoin
+0002b980: 745f 7572 6c20 3d20 636c 6f75 6466 6c61  t_url = cloudfla
+0002b990: 7265 2e63 7265 6174 655f 656e 6470 6f69  re.create_endpoi
+0002b9a0: 6e74 2829 0a20 2020 2020 2020 2020 2020  nt().           
+0002b9b0: 2069 6620 7375 6666 6978 3a0a 2020 2020   if suffix:.    
+0002b9c0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0002b9d0: 726e 2066 2741 5753 5f53 4841 5245 445f  rn f'AWS_SHARED_
+0002b9e0: 4352 4544 454e 5449 414c 535f 4649 4c45  CREDENTIALS_FILE
+0002b9f0: 3d7b 636c 6f75 6466 6c61 7265 2e52 325f  ={cloudflare.R2_
+0002ba00: 4352 4544 454e 5449 414c 535f 5041 5448  CREDENTIALS_PATH
+0002ba10: 7d20 6177 7320 7333 6170 6920 6c69 7374  } aws s3api list
+0002ba20: 2d6f 626a 6563 7473 202d 2d62 7563 6b65  -objects --bucke
+0002ba30: 7420 227b 6275 636b 6574 5f6e 616d 657d  t "{bucket_name}
+0002ba40: 2220 2d2d 7072 6566 6978 207b 7375 6666  " --prefix {suff
+0002ba50: 6978 7d20 2d2d 7175 6572 7920 226c 656e  ix} --query "len
+0002ba60: 6774 6828 436f 6e74 656e 7473 5b3f 636f  gth(Contents[?co
+0002ba70: 6e74 6169 6e73 284b 6579 2c5c 277b 6669  ntains(Key,\'{fi
+0002ba80: 6c65 5f6e 616d 657d 5c27 295d 2e4b 6579  le_name}\')].Key
+0002ba90: 2922 202d 2d65 6e64 706f 696e 7420 7b65  )" --endpoint {e
+0002baa0: 6e64 706f 696e 745f 7572 6c7d 202d 2d70  ndpoint_url} --p
+0002bab0: 726f 6669 6c65 3d72 3227 0a20 2020 2020  rofile=r2'.     
+0002bac0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0002bad0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+0002bae0: 7572 6e20 6627 4157 535f 5348 4152 4544  urn f'AWS_SHARED
+0002baf0: 5f43 5245 4445 4e54 4941 4c53 5f46 494c  _CREDENTIALS_FIL
+0002bb00: 453d 7b63 6c6f 7564 666c 6172 652e 5232  E={cloudflare.R2
+0002bb10: 5f43 5245 4445 4e54 4941 4c53 5f50 4154  _CREDENTIALS_PAT
+0002bb20: 487d 2061 7773 2073 3361 7069 206c 6973  H} aws s3api lis
+0002bb30: 742d 6f62 6a65 6374 7320 2d2d 6275 636b  t-objects --buck
+0002bb40: 6574 2022 7b62 7563 6b65 745f 6e61 6d65  et "{bucket_name
+0002bb50: 7d22 202d 2d71 7565 7279 2022 6c65 6e67  }" --query "leng
+0002bb60: 7468 2843 6f6e 7465 6e74 735b 3f63 6f6e  th(Contents[?con
+0002bb70: 7461 696e 7328 4b65 792c 5c27 7b66 696c  tains(Key,\'{fil
+0002bb80: 655f 6e61 6d65 7d5c 2729 5d2e 4b65 7929  e_name}\')].Key)
+0002bb90: 2220 2d2d 656e 6470 6f69 6e74 207b 656e  " --endpoint {en
+0002bba0: 6470 6f69 6e74 5f75 726c 7d20 2d2d 7072  dpoint_url} --pr
+0002bbb0: 6f66 696c 653d 7232 270a 0a20 2020 2040  ofile=r2'..    @
+0002bbc0: 7374 6174 6963 6d65 7468 6f64 0a20 2020  staticmethod.   
+0002bbd0: 2064 6566 2063 6c69 5f63 6f75 6e74 5f66   def cli_count_f
+0002bbe0: 696c 655f 696e 5f62 7563 6b65 7428 7374  ile_in_bucket(st
+0002bbf0: 6f72 655f 7479 7065 2c20 6275 636b 6574  ore_type, bucket
+0002bc00: 5f6e 616d 6529 3a0a 2020 2020 2020 2020  _name):.        
+0002bc10: 6966 2073 746f 7265 5f74 7970 6520 3d3d  if store_type ==
+0002bc20: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+0002bc30: 7265 5479 7065 2e53 333a 0a20 2020 2020  reType.S3:.     
+0002bc40: 2020 2020 2020 2072 6574 7572 6e20 6627         return f'
+0002bc50: 6177 7320 7333 206c 7320 7333 3a2f 2f7b  aws s3 ls s3://{
+0002bc60: 6275 636b 6574 5f6e 616d 657d 202d 2d72  bucket_name} --r
+0002bc70: 6563 7572 7369 7665 207c 2077 6320 2d6c  ecursive | wc -l
+0002bc80: 270a 2020 2020 2020 2020 656c 6966 2073  '.        elif s
+0002bc90: 746f 7265 5f74 7970 6520 3d3d 2073 746f  tore_type == sto
+0002bca0: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+0002bcb0: 7065 2e47 4353 3a0a 2020 2020 2020 2020  pe.GCS:.        
+0002bcc0: 2020 2020 7265 7475 726e 2066 2767 7375      return f'gsu
+0002bcd0: 7469 6c20 6c73 202d 7220 6773 3a2f 2f7b  til ls -r gs://{
+0002bce0: 6275 636b 6574 5f6e 616d 657d 2f2a 2a20  bucket_name}/** 
+0002bcf0: 7c20 7763 202d 6c27 0a20 2020 2020 2020  | wc -l'.       
+0002bd00: 2065 6c69 6620 7374 6f72 655f 7479 7065   elif store_type
+0002bd10: 203d 3d20 7374 6f72 6167 655f 6c69 622e   == storage_lib.
+0002bd20: 5374 6f72 6554 7970 652e 5232 3a0a 2020  StoreType.R2:.  
+0002bd30: 2020 2020 2020 2020 2020 656e 6470 6f69            endpoi
+0002bd40: 6e74 5f75 726c 203d 2063 6c6f 7564 666c  nt_url = cloudfl
+0002bd50: 6172 652e 6372 6561 7465 5f65 6e64 706f  are.create_endpo
+0002bd60: 696e 7428 290a 2020 2020 2020 2020 2020  int().          
+0002bd70: 2020 7265 7475 726e 2066 2741 5753 5f53    return f'AWS_S
+0002bd80: 4841 5245 445f 4352 4544 454e 5449 414c  HARED_CREDENTIAL
+0002bd90: 535f 4649 4c45 3d7b 636c 6f75 6466 6c61  S_FILE={cloudfla
+0002bda0: 7265 2e52 325f 4352 4544 454e 5449 414c  re.R2_CREDENTIAL
+0002bdb0: 535f 5041 5448 7d20 6177 7320 7333 206c  S_PATH} aws s3 l
+0002bdc0: 7320 7333 3a2f 2f7b 6275 636b 6574 5f6e  s s3://{bucket_n
+0002bdd0: 616d 657d 202d 2d72 6563 7572 7369 7665  ame} --recursive
+0002bde0: 202d 2d65 6e64 706f 696e 7420 7b65 6e64   --endpoint {end
+0002bdf0: 706f 696e 745f 7572 6c7d 202d 2d70 726f  point_url} --pro
+0002be00: 6669 6c65 3d72 3220 7c20 7763 202d 6c27  file=r2 | wc -l'
+0002be10: 0a0a 2020 2020 4070 7974 6573 742e 6669  ..    @pytest.fi
+0002be20: 7874 7572 650a 2020 2020 6465 6620 746d  xture.    def tm
+0002be30: 705f 736f 7572 6365 2873 656c 662c 2074  p_source(self, t
+0002be40: 6d70 5f70 6174 6829 3a0a 2020 2020 2020  mp_path):.      
+0002be50: 2020 2320 4372 6561 7465 7320 6120 7465    # Creates a te
+0002be60: 6d70 6f72 6172 7920 6469 7265 6374 6f72  mporary director
+0002be70: 7920 7769 7468 2061 2066 696c 6520 696e  y with a file in
+0002be80: 2069 740a 2020 2020 2020 2020 746d 705f   it.        tmp_
+0002be90: 6469 7220 3d20 746d 705f 7061 7468 202f  dir = tmp_path /
+0002bea0: 2027 746d 702d 736f 7572 6365 270a 2020   'tmp-source'.  
+0002beb0: 2020 2020 2020 746d 705f 6469 722e 6d6b        tmp_dir.mk
+0002bec0: 6469 7228 290a 2020 2020 2020 2020 746d  dir().        tm
+0002bed0: 705f 6669 6c65 203d 2074 6d70 5f64 6972  p_file = tmp_dir
+0002bee0: 202f 2027 746d 702d 6669 6c65 270a 2020   / 'tmp-file'.  
+0002bef0: 2020 2020 2020 746d 705f 6669 6c65 2e77        tmp_file.w
+0002bf00: 7269 7465 5f74 6578 7428 2774 6573 7427  rite_text('test'
+0002bf10: 290a 2020 2020 2020 2020 6369 7263 6c65  ).        circle
+0002bf20: 5f6c 696e 6b20 3d20 746d 705f 6469 7220  _link = tmp_dir 
+0002bf30: 2f20 2763 6972 636c 652d 6c69 6e6b 270a  / 'circle-link'.
+0002bf40: 2020 2020 2020 2020 6369 7263 6c65 5f6c          circle_l
+0002bf50: 696e 6b2e 7379 6d6c 696e 6b5f 746f 2874  ink.symlink_to(t
+0002bf60: 6d70 5f64 6972 2c20 7461 7267 6574 5f69  mp_dir, target_i
+0002bf70: 735f 6469 7265 6374 6f72 793d 5472 7565  s_directory=True
+0002bf80: 290a 2020 2020 2020 2020 7969 656c 6420  ).        yield 
+0002bf90: 7374 7228 746d 705f 6469 7229 0a0a 2020  str(tmp_dir)..  
+0002bfa0: 2020 4073 7461 7469 636d 6574 686f 640a    @staticmethod.
+0002bfb0: 2020 2020 6465 6620 6765 6e65 7261 7465      def generate
+0002bfc0: 5f62 7563 6b65 745f 6e61 6d65 2829 3a0a  _bucket_name():.
+0002bfd0: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
+0002bfe0: 7320 6120 7465 6d70 6f72 6172 7920 6275  s a temporary bu
+0002bff0: 636b 6574 206e 616d 650a 2020 2020 2020  cket name.      
+0002c000: 2020 2320 7469 6d65 2e74 696d 6528 2920    # time.time() 
+0002c010: 7265 7475 726e 7320 7661 7279 696e 6720  returns varying 
+0002c020: 7072 6563 6973 696f 6e20 6f6e 2064 6966  precision on dif
+0002c030: 6665 7265 6e74 2073 7973 7465 6d73 2c20  ferent systems, 
+0002c040: 736f 2077 650a 2020 2020 2020 2020 2320  so we.        # 
+0002c050: 7265 706c 6163 6520 7468 6520 6465 6369  replace the deci
+0002c060: 6d61 6c20 706f 696e 7420 616e 6420 7573  mal point and us
+0002c070: 6520 7768 6174 6576 6572 2070 7265 6369  e whatever preci
+0002c080: 7369 6f6e 2077 6520 6361 6e20 6765 742e  sion we can get.
+0002c090: 0a20 2020 2020 2020 2074 696d 6573 7461  .        timesta
+0002c0a0: 6d70 203d 2073 7472 2874 696d 652e 7469  mp = str(time.ti
+0002c0b0: 6d65 2829 292e 7265 706c 6163 6528 272e  me()).replace('.
+0002c0c0: 272c 2027 2729 0a20 2020 2020 2020 2072  ', '').        r
+0002c0d0: 6574 7572 6e20 6627 736b 792d 7465 7374  eturn f'sky-test
+0002c0e0: 2d7b 7469 6d65 7374 616d 707d 270a 0a20  -{timestamp}'.. 
+0002c0f0: 2020 2040 7079 7465 7374 2e66 6978 7475     @pytest.fixtu
+0002c100: 7265 0a20 2020 2064 6566 2074 6d70 5f62  re.    def tmp_b
+0002c110: 7563 6b65 745f 6e61 6d65 2873 656c 6629  ucket_name(self)
+0002c120: 3a0a 2020 2020 2020 2020 7969 656c 6420  :.        yield 
+0002c130: 7365 6c66 2e67 656e 6572 6174 655f 6275  self.generate_bu
+0002c140: 636b 6574 5f6e 616d 6528 290a 0a20 2020  cket_name()..   
+0002c150: 2040 7374 6174 6963 6d65 7468 6f64 0a20   @staticmethod. 
+0002c160: 2020 2064 6566 2079 6965 6c64 5f73 746f     def yield_sto
+0002c170: 7261 6765 5f6f 626a 6563 7428 0a20 2020  rage_object(.   
+0002c180: 2020 2020 2020 2020 206e 616d 653a 204f           name: O
+0002c190: 7074 696f 6e61 6c5b 7374 725d 203d 204e  ptional[str] = N
+0002c1a0: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+0002c1b0: 2073 6f75 7263 653a 204f 7074 696f 6e61   source: Optiona
+0002c1c0: 6c5b 7374 6f72 6167 655f 6c69 622e 5061  l[storage_lib.Pa
+0002c1d0: 7468 5d20 3d20 4e6f 6e65 2c0a 2020 2020  th] = None,.    
+0002c1e0: 2020 2020 2020 2020 7374 6f72 6573 3a20          stores: 
+0002c1f0: 4f70 7469 6f6e 616c 5b44 6963 745b 7374  Optional[Dict[st
+0002c200: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+0002c210: 7970 652c 0a20 2020 2020 2020 2020 2020  ype,.           
+0002c220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c230: 2020 2020 2020 2073 746f 7261 6765 5f6c         storage_l
+0002c240: 6962 2e41 6273 7472 6163 7453 746f 7265  ib.AbstractStore
+0002c250: 5d5d 203d 204e 6f6e 652c 0a20 2020 2020  ]] = None,.     
+0002c260: 2020 2020 2020 2070 6572 7369 7374 656e         persisten
+0002c270: 743a 204f 7074 696f 6e61 6c5b 626f 6f6c  t: Optional[bool
+0002c280: 5d20 3d20 5472 7565 2c0a 2020 2020 2020  ] = True,.      
+0002c290: 2020 2020 2020 6d6f 6465 3a20 7374 6f72        mode: stor
+0002c2a0: 6167 655f 6c69 622e 5374 6f72 6167 654d  age_lib.StorageM
+0002c2b0: 6f64 6520 3d20 7374 6f72 6167 655f 6c69  ode = storage_li
+0002c2c0: 622e 5374 6f72 6167 654d 6f64 652e 4d4f  b.StorageMode.MO
+0002c2d0: 554e 5429 3a0a 2020 2020 2020 2020 2320  UNT):.        # 
+0002c2e0: 4372 6561 7465 7320 6120 7465 6d70 6f72  Creates a tempor
+0002c2f0: 6172 7920 7374 6f72 6167 6520 6f62 6a65  ary storage obje
+0002c300: 6374 2e20 5374 6f72 6573 206d 7573 7420  ct. Stores must 
+0002c310: 6265 2061 6464 6564 2069 6e20 7468 6520  be added in the 
+0002c320: 7465 7374 2e0a 2020 2020 2020 2020 7374  test..        st
+0002c330: 6f72 6167 655f 6f62 6a20 3d20 7374 6f72  orage_obj = stor
+0002c340: 6167 655f 6c69 622e 5374 6f72 6167 6528  age_lib.Storage(
+0002c350: 6e61 6d65 3d6e 616d 652c 0a20 2020 2020  name=name,.     
+0002c360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c380: 2020 2020 2073 6f75 7263 653d 736f 7572       source=sour
+0002c390: 6365 2c0a 2020 2020 2020 2020 2020 2020  ce,.            
+0002c3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c3b0: 2020 2020 2020 2020 2020 2020 2020 7374                st
+0002c3c0: 6f72 6573 3d73 746f 7265 732c 0a20 2020  ores=stores,.   
+0002c3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c3f0: 2020 2020 2020 2070 6572 7369 7374 656e         persisten
+0002c400: 743d 7065 7273 6973 7465 6e74 2c0a 2020  t=persistent,.  
+0002c410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c430: 2020 2020 2020 2020 6d6f 6465 3d6d 6f64          mode=mod
+0002c440: 6529 0a20 2020 2020 2020 2079 6965 6c64  e).        yield
+0002c450: 2073 746f 7261 6765 5f6f 626a 0a20 2020   storage_obj.   
+0002c460: 2020 2020 2068 616e 646c 6520 3d20 676c       handle = gl
+0002c470: 6f62 616c 5f75 7365 725f 7374 6174 652e  obal_user_state.
+0002c480: 6765 745f 6861 6e64 6c65 5f66 726f 6d5f  get_handle_from_
+0002c490: 7374 6f72 6167 655f 6e61 6d65 280a 2020  storage_name(.  
+0002c4a0: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
+0002c4b0: 655f 6f62 6a2e 6e61 6d65 290a 2020 2020  e_obj.name).    
+0002c4c0: 2020 2020 6966 2068 616e 646c 653a 0a20      if handle:. 
+0002c4d0: 2020 2020 2020 2020 2020 2023 2049 6620             # If 
+0002c4e0: 6861 6e64 6c65 2065 7869 7374 732c 2064  handle exists, d
+0002c4f0: 656c 6574 6520 6d61 6e75 616c 6c79 0a20  elete manually. 
+0002c500: 2020 2020 2020 2020 2020 2023 2054 4f44             # TOD
+0002c510: 4f28 726f 6d69 6c62 293a 2054 6869 7320  O(romilb): This 
+0002c520: 6973 2070 6f74 656e 7469 616c 6c79 2072  is potentially r
+0002c530: 6973 6b79 202d 2069 6620 7468 6520 6465  isky - if the de
+0002c540: 6c65 7465 206d 6574 686f 6420 6861 730a  lete method has.
+0002c550: 2020 2020 2020 2020 2020 2020 2320 2020              #   
+0002c560: 6275 6773 2c20 7468 6973 2063 616e 2063  bugs, this can c
+0002c570: 6175 7365 2072 6573 6f75 7263 6520 6c65  ause resource le
+0002c580: 616b 732e 2049 6465 616c 6c79 2077 6520  aks. Ideally we 
+0002c590: 7368 6f75 6c64 206d 616e 7561 6c6c 790a  should manually.
+0002c5a0: 2020 2020 2020 2020 2020 2020 2320 2020              #   
+0002c5b0: 656a 6563 7420 7374 6f72 6167 6520 6672  eject storage fr
+0002c5c0: 6f6d 2067 6c6f 6261 6c5f 7573 6572 5f73  om global_user_s
+0002c5d0: 7461 7465 2061 6e64 2064 656c 6574 6520  tate and delete 
+0002c5e0: 7468 6520 6275 636b 6574 2075 7369 6e67  the bucket using
+0002c5f0: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
+0002c600: 2062 6f74 6f33 2064 6972 6563 746c 792e   boto3 directly.
+0002c610: 0a20 2020 2020 2020 2020 2020 2073 746f  .            sto
+0002c620: 7261 6765 5f6f 626a 2e64 656c 6574 6528  rage_obj.delete(
+0002c630: 290a 0a20 2020 2040 7079 7465 7374 2e66  )..    @pytest.f
+0002c640: 6978 7475 7265 0a20 2020 2064 6566 2074  ixture.    def t
+0002c650: 6d70 5f73 6372 6174 6368 5f73 746f 7261  mp_scratch_stora
+0002c660: 6765 5f6f 626a 2873 656c 662c 2074 6d70  ge_obj(self, tmp
+0002c670: 5f62 7563 6b65 745f 6e61 6d65 293a 0a20  _bucket_name):. 
+0002c680: 2020 2020 2020 2023 2043 7265 6174 6573         # Creates
+0002c690: 2061 2073 746f 7261 6765 206f 626a 6563   a storage objec
+0002c6a0: 7420 7769 7468 206e 6f20 736f 7572 6365  t with no source
+0002c6b0: 2074 6f20 6372 6561 7465 2061 2073 6372   to create a scr
+0002c6c0: 6174 6368 2073 746f 7261 6765 2e0a 2020  atch storage..  
+0002c6d0: 2020 2020 2020 2320 5374 6f72 6573 206d        # Stores m
+0002c6e0: 7573 7420 6265 2061 6464 6564 2069 6e20  ust be added in 
+0002c6f0: 7468 6520 7465 7374 2e0a 2020 2020 2020  the test..      
+0002c700: 2020 7969 656c 6420 6672 6f6d 2073 656c    yield from sel
+0002c710: 662e 7969 656c 645f 7374 6f72 6167 655f  f.yield_storage_
+0002c720: 6f62 6a65 6374 286e 616d 653d 746d 705f  object(name=tmp_
+0002c730: 6275 636b 6574 5f6e 616d 6529 0a0a 2020  bucket_name)..  
+0002c740: 2020 4070 7974 6573 742e 6669 7874 7572    @pytest.fixtur
+0002c750: 650a 2020 2020 6465 6620 746d 705f 6d75  e.    def tmp_mu
+0002c760: 6c74 6970 6c65 5f73 6372 6174 6368 5f73  ltiple_scratch_s
+0002c770: 746f 7261 6765 5f6f 626a 2873 656c 6629  torage_obj(self)
+0002c780: 3a0a 2020 2020 2020 2020 2320 4372 6561  :.        # Crea
+0002c790: 7465 7320 6120 6c69 7374 206f 6620 3520  tes a list of 5 
+0002c7a0: 7374 6f72 6167 6520 6f62 6a65 6374 7320  storage objects 
+0002c7b0: 7769 7468 206e 6f20 736f 7572 6365 2074  with no source t
+0002c7c0: 6f20 6372 6561 7465 0a20 2020 2020 2020  o create.       
+0002c7d0: 2023 206d 756c 7469 706c 6520 7363 7261   # multiple scra
+0002c7e0: 7463 6820 7374 6f72 6167 6573 2e0a 2020  tch storages..  
+0002c7f0: 2020 2020 2020 2320 5374 6f72 6573 2066        # Stores f
+0002c800: 6f72 2065 6163 6820 6f62 6a65 6374 2069  or each object i
+0002c810: 6e20 7468 6520 6c69 7374 206d 7573 7420  n the list must 
+0002c820: 6265 2061 6464 6564 2069 6e20 7468 6520  be added in the 
+0002c830: 7465 7374 2e0a 2020 2020 2020 2020 7374  test..        st
+0002c840: 6f72 6167 655f 6d75 6c74 5f6f 626a 203d  orage_mult_obj =
+0002c850: 205b 5d0a 2020 2020 2020 2020 666f 7220   [].        for 
+0002c860: 5f20 696e 2072 616e 6765 2835 293a 0a20  _ in range(5):. 
+0002c870: 2020 2020 2020 2020 2020 2074 696d 6573             times
+0002c880: 7461 6d70 203d 2073 7472 2874 696d 652e  tamp = str(time.
+0002c890: 7469 6d65 2829 292e 7265 706c 6163 6528  time()).replace(
+0002c8a0: 272e 272c 2027 2729 0a20 2020 2020 2020  '.', '').       
+0002c8b0: 2020 2020 2073 746f 7265 5f6f 626a 203d       store_obj =
+0002c8c0: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+0002c8d0: 7261 6765 286e 616d 653d 6627 736b 792d  rage(name=f'sky-
+0002c8e0: 7465 7374 2d7b 7469 6d65 7374 616d 707d  test-{timestamp}
+0002c8f0: 2729 0a20 2020 2020 2020 2020 2020 2073  ').            s
+0002c900: 746f 7261 6765 5f6d 756c 745f 6f62 6a2e  torage_mult_obj.
+0002c910: 6170 7065 6e64 2873 746f 7265 5f6f 626a  append(store_obj
+0002c920: 290a 2020 2020 2020 2020 7969 656c 6420  ).        yield 
+0002c930: 7374 6f72 6167 655f 6d75 6c74 5f6f 626a  storage_mult_obj
+0002c940: 0a20 2020 2020 2020 2066 6f72 2073 746f  .        for sto
+0002c950: 7261 6765 5f6f 626a 2069 6e20 7374 6f72  rage_obj in stor
+0002c960: 6167 655f 6d75 6c74 5f6f 626a 3a0a 2020  age_mult_obj:.  
+0002c970: 2020 2020 2020 2020 2020 6861 6e64 6c65            handle
+0002c980: 203d 2067 6c6f 6261 6c5f 7573 6572 5f73   = global_user_s
+0002c990: 7461 7465 2e67 6574 5f68 616e 646c 655f  tate.get_handle_
+0002c9a0: 6672 6f6d 5f73 746f 7261 6765 5f6e 616d  from_storage_nam
+0002c9b0: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
+0002c9c0: 2020 2073 746f 7261 6765 5f6f 626a 2e6e     storage_obj.n
+0002c9d0: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
+0002c9e0: 2069 6620 6861 6e64 6c65 3a0a 2020 2020   if handle:.    
+0002c9f0: 2020 2020 2020 2020 2020 2020 2320 4966              # If
+0002ca00: 2068 616e 646c 6520 6578 6973 7473 2c20   handle exists, 
+0002ca10: 6465 6c65 7465 206d 616e 7561 6c6c 790a  delete manually.
+0002ca20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ca30: 2320 544f 444f 2872 6f6d 696c 6229 3a20  # TODO(romilb): 
+0002ca40: 5468 6973 2069 7320 706f 7465 6e74 6961  This is potentia
+0002ca50: 6c6c 7920 7269 736b 7920 2d20 6966 2074  lly risky - if t
+0002ca60: 6865 2064 656c 6574 6520 6d65 7468 6f64  he delete method
+0002ca70: 2068 6173 0a20 2020 2020 2020 2020 2020   has.           
+0002ca80: 2020 2020 2023 2062 7567 732c 2074 6869       # bugs, thi
+0002ca90: 7320 6361 6e20 6361 7573 6520 7265 736f  s can cause reso
+0002caa0: 7572 6365 206c 6561 6b73 2e20 4964 6561  urce leaks. Idea
+0002cab0: 6c6c 7920 7765 2073 686f 756c 6420 6d61  lly we should ma
+0002cac0: 6e75 616c 6c79 0a20 2020 2020 2020 2020  nually.         
+0002cad0: 2020 2020 2020 2023 2065 6a65 6374 2073         # eject s
+0002cae0: 746f 7261 6765 2066 726f 6d20 676c 6f62  torage from glob
+0002caf0: 616c 5f75 7365 725f 7374 6174 6520 616e  al_user_state an
+0002cb00: 6420 6465 6c65 7465 2074 6865 2062 7563  d delete the buc
+0002cb10: 6b65 7420 7573 696e 670a 2020 2020 2020  ket using.      
+0002cb20: 2020 2020 2020 2020 2020 2320 626f 746f            # boto
+0002cb30: 3320 6469 7265 6374 6c79 2e0a 2020 2020  3 directly..    
+0002cb40: 2020 2020 2020 2020 2020 2020 7374 6f72              stor
+0002cb50: 6167 655f 6f62 6a2e 6465 6c65 7465 2829  age_obj.delete()
+0002cb60: 0a0a 2020 2020 4070 7974 6573 742e 6669  ..    @pytest.fi
+0002cb70: 7874 7572 650a 2020 2020 6465 6620 746d  xture.    def tm
+0002cb80: 705f 6d75 6c74 6970 6c65 5f63 7573 746f  p_multiple_custo
+0002cb90: 6d5f 736f 7572 6365 5f73 746f 7261 6765  m_source_storage
+0002cba0: 5f6f 626a 2873 656c 6629 3a0a 2020 2020  _obj(self):.    
+0002cbb0: 2020 2020 2320 4372 6561 7465 7320 6120      # Creates a 
+0002cbc0: 6c69 7374 206f 6620 7374 6f72 6167 6520  list of storage 
+0002cbd0: 6f62 6a65 6374 7320 7769 7468 2063 7573  objects with cus
+0002cbe0: 746f 6d20 736f 7572 6365 206e 616d 6573  tom source names
+0002cbf0: 2074 6f0a 2020 2020 2020 2020 2320 6372   to.        # cr
+0002cc00: 6561 7465 206d 756c 7469 706c 6520 7363  eate multiple sc
+0002cc10: 7261 7463 6820 7374 6f72 6167 6573 2e0a  ratch storages..
+0002cc20: 2020 2020 2020 2020 2320 5374 6f72 6573          # Stores
+0002cc30: 2066 6f72 2065 6163 6820 6f62 6a65 6374   for each object
+0002cc40: 2069 6e20 7468 6520 6c69 7374 206d 7573   in the list mus
+0002cc50: 7420 6265 2061 6464 6564 2069 6e20 7468  t be added in th
+0002cc60: 6520 7465 7374 2e0a 2020 2020 2020 2020  e test..        
+0002cc70: 6375 7374 6f6d 5f73 6f75 7263 655f 6e61  custom_source_na
+0002cc80: 6d65 7320 3d20 5b27 2270 6174 6820 5769  mes = ['"path Wi
+0002cc90: 7468 2053 7061 6365 7322 272c 2027 7061  th Spaces"', 'pa
+0002cca0: 7468 2057 6974 6820 5370 6163 6573 275d  th With Spaces']
+0002ccb0: 0a20 2020 2020 2020 2073 746f 7261 6765  .        storage
+0002ccc0: 5f6d 756c 745f 6f62 6a20 3d20 5b5d 0a20  _mult_obj = []. 
+0002ccd0: 2020 2020 2020 2066 6f72 206e 616d 6520         for name 
+0002cce0: 696e 2063 7573 746f 6d5f 736f 7572 6365  in custom_source
+0002ccf0: 5f6e 616d 6573 3a0a 2020 2020 2020 2020  _names:.        
+0002cd00: 2020 2020 7372 635f 7061 7468 203d 206f      src_path = o
+0002cd10: 732e 7061 7468 2e65 7870 616e 6475 7365  s.path.expanduse
+0002cd20: 7228 6627 7e2f 7b6e 616d 657d 2729 0a20  r(f'~/{name}'). 
+0002cd30: 2020 2020 2020 2020 2020 2070 6174 686c             pathl
+0002cd40: 6962 2e50 6174 6828 7372 635f 7061 7468  ib.Path(src_path
+0002cd50: 292e 6578 7061 6e64 7573 6572 2829 2e6d  ).expanduser().m
+0002cd60: 6b64 6972 2865 7869 7374 5f6f 6b3d 5472  kdir(exist_ok=Tr
+0002cd70: 7565 290a 2020 2020 2020 2020 2020 2020  ue).            
+0002cd80: 7469 6d65 7374 616d 7020 3d20 7374 7228  timestamp = str(
+0002cd90: 7469 6d65 2e74 696d 6528 2929 2e72 6570  time.time()).rep
+0002cda0: 6c61 6365 2827 2e27 2c20 2727 290a 2020  lace('.', '').  
+0002cdb0: 2020 2020 2020 2020 2020 7374 6f72 655f            store_
+0002cdc0: 6f62 6a20 3d20 7374 6f72 6167 655f 6c69  obj = storage_li
+0002cdd0: 622e 5374 6f72 6167 6528 6e61 6d65 3d66  b.Storage(name=f
+0002cde0: 2773 6b79 2d74 6573 742d 7b74 696d 6573  'sky-test-{times
+0002cdf0: 7461 6d70 7d27 2c0a 2020 2020 2020 2020  tamp}',.        
+0002ce00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ce10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ce20: 2020 2020 736f 7572 6365 3d73 7263 5f70      source=src_p
+0002ce30: 6174 6829 0a20 2020 2020 2020 2020 2020  ath).           
+0002ce40: 2073 746f 7261 6765 5f6d 756c 745f 6f62   storage_mult_ob
+0002ce50: 6a2e 6170 7065 6e64 2873 746f 7265 5f6f  j.append(store_o
+0002ce60: 626a 290a 2020 2020 2020 2020 7969 656c  bj).        yiel
+0002ce70: 6420 7374 6f72 6167 655f 6d75 6c74 5f6f  d storage_mult_o
+0002ce80: 626a 0a20 2020 2020 2020 2066 6f72 2073  bj.        for s
+0002ce90: 746f 7261 6765 5f6f 626a 2069 6e20 7374  torage_obj in st
+0002cea0: 6f72 6167 655f 6d75 6c74 5f6f 626a 3a0a  orage_mult_obj:.
+0002ceb0: 2020 2020 2020 2020 2020 2020 6861 6e64              hand
+0002cec0: 6c65 203d 2067 6c6f 6261 6c5f 7573 6572  le = global_user
+0002ced0: 5f73 7461 7465 2e67 6574 5f68 616e 646c  _state.get_handl
+0002cee0: 655f 6672 6f6d 5f73 746f 7261 6765 5f6e  e_from_storage_n
+0002cef0: 616d 6528 0a20 2020 2020 2020 2020 2020  ame(.           
+0002cf00: 2020 2020 2073 746f 7261 6765 5f6f 626a       storage_obj
+0002cf10: 2e6e 616d 6529 0a20 2020 2020 2020 2020  .name).         
+0002cf20: 2020 2069 6620 6861 6e64 6c65 3a0a 2020     if handle:.  
+0002cf30: 2020 2020 2020 2020 2020 2020 2020 7374                st
+0002cf40: 6f72 6167 655f 6f62 6a2e 6465 6c65 7465  orage_obj.delete
+0002cf50: 2829 0a0a 2020 2020 4070 7974 6573 742e  ()..    @pytest.
+0002cf60: 6669 7874 7572 650a 2020 2020 6465 6620  fixture.    def 
+0002cf70: 746d 705f 6c6f 6361 6c5f 7374 6f72 6167  tmp_local_storag
+0002cf80: 655f 6f62 6a28 7365 6c66 2c20 746d 705f  e_obj(self, tmp_
+0002cf90: 6275 636b 6574 5f6e 616d 652c 2074 6d70  bucket_name, tmp
+0002cfa0: 5f73 6f75 7263 6529 3a0a 2020 2020 2020  _source):.      
+0002cfb0: 2020 2320 4372 6561 7465 7320 6120 7465    # Creates a te
+0002cfc0: 6d70 6f72 6172 7920 7374 6f72 6167 6520  mporary storage 
+0002cfd0: 6f62 6a65 6374 2e20 5374 6f72 6573 206d  object. Stores m
+0002cfe0: 7573 7420 6265 2061 6464 6564 2069 6e20  ust be added in 
+0002cff0: 7468 6520 7465 7374 2e0a 2020 2020 2020  the test..      
+0002d000: 2020 7969 656c 6420 6672 6f6d 2073 656c    yield from sel
+0002d010: 662e 7969 656c 645f 7374 6f72 6167 655f  f.yield_storage_
+0002d020: 6f62 6a65 6374 286e 616d 653d 746d 705f  object(name=tmp_
+0002d030: 6275 636b 6574 5f6e 616d 652c 0a20 2020  bucket_name,.   
+0002d040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d060: 2020 2020 2020 2020 2020 736f 7572 6365            source
+0002d070: 3d74 6d70 5f73 6f75 7263 6529 0a0a 2020  =tmp_source)..  
+0002d080: 2020 4070 7974 6573 742e 6669 7874 7572    @pytest.fixtur
+0002d090: 650a 2020 2020 6465 6620 746d 705f 6c6f  e.    def tmp_lo
+0002d0a0: 6361 6c5f 6c69 7374 5f73 746f 7261 6765  cal_list_storage
+0002d0b0: 5f6f 626a 2873 656c 662c 2074 6d70 5f62  _obj(self, tmp_b
+0002d0c0: 7563 6b65 745f 6e61 6d65 2c20 746d 705f  ucket_name, tmp_
+0002d0d0: 736f 7572 6365 293a 0a20 2020 2020 2020  source):.       
+0002d0e0: 2023 2043 7265 6174 6573 2061 2074 656d   # Creates a tem
+0002d0f0: 7020 7374 6f72 6167 6520 6f62 6a65 6374  p storage object
+0002d100: 2077 6869 6368 2075 7365 7320 6120 6c69   which uses a li
+0002d110: 7374 206f 6620 7061 7468 7320 6173 2073  st of paths as s
+0002d120: 6f75 7263 652e 0a20 2020 2020 2020 2023  ource..        #
+0002d130: 2053 746f 7265 7320 6d75 7374 2062 6520   Stores must be 
+0002d140: 6164 6465 6420 696e 2074 6865 2074 6573  added in the tes
+0002d150: 742e 2041 6674 6572 2075 706c 6f61 642c  t. After upload,
+0002d160: 2074 6865 2062 7563 6b65 7420 7368 6f75   the bucket shou
+0002d170: 6c64 0a20 2020 2020 2020 2023 2068 6176  ld.        # hav
+0002d180: 6520 7477 6f20 6669 6c65 7320 2d20 2f74  e two files - /t
+0002d190: 6d70 2d66 696c 6520 616e 6420 2f74 6d70  mp-file and /tmp
+0002d1a0: 2d73 6f75 7263 652f 746d 702d 6669 6c65  -source/tmp-file
+0002d1b0: 0a20 2020 2020 2020 206c 6973 745f 736f  .        list_so
+0002d1c0: 7572 6365 203d 205b 746d 705f 736f 7572  urce = [tmp_sour
+0002d1d0: 6365 2c20 746d 705f 736f 7572 6365 202b  ce, tmp_source +
+0002d1e0: 2027 2f74 6d70 2d66 696c 6527 5d0a 2020   '/tmp-file'].  
+0002d1f0: 2020 2020 2020 7969 656c 6420 6672 6f6d        yield from
+0002d200: 2073 656c 662e 7969 656c 645f 7374 6f72   self.yield_stor
+0002d210: 6167 655f 6f62 6a65 6374 286e 616d 653d  age_object(name=
+0002d220: 746d 705f 6275 636b 6574 5f6e 616d 652c  tmp_bucket_name,
+0002d230: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002d240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d250: 2020 2020 2020 2020 2020 2020 2020 736f                so
+0002d260: 7572 6365 3d6c 6973 745f 736f 7572 6365  urce=list_source
+0002d270: 290a 0a20 2020 2040 7079 7465 7374 2e66  )..    @pytest.f
+0002d280: 6978 7475 7265 0a20 2020 2064 6566 2074  ixture.    def t
+0002d290: 6d70 5f62 756c 6b5f 6465 6c5f 7374 6f72  mp_bulk_del_stor
+0002d2a0: 6167 655f 6f62 6a28 7365 6c66 2c20 746d  age_obj(self, tm
+0002d2b0: 705f 6275 636b 6574 5f6e 616d 6529 3a0a  p_bucket_name):.
+0002d2c0: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
+0002d2d0: 7320 6120 7465 6d70 6f72 6172 7920 7374  s a temporary st
+0002d2e0: 6f72 6167 6520 6f62 6a65 6374 2066 6f72  orage object for
+0002d2f0: 2074 6573 7469 6e67 2062 756c 6b20 6465   testing bulk de
+0002d300: 6c65 7469 6f6e 2e0a 2020 2020 2020 2020  letion..        
+0002d310: 2320 5374 6f72 6573 206d 7573 7420 6265  # Stores must be
+0002d320: 2061 6464 6564 2069 6e20 7468 6520 7465   added in the te
+0002d330: 7374 2e0a 2020 2020 2020 2020 7769 7468  st..        with
+0002d340: 2074 656d 7066 696c 652e 5465 6d70 6f72   tempfile.Tempor
+0002d350: 6172 7944 6972 6563 746f 7279 2829 2061  aryDirectory() a
+0002d360: 7320 746d 7064 6972 3a0a 2020 2020 2020  s tmpdir:.      
+0002d370: 2020 2020 2020 7375 6270 726f 6365 7373        subprocess
+0002d380: 2e63 6865 636b 5f6f 7574 7075 7428 6627  .check_output(f'
+0002d390: 6d6b 6469 7220 2d70 207b 746d 7064 6972  mkdir -p {tmpdir
+0002d3a0: 7d2f 666f 6c64 6572 7b7b 3030 302e 2e32  }/folder{{000..2
+0002d3b0: 3535 7d7d 272c 0a20 2020 2020 2020 2020  55}}',.         
+0002d3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d3d0: 2020 2020 2020 2020 2020 2073 6865 6c6c             shell
+0002d3e0: 3d54 7275 6529 0a20 2020 2020 2020 2020  =True).         
+0002d3f0: 2020 2073 7562 7072 6f63 6573 732e 6368     subprocess.ch
+0002d400: 6563 6b5f 6f75 7470 7574 2866 2774 6f75  eck_output(f'tou
+0002d410: 6368 207b 746d 7064 6972 7d2f 7465 7374  ch {tmpdir}/test
+0002d420: 7b7b 3030 302e 2e32 3535 7d7d 2e74 7874  {{000..255}}.txt
+0002d430: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+0002d440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d450: 2020 2020 2020 2073 6865 6c6c 3d54 7275         shell=Tru
+0002d460: 6529 0a20 2020 2020 2020 2020 2020 2073  e).            s
+0002d470: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
+0002d480: 6f75 7470 7574 280a 2020 2020 2020 2020  output(.        
+0002d490: 2020 2020 2020 2020 6627 746f 7563 6820          f'touch 
+0002d4a0: 7b74 6d70 6469 727d 2f66 6f6c 6465 727b  {tmpdir}/folder{
+0002d4b0: 7b30 3030 2e2e 3235 357d 7d2f 7465 7374  {000..255}}/test
+0002d4c0: 2e74 7874 272c 2073 6865 6c6c 3d54 7275  .txt', shell=Tru
+0002d4d0: 6529 0a20 2020 2020 2020 2020 2020 2079  e).            y
+0002d4e0: 6965 6c64 2066 726f 6d20 7365 6c66 2e79  ield from self.y
+0002d4f0: 6965 6c64 5f73 746f 7261 6765 5f6f 626a  ield_storage_obj
+0002d500: 6563 7428 6e61 6d65 3d74 6d70 5f62 7563  ect(name=tmp_buc
+0002d510: 6b65 745f 6e61 6d65 2c0a 2020 2020 2020  ket_name,.      
+0002d520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d540: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
+0002d550: 653d 746d 7064 6972 290a 0a20 2020 2040  e=tmpdir)..    @
+0002d560: 7079 7465 7374 2e66 6978 7475 7265 0a20  pytest.fixture. 
+0002d570: 2020 2064 6566 2074 6d70 5f63 6f70 795f     def tmp_copy_
+0002d580: 6d6e 745f 6578 6973 7469 6e67 5f73 746f  mnt_existing_sto
+0002d590: 7261 6765 5f6f 626a 2873 656c 662c 2074  rage_obj(self, t
+0002d5a0: 6d70 5f73 6372 6174 6368 5f73 746f 7261  mp_scratch_stora
+0002d5b0: 6765 5f6f 626a 293a 0a20 2020 2020 2020  ge_obj):.       
+0002d5c0: 2023 2043 7265 6174 6573 2061 2063 6f70   # Creates a cop
+0002d5d0: 7920 6d6f 756e 7420 7374 6f72 6167 6520  y mount storage 
+0002d5e0: 7768 6963 6820 7265 7573 6573 2061 6e20  which reuses an 
+0002d5f0: 6578 6973 7469 6e67 2073 746f 7261 6765  existing storage
+0002d600: 206f 626a 6563 742e 0a20 2020 2020 2020   object..       
+0002d610: 2074 6d70 5f73 6372 6174 6368 5f73 746f   tmp_scratch_sto
+0002d620: 7261 6765 5f6f 626a 2e61 6464 5f73 746f  rage_obj.add_sto
+0002d630: 7265 2873 746f 7261 6765 5f6c 6962 2e53  re(storage_lib.S
+0002d640: 746f 7265 5479 7065 2e53 3329 0a20 2020  toreType.S3).   
+0002d650: 2020 2020 2073 746f 7261 6765 5f6e 616d       storage_nam
+0002d660: 6520 3d20 746d 705f 7363 7261 7463 685f  e = tmp_scratch_
+0002d670: 7374 6f72 6167 655f 6f62 6a2e 6e61 6d65  storage_obj.name
+0002d680: 0a0a 2020 2020 2020 2020 2320 5472 7920  ..        # Try 
+0002d690: 746f 2069 6e69 7469 616c 697a 6520 616e  to initialize an
+0002d6a0: 6f74 6865 7220 7374 6f72 6167 6520 7769  other storage wi
+0002d6b0: 7468 2074 6865 2073 746f 7261 6765 206f  th the storage o
+0002d6c0: 626a 6563 7420 6372 6561 7465 640a 2020  bject created.  
+0002d6d0: 2020 2020 2020 2320 6162 6f76 652c 2062        # above, b
+0002d6e0: 7574 206e 6f77 2069 6e20 434f 5059 206d  ut now in COPY m
+0002d6f0: 6f64 652e 2054 6869 7320 7368 6f75 6c64  ode. This should
+0002d700: 2073 7563 6365 6564 2e0a 2020 2020 2020   succeed..      
+0002d710: 2020 7969 656c 6420 6672 6f6d 2073 656c    yield from sel
+0002d720: 662e 7969 656c 645f 7374 6f72 6167 655f  f.yield_storage_
+0002d730: 6f62 6a65 6374 286e 616d 653d 7374 6f72  object(name=stor
+0002d740: 6167 655f 6e61 6d65 2c0a 2020 2020 2020  age_name,.      
+0002d750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d770: 2020 2020 2020 206d 6f64 653d 7374 6f72         mode=stor
+0002d780: 6167 655f 6c69 622e 5374 6f72 6167 654d  age_lib.StorageM
+0002d790: 6f64 652e 434f 5059 290a 0a20 2020 2040  ode.COPY)..    @
+0002d7a0: 7079 7465 7374 2e66 6978 7475 7265 0a20  pytest.fixture. 
+0002d7b0: 2020 2064 6566 2074 6d70 5f67 6974 6967     def tmp_gitig
+0002d7c0: 6e6f 7265 5f73 746f 7261 6765 5f6f 626a  nore_storage_obj
+0002d7d0: 2873 656c 662c 2074 6d70 5f62 7563 6b65  (self, tmp_bucke
+0002d7e0: 745f 6e61 6d65 2c20 6769 7469 676e 6f72  t_name, gitignor
+0002d7f0: 655f 7374 7275 6374 7572 6529 3a0a 2020  e_structure):.  
+0002d800: 2020 2020 2020 2320 4372 6561 7465 7320        # Creates 
+0002d810: 6120 7465 6d70 6f72 6172 7920 7374 6f72  a temporary stor
+0002d820: 6167 6520 6f62 6a65 6374 2066 6f72 2074  age object for t
+0002d830: 6573 7469 6e67 202e 6769 7469 676e 6f72  esting .gitignor
+0002d840: 6520 6669 6c74 6572 2e0a 2020 2020 2020  e filter..      
+0002d850: 2020 2320 4749 5449 4749 4e4f 5245 5f53    # GITIGINORE_S
+0002d860: 5452 5543 5455 5245 2069 7320 7265 7072  TRUCTURE is repr
+0002d870: 6573 656e 7469 6e67 2061 2066 696c 6520  esenting a file 
+0002d880: 7374 7275 6374 7572 6520 696e 2061 2064  structure in a d
+0002d890: 6963 7469 6f6e 6172 790a 2020 2020 2020  ictionary.      
+0002d8a0: 2020 2320 666f 726d 6174 2e20 4372 6561    # format. Crea
+0002d8b0: 7465 6420 7374 6f72 6167 6520 6f62 6a65  ted storage obje
+0002d8c0: 6374 2077 696c 6c20 636f 6e74 6169 6e20  ct will contain 
+0002d8d0: 7468 6520 6669 6c65 2073 7472 7563 7475  the file structu
+0002d8e0: 7265 2061 6c6f 6e67 0a20 2020 2020 2020  re along.       
+0002d8f0: 2023 2077 6974 6820 2e67 6974 6967 6e6f   # with .gitigno
+0002d900: 7265 2061 6e64 202e 6769 742f 696e 666f  re and .git/info
+0002d910: 2f65 7863 6c75 6465 2066 696c 6573 2074  /exclude files t
+0002d920: 6f20 7465 7374 2065 7863 6c75 6465 2066  o test exclude f
+0002d930: 696c 7465 722e 0a20 2020 2020 2020 2023  ilter..        #
+0002d940: 2053 746f 7265 7320 6d75 7374 2062 6520   Stores must be 
+0002d950: 6164 6465 6420 696e 2074 6865 2074 6573  added in the tes
+0002d960: 742e 0a20 2020 2020 2020 2077 6974 6820  t..        with 
+0002d970: 7465 6d70 6669 6c65 2e54 656d 706f 7261  tempfile.Tempora
+0002d980: 7279 4469 7265 6374 6f72 7928 2920 6173  ryDirectory() as
+0002d990: 2074 6d70 6469 723a 0a20 2020 2020 2020   tmpdir:.       
+0002d9a0: 2020 2020 2023 2043 7265 6174 6573 2066       # Creates f
+0002d9b0: 696c 6520 7374 7275 6374 7572 6520 746f  ile structure to
+0002d9c0: 2062 6520 7570 6c6f 6164 6564 2069 6e20   be uploaded in 
+0002d9d0: 7468 6520 5374 6f72 6167 650a 2020 2020  the Storage.    
+0002d9e0: 2020 2020 2020 2020 7365 6c66 2e63 7265          self.cre
+0002d9f0: 6174 655f 6469 725f 7374 7275 6374 7572  ate_dir_structur
+0002da00: 6528 746d 7064 6972 2c20 6769 7469 676e  e(tmpdir, gitign
+0002da10: 6f72 655f 7374 7275 6374 7572 6529 0a0a  ore_structure)..
+0002da20: 2020 2020 2020 2020 2020 2020 2320 4372              # Cr
+0002da30: 6561 7465 202e 6769 7469 676e 6f72 6520  eate .gitignore 
+0002da40: 616e 6420 6c69 7374 2066 696c 6573 2f64  and list files/d
+0002da50: 6972 7320 746f 2062 6520 6578 636c 7564  irs to be exclud
+0002da60: 6564 2069 6e20 6974 0a20 2020 2020 2020  ed in it.       
+0002da70: 2020 2020 2073 6b79 7069 6c6f 745f 7061       skypilot_pa
+0002da80: 7468 203d 206f 732e 7061 7468 2e64 6972  th = os.path.dir
+0002da90: 6e61 6d65 286f 732e 7061 7468 2e64 6972  name(os.path.dir
+0002daa0: 6e61 6d65 2873 6b79 2e5f 5f66 696c 655f  name(sky.__file_
+0002dab0: 5f29 290a 2020 2020 2020 2020 2020 2020  _)).            
+0002dac0: 7465 6d70 5f70 6174 6820 3d20 6627 7b74  temp_path = f'{t
+0002dad0: 6d70 6469 727d 2f2e 6769 7469 676e 6f72  mpdir}/.gitignor
+0002dae0: 6527 0a20 2020 2020 2020 2020 2020 2066  e'.            f
+0002daf0: 696c 655f 7061 7468 203d 206f 732e 7061  ile_path = os.pa
+0002db00: 7468 2e6a 6f69 6e28 736b 7970 696c 6f74  th.join(skypilot
+0002db10: 5f70 6174 682c 2027 7465 7374 732f 6769  _path, 'tests/gi
+0002db20: 7469 676e 6f72 655f 7465 7374 2729 0a20  tignore_test'). 
+0002db30: 2020 2020 2020 2020 2020 2073 6875 7469             shuti
+0002db40: 6c2e 636f 7079 6669 6c65 2866 696c 655f  l.copyfile(file_
+0002db50: 7061 7468 2c20 7465 6d70 5f70 6174 6829  path, temp_path)
+0002db60: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+0002db70: 4372 6561 7465 202e 6769 742f 696e 666f  Create .git/info
+0002db80: 2f65 7863 6c75 6465 2061 6e64 206c 6973  /exclude and lis
+0002db90: 7420 6669 6c65 732f 6469 7273 2074 6f20  t files/dirs to 
+0002dba0: 6265 2065 7863 6c75 6465 6420 696e 2069  be excluded in i
+0002dbb0: 740a 2020 2020 2020 2020 2020 2020 7465  t.            te
+0002dbc0: 6d70 5f70 6174 6820 3d20 6627 7b74 6d70  mp_path = f'{tmp
+0002dbd0: 6469 727d 2f2e 6769 742f 696e 666f 2f27  dir}/.git/info/'
+0002dbe0: 0a20 2020 2020 2020 2020 2020 206f 732e  .            os.
+0002dbf0: 6d61 6b65 6469 7273 2874 656d 705f 7061  makedirs(temp_pa
+0002dc00: 7468 290a 2020 2020 2020 2020 2020 2020  th).            
+0002dc10: 7465 6d70 5f65 7863 6c75 6465 5f70 6174  temp_exclude_pat
+0002dc20: 6820 3d20 6f73 2e70 6174 682e 6a6f 696e  h = os.path.join
+0002dc30: 2874 656d 705f 7061 7468 2c20 2765 7863  (temp_path, 'exc
+0002dc40: 6c75 6465 2729 0a20 2020 2020 2020 2020  lude').         
+0002dc50: 2020 2066 696c 655f 7061 7468 203d 206f     file_path = o
+0002dc60: 732e 7061 7468 2e6a 6f69 6e28 736b 7970  s.path.join(skyp
+0002dc70: 696c 6f74 5f70 6174 682c 0a20 2020 2020  ilot_path,.     
+0002dc80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002dc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002dca0: 2774 6573 7473 2f67 6974 5f69 6e66 6f5f  'tests/git_info_
+0002dcb0: 6578 636c 7564 655f 7465 7374 2729 0a20  exclude_test'). 
+0002dcc0: 2020 2020 2020 2020 2020 2073 6875 7469             shuti
+0002dcd0: 6c2e 636f 7079 6669 6c65 2866 696c 655f  l.copyfile(file_
+0002dce0: 7061 7468 2c20 7465 6d70 5f65 7863 6c75  path, temp_exclu
+0002dcf0: 6465 5f70 6174 6829 0a0a 2020 2020 2020  de_path)..      
+0002dd00: 2020 2020 2020 2320 4372 6561 7465 2073        # Create s
+0002dd10: 6b79 2053 746f 7261 6765 2077 6974 6820  ky Storage with 
+0002dd20: 7468 6520 6669 6c65 7320 6372 6561 7465  the files create
+0002dd30: 640a 2020 2020 2020 2020 2020 2020 7969  d.            yi
+0002dd40: 656c 6420 6672 6f6d 2073 656c 662e 7969  eld from self.yi
+0002dd50: 656c 645f 7374 6f72 6167 655f 6f62 6a65  eld_storage_obje
+0002dd60: 6374 280a 2020 2020 2020 2020 2020 2020  ct(.            
+0002dd70: 2020 2020 6e61 6d65 3d74 6d70 5f62 7563      name=tmp_buc
+0002dd80: 6b65 745f 6e61 6d65 2c0a 2020 2020 2020  ket_name,.      
+0002dd90: 2020 2020 2020 2020 2020 736f 7572 6365            source
+0002dda0: 3d74 6d70 6469 722c 0a20 2020 2020 2020  =tmpdir,.       
+0002ddb0: 2020 2020 2020 2020 206d 6f64 653d 7374           mode=st
+0002ddc0: 6f72 6167 655f 6c69 622e 5374 6f72 6167  orage_lib.Storag
+0002ddd0: 654d 6f64 652e 434f 5059 290a 0a20 2020  eMode.COPY)..   
+0002dde0: 2040 7079 7465 7374 2e66 6978 7475 7265   @pytest.fixture
+0002ddf0: 0a20 2020 2064 6566 2074 6d70 5f61 7773  .    def tmp_aws
+0002de00: 636c 695f 6275 636b 6574 2873 656c 662c  cli_bucket(self,
+0002de10: 2074 6d70 5f62 7563 6b65 745f 6e61 6d65   tmp_bucket_name
+0002de20: 293a 0a20 2020 2020 2020 2023 2043 7265  ):.        # Cre
+0002de30: 6174 6573 2061 2074 656d 706f 7261 7279  ates a temporary
+0002de40: 2062 7563 6b65 7420 7573 696e 6720 6177   bucket using aw
+0002de50: 7363 6c69 0a20 2020 2020 2020 2062 7563  scli.        buc
+0002de60: 6b65 745f 7572 6920 3d20 6627 7333 3a2f  ket_uri = f's3:/
+0002de70: 2f7b 746d 705f 6275 636b 6574 5f6e 616d  /{tmp_bucket_nam
+0002de80: 657d 270a 2020 2020 2020 2020 7375 6270  e}'.        subp
+0002de90: 726f 6365 7373 2e63 6865 636b 5f63 616c  rocess.check_cal
+0002dea0: 6c28 5b27 6177 7327 2c20 2773 3327 2c20  l(['aws', 's3', 
+0002deb0: 276d 6227 2c20 6275 636b 6574 5f75 7269  'mb', bucket_uri
+0002dec0: 5d29 0a20 2020 2020 2020 2079 6965 6c64  ]).        yield
+0002ded0: 2074 6d70 5f62 7563 6b65 745f 6e61 6d65   tmp_bucket_name
+0002dee0: 2c20 6275 636b 6574 5f75 7269 0a20 2020  , bucket_uri.   
+0002def0: 2020 2020 2073 7562 7072 6f63 6573 732e       subprocess.
+0002df00: 6368 6563 6b5f 6361 6c6c 285b 2761 7773  check_call(['aws
+0002df10: 272c 2027 7333 272c 2027 7262 272c 2062  ', 's3', 'rb', b
+0002df20: 7563 6b65 745f 7572 692c 2027 2d2d 666f  ucket_uri, '--fo
+0002df30: 7263 6527 5d29 0a0a 2020 2020 4070 7974  rce'])..    @pyt
+0002df40: 6573 742e 6669 7874 7572 650a 2020 2020  est.fixture.    
+0002df50: 6465 6620 746d 705f 6773 7574 696c 5f62  def tmp_gsutil_b
+0002df60: 7563 6b65 7428 7365 6c66 2c20 746d 705f  ucket(self, tmp_
+0002df70: 6275 636b 6574 5f6e 616d 6529 3a0a 2020  bucket_name):.  
+0002df80: 2020 2020 2020 2320 4372 6561 7465 7320        # Creates 
+0002df90: 6120 7465 6d70 6f72 6172 7920 6275 636b  a temporary buck
+0002dfa0: 6574 2075 7369 6e67 2067 7375 7469 6c0a  et using gsutil.
+0002dfb0: 2020 2020 2020 2020 6275 636b 6574 5f75          bucket_u
+0002dfc0: 7269 203d 2066 2767 733a 2f2f 7b74 6d70  ri = f'gs://{tmp
+0002dfd0: 5f62 7563 6b65 745f 6e61 6d65 7d27 0a20  _bucket_name}'. 
+0002dfe0: 2020 2020 2020 2073 7562 7072 6f63 6573         subproces
+0002dff0: 732e 6368 6563 6b5f 6361 6c6c 285b 2767  s.check_call(['g
+0002e000: 7375 7469 6c27 2c20 276d 6227 2c20 6275  sutil', 'mb', bu
+0002e010: 636b 6574 5f75 7269 5d29 0a20 2020 2020  cket_uri]).     
+0002e020: 2020 2079 6965 6c64 2074 6d70 5f62 7563     yield tmp_buc
+0002e030: 6b65 745f 6e61 6d65 2c20 6275 636b 6574  ket_name, bucket
+0002e040: 5f75 7269 0a20 2020 2020 2020 2073 7562  _uri.        sub
+0002e050: 7072 6f63 6573 732e 6368 6563 6b5f 6361  process.check_ca
+0002e060: 6c6c 285b 2767 7375 7469 6c27 2c20 2772  ll(['gsutil', 'r
+0002e070: 6d27 2c20 272d 7227 2c20 6275 636b 6574  m', '-r', bucket
+0002e080: 5f75 7269 5d29 0a0a 2020 2020 4070 7974  _uri])..    @pyt
+0002e090: 6573 742e 6669 7874 7572 650a 2020 2020  est.fixture.    
+0002e0a0: 6465 6620 746d 705f 6177 7363 6c69 5f62  def tmp_awscli_b
+0002e0b0: 7563 6b65 745f 7232 2873 656c 662c 2074  ucket_r2(self, t
+0002e0c0: 6d70 5f62 7563 6b65 745f 6e61 6d65 293a  mp_bucket_name):
+0002e0d0: 0a20 2020 2020 2020 2023 2043 7265 6174  .        # Creat
+0002e0e0: 6573 2061 2074 656d 706f 7261 7279 2062  es a temporary b
+0002e0f0: 7563 6b65 7420 7573 696e 6720 6177 7363  ucket using awsc
+0002e100: 6c69 0a20 2020 2020 2020 2065 6e64 706f  li.        endpo
+0002e110: 696e 745f 7572 6c20 3d20 636c 6f75 6466  int_url = cloudf
+0002e120: 6c61 7265 2e63 7265 6174 655f 656e 6470  lare.create_endp
+0002e130: 6f69 6e74 2829 0a20 2020 2020 2020 2062  oint().        b
+0002e140: 7563 6b65 745f 7572 6920 3d20 6627 7333  ucket_uri = f's3
+0002e150: 3a2f 2f7b 746d 705f 6275 636b 6574 5f6e  ://{tmp_bucket_n
+0002e160: 616d 657d 270a 2020 2020 2020 2020 7375  ame}'.        su
+0002e170: 6270 726f 6365 7373 2e63 6865 636b 5f63  bprocess.check_c
+0002e180: 616c 6c28 0a20 2020 2020 2020 2020 2020  all(.           
+0002e190: 2066 2741 5753 5f53 4841 5245 445f 4352   f'AWS_SHARED_CR
+0002e1a0: 4544 454e 5449 414c 535f 4649 4c45 3d7b  EDENTIALS_FILE={
+0002e1b0: 636c 6f75 6466 6c61 7265 2e52 325f 4352  cloudflare.R2_CR
+0002e1c0: 4544 454e 5449 414c 535f 5041 5448 7d20  EDENTIALS_PATH} 
+0002e1d0: 6177 7320 7333 206d 6220 7b62 7563 6b65  aws s3 mb {bucke
+0002e1e0: 745f 7572 697d 202d 2d65 6e64 706f 696e  t_uri} --endpoin
+0002e1f0: 7420 7b65 6e64 706f 696e 745f 7572 6c7d  t {endpoint_url}
+0002e200: 202d 2d70 726f 6669 6c65 3d72 3227 2c0a   --profile=r2',.
+0002e210: 2020 2020 2020 2020 2020 2020 7368 656c              shel
+0002e220: 6c3d 5472 7565 290a 2020 2020 2020 2020  l=True).        
+0002e230: 7969 656c 6420 746d 705f 6275 636b 6574  yield tmp_bucket
+0002e240: 5f6e 616d 652c 2062 7563 6b65 745f 7572  _name, bucket_ur
+0002e250: 690a 2020 2020 2020 2020 7375 6270 726f  i.        subpro
+0002e260: 6365 7373 2e63 6865 636b 5f63 616c 6c28  cess.check_call(
+0002e270: 0a20 2020 2020 2020 2020 2020 2066 2741  .            f'A
+0002e280: 5753 5f53 4841 5245 445f 4352 4544 454e  WS_SHARED_CREDEN
+0002e290: 5449 414c 535f 4649 4c45 3d7b 636c 6f75  TIALS_FILE={clou
+0002e2a0: 6466 6c61 7265 2e52 325f 4352 4544 454e  dflare.R2_CREDEN
+0002e2b0: 5449 414c 535f 5041 5448 7d20 6177 7320  TIALS_PATH} aws 
+0002e2c0: 7333 2072 6220 7b62 7563 6b65 745f 7572  s3 rb {bucket_ur
+0002e2d0: 697d 202d 2d66 6f72 6365 202d 2d65 6e64  i} --force --end
+0002e2e0: 706f 696e 7420 7b65 6e64 706f 696e 745f  point {endpoint_
+0002e2f0: 7572 6c7d 202d 2d70 726f 6669 6c65 3d72  url} --profile=r
+0002e300: 3227 2c0a 2020 2020 2020 2020 2020 2020  2',.            
+0002e310: 7368 656c 6c3d 5472 7565 290a 0a20 2020  shell=True)..   
+0002e320: 2040 7079 7465 7374 2e66 6978 7475 7265   @pytest.fixture
+0002e330: 0a20 2020 2064 6566 2074 6d70 5f69 626d  .    def tmp_ibm
+0002e340: 5f63 6f73 5f62 7563 6b65 7428 7365 6c66  _cos_bucket(self
+0002e350: 2c20 746d 705f 6275 636b 6574 5f6e 616d  , tmp_bucket_nam
+0002e360: 6529 3a0a 2020 2020 2020 2020 2320 4372  e):.        # Cr
+0002e370: 6561 7465 7320 6120 7465 6d70 6f72 6172  eates a temporar
+0002e380: 7920 6275 636b 6574 2075 7369 6e67 2049  y bucket using I
+0002e390: 424d 2043 4f53 2041 5049 0a20 2020 2020  BM COS API.     
+0002e3a0: 2020 2073 746f 7261 6765 5f6f 626a 203d     storage_obj =
+0002e3b0: 2073 746f 7261 6765 5f6c 6962 2e49 424d   storage_lib.IBM
+0002e3c0: 436f 7353 746f 7265 2873 6f75 7263 653d  CosStore(source=
+0002e3d0: 2222 2c20 6e61 6d65 3d74 6d70 5f62 7563  "", name=tmp_buc
+0002e3e0: 6b65 745f 6e61 6d65 290a 2020 2020 2020  ket_name).      
+0002e3f0: 2020 7969 656c 6420 746d 705f 6275 636b    yield tmp_buck
+0002e400: 6574 5f6e 616d 650a 2020 2020 2020 2020  et_name.        
+0002e410: 7374 6f72 6167 655f 6f62 6a2e 6465 6c65  storage_obj.dele
+0002e420: 7465 2829 0a0a 2020 2020 4070 7974 6573  te()..    @pytes
+0002e430: 742e 6669 7874 7572 650a 2020 2020 6465  t.fixture.    de
+0002e440: 6620 746d 705f 7075 626c 6963 5f73 746f  f tmp_public_sto
+0002e450: 7261 6765 5f6f 626a 2873 656c 662c 2072  rage_obj(self, r
+0002e460: 6571 7565 7374 293a 0a20 2020 2020 2020  equest):.       
+0002e470: 2023 2049 6e69 7469 616c 697a 6573 2061   # Initializes a
+0002e480: 2073 746f 7261 6765 206f 626a 6563 7420   storage object 
+0002e490: 7769 7468 2061 2070 7562 6c69 6320 6275  with a public bu
+0002e4a0: 636b 6574 0a20 2020 2020 2020 2073 746f  cket.        sto
+0002e4b0: 7261 6765 5f6f 626a 203d 2073 746f 7261  rage_obj = stora
+0002e4c0: 6765 5f6c 6962 2e53 746f 7261 6765 2873  ge_lib.Storage(s
+0002e4d0: 6f75 7263 653d 7265 7175 6573 742e 7061  ource=request.pa
+0002e4e0: 7261 6d29 0a20 2020 2020 2020 2079 6965  ram).        yie
+0002e4f0: 6c64 2073 746f 7261 6765 5f6f 626a 0a20  ld storage_obj. 
+0002e500: 2020 2020 2020 2023 2054 6869 7320 646f         # This do
+0002e510: 6573 206e 6f74 2072 6571 7569 7265 2061  es not require a
+0002e520: 6e79 2064 656c 6574 696f 6e20 6c6f 6769  ny deletion logi
+0002e530: 6320 6265 6361 7573 6520 6974 2069 7320  c because it is 
+0002e540: 6120 7075 626c 6963 2062 7563 6b65 740a  a public bucket.
+0002e550: 2020 2020 2020 2020 2320 616e 6420 7368          # and sh
+0002e560: 6f75 6c64 206e 6f74 2067 6574 2061 6464  ould not get add
+0002e570: 6564 2074 6f20 676c 6f62 616c 5f75 7365  ed to global_use
+0002e580: 725f 7374 6174 652e 0a0a 2020 2020 4070  r_state...    @p
+0002e590: 7974 6573 742e 6d61 726b 2e6e 6f5f 666c  ytest.mark.no_fl
+0002e5a0: 7569 6473 7461 636b 0a20 2020 2040 7079  uidstack.    @py
+0002e5b0: 7465 7374 2e6d 6172 6b2e 7061 7261 6d65  test.mark.parame
+0002e5c0: 7472 697a 6528 2773 746f 7265 5f74 7970  trize('store_typ
+0002e5d0: 6527 2c20 5b0a 2020 2020 2020 2020 7374  e', [.        st
+0002e5e0: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+0002e5f0: 7970 652e 5333 2c20 7374 6f72 6167 655f  ype.S3, storage_
+0002e600: 6c69 622e 5374 6f72 6554 7970 652e 4743  lib.StoreType.GC
+0002e610: 532c 0a20 2020 2020 2020 2070 7974 6573  S,.        pytes
+0002e620: 742e 7061 7261 6d28 7374 6f72 6167 655f  t.param(storage_
+0002e630: 6c69 622e 5374 6f72 6554 7970 652e 4942  lib.StoreType.IB
+0002e640: 4d2c 206d 6172 6b73 3d70 7974 6573 742e  M, marks=pytest.
+0002e650: 6d61 726b 2e69 626d 292c 0a20 2020 2020  mark.ibm),.     
+0002e660: 2020 2070 7974 6573 742e 7061 7261 6d28     pytest.param(
+0002e670: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0002e680: 6554 7970 652e 5232 2c20 6d61 726b 733d  eType.R2, marks=
+0002e690: 7079 7465 7374 2e6d 6172 6b2e 636c 6f75  pytest.mark.clou
+0002e6a0: 6466 6c61 7265 290a 2020 2020 5d29 0a20  dflare).    ]). 
+0002e6b0: 2020 2064 6566 2074 6573 745f 6e65 775f     def test_new_
+0002e6c0: 6275 636b 6574 5f63 7265 6174 696f 6e5f  bucket_creation_
+0002e6d0: 616e 645f 6465 6c65 7469 6f6e 2873 656c  and_deletion(sel
+0002e6e0: 662c 2074 6d70 5f6c 6f63 616c 5f73 746f  f, tmp_local_sto
+0002e6f0: 7261 6765 5f6f 626a 2c0a 2020 2020 2020  rage_obj,.      
+0002e700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e720: 2020 2020 2020 2020 7374 6f72 655f 7479          store_ty
+0002e730: 7065 293a 0a20 2020 2020 2020 2023 2043  pe):.        # C
+0002e740: 7265 6174 6573 2061 206e 6577 2062 7563  reates a new buc
+0002e750: 6b65 7420 7769 7468 2061 206c 6f63 616c  ket with a local
+0002e760: 2073 6f75 7263 652c 2075 706c 6f61 6473   source, uploads
+0002e770: 2066 696c 6573 2074 6f20 6974 0a20 2020   files to it.   
+0002e780: 2020 2020 2023 2061 6e64 2064 656c 6574       # and delet
+0002e790: 6573 2069 742e 0a20 2020 2020 2020 2074  es it..        t
+0002e7a0: 6d70 5f6c 6f63 616c 5f73 746f 7261 6765  mp_local_storage
+0002e7b0: 5f6f 626a 2e61 6464 5f73 746f 7265 2873  _obj.add_store(s
+0002e7c0: 746f 7265 5f74 7970 6529 0a0a 2020 2020  tore_type)..    
+0002e7d0: 2020 2020 2320 5275 6e20 736b 7920 7374      # Run sky st
+0002e7e0: 6f72 6167 6520 6c73 2074 6f20 6368 6563  orage ls to chec
+0002e7f0: 6b20 6966 2073 746f 7261 6765 206f 626a  k if storage obj
+0002e800: 6563 7420 6578 6973 7473 2069 6e20 7468  ect exists in th
+0002e810: 6520 6f75 7470 7574 0a20 2020 2020 2020  e output.       
+0002e820: 206f 7574 203d 2073 7562 7072 6f63 6573   out = subproces
+0002e830: 732e 6368 6563 6b5f 6f75 7470 7574 285b  s.check_output([
+0002e840: 2773 6b79 272c 2027 7374 6f72 6167 6527  'sky', 'storage'
+0002e850: 2c20 276c 7327 5d29 0a20 2020 2020 2020  , 'ls']).       
+0002e860: 2061 7373 6572 7420 746d 705f 6c6f 6361   assert tmp_loca
+0002e870: 6c5f 7374 6f72 6167 655f 6f62 6a2e 6e61  l_storage_obj.na
+0002e880: 6d65 2069 6e20 6f75 742e 6465 636f 6465  me in out.decode
+0002e890: 2827 7574 662d 3827 290a 0a20 2020 2020  ('utf-8')..     
+0002e8a0: 2020 2023 2052 756e 2073 6b79 2073 746f     # Run sky sto
+0002e8b0: 7261 6765 2064 656c 6574 6520 746f 2064  rage delete to d
+0002e8c0: 656c 6574 6520 7468 6520 7374 6f72 6167  elete the storag
+0002e8d0: 6520 6f62 6a65 6374 0a20 2020 2020 2020  e object.       
+0002e8e0: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
+0002e8f0: 6b5f 6f75 7470 7574 280a 2020 2020 2020  k_output(.      
+0002e900: 2020 2020 2020 5b27 736b 7927 2c20 2773        ['sky', 's
+0002e910: 746f 7261 6765 272c 2027 6465 6c65 7465  torage', 'delete
+0002e920: 272c 2074 6d70 5f6c 6f63 616c 5f73 746f  ', tmp_local_sto
+0002e930: 7261 6765 5f6f 626a 2e6e 616d 652c 2027  rage_obj.name, '
+0002e940: 2d2d 7965 7327 5d29 0a0a 2020 2020 2020  --yes'])..      
+0002e950: 2020 2320 5275 6e20 736b 7920 7374 6f72    # Run sky stor
+0002e960: 6167 6520 6c73 2074 6f20 6368 6563 6b20  age ls to check 
+0002e970: 6966 2073 746f 7261 6765 206f 626a 6563  if storage objec
+0002e980: 7420 6973 2064 656c 6574 6564 0a20 2020  t is deleted.   
+0002e990: 2020 2020 206f 7574 203d 2073 7562 7072       out = subpr
+0002e9a0: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
+0002e9b0: 7574 285b 2773 6b79 272c 2027 7374 6f72  ut(['sky', 'stor
+0002e9c0: 6167 6527 2c20 276c 7327 5d29 0a20 2020  age', 'ls']).   
+0002e9d0: 2020 2020 2061 7373 6572 7420 746d 705f       assert tmp_
+0002e9e0: 6c6f 6361 6c5f 7374 6f72 6167 655f 6f62  local_storage_ob
+0002e9f0: 6a2e 6e61 6d65 206e 6f74 2069 6e20 6f75  j.name not in ou
+0002ea00: 742e 6465 636f 6465 2827 7574 662d 3827  t.decode('utf-8'
+0002ea10: 290a 0a20 2020 2040 7079 7465 7374 2e6d  )..    @pytest.m
+0002ea20: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
+0002ea30: 6b0a 2020 2020 4070 7974 6573 742e 6d61  k.    @pytest.ma
+0002ea40: 726b 2e78 6469 7374 5f67 726f 7570 2827  rk.xdist_group('
+0002ea50: 6d75 6c74 6970 6c65 5f62 7563 6b65 745f  multiple_bucket_
+0002ea60: 6465 6c65 7469 6f6e 2729 0a20 2020 2040  deletion').    @
+0002ea70: 7079 7465 7374 2e6d 6172 6b2e 7061 7261  pytest.mark.para
+0002ea80: 6d65 7472 697a 6528 2773 746f 7265 5f74  metrize('store_t
+0002ea90: 7970 6527 2c20 5b0a 2020 2020 2020 2020  ype', [.        
+0002eaa0: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0002eab0: 6554 7970 652e 5333 2c20 7374 6f72 6167  eType.S3, storag
+0002eac0: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
+0002ead0: 4743 532c 0a20 2020 2020 2020 2070 7974  GCS,.        pyt
+0002eae0: 6573 742e 7061 7261 6d28 7374 6f72 6167  est.param(storag
+0002eaf0: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
+0002eb00: 5232 2c20 6d61 726b 733d 7079 7465 7374  R2, marks=pytest
+0002eb10: 2e6d 6172 6b2e 636c 6f75 6466 6c61 7265  .mark.cloudflare
+0002eb20: 292c 0a20 2020 2020 2020 2070 7974 6573  ),.        pytes
+0002eb30: 742e 7061 7261 6d28 7374 6f72 6167 655f  t.param(storage_
+0002eb40: 6c69 622e 5374 6f72 6554 7970 652e 4942  lib.StoreType.IB
+0002eb50: 4d2c 206d 6172 6b73 3d70 7974 6573 742e  M, marks=pytest.
+0002eb60: 6d61 726b 2e69 626d 290a 2020 2020 5d29  mark.ibm).    ])
+0002eb70: 0a20 2020 2064 6566 2074 6573 745f 6d75  .    def test_mu
+0002eb80: 6c74 6970 6c65 5f62 7563 6b65 7473 5f63  ltiple_buckets_c
+0002eb90: 7265 6174 696f 6e5f 616e 645f 6465 6c65  reation_and_dele
+0002eba0: 7469 6f6e 280a 2020 2020 2020 2020 2020  tion(.          
+0002ebb0: 2020 7365 6c66 2c20 746d 705f 6d75 6c74    self, tmp_mult
+0002ebc0: 6970 6c65 5f73 6372 6174 6368 5f73 746f  iple_scratch_sto
+0002ebd0: 7261 6765 5f6f 626a 2c20 7374 6f72 655f  rage_obj, store_
+0002ebe0: 7479 7065 293a 0a20 2020 2020 2020 2023  type):.        #
+0002ebf0: 2043 7265 6174 6573 206d 756c 7469 706c   Creates multipl
+0002ec00: 6520 6e65 7720 6275 636b 6574 7328 3520  e new buckets(5 
+0002ec10: 6275 636b 6574 7329 2077 6974 6820 6120  buckets) with a 
+0002ec20: 6c6f 6361 6c20 736f 7572 6365 0a20 2020  local source.   
+0002ec30: 2020 2020 2023 2061 6e64 2064 656c 6574       # and delet
+0002ec40: 6573 2074 6865 6d2e 0a20 2020 2020 2020  es them..       
+0002ec50: 2073 746f 7261 6765 5f6f 626a 5f6e 616d   storage_obj_nam
+0002ec60: 6520 3d20 5b5d 0a20 2020 2020 2020 2066  e = [].        f
+0002ec70: 6f72 2073 746f 7265 5f6f 626a 2069 6e20  or store_obj in 
+0002ec80: 746d 705f 6d75 6c74 6970 6c65 5f73 6372  tmp_multiple_scr
+0002ec90: 6174 6368 5f73 746f 7261 6765 5f6f 626a  atch_storage_obj
+0002eca0: 3a0a 2020 2020 2020 2020 2020 2020 7374  :.            st
+0002ecb0: 6f72 655f 6f62 6a2e 6164 645f 7374 6f72  ore_obj.add_stor
+0002ecc0: 6528 7374 6f72 655f 7479 7065 290a 2020  e(store_type).  
+0002ecd0: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
+0002ece0: 655f 6f62 6a5f 6e61 6d65 2e61 7070 656e  e_obj_name.appen
+0002ecf0: 6428 7374 6f72 655f 6f62 6a2e 6e61 6d65  d(store_obj.name
+0002ed00: 290a 0a20 2020 2020 2020 2023 2052 756e  )..        # Run
+0002ed10: 2073 6b79 2073 746f 7261 6765 206c 7320   sky storage ls 
+0002ed20: 746f 2063 6865 636b 2069 6620 616c 6c20  to check if all 
+0002ed30: 7374 6f72 6167 6520 6f62 6a65 6374 7320  storage objects 
+0002ed40: 6578 6973 7473 2069 6e20 7468 650a 2020  exists in the.  
+0002ed50: 2020 2020 2020 2320 6f75 7470 7574 2066        # output f
+0002ed60: 696c 7465 7265 6420 6279 2073 746f 7265  iltered by store
+0002ed70: 2074 7970 650a 2020 2020 2020 2020 6f75   type.        ou
+0002ed80: 745f 616c 6c20 3d20 7375 6270 726f 6365  t_all = subproce
+0002ed90: 7373 2e63 6865 636b 5f6f 7574 7075 7428  ss.check_output(
+0002eda0: 5b27 736b 7927 2c20 2773 746f 7261 6765  ['sky', 'storage
+0002edb0: 272c 2027 6c73 275d 290a 2020 2020 2020  ', 'ls']).      
+0002edc0: 2020 6f75 7420 3d20 5b0a 2020 2020 2020    out = [.      
+0002edd0: 2020 2020 2020 6974 656d 2e73 706c 6974        item.split
+0002ede0: 2829 5b30 5d0a 2020 2020 2020 2020 2020  ()[0].          
+0002edf0: 2020 666f 7220 6974 656d 2069 6e20 6f75    for item in ou
+0002ee00: 745f 616c 6c2e 6465 636f 6465 2827 7574  t_all.decode('ut
+0002ee10: 662d 3827 292e 7370 6c69 746c 696e 6573  f-8').splitlines
+0002ee20: 2829 0a20 2020 2020 2020 2020 2020 2069  ().            i
+0002ee30: 6620 7374 6f72 655f 7479 7065 2e76 616c  f store_type.val
+0002ee40: 7565 2069 6e20 6974 656d 0a20 2020 2020  ue in item.     
+0002ee50: 2020 205d 0a20 2020 2020 2020 2061 7373     ].        ass
+0002ee60: 6572 7420 616c 6c28 5b69 7465 6d20 696e  ert all([item in
+0002ee70: 206f 7574 2066 6f72 2069 7465 6d20 696e   out for item in
+0002ee80: 2073 746f 7261 6765 5f6f 626a 5f6e 616d   storage_obj_nam
+0002ee90: 655d 290a 0a20 2020 2020 2020 2023 2052  e])..        # R
+0002eea0: 756e 2073 6b79 2073 746f 7261 6765 2064  un sky storage d
+0002eeb0: 656c 6574 6520 616c 6c20 746f 2064 656c  elete all to del
+0002eec0: 6574 6520 616c 6c20 7374 6f72 6167 6520  ete all storage 
+0002eed0: 6f62 6a65 6374 730a 2020 2020 2020 2020  objects.        
+0002eee0: 6465 6c65 7465 5f63 6d64 203d 205b 2773  delete_cmd = ['s
+0002eef0: 6b79 272c 2027 7374 6f72 6167 6527 2c20  ky', 'storage', 
+0002ef00: 2764 656c 6574 6527 2c20 272d 2d79 6573  'delete', '--yes
+0002ef10: 275d 0a20 2020 2020 2020 2064 656c 6574  '].        delet
+0002ef20: 655f 636d 6420 2b3d 2073 746f 7261 6765  e_cmd += storage
+0002ef30: 5f6f 626a 5f6e 616d 650a 2020 2020 2020  _obj_name.      
+0002ef40: 2020 7375 6270 726f 6365 7373 2e63 6865    subprocess.che
+0002ef50: 636b 5f6f 7574 7075 7428 6465 6c65 7465  ck_output(delete
+0002ef60: 5f63 6d64 290a 0a20 2020 2020 2020 2023  _cmd)..        #
+0002ef70: 2052 756e 2073 6b79 2073 746f 7261 6765   Run sky storage
+0002ef80: 206c 7320 746f 2063 6865 636b 2069 6620   ls to check if 
+0002ef90: 616c 6c20 7374 6f72 6167 6520 6f62 6a65  all storage obje
+0002efa0: 6374 7320 6669 6c74 6572 6564 2062 7920  cts filtered by 
+0002efb0: 7374 6f72 650a 2020 2020 2020 2020 2320  store.        # 
+0002efc0: 7479 7065 2061 7265 2064 656c 6574 6564  type are deleted
+0002efd0: 0a20 2020 2020 2020 206f 7574 5f61 6c6c  .        out_all
+0002efe0: 203d 2073 7562 7072 6f63 6573 732e 6368   = subprocess.ch
+0002eff0: 6563 6b5f 6f75 7470 7574 285b 2773 6b79  eck_output(['sky
+0002f000: 272c 2027 7374 6f72 6167 6527 2c20 276c  ', 'storage', 'l
+0002f010: 7327 5d29 0a20 2020 2020 2020 206f 7574  s']).        out
+0002f020: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
+0002f030: 2069 7465 6d2e 7370 6c69 7428 295b 305d   item.split()[0]
+0002f040: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+0002f050: 2069 7465 6d20 696e 206f 7574 5f61 6c6c   item in out_all
+0002f060: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
+0002f070: 2e73 706c 6974 6c69 6e65 7328 290a 2020  .splitlines().  
+0002f080: 2020 2020 2020 2020 2020 6966 2073 746f            if sto
+0002f090: 7265 5f74 7970 652e 7661 6c75 6520 696e  re_type.value in
+0002f0a0: 2069 7465 6d0a 2020 2020 2020 2020 5d0a   item.        ].
+0002f0b0: 2020 2020 2020 2020 6173 7365 7274 2061          assert a
+0002f0c0: 6c6c 285b 6974 656d 206e 6f74 2069 6e20  ll([item not in 
+0002f0d0: 6f75 7420 666f 7220 6974 656d 2069 6e20  out for item in 
+0002f0e0: 7374 6f72 6167 655f 6f62 6a5f 6e61 6d65  storage_obj_name
+0002f0f0: 5d29 0a0a 2020 2020 4070 7974 6573 742e  ])..    @pytest.
+0002f100: 6d61 726b 2e6e 6f5f 666c 7569 6473 7461  mark.no_fluidsta
+0002f110: 636b 0a20 2020 2040 7079 7465 7374 2e6d  ck.    @pytest.m
+0002f120: 6172 6b2e 7061 7261 6d65 7472 697a 6528  ark.parametrize(
+0002f130: 2773 746f 7265 5f74 7970 6527 2c20 5b0a  'store_type', [.
+0002f140: 2020 2020 2020 2020 7374 6f72 6167 655f          storage_
+0002f150: 6c69 622e 5374 6f72 6554 7970 652e 5333  lib.StoreType.S3
+0002f160: 2c20 7374 6f72 6167 655f 6c69 622e 5374  , storage_lib.St
+0002f170: 6f72 6554 7970 652e 4743 532c 0a20 2020  oreType.GCS,.   
+0002f180: 2020 2020 2070 7974 6573 742e 7061 7261       pytest.para
+0002f190: 6d28 7374 6f72 6167 655f 6c69 622e 5374  m(storage_lib.St
+0002f1a0: 6f72 6554 7970 652e 4942 4d2c 206d 6172  oreType.IBM, mar
+0002f1b0: 6b73 3d70 7974 6573 742e 6d61 726b 2e69  ks=pytest.mark.i
+0002f1c0: 626d 292c 0a20 2020 2020 2020 2070 7974  bm),.        pyt
+0002f1d0: 6573 742e 7061 7261 6d28 7374 6f72 6167  est.param(storag
+0002f1e0: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
+0002f1f0: 5232 2c20 6d61 726b 733d 7079 7465 7374  R2, marks=pytest
+0002f200: 2e6d 6172 6b2e 636c 6f75 6466 6c61 7265  .mark.cloudflare
+0002f210: 290a 2020 2020 5d29 0a20 2020 2064 6566  ).    ]).    def
+0002f220: 2074 6573 745f 7570 6c6f 6164 5f73 6f75   test_upload_sou
+0002f230: 7263 655f 7769 7468 5f73 7061 6365 7328  rce_with_spaces(
+0002f240: 7365 6c66 2c20 7374 6f72 655f 7479 7065  self, store_type
+0002f250: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002f260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f270: 2020 2020 2020 2020 2074 6d70 5f6d 756c           tmp_mul
+0002f280: 7469 706c 655f 6375 7374 6f6d 5f73 6f75  tiple_custom_sou
+0002f290: 7263 655f 7374 6f72 6167 655f 6f62 6a29  rce_storage_obj)
+0002f2a0: 3a0a 2020 2020 2020 2020 2320 4372 6561  :.        # Crea
+0002f2b0: 7465 7320 7477 6f20 6275 636b 6574 7320  tes two buckets 
+0002f2c0: 7769 7468 2073 7065 6369 6669 6564 206c  with specified l
+0002f2d0: 6f63 616c 2073 6f75 7263 6573 0a20 2020  ocal sources.   
+0002f2e0: 2020 2020 2023 2077 6974 6820 7370 6163       # with spac
+0002f2f0: 6573 2069 6e20 7468 6520 6e61 6d65 0a20  es in the name. 
+0002f300: 2020 2020 2020 2073 746f 7261 6765 5f6f         storage_o
+0002f310: 626a 5f6e 616d 6573 203d 205b 5d0a 2020  bj_names = [].  
+0002f320: 2020 2020 2020 666f 7220 7374 6f72 6167        for storag
+0002f330: 655f 6f62 6a20 696e 2074 6d70 5f6d 756c  e_obj in tmp_mul
+0002f340: 7469 706c 655f 6375 7374 6f6d 5f73 6f75  tiple_custom_sou
+0002f350: 7263 655f 7374 6f72 6167 655f 6f62 6a3a  rce_storage_obj:
+0002f360: 0a20 2020 2020 2020 2020 2020 2073 746f  .            sto
+0002f370: 7261 6765 5f6f 626a 2e61 6464 5f73 746f  rage_obj.add_sto
+0002f380: 7265 2873 746f 7265 5f74 7970 6529 0a20  re(store_type). 
+0002f390: 2020 2020 2020 2020 2020 2073 746f 7261             stora
+0002f3a0: 6765 5f6f 626a 5f6e 616d 6573 2e61 7070  ge_obj_names.app
+0002f3b0: 656e 6428 7374 6f72 6167 655f 6f62 6a2e  end(storage_obj.
+0002f3c0: 6e61 6d65 290a 0a20 2020 2020 2020 2023  name)..        #
+0002f3d0: 2052 756e 2073 6b79 2073 746f 7261 6765   Run sky storage
+0002f3e0: 206c 7320 746f 2063 6865 636b 2069 6620   ls to check if 
+0002f3f0: 616c 6c20 7374 6f72 6167 6520 6f62 6a65  all storage obje
+0002f400: 6374 7320 6578 6973 7473 2069 6e20 7468  cts exists in th
+0002f410: 650a 2020 2020 2020 2020 2320 6f75 7470  e.        # outp
+0002f420: 7574 2066 696c 7465 7265 6420 6279 2073  ut filtered by s
+0002f430: 746f 7265 2074 7970 650a 2020 2020 2020  tore type.      
+0002f440: 2020 6f75 745f 616c 6c20 3d20 7375 6270    out_all = subp
+0002f450: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
+0002f460: 7075 7428 5b27 736b 7927 2c20 2773 746f  put(['sky', 'sto
+0002f470: 7261 6765 272c 2027 6c73 275d 290a 2020  rage', 'ls']).  
+0002f480: 2020 2020 2020 6f75 7420 3d20 5b0a 2020        out = [.  
+0002f490: 2020 2020 2020 2020 2020 6974 656d 2e73            item.s
+0002f4a0: 706c 6974 2829 5b30 5d0a 2020 2020 2020  plit()[0].      
+0002f4b0: 2020 2020 2020 666f 7220 6974 656d 2069        for item i
+0002f4c0: 6e20 6f75 745f 616c 6c2e 6465 636f 6465  n out_all.decode
+0002f4d0: 2827 7574 662d 3827 292e 7370 6c69 746c  ('utf-8').splitl
+0002f4e0: 696e 6573 2829 0a20 2020 2020 2020 2020  ines().         
+0002f4f0: 2020 2069 6620 7374 6f72 655f 7479 7065     if store_type
+0002f500: 2e76 616c 7565 2069 6e20 6974 656d 0a20  .value in item. 
+0002f510: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
+0002f520: 2061 7373 6572 7420 616c 6c28 5b69 7465   assert all([ite
+0002f530: 6d20 696e 206f 7574 2066 6f72 2069 7465  m in out for ite
+0002f540: 6d20 696e 2073 746f 7261 6765 5f6f 626a  m in storage_obj
+0002f550: 5f6e 616d 6573 5d29 0a0a 2020 2020 4070  _names])..    @p
+0002f560: 7974 6573 742e 6d61 726b 2e6e 6f5f 666c  ytest.mark.no_fl
+0002f570: 7569 6473 7461 636b 0a20 2020 2040 7079  uidstack.    @py
+0002f580: 7465 7374 2e6d 6172 6b2e 7061 7261 6d65  test.mark.parame
+0002f590: 7472 697a 6528 2773 746f 7265 5f74 7970  trize('store_typ
+0002f5a0: 6527 2c20 5b0a 2020 2020 2020 2020 7374  e', [.        st
+0002f5b0: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+0002f5c0: 7970 652e 5333 2c20 7374 6f72 6167 655f  ype.S3, storage_
+0002f5d0: 6c69 622e 5374 6f72 6554 7970 652e 4743  lib.StoreType.GC
+0002f5e0: 532c 0a20 2020 2020 2020 2070 7974 6573  S,.        pytes
+0002f5f0: 742e 7061 7261 6d28 7374 6f72 6167 655f  t.param(storage_
+0002f600: 6c69 622e 5374 6f72 6554 7970 652e 4942  lib.StoreType.IB
+0002f610: 4d2c 206d 6172 6b73 3d70 7974 6573 742e  M, marks=pytest.
+0002f620: 6d61 726b 2e69 626d 292c 0a20 2020 2020  mark.ibm),.     
+0002f630: 2020 2070 7974 6573 742e 7061 7261 6d28     pytest.param(
+0002f640: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0002f650: 6554 7970 652e 5232 2c20 6d61 726b 733d  eType.R2, marks=
+0002f660: 7079 7465 7374 2e6d 6172 6b2e 636c 6f75  pytest.mark.clou
+0002f670: 6466 6c61 7265 290a 2020 2020 5d29 0a20  dflare).    ]). 
+0002f680: 2020 2064 6566 2074 6573 745f 6275 636b     def test_buck
+0002f690: 6574 5f65 7874 6572 6e61 6c5f 6465 6c65  et_external_dele
+0002f6a0: 7469 6f6e 2873 656c 662c 2074 6d70 5f73  tion(self, tmp_s
+0002f6b0: 6372 6174 6368 5f73 746f 7261 6765 5f6f  cratch_storage_o
+0002f6c0: 626a 2c0a 2020 2020 2020 2020 2020 2020  bj,.            
+0002f6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f6e0: 2020 2020 2020 2020 2020 7374 6f72 655f            store_
+0002f6f0: 7479 7065 293a 0a20 2020 2020 2020 2023  type):.        #
+0002f700: 2043 7265 6174 6573 2061 2062 7563 6b65   Creates a bucke
+0002f710: 742c 2064 656c 6574 6573 2069 7420 6578  t, deletes it ex
+0002f720: 7465 726e 616c 6c79 2075 7369 6e67 2063  ternally using c
+0002f730: 6c6f 7564 2063 6c69 2063 6f6d 6d61 6e64  loud cli command
+0002f740: 730a 2020 2020 2020 2020 2320 616e 6420  s.        # and 
+0002f750: 7468 656e 2074 7269 6573 2074 6f20 6465  then tries to de
+0002f760: 6c65 7465 2069 7420 7573 696e 6720 736b  lete it using sk
+0002f770: 7920 7374 6f72 6167 6520 6465 6c65 7465  y storage delete
+0002f780: 2e0a 2020 2020 2020 2020 746d 705f 7363  ..        tmp_sc
+0002f790: 7261 7463 685f 7374 6f72 6167 655f 6f62  ratch_storage_ob
+0002f7a0: 6a2e 6164 645f 7374 6f72 6528 7374 6f72  j.add_store(stor
+0002f7b0: 655f 7479 7065 290a 0a20 2020 2020 2020  e_type)..       
+0002f7c0: 2023 2052 756e 2073 6b79 2073 746f 7261   # Run sky stora
+0002f7d0: 6765 206c 7320 746f 2063 6865 636b 2069  ge ls to check i
+0002f7e0: 6620 7374 6f72 6167 6520 6f62 6a65 6374  f storage object
+0002f7f0: 2065 7869 7374 7320 696e 2074 6865 206f   exists in the o
+0002f800: 7574 7075 740a 2020 2020 2020 2020 6f75  utput.        ou
+0002f810: 7420 3d20 7375 6270 726f 6365 7373 2e63  t = subprocess.c
+0002f820: 6865 636b 5f6f 7574 7075 7428 5b27 736b  heck_output(['sk
+0002f830: 7927 2c20 2773 746f 7261 6765 272c 2027  y', 'storage', '
+0002f840: 6c73 275d 290a 2020 2020 2020 2020 6173  ls']).        as
+0002f850: 7365 7274 2074 6d70 5f73 6372 6174 6368  sert tmp_scratch
+0002f860: 5f73 746f 7261 6765 5f6f 626a 2e6e 616d  _storage_obj.nam
+0002f870: 6520 696e 206f 7574 2e64 6563 6f64 6528  e in out.decode(
+0002f880: 2775 7466 2d38 2729 0a0a 2020 2020 2020  'utf-8')..      
+0002f890: 2020 2320 4465 6c65 7465 2062 7563 6b65    # Delete bucke
+0002f8a0: 7420 6578 7465 726e 616c 6c79 0a20 2020  t externally.   
+0002f8b0: 2020 2020 2063 6d64 203d 2073 656c 662e       cmd = self.
+0002f8c0: 636c 695f 6465 6c65 7465 5f63 6d64 2873  cli_delete_cmd(s
+0002f8d0: 746f 7265 5f74 7970 652c 2074 6d70 5f73  tore_type, tmp_s
+0002f8e0: 6372 6174 6368 5f73 746f 7261 6765 5f6f  cratch_storage_o
+0002f8f0: 626a 2e6e 616d 6529 0a20 2020 2020 2020  bj.name).       
+0002f900: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
+0002f910: 6b5f 6f75 7470 7574 2863 6d64 2c20 7368  k_output(cmd, sh
+0002f920: 656c 6c3d 5472 7565 290a 0a20 2020 2020  ell=True)..     
+0002f930: 2020 2023 2052 756e 2073 6b79 2073 746f     # Run sky sto
+0002f940: 7261 6765 2064 656c 6574 6520 746f 2064  rage delete to d
+0002f950: 656c 6574 6520 7468 6520 7374 6f72 6167  elete the storag
+0002f960: 6520 6f62 6a65 6374 0a20 2020 2020 2020  e object.       
+0002f970: 206f 7574 203d 2073 7562 7072 6f63 6573   out = subproces
+0002f980: 732e 6368 6563 6b5f 6f75 7470 7574 280a  s.check_output(.
+0002f990: 2020 2020 2020 2020 2020 2020 5b27 736b              ['sk
+0002f9a0: 7927 2c20 2773 746f 7261 6765 272c 2027  y', 'storage', '
+0002f9b0: 6465 6c65 7465 272c 2074 6d70 5f73 6372  delete', tmp_scr
+0002f9c0: 6174 6368 5f73 746f 7261 6765 5f6f 626a  atch_storage_obj
+0002f9d0: 2e6e 616d 652c 2027 2d2d 7965 7327 5d29  .name, '--yes'])
+0002f9e0: 0a20 2020 2020 2020 2023 204d 616b 6520  .        # Make 
+0002f9f0: 7375 7265 2062 7563 6b65 7420 7761 7320  sure bucket was 
+0002fa00: 6e6f 7420 6372 6561 7465 6420 6475 7269  not created duri
+0002fa10: 6e67 2064 656c 6574 696f 6e20 2873 6565  ng deletion (see
+0002fa20: 2069 7373 7565 2023 3133 3232 290a 2020   issue #1322).  
+0002fa30: 2020 2020 2020 6173 7365 7274 2027 6372        assert 'cr
+0002fa40: 6561 7465 6427 206e 6f74 2069 6e20 6f75  eated' not in ou
+0002fa50: 742e 6465 636f 6465 2827 7574 662d 3827  t.decode('utf-8'
+0002fa60: 292e 6c6f 7765 7228 290a 0a20 2020 2020  ).lower()..     
+0002fa70: 2020 2023 2052 756e 2073 6b79 2073 746f     # Run sky sto
+0002fa80: 7261 6765 206c 7320 746f 2063 6865 636b  rage ls to check
+0002fa90: 2069 6620 7374 6f72 6167 6520 6f62 6a65   if storage obje
+0002faa0: 6374 2069 7320 6465 6c65 7465 640a 2020  ct is deleted.  
+0002fab0: 2020 2020 2020 6f75 7420 3d20 7375 6270        out = subp
+0002fac0: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
+0002fad0: 7075 7428 5b27 736b 7927 2c20 2773 746f  put(['sky', 'sto
+0002fae0: 7261 6765 272c 2027 6c73 275d 290a 2020  rage', 'ls']).  
+0002faf0: 2020 2020 2020 6173 7365 7274 2074 6d70        assert tmp
+0002fb00: 5f73 6372 6174 6368 5f73 746f 7261 6765  _scratch_storage
+0002fb10: 5f6f 626a 2e6e 616d 6520 6e6f 7420 696e  _obj.name not in
+0002fb20: 206f 7574 2e64 6563 6f64 6528 2775 7466   out.decode('utf
+0002fb30: 2d38 2729 0a0a 2020 2020 4070 7974 6573  -8')..    @pytes
+0002fb40: 742e 6d61 726b 2e6e 6f5f 666c 7569 6473  t.mark.no_fluids
+0002fb50: 7461 636b 0a20 2020 2040 7079 7465 7374  tack.    @pytest
+0002fb60: 2e6d 6172 6b2e 7061 7261 6d65 7472 697a  .mark.parametriz
+0002fb70: 6528 2773 746f 7265 5f74 7970 6527 2c20  e('store_type', 
+0002fb80: 5b0a 2020 2020 2020 2020 7374 6f72 6167  [.        storag
+0002fb90: 655f 6c69 622e 5374 6f72 6554 7970 652e  e_lib.StoreType.
+0002fba0: 5333 2c20 7374 6f72 6167 655f 6c69 622e  S3, storage_lib.
+0002fbb0: 5374 6f72 6554 7970 652e 4743 532c 0a20  StoreType.GCS,. 
+0002fbc0: 2020 2020 2020 2070 7974 6573 742e 7061         pytest.pa
+0002fbd0: 7261 6d28 7374 6f72 6167 655f 6c69 622e  ram(storage_lib.
+0002fbe0: 5374 6f72 6554 7970 652e 4942 4d2c 206d  StoreType.IBM, m
+0002fbf0: 6172 6b73 3d70 7974 6573 742e 6d61 726b  arks=pytest.mark
+0002fc00: 2e69 626d 292c 0a20 2020 2020 2020 2070  .ibm),.        p
+0002fc10: 7974 6573 742e 7061 7261 6d28 7374 6f72  ytest.param(stor
+0002fc20: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+0002fc30: 652e 5232 2c20 6d61 726b 733d 7079 7465  e.R2, marks=pyte
+0002fc40: 7374 2e6d 6172 6b2e 636c 6f75 6466 6c61  st.mark.cloudfla
+0002fc50: 7265 290a 2020 2020 5d29 0a20 2020 2064  re).    ]).    d
+0002fc60: 6566 2074 6573 745f 6275 636b 6574 5f62  ef test_bucket_b
+0002fc70: 756c 6b5f 6465 6c65 7469 6f6e 2873 656c  ulk_deletion(sel
+0002fc80: 662c 2073 746f 7265 5f74 7970 652c 2074  f, store_type, t
+0002fc90: 6d70 5f62 756c 6b5f 6465 6c5f 7374 6f72  mp_bulk_del_stor
+0002fca0: 6167 655f 6f62 6a29 3a0a 2020 2020 2020  age_obj):.      
+0002fcb0: 2020 2320 4372 6561 7465 7320 6120 7465    # Creates a te
+0002fcc0: 6d70 2066 6f6c 6465 7220 7769 7468 206f  mp folder with o
+0002fcd0: 7665 7220 3235 3620 6669 6c65 7320 616e  ver 256 files an
+0002fce0: 6420 666f 6c64 6572 732c 2075 706c 6f61  d folders, uploa
+0002fcf0: 640a 2020 2020 2020 2020 2320 6669 6c65  d.        # file
+0002fd00: 7320 616e 6420 666f 6c64 6572 7320 746f  s and folders to
+0002fd10: 2061 206e 6577 2062 7563 6b65 742c 2074   a new bucket, t
+0002fd20: 6865 6e20 6465 6c65 7465 2062 7563 6b65  hen delete bucke
+0002fd30: 742e 0a20 2020 2020 2020 2074 6d70 5f62  t..        tmp_b
+0002fd40: 756c 6b5f 6465 6c5f 7374 6f72 6167 655f  ulk_del_storage_
+0002fd50: 6f62 6a2e 6164 645f 7374 6f72 6528 7374  obj.add_store(st
+0002fd60: 6f72 655f 7479 7065 290a 0a20 2020 2020  ore_type)..     
+0002fd70: 2020 2073 7562 7072 6f63 6573 732e 6368     subprocess.ch
+0002fd80: 6563 6b5f 6f75 7470 7574 285b 0a20 2020  eck_output([.   
+0002fd90: 2020 2020 2020 2020 2027 736b 7927 2c20           'sky', 
+0002fda0: 2773 746f 7261 6765 272c 2027 6465 6c65  'storage', 'dele
+0002fdb0: 7465 272c 2074 6d70 5f62 756c 6b5f 6465  te', tmp_bulk_de
+0002fdc0: 6c5f 7374 6f72 6167 655f 6f62 6a2e 6e61  l_storage_obj.na
+0002fdd0: 6d65 2c20 272d 2d79 6573 270a 2020 2020  me, '--yes'.    
+0002fde0: 2020 2020 5d29 0a0a 2020 2020 2020 2020      ])..        
+0002fdf0: 6f75 7470 7574 203d 2073 7562 7072 6f63  output = subproc
+0002fe00: 6573 732e 6368 6563 6b5f 6f75 7470 7574  ess.check_output
+0002fe10: 285b 2773 6b79 272c 2027 7374 6f72 6167  (['sky', 'storag
+0002fe20: 6527 2c20 276c 7327 5d29 0a20 2020 2020  e', 'ls']).     
+0002fe30: 2020 2061 7373 6572 7420 746d 705f 6275     assert tmp_bu
+0002fe40: 6c6b 5f64 656c 5f73 746f 7261 6765 5f6f  lk_del_storage_o
+0002fe50: 626a 2e6e 616d 6520 6e6f 7420 696e 206f  bj.name not in o
+0002fe60: 7574 7075 742e 6465 636f 6465 2827 7574  utput.decode('ut
+0002fe70: 662d 3827 290a 0a20 2020 2040 7079 7465  f-8')..    @pyte
+0002fe80: 7374 2e6d 6172 6b2e 6e6f 5f66 6c75 6964  st.mark.no_fluid
+0002fe90: 7374 6163 6b0a 2020 2020 4070 7974 6573  stack.    @pytes
+0002fea0: 742e 6d61 726b 2e70 6172 616d 6574 7269  t.mark.parametri
+0002feb0: 7a65 280a 2020 2020 2020 2020 2774 6d70  ze(.        'tmp
+0002fec0: 5f70 7562 6c69 635f 7374 6f72 6167 655f  _public_storage_
+0002fed0: 6f62 6a2c 2073 746f 7265 5f74 7970 6527  obj, store_type'
+0002fee0: 2c0a 2020 2020 2020 2020 5b28 2773 333a  ,.        [('s3:
+0002fef0: 2f2f 7463 6761 2d32 2d6f 7065 6e27 2c20  //tcga-2-open', 
+0002ff00: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+0002ff10: 6554 7970 652e 5333 292c 0a20 2020 2020  eType.S3),.     
+0002ff20: 2020 2020 2827 7333 3a2f 2f64 6967 6974      ('s3://digit
+0002ff30: 616c 636f 7270 6f72 6127 2c20 7374 6f72  alcorpora', stor
+0002ff40: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+0002ff50: 652e 5333 292c 0a20 2020 2020 2020 2020  e.S3),.         
+0002ff60: 2827 6773 3a2f 2f67 6370 2d70 7562 6c69  ('gs://gcp-publi
+0002ff70: 632d 6461 7461 2d73 656e 7469 6e65 6c2d  c-data-sentinel-
+0002ff80: 3227 2c20 7374 6f72 6167 655f 6c69 622e  2', storage_lib.
+0002ff90: 5374 6f72 6554 7970 652e 4743 5329 5d2c  StoreType.GCS)],
+0002ffa0: 0a20 2020 2020 2020 2069 6e64 6972 6563  .        indirec
+0002ffb0: 743d 5b27 746d 705f 7075 626c 6963 5f73  t=['tmp_public_s
+0002ffc0: 746f 7261 6765 5f6f 626a 275d 290a 2020  torage_obj']).  
+0002ffd0: 2020 6465 6620 7465 7374 5f70 7562 6c69    def test_publi
+0002ffe0: 635f 6275 636b 6574 2873 656c 662c 2074  c_bucket(self, t
+0002fff0: 6d70 5f70 7562 6c69 635f 7374 6f72 6167  mp_public_storag
+00030000: 655f 6f62 6a2c 2073 746f 7265 5f74 7970  e_obj, store_typ
+00030010: 6529 3a0a 2020 2020 2020 2020 2320 4372  e):.        # Cr
+00030020: 6561 7465 7320 6120 6e65 7720 6275 636b  eates a new buck
+00030030: 6574 2077 6974 6820 6120 7075 626c 6963  et with a public
+00030040: 2073 6f75 7263 6520 616e 6420 7665 7269   source and veri
+00030050: 6669 6573 2074 6861 7420 6974 2069 7320  fies that it is 
+00030060: 6e6f 740a 2020 2020 2020 2020 2320 6164  not.        # ad
+00030070: 6465 6420 746f 2067 6c6f 6261 6c5f 7573  ded to global_us
+00030080: 6572 5f73 7461 7465 2e0a 2020 2020 2020  er_state..      
+00030090: 2020 746d 705f 7075 626c 6963 5f73 746f    tmp_public_sto
+000300a0: 7261 6765 5f6f 626a 2e61 6464 5f73 746f  rage_obj.add_sto
+000300b0: 7265 2873 746f 7265 5f74 7970 6529 0a0a  re(store_type)..
+000300c0: 2020 2020 2020 2020 2320 5275 6e20 736b          # Run sk
+000300d0: 7920 7374 6f72 6167 6520 6c73 2074 6f20  y storage ls to 
+000300e0: 6368 6563 6b20 6966 2073 746f 7261 6765  check if storage
+000300f0: 206f 626a 6563 7420 6578 6973 7473 2069   object exists i
+00030100: 6e20 7468 6520 6f75 7470 7574 0a20 2020  n the output.   
+00030110: 2020 2020 206f 7574 203d 2073 7562 7072       out = subpr
+00030120: 6f63 6573 732e 6368 6563 6b5f 6f75 7470  ocess.check_outp
+00030130: 7574 285b 2773 6b79 272c 2027 7374 6f72  ut(['sky', 'stor
+00030140: 6167 6527 2c20 276c 7327 5d29 0a20 2020  age', 'ls']).   
+00030150: 2020 2020 2061 7373 6572 7420 746d 705f       assert tmp_
+00030160: 7075 626c 6963 5f73 746f 7261 6765 5f6f  public_storage_o
+00030170: 626a 2e6e 616d 6520 6e6f 7420 696e 206f  bj.name not in o
+00030180: 7574 2e64 6563 6f64 6528 2775 7466 2d38  ut.decode('utf-8
+00030190: 2729 0a0a 2020 2020 4070 7974 6573 742e  ')..    @pytest.
+000301a0: 6d61 726b 2e6e 6f5f 666c 7569 6473 7461  mark.no_fluidsta
+000301b0: 636b 0a20 2020 2040 7079 7465 7374 2e6d  ck.    @pytest.m
+000301c0: 6172 6b2e 7061 7261 6d65 7472 697a 6528  ark.parametrize(
+000301d0: 276e 6f6e 6578 6973 745f 6275 636b 6574  'nonexist_bucket
+000301e0: 5f75 726c 272c 205b 0a20 2020 2020 2020  _url', [.       
+000301f0: 2027 7333 3a2f 2f7b 7261 6e64 6f6d 5f6e   's3://{random_n
+00030200: 616d 657d 272c 2027 6773 3a2f 2f7b 7261  ame}', 'gs://{ra
+00030210: 6e64 6f6d 5f6e 616d 657d 272c 0a20 2020  ndom_name}',.   
+00030220: 2020 2020 2070 7974 6573 742e 7061 7261       pytest.para
+00030230: 6d28 2763 6f73 3a2f 2f75 732d 6561 7374  m('cos://us-east
+00030240: 2f7b 7261 6e64 6f6d 5f6e 616d 657d 272c  /{random_name}',
+00030250: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
+00030260: 726b 2e69 626d 292c 0a20 2020 2020 2020  rk.ibm),.       
+00030270: 2070 7974 6573 742e 7061 7261 6d28 2772   pytest.param('r
+00030280: 323a 2f2f 7b72 616e 646f 6d5f 6e61 6d65  2://{random_name
+00030290: 7d27 2c20 6d61 726b 733d 7079 7465 7374  }', marks=pytest
+000302a0: 2e6d 6172 6b2e 636c 6f75 6466 6c61 7265  .mark.cloudflare
+000302b0: 290a 2020 2020 5d29 0a20 2020 2064 6566  ).    ]).    def
+000302c0: 2074 6573 745f 6e6f 6e65 7869 7374 656e   test_nonexisten
+000302d0: 745f 6275 636b 6574 2873 656c 662c 206e  t_bucket(self, n
+000302e0: 6f6e 6578 6973 745f 6275 636b 6574 5f75  onexist_bucket_u
+000302f0: 726c 293a 0a20 2020 2020 2020 2023 2041  rl):.        # A
+00030300: 7474 656d 7074 7320 746f 2063 7265 6174  ttempts to creat
+00030310: 6520 6665 7463 6820 6120 7374 726f 6167  e fetch a stroag
+00030320: 6520 7769 7468 2061 206e 6f6e 2d65 7869  e with a non-exi
+00030330: 7374 656e 7420 736f 7572 6365 2e0a 2020  stent source..  
+00030340: 2020 2020 2020 2320 4765 6e65 7261 7465        # Generate
+00030350: 2061 2072 616e 646f 6d20 6275 636b 6574   a random bucket
+00030360: 206e 616d 6520 616e 6420 7665 7269 6679   name and verify
+00030370: 2069 7420 646f 6573 6e27 7420 6578 6973   it doesn't exis
+00030380: 743a 0a20 2020 2020 2020 2072 6574 7279  t:.        retry
+00030390: 5f63 6f75 6e74 203d 2030 0a20 2020 2020  _count = 0.     
+000303a0: 2020 2077 6869 6c65 2054 7275 653a 0a20     while True:. 
+000303b0: 2020 2020 2020 2020 2020 206e 6f6e 6578             nonex
+000303c0: 6973 745f 6275 636b 6574 5f6e 616d 6520  ist_bucket_name 
+000303d0: 3d20 7374 7228 7575 6964 2e75 7569 6434  = str(uuid.uuid4
+000303e0: 2829 290a 2020 2020 2020 2020 2020 2020  ()).            
+000303f0: 6966 206e 6f6e 6578 6973 745f 6275 636b  if nonexist_buck
+00030400: 6574 5f75 726c 2e73 7461 7274 7377 6974  et_url.startswit
+00030410: 6828 2773 3327 293a 0a20 2020 2020 2020  h('s3'):.       
+00030420: 2020 2020 2020 2020 2063 6f6d 6d61 6e64           command
+00030430: 203d 2066 2761 7773 2073 3361 7069 2068   = f'aws s3api h
+00030440: 6561 642d 6275 636b 6574 202d 2d62 7563  ead-bucket --buc
+00030450: 6b65 7420 7b6e 6f6e 6578 6973 745f 6275  ket {nonexist_bu
+00030460: 636b 6574 5f6e 616d 657d 270a 2020 2020  cket_name}'.    
+00030470: 2020 2020 2020 2020 2020 2020 6578 7065              expe
+00030480: 6374 6564 5f6f 7574 7075 7420 3d20 2734  cted_output = '4
+00030490: 3034 270a 2020 2020 2020 2020 2020 2020  04'.            
+000304a0: 656c 6966 206e 6f6e 6578 6973 745f 6275  elif nonexist_bu
+000304b0: 636b 6574 5f75 726c 2e73 7461 7274 7377  cket_url.startsw
+000304c0: 6974 6828 2767 7327 293a 0a20 2020 2020  ith('gs'):.     
+000304d0: 2020 2020 2020 2020 2020 2063 6f6d 6d61             comma
+000304e0: 6e64 203d 2066 2767 7375 7469 6c20 6c73  nd = f'gsutil ls
+000304f0: 207b 6e6f 6e65 7869 7374 5f62 7563 6b65   {nonexist_bucke
+00030500: 745f 7572 6c2e 666f 726d 6174 2872 616e  t_url.format(ran
+00030510: 646f 6d5f 6e61 6d65 3d6e 6f6e 6578 6973  dom_name=nonexis
+00030520: 745f 6275 636b 6574 5f6e 616d 6529 7d27  t_bucket_name)}'
+00030530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00030540: 2065 7870 6563 7465 645f 6f75 7470 7574   expected_output
+00030550: 203d 2027 4275 636b 6574 4e6f 7446 6f75   = 'BucketNotFou
+00030560: 6e64 4578 6365 7074 696f 6e27 0a20 2020  ndException'.   
+00030570: 2020 2020 2020 2020 2065 6c69 6620 6e6f           elif no
+00030580: 6e65 7869 7374 5f62 7563 6b65 745f 7572  nexist_bucket_ur
+00030590: 6c2e 7374 6172 7473 7769 7468 2827 7232  l.startswith('r2
+000305a0: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
+000305b0: 2020 2020 656e 6470 6f69 6e74 5f75 726c      endpoint_url
+000305c0: 203d 2063 6c6f 7564 666c 6172 652e 6372   = cloudflare.cr
+000305d0: 6561 7465 5f65 6e64 706f 696e 7428 290a  eate_endpoint().
+000305e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000305f0: 636f 6d6d 616e 6420 3d20 6627 4157 535f  command = f'AWS_
+00030600: 5348 4152 4544 5f43 5245 4445 4e54 4941  SHARED_CREDENTIA
+00030610: 4c53 5f46 494c 453d 7b63 6c6f 7564 666c  LS_FILE={cloudfl
+00030620: 6172 652e 5232 5f43 5245 4445 4e54 4941  are.R2_CREDENTIA
+00030630: 4c53 5f50 4154 487d 2061 7773 2073 3361  LS_PATH} aws s3a
+00030640: 7069 2068 6561 642d 6275 636b 6574 202d  pi head-bucket -
+00030650: 2d62 7563 6b65 7420 7b6e 6f6e 6578 6973  -bucket {nonexis
+00030660: 745f 6275 636b 6574 5f6e 616d 657d 202d  t_bucket_name} -
+00030670: 2d65 6e64 706f 696e 7420 7b65 6e64 706f  -endpoint {endpo
+00030680: 696e 745f 7572 6c7d 202d 2d70 726f 6669  int_url} --profi
+00030690: 6c65 3d72 3227 0a20 2020 2020 2020 2020  le=r2'.         
+000306a0: 2020 2020 2020 2065 7870 6563 7465 645f         expected_
+000306b0: 6f75 7470 7574 203d 2027 3430 3427 0a20  output = '404'. 
+000306c0: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+000306d0: 6e6f 6e65 7869 7374 5f62 7563 6b65 745f  nonexist_bucket_
+000306e0: 7572 6c2e 7374 6172 7473 7769 7468 2827  url.startswith('
+000306f0: 636f 7327 293a 0a20 2020 2020 2020 2020  cos'):.         
+00030700: 2020 2020 2020 2023 2055 7369 6e67 2041         # Using A
+00030710: 5049 2063 616c 6c73 2c20 7369 6e63 6520  PI calls, since 
+00030720: 7573 696e 6720 7263 6c6f 6e65 2072 6571  using rclone req
+00030730: 7569 7265 7320 6120 7072 6f66 696c 6527  uires a profile'
+00030740: 7320 6e61 6d65 0a20 2020 2020 2020 2020  s name.         
+00030750: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+00030760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030770: 6578 7065 6374 6564 5f6f 7574 7075 7420  expected_output 
+00030780: 3d20 636f 6d6d 616e 6420 3d20 2265 6368  = command = "ech
+00030790: 6f22 2020 2320 6176 6f69 6420 756e 7265  o"  # avoid unre
+000307a0: 6c61 7465 6420 6578 6365 7074 696f 6e20  lated exception 
+000307b0: 696e 2063 6173 6520 6f66 2066 6169 6c75  in case of failu
+000307c0: 7265 2e0a 2020 2020 2020 2020 2020 2020  re..            
+000307d0: 2020 2020 2020 2020 6275 636b 6574 5f6e          bucket_n
+000307e0: 616d 6520 3d20 7572 6c6c 6962 2e70 6172  ame = urllib.par
+000307f0: 7365 2e75 726c 7370 6c69 7428 0a20 2020  se.urlsplit(.   
+00030800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030810: 2020 2020 206e 6f6e 6578 6973 745f 6275       nonexist_bu
+00030820: 636b 6574 5f75 726c 2e66 6f72 6d61 7428  cket_url.format(
+00030830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00030840: 2020 2020 2020 2020 2020 2020 2072 616e               ran
+00030850: 646f 6d5f 6e61 6d65 3d6e 6f6e 6578 6973  dom_name=nonexis
+00030860: 745f 6275 636b 6574 5f6e 616d 6529 292e  t_bucket_name)).
+00030870: 7061 7468 2e73 7472 6970 2827 2f27 290a  path.strip('/').
+00030880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030890: 2020 2020 636c 6965 6e74 203d 2069 626d      client = ibm
+000308a0: 2e67 6574 5f63 6f73 5f63 6c69 656e 7428  .get_cos_client(
+000308b0: 2775 732d 6561 7374 2729 0a20 2020 2020  'us-east').     
+000308c0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000308d0: 6c69 656e 742e 6865 6164 5f62 7563 6b65  lient.head_bucke
+000308e0: 7428 4275 636b 6574 3d62 7563 6b65 745f  t(Bucket=bucket_
+000308f0: 6e61 6d65 290a 2020 2020 2020 2020 2020  name).          
+00030900: 2020 2020 2020 6578 6365 7074 2069 626d        except ibm
+00030910: 2e69 626d 5f62 6f74 6f63 6f72 652e 6578  .ibm_botocore.ex
+00030920: 6365 7074 696f 6e73 2e43 6c69 656e 7445  ceptions.ClientE
+00030930: 7272 6f72 2061 7320 653a 0a20 2020 2020  rror as e:.     
+00030940: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00030950: 6620 652e 7265 7370 6f6e 7365 5b27 4572  f e.response['Er
+00030960: 726f 7227 5d5b 2743 6f64 6527 5d20 3d3d  ror']['Code'] ==
+00030970: 2027 3430 3427 3a0a 2020 2020 2020 2020   '404':.        
+00030980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030990: 2320 7375 6363 6573 730a 2020 2020 2020  # success.      
+000309a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000309b0: 2020 7265 7475 726e 0a20 2020 2020 2020    return.       
+000309c0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+000309d0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+000309e0: 2056 616c 7565 4572 726f 7228 2755 6e73   ValueError('Uns
+000309f0: 7570 706f 7274 6564 2062 7563 6b65 7420  upported bucket 
+00030a00: 7479 7065 2027 0a20 2020 2020 2020 2020  type '.         
+00030a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030a20: 2020 2020 2020 2020 6627 7b6e 6f6e 6578          f'{nonex
+00030a30: 6973 745f 6275 636b 6574 5f75 726c 7d27  ist_bucket_url}'
+00030a40: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
+00030a50: 2043 6865 636b 2069 6620 6275 636b 6574   Check if bucket
+00030a60: 2065 7869 7374 7320 7573 696e 6720 7468   exists using th
+00030a70: 6520 636c 693a 0a20 2020 2020 2020 2020  e cli:.         
+00030a80: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00030a90: 2020 2020 2020 2020 6f75 7420 3d20 7375          out = su
+00030aa0: 6270 726f 6365 7373 2e63 6865 636b 5f6f  bprocess.check_o
+00030ab0: 7574 7075 7428 636f 6d6d 616e 642c 0a20  utput(command,. 
+00030ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030ae0: 2020 2020 2020 2020 2020 2020 2073 7464               std
+00030af0: 6572 723d 7375 6270 726f 6365 7373 2e53  err=subprocess.S
+00030b00: 5444 4f55 542c 0a20 2020 2020 2020 2020  TDOUT,.         
+00030b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030b30: 2020 2020 2073 6865 6c6c 3d54 7275 6529       shell=True)
+00030b40: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
+00030b50: 6570 7420 7375 6270 726f 6365 7373 2e43  ept subprocess.C
+00030b60: 616c 6c65 6450 726f 6365 7373 4572 726f  alledProcessErro
+00030b70: 7220 6173 2065 3a0a 2020 2020 2020 2020  r as e:.        
+00030b80: 2020 2020 2020 2020 6f75 7420 3d20 652e          out = e.
+00030b90: 6f75 7470 7574 0a20 2020 2020 2020 2020  output.         
+00030ba0: 2020 206f 7574 203d 206f 7574 2e64 6563     out = out.dec
+00030bb0: 6f64 6528 2775 7466 2d38 2729 0a20 2020  ode('utf-8').   
+00030bc0: 2020 2020 2020 2020 2069 6620 6578 7065           if expe
+00030bd0: 6374 6564 5f6f 7574 7075 7420 696e 206f  cted_output in o
+00030be0: 7574 3a0a 2020 2020 2020 2020 2020 2020  ut:.            
+00030bf0: 2020 2020 6272 6561 6b0a 2020 2020 2020      break.      
+00030c00: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00030c10: 2020 2020 2020 2020 2020 2020 7265 7472              retr
+00030c20: 795f 636f 756e 7420 2b3d 2031 0a20 2020  y_count += 1.   
+00030c30: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00030c40: 7265 7472 795f 636f 756e 7420 3e20 333a  retry_count > 3:
+00030c50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00030c60: 2020 2020 2072 6169 7365 2052 756e 7469       raise Runti
+00030c70: 6d65 4572 726f 7228 2755 6e61 626c 6520  meError('Unable 
+00030c80: 746f 2066 696e 6420 6120 6e6f 6e65 7869  to find a nonexi
+00030c90: 7374 656e 7420 6275 636b 6574 2027 0a20  stent bucket '. 
+00030ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030cc0: 2020 2020 2020 2774 6f20 7573 652e 2054        'to use. T
+00030cd0: 6869 7320 6973 2068 6967 6c79 2075 6e6c  his is higly unl
+00030ce0: 696b 656c 7920 2d20 270a 2020 2020 2020  ikely - '.      
+00030cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030d10: 2027 6368 6563 6b20 6966 2074 6865 2074   'check if the t
+00030d20: 6573 7473 2061 7265 2063 6f72 7265 6374  ests are correct
+00030d30: 2e27 290a 0a20 2020 2020 2020 2077 6974  .')..        wit
+00030d40: 6820 7079 7465 7374 2e72 6169 7365 7328  h pytest.raises(
+00030d50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00030d60: 2073 6b79 2e65 7863 6570 7469 6f6e 732e   sky.exceptions.
+00030d70: 5374 6f72 6167 6542 7563 6b65 7447 6574  StorageBucketGet
+00030d80: 4572 726f 722c 0a20 2020 2020 2020 2020  Error,.         
+00030d90: 2020 2020 2020 206d 6174 6368 3d27 4174         match='At
+00030da0: 7465 6d70 7465 6420 746f 2075 7365 2061  tempted to use a
+00030db0: 206e 6f6e 2d65 7869 7374 656e 7420 6275   non-existent bu
+00030dc0: 636b 6574 2061 7320 6120 736f 7572 6365  cket as a source
+00030dd0: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
+00030de0: 7374 6f72 6167 655f 6f62 6a20 3d20 7374  storage_obj = st
+00030df0: 6f72 6167 655f 6c69 622e 5374 6f72 6167  orage_lib.Storag
+00030e00: 6528 736f 7572 6365 3d6e 6f6e 6578 6973  e(source=nonexis
+00030e10: 745f 6275 636b 6574 5f75 726c 2e66 6f72  t_bucket_url.for
+00030e20: 6d61 7428 0a20 2020 2020 2020 2020 2020  mat(.           
+00030e30: 2020 2020 2072 616e 646f 6d5f 6e61 6d65       random_name
+00030e40: 3d6e 6f6e 6578 6973 745f 6275 636b 6574  =nonexist_bucket
+00030e50: 5f6e 616d 6529 290a 0a20 2020 2040 7079  _name))..    @py
+00030e60: 7465 7374 2e6d 6172 6b2e 6e6f 5f66 6c75  test.mark.no_flu
+00030e70: 6964 7374 6163 6b0a 2020 2020 4070 7974  idstack.    @pyt
+00030e80: 6573 742e 6d61 726b 2e70 6172 616d 6574  est.mark.paramet
+00030e90: 7269 7a65 2827 7072 6976 6174 655f 6275  rize('private_bu
+00030ea0: 636b 6574 272c 205b 0a20 2020 2020 2020  cket', [.       
+00030eb0: 2066 2773 333a 2f2f 696d 6167 656e 6574   f's3://imagenet
+00030ec0: 272c 2066 2767 733a 2f2f 696d 6167 656e  ', f'gs://imagen
+00030ed0: 6574 272c 0a20 2020 2020 2020 2070 7974  et',.        pyt
+00030ee0: 6573 742e 7061 7261 6d28 2763 6f73 3a2f  est.param('cos:/
+00030ef0: 2f75 732d 6561 7374 2f62 7563 6b65 7431  /us-east/bucket1
+00030f00: 272c 206d 6172 6b73 3d70 7974 6573 742e  ', marks=pytest.
+00030f10: 6d61 726b 2e69 626d 290a 2020 2020 5d29  mark.ibm).    ])
+00030f20: 0a20 2020 2064 6566 2074 6573 745f 7072  .    def test_pr
+00030f30: 6976 6174 655f 6275 636b 6574 2873 656c  ivate_bucket(sel
+00030f40: 662c 2070 7269 7661 7465 5f62 7563 6b65  f, private_bucke
+00030f50: 7429 3a0a 2020 2020 2020 2020 2320 4174  t):.        # At
+00030f60: 7465 6d70 7473 2074 6f20 6163 6365 7373  tempts to access
+00030f70: 2070 7269 7661 7465 2062 7563 6b65 7473   private buckets
+00030f80: 206e 6f74 2062 656c 6f6e 6769 6e67 2074   not belonging t
+00030f90: 6f20 7468 6520 7573 6572 2e0a 2020 2020  o the user..    
+00030fa0: 2020 2020 2320 5468 6573 6520 6275 636b      # These buck
+00030fb0: 6574 7320 6172 6520 6b6e 6f77 6e20 746f  ets are known to
+00030fc0: 2062 6520 7072 6976 6174 652c 2062 7574   be private, but
+00030fd0: 206d 6179 206e 6565 6420 746f 2062 6520   may need to be 
+00030fe0: 7570 6461 7465 6420 6966 0a20 2020 2020  updated if.     
+00030ff0: 2020 2023 2074 6865 7920 6172 6520 7265     # they are re
+00031000: 6d6f 7665 6420 6279 2074 6865 6972 206f  moved by their o
+00031010: 776e 6572 732e 0a20 2020 2020 2020 2070  wners..        p
+00031020: 7269 7661 7465 5f62 7563 6b65 745f 6e61  rivate_bucket_na
+00031030: 6d65 203d 2075 726c 6c69 622e 7061 7273  me = urllib.pars
+00031040: 652e 7572 6c73 706c 6974 2870 7269 7661  e.urlsplit(priva
+00031050: 7465 5f62 7563 6b65 7429 2e6e 6574 6c6f  te_bucket).netlo
+00031060: 6320 6966 205c 0a20 2020 2020 2020 2020  c if \.         
+00031070: 2020 2020 2075 726c 6c69 622e 7061 7273       urllib.pars
+00031080: 652e 7572 6c73 706c 6974 2870 7269 7661  e.urlsplit(priva
+00031090: 7465 5f62 7563 6b65 7429 2e73 6368 656d  te_bucket).schem
+000310a0: 6520 213d 2027 636f 7327 2065 6c73 6520  e != 'cos' else 
+000310b0: 5c0a 2020 2020 2020 2020 2020 2020 2020  \.              
+000310c0: 2020 2020 7572 6c6c 6962 2e70 6172 7365      urllib.parse
+000310d0: 2e75 726c 7370 6c69 7428 7072 6976 6174  .urlsplit(privat
+000310e0: 655f 6275 636b 6574 292e 7061 7468 2e73  e_bucket).path.s
+000310f0: 7472 6970 2827 2f27 290a 2020 2020 2020  trip('/').      
+00031100: 2020 7769 7468 2070 7974 6573 742e 7261    with pytest.ra
+00031110: 6973 6573 280a 2020 2020 2020 2020 2020  ises(.          
+00031120: 2020 2020 2020 736b 792e 6578 6365 7074        sky.except
+00031130: 696f 6e73 2e53 746f 7261 6765 4275 636b  ions.StorageBuck
+00031140: 6574 4765 7445 7272 6f72 2c0a 2020 2020  etGetError,.    
+00031150: 2020 2020 2020 2020 2020 2020 6d61 7463              matc
+00031160: 683d 7374 6f72 6167 655f 6c69 622e 5f42  h=storage_lib._B
+00031170: 5543 4b45 545f 4641 494c 5f54 4f5f 434f  UCKET_FAIL_TO_CO
+00031180: 4e4e 4543 545f 4d45 5353 4147 452e 666f  NNECT_MESSAGE.fo
+00031190: 726d 6174 280a 2020 2020 2020 2020 2020  rmat(.          
+000311a0: 2020 2020 2020 2020 2020 6e61 6d65 3d70            name=p
+000311b0: 7269 7661 7465 5f62 7563 6b65 745f 6e61  rivate_bucket_na
+000311c0: 6d65 2929 3a0a 2020 2020 2020 2020 2020  me)):.          
+000311d0: 2020 7374 6f72 6167 655f 6f62 6a20 3d20    storage_obj = 
+000311e0: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+000311f0: 6167 6528 736f 7572 6365 3d70 7269 7661  age(source=priva
+00031200: 7465 5f62 7563 6b65 7429 0a0a 2020 2020  te_bucket)..    
+00031210: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00031220: 666c 7569 6473 7461 636b 0a20 2020 2040  fluidstack.    @
+00031230: 7079 7465 7374 2e6d 6172 6b2e 7061 7261  pytest.mark.para
+00031240: 6d65 7472 697a 6528 2765 7874 5f62 7563  metrize('ext_buc
+00031250: 6b65 745f 6669 7874 7572 652c 2073 746f  ket_fixture, sto
+00031260: 7265 5f74 7970 6527 2c0a 2020 2020 2020  re_type',.      
+00031270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031280: 2020 2020 2020 205b 2827 746d 705f 6177         [('tmp_aw
+00031290: 7363 6c69 5f62 7563 6b65 7427 2c20 7374  scli_bucket', st
+000312a0: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+000312b0: 7970 652e 5333 292c 0a20 2020 2020 2020  ype.S3),.       
+000312c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000312d0: 2020 2020 2020 2028 2774 6d70 5f67 7375         ('tmp_gsu
+000312e0: 7469 6c5f 6275 636b 6574 272c 2073 746f  til_bucket', sto
+000312f0: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+00031300: 7065 2e47 4353 292c 0a20 2020 2020 2020  pe.GCS),.       
+00031310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031320: 2020 2020 2020 2070 7974 6573 742e 7061         pytest.pa
+00031330: 7261 6d28 2774 6d70 5f69 626d 5f63 6f73  ram('tmp_ibm_cos
+00031340: 5f62 7563 6b65 7427 2c0a 2020 2020 2020  _bucket',.      
+00031350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031370: 2020 2020 2073 746f 7261 6765 5f6c 6962       storage_lib
+00031380: 2e53 746f 7265 5479 7065 2e49 424d 2c0a  .StoreType.IBM,.
+00031390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000313a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000313b0: 2020 2020 2020 2020 2020 206d 6172 6b73             marks
+000313c0: 3d70 7974 6573 742e 6d61 726b 2e69 626d  =pytest.mark.ibm
+000313d0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+000313e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000313f0: 2070 7974 6573 742e 7061 7261 6d28 2774   pytest.param('t
+00031400: 6d70 5f61 7773 636c 695f 6275 636b 6574  mp_awscli_bucket
+00031410: 5f72 3227 2c0a 2020 2020 2020 2020 2020  _r2',.          
+00031420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031440: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+00031450: 7265 5479 7065 2e52 322c 0a20 2020 2020  reType.R2,.     
+00031460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031480: 2020 2020 2020 6d61 726b 733d 7079 7465        marks=pyte
+00031490: 7374 2e6d 6172 6b2e 636c 6f75 6466 6c61  st.mark.cloudfla
+000314a0: 7265 295d 290a 2020 2020 6465 6620 7465  re)]).    def te
+000314b0: 7374 5f75 706c 6f61 645f 746f 5f65 7869  st_upload_to_exi
+000314c0: 7374 696e 675f 6275 636b 6574 2873 656c  sting_bucket(sel
+000314d0: 662c 2065 7874 5f62 7563 6b65 745f 6669  f, ext_bucket_fi
+000314e0: 7874 7572 652c 2072 6571 7565 7374 2c0a  xture, request,.
+000314f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031510: 2020 2020 2020 2074 6d70 5f73 6f75 7263         tmp_sourc
+00031520: 652c 2073 746f 7265 5f74 7970 6529 3a0a  e, store_type):.
+00031530: 2020 2020 2020 2020 2320 5472 6965 7320          # Tries 
+00031540: 7570 6c6f 6164 696e 6720 6578 6973 7469  uploading existi
+00031550: 6e67 2066 696c 6573 2074 6f20 6e65 776c  ng files to newl
+00031560: 7920 6372 6561 7465 6420 6275 636b 6574  y created bucket
+00031570: 2028 6f75 7473 6964 6520 6f66 0a20 2020   (outside of.   
+00031580: 2020 2020 2023 2073 6b79 2920 616e 6420       # sky) and 
+00031590: 7665 7269 6669 6573 2074 6861 7420 6669  verifies that fi
+000315a0: 6c65 7320 6172 6520 7772 6974 7465 6e2e  les are written.
+000315b0: 0a20 2020 2020 2020 2062 7563 6b65 745f  .        bucket_
+000315c0: 6e61 6d65 2c20 5f20 3d20 7265 7175 6573  name, _ = reques
+000315d0: 742e 6765 7466 6978 7475 7265 7661 6c75  t.getfixturevalu
+000315e0: 6528 6578 745f 6275 636b 6574 5f66 6978  e(ext_bucket_fix
+000315f0: 7475 7265 290a 2020 2020 2020 2020 7374  ture).        st
+00031600: 6f72 6167 655f 6f62 6a20 3d20 7374 6f72  orage_obj = stor
+00031610: 6167 655f 6c69 622e 5374 6f72 6167 6528  age_lib.Storage(
+00031620: 6e61 6d65 3d62 7563 6b65 745f 6e61 6d65  name=bucket_name
+00031630: 2c20 736f 7572 6365 3d74 6d70 5f73 6f75  , source=tmp_sou
+00031640: 7263 6529 0a20 2020 2020 2020 2073 746f  rce).        sto
+00031650: 7261 6765 5f6f 626a 2e61 6464 5f73 746f  rage_obj.add_sto
+00031660: 7265 2873 746f 7265 5f74 7970 6529 0a0a  re(store_type)..
+00031670: 2020 2020 2020 2020 2320 4368 6563 6b20          # Check 
+00031680: 6966 2074 6d70 5f73 6f75 7263 652f 746d  if tmp_source/tm
+00031690: 702d 6669 6c65 2065 7869 7374 7320 696e  p-file exists in
+000316a0: 2074 6865 2062 7563 6b65 7420 7573 696e   the bucket usin
+000316b0: 6720 6177 7320 636c 690a 2020 2020 2020  g aws cli.      
+000316c0: 2020 6f75 7420 3d20 7375 6270 726f 6365    out = subproce
+000316d0: 7373 2e63 6865 636b 5f6f 7574 7075 7428  ss.check_output(
+000316e0: 7365 6c66 2e63 6c69 5f6c 735f 636d 6428  self.cli_ls_cmd(
+000316f0: 7374 6f72 655f 7479 7065 2c20 6275 636b  store_type, buck
+00031700: 6574 5f6e 616d 6529 2c0a 2020 2020 2020  et_name),.      
+00031710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031730: 7368 656c 6c3d 5472 7565 290a 2020 2020  shell=True).    
+00031740: 2020 2020 6173 7365 7274 2027 746d 702d      assert 'tmp-
+00031750: 6669 6c65 2720 696e 206f 7574 2e64 6563  file' in out.dec
+00031760: 6f64 6528 2775 7466 2d38 2729 2c20 5c0a  ode('utf-8'), \.
+00031770: 2020 2020 2020 2020 2020 2020 2746 696c              'Fil
+00031780: 6520 6e6f 7420 666f 756e 6420 696e 2062  e not found in b
+00031790: 7563 6b65 7420 2d20 6f75 7470 7574 2077  ucket - output w
+000317a0: 6173 203a 207b 7d27 2e66 6f72 6d61 7428  as : {}'.format(
+000317b0: 6f75 742e 6465 636f 6465 0a20 2020 2020  out.decode.     
+000317c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000317d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000317e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000317f0: 2020 2020 2020 2020 2020 2028 2775 7466             ('utf
+00031800: 2d38 2729 290a 0a20 2020 2020 2020 2023  -8'))..        #
+00031810: 2043 6865 636b 2073 796d 6c69 6e6b 7320   Check symlinks 
+00031820: 2d20 7379 6d6c 696e 6b73 2064 6f6e 2774  - symlinks don't
+00031830: 2067 6574 2063 6f70 6965 6420 6279 2073   get copied by s
+00031840: 6b79 2073 746f 7261 6765 0a20 2020 2020  ky storage.     
+00031850: 2020 2061 7373 6572 7420 2870 6174 686c     assert (pathl
+00031860: 6962 2e50 6174 6828 746d 705f 736f 7572  ib.Path(tmp_sour
+00031870: 6365 2920 2f20 2763 6972 636c 652d 6c69  ce) / 'circle-li
+00031880: 6e6b 2729 2e69 735f 7379 6d6c 696e 6b28  nk').is_symlink(
+00031890: 292c 2028 0a20 2020 2020 2020 2020 2020  ), (.           
+000318a0: 2027 6369 7263 6c65 2d6c 696e 6b20 7761   'circle-link wa
+000318b0: 7320 6e6f 7420 666f 756e 6420 696e 2074  s not found in t
+000318c0: 6865 2075 706c 6f61 6420 736f 7572 6365  he upload source
+000318d0: 202d 2027 0a20 2020 2020 2020 2020 2020   - '.           
+000318e0: 2027 6172 6520 7468 6520 7465 7374 2066   'are the test f
+000318f0: 6978 7475 7265 7320 636f 7272 6563 743f  ixtures correct?
+00031900: 2729 0a20 2020 2020 2020 2061 7373 6572  ').        asser
+00031910: 7420 2763 6972 636c 652d 6c69 6e6b 2720  t 'circle-link' 
+00031920: 6e6f 7420 696e 206f 7574 2e64 6563 6f64  not in out.decod
+00031930: 6528 2775 7466 2d38 2729 2c20 280a 2020  e('utf-8'), (.  
+00031940: 2020 2020 2020 2020 2020 2753 796d 6c69            'Symli
+00031950: 6e6b 2066 6f75 6e64 2069 6e20 6275 636b  nk found in buck
+00031960: 6574 202d 206c 7320 6f75 7470 7574 2077  et - ls output w
+00031970: 6173 203a 207b 7d27 2e66 6f72 6d61 7428  as : {}'.format(
+00031980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00031990: 206f 7574 2e64 6563 6f64 6528 2775 7466   out.decode('utf
+000319a0: 2d38 2729 2929 0a0a 2020 2020 2020 2020  -8')))..        
+000319b0: 2320 5275 6e20 736b 7920 7374 6f72 6167  # Run sky storag
+000319c0: 6520 6c73 2074 6f20 6368 6563 6b20 6966  e ls to check if
+000319d0: 2073 746f 7261 6765 206f 626a 6563 7420   storage object 
+000319e0: 6578 6973 7473 2069 6e20 7468 6520 6f75  exists in the ou
+000319f0: 7470 7574 2e0a 2020 2020 2020 2020 2320  tput..        # 
+00031a00: 4974 2073 686f 756c 6420 6e6f 7420 6578  It should not ex
+00031a10: 6973 7420 6265 6361 7573 6520 7468 6520  ist because the 
+00031a20: 6275 636b 6574 2077 6173 2063 7265 6174  bucket was creat
+00031a30: 6564 2065 7874 6572 6e61 6c6c 792e 0a20  ed externally.. 
+00031a40: 2020 2020 2020 206f 7574 203d 2073 7562         out = sub
+00031a50: 7072 6f63 6573 732e 6368 6563 6b5f 6f75  process.check_ou
+00031a60: 7470 7574 285b 2773 6b79 272c 2027 7374  tput(['sky', 'st
+00031a70: 6f72 6167 6527 2c20 276c 7327 5d29 0a20  orage', 'ls']). 
+00031a80: 2020 2020 2020 2061 7373 6572 7420 7374         assert st
+00031a90: 6f72 6167 655f 6f62 6a2e 6e61 6d65 206e  orage_obj.name n
+00031aa0: 6f74 2069 6e20 6f75 742e 6465 636f 6465  ot in out.decode
+00031ab0: 2827 7574 662d 3827 290a 0a20 2020 2040  ('utf-8')..    @
+00031ac0: 7079 7465 7374 2e6d 6172 6b2e 6e6f 5f66  pytest.mark.no_f
+00031ad0: 6c75 6964 7374 6163 6b0a 2020 2020 6465  luidstack.    de
+00031ae0: 6620 7465 7374 5f63 6f70 795f 6d6f 756e  f test_copy_moun
+00031af0: 745f 6578 6973 7469 6e67 5f73 746f 7261  t_existing_stora
+00031b00: 6765 2873 656c 662c 0a20 2020 2020 2020  ge(self,.       
+00031b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031b30: 2020 746d 705f 636f 7079 5f6d 6e74 5f65    tmp_copy_mnt_e
+00031b40: 7869 7374 696e 675f 7374 6f72 6167 655f  xisting_storage_
+00031b50: 6f62 6a29 3a0a 2020 2020 2020 2020 2320  obj):.        # 
+00031b60: 4372 6561 7465 7320 6120 6275 636b 6574  Creates a bucket
+00031b70: 2077 6974 6820 6e6f 2073 6f75 7263 6520   with no source 
+00031b80: 696e 204d 4f55 4e54 206d 6f64 6520 2865  in MOUNT mode (e
+00031b90: 6d70 7479 2062 7563 6b65 7429 2c20 616e  mpty bucket), an
+00031ba0: 640a 2020 2020 2020 2020 2320 7468 656e  d.        # then
+00031bb0: 2074 7269 6573 2074 6f20 6c6f 6164 2074   tries to load t
+00031bc0: 6865 2073 616d 6520 7374 6f72 6167 6520  he same storage 
+00031bd0: 696e 2043 4f50 5920 6d6f 6465 2e0a 2020  in COPY mode..  
+00031be0: 2020 2020 2020 746d 705f 636f 7079 5f6d        tmp_copy_m
+00031bf0: 6e74 5f65 7869 7374 696e 675f 7374 6f72  nt_existing_stor
+00031c00: 6167 655f 6f62 6a2e 6164 645f 7374 6f72  age_obj.add_stor
+00031c10: 6528 7374 6f72 6167 655f 6c69 622e 5374  e(storage_lib.St
+00031c20: 6f72 6554 7970 652e 5333 290a 2020 2020  oreType.S3).    
+00031c30: 2020 2020 7374 6f72 6167 655f 6e61 6d65      storage_name
+00031c40: 203d 2074 6d70 5f63 6f70 795f 6d6e 745f   = tmp_copy_mnt_
+00031c50: 6578 6973 7469 6e67 5f73 746f 7261 6765  existing_storage
+00031c60: 5f6f 626a 2e6e 616d 650a 0a20 2020 2020  _obj.name..     
+00031c70: 2020 2023 2043 6865 636b 2060 736b 7920     # Check `sky 
+00031c80: 7374 6f72 6167 6520 6c73 6020 746f 2065  storage ls` to e
+00031c90: 6e73 7572 6520 7374 6f72 6167 6520 6f62  nsure storage ob
+00031ca0: 6a65 6374 2065 7869 7374 730a 2020 2020  ject exists.    
+00031cb0: 2020 2020 6f75 7420 3d20 7375 6270 726f      out = subpro
+00031cc0: 6365 7373 2e63 6865 636b 5f6f 7574 7075  cess.check_outpu
+00031cd0: 7428 5b27 736b 7927 2c20 2773 746f 7261  t(['sky', 'stora
+00031ce0: 6765 272c 2027 6c73 275d 292e 6465 636f  ge', 'ls']).deco
+00031cf0: 6465 2827 7574 662d 3827 290a 2020 2020  de('utf-8').    
+00031d00: 2020 2020 6173 7365 7274 2073 746f 7261      assert stora
+00031d10: 6765 5f6e 616d 6520 696e 206f 7574 2c20  ge_name in out, 
+00031d20: 6627 5374 6f72 6167 6520 7b73 746f 7261  f'Storage {stora
+00031d30: 6765 5f6e 616d 657d 206e 6f74 2066 6f75  ge_name} not fou
+00031d40: 6e64 2069 6e20 736b 7920 7374 6f72 6167  nd in sky storag
+00031d50: 6520 6c73 2e27 0a0a 2020 2020 4070 7974  e ls.'..    @pyt
+00031d60: 6573 742e 6d61 726b 2e6e 6f5f 666c 7569  est.mark.no_flui
+00031d70: 6473 7461 636b 0a20 2020 2040 7079 7465  dstack.    @pyte
+00031d80: 7374 2e6d 6172 6b2e 7061 7261 6d65 7472  st.mark.parametr
+00031d90: 697a 6528 2773 746f 7265 5f74 7970 6527  ize('store_type'
+00031da0: 2c20 5b0a 2020 2020 2020 2020 7374 6f72  , [.        stor
+00031db0: 6167 655f 6c69 622e 5374 6f72 6554 7970  age_lib.StoreTyp
+00031dc0: 652e 5333 2c20 7374 6f72 6167 655f 6c69  e.S3, storage_li
+00031dd0: 622e 5374 6f72 6554 7970 652e 4743 532c  b.StoreType.GCS,
+00031de0: 0a20 2020 2020 2020 2070 7974 6573 742e  .        pytest.
+00031df0: 7061 7261 6d28 7374 6f72 6167 655f 6c69  param(storage_li
+00031e00: 622e 5374 6f72 6554 7970 652e 4942 4d2c  b.StoreType.IBM,
+00031e10: 206d 6172 6b73 3d70 7974 6573 742e 6d61   marks=pytest.ma
+00031e20: 726b 2e69 626d 292c 0a20 2020 2020 2020  rk.ibm),.       
+00031e30: 2070 7974 6573 742e 7061 7261 6d28 7374   pytest.param(st
+00031e40: 6f72 6167 655f 6c69 622e 5374 6f72 6554  orage_lib.StoreT
+00031e50: 7970 652e 5232 2c20 6d61 726b 733d 7079  ype.R2, marks=py
+00031e60: 7465 7374 2e6d 6172 6b2e 636c 6f75 6466  test.mark.cloudf
+00031e70: 6c61 7265 290a 2020 2020 5d29 0a20 2020  lare).    ]).   
+00031e80: 2064 6566 2074 6573 745f 6c69 7374 5f73   def test_list_s
+00031e90: 6f75 7263 6528 7365 6c66 2c20 746d 705f  ource(self, tmp_
+00031ea0: 6c6f 6361 6c5f 6c69 7374 5f73 746f 7261  local_list_stora
+00031eb0: 6765 5f6f 626a 2c20 7374 6f72 655f 7479  ge_obj, store_ty
+00031ec0: 7065 293a 0a20 2020 2020 2020 2023 2055  pe):.        # U
+00031ed0: 7365 7320 6120 6c69 7374 2069 6e20 7468  ses a list in th
+00031ee0: 6520 736f 7572 6365 2066 6965 6c64 2074  e source field t
+00031ef0: 6f20 7370 6563 6966 7920 6120 6669 6c65  o specify a file
+00031f00: 2061 6e64 2061 2064 6972 6563 746f 7279   and a directory
+00031f10: 2074 6f0a 2020 2020 2020 2020 2320 6265   to.        # be
+00031f20: 2075 706c 6f61 6465 6420 746f 2074 6865   uploaded to the
+00031f30: 2073 746f 7261 6765 206f 626a 6563 742e   storage object.
+00031f40: 0a20 2020 2020 2020 2074 6d70 5f6c 6f63  .        tmp_loc
+00031f50: 616c 5f6c 6973 745f 7374 6f72 6167 655f  al_list_storage_
+00031f60: 6f62 6a2e 6164 645f 7374 6f72 6528 7374  obj.add_store(st
+00031f70: 6f72 655f 7479 7065 290a 0a20 2020 2020  ore_type)..     
+00031f80: 2020 2023 2043 6865 636b 2069 6620 746d     # Check if tm
+00031f90: 702d 6669 6c65 2065 7869 7374 7320 696e  p-file exists in
+00031fa0: 2074 6865 2062 7563 6b65 7420 726f 6f74   the bucket root
+00031fb0: 2075 7369 6e67 2063 6c69 0a20 2020 2020   using cli.     
+00031fc0: 2020 206f 7574 203d 2073 7562 7072 6f63     out = subproc
+00031fd0: 6573 732e 6368 6563 6b5f 6f75 7470 7574  ess.check_output
+00031fe0: 2873 656c 662e 636c 695f 6c73 5f63 6d64  (self.cli_ls_cmd
+00031ff0: 280a 2020 2020 2020 2020 2020 2020 7374  (.            st
+00032000: 6f72 655f 7479 7065 2c20 746d 705f 6c6f  ore_type, tmp_lo
+00032010: 6361 6c5f 6c69 7374 5f73 746f 7261 6765  cal_list_storage
+00032020: 5f6f 626a 2e6e 616d 6529 2c0a 2020 2020  _obj.name),.    
+00032030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032050: 2020 7368 656c 6c3d 5472 7565 290a 2020    shell=True).  
+00032060: 2020 2020 2020 6173 7365 7274 2027 746d        assert 'tm
+00032070: 702d 6669 6c65 2720 696e 206f 7574 2e64  p-file' in out.d
+00032080: 6563 6f64 6528 2775 7466 2d38 2729 2c20  ecode('utf-8'), 
+00032090: 5c0a 2020 2020 2020 2020 2020 2020 2746  \.            'F
+000320a0: 696c 6520 6e6f 7420 666f 756e 6420 696e  ile not found in
+000320b0: 2062 7563 6b65 7420 2d20 6f75 7470 7574   bucket - output
+000320c0: 2077 6173 203a 207b 7d27 2e66 6f72 6d61   was : {}'.forma
+000320d0: 7428 6f75 742e 6465 636f 6465 0a20 2020  t(out.decode.   
+000320e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000320f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032110: 2020 2020 2020 2020 2020 2020 2028 2775               ('u
+00032120: 7466 2d38 2729 290a 0a20 2020 2020 2020  tf-8'))..       
+00032130: 2023 2043 6865 636b 2069 6620 746d 702d   # Check if tmp-
+00032140: 6669 6c65 2065 7869 7374 7320 696e 2074  file exists in t
+00032150: 6865 2062 7563 6b65 742f 746d 702d 736f  he bucket/tmp-so
+00032160: 7572 6365 2075 7369 6e67 2063 6c69 0a20  urce using cli. 
+00032170: 2020 2020 2020 206f 7574 203d 2073 7562         out = sub
+00032180: 7072 6f63 6573 732e 6368 6563 6b5f 6f75  process.check_ou
+00032190: 7470 7574 2873 656c 662e 636c 695f 6c73  tput(self.cli_ls
+000321a0: 5f63 6d64 280a 2020 2020 2020 2020 2020  _cmd(.          
+000321b0: 2020 7374 6f72 655f 7479 7065 2c20 746d    store_type, tm
+000321c0: 705f 6c6f 6361 6c5f 6c69 7374 5f73 746f  p_local_list_sto
+000321d0: 7261 6765 5f6f 626a 2e6e 616d 652c 2027  rage_obj.name, '
+000321e0: 746d 702d 736f 7572 6365 2f27 292c 0a20  tmp-source/'),. 
+000321f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032210: 2020 2020 2073 6865 6c6c 3d54 7275 6529       shell=True)
+00032220: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00032230: 2774 6d70 2d66 696c 6527 2069 6e20 6f75  'tmp-file' in ou
+00032240: 742e 6465 636f 6465 2827 7574 662d 3827  t.decode('utf-8'
+00032250: 292c 205c 0a20 2020 2020 2020 2020 2020  ), \.           
+00032260: 2027 4669 6c65 206e 6f74 2066 6f75 6e64   'File not found
+00032270: 2069 6e20 6275 636b 6574 202d 206f 7574   in bucket - out
+00032280: 7075 7420 7761 7320 3a20 7b7d 272e 666f  put was : {}'.fo
+00032290: 726d 6174 286f 7574 2e64 6563 6f64 650a  rmat(out.decode.
+000322a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000322b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000322c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000322d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000322e0: 2827 7574 662d 3827 2929 0a0a 2020 2020  ('utf-8'))..    
+000322f0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00032300: 666c 7569 6473 7461 636b 0a20 2020 2040  fluidstack.    @
+00032310: 7079 7465 7374 2e6d 6172 6b2e 7061 7261  pytest.mark.para
+00032320: 6d65 7472 697a 6528 2769 6e76 616c 6964  metrize('invalid
+00032330: 5f6e 616d 655f 6c69 7374 2c20 7374 6f72  _name_list, stor
+00032340: 655f 7479 7065 272c 0a20 2020 2020 2020  e_type',.       
+00032350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032360: 2020 2020 2020 5b28 4157 535f 494e 5641        [(AWS_INVA
+00032370: 4c49 445f 4e41 4d45 532c 2073 746f 7261  LID_NAMES, stora
+00032380: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
+00032390: 2e53 3329 2c0a 2020 2020 2020 2020 2020  .S3),.          
+000323a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000323b0: 2020 2020 2847 4353 5f49 4e56 414c 4944      (GCS_INVALID
+000323c0: 5f4e 414d 4553 2c20 7374 6f72 6167 655f  _NAMES, storage_
+000323d0: 6c69 622e 5374 6f72 6554 7970 652e 4743  lib.StoreType.GC
+000323e0: 5329 2c0a 2020 2020 2020 2020 2020 2020  S),.            
+000323f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032400: 2020 7079 7465 7374 2e70 6172 616d 2849    pytest.param(I
+00032410: 424d 5f49 4e56 414c 4944 5f4e 414d 4553  BM_INVALID_NAMES
+00032420: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00032430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032440: 2020 2020 2020 2020 2020 2020 2073 746f               sto
+00032450: 7261 6765 5f6c 6962 2e53 746f 7265 5479  rage_lib.StoreTy
+00032460: 7065 2e49 424d 2c0a 2020 2020 2020 2020  pe.IBM,.        
+00032470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032490: 2020 206d 6172 6b73 3d70 7974 6573 742e     marks=pytest.
+000324a0: 6d61 726b 2e69 626d 292c 0a20 2020 2020  mark.ibm),.     
+000324b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000324c0: 2020 2020 2020 2020 2070 7974 6573 742e           pytest.
+000324d0: 7061 7261 6d28 4157 535f 494e 5641 4c49  param(AWS_INVALI
+000324e0: 445f 4e41 4d45 532c 0a20 2020 2020 2020  D_NAMES,.       
+000324f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032510: 2020 2020 7374 6f72 6167 655f 6c69 622e      storage_lib.
+00032520: 5374 6f72 6554 7970 652e 5232 2c0a 2020  StoreType.R2,.  
+00032530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032550: 2020 2020 2020 2020 206d 6172 6b73 3d70           marks=p
+00032560: 7974 6573 742e 6d61 726b 2e63 6c6f 7564  ytest.mark.cloud
+00032570: 666c 6172 6529 5d29 0a20 2020 2064 6566  flare)]).    def
+00032580: 2074 6573 745f 696e 7661 6c69 645f 6e61   test_invalid_na
+00032590: 6d65 7328 7365 6c66 2c20 696e 7661 6c69  mes(self, invali
+000325a0: 645f 6e61 6d65 5f6c 6973 742c 2073 746f  d_name_list, sto
+000325b0: 7265 5f74 7970 6529 3a0a 2020 2020 2020  re_type):.      
+000325c0: 2020 2320 5573 6573 2061 206c 6973 7420    # Uses a list 
+000325d0: 696e 2074 6865 2073 6f75 7263 6520 6669  in the source fi
+000325e0: 656c 6420 746f 2073 7065 6369 6679 2061  eld to specify a
+000325f0: 2066 696c 6520 616e 6420 6120 6469 7265   file and a dire
+00032600: 6374 6f72 7920 746f 0a20 2020 2020 2020  ctory to.       
+00032610: 2023 2062 6520 7570 6c6f 6164 6564 2074   # be uploaded t
+00032620: 6f20 7468 6520 7374 6f72 6167 6520 6f62  o the storage ob
+00032630: 6a65 6374 2e0a 2020 2020 2020 2020 666f  ject..        fo
+00032640: 7220 6e61 6d65 2069 6e20 696e 7661 6c69  r name in invali
+00032650: 645f 6e61 6d65 5f6c 6973 743a 0a20 2020  d_name_list:.   
+00032660: 2020 2020 2020 2020 2077 6974 6820 7079           with py
+00032670: 7465 7374 2e72 6169 7365 7328 736b 792e  test.raises(sky.
+00032680: 6578 6365 7074 696f 6e73 2e53 746f 7261  exceptions.Stora
+00032690: 6765 4e61 6d65 4572 726f 7229 3a0a 2020  geNameError):.  
+000326a0: 2020 2020 2020 2020 2020 2020 2020 7374                st
+000326b0: 6f72 6167 655f 6f62 6a20 3d20 7374 6f72  orage_obj = stor
+000326c0: 6167 655f 6c69 622e 5374 6f72 6167 6528  age_lib.Storage(
+000326d0: 6e61 6d65 3d6e 616d 6529 0a20 2020 2020  name=name).     
+000326e0: 2020 2020 2020 2020 2020 2073 746f 7261             stora
+000326f0: 6765 5f6f 626a 2e61 6464 5f73 746f 7265  ge_obj.add_store
+00032700: 2873 746f 7265 5f74 7970 6529 0a0a 2020  (store_type)..  
+00032710: 2020 4070 7974 6573 742e 6d61 726b 2e6e    @pytest.mark.n
+00032720: 6f5f 666c 7569 6473 7461 636b 0a20 2020  o_fluidstack.   
+00032730: 2040 7079 7465 7374 2e6d 6172 6b2e 7061   @pytest.mark.pa
+00032740: 7261 6d65 7472 697a 6528 0a20 2020 2020  rametrize(.     
+00032750: 2020 2027 6769 7469 676e 6f72 655f 7374     'gitignore_st
+00032760: 7275 6374 7572 652c 2073 746f 7265 5f74  ructure, store_t
+00032770: 7970 6527 2c0a 2020 2020 2020 2020 5b28  ype',.        [(
+00032780: 4749 5449 474e 4f52 455f 5359 4e43 5f54  GITIGNORE_SYNC_T
+00032790: 4553 545f 4449 525f 5354 5255 4354 5552  EST_DIR_STRUCTUR
+000327a0: 452c 2073 746f 7261 6765 5f6c 6962 2e53  E, storage_lib.S
+000327b0: 746f 7265 5479 7065 2e53 3329 2c0a 2020  toreType.S3),.  
+000327c0: 2020 2020 2020 2028 4749 5449 474e 4f52         (GITIGNOR
+000327d0: 455f 5359 4e43 5f54 4553 545f 4449 525f  E_SYNC_TEST_DIR_
+000327e0: 5354 5255 4354 5552 452c 2073 746f 7261  STRUCTURE, stora
+000327f0: 6765 5f6c 6962 2e53 746f 7265 5479 7065  ge_lib.StoreType
+00032800: 2e47 4353 292c 0a20 2020 2020 2020 2020  .GCS),.         
+00032810: 7079 7465 7374 2e70 6172 616d 2847 4954  pytest.param(GIT
+00032820: 4947 4e4f 5245 5f53 594e 435f 5445 5354  IGNORE_SYNC_TEST
+00032830: 5f44 4952 5f53 5452 5543 5455 5245 2c0a  _DIR_STRUCTURE,.
+00032840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032850: 2020 2020 2020 7374 6f72 6167 655f 6c69        storage_li
+00032860: 622e 5374 6f72 6554 7970 652e 5232 2c0a  b.StoreType.R2,.
+00032870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032880: 2020 2020 2020 6d61 726b 733d 7079 7465        marks=pyte
+00032890: 7374 2e6d 6172 6b2e 636c 6f75 6466 6c61  st.mark.cloudfla
+000328a0: 7265 295d 290a 2020 2020 6465 6620 7465  re)]).    def te
+000328b0: 7374 5f65 7863 6c75 6465 645f 6669 6c65  st_excluded_file
+000328c0: 5f63 6c6f 7564 5f73 746f 7261 6765 5f75  _cloud_storage_u
+000328d0: 706c 6f61 645f 636f 7079 2873 656c 662c  pload_copy(self,
+000328e0: 2067 6974 6967 6e6f 7265 5f73 7472 7563   gitignore_struc
+000328f0: 7475 7265 2c0a 2020 2020 2020 2020 2020  ture,.          
+00032900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032920: 2020 2020 2020 2020 2020 2073 746f 7265             store
+00032930: 5f74 7970 652c 0a20 2020 2020 2020 2020  _type,.         
+00032940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032960: 2020 2020 2020 2020 2020 2020 746d 705f              tmp_
+00032970: 6769 7469 676e 6f72 655f 7374 6f72 6167  gitignore_storag
+00032980: 655f 6f62 6a29 3a0a 2020 2020 2020 2020  e_obj):.        
+00032990: 2320 7465 7374 7320 6966 2066 696c 6573  # tests if files
+000329a0: 2069 6e63 6c75 6465 6420 696e 202e 6769   included in .gi
+000329b0: 7469 676e 6f72 6520 616e 6420 2e67 6974  tignore and .git
+000329c0: 2f69 6e66 6f2f 6578 636c 7564 6520 6172  /info/exclude ar
+000329d0: 650a 2020 2020 2020 2020 2320 6578 636c  e.        # excl
+000329e0: 7564 6564 2066 726f 6d20 6265 696e 6720  uded from being 
+000329f0: 7472 616e 7366 6572 7265 6420 746f 2053  transferred to S
+00032a00: 746f 7261 6765 0a0a 2020 2020 2020 2020  torage..        
+00032a10: 746d 705f 6769 7469 676e 6f72 655f 7374  tmp_gitignore_st
+00032a20: 6f72 6167 655f 6f62 6a2e 6164 645f 7374  orage_obj.add_st
+00032a30: 6f72 6528 7374 6f72 655f 7479 7065 290a  ore(store_type).
+00032a40: 0a20 2020 2020 2020 2075 706c 6f61 645f  .        upload_
+00032a50: 6669 6c65 5f6e 616d 6520 3d20 2769 6e63  file_name = 'inc
+00032a60: 6c75 6465 6427 0a20 2020 2020 2020 2023  luded'.        #
+00032a70: 2043 6f75 6e74 2074 6865 206e 756d 6265   Count the numbe
+00032a80: 7220 6f66 2066 696c 6573 2077 6974 6820  r of files with 
+00032a90: 7468 6520 6769 7665 6e20 6669 6c65 206e  the given file n
+00032aa0: 616d 650a 2020 2020 2020 2020 7570 5f63  ame.        up_c
+00032ab0: 6d64 203d 2073 656c 662e 636c 695f 636f  md = self.cli_co
+00032ac0: 756e 745f 6e61 6d65 5f69 6e5f 6275 636b  unt_name_in_buck
+00032ad0: 6574 2873 746f 7265 5f74 7970 652c 205c  et(store_type, \
+00032ae0: 0a20 2020 2020 2020 2020 2020 2074 6d70  .            tmp
+00032af0: 5f67 6974 6967 6e6f 7265 5f73 746f 7261  _gitignore_stora
+00032b00: 6765 5f6f 626a 2e6e 616d 652c 2066 696c  ge_obj.name, fil
+00032b10: 655f 6e61 6d65 3d75 706c 6f61 645f 6669  e_name=upload_fi
+00032b20: 6c65 5f6e 616d 6529 0a20 2020 2020 2020  le_name).       
+00032b30: 2067 6974 5f65 7863 6c75 6465 5f63 6d64   git_exclude_cmd
+00032b40: 203d 2073 656c 662e 636c 695f 636f 756e   = self.cli_coun
+00032b50: 745f 6e61 6d65 5f69 6e5f 6275 636b 6574  t_name_in_bucket
+00032b60: 2873 746f 7265 5f74 7970 652c 205c 0a20  (store_type, \. 
+00032b70: 2020 2020 2020 2020 2020 2074 6d70 5f67             tmp_g
+00032b80: 6974 6967 6e6f 7265 5f73 746f 7261 6765  itignore_storage
+00032b90: 5f6f 626a 2e6e 616d 652c 2066 696c 655f  _obj.name, file_
+00032ba0: 6e61 6d65 3d27 2e67 6974 2729 0a20 2020  name='.git').   
+00032bb0: 2020 2020 2063 6e74 5f6e 756d 5f66 696c       cnt_num_fil
+00032bc0: 655f 636d 6420 3d20 7365 6c66 2e63 6c69  e_cmd = self.cli
+00032bd0: 5f63 6f75 6e74 5f66 696c 655f 696e 5f62  _count_file_in_b
+00032be0: 7563 6b65 7428 0a20 2020 2020 2020 2020  ucket(.         
+00032bf0: 2020 2073 746f 7265 5f74 7970 652c 2074     store_type, t
+00032c00: 6d70 5f67 6974 6967 6e6f 7265 5f73 746f  mp_gitignore_sto
+00032c10: 7261 6765 5f6f 626a 2e6e 616d 6529 0a0a  rage_obj.name)..
+00032c20: 2020 2020 2020 2020 7570 5f6f 7574 7075          up_outpu
+00032c30: 7420 3d20 7375 6270 726f 6365 7373 2e63  t = subprocess.c
+00032c40: 6865 636b 5f6f 7574 7075 7428 7570 5f63  heck_output(up_c
+00032c50: 6d64 2c20 7368 656c 6c3d 5472 7565 290a  md, shell=True).
+00032c60: 2020 2020 2020 2020 6769 745f 6578 636c          git_excl
+00032c70: 7564 655f 6f75 7470 7574 203d 2073 7562  ude_output = sub
+00032c80: 7072 6f63 6573 732e 6368 6563 6b5f 6f75  process.check_ou
+00032c90: 7470 7574 2867 6974 5f65 7863 6c75 6465  tput(git_exclude
+00032ca0: 5f63 6d64 2c0a 2020 2020 2020 2020 2020  _cmd,.          
+00032cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032cd0: 2020 2020 2020 2020 2020 2073 6865 6c6c             shell
+00032ce0: 3d54 7275 6529 0a20 2020 2020 2020 2063  =True).        c
+00032cf0: 6e74 5f6f 7574 7075 7420 3d20 7375 6270  nt_output = subp
+00032d00: 726f 6365 7373 2e63 6865 636b 5f6f 7574  rocess.check_out
+00032d10: 7075 7428 636e 745f 6e75 6d5f 6669 6c65  put(cnt_num_file
+00032d20: 5f63 6d64 2c20 7368 656c 6c3d 5472 7565  _cmd, shell=True
+00032d30: 290a 0a20 2020 2020 2020 2061 7373 6572  )..        asser
+00032d40: 7420 2733 2720 696e 2075 705f 6f75 7470  t '3' in up_outp
+00032d50: 7574 2e64 6563 6f64 6528 2775 7466 2d38  ut.decode('utf-8
+00032d60: 2729 2c20 5c0a 2020 2020 2020 2020 2020  '), \.          
+00032d70: 2020 2020 2020 2746 696c 6573 2074 6f20        'Files to 
+00032d80: 6265 2069 6e63 6c75 6465 6420 6172 6520  be included are 
+00032d90: 6e6f 7420 636f 6d70 6c65 7465 6c79 2075  not completely u
+00032da0: 706c 6f61 6465 642e 270a 2020 2020 2020  ploaded.'.      
+00032db0: 2020 2320 3120 6973 2072 6561 6420 6173    # 1 is read as
+00032dc0: 202e 6769 7469 676e 6f72 6520 6973 2075   .gitignore is u
+00032dd0: 706c 6f61 6465 640a 2020 2020 2020 2020  ploaded.        
+00032de0: 6173 7365 7274 2027 3127 2069 6e20 6769  assert '1' in gi
+00032df0: 745f 6578 636c 7564 655f 6f75 7470 7574  t_exclude_output
+00032e00: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
+00032e10: 2c20 5c0a 2020 2020 2020 2020 2020 2020  , \.            
+00032e20: 2020 2027 2e67 6974 2064 6972 6563 746f     '.git directo
+00032e30: 7279 2073 686f 756c 6420 6e6f 7420 6265  ry should not be
+00032e40: 2075 706c 6f61 6465 642e 270a 2020 2020   uploaded.'.    
+00032e50: 2020 2020 2320 3420 6669 6c65 7320 696e      # 4 files in
+00032e60: 636c 7564 6520 2e67 6974 6967 6e6f 7265  clude .gitignore
+00032e70: 2c20 696e 636c 7564 6564 2e6c 6f67 2c20  , included.log, 
+00032e80: 696e 636c 7564 6564 2e74 7874 2c20 696e  included.txt, in
+00032e90: 636c 7564 655f 6469 722f 696e 636c 7564  clude_dir/includ
+00032ea0: 6564 2e6c 6f67 0a20 2020 2020 2020 2061  ed.log.        a
+00032eb0: 7373 6572 7420 2734 2720 696e 2063 6e74  ssert '4' in cnt
+00032ec0: 5f6f 7574 7075 742e 6465 636f 6465 2827  _output.decode('
+00032ed0: 7574 662d 3827 292c 205c 0a20 2020 2020  utf-8'), \.     
+00032ee0: 2020 2020 2020 2020 2020 2753 6f6d 6520            'Some 
+00032ef0: 6974 656d 7320 6c69 7374 6564 2069 6e20  items listed in 
+00032f00: 2e67 6974 6967 6e6f 7265 2061 6e64 202e  .gitignore and .
+00032f10: 6769 742f 696e 666f 2f65 7863 6c75 6465  git/info/exclude
+00032f20: 2061 7265 206e 6f74 2065 7863 6c75 6465   are not exclude
+00032f30: 642e 270a 0a20 2020 2040 7079 7465 7374  d.'..    @pytest
+00032f40: 2e6d 6172 6b2e 7061 7261 6d65 7472 697a  .mark.parametriz
+00032f50: 6528 2765 7874 5f62 7563 6b65 745f 6669  e('ext_bucket_fi
+00032f60: 7874 7572 652c 2073 746f 7265 5f74 7970  xture, store_typ
+00032f70: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
+00032f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032f90: 205b 2827 746d 705f 6177 7363 6c69 5f62   [('tmp_awscli_b
+00032fa0: 7563 6b65 7427 2c20 7374 6f72 6167 655f  ucket', storage_
+00032fb0: 6c69 622e 5374 6f72 6554 7970 652e 5333  lib.StoreType.S3
+00032fc0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00032fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032fe0: 2028 2774 6d70 5f67 7375 7469 6c5f 6275   ('tmp_gsutil_bu
+00032ff0: 636b 6574 272c 2073 746f 7261 6765 5f6c  cket', storage_l
+00033000: 6962 2e53 746f 7265 5479 7065 2e47 4353  ib.StoreType.GCS
+00033010: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00033020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033030: 2070 7974 6573 742e 7061 7261 6d28 2774   pytest.param('t
+00033040: 6d70 5f61 7773 636c 695f 6275 636b 6574  mp_awscli_bucket
+00033050: 5f72 3227 2c0a 2020 2020 2020 2020 2020  _r2',.          
+00033060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033080: 2073 746f 7261 6765 5f6c 6962 2e53 746f   storage_lib.Sto
+00033090: 7265 5479 7065 2e52 322c 0a20 2020 2020  reType.R2,.     
+000330a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000330b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000330c0: 2020 2020 2020 6d61 726b 733d 7079 7465        marks=pyte
+000330d0: 7374 2e6d 6172 6b2e 636c 6f75 6466 6c61  st.mark.cloudfla
+000330e0: 7265 295d 290a 2020 2020 6465 6620 7465  re)]).    def te
+000330f0: 7374 5f65 7874 6572 6e61 6c6c 795f 6372  st_externally_cr
+00033100: 6561 7465 645f 6275 636b 6574 5f6d 6f75  eated_bucket_mou
+00033110: 6e74 5f77 6974 686f 7574 5f73 6f75 7263  nt_without_sourc
+00033120: 6528 0a20 2020 2020 2020 2020 2020 2073  e(.            s
+00033130: 656c 662c 2065 7874 5f62 7563 6b65 745f  elf, ext_bucket_
+00033140: 6669 7874 7572 652c 2072 6571 7565 7374  fixture, request
+00033150: 2c20 7374 6f72 655f 7479 7065 293a 0a20  , store_type):. 
+00033160: 2020 2020 2020 2023 204e 6f6e 2d73 6b79         # Non-sky
+00033170: 206d 616e 6167 6564 2062 7563 6b65 7473   managed buckets
+00033180: 2862 7563 6b65 7473 2063 7265 6174 6564  (buckets created
+00033190: 206f 7574 7369 6465 206f 6620 536b 7970   outside of Skyp
+000331a0: 696c 6f74 2043 4c49 290a 2020 2020 2020  ilot CLI).      
+000331b0: 2020 2320 6172 6520 616c 6c6f 7765 6420    # are allowed 
+000331c0: 746f 2062 6520 4d4f 554e 5465 6420 6279  to be MOUNTed by
+000331d0: 2073 7065 6369 6679 696e 6720 7468 6520   specifying the 
+000331e0: 5552 4920 6f66 2074 6865 2062 7563 6b65  URI of the bucke
+000331f0: 7420 746f 0a20 2020 2020 2020 2023 2073  t to.        # s
+00033200: 6f75 7263 6520 6669 656c 6420 6f6e 6c79  ource field only
+00033210: 2e20 5768 656e 2069 7420 6973 2061 7474  . When it is att
+00033220: 656d 7074 6564 2062 7920 7370 6563 6966  empted by specif
+00033230: 7969 6e67 2074 6865 206e 616d 6520 6f66  ying the name of
+00033240: 0a20 2020 2020 2020 2023 2074 6865 2062  .        # the b
+00033250: 7563 6b65 7420 6f6e 6c79 2c20 6974 2073  ucket only, it s
+00033260: 686f 756c 6420 6572 726f 7220 6f75 742e  hould error out.
+00033270: 0a20 2020 2020 2020 2023 0a20 2020 2020  .        #.     
+00033280: 2020 2023 2054 4f44 4f28 646f 796f 756e     # TODO(doyoun
+00033290: 6729 3a20 4164 6420 7465 7374 2066 6f72  g): Add test for
+000332a0: 2049 424d 2043 4f53 2e20 4375 7272 656e   IBM COS. Curren
+000332b0: 746c 792c 2074 6869 7320 6973 2062 6c6f  tly, this is blo
+000332c0: 636b 6564 0a20 2020 2020 2020 2023 2061  cked.        # a
+000332d0: 7320 7263 6c6f 6e65 2075 7365 6420 746f  s rclone used to
+000332e0: 2069 6e74 6572 6163 7420 7769 7468 2049   interact with I
+000332f0: 424d 2043 4f53 2064 6f65 7320 6e6f 7420  BM COS does not 
+00033300: 7375 7070 6f72 7420 6665 6174 7572 6520  support feature 
+00033310: 746f 0a20 2020 2020 2020 2023 2063 7265  to.        # cre
+00033320: 6174 6520 6120 6275 636b 6574 2c20 616e  ate a bucket, an
+00033330: 6420 7468 6520 6962 6d63 6c6f 7564 2043  d the ibmcloud C
+00033340: 4c49 2069 7320 6e6f 7420 7375 7070 6f72  LI is not suppor
+00033350: 7465 6420 696e 2053 6b79 7069 6c6f 742e  ted in Skypilot.
+00033360: 0a20 2020 2020 2020 2023 2045 6974 6865  .        # Eithe
+00033370: 7220 6f66 2074 6865 2066 6561 7475 7265  r of the feature
+00033380: 2069 7320 6e65 6365 7373 6172 7920 746f   is necessary to
+00033390: 2073 696d 756c 6174 6520 616e 2065 7874   simulate an ext
+000333a0: 6572 6e61 6c20 6275 636b 6574 0a20 2020  ernal bucket.   
+000333b0: 2020 2020 2023 2063 7265 6174 696f 6e20       # creation 
+000333c0: 666f 7220 4942 4d20 434f 532e 0a20 2020  for IBM COS..   
+000333d0: 2020 2020 2023 2068 7474 7073 3a2f 2f67       # https://g
+000333e0: 6974 6875 622e 636f 6d2f 736b 7970 696c  ithub.com/skypil
+000333f0: 6f74 2d6f 7267 2f73 6b79 7069 6c6f 742f  ot-org/skypilot/
+00033400: 7075 6c6c 2f31 3936 362f 6669 6c65 7323  pull/1966/files#
+00033410: 7231 3235 3334 3339 3833 370a 0a20 2020  r1253439837..   
+00033420: 2020 2020 2065 7874 5f62 7563 6b65 745f       ext_bucket_
+00033430: 6e61 6d65 2c20 6578 745f 6275 636b 6574  name, ext_bucket
+00033440: 5f75 7269 203d 2072 6571 7565 7374 2e67  _uri = request.g
+00033450: 6574 6669 7874 7572 6576 616c 7565 280a  etfixturevalue(.
+00033460: 2020 2020 2020 2020 2020 2020 6578 745f              ext_
+00033470: 6275 636b 6574 5f66 6978 7475 7265 290a  bucket_fixture).
+00033480: 2020 2020 2020 2020 2320 696e 7661 6c69          # invali
+00033490: 6420 7370 6563 0a20 2020 2020 2020 2077  d spec.        w
+000334a0: 6974 6820 7079 7465 7374 2e72 6169 7365  ith pytest.raise
+000334b0: 7328 736b 792e 6578 6365 7074 696f 6e73  s(sky.exceptions
+000334c0: 2e53 746f 7261 6765 5370 6563 4572 726f  .StorageSpecErro
+000334d0: 7229 2061 7320 653a 0a20 2020 2020 2020  r) as e:.       
+000334e0: 2020 2020 2073 746f 7261 6765 5f6f 626a       storage_obj
+000334f0: 203d 2073 746f 7261 6765 5f6c 6962 2e53   = storage_lib.S
+00033500: 746f 7261 6765 280a 2020 2020 2020 2020  torage(.        
+00033510: 2020 2020 2020 2020 6e61 6d65 3d65 7874          name=ext
+00033520: 5f62 7563 6b65 745f 6e61 6d65 2c20 6d6f  _bucket_name, mo
+00033530: 6465 3d73 746f 7261 6765 5f6c 6962 2e53  de=storage_lib.S
+00033540: 746f 7261 6765 4d6f 6465 2e4d 4f55 4e54  torageMode.MOUNT
+00033550: 290a 2020 2020 2020 2020 2020 2020 7374  ).            st
+00033560: 6f72 6167 655f 6f62 6a2e 6164 645f 7374  orage_obj.add_st
+00033570: 6f72 6528 7374 6f72 655f 7479 7065 290a  ore(store_type).
+00033580: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00033590: 2741 7474 656d 7074 6564 2074 6f20 6d6f  'Attempted to mo
+000335a0: 756e 7420 6120 6e6f 6e2d 736b 7920 6d61  unt a non-sky ma
+000335b0: 6e61 6765 6420 6275 636b 6574 2720 696e  naged bucket' in
+000335c0: 2073 7472 2865 290a 0a20 2020 2020 2020   str(e)..       
+000335d0: 2023 2076 616c 6964 2073 7065 630a 2020   # valid spec.  
+000335e0: 2020 2020 2020 7374 6f72 6167 655f 6f62        storage_ob
+000335f0: 6a20 3d20 7374 6f72 6167 655f 6c69 622e  j = storage_lib.
+00033600: 5374 6f72 6167 6528 736f 7572 6365 3d65  Storage(source=e
+00033610: 7874 5f62 7563 6b65 745f 7572 692c 0a20  xt_bucket_uri,. 
+00033620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033640: 2020 2020 2020 2020 206d 6f64 653d 7374           mode=st
+00033650: 6f72 6167 655f 6c69 622e 5374 6f72 6167  orage_lib.Storag
+00033660: 654d 6f64 652e 4d4f 554e 5429 0a20 2020  eMode.MOUNT).   
+00033670: 2020 2020 2068 616e 646c 6520 3d20 676c       handle = gl
+00033680: 6f62 616c 5f75 7365 725f 7374 6174 652e  obal_user_state.
+00033690: 6765 745f 6861 6e64 6c65 5f66 726f 6d5f  get_handle_from_
+000336a0: 7374 6f72 6167 655f 6e61 6d65 280a 2020  storage_name(.  
+000336b0: 2020 2020 2020 2020 2020 7374 6f72 6167            storag
+000336c0: 655f 6f62 6a2e 6e61 6d65 290a 2020 2020  e_obj.name).    
+000336d0: 2020 2020 6966 2068 616e 646c 653a 0a20      if handle:. 
+000336e0: 2020 2020 2020 2020 2020 2073 746f 7261             stora
+000336f0: 6765 5f6f 626a 2e64 656c 6574 6528 290a  ge_obj.delete().
+00033700: 0a20 2020 2040 7079 7465 7374 2e6d 6172  .    @pytest.mar
+00033710: 6b2e 6e6f 5f66 6c75 6964 7374 6163 6b0a  k.no_fluidstack.
+00033720: 2020 2020 4070 7974 6573 742e 6d61 726b      @pytest.mark
+00033730: 2e70 6172 616d 6574 7269 7a65 2827 7265  .parametrize('re
+00033740: 6769 6f6e 272c 205b 0a20 2020 2020 2020  gion', [.       
+00033750: 2027 6170 2d6e 6f72 7468 6561 7374 2d31   'ap-northeast-1
+00033760: 272c 2027 6170 2d6e 6f72 7468 6561 7374  ', 'ap-northeast
+00033770: 2d32 272c 2027 6170 2d6e 6f72 7468 6561  -2', 'ap-northea
+00033780: 7374 2d33 272c 2027 6170 2d73 6f75 7468  st-3', 'ap-south
+00033790: 2d31 272c 0a20 2020 2020 2020 2027 6170  -1',.        'ap
+000337a0: 2d73 6f75 7468 6561 7374 2d31 272c 2027  -southeast-1', '
+000337b0: 6170 2d73 6f75 7468 6561 7374 2d32 272c  ap-southeast-2',
+000337c0: 2027 6575 2d63 656e 7472 616c 2d31 272c   'eu-central-1',
+000337d0: 2027 6575 2d6e 6f72 7468 2d31 272c 0a20   'eu-north-1',. 
+000337e0: 2020 2020 2020 2027 6575 2d77 6573 742d         'eu-west-
+000337f0: 3127 2c20 2765 752d 7765 7374 2d32 272c  1', 'eu-west-2',
+00033800: 2027 6575 2d77 6573 742d 3327 2c20 2773   'eu-west-3', 's
+00033810: 612d 6561 7374 2d31 272c 2027 7573 2d65  a-east-1', 'us-e
+00033820: 6173 742d 3127 2c0a 2020 2020 2020 2020  ast-1',.        
+00033830: 2775 732d 6561 7374 2d32 272c 2027 7573  'us-east-2', 'us
+00033840: 2d77 6573 742d 3127 2c20 2775 732d 7765  -west-1', 'us-we
+00033850: 7374 2d32 270a 2020 2020 5d29 0a20 2020  st-2'.    ]).   
+00033860: 2064 6566 2074 6573 745f 6177 735f 7265   def test_aws_re
+00033870: 6769 6f6e 7328 7365 6c66 2c20 746d 705f  gions(self, tmp_
+00033880: 6c6f 6361 6c5f 7374 6f72 6167 655f 6f62  local_storage_ob
+00033890: 6a2c 2072 6567 696f 6e29 3a0a 2020 2020  j, region):.    
+000338a0: 2020 2020 2320 5468 6973 2074 6573 7473      # This tests
+000338b0: 2063 7265 6174 696f 6e20 616e 6420 7570   creation and up
+000338c0: 6c6f 6164 2074 6f20 6275 636b 6574 2069  load to bucket i
+000338d0: 6e20 616c 6c20 4157 5320 7333 2072 6567  n all AWS s3 reg
+000338e0: 696f 6e73 0a20 2020 2020 2020 2023 2054  ions.        # T
+000338f0: 6f20 7465 7374 2066 756c 6c20 6675 6e63  o test full func
+00033900: 7469 6f6e 616c 6974 792c 2075 7365 2074  tionality, use t
+00033910: 6573 745f 6d61 6e61 6765 645f 6a6f 6273  est_managed_jobs
+00033920: 5f73 746f 7261 6765 2061 626f 7665 2e0a  _storage above..
+00033930: 2020 2020 2020 2020 7374 6f72 655f 7479          store_ty
+00033940: 7065 203d 2073 746f 7261 6765 5f6c 6962  pe = storage_lib
+00033950: 2e53 746f 7265 5479 7065 2e53 330a 2020  .StoreType.S3.  
+00033960: 2020 2020 2020 746d 705f 6c6f 6361 6c5f        tmp_local_
+00033970: 7374 6f72 6167 655f 6f62 6a2e 6164 645f  storage_obj.add_
+00033980: 7374 6f72 6528 7374 6f72 655f 7479 7065  store(store_type
+00033990: 2c20 7265 6769 6f6e 3d72 6567 696f 6e29  , region=region)
+000339a0: 0a20 2020 2020 2020 2062 7563 6b65 745f  .        bucket_
+000339b0: 6e61 6d65 203d 2074 6d70 5f6c 6f63 616c  name = tmp_local
+000339c0: 5f73 746f 7261 6765 5f6f 626a 2e6e 616d  _storage_obj.nam
+000339d0: 650a 0a20 2020 2020 2020 2023 2043 6f6e  e..        # Con
+000339e0: 6669 726d 2074 6861 7420 7468 6520 6275  firm that the bu
+000339f0: 636b 6574 2077 6173 2063 7265 6174 6564  cket was created
+00033a00: 2069 6e20 7468 6520 636f 7272 6563 7420   in the correct 
+00033a10: 7265 6769 6f6e 0a20 2020 2020 2020 2072  region.        r
+00033a20: 6567 696f 6e5f 636d 6420 3d20 7365 6c66  egion_cmd = self
+00033a30: 2e63 6c69 5f72 6567 696f 6e5f 636d 6428  .cli_region_cmd(
+00033a40: 7374 6f72 655f 7479 7065 2c20 6275 636b  store_type, buck
+00033a50: 6574 5f6e 616d 6529 0a20 2020 2020 2020  et_name).       
+00033a60: 206f 7574 203d 2073 7562 7072 6f63 6573   out = subproces
+00033a70: 732e 6368 6563 6b5f 6f75 7470 7574 2872  s.check_output(r
+00033a80: 6567 696f 6e5f 636d 642c 2073 6865 6c6c  egion_cmd, shell
+00033a90: 3d54 7275 6529 0a20 2020 2020 2020 206f  =True).        o
+00033aa0: 7574 7075 7420 3d20 6f75 742e 6465 636f  utput = out.deco
+00033ab0: 6465 2827 7574 662d 3827 290a 2020 2020  de('utf-8').    
+00033ac0: 2020 2020 6578 7065 6374 6564 5f6f 7574      expected_out
+00033ad0: 7075 745f 7265 6769 6f6e 203d 2072 6567  put_region = reg
+00033ae0: 696f 6e0a 2020 2020 2020 2020 6966 2072  ion.        if r
+00033af0: 6567 696f 6e20 3d3d 2027 7573 2d65 6173  egion == 'us-eas
+00033b00: 742d 3127 3a0a 2020 2020 2020 2020 2020  t-1':.          
+00033b10: 2020 6578 7065 6374 6564 5f6f 7574 7075    expected_outpu
+00033b20: 745f 7265 6769 6f6e 203d 2027 4e6f 6e65  t_region = 'None
+00033b30: 2720 2023 2075 732d 6561 7374 2d31 2069  '  # us-east-1 i
+00033b40: 7320 7468 6520 6465 6661 756c 7420 7265  s the default re
+00033b50: 6769 6f6e 0a20 2020 2020 2020 2061 7373  gion.        ass
+00033b60: 6572 7420 6578 7065 6374 6564 5f6f 7574  ert expected_out
+00033b70: 7075 745f 7265 6769 6f6e 2069 6e20 6f75  put_region in ou
+00033b80: 742e 6465 636f 6465 2827 7574 662d 3827  t.decode('utf-8'
+00033b90: 292c 2028 0a20 2020 2020 2020 2020 2020  ), (.           
+00033ba0: 2066 2742 7563 6b65 7420 7761 7320 6e6f   f'Bucket was no
+00033bb0: 7420 666f 756e 6420 696e 2072 6567 696f  t found in regio
+00033bc0: 6e20 7b72 6567 696f 6e7d 202d 2027 0a20  n {region} - '. 
+00033bd0: 2020 2020 2020 2020 2020 2066 276f 7574             f'out
+00033be0: 7075 7420 6f66 207b 7265 6769 6f6e 5f63  put of {region_c
+00033bf0: 6d64 7d20 7761 733a 207b 6f75 7470 7574  md} was: {output
+00033c00: 7d27 290a 0a20 2020 2020 2020 2023 2043  }')..        # C
+00033c10: 6865 636b 2069 6620 746d 705f 736f 7572  heck if tmp_sour
+00033c20: 6365 2f74 6d70 2d66 696c 6520 6578 6973  ce/tmp-file exis
+00033c30: 7473 2069 6e20 7468 6520 6275 636b 6574  ts in the bucket
+00033c40: 2075 7369 6e67 2063 6c69 0a20 2020 2020   using cli.     
+00033c50: 2020 206c 735f 636d 6420 3d20 7365 6c66     ls_cmd = self
+00033c60: 2e63 6c69 5f6c 735f 636d 6428 7374 6f72  .cli_ls_cmd(stor
+00033c70: 655f 7479 7065 2c20 6275 636b 6574 5f6e  e_type, bucket_n
+00033c80: 616d 6529 0a20 2020 2020 2020 206f 7574  ame).        out
+00033c90: 203d 2073 7562 7072 6f63 6573 732e 6368   = subprocess.ch
+00033ca0: 6563 6b5f 6f75 7470 7574 286c 735f 636d  eck_output(ls_cm
+00033cb0: 642c 2073 6865 6c6c 3d54 7275 6529 0a20  d, shell=True). 
+00033cc0: 2020 2020 2020 206f 7574 7075 7420 3d20         output = 
+00033cd0: 6f75 742e 6465 636f 6465 2827 7574 662d  out.decode('utf-
+00033ce0: 3827 290a 2020 2020 2020 2020 6173 7365  8').        asse
+00033cf0: 7274 2027 746d 702d 6669 6c65 2720 696e  rt 'tmp-file' in
+00033d00: 206f 7574 7075 742c 2028 0a20 2020 2020   output, (.     
+00033d10: 2020 2020 2020 2066 2774 6d70 2d66 696c         f'tmp-fil
+00033d20: 6520 6e6f 7420 666f 756e 6420 696e 2062  e not found in b
+00033d30: 7563 6b65 7420 2d20 6f75 7470 7574 206f  ucket - output o
+00033d40: 6620 7b6c 735f 636d 647d 2077 6173 3a20  f {ls_cmd} was: 
+00033d50: 7b6f 7574 7075 747d 2729 0a0a 2020 2020  {output}')..    
+00033d60: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00033d70: 666c 7569 6473 7461 636b 0a20 2020 2040  fluidstack.    @
+00033d80: 7079 7465 7374 2e6d 6172 6b2e 7061 7261  pytest.mark.para
+00033d90: 6d65 7472 697a 6528 2772 6567 696f 6e27  metrize('region'
+00033da0: 2c20 5b0a 2020 2020 2020 2020 276e 6f72  , [.        'nor
+00033db0: 7468 616d 6572 6963 612d 6e6f 7274 6865  thamerica-northe
+00033dc0: 6173 7431 272c 2027 6e6f 7274 6861 6d65  ast1', 'northame
+00033dd0: 7269 6361 2d6e 6f72 7468 6561 7374 3227  rica-northeast2'
+00033de0: 2c20 2775 732d 6365 6e74 7261 6c31 272c  , 'us-central1',
+00033df0: 0a20 2020 2020 2020 2027 7573 2d65 6173  .        'us-eas
+00033e00: 7431 272c 2027 7573 2d65 6173 7434 272c  t1', 'us-east4',
+00033e10: 2027 7573 2d65 6173 7435 272c 2027 7573   'us-east5', 'us
+00033e20: 2d73 6f75 7468 3127 2c20 2775 732d 7765  -south1', 'us-we
+00033e30: 7374 3127 2c20 2775 732d 7765 7374 3227  st1', 'us-west2'
+00033e40: 2c0a 2020 2020 2020 2020 2775 732d 7765  ,.        'us-we
+00033e50: 7374 3327 2c20 2775 732d 7765 7374 3427  st3', 'us-west4'
+00033e60: 2c20 2773 6f75 7468 616d 6572 6963 612d  , 'southamerica-
+00033e70: 6561 7374 3127 2c20 2773 6f75 7468 616d  east1', 'southam
+00033e80: 6572 6963 612d 7765 7374 3127 2c0a 2020  erica-west1',.  
+00033e90: 2020 2020 2020 2765 7572 6f70 652d 6365        'europe-ce
+00033ea0: 6e74 7261 6c32 272c 2027 6575 726f 7065  ntral2', 'europe
+00033eb0: 2d6e 6f72 7468 3127 2c20 2765 7572 6f70  -north1', 'europ
+00033ec0: 652d 736f 7574 6877 6573 7431 272c 2027  e-southwest1', '
+00033ed0: 6575 726f 7065 2d77 6573 7431 272c 0a20  europe-west1',. 
+00033ee0: 2020 2020 2020 2027 6575 726f 7065 2d77         'europe-w
+00033ef0: 6573 7432 272c 2027 6575 726f 7065 2d77  est2', 'europe-w
+00033f00: 6573 7433 272c 2027 6575 726f 7065 2d77  est3', 'europe-w
+00033f10: 6573 7434 272c 2027 6575 726f 7065 2d77  est4', 'europe-w
+00033f20: 6573 7436 272c 0a20 2020 2020 2020 2027  est6',.        '
+00033f30: 6575 726f 7065 2d77 6573 7438 272c 2027  europe-west8', '
+00033f40: 6575 726f 7065 2d77 6573 7439 272c 2027  europe-west9', '
+00033f50: 6575 726f 7065 2d77 6573 7431 3027 2c20  europe-west10', 
+00033f60: 2765 7572 6f70 652d 7765 7374 3132 272c  'europe-west12',
+00033f70: 0a20 2020 2020 2020 2027 6173 6961 2d65  .        'asia-e
+00033f80: 6173 7431 272c 2027 6173 6961 2d65 6173  ast1', 'asia-eas
+00033f90: 7432 272c 2027 6173 6961 2d6e 6f72 7468  t2', 'asia-north
+00033fa0: 6561 7374 3127 2c20 2761 7369 612d 6e6f  east1', 'asia-no
+00033fb0: 7274 6865 6173 7432 272c 0a20 2020 2020  rtheast2',.     
+00033fc0: 2020 2027 6173 6961 2d6e 6f72 7468 6561     'asia-northea
+00033fd0: 7374 3327 2c20 2761 7369 612d 736f 7574  st3', 'asia-sout
+00033fe0: 6865 6173 7431 272c 2027 6173 6961 2d73  heast1', 'asia-s
+00033ff0: 6f75 7468 3127 2c20 2761 7369 612d 736f  outh1', 'asia-so
+00034000: 7574 6832 272c 0a20 2020 2020 2020 2027  uth2',.        '
+00034010: 6173 6961 2d73 6f75 7468 6561 7374 3227  asia-southeast2'
+00034020: 2c20 276d 652d 6365 6e74 7261 6c31 272c  , 'me-central1',
+00034030: 2027 6d65 2d63 656e 7472 616c 3227 2c20   'me-central2', 
+00034040: 276d 652d 7765 7374 3127 2c0a 2020 2020  'me-west1',.    
+00034050: 2020 2020 2761 7573 7472 616c 6961 2d73      'australia-s
+00034060: 6f75 7468 6561 7374 3127 2c20 2761 7573  outheast1', 'aus
+00034070: 7472 616c 6961 2d73 6f75 7468 6561 7374  tralia-southeast
+00034080: 3227 2c20 2761 6672 6963 612d 736f 7574  2', 'africa-sout
+00034090: 6831 270a 2020 2020 5d29 0a20 2020 2064  h1'.    ]).    d
+000340a0: 6566 2074 6573 745f 6763 735f 7265 6769  ef test_gcs_regi
+000340b0: 6f6e 7328 7365 6c66 2c20 746d 705f 6c6f  ons(self, tmp_lo
+000340c0: 6361 6c5f 7374 6f72 6167 655f 6f62 6a2c  cal_storage_obj,
+000340d0: 2072 6567 696f 6e29 3a0a 2020 2020 2020   region):.      
+000340e0: 2020 2320 5468 6973 2074 6573 7473 2063    # This tests c
+000340f0: 7265 6174 696f 6e20 616e 6420 7570 6c6f  reation and uplo
+00034100: 6164 2074 6f20 6275 636b 6574 2069 6e20  ad to bucket in 
+00034110: 616c 6c20 4743 5320 7265 6769 6f6e 730a  all GCS regions.
+00034120: 2020 2020 2020 2020 2320 546f 2074 6573          # To tes
+00034130: 7420 6675 6c6c 2066 756e 6374 696f 6e61  t full functiona
+00034140: 6c69 7479 2c20 7573 6520 7465 7374 5f6d  lity, use test_m
+00034150: 616e 6167 6564 5f6a 6f62 735f 7374 6f72  anaged_jobs_stor
+00034160: 6167 6520 6162 6f76 652e 0a20 2020 2020  age above..     
+00034170: 2020 2073 746f 7265 5f74 7970 6520 3d20     store_type = 
+00034180: 7374 6f72 6167 655f 6c69 622e 5374 6f72  storage_lib.Stor
+00034190: 6554 7970 652e 4743 530a 2020 2020 2020  eType.GCS.      
+000341a0: 2020 746d 705f 6c6f 6361 6c5f 7374 6f72    tmp_local_stor
+000341b0: 6167 655f 6f62 6a2e 6164 645f 7374 6f72  age_obj.add_stor
+000341c0: 6528 7374 6f72 655f 7479 7065 2c20 7265  e(store_type, re
+000341d0: 6769 6f6e 3d72 6567 696f 6e29 0a20 2020  gion=region).   
+000341e0: 2020 2020 2062 7563 6b65 745f 6e61 6d65       bucket_name
+000341f0: 203d 2074 6d70 5f6c 6f63 616c 5f73 746f   = tmp_local_sto
+00034200: 7261 6765 5f6f 626a 2e6e 616d 650a 0a20  rage_obj.name.. 
+00034210: 2020 2020 2020 2023 2043 6f6e 6669 726d         # Confirm
+00034220: 2074 6861 7420 7468 6520 6275 636b 6574   that the bucket
+00034230: 2077 6173 2063 7265 6174 6564 2069 6e20   was created in 
+00034240: 7468 6520 636f 7272 6563 7420 7265 6769  the correct regi
+00034250: 6f6e 0a20 2020 2020 2020 2072 6567 696f  on.        regio
+00034260: 6e5f 636d 6420 3d20 7365 6c66 2e63 6c69  n_cmd = self.cli
+00034270: 5f72 6567 696f 6e5f 636d 6428 7374 6f72  _region_cmd(stor
+00034280: 655f 7479 7065 2c20 6275 636b 6574 5f6e  e_type, bucket_n
+00034290: 616d 6529 0a20 2020 2020 2020 206f 7574  ame).        out
+000342a0: 203d 2073 7562 7072 6f63 6573 732e 6368   = subprocess.ch
+000342b0: 6563 6b5f 6f75 7470 7574 2872 6567 696f  eck_output(regio
+000342c0: 6e5f 636d 642c 2073 6865 6c6c 3d54 7275  n_cmd, shell=Tru
+000342d0: 6529 0a20 2020 2020 2020 206f 7574 7075  e).        outpu
+000342e0: 7420 3d20 6f75 742e 6465 636f 6465 2827  t = out.decode('
+000342f0: 7574 662d 3827 290a 2020 2020 2020 2020  utf-8').        
+00034300: 6173 7365 7274 2072 6567 696f 6e20 696e  assert region in
+00034310: 206f 7574 2e64 6563 6f64 6528 2775 7466   out.decode('utf
+00034320: 2d38 2729 2c20 280a 2020 2020 2020 2020  -8'), (.        
+00034330: 2020 2020 6627 4275 636b 6574 2077 6173      f'Bucket was
+00034340: 206e 6f74 2066 6f75 6e64 2069 6e20 7265   not found in re
+00034350: 6769 6f6e 207b 7265 6769 6f6e 7d20 2d20  gion {region} - 
+00034360: 270a 2020 2020 2020 2020 2020 2020 6627  '.            f'
+00034370: 6f75 7470 7574 206f 6620 7b72 6567 696f  output of {regio
+00034380: 6e5f 636d 647d 2077 6173 3a20 7b6f 7574  n_cmd} was: {out
+00034390: 7075 747d 2729 0a0a 2020 2020 2020 2020  put}')..        
+000343a0: 2320 4368 6563 6b20 6966 2074 6d70 5f73  # Check if tmp_s
+000343b0: 6f75 7263 652f 746d 702d 6669 6c65 2065  ource/tmp-file e
+000343c0: 7869 7374 7320 696e 2074 6865 2062 7563  xists in the buc
+000343d0: 6b65 7420 7573 696e 6720 636c 690a 2020  ket using cli.  
+000343e0: 2020 2020 2020 6c73 5f63 6d64 203d 2073        ls_cmd = s
+000343f0: 656c 662e 636c 695f 6c73 5f63 6d64 2873  elf.cli_ls_cmd(s
+00034400: 746f 7265 5f74 7970 652c 2062 7563 6b65  tore_type, bucke
+00034410: 745f 6e61 6d65 290a 2020 2020 2020 2020  t_name).        
+00034420: 6f75 7420 3d20 7375 6270 726f 6365 7373  out = subprocess
+00034430: 2e63 6865 636b 5f6f 7574 7075 7428 6c73  .check_output(ls
+00034440: 5f63 6d64 2c20 7368 656c 6c3d 5472 7565  _cmd, shell=True
+00034450: 290a 2020 2020 2020 2020 6f75 7470 7574  ).        output
+00034460: 203d 206f 7574 2e64 6563 6f64 6528 2775   = out.decode('u
+00034470: 7466 2d38 2729 0a20 2020 2020 2020 2061  tf-8').        a
+00034480: 7373 6572 7420 2774 6d70 2d66 696c 6527  ssert 'tmp-file'
+00034490: 2069 6e20 6f75 7470 7574 2c20 280a 2020   in output, (.  
+000344a0: 2020 2020 2020 2020 2020 6627 746d 702d            f'tmp-
+000344b0: 6669 6c65 206e 6f74 2066 6f75 6e64 2069  file not found i
+000344c0: 6e20 6275 636b 6574 202d 206f 7574 7075  n bucket - outpu
+000344d0: 7420 6f66 207b 6c73 5f63 6d64 7d20 7761  t of {ls_cmd} wa
+000344e0: 733a 207b 6f75 7470 7574 7d27 290a 0a0a  s: {output}')...
+000344f0: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2054 6573  # ---------- Tes
+00034500: 7469 6e67 2059 414d 4c20 5370 6563 7320  ting YAML Specs 
+00034510: 2d2d 2d2d 2d2d 2d2d 2d2d 0a23 204f 7572  ----------.# Our
+00034520: 2073 6b79 2073 746f 7261 6765 2072 6571   sky storage req
+00034530: 7569 7265 7320 6372 6564 656e 7469 616c  uires credential
+00034540: 7320 746f 2063 6865 636b 2074 6865 2062  s to check the b
+00034550: 7563 6b65 7420 6578 6973 7461 6e63 6520  ucket existance 
+00034560: 7768 656e 0a23 206c 6f61 6469 6e67 2061  when.# loading a
+00034570: 2074 6173 6b20 6672 6f6d 2074 6865 2079   task from the y
+00034580: 616d 6c20 6669 6c65 2c20 736f 2077 6520  aml file, so we 
+00034590: 6361 6e6e 6f74 206d 616b 6520 6974 2061  cannot make it a
+000345a0: 2075 6e69 7420 7465 7374 2e0a 636c 6173   unit test..clas
+000345b0: 7320 5465 7374 5961 6d6c 5370 6563 733a  s TestYamlSpecs:
+000345c0: 0a20 2020 2023 2054 4f44 4f28 7a68 7775  .    # TODO(zhwu
+000345d0: 293a 2041 6464 2074 6573 7420 666f 7220  ): Add test for 
+000345e0: 6074 6f5f 7961 6d6c 5f63 6f6e 6669 6760  `to_yaml_config`
+000345f0: 2066 6f72 2074 6865 2053 746f 7261 6765   for the Storage
+00034600: 206f 626a 6563 742e 0a20 2020 2023 2020   object..    #  
+00034610: 5765 2073 686f 756c 6420 6e6f 7420 7573  We should not us
+00034620: 6520 6065 7861 6d70 6c65 732f 7374 6f72  e `examples/stor
+00034630: 6167 655f 6465 6d6f 2e79 616d 6c60 2068  age_demo.yaml` h
+00034640: 6572 652c 2073 696e 6365 2069 7420 7265  ere, since it re
+00034650: 7175 6972 6573 0a20 2020 2023 2020 7573  quires.    #  us
+00034660: 6572 7320 746f 2065 6e73 7572 6520 6275  ers to ensure bu
+00034670: 636b 6574 206e 616d 6573 2074 6f20 6e6f  cket names to no
+00034680: 7420 6578 6973 7420 616e 642f 6f72 2062  t exist and/or b
+00034690: 6520 756e 6971 7565 2e0a 2020 2020 5f54  e unique..    _T
+000346a0: 4553 545f 5941 4d4c 5f50 4154 4853 203d  EST_YAML_PATHS =
+000346b0: 205b 0a20 2020 2020 2020 2027 6578 616d   [.        'exam
+000346c0: 706c 6573 2f6d 696e 696d 616c 2e79 616d  ples/minimal.yam
+000346d0: 6c27 2c20 2765 7861 6d70 6c65 732f 6d61  l', 'examples/ma
+000346e0: 6e61 6765 645f 6a6f 622e 7961 6d6c 272c  naged_job.yaml',
+000346f0: 0a20 2020 2020 2020 2027 6578 616d 706c  .        'exampl
+00034700: 6573 2f75 7369 6e67 5f66 696c 655f 6d6f  es/using_file_mo
+00034710: 756e 7473 2e79 616d 6c27 2c20 2765 7861  unts.yaml', 'exa
+00034720: 6d70 6c65 732f 7265 736e 6574 5f61 7070  mples/resnet_app
+00034730: 2e79 616d 6c27 2c0a 2020 2020 2020 2020  .yaml',.        
+00034740: 2765 7861 6d70 6c65 732f 6d75 6c74 695f  'examples/multi_
+00034750: 686f 7374 6e61 6d65 2e79 616d 6c27 0a20  hostname.yaml'. 
+00034760: 2020 205d 0a0a 2020 2020 6465 6620 5f69     ]..    def _i
+00034770: 735f 6469 6374 5f73 7562 7365 7428 7365  s_dict_subset(se
+00034780: 6c66 2c20 6431 2c20 6432 293a 0a20 2020  lf, d1, d2):.   
+00034790: 2020 2020 2022 2222 4368 6563 6b20 6966       """Check if
+000347a0: 2064 3120 6973 2074 6865 2073 7562 7365   d1 is the subse
+000347b0: 7420 6f66 2064 322e 2222 220a 2020 2020  t of d2.""".    
+000347c0: 2020 2020 666f 7220 6b2c 2076 2069 6e20      for k, v in 
+000347d0: 6431 2e69 7465 6d73 2829 3a0a 2020 2020  d1.items():.    
+000347e0: 2020 2020 2020 2020 6966 206b 206e 6f74          if k not
+000347f0: 2069 6e20 6432 3a0a 2020 2020 2020 2020   in d2:.        
+00034800: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+00034810: 7461 6e63 6528 762c 206c 6973 7429 206f  tance(v, list) o
+00034820: 7220 6973 696e 7374 616e 6365 2876 2c20  r isinstance(v, 
+00034830: 6469 6374 293a 0a20 2020 2020 2020 2020  dict):.         
+00034840: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00034850: 7420 6c65 6e28 7629 203d 3d20 302c 2028  t len(v) == 0, (
+00034860: 6b2c 2076 290a 2020 2020 2020 2020 2020  k, v).          
+00034870: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00034880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034890: 6173 7365 7274 2046 616c 7365 2c20 286b  assert False, (k
+000348a0: 2c20 7629 0a20 2020 2020 2020 2020 2020  , v).           
+000348b0: 2065 6c69 6620 6973 696e 7374 616e 6365   elif isinstance
+000348c0: 2876 2c20 6469 6374 293a 0a20 2020 2020  (v, dict):.     
+000348d0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+000348e0: 7420 6973 696e 7374 616e 6365 2864 325b  t isinstance(d2[
+000348f0: 6b5d 2c20 6469 6374 292c 2028 6b2c 2076  k], dict), (k, v
+00034900: 2c20 6432 290a 2020 2020 2020 2020 2020  , d2).          
+00034910: 2020 2020 2020 7365 6c66 2e5f 6973 5f64        self._is_d
+00034920: 6963 745f 7375 6273 6574 2876 2c20 6432  ict_subset(v, d2
+00034930: 5b6b 5d29 0a20 2020 2020 2020 2020 2020  [k]).           
+00034940: 2065 6c69 6620 6973 696e 7374 616e 6365   elif isinstance
+00034950: 2876 2c20 7374 7229 3a0a 2020 2020 2020  (v, str):.      
+00034960: 2020 2020 2020 2020 2020 6966 206b 203d            if k =
+00034970: 3d20 2761 6363 656c 6572 6174 6f72 7327  = 'accelerators'
+00034980: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00034990: 2020 2020 2020 7265 736f 7572 6365 7320        resources 
+000349a0: 3d20 736b 792e 5265 736f 7572 6365 7328  = sky.Resources(
+000349b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000349c0: 2020 2020 2020 7265 736f 7572 6365 732e        resources.
+000349d0: 5f73 6574 5f61 6363 656c 6572 6174 6f72  _set_accelerator
+000349e0: 7328 762c 204e 6f6e 6529 0a20 2020 2020  s(v, None).     
+000349f0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00034a00: 7373 6572 7420 7265 736f 7572 6365 732e  ssert resources.
+00034a10: 6163 6365 6c65 7261 746f 7273 203d 3d20  accelerators == 
+00034a20: 6432 5b6b 5d2c 2028 6b2c 2076 2c20 6432  d2[k], (k, v, d2
+00034a30: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00034a40: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00034a50: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00034a60: 7274 2076 2e6c 6f77 6572 2829 203d 3d20  rt v.lower() == 
+00034a70: 6432 5b6b 5d2e 6c6f 7765 7228 292c 2028  d2[k].lower(), (
+00034a80: 6b2c 2076 2c20 6432 5b6b 5d29 0a20 2020  k, v, d2[k]).   
+00034a90: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00034aa0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00034ab0: 7373 6572 7420 7620 3d3d 2064 325b 6b5d  ssert v == d2[k]
+00034ac0: 2c20 286b 2c20 762c 2064 325b 6b5d 290a  , (k, v, d2[k]).
+00034ad0: 0a20 2020 2064 6566 205f 6368 6563 6b5f  .    def _check_
+00034ae0: 6571 7569 7661 6c65 6e74 2873 656c 662c  equivalent(self,
+00034af0: 2079 616d 6c5f 7061 7468 293a 0a20 2020   yaml_path):.   
+00034b00: 2020 2020 2022 2222 4368 6563 6b20 6966       """Check if
+00034b10: 2074 6865 2079 616d 6c20 6973 2065 7175   the yaml is equ
+00034b20: 6976 616c 656e 7420 6166 7465 7220 6c6f  ivalent after lo
+00034b30: 6164 2061 6e64 2064 756d 7020 6167 6169  ad and dump agai
+00034b40: 6e2e 2222 220a 2020 2020 2020 2020 6f72  n.""".        or
+00034b50: 6967 696e 5f74 6173 6b5f 636f 6e66 6967  igin_task_config
+00034b60: 203d 2063 6f6d 6d6f 6e5f 7574 696c 732e   = common_utils.
+00034b70: 7265 6164 5f79 616d 6c28 7961 6d6c 5f70  read_yaml(yaml_p
+00034b80: 6174 6829 0a0a 2020 2020 2020 2020 7461  ath)..        ta
+00034b90: 736b 203d 2073 6b79 2e54 6173 6b2e 6672  sk = sky.Task.fr
+00034ba0: 6f6d 5f79 616d 6c28 7961 6d6c 5f70 6174  om_yaml(yaml_pat
+00034bb0: 6829 0a20 2020 2020 2020 206e 6577 5f74  h).        new_t
+00034bc0: 6173 6b5f 636f 6e66 6967 203d 2074 6173  ask_config = tas
+00034bd0: 6b2e 746f 5f79 616d 6c5f 636f 6e66 6967  k.to_yaml_config
+00034be0: 2829 0a20 2020 2020 2020 2023 2064 3120  ().        # d1 
+00034bf0: 3c3d 2064 320a 2020 2020 2020 2020 7072  <= d2.        pr
+00034c00: 696e 7428 6f72 6967 696e 5f74 6173 6b5f  int(origin_task_
+00034c10: 636f 6e66 6967 2c20 6e65 775f 7461 736b  config, new_task
+00034c20: 5f63 6f6e 6669 6729 0a20 2020 2020 2020  _config).       
+00034c30: 2073 656c 662e 5f69 735f 6469 6374 5f73   self._is_dict_s
+00034c40: 7562 7365 7428 6f72 6967 696e 5f74 6173  ubset(origin_tas
+00034c50: 6b5f 636f 6e66 6967 2c20 6e65 775f 7461  k_config, new_ta
+00034c60: 736b 5f63 6f6e 6669 6729 0a0a 2020 2020  sk_config)..    
+00034c70: 6465 6620 7465 7374 5f6c 6f61 645f 6475  def test_load_du
+00034c80: 6d70 5f79 616d 6c5f 636f 6e66 6967 5f65  mp_yaml_config_e
+00034c90: 7175 6976 616c 656e 7428 7365 6c66 293a  quivalent(self):
+00034ca0: 0a20 2020 2020 2020 2022 2222 5465 7374  .        """Test
+00034cb0: 2069 6620 7468 6520 7961 6d6c 2063 6f6e   if the yaml con
+00034cc0: 6669 6720 6973 2065 7175 6976 616c 656e  fig is equivalen
+00034cd0: 7420 6166 7465 7220 6c6f 6164 2061 6e64  t after load and
+00034ce0: 2064 756d 7020 6167 6169 6e2e 2222 220a   dump again.""".
+00034cf0: 2020 2020 2020 2020 7061 7468 6c69 622e          pathlib.
+00034d00: 5061 7468 2827 7e2f 6461 7461 7365 7473  Path('~/datasets
+00034d10: 2729 2e65 7870 616e 6475 7365 7228 292e  ').expanduser().
+00034d20: 6d6b 6469 7228 6578 6973 745f 6f6b 3d54  mkdir(exist_ok=T
+00034d30: 7275 6529 0a20 2020 2020 2020 2070 6174  rue).        pat
+00034d40: 686c 6962 2e50 6174 6828 277e 2f74 6d70  hlib.Path('~/tmp
+00034d50: 6669 6c65 2729 2e65 7870 616e 6475 7365  file').expanduse
+00034d60: 7228 292e 746f 7563 6828 290a 2020 2020  r().touch().    
+00034d70: 2020 2020 7061 7468 6c69 622e 5061 7468      pathlib.Path
+00034d80: 2827 7e2f 2e73 7368 2729 2e65 7870 616e  ('~/.ssh').expan
+00034d90: 6475 7365 7228 292e 6d6b 6469 7228 6578  duser().mkdir(ex
+00034da0: 6973 745f 6f6b 3d54 7275 6529 0a20 2020  ist_ok=True).   
+00034db0: 2020 2020 2070 6174 686c 6962 2e50 6174       pathlib.Pat
+00034dc0: 6828 277e 2f2e 7373 682f 6964 5f72 7361  h('~/.ssh/id_rsa
+00034dd0: 2e70 7562 2729 2e65 7870 616e 6475 7365  .pub').expanduse
+00034de0: 7228 292e 746f 7563 6828 290a 2020 2020  r().touch().    
+00034df0: 2020 2020 7061 7468 6c69 622e 5061 7468      pathlib.Path
+00034e00: 2827 7e2f 746d 702d 776f 726b 6469 7227  ('~/tmp-workdir'
+00034e10: 292e 6578 7061 6e64 7573 6572 2829 2e6d  ).expanduser().m
+00034e20: 6b64 6972 2865 7869 7374 5f6f 6b3d 5472  kdir(exist_ok=Tr
+00034e30: 7565 290a 2020 2020 2020 2020 7061 7468  ue).        path
+00034e40: 6c69 622e 5061 7468 2827 7e2f 446f 776e  lib.Path('~/Down
+00034e50: 6c6f 6164 732f 7470 7527 292e 6578 7061  loads/tpu').expa
+00034e60: 6e64 7573 6572 2829 2e6d 6b64 6972 2870  nduser().mkdir(p
+00034e70: 6172 656e 7473 3d54 7275 652c 0a20 2020  arents=True,.   
+00034e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034eb0: 2020 2020 2020 2020 6578 6973 745f 6f6b          exist_ok
+00034ec0: 3d54 7275 6529 0a20 2020 2020 2020 2066  =True).        f
+00034ed0: 6f72 2079 616d 6c5f 7061 7468 2069 6e20  or yaml_path in 
+00034ee0: 7365 6c66 2e5f 5445 5354 5f59 414d 4c5f  self._TEST_YAML_
+00034ef0: 5041 5448 533a 0a20 2020 2020 2020 2020  PATHS:.         
+00034f00: 2020 2073 656c 662e 5f63 6865 636b 5f65     self._check_e
+00034f10: 7175 6976 616c 656e 7428 7961 6d6c 5f70  quivalent(yaml_p
+00034f20: 6174 6829 0a0a 0a23 202d 2d2d 2d2d 2d2d  ath)...# -------
+00034f30: 2d2d 2d20 5465 7374 696e 6720 4d75 6c74  --- Testing Mult
+00034f40: 6970 6c65 2041 6363 656c 6572 6174 6f72  iple Accelerator
+00034f50: 7320 2d2d 2d2d 2d2d 2d2d 2d2d 0a40 7079  s ----------.@py
+00034f60: 7465 7374 2e6d 6172 6b2e 6e6f 5f66 6c75  test.mark.no_flu
+00034f70: 6964 7374 6163 6b20 2023 2046 6c75 6964  idstack  # Fluid
+00034f80: 7374 6163 6b20 646f 6573 206e 6f74 2073  stack does not s
+00034f90: 7570 706f 7274 204b 3830 2067 7075 7320  upport K80 gpus 
+00034fa0: 666f 7220 6e6f 770a 4070 7974 6573 742e  for now.@pytest.
+00034fb0: 6d61 726b 2e6e 6f5f 7061 7065 7273 7061  mark.no_paperspa
+00034fc0: 6365 2020 2320 5061 7065 7273 7061 6365  ce  # Paperspace
+00034fd0: 2064 6f65 7320 6e6f 7420 7375 7070 6f72   does not suppor
+00034fe0: 7420 4b38 3020 6770 7573 0a64 6566 2074  t K80 gpus.def t
+00034ff0: 6573 745f 6d75 6c74 6970 6c65 5f61 6363  est_multiple_acc
+00035000: 656c 6572 6174 6f72 735f 6f72 6465 7265  elerators_ordere
+00035010: 6428 293a 0a20 2020 206e 616d 6520 3d20  d():.    name = 
+00035020: 5f67 6574 5f63 6c75 7374 6572 5f6e 616d  _get_cluster_nam
+00035030: 6528 290a 2020 2020 7465 7374 203d 2054  e().    test = T
+00035040: 6573 7428 0a20 2020 2020 2020 2027 6d75  est(.        'mu
+00035050: 6c74 6970 6c65 2d61 6363 656c 6572 6174  ltiple-accelerat
+00035060: 6f72 732d 6f72 6465 7265 6427 2c0a 2020  ors-ordered',.  
+00035070: 2020 2020 2020 5b0a 2020 2020 2020 2020        [.        
+00035080: 2020 2020 6627 736b 7920 6c61 756e 6368      f'sky launch
+00035090: 202d 7920 2d63 207b 6e61 6d65 7d20 7465   -y -c {name} te
+000350a0: 7374 732f 7465 7374 5f79 616d 6c73 2f74  sts/test_yamls/t
+000350b0: 6573 745f 6d75 6c74 6970 6c65 5f61 6363  est_multiple_acc
+000350c0: 656c 6572 6174 6f72 735f 6f72 6465 7265  elerators_ordere
+000350d0: 642e 7961 6d6c 207c 2067 7265 7020 2255  d.yaml | grep "U
+000350e0: 7369 6e67 2075 7365 722d 7370 6563 6966  sing user-specif
+000350f0: 6965 6420 6163 6365 6c65 7261 746f 7273  ied accelerators
+00035100: 206c 6973 7422 272c 0a20 2020 2020 2020   list"',.       
+00035110: 2020 2020 2066 2773 6b79 206c 6f67 7320       f'sky logs 
+00035120: 7b6e 616d 657d 2031 202d 2d73 7461 7475  {name} 1 --statu
+00035130: 7327 2c20 2023 2045 6e73 7572 6520 7468  s',  # Ensure th
+00035140: 6520 6a6f 6220 7375 6363 6565 6465 642e  e job succeeded.
+00035150: 0a20 2020 2020 2020 205d 2c0a 2020 2020  .        ],.    
+00035160: 2020 2020 6627 736b 7920 646f 776e 202d      f'sky down -
+00035170: 7920 7b6e 616d 657d 272c 0a20 2020 2020  y {name}',.     
+00035180: 2020 2074 696d 656f 7574 3d32 3020 2a20     timeout=20 * 
+00035190: 3630 2c0a 2020 2020 290a 2020 2020 7275  60,.    ).    ru
+000351a0: 6e5f 6f6e 655f 7465 7374 2874 6573 7429  n_one_test(test)
+000351b0: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+000351c0: 6e6f 5f66 6c75 6964 7374 6163 6b20 2023  no_fluidstack  #
+000351d0: 2046 6c75 6964 7374 6163 6b20 6861 7320   Fluidstack has 
+000351e0: 6c6f 7720 6176 6169 6c61 6269 6c69 7479  low availability
+000351f0: 2066 6f72 2054 3420 4750 5573 0a40 7079   for T4 GPUs.@py
+00035200: 7465 7374 2e6d 6172 6b2e 6e6f 5f70 6170  test.mark.no_pap
+00035210: 6572 7370 6163 6520 2023 2050 6170 6572  erspace  # Paper
+00035220: 7370 6163 6520 646f 6573 206e 6f74 2073  space does not s
+00035230: 7570 706f 7274 2054 3420 4750 5573 0a64  upport T4 GPUs.d
+00035240: 6566 2074 6573 745f 6d75 6c74 6970 6c65  ef test_multiple
+00035250: 5f61 6363 656c 6572 6174 6f72 735f 6f72  _accelerators_or
+00035260: 6465 7265 645f 7769 7468 5f64 6566 6175  dered_with_defau
+00035270: 6c74 2829 3a0a 2020 2020 6e61 6d65 203d  lt():.    name =
+00035280: 205f 6765 745f 636c 7573 7465 725f 6e61   _get_cluster_na
+00035290: 6d65 2829 0a20 2020 2074 6573 7420 3d20  me().    test = 
+000352a0: 5465 7374 280a 2020 2020 2020 2020 276d  Test(.        'm
+000352b0: 756c 7469 706c 652d 6163 6365 6c65 7261  ultiple-accelera
+000352c0: 746f 7273 2d6f 7264 6572 6564 272c 0a20  tors-ordered',. 
+000352d0: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+000352e0: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+000352f0: 6820 2d79 202d 6320 7b6e 616d 657d 2074  h -y -c {name} t
+00035300: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
+00035310: 7465 7374 5f6d 756c 7469 706c 655f 6163  test_multiple_ac
+00035320: 6365 6c65 7261 746f 7273 5f6f 7264 6572  celerators_order
+00035330: 6564 5f77 6974 685f 6465 6661 756c 742e  ed_with_default.
+00035340: 7961 6d6c 207c 2067 7265 7020 2255 7369  yaml | grep "Usi
+00035350: 6e67 2075 7365 722d 7370 6563 6966 6965  ng user-specifie
+00035360: 6420 6163 6365 6c65 7261 746f 7273 206c  d accelerators l
+00035370: 6973 7422 272c 0a20 2020 2020 2020 2020  ist"',.         
+00035380: 2020 2066 2773 6b79 206c 6f67 7320 7b6e     f'sky logs {n
+00035390: 616d 657d 2031 202d 2d73 7461 7475 7327  ame} 1 --status'
+000353a0: 2c20 2023 2045 6e73 7572 6520 7468 6520  ,  # Ensure the 
+000353b0: 6a6f 6220 7375 6363 6565 6465 642e 0a20  job succeeded.. 
+000353c0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000353d0: 2073 7461 7475 7320 7b6e 616d 657d 207c   status {name} |
+000353e0: 2067 7265 7020 5370 6f74 272c 0a20 2020   grep Spot',.   
+000353f0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+00035400: 6627 736b 7920 646f 776e 202d 7920 7b6e  f'sky down -y {n
+00035410: 616d 657d 272c 0a20 2020 2029 0a20 2020  ame}',.    ).   
+00035420: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+00035430: 7374 290a 0a0a 4070 7974 6573 742e 6d61  st)...@pytest.ma
+00035440: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
+00035450: 2020 2320 466c 7569 6473 7461 636b 2068    # Fluidstack h
+00035460: 6173 206c 6f77 2061 7661 696c 6162 696c  as low availabil
+00035470: 6974 7920 666f 7220 5434 2047 5055 730a  ity for T4 GPUs.
+00035480: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+00035490: 7061 7065 7273 7061 6365 2020 2320 5061  paperspace  # Pa
+000354a0: 7065 7273 7061 6365 2064 6f65 7320 6e6f  perspace does no
+000354b0: 7420 7375 7070 6f72 7420 5434 2047 5055  t support T4 GPU
+000354c0: 730a 6465 6620 7465 7374 5f6d 756c 7469  s.def test_multi
+000354d0: 706c 655f 6163 6365 6c65 7261 746f 7273  ple_accelerators
+000354e0: 5f75 6e6f 7264 6572 6564 2829 3a0a 2020  _unordered():.  
+000354f0: 2020 6e61 6d65 203d 205f 6765 745f 636c    name = _get_cl
+00035500: 7573 7465 725f 6e61 6d65 2829 0a20 2020  uster_name().   
+00035510: 2074 6573 7420 3d20 5465 7374 280a 2020   test = Test(.  
+00035520: 2020 2020 2020 276d 756c 7469 706c 652d        'multiple-
+00035530: 6163 6365 6c65 7261 746f 7273 2d75 6e6f  accelerators-uno
+00035540: 7264 6572 6564 272c 0a20 2020 2020 2020  rdered',.       
+00035550: 205b 0a20 2020 2020 2020 2020 2020 2066   [.            f
+00035560: 2773 6b79 206c 6175 6e63 6820 2d79 202d  'sky launch -y -
+00035570: 6320 7b6e 616d 657d 2074 6573 7473 2f74  c {name} tests/t
+00035580: 6573 745f 7961 6d6c 732f 7465 7374 5f6d  est_yamls/test_m
+00035590: 756c 7469 706c 655f 6163 6365 6c65 7261  ultiple_accelera
+000355a0: 746f 7273 5f75 6e6f 7264 6572 6564 2e79  tors_unordered.y
+000355b0: 616d 6c27 2c0a 2020 2020 2020 2020 2020  aml',.          
+000355c0: 2020 6627 736b 7920 6c6f 6773 207b 6e61    f'sky logs {na
+000355d0: 6d65 7d20 3120 2d2d 7374 6174 7573 272c  me} 1 --status',
+000355e0: 2020 2320 456e 7375 7265 2074 6865 206a    # Ensure the j
+000355f0: 6f62 2073 7563 6365 6564 6564 2e0a 2020  ob succeeded..  
+00035600: 2020 2020 2020 5d2c 0a20 2020 2020 2020        ],.       
+00035610: 2066 2773 6b79 2064 6f77 6e20 2d79 207b   f'sky down -y {
+00035620: 6e61 6d65 7d27 2c0a 2020 2020 290a 2020  name}',.    ).  
+00035630: 2020 7275 6e5f 6f6e 655f 7465 7374 2874    run_one_test(t
+00035640: 6573 7429 0a0a 0a40 7079 7465 7374 2e6d  est)...@pytest.m
+00035650: 6172 6b2e 6e6f 5f66 6c75 6964 7374 6163  ark.no_fluidstac
+00035660: 6b20 2023 2046 6c75 6964 7374 6163 6b20  k  # Fluidstack 
+00035670: 6861 7320 6c6f 7720 6176 6169 6c61 6269  has low availabi
+00035680: 6c69 7479 2066 6f72 2054 3420 4750 5573  lity for T4 GPUs
+00035690: 0a40 7079 7465 7374 2e6d 6172 6b2e 6e6f  .@pytest.mark.no
+000356a0: 5f70 6170 6572 7370 6163 6520 2023 2050  _paperspace  # P
+000356b0: 6170 6572 7370 6163 6520 646f 6573 206e  aperspace does n
+000356c0: 6f74 2073 7570 706f 7274 2054 3420 4750  ot support T4 GP
+000356d0: 5573 0a64 6566 2074 6573 745f 6d75 6c74  Us.def test_mult
+000356e0: 6970 6c65 5f61 6363 656c 6572 6174 6f72  iple_accelerator
+000356f0: 735f 756e 6f72 6465 7265 645f 7769 7468  s_unordered_with
+00035700: 5f64 6566 6175 6c74 2829 3a0a 2020 2020  _default():.    
+00035710: 6e61 6d65 203d 205f 6765 745f 636c 7573  name = _get_clus
+00035720: 7465 725f 6e61 6d65 2829 0a20 2020 2074  ter_name().    t
+00035730: 6573 7420 3d20 5465 7374 280a 2020 2020  est = Test(.    
+00035740: 2020 2020 276d 756c 7469 706c 652d 6163      'multiple-ac
+00035750: 6365 6c65 7261 746f 7273 2d75 6e6f 7264  celerators-unord
+00035760: 6572 6564 272c 0a20 2020 2020 2020 205b  ered',.        [
+00035770: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+00035780: 6b79 206c 6175 6e63 6820 2d79 202d 6320  ky launch -y -c 
+00035790: 7b6e 616d 657d 2074 6573 7473 2f74 6573  {name} tests/tes
+000357a0: 745f 7961 6d6c 732f 7465 7374 5f6d 756c  t_yamls/test_mul
+000357b0: 7469 706c 655f 6163 6365 6c65 7261 746f  tiple_accelerato
+000357c0: 7273 5f75 6e6f 7264 6572 6564 5f77 6974  rs_unordered_wit
+000357d0: 685f 6465 6661 756c 742e 7961 6d6c 272c  h_default.yaml',
+000357e0: 0a20 2020 2020 2020 2020 2020 2066 2773  .            f's
+000357f0: 6b79 206c 6f67 7320 7b6e 616d 657d 2031  ky logs {name} 1
+00035800: 202d 2d73 7461 7475 7327 2c20 2023 2045   --status',  # E
+00035810: 6e73 7572 6520 7468 6520 6a6f 6220 7375  nsure the job su
+00035820: 6363 6565 6465 642e 0a20 2020 2020 2020  cceeded..       
+00035830: 2020 2020 2066 2773 6b79 2073 7461 7475       f'sky statu
+00035840: 7320 7b6e 616d 657d 207c 2067 7265 7020  s {name} | grep 
+00035850: 5370 6f74 272c 0a20 2020 2020 2020 205d  Spot',.        ]
+00035860: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+00035870: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+00035880: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00035890: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+000358a0: 4070 7974 6573 742e 6d61 726b 2e6e 6f5f  @pytest.mark.no_
+000358b0: 666c 7569 6473 7461 636b 2020 2320 5265  fluidstack  # Re
+000358c0: 7175 6972 6573 206f 7468 6572 2063 6c6f  quires other clo
+000358d0: 7564 7320 746f 2062 6520 656e 6162 6c65  uds to be enable
+000358e0: 640a 6465 6620 7465 7374 5f6d 756c 7469  d.def test_multi
+000358f0: 706c 655f 7265 736f 7572 6365 7328 293a  ple_resources():
+00035900: 0a20 2020 206e 616d 6520 3d20 5f67 6574  .    name = _get
+00035910: 5f63 6c75 7374 6572 5f6e 616d 6528 290a  _cluster_name().
+00035920: 2020 2020 7465 7374 203d 2054 6573 7428      test = Test(
+00035930: 0a20 2020 2020 2020 2027 6d75 6c74 6970  .        'multip
+00035940: 6c65 2d72 6573 6f75 7263 6573 272c 0a20  le-resources',. 
+00035950: 2020 2020 2020 205b 0a20 2020 2020 2020         [.       
+00035960: 2020 2020 2066 2773 6b79 206c 6175 6e63       f'sky launc
+00035970: 6820 2d79 202d 6320 7b6e 616d 657d 2074  h -y -c {name} t
+00035980: 6573 7473 2f74 6573 745f 7961 6d6c 732f  ests/test_yamls/
+00035990: 7465 7374 5f6d 756c 7469 706c 655f 7265  test_multiple_re
+000359a0: 736f 7572 6365 732e 7961 6d6c 272c 0a20  sources.yaml',. 
+000359b0: 2020 2020 2020 2020 2020 2066 2773 6b79             f'sky
+000359c0: 206c 6f67 7320 7b6e 616d 657d 2031 202d   logs {name} 1 -
+000359d0: 2d73 7461 7475 7327 2c20 2023 2045 6e73  -status',  # Ens
+000359e0: 7572 6520 7468 6520 6a6f 6220 7375 6363  ure the job succ
+000359f0: 6565 6465 642e 0a20 2020 2020 2020 205d  eeded..        ]
+00035a00: 2c0a 2020 2020 2020 2020 6627 736b 7920  ,.        f'sky 
+00035a10: 646f 776e 202d 7920 7b6e 616d 657d 272c  down -y {name}',
+00035a20: 0a20 2020 2029 0a20 2020 2072 756e 5f6f  .    ).    run_o
+00035a30: 6e65 5f74 6573 7428 7465 7374 290a 0a0a  ne_test(test)...
+00035a40: 2320 2d2d 2d2d 2d2d 2d2d 2d2d 2053 6b79  # ---------- Sky
+00035a50: 2042 656e 6368 6d61 726b 202d 2d2d 2d2d   Benchmark -----
+00035a60: 2d2d 2d2d 2d0a 4070 7974 6573 742e 6d61  -----.@pytest.ma
+00035a70: 726b 2e6e 6f5f 666c 7569 6473 7461 636b  rk.no_fluidstack
+00035a80: 2020 2320 5265 7175 6972 6573 206f 7468    # Requires oth
+00035a90: 6572 2063 6c6f 7564 7320 746f 2062 6520  er clouds to be 
+00035aa0: 656e 6162 6c65 640a 4070 7974 6573 742e  enabled.@pytest.
+00035ab0: 6d61 726b 2e6e 6f5f 7061 7065 7273 7061  mark.no_paperspa
+00035ac0: 6365 2020 2320 5265 7175 6972 6573 206f  ce  # Requires o
+00035ad0: 7468 6572 2063 6c6f 7564 7320 746f 2062  ther clouds to b
+00035ae0: 6520 656e 6162 6c65 640a 4070 7974 6573  e enabled.@pytes
+00035af0: 742e 6d61 726b 2e6e 6f5f 6b75 6265 726e  t.mark.no_kubern
+00035b00: 6574 6573 0a64 6566 2074 6573 745f 736b  etes.def test_sk
+00035b10: 795f 6265 6e63 6828 6765 6e65 7269 635f  y_bench(generic_
+00035b20: 636c 6f75 643a 2073 7472 293a 0a20 2020  cloud: str):.   
+00035b30: 206e 616d 6520 3d20 5f67 6574 5f63 6c75   name = _get_clu
+00035b40: 7374 6572 5f6e 616d 6528 290a 2020 2020  ster_name().    
+00035b50: 7465 7374 203d 2054 6573 7428 0a20 2020  test = Test(.   
+00035b60: 2020 2020 2027 736b 792d 6265 6e63 6827       'sky-bench'
+00035b70: 2c0a 2020 2020 2020 2020 5b0a 2020 2020  ,.        [.    
+00035b80: 2020 2020 2020 2020 6627 736b 7920 6265          f'sky be
+00035b90: 6e63 6820 6c61 756e 6368 202d 7920 2d62  nch launch -y -b
+00035ba0: 207b 6e61 6d65 7d20 2d2d 636c 6f75 6420   {name} --cloud 
+00035bb0: 7b67 656e 6572 6963 5f63 6c6f 7564 7d20  {generic_cloud} 
+00035bc0: 2d69 3020 7465 7374 732f 7465 7374 5f79  -i0 tests/test_y
+00035bd0: 616d 6c73 2f6d 696e 696d 616c 2e79 616d  amls/minimal.yam
+00035be0: 6c27 2c0a 2020 2020 2020 2020 2020 2020  l',.            
+00035bf0: 2773 6c65 6570 2031 3230 272c 0a20 2020  'sleep 120',.   
+00035c00: 2020 2020 2020 2020 2066 2773 6b79 2062           f'sky b
+00035c10: 656e 6368 2073 686f 7720 7b6e 616d 657d  ench show {name}
+00035c20: 207c 2067 7265 7020 736b 792d 6265 6e63   | grep sky-benc
+00035c30: 682d 7b6e 616d 657d 207c 2067 7265 7020  h-{name} | grep 
+00035c40: 4649 4e49 5348 4544 272c 0a20 2020 2020  FINISHED',.     
+00035c50: 2020 205d 2c0a 2020 2020 2020 2020 6627     ],.        f'
+00035c60: 736b 7920 6265 6e63 6820 646f 776e 207b  sky bench down {
+00035c70: 6e61 6d65 7d20 2d79 3b20 736b 7920 6265  name} -y; sky be
+00035c80: 6e63 6820 6465 6c65 7465 207b 6e61 6d65  nch delete {name
+00035c90: 7d20 2d79 272c 0a20 2020 2029 0a20 2020  } -y',.    ).   
+00035ca0: 2072 756e 5f6f 6e65 5f74 6573 7428 7465   run_one_test(te
+00035cb0: 7374 290a                                st).
```

### Comparing `skypilot-0.5.0/tests/test_storage.py` & `skypilot-0.6.0/tests/test_storage.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/tests/test_wheels.py` & `skypilot-0.6.0/tests/test_wheels.py`

 * *Files identical despite different names*

### Comparing `skypilot-0.5.0/tests/test_yaml_parser.py` & `skypilot-0.6.0/tests/test_yaml_parser.py`

 * *Files 25% similar despite different names*

```diff
@@ -107,7 +107,42 @@
                 /datasets-storage:
                     name: sky-dataset
                     not_a_valid_field:
             """), tmp_path)
     with pytest.raises(AssertionError) as e:
         Task.from_yaml(config_path)
     assert 'Invalid storage args' in e.value.args[0]
+
+
+def test_invalid_envs_key(tmp_path):
+    config_path = _create_config_file(
+        textwrap.dedent(f"""\
+            envs:
+                invalid_env_$_key: value
+            """), tmp_path)
+    with pytest.raises(ValueError) as e:
+        Task.from_yaml(config_path)
+    assert 'does not match any of the regexes:' in e.value.args[0]
+
+
+def test_invalid_envs_type(tmp_path):
+    config_path = _create_config_file(
+        textwrap.dedent(f"""\
+            envs:
+                - env_key1: abc
+                - env_key2: abc
+            """), tmp_path)
+    with pytest.raises(ValueError) as e:
+        Task.from_yaml(config_path)
+    assert 'is not of type \'dict\'' in e.value.args[0]
+
+
+def test_invalid_empty_envs(tmp_path):
+    config_path = _create_config_file(
+        textwrap.dedent(f"""\
+            envs:
+                env_key1: abc
+                env_key2:
+            """), tmp_path)
+    with pytest.raises(ValueError) as e:
+        Task.from_yaml(config_path)
+    assert 'Environment variable \'env_key2\' is None.' in e.value.args[0]
```

