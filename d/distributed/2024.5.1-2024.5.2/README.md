# Comparing `tmp/distributed-2024.5.1.tar.gz` & `tmp/distributed-2024.5.2.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "distributed-2024.5.1.tar", last modified: Fri May 17 20:08:13 2024, max compression
+gzip compressed data, was "distributed-2024.5.2.tar", last modified: Fri May 31 21:11:42 2024, max compression
```

## Comparing `distributed-2024.5.1.tar` & `distributed-2024.5.2.tar`

### file list

```diff
@@ -1,308 +1,308 @@
-drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-17 20:08:13.450828 distributed-2024.5.1/
--rw-r--r--   0 james      (501) staff       (20)      104 2023-07-17 19:50:47.000000 distributed-2024.5.1/AUTHORS.md
--rw-r--r--   0 james      (501) staff       (20)     1533 2023-07-17 19:51:10.000000 distributed-2024.5.1/LICENSE.txt
--rw-r--r--   0 james      (501) staff       (20)      633 2023-07-17 19:51:10.000000 distributed-2024.5.1/MANIFEST.in
--rw-r--r--   0 james      (501) staff       (20)     3344 2024-05-17 20:08:13.450526 distributed-2024.5.1/PKG-INFO
--rw-r--r--   0 james      (501) staff       (20)     1801 2023-07-17 19:51:10.000000 distributed-2024.5.1/README.rst
-drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-17 20:08:13.393307 distributed-2024.5.1/distributed/
--rw-r--r--   0 james      (501) staff       (20)     4265 2024-01-26 22:03:47.000000 distributed-2024.5.1/distributed/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     2090 2023-10-13 21:59:50.000000 distributed-2024.5.1/distributed/_asyncio.py
--rw-r--r--   0 james      (501) staff       (20)     5528 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/_concurrent_futures_thread.py
--rw-r--r--   0 james      (501) staff       (20)     1325 2023-08-21 21:39:28.000000 distributed-2024.5.1/distributed/_signals.py
--rw-r--r--   0 james      (501) staff       (20)     1459 2023-10-13 21:59:50.000000 distributed-2024.5.1/distributed/_stories.py
--rw-r--r--   0 james      (501) staff       (20)      500 2024-05-17 20:08:13.451024 distributed-2024.5.1/distributed/_version.py
--rw-r--r--   0 james      (501) staff       (20)    29675 2023-12-01 22:10:13.000000 distributed-2024.5.1/distributed/active_memory_manager.py
--rw-r--r--   0 james      (501) staff       (20)     9538 2024-01-12 19:19:58.000000 distributed-2024.5.1/distributed/actor.py
--rw-r--r--   0 james      (501) staff       (20)     7342 2023-09-27 18:27:06.000000 distributed-2024.5.1/distributed/batched.py
--rw-r--r--   0 james      (501) staff       (20)      121 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/bokeh.py
--rw-r--r--   0 james      (501) staff       (20)     5742 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/cfexecutor.py
--rw-r--r--   0 james      (501) staff       (20)     1947 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/chaos.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-17 20:08:13.396264 distributed-2024.5.1/distributed/cli/
--rw-r--r--   0 james      (501) staff       (20)        0 2023-07-17 19:50:47.000000 distributed-2024.5.1/distributed/cli/__init__.py
--rwxr-xr-x   0 james      (501) staff       (20)     7242 2023-08-21 21:39:28.000000 distributed-2024.5.1/distributed/cli/dask_scheduler.py
--rw-r--r--   0 james      (501) staff       (20)     2104 2023-10-23 15:00:29.000000 distributed-2024.5.1/distributed/cli/dask_spec.py
--rwxr-xr-x   0 james      (501) staff       (20)     5468 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/cli/dask_ssh.py
--rwxr-xr-x   0 james      (501) staff       (20)    16153 2023-08-21 21:39:28.000000 distributed-2024.5.1/distributed/cli/dask_worker.py
--rw-r--r--   0 james      (501) staff       (20)     1092 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/cli/utils.py
--rw-r--r--   0 james      (501) staff       (20)   213470 2024-04-15 18:21:07.000000 distributed-2024.5.1/distributed/client.py
--rw-r--r--   0 james      (501) staff       (20)    10995 2023-10-13 21:59:50.000000 distributed-2024.5.1/distributed/cluster_dump.py
--rw-r--r--   0 james      (501) staff       (20)     7099 2023-08-21 21:39:28.000000 distributed-2024.5.1/distributed/collections.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-17 20:08:13.398706 distributed-2024.5.1/distributed/comm/
--rw-r--r--   0 james      (501) staff       (20)      759 2023-12-01 22:10:13.000000 distributed-2024.5.1/distributed/comm/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     8597 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/comm/addressing.py
--rw-r--r--   0 james      (501) staff       (20)    12721 2023-08-21 21:39:28.000000 distributed-2024.5.1/distributed/comm/core.py
--rw-r--r--   0 james      (501) staff       (20)    10515 2024-04-19 20:54:28.000000 distributed-2024.5.1/distributed/comm/inproc.py
--rw-r--r--   0 james      (501) staff       (20)     2815 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/comm/registry.py
--rw-r--r--   0 james      (501) staff       (20)    26549 2024-03-13 20:03:34.000000 distributed-2024.5.1/distributed/comm/tcp.py
--rw-r--r--   0 james      (501) staff       (20)    23014 2023-11-07 17:11:41.000000 distributed-2024.5.1/distributed/comm/ucx.py
--rw-r--r--   0 james      (501) staff       (20)     3758 2023-11-07 17:11:41.000000 distributed-2024.5.1/distributed/comm/utils.py
--rw-r--r--   0 james      (501) staff       (20)    14903 2023-08-21 21:39:28.000000 distributed-2024.5.1/distributed/comm/ws.py
--rw-r--r--   0 james      (501) staff       (20)    10114 2023-08-21 21:39:28.000000 distributed-2024.5.1/distributed/compatibility.py
--rw-r--r--   0 james      (501) staff       (20)     7826 2023-09-27 18:27:06.000000 distributed-2024.5.1/distributed/config.py
--rw-r--r--   0 james      (501) staff       (20)    61536 2024-01-26 22:03:47.000000 distributed-2024.5.1/distributed/core.py
--rw-r--r--   0 james      (501) staff       (20)     2134 2023-10-23 15:00:29.000000 distributed-2024.5.1/distributed/counter.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-17 20:08:13.400591 distributed-2024.5.1/distributed/dashboard/
--rw-r--r--   0 james      (501) staff       (20)        0 2023-07-17 19:50:47.000000 distributed-2024.5.1/distributed/dashboard/__init__.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-17 20:08:13.404571 distributed-2024.5.1/distributed/dashboard/components/
--rw-r--r--   0 james      (501) staff       (20)     1550 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/dashboard/components/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     5775 2024-04-01 19:12:58.000000 distributed-2024.5.1/distributed/dashboard/components/nvml.py
--rw-r--r--   0 james      (501) staff       (20)     7154 2024-01-12 19:19:58.000000 distributed-2024.5.1/distributed/dashboard/components/rmm.py
--rw-r--r--   0 james      (501) staff       (20)   162585 2024-04-01 19:12:54.000000 distributed-2024.5.1/distributed/dashboard/components/scheduler.py
--rw-r--r--   0 james      (501) staff       (20)    19429 2023-12-01 22:10:13.000000 distributed-2024.5.1/distributed/dashboard/components/shared.py
--rw-r--r--   0 james      (501) staff       (20)    15424 2023-10-27 21:35:57.000000 distributed-2024.5.1/distributed/dashboard/components/worker.py
--rw-r--r--   0 james      (501) staff       (20)     2232 2023-12-01 22:10:13.000000 distributed-2024.5.1/distributed/dashboard/core.py
--rw-r--r--   0 james      (501) staff       (20)     2313 2023-07-17 19:50:47.000000 distributed-2024.5.1/distributed/dashboard/export_tool.js
--rw-r--r--   0 james      (501) staff       (20)      763 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/dashboard/export_tool.py
--rw-r--r--   0 james      (501) staff       (20)     5908 2023-11-07 17:11:41.000000 distributed-2024.5.1/distributed/dashboard/scheduler.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-17 20:08:13.405162 distributed-2024.5.1/distributed/dashboard/templates/
--rw-r--r--   0 james      (501) staff       (20)        0 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/dashboard/templates/__init__.py
--rw-r--r--   0 james      (501) staff       (20)      241 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/dashboard/templates/performance_report.html
--rw-r--r--   0 james      (501) staff       (20)      199 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/dashboard/theme.yaml
--rw-r--r--   0 james      (501) staff       (20)     1732 2023-08-21 21:39:28.000000 distributed-2024.5.1/distributed/dashboard/utils.py
--rw-r--r--   0 james      (501) staff       (20)      840 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/dashboard/worker.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-17 20:08:13.407536 distributed-2024.5.1/distributed/deploy/
--rw-r--r--   0 james      (501) staff       (20)      466 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/deploy/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     6702 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/deploy/adaptive.py
--rw-r--r--   0 james      (501) staff       (20)     7895 2023-09-27 18:27:06.000000 distributed-2024.5.1/distributed/deploy/adaptive_core.py
--rw-r--r--   0 james      (501) staff       (20)    21271 2023-12-01 22:10:13.000000 distributed-2024.5.1/distributed/deploy/cluster.py
--rw-r--r--   0 james      (501) staff       (20)    10452 2023-08-21 21:39:28.000000 distributed-2024.5.1/distributed/deploy/local.py
--rw-r--r--   0 james      (501) staff       (20)    15514 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/deploy/old_ssh.py
--rw-r--r--   0 james      (501) staff       (20)    23933 2023-12-01 22:10:13.000000 distributed-2024.5.1/distributed/deploy/spec.py
--rw-r--r--   0 james      (501) staff       (20)    15265 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/deploy/ssh.py
--rw-r--r--   0 james      (501) staff       (20)     8543 2023-12-15 20:02:12.000000 distributed-2024.5.1/distributed/deploy/subprocess.py
--rw-r--r--   0 james      (501) staff       (20)      888 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/deploy/utils.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-17 20:08:13.411231 distributed-2024.5.1/distributed/diagnostics/
--rw-r--r--   0 james      (501) staff       (20)      221 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/diagnostics/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     1302 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/diagnostics/cluster_dump.py
--rw-r--r--   0 james      (501) staff       (20)      564 2024-01-12 19:19:58.000000 distributed-2024.5.1/distributed/diagnostics/cudf.py
--rw-r--r--   0 james      (501) staff       (20)     2190 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/diagnostics/eventstream.py
--rw-r--r--   0 james      (501) staff       (20)     5207 2023-08-21 21:39:28.000000 distributed-2024.5.1/distributed/diagnostics/graph_layout.py
--rw-r--r--   0 james      (501) staff       (20)     7017 2023-09-13 17:55:47.000000 distributed-2024.5.1/distributed/diagnostics/memory_sampler.py
--rw-r--r--   0 james      (501) staff       (20)     8388 2024-04-19 20:54:28.000000 distributed-2024.5.1/distributed/diagnostics/memray.py
--rw-r--r--   0 james      (501) staff       (20)    10781 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/diagnostics/nvml.py
--rw-r--r--   0 james      (501) staff       (20)    34059 2024-05-17 19:53:51.000000 distributed-2024.5.1/distributed/diagnostics/plugin.py
--rw-r--r--   0 james      (501) staff       (20)    13904 2023-10-23 15:00:29.000000 distributed-2024.5.1/distributed/diagnostics/progress.py
--rw-r--r--   0 james      (501) staff       (20)     6063 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/diagnostics/progress_stream.py
--rw-r--r--   0 james      (501) staff       (20)    15800 2023-08-21 21:39:28.000000 distributed-2024.5.1/distributed/diagnostics/progressbar.py
--rw-r--r--   0 james      (501) staff       (20)     1124 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/diagnostics/rmm.py
--rw-r--r--   0 james      (501) staff       (20)     5677 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/diagnostics/task_stream.py
--rw-r--r--   0 james      (501) staff       (20)     2513 2023-08-21 21:39:28.000000 distributed-2024.5.1/distributed/diagnostics/websocket.py
--rw-r--r--   0 james      (501) staff       (20)     9407 2023-10-13 21:59:50.000000 distributed-2024.5.1/distributed/diskutils.py
--rw-r--r--   0 james      (501) staff       (20)    48005 2024-03-13 20:03:34.000000 distributed-2024.5.1/distributed/distributed-schema.yaml
--rw-r--r--   0 james      (501) staff       (20)    15035 2024-03-15 18:22:29.000000 distributed-2024.5.1/distributed/distributed.yaml
--rw-r--r--   0 james      (501) staff       (20)     8536 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/event.py
--rw-r--r--   0 james      (501) staff       (20)      586 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/exceptions.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-17 20:08:13.412978 distributed-2024.5.1/distributed/http/
--rw-r--r--   0 james      (501) staff       (20)       84 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/http/__init__.py
--rw-r--r--   0 james      (501) staff       (20)      273 2023-10-13 21:59:50.000000 distributed-2024.5.1/distributed/http/health.py
--rw-r--r--   0 james      (501) staff       (20)     1480 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/http/prometheus.py
--rw-r--r--   0 james      (501) staff       (20)     4925 2024-04-01 19:12:54.000000 distributed-2024.5.1/distributed/http/proxy.py
--rw-r--r--   0 james      (501) staff       (20)     2548 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/http/routing.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-17 20:08:13.413962 distributed-2024.5.1/distributed/http/scheduler/
--rw-r--r--   0 james      (501) staff       (20)        0 2023-07-17 19:50:47.000000 distributed-2024.5.1/distributed/http/scheduler/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     2914 2023-10-13 21:59:50.000000 distributed-2024.5.1/distributed/http/scheduler/api.py
--rw-r--r--   0 james      (501) staff       (20)     8359 2023-12-01 22:10:13.000000 distributed-2024.5.1/distributed/http/scheduler/info.py
--rw-r--r--   0 james      (501) staff       (20)     2159 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/http/scheduler/json.py
--rw-r--r--   0 james      (501) staff       (20)      625 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/http/scheduler/missing_bokeh.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-17 20:08:13.415068 distributed-2024.5.1/distributed/http/scheduler/prometheus/
--rw-r--r--   0 james      (501) staff       (20)      291 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/http/scheduler/prometheus/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     7080 2024-03-15 18:22:29.000000 distributed-2024.5.1/distributed/http/scheduler/prometheus/core.py
--rw-r--r--   0 james      (501) staff       (20)     3514 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/http/scheduler/prometheus/semaphore.py
--rw-r--r--   0 james      (501) staff       (20)     1617 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/http/scheduler/prometheus/stealing.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-17 20:08:13.415346 distributed-2024.5.1/distributed/http/static/
--rw-r--r--   0 james      (501) staff       (20)        0 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/http/static/__init__.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-17 20:08:13.416553 distributed-2024.5.1/distributed/http/static/css/
--rw-r--r--   0 james      (501) staff       (20)        0 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/http/static/css/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     2260 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/http/static/css/base.css
--rw-r--r--   0 james      (501) staff       (20)      250 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/http/static/css/gpu.css
--rw-r--r--   0 james      (501) staff       (20)      840 2023-07-17 19:50:47.000000 distributed-2024.5.1/distributed/http/static/css/individual-cluster-map.css
--rw-r--r--   0 james      (501) staff       (20)     1557 2023-09-13 17:55:47.000000 distributed-2024.5.1/distributed/http/static/css/sortable.min.css
--rw-r--r--   0 james      (501) staff       (20)     1012 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/http/static/css/status.css
-drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-17 20:08:13.417945 distributed-2024.5.1/distributed/http/static/images/
--rw-r--r--   0 james      (501) staff       (20)        0 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/http/static/images/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     1607 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/http/static/images/dask-logo.svg
--rw-r--r--   0 james      (501) staff       (20)      552 2023-07-17 19:50:47.000000 distributed-2024.5.1/distributed/http/static/images/fa-bars.svg
--rw-r--r--   0 james      (501) staff       (20)    15086 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/http/static/images/favicon.ico
--rw-r--r--   0 james      (501) staff       (20)    11002 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/http/static/images/jupyter.svg
--rw-r--r--   0 james      (501) staff       (20)    18663 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/http/static/images/numpy.png
--rw-r--r--   0 james      (501) staff       (20)     1213 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/http/static/images/pandas.png
--rw-r--r--   0 james      (501) staff       (20)   830916 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/http/static/images/python.png
--rw-r--r--   0 james      (501) staff       (20)      667 2023-07-17 19:50:47.000000 distributed-2024.5.1/distributed/http/static/individual-cluster-map.html
-drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-17 20:08:13.420341 distributed-2024.5.1/distributed/http/static/js/
--rw-r--r--   0 james      (501) staff       (20)        0 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/http/static/js/__init__.py
--rw-r--r--   0 james      (501) staff       (20)    17271 2023-07-17 19:50:47.000000 distributed-2024.5.1/distributed/http/static/js/anime.min.js
--rw-r--r--   0 james      (501) staff       (20)     9337 2023-07-17 19:50:47.000000 distributed-2024.5.1/distributed/http/static/js/individual-cluster-map.js
--rw-r--r--   0 james      (501) staff       (20)     3276 2023-07-17 19:50:47.000000 distributed-2024.5.1/distributed/http/static/js/reconnecting-websocket.min.js
--rw-r--r--   0 james      (501) staff       (20)     1194 2023-09-13 17:55:47.000000 distributed-2024.5.1/distributed/http/static/js/sortable.min.js
--rw-r--r--   0 james      (501) staff       (20)      223 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/http/statics.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-17 20:08:13.423052 distributed-2024.5.1/distributed/http/templates/
--rw-r--r--   0 james      (501) staff       (20)        0 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/http/templates/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     2930 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/http/templates/base.html
--rw-r--r--   0 james      (501) staff       (20)      388 2023-07-17 19:50:47.000000 distributed-2024.5.1/distributed/http/templates/call-stack.html
--rw-r--r--   0 james      (501) staff       (20)     1351 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/http/templates/exceptions.html
--rw-r--r--   0 james      (501) staff       (20)      404 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/http/templates/gpu.html
--rw-r--r--   0 james      (501) staff       (20)      276 2023-07-17 19:50:47.000000 distributed-2024.5.1/distributed/http/templates/json-index.html
--rw-r--r--   0 james      (501) staff       (20)      116 2023-07-17 19:50:47.000000 distributed-2024.5.1/distributed/http/templates/logs.html
--rw-r--r--   0 james      (501) staff       (20)      522 2023-09-13 17:55:47.000000 distributed-2024.5.1/distributed/http/templates/main.html
--rw-r--r--   0 james      (501) staff       (20)       95 2023-07-17 19:50:47.000000 distributed-2024.5.1/distributed/http/templates/simple.html
--rw-r--r--   0 james      (501) staff       (20)      635 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/http/templates/status.html
--rw-r--r--   0 james      (501) staff       (20)     5726 2023-09-13 17:55:47.000000 distributed-2024.5.1/distributed/http/templates/task.html
--rw-r--r--   0 james      (501) staff       (20)     1601 2023-09-13 17:55:47.000000 distributed-2024.5.1/distributed/http/templates/worker-table.html
--rw-r--r--   0 james      (501) staff       (20)     2034 2023-09-13 17:55:47.000000 distributed-2024.5.1/distributed/http/templates/worker.html
--rw-r--r--   0 james      (501) staff       (20)      457 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/http/templates/workers.html
--rw-r--r--   0 james      (501) staff       (20)     1184 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/http/utils.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-17 20:08:13.423207 distributed-2024.5.1/distributed/http/worker/
--rw-r--r--   0 james      (501) staff       (20)        0 2023-07-17 19:50:47.000000 distributed-2024.5.1/distributed/http/worker/__init__.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-17 20:08:13.423474 distributed-2024.5.1/distributed/http/worker/prometheus/
--rw-r--r--   0 james      (501) staff       (20)      288 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/http/worker/prometheus/__init__.py
--rw-r--r--   0 james      (501) staff       (20)    10039 2024-03-15 18:22:29.000000 distributed-2024.5.1/distributed/http/worker/prometheus/core.py
--rw-r--r--   0 james      (501) staff       (20)     1170 2023-08-21 21:39:28.000000 distributed-2024.5.1/distributed/itertools.py
--rw-r--r--   0 james      (501) staff       (20)     5599 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/lock.py
--rwxr-xr-x   0 james      (501) staff       (20)    14428 2024-05-17 19:53:58.000000 distributed-2024.5.1/distributed/metrics.py
--rw-r--r--   0 james      (501) staff       (20)     8044 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/multi_lock.py
--rw-r--r--   0 james      (501) staff       (20)    35101 2024-04-15 18:21:07.000000 distributed-2024.5.1/distributed/nanny.py
--rw-r--r--   0 james      (501) staff       (20)     6710 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/node.py
--rw-r--r--   0 james      (501) staff       (20)     1449 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/objects.py
--rw-r--r--   0 james      (501) staff       (20)     8356 2023-08-21 21:39:28.000000 distributed-2024.5.1/distributed/preloading.py
--rw-r--r--   0 james      (501) staff       (20)    12887 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/process.py
--rw-r--r--   0 james      (501) staff       (20)      931 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/proctitle.py
--rw-r--r--   0 james      (501) staff       (20)    16996 2023-10-13 21:59:50.000000 distributed-2024.5.1/distributed/profile.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-17 20:08:13.427764 distributed-2024.5.1/distributed/protocol/
--rw-r--r--   0 james      (501) staff       (20)     3390 2024-04-19 20:54:28.000000 distributed-2024.5.1/distributed/protocol/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     1336 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/protocol/arrow.py
--rw-r--r--   0 james      (501) staff       (20)     6671 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/protocol/compression.py
--rw-r--r--   0 james      (501) staff       (20)     6831 2024-01-12 19:19:58.000000 distributed-2024.5.1/distributed/protocol/core.py
--rw-r--r--   0 james      (501) staff       (20)     1181 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/protocol/cuda.py
--rw-r--r--   0 james      (501) staff       (20)     2931 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/protocol/cupy.py
--rw-r--r--   0 james      (501) staff       (20)      836 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/protocol/h5py.py
--rw-r--r--   0 james      (501) staff       (20)     1127 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/protocol/keras.py
--rw-r--r--   0 james      (501) staff       (20)     1466 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/protocol/netcdf4.py
--rw-r--r--   0 james      (501) staff       (20)     2139 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/protocol/numba.py
--rw-r--r--   0 james      (501) staff       (20)     7030 2024-01-26 22:03:47.000000 distributed-2024.5.1/distributed/protocol/numpy.py
--rw-r--r--   0 james      (501) staff       (20)     3041 2023-08-21 21:39:28.000000 distributed-2024.5.1/distributed/protocol/pickle.py
--rw-r--r--   0 james      (501) staff       (20)     1507 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/protocol/rmm.py
--rw-r--r--   0 james      (501) staff       (20)      792 2024-01-26 22:03:47.000000 distributed-2024.5.1/distributed/protocol/scipy.py
--rw-r--r--   0 james      (501) staff       (20)    30056 2024-04-19 20:54:28.000000 distributed-2024.5.1/distributed/protocol/serialize.py
--rw-r--r--   0 james      (501) staff       (20)      955 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/protocol/sparse.py
--rw-r--r--   0 james      (501) staff       (20)     1993 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/protocol/torch.py
--rw-r--r--   0 james      (501) staff       (20)     8314 2024-03-13 20:03:34.000000 distributed-2024.5.1/distributed/protocol/utils.py
--rw-r--r--   0 james      (501) staff       (20)      795 2023-11-07 17:11:41.000000 distributed-2024.5.1/distributed/protocol/utils_test.py
--rw-r--r--   0 james      (501) staff       (20)     4226 2024-04-15 18:21:07.000000 distributed-2024.5.1/distributed/publish.py
--rw-r--r--   0 james      (501) staff       (20)    15643 2023-10-23 15:00:29.000000 distributed-2024.5.1/distributed/pubsub.py
--rw-r--r--   0 james      (501) staff       (20)        0 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/py.typed
--rw-r--r--   0 james      (501) staff       (20)    10054 2023-10-23 15:00:29.000000 distributed-2024.5.1/distributed/queues.py
--rw-r--r--   0 james      (501) staff       (20)     7419 2023-09-13 17:55:47.000000 distributed-2024.5.1/distributed/recreate_tasks.py
--rw-r--r--   0 james      (501) staff       (20)   327685 2024-04-19 20:54:28.000000 distributed-2024.5.1/distributed/scheduler.py
--rw-r--r--   0 james      (501) staff       (20)    13867 2023-10-13 21:59:50.000000 distributed-2024.5.1/distributed/security.py
--rw-r--r--   0 james      (501) staff       (20)    20568 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/semaphore.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-17 20:08:13.432295 distributed-2024.5.1/distributed/shuffle/
--rw-r--r--   0 james      (501) staff       (20)      674 2023-08-21 21:39:28.000000 distributed-2024.5.1/distributed/shuffle/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     6394 2024-04-01 19:12:58.000000 distributed-2024.5.1/distributed/shuffle/_arrow.py
--rw-r--r--   0 james      (501) staff       (20)     9330 2024-01-12 19:19:58.000000 distributed-2024.5.1/distributed/shuffle/_buffer.py
--rw-r--r--   0 james      (501) staff       (20)     2481 2024-01-12 19:19:58.000000 distributed-2024.5.1/distributed/shuffle/_comms.py
--rw-r--r--   0 james      (501) staff       (20)    17734 2024-03-13 20:03:34.000000 distributed-2024.5.1/distributed/shuffle/_core.py
--rw-r--r--   0 james      (501) staff       (20)     7924 2024-03-13 20:03:34.000000 distributed-2024.5.1/distributed/shuffle/_disk.py
--rw-r--r--   0 james      (501) staff       (20)      180 2024-03-13 20:03:34.000000 distributed-2024.5.1/distributed/shuffle/_exceptions.py
--rw-r--r--   0 james      (501) staff       (20)     2798 2024-01-12 19:19:58.000000 distributed-2024.5.1/distributed/shuffle/_limiter.py
--rw-r--r--   0 james      (501) staff       (20)     1531 2024-03-13 20:03:34.000000 distributed-2024.5.1/distributed/shuffle/_memory.py
--rw-r--r--   0 james      (501) staff       (20)    14022 2024-03-15 18:22:29.000000 distributed-2024.5.1/distributed/shuffle/_merge.py
--rw-r--r--   0 james      (501) staff       (20)     1186 2023-11-07 17:11:41.000000 distributed-2024.5.1/distributed/shuffle/_pickle.py
--rw-r--r--   0 james      (501) staff       (20)    26857 2024-01-12 19:19:58.000000 distributed-2024.5.1/distributed/shuffle/_rechunk.py
--rw-r--r--   0 james      (501) staff       (20)    18821 2024-04-15 18:21:07.000000 distributed-2024.5.1/distributed/shuffle/_scheduler_plugin.py
--rw-r--r--   0 james      (501) staff       (20)    18581 2024-03-15 18:22:29.000000 distributed-2024.5.1/distributed/shuffle/_shuffle.py
--rw-r--r--   0 james      (501) staff       (20)    14591 2024-03-13 20:03:34.000000 distributed-2024.5.1/distributed/shuffle/_worker_plugin.py
--rw-r--r--   0 james      (501) staff       (20)      670 2024-05-03 20:25:17.000000 distributed-2024.5.1/distributed/sizeof.py
--rw-r--r--   0 james      (501) staff       (20)    23191 2024-01-12 19:19:58.000000 distributed-2024.5.1/distributed/spans.py
--rw-r--r--   0 james      (501) staff       (20)    13767 2023-12-15 20:02:12.000000 distributed-2024.5.1/distributed/spill.py
--rw-r--r--   0 james      (501) staff       (20)    19711 2024-03-15 18:22:29.000000 distributed-2024.5.1/distributed/stealing.py
--rw-r--r--   0 james      (501) staff       (20)     1952 2023-10-13 21:59:50.000000 distributed-2024.5.1/distributed/system.py
--rw-r--r--   0 james      (501) staff       (20)     8971 2024-04-01 19:12:58.000000 distributed-2024.5.1/distributed/system_monitor.py
--rw-r--r--   0 james      (501) staff       (20)     7104 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/threadpoolexecutor.py
--rw-r--r--   0 james      (501) staff       (20)    58512 2024-04-01 19:12:54.000000 distributed-2024.5.1/distributed/utils.py
--rw-r--r--   0 james      (501) staff       (20)    14586 2024-04-15 18:21:07.000000 distributed-2024.5.1/distributed/utils_comm.py
--rw-r--r--   0 james      (501) staff       (20)     8050 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/utils_perf.py
--rw-r--r--   0 james      (501) staff       (20)    83804 2024-04-01 19:12:54.000000 distributed-2024.5.1/distributed/utils_test.py
--rw-r--r--   0 james      (501) staff       (20)     8411 2023-08-31 20:57:51.000000 distributed-2024.5.1/distributed/variable.py
--rw-r--r--   0 james      (501) staff       (20)     5165 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/versions.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-17 20:08:13.432946 distributed-2024.5.1/distributed/widgets/
--rw-r--r--   0 james      (501) staff       (20)      267 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/widgets/__init__.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-17 20:08:13.436756 distributed-2024.5.1/distributed/widgets/templates/
--rw-r--r--   0 james      (501) staff       (20)        0 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/widgets/templates/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     2265 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/widgets/templates/client.html.j2
--rw-r--r--   0 james      (501) staff       (20)     1589 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/widgets/templates/cluster.html.j2
--rw-r--r--   0 james      (501) staff       (20)     1270 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/widgets/templates/computation.html.j2
--rw-r--r--   0 james      (501) staff       (20)      518 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/widgets/templates/future.html.j2
--rw-r--r--   0 james      (501) staff       (20)      544 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/widgets/templates/has_what.html.j2
--rw-r--r--   0 james      (501) staff       (20)      234 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/widgets/templates/local_cluster.html.j2
--rw-r--r--   0 james      (501) staff       (20)      636 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/widgets/templates/log.html.j2
--rw-r--r--   0 james      (501) staff       (20)      168 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/widgets/templates/logs.html.j2
--rw-r--r--   0 james      (501) staff       (20)     1290 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/widgets/templates/process_interface.html.j2
--rw-r--r--   0 james      (501) staff       (20)      317 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/widgets/templates/scheduler.html.j2
--rw-r--r--   0 james      (501) staff       (20)     6705 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/widgets/templates/scheduler_info.html.j2
--rw-r--r--   0 james      (501) staff       (20)      407 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/widgets/templates/security.html.j2
--rw-r--r--   0 james      (501) staff       (20)      448 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/widgets/templates/task_state.html.j2
--rw-r--r--   0 james      (501) staff       (20)      295 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/widgets/templates/who_has.html.j2
--rw-r--r--   0 james      (501) staff       (20)      407 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/widgets/templates/worker_state.html.j2
--rw-r--r--   0 james      (501) staff       (20)   124786 2024-05-17 19:53:56.000000 distributed-2024.5.1/distributed/worker.py
--rw-r--r--   0 james      (501) staff       (20)     2568 2023-07-17 19:51:10.000000 distributed-2024.5.1/distributed/worker_client.py
--rw-r--r--   0 james      (501) staff       (20)    21478 2024-04-15 18:21:07.000000 distributed-2024.5.1/distributed/worker_memory.py
--rw-r--r--   0 james      (501) staff       (20)   142682 2023-12-01 22:10:13.000000 distributed-2024.5.1/distributed/worker_state_machine.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-17 20:08:13.450088 distributed-2024.5.1/distributed.egg-info/
--rw-r--r--   0 james      (501) staff       (20)     3344 2024-05-17 20:08:13.000000 distributed-2024.5.1/distributed.egg-info/PKG-INFO
--rw-r--r--   0 james      (501) staff       (20)     8983 2024-05-17 20:08:13.000000 distributed-2024.5.1/distributed.egg-info/SOURCES.txt
--rw-r--r--   0 james      (501) staff       (20)        1 2024-05-17 20:08:13.000000 distributed-2024.5.1/distributed.egg-info/dependency_links.txt
--rw-r--r--   0 james      (501) staff       (20)      335 2024-05-17 20:08:13.000000 distributed-2024.5.1/distributed.egg-info/entry_points.txt
--rw-r--r--   0 james      (501) staff       (20)        1 2024-05-17 20:08:12.000000 distributed-2024.5.1/distributed.egg-info/not-zip-safe
--rw-r--r--   0 james      (501) staff       (20)      227 2024-05-17 20:08:13.000000 distributed-2024.5.1/distributed.egg-info/requires.txt
--rw-r--r--   0 james      (501) staff       (20)       12 2024-05-17 20:08:13.000000 distributed-2024.5.1/distributed.egg-info/top_level.txt
-drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-17 20:08:13.368589 distributed-2024.5.1/docs/
-drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-17 20:08:13.449520 distributed-2024.5.1/docs/source/
--rw-r--r--   0 james      (501) staff       (20)    11754 2023-07-17 19:51:10.000000 distributed-2024.5.1/docs/source/active_memory_manager.rst
--rw-r--r--   0 james      (501) staff       (20)     8000 2023-07-17 19:51:10.000000 distributed-2024.5.1/docs/source/actors.rst
--rw-r--r--   0 james      (501) staff       (20)     4343 2023-08-21 21:55:47.000000 distributed-2024.5.1/docs/source/api.rst
--rw-r--r--   0 james      (501) staff       (20)     3519 2023-07-17 19:51:10.000000 distributed-2024.5.1/docs/source/asynchronous.rst
--rw-r--r--   0 james      (501) staff       (20)   275148 2023-10-13 22:40:21.000000 distributed-2024.5.1/docs/source/changelog.rst
--rw-r--r--   0 james      (501) staff       (20)     7137 2023-08-21 21:39:28.000000 distributed-2024.5.1/docs/source/client.rst
--rw-r--r--   0 james      (501) staff       (20)     3770 2023-07-17 19:50:47.000000 distributed-2024.5.1/docs/source/communications.rst
--rw-r--r--   0 james      (501) staff       (20)     7049 2023-07-17 19:51:10.000000 distributed-2024.5.1/docs/source/develop.rst
--rw-r--r--   0 james      (501) staff       (20)     6823 2023-07-17 19:51:10.000000 distributed-2024.5.1/docs/source/diagnosing-performance.rst
--rw-r--r--   0 james      (501) staff       (20)     3392 2023-07-17 19:51:10.000000 distributed-2024.5.1/docs/source/efficiency.rst
-drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-17 20:08:13.449754 distributed-2024.5.1/docs/source/examples/
--rw-r--r--   0 james      (501) staff       (20)     8953 2023-07-17 19:51:10.000000 distributed-2024.5.1/docs/source/examples/word-count.rst
--rw-r--r--   0 james      (501) staff       (20)       75 2023-07-17 19:50:47.000000 distributed-2024.5.1/docs/source/examples-overview.rst
--rw-r--r--   0 james      (501) staff       (20)     4228 2023-07-17 19:51:10.000000 distributed-2024.5.1/docs/source/faq.rst
--rw-r--r--   0 james      (501) staff       (20)     9303 2023-08-21 21:39:28.000000 distributed-2024.5.1/docs/source/fine-performance-metrics.rst
--rw-r--r--   0 james      (501) staff       (20)     4613 2023-07-17 19:51:10.000000 distributed-2024.5.1/docs/source/foundations.rst
--rw-r--r--   0 james      (501) staff       (20)     4016 2023-07-17 19:51:10.000000 distributed-2024.5.1/docs/source/http_services.rst
--rw-r--r--   0 james      (501) staff       (20)     4460 2023-08-21 21:39:28.000000 distributed-2024.5.1/docs/source/index.rst
--rw-r--r--   0 james      (501) staff       (20)     1182 2023-07-17 19:51:10.000000 distributed-2024.5.1/docs/source/install.rst
--rw-r--r--   0 james      (501) staff       (20)     7293 2023-07-17 19:50:47.000000 distributed-2024.5.1/docs/source/journey.rst
--rw-r--r--   0 james      (501) staff       (20)     6470 2023-07-17 19:51:10.000000 distributed-2024.5.1/docs/source/killed.rst
--rw-r--r--   0 james      (501) staff       (20)     1828 2023-07-17 19:51:10.000000 distributed-2024.5.1/docs/source/limitations.rst
--rw-r--r--   0 james      (501) staff       (20)     6458 2023-07-17 19:51:10.000000 distributed-2024.5.1/docs/source/locality.rst
--rw-r--r--   0 james      (501) staff       (20)     2807 2023-07-17 19:50:47.000000 distributed-2024.5.1/docs/source/logging.rst
--rw-r--r--   0 james      (501) staff       (20)     6546 2023-07-17 19:50:47.000000 distributed-2024.5.1/docs/source/manage-computation.rst
--rw-r--r--   0 james      (501) staff       (20)     8550 2023-07-17 19:51:10.000000 distributed-2024.5.1/docs/source/memory.rst
--rw-r--r--   0 james      (501) staff       (20)     4282 2023-12-01 22:10:13.000000 distributed-2024.5.1/docs/source/plugins.rst
--rw-r--r--   0 james      (501) staff       (20)     3265 2023-07-17 19:51:10.000000 distributed-2024.5.1/docs/source/priority.rst
--rw-r--r--   0 james      (501) staff       (20)     7800 2024-03-15 18:22:29.000000 distributed-2024.5.1/docs/source/prometheus.rst
--rw-r--r--   0 james      (501) staff       (20)    11199 2023-07-17 19:51:10.000000 distributed-2024.5.1/docs/source/protocol.rst
--rw-r--r--   0 james      (501) staff       (20)     3107 2023-07-17 19:50:47.000000 distributed-2024.5.1/docs/source/publish.rst
--rw-r--r--   0 james      (501) staff       (20)      402 2023-07-17 19:51:10.000000 distributed-2024.5.1/docs/source/queues.rst
--rw-r--r--   0 james      (501) staff       (20)     2942 2023-07-17 19:51:10.000000 distributed-2024.5.1/docs/source/quickstart.rst
--rw-r--r--   0 james      (501) staff       (20)     8773 2023-07-17 19:51:10.000000 distributed-2024.5.1/docs/source/related-work.rst
--rw-r--r--   0 james      (501) staff       (20)     3418 2023-07-17 19:51:10.000000 distributed-2024.5.1/docs/source/resilience.rst
--rw-r--r--   0 james      (501) staff       (20)     7021 2024-04-01 19:12:58.000000 distributed-2024.5.1/docs/source/resources.rst
--rw-r--r--   0 james      (501) staff       (20)    16084 2023-07-17 19:51:10.000000 distributed-2024.5.1/docs/source/scheduling-policies.rst
--rw-r--r--   0 james      (501) staff       (20)    16893 2023-08-31 20:57:51.000000 distributed-2024.5.1/docs/source/scheduling-state.rst
--rw-r--r--   0 james      (501) staff       (20)     6518 2023-07-17 19:50:47.000000 distributed-2024.5.1/docs/source/serialization.rst
--rw-r--r--   0 james      (501) staff       (20)     5463 2024-04-01 19:12:58.000000 distributed-2024.5.1/docs/source/spans.rst
--rw-r--r--   0 james      (501) staff       (20)     8343 2023-07-17 19:51:10.000000 distributed-2024.5.1/docs/source/task-launch.rst
--rw-r--r--   0 james      (501) staff       (20)     4190 2023-07-17 19:51:10.000000 distributed-2024.5.1/docs/source/tls.rst
--rw-r--r--   0 james      (501) staff       (20)     5557 2023-07-17 19:50:47.000000 distributed-2024.5.1/docs/source/work-stealing.rst
--rw-r--r--   0 james      (501) staff       (20)    13489 2023-07-17 19:51:10.000000 distributed-2024.5.1/docs/source/worker-memory.rst
--rw-r--r--   0 james      (501) staff       (20)    22542 2023-07-17 19:51:10.000000 distributed-2024.5.1/docs/source/worker-state.rst
--rw-r--r--   0 james      (501) staff       (20)     3467 2023-07-17 19:51:10.000000 distributed-2024.5.1/docs/source/worker.rst
--rw-r--r--   0 james      (501) staff       (20)    10198 2024-05-17 19:56:45.000000 distributed-2024.5.1/pyproject.toml
--rw-r--r--   0 james      (501) staff       (20)       38 2024-05-17 20:08:13.450887 distributed-2024.5.1/setup.cfg
--rw-r--r--   0 james      (501) staff       (20)      171 2023-07-17 19:51:10.000000 distributed-2024.5.1/setup.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-31 21:11:42.893606 distributed-2024.5.2/
+-rw-r--r--   0 james      (501) staff       (20)      104 2023-07-17 19:50:47.000000 distributed-2024.5.2/AUTHORS.md
+-rw-r--r--   0 james      (501) staff       (20)     1533 2023-07-17 19:51:10.000000 distributed-2024.5.2/LICENSE.txt
+-rw-r--r--   0 james      (501) staff       (20)      633 2023-07-17 19:51:10.000000 distributed-2024.5.2/MANIFEST.in
+-rw-r--r--   0 james      (501) staff       (20)     3344 2024-05-31 21:11:42.893335 distributed-2024.5.2/PKG-INFO
+-rw-r--r--   0 james      (501) staff       (20)     1801 2023-07-17 19:51:10.000000 distributed-2024.5.2/README.rst
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-31 21:11:42.842628 distributed-2024.5.2/distributed/
+-rw-r--r--   0 james      (501) staff       (20)     4265 2024-01-26 22:03:47.000000 distributed-2024.5.2/distributed/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     2090 2023-10-13 21:59:50.000000 distributed-2024.5.2/distributed/_asyncio.py
+-rw-r--r--   0 james      (501) staff       (20)     5528 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/_concurrent_futures_thread.py
+-rw-r--r--   0 james      (501) staff       (20)     1325 2023-08-21 21:39:28.000000 distributed-2024.5.2/distributed/_signals.py
+-rw-r--r--   0 james      (501) staff       (20)     1459 2023-10-13 21:59:50.000000 distributed-2024.5.2/distributed/_stories.py
+-rw-r--r--   0 james      (501) staff       (20)      500 2024-05-31 21:11:42.893777 distributed-2024.5.2/distributed/_version.py
+-rw-r--r--   0 james      (501) staff       (20)    29675 2023-12-01 22:10:13.000000 distributed-2024.5.2/distributed/active_memory_manager.py
+-rw-r--r--   0 james      (501) staff       (20)     9538 2024-01-12 19:19:58.000000 distributed-2024.5.2/distributed/actor.py
+-rw-r--r--   0 james      (501) staff       (20)     7342 2023-09-27 18:27:06.000000 distributed-2024.5.2/distributed/batched.py
+-rw-r--r--   0 james      (501) staff       (20)      121 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/bokeh.py
+-rw-r--r--   0 james      (501) staff       (20)     5742 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/cfexecutor.py
+-rw-r--r--   0 james      (501) staff       (20)     1947 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/chaos.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-31 21:11:42.845392 distributed-2024.5.2/distributed/cli/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-07-17 19:50:47.000000 distributed-2024.5.2/distributed/cli/__init__.py
+-rwxr-xr-x   0 james      (501) staff       (20)     7242 2023-08-21 21:39:28.000000 distributed-2024.5.2/distributed/cli/dask_scheduler.py
+-rw-r--r--   0 james      (501) staff       (20)     2104 2023-10-23 15:00:29.000000 distributed-2024.5.2/distributed/cli/dask_spec.py
+-rwxr-xr-x   0 james      (501) staff       (20)     5468 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/cli/dask_ssh.py
+-rwxr-xr-x   0 james      (501) staff       (20)    16153 2023-08-21 21:39:28.000000 distributed-2024.5.2/distributed/cli/dask_worker.py
+-rw-r--r--   0 james      (501) staff       (20)     1092 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/cli/utils.py
+-rw-r--r--   0 james      (501) staff       (20)   214239 2024-05-31 20:51:06.000000 distributed-2024.5.2/distributed/client.py
+-rw-r--r--   0 james      (501) staff       (20)    10995 2023-10-13 21:59:50.000000 distributed-2024.5.2/distributed/cluster_dump.py
+-rw-r--r--   0 james      (501) staff       (20)     7099 2023-08-21 21:39:28.000000 distributed-2024.5.2/distributed/collections.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-31 21:11:42.848022 distributed-2024.5.2/distributed/comm/
+-rw-r--r--   0 james      (501) staff       (20)      759 2023-12-01 22:10:13.000000 distributed-2024.5.2/distributed/comm/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     8597 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/comm/addressing.py
+-rw-r--r--   0 james      (501) staff       (20)    12721 2023-08-21 21:39:28.000000 distributed-2024.5.2/distributed/comm/core.py
+-rw-r--r--   0 james      (501) staff       (20)    10515 2024-04-19 20:54:28.000000 distributed-2024.5.2/distributed/comm/inproc.py
+-rw-r--r--   0 james      (501) staff       (20)     2815 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/comm/registry.py
+-rw-r--r--   0 james      (501) staff       (20)    26549 2024-03-13 20:03:34.000000 distributed-2024.5.2/distributed/comm/tcp.py
+-rw-r--r--   0 james      (501) staff       (20)    23014 2023-11-07 17:11:41.000000 distributed-2024.5.2/distributed/comm/ucx.py
+-rw-r--r--   0 james      (501) staff       (20)     3758 2023-11-07 17:11:41.000000 distributed-2024.5.2/distributed/comm/utils.py
+-rw-r--r--   0 james      (501) staff       (20)    14903 2023-08-21 21:39:28.000000 distributed-2024.5.2/distributed/comm/ws.py
+-rw-r--r--   0 james      (501) staff       (20)    10114 2023-08-21 21:39:28.000000 distributed-2024.5.2/distributed/compatibility.py
+-rw-r--r--   0 james      (501) staff       (20)     7826 2023-09-27 18:27:06.000000 distributed-2024.5.2/distributed/config.py
+-rw-r--r--   0 james      (501) staff       (20)    61536 2024-01-26 22:03:47.000000 distributed-2024.5.2/distributed/core.py
+-rw-r--r--   0 james      (501) staff       (20)     2134 2023-10-23 15:00:29.000000 distributed-2024.5.2/distributed/counter.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-31 21:11:42.849836 distributed-2024.5.2/distributed/dashboard/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-07-17 19:50:47.000000 distributed-2024.5.2/distributed/dashboard/__init__.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-31 21:11:42.851963 distributed-2024.5.2/distributed/dashboard/components/
+-rw-r--r--   0 james      (501) staff       (20)     1550 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/dashboard/components/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     5775 2024-04-01 19:12:58.000000 distributed-2024.5.2/distributed/dashboard/components/nvml.py
+-rw-r--r--   0 james      (501) staff       (20)     7154 2024-01-12 19:19:58.000000 distributed-2024.5.2/distributed/dashboard/components/rmm.py
+-rw-r--r--   0 james      (501) staff       (20)   162585 2024-04-01 19:12:54.000000 distributed-2024.5.2/distributed/dashboard/components/scheduler.py
+-rw-r--r--   0 james      (501) staff       (20)    19429 2023-12-01 22:10:13.000000 distributed-2024.5.2/distributed/dashboard/components/shared.py
+-rw-r--r--   0 james      (501) staff       (20)    15424 2023-10-27 21:35:57.000000 distributed-2024.5.2/distributed/dashboard/components/worker.py
+-rw-r--r--   0 james      (501) staff       (20)     2232 2023-12-01 22:10:13.000000 distributed-2024.5.2/distributed/dashboard/core.py
+-rw-r--r--   0 james      (501) staff       (20)     2313 2023-07-17 19:50:47.000000 distributed-2024.5.2/distributed/dashboard/export_tool.js
+-rw-r--r--   0 james      (501) staff       (20)      763 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/dashboard/export_tool.py
+-rw-r--r--   0 james      (501) staff       (20)     5908 2023-11-07 17:11:41.000000 distributed-2024.5.2/distributed/dashboard/scheduler.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-31 21:11:42.852486 distributed-2024.5.2/distributed/dashboard/templates/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/dashboard/templates/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)      241 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/dashboard/templates/performance_report.html
+-rw-r--r--   0 james      (501) staff       (20)      199 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/dashboard/theme.yaml
+-rw-r--r--   0 james      (501) staff       (20)     1732 2023-08-21 21:39:28.000000 distributed-2024.5.2/distributed/dashboard/utils.py
+-rw-r--r--   0 james      (501) staff       (20)      840 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/dashboard/worker.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-31 21:11:42.854868 distributed-2024.5.2/distributed/deploy/
+-rw-r--r--   0 james      (501) staff       (20)      466 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/deploy/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     6702 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/deploy/adaptive.py
+-rw-r--r--   0 james      (501) staff       (20)     7895 2023-09-27 18:27:06.000000 distributed-2024.5.2/distributed/deploy/adaptive_core.py
+-rw-r--r--   0 james      (501) staff       (20)    21271 2023-12-01 22:10:13.000000 distributed-2024.5.2/distributed/deploy/cluster.py
+-rw-r--r--   0 james      (501) staff       (20)    10452 2023-08-21 21:39:28.000000 distributed-2024.5.2/distributed/deploy/local.py
+-rw-r--r--   0 james      (501) staff       (20)    15514 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/deploy/old_ssh.py
+-rw-r--r--   0 james      (501) staff       (20)    23933 2023-12-01 22:10:13.000000 distributed-2024.5.2/distributed/deploy/spec.py
+-rw-r--r--   0 james      (501) staff       (20)    15265 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/deploy/ssh.py
+-rw-r--r--   0 james      (501) staff       (20)     8543 2023-12-15 20:02:12.000000 distributed-2024.5.2/distributed/deploy/subprocess.py
+-rw-r--r--   0 james      (501) staff       (20)      888 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/deploy/utils.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-31 21:11:42.858399 distributed-2024.5.2/distributed/diagnostics/
+-rw-r--r--   0 james      (501) staff       (20)      221 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/diagnostics/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     1302 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/diagnostics/cluster_dump.py
+-rw-r--r--   0 james      (501) staff       (20)      564 2024-01-12 19:19:58.000000 distributed-2024.5.2/distributed/diagnostics/cudf.py
+-rw-r--r--   0 james      (501) staff       (20)     2190 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/diagnostics/eventstream.py
+-rw-r--r--   0 james      (501) staff       (20)     5207 2023-08-21 21:39:28.000000 distributed-2024.5.2/distributed/diagnostics/graph_layout.py
+-rw-r--r--   0 james      (501) staff       (20)     7017 2023-09-13 17:55:47.000000 distributed-2024.5.2/distributed/diagnostics/memory_sampler.py
+-rw-r--r--   0 james      (501) staff       (20)     8388 2024-04-19 20:54:28.000000 distributed-2024.5.2/distributed/diagnostics/memray.py
+-rw-r--r--   0 james      (501) staff       (20)    10781 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/diagnostics/nvml.py
+-rw-r--r--   0 james      (501) staff       (20)    34297 2024-05-31 20:51:06.000000 distributed-2024.5.2/distributed/diagnostics/plugin.py
+-rw-r--r--   0 james      (501) staff       (20)    13904 2023-10-23 15:00:29.000000 distributed-2024.5.2/distributed/diagnostics/progress.py
+-rw-r--r--   0 james      (501) staff       (20)     6063 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/diagnostics/progress_stream.py
+-rw-r--r--   0 james      (501) staff       (20)    15800 2023-08-21 21:39:28.000000 distributed-2024.5.2/distributed/diagnostics/progressbar.py
+-rw-r--r--   0 james      (501) staff       (20)     1124 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/diagnostics/rmm.py
+-rw-r--r--   0 james      (501) staff       (20)     5677 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/diagnostics/task_stream.py
+-rw-r--r--   0 james      (501) staff       (20)     2513 2023-08-21 21:39:28.000000 distributed-2024.5.2/distributed/diagnostics/websocket.py
+-rw-r--r--   0 james      (501) staff       (20)     9407 2023-10-13 21:59:50.000000 distributed-2024.5.2/distributed/diskutils.py
+-rw-r--r--   0 james      (501) staff       (20)    48005 2024-03-13 20:03:34.000000 distributed-2024.5.2/distributed/distributed-schema.yaml
+-rw-r--r--   0 james      (501) staff       (20)    15035 2024-03-15 18:22:29.000000 distributed-2024.5.2/distributed/distributed.yaml
+-rw-r--r--   0 james      (501) staff       (20)     8536 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/event.py
+-rw-r--r--   0 james      (501) staff       (20)      586 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/exceptions.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-31 21:11:42.860013 distributed-2024.5.2/distributed/http/
+-rw-r--r--   0 james      (501) staff       (20)       84 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/http/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)      273 2023-10-13 21:59:50.000000 distributed-2024.5.2/distributed/http/health.py
+-rw-r--r--   0 james      (501) staff       (20)     1480 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/http/prometheus.py
+-rw-r--r--   0 james      (501) staff       (20)     4925 2024-04-01 19:12:54.000000 distributed-2024.5.2/distributed/http/proxy.py
+-rw-r--r--   0 james      (501) staff       (20)     2548 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/http/routing.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-31 21:11:42.861004 distributed-2024.5.2/distributed/http/scheduler/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-07-17 19:50:47.000000 distributed-2024.5.2/distributed/http/scheduler/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     2914 2023-10-13 21:59:50.000000 distributed-2024.5.2/distributed/http/scheduler/api.py
+-rw-r--r--   0 james      (501) staff       (20)     8359 2023-12-01 22:10:13.000000 distributed-2024.5.2/distributed/http/scheduler/info.py
+-rw-r--r--   0 james      (501) staff       (20)     2159 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/http/scheduler/json.py
+-rw-r--r--   0 james      (501) staff       (20)      625 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/http/scheduler/missing_bokeh.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-31 21:11:42.862057 distributed-2024.5.2/distributed/http/scheduler/prometheus/
+-rw-r--r--   0 james      (501) staff       (20)      291 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/http/scheduler/prometheus/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     7080 2024-03-15 18:22:29.000000 distributed-2024.5.2/distributed/http/scheduler/prometheus/core.py
+-rw-r--r--   0 james      (501) staff       (20)     3514 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/http/scheduler/prometheus/semaphore.py
+-rw-r--r--   0 james      (501) staff       (20)     1617 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/http/scheduler/prometheus/stealing.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-31 21:11:42.862335 distributed-2024.5.2/distributed/http/static/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/http/static/__init__.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-31 21:11:42.863605 distributed-2024.5.2/distributed/http/static/css/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/http/static/css/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     2260 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/http/static/css/base.css
+-rw-r--r--   0 james      (501) staff       (20)      250 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/http/static/css/gpu.css
+-rw-r--r--   0 james      (501) staff       (20)      840 2023-07-17 19:50:47.000000 distributed-2024.5.2/distributed/http/static/css/individual-cluster-map.css
+-rw-r--r--   0 james      (501) staff       (20)     1557 2023-09-13 17:55:47.000000 distributed-2024.5.2/distributed/http/static/css/sortable.min.css
+-rw-r--r--   0 james      (501) staff       (20)     1012 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/http/static/css/status.css
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-31 21:11:42.865319 distributed-2024.5.2/distributed/http/static/images/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/http/static/images/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     1607 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/http/static/images/dask-logo.svg
+-rw-r--r--   0 james      (501) staff       (20)      552 2023-07-17 19:50:47.000000 distributed-2024.5.2/distributed/http/static/images/fa-bars.svg
+-rw-r--r--   0 james      (501) staff       (20)    15086 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/http/static/images/favicon.ico
+-rw-r--r--   0 james      (501) staff       (20)    11002 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/http/static/images/jupyter.svg
+-rw-r--r--   0 james      (501) staff       (20)    18663 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/http/static/images/numpy.png
+-rw-r--r--   0 james      (501) staff       (20)     1213 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/http/static/images/pandas.png
+-rw-r--r--   0 james      (501) staff       (20)   830916 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/http/static/images/python.png
+-rw-r--r--   0 james      (501) staff       (20)      667 2023-07-17 19:50:47.000000 distributed-2024.5.2/distributed/http/static/individual-cluster-map.html
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-31 21:11:42.867697 distributed-2024.5.2/distributed/http/static/js/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/http/static/js/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)    17271 2023-07-17 19:50:47.000000 distributed-2024.5.2/distributed/http/static/js/anime.min.js
+-rw-r--r--   0 james      (501) staff       (20)     9337 2023-07-17 19:50:47.000000 distributed-2024.5.2/distributed/http/static/js/individual-cluster-map.js
+-rw-r--r--   0 james      (501) staff       (20)     3276 2023-07-17 19:50:47.000000 distributed-2024.5.2/distributed/http/static/js/reconnecting-websocket.min.js
+-rw-r--r--   0 james      (501) staff       (20)     1194 2023-09-13 17:55:47.000000 distributed-2024.5.2/distributed/http/static/js/sortable.min.js
+-rw-r--r--   0 james      (501) staff       (20)      223 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/http/statics.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-31 21:11:42.870631 distributed-2024.5.2/distributed/http/templates/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/http/templates/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     2930 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/http/templates/base.html
+-rw-r--r--   0 james      (501) staff       (20)      388 2023-07-17 19:50:47.000000 distributed-2024.5.2/distributed/http/templates/call-stack.html
+-rw-r--r--   0 james      (501) staff       (20)     1351 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/http/templates/exceptions.html
+-rw-r--r--   0 james      (501) staff       (20)      404 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/http/templates/gpu.html
+-rw-r--r--   0 james      (501) staff       (20)      276 2023-07-17 19:50:47.000000 distributed-2024.5.2/distributed/http/templates/json-index.html
+-rw-r--r--   0 james      (501) staff       (20)      116 2023-07-17 19:50:47.000000 distributed-2024.5.2/distributed/http/templates/logs.html
+-rw-r--r--   0 james      (501) staff       (20)      522 2023-09-13 17:55:47.000000 distributed-2024.5.2/distributed/http/templates/main.html
+-rw-r--r--   0 james      (501) staff       (20)       95 2023-07-17 19:50:47.000000 distributed-2024.5.2/distributed/http/templates/simple.html
+-rw-r--r--   0 james      (501) staff       (20)      635 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/http/templates/status.html
+-rw-r--r--   0 james      (501) staff       (20)     5726 2023-09-13 17:55:47.000000 distributed-2024.5.2/distributed/http/templates/task.html
+-rw-r--r--   0 james      (501) staff       (20)     1601 2023-09-13 17:55:47.000000 distributed-2024.5.2/distributed/http/templates/worker-table.html
+-rw-r--r--   0 james      (501) staff       (20)     2034 2023-09-13 17:55:47.000000 distributed-2024.5.2/distributed/http/templates/worker.html
+-rw-r--r--   0 james      (501) staff       (20)      457 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/http/templates/workers.html
+-rw-r--r--   0 james      (501) staff       (20)     1184 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/http/utils.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-31 21:11:42.870800 distributed-2024.5.2/distributed/http/worker/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-07-17 19:50:47.000000 distributed-2024.5.2/distributed/http/worker/__init__.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-31 21:11:42.871074 distributed-2024.5.2/distributed/http/worker/prometheus/
+-rw-r--r--   0 james      (501) staff       (20)      288 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/http/worker/prometheus/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)    10039 2024-03-15 18:22:29.000000 distributed-2024.5.2/distributed/http/worker/prometheus/core.py
+-rw-r--r--   0 james      (501) staff       (20)     1170 2023-08-21 21:39:28.000000 distributed-2024.5.2/distributed/itertools.py
+-rw-r--r--   0 james      (501) staff       (20)     5599 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/lock.py
+-rwxr-xr-x   0 james      (501) staff       (20)    14428 2024-05-17 19:53:58.000000 distributed-2024.5.2/distributed/metrics.py
+-rw-r--r--   0 james      (501) staff       (20)     8044 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/multi_lock.py
+-rw-r--r--   0 james      (501) staff       (20)    35101 2024-04-15 18:21:07.000000 distributed-2024.5.2/distributed/nanny.py
+-rw-r--r--   0 james      (501) staff       (20)     6710 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/node.py
+-rw-r--r--   0 james      (501) staff       (20)     1449 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/objects.py
+-rw-r--r--   0 james      (501) staff       (20)     8356 2023-08-21 21:39:28.000000 distributed-2024.5.2/distributed/preloading.py
+-rw-r--r--   0 james      (501) staff       (20)    12887 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/process.py
+-rw-r--r--   0 james      (501) staff       (20)      931 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/proctitle.py
+-rw-r--r--   0 james      (501) staff       (20)    16996 2023-10-13 21:59:50.000000 distributed-2024.5.2/distributed/profile.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-31 21:11:42.875428 distributed-2024.5.2/distributed/protocol/
+-rw-r--r--   0 james      (501) staff       (20)     3390 2024-04-19 20:54:28.000000 distributed-2024.5.2/distributed/protocol/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     1336 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/protocol/arrow.py
+-rw-r--r--   0 james      (501) staff       (20)     6671 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/protocol/compression.py
+-rw-r--r--   0 james      (501) staff       (20)     6831 2024-01-12 19:19:58.000000 distributed-2024.5.2/distributed/protocol/core.py
+-rw-r--r--   0 james      (501) staff       (20)     1181 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/protocol/cuda.py
+-rw-r--r--   0 james      (501) staff       (20)     2931 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/protocol/cupy.py
+-rw-r--r--   0 james      (501) staff       (20)      836 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/protocol/h5py.py
+-rw-r--r--   0 james      (501) staff       (20)     1127 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/protocol/keras.py
+-rw-r--r--   0 james      (501) staff       (20)     1466 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/protocol/netcdf4.py
+-rw-r--r--   0 james      (501) staff       (20)     2139 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/protocol/numba.py
+-rw-r--r--   0 james      (501) staff       (20)     7030 2024-01-26 22:03:47.000000 distributed-2024.5.2/distributed/protocol/numpy.py
+-rw-r--r--   0 james      (501) staff       (20)     3041 2023-08-21 21:39:28.000000 distributed-2024.5.2/distributed/protocol/pickle.py
+-rw-r--r--   0 james      (501) staff       (20)     1507 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/protocol/rmm.py
+-rw-r--r--   0 james      (501) staff       (20)      792 2024-01-26 22:03:47.000000 distributed-2024.5.2/distributed/protocol/scipy.py
+-rw-r--r--   0 james      (501) staff       (20)    30056 2024-04-19 20:54:28.000000 distributed-2024.5.2/distributed/protocol/serialize.py
+-rw-r--r--   0 james      (501) staff       (20)      955 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/protocol/sparse.py
+-rw-r--r--   0 james      (501) staff       (20)     1993 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/protocol/torch.py
+-rw-r--r--   0 james      (501) staff       (20)     8314 2024-03-13 20:03:34.000000 distributed-2024.5.2/distributed/protocol/utils.py
+-rw-r--r--   0 james      (501) staff       (20)      795 2023-11-07 17:11:41.000000 distributed-2024.5.2/distributed/protocol/utils_test.py
+-rw-r--r--   0 james      (501) staff       (20)     4226 2024-04-15 18:21:07.000000 distributed-2024.5.2/distributed/publish.py
+-rw-r--r--   0 james      (501) staff       (20)    15643 2023-10-23 15:00:29.000000 distributed-2024.5.2/distributed/pubsub.py
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/py.typed
+-rw-r--r--   0 james      (501) staff       (20)    10054 2023-10-23 15:00:29.000000 distributed-2024.5.2/distributed/queues.py
+-rw-r--r--   0 james      (501) staff       (20)     7437 2024-05-31 20:51:06.000000 distributed-2024.5.2/distributed/recreate_tasks.py
+-rw-r--r--   0 james      (501) staff       (20)   327877 2024-05-31 20:51:06.000000 distributed-2024.5.2/distributed/scheduler.py
+-rw-r--r--   0 james      (501) staff       (20)    13867 2023-10-13 21:59:50.000000 distributed-2024.5.2/distributed/security.py
+-rw-r--r--   0 james      (501) staff       (20)    20568 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/semaphore.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-31 21:11:42.879341 distributed-2024.5.2/distributed/shuffle/
+-rw-r--r--   0 james      (501) staff       (20)      674 2023-08-21 21:39:28.000000 distributed-2024.5.2/distributed/shuffle/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     6394 2024-04-01 19:12:58.000000 distributed-2024.5.2/distributed/shuffle/_arrow.py
+-rw-r--r--   0 james      (501) staff       (20)     9330 2024-01-12 19:19:58.000000 distributed-2024.5.2/distributed/shuffle/_buffer.py
+-rw-r--r--   0 james      (501) staff       (20)     2481 2024-01-12 19:19:58.000000 distributed-2024.5.2/distributed/shuffle/_comms.py
+-rw-r--r--   0 james      (501) staff       (20)    17734 2024-03-13 20:03:34.000000 distributed-2024.5.2/distributed/shuffle/_core.py
+-rw-r--r--   0 james      (501) staff       (20)     7924 2024-03-13 20:03:34.000000 distributed-2024.5.2/distributed/shuffle/_disk.py
+-rw-r--r--   0 james      (501) staff       (20)      180 2024-03-13 20:03:34.000000 distributed-2024.5.2/distributed/shuffle/_exceptions.py
+-rw-r--r--   0 james      (501) staff       (20)     2798 2024-01-12 19:19:58.000000 distributed-2024.5.2/distributed/shuffle/_limiter.py
+-rw-r--r--   0 james      (501) staff       (20)     1531 2024-03-13 20:03:34.000000 distributed-2024.5.2/distributed/shuffle/_memory.py
+-rw-r--r--   0 james      (501) staff       (20)    14022 2024-03-15 18:22:29.000000 distributed-2024.5.2/distributed/shuffle/_merge.py
+-rw-r--r--   0 james      (501) staff       (20)     1186 2023-11-07 17:11:41.000000 distributed-2024.5.2/distributed/shuffle/_pickle.py
+-rw-r--r--   0 james      (501) staff       (20)    27534 2024-05-31 20:51:06.000000 distributed-2024.5.2/distributed/shuffle/_rechunk.py
+-rw-r--r--   0 james      (501) staff       (20)    18821 2024-04-15 18:21:07.000000 distributed-2024.5.2/distributed/shuffle/_scheduler_plugin.py
+-rw-r--r--   0 james      (501) staff       (20)    18581 2024-03-15 18:22:29.000000 distributed-2024.5.2/distributed/shuffle/_shuffle.py
+-rw-r--r--   0 james      (501) staff       (20)    14591 2024-03-13 20:03:34.000000 distributed-2024.5.2/distributed/shuffle/_worker_plugin.py
+-rw-r--r--   0 james      (501) staff       (20)      670 2024-05-03 20:25:17.000000 distributed-2024.5.2/distributed/sizeof.py
+-rw-r--r--   0 james      (501) staff       (20)    24020 2024-05-31 20:51:06.000000 distributed-2024.5.2/distributed/spans.py
+-rw-r--r--   0 james      (501) staff       (20)    13767 2023-12-15 20:02:12.000000 distributed-2024.5.2/distributed/spill.py
+-rw-r--r--   0 james      (501) staff       (20)    19711 2024-03-15 18:22:29.000000 distributed-2024.5.2/distributed/stealing.py
+-rw-r--r--   0 james      (501) staff       (20)     1952 2023-10-13 21:59:50.000000 distributed-2024.5.2/distributed/system.py
+-rw-r--r--   0 james      (501) staff       (20)     8971 2024-04-01 19:12:58.000000 distributed-2024.5.2/distributed/system_monitor.py
+-rw-r--r--   0 james      (501) staff       (20)     7104 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/threadpoolexecutor.py
+-rw-r--r--   0 james      (501) staff       (20)    58512 2024-04-01 19:12:54.000000 distributed-2024.5.2/distributed/utils.py
+-rw-r--r--   0 james      (501) staff       (20)    14586 2024-04-15 18:21:07.000000 distributed-2024.5.2/distributed/utils_comm.py
+-rw-r--r--   0 james      (501) staff       (20)     8050 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/utils_perf.py
+-rw-r--r--   0 james      (501) staff       (20)    83804 2024-04-01 19:12:54.000000 distributed-2024.5.2/distributed/utils_test.py
+-rw-r--r--   0 james      (501) staff       (20)     8411 2023-08-31 20:57:51.000000 distributed-2024.5.2/distributed/variable.py
+-rw-r--r--   0 james      (501) staff       (20)     5165 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/versions.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-31 21:11:42.879568 distributed-2024.5.2/distributed/widgets/
+-rw-r--r--   0 james      (501) staff       (20)      267 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/widgets/__init__.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-31 21:11:42.882262 distributed-2024.5.2/distributed/widgets/templates/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/widgets/templates/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     2265 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/widgets/templates/client.html.j2
+-rw-r--r--   0 james      (501) staff       (20)     1589 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/widgets/templates/cluster.html.j2
+-rw-r--r--   0 james      (501) staff       (20)     1270 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/widgets/templates/computation.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      518 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/widgets/templates/future.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      544 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/widgets/templates/has_what.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      234 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/widgets/templates/local_cluster.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      636 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/widgets/templates/log.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      168 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/widgets/templates/logs.html.j2
+-rw-r--r--   0 james      (501) staff       (20)     1290 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/widgets/templates/process_interface.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      317 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/widgets/templates/scheduler.html.j2
+-rw-r--r--   0 james      (501) staff       (20)     6705 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/widgets/templates/scheduler_info.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      407 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/widgets/templates/security.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      448 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/widgets/templates/task_state.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      295 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/widgets/templates/who_has.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      407 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/widgets/templates/worker_state.html.j2
+-rw-r--r--   0 james      (501) staff       (20)   124786 2024-05-17 19:53:56.000000 distributed-2024.5.2/distributed/worker.py
+-rw-r--r--   0 james      (501) staff       (20)     2568 2023-07-17 19:51:10.000000 distributed-2024.5.2/distributed/worker_client.py
+-rw-r--r--   0 james      (501) staff       (20)    21478 2024-04-15 18:21:07.000000 distributed-2024.5.2/distributed/worker_memory.py
+-rw-r--r--   0 james      (501) staff       (20)   142682 2023-12-01 22:10:13.000000 distributed-2024.5.2/distributed/worker_state_machine.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-31 21:11:42.893008 distributed-2024.5.2/distributed.egg-info/
+-rw-r--r--   0 james      (501) staff       (20)     3344 2024-05-31 21:11:42.000000 distributed-2024.5.2/distributed.egg-info/PKG-INFO
+-rw-r--r--   0 james      (501) staff       (20)     8983 2024-05-31 21:11:42.000000 distributed-2024.5.2/distributed.egg-info/SOURCES.txt
+-rw-r--r--   0 james      (501) staff       (20)        1 2024-05-31 21:11:42.000000 distributed-2024.5.2/distributed.egg-info/dependency_links.txt
+-rw-r--r--   0 james      (501) staff       (20)      335 2024-05-31 21:11:42.000000 distributed-2024.5.2/distributed.egg-info/entry_points.txt
+-rw-r--r--   0 james      (501) staff       (20)        1 2024-05-31 21:11:42.000000 distributed-2024.5.2/distributed.egg-info/not-zip-safe
+-rw-r--r--   0 james      (501) staff       (20)      227 2024-05-31 21:11:42.000000 distributed-2024.5.2/distributed.egg-info/requires.txt
+-rw-r--r--   0 james      (501) staff       (20)       12 2024-05-31 21:11:42.000000 distributed-2024.5.2/distributed.egg-info/top_level.txt
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-31 21:11:42.820532 distributed-2024.5.2/docs/
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-31 21:11:42.892517 distributed-2024.5.2/docs/source/
+-rw-r--r--   0 james      (501) staff       (20)    11754 2023-07-17 19:51:10.000000 distributed-2024.5.2/docs/source/active_memory_manager.rst
+-rw-r--r--   0 james      (501) staff       (20)     8000 2023-07-17 19:51:10.000000 distributed-2024.5.2/docs/source/actors.rst
+-rw-r--r--   0 james      (501) staff       (20)     4343 2023-08-21 21:55:47.000000 distributed-2024.5.2/docs/source/api.rst
+-rw-r--r--   0 james      (501) staff       (20)     3519 2023-07-17 19:51:10.000000 distributed-2024.5.2/docs/source/asynchronous.rst
+-rw-r--r--   0 james      (501) staff       (20)   275148 2023-10-13 22:40:21.000000 distributed-2024.5.2/docs/source/changelog.rst
+-rw-r--r--   0 james      (501) staff       (20)     7137 2023-08-21 21:39:28.000000 distributed-2024.5.2/docs/source/client.rst
+-rw-r--r--   0 james      (501) staff       (20)     3770 2023-07-17 19:50:47.000000 distributed-2024.5.2/docs/source/communications.rst
+-rw-r--r--   0 james      (501) staff       (20)     7049 2023-07-17 19:51:10.000000 distributed-2024.5.2/docs/source/develop.rst
+-rw-r--r--   0 james      (501) staff       (20)     6823 2023-07-17 19:51:10.000000 distributed-2024.5.2/docs/source/diagnosing-performance.rst
+-rw-r--r--   0 james      (501) staff       (20)     3392 2023-07-17 19:51:10.000000 distributed-2024.5.2/docs/source/efficiency.rst
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-05-31 21:11:42.892687 distributed-2024.5.2/docs/source/examples/
+-rw-r--r--   0 james      (501) staff       (20)     8953 2023-07-17 19:51:10.000000 distributed-2024.5.2/docs/source/examples/word-count.rst
+-rw-r--r--   0 james      (501) staff       (20)       75 2023-07-17 19:50:47.000000 distributed-2024.5.2/docs/source/examples-overview.rst
+-rw-r--r--   0 james      (501) staff       (20)     4228 2023-07-17 19:51:10.000000 distributed-2024.5.2/docs/source/faq.rst
+-rw-r--r--   0 james      (501) staff       (20)     9303 2023-08-21 21:39:28.000000 distributed-2024.5.2/docs/source/fine-performance-metrics.rst
+-rw-r--r--   0 james      (501) staff       (20)     4613 2023-07-17 19:51:10.000000 distributed-2024.5.2/docs/source/foundations.rst
+-rw-r--r--   0 james      (501) staff       (20)     4016 2023-07-17 19:51:10.000000 distributed-2024.5.2/docs/source/http_services.rst
+-rw-r--r--   0 james      (501) staff       (20)     4460 2023-08-21 21:39:28.000000 distributed-2024.5.2/docs/source/index.rst
+-rw-r--r--   0 james      (501) staff       (20)     1182 2023-07-17 19:51:10.000000 distributed-2024.5.2/docs/source/install.rst
+-rw-r--r--   0 james      (501) staff       (20)     7293 2023-07-17 19:50:47.000000 distributed-2024.5.2/docs/source/journey.rst
+-rw-r--r--   0 james      (501) staff       (20)     6470 2023-07-17 19:51:10.000000 distributed-2024.5.2/docs/source/killed.rst
+-rw-r--r--   0 james      (501) staff       (20)     1828 2023-07-17 19:51:10.000000 distributed-2024.5.2/docs/source/limitations.rst
+-rw-r--r--   0 james      (501) staff       (20)     6458 2023-07-17 19:51:10.000000 distributed-2024.5.2/docs/source/locality.rst
+-rw-r--r--   0 james      (501) staff       (20)     2807 2023-07-17 19:50:47.000000 distributed-2024.5.2/docs/source/logging.rst
+-rw-r--r--   0 james      (501) staff       (20)     6546 2023-07-17 19:50:47.000000 distributed-2024.5.2/docs/source/manage-computation.rst
+-rw-r--r--   0 james      (501) staff       (20)     8550 2023-07-17 19:51:10.000000 distributed-2024.5.2/docs/source/memory.rst
+-rw-r--r--   0 james      (501) staff       (20)     4282 2023-12-01 22:10:13.000000 distributed-2024.5.2/docs/source/plugins.rst
+-rw-r--r--   0 james      (501) staff       (20)     3265 2023-07-17 19:51:10.000000 distributed-2024.5.2/docs/source/priority.rst
+-rw-r--r--   0 james      (501) staff       (20)     7800 2024-03-15 18:22:29.000000 distributed-2024.5.2/docs/source/prometheus.rst
+-rw-r--r--   0 james      (501) staff       (20)    11199 2023-07-17 19:51:10.000000 distributed-2024.5.2/docs/source/protocol.rst
+-rw-r--r--   0 james      (501) staff       (20)     3107 2023-07-17 19:50:47.000000 distributed-2024.5.2/docs/source/publish.rst
+-rw-r--r--   0 james      (501) staff       (20)      402 2023-07-17 19:51:10.000000 distributed-2024.5.2/docs/source/queues.rst
+-rw-r--r--   0 james      (501) staff       (20)     2942 2023-07-17 19:51:10.000000 distributed-2024.5.2/docs/source/quickstart.rst
+-rw-r--r--   0 james      (501) staff       (20)     8773 2023-07-17 19:51:10.000000 distributed-2024.5.2/docs/source/related-work.rst
+-rw-r--r--   0 james      (501) staff       (20)     3418 2023-07-17 19:51:10.000000 distributed-2024.5.2/docs/source/resilience.rst
+-rw-r--r--   0 james      (501) staff       (20)     7021 2024-04-01 19:12:58.000000 distributed-2024.5.2/docs/source/resources.rst
+-rw-r--r--   0 james      (501) staff       (20)    16084 2023-07-17 19:51:10.000000 distributed-2024.5.2/docs/source/scheduling-policies.rst
+-rw-r--r--   0 james      (501) staff       (20)    16893 2023-08-31 20:57:51.000000 distributed-2024.5.2/docs/source/scheduling-state.rst
+-rw-r--r--   0 james      (501) staff       (20)     6518 2023-07-17 19:50:47.000000 distributed-2024.5.2/docs/source/serialization.rst
+-rw-r--r--   0 james      (501) staff       (20)     5463 2024-04-01 19:12:58.000000 distributed-2024.5.2/docs/source/spans.rst
+-rw-r--r--   0 james      (501) staff       (20)     8346 2024-05-31 20:51:06.000000 distributed-2024.5.2/docs/source/task-launch.rst
+-rw-r--r--   0 james      (501) staff       (20)     4190 2023-07-17 19:51:10.000000 distributed-2024.5.2/docs/source/tls.rst
+-rw-r--r--   0 james      (501) staff       (20)     5557 2023-07-17 19:50:47.000000 distributed-2024.5.2/docs/source/work-stealing.rst
+-rw-r--r--   0 james      (501) staff       (20)    13489 2023-07-17 19:51:10.000000 distributed-2024.5.2/docs/source/worker-memory.rst
+-rw-r--r--   0 james      (501) staff       (20)    22542 2023-07-17 19:51:10.000000 distributed-2024.5.2/docs/source/worker-state.rst
+-rw-r--r--   0 james      (501) staff       (20)     3467 2023-07-17 19:51:10.000000 distributed-2024.5.2/docs/source/worker.rst
+-rw-r--r--   0 james      (501) staff       (20)    10198 2024-05-31 20:59:03.000000 distributed-2024.5.2/pyproject.toml
+-rw-r--r--   0 james      (501) staff       (20)       38 2024-05-31 21:11:42.893656 distributed-2024.5.2/setup.cfg
+-rw-r--r--   0 james      (501) staff       (20)      171 2023-07-17 19:51:10.000000 distributed-2024.5.2/setup.py
```

### Comparing `distributed-2024.5.1/LICENSE.txt` & `distributed-2024.5.2/LICENSE.txt`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/MANIFEST.in` & `distributed-2024.5.2/MANIFEST.in`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/PKG-INFO` & `distributed-2024.5.2/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: distributed
-Version: 2024.5.1
+Version: 2024.5.2
 Summary: Distributed scheduler for Dask
 Maintainer-email: Matthew Rocklin <mrocklin@gmail.com>
 License: BSD-3-Clause
 Project-URL: Homepage, https://distributed.dask.org
 Project-URL: Source, https://github.com/dask/distributed
 Classifier: Development Status :: 5 - Production/Stable
 Classifier: Intended Audience :: Developers
@@ -22,15 +22,15 @@
 Classifier: Topic :: System :: Distributed Computing
 Requires-Python: >=3.9
 Description-Content-Type: text/x-rst
 License-File: LICENSE.txt
 License-File: AUTHORS.md
 Requires-Dist: click>=8.0
 Requires-Dist: cloudpickle>=1.5.0
-Requires-Dist: dask==2024.5.1
+Requires-Dist: dask==2024.5.2
 Requires-Dist: jinja2>=2.10.3
 Requires-Dist: locket>=1.0.0
 Requires-Dist: msgpack>=1.0.0
 Requires-Dist: packaging>=20.0
 Requires-Dist: psutil>=5.7.2
 Requires-Dist: pyyaml>=5.3.1
 Requires-Dist: sortedcontainers>=2.0.5
```

### Comparing `distributed-2024.5.1/README.rst` & `distributed-2024.5.2/README.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/__init__.py` & `distributed-2024.5.2/distributed/__init__.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/_asyncio.py` & `distributed-2024.5.2/distributed/_asyncio.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/_concurrent_futures_thread.py` & `distributed-2024.5.2/distributed/_concurrent_futures_thread.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/_signals.py` & `distributed-2024.5.2/distributed/_signals.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/_stories.py` & `distributed-2024.5.2/distributed/_stories.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/active_memory_manager.py` & `distributed-2024.5.2/distributed/active_memory_manager.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/actor.py` & `distributed-2024.5.2/distributed/actor.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/batched.py` & `distributed-2024.5.2/distributed/batched.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/cfexecutor.py` & `distributed-2024.5.2/distributed/cfexecutor.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/chaos.py` & `distributed-2024.5.2/distributed/chaos.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/cli/dask_scheduler.py` & `distributed-2024.5.2/distributed/cli/dask_scheduler.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/cli/dask_spec.py` & `distributed-2024.5.2/distributed/cli/dask_spec.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/cli/dask_ssh.py` & `distributed-2024.5.2/distributed/cli/dask_ssh.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/cli/dask_worker.py` & `distributed-2024.5.2/distributed/cli/dask_worker.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/cli/utils.py` & `distributed-2024.5.2/distributed/cli/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/client.py` & `distributed-2024.5.2/distributed/client.py`

 * *Files 1% similar despite different names*

```diff
@@ -88,14 +88,15 @@
 from distributed.objects import HasWhat, SchedulerInfo, WhoHas
 from distributed.protocol import to_serialize
 from distributed.protocol.pickle import dumps, loads
 from distributed.publish import Datasets
 from distributed.pubsub import PubSubClientExtension
 from distributed.security import Security
 from distributed.sizeof import sizeof
+from distributed.spans import SpanMetadata
 from distributed.threadpoolexecutor import rejoin
 from distributed.utils import (
     CancelledError,
     LoopRunner,
     NoOpAwaitable,
     SyncMethodMixin,
     TimeoutError,
@@ -1942,26 +1943,26 @@
         if isinstance(workers, (str, Number)):
             workers = [workers]
 
         if kwargs:
             dsk = {key: (apply, func, list(args), kwargs)}
         else:
             dsk = {key: (func,) + tuple(args)}
-
         futures = self._graph_to_futures(
             dsk,
             [key],
             workers=workers,
             allow_other_workers=allow_other_workers,
             internal_priority={key: 0},
             user_priority=priority,
             resources=resources,
             retries=retries,
             fifo_timeout=fifo_timeout,
             actors=actor,
+            span_metadata=SpanMetadata(collections=[{"type": "Future"}]),
         )
 
         logger.debug("Submit %s(...), %s", funcname(func), key)
 
         return futures[key]
 
     def map(
@@ -2160,14 +2161,15 @@
             allow_other_workers=allow_other_workers,
             internal_priority=internal_priority,
             resources=resources,
             retries=retries,
             user_priority=priority,
             fifo_timeout=fifo_timeout,
             actors=actor,
+            span_metadata=SpanMetadata(collections=[{"type": "Future"}]),
         )
         logger.debug("map(%s, ...)", funcname(func))
 
         return [futures[k] for k in keys]
 
     async def _gather(self, futures, errors="raise", direct=None, local_worker=None):
         unpacked, future_set = unpack_remotedata(futures, byte_keys=True)
@@ -3099,14 +3101,15 @@
 
         return tuple(reversed(code))
 
     def _graph_to_futures(
         self,
         dsk,
         keys,
+        span_metadata,
         workers=None,
         allow_other_workers=None,
         internal_priority=None,
         user_priority=0,
         resources=None,
         retries=None,
         fifo_timeout=0,
@@ -3175,14 +3178,15 @@
                     "keys": list(keys),
                     "internal_priority": internal_priority,
                     "submitting_task": getattr(thread_state, "key", None),
                     "fifo_timeout": fifo_timeout,
                     "actors": actors,
                     "code": ToPickle(computations),
                     "annotations": ToPickle(annotations),
+                    "span_metadata": ToPickle(span_metadata),
                 }
             )
             return futures
 
     def get(
         self,
         dsk,
@@ -3262,14 +3266,15 @@
             workers=workers,
             allow_other_workers=allow_other_workers,
             resources=resources,
             fifo_timeout=fifo_timeout,
             retries=retries,
             user_priority=priority,
             actors=actors,
+            span_metadata=SpanMetadata(collections=[{"type": "low-level-graph"}]),
         )
         packed = pack_data(keys, futures)
         if sync:
             if getattr(thread_state, "key", False):
                 try:
                     secede()
                     should_rejoin = True
@@ -3444,14 +3449,17 @@
                     if isinstance(a, (list, set, tuple, dict, Iterator))
                     else a
                 )
                 for a in collections
             )
 
         variables = [a for a in collections if dask.is_dask_collection(a)]
+        metadata = SpanMetadata(
+            collections=[get_collections_metadata(v) for v in variables]
+        )
 
         dsk = self.collections_to_dsk(variables, optimize_graph, **kwargs)
         names = ["finalize-%s" % tokenize(v) for v in variables]
         dsk2 = {}
         for i, (name, v) in enumerate(zip(names, variables)):
             func, extra_args = v.__dask_postcompute__()
             keys = v.__dask_keys__()
@@ -3477,14 +3485,15 @@
             workers=workers,
             allow_other_workers=allow_other_workers,
             resources=resources,
             retries=retries,
             user_priority=priority,
             fifo_timeout=fifo_timeout,
             actors=actors,
+            span_metadata=metadata,
         )
 
         i = 0
         futures = []
         for arg in collections:
             if dask.is_dask_collection(arg):
                 futures.append(futures_dict[names[i]])
@@ -3568,29 +3577,32 @@
         if isinstance(collections, (tuple, list, set, frozenset)):
             singleton = False
         else:
             singleton = True
             collections = [collections]
 
         assert all(map(dask.is_dask_collection, collections))
-
+        metadata = SpanMetadata(
+            collections=[get_collections_metadata(v) for v in collections]
+        )
         dsk = self.collections_to_dsk(collections, optimize_graph, **kwargs)
 
         names = {k for c in collections for k in flatten(c.__dask_keys__())}
 
         futures = self._graph_to_futures(
             dsk,
             names,
             workers=workers,
             allow_other_workers=allow_other_workers,
             resources=resources,
             retries=retries,
             user_priority=priority,
             fifo_timeout=fifo_timeout,
             actors=actors,
+            span_metadata=metadata,
         )
 
         postpersists = [c.__dask_postpersist__() for c in collections]
         result = [
             func({k: futures[k] for k in flatten(c.__dask_keys__())}, *args)
             for (func, args), c in zip(postpersists, collections)
         ]
@@ -6150,8 +6162,14 @@
         with suppress(TimeoutError, RuntimeError):
             if c.asynchronous:
                 c.loop.add_callback(c.close, timeout=3)
             else:
                 c.close(timeout=3)
 
 
+def get_collections_metadata(collection):
+    return {
+        "type": type(collection).__name__,
+    }
+
+
 atexit.register(_close_global_client)
```

### Comparing `distributed-2024.5.1/distributed/cluster_dump.py` & `distributed-2024.5.2/distributed/cluster_dump.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/collections.py` & `distributed-2024.5.2/distributed/collections.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/comm/__init__.py` & `distributed-2024.5.2/distributed/comm/__init__.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/comm/addressing.py` & `distributed-2024.5.2/distributed/comm/addressing.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/comm/core.py` & `distributed-2024.5.2/distributed/comm/core.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/comm/inproc.py` & `distributed-2024.5.2/distributed/comm/inproc.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/comm/registry.py` & `distributed-2024.5.2/distributed/comm/registry.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/comm/tcp.py` & `distributed-2024.5.2/distributed/comm/tcp.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/comm/ucx.py` & `distributed-2024.5.2/distributed/comm/ucx.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/comm/utils.py` & `distributed-2024.5.2/distributed/comm/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/comm/ws.py` & `distributed-2024.5.2/distributed/comm/ws.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/compatibility.py` & `distributed-2024.5.2/distributed/compatibility.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/config.py` & `distributed-2024.5.2/distributed/config.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/core.py` & `distributed-2024.5.2/distributed/core.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/counter.py` & `distributed-2024.5.2/distributed/counter.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/dashboard/components/__init__.py` & `distributed-2024.5.2/distributed/dashboard/components/__init__.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/dashboard/components/nvml.py` & `distributed-2024.5.2/distributed/dashboard/components/nvml.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/dashboard/components/rmm.py` & `distributed-2024.5.2/distributed/dashboard/components/rmm.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/dashboard/components/scheduler.py` & `distributed-2024.5.2/distributed/dashboard/components/scheduler.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/dashboard/components/shared.py` & `distributed-2024.5.2/distributed/dashboard/components/shared.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/dashboard/components/worker.py` & `distributed-2024.5.2/distributed/dashboard/components/worker.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/dashboard/core.py` & `distributed-2024.5.2/distributed/dashboard/core.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/dashboard/export_tool.js` & `distributed-2024.5.2/distributed/dashboard/export_tool.js`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/dashboard/export_tool.py` & `distributed-2024.5.2/distributed/dashboard/export_tool.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/dashboard/scheduler.py` & `distributed-2024.5.2/distributed/dashboard/scheduler.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/dashboard/utils.py` & `distributed-2024.5.2/distributed/dashboard/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/dashboard/worker.py` & `distributed-2024.5.2/distributed/dashboard/worker.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/deploy/adaptive.py` & `distributed-2024.5.2/distributed/deploy/adaptive.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/deploy/adaptive_core.py` & `distributed-2024.5.2/distributed/deploy/adaptive_core.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/deploy/cluster.py` & `distributed-2024.5.2/distributed/deploy/cluster.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/deploy/local.py` & `distributed-2024.5.2/distributed/deploy/local.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/deploy/old_ssh.py` & `distributed-2024.5.2/distributed/deploy/old_ssh.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/deploy/spec.py` & `distributed-2024.5.2/distributed/deploy/spec.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/deploy/ssh.py` & `distributed-2024.5.2/distributed/deploy/ssh.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/deploy/subprocess.py` & `distributed-2024.5.2/distributed/deploy/subprocess.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/deploy/utils.py` & `distributed-2024.5.2/distributed/deploy/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/diagnostics/cluster_dump.py` & `distributed-2024.5.2/distributed/diagnostics/cluster_dump.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/diagnostics/cudf.py` & `distributed-2024.5.2/distributed/diagnostics/cudf.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/diagnostics/eventstream.py` & `distributed-2024.5.2/distributed/diagnostics/eventstream.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/diagnostics/graph_layout.py` & `distributed-2024.5.2/distributed/diagnostics/graph_layout.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/diagnostics/memory_sampler.py` & `distributed-2024.5.2/distributed/diagnostics/memory_sampler.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/diagnostics/memray.py` & `distributed-2024.5.2/distributed/diagnostics/memray.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/diagnostics/nvml.py` & `distributed-2024.5.2/distributed/diagnostics/nvml.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/diagnostics/plugin.py` & `distributed-2024.5.2/distributed/diagnostics/plugin.py`

 * *Files 2% similar despite different names*

```diff
@@ -17,17 +17,20 @@
 from dask.typing import Key
 from dask.utils import funcname, tmpfile
 
 from distributed.protocol.pickle import dumps
 
 if TYPE_CHECKING:
     # circular imports
+    # Needed to avoid Sphinx WARNING: more than one target found for cross-reference
+    # 'WorkerState'"
+    # https://github.com/agronholm/sphinx-autodoc-typehints#dealing-with-circular-imports
+    from distributed import scheduler as scheduler_module
     from distributed.scheduler import Scheduler
     from distributed.scheduler import TaskStateState as SchedulerTaskStateState
-    from distributed.scheduler import WorkerState
     from distributed.worker import Worker
     from distributed.worker_state_machine import TaskStateState as WorkerTaskStateState
 
 logger = logging.getLogger(__name__)
 
 
 class SchedulerPlugin:
@@ -203,16 +206,16 @@
     def add_client(self, scheduler: Scheduler, client: str) -> None:
         """Run when a new client connects"""
 
     def remove_client(self, scheduler: Scheduler, client: str) -> None:
         """Run when a client disconnects"""
 
     def valid_workers_downscaling(
-        self, scheduler: Scheduler, workers: list[WorkerState]
-    ) -> list[WorkerState]:
+        self, scheduler: Scheduler, workers: list[scheduler_module.WorkerState]
+    ) -> list[scheduler_module.WorkerState]:
         """Determine which workers can be removed from the cluster
 
         This method is called when the scheduler is about to downscale the cluster
         by removing workers. The method should return a set of worker states that
         can be removed from the cluster.
 
         Parameters
```

### Comparing `distributed-2024.5.1/distributed/diagnostics/progress.py` & `distributed-2024.5.2/distributed/diagnostics/progress.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/diagnostics/progress_stream.py` & `distributed-2024.5.2/distributed/diagnostics/progress_stream.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/diagnostics/progressbar.py` & `distributed-2024.5.2/distributed/diagnostics/progressbar.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/diagnostics/rmm.py` & `distributed-2024.5.2/distributed/diagnostics/rmm.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/diagnostics/task_stream.py` & `distributed-2024.5.2/distributed/diagnostics/task_stream.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/diagnostics/websocket.py` & `distributed-2024.5.2/distributed/diagnostics/websocket.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/diskutils.py` & `distributed-2024.5.2/distributed/diskutils.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/distributed-schema.yaml` & `distributed-2024.5.2/distributed/distributed-schema.yaml`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/distributed.yaml` & `distributed-2024.5.2/distributed/distributed.yaml`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/event.py` & `distributed-2024.5.2/distributed/event.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/exceptions.py` & `distributed-2024.5.2/distributed/exceptions.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/http/prometheus.py` & `distributed-2024.5.2/distributed/http/prometheus.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/http/proxy.py` & `distributed-2024.5.2/distributed/http/proxy.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/http/routing.py` & `distributed-2024.5.2/distributed/http/routing.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/http/scheduler/api.py` & `distributed-2024.5.2/distributed/http/scheduler/api.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/http/scheduler/info.py` & `distributed-2024.5.2/distributed/http/scheduler/info.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/http/scheduler/json.py` & `distributed-2024.5.2/distributed/http/scheduler/json.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/http/scheduler/missing_bokeh.py` & `distributed-2024.5.2/distributed/http/scheduler/missing_bokeh.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/http/scheduler/prometheus/core.py` & `distributed-2024.5.2/distributed/http/scheduler/prometheus/core.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/http/scheduler/prometheus/semaphore.py` & `distributed-2024.5.2/distributed/http/scheduler/prometheus/semaphore.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/http/scheduler/prometheus/stealing.py` & `distributed-2024.5.2/distributed/http/scheduler/prometheus/stealing.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/http/static/css/base.css` & `distributed-2024.5.2/distributed/http/static/css/base.css`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/http/static/css/individual-cluster-map.css` & `distributed-2024.5.2/distributed/http/static/css/individual-cluster-map.css`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/http/static/css/sortable.min.css` & `distributed-2024.5.2/distributed/http/static/css/sortable.min.css`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/http/static/css/status.css` & `distributed-2024.5.2/distributed/http/static/css/status.css`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/http/static/images/dask-logo.svg` & `distributed-2024.5.2/distributed/http/static/images/dask-logo.svg`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/http/static/images/fa-bars.svg` & `distributed-2024.5.2/distributed/http/static/images/fa-bars.svg`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/http/static/images/favicon.ico` & `distributed-2024.5.2/distributed/http/static/images/favicon.ico`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/http/static/images/jupyter.svg` & `distributed-2024.5.2/distributed/http/static/images/jupyter.svg`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/http/static/images/numpy.png` & `distributed-2024.5.2/distributed/http/static/images/numpy.png`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/http/static/images/pandas.png` & `distributed-2024.5.2/distributed/http/static/images/pandas.png`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/http/static/images/python.png` & `distributed-2024.5.2/distributed/http/static/images/python.png`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/http/static/individual-cluster-map.html` & `distributed-2024.5.2/distributed/http/static/individual-cluster-map.html`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/http/static/js/anime.min.js` & `distributed-2024.5.2/distributed/http/static/js/anime.min.js`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/http/static/js/individual-cluster-map.js` & `distributed-2024.5.2/distributed/http/static/js/individual-cluster-map.js`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/http/static/js/reconnecting-websocket.min.js` & `distributed-2024.5.2/distributed/http/static/js/reconnecting-websocket.min.js`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/http/static/js/sortable.min.js` & `distributed-2024.5.2/distributed/http/static/js/sortable.min.js`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/http/templates/base.html` & `distributed-2024.5.2/distributed/http/templates/base.html`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/http/templates/exceptions.html` & `distributed-2024.5.2/distributed/http/templates/exceptions.html`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/http/templates/main.html` & `distributed-2024.5.2/distributed/http/templates/main.html`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/http/templates/status.html` & `distributed-2024.5.2/distributed/http/templates/status.html`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/http/templates/task.html` & `distributed-2024.5.2/distributed/http/templates/task.html`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/http/templates/worker-table.html` & `distributed-2024.5.2/distributed/http/templates/worker-table.html`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/http/templates/worker.html` & `distributed-2024.5.2/distributed/http/templates/worker.html`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/http/utils.py` & `distributed-2024.5.2/distributed/http/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/http/worker/prometheus/core.py` & `distributed-2024.5.2/distributed/http/worker/prometheus/core.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/itertools.py` & `distributed-2024.5.2/distributed/itertools.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/lock.py` & `distributed-2024.5.2/distributed/lock.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/metrics.py` & `distributed-2024.5.2/distributed/metrics.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/multi_lock.py` & `distributed-2024.5.2/distributed/multi_lock.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/nanny.py` & `distributed-2024.5.2/distributed/nanny.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/node.py` & `distributed-2024.5.2/distributed/node.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/objects.py` & `distributed-2024.5.2/distributed/objects.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/preloading.py` & `distributed-2024.5.2/distributed/preloading.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/process.py` & `distributed-2024.5.2/distributed/process.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/proctitle.py` & `distributed-2024.5.2/distributed/proctitle.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/profile.py` & `distributed-2024.5.2/distributed/profile.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/protocol/__init__.py` & `distributed-2024.5.2/distributed/protocol/__init__.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/protocol/arrow.py` & `distributed-2024.5.2/distributed/protocol/arrow.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/protocol/compression.py` & `distributed-2024.5.2/distributed/protocol/compression.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/protocol/core.py` & `distributed-2024.5.2/distributed/protocol/core.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/protocol/cuda.py` & `distributed-2024.5.2/distributed/protocol/cuda.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/protocol/cupy.py` & `distributed-2024.5.2/distributed/protocol/cupy.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/protocol/h5py.py` & `distributed-2024.5.2/distributed/protocol/h5py.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/protocol/keras.py` & `distributed-2024.5.2/distributed/protocol/keras.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/protocol/netcdf4.py` & `distributed-2024.5.2/distributed/protocol/netcdf4.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/protocol/numba.py` & `distributed-2024.5.2/distributed/protocol/numba.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/protocol/numpy.py` & `distributed-2024.5.2/distributed/protocol/numpy.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/protocol/pickle.py` & `distributed-2024.5.2/distributed/protocol/pickle.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/protocol/rmm.py` & `distributed-2024.5.2/distributed/protocol/rmm.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/protocol/scipy.py` & `distributed-2024.5.2/distributed/protocol/scipy.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/protocol/serialize.py` & `distributed-2024.5.2/distributed/protocol/serialize.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/protocol/sparse.py` & `distributed-2024.5.2/distributed/protocol/sparse.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/protocol/torch.py` & `distributed-2024.5.2/distributed/protocol/torch.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/protocol/utils.py` & `distributed-2024.5.2/distributed/protocol/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/protocol/utils_test.py` & `distributed-2024.5.2/distributed/protocol/utils_test.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/publish.py` & `distributed-2024.5.2/distributed/publish.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/pubsub.py` & `distributed-2024.5.2/distributed/pubsub.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/queues.py` & `distributed-2024.5.2/distributed/queues.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/recreate_tasks.py` & `distributed-2024.5.2/distributed/recreate_tasks.py`

 * *Files 1% similar despite different names*

```diff
@@ -89,15 +89,15 @@
         return (*spec["task"], spec["deps"])
 
     async def _prepare_raw_components(self, raw_components):
         """
         Take raw components and resolve future dependencies.
         """
         function, args, kwargs, deps = raw_components
-        futures = self.client._graph_to_futures({}, deps)
+        futures = self.client._graph_to_futures({}, deps, span_metadata={})
         data = await self.client._gather(futures)
         args = pack_data(args, data)
         kwargs = pack_data(kwargs, data)
         return (function, args, kwargs)
 
     async def _get_components_from_future(self, future):
         """
```

### Comparing `distributed-2024.5.1/distributed/scheduler.py` & `distributed-2024.5.2/distributed/scheduler.py`

 * *Files 0% similar despite different names*

```diff
@@ -190,20292 +190,20304 @@
 00000bd0: 6520 696d 706f 7274 2053 656d 6170 686f  e import Semapho
 00000be0: 7265 4578 7465 6e73 696f 6e0a 6672 6f6d  reExtension.from
 00000bf0: 2064 6973 7472 6962 7574 6564 2e73 6875   distributed.shu
 00000c00: 6666 6c65 2069 6d70 6f72 7420 5368 7566  ffle import Shuf
 00000c10: 666c 6553 6368 6564 756c 6572 506c 7567  fleSchedulerPlug
 00000c20: 696e 0a66 726f 6d20 6469 7374 7269 6275  in.from distribu
 00000c30: 7465 642e 7370 616e 7320 696d 706f 7274  ted.spans import
-00000c40: 2053 7061 6e73 5363 6865 6475 6c65 7245   SpansSchedulerE
-00000c50: 7874 656e 7369 6f6e 0a66 726f 6d20 6469  xtension.from di
-00000c60: 7374 7269 6275 7465 642e 7374 6561 6c69  stributed.steali
-00000c70: 6e67 2069 6d70 6f72 7420 576f 726b 5374  ng import WorkSt
-00000c80: 6561 6c69 6e67 0a66 726f 6d20 6469 7374  ealing.from dist
-00000c90: 7269 6275 7465 642e 7574 696c 7320 696d  ributed.utils im
-00000ca0: 706f 7274 2028 0a20 2020 2041 6c6c 2c0a  port (.    All,.
-00000cb0: 2020 2020 4465 6164 6c69 6e65 2c0a 2020      Deadline,.  
-00000cc0: 2020 5469 6d65 6f75 7445 7272 6f72 2c0a    TimeoutError,.
-00000cd0: 2020 2020 666f 726d 6174 5f64 6173 6862      format_dashb
-00000ce0: 6f61 7264 5f6c 696e 6b2c 0a20 2020 2067  oard_link,.    g
-00000cf0: 6574 5f66 696c 656e 6f5f 6c69 6d69 742c  et_fileno_limit,
-00000d00: 0a20 2020 2069 735f 7079 7468 6f6e 5f73  .    is_python_s
-00000d10: 6875 7474 696e 675f 646f 776e 2c0a 2020  hutting_down,.  
-00000d20: 2020 6b65 795f 7370 6c69 745f 6772 6f75    key_split_grou
-00000d30: 702c 0a20 2020 206c 6f67 5f65 7272 6f72  p,.    log_error
-00000d40: 732c 0a20 2020 206f 6666 6c6f 6164 2c0a  s,.    offload,.
-00000d50: 2020 2020 7265 6375 7273 6976 655f 746f      recursive_to
-00000d60: 5f64 6963 742c 0a20 2020 2077 6169 745f  _dict,.    wait_
-00000d70: 666f 722c 0a29 0a66 726f 6d20 6469 7374  for,.).from dist
-00000d80: 7269 6275 7465 642e 7574 696c 735f 636f  ributed.utils_co
-00000d90: 6d6d 2069 6d70 6f72 7420 280a 2020 2020  mm import (.    
-00000da0: 6761 7468 6572 5f66 726f 6d5f 776f 726b  gather_from_work
-00000db0: 6572 732c 0a20 2020 2072 6574 7279 5f6f  ers,.    retry_o
-00000dc0: 7065 7261 7469 6f6e 2c0a 2020 2020 7363  peration,.    sc
-00000dd0: 6174 7465 725f 746f 5f77 6f72 6b65 7273  atter_to_workers
-00000de0: 2c0a 2020 2020 756e 7061 636b 5f72 656d  ,.    unpack_rem
-00000df0: 6f74 6564 6174 612c 0a29 0a66 726f 6d20  otedata,.).from 
-00000e00: 6469 7374 7269 6275 7465 642e 7574 696c  distributed.util
-00000e10: 735f 7065 7266 2069 6d70 6f72 7420 6469  s_perf import di
-00000e20: 7361 626c 655f 6763 5f64 6961 676e 6f73  sable_gc_diagnos
-00000e30: 6973 2c20 656e 6162 6c65 5f67 635f 6469  is, enable_gc_di
-00000e40: 6167 6e6f 7369 730a 6672 6f6d 2064 6973  agnosis.from dis
-00000e50: 7472 6962 7574 6564 2e76 6172 6961 626c  tributed.variabl
-00000e60: 6520 696d 706f 7274 2056 6172 6961 626c  e import Variabl
-00000e70: 6545 7874 656e 7369 6f6e 0a66 726f 6d20  eExtension.from 
-00000e80: 6469 7374 7269 6275 7465 642e 776f 726b  distributed.work
-00000e90: 6572 2069 6d70 6f72 7420 5f6e 6f72 6d61  er import _norma
-00000ea0: 6c69 7a65 5f74 6173 6b0a 0a69 6620 5459  lize_task..if TY
-00000eb0: 5045 5f43 4845 434b 494e 473a 0a20 2020  PE_CHECKING:.   
-00000ec0: 2023 2054 4f44 4f20 696d 706f 7274 2066   # TODO import f
-00000ed0: 726f 6d20 7479 7069 6e67 2028 7265 7175  rom typing (requ
-00000ee0: 6972 6573 2050 7974 686f 6e20 3e3d 332e  ires Python >=3.
-00000ef0: 3130 290a 2020 2020 2320 544f 444f 2069  10).    # TODO i
-00000f00: 6d70 6f72 7420 6672 6f6d 2074 7970 696e  mport from typin
-00000f10: 6720 2872 6571 7569 7265 7320 5079 7468  g (requires Pyth
-00000f20: 6f6e 203e 3d33 2e31 3129 0a20 2020 2066  on >=3.11).    f
-00000f30: 726f 6d20 7479 7069 6e67 5f65 7874 656e  rom typing_exten
-00000f40: 7369 6f6e 7320 696d 706f 7274 2053 656c  sions import Sel
-00000f50: 662c 2054 7970 6541 6c69 6173 0a0a 2020  f, TypeAlias..  
-00000f60: 2020 6672 6f6d 2064 6173 6b2e 6869 6768    from dask.high
-00000f70: 6c65 7665 6c67 7261 7068 2069 6d70 6f72  levelgraph impor
-00000f80: 7420 4869 6768 4c65 7665 6c47 7261 7068  t HighLevelGraph
-00000f90: 0a0a 2320 4e6f 7420 746f 2062 6520 636f  ..# Not to be co
-00000fa0: 6e66 7573 6564 2077 6974 6820 6469 7374  nfused with dist
-00000fb0: 7269 6275 7465 642e 776f 726b 6572 5f73  ributed.worker_s
-00000fc0: 7461 7465 5f6d 6163 6869 6e65 2e54 6173  tate_machine.Tas
-00000fd0: 6b53 7461 7465 5374 6174 650a 5461 736b  kStateState.Task
-00000fe0: 5374 6174 6553 7461 7465 3a20 5479 7065  StateState: Type
-00000ff0: 416c 6961 7320 3d20 4c69 7465 7261 6c5b  Alias = Literal[
-00001000: 0a20 2020 2022 7265 6c65 6173 6564 222c  .    "released",
-00001010: 0a20 2020 2022 7761 6974 696e 6722 2c0a  .    "waiting",.
-00001020: 2020 2020 226e 6f2d 776f 726b 6572 222c      "no-worker",
-00001030: 0a20 2020 2022 7175 6575 6564 222c 0a20  .    "queued",. 
-00001040: 2020 2022 7072 6f63 6573 7369 6e67 222c     "processing",
-00001050: 0a20 2020 2022 6d65 6d6f 7279 222c 0a20  .    "memory",. 
-00001060: 2020 2022 6572 7265 6422 2c0a 2020 2020     "erred",.    
-00001070: 2266 6f72 676f 7474 656e 222c 0a5d 0a0a  "forgotten",.]..
-00001080: 414c 4c5f 5441 534b 5f53 5441 5445 533a  ALL_TASK_STATES:
-00001090: 2053 6574 5b54 6173 6b53 7461 7465 5374   Set[TaskStateSt
-000010a0: 6174 655d 203d 2073 6574 2854 6173 6b53  ate] = set(TaskS
-000010b0: 7461 7465 5374 6174 652e 5f5f 6172 6773  tateState.__args
-000010c0: 5f5f 2920 2023 2074 7970 653a 2069 676e  __)  # type: ign
-000010d0: 6f72 650a 0a23 207b 7461 736b 206b 6579  ore..# {task key
-000010e0: 202d 3e20 6669 6e69 7368 2073 7461 7465   -> finish state
-000010f0: 7d0a 2320 4e6f 7420 746f 2062 6520 636f  }.# Not to be co
-00001100: 6e66 7573 6564 2077 6974 6820 6469 7374  nfused with dist
-00001110: 7269 6275 7465 642e 776f 726b 6572 5f73  ributed.worker_s
-00001120: 7461 7465 5f6d 6163 6869 6e65 2e52 6563  tate_machine.Rec
-00001130: 730a 5265 6373 3a20 5479 7065 416c 6961  s.Recs: TypeAlia
-00001140: 7320 3d20 6469 6374 5b4b 6579 2c20 5461  s = dict[Key, Ta
-00001150: 736b 5374 6174 6553 7461 7465 5d0a 2320  skStateState].# 
-00001160: 7b63 6c69 656e 7420 6f72 2077 6f72 6b65  {client or worke
-00001170: 7220 6164 6472 6573 733a 205b 7b6f 703a  r address: [{op:
-00001180: 203c 6b65 793e 2c20 2e2e 2e7d 2c20 2e2e   <key>, ...}, ..
-00001190: 2e5d 7d0a 4d73 6773 3a20 5479 7065 416c  .]}.Msgs: TypeAl
-000011a0: 6961 7320 3d20 6469 6374 5b73 7472 2c20  ias = dict[str, 
-000011b0: 6c69 7374 5b64 6963 745b 7374 722c 2041  list[dict[str, A
-000011c0: 6e79 5d5d 5d0a 2320 2872 6563 6f6d 6d65  ny]]].# (recomme
-000011d0: 6e64 6174 696f 6e73 2c20 636c 6965 6e74  ndations, client
-000011e0: 206d 6573 7361 6765 732c 2077 6f72 6b65   messages, worke
-000011f0: 7220 6d65 7373 6167 6573 290a 5265 6373  r messages).Recs
-00001200: 4d73 6773 3a20 5479 7065 416c 6961 7320  Msgs: TypeAlias 
-00001210: 3d20 7475 706c 655b 5265 6373 2c20 4d73  = tuple[Recs, Ms
-00001220: 6773 2c20 4d73 6773 5d0a 0a54 5f72 756e  gs, Msgs]..T_run
-00001230: 7370 6563 3a20 5479 7065 416c 6961 7320  spec: TypeAlias 
-00001240: 3d20 7475 706c 655b 4361 6c6c 6162 6c65  = tuple[Callable
-00001250: 2c20 7475 706c 652c 2064 6963 745b 7374  , tuple, dict[st
-00001260: 722c 2041 6e79 5d5d 0a0a 6c6f 6767 6572  r, Any]]..logger
-00001270: 203d 206c 6f67 6769 6e67 2e67 6574 4c6f   = logging.getLo
-00001280: 6767 6572 285f 5f6e 616d 655f 5f29 0a4c  gger(__name__).L
-00001290: 4f47 5f50 4442 203d 2064 6173 6b2e 636f  OG_PDB = dask.co
-000012a0: 6e66 6967 2e67 6574 2822 6469 7374 7269  nfig.get("distri
-000012b0: 6275 7465 642e 6164 6d69 6e2e 7064 622d  buted.admin.pdb-
-000012c0: 6f6e 2d65 7272 2229 0a44 4546 4155 4c54  on-err").DEFAULT
-000012d0: 5f44 4154 415f 5349 5a45 203d 2070 6172  _DATA_SIZE = par
-000012e0: 7365 5f62 7974 6573 280a 2020 2020 6461  se_bytes(.    da
-000012f0: 736b 2e63 6f6e 6669 672e 6765 7428 2264  sk.config.get("d
-00001300: 6973 7472 6962 7574 6564 2e73 6368 6564  istributed.sched
-00001310: 756c 6572 2e64 6566 6175 6c74 2d64 6174  uler.default-dat
-00001320: 612d 7369 7a65 2229 0a29 0a53 5449 4d55  a-size").).STIMU
-00001330: 4c55 535f 4944 5f55 4e53 4554 203d 2022  LUS_ID_UNSET = "
-00001340: 3c73 7469 6d75 6c75 735f 6964 2075 6e73  <stimulus_id uns
-00001350: 6574 3e22 0a0a 4445 4641 554c 545f 4558  et>"..DEFAULT_EX
-00001360: 5445 4e53 494f 4e53 203d 207b 0a20 2020  TENSIONS = {.   
-00001370: 2022 6c6f 636b 7322 3a20 4c6f 636b 4578   "locks": LockEx
-00001380: 7465 6e73 696f 6e2c 0a20 2020 2022 6d75  tension,.    "mu
-00001390: 6c74 695f 6c6f 636b 7322 3a20 4d75 6c74  lti_locks": Mult
-000013a0: 694c 6f63 6b45 7874 656e 7369 6f6e 2c0a  iLockExtension,.
-000013b0: 2020 2020 2270 7562 6c69 7368 223a 2050      "publish": P
-000013c0: 7562 6c69 7368 4578 7465 6e73 696f 6e2c  ublishExtension,
-000013d0: 0a20 2020 2022 7265 706c 6179 2d74 6173  .    "replay-tas
-000013e0: 6b73 223a 2052 6570 6c61 7954 6173 6b53  ks": ReplayTaskS
-000013f0: 6368 6564 756c 6572 2c0a 2020 2020 2271  cheduler,.    "q
-00001400: 7565 7565 7322 3a20 5175 6575 6545 7874  ueues": QueueExt
-00001410: 656e 7369 6f6e 2c0a 2020 2020 2276 6172  ension,.    "var
-00001420: 6961 626c 6573 223a 2056 6172 6961 626c  iables": Variabl
-00001430: 6545 7874 656e 7369 6f6e 2c0a 2020 2020  eExtension,.    
-00001440: 2270 7562 7375 6222 3a20 5075 6253 7562  "pubsub": PubSub
-00001450: 5363 6865 6475 6c65 7245 7874 656e 7369  SchedulerExtensi
-00001460: 6f6e 2c0a 2020 2020 2273 656d 6170 686f  on,.    "semapho
-00001470: 7265 7322 3a20 5365 6d61 7068 6f72 6545  res": SemaphoreE
-00001480: 7874 656e 7369 6f6e 2c0a 2020 2020 2265  xtension,.    "e
-00001490: 7665 6e74 7322 3a20 4576 656e 7445 7874  vents": EventExt
-000014a0: 656e 7369 6f6e 2c0a 2020 2020 2261 6d6d  ension,.    "amm
-000014b0: 223a 2041 6374 6976 654d 656d 6f72 794d  ": ActiveMemoryM
-000014c0: 616e 6167 6572 4578 7465 6e73 696f 6e2c  anagerExtension,
-000014d0: 0a20 2020 2022 6d65 6d6f 7279 5f73 616d  .    "memory_sam
-000014e0: 706c 6572 223a 204d 656d 6f72 7953 616d  pler": MemorySam
-000014f0: 706c 6572 4578 7465 6e73 696f 6e2c 0a20  plerExtension,. 
-00001500: 2020 2022 7368 7566 666c 6522 3a20 5368     "shuffle": Sh
-00001510: 7566 666c 6553 6368 6564 756c 6572 506c  uffleSchedulerPl
-00001520: 7567 696e 2c0a 2020 2020 2273 7061 6e73  ugin,.    "spans
-00001530: 223a 2053 7061 6e73 5363 6865 6475 6c65  ": SpansSchedule
-00001540: 7245 7874 656e 7369 6f6e 2c0a 2020 2020  rExtension,.    
-00001550: 2273 7465 616c 696e 6722 3a20 576f 726b  "stealing": Work
-00001560: 5374 6561 6c69 6e67 2c0a 7d0a 0a0a 636c  Stealing,.}...cl
-00001570: 6173 7320 436c 6965 6e74 5374 6174 653a  ass ClientState:
-00001580: 0a20 2020 2022 2222 4120 7369 6d70 6c65  .    """A simple
-00001590: 206f 626a 6563 7420 686f 6c64 696e 6720   object holding 
-000015a0: 696e 666f 726d 6174 696f 6e20 6162 6f75  information abou
-000015b0: 7420 6120 636c 6965 6e74 2e22 2222 0a0a  t a client."""..
-000015c0: 2020 2020 233a 2041 2075 6e69 7175 6520      #: A unique 
-000015d0: 6964 656e 7469 6669 6572 2066 6f72 2074  identifier for t
-000015e0: 6869 7320 636c 6965 6e74 2e20 5468 6973  his client. This
-000015f0: 2069 7320 6765 6e65 7261 6c6c 7920 616e   is generally an
-00001600: 206f 7061 7175 650a 2020 2020 233a 2073   opaque.    #: s
-00001610: 7472 696e 6720 6765 6e65 7261 7465 6420  tring generated 
-00001620: 6279 2074 6865 2063 6c69 656e 7420 6974  by the client it
-00001630: 7365 6c66 2e0a 2020 2020 636c 6965 6e74  self..    client
-00001640: 5f6b 6579 3a20 7374 720a 0a20 2020 2023  _key: str..    #
-00001650: 3a20 4361 6368 6564 2068 6173 6820 6f66  : Cached hash of
-00001660: 203a 6174 7472 3a60 7e43 6c69 656e 7453   :attr:`~ClientS
-00001670: 7461 7465 2e63 6c69 656e 745f 6b65 7960  tate.client_key`
-00001680: 0a20 2020 205f 6861 7368 3a20 696e 740a  .    _hash: int.
-00001690: 0a20 2020 2023 3a20 4120 7365 7420 6f66  .    #: A set of
-000016a0: 2074 6173 6b73 2074 6869 7320 636c 6965   tasks this clie
-000016b0: 6e74 2077 616e 7473 2074 6f20 6265 206b  nt wants to be k
-000016c0: 6570 7420 696e 206d 656d 6f72 792c 2073  ept in memory, s
-000016d0: 6f20 7468 6174 2069 7420 6361 6e20 646f  o that it can do
-000016e0: 776e 6c6f 6164 0a20 2020 2023 3a20 6974  wnload.    #: it
-000016f0: 7320 7265 7375 6c74 2077 6865 6e20 6465  s result when de
-00001700: 7369 7265 642e 2054 6869 7320 6973 2074  sired. This is t
-00001710: 6865 2072 6576 6572 7365 206d 6170 7069  he reverse mappi
-00001720: 6e67 206f 660a 2020 2020 233a 203a 636c  ng of.    #: :cl
-00001730: 6173 733a 6054 6173 6b53 7461 7465 2e77  ass:`TaskState.w
-00001740: 686f 5f77 616e 7473 602e 2054 6173 6b73  ho_wants`. Tasks
-00001750: 2061 7265 2074 7970 6963 616c 6c79 2072   are typically r
-00001760: 656d 6f76 6564 2066 726f 6d20 7468 6973  emoved from this
-00001770: 2073 6574 2077 6865 6e20 7468 650a 2020   set when the.  
-00001780: 2020 233a 2063 6f72 7265 7370 6f6e 6469    #: correspondi
-00001790: 6e67 206f 626a 6563 7420 696e 2074 6865  ng object in the
-000017a0: 2063 6c69 656e 7427 7320 7370 6163 6520   client's space 
-000017b0: 2866 6f72 2065 7861 6d70 6c65 2061 2060  (for example a `
-000017c0: 6046 7574 7572 6560 6020 6f72 2061 2044  `Future`` or a D
-000017d0: 6173 6b0a 2020 2020 233a 2063 6f6c 6c65  ask.    #: colle
-000017e0: 6374 696f 6e29 2067 6574 7320 6761 7262  ction) gets garb
-000017f0: 6167 652d 636f 6c6c 6563 7465 642e 0a20  age-collected.. 
-00001800: 2020 2077 616e 7473 5f77 6861 743a 2073     wants_what: s
-00001810: 6574 5b54 6173 6b53 7461 7465 5d0a 0a20  et[TaskState].. 
-00001820: 2020 2023 3a20 5468 6520 6c61 7374 2074     #: The last t
-00001830: 696d 6520 7765 2072 6563 6569 7665 6420  ime we received 
-00001840: 6120 6865 6172 7462 6561 7420 6672 6f6d  a heartbeat from
-00001850: 2074 6869 7320 636c 6965 6e74 2c20 696e   this client, in
-00001860: 206c 6f63 616c 2073 6368 6564 756c 6572   local scheduler
-00001870: 2074 696d 652e 0a20 2020 206c 6173 745f   time..    last_
-00001880: 7365 656e 3a20 666c 6f61 740a 0a20 2020  seen: float..   
-00001890: 2023 3a20 4f75 7470 7574 206f 6620 3a66   #: Output of :f
-000018a0: 756e 633a 6064 6973 7472 6962 7574 6564  unc:`distributed
-000018b0: 2e76 6572 7369 6f6e 732e 6765 745f 7665  .versions.get_ve
-000018c0: 7273 696f 6e73 6020 6f6e 2074 6865 2063  rsions` on the c
-000018d0: 6c69 656e 740a 2020 2020 7665 7273 696f  lient.    versio
-000018e0: 6e73 3a20 6469 6374 5b73 7472 2c20 416e  ns: dict[str, An
-000018f0: 795d 0a0a 2020 2020 5f5f 736c 6f74 735f  y]..    __slots_
-00001900: 5f20 3d20 7475 706c 6528 5f5f 616e 6e6f  _ = tuple(__anno
-00001910: 7461 7469 6f6e 735f 5f29 0a0a 2020 2020  tations__)..    
-00001920: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
-00001930: 662c 2063 6c69 656e 743a 2073 7472 2c20  f, client: str, 
-00001940: 2a2c 2076 6572 7369 6f6e 733a 2064 6963  *, versions: dic
-00001950: 745b 7374 722c 2041 6e79 5d20 7c20 4e6f  t[str, Any] | No
-00001960: 6e65 203d 204e 6f6e 6529 3a0a 2020 2020  ne = None):.    
-00001970: 2020 2020 7365 6c66 2e63 6c69 656e 745f      self.client_
-00001980: 6b65 7920 3d20 636c 6965 6e74 0a20 2020  key = client.   
-00001990: 2020 2020 2073 656c 662e 5f68 6173 6820       self._hash 
-000019a0: 3d20 6861 7368 2863 6c69 656e 7429 0a20  = hash(client). 
-000019b0: 2020 2020 2020 2073 656c 662e 7761 6e74         self.want
-000019c0: 735f 7768 6174 203d 2073 6574 2829 0a20  s_what = set(). 
-000019d0: 2020 2020 2020 2073 656c 662e 6c61 7374         self.last
-000019e0: 5f73 6565 6e20 3d20 7469 6d65 2829 0a20  _seen = time(). 
-000019f0: 2020 2020 2020 2073 656c 662e 7665 7273         self.vers
-00001a00: 696f 6e73 203d 2076 6572 7369 6f6e 7320  ions = versions 
-00001a10: 6f72 207b 7d0a 0a20 2020 2064 6566 205f  or {}..    def _
-00001a20: 5f68 6173 685f 5f28 7365 6c66 2920 2d3e  _hash__(self) ->
-00001a30: 2069 6e74 3a0a 2020 2020 2020 2020 7265   int:.        re
-00001a40: 7475 726e 2073 656c 662e 5f68 6173 680a  turn self._hash.
-00001a50: 0a20 2020 2064 6566 205f 5f65 715f 5f28  .    def __eq__(
-00001a60: 7365 6c66 2c20 6f74 6865 723a 206f 626a  self, other: obj
-00001a70: 6563 7429 202d 3e20 626f 6f6c 3a0a 2020  ect) -> bool:.  
-00001a80: 2020 2020 2020 6966 206e 6f74 2069 7369        if not isi
-00001a90: 6e73 7461 6e63 6528 6f74 6865 722c 2043  nstance(other, C
-00001aa0: 6c69 656e 7453 7461 7465 293a 0a20 2020  lientState):.   
-00001ab0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00001ac0: 4661 6c73 650a 2020 2020 2020 2020 7265  False.        re
-00001ad0: 7475 726e 2073 656c 662e 636c 6965 6e74  turn self.client
-00001ae0: 5f6b 6579 203d 3d20 6f74 6865 722e 636c  _key == other.cl
-00001af0: 6965 6e74 5f6b 6579 0a0a 2020 2020 6465  ient_key..    de
-00001b00: 6620 5f5f 7265 7072 5f5f 2873 656c 6629  f __repr__(self)
-00001b10: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
-00001b20: 2072 6574 7572 6e20 6622 3c43 6c69 656e   return f"<Clien
-00001b30: 7420 7b73 656c 662e 636c 6965 6e74 5f6b  t {self.client_k
-00001b40: 6579 2172 7d3e 220a 0a20 2020 2064 6566  ey!r}>"..    def
-00001b50: 205f 5f73 7472 5f5f 2873 656c 6629 202d   __str__(self) -
-00001b60: 3e20 7374 723a 0a20 2020 2020 2020 2072  > str:.        r
-00001b70: 6574 7572 6e20 7365 6c66 2e63 6c69 656e  eturn self.clien
-00001b80: 745f 6b65 790a 0a20 2020 2064 6566 205f  t_key..    def _
-00001b90: 746f 5f64 6963 745f 6e6f 5f6e 6573 7428  to_dict_no_nest(
-00001ba0: 7365 6c66 2c20 2a2c 2065 7863 6c75 6465  self, *, exclude
-00001bb0: 3a20 436f 6e74 6169 6e65 725b 7374 725d  : Container[str]
-00001bc0: 203d 2028 2929 202d 3e20 6469 6374 3a0a   = ()) -> dict:.
-00001bd0: 2020 2020 2020 2020 2222 2244 6963 7469          """Dicti
-00001be0: 6f6e 6172 7920 7265 7072 6573 656e 7461  onary representa
-00001bf0: 7469 6f6e 2066 6f72 2064 6562 7567 6769  tion for debuggi
-00001c00: 6e67 2070 7572 706f 7365 732e 0a20 2020  ng purposes..   
-00001c10: 2020 2020 204e 6f74 2074 7970 6520 7374       Not type st
-00001c20: 6162 6c65 2061 6e64 206e 6f74 2069 6e74  able and not int
-00001c30: 656e 6465 6420 666f 7220 726f 756e 6474  ended for roundt
-00001c40: 7269 7073 2e0a 0a20 2020 2020 2020 2053  rips...        S
-00001c50: 6565 2061 6c73 6f0a 2020 2020 2020 2020  ee also.        
-00001c60: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020 2020  --------.       
-00001c70: 2043 6c69 656e 742e 6475 6d70 5f63 6c75   Client.dump_clu
-00001c80: 7374 6572 5f73 7461 7465 0a20 2020 2020  ster_state.     
-00001c90: 2020 2064 6973 7472 6962 7574 6564 2e75     distributed.u
-00001ca0: 7469 6c73 2e72 6563 7572 7369 7665 5f74  tils.recursive_t
-00001cb0: 6f5f 6469 6374 0a20 2020 2020 2020 2054  o_dict.        T
-00001cc0: 6173 6b53 7461 7465 2e5f 746f 5f64 6963  askState._to_dic
-00001cd0: 740a 2020 2020 2020 2020 2222 220a 2020  t.        """.  
-00001ce0: 2020 2020 2020 7265 7475 726e 2072 6563        return rec
-00001cf0: 7572 7369 7665 5f74 6f5f 6469 6374 280a  ursive_to_dict(.
-00001d00: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00001d10: 2c0a 2020 2020 2020 2020 2020 2020 6578  ,.            ex
-00001d20: 636c 7564 653d 7365 7428 6578 636c 7564  clude=set(exclud
-00001d30: 6529 207c 207b 2276 6572 7369 6f6e 7322  e) | {"versions"
-00001d40: 7d2c 2020 2320 7479 7065 3a20 6967 6e6f  },  # type: igno
-00001d50: 7265 0a20 2020 2020 2020 2020 2020 206d  re.            m
-00001d60: 656d 6265 7273 3d54 7275 652c 0a20 2020  embers=True,.   
-00001d70: 2020 2020 2029 0a0a 0a63 6c61 7373 204d       )...class M
-00001d80: 656d 6f72 7953 7461 7465 3a0a 2020 2020  emoryState:.    
-00001d90: 2222 224d 656d 6f72 7920 7265 6164 696e  """Memory readin
-00001da0: 6773 206f 6e20 6120 776f 726b 6572 206f  gs on a worker o
-00001db0: 7220 6f6e 2074 6865 2077 686f 6c65 2063  r on the whole c
-00001dc0: 6c75 7374 6572 2e0a 0a20 2020 2053 6565  luster...    See
-00001dd0: 203a 646f 633a 6077 6f72 6b65 722d 6d65   :doc:`worker-me
-00001de0: 6d6f 7279 602e 0a0a 2020 2020 4174 7472  mory`...    Attr
-00001df0: 6962 7574 6573 202f 2070 726f 7065 7274  ibutes / propert
-00001e00: 6965 733a 0a0a 2020 2020 6d61 6e61 6765  ies:..    manage
-00001e10: 645f 746f 7461 6c0a 2020 2020 2020 2020  d_total.        
-00001e20: 5375 6d20 6f66 2074 6865 206f 7574 7075  Sum of the outpu
-00001e30: 7420 6f66 2073 697a 656f 6628 2920 666f  t of sizeof() fo
-00001e40: 7220 616c 6c20 6461 736b 206b 6579 7320  r all dask keys 
-00001e50: 6865 6c64 2062 7920 7468 6520 776f 726b  held by the work
-00001e60: 6572 2069 6e20 6d65 6d6f 7279 2c0a 2020  er in memory,.  
-00001e70: 2020 2020 2020 706c 7573 206e 756d 6265        plus numbe
-00001e80: 7220 6f66 2062 7974 6573 2073 7069 6c6c  r of bytes spill
-00001e90: 6564 2074 6f20 6469 736b 0a0a 2020 2020  ed to disk..    
-00001ea0: 6d61 6e61 6765 640a 2020 2020 2020 2020  managed.        
-00001eb0: 5375 6d20 6f66 2074 6865 206f 7574 7075  Sum of the outpu
-00001ec0: 7420 6f66 2073 697a 656f 6628 2920 666f  t of sizeof() fo
-00001ed0: 7220 7468 6520 6461 736b 206b 6579 7320  r the dask keys 
-00001ee0: 6865 6c64 2069 6e20 5241 4d2e 204e 6f74  held in RAM. Not
-00001ef0: 6520 7468 6174 2074 6869 7320 6d61 790a  e that this may.
-00001f00: 2020 2020 2020 2020 6265 2069 6e61 6363          be inacc
-00001f10: 7572 6174 652c 2077 6869 6368 206d 6179  urate, which may
-00001f20: 2063 6175 7365 2069 6e61 6363 7572 6174   cause inaccurat
-00001f30: 6520 756e 6d61 6e61 6765 6420 6d65 6d6f  e unmanaged memo
-00001f40: 7279 2028 7365 6520 6265 6c6f 7729 2e0a  ry (see below)..
-00001f50: 0a20 2020 2073 7069 6c6c 6564 0a20 2020  .    spilled.   
-00001f60: 2020 2020 204e 756d 6265 7220 6f66 2062       Number of b
-00001f70: 7974 6573 2020 666f 7220 7468 6520 6461  ytes  for the da
-00001f80: 736b 206b 6579 7320 7370 696c 6c65 6420  sk keys spilled 
-00001f90: 746f 2074 6865 2068 6172 6420 6472 6976  to the hard driv
-00001fa0: 652e 0a20 2020 2020 2020 204e 6f74 6520  e..        Note 
-00001fb0: 7468 6174 2074 6869 7320 6973 2074 6865  that this is the
-00001fc0: 2073 697a 6520 6f6e 2064 6973 6b3b 2073   size on disk; s
-00001fd0: 697a 6520 696e 206d 656d 6f72 7920 6d61  ize in memory ma
-00001fe0: 7920 6265 2064 6966 6665 7265 6e74 2064  y be different d
-00001ff0: 7565 2074 6f0a 2020 2020 2020 2020 636f  ue to.        co
-00002000: 6d70 7265 7373 696f 6e20 616e 6420 696e  mpression and in
-00002010: 6163 6375 7261 6369 6573 2069 6e20 7369  accuracies in si
-00002020: 7a65 6f66 2829 2e20 496e 206f 7468 6572  zeof(). In other
-00002030: 2077 6f72 6473 2c20 6769 7665 6e20 7468   words, given th
-00002040: 6520 7361 6d65 206b 6579 732c 0a20 2020  e same keys,.   
-00002050: 2020 2020 2027 6d61 6e61 6765 6427 2077       'managed' w
-00002060: 696c 6c20 6368 616e 6765 2064 6570 656e  ill change depen
-00002070: 6469 6e67 206f 6e20 7468 6520 6b65 7973  ding on the keys
-00002080: 2062 6569 6e67 2069 6e20 6d65 6d6f 7279   being in memory
-00002090: 206f 7220 7370 696c 6c65 642e 0a0a 2020   or spilled...  
-000020a0: 2020 7072 6f63 6573 730a 2020 2020 2020    process.      
-000020b0: 2020 546f 7461 6c20 5253 5320 6d65 6d6f    Total RSS memo
-000020c0: 7279 206d 6561 7375 7265 6420 6279 2074  ry measured by t
-000020d0: 6865 204f 5320 6f6e 2074 6865 2077 6f72  he OS on the wor
-000020e0: 6b65 7220 7072 6f63 6573 732e 0a20 2020  ker process..   
-000020f0: 2020 2020 2054 6869 7320 6973 2061 6c77       This is alw
-00002100: 6179 7320 6578 6163 746c 7920 6571 7561  ays exactly equa
-00002110: 6c20 746f 206d 616e 6167 6564 202b 2075  l to managed + u
-00002120: 6e6d 616e 6167 6564 2e0a 0a20 2020 2075  nmanaged...    u
-00002130: 6e6d 616e 6167 6564 0a20 2020 2020 2020  nmanaged.       
-00002140: 2070 726f 6365 7373 202d 206d 616e 6167   process - manag
-00002150: 6564 2e20 5468 6973 2069 7320 7468 6520  ed. This is the 
-00002160: 7375 6d20 6f66 0a0a 2020 2020 2020 2020  sum of..        
-00002170: 2d20 5079 7468 6f6e 2069 6e74 6572 7072  - Python interpr
-00002180: 6574 6572 2061 6e64 206d 6f64 756c 6573  eter and modules
-00002190: 0a20 2020 2020 2020 202d 2067 6c6f 6261  .        - globa
-000021a0: 6c20 7661 7269 6162 6c65 730a 2020 2020  l variables.    
-000021b0: 2020 2020 2d20 6d65 6d6f 7279 2074 656d      - memory tem
-000021c0: 706f 7261 7269 6c79 2061 6c6c 6f63 6174  porarily allocat
-000021d0: 6564 2062 7920 7468 6520 6461 736b 2074  ed by the dask t
-000021e0: 6173 6b73 2074 6861 7420 6172 6520 6375  asks that are cu
-000021f0: 7272 656e 746c 7920 7275 6e6e 696e 670a  rrently running.
-00002200: 2020 2020 2020 2020 2d20 6d65 6d6f 7279          - memory
-00002210: 2066 7261 676d 656e 7461 7469 6f6e 0a20   fragmentation. 
-00002220: 2020 2020 2020 202d 206d 656d 6f72 7920         - memory 
-00002230: 6c65 616b 730a 2020 2020 2020 2020 2d20  leaks.        - 
-00002240: 6d65 6d6f 7279 206e 6f74 2079 6574 2067  memory not yet g
-00002250: 6172 6261 6765 2063 6f6c 6c65 6374 6564  arbage collected
-00002260: 0a20 2020 2020 2020 202d 206d 656d 6f72  .        - memor
-00002270: 7920 6e6f 7420 7965 7420 6672 6565 2829  y not yet free()
-00002280: 2764 2062 7920 7468 6520 5079 7468 6f6e  'd by the Python
-00002290: 206d 656d 6f72 7920 6d61 6e61 6765 7220   memory manager 
-000022a0: 746f 2074 6865 204f 530a 0a20 2020 2075  to the OS..    u
-000022b0: 6e6d 616e 6167 6564 5f6f 6c64 0a20 2020  nmanaged_old.   
-000022c0: 2020 2020 204d 696e 696d 756d 206f 6620       Minimum of 
-000022d0: 7468 6520 2775 6e6d 616e 6167 6564 2720  the 'unmanaged' 
-000022e0: 6d65 6173 7572 6573 206f 7665 7220 7468  measures over th
-000022f0: 6520 6c61 7374 0a20 2020 2020 2020 2060  e last.        `
-00002300: 6064 6973 7472 6962 7574 6564 2e6d 656d  `distributed.mem
-00002310: 6f72 792e 7265 6365 6e74 2d74 6f2d 6f6c  ory.recent-to-ol
-00002320: 642d 7469 6d65 6060 2073 6563 6f6e 6473  d-time`` seconds
-00002330: 0a0a 2020 2020 756e 6d61 6e61 6765 645f  ..    unmanaged_
-00002340: 7265 6365 6e74 0a20 2020 2020 2020 2075  recent.        u
-00002350: 6e6d 616e 6167 6564 202d 2075 6e6d 616e  nmanaged - unman
-00002360: 6167 6564 5f6f 6c64 3b20 696e 206f 7468  aged_old; in oth
-00002370: 6572 2077 6f72 6473 2070 726f 6365 7373  er words process
-00002380: 206d 656d 6f72 7920 7468 6174 2068 6173   memory that has
-00002390: 2062 6565 6e20 7265 6365 6e74 6c79 0a20   been recently. 
-000023a0: 2020 2020 2020 2061 6c6c 6f63 6174 6564         allocated
-000023b0: 2062 7574 2069 7320 6e6f 7420 6163 636f   but is not acco
-000023c0: 756e 7465 6420 666f 7220 6279 2064 6173  unted for by das
-000023d0: 6b3b 2068 6f70 6566 756c 6c79 2069 7427  k; hopefully it'
-000023e0: 7320 6d6f 7374 6c79 2061 2074 656d 706f  s mostly a tempo
-000023f0: 7261 7279 0a20 2020 2020 2020 2073 7069  rary.        spi
-00002400: 6b65 2e0a 0a20 2020 206f 7074 696d 6973  ke...    optimis
-00002410: 7469 630a 2020 2020 2020 2020 6d61 6e61  tic.        mana
-00002420: 6765 6420 2b20 756e 6d61 6e61 6765 645f  ged + unmanaged_
-00002430: 6f6c 643b 2069 6e20 6f74 6865 7220 776f  old; in other wo
-00002440: 7264 7320 7468 6520 6d65 6d6f 7279 2068  rds the memory h
-00002450: 656c 6420 6c6f 6e67 2d74 6572 6d20 6279  eld long-term by
-00002460: 0a20 2020 2020 2020 2074 6865 2070 726f  .        the pro
-00002470: 6365 7373 2075 6e64 6572 2074 6865 2068  cess under the h
-00002480: 6f70 6566 756c 2061 7373 756d 7074 696f  opeful assumptio
-00002490: 6e20 7468 6174 2061 6c6c 2075 6e6d 616e  n that all unman
-000024a0: 6167 6564 5f72 6563 656e 7420 6d65 6d6f  aged_recent memo
-000024b0: 7279 2069 7320 610a 2020 2020 2020 2020  ry is a.        
-000024c0: 7465 6d70 6f72 6172 7920 7370 696b 650a  temporary spike.
-000024d0: 2020 2020 2222 220a 0a20 2020 2070 726f      """..    pro
-000024e0: 6365 7373 3a20 696e 740a 2020 2020 756e  cess: int.    un
-000024f0: 6d61 6e61 6765 645f 6f6c 643a 2069 6e74  managed_old: int
-00002500: 0a20 2020 206d 616e 6167 6564 3a20 696e  .    managed: in
-00002510: 740a 2020 2020 7370 696c 6c65 643a 2069  t.    spilled: i
-00002520: 6e74 0a0a 2020 2020 5f5f 736c 6f74 735f  nt..    __slots_
-00002530: 5f20 3d20 7475 706c 6528 5f5f 616e 6e6f  _ = tuple(__anno
-00002540: 7461 7469 6f6e 735f 5f29 0a0a 2020 2020  tations__)..    
-00002550: 6465 6620 5f5f 696e 6974 5f5f 280a 2020  def __init__(.  
-00002560: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-00002570: 2020 2020 2a2c 0a20 2020 2020 2020 2070      *,.        p
-00002580: 726f 6365 7373 3a20 696e 742c 0a20 2020  rocess: int,.   
-00002590: 2020 2020 2075 6e6d 616e 6167 6564 5f6f       unmanaged_o
-000025a0: 6c64 3a20 696e 742c 0a20 2020 2020 2020  ld: int,.       
-000025b0: 206d 616e 6167 6564 3a20 696e 742c 0a20   managed: int,. 
-000025c0: 2020 2020 2020 2073 7069 6c6c 6564 3a20         spilled: 
-000025d0: 696e 742c 0a20 2020 2029 3a0a 2020 2020  int,.    ):.    
-000025e0: 2020 2020 2320 536f 6d65 2064 6174 6120      # Some data 
-000025f0: 6172 7269 7665 7320 7769 7468 2074 6865  arrives with the
-00002600: 2068 6561 7274 6265 6174 2c20 736f 6d65   heartbeat, some
-00002610: 206f 7468 6572 2061 7272 6976 6573 2069   other arrives i
-00002620: 6e20 7265 616c 7469 6d65 2061 7320 7468  n realtime as th
-00002630: 650a 2020 2020 2020 2020 2320 7461 736b  e.        # task
-00002640: 7320 7072 6f67 7265 7373 2e20 416c 736f  s progress. Also
-00002650: 2c20 7369 7a65 6f66 2829 2069 7320 6e6f  , sizeof() is no
-00002660: 7420 6775 6172 616e 7465 6564 2074 6f20  t guaranteed to 
-00002670: 7265 7475 726e 2063 6f72 7265 6374 2072  return correct r
-00002680: 6573 756c 7473 2e0a 2020 2020 2020 2020  esults..        
-00002690: 2320 5468 6973 2063 616e 2063 6175 7365  # This can cause
-000026a0: 2067 6c69 7463 6865 7320 7768 6572 6520   glitches where 
-000026b0: 6120 7061 7274 6961 6c20 6d65 6173 7572  a partial measur
-000026c0: 6520 6973 206c 6172 6765 7220 7468 616e  e is larger than
-000026d0: 2074 6865 2077 686f 6c65 2c20 736f 0a20   the whole, so. 
-000026e0: 2020 2020 2020 2023 2077 6520 6e65 6564         # we need
-000026f0: 2074 6f20 666f 7263 6520 616c 6c20 6e75   to force all nu
-00002700: 6d62 6572 7320 746f 2061 6464 2075 7020  mbers to add up 
-00002710: 6578 6163 746c 7920 6279 2064 6566 696e  exactly by defin
-00002720: 6974 696f 6e2e 0a20 2020 2020 2020 2073  ition..        s
-00002730: 656c 662e 7072 6f63 6573 7320 3d20 7072  elf.process = pr
-00002740: 6f63 6573 730a 2020 2020 2020 2020 7365  ocess.        se
-00002750: 6c66 2e6d 616e 6167 6564 203d 206d 696e  lf.managed = min
-00002760: 2873 656c 662e 7072 6f63 6573 732c 206d  (self.process, m
-00002770: 616e 6167 6564 290a 2020 2020 2020 2020  anaged).        
-00002780: 7365 6c66 2e73 7069 6c6c 6564 203d 2073  self.spilled = s
-00002790: 7069 6c6c 6564 0a20 2020 2020 2020 2023  pilled.        #
-000027a0: 2053 7562 7472 6163 7469 6f6e 7320 6265   Subtractions be
-000027b0: 7477 6565 6e20 756e 7369 676e 6564 2069  tween unsigned i
-000027c0: 6e74 7320 6775 6172 616e 7465 6564 2062  nts guaranteed b
-000027d0: 7920 636f 6e73 7472 7563 7469 6f6e 2074  y construction t
-000027e0: 6f20 6265 203e 3d20 300a 2020 2020 2020  o be >= 0.      
-000027f0: 2020 7365 6c66 2e75 6e6d 616e 6167 6564    self.unmanaged
-00002800: 5f6f 6c64 203d 206d 696e 2875 6e6d 616e  _old = min(unman
-00002810: 6167 6564 5f6f 6c64 2c20 7072 6f63 6573  aged_old, proces
-00002820: 7320 2d20 7365 6c66 2e6d 616e 6167 6564  s - self.managed
-00002830: 290a 0a20 2020 2040 7374 6174 6963 6d65  )..    @staticme
-00002840: 7468 6f64 0a20 2020 2064 6566 2073 756d  thod.    def sum
-00002850: 282a 696e 666f 733a 204d 656d 6f72 7953  (*infos: MemoryS
-00002860: 7461 7465 2920 2d3e 204d 656d 6f72 7953  tate) -> MemoryS
-00002870: 7461 7465 3a0a 2020 2020 2020 2020 7072  tate:.        pr
-00002880: 6f63 6573 7320 3d20 300a 2020 2020 2020  ocess = 0.      
-00002890: 2020 756e 6d61 6e61 6765 645f 6f6c 6420    unmanaged_old 
-000028a0: 3d20 300a 2020 2020 2020 2020 6d61 6e61  = 0.        mana
-000028b0: 6765 6420 3d20 300a 2020 2020 2020 2020  ged = 0.        
-000028c0: 7370 696c 6c65 6420 3d20 300a 2020 2020  spilled = 0.    
-000028d0: 2020 2020 666f 7220 6d73 2069 6e20 696e      for ms in in
-000028e0: 666f 733a 0a20 2020 2020 2020 2020 2020  fos:.           
-000028f0: 2070 726f 6365 7373 202b 3d20 6d73 2e70   process += ms.p
-00002900: 726f 6365 7373 0a20 2020 2020 2020 2020  rocess.         
-00002910: 2020 2075 6e6d 616e 6167 6564 5f6f 6c64     unmanaged_old
-00002920: 202b 3d20 6d73 2e75 6e6d 616e 6167 6564   += ms.unmanaged
-00002930: 5f6f 6c64 0a20 2020 2020 2020 2020 2020  _old.           
-00002940: 2073 7069 6c6c 6564 202b 3d20 6d73 2e73   spilled += ms.s
-00002950: 7069 6c6c 6564 0a20 2020 2020 2020 2020  pilled.         
-00002960: 2020 206d 616e 6167 6564 202b 3d20 6d73     managed += ms
-00002970: 2e6d 616e 6167 6564 0a20 2020 2020 2020  .managed.       
-00002980: 2072 6574 7572 6e20 4d65 6d6f 7279 5374   return MemorySt
-00002990: 6174 6528 0a20 2020 2020 2020 2020 2020  ate(.           
-000029a0: 2070 726f 6365 7373 3d70 726f 6365 7373   process=process
-000029b0: 2c0a 2020 2020 2020 2020 2020 2020 756e  ,.            un
-000029c0: 6d61 6e61 6765 645f 6f6c 643d 756e 6d61  managed_old=unma
-000029d0: 6e61 6765 645f 6f6c 642c 0a20 2020 2020  naged_old,.     
-000029e0: 2020 2020 2020 206d 616e 6167 6564 3d6d         managed=m
-000029f0: 616e 6167 6564 2c0a 2020 2020 2020 2020  anaged,.        
-00002a00: 2020 2020 7370 696c 6c65 643d 7370 696c      spilled=spil
-00002a10: 6c65 642c 0a20 2020 2020 2020 2029 0a0a  led,.        )..
-00002a20: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
-00002a30: 2020 6465 6620 6d61 6e61 6765 645f 746f    def managed_to
-00002a40: 7461 6c28 7365 6c66 2920 2d3e 2069 6e74  tal(self) -> int
-00002a50: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-00002a60: 2073 656c 662e 6d61 6e61 6765 6420 2b20   self.managed + 
-00002a70: 7365 6c66 2e73 7069 6c6c 6564 0a0a 2020  self.spilled..  
-00002a80: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
-00002a90: 6465 6620 756e 6d61 6e61 6765 6428 7365  def unmanaged(se
-00002aa0: 6c66 2920 2d3e 2069 6e74 3a0a 2020 2020  lf) -> int:.    
-00002ab0: 2020 2020 2320 5468 6973 2069 7320 6e65      # This is ne
-00002ac0: 7665 7220 6e65 6761 7469 7665 2074 6861  ver negative tha
-00002ad0: 6e6b 7320 746f 205f 5f69 6e69 745f 5f0a  nks to __init__.
-00002ae0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00002af0: 656c 662e 7072 6f63 6573 7320 2d20 7365  elf.process - se
-00002b00: 6c66 2e6d 616e 6167 6564 0a0a 2020 2020  lf.managed..    
-00002b10: 4070 726f 7065 7274 790a 2020 2020 6465  @property.    de
-00002b20: 6620 756e 6d61 6e61 6765 645f 7265 6365  f unmanaged_rece
-00002b30: 6e74 2873 656c 6629 202d 3e20 696e 743a  nt(self) -> int:
-00002b40: 0a20 2020 2020 2020 2023 2054 6869 7320  .        # This 
-00002b50: 6973 206e 6576 6572 206e 6567 6174 6976  is never negativ
-00002b60: 6520 7468 616e 6b73 2074 6f20 5f5f 696e  e thanks to __in
-00002b70: 6974 5f5f 0a20 2020 2020 2020 2072 6574  it__.        ret
-00002b80: 7572 6e20 7365 6c66 2e70 726f 6365 7373  urn self.process
-00002b90: 202d 2073 656c 662e 6d61 6e61 6765 6420   - self.managed 
-00002ba0: 2d20 7365 6c66 2e75 6e6d 616e 6167 6564  - self.unmanaged
-00002bb0: 5f6f 6c64 0a0a 2020 2020 4070 726f 7065  _old..    @prope
-00002bc0: 7274 790a 2020 2020 6465 6620 6f70 7469  rty.    def opti
-00002bd0: 6d69 7374 6963 2873 656c 6629 202d 3e20  mistic(self) -> 
-00002be0: 696e 743a 0a20 2020 2020 2020 2072 6574  int:.        ret
-00002bf0: 7572 6e20 7365 6c66 2e6d 616e 6167 6564  urn self.managed
-00002c00: 202b 2073 656c 662e 756e 6d61 6e61 6765   + self.unmanage
-00002c10: 645f 6f6c 640a 0a20 2020 2040 7072 6f70  d_old..    @prop
-00002c20: 6572 7479 0a20 2020 2064 6566 206d 616e  erty.    def man
-00002c30: 6167 6564 5f69 6e5f 6d65 6d6f 7279 2873  aged_in_memory(s
-00002c40: 656c 6629 202d 3e20 696e 743a 0a20 2020  elf) -> int:.   
-00002c50: 2020 2020 2077 6172 6e69 6e67 732e 7761       warnings.wa
-00002c60: 726e 2822 6d61 6e61 6765 645f 696e 5f6d  rn("managed_in_m
-00002c70: 656d 6f72 7920 6861 7320 6265 656e 2072  emory has been r
-00002c80: 656e 616d 6564 2074 6f20 6d61 6e61 6765  enamed to manage
-00002c90: 6422 2c20 4675 7475 7265 5761 726e 696e  d", FutureWarnin
-00002ca0: 6729 0a20 2020 2020 2020 2072 6574 7572  g).        retur
-00002cb0: 6e20 7365 6c66 2e6d 616e 6167 6564 0a0a  n self.managed..
-00002cc0: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
-00002cd0: 2020 6465 6620 6d61 6e61 6765 645f 7370    def managed_sp
-00002ce0: 696c 6c65 6428 7365 6c66 2920 2d3e 2069  illed(self) -> i
-00002cf0: 6e74 3a0a 2020 2020 2020 2020 7761 726e  nt:.        warn
-00002d00: 696e 6773 2e77 6172 6e28 226d 616e 6167  ings.warn("manag
-00002d10: 6564 5f73 7069 6c6c 6564 2068 6173 2062  ed_spilled has b
-00002d20: 6565 6e20 7265 6e61 6d65 6420 746f 2073  een renamed to s
-00002d30: 7069 6c6c 6564 222c 2046 7574 7572 6557  pilled", FutureW
-00002d40: 6172 6e69 6e67 290a 2020 2020 2020 2020  arning).        
-00002d50: 7265 7475 726e 2073 656c 662e 7370 696c  return self.spil
-00002d60: 6c65 640a 0a20 2020 2064 6566 205f 5f72  led..    def __r
-00002d70: 6570 725f 5f28 7365 6c66 2920 2d3e 2073  epr__(self) -> s
-00002d80: 7472 3a0a 2020 2020 2020 2020 7265 7475  tr:.        retu
-00002d90: 726e 2028 0a20 2020 2020 2020 2020 2020  rn (.           
-00002da0: 2066 2250 726f 6365 7373 206d 656d 6f72   f"Process memor
-00002db0: 7920 2852 5353 2920 203a 207b 666f 726d  y (RSS)  : {form
-00002dc0: 6174 5f62 7974 6573 2873 656c 662e 7072  at_bytes(self.pr
-00002dd0: 6f63 6573 7329 7d5c 6e22 0a20 2020 2020  ocess)}\n".     
-00002de0: 2020 2020 2020 2066 2220 202d 206d 616e         f"  - man
-00002df0: 6167 6564 2062 7920 4461 736b 2020 203a  aged by Dask   :
-00002e00: 207b 666f 726d 6174 5f62 7974 6573 2873   {format_bytes(s
-00002e10: 656c 662e 6d61 6e61 6765 6429 7d5c 6e22  elf.managed)}\n"
-00002e20: 0a20 2020 2020 2020 2020 2020 2066 2220  .            f" 
-00002e30: 202d 2075 6e6d 616e 6167 6564 2028 6f6c   - unmanaged (ol
-00002e40: 6429 2020 203a 207b 666f 726d 6174 5f62  d)   : {format_b
-00002e50: 7974 6573 2873 656c 662e 756e 6d61 6e61  ytes(self.unmana
-00002e60: 6765 645f 6f6c 6429 7d5c 6e22 0a20 2020  ged_old)}\n".   
-00002e70: 2020 2020 2020 2020 2066 2220 202d 2075           f"  - u
-00002e80: 6e6d 616e 6167 6564 2028 7265 6365 6e74  nmanaged (recent
-00002e90: 293a 207b 666f 726d 6174 5f62 7974 6573  ): {format_bytes
-00002ea0: 2873 656c 662e 756e 6d61 6e61 6765 645f  (self.unmanaged_
-00002eb0: 7265 6365 6e74 297d 5c6e 220a 2020 2020  recent)}\n".    
-00002ec0: 2020 2020 2020 2020 6622 5370 696c 6c65          f"Spille
-00002ed0: 6420 746f 2064 6973 6b20 2020 2020 2020  d to disk       
-00002ee0: 3a20 7b66 6f72 6d61 745f 6279 7465 7328  : {format_bytes(
-00002ef0: 7365 6c66 2e73 7069 6c6c 6564 297d 5c6e  self.spilled)}\n
-00002f00: 220a 2020 2020 2020 2020 290a 0a20 2020  ".        )..   
-00002f10: 2064 6566 205f 746f 5f64 6963 7428 7365   def _to_dict(se
-00002f20: 6c66 2c20 2a2c 2065 7863 6c75 6465 3a20  lf, *, exclude: 
-00002f30: 436f 6e74 6169 6e65 725b 7374 725d 203d  Container[str] =
-00002f40: 2028 2929 202d 3e20 6469 6374 3a0a 2020   ()) -> dict:.  
-00002f50: 2020 2020 2020 2222 2244 6963 7469 6f6e        """Diction
-00002f60: 6172 7920 7265 7072 6573 656e 7461 7469  ary representati
-00002f70: 6f6e 2066 6f72 2064 6562 7567 6769 6e67  on for debugging
-00002f80: 2070 7572 706f 7365 732e 0a0a 2020 2020   purposes...    
-00002f90: 2020 2020 5365 6520 616c 736f 0a20 2020      See also.   
-00002fa0: 2020 2020 202d 2d2d 2d2d 2d2d 2d0a 2020       --------.  
-00002fb0: 2020 2020 2020 436c 6965 6e74 2e64 756d        Client.dum
-00002fc0: 705f 636c 7573 7465 725f 7374 6174 650a  p_cluster_state.
-00002fd0: 2020 2020 2020 2020 6469 7374 7269 6275          distribu
-00002fe0: 7465 642e 7574 696c 732e 7265 6375 7273  ted.utils.recurs
-00002ff0: 6976 655f 746f 5f64 6963 740a 2020 2020  ive_to_dict.    
-00003000: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00003010: 7265 7475 726e 207b 0a20 2020 2020 2020  return {.       
-00003020: 2020 2020 206b 3a20 6765 7461 7474 7228       k: getattr(
-00003030: 7365 6c66 2c20 6b29 0a20 2020 2020 2020  self, k).       
-00003040: 2020 2020 2066 6f72 206b 2069 6e20 6469       for k in di
-00003050: 7228 7365 6c66 290a 2020 2020 2020 2020  r(self).        
-00003060: 2020 2020 6966 206e 6f74 206b 2e73 7461      if not k.sta
-00003070: 7274 7377 6974 6828 225f 2229 0a20 2020  rtswith("_").   
-00003080: 2020 2020 2020 2020 2061 6e64 206b 206e           and k n
-00003090: 6f74 2069 6e20 7b22 7375 6d22 2c20 226d  ot in {"sum", "m
-000030a0: 616e 6167 6564 5f69 6e5f 6d65 6d6f 7279  anaged_in_memory
-000030b0: 222c 2022 6d61 6e61 6765 645f 7370 696c  ", "managed_spil
-000030c0: 6c65 6422 7d0a 2020 2020 2020 2020 7d0a  led"}.        }.
-000030d0: 0a0a 636c 6173 7320 576f 726b 6572 5374  ..class WorkerSt
-000030e0: 6174 653a 0a20 2020 2022 2222 4120 7369  ate:.    """A si
-000030f0: 6d70 6c65 206f 626a 6563 7420 686f 6c64  mple object hold
-00003100: 696e 6720 696e 666f 726d 6174 696f 6e20  ing information 
-00003110: 6162 6f75 7420 6120 776f 726b 6572 2e0a  about a worker..
-00003120: 0a20 2020 204e 6f74 2074 6f20 6265 2063  .    Not to be c
-00003130: 6f6e 6675 7365 6420 7769 7468 203a 636c  onfused with :cl
-00003140: 6173 733a 6064 6973 7472 6962 7574 6564  ass:`distributed
-00003150: 2e77 6f72 6b65 725f 7374 6174 655f 6d61  .worker_state_ma
-00003160: 6368 696e 652e 576f 726b 6572 5374 6174  chine.WorkerStat
-00003170: 6560 2e0a 2020 2020 2222 220a 0a20 2020  e`..    """..   
-00003180: 2023 3a20 5468 6973 2077 6f72 6b65 7227   #: This worker'
-00003190: 7320 756e 6971 7565 206b 6579 2e20 5468  s unique key. Th
-000031a0: 6973 2063 616e 2062 6520 6974 7320 636f  is can be its co
-000031b0: 6e6e 6563 7465 6420 6164 6472 6573 730a  nnected address.
-000031c0: 2020 2020 233a 2028 7375 6368 2061 7320      #: (such as 
-000031d0: 6060 2274 6370 3a2f 2f31 3237 2e30 2e30  ``"tcp://127.0.0
-000031e0: 2e31 3a38 3839 3122 6060 2920 6f72 2061  .1:8891"``) or a
-000031f0: 6e20 616c 6961 7320 2873 7563 6820 6173  n alias (such as
-00003200: 2060 6022 616c 6963 6522 6060 292e 0a20   ``"alice"``).. 
-00003210: 2020 2061 6464 7265 7373 3a20 7374 720a     address: str.
-00003220: 0a20 2020 2070 6964 3a20 696e 740a 2020  .    pid: int.  
-00003230: 2020 6e61 6d65 3a20 4861 7368 6162 6c65    name: Hashable
-00003240: 0a0a 2020 2020 233a 2054 6865 206e 756d  ..    #: The num
-00003250: 6265 7220 6f66 2043 5055 2074 6872 6561  ber of CPU threa
-00003260: 6473 206d 6164 6520 6176 6169 6c61 626c  ds made availabl
-00003270: 6520 6f6e 2074 6869 7320 776f 726b 6572  e on this worker
-00003280: 0a20 2020 206e 7468 7265 6164 733a 2069  .    nthreads: i
-00003290: 6e74 0a0a 2020 2020 233a 204d 656d 6f72  nt..    #: Memor
-000032a0: 7920 6176 6169 6c61 626c 6520 746f 2074  y available to t
-000032b0: 6865 2077 6f72 6b65 722c 2069 6e20 6279  he worker, in by
-000032c0: 7465 730a 2020 2020 6d65 6d6f 7279 5f6c  tes.    memory_l
-000032d0: 696d 6974 3a20 696e 740a 0a20 2020 206c  imit: int..    l
-000032e0: 6f63 616c 5f64 6972 6563 746f 7279 3a20  ocal_directory: 
-000032f0: 7374 720a 2020 2020 7365 7276 6963 6573  str.    services
-00003300: 3a20 6469 6374 5b73 7472 2c20 696e 745d  : dict[str, int]
-00003310: 0a0a 2020 2020 233a 204f 7574 7075 7420  ..    #: Output 
-00003320: 6f66 203a 6d65 7468 3a60 6469 7374 7269  of :meth:`distri
-00003330: 6275 7465 642e 7665 7273 696f 6e73 2e67  buted.versions.g
-00003340: 6574 5f76 6572 7369 6f6e 7360 206f 6e20  et_versions` on 
-00003350: 7468 6520 776f 726b 6572 0a20 2020 2076  the worker.    v
-00003360: 6572 7369 6f6e 733a 2064 6963 745b 7374  ersions: dict[st
-00003370: 722c 2041 6e79 5d0a 0a20 2020 2023 3a20  r, Any]..    #: 
-00003380: 4164 6472 6573 7320 6f66 2074 6865 2061  Address of the a
-00003390: 7373 6f63 6961 7465 6420 3a63 6c61 7373  ssociated :class
-000033a0: 3a60 7e64 6973 7472 6962 7574 6564 2e6e  :`~distributed.n
-000033b0: 616e 6e79 2e4e 616e 6e79 602c 2069 6620  anny.Nanny`, if 
-000033c0: 7072 6573 656e 740a 2020 2020 6e61 6e6e  present.    nann
-000033d0: 793a 2073 7472 207c 204e 6f6e 650a 0a20  y: str | None.. 
-000033e0: 2020 2023 3a20 5265 6164 2d6f 6e6c 7920     #: Read-only 
-000033f0: 776f 726b 6572 2073 7461 7475 732c 2073  worker status, s
-00003400: 796e 6365 6420 6f6e 6520 7761 7920 6672  ynced one way fr
-00003410: 6f6d 2074 6865 2072 656d 6f74 6520 576f  om the remote Wo
-00003420: 726b 6572 206f 626a 6563 740a 2020 2020  rker object.    
-00003430: 7374 6174 7573 3a20 5374 6174 7573 0a0a  status: Status..
-00003440: 2020 2020 233a 2043 6163 6865 6420 6861      #: Cached ha
-00003450: 7368 206f 6620 3a61 7474 723a 607e 576f  sh of :attr:`~Wo
-00003460: 726b 6572 5374 6174 652e 7365 7276 6572  rkerState.server
-00003470: 5f69 6460 0a20 2020 205f 6861 7368 3a20  _id`.    _hash: 
-00003480: 696e 740a 0a20 2020 2023 3a20 5468 6520  int..    #: The 
-00003490: 746f 7461 6c20 6d65 6d6f 7279 2073 697a  total memory siz
-000034a0: 652c 2069 6e20 6279 7465 732c 2075 7365  e, in bytes, use
-000034b0: 6420 6279 2074 6865 2074 6173 6b73 2074  d by the tasks t
-000034c0: 6869 7320 776f 726b 6572 2068 6f6c 6473  his worker holds
-000034d0: 2069 6e20 6d65 6d6f 7279 0a20 2020 2023   in memory.    #
-000034e0: 3a20 2869 2e65 2e20 7468 6520 7461 736b  : (i.e. the task
-000034f0: 7320 696e 2074 6869 7320 776f 726b 6572  s in this worker
-00003500: 2773 203a 6174 7472 3a60 7e57 6f72 6b65  's :attr:`~Worke
-00003510: 7253 7461 7465 2e68 6173 5f77 6861 7460  rState.has_what`
-00003520: 292e 0a20 2020 206e 6279 7465 733a 2069  )..    nbytes: i
-00003530: 6e74 0a0a 2020 2020 233a 2057 6f72 6b65  nt..    #: Worke
-00003540: 7220 6d65 6d6f 7279 2075 6e6b 6e6f 776e  r memory unknown
-00003550: 2074 6f20 7468 6520 776f 726b 6572 2c20   to the worker, 
-00003560: 696e 2062 7974 6573 2c20 7768 6963 6820  in bytes, which 
-00003570: 6861 7320 6265 656e 2074 6865 7265 2066  has been there f
-00003580: 6f72 206d 6f72 6520 7468 616e 0a20 2020  or more than.   
-00003590: 2023 3a20 3330 2073 6563 6f6e 6473 2e20   #: 30 seconds. 
-000035a0: 5365 6520 3a63 6c61 7373 3a60 4d65 6d6f  See :class:`Memo
-000035b0: 7279 5374 6174 6560 2e0a 2020 2020 5f6d  ryState`..    _m
-000035c0: 656d 6f72 795f 756e 6d61 6e61 6765 645f  emory_unmanaged_
-000035d0: 6f6c 643a 2069 6e74 0a0a 2020 2020 233a  old: int..    #:
-000035e0: 2048 6973 746f 7279 206f 6620 7468 6520   History of the 
-000035f0: 6c61 7374 2033 3020 7365 636f 6e64 7327  last 30 seconds'
-00003600: 2077 6f72 7468 206f 6620 756e 6d61 6e61   worth of unmana
-00003610: 6765 6420 6d65 6d6f 7279 2e20 5573 6564  ged memory. Used
-00003620: 2074 6f20 6469 6666 6572 656e 7469 6174   to differentiat
-00003630: 650a 2020 2020 233a 2062 6574 7765 656e  e.    #: between
-00003640: 2022 6f6c 6422 2061 6e64 2022 6e65 7722   "old" and "new"
-00003650: 2075 6e6d 616e 6167 6564 206d 656d 6f72   unmanaged memor
-00003660: 792e 0a20 2020 2023 3a20 466f 726d 6174  y..    #: Format
-00003670: 3a20 6060 5b28 7469 6d65 7374 616d 702c  : ``[(timestamp,
-00003680: 2062 7974 6573 292c 2028 7469 6d65 7374   bytes), (timest
-00003690: 616d 702c 2062 7974 6573 292c 202e 2e2e  amp, bytes), ...
-000036a0: 5d60 600a 2020 2020 5f6d 656d 6f72 795f  ]``.    _memory_
-000036b0: 756e 6d61 6e61 6765 645f 6869 7374 6f72  unmanaged_histor
-000036c0: 793a 2064 6571 7565 5b74 7570 6c65 5b66  y: deque[tuple[f
-000036d0: 6c6f 6174 2c20 696e 745d 5d0a 0a20 2020  loat, int]]..   
-000036e0: 206d 6574 7269 6373 3a20 6469 6374 5b73   metrics: dict[s
-000036f0: 7472 2c20 416e 795d 0a0a 2020 2020 233a  tr, Any]..    #:
-00003700: 2054 6865 206c 6173 7420 7469 6d65 2077   The last time w
-00003710: 6520 7265 6365 6976 6564 2061 2068 6561  e received a hea
-00003720: 7274 6265 6174 2066 726f 6d20 7468 6973  rtbeat from this
-00003730: 2077 6f72 6b65 722c 2069 6e20 6c6f 6361   worker, in loca
-00003740: 6c20 7363 6865 6475 6c65 7220 7469 6d65  l scheduler time
-00003750: 2e0a 2020 2020 6c61 7374 5f73 6565 6e3a  ..    last_seen:
-00003760: 2066 6c6f 6174 0a0a 2020 2020 7469 6d65   float..    time
-00003770: 5f64 656c 6179 3a20 666c 6f61 740a 2020  _delay: float.  
-00003780: 2020 6261 6e64 7769 6474 683a 2066 6c6f    bandwidth: flo
-00003790: 6174 0a0a 2020 2020 233a 2041 2073 6574  at..    #: A set
-000037a0: 206f 6620 616c 6c20 5461 736b 5374 6174   of all TaskStat
-000037b0: 6573 206f 6e20 7468 6973 2077 6f72 6b65  es on this worke
-000037c0: 7220 7468 6174 2061 7265 2061 6374 6f72  r that are actor
-000037d0: 732e 2054 6869 7320 6f6e 6c79 2069 6e63  s. This only inc
-000037e0: 6c75 6465 7320 7468 6f73 650a 2020 2020  ludes those.    
-000037f0: 233a 2061 6374 6f72 7320 7768 6f73 6520  #: actors whose 
-00003800: 7374 6174 6520 6163 7475 616c 6c79 206c  state actually l
-00003810: 6976 6573 206f 6e20 7468 6973 2077 6f72  ives on this wor
-00003820: 6b65 722c 206e 6f74 2061 6374 6f72 7320  ker, not actors 
-00003830: 746f 2077 6869 6368 2074 6869 7320 776f  to which this wo
-00003840: 726b 6572 0a20 2020 2023 3a20 6861 7320  rker.    #: has 
-00003850: 6120 7265 6665 7265 6e63 652e 0a20 2020  a reference..   
-00003860: 2061 6374 6f72 733a 2073 6574 5b54 6173   actors: set[Tas
-00003870: 6b53 7461 7465 5d0a 0a20 2020 2023 3a20  kState]..    #: 
-00003880: 556e 6465 726c 7969 6e67 2064 6174 6120  Underlying data 
-00003890: 6f66 203a 6d65 7468 3a60 576f 726b 6572  of :meth:`Worker
-000038a0: 5374 6174 652e 6861 735f 7768 6174 600a  State.has_what`.
-000038b0: 2020 2020 5f68 6173 5f77 6861 743a 2064      _has_what: d
-000038c0: 6963 745b 5461 736b 5374 6174 652c 204e  ict[TaskState, N
-000038d0: 6f6e 655d 0a0a 2020 2020 233a 2041 2073  one]..    #: A s
-000038e0: 6574 206f 6620 7461 736b 7320 7468 6174  et of tasks that
-000038f0: 2068 6176 6520 6265 656e 2073 7562 6d69   have been submi
-00003900: 7474 6564 2074 6f20 7468 6973 2077 6f72  tted to this wor
-00003910: 6b65 722e 204d 756c 7469 706c 6520 7461  ker. Multiple ta
-00003920: 736b 7320 6d61 7920 6265 0a20 2020 2023  sks may be.    #
-00003930: 2073 7562 6d69 7474 6564 2074 6f20 6120   submitted to a 
-00003940: 776f 726b 6572 2069 6e20 6164 7661 6e63  worker in advanc
-00003950: 6520 616e 6420 7468 6520 776f 726b 6572  e and the worker
-00003960: 2077 696c 6c20 7275 6e20 7468 656d 2065   will run them e
-00003970: 7665 6e74 7561 6c6c 792c 0a20 2020 2023  ventually,.    #
-00003980: 2064 6570 656e 6469 6e67 206f 6e20 6974   depending on it
-00003990: 7320 6578 6563 7574 696f 6e20 7265 736f  s execution reso
-000039a0: 7572 6365 7320 2862 7574 2073 6565 203a  urces (but see :
-000039b0: 646f 633a 6077 6f72 6b2d 7374 6561 6c69  doc:`work-steali
-000039c0: 6e67 6029 2e0a 2020 2020 233a 0a20 2020  ng`)..    #:.   
-000039d0: 2023 3a20 416c 6c20 7468 6520 7461 736b   #: All the task
-000039e0: 7320 6865 7265 2061 7265 2069 6e20 7468  s here are in th
-000039f0: 6520 2270 726f 6365 7373 696e 6722 2073  e "processing" s
-00003a00: 7461 7465 2e0a 2020 2020 233a 2054 6869  tate..    #: Thi
-00003a10: 7320 6174 7472 6962 7574 6520 6973 206b  s attribute is k
-00003a20: 6570 7420 696e 2073 796e 6320 7769 7468  ept in sync with
-00003a30: 203a 6174 7472 3a60 5461 736b 5374 6174   :attr:`TaskStat
-00003a40: 652e 7072 6f63 6573 7369 6e67 5f6f 6e60  e.processing_on`
-00003a50: 2e0a 2020 2020 7072 6f63 6573 7369 6e67  ..    processing
-00003a60: 3a20 7365 745b 5461 736b 5374 6174 655d  : set[TaskState]
-00003a70: 0a0a 2020 2020 233a 2052 756e 6e69 6e67  ..    #: Running
-00003a80: 2074 6173 6b73 2074 6861 7420 696e 766f   tasks that invo
-00003a90: 6b65 6420 3a66 756e 633a 6064 6973 7472  ked :func:`distr
-00003aa0: 6962 7574 6564 2e73 6563 6564 6560 0a20  ibuted.secede`. 
-00003ab0: 2020 206c 6f6e 675f 7275 6e6e 696e 673a     long_running:
-00003ac0: 2073 6574 5b54 6173 6b53 7461 7465 5d0a   set[TaskState].
-00003ad0: 0a20 2020 2023 3a20 4120 6469 6374 696f  .    #: A dictio
-00003ae0: 6e61 7279 206f 6620 7461 736b 7320 7468  nary of tasks th
-00003af0: 6174 2061 7265 2063 7572 7265 6e74 6c79  at are currently
-00003b00: 2062 6569 6e67 2072 756e 206f 6e20 7468   being run on th
-00003b10: 6973 2077 6f72 6b65 722e 0a20 2020 2023  is worker..    #
-00003b20: 3a20 4561 6368 2074 6173 6b20 7374 6174  : Each task stat
-00003b30: 6520 6973 2061 7373 6f63 6961 7465 6420  e is associated 
-00003b40: 7769 7468 2074 6865 2064 7572 6174 696f  with the duratio
-00003b50: 6e20 696e 2073 6563 6f6e 6473 2077 6869  n in seconds whi
-00003b60: 6368 2074 6865 2074 6173 6b20 6861 730a  ch the task has.
-00003b70: 2020 2020 233a 2062 6565 6e20 7275 6e6e      #: been runn
-00003b80: 696e 672e 0a20 2020 2065 7865 6375 7469  ing..    executi
-00003b90: 6e67 3a20 6469 6374 5b54 6173 6b53 7461  ng: dict[TaskSta
-00003ba0: 7465 2c20 666c 6f61 745d 0a0a 2020 2020  te, float]..    
-00003bb0: 233a 2054 6865 2061 7661 696c 6162 6c65  #: The available
-00003bc0: 2072 6573 6f75 7263 6573 206f 6e20 7468   resources on th
-00003bd0: 6973 2077 6f72 6b65 722c 2065 2e67 2e20  is worker, e.g. 
-00003be0: 6060 7b22 4750 5522 3a20 327d 6060 2e0a  ``{"GPU": 2}``..
-00003bf0: 2020 2020 233a 2054 6865 7365 2061 7265      #: These are
-00003c00: 2061 6273 7472 6163 7420 7175 616e 7469   abstract quanti
-00003c10: 7469 6573 2074 6861 7420 636f 6e73 7472  ties that constr
-00003c20: 6169 6e20 6365 7274 6169 6e20 7461 736b  ain certain task
-00003c30: 7320 6672 6f6d 2072 756e 6e69 6e67 2061  s from running a
-00003c40: 7420 7468 650a 2020 2020 233a 2073 616d  t the.    #: sam
-00003c50: 6520 7469 6d65 206f 6e20 7468 6973 2077  e time on this w
-00003c60: 6f72 6b65 722e 0a20 2020 2072 6573 6f75  orker..    resou
-00003c70: 7263 6573 3a20 6469 6374 5b73 7472 2c20  rces: dict[str, 
-00003c80: 666c 6f61 745d 0a0a 2020 2020 233a 2054  float]..    #: T
-00003c90: 6865 2073 756d 206f 6620 6561 6368 2072  he sum of each r
-00003ca0: 6573 6f75 7263 6520 7573 6564 2062 7920  esource used by 
-00003cb0: 616c 6c20 7461 736b 7320 616c 6c6f 6361  all tasks alloca
-00003cc0: 7465 6420 746f 2074 6869 7320 776f 726b  ted to this work
-00003cd0: 6572 2e0a 2020 2020 233a 2054 6865 206e  er..    #: The n
-00003ce0: 756d 6265 7273 2069 6e20 7468 6973 2064  umbers in this d
-00003cf0: 6963 7469 6f6e 6172 7920 6361 6e20 6f6e  ictionary can on
-00003d00: 6c79 2062 6520 6c65 7373 206f 7220 6571  ly be less or eq
-00003d10: 7561 6c20 7468 616e 2074 686f 7365 2069  ual than those i
-00003d20: 6e20 7468 6973 0a20 2020 2023 3a20 776f  n this.    #: wo
-00003d30: 726b 6572 2773 203a 6174 7472 3a60 7e57  rker's :attr:`~W
-00003d40: 6f72 6b65 7253 7461 7465 2e72 6573 6f75  orkerState.resou
-00003d50: 7263 6573 602e 0a20 2020 2075 7365 645f  rces`..    used_
-00003d60: 7265 736f 7572 6365 733a 2064 6963 745b  resources: dict[
-00003d70: 7374 722c 2066 6c6f 6174 5d0a 0a20 2020  str, float]..   
-00003d80: 2023 3a20 4172 6269 7472 6172 7920 6164   #: Arbitrary ad
-00003d90: 6469 7469 6f6e 616c 206d 6574 6164 6174  ditional metadat
-00003da0: 6120 746f 2062 6520 6164 6465 6420 746f  a to be added to
-00003db0: 203a 6d65 7468 3a60 7e57 6f72 6b65 7253   :meth:`~WorkerS
-00003dc0: 7461 7465 2e69 6465 6e74 6974 7960 0a20  tate.identity`. 
-00003dd0: 2020 2065 7874 7261 3a20 6469 6374 5b73     extra: dict[s
-00003de0: 7472 2c20 416e 795d 0a0a 2020 2020 2320  tr, Any]..    # 
-00003df0: 5468 6520 756e 6971 7565 2073 6572 7665  The unique serve
-00003e00: 7220 4944 2074 6869 7320 576f 726b 6572  r ID this Worker
-00003e10: 5374 6174 6520 6973 2072 6566 6572 656e  State is referen
-00003e20: 6369 6e67 0a20 2020 2073 6572 7665 725f  cing.    server_
-00003e30: 6964 3a20 7374 720a 0a20 2020 2023 2052  id: str..    # R
-00003e40: 6566 6572 656e 6365 2074 6f20 7363 6865  eference to sche
-00003e50: 6475 6c65 7220 7461 736b 5f67 726f 7570  duler task_group
-00003e60: 730a 2020 2020 7363 6865 6475 6c65 725f  s.    scheduler_
-00003e70: 7265 663a 2077 6561 6b72 6566 2e72 6566  ref: weakref.ref
-00003e80: 5b53 6368 6564 756c 6572 5374 6174 655d  [SchedulerState]
-00003e90: 207c 204e 6f6e 650a 2020 2020 7461 736b   | None.    task
-00003ea0: 5f70 7265 6669 785f 636f 756e 743a 2064  _prefix_count: d
-00003eb0: 6566 6175 6c74 6469 6374 5b73 7472 2c20  efaultdict[str, 
-00003ec0: 696e 745d 0a20 2020 205f 6e65 7477 6f72  int].    _networ
-00003ed0: 6b5f 6f63 633a 2066 6c6f 6174 0a20 2020  k_occ: float.   
-00003ee0: 205f 6f63 6375 7061 6e63 795f 6361 6368   _occupancy_cach
-00003ef0: 653a 2066 6c6f 6174 207c 204e 6f6e 650a  e: float | None.
-00003f00: 0a20 2020 2023 3a20 4b65 7973 2074 6861  .    #: Keys tha
-00003f10: 7420 6d61 7920 6e65 6564 2074 6f20 6265  t may need to be
-00003f20: 2066 6574 6368 6564 2074 6f20 7468 6973   fetched to this
-00003f30: 2077 6f72 6b65 722c 2061 6e64 2074 6865   worker, and the
-00003f40: 206e 756d 6265 7220 6f66 2074 6173 6b73   number of tasks
-00003f50: 2074 6861 7420 6e65 6564 2074 6865 6d2e   that need them.
-00003f60: 0a20 2020 2023 3a20 416c 6c20 7461 736b  .    #: All task
-00003f70: 7320 6172 6520 6375 7272 656e 746c 7920  s are currently 
-00003f80: 696e 2060 6d65 6d6f 7279 6020 6f6e 2061  in `memory` on a
-00003f90: 2077 6f72 6b65 7220 6f74 6865 7220 7468   worker other th
-00003fa0: 616e 2074 6869 7320 6f6e 652e 0a20 2020  an this one..   
-00003fb0: 2023 3a20 4d75 6368 206c 696b 6520 6070   #: Much like `p
-00003fc0: 726f 6365 7373 696e 6760 2c20 7468 6973  rocessing`, this
-00003fd0: 2064 6f65 7320 6e6f 7420 6578 6163 746c   does not exactl
-00003fe0: 7920 7265 666c 6563 7420 776f 726b 6572  y reflect worker
-00003ff0: 2073 7461 7465 3a0a 2020 2020 233a 206b   state:.    #: k
-00004000: 6579 7320 6865 7265 206d 6179 2062 6520  eys here may be 
-00004010: 7175 6575 6564 2074 6f20 6665 7463 682c  queued to fetch,
-00004020: 2069 6e20 666c 6967 6874 2c20 6f72 2061   in flight, or a
-00004030: 6c72 6561 6479 2069 6e20 6d65 6d6f 7279  lready in memory
-00004040: 0a20 2020 2023 3a20 6f6e 2074 6865 2077  .    #: on the w
-00004050: 6f72 6b65 722e 0a20 2020 206e 6565 6473  orker..    needs
-00004060: 5f77 6861 743a 2064 6963 745b 5461 736b  _what: dict[Task
-00004070: 5374 6174 652c 2069 6e74 5d0a 0a20 2020  State, int]..   
-00004080: 205f 5f73 6c6f 7473 5f5f 203d 2074 7570   __slots__ = tup
-00004090: 6c65 285f 5f61 6e6e 6f74 6174 696f 6e73  le(__annotations
-000040a0: 5f5f 290a 0a20 2020 2064 6566 205f 5f69  __)..    def __i
-000040b0: 6e69 745f 5f28 0a20 2020 2020 2020 2073  nit__(.        s
-000040c0: 656c 662c 0a20 2020 2020 2020 202a 2c0a  elf,.        *,.
-000040d0: 2020 2020 2020 2020 6164 6472 6573 733a          address:
-000040e0: 2073 7472 2c0a 2020 2020 2020 2020 7374   str,.        st
-000040f0: 6174 7573 3a20 5374 6174 7573 2c0a 2020  atus: Status,.  
-00004100: 2020 2020 2020 7069 643a 2069 6e74 2c0a        pid: int,.
-00004110: 2020 2020 2020 2020 6e61 6d65 3a20 6f62          name: ob
-00004120: 6a65 6374 2c0a 2020 2020 2020 2020 6e74  ject,.        nt
-00004130: 6872 6561 6473 3a20 696e 7420 3d20 302c  hreads: int = 0,
-00004140: 0a20 2020 2020 2020 206d 656d 6f72 795f  .        memory_
-00004150: 6c69 6d69 743a 2069 6e74 2c0a 2020 2020  limit: int,.    
-00004160: 2020 2020 6c6f 6361 6c5f 6469 7265 6374      local_direct
-00004170: 6f72 793a 2073 7472 2c0a 2020 2020 2020  ory: str,.      
-00004180: 2020 6e61 6e6e 793a 2073 7472 207c 204e    nanny: str | N
-00004190: 6f6e 652c 0a20 2020 2020 2020 2073 6572  one,.        ser
-000041a0: 7665 725f 6964 3a20 7374 722c 0a20 2020  ver_id: str,.   
-000041b0: 2020 2020 2073 6572 7669 6365 733a 2064       services: d
-000041c0: 6963 745b 7374 722c 2069 6e74 5d20 7c20  ict[str, int] | 
-000041d0: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
-000041e0: 2020 2020 2076 6572 7369 6f6e 733a 2064       versions: d
-000041f0: 6963 745b 7374 722c 2041 6e79 5d20 7c20  ict[str, Any] | 
-00004200: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
-00004210: 2020 2020 2065 7874 7261 3a20 6469 6374       extra: dict
-00004220: 5b73 7472 2c20 416e 795d 207c 204e 6f6e  [str, Any] | Non
-00004230: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
-00004240: 2020 7363 6865 6475 6c65 723a 2053 6368    scheduler: Sch
-00004250: 6564 756c 6572 5374 6174 6520 7c20 4e6f  edulerState | No
-00004260: 6e65 203d 204e 6f6e 652c 0a20 2020 2029  ne = None,.    )
-00004270: 3a0a 2020 2020 2020 2020 7365 6c66 2e73  :.        self.s
-00004280: 6572 7665 725f 6964 203d 2073 6572 7665  erver_id = serve
-00004290: 725f 6964 0a20 2020 2020 2020 2073 656c  r_id.        sel
-000042a0: 662e 6164 6472 6573 7320 3d20 6164 6472  f.address = addr
-000042b0: 6573 730a 2020 2020 2020 2020 7365 6c66  ess.        self
-000042c0: 2e70 6964 203d 2070 6964 0a20 2020 2020  .pid = pid.     
-000042d0: 2020 2073 656c 662e 6e61 6d65 203d 206e     self.name = n
-000042e0: 616d 650a 2020 2020 2020 2020 7365 6c66  ame.        self
-000042f0: 2e6e 7468 7265 6164 7320 3d20 6e74 6872  .nthreads = nthr
-00004300: 6561 6473 0a20 2020 2020 2020 2073 656c  eads.        sel
-00004310: 662e 6d65 6d6f 7279 5f6c 696d 6974 203d  f.memory_limit =
-00004320: 206d 656d 6f72 795f 6c69 6d69 740a 2020   memory_limit.  
-00004330: 2020 2020 2020 7365 6c66 2e6c 6f63 616c        self.local
-00004340: 5f64 6972 6563 746f 7279 203d 206c 6f63  _directory = loc
-00004350: 616c 5f64 6972 6563 746f 7279 0a20 2020  al_directory.   
-00004360: 2020 2020 2073 656c 662e 7365 7276 6963       self.servic
-00004370: 6573 203d 2073 6572 7669 6365 7320 6f72  es = services or
-00004380: 207b 7d0a 2020 2020 2020 2020 7365 6c66   {}.        self
-00004390: 2e76 6572 7369 6f6e 7320 3d20 7665 7273  .versions = vers
-000043a0: 696f 6e73 206f 7220 7b7d 0a20 2020 2020  ions or {}.     
-000043b0: 2020 2073 656c 662e 6e61 6e6e 7920 3d20     self.nanny = 
-000043c0: 6e61 6e6e 790a 2020 2020 2020 2020 7365  nanny.        se
-000043d0: 6c66 2e73 7461 7475 7320 3d20 7374 6174  lf.status = stat
-000043e0: 7573 0a20 2020 2020 2020 2073 656c 662e  us.        self.
-000043f0: 5f68 6173 6820 3d20 6861 7368 2873 656c  _hash = hash(sel
-00004400: 662e 7365 7276 6572 5f69 6429 0a20 2020  f.server_id).   
-00004410: 2020 2020 2073 656c 662e 6e62 7974 6573       self.nbytes
-00004420: 203d 2030 0a20 2020 2020 2020 2073 656c   = 0.        sel
-00004430: 662e 5f6d 656d 6f72 795f 756e 6d61 6e61  f._memory_unmana
-00004440: 6765 645f 6f6c 6420 3d20 300a 2020 2020  ged_old = 0.    
-00004450: 2020 2020 7365 6c66 2e5f 6d65 6d6f 7279      self._memory
-00004460: 5f75 6e6d 616e 6167 6564 5f68 6973 746f  _unmanaged_histo
-00004470: 7279 203d 2064 6571 7565 2829 0a20 2020  ry = deque().   
-00004480: 2020 2020 2073 656c 662e 6d65 7472 6963       self.metric
-00004490: 7320 3d20 7b7d 0a20 2020 2020 2020 2073  s = {}.        s
-000044a0: 656c 662e 6c61 7374 5f73 6565 6e20 3d20  elf.last_seen = 
-000044b0: 7469 6d65 2829 0a20 2020 2020 2020 2073  time().        s
-000044c0: 656c 662e 7469 6d65 5f64 656c 6179 203d  elf.time_delay =
-000044d0: 2030 0a20 2020 2020 2020 2073 656c 662e   0.        self.
-000044e0: 6261 6e64 7769 6474 6820 3d20 7061 7273  bandwidth = pars
-000044f0: 655f 6279 7465 7328 6461 736b 2e63 6f6e  e_bytes(dask.con
-00004500: 6669 672e 6765 7428 2264 6973 7472 6962  fig.get("distrib
-00004510: 7574 6564 2e73 6368 6564 756c 6572 2e62  uted.scheduler.b
-00004520: 616e 6477 6964 7468 2229 290a 2020 2020  andwidth")).    
-00004530: 2020 2020 7365 6c66 2e61 6374 6f72 7320      self.actors 
-00004540: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
-00004550: 7365 6c66 2e5f 6861 735f 7768 6174 203d  self._has_what =
-00004560: 207b 7d0a 2020 2020 2020 2020 7365 6c66   {}.        self
-00004570: 2e70 726f 6365 7373 696e 6720 3d20 7365  .processing = se
-00004580: 7428 290a 2020 2020 2020 2020 7365 6c66  t().        self
-00004590: 2e6c 6f6e 675f 7275 6e6e 696e 6720 3d20  .long_running = 
-000045a0: 7365 7428 290a 2020 2020 2020 2020 7365  set().        se
-000045b0: 6c66 2e65 7865 6375 7469 6e67 203d 207b  lf.executing = {
-000045c0: 7d0a 2020 2020 2020 2020 7365 6c66 2e72  }.        self.r
-000045d0: 6573 6f75 7263 6573 203d 207b 7d0a 2020  esources = {}.  
-000045e0: 2020 2020 2020 7365 6c66 2e75 7365 645f        self.used_
-000045f0: 7265 736f 7572 6365 7320 3d20 7b7d 0a20  resources = {}. 
-00004600: 2020 2020 2020 2073 656c 662e 6578 7472         self.extr
-00004610: 6120 3d20 6578 7472 6120 6f72 207b 7d0a  a = extra or {}.
-00004620: 2020 2020 2020 2020 7365 6c66 2e73 6368          self.sch
-00004630: 6564 756c 6572 5f72 6566 203d 2077 6561  eduler_ref = wea
-00004640: 6b72 6566 2e72 6566 2873 6368 6564 756c  kref.ref(schedul
-00004650: 6572 2920 6966 2073 6368 6564 756c 6572  er) if scheduler
-00004660: 2065 6c73 6520 4e6f 6e65 0a20 2020 2020   else None.     
-00004670: 2020 2073 656c 662e 7461 736b 5f70 7265     self.task_pre
-00004680: 6669 785f 636f 756e 7420 3d20 6465 6661  fix_count = defa
-00004690: 756c 7464 6963 7428 696e 7429 0a20 2020  ultdict(int).   
-000046a0: 2020 2020 2073 656c 662e 6e65 6564 735f       self.needs_
-000046b0: 7768 6174 203d 207b 7d0a 2020 2020 2020  what = {}.      
-000046c0: 2020 7365 6c66 2e5f 6e65 7477 6f72 6b5f    self._network_
-000046d0: 6f63 6320 3d20 300a 2020 2020 2020 2020  occ = 0.        
-000046e0: 7365 6c66 2e5f 6f63 6375 7061 6e63 795f  self._occupancy_
-000046f0: 6361 6368 6520 3d20 4e6f 6e65 0a0a 2020  cache = None..  
-00004700: 2020 6465 6620 5f5f 6861 7368 5f5f 2873    def __hash__(s
-00004710: 656c 6629 202d 3e20 696e 743a 0a20 2020  elf) -> int:.   
-00004720: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-00004730: 2e5f 6861 7368 0a0a 2020 2020 6465 6620  ._hash..    def 
-00004740: 5f5f 6571 5f5f 2873 656c 662c 206f 7468  __eq__(self, oth
-00004750: 6572 3a20 6f62 6a65 6374 2920 2d3e 2062  er: object) -> b
-00004760: 6f6f 6c3a 0a20 2020 2020 2020 2072 6574  ool:.        ret
-00004770: 7572 6e20 6973 696e 7374 616e 6365 286f  urn isinstance(o
-00004780: 7468 6572 2c20 576f 726b 6572 5374 6174  ther, WorkerStat
-00004790: 6529 2061 6e64 206f 7468 6572 2e73 6572  e) and other.ser
-000047a0: 7665 725f 6964 203d 3d20 7365 6c66 2e73  ver_id == self.s
-000047b0: 6572 7665 725f 6964 0a0a 2020 2020 4070  erver_id..    @p
-000047c0: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
-000047d0: 6861 735f 7768 6174 2873 656c 6629 202d  has_what(self) -
-000047e0: 3e20 5365 745b 5461 736b 5374 6174 655d  > Set[TaskState]
-000047f0: 3a0a 2020 2020 2020 2020 2222 2241 6e20  :.        """An 
-00004800: 696e 7365 7274 696f 6e2d 736f 7274 6564  insertion-sorted
-00004810: 2073 6574 2d6c 696b 6520 6f66 2074 6173   set-like of tas
-00004820: 6b73 2077 6869 6368 2063 7572 7265 6e74  ks which current
-00004830: 6c79 2072 6573 6964 6520 6f6e 2074 6869  ly reside on thi
-00004840: 7320 776f 726b 6572 2e0a 2020 2020 2020  s worker..      
-00004850: 2020 416c 6c20 7468 6520 7461 736b 7320    All the tasks 
-00004860: 6865 7265 2061 7265 2069 6e20 7468 6520  here are in the 
-00004870: 226d 656d 6f72 7922 2073 7461 7465 2e0a  "memory" state..
-00004880: 2020 2020 2020 2020 5468 6973 2069 7320          This is 
-00004890: 7468 6520 7265 7665 7273 6520 6d61 7070  the reverse mapp
-000048a0: 696e 6720 6f66 203a 6174 7472 3a60 5461  ing of :attr:`Ta
-000048b0: 736b 5374 6174 652e 7768 6f5f 6861 7360  skState.who_has`
-000048c0: 2e0a 0a20 2020 2020 2020 2054 6869 7320  ...        This 
-000048d0: 6973 2061 2072 6561 642d 6f6e 6c79 2070  is a read-only p
-000048e0: 7562 6c69 6320 6163 6365 7373 6f72 2e20  ublic accessor. 
-000048f0: 5468 6520 6461 7461 2069 7320 696d 706c  The data is impl
-00004900: 656d 656e 7465 6420 6173 2061 2064 6963  emented as a dic
-00004910: 7420 7769 7468 6f75 740a 2020 2020 2020  t without.      
-00004920: 2020 7661 6c75 6573 2c20 6265 6361 7573    values, becaus
-00004930: 6520 7265 6261 6c61 6e63 6528 2920 7265  e rebalance() re
-00004940: 6c69 6573 206f 6e20 6469 6374 7320 6265  lies on dicts be
-00004950: 696e 6720 696e 7365 7274 696f 6e2d 736f  ing insertion-so
-00004960: 7274 6564 2e0a 2020 2020 2020 2020 2222  rted..        ""
-00004970: 220a 2020 2020 2020 2020 7265 7475 726e  ".        return
-00004980: 2073 656c 662e 5f68 6173 5f77 6861 742e   self._has_what.
-00004990: 6b65 7973 2829 0a0a 2020 2020 4070 726f  keys()..    @pro
-000049a0: 7065 7274 790a 2020 2020 6465 6620 686f  perty.    def ho
-000049b0: 7374 2873 656c 6629 202d 3e20 7374 723a  st(self) -> str:
-000049c0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000049d0: 6765 745f 6164 6472 6573 735f 686f 7374  get_address_host
-000049e0: 2873 656c 662e 6164 6472 6573 7329 0a0a  (self.address)..
-000049f0: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
-00004a00: 2020 6465 6620 6d65 6d6f 7279 2873 656c    def memory(sel
-00004a10: 6629 202d 3e20 4d65 6d6f 7279 5374 6174  f) -> MemoryStat
-00004a20: 653a 0a20 2020 2020 2020 2022 2222 506f  e:.        """Po
-00004a30: 6c69 7368 6564 206d 656d 6f72 7920 6d65  lished memory me
-00004a40: 7472 6963 7320 666f 7220 7468 6520 776f  trics for the wo
-00004a50: 726b 6572 2e0a 0a20 2020 2020 2020 202a  rker...        *
-00004a60: 2a44 6573 6967 6e20 6e6f 7465 206f 6e20  *Design note on 
-00004a70: 6d61 6e61 6765 6420 6d65 6d6f 7279 2a2a  managed memory**
-00004a80: 0a0a 2020 2020 2020 2020 5468 6572 6520  ..        There 
-00004a90: 6172 6520 7477 6f20 6d65 6173 7572 6573  are two measures
-00004aa0: 2061 7661 696c 6162 6c65 2066 6f72 206d   available for m
-00004ab0: 616e 6167 6564 206d 656d 6f72 793a 0a0a  anaged memory:..
-00004ac0: 2020 2020 2020 2020 2d20 6060 7365 6c66          - ``self
-00004ad0: 2e6e 6279 7465 7360 600a 2020 2020 2020  .nbytes``.      
-00004ae0: 2020 2d20 6060 7365 6c66 2e6d 6574 7269    - ``self.metri
-00004af0: 6373 5b22 6d61 6e61 6765 645f 6279 7465  cs["managed_byte
-00004b00: 7322 5d60 600a 0a20 2020 2020 2020 2041  s"]``..        A
-00004b10: 7420 7265 7374 2c20 7468 6520 7477 6f20  t rest, the two 
-00004b20: 6e75 6d62 6572 7320 6d75 7374 2062 6520  numbers must be 
-00004b30: 6964 656e 7469 6361 6c2e 2048 6f77 6576  identical. Howev
-00004b40: 6572 2c20 6060 7365 6c66 2e6e 6279 7465  er, ``self.nbyte
-00004b50: 7360 6020 6973 0a20 2020 2020 2020 2069  s`` is.        i
-00004b60: 6d6d 6564 6961 7465 6c79 2075 7064 6174  mmediately updat
-00004b70: 6564 2074 6872 6f75 6768 2074 6865 2062  ed through the b
-00004b80: 6174 6368 6564 2063 6f6d 6d73 2061 7320  atched comms as 
-00004b90: 736f 6f6e 2061 7320 6561 6368 2074 6173  soon as each tas
-00004ba0: 6b20 6c61 6e64 7320 696e 0a20 2020 2020  k lands in.     
-00004bb0: 2020 206d 656d 6f72 7920 6f6e 2074 6865     memory on the
-00004bc0: 2077 6f72 6b65 723b 2060 6073 656c 662e   worker; ``self.
-00004bd0: 6d65 7472 6963 735b 226d 616e 6167 6564  metrics["managed
-00004be0: 5f62 7974 6573 225d 6060 2069 6e73 7465  _bytes"]`` inste
-00004bf0: 6164 2069 7320 7570 6461 7465 6420 6279  ad is updated by
-00004c00: 0a20 2020 2020 2020 2074 6865 2068 6561  .        the hea
-00004c10: 7274 6265 6174 2c20 7768 6963 6820 6361  rtbeat, which ca
-00004c20: 6e20 6c61 6720 7365 7665 7261 6c20 7365  n lag several se
-00004c30: 636f 6e64 7320 6265 6869 6e64 2e0a 0a20  conds behind... 
-00004c40: 2020 2020 2020 2042 656c 6f77 2077 6520         Below we 
-00004c50: 6172 6520 6d69 7869 6e67 206c 696b 656c  are mixing likel
-00004c60: 7920 6e65 7765 7220 6d61 6e61 6765 6420  y newer managed 
-00004c70: 6d65 6d6f 7279 2069 6e66 6f20 6672 6f6d  memory info from
-00004c80: 2060 6073 656c 662e 6e62 7974 6573 6060   ``self.nbytes``
-00004c90: 2077 6974 680a 2020 2020 2020 2020 7072   with.        pr
-00004ca0: 6f63 6573 7320 616e 6420 7370 696c 6c65  ocess and spille
-00004cb0: 6420 6d65 6d6f 7279 2066 726f 6d20 7468  d memory from th
-00004cc0: 6520 6865 6172 7462 6561 742e 2054 6869  e heartbeat. Thi
-00004cd0: 7320 6973 2064 656c 6962 6572 6174 652c  s is deliberate,
-00004ce0: 2073 6f20 7468 6174 0a20 2020 2020 2020   so that.       
-00004cf0: 206d 616e 6167 6564 206d 656d 6f72 7920   managed memory 
-00004d00: 746f 7461 6c20 6973 2075 7064 6174 6564  total is updated
-00004d10: 206d 6f72 6520 6672 6571 7565 6e74 6c79   more frequently
-00004d20: 2e0a 0a20 2020 2020 2020 204d 616e 6167  ...        Manag
-00004d30: 6564 206d 656d 6f72 7920 6469 7265 6374  ed memory direct
-00004d40: 6c79 2061 6e64 2069 6d6d 6564 6961 7465  ly and immediate
-00004d50: 6c79 2063 6f6e 7472 6962 7574 6573 2074  ly contributes t
-00004d60: 6f20 6f70 7469 6d69 7374 6963 206d 656d  o optimistic mem
-00004d70: 6f72 792c 2077 6869 6368 0a20 2020 2020  ory, which.     
-00004d80: 2020 2069 7320 696e 2074 7572 6e20 7573     is in turn us
-00004d90: 6564 2069 6e20 4163 7469 7665 204d 656d  ed in Active Mem
-00004da0: 6f72 7920 4d61 6e61 6765 7220 6865 7572  ory Manager heur
-00004db0: 6973 7469 6373 2028 6174 2074 6865 206d  istics (at the m
-00004dc0: 6f6d 656e 7420 6f66 2077 7269 7469 6e67  oment of writing
-00004dd0: 3b0a 2020 2020 2020 2020 6d6f 7265 2075  ;.        more u
-00004de0: 7365 7320 7769 6c6c 206c 696b 656c 7920  ses will likely 
-00004df0: 6265 2061 6464 6564 2069 6e20 7468 6520  be added in the 
-00004e00: 6675 7475 7265 292e 2053 6f20 6974 2773  future). So it's
-00004e10: 2069 6d70 6f72 7461 6e74 2074 6f20 6861   important to ha
-00004e20: 7665 2069 740a 2020 2020 2020 2020 7570  ve it.        up
-00004e30: 2074 6f20 6461 7465 3b20 6d75 6368 206d   to date; much m
-00004e40: 6f72 6520 7468 616e 2069 7420 6973 2066  ore than it is f
-00004e50: 6f72 2070 726f 6365 7373 206d 656d 6f72  or process memor
-00004e60: 792e 0a0a 2020 2020 2020 2020 4861 7669  y...        Havi
-00004e70: 6e67 2075 702d 746f 2d64 6174 6520 6d61  ng up-to-date ma
-00004e80: 6e61 6765 6420 6d65 6d6f 7279 2069 6e66  naged memory inf
-00004e90: 6f20 6173 2073 6f6f 6e20 6173 2074 6865  o as soon as the
-00004ea0: 2073 6368 6564 756c 6572 206c 6561 726e   scheduler learn
-00004eb0: 7320 6162 6f75 740a 2020 2020 2020 2020  s about.        
-00004ec0: 7461 736b 2063 6f6d 706c 6574 696f 6e20  task completion 
-00004ed0: 616c 736f 2073 7562 7374 616e 7469 616c  also substantial
-00004ee0: 6c79 2073 696d 706c 6966 6965 7320 756e  ly simplifies un
-00004ef0: 6974 2074 6573 7473 2e0a 0a20 2020 2020  it tests...     
-00004f00: 2020 2054 6865 2066 6c69 7020 7369 6465     The flip side
-00004f10: 206f 6620 7468 6973 2064 6573 6967 6e20   of this design 
-00004f20: 6973 2074 6861 7420 6974 206d 6179 2063  is that it may c
-00004f30: 6175 7365 2073 6f6d 6520 6e6f 6973 6520  ause some noise 
-00004f40: 696e 2074 6865 0a20 2020 2020 2020 2075  in the.        u
-00004f50: 6e6d 616e 6167 6564 5f72 6563 656e 7420  nmanaged_recent 
-00004f60: 6d65 6173 7572 652e 2065 2e67 2e3a 0a0a  measure. e.g.:..
-00004f70: 2020 2020 2020 2020 312e 2044 656c 6574          1. Delet
-00004f80: 6520 3130 304d 4220 6f66 206d 616e 6167  e 100MB of manag
-00004f90: 6564 2064 6174 610a 2020 2020 2020 2020  ed data.        
-00004fa0: 322e 2054 6865 2075 7064 6174 6564 206d  2. The updated m
-00004fb0: 616e 6167 6564 206d 656d 6f72 7920 7265  anaged memory re
-00004fc0: 6163 6865 7320 7468 6520 7363 6865 6475  aches the schedu
-00004fd0: 6c65 7220 6661 7374 6572 2074 6861 6e20  ler faster than 
-00004fe0: 7468 650a 2020 2020 2020 2020 2020 2075  the.           u
-00004ff0: 7064 6174 6564 2070 726f 6365 7373 206d  pdated process m
-00005000: 656d 6f72 790a 2020 2020 2020 2020 332e  emory.        3.
-00005010: 2054 6865 7265 2773 2061 2062 6c69 7020   There's a blip 
-00005020: 7768 6572 6520 7468 6520 7363 6865 6475  where the schedu
-00005030: 6c65 7220 7468 696e 6b73 2074 6861 7420  ler thinks that 
-00005040: 7468 6572 6527 7320 6120 7375 6464 656e  there's a sudden
-00005050: 2031 3030 4d42 0a20 2020 2020 2020 2020   100MB.         
-00005060: 2020 696e 6372 6561 7365 2069 6e20 756e    increase in un
-00005070: 6d61 6e61 6765 645f 7265 6365 6e74 2c20  managed_recent, 
-00005080: 7369 6e63 6520 7072 6f63 6573 7320 6d65  since process me
-00005090: 6d6f 7279 2068 6173 6e27 7420 6368 616e  mory hasn't chan
-000050a0: 6765 6420 6275 7420 6d61 6e61 6765 640a  ged but managed.
-000050b0: 2020 2020 2020 2020 2020 206d 656d 6f72             memor
-000050c0: 7920 6861 7320 6465 6372 6561 7365 6420  y has decreased 
-000050d0: 6279 2031 3030 4d42 0a20 2020 2020 2020  by 100MB.       
-000050e0: 2034 2e20 5768 656e 2074 6865 2068 6561   4. When the hea
-000050f0: 7274 6265 6174 2061 7272 6976 6573 2c20  rtbeat arrives, 
-00005100: 7072 6f63 6573 7320 6d65 6d6f 7279 2067  process memory g
-00005110: 6f65 7320 646f 776e 2061 6e64 2073 6f20  oes down and so 
-00005120: 646f 6573 2074 6865 0a20 2020 2020 2020  does the.       
-00005130: 2020 2020 756e 6d61 6e61 6765 645f 7265      unmanaged_re
-00005140: 6365 6e74 2e0a 0a20 2020 2020 2020 2054  cent...        T
-00005150: 6869 7320 6973 204f 4b20 2d20 6f6e 6520  his is OK - one 
-00005160: 6f66 2074 6865 206d 6169 6e20 7265 6173  of the main reas
-00005170: 6f6e 7320 666f 7220 7468 6520 756e 6d61  ons for the unma
-00005180: 6e61 6765 645f 7265 6365 6e74 202f 2075  naged_recent / u
-00005190: 6e6d 616e 6167 6564 5f6f 6c64 0a20 2020  nmanaged_old.   
-000051a0: 2020 2020 2073 706c 6974 2069 7320 6578       split is ex
-000051b0: 6163 746c 7920 746f 2063 6f6e 6365 6e74  actly to concent
-000051c0: 7261 7465 2061 6c6c 2074 6865 206e 6f69  rate all the noi
-000051d0: 7365 2069 6e20 756e 6d61 6e61 6765 645f  se in unmanaged_
-000051e0: 7265 6365 6e74 2061 6e64 2065 7863 6c75  recent and exclu
-000051f0: 6465 2069 740a 2020 2020 2020 2020 6672  de it.        fr
-00005200: 6f6d 206f 7074 696d 6973 7469 6320 6d65  om optimistic me
-00005210: 6d6f 7279 2c20 7768 6963 6820 6973 2075  mory, which is u
-00005220: 7365 6420 666f 7220 6865 7572 6973 7469  sed for heuristi
-00005230: 6373 2e0a 0a20 2020 2020 2020 2053 6f6d  cs...        Som
-00005240: 6574 6869 6e67 2074 6861 7420 6973 206c  ething that is l
-00005250: 6573 7320 4f4b 2c20 6275 7420 616c 736f  ess OK, but also
-00005260: 206c 6573 7320 6672 6571 7565 6e74 2c20   less frequent, 
-00005270: 6973 2074 6861 7420 7468 6520 7375 6464  is that the sudd
-00005280: 656e 2064 656c 6574 696f 6e0a 2020 2020  en deletion.    
-00005290: 2020 2020 6f66 2073 7069 6c6c 6564 206b      of spilled k
-000052a0: 6579 7320 7769 6c6c 2063 6175 7365 2061  eys will cause a
-000052b0: 206e 6567 6174 6976 6520 626c 6970 2069   negative blip i
-000052c0: 6e20 6d61 6e61 6765 6420 6d65 6d6f 7279  n managed memory
-000052d0: 3a0a 0a20 2020 2020 2020 2031 2e20 4465  :..        1. De
-000052e0: 6c65 7465 2031 3030 4d42 206f 6620 7370  lete 100MB of sp
-000052f0: 696c 6c65 6420 6461 7461 0a20 2020 2020  illed data.     
-00005300: 2020 2032 2e20 5468 6520 7570 6461 7465     2. The update
-00005310: 6420 6d61 6e61 6765 6420 6d65 6d6f 7279  d managed memory
-00005320: 202a 746f 7461 6c2a 2072 6561 6368 6573   *total* reaches
-00005330: 2074 6865 2073 6368 6564 756c 6572 2066   the scheduler f
-00005340: 6173 7465 7220 7468 616e 2074 6865 0a20  aster than the. 
-00005350: 2020 2020 2020 2020 2020 7570 6461 7465            update
-00005360: 6420 7370 696c 6c65 6420 706f 7274 696f  d spilled portio
-00005370: 6e0a 2020 2020 2020 2020 332e 2054 6869  n.        3. Thi
-00005380: 7320 6361 7573 6573 2074 6865 206d 616e  s causes the man
-00005390: 6167 6564 206d 656d 6f72 7920 746f 2074  aged memory to t
-000053a0: 656d 706f 7261 7269 6c79 2070 6c75 6d6d  emporarily plumm
-000053b0: 6574 2061 6e64 2062 6520 7265 706c 6163  et and be replac
-000053c0: 6564 2062 790a 2020 2020 2020 2020 2020  ed by.          
-000053d0: 2075 6e6d 616e 6167 6564 5f72 6563 656e   unmanaged_recen
-000053e0: 742c 2077 6869 6c65 2073 7069 6c6c 6564  t, while spilled
-000053f0: 206d 656d 6f72 7920 7265 6d61 696e 7320   memory remains 
-00005400: 756e 616c 7465 7265 640a 2020 2020 2020  unaltered.      
-00005410: 2020 342e 2057 6865 6e20 7468 6520 6865    4. When the he
-00005420: 6172 7462 6561 7420 6172 7269 7665 732c  artbeat arrives,
-00005430: 206d 616e 6167 6564 2067 6f65 7320 6261   managed goes ba
-00005440: 636b 2075 702c 2075 6e6d 616e 6167 6564  ck up, unmanaged
-00005450: 5f72 6563 656e 740a 2020 2020 2020 2020  _recent.        
-00005460: 2020 2067 6f65 7320 6261 636b 2064 6f77     goes back dow
-00005470: 6e2c 2061 6e64 2073 7069 6c6c 6564 2067  n, and spilled g
-00005480: 6f65 7320 646f 776e 2062 7920 3130 304d  oes down by 100M
-00005490: 4220 6173 2069 7420 7368 6f75 6c64 2068  B as it should h
-000054a0: 6176 6520 746f 0a20 2020 2020 2020 2020  ave to.         
-000054b0: 2020 6265 6769 6e20 7769 7468 2e0a 0a20    begin with... 
-000054c0: 2020 2020 2020 203a 6973 7375 653a 6036         :issue:`6
-000054d0: 3030 3260 2077 696c 6c20 6c65 7420 7573  002` will let us
-000054e0: 2073 6f6c 7665 2074 6869 732e 0a20 2020   solve this..   
-000054f0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00005500: 2072 6574 7572 6e20 4d65 6d6f 7279 5374   return MemorySt
-00005510: 6174 6528 0a20 2020 2020 2020 2020 2020  ate(.           
-00005520: 2070 726f 6365 7373 3d73 656c 662e 6d65   process=self.me
-00005530: 7472 6963 735b 226d 656d 6f72 7922 5d2c  trics["memory"],
-00005540: 0a20 2020 2020 2020 2020 2020 206d 616e  .            man
-00005550: 6167 6564 3d6d 6178 2830 2c20 7365 6c66  aged=max(0, self
-00005560: 2e6e 6279 7465 7320 2d20 7365 6c66 2e6d  .nbytes - self.m
-00005570: 6574 7269 6373 5b22 7370 696c 6c65 645f  etrics["spilled_
-00005580: 6279 7465 7322 5d5b 226d 656d 6f72 7922  bytes"]["memory"
-00005590: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
-000055a0: 7370 696c 6c65 643d 7365 6c66 2e6d 6574  spilled=self.met
-000055b0: 7269 6373 5b22 7370 696c 6c65 645f 6279  rics["spilled_by
-000055c0: 7465 7322 5d5b 2264 6973 6b22 5d2c 0a20  tes"]["disk"],. 
-000055d0: 2020 2020 2020 2020 2020 2075 6e6d 616e             unman
-000055e0: 6167 6564 5f6f 6c64 3d73 656c 662e 5f6d  aged_old=self._m
-000055f0: 656d 6f72 795f 756e 6d61 6e61 6765 645f  emory_unmanaged_
-00005600: 6f6c 642c 0a20 2020 2020 2020 2029 0a0a  old,.        )..
-00005610: 2020 2020 6465 6620 636c 6561 6e28 7365      def clean(se
-00005620: 6c66 2920 2d3e 2057 6f72 6b65 7253 7461  lf) -> WorkerSta
-00005630: 7465 3a0a 2020 2020 2020 2020 2222 2252  te:.        """R
-00005640: 6574 7572 6e20 6120 7665 7273 696f 6e20  eturn a version 
-00005650: 6f66 2074 6869 7320 6f62 6a65 6374 2074  of this object t
-00005660: 6861 7420 6973 2061 7070 726f 7072 6961  hat is appropria
-00005670: 7465 2066 6f72 2073 6572 6961 6c69 7a61  te for serializa
-00005680: 7469 6f6e 2222 220a 2020 2020 2020 2020  tion""".        
-00005690: 7773 203d 2057 6f72 6b65 7253 7461 7465  ws = WorkerState
-000056a0: 280a 2020 2020 2020 2020 2020 2020 6164  (.            ad
-000056b0: 6472 6573 733d 7365 6c66 2e61 6464 7265  dress=self.addre
-000056c0: 7373 2c0a 2020 2020 2020 2020 2020 2020  ss,.            
-000056d0: 7374 6174 7573 3d73 656c 662e 7374 6174  status=self.stat
-000056e0: 7573 2c0a 2020 2020 2020 2020 2020 2020  us,.            
-000056f0: 7069 643d 7365 6c66 2e70 6964 2c0a 2020  pid=self.pid,.  
-00005700: 2020 2020 2020 2020 2020 6e61 6d65 3d73            name=s
-00005710: 656c 662e 6e61 6d65 2c0a 2020 2020 2020  elf.name,.      
-00005720: 2020 2020 2020 6e74 6872 6561 6473 3d73        nthreads=s
-00005730: 656c 662e 6e74 6872 6561 6473 2c0a 2020  elf.nthreads,.  
-00005740: 2020 2020 2020 2020 2020 6d65 6d6f 7279            memory
-00005750: 5f6c 696d 6974 3d73 656c 662e 6d65 6d6f  _limit=self.memo
-00005760: 7279 5f6c 696d 6974 2c0a 2020 2020 2020  ry_limit,.      
-00005770: 2020 2020 2020 6c6f 6361 6c5f 6469 7265        local_dire
-00005780: 6374 6f72 793d 7365 6c66 2e6c 6f63 616c  ctory=self.local
-00005790: 5f64 6972 6563 746f 7279 2c0a 2020 2020  _directory,.    
-000057a0: 2020 2020 2020 2020 7365 7276 6963 6573          services
-000057b0: 3d73 656c 662e 7365 7276 6963 6573 2c0a  =self.services,.
-000057c0: 2020 2020 2020 2020 2020 2020 6e61 6e6e              nann
-000057d0: 793d 7365 6c66 2e6e 616e 6e79 2c0a 2020  y=self.nanny,.  
-000057e0: 2020 2020 2020 2020 2020 6578 7472 613d            extra=
-000057f0: 7365 6c66 2e65 7874 7261 2c0a 2020 2020  self.extra,.    
-00005800: 2020 2020 2020 2020 7365 7276 6572 5f69          server_i
-00005810: 643d 7365 6c66 2e73 6572 7665 725f 6964  d=self.server_id
-00005820: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-00005830: 2020 2020 7773 2e5f 6f63 6375 7061 6e63      ws._occupanc
-00005840: 795f 6361 6368 6520 3d20 7365 6c66 2e6f  y_cache = self.o
-00005850: 6363 7570 616e 6379 0a0a 2020 2020 2020  ccupancy..      
-00005860: 2020 7773 2e65 7865 6375 7469 6e67 203d    ws.executing =
-00005870: 207b 0a20 2020 2020 2020 2020 2020 2074   {.            t
-00005880: 732e 6b65 793a 2064 7572 6174 696f 6e20  s.key: duration 
-00005890: 666f 7220 7473 2c20 6475 7261 7469 6f6e  for ts, duration
-000058a0: 2069 6e20 7365 6c66 2e65 7865 6375 7469   in self.executi
-000058b0: 6e67 2e69 7465 6d73 2829 2020 2320 7479  ng.items()  # ty
-000058c0: 7065 3a20 6967 6e6f 7265 0a20 2020 2020  pe: ignore.     
-000058d0: 2020 207d 0a20 2020 2020 2020 2072 6574     }.        ret
-000058e0: 7572 6e20 7773 0a0a 2020 2020 6465 6620  urn ws..    def 
-000058f0: 5f5f 7265 7072 5f5f 2873 656c 6629 202d  __repr__(self) -
-00005900: 3e20 7374 723a 0a20 2020 2020 2020 206e  > str:.        n
-00005910: 616d 6520 3d20 6622 2c20 6e61 6d65 3a20  ame = f", name: 
-00005920: 7b73 656c 662e 6e61 6d65 7d22 2069 6620  {self.name}" if 
-00005930: 7365 6c66 2e6e 616d 6520 213d 2073 656c  self.name != sel
-00005940: 662e 6164 6472 6573 7320 656c 7365 2022  f.address else "
-00005950: 220a 2020 2020 2020 2020 7265 7475 726e  ".        return
-00005960: 2028 0a20 2020 2020 2020 2020 2020 2066   (.            f
-00005970: 223c 576f 726b 6572 5374 6174 6520 7b73  "<WorkerState {s
-00005980: 656c 662e 6164 6472 6573 7321 727d 7b6e  elf.address!r}{n
-00005990: 616d 657d 2c20 220a 2020 2020 2020 2020  ame}, ".        
-000059a0: 2020 2020 6622 7374 6174 7573 3a20 7b73      f"status: {s
-000059b0: 656c 662e 7374 6174 7573 2e6e 616d 657d  elf.status.name}
-000059c0: 2c20 220a 2020 2020 2020 2020 2020 2020  , ".            
-000059d0: 6622 6d65 6d6f 7279 3a20 7b6c 656e 2873  f"memory: {len(s
-000059e0: 656c 662e 6861 735f 7768 6174 297d 2c20  elf.has_what)}, 
-000059f0: 220a 2020 2020 2020 2020 2020 2020 6622  ".            f"
-00005a00: 7072 6f63 6573 7369 6e67 3a20 7b6c 656e  processing: {len
-00005a10: 2873 656c 662e 7072 6f63 6573 7369 6e67  (self.processing
-00005a20: 297d 3e22 0a20 2020 2020 2020 2029 0a0a  )}>".        )..
-00005a30: 2020 2020 6465 6620 5f72 6570 725f 6874      def _repr_ht
-00005a40: 6d6c 5f28 7365 6c66 2920 2d3e 2073 7472  ml_(self) -> str
-00005a50: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-00005a60: 2067 6574 5f74 656d 706c 6174 6528 2277   get_template("w
-00005a70: 6f72 6b65 725f 7374 6174 652e 6874 6d6c  orker_state.html
-00005a80: 2e6a 3222 292e 7265 6e64 6572 280a 2020  .j2").render(.  
-00005a90: 2020 2020 2020 2020 2020 6164 6472 6573            addres
-00005aa0: 733d 7365 6c66 2e61 6464 7265 7373 2c0a  s=self.address,.
-00005ab0: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-00005ac0: 3d73 656c 662e 6e61 6d65 2c0a 2020 2020  =self.name,.    
-00005ad0: 2020 2020 2020 2020 7374 6174 7573 3d73          status=s
-00005ae0: 656c 662e 7374 6174 7573 2e6e 616d 652c  elf.status.name,
-00005af0: 0a20 2020 2020 2020 2020 2020 2068 6173  .            has
-00005b00: 5f77 6861 743d 7365 6c66 2e68 6173 5f77  _what=self.has_w
-00005b10: 6861 742c 0a20 2020 2020 2020 2020 2020  hat,.           
-00005b20: 2070 726f 6365 7373 696e 673d 7365 6c66   processing=self
-00005b30: 2e70 726f 6365 7373 696e 672c 0a20 2020  .processing,.   
-00005b40: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
-00005b50: 6964 656e 7469 7479 2873 656c 6629 202d  identity(self) -
-00005b60: 3e20 6469 6374 5b73 7472 2c20 416e 795d  > dict[str, Any]
-00005b70: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-00005b80: 207b 0a20 2020 2020 2020 2020 2020 2022   {.            "
-00005b90: 7479 7065 223a 2022 576f 726b 6572 222c  type": "Worker",
-00005ba0: 0a20 2020 2020 2020 2020 2020 2022 6964  .            "id
-00005bb0: 223a 2073 656c 662e 6e61 6d65 2c0a 2020  ": self.name,.  
-00005bc0: 2020 2020 2020 2020 2020 2268 6f73 7422            "host"
-00005bd0: 3a20 7365 6c66 2e68 6f73 742c 0a20 2020  : self.host,.   
-00005be0: 2020 2020 2020 2020 2022 7265 736f 7572           "resour
-00005bf0: 6365 7322 3a20 7365 6c66 2e72 6573 6f75  ces": self.resou
-00005c00: 7263 6573 2c0a 2020 2020 2020 2020 2020  rces,.          
-00005c10: 2020 226c 6f63 616c 5f64 6972 6563 746f    "local_directo
-00005c20: 7279 223a 2073 656c 662e 6c6f 6361 6c5f  ry": self.local_
-00005c30: 6469 7265 6374 6f72 792c 0a20 2020 2020  directory,.     
-00005c40: 2020 2020 2020 2022 6e61 6d65 223a 2073         "name": s
-00005c50: 656c 662e 6e61 6d65 2c0a 2020 2020 2020  elf.name,.      
-00005c60: 2020 2020 2020 226e 7468 7265 6164 7322        "nthreads"
-00005c70: 3a20 7365 6c66 2e6e 7468 7265 6164 732c  : self.nthreads,
-00005c80: 0a20 2020 2020 2020 2020 2020 2022 6d65  .            "me
-00005c90: 6d6f 7279 5f6c 696d 6974 223a 2073 656c  mory_limit": sel
-00005ca0: 662e 6d65 6d6f 7279 5f6c 696d 6974 2c0a  f.memory_limit,.
-00005cb0: 2020 2020 2020 2020 2020 2020 226c 6173              "las
-00005cc0: 745f 7365 656e 223a 2073 656c 662e 6c61  t_seen": self.la
-00005cd0: 7374 5f73 6565 6e2c 0a20 2020 2020 2020  st_seen,.       
-00005ce0: 2020 2020 2022 7365 7276 6963 6573 223a       "services":
-00005cf0: 2073 656c 662e 7365 7276 6963 6573 2c0a   self.services,.
-00005d00: 2020 2020 2020 2020 2020 2020 226d 6574              "met
-00005d10: 7269 6373 223a 2073 656c 662e 6d65 7472  rics": self.metr
-00005d20: 6963 732c 0a20 2020 2020 2020 2020 2020  ics,.           
-00005d30: 2022 7374 6174 7573 223a 2073 656c 662e   "status": self.
-00005d40: 7374 6174 7573 2e6e 616d 652c 0a20 2020  status.name,.   
-00005d50: 2020 2020 2020 2020 2022 6e61 6e6e 7922           "nanny"
-00005d60: 3a20 7365 6c66 2e6e 616e 6e79 2c0a 2020  : self.nanny,.  
-00005d70: 2020 2020 2020 2020 2020 2a2a 7365 6c66            **self
-00005d80: 2e65 7874 7261 2c0a 2020 2020 2020 2020  .extra,.        
-00005d90: 7d0a 0a20 2020 2064 6566 205f 746f 5f64  }..    def _to_d
-00005da0: 6963 745f 6e6f 5f6e 6573 7428 7365 6c66  ict_no_nest(self
-00005db0: 2c20 2a2c 2065 7863 6c75 6465 3a20 436f  , *, exclude: Co
-00005dc0: 6e74 6169 6e65 725b 7374 725d 203d 2028  ntainer[str] = (
-00005dd0: 2929 202d 3e20 6469 6374 5b73 7472 2c20  )) -> dict[str, 
-00005de0: 416e 795d 3a0a 2020 2020 2020 2020 2222  Any]:.        ""
-00005df0: 2244 6963 7469 6f6e 6172 7920 7265 7072  "Dictionary repr
-00005e00: 6573 656e 7461 7469 6f6e 2066 6f72 2064  esentation for d
-00005e10: 6562 7567 6769 6e67 2070 7572 706f 7365  ebugging purpose
-00005e20: 732e 0a20 2020 2020 2020 204e 6f74 2074  s..        Not t
-00005e30: 7970 6520 7374 6162 6c65 2061 6e64 206e  ype stable and n
-00005e40: 6f74 2069 6e74 656e 6465 6420 666f 7220  ot intended for 
-00005e50: 726f 756e 6474 7269 7073 2e0a 0a20 2020  roundtrips...   
-00005e60: 2020 2020 2053 6565 2061 6c73 6f0a 2020       See also.  
-00005e70: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20        --------. 
-00005e80: 2020 2020 2020 2043 6c69 656e 742e 6475         Client.du
-00005e90: 6d70 5f63 6c75 7374 6572 5f73 7461 7465  mp_cluster_state
-00005ea0: 0a20 2020 2020 2020 2064 6973 7472 6962  .        distrib
-00005eb0: 7574 6564 2e75 7469 6c73 2e72 6563 7572  uted.utils.recur
-00005ec0: 7369 7665 5f74 6f5f 6469 6374 0a20 2020  sive_to_dict.   
-00005ed0: 2020 2020 2054 6173 6b53 7461 7465 2e5f       TaskState._
-00005ee0: 746f 5f64 6963 740a 2020 2020 2020 2020  to_dict.        
-00005ef0: 2222 220a 2020 2020 2020 2020 7265 7475  """.        retu
-00005f00: 726e 2072 6563 7572 7369 7665 5f74 6f5f  rn recursive_to_
-00005f10: 6469 6374 280a 2020 2020 2020 2020 2020  dict(.          
-00005f20: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-00005f30: 2020 2020 6578 636c 7564 653d 7365 7428      exclude=set(
-00005f40: 6578 636c 7564 6529 207c 207b 2276 6572  exclude) | {"ver
-00005f50: 7369 6f6e 7322 7d2c 2020 2320 7479 7065  sions"},  # type
-00005f60: 3a20 6967 6e6f 7265 0a20 2020 2020 2020  : ignore.       
-00005f70: 2020 2020 206d 656d 6265 7273 3d54 7275       members=Tru
-00005f80: 652c 0a20 2020 2020 2020 2029 0a0a 2020  e,.        )..  
-00005f90: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
-00005fa0: 6465 6620 7363 6865 6475 6c65 7228 7365  def scheduler(se
-00005fb0: 6c66 2920 2d3e 2053 6368 6564 756c 6572  lf) -> Scheduler
-00005fc0: 5374 6174 653a 0a20 2020 2020 2020 2061  State:.        a
-00005fd0: 7373 6572 7420 7365 6c66 2e73 6368 6564  ssert self.sched
-00005fe0: 756c 6572 5f72 6566 0a20 2020 2020 2020  uler_ref.       
-00005ff0: 2073 203d 2073 656c 662e 7363 6865 6475   s = self.schedu
-00006000: 6c65 725f 7265 6628 290a 2020 2020 2020  ler_ref().      
-00006010: 2020 6173 7365 7274 2073 0a20 2020 2020    assert s.     
-00006020: 2020 2072 6574 7572 6e20 730a 0a20 2020     return s..   
-00006030: 2064 6566 2061 6464 5f74 6f5f 7072 6f63   def add_to_proc
-00006040: 6573 7369 6e67 2873 656c 662c 2074 733a  essing(self, ts:
-00006050: 2054 6173 6b53 7461 7465 2920 2d3e 204e   TaskState) -> N
-00006060: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
-00006070: 4173 7369 676e 2061 2074 6173 6b20 746f  Assign a task to
-00006080: 2074 6869 7320 776f 726b 6572 2066 6f72   this worker for
-00006090: 2063 6f6d 7075 7465 2e22 2222 0a20 2020   compute.""".   
-000060a0: 2020 2020 2069 6620 7365 6c66 2e73 6368       if self.sch
-000060b0: 6564 756c 6572 2e76 616c 6964 6174 653a  eduler.validate:
-000060c0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-000060d0: 6572 7420 7473 206e 6f74 2069 6e20 7365  ert ts not in se
-000060e0: 6c66 2e70 726f 6365 7373 696e 670a 0a20  lf.processing.. 
-000060f0: 2020 2020 2020 2074 7020 3d20 7473 2e70         tp = ts.p
-00006100: 7265 6669 780a 2020 2020 2020 2020 7365  refix.        se
-00006110: 6c66 2e74 6173 6b5f 7072 6566 6978 5f63  lf.task_prefix_c
-00006120: 6f75 6e74 5b74 702e 6e61 6d65 5d20 2b3d  ount[tp.name] +=
-00006130: 2031 0a20 2020 2020 2020 2073 656c 662e   1.        self.
-00006140: 7363 6865 6475 6c65 722e 5f74 6173 6b5f  scheduler._task_
-00006150: 7072 6566 6978 5f63 6f75 6e74 5f67 6c6f  prefix_count_glo
-00006160: 6261 6c5b 7470 2e6e 616d 655d 202b 3d20  bal[tp.name] += 
-00006170: 310a 2020 2020 2020 2020 7365 6c66 2e70  1.        self.p
-00006180: 726f 6365 7373 696e 672e 6164 6428 7473  rocessing.add(ts
-00006190: 290a 2020 2020 2020 2020 666f 7220 6474  ).        for dt
-000061a0: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
-000061b0: 6369 6573 3a0a 2020 2020 2020 2020 2020  cies:.          
-000061c0: 2020 6173 7365 7274 2064 7473 2e77 686f    assert dts.who
-000061d0: 5f68 6173 0a20 2020 2020 2020 2020 2020  _has.           
-000061e0: 2069 6620 7365 6c66 206e 6f74 2069 6e20   if self not in 
-000061f0: 6474 732e 7768 6f5f 6861 733a 0a20 2020  dts.who_has:.   
-00006200: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00006210: 662e 5f69 6e63 5f6e 6565 6473 5f72 6570  f._inc_needs_rep
-00006220: 6c69 6361 2864 7473 290a 0a20 2020 2064  lica(dts)..    d
-00006230: 6566 2061 6464 5f74 6f5f 6c6f 6e67 5f72  ef add_to_long_r
-00006240: 756e 6e69 6e67 2873 656c 662c 2074 733a  unning(self, ts:
-00006250: 2054 6173 6b53 7461 7465 2920 2d3e 204e   TaskState) -> N
-00006260: 6f6e 653a 0a20 2020 2020 2020 2069 6620  one:.        if 
-00006270: 7365 6c66 2e73 6368 6564 756c 6572 2e76  self.scheduler.v
-00006280: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
-00006290: 2020 2020 2061 7373 6572 7420 7473 2069       assert ts i
-000062a0: 6e20 7365 6c66 2e70 726f 6365 7373 696e  n self.processin
-000062b0: 670a 2020 2020 2020 2020 2020 2020 6173  g.            as
-000062c0: 7365 7274 2074 7320 6e6f 7420 696e 2073  sert ts not in s
-000062d0: 656c 662e 6c6f 6e67 5f72 756e 6e69 6e67  elf.long_running
-000062e0: 0a0a 2020 2020 2020 2020 7365 6c66 2e5f  ..        self._
-000062f0: 7265 6d6f 7665 5f66 726f 6d5f 7461 736b  remove_from_task
-00006300: 5f70 7265 6669 785f 636f 756e 7428 7473  _prefix_count(ts
-00006310: 290a 2020 2020 2020 2020 2320 4361 6e6e  ).        # Cann
-00006320: 6f74 2072 656d 6f76 6520 6672 6f6d 2070  ot remove from p
-00006330: 726f 6365 7373 696e 6720 7369 6e63 6520  rocessing since 
-00006340: 7765 2772 6520 7573 696e 6720 7468 6973  we're using this
-00006350: 2066 6f72 2074 6869 6e67 7320 6c69 6b65   for things like
-00006360: 0a20 2020 2020 2020 2023 2069 646c 656e  .        # idlen
-00006370: 6573 7320 6465 7465 6374 696f 6e2e 2049  ess detection. I
-00006380: 646c 6520 776f 726b 6572 7320 6172 6520  dle workers are 
-00006390: 7479 7069 6361 6c6c 7920 7461 7267 6574  typically target
-000063a0: 6564 2066 6f72 0a20 2020 2020 2020 2023  ed for.        #
-000063b0: 2064 6f77 6e73 6361 6c69 6e67 2062 7574   downscaling but
-000063c0: 2077 6520 7368 6f75 6c64 206e 6f74 2064   we should not d
-000063d0: 6f77 6e73 6361 6c65 2077 6f72 6b65 7273  ownscale workers
-000063e0: 2077 6974 6820 6c6f 6e67 2072 756e 6e69   with long runni
-000063f0: 6e67 0a20 2020 2020 2020 2023 2074 6173  ng.        # tas
-00006400: 6b73 0a20 2020 2020 2020 2073 656c 662e  ks.        self.
-00006410: 6c6f 6e67 5f72 756e 6e69 6e67 2e61 6464  long_running.add
-00006420: 2874 7329 0a0a 2020 2020 6465 6620 7265  (ts)..    def re
-00006430: 6d6f 7665 5f66 726f 6d5f 7072 6f63 6573  move_from_proces
-00006440: 7369 6e67 2873 656c 662c 2074 733a 2054  sing(self, ts: T
-00006450: 6173 6b53 7461 7465 2920 2d3e 204e 6f6e  askState) -> Non
-00006460: 653a 0a20 2020 2020 2020 2022 2222 5265  e:.        """Re
-00006470: 6d6f 7665 2061 2074 6173 6b20 6672 6f6d  move a task from
-00006480: 2061 2077 6f72 6b65 7273 2070 726f 6365   a workers proce
-00006490: 7373 696e 6722 2222 0a20 2020 2020 2020  ssing""".       
-000064a0: 2069 6620 7365 6c66 2e73 6368 6564 756c   if self.schedul
-000064b0: 6572 2e76 616c 6964 6174 653a 0a20 2020  er.validate:.   
-000064c0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-000064d0: 7473 2069 6e20 7365 6c66 2e70 726f 6365  ts in self.proce
-000064e0: 7373 696e 670a 0a20 2020 2020 2020 2069  ssing..        i
-000064f0: 6620 7473 2069 6e20 7365 6c66 2e6c 6f6e  f ts in self.lon
-00006500: 675f 7275 6e6e 696e 673a 0a20 2020 2020  g_running:.     
-00006510: 2020 2020 2020 2073 656c 662e 6c6f 6e67         self.long
-00006520: 5f72 756e 6e69 6e67 2e64 6973 6361 7264  _running.discard
-00006530: 2874 7329 0a20 2020 2020 2020 2065 6c73  (ts).        els
-00006540: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
-00006550: 656c 662e 5f72 656d 6f76 655f 6672 6f6d  elf._remove_from
-00006560: 5f74 6173 6b5f 7072 6566 6978 5f63 6f75  _task_prefix_cou
-00006570: 6e74 2874 7329 0a20 2020 2020 2020 2073  nt(ts).        s
-00006580: 656c 662e 7072 6f63 6573 7369 6e67 2e72  elf.processing.r
-00006590: 656d 6f76 6528 7473 290a 2020 2020 2020  emove(ts).      
-000065a0: 2020 666f 7220 6474 7320 696e 2074 732e    for dts in ts.
-000065b0: 6465 7065 6e64 656e 6369 6573 3a0a 2020  dependencies:.  
-000065c0: 2020 2020 2020 2020 2020 6966 2064 7473            if dts
-000065d0: 2069 6e20 7365 6c66 2e6e 6565 6473 5f77   in self.needs_w
-000065e0: 6861 743a 0a20 2020 2020 2020 2020 2020  hat:.           
-000065f0: 2020 2020 2073 656c 662e 5f64 6563 5f6e       self._dec_n
-00006600: 6565 6473 5f72 6570 6c69 6361 2864 7473  eeds_replica(dts
-00006610: 290a 0a20 2020 2064 6566 205f 7265 6d6f  )..    def _remo
-00006620: 7665 5f66 726f 6d5f 7461 736b 5f70 7265  ve_from_task_pre
-00006630: 6669 785f 636f 756e 7428 7365 6c66 2c20  fix_count(self, 
-00006640: 7473 3a20 5461 736b 5374 6174 6529 202d  ts: TaskState) -
-00006650: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-00006660: 636f 756e 7420 3d20 7365 6c66 2e74 6173  count = self.tas
-00006670: 6b5f 7072 6566 6978 5f63 6f75 6e74 5b74  k_prefix_count[t
-00006680: 732e 7072 6566 6978 2e6e 616d 655d 202d  s.prefix.name] -
-00006690: 2031 0a20 2020 2020 2020 2069 6620 636f   1.        if co
-000066a0: 756e 743a 0a20 2020 2020 2020 2020 2020  unt:.           
-000066b0: 2073 656c 662e 7461 736b 5f70 7265 6669   self.task_prefi
-000066c0: 785f 636f 756e 745b 7473 2e70 7265 6669  x_count[ts.prefi
-000066d0: 782e 6e61 6d65 5d20 3d20 636f 756e 740a  x.name] = count.
-000066e0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-000066f0: 2020 2020 2020 2020 2020 6465 6c20 7365            del se
-00006700: 6c66 2e74 6173 6b5f 7072 6566 6978 5f63  lf.task_prefix_c
-00006710: 6f75 6e74 5b74 732e 7072 6566 6978 2e6e  ount[ts.prefix.n
-00006720: 616d 655d 0a0a 2020 2020 2020 2020 636f  ame]..        co
-00006730: 756e 7420 3d20 7365 6c66 2e73 6368 6564  unt = self.sched
-00006740: 756c 6572 2e5f 7461 736b 5f70 7265 6669  uler._task_prefi
-00006750: 785f 636f 756e 745f 676c 6f62 616c 5b74  x_count_global[t
-00006760: 732e 7072 6566 6978 2e6e 616d 655d 202d  s.prefix.name] -
-00006770: 2031 0a20 2020 2020 2020 2069 6620 636f   1.        if co
-00006780: 756e 743a 0a20 2020 2020 2020 2020 2020  unt:.           
-00006790: 2073 656c 662e 7363 6865 6475 6c65 722e   self.scheduler.
-000067a0: 5f74 6173 6b5f 7072 6566 6978 5f63 6f75  _task_prefix_cou
-000067b0: 6e74 5f67 6c6f 6261 6c5b 7473 2e70 7265  nt_global[ts.pre
-000067c0: 6669 782e 6e61 6d65 5d20 3d20 636f 756e  fix.name] = coun
-000067d0: 740a 2020 2020 2020 2020 656c 7365 3a0a  t.        else:.
-000067e0: 2020 2020 2020 2020 2020 2020 6465 6c20              del 
-000067f0: 7365 6c66 2e73 6368 6564 756c 6572 2e5f  self.scheduler._
-00006800: 7461 736b 5f70 7265 6669 785f 636f 756e  task_prefix_coun
-00006810: 745f 676c 6f62 616c 5b74 732e 7072 6566  t_global[ts.pref
-00006820: 6978 2e6e 616d 655d 0a0a 2020 2020 6465  ix.name]..    de
-00006830: 6620 7265 6d6f 7665 5f72 6570 6c69 6361  f remove_replica
-00006840: 2873 656c 662c 2074 733a 2054 6173 6b53  (self, ts: TaskS
-00006850: 7461 7465 2920 2d3e 204e 6f6e 653a 0a20  tate) -> None:. 
-00006860: 2020 2020 2020 2022 2222 5468 6520 776f         """The wo
-00006870: 726b 6572 206e 6f20 6c6f 6e67 6572 2068  rker no longer h
-00006880: 6173 2061 2074 6173 6b20 696e 206d 656d  as a task in mem
-00006890: 6f72 7922 2222 0a20 2020 2020 2020 2069  ory""".        i
-000068a0: 6620 7365 6c66 2e73 6368 6564 756c 6572  f self.scheduler
-000068b0: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
-000068c0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
-000068d0: 2e77 686f 5f68 6173 0a20 2020 2020 2020  .who_has.       
-000068e0: 2020 2020 2061 7373 6572 7420 7365 6c66       assert self
-000068f0: 2069 6e20 7473 2e77 686f 5f68 6173 0a20   in ts.who_has. 
-00006900: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00006910: 7420 7473 2069 6e20 7365 6c66 2e68 6173  t ts in self.has
-00006920: 5f77 6861 740a 2020 2020 2020 2020 2020  _what.          
-00006930: 2020 6173 7365 7274 2074 7320 6e6f 7420    assert ts not 
-00006940: 696e 2073 656c 662e 6e65 6564 735f 7768  in self.needs_wh
-00006950: 6174 0a0a 2020 2020 2020 2020 7365 6c66  at..        self
-00006960: 2e6e 6279 7465 7320 2d3d 2074 732e 6765  .nbytes -= ts.ge
-00006970: 745f 6e62 7974 6573 2829 0a20 2020 2020  t_nbytes().     
-00006980: 2020 2064 656c 2073 656c 662e 5f68 6173     del self._has
-00006990: 5f77 6861 745b 7473 5d0a 2020 2020 2020  _what[ts].      
-000069a0: 2020 7473 2e77 686f 5f68 6173 2e72 656d    ts.who_has.rem
-000069b0: 6f76 6528 7365 6c66 2920 2023 2074 7970  ove(self)  # typ
-000069c0: 653a 2069 676e 6f72 650a 2020 2020 2020  e: ignore.      
-000069d0: 2020 6966 206e 6f74 2074 732e 7768 6f5f    if not ts.who_
-000069e0: 6861 733a 0a20 2020 2020 2020 2020 2020  has:.           
-000069f0: 2074 732e 7768 6f5f 6861 7320 3d20 4e6f   ts.who_has = No
-00006a00: 6e65 0a0a 2020 2020 6465 6620 5f69 6e63  ne..    def _inc
-00006a10: 5f6e 6565 6473 5f72 6570 6c69 6361 2873  _needs_replica(s
-00006a20: 656c 662c 2074 733a 2054 6173 6b53 7461  elf, ts: TaskSta
-00006a30: 7465 2920 2d3e 204e 6f6e 653a 0a20 2020  te) -> None:.   
-00006a40: 2020 2020 2022 2222 4173 7369 676e 2061       """Assign a
-00006a50: 2074 6173 6b20 6665 7463 6820 746f 2074   task fetch to t
-00006a60: 6869 7320 776f 726b 6572 2061 6e64 2075  his worker and u
-00006a70: 7064 6174 6520 6e65 7477 6f72 6b20 6f63  pdate network oc
-00006a80: 6375 7061 6e63 6965 7322 2222 0a20 2020  cupancies""".   
-00006a90: 2020 2020 2069 6620 7365 6c66 2e73 6368       if self.sch
-00006aa0: 6564 756c 6572 2e76 616c 6964 6174 653a  eduler.validate:
-00006ab0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00006ac0: 6572 7420 7473 2e77 686f 5f68 6173 0a20  ert ts.who_has. 
-00006ad0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00006ae0: 7420 7365 6c66 206e 6f74 2069 6e20 7473  t self not in ts
-00006af0: 2e77 686f 5f68 6173 0a20 2020 2020 2020  .who_has.       
-00006b00: 2020 2020 2061 7373 6572 7420 7473 206e       assert ts n
-00006b10: 6f74 2069 6e20 7365 6c66 2e68 6173 5f77  ot in self.has_w
-00006b20: 6861 740a 2020 2020 2020 2020 6966 2074  hat.        if t
-00006b30: 7320 6e6f 7420 696e 2073 656c 662e 6e65  s not in self.ne
-00006b40: 6564 735f 7768 6174 3a0a 2020 2020 2020  eds_what:.      
-00006b50: 2020 2020 2020 7365 6c66 2e6e 6565 6473        self.needs
-00006b60: 5f77 6861 745b 7473 5d20 3d20 310a 2020  _what[ts] = 1.  
-00006b70: 2020 2020 2020 2020 2020 6e62 7974 6573            nbytes
-00006b80: 203d 2074 732e 6765 745f 6e62 7974 6573   = ts.get_nbytes
-00006b90: 2829 0a20 2020 2020 2020 2020 2020 2073  ().            s
-00006ba0: 656c 662e 5f6e 6574 776f 726b 5f6f 6363  elf._network_occ
-00006bb0: 202b 3d20 6e62 7974 6573 0a20 2020 2020   += nbytes.     
-00006bc0: 2020 2020 2020 2073 656c 662e 7363 6865         self.sche
-00006bd0: 6475 6c65 722e 5f6e 6574 776f 726b 5f6f  duler._network_o
-00006be0: 6363 5f67 6c6f 6261 6c20 2b3d 206e 6279  cc_global += nby
-00006bf0: 7465 730a 2020 2020 2020 2020 656c 7365  tes.        else
-00006c00: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00006c10: 6c66 2e6e 6565 6473 5f77 6861 745b 7473  lf.needs_what[ts
-00006c20: 5d20 2b3d 2031 0a0a 2020 2020 6465 6620  ] += 1..    def 
-00006c30: 5f64 6563 5f6e 6565 6473 5f72 6570 6c69  _dec_needs_repli
-00006c40: 6361 2873 656c 662c 2074 733a 2054 6173  ca(self, ts: Tas
-00006c50: 6b53 7461 7465 2920 2d3e 204e 6f6e 653a  kState) -> None:
-00006c60: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00006c70: 2e73 6368 6564 756c 6572 2e76 616c 6964  .scheduler.valid
-00006c80: 6174 653a 0a20 2020 2020 2020 2020 2020  ate:.           
-00006c90: 2061 7373 6572 7420 7473 2069 6e20 7365   assert ts in se
-00006ca0: 6c66 2e6e 6565 6473 5f77 6861 740a 0a20  lf.needs_what.. 
-00006cb0: 2020 2020 2020 2073 656c 662e 6e65 6564         self.need
-00006cc0: 735f 7768 6174 5b74 735d 202d 3d20 310a  s_what[ts] -= 1.
-00006cd0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00006ce0: 6e65 6564 735f 7768 6174 5b74 735d 203d  needs_what[ts] =
-00006cf0: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
-00006d00: 2064 656c 2073 656c 662e 6e65 6564 735f   del self.needs_
-00006d10: 7768 6174 5b74 735d 0a20 2020 2020 2020  what[ts].       
-00006d20: 2020 2020 206e 6279 7465 7320 3d20 7473       nbytes = ts
-00006d30: 2e67 6574 5f6e 6279 7465 7328 290a 2020  .get_nbytes().  
-00006d40: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-00006d50: 6e65 7477 6f72 6b5f 6f63 6320 2d3d 206e  network_occ -= n
-00006d60: 6279 7465 730a 2020 2020 2020 2020 2020  bytes.          
-00006d70: 2020 7365 6c66 2e73 6368 6564 756c 6572    self.scheduler
-00006d80: 2e5f 6e65 7477 6f72 6b5f 6f63 635f 676c  ._network_occ_gl
-00006d90: 6f62 616c 202d 3d20 6e62 7974 6573 0a0a  obal -= nbytes..
-00006da0: 2020 2020 6465 6620 6164 645f 7265 706c      def add_repl
-00006db0: 6963 6128 7365 6c66 2c20 7473 3a20 5461  ica(self, ts: Ta
-00006dc0: 736b 5374 6174 6529 202d 3e20 4e6f 6e65  skState) -> None
-00006dd0: 3a0a 2020 2020 2020 2020 2222 2254 6865  :.        """The
-00006de0: 2077 6f72 6b65 7220 6163 7175 6972 6564   worker acquired
-00006df0: 2061 2072 6570 6c69 6361 206f 6620 7461   a replica of ta
-00006e00: 736b 2222 220a 2020 2020 2020 2020 6966  sk""".        if
-00006e10: 2074 732e 7768 6f5f 6861 7320 6973 204e   ts.who_has is N
-00006e20: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00006e30: 2074 732e 7768 6f5f 6861 7320 3d20 7365   ts.who_has = se
-00006e40: 7428 290a 2020 2020 2020 2020 6966 2074  t().        if t
-00006e50: 7320 696e 2073 656c 662e 5f68 6173 5f77  s in self._has_w
-00006e60: 6861 743a 0a20 2020 2020 2020 2020 2020  hat:.           
-00006e70: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
-00006e80: 6e62 7974 6573 203d 2074 732e 6765 745f  nbytes = ts.get_
-00006e90: 6e62 7974 6573 2829 0a20 2020 2020 2020  nbytes().       
-00006ea0: 2069 6620 7473 2069 6e20 7365 6c66 2e6e   if ts in self.n
-00006eb0: 6565 6473 5f77 6861 743a 0a20 2020 2020  eeds_what:.     
-00006ec0: 2020 2020 2020 2064 656c 2073 656c 662e         del self.
-00006ed0: 6e65 6564 735f 7768 6174 5b74 735d 0a20  needs_what[ts]. 
-00006ee0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00006ef0: 5f6e 6574 776f 726b 5f6f 6363 202d 3d20  _network_occ -= 
-00006f00: 6e62 7974 6573 0a20 2020 2020 2020 2020  nbytes.         
-00006f10: 2020 2073 656c 662e 7363 6865 6475 6c65     self.schedule
-00006f20: 722e 5f6e 6574 776f 726b 5f6f 6363 5f67  r._network_occ_g
-00006f30: 6c6f 6261 6c20 2d3d 206e 6279 7465 730a  lobal -= nbytes.
-00006f40: 2020 2020 2020 2020 7473 2e77 686f 5f68          ts.who_h
-00006f50: 6173 2e61 6464 2873 656c 6629 0a20 2020  as.add(self).   
-00006f60: 2020 2020 2073 656c 662e 6e62 7974 6573       self.nbytes
-00006f70: 202b 3d20 6e62 7974 6573 0a20 2020 2020   += nbytes.     
-00006f80: 2020 2073 656c 662e 5f68 6173 5f77 6861     self._has_wha
-00006f90: 745b 7473 5d20 3d20 4e6f 6e65 0a0a 2020  t[ts] = None..  
-00006fa0: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
-00006fb0: 6465 6620 6f63 6375 7061 6e63 7928 7365  def occupancy(se
-00006fc0: 6c66 2920 2d3e 2066 6c6f 6174 3a0a 2020  lf) -> float:.  
-00006fd0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-00006fe0: 662e 5f6f 6363 7570 616e 6379 5f63 6163  f._occupancy_cac
-00006ff0: 6865 206f 7220 7365 6c66 2e73 6368 6564  he or self.sched
-00007000: 756c 6572 2e5f 6361 6c63 5f6f 6363 7570  uler._calc_occup
-00007010: 616e 6379 280a 2020 2020 2020 2020 2020  ancy(.          
-00007020: 2020 7365 6c66 2e74 6173 6b5f 7072 6566    self.task_pref
-00007030: 6978 5f63 6f75 6e74 2c20 7365 6c66 2e5f  ix_count, self._
-00007040: 6e65 7477 6f72 6b5f 6f63 630a 2020 2020  network_occ.    
-00007050: 2020 2020 290a 0a0a 4064 6174 6163 6c61      )...@datacla
-00007060: 7373 6573 2e64 6174 6163 6c61 7373 0a63  sses.dataclass.c
-00007070: 6c61 7373 2045 7272 6564 5461 736b 3a0a  lass ErredTask:.
-00007080: 2020 2020 2222 224c 6967 6874 7765 6967      """Lightweig
-00007090: 6874 2072 6570 7265 7365 6e74 6174 696f  ht representatio
-000070a0: 6e20 6f66 2061 6e20 6572 7265 6420 7461  n of an erred ta
-000070b0: 736b 2077 6974 686f 7574 2061 6e79 2064  sk without any d
-000070c0: 6570 656e 6465 6e63 7920 696e 666f 726d  ependency inform
-000070d0: 6174 696f 6e0a 2020 2020 6f72 2072 756e  ation.    or run
-000070e0: 7370 6563 2e0a 0a20 2020 2053 6565 2061  spec...    See a
-000070f0: 6c73 6f0a 2020 2020 2d2d 2d2d 2d2d 2d2d  lso.    --------
-00007100: 0a20 2020 2054 6173 6b53 7461 7465 0a20  .    TaskState. 
-00007110: 2020 2022 2222 0a0a 2020 2020 6b65 793a     """..    key:
-00007120: 2048 6173 6861 626c 650a 2020 2020 7469   Hashable.    ti
-00007130: 6d65 7374 616d 703a 2066 6c6f 6174 0a20  mestamp: float. 
-00007140: 2020 2065 7272 6564 5f6f 6e3a 2073 6574     erred_on: set
-00007150: 5b73 7472 5d0a 2020 2020 6578 6365 7074  [str].    except
-00007160: 696f 6e5f 7465 7874 3a20 7374 720a 2020  ion_text: str.  
-00007170: 2020 7472 6163 6562 6163 6b5f 7465 7874    traceback_text
-00007180: 3a20 7374 720a 0a0a 636c 6173 7320 436f  : str...class Co
-00007190: 6d70 7574 6174 696f 6e3a 0a20 2020 2022  mputation:.    "
-000071a0: 2222 436f 6c6c 6563 7469 6f6e 2074 7261  ""Collection tra
-000071b0: 636b 696e 6720 6120 7369 6e67 6c65 2063  cking a single c
-000071c0: 6f6d 7075 7465 206f 7220 7065 7273 6973  ompute or persis
-000071d0: 7420 6361 6c6c 0a0a 2020 2020 4445 5052  t call..    DEPR
-000071e0: 4543 4154 4544 3a20 706c 6561 7365 2075  ECATED: please u
-000071f0: 7365 2073 7061 6e73 2069 6e73 7465 6164  se spans instead
-00007200: 0a0a 2020 2020 5365 6520 616c 736f 0a20  ..    See also. 
-00007210: 2020 202d 2d2d 2d2d 2d2d 2d0a 2020 2020     --------.    
-00007220: 5461 736b 5072 6566 6978 0a20 2020 2054  TaskPrefix.    T
-00007230: 6173 6b47 726f 7570 0a20 2020 2054 6173  askGroup.    Tas
-00007240: 6b53 7461 7465 0a20 2020 2022 2222 0a0a  kState.    """..
-00007250: 2020 2020 7374 6172 743a 2066 6c6f 6174      start: float
-00007260: 0a20 2020 2067 726f 7570 733a 2073 6574  .    groups: set
-00007270: 5b54 6173 6b47 726f 7570 5d0a 2020 2020  [TaskGroup].    
-00007280: 636f 6465 3a20 536f 7274 6564 5365 745b  code: SortedSet[
-00007290: 7475 706c 655b 536f 7572 6365 436f 6465  tuple[SourceCode
-000072a0: 2c20 2e2e 2e5d 5d0a 2020 2020 6964 3a20  , ...]].    id: 
-000072b0: 7575 6964 2e55 5549 440a 2020 2020 616e  uuid.UUID.    an
-000072c0: 6e6f 7461 7469 6f6e 733a 2064 6963 740a  notations: dict.
-000072d0: 0a20 2020 205f 5f73 6c6f 7473 5f5f 203d  .    __slots__ =
-000072e0: 2074 7570 6c65 285f 5f61 6e6e 6f74 6174   tuple(__annotat
-000072f0: 696f 6e73 5f5f 290a 0a20 2020 2064 6566  ions__)..    def
-00007300: 205f 5f69 6e69 745f 5f28 7365 6c66 293a   __init__(self):
-00007310: 0a20 2020 2020 2020 2073 656c 662e 7374  .        self.st
-00007320: 6172 7420 3d20 7469 6d65 2829 0a20 2020  art = time().   
-00007330: 2020 2020 2073 656c 662e 6772 6f75 7073       self.groups
-00007340: 203d 2073 6574 2829 0a20 2020 2020 2020   = set().       
-00007350: 2073 656c 662e 636f 6465 203d 2053 6f72   self.code = Sor
-00007360: 7465 6453 6574 2829 0a20 2020 2020 2020  tedSet().       
-00007370: 2073 656c 662e 6964 203d 2075 7569 642e   self.id = uuid.
-00007380: 7575 6964 3428 290a 2020 2020 2020 2020  uuid4().        
-00007390: 7365 6c66 2e61 6e6e 6f74 6174 696f 6e73  self.annotations
-000073a0: 203d 207b 7d0a 0a20 2020 2040 7072 6f70   = {}..    @prop
-000073b0: 6572 7479 0a20 2020 2064 6566 2073 746f  erty.    def sto
-000073c0: 7028 7365 6c66 2920 2d3e 2066 6c6f 6174  p(self) -> float
-000073d0: 3a0a 2020 2020 2020 2020 6966 2073 656c  :.        if sel
-000073e0: 662e 6772 6f75 7073 3a0a 2020 2020 2020  f.groups:.      
-000073f0: 2020 2020 2020 7265 7475 726e 206d 6178        return max
-00007400: 2874 672e 7374 6f70 2066 6f72 2074 6720  (tg.stop for tg 
-00007410: 696e 2073 656c 662e 6772 6f75 7073 290a  in self.groups).
-00007420: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00007430: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00007440: 202d 310a 0a20 2020 2040 7072 6f70 6572   -1..    @proper
-00007450: 7479 0a20 2020 2064 6566 2073 7461 7465  ty.    def state
-00007460: 7328 7365 6c66 2920 2d3e 2064 6963 745b  s(self) -> dict[
-00007470: 5461 736b 5374 6174 6553 7461 7465 2c20  TaskStateState, 
-00007480: 696e 745d 3a0a 2020 2020 2020 2020 7265  int]:.        re
-00007490: 7475 726e 206d 6572 6765 5f77 6974 6828  turn merge_with(
-000074a0: 7375 6d2c 2028 7467 2e73 7461 7465 7320  sum, (tg.states 
-000074b0: 666f 7220 7467 2069 6e20 7365 6c66 2e67  for tg in self.g
-000074c0: 726f 7570 7329 290a 0a20 2020 2064 6566  roups))..    def
-000074d0: 205f 5f72 6570 725f 5f28 7365 6c66 2920   __repr__(self) 
-000074e0: 2d3e 2073 7472 3a0a 2020 2020 2020 2020  -> str:.        
-000074f0: 7265 7475 726e 2028 0a20 2020 2020 2020  return (.       
-00007500: 2020 2020 2066 223c 436f 6d70 7574 6174       f"<Computat
-00007510: 696f 6e20 7b73 656c 662e 6964 7d3a 2022  ion {self.id}: "
-00007520: 0a20 2020 2020 2020 2020 2020 202b 2022  .            + "
-00007530: 5461 736b 733a 2022 0a20 2020 2020 2020  Tasks: ".       
-00007540: 2020 2020 202b 2022 2c20 222e 6a6f 696e       + ", ".join
-00007550: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00007560: 2020 2225 733a 2025 6422 2025 2028 6b2c    "%s: %d" % (k,
-00007570: 2076 2920 666f 7220 286b 2c20 7629 2069   v) for (k, v) i
-00007580: 6e20 736f 7274 6564 2873 656c 662e 7374  n sorted(self.st
-00007590: 6174 6573 2e69 7465 6d73 2829 2920 6966  ates.items()) if
-000075a0: 2076 0a20 2020 2020 2020 2020 2020 2029   v.            )
-000075b0: 0a20 2020 2020 2020 2020 2020 202b 2022  .            + "
-000075c0: 3e22 0a20 2020 2020 2020 2029 0a0a 2020  >".        )..  
-000075d0: 2020 6465 6620 5f72 6570 725f 6874 6d6c    def _repr_html
-000075e0: 5f28 7365 6c66 2920 2d3e 2073 7472 3a0a  _(self) -> str:.
-000075f0: 2020 2020 2020 2020 7265 7475 726e 2067          return g
-00007600: 6574 5f74 656d 706c 6174 6528 2263 6f6d  et_template("com
-00007610: 7075 7461 7469 6f6e 2e68 746d 6c2e 6a32  putation.html.j2
-00007620: 2229 2e72 656e 6465 7228 0a20 2020 2020  ").render(.     
-00007630: 2020 2020 2020 2069 643d 7365 6c66 2e69         id=self.i
-00007640: 642c 0a20 2020 2020 2020 2020 2020 2073  d,.            s
-00007650: 7461 7274 3d73 656c 662e 7374 6172 742c  tart=self.start,
-00007660: 0a20 2020 2020 2020 2020 2020 2073 746f  .            sto
-00007670: 703d 7365 6c66 2e73 746f 702c 0a20 2020  p=self.stop,.   
-00007680: 2020 2020 2020 2020 2067 726f 7570 733d           groups=
-00007690: 7365 6c66 2e67 726f 7570 732c 0a20 2020  self.groups,.   
-000076a0: 2020 2020 2020 2020 2073 7461 7465 733d           states=
-000076b0: 7365 6c66 2e73 7461 7465 732c 0a20 2020  self.states,.   
-000076c0: 2020 2020 2020 2020 2063 6f64 653d 7365           code=se
-000076d0: 6c66 2e63 6f64 652c 0a20 2020 2020 2020  lf.code,.       
-000076e0: 2029 0a0a 0a63 6c61 7373 2054 6173 6b50   )...class TaskP
-000076f0: 7265 6669 783a 0a20 2020 2022 2222 436f  refix:.    """Co
-00007700: 6c6c 6563 7469 6f6e 2074 7261 636b 696e  llection trackin
-00007710: 6720 616c 6c20 7461 736b 7320 7769 7468  g all tasks with
-00007720: 696e 2061 2067 726f 7570 0a0a 2020 2020  in a group..    
-00007730: 4b65 7973 206f 6674 656e 2068 6176 6520  Keys often have 
-00007740: 6120 7374 7275 6374 7572 6520 6c69 6b65  a structure like
-00007750: 2060 6028 2278 2d31 3233 222c 2030 2960   ``("x-123", 0)`
-00007760: 600a 2020 2020 4120 6772 6f75 7020 7461  `.    A group ta
-00007770: 6b65 7320 7468 6520 6669 7273 7420 7365  kes the first se
-00007780: 6374 696f 6e2c 206c 696b 6520 6060 2278  ction, like ``"x
-00007790: 2260 600a 0a20 2020 2053 6565 2041 6c73  "``..    See Als
-000077a0: 6f0a 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20  o.    --------. 
-000077b0: 2020 2054 6173 6b47 726f 7570 0a20 2020     TaskGroup.   
-000077c0: 2022 2222 0a0a 2020 2020 233a 2054 6865   """..    #: The
-000077d0: 206e 616d 6520 6f66 2061 2067 726f 7570   name of a group
-000077e0: 206f 6620 7461 736b 732e 0a20 2020 2023   of tasks..    #
-000077f0: 3a20 466f 7220 6120 7461 736b 206c 696b  : For a task lik
-00007800: 6520 6060 2822 782d 3132 3322 2c20 3029  e ``("x-123", 0)
-00007810: 6060 2074 6869 7320 6973 2074 6865 2074  `` this is the t
-00007820: 6578 7420 6060 2278 2260 600a 2020 2020  ext ``"x"``.    
-00007830: 6e61 6d65 3a20 7374 720a 0a20 2020 2023  name: str..    #
-00007840: 3a20 416e 2065 7870 6f6e 656e 7469 616c  : An exponential
-00007850: 6c79 2077 6569 6768 7465 6420 6d6f 7669  ly weighted movi
-00007860: 6e67 2061 7665 7261 6765 2064 7572 6174  ng average durat
-00007870: 696f 6e20 6f66 2061 6c6c 2074 6173 6b73  ion of all tasks
-00007880: 2077 6974 6820 7468 6973 2070 7265 6669   with this prefi
-00007890: 780a 2020 2020 6475 7261 7469 6f6e 5f61  x.    duration_a
-000078a0: 7665 7261 6765 3a20 666c 6f61 740a 0a20  verage: float.. 
-000078b0: 2020 2023 3a20 4e75 6d62 6572 7320 6f66     #: Numbers of
-000078c0: 2074 696d 6573 2061 2074 6173 6b20 7761   times a task wa
-000078d0: 7320 6d61 726b 6564 2061 7320 7375 7370  s marked as susp
-000078e0: 6963 696f 7573 2077 6974 6820 7468 6973  icious with this
-000078f0: 2070 7265 6669 780a 2020 2020 7375 7370   prefix.    susp
-00007900: 6963 696f 7573 3a20 696e 740a 0a20 2020  icious: int..   
-00007910: 2023 3a20 5374 6f72 6520 7469 6d69 6e67   #: Store timing
-00007920: 7320 666f 7220 6561 6368 2070 7265 6669  s for each prefi
-00007930: 782d 6163 7469 6f6e 0a20 2020 2061 6c6c  x-action.    all
-00007940: 5f64 7572 6174 696f 6e73 3a20 6465 6661  _durations: defa
-00007950: 756c 7464 6963 745b 7374 722c 2066 6c6f  ultdict[str, flo
-00007960: 6174 5d0a 0a20 2020 2023 3a20 5468 6973  at]..    #: This
-00007970: 206d 6561 7375 7265 7320 7468 6520 6d61   measures the ma
-00007980: 7869 6d75 6d20 7265 636f 7264 6564 206c  ximum recorded l
-00007990: 6976 6520 6578 6563 7574 696f 6e20 7469  ive execution ti
-000079a0: 6d65 2061 6e64 2063 616e 2062 6520 7573  me and can be us
-000079b0: 6564 2074 6f0a 2020 2020 233a 2064 6574  ed to.    #: det
-000079c0: 6563 7420 6f75 746c 6965 7273 0a20 2020  ect outliers.   
-000079d0: 206d 6178 5f65 7865 635f 7469 6d65 3a20   max_exec_time: 
-000079e0: 666c 6f61 740a 0a20 2020 2023 3a20 5461  float..    #: Ta
-000079f0: 736b 2067 726f 7570 7320 6173 736f 6369  sk groups associ
-00007a00: 6174 6564 2074 6f20 7468 6973 2070 7265  ated to this pre
-00007a10: 6669 780a 2020 2020 6772 6f75 7073 3a20  fix.    groups: 
-00007a20: 6c69 7374 5b54 6173 6b47 726f 7570 5d0a  list[TaskGroup].
-00007a30: 0a20 2020 2023 3a20 4163 6375 6d75 6c61  .    #: Accumula
-00007a40: 7465 2063 6f75 6e74 206f 6620 6e75 6d62  te count of numb
-00007a50: 6572 206f 6620 7461 736b 7320 696e 2065  er of tasks in e
-00007a60: 6163 6820 7374 6174 650a 2020 2020 7374  ach state.    st
-00007a70: 6174 655f 636f 756e 7473 3a20 6465 6661  ate_counts: defa
-00007a80: 756c 7464 6963 745b 5461 736b 5374 6174  ultdict[TaskStat
-00007a90: 6553 7461 7465 2c20 696e 745d 0a0a 2020  eState, int]..  
-00007aa0: 2020 5f5f 736c 6f74 735f 5f20 3d20 7475    __slots__ = tu
-00007ab0: 706c 6528 5f5f 616e 6e6f 7461 7469 6f6e  ple(__annotation
-00007ac0: 735f 5f29 0a0a 2020 2020 6465 6620 5f5f  s__)..    def __
-00007ad0: 696e 6974 5f5f 2873 656c 662c 206e 616d  init__(self, nam
-00007ae0: 653a 2073 7472 293a 0a20 2020 2020 2020  e: str):.       
-00007af0: 2073 656c 662e 6e61 6d65 203d 206e 616d   self.name = nam
-00007b00: 650a 2020 2020 2020 2020 7365 6c66 2e67  e.        self.g
-00007b10: 726f 7570 7320 3d20 5b5d 0a20 2020 2020  roups = [].     
-00007b20: 2020 2073 656c 662e 616c 6c5f 6475 7261     self.all_dura
-00007b30: 7469 6f6e 7320 3d20 6465 6661 756c 7464  tions = defaultd
-00007b40: 6963 7428 666c 6f61 7429 0a20 2020 2020  ict(float).     
-00007b50: 2020 2073 656c 662e 7374 6174 655f 636f     self.state_co
-00007b60: 756e 7473 203d 2064 6566 6175 6c74 6469  unts = defaultdi
-00007b70: 6374 2869 6e74 290a 2020 2020 2020 2020  ct(int).        
-00007b80: 7461 736b 5f64 7572 6174 696f 6e73 203d  task_durations =
-00007b90: 2064 6173 6b2e 636f 6e66 6967 2e67 6574   dask.config.get
-00007ba0: 2822 6469 7374 7269 6275 7465 642e 7363  ("distributed.sc
-00007bb0: 6865 6475 6c65 722e 6465 6661 756c 742d  heduler.default-
-00007bc0: 7461 736b 2d64 7572 6174 696f 6e73 2229  task-durations")
-00007bd0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00007be0: 2e6e 616d 6520 696e 2074 6173 6b5f 6475  .name in task_du
-00007bf0: 7261 7469 6f6e 733a 0a20 2020 2020 2020  rations:.       
-00007c00: 2020 2020 2073 656c 662e 6475 7261 7469       self.durati
-00007c10: 6f6e 5f61 7665 7261 6765 203d 2070 6172  on_average = par
-00007c20: 7365 5f74 696d 6564 656c 7461 2874 6173  se_timedelta(tas
-00007c30: 6b5f 6475 7261 7469 6f6e 735b 7365 6c66  k_durations[self
-00007c40: 2e6e 616d 655d 290a 2020 2020 2020 2020  .name]).        
-00007c50: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00007c60: 2020 7365 6c66 2e64 7572 6174 696f 6e5f    self.duration_
-00007c70: 6176 6572 6167 6520 3d20 2d31 0a20 2020  average = -1.   
-00007c80: 2020 2020 2073 656c 662e 6d61 785f 6578       self.max_ex
-00007c90: 6563 5f74 696d 6520 3d20 2d31 0a20 2020  ec_time = -1.   
-00007ca0: 2020 2020 2073 656c 662e 7375 7370 6963       self.suspic
-00007cb0: 696f 7573 203d 2030 0a0a 2020 2020 6465  ious = 0..    de
-00007cc0: 6620 6164 645f 6578 6563 5f74 696d 6528  f add_exec_time(
-00007cd0: 7365 6c66 2c20 6475 7261 7469 6f6e 3a20  self, duration: 
-00007ce0: 666c 6f61 7429 202d 3e20 4e6f 6e65 3a0a  float) -> None:.
-00007cf0: 2020 2020 2020 2020 7365 6c66 2e6d 6178          self.max
-00007d00: 5f65 7865 635f 7469 6d65 203d 206d 6178  _exec_time = max
-00007d10: 2864 7572 6174 696f 6e2c 2073 656c 662e  (duration, self.
-00007d20: 6d61 785f 6578 6563 5f74 696d 6529 0a20  max_exec_time). 
-00007d30: 2020 2020 2020 2069 6620 6475 7261 7469         if durati
-00007d40: 6f6e 203e 2032 202a 2073 656c 662e 6475  on > 2 * self.du
-00007d50: 7261 7469 6f6e 5f61 7665 7261 6765 3a0a  ration_average:.
-00007d60: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00007d70: 2e64 7572 6174 696f 6e5f 6176 6572 6167  .duration_averag
-00007d80: 6520 3d20 2d31 0a0a 2020 2020 6465 6620  e = -1..    def 
-00007d90: 6164 645f 6475 7261 7469 6f6e 2873 656c  add_duration(sel
-00007da0: 662c 2061 6374 696f 6e3a 2073 7472 2c20  f, action: str, 
-00007db0: 7374 6172 743a 2066 6c6f 6174 2c20 7374  start: float, st
-00007dc0: 6f70 3a20 666c 6f61 7429 202d 3e20 4e6f  op: float) -> No
-00007dd0: 6e65 3a0a 2020 2020 2020 2020 6475 7261  ne:.        dura
-00007de0: 7469 6f6e 203d 2073 746f 7020 2d20 7374  tion = stop - st
-00007df0: 6172 740a 2020 2020 2020 2020 7365 6c66  art.        self
-00007e00: 2e61 6c6c 5f64 7572 6174 696f 6e73 5b61  .all_durations[a
-00007e10: 6374 696f 6e5d 202b 3d20 6475 7261 7469  ction] += durati
-00007e20: 6f6e 0a20 2020 2020 2020 2069 6620 6163  on.        if ac
-00007e30: 7469 6f6e 203d 3d20 2263 6f6d 7075 7465  tion == "compute
-00007e40: 223a 0a20 2020 2020 2020 2020 2020 206f  ":.            o
-00007e50: 6c64 203d 2073 656c 662e 6475 7261 7469  ld = self.durati
-00007e60: 6f6e 5f61 7665 7261 6765 0a20 2020 2020  on_average.     
-00007e70: 2020 2020 2020 2069 6620 6f6c 6420 3c20         if old < 
-00007e80: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
-00007e90: 2020 2073 656c 662e 6475 7261 7469 6f6e     self.duration
-00007ea0: 5f61 7665 7261 6765 203d 2064 7572 6174  _average = durat
-00007eb0: 696f 6e0a 2020 2020 2020 2020 2020 2020  ion.            
-00007ec0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00007ed0: 2020 2020 2020 7365 6c66 2e64 7572 6174        self.durat
-00007ee0: 696f 6e5f 6176 6572 6167 6520 3d20 302e  ion_average = 0.
-00007ef0: 3520 2a20 6475 7261 7469 6f6e 202b 2030  5 * duration + 0
-00007f00: 2e35 202a 206f 6c64 0a0a 2020 2020 4070  .5 * old..    @p
-00007f10: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
-00007f20: 7374 6174 6573 2873 656c 6629 202d 3e20  states(self) -> 
-00007f30: 6469 6374 5b54 6173 6b53 7461 7465 5374  dict[TaskStateSt
-00007f40: 6174 652c 2069 6e74 5d3a 0a20 2020 2020  ate, int]:.     
-00007f50: 2020 2022 2222 5468 6520 6e75 6d62 6572     """The number
-00007f60: 206f 6620 7461 736b 7320 696e 2065 6163   of tasks in eac
-00007f70: 6820 7374 6174 652c 0a20 2020 2020 2020  h state,.       
-00007f80: 206c 696b 6520 6060 7b22 6d65 6d6f 7279   like ``{"memory
-00007f90: 223a 2031 302c 2022 7072 6f63 6573 7369  ": 10, "processi
-00007fa0: 6e67 223a 2033 2c20 2272 656c 6561 7365  ng": 3, "release
-00007fb0: 6422 3a20 342c 202e 2e2e 7d60 600a 2020  d": 4, ...}``.  
-00007fc0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00007fd0: 2020 7265 7475 726e 206d 6572 6765 5f77    return merge_w
-00007fe0: 6974 6828 7375 6d2c 205b 7467 2e73 7461  ith(sum, [tg.sta
-00007ff0: 7465 7320 666f 7220 7467 2069 6e20 7365  tes for tg in se
-00008000: 6c66 2e67 726f 7570 735d 290a 0a20 2020  lf.groups])..   
-00008010: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
-00008020: 6566 2061 6374 6976 6528 7365 6c66 2920  ef active(self) 
-00008030: 2d3e 206c 6973 745b 5461 736b 4772 6f75  -> list[TaskGrou
-00008040: 705d 3a0a 2020 2020 2020 2020 7265 7475  p]:.        retu
-00008050: 726e 205b 0a20 2020 2020 2020 2020 2020  rn [.           
-00008060: 2074 670a 2020 2020 2020 2020 2020 2020   tg.            
-00008070: 666f 7220 7467 2069 6e20 7365 6c66 2e67  for tg in self.g
-00008080: 726f 7570 730a 2020 2020 2020 2020 2020  roups.          
-00008090: 2020 6966 2061 6e79 286b 2021 3d20 2266    if any(k != "f
-000080a0: 6f72 676f 7474 656e 2220 616e 6420 7620  orgotten" and v 
-000080b0: 213d 2030 2066 6f72 206b 2c20 7620 696e  != 0 for k, v in
-000080c0: 2074 672e 7374 6174 6573 2e69 7465 6d73   tg.states.items
-000080d0: 2829 290a 2020 2020 2020 2020 5d0a 0a20  ()).        ].. 
-000080e0: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
-000080f0: 2064 6566 2061 6374 6976 655f 7374 6174   def active_stat
-00008100: 6573 2873 656c 6629 202d 3e20 6469 6374  es(self) -> dict
-00008110: 5b54 6173 6b53 7461 7465 5374 6174 652c  [TaskStateState,
-00008120: 2069 6e74 5d3a 0a20 2020 2020 2020 2072   int]:.        r
-00008130: 6574 7572 6e20 6d65 7267 655f 7769 7468  eturn merge_with
-00008140: 2873 756d 2c20 5b74 672e 7374 6174 6573  (sum, [tg.states
-00008150: 2066 6f72 2074 6720 696e 2073 656c 662e   for tg in self.
-00008160: 6163 7469 7665 5d29 0a0a 2020 2020 6465  active])..    de
-00008170: 6620 5f5f 7265 7072 5f5f 2873 656c 6629  f __repr__(self)
-00008180: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
-00008190: 2072 6574 7572 6e20 280a 2020 2020 2020   return (.      
-000081a0: 2020 2020 2020 223c 220a 2020 2020 2020        "<".      
-000081b0: 2020 2020 2020 2b20 7365 6c66 2e6e 616d        + self.nam
-000081c0: 650a 2020 2020 2020 2020 2020 2020 2b20  e.            + 
-000081d0: 223a 2022 0a20 2020 2020 2020 2020 2020  ": ".           
-000081e0: 202b 2022 2c20 222e 6a6f 696e 280a 2020   + ", ".join(.  
-000081f0: 2020 2020 2020 2020 2020 2020 2020 2225                "%
-00008200: 733a 2025 6422 2025 2028 6b2c 2076 2920  s: %d" % (k, v) 
-00008210: 666f 7220 286b 2c20 7629 2069 6e20 736f  for (k, v) in so
-00008220: 7274 6564 2873 656c 662e 7374 6174 6573  rted(self.states
-00008230: 2e69 7465 6d73 2829 2920 6966 2076 0a20  .items()) if v. 
-00008240: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00008250: 2020 2020 2020 2020 202b 2022 3e22 0a20           + ">". 
-00008260: 2020 2020 2020 2029 0a0a 2020 2020 4070         )..    @p
-00008270: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
-00008280: 6e62 7974 6573 5f74 6f74 616c 2873 656c  nbytes_total(sel
-00008290: 6629 202d 3e20 696e 743a 0a20 2020 2020  f) -> int:.     
-000082a0: 2020 2072 6574 7572 6e20 7375 6d28 7467     return sum(tg
-000082b0: 2e6e 6279 7465 735f 746f 7461 6c20 666f  .nbytes_total fo
-000082c0: 7220 7467 2069 6e20 7365 6c66 2e67 726f  r tg in self.gro
-000082d0: 7570 7329 0a0a 2020 2020 6465 6620 5f5f  ups)..    def __
-000082e0: 6c65 6e5f 5f28 7365 6c66 2920 2d3e 2069  len__(self) -> i
-000082f0: 6e74 3a0a 2020 2020 2020 2020 7265 7475  nt:.        retu
-00008300: 726e 2073 756d 286d 6170 286c 656e 2c20  rn sum(map(len, 
-00008310: 7365 6c66 2e67 726f 7570 7329 290a 0a20  self.groups)).. 
-00008320: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
-00008330: 2064 6566 2064 7572 6174 696f 6e28 7365   def duration(se
-00008340: 6c66 2920 2d3e 2066 6c6f 6174 3a0a 2020  lf) -> float:.  
-00008350: 2020 2020 2020 7265 7475 726e 2073 756d        return sum
-00008360: 2874 672e 6475 7261 7469 6f6e 2066 6f72  (tg.duration for
-00008370: 2074 6720 696e 2073 656c 662e 6772 6f75   tg in self.grou
-00008380: 7073 290a 0a20 2020 2040 7072 6f70 6572  ps)..    @proper
-00008390: 7479 0a20 2020 2064 6566 2074 7970 6573  ty.    def types
-000083a0: 2873 656c 6629 202d 3e20 7365 745b 7374  (self) -> set[st
-000083b0: 725d 3a0a 2020 2020 2020 2020 7265 7475  r]:.        retu
-000083c0: 726e 207b 7479 7020 666f 7220 7467 2069  rn {typ for tg i
-000083d0: 6e20 7365 6c66 2e67 726f 7570 7320 666f  n self.groups fo
-000083e0: 7220 7479 7020 696e 2074 672e 7479 7065  r typ in tg.type
-000083f0: 737d 0a0a 0a63 6c61 7373 2054 6173 6b47  s}...class TaskG
-00008400: 726f 7570 3a0a 2020 2020 2222 2243 6f6c  roup:.    """Col
-00008410: 6c65 6374 696f 6e20 7472 6163 6b69 6e67  lection tracking
-00008420: 2061 6c6c 2074 6173 6b73 2077 6974 6869   all tasks withi
-00008430: 6e20 6120 6772 6f75 700a 0a20 2020 204b  n a group..    K
-00008440: 6579 7320 6f66 7465 6e20 6861 7665 2061  eys often have a
-00008450: 2073 7472 7563 7475 7265 206c 696b 6520   structure like 
-00008460: 6060 2822 782d 3132 3322 2c20 3029 6060  ``("x-123", 0)``
-00008470: 0a20 2020 2041 2067 726f 7570 2074 616b  .    A group tak
-00008480: 6573 2074 6865 2066 6972 7374 2073 6563  es the first sec
-00008490: 7469 6f6e 2c20 6c69 6b65 2060 6022 782d  tion, like ``"x-
-000084a0: 3132 3322 6060 0a0a 2020 2020 5365 6520  123"``..    See 
-000084b0: 616c 736f 0a20 2020 202d 2d2d 2d2d 2d2d  also.    -------
-000084c0: 2d0a 2020 2020 5461 736b 5072 6566 6978  -.    TaskPrefix
-000084d0: 0a20 2020 2022 2222 0a0a 2020 2020 233a  .    """..    #:
-000084e0: 2054 6865 206e 616d 6520 6f66 2061 2067   The name of a g
-000084f0: 726f 7570 206f 6620 7461 736b 732e 0a20  roup of tasks.. 
-00008500: 2020 2023 3a20 466f 7220 6120 7461 736b     #: For a task
-00008510: 206c 696b 6520 6060 2822 782d 3132 3322   like ``("x-123"
-00008520: 2c20 3029 6060 2074 6869 7320 6973 2074  , 0)`` this is t
-00008530: 6865 2074 6578 7420 6060 2278 2d31 3233  he text ``"x-123
-00008540: 2260 600a 2020 2020 6e61 6d65 3a20 7374  "``.    name: st
-00008550: 720a 0a20 2020 2023 3a20 5468 6520 6e75  r..    #: The nu
-00008560: 6d62 6572 206f 6620 7461 736b 7320 696e  mber of tasks in
-00008570: 2065 6163 6820 7374 6174 652c 0a20 2020   each state,.   
-00008580: 2023 3a20 6c69 6b65 2060 607b 226d 656d   #: like ``{"mem
-00008590: 6f72 7922 3a20 3130 2c20 2270 726f 6365  ory": 10, "proce
-000085a0: 7373 696e 6722 3a20 332c 2022 7265 6c65  ssing": 3, "rele
-000085b0: 6173 6564 223a 2034 2c20 2e2e 2e7d 6060  ased": 4, ...}``
-000085c0: 0a20 2020 2073 7461 7465 733a 2064 6963  .    states: dic
-000085d0: 745b 5461 736b 5374 6174 6553 7461 7465  t[TaskStateState
-000085e0: 2c20 696e 745d 0a0a 2020 2020 233a 2054  , int]..    #: T
-000085f0: 6865 206f 7468 6572 2054 6173 6b47 726f  he other TaskGro
-00008600: 7570 7320 6f6e 2077 6869 6368 2074 6869  ups on which thi
-00008610: 7320 6f6e 6520 6465 7065 6e64 730a 2020  s one depends.  
-00008620: 2020 6465 7065 6e64 656e 6369 6573 3a20    dependencies: 
-00008630: 7365 745b 5461 736b 4772 6f75 705d 0a0a  set[TaskGroup]..
-00008640: 2020 2020 233a 2054 6865 2074 6f74 616c      #: The total
-00008650: 206e 756d 6265 7220 6f66 2062 7974 6573   number of bytes
-00008660: 2074 6861 7420 7468 6973 2074 6173 6b20   that this task 
-00008670: 6772 6f75 7020 6861 7320 7072 6f64 7563  group has produc
-00008680: 6564 0a20 2020 206e 6279 7465 735f 746f  ed.    nbytes_to
-00008690: 7461 6c3a 2069 6e74 0a0a 2020 2020 233a  tal: int..    #:
-000086a0: 2054 6865 2074 6f74 616c 2061 6d6f 756e   The total amoun
-000086b0: 7420 6f66 2074 696d 6520 7370 656e 7420  t of time spent 
-000086c0: 6f6e 2061 6c6c 2074 6173 6b73 2069 6e20  on all tasks in 
-000086d0: 7468 6973 2054 6173 6b47 726f 7570 0a20  this TaskGroup. 
-000086e0: 2020 2064 7572 6174 696f 6e3a 2066 6c6f     duration: flo
-000086f0: 6174 0a0a 2020 2020 233a 2054 6865 2072  at..    #: The r
-00008700: 6573 756c 7420 7479 7065 7320 6f66 2074  esult types of t
-00008710: 6869 7320 5461 736b 4772 6f75 700a 2020  his TaskGroup.  
-00008720: 2020 7479 7065 733a 2073 6574 5b73 7472    types: set[str
-00008730: 5d0a 0a20 2020 2023 3a20 5468 6520 776f  ]..    #: The wo
-00008740: 726b 6572 206d 6f73 7420 7265 6365 6e74  rker most recent
-00008750: 6c79 2061 7373 6967 6e65 6420 6120 7461  ly assigned a ta
-00008760: 736b 2066 726f 6d20 7468 6973 2067 726f  sk from this gro
-00008770: 7570 2c20 6f72 204e 6f6e 6520 7768 656e  up, or None when
-00008780: 2074 6865 2067 726f 7570 0a20 2020 2023   the group.    #
-00008790: 3a20 6973 206e 6f74 2069 6465 6e74 6966  : is not identif
-000087a0: 6965 6420 746f 2062 6520 726f 6f74 2d6c  ied to be root-l
-000087b0: 696b 6520 6279 2060 5363 6865 6475 6c65  ike by `Schedule
-000087c0: 7253 7461 7465 2e64 6563 6964 655f 776f  rState.decide_wo
-000087d0: 726b 6572 602e 0a20 2020 206c 6173 745f  rker`..    last_
-000087e0: 776f 726b 6572 3a20 576f 726b 6572 5374  worker: WorkerSt
-000087f0: 6174 6520 7c20 4e6f 6e65 0a0a 2020 2020  ate | None..    
-00008800: 233a 2049 6620 606c 6173 745f 776f 726b  #: If `last_work
-00008810: 6572 6020 6973 206e 6f74 204e 6f6e 652c  er` is not None,
-00008820: 2074 6865 206e 756d 6265 7220 6f66 2074   the number of t
-00008830: 696d 6573 2074 6861 7420 776f 726b 6572  imes that worker
-00008840: 2073 686f 756c 6420 6265 2061 7373 6967   should be assig
-00008850: 6e65 640a 2020 2020 233a 2073 7562 7365  ned.    #: subse
-00008860: 7175 656e 7420 7461 736b 7320 756e 7469  quent tasks unti
-00008870: 6c20 6120 6e65 7720 776f 726b 6572 2069  l a new worker i
-00008880: 7320 6368 6f73 656e 2e0a 2020 2020 6c61  s chosen..    la
-00008890: 7374 5f77 6f72 6b65 725f 7461 736b 735f  st_worker_tasks_
-000088a0: 6c65 6674 3a20 696e 740a 0a20 2020 2070  left: int..    p
-000088b0: 7265 6669 783a 2054 6173 6b50 7265 6669  refix: TaskPrefi
-000088c0: 7820 7c20 4e6f 6e65 0a0a 2020 2020 233a  x | None..    #:
-000088d0: 2045 6172 6c69 6573 7420 7469 6d65 2077   Earliest time w
-000088e0: 6865 6e20 6120 7461 736b 2062 656c 6f6e  hen a task belon
-000088f0: 6769 6e67 2074 6f20 7468 6973 2067 726f  ging to this gro
-00008900: 7570 2073 7461 7274 6564 2063 6f6d 7075  up started compu
-00008910: 7469 6e67 3b0a 2020 2020 233a 2030 2069  ting;.    #: 0 i
-00008920: 6620 6e6f 2074 6173 6b20 6861 7320 2a66  f no task has *f
-00008930: 696e 6973 6865 642a 2063 6f6d 7075 7469  inished* computi
-00008940: 6e67 2079 6574 0a20 2020 2023 3a0a 2020  ng yet.    #:.  
-00008950: 2020 233a 204e 6f74 6573 0a20 2020 2023    #: Notes.    #
-00008960: 3a20 2d2d 2d2d 2d0a 2020 2020 233a 2054  : -----.    #: T
-00008970: 6869 7320 6973 206e 6f74 2075 7064 6174  his is not updat
-00008980: 6564 2075 6e74 696c 2061 7420 6c65 6173  ed until at leas
-00008990: 7420 6f6e 6520 7461 736b 2068 6173 202a  t one task has *
-000089a0: 6669 6e69 7368 6564 2a20 636f 6d70 7574  finished* comput
-000089b0: 696e 672e 0a20 2020 2023 3a20 4974 2063  ing..    #: It c
-000089c0: 6f75 6c64 206d 6f76 6520 6261 636b 7761  ould move backwa
-000089d0: 7264 7320 6173 2074 6173 6b73 2063 6f6d  rds as tasks com
-000089e0: 706c 6574 652e 0a20 2020 2073 7461 7274  plete..    start
-000089f0: 3a20 666c 6f61 740a 0a20 2020 2023 3a20  : float..    #: 
-00008a00: 4c61 7465 7374 2074 696d 6520 7768 656e  Latest time when
-00008a10: 2061 2074 6173 6b20 6265 6c6f 6e67 696e   a task belongin
-00008a20: 6720 746f 2074 6869 7320 6772 6f75 7020  g to this group 
-00008a30: 6669 6e69 7368 6564 2063 6f6d 7075 7469  finished computi
-00008a40: 6e67 2c0a 2020 2020 233a 2030 2069 6620  ng,.    #: 0 if 
-00008a50: 6e6f 2074 6173 6b20 6861 7320 6669 6e69  no task has fini
-00008a60: 7368 6564 2063 6f6d 7075 7469 6e67 2079  shed computing y
-00008a70: 6574 0a20 2020 2073 746f 703a 2066 6c6f  et.    stop: flo
-00008a80: 6174 0a0a 2020 2020 233a 2043 756d 756c  at..    #: Cumul
-00008a90: 6174 6976 6520 6475 7261 7469 6f6e 206f  ative duration o
-00008aa0: 6620 616c 6c20 636f 6d70 6c65 7465 6420  f all completed 
-00008ab0: 6163 7469 6f6e 732c 2062 7920 6163 7469  actions, by acti
-00008ac0: 6f6e 0a20 2020 2061 6c6c 5f64 7572 6174  on.    all_durat
-00008ad0: 696f 6e73 3a20 6465 6661 756c 7464 6963  ions: defaultdic
-00008ae0: 745b 7374 722c 2066 6c6f 6174 5d0a 0a20  t[str, float].. 
-00008af0: 2020 2023 3a20 5370 616e 2049 4420 2873     #: Span ID (s
-00008b00: 6565 2060 6064 6973 7472 6962 7574 6564  ee ``distributed
-00008b10: 2e73 7061 6e73 6060 292e 0a20 2020 2023  .spans``)..    #
-00008b20: 3a20 4d61 7463 6865 7320 6060 6469 7374  : Matches ``dist
-00008b30: 7269 6275 7465 642e 776f 726b 6572 5f73  ributed.worker_s
-00008b40: 7461 7465 5f6d 6163 6869 6e65 2e54 6173  tate_machine.Tas
-00008b50: 6b53 7461 7465 2e73 7061 6e5f 6964 6060  kState.span_id``
-00008b60: 2e0a 2020 2020 233a 2049 7420 6973 2070  ..    #: It is p
-00008b70: 6f73 7369 626c 6520 746f 2065 6e64 2075  ossible to end u
-00008b80: 7020 696e 2073 6974 7561 7469 6f6e 2077  p in situation w
-00008b90: 6865 7265 2064 6966 6665 7265 6e74 2074  here different t
-00008ba0: 6173 6b73 206f 6620 7468 6520 7361 6d65  asks of the same
-00008bb0: 2054 6173 6b47 726f 7570 0a20 2020 2023   TaskGroup.    #
-00008bc0: 3a20 6265 6c6f 6e67 2074 6f20 6469 6666  : belong to diff
-00008bd0: 6572 656e 7420 7370 616e 733b 2074 6865  erent spans; the
-00008be0: 2070 7572 706f 7365 206f 6620 7468 6973   purpose of this
-00008bf0: 2061 7474 7269 6275 7465 2069 7320 746f   attribute is to
-00008c00: 2061 7262 6974 7261 7269 6c79 2066 6f72   arbitrarily for
-00008c10: 6365 0a20 2020 2023 3a20 6576 6572 7974  ce.    #: everyt
-00008c20: 6869 6e67 206f 6e74 6f20 7468 6520 6561  hing onto the ea
-00008c30: 726c 6965 7374 2065 6e63 6f75 6e74 6572  rliest encounter
-00008c40: 6564 206f 6e65 2e0a 2020 2020 7370 616e  ed one..    span
-00008c50: 5f69 643a 2073 7472 207c 204e 6f6e 650a  _id: str | None.
-00008c60: 0a20 2020 205f 5f73 6c6f 7473 5f5f 203d  .    __slots__ =
-00008c70: 2074 7570 6c65 285f 5f61 6e6e 6f74 6174   tuple(__annotat
-00008c80: 696f 6e73 5f5f 290a 0a20 2020 2064 6566  ions__)..    def
-00008c90: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
-00008ca0: 6e61 6d65 3a20 7374 7229 3a0a 2020 2020  name: str):.    
-00008cb0: 2020 2020 7365 6c66 2e6e 616d 6520 3d20      self.name = 
-00008cc0: 6e61 6d65 0a20 2020 2020 2020 2073 656c  name.        sel
-00008cd0: 662e 7072 6566 6978 203d 204e 6f6e 650a  f.prefix = None.
-00008ce0: 2020 2020 2020 2020 7365 6c66 2e73 7461          self.sta
-00008cf0: 7465 7320 3d20 6469 6374 2e66 726f 6d6b  tes = dict.fromk
-00008d00: 6579 7328 414c 4c5f 5441 534b 5f53 5441  eys(ALL_TASK_STA
-00008d10: 5445 532c 2030 290a 2020 2020 2020 2020  TES, 0).        
-00008d20: 7365 6c66 2e64 6570 656e 6465 6e63 6965  self.dependencie
-00008d30: 7320 3d20 7365 7428 290a 2020 2020 2020  s = set().      
-00008d40: 2020 7365 6c66 2e6e 6279 7465 735f 746f    self.nbytes_to
-00008d50: 7461 6c20 3d20 300a 2020 2020 2020 2020  tal = 0.        
-00008d60: 7365 6c66 2e64 7572 6174 696f 6e20 3d20  self.duration = 
-00008d70: 300a 2020 2020 2020 2020 7365 6c66 2e74  0.        self.t
-00008d80: 7970 6573 203d 2073 6574 2829 0a20 2020  ypes = set().   
-00008d90: 2020 2020 2073 656c 662e 7374 6172 7420       self.start 
-00008da0: 3d20 302e 300a 2020 2020 2020 2020 7365  = 0.0.        se
-00008db0: 6c66 2e73 746f 7020 3d20 302e 300a 2020  lf.stop = 0.0.  
-00008dc0: 2020 2020 2020 7365 6c66 2e61 6c6c 5f64        self.all_d
-00008dd0: 7572 6174 696f 6e73 203d 2064 6566 6175  urations = defau
-00008de0: 6c74 6469 6374 2866 6c6f 6174 290a 2020  ltdict(float).  
-00008df0: 2020 2020 2020 7365 6c66 2e6c 6173 745f        self.last_
-00008e00: 776f 726b 6572 203d 204e 6f6e 650a 2020  worker = None.  
-00008e10: 2020 2020 2020 7365 6c66 2e6c 6173 745f        self.last_
-00008e20: 776f 726b 6572 5f74 6173 6b73 5f6c 6566  worker_tasks_lef
-00008e30: 7420 3d20 300a 2020 2020 2020 2020 7365  t = 0.        se
-00008e40: 6c66 2e73 7061 6e5f 6964 203d 204e 6f6e  lf.span_id = Non
-00008e50: 650a 0a20 2020 2064 6566 2061 6464 5f64  e..    def add_d
-00008e60: 7572 6174 696f 6e28 7365 6c66 2c20 6163  uration(self, ac
-00008e70: 7469 6f6e 3a20 7374 722c 2073 7461 7274  tion: str, start
-00008e80: 3a20 666c 6f61 742c 2073 746f 703a 2066  : float, stop: f
-00008e90: 6c6f 6174 2920 2d3e 204e 6f6e 653a 0a20  loat) -> None:. 
-00008ea0: 2020 2020 2020 2064 7572 6174 696f 6e20         duration 
-00008eb0: 3d20 7374 6f70 202d 2073 7461 7274 0a20  = stop - start. 
-00008ec0: 2020 2020 2020 2073 656c 662e 6475 7261         self.dura
-00008ed0: 7469 6f6e 202b 3d20 6475 7261 7469 6f6e  tion += duration
-00008ee0: 0a20 2020 2020 2020 2073 656c 662e 616c  .        self.al
-00008ef0: 6c5f 6475 7261 7469 6f6e 735b 6163 7469  l_durations[acti
-00008f00: 6f6e 5d20 2b3d 2064 7572 6174 696f 6e0a  on] += duration.
-00008f10: 2020 2020 2020 2020 6966 2061 6374 696f          if actio
-00008f20: 6e20 3d3d 2022 636f 6d70 7574 6522 3a0a  n == "compute":.
-00008f30: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00008f40: 656c 662e 7374 6f70 203c 2073 746f 703a  elf.stop < stop:
-00008f50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008f60: 2073 656c 662e 7374 6f70 203d 2073 746f   self.stop = sto
-00008f70: 700a 2020 2020 2020 2020 2020 2020 6966  p.            if
-00008f80: 2073 656c 662e 7374 6172 7420 3d3d 2030   self.start == 0
-00008f90: 2e30 206f 7220 7365 6c66 2e73 7461 7274  .0 or self.start
-00008fa0: 203e 2073 7461 7274 3a0a 2020 2020 2020   > start:.      
-00008fb0: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
-00008fc0: 7461 7274 203d 2073 7461 7274 0a20 2020  tart = start.   
-00008fd0: 2020 2020 2061 7373 6572 7420 7365 6c66       assert self
-00008fe0: 2e70 7265 6669 7820 6973 206e 6f74 204e  .prefix is not N
-00008ff0: 6f6e 650a 2020 2020 2020 2020 7365 6c66  one.        self
-00009000: 2e70 7265 6669 782e 6164 645f 6475 7261  .prefix.add_dura
-00009010: 7469 6f6e 2861 6374 696f 6e2c 2073 7461  tion(action, sta
-00009020: 7274 2c20 7374 6f70 290a 0a20 2020 2064  rt, stop)..    d
-00009030: 6566 2061 6464 2873 656c 662c 206f 7468  ef add(self, oth
-00009040: 6572 3a20 5461 736b 5374 6174 6529 202d  er: TaskState) -
-00009050: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-00009060: 7365 6c66 2e73 7461 7465 735b 6f74 6865  self.states[othe
-00009070: 722e 7374 6174 655d 202b 3d20 310a 2020  r.state] += 1.  
-00009080: 2020 2020 2020 6f74 6865 722e 6772 6f75        other.grou
-00009090: 7020 3d20 7365 6c66 0a0a 2020 2020 6465  p = self..    de
-000090a0: 6620 5f5f 7265 7072 5f5f 2873 656c 6629  f __repr__(self)
-000090b0: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
-000090c0: 2072 6574 7572 6e20 280a 2020 2020 2020   return (.      
-000090d0: 2020 2020 2020 223c 220a 2020 2020 2020        "<".      
-000090e0: 2020 2020 2020 2b20 2873 656c 662e 6e61        + (self.na
-000090f0: 6d65 206f 7220 226e 6f2d 6772 6f75 7022  me or "no-group"
-00009100: 290a 2020 2020 2020 2020 2020 2020 2b20  ).            + 
-00009110: 223a 2022 0a20 2020 2020 2020 2020 2020  ": ".           
-00009120: 202b 2022 2c20 222e 6a6f 696e 280a 2020   + ", ".join(.  
-00009130: 2020 2020 2020 2020 2020 2020 2020 2225                "%
-00009140: 733a 2025 6422 2025 2028 6b2c 2076 2920  s: %d" % (k, v) 
-00009150: 666f 7220 286b 2c20 7629 2069 6e20 736f  for (k, v) in so
-00009160: 7274 6564 2873 656c 662e 7374 6174 6573  rted(self.states
-00009170: 2e69 7465 6d73 2829 2920 6966 2076 0a20  .items()) if v. 
-00009180: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00009190: 2020 2020 2020 2020 202b 2022 3e22 0a20           + ">". 
-000091a0: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
-000091b0: 6620 5f5f 6c65 6e5f 5f28 7365 6c66 2920  f __len__(self) 
-000091c0: 2d3e 2069 6e74 3a0a 2020 2020 2020 2020  -> int:.        
-000091d0: 7265 7475 726e 2073 756d 2873 656c 662e  return sum(self.
-000091e0: 7374 6174 6573 2e76 616c 7565 7328 2929  states.values())
-000091f0: 0a0a 2020 2020 6465 6620 5f74 6f5f 6469  ..    def _to_di
-00009200: 6374 5f6e 6f5f 6e65 7374 2873 656c 662c  ct_no_nest(self,
-00009210: 202a 2c20 6578 636c 7564 653a 2043 6f6e   *, exclude: Con
-00009220: 7461 696e 6572 5b73 7472 5d20 3d20 2829  tainer[str] = ()
-00009230: 2920 2d3e 2064 6963 745b 7374 722c 2041  ) -> dict[str, A
-00009240: 6e79 5d3a 0a20 2020 2020 2020 2022 2222  ny]:.        """
-00009250: 4469 6374 696f 6e61 7279 2072 6570 7265  Dictionary repre
-00009260: 7365 6e74 6174 696f 6e20 666f 7220 6465  sentation for de
-00009270: 6275 6767 696e 6720 7075 7270 6f73 6573  bugging purposes
-00009280: 2e0a 2020 2020 2020 2020 4e6f 7420 7479  ..        Not ty
-00009290: 7065 2073 7461 626c 6520 616e 6420 6e6f  pe stable and no
-000092a0: 7420 696e 7465 6e64 6564 2066 6f72 2072  t intended for r
-000092b0: 6f75 6e64 7472 6970 732e 0a0a 2020 2020  oundtrips...    
-000092c0: 2020 2020 5365 6520 616c 736f 0a20 2020      See also.   
-000092d0: 2020 2020 202d 2d2d 2d2d 2d2d 2d0a 2020       --------.  
-000092e0: 2020 2020 2020 436c 6965 6e74 2e64 756d        Client.dum
-000092f0: 705f 636c 7573 7465 725f 7374 6174 650a  p_cluster_state.
-00009300: 2020 2020 2020 2020 6469 7374 7269 6275          distribu
-00009310: 7465 642e 7574 696c 732e 7265 6375 7273  ted.utils.recurs
-00009320: 6976 655f 746f 5f64 6963 740a 2020 2020  ive_to_dict.    
-00009330: 2020 2020 5461 736b 5374 6174 652e 5f74      TaskState._t
-00009340: 6f5f 6469 6374 0a20 2020 2020 2020 2022  o_dict.        "
-00009350: 2222 0a20 2020 2020 2020 2072 6574 7572  "".        retur
-00009360: 6e20 7265 6375 7273 6976 655f 746f 5f64  n recursive_to_d
-00009370: 6963 7428 7365 6c66 2c20 6578 636c 7564  ict(self, exclud
-00009380: 653d 6578 636c 7564 652c 206d 656d 6265  e=exclude, membe
-00009390: 7273 3d54 7275 6529 0a0a 2020 2020 4070  rs=True)..    @p
-000093a0: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
-000093b0: 646f 6e65 2873 656c 6629 202d 3e20 626f  done(self) -> bo
-000093c0: 6f6c 3a0a 2020 2020 2020 2020 2222 2252  ol:.        """R
-000093d0: 6574 7572 6e20 5472 7565 2069 6620 616c  eturn True if al
-000093e0: 6c20 636f 6d70 7574 6174 696f 6e73 2066  l computations f
-000093f0: 6f72 2074 6869 7320 6772 6f75 7020 6861  or this group ha
-00009400: 7665 2063 6f6d 706c 6574 6564 3b20 4661  ve completed; Fa
-00009410: 6c73 650a 2020 2020 2020 2020 6f74 6865  lse.        othe
-00009420: 7277 6973 652e 0a0a 2020 2020 2020 2020  rwise...        
-00009430: 4e6f 7465 730a 2020 2020 2020 2020 2d2d  Notes.        --
-00009440: 2d2d 2d0a 2020 2020 2020 2020 5468 6973  ---.        This
-00009450: 2070 726f 7065 7274 7920 6d61 7920 7472   property may tr
-00009460: 616e 7369 7469 6f6e 2066 726f 6d20 5472  ansition from Tr
-00009470: 7565 2074 6f20 4661 6c73 652c 2065 2e67  ue to False, e.g
-00009480: 2e20 7768 656e 2061 2077 6f72 6b65 7220  . when a worker 
-00009490: 7468 6174 0a20 2020 2020 2020 2063 6f6e  that.        con
-000094a0: 7461 696e 6564 2074 6865 206f 6e6c 7920  tained the only 
-000094b0: 7265 706c 6963 6120 6f66 2061 2074 6173  replica of a tas
-000094c0: 6b20 696e 206d 656d 6f72 7920 6372 6173  k in memory cras
-000094d0: 6865 7320 616e 6420 7468 6520 7461 736b  hes and the task
-000094e0: 206e 6565 6420 746f 2062 650a 2020 2020   need to be.    
-000094f0: 2020 2020 7265 636f 6d70 7574 6564 2e0a      recomputed..
-00009500: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00009510: 2020 2020 7265 7475 726e 2061 6c6c 280a      return all(.
-00009520: 2020 2020 2020 2020 2020 2020 636f 756e              coun
-00009530: 7420 3d3d 2030 206f 7220 7374 6174 6520  t == 0 or state 
-00009540: 696e 207b 226d 656d 6f72 7922 2c20 2265  in {"memory", "e
-00009550: 7272 6564 222c 2022 7265 6c65 6173 6564  rred", "released
-00009560: 222c 2022 666f 7267 6f74 7465 6e22 7d0a  ", "forgotten"}.
-00009570: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00009580: 7374 6174 652c 2063 6f75 6e74 2069 6e20  state, count in 
-00009590: 7365 6c66 2e73 7461 7465 732e 6974 656d  self.states.item
-000095a0: 7328 290a 2020 2020 2020 2020 290a 0a0a  s().        )...
-000095b0: 636c 6173 7320 5461 736b 5374 6174 653a  class TaskState:
-000095c0: 0a20 2020 2022 2222 4120 7369 6d70 6c65  .    """A simple
-000095d0: 206f 626a 6563 7420 686f 6c64 696e 6720   object holding 
-000095e0: 696e 666f 726d 6174 696f 6e20 6162 6f75  information abou
-000095f0: 7420 6120 7461 736b 2e0a 0a20 2020 204e  t a task...    N
-00009600: 6f74 2074 6f20 6265 2063 6f6e 6675 7365  ot to be confuse
-00009610: 6420 7769 7468 203a 636c 6173 733a 6064  d with :class:`d
-00009620: 6973 7472 6962 7574 6564 2e77 6f72 6b65  istributed.worke
-00009630: 725f 7374 6174 655f 6d61 6368 696e 652e  r_state_machine.
-00009640: 5461 736b 5374 6174 6560 2c20 7768 6963  TaskState`, whic
-00009650: 680a 2020 2020 686f 6c64 7320 7369 6d69  h.    holds simi
-00009660: 6c61 7220 696e 666f 726d 6174 696f 6e20  lar information 
-00009670: 6f6e 2074 6865 2057 6f72 6b65 7220 7369  on the Worker si
-00009680: 6465 2e0a 2020 2020 2222 220a 0a20 2020  de..    """..   
-00009690: 2023 3a20 5468 6520 6b65 7920 6973 2074   #: The key is t
-000096a0: 6865 2075 6e69 7175 6520 6964 656e 7469  he unique identi
-000096b0: 6669 6572 206f 6620 6120 7461 736b 2c20  fier of a task, 
-000096c0: 6765 6e65 7261 6c6c 7920 666f 726d 6564  generally formed
-000096d0: 2066 726f 6d20 7468 6520 6e61 6d65 206f   from the name o
-000096e0: 6620 7468 650a 2020 2020 233a 2066 756e  f the.    #: fun
-000096f0: 6374 696f 6e2c 2066 6f6c 6c6f 7765 6420  ction, followed 
-00009700: 6279 2061 2068 6173 6820 6f66 2074 6865  by a hash of the
-00009710: 2066 756e 6374 696f 6e20 616e 6420 6172   function and ar
-00009720: 6775 6d65 6e74 732c 206c 696b 650a 2020  guments, like.  
-00009730: 2020 233a 2060 6027 696e 632d 6162 3331    #: ``'inc-ab31
-00009740: 6330 3130 3434 3439 3737 3030 3464 3635  c010444977004d65
-00009750: 3636 3130 6432 6434 3231 6563 2760 602e  6610d2d421ec'``.
-00009760: 0a20 2020 206b 6579 3a20 4b65 790a 0a20  .    key: Key.. 
-00009770: 2020 2023 3a20 5468 6520 6272 6f61 6420     #: The broad 
-00009780: 636c 6173 7320 6f66 2074 6173 6b73 2074  class of tasks t
-00009790: 6f20 7768 6963 6820 7468 6973 2074 6173  o which this tas
-000097a0: 6b20 6265 6c6f 6e67 7320 6c69 6b65 2022  k belongs like "
-000097b0: 696e 6322 206f 7220 2272 6561 645f 6373  inc" or "read_cs
-000097c0: 7622 0a20 2020 2070 7265 6669 783a 2054  v".    prefix: T
-000097d0: 6173 6b50 7265 6669 780a 0a20 2020 2023  askPrefix..    #
-000097e0: 3a20 4120 7370 6563 6966 6963 6174 696f  : A specificatio
-000097f0: 6e20 6f66 2068 6f77 2074 6f20 7275 6e20  n of how to run 
-00009800: 7468 6520 7461 736b 2e20 2054 6865 2074  the task.  The t
-00009810: 7970 6520 616e 6420 6d65 616e 696e 6720  ype and meaning 
-00009820: 6f66 2074 6869 7320 7661 6c75 6520 6973  of this value is
-00009830: 0a20 2020 2023 3a20 6f70 6171 7565 2074  .    #: opaque t
-00009840: 6f20 7468 6520 7363 6865 6475 6c65 722c  o the scheduler,
-00009850: 2061 7320 6974 2069 7320 6f6e 6c79 2069   as it is only i
-00009860: 6e74 6572 7072 6574 6564 2062 7920 7468  nterpreted by th
-00009870: 6520 776f 726b 6572 2074 6f20 7768 6963  e worker to whic
-00009880: 6820 7468 650a 2020 2020 233a 2074 6173  h the.    #: tas
-00009890: 6b20 6973 2073 656e 7420 666f 7220 6578  k is sent for ex
-000098a0: 6563 7574 696e 672e 0a20 2020 2023 3a0a  ecuting..    #:.
-000098b0: 2020 2020 233a 2041 7320 6120 7370 6563      #: As a spec
-000098c0: 6961 6c20 6361 7365 2c20 7468 6973 2061  ial case, this a
-000098d0: 7474 7269 6275 7465 206d 6179 2061 6c73  ttribute may als
-000098e0: 6f20 6265 2060 604e 6f6e 6560 602c 2069  o be ``None``, i
-000098f0: 6e20 7768 6963 6820 6361 7365 2074 6865  n which case the
-00009900: 2074 6173 6b20 6973 0a20 2020 2023 3a20   task is.    #: 
-00009910: 2270 7572 6520 6461 7461 2220 2873 7563  "pure data" (suc
-00009920: 6820 6173 2c20 666f 7220 6578 616d 706c  h as, for exampl
-00009930: 652c 2061 2070 6965 6365 206f 6620 6461  e, a piece of da
-00009940: 7461 206c 6f61 6465 6420 696e 2074 6865  ta loaded in the
-00009950: 2073 6368 6564 756c 6572 2075 7369 6e67   scheduler using
-00009960: 0a20 2020 2023 3a20 3a6d 6574 683a 6043  .    #: :meth:`C
-00009970: 6c69 656e 742e 7363 6174 7465 7260 292e  lient.scatter`).
-00009980: 2020 4120 2270 7572 6520 6461 7461 2220    A "pure data" 
-00009990: 7461 736b 2063 616e 6e6f 7420 6265 2063  task cannot be c
-000099a0: 6f6d 7075 7465 6420 6167 6169 6e20 6966  omputed again if
-000099b0: 2069 7473 0a20 2020 2023 3a20 7661 6c75   its.    #: valu
-000099c0: 6520 6973 206c 6f73 742e 0a20 2020 2072  e is lost..    r
-000099d0: 756e 5f73 7065 633a 2054 5f72 756e 7370  un_spec: T_runsp
-000099e0: 6563 207c 204e 6f6e 650a 0a20 2020 2023  ec | None..    #
-000099f0: 3a20 5468 6520 7072 696f 7269 7479 2070  : The priority p
-00009a00: 726f 7669 6465 7320 6561 6368 2074 6173  rovides each tas
-00009a10: 6b20 7769 7468 2061 2072 656c 6174 6976  k with a relativ
-00009a20: 6520 7261 6e6b 696e 6720 7768 6963 6820  e ranking which 
-00009a30: 6973 2075 7365 6420 746f 2062 7265 616b  is used to break
-00009a40: 0a20 2020 2023 3a20 7469 6573 2077 6865  .    #: ties whe
-00009a50: 6e20 6d61 6e79 2074 6173 6b73 2061 7265  n many tasks are
-00009a60: 2062 6569 6e67 2063 6f6e 7369 6465 7265   being considere
-00009a70: 6420 666f 7220 6578 6563 7574 696f 6e2e  d for execution.
-00009a80: 0a20 2020 2023 3a0a 2020 2020 233a 2054  .    #:.    #: T
-00009a90: 6869 7320 7261 6e6b 696e 6720 6973 2067  his ranking is g
-00009aa0: 656e 6572 616c 6c79 2061 2032 2d69 7465  enerally a 2-ite
-00009ab0: 6d20 7475 706c 652e 2020 5468 6520 6669  m tuple.  The fi
-00009ac0: 7273 7420 2861 6e64 2064 6f6d 696e 616e  rst (and dominan
-00009ad0: 7429 2069 7465 6d0a 2020 2020 233a 2063  t) item.    #: c
-00009ae0: 6f72 7265 7370 6f6e 6473 2074 6f20 7768  orresponds to wh
-00009af0: 656e 2069 7420 7761 7320 7375 626d 6974  en it was submit
-00009b00: 7465 642e 2020 4765 6e65 7261 6c6c 792c  ted.  Generally,
-00009b10: 2065 6172 6c69 6572 2074 6173 6b73 2074   earlier tasks t
-00009b20: 616b 6520 7072 6563 6564 656e 6365 2e0a  ake precedence..
-00009b30: 2020 2020 233a 2054 6865 2073 6563 6f6e      #: The secon
-00009b40: 6420 6974 656d 2069 7320 6465 7465 726d  d item is determ
-00009b50: 696e 6564 2062 7920 7468 6520 636c 6965  ined by the clie
-00009b60: 6e74 2c20 616e 6420 6973 2061 2077 6179  nt, and is a way
-00009b70: 2074 6f20 7072 696f 7269 7469 7a65 2074   to prioritize t
-00009b80: 6173 6b73 0a20 2020 2023 3a20 7769 7468  asks.    #: with
-00009b90: 696e 2061 206c 6172 6765 2067 7261 7068  in a large graph
-00009ba0: 2074 6861 7420 6d61 7920 6265 2069 6d70   that may be imp
-00009bb0: 6f72 7461 6e74 2c20 7375 6368 2061 7320  ortant, such as 
-00009bc0: 6966 2074 6865 7920 6172 6520 6f6e 2074  if they are on t
-00009bd0: 6865 2063 7269 7469 6361 6c0a 2020 2020  he critical.    
-00009be0: 233a 2070 6174 682c 206f 7220 676f 6f64  #: path, or good
-00009bf0: 2074 6f20 7275 6e20 696e 206f 7264 6572   to run in order
-00009c00: 2074 6f20 7265 6c65 6173 6520 6d61 6e79   to release many
-00009c10: 2064 6570 656e 6465 6e63 6965 732e 2020   dependencies.  
-00009c20: 5468 6973 2069 7320 6578 706c 6169 6e65  This is explaine
-00009c30: 640a 2020 2020 233a 2066 7572 7468 6572  d.    #: further
-00009c40: 2069 6e20 3a64 6f63 3a60 5363 6865 6475   in :doc:`Schedu
-00009c50: 6c69 6e67 2050 6f6c 6963 7920 3c73 6368  ling Policy <sch
-00009c60: 6564 756c 696e 672d 706f 6c69 6369 6573  eduling-policies
-00009c70: 3e60 2e0a 2020 2020 7072 696f 7269 7479  >`..    priority
-00009c80: 3a20 7475 706c 655b 666c 6f61 742c 202e  : tuple[float, .
-00009c90: 2e2e 5d20 7c20 4e6f 6e65 0a0a 2020 2020  ..] | None..    
-00009ca0: 2320 4174 7472 6962 7574 6520 756e 6465  # Attribute unde
-00009cb0: 726c 7969 6e67 2074 6865 2073 7461 7465  rlying the state
-00009cc0: 2070 726f 7065 7274 790a 2020 2020 5f73   property.    _s
-00009cd0: 7461 7465 3a20 5461 736b 5374 6174 6553  tate: TaskStateS
-00009ce0: 7461 7465 0a0a 2020 2020 233a 2054 6865  tate..    #: The
-00009cf0: 2073 6574 206f 6620 7461 736b 7320 7468   set of tasks th
-00009d00: 6973 2074 6173 6b20 6465 7065 6e64 7320  is task depends 
-00009d10: 6f6e 2066 6f72 2070 726f 7065 7220 6578  on for proper ex
-00009d20: 6563 7574 696f 6e2e 204f 6e6c 7920 7461  ecution. Only ta
-00009d30: 736b 7320 7374 696c 6c0a 2020 2020 233a  sks still.    #:
-00009d40: 2061 6c69 7665 2061 7265 206c 6973 7465   alive are liste
-00009d50: 6420 696e 2074 6869 7320 7365 742e 2049  d in this set. I
-00009d60: 662c 2066 6f72 2077 6861 7465 7665 7220  f, for whatever 
-00009d70: 7265 6173 6f6e 2c20 7468 6973 2074 6173  reason, this tas
-00009d80: 6b20 616c 736f 2064 6570 656e 6473 206f  k also depends o
-00009d90: 6e0a 2020 2020 233a 2061 2066 6f72 676f  n.    #: a forgo
-00009da0: 7474 656e 2074 6173 6b2c 2074 6865 203a  tten task, the :
-00009db0: 6174 7472 3a60 6861 735f 6c6f 7374 5f64  attr:`has_lost_d
-00009dc0: 6570 656e 6465 6e63 6965 7360 2066 6c61  ependencies` fla
-00009dd0: 6720 6973 2073 6574 2e0a 2020 2020 233a  g is set..    #:
-00009de0: 0a20 2020 2023 3a20 4120 7461 736b 2063  .    #: A task c
-00009df0: 616e 206f 6e6c 7920 6265 2065 7865 6375  an only be execu
-00009e00: 7465 6420 6f6e 6365 2061 6c6c 2069 7473  ted once all its
-00009e10: 2064 6570 656e 6465 6e63 6965 7320 6861   dependencies ha
-00009e20: 7665 2061 6c72 6561 6479 2062 6565 6e0a  ve already been.
-00009e30: 2020 2020 233a 2073 7563 6365 7373 6675      #: successfu
-00009e40: 6c6c 7920 6578 6563 7574 6564 2061 6e64  lly executed and
-00009e50: 2068 6176 6520 7468 6569 7220 7265 7375   have their resu
-00009e60: 6c74 2073 746f 7265 6420 6f6e 2061 7420  lt stored on at 
-00009e70: 6c65 6173 7420 6f6e 6520 776f 726b 6572  least one worker
-00009e80: 2e20 5468 6973 0a20 2020 2023 3a20 6973  . This.    #: is
-00009e90: 2074 7261 636b 6564 2062 7920 7072 6f67   tracked by prog
-00009ea0: 7265 7373 6976 656c 7920 6472 6169 6e69  ressively draini
-00009eb0: 6e67 2074 6865 203a 6174 7472 3a60 7761  ng the :attr:`wa
-00009ec0: 6974 696e 675f 6f6e 6020 7365 742e 0a20  iting_on` set.. 
-00009ed0: 2020 2064 6570 656e 6465 6e63 6965 733a     dependencies:
-00009ee0: 2073 6574 5b54 6173 6b53 7461 7465 5d0a   set[TaskState].
-00009ef0: 0a20 2020 2023 3a20 5468 6520 7365 7420  .    #: The set 
-00009f00: 6f66 2074 6173 6b73 2077 6869 6368 2064  of tasks which d
-00009f10: 6570 656e 6420 6f6e 2074 6869 7320 7461  epend on this ta
-00009f20: 736b 2e20 204f 6e6c 7920 7461 736b 7320  sk.  Only tasks 
-00009f30: 7374 696c 6c20 616c 6976 6520 6172 6520  still alive are 
-00009f40: 6c69 7374 6564 2069 6e0a 2020 2020 233a  listed in.    #:
-00009f50: 2074 6869 7320 7365 742e 2054 6869 7320   this set. This 
-00009f60: 6973 2074 6865 2072 6576 6572 7365 206d  is the reverse m
-00009f70: 6170 7069 6e67 206f 6620 3a61 7474 723a  apping of :attr:
-00009f80: 6064 6570 656e 6465 6e63 6965 7360 2e0a  `dependencies`..
-00009f90: 2020 2020 6465 7065 6e64 656e 7473 3a20      dependents: 
-00009fa0: 7365 745b 5461 736b 5374 6174 655d 0a0a  set[TaskState]..
-00009fb0: 2020 2020 233a 2057 6865 7468 6572 2061      #: Whether a
-00009fc0: 6e79 206f 6620 7468 6520 6465 7065 6e64  ny of the depend
-00009fd0: 656e 6369 6573 206f 6620 7468 6973 2074  encies of this t
-00009fe0: 6173 6b20 6861 7320 6265 656e 2066 6f72  ask has been for
-00009ff0: 676f 7474 656e 2e20 466f 7220 6d65 6d6f  gotten. For memo
-0000a000: 7279 0a20 2020 2023 3a20 636f 6e73 756d  ry.    #: consum
-0000a010: 7074 696f 6e20 7265 6173 6f6e 732c 2066  ption reasons, f
-0000a020: 6f72 676f 7474 656e 2074 6173 6b73 2061  orgotten tasks a
-0000a030: 7265 206e 6f74 206b 6570 7420 696e 206d  re not kept in m
-0000a040: 656d 6f72 7920 6576 656e 2074 686f 7567  emory even thoug
-0000a050: 6820 7468 6579 206d 6179 0a20 2020 2023  h they may.    #
-0000a060: 3a20 6861 7665 2064 6570 656e 6465 6e74  : have dependent
-0000a070: 2074 6173 6b73 2e20 2057 6865 6e20 6120   tasks.  When a 
-0000a080: 7461 736b 2069 7320 666f 7267 6f74 7465  task is forgotte
-0000a090: 6e2c 2074 6865 7265 666f 7265 2c20 6561  n, therefore, ea
-0000a0a0: 6368 206f 6620 6974 730a 2020 2020 233a  ch of its.    #:
-0000a0b0: 2064 6570 656e 6465 6e74 7320 6861 7320   dependents has 
-0000a0c0: 7468 6569 7220 3a61 7474 723a 6068 6173  their :attr:`has
-0000a0d0: 5f6c 6f73 745f 6465 7065 6e64 656e 6369  _lost_dependenci
-0000a0e0: 6573 6020 6174 7472 6962 7574 6520 7365  es` attribute se
-0000a0f0: 7420 746f 2060 6054 7275 6560 602e 0a20  t to ``True``.. 
-0000a100: 2020 2023 3a0a 2020 2020 233a 2049 6620     #:.    #: If 
-0000a110: 3a61 7474 723a 6068 6173 5f6c 6f73 745f  :attr:`has_lost_
-0000a120: 6465 7065 6e64 656e 6369 6573 6020 6973  dependencies` is
-0000a130: 2074 7275 652c 2074 6869 7320 7461 736b   true, this task
-0000a140: 2063 616e 6e6f 7420 676f 2069 6e74 6f20   cannot go into 
-0000a150: 7468 650a 2020 2020 233a 2022 7072 6f63  the.    #: "proc
-0000a160: 6573 7369 6e67 2220 7374 6174 6520 616e  essing" state an
-0000a170: 796d 6f72 652e 0a20 2020 2068 6173 5f6c  ymore..    has_l
-0000a180: 6f73 745f 6465 7065 6e64 656e 6369 6573  ost_dependencies
-0000a190: 3a20 626f 6f6c 0a0a 2020 2020 233a 2054  : bool..    #: T
-0000a1a0: 6865 2073 6574 206f 6620 7461 736b 7320  he set of tasks 
-0000a1b0: 7468 6973 2074 6173 6b20 6973 2077 6169  this task is wai
-0000a1c0: 7469 6e67 206f 6e20 2a62 6566 6f72 652a  ting on *before*
-0000a1d0: 2069 7420 6361 6e20 6265 2065 7865 6375   it can be execu
-0000a1e0: 7465 642e 2054 6869 7320 6973 0a20 2020  ted. This is.   
-0000a1f0: 2023 3a20 616c 7761 7973 2061 2073 7562   #: always a sub
-0000a200: 7365 7420 6f66 203a 6174 7472 3a60 6465  set of :attr:`de
-0000a210: 7065 6e64 656e 6369 6573 602e 2020 4561  pendencies`.  Ea
-0000a220: 6368 2074 696d 6520 6f6e 6520 6f66 2074  ch time one of t
-0000a230: 6865 2064 6570 656e 6465 6e63 6965 7320  he dependencies 
-0000a240: 6861 730a 2020 2020 233a 2066 696e 6973  has.    #: finis
-0000a250: 6865 6420 7072 6f63 6573 7369 6e67 2c20  hed processing, 
-0000a260: 6974 2069 7320 7265 6d6f 7665 6420 6672  it is removed fr
-0000a270: 6f6d 2074 6865 203a 6174 7472 3a60 7761  om the :attr:`wa
-0000a280: 6974 696e 675f 6f6e 6020 7365 742e 0a20  iting_on` set.. 
-0000a290: 2020 2023 3a0a 2020 2020 233a 204f 6e63     #:.    #: Onc
-0000a2a0: 6520 3a61 7474 723a 6077 6169 7469 6e67  e :attr:`waiting
-0000a2b0: 5f6f 6e60 2062 6563 6f6d 6573 2065 6d70  _on` becomes emp
-0000a2c0: 7479 2c20 7468 6973 2074 6173 6b20 6361  ty, this task ca
-0000a2d0: 6e20 6d6f 7665 2066 726f 6d20 7468 6520  n move from the 
-0000a2e0: 2277 6169 7469 6e67 220a 2020 2020 233a  "waiting".    #:
-0000a2f0: 2073 7461 7465 2074 6f20 7468 6520 2270   state to the "p
-0000a300: 726f 6365 7373 696e 6722 2073 7461 7465  rocessing" state
-0000a310: 2028 756e 6c65 7373 206f 6e65 206f 6620   (unless one of 
-0000a320: 7468 6520 6465 7065 6e64 656e 6369 6573  the dependencies
-0000a330: 2065 7272 6f72 6564 206f 7574 2c20 696e   errored out, in
-0000a340: 0a20 2020 2023 3a20 7768 6963 6820 6361  .    #: which ca
-0000a350: 7365 2074 6869 7320 7461 736b 2069 7320  se this task is 
-0000a360: 696e 7374 6561 6420 6d61 726b 6564 2022  instead marked "
-0000a370: 6572 7265 6422 292e 0a20 2020 2077 6169  erred")..    wai
-0000a380: 7469 6e67 5f6f 6e3a 2073 6574 5b54 6173  ting_on: set[Tas
-0000a390: 6b53 7461 7465 5d20 7c20 4e6f 6e65 0a0a  kState] | None..
-0000a3a0: 2020 2020 233a 2054 6865 2073 6574 206f      #: The set o
-0000a3b0: 6620 7461 736b 7320 7768 6963 6820 6e65  f tasks which ne
-0000a3c0: 6564 2074 6869 7320 7461 736b 2074 6f20  ed this task to 
-0000a3d0: 7265 6d61 696e 2061 6c69 7665 2e20 2054  remain alive.  T
-0000a3e0: 6869 7320 6973 2061 6c77 6179 7320 6120  his is always a 
-0000a3f0: 7375 6273 6574 0a20 2020 2023 3a20 6f66  subset.    #: of
-0000a400: 203a 6174 7472 3a60 6465 7065 6e64 656e   :attr:`dependen
-0000a410: 7473 602e 2020 4561 6368 2074 696d 6520  ts`.  Each time 
-0000a420: 6f6e 6520 6f66 2074 6865 2064 6570 656e  one of the depen
-0000a430: 6465 6e74 7320 6861 7320 6669 6e69 7368  dents has finish
-0000a440: 6564 2070 726f 6365 7373 696e 672c 0a20  ed processing,. 
-0000a450: 2020 2023 3a20 6974 2069 7320 7265 6d6f     #: it is remo
-0000a460: 7665 6420 6672 6f6d 2074 6865 203a 6174  ved from the :at
-0000a470: 7472 3a60 7761 6974 6572 7360 2073 6574  tr:`waiters` set
-0000a480: 2e0a 2020 2020 233a 0a20 2020 2023 3a20  ..    #:.    #: 
-0000a490: 4f6e 6365 2062 6f74 6820 3a61 7474 723a  Once both :attr:
-0000a4a0: 6077 6169 7465 7273 6020 616e 6420 3a61  `waiters` and :a
-0000a4b0: 7474 723a 6077 686f 5f77 616e 7473 6020  ttr:`who_wants` 
-0000a4c0: 6265 636f 6d65 2065 6d70 7479 2c20 7468  become empty, th
-0000a4d0: 6973 2074 6173 6b20 6361 6e20 6265 0a20  is task can be. 
-0000a4e0: 2020 2023 3a20 7265 6c65 6173 6564 2028     #: released (
-0000a4f0: 6966 2069 7420 6861 7320 6120 6e6f 6e2d  if it has a non-
-0000a500: 656d 7074 7920 3a61 7474 723a 6072 756e  empty :attr:`run
-0000a510: 5f73 7065 6360 2920 6f72 2066 6f72 676f  _spec`) or forgo
-0000a520: 7474 656e 2028 6f74 6865 7277 6973 6529  tten (otherwise)
-0000a530: 2062 7920 7468 650a 2020 2020 233a 2073   by the.    #: s
-0000a540: 6368 6564 756c 6572 2c20 616e 6420 6279  cheduler, and by
-0000a550: 2061 6e79 2077 6f72 6b65 7273 2069 6e20   any workers in 
-0000a560: 3a61 7474 723a 6077 686f 5f68 6173 602e  :attr:`who_has`.
-0000a570: 0a20 2020 2023 3a0a 2020 2020 233a 202e  .    #:.    #: .
-0000a580: 2e20 6e6f 7465 3a3a 0a20 2020 2023 3a20  . note::.    #: 
-0000a590: 2020 2043 6f75 6e74 6572 2d69 6e74 7569     Counter-intui
-0000a5a0: 7469 7665 6c79 2c20 3a61 7474 723a 6077  tively, :attr:`w
-0000a5b0: 6169 7469 6e67 5f6f 6e60 2061 6e64 203a  aiting_on` and :
-0000a5c0: 6174 7472 3a60 7761 6974 6572 7360 2061  attr:`waiters` a
-0000a5d0: 7265 206e 6f74 2072 6576 6572 7365 0a20  re not reverse. 
-0000a5e0: 2020 2023 3a20 2020 206d 6170 7069 6e67     #:    mapping
-0000a5f0: 7320 6f66 2065 6163 6820 6f74 6865 722e  s of each other.
-0000a600: 0a20 2020 2077 6169 7465 7273 3a20 7365  .    waiters: se
-0000a610: 745b 5461 736b 5374 6174 655d 207c 204e  t[TaskState] | N
-0000a620: 6f6e 650a 0a20 2020 2023 3a20 5468 6520  one..    #: The 
-0000a630: 7365 7420 6f66 2063 6c69 656e 7473 2077  set of clients w
-0000a640: 686f 2077 616e 7420 7468 6520 7265 7375  ho want the resu
-0000a650: 6c74 206f 6620 7468 6973 2074 6173 6b20  lt of this task 
-0000a660: 746f 2072 656d 6169 6e20 616c 6976 652e  to remain alive.
-0000a670: 0a20 2020 2023 3a20 5468 6973 2069 7320  .    #: This is 
-0000a680: 7468 6520 7265 7665 7273 6520 6d61 7070  the reverse mapp
-0000a690: 696e 6720 6f66 203a 6174 7472 3a60 436c  ing of :attr:`Cl
-0000a6a0: 6965 6e74 5374 6174 652e 7761 6e74 735f  ientState.wants_
-0000a6b0: 7768 6174 602e 0a20 2020 2023 3a0a 2020  what`..    #:.  
-0000a6c0: 2020 233a 2057 6865 6e20 6120 636c 6965    #: When a clie
-0000a6d0: 6e74 2073 7562 6d69 7473 2061 2067 7261  nt submits a gra
-0000a6e0: 7068 2074 6f20 7468 6520 7363 6865 6475  ph to the schedu
-0000a6f0: 6c65 7220 6974 2061 6c73 6f20 7370 6563  ler it also spec
-0000a700: 6966 6965 7320 7768 6963 6820 6f75 7470  ifies which outp
-0000a710: 7574 0a20 2020 2023 3a20 7461 736b 7320  ut.    #: tasks 
-0000a720: 6974 2064 6573 6972 6573 2c20 7375 6368  it desires, such
-0000a730: 2074 6861 7420 7468 6569 7220 7265 7375   that their resu
-0000a740: 6c74 7320 6172 6520 6e6f 7420 7265 6c65  lts are not rele
-0000a750: 6173 6564 2066 726f 6d20 6d65 6d6f 7279  ased from memory
-0000a760: 2e0a 2020 2020 233a 0a20 2020 2023 3a20  ..    #:.    #: 
-0000a770: 4f6e 6365 2061 2074 6173 6b20 6861 7320  Once a task has 
-0000a780: 6669 6e69 7368 6564 2065 7865 6375 7469  finished executi
-0000a790: 6e67 2028 692e 652e 206d 6f76 6573 2069  ng (i.e. moves i
-0000a7a0: 6e74 6f20 7468 6520 226d 656d 6f72 7922  nto the "memory"
-0000a7b0: 206f 7220 2265 7272 6564 220a 2020 2020   or "erred".    
-0000a7c0: 233a 2073 7461 7465 292c 2074 6865 2063  #: state), the c
-0000a7d0: 6c69 656e 7473 2069 6e20 3a61 7474 723a  lients in :attr:
-0000a7e0: 6077 686f 5f77 616e 7473 6020 6172 6520  `who_wants` are 
-0000a7f0: 6e6f 7469 6669 6564 2e0a 2020 2020 233a  notified..    #:
-0000a800: 0a20 2020 2023 3a20 4f6e 6365 2062 6f74  .    #: Once bot
-0000a810: 6820 3a61 7474 723a 6077 6169 7465 7273  h :attr:`waiters
-0000a820: 6020 616e 6420 3a61 7474 723a 6077 686f  ` and :attr:`who
-0000a830: 5f77 616e 7473 6020 6265 636f 6d65 2065  _wants` become e
-0000a840: 6d70 7479 2c20 7468 6973 2074 6173 6b20  mpty, this task 
-0000a850: 6361 6e20 6265 0a20 2020 2023 3a20 7265  can be.    #: re
-0000a860: 6c65 6173 6564 2028 6966 2069 7420 6861  leased (if it ha
-0000a870: 7320 6120 6e6f 6e2d 656d 7074 7920 3a61  s a non-empty :a
-0000a880: 7474 723a 6072 756e 5f73 7065 6360 2920  ttr:`run_spec`) 
-0000a890: 6f72 2066 6f72 676f 7474 656e 2028 6f74  or forgotten (ot
-0000a8a0: 6865 7277 6973 6529 2062 7920 7468 650a  herwise) by the.
-0000a8b0: 2020 2020 233a 2073 6368 6564 756c 6572      #: scheduler
-0000a8c0: 2c20 616e 6420 6279 2061 6e79 2077 6f72  , and by any wor
-0000a8d0: 6b65 7273 2069 6e20 3a61 7474 723a 6077  kers in :attr:`w
-0000a8e0: 686f 5f68 6173 602e 0a20 2020 2077 686f  ho_has`..    who
-0000a8f0: 5f77 616e 7473 3a20 7365 745b 436c 6965  _wants: set[Clie
-0000a900: 6e74 5374 6174 655d 207c 204e 6f6e 650a  ntState] | None.
-0000a910: 0a20 2020 2023 3a20 5468 6520 7365 7420  .    #: The set 
-0000a920: 6f66 2077 6f72 6b65 7273 2077 686f 2068  of workers who h
-0000a930: 6176 6520 7468 6973 2074 6173 6b27 7320  ave this task's 
-0000a940: 7265 7375 6c74 2069 6e20 6d65 6d6f 7279  result in memory
-0000a950: 2e20 4974 2069 7320 6e6f 6e2d 656d 7074  . It is non-empt
-0000a960: 7920 6966 6620 7468 650a 2020 2020 233a  y iff the.    #:
-0000a970: 2074 6173 6b20 6973 2069 6e20 7468 6520   task is in the 
-0000a980: 226d 656d 6f72 7922 2073 7461 7465 2e20  "memory" state. 
-0000a990: 2054 6865 7265 2063 616e 2062 6520 6d6f   There can be mo
-0000a9a0: 7265 2074 6861 6e20 6f6e 6520 776f 726b  re than one work
-0000a9b0: 6572 2069 6e20 7468 6973 2073 6574 2069  er in this set i
-0000a9c0: 662c 0a20 2020 2023 3a20 666f 7220 6578  f,.    #: for ex
-0000a9d0: 616d 706c 652c 203a 6d65 7468 3a60 436c  ample, :meth:`Cl
-0000a9e0: 6965 6e74 2e73 6361 7474 6572 6020 6f72  ient.scatter` or
-0000a9f0: 203a 6d65 7468 3a60 436c 6965 6e74 2e72   :meth:`Client.r
-0000aa00: 6570 6c69 6361 7465 6020 7761 7320 7573  eplicate` was us
-0000aa10: 6564 2e0a 2020 2020 233a 0a20 2020 2023  ed..    #:.    #
-0000aa20: 3a20 5468 6973 2069 7320 7468 6520 7265  : This is the re
-0000aa30: 7665 7273 6520 6d61 7070 696e 6720 6f66  verse mapping of
-0000aa40: 203a 6174 7472 3a60 576f 726b 6572 5374   :attr:`WorkerSt
-0000aa50: 6174 652e 6861 735f 7768 6174 602e 0a20  ate.has_what`.. 
-0000aa60: 2020 2077 686f 5f68 6173 3a20 7365 745b     who_has: set[
-0000aa70: 576f 726b 6572 5374 6174 655d 207c 204e  WorkerState] | N
-0000aa80: 6f6e 650a 0a20 2020 2023 3a20 4966 2074  one..    #: If t
-0000aa90: 6869 7320 7461 736b 2069 7320 696e 2074  his task is in t
-0000aaa0: 6865 2022 7072 6f63 6573 7369 6e67 2220  he "processing" 
-0000aab0: 7374 6174 652c 2077 6869 6368 2077 6f72  state, which wor
-0000aac0: 6b65 7220 6973 2063 7572 7265 6e74 6c79  ker is currently
-0000aad0: 2070 726f 6365 7373 696e 670a 2020 2020   processing.    
-0000aae0: 233a 2069 742e 2054 6869 7320 6174 7472  #: it. This attr
-0000aaf0: 6962 7574 6520 6973 206b 6570 7420 696e  ibute is kept in
-0000ab00: 2073 796e 6320 7769 7468 203a 6174 7472   sync with :attr
-0000ab10: 3a60 576f 726b 6572 5374 6174 652e 7072  :`WorkerState.pr
-0000ab20: 6f63 6573 7369 6e67 602e 0a20 2020 2070  ocessing`..    p
-0000ab30: 726f 6365 7373 696e 675f 6f6e 3a20 576f  rocessing_on: Wo
-0000ab40: 726b 6572 5374 6174 6520 7c20 4e6f 6e65  rkerState | None
-0000ab50: 0a0a 2020 2020 233a 2054 6865 206e 756d  ..    #: The num
-0000ab60: 6265 7220 6f66 2074 696d 6573 2074 6869  ber of times thi
-0000ab70: 7320 7461 736b 2063 616e 2061 7574 6f6d  s task can autom
-0000ab80: 6174 6963 616c 6c79 2062 6520 7265 7472  atically be retr
-0000ab90: 6965 6420 696e 2063 6173 6520 6f66 2066  ied in case of f
-0000aba0: 6169 6c75 7265 2e0a 2020 2020 233a 2049  ailure..    #: I
-0000abb0: 6620 6120 7461 736b 2066 6169 6c73 2065  f a task fails e
-0000abc0: 7865 6375 7469 6e67 2028 7468 6520 776f  xecuting (the wo
-0000abd0: 726b 6572 2072 6574 7572 6e73 2077 6974  rker returns wit
-0000abe0: 6820 616e 2065 7272 6f72 292c 2069 7473  h an error), its
-0000abf0: 203a 6174 7472 3a60 7265 7472 6965 7360   :attr:`retries`
-0000ac00: 0a20 2020 2023 3a20 6174 7472 6962 7574  .    #: attribut
-0000ac10: 6520 6973 2063 6865 636b 6564 2e20 4966  e is checked. If
-0000ac20: 2069 7420 6973 2065 7175 616c 2074 6f20   it is equal to 
-0000ac30: 302c 2074 6865 2074 6173 6b20 6973 206d  0, the task is m
-0000ac40: 6172 6b65 6420 2265 7272 6564 222e 2049  arked "erred". I
-0000ac50: 6620 6974 2069 730a 2020 2020 233a 2067  f it is.    #: g
-0000ac60: 7265 6174 6572 2074 6861 6e20 302c 2074  reater than 0, t
-0000ac70: 6865 203a 6174 7472 3a60 7265 7472 6965  he :attr:`retrie
-0000ac80: 7360 2061 7474 7269 6275 7465 2069 7320  s` attribute is 
-0000ac90: 6465 6372 656d 656e 7465 6420 616e 6420  decremented and 
-0000aca0: 6578 6563 7574 696f 6e20 6973 0a20 2020  execution is.   
-0000acb0: 2023 3a20 6174 7465 6d70 7465 6420 6167   #: attempted ag
-0000acc0: 6169 6e2e 0a20 2020 2072 6574 7269 6573  ain..    retries
-0000acd0: 3a20 696e 740a 0a20 2020 2023 3a20 5468  : int..    #: Th
-0000ace0: 6520 6e75 6d62 6572 206f 6620 6279 7465  e number of byte
-0000acf0: 732c 2061 7320 6465 7465 726d 696e 6564  s, as determined
-0000ad00: 2062 7920 6060 7369 7a65 6f66 6060 2c20   by ``sizeof``, 
-0000ad10: 6f66 2074 6865 2072 6573 756c 7420 6f66  of the result of
-0000ad20: 2061 2066 696e 6973 6865 640a 2020 2020   a finished.    
-0000ad30: 233a 2074 6173 6b2e 2054 6869 7320 6e75  #: task. This nu
-0000ad40: 6d62 6572 2069 7320 7573 6564 2066 6f72  mber is used for
-0000ad50: 2064 6961 676e 6f73 7469 6373 2061 6e64   diagnostics and
-0000ad60: 2074 6f20 6865 6c70 2070 7269 6f72 6974   to help priorit
-0000ad70: 697a 6520 776f 726b 2e0a 2020 2020 233a  ize work..    #:
-0000ad80: 2053 6574 2074 6f20 2d31 2066 6f72 2075   Set to -1 for u
-0000ad90: 6e66 696e 6973 6865 6420 7461 736b 732e  nfinished tasks.
-0000ada0: 0a20 2020 206e 6279 7465 733a 2069 6e74  .    nbytes: int
-0000adb0: 0a0a 2020 2020 233a 2054 6865 2074 7970  ..    #: The typ
-0000adc0: 6520 6f66 2074 6865 206f 626a 6563 7420  e of the object 
-0000add0: 6173 2061 2073 7472 696e 672e 204f 6e6c  as a string. Onl
-0000ade0: 7920 7072 6573 656e 7420 666f 7220 7461  y present for ta
-0000adf0: 736b 7320 7468 6174 2068 6176 6520 6265  sks that have be
-0000ae00: 656e 0a20 2020 2023 3a20 636f 6d70 7574  en.    #: comput
-0000ae10: 6564 2e0a 2020 2020 7479 7065 3a20 7374  ed..    type: st
-0000ae20: 720a 0a20 2020 2023 3a20 4966 2074 6869  r..    #: If thi
-0000ae30: 7320 7461 736b 2066 6169 6c65 6420 6578  s task failed ex
-0000ae40: 6563 7574 696e 672c 2074 6865 2065 7863  ecuting, the exc
-0000ae50: 6570 7469 6f6e 206f 626a 6563 7420 6973  eption object is
-0000ae60: 2073 746f 7265 6420 6865 7265 2e0a 2020   stored here..  
-0000ae70: 2020 6578 6365 7074 696f 6e3a 2053 6572    exception: Ser
-0000ae80: 6961 6c69 7a65 6420 7c20 4e6f 6e65 0a0a  ialized | None..
-0000ae90: 2020 2020 233a 2049 6620 7468 6973 2074      #: If this t
-0000aea0: 6173 6b20 6661 696c 6564 2065 7865 6375  ask failed execu
-0000aeb0: 7469 6e67 2c20 7468 6520 7472 6163 6562  ting, the traceb
-0000aec0: 6163 6b20 6f62 6a65 6374 2069 7320 7374  ack object is st
-0000aed0: 6f72 6564 2068 6572 652e 0a20 2020 2074  ored here..    t
-0000aee0: 7261 6365 6261 636b 3a20 5365 7269 616c  raceback: Serial
-0000aef0: 697a 6564 207c 204e 6f6e 650a 0a20 2020  ized | None..   
-0000af00: 2023 3a20 7374 7269 6e67 2072 6570 7265   #: string repre
-0000af10: 7365 6e74 6174 696f 6e20 6f66 2065 7863  sentation of exc
-0000af20: 6570 7469 6f6e 0a20 2020 2065 7863 6570  eption.    excep
-0000af30: 7469 6f6e 5f74 6578 743a 2073 7472 207c  tion_text: str |
-0000af40: 204e 6f6e 650a 0a20 2020 2023 3a20 7374   None..    #: st
-0000af50: 7269 6e67 2072 6570 7265 7365 6e74 6174  ring representat
-0000af60: 696f 6e20 6f66 2074 7261 6365 6261 636b  ion of traceback
-0000af70: 0a20 2020 2074 7261 6365 6261 636b 5f74  .    traceback_t
-0000af80: 6578 743a 2073 7472 207c 204e 6f6e 650a  ext: str | None.
-0000af90: 0a20 2020 2023 3a20 4966 2074 6869 7320  .    #: If this 
-0000afa0: 7461 736b 206f 7220 6f6e 6520 6f66 2069  task or one of i
-0000afb0: 7473 2064 6570 656e 6465 6e63 6965 7320  ts dependencies 
-0000afc0: 6661 696c 6564 2065 7865 6375 7469 6e67  failed executing
-0000afd0: 2c20 7468 6520 6661 696c 6564 2074 6173  , the failed tas
-0000afe0: 6b20 6973 0a20 2020 2023 3a20 7374 6f72  k is.    #: stor
-0000aff0: 6564 2068 6572 6520 2870 6f73 7369 626c  ed here (possibl
-0000b000: 7920 6974 7365 6c66 292e 0a20 2020 2065  y itself)..    e
-0000b010: 7863 6570 7469 6f6e 5f62 6c61 6d65 3a20  xception_blame: 
-0000b020: 5461 736b 5374 6174 6520 7c20 4e6f 6e65  TaskState | None
-0000b030: 0a0a 2020 2020 233a 2057 6f72 6b65 7220  ..    #: Worker 
-0000b040: 6164 6472 6573 7365 7320 6f6e 2077 6869  addresses on whi
-0000b050: 6368 2065 7272 6f72 7320 6170 7065 6172  ch errors appear
-0000b060: 6564 2c20 6361 7573 696e 6720 7468 6973  ed, causing this
-0000b070: 2074 6173 6b20 746f 2062 6520 696e 2061   task to be in a
-0000b080: 6e20 6572 726f 720a 2020 2020 233a 2073  n error.    #: s
-0000b090: 7461 7465 2e0a 2020 2020 6572 7265 645f  tate..    erred_
-0000b0a0: 6f6e 3a20 7365 745b 7374 725d 207c 204e  on: set[str] | N
-0000b0b0: 6f6e 650a 0a20 2020 2023 3a20 5468 6520  one..    #: The 
-0000b0c0: 6e75 6d62 6572 206f 6620 7469 6d65 7320  number of times 
-0000b0d0: 7468 6973 2074 6173 6b20 6861 7320 6265  this task has be
-0000b0e0: 656e 2069 6e76 6f6c 7665 6420 696e 2061  en involved in a
-0000b0f0: 2077 6f72 6b65 7220 6465 6174 682e 0a20   worker death.. 
-0000b100: 2020 2023 3a0a 2020 2020 233a 2053 6f6d     #:.    #: Som
-0000b110: 6520 7461 736b 7320 6d61 7920 6361 7573  e tasks may caus
-0000b120: 6520 776f 726b 6572 7320 746f 2064 6965  e workers to die
-0000b130: 2028 7375 6368 2061 7320 6361 6c6c 696e   (such as callin
-0000b140: 6720 6060 6f73 2e5f 6578 6974 2830 2960  g ``os._exit(0)`
-0000b150: 6029 2e20 5768 656e 2061 0a20 2020 2023  `). When a.    #
-0000b160: 3a20 776f 726b 6572 2064 6965 732c 2061  : worker dies, a
-0000b170: 6c6c 206f 6620 7468 6520 7461 736b 7320  ll of the tasks 
-0000b180: 6f6e 2074 6861 7420 776f 726b 6572 2061  on that worker a
-0000b190: 7265 2072 6561 7373 6967 6e65 6420 746f  re reassigned to
-0000b1a0: 206f 7468 6572 732e 2054 6869 730a 2020   others. This.  
-0000b1b0: 2020 233a 2063 6f6d 6269 6e61 7469 6f6e    #: combination
-0000b1c0: 206f 6620 6265 6861 7669 6f72 7320 6361   of behaviors ca
-0000b1d0: 6e20 6361 7573 6520 6120 6261 6420 7461  n cause a bad ta
-0000b1e0: 736b 2074 6f20 6361 7461 7374 726f 7068  sk to catastroph
-0000b1f0: 6963 616c 6c79 2064 6573 7472 6f79 2061  ically destroy a
-0000b200: 6c6c 0a20 2020 2023 3a20 776f 726b 6572  ll.    #: worker
-0000b210: 7320 6f6e 2074 6865 2063 6c75 7374 6572  s on the cluster
-0000b220: 2c20 6f6e 6520 6166 7465 7220 616e 6f74  , one after anot
-0000b230: 6865 722e 2057 6865 6e65 7665 7220 6120  her. Whenever a 
-0000b240: 776f 726b 6572 2064 6965 732c 2077 6520  worker dies, we 
-0000b250: 6d61 726b 2065 6163 680a 2020 2020 233a  mark each.    #:
-0000b260: 2074 6173 6b20 6375 7272 656e 746c 7920   task currently 
-0000b270: 7072 6f63 6573 7369 6e67 206f 6e20 7468  processing on th
-0000b280: 6174 2077 6f72 6b65 7220 2861 7320 7265  at worker (as re
-0000b290: 636f 7264 6564 2062 790a 2020 2020 233a  corded by.    #:
-0000b2a0: 203a 6174 7472 3a60 576f 726b 6572 5374   :attr:`WorkerSt
-0000b2b0: 6174 652e 7072 6f63 6573 7369 6e67 6029  ate.processing`)
-0000b2c0: 2061 7320 7375 7370 6963 696f 7573 2e20   as suspicious. 
-0000b2d0: 4966 2061 2074 6173 6b20 6973 2069 6e76  If a task is inv
-0000b2e0: 6f6c 7665 6420 696e 2074 6872 6565 0a20  olved in three. 
-0000b2f0: 2020 2023 3a20 6465 6174 6873 2028 6f72     #: deaths (or
-0000b300: 2073 6f6d 6520 6f74 6865 7220 6669 7865   some other fixe
-0000b310: 6420 636f 6e73 7461 6e74 2920 7468 656e  d constant) then
-0000b320: 2077 6520 6d61 726b 2074 6865 2074 6173   we mark the tas
-0000b330: 6b20 6173 2060 6065 7272 6564 6060 2e0a  k as ``erred``..
-0000b340: 2020 2020 7375 7370 6963 696f 7573 3a20      suspicious: 
-0000b350: 696e 740a 0a20 2020 2023 3a20 4120 7365  int..    #: A se
-0000b360: 7420 6f66 2068 6f73 746e 616d 6573 2077  t of hostnames w
-0000b370: 6865 7265 2074 6869 7320 7461 736b 2063  here this task c
-0000b380: 616e 2062 6520 7275 6e20 286f 7220 6060  an be run (or ``
-0000b390: 4e6f 6e65 6060 2069 6620 656d 7074 7929  None`` if empty)
-0000b3a0: 2e20 5573 7561 6c6c 790a 2020 2020 233a  . Usually.    #:
-0000b3b0: 2074 6869 7320 6973 2065 6d70 7479 2075   this is empty u
-0000b3c0: 6e6c 6573 7320 7468 6520 7461 736b 2068  nless the task h
-0000b3d0: 6173 2062 6565 6e20 7370 6563 6966 6963  as been specific
-0000b3e0: 616c 6c79 2072 6573 7472 6963 7465 6420  ally restricted 
-0000b3f0: 746f 206f 6e6c 7920 7275 6e20 6f6e 0a20  to only run on. 
-0000b400: 2020 2023 3a20 6365 7274 6169 6e20 686f     #: certain ho
-0000b410: 7374 732e 2041 2068 6f73 746e 616d 6520  sts. A hostname 
-0000b420: 6d61 7920 636f 7272 6573 706f 6e64 2074  may correspond t
-0000b430: 6f20 6f6e 6520 6f72 2073 6576 6572 616c  o one or several
-0000b440: 2063 6f6e 6e65 6374 6564 2077 6f72 6b65   connected worke
-0000b450: 7273 2e0a 2020 2020 686f 7374 5f72 6573  rs..    host_res
-0000b460: 7472 6963 7469 6f6e 733a 2073 6574 5b73  trictions: set[s
-0000b470: 7472 5d20 7c20 4e6f 6e65 0a0a 2020 2020  tr] | None..    
-0000b480: 233a 2041 2073 6574 206f 6620 636f 6d70  #: A set of comp
-0000b490: 6c65 7465 2077 6f72 6b65 7220 6164 6472  lete worker addr
-0000b4a0: 6573 7365 7320 7768 6572 6520 7468 6973  esses where this
-0000b4b0: 2063 616e 2062 6520 7275 6e20 286f 7220   can be run (or 
-0000b4c0: 6060 4e6f 6e65 6060 2069 6620 656d 7074  ``None`` if empt
-0000b4d0: 7929 2e0a 2020 2020 233a 2055 7375 616c  y)..    #: Usual
-0000b4e0: 6c79 2074 6869 7320 6973 2065 6d70 7479  ly this is empty
-0000b4f0: 2075 6e6c 6573 7320 7468 6520 7461 736b   unless the task
-0000b500: 2068 6173 2062 6565 6e20 7370 6563 6966   has been specif
-0000b510: 6963 616c 6c79 2072 6573 7472 6963 7465  ically restricte
-0000b520: 6420 746f 206f 6e6c 790a 2020 2020 233a  d to only.    #:
-0000b530: 2072 756e 206f 6e20 6365 7274 6169 6e20   run on certain 
-0000b540: 776f 726b 6572 732e 0a20 2020 2023 3a20  workers..    #: 
-0000b550: 4e6f 7465 2074 6869 7320 6973 2074 7261  Note this is tra
-0000b560: 636b 696e 6720 776f 726b 6572 2061 6464  cking worker add
-0000b570: 7265 7373 6573 2c20 6e6f 7420 776f 726b  resses, not work
-0000b580: 6572 2073 7461 7465 732c 2073 696e 6365  er states, since
-0000b590: 2074 6865 2073 7065 6369 6669 630a 2020   the specific.  
-0000b5a0: 2020 233a 2077 6f72 6b65 7273 206d 6179    #: workers may
-0000b5b0: 206e 6f74 2062 6520 636f 6e6e 6563 7465   not be connecte
-0000b5c0: 6420 6174 2074 6869 7320 7469 6d65 2e0a  d at this time..
-0000b5d0: 2020 2020 776f 726b 6572 5f72 6573 7472      worker_restr
-0000b5e0: 6963 7469 6f6e 733a 2073 6574 5b73 7472  ictions: set[str
-0000b5f0: 5d20 7c20 4e6f 6e65 0a0a 2020 2020 233a  ] | None..    #:
-0000b600: 2052 6573 6f75 7263 6573 2072 6571 7569   Resources requi
-0000b610: 7265 6420 6279 2074 6869 7320 7461 736b  red by this task
-0000b620: 2c20 7375 6368 2061 7320 6060 7b27 6770  , such as ``{'gp
-0000b630: 7527 3a20 317d 6060 206f 7220 6060 7b27  u': 1}`` or ``{'
-0000b640: 6d65 6d6f 7279 273a 2031 6539 7d60 600a  memory': 1e9}``.
-0000b650: 2020 2020 233a 2054 6865 7365 2061 7265      #: These are
-0000b660: 2075 7365 722d 6465 6669 6e65 6420 6e61   user-defined na
-0000b670: 6d65 7320 616e 6420 6172 6520 6d61 7463  mes and are matc
-0000b680: 6865 6420 6167 6169 6e73 7420 7468 6520  hed against the 
-0000b690: 3a20 636f 6e74 656e 7473 206f 6620 6561  : contents of ea
-0000b6a0: 6368 0a20 2020 2023 3a20 3a61 7474 723a  ch.    #: :attr:
-0000b6b0: 6057 6f72 6b65 7253 7461 7465 2e72 6573  `WorkerState.res
-0000b6c0: 6f75 7263 6573 6020 6469 6374 696f 6e61  ources` dictiona
-0000b6d0: 7279 2e0a 2020 2020 7265 736f 7572 6365  ry..    resource
-0000b6e0: 5f72 6573 7472 6963 7469 6f6e 733a 2064  _restrictions: d
-0000b6f0: 6963 745b 7374 722c 2066 6c6f 6174 5d20  ict[str, float] 
-0000b700: 7c20 4e6f 6e65 0a0a 2020 2020 233a 2046  | None..    #: F
-0000b710: 616c 7365 0a20 2020 2023 3a20 2020 2020  alse.    #:     
-0000b720: 4561 6368 206f 6620 3a61 7474 723a 6068  Each of :attr:`h
-0000b730: 6f73 745f 7265 7374 7269 6374 696f 6e73  ost_restrictions
-0000b740: 602c 203a 6174 7472 3a60 776f 726b 6572  `, :attr:`worker
-0000b750: 5f72 6573 7472 6963 7469 6f6e 7360 2061  _restrictions` a
-0000b760: 6e64 0a20 2020 2023 3a20 2020 2020 3a61  nd.    #:     :a
-0000b770: 7474 723a 6072 6573 6f75 7263 655f 7265  ttr:`resource_re
-0000b780: 7374 7269 6374 696f 6e73 6020 6973 2061  strictions` is a
-0000b790: 2068 6172 6420 636f 6e73 7472 6169 6e74   hard constraint
-0000b7a0: 3a20 6966 206e 6f20 776f 726b 6572 2069  : if no worker i
-0000b7b0: 7320 6176 6169 6c61 626c 650a 2020 2020  s available.    
-0000b7c0: 233a 2020 2020 2073 6174 6973 6679 696e  #:     satisfyin
-0000b7d0: 6720 7468 6f73 6520 7265 7374 7269 6374  g those restrict
-0000b7e0: 696f 6e73 2c20 7468 6520 7461 736b 2063  ions, the task c
-0000b7f0: 616e 6e6f 7420 676f 2069 6e74 6f20 7468  annot go into th
-0000b800: 6520 2270 726f 6365 7373 696e 6722 2073  e "processing" s
-0000b810: 7461 7465 0a20 2020 2023 3a20 2020 2020  tate.    #:     
-0000b820: 616e 6420 7769 6c6c 2069 6e73 7465 6164  and will instead
-0000b830: 2067 6f20 696e 746f 2074 6865 2022 6e6f   go into the "no
-0000b840: 2d77 6f72 6b65 7222 2073 7461 7465 2e0a  -worker" state..
-0000b850: 2020 2020 233a 2054 7275 650a 2020 2020      #: True.    
-0000b860: 233a 2020 2020 2054 6865 2061 626f 7665  #:     The above
-0000b870: 2072 6573 7472 6963 7469 6f6e 7320 6172   restrictions ar
-0000b880: 6520 6d65 7265 2070 7265 6665 7265 6e63  e mere preferenc
-0000b890: 6573 3a20 6966 206e 6f20 776f 726b 6572  es: if no worker
-0000b8a0: 2069 7320 6176 6169 6c61 626c 650a 2020   is available.  
-0000b8b0: 2020 233a 2020 2020 2073 6174 6973 6679    #:     satisfy
-0000b8c0: 696e 6720 7468 6f73 6520 7265 7374 7269  ing those restri
-0000b8d0: 6374 696f 6e73 2c20 7468 6520 7461 736b  ctions, the task
-0000b8e0: 2063 616e 2073 7469 6c6c 2067 6f20 696e   can still go in
-0000b8f0: 746f 2074 6865 0a20 2020 2023 3a20 2020  to the.    #:   
-0000b900: 2020 2270 726f 6365 7373 696e 6722 2073    "processing" s
-0000b910: 7461 7465 2061 6e64 2062 6520 7365 6e74  tate and be sent
-0000b920: 2066 6f72 2065 7865 6375 7469 6f6e 2074   for execution t
-0000b930: 6f20 616e 6f74 6865 7220 636f 6e6e 6563  o another connec
-0000b940: 7465 6420 776f 726b 6572 2e0a 2020 2020  ted worker..    
-0000b950: 6c6f 6f73 655f 7265 7374 7269 6374 696f  loose_restrictio
-0000b960: 6e73 3a20 626f 6f6c 0a0a 2020 2020 233a  ns: bool..    #:
-0000b970: 2057 6865 7468 6572 2074 6869 7320 7461   Whether this ta
-0000b980: 736b 2069 7320 616e 2041 6374 6f72 0a20  sk is an Actor. 
-0000b990: 2020 2061 6374 6f72 3a20 626f 6f6c 0a0a     actor: bool..
-0000b9a0: 2020 2020 233a 2054 6865 2067 726f 7570      #: The group
-0000b9b0: 206f 6620 7461 736b 7320 746f 2077 6869   of tasks to whi
-0000b9c0: 6368 2074 6869 7320 6f6e 6520 6265 6c6f  ch this one belo
-0000b9d0: 6e67 730a 2020 2020 6772 6f75 703a 2054  ngs.    group: T
-0000b9e0: 6173 6b47 726f 7570 0a0a 2020 2020 233a  askGroup..    #:
-0000b9f0: 2053 616d 6520 6173 206f 6620 6772 6f75   Same as of grou
-0000ba00: 702e 6e61 6d65 0a20 2020 2067 726f 7570  p.name.    group
-0000ba10: 5f6b 6579 3a20 7374 720a 0a20 2020 2023  _key: str..    #
-0000ba20: 3a20 4d65 7461 6461 7461 2072 656c 6174  : Metadata relat
-0000ba30: 6564 2074 6f20 7461 736b 0a20 2020 206d  ed to task.    m
-0000ba40: 6574 6164 6174 613a 2064 6963 745b 7374  etadata: dict[st
-0000ba50: 722c 2041 6e79 5d20 7c20 4e6f 6e65 0a0a  r, Any] | None..
-0000ba60: 2020 2020 233a 2054 6173 6b20 616e 6e6f      #: Task anno
-0000ba70: 7461 7469 6f6e 730a 2020 2020 616e 6e6f  tations.    anno
-0000ba80: 7461 7469 6f6e 733a 2064 6963 745b 7374  tations: dict[st
-0000ba90: 722c 2041 6e79 5d20 7c20 4e6f 6e65 0a0a  r, Any] | None..
-0000baa0: 2020 2020 233a 2054 6865 2075 6e69 7175      #: The uniqu
-0000bab0: 6520 6964 656e 7469 6669 6572 206f 6620  e identifier of 
-0000bac0: 6120 7370 6563 6966 6963 2065 7865 6375  a specific execu
-0000bad0: 7469 6f6e 206f 6620 6120 7461 736b 2e20  tion of a task. 
-0000bae0: 5468 6973 2069 6465 6e74 6966 6965 720a  This identifier.
-0000baf0: 2020 2020 233a 2069 7320 7573 6564 2074      #: is used t
-0000bb00: 6f20 7369 676e 2061 2074 6173 6b20 7375  o sign a task su
-0000bb10: 6368 2074 6861 7420 7468 6520 6173 7369  ch that the assi
-0000bb20: 676e 6564 2077 6f72 6b65 7220 6973 2065  gned worker is e
-0000bb30: 7870 6563 7465 6420 746f 2072 6574 7572  xpected to retur
-0000bb40: 6e0a 2020 2020 233a 2074 6865 2073 616d  n.    #: the sam
-0000bb50: 6520 6964 656e 7469 6669 6572 2069 6e20  e identifier in 
-0000bb60: 7468 6520 7461 736b 2d66 696e 6973 6865  the task-finishe
-0000bb70: 6420 6d65 7373 6167 652e 2054 6869 7320  d message. This 
-0000bb80: 6973 2075 7365 6420 746f 2063 6f72 7265  is used to corre
-0000bb90: 6c61 7465 0a20 2020 2023 3a20 7265 7370  late.    #: resp
-0000bba0: 6f6e 7365 732e 0a20 2020 2023 3a20 4f6e  onses..    #: On
-0000bbb0: 6c79 2074 6865 206d 6f73 7420 7265 6365  ly the most rece
-0000bbc0: 6e74 6c79 2061 7373 6967 6e65 6420 776f  ntly assigned wo
-0000bbd0: 726b 6572 2069 7320 7472 7573 7465 642e  rker is trusted.
-0000bbe0: 2041 6c6c 206f 7468 6572 2072 6573 756c   All other resul
-0000bbf0: 7473 2077 696c 6c0a 2020 2020 233a 2062  ts will.    #: b
-0000bc00: 6520 7265 6a65 6374 6564 2e0a 2020 2020  e rejected..    
-0000bc10: 7275 6e5f 6964 3a20 696e 7420 7c20 4e6f  run_id: int | No
-0000bc20: 6e65 0a0a 2020 2020 233a 2057 6865 7468  ne..    #: Wheth
-0000bc30: 6572 2074 6f20 636f 6e73 6964 6572 2074  er to consider t
-0000bc40: 6869 7320 7461 736b 2072 6f6f 7469 7368  his task rootish
-0000bc50: 2069 6e20 7468 6520 636f 6e74 6578 7420   in the context 
-0000bc60: 6f66 2074 6173 6b20 7175 6575 6569 6e67  of task queueing
-0000bc70: 0a20 2020 2023 3a20 5472 7565 0a20 2020  .    #: True.   
-0000bc80: 2023 3a20 2020 2020 416c 7761 7973 2063   #:     Always c
-0000bc90: 6f6e 7369 6465 7220 7468 6973 2074 6173  onsider this tas
-0000bca0: 6b20 726f 6f74 6973 680a 2020 2020 233a  k rootish.    #:
-0000bcb0: 2046 616c 7365 0a20 2020 2023 3a20 2020   False.    #:   
-0000bcc0: 2020 4e65 7665 7220 636f 6e73 6964 6572    Never consider
-0000bcd0: 2074 6869 7320 7461 736b 2072 6f6f 7469   this task rooti
-0000bce0: 7368 0a20 2020 2023 3a20 4e6f 6e65 0a20  sh.    #: None. 
-0000bcf0: 2020 2023 3a20 2020 2020 5573 6520 6120     #:     Use a 
-0000bd00: 6865 7572 6973 7469 6320 746f 2064 6574  heuristic to det
-0000bd10: 6572 6d69 6e65 2077 6865 7468 6572 2074  ermine whether t
-0000bd20: 6869 7320 7461 736b 2073 686f 756c 6420  his task should 
-0000bd30: 6265 2063 6f6e 7369 6465 7265 6420 726f  be considered ro
-0000bd40: 6f74 6973 680a 2020 2020 5f72 6f6f 7469  otish.    _rooti
-0000bd50: 7368 3a20 626f 6f6c 207c 204e 6f6e 650a  sh: bool | None.
-0000bd60: 0a20 2020 2023 3a20 4361 6368 6564 2068  .    #: Cached h
-0000bd70: 6173 6820 6f66 203a 6174 7472 3a60 7e54  ash of :attr:`~T
-0000bd80: 6173 6b53 7461 7465 2e63 6c69 656e 745f  askState.client_
-0000bd90: 6b65 7960 0a20 2020 205f 6861 7368 3a20  key`.    _hash: 
-0000bda0: 696e 740a 0a20 2020 2023 2053 7570 706f  int..    # Suppo
-0000bdb0: 7274 2066 6f72 2077 6561 6b72 6566 7320  rt for weakrefs 
-0000bdc0: 746f 2061 2063 6c61 7373 2077 6974 6820  to a class with 
-0000bdd0: 5f5f 736c 6f74 735f 5f0a 2020 2020 5f5f  __slots__.    __
-0000bde0: 7765 616b 7265 665f 5f3a 2041 6e79 203d  weakref__: Any =
-0000bdf0: 204e 6f6e 650a 2020 2020 5f5f 736c 6f74   None.    __slot
-0000be00: 735f 5f20 3d20 7475 706c 6528 5f5f 616e  s__ = tuple(__an
-0000be10: 6e6f 7461 7469 6f6e 735f 5f29 0a0a 2020  notations__)..  
-0000be20: 2020 233a 2047 6c6f 6261 6c20 6974 6572    #: Global iter
-0000be30: 6174 6f72 2075 7365 6420 746f 2063 7265  ator used to cre
-0000be40: 6174 6520 756e 6971 7565 2074 6173 6b20  ate unique task 
-0000be50: 7275 6e20 4944 730a 2020 2020 5f72 756e  run IDs.    _run
-0000be60: 5f69 645f 6974 6572 6174 6f72 3a20 436c  _id_iterator: Cl
-0000be70: 6173 7356 6172 5b69 7465 7274 6f6f 6c73  assVar[itertools
-0000be80: 2e63 6f75 6e74 5d20 3d20 6974 6572 746f  .count] = iterto
-0000be90: 6f6c 732e 636f 756e 7428 290a 0a20 2020  ols.count()..   
-0000bea0: 2023 2049 6e73 7461 6e63 6573 206e 6f74   # Instances not
-0000beb0: 2070 6172 7420 6f66 2073 6c6f 7473 2073   part of slots s
-0000bec0: 696e 6365 2063 6c61 7373 2076 6172 6961  ince class varia
-0000bed0: 626c 650a 2020 2020 5f69 6e73 7461 6e63  ble.    _instanc
-0000bee0: 6573 3a20 436c 6173 7356 6172 5b77 6561  es: ClassVar[wea
-0000bef0: 6b72 6566 2e57 6561 6b53 6574 5b54 6173  kref.WeakSet[Tas
-0000bf00: 6b53 7461 7465 5d5d 203d 2077 6561 6b72  kState]] = weakr
-0000bf10: 6566 2e57 6561 6b53 6574 2829 0a0a 2020  ef.WeakSet()..  
-0000bf20: 2020 6465 6620 5f5f 696e 6974 5f5f 280a    def __init__(.
-0000bf30: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
-0000bf40: 2020 2020 2020 6b65 793a 204b 6579 2c0a        key: Key,.
-0000bf50: 2020 2020 2020 2020 7275 6e5f 7370 6563          run_spec
-0000bf60: 3a20 545f 7275 6e73 7065 6320 7c20 4e6f  : T_runspec | No
-0000bf70: 6e65 2c0a 2020 2020 2020 2020 7374 6174  ne,.        stat
-0000bf80: 653a 2054 6173 6b53 7461 7465 5374 6174  e: TaskStateStat
-0000bf90: 652c 0a20 2020 2029 3a0a 2020 2020 2020  e,.    ):.      
-0000bfa0: 2020 2320 4d6f 7374 206f 6620 7468 6520    # Most of the 
-0000bfb0: 6174 7472 6962 7574 6573 2062 656c 6f77  attributes below
-0000bfc0: 2061 7265 206e 6f74 2069 6e69 7469 616c   are not initial
-0000bfd0: 697a 6564 2073 696e 6365 2074 6865 7265  ized since there
-0000bfe0: 2061 7265 206e 6f74 0a20 2020 2020 2020   are not.       
-0000bff0: 2023 2061 6c77 6179 7320 7265 7175 6972   # always requir
-0000c000: 6564 2066 6f72 2065 7665 7279 2074 6173  ed for every tas
-0000c010: 6b73 2e20 5061 7274 6963 756c 6172 6c79  ks. Particularly
-0000c020: 2066 6f72 206c 6172 6765 2067 7261 7068   for large graph
-0000c030: 732c 2074 6865 7365 0a20 2020 2020 2020  s, these.       
-0000c040: 2023 2063 616e 2061 6464 2075 7020 7369   # can add up si
-0000c050: 676e 6966 6963 616e 7420 6d65 6d6f 7279  gnificant memory
-0000c060: 2c20 7365 650a 2020 2020 2020 2020 2320  , see.        # 
-0000c070: 6874 7470 733a 2f2f 6769 7468 7562 2e63  https://github.c
-0000c080: 6f6d 2f64 6173 6b2f 6469 7374 7269 6275  om/dask/distribu
-0000c090: 7465 642f 7075 6c6c 2f38 3333 310a 2020  ted/pull/8331.  
-0000c0a0: 2020 2020 2020 2320 6874 7470 733a 2f2f        # https://
-0000c0b0: 6769 7468 7562 2e63 6f6d 2f64 6173 6b2f  github.com/dask/
-0000c0c0: 6469 7374 7269 6275 7465 642f 6973 7375  distributed/issu
-0000c0d0: 6573 2f37 3939 3823 6973 7375 6563 6f6d  es/7998#issuecom
-0000c0e0: 6d65 6e74 2d31 3637 3731 3637 3437 380a  ment-1677167478.
-0000c0f0: 2020 2020 2020 2020 7365 6c66 2e6b 6579          self.key
-0000c100: 203d 206b 6579 0a20 2020 2020 2020 2073   = key.        s
-0000c110: 656c 662e 5f68 6173 6820 3d20 6861 7368  elf._hash = hash
-0000c120: 286b 6579 290a 2020 2020 2020 2020 7365  (key).        se
-0000c130: 6c66 2e72 756e 5f73 7065 6320 3d20 7275  lf.run_spec = ru
-0000c140: 6e5f 7370 6563 0a20 2020 2020 2020 2073  n_spec.        s
-0000c150: 656c 662e 5f73 7461 7465 203d 2073 7461  elf._state = sta
-0000c160: 7465 0a20 2020 2020 2020 2073 656c 662e  te.        self.
-0000c170: 6578 6365 7074 696f 6e20 3d20 4e6f 6e65  exception = None
-0000c180: 0a20 2020 2020 2020 2073 656c 662e 6578  .        self.ex
-0000c190: 6365 7074 696f 6e5f 626c 616d 6520 3d20  ception_blame = 
-0000c1a0: 4e6f 6e65 0a20 2020 2020 2020 2073 656c  None.        sel
-0000c1b0: 662e 7472 6163 6562 6163 6b20 3d20 4e6f  f.traceback = No
-0000c1c0: 6e65 0a20 2020 2020 2020 2073 656c 662e  ne.        self.
-0000c1d0: 6578 6365 7074 696f 6e5f 7465 7874 203d  exception_text =
-0000c1e0: 204e 6f6e 650a 2020 2020 2020 2020 7365   None.        se
-0000c1f0: 6c66 2e74 7261 6365 6261 636b 5f74 6578  lf.traceback_tex
-0000c200: 7420 3d20 4e6f 6e65 0a20 2020 2020 2020  t = None.       
-0000c210: 2073 656c 662e 7375 7370 6963 696f 7573   self.suspicious
-0000c220: 203d 2030 0a20 2020 2020 2020 2073 656c   = 0.        sel
-0000c230: 662e 7265 7472 6965 7320 3d20 300a 2020  f.retries = 0.  
-0000c240: 2020 2020 2020 7365 6c66 2e6e 6279 7465        self.nbyte
-0000c250: 7320 3d20 2d31 0a20 2020 2020 2020 2073  s = -1.        s
-0000c260: 656c 662e 7072 696f 7269 7479 203d 204e  elf.priority = N
-0000c270: 6f6e 650a 2020 2020 2020 2020 7365 6c66  one.        self
-0000c280: 2e77 686f 5f77 616e 7473 203d 204e 6f6e  .who_wants = Non
-0000c290: 650a 2020 2020 2020 2020 7365 6c66 2e64  e.        self.d
-0000c2a0: 6570 656e 6465 6e63 6965 7320 3d20 7365  ependencies = se
-0000c2b0: 7428 290a 2020 2020 2020 2020 7365 6c66  t().        self
-0000c2c0: 2e64 6570 656e 6465 6e74 7320 3d20 7365  .dependents = se
-0000c2d0: 7428 290a 2020 2020 2020 2020 7365 6c66  t().        self
-0000c2e0: 2e77 6169 7469 6e67 5f6f 6e20 3d20 4e6f  .waiting_on = No
-0000c2f0: 6e65 0a20 2020 2020 2020 2073 656c 662e  ne.        self.
-0000c300: 7761 6974 6572 7320 3d20 4e6f 6e65 0a20  waiters = None. 
-0000c310: 2020 2020 2020 2073 656c 662e 7768 6f5f         self.who_
-0000c320: 6861 7320 3d20 4e6f 6e65 0a20 2020 2020  has = None.     
-0000c330: 2020 2073 656c 662e 7072 6f63 6573 7369     self.processi
-0000c340: 6e67 5f6f 6e20 3d20 4e6f 6e65 0a20 2020  ng_on = None.   
-0000c350: 2020 2020 2073 656c 662e 6861 735f 6c6f       self.has_lo
-0000c360: 7374 5f64 6570 656e 6465 6e63 6965 7320  st_dependencies 
-0000c370: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
-0000c380: 7365 6c66 2e68 6f73 745f 7265 7374 7269  self.host_restri
-0000c390: 6374 696f 6e73 203d 204e 6f6e 650a 2020  ctions = None.  
-0000c3a0: 2020 2020 2020 7365 6c66 2e77 6f72 6b65        self.worke
-0000c3b0: 725f 7265 7374 7269 6374 696f 6e73 203d  r_restrictions =
-0000c3c0: 204e 6f6e 650a 2020 2020 2020 2020 7365   None.        se
-0000c3d0: 6c66 2e72 6573 6f75 7263 655f 7265 7374  lf.resource_rest
-0000c3e0: 7269 6374 696f 6e73 203d 204e 6f6e 650a  rictions = None.
-0000c3f0: 2020 2020 2020 2020 7365 6c66 2e6c 6f6f          self.loo
-0000c400: 7365 5f72 6573 7472 6963 7469 6f6e 7320  se_restrictions 
-0000c410: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
-0000c420: 7365 6c66 2e61 6374 6f72 203d 2046 616c  self.actor = Fal
-0000c430: 7365 0a20 2020 2020 2020 2073 656c 662e  se.        self.
-0000c440: 7072 6566 6978 203d 204e 6f6e 6520 2023  prefix = None  #
-0000c450: 2074 7970 653a 2069 676e 6f72 650a 2020   type: ignore.  
-0000c460: 2020 2020 2020 7365 6c66 2e74 7970 6520        self.type 
-0000c470: 3d20 4e6f 6e65 2020 2320 7479 7065 3a20  = None  # type: 
-0000c480: 6967 6e6f 7265 0a20 2020 2020 2020 2073  ignore.        s
-0000c490: 656c 662e 6772 6f75 705f 6b65 7920 3d20  elf.group_key = 
-0000c4a0: 6b65 795f 7370 6c69 745f 6772 6f75 7028  key_split_group(
-0000c4b0: 6b65 7929 0a20 2020 2020 2020 2073 656c  key).        sel
-0000c4c0: 662e 6772 6f75 7020 3d20 4e6f 6e65 2020  f.group = None  
-0000c4d0: 2320 7479 7065 3a20 6967 6e6f 7265 0a20  # type: ignore. 
-0000c4e0: 2020 2020 2020 2073 656c 662e 6d65 7461         self.meta
-0000c4f0: 6461 7461 203d 204e 6f6e 650a 2020 2020  data = None.    
-0000c500: 2020 2020 7365 6c66 2e61 6e6e 6f74 6174      self.annotat
-0000c510: 696f 6e73 203d 204e 6f6e 650a 2020 2020  ions = None.    
-0000c520: 2020 2020 7365 6c66 2e65 7272 6564 5f6f      self.erred_o
-0000c530: 6e20 3d20 4e6f 6e65 0a20 2020 2020 2020  n = None.       
-0000c540: 2073 656c 662e 5f72 6f6f 7469 7368 203d   self._rootish =
-0000c550: 204e 6f6e 650a 2020 2020 2020 2020 7365   None.        se
-0000c560: 6c66 2e72 756e 5f69 6420 3d20 4e6f 6e65  lf.run_id = None
-0000c570: 0a20 2020 2020 2020 2054 6173 6b53 7461  .        TaskSta
-0000c580: 7465 2e5f 696e 7374 616e 6365 732e 6164  te._instances.ad
-0000c590: 6428 7365 6c66 290a 0a20 2020 2064 6566  d(self)..    def
-0000c5a0: 205f 5f68 6173 685f 5f28 7365 6c66 2920   __hash__(self) 
-0000c5b0: 2d3e 2069 6e74 3a0a 2020 2020 2020 2020  -> int:.        
-0000c5c0: 7265 7475 726e 2073 656c 662e 5f68 6173  return self._has
-0000c5d0: 680a 0a20 2020 2064 6566 205f 5f65 715f  h..    def __eq_
-0000c5e0: 5f28 7365 6c66 2c20 6f74 6865 723a 206f  _(self, other: o
-0000c5f0: 626a 6563 7429 202d 3e20 626f 6f6c 3a0a  bject) -> bool:.
-0000c600: 2020 2020 2020 2020 7265 7475 726e 2069          return i
-0000c610: 7369 6e73 7461 6e63 6528 6f74 6865 722c  sinstance(other,
-0000c620: 2054 6173 6b53 7461 7465 2920 616e 6420   TaskState) and 
-0000c630: 7365 6c66 2e6b 6579 203d 3d20 6f74 6865  self.key == othe
-0000c640: 722e 6b65 790a 0a20 2020 2040 7072 6f70  r.key..    @prop
-0000c650: 6572 7479 0a20 2020 2064 6566 2073 7461  erty.    def sta
-0000c660: 7465 2873 656c 6629 202d 3e20 5461 736b  te(self) -> Task
-0000c670: 5374 6174 6553 7461 7465 3a0a 2020 2020  StateState:.    
-0000c680: 2020 2020 2222 2254 6869 7320 7461 736b      """This task
-0000c690: 2773 2063 7572 7265 6e74 2073 7461 7465  's current state
-0000c6a0: 2e20 2056 616c 6964 2073 7461 7465 7320  .  Valid states 
-0000c6b0: 6172 6520 6060 7265 6c65 6173 6564 6060  are ``released``
-0000c6c0: 2c20 6060 7761 6974 696e 6760 602c 0a20  , ``waiting``,. 
-0000c6d0: 2020 2020 2020 2060 606e 6f2d 776f 726b         ``no-work
-0000c6e0: 6572 6060 2c20 6060 7072 6f63 6573 7369  er``, ``processi
-0000c6f0: 6e67 6060 2c20 6060 6d65 6d6f 7279 6060  ng``, ``memory``
-0000c700: 2c20 6060 6572 7265 6460 6020 616e 6420  , ``erred`` and 
-0000c710: 6060 666f 7267 6f74 7465 6e60 602e 2020  ``forgotten``.  
-0000c720: 4966 2069 740a 2020 2020 2020 2020 6973  If it.        is
-0000c730: 2060 6066 6f72 676f 7474 656e 6060 2c20   ``forgotten``, 
-0000c740: 7468 6520 7461 736b 2069 736e 2774 2073  the task isn't s
-0000c750: 746f 7265 6420 696e 2074 6865 2060 6074  tored in the ``t
-0000c760: 6173 6b73 6060 2064 6963 7469 6f6e 6172  asks`` dictionar
-0000c770: 7920 616e 796d 6f72 6520 616e 640a 2020  y anymore and.  
-0000c780: 2020 2020 2020 7769 6c6c 2070 726f 6261        will proba
-0000c790: 626c 7920 6469 7361 7070 6561 7220 736f  bly disappear so
-0000c7a0: 6f6e 2066 726f 6d20 6d65 6d6f 7279 2e0a  on from memory..
-0000c7b0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0000c7c0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-0000c7d0: 5f73 7461 7465 0a0a 2020 2020 4073 7461  _state..    @sta
-0000c7e0: 7465 2e73 6574 7465 720a 2020 2020 6465  te.setter.    de
-0000c7f0: 6620 7374 6174 6528 7365 6c66 2c20 7661  f state(self, va
-0000c800: 6c75 653a 2054 6173 6b53 7461 7465 5374  lue: TaskStateSt
-0000c810: 6174 6529 202d 3e20 4e6f 6e65 3a0a 2020  ate) -> None:.  
-0000c820: 2020 2020 2020 7365 6c66 2e67 726f 7570        self.group
-0000c830: 2e73 7461 7465 735b 7365 6c66 2e5f 7374  .states[self._st
-0000c840: 6174 655d 202d 3d20 310a 2020 2020 2020  ate] -= 1.      
-0000c850: 2020 7365 6c66 2e67 726f 7570 2e73 7461    self.group.sta
-0000c860: 7465 735b 7661 6c75 655d 202b 3d20 310a  tes[value] += 1.
-0000c870: 2020 2020 2020 2020 7365 6c66 2e5f 7374          self._st
-0000c880: 6174 6520 3d20 7661 6c75 650a 2020 2020  ate = value.    
-0000c890: 2020 2020 7365 6c66 2e70 7265 6669 782e      self.prefix.
-0000c8a0: 7374 6174 655f 636f 756e 7473 5b76 616c  state_counts[val
-0000c8b0: 7565 5d20 2b3d 2031 0a0a 2020 2020 6465  ue] += 1..    de
-0000c8c0: 6620 6164 645f 6465 7065 6e64 656e 6379  f add_dependency
-0000c8d0: 2873 656c 662c 206f 7468 6572 3a20 5461  (self, other: Ta
-0000c8e0: 736b 5374 6174 6529 202d 3e20 4e6f 6e65  skState) -> None
-0000c8f0: 3a0a 2020 2020 2020 2020 2222 2241 6464  :.        """Add
-0000c900: 2061 6e6f 7468 6572 2074 6173 6b20 6173   another task as
-0000c910: 2061 2064 6570 656e 6465 6e63 7920 6f66   a dependency of
-0000c920: 2074 6869 7320 7461 736b 2222 220a 2020   this task""".  
-0000c930: 2020 2020 2020 7365 6c66 2e64 6570 656e        self.depen
-0000c940: 6465 6e63 6965 732e 6164 6428 6f74 6865  dencies.add(othe
-0000c950: 7229 0a20 2020 2020 2020 2073 656c 662e  r).        self.
-0000c960: 6772 6f75 702e 6465 7065 6e64 656e 6369  group.dependenci
-0000c970: 6573 2e61 6464 286f 7468 6572 2e67 726f  es.add(other.gro
-0000c980: 7570 290a 2020 2020 2020 2020 6f74 6865  up).        othe
-0000c990: 722e 6465 7065 6e64 656e 7473 2e61 6464  r.dependents.add
-0000c9a0: 2873 656c 6629 0a0a 2020 2020 6465 6620  (self)..    def 
-0000c9b0: 6765 745f 6e62 7974 6573 2873 656c 6629  get_nbytes(self)
-0000c9c0: 202d 3e20 696e 743a 0a20 2020 2020 2020   -> int:.       
-0000c9d0: 2072 6574 7572 6e20 7365 6c66 2e6e 6279   return self.nby
-0000c9e0: 7465 7320 6966 2073 656c 662e 6e62 7974  tes if self.nbyt
-0000c9f0: 6573 203e 3d20 3020 656c 7365 2044 4546  es >= 0 else DEF
-0000ca00: 4155 4c54 5f44 4154 415f 5349 5a45 0a0a  AULT_DATA_SIZE..
-0000ca10: 2020 2020 6465 6620 7365 745f 6e62 7974      def set_nbyt
-0000ca20: 6573 2873 656c 662c 206e 6279 7465 733a  es(self, nbytes:
-0000ca30: 2069 6e74 2920 2d3e 204e 6f6e 653a 0a20   int) -> None:. 
-0000ca40: 2020 2020 2020 2064 6966 6620 3d20 6e62         diff = nb
-0000ca50: 7974 6573 0a20 2020 2020 2020 206f 6c64  ytes.        old
-0000ca60: 5f6e 6279 7465 7320 3d20 7365 6c66 2e6e  _nbytes = self.n
-0000ca70: 6279 7465 730a 2020 2020 2020 2020 6966  bytes.        if
-0000ca80: 206f 6c64 5f6e 6279 7465 7320 3e3d 2030   old_nbytes >= 0
-0000ca90: 3a0a 2020 2020 2020 2020 2020 2020 6469  :.            di
-0000caa0: 6666 202d 3d20 6f6c 645f 6e62 7974 6573  ff -= old_nbytes
-0000cab0: 0a20 2020 2020 2020 2073 656c 662e 6772  .        self.gr
-0000cac0: 6f75 702e 6e62 7974 6573 5f74 6f74 616c  oup.nbytes_total
-0000cad0: 202b 3d20 6469 6666 0a20 2020 2020 2020   += diff.       
-0000cae0: 2066 6f72 2077 7320 696e 2073 656c 662e   for ws in self.
-0000caf0: 7768 6f5f 6861 7320 6f72 2028 293a 0a20  who_has or ():. 
-0000cb00: 2020 2020 2020 2020 2020 2077 732e 6e62             ws.nb
-0000cb10: 7974 6573 202b 3d20 6469 6666 0a20 2020  ytes += diff.   
-0000cb20: 2020 2020 2073 656c 662e 6e62 7974 6573       self.nbytes
-0000cb30: 203d 206e 6279 7465 730a 0a20 2020 2064   = nbytes..    d
-0000cb40: 6566 205f 5f72 6570 725f 5f28 7365 6c66  ef __repr__(self
-0000cb50: 2920 2d3e 2073 7472 3a0a 2020 2020 2020  ) -> str:.      
-0000cb60: 2020 7265 7475 726e 2066 223c 5461 736b    return f"<Task
-0000cb70: 5374 6174 6520 7b73 656c 662e 6b65 7921  State {self.key!
-0000cb80: 727d 207b 7365 6c66 2e5f 7374 6174 657d  r} {self._state}
-0000cb90: 3e22 0a0a 2020 2020 6465 6620 5f72 6570  >"..    def _rep
-0000cba0: 725f 6874 6d6c 5f28 7365 6c66 2920 2d3e  r_html_(self) ->
-0000cbb0: 2073 7472 3a0a 2020 2020 2020 2020 7265   str:.        re
-0000cbc0: 7475 726e 2067 6574 5f74 656d 706c 6174  turn get_templat
-0000cbd0: 6528 2274 6173 6b5f 7374 6174 652e 6874  e("task_state.ht
-0000cbe0: 6d6c 2e6a 3222 292e 7265 6e64 6572 280a  ml.j2").render(.
-0000cbf0: 2020 2020 2020 2020 2020 2020 7374 6174              stat
-0000cc00: 653d 7365 6c66 2e73 7461 7465 2c0a 2020  e=self.state,.  
-0000cc10: 2020 2020 2020 2020 2020 6e62 7974 6573            nbytes
-0000cc20: 3d73 656c 662e 6e62 7974 6573 2c0a 2020  =self.nbytes,.  
-0000cc30: 2020 2020 2020 2020 2020 6b65 793d 7374            key=st
-0000cc40: 7228 7365 6c66 2e6b 6579 292c 0a20 2020  r(self.key),.   
-0000cc50: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
-0000cc60: 7661 6c69 6461 7465 2873 656c 6629 202d  validate(self) -
-0000cc70: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-0000cc80: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-0000cc90: 2066 6f72 2063 7320 696e 2073 656c 662e   for cs in self.
-0000cca0: 7768 6f5f 7761 6e74 7320 6f72 2028 293a  who_wants or ():
-0000ccb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ccc0: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
-0000ccd0: 6365 2863 732c 2043 6c69 656e 7453 7461  ce(cs, ClientSta
-0000cce0: 7465 292c 2028 7265 7072 2863 7329 2c20  te), (repr(cs), 
-0000ccf0: 7365 6c66 2e77 686f 5f77 616e 7473 290a  self.who_wants).
-0000cd00: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0000cd10: 7773 2069 6e20 7365 6c66 2e77 686f 5f68  ws in self.who_h
-0000cd20: 6173 206f 7220 2829 3a0a 2020 2020 2020  as or ():.      
-0000cd30: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0000cd40: 2069 7369 6e73 7461 6e63 6528 7773 2c20   isinstance(ws, 
-0000cd50: 576f 726b 6572 5374 6174 6529 2c20 2872  WorkerState), (r
-0000cd60: 6570 7228 7773 292c 2073 656c 662e 7768  epr(ws), self.wh
-0000cd70: 6f5f 6861 7329 0a20 2020 2020 2020 2020  o_has).         
-0000cd80: 2020 2066 6f72 2074 7320 696e 2073 656c     for ts in sel
-0000cd90: 662e 6465 7065 6e64 656e 6369 6573 3a0a  f.dependencies:.
-0000cda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cdb0: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
-0000cdc0: 6528 7473 2c20 5461 736b 5374 6174 6529  e(ts, TaskState)
-0000cdd0: 2c20 2872 6570 7228 7473 292c 2073 656c  , (repr(ts), sel
-0000cde0: 662e 6465 7065 6e64 656e 6369 6573 290a  f.dependencies).
-0000cdf0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0000ce00: 7473 2069 6e20 7365 6c66 2e64 6570 656e  ts in self.depen
-0000ce10: 6465 6e74 733a 0a20 2020 2020 2020 2020  dents:.         
-0000ce20: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
-0000ce30: 696e 7374 616e 6365 2874 732c 2054 6173  instance(ts, Tas
-0000ce40: 6b53 7461 7465 292c 2028 7265 7072 2874  kState), (repr(t
-0000ce50: 7329 2c20 7365 6c66 2e64 6570 656e 6465  s), self.depende
-0000ce60: 6e74 7329 0a20 2020 2020 2020 2020 2020  nts).           
-0000ce70: 2076 616c 6964 6174 655f 7461 736b 5f73   validate_task_s
-0000ce80: 7461 7465 2873 656c 6629 0a20 2020 2020  tate(self).     
-0000ce90: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
-0000cea0: 696f 6e20 6173 2065 3a0a 2020 2020 2020  ion as e:.      
-0000ceb0: 2020 2020 2020 6c6f 6767 6572 2e65 7863        logger.exc
-0000cec0: 6570 7469 6f6e 2865 290a 2020 2020 2020  eption(e).      
-0000ced0: 2020 2020 2020 6966 204c 4f47 5f50 4442        if LOG_PDB
-0000cee0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000cef0: 2020 696d 706f 7274 2070 6462 0a0a 2020    import pdb..  
-0000cf00: 2020 2020 2020 2020 2020 2020 2020 7064                pd
-0000cf10: 622e 7365 745f 7472 6163 6528 290a 0a20  b.set_trace().. 
-0000cf20: 2020 2064 6566 2067 6574 5f6e 6279 7465     def get_nbyte
-0000cf30: 735f 6465 7073 2873 656c 6629 202d 3e20  s_deps(self) -> 
-0000cf40: 696e 743a 0a20 2020 2020 2020 2072 6574  int:.        ret
-0000cf50: 7572 6e20 7375 6d28 7473 2e67 6574 5f6e  urn sum(ts.get_n
-0000cf60: 6279 7465 7328 2920 666f 7220 7473 2069  bytes() for ts i
-0000cf70: 6e20 7365 6c66 2e64 6570 656e 6465 6e63  n self.dependenc
-0000cf80: 6965 7329 0a0a 2020 2020 6465 6620 5f74  ies)..    def _t
-0000cf90: 6f5f 6469 6374 5f6e 6f5f 6e65 7374 2873  o_dict_no_nest(s
-0000cfa0: 656c 662c 202a 2c20 6578 636c 7564 653a  elf, *, exclude:
-0000cfb0: 2043 6f6e 7461 696e 6572 5b73 7472 5d20   Container[str] 
-0000cfc0: 3d20 2829 2920 2d3e 2064 6963 745b 7374  = ()) -> dict[st
-0000cfd0: 722c 2041 6e79 5d3a 0a20 2020 2020 2020  r, Any]:.       
-0000cfe0: 2022 2222 4469 6374 696f 6e61 7279 2072   """Dictionary r
-0000cff0: 6570 7265 7365 6e74 6174 696f 6e20 666f  epresentation fo
-0000d000: 7220 6465 6275 6767 696e 6720 7075 7270  r debugging purp
-0000d010: 6f73 6573 2e0a 2020 2020 2020 2020 4e6f  oses..        No
-0000d020: 7420 7479 7065 2073 7461 626c 6520 616e  t type stable an
-0000d030: 6420 6e6f 7420 696e 7465 6e64 6564 2066  d not intended f
-0000d040: 6f72 2072 6f75 6e64 7472 6970 732e 0a0a  or roundtrips...
-0000d050: 2020 2020 2020 2020 5365 6520 616c 736f          See also
-0000d060: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
-0000d070: 2d0a 2020 2020 2020 2020 436c 6965 6e74  -.        Client
-0000d080: 2e64 756d 705f 636c 7573 7465 725f 7374  .dump_cluster_st
-0000d090: 6174 650a 2020 2020 2020 2020 6469 7374  ate.        dist
-0000d0a0: 7269 6275 7465 642e 7574 696c 732e 7265  ributed.utils.re
-0000d0b0: 6375 7273 6976 655f 746f 5f64 6963 740a  cursive_to_dict.
-0000d0c0: 0a20 2020 2020 2020 204e 6f74 6573 0a20  .        Notes. 
-0000d0d0: 2020 2020 2020 202d 2d2d 2d2d 0a20 2020         -----.   
-0000d0e0: 2020 2020 2054 6869 7320 636c 6173 7320       This class 
-0000d0f0: 7573 6573 2060 605f 746f 5f64 6963 745f  uses ``_to_dict_
-0000d100: 6e6f 5f6e 6573 7460 6020 696e 7374 6561  no_nest`` instea
-0000d110: 6420 6f66 2060 605f 746f 5f64 6963 7460  d of ``_to_dict`
-0000d120: 602e 0a20 2020 2020 2020 2057 6865 6e20  `..        When 
-0000d130: 6120 7461 736b 2072 6566 6572 656e 6365  a task reference
-0000d140: 7320 616e 6f74 6865 7220 7461 736b 2c20  s another task, 
-0000d150: 6f72 2077 6865 6e20 6120 576f 726b 6572  or when a Worker
-0000d160: 5374 6174 652e 7461 736b 7320 636f 6e74  State.tasks cont
-0000d170: 6169 6e73 2074 6173 6b73 2c0a 2020 2020  ains tasks,.    
-0000d180: 2020 2020 7468 6973 206d 6574 686f 6420      this method 
-0000d190: 6973 206e 6f74 2065 7865 6375 7465 6420  is not executed 
-0000d1a0: 666f 7220 7468 6520 696e 6e65 7220 7461  for the inner ta
-0000d1b0: 736b 2c20 6576 656e 2069 6620 7468 6520  sk, even if the 
-0000d1c0: 696e 6e65 7220 7461 736b 2077 6173 206e  inner task was n
-0000d1d0: 6576 6572 0a20 2020 2020 2020 2073 6565  ever.        see
-0000d1e0: 6e20 6265 666f 7265 3b20 796f 7520 6765  n before; you ge
-0000d1f0: 7420 6120 7265 7072 2069 6e73 7465 6164  t a repr instead
-0000d200: 2e20 416c 6c20 7461 736b 7320 7368 6f75  . All tasks shou
-0000d210: 6c64 206e 6561 746c 7920 6170 7065 6172  ld neatly appear
-0000d220: 2075 6e64 6572 0a20 2020 2020 2020 2053   under.        S
-0000d230: 6368 6564 756c 6572 2e74 6173 6b73 2e20  cheduler.tasks. 
-0000d240: 5468 6973 2061 6c73 6f20 7072 6576 656e  This also preven
-0000d250: 7473 2061 2052 6563 7572 7369 6f6e 4572  ts a RecursionEr
-0000d260: 726f 7220 6475 7269 6e67 2070 6172 7469  ror during parti
-0000d270: 6375 6c61 726c 7920 6865 6176 790a 2020  cularly heavy.  
-0000d280: 2020 2020 2020 6c6f 6164 732c 2077 6869        loads, whi
-0000d290: 6368 2068 6176 6520 6265 656e 206f 6273  ch have been obs
-0000d2a0: 6572 7665 6420 746f 2068 6170 7065 6e20  erved to happen 
-0000d2b0: 7768 656e 6576 6572 2074 6865 7265 2773  whenever there's
-0000d2c0: 2061 6e20 6163 7963 6c69 6320 6465 7065   an acyclic depe
-0000d2d0: 6e64 656e 6379 0a20 2020 2020 2020 2063  ndency.        c
-0000d2e0: 6861 696e 206f 6620 7e32 3030 2b20 7461  hain of ~200+ ta
-0000d2f0: 736b 732e 0a20 2020 2020 2020 2022 2222  sks..        """
-0000d300: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000d310: 7265 6375 7273 6976 655f 746f 5f64 6963  recursive_to_dic
-0000d320: 7428 7365 6c66 2c20 6578 636c 7564 653d  t(self, exclude=
-0000d330: 6578 636c 7564 652c 206d 656d 6265 7273  exclude, members
-0000d340: 3d54 7275 6529 0a0a 0a63 6c61 7373 2054  =True)...class T
-0000d350: 7261 6e73 6974 696f 6e28 4e61 6d65 6454  ransition(NamedT
-0000d360: 7570 6c65 293a 0a20 2020 2022 2222 416e  uple):.    """An
-0000d370: 2065 6e74 7279 2069 6e20 3a61 7474 723a   entry in :attr:
-0000d380: 6053 6368 6564 756c 6572 5374 6174 652e  `SchedulerState.
-0000d390: 7472 616e 7369 7469 6f6e 5f6c 6f67 6022  transition_log`"
-0000d3a0: 2222 0a0a 2020 2020 6b65 793a 204b 6579  ""..    key: Key
-0000d3b0: 0a20 2020 2073 7461 7274 3a20 5461 736b  .    start: Task
-0000d3c0: 5374 6174 6553 7461 7465 0a20 2020 2066  StateState.    f
-0000d3d0: 696e 6973 683a 2054 6173 6b53 7461 7465  inish: TaskState
-0000d3e0: 5374 6174 650a 2020 2020 7265 636f 6d6d  State.    recomm
-0000d3f0: 656e 6461 7469 6f6e 733a 2052 6563 730a  endations: Recs.
-0000d400: 2020 2020 7374 696d 756c 7573 5f69 643a      stimulus_id:
-0000d410: 2073 7472 0a20 2020 2074 696d 6573 7461   str.    timesta
-0000d420: 6d70 3a20 666c 6f61 740a 0a0a 636c 6173  mp: float...clas
-0000d430: 7320 5363 6865 6475 6c65 7253 7461 7465  s SchedulerState
-0000d440: 3a0a 2020 2020 2222 2255 6e64 6572 6c79  :.    """Underly
-0000d450: 696e 6720 7461 736b 2073 7461 7465 206f  ing task state o
-0000d460: 6620 6479 6e61 6d69 6320 7363 6865 6475  f dynamic schedu
-0000d470: 6c65 720a 0a20 2020 2054 7261 636b 7320  ler..    Tracks 
-0000d480: 7468 6520 6375 7272 656e 7420 7374 6174  the current stat
-0000d490: 6520 6f66 2077 6f72 6b65 7273 2c20 6461  e of workers, da
-0000d4a0: 7461 2c20 616e 6420 636f 6d70 7574 6174  ta, and computat
-0000d4b0: 696f 6e73 2e0a 0a20 2020 2048 616e 646c  ions...    Handl
-0000d4c0: 6573 2074 7261 6e73 6974 696f 6e73 2062  es transitions b
-0000d4d0: 6574 7765 656e 2064 6966 6665 7265 6e74  etween different
-0000d4e0: 2074 6173 6b20 7374 6174 6573 2e20 4e6f   task states. No
-0000d4f0: 7469 6669 6573 2074 6865 0a20 2020 2053  tifies the.    S
-0000d500: 6368 6564 756c 6572 206f 6620 6368 616e  cheduler of chan
-0000d510: 6765 7320 6279 206d 6573 7361 6769 6e67  ges by messaging
-0000d520: 2070 6173 7369 6e67 2074 6872 6f75 6768   passing through
-0000d530: 2051 7565 7565 732c 2077 6869 6368 2074   Queues, which t
-0000d540: 6865 0a20 2020 2053 6368 6564 756c 6572  he.    Scheduler
-0000d550: 206c 6973 7465 6e73 2074 6f20 7265 7370   listens to resp
-0000d560: 6f6e 6473 2061 6363 6f72 6469 6e67 6c79  onds accordingly
-0000d570: 2e0a 0a20 2020 2041 6c6c 2065 7665 6e74  ...    All event
-0000d580: 7320 6172 6520 6861 6e64 6c65 6420 7175  s are handled qu
-0000d590: 6963 6b6c 792c 2069 6e20 6c69 6e65 6172  ickly, in linear
-0000d5a0: 2074 696d 6520 7769 7468 2072 6573 7065   time with respe
-0000d5b0: 6374 2074 6f20 7468 6569 720a 2020 2020  ct to their.    
-0000d5c0: 696e 7075 7420 2877 6869 6368 2069 7320  input (which is 
-0000d5d0: 6f66 7465 6e20 6f66 2063 6f6e 7374 616e  often of constan
-0000d5e0: 7420 7369 7a65 2920 616e 6420 6765 6e65  t size) and gene
-0000d5f0: 7261 6c6c 7920 7769 7468 696e 2061 0a20  rally within a. 
-0000d600: 2020 206d 696c 6c69 7365 636f 6e64 2e0a     millisecond..
-0000d610: 0a20 2020 2055 7365 7273 2074 7970 6963  .    Users typic
-0000d620: 616c 6c79 2064 6f20 6e6f 7420 696e 7465  ally do not inte
-0000d630: 7261 6374 2077 6974 6820 6060 5472 616e  ract with ``Tran
-0000d640: 7369 7469 6f6e 7360 6020 6469 7265 6374  sitions`` direct
-0000d650: 6c79 2e20 496e 7374 6561 640a 2020 2020  ly. Instead.    
-0000d660: 7573 6572 7320 696e 7465 7261 6374 2077  users interact w
-0000d670: 6974 6820 7468 6520 6060 436c 6965 6e74  ith the ``Client
-0000d680: 6060 2c20 7768 6963 6820 696e 2074 7572  ``, which in tur
-0000d690: 6e20 656e 6761 6765 7320 7468 650a 2020  n engages the.  
-0000d6a0: 2020 6060 5363 6865 6475 6c65 7260 6020    ``Scheduler`` 
-0000d6b0: 6166 6665 6374 696e 6720 6469 6666 6572  affecting differ
-0000d6c0: 656e 7420 7472 616e 7369 7469 6f6e 7320  ent transitions 
-0000d6d0: 6865 7265 2075 6e64 6572 2d74 6865 2d68  here under-the-h
-0000d6e0: 6f6f 642e 2049 6e0a 2020 2020 7468 6520  ood. In.    the 
-0000d6f0: 6261 636b 6772 6f75 6e64 2060 6057 6f72  background ``Wor
-0000d700: 6b65 7260 6073 2061 6c73 6f20 656e 6761  ker``s also enga
-0000d710: 6765 2077 6974 6820 7468 6520 6060 5363  ge with the ``Sc
-0000d720: 6865 6475 6c65 7260 600a 2020 2020 6166  heduler``.    af
-0000d730: 6665 6374 696e 6720 7468 6573 6520 7374  fecting these st
-0000d740: 6174 6520 7472 616e 7369 7469 6f6e 7320  ate transitions 
-0000d750: 6173 2077 656c 6c2e 0a20 2020 2022 2222  as well..    """
-0000d760: 0a0a 2020 2020 6261 6e64 7769 6474 683a  ..    bandwidth:
-0000d770: 2069 6e74 0a0a 2020 2020 233a 2043 6c69   int..    #: Cli
-0000d780: 656e 7473 2063 7572 7265 6e74 6c79 2063  ents currently c
-0000d790: 6f6e 6e65 6374 6564 2074 6f20 7468 6520  onnected to the 
-0000d7a0: 7363 6865 6475 6c65 720a 2020 2020 636c  scheduler.    cl
-0000d7b0: 6965 6e74 733a 2064 6963 745b 7374 722c  ients: dict[str,
-0000d7c0: 2043 6c69 656e 7453 7461 7465 5d0a 0a20   ClientState].. 
-0000d7d0: 2020 2065 7874 656e 7369 6f6e 733a 2064     extensions: d
-0000d7e0: 6963 745b 7374 722c 2041 6e79 5d20 2023  ict[str, Any]  #
-0000d7f0: 2054 4f44 4f20 7772 6974 6520 6120 7363   TODO write a sc
-0000d800: 6865 6475 6c65 7220 6578 7465 6e73 696f  heduler extensio
-0000d810: 6e20 5072 6f74 6f63 6f6c 0a20 2020 2070  n Protocol.    p
-0000d820: 6c75 6769 6e73 3a20 6469 6374 5b73 7472  lugins: dict[str
-0000d830: 2c20 5363 6865 6475 6c65 7250 6c75 6769  , SchedulerPlugi
-0000d840: 6e5d 0a20 2020 2068 6f73 745f 696e 666f  n].    host_info
-0000d850: 3a20 6469 6374 5b73 7472 2c20 6469 6374  : dict[str, dict
-0000d860: 5b73 7472 2c20 416e 795d 5d0a 0a20 2020  [str, Any]]..   
-0000d870: 2023 3a20 4966 2054 7275 652c 2065 6e61   #: If True, ena
-0000d880: 626c 6520 6578 7065 6e73 6976 6520 696e  ble expensive in
-0000d890: 7465 726e 616c 2063 6f6e 7369 7374 656e  ternal consisten
-0000d8a0: 6379 2063 6865 636b 2e0a 2020 2020 233a  cy check..    #:
-0000d8b0: 2054 7970 6963 616c 6c79 2064 6973 6162   Typically disab
-0000d8c0: 6c65 6420 696e 2070 726f 6475 6374 696f  led in productio
-0000d8d0: 6e2e 0a20 2020 2076 616c 6964 6174 653a  n..    validate:
-0000d8e0: 2062 6f6f 6c0a 0a20 2020 2023 2323 2323   bool..    #####
-0000d8f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000d900: 2323 0a20 2020 2023 2057 6f72 6b65 7273  ##.    # Workers
-0000d910: 2d72 656c 6174 6564 2073 7461 7465 0a20  -related state. 
-0000d920: 2020 2023 2323 2323 2323 2323 2323 2323     #############
-0000d930: 2323 2323 2323 2323 2323 0a0a 2020 2020  ##########..    
-0000d940: 233a 2057 6f72 6b65 7273 2063 7572 7265  #: Workers curre
-0000d950: 6e74 6c79 2063 6f6e 6e65 6374 6564 2074  ntly connected t
-0000d960: 6f20 7468 6520 7363 6865 6475 6c65 720a  o the scheduler.
-0000d970: 2020 2020 233a 2028 6163 7475 616c 6c79      #: (actually
-0000d980: 2061 2053 6f72 7465 6444 6963 742c 2062   a SortedDict, b
-0000d990: 7574 2074 6865 2073 6f72 7465 6463 6f6e  ut the sortedcon
-0000d9a0: 7461 696e 6572 7320 7061 636b 6167 6520  tainers package 
-0000d9b0: 6973 6e27 7420 616e 6e6f 7461 7465 6429  isn't annotated)
-0000d9c0: 0a20 2020 2077 6f72 6b65 7273 3a20 6469  .    workers: di
-0000d9d0: 6374 5b73 7472 2c20 576f 726b 6572 5374  ct[str, WorkerSt
-0000d9e0: 6174 655d 0a20 2020 2023 3a20 576f 726b  ate].    #: Work
-0000d9f0: 6572 207b 6e61 6d65 3a20 6164 6472 6573  er {name: addres
-0000da00: 737d 0a20 2020 2061 6c69 6173 6573 3a20  s}.    aliases: 
-0000da10: 6469 6374 5b48 6173 6861 626c 652c 2073  dict[Hashable, s
-0000da20: 7472 5d0a 2020 2020 233a 2057 6f72 6b65  tr].    #: Worke
-0000da30: 7273 2074 6861 7420 6172 6520 6375 7272  rs that are curr
-0000da40: 656e 746c 7920 696e 2072 756e 6e69 6e67  ently in running
-0000da50: 2073 7461 7465 0a20 2020 2072 756e 6e69   state.    runni
-0000da60: 6e67 3a20 7365 745b 576f 726b 6572 5374  ng: set[WorkerSt
-0000da70: 6174 655d 0a20 2020 2023 3a20 576f 726b  ate].    #: Work
-0000da80: 6572 7320 7468 6174 2061 7265 2063 7572  ers that are cur
-0000da90: 7265 6e74 6c79 2069 6e20 7275 6e6e 696e  rently in runnin
-0000daa0: 6720 7374 6174 6520 616e 6420 6e6f 7420  g state and not 
-0000dab0: 6675 6c6c 7920 7574 696c 697a 6564 0a20  fully utilized. 
-0000dac0: 2020 2023 3a20 4465 6669 6e69 7469 6f6e     #: Definition
-0000dad0: 2062 6173 6564 206f 6e20 6f63 6375 7061   based on occupa
-0000dae0: 6e63 790a 2020 2020 233a 2028 6163 7475  ncy.    #: (actu
-0000daf0: 616c 6c79 2061 2053 6f72 7465 6444 6963  ally a SortedDic
-0000db00: 742c 2062 7574 2074 6865 2073 6f72 7465  t, but the sorte
-0000db10: 6463 6f6e 7461 696e 6572 7320 7061 636b  dcontainers pack
-0000db20: 6167 6520 6973 6e27 7420 616e 6e6f 7461  age isn't annota
-0000db30: 7465 6429 2e0a 2020 2020 233a 204e 6f74  ted)..    #: Not
-0000db40: 2074 6f20 6265 2063 6f6e 6675 7365 6420   to be confused 
-0000db50: 7769 7468 203a 6d65 7468 3a60 6973 5f69  with :meth:`is_i
-0000db60: 646c 6560 2e0a 2020 2020 6964 6c65 3a20  dle`..    idle: 
-0000db70: 6469 6374 5b73 7472 2c20 576f 726b 6572  dict[str, Worker
-0000db80: 5374 6174 655d 0a20 2020 2023 3a20 5369  State].    #: Si
-0000db90: 6d69 6c61 7220 746f 2060 6964 6c65 600a  milar to `idle`.
-0000dba0: 2020 2020 233a 2044 6566 696e 6974 696f      #: Definitio
-0000dbb0: 6e20 6261 7365 6420 6f6e 2061 7373 6967  n based on assig
-0000dbc0: 6e65 6420 7461 736b 730a 2020 2020 6964  ned tasks.    id
-0000dbd0: 6c65 5f74 6173 6b5f 636f 756e 743a 2073  le_task_count: s
-0000dbe0: 6574 5b57 6f72 6b65 7253 7461 7465 5d0a  et[WorkerState].
-0000dbf0: 2020 2020 233a 2057 6f72 6b65 7273 2074      #: Workers t
-0000dc00: 6861 7420 6172 6520 6675 6c6c 7920 7574  hat are fully ut
-0000dc10: 696c 697a 6564 2e20 4d61 7920 696e 636c  ilized. May incl
-0000dc20: 7564 6520 6e6f 6e2d 7275 6e6e 696e 6720  ude non-running 
-0000dc30: 776f 726b 6572 732e 0a20 2020 2073 6174  workers..    sat
-0000dc40: 7572 6174 6564 3a20 7365 745b 576f 726b  urated: set[Work
-0000dc50: 6572 5374 6174 655d 0a20 2020 2023 3a20  erState].    #: 
-0000dc60: 4375 7272 656e 7420 6e75 6d62 6572 206f  Current number o
-0000dc70: 6620 7468 7265 6164 7320 6163 726f 7373  f threads across
-0000dc80: 2061 6c6c 2077 6f72 6b65 7273 0a20 2020   all workers.   
-0000dc90: 2074 6f74 616c 5f6e 7468 7265 6164 733a   total_nthreads:
-0000dca0: 2069 6e74 0a20 2020 2023 3a20 4869 7374   int.    #: Hist
-0000dcb0: 6f72 7920 6f66 206e 756d 6265 7220 6f66  ory of number of
-0000dcc0: 2074 6872 6561 6473 0a20 2020 2023 3a20   threads.    #: 
-0000dcd0: 2874 696d 6573 7461 6d70 2c20 6e65 7720  (timestamp, new 
-0000dce0: 6e75 6d62 6572 206f 6620 7468 7265 6164  number of thread
-0000dcf0: 7329 0a20 2020 2074 6f74 616c 5f6e 7468  s).    total_nth
-0000dd00: 7265 6164 735f 6869 7374 6f72 793a 206c  reads_history: l
-0000dd10: 6973 745b 7475 706c 655b 666c 6f61 742c  ist[tuple[float,
-0000dd20: 2069 6e74 5d5d 0a20 2020 2023 3a20 436c   int]].    #: Cl
-0000dd30: 7573 7465 722d 7769 6465 2072 6573 6f75  uster-wide resou
-0000dd40: 7263 6573 2e20 7b72 6573 6f75 7263 6520  rces. {resource 
-0000dd50: 6e61 6d65 3a20 7b77 6f72 6b65 7220 6164  name: {worker ad
-0000dd60: 6472 6573 733a 2061 6d6f 756e 747d 7d0a  dress: amount}}.
-0000dd70: 2020 2020 7265 736f 7572 6365 733a 2064      resources: d
-0000dd80: 6963 745b 7374 722c 2064 6963 745b 7374  ict[str, dict[st
-0000dd90: 722c 2066 6c6f 6174 5d5d 0a0a 2020 2020  r, float]]..    
-0000dda0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000ddb0: 2323 2323 230a 2020 2020 2320 5461 736b  #####.    # Task
-0000ddc0: 732d 7265 6c61 7465 6420 7374 6174 650a  s-related state.
-0000ddd0: 2020 2020 2323 2323 2323 2323 2323 2323      ############
-0000dde0: 2323 2323 2323 2323 230a 0a20 2020 2023  #########..    #
-0000ddf0: 3a20 546f 7461 6c20 6e75 6d62 6572 206f  : Total number o
-0000de00: 6620 7461 736b 7320 6576 6572 2070 726f  f tasks ever pro
-0000de10: 6365 7373 6564 0a20 2020 206e 5f74 6173  cessed.    n_tas
-0000de20: 6b73 3a20 696e 740a 0a20 2020 2023 3a20  ks: int..    #: 
-0000de30: 416c 6c20 7461 736b 7320 6375 7272 656e  All tasks curren
-0000de40: 746c 7920 6b6e 6f77 6e20 746f 2074 6865  tly known to the
-0000de50: 2073 6368 6564 756c 6572 0a20 2020 2074   scheduler.    t
-0000de60: 6173 6b73 3a20 6469 6374 5b4b 6579 2c20  asks: dict[Key, 
-0000de70: 5461 736b 5374 6174 655d 0a0a 2020 2020  TaskState]..    
-0000de80: 233a 2054 6173 6b73 2069 6e20 7468 6520  #: Tasks in the 
-0000de90: 2271 7565 7565 6422 2073 7461 7465 2c20  "queued" state, 
-0000dea0: 6f72 6465 7265 6420 6279 2070 7269 6f72  ordered by prior
-0000deb0: 6974 790a 2020 2020 7175 6575 6564 3a20  ity.    queued: 
-0000dec0: 4865 6170 5365 745b 5461 736b 5374 6174  HeapSet[TaskStat
-0000ded0: 655d 0a0a 2020 2020 233a 2054 6173 6b73  e]..    #: Tasks
-0000dee0: 2069 6e20 7468 6520 226e 6f2d 776f 726b   in the "no-work
-0000def0: 6572 2220 7374 6174 650a 2020 2020 756e  er" state.    un
-0000df00: 7275 6e6e 6162 6c65 3a20 7365 745b 5461  runnable: set[Ta
-0000df10: 736b 5374 6174 655d 0a0a 2020 2020 233a  skState]..    #:
-0000df20: 2053 7562 7365 7420 6f66 2074 6173 6b73   Subset of tasks
-0000df30: 2074 6861 7420 6578 6973 7420 696e 206d   that exist in m
-0000df40: 656d 6f72 7920 6f6e 206d 6f72 6520 7468  emory on more th
-0000df50: 616e 206f 6e65 2077 6f72 6b65 720a 2020  an one worker.  
-0000df60: 2020 7265 706c 6963 6174 6564 5f74 6173    replicated_tas
-0000df70: 6b73 3a20 7365 745b 5461 736b 5374 6174  ks: set[TaskStat
-0000df80: 655d 0a0a 2020 2020 233a 2054 6173 6b73  e]..    #: Tasks
-0000df90: 2077 6974 6820 756e 6b6e 6f77 6e20 6475   with unknown du
-0000dfa0: 7261 7469 6f6e 2c20 6772 6f75 7065 6420  ration, grouped 
-0000dfb0: 6279 2070 7265 6669 780a 2020 2020 233a  by prefix.    #:
-0000dfc0: 207b 7461 736b 2070 7265 6669 783a 207b   {task prefix: {
-0000dfd0: 7473 2c20 7473 2c20 2e2e 2e7d 7d0a 2020  ts, ts, ...}}.  
-0000dfe0: 2020 756e 6b6e 6f77 6e5f 6475 7261 7469    unknown_durati
-0000dff0: 6f6e 733a 2064 6963 745b 7374 722c 2073  ons: dict[str, s
-0000e000: 6574 5b54 6173 6b53 7461 7465 5d5d 0a20  et[TaskState]]. 
-0000e010: 2020 2074 6173 6b5f 6772 6f75 7073 3a20     task_groups: 
-0000e020: 6469 6374 5b73 7472 2c20 5461 736b 4772  dict[str, TaskGr
-0000e030: 6f75 705d 0a20 2020 2074 6173 6b5f 7072  oup].    task_pr
-0000e040: 6566 6978 6573 3a20 6469 6374 5b73 7472  efixes: dict[str
-0000e050: 2c20 5461 736b 5072 6566 6978 5d0a 2020  , TaskPrefix].  
-0000e060: 2020 7461 736b 5f6d 6574 6164 6174 613a    task_metadata:
-0000e070: 2064 6963 745b 4b65 792c 2041 6e79 5d0a   dict[Key, Any].
-0000e080: 0a20 2020 2023 2323 2323 2323 2323 0a20  .    #########. 
-0000e090: 2020 2023 2048 6973 746f 7279 0a20 2020     # History.   
-0000e0a0: 2023 2323 2323 2323 2323 0a0a 2020 2020   #########..    
-0000e0b0: 233a 2048 6973 746f 7279 206f 6620 636f  #: History of co
-0000e0c0: 6d70 7574 6174 696f 6e73 2e0a 2020 2020  mputations..    
-0000e0d0: 233a 2054 6865 206c 656e 6774 6820 6361  #: The length ca
-0000e0e0: 6e20 6265 2074 7765 616b 6564 2074 6872  n be tweaked thr
-0000e0f0: 6f75 6768 0a20 2020 2023 3a20 6469 7374  ough.    #: dist
-0000e100: 7269 6275 7465 642e 6469 6167 6e6f 7374  ributed.diagnost
-0000e110: 6963 732e 636f 6d70 7574 6174 696f 6e73  ics.computations
-0000e120: 2e6d 6178 2d68 6973 746f 7279 0a20 2020  .max-history.   
-0000e130: 2063 6f6d 7075 7461 7469 6f6e 733a 2064   computations: d
-0000e140: 6571 7565 5b43 6f6d 7075 7461 7469 6f6e  eque[Computation
-0000e150: 5d0a 0a20 2020 2023 3a20 4869 7374 6f72  ]..    #: Histor
-0000e160: 7920 6f66 2065 7272 6564 2074 6173 6b73  y of erred tasks
-0000e170: 2e0a 2020 2020 233a 2054 6865 206c 656e  ..    #: The len
-0000e180: 6774 6820 6361 6e20 6265 2074 7765 616b  gth can be tweak
-0000e190: 6564 2074 6872 6f75 6768 0a20 2020 2023  ed through.    #
-0000e1a0: 3a20 6469 7374 7269 6275 7465 642e 6469  : distributed.di
-0000e1b0: 6167 6e6f 7374 6963 732e 6572 7265 642d  agnostics.erred-
-0000e1c0: 7461 736b 732e 6d61 782d 6869 7374 6f72  tasks.max-histor
-0000e1d0: 790a 2020 2020 6572 7265 645f 7461 736b  y.    erred_task
-0000e1e0: 733a 2064 6571 7565 5b45 7272 6564 5461  s: deque[ErredTa
-0000e1f0: 736b 5d0a 0a20 2020 2023 3a20 4869 7374  sk]..    #: Hist
-0000e200: 6f72 7920 6f66 2074 6173 6b20 7374 6174  ory of task stat
-0000e210: 6520 7472 616e 7369 7469 6f6e 732e 0a20  e transitions.. 
-0000e220: 2020 2023 3a20 5468 6520 6c65 6e67 7468     #: The length
-0000e230: 2063 616e 2062 6520 7477 6561 6b65 6420   can be tweaked 
-0000e240: 7468 726f 7567 680a 2020 2020 233a 2064  through.    #: d
-0000e250: 6973 7472 6962 7574 6564 2e61 646d 696e  istributed.admin
-0000e260: 2e6c 6f77 2d6c 6576 656c 2d6c 6f67 2d6c  .low-level-log-l
-0000e270: 656e 6774 680a 2020 2020 7472 616e 7369  ength.    transi
-0000e280: 7469 6f6e 5f6c 6f67 3a20 6465 7175 655b  tion_log: deque[
-0000e290: 5472 616e 7369 7469 6f6e 5d0a 0a20 2020  Transition]..   
-0000e2a0: 2023 3a20 546f 7461 6c20 6e75 6d62 6572   #: Total number
-0000e2b0: 206f 6620 7472 616e 7369 7469 6f6e 7320   of transitions 
-0000e2c0: 7369 6e63 6520 7468 6520 636c 7573 7465  since the cluste
-0000e2d0: 7220 7761 7320 7374 6172 7465 640a 2020  r was started.  
-0000e2e0: 2020 7472 616e 7369 7469 6f6e 5f63 6f75    transition_cou
-0000e2f0: 6e74 6572 3a20 696e 740a 0a20 2020 2023  nter: int..    #
-0000e300: 3a20 546f 7461 6c20 6e75 6d62 6572 206f  : Total number o
-0000e310: 6620 7472 616e 7369 7469 6f6e 7320 6173  f transitions as
-0000e320: 206f 6620 7468 6520 7072 6576 696f 7573   of the previous
-0000e330: 2063 616c 6c20 746f 2063 6865 636b 5f69   call to check_i
-0000e340: 646c 6528 290a 2020 2020 5f69 646c 655f  dle().    _idle_
-0000e350: 7472 616e 7369 7469 6f6e 5f63 6f75 6e74  transition_count
-0000e360: 6572 3a20 696e 740a 0a20 2020 2023 3a20  er: int..    #: 
-0000e370: 5261 6973 6520 616e 2065 7272 6f72 2069  Raise an error i
-0000e380: 6620 7468 6520 3a61 7474 723a 6074 7261  f the :attr:`tra
-0000e390: 6e73 6974 696f 6e5f 636f 756e 7465 7260  nsition_counter`
-0000e3a0: 2065 7665 7220 7265 6163 6865 7320 7468   ever reaches th
-0000e3b0: 6973 2076 616c 7565 2e0a 2020 2020 233a  is value..    #:
-0000e3c0: 2054 6869 7320 6973 206d 6561 6e74 2066   This is meant f
-0000e3d0: 6f72 2064 6562 7567 6769 6e67 206f 6e6c  or debugging onl
-0000e3e0: 792c 2074 6f20 6361 7463 6820 696e 6669  y, to catch infi
-0000e3f0: 6e69 7465 2072 6563 7572 7369 6f6e 206c  nite recursion l
-0000e400: 6f6f 7073 2e0a 2020 2020 233a 2049 6e20  oops..    #: In 
-0000e410: 7072 6f64 7563 7469 6f6e 2c20 6974 2073  production, it s
-0000e420: 686f 756c 6420 616c 7761 7973 2062 6520  hould always be 
-0000e430: 7365 7420 746f 2046 616c 7365 2e0a 2020  set to False..  
-0000e440: 2020 7472 616e 7369 7469 6f6e 5f63 6f75    transition_cou
-0000e450: 6e74 6572 5f6d 6178 3a20 696e 7420 7c20  nter_max: int | 
-0000e460: 4c69 7465 7261 6c5b 4661 6c73 655d 0a0a  Literal[False]..
-0000e470: 2020 2020 5f74 6173 6b5f 7072 6566 6978      _task_prefix
-0000e480: 5f63 6f75 6e74 5f67 6c6f 6261 6c3a 2064  _count_global: d
-0000e490: 6566 6175 6c74 6469 6374 5b73 7472 2c20  efaultdict[str, 
-0000e4a0: 696e 745d 0a20 2020 205f 6e65 7477 6f72  int].    _networ
-0000e4b0: 6b5f 6f63 635f 676c 6f62 616c 3a20 666c  k_occ_global: fl
-0000e4c0: 6f61 740a 2020 2020 2323 2323 2323 2323  oat.    ########
-0000e4d0: 2323 2323 2323 2323 2323 2323 2323 0a20  ##############. 
-0000e4e0: 2020 2023 2043 6163 6865 6420 636f 6e66     # Cached conf
-0000e4f0: 6967 7572 6174 696f 6e0a 2020 2020 2323  iguration.    ##
-0000e500: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000e510: 2323 2323 0a0a 2020 2020 233a 2064 6973  ####..    #: dis
-0000e520: 7472 6962 7574 6564 2e73 6368 6564 756c  tributed.schedul
-0000e530: 6572 2e75 6e6b 6e6f 776e 2d74 6173 6b2d  er.unknown-task-
-0000e540: 6475 7261 7469 6f6e 0a20 2020 2055 4e4b  duration.    UNK
-0000e550: 4e4f 574e 5f54 4153 4b5f 4455 5241 5449  NOWN_TASK_DURATI
-0000e560: 4f4e 3a20 666c 6f61 740a 2020 2020 233a  ON: float.    #:
-0000e570: 2064 6973 7472 6962 7574 6564 2e77 6f72   distributed.wor
-0000e580: 6b65 722e 6d65 6d6f 7279 2e72 6563 656e  ker.memory.recen
-0000e590: 742d 746f 2d6f 6c64 2d74 696d 650a 2020  t-to-old-time.  
-0000e5a0: 2020 4d45 4d4f 5259 5f52 4543 454e 545f    MEMORY_RECENT_
-0000e5b0: 544f 5f4f 4c44 5f54 494d 453a 2066 6c6f  TO_OLD_TIME: flo
-0000e5c0: 6174 0a20 2020 2023 3a20 6469 7374 7269  at.    #: distri
-0000e5d0: 6275 7465 642e 776f 726b 6572 2e6d 656d  buted.worker.mem
-0000e5e0: 6f72 792e 7265 6261 6c61 6e63 652e 6d65  ory.rebalance.me
-0000e5f0: 6173 7572 650a 2020 2020 4d45 4d4f 5259  asure.    MEMORY
-0000e600: 5f52 4542 414c 414e 4345 5f4d 4541 5355  _REBALANCE_MEASU
-0000e610: 5245 3a20 7374 720a 2020 2020 233a 2064  RE: str.    #: d
-0000e620: 6973 7472 6962 7574 6564 2e77 6f72 6b65  istributed.worke
-0000e630: 722e 6d65 6d6f 7279 2e72 6562 616c 616e  r.memory.rebalan
-0000e640: 6365 2e73 656e 6465 722d 6d69 6e0a 2020  ce.sender-min.  
-0000e650: 2020 4d45 4d4f 5259 5f52 4542 414c 414e    MEMORY_REBALAN
-0000e660: 4345 5f53 454e 4445 525f 4d49 4e3a 2066  CE_SENDER_MIN: f
-0000e670: 6c6f 6174 0a20 2020 2023 3a20 6469 7374  loat.    #: dist
-0000e680: 7269 6275 7465 642e 776f 726b 6572 2e6d  ributed.worker.m
-0000e690: 656d 6f72 792e 7265 6261 6c61 6e63 652e  emory.rebalance.
-0000e6a0: 7265 6369 7069 656e 742d 6d61 780a 2020  recipient-max.  
-0000e6b0: 2020 4d45 4d4f 5259 5f52 4542 414c 414e    MEMORY_REBALAN
-0000e6c0: 4345 5f52 4543 4950 4945 4e54 5f4d 4158  CE_RECIPIENT_MAX
-0000e6d0: 3a20 666c 6f61 740a 2020 2020 233a 2064  : float.    #: d
-0000e6e0: 6973 7472 6962 7574 6564 2e77 6f72 6b65  istributed.worke
-0000e6f0: 722e 6d65 6d6f 7279 2e72 6562 616c 616e  r.memory.rebalan
-0000e700: 6365 2e73 656e 6465 722d 7265 6369 7069  ce.sender-recipi
-0000e710: 656e 742d 6761 7020 2f20 320a 2020 2020  ent-gap / 2.    
-0000e720: 4d45 4d4f 5259 5f52 4542 414c 414e 4345  MEMORY_REBALANCE
-0000e730: 5f48 414c 465f 4741 503a 2066 6c6f 6174  _HALF_GAP: float
-0000e740: 0a20 2020 2023 3a20 6469 7374 7269 6275  .    #: distribu
-0000e750: 7465 642e 7363 6865 6475 6c65 722e 776f  ted.scheduler.wo
-0000e760: 726b 6572 2d73 6174 7572 6174 696f 6e0a  rker-saturation.
-0000e770: 2020 2020 574f 524b 4552 5f53 4154 5552      WORKER_SATUR
-0000e780: 4154 494f 4e3a 2066 6c6f 6174 0a0a 2020  ATION: float..  
-0000e790: 2020 5f5f 736c 6f74 735f 5f20 3d20 7475    __slots__ = tu
-0000e7a0: 706c 6528 5f5f 616e 6e6f 7461 7469 6f6e  ple(__annotation
-0000e7b0: 735f 5f29 0a0a 2020 2020 6465 6620 5f5f  s__)..    def __
-0000e7c0: 696e 6974 5f5f 280a 2020 2020 2020 2020  init__(.        
-0000e7d0: 7365 6c66 2c0a 2020 2020 2020 2020 616c  self,.        al
-0000e7e0: 6961 7365 733a 2064 6963 745b 4861 7368  iases: dict[Hash
-0000e7f0: 6162 6c65 2c20 7374 725d 2c0a 2020 2020  able, str],.    
-0000e800: 2020 2020 636c 6965 6e74 733a 2064 6963      clients: dic
-0000e810: 745b 7374 722c 2043 6c69 656e 7453 7461  t[str, ClientSta
-0000e820: 7465 5d2c 0a20 2020 2020 2020 2077 6f72  te],.        wor
-0000e830: 6b65 7273 3a20 536f 7274 6564 4469 6374  kers: SortedDict
-0000e840: 5b73 7472 2c20 576f 726b 6572 5374 6174  [str, WorkerStat
-0000e850: 655d 2c0a 2020 2020 2020 2020 686f 7374  e],.        host
-0000e860: 5f69 6e66 6f3a 2064 6963 745b 7374 722c  _info: dict[str,
-0000e870: 2064 6963 745b 7374 722c 2041 6e79 5d5d   dict[str, Any]]
-0000e880: 2c0a 2020 2020 2020 2020 7265 736f 7572  ,.        resour
-0000e890: 6365 733a 2064 6963 745b 7374 722c 2064  ces: dict[str, d
-0000e8a0: 6963 745b 7374 722c 2066 6c6f 6174 5d5d  ict[str, float]]
-0000e8b0: 2c0a 2020 2020 2020 2020 7461 736b 733a  ,.        tasks:
-0000e8c0: 2064 6963 745b 4b65 792c 2054 6173 6b53   dict[Key, TaskS
-0000e8d0: 7461 7465 5d2c 0a20 2020 2020 2020 2075  tate],.        u
-0000e8e0: 6e72 756e 6e61 626c 653a 2073 6574 5b54  nrunnable: set[T
-0000e8f0: 6173 6b53 7461 7465 5d2c 0a20 2020 2020  askState],.     
-0000e900: 2020 2071 7565 7565 643a 2048 6561 7053     queued: HeapS
-0000e910: 6574 5b54 6173 6b53 7461 7465 5d2c 0a20  et[TaskState],. 
-0000e920: 2020 2020 2020 2076 616c 6964 6174 653a         validate:
-0000e930: 2062 6f6f 6c2c 0a20 2020 2020 2020 2070   bool,.        p
-0000e940: 6c75 6769 6e73 3a20 4974 6572 6162 6c65  lugins: Iterable
-0000e950: 5b53 6368 6564 756c 6572 506c 7567 696e  [SchedulerPlugin
-0000e960: 5d20 3d20 2829 2c0a 2020 2020 2020 2020  ] = (),.        
-0000e970: 7472 616e 7369 7469 6f6e 5f63 6f75 6e74  transition_count
-0000e980: 6572 5f6d 6178 3a20 696e 7420 7c20 4c69  er_max: int | Li
-0000e990: 7465 7261 6c5b 4661 6c73 655d 203d 2046  teral[False] = F
-0000e9a0: 616c 7365 2c0a 2020 2020 2020 2020 2a2a  alse,.        **
-0000e9b0: 6b77 6172 6773 3a20 416e 792c 2020 2320  kwargs: Any,  # 
-0000e9c0: 5061 7373 6564 2076 6572 6261 7469 6d20  Passed verbatim 
-0000e9d0: 746f 2053 6572 7665 722e 5f5f 696e 6974  to Server.__init
-0000e9e0: 5f5f 2829 0a20 2020 2029 3a0a 2020 2020  __().    ):.    
-0000e9f0: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
-0000ea00: 2253 7461 7465 2073 7461 7274 2229 0a20  "State start"). 
-0000ea10: 2020 2020 2020 2073 656c 662e 616c 6961         self.alia
-0000ea20: 7365 7320 3d20 616c 6961 7365 730a 2020  ses = aliases.  
-0000ea30: 2020 2020 2020 7365 6c66 2e62 616e 6477        self.bandw
-0000ea40: 6964 7468 203d 2070 6172 7365 5f62 7974  idth = parse_byt
-0000ea50: 6573 2864 6173 6b2e 636f 6e66 6967 2e67  es(dask.config.g
-0000ea60: 6574 2822 6469 7374 7269 6275 7465 642e  et("distributed.
-0000ea70: 7363 6865 6475 6c65 722e 6261 6e64 7769  scheduler.bandwi
-0000ea80: 6474 6822 2929 0a20 2020 2020 2020 2073  dth")).        s
-0000ea90: 656c 662e 636c 6965 6e74 7320 3d20 636c  elf.clients = cl
-0000eaa0: 6965 6e74 730a 2020 2020 2020 2020 7365  ients.        se
-0000eab0: 6c66 2e63 6c69 656e 7473 5b22 6669 7265  lf.clients["fire
-0000eac0: 2d61 6e64 2d66 6f72 6765 7422 5d20 3d20  -and-forget"] = 
-0000ead0: 436c 6965 6e74 5374 6174 6528 2266 6972  ClientState("fir
-0000eae0: 652d 616e 642d 666f 7267 6574 2229 0a20  e-and-forget"). 
-0000eaf0: 2020 2020 2020 2073 656c 662e 6578 7465         self.exte
-0000eb00: 6e73 696f 6e73 203d 207b 7d0a 2020 2020  nsions = {}.    
-0000eb10: 2020 2020 7365 6c66 2e68 6f73 745f 696e      self.host_in
-0000eb20: 666f 203d 2068 6f73 745f 696e 666f 0a20  fo = host_info. 
-0000eb30: 2020 2020 2020 2073 656c 662e 6964 6c65         self.idle
-0000eb40: 203d 2053 6f72 7465 6444 6963 7428 290a   = SortedDict().
-0000eb50: 2020 2020 2020 2020 7365 6c66 2e69 646c          self.idl
-0000eb60: 655f 7461 736b 5f63 6f75 6e74 203d 2073  e_task_count = s
-0000eb70: 6574 2829 0a20 2020 2020 2020 2073 656c  et().        sel
-0000eb80: 662e 6e5f 7461 736b 7320 3d20 300a 2020  f.n_tasks = 0.  
-0000eb90: 2020 2020 2020 7365 6c66 2e72 6573 6f75        self.resou
-0000eba0: 7263 6573 203d 2072 6573 6f75 7263 6573  rces = resources
-0000ebb0: 0a20 2020 2020 2020 2073 656c 662e 7361  .        self.sa
-0000ebc0: 7475 7261 7465 6420 3d20 7365 7428 290a  turated = set().
-0000ebd0: 2020 2020 2020 2020 7365 6c66 2e74 6173          self.tas
-0000ebe0: 6b73 203d 2074 6173 6b73 0a20 2020 2020  ks = tasks.     
-0000ebf0: 2020 2073 656c 662e 7265 706c 6963 6174     self.replicat
-0000ec00: 6564 5f74 6173 6b73 203d 207b 0a20 2020  ed_tasks = {.   
-0000ec10: 2020 2020 2020 2020 2074 7320 666f 7220           ts for 
-0000ec20: 7473 2069 6e20 7365 6c66 2e74 6173 6b73  ts in self.tasks
-0000ec30: 2e76 616c 7565 7328 2920 6966 206c 656e  .values() if len
-0000ec40: 2874 732e 7768 6f5f 6861 7320 6f72 2028  (ts.who_has or (
-0000ec50: 2929 203e 2031 0a20 2020 2020 2020 207d  )) > 1.        }
-0000ec60: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
-0000ec70: 6d70 7574 6174 696f 6e73 203d 2064 6571  mputations = deq
-0000ec80: 7565 280a 2020 2020 2020 2020 2020 2020  ue(.            
-0000ec90: 6d61 786c 656e 3d64 6173 6b2e 636f 6e66  maxlen=dask.conf
-0000eca0: 6967 2e67 6574 2822 6469 7374 7269 6275  ig.get("distribu
-0000ecb0: 7465 642e 6469 6167 6e6f 7374 6963 732e  ted.diagnostics.
-0000ecc0: 636f 6d70 7574 6174 696f 6e73 2e6d 6178  computations.max
-0000ecd0: 2d68 6973 746f 7279 2229 0a20 2020 2020  -history").     
-0000ece0: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
-0000ecf0: 662e 6572 7265 645f 7461 736b 7320 3d20  f.erred_tasks = 
-0000ed00: 6465 7175 6528 0a20 2020 2020 2020 2020  deque(.         
-0000ed10: 2020 206d 6178 6c65 6e3d 6461 736b 2e63     maxlen=dask.c
-0000ed20: 6f6e 6669 672e 6765 7428 2264 6973 7472  onfig.get("distr
-0000ed30: 6962 7574 6564 2e64 6961 676e 6f73 7469  ibuted.diagnosti
-0000ed40: 6373 2e65 7272 6564 2d74 6173 6b73 2e6d  cs.erred-tasks.m
-0000ed50: 6178 2d68 6973 746f 7279 2229 0a20 2020  ax-history").   
-0000ed60: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
-0000ed70: 656c 662e 7461 736b 5f67 726f 7570 7320  elf.task_groups 
-0000ed80: 3d20 7b7d 0a20 2020 2020 2020 2073 656c  = {}.        sel
-0000ed90: 662e 7461 736b 5f70 7265 6669 7865 7320  f.task_prefixes 
-0000eda0: 3d20 7b7d 0a20 2020 2020 2020 2073 656c  = {}.        sel
-0000edb0: 662e 7461 736b 5f6d 6574 6164 6174 6120  f.task_metadata 
-0000edc0: 3d20 7b7d 0a20 2020 2020 2020 2073 656c  = {}.        sel
-0000edd0: 662e 746f 7461 6c5f 6e74 6872 6561 6473  f.total_nthreads
-0000ede0: 203d 2030 0a20 2020 2020 2020 2073 656c   = 0.        sel
-0000edf0: 662e 746f 7461 6c5f 6e74 6872 6561 6473  f.total_nthreads
-0000ee00: 5f68 6973 746f 7279 203d 205b 2874 696d  _history = [(tim
-0000ee10: 6528 292c 2030 295d 0a20 2020 2020 2020  e(), 0)].       
-0000ee20: 2073 656c 662e 756e 6b6e 6f77 6e5f 6475   self.unknown_du
-0000ee30: 7261 7469 6f6e 7320 3d20 7b7d 0a20 2020  rations = {}.   
-0000ee40: 2020 2020 2073 656c 662e 7175 6575 6564       self.queued
-0000ee50: 203d 2071 7565 7565 640a 2020 2020 2020   = queued.      
-0000ee60: 2020 7365 6c66 2e75 6e72 756e 6e61 626c    self.unrunnabl
-0000ee70: 6520 3d20 756e 7275 6e6e 6162 6c65 0a20  e = unrunnable. 
-0000ee80: 2020 2020 2020 2073 656c 662e 7661 6c69         self.vali
-0000ee90: 6461 7465 203d 2076 616c 6964 6174 650a  date = validate.
-0000eea0: 2020 2020 2020 2020 7365 6c66 2e77 6f72          self.wor
-0000eeb0: 6b65 7273 203d 2077 6f72 6b65 7273 0a20  kers = workers. 
-0000eec0: 2020 2020 2020 2073 656c 662e 5f74 6173         self._tas
-0000eed0: 6b5f 7072 6566 6978 5f63 6f75 6e74 5f67  k_prefix_count_g
-0000eee0: 6c6f 6261 6c20 3d20 6465 6661 756c 7464  lobal = defaultd
-0000eef0: 6963 7428 696e 7429 0a20 2020 2020 2020  ict(int).       
-0000ef00: 2073 656c 662e 5f6e 6574 776f 726b 5f6f   self._network_o
-0000ef10: 6363 5f67 6c6f 6261 6c20 3d20 302e 300a  cc_global = 0.0.
-0000ef20: 2020 2020 2020 2020 7365 6c66 2e72 756e          self.run
-0000ef30: 6e69 6e67 203d 207b 0a20 2020 2020 2020  ning = {.       
-0000ef40: 2020 2020 2077 7320 666f 7220 7773 2069       ws for ws i
-0000ef50: 6e20 7365 6c66 2e77 6f72 6b65 7273 2e76  n self.workers.v
-0000ef60: 616c 7565 7328 2920 6966 2077 732e 7374  alues() if ws.st
-0000ef70: 6174 7573 203d 3d20 5374 6174 7573 2e72  atus == Status.r
-0000ef80: 756e 6e69 6e67 0a20 2020 2020 2020 207d  unning.        }
-0000ef90: 0a20 2020 2020 2020 2073 656c 662e 706c  .        self.pl
-0000efa0: 7567 696e 7320 3d20 7b7d 2069 6620 6e6f  ugins = {} if no
-0000efb0: 7420 706c 7567 696e 7320 656c 7365 207b  t plugins else {
-0000efc0: 5f67 6574 5f70 6c75 6769 6e5f 6e61 6d65  _get_plugin_name
-0000efd0: 2870 293a 2070 2066 6f72 2070 2069 6e20  (p): p for p in 
-0000efe0: 706c 7567 696e 737d 0a0a 2020 2020 2020  plugins}..      
-0000eff0: 2020 7365 6c66 2e74 7261 6e73 6974 696f    self.transitio
-0000f000: 6e5f 6c6f 6720 3d20 6465 7175 6528 0a20  n_log = deque(. 
-0000f010: 2020 2020 2020 2020 2020 206d 6178 6c65             maxle
-0000f020: 6e3d 6461 736b 2e63 6f6e 6669 672e 6765  n=dask.config.ge
-0000f030: 7428 2264 6973 7472 6962 7574 6564 2e61  t("distributed.a
-0000f040: 646d 696e 2e6c 6f77 2d6c 6576 656c 2d6c  dmin.low-level-l
-0000f050: 6f67 2d6c 656e 6774 6822 290a 2020 2020  og-length").    
-0000f060: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
-0000f070: 6c66 2e74 7261 6e73 6974 696f 6e5f 636f  lf.transition_co
-0000f080: 756e 7465 7220 3d20 300a 2020 2020 2020  unter = 0.      
-0000f090: 2020 7365 6c66 2e5f 6964 6c65 5f74 7261    self._idle_tra
-0000f0a0: 6e73 6974 696f 6e5f 636f 756e 7465 7220  nsition_counter 
-0000f0b0: 3d20 300a 2020 2020 2020 2020 7365 6c66  = 0.        self
-0000f0c0: 2e74 7261 6e73 6974 696f 6e5f 636f 756e  .transition_coun
-0000f0d0: 7465 725f 6d61 7820 3d20 7472 616e 7369  ter_max = transi
-0000f0e0: 7469 6f6e 5f63 6f75 6e74 6572 5f6d 6178  tion_counter_max
-0000f0f0: 0a0a 2020 2020 2020 2020 2320 5661 7269  ..        # Vari
-0000f100: 6162 6c65 7320 6672 6f6d 2064 6173 6b2e  ables from dask.
-0000f110: 636f 6e66 6967 2c20 6361 6368 6564 2062  config, cached b
-0000f120: 7920 5f5f 696e 6974 5f5f 2066 6f72 2070  y __init__ for p
-0000f130: 6572 666f 726d 616e 6365 0a20 2020 2020  erformance.     
-0000f140: 2020 2073 656c 662e 554e 4b4e 4f57 4e5f     self.UNKNOWN_
-0000f150: 5441 534b 5f44 5552 4154 494f 4e20 3d20  TASK_DURATION = 
-0000f160: 7061 7273 655f 7469 6d65 6465 6c74 6128  parse_timedelta(
-0000f170: 0a20 2020 2020 2020 2020 2020 2064 6173  .            das
-0000f180: 6b2e 636f 6e66 6967 2e67 6574 2822 6469  k.config.get("di
-0000f190: 7374 7269 6275 7465 642e 7363 6865 6475  stributed.schedu
-0000f1a0: 6c65 722e 756e 6b6e 6f77 6e2d 7461 736b  ler.unknown-task
-0000f1b0: 2d64 7572 6174 696f 6e22 290a 2020 2020  -duration").    
-0000f1c0: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
-0000f1d0: 6c66 2e4d 454d 4f52 595f 5245 4345 4e54  lf.MEMORY_RECENT
-0000f1e0: 5f54 4f5f 4f4c 445f 5449 4d45 203d 2070  _TO_OLD_TIME = p
-0000f1f0: 6172 7365 5f74 696d 6564 656c 7461 280a  arse_timedelta(.
-0000f200: 2020 2020 2020 2020 2020 2020 6461 736b              dask
-0000f210: 2e63 6f6e 6669 672e 6765 7428 2264 6973  .config.get("dis
-0000f220: 7472 6962 7574 6564 2e77 6f72 6b65 722e  tributed.worker.
-0000f230: 6d65 6d6f 7279 2e72 6563 656e 742d 746f  memory.recent-to
-0000f240: 2d6f 6c64 2d74 696d 6522 290a 2020 2020  -old-time").    
-0000f250: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
-0000f260: 6c66 2e4d 454d 4f52 595f 5245 4241 4c41  lf.MEMORY_REBALA
-0000f270: 4e43 455f 4d45 4153 5552 4520 3d20 6461  NCE_MEASURE = da
-0000f280: 736b 2e63 6f6e 6669 672e 6765 7428 0a20  sk.config.get(. 
-0000f290: 2020 2020 2020 2020 2020 2022 6469 7374             "dist
-0000f2a0: 7269 6275 7465 642e 776f 726b 6572 2e6d  ributed.worker.m
-0000f2b0: 656d 6f72 792e 7265 6261 6c61 6e63 652e  emory.rebalance.
-0000f2c0: 6d65 6173 7572 6522 0a20 2020 2020 2020  measure".       
-0000f2d0: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
-0000f2e0: 4d45 4d4f 5259 5f52 4542 414c 414e 4345  MEMORY_REBALANCE
-0000f2f0: 5f53 454e 4445 525f 4d49 4e20 3d20 6461  _SENDER_MIN = da
-0000f300: 736b 2e63 6f6e 6669 672e 6765 7428 0a20  sk.config.get(. 
-0000f310: 2020 2020 2020 2020 2020 2022 6469 7374             "dist
-0000f320: 7269 6275 7465 642e 776f 726b 6572 2e6d  ributed.worker.m
-0000f330: 656d 6f72 792e 7265 6261 6c61 6e63 652e  emory.rebalance.
-0000f340: 7365 6e64 6572 2d6d 696e 220a 2020 2020  sender-min".    
-0000f350: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
-0000f360: 6c66 2e4d 454d 4f52 595f 5245 4241 4c41  lf.MEMORY_REBALA
-0000f370: 4e43 455f 5245 4349 5049 454e 545f 4d41  NCE_RECIPIENT_MA
-0000f380: 5820 3d20 6461 736b 2e63 6f6e 6669 672e  X = dask.config.
-0000f390: 6765 7428 0a20 2020 2020 2020 2020 2020  get(.           
-0000f3a0: 2022 6469 7374 7269 6275 7465 642e 776f   "distributed.wo
-0000f3b0: 726b 6572 2e6d 656d 6f72 792e 7265 6261  rker.memory.reba
-0000f3c0: 6c61 6e63 652e 7265 6369 7069 656e 742d  lance.recipient-
-0000f3d0: 6d61 7822 0a20 2020 2020 2020 2029 0a20  max".        ). 
-0000f3e0: 2020 2020 2020 2073 656c 662e 4d45 4d4f         self.MEMO
-0000f3f0: 5259 5f52 4542 414c 414e 4345 5f48 414c  RY_REBALANCE_HAL
-0000f400: 465f 4741 5020 3d20 280a 2020 2020 2020  F_GAP = (.      
-0000f410: 2020 2020 2020 6461 736b 2e63 6f6e 6669        dask.confi
-0000f420: 672e 6765 7428 2264 6973 7472 6962 7574  g.get("distribut
-0000f430: 6564 2e77 6f72 6b65 722e 6d65 6d6f 7279  ed.worker.memory
-0000f440: 2e72 6562 616c 616e 6365 2e73 656e 6465  .rebalance.sende
-0000f450: 722d 7265 6369 7069 656e 742d 6761 7022  r-recipient-gap"
-0000f460: 290a 2020 2020 2020 2020 2020 2020 2f20  ).            / 
-0000f470: 322e 300a 2020 2020 2020 2020 290a 0a20  2.0.        ).. 
-0000f480: 2020 2020 2020 2073 656c 662e 574f 524b         self.WORK
-0000f490: 4552 5f53 4154 5552 4154 494f 4e20 3d20  ER_SATURATION = 
-0000f4a0: 6461 736b 2e63 6f6e 6669 672e 6765 7428  dask.config.get(
-0000f4b0: 0a20 2020 2020 2020 2020 2020 2022 6469  .            "di
-0000f4c0: 7374 7269 6275 7465 642e 7363 6865 6475  stributed.schedu
-0000f4d0: 6c65 722e 776f 726b 6572 2d73 6174 7572  ler.worker-satur
-0000f4e0: 6174 696f 6e22 0a20 2020 2020 2020 2029  ation".        )
-0000f4f0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-0000f500: 2e57 4f52 4b45 525f 5341 5455 5241 5449  .WORKER_SATURATI
-0000f510: 4f4e 203d 3d20 2269 6e66 223a 0a20 2020  ON == "inf":.   
-0000f520: 2020 2020 2020 2020 2023 2053 7065 6369           # Speci
-0000f530: 616c 2063 6173 6520 6e65 6365 7373 6172  al case necessar
-0000f540: 7920 6265 6361 7573 6520 7468 6572 6527  y because there'
-0000f550: 7320 6e6f 2077 6179 2074 6f20 7061 7273  s no way to pars
-0000f560: 6520 6120 666c 6f61 7420 696e 6669 6e69  e a float infini
-0000f570: 7479 0a20 2020 2020 2020 2020 2020 2023  ty.            #
-0000f580: 2066 726f 6d20 6120 4441 534b 5f2a 2065   from a DASK_* e
-0000f590: 6e76 6972 6f6e 6d65 6e74 2076 6172 6961  nvironment varia
-0000f5a0: 626c 650a 2020 2020 2020 2020 2020 2020  ble.            
-0000f5b0: 7365 6c66 2e57 4f52 4b45 525f 5341 5455  self.WORKER_SATU
-0000f5c0: 5241 5449 4f4e 203d 206d 6174 682e 696e  RATION = math.in
-0000f5d0: 660a 2020 2020 2020 2020 6966 2028 0a20  f.        if (. 
-0000f5e0: 2020 2020 2020 2020 2020 206e 6f74 2069             not i
-0000f5f0: 7369 6e73 7461 6e63 6528 7365 6c66 2e57  sinstance(self.W
-0000f600: 4f52 4b45 525f 5341 5455 5241 5449 4f4e  ORKER_SATURATION
-0000f610: 2c20 2869 6e74 2c20 666c 6f61 7429 290a  , (int, float)).
-0000f620: 2020 2020 2020 2020 2020 2020 6f72 2073              or s
-0000f630: 656c 662e 574f 524b 4552 5f53 4154 5552  elf.WORKER_SATUR
-0000f640: 4154 494f 4e20 3c3d 2030 0a20 2020 2020  ATION <= 0.     
-0000f650: 2020 2029 3a0a 2020 2020 2020 2020 2020     ):.          
-0000f660: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
-0000f670: 6f72 2820 2023 2070 7261 676d 613a 206e  or(  # pragma: n
-0000f680: 6f63 6f76 6572 0a20 2020 2020 2020 2020  ocover.         
-0000f690: 2020 2020 2020 2022 6064 6973 7472 6962         "`distrib
-0000f6a0: 7574 6564 2e73 6368 6564 756c 6572 2e77  uted.scheduler.w
-0000f6b0: 6f72 6b65 722d 7361 7475 7261 7469 6f6e  orker-saturation
-0000f6c0: 6020 6d75 7374 2062 6520 6120 666c 6f61  ` must be a floa
-0000f6d0: 7420 3e20 303b 2067 6f74 2022 0a20 2020  t > 0; got ".   
-0000f6e0: 2020 2020 2020 2020 2020 2020 202b 2072               + r
-0000f6f0: 6570 7228 7365 6c66 2e57 4f52 4b45 525f  epr(self.WORKER_
-0000f700: 5341 5455 5241 5449 4f4e 290a 2020 2020  SATURATION).    
-0000f710: 2020 2020 2020 2020 290a 0a20 2020 2040          )..    @
-0000f720: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
-0000f730: 206d 656d 6f72 7928 7365 6c66 2920 2d3e   memory(self) ->
-0000f740: 204d 656d 6f72 7953 7461 7465 3a0a 2020   MemoryState:.  
-0000f750: 2020 2020 2020 7265 7475 726e 204d 656d        return Mem
-0000f760: 6f72 7953 7461 7465 2e73 756d 282a 2877  oryState.sum(*(w
-0000f770: 2e6d 656d 6f72 7920 666f 7220 7720 696e  .memory for w in
-0000f780: 2073 656c 662e 776f 726b 6572 732e 7661   self.workers.va
-0000f790: 6c75 6573 2829 2929 0a0a 2020 2020 4070  lues()))..    @p
-0000f7a0: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
-0000f7b0: 5f5f 7064 6963 745f 5f28 7365 6c66 2920  __pdict__(self) 
-0000f7c0: 2d3e 2064 6963 745b 7374 722c 2041 6e79  -> dict[str, Any
-0000f7d0: 5d3a 0a20 2020 2020 2020 2072 6574 7572  ]:.        retur
-0000f7e0: 6e20 7b0a 2020 2020 2020 2020 2020 2020  n {.            
-0000f7f0: 2262 616e 6477 6964 7468 223a 2073 656c  "bandwidth": sel
-0000f800: 662e 6261 6e64 7769 6474 682c 0a20 2020  f.bandwidth,.   
-0000f810: 2020 2020 2020 2020 2022 7265 736f 7572           "resour
-0000f820: 6365 7322 3a20 7365 6c66 2e72 6573 6f75  ces": self.resou
-0000f830: 7263 6573 2c0a 2020 2020 2020 2020 2020  rces,.          
-0000f840: 2020 2273 6174 7572 6174 6564 223a 2073    "saturated": s
-0000f850: 656c 662e 7361 7475 7261 7465 642c 0a20  elf.saturated,. 
-0000f860: 2020 2020 2020 2020 2020 2022 756e 7275             "unru
-0000f870: 6e6e 6162 6c65 223a 2073 656c 662e 756e  nnable": self.un
-0000f880: 7275 6e6e 6162 6c65 2c0a 2020 2020 2020  runnable,.      
-0000f890: 2020 2020 2020 2271 7565 7565 6422 3a20        "queued": 
-0000f8a0: 7365 6c66 2e71 7565 7565 642c 0a20 2020  self.queued,.   
-0000f8b0: 2020 2020 2020 2020 2022 6e5f 7461 736b           "n_task
-0000f8c0: 7322 3a20 7365 6c66 2e6e 5f74 6173 6b73  s": self.n_tasks
-0000f8d0: 2c0a 2020 2020 2020 2020 2020 2020 2275  ,.            "u
-0000f8e0: 6e6b 6e6f 776e 5f64 7572 6174 696f 6e73  nknown_durations
-0000f8f0: 223a 2073 656c 662e 756e 6b6e 6f77 6e5f  ": self.unknown_
-0000f900: 6475 7261 7469 6f6e 732c 0a20 2020 2020  durations,.     
-0000f910: 2020 2020 2020 2022 7661 6c69 6461 7465         "validate
-0000f920: 223a 2073 656c 662e 7661 6c69 6461 7465  ": self.validate
-0000f930: 2c0a 2020 2020 2020 2020 2020 2020 2274  ,.            "t
-0000f940: 6173 6b73 223a 2073 656c 662e 7461 736b  asks": self.task
-0000f950: 732c 0a20 2020 2020 2020 2020 2020 2022  s,.            "
-0000f960: 7461 736b 5f67 726f 7570 7322 3a20 7365  task_groups": se
-0000f970: 6c66 2e74 6173 6b5f 6772 6f75 7073 2c0a  lf.task_groups,.
-0000f980: 2020 2020 2020 2020 2020 2020 2274 6173              "tas
-0000f990: 6b5f 7072 6566 6978 6573 223a 2073 656c  k_prefixes": sel
-0000f9a0: 662e 7461 736b 5f70 7265 6669 7865 732c  f.task_prefixes,
-0000f9b0: 0a20 2020 2020 2020 2020 2020 2022 746f  .            "to
-0000f9c0: 7461 6c5f 6e74 6872 6561 6473 223a 2073  tal_nthreads": s
-0000f9d0: 656c 662e 746f 7461 6c5f 6e74 6872 6561  elf.total_nthrea
-0000f9e0: 6473 2c0a 2020 2020 2020 2020 2020 2020  ds,.            
-0000f9f0: 2274 6f74 616c 5f6f 6363 7570 616e 6379  "total_occupancy
-0000fa00: 223a 2073 656c 662e 746f 7461 6c5f 6f63  ": self.total_oc
-0000fa10: 6375 7061 6e63 792c 0a20 2020 2020 2020  cupancy,.       
-0000fa20: 2020 2020 2022 6572 7265 645f 7461 736b       "erred_task
-0000fa30: 7322 3a20 7365 6c66 2e65 7272 6564 5f74  s": self.erred_t
-0000fa40: 6173 6b73 2c0a 2020 2020 2020 2020 2020  asks,.          
-0000fa50: 2020 2265 7874 656e 7369 6f6e 7322 3a20    "extensions": 
-0000fa60: 7365 6c66 2e65 7874 656e 7369 6f6e 732c  self.extensions,
-0000fa70: 0a20 2020 2020 2020 2020 2020 2022 636c  .            "cl
-0000fa80: 6965 6e74 7322 3a20 7365 6c66 2e63 6c69  ients": self.cli
-0000fa90: 656e 7473 2c0a 2020 2020 2020 2020 2020  ents,.          
-0000faa0: 2020 2277 6f72 6b65 7273 223a 2073 656c    "workers": sel
-0000fab0: 662e 776f 726b 6572 732c 0a20 2020 2020  f.workers,.     
-0000fac0: 2020 2020 2020 2022 6964 6c65 223a 2073         "idle": s
-0000fad0: 656c 662e 6964 6c65 2c0a 2020 2020 2020  elf.idle,.      
-0000fae0: 2020 2020 2020 2268 6f73 745f 696e 666f        "host_info
-0000faf0: 223a 2073 656c 662e 686f 7374 5f69 6e66  ": self.host_inf
-0000fb00: 6f2c 0a20 2020 2020 2020 207d 0a0a 2020  o,.        }..  
-0000fb10: 2020 6465 6620 6e65 775f 7461 736b 280a    def new_task(.
-0000fb20: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
-0000fb30: 2020 2020 2020 6b65 793a 204b 6579 2c0a        key: Key,.
-0000fb40: 2020 2020 2020 2020 7370 6563 3a20 545f          spec: T_
-0000fb50: 7275 6e73 7065 6320 7c20 4e6f 6e65 2c0a  runspec | None,.
-0000fb60: 2020 2020 2020 2020 7374 6174 653a 2054          state: T
-0000fb70: 6173 6b53 7461 7465 5374 6174 652c 0a20  askStateState,. 
-0000fb80: 2020 2020 2020 2063 6f6d 7075 7461 7469         computati
-0000fb90: 6f6e 3a20 436f 6d70 7574 6174 696f 6e20  on: Computation 
-0000fba0: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
-0000fbb0: 2020 2029 202d 3e20 5461 736b 5374 6174     ) -> TaskStat
-0000fbc0: 653a 0a20 2020 2020 2020 2022 2222 4372  e:.        """Cr
-0000fbd0: 6561 7465 2061 206e 6577 2074 6173 6b2c  eate a new task,
-0000fbe0: 2061 6e64 2061 7373 6f63 6961 7465 6420   and associated 
-0000fbf0: 7374 6174 6573 2222 220a 2020 2020 2020  states""".      
-0000fc00: 2020 7473 203d 2054 6173 6b53 7461 7465    ts = TaskState
-0000fc10: 286b 6579 2c20 7370 6563 2c20 7374 6174  (key, spec, stat
-0000fc20: 6529 0a0a 2020 2020 2020 2020 7072 6566  e)..        pref
-0000fc30: 6978 5f6b 6579 203d 206b 6579 5f73 706c  ix_key = key_spl
-0000fc40: 6974 286b 6579 290a 2020 2020 2020 2020  it(key).        
-0000fc50: 7470 203d 2073 656c 662e 7461 736b 5f70  tp = self.task_p
-0000fc60: 7265 6669 7865 732e 6765 7428 7072 6566  refixes.get(pref
-0000fc70: 6978 5f6b 6579 290a 2020 2020 2020 2020  ix_key).        
-0000fc80: 6966 2074 7020 6973 204e 6f6e 653a 0a20  if tp is None:. 
-0000fc90: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000fca0: 7461 736b 5f70 7265 6669 7865 735b 7072  task_prefixes[pr
-0000fcb0: 6566 6978 5f6b 6579 5d20 3d20 7470 203d  efix_key] = tp =
-0000fcc0: 2054 6173 6b50 7265 6669 7828 7072 6566   TaskPrefix(pref
-0000fcd0: 6978 5f6b 6579 290a 2020 2020 2020 2020  ix_key).        
-0000fce0: 7473 2e70 7265 6669 7820 3d20 7470 0a0a  ts.prefix = tp..
-0000fcf0: 2020 2020 2020 2020 6772 6f75 705f 6b65          group_ke
-0000fd00: 7920 3d20 7473 2e67 726f 7570 5f6b 6579  y = ts.group_key
-0000fd10: 0a20 2020 2020 2020 2074 6720 3d20 7365  .        tg = se
-0000fd20: 6c66 2e74 6173 6b5f 6772 6f75 7073 2e67  lf.task_groups.g
-0000fd30: 6574 2867 726f 7570 5f6b 6579 290a 2020  et(group_key).  
-0000fd40: 2020 2020 2020 6966 2074 6720 6973 204e        if tg is N
-0000fd50: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0000fd60: 2073 656c 662e 7461 736b 5f67 726f 7570   self.task_group
-0000fd70: 735b 6772 6f75 705f 6b65 795d 203d 2074  s[group_key] = t
-0000fd80: 6720 3d20 5461 736b 4772 6f75 7028 6772  g = TaskGroup(gr
-0000fd90: 6f75 705f 6b65 7929 0a20 2020 2020 2020  oup_key).       
-0000fda0: 2020 2020 2069 6620 636f 6d70 7574 6174       if computat
-0000fdb0: 696f 6e3a 0a20 2020 2020 2020 2020 2020  ion:.           
-0000fdc0: 2020 2020 2063 6f6d 7075 7461 7469 6f6e       computation
-0000fdd0: 2e67 726f 7570 732e 6164 6428 7467 290a  .groups.add(tg).
-0000fde0: 2020 2020 2020 2020 2020 2020 7467 2e70              tg.p
-0000fdf0: 7265 6669 7820 3d20 7470 0a20 2020 2020  refix = tp.     
-0000fe00: 2020 2020 2020 2074 702e 6772 6f75 7073         tp.groups
-0000fe10: 2e61 7070 656e 6428 7467 290a 2020 2020  .append(tg).    
-0000fe20: 2020 2020 7467 2e61 6464 2874 7329 0a0a      tg.add(ts)..
-0000fe30: 2020 2020 2020 2020 7365 6c66 2e74 6173          self.tas
-0000fe40: 6b73 5b6b 6579 5d20 3d20 7473 0a0a 2020  ks[key] = ts..  
-0000fe50: 2020 2020 2020 7265 7475 726e 2074 730a        return ts.
-0000fe60: 0a20 2020 2064 6566 205f 636c 6561 725f  .    def _clear_
-0000fe70: 7461 736b 5f73 7461 7465 2873 656c 6629  task_state(self)
-0000fe80: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-0000fe90: 2020 6c6f 6767 6572 2e64 6562 7567 2822    logger.debug("
-0000fea0: 436c 6561 7220 7461 736b 2073 7461 7465  Clear task state
-0000feb0: 2229 0a20 2020 2020 2020 2066 6f72 2063  ").        for c
-0000fec0: 6f6c 6c65 6374 696f 6e20 696e 2028 0a20  ollection in (. 
-0000fed0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000fee0: 756e 7275 6e6e 6162 6c65 2c0a 2020 2020  unrunnable,.    
-0000fef0: 2020 2020 2020 2020 7365 6c66 2e65 7272          self.err
-0000ff00: 6564 5f74 6173 6b73 2c0a 2020 2020 2020  ed_tasks,.      
-0000ff10: 2020 2020 2020 7365 6c66 2e63 6f6d 7075        self.compu
-0000ff20: 7461 7469 6f6e 732c 0a20 2020 2020 2020  tations,.       
-0000ff30: 2020 2020 2073 656c 662e 7461 736b 5f70       self.task_p
-0000ff40: 7265 6669 7865 732c 0a20 2020 2020 2020  refixes,.       
-0000ff50: 2020 2020 2073 656c 662e 7461 736b 5f67       self.task_g
-0000ff60: 726f 7570 732c 0a20 2020 2020 2020 2020  roups,.         
-0000ff70: 2020 2073 656c 662e 7461 736b 5f6d 6574     self.task_met
-0000ff80: 6164 6174 612c 0a20 2020 2020 2020 2020  adata,.         
-0000ff90: 2020 2073 656c 662e 756e 6b6e 6f77 6e5f     self.unknown_
-0000ffa0: 6475 7261 7469 6f6e 732c 0a20 2020 2020  durations,.     
-0000ffb0: 2020 2020 2020 2073 656c 662e 7265 706c         self.repl
-0000ffc0: 6963 6174 6564 5f74 6173 6b73 2c0a 2020  icated_tasks,.  
-0000ffd0: 2020 2020 2020 293a 0a20 2020 2020 2020        ):.       
-0000ffe0: 2020 2020 2063 6f6c 6c65 6374 696f 6e2e       collection.
-0000fff0: 636c 6561 7228 2920 2023 2074 7970 653a  clear()  # type:
-00010000: 2069 676e 6f72 650a 0a20 2020 2040 7072   ignore..    @pr
-00010010: 6f70 6572 7479 0a20 2020 2064 6566 2069  operty.    def i
-00010020: 735f 6964 6c65 2873 656c 6629 202d 3e20  s_idle(self) -> 
-00010030: 626f 6f6c 3a0a 2020 2020 2020 2020 2222  bool:.        ""
-00010040: 2252 6574 7572 6e20 5472 7565 2069 6666  "Return True iff
-00010050: 2074 6865 7265 2061 7265 206e 6f20 7461   there are no ta
-00010060: 736b 7320 7468 6174 2068 6176 656e 2774  sks that haven't
-00010070: 2066 696e 6973 6865 6420 636f 6d70 7574   finished comput
-00010080: 696e 672e 0a0a 2020 2020 2020 2020 556e  ing...        Un
-00010090: 6c69 6b65 2074 6573 7469 6e67 2060 6073  like testing ``s
-000100a0: 656c 662e 746f 7461 6c5f 6f63 6375 7061  elf.total_occupa
-000100b0: 6e63 7960 602c 2074 6869 7320 7072 6f70  ncy``, this prop
-000100c0: 6572 7479 2072 6574 7572 6e73 2046 616c  erty returns Fal
-000100d0: 7365 2069 6620 7468 6572 650a 2020 2020  se if there.    
-000100e0: 2020 2020 6172 6520 6c6f 6e67 2d72 756e      are long-run
-000100f0: 6e69 6e67 2074 6173 6b73 2c20 6e6f 2d77  ning tasks, no-w
-00010100: 6f72 6b65 722c 206f 7220 7175 6575 6564  orker, or queued
-00010110: 2074 6173 6b73 2028 6475 6520 746f 206e   tasks (due to n
-00010120: 6f74 2068 6176 696e 6720 616e 790a 2020  ot having any.  
-00010130: 2020 2020 2020 776f 726b 6572 7329 2e0a        workers)..
-00010140: 0a20 2020 2020 2020 204e 6f74 2074 6f20  .        Not to 
-00010150: 6265 2063 6f6e 6675 7365 6420 7769 7468  be confused with
-00010160: 2060 6069 646c 6560 602e 0a20 2020 2020   ``idle``..     
-00010170: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
-00010180: 6574 7572 6e20 616c 6c28 7467 2e64 6f6e  eturn all(tg.don
-00010190: 6520 666f 7220 7467 2069 6e20 7365 6c66  e for tg in self
-000101a0: 2e74 6173 6b5f 6772 6f75 7073 2e76 616c  .task_groups.val
-000101b0: 7565 7328 2929 0a0a 2020 2020 4070 726f  ues())..    @pro
-000101c0: 7065 7274 790a 2020 2020 6465 6620 746f  perty.    def to
-000101d0: 7461 6c5f 6f63 6375 7061 6e63 7928 7365  tal_occupancy(se
-000101e0: 6c66 2920 2d3e 2066 6c6f 6174 3a0a 2020  lf) -> float:.  
-000101f0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-00010200: 662e 5f63 616c 635f 6f63 6375 7061 6e63  f._calc_occupanc
-00010210: 7928 0a20 2020 2020 2020 2020 2020 2073  y(.            s
-00010220: 656c 662e 5f74 6173 6b5f 7072 6566 6978  elf._task_prefix
-00010230: 5f63 6f75 6e74 5f67 6c6f 6261 6c2c 0a20  _count_global,. 
-00010240: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00010250: 5f6e 6574 776f 726b 5f6f 6363 5f67 6c6f  _network_occ_glo
-00010260: 6261 6c2c 0a20 2020 2020 2020 2029 0a0a  bal,.        )..
-00010270: 2020 2020 6465 6620 5f63 616c 635f 6f63      def _calc_oc
-00010280: 6375 7061 6e63 7928 0a20 2020 2020 2020  cupancy(.       
-00010290: 2073 656c 662c 0a20 2020 2020 2020 2074   self,.        t
-000102a0: 6173 6b5f 7072 6566 6978 5f63 6f75 6e74  ask_prefix_count
-000102b0: 3a20 6469 6374 5b73 7472 2c20 696e 745d  : dict[str, int]
-000102c0: 2c0a 2020 2020 2020 2020 6e65 7477 6f72  ,.        networ
-000102d0: 6b5f 6f63 633a 2066 6c6f 6174 2c0a 2020  k_occ: float,.  
-000102e0: 2020 2920 2d3e 2066 6c6f 6174 3a0a 2020    ) -> float:.  
-000102f0: 2020 2020 2020 7265 7320 3d20 302e 300a        res = 0.0.
-00010300: 2020 2020 2020 2020 666f 7220 7072 6566          for pref
-00010310: 6978 5f6e 616d 652c 2063 6f75 6e74 2069  ix_name, count i
-00010320: 6e20 7461 736b 5f70 7265 6669 785f 636f  n task_prefix_co
-00010330: 756e 742e 6974 656d 7328 293a 0a20 2020  unt.items():.   
-00010340: 2020 2020 2020 2020 2023 2054 4f44 4f3a           # TODO:
-00010350: 2044 6561 6c20 7769 7468 2075 6e6b 6e6f   Deal with unkno
-00010360: 776e 2074 6173 6b73 2062 6574 7465 720a  wn tasks better.
-00010370: 2020 2020 2020 2020 2020 2020 7072 6566              pref
-00010380: 6978 203d 2073 656c 662e 7461 736b 5f70  ix = self.task_p
-00010390: 7265 6669 7865 735b 7072 6566 6978 5f6e  refixes[prefix_n
-000103a0: 616d 655d 0a20 2020 2020 2020 2020 2020  ame].           
-000103b0: 2061 7373 6572 7420 7072 6566 6978 2069   assert prefix i
-000103c0: 7320 6e6f 7420 4e6f 6e65 0a20 2020 2020  s not None.     
-000103d0: 2020 2020 2020 2064 7572 6174 696f 6e20         duration 
-000103e0: 3d20 7072 6566 6978 2e64 7572 6174 696f  = prefix.duratio
-000103f0: 6e5f 6176 6572 6167 650a 2020 2020 2020  n_average.      
-00010400: 2020 2020 2020 6966 2064 7572 6174 696f        if duratio
-00010410: 6e20 3c20 303a 0a20 2020 2020 2020 2020  n < 0:.         
-00010420: 2020 2020 2020 2069 6620 7072 6566 6978         if prefix
-00010430: 2e6d 6178 5f65 7865 635f 7469 6d65 203e  .max_exec_time >
-00010440: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-00010450: 2020 2020 2020 2020 6475 7261 7469 6f6e          duration
-00010460: 203d 2032 202a 2070 7265 6669 782e 6d61   = 2 * prefix.ma
-00010470: 785f 6578 6563 5f74 696d 650a 2020 2020  x_exec_time.    
-00010480: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00010490: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000104a0: 2020 2020 2020 6475 7261 7469 6f6e 203d        duration =
-000104b0: 2073 656c 662e 554e 4b4e 4f57 4e5f 5441   self.UNKNOWN_TA
-000104c0: 534b 5f44 5552 4154 494f 4e0a 2020 2020  SK_DURATION.    
-000104d0: 2020 2020 2020 2020 7265 7320 2b3d 2064          res += d
-000104e0: 7572 6174 696f 6e20 2a20 636f 756e 740a  uration * count.
-000104f0: 2020 2020 2020 2020 6f63 6320 3d20 7265          occ = re
-00010500: 7320 2b20 6e65 7477 6f72 6b5f 6f63 6320  s + network_occ 
-00010510: 2f20 7365 6c66 2e62 616e 6477 6964 7468  / self.bandwidth
-00010520: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-00010530: 6f63 6320 3e3d 2030 2c20 286f 6363 2c20  occ >= 0, (occ, 
-00010540: 7265 732c 206e 6574 776f 726b 5f6f 6363  res, network_occ
-00010550: 2c20 7365 6c66 2e62 616e 6477 6964 7468  , self.bandwidth
-00010560: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00010570: 206f 6363 0a0a 2020 2020 2323 2323 2323   occ..    ######
-00010580: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
-00010590: 2020 2020 2320 5374 6174 6520 5472 616e      # State Tran
-000105a0: 7369 7469 6f6e 7320 230a 2020 2020 2323  sitions #.    ##
-000105b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000105c0: 2323 230a 0a20 2020 2064 6566 205f 7472  ###..    def _tr
-000105d0: 616e 7369 7469 6f6e 280a 2020 2020 2020  ansition(.      
-000105e0: 2020 7365 6c66 2c20 6b65 793a 204b 6579    self, key: Key
-000105f0: 2c20 6669 6e69 7368 3a20 5461 736b 5374  , finish: TaskSt
-00010600: 6174 6553 7461 7465 2c20 7374 696d 756c  ateState, stimul
-00010610: 7573 5f69 643a 2073 7472 2c20 2a2a 6b77  us_id: str, **kw
-00010620: 6172 6773 3a20 416e 790a 2020 2020 2920  args: Any.    ) 
-00010630: 2d3e 2052 6563 734d 7367 733a 0a20 2020  -> RecsMsgs:.   
-00010640: 2020 2020 2022 2222 5472 616e 7369 7469       """Transiti
-00010650: 6f6e 2061 206b 6579 2066 726f 6d20 6974  on a key from it
-00010660: 7320 6375 7272 656e 7420 7374 6174 6520  s current state 
-00010670: 746f 2074 6865 2066 696e 6973 6820 7374  to the finish st
-00010680: 6174 650a 0a20 2020 2020 2020 2045 7861  ate..        Exa
-00010690: 6d70 6c65 730a 2020 2020 2020 2020 2d2d  mples.        --
-000106a0: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 203e  ------.        >
-000106b0: 3e3e 2073 656c 662e 5f74 7261 6e73 6974  >> self._transit
-000106c0: 696f 6e28 2778 272c 2027 7761 6974 696e  ion('x', 'waitin
-000106d0: 6727 290a 2020 2020 2020 2020 7b27 7827  g').        {'x'
-000106e0: 3a20 2770 726f 6365 7373 696e 6727 7d2c  : 'processing'},
-000106f0: 207b 7d2c 207b 7d0a 0a20 2020 2020 2020   {}, {}..       
-00010700: 2052 6574 7572 6e73 0a20 2020 2020 2020   Returns.       
-00010710: 202d 2d2d 2d2d 2d2d 0a20 2020 2020 2020   -------.       
-00010720: 2054 7570 6c65 206f 663a 0a0a 2020 2020   Tuple of:..    
-00010730: 2020 2020 2d20 4469 6374 696f 6e61 7279      - Dictionary
-00010740: 206f 6620 7265 636f 6d6d 656e 6461 7469   of recommendati
-00010750: 6f6e 7320 666f 7220 6675 7475 7265 2074  ons for future t
-00010760: 7261 6e73 6974 696f 6e73 207b 6b65 793a  ransitions {key:
-00010770: 206e 6577 2073 7461 7465 7d0a 2020 2020   new state}.    
-00010780: 2020 2020 2d20 4d65 7373 6167 6573 2074      - Messages t
-00010790: 6f20 636c 6965 6e74 7320 7b63 6c69 656e  o clients {clien
-000107a0: 7420 6164 6472 6573 733a 205b 6d73 672c  t address: [msg,
-000107b0: 206d 7367 2c20 2e2e 2e5d 7d0a 2020 2020   msg, ...]}.    
-000107c0: 2020 2020 2d20 4d65 7373 6167 6573 2074      - Messages t
-000107d0: 6f20 776f 726b 6572 7320 7b77 6f72 6b65  o workers {worke
-000107e0: 7220 6164 6472 6573 733a 205b 6d73 672c  r address: [msg,
-000107f0: 206d 7367 2c20 2e2e 2e5d 7d0a 0a20 2020   msg, ...]}..   
-00010800: 2020 2020 2053 6565 2041 6c73 6f0a 2020       See Also.  
-00010810: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20        --------. 
-00010820: 2020 2020 2020 2053 6368 6564 756c 6572         Scheduler
-00010830: 2e74 7261 6e73 6974 696f 6e73 203a 2074  .transitions : t
-00010840: 7261 6e73 6974 6976 6520 7665 7273 696f  ransitive versio
-00010850: 6e20 6f66 2074 6869 7320 6675 6e63 7469  n of this functi
-00010860: 6f6e 0a20 2020 2020 2020 2022 2222 0a20  on.        """. 
-00010870: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00010880: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
-00010890: 662e 7461 736b 732e 6765 7428 6b65 7929  f.tasks.get(key)
-000108a0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000108b0: 7473 2069 7320 4e6f 6e65 3a0a 2020 2020  ts is None:.    
-000108c0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-000108d0: 726e 207b 7d2c 207b 7d2c 207b 7d0a 2020  rn {}, {}, {}.  
-000108e0: 2020 2020 2020 2020 2020 7374 6172 7420            start 
-000108f0: 3d20 7473 2e5f 7374 6174 650a 2020 2020  = ts._state.    
-00010900: 2020 2020 2020 2020 6966 2073 7461 7274          if start
-00010910: 203d 3d20 6669 6e69 7368 3a0a 2020 2020   == finish:.    
-00010920: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00010930: 726e 207b 7d2c 207b 7d2c 207b 7d0a 0a20  rn {}, {}, {}.. 
-00010940: 2020 2020 2020 2020 2020 2023 204e 6f74             # Not
-00010950: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-00010960: 2320 2d20 696e 2063 6173 6520 6f66 2074  # - in case of t
-00010970: 7261 6e73 6974 696f 6e20 7468 726f 7567  ransition throug
-00010980: 6820 7265 6c65 6173 6564 2c20 7468 6973  h released, this
-00010990: 2063 6f75 6e74 6572 2069 7320 696e 6372   counter is incr
-000109a0: 656d 656e 7465 6420 6279 2032 0a20 2020  emented by 2.   
-000109b0: 2020 2020 2020 2020 2023 202d 2074 6869           # - thi
-000109c0: 7320 696e 6372 6561 7365 2068 6170 7065  s increase happe
-000109d0: 6e73 2062 6566 6f72 6520 7468 6520 6163  ns before the ac
-000109e0: 7475 616c 2074 7261 6e73 6974 696f 6e73  tual transitions
-000109f0: 2c20 736f 2074 6861 7420 6974 2063 616e  , so that it can
-00010a00: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
-00010a10: 2063 6174 6368 2070 6f74 656e 7469 616c   catch potential
-00010a20: 2069 6e66 696e 6974 6520 7265 6375 7273   infinite recurs
-00010a30: 696f 6e73 0a20 2020 2020 2020 2020 2020  ions.           
-00010a40: 2073 656c 662e 7472 616e 7369 7469 6f6e   self.transition
-00010a50: 5f63 6f75 6e74 6572 202b 3d20 310a 2020  _counter += 1.  
-00010a60: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-00010a70: 662e 7472 616e 7369 7469 6f6e 5f63 6f75  f.transition_cou
-00010a80: 6e74 6572 5f6d 6178 3a0a 2020 2020 2020  nter_max:.      
-00010a90: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00010aa0: 2073 656c 662e 7472 616e 7369 7469 6f6e   self.transition
-00010ab0: 5f63 6f75 6e74 6572 203c 2073 656c 662e  _counter < self.
-00010ac0: 7472 616e 7369 7469 6f6e 5f63 6f75 6e74  transition_count
-00010ad0: 6572 5f6d 6178 0a0a 2020 2020 2020 2020  er_max..        
-00010ae0: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
-00010af0: 6f6e 733a 2052 6563 7320 3d20 7b7d 0a20  ons: Recs = {}. 
-00010b00: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
-00010b10: 725f 6d73 6773 3a20 4d73 6773 203d 207b  r_msgs: Msgs = {
-00010b20: 7d0a 2020 2020 2020 2020 2020 2020 636c  }.            cl
-00010b30: 6965 6e74 5f6d 7367 733a 204d 7367 7320  ient_msgs: Msgs 
-00010b40: 3d20 7b7d 0a0a 2020 2020 2020 2020 2020  = {}..          
-00010b50: 2020 6966 2073 656c 662e 706c 7567 696e    if self.plugin
-00010b60: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00010b70: 2020 2064 6570 656e 6465 6e74 7320 3d20     dependents = 
-00010b80: 7365 7428 7473 2e64 6570 656e 6465 6e74  set(ts.dependent
-00010b90: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
-00010ba0: 2020 2064 6570 656e 6465 6e63 6965 7320     dependencies 
-00010bb0: 3d20 7365 7428 7473 2e64 6570 656e 6465  = set(ts.depende
-00010bc0: 6e63 6965 7329 0a0a 2020 2020 2020 2020  ncies)..        
-00010bd0: 2020 2020 6675 6e63 203d 2073 656c 662e      func = self.
-00010be0: 5f54 5241 4e53 4954 494f 4e53 5f54 4142  _TRANSITIONS_TAB
-00010bf0: 4c45 2e67 6574 2828 7374 6172 742c 2066  LE.get((start, f
-00010c00: 696e 6973 6829 290a 2020 2020 2020 2020  inish)).        
-00010c10: 2020 2020 6966 2066 756e 6320 6973 206e      if func is n
-00010c20: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00010c30: 2020 2020 2020 2020 2072 6563 6f6d 6d65           recomme
-00010c40: 6e64 6174 696f 6e73 2c20 636c 6965 6e74  ndations, client
-00010c50: 5f6d 7367 732c 2077 6f72 6b65 725f 6d73  _msgs, worker_ms
-00010c60: 6773 203d 2066 756e 6328 0a20 2020 2020  gs = func(.     
-00010c70: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00010c80: 656c 662c 206b 6579 2c20 7374 696d 756c  elf, key, stimul
-00010c90: 7573 5f69 642c 202a 2a6b 7761 7267 730a  us_id, **kwargs.
-00010ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010cb0: 290a 0a20 2020 2020 2020 2020 2020 2065  )..            e
-00010cc0: 6c69 6620 2272 656c 6561 7365 6422 206e  lif "released" n
-00010cd0: 6f74 2069 6e20 2873 7461 7274 2c20 6669  ot in (start, fi
-00010ce0: 6e69 7368 293a 0a20 2020 2020 2020 2020  nish):.         
-00010cf0: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
-00010d00: 7420 6b77 6172 6773 2c20 286b 7761 7267  t kwargs, (kwarg
-00010d10: 732c 2073 7461 7274 2c20 6669 6e69 7368  s, start, finish
-00010d20: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00010d30: 2020 615f 7265 6373 2c20 615f 636d 7367    a_recs, a_cmsg
-00010d40: 732c 2061 5f77 6d73 6773 203d 2073 656c  s, a_wmsgs = sel
-00010d50: 662e 5f74 7261 6e73 6974 696f 6e28 0a20  f._transition(. 
-00010d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010d70: 2020 206b 6579 2c20 2272 656c 6561 7365     key, "release
-00010d80: 6422 2c20 7374 696d 756c 7573 5f69 640a  d", stimulus_id.
-00010d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010da0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-00010db0: 2020 2076 203d 2061 5f72 6563 732e 6765     v = a_recs.ge
-00010dc0: 7428 6b65 792c 2066 696e 6973 6829 0a20  t(key, finish). 
-00010dd0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00010de0: 2054 6865 2069 6e6e 6572 2072 6563 2068   The inner rec h
-00010df0: 6173 2068 6967 6865 7220 7072 696f 7269  as higher priori
-00010e00: 7479 3f20 4973 2074 6861 7420 616c 7761  ty? Is that alwa
-00010e10: 7973 2064 6573 6972 6564 3f0a 2020 2020  ys desired?.    
-00010e20: 2020 2020 2020 2020 2020 2020 6675 6e63              func
-00010e30: 203d 2073 656c 662e 5f54 5241 4e53 4954   = self._TRANSIT
-00010e40: 494f 4e53 5f54 4142 4c45 5b22 7265 6c65  IONS_TABLE["rele
-00010e50: 6173 6564 222c 2076 5d0a 2020 2020 2020  ased", v].      
-00010e60: 2020 2020 2020 2020 2020 625f 7265 6373            b_recs
-00010e70: 2c20 625f 636d 7367 732c 2062 5f77 6d73  , b_cmsgs, b_wms
-00010e80: 6773 203d 2066 756e 6328 7365 6c66 2c20  gs = func(self, 
-00010e90: 6b65 792c 2073 7469 6d75 6c75 735f 6964  key, stimulus_id
-00010ea0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-00010eb0: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
-00010ec0: 6e73 2e75 7064 6174 6528 615f 7265 6373  ns.update(a_recs
-00010ed0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00010ee0: 2020 666f 7220 632c 206e 6577 5f6d 7367    for c, new_msg
-00010ef0: 7320 696e 2061 5f63 6d73 6773 2e69 7465  s in a_cmsgs.ite
-00010f00: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
-00010f10: 2020 2020 2020 2020 2020 636c 6965 6e74            client
-00010f20: 5f6d 7367 732e 7365 7464 6566 6175 6c74  _msgs.setdefault
-00010f30: 2863 2c20 5b5d 292e 6578 7465 6e64 286e  (c, []).extend(n
-00010f40: 6577 5f6d 7367 7329 0a20 2020 2020 2020  ew_msgs).       
-00010f50: 2020 2020 2020 2020 2066 6f72 2077 2c20           for w, 
-00010f60: 6e65 775f 6d73 6773 2069 6e20 615f 776d  new_msgs in a_wm
-00010f70: 7367 732e 6974 656d 7328 293a 0a20 2020  sgs.items():.   
-00010f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010f90: 2077 6f72 6b65 725f 6d73 6773 2e73 6574   worker_msgs.set
-00010fa0: 6465 6661 756c 7428 772c 205b 5d29 2e65  default(w, []).e
-00010fb0: 7874 656e 6428 6e65 775f 6d73 6773 290a  xtend(new_msgs).
-00010fc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010fd0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-00010fe0: 2e75 7064 6174 6528 625f 7265 6373 290a  .update(b_recs).
-00010ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011000: 666f 7220 632c 206e 6577 5f6d 7367 7320  for c, new_msgs 
-00011010: 696e 2062 5f63 6d73 6773 2e69 7465 6d73  in b_cmsgs.items
-00011020: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00011030: 2020 2020 2020 2020 636c 6965 6e74 5f6d          client_m
-00011040: 7367 732e 7365 7464 6566 6175 6c74 2863  sgs.setdefault(c
-00011050: 2c20 5b5d 292e 6578 7465 6e64 286e 6577  , []).extend(new
-00011060: 5f6d 7367 7329 0a20 2020 2020 2020 2020  _msgs).         
-00011070: 2020 2020 2020 2066 6f72 2077 2c20 6e65         for w, ne
-00011080: 775f 6d73 6773 2069 6e20 625f 776d 7367  w_msgs in b_wmsg
-00011090: 732e 6974 656d 7328 293a 0a20 2020 2020  s.items():.     
-000110a0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-000110b0: 6f72 6b65 725f 6d73 6773 2e73 6574 6465  orker_msgs.setde
-000110c0: 6661 756c 7428 772c 205b 5d29 2e65 7874  fault(w, []).ext
-000110d0: 656e 6428 6e65 775f 6d73 6773 290a 0a20  end(new_msgs).. 
-000110e0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000110f0: 7461 7274 203d 2022 7265 6c65 6173 6564  tart = "released
-00011100: 220a 2020 2020 2020 2020 2020 2020 656c  ".            el
-00011110: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00011120: 2020 2020 7261 6973 6520 5275 6e74 696d      raise Runtim
-00011130: 6545 7272 6f72 280a 2020 2020 2020 2020  eError(.        
-00011140: 2020 2020 2020 2020 2020 2020 6622 496d              f"Im
-00011150: 706f 7373 6962 6c65 2074 7261 6e73 6974  possible transit
-00011160: 696f 6e20 6672 6f6d 207b 7374 6172 747d  ion from {start}
-00011170: 2074 6f20 7b66 696e 6973 687d 2066 6f72   to {finish} for
-00011180: 207b 6b65 7921 727d 3a20 220a 2020 2020   {key!r}: ".    
-00011190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000111a0: 6622 7b73 7469 6d75 6c75 735f 6964 3d7d  f"{stimulus_id=}
-000111b0: 2c20 7b6b 7761 7267 733d 7d2c 2073 746f  , {kwargs=}, sto
-000111c0: 7279 3d7b 7365 6c66 2e73 746f 7279 2874  ry={self.story(t
-000111d0: 7329 7d22 0a20 2020 2020 2020 2020 2020  s)}".           
-000111e0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-000111f0: 2020 2020 6966 206e 6f74 2073 7469 6d75      if not stimu
-00011200: 6c75 735f 6964 3a0a 2020 2020 2020 2020  lus_id:.        
-00011210: 2020 2020 2020 2020 7374 696d 756c 7573          stimulus
-00011220: 5f69 6420 3d20 5354 494d 554c 5553 5f49  _id = STIMULUS_I
-00011230: 445f 554e 5345 540a 0a20 2020 2020 2020  D_UNSET..       
-00011240: 2020 2020 2061 6374 7561 6c5f 6669 6e69       actual_fini
-00011250: 7368 203d 2074 732e 5f73 7461 7465 0a20  sh = ts._state. 
-00011260: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00011270: 7472 616e 7369 7469 6f6e 5f6c 6f67 2e61  transition_log.a
-00011280: 7070 656e 6428 0a20 2020 2020 2020 2020  ppend(.         
-00011290: 2020 2020 2020 2054 7261 6e73 6974 696f         Transitio
-000112a0: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
-000112b0: 2020 2020 2020 206b 6579 2c20 7374 6172         key, star
-000112c0: 742c 2061 6374 7561 6c5f 6669 6e69 7368  t, actual_finish
-000112d0: 2c20 7265 636f 6d6d 656e 6461 7469 6f6e  , recommendation
-000112e0: 732c 2073 7469 6d75 6c75 735f 6964 2c20  s, stimulus_id, 
-000112f0: 7469 6d65 2829 0a20 2020 2020 2020 2020  time().         
-00011300: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00000c40: 2053 7061 6e4d 6574 6164 6174 612c 2053   SpanMetadata, S
+00000c50: 7061 6e73 5363 6865 6475 6c65 7245 7874  pansSchedulerExt
+00000c60: 656e 7369 6f6e 0a66 726f 6d20 6469 7374  ension.from dist
+00000c70: 7269 6275 7465 642e 7374 6561 6c69 6e67  ributed.stealing
+00000c80: 2069 6d70 6f72 7420 576f 726b 5374 6561   import WorkStea
+00000c90: 6c69 6e67 0a66 726f 6d20 6469 7374 7269  ling.from distri
+00000ca0: 6275 7465 642e 7574 696c 7320 696d 706f  buted.utils impo
+00000cb0: 7274 2028 0a20 2020 2041 6c6c 2c0a 2020  rt (.    All,.  
+00000cc0: 2020 4465 6164 6c69 6e65 2c0a 2020 2020    Deadline,.    
+00000cd0: 5469 6d65 6f75 7445 7272 6f72 2c0a 2020  TimeoutError,.  
+00000ce0: 2020 666f 726d 6174 5f64 6173 6862 6f61    format_dashboa
+00000cf0: 7264 5f6c 696e 6b2c 0a20 2020 2067 6574  rd_link,.    get
+00000d00: 5f66 696c 656e 6f5f 6c69 6d69 742c 0a20  _fileno_limit,. 
+00000d10: 2020 2069 735f 7079 7468 6f6e 5f73 6875     is_python_shu
+00000d20: 7474 696e 675f 646f 776e 2c0a 2020 2020  tting_down,.    
+00000d30: 6b65 795f 7370 6c69 745f 6772 6f75 702c  key_split_group,
+00000d40: 0a20 2020 206c 6f67 5f65 7272 6f72 732c  .    log_errors,
+00000d50: 0a20 2020 206f 6666 6c6f 6164 2c0a 2020  .    offload,.  
+00000d60: 2020 7265 6375 7273 6976 655f 746f 5f64    recursive_to_d
+00000d70: 6963 742c 0a20 2020 2077 6169 745f 666f  ict,.    wait_fo
+00000d80: 722c 0a29 0a66 726f 6d20 6469 7374 7269  r,.).from distri
+00000d90: 6275 7465 642e 7574 696c 735f 636f 6d6d  buted.utils_comm
+00000da0: 2069 6d70 6f72 7420 280a 2020 2020 6761   import (.    ga
+00000db0: 7468 6572 5f66 726f 6d5f 776f 726b 6572  ther_from_worker
+00000dc0: 732c 0a20 2020 2072 6574 7279 5f6f 7065  s,.    retry_ope
+00000dd0: 7261 7469 6f6e 2c0a 2020 2020 7363 6174  ration,.    scat
+00000de0: 7465 725f 746f 5f77 6f72 6b65 7273 2c0a  ter_to_workers,.
+00000df0: 2020 2020 756e 7061 636b 5f72 656d 6f74      unpack_remot
+00000e00: 6564 6174 612c 0a29 0a66 726f 6d20 6469  edata,.).from di
+00000e10: 7374 7269 6275 7465 642e 7574 696c 735f  stributed.utils_
+00000e20: 7065 7266 2069 6d70 6f72 7420 6469 7361  perf import disa
+00000e30: 626c 655f 6763 5f64 6961 676e 6f73 6973  ble_gc_diagnosis
+00000e40: 2c20 656e 6162 6c65 5f67 635f 6469 6167  , enable_gc_diag
+00000e50: 6e6f 7369 730a 6672 6f6d 2064 6973 7472  nosis.from distr
+00000e60: 6962 7574 6564 2e76 6172 6961 626c 6520  ibuted.variable 
+00000e70: 696d 706f 7274 2056 6172 6961 626c 6545  import VariableE
+00000e80: 7874 656e 7369 6f6e 0a66 726f 6d20 6469  xtension.from di
+00000e90: 7374 7269 6275 7465 642e 776f 726b 6572  stributed.worker
+00000ea0: 2069 6d70 6f72 7420 5f6e 6f72 6d61 6c69   import _normali
+00000eb0: 7a65 5f74 6173 6b0a 0a69 6620 5459 5045  ze_task..if TYPE
+00000ec0: 5f43 4845 434b 494e 473a 0a20 2020 2023  _CHECKING:.    #
+00000ed0: 2054 4f44 4f20 696d 706f 7274 2066 726f   TODO import fro
+00000ee0: 6d20 7479 7069 6e67 2028 7265 7175 6972  m typing (requir
+00000ef0: 6573 2050 7974 686f 6e20 3e3d 332e 3130  es Python >=3.10
+00000f00: 290a 2020 2020 2320 544f 444f 2069 6d70  ).    # TODO imp
+00000f10: 6f72 7420 6672 6f6d 2074 7970 696e 6720  ort from typing 
+00000f20: 2872 6571 7569 7265 7320 5079 7468 6f6e  (requires Python
+00000f30: 203e 3d33 2e31 3129 0a20 2020 2066 726f   >=3.11).    fro
+00000f40: 6d20 7479 7069 6e67 5f65 7874 656e 7369  m typing_extensi
+00000f50: 6f6e 7320 696d 706f 7274 2053 656c 662c  ons import Self,
+00000f60: 2054 7970 6541 6c69 6173 0a0a 2020 2020   TypeAlias..    
+00000f70: 6672 6f6d 2064 6173 6b2e 6869 6768 6c65  from dask.highle
+00000f80: 7665 6c67 7261 7068 2069 6d70 6f72 7420  velgraph import 
+00000f90: 4869 6768 4c65 7665 6c47 7261 7068 0a0a  HighLevelGraph..
+00000fa0: 2320 4e6f 7420 746f 2062 6520 636f 6e66  # Not to be conf
+00000fb0: 7573 6564 2077 6974 6820 6469 7374 7269  used with distri
+00000fc0: 6275 7465 642e 776f 726b 6572 5f73 7461  buted.worker_sta
+00000fd0: 7465 5f6d 6163 6869 6e65 2e54 6173 6b53  te_machine.TaskS
+00000fe0: 7461 7465 5374 6174 650a 5461 736b 5374  tateState.TaskSt
+00000ff0: 6174 6553 7461 7465 3a20 5479 7065 416c  ateState: TypeAl
+00001000: 6961 7320 3d20 4c69 7465 7261 6c5b 0a20  ias = Literal[. 
+00001010: 2020 2022 7265 6c65 6173 6564 222c 0a20     "released",. 
+00001020: 2020 2022 7761 6974 696e 6722 2c0a 2020     "waiting",.  
+00001030: 2020 226e 6f2d 776f 726b 6572 222c 0a20    "no-worker",. 
+00001040: 2020 2022 7175 6575 6564 222c 0a20 2020     "queued",.   
+00001050: 2022 7072 6f63 6573 7369 6e67 222c 0a20   "processing",. 
+00001060: 2020 2022 6d65 6d6f 7279 222c 0a20 2020     "memory",.   
+00001070: 2022 6572 7265 6422 2c0a 2020 2020 2266   "erred",.    "f
+00001080: 6f72 676f 7474 656e 222c 0a5d 0a0a 414c  orgotten",.]..AL
+00001090: 4c5f 5441 534b 5f53 5441 5445 533a 2053  L_TASK_STATES: S
+000010a0: 6574 5b54 6173 6b53 7461 7465 5374 6174  et[TaskStateStat
+000010b0: 655d 203d 2073 6574 2854 6173 6b53 7461  e] = set(TaskSta
+000010c0: 7465 5374 6174 652e 5f5f 6172 6773 5f5f  teState.__args__
+000010d0: 2920 2023 2074 7970 653a 2069 676e 6f72  )  # type: ignor
+000010e0: 650a 0a23 207b 7461 736b 206b 6579 202d  e..# {task key -
+000010f0: 3e20 6669 6e69 7368 2073 7461 7465 7d0a  > finish state}.
+00001100: 2320 4e6f 7420 746f 2062 6520 636f 6e66  # Not to be conf
+00001110: 7573 6564 2077 6974 6820 6469 7374 7269  used with distri
+00001120: 6275 7465 642e 776f 726b 6572 5f73 7461  buted.worker_sta
+00001130: 7465 5f6d 6163 6869 6e65 2e52 6563 730a  te_machine.Recs.
+00001140: 5265 6373 3a20 5479 7065 416c 6961 7320  Recs: TypeAlias 
+00001150: 3d20 6469 6374 5b4b 6579 2c20 5461 736b  = dict[Key, Task
+00001160: 5374 6174 6553 7461 7465 5d0a 2320 7b63  StateState].# {c
+00001170: 6c69 656e 7420 6f72 2077 6f72 6b65 7220  lient or worker 
+00001180: 6164 6472 6573 733a 205b 7b6f 703a 203c  address: [{op: <
+00001190: 6b65 793e 2c20 2e2e 2e7d 2c20 2e2e 2e5d  key>, ...}, ...]
+000011a0: 7d0a 4d73 6773 3a20 5479 7065 416c 6961  }.Msgs: TypeAlia
+000011b0: 7320 3d20 6469 6374 5b73 7472 2c20 6c69  s = dict[str, li
+000011c0: 7374 5b64 6963 745b 7374 722c 2041 6e79  st[dict[str, Any
+000011d0: 5d5d 5d0a 2320 2872 6563 6f6d 6d65 6e64  ]]].# (recommend
+000011e0: 6174 696f 6e73 2c20 636c 6965 6e74 206d  ations, client m
+000011f0: 6573 7361 6765 732c 2077 6f72 6b65 7220  essages, worker 
+00001200: 6d65 7373 6167 6573 290a 5265 6373 4d73  messages).RecsMs
+00001210: 6773 3a20 5479 7065 416c 6961 7320 3d20  gs: TypeAlias = 
+00001220: 7475 706c 655b 5265 6373 2c20 4d73 6773  tuple[Recs, Msgs
+00001230: 2c20 4d73 6773 5d0a 0a54 5f72 756e 7370  , Msgs]..T_runsp
+00001240: 6563 3a20 5479 7065 416c 6961 7320 3d20  ec: TypeAlias = 
+00001250: 7475 706c 655b 4361 6c6c 6162 6c65 2c20  tuple[Callable, 
+00001260: 7475 706c 652c 2064 6963 745b 7374 722c  tuple, dict[str,
+00001270: 2041 6e79 5d5d 0a0a 6c6f 6767 6572 203d   Any]]..logger =
+00001280: 206c 6f67 6769 6e67 2e67 6574 4c6f 6767   logging.getLogg
+00001290: 6572 285f 5f6e 616d 655f 5f29 0a4c 4f47  er(__name__).LOG
+000012a0: 5f50 4442 203d 2064 6173 6b2e 636f 6e66  _PDB = dask.conf
+000012b0: 6967 2e67 6574 2822 6469 7374 7269 6275  ig.get("distribu
+000012c0: 7465 642e 6164 6d69 6e2e 7064 622d 6f6e  ted.admin.pdb-on
+000012d0: 2d65 7272 2229 0a44 4546 4155 4c54 5f44  -err").DEFAULT_D
+000012e0: 4154 415f 5349 5a45 203d 2070 6172 7365  ATA_SIZE = parse
+000012f0: 5f62 7974 6573 280a 2020 2020 6461 736b  _bytes(.    dask
+00001300: 2e63 6f6e 6669 672e 6765 7428 2264 6973  .config.get("dis
+00001310: 7472 6962 7574 6564 2e73 6368 6564 756c  tributed.schedul
+00001320: 6572 2e64 6566 6175 6c74 2d64 6174 612d  er.default-data-
+00001330: 7369 7a65 2229 0a29 0a53 5449 4d55 4c55  size").).STIMULU
+00001340: 535f 4944 5f55 4e53 4554 203d 2022 3c73  S_ID_UNSET = "<s
+00001350: 7469 6d75 6c75 735f 6964 2075 6e73 6574  timulus_id unset
+00001360: 3e22 0a0a 4445 4641 554c 545f 4558 5445  >"..DEFAULT_EXTE
+00001370: 4e53 494f 4e53 203d 207b 0a20 2020 2022  NSIONS = {.    "
+00001380: 6c6f 636b 7322 3a20 4c6f 636b 4578 7465  locks": LockExte
+00001390: 6e73 696f 6e2c 0a20 2020 2022 6d75 6c74  nsion,.    "mult
+000013a0: 695f 6c6f 636b 7322 3a20 4d75 6c74 694c  i_locks": MultiL
+000013b0: 6f63 6b45 7874 656e 7369 6f6e 2c0a 2020  ockExtension,.  
+000013c0: 2020 2270 7562 6c69 7368 223a 2050 7562    "publish": Pub
+000013d0: 6c69 7368 4578 7465 6e73 696f 6e2c 0a20  lishExtension,. 
+000013e0: 2020 2022 7265 706c 6179 2d74 6173 6b73     "replay-tasks
+000013f0: 223a 2052 6570 6c61 7954 6173 6b53 6368  ": ReplayTaskSch
+00001400: 6564 756c 6572 2c0a 2020 2020 2271 7565  eduler,.    "que
+00001410: 7565 7322 3a20 5175 6575 6545 7874 656e  ues": QueueExten
+00001420: 7369 6f6e 2c0a 2020 2020 2276 6172 6961  sion,.    "varia
+00001430: 626c 6573 223a 2056 6172 6961 626c 6545  bles": VariableE
+00001440: 7874 656e 7369 6f6e 2c0a 2020 2020 2270  xtension,.    "p
+00001450: 7562 7375 6222 3a20 5075 6253 7562 5363  ubsub": PubSubSc
+00001460: 6865 6475 6c65 7245 7874 656e 7369 6f6e  hedulerExtension
+00001470: 2c0a 2020 2020 2273 656d 6170 686f 7265  ,.    "semaphore
+00001480: 7322 3a20 5365 6d61 7068 6f72 6545 7874  s": SemaphoreExt
+00001490: 656e 7369 6f6e 2c0a 2020 2020 2265 7665  ension,.    "eve
+000014a0: 6e74 7322 3a20 4576 656e 7445 7874 656e  nts": EventExten
+000014b0: 7369 6f6e 2c0a 2020 2020 2261 6d6d 223a  sion,.    "amm":
+000014c0: 2041 6374 6976 654d 656d 6f72 794d 616e   ActiveMemoryMan
+000014d0: 6167 6572 4578 7465 6e73 696f 6e2c 0a20  agerExtension,. 
+000014e0: 2020 2022 6d65 6d6f 7279 5f73 616d 706c     "memory_sampl
+000014f0: 6572 223a 204d 656d 6f72 7953 616d 706c  er": MemorySampl
+00001500: 6572 4578 7465 6e73 696f 6e2c 0a20 2020  erExtension,.   
+00001510: 2022 7368 7566 666c 6522 3a20 5368 7566   "shuffle": Shuf
+00001520: 666c 6553 6368 6564 756c 6572 506c 7567  fleSchedulerPlug
+00001530: 696e 2c0a 2020 2020 2273 7061 6e73 223a  in,.    "spans":
+00001540: 2053 7061 6e73 5363 6865 6475 6c65 7245   SpansSchedulerE
+00001550: 7874 656e 7369 6f6e 2c0a 2020 2020 2273  xtension,.    "s
+00001560: 7465 616c 696e 6722 3a20 576f 726b 5374  tealing": WorkSt
+00001570: 6561 6c69 6e67 2c0a 7d0a 0a0a 636c 6173  ealing,.}...clas
+00001580: 7320 436c 6965 6e74 5374 6174 653a 0a20  s ClientState:. 
+00001590: 2020 2022 2222 4120 7369 6d70 6c65 206f     """A simple o
+000015a0: 626a 6563 7420 686f 6c64 696e 6720 696e  bject holding in
+000015b0: 666f 726d 6174 696f 6e20 6162 6f75 7420  formation about 
+000015c0: 6120 636c 6965 6e74 2e22 2222 0a0a 2020  a client."""..  
+000015d0: 2020 233a 2041 2075 6e69 7175 6520 6964    #: A unique id
+000015e0: 656e 7469 6669 6572 2066 6f72 2074 6869  entifier for thi
+000015f0: 7320 636c 6965 6e74 2e20 5468 6973 2069  s client. This i
+00001600: 7320 6765 6e65 7261 6c6c 7920 616e 206f  s generally an o
+00001610: 7061 7175 650a 2020 2020 233a 2073 7472  paque.    #: str
+00001620: 696e 6720 6765 6e65 7261 7465 6420 6279  ing generated by
+00001630: 2074 6865 2063 6c69 656e 7420 6974 7365   the client itse
+00001640: 6c66 2e0a 2020 2020 636c 6965 6e74 5f6b  lf..    client_k
+00001650: 6579 3a20 7374 720a 0a20 2020 2023 3a20  ey: str..    #: 
+00001660: 4361 6368 6564 2068 6173 6820 6f66 203a  Cached hash of :
+00001670: 6174 7472 3a60 7e43 6c69 656e 7453 7461  attr:`~ClientSta
+00001680: 7465 2e63 6c69 656e 745f 6b65 7960 0a20  te.client_key`. 
+00001690: 2020 205f 6861 7368 3a20 696e 740a 0a20     _hash: int.. 
+000016a0: 2020 2023 3a20 4120 7365 7420 6f66 2074     #: A set of t
+000016b0: 6173 6b73 2074 6869 7320 636c 6965 6e74  asks this client
+000016c0: 2077 616e 7473 2074 6f20 6265 206b 6570   wants to be kep
+000016d0: 7420 696e 206d 656d 6f72 792c 2073 6f20  t in memory, so 
+000016e0: 7468 6174 2069 7420 6361 6e20 646f 776e  that it can down
+000016f0: 6c6f 6164 0a20 2020 2023 3a20 6974 7320  load.    #: its 
+00001700: 7265 7375 6c74 2077 6865 6e20 6465 7369  result when desi
+00001710: 7265 642e 2054 6869 7320 6973 2074 6865  red. This is the
+00001720: 2072 6576 6572 7365 206d 6170 7069 6e67   reverse mapping
+00001730: 206f 660a 2020 2020 233a 203a 636c 6173   of.    #: :clas
+00001740: 733a 6054 6173 6b53 7461 7465 2e77 686f  s:`TaskState.who
+00001750: 5f77 616e 7473 602e 2054 6173 6b73 2061  _wants`. Tasks a
+00001760: 7265 2074 7970 6963 616c 6c79 2072 656d  re typically rem
+00001770: 6f76 6564 2066 726f 6d20 7468 6973 2073  oved from this s
+00001780: 6574 2077 6865 6e20 7468 650a 2020 2020  et when the.    
+00001790: 233a 2063 6f72 7265 7370 6f6e 6469 6e67  #: corresponding
+000017a0: 206f 626a 6563 7420 696e 2074 6865 2063   object in the c
+000017b0: 6c69 656e 7427 7320 7370 6163 6520 2866  lient's space (f
+000017c0: 6f72 2065 7861 6d70 6c65 2061 2060 6046  or example a ``F
+000017d0: 7574 7572 6560 6020 6f72 2061 2044 6173  uture`` or a Das
+000017e0: 6b0a 2020 2020 233a 2063 6f6c 6c65 6374  k.    #: collect
+000017f0: 696f 6e29 2067 6574 7320 6761 7262 6167  ion) gets garbag
+00001800: 652d 636f 6c6c 6563 7465 642e 0a20 2020  e-collected..   
+00001810: 2077 616e 7473 5f77 6861 743a 2073 6574   wants_what: set
+00001820: 5b54 6173 6b53 7461 7465 5d0a 0a20 2020  [TaskState]..   
+00001830: 2023 3a20 5468 6520 6c61 7374 2074 696d   #: The last tim
+00001840: 6520 7765 2072 6563 6569 7665 6420 6120  e we received a 
+00001850: 6865 6172 7462 6561 7420 6672 6f6d 2074  heartbeat from t
+00001860: 6869 7320 636c 6965 6e74 2c20 696e 206c  his client, in l
+00001870: 6f63 616c 2073 6368 6564 756c 6572 2074  ocal scheduler t
+00001880: 696d 652e 0a20 2020 206c 6173 745f 7365  ime..    last_se
+00001890: 656e 3a20 666c 6f61 740a 0a20 2020 2023  en: float..    #
+000018a0: 3a20 4f75 7470 7574 206f 6620 3a66 756e  : Output of :fun
+000018b0: 633a 6064 6973 7472 6962 7574 6564 2e76  c:`distributed.v
+000018c0: 6572 7369 6f6e 732e 6765 745f 7665 7273  ersions.get_vers
+000018d0: 696f 6e73 6020 6f6e 2074 6865 2063 6c69  ions` on the cli
+000018e0: 656e 740a 2020 2020 7665 7273 696f 6e73  ent.    versions
+000018f0: 3a20 6469 6374 5b73 7472 2c20 416e 795d  : dict[str, Any]
+00001900: 0a0a 2020 2020 5f5f 736c 6f74 735f 5f20  ..    __slots__ 
+00001910: 3d20 7475 706c 6528 5f5f 616e 6e6f 7461  = tuple(__annota
+00001920: 7469 6f6e 735f 5f29 0a0a 2020 2020 6465  tions__)..    de
+00001930: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
+00001940: 2063 6c69 656e 743a 2073 7472 2c20 2a2c   client: str, *,
+00001950: 2076 6572 7369 6f6e 733a 2064 6963 745b   versions: dict[
+00001960: 7374 722c 2041 6e79 5d20 7c20 4e6f 6e65  str, Any] | None
+00001970: 203d 204e 6f6e 6529 3a0a 2020 2020 2020   = None):.      
+00001980: 2020 7365 6c66 2e63 6c69 656e 745f 6b65    self.client_ke
+00001990: 7920 3d20 636c 6965 6e74 0a20 2020 2020  y = client.     
+000019a0: 2020 2073 656c 662e 5f68 6173 6820 3d20     self._hash = 
+000019b0: 6861 7368 2863 6c69 656e 7429 0a20 2020  hash(client).   
+000019c0: 2020 2020 2073 656c 662e 7761 6e74 735f       self.wants_
+000019d0: 7768 6174 203d 2073 6574 2829 0a20 2020  what = set().   
+000019e0: 2020 2020 2073 656c 662e 6c61 7374 5f73       self.last_s
+000019f0: 6565 6e20 3d20 7469 6d65 2829 0a20 2020  een = time().   
+00001a00: 2020 2020 2073 656c 662e 7665 7273 696f       self.versio
+00001a10: 6e73 203d 2076 6572 7369 6f6e 7320 6f72  ns = versions or
+00001a20: 207b 7d0a 0a20 2020 2064 6566 205f 5f68   {}..    def __h
+00001a30: 6173 685f 5f28 7365 6c66 2920 2d3e 2069  ash__(self) -> i
+00001a40: 6e74 3a0a 2020 2020 2020 2020 7265 7475  nt:.        retu
+00001a50: 726e 2073 656c 662e 5f68 6173 680a 0a20  rn self._hash.. 
+00001a60: 2020 2064 6566 205f 5f65 715f 5f28 7365     def __eq__(se
+00001a70: 6c66 2c20 6f74 6865 723a 206f 626a 6563  lf, other: objec
+00001a80: 7429 202d 3e20 626f 6f6c 3a0a 2020 2020  t) -> bool:.    
+00001a90: 2020 2020 6966 206e 6f74 2069 7369 6e73      if not isins
+00001aa0: 7461 6e63 6528 6f74 6865 722c 2043 6c69  tance(other, Cli
+00001ab0: 656e 7453 7461 7465 293a 0a20 2020 2020  entState):.     
+00001ac0: 2020 2020 2020 2072 6574 7572 6e20 4661         return Fa
+00001ad0: 6c73 650a 2020 2020 2020 2020 7265 7475  lse.        retu
+00001ae0: 726e 2073 656c 662e 636c 6965 6e74 5f6b  rn self.client_k
+00001af0: 6579 203d 3d20 6f74 6865 722e 636c 6965  ey == other.clie
+00001b00: 6e74 5f6b 6579 0a0a 2020 2020 6465 6620  nt_key..    def 
+00001b10: 5f5f 7265 7072 5f5f 2873 656c 6629 202d  __repr__(self) -
+00001b20: 3e20 7374 723a 0a20 2020 2020 2020 2072  > str:.        r
+00001b30: 6574 7572 6e20 6622 3c43 6c69 656e 7420  eturn f"<Client 
+00001b40: 7b73 656c 662e 636c 6965 6e74 5f6b 6579  {self.client_key
+00001b50: 2172 7d3e 220a 0a20 2020 2064 6566 205f  !r}>"..    def _
+00001b60: 5f73 7472 5f5f 2873 656c 6629 202d 3e20  _str__(self) -> 
+00001b70: 7374 723a 0a20 2020 2020 2020 2072 6574  str:.        ret
+00001b80: 7572 6e20 7365 6c66 2e63 6c69 656e 745f  urn self.client_
+00001b90: 6b65 790a 0a20 2020 2064 6566 205f 746f  key..    def _to
+00001ba0: 5f64 6963 745f 6e6f 5f6e 6573 7428 7365  _dict_no_nest(se
+00001bb0: 6c66 2c20 2a2c 2065 7863 6c75 6465 3a20  lf, *, exclude: 
+00001bc0: 436f 6e74 6169 6e65 725b 7374 725d 203d  Container[str] =
+00001bd0: 2028 2929 202d 3e20 6469 6374 3a0a 2020   ()) -> dict:.  
+00001be0: 2020 2020 2020 2222 2244 6963 7469 6f6e        """Diction
+00001bf0: 6172 7920 7265 7072 6573 656e 7461 7469  ary representati
+00001c00: 6f6e 2066 6f72 2064 6562 7567 6769 6e67  on for debugging
+00001c10: 2070 7572 706f 7365 732e 0a20 2020 2020   purposes..     
+00001c20: 2020 204e 6f74 2074 7970 6520 7374 6162     Not type stab
+00001c30: 6c65 2061 6e64 206e 6f74 2069 6e74 656e  le and not inten
+00001c40: 6465 6420 666f 7220 726f 756e 6474 7269  ded for roundtri
+00001c50: 7073 2e0a 0a20 2020 2020 2020 2053 6565  ps...        See
+00001c60: 2061 6c73 6f0a 2020 2020 2020 2020 2d2d   also.        --
+00001c70: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2043  ------.        C
+00001c80: 6c69 656e 742e 6475 6d70 5f63 6c75 7374  lient.dump_clust
+00001c90: 6572 5f73 7461 7465 0a20 2020 2020 2020  er_state.       
+00001ca0: 2064 6973 7472 6962 7574 6564 2e75 7469   distributed.uti
+00001cb0: 6c73 2e72 6563 7572 7369 7665 5f74 6f5f  ls.recursive_to_
+00001cc0: 6469 6374 0a20 2020 2020 2020 2054 6173  dict.        Tas
+00001cd0: 6b53 7461 7465 2e5f 746f 5f64 6963 740a  kState._to_dict.
+00001ce0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00001cf0: 2020 2020 7265 7475 726e 2072 6563 7572      return recur
+00001d00: 7369 7665 5f74 6f5f 6469 6374 280a 2020  sive_to_dict(.  
+00001d10: 2020 2020 2020 2020 2020 7365 6c66 2c0a            self,.
+00001d20: 2020 2020 2020 2020 2020 2020 6578 636c              excl
+00001d30: 7564 653d 7365 7428 6578 636c 7564 6529  ude=set(exclude)
+00001d40: 207c 207b 2276 6572 7369 6f6e 7322 7d2c   | {"versions"},
+00001d50: 2020 2320 7479 7065 3a20 6967 6e6f 7265    # type: ignore
+00001d60: 0a20 2020 2020 2020 2020 2020 206d 656d  .            mem
+00001d70: 6265 7273 3d54 7275 652c 0a20 2020 2020  bers=True,.     
+00001d80: 2020 2029 0a0a 0a63 6c61 7373 204d 656d     )...class Mem
+00001d90: 6f72 7953 7461 7465 3a0a 2020 2020 2222  oryState:.    ""
+00001da0: 224d 656d 6f72 7920 7265 6164 696e 6773  "Memory readings
+00001db0: 206f 6e20 6120 776f 726b 6572 206f 7220   on a worker or 
+00001dc0: 6f6e 2074 6865 2077 686f 6c65 2063 6c75  on the whole clu
+00001dd0: 7374 6572 2e0a 0a20 2020 2053 6565 203a  ster...    See :
+00001de0: 646f 633a 6077 6f72 6b65 722d 6d65 6d6f  doc:`worker-memo
+00001df0: 7279 602e 0a0a 2020 2020 4174 7472 6962  ry`...    Attrib
+00001e00: 7574 6573 202f 2070 726f 7065 7274 6965  utes / propertie
+00001e10: 733a 0a0a 2020 2020 6d61 6e61 6765 645f  s:..    managed_
+00001e20: 746f 7461 6c0a 2020 2020 2020 2020 5375  total.        Su
+00001e30: 6d20 6f66 2074 6865 206f 7574 7075 7420  m of the output 
+00001e40: 6f66 2073 697a 656f 6628 2920 666f 7220  of sizeof() for 
+00001e50: 616c 6c20 6461 736b 206b 6579 7320 6865  all dask keys he
+00001e60: 6c64 2062 7920 7468 6520 776f 726b 6572  ld by the worker
+00001e70: 2069 6e20 6d65 6d6f 7279 2c0a 2020 2020   in memory,.    
+00001e80: 2020 2020 706c 7573 206e 756d 6265 7220      plus number 
+00001e90: 6f66 2062 7974 6573 2073 7069 6c6c 6564  of bytes spilled
+00001ea0: 2074 6f20 6469 736b 0a0a 2020 2020 6d61   to disk..    ma
+00001eb0: 6e61 6765 640a 2020 2020 2020 2020 5375  naged.        Su
+00001ec0: 6d20 6f66 2074 6865 206f 7574 7075 7420  m of the output 
+00001ed0: 6f66 2073 697a 656f 6628 2920 666f 7220  of sizeof() for 
+00001ee0: 7468 6520 6461 736b 206b 6579 7320 6865  the dask keys he
+00001ef0: 6c64 2069 6e20 5241 4d2e 204e 6f74 6520  ld in RAM. Note 
+00001f00: 7468 6174 2074 6869 7320 6d61 790a 2020  that this may.  
+00001f10: 2020 2020 2020 6265 2069 6e61 6363 7572        be inaccur
+00001f20: 6174 652c 2077 6869 6368 206d 6179 2063  ate, which may c
+00001f30: 6175 7365 2069 6e61 6363 7572 6174 6520  ause inaccurate 
+00001f40: 756e 6d61 6e61 6765 6420 6d65 6d6f 7279  unmanaged memory
+00001f50: 2028 7365 6520 6265 6c6f 7729 2e0a 0a20   (see below)... 
+00001f60: 2020 2073 7069 6c6c 6564 0a20 2020 2020     spilled.     
+00001f70: 2020 204e 756d 6265 7220 6f66 2062 7974     Number of byt
+00001f80: 6573 2020 666f 7220 7468 6520 6461 736b  es  for the dask
+00001f90: 206b 6579 7320 7370 696c 6c65 6420 746f   keys spilled to
+00001fa0: 2074 6865 2068 6172 6420 6472 6976 652e   the hard drive.
+00001fb0: 0a20 2020 2020 2020 204e 6f74 6520 7468  .        Note th
+00001fc0: 6174 2074 6869 7320 6973 2074 6865 2073  at this is the s
+00001fd0: 697a 6520 6f6e 2064 6973 6b3b 2073 697a  ize on disk; siz
+00001fe0: 6520 696e 206d 656d 6f72 7920 6d61 7920  e in memory may 
+00001ff0: 6265 2064 6966 6665 7265 6e74 2064 7565  be different due
+00002000: 2074 6f0a 2020 2020 2020 2020 636f 6d70   to.        comp
+00002010: 7265 7373 696f 6e20 616e 6420 696e 6163  ression and inac
+00002020: 6375 7261 6369 6573 2069 6e20 7369 7a65  curacies in size
+00002030: 6f66 2829 2e20 496e 206f 7468 6572 2077  of(). In other w
+00002040: 6f72 6473 2c20 6769 7665 6e20 7468 6520  ords, given the 
+00002050: 7361 6d65 206b 6579 732c 0a20 2020 2020  same keys,.     
+00002060: 2020 2027 6d61 6e61 6765 6427 2077 696c     'managed' wil
+00002070: 6c20 6368 616e 6765 2064 6570 656e 6469  l change dependi
+00002080: 6e67 206f 6e20 7468 6520 6b65 7973 2062  ng on the keys b
+00002090: 6569 6e67 2069 6e20 6d65 6d6f 7279 206f  eing in memory o
+000020a0: 7220 7370 696c 6c65 642e 0a0a 2020 2020  r spilled...    
+000020b0: 7072 6f63 6573 730a 2020 2020 2020 2020  process.        
+000020c0: 546f 7461 6c20 5253 5320 6d65 6d6f 7279  Total RSS memory
+000020d0: 206d 6561 7375 7265 6420 6279 2074 6865   measured by the
+000020e0: 204f 5320 6f6e 2074 6865 2077 6f72 6b65   OS on the worke
+000020f0: 7220 7072 6f63 6573 732e 0a20 2020 2020  r process..     
+00002100: 2020 2054 6869 7320 6973 2061 6c77 6179     This is alway
+00002110: 7320 6578 6163 746c 7920 6571 7561 6c20  s exactly equal 
+00002120: 746f 206d 616e 6167 6564 202b 2075 6e6d  to managed + unm
+00002130: 616e 6167 6564 2e0a 0a20 2020 2075 6e6d  anaged...    unm
+00002140: 616e 6167 6564 0a20 2020 2020 2020 2070  anaged.        p
+00002150: 726f 6365 7373 202d 206d 616e 6167 6564  rocess - managed
+00002160: 2e20 5468 6973 2069 7320 7468 6520 7375  . This is the su
+00002170: 6d20 6f66 0a0a 2020 2020 2020 2020 2d20  m of..        - 
+00002180: 5079 7468 6f6e 2069 6e74 6572 7072 6574  Python interpret
+00002190: 6572 2061 6e64 206d 6f64 756c 6573 0a20  er and modules. 
+000021a0: 2020 2020 2020 202d 2067 6c6f 6261 6c20         - global 
+000021b0: 7661 7269 6162 6c65 730a 2020 2020 2020  variables.      
+000021c0: 2020 2d20 6d65 6d6f 7279 2074 656d 706f    - memory tempo
+000021d0: 7261 7269 6c79 2061 6c6c 6f63 6174 6564  rarily allocated
+000021e0: 2062 7920 7468 6520 6461 736b 2074 6173   by the dask tas
+000021f0: 6b73 2074 6861 7420 6172 6520 6375 7272  ks that are curr
+00002200: 656e 746c 7920 7275 6e6e 696e 670a 2020  ently running.  
+00002210: 2020 2020 2020 2d20 6d65 6d6f 7279 2066        - memory f
+00002220: 7261 676d 656e 7461 7469 6f6e 0a20 2020  ragmentation.   
+00002230: 2020 2020 202d 206d 656d 6f72 7920 6c65       - memory le
+00002240: 616b 730a 2020 2020 2020 2020 2d20 6d65  aks.        - me
+00002250: 6d6f 7279 206e 6f74 2079 6574 2067 6172  mory not yet gar
+00002260: 6261 6765 2063 6f6c 6c65 6374 6564 0a20  bage collected. 
+00002270: 2020 2020 2020 202d 206d 656d 6f72 7920         - memory 
+00002280: 6e6f 7420 7965 7420 6672 6565 2829 2764  not yet free()'d
+00002290: 2062 7920 7468 6520 5079 7468 6f6e 206d   by the Python m
+000022a0: 656d 6f72 7920 6d61 6e61 6765 7220 746f  emory manager to
+000022b0: 2074 6865 204f 530a 0a20 2020 2075 6e6d   the OS..    unm
+000022c0: 616e 6167 6564 5f6f 6c64 0a20 2020 2020  anaged_old.     
+000022d0: 2020 204d 696e 696d 756d 206f 6620 7468     Minimum of th
+000022e0: 6520 2775 6e6d 616e 6167 6564 2720 6d65  e 'unmanaged' me
+000022f0: 6173 7572 6573 206f 7665 7220 7468 6520  asures over the 
+00002300: 6c61 7374 0a20 2020 2020 2020 2060 6064  last.        ``d
+00002310: 6973 7472 6962 7574 6564 2e6d 656d 6f72  istributed.memor
+00002320: 792e 7265 6365 6e74 2d74 6f2d 6f6c 642d  y.recent-to-old-
+00002330: 7469 6d65 6060 2073 6563 6f6e 6473 0a0a  time`` seconds..
+00002340: 2020 2020 756e 6d61 6e61 6765 645f 7265      unmanaged_re
+00002350: 6365 6e74 0a20 2020 2020 2020 2075 6e6d  cent.        unm
+00002360: 616e 6167 6564 202d 2075 6e6d 616e 6167  anaged - unmanag
+00002370: 6564 5f6f 6c64 3b20 696e 206f 7468 6572  ed_old; in other
+00002380: 2077 6f72 6473 2070 726f 6365 7373 206d   words process m
+00002390: 656d 6f72 7920 7468 6174 2068 6173 2062  emory that has b
+000023a0: 6565 6e20 7265 6365 6e74 6c79 0a20 2020  een recently.   
+000023b0: 2020 2020 2061 6c6c 6f63 6174 6564 2062       allocated b
+000023c0: 7574 2069 7320 6e6f 7420 6163 636f 756e  ut is not accoun
+000023d0: 7465 6420 666f 7220 6279 2064 6173 6b3b  ted for by dask;
+000023e0: 2068 6f70 6566 756c 6c79 2069 7427 7320   hopefully it's 
+000023f0: 6d6f 7374 6c79 2061 2074 656d 706f 7261  mostly a tempora
+00002400: 7279 0a20 2020 2020 2020 2073 7069 6b65  ry.        spike
+00002410: 2e0a 0a20 2020 206f 7074 696d 6973 7469  ...    optimisti
+00002420: 630a 2020 2020 2020 2020 6d61 6e61 6765  c.        manage
+00002430: 6420 2b20 756e 6d61 6e61 6765 645f 6f6c  d + unmanaged_ol
+00002440: 643b 2069 6e20 6f74 6865 7220 776f 7264  d; in other word
+00002450: 7320 7468 6520 6d65 6d6f 7279 2068 656c  s the memory hel
+00002460: 6420 6c6f 6e67 2d74 6572 6d20 6279 0a20  d long-term by. 
+00002470: 2020 2020 2020 2074 6865 2070 726f 6365         the proce
+00002480: 7373 2075 6e64 6572 2074 6865 2068 6f70  ss under the hop
+00002490: 6566 756c 2061 7373 756d 7074 696f 6e20  eful assumption 
+000024a0: 7468 6174 2061 6c6c 2075 6e6d 616e 6167  that all unmanag
+000024b0: 6564 5f72 6563 656e 7420 6d65 6d6f 7279  ed_recent memory
+000024c0: 2069 7320 610a 2020 2020 2020 2020 7465   is a.        te
+000024d0: 6d70 6f72 6172 7920 7370 696b 650a 2020  mporary spike.  
+000024e0: 2020 2222 220a 0a20 2020 2070 726f 6365    """..    proce
+000024f0: 7373 3a20 696e 740a 2020 2020 756e 6d61  ss: int.    unma
+00002500: 6e61 6765 645f 6f6c 643a 2069 6e74 0a20  naged_old: int. 
+00002510: 2020 206d 616e 6167 6564 3a20 696e 740a     managed: int.
+00002520: 2020 2020 7370 696c 6c65 643a 2069 6e74      spilled: int
+00002530: 0a0a 2020 2020 5f5f 736c 6f74 735f 5f20  ..    __slots__ 
+00002540: 3d20 7475 706c 6528 5f5f 616e 6e6f 7461  = tuple(__annota
+00002550: 7469 6f6e 735f 5f29 0a0a 2020 2020 6465  tions__)..    de
+00002560: 6620 5f5f 696e 6974 5f5f 280a 2020 2020  f __init__(.    
+00002570: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+00002580: 2020 2a2c 0a20 2020 2020 2020 2070 726f    *,.        pro
+00002590: 6365 7373 3a20 696e 742c 0a20 2020 2020  cess: int,.     
+000025a0: 2020 2075 6e6d 616e 6167 6564 5f6f 6c64     unmanaged_old
+000025b0: 3a20 696e 742c 0a20 2020 2020 2020 206d  : int,.        m
+000025c0: 616e 6167 6564 3a20 696e 742c 0a20 2020  anaged: int,.   
+000025d0: 2020 2020 2073 7069 6c6c 6564 3a20 696e       spilled: in
+000025e0: 742c 0a20 2020 2029 3a0a 2020 2020 2020  t,.    ):.      
+000025f0: 2020 2320 536f 6d65 2064 6174 6120 6172    # Some data ar
+00002600: 7269 7665 7320 7769 7468 2074 6865 2068  rives with the h
+00002610: 6561 7274 6265 6174 2c20 736f 6d65 206f  eartbeat, some o
+00002620: 7468 6572 2061 7272 6976 6573 2069 6e20  ther arrives in 
+00002630: 7265 616c 7469 6d65 2061 7320 7468 650a  realtime as the.
+00002640: 2020 2020 2020 2020 2320 7461 736b 7320          # tasks 
+00002650: 7072 6f67 7265 7373 2e20 416c 736f 2c20  progress. Also, 
+00002660: 7369 7a65 6f66 2829 2069 7320 6e6f 7420  sizeof() is not 
+00002670: 6775 6172 616e 7465 6564 2074 6f20 7265  guaranteed to re
+00002680: 7475 726e 2063 6f72 7265 6374 2072 6573  turn correct res
+00002690: 756c 7473 2e0a 2020 2020 2020 2020 2320  ults..        # 
+000026a0: 5468 6973 2063 616e 2063 6175 7365 2067  This can cause g
+000026b0: 6c69 7463 6865 7320 7768 6572 6520 6120  litches where a 
+000026c0: 7061 7274 6961 6c20 6d65 6173 7572 6520  partial measure 
+000026d0: 6973 206c 6172 6765 7220 7468 616e 2074  is larger than t
+000026e0: 6865 2077 686f 6c65 2c20 736f 0a20 2020  he whole, so.   
+000026f0: 2020 2020 2023 2077 6520 6e65 6564 2074       # we need t
+00002700: 6f20 666f 7263 6520 616c 6c20 6e75 6d62  o force all numb
+00002710: 6572 7320 746f 2061 6464 2075 7020 6578  ers to add up ex
+00002720: 6163 746c 7920 6279 2064 6566 696e 6974  actly by definit
+00002730: 696f 6e2e 0a20 2020 2020 2020 2073 656c  ion..        sel
+00002740: 662e 7072 6f63 6573 7320 3d20 7072 6f63  f.process = proc
+00002750: 6573 730a 2020 2020 2020 2020 7365 6c66  ess.        self
+00002760: 2e6d 616e 6167 6564 203d 206d 696e 2873  .managed = min(s
+00002770: 656c 662e 7072 6f63 6573 732c 206d 616e  elf.process, man
+00002780: 6167 6564 290a 2020 2020 2020 2020 7365  aged).        se
+00002790: 6c66 2e73 7069 6c6c 6564 203d 2073 7069  lf.spilled = spi
+000027a0: 6c6c 6564 0a20 2020 2020 2020 2023 2053  lled.        # S
+000027b0: 7562 7472 6163 7469 6f6e 7320 6265 7477  ubtractions betw
+000027c0: 6565 6e20 756e 7369 676e 6564 2069 6e74  een unsigned int
+000027d0: 7320 6775 6172 616e 7465 6564 2062 7920  s guaranteed by 
+000027e0: 636f 6e73 7472 7563 7469 6f6e 2074 6f20  construction to 
+000027f0: 6265 203e 3d20 300a 2020 2020 2020 2020  be >= 0.        
+00002800: 7365 6c66 2e75 6e6d 616e 6167 6564 5f6f  self.unmanaged_o
+00002810: 6c64 203d 206d 696e 2875 6e6d 616e 6167  ld = min(unmanag
+00002820: 6564 5f6f 6c64 2c20 7072 6f63 6573 7320  ed_old, process 
+00002830: 2d20 7365 6c66 2e6d 616e 6167 6564 290a  - self.managed).
+00002840: 0a20 2020 2040 7374 6174 6963 6d65 7468  .    @staticmeth
+00002850: 6f64 0a20 2020 2064 6566 2073 756d 282a  od.    def sum(*
+00002860: 696e 666f 733a 204d 656d 6f72 7953 7461  infos: MemorySta
+00002870: 7465 2920 2d3e 204d 656d 6f72 7953 7461  te) -> MemorySta
+00002880: 7465 3a0a 2020 2020 2020 2020 7072 6f63  te:.        proc
+00002890: 6573 7320 3d20 300a 2020 2020 2020 2020  ess = 0.        
+000028a0: 756e 6d61 6e61 6765 645f 6f6c 6420 3d20  unmanaged_old = 
+000028b0: 300a 2020 2020 2020 2020 6d61 6e61 6765  0.        manage
+000028c0: 6420 3d20 300a 2020 2020 2020 2020 7370  d = 0.        sp
+000028d0: 696c 6c65 6420 3d20 300a 2020 2020 2020  illed = 0.      
+000028e0: 2020 666f 7220 6d73 2069 6e20 696e 666f    for ms in info
+000028f0: 733a 0a20 2020 2020 2020 2020 2020 2070  s:.            p
+00002900: 726f 6365 7373 202b 3d20 6d73 2e70 726f  rocess += ms.pro
+00002910: 6365 7373 0a20 2020 2020 2020 2020 2020  cess.           
+00002920: 2075 6e6d 616e 6167 6564 5f6f 6c64 202b   unmanaged_old +
+00002930: 3d20 6d73 2e75 6e6d 616e 6167 6564 5f6f  = ms.unmanaged_o
+00002940: 6c64 0a20 2020 2020 2020 2020 2020 2073  ld.            s
+00002950: 7069 6c6c 6564 202b 3d20 6d73 2e73 7069  pilled += ms.spi
+00002960: 6c6c 6564 0a20 2020 2020 2020 2020 2020  lled.           
+00002970: 206d 616e 6167 6564 202b 3d20 6d73 2e6d   managed += ms.m
+00002980: 616e 6167 6564 0a20 2020 2020 2020 2072  anaged.        r
+00002990: 6574 7572 6e20 4d65 6d6f 7279 5374 6174  eturn MemoryStat
+000029a0: 6528 0a20 2020 2020 2020 2020 2020 2070  e(.            p
+000029b0: 726f 6365 7373 3d70 726f 6365 7373 2c0a  rocess=process,.
+000029c0: 2020 2020 2020 2020 2020 2020 756e 6d61              unma
+000029d0: 6e61 6765 645f 6f6c 643d 756e 6d61 6e61  naged_old=unmana
+000029e0: 6765 645f 6f6c 642c 0a20 2020 2020 2020  ged_old,.       
+000029f0: 2020 2020 206d 616e 6167 6564 3d6d 616e       managed=man
+00002a00: 6167 6564 2c0a 2020 2020 2020 2020 2020  aged,.          
+00002a10: 2020 7370 696c 6c65 643d 7370 696c 6c65    spilled=spille
+00002a20: 642c 0a20 2020 2020 2020 2029 0a0a 2020  d,.        )..  
+00002a30: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
+00002a40: 6465 6620 6d61 6e61 6765 645f 746f 7461  def managed_tota
+00002a50: 6c28 7365 6c66 2920 2d3e 2069 6e74 3a0a  l(self) -> int:.
+00002a60: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00002a70: 656c 662e 6d61 6e61 6765 6420 2b20 7365  elf.managed + se
+00002a80: 6c66 2e73 7069 6c6c 6564 0a0a 2020 2020  lf.spilled..    
+00002a90: 4070 726f 7065 7274 790a 2020 2020 6465  @property.    de
+00002aa0: 6620 756e 6d61 6e61 6765 6428 7365 6c66  f unmanaged(self
+00002ab0: 2920 2d3e 2069 6e74 3a0a 2020 2020 2020  ) -> int:.      
+00002ac0: 2020 2320 5468 6973 2069 7320 6e65 7665    # This is neve
+00002ad0: 7220 6e65 6761 7469 7665 2074 6861 6e6b  r negative thank
+00002ae0: 7320 746f 205f 5f69 6e69 745f 5f0a 2020  s to __init__.  
+00002af0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+00002b00: 662e 7072 6f63 6573 7320 2d20 7365 6c66  f.process - self
+00002b10: 2e6d 616e 6167 6564 0a0a 2020 2020 4070  .managed..    @p
+00002b20: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
+00002b30: 756e 6d61 6e61 6765 645f 7265 6365 6e74  unmanaged_recent
+00002b40: 2873 656c 6629 202d 3e20 696e 743a 0a20  (self) -> int:. 
+00002b50: 2020 2020 2020 2023 2054 6869 7320 6973         # This is
+00002b60: 206e 6576 6572 206e 6567 6174 6976 6520   never negative 
+00002b70: 7468 616e 6b73 2074 6f20 5f5f 696e 6974  thanks to __init
+00002b80: 5f5f 0a20 2020 2020 2020 2072 6574 7572  __.        retur
+00002b90: 6e20 7365 6c66 2e70 726f 6365 7373 202d  n self.process -
+00002ba0: 2073 656c 662e 6d61 6e61 6765 6420 2d20   self.managed - 
+00002bb0: 7365 6c66 2e75 6e6d 616e 6167 6564 5f6f  self.unmanaged_o
+00002bc0: 6c64 0a0a 2020 2020 4070 726f 7065 7274  ld..    @propert
+00002bd0: 790a 2020 2020 6465 6620 6f70 7469 6d69  y.    def optimi
+00002be0: 7374 6963 2873 656c 6629 202d 3e20 696e  stic(self) -> in
+00002bf0: 743a 0a20 2020 2020 2020 2072 6574 7572  t:.        retur
+00002c00: 6e20 7365 6c66 2e6d 616e 6167 6564 202b  n self.managed +
+00002c10: 2073 656c 662e 756e 6d61 6e61 6765 645f   self.unmanaged_
+00002c20: 6f6c 640a 0a20 2020 2040 7072 6f70 6572  old..    @proper
+00002c30: 7479 0a20 2020 2064 6566 206d 616e 6167  ty.    def manag
+00002c40: 6564 5f69 6e5f 6d65 6d6f 7279 2873 656c  ed_in_memory(sel
+00002c50: 6629 202d 3e20 696e 743a 0a20 2020 2020  f) -> int:.     
+00002c60: 2020 2077 6172 6e69 6e67 732e 7761 726e     warnings.warn
+00002c70: 2822 6d61 6e61 6765 645f 696e 5f6d 656d  ("managed_in_mem
+00002c80: 6f72 7920 6861 7320 6265 656e 2072 656e  ory has been ren
+00002c90: 616d 6564 2074 6f20 6d61 6e61 6765 6422  amed to managed"
+00002ca0: 2c20 4675 7475 7265 5761 726e 696e 6729  , FutureWarning)
+00002cb0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00002cc0: 7365 6c66 2e6d 616e 6167 6564 0a0a 2020  self.managed..  
+00002cd0: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
+00002ce0: 6465 6620 6d61 6e61 6765 645f 7370 696c  def managed_spil
+00002cf0: 6c65 6428 7365 6c66 2920 2d3e 2069 6e74  led(self) -> int
+00002d00: 3a0a 2020 2020 2020 2020 7761 726e 696e  :.        warnin
+00002d10: 6773 2e77 6172 6e28 226d 616e 6167 6564  gs.warn("managed
+00002d20: 5f73 7069 6c6c 6564 2068 6173 2062 6565  _spilled has bee
+00002d30: 6e20 7265 6e61 6d65 6420 746f 2073 7069  n renamed to spi
+00002d40: 6c6c 6564 222c 2046 7574 7572 6557 6172  lled", FutureWar
+00002d50: 6e69 6e67 290a 2020 2020 2020 2020 7265  ning).        re
+00002d60: 7475 726e 2073 656c 662e 7370 696c 6c65  turn self.spille
+00002d70: 640a 0a20 2020 2064 6566 205f 5f72 6570  d..    def __rep
+00002d80: 725f 5f28 7365 6c66 2920 2d3e 2073 7472  r__(self) -> str
+00002d90: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+00002da0: 2028 0a20 2020 2020 2020 2020 2020 2066   (.            f
+00002db0: 2250 726f 6365 7373 206d 656d 6f72 7920  "Process memory 
+00002dc0: 2852 5353 2920 203a 207b 666f 726d 6174  (RSS)  : {format
+00002dd0: 5f62 7974 6573 2873 656c 662e 7072 6f63  _bytes(self.proc
+00002de0: 6573 7329 7d5c 6e22 0a20 2020 2020 2020  ess)}\n".       
+00002df0: 2020 2020 2066 2220 202d 206d 616e 6167       f"  - manag
+00002e00: 6564 2062 7920 4461 736b 2020 203a 207b  ed by Dask   : {
+00002e10: 666f 726d 6174 5f62 7974 6573 2873 656c  format_bytes(sel
+00002e20: 662e 6d61 6e61 6765 6429 7d5c 6e22 0a20  f.managed)}\n". 
+00002e30: 2020 2020 2020 2020 2020 2066 2220 202d             f"  -
+00002e40: 2075 6e6d 616e 6167 6564 2028 6f6c 6429   unmanaged (old)
+00002e50: 2020 203a 207b 666f 726d 6174 5f62 7974     : {format_byt
+00002e60: 6573 2873 656c 662e 756e 6d61 6e61 6765  es(self.unmanage
+00002e70: 645f 6f6c 6429 7d5c 6e22 0a20 2020 2020  d_old)}\n".     
+00002e80: 2020 2020 2020 2066 2220 202d 2075 6e6d         f"  - unm
+00002e90: 616e 6167 6564 2028 7265 6365 6e74 293a  anaged (recent):
+00002ea0: 207b 666f 726d 6174 5f62 7974 6573 2873   {format_bytes(s
+00002eb0: 656c 662e 756e 6d61 6e61 6765 645f 7265  elf.unmanaged_re
+00002ec0: 6365 6e74 297d 5c6e 220a 2020 2020 2020  cent)}\n".      
+00002ed0: 2020 2020 2020 6622 5370 696c 6c65 6420        f"Spilled 
+00002ee0: 746f 2064 6973 6b20 2020 2020 2020 3a20  to disk       : 
+00002ef0: 7b66 6f72 6d61 745f 6279 7465 7328 7365  {format_bytes(se
+00002f00: 6c66 2e73 7069 6c6c 6564 297d 5c6e 220a  lf.spilled)}\n".
+00002f10: 2020 2020 2020 2020 290a 0a20 2020 2064          )..    d
+00002f20: 6566 205f 746f 5f64 6963 7428 7365 6c66  ef _to_dict(self
+00002f30: 2c20 2a2c 2065 7863 6c75 6465 3a20 436f  , *, exclude: Co
+00002f40: 6e74 6169 6e65 725b 7374 725d 203d 2028  ntainer[str] = (
+00002f50: 2929 202d 3e20 6469 6374 3a0a 2020 2020  )) -> dict:.    
+00002f60: 2020 2020 2222 2244 6963 7469 6f6e 6172      """Dictionar
+00002f70: 7920 7265 7072 6573 656e 7461 7469 6f6e  y representation
+00002f80: 2066 6f72 2064 6562 7567 6769 6e67 2070   for debugging p
+00002f90: 7572 706f 7365 732e 0a0a 2020 2020 2020  urposes...      
+00002fa0: 2020 5365 6520 616c 736f 0a20 2020 2020    See also.     
+00002fb0: 2020 202d 2d2d 2d2d 2d2d 2d0a 2020 2020     --------.    
+00002fc0: 2020 2020 436c 6965 6e74 2e64 756d 705f      Client.dump_
+00002fd0: 636c 7573 7465 725f 7374 6174 650a 2020  cluster_state.  
+00002fe0: 2020 2020 2020 6469 7374 7269 6275 7465        distribute
+00002ff0: 642e 7574 696c 732e 7265 6375 7273 6976  d.utils.recursiv
+00003000: 655f 746f 5f64 6963 740a 2020 2020 2020  e_to_dict.      
+00003010: 2020 2222 220a 2020 2020 2020 2020 7265    """.        re
+00003020: 7475 726e 207b 0a20 2020 2020 2020 2020  turn {.         
+00003030: 2020 206b 3a20 6765 7461 7474 7228 7365     k: getattr(se
+00003040: 6c66 2c20 6b29 0a20 2020 2020 2020 2020  lf, k).         
+00003050: 2020 2066 6f72 206b 2069 6e20 6469 7228     for k in dir(
+00003060: 7365 6c66 290a 2020 2020 2020 2020 2020  self).          
+00003070: 2020 6966 206e 6f74 206b 2e73 7461 7274    if not k.start
+00003080: 7377 6974 6828 225f 2229 0a20 2020 2020  swith("_").     
+00003090: 2020 2020 2020 2061 6e64 206b 206e 6f74         and k not
+000030a0: 2069 6e20 7b22 7375 6d22 2c20 226d 616e   in {"sum", "man
+000030b0: 6167 6564 5f69 6e5f 6d65 6d6f 7279 222c  aged_in_memory",
+000030c0: 2022 6d61 6e61 6765 645f 7370 696c 6c65   "managed_spille
+000030d0: 6422 7d0a 2020 2020 2020 2020 7d0a 0a0a  d"}.        }...
+000030e0: 636c 6173 7320 576f 726b 6572 5374 6174  class WorkerStat
+000030f0: 653a 0a20 2020 2022 2222 4120 7369 6d70  e:.    """A simp
+00003100: 6c65 206f 626a 6563 7420 686f 6c64 696e  le object holdin
+00003110: 6720 696e 666f 726d 6174 696f 6e20 6162  g information ab
+00003120: 6f75 7420 6120 776f 726b 6572 2e0a 0a20  out a worker... 
+00003130: 2020 204e 6f74 2074 6f20 6265 2063 6f6e     Not to be con
+00003140: 6675 7365 6420 7769 7468 203a 636c 6173  fused with :clas
+00003150: 733a 6064 6973 7472 6962 7574 6564 2e77  s:`distributed.w
+00003160: 6f72 6b65 725f 7374 6174 655f 6d61 6368  orker_state_mach
+00003170: 696e 652e 576f 726b 6572 5374 6174 6560  ine.WorkerState`
+00003180: 2e0a 2020 2020 2222 220a 0a20 2020 2023  ..    """..    #
+00003190: 3a20 5468 6973 2077 6f72 6b65 7227 7320  : This worker's 
+000031a0: 756e 6971 7565 206b 6579 2e20 5468 6973  unique key. This
+000031b0: 2063 616e 2062 6520 6974 7320 636f 6e6e   can be its conn
+000031c0: 6563 7465 6420 6164 6472 6573 730a 2020  ected address.  
+000031d0: 2020 233a 2028 7375 6368 2061 7320 6060    #: (such as ``
+000031e0: 2274 6370 3a2f 2f31 3237 2e30 2e30 2e31  "tcp://127.0.0.1
+000031f0: 3a38 3839 3122 6060 2920 6f72 2061 6e20  :8891"``) or an 
+00003200: 616c 6961 7320 2873 7563 6820 6173 2060  alias (such as `
+00003210: 6022 616c 6963 6522 6060 292e 0a20 2020  `"alice"``)..   
+00003220: 2061 6464 7265 7373 3a20 7374 720a 0a20   address: str.. 
+00003230: 2020 2070 6964 3a20 696e 740a 2020 2020     pid: int.    
+00003240: 6e61 6d65 3a20 4861 7368 6162 6c65 0a0a  name: Hashable..
+00003250: 2020 2020 233a 2054 6865 206e 756d 6265      #: The numbe
+00003260: 7220 6f66 2043 5055 2074 6872 6561 6473  r of CPU threads
+00003270: 206d 6164 6520 6176 6169 6c61 626c 6520   made available 
+00003280: 6f6e 2074 6869 7320 776f 726b 6572 0a20  on this worker. 
+00003290: 2020 206e 7468 7265 6164 733a 2069 6e74     nthreads: int
+000032a0: 0a0a 2020 2020 233a 204d 656d 6f72 7920  ..    #: Memory 
+000032b0: 6176 6169 6c61 626c 6520 746f 2074 6865  available to the
+000032c0: 2077 6f72 6b65 722c 2069 6e20 6279 7465   worker, in byte
+000032d0: 730a 2020 2020 6d65 6d6f 7279 5f6c 696d  s.    memory_lim
+000032e0: 6974 3a20 696e 740a 0a20 2020 206c 6f63  it: int..    loc
+000032f0: 616c 5f64 6972 6563 746f 7279 3a20 7374  al_directory: st
+00003300: 720a 2020 2020 7365 7276 6963 6573 3a20  r.    services: 
+00003310: 6469 6374 5b73 7472 2c20 696e 745d 0a0a  dict[str, int]..
+00003320: 2020 2020 233a 204f 7574 7075 7420 6f66      #: Output of
+00003330: 203a 6d65 7468 3a60 6469 7374 7269 6275   :meth:`distribu
+00003340: 7465 642e 7665 7273 696f 6e73 2e67 6574  ted.versions.get
+00003350: 5f76 6572 7369 6f6e 7360 206f 6e20 7468  _versions` on th
+00003360: 6520 776f 726b 6572 0a20 2020 2076 6572  e worker.    ver
+00003370: 7369 6f6e 733a 2064 6963 745b 7374 722c  sions: dict[str,
+00003380: 2041 6e79 5d0a 0a20 2020 2023 3a20 4164   Any]..    #: Ad
+00003390: 6472 6573 7320 6f66 2074 6865 2061 7373  dress of the ass
+000033a0: 6f63 6961 7465 6420 3a63 6c61 7373 3a60  ociated :class:`
+000033b0: 7e64 6973 7472 6962 7574 6564 2e6e 616e  ~distributed.nan
+000033c0: 6e79 2e4e 616e 6e79 602c 2069 6620 7072  ny.Nanny`, if pr
+000033d0: 6573 656e 740a 2020 2020 6e61 6e6e 793a  esent.    nanny:
+000033e0: 2073 7472 207c 204e 6f6e 650a 0a20 2020   str | None..   
+000033f0: 2023 3a20 5265 6164 2d6f 6e6c 7920 776f   #: Read-only wo
+00003400: 726b 6572 2073 7461 7475 732c 2073 796e  rker status, syn
+00003410: 6365 6420 6f6e 6520 7761 7920 6672 6f6d  ced one way from
+00003420: 2074 6865 2072 656d 6f74 6520 576f 726b   the remote Work
+00003430: 6572 206f 626a 6563 740a 2020 2020 7374  er object.    st
+00003440: 6174 7573 3a20 5374 6174 7573 0a0a 2020  atus: Status..  
+00003450: 2020 233a 2043 6163 6865 6420 6861 7368    #: Cached hash
+00003460: 206f 6620 3a61 7474 723a 607e 576f 726b   of :attr:`~Work
+00003470: 6572 5374 6174 652e 7365 7276 6572 5f69  erState.server_i
+00003480: 6460 0a20 2020 205f 6861 7368 3a20 696e  d`.    _hash: in
+00003490: 740a 0a20 2020 2023 3a20 5468 6520 746f  t..    #: The to
+000034a0: 7461 6c20 6d65 6d6f 7279 2073 697a 652c  tal memory size,
+000034b0: 2069 6e20 6279 7465 732c 2075 7365 6420   in bytes, used 
+000034c0: 6279 2074 6865 2074 6173 6b73 2074 6869  by the tasks thi
+000034d0: 7320 776f 726b 6572 2068 6f6c 6473 2069  s worker holds i
+000034e0: 6e20 6d65 6d6f 7279 0a20 2020 2023 3a20  n memory.    #: 
+000034f0: 2869 2e65 2e20 7468 6520 7461 736b 7320  (i.e. the tasks 
+00003500: 696e 2074 6869 7320 776f 726b 6572 2773  in this worker's
+00003510: 203a 6174 7472 3a60 7e57 6f72 6b65 7253   :attr:`~WorkerS
+00003520: 7461 7465 2e68 6173 5f77 6861 7460 292e  tate.has_what`).
+00003530: 0a20 2020 206e 6279 7465 733a 2069 6e74  .    nbytes: int
+00003540: 0a0a 2020 2020 233a 2057 6f72 6b65 7220  ..    #: Worker 
+00003550: 6d65 6d6f 7279 2075 6e6b 6e6f 776e 2074  memory unknown t
+00003560: 6f20 7468 6520 776f 726b 6572 2c20 696e  o the worker, in
+00003570: 2062 7974 6573 2c20 7768 6963 6820 6861   bytes, which ha
+00003580: 7320 6265 656e 2074 6865 7265 2066 6f72  s been there for
+00003590: 206d 6f72 6520 7468 616e 0a20 2020 2023   more than.    #
+000035a0: 3a20 3330 2073 6563 6f6e 6473 2e20 5365  : 30 seconds. Se
+000035b0: 6520 3a63 6c61 7373 3a60 4d65 6d6f 7279  e :class:`Memory
+000035c0: 5374 6174 6560 2e0a 2020 2020 5f6d 656d  State`..    _mem
+000035d0: 6f72 795f 756e 6d61 6e61 6765 645f 6f6c  ory_unmanaged_ol
+000035e0: 643a 2069 6e74 0a0a 2020 2020 233a 2048  d: int..    #: H
+000035f0: 6973 746f 7279 206f 6620 7468 6520 6c61  istory of the la
+00003600: 7374 2033 3020 7365 636f 6e64 7327 2077  st 30 seconds' w
+00003610: 6f72 7468 206f 6620 756e 6d61 6e61 6765  orth of unmanage
+00003620: 6420 6d65 6d6f 7279 2e20 5573 6564 2074  d memory. Used t
+00003630: 6f20 6469 6666 6572 656e 7469 6174 650a  o differentiate.
+00003640: 2020 2020 233a 2062 6574 7765 656e 2022      #: between "
+00003650: 6f6c 6422 2061 6e64 2022 6e65 7722 2075  old" and "new" u
+00003660: 6e6d 616e 6167 6564 206d 656d 6f72 792e  nmanaged memory.
+00003670: 0a20 2020 2023 3a20 466f 726d 6174 3a20  .    #: Format: 
+00003680: 6060 5b28 7469 6d65 7374 616d 702c 2062  ``[(timestamp, b
+00003690: 7974 6573 292c 2028 7469 6d65 7374 616d  ytes), (timestam
+000036a0: 702c 2062 7974 6573 292c 202e 2e2e 5d60  p, bytes), ...]`
+000036b0: 600a 2020 2020 5f6d 656d 6f72 795f 756e  `.    _memory_un
+000036c0: 6d61 6e61 6765 645f 6869 7374 6f72 793a  managed_history:
+000036d0: 2064 6571 7565 5b74 7570 6c65 5b66 6c6f   deque[tuple[flo
+000036e0: 6174 2c20 696e 745d 5d0a 0a20 2020 206d  at, int]]..    m
+000036f0: 6574 7269 6373 3a20 6469 6374 5b73 7472  etrics: dict[str
+00003700: 2c20 416e 795d 0a0a 2020 2020 233a 2054  , Any]..    #: T
+00003710: 6865 206c 6173 7420 7469 6d65 2077 6520  he last time we 
+00003720: 7265 6365 6976 6564 2061 2068 6561 7274  received a heart
+00003730: 6265 6174 2066 726f 6d20 7468 6973 2077  beat from this w
+00003740: 6f72 6b65 722c 2069 6e20 6c6f 6361 6c20  orker, in local 
+00003750: 7363 6865 6475 6c65 7220 7469 6d65 2e0a  scheduler time..
+00003760: 2020 2020 6c61 7374 5f73 6565 6e3a 2066      last_seen: f
+00003770: 6c6f 6174 0a0a 2020 2020 7469 6d65 5f64  loat..    time_d
+00003780: 656c 6179 3a20 666c 6f61 740a 2020 2020  elay: float.    
+00003790: 6261 6e64 7769 6474 683a 2066 6c6f 6174  bandwidth: float
+000037a0: 0a0a 2020 2020 233a 2041 2073 6574 206f  ..    #: A set o
+000037b0: 6620 616c 6c20 5461 736b 5374 6174 6573  f all TaskStates
+000037c0: 206f 6e20 7468 6973 2077 6f72 6b65 7220   on this worker 
+000037d0: 7468 6174 2061 7265 2061 6374 6f72 732e  that are actors.
+000037e0: 2054 6869 7320 6f6e 6c79 2069 6e63 6c75   This only inclu
+000037f0: 6465 7320 7468 6f73 650a 2020 2020 233a  des those.    #:
+00003800: 2061 6374 6f72 7320 7768 6f73 6520 7374   actors whose st
+00003810: 6174 6520 6163 7475 616c 6c79 206c 6976  ate actually liv
+00003820: 6573 206f 6e20 7468 6973 2077 6f72 6b65  es on this worke
+00003830: 722c 206e 6f74 2061 6374 6f72 7320 746f  r, not actors to
+00003840: 2077 6869 6368 2074 6869 7320 776f 726b   which this work
+00003850: 6572 0a20 2020 2023 3a20 6861 7320 6120  er.    #: has a 
+00003860: 7265 6665 7265 6e63 652e 0a20 2020 2061  reference..    a
+00003870: 6374 6f72 733a 2073 6574 5b54 6173 6b53  ctors: set[TaskS
+00003880: 7461 7465 5d0a 0a20 2020 2023 3a20 556e  tate]..    #: Un
+00003890: 6465 726c 7969 6e67 2064 6174 6120 6f66  derlying data of
+000038a0: 203a 6d65 7468 3a60 576f 726b 6572 5374   :meth:`WorkerSt
+000038b0: 6174 652e 6861 735f 7768 6174 600a 2020  ate.has_what`.  
+000038c0: 2020 5f68 6173 5f77 6861 743a 2064 6963    _has_what: dic
+000038d0: 745b 5461 736b 5374 6174 652c 204e 6f6e  t[TaskState, Non
+000038e0: 655d 0a0a 2020 2020 233a 2041 2073 6574  e]..    #: A set
+000038f0: 206f 6620 7461 736b 7320 7468 6174 2068   of tasks that h
+00003900: 6176 6520 6265 656e 2073 7562 6d69 7474  ave been submitt
+00003910: 6564 2074 6f20 7468 6973 2077 6f72 6b65  ed to this worke
+00003920: 722e 204d 756c 7469 706c 6520 7461 736b  r. Multiple task
+00003930: 7320 6d61 7920 6265 0a20 2020 2023 2073  s may be.    # s
+00003940: 7562 6d69 7474 6564 2074 6f20 6120 776f  ubmitted to a wo
+00003950: 726b 6572 2069 6e20 6164 7661 6e63 6520  rker in advance 
+00003960: 616e 6420 7468 6520 776f 726b 6572 2077  and the worker w
+00003970: 696c 6c20 7275 6e20 7468 656d 2065 7665  ill run them eve
+00003980: 6e74 7561 6c6c 792c 0a20 2020 2023 2064  ntually,.    # d
+00003990: 6570 656e 6469 6e67 206f 6e20 6974 7320  epending on its 
+000039a0: 6578 6563 7574 696f 6e20 7265 736f 7572  execution resour
+000039b0: 6365 7320 2862 7574 2073 6565 203a 646f  ces (but see :do
+000039c0: 633a 6077 6f72 6b2d 7374 6561 6c69 6e67  c:`work-stealing
+000039d0: 6029 2e0a 2020 2020 233a 0a20 2020 2023  `)..    #:.    #
+000039e0: 3a20 416c 6c20 7468 6520 7461 736b 7320  : All the tasks 
+000039f0: 6865 7265 2061 7265 2069 6e20 7468 6520  here are in the 
+00003a00: 2270 726f 6365 7373 696e 6722 2073 7461  "processing" sta
+00003a10: 7465 2e0a 2020 2020 233a 2054 6869 7320  te..    #: This 
+00003a20: 6174 7472 6962 7574 6520 6973 206b 6570  attribute is kep
+00003a30: 7420 696e 2073 796e 6320 7769 7468 203a  t in sync with :
+00003a40: 6174 7472 3a60 5461 736b 5374 6174 652e  attr:`TaskState.
+00003a50: 7072 6f63 6573 7369 6e67 5f6f 6e60 2e0a  processing_on`..
+00003a60: 2020 2020 7072 6f63 6573 7369 6e67 3a20      processing: 
+00003a70: 7365 745b 5461 736b 5374 6174 655d 0a0a  set[TaskState]..
+00003a80: 2020 2020 233a 2052 756e 6e69 6e67 2074      #: Running t
+00003a90: 6173 6b73 2074 6861 7420 696e 766f 6b65  asks that invoke
+00003aa0: 6420 3a66 756e 633a 6064 6973 7472 6962  d :func:`distrib
+00003ab0: 7574 6564 2e73 6563 6564 6560 0a20 2020  uted.secede`.   
+00003ac0: 206c 6f6e 675f 7275 6e6e 696e 673a 2073   long_running: s
+00003ad0: 6574 5b54 6173 6b53 7461 7465 5d0a 0a20  et[TaskState].. 
+00003ae0: 2020 2023 3a20 4120 6469 6374 696f 6e61     #: A dictiona
+00003af0: 7279 206f 6620 7461 736b 7320 7468 6174  ry of tasks that
+00003b00: 2061 7265 2063 7572 7265 6e74 6c79 2062   are currently b
+00003b10: 6569 6e67 2072 756e 206f 6e20 7468 6973  eing run on this
+00003b20: 2077 6f72 6b65 722e 0a20 2020 2023 3a20   worker..    #: 
+00003b30: 4561 6368 2074 6173 6b20 7374 6174 6520  Each task state 
+00003b40: 6973 2061 7373 6f63 6961 7465 6420 7769  is associated wi
+00003b50: 7468 2074 6865 2064 7572 6174 696f 6e20  th the duration 
+00003b60: 696e 2073 6563 6f6e 6473 2077 6869 6368  in seconds which
+00003b70: 2074 6865 2074 6173 6b20 6861 730a 2020   the task has.  
+00003b80: 2020 233a 2062 6565 6e20 7275 6e6e 696e    #: been runnin
+00003b90: 672e 0a20 2020 2065 7865 6375 7469 6e67  g..    executing
+00003ba0: 3a20 6469 6374 5b54 6173 6b53 7461 7465  : dict[TaskState
+00003bb0: 2c20 666c 6f61 745d 0a0a 2020 2020 233a  , float]..    #:
+00003bc0: 2054 6865 2061 7661 696c 6162 6c65 2072   The available r
+00003bd0: 6573 6f75 7263 6573 206f 6e20 7468 6973  esources on this
+00003be0: 2077 6f72 6b65 722c 2065 2e67 2e20 6060   worker, e.g. ``
+00003bf0: 7b22 4750 5522 3a20 327d 6060 2e0a 2020  {"GPU": 2}``..  
+00003c00: 2020 233a 2054 6865 7365 2061 7265 2061    #: These are a
+00003c10: 6273 7472 6163 7420 7175 616e 7469 7469  bstract quantiti
+00003c20: 6573 2074 6861 7420 636f 6e73 7472 6169  es that constrai
+00003c30: 6e20 6365 7274 6169 6e20 7461 736b 7320  n certain tasks 
+00003c40: 6672 6f6d 2072 756e 6e69 6e67 2061 7420  from running at 
+00003c50: 7468 650a 2020 2020 233a 2073 616d 6520  the.    #: same 
+00003c60: 7469 6d65 206f 6e20 7468 6973 2077 6f72  time on this wor
+00003c70: 6b65 722e 0a20 2020 2072 6573 6f75 7263  ker..    resourc
+00003c80: 6573 3a20 6469 6374 5b73 7472 2c20 666c  es: dict[str, fl
+00003c90: 6f61 745d 0a0a 2020 2020 233a 2054 6865  oat]..    #: The
+00003ca0: 2073 756d 206f 6620 6561 6368 2072 6573   sum of each res
+00003cb0: 6f75 7263 6520 7573 6564 2062 7920 616c  ource used by al
+00003cc0: 6c20 7461 736b 7320 616c 6c6f 6361 7465  l tasks allocate
+00003cd0: 6420 746f 2074 6869 7320 776f 726b 6572  d to this worker
+00003ce0: 2e0a 2020 2020 233a 2054 6865 206e 756d  ..    #: The num
+00003cf0: 6265 7273 2069 6e20 7468 6973 2064 6963  bers in this dic
+00003d00: 7469 6f6e 6172 7920 6361 6e20 6f6e 6c79  tionary can only
+00003d10: 2062 6520 6c65 7373 206f 7220 6571 7561   be less or equa
+00003d20: 6c20 7468 616e 2074 686f 7365 2069 6e20  l than those in 
+00003d30: 7468 6973 0a20 2020 2023 3a20 776f 726b  this.    #: work
+00003d40: 6572 2773 203a 6174 7472 3a60 7e57 6f72  er's :attr:`~Wor
+00003d50: 6b65 7253 7461 7465 2e72 6573 6f75 7263  kerState.resourc
+00003d60: 6573 602e 0a20 2020 2075 7365 645f 7265  es`..    used_re
+00003d70: 736f 7572 6365 733a 2064 6963 745b 7374  sources: dict[st
+00003d80: 722c 2066 6c6f 6174 5d0a 0a20 2020 2023  r, float]..    #
+00003d90: 3a20 4172 6269 7472 6172 7920 6164 6469  : Arbitrary addi
+00003da0: 7469 6f6e 616c 206d 6574 6164 6174 6120  tional metadata 
+00003db0: 746f 2062 6520 6164 6465 6420 746f 203a  to be added to :
+00003dc0: 6d65 7468 3a60 7e57 6f72 6b65 7253 7461  meth:`~WorkerSta
+00003dd0: 7465 2e69 6465 6e74 6974 7960 0a20 2020  te.identity`.   
+00003de0: 2065 7874 7261 3a20 6469 6374 5b73 7472   extra: dict[str
+00003df0: 2c20 416e 795d 0a0a 2020 2020 2320 5468  , Any]..    # Th
+00003e00: 6520 756e 6971 7565 2073 6572 7665 7220  e unique server 
+00003e10: 4944 2074 6869 7320 576f 726b 6572 5374  ID this WorkerSt
+00003e20: 6174 6520 6973 2072 6566 6572 656e 6369  ate is referenci
+00003e30: 6e67 0a20 2020 2073 6572 7665 725f 6964  ng.    server_id
+00003e40: 3a20 7374 720a 0a20 2020 2023 2052 6566  : str..    # Ref
+00003e50: 6572 656e 6365 2074 6f20 7363 6865 6475  erence to schedu
+00003e60: 6c65 7220 7461 736b 5f67 726f 7570 730a  ler task_groups.
+00003e70: 2020 2020 7363 6865 6475 6c65 725f 7265      scheduler_re
+00003e80: 663a 2077 6561 6b72 6566 2e72 6566 5b53  f: weakref.ref[S
+00003e90: 6368 6564 756c 6572 5374 6174 655d 207c  chedulerState] |
+00003ea0: 204e 6f6e 650a 2020 2020 7461 736b 5f70   None.    task_p
+00003eb0: 7265 6669 785f 636f 756e 743a 2064 6566  refix_count: def
+00003ec0: 6175 6c74 6469 6374 5b73 7472 2c20 696e  aultdict[str, in
+00003ed0: 745d 0a20 2020 205f 6e65 7477 6f72 6b5f  t].    _network_
+00003ee0: 6f63 633a 2066 6c6f 6174 0a20 2020 205f  occ: float.    _
+00003ef0: 6f63 6375 7061 6e63 795f 6361 6368 653a  occupancy_cache:
+00003f00: 2066 6c6f 6174 207c 204e 6f6e 650a 0a20   float | None.. 
+00003f10: 2020 2023 3a20 4b65 7973 2074 6861 7420     #: Keys that 
+00003f20: 6d61 7920 6e65 6564 2074 6f20 6265 2066  may need to be f
+00003f30: 6574 6368 6564 2074 6f20 7468 6973 2077  etched to this w
+00003f40: 6f72 6b65 722c 2061 6e64 2074 6865 206e  orker, and the n
+00003f50: 756d 6265 7220 6f66 2074 6173 6b73 2074  umber of tasks t
+00003f60: 6861 7420 6e65 6564 2074 6865 6d2e 0a20  hat need them.. 
+00003f70: 2020 2023 3a20 416c 6c20 7461 736b 7320     #: All tasks 
+00003f80: 6172 6520 6375 7272 656e 746c 7920 696e  are currently in
+00003f90: 2060 6d65 6d6f 7279 6020 6f6e 2061 2077   `memory` on a w
+00003fa0: 6f72 6b65 7220 6f74 6865 7220 7468 616e  orker other than
+00003fb0: 2074 6869 7320 6f6e 652e 0a20 2020 2023   this one..    #
+00003fc0: 3a20 4d75 6368 206c 696b 6520 6070 726f  : Much like `pro
+00003fd0: 6365 7373 696e 6760 2c20 7468 6973 2064  cessing`, this d
+00003fe0: 6f65 7320 6e6f 7420 6578 6163 746c 7920  oes not exactly 
+00003ff0: 7265 666c 6563 7420 776f 726b 6572 2073  reflect worker s
+00004000: 7461 7465 3a0a 2020 2020 233a 206b 6579  tate:.    #: key
+00004010: 7320 6865 7265 206d 6179 2062 6520 7175  s here may be qu
+00004020: 6575 6564 2074 6f20 6665 7463 682c 2069  eued to fetch, i
+00004030: 6e20 666c 6967 6874 2c20 6f72 2061 6c72  n flight, or alr
+00004040: 6561 6479 2069 6e20 6d65 6d6f 7279 0a20  eady in memory. 
+00004050: 2020 2023 3a20 6f6e 2074 6865 2077 6f72     #: on the wor
+00004060: 6b65 722e 0a20 2020 206e 6565 6473 5f77  ker..    needs_w
+00004070: 6861 743a 2064 6963 745b 5461 736b 5374  hat: dict[TaskSt
+00004080: 6174 652c 2069 6e74 5d0a 0a20 2020 205f  ate, int]..    _
+00004090: 5f73 6c6f 7473 5f5f 203d 2074 7570 6c65  _slots__ = tuple
+000040a0: 285f 5f61 6e6e 6f74 6174 696f 6e73 5f5f  (__annotations__
+000040b0: 290a 0a20 2020 2064 6566 205f 5f69 6e69  )..    def __ini
+000040c0: 745f 5f28 0a20 2020 2020 2020 2073 656c  t__(.        sel
+000040d0: 662c 0a20 2020 2020 2020 202a 2c0a 2020  f,.        *,.  
+000040e0: 2020 2020 2020 6164 6472 6573 733a 2073        address: s
+000040f0: 7472 2c0a 2020 2020 2020 2020 7374 6174  tr,.        stat
+00004100: 7573 3a20 5374 6174 7573 2c0a 2020 2020  us: Status,.    
+00004110: 2020 2020 7069 643a 2069 6e74 2c0a 2020      pid: int,.  
+00004120: 2020 2020 2020 6e61 6d65 3a20 6f62 6a65        name: obje
+00004130: 6374 2c0a 2020 2020 2020 2020 6e74 6872  ct,.        nthr
+00004140: 6561 6473 3a20 696e 7420 3d20 302c 0a20  eads: int = 0,. 
+00004150: 2020 2020 2020 206d 656d 6f72 795f 6c69         memory_li
+00004160: 6d69 743a 2069 6e74 2c0a 2020 2020 2020  mit: int,.      
+00004170: 2020 6c6f 6361 6c5f 6469 7265 6374 6f72    local_director
+00004180: 793a 2073 7472 2c0a 2020 2020 2020 2020  y: str,.        
+00004190: 6e61 6e6e 793a 2073 7472 207c 204e 6f6e  nanny: str | Non
+000041a0: 652c 0a20 2020 2020 2020 2073 6572 7665  e,.        serve
+000041b0: 725f 6964 3a20 7374 722c 0a20 2020 2020  r_id: str,.     
+000041c0: 2020 2073 6572 7669 6365 733a 2064 6963     services: dic
+000041d0: 745b 7374 722c 2069 6e74 5d20 7c20 4e6f  t[str, int] | No
+000041e0: 6e65 203d 204e 6f6e 652c 0a20 2020 2020  ne = None,.     
+000041f0: 2020 2076 6572 7369 6f6e 733a 2064 6963     versions: dic
+00004200: 745b 7374 722c 2041 6e79 5d20 7c20 4e6f  t[str, Any] | No
+00004210: 6e65 203d 204e 6f6e 652c 0a20 2020 2020  ne = None,.     
+00004220: 2020 2065 7874 7261 3a20 6469 6374 5b73     extra: dict[s
+00004230: 7472 2c20 416e 795d 207c 204e 6f6e 6520  tr, Any] | None 
+00004240: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00004250: 7363 6865 6475 6c65 723a 2053 6368 6564  scheduler: Sched
+00004260: 756c 6572 5374 6174 6520 7c20 4e6f 6e65  ulerState | None
+00004270: 203d 204e 6f6e 652c 0a20 2020 2029 3a0a   = None,.    ):.
+00004280: 2020 2020 2020 2020 7365 6c66 2e73 6572          self.ser
+00004290: 7665 725f 6964 203d 2073 6572 7665 725f  ver_id = server_
+000042a0: 6964 0a20 2020 2020 2020 2073 656c 662e  id.        self.
+000042b0: 6164 6472 6573 7320 3d20 6164 6472 6573  address = addres
+000042c0: 730a 2020 2020 2020 2020 7365 6c66 2e70  s.        self.p
+000042d0: 6964 203d 2070 6964 0a20 2020 2020 2020  id = pid.       
+000042e0: 2073 656c 662e 6e61 6d65 203d 206e 616d   self.name = nam
+000042f0: 650a 2020 2020 2020 2020 7365 6c66 2e6e  e.        self.n
+00004300: 7468 7265 6164 7320 3d20 6e74 6872 6561  threads = nthrea
+00004310: 6473 0a20 2020 2020 2020 2073 656c 662e  ds.        self.
+00004320: 6d65 6d6f 7279 5f6c 696d 6974 203d 206d  memory_limit = m
+00004330: 656d 6f72 795f 6c69 6d69 740a 2020 2020  emory_limit.    
+00004340: 2020 2020 7365 6c66 2e6c 6f63 616c 5f64      self.local_d
+00004350: 6972 6563 746f 7279 203d 206c 6f63 616c  irectory = local
+00004360: 5f64 6972 6563 746f 7279 0a20 2020 2020  _directory.     
+00004370: 2020 2073 656c 662e 7365 7276 6963 6573     self.services
+00004380: 203d 2073 6572 7669 6365 7320 6f72 207b   = services or {
+00004390: 7d0a 2020 2020 2020 2020 7365 6c66 2e76  }.        self.v
+000043a0: 6572 7369 6f6e 7320 3d20 7665 7273 696f  ersions = versio
+000043b0: 6e73 206f 7220 7b7d 0a20 2020 2020 2020  ns or {}.       
+000043c0: 2073 656c 662e 6e61 6e6e 7920 3d20 6e61   self.nanny = na
+000043d0: 6e6e 790a 2020 2020 2020 2020 7365 6c66  nny.        self
+000043e0: 2e73 7461 7475 7320 3d20 7374 6174 7573  .status = status
+000043f0: 0a20 2020 2020 2020 2073 656c 662e 5f68  .        self._h
+00004400: 6173 6820 3d20 6861 7368 2873 656c 662e  ash = hash(self.
+00004410: 7365 7276 6572 5f69 6429 0a20 2020 2020  server_id).     
+00004420: 2020 2073 656c 662e 6e62 7974 6573 203d     self.nbytes =
+00004430: 2030 0a20 2020 2020 2020 2073 656c 662e   0.        self.
+00004440: 5f6d 656d 6f72 795f 756e 6d61 6e61 6765  _memory_unmanage
+00004450: 645f 6f6c 6420 3d20 300a 2020 2020 2020  d_old = 0.      
+00004460: 2020 7365 6c66 2e5f 6d65 6d6f 7279 5f75    self._memory_u
+00004470: 6e6d 616e 6167 6564 5f68 6973 746f 7279  nmanaged_history
+00004480: 203d 2064 6571 7565 2829 0a20 2020 2020   = deque().     
+00004490: 2020 2073 656c 662e 6d65 7472 6963 7320     self.metrics 
+000044a0: 3d20 7b7d 0a20 2020 2020 2020 2073 656c  = {}.        sel
+000044b0: 662e 6c61 7374 5f73 6565 6e20 3d20 7469  f.last_seen = ti
+000044c0: 6d65 2829 0a20 2020 2020 2020 2073 656c  me().        sel
+000044d0: 662e 7469 6d65 5f64 656c 6179 203d 2030  f.time_delay = 0
+000044e0: 0a20 2020 2020 2020 2073 656c 662e 6261  .        self.ba
+000044f0: 6e64 7769 6474 6820 3d20 7061 7273 655f  ndwidth = parse_
+00004500: 6279 7465 7328 6461 736b 2e63 6f6e 6669  bytes(dask.confi
+00004510: 672e 6765 7428 2264 6973 7472 6962 7574  g.get("distribut
+00004520: 6564 2e73 6368 6564 756c 6572 2e62 616e  ed.scheduler.ban
+00004530: 6477 6964 7468 2229 290a 2020 2020 2020  dwidth")).      
+00004540: 2020 7365 6c66 2e61 6374 6f72 7320 3d20    self.actors = 
+00004550: 7365 7428 290a 2020 2020 2020 2020 7365  set().        se
+00004560: 6c66 2e5f 6861 735f 7768 6174 203d 207b  lf._has_what = {
+00004570: 7d0a 2020 2020 2020 2020 7365 6c66 2e70  }.        self.p
+00004580: 726f 6365 7373 696e 6720 3d20 7365 7428  rocessing = set(
+00004590: 290a 2020 2020 2020 2020 7365 6c66 2e6c  ).        self.l
+000045a0: 6f6e 675f 7275 6e6e 696e 6720 3d20 7365  ong_running = se
+000045b0: 7428 290a 2020 2020 2020 2020 7365 6c66  t().        self
+000045c0: 2e65 7865 6375 7469 6e67 203d 207b 7d0a  .executing = {}.
+000045d0: 2020 2020 2020 2020 7365 6c66 2e72 6573          self.res
+000045e0: 6f75 7263 6573 203d 207b 7d0a 2020 2020  ources = {}.    
+000045f0: 2020 2020 7365 6c66 2e75 7365 645f 7265      self.used_re
+00004600: 736f 7572 6365 7320 3d20 7b7d 0a20 2020  sources = {}.   
+00004610: 2020 2020 2073 656c 662e 6578 7472 6120       self.extra 
+00004620: 3d20 6578 7472 6120 6f72 207b 7d0a 2020  = extra or {}.  
+00004630: 2020 2020 2020 7365 6c66 2e73 6368 6564        self.sched
+00004640: 756c 6572 5f72 6566 203d 2077 6561 6b72  uler_ref = weakr
+00004650: 6566 2e72 6566 2873 6368 6564 756c 6572  ef.ref(scheduler
+00004660: 2920 6966 2073 6368 6564 756c 6572 2065  ) if scheduler e
+00004670: 6c73 6520 4e6f 6e65 0a20 2020 2020 2020  lse None.       
+00004680: 2073 656c 662e 7461 736b 5f70 7265 6669   self.task_prefi
+00004690: 785f 636f 756e 7420 3d20 6465 6661 756c  x_count = defaul
+000046a0: 7464 6963 7428 696e 7429 0a20 2020 2020  tdict(int).     
+000046b0: 2020 2073 656c 662e 6e65 6564 735f 7768     self.needs_wh
+000046c0: 6174 203d 207b 7d0a 2020 2020 2020 2020  at = {}.        
+000046d0: 7365 6c66 2e5f 6e65 7477 6f72 6b5f 6f63  self._network_oc
+000046e0: 6320 3d20 300a 2020 2020 2020 2020 7365  c = 0.        se
+000046f0: 6c66 2e5f 6f63 6375 7061 6e63 795f 6361  lf._occupancy_ca
+00004700: 6368 6520 3d20 4e6f 6e65 0a0a 2020 2020  che = None..    
+00004710: 6465 6620 5f5f 6861 7368 5f5f 2873 656c  def __hash__(sel
+00004720: 6629 202d 3e20 696e 743a 0a20 2020 2020  f) -> int:.     
+00004730: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
+00004740: 6861 7368 0a0a 2020 2020 6465 6620 5f5f  hash..    def __
+00004750: 6571 5f5f 2873 656c 662c 206f 7468 6572  eq__(self, other
+00004760: 3a20 6f62 6a65 6374 2920 2d3e 2062 6f6f  : object) -> boo
+00004770: 6c3a 0a20 2020 2020 2020 2072 6574 7572  l:.        retur
+00004780: 6e20 6973 696e 7374 616e 6365 286f 7468  n isinstance(oth
+00004790: 6572 2c20 576f 726b 6572 5374 6174 6529  er, WorkerState)
+000047a0: 2061 6e64 206f 7468 6572 2e73 6572 7665   and other.serve
+000047b0: 725f 6964 203d 3d20 7365 6c66 2e73 6572  r_id == self.ser
+000047c0: 7665 725f 6964 0a0a 2020 2020 4070 726f  ver_id..    @pro
+000047d0: 7065 7274 790a 2020 2020 6465 6620 6861  perty.    def ha
+000047e0: 735f 7768 6174 2873 656c 6629 202d 3e20  s_what(self) -> 
+000047f0: 5365 745b 5461 736b 5374 6174 655d 3a0a  Set[TaskState]:.
+00004800: 2020 2020 2020 2020 2222 2241 6e20 696e          """An in
+00004810: 7365 7274 696f 6e2d 736f 7274 6564 2073  sertion-sorted s
+00004820: 6574 2d6c 696b 6520 6f66 2074 6173 6b73  et-like of tasks
+00004830: 2077 6869 6368 2063 7572 7265 6e74 6c79   which currently
+00004840: 2072 6573 6964 6520 6f6e 2074 6869 7320   reside on this 
+00004850: 776f 726b 6572 2e0a 2020 2020 2020 2020  worker..        
+00004860: 416c 6c20 7468 6520 7461 736b 7320 6865  All the tasks he
+00004870: 7265 2061 7265 2069 6e20 7468 6520 226d  re are in the "m
+00004880: 656d 6f72 7922 2073 7461 7465 2e0a 2020  emory" state..  
+00004890: 2020 2020 2020 5468 6973 2069 7320 7468        This is th
+000048a0: 6520 7265 7665 7273 6520 6d61 7070 696e  e reverse mappin
+000048b0: 6720 6f66 203a 6174 7472 3a60 5461 736b  g of :attr:`Task
+000048c0: 5374 6174 652e 7768 6f5f 6861 7360 2e0a  State.who_has`..
+000048d0: 0a20 2020 2020 2020 2054 6869 7320 6973  .        This is
+000048e0: 2061 2072 6561 642d 6f6e 6c79 2070 7562   a read-only pub
+000048f0: 6c69 6320 6163 6365 7373 6f72 2e20 5468  lic accessor. Th
+00004900: 6520 6461 7461 2069 7320 696d 706c 656d  e data is implem
+00004910: 656e 7465 6420 6173 2061 2064 6963 7420  ented as a dict 
+00004920: 7769 7468 6f75 740a 2020 2020 2020 2020  without.        
+00004930: 7661 6c75 6573 2c20 6265 6361 7573 6520  values, because 
+00004940: 7265 6261 6c61 6e63 6528 2920 7265 6c69  rebalance() reli
+00004950: 6573 206f 6e20 6469 6374 7320 6265 696e  es on dicts bein
+00004960: 6720 696e 7365 7274 696f 6e2d 736f 7274  g insertion-sort
+00004970: 6564 2e0a 2020 2020 2020 2020 2222 220a  ed..        """.
+00004980: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00004990: 656c 662e 5f68 6173 5f77 6861 742e 6b65  elf._has_what.ke
+000049a0: 7973 2829 0a0a 2020 2020 4070 726f 7065  ys()..    @prope
+000049b0: 7274 790a 2020 2020 6465 6620 686f 7374  rty.    def host
+000049c0: 2873 656c 6629 202d 3e20 7374 723a 0a20  (self) -> str:. 
+000049d0: 2020 2020 2020 2072 6574 7572 6e20 6765         return ge
+000049e0: 745f 6164 6472 6573 735f 686f 7374 2873  t_address_host(s
+000049f0: 656c 662e 6164 6472 6573 7329 0a0a 2020  elf.address)..  
+00004a00: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
+00004a10: 6465 6620 6d65 6d6f 7279 2873 656c 6629  def memory(self)
+00004a20: 202d 3e20 4d65 6d6f 7279 5374 6174 653a   -> MemoryState:
+00004a30: 0a20 2020 2020 2020 2022 2222 506f 6c69  .        """Poli
+00004a40: 7368 6564 206d 656d 6f72 7920 6d65 7472  shed memory metr
+00004a50: 6963 7320 666f 7220 7468 6520 776f 726b  ics for the work
+00004a60: 6572 2e0a 0a20 2020 2020 2020 202a 2a44  er...        **D
+00004a70: 6573 6967 6e20 6e6f 7465 206f 6e20 6d61  esign note on ma
+00004a80: 6e61 6765 6420 6d65 6d6f 7279 2a2a 0a0a  naged memory**..
+00004a90: 2020 2020 2020 2020 5468 6572 6520 6172          There ar
+00004aa0: 6520 7477 6f20 6d65 6173 7572 6573 2061  e two measures a
+00004ab0: 7661 696c 6162 6c65 2066 6f72 206d 616e  vailable for man
+00004ac0: 6167 6564 206d 656d 6f72 793a 0a0a 2020  aged memory:..  
+00004ad0: 2020 2020 2020 2d20 6060 7365 6c66 2e6e        - ``self.n
+00004ae0: 6279 7465 7360 600a 2020 2020 2020 2020  bytes``.        
+00004af0: 2d20 6060 7365 6c66 2e6d 6574 7269 6373  - ``self.metrics
+00004b00: 5b22 6d61 6e61 6765 645f 6279 7465 7322  ["managed_bytes"
+00004b10: 5d60 600a 0a20 2020 2020 2020 2041 7420  ]``..        At 
+00004b20: 7265 7374 2c20 7468 6520 7477 6f20 6e75  rest, the two nu
+00004b30: 6d62 6572 7320 6d75 7374 2062 6520 6964  mbers must be id
+00004b40: 656e 7469 6361 6c2e 2048 6f77 6576 6572  entical. However
+00004b50: 2c20 6060 7365 6c66 2e6e 6279 7465 7360  , ``self.nbytes`
+00004b60: 6020 6973 0a20 2020 2020 2020 2069 6d6d  ` is.        imm
+00004b70: 6564 6961 7465 6c79 2075 7064 6174 6564  ediately updated
+00004b80: 2074 6872 6f75 6768 2074 6865 2062 6174   through the bat
+00004b90: 6368 6564 2063 6f6d 6d73 2061 7320 736f  ched comms as so
+00004ba0: 6f6e 2061 7320 6561 6368 2074 6173 6b20  on as each task 
+00004bb0: 6c61 6e64 7320 696e 0a20 2020 2020 2020  lands in.       
+00004bc0: 206d 656d 6f72 7920 6f6e 2074 6865 2077   memory on the w
+00004bd0: 6f72 6b65 723b 2060 6073 656c 662e 6d65  orker; ``self.me
+00004be0: 7472 6963 735b 226d 616e 6167 6564 5f62  trics["managed_b
+00004bf0: 7974 6573 225d 6060 2069 6e73 7465 6164  ytes"]`` instead
+00004c00: 2069 7320 7570 6461 7465 6420 6279 0a20   is updated by. 
+00004c10: 2020 2020 2020 2074 6865 2068 6561 7274         the heart
+00004c20: 6265 6174 2c20 7768 6963 6820 6361 6e20  beat, which can 
+00004c30: 6c61 6720 7365 7665 7261 6c20 7365 636f  lag several seco
+00004c40: 6e64 7320 6265 6869 6e64 2e0a 0a20 2020  nds behind...   
+00004c50: 2020 2020 2042 656c 6f77 2077 6520 6172       Below we ar
+00004c60: 6520 6d69 7869 6e67 206c 696b 656c 7920  e mixing likely 
+00004c70: 6e65 7765 7220 6d61 6e61 6765 6420 6d65  newer managed me
+00004c80: 6d6f 7279 2069 6e66 6f20 6672 6f6d 2060  mory info from `
+00004c90: 6073 656c 662e 6e62 7974 6573 6060 2077  `self.nbytes`` w
+00004ca0: 6974 680a 2020 2020 2020 2020 7072 6f63  ith.        proc
+00004cb0: 6573 7320 616e 6420 7370 696c 6c65 6420  ess and spilled 
+00004cc0: 6d65 6d6f 7279 2066 726f 6d20 7468 6520  memory from the 
+00004cd0: 6865 6172 7462 6561 742e 2054 6869 7320  heartbeat. This 
+00004ce0: 6973 2064 656c 6962 6572 6174 652c 2073  is deliberate, s
+00004cf0: 6f20 7468 6174 0a20 2020 2020 2020 206d  o that.        m
+00004d00: 616e 6167 6564 206d 656d 6f72 7920 746f  anaged memory to
+00004d10: 7461 6c20 6973 2075 7064 6174 6564 206d  tal is updated m
+00004d20: 6f72 6520 6672 6571 7565 6e74 6c79 2e0a  ore frequently..
+00004d30: 0a20 2020 2020 2020 204d 616e 6167 6564  .        Managed
+00004d40: 206d 656d 6f72 7920 6469 7265 6374 6c79   memory directly
+00004d50: 2061 6e64 2069 6d6d 6564 6961 7465 6c79   and immediately
+00004d60: 2063 6f6e 7472 6962 7574 6573 2074 6f20   contributes to 
+00004d70: 6f70 7469 6d69 7374 6963 206d 656d 6f72  optimistic memor
+00004d80: 792c 2077 6869 6368 0a20 2020 2020 2020  y, which.       
+00004d90: 2069 7320 696e 2074 7572 6e20 7573 6564   is in turn used
+00004da0: 2069 6e20 4163 7469 7665 204d 656d 6f72   in Active Memor
+00004db0: 7920 4d61 6e61 6765 7220 6865 7572 6973  y Manager heuris
+00004dc0: 7469 6373 2028 6174 2074 6865 206d 6f6d  tics (at the mom
+00004dd0: 656e 7420 6f66 2077 7269 7469 6e67 3b0a  ent of writing;.
+00004de0: 2020 2020 2020 2020 6d6f 7265 2075 7365          more use
+00004df0: 7320 7769 6c6c 206c 696b 656c 7920 6265  s will likely be
+00004e00: 2061 6464 6564 2069 6e20 7468 6520 6675   added in the fu
+00004e10: 7475 7265 292e 2053 6f20 6974 2773 2069  ture). So it's i
+00004e20: 6d70 6f72 7461 6e74 2074 6f20 6861 7665  mportant to have
+00004e30: 2069 740a 2020 2020 2020 2020 7570 2074   it.        up t
+00004e40: 6f20 6461 7465 3b20 6d75 6368 206d 6f72  o date; much mor
+00004e50: 6520 7468 616e 2069 7420 6973 2066 6f72  e than it is for
+00004e60: 2070 726f 6365 7373 206d 656d 6f72 792e   process memory.
+00004e70: 0a0a 2020 2020 2020 2020 4861 7669 6e67  ..        Having
+00004e80: 2075 702d 746f 2d64 6174 6520 6d61 6e61   up-to-date mana
+00004e90: 6765 6420 6d65 6d6f 7279 2069 6e66 6f20  ged memory info 
+00004ea0: 6173 2073 6f6f 6e20 6173 2074 6865 2073  as soon as the s
+00004eb0: 6368 6564 756c 6572 206c 6561 726e 7320  cheduler learns 
+00004ec0: 6162 6f75 740a 2020 2020 2020 2020 7461  about.        ta
+00004ed0: 736b 2063 6f6d 706c 6574 696f 6e20 616c  sk completion al
+00004ee0: 736f 2073 7562 7374 616e 7469 616c 6c79  so substantially
+00004ef0: 2073 696d 706c 6966 6965 7320 756e 6974   simplifies unit
+00004f00: 2074 6573 7473 2e0a 0a20 2020 2020 2020   tests...       
+00004f10: 2054 6865 2066 6c69 7020 7369 6465 206f   The flip side o
+00004f20: 6620 7468 6973 2064 6573 6967 6e20 6973  f this design is
+00004f30: 2074 6861 7420 6974 206d 6179 2063 6175   that it may cau
+00004f40: 7365 2073 6f6d 6520 6e6f 6973 6520 696e  se some noise in
+00004f50: 2074 6865 0a20 2020 2020 2020 2075 6e6d   the.        unm
+00004f60: 616e 6167 6564 5f72 6563 656e 7420 6d65  anaged_recent me
+00004f70: 6173 7572 652e 2065 2e67 2e3a 0a0a 2020  asure. e.g.:..  
+00004f80: 2020 2020 2020 312e 2044 656c 6574 6520        1. Delete 
+00004f90: 3130 304d 4220 6f66 206d 616e 6167 6564  100MB of managed
+00004fa0: 2064 6174 610a 2020 2020 2020 2020 322e   data.        2.
+00004fb0: 2054 6865 2075 7064 6174 6564 206d 616e   The updated man
+00004fc0: 6167 6564 206d 656d 6f72 7920 7265 6163  aged memory reac
+00004fd0: 6865 7320 7468 6520 7363 6865 6475 6c65  hes the schedule
+00004fe0: 7220 6661 7374 6572 2074 6861 6e20 7468  r faster than th
+00004ff0: 650a 2020 2020 2020 2020 2020 2075 7064  e.           upd
+00005000: 6174 6564 2070 726f 6365 7373 206d 656d  ated process mem
+00005010: 6f72 790a 2020 2020 2020 2020 332e 2054  ory.        3. T
+00005020: 6865 7265 2773 2061 2062 6c69 7020 7768  here's a blip wh
+00005030: 6572 6520 7468 6520 7363 6865 6475 6c65  ere the schedule
+00005040: 7220 7468 696e 6b73 2074 6861 7420 7468  r thinks that th
+00005050: 6572 6527 7320 6120 7375 6464 656e 2031  ere's a sudden 1
+00005060: 3030 4d42 0a20 2020 2020 2020 2020 2020  00MB.           
+00005070: 696e 6372 6561 7365 2069 6e20 756e 6d61  increase in unma
+00005080: 6e61 6765 645f 7265 6365 6e74 2c20 7369  naged_recent, si
+00005090: 6e63 6520 7072 6f63 6573 7320 6d65 6d6f  nce process memo
+000050a0: 7279 2068 6173 6e27 7420 6368 616e 6765  ry hasn't change
+000050b0: 6420 6275 7420 6d61 6e61 6765 640a 2020  d but managed.  
+000050c0: 2020 2020 2020 2020 206d 656d 6f72 7920           memory 
+000050d0: 6861 7320 6465 6372 6561 7365 6420 6279  has decreased by
+000050e0: 2031 3030 4d42 0a20 2020 2020 2020 2034   100MB.        4
+000050f0: 2e20 5768 656e 2074 6865 2068 6561 7274  . When the heart
+00005100: 6265 6174 2061 7272 6976 6573 2c20 7072  beat arrives, pr
+00005110: 6f63 6573 7320 6d65 6d6f 7279 2067 6f65  ocess memory goe
+00005120: 7320 646f 776e 2061 6e64 2073 6f20 646f  s down and so do
+00005130: 6573 2074 6865 0a20 2020 2020 2020 2020  es the.         
+00005140: 2020 756e 6d61 6e61 6765 645f 7265 6365    unmanaged_rece
+00005150: 6e74 2e0a 0a20 2020 2020 2020 2054 6869  nt...        Thi
+00005160: 7320 6973 204f 4b20 2d20 6f6e 6520 6f66  s is OK - one of
+00005170: 2074 6865 206d 6169 6e20 7265 6173 6f6e   the main reason
+00005180: 7320 666f 7220 7468 6520 756e 6d61 6e61  s for the unmana
+00005190: 6765 645f 7265 6365 6e74 202f 2075 6e6d  ged_recent / unm
+000051a0: 616e 6167 6564 5f6f 6c64 0a20 2020 2020  anaged_old.     
+000051b0: 2020 2073 706c 6974 2069 7320 6578 6163     split is exac
+000051c0: 746c 7920 746f 2063 6f6e 6365 6e74 7261  tly to concentra
+000051d0: 7465 2061 6c6c 2074 6865 206e 6f69 7365  te all the noise
+000051e0: 2069 6e20 756e 6d61 6e61 6765 645f 7265   in unmanaged_re
+000051f0: 6365 6e74 2061 6e64 2065 7863 6c75 6465  cent and exclude
+00005200: 2069 740a 2020 2020 2020 2020 6672 6f6d   it.        from
+00005210: 206f 7074 696d 6973 7469 6320 6d65 6d6f   optimistic memo
+00005220: 7279 2c20 7768 6963 6820 6973 2075 7365  ry, which is use
+00005230: 6420 666f 7220 6865 7572 6973 7469 6373  d for heuristics
+00005240: 2e0a 0a20 2020 2020 2020 2053 6f6d 6574  ...        Somet
+00005250: 6869 6e67 2074 6861 7420 6973 206c 6573  hing that is les
+00005260: 7320 4f4b 2c20 6275 7420 616c 736f 206c  s OK, but also l
+00005270: 6573 7320 6672 6571 7565 6e74 2c20 6973  ess frequent, is
+00005280: 2074 6861 7420 7468 6520 7375 6464 656e   that the sudden
+00005290: 2064 656c 6574 696f 6e0a 2020 2020 2020   deletion.      
+000052a0: 2020 6f66 2073 7069 6c6c 6564 206b 6579    of spilled key
+000052b0: 7320 7769 6c6c 2063 6175 7365 2061 206e  s will cause a n
+000052c0: 6567 6174 6976 6520 626c 6970 2069 6e20  egative blip in 
+000052d0: 6d61 6e61 6765 6420 6d65 6d6f 7279 3a0a  managed memory:.
+000052e0: 0a20 2020 2020 2020 2031 2e20 4465 6c65  .        1. Dele
+000052f0: 7465 2031 3030 4d42 206f 6620 7370 696c  te 100MB of spil
+00005300: 6c65 6420 6461 7461 0a20 2020 2020 2020  led data.       
+00005310: 2032 2e20 5468 6520 7570 6461 7465 6420   2. The updated 
+00005320: 6d61 6e61 6765 6420 6d65 6d6f 7279 202a  managed memory *
+00005330: 746f 7461 6c2a 2072 6561 6368 6573 2074  total* reaches t
+00005340: 6865 2073 6368 6564 756c 6572 2066 6173  he scheduler fas
+00005350: 7465 7220 7468 616e 2074 6865 0a20 2020  ter than the.   
+00005360: 2020 2020 2020 2020 7570 6461 7465 6420          updated 
+00005370: 7370 696c 6c65 6420 706f 7274 696f 6e0a  spilled portion.
+00005380: 2020 2020 2020 2020 332e 2054 6869 7320          3. This 
+00005390: 6361 7573 6573 2074 6865 206d 616e 6167  causes the manag
+000053a0: 6564 206d 656d 6f72 7920 746f 2074 656d  ed memory to tem
+000053b0: 706f 7261 7269 6c79 2070 6c75 6d6d 6574  porarily plummet
+000053c0: 2061 6e64 2062 6520 7265 706c 6163 6564   and be replaced
+000053d0: 2062 790a 2020 2020 2020 2020 2020 2075   by.           u
+000053e0: 6e6d 616e 6167 6564 5f72 6563 656e 742c  nmanaged_recent,
+000053f0: 2077 6869 6c65 2073 7069 6c6c 6564 206d   while spilled m
+00005400: 656d 6f72 7920 7265 6d61 696e 7320 756e  emory remains un
+00005410: 616c 7465 7265 640a 2020 2020 2020 2020  altered.        
+00005420: 342e 2057 6865 6e20 7468 6520 6865 6172  4. When the hear
+00005430: 7462 6561 7420 6172 7269 7665 732c 206d  tbeat arrives, m
+00005440: 616e 6167 6564 2067 6f65 7320 6261 636b  anaged goes back
+00005450: 2075 702c 2075 6e6d 616e 6167 6564 5f72   up, unmanaged_r
+00005460: 6563 656e 740a 2020 2020 2020 2020 2020  ecent.          
+00005470: 2067 6f65 7320 6261 636b 2064 6f77 6e2c   goes back down,
+00005480: 2061 6e64 2073 7069 6c6c 6564 2067 6f65   and spilled goe
+00005490: 7320 646f 776e 2062 7920 3130 304d 4220  s down by 100MB 
+000054a0: 6173 2069 7420 7368 6f75 6c64 2068 6176  as it should hav
+000054b0: 6520 746f 0a20 2020 2020 2020 2020 2020  e to.           
+000054c0: 6265 6769 6e20 7769 7468 2e0a 0a20 2020  begin with...   
+000054d0: 2020 2020 203a 6973 7375 653a 6036 3030       :issue:`600
+000054e0: 3260 2077 696c 6c20 6c65 7420 7573 2073  2` will let us s
+000054f0: 6f6c 7665 2074 6869 732e 0a20 2020 2020  olve this..     
+00005500: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
+00005510: 6574 7572 6e20 4d65 6d6f 7279 5374 6174  eturn MemoryStat
+00005520: 6528 0a20 2020 2020 2020 2020 2020 2070  e(.            p
+00005530: 726f 6365 7373 3d73 656c 662e 6d65 7472  rocess=self.metr
+00005540: 6963 735b 226d 656d 6f72 7922 5d2c 0a20  ics["memory"],. 
+00005550: 2020 2020 2020 2020 2020 206d 616e 6167             manag
+00005560: 6564 3d6d 6178 2830 2c20 7365 6c66 2e6e  ed=max(0, self.n
+00005570: 6279 7465 7320 2d20 7365 6c66 2e6d 6574  bytes - self.met
+00005580: 7269 6373 5b22 7370 696c 6c65 645f 6279  rics["spilled_by
+00005590: 7465 7322 5d5b 226d 656d 6f72 7922 5d29  tes"]["memory"])
+000055a0: 2c0a 2020 2020 2020 2020 2020 2020 7370  ,.            sp
+000055b0: 696c 6c65 643d 7365 6c66 2e6d 6574 7269  illed=self.metri
+000055c0: 6373 5b22 7370 696c 6c65 645f 6279 7465  cs["spilled_byte
+000055d0: 7322 5d5b 2264 6973 6b22 5d2c 0a20 2020  s"]["disk"],.   
+000055e0: 2020 2020 2020 2020 2075 6e6d 616e 6167           unmanag
+000055f0: 6564 5f6f 6c64 3d73 656c 662e 5f6d 656d  ed_old=self._mem
+00005600: 6f72 795f 756e 6d61 6e61 6765 645f 6f6c  ory_unmanaged_ol
+00005610: 642c 0a20 2020 2020 2020 2029 0a0a 2020  d,.        )..  
+00005620: 2020 6465 6620 636c 6561 6e28 7365 6c66    def clean(self
+00005630: 2920 2d3e 2057 6f72 6b65 7253 7461 7465  ) -> WorkerState
+00005640: 3a0a 2020 2020 2020 2020 2222 2252 6574  :.        """Ret
+00005650: 7572 6e20 6120 7665 7273 696f 6e20 6f66  urn a version of
+00005660: 2074 6869 7320 6f62 6a65 6374 2074 6861   this object tha
+00005670: 7420 6973 2061 7070 726f 7072 6961 7465  t is appropriate
+00005680: 2066 6f72 2073 6572 6961 6c69 7a61 7469   for serializati
+00005690: 6f6e 2222 220a 2020 2020 2020 2020 7773  on""".        ws
+000056a0: 203d 2057 6f72 6b65 7253 7461 7465 280a   = WorkerState(.
+000056b0: 2020 2020 2020 2020 2020 2020 6164 6472              addr
+000056c0: 6573 733d 7365 6c66 2e61 6464 7265 7373  ess=self.address
+000056d0: 2c0a 2020 2020 2020 2020 2020 2020 7374  ,.            st
+000056e0: 6174 7573 3d73 656c 662e 7374 6174 7573  atus=self.status
+000056f0: 2c0a 2020 2020 2020 2020 2020 2020 7069  ,.            pi
+00005700: 643d 7365 6c66 2e70 6964 2c0a 2020 2020  d=self.pid,.    
+00005710: 2020 2020 2020 2020 6e61 6d65 3d73 656c          name=sel
+00005720: 662e 6e61 6d65 2c0a 2020 2020 2020 2020  f.name,.        
+00005730: 2020 2020 6e74 6872 6561 6473 3d73 656c      nthreads=sel
+00005740: 662e 6e74 6872 6561 6473 2c0a 2020 2020  f.nthreads,.    
+00005750: 2020 2020 2020 2020 6d65 6d6f 7279 5f6c          memory_l
+00005760: 696d 6974 3d73 656c 662e 6d65 6d6f 7279  imit=self.memory
+00005770: 5f6c 696d 6974 2c0a 2020 2020 2020 2020  _limit,.        
+00005780: 2020 2020 6c6f 6361 6c5f 6469 7265 6374      local_direct
+00005790: 6f72 793d 7365 6c66 2e6c 6f63 616c 5f64  ory=self.local_d
+000057a0: 6972 6563 746f 7279 2c0a 2020 2020 2020  irectory,.      
+000057b0: 2020 2020 2020 7365 7276 6963 6573 3d73        services=s
+000057c0: 656c 662e 7365 7276 6963 6573 2c0a 2020  elf.services,.  
+000057d0: 2020 2020 2020 2020 2020 6e61 6e6e 793d            nanny=
+000057e0: 7365 6c66 2e6e 616e 6e79 2c0a 2020 2020  self.nanny,.    
+000057f0: 2020 2020 2020 2020 6578 7472 613d 7365          extra=se
+00005800: 6c66 2e65 7874 7261 2c0a 2020 2020 2020  lf.extra,.      
+00005810: 2020 2020 2020 7365 7276 6572 5f69 643d        server_id=
+00005820: 7365 6c66 2e73 6572 7665 725f 6964 2c0a  self.server_id,.
+00005830: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00005840: 2020 7773 2e5f 6f63 6375 7061 6e63 795f    ws._occupancy_
+00005850: 6361 6368 6520 3d20 7365 6c66 2e6f 6363  cache = self.occ
+00005860: 7570 616e 6379 0a0a 2020 2020 2020 2020  upancy..        
+00005870: 7773 2e65 7865 6375 7469 6e67 203d 207b  ws.executing = {
+00005880: 0a20 2020 2020 2020 2020 2020 2074 732e  .            ts.
+00005890: 6b65 793a 2064 7572 6174 696f 6e20 666f  key: duration fo
+000058a0: 7220 7473 2c20 6475 7261 7469 6f6e 2069  r ts, duration i
+000058b0: 6e20 7365 6c66 2e65 7865 6375 7469 6e67  n self.executing
+000058c0: 2e69 7465 6d73 2829 2020 2320 7479 7065  .items()  # type
+000058d0: 3a20 6967 6e6f 7265 0a20 2020 2020 2020  : ignore.       
+000058e0: 207d 0a20 2020 2020 2020 2072 6574 7572   }.        retur
+000058f0: 6e20 7773 0a0a 2020 2020 6465 6620 5f5f  n ws..    def __
+00005900: 7265 7072 5f5f 2873 656c 6629 202d 3e20  repr__(self) -> 
+00005910: 7374 723a 0a20 2020 2020 2020 206e 616d  str:.        nam
+00005920: 6520 3d20 6622 2c20 6e61 6d65 3a20 7b73  e = f", name: {s
+00005930: 656c 662e 6e61 6d65 7d22 2069 6620 7365  elf.name}" if se
+00005940: 6c66 2e6e 616d 6520 213d 2073 656c 662e  lf.name != self.
+00005950: 6164 6472 6573 7320 656c 7365 2022 220a  address else "".
+00005960: 2020 2020 2020 2020 7265 7475 726e 2028          return (
+00005970: 0a20 2020 2020 2020 2020 2020 2066 223c  .            f"<
+00005980: 576f 726b 6572 5374 6174 6520 7b73 656c  WorkerState {sel
+00005990: 662e 6164 6472 6573 7321 727d 7b6e 616d  f.address!r}{nam
+000059a0: 657d 2c20 220a 2020 2020 2020 2020 2020  e}, ".          
+000059b0: 2020 6622 7374 6174 7573 3a20 7b73 656c    f"status: {sel
+000059c0: 662e 7374 6174 7573 2e6e 616d 657d 2c20  f.status.name}, 
+000059d0: 220a 2020 2020 2020 2020 2020 2020 6622  ".            f"
+000059e0: 6d65 6d6f 7279 3a20 7b6c 656e 2873 656c  memory: {len(sel
+000059f0: 662e 6861 735f 7768 6174 297d 2c20 220a  f.has_what)}, ".
+00005a00: 2020 2020 2020 2020 2020 2020 6622 7072              f"pr
+00005a10: 6f63 6573 7369 6e67 3a20 7b6c 656e 2873  ocessing: {len(s
+00005a20: 656c 662e 7072 6f63 6573 7369 6e67 297d  elf.processing)}
+00005a30: 3e22 0a20 2020 2020 2020 2029 0a0a 2020  >".        )..  
+00005a40: 2020 6465 6620 5f72 6570 725f 6874 6d6c    def _repr_html
+00005a50: 5f28 7365 6c66 2920 2d3e 2073 7472 3a0a  _(self) -> str:.
+00005a60: 2020 2020 2020 2020 7265 7475 726e 2067          return g
+00005a70: 6574 5f74 656d 706c 6174 6528 2277 6f72  et_template("wor
+00005a80: 6b65 725f 7374 6174 652e 6874 6d6c 2e6a  ker_state.html.j
+00005a90: 3222 292e 7265 6e64 6572 280a 2020 2020  2").render(.    
+00005aa0: 2020 2020 2020 2020 6164 6472 6573 733d          address=
+00005ab0: 7365 6c66 2e61 6464 7265 7373 2c0a 2020  self.address,.  
+00005ac0: 2020 2020 2020 2020 2020 6e61 6d65 3d73            name=s
+00005ad0: 656c 662e 6e61 6d65 2c0a 2020 2020 2020  elf.name,.      
+00005ae0: 2020 2020 2020 7374 6174 7573 3d73 656c        status=sel
+00005af0: 662e 7374 6174 7573 2e6e 616d 652c 0a20  f.status.name,. 
+00005b00: 2020 2020 2020 2020 2020 2068 6173 5f77             has_w
+00005b10: 6861 743d 7365 6c66 2e68 6173 5f77 6861  hat=self.has_wha
+00005b20: 742c 0a20 2020 2020 2020 2020 2020 2070  t,.            p
+00005b30: 726f 6365 7373 696e 673d 7365 6c66 2e70  rocessing=self.p
+00005b40: 726f 6365 7373 696e 672c 0a20 2020 2020  rocessing,.     
+00005b50: 2020 2029 0a0a 2020 2020 6465 6620 6964     )..    def id
+00005b60: 656e 7469 7479 2873 656c 6629 202d 3e20  entity(self) -> 
+00005b70: 6469 6374 5b73 7472 2c20 416e 795d 3a0a  dict[str, Any]:.
+00005b80: 2020 2020 2020 2020 7265 7475 726e 207b          return {
+00005b90: 0a20 2020 2020 2020 2020 2020 2022 7479  .            "ty
+00005ba0: 7065 223a 2022 576f 726b 6572 222c 0a20  pe": "Worker",. 
+00005bb0: 2020 2020 2020 2020 2020 2022 6964 223a             "id":
+00005bc0: 2073 656c 662e 6e61 6d65 2c0a 2020 2020   self.name,.    
+00005bd0: 2020 2020 2020 2020 2268 6f73 7422 3a20          "host": 
+00005be0: 7365 6c66 2e68 6f73 742c 0a20 2020 2020  self.host,.     
+00005bf0: 2020 2020 2020 2022 7265 736f 7572 6365         "resource
+00005c00: 7322 3a20 7365 6c66 2e72 6573 6f75 7263  s": self.resourc
+00005c10: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
+00005c20: 226c 6f63 616c 5f64 6972 6563 746f 7279  "local_directory
+00005c30: 223a 2073 656c 662e 6c6f 6361 6c5f 6469  ": self.local_di
+00005c40: 7265 6374 6f72 792c 0a20 2020 2020 2020  rectory,.       
+00005c50: 2020 2020 2022 6e61 6d65 223a 2073 656c       "name": sel
+00005c60: 662e 6e61 6d65 2c0a 2020 2020 2020 2020  f.name,.        
+00005c70: 2020 2020 226e 7468 7265 6164 7322 3a20      "nthreads": 
+00005c80: 7365 6c66 2e6e 7468 7265 6164 732c 0a20  self.nthreads,. 
+00005c90: 2020 2020 2020 2020 2020 2022 6d65 6d6f             "memo
+00005ca0: 7279 5f6c 696d 6974 223a 2073 656c 662e  ry_limit": self.
+00005cb0: 6d65 6d6f 7279 5f6c 696d 6974 2c0a 2020  memory_limit,.  
+00005cc0: 2020 2020 2020 2020 2020 226c 6173 745f            "last_
+00005cd0: 7365 656e 223a 2073 656c 662e 6c61 7374  seen": self.last
+00005ce0: 5f73 6565 6e2c 0a20 2020 2020 2020 2020  _seen,.         
+00005cf0: 2020 2022 7365 7276 6963 6573 223a 2073     "services": s
+00005d00: 656c 662e 7365 7276 6963 6573 2c0a 2020  elf.services,.  
+00005d10: 2020 2020 2020 2020 2020 226d 6574 7269            "metri
+00005d20: 6373 223a 2073 656c 662e 6d65 7472 6963  cs": self.metric
+00005d30: 732c 0a20 2020 2020 2020 2020 2020 2022  s,.            "
+00005d40: 7374 6174 7573 223a 2073 656c 662e 7374  status": self.st
+00005d50: 6174 7573 2e6e 616d 652c 0a20 2020 2020  atus.name,.     
+00005d60: 2020 2020 2020 2022 6e61 6e6e 7922 3a20         "nanny": 
+00005d70: 7365 6c66 2e6e 616e 6e79 2c0a 2020 2020  self.nanny,.    
+00005d80: 2020 2020 2020 2020 2a2a 7365 6c66 2e65          **self.e
+00005d90: 7874 7261 2c0a 2020 2020 2020 2020 7d0a  xtra,.        }.
+00005da0: 0a20 2020 2064 6566 205f 746f 5f64 6963  .    def _to_dic
+00005db0: 745f 6e6f 5f6e 6573 7428 7365 6c66 2c20  t_no_nest(self, 
+00005dc0: 2a2c 2065 7863 6c75 6465 3a20 436f 6e74  *, exclude: Cont
+00005dd0: 6169 6e65 725b 7374 725d 203d 2028 2929  ainer[str] = ())
+00005de0: 202d 3e20 6469 6374 5b73 7472 2c20 416e   -> dict[str, An
+00005df0: 795d 3a0a 2020 2020 2020 2020 2222 2244  y]:.        """D
+00005e00: 6963 7469 6f6e 6172 7920 7265 7072 6573  ictionary repres
+00005e10: 656e 7461 7469 6f6e 2066 6f72 2064 6562  entation for deb
+00005e20: 7567 6769 6e67 2070 7572 706f 7365 732e  ugging purposes.
+00005e30: 0a20 2020 2020 2020 204e 6f74 2074 7970  .        Not typ
+00005e40: 6520 7374 6162 6c65 2061 6e64 206e 6f74  e stable and not
+00005e50: 2069 6e74 656e 6465 6420 666f 7220 726f   intended for ro
+00005e60: 756e 6474 7269 7073 2e0a 0a20 2020 2020  undtrips...     
+00005e70: 2020 2053 6565 2061 6c73 6f0a 2020 2020     See also.    
+00005e80: 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020      --------.   
+00005e90: 2020 2020 2043 6c69 656e 742e 6475 6d70       Client.dump
+00005ea0: 5f63 6c75 7374 6572 5f73 7461 7465 0a20  _cluster_state. 
+00005eb0: 2020 2020 2020 2064 6973 7472 6962 7574         distribut
+00005ec0: 6564 2e75 7469 6c73 2e72 6563 7572 7369  ed.utils.recursi
+00005ed0: 7665 5f74 6f5f 6469 6374 0a20 2020 2020  ve_to_dict.     
+00005ee0: 2020 2054 6173 6b53 7461 7465 2e5f 746f     TaskState._to
+00005ef0: 5f64 6963 740a 2020 2020 2020 2020 2222  _dict.        ""
+00005f00: 220a 2020 2020 2020 2020 7265 7475 726e  ".        return
+00005f10: 2072 6563 7572 7369 7665 5f74 6f5f 6469   recursive_to_di
+00005f20: 6374 280a 2020 2020 2020 2020 2020 2020  ct(.            
+00005f30: 7365 6c66 2c0a 2020 2020 2020 2020 2020  self,.          
+00005f40: 2020 6578 636c 7564 653d 7365 7428 6578    exclude=set(ex
+00005f50: 636c 7564 6529 207c 207b 2276 6572 7369  clude) | {"versi
+00005f60: 6f6e 7322 7d2c 2020 2320 7479 7065 3a20  ons"},  # type: 
+00005f70: 6967 6e6f 7265 0a20 2020 2020 2020 2020  ignore.         
+00005f80: 2020 206d 656d 6265 7273 3d54 7275 652c     members=True,
+00005f90: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+00005fa0: 4070 726f 7065 7274 790a 2020 2020 6465  @property.    de
+00005fb0: 6620 7363 6865 6475 6c65 7228 7365 6c66  f scheduler(self
+00005fc0: 2920 2d3e 2053 6368 6564 756c 6572 5374  ) -> SchedulerSt
+00005fd0: 6174 653a 0a20 2020 2020 2020 2061 7373  ate:.        ass
+00005fe0: 6572 7420 7365 6c66 2e73 6368 6564 756c  ert self.schedul
+00005ff0: 6572 5f72 6566 0a20 2020 2020 2020 2073  er_ref.        s
+00006000: 203d 2073 656c 662e 7363 6865 6475 6c65   = self.schedule
+00006010: 725f 7265 6628 290a 2020 2020 2020 2020  r_ref().        
+00006020: 6173 7365 7274 2073 0a20 2020 2020 2020  assert s.       
+00006030: 2072 6574 7572 6e20 730a 0a20 2020 2064   return s..    d
+00006040: 6566 2061 6464 5f74 6f5f 7072 6f63 6573  ef add_to_proces
+00006050: 7369 6e67 2873 656c 662c 2074 733a 2054  sing(self, ts: T
+00006060: 6173 6b53 7461 7465 2920 2d3e 204e 6f6e  askState) -> Non
+00006070: 653a 0a20 2020 2020 2020 2022 2222 4173  e:.        """As
+00006080: 7369 676e 2061 2074 6173 6b20 746f 2074  sign a task to t
+00006090: 6869 7320 776f 726b 6572 2066 6f72 2063  his worker for c
+000060a0: 6f6d 7075 7465 2e22 2222 0a20 2020 2020  ompute.""".     
+000060b0: 2020 2069 6620 7365 6c66 2e73 6368 6564     if self.sched
+000060c0: 756c 6572 2e76 616c 6964 6174 653a 0a20  uler.validate:. 
+000060d0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+000060e0: 7420 7473 206e 6f74 2069 6e20 7365 6c66  t ts not in self
+000060f0: 2e70 726f 6365 7373 696e 670a 0a20 2020  .processing..   
+00006100: 2020 2020 2074 7020 3d20 7473 2e70 7265       tp = ts.pre
+00006110: 6669 780a 2020 2020 2020 2020 7365 6c66  fix.        self
+00006120: 2e74 6173 6b5f 7072 6566 6978 5f63 6f75  .task_prefix_cou
+00006130: 6e74 5b74 702e 6e61 6d65 5d20 2b3d 2031  nt[tp.name] += 1
+00006140: 0a20 2020 2020 2020 2073 656c 662e 7363  .        self.sc
+00006150: 6865 6475 6c65 722e 5f74 6173 6b5f 7072  heduler._task_pr
+00006160: 6566 6978 5f63 6f75 6e74 5f67 6c6f 6261  efix_count_globa
+00006170: 6c5b 7470 2e6e 616d 655d 202b 3d20 310a  l[tp.name] += 1.
+00006180: 2020 2020 2020 2020 7365 6c66 2e70 726f          self.pro
+00006190: 6365 7373 696e 672e 6164 6428 7473 290a  cessing.add(ts).
+000061a0: 2020 2020 2020 2020 666f 7220 6474 7320          for dts 
+000061b0: 696e 2074 732e 6465 7065 6e64 656e 6369  in ts.dependenci
+000061c0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+000061d0: 6173 7365 7274 2064 7473 2e77 686f 5f68  assert dts.who_h
+000061e0: 6173 0a20 2020 2020 2020 2020 2020 2069  as.            i
+000061f0: 6620 7365 6c66 206e 6f74 2069 6e20 6474  f self not in dt
+00006200: 732e 7768 6f5f 6861 733a 0a20 2020 2020  s.who_has:.     
+00006210: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00006220: 5f69 6e63 5f6e 6565 6473 5f72 6570 6c69  _inc_needs_repli
+00006230: 6361 2864 7473 290a 0a20 2020 2064 6566  ca(dts)..    def
+00006240: 2061 6464 5f74 6f5f 6c6f 6e67 5f72 756e   add_to_long_run
+00006250: 6e69 6e67 2873 656c 662c 2074 733a 2054  ning(self, ts: T
+00006260: 6173 6b53 7461 7465 2920 2d3e 204e 6f6e  askState) -> Non
+00006270: 653a 0a20 2020 2020 2020 2069 6620 7365  e:.        if se
+00006280: 6c66 2e73 6368 6564 756c 6572 2e76 616c  lf.scheduler.val
+00006290: 6964 6174 653a 0a20 2020 2020 2020 2020  idate:.         
+000062a0: 2020 2061 7373 6572 7420 7473 2069 6e20     assert ts in 
+000062b0: 7365 6c66 2e70 726f 6365 7373 696e 670a  self.processing.
+000062c0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+000062d0: 7274 2074 7320 6e6f 7420 696e 2073 656c  rt ts not in sel
+000062e0: 662e 6c6f 6e67 5f72 756e 6e69 6e67 0a0a  f.long_running..
+000062f0: 2020 2020 2020 2020 7365 6c66 2e5f 7265          self._re
+00006300: 6d6f 7665 5f66 726f 6d5f 7461 736b 5f70  move_from_task_p
+00006310: 7265 6669 785f 636f 756e 7428 7473 290a  refix_count(ts).
+00006320: 2020 2020 2020 2020 2320 4361 6e6e 6f74          # Cannot
+00006330: 2072 656d 6f76 6520 6672 6f6d 2070 726f   remove from pro
+00006340: 6365 7373 696e 6720 7369 6e63 6520 7765  cessing since we
+00006350: 2772 6520 7573 696e 6720 7468 6973 2066  're using this f
+00006360: 6f72 2074 6869 6e67 7320 6c69 6b65 0a20  or things like. 
+00006370: 2020 2020 2020 2023 2069 646c 656e 6573         # idlenes
+00006380: 7320 6465 7465 6374 696f 6e2e 2049 646c  s detection. Idl
+00006390: 6520 776f 726b 6572 7320 6172 6520 7479  e workers are ty
+000063a0: 7069 6361 6c6c 7920 7461 7267 6574 6564  pically targeted
+000063b0: 2066 6f72 0a20 2020 2020 2020 2023 2064   for.        # d
+000063c0: 6f77 6e73 6361 6c69 6e67 2062 7574 2077  ownscaling but w
+000063d0: 6520 7368 6f75 6c64 206e 6f74 2064 6f77  e should not dow
+000063e0: 6e73 6361 6c65 2077 6f72 6b65 7273 2077  nscale workers w
+000063f0: 6974 6820 6c6f 6e67 2072 756e 6e69 6e67  ith long running
+00006400: 0a20 2020 2020 2020 2023 2074 6173 6b73  .        # tasks
+00006410: 0a20 2020 2020 2020 2073 656c 662e 6c6f  .        self.lo
+00006420: 6e67 5f72 756e 6e69 6e67 2e61 6464 2874  ng_running.add(t
+00006430: 7329 0a0a 2020 2020 6465 6620 7265 6d6f  s)..    def remo
+00006440: 7665 5f66 726f 6d5f 7072 6f63 6573 7369  ve_from_processi
+00006450: 6e67 2873 656c 662c 2074 733a 2054 6173  ng(self, ts: Tas
+00006460: 6b53 7461 7465 2920 2d3e 204e 6f6e 653a  kState) -> None:
+00006470: 0a20 2020 2020 2020 2022 2222 5265 6d6f  .        """Remo
+00006480: 7665 2061 2074 6173 6b20 6672 6f6d 2061  ve a task from a
+00006490: 2077 6f72 6b65 7273 2070 726f 6365 7373   workers process
+000064a0: 696e 6722 2222 0a20 2020 2020 2020 2069  ing""".        i
+000064b0: 6620 7365 6c66 2e73 6368 6564 756c 6572  f self.scheduler
+000064c0: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
+000064d0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
+000064e0: 2069 6e20 7365 6c66 2e70 726f 6365 7373   in self.process
+000064f0: 696e 670a 0a20 2020 2020 2020 2069 6620  ing..        if 
+00006500: 7473 2069 6e20 7365 6c66 2e6c 6f6e 675f  ts in self.long_
+00006510: 7275 6e6e 696e 673a 0a20 2020 2020 2020  running:.       
+00006520: 2020 2020 2073 656c 662e 6c6f 6e67 5f72       self.long_r
+00006530: 756e 6e69 6e67 2e64 6973 6361 7264 2874  unning.discard(t
+00006540: 7329 0a20 2020 2020 2020 2065 6c73 653a  s).        else:
+00006550: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00006560: 662e 5f72 656d 6f76 655f 6672 6f6d 5f74  f._remove_from_t
+00006570: 6173 6b5f 7072 6566 6978 5f63 6f75 6e74  ask_prefix_count
+00006580: 2874 7329 0a20 2020 2020 2020 2073 656c  (ts).        sel
+00006590: 662e 7072 6f63 6573 7369 6e67 2e72 656d  f.processing.rem
+000065a0: 6f76 6528 7473 290a 2020 2020 2020 2020  ove(ts).        
+000065b0: 666f 7220 6474 7320 696e 2074 732e 6465  for dts in ts.de
+000065c0: 7065 6e64 656e 6369 6573 3a0a 2020 2020  pendencies:.    
+000065d0: 2020 2020 2020 2020 6966 2064 7473 2069          if dts i
+000065e0: 6e20 7365 6c66 2e6e 6565 6473 5f77 6861  n self.needs_wha
+000065f0: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+00006600: 2020 2073 656c 662e 5f64 6563 5f6e 6565     self._dec_nee
+00006610: 6473 5f72 6570 6c69 6361 2864 7473 290a  ds_replica(dts).
+00006620: 0a20 2020 2064 6566 205f 7265 6d6f 7665  .    def _remove
+00006630: 5f66 726f 6d5f 7461 736b 5f70 7265 6669  _from_task_prefi
+00006640: 785f 636f 756e 7428 7365 6c66 2c20 7473  x_count(self, ts
+00006650: 3a20 5461 736b 5374 6174 6529 202d 3e20  : TaskState) -> 
+00006660: 4e6f 6e65 3a0a 2020 2020 2020 2020 636f  None:.        co
+00006670: 756e 7420 3d20 7365 6c66 2e74 6173 6b5f  unt = self.task_
+00006680: 7072 6566 6978 5f63 6f75 6e74 5b74 732e  prefix_count[ts.
+00006690: 7072 6566 6978 2e6e 616d 655d 202d 2031  prefix.name] - 1
+000066a0: 0a20 2020 2020 2020 2069 6620 636f 756e  .        if coun
+000066b0: 743a 0a20 2020 2020 2020 2020 2020 2073  t:.            s
+000066c0: 656c 662e 7461 736b 5f70 7265 6669 785f  elf.task_prefix_
+000066d0: 636f 756e 745b 7473 2e70 7265 6669 782e  count[ts.prefix.
+000066e0: 6e61 6d65 5d20 3d20 636f 756e 740a 2020  name] = count.  
+000066f0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00006700: 2020 2020 2020 2020 6465 6c20 7365 6c66          del self
+00006710: 2e74 6173 6b5f 7072 6566 6978 5f63 6f75  .task_prefix_cou
+00006720: 6e74 5b74 732e 7072 6566 6978 2e6e 616d  nt[ts.prefix.nam
+00006730: 655d 0a0a 2020 2020 2020 2020 636f 756e  e]..        coun
+00006740: 7420 3d20 7365 6c66 2e73 6368 6564 756c  t = self.schedul
+00006750: 6572 2e5f 7461 736b 5f70 7265 6669 785f  er._task_prefix_
+00006760: 636f 756e 745f 676c 6f62 616c 5b74 732e  count_global[ts.
+00006770: 7072 6566 6978 2e6e 616d 655d 202d 2031  prefix.name] - 1
+00006780: 0a20 2020 2020 2020 2069 6620 636f 756e  .        if coun
+00006790: 743a 0a20 2020 2020 2020 2020 2020 2073  t:.            s
+000067a0: 656c 662e 7363 6865 6475 6c65 722e 5f74  elf.scheduler._t
+000067b0: 6173 6b5f 7072 6566 6978 5f63 6f75 6e74  ask_prefix_count
+000067c0: 5f67 6c6f 6261 6c5b 7473 2e70 7265 6669  _global[ts.prefi
+000067d0: 782e 6e61 6d65 5d20 3d20 636f 756e 740a  x.name] = count.
+000067e0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+000067f0: 2020 2020 2020 2020 2020 6465 6c20 7365            del se
+00006800: 6c66 2e73 6368 6564 756c 6572 2e5f 7461  lf.scheduler._ta
+00006810: 736b 5f70 7265 6669 785f 636f 756e 745f  sk_prefix_count_
+00006820: 676c 6f62 616c 5b74 732e 7072 6566 6978  global[ts.prefix
+00006830: 2e6e 616d 655d 0a0a 2020 2020 6465 6620  .name]..    def 
+00006840: 7265 6d6f 7665 5f72 6570 6c69 6361 2873  remove_replica(s
+00006850: 656c 662c 2074 733a 2054 6173 6b53 7461  elf, ts: TaskSta
+00006860: 7465 2920 2d3e 204e 6f6e 653a 0a20 2020  te) -> None:.   
+00006870: 2020 2020 2022 2222 5468 6520 776f 726b       """The work
+00006880: 6572 206e 6f20 6c6f 6e67 6572 2068 6173  er no longer has
+00006890: 2061 2074 6173 6b20 696e 206d 656d 6f72   a task in memor
+000068a0: 7922 2222 0a20 2020 2020 2020 2069 6620  y""".        if 
+000068b0: 7365 6c66 2e73 6368 6564 756c 6572 2e76  self.scheduler.v
+000068c0: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
+000068d0: 2020 2020 2061 7373 6572 7420 7473 2e77       assert ts.w
+000068e0: 686f 5f68 6173 0a20 2020 2020 2020 2020  ho_has.         
+000068f0: 2020 2061 7373 6572 7420 7365 6c66 2069     assert self i
+00006900: 6e20 7473 2e77 686f 5f68 6173 0a20 2020  n ts.who_has.   
+00006910: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00006920: 7473 2069 6e20 7365 6c66 2e68 6173 5f77  ts in self.has_w
+00006930: 6861 740a 2020 2020 2020 2020 2020 2020  hat.            
+00006940: 6173 7365 7274 2074 7320 6e6f 7420 696e  assert ts not in
+00006950: 2073 656c 662e 6e65 6564 735f 7768 6174   self.needs_what
+00006960: 0a0a 2020 2020 2020 2020 7365 6c66 2e6e  ..        self.n
+00006970: 6279 7465 7320 2d3d 2074 732e 6765 745f  bytes -= ts.get_
+00006980: 6e62 7974 6573 2829 0a20 2020 2020 2020  nbytes().       
+00006990: 2064 656c 2073 656c 662e 5f68 6173 5f77   del self._has_w
+000069a0: 6861 745b 7473 5d0a 2020 2020 2020 2020  hat[ts].        
+000069b0: 7473 2e77 686f 5f68 6173 2e72 656d 6f76  ts.who_has.remov
+000069c0: 6528 7365 6c66 2920 2023 2074 7970 653a  e(self)  # type:
+000069d0: 2069 676e 6f72 650a 2020 2020 2020 2020   ignore.        
+000069e0: 6966 206e 6f74 2074 732e 7768 6f5f 6861  if not ts.who_ha
+000069f0: 733a 0a20 2020 2020 2020 2020 2020 2074  s:.            t
+00006a00: 732e 7768 6f5f 6861 7320 3d20 4e6f 6e65  s.who_has = None
+00006a10: 0a0a 2020 2020 6465 6620 5f69 6e63 5f6e  ..    def _inc_n
+00006a20: 6565 6473 5f72 6570 6c69 6361 2873 656c  eeds_replica(sel
+00006a30: 662c 2074 733a 2054 6173 6b53 7461 7465  f, ts: TaskState
+00006a40: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00006a50: 2020 2022 2222 4173 7369 676e 2061 2074     """Assign a t
+00006a60: 6173 6b20 6665 7463 6820 746f 2074 6869  ask fetch to thi
+00006a70: 7320 776f 726b 6572 2061 6e64 2075 7064  s worker and upd
+00006a80: 6174 6520 6e65 7477 6f72 6b20 6f63 6375  ate network occu
+00006a90: 7061 6e63 6965 7322 2222 0a20 2020 2020  pancies""".     
+00006aa0: 2020 2069 6620 7365 6c66 2e73 6368 6564     if self.sched
+00006ab0: 756c 6572 2e76 616c 6964 6174 653a 0a20  uler.validate:. 
+00006ac0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00006ad0: 7420 7473 2e77 686f 5f68 6173 0a20 2020  t ts.who_has.   
+00006ae0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00006af0: 7365 6c66 206e 6f74 2069 6e20 7473 2e77  self not in ts.w
+00006b00: 686f 5f68 6173 0a20 2020 2020 2020 2020  ho_has.         
+00006b10: 2020 2061 7373 6572 7420 7473 206e 6f74     assert ts not
+00006b20: 2069 6e20 7365 6c66 2e68 6173 5f77 6861   in self.has_wha
+00006b30: 740a 2020 2020 2020 2020 6966 2074 7320  t.        if ts 
+00006b40: 6e6f 7420 696e 2073 656c 662e 6e65 6564  not in self.need
+00006b50: 735f 7768 6174 3a0a 2020 2020 2020 2020  s_what:.        
+00006b60: 2020 2020 7365 6c66 2e6e 6565 6473 5f77      self.needs_w
+00006b70: 6861 745b 7473 5d20 3d20 310a 2020 2020  hat[ts] = 1.    
+00006b80: 2020 2020 2020 2020 6e62 7974 6573 203d          nbytes =
+00006b90: 2074 732e 6765 745f 6e62 7974 6573 2829   ts.get_nbytes()
+00006ba0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00006bb0: 662e 5f6e 6574 776f 726b 5f6f 6363 202b  f._network_occ +
+00006bc0: 3d20 6e62 7974 6573 0a20 2020 2020 2020  = nbytes.       
+00006bd0: 2020 2020 2073 656c 662e 7363 6865 6475       self.schedu
+00006be0: 6c65 722e 5f6e 6574 776f 726b 5f6f 6363  ler._network_occ
+00006bf0: 5f67 6c6f 6261 6c20 2b3d 206e 6279 7465  _global += nbyte
+00006c00: 730a 2020 2020 2020 2020 656c 7365 3a0a  s.        else:.
+00006c10: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00006c20: 2e6e 6565 6473 5f77 6861 745b 7473 5d20  .needs_what[ts] 
+00006c30: 2b3d 2031 0a0a 2020 2020 6465 6620 5f64  += 1..    def _d
+00006c40: 6563 5f6e 6565 6473 5f72 6570 6c69 6361  ec_needs_replica
+00006c50: 2873 656c 662c 2074 733a 2054 6173 6b53  (self, ts: TaskS
+00006c60: 7461 7465 2920 2d3e 204e 6f6e 653a 0a20  tate) -> None:. 
+00006c70: 2020 2020 2020 2069 6620 7365 6c66 2e73         if self.s
+00006c80: 6368 6564 756c 6572 2e76 616c 6964 6174  cheduler.validat
+00006c90: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
+00006ca0: 7373 6572 7420 7473 2069 6e20 7365 6c66  ssert ts in self
+00006cb0: 2e6e 6565 6473 5f77 6861 740a 0a20 2020  .needs_what..   
+00006cc0: 2020 2020 2073 656c 662e 6e65 6564 735f       self.needs_
+00006cd0: 7768 6174 5b74 735d 202d 3d20 310a 2020  what[ts] -= 1.  
+00006ce0: 2020 2020 2020 6966 2073 656c 662e 6e65        if self.ne
+00006cf0: 6564 735f 7768 6174 5b74 735d 203d 3d20  eds_what[ts] == 
+00006d00: 303a 0a20 2020 2020 2020 2020 2020 2064  0:.            d
+00006d10: 656c 2073 656c 662e 6e65 6564 735f 7768  el self.needs_wh
+00006d20: 6174 5b74 735d 0a20 2020 2020 2020 2020  at[ts].         
+00006d30: 2020 206e 6279 7465 7320 3d20 7473 2e67     nbytes = ts.g
+00006d40: 6574 5f6e 6279 7465 7328 290a 2020 2020  et_nbytes().    
+00006d50: 2020 2020 2020 2020 7365 6c66 2e5f 6e65          self._ne
+00006d60: 7477 6f72 6b5f 6f63 6320 2d3d 206e 6279  twork_occ -= nby
+00006d70: 7465 730a 2020 2020 2020 2020 2020 2020  tes.            
+00006d80: 7365 6c66 2e73 6368 6564 756c 6572 2e5f  self.scheduler._
+00006d90: 6e65 7477 6f72 6b5f 6f63 635f 676c 6f62  network_occ_glob
+00006da0: 616c 202d 3d20 6e62 7974 6573 0a0a 2020  al -= nbytes..  
+00006db0: 2020 6465 6620 6164 645f 7265 706c 6963    def add_replic
+00006dc0: 6128 7365 6c66 2c20 7473 3a20 5461 736b  a(self, ts: Task
+00006dd0: 5374 6174 6529 202d 3e20 4e6f 6e65 3a0a  State) -> None:.
+00006de0: 2020 2020 2020 2020 2222 2254 6865 2077          """The w
+00006df0: 6f72 6b65 7220 6163 7175 6972 6564 2061  orker acquired a
+00006e00: 2072 6570 6c69 6361 206f 6620 7461 736b   replica of task
+00006e10: 2222 220a 2020 2020 2020 2020 6966 2074  """.        if t
+00006e20: 732e 7768 6f5f 6861 7320 6973 204e 6f6e  s.who_has is Non
+00006e30: 653a 0a20 2020 2020 2020 2020 2020 2074  e:.            t
+00006e40: 732e 7768 6f5f 6861 7320 3d20 7365 7428  s.who_has = set(
+00006e50: 290a 2020 2020 2020 2020 6966 2074 7320  ).        if ts 
+00006e60: 696e 2073 656c 662e 5f68 6173 5f77 6861  in self._has_wha
+00006e70: 743a 0a20 2020 2020 2020 2020 2020 2072  t:.            r
+00006e80: 6574 7572 6e0a 2020 2020 2020 2020 6e62  eturn.        nb
+00006e90: 7974 6573 203d 2074 732e 6765 745f 6e62  ytes = ts.get_nb
+00006ea0: 7974 6573 2829 0a20 2020 2020 2020 2069  ytes().        i
+00006eb0: 6620 7473 2069 6e20 7365 6c66 2e6e 6565  f ts in self.nee
+00006ec0: 6473 5f77 6861 743a 0a20 2020 2020 2020  ds_what:.       
+00006ed0: 2020 2020 2064 656c 2073 656c 662e 6e65       del self.ne
+00006ee0: 6564 735f 7768 6174 5b74 735d 0a20 2020  eds_what[ts].   
+00006ef0: 2020 2020 2020 2020 2073 656c 662e 5f6e           self._n
+00006f00: 6574 776f 726b 5f6f 6363 202d 3d20 6e62  etwork_occ -= nb
+00006f10: 7974 6573 0a20 2020 2020 2020 2020 2020  ytes.           
+00006f20: 2073 656c 662e 7363 6865 6475 6c65 722e   self.scheduler.
+00006f30: 5f6e 6574 776f 726b 5f6f 6363 5f67 6c6f  _network_occ_glo
+00006f40: 6261 6c20 2d3d 206e 6279 7465 730a 2020  bal -= nbytes.  
+00006f50: 2020 2020 2020 7473 2e77 686f 5f68 6173        ts.who_has
+00006f60: 2e61 6464 2873 656c 6629 0a20 2020 2020  .add(self).     
+00006f70: 2020 2073 656c 662e 6e62 7974 6573 202b     self.nbytes +
+00006f80: 3d20 6e62 7974 6573 0a20 2020 2020 2020  = nbytes.       
+00006f90: 2073 656c 662e 5f68 6173 5f77 6861 745b   self._has_what[
+00006fa0: 7473 5d20 3d20 4e6f 6e65 0a0a 2020 2020  ts] = None..    
+00006fb0: 4070 726f 7065 7274 790a 2020 2020 6465  @property.    de
+00006fc0: 6620 6f63 6375 7061 6e63 7928 7365 6c66  f occupancy(self
+00006fd0: 2920 2d3e 2066 6c6f 6174 3a0a 2020 2020  ) -> float:.    
+00006fe0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+00006ff0: 5f6f 6363 7570 616e 6379 5f63 6163 6865  _occupancy_cache
+00007000: 206f 7220 7365 6c66 2e73 6368 6564 756c   or self.schedul
+00007010: 6572 2e5f 6361 6c63 5f6f 6363 7570 616e  er._calc_occupan
+00007020: 6379 280a 2020 2020 2020 2020 2020 2020  cy(.            
+00007030: 7365 6c66 2e74 6173 6b5f 7072 6566 6978  self.task_prefix
+00007040: 5f63 6f75 6e74 2c20 7365 6c66 2e5f 6e65  _count, self._ne
+00007050: 7477 6f72 6b5f 6f63 630a 2020 2020 2020  twork_occ.      
+00007060: 2020 290a 0a0a 4064 6174 6163 6c61 7373    )...@dataclass
+00007070: 6573 2e64 6174 6163 6c61 7373 0a63 6c61  es.dataclass.cla
+00007080: 7373 2045 7272 6564 5461 736b 3a0a 2020  ss ErredTask:.  
+00007090: 2020 2222 224c 6967 6874 7765 6967 6874    """Lightweight
+000070a0: 2072 6570 7265 7365 6e74 6174 696f 6e20   representation 
+000070b0: 6f66 2061 6e20 6572 7265 6420 7461 736b  of an erred task
+000070c0: 2077 6974 686f 7574 2061 6e79 2064 6570   without any dep
+000070d0: 656e 6465 6e63 7920 696e 666f 726d 6174  endency informat
+000070e0: 696f 6e0a 2020 2020 6f72 2072 756e 7370  ion.    or runsp
+000070f0: 6563 2e0a 0a20 2020 2053 6565 2061 6c73  ec...    See als
+00007100: 6f0a 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20  o.    --------. 
+00007110: 2020 2054 6173 6b53 7461 7465 0a20 2020     TaskState.   
+00007120: 2022 2222 0a0a 2020 2020 6b65 793a 2048   """..    key: H
+00007130: 6173 6861 626c 650a 2020 2020 7469 6d65  ashable.    time
+00007140: 7374 616d 703a 2066 6c6f 6174 0a20 2020  stamp: float.   
+00007150: 2065 7272 6564 5f6f 6e3a 2073 6574 5b73   erred_on: set[s
+00007160: 7472 5d0a 2020 2020 6578 6365 7074 696f  tr].    exceptio
+00007170: 6e5f 7465 7874 3a20 7374 720a 2020 2020  n_text: str.    
+00007180: 7472 6163 6562 6163 6b5f 7465 7874 3a20  traceback_text: 
+00007190: 7374 720a 0a0a 636c 6173 7320 436f 6d70  str...class Comp
+000071a0: 7574 6174 696f 6e3a 0a20 2020 2022 2222  utation:.    """
+000071b0: 436f 6c6c 6563 7469 6f6e 2074 7261 636b  Collection track
+000071c0: 696e 6720 6120 7369 6e67 6c65 2063 6f6d  ing a single com
+000071d0: 7075 7465 206f 7220 7065 7273 6973 7420  pute or persist 
+000071e0: 6361 6c6c 0a0a 2020 2020 4445 5052 4543  call..    DEPREC
+000071f0: 4154 4544 3a20 706c 6561 7365 2075 7365  ATED: please use
+00007200: 2073 7061 6e73 2069 6e73 7465 6164 0a0a   spans instead..
+00007210: 2020 2020 5365 6520 616c 736f 0a20 2020      See also.   
+00007220: 202d 2d2d 2d2d 2d2d 2d0a 2020 2020 5461   --------.    Ta
+00007230: 736b 5072 6566 6978 0a20 2020 2054 6173  skPrefix.    Tas
+00007240: 6b47 726f 7570 0a20 2020 2054 6173 6b53  kGroup.    TaskS
+00007250: 7461 7465 0a20 2020 2022 2222 0a0a 2020  tate.    """..  
+00007260: 2020 7374 6172 743a 2066 6c6f 6174 0a20    start: float. 
+00007270: 2020 2067 726f 7570 733a 2073 6574 5b54     groups: set[T
+00007280: 6173 6b47 726f 7570 5d0a 2020 2020 636f  askGroup].    co
+00007290: 6465 3a20 536f 7274 6564 5365 745b 7475  de: SortedSet[tu
+000072a0: 706c 655b 536f 7572 6365 436f 6465 2c20  ple[SourceCode, 
+000072b0: 2e2e 2e5d 5d0a 2020 2020 6964 3a20 7575  ...]].    id: uu
+000072c0: 6964 2e55 5549 440a 2020 2020 616e 6e6f  id.UUID.    anno
+000072d0: 7461 7469 6f6e 733a 2064 6963 740a 0a20  tations: dict.. 
+000072e0: 2020 205f 5f73 6c6f 7473 5f5f 203d 2074     __slots__ = t
+000072f0: 7570 6c65 285f 5f61 6e6e 6f74 6174 696f  uple(__annotatio
+00007300: 6e73 5f5f 290a 0a20 2020 2064 6566 205f  ns__)..    def _
+00007310: 5f69 6e69 745f 5f28 7365 6c66 293a 0a20  _init__(self):. 
+00007320: 2020 2020 2020 2073 656c 662e 7374 6172         self.star
+00007330: 7420 3d20 7469 6d65 2829 0a20 2020 2020  t = time().     
+00007340: 2020 2073 656c 662e 6772 6f75 7073 203d     self.groups =
+00007350: 2073 6574 2829 0a20 2020 2020 2020 2073   set().        s
+00007360: 656c 662e 636f 6465 203d 2053 6f72 7465  elf.code = Sorte
+00007370: 6453 6574 2829 0a20 2020 2020 2020 2073  dSet().        s
+00007380: 656c 662e 6964 203d 2075 7569 642e 7575  elf.id = uuid.uu
+00007390: 6964 3428 290a 2020 2020 2020 2020 7365  id4().        se
+000073a0: 6c66 2e61 6e6e 6f74 6174 696f 6e73 203d  lf.annotations =
+000073b0: 207b 7d0a 0a20 2020 2040 7072 6f70 6572   {}..    @proper
+000073c0: 7479 0a20 2020 2064 6566 2073 746f 7028  ty.    def stop(
+000073d0: 7365 6c66 2920 2d3e 2066 6c6f 6174 3a0a  self) -> float:.
+000073e0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+000073f0: 6772 6f75 7073 3a0a 2020 2020 2020 2020  groups:.        
+00007400: 2020 2020 7265 7475 726e 206d 6178 2874      return max(t
+00007410: 672e 7374 6f70 2066 6f72 2074 6720 696e  g.stop for tg in
+00007420: 2073 656c 662e 6772 6f75 7073 290a 2020   self.groups).  
+00007430: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00007440: 2020 2020 2020 2020 7265 7475 726e 202d          return -
+00007450: 310a 0a20 2020 2040 7072 6f70 6572 7479  1..    @property
+00007460: 0a20 2020 2064 6566 2073 7461 7465 7328  .    def states(
+00007470: 7365 6c66 2920 2d3e 2064 6963 745b 5461  self) -> dict[Ta
+00007480: 736b 5374 6174 6553 7461 7465 2c20 696e  skStateState, in
+00007490: 745d 3a0a 2020 2020 2020 2020 7265 7475  t]:.        retu
+000074a0: 726e 206d 6572 6765 5f77 6974 6828 7375  rn merge_with(su
+000074b0: 6d2c 2028 7467 2e73 7461 7465 7320 666f  m, (tg.states fo
+000074c0: 7220 7467 2069 6e20 7365 6c66 2e67 726f  r tg in self.gro
+000074d0: 7570 7329 290a 0a20 2020 2064 6566 205f  ups))..    def _
+000074e0: 5f72 6570 725f 5f28 7365 6c66 2920 2d3e  _repr__(self) ->
+000074f0: 2073 7472 3a0a 2020 2020 2020 2020 7265   str:.        re
+00007500: 7475 726e 2028 0a20 2020 2020 2020 2020  turn (.         
+00007510: 2020 2066 223c 436f 6d70 7574 6174 696f     f"<Computatio
+00007520: 6e20 7b73 656c 662e 6964 7d3a 2022 0a20  n {self.id}: ". 
+00007530: 2020 2020 2020 2020 2020 202b 2022 5461             + "Ta
+00007540: 736b 733a 2022 0a20 2020 2020 2020 2020  sks: ".         
+00007550: 2020 202b 2022 2c20 222e 6a6f 696e 280a     + ", ".join(.
+00007560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007570: 2225 733a 2025 6422 2025 2028 6b2c 2076  "%s: %d" % (k, v
+00007580: 2920 666f 7220 286b 2c20 7629 2069 6e20  ) for (k, v) in 
+00007590: 736f 7274 6564 2873 656c 662e 7374 6174  sorted(self.stat
+000075a0: 6573 2e69 7465 6d73 2829 2920 6966 2076  es.items()) if v
+000075b0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+000075c0: 2020 2020 2020 2020 2020 202b 2022 3e22             + ">"
+000075d0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+000075e0: 6465 6620 5f72 6570 725f 6874 6d6c 5f28  def _repr_html_(
+000075f0: 7365 6c66 2920 2d3e 2073 7472 3a0a 2020  self) -> str:.  
+00007600: 2020 2020 2020 7265 7475 726e 2067 6574        return get
+00007610: 5f74 656d 706c 6174 6528 2263 6f6d 7075  _template("compu
+00007620: 7461 7469 6f6e 2e68 746d 6c2e 6a32 2229  tation.html.j2")
+00007630: 2e72 656e 6465 7228 0a20 2020 2020 2020  .render(.       
+00007640: 2020 2020 2069 643d 7365 6c66 2e69 642c       id=self.id,
+00007650: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
+00007660: 7274 3d73 656c 662e 7374 6172 742c 0a20  rt=self.start,. 
+00007670: 2020 2020 2020 2020 2020 2073 746f 703d             stop=
+00007680: 7365 6c66 2e73 746f 702c 0a20 2020 2020  self.stop,.     
+00007690: 2020 2020 2020 2067 726f 7570 733d 7365         groups=se
+000076a0: 6c66 2e67 726f 7570 732c 0a20 2020 2020  lf.groups,.     
+000076b0: 2020 2020 2020 2073 7461 7465 733d 7365         states=se
+000076c0: 6c66 2e73 7461 7465 732c 0a20 2020 2020  lf.states,.     
+000076d0: 2020 2020 2020 2063 6f64 653d 7365 6c66         code=self
+000076e0: 2e63 6f64 652c 0a20 2020 2020 2020 2029  .code,.        )
+000076f0: 0a0a 0a63 6c61 7373 2054 6173 6b50 7265  ...class TaskPre
+00007700: 6669 783a 0a20 2020 2022 2222 436f 6c6c  fix:.    """Coll
+00007710: 6563 7469 6f6e 2074 7261 636b 696e 6720  ection tracking 
+00007720: 616c 6c20 7461 736b 7320 7769 7468 696e  all tasks within
+00007730: 2061 2067 726f 7570 0a0a 2020 2020 4b65   a group..    Ke
+00007740: 7973 206f 6674 656e 2068 6176 6520 6120  ys often have a 
+00007750: 7374 7275 6374 7572 6520 6c69 6b65 2060  structure like `
+00007760: 6028 2278 2d31 3233 222c 2030 2960 600a  `("x-123", 0)``.
+00007770: 2020 2020 4120 6772 6f75 7020 7461 6b65      A group take
+00007780: 7320 7468 6520 6669 7273 7420 7365 6374  s the first sect
+00007790: 696f 6e2c 206c 696b 6520 6060 2278 2260  ion, like ``"x"`
+000077a0: 600a 0a20 2020 2053 6565 2041 6c73 6f0a  `..    See Also.
+000077b0: 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020      --------.   
+000077c0: 2054 6173 6b47 726f 7570 0a20 2020 2022   TaskGroup.    "
+000077d0: 2222 0a0a 2020 2020 233a 2054 6865 206e  ""..    #: The n
+000077e0: 616d 6520 6f66 2061 2067 726f 7570 206f  ame of a group o
+000077f0: 6620 7461 736b 732e 0a20 2020 2023 3a20  f tasks..    #: 
+00007800: 466f 7220 6120 7461 736b 206c 696b 6520  For a task like 
+00007810: 6060 2822 782d 3132 3322 2c20 3029 6060  ``("x-123", 0)``
+00007820: 2074 6869 7320 6973 2074 6865 2074 6578   this is the tex
+00007830: 7420 6060 2278 2260 600a 2020 2020 6e61  t ``"x"``.    na
+00007840: 6d65 3a20 7374 720a 0a20 2020 2023 3a20  me: str..    #: 
+00007850: 416e 2065 7870 6f6e 656e 7469 616c 6c79  An exponentially
+00007860: 2077 6569 6768 7465 6420 6d6f 7669 6e67   weighted moving
+00007870: 2061 7665 7261 6765 2064 7572 6174 696f   average duratio
+00007880: 6e20 6f66 2061 6c6c 2074 6173 6b73 2077  n of all tasks w
+00007890: 6974 6820 7468 6973 2070 7265 6669 780a  ith this prefix.
+000078a0: 2020 2020 6475 7261 7469 6f6e 5f61 7665      duration_ave
+000078b0: 7261 6765 3a20 666c 6f61 740a 0a20 2020  rage: float..   
+000078c0: 2023 3a20 4e75 6d62 6572 7320 6f66 2074   #: Numbers of t
+000078d0: 696d 6573 2061 2074 6173 6b20 7761 7320  imes a task was 
+000078e0: 6d61 726b 6564 2061 7320 7375 7370 6963  marked as suspic
+000078f0: 696f 7573 2077 6974 6820 7468 6973 2070  ious with this p
+00007900: 7265 6669 780a 2020 2020 7375 7370 6963  refix.    suspic
+00007910: 696f 7573 3a20 696e 740a 0a20 2020 2023  ious: int..    #
+00007920: 3a20 5374 6f72 6520 7469 6d69 6e67 7320  : Store timings 
+00007930: 666f 7220 6561 6368 2070 7265 6669 782d  for each prefix-
+00007940: 6163 7469 6f6e 0a20 2020 2061 6c6c 5f64  action.    all_d
+00007950: 7572 6174 696f 6e73 3a20 6465 6661 756c  urations: defaul
+00007960: 7464 6963 745b 7374 722c 2066 6c6f 6174  tdict[str, float
+00007970: 5d0a 0a20 2020 2023 3a20 5468 6973 206d  ]..    #: This m
+00007980: 6561 7375 7265 7320 7468 6520 6d61 7869  easures the maxi
+00007990: 6d75 6d20 7265 636f 7264 6564 206c 6976  mum recorded liv
+000079a0: 6520 6578 6563 7574 696f 6e20 7469 6d65  e execution time
+000079b0: 2061 6e64 2063 616e 2062 6520 7573 6564   and can be used
+000079c0: 2074 6f0a 2020 2020 233a 2064 6574 6563   to.    #: detec
+000079d0: 7420 6f75 746c 6965 7273 0a20 2020 206d  t outliers.    m
+000079e0: 6178 5f65 7865 635f 7469 6d65 3a20 666c  ax_exec_time: fl
+000079f0: 6f61 740a 0a20 2020 2023 3a20 5461 736b  oat..    #: Task
+00007a00: 2067 726f 7570 7320 6173 736f 6369 6174   groups associat
+00007a10: 6564 2074 6f20 7468 6973 2070 7265 6669  ed to this prefi
+00007a20: 780a 2020 2020 6772 6f75 7073 3a20 6c69  x.    groups: li
+00007a30: 7374 5b54 6173 6b47 726f 7570 5d0a 0a20  st[TaskGroup].. 
+00007a40: 2020 2023 3a20 4163 6375 6d75 6c61 7465     #: Accumulate
+00007a50: 2063 6f75 6e74 206f 6620 6e75 6d62 6572   count of number
+00007a60: 206f 6620 7461 736b 7320 696e 2065 6163   of tasks in eac
+00007a70: 6820 7374 6174 650a 2020 2020 7374 6174  h state.    stat
+00007a80: 655f 636f 756e 7473 3a20 6465 6661 756c  e_counts: defaul
+00007a90: 7464 6963 745b 5461 736b 5374 6174 6553  tdict[TaskStateS
+00007aa0: 7461 7465 2c20 696e 745d 0a0a 2020 2020  tate, int]..    
+00007ab0: 5f5f 736c 6f74 735f 5f20 3d20 7475 706c  __slots__ = tupl
+00007ac0: 6528 5f5f 616e 6e6f 7461 7469 6f6e 735f  e(__annotations_
+00007ad0: 5f29 0a0a 2020 2020 6465 6620 5f5f 696e  _)..    def __in
+00007ae0: 6974 5f5f 2873 656c 662c 206e 616d 653a  it__(self, name:
+00007af0: 2073 7472 293a 0a20 2020 2020 2020 2073   str):.        s
+00007b00: 656c 662e 6e61 6d65 203d 206e 616d 650a  elf.name = name.
+00007b10: 2020 2020 2020 2020 7365 6c66 2e67 726f          self.gro
+00007b20: 7570 7320 3d20 5b5d 0a20 2020 2020 2020  ups = [].       
+00007b30: 2073 656c 662e 616c 6c5f 6475 7261 7469   self.all_durati
+00007b40: 6f6e 7320 3d20 6465 6661 756c 7464 6963  ons = defaultdic
+00007b50: 7428 666c 6f61 7429 0a20 2020 2020 2020  t(float).       
+00007b60: 2073 656c 662e 7374 6174 655f 636f 756e   self.state_coun
+00007b70: 7473 203d 2064 6566 6175 6c74 6469 6374  ts = defaultdict
+00007b80: 2869 6e74 290a 2020 2020 2020 2020 7461  (int).        ta
+00007b90: 736b 5f64 7572 6174 696f 6e73 203d 2064  sk_durations = d
+00007ba0: 6173 6b2e 636f 6e66 6967 2e67 6574 2822  ask.config.get("
+00007bb0: 6469 7374 7269 6275 7465 642e 7363 6865  distributed.sche
+00007bc0: 6475 6c65 722e 6465 6661 756c 742d 7461  duler.default-ta
+00007bd0: 736b 2d64 7572 6174 696f 6e73 2229 0a20  sk-durations"). 
+00007be0: 2020 2020 2020 2069 6620 7365 6c66 2e6e         if self.n
+00007bf0: 616d 6520 696e 2074 6173 6b5f 6475 7261  ame in task_dura
+00007c00: 7469 6f6e 733a 0a20 2020 2020 2020 2020  tions:.         
+00007c10: 2020 2073 656c 662e 6475 7261 7469 6f6e     self.duration
+00007c20: 5f61 7665 7261 6765 203d 2070 6172 7365  _average = parse
+00007c30: 5f74 696d 6564 656c 7461 2874 6173 6b5f  _timedelta(task_
+00007c40: 6475 7261 7469 6f6e 735b 7365 6c66 2e6e  durations[self.n
+00007c50: 616d 655d 290a 2020 2020 2020 2020 656c  ame]).        el
+00007c60: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00007c70: 7365 6c66 2e64 7572 6174 696f 6e5f 6176  self.duration_av
+00007c80: 6572 6167 6520 3d20 2d31 0a20 2020 2020  erage = -1.     
+00007c90: 2020 2073 656c 662e 6d61 785f 6578 6563     self.max_exec
+00007ca0: 5f74 696d 6520 3d20 2d31 0a20 2020 2020  _time = -1.     
+00007cb0: 2020 2073 656c 662e 7375 7370 6963 696f     self.suspicio
+00007cc0: 7573 203d 2030 0a0a 2020 2020 6465 6620  us = 0..    def 
+00007cd0: 6164 645f 6578 6563 5f74 696d 6528 7365  add_exec_time(se
+00007ce0: 6c66 2c20 6475 7261 7469 6f6e 3a20 666c  lf, duration: fl
+00007cf0: 6f61 7429 202d 3e20 4e6f 6e65 3a0a 2020  oat) -> None:.  
+00007d00: 2020 2020 2020 7365 6c66 2e6d 6178 5f65        self.max_e
+00007d10: 7865 635f 7469 6d65 203d 206d 6178 2864  xec_time = max(d
+00007d20: 7572 6174 696f 6e2c 2073 656c 662e 6d61  uration, self.ma
+00007d30: 785f 6578 6563 5f74 696d 6529 0a20 2020  x_exec_time).   
+00007d40: 2020 2020 2069 6620 6475 7261 7469 6f6e       if duration
+00007d50: 203e 2032 202a 2073 656c 662e 6475 7261   > 2 * self.dura
+00007d60: 7469 6f6e 5f61 7665 7261 6765 3a0a 2020  tion_average:.  
+00007d70: 2020 2020 2020 2020 2020 7365 6c66 2e64            self.d
+00007d80: 7572 6174 696f 6e5f 6176 6572 6167 6520  uration_average 
+00007d90: 3d20 2d31 0a0a 2020 2020 6465 6620 6164  = -1..    def ad
+00007da0: 645f 6475 7261 7469 6f6e 2873 656c 662c  d_duration(self,
+00007db0: 2061 6374 696f 6e3a 2073 7472 2c20 7374   action: str, st
+00007dc0: 6172 743a 2066 6c6f 6174 2c20 7374 6f70  art: float, stop
+00007dd0: 3a20 666c 6f61 7429 202d 3e20 4e6f 6e65  : float) -> None
+00007de0: 3a0a 2020 2020 2020 2020 6475 7261 7469  :.        durati
+00007df0: 6f6e 203d 2073 746f 7020 2d20 7374 6172  on = stop - star
+00007e00: 740a 2020 2020 2020 2020 7365 6c66 2e61  t.        self.a
+00007e10: 6c6c 5f64 7572 6174 696f 6e73 5b61 6374  ll_durations[act
+00007e20: 696f 6e5d 202b 3d20 6475 7261 7469 6f6e  ion] += duration
+00007e30: 0a20 2020 2020 2020 2069 6620 6163 7469  .        if acti
+00007e40: 6f6e 203d 3d20 2263 6f6d 7075 7465 223a  on == "compute":
+00007e50: 0a20 2020 2020 2020 2020 2020 206f 6c64  .            old
+00007e60: 203d 2073 656c 662e 6475 7261 7469 6f6e   = self.duration
+00007e70: 5f61 7665 7261 6765 0a20 2020 2020 2020  _average.       
+00007e80: 2020 2020 2069 6620 6f6c 6420 3c20 303a       if old < 0:
+00007e90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007ea0: 2073 656c 662e 6475 7261 7469 6f6e 5f61   self.duration_a
+00007eb0: 7665 7261 6765 203d 2064 7572 6174 696f  verage = duratio
+00007ec0: 6e0a 2020 2020 2020 2020 2020 2020 656c  n.            el
+00007ed0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00007ee0: 2020 2020 7365 6c66 2e64 7572 6174 696f      self.duratio
+00007ef0: 6e5f 6176 6572 6167 6520 3d20 302e 3520  n_average = 0.5 
+00007f00: 2a20 6475 7261 7469 6f6e 202b 2030 2e35  * duration + 0.5
+00007f10: 202a 206f 6c64 0a0a 2020 2020 4070 726f   * old..    @pro
+00007f20: 7065 7274 790a 2020 2020 6465 6620 7374  perty.    def st
+00007f30: 6174 6573 2873 656c 6629 202d 3e20 6469  ates(self) -> di
+00007f40: 6374 5b54 6173 6b53 7461 7465 5374 6174  ct[TaskStateStat
+00007f50: 652c 2069 6e74 5d3a 0a20 2020 2020 2020  e, int]:.       
+00007f60: 2022 2222 5468 6520 6e75 6d62 6572 206f   """The number o
+00007f70: 6620 7461 736b 7320 696e 2065 6163 6820  f tasks in each 
+00007f80: 7374 6174 652c 0a20 2020 2020 2020 206c  state,.        l
+00007f90: 696b 6520 6060 7b22 6d65 6d6f 7279 223a  ike ``{"memory":
+00007fa0: 2031 302c 2022 7072 6f63 6573 7369 6e67   10, "processing
+00007fb0: 223a 2033 2c20 2272 656c 6561 7365 6422  ": 3, "released"
+00007fc0: 3a20 342c 202e 2e2e 7d60 600a 2020 2020  : 4, ...}``.    
+00007fd0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00007fe0: 7265 7475 726e 206d 6572 6765 5f77 6974  return merge_wit
+00007ff0: 6828 7375 6d2c 205b 7467 2e73 7461 7465  h(sum, [tg.state
+00008000: 7320 666f 7220 7467 2069 6e20 7365 6c66  s for tg in self
+00008010: 2e67 726f 7570 735d 290a 0a20 2020 2040  .groups])..    @
+00008020: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
+00008030: 2061 6374 6976 6528 7365 6c66 2920 2d3e   active(self) ->
+00008040: 206c 6973 745b 5461 736b 4772 6f75 705d   list[TaskGroup]
+00008050: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+00008060: 205b 0a20 2020 2020 2020 2020 2020 2074   [.            t
+00008070: 670a 2020 2020 2020 2020 2020 2020 666f  g.            fo
+00008080: 7220 7467 2069 6e20 7365 6c66 2e67 726f  r tg in self.gro
+00008090: 7570 730a 2020 2020 2020 2020 2020 2020  ups.            
+000080a0: 6966 2061 6e79 286b 2021 3d20 2266 6f72  if any(k != "for
+000080b0: 676f 7474 656e 2220 616e 6420 7620 213d  gotten" and v !=
+000080c0: 2030 2066 6f72 206b 2c20 7620 696e 2074   0 for k, v in t
+000080d0: 672e 7374 6174 6573 2e69 7465 6d73 2829  g.states.items()
+000080e0: 290a 2020 2020 2020 2020 5d0a 0a20 2020  ).        ]..   
+000080f0: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
+00008100: 6566 2061 6374 6976 655f 7374 6174 6573  ef active_states
+00008110: 2873 656c 6629 202d 3e20 6469 6374 5b54  (self) -> dict[T
+00008120: 6173 6b53 7461 7465 5374 6174 652c 2069  askStateState, i
+00008130: 6e74 5d3a 0a20 2020 2020 2020 2072 6574  nt]:.        ret
+00008140: 7572 6e20 6d65 7267 655f 7769 7468 2873  urn merge_with(s
+00008150: 756d 2c20 5b74 672e 7374 6174 6573 2066  um, [tg.states f
+00008160: 6f72 2074 6720 696e 2073 656c 662e 6163  or tg in self.ac
+00008170: 7469 7665 5d29 0a0a 2020 2020 6465 6620  tive])..    def 
+00008180: 5f5f 7265 7072 5f5f 2873 656c 6629 202d  __repr__(self) -
+00008190: 3e20 7374 723a 0a20 2020 2020 2020 2072  > str:.        r
+000081a0: 6574 7572 6e20 280a 2020 2020 2020 2020  eturn (.        
+000081b0: 2020 2020 223c 220a 2020 2020 2020 2020      "<".        
+000081c0: 2020 2020 2b20 7365 6c66 2e6e 616d 650a      + self.name.
+000081d0: 2020 2020 2020 2020 2020 2020 2b20 223a              + ":
+000081e0: 2022 0a20 2020 2020 2020 2020 2020 202b   ".            +
+000081f0: 2022 2c20 222e 6a6f 696e 280a 2020 2020   ", ".join(.    
+00008200: 2020 2020 2020 2020 2020 2020 2225 733a              "%s:
+00008210: 2025 6422 2025 2028 6b2c 2076 2920 666f   %d" % (k, v) fo
+00008220: 7220 286b 2c20 7629 2069 6e20 736f 7274  r (k, v) in sort
+00008230: 6564 2873 656c 662e 7374 6174 6573 2e69  ed(self.states.i
+00008240: 7465 6d73 2829 2920 6966 2076 0a20 2020  tems()) if v.   
+00008250: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00008260: 2020 2020 2020 202b 2022 3e22 0a20 2020         + ">".   
+00008270: 2020 2020 2029 0a0a 2020 2020 4070 726f       )..    @pro
+00008280: 7065 7274 790a 2020 2020 6465 6620 6e62  perty.    def nb
+00008290: 7974 6573 5f74 6f74 616c 2873 656c 6629  ytes_total(self)
+000082a0: 202d 3e20 696e 743a 0a20 2020 2020 2020   -> int:.       
+000082b0: 2072 6574 7572 6e20 7375 6d28 7467 2e6e   return sum(tg.n
+000082c0: 6279 7465 735f 746f 7461 6c20 666f 7220  bytes_total for 
+000082d0: 7467 2069 6e20 7365 6c66 2e67 726f 7570  tg in self.group
+000082e0: 7329 0a0a 2020 2020 6465 6620 5f5f 6c65  s)..    def __le
+000082f0: 6e5f 5f28 7365 6c66 2920 2d3e 2069 6e74  n__(self) -> int
+00008300: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+00008310: 2073 756d 286d 6170 286c 656e 2c20 7365   sum(map(len, se
+00008320: 6c66 2e67 726f 7570 7329 290a 0a20 2020  lf.groups))..   
+00008330: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
+00008340: 6566 2064 7572 6174 696f 6e28 7365 6c66  ef duration(self
+00008350: 2920 2d3e 2066 6c6f 6174 3a0a 2020 2020  ) -> float:.    
+00008360: 2020 2020 7265 7475 726e 2073 756d 2874      return sum(t
+00008370: 672e 6475 7261 7469 6f6e 2066 6f72 2074  g.duration for t
+00008380: 6720 696e 2073 656c 662e 6772 6f75 7073  g in self.groups
+00008390: 290a 0a20 2020 2040 7072 6f70 6572 7479  )..    @property
+000083a0: 0a20 2020 2064 6566 2074 7970 6573 2873  .    def types(s
+000083b0: 656c 6629 202d 3e20 7365 745b 7374 725d  elf) -> set[str]
+000083c0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+000083d0: 207b 7479 7020 666f 7220 7467 2069 6e20   {typ for tg in 
+000083e0: 7365 6c66 2e67 726f 7570 7320 666f 7220  self.groups for 
+000083f0: 7479 7020 696e 2074 672e 7479 7065 737d  typ in tg.types}
+00008400: 0a0a 0a63 6c61 7373 2054 6173 6b47 726f  ...class TaskGro
+00008410: 7570 3a0a 2020 2020 2222 2243 6f6c 6c65  up:.    """Colle
+00008420: 6374 696f 6e20 7472 6163 6b69 6e67 2061  ction tracking a
+00008430: 6c6c 2074 6173 6b73 2077 6974 6869 6e20  ll tasks within 
+00008440: 6120 6772 6f75 700a 0a20 2020 204b 6579  a group..    Key
+00008450: 7320 6f66 7465 6e20 6861 7665 2061 2073  s often have a s
+00008460: 7472 7563 7475 7265 206c 696b 6520 6060  tructure like ``
+00008470: 2822 782d 3132 3322 2c20 3029 6060 0a20  ("x-123", 0)``. 
+00008480: 2020 2041 2067 726f 7570 2074 616b 6573     A group takes
+00008490: 2074 6865 2066 6972 7374 2073 6563 7469   the first secti
+000084a0: 6f6e 2c20 6c69 6b65 2060 6022 782d 3132  on, like ``"x-12
+000084b0: 3322 6060 0a0a 2020 2020 5365 6520 616c  3"``..    See al
+000084c0: 736f 0a20 2020 202d 2d2d 2d2d 2d2d 2d0a  so.    --------.
+000084d0: 2020 2020 5461 736b 5072 6566 6978 0a20      TaskPrefix. 
+000084e0: 2020 2022 2222 0a0a 2020 2020 233a 2054     """..    #: T
+000084f0: 6865 206e 616d 6520 6f66 2061 2067 726f  he name of a gro
+00008500: 7570 206f 6620 7461 736b 732e 0a20 2020  up of tasks..   
+00008510: 2023 3a20 466f 7220 6120 7461 736b 206c   #: For a task l
+00008520: 696b 6520 6060 2822 782d 3132 3322 2c20  ike ``("x-123", 
+00008530: 3029 6060 2074 6869 7320 6973 2074 6865  0)`` this is the
+00008540: 2074 6578 7420 6060 2278 2d31 3233 2260   text ``"x-123"`
+00008550: 600a 2020 2020 6e61 6d65 3a20 7374 720a  `.    name: str.
+00008560: 0a20 2020 2023 3a20 5468 6520 6e75 6d62  .    #: The numb
+00008570: 6572 206f 6620 7461 736b 7320 696e 2065  er of tasks in e
+00008580: 6163 6820 7374 6174 652c 0a20 2020 2023  ach state,.    #
+00008590: 3a20 6c69 6b65 2060 607b 226d 656d 6f72  : like ``{"memor
+000085a0: 7922 3a20 3130 2c20 2270 726f 6365 7373  y": 10, "process
+000085b0: 696e 6722 3a20 332c 2022 7265 6c65 6173  ing": 3, "releas
+000085c0: 6564 223a 2034 2c20 2e2e 2e7d 6060 0a20  ed": 4, ...}``. 
+000085d0: 2020 2073 7461 7465 733a 2064 6963 745b     states: dict[
+000085e0: 5461 736b 5374 6174 6553 7461 7465 2c20  TaskStateState, 
+000085f0: 696e 745d 0a0a 2020 2020 233a 2054 6865  int]..    #: The
+00008600: 206f 7468 6572 2054 6173 6b47 726f 7570   other TaskGroup
+00008610: 7320 6f6e 2077 6869 6368 2074 6869 7320  s on which this 
+00008620: 6f6e 6520 6465 7065 6e64 730a 2020 2020  one depends.    
+00008630: 6465 7065 6e64 656e 6369 6573 3a20 7365  dependencies: se
+00008640: 745b 5461 736b 4772 6f75 705d 0a0a 2020  t[TaskGroup]..  
+00008650: 2020 233a 2054 6865 2074 6f74 616c 206e    #: The total n
+00008660: 756d 6265 7220 6f66 2062 7974 6573 2074  umber of bytes t
+00008670: 6861 7420 7468 6973 2074 6173 6b20 6772  hat this task gr
+00008680: 6f75 7020 6861 7320 7072 6f64 7563 6564  oup has produced
+00008690: 0a20 2020 206e 6279 7465 735f 746f 7461  .    nbytes_tota
+000086a0: 6c3a 2069 6e74 0a0a 2020 2020 233a 2054  l: int..    #: T
+000086b0: 6865 2074 6f74 616c 2061 6d6f 756e 7420  he total amount 
+000086c0: 6f66 2074 696d 6520 7370 656e 7420 6f6e  of time spent on
+000086d0: 2061 6c6c 2074 6173 6b73 2069 6e20 7468   all tasks in th
+000086e0: 6973 2054 6173 6b47 726f 7570 0a20 2020  is TaskGroup.   
+000086f0: 2064 7572 6174 696f 6e3a 2066 6c6f 6174   duration: float
+00008700: 0a0a 2020 2020 233a 2054 6865 2072 6573  ..    #: The res
+00008710: 756c 7420 7479 7065 7320 6f66 2074 6869  ult types of thi
+00008720: 7320 5461 736b 4772 6f75 700a 2020 2020  s TaskGroup.    
+00008730: 7479 7065 733a 2073 6574 5b73 7472 5d0a  types: set[str].
+00008740: 0a20 2020 2023 3a20 5468 6520 776f 726b  .    #: The work
+00008750: 6572 206d 6f73 7420 7265 6365 6e74 6c79  er most recently
+00008760: 2061 7373 6967 6e65 6420 6120 7461 736b   assigned a task
+00008770: 2066 726f 6d20 7468 6973 2067 726f 7570   from this group
+00008780: 2c20 6f72 204e 6f6e 6520 7768 656e 2074  , or None when t
+00008790: 6865 2067 726f 7570 0a20 2020 2023 3a20  he group.    #: 
+000087a0: 6973 206e 6f74 2069 6465 6e74 6966 6965  is not identifie
+000087b0: 6420 746f 2062 6520 726f 6f74 2d6c 696b  d to be root-lik
+000087c0: 6520 6279 2060 5363 6865 6475 6c65 7253  e by `SchedulerS
+000087d0: 7461 7465 2e64 6563 6964 655f 776f 726b  tate.decide_work
+000087e0: 6572 602e 0a20 2020 206c 6173 745f 776f  er`..    last_wo
+000087f0: 726b 6572 3a20 576f 726b 6572 5374 6174  rker: WorkerStat
+00008800: 6520 7c20 4e6f 6e65 0a0a 2020 2020 233a  e | None..    #:
+00008810: 2049 6620 606c 6173 745f 776f 726b 6572   If `last_worker
+00008820: 6020 6973 206e 6f74 204e 6f6e 652c 2074  ` is not None, t
+00008830: 6865 206e 756d 6265 7220 6f66 2074 696d  he number of tim
+00008840: 6573 2074 6861 7420 776f 726b 6572 2073  es that worker s
+00008850: 686f 756c 6420 6265 2061 7373 6967 6e65  hould be assigne
+00008860: 640a 2020 2020 233a 2073 7562 7365 7175  d.    #: subsequ
+00008870: 656e 7420 7461 736b 7320 756e 7469 6c20  ent tasks until 
+00008880: 6120 6e65 7720 776f 726b 6572 2069 7320  a new worker is 
+00008890: 6368 6f73 656e 2e0a 2020 2020 6c61 7374  chosen..    last
+000088a0: 5f77 6f72 6b65 725f 7461 736b 735f 6c65  _worker_tasks_le
+000088b0: 6674 3a20 696e 740a 0a20 2020 2070 7265  ft: int..    pre
+000088c0: 6669 783a 2054 6173 6b50 7265 6669 7820  fix: TaskPrefix 
+000088d0: 7c20 4e6f 6e65 0a0a 2020 2020 233a 2045  | None..    #: E
+000088e0: 6172 6c69 6573 7420 7469 6d65 2077 6865  arliest time whe
+000088f0: 6e20 6120 7461 736b 2062 656c 6f6e 6769  n a task belongi
+00008900: 6e67 2074 6f20 7468 6973 2067 726f 7570  ng to this group
+00008910: 2073 7461 7274 6564 2063 6f6d 7075 7469   started computi
+00008920: 6e67 3b0a 2020 2020 233a 2030 2069 6620  ng;.    #: 0 if 
+00008930: 6e6f 2074 6173 6b20 6861 7320 2a66 696e  no task has *fin
+00008940: 6973 6865 642a 2063 6f6d 7075 7469 6e67  ished* computing
+00008950: 2079 6574 0a20 2020 2023 3a0a 2020 2020   yet.    #:.    
+00008960: 233a 204e 6f74 6573 0a20 2020 2023 3a20  #: Notes.    #: 
+00008970: 2d2d 2d2d 2d0a 2020 2020 233a 2054 6869  -----.    #: Thi
+00008980: 7320 6973 206e 6f74 2075 7064 6174 6564  s is not updated
+00008990: 2075 6e74 696c 2061 7420 6c65 6173 7420   until at least 
+000089a0: 6f6e 6520 7461 736b 2068 6173 202a 6669  one task has *fi
+000089b0: 6e69 7368 6564 2a20 636f 6d70 7574 696e  nished* computin
+000089c0: 672e 0a20 2020 2023 3a20 4974 2063 6f75  g..    #: It cou
+000089d0: 6c64 206d 6f76 6520 6261 636b 7761 7264  ld move backward
+000089e0: 7320 6173 2074 6173 6b73 2063 6f6d 706c  s as tasks compl
+000089f0: 6574 652e 0a20 2020 2073 7461 7274 3a20  ete..    start: 
+00008a00: 666c 6f61 740a 0a20 2020 2023 3a20 4c61  float..    #: La
+00008a10: 7465 7374 2074 696d 6520 7768 656e 2061  test time when a
+00008a20: 2074 6173 6b20 6265 6c6f 6e67 696e 6720   task belonging 
+00008a30: 746f 2074 6869 7320 6772 6f75 7020 6669  to this group fi
+00008a40: 6e69 7368 6564 2063 6f6d 7075 7469 6e67  nished computing
+00008a50: 2c0a 2020 2020 233a 2030 2069 6620 6e6f  ,.    #: 0 if no
+00008a60: 2074 6173 6b20 6861 7320 6669 6e69 7368   task has finish
+00008a70: 6564 2063 6f6d 7075 7469 6e67 2079 6574  ed computing yet
+00008a80: 0a20 2020 2073 746f 703a 2066 6c6f 6174  .    stop: float
+00008a90: 0a0a 2020 2020 233a 2043 756d 756c 6174  ..    #: Cumulat
+00008aa0: 6976 6520 6475 7261 7469 6f6e 206f 6620  ive duration of 
+00008ab0: 616c 6c20 636f 6d70 6c65 7465 6420 6163  all completed ac
+00008ac0: 7469 6f6e 732c 2062 7920 6163 7469 6f6e  tions, by action
+00008ad0: 0a20 2020 2061 6c6c 5f64 7572 6174 696f  .    all_duratio
+00008ae0: 6e73 3a20 6465 6661 756c 7464 6963 745b  ns: defaultdict[
+00008af0: 7374 722c 2066 6c6f 6174 5d0a 0a20 2020  str, float]..   
+00008b00: 2023 3a20 5370 616e 2049 4420 2873 6565   #: Span ID (see
+00008b10: 2060 6064 6973 7472 6962 7574 6564 2e73   ``distributed.s
+00008b20: 7061 6e73 6060 292e 0a20 2020 2023 3a20  pans``)..    #: 
+00008b30: 4d61 7463 6865 7320 6060 6469 7374 7269  Matches ``distri
+00008b40: 6275 7465 642e 776f 726b 6572 5f73 7461  buted.worker_sta
+00008b50: 7465 5f6d 6163 6869 6e65 2e54 6173 6b53  te_machine.TaskS
+00008b60: 7461 7465 2e73 7061 6e5f 6964 6060 2e0a  tate.span_id``..
+00008b70: 2020 2020 233a 2049 7420 6973 2070 6f73      #: It is pos
+00008b80: 7369 626c 6520 746f 2065 6e64 2075 7020  sible to end up 
+00008b90: 696e 2073 6974 7561 7469 6f6e 2077 6865  in situation whe
+00008ba0: 7265 2064 6966 6665 7265 6e74 2074 6173  re different tas
+00008bb0: 6b73 206f 6620 7468 6520 7361 6d65 2054  ks of the same T
+00008bc0: 6173 6b47 726f 7570 0a20 2020 2023 3a20  askGroup.    #: 
+00008bd0: 6265 6c6f 6e67 2074 6f20 6469 6666 6572  belong to differ
+00008be0: 656e 7420 7370 616e 733b 2074 6865 2070  ent spans; the p
+00008bf0: 7572 706f 7365 206f 6620 7468 6973 2061  urpose of this a
+00008c00: 7474 7269 6275 7465 2069 7320 746f 2061  ttribute is to a
+00008c10: 7262 6974 7261 7269 6c79 2066 6f72 6365  rbitrarily force
+00008c20: 0a20 2020 2023 3a20 6576 6572 7974 6869  .    #: everythi
+00008c30: 6e67 206f 6e74 6f20 7468 6520 6561 726c  ng onto the earl
+00008c40: 6965 7374 2065 6e63 6f75 6e74 6572 6564  iest encountered
+00008c50: 206f 6e65 2e0a 2020 2020 7370 616e 5f69   one..    span_i
+00008c60: 643a 2073 7472 207c 204e 6f6e 650a 0a20  d: str | None.. 
+00008c70: 2020 205f 5f73 6c6f 7473 5f5f 203d 2074     __slots__ = t
+00008c80: 7570 6c65 285f 5f61 6e6e 6f74 6174 696f  uple(__annotatio
+00008c90: 6e73 5f5f 290a 0a20 2020 2064 6566 205f  ns__)..    def _
+00008ca0: 5f69 6e69 745f 5f28 7365 6c66 2c20 6e61  _init__(self, na
+00008cb0: 6d65 3a20 7374 7229 3a0a 2020 2020 2020  me: str):.      
+00008cc0: 2020 7365 6c66 2e6e 616d 6520 3d20 6e61    self.name = na
+00008cd0: 6d65 0a20 2020 2020 2020 2073 656c 662e  me.        self.
+00008ce0: 7072 6566 6978 203d 204e 6f6e 650a 2020  prefix = None.  
+00008cf0: 2020 2020 2020 7365 6c66 2e73 7461 7465        self.state
+00008d00: 7320 3d20 6469 6374 2e66 726f 6d6b 6579  s = dict.fromkey
+00008d10: 7328 414c 4c5f 5441 534b 5f53 5441 5445  s(ALL_TASK_STATE
+00008d20: 532c 2030 290a 2020 2020 2020 2020 7365  S, 0).        se
+00008d30: 6c66 2e64 6570 656e 6465 6e63 6965 7320  lf.dependencies 
+00008d40: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
+00008d50: 7365 6c66 2e6e 6279 7465 735f 746f 7461  self.nbytes_tota
+00008d60: 6c20 3d20 300a 2020 2020 2020 2020 7365  l = 0.        se
+00008d70: 6c66 2e64 7572 6174 696f 6e20 3d20 300a  lf.duration = 0.
+00008d80: 2020 2020 2020 2020 7365 6c66 2e74 7970          self.typ
+00008d90: 6573 203d 2073 6574 2829 0a20 2020 2020  es = set().     
+00008da0: 2020 2073 656c 662e 7374 6172 7420 3d20     self.start = 
+00008db0: 302e 300a 2020 2020 2020 2020 7365 6c66  0.0.        self
+00008dc0: 2e73 746f 7020 3d20 302e 300a 2020 2020  .stop = 0.0.    
+00008dd0: 2020 2020 7365 6c66 2e61 6c6c 5f64 7572      self.all_dur
+00008de0: 6174 696f 6e73 203d 2064 6566 6175 6c74  ations = default
+00008df0: 6469 6374 2866 6c6f 6174 290a 2020 2020  dict(float).    
+00008e00: 2020 2020 7365 6c66 2e6c 6173 745f 776f      self.last_wo
+00008e10: 726b 6572 203d 204e 6f6e 650a 2020 2020  rker = None.    
+00008e20: 2020 2020 7365 6c66 2e6c 6173 745f 776f      self.last_wo
+00008e30: 726b 6572 5f74 6173 6b73 5f6c 6566 7420  rker_tasks_left 
+00008e40: 3d20 300a 2020 2020 2020 2020 7365 6c66  = 0.        self
+00008e50: 2e73 7061 6e5f 6964 203d 204e 6f6e 650a  .span_id = None.
+00008e60: 0a20 2020 2064 6566 2061 6464 5f64 7572  .    def add_dur
+00008e70: 6174 696f 6e28 7365 6c66 2c20 6163 7469  ation(self, acti
+00008e80: 6f6e 3a20 7374 722c 2073 7461 7274 3a20  on: str, start: 
+00008e90: 666c 6f61 742c 2073 746f 703a 2066 6c6f  float, stop: flo
+00008ea0: 6174 2920 2d3e 204e 6f6e 653a 0a20 2020  at) -> None:.   
+00008eb0: 2020 2020 2064 7572 6174 696f 6e20 3d20       duration = 
+00008ec0: 7374 6f70 202d 2073 7461 7274 0a20 2020  stop - start.   
+00008ed0: 2020 2020 2073 656c 662e 6475 7261 7469       self.durati
+00008ee0: 6f6e 202b 3d20 6475 7261 7469 6f6e 0a20  on += duration. 
+00008ef0: 2020 2020 2020 2073 656c 662e 616c 6c5f         self.all_
+00008f00: 6475 7261 7469 6f6e 735b 6163 7469 6f6e  durations[action
+00008f10: 5d20 2b3d 2064 7572 6174 696f 6e0a 2020  ] += duration.  
+00008f20: 2020 2020 2020 6966 2061 6374 696f 6e20        if action 
+00008f30: 3d3d 2022 636f 6d70 7574 6522 3a0a 2020  == "compute":.  
+00008f40: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+00008f50: 662e 7374 6f70 203c 2073 746f 703a 0a20  f.stop < stop:. 
+00008f60: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00008f70: 656c 662e 7374 6f70 203d 2073 746f 700a  elf.stop = stop.
+00008f80: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+00008f90: 656c 662e 7374 6172 7420 3d3d 2030 2e30  elf.start == 0.0
+00008fa0: 206f 7220 7365 6c66 2e73 7461 7274 203e   or self.start >
+00008fb0: 2073 7461 7274 3a0a 2020 2020 2020 2020   start:.        
+00008fc0: 2020 2020 2020 2020 7365 6c66 2e73 7461          self.sta
+00008fd0: 7274 203d 2073 7461 7274 0a20 2020 2020  rt = start.     
+00008fe0: 2020 2061 7373 6572 7420 7365 6c66 2e70     assert self.p
+00008ff0: 7265 6669 7820 6973 206e 6f74 204e 6f6e  refix is not Non
+00009000: 650a 2020 2020 2020 2020 7365 6c66 2e70  e.        self.p
+00009010: 7265 6669 782e 6164 645f 6475 7261 7469  refix.add_durati
+00009020: 6f6e 2861 6374 696f 6e2c 2073 7461 7274  on(action, start
+00009030: 2c20 7374 6f70 290a 0a20 2020 2064 6566  , stop)..    def
+00009040: 2061 6464 2873 656c 662c 206f 7468 6572   add(self, other
+00009050: 3a20 5461 736b 5374 6174 6529 202d 3e20  : TaskState) -> 
+00009060: 4e6f 6e65 3a0a 2020 2020 2020 2020 7365  None:.        se
+00009070: 6c66 2e73 7461 7465 735b 6f74 6865 722e  lf.states[other.
+00009080: 7374 6174 655d 202b 3d20 310a 2020 2020  state] += 1.    
+00009090: 2020 2020 6f74 6865 722e 6772 6f75 7020      other.group 
+000090a0: 3d20 7365 6c66 0a0a 2020 2020 6465 6620  = self..    def 
+000090b0: 5f5f 7265 7072 5f5f 2873 656c 6629 202d  __repr__(self) -
+000090c0: 3e20 7374 723a 0a20 2020 2020 2020 2072  > str:.        r
+000090d0: 6574 7572 6e20 280a 2020 2020 2020 2020  eturn (.        
+000090e0: 2020 2020 223c 220a 2020 2020 2020 2020      "<".        
+000090f0: 2020 2020 2b20 2873 656c 662e 6e61 6d65      + (self.name
+00009100: 206f 7220 226e 6f2d 6772 6f75 7022 290a   or "no-group").
+00009110: 2020 2020 2020 2020 2020 2020 2b20 223a              + ":
+00009120: 2022 0a20 2020 2020 2020 2020 2020 202b   ".            +
+00009130: 2022 2c20 222e 6a6f 696e 280a 2020 2020   ", ".join(.    
+00009140: 2020 2020 2020 2020 2020 2020 2225 733a              "%s:
+00009150: 2025 6422 2025 2028 6b2c 2076 2920 666f   %d" % (k, v) fo
+00009160: 7220 286b 2c20 7629 2069 6e20 736f 7274  r (k, v) in sort
+00009170: 6564 2873 656c 662e 7374 6174 6573 2e69  ed(self.states.i
+00009180: 7465 6d73 2829 2920 6966 2076 0a20 2020  tems()) if v.   
+00009190: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+000091a0: 2020 2020 2020 202b 2022 3e22 0a20 2020         + ">".   
+000091b0: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
+000091c0: 5f5f 6c65 6e5f 5f28 7365 6c66 2920 2d3e  __len__(self) ->
+000091d0: 2069 6e74 3a0a 2020 2020 2020 2020 7265   int:.        re
+000091e0: 7475 726e 2073 756d 2873 656c 662e 7374  turn sum(self.st
+000091f0: 6174 6573 2e76 616c 7565 7328 2929 0a0a  ates.values())..
+00009200: 2020 2020 6465 6620 5f74 6f5f 6469 6374      def _to_dict
+00009210: 5f6e 6f5f 6e65 7374 2873 656c 662c 202a  _no_nest(self, *
+00009220: 2c20 6578 636c 7564 653a 2043 6f6e 7461  , exclude: Conta
+00009230: 696e 6572 5b73 7472 5d20 3d20 2829 2920  iner[str] = ()) 
+00009240: 2d3e 2064 6963 745b 7374 722c 2041 6e79  -> dict[str, Any
+00009250: 5d3a 0a20 2020 2020 2020 2022 2222 4469  ]:.        """Di
+00009260: 6374 696f 6e61 7279 2072 6570 7265 7365  ctionary represe
+00009270: 6e74 6174 696f 6e20 666f 7220 6465 6275  ntation for debu
+00009280: 6767 696e 6720 7075 7270 6f73 6573 2e0a  gging purposes..
+00009290: 2020 2020 2020 2020 4e6f 7420 7479 7065          Not type
+000092a0: 2073 7461 626c 6520 616e 6420 6e6f 7420   stable and not 
+000092b0: 696e 7465 6e64 6564 2066 6f72 2072 6f75  intended for rou
+000092c0: 6e64 7472 6970 732e 0a0a 2020 2020 2020  ndtrips...      
+000092d0: 2020 5365 6520 616c 736f 0a20 2020 2020    See also.     
+000092e0: 2020 202d 2d2d 2d2d 2d2d 2d0a 2020 2020     --------.    
+000092f0: 2020 2020 436c 6965 6e74 2e64 756d 705f      Client.dump_
+00009300: 636c 7573 7465 725f 7374 6174 650a 2020  cluster_state.  
+00009310: 2020 2020 2020 6469 7374 7269 6275 7465        distribute
+00009320: 642e 7574 696c 732e 7265 6375 7273 6976  d.utils.recursiv
+00009330: 655f 746f 5f64 6963 740a 2020 2020 2020  e_to_dict.      
+00009340: 2020 5461 736b 5374 6174 652e 5f74 6f5f    TaskState._to_
+00009350: 6469 6374 0a20 2020 2020 2020 2022 2222  dict.        """
+00009360: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00009370: 7265 6375 7273 6976 655f 746f 5f64 6963  recursive_to_dic
+00009380: 7428 7365 6c66 2c20 6578 636c 7564 653d  t(self, exclude=
+00009390: 6578 636c 7564 652c 206d 656d 6265 7273  exclude, members
+000093a0: 3d54 7275 6529 0a0a 2020 2020 4070 726f  =True)..    @pro
+000093b0: 7065 7274 790a 2020 2020 6465 6620 646f  perty.    def do
+000093c0: 6e65 2873 656c 6629 202d 3e20 626f 6f6c  ne(self) -> bool
+000093d0: 3a0a 2020 2020 2020 2020 2222 2252 6574  :.        """Ret
+000093e0: 7572 6e20 5472 7565 2069 6620 616c 6c20  urn True if all 
+000093f0: 636f 6d70 7574 6174 696f 6e73 2066 6f72  computations for
+00009400: 2074 6869 7320 6772 6f75 7020 6861 7665   this group have
+00009410: 2063 6f6d 706c 6574 6564 3b20 4661 6c73   completed; Fals
+00009420: 650a 2020 2020 2020 2020 6f74 6865 7277  e.        otherw
+00009430: 6973 652e 0a0a 2020 2020 2020 2020 4e6f  ise...        No
+00009440: 7465 730a 2020 2020 2020 2020 2d2d 2d2d  tes.        ----
+00009450: 2d0a 2020 2020 2020 2020 5468 6973 2070  -.        This p
+00009460: 726f 7065 7274 7920 6d61 7920 7472 616e  roperty may tran
+00009470: 7369 7469 6f6e 2066 726f 6d20 5472 7565  sition from True
+00009480: 2074 6f20 4661 6c73 652c 2065 2e67 2e20   to False, e.g. 
+00009490: 7768 656e 2061 2077 6f72 6b65 7220 7468  when a worker th
+000094a0: 6174 0a20 2020 2020 2020 2063 6f6e 7461  at.        conta
+000094b0: 696e 6564 2074 6865 206f 6e6c 7920 7265  ined the only re
+000094c0: 706c 6963 6120 6f66 2061 2074 6173 6b20  plica of a task 
+000094d0: 696e 206d 656d 6f72 7920 6372 6173 6865  in memory crashe
+000094e0: 7320 616e 6420 7468 6520 7461 736b 206e  s and the task n
+000094f0: 6565 6420 746f 2062 650a 2020 2020 2020  eed to be.      
+00009500: 2020 7265 636f 6d70 7574 6564 2e0a 2020    recomputed..  
+00009510: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00009520: 2020 7265 7475 726e 2061 6c6c 280a 2020    return all(.  
+00009530: 2020 2020 2020 2020 2020 636f 756e 7420            count 
+00009540: 3d3d 2030 206f 7220 7374 6174 6520 696e  == 0 or state in
+00009550: 207b 226d 656d 6f72 7922 2c20 2265 7272   {"memory", "err
+00009560: 6564 222c 2022 7265 6c65 6173 6564 222c  ed", "released",
+00009570: 2022 666f 7267 6f74 7465 6e22 7d0a 2020   "forgotten"}.  
+00009580: 2020 2020 2020 2020 2020 666f 7220 7374            for st
+00009590: 6174 652c 2063 6f75 6e74 2069 6e20 7365  ate, count in se
+000095a0: 6c66 2e73 7461 7465 732e 6974 656d 7328  lf.states.items(
+000095b0: 290a 2020 2020 2020 2020 290a 0a0a 636c  ).        )...cl
+000095c0: 6173 7320 5461 736b 5374 6174 653a 0a20  ass TaskState:. 
+000095d0: 2020 2022 2222 4120 7369 6d70 6c65 206f     """A simple o
+000095e0: 626a 6563 7420 686f 6c64 696e 6720 696e  bject holding in
+000095f0: 666f 726d 6174 696f 6e20 6162 6f75 7420  formation about 
+00009600: 6120 7461 736b 2e0a 0a20 2020 204e 6f74  a task...    Not
+00009610: 2074 6f20 6265 2063 6f6e 6675 7365 6420   to be confused 
+00009620: 7769 7468 203a 636c 6173 733a 6064 6973  with :class:`dis
+00009630: 7472 6962 7574 6564 2e77 6f72 6b65 725f  tributed.worker_
+00009640: 7374 6174 655f 6d61 6368 696e 652e 5461  state_machine.Ta
+00009650: 736b 5374 6174 6560 2c20 7768 6963 680a  skState`, which.
+00009660: 2020 2020 686f 6c64 7320 7369 6d69 6c61      holds simila
+00009670: 7220 696e 666f 726d 6174 696f 6e20 6f6e  r information on
+00009680: 2074 6865 2057 6f72 6b65 7220 7369 6465   the Worker side
+00009690: 2e0a 2020 2020 2222 220a 0a20 2020 2023  ..    """..    #
+000096a0: 3a20 5468 6520 6b65 7920 6973 2074 6865  : The key is the
+000096b0: 2075 6e69 7175 6520 6964 656e 7469 6669   unique identifi
+000096c0: 6572 206f 6620 6120 7461 736b 2c20 6765  er of a task, ge
+000096d0: 6e65 7261 6c6c 7920 666f 726d 6564 2066  nerally formed f
+000096e0: 726f 6d20 7468 6520 6e61 6d65 206f 6620  rom the name of 
+000096f0: 7468 650a 2020 2020 233a 2066 756e 6374  the.    #: funct
+00009700: 696f 6e2c 2066 6f6c 6c6f 7765 6420 6279  ion, followed by
+00009710: 2061 2068 6173 6820 6f66 2074 6865 2066   a hash of the f
+00009720: 756e 6374 696f 6e20 616e 6420 6172 6775  unction and argu
+00009730: 6d65 6e74 732c 206c 696b 650a 2020 2020  ments, like.    
+00009740: 233a 2060 6027 696e 632d 6162 3331 6330  #: ``'inc-ab31c0
+00009750: 3130 3434 3439 3737 3030 3464 3635 3636  10444977004d6566
+00009760: 3130 6432 6434 3231 6563 2760 602e 0a20  10d2d421ec'``.. 
+00009770: 2020 206b 6579 3a20 4b65 790a 0a20 2020     key: Key..   
+00009780: 2023 3a20 5468 6520 6272 6f61 6420 636c   #: The broad cl
+00009790: 6173 7320 6f66 2074 6173 6b73 2074 6f20  ass of tasks to 
+000097a0: 7768 6963 6820 7468 6973 2074 6173 6b20  which this task 
+000097b0: 6265 6c6f 6e67 7320 6c69 6b65 2022 696e  belongs like "in
+000097c0: 6322 206f 7220 2272 6561 645f 6373 7622  c" or "read_csv"
+000097d0: 0a20 2020 2070 7265 6669 783a 2054 6173  .    prefix: Tas
+000097e0: 6b50 7265 6669 780a 0a20 2020 2023 3a20  kPrefix..    #: 
+000097f0: 4120 7370 6563 6966 6963 6174 696f 6e20  A specification 
+00009800: 6f66 2068 6f77 2074 6f20 7275 6e20 7468  of how to run th
+00009810: 6520 7461 736b 2e20 2054 6865 2074 7970  e task.  The typ
+00009820: 6520 616e 6420 6d65 616e 696e 6720 6f66  e and meaning of
+00009830: 2074 6869 7320 7661 6c75 6520 6973 0a20   this value is. 
+00009840: 2020 2023 3a20 6f70 6171 7565 2074 6f20     #: opaque to 
+00009850: 7468 6520 7363 6865 6475 6c65 722c 2061  the scheduler, a
+00009860: 7320 6974 2069 7320 6f6e 6c79 2069 6e74  s it is only int
+00009870: 6572 7072 6574 6564 2062 7920 7468 6520  erpreted by the 
+00009880: 776f 726b 6572 2074 6f20 7768 6963 6820  worker to which 
+00009890: 7468 650a 2020 2020 233a 2074 6173 6b20  the.    #: task 
+000098a0: 6973 2073 656e 7420 666f 7220 6578 6563  is sent for exec
+000098b0: 7574 696e 672e 0a20 2020 2023 3a0a 2020  uting..    #:.  
+000098c0: 2020 233a 2041 7320 6120 7370 6563 6961    #: As a specia
+000098d0: 6c20 6361 7365 2c20 7468 6973 2061 7474  l case, this att
+000098e0: 7269 6275 7465 206d 6179 2061 6c73 6f20  ribute may also 
+000098f0: 6265 2060 604e 6f6e 6560 602c 2069 6e20  be ``None``, in 
+00009900: 7768 6963 6820 6361 7365 2074 6865 2074  which case the t
+00009910: 6173 6b20 6973 0a20 2020 2023 3a20 2270  ask is.    #: "p
+00009920: 7572 6520 6461 7461 2220 2873 7563 6820  ure data" (such 
+00009930: 6173 2c20 666f 7220 6578 616d 706c 652c  as, for example,
+00009940: 2061 2070 6965 6365 206f 6620 6461 7461   a piece of data
+00009950: 206c 6f61 6465 6420 696e 2074 6865 2073   loaded in the s
+00009960: 6368 6564 756c 6572 2075 7369 6e67 0a20  cheduler using. 
+00009970: 2020 2023 3a20 3a6d 6574 683a 6043 6c69     #: :meth:`Cli
+00009980: 656e 742e 7363 6174 7465 7260 292e 2020  ent.scatter`).  
+00009990: 4120 2270 7572 6520 6461 7461 2220 7461  A "pure data" ta
+000099a0: 736b 2063 616e 6e6f 7420 6265 2063 6f6d  sk cannot be com
+000099b0: 7075 7465 6420 6167 6169 6e20 6966 2069  puted again if i
+000099c0: 7473 0a20 2020 2023 3a20 7661 6c75 6520  ts.    #: value 
+000099d0: 6973 206c 6f73 742e 0a20 2020 2072 756e  is lost..    run
+000099e0: 5f73 7065 633a 2054 5f72 756e 7370 6563  _spec: T_runspec
+000099f0: 207c 204e 6f6e 650a 0a20 2020 2023 3a20   | None..    #: 
+00009a00: 5468 6520 7072 696f 7269 7479 2070 726f  The priority pro
+00009a10: 7669 6465 7320 6561 6368 2074 6173 6b20  vides each task 
+00009a20: 7769 7468 2061 2072 656c 6174 6976 6520  with a relative 
+00009a30: 7261 6e6b 696e 6720 7768 6963 6820 6973  ranking which is
+00009a40: 2075 7365 6420 746f 2062 7265 616b 0a20   used to break. 
+00009a50: 2020 2023 3a20 7469 6573 2077 6865 6e20     #: ties when 
+00009a60: 6d61 6e79 2074 6173 6b73 2061 7265 2062  many tasks are b
+00009a70: 6569 6e67 2063 6f6e 7369 6465 7265 6420  eing considered 
+00009a80: 666f 7220 6578 6563 7574 696f 6e2e 0a20  for execution.. 
+00009a90: 2020 2023 3a0a 2020 2020 233a 2054 6869     #:.    #: Thi
+00009aa0: 7320 7261 6e6b 696e 6720 6973 2067 656e  s ranking is gen
+00009ab0: 6572 616c 6c79 2061 2032 2d69 7465 6d20  erally a 2-item 
+00009ac0: 7475 706c 652e 2020 5468 6520 6669 7273  tuple.  The firs
+00009ad0: 7420 2861 6e64 2064 6f6d 696e 616e 7429  t (and dominant)
+00009ae0: 2069 7465 6d0a 2020 2020 233a 2063 6f72   item.    #: cor
+00009af0: 7265 7370 6f6e 6473 2074 6f20 7768 656e  responds to when
+00009b00: 2069 7420 7761 7320 7375 626d 6974 7465   it was submitte
+00009b10: 642e 2020 4765 6e65 7261 6c6c 792c 2065  d.  Generally, e
+00009b20: 6172 6c69 6572 2074 6173 6b73 2074 616b  arlier tasks tak
+00009b30: 6520 7072 6563 6564 656e 6365 2e0a 2020  e precedence..  
+00009b40: 2020 233a 2054 6865 2073 6563 6f6e 6420    #: The second 
+00009b50: 6974 656d 2069 7320 6465 7465 726d 696e  item is determin
+00009b60: 6564 2062 7920 7468 6520 636c 6965 6e74  ed by the client
+00009b70: 2c20 616e 6420 6973 2061 2077 6179 2074  , and is a way t
+00009b80: 6f20 7072 696f 7269 7469 7a65 2074 6173  o prioritize tas
+00009b90: 6b73 0a20 2020 2023 3a20 7769 7468 696e  ks.    #: within
+00009ba0: 2061 206c 6172 6765 2067 7261 7068 2074   a large graph t
+00009bb0: 6861 7420 6d61 7920 6265 2069 6d70 6f72  hat may be impor
+00009bc0: 7461 6e74 2c20 7375 6368 2061 7320 6966  tant, such as if
+00009bd0: 2074 6865 7920 6172 6520 6f6e 2074 6865   they are on the
+00009be0: 2063 7269 7469 6361 6c0a 2020 2020 233a   critical.    #:
+00009bf0: 2070 6174 682c 206f 7220 676f 6f64 2074   path, or good t
+00009c00: 6f20 7275 6e20 696e 206f 7264 6572 2074  o run in order t
+00009c10: 6f20 7265 6c65 6173 6520 6d61 6e79 2064  o release many d
+00009c20: 6570 656e 6465 6e63 6965 732e 2020 5468  ependencies.  Th
+00009c30: 6973 2069 7320 6578 706c 6169 6e65 640a  is is explained.
+00009c40: 2020 2020 233a 2066 7572 7468 6572 2069      #: further i
+00009c50: 6e20 3a64 6f63 3a60 5363 6865 6475 6c69  n :doc:`Scheduli
+00009c60: 6e67 2050 6f6c 6963 7920 3c73 6368 6564  ng Policy <sched
+00009c70: 756c 696e 672d 706f 6c69 6369 6573 3e60  uling-policies>`
+00009c80: 2e0a 2020 2020 7072 696f 7269 7479 3a20  ..    priority: 
+00009c90: 7475 706c 655b 666c 6f61 742c 202e 2e2e  tuple[float, ...
+00009ca0: 5d20 7c20 4e6f 6e65 0a0a 2020 2020 2320  ] | None..    # 
+00009cb0: 4174 7472 6962 7574 6520 756e 6465 726c  Attribute underl
+00009cc0: 7969 6e67 2074 6865 2073 7461 7465 2070  ying the state p
+00009cd0: 726f 7065 7274 790a 2020 2020 5f73 7461  roperty.    _sta
+00009ce0: 7465 3a20 5461 736b 5374 6174 6553 7461  te: TaskStateSta
+00009cf0: 7465 0a0a 2020 2020 233a 2054 6865 2073  te..    #: The s
+00009d00: 6574 206f 6620 7461 736b 7320 7468 6973  et of tasks this
+00009d10: 2074 6173 6b20 6465 7065 6e64 7320 6f6e   task depends on
+00009d20: 2066 6f72 2070 726f 7065 7220 6578 6563   for proper exec
+00009d30: 7574 696f 6e2e 204f 6e6c 7920 7461 736b  ution. Only task
+00009d40: 7320 7374 696c 6c0a 2020 2020 233a 2061  s still.    #: a
+00009d50: 6c69 7665 2061 7265 206c 6973 7465 6420  live are listed 
+00009d60: 696e 2074 6869 7320 7365 742e 2049 662c  in this set. If,
+00009d70: 2066 6f72 2077 6861 7465 7665 7220 7265   for whatever re
+00009d80: 6173 6f6e 2c20 7468 6973 2074 6173 6b20  ason, this task 
+00009d90: 616c 736f 2064 6570 656e 6473 206f 6e0a  also depends on.
+00009da0: 2020 2020 233a 2061 2066 6f72 676f 7474      #: a forgott
+00009db0: 656e 2074 6173 6b2c 2074 6865 203a 6174  en task, the :at
+00009dc0: 7472 3a60 6861 735f 6c6f 7374 5f64 6570  tr:`has_lost_dep
+00009dd0: 656e 6465 6e63 6965 7360 2066 6c61 6720  endencies` flag 
+00009de0: 6973 2073 6574 2e0a 2020 2020 233a 0a20  is set..    #:. 
+00009df0: 2020 2023 3a20 4120 7461 736b 2063 616e     #: A task can
+00009e00: 206f 6e6c 7920 6265 2065 7865 6375 7465   only be execute
+00009e10: 6420 6f6e 6365 2061 6c6c 2069 7473 2064  d once all its d
+00009e20: 6570 656e 6465 6e63 6965 7320 6861 7665  ependencies have
+00009e30: 2061 6c72 6561 6479 2062 6565 6e0a 2020   already been.  
+00009e40: 2020 233a 2073 7563 6365 7373 6675 6c6c    #: successfull
+00009e50: 7920 6578 6563 7574 6564 2061 6e64 2068  y executed and h
+00009e60: 6176 6520 7468 6569 7220 7265 7375 6c74  ave their result
+00009e70: 2073 746f 7265 6420 6f6e 2061 7420 6c65   stored on at le
+00009e80: 6173 7420 6f6e 6520 776f 726b 6572 2e20  ast one worker. 
+00009e90: 5468 6973 0a20 2020 2023 3a20 6973 2074  This.    #: is t
+00009ea0: 7261 636b 6564 2062 7920 7072 6f67 7265  racked by progre
+00009eb0: 7373 6976 656c 7920 6472 6169 6e69 6e67  ssively draining
+00009ec0: 2074 6865 203a 6174 7472 3a60 7761 6974   the :attr:`wait
+00009ed0: 696e 675f 6f6e 6020 7365 742e 0a20 2020  ing_on` set..   
+00009ee0: 2064 6570 656e 6465 6e63 6965 733a 2073   dependencies: s
+00009ef0: 6574 5b54 6173 6b53 7461 7465 5d0a 0a20  et[TaskState].. 
+00009f00: 2020 2023 3a20 5468 6520 7365 7420 6f66     #: The set of
+00009f10: 2074 6173 6b73 2077 6869 6368 2064 6570   tasks which dep
+00009f20: 656e 6420 6f6e 2074 6869 7320 7461 736b  end on this task
+00009f30: 2e20 204f 6e6c 7920 7461 736b 7320 7374  .  Only tasks st
+00009f40: 696c 6c20 616c 6976 6520 6172 6520 6c69  ill alive are li
+00009f50: 7374 6564 2069 6e0a 2020 2020 233a 2074  sted in.    #: t
+00009f60: 6869 7320 7365 742e 2054 6869 7320 6973  his set. This is
+00009f70: 2074 6865 2072 6576 6572 7365 206d 6170   the reverse map
+00009f80: 7069 6e67 206f 6620 3a61 7474 723a 6064  ping of :attr:`d
+00009f90: 6570 656e 6465 6e63 6965 7360 2e0a 2020  ependencies`..  
+00009fa0: 2020 6465 7065 6e64 656e 7473 3a20 7365    dependents: se
+00009fb0: 745b 5461 736b 5374 6174 655d 0a0a 2020  t[TaskState]..  
+00009fc0: 2020 233a 2057 6865 7468 6572 2061 6e79    #: Whether any
+00009fd0: 206f 6620 7468 6520 6465 7065 6e64 656e   of the dependen
+00009fe0: 6369 6573 206f 6620 7468 6973 2074 6173  cies of this tas
+00009ff0: 6b20 6861 7320 6265 656e 2066 6f72 676f  k has been forgo
+0000a000: 7474 656e 2e20 466f 7220 6d65 6d6f 7279  tten. For memory
+0000a010: 0a20 2020 2023 3a20 636f 6e73 756d 7074  .    #: consumpt
+0000a020: 696f 6e20 7265 6173 6f6e 732c 2066 6f72  ion reasons, for
+0000a030: 676f 7474 656e 2074 6173 6b73 2061 7265  gotten tasks are
+0000a040: 206e 6f74 206b 6570 7420 696e 206d 656d   not kept in mem
+0000a050: 6f72 7920 6576 656e 2074 686f 7567 6820  ory even though 
+0000a060: 7468 6579 206d 6179 0a20 2020 2023 3a20  they may.    #: 
+0000a070: 6861 7665 2064 6570 656e 6465 6e74 2074  have dependent t
+0000a080: 6173 6b73 2e20 2057 6865 6e20 6120 7461  asks.  When a ta
+0000a090: 736b 2069 7320 666f 7267 6f74 7465 6e2c  sk is forgotten,
+0000a0a0: 2074 6865 7265 666f 7265 2c20 6561 6368   therefore, each
+0000a0b0: 206f 6620 6974 730a 2020 2020 233a 2064   of its.    #: d
+0000a0c0: 6570 656e 6465 6e74 7320 6861 7320 7468  ependents has th
+0000a0d0: 6569 7220 3a61 7474 723a 6068 6173 5f6c  eir :attr:`has_l
+0000a0e0: 6f73 745f 6465 7065 6e64 656e 6369 6573  ost_dependencies
+0000a0f0: 6020 6174 7472 6962 7574 6520 7365 7420  ` attribute set 
+0000a100: 746f 2060 6054 7275 6560 602e 0a20 2020  to ``True``..   
+0000a110: 2023 3a0a 2020 2020 233a 2049 6620 3a61   #:.    #: If :a
+0000a120: 7474 723a 6068 6173 5f6c 6f73 745f 6465  ttr:`has_lost_de
+0000a130: 7065 6e64 656e 6369 6573 6020 6973 2074  pendencies` is t
+0000a140: 7275 652c 2074 6869 7320 7461 736b 2063  rue, this task c
+0000a150: 616e 6e6f 7420 676f 2069 6e74 6f20 7468  annot go into th
+0000a160: 650a 2020 2020 233a 2022 7072 6f63 6573  e.    #: "proces
+0000a170: 7369 6e67 2220 7374 6174 6520 616e 796d  sing" state anym
+0000a180: 6f72 652e 0a20 2020 2068 6173 5f6c 6f73  ore..    has_los
+0000a190: 745f 6465 7065 6e64 656e 6369 6573 3a20  t_dependencies: 
+0000a1a0: 626f 6f6c 0a0a 2020 2020 233a 2054 6865  bool..    #: The
+0000a1b0: 2073 6574 206f 6620 7461 736b 7320 7468   set of tasks th
+0000a1c0: 6973 2074 6173 6b20 6973 2077 6169 7469  is task is waiti
+0000a1d0: 6e67 206f 6e20 2a62 6566 6f72 652a 2069  ng on *before* i
+0000a1e0: 7420 6361 6e20 6265 2065 7865 6375 7465  t can be execute
+0000a1f0: 642e 2054 6869 7320 6973 0a20 2020 2023  d. This is.    #
+0000a200: 3a20 616c 7761 7973 2061 2073 7562 7365  : always a subse
+0000a210: 7420 6f66 203a 6174 7472 3a60 6465 7065  t of :attr:`depe
+0000a220: 6e64 656e 6369 6573 602e 2020 4561 6368  ndencies`.  Each
+0000a230: 2074 696d 6520 6f6e 6520 6f66 2074 6865   time one of the
+0000a240: 2064 6570 656e 6465 6e63 6965 7320 6861   dependencies ha
+0000a250: 730a 2020 2020 233a 2066 696e 6973 6865  s.    #: finishe
+0000a260: 6420 7072 6f63 6573 7369 6e67 2c20 6974  d processing, it
+0000a270: 2069 7320 7265 6d6f 7665 6420 6672 6f6d   is removed from
+0000a280: 2074 6865 203a 6174 7472 3a60 7761 6974   the :attr:`wait
+0000a290: 696e 675f 6f6e 6020 7365 742e 0a20 2020  ing_on` set..   
+0000a2a0: 2023 3a0a 2020 2020 233a 204f 6e63 6520   #:.    #: Once 
+0000a2b0: 3a61 7474 723a 6077 6169 7469 6e67 5f6f  :attr:`waiting_o
+0000a2c0: 6e60 2062 6563 6f6d 6573 2065 6d70 7479  n` becomes empty
+0000a2d0: 2c20 7468 6973 2074 6173 6b20 6361 6e20  , this task can 
+0000a2e0: 6d6f 7665 2066 726f 6d20 7468 6520 2277  move from the "w
+0000a2f0: 6169 7469 6e67 220a 2020 2020 233a 2073  aiting".    #: s
+0000a300: 7461 7465 2074 6f20 7468 6520 2270 726f  tate to the "pro
+0000a310: 6365 7373 696e 6722 2073 7461 7465 2028  cessing" state (
+0000a320: 756e 6c65 7373 206f 6e65 206f 6620 7468  unless one of th
+0000a330: 6520 6465 7065 6e64 656e 6369 6573 2065  e dependencies e
+0000a340: 7272 6f72 6564 206f 7574 2c20 696e 0a20  rrored out, in. 
+0000a350: 2020 2023 3a20 7768 6963 6820 6361 7365     #: which case
+0000a360: 2074 6869 7320 7461 736b 2069 7320 696e   this task is in
+0000a370: 7374 6561 6420 6d61 726b 6564 2022 6572  stead marked "er
+0000a380: 7265 6422 292e 0a20 2020 2077 6169 7469  red")..    waiti
+0000a390: 6e67 5f6f 6e3a 2073 6574 5b54 6173 6b53  ng_on: set[TaskS
+0000a3a0: 7461 7465 5d20 7c20 4e6f 6e65 0a0a 2020  tate] | None..  
+0000a3b0: 2020 233a 2054 6865 2073 6574 206f 6620    #: The set of 
+0000a3c0: 7461 736b 7320 7768 6963 6820 6e65 6564  tasks which need
+0000a3d0: 2074 6869 7320 7461 736b 2074 6f20 7265   this task to re
+0000a3e0: 6d61 696e 2061 6c69 7665 2e20 2054 6869  main alive.  Thi
+0000a3f0: 7320 6973 2061 6c77 6179 7320 6120 7375  s is always a su
+0000a400: 6273 6574 0a20 2020 2023 3a20 6f66 203a  bset.    #: of :
+0000a410: 6174 7472 3a60 6465 7065 6e64 656e 7473  attr:`dependents
+0000a420: 602e 2020 4561 6368 2074 696d 6520 6f6e  `.  Each time on
+0000a430: 6520 6f66 2074 6865 2064 6570 656e 6465  e of the depende
+0000a440: 6e74 7320 6861 7320 6669 6e69 7368 6564  nts has finished
+0000a450: 2070 726f 6365 7373 696e 672c 0a20 2020   processing,.   
+0000a460: 2023 3a20 6974 2069 7320 7265 6d6f 7665   #: it is remove
+0000a470: 6420 6672 6f6d 2074 6865 203a 6174 7472  d from the :attr
+0000a480: 3a60 7761 6974 6572 7360 2073 6574 2e0a  :`waiters` set..
+0000a490: 2020 2020 233a 0a20 2020 2023 3a20 4f6e      #:.    #: On
+0000a4a0: 6365 2062 6f74 6820 3a61 7474 723a 6077  ce both :attr:`w
+0000a4b0: 6169 7465 7273 6020 616e 6420 3a61 7474  aiters` and :att
+0000a4c0: 723a 6077 686f 5f77 616e 7473 6020 6265  r:`who_wants` be
+0000a4d0: 636f 6d65 2065 6d70 7479 2c20 7468 6973  come empty, this
+0000a4e0: 2074 6173 6b20 6361 6e20 6265 0a20 2020   task can be.   
+0000a4f0: 2023 3a20 7265 6c65 6173 6564 2028 6966   #: released (if
+0000a500: 2069 7420 6861 7320 6120 6e6f 6e2d 656d   it has a non-em
+0000a510: 7074 7920 3a61 7474 723a 6072 756e 5f73  pty :attr:`run_s
+0000a520: 7065 6360 2920 6f72 2066 6f72 676f 7474  pec`) or forgott
+0000a530: 656e 2028 6f74 6865 7277 6973 6529 2062  en (otherwise) b
+0000a540: 7920 7468 650a 2020 2020 233a 2073 6368  y the.    #: sch
+0000a550: 6564 756c 6572 2c20 616e 6420 6279 2061  eduler, and by a
+0000a560: 6e79 2077 6f72 6b65 7273 2069 6e20 3a61  ny workers in :a
+0000a570: 7474 723a 6077 686f 5f68 6173 602e 0a20  ttr:`who_has`.. 
+0000a580: 2020 2023 3a0a 2020 2020 233a 202e 2e20     #:.    #: .. 
+0000a590: 6e6f 7465 3a3a 0a20 2020 2023 3a20 2020  note::.    #:   
+0000a5a0: 2043 6f75 6e74 6572 2d69 6e74 7569 7469   Counter-intuiti
+0000a5b0: 7665 6c79 2c20 3a61 7474 723a 6077 6169  vely, :attr:`wai
+0000a5c0: 7469 6e67 5f6f 6e60 2061 6e64 203a 6174  ting_on` and :at
+0000a5d0: 7472 3a60 7761 6974 6572 7360 2061 7265  tr:`waiters` are
+0000a5e0: 206e 6f74 2072 6576 6572 7365 0a20 2020   not reverse.   
+0000a5f0: 2023 3a20 2020 206d 6170 7069 6e67 7320   #:    mappings 
+0000a600: 6f66 2065 6163 6820 6f74 6865 722e 0a20  of each other.. 
+0000a610: 2020 2077 6169 7465 7273 3a20 7365 745b     waiters: set[
+0000a620: 5461 736b 5374 6174 655d 207c 204e 6f6e  TaskState] | Non
+0000a630: 650a 0a20 2020 2023 3a20 5468 6520 7365  e..    #: The se
+0000a640: 7420 6f66 2063 6c69 656e 7473 2077 686f  t of clients who
+0000a650: 2077 616e 7420 7468 6520 7265 7375 6c74   want the result
+0000a660: 206f 6620 7468 6973 2074 6173 6b20 746f   of this task to
+0000a670: 2072 656d 6169 6e20 616c 6976 652e 0a20   remain alive.. 
+0000a680: 2020 2023 3a20 5468 6973 2069 7320 7468     #: This is th
+0000a690: 6520 7265 7665 7273 6520 6d61 7070 696e  e reverse mappin
+0000a6a0: 6720 6f66 203a 6174 7472 3a60 436c 6965  g of :attr:`Clie
+0000a6b0: 6e74 5374 6174 652e 7761 6e74 735f 7768  ntState.wants_wh
+0000a6c0: 6174 602e 0a20 2020 2023 3a0a 2020 2020  at`..    #:.    
+0000a6d0: 233a 2057 6865 6e20 6120 636c 6965 6e74  #: When a client
+0000a6e0: 2073 7562 6d69 7473 2061 2067 7261 7068   submits a graph
+0000a6f0: 2074 6f20 7468 6520 7363 6865 6475 6c65   to the schedule
+0000a700: 7220 6974 2061 6c73 6f20 7370 6563 6966  r it also specif
+0000a710: 6965 7320 7768 6963 6820 6f75 7470 7574  ies which output
+0000a720: 0a20 2020 2023 3a20 7461 736b 7320 6974  .    #: tasks it
+0000a730: 2064 6573 6972 6573 2c20 7375 6368 2074   desires, such t
+0000a740: 6861 7420 7468 6569 7220 7265 7375 6c74  hat their result
+0000a750: 7320 6172 6520 6e6f 7420 7265 6c65 6173  s are not releas
+0000a760: 6564 2066 726f 6d20 6d65 6d6f 7279 2e0a  ed from memory..
+0000a770: 2020 2020 233a 0a20 2020 2023 3a20 4f6e      #:.    #: On
+0000a780: 6365 2061 2074 6173 6b20 6861 7320 6669  ce a task has fi
+0000a790: 6e69 7368 6564 2065 7865 6375 7469 6e67  nished executing
+0000a7a0: 2028 692e 652e 206d 6f76 6573 2069 6e74   (i.e. moves int
+0000a7b0: 6f20 7468 6520 226d 656d 6f72 7922 206f  o the "memory" o
+0000a7c0: 7220 2265 7272 6564 220a 2020 2020 233a  r "erred".    #:
+0000a7d0: 2073 7461 7465 292c 2074 6865 2063 6c69   state), the cli
+0000a7e0: 656e 7473 2069 6e20 3a61 7474 723a 6077  ents in :attr:`w
+0000a7f0: 686f 5f77 616e 7473 6020 6172 6520 6e6f  ho_wants` are no
+0000a800: 7469 6669 6564 2e0a 2020 2020 233a 0a20  tified..    #:. 
+0000a810: 2020 2023 3a20 4f6e 6365 2062 6f74 6820     #: Once both 
+0000a820: 3a61 7474 723a 6077 6169 7465 7273 6020  :attr:`waiters` 
+0000a830: 616e 6420 3a61 7474 723a 6077 686f 5f77  and :attr:`who_w
+0000a840: 616e 7473 6020 6265 636f 6d65 2065 6d70  ants` become emp
+0000a850: 7479 2c20 7468 6973 2074 6173 6b20 6361  ty, this task ca
+0000a860: 6e20 6265 0a20 2020 2023 3a20 7265 6c65  n be.    #: rele
+0000a870: 6173 6564 2028 6966 2069 7420 6861 7320  ased (if it has 
+0000a880: 6120 6e6f 6e2d 656d 7074 7920 3a61 7474  a non-empty :att
+0000a890: 723a 6072 756e 5f73 7065 6360 2920 6f72  r:`run_spec`) or
+0000a8a0: 2066 6f72 676f 7474 656e 2028 6f74 6865   forgotten (othe
+0000a8b0: 7277 6973 6529 2062 7920 7468 650a 2020  rwise) by the.  
+0000a8c0: 2020 233a 2073 6368 6564 756c 6572 2c20    #: scheduler, 
+0000a8d0: 616e 6420 6279 2061 6e79 2077 6f72 6b65  and by any worke
+0000a8e0: 7273 2069 6e20 3a61 7474 723a 6077 686f  rs in :attr:`who
+0000a8f0: 5f68 6173 602e 0a20 2020 2077 686f 5f77  _has`..    who_w
+0000a900: 616e 7473 3a20 7365 745b 436c 6965 6e74  ants: set[Client
+0000a910: 5374 6174 655d 207c 204e 6f6e 650a 0a20  State] | None.. 
+0000a920: 2020 2023 3a20 5468 6520 7365 7420 6f66     #: The set of
+0000a930: 2077 6f72 6b65 7273 2077 686f 2068 6176   workers who hav
+0000a940: 6520 7468 6973 2074 6173 6b27 7320 7265  e this task's re
+0000a950: 7375 6c74 2069 6e20 6d65 6d6f 7279 2e20  sult in memory. 
+0000a960: 4974 2069 7320 6e6f 6e2d 656d 7074 7920  It is non-empty 
+0000a970: 6966 6620 7468 650a 2020 2020 233a 2074  iff the.    #: t
+0000a980: 6173 6b20 6973 2069 6e20 7468 6520 226d  ask is in the "m
+0000a990: 656d 6f72 7922 2073 7461 7465 2e20 2054  emory" state.  T
+0000a9a0: 6865 7265 2063 616e 2062 6520 6d6f 7265  here can be more
+0000a9b0: 2074 6861 6e20 6f6e 6520 776f 726b 6572   than one worker
+0000a9c0: 2069 6e20 7468 6973 2073 6574 2069 662c   in this set if,
+0000a9d0: 0a20 2020 2023 3a20 666f 7220 6578 616d  .    #: for exam
+0000a9e0: 706c 652c 203a 6d65 7468 3a60 436c 6965  ple, :meth:`Clie
+0000a9f0: 6e74 2e73 6361 7474 6572 6020 6f72 203a  nt.scatter` or :
+0000aa00: 6d65 7468 3a60 436c 6965 6e74 2e72 6570  meth:`Client.rep
+0000aa10: 6c69 6361 7465 6020 7761 7320 7573 6564  licate` was used
+0000aa20: 2e0a 2020 2020 233a 0a20 2020 2023 3a20  ..    #:.    #: 
+0000aa30: 5468 6973 2069 7320 7468 6520 7265 7665  This is the reve
+0000aa40: 7273 6520 6d61 7070 696e 6720 6f66 203a  rse mapping of :
+0000aa50: 6174 7472 3a60 576f 726b 6572 5374 6174  attr:`WorkerStat
+0000aa60: 652e 6861 735f 7768 6174 602e 0a20 2020  e.has_what`..   
+0000aa70: 2077 686f 5f68 6173 3a20 7365 745b 576f   who_has: set[Wo
+0000aa80: 726b 6572 5374 6174 655d 207c 204e 6f6e  rkerState] | Non
+0000aa90: 650a 0a20 2020 2023 3a20 4966 2074 6869  e..    #: If thi
+0000aaa0: 7320 7461 736b 2069 7320 696e 2074 6865  s task is in the
+0000aab0: 2022 7072 6f63 6573 7369 6e67 2220 7374   "processing" st
+0000aac0: 6174 652c 2077 6869 6368 2077 6f72 6b65  ate, which worke
+0000aad0: 7220 6973 2063 7572 7265 6e74 6c79 2070  r is currently p
+0000aae0: 726f 6365 7373 696e 670a 2020 2020 233a  rocessing.    #:
+0000aaf0: 2069 742e 2054 6869 7320 6174 7472 6962   it. This attrib
+0000ab00: 7574 6520 6973 206b 6570 7420 696e 2073  ute is kept in s
+0000ab10: 796e 6320 7769 7468 203a 6174 7472 3a60  ync with :attr:`
+0000ab20: 576f 726b 6572 5374 6174 652e 7072 6f63  WorkerState.proc
+0000ab30: 6573 7369 6e67 602e 0a20 2020 2070 726f  essing`..    pro
+0000ab40: 6365 7373 696e 675f 6f6e 3a20 576f 726b  cessing_on: Work
+0000ab50: 6572 5374 6174 6520 7c20 4e6f 6e65 0a0a  erState | None..
+0000ab60: 2020 2020 233a 2054 6865 206e 756d 6265      #: The numbe
+0000ab70: 7220 6f66 2074 696d 6573 2074 6869 7320  r of times this 
+0000ab80: 7461 736b 2063 616e 2061 7574 6f6d 6174  task can automat
+0000ab90: 6963 616c 6c79 2062 6520 7265 7472 6965  ically be retrie
+0000aba0: 6420 696e 2063 6173 6520 6f66 2066 6169  d in case of fai
+0000abb0: 6c75 7265 2e0a 2020 2020 233a 2049 6620  lure..    #: If 
+0000abc0: 6120 7461 736b 2066 6169 6c73 2065 7865  a task fails exe
+0000abd0: 6375 7469 6e67 2028 7468 6520 776f 726b  cuting (the work
+0000abe0: 6572 2072 6574 7572 6e73 2077 6974 6820  er returns with 
+0000abf0: 616e 2065 7272 6f72 292c 2069 7473 203a  an error), its :
+0000ac00: 6174 7472 3a60 7265 7472 6965 7360 0a20  attr:`retries`. 
+0000ac10: 2020 2023 3a20 6174 7472 6962 7574 6520     #: attribute 
+0000ac20: 6973 2063 6865 636b 6564 2e20 4966 2069  is checked. If i
+0000ac30: 7420 6973 2065 7175 616c 2074 6f20 302c  t is equal to 0,
+0000ac40: 2074 6865 2074 6173 6b20 6973 206d 6172   the task is mar
+0000ac50: 6b65 6420 2265 7272 6564 222e 2049 6620  ked "erred". If 
+0000ac60: 6974 2069 730a 2020 2020 233a 2067 7265  it is.    #: gre
+0000ac70: 6174 6572 2074 6861 6e20 302c 2074 6865  ater than 0, the
+0000ac80: 203a 6174 7472 3a60 7265 7472 6965 7360   :attr:`retries`
+0000ac90: 2061 7474 7269 6275 7465 2069 7320 6465   attribute is de
+0000aca0: 6372 656d 656e 7465 6420 616e 6420 6578  cremented and ex
+0000acb0: 6563 7574 696f 6e20 6973 0a20 2020 2023  ecution is.    #
+0000acc0: 3a20 6174 7465 6d70 7465 6420 6167 6169  : attempted agai
+0000acd0: 6e2e 0a20 2020 2072 6574 7269 6573 3a20  n..    retries: 
+0000ace0: 696e 740a 0a20 2020 2023 3a20 5468 6520  int..    #: The 
+0000acf0: 6e75 6d62 6572 206f 6620 6279 7465 732c  number of bytes,
+0000ad00: 2061 7320 6465 7465 726d 696e 6564 2062   as determined b
+0000ad10: 7920 6060 7369 7a65 6f66 6060 2c20 6f66  y ``sizeof``, of
+0000ad20: 2074 6865 2072 6573 756c 7420 6f66 2061   the result of a
+0000ad30: 2066 696e 6973 6865 640a 2020 2020 233a   finished.    #:
+0000ad40: 2074 6173 6b2e 2054 6869 7320 6e75 6d62   task. This numb
+0000ad50: 6572 2069 7320 7573 6564 2066 6f72 2064  er is used for d
+0000ad60: 6961 676e 6f73 7469 6373 2061 6e64 2074  iagnostics and t
+0000ad70: 6f20 6865 6c70 2070 7269 6f72 6974 697a  o help prioritiz
+0000ad80: 6520 776f 726b 2e0a 2020 2020 233a 2053  e work..    #: S
+0000ad90: 6574 2074 6f20 2d31 2066 6f72 2075 6e66  et to -1 for unf
+0000ada0: 696e 6973 6865 6420 7461 736b 732e 0a20  inished tasks.. 
+0000adb0: 2020 206e 6279 7465 733a 2069 6e74 0a0a     nbytes: int..
+0000adc0: 2020 2020 233a 2054 6865 2074 7970 6520      #: The type 
+0000add0: 6f66 2074 6865 206f 626a 6563 7420 6173  of the object as
+0000ade0: 2061 2073 7472 696e 672e 204f 6e6c 7920   a string. Only 
+0000adf0: 7072 6573 656e 7420 666f 7220 7461 736b  present for task
+0000ae00: 7320 7468 6174 2068 6176 6520 6265 656e  s that have been
+0000ae10: 0a20 2020 2023 3a20 636f 6d70 7574 6564  .    #: computed
+0000ae20: 2e0a 2020 2020 7479 7065 3a20 7374 720a  ..    type: str.
+0000ae30: 0a20 2020 2023 3a20 4966 2074 6869 7320  .    #: If this 
+0000ae40: 7461 736b 2066 6169 6c65 6420 6578 6563  task failed exec
+0000ae50: 7574 696e 672c 2074 6865 2065 7863 6570  uting, the excep
+0000ae60: 7469 6f6e 206f 626a 6563 7420 6973 2073  tion object is s
+0000ae70: 746f 7265 6420 6865 7265 2e0a 2020 2020  tored here..    
+0000ae80: 6578 6365 7074 696f 6e3a 2053 6572 6961  exception: Seria
+0000ae90: 6c69 7a65 6420 7c20 4e6f 6e65 0a0a 2020  lized | None..  
+0000aea0: 2020 233a 2049 6620 7468 6973 2074 6173    #: If this tas
+0000aeb0: 6b20 6661 696c 6564 2065 7865 6375 7469  k failed executi
+0000aec0: 6e67 2c20 7468 6520 7472 6163 6562 6163  ng, the tracebac
+0000aed0: 6b20 6f62 6a65 6374 2069 7320 7374 6f72  k object is stor
+0000aee0: 6564 2068 6572 652e 0a20 2020 2074 7261  ed here..    tra
+0000aef0: 6365 6261 636b 3a20 5365 7269 616c 697a  ceback: Serializ
+0000af00: 6564 207c 204e 6f6e 650a 0a20 2020 2023  ed | None..    #
+0000af10: 3a20 7374 7269 6e67 2072 6570 7265 7365  : string represe
+0000af20: 6e74 6174 696f 6e20 6f66 2065 7863 6570  ntation of excep
+0000af30: 7469 6f6e 0a20 2020 2065 7863 6570 7469  tion.    excepti
+0000af40: 6f6e 5f74 6578 743a 2073 7472 207c 204e  on_text: str | N
+0000af50: 6f6e 650a 0a20 2020 2023 3a20 7374 7269  one..    #: stri
+0000af60: 6e67 2072 6570 7265 7365 6e74 6174 696f  ng representatio
+0000af70: 6e20 6f66 2074 7261 6365 6261 636b 0a20  n of traceback. 
+0000af80: 2020 2074 7261 6365 6261 636b 5f74 6578     traceback_tex
+0000af90: 743a 2073 7472 207c 204e 6f6e 650a 0a20  t: str | None.. 
+0000afa0: 2020 2023 3a20 4966 2074 6869 7320 7461     #: If this ta
+0000afb0: 736b 206f 7220 6f6e 6520 6f66 2069 7473  sk or one of its
+0000afc0: 2064 6570 656e 6465 6e63 6965 7320 6661   dependencies fa
+0000afd0: 696c 6564 2065 7865 6375 7469 6e67 2c20  iled executing, 
+0000afe0: 7468 6520 6661 696c 6564 2074 6173 6b20  the failed task 
+0000aff0: 6973 0a20 2020 2023 3a20 7374 6f72 6564  is.    #: stored
+0000b000: 2068 6572 6520 2870 6f73 7369 626c 7920   here (possibly 
+0000b010: 6974 7365 6c66 292e 0a20 2020 2065 7863  itself)..    exc
+0000b020: 6570 7469 6f6e 5f62 6c61 6d65 3a20 5461  eption_blame: Ta
+0000b030: 736b 5374 6174 6520 7c20 4e6f 6e65 0a0a  skState | None..
+0000b040: 2020 2020 233a 2057 6f72 6b65 7220 6164      #: Worker ad
+0000b050: 6472 6573 7365 7320 6f6e 2077 6869 6368  dresses on which
+0000b060: 2065 7272 6f72 7320 6170 7065 6172 6564   errors appeared
+0000b070: 2c20 6361 7573 696e 6720 7468 6973 2074  , causing this t
+0000b080: 6173 6b20 746f 2062 6520 696e 2061 6e20  ask to be in an 
+0000b090: 6572 726f 720a 2020 2020 233a 2073 7461  error.    #: sta
+0000b0a0: 7465 2e0a 2020 2020 6572 7265 645f 6f6e  te..    erred_on
+0000b0b0: 3a20 7365 745b 7374 725d 207c 204e 6f6e  : set[str] | Non
+0000b0c0: 650a 0a20 2020 2023 3a20 5468 6520 6e75  e..    #: The nu
+0000b0d0: 6d62 6572 206f 6620 7469 6d65 7320 7468  mber of times th
+0000b0e0: 6973 2074 6173 6b20 6861 7320 6265 656e  is task has been
+0000b0f0: 2069 6e76 6f6c 7665 6420 696e 2061 2077   involved in a w
+0000b100: 6f72 6b65 7220 6465 6174 682e 0a20 2020  orker death..   
+0000b110: 2023 3a0a 2020 2020 233a 2053 6f6d 6520   #:.    #: Some 
+0000b120: 7461 736b 7320 6d61 7920 6361 7573 6520  tasks may cause 
+0000b130: 776f 726b 6572 7320 746f 2064 6965 2028  workers to die (
+0000b140: 7375 6368 2061 7320 6361 6c6c 696e 6720  such as calling 
+0000b150: 6060 6f73 2e5f 6578 6974 2830 2960 6029  ``os._exit(0)``)
+0000b160: 2e20 5768 656e 2061 0a20 2020 2023 3a20  . When a.    #: 
+0000b170: 776f 726b 6572 2064 6965 732c 2061 6c6c  worker dies, all
+0000b180: 206f 6620 7468 6520 7461 736b 7320 6f6e   of the tasks on
+0000b190: 2074 6861 7420 776f 726b 6572 2061 7265   that worker are
+0000b1a0: 2072 6561 7373 6967 6e65 6420 746f 206f   reassigned to o
+0000b1b0: 7468 6572 732e 2054 6869 730a 2020 2020  thers. This.    
+0000b1c0: 233a 2063 6f6d 6269 6e61 7469 6f6e 206f  #: combination o
+0000b1d0: 6620 6265 6861 7669 6f72 7320 6361 6e20  f behaviors can 
+0000b1e0: 6361 7573 6520 6120 6261 6420 7461 736b  cause a bad task
+0000b1f0: 2074 6f20 6361 7461 7374 726f 7068 6963   to catastrophic
+0000b200: 616c 6c79 2064 6573 7472 6f79 2061 6c6c  ally destroy all
+0000b210: 0a20 2020 2023 3a20 776f 726b 6572 7320  .    #: workers 
+0000b220: 6f6e 2074 6865 2063 6c75 7374 6572 2c20  on the cluster, 
+0000b230: 6f6e 6520 6166 7465 7220 616e 6f74 6865  one after anothe
+0000b240: 722e 2057 6865 6e65 7665 7220 6120 776f  r. Whenever a wo
+0000b250: 726b 6572 2064 6965 732c 2077 6520 6d61  rker dies, we ma
+0000b260: 726b 2065 6163 680a 2020 2020 233a 2074  rk each.    #: t
+0000b270: 6173 6b20 6375 7272 656e 746c 7920 7072  ask currently pr
+0000b280: 6f63 6573 7369 6e67 206f 6e20 7468 6174  ocessing on that
+0000b290: 2077 6f72 6b65 7220 2861 7320 7265 636f   worker (as reco
+0000b2a0: 7264 6564 2062 790a 2020 2020 233a 203a  rded by.    #: :
+0000b2b0: 6174 7472 3a60 576f 726b 6572 5374 6174  attr:`WorkerStat
+0000b2c0: 652e 7072 6f63 6573 7369 6e67 6029 2061  e.processing`) a
+0000b2d0: 7320 7375 7370 6963 696f 7573 2e20 4966  s suspicious. If
+0000b2e0: 2061 2074 6173 6b20 6973 2069 6e76 6f6c   a task is invol
+0000b2f0: 7665 6420 696e 2074 6872 6565 0a20 2020  ved in three.   
+0000b300: 2023 3a20 6465 6174 6873 2028 6f72 2073   #: deaths (or s
+0000b310: 6f6d 6520 6f74 6865 7220 6669 7865 6420  ome other fixed 
+0000b320: 636f 6e73 7461 6e74 2920 7468 656e 2077  constant) then w
+0000b330: 6520 6d61 726b 2074 6865 2074 6173 6b20  e mark the task 
+0000b340: 6173 2060 6065 7272 6564 6060 2e0a 2020  as ``erred``..  
+0000b350: 2020 7375 7370 6963 696f 7573 3a20 696e    suspicious: in
+0000b360: 740a 0a20 2020 2023 3a20 4120 7365 7420  t..    #: A set 
+0000b370: 6f66 2068 6f73 746e 616d 6573 2077 6865  of hostnames whe
+0000b380: 7265 2074 6869 7320 7461 736b 2063 616e  re this task can
+0000b390: 2062 6520 7275 6e20 286f 7220 6060 4e6f   be run (or ``No
+0000b3a0: 6e65 6060 2069 6620 656d 7074 7929 2e20  ne`` if empty). 
+0000b3b0: 5573 7561 6c6c 790a 2020 2020 233a 2074  Usually.    #: t
+0000b3c0: 6869 7320 6973 2065 6d70 7479 2075 6e6c  his is empty unl
+0000b3d0: 6573 7320 7468 6520 7461 736b 2068 6173  ess the task has
+0000b3e0: 2062 6565 6e20 7370 6563 6966 6963 616c   been specifical
+0000b3f0: 6c79 2072 6573 7472 6963 7465 6420 746f  ly restricted to
+0000b400: 206f 6e6c 7920 7275 6e20 6f6e 0a20 2020   only run on.   
+0000b410: 2023 3a20 6365 7274 6169 6e20 686f 7374   #: certain host
+0000b420: 732e 2041 2068 6f73 746e 616d 6520 6d61  s. A hostname ma
+0000b430: 7920 636f 7272 6573 706f 6e64 2074 6f20  y correspond to 
+0000b440: 6f6e 6520 6f72 2073 6576 6572 616c 2063  one or several c
+0000b450: 6f6e 6e65 6374 6564 2077 6f72 6b65 7273  onnected workers
+0000b460: 2e0a 2020 2020 686f 7374 5f72 6573 7472  ..    host_restr
+0000b470: 6963 7469 6f6e 733a 2073 6574 5b73 7472  ictions: set[str
+0000b480: 5d20 7c20 4e6f 6e65 0a0a 2020 2020 233a  ] | None..    #:
+0000b490: 2041 2073 6574 206f 6620 636f 6d70 6c65   A set of comple
+0000b4a0: 7465 2077 6f72 6b65 7220 6164 6472 6573  te worker addres
+0000b4b0: 7365 7320 7768 6572 6520 7468 6973 2063  ses where this c
+0000b4c0: 616e 2062 6520 7275 6e20 286f 7220 6060  an be run (or ``
+0000b4d0: 4e6f 6e65 6060 2069 6620 656d 7074 7929  None`` if empty)
+0000b4e0: 2e0a 2020 2020 233a 2055 7375 616c 6c79  ..    #: Usually
+0000b4f0: 2074 6869 7320 6973 2065 6d70 7479 2075   this is empty u
+0000b500: 6e6c 6573 7320 7468 6520 7461 736b 2068  nless the task h
+0000b510: 6173 2062 6565 6e20 7370 6563 6966 6963  as been specific
+0000b520: 616c 6c79 2072 6573 7472 6963 7465 6420  ally restricted 
+0000b530: 746f 206f 6e6c 790a 2020 2020 233a 2072  to only.    #: r
+0000b540: 756e 206f 6e20 6365 7274 6169 6e20 776f  un on certain wo
+0000b550: 726b 6572 732e 0a20 2020 2023 3a20 4e6f  rkers..    #: No
+0000b560: 7465 2074 6869 7320 6973 2074 7261 636b  te this is track
+0000b570: 696e 6720 776f 726b 6572 2061 6464 7265  ing worker addre
+0000b580: 7373 6573 2c20 6e6f 7420 776f 726b 6572  sses, not worker
+0000b590: 2073 7461 7465 732c 2073 696e 6365 2074   states, since t
+0000b5a0: 6865 2073 7065 6369 6669 630a 2020 2020  he specific.    
+0000b5b0: 233a 2077 6f72 6b65 7273 206d 6179 206e  #: workers may n
+0000b5c0: 6f74 2062 6520 636f 6e6e 6563 7465 6420  ot be connected 
+0000b5d0: 6174 2074 6869 7320 7469 6d65 2e0a 2020  at this time..  
+0000b5e0: 2020 776f 726b 6572 5f72 6573 7472 6963    worker_restric
+0000b5f0: 7469 6f6e 733a 2073 6574 5b73 7472 5d20  tions: set[str] 
+0000b600: 7c20 4e6f 6e65 0a0a 2020 2020 233a 2052  | None..    #: R
+0000b610: 6573 6f75 7263 6573 2072 6571 7569 7265  esources require
+0000b620: 6420 6279 2074 6869 7320 7461 736b 2c20  d by this task, 
+0000b630: 7375 6368 2061 7320 6060 7b27 6770 7527  such as ``{'gpu'
+0000b640: 3a20 317d 6060 206f 7220 6060 7b27 6d65  : 1}`` or ``{'me
+0000b650: 6d6f 7279 273a 2031 6539 7d60 600a 2020  mory': 1e9}``.  
+0000b660: 2020 233a 2054 6865 7365 2061 7265 2075    #: These are u
+0000b670: 7365 722d 6465 6669 6e65 6420 6e61 6d65  ser-defined name
+0000b680: 7320 616e 6420 6172 6520 6d61 7463 6865  s and are matche
+0000b690: 6420 6167 6169 6e73 7420 7468 6520 3a20  d against the : 
+0000b6a0: 636f 6e74 656e 7473 206f 6620 6561 6368  contents of each
+0000b6b0: 0a20 2020 2023 3a20 3a61 7474 723a 6057  .    #: :attr:`W
+0000b6c0: 6f72 6b65 7253 7461 7465 2e72 6573 6f75  orkerState.resou
+0000b6d0: 7263 6573 6020 6469 6374 696f 6e61 7279  rces` dictionary
+0000b6e0: 2e0a 2020 2020 7265 736f 7572 6365 5f72  ..    resource_r
+0000b6f0: 6573 7472 6963 7469 6f6e 733a 2064 6963  estrictions: dic
+0000b700: 745b 7374 722c 2066 6c6f 6174 5d20 7c20  t[str, float] | 
+0000b710: 4e6f 6e65 0a0a 2020 2020 233a 2046 616c  None..    #: Fal
+0000b720: 7365 0a20 2020 2023 3a20 2020 2020 4561  se.    #:     Ea
+0000b730: 6368 206f 6620 3a61 7474 723a 6068 6f73  ch of :attr:`hos
+0000b740: 745f 7265 7374 7269 6374 696f 6e73 602c  t_restrictions`,
+0000b750: 203a 6174 7472 3a60 776f 726b 6572 5f72   :attr:`worker_r
+0000b760: 6573 7472 6963 7469 6f6e 7360 2061 6e64  estrictions` and
+0000b770: 0a20 2020 2023 3a20 2020 2020 3a61 7474  .    #:     :att
+0000b780: 723a 6072 6573 6f75 7263 655f 7265 7374  r:`resource_rest
+0000b790: 7269 6374 696f 6e73 6020 6973 2061 2068  rictions` is a h
+0000b7a0: 6172 6420 636f 6e73 7472 6169 6e74 3a20  ard constraint: 
+0000b7b0: 6966 206e 6f20 776f 726b 6572 2069 7320  if no worker is 
+0000b7c0: 6176 6169 6c61 626c 650a 2020 2020 233a  available.    #:
+0000b7d0: 2020 2020 2073 6174 6973 6679 696e 6720       satisfying 
+0000b7e0: 7468 6f73 6520 7265 7374 7269 6374 696f  those restrictio
+0000b7f0: 6e73 2c20 7468 6520 7461 736b 2063 616e  ns, the task can
+0000b800: 6e6f 7420 676f 2069 6e74 6f20 7468 6520  not go into the 
+0000b810: 2270 726f 6365 7373 696e 6722 2073 7461  "processing" sta
+0000b820: 7465 0a20 2020 2023 3a20 2020 2020 616e  te.    #:     an
+0000b830: 6420 7769 6c6c 2069 6e73 7465 6164 2067  d will instead g
+0000b840: 6f20 696e 746f 2074 6865 2022 6e6f 2d77  o into the "no-w
+0000b850: 6f72 6b65 7222 2073 7461 7465 2e0a 2020  orker" state..  
+0000b860: 2020 233a 2054 7275 650a 2020 2020 233a    #: True.    #:
+0000b870: 2020 2020 2054 6865 2061 626f 7665 2072       The above r
+0000b880: 6573 7472 6963 7469 6f6e 7320 6172 6520  estrictions are 
+0000b890: 6d65 7265 2070 7265 6665 7265 6e63 6573  mere preferences
+0000b8a0: 3a20 6966 206e 6f20 776f 726b 6572 2069  : if no worker i
+0000b8b0: 7320 6176 6169 6c61 626c 650a 2020 2020  s available.    
+0000b8c0: 233a 2020 2020 2073 6174 6973 6679 696e  #:     satisfyin
+0000b8d0: 6720 7468 6f73 6520 7265 7374 7269 6374  g those restrict
+0000b8e0: 696f 6e73 2c20 7468 6520 7461 736b 2063  ions, the task c
+0000b8f0: 616e 2073 7469 6c6c 2067 6f20 696e 746f  an still go into
+0000b900: 2074 6865 0a20 2020 2023 3a20 2020 2020   the.    #:     
+0000b910: 2270 726f 6365 7373 696e 6722 2073 7461  "processing" sta
+0000b920: 7465 2061 6e64 2062 6520 7365 6e74 2066  te and be sent f
+0000b930: 6f72 2065 7865 6375 7469 6f6e 2074 6f20  or execution to 
+0000b940: 616e 6f74 6865 7220 636f 6e6e 6563 7465  another connecte
+0000b950: 6420 776f 726b 6572 2e0a 2020 2020 6c6f  d worker..    lo
+0000b960: 6f73 655f 7265 7374 7269 6374 696f 6e73  ose_restrictions
+0000b970: 3a20 626f 6f6c 0a0a 2020 2020 233a 2057  : bool..    #: W
+0000b980: 6865 7468 6572 2074 6869 7320 7461 736b  hether this task
+0000b990: 2069 7320 616e 2041 6374 6f72 0a20 2020   is an Actor.   
+0000b9a0: 2061 6374 6f72 3a20 626f 6f6c 0a0a 2020   actor: bool..  
+0000b9b0: 2020 233a 2054 6865 2067 726f 7570 206f    #: The group o
+0000b9c0: 6620 7461 736b 7320 746f 2077 6869 6368  f tasks to which
+0000b9d0: 2074 6869 7320 6f6e 6520 6265 6c6f 6e67   this one belong
+0000b9e0: 730a 2020 2020 6772 6f75 703a 2054 6173  s.    group: Tas
+0000b9f0: 6b47 726f 7570 0a0a 2020 2020 233a 2053  kGroup..    #: S
+0000ba00: 616d 6520 6173 206f 6620 6772 6f75 702e  ame as of group.
+0000ba10: 6e61 6d65 0a20 2020 2067 726f 7570 5f6b  name.    group_k
+0000ba20: 6579 3a20 7374 720a 0a20 2020 2023 3a20  ey: str..    #: 
+0000ba30: 4d65 7461 6461 7461 2072 656c 6174 6564  Metadata related
+0000ba40: 2074 6f20 7461 736b 0a20 2020 206d 6574   to task.    met
+0000ba50: 6164 6174 613a 2064 6963 745b 7374 722c  adata: dict[str,
+0000ba60: 2041 6e79 5d20 7c20 4e6f 6e65 0a0a 2020   Any] | None..  
+0000ba70: 2020 233a 2054 6173 6b20 616e 6e6f 7461    #: Task annota
+0000ba80: 7469 6f6e 730a 2020 2020 616e 6e6f 7461  tions.    annota
+0000ba90: 7469 6f6e 733a 2064 6963 745b 7374 722c  tions: dict[str,
+0000baa0: 2041 6e79 5d20 7c20 4e6f 6e65 0a0a 2020   Any] | None..  
+0000bab0: 2020 233a 2054 6865 2075 6e69 7175 6520    #: The unique 
+0000bac0: 6964 656e 7469 6669 6572 206f 6620 6120  identifier of a 
+0000bad0: 7370 6563 6966 6963 2065 7865 6375 7469  specific executi
+0000bae0: 6f6e 206f 6620 6120 7461 736b 2e20 5468  on of a task. Th
+0000baf0: 6973 2069 6465 6e74 6966 6965 720a 2020  is identifier.  
+0000bb00: 2020 233a 2069 7320 7573 6564 2074 6f20    #: is used to 
+0000bb10: 7369 676e 2061 2074 6173 6b20 7375 6368  sign a task such
+0000bb20: 2074 6861 7420 7468 6520 6173 7369 676e   that the assign
+0000bb30: 6564 2077 6f72 6b65 7220 6973 2065 7870  ed worker is exp
+0000bb40: 6563 7465 6420 746f 2072 6574 7572 6e0a  ected to return.
+0000bb50: 2020 2020 233a 2074 6865 2073 616d 6520      #: the same 
+0000bb60: 6964 656e 7469 6669 6572 2069 6e20 7468  identifier in th
+0000bb70: 6520 7461 736b 2d66 696e 6973 6865 6420  e task-finished 
+0000bb80: 6d65 7373 6167 652e 2054 6869 7320 6973  message. This is
+0000bb90: 2075 7365 6420 746f 2063 6f72 7265 6c61   used to correla
+0000bba0: 7465 0a20 2020 2023 3a20 7265 7370 6f6e  te.    #: respon
+0000bbb0: 7365 732e 0a20 2020 2023 3a20 4f6e 6c79  ses..    #: Only
+0000bbc0: 2074 6865 206d 6f73 7420 7265 6365 6e74   the most recent
+0000bbd0: 6c79 2061 7373 6967 6e65 6420 776f 726b  ly assigned work
+0000bbe0: 6572 2069 7320 7472 7573 7465 642e 2041  er is trusted. A
+0000bbf0: 6c6c 206f 7468 6572 2072 6573 756c 7473  ll other results
+0000bc00: 2077 696c 6c0a 2020 2020 233a 2062 6520   will.    #: be 
+0000bc10: 7265 6a65 6374 6564 2e0a 2020 2020 7275  rejected..    ru
+0000bc20: 6e5f 6964 3a20 696e 7420 7c20 4e6f 6e65  n_id: int | None
+0000bc30: 0a0a 2020 2020 233a 2057 6865 7468 6572  ..    #: Whether
+0000bc40: 2074 6f20 636f 6e73 6964 6572 2074 6869   to consider thi
+0000bc50: 7320 7461 736b 2072 6f6f 7469 7368 2069  s task rootish i
+0000bc60: 6e20 7468 6520 636f 6e74 6578 7420 6f66  n the context of
+0000bc70: 2074 6173 6b20 7175 6575 6569 6e67 0a20   task queueing. 
+0000bc80: 2020 2023 3a20 5472 7565 0a20 2020 2023     #: True.    #
+0000bc90: 3a20 2020 2020 416c 7761 7973 2063 6f6e  :     Always con
+0000bca0: 7369 6465 7220 7468 6973 2074 6173 6b20  sider this task 
+0000bcb0: 726f 6f74 6973 680a 2020 2020 233a 2046  rootish.    #: F
+0000bcc0: 616c 7365 0a20 2020 2023 3a20 2020 2020  alse.    #:     
+0000bcd0: 4e65 7665 7220 636f 6e73 6964 6572 2074  Never consider t
+0000bce0: 6869 7320 7461 736b 2072 6f6f 7469 7368  his task rootish
+0000bcf0: 0a20 2020 2023 3a20 4e6f 6e65 0a20 2020  .    #: None.   
+0000bd00: 2023 3a20 2020 2020 5573 6520 6120 6865   #:     Use a he
+0000bd10: 7572 6973 7469 6320 746f 2064 6574 6572  uristic to deter
+0000bd20: 6d69 6e65 2077 6865 7468 6572 2074 6869  mine whether thi
+0000bd30: 7320 7461 736b 2073 686f 756c 6420 6265  s task should be
+0000bd40: 2063 6f6e 7369 6465 7265 6420 726f 6f74   considered root
+0000bd50: 6973 680a 2020 2020 5f72 6f6f 7469 7368  ish.    _rootish
+0000bd60: 3a20 626f 6f6c 207c 204e 6f6e 650a 0a20  : bool | None.. 
+0000bd70: 2020 2023 3a20 4361 6368 6564 2068 6173     #: Cached has
+0000bd80: 6820 6f66 203a 6174 7472 3a60 7e54 6173  h of :attr:`~Tas
+0000bd90: 6b53 7461 7465 2e63 6c69 656e 745f 6b65  kState.client_ke
+0000bda0: 7960 0a20 2020 205f 6861 7368 3a20 696e  y`.    _hash: in
+0000bdb0: 740a 0a20 2020 2023 2053 7570 706f 7274  t..    # Support
+0000bdc0: 2066 6f72 2077 6561 6b72 6566 7320 746f   for weakrefs to
+0000bdd0: 2061 2063 6c61 7373 2077 6974 6820 5f5f   a class with __
+0000bde0: 736c 6f74 735f 5f0a 2020 2020 5f5f 7765  slots__.    __we
+0000bdf0: 616b 7265 665f 5f3a 2041 6e79 203d 204e  akref__: Any = N
+0000be00: 6f6e 650a 2020 2020 5f5f 736c 6f74 735f  one.    __slots_
+0000be10: 5f20 3d20 7475 706c 6528 5f5f 616e 6e6f  _ = tuple(__anno
+0000be20: 7461 7469 6f6e 735f 5f29 0a0a 2020 2020  tations__)..    
+0000be30: 233a 2047 6c6f 6261 6c20 6974 6572 6174  #: Global iterat
+0000be40: 6f72 2075 7365 6420 746f 2063 7265 6174  or used to creat
+0000be50: 6520 756e 6971 7565 2074 6173 6b20 7275  e unique task ru
+0000be60: 6e20 4944 730a 2020 2020 5f72 756e 5f69  n IDs.    _run_i
+0000be70: 645f 6974 6572 6174 6f72 3a20 436c 6173  d_iterator: Clas
+0000be80: 7356 6172 5b69 7465 7274 6f6f 6c73 2e63  sVar[itertools.c
+0000be90: 6f75 6e74 5d20 3d20 6974 6572 746f 6f6c  ount] = itertool
+0000bea0: 732e 636f 756e 7428 290a 0a20 2020 2023  s.count()..    #
+0000beb0: 2049 6e73 7461 6e63 6573 206e 6f74 2070   Instances not p
+0000bec0: 6172 7420 6f66 2073 6c6f 7473 2073 696e  art of slots sin
+0000bed0: 6365 2063 6c61 7373 2076 6172 6961 626c  ce class variabl
+0000bee0: 650a 2020 2020 5f69 6e73 7461 6e63 6573  e.    _instances
+0000bef0: 3a20 436c 6173 7356 6172 5b77 6561 6b72  : ClassVar[weakr
+0000bf00: 6566 2e57 6561 6b53 6574 5b54 6173 6b53  ef.WeakSet[TaskS
+0000bf10: 7461 7465 5d5d 203d 2077 6561 6b72 6566  tate]] = weakref
+0000bf20: 2e57 6561 6b53 6574 2829 0a0a 2020 2020  .WeakSet()..    
+0000bf30: 6465 6620 5f5f 696e 6974 5f5f 280a 2020  def __init__(.  
+0000bf40: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+0000bf50: 2020 2020 6b65 793a 204b 6579 2c0a 2020      key: Key,.  
+0000bf60: 2020 2020 2020 7275 6e5f 7370 6563 3a20        run_spec: 
+0000bf70: 545f 7275 6e73 7065 6320 7c20 4e6f 6e65  T_runspec | None
+0000bf80: 2c0a 2020 2020 2020 2020 7374 6174 653a  ,.        state:
+0000bf90: 2054 6173 6b53 7461 7465 5374 6174 652c   TaskStateState,
+0000bfa0: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
+0000bfb0: 2320 4d6f 7374 206f 6620 7468 6520 6174  # Most of the at
+0000bfc0: 7472 6962 7574 6573 2062 656c 6f77 2061  tributes below a
+0000bfd0: 7265 206e 6f74 2069 6e69 7469 616c 697a  re not initializ
+0000bfe0: 6564 2073 696e 6365 2074 6865 7265 2061  ed since there a
+0000bff0: 7265 206e 6f74 0a20 2020 2020 2020 2023  re not.        #
+0000c000: 2061 6c77 6179 7320 7265 7175 6972 6564   always required
+0000c010: 2066 6f72 2065 7665 7279 2074 6173 6b73   for every tasks
+0000c020: 2e20 5061 7274 6963 756c 6172 6c79 2066  . Particularly f
+0000c030: 6f72 206c 6172 6765 2067 7261 7068 732c  or large graphs,
+0000c040: 2074 6865 7365 0a20 2020 2020 2020 2023   these.        #
+0000c050: 2063 616e 2061 6464 2075 7020 7369 676e   can add up sign
+0000c060: 6966 6963 616e 7420 6d65 6d6f 7279 2c20  ificant memory, 
+0000c070: 7365 650a 2020 2020 2020 2020 2320 6874  see.        # ht
+0000c080: 7470 733a 2f2f 6769 7468 7562 2e63 6f6d  tps://github.com
+0000c090: 2f64 6173 6b2f 6469 7374 7269 6275 7465  /dask/distribute
+0000c0a0: 642f 7075 6c6c 2f38 3333 310a 2020 2020  d/pull/8331.    
+0000c0b0: 2020 2020 2320 6874 7470 733a 2f2f 6769      # https://gi
+0000c0c0: 7468 7562 2e63 6f6d 2f64 6173 6b2f 6469  thub.com/dask/di
+0000c0d0: 7374 7269 6275 7465 642f 6973 7375 6573  stributed/issues
+0000c0e0: 2f37 3939 3823 6973 7375 6563 6f6d 6d65  /7998#issuecomme
+0000c0f0: 6e74 2d31 3637 3731 3637 3437 380a 2020  nt-1677167478.  
+0000c100: 2020 2020 2020 7365 6c66 2e6b 6579 203d        self.key =
+0000c110: 206b 6579 0a20 2020 2020 2020 2073 656c   key.        sel
+0000c120: 662e 5f68 6173 6820 3d20 6861 7368 286b  f._hash = hash(k
+0000c130: 6579 290a 2020 2020 2020 2020 7365 6c66  ey).        self
+0000c140: 2e72 756e 5f73 7065 6320 3d20 7275 6e5f  .run_spec = run_
+0000c150: 7370 6563 0a20 2020 2020 2020 2073 656c  spec.        sel
+0000c160: 662e 5f73 7461 7465 203d 2073 7461 7465  f._state = state
+0000c170: 0a20 2020 2020 2020 2073 656c 662e 6578  .        self.ex
+0000c180: 6365 7074 696f 6e20 3d20 4e6f 6e65 0a20  ception = None. 
+0000c190: 2020 2020 2020 2073 656c 662e 6578 6365         self.exce
+0000c1a0: 7074 696f 6e5f 626c 616d 6520 3d20 4e6f  ption_blame = No
+0000c1b0: 6e65 0a20 2020 2020 2020 2073 656c 662e  ne.        self.
+0000c1c0: 7472 6163 6562 6163 6b20 3d20 4e6f 6e65  traceback = None
+0000c1d0: 0a20 2020 2020 2020 2073 656c 662e 6578  .        self.ex
+0000c1e0: 6365 7074 696f 6e5f 7465 7874 203d 204e  ception_text = N
+0000c1f0: 6f6e 650a 2020 2020 2020 2020 7365 6c66  one.        self
+0000c200: 2e74 7261 6365 6261 636b 5f74 6578 7420  .traceback_text 
+0000c210: 3d20 4e6f 6e65 0a20 2020 2020 2020 2073  = None.        s
+0000c220: 656c 662e 7375 7370 6963 696f 7573 203d  elf.suspicious =
+0000c230: 2030 0a20 2020 2020 2020 2073 656c 662e   0.        self.
+0000c240: 7265 7472 6965 7320 3d20 300a 2020 2020  retries = 0.    
+0000c250: 2020 2020 7365 6c66 2e6e 6279 7465 7320      self.nbytes 
+0000c260: 3d20 2d31 0a20 2020 2020 2020 2073 656c  = -1.        sel
+0000c270: 662e 7072 696f 7269 7479 203d 204e 6f6e  f.priority = Non
+0000c280: 650a 2020 2020 2020 2020 7365 6c66 2e77  e.        self.w
+0000c290: 686f 5f77 616e 7473 203d 204e 6f6e 650a  ho_wants = None.
+0000c2a0: 2020 2020 2020 2020 7365 6c66 2e64 6570          self.dep
+0000c2b0: 656e 6465 6e63 6965 7320 3d20 7365 7428  endencies = set(
+0000c2c0: 290a 2020 2020 2020 2020 7365 6c66 2e64  ).        self.d
+0000c2d0: 6570 656e 6465 6e74 7320 3d20 7365 7428  ependents = set(
+0000c2e0: 290a 2020 2020 2020 2020 7365 6c66 2e77  ).        self.w
+0000c2f0: 6169 7469 6e67 5f6f 6e20 3d20 4e6f 6e65  aiting_on = None
+0000c300: 0a20 2020 2020 2020 2073 656c 662e 7761  .        self.wa
+0000c310: 6974 6572 7320 3d20 4e6f 6e65 0a20 2020  iters = None.   
+0000c320: 2020 2020 2073 656c 662e 7768 6f5f 6861       self.who_ha
+0000c330: 7320 3d20 4e6f 6e65 0a20 2020 2020 2020  s = None.       
+0000c340: 2073 656c 662e 7072 6f63 6573 7369 6e67   self.processing
+0000c350: 5f6f 6e20 3d20 4e6f 6e65 0a20 2020 2020  _on = None.     
+0000c360: 2020 2073 656c 662e 6861 735f 6c6f 7374     self.has_lost
+0000c370: 5f64 6570 656e 6465 6e63 6965 7320 3d20  _dependencies = 
+0000c380: 4661 6c73 650a 2020 2020 2020 2020 7365  False.        se
+0000c390: 6c66 2e68 6f73 745f 7265 7374 7269 6374  lf.host_restrict
+0000c3a0: 696f 6e73 203d 204e 6f6e 650a 2020 2020  ions = None.    
+0000c3b0: 2020 2020 7365 6c66 2e77 6f72 6b65 725f      self.worker_
+0000c3c0: 7265 7374 7269 6374 696f 6e73 203d 204e  restrictions = N
+0000c3d0: 6f6e 650a 2020 2020 2020 2020 7365 6c66  one.        self
+0000c3e0: 2e72 6573 6f75 7263 655f 7265 7374 7269  .resource_restri
+0000c3f0: 6374 696f 6e73 203d 204e 6f6e 650a 2020  ctions = None.  
+0000c400: 2020 2020 2020 7365 6c66 2e6c 6f6f 7365        self.loose
+0000c410: 5f72 6573 7472 6963 7469 6f6e 7320 3d20  _restrictions = 
+0000c420: 4661 6c73 650a 2020 2020 2020 2020 7365  False.        se
+0000c430: 6c66 2e61 6374 6f72 203d 2046 616c 7365  lf.actor = False
+0000c440: 0a20 2020 2020 2020 2073 656c 662e 7072  .        self.pr
+0000c450: 6566 6978 203d 204e 6f6e 6520 2023 2074  efix = None  # t
+0000c460: 7970 653a 2069 676e 6f72 650a 2020 2020  ype: ignore.    
+0000c470: 2020 2020 7365 6c66 2e74 7970 6520 3d20      self.type = 
+0000c480: 4e6f 6e65 2020 2320 7479 7065 3a20 6967  None  # type: ig
+0000c490: 6e6f 7265 0a20 2020 2020 2020 2073 656c  nore.        sel
+0000c4a0: 662e 6772 6f75 705f 6b65 7920 3d20 6b65  f.group_key = ke
+0000c4b0: 795f 7370 6c69 745f 6772 6f75 7028 6b65  y_split_group(ke
+0000c4c0: 7929 0a20 2020 2020 2020 2073 656c 662e  y).        self.
+0000c4d0: 6772 6f75 7020 3d20 4e6f 6e65 2020 2320  group = None  # 
+0000c4e0: 7479 7065 3a20 6967 6e6f 7265 0a20 2020  type: ignore.   
+0000c4f0: 2020 2020 2073 656c 662e 6d65 7461 6461       self.metada
+0000c500: 7461 203d 204e 6f6e 650a 2020 2020 2020  ta = None.      
+0000c510: 2020 7365 6c66 2e61 6e6e 6f74 6174 696f    self.annotatio
+0000c520: 6e73 203d 204e 6f6e 650a 2020 2020 2020  ns = None.      
+0000c530: 2020 7365 6c66 2e65 7272 6564 5f6f 6e20    self.erred_on 
+0000c540: 3d20 4e6f 6e65 0a20 2020 2020 2020 2073  = None.        s
+0000c550: 656c 662e 5f72 6f6f 7469 7368 203d 204e  elf._rootish = N
+0000c560: 6f6e 650a 2020 2020 2020 2020 7365 6c66  one.        self
+0000c570: 2e72 756e 5f69 6420 3d20 4e6f 6e65 0a20  .run_id = None. 
+0000c580: 2020 2020 2020 2054 6173 6b53 7461 7465         TaskState
+0000c590: 2e5f 696e 7374 616e 6365 732e 6164 6428  ._instances.add(
+0000c5a0: 7365 6c66 290a 0a20 2020 2064 6566 205f  self)..    def _
+0000c5b0: 5f68 6173 685f 5f28 7365 6c66 2920 2d3e  _hash__(self) ->
+0000c5c0: 2069 6e74 3a0a 2020 2020 2020 2020 7265   int:.        re
+0000c5d0: 7475 726e 2073 656c 662e 5f68 6173 680a  turn self._hash.
+0000c5e0: 0a20 2020 2064 6566 205f 5f65 715f 5f28  .    def __eq__(
+0000c5f0: 7365 6c66 2c20 6f74 6865 723a 206f 626a  self, other: obj
+0000c600: 6563 7429 202d 3e20 626f 6f6c 3a0a 2020  ect) -> bool:.  
+0000c610: 2020 2020 2020 7265 7475 726e 2069 7369        return isi
+0000c620: 6e73 7461 6e63 6528 6f74 6865 722c 2054  nstance(other, T
+0000c630: 6173 6b53 7461 7465 2920 616e 6420 7365  askState) and se
+0000c640: 6c66 2e6b 6579 203d 3d20 6f74 6865 722e  lf.key == other.
+0000c650: 6b65 790a 0a20 2020 2040 7072 6f70 6572  key..    @proper
+0000c660: 7479 0a20 2020 2064 6566 2073 7461 7465  ty.    def state
+0000c670: 2873 656c 6629 202d 3e20 5461 736b 5374  (self) -> TaskSt
+0000c680: 6174 6553 7461 7465 3a0a 2020 2020 2020  ateState:.      
+0000c690: 2020 2222 2254 6869 7320 7461 736b 2773    """This task's
+0000c6a0: 2063 7572 7265 6e74 2073 7461 7465 2e20   current state. 
+0000c6b0: 2056 616c 6964 2073 7461 7465 7320 6172   Valid states ar
+0000c6c0: 6520 6060 7265 6c65 6173 6564 6060 2c20  e ``released``, 
+0000c6d0: 6060 7761 6974 696e 6760 602c 0a20 2020  ``waiting``,.   
+0000c6e0: 2020 2020 2060 606e 6f2d 776f 726b 6572       ``no-worker
+0000c6f0: 6060 2c20 6060 7072 6f63 6573 7369 6e67  ``, ``processing
+0000c700: 6060 2c20 6060 6d65 6d6f 7279 6060 2c20  ``, ``memory``, 
+0000c710: 6060 6572 7265 6460 6020 616e 6420 6060  ``erred`` and ``
+0000c720: 666f 7267 6f74 7465 6e60 602e 2020 4966  forgotten``.  If
+0000c730: 2069 740a 2020 2020 2020 2020 6973 2060   it.        is `
+0000c740: 6066 6f72 676f 7474 656e 6060 2c20 7468  `forgotten``, th
+0000c750: 6520 7461 736b 2069 736e 2774 2073 746f  e task isn't sto
+0000c760: 7265 6420 696e 2074 6865 2060 6074 6173  red in the ``tas
+0000c770: 6b73 6060 2064 6963 7469 6f6e 6172 7920  ks`` dictionary 
+0000c780: 616e 796d 6f72 6520 616e 640a 2020 2020  anymore and.    
+0000c790: 2020 2020 7769 6c6c 2070 726f 6261 626c      will probabl
+0000c7a0: 7920 6469 7361 7070 6561 7220 736f 6f6e  y disappear soon
+0000c7b0: 2066 726f 6d20 6d65 6d6f 7279 2e0a 2020   from memory..  
+0000c7c0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0000c7d0: 2020 7265 7475 726e 2073 656c 662e 5f73    return self._s
+0000c7e0: 7461 7465 0a0a 2020 2020 4073 7461 7465  tate..    @state
+0000c7f0: 2e73 6574 7465 720a 2020 2020 6465 6620  .setter.    def 
+0000c800: 7374 6174 6528 7365 6c66 2c20 7661 6c75  state(self, valu
+0000c810: 653a 2054 6173 6b53 7461 7465 5374 6174  e: TaskStateStat
+0000c820: 6529 202d 3e20 4e6f 6e65 3a0a 2020 2020  e) -> None:.    
+0000c830: 2020 2020 7365 6c66 2e67 726f 7570 2e73      self.group.s
+0000c840: 7461 7465 735b 7365 6c66 2e5f 7374 6174  tates[self._stat
+0000c850: 655d 202d 3d20 310a 2020 2020 2020 2020  e] -= 1.        
+0000c860: 7365 6c66 2e67 726f 7570 2e73 7461 7465  self.group.state
+0000c870: 735b 7661 6c75 655d 202b 3d20 310a 2020  s[value] += 1.  
+0000c880: 2020 2020 2020 7365 6c66 2e5f 7374 6174        self._stat
+0000c890: 6520 3d20 7661 6c75 650a 2020 2020 2020  e = value.      
+0000c8a0: 2020 7365 6c66 2e70 7265 6669 782e 7374    self.prefix.st
+0000c8b0: 6174 655f 636f 756e 7473 5b76 616c 7565  ate_counts[value
+0000c8c0: 5d20 2b3d 2031 0a0a 2020 2020 6465 6620  ] += 1..    def 
+0000c8d0: 6164 645f 6465 7065 6e64 656e 6379 2873  add_dependency(s
+0000c8e0: 656c 662c 206f 7468 6572 3a20 5461 736b  elf, other: Task
+0000c8f0: 5374 6174 6529 202d 3e20 4e6f 6e65 3a0a  State) -> None:.
+0000c900: 2020 2020 2020 2020 2222 2241 6464 2061          """Add a
+0000c910: 6e6f 7468 6572 2074 6173 6b20 6173 2061  nother task as a
+0000c920: 2064 6570 656e 6465 6e63 7920 6f66 2074   dependency of t
+0000c930: 6869 7320 7461 736b 2222 220a 2020 2020  his task""".    
+0000c940: 2020 2020 7365 6c66 2e64 6570 656e 6465      self.depende
+0000c950: 6e63 6965 732e 6164 6428 6f74 6865 7229  ncies.add(other)
+0000c960: 0a20 2020 2020 2020 2073 656c 662e 6772  .        self.gr
+0000c970: 6f75 702e 6465 7065 6e64 656e 6369 6573  oup.dependencies
+0000c980: 2e61 6464 286f 7468 6572 2e67 726f 7570  .add(other.group
+0000c990: 290a 2020 2020 2020 2020 6f74 6865 722e  ).        other.
+0000c9a0: 6465 7065 6e64 656e 7473 2e61 6464 2873  dependents.add(s
+0000c9b0: 656c 6629 0a0a 2020 2020 6465 6620 6765  elf)..    def ge
+0000c9c0: 745f 6e62 7974 6573 2873 656c 6629 202d  t_nbytes(self) -
+0000c9d0: 3e20 696e 743a 0a20 2020 2020 2020 2072  > int:.        r
+0000c9e0: 6574 7572 6e20 7365 6c66 2e6e 6279 7465  eturn self.nbyte
+0000c9f0: 7320 6966 2073 656c 662e 6e62 7974 6573  s if self.nbytes
+0000ca00: 203e 3d20 3020 656c 7365 2044 4546 4155   >= 0 else DEFAU
+0000ca10: 4c54 5f44 4154 415f 5349 5a45 0a0a 2020  LT_DATA_SIZE..  
+0000ca20: 2020 6465 6620 7365 745f 6e62 7974 6573    def set_nbytes
+0000ca30: 2873 656c 662c 206e 6279 7465 733a 2069  (self, nbytes: i
+0000ca40: 6e74 2920 2d3e 204e 6f6e 653a 0a20 2020  nt) -> None:.   
+0000ca50: 2020 2020 2064 6966 6620 3d20 6e62 7974       diff = nbyt
+0000ca60: 6573 0a20 2020 2020 2020 206f 6c64 5f6e  es.        old_n
+0000ca70: 6279 7465 7320 3d20 7365 6c66 2e6e 6279  bytes = self.nby
+0000ca80: 7465 730a 2020 2020 2020 2020 6966 206f  tes.        if o
+0000ca90: 6c64 5f6e 6279 7465 7320 3e3d 2030 3a0a  ld_nbytes >= 0:.
+0000caa0: 2020 2020 2020 2020 2020 2020 6469 6666              diff
+0000cab0: 202d 3d20 6f6c 645f 6e62 7974 6573 0a20   -= old_nbytes. 
+0000cac0: 2020 2020 2020 2073 656c 662e 6772 6f75         self.grou
+0000cad0: 702e 6e62 7974 6573 5f74 6f74 616c 202b  p.nbytes_total +
+0000cae0: 3d20 6469 6666 0a20 2020 2020 2020 2066  = diff.        f
+0000caf0: 6f72 2077 7320 696e 2073 656c 662e 7768  or ws in self.wh
+0000cb00: 6f5f 6861 7320 6f72 2028 293a 0a20 2020  o_has or ():.   
+0000cb10: 2020 2020 2020 2020 2077 732e 6e62 7974           ws.nbyt
+0000cb20: 6573 202b 3d20 6469 6666 0a20 2020 2020  es += diff.     
+0000cb30: 2020 2073 656c 662e 6e62 7974 6573 203d     self.nbytes =
+0000cb40: 206e 6279 7465 730a 0a20 2020 2064 6566   nbytes..    def
+0000cb50: 205f 5f72 6570 725f 5f28 7365 6c66 2920   __repr__(self) 
+0000cb60: 2d3e 2073 7472 3a0a 2020 2020 2020 2020  -> str:.        
+0000cb70: 7265 7475 726e 2066 223c 5461 736b 5374  return f"<TaskSt
+0000cb80: 6174 6520 7b73 656c 662e 6b65 7921 727d  ate {self.key!r}
+0000cb90: 207b 7365 6c66 2e5f 7374 6174 657d 3e22   {self._state}>"
+0000cba0: 0a0a 2020 2020 6465 6620 5f72 6570 725f  ..    def _repr_
+0000cbb0: 6874 6d6c 5f28 7365 6c66 2920 2d3e 2073  html_(self) -> s
+0000cbc0: 7472 3a0a 2020 2020 2020 2020 7265 7475  tr:.        retu
+0000cbd0: 726e 2067 6574 5f74 656d 706c 6174 6528  rn get_template(
+0000cbe0: 2274 6173 6b5f 7374 6174 652e 6874 6d6c  "task_state.html
+0000cbf0: 2e6a 3222 292e 7265 6e64 6572 280a 2020  .j2").render(.  
+0000cc00: 2020 2020 2020 2020 2020 7374 6174 653d            state=
+0000cc10: 7365 6c66 2e73 7461 7465 2c0a 2020 2020  self.state,.    
+0000cc20: 2020 2020 2020 2020 6e62 7974 6573 3d73          nbytes=s
+0000cc30: 656c 662e 6e62 7974 6573 2c0a 2020 2020  elf.nbytes,.    
+0000cc40: 2020 2020 2020 2020 6b65 793d 7374 7228          key=str(
+0000cc50: 7365 6c66 2e6b 6579 292c 0a20 2020 2020  self.key),.     
+0000cc60: 2020 2029 0a0a 2020 2020 6465 6620 7661     )..    def va
+0000cc70: 6c69 6461 7465 2873 656c 6629 202d 3e20  lidate(self) -> 
+0000cc80: 4e6f 6e65 3a0a 2020 2020 2020 2020 7472  None:.        tr
+0000cc90: 793a 0a20 2020 2020 2020 2020 2020 2066  y:.            f
+0000cca0: 6f72 2063 7320 696e 2073 656c 662e 7768  or cs in self.wh
+0000ccb0: 6f5f 7761 6e74 7320 6f72 2028 293a 0a20  o_wants or ():. 
+0000ccc0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0000ccd0: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
+0000cce0: 2863 732c 2043 6c69 656e 7453 7461 7465  (cs, ClientState
+0000ccf0: 292c 2028 7265 7072 2863 7329 2c20 7365  ), (repr(cs), se
+0000cd00: 6c66 2e77 686f 5f77 616e 7473 290a 2020  lf.who_wants).  
+0000cd10: 2020 2020 2020 2020 2020 666f 7220 7773            for ws
+0000cd20: 2069 6e20 7365 6c66 2e77 686f 5f68 6173   in self.who_has
+0000cd30: 206f 7220 2829 3a0a 2020 2020 2020 2020   or ():.        
+0000cd40: 2020 2020 2020 2020 6173 7365 7274 2069          assert i
+0000cd50: 7369 6e73 7461 6e63 6528 7773 2c20 576f  sinstance(ws, Wo
+0000cd60: 726b 6572 5374 6174 6529 2c20 2872 6570  rkerState), (rep
+0000cd70: 7228 7773 292c 2073 656c 662e 7768 6f5f  r(ws), self.who_
+0000cd80: 6861 7329 0a20 2020 2020 2020 2020 2020  has).           
+0000cd90: 2066 6f72 2074 7320 696e 2073 656c 662e   for ts in self.
+0000cda0: 6465 7065 6e64 656e 6369 6573 3a0a 2020  dependencies:.  
+0000cdb0: 2020 2020 2020 2020 2020 2020 2020 6173                as
+0000cdc0: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
+0000cdd0: 7473 2c20 5461 736b 5374 6174 6529 2c20  ts, TaskState), 
+0000cde0: 2872 6570 7228 7473 292c 2073 656c 662e  (repr(ts), self.
+0000cdf0: 6465 7065 6e64 656e 6369 6573 290a 2020  dependencies).  
+0000ce00: 2020 2020 2020 2020 2020 666f 7220 7473            for ts
+0000ce10: 2069 6e20 7365 6c66 2e64 6570 656e 6465   in self.depende
+0000ce20: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
+0000ce30: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
+0000ce40: 7374 616e 6365 2874 732c 2054 6173 6b53  stance(ts, TaskS
+0000ce50: 7461 7465 292c 2028 7265 7072 2874 7329  tate), (repr(ts)
+0000ce60: 2c20 7365 6c66 2e64 6570 656e 6465 6e74  , self.dependent
+0000ce70: 7329 0a20 2020 2020 2020 2020 2020 2076  s).            v
+0000ce80: 616c 6964 6174 655f 7461 736b 5f73 7461  alidate_task_sta
+0000ce90: 7465 2873 656c 6629 0a20 2020 2020 2020  te(self).       
+0000cea0: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+0000ceb0: 6e20 6173 2065 3a0a 2020 2020 2020 2020  n as e:.        
+0000cec0: 2020 2020 6c6f 6767 6572 2e65 7863 6570      logger.excep
+0000ced0: 7469 6f6e 2865 290a 2020 2020 2020 2020  tion(e).        
+0000cee0: 2020 2020 6966 204c 4f47 5f50 4442 3a0a      if LOG_PDB:.
+0000cef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cf00: 696d 706f 7274 2070 6462 0a0a 2020 2020  import pdb..    
+0000cf10: 2020 2020 2020 2020 2020 2020 7064 622e              pdb.
+0000cf20: 7365 745f 7472 6163 6528 290a 0a20 2020  set_trace()..   
+0000cf30: 2064 6566 2067 6574 5f6e 6279 7465 735f   def get_nbytes_
+0000cf40: 6465 7073 2873 656c 6629 202d 3e20 696e  deps(self) -> in
+0000cf50: 743a 0a20 2020 2020 2020 2072 6574 7572  t:.        retur
+0000cf60: 6e20 7375 6d28 7473 2e67 6574 5f6e 6279  n sum(ts.get_nby
+0000cf70: 7465 7328 2920 666f 7220 7473 2069 6e20  tes() for ts in 
+0000cf80: 7365 6c66 2e64 6570 656e 6465 6e63 6965  self.dependencie
+0000cf90: 7329 0a0a 2020 2020 6465 6620 5f74 6f5f  s)..    def _to_
+0000cfa0: 6469 6374 5f6e 6f5f 6e65 7374 2873 656c  dict_no_nest(sel
+0000cfb0: 662c 202a 2c20 6578 636c 7564 653a 2043  f, *, exclude: C
+0000cfc0: 6f6e 7461 696e 6572 5b73 7472 5d20 3d20  ontainer[str] = 
+0000cfd0: 2829 2920 2d3e 2064 6963 745b 7374 722c  ()) -> dict[str,
+0000cfe0: 2041 6e79 5d3a 0a20 2020 2020 2020 2022   Any]:.        "
+0000cff0: 2222 4469 6374 696f 6e61 7279 2072 6570  ""Dictionary rep
+0000d000: 7265 7365 6e74 6174 696f 6e20 666f 7220  resentation for 
+0000d010: 6465 6275 6767 696e 6720 7075 7270 6f73  debugging purpos
+0000d020: 6573 2e0a 2020 2020 2020 2020 4e6f 7420  es..        Not 
+0000d030: 7479 7065 2073 7461 626c 6520 616e 6420  type stable and 
+0000d040: 6e6f 7420 696e 7465 6e64 6564 2066 6f72  not intended for
+0000d050: 2072 6f75 6e64 7472 6970 732e 0a0a 2020   roundtrips...  
+0000d060: 2020 2020 2020 5365 6520 616c 736f 0a20        See also. 
+0000d070: 2020 2020 2020 202d 2d2d 2d2d 2d2d 2d0a         --------.
+0000d080: 2020 2020 2020 2020 436c 6965 6e74 2e64          Client.d
+0000d090: 756d 705f 636c 7573 7465 725f 7374 6174  ump_cluster_stat
+0000d0a0: 650a 2020 2020 2020 2020 6469 7374 7269  e.        distri
+0000d0b0: 6275 7465 642e 7574 696c 732e 7265 6375  buted.utils.recu
+0000d0c0: 7273 6976 655f 746f 5f64 6963 740a 0a20  rsive_to_dict.. 
+0000d0d0: 2020 2020 2020 204e 6f74 6573 0a20 2020         Notes.   
+0000d0e0: 2020 2020 202d 2d2d 2d2d 0a20 2020 2020       -----.     
+0000d0f0: 2020 2054 6869 7320 636c 6173 7320 7573     This class us
+0000d100: 6573 2060 605f 746f 5f64 6963 745f 6e6f  es ``_to_dict_no
+0000d110: 5f6e 6573 7460 6020 696e 7374 6561 6420  _nest`` instead 
+0000d120: 6f66 2060 605f 746f 5f64 6963 7460 602e  of ``_to_dict``.
+0000d130: 0a20 2020 2020 2020 2057 6865 6e20 6120  .        When a 
+0000d140: 7461 736b 2072 6566 6572 656e 6365 7320  task references 
+0000d150: 616e 6f74 6865 7220 7461 736b 2c20 6f72  another task, or
+0000d160: 2077 6865 6e20 6120 576f 726b 6572 5374   when a WorkerSt
+0000d170: 6174 652e 7461 736b 7320 636f 6e74 6169  ate.tasks contai
+0000d180: 6e73 2074 6173 6b73 2c0a 2020 2020 2020  ns tasks,.      
+0000d190: 2020 7468 6973 206d 6574 686f 6420 6973    this method is
+0000d1a0: 206e 6f74 2065 7865 6375 7465 6420 666f   not executed fo
+0000d1b0: 7220 7468 6520 696e 6e65 7220 7461 736b  r the inner task
+0000d1c0: 2c20 6576 656e 2069 6620 7468 6520 696e  , even if the in
+0000d1d0: 6e65 7220 7461 736b 2077 6173 206e 6576  ner task was nev
+0000d1e0: 6572 0a20 2020 2020 2020 2073 6565 6e20  er.        seen 
+0000d1f0: 6265 666f 7265 3b20 796f 7520 6765 7420  before; you get 
+0000d200: 6120 7265 7072 2069 6e73 7465 6164 2e20  a repr instead. 
+0000d210: 416c 6c20 7461 736b 7320 7368 6f75 6c64  All tasks should
+0000d220: 206e 6561 746c 7920 6170 7065 6172 2075   neatly appear u
+0000d230: 6e64 6572 0a20 2020 2020 2020 2053 6368  nder.        Sch
+0000d240: 6564 756c 6572 2e74 6173 6b73 2e20 5468  eduler.tasks. Th
+0000d250: 6973 2061 6c73 6f20 7072 6576 656e 7473  is also prevents
+0000d260: 2061 2052 6563 7572 7369 6f6e 4572 726f   a RecursionErro
+0000d270: 7220 6475 7269 6e67 2070 6172 7469 6375  r during particu
+0000d280: 6c61 726c 7920 6865 6176 790a 2020 2020  larly heavy.    
+0000d290: 2020 2020 6c6f 6164 732c 2077 6869 6368      loads, which
+0000d2a0: 2068 6176 6520 6265 656e 206f 6273 6572   have been obser
+0000d2b0: 7665 6420 746f 2068 6170 7065 6e20 7768  ved to happen wh
+0000d2c0: 656e 6576 6572 2074 6865 7265 2773 2061  enever there's a
+0000d2d0: 6e20 6163 7963 6c69 6320 6465 7065 6e64  n acyclic depend
+0000d2e0: 656e 6379 0a20 2020 2020 2020 2063 6861  ency.        cha
+0000d2f0: 696e 206f 6620 7e32 3030 2b20 7461 736b  in of ~200+ task
+0000d300: 732e 0a20 2020 2020 2020 2022 2222 0a20  s..        """. 
+0000d310: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
+0000d320: 6375 7273 6976 655f 746f 5f64 6963 7428  cursive_to_dict(
+0000d330: 7365 6c66 2c20 6578 636c 7564 653d 6578  self, exclude=ex
+0000d340: 636c 7564 652c 206d 656d 6265 7273 3d54  clude, members=T
+0000d350: 7275 6529 0a0a 0a63 6c61 7373 2054 7261  rue)...class Tra
+0000d360: 6e73 6974 696f 6e28 4e61 6d65 6454 7570  nsition(NamedTup
+0000d370: 6c65 293a 0a20 2020 2022 2222 416e 2065  le):.    """An e
+0000d380: 6e74 7279 2069 6e20 3a61 7474 723a 6053  ntry in :attr:`S
+0000d390: 6368 6564 756c 6572 5374 6174 652e 7472  chedulerState.tr
+0000d3a0: 616e 7369 7469 6f6e 5f6c 6f67 6022 2222  ansition_log`"""
+0000d3b0: 0a0a 2020 2020 6b65 793a 204b 6579 0a20  ..    key: Key. 
+0000d3c0: 2020 2073 7461 7274 3a20 5461 736b 5374     start: TaskSt
+0000d3d0: 6174 6553 7461 7465 0a20 2020 2066 696e  ateState.    fin
+0000d3e0: 6973 683a 2054 6173 6b53 7461 7465 5374  ish: TaskStateSt
+0000d3f0: 6174 650a 2020 2020 7265 636f 6d6d 656e  ate.    recommen
+0000d400: 6461 7469 6f6e 733a 2052 6563 730a 2020  dations: Recs.  
+0000d410: 2020 7374 696d 756c 7573 5f69 643a 2073    stimulus_id: s
+0000d420: 7472 0a20 2020 2074 696d 6573 7461 6d70  tr.    timestamp
+0000d430: 3a20 666c 6f61 740a 0a0a 636c 6173 7320  : float...class 
+0000d440: 5363 6865 6475 6c65 7253 7461 7465 3a0a  SchedulerState:.
+0000d450: 2020 2020 2222 2255 6e64 6572 6c79 696e      """Underlyin
+0000d460: 6720 7461 736b 2073 7461 7465 206f 6620  g task state of 
+0000d470: 6479 6e61 6d69 6320 7363 6865 6475 6c65  dynamic schedule
+0000d480: 720a 0a20 2020 2054 7261 636b 7320 7468  r..    Tracks th
+0000d490: 6520 6375 7272 656e 7420 7374 6174 6520  e current state 
+0000d4a0: 6f66 2077 6f72 6b65 7273 2c20 6461 7461  of workers, data
+0000d4b0: 2c20 616e 6420 636f 6d70 7574 6174 696f  , and computatio
+0000d4c0: 6e73 2e0a 0a20 2020 2048 616e 646c 6573  ns...    Handles
+0000d4d0: 2074 7261 6e73 6974 696f 6e73 2062 6574   transitions bet
+0000d4e0: 7765 656e 2064 6966 6665 7265 6e74 2074  ween different t
+0000d4f0: 6173 6b20 7374 6174 6573 2e20 4e6f 7469  ask states. Noti
+0000d500: 6669 6573 2074 6865 0a20 2020 2053 6368  fies the.    Sch
+0000d510: 6564 756c 6572 206f 6620 6368 616e 6765  eduler of change
+0000d520: 7320 6279 206d 6573 7361 6769 6e67 2070  s by messaging p
+0000d530: 6173 7369 6e67 2074 6872 6f75 6768 2051  assing through Q
+0000d540: 7565 7565 732c 2077 6869 6368 2074 6865  ueues, which the
+0000d550: 0a20 2020 2053 6368 6564 756c 6572 206c  .    Scheduler l
+0000d560: 6973 7465 6e73 2074 6f20 7265 7370 6f6e  istens to respon
+0000d570: 6473 2061 6363 6f72 6469 6e67 6c79 2e0a  ds accordingly..
+0000d580: 0a20 2020 2041 6c6c 2065 7665 6e74 7320  .    All events 
+0000d590: 6172 6520 6861 6e64 6c65 6420 7175 6963  are handled quic
+0000d5a0: 6b6c 792c 2069 6e20 6c69 6e65 6172 2074  kly, in linear t
+0000d5b0: 696d 6520 7769 7468 2072 6573 7065 6374  ime with respect
+0000d5c0: 2074 6f20 7468 6569 720a 2020 2020 696e   to their.    in
+0000d5d0: 7075 7420 2877 6869 6368 2069 7320 6f66  put (which is of
+0000d5e0: 7465 6e20 6f66 2063 6f6e 7374 616e 7420  ten of constant 
+0000d5f0: 7369 7a65 2920 616e 6420 6765 6e65 7261  size) and genera
+0000d600: 6c6c 7920 7769 7468 696e 2061 0a20 2020  lly within a.   
+0000d610: 206d 696c 6c69 7365 636f 6e64 2e0a 0a20   millisecond... 
+0000d620: 2020 2055 7365 7273 2074 7970 6963 616c     Users typical
+0000d630: 6c79 2064 6f20 6e6f 7420 696e 7465 7261  ly do not intera
+0000d640: 6374 2077 6974 6820 6060 5472 616e 7369  ct with ``Transi
+0000d650: 7469 6f6e 7360 6020 6469 7265 6374 6c79  tions`` directly
+0000d660: 2e20 496e 7374 6561 640a 2020 2020 7573  . Instead.    us
+0000d670: 6572 7320 696e 7465 7261 6374 2077 6974  ers interact wit
+0000d680: 6820 7468 6520 6060 436c 6965 6e74 6060  h the ``Client``
+0000d690: 2c20 7768 6963 6820 696e 2074 7572 6e20  , which in turn 
+0000d6a0: 656e 6761 6765 7320 7468 650a 2020 2020  engages the.    
+0000d6b0: 6060 5363 6865 6475 6c65 7260 6020 6166  ``Scheduler`` af
+0000d6c0: 6665 6374 696e 6720 6469 6666 6572 656e  fecting differen
+0000d6d0: 7420 7472 616e 7369 7469 6f6e 7320 6865  t transitions he
+0000d6e0: 7265 2075 6e64 6572 2d74 6865 2d68 6f6f  re under-the-hoo
+0000d6f0: 642e 2049 6e0a 2020 2020 7468 6520 6261  d. In.    the ba
+0000d700: 636b 6772 6f75 6e64 2060 6057 6f72 6b65  ckground ``Worke
+0000d710: 7260 6073 2061 6c73 6f20 656e 6761 6765  r``s also engage
+0000d720: 2077 6974 6820 7468 6520 6060 5363 6865   with the ``Sche
+0000d730: 6475 6c65 7260 600a 2020 2020 6166 6665  duler``.    affe
+0000d740: 6374 696e 6720 7468 6573 6520 7374 6174  cting these stat
+0000d750: 6520 7472 616e 7369 7469 6f6e 7320 6173  e transitions as
+0000d760: 2077 656c 6c2e 0a20 2020 2022 2222 0a0a   well..    """..
+0000d770: 2020 2020 6261 6e64 7769 6474 683a 2069      bandwidth: i
+0000d780: 6e74 0a0a 2020 2020 233a 2043 6c69 656e  nt..    #: Clien
+0000d790: 7473 2063 7572 7265 6e74 6c79 2063 6f6e  ts currently con
+0000d7a0: 6e65 6374 6564 2074 6f20 7468 6520 7363  nected to the sc
+0000d7b0: 6865 6475 6c65 720a 2020 2020 636c 6965  heduler.    clie
+0000d7c0: 6e74 733a 2064 6963 745b 7374 722c 2043  nts: dict[str, C
+0000d7d0: 6c69 656e 7453 7461 7465 5d0a 0a20 2020  lientState]..   
+0000d7e0: 2065 7874 656e 7369 6f6e 733a 2064 6963   extensions: dic
+0000d7f0: 745b 7374 722c 2041 6e79 5d20 2023 2054  t[str, Any]  # T
+0000d800: 4f44 4f20 7772 6974 6520 6120 7363 6865  ODO write a sche
+0000d810: 6475 6c65 7220 6578 7465 6e73 696f 6e20  duler extension 
+0000d820: 5072 6f74 6f63 6f6c 0a20 2020 2070 6c75  Protocol.    plu
+0000d830: 6769 6e73 3a20 6469 6374 5b73 7472 2c20  gins: dict[str, 
+0000d840: 5363 6865 6475 6c65 7250 6c75 6769 6e5d  SchedulerPlugin]
+0000d850: 0a20 2020 2068 6f73 745f 696e 666f 3a20  .    host_info: 
+0000d860: 6469 6374 5b73 7472 2c20 6469 6374 5b73  dict[str, dict[s
+0000d870: 7472 2c20 416e 795d 5d0a 0a20 2020 2023  tr, Any]]..    #
+0000d880: 3a20 4966 2054 7275 652c 2065 6e61 626c  : If True, enabl
+0000d890: 6520 6578 7065 6e73 6976 6520 696e 7465  e expensive inte
+0000d8a0: 726e 616c 2063 6f6e 7369 7374 656e 6379  rnal consistency
+0000d8b0: 2063 6865 636b 2e0a 2020 2020 233a 2054   check..    #: T
+0000d8c0: 7970 6963 616c 6c79 2064 6973 6162 6c65  ypically disable
+0000d8d0: 6420 696e 2070 726f 6475 6374 696f 6e2e  d in production.
+0000d8e0: 0a20 2020 2076 616c 6964 6174 653a 2062  .    validate: b
+0000d8f0: 6f6f 6c0a 0a20 2020 2023 2323 2323 2323  ool..    #######
+0000d900: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000d910: 0a20 2020 2023 2057 6f72 6b65 7273 2d72  .    # Workers-r
+0000d920: 656c 6174 6564 2073 7461 7465 0a20 2020  elated state.   
+0000d930: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
+0000d940: 2323 2323 2323 2323 0a0a 2020 2020 233a  ########..    #:
+0000d950: 2057 6f72 6b65 7273 2063 7572 7265 6e74   Workers current
+0000d960: 6c79 2063 6f6e 6e65 6374 6564 2074 6f20  ly connected to 
+0000d970: 7468 6520 7363 6865 6475 6c65 720a 2020  the scheduler.  
+0000d980: 2020 233a 2028 6163 7475 616c 6c79 2061    #: (actually a
+0000d990: 2053 6f72 7465 6444 6963 742c 2062 7574   SortedDict, but
+0000d9a0: 2074 6865 2073 6f72 7465 6463 6f6e 7461   the sortedconta
+0000d9b0: 696e 6572 7320 7061 636b 6167 6520 6973  iners package is
+0000d9c0: 6e27 7420 616e 6e6f 7461 7465 6429 0a20  n't annotated). 
+0000d9d0: 2020 2077 6f72 6b65 7273 3a20 6469 6374     workers: dict
+0000d9e0: 5b73 7472 2c20 576f 726b 6572 5374 6174  [str, WorkerStat
+0000d9f0: 655d 0a20 2020 2023 3a20 576f 726b 6572  e].    #: Worker
+0000da00: 207b 6e61 6d65 3a20 6164 6472 6573 737d   {name: address}
+0000da10: 0a20 2020 2061 6c69 6173 6573 3a20 6469  .    aliases: di
+0000da20: 6374 5b48 6173 6861 626c 652c 2073 7472  ct[Hashable, str
+0000da30: 5d0a 2020 2020 233a 2057 6f72 6b65 7273  ].    #: Workers
+0000da40: 2074 6861 7420 6172 6520 6375 7272 656e   that are curren
+0000da50: 746c 7920 696e 2072 756e 6e69 6e67 2073  tly in running s
+0000da60: 7461 7465 0a20 2020 2072 756e 6e69 6e67  tate.    running
+0000da70: 3a20 7365 745b 576f 726b 6572 5374 6174  : set[WorkerStat
+0000da80: 655d 0a20 2020 2023 3a20 576f 726b 6572  e].    #: Worker
+0000da90: 7320 7468 6174 2061 7265 2063 7572 7265  s that are curre
+0000daa0: 6e74 6c79 2069 6e20 7275 6e6e 696e 6720  ntly in running 
+0000dab0: 7374 6174 6520 616e 6420 6e6f 7420 6675  state and not fu
+0000dac0: 6c6c 7920 7574 696c 697a 6564 0a20 2020  lly utilized.   
+0000dad0: 2023 3a20 4465 6669 6e69 7469 6f6e 2062   #: Definition b
+0000dae0: 6173 6564 206f 6e20 6f63 6375 7061 6e63  ased on occupanc
+0000daf0: 790a 2020 2020 233a 2028 6163 7475 616c  y.    #: (actual
+0000db00: 6c79 2061 2053 6f72 7465 6444 6963 742c  ly a SortedDict,
+0000db10: 2062 7574 2074 6865 2073 6f72 7465 6463   but the sortedc
+0000db20: 6f6e 7461 696e 6572 7320 7061 636b 6167  ontainers packag
+0000db30: 6520 6973 6e27 7420 616e 6e6f 7461 7465  e isn't annotate
+0000db40: 6429 2e0a 2020 2020 233a 204e 6f74 2074  d)..    #: Not t
+0000db50: 6f20 6265 2063 6f6e 6675 7365 6420 7769  o be confused wi
+0000db60: 7468 203a 6d65 7468 3a60 6973 5f69 646c  th :meth:`is_idl
+0000db70: 6560 2e0a 2020 2020 6964 6c65 3a20 6469  e`..    idle: di
+0000db80: 6374 5b73 7472 2c20 576f 726b 6572 5374  ct[str, WorkerSt
+0000db90: 6174 655d 0a20 2020 2023 3a20 5369 6d69  ate].    #: Simi
+0000dba0: 6c61 7220 746f 2060 6964 6c65 600a 2020  lar to `idle`.  
+0000dbb0: 2020 233a 2044 6566 696e 6974 696f 6e20    #: Definition 
+0000dbc0: 6261 7365 6420 6f6e 2061 7373 6967 6e65  based on assigne
+0000dbd0: 6420 7461 736b 730a 2020 2020 6964 6c65  d tasks.    idle
+0000dbe0: 5f74 6173 6b5f 636f 756e 743a 2073 6574  _task_count: set
+0000dbf0: 5b57 6f72 6b65 7253 7461 7465 5d0a 2020  [WorkerState].  
+0000dc00: 2020 233a 2057 6f72 6b65 7273 2074 6861    #: Workers tha
+0000dc10: 7420 6172 6520 6675 6c6c 7920 7574 696c  t are fully util
+0000dc20: 697a 6564 2e20 4d61 7920 696e 636c 7564  ized. May includ
+0000dc30: 6520 6e6f 6e2d 7275 6e6e 696e 6720 776f  e non-running wo
+0000dc40: 726b 6572 732e 0a20 2020 2073 6174 7572  rkers..    satur
+0000dc50: 6174 6564 3a20 7365 745b 576f 726b 6572  ated: set[Worker
+0000dc60: 5374 6174 655d 0a20 2020 2023 3a20 4375  State].    #: Cu
+0000dc70: 7272 656e 7420 6e75 6d62 6572 206f 6620  rrent number of 
+0000dc80: 7468 7265 6164 7320 6163 726f 7373 2061  threads across a
+0000dc90: 6c6c 2077 6f72 6b65 7273 0a20 2020 2074  ll workers.    t
+0000dca0: 6f74 616c 5f6e 7468 7265 6164 733a 2069  otal_nthreads: i
+0000dcb0: 6e74 0a20 2020 2023 3a20 4869 7374 6f72  nt.    #: Histor
+0000dcc0: 7920 6f66 206e 756d 6265 7220 6f66 2074  y of number of t
+0000dcd0: 6872 6561 6473 0a20 2020 2023 3a20 2874  hreads.    #: (t
+0000dce0: 696d 6573 7461 6d70 2c20 6e65 7720 6e75  imestamp, new nu
+0000dcf0: 6d62 6572 206f 6620 7468 7265 6164 7329  mber of threads)
+0000dd00: 0a20 2020 2074 6f74 616c 5f6e 7468 7265  .    total_nthre
+0000dd10: 6164 735f 6869 7374 6f72 793a 206c 6973  ads_history: lis
+0000dd20: 745b 7475 706c 655b 666c 6f61 742c 2069  t[tuple[float, i
+0000dd30: 6e74 5d5d 0a20 2020 2023 3a20 436c 7573  nt]].    #: Clus
+0000dd40: 7465 722d 7769 6465 2072 6573 6f75 7263  ter-wide resourc
+0000dd50: 6573 2e20 7b72 6573 6f75 7263 6520 6e61  es. {resource na
+0000dd60: 6d65 3a20 7b77 6f72 6b65 7220 6164 6472  me: {worker addr
+0000dd70: 6573 733a 2061 6d6f 756e 747d 7d0a 2020  ess: amount}}.  
+0000dd80: 2020 7265 736f 7572 6365 733a 2064 6963    resources: dic
+0000dd90: 745b 7374 722c 2064 6963 745b 7374 722c  t[str, dict[str,
+0000dda0: 2066 6c6f 6174 5d5d 0a0a 2020 2020 2323   float]]..    ##
+0000ddb0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000ddc0: 2323 230a 2020 2020 2320 5461 736b 732d  ###.    # Tasks-
+0000ddd0: 7265 6c61 7465 6420 7374 6174 650a 2020  related state.  
+0000dde0: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
+0000ddf0: 2323 2323 2323 230a 0a20 2020 2023 3a20  #######..    #: 
+0000de00: 546f 7461 6c20 6e75 6d62 6572 206f 6620  Total number of 
+0000de10: 7461 736b 7320 6576 6572 2070 726f 6365  tasks ever proce
+0000de20: 7373 6564 0a20 2020 206e 5f74 6173 6b73  ssed.    n_tasks
+0000de30: 3a20 696e 740a 0a20 2020 2023 3a20 416c  : int..    #: Al
+0000de40: 6c20 7461 736b 7320 6375 7272 656e 746c  l tasks currentl
+0000de50: 7920 6b6e 6f77 6e20 746f 2074 6865 2073  y known to the s
+0000de60: 6368 6564 756c 6572 0a20 2020 2074 6173  cheduler.    tas
+0000de70: 6b73 3a20 6469 6374 5b4b 6579 2c20 5461  ks: dict[Key, Ta
+0000de80: 736b 5374 6174 655d 0a0a 2020 2020 233a  skState]..    #:
+0000de90: 2054 6173 6b73 2069 6e20 7468 6520 2271   Tasks in the "q
+0000dea0: 7565 7565 6422 2073 7461 7465 2c20 6f72  ueued" state, or
+0000deb0: 6465 7265 6420 6279 2070 7269 6f72 6974  dered by priorit
+0000dec0: 790a 2020 2020 7175 6575 6564 3a20 4865  y.    queued: He
+0000ded0: 6170 5365 745b 5461 736b 5374 6174 655d  apSet[TaskState]
+0000dee0: 0a0a 2020 2020 233a 2054 6173 6b73 2069  ..    #: Tasks i
+0000def0: 6e20 7468 6520 226e 6f2d 776f 726b 6572  n the "no-worker
+0000df00: 2220 7374 6174 650a 2020 2020 756e 7275  " state.    unru
+0000df10: 6e6e 6162 6c65 3a20 7365 745b 5461 736b  nnable: set[Task
+0000df20: 5374 6174 655d 0a0a 2020 2020 233a 2053  State]..    #: S
+0000df30: 7562 7365 7420 6f66 2074 6173 6b73 2074  ubset of tasks t
+0000df40: 6861 7420 6578 6973 7420 696e 206d 656d  hat exist in mem
+0000df50: 6f72 7920 6f6e 206d 6f72 6520 7468 616e  ory on more than
+0000df60: 206f 6e65 2077 6f72 6b65 720a 2020 2020   one worker.    
+0000df70: 7265 706c 6963 6174 6564 5f74 6173 6b73  replicated_tasks
+0000df80: 3a20 7365 745b 5461 736b 5374 6174 655d  : set[TaskState]
+0000df90: 0a0a 2020 2020 233a 2054 6173 6b73 2077  ..    #: Tasks w
+0000dfa0: 6974 6820 756e 6b6e 6f77 6e20 6475 7261  ith unknown dura
+0000dfb0: 7469 6f6e 2c20 6772 6f75 7065 6420 6279  tion, grouped by
+0000dfc0: 2070 7265 6669 780a 2020 2020 233a 207b   prefix.    #: {
+0000dfd0: 7461 736b 2070 7265 6669 783a 207b 7473  task prefix: {ts
+0000dfe0: 2c20 7473 2c20 2e2e 2e7d 7d0a 2020 2020  , ts, ...}}.    
+0000dff0: 756e 6b6e 6f77 6e5f 6475 7261 7469 6f6e  unknown_duration
+0000e000: 733a 2064 6963 745b 7374 722c 2073 6574  s: dict[str, set
+0000e010: 5b54 6173 6b53 7461 7465 5d5d 0a20 2020  [TaskState]].   
+0000e020: 2074 6173 6b5f 6772 6f75 7073 3a20 6469   task_groups: di
+0000e030: 6374 5b73 7472 2c20 5461 736b 4772 6f75  ct[str, TaskGrou
+0000e040: 705d 0a20 2020 2074 6173 6b5f 7072 6566  p].    task_pref
+0000e050: 6978 6573 3a20 6469 6374 5b73 7472 2c20  ixes: dict[str, 
+0000e060: 5461 736b 5072 6566 6978 5d0a 2020 2020  TaskPrefix].    
+0000e070: 7461 736b 5f6d 6574 6164 6174 613a 2064  task_metadata: d
+0000e080: 6963 745b 4b65 792c 2041 6e79 5d0a 0a20  ict[Key, Any].. 
+0000e090: 2020 2023 2323 2323 2323 2323 0a20 2020     #########.   
+0000e0a0: 2023 2048 6973 746f 7279 0a20 2020 2023   # History.    #
+0000e0b0: 2323 2323 2323 2323 0a0a 2020 2020 233a  ########..    #:
+0000e0c0: 2048 6973 746f 7279 206f 6620 636f 6d70   History of comp
+0000e0d0: 7574 6174 696f 6e73 2e0a 2020 2020 233a  utations..    #:
+0000e0e0: 2054 6865 206c 656e 6774 6820 6361 6e20   The length can 
+0000e0f0: 6265 2074 7765 616b 6564 2074 6872 6f75  be tweaked throu
+0000e100: 6768 0a20 2020 2023 3a20 6469 7374 7269  gh.    #: distri
+0000e110: 6275 7465 642e 6469 6167 6e6f 7374 6963  buted.diagnostic
+0000e120: 732e 636f 6d70 7574 6174 696f 6e73 2e6d  s.computations.m
+0000e130: 6178 2d68 6973 746f 7279 0a20 2020 2063  ax-history.    c
+0000e140: 6f6d 7075 7461 7469 6f6e 733a 2064 6571  omputations: deq
+0000e150: 7565 5b43 6f6d 7075 7461 7469 6f6e 5d0a  ue[Computation].
+0000e160: 0a20 2020 2023 3a20 4869 7374 6f72 7920  .    #: History 
+0000e170: 6f66 2065 7272 6564 2074 6173 6b73 2e0a  of erred tasks..
+0000e180: 2020 2020 233a 2054 6865 206c 656e 6774      #: The lengt
+0000e190: 6820 6361 6e20 6265 2074 7765 616b 6564  h can be tweaked
+0000e1a0: 2074 6872 6f75 6768 0a20 2020 2023 3a20   through.    #: 
+0000e1b0: 6469 7374 7269 6275 7465 642e 6469 6167  distributed.diag
+0000e1c0: 6e6f 7374 6963 732e 6572 7265 642d 7461  nostics.erred-ta
+0000e1d0: 736b 732e 6d61 782d 6869 7374 6f72 790a  sks.max-history.
+0000e1e0: 2020 2020 6572 7265 645f 7461 736b 733a      erred_tasks:
+0000e1f0: 2064 6571 7565 5b45 7272 6564 5461 736b   deque[ErredTask
+0000e200: 5d0a 0a20 2020 2023 3a20 4869 7374 6f72  ]..    #: Histor
+0000e210: 7920 6f66 2074 6173 6b20 7374 6174 6520  y of task state 
+0000e220: 7472 616e 7369 7469 6f6e 732e 0a20 2020  transitions..   
+0000e230: 2023 3a20 5468 6520 6c65 6e67 7468 2063   #: The length c
+0000e240: 616e 2062 6520 7477 6561 6b65 6420 7468  an be tweaked th
+0000e250: 726f 7567 680a 2020 2020 233a 2064 6973  rough.    #: dis
+0000e260: 7472 6962 7574 6564 2e61 646d 696e 2e6c  tributed.admin.l
+0000e270: 6f77 2d6c 6576 656c 2d6c 6f67 2d6c 656e  ow-level-log-len
+0000e280: 6774 680a 2020 2020 7472 616e 7369 7469  gth.    transiti
+0000e290: 6f6e 5f6c 6f67 3a20 6465 7175 655b 5472  on_log: deque[Tr
+0000e2a0: 616e 7369 7469 6f6e 5d0a 0a20 2020 2023  ansition]..    #
+0000e2b0: 3a20 546f 7461 6c20 6e75 6d62 6572 206f  : Total number o
+0000e2c0: 6620 7472 616e 7369 7469 6f6e 7320 7369  f transitions si
+0000e2d0: 6e63 6520 7468 6520 636c 7573 7465 7220  nce the cluster 
+0000e2e0: 7761 7320 7374 6172 7465 640a 2020 2020  was started.    
+0000e2f0: 7472 616e 7369 7469 6f6e 5f63 6f75 6e74  transition_count
+0000e300: 6572 3a20 696e 740a 0a20 2020 2023 3a20  er: int..    #: 
+0000e310: 546f 7461 6c20 6e75 6d62 6572 206f 6620  Total number of 
+0000e320: 7472 616e 7369 7469 6f6e 7320 6173 206f  transitions as o
+0000e330: 6620 7468 6520 7072 6576 696f 7573 2063  f the previous c
+0000e340: 616c 6c20 746f 2063 6865 636b 5f69 646c  all to check_idl
+0000e350: 6528 290a 2020 2020 5f69 646c 655f 7472  e().    _idle_tr
+0000e360: 616e 7369 7469 6f6e 5f63 6f75 6e74 6572  ansition_counter
+0000e370: 3a20 696e 740a 0a20 2020 2023 3a20 5261  : int..    #: Ra
+0000e380: 6973 6520 616e 2065 7272 6f72 2069 6620  ise an error if 
+0000e390: 7468 6520 3a61 7474 723a 6074 7261 6e73  the :attr:`trans
+0000e3a0: 6974 696f 6e5f 636f 756e 7465 7260 2065  ition_counter` e
+0000e3b0: 7665 7220 7265 6163 6865 7320 7468 6973  ver reaches this
+0000e3c0: 2076 616c 7565 2e0a 2020 2020 233a 2054   value..    #: T
+0000e3d0: 6869 7320 6973 206d 6561 6e74 2066 6f72  his is meant for
+0000e3e0: 2064 6562 7567 6769 6e67 206f 6e6c 792c   debugging only,
+0000e3f0: 2074 6f20 6361 7463 6820 696e 6669 6e69   to catch infini
+0000e400: 7465 2072 6563 7572 7369 6f6e 206c 6f6f  te recursion loo
+0000e410: 7073 2e0a 2020 2020 233a 2049 6e20 7072  ps..    #: In pr
+0000e420: 6f64 7563 7469 6f6e 2c20 6974 2073 686f  oduction, it sho
+0000e430: 756c 6420 616c 7761 7973 2062 6520 7365  uld always be se
+0000e440: 7420 746f 2046 616c 7365 2e0a 2020 2020  t to False..    
+0000e450: 7472 616e 7369 7469 6f6e 5f63 6f75 6e74  transition_count
+0000e460: 6572 5f6d 6178 3a20 696e 7420 7c20 4c69  er_max: int | Li
+0000e470: 7465 7261 6c5b 4661 6c73 655d 0a0a 2020  teral[False]..  
+0000e480: 2020 5f74 6173 6b5f 7072 6566 6978 5f63    _task_prefix_c
+0000e490: 6f75 6e74 5f67 6c6f 6261 6c3a 2064 6566  ount_global: def
+0000e4a0: 6175 6c74 6469 6374 5b73 7472 2c20 696e  aultdict[str, in
+0000e4b0: 745d 0a20 2020 205f 6e65 7477 6f72 6b5f  t].    _network_
+0000e4c0: 6f63 635f 676c 6f62 616c 3a20 666c 6f61  occ_global: floa
+0000e4d0: 740a 2020 2020 2323 2323 2323 2323 2323  t.    ##########
+0000e4e0: 2323 2323 2323 2323 2323 2323 0a20 2020  ############.   
+0000e4f0: 2023 2043 6163 6865 6420 636f 6e66 6967   # Cached config
+0000e500: 7572 6174 696f 6e0a 2020 2020 2323 2323  uration.    ####
+0000e510: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000e520: 2323 0a0a 2020 2020 233a 2064 6973 7472  ##..    #: distr
+0000e530: 6962 7574 6564 2e73 6368 6564 756c 6572  ibuted.scheduler
+0000e540: 2e75 6e6b 6e6f 776e 2d74 6173 6b2d 6475  .unknown-task-du
+0000e550: 7261 7469 6f6e 0a20 2020 2055 4e4b 4e4f  ration.    UNKNO
+0000e560: 574e 5f54 4153 4b5f 4455 5241 5449 4f4e  WN_TASK_DURATION
+0000e570: 3a20 666c 6f61 740a 2020 2020 233a 2064  : float.    #: d
+0000e580: 6973 7472 6962 7574 6564 2e77 6f72 6b65  istributed.worke
+0000e590: 722e 6d65 6d6f 7279 2e72 6563 656e 742d  r.memory.recent-
+0000e5a0: 746f 2d6f 6c64 2d74 696d 650a 2020 2020  to-old-time.    
+0000e5b0: 4d45 4d4f 5259 5f52 4543 454e 545f 544f  MEMORY_RECENT_TO
+0000e5c0: 5f4f 4c44 5f54 494d 453a 2066 6c6f 6174  _OLD_TIME: float
+0000e5d0: 0a20 2020 2023 3a20 6469 7374 7269 6275  .    #: distribu
+0000e5e0: 7465 642e 776f 726b 6572 2e6d 656d 6f72  ted.worker.memor
+0000e5f0: 792e 7265 6261 6c61 6e63 652e 6d65 6173  y.rebalance.meas
+0000e600: 7572 650a 2020 2020 4d45 4d4f 5259 5f52  ure.    MEMORY_R
+0000e610: 4542 414c 414e 4345 5f4d 4541 5355 5245  EBALANCE_MEASURE
+0000e620: 3a20 7374 720a 2020 2020 233a 2064 6973  : str.    #: dis
+0000e630: 7472 6962 7574 6564 2e77 6f72 6b65 722e  tributed.worker.
+0000e640: 6d65 6d6f 7279 2e72 6562 616c 616e 6365  memory.rebalance
+0000e650: 2e73 656e 6465 722d 6d69 6e0a 2020 2020  .sender-min.    
+0000e660: 4d45 4d4f 5259 5f52 4542 414c 414e 4345  MEMORY_REBALANCE
+0000e670: 5f53 454e 4445 525f 4d49 4e3a 2066 6c6f  _SENDER_MIN: flo
+0000e680: 6174 0a20 2020 2023 3a20 6469 7374 7269  at.    #: distri
+0000e690: 6275 7465 642e 776f 726b 6572 2e6d 656d  buted.worker.mem
+0000e6a0: 6f72 792e 7265 6261 6c61 6e63 652e 7265  ory.rebalance.re
+0000e6b0: 6369 7069 656e 742d 6d61 780a 2020 2020  cipient-max.    
+0000e6c0: 4d45 4d4f 5259 5f52 4542 414c 414e 4345  MEMORY_REBALANCE
+0000e6d0: 5f52 4543 4950 4945 4e54 5f4d 4158 3a20  _RECIPIENT_MAX: 
+0000e6e0: 666c 6f61 740a 2020 2020 233a 2064 6973  float.    #: dis
+0000e6f0: 7472 6962 7574 6564 2e77 6f72 6b65 722e  tributed.worker.
+0000e700: 6d65 6d6f 7279 2e72 6562 616c 616e 6365  memory.rebalance
+0000e710: 2e73 656e 6465 722d 7265 6369 7069 656e  .sender-recipien
+0000e720: 742d 6761 7020 2f20 320a 2020 2020 4d45  t-gap / 2.    ME
+0000e730: 4d4f 5259 5f52 4542 414c 414e 4345 5f48  MORY_REBALANCE_H
+0000e740: 414c 465f 4741 503a 2066 6c6f 6174 0a20  ALF_GAP: float. 
+0000e750: 2020 2023 3a20 6469 7374 7269 6275 7465     #: distribute
+0000e760: 642e 7363 6865 6475 6c65 722e 776f 726b  d.scheduler.work
+0000e770: 6572 2d73 6174 7572 6174 696f 6e0a 2020  er-saturation.  
+0000e780: 2020 574f 524b 4552 5f53 4154 5552 4154    WORKER_SATURAT
+0000e790: 494f 4e3a 2066 6c6f 6174 0a0a 2020 2020  ION: float..    
+0000e7a0: 5f5f 736c 6f74 735f 5f20 3d20 7475 706c  __slots__ = tupl
+0000e7b0: 6528 5f5f 616e 6e6f 7461 7469 6f6e 735f  e(__annotations_
+0000e7c0: 5f29 0a0a 2020 2020 6465 6620 5f5f 696e  _)..    def __in
+0000e7d0: 6974 5f5f 280a 2020 2020 2020 2020 7365  it__(.        se
+0000e7e0: 6c66 2c0a 2020 2020 2020 2020 616c 6961  lf,.        alia
+0000e7f0: 7365 733a 2064 6963 745b 4861 7368 6162  ses: dict[Hashab
+0000e800: 6c65 2c20 7374 725d 2c0a 2020 2020 2020  le, str],.      
+0000e810: 2020 636c 6965 6e74 733a 2064 6963 745b    clients: dict[
+0000e820: 7374 722c 2043 6c69 656e 7453 7461 7465  str, ClientState
+0000e830: 5d2c 0a20 2020 2020 2020 2077 6f72 6b65  ],.        worke
+0000e840: 7273 3a20 536f 7274 6564 4469 6374 5b73  rs: SortedDict[s
+0000e850: 7472 2c20 576f 726b 6572 5374 6174 655d  tr, WorkerState]
+0000e860: 2c0a 2020 2020 2020 2020 686f 7374 5f69  ,.        host_i
+0000e870: 6e66 6f3a 2064 6963 745b 7374 722c 2064  nfo: dict[str, d
+0000e880: 6963 745b 7374 722c 2041 6e79 5d5d 2c0a  ict[str, Any]],.
+0000e890: 2020 2020 2020 2020 7265 736f 7572 6365          resource
+0000e8a0: 733a 2064 6963 745b 7374 722c 2064 6963  s: dict[str, dic
+0000e8b0: 745b 7374 722c 2066 6c6f 6174 5d5d 2c0a  t[str, float]],.
+0000e8c0: 2020 2020 2020 2020 7461 736b 733a 2064          tasks: d
+0000e8d0: 6963 745b 4b65 792c 2054 6173 6b53 7461  ict[Key, TaskSta
+0000e8e0: 7465 5d2c 0a20 2020 2020 2020 2075 6e72  te],.        unr
+0000e8f0: 756e 6e61 626c 653a 2073 6574 5b54 6173  unnable: set[Tas
+0000e900: 6b53 7461 7465 5d2c 0a20 2020 2020 2020  kState],.       
+0000e910: 2071 7565 7565 643a 2048 6561 7053 6574   queued: HeapSet
+0000e920: 5b54 6173 6b53 7461 7465 5d2c 0a20 2020  [TaskState],.   
+0000e930: 2020 2020 2076 616c 6964 6174 653a 2062       validate: b
+0000e940: 6f6f 6c2c 0a20 2020 2020 2020 2070 6c75  ool,.        plu
+0000e950: 6769 6e73 3a20 4974 6572 6162 6c65 5b53  gins: Iterable[S
+0000e960: 6368 6564 756c 6572 506c 7567 696e 5d20  chedulerPlugin] 
+0000e970: 3d20 2829 2c0a 2020 2020 2020 2020 7472  = (),.        tr
+0000e980: 616e 7369 7469 6f6e 5f63 6f75 6e74 6572  ansition_counter
+0000e990: 5f6d 6178 3a20 696e 7420 7c20 4c69 7465  _max: int | Lite
+0000e9a0: 7261 6c5b 4661 6c73 655d 203d 2046 616c  ral[False] = Fal
+0000e9b0: 7365 2c0a 2020 2020 2020 2020 2a2a 6b77  se,.        **kw
+0000e9c0: 6172 6773 3a20 416e 792c 2020 2320 5061  args: Any,  # Pa
+0000e9d0: 7373 6564 2076 6572 6261 7469 6d20 746f  ssed verbatim to
+0000e9e0: 2053 6572 7665 722e 5f5f 696e 6974 5f5f   Server.__init__
+0000e9f0: 2829 0a20 2020 2029 3a0a 2020 2020 2020  ().    ):.      
+0000ea00: 2020 6c6f 6767 6572 2e69 6e66 6f28 2253    logger.info("S
+0000ea10: 7461 7465 2073 7461 7274 2229 0a20 2020  tate start").   
+0000ea20: 2020 2020 2073 656c 662e 616c 6961 7365       self.aliase
+0000ea30: 7320 3d20 616c 6961 7365 730a 2020 2020  s = aliases.    
+0000ea40: 2020 2020 7365 6c66 2e62 616e 6477 6964      self.bandwid
+0000ea50: 7468 203d 2070 6172 7365 5f62 7974 6573  th = parse_bytes
+0000ea60: 2864 6173 6b2e 636f 6e66 6967 2e67 6574  (dask.config.get
+0000ea70: 2822 6469 7374 7269 6275 7465 642e 7363  ("distributed.sc
+0000ea80: 6865 6475 6c65 722e 6261 6e64 7769 6474  heduler.bandwidt
+0000ea90: 6822 2929 0a20 2020 2020 2020 2073 656c  h")).        sel
+0000eaa0: 662e 636c 6965 6e74 7320 3d20 636c 6965  f.clients = clie
+0000eab0: 6e74 730a 2020 2020 2020 2020 7365 6c66  nts.        self
+0000eac0: 2e63 6c69 656e 7473 5b22 6669 7265 2d61  .clients["fire-a
+0000ead0: 6e64 2d66 6f72 6765 7422 5d20 3d20 436c  nd-forget"] = Cl
+0000eae0: 6965 6e74 5374 6174 6528 2266 6972 652d  ientState("fire-
+0000eaf0: 616e 642d 666f 7267 6574 2229 0a20 2020  and-forget").   
+0000eb00: 2020 2020 2073 656c 662e 6578 7465 6e73       self.extens
+0000eb10: 696f 6e73 203d 207b 7d0a 2020 2020 2020  ions = {}.      
+0000eb20: 2020 7365 6c66 2e68 6f73 745f 696e 666f    self.host_info
+0000eb30: 203d 2068 6f73 745f 696e 666f 0a20 2020   = host_info.   
+0000eb40: 2020 2020 2073 656c 662e 6964 6c65 203d       self.idle =
+0000eb50: 2053 6f72 7465 6444 6963 7428 290a 2020   SortedDict().  
+0000eb60: 2020 2020 2020 7365 6c66 2e69 646c 655f        self.idle_
+0000eb70: 7461 736b 5f63 6f75 6e74 203d 2073 6574  task_count = set
+0000eb80: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
+0000eb90: 6e5f 7461 736b 7320 3d20 300a 2020 2020  n_tasks = 0.    
+0000eba0: 2020 2020 7365 6c66 2e72 6573 6f75 7263      self.resourc
+0000ebb0: 6573 203d 2072 6573 6f75 7263 6573 0a20  es = resources. 
+0000ebc0: 2020 2020 2020 2073 656c 662e 7361 7475         self.satu
+0000ebd0: 7261 7465 6420 3d20 7365 7428 290a 2020  rated = set().  
+0000ebe0: 2020 2020 2020 7365 6c66 2e74 6173 6b73        self.tasks
+0000ebf0: 203d 2074 6173 6b73 0a20 2020 2020 2020   = tasks.       
+0000ec00: 2073 656c 662e 7265 706c 6963 6174 6564   self.replicated
+0000ec10: 5f74 6173 6b73 203d 207b 0a20 2020 2020  _tasks = {.     
+0000ec20: 2020 2020 2020 2074 7320 666f 7220 7473         ts for ts
+0000ec30: 2069 6e20 7365 6c66 2e74 6173 6b73 2e76   in self.tasks.v
+0000ec40: 616c 7565 7328 2920 6966 206c 656e 2874  alues() if len(t
+0000ec50: 732e 7768 6f5f 6861 7320 6f72 2028 2929  s.who_has or ())
+0000ec60: 203e 2031 0a20 2020 2020 2020 207d 0a20   > 1.        }. 
+0000ec70: 2020 2020 2020 2073 656c 662e 636f 6d70         self.comp
+0000ec80: 7574 6174 696f 6e73 203d 2064 6571 7565  utations = deque
+0000ec90: 280a 2020 2020 2020 2020 2020 2020 6d61  (.            ma
+0000eca0: 786c 656e 3d64 6173 6b2e 636f 6e66 6967  xlen=dask.config
+0000ecb0: 2e67 6574 2822 6469 7374 7269 6275 7465  .get("distribute
+0000ecc0: 642e 6469 6167 6e6f 7374 6963 732e 636f  d.diagnostics.co
+0000ecd0: 6d70 7574 6174 696f 6e73 2e6d 6178 2d68  mputations.max-h
+0000ece0: 6973 746f 7279 2229 0a20 2020 2020 2020  istory").       
+0000ecf0: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
+0000ed00: 6572 7265 645f 7461 736b 7320 3d20 6465  erred_tasks = de
+0000ed10: 7175 6528 0a20 2020 2020 2020 2020 2020  que(.           
+0000ed20: 206d 6178 6c65 6e3d 6461 736b 2e63 6f6e   maxlen=dask.con
+0000ed30: 6669 672e 6765 7428 2264 6973 7472 6962  fig.get("distrib
+0000ed40: 7574 6564 2e64 6961 676e 6f73 7469 6373  uted.diagnostics
+0000ed50: 2e65 7272 6564 2d74 6173 6b73 2e6d 6178  .erred-tasks.max
+0000ed60: 2d68 6973 746f 7279 2229 0a20 2020 2020  -history").     
+0000ed70: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
+0000ed80: 662e 7461 736b 5f67 726f 7570 7320 3d20  f.task_groups = 
+0000ed90: 7b7d 0a20 2020 2020 2020 2073 656c 662e  {}.        self.
+0000eda0: 7461 736b 5f70 7265 6669 7865 7320 3d20  task_prefixes = 
+0000edb0: 7b7d 0a20 2020 2020 2020 2073 656c 662e  {}.        self.
+0000edc0: 7461 736b 5f6d 6574 6164 6174 6120 3d20  task_metadata = 
+0000edd0: 7b7d 0a20 2020 2020 2020 2073 656c 662e  {}.        self.
+0000ede0: 746f 7461 6c5f 6e74 6872 6561 6473 203d  total_nthreads =
+0000edf0: 2030 0a20 2020 2020 2020 2073 656c 662e   0.        self.
+0000ee00: 746f 7461 6c5f 6e74 6872 6561 6473 5f68  total_nthreads_h
+0000ee10: 6973 746f 7279 203d 205b 2874 696d 6528  istory = [(time(
+0000ee20: 292c 2030 295d 0a20 2020 2020 2020 2073  ), 0)].        s
+0000ee30: 656c 662e 756e 6b6e 6f77 6e5f 6475 7261  elf.unknown_dura
+0000ee40: 7469 6f6e 7320 3d20 7b7d 0a20 2020 2020  tions = {}.     
+0000ee50: 2020 2073 656c 662e 7175 6575 6564 203d     self.queued =
+0000ee60: 2071 7565 7565 640a 2020 2020 2020 2020   queued.        
+0000ee70: 7365 6c66 2e75 6e72 756e 6e61 626c 6520  self.unrunnable 
+0000ee80: 3d20 756e 7275 6e6e 6162 6c65 0a20 2020  = unrunnable.   
+0000ee90: 2020 2020 2073 656c 662e 7661 6c69 6461       self.valida
+0000eea0: 7465 203d 2076 616c 6964 6174 650a 2020  te = validate.  
+0000eeb0: 2020 2020 2020 7365 6c66 2e77 6f72 6b65        self.worke
+0000eec0: 7273 203d 2077 6f72 6b65 7273 0a20 2020  rs = workers.   
+0000eed0: 2020 2020 2073 656c 662e 5f74 6173 6b5f       self._task_
+0000eee0: 7072 6566 6978 5f63 6f75 6e74 5f67 6c6f  prefix_count_glo
+0000eef0: 6261 6c20 3d20 6465 6661 756c 7464 6963  bal = defaultdic
+0000ef00: 7428 696e 7429 0a20 2020 2020 2020 2073  t(int).        s
+0000ef10: 656c 662e 5f6e 6574 776f 726b 5f6f 6363  elf._network_occ
+0000ef20: 5f67 6c6f 6261 6c20 3d20 302e 300a 2020  _global = 0.0.  
+0000ef30: 2020 2020 2020 7365 6c66 2e72 756e 6e69        self.runni
+0000ef40: 6e67 203d 207b 0a20 2020 2020 2020 2020  ng = {.         
+0000ef50: 2020 2077 7320 666f 7220 7773 2069 6e20     ws for ws in 
+0000ef60: 7365 6c66 2e77 6f72 6b65 7273 2e76 616c  self.workers.val
+0000ef70: 7565 7328 2920 6966 2077 732e 7374 6174  ues() if ws.stat
+0000ef80: 7573 203d 3d20 5374 6174 7573 2e72 756e  us == Status.run
+0000ef90: 6e69 6e67 0a20 2020 2020 2020 207d 0a20  ning.        }. 
+0000efa0: 2020 2020 2020 2073 656c 662e 706c 7567         self.plug
+0000efb0: 696e 7320 3d20 7b7d 2069 6620 6e6f 7420  ins = {} if not 
+0000efc0: 706c 7567 696e 7320 656c 7365 207b 5f67  plugins else {_g
+0000efd0: 6574 5f70 6c75 6769 6e5f 6e61 6d65 2870  et_plugin_name(p
+0000efe0: 293a 2070 2066 6f72 2070 2069 6e20 706c  ): p for p in pl
+0000eff0: 7567 696e 737d 0a0a 2020 2020 2020 2020  ugins}..        
+0000f000: 7365 6c66 2e74 7261 6e73 6974 696f 6e5f  self.transition_
+0000f010: 6c6f 6720 3d20 6465 7175 6528 0a20 2020  log = deque(.   
+0000f020: 2020 2020 2020 2020 206d 6178 6c65 6e3d           maxlen=
+0000f030: 6461 736b 2e63 6f6e 6669 672e 6765 7428  dask.config.get(
+0000f040: 2264 6973 7472 6962 7574 6564 2e61 646d  "distributed.adm
+0000f050: 696e 2e6c 6f77 2d6c 6576 656c 2d6c 6f67  in.low-level-log
+0000f060: 2d6c 656e 6774 6822 290a 2020 2020 2020  -length").      
+0000f070: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
+0000f080: 2e74 7261 6e73 6974 696f 6e5f 636f 756e  .transition_coun
+0000f090: 7465 7220 3d20 300a 2020 2020 2020 2020  ter = 0.        
+0000f0a0: 7365 6c66 2e5f 6964 6c65 5f74 7261 6e73  self._idle_trans
+0000f0b0: 6974 696f 6e5f 636f 756e 7465 7220 3d20  ition_counter = 
+0000f0c0: 300a 2020 2020 2020 2020 7365 6c66 2e74  0.        self.t
+0000f0d0: 7261 6e73 6974 696f 6e5f 636f 756e 7465  ransition_counte
+0000f0e0: 725f 6d61 7820 3d20 7472 616e 7369 7469  r_max = transiti
+0000f0f0: 6f6e 5f63 6f75 6e74 6572 5f6d 6178 0a0a  on_counter_max..
+0000f100: 2020 2020 2020 2020 2320 5661 7269 6162          # Variab
+0000f110: 6c65 7320 6672 6f6d 2064 6173 6b2e 636f  les from dask.co
+0000f120: 6e66 6967 2c20 6361 6368 6564 2062 7920  nfig, cached by 
+0000f130: 5f5f 696e 6974 5f5f 2066 6f72 2070 6572  __init__ for per
+0000f140: 666f 726d 616e 6365 0a20 2020 2020 2020  formance.       
+0000f150: 2073 656c 662e 554e 4b4e 4f57 4e5f 5441   self.UNKNOWN_TA
+0000f160: 534b 5f44 5552 4154 494f 4e20 3d20 7061  SK_DURATION = pa
+0000f170: 7273 655f 7469 6d65 6465 6c74 6128 0a20  rse_timedelta(. 
+0000f180: 2020 2020 2020 2020 2020 2064 6173 6b2e             dask.
+0000f190: 636f 6e66 6967 2e67 6574 2822 6469 7374  config.get("dist
+0000f1a0: 7269 6275 7465 642e 7363 6865 6475 6c65  ributed.schedule
+0000f1b0: 722e 756e 6b6e 6f77 6e2d 7461 736b 2d64  r.unknown-task-d
+0000f1c0: 7572 6174 696f 6e22 290a 2020 2020 2020  uration").      
+0000f1d0: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
+0000f1e0: 2e4d 454d 4f52 595f 5245 4345 4e54 5f54  .MEMORY_RECENT_T
+0000f1f0: 4f5f 4f4c 445f 5449 4d45 203d 2070 6172  O_OLD_TIME = par
+0000f200: 7365 5f74 696d 6564 656c 7461 280a 2020  se_timedelta(.  
+0000f210: 2020 2020 2020 2020 2020 6461 736b 2e63            dask.c
+0000f220: 6f6e 6669 672e 6765 7428 2264 6973 7472  onfig.get("distr
+0000f230: 6962 7574 6564 2e77 6f72 6b65 722e 6d65  ibuted.worker.me
+0000f240: 6d6f 7279 2e72 6563 656e 742d 746f 2d6f  mory.recent-to-o
+0000f250: 6c64 2d74 696d 6522 290a 2020 2020 2020  ld-time").      
+0000f260: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
+0000f270: 2e4d 454d 4f52 595f 5245 4241 4c41 4e43  .MEMORY_REBALANC
+0000f280: 455f 4d45 4153 5552 4520 3d20 6461 736b  E_MEASURE = dask
+0000f290: 2e63 6f6e 6669 672e 6765 7428 0a20 2020  .config.get(.   
+0000f2a0: 2020 2020 2020 2020 2022 6469 7374 7269           "distri
+0000f2b0: 6275 7465 642e 776f 726b 6572 2e6d 656d  buted.worker.mem
+0000f2c0: 6f72 792e 7265 6261 6c61 6e63 652e 6d65  ory.rebalance.me
+0000f2d0: 6173 7572 6522 0a20 2020 2020 2020 2029  asure".        )
+0000f2e0: 0a20 2020 2020 2020 2073 656c 662e 4d45  .        self.ME
+0000f2f0: 4d4f 5259 5f52 4542 414c 414e 4345 5f53  MORY_REBALANCE_S
+0000f300: 454e 4445 525f 4d49 4e20 3d20 6461 736b  ENDER_MIN = dask
+0000f310: 2e63 6f6e 6669 672e 6765 7428 0a20 2020  .config.get(.   
+0000f320: 2020 2020 2020 2020 2022 6469 7374 7269           "distri
+0000f330: 6275 7465 642e 776f 726b 6572 2e6d 656d  buted.worker.mem
+0000f340: 6f72 792e 7265 6261 6c61 6e63 652e 7365  ory.rebalance.se
+0000f350: 6e64 6572 2d6d 696e 220a 2020 2020 2020  nder-min".      
+0000f360: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
+0000f370: 2e4d 454d 4f52 595f 5245 4241 4c41 4e43  .MEMORY_REBALANC
+0000f380: 455f 5245 4349 5049 454e 545f 4d41 5820  E_RECIPIENT_MAX 
+0000f390: 3d20 6461 736b 2e63 6f6e 6669 672e 6765  = dask.config.ge
+0000f3a0: 7428 0a20 2020 2020 2020 2020 2020 2022  t(.            "
+0000f3b0: 6469 7374 7269 6275 7465 642e 776f 726b  distributed.work
+0000f3c0: 6572 2e6d 656d 6f72 792e 7265 6261 6c61  er.memory.rebala
+0000f3d0: 6e63 652e 7265 6369 7069 656e 742d 6d61  nce.recipient-ma
+0000f3e0: 7822 0a20 2020 2020 2020 2029 0a20 2020  x".        ).   
+0000f3f0: 2020 2020 2073 656c 662e 4d45 4d4f 5259       self.MEMORY
+0000f400: 5f52 4542 414c 414e 4345 5f48 414c 465f  _REBALANCE_HALF_
+0000f410: 4741 5020 3d20 280a 2020 2020 2020 2020  GAP = (.        
+0000f420: 2020 2020 6461 736b 2e63 6f6e 6669 672e      dask.config.
+0000f430: 6765 7428 2264 6973 7472 6962 7574 6564  get("distributed
+0000f440: 2e77 6f72 6b65 722e 6d65 6d6f 7279 2e72  .worker.memory.r
+0000f450: 6562 616c 616e 6365 2e73 656e 6465 722d  ebalance.sender-
+0000f460: 7265 6369 7069 656e 742d 6761 7022 290a  recipient-gap").
+0000f470: 2020 2020 2020 2020 2020 2020 2f20 322e              / 2.
+0000f480: 300a 2020 2020 2020 2020 290a 0a20 2020  0.        )..   
+0000f490: 2020 2020 2073 656c 662e 574f 524b 4552       self.WORKER
+0000f4a0: 5f53 4154 5552 4154 494f 4e20 3d20 6461  _SATURATION = da
+0000f4b0: 736b 2e63 6f6e 6669 672e 6765 7428 0a20  sk.config.get(. 
+0000f4c0: 2020 2020 2020 2020 2020 2022 6469 7374             "dist
+0000f4d0: 7269 6275 7465 642e 7363 6865 6475 6c65  ributed.schedule
+0000f4e0: 722e 776f 726b 6572 2d73 6174 7572 6174  r.worker-saturat
+0000f4f0: 696f 6e22 0a20 2020 2020 2020 2029 0a20  ion".        ). 
+0000f500: 2020 2020 2020 2069 6620 7365 6c66 2e57         if self.W
+0000f510: 4f52 4b45 525f 5341 5455 5241 5449 4f4e  ORKER_SATURATION
+0000f520: 203d 3d20 2269 6e66 223a 0a20 2020 2020   == "inf":.     
+0000f530: 2020 2020 2020 2023 2053 7065 6369 616c         # Special
+0000f540: 2063 6173 6520 6e65 6365 7373 6172 7920   case necessary 
+0000f550: 6265 6361 7573 6520 7468 6572 6527 7320  because there's 
+0000f560: 6e6f 2077 6179 2074 6f20 7061 7273 6520  no way to parse 
+0000f570: 6120 666c 6f61 7420 696e 6669 6e69 7479  a float infinity
+0000f580: 0a20 2020 2020 2020 2020 2020 2023 2066  .            # f
+0000f590: 726f 6d20 6120 4441 534b 5f2a 2065 6e76  rom a DASK_* env
+0000f5a0: 6972 6f6e 6d65 6e74 2076 6172 6961 626c  ironment variabl
+0000f5b0: 650a 2020 2020 2020 2020 2020 2020 7365  e.            se
+0000f5c0: 6c66 2e57 4f52 4b45 525f 5341 5455 5241  lf.WORKER_SATURA
+0000f5d0: 5449 4f4e 203d 206d 6174 682e 696e 660a  TION = math.inf.
+0000f5e0: 2020 2020 2020 2020 6966 2028 0a20 2020          if (.   
+0000f5f0: 2020 2020 2020 2020 206e 6f74 2069 7369           not isi
+0000f600: 6e73 7461 6e63 6528 7365 6c66 2e57 4f52  nstance(self.WOR
+0000f610: 4b45 525f 5341 5455 5241 5449 4f4e 2c20  KER_SATURATION, 
+0000f620: 2869 6e74 2c20 666c 6f61 7429 290a 2020  (int, float)).  
+0000f630: 2020 2020 2020 2020 2020 6f72 2073 656c            or sel
+0000f640: 662e 574f 524b 4552 5f53 4154 5552 4154  f.WORKER_SATURAT
+0000f650: 494f 4e20 3c3d 2030 0a20 2020 2020 2020  ION <= 0.       
+0000f660: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
+0000f670: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+0000f680: 2820 2023 2070 7261 676d 613a 206e 6f63  (  # pragma: noc
+0000f690: 6f76 6572 0a20 2020 2020 2020 2020 2020  over.           
+0000f6a0: 2020 2020 2022 6064 6973 7472 6962 7574       "`distribut
+0000f6b0: 6564 2e73 6368 6564 756c 6572 2e77 6f72  ed.scheduler.wor
+0000f6c0: 6b65 722d 7361 7475 7261 7469 6f6e 6020  ker-saturation` 
+0000f6d0: 6d75 7374 2062 6520 6120 666c 6f61 7420  must be a float 
+0000f6e0: 3e20 303b 2067 6f74 2022 0a20 2020 2020  > 0; got ".     
+0000f6f0: 2020 2020 2020 2020 2020 202b 2072 6570             + rep
+0000f700: 7228 7365 6c66 2e57 4f52 4b45 525f 5341  r(self.WORKER_SA
+0000f710: 5455 5241 5449 4f4e 290a 2020 2020 2020  TURATION).      
+0000f720: 2020 2020 2020 290a 0a20 2020 2040 7072        )..    @pr
+0000f730: 6f70 6572 7479 0a20 2020 2064 6566 206d  operty.    def m
+0000f740: 656d 6f72 7928 7365 6c66 2920 2d3e 204d  emory(self) -> M
+0000f750: 656d 6f72 7953 7461 7465 3a0a 2020 2020  emoryState:.    
+0000f760: 2020 2020 7265 7475 726e 204d 656d 6f72      return Memor
+0000f770: 7953 7461 7465 2e73 756d 282a 2877 2e6d  yState.sum(*(w.m
+0000f780: 656d 6f72 7920 666f 7220 7720 696e 2073  emory for w in s
+0000f790: 656c 662e 776f 726b 6572 732e 7661 6c75  elf.workers.valu
+0000f7a0: 6573 2829 2929 0a0a 2020 2020 4070 726f  es()))..    @pro
+0000f7b0: 7065 7274 790a 2020 2020 6465 6620 5f5f  perty.    def __
+0000f7c0: 7064 6963 745f 5f28 7365 6c66 2920 2d3e  pdict__(self) ->
+0000f7d0: 2064 6963 745b 7374 722c 2041 6e79 5d3a   dict[str, Any]:
+0000f7e0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000f7f0: 7b0a 2020 2020 2020 2020 2020 2020 2262  {.            "b
+0000f800: 616e 6477 6964 7468 223a 2073 656c 662e  andwidth": self.
+0000f810: 6261 6e64 7769 6474 682c 0a20 2020 2020  bandwidth,.     
+0000f820: 2020 2020 2020 2022 7265 736f 7572 6365         "resource
+0000f830: 7322 3a20 7365 6c66 2e72 6573 6f75 7263  s": self.resourc
+0000f840: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
+0000f850: 2273 6174 7572 6174 6564 223a 2073 656c  "saturated": sel
+0000f860: 662e 7361 7475 7261 7465 642c 0a20 2020  f.saturated,.   
+0000f870: 2020 2020 2020 2020 2022 756e 7275 6e6e           "unrunn
+0000f880: 6162 6c65 223a 2073 656c 662e 756e 7275  able": self.unru
+0000f890: 6e6e 6162 6c65 2c0a 2020 2020 2020 2020  nnable,.        
+0000f8a0: 2020 2020 2271 7565 7565 6422 3a20 7365      "queued": se
+0000f8b0: 6c66 2e71 7565 7565 642c 0a20 2020 2020  lf.queued,.     
+0000f8c0: 2020 2020 2020 2022 6e5f 7461 736b 7322         "n_tasks"
+0000f8d0: 3a20 7365 6c66 2e6e 5f74 6173 6b73 2c0a  : self.n_tasks,.
+0000f8e0: 2020 2020 2020 2020 2020 2020 2275 6e6b              "unk
+0000f8f0: 6e6f 776e 5f64 7572 6174 696f 6e73 223a  nown_durations":
+0000f900: 2073 656c 662e 756e 6b6e 6f77 6e5f 6475   self.unknown_du
+0000f910: 7261 7469 6f6e 732c 0a20 2020 2020 2020  rations,.       
+0000f920: 2020 2020 2022 7661 6c69 6461 7465 223a       "validate":
+0000f930: 2073 656c 662e 7661 6c69 6461 7465 2c0a   self.validate,.
+0000f940: 2020 2020 2020 2020 2020 2020 2274 6173              "tas
+0000f950: 6b73 223a 2073 656c 662e 7461 736b 732c  ks": self.tasks,
+0000f960: 0a20 2020 2020 2020 2020 2020 2022 7461  .            "ta
+0000f970: 736b 5f67 726f 7570 7322 3a20 7365 6c66  sk_groups": self
+0000f980: 2e74 6173 6b5f 6772 6f75 7073 2c0a 2020  .task_groups,.  
+0000f990: 2020 2020 2020 2020 2020 2274 6173 6b5f            "task_
+0000f9a0: 7072 6566 6978 6573 223a 2073 656c 662e  prefixes": self.
+0000f9b0: 7461 736b 5f70 7265 6669 7865 732c 0a20  task_prefixes,. 
+0000f9c0: 2020 2020 2020 2020 2020 2022 746f 7461             "tota
+0000f9d0: 6c5f 6e74 6872 6561 6473 223a 2073 656c  l_nthreads": sel
+0000f9e0: 662e 746f 7461 6c5f 6e74 6872 6561 6473  f.total_nthreads
+0000f9f0: 2c0a 2020 2020 2020 2020 2020 2020 2274  ,.            "t
+0000fa00: 6f74 616c 5f6f 6363 7570 616e 6379 223a  otal_occupancy":
+0000fa10: 2073 656c 662e 746f 7461 6c5f 6f63 6375   self.total_occu
+0000fa20: 7061 6e63 792c 0a20 2020 2020 2020 2020  pancy,.         
+0000fa30: 2020 2022 6572 7265 645f 7461 736b 7322     "erred_tasks"
+0000fa40: 3a20 7365 6c66 2e65 7272 6564 5f74 6173  : self.erred_tas
+0000fa50: 6b73 2c0a 2020 2020 2020 2020 2020 2020  ks,.            
+0000fa60: 2265 7874 656e 7369 6f6e 7322 3a20 7365  "extensions": se
+0000fa70: 6c66 2e65 7874 656e 7369 6f6e 732c 0a20  lf.extensions,. 
+0000fa80: 2020 2020 2020 2020 2020 2022 636c 6965             "clie
+0000fa90: 6e74 7322 3a20 7365 6c66 2e63 6c69 656e  nts": self.clien
+0000faa0: 7473 2c0a 2020 2020 2020 2020 2020 2020  ts,.            
+0000fab0: 2277 6f72 6b65 7273 223a 2073 656c 662e  "workers": self.
+0000fac0: 776f 726b 6572 732c 0a20 2020 2020 2020  workers,.       
+0000fad0: 2020 2020 2022 6964 6c65 223a 2073 656c       "idle": sel
+0000fae0: 662e 6964 6c65 2c0a 2020 2020 2020 2020  f.idle,.        
+0000faf0: 2020 2020 2268 6f73 745f 696e 666f 223a      "host_info":
+0000fb00: 2073 656c 662e 686f 7374 5f69 6e66 6f2c   self.host_info,
+0000fb10: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
+0000fb20: 6465 6620 6e65 775f 7461 736b 280a 2020  def new_task(.  
+0000fb30: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+0000fb40: 2020 2020 6b65 793a 204b 6579 2c0a 2020      key: Key,.  
+0000fb50: 2020 2020 2020 7370 6563 3a20 545f 7275        spec: T_ru
+0000fb60: 6e73 7065 6320 7c20 4e6f 6e65 2c0a 2020  nspec | None,.  
+0000fb70: 2020 2020 2020 7374 6174 653a 2054 6173        state: Tas
+0000fb80: 6b53 7461 7465 5374 6174 652c 0a20 2020  kStateState,.   
+0000fb90: 2020 2020 2063 6f6d 7075 7461 7469 6f6e       computation
+0000fba0: 3a20 436f 6d70 7574 6174 696f 6e20 7c20  : Computation | 
+0000fbb0: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
+0000fbc0: 2029 202d 3e20 5461 736b 5374 6174 653a   ) -> TaskState:
+0000fbd0: 0a20 2020 2020 2020 2022 2222 4372 6561  .        """Crea
+0000fbe0: 7465 2061 206e 6577 2074 6173 6b2c 2061  te a new task, a
+0000fbf0: 6e64 2061 7373 6f63 6961 7465 6420 7374  nd associated st
+0000fc00: 6174 6573 2222 220a 2020 2020 2020 2020  ates""".        
+0000fc10: 7473 203d 2054 6173 6b53 7461 7465 286b  ts = TaskState(k
+0000fc20: 6579 2c20 7370 6563 2c20 7374 6174 6529  ey, spec, state)
+0000fc30: 0a0a 2020 2020 2020 2020 7072 6566 6978  ..        prefix
+0000fc40: 5f6b 6579 203d 206b 6579 5f73 706c 6974  _key = key_split
+0000fc50: 286b 6579 290a 2020 2020 2020 2020 7470  (key).        tp
+0000fc60: 203d 2073 656c 662e 7461 736b 5f70 7265   = self.task_pre
+0000fc70: 6669 7865 732e 6765 7428 7072 6566 6978  fixes.get(prefix
+0000fc80: 5f6b 6579 290a 2020 2020 2020 2020 6966  _key).        if
+0000fc90: 2074 7020 6973 204e 6f6e 653a 0a20 2020   tp is None:.   
+0000fca0: 2020 2020 2020 2020 2073 656c 662e 7461           self.ta
+0000fcb0: 736b 5f70 7265 6669 7865 735b 7072 6566  sk_prefixes[pref
+0000fcc0: 6978 5f6b 6579 5d20 3d20 7470 203d 2054  ix_key] = tp = T
+0000fcd0: 6173 6b50 7265 6669 7828 7072 6566 6978  askPrefix(prefix
+0000fce0: 5f6b 6579 290a 2020 2020 2020 2020 7473  _key).        ts
+0000fcf0: 2e70 7265 6669 7820 3d20 7470 0a0a 2020  .prefix = tp..  
+0000fd00: 2020 2020 2020 6772 6f75 705f 6b65 7920        group_key 
+0000fd10: 3d20 7473 2e67 726f 7570 5f6b 6579 0a20  = ts.group_key. 
+0000fd20: 2020 2020 2020 2074 6720 3d20 7365 6c66         tg = self
+0000fd30: 2e74 6173 6b5f 6772 6f75 7073 2e67 6574  .task_groups.get
+0000fd40: 2867 726f 7570 5f6b 6579 290a 2020 2020  (group_key).    
+0000fd50: 2020 2020 6966 2074 6720 6973 204e 6f6e      if tg is Non
+0000fd60: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
+0000fd70: 656c 662e 7461 736b 5f67 726f 7570 735b  elf.task_groups[
+0000fd80: 6772 6f75 705f 6b65 795d 203d 2074 6720  group_key] = tg 
+0000fd90: 3d20 5461 736b 4772 6f75 7028 6772 6f75  = TaskGroup(grou
+0000fda0: 705f 6b65 7929 0a20 2020 2020 2020 2020  p_key).         
+0000fdb0: 2020 2069 6620 636f 6d70 7574 6174 696f     if computatio
+0000fdc0: 6e3a 0a20 2020 2020 2020 2020 2020 2020  n:.             
+0000fdd0: 2020 2063 6f6d 7075 7461 7469 6f6e 2e67     computation.g
+0000fde0: 726f 7570 732e 6164 6428 7467 290a 2020  roups.add(tg).  
+0000fdf0: 2020 2020 2020 2020 2020 7467 2e70 7265            tg.pre
+0000fe00: 6669 7820 3d20 7470 0a20 2020 2020 2020  fix = tp.       
+0000fe10: 2020 2020 2074 702e 6772 6f75 7073 2e61       tp.groups.a
+0000fe20: 7070 656e 6428 7467 290a 2020 2020 2020  ppend(tg).      
+0000fe30: 2020 7467 2e61 6464 2874 7329 0a0a 2020    tg.add(ts)..  
+0000fe40: 2020 2020 2020 7365 6c66 2e74 6173 6b73        self.tasks
+0000fe50: 5b6b 6579 5d20 3d20 7473 0a0a 2020 2020  [key] = ts..    
+0000fe60: 2020 2020 7265 7475 726e 2074 730a 0a20      return ts.. 
+0000fe70: 2020 2064 6566 205f 636c 6561 725f 7461     def _clear_ta
+0000fe80: 736b 5f73 7461 7465 2873 656c 6629 202d  sk_state(self) -
+0000fe90: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+0000fea0: 6c6f 6767 6572 2e64 6562 7567 2822 436c  logger.debug("Cl
+0000feb0: 6561 7220 7461 736b 2073 7461 7465 2229  ear task state")
+0000fec0: 0a20 2020 2020 2020 2066 6f72 2063 6f6c  .        for col
+0000fed0: 6c65 6374 696f 6e20 696e 2028 0a20 2020  lection in (.   
+0000fee0: 2020 2020 2020 2020 2073 656c 662e 756e           self.un
+0000fef0: 7275 6e6e 6162 6c65 2c0a 2020 2020 2020  runnable,.      
+0000ff00: 2020 2020 2020 7365 6c66 2e65 7272 6564        self.erred
+0000ff10: 5f74 6173 6b73 2c0a 2020 2020 2020 2020  _tasks,.        
+0000ff20: 2020 2020 7365 6c66 2e63 6f6d 7075 7461      self.computa
+0000ff30: 7469 6f6e 732c 0a20 2020 2020 2020 2020  tions,.         
+0000ff40: 2020 2073 656c 662e 7461 736b 5f70 7265     self.task_pre
+0000ff50: 6669 7865 732c 0a20 2020 2020 2020 2020  fixes,.         
+0000ff60: 2020 2073 656c 662e 7461 736b 5f67 726f     self.task_gro
+0000ff70: 7570 732c 0a20 2020 2020 2020 2020 2020  ups,.           
+0000ff80: 2073 656c 662e 7461 736b 5f6d 6574 6164   self.task_metad
+0000ff90: 6174 612c 0a20 2020 2020 2020 2020 2020  ata,.           
+0000ffa0: 2073 656c 662e 756e 6b6e 6f77 6e5f 6475   self.unknown_du
+0000ffb0: 7261 7469 6f6e 732c 0a20 2020 2020 2020  rations,.       
+0000ffc0: 2020 2020 2073 656c 662e 7265 706c 6963       self.replic
+0000ffd0: 6174 6564 5f74 6173 6b73 2c0a 2020 2020  ated_tasks,.    
+0000ffe0: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
+0000fff0: 2020 2063 6f6c 6c65 6374 696f 6e2e 636c     collection.cl
+00010000: 6561 7228 2920 2023 2074 7970 653a 2069  ear()  # type: i
+00010010: 676e 6f72 650a 0a20 2020 2040 7072 6f70  gnore..    @prop
+00010020: 6572 7479 0a20 2020 2064 6566 2069 735f  erty.    def is_
+00010030: 6964 6c65 2873 656c 6629 202d 3e20 626f  idle(self) -> bo
+00010040: 6f6c 3a0a 2020 2020 2020 2020 2222 2252  ol:.        """R
+00010050: 6574 7572 6e20 5472 7565 2069 6666 2074  eturn True iff t
+00010060: 6865 7265 2061 7265 206e 6f20 7461 736b  here are no task
+00010070: 7320 7468 6174 2068 6176 656e 2774 2066  s that haven't f
+00010080: 696e 6973 6865 6420 636f 6d70 7574 696e  inished computin
+00010090: 672e 0a0a 2020 2020 2020 2020 556e 6c69  g...        Unli
+000100a0: 6b65 2074 6573 7469 6e67 2060 6073 656c  ke testing ``sel
+000100b0: 662e 746f 7461 6c5f 6f63 6375 7061 6e63  f.total_occupanc
+000100c0: 7960 602c 2074 6869 7320 7072 6f70 6572  y``, this proper
+000100d0: 7479 2072 6574 7572 6e73 2046 616c 7365  ty returns False
+000100e0: 2069 6620 7468 6572 650a 2020 2020 2020   if there.      
+000100f0: 2020 6172 6520 6c6f 6e67 2d72 756e 6e69    are long-runni
+00010100: 6e67 2074 6173 6b73 2c20 6e6f 2d77 6f72  ng tasks, no-wor
+00010110: 6b65 722c 206f 7220 7175 6575 6564 2074  ker, or queued t
+00010120: 6173 6b73 2028 6475 6520 746f 206e 6f74  asks (due to not
+00010130: 2068 6176 696e 6720 616e 790a 2020 2020   having any.    
+00010140: 2020 2020 776f 726b 6572 7329 2e0a 0a20      workers)... 
+00010150: 2020 2020 2020 204e 6f74 2074 6f20 6265         Not to be
+00010160: 2063 6f6e 6675 7365 6420 7769 7468 2060   confused with `
+00010170: 6069 646c 6560 602e 0a20 2020 2020 2020  `idle``..       
+00010180: 2022 2222 0a20 2020 2020 2020 2072 6574   """.        ret
+00010190: 7572 6e20 616c 6c28 7467 2e64 6f6e 6520  urn all(tg.done 
+000101a0: 666f 7220 7467 2069 6e20 7365 6c66 2e74  for tg in self.t
+000101b0: 6173 6b5f 6772 6f75 7073 2e76 616c 7565  ask_groups.value
+000101c0: 7328 2929 0a0a 2020 2020 4070 726f 7065  s())..    @prope
+000101d0: 7274 790a 2020 2020 6465 6620 746f 7461  rty.    def tota
+000101e0: 6c5f 6f63 6375 7061 6e63 7928 7365 6c66  l_occupancy(self
+000101f0: 2920 2d3e 2066 6c6f 6174 3a0a 2020 2020  ) -> float:.    
+00010200: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+00010210: 5f63 616c 635f 6f63 6375 7061 6e63 7928  _calc_occupancy(
+00010220: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00010230: 662e 5f74 6173 6b5f 7072 6566 6978 5f63  f._task_prefix_c
+00010240: 6f75 6e74 5f67 6c6f 6261 6c2c 0a20 2020  ount_global,.   
+00010250: 2020 2020 2020 2020 2073 656c 662e 5f6e           self._n
+00010260: 6574 776f 726b 5f6f 6363 5f67 6c6f 6261  etwork_occ_globa
+00010270: 6c2c 0a20 2020 2020 2020 2029 0a0a 2020  l,.        )..  
+00010280: 2020 6465 6620 5f63 616c 635f 6f63 6375    def _calc_occu
+00010290: 7061 6e63 7928 0a20 2020 2020 2020 2073  pancy(.        s
+000102a0: 656c 662c 0a20 2020 2020 2020 2074 6173  elf,.        tas
+000102b0: 6b5f 7072 6566 6978 5f63 6f75 6e74 3a20  k_prefix_count: 
+000102c0: 6469 6374 5b73 7472 2c20 696e 745d 2c0a  dict[str, int],.
+000102d0: 2020 2020 2020 2020 6e65 7477 6f72 6b5f          network_
+000102e0: 6f63 633a 2066 6c6f 6174 2c0a 2020 2020  occ: float,.    
+000102f0: 2920 2d3e 2066 6c6f 6174 3a0a 2020 2020  ) -> float:.    
+00010300: 2020 2020 7265 7320 3d20 302e 300a 2020      res = 0.0.  
+00010310: 2020 2020 2020 666f 7220 7072 6566 6978        for prefix
+00010320: 5f6e 616d 652c 2063 6f75 6e74 2069 6e20  _name, count in 
+00010330: 7461 736b 5f70 7265 6669 785f 636f 756e  task_prefix_coun
+00010340: 742e 6974 656d 7328 293a 0a20 2020 2020  t.items():.     
+00010350: 2020 2020 2020 2023 2054 4f44 4f3a 2044         # TODO: D
+00010360: 6561 6c20 7769 7468 2075 6e6b 6e6f 776e  eal with unknown
+00010370: 2074 6173 6b73 2062 6574 7465 720a 2020   tasks better.  
+00010380: 2020 2020 2020 2020 2020 7072 6566 6978            prefix
+00010390: 203d 2073 656c 662e 7461 736b 5f70 7265   = self.task_pre
+000103a0: 6669 7865 735b 7072 6566 6978 5f6e 616d  fixes[prefix_nam
+000103b0: 655d 0a20 2020 2020 2020 2020 2020 2061  e].            a
+000103c0: 7373 6572 7420 7072 6566 6978 2069 7320  ssert prefix is 
+000103d0: 6e6f 7420 4e6f 6e65 0a20 2020 2020 2020  not None.       
+000103e0: 2020 2020 2064 7572 6174 696f 6e20 3d20       duration = 
+000103f0: 7072 6566 6978 2e64 7572 6174 696f 6e5f  prefix.duration_
+00010400: 6176 6572 6167 650a 2020 2020 2020 2020  average.        
+00010410: 2020 2020 6966 2064 7572 6174 696f 6e20      if duration 
+00010420: 3c20 303a 0a20 2020 2020 2020 2020 2020  < 0:.           
+00010430: 2020 2020 2069 6620 7072 6566 6978 2e6d       if prefix.m
+00010440: 6178 5f65 7865 635f 7469 6d65 203e 2030  ax_exec_time > 0
+00010450: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00010460: 2020 2020 2020 6475 7261 7469 6f6e 203d        duration =
+00010470: 2032 202a 2070 7265 6669 782e 6d61 785f   2 * prefix.max_
+00010480: 6578 6563 5f74 696d 650a 2020 2020 2020  exec_time.      
+00010490: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+000104a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000104b0: 2020 2020 6475 7261 7469 6f6e 203d 2073      duration = s
+000104c0: 656c 662e 554e 4b4e 4f57 4e5f 5441 534b  elf.UNKNOWN_TASK
+000104d0: 5f44 5552 4154 494f 4e0a 2020 2020 2020  _DURATION.      
+000104e0: 2020 2020 2020 7265 7320 2b3d 2064 7572        res += dur
+000104f0: 6174 696f 6e20 2a20 636f 756e 740a 2020  ation * count.  
+00010500: 2020 2020 2020 6f63 6320 3d20 7265 7320        occ = res 
+00010510: 2b20 6e65 7477 6f72 6b5f 6f63 6320 2f20  + network_occ / 
+00010520: 7365 6c66 2e62 616e 6477 6964 7468 0a20  self.bandwidth. 
+00010530: 2020 2020 2020 2061 7373 6572 7420 6f63         assert oc
+00010540: 6320 3e3d 2030 2c20 286f 6363 2c20 7265  c >= 0, (occ, re
+00010550: 732c 206e 6574 776f 726b 5f6f 6363 2c20  s, network_occ, 
+00010560: 7365 6c66 2e62 616e 6477 6964 7468 290a  self.bandwidth).
+00010570: 2020 2020 2020 2020 7265 7475 726e 206f          return o
+00010580: 6363 0a0a 2020 2020 2323 2323 2323 2323  cc..    ########
+00010590: 2323 2323 2323 2323 2323 2323 230a 2020  #############.  
+000105a0: 2020 2320 5374 6174 6520 5472 616e 7369    # State Transi
+000105b0: 7469 6f6e 7320 230a 2020 2020 2323 2323  tions #.    ####
+000105c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000105d0: 230a 0a20 2020 2064 6566 205f 7472 616e  #..    def _tran
+000105e0: 7369 7469 6f6e 280a 2020 2020 2020 2020  sition(.        
+000105f0: 7365 6c66 2c20 6b65 793a 204b 6579 2c20  self, key: Key, 
+00010600: 6669 6e69 7368 3a20 5461 736b 5374 6174  finish: TaskStat
+00010610: 6553 7461 7465 2c20 7374 696d 756c 7573  eState, stimulus
+00010620: 5f69 643a 2073 7472 2c20 2a2a 6b77 6172  _id: str, **kwar
+00010630: 6773 3a20 416e 790a 2020 2020 2920 2d3e  gs: Any.    ) ->
+00010640: 2052 6563 734d 7367 733a 0a20 2020 2020   RecsMsgs:.     
+00010650: 2020 2022 2222 5472 616e 7369 7469 6f6e     """Transition
+00010660: 2061 206b 6579 2066 726f 6d20 6974 7320   a key from its 
+00010670: 6375 7272 656e 7420 7374 6174 6520 746f  current state to
+00010680: 2074 6865 2066 696e 6973 6820 7374 6174   the finish stat
+00010690: 650a 0a20 2020 2020 2020 2045 7861 6d70  e..        Examp
+000106a0: 6c65 730a 2020 2020 2020 2020 2d2d 2d2d  les.        ----
+000106b0: 2d2d 2d2d 0a20 2020 2020 2020 203e 3e3e  ----.        >>>
+000106c0: 2073 656c 662e 5f74 7261 6e73 6974 696f   self._transitio
+000106d0: 6e28 2778 272c 2027 7761 6974 696e 6727  n('x', 'waiting'
+000106e0: 290a 2020 2020 2020 2020 7b27 7827 3a20  ).        {'x': 
+000106f0: 2770 726f 6365 7373 696e 6727 7d2c 207b  'processing'}, {
+00010700: 7d2c 207b 7d0a 0a20 2020 2020 2020 2052  }, {}..        R
+00010710: 6574 7572 6e73 0a20 2020 2020 2020 202d  eturns.        -
+00010720: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2054  ------.        T
+00010730: 7570 6c65 206f 663a 0a0a 2020 2020 2020  uple of:..      
+00010740: 2020 2d20 4469 6374 696f 6e61 7279 206f    - Dictionary o
+00010750: 6620 7265 636f 6d6d 656e 6461 7469 6f6e  f recommendation
+00010760: 7320 666f 7220 6675 7475 7265 2074 7261  s for future tra
+00010770: 6e73 6974 696f 6e73 207b 6b65 793a 206e  nsitions {key: n
+00010780: 6577 2073 7461 7465 7d0a 2020 2020 2020  ew state}.      
+00010790: 2020 2d20 4d65 7373 6167 6573 2074 6f20    - Messages to 
+000107a0: 636c 6965 6e74 7320 7b63 6c69 656e 7420  clients {client 
+000107b0: 6164 6472 6573 733a 205b 6d73 672c 206d  address: [msg, m
+000107c0: 7367 2c20 2e2e 2e5d 7d0a 2020 2020 2020  sg, ...]}.      
+000107d0: 2020 2d20 4d65 7373 6167 6573 2074 6f20    - Messages to 
+000107e0: 776f 726b 6572 7320 7b77 6f72 6b65 7220  workers {worker 
+000107f0: 6164 6472 6573 733a 205b 6d73 672c 206d  address: [msg, m
+00010800: 7367 2c20 2e2e 2e5d 7d0a 0a20 2020 2020  sg, ...]}..     
+00010810: 2020 2053 6565 2041 6c73 6f0a 2020 2020     See Also.    
+00010820: 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020      --------.   
+00010830: 2020 2020 2053 6368 6564 756c 6572 2e74       Scheduler.t
+00010840: 7261 6e73 6974 696f 6e73 203a 2074 7261  ransitions : tra
+00010850: 6e73 6974 6976 6520 7665 7273 696f 6e20  nsitive version 
+00010860: 6f66 2074 6869 7320 6675 6e63 7469 6f6e  of this function
+00010870: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00010880: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00010890: 2020 2020 2020 7473 203d 2073 656c 662e        ts = self.
+000108a0: 7461 736b 732e 6765 7428 6b65 7929 0a20  tasks.get(key). 
+000108b0: 2020 2020 2020 2020 2020 2069 6620 7473             if ts
+000108c0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+000108d0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000108e0: 207b 7d2c 207b 7d2c 207b 7d0a 2020 2020   {}, {}, {}.    
+000108f0: 2020 2020 2020 2020 7374 6172 7420 3d20          start = 
+00010900: 7473 2e5f 7374 6174 650a 2020 2020 2020  ts._state.      
+00010910: 2020 2020 2020 6966 2073 7461 7274 203d        if start =
+00010920: 3d20 6669 6e69 7368 3a0a 2020 2020 2020  = finish:.      
+00010930: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00010940: 207b 7d2c 207b 7d2c 207b 7d0a 0a20 2020   {}, {}, {}..   
+00010950: 2020 2020 2020 2020 2023 204e 6f74 6573           # Notes
+00010960: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+00010970: 2d20 696e 2063 6173 6520 6f66 2074 7261  - in case of tra
+00010980: 6e73 6974 696f 6e20 7468 726f 7567 6820  nsition through 
+00010990: 7265 6c65 6173 6564 2c20 7468 6973 2063  released, this c
+000109a0: 6f75 6e74 6572 2069 7320 696e 6372 656d  ounter is increm
+000109b0: 656e 7465 6420 6279 2032 0a20 2020 2020  ented by 2.     
+000109c0: 2020 2020 2020 2023 202d 2074 6869 7320         # - this 
+000109d0: 696e 6372 6561 7365 2068 6170 7065 6e73  increase happens
+000109e0: 2062 6566 6f72 6520 7468 6520 6163 7475   before the actu
+000109f0: 616c 2074 7261 6e73 6974 696f 6e73 2c20  al transitions, 
+00010a00: 736f 2074 6861 7420 6974 2063 616e 0a20  so that it can. 
+00010a10: 2020 2020 2020 2020 2020 2023 2020 2063             #   c
+00010a20: 6174 6368 2070 6f74 656e 7469 616c 2069  atch potential i
+00010a30: 6e66 696e 6974 6520 7265 6375 7273 696f  nfinite recursio
+00010a40: 6e73 0a20 2020 2020 2020 2020 2020 2073  ns.            s
+00010a50: 656c 662e 7472 616e 7369 7469 6f6e 5f63  elf.transition_c
+00010a60: 6f75 6e74 6572 202b 3d20 310a 2020 2020  ounter += 1.    
+00010a70: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00010a80: 7472 616e 7369 7469 6f6e 5f63 6f75 6e74  transition_count
+00010a90: 6572 5f6d 6178 3a0a 2020 2020 2020 2020  er_max:.        
+00010aa0: 2020 2020 2020 2020 6173 7365 7274 2073          assert s
+00010ab0: 656c 662e 7472 616e 7369 7469 6f6e 5f63  elf.transition_c
+00010ac0: 6f75 6e74 6572 203c 2073 656c 662e 7472  ounter < self.tr
+00010ad0: 616e 7369 7469 6f6e 5f63 6f75 6e74 6572  ansition_counter
+00010ae0: 5f6d 6178 0a0a 2020 2020 2020 2020 2020  _max..          
+00010af0: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
+00010b00: 733a 2052 6563 7320 3d20 7b7d 0a20 2020  s: Recs = {}.   
+00010b10: 2020 2020 2020 2020 2077 6f72 6b65 725f           worker_
+00010b20: 6d73 6773 3a20 4d73 6773 203d 207b 7d0a  msgs: Msgs = {}.
+00010b30: 2020 2020 2020 2020 2020 2020 636c 6965              clie
+00010b40: 6e74 5f6d 7367 733a 204d 7367 7320 3d20  nt_msgs: Msgs = 
+00010b50: 7b7d 0a0a 2020 2020 2020 2020 2020 2020  {}..            
+00010b60: 6966 2073 656c 662e 706c 7567 696e 733a  if self.plugins:
+00010b70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010b80: 2064 6570 656e 6465 6e74 7320 3d20 7365   dependents = se
+00010b90: 7428 7473 2e64 6570 656e 6465 6e74 7329  t(ts.dependents)
+00010ba0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010bb0: 2064 6570 656e 6465 6e63 6965 7320 3d20   dependencies = 
+00010bc0: 7365 7428 7473 2e64 6570 656e 6465 6e63  set(ts.dependenc
+00010bd0: 6965 7329 0a0a 2020 2020 2020 2020 2020  ies)..          
+00010be0: 2020 6675 6e63 203d 2073 656c 662e 5f54    func = self._T
+00010bf0: 5241 4e53 4954 494f 4e53 5f54 4142 4c45  RANSITIONS_TABLE
+00010c00: 2e67 6574 2828 7374 6172 742c 2066 696e  .get((start, fin
+00010c10: 6973 6829 290a 2020 2020 2020 2020 2020  ish)).          
+00010c20: 2020 6966 2066 756e 6320 6973 206e 6f74    if func is not
+00010c30: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00010c40: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
+00010c50: 6174 696f 6e73 2c20 636c 6965 6e74 5f6d  ations, client_m
+00010c60: 7367 732c 2077 6f72 6b65 725f 6d73 6773  sgs, worker_msgs
+00010c70: 203d 2066 756e 6328 0a20 2020 2020 2020   = func(.       
+00010c80: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00010c90: 662c 206b 6579 2c20 7374 696d 756c 7573  f, key, stimulus
+00010ca0: 5f69 642c 202a 2a6b 7761 7267 730a 2020  _id, **kwargs.  
+00010cb0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00010cc0: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+00010cd0: 6620 2272 656c 6561 7365 6422 206e 6f74  f "released" not
+00010ce0: 2069 6e20 2873 7461 7274 2c20 6669 6e69   in (start, fini
+00010cf0: 7368 293a 0a20 2020 2020 2020 2020 2020  sh):.           
+00010d00: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+00010d10: 6b77 6172 6773 2c20 286b 7761 7267 732c  kwargs, (kwargs,
+00010d20: 2073 7461 7274 2c20 6669 6e69 7368 290a   start, finish).
+00010d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010d40: 615f 7265 6373 2c20 615f 636d 7367 732c  a_recs, a_cmsgs,
+00010d50: 2061 5f77 6d73 6773 203d 2073 656c 662e   a_wmsgs = self.
+00010d60: 5f74 7261 6e73 6974 696f 6e28 0a20 2020  _transition(.   
+00010d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010d80: 206b 6579 2c20 2272 656c 6561 7365 6422   key, "released"
+00010d90: 2c20 7374 696d 756c 7573 5f69 640a 2020  , stimulus_id.  
+00010da0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00010db0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010dc0: 2076 203d 2061 5f72 6563 732e 6765 7428   v = a_recs.get(
+00010dd0: 6b65 792c 2066 696e 6973 6829 0a20 2020  key, finish).   
+00010de0: 2020 2020 2020 2020 2020 2020 2023 2054               # T
+00010df0: 6865 2069 6e6e 6572 2072 6563 2068 6173  he inner rec has
+00010e00: 2068 6967 6865 7220 7072 696f 7269 7479   higher priority
+00010e10: 3f20 4973 2074 6861 7420 616c 7761 7973  ? Is that always
+00010e20: 2064 6573 6972 6564 3f0a 2020 2020 2020   desired?.      
+00010e30: 2020 2020 2020 2020 2020 6675 6e63 203d            func =
+00010e40: 2073 656c 662e 5f54 5241 4e53 4954 494f   self._TRANSITIO
+00010e50: 4e53 5f54 4142 4c45 5b22 7265 6c65 6173  NS_TABLE["releas
+00010e60: 6564 222c 2076 5d0a 2020 2020 2020 2020  ed", v].        
+00010e70: 2020 2020 2020 2020 625f 7265 6373 2c20          b_recs, 
+00010e80: 625f 636d 7367 732c 2062 5f77 6d73 6773  b_cmsgs, b_wmsgs
+00010e90: 203d 2066 756e 6328 7365 6c66 2c20 6b65   = func(self, ke
+00010ea0: 792c 2073 7469 6d75 6c75 735f 6964 290a  y, stimulus_id).
+00010eb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010ec0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+00010ed0: 2e75 7064 6174 6528 615f 7265 6373 290a  .update(a_recs).
+00010ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010ef0: 666f 7220 632c 206e 6577 5f6d 7367 7320  for c, new_msgs 
+00010f00: 696e 2061 5f63 6d73 6773 2e69 7465 6d73  in a_cmsgs.items
+00010f10: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00010f20: 2020 2020 2020 2020 636c 6965 6e74 5f6d          client_m
+00010f30: 7367 732e 7365 7464 6566 6175 6c74 2863  sgs.setdefault(c
+00010f40: 2c20 5b5d 292e 6578 7465 6e64 286e 6577  , []).extend(new
+00010f50: 5f6d 7367 7329 0a20 2020 2020 2020 2020  _msgs).         
+00010f60: 2020 2020 2020 2066 6f72 2077 2c20 6e65         for w, ne
+00010f70: 775f 6d73 6773 2069 6e20 615f 776d 7367  w_msgs in a_wmsg
+00010f80: 732e 6974 656d 7328 293a 0a20 2020 2020  s.items():.     
+00010f90: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+00010fa0: 6f72 6b65 725f 6d73 6773 2e73 6574 6465  orker_msgs.setde
+00010fb0: 6661 756c 7428 772c 205b 5d29 2e65 7874  fault(w, []).ext
+00010fc0: 656e 6428 6e65 775f 6d73 6773 290a 0a20  end(new_msgs).. 
+00010fd0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00010fe0: 6563 6f6d 6d65 6e64 6174 696f 6e73 2e75  ecommendations.u
+00010ff0: 7064 6174 6528 625f 7265 6373 290a 2020  pdate(b_recs).  
+00011000: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00011010: 7220 632c 206e 6577 5f6d 7367 7320 696e  r c, new_msgs in
+00011020: 2062 5f63 6d73 6773 2e69 7465 6d73 2829   b_cmsgs.items()
+00011030: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00011040: 2020 2020 2020 636c 6965 6e74 5f6d 7367        client_msg
+00011050: 732e 7365 7464 6566 6175 6c74 2863 2c20  s.setdefault(c, 
+00011060: 5b5d 292e 6578 7465 6e64 286e 6577 5f6d  []).extend(new_m
+00011070: 7367 7329 0a20 2020 2020 2020 2020 2020  sgs).           
+00011080: 2020 2020 2066 6f72 2077 2c20 6e65 775f       for w, new_
+00011090: 6d73 6773 2069 6e20 625f 776d 7367 732e  msgs in b_wmsgs.
+000110a0: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
+000110b0: 2020 2020 2020 2020 2020 2020 2077 6f72               wor
+000110c0: 6b65 725f 6d73 6773 2e73 6574 6465 6661  ker_msgs.setdefa
+000110d0: 756c 7428 772c 205b 5d29 2e65 7874 656e  ult(w, []).exten
+000110e0: 6428 6e65 775f 6d73 6773 290a 0a20 2020  d(new_msgs)..   
+000110f0: 2020 2020 2020 2020 2020 2020 2073 7461               sta
+00011100: 7274 203d 2022 7265 6c65 6173 6564 220a  rt = "released".
+00011110: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00011120: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00011130: 2020 7261 6973 6520 5275 6e74 696d 6545    raise RuntimeE
+00011140: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+00011150: 2020 2020 2020 2020 2020 6622 496d 706f            f"Impo
+00011160: 7373 6962 6c65 2074 7261 6e73 6974 696f  ssible transitio
+00011170: 6e20 6672 6f6d 207b 7374 6172 747d 2074  n from {start} t
+00011180: 6f20 7b66 696e 6973 687d 2066 6f72 207b  o {finish} for {
+00011190: 6b65 7921 727d 3a20 220a 2020 2020 2020  key!r}: ".      
+000111a0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+000111b0: 7b73 7469 6d75 6c75 735f 6964 3d7d 2c20  {stimulus_id=}, 
+000111c0: 7b6b 7761 7267 733d 7d2c 2073 746f 7279  {kwargs=}, story
+000111d0: 3d7b 7365 6c66 2e73 746f 7279 2874 7329  ={self.story(ts)
+000111e0: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
+000111f0: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
+00011200: 2020 6966 206e 6f74 2073 7469 6d75 6c75    if not stimulu
+00011210: 735f 6964 3a0a 2020 2020 2020 2020 2020  s_id:.          
+00011220: 2020 2020 2020 7374 696d 756c 7573 5f69        stimulus_i
+00011230: 6420 3d20 5354 494d 554c 5553 5f49 445f  d = STIMULUS_ID_
+00011240: 554e 5345 540a 0a20 2020 2020 2020 2020  UNSET..         
+00011250: 2020 2061 6374 7561 6c5f 6669 6e69 7368     actual_finish
+00011260: 203d 2074 732e 5f73 7461 7465 0a20 2020   = ts._state.   
+00011270: 2020 2020 2020 2020 2073 656c 662e 7472           self.tr
+00011280: 616e 7369 7469 6f6e 5f6c 6f67 2e61 7070  ansition_log.app
+00011290: 656e 6428 0a20 2020 2020 2020 2020 2020  end(.           
+000112a0: 2020 2020 2054 7261 6e73 6974 696f 6e28       Transition(
+000112b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000112c0: 2020 2020 206b 6579 2c20 7374 6172 742c       key, start,
+000112d0: 2061 6374 7561 6c5f 6669 6e69 7368 2c20   actual_finish, 
+000112e0: 7265 636f 6d6d 656e 6461 7469 6f6e 732c  recommendations,
+000112f0: 2073 7469 6d75 6c75 735f 6964 2c20 7469   stimulus_id, ti
+00011300: 6d65 2829 0a20 2020 2020 2020 2020 2020  me().           
 00011310: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00011320: 2020 2069 6620 7365 6c66 2e76 616c 6964     if self.valid
-00011330: 6174 653a 0a20 2020 2020 2020 2020 2020  ate:.           
-00011340: 2020 2020 2069 6620 7374 696d 756c 7573       if stimulus
-00011350: 5f69 6420 3d3d 2053 5449 4d55 4c55 535f  _id == STIMULUS_
-00011360: 4944 5f55 4e53 4554 3a0a 2020 2020 2020  ID_UNSET:.      
-00011370: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-00011380: 6973 6520 5275 6e74 696d 6545 7272 6f72  ise RuntimeError
-00011390: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000113a0: 2020 2020 2020 2020 2020 2273 7469 6d75            "stimu
-000113b0: 6c75 735f 6964 206e 6f74 2073 6574 2064  lus_id not set d
-000113c0: 7572 696e 6720 5363 6865 6475 6c65 7220  uring Scheduler 
-000113d0: 7472 616e 7369 7469 6f6e 220a 2020 2020  transition".    
-000113e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000113f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00011400: 2020 6c6f 6767 6572 2e64 6562 7567 280a    logger.debug(.
-00011410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011420: 2020 2020 2254 7261 6e73 6974 696f 6e65      "Transitione
-00011430: 6420 2572 2025 732d 3e25 7320 2861 6374  d %r %s->%s (act
-00011440: 7561 6c3a 2025 7329 2e20 2043 6f6e 7365  ual: %s).  Conse
-00011450: 7175 656e 6365 3a20 2573 222c 0a20 2020  quence: %s",.   
-00011460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011470: 206b 6579 2c0a 2020 2020 2020 2020 2020   key,.          
-00011480: 2020 2020 2020 2020 2020 7374 6172 742c            start,
-00011490: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000114a0: 2020 2020 2066 696e 6973 682c 0a20 2020       finish,.   
-000114b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000114c0: 2061 6374 7561 6c5f 6669 6e69 7368 2c0a   actual_finish,.
-000114d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000114e0: 2020 2020 6469 6374 2872 6563 6f6d 6d65      dict(recomme
-000114f0: 6e64 6174 696f 6e73 292c 0a20 2020 2020  ndations),.     
-00011500: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00011510: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-00011520: 2e70 6c75 6769 6e73 3a0a 2020 2020 2020  .plugins:.      
-00011530: 2020 2020 2020 2020 2020 2320 5465 6d70            # Temp
-00011540: 6f72 6172 696c 7920 7075 7420 6261 636b  orarily put back
-00011550: 2066 6f72 676f 7474 656e 206b 6579 2066   forgotten key f
-00011560: 6f72 2070 6c75 6769 6e20 746f 2072 6574  or plugin to ret
-00011570: 7269 6576 6520 6974 0a20 2020 2020 2020  rieve it.       
-00011580: 2020 2020 2020 2020 2069 6620 7473 2e5f           if ts._
-00011590: 7374 6174 6520 3d3d 2022 666f 7267 6f74  state == "forgot
-000115a0: 7465 6e22 3a0a 2020 2020 2020 2020 2020  ten":.          
-000115b0: 2020 2020 2020 2020 2020 7473 2e64 6570            ts.dep
-000115c0: 656e 6465 6e74 7320 3d20 6465 7065 6e64  endents = depend
-000115d0: 656e 7473 0a20 2020 2020 2020 2020 2020  ents.           
-000115e0: 2020 2020 2020 2020 2074 732e 6465 7065           ts.depe
-000115f0: 6e64 656e 6369 6573 203d 2064 6570 656e  ndencies = depen
-00011600: 6465 6e63 6965 730a 2020 2020 2020 2020  dencies.        
-00011610: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00011620: 2e74 6173 6b73 5b74 732e 6b65 795d 203d  .tasks[ts.key] =
-00011630: 2074 730a 2020 2020 2020 2020 2020 2020   ts.            
-00011640: 2020 2020 666f 7220 706c 7567 696e 2069      for plugin i
-00011650: 6e20 6c69 7374 2873 656c 662e 706c 7567  n list(self.plug
-00011660: 696e 732e 7661 6c75 6573 2829 293a 0a20  ins.values()):. 
-00011670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011680: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00011690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000116a0: 706c 7567 696e 2e74 7261 6e73 6974 696f  plugin.transitio
-000116b0: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
-000116c0: 2020 2020 2020 2020 2020 2020 2020 206b                 k
-000116d0: 6579 2c20 7374 6172 742c 2061 6374 7561  ey, start, actua
-000116e0: 6c5f 6669 6e69 7368 2c20 7374 696d 756c  l_finish, stimul
-000116f0: 7573 5f69 643d 7374 696d 756c 7573 5f69  us_id=stimulus_i
-00011700: 642c 202a 2a6b 7761 7267 730a 2020 2020  d, **kwargs.    
-00011710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011720: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00011730: 2020 2020 2020 2020 2020 6578 6365 7074            except
-00011740: 2045 7863 6570 7469 6f6e 3a0a 2020 2020   Exception:.    
-00011750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011760: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
-00011770: 2250 6c75 6769 6e20 6661 696c 6564 2077  "Plugin failed w
-00011780: 6974 6820 6578 6365 7074 696f 6e22 2c20  ith exception", 
-00011790: 6578 635f 696e 666f 3d54 7275 6529 0a20  exc_info=True). 
-000117a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000117b0: 6620 7473 2e73 7461 7465 203d 3d20 2266  f ts.state == "f
-000117c0: 6f72 676f 7474 656e 223a 0a20 2020 2020  orgotten":.     
-000117d0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-000117e0: 656c 2073 656c 662e 7461 736b 735b 7473  el self.tasks[ts
-000117f0: 2e6b 6579 5d0a 0a20 2020 2020 2020 2020  .key]..         
-00011800: 2020 2074 6720 3d20 7473 2e67 726f 7570     tg = ts.group
-00011810: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00011820: 7473 2e73 7461 7465 203d 3d20 2266 6f72  ts.state == "for
-00011830: 676f 7474 656e 2220 616e 6420 7467 2e6e  gotten" and tg.n
-00011840: 616d 6520 696e 2073 656c 662e 7461 736b  ame in self.task
-00011850: 5f67 726f 7570 733a 0a20 2020 2020 2020  _groups:.       
-00011860: 2020 2020 2020 2020 2023 2052 656d 6f76           # Remov
-00011870: 6520 5461 736b 4772 6f75 7020 6966 2061  e TaskGroup if a
-00011880: 6c6c 2074 6173 6b73 2061 7265 2069 6e20  ll tasks are in 
-00011890: 7468 6520 666f 7267 6f74 7465 6e20 7374  the forgotten st
-000118a0: 6174 650a 2020 2020 2020 2020 2020 2020  ate.            
-000118b0: 2020 2020 6966 2061 6c6c 2876 203d 3d20      if all(v == 
-000118c0: 3020 6f72 206b 203d 3d20 2266 6f72 676f  0 or k == "forgo
-000118d0: 7474 656e 2220 666f 7220 6b2c 2076 2069  tten" for k, v i
-000118e0: 6e20 7467 2e73 7461 7465 732e 6974 656d  n tg.states.item
-000118f0: 7328 2929 3a0a 2020 2020 2020 2020 2020  s()):.          
-00011900: 2020 2020 2020 2020 2020 7473 2e70 7265            ts.pre
-00011910: 6669 782e 6772 6f75 7073 2e72 656d 6f76  fix.groups.remov
-00011920: 6528 7467 290a 2020 2020 2020 2020 2020  e(tg).          
-00011930: 2020 2020 2020 2020 2020 6465 6c20 7365            del se
-00011940: 6c66 2e74 6173 6b5f 6772 6f75 7073 5b74  lf.task_groups[t
-00011950: 672e 6e61 6d65 5d0a 0a20 2020 2020 2020  g.name]..       
-00011960: 2020 2020 2072 6574 7572 6e20 7265 636f       return reco
-00011970: 6d6d 656e 6461 7469 6f6e 732c 2063 6c69  mmendations, cli
-00011980: 656e 745f 6d73 6773 2c20 776f 726b 6572  ent_msgs, worker
-00011990: 5f6d 7367 730a 2020 2020 2020 2020 6578  _msgs.        ex
-000119a0: 6365 7074 2045 7863 6570 7469 6f6e 3a0a  cept Exception:.
-000119b0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-000119c0: 6572 2e65 7863 6570 7469 6f6e 2822 4572  er.exception("Er
-000119d0: 726f 7220 7472 616e 7369 7469 6f6e 696e  ror transitionin
-000119e0: 6720 2572 2066 726f 6d20 2572 2074 6f20  g %r from %r to 
-000119f0: 2572 222c 206b 6579 2c20 7374 6172 742c  %r", key, start,
-00011a00: 2066 696e 6973 6829 0a20 2020 2020 2020   finish).       
-00011a10: 2020 2020 2069 6620 4c4f 475f 5044 423a       if LOG_PDB:
-00011a20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011a30: 2069 6d70 6f72 7420 7064 620a 0a20 2020   import pdb..   
-00011a40: 2020 2020 2020 2020 2020 2020 2070 6462               pdb
-00011a50: 2e73 6574 5f74 7261 6365 2829 0a20 2020  .set_trace().   
-00011a60: 2020 2020 2020 2020 2072 6169 7365 0a0a           raise..
-00011a70: 2020 2020 6465 6620 5f74 7261 6e73 6974      def _transit
-00011a80: 696f 6e73 280a 2020 2020 2020 2020 7365  ions(.        se
-00011a90: 6c66 2c0a 2020 2020 2020 2020 7265 636f  lf,.        reco
-00011aa0: 6d6d 656e 6461 7469 6f6e 733a 2052 6563  mmendations: Rec
-00011ab0: 732c 0a20 2020 2020 2020 2063 6c69 656e  s,.        clien
-00011ac0: 745f 6d73 6773 3a20 4d73 6773 2c0a 2020  t_msgs: Msgs,.  
-00011ad0: 2020 2020 2020 776f 726b 6572 5f6d 7367        worker_msg
-00011ae0: 733a 204d 7367 732c 0a20 2020 2020 2020  s: Msgs,.       
-00011af0: 2073 7469 6d75 6c75 735f 6964 3a20 7374   stimulus_id: st
-00011b00: 722c 0a20 2020 2029 202d 3e20 4e6f 6e65  r,.    ) -> None
-00011b10: 3a0a 2020 2020 2020 2020 2222 2250 726f  :.        """Pro
-00011b20: 6365 7373 2074 7261 6e73 6974 696f 6e73  cess transitions
-00011b30: 2075 6e74 696c 206e 6f6e 6520 6172 6520   until none are 
-00011b40: 6c65 6674 0a0a 2020 2020 2020 2020 5468  left..        Th
-00011b50: 6973 2069 6e63 6c75 6465 7320 6665 6564  is includes feed
-00011b60: 6261 636b 2066 726f 6d20 7072 6576 696f  back from previo
-00011b70: 7573 2074 7261 6e73 6974 696f 6e73 2061  us transitions a
-00011b80: 6e64 2063 6f6e 7469 6e75 6573 2075 6e74  nd continues unt
-00011b90: 696c 2077 650a 2020 2020 2020 2020 7265  il we.        re
-00011ba0: 6163 6820 6120 7374 6561 6479 2073 7461  ach a steady sta
-00011bb0: 7465 0a20 2020 2020 2020 2022 2222 0a20  te.        """. 
-00011bc0: 2020 2020 2020 206b 6579 733a 2073 6574         keys: set
-00011bd0: 5b4b 6579 5d20 3d20 7365 7428 290a 2020  [Key] = set().  
-00011be0: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
-00011bf0: 7469 6f6e 7320 3d20 7265 636f 6d6d 656e  tions = recommen
-00011c00: 6461 7469 6f6e 732e 636f 7079 2829 0a0a  dations.copy()..
-00011c10: 2020 2020 2020 2020 7768 696c 6520 7265          while re
-00011c20: 636f 6d6d 656e 6461 7469 6f6e 733a 0a20  commendations:. 
-00011c30: 2020 2020 2020 2020 2020 206b 6579 2c20             key, 
-00011c40: 6669 6e69 7368 203d 2072 6563 6f6d 6d65  finish = recomme
-00011c50: 6e64 6174 696f 6e73 2e70 6f70 6974 656d  ndations.popitem
-00011c60: 2829 0a20 2020 2020 2020 2020 2020 206b  ().            k
-00011c70: 6579 732e 6164 6428 6b65 7929 0a0a 2020  eys.add(key)..  
-00011c80: 2020 2020 2020 2020 2020 6e65 775f 7265            new_re
-00011c90: 6373 2c20 6e65 775f 636d 7367 732c 206e  cs, new_cmsgs, n
-00011ca0: 6577 5f77 6d73 6773 203d 2073 656c 662e  ew_wmsgs = self.
-00011cb0: 5f74 7261 6e73 6974 696f 6e28 6b65 792c  _transition(key,
-00011cc0: 2066 696e 6973 682c 2073 7469 6d75 6c75   finish, stimulu
-00011cd0: 735f 6964 290a 0a20 2020 2020 2020 2020  s_id)..         
-00011ce0: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
-00011cf0: 6e73 2e75 7064 6174 6528 6e65 775f 7265  ns.update(new_re
-00011d00: 6373 290a 2020 2020 2020 2020 2020 2020  cs).            
-00011d10: 666f 7220 632c 206e 6577 5f6d 7367 7320  for c, new_msgs 
-00011d20: 696e 206e 6577 5f63 6d73 6773 2e69 7465  in new_cmsgs.ite
-00011d30: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
-00011d40: 2020 2020 2020 636c 6965 6e74 5f6d 7367        client_msg
-00011d50: 732e 7365 7464 6566 6175 6c74 2863 2c20  s.setdefault(c, 
-00011d60: 5b5d 292e 6578 7465 6e64 286e 6577 5f6d  []).extend(new_m
-00011d70: 7367 7329 0a20 2020 2020 2020 2020 2020  sgs).           
-00011d80: 2066 6f72 2077 2c20 6e65 775f 6d73 6773   for w, new_msgs
-00011d90: 2069 6e20 6e65 775f 776d 7367 732e 6974   in new_wmsgs.it
-00011da0: 656d 7328 293a 0a20 2020 2020 2020 2020  ems():.         
-00011db0: 2020 2020 2020 2077 6f72 6b65 725f 6d73         worker_ms
-00011dc0: 6773 2e73 6574 6465 6661 756c 7428 772c  gs.setdefault(w,
-00011dd0: 205b 5d29 2e65 7874 656e 6428 6e65 775f   []).extend(new_
-00011de0: 6d73 6773 290a 0a20 2020 2020 2020 2069  msgs)..        i
-00011df0: 6620 7365 6c66 2e76 616c 6964 6174 653a  f self.validate:
-00011e00: 0a20 2020 2020 2020 2020 2020 2023 2046  .            # F
-00011e10: 4958 4d45 2064 6f77 6e63 6173 7420 616e  IXME downcast an
-00011e20: 7469 7061 7474 6572 6e0a 2020 2020 2020  tipattern.      
-00011e30: 2020 2020 2020 7363 6865 6475 6c65 7220        scheduler 
-00011e40: 3d20 6361 7374 2853 6368 6564 756c 6572  = cast(Scheduler
-00011e50: 2c20 7365 6c66 290a 2020 2020 2020 2020  , self).        
-00011e60: 2020 2020 666f 7220 6b65 7920 696e 206b      for key in k
-00011e70: 6579 733a 0a20 2020 2020 2020 2020 2020  eys:.           
-00011e80: 2020 2020 2073 6368 6564 756c 6572 2e76       scheduler.v
-00011e90: 616c 6964 6174 655f 6b65 7928 6b65 7929  alidate_key(key)
-00011ea0: 0a0a 2020 2020 6465 6620 5f74 7261 6e73  ..    def _trans
-00011eb0: 6974 696f 6e5f 7265 6c65 6173 6564 5f77  ition_released_w
-00011ec0: 6169 7469 6e67 2873 656c 662c 206b 6579  aiting(self, key
-00011ed0: 3a20 4b65 792c 2073 7469 6d75 6c75 735f  : Key, stimulus_
-00011ee0: 6964 3a20 7374 7229 202d 3e20 5265 6373  id: str) -> Recs
-00011ef0: 4d73 6773 3a0a 2020 2020 2020 2020 7473  Msgs:.        ts
-00011f00: 203d 2073 656c 662e 7461 736b 735b 6b65   = self.tasks[ke
-00011f10: 795d 0a0a 2020 2020 2020 2020 6966 2073  y]..        if s
-00011f20: 656c 662e 7661 6c69 6461 7465 3a0a 2020  elf.validate:.  
-00011f30: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00011f40: 2074 732e 7275 6e5f 7370 6563 0a20 2020   ts.run_spec.   
-00011f50: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00011f60: 6e6f 7420 7473 2e77 6169 7469 6e67 5f6f  not ts.waiting_o
-00011f70: 6e0a 2020 2020 2020 2020 2020 2020 6173  n.            as
-00011f80: 7365 7274 206e 6f74 2074 732e 7768 6f5f  sert not ts.who_
-00011f90: 6861 730a 2020 2020 2020 2020 2020 2020  has.            
-00011fa0: 6173 7365 7274 206e 6f74 2074 732e 7072  assert not ts.pr
-00011fb0: 6f63 6573 7369 6e67 5f6f 6e0a 2020 2020  ocessing_on.    
-00011fc0: 2020 2020 2020 2020 666f 7220 6474 7320          for dts 
-00011fd0: 696e 2074 732e 6465 7065 6e64 656e 6369  in ts.dependenci
-00011fe0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-00011ff0: 2020 2020 6173 7365 7274 2064 7473 2e73      assert dts.s
-00012000: 7461 7465 206e 6f74 2069 6e20 7b22 666f  tate not in {"fo
-00012010: 7267 6f74 7465 6e22 2c20 2265 7272 6564  rgotten", "erred
-00012020: 227d 2c20 280a 2020 2020 2020 2020 2020  "}, (.          
-00012030: 2020 2020 2020 2020 2020 7374 7228 7473            str(ts
-00012040: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00012050: 2020 2020 2020 2073 7472 2864 7473 292c         str(dts),
-00012060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012070: 2020 2020 2073 656c 662e 7472 616e 7369       self.transi
-00012080: 7469 6f6e 5f6c 6f67 2c0a 2020 2020 2020  tion_log,.      
-00012090: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-000120a0: 2020 2020 2069 6620 7473 2e68 6173 5f6c       if ts.has_l
-000120b0: 6f73 745f 6465 7065 6e64 656e 6369 6573  ost_dependencies
-000120c0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-000120d0: 7475 726e 207b 6b65 793a 2022 666f 7267  turn {key: "forg
-000120e0: 6f74 7465 6e22 7d2c 207b 7d2c 207b 7d0a  otten"}, {}, {}.
-000120f0: 0a20 2020 2020 2020 2074 732e 7374 6174  .        ts.stat
-00012100: 6520 3d20 2277 6169 7469 6e67 220a 0a20  e = "waiting".. 
-00012110: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
-00012120: 6174 696f 6e73 3a20 5265 6373 203d 207b  ations: Recs = {
-00012130: 7d0a 0a20 2020 2020 2020 2066 6f72 2064  }..        for d
-00012140: 7473 2069 6e20 7473 2e64 6570 656e 6465  ts in ts.depende
-00012150: 6e63 6965 733a 0a20 2020 2020 2020 2020  ncies:.         
-00012160: 2020 2069 6620 6e6f 7420 6474 732e 7768     if not dts.wh
-00012170: 6f5f 6861 733a 0a20 2020 2020 2020 2020  o_has:.         
-00012180: 2020 2020 2020 2069 6620 6e6f 7420 7473         if not ts
-00012190: 2e77 6169 7469 6e67 5f6f 6e3a 0a20 2020  .waiting_on:.   
-000121a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000121b0: 2074 732e 7761 6974 696e 675f 6f6e 203d   ts.waiting_on =
-000121c0: 2073 6574 2829 0a20 2020 2020 2020 2020   set().         
-000121d0: 2020 2020 2020 2074 732e 7761 6974 696e         ts.waitin
-000121e0: 675f 6f6e 2e61 6464 2864 7473 290a 2020  g_on.add(dts).  
-000121f0: 2020 2020 2020 2020 2020 6966 2064 7473            if dts
-00012200: 2e73 7461 7465 203d 3d20 2272 656c 6561  .state == "relea
-00012210: 7365 6422 3a0a 2020 2020 2020 2020 2020  sed":.          
-00012220: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
-00012230: 7469 6f6e 735b 6474 732e 6b65 795d 203d  tions[dts.key] =
-00012240: 2022 7761 6974 696e 6722 0a20 2020 2020   "waiting".     
-00012250: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00012260: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00012270: 6e6f 7420 6474 732e 7761 6974 6572 733a  not dts.waiters:
-00012280: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012290: 2020 2020 2064 7473 2e77 6169 7465 7273       dts.waiters
-000122a0: 203d 2073 6574 2829 0a20 2020 2020 2020   = set().       
-000122b0: 2020 2020 2020 2020 2064 7473 2e77 6169           dts.wai
-000122c0: 7465 7273 2e61 6464 2874 7329 0a0a 2020  ters.add(ts)..  
-000122d0: 2020 2020 2020 7473 2e77 6169 7465 7273        ts.waiters
-000122e0: 203d 207b 6474 7320 666f 7220 6474 7320   = {dts for dts 
-000122f0: 696e 2074 732e 6465 7065 6e64 656e 7473  in ts.dependents
-00012300: 2069 6620 6474 732e 7374 6174 6520 3d3d   if dts.state ==
-00012310: 2022 7761 6974 696e 6722 7d0a 0a20 2020   "waiting"}..   
-00012320: 2020 2020 2069 6620 6e6f 7420 7473 2e77       if not ts.w
-00012330: 6169 7469 6e67 5f6f 6e3a 0a20 2020 2020  aiting_on:.     
-00012340: 2020 2020 2020 2023 204e 4f54 453a 2077         # NOTE: w
-00012350: 6169 7469 6e67 2d3e 7072 6f63 6573 7369  aiting->processi
-00012360: 6e67 2077 696c 6c20 7365 6e64 2074 6173  ng will send tas
-00012370: 6b73 2074 6f20 7175 6575 6564 206f 7220  ks to queued or 
-00012380: 6e6f 2d77 6f72 6b65 7220 6173 0a20 2020  no-worker as.   
-00012390: 2020 2020 2020 2020 2023 206e 6563 6573           # neces
-000123a0: 7361 7279 0a20 2020 2020 2020 2020 2020  sary.           
-000123b0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-000123c0: 5b6b 6579 5d20 3d20 2270 726f 6365 7373  [key] = "process
-000123d0: 696e 6722 0a0a 2020 2020 2020 2020 7265  ing"..        re
-000123e0: 7475 726e 2072 6563 6f6d 6d65 6e64 6174  turn recommendat
-000123f0: 696f 6e73 2c20 7b7d 2c20 7b7d 0a0a 2020  ions, {}, {}..  
-00012400: 2020 6465 6620 5f74 7261 6e73 6974 696f    def _transitio
-00012410: 6e5f 6e6f 5f77 6f72 6b65 725f 7072 6f63  n_no_worker_proc
-00012420: 6573 7369 6e67 2873 656c 662c 206b 6579  essing(self, key
-00012430: 3a20 4b65 792c 2073 7469 6d75 6c75 735f  : Key, stimulus_
-00012440: 6964 3a20 7374 7229 202d 3e20 5265 6373  id: str) -> Recs
-00012450: 4d73 6773 3a0a 2020 2020 2020 2020 7473  Msgs:.        ts
-00012460: 203d 2073 656c 662e 7461 736b 735b 6b65   = self.tasks[ke
-00012470: 795d 0a0a 2020 2020 2020 2020 6966 2073  y]..        if s
-00012480: 656c 662e 7661 6c69 6461 7465 3a0a 2020  elf.validate:.  
-00012490: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-000124a0: 206e 6f74 2074 732e 6163 746f 722c 2066   not ts.actor, f
-000124b0: 2241 6374 6f72 7320 6361 6e27 7420 6265  "Actors can't be
-000124c0: 2069 6e20 606e 6f2d 776f 726b 6572 603a   in `no-worker`:
-000124d0: 207b 7473 7d22 0a20 2020 2020 2020 2020   {ts}".         
-000124e0: 2020 2061 7373 6572 7420 7473 2069 6e20     assert ts in 
-000124f0: 7365 6c66 2e75 6e72 756e 6e61 626c 650a  self.unrunnable.
-00012500: 0a20 2020 2020 2020 2069 6620 7773 203a  .        if ws :
-00012510: 3d20 7365 6c66 2e64 6563 6964 655f 776f  = self.decide_wo
-00012520: 726b 6572 5f6e 6f6e 5f72 6f6f 7469 7368  rker_non_rootish
-00012530: 2874 7329 3a0a 2020 2020 2020 2020 2020  (ts):.          
-00012540: 2020 7365 6c66 2e75 6e72 756e 6e61 626c    self.unrunnabl
-00012550: 652e 6469 7363 6172 6428 7473 290a 2020  e.discard(ts).  
-00012560: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00012570: 2073 656c 662e 5f61 6464 5f74 6f5f 7072   self._add_to_pr
-00012580: 6f63 6573 7369 6e67 2874 732c 2077 732c  ocessing(ts, ws,
-00012590: 2073 7469 6d75 6c75 735f 6964 3d73 7469   stimulus_id=sti
-000125a0: 6d75 6c75 735f 6964 290a 2020 2020 2020  mulus_id).      
-000125b0: 2020 2320 4966 206e 6f20 776f 726b 6572    # If no worker
-000125c0: 2c20 7461 736b 206a 7573 7420 7374 6179  , task just stay
-000125d0: 7320 696e 2060 6e6f 2d77 6f72 6b65 7260  s in `no-worker`
-000125e0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-000125f0: 207b 7d2c 207b 7d2c 207b 7d0a 0a20 2020   {}, {}, {}..   
-00012600: 2064 6566 2064 6563 6964 655f 776f 726b   def decide_work
-00012610: 6572 5f72 6f6f 7469 7368 5f71 7565 7569  er_rootish_queui
-00012620: 6e67 5f64 6973 6162 6c65 6428 0a20 2020  ng_disabled(.   
-00012630: 2020 2020 2073 656c 662c 2074 733a 2054       self, ts: T
-00012640: 6173 6b53 7461 7465 0a20 2020 2029 202d  askState.    ) -
-00012650: 3e20 576f 726b 6572 5374 6174 6520 7c20  > WorkerState | 
-00012660: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
-00012670: 2250 6963 6b20 6120 776f 726b 6572 2066  "Pick a worker f
-00012680: 6f72 2061 2072 756e 6e61 626c 6520 726f  or a runnable ro
-00012690: 6f74 2d69 7368 2074 6173 6b2c 2077 6974  ot-ish task, wit
-000126a0: 686f 7574 2071 7565 7569 6e67 2e0a 0a20  hout queuing... 
-000126b0: 2020 2020 2020 2054 6869 7320 6174 7465         This atte
-000126c0: 6d70 7473 2074 6f20 7363 6865 6475 6c65  mpts to schedule
-000126d0: 2073 6962 6c69 6e67 2074 6173 6b73 206f   sibling tasks o
-000126e0: 6e20 7468 6520 7361 6d65 2077 6f72 6b65  n the same worke
-000126f0: 722c 2072 6564 7563 696e 6720 6675 7475  r, reducing futu
-00012700: 7265 2064 6174 610a 2020 2020 2020 2020  re data.        
-00012710: 7472 616e 7366 6572 2e20 4974 2064 6f65  transfer. It doe
-00012720: 7320 6e6f 7420 636f 6e73 6964 6572 2074  s not consider t
-00012730: 6865 206c 6f63 6174 696f 6e20 6f66 2064  he location of d
-00012740: 6570 656e 6465 6e63 6965 732c 2073 696e  ependencies, sin
-00012750: 6365 2074 6865 7927 6c6c 2065 6e64 0a20  ce they'll end. 
-00012760: 2020 2020 2020 2075 7020 6f6e 2065 7665         up on eve
-00012770: 7279 2077 6f72 6b65 7220 616e 7977 6179  ry worker anyway
-00012780: 2e0a 0a20 2020 2020 2020 2049 7420 6173  ...        It as
-00012790: 7375 6d65 7320 6974 2773 2062 6569 6e67  sumes it's being
-000127a0: 2063 616c 6c65 6420 6f6e 2061 2062 6174   called on a bat
-000127b0: 6368 206f 6620 7461 736b 7320 696e 2070  ch of tasks in p
-000127c0: 7269 6f72 6974 7920 6f72 6465 722c 2061  riority order, a
-000127d0: 6e64 0a20 2020 2020 2020 206d 6169 6e74  nd.        maint
-000127e0: 6169 6e73 2073 7461 7465 2069 6e20 6053  ains state in `S
-000127f0: 6368 6564 756c 6572 5374 6174 652e 6c61  chedulerState.la
-00012800: 7374 5f72 6f6f 745f 776f 726b 6572 6020  st_root_worker` 
-00012810: 616e 640a 2020 2020 2020 2020 6053 6368  and.        `Sch
-00012820: 6564 756c 6572 5374 6174 652e 6c61 7374  edulerState.last
-00012830: 5f72 6f6f 745f 776f 726b 6572 5f74 6173  _root_worker_tas
-00012840: 6b73 5f6c 6566 7460 2074 6f20 6163 6869  ks_left` to achi
-00012850: 6576 6520 7468 6973 2e0a 0a20 2020 2020  eve this...     
-00012860: 2020 2054 6869 7320 7769 6c6c 2073 656e     This will sen
-00012870: 6420 6576 6572 7920 7275 6e6e 6162 6c65  d every runnable
-00012880: 2074 6173 6b20 746f 2061 2077 6f72 6b65   task to a worke
-00012890: 722c 206f 6674 656e 2063 6175 7369 6e67  r, often causing
-000128a0: 2072 6f6f 7420 7461 736b 0a20 2020 2020   root task.     
-000128b0: 2020 206f 7665 7270 726f 6475 6374 696f     overproductio
-000128c0: 6e2e 0a0a 2020 2020 2020 2020 5265 7475  n...        Retu
-000128d0: 726e 730a 2020 2020 2020 2020 2d2d 2d2d  rns.        ----
-000128e0: 2d2d 2d0a 2020 2020 2020 2020 7773 3a20  ---.        ws: 
-000128f0: 576f 726b 6572 5374 6174 6520 7c20 4e6f  WorkerState | No
-00012900: 6e65 0a20 2020 2020 2020 2020 2020 2054  ne.            T
-00012910: 6865 2077 6f72 6b65 7220 746f 2061 7373  he worker to ass
-00012920: 6967 6e20 7468 6520 7461 736b 2074 6f2e  ign the task to.
-00012930: 2049 6620 7468 6572 6520 6172 6520 6e6f   If there are no
-00012940: 2077 6f72 6b65 7273 2069 6e20 7468 6520   workers in the 
-00012950: 636c 7573 7465 722c 0a20 2020 2020 2020  cluster,.       
-00012960: 2020 2020 2072 6574 7572 6e73 204e 6f6e       returns Non
-00012970: 652c 2069 6e20 7768 6963 6820 6361 7365  e, in which case
-00012980: 2074 6865 2074 6173 6b20 7368 6f75 6c64   the task should
-00012990: 2062 6520 7472 616e 7369 7469 6f6e 6564   be transitioned
-000129a0: 2074 6f0a 2020 2020 2020 2020 2020 2020   to.            
-000129b0: 6060 6e6f 2d77 6f72 6b65 7260 602e 0a20  ``no-worker``.. 
-000129c0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-000129d0: 2020 2069 6620 7365 6c66 2e76 616c 6964     if self.valid
-000129e0: 6174 653a 0a20 2020 2020 2020 2020 2020  ate:.           
-000129f0: 2023 2053 6565 2072 6f6f 742d 6973 682d   # See root-ish-
-00012a00: 6e65 7373 206e 6f74 6520 6265 6c6f 7720  ness note below 
-00012a10: 696e 2060 6465 6369 6465 5f77 6f72 6b65  in `decide_worke
-00012a20: 725f 726f 6f74 6973 685f 7175 6575 696e  r_rootish_queuin
-00012a30: 675f 656e 6162 6c65 6460 0a20 2020 2020  g_enabled`.     
-00012a40: 2020 2020 2020 2061 7373 6572 7420 6d61         assert ma
-00012a50: 7468 2e69 7369 6e66 2873 656c 662e 574f  th.isinf(self.WO
-00012a60: 524b 4552 5f53 4154 5552 4154 494f 4e29  RKER_SATURATION)
-00012a70: 0a0a 2020 2020 2020 2020 706f 6f6c 203d  ..        pool =
-00012a80: 2073 656c 662e 6964 6c65 2e76 616c 7565   self.idle.value
-00012a90: 7328 2920 6966 2073 656c 662e 6964 6c65  s() if self.idle
-00012aa0: 2065 6c73 6520 7365 6c66 2e72 756e 6e69   else self.runni
-00012ab0: 6e67 0a20 2020 2020 2020 2069 6620 6e6f  ng.        if no
-00012ac0: 7420 706f 6f6c 3a0a 2020 2020 2020 2020  t pool:.        
-00012ad0: 2020 2020 7265 7475 726e 204e 6f6e 650a      return None.
-00012ae0: 0a20 2020 2020 2020 2074 6720 3d20 7473  .        tg = ts
-00012af0: 2e67 726f 7570 0a20 2020 2020 2020 206c  .group.        l
-00012b00: 7773 203d 2074 672e 6c61 7374 5f77 6f72  ws = tg.last_wor
-00012b10: 6b65 720a 2020 2020 2020 2020 6966 2028  ker.        if (
-00012b20: 0a20 2020 2020 2020 2020 2020 206c 7773  .            lws
-00012b30: 0a20 2020 2020 2020 2020 2020 2061 6e64  .            and
-00012b40: 2074 672e 6c61 7374 5f77 6f72 6b65 725f   tg.last_worker_
-00012b50: 7461 736b 735f 6c65 6674 0a20 2020 2020  tasks_left.     
-00012b60: 2020 2020 2020 2061 6e64 206c 7773 2e73         and lws.s
-00012b70: 7461 7475 7320 3d3d 2053 7461 7475 732e  tatus == Status.
-00012b80: 7275 6e6e 696e 670a 2020 2020 2020 2020  running.        
-00012b90: 2020 2020 616e 6420 7365 6c66 2e77 6f72      and self.wor
-00012ba0: 6b65 7273 2e67 6574 286c 7773 2e61 6464  kers.get(lws.add
-00012bb0: 7265 7373 2920 6973 206c 7773 0a20 2020  ress) is lws.   
-00012bc0: 2020 2020 2029 3a0a 2020 2020 2020 2020       ):.        
-00012bd0: 2020 2020 7773 203d 206c 7773 0a20 2020      ws = lws.   
-00012be0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00012bf0: 2020 2020 2020 2023 204c 6173 742d 7573         # Last-us
-00012c00: 6564 2077 6f72 6b65 7220 6973 2066 756c  ed worker is ful
-00012c10: 6c2c 2075 6e6b 6e6f 776e 2c20 7265 7469  l, unknown, reti
-00012c20: 7269 6e67 2c20 6f72 2070 6175 7365 643b  ring, or paused;
-00012c30: 0a20 2020 2020 2020 2020 2020 2023 2070  .            # p
-00012c40: 6963 6b20 6120 6e65 7720 776f 726b 6572  ick a new worker
-00012c50: 2066 6f72 2074 6865 206e 6578 7420 6665   for the next fe
-00012c60: 7720 7461 736b 730a 2020 2020 2020 2020  w tasks.        
-00012c70: 2020 2020 7773 203d 206d 696e 2870 6f6f      ws = min(poo
-00012c80: 6c2c 206b 6579 3d70 6172 7469 616c 2873  l, key=partial(s
-00012c90: 656c 662e 776f 726b 6572 5f6f 626a 6563  elf.worker_objec
-00012ca0: 7469 7665 2c20 7473 2929 0a20 2020 2020  tive, ts)).     
-00012cb0: 2020 2020 2020 2074 672e 6c61 7374 5f77         tg.last_w
-00012cc0: 6f72 6b65 725f 7461 736b 735f 6c65 6674  orker_tasks_left
-00012cd0: 203d 206d 6174 682e 666c 6f6f 7228 0a20   = math.floor(. 
-00012ce0: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00012cf0: 6c65 6e28 7467 2920 2f20 7365 6c66 2e74  len(tg) / self.t
-00012d00: 6f74 616c 5f6e 7468 7265 6164 7329 202a  otal_nthreads) *
-00012d10: 2077 732e 6e74 6872 6561 6473 0a20 2020   ws.nthreads.   
-00012d20: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-00012d30: 2020 2020 2320 5265 636f 7264 2060 6c61      # Record `la
-00012d40: 7374 5f77 6f72 6b65 7260 2c20 6f72 2063  st_worker`, or c
-00012d50: 6c65 6172 2069 7420 6f6e 2074 6865 2066  lear it on the f
-00012d60: 696e 616c 2074 6173 6b0a 2020 2020 2020  inal task.      
-00012d70: 2020 7467 2e6c 6173 745f 776f 726b 6572    tg.last_worker
-00012d80: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
-00012d90: 2077 7320 6966 2074 672e 7374 6174 6573   ws if tg.states
-00012da0: 5b22 7265 6c65 6173 6564 225d 202b 2074  ["released"] + t
-00012db0: 672e 7374 6174 6573 5b22 7761 6974 696e  g.states["waitin
-00012dc0: 6722 5d20 3e20 3120 656c 7365 204e 6f6e  g"] > 1 else Non
-00012dd0: 650a 2020 2020 2020 2020 290a 2020 2020  e.        ).    
-00012de0: 2020 2020 7467 2e6c 6173 745f 776f 726b      tg.last_work
-00012df0: 6572 5f74 6173 6b73 5f6c 6566 7420 2d3d  er_tasks_left -=
-00012e00: 2031 0a0a 2020 2020 2020 2020 6966 2073   1..        if s
-00012e10: 656c 662e 7661 6c69 6461 7465 2061 6e64  elf.validate and
-00012e20: 2077 7320 6973 206e 6f74 204e 6f6e 653a   ws is not None:
-00012e30: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00012e40: 6572 7420 7365 6c66 2e77 6f72 6b65 7273  ert self.workers
-00012e50: 2e67 6574 2877 732e 6164 6472 6573 7329  .get(ws.address)
-00012e60: 2069 7320 7773 0a20 2020 2020 2020 2020   is ws.         
-00012e70: 2020 2061 7373 6572 7420 7773 2069 6e20     assert ws in 
-00012e80: 7365 6c66 2e72 756e 6e69 6e67 2c20 2877  self.running, (w
-00012e90: 732c 2073 656c 662e 7275 6e6e 696e 6729  s, self.running)
-00012ea0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00012eb0: 2077 730a 0a20 2020 2064 6566 2064 6563   ws..    def dec
-00012ec0: 6964 655f 776f 726b 6572 5f72 6f6f 7469  ide_worker_rooti
-00012ed0: 7368 5f71 7565 7569 6e67 5f65 6e61 626c  sh_queuing_enabl
-00012ee0: 6564 2873 656c 6629 202d 3e20 576f 726b  ed(self) -> Work
-00012ef0: 6572 5374 6174 6520 7c20 4e6f 6e65 3a0a  erState | None:.
-00012f00: 2020 2020 2020 2020 2222 2250 6963 6b20          """Pick 
-00012f10: 6120 776f 726b 6572 2066 6f72 2061 2072  a worker for a r
-00012f20: 756e 6e61 626c 6520 726f 6f74 2d69 7368  unnable root-ish
-00012f30: 2074 6173 6b2c 2069 6620 6e6f 7420 616c   task, if not al
-00012f40: 6c20 6172 6520 6275 7379 2e0a 0a20 2020  l are busy...   
-00012f50: 2020 2020 2050 6963 6b73 2074 6865 206c       Picks the l
-00012f60: 6561 7374 2d62 7573 7920 776f 726b 6572  east-busy worker
-00012f70: 206f 7574 206f 6620 7468 6520 6060 6964   out of the ``id
-00012f80: 6c65 6060 2077 6f72 6b65 7273 2028 6964  le`` workers (id
-00012f90: 6c65 2077 6f72 6b65 7273 2068 6176 6520  le workers have 
-00012fa0: 6665 7765 720a 2020 2020 2020 2020 7461  fewer.        ta
-00012fb0: 736b 7320 7275 6e6e 696e 6720 7468 616e  sks running than
-00012fc0: 2074 6872 6561 6473 2c20 6173 2073 6574   threads, as set
-00012fd0: 2062 7920 6060 6469 7374 7269 6275 7465   by ``distribute
-00012fe0: 642e 7363 6865 6475 6c65 722e 776f 726b  d.scheduler.work
-00012ff0: 6572 2d73 6174 7572 6174 696f 6e60 6029  er-saturation``)
-00013000: 2e0a 2020 2020 2020 2020 4974 2064 6f65  ..        It doe
-00013010: 7320 6e6f 7420 636f 6e73 6964 6572 2074  s not consider t
-00013020: 6865 206c 6f63 6174 696f 6e20 6f66 2064  he location of d
-00013030: 6570 656e 6465 6e63 6965 732c 2073 696e  ependencies, sin
-00013040: 6365 2074 6865 7927 6c6c 2065 6e64 2075  ce they'll end u
-00013050: 7020 6f6e 2065 7665 7279 0a20 2020 2020  p on every.     
-00013060: 2020 2077 6f72 6b65 7220 616e 7977 6179     worker anyway
-00013070: 2e0a 0a20 2020 2020 2020 2049 6620 616c  ...        If al
-00013080: 6c20 776f 726b 6572 7320 6172 6520 6675  l workers are fu
-00013090: 6c6c 2c20 7265 7475 726e 7320 4e6f 6e65  ll, returns None
-000130a0: 2c20 6d65 616e 696e 6720 7468 6520 7461  , meaning the ta
-000130b0: 736b 2073 686f 756c 6420 7472 616e 7369  sk should transi
-000130c0: 7469 6f6e 2074 6f0a 2020 2020 2020 2020  tion to.        
-000130d0: 6060 7175 6575 6564 6060 2e20 5468 6520  ``queued``. The 
-000130e0: 7363 6865 6475 6c65 7220 7769 6c6c 2077  scheduler will w
-000130f0: 6169 7420 746f 2073 656e 6420 6974 2074  ait to send it t
-00013100: 6f20 6120 776f 726b 6572 2075 6e74 696c  o a worker until
-00013110: 2061 2074 6872 6561 6420 6f70 656e 730a   a thread opens.
-00013120: 2020 2020 2020 2020 7570 2e20 5468 6973          up. This
-00013130: 2065 6e73 7572 6573 2074 6861 7420 646f   ensures that do
-00013140: 776e 7374 7265 616d 2074 6173 6b73 2061  wnstream tasks a
-00013150: 6c77 6179 7320 7275 6e20 6265 666f 7265  lways run before
-00013160: 206e 6577 2072 6f6f 7420 7461 736b 7320   new root tasks 
-00013170: 6172 650a 2020 2020 2020 2020 7374 6172  are.        star
-00013180: 7465 642e 0a0a 2020 2020 2020 2020 5468  ted...        Th
-00013190: 6973 2064 6f65 7320 6e6f 7420 7472 7920  is does not try 
-000131a0: 746f 2073 6368 6564 756c 6520 7369 626c  to schedule sibl
-000131b0: 696e 6720 7461 736b 7320 6f6e 2074 6865  ing tasks on the
-000131c0: 2073 616d 6520 776f 726b 6572 3b20 696e   same worker; in
-000131d0: 2066 6163 742c 2069 740a 2020 2020 2020   fact, it.      
-000131e0: 2020 7573 7561 6c6c 7920 646f 6573 2074    usually does t
-000131f0: 6865 206f 7070 6f73 6974 652e 2045 7665  he opposite. Eve
-00013200: 6e20 7468 6f75 6768 2074 6869 7320 696e  n though this in
-00013210: 6372 6561 7365 7320 7375 6273 6571 7565  creases subseque
-00013220: 6e74 2064 6174 6120 7472 616e 7366 6572  nt data transfer
-00013230: 2c0a 2020 2020 2020 2020 6974 2074 7970  ,.        it typ
-00013240: 6963 616c 6c79 2072 6564 7563 6573 206f  ically reduces o
-00013250: 7665 7261 6c6c 206d 656d 6f72 7920 7573  verall memory us
-00013260: 6520 6279 2065 6c69 6d69 6e61 7469 6e67  e by eliminating
-00013270: 2072 6f6f 7420 7461 736b 206f 7665 7270   root task overp
-00013280: 726f 6475 6374 696f 6e2e 0a0a 2020 2020  roduction...    
-00013290: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
-000132a0: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
-000132b0: 2020 2020 7773 3a20 576f 726b 6572 5374      ws: WorkerSt
-000132c0: 6174 6520 7c20 4e6f 6e65 0a20 2020 2020  ate | None.     
-000132d0: 2020 2020 2020 2054 6865 2077 6f72 6b65         The worke
-000132e0: 7220 746f 2061 7373 6967 6e20 7468 6520  r to assign the 
-000132f0: 7461 736b 2074 6f2e 2049 6620 7468 6572  task to. If ther
-00013300: 6520 6172 6520 6e6f 2069 646c 6520 776f  e are no idle wo
-00013310: 726b 6572 732c 2072 6574 7572 6e73 0a20  rkers, returns. 
-00013320: 2020 2020 2020 2020 2020 204e 6f6e 652c             None,
-00013330: 2069 6e20 7768 6963 6820 6361 7365 2074   in which case t
-00013340: 6865 2074 6173 6b20 7368 6f75 6c64 2062  he task should b
-00013350: 6520 7472 616e 7369 7469 6f6e 6564 2074  e transitioned t
-00013360: 6f20 6060 7175 6575 6564 6060 2e0a 0a20  o ``queued``... 
-00013370: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00013380: 2020 2069 6620 7365 6c66 2e76 616c 6964     if self.valid
-00013390: 6174 653a 0a20 2020 2020 2020 2020 2020  ate:.           
-000133a0: 2023 2057 6520 646f 6e27 7420 6061 7373   # We don't `ass
-000133b0: 6572 7420 7365 6c66 2e69 735f 726f 6f74  ert self.is_root
-000133c0: 6973 6828 7473 2960 2068 6572 652c 2062  ish(ts)` here, b
-000133d0: 6563 6175 7365 2074 6861 7420 6368 6563  ecause that chec
-000133e0: 6b20 6973 0a20 2020 2020 2020 2020 2020  k is.           
-000133f0: 2023 2064 6570 656e 6465 6e74 206f 6e20   # dependent on 
-00013400: 636c 7573 7465 7220 7369 7a65 2e20 4974  cluster size. It
-00013410: 2773 2070 6f73 7369 626c 6520 6120 7461  's possible a ta
-00013420: 736b 206c 6f6f 6b65 6420 726f 6f74 2d69  sk looked root-i
-00013430: 7368 2077 6865 6e20 6974 0a20 2020 2020  sh when it.     
-00013440: 2020 2020 2020 2023 2077 6173 2071 7565         # was que
-00013450: 7565 642c 2062 7574 2074 6865 2063 6c75  ued, but the clu
-00013460: 7374 6572 2068 6173 2073 696e 6365 2073  ster has since s
-00013470: 6361 6c65 6420 7570 2061 6e64 2069 7420  caled up and it 
-00013480: 6e6f 206c 6f6e 6765 7220 646f 6573 2077  no longer does w
-00013490: 6865 6e0a 2020 2020 2020 2020 2020 2020  hen.            
-000134a0: 2320 636f 6d69 6e67 206f 7574 206f 6620  # coming out of 
-000134b0: 7468 6520 7175 6575 652e 2049 6620 6069  the queue. If `i
-000134c0: 735f 726f 6f74 6973 6860 2063 6861 6e67  s_rootish` chang
-000134d0: 6573 2074 6f20 6120 7374 6174 6963 2064  es to a static d
-000134e0: 6566 696e 6974 696f 6e2c 0a20 2020 2020  efinition,.     
-000134f0: 2020 2020 2020 2023 2074 6865 6e20 6164         # then ad
-00013500: 6420 7468 6174 2061 7373 6572 7469 6f6e  d that assertion
-00013510: 2068 6572 6520 2861 6e64 2061 6374 7561   here (and actua
-00013520: 6c6c 7920 7061 7373 2069 6e20 7468 6520  lly pass in the 
-00013530: 7461 736b 292e 0a20 2020 2020 2020 2020  task)..         
-00013540: 2020 2061 7373 6572 7420 6e6f 7420 6d61     assert not ma
-00013550: 7468 2e69 7369 6e66 2873 656c 662e 574f  th.isinf(self.WO
-00013560: 524b 4552 5f53 4154 5552 4154 494f 4e29  RKER_SATURATION)
-00013570: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
-00013580: 2073 656c 662e 6964 6c65 5f74 6173 6b5f   self.idle_task_
-00013590: 636f 756e 743a 0a20 2020 2020 2020 2020  count:.         
-000135a0: 2020 2023 2041 6c6c 2077 6f72 6b65 7273     # All workers
-000135b0: 2062 7573 793f 2054 6173 6b20 6765 7473   busy? Task gets
-000135c0: 2f73 7461 7973 2071 7565 7565 642e 0a20  /stays queued.. 
-000135d0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-000135e0: 6e20 4e6f 6e65 0a0a 2020 2020 2020 2020  n None..        
-000135f0: 2320 4a75 7374 2070 6963 6b20 7468 6520  # Just pick the 
-00013600: 6c65 6173 7420 6275 7379 2077 6f72 6b65  least busy worke
-00013610: 722e 0a20 2020 2020 2020 2023 204e 4f54  r..        # NOT
-00013620: 453a 2074 6869 7320 7769 6c6c 206c 6561  E: this will lea
-00013630: 6420 746f 2077 6f72 7374 2d63 6173 6520  d to worst-case 
-00013640: 7363 6865 6475 6c69 6e67 2077 6974 6820  scheduling with 
-00013650: 7265 6761 7264 7320 746f 2063 6f2d 6173  regards to co-as
-00013660: 7369 676e 6d65 6e74 2e0a 2020 2020 2020  signment..      
-00013670: 2020 7773 203d 206d 696e 280a 2020 2020    ws = min(.    
-00013680: 2020 2020 2020 2020 7365 6c66 2e69 646c          self.idl
-00013690: 655f 7461 736b 5f63 6f75 6e74 2c0a 2020  e_task_count,.  
-000136a0: 2020 2020 2020 2020 2020 6b65 793d 6c61            key=la
-000136b0: 6d62 6461 2077 733a 206c 656e 2877 732e  mbda ws: len(ws.
-000136c0: 7072 6f63 6573 7369 6e67 2920 2f20 7773  processing) / ws
-000136d0: 2e6e 7468 7265 6164 732c 0a20 2020 2020  .nthreads,.     
-000136e0: 2020 2029 0a20 2020 2020 2020 2069 6620     ).        if 
-000136f0: 7365 6c66 2e76 616c 6964 6174 653a 0a20  self.validate:. 
-00013700: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00013710: 7420 7365 6c66 2e77 6f72 6b65 7273 2e67  t self.workers.g
-00013720: 6574 2877 732e 6164 6472 6573 7329 2069  et(ws.address) i
-00013730: 7320 7773 0a20 2020 2020 2020 2020 2020  s ws.           
-00013740: 2061 7373 6572 7420 6e6f 7420 5f77 6f72   assert not _wor
-00013750: 6b65 725f 6675 6c6c 2877 732c 2073 656c  ker_full(ws, sel
-00013760: 662e 574f 524b 4552 5f53 4154 5552 4154  f.WORKER_SATURAT
-00013770: 494f 4e29 2c20 280a 2020 2020 2020 2020  ION), (.        
-00013780: 2020 2020 2020 2020 7773 2c0a 2020 2020          ws,.    
-00013790: 2020 2020 2020 2020 2020 2020 5f74 6173              _tas
-000137a0: 6b5f 736c 6f74 735f 6176 6169 6c61 626c  k_slots_availabl
-000137b0: 6528 7773 2c20 7365 6c66 2e57 4f52 4b45  e(ws, self.WORKE
-000137c0: 525f 5341 5455 5241 5449 4f4e 292c 0a20  R_SATURATION),. 
-000137d0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-000137e0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-000137f0: 7773 2069 6e20 7365 6c66 2e72 756e 6e69  ws in self.runni
-00013800: 6e67 2c20 2877 732c 2073 656c 662e 7275  ng, (ws, self.ru
-00013810: 6e6e 696e 6729 0a0a 2020 2020 2020 2020  nning)..        
-00013820: 7265 7475 726e 2077 730a 0a20 2020 2064  return ws..    d
-00013830: 6566 2064 6563 6964 655f 776f 726b 6572  ef decide_worker
-00013840: 5f6e 6f6e 5f72 6f6f 7469 7368 2873 656c  _non_rootish(sel
-00013850: 662c 2074 733a 2054 6173 6b53 7461 7465  f, ts: TaskState
-00013860: 2920 2d3e 2057 6f72 6b65 7253 7461 7465  ) -> WorkerState
-00013870: 207c 204e 6f6e 653a 0a20 2020 2020 2020   | None:.       
-00013880: 2022 2222 5069 636b 2061 2077 6f72 6b65   """Pick a worke
-00013890: 7220 666f 7220 6120 7275 6e6e 6162 6c65  r for a runnable
-000138a0: 206e 6f6e 2d72 6f6f 7420 7461 736b 2c20   non-root task, 
-000138b0: 636f 6e73 6964 6572 696e 6720 6465 7065  considering depe
-000138c0: 6e64 656e 6369 6573 2061 6e64 0a20 2020  ndencies and.   
-000138d0: 2020 2020 2072 6573 7472 6963 7469 6f6e       restriction
-000138e0: 732e 0a0a 2020 2020 2020 2020 4f75 7420  s...        Out 
-000138f0: 6f66 2065 6c69 6769 626c 6520 776f 726b  of eligible work
-00013900: 6572 7320 686f 6c64 696e 6720 6465 7065  ers holding depe
-00013910: 6e64 656e 6369 6573 206f 6620 6060 7473  ndencies of ``ts
-00013920: 6060 2c20 7365 6c65 6374 7320 7468 6520  ``, selects the 
-00013930: 776f 726b 6572 0a20 2020 2020 2020 2077  worker.        w
-00013940: 6865 7265 2c20 636f 6e73 6964 6572 696e  here, considerin
-00013950: 6720 776f 726b 6572 2062 6163 6b6c 6f67  g worker backlog
-00013960: 2061 6e64 2064 6174 612d 7472 616e 7366   and data-transf
-00013970: 6572 2063 6f73 7473 2c20 7468 6520 7461  er costs, the ta
-00013980: 736b 2069 730a 2020 2020 2020 2020 6573  sk is.        es
-00013990: 7469 6d61 7465 6420 746f 2073 7461 7274  timated to start
-000139a0: 2072 756e 6e69 6e67 2074 6865 2073 6f6f   running the soo
-000139b0: 6e65 7374 2e0a 0a20 2020 2020 2020 2052  nest...        R
-000139c0: 6574 7572 6e73 0a20 2020 2020 2020 202d  eturns.        -
-000139d0: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2077  ------.        w
-000139e0: 733a 2057 6f72 6b65 7253 7461 7465 207c  s: WorkerState |
-000139f0: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
-00013a00: 2020 5468 6520 776f 726b 6572 2074 6f20    The worker to 
-00013a10: 6173 7369 676e 2074 6865 2074 6173 6b20  assign the task 
-00013a20: 746f 2e20 4966 206e 6f20 776f 726b 6572  to. If no worker
-00013a30: 7320 7361 7469 7366 7920 7468 6520 7265  s satisfy the re
-00013a40: 7374 7269 6374 696f 6e73 206f 660a 2020  strictions of.  
-00013a50: 2020 2020 2020 2020 2020 6060 7473 6060            ``ts``
-00013a60: 206f 7220 7468 6572 6520 6172 6520 6e6f   or there are no
-00013a70: 2072 756e 6e69 6e67 2077 6f72 6b65 7273   running workers
-00013a80: 2c20 7265 7475 726e 7320 4e6f 6e65 2c20  , returns None, 
-00013a90: 696e 2077 6869 6368 2063 6173 6520 7468  in which case th
-00013aa0: 6520 7461 736b 0a20 2020 2020 2020 2020  e task.         
-00013ab0: 2020 2073 686f 756c 6420 6265 2074 7261     should be tra
-00013ac0: 6e73 6974 696f 6e65 6420 746f 2060 606e  nsitioned to ``n
-00013ad0: 6f2d 776f 726b 6572 6060 2e0a 2020 2020  o-worker``..    
-00013ae0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00013af0: 6966 206e 6f74 2073 656c 662e 7275 6e6e  if not self.runn
-00013b00: 696e 673a 0a20 2020 2020 2020 2020 2020  ing:.           
-00013b10: 2072 6574 7572 6e20 4e6f 6e65 0a0a 2020   return None..  
-00013b20: 2020 2020 2020 7661 6c69 645f 776f 726b        valid_work
-00013b30: 6572 7320 3d20 7365 6c66 2e76 616c 6964  ers = self.valid
-00013b40: 5f77 6f72 6b65 7273 2874 7329 0a20 2020  _workers(ts).   
-00013b50: 2020 2020 2069 6620 7661 6c69 645f 776f       if valid_wo
-00013b60: 726b 6572 7320 6973 204e 6f6e 6520 616e  rkers is None an
-00013b70: 6420 6c65 6e28 7365 6c66 2e72 756e 6e69  d len(self.runni
-00013b80: 6e67 2920 3c20 6c65 6e28 7365 6c66 2e77  ng) < len(self.w
-00013b90: 6f72 6b65 7273 293a 0a20 2020 2020 2020  orkers):.       
-00013ba0: 2020 2020 2023 2049 6620 7468 6572 6520       # If there 
-00013bb0: 7765 7265 206e 6f20 7265 7374 7269 6374  were no restrict
-00013bc0: 696f 6e73 2c20 6076 616c 6964 5f77 6f72  ions, `valid_wor
-00013bd0: 6b65 7273 2829 6020 6469 646e 2774 2073  kers()` didn't s
-00013be0: 7562 7365 7420 6279 0a20 2020 2020 2020  ubset by.       
-00013bf0: 2020 2020 2023 2060 7275 6e6e 696e 6760       # `running`
-00013c00: 2e0a 2020 2020 2020 2020 2020 2020 7661  ..            va
-00013c10: 6c69 645f 776f 726b 6572 7320 3d20 7365  lid_workers = se
-00013c20: 6c66 2e72 756e 6e69 6e67 0a0a 2020 2020  lf.running..    
-00013c30: 2020 2020 6966 2074 732e 6465 7065 6e64      if ts.depend
-00013c40: 656e 6369 6573 206f 7220 7661 6c69 645f  encies or valid_
-00013c50: 776f 726b 6572 7320 6973 206e 6f74 204e  workers is not N
-00013c60: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00013c70: 2077 7320 3d20 6465 6369 6465 5f77 6f72   ws = decide_wor
-00013c80: 6b65 7228 0a20 2020 2020 2020 2020 2020  ker(.           
-00013c90: 2020 2020 2074 732c 0a20 2020 2020 2020       ts,.       
-00013ca0: 2020 2020 2020 2020 2073 656c 662e 7275           self.ru
-00013cb0: 6e6e 696e 672c 0a20 2020 2020 2020 2020  nning,.         
-00013cc0: 2020 2020 2020 2076 616c 6964 5f77 6f72         valid_wor
-00013cd0: 6b65 7273 2c0a 2020 2020 2020 2020 2020  kers,.          
-00013ce0: 2020 2020 2020 7061 7274 6961 6c28 7365        partial(se
-00013cf0: 6c66 2e77 6f72 6b65 725f 6f62 6a65 6374  lf.worker_object
-00013d00: 6976 652c 2074 7329 2c0a 2020 2020 2020  ive, ts),.      
-00013d10: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00013d20: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00013d30: 2020 2320 544f 444f 2069 6620 6069 735f    # TODO if `is_
-00013d40: 726f 6f74 6973 6860 2077 6f75 6c64 2061  rootish` would a
-00013d50: 6c77 6179 7320 7265 7475 726e 2054 7275  lways return Tru
-00013d60: 6520 666f 7220 7461 736b 7320 7769 7468  e for tasks with
-00013d70: 6f75 740a 2020 2020 2020 2020 2020 2020  out.            
-00013d80: 2320 6465 7065 6e64 656e 6369 6573 2c20  # dependencies, 
-00013d90: 7765 2063 6f75 6c64 2072 656d 6f76 6520  we could remove 
-00013da0: 616c 6c20 7468 6973 206c 6f67 6963 2e20  all this logic. 
-00013db0: 5468 6520 726f 6f74 6973 6820 6173 7369  The rootish assi
-00013dc0: 676e 6d65 6e74 206c 6f67 6963 0a20 2020  gnment logic.   
-00013dd0: 2020 2020 2020 2020 2023 2077 6f75 6c64           # would
-00013de0: 2062 6568 6176 6520 6d6f 7265 206f 7220   behave more or 
-00013df0: 6c65 7373 2074 6865 2073 616d 6520 6173  less the same as
-00013e00: 2074 6869 732c 206d 6179 6265 2077 6974   this, maybe wit
-00013e10: 686f 7574 2067 7561 7261 6e74 6565 640a  hout guaranteed.
-00013e20: 2020 2020 2020 2020 2020 2020 2320 726f              # ro
-00013e30: 756e 642d 726f 6269 6e20 7468 6f75 6768  und-robin though
-00013e40: 3f20 5468 6973 2070 6174 6820 6973 206f  ? This path is o
-00013e50: 6e6c 7920 7265 6163 6861 626c 6520 7768  nly reachable wh
-00013e60: 656e 2060 7473 6020 646f 6573 6e27 7420  en `ts` doesn't 
-00013e70: 6861 7665 0a20 2020 2020 2020 2020 2020  have.           
-00013e80: 2023 2064 6570 656e 6465 6e63 6965 732c   # dependencies,
-00013e90: 2062 7574 2069 7473 2067 726f 7570 2069   but its group i
-00013ea0: 7320 616c 736f 2073 6d61 6c6c 6572 2074  s also smaller t
-00013eb0: 6861 6e20 7468 6520 636c 7573 7465 722e  han the cluster.
-00013ec0: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-00013ed0: 4661 7374 7061 7468 2077 6865 6e20 7468  Fastpath when th
-00013ee0: 6572 6520 6172 6520 6e6f 2072 656c 6174  ere are no relat
-00013ef0: 6564 2074 6173 6b73 206f 7220 7265 7374  ed tasks or rest
-00013f00: 7269 6374 696f 6e73 0a20 2020 2020 2020  rictions.       
-00013f10: 2020 2020 2077 6f72 6b65 725f 706f 6f6c       worker_pool
-00013f20: 203d 2073 656c 662e 6964 6c65 206f 7220   = self.idle or 
-00013f30: 7365 6c66 2e77 6f72 6b65 7273 0a20 2020  self.workers.   
-00013f40: 2020 2020 2020 2020 2023 2046 4958 4d45           # FIXME
-00013f50: 2069 646c 6520 616e 6420 776f 726b 6572   idle and worker
-00013f60: 7320 6172 6520 536f 7274 6564 4469 6374  s are SortedDict
-00013f70: 2773 2064 6563 6c61 7265 6420 6173 2064  's declared as d
-00013f80: 6963 7473 0a20 2020 2020 2020 2020 2020  icts.           
-00013f90: 2023 2020 2020 2020 2062 6563 6175 7365   #       because
-00013fa0: 2073 6f72 7465 6463 6f6e 7461 696e 6572   sortedcontainer
-00013fb0: 7320 6973 206e 6f74 2061 6e6e 6f74 6174  s is not annotat
-00013fc0: 6564 0a20 2020 2020 2020 2020 2020 2077  ed.            w
-00013fd0: 705f 7661 6c73 203d 2063 6173 7428 2253  p_vals = cast("S
-00013fe0: 6571 7565 6e63 655b 576f 726b 6572 5374  equence[WorkerSt
-00013ff0: 6174 655d 222c 2077 6f72 6b65 725f 706f  ate]", worker_po
-00014000: 6f6c 2e76 616c 7565 7328 2929 0a20 2020  ol.values()).   
-00014010: 2020 2020 2020 2020 206e 5f77 6f72 6b65           n_worke
-00014020: 7273 203d 206c 656e 2877 705f 7661 6c73  rs = len(wp_vals
-00014030: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-00014040: 206e 5f77 6f72 6b65 7273 203c 2032 303a   n_workers < 20:
-00014050: 2020 2320 736d 6172 7420 6275 7420 6c69    # smart but li
-00014060: 6e65 6172 2069 6e20 736d 616c 6c20 6361  near in small ca
-00014070: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
-00014080: 2020 2077 7320 3d20 6d69 6e28 7770 5f76     ws = min(wp_v
-00014090: 616c 732c 206b 6579 3d6f 7065 7261 746f  als, key=operato
-000140a0: 722e 6174 7472 6765 7474 6572 2822 6f63  r.attrgetter("oc
-000140b0: 6375 7061 6e63 7922 2929 0a20 2020 2020  cupancy")).     
-000140c0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-000140d0: 7420 7773 0a20 2020 2020 2020 2020 2020  t ws.           
-000140e0: 2020 2020 2069 6620 7773 2e6f 6363 7570       if ws.occup
-000140f0: 616e 6379 203d 3d20 303a 0a20 2020 2020  ancy == 0:.     
-00014100: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00014110: 2073 7065 6369 616c 2063 6173 6520 746f   special case to
-00014120: 2075 7365 2072 6f75 6e64 2d72 6f62 696e   use round-robin
-00014130: 3b20 6c69 6e65 6172 2073 6561 7263 680a  ; linear search.
-00014140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014150: 2020 2020 2320 666f 7220 6e65 7874 2077      # for next w
-00014160: 6f72 6b65 7220 7769 7468 207a 6572 6f20  orker with zero 
-00014170: 6f63 6375 7061 6e63 7920 286f 7220 6a75  occupancy (or ju
-00014180: 7374 0a20 2020 2020 2020 2020 2020 2020  st.             
-00014190: 2020 2020 2020 2023 206c 616e 6420 6261         # land ba
-000141a0: 636b 2077 6865 7265 2077 6520 7374 6172  ck where we star
-000141b0: 7465 6429 2e0a 2020 2020 2020 2020 2020  ted)..          
-000141c0: 2020 2020 2020 2020 2020 7374 6172 7420            start 
-000141d0: 3d20 7365 6c66 2e6e 5f74 6173 6b73 2025  = self.n_tasks %
-000141e0: 206e 5f77 6f72 6b65 7273 0a20 2020 2020   n_workers.     
-000141f0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00014200: 6f72 2069 2069 6e20 7261 6e67 6528 6e5f  or i in range(n_
-00014210: 776f 726b 6572 7329 3a0a 2020 2020 2020  workers):.      
-00014220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014230: 2020 7770 5f69 203d 2077 705f 7661 6c73    wp_i = wp_vals
-00014240: 5b28 6920 2b20 7374 6172 7429 2025 206e  [(i + start) % n
-00014250: 5f77 6f72 6b65 7273 5d0a 2020 2020 2020  _workers].      
-00014260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014270: 2020 6966 2077 705f 692e 6f63 6375 7061    if wp_i.occupa
-00014280: 6e63 7920 3d3d 2030 3a0a 2020 2020 2020  ncy == 0:.      
-00014290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000142a0: 2020 2020 2020 7773 203d 2077 705f 690a        ws = wp_i.
-000142b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000142c0: 2020 2020 2020 2020 2020 2020 6272 6561              brea
-000142d0: 6b0a 2020 2020 2020 2020 2020 2020 656c  k.            el
-000142e0: 7365 3a20 2023 2064 756d 6220 6275 7420  se:  # dumb but 
-000142f0: 6661 7374 2069 6e20 6c61 7267 6520 6361  fast in large ca
-00014300: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
-00014310: 2020 2077 7320 3d20 7770 5f76 616c 735b     ws = wp_vals[
-00014320: 7365 6c66 2e6e 5f74 6173 6b73 2025 206e  self.n_tasks % n
-00014330: 5f77 6f72 6b65 7273 5d0a 0a20 2020 2020  _workers]..     
-00014340: 2020 2069 6620 7365 6c66 2e76 616c 6964     if self.valid
-00014350: 6174 6520 616e 6420 7773 2069 7320 6e6f  ate and ws is no
-00014360: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-00014370: 2020 2020 6173 7365 7274 2073 656c 662e      assert self.
-00014380: 776f 726b 6572 732e 6765 7428 7773 2e61  workers.get(ws.a
-00014390: 6464 7265 7373 2920 6973 2077 730a 2020  ddress) is ws.  
-000143a0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-000143b0: 2077 7320 696e 2073 656c 662e 7275 6e6e   ws in self.runn
-000143c0: 696e 672c 2028 7773 2c20 7365 6c66 2e72  ing, (ws, self.r
-000143d0: 756e 6e69 6e67 290a 0a20 2020 2020 2020  unning)..       
-000143e0: 2072 6574 7572 6e20 7773 0a0a 2020 2020   return ws..    
-000143f0: 6465 6620 5f74 7261 6e73 6974 696f 6e5f  def _transition_
-00014400: 7761 6974 696e 675f 7072 6f63 6573 7369  waiting_processi
-00014410: 6e67 2873 656c 662c 206b 6579 3a20 4b65  ng(self, key: Ke
-00014420: 792c 2073 7469 6d75 6c75 735f 6964 3a20  y, stimulus_id: 
-00014430: 7374 7229 202d 3e20 5265 6373 4d73 6773  str) -> RecsMsgs
-00014440: 3a0a 2020 2020 2020 2020 2222 2250 6f73  :.        """Pos
-00014450: 7369 626c 7920 7363 6865 6475 6c65 2061  sibly schedule a
-00014460: 2072 6561 6479 2074 6173 6b2e 2054 6869   ready task. Thi
-00014470: 7320 6973 2074 6865 2070 7269 6d61 7279  s is the primary
-00014480: 2064 6973 7061 7463 6820 666f 7220 7265   dispatch for re
-00014490: 6164 7920 7461 736b 732e 0a0a 2020 2020  ady tasks...    
-000144a0: 2020 2020 4966 2074 6865 7265 2773 206e      If there's n
-000144b0: 6f20 6170 7072 6f70 7269 6174 6520 776f  o appropriate wo
-000144c0: 726b 6572 2066 6f72 2074 6865 2074 6173  rker for the tas
-000144d0: 6b20 2862 7574 2074 6865 2074 6173 6b20  k (but the task 
-000144e0: 6973 206f 7468 6572 7769 7365 0a20 2020  is otherwise.   
-000144f0: 2020 2020 2072 756e 6e61 626c 6529 2c20       runnable), 
-00014500: 6974 2077 696c 6c20 6265 2072 6563 6f6d  it will be recom
-00014510: 6d65 6e64 6564 2074 6f20 6060 6e6f 2d77  mended to ``no-w
-00014520: 6f72 6b65 7260 6020 6f72 2060 6071 7565  orker`` or ``que
-00014530: 7565 6460 602e 0a20 2020 2020 2020 2022  ued``..        "
-00014540: 2222 0a20 2020 2020 2020 2074 7320 3d20  "".        ts = 
-00014550: 7365 6c66 2e74 6173 6b73 5b6b 6579 5d0a  self.tasks[key].
-00014560: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00014570: 2e69 735f 726f 6f74 6973 6828 7473 293a  .is_rootish(ts):
-00014580: 0a20 2020 2020 2020 2020 2020 2023 204e  .            # N
-00014590: 4f54 453a 2068 6176 696e 6720 7477 6f20  OTE: having two 
-000145a0: 726f 6f74 2d69 7368 206d 6574 686f 6473  root-ish methods
-000145b0: 2069 7320 7465 6d70 6f72 6172 792e 2057   is temporary. W
-000145c0: 6865 6e20 7468 6520 6665 6174 7572 6520  hen the feature 
-000145d0: 666c 6167 2069 730a 2020 2020 2020 2020  flag is.        
-000145e0: 2020 2020 2320 7265 6d6f 7665 642c 2074      # removed, t
-000145f0: 6865 7265 2073 686f 756c 6420 6f6e 6c79  here should only
-00014600: 2062 6520 6f6e 652c 2077 6869 6368 2063   be one, which c
-00014610: 6f6d 6269 6e65 7320 636f 2d61 7373 6967  ombines co-assig
-00014620: 6e6d 656e 7420 616e 640a 2020 2020 2020  nment and.      
-00014630: 2020 2020 2020 2320 7175 6575 696e 672e        # queuing.
-00014640: 2045 7665 6e74 7561 6c6c 792c 2073 7065   Eventually, spe
-00014650: 6369 616c 2d63 6173 696e 6720 726f 6f74  cial-casing root
-00014660: 2074 6173 6b73 206d 6967 6874 2062 6520   tasks might be 
-00014670: 7265 6d6f 7665 6420 656e 7469 7265 6c79  removed entirely
-00014680: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00014690: 7769 7468 2062 6574 7465 7220 6865 7572  with better heur
-000146a0: 6973 7469 6373 2e0a 2020 2020 2020 2020  istics..        
-000146b0: 2020 2020 6966 206d 6174 682e 6973 696e      if math.isin
-000146c0: 6628 7365 6c66 2e57 4f52 4b45 525f 5341  f(self.WORKER_SA
-000146d0: 5455 5241 5449 4f4e 293a 0a20 2020 2020  TURATION):.     
-000146e0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-000146f0: 7420 2877 7320 3a3d 2073 656c 662e 6465  t (ws := self.de
-00014700: 6369 6465 5f77 6f72 6b65 725f 726f 6f74  cide_worker_root
-00014710: 6973 685f 7175 6575 696e 675f 6469 7361  ish_queuing_disa
-00014720: 626c 6564 2874 7329 293a 0a20 2020 2020  bled(ts)):.     
-00014730: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00014740: 6574 7572 6e20 7b74 732e 6b65 793a 2022  eturn {ts.key: "
-00014750: 6e6f 2d77 6f72 6b65 7222 7d2c 207b 7d2c  no-worker"}, {},
-00014760: 207b 7d0a 2020 2020 2020 2020 2020 2020   {}.            
-00014770: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00014780: 2020 2020 2020 6966 206e 6f74 2028 7773        if not (ws
-00014790: 203a 3d20 7365 6c66 2e64 6563 6964 655f   := self.decide_
-000147a0: 776f 726b 6572 5f72 6f6f 7469 7368 5f71  worker_rootish_q
-000147b0: 7565 7569 6e67 5f65 6e61 626c 6564 2829  ueuing_enabled()
-000147c0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-000147d0: 2020 2020 2020 2072 6574 7572 6e20 7b74         return {t
-000147e0: 732e 6b65 793a 2022 7175 6575 6564 227d  s.key: "queued"}
-000147f0: 2c20 7b7d 2c20 7b7d 0a20 2020 2020 2020  , {}, {}.       
-00014800: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00014810: 2020 2069 6620 6e6f 7420 2877 7320 3a3d     if not (ws :=
-00014820: 2073 656c 662e 6465 6369 6465 5f77 6f72   self.decide_wor
-00014830: 6b65 725f 6e6f 6e5f 726f 6f74 6973 6828  ker_non_rootish(
-00014840: 7473 2929 3a0a 2020 2020 2020 2020 2020  ts)):.          
-00014850: 2020 2020 2020 7265 7475 726e 207b 7473        return {ts
-00014860: 2e6b 6579 3a20 226e 6f2d 776f 726b 6572  .key: "no-worker
-00014870: 227d 2c20 7b7d 2c20 7b7d 0a0a 2020 2020  "}, {}, {}..    
-00014880: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-00014890: 5f61 6464 5f74 6f5f 7072 6f63 6573 7369  _add_to_processi
-000148a0: 6e67 2874 732c 2077 732c 2073 7469 6d75  ng(ts, ws, stimu
-000148b0: 6c75 735f 6964 3d73 7469 6d75 6c75 735f  lus_id=stimulus_
-000148c0: 6964 290a 0a20 2020 2064 6566 205f 7472  id)..    def _tr
-000148d0: 616e 7369 7469 6f6e 5f77 6169 7469 6e67  ansition_waiting
-000148e0: 5f6d 656d 6f72 7928 0a20 2020 2020 2020  _memory(.       
-000148f0: 2073 656c 662c 0a20 2020 2020 2020 206b   self,.        k
-00014900: 6579 3a20 4b65 792c 0a20 2020 2020 2020  ey: Key,.       
-00014910: 2073 7469 6d75 6c75 735f 6964 3a20 7374   stimulus_id: st
-00014920: 722c 0a20 2020 2020 2020 202a 2c0a 2020  r,.        *,.  
-00014930: 2020 2020 2020 6e62 7974 6573 3a20 696e        nbytes: in
-00014940: 7420 7c20 4e6f 6e65 203d 204e 6f6e 652c  t | None = None,
-00014950: 0a20 2020 2020 2020 2074 7970 653a 2062  .        type: b
-00014960: 7974 6573 207c 204e 6f6e 6520 3d20 4e6f  ytes | None = No
-00014970: 6e65 2c0a 2020 2020 2020 2020 7479 7065  ne,.        type
-00014980: 6e61 6d65 3a20 7374 7220 7c20 4e6f 6e65  name: str | None
-00014990: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-000149a0: 2077 6f72 6b65 723a 2073 7472 2c0a 2020   worker: str,.  
-000149b0: 2020 2020 2020 2a2a 6b77 6172 6773 3a20        **kwargs: 
-000149c0: 416e 792c 0a20 2020 2029 202d 3e20 5265  Any,.    ) -> Re
-000149d0: 6373 4d73 6773 3a0a 2020 2020 2020 2020  csMsgs:.        
-000149e0: 2222 2254 6869 7320 7472 616e 7369 7469  """This transiti
-000149f0: 6f6e 2065 7863 6c75 7369 7665 6c79 2068  on exclusively h
-00014a00: 6170 7065 6e73 2069 6e20 6120 7261 6365  appens in a race
-00014a10: 2063 6f6e 6469 7469 6f6e 2077 6865 7265   condition where
-00014a20: 2074 6865 2073 6368 6564 756c 6572 0a20   the scheduler. 
-00014a30: 2020 2020 2020 2062 656c 6965 7665 7320         believes 
-00014a40: 7468 6174 2074 6865 206f 6e6c 7920 636f  that the only co
-00014a50: 7079 206f 6620 6120 6465 7065 6e64 656e  py of a dependen
-00014a60: 6379 2074 6173 6b20 6861 7320 6a75 7374  cy task has just
-00014a70: 2062 6565 6e20 6c6f 7374 2c20 736f 2069   been lost, so i
-00014a80: 740a 2020 2020 2020 2020 7472 616e 7369  t.        transi
-00014a90: 7469 6f6e 7320 616c 6c20 6465 7065 6e64  tions all depend
-00014aa0: 656e 7473 2062 6163 6b20 746f 2077 6169  ents back to wai
-00014ab0: 7469 6e67 2c20 6275 7420 6163 7475 616c  ting, but actual
-00014ac0: 6c79 2061 2072 6570 6c69 6361 2068 6173  ly a replica has
-00014ad0: 2061 6c72 6561 6479 0a20 2020 2020 2020   already.       
-00014ae0: 2062 6565 6e20 6163 7175 6972 6564 2062   been acquired b
-00014af0: 7920 6120 776f 726b 6572 2063 6f6d 7075  y a worker compu
-00014b00: 7469 6e67 2074 6865 2064 6570 656e 6465  ting the depende
-00014b10: 6e63 7920 2d20 7468 6520 7363 6865 6475  ncy - the schedu
-00014b20: 6c65 7220 6a75 7374 2064 6f65 736e 2774  ler just doesn't
-00014b30: 0a20 2020 2020 2020 206b 6e6f 7720 7965  .        know ye
-00014b40: 7420 2d20 616e 6420 7468 6520 6578 6563  t - and the exec
-00014b50: 7574 696f 6e20 6669 6e69 7368 6573 2062  ution finishes b
-00014b60: 6566 6f72 6520 7468 6520 6361 6e63 656c  efore the cancel
-00014b70: 6c61 7469 6f6e 206d 6573 7361 6765 2066  lation message f
-00014b80: 726f 6d20 7468 650a 2020 2020 2020 2020  rom the.        
-00014b90: 7363 6865 6475 6c65 7220 6861 7320 6120  scheduler has a 
-00014ba0: 6368 616e 6365 2074 6f20 7265 6163 6820  chance to reach 
-00014bb0: 7468 6520 776f 726b 6572 2e20 5368 6f72  the worker. Shor
-00014bc0: 746c 792c 2074 6865 2063 616e 6365 6c6c  tly, the cancell
-00014bd0: 6174 696f 6e20 7265 7175 6573 740a 2020  ation request.  
-00014be0: 2020 2020 2020 7769 6c6c 2072 6561 6368        will reach
-00014bf0: 2074 6865 2077 6f72 6b65 722c 2074 6875   the worker, thu
-00014c00: 7320 6465 6c65 7469 6e67 2074 6865 2064  s deleting the d
-00014c10: 6174 6120 6672 6f6d 206d 656d 6f72 792e  ata from memory.
-00014c20: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00014c30: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
-00014c40: 6173 6b73 5b6b 6579 5d0a 0a20 2020 2020  asks[key]..     
-00014c50: 2020 2069 6620 7365 6c66 2e76 616c 6964     if self.valid
-00014c60: 6174 653a 0a20 2020 2020 2020 2020 2020  ate:.           
-00014c70: 2061 7373 6572 7420 6e6f 7420 7473 2e70   assert not ts.p
-00014c80: 726f 6365 7373 696e 675f 6f6e 0a20 2020  rocessing_on.   
-00014c90: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00014ca0: 7473 2e77 6169 7469 6e67 5f6f 6e0a 2020  ts.waiting_on.  
-00014cb0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00014cc0: 2074 732e 7374 6174 6520 3d3d 2022 7761   ts.state == "wa
-00014cd0: 6974 696e 6722 0a0a 2020 2020 2020 2020  iting"..        
-00014ce0: 7265 7475 726e 207b 7d2c 207b 7d2c 207b  return {}, {}, {
-00014cf0: 7d0a 0a20 2020 2064 6566 205f 7472 616e  }..    def _tran
-00014d00: 7369 7469 6f6e 5f70 726f 6365 7373 696e  sition_processin
-00014d10: 675f 6d65 6d6f 7279 280a 2020 2020 2020  g_memory(.      
-00014d20: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-00014d30: 6b65 793a 204b 6579 2c0a 2020 2020 2020  key: Key,.      
-00014d40: 2020 7374 696d 756c 7573 5f69 643a 2073    stimulus_id: s
-00014d50: 7472 2c0a 2020 2020 2020 2020 2a2c 0a20  tr,.        *,. 
-00014d60: 2020 2020 2020 206e 6279 7465 733a 2069         nbytes: i
-00014d70: 6e74 207c 204e 6f6e 6520 3d20 4e6f 6e65  nt | None = None
-00014d80: 2c0a 2020 2020 2020 2020 7479 7065 3a20  ,.        type: 
-00014d90: 6279 7465 7320 7c20 4e6f 6e65 203d 204e  bytes | None = N
-00014da0: 6f6e 652c 0a20 2020 2020 2020 2074 7970  one,.        typ
-00014db0: 656e 616d 653a 2073 7472 207c 204e 6f6e  ename: str | Non
-00014dc0: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
-00014dd0: 2020 776f 726b 6572 3a20 7374 722c 0a20    worker: str,. 
-00014de0: 2020 2020 2020 2073 7461 7274 7374 6f70         startstop
-00014df0: 733a 206c 6973 745b 6469 6374 5d20 7c20  s: list[dict] | 
-00014e00: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
-00014e10: 2020 2020 202a 2a6b 7761 7267 733a 2041       **kwargs: A
-00014e20: 6e79 2c0a 2020 2020 2920 2d3e 2052 6563  ny,.    ) -> Rec
-00014e30: 734d 7367 733a 0a20 2020 2020 2020 2074  sMsgs:.        t
-00014e40: 7320 3d20 7365 6c66 2e74 6173 6b73 5b6b  s = self.tasks[k
-00014e50: 6579 5d0a 0a20 2020 2020 2020 2061 7373  ey]..        ass
-00014e60: 6572 7420 776f 726b 6572 0a20 2020 2020  ert worker.     
-00014e70: 2020 2061 7373 6572 7420 6973 696e 7374     assert isinst
-00014e80: 616e 6365 2877 6f72 6b65 722c 2073 7472  ance(worker, str
-00014e90: 290a 0a20 2020 2020 2020 2069 6620 7365  )..        if se
-00014ea0: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
-00014eb0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00014ec0: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
-00014ed0: 0a20 2020 2020 2020 2020 2020 2077 7373  .            wss
-00014ee0: 203d 2074 732e 7072 6f63 6573 7369 6e67   = ts.processing
-00014ef0: 5f6f 6e0a 2020 2020 2020 2020 2020 2020  _on.            
-00014f00: 6173 7365 7274 2077 7373 0a20 2020 2020  assert wss.     
-00014f10: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
-00014f20: 2069 6e20 7773 732e 7072 6f63 6573 7369   in wss.processi
-00014f30: 6e67 0a20 2020 2020 2020 2020 2020 2064  ng.            d
-00014f40: 656c 2077 7373 0a20 2020 2020 2020 2020  el wss.         
-00014f50: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
-00014f60: 2e77 6169 7469 6e67 5f6f 6e0a 2020 2020  .waiting_on.    
-00014f70: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
-00014f80: 6f74 2074 732e 7768 6f5f 6861 732c 2028  ot ts.who_has, (
-00014f90: 7473 2c20 7473 2e77 686f 5f68 6173 290a  ts, ts.who_has).
-00014fa0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00014fb0: 7274 206e 6f74 2074 732e 6578 6365 7074  rt not ts.except
-00014fc0: 696f 6e5f 626c 616d 650a 2020 2020 2020  ion_blame.      
-00014fd0: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
-00014fe0: 7374 6174 6520 3d3d 2022 7072 6f63 6573  state == "proces
-00014ff0: 7369 6e67 220a 0a20 2020 2020 2020 2077  sing"..        w
-00015000: 7320 3d20 7365 6c66 2e77 6f72 6b65 7273  s = self.workers
-00015010: 2e67 6574 2877 6f72 6b65 7229 0a20 2020  .get(worker).   
-00015020: 2020 2020 2069 6620 7773 2069 7320 4e6f       if ws is No
-00015030: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00015040: 7265 7475 726e 207b 6b65 793a 2022 7265  return {key: "re
-00015050: 6c65 6173 6564 227d 2c20 7b7d 2c20 7b7d  leased"}, {}, {}
-00015060: 0a0a 2020 2020 2020 2020 6966 2077 7320  ..        if ws 
-00015070: 213d 2074 732e 7072 6f63 6573 7369 6e67  != ts.processing
-00015080: 5f6f 6e3a 2020 2320 7072 6167 6d61 3a20  _on:  # pragma: 
-00015090: 6e6f 636f 7665 720a 2020 2020 2020 2020  nocover.        
-000150a0: 2020 2020 6173 7365 7274 2074 732e 7072      assert ts.pr
-000150b0: 6f63 6573 7369 6e67 5f6f 6e0a 2020 2020  ocessing_on.    
-000150c0: 2020 2020 2020 2020 7261 6973 6520 5275          raise Ru
-000150d0: 6e74 696d 6545 7272 6f72 280a 2020 2020  ntimeError(.    
-000150e0: 2020 2020 2020 2020 2020 2020 6622 5461              f"Ta
-000150f0: 736b 207b 7473 2e6b 6579 2172 7d20 7472  sk {ts.key!r} tr
-00015100: 616e 7369 7469 6f6e 6564 2066 726f 6d20  ansitioned from 
-00015110: 7072 6f63 6573 7369 6e67 2074 6f20 6d65  processing to me
-00015120: 6d6f 7279 206f 6e20 776f 726b 6572 2022  mory on worker "
-00015130: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015140: 2066 227b 7773 7d2c 2077 6869 6c65 2069   f"{ws}, while i
-00015150: 7420 7761 7320 6578 7065 6374 6564 2066  t was expected f
-00015160: 726f 6d20 7b74 732e 7072 6f63 6573 7369  rom {ts.processi
-00015170: 6e67 5f6f 6e7d 2e20 5468 6973 2073 686f  ng_on}. This sho
-00015180: 756c 6420 220a 2020 2020 2020 2020 2020  uld ".          
-00015190: 2020 2020 2020 6622 6265 2069 6d70 6f73        f"be impos
-000151a0: 7369 626c 652e 207b 7374 696d 756c 7573  sible. {stimulus
-000151b0: 5f69 643d 7d2c 2073 746f 7279 3d7b 7365  _id=}, story={se
-000151c0: 6c66 2e73 746f 7279 2874 7329 7d22 0a20  lf.story(ts)}". 
-000151d0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-000151e0: 2020 2020 2020 2323 2323 2323 2323 2323        ##########
-000151f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00015200: 2323 230a 2020 2020 2020 2020 2320 5570  ###.        # Up
-00015210: 6461 7465 2054 696d 696e 6720 496e 666f  date Timing Info
-00015220: 726d 6174 696f 6e20 230a 2020 2020 2020  rmation #.      
-00015230: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
-00015240: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
-00015250: 2020 2020 2020 2020 6966 2073 7461 7274          if start
-00015260: 7374 6f70 733a 0a20 2020 2020 2020 2020  stops:.         
-00015270: 2020 2066 6f72 2073 7461 7274 7374 6f70     for startstop
-00015280: 2069 6e20 7374 6172 7473 746f 7073 3a0a   in startstops:.
-00015290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000152a0: 7473 2e67 726f 7570 2e61 6464 5f64 7572  ts.group.add_dur
-000152b0: 6174 696f 6e28 0a20 2020 2020 2020 2020  ation(.         
-000152c0: 2020 2020 2020 2020 2020 2073 746f 703d             stop=
-000152d0: 7374 6172 7473 746f 705b 2273 746f 7022  startstop["stop"
-000152e0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-000152f0: 2020 2020 2020 2073 7461 7274 3d73 7461         start=sta
-00015300: 7274 7374 6f70 5b22 7374 6172 7422 5d2c  rtstop["start"],
-00015310: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015320: 2020 2020 2061 6374 696f 6e3d 7374 6172       action=star
-00015330: 7473 746f 705b 2261 6374 696f 6e22 5d2c  tstop["action"],
-00015340: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015350: 2029 0a0a 2020 2020 2020 2020 7320 3d20   )..        s = 
-00015360: 7365 6c66 2e75 6e6b 6e6f 776e 5f64 7572  self.unknown_dur
-00015370: 6174 696f 6e73 2e70 6f70 2874 732e 7072  ations.pop(ts.pr
-00015380: 6566 6978 2e6e 616d 652c 2073 6574 2829  efix.name, set()
-00015390: 290a 2020 2020 2020 2020 7374 6561 6c20  ).        steal 
-000153a0: 3d20 7365 6c66 2e65 7874 656e 7369 6f6e  = self.extension
-000153b0: 732e 6765 7428 2273 7465 616c 696e 6722  s.get("stealing"
-000153c0: 290a 2020 2020 2020 2020 6966 2073 7465  ).        if ste
-000153d0: 616c 3a0a 2020 2020 2020 2020 2020 2020  al:.            
-000153e0: 666f 7220 7474 7320 696e 2073 3a0a 2020  for tts in s:.  
-000153f0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00015400: 2074 7473 2e70 726f 6365 7373 696e 675f   tts.processing_
-00015410: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
-00015420: 2020 2020 2020 2020 7374 6561 6c2e 7265          steal.re
-00015430: 6361 6c63 756c 6174 655f 636f 7374 2874  calculate_cost(t
-00015440: 7473 290a 0a20 2020 2020 2020 2023 2323  ts)..        ###
-00015450: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00015460: 2323 2323 2323 2323 230a 2020 2020 2020  #########.      
-00015470: 2020 2320 5570 6461 7465 2053 7461 7465    # Update State
-00015480: 2049 6e66 6f72 6d61 7469 6f6e 2023 0a20   Information #. 
-00015490: 2020 2020 2020 2023 2323 2323 2323 2323         #########
-000154a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000154b0: 2323 230a 2020 2020 2020 2020 6966 206e  ###.        if n
-000154c0: 6279 7465 7320 6973 206e 6f74 204e 6f6e  bytes is not Non
-000154d0: 653a 0a20 2020 2020 2020 2020 2020 2074  e:.            t
-000154e0: 732e 7365 745f 6e62 7974 6573 286e 6279  s.set_nbytes(nby
-000154f0: 7465 7329 0a0a 2020 2020 2020 2020 7365  tes)..        se
-00015500: 6c66 2e5f 6578 6974 5f70 726f 6365 7373  lf._exit_process
-00015510: 696e 675f 636f 6d6d 6f6e 2874 7329 0a0a  ing_common(ts)..
-00015520: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
-00015530: 6461 7469 6f6e 733a 2052 6563 7320 3d20  dations: Recs = 
-00015540: 7b7d 0a20 2020 2020 2020 2063 6c69 656e  {}.        clien
-00015550: 745f 6d73 6773 3a20 4d73 6773 203d 207b  t_msgs: Msgs = {
-00015560: 7d0a 2020 2020 2020 2020 7365 6c66 2e5f  }.        self._
-00015570: 6164 645f 746f 5f6d 656d 6f72 7928 0a20  add_to_memory(. 
-00015580: 2020 2020 2020 2020 2020 2074 732c 2077             ts, w
-00015590: 732c 2072 6563 6f6d 6d65 6e64 6174 696f  s, recommendatio
-000155a0: 6e73 2c20 636c 6965 6e74 5f6d 7367 732c  ns, client_msgs,
-000155b0: 2074 7970 653d 7479 7065 2c20 7479 7065   type=type, type
-000155c0: 6e61 6d65 3d74 7970 656e 616d 650a 2020  name=typename.  
-000155d0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-000155e0: 2069 6620 7365 6c66 2e76 616c 6964 6174   if self.validat
-000155f0: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
-00015600: 7373 6572 7420 6e6f 7420 7473 2e70 726f  ssert not ts.pro
-00015610: 6365 7373 696e 675f 6f6e 0a20 2020 2020  cessing_on.     
-00015620: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
-00015630: 7420 7473 2e77 6169 7469 6e67 5f6f 6e0a  t ts.waiting_on.
-00015640: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00015650: 7265 636f 6d6d 656e 6461 7469 6f6e 732c  recommendations,
-00015660: 2063 6c69 656e 745f 6d73 6773 2c20 7b7d   client_msgs, {}
-00015670: 0a0a 2020 2020 6465 6620 5f74 7261 6e73  ..    def _trans
-00015680: 6974 696f 6e5f 6d65 6d6f 7279 5f72 656c  ition_memory_rel
-00015690: 6561 7365 6428 0a20 2020 2020 2020 2073  eased(.        s
-000156a0: 656c 662c 206b 6579 3a20 4b65 792c 2073  elf, key: Key, s
-000156b0: 7469 6d75 6c75 735f 6964 3a20 7374 722c  timulus_id: str,
-000156c0: 202a 2c20 7361 6665 3a20 626f 6f6c 203d   *, safe: bool =
-000156d0: 2046 616c 7365 0a20 2020 2029 202d 3e20   False.    ) -> 
-000156e0: 5265 6373 4d73 6773 3a0a 2020 2020 2020  RecsMsgs:.      
-000156f0: 2020 7473 203d 2073 656c 662e 7461 736b    ts = self.task
-00015700: 735b 6b65 795d 0a0a 2020 2020 2020 2020  s[key]..        
-00015710: 6966 2073 656c 662e 7661 6c69 6461 7465  if self.validate
-00015720: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
-00015730: 7365 7274 206e 6f74 2074 732e 7761 6974  sert not ts.wait
-00015740: 696e 675f 6f6e 0a20 2020 2020 2020 2020  ing_on.         
-00015750: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
-00015760: 2e70 726f 6365 7373 696e 675f 6f6e 0a20  .processing_on. 
-00015770: 2020 2020 2020 2020 2020 2069 6620 7361             if sa
-00015780: 6665 3a0a 2020 2020 2020 2020 2020 2020  fe:.            
-00015790: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
-000157a0: 732e 7761 6974 6572 730a 0a20 2020 2020  s.waiters..     
-000157b0: 2020 2069 6620 7473 2e61 6374 6f72 3a0a     if ts.actor:.
-000157c0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-000157d0: 7773 2069 6e20 7473 2e77 686f 5f68 6173  ws in ts.who_has
-000157e0: 206f 7220 2829 3a0a 2020 2020 2020 2020   or ():.        
-000157f0: 2020 2020 2020 2020 7773 2e61 6374 6f72          ws.actor
-00015800: 732e 6469 7363 6172 6428 7473 290a 2020  s.discard(ts).  
-00015810: 2020 2020 2020 2020 2020 6966 2074 732e            if ts.
-00015820: 7768 6f5f 7761 6e74 733a 0a20 2020 2020  who_wants:.     
-00015830: 2020 2020 2020 2020 2020 2074 732e 6578             ts.ex
-00015840: 6365 7074 696f 6e5f 626c 616d 6520 3d20  ception_blame = 
-00015850: 7473 0a20 2020 2020 2020 2020 2020 2020  ts.             
-00015860: 2020 2074 732e 6578 6365 7074 696f 6e20     ts.exception 
-00015870: 3d20 5365 7269 616c 697a 6564 280a 2020  = Serialized(.  
-00015880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015890: 2020 2a73 6572 6961 6c69 7a65 2856 616c    *serialize(Val
-000158a0: 7565 4572 726f 7228 2257 6f72 6b65 7220  ueError("Worker 
-000158b0: 686f 6c64 696e 6720 4163 746f 7220 7761  holding Actor wa
-000158c0: 7320 6c6f 7374 2229 290a 2020 2020 2020  s lost")).      
-000158d0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-000158e0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-000158f0: 726e 207b 7473 2e6b 6579 3a20 2265 7272  rn {ts.key: "err
-00015900: 6564 227d 2c20 7b7d 2c20 7b7d 2020 2320  ed"}, {}, {}  # 
-00015910: 646f 6e27 7420 7472 7920 746f 2072 6563  don't try to rec
-00015920: 7265 6174 650a 0a20 2020 2020 2020 2072  reate..        r
-00015930: 6563 6f6d 6d65 6e64 6174 696f 6e73 3a20  ecommendations: 
-00015940: 5265 6373 203d 207b 7d0a 2020 2020 2020  Recs = {}.      
-00015950: 2020 636c 6965 6e74 5f6d 7367 733a 204d    client_msgs: M
-00015960: 7367 7320 3d20 7b7d 0a20 2020 2020 2020  sgs = {}.       
-00015970: 2077 6f72 6b65 725f 6d73 6773 3a20 4d73   worker_msgs: Ms
-00015980: 6773 203d 207b 7d0a 0a20 2020 2020 2020  gs = {}..       
-00015990: 2023 2058 5858 2066 6163 746f 7220 7468   # XXX factor th
-000159a0: 6973 206f 7574 3f0a 2020 2020 2020 2020  is out?.        
-000159b0: 776f 726b 6572 5f6d 7367 203d 207b 0a20  worker_msg = {. 
-000159c0: 2020 2020 2020 2020 2020 2022 6f70 223a             "op":
-000159d0: 2022 6672 6565 2d6b 6579 7322 2c0a 2020   "free-keys",.  
-000159e0: 2020 2020 2020 2020 2020 226b 6579 7322            "keys"
-000159f0: 3a20 5b6b 6579 5d2c 0a20 2020 2020 2020  : [key],.       
-00015a00: 2020 2020 2022 7374 696d 756c 7573 5f69       "stimulus_i
-00015a10: 6422 3a20 7374 696d 756c 7573 5f69 642c  d": stimulus_id,
-00015a20: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
-00015a30: 2020 2066 6f72 2077 7320 696e 2074 732e     for ws in ts.
-00015a40: 7768 6f5f 6861 7320 6f72 2028 293a 0a20  who_has or ():. 
-00015a50: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
-00015a60: 725f 6d73 6773 5b77 732e 6164 6472 6573  r_msgs[ws.addres
-00015a70: 735d 203d 205b 776f 726b 6572 5f6d 7367  s] = [worker_msg
-00015a80: 5d0a 2020 2020 2020 2020 7365 6c66 2e72  ].        self.r
-00015a90: 656d 6f76 655f 616c 6c5f 7265 706c 6963  emove_all_replic
-00015aa0: 6173 2874 7329 0a0a 2020 2020 2020 2020  as(ts)..        
-00015ab0: 7473 2e73 7461 7465 203d 2022 7265 6c65  ts.state = "rele
-00015ac0: 6173 6564 220a 0a20 2020 2020 2020 2072  ased"..        r
-00015ad0: 6570 6f72 745f 6d73 6720 3d20 7b22 6f70  eport_msg = {"op
-00015ae0: 223a 2022 6c6f 7374 2d64 6174 6122 2c20  ": "lost-data", 
-00015af0: 226b 6579 223a 206b 6579 7d0a 2020 2020  "key": key}.    
-00015b00: 2020 2020 666f 7220 6373 2069 6e20 7473      for cs in ts
-00015b10: 2e77 686f 5f77 616e 7473 206f 7220 2829  .who_wants or ()
-00015b20: 3a0a 2020 2020 2020 2020 2020 2020 636c  :.            cl
-00015b30: 6965 6e74 5f6d 7367 735b 6373 2e63 6c69  ient_msgs[cs.cli
-00015b40: 656e 745f 6b65 795d 203d 205b 7265 706f  ent_key] = [repo
-00015b50: 7274 5f6d 7367 5d0a 0a20 2020 2020 2020  rt_msg]..       
-00015b60: 2069 6620 6e6f 7420 7473 2e72 756e 5f73   if not ts.run_s
-00015b70: 7065 633a 2020 2320 7075 7265 2064 6174  pec:  # pure dat
-00015b80: 610a 2020 2020 2020 2020 2020 2020 7265  a.            re
-00015b90: 636f 6d6d 656e 6461 7469 6f6e 735b 6b65  commendations[ke
-00015ba0: 795d 203d 2022 666f 7267 6f74 7465 6e22  y] = "forgotten"
-00015bb0: 0a20 2020 2020 2020 2065 6c69 6620 7473  .        elif ts
-00015bc0: 2e68 6173 5f6c 6f73 745f 6465 7065 6e64  .has_lost_depend
-00015bd0: 656e 6369 6573 3a0a 2020 2020 2020 2020  encies:.        
-00015be0: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
-00015bf0: 6f6e 735b 6b65 795d 203d 2022 666f 7267  ons[key] = "forg
-00015c00: 6f74 7465 6e22 0a20 2020 2020 2020 2065  otten".        e
-00015c10: 6c69 6620 2874 732e 7768 6f5f 7761 6e74  lif (ts.who_want
-00015c20: 7320 6f72 2074 732e 7761 6974 6572 7329  s or ts.waiters)
-00015c30: 2061 6e64 206e 6f74 2061 6e79 280a 2020   and not any(.  
-00015c40: 2020 2020 2020 2020 2020 6474 732e 7374            dts.st
-00015c50: 6174 6520 3d3d 2022 6572 7265 6422 2066  ate == "erred" f
-00015c60: 6f72 2064 7473 2069 6e20 7473 2e64 6570  or dts in ts.dep
-00015c70: 656e 6465 6e63 6965 730a 2020 2020 2020  endencies.      
-00015c80: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
-00015c90: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-00015ca0: 5b6b 6579 5d20 3d20 2277 6169 7469 6e67  [key] = "waiting
-00015cb0: 220a 0a20 2020 2020 2020 2066 6f72 2064  "..        for d
-00015cc0: 7473 2069 6e20 7473 2e77 6169 7465 7273  ts in ts.waiters
-00015cd0: 206f 7220 2829 3a0a 2020 2020 2020 2020   or ():.        
-00015ce0: 2020 2020 6966 2064 7473 2e73 7461 7465      if dts.state
-00015cf0: 2069 6e20 2822 6e6f 2d77 6f72 6b65 7222   in ("no-worker"
-00015d00: 2c20 2270 726f 6365 7373 696e 6722 293a  , "processing"):
-00015d10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015d20: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-00015d30: 5b64 7473 2e6b 6579 5d20 3d20 2277 6169  [dts.key] = "wai
-00015d40: 7469 6e67 220a 2020 2020 2020 2020 2020  ting".          
-00015d50: 2020 656c 6966 2064 7473 2e73 7461 7465    elif dts.state
-00015d60: 203d 3d20 2277 6169 7469 6e67 223a 0a20   == "waiting":. 
-00015d70: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00015d80: 6620 6e6f 7420 6474 732e 7761 6974 696e  f not dts.waitin
-00015d90: 675f 6f6e 3a0a 2020 2020 2020 2020 2020  g_on:.          
-00015da0: 2020 2020 2020 2020 2020 6474 732e 7761            dts.wa
-00015db0: 6974 696e 675f 6f6e 203d 2073 6574 2829  iting_on = set()
-00015dc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015dd0: 2064 7473 2e77 6169 7469 6e67 5f6f 6e2e   dts.waiting_on.
-00015de0: 6164 6428 7473 290a 0a20 2020 2020 2020  add(ts)..       
-00015df0: 2069 6620 7365 6c66 2e76 616c 6964 6174   if self.validat
-00015e00: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
-00015e10: 7373 6572 7420 6e6f 7420 7473 2e77 6169  ssert not ts.wai
-00015e20: 7469 6e67 5f6f 6e0a 0a20 2020 2020 2020  ting_on..       
-00015e30: 2072 6574 7572 6e20 7265 636f 6d6d 656e   return recommen
-00015e40: 6461 7469 6f6e 732c 2063 6c69 656e 745f  dations, client_
-00015e50: 6d73 6773 2c20 776f 726b 6572 5f6d 7367  msgs, worker_msg
-00015e60: 730a 0a20 2020 2064 6566 205f 7472 616e  s..    def _tran
-00015e70: 7369 7469 6f6e 5f72 656c 6561 7365 645f  sition_released_
-00015e80: 6572 7265 6428 7365 6c66 2c20 6b65 793a  erred(self, key:
-00015e90: 204b 6579 2c20 7374 696d 756c 7573 5f69   Key, stimulus_i
-00015ea0: 643a 2073 7472 2920 2d3e 2052 6563 734d  d: str) -> RecsM
-00015eb0: 7367 733a 0a20 2020 2020 2020 2074 7320  sgs:.        ts 
-00015ec0: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
-00015ed0: 5d0a 2020 2020 2020 2020 7265 636f 6d6d  ].        recomm
-00015ee0: 656e 6461 7469 6f6e 733a 2052 6563 7320  endations: Recs 
-00015ef0: 3d20 7b7d 0a20 2020 2020 2020 2063 6c69  = {}.        cli
-00015f00: 656e 745f 6d73 6773 3a20 4d73 6773 203d  ent_msgs: Msgs =
-00015f10: 207b 7d0a 0a20 2020 2020 2020 2069 6620   {}..        if 
-00015f20: 7365 6c66 2e76 616c 6964 6174 653a 0a20  self.validate:. 
-00015f30: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00015f40: 7420 7473 2e65 7863 6570 7469 6f6e 5f62  t ts.exception_b
-00015f50: 6c61 6d65 0a20 2020 2020 2020 2020 2020  lame.           
-00015f60: 2061 7373 6572 7420 6e6f 7420 7473 2e77   assert not ts.w
-00015f70: 686f 5f68 6173 0a20 2020 2020 2020 2020  ho_has.         
-00015f80: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
-00015f90: 2e77 6169 7469 6e67 5f6f 6e0a 0a20 2020  .waiting_on..   
-00015fa0: 2020 2020 2066 6169 6c69 6e67 5f74 7320       failing_ts 
-00015fb0: 3d20 7473 2e65 7863 6570 7469 6f6e 5f62  = ts.exception_b
-00015fc0: 6c61 6d65 0a20 2020 2020 2020 2061 7373  lame.        ass
-00015fd0: 6572 7420 6661 696c 696e 675f 7473 0a0a  ert failing_ts..
-00015fe0: 2020 2020 2020 2020 666f 7220 6474 7320          for dts 
-00015ff0: 696e 2074 732e 6465 7065 6e64 656e 7473  in ts.dependents
-00016000: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00016010: 206e 6f74 2064 7473 2e77 686f 5f68 6173   not dts.who_has
-00016020: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00016030: 2020 6474 732e 6578 6365 7074 696f 6e5f    dts.exception_
-00016040: 626c 616d 6520 3d20 6661 696c 696e 675f  blame = failing_
-00016050: 7473 0a20 2020 2020 2020 2020 2020 2020  ts.             
-00016060: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
-00016070: 6e73 5b64 7473 2e6b 6579 5d20 3d20 2265  ns[dts.key] = "e
-00016080: 7272 6564 220a 0a20 2020 2020 2020 2072  rred"..        r
-00016090: 6570 6f72 745f 6d73 6720 3d20 7b0a 2020  eport_msg = {.  
-000160a0: 2020 2020 2020 2020 2020 226f 7022 3a20            "op": 
-000160b0: 2274 6173 6b2d 6572 7265 6422 2c0a 2020  "task-erred",.  
-000160c0: 2020 2020 2020 2020 2020 226b 6579 223a            "key":
-000160d0: 206b 6579 2c0a 2020 2020 2020 2020 2020   key,.          
-000160e0: 2020 2265 7863 6570 7469 6f6e 223a 2066    "exception": f
-000160f0: 6169 6c69 6e67 5f74 732e 6578 6365 7074  ailing_ts.except
-00016100: 696f 6e2c 0a20 2020 2020 2020 2020 2020  ion,.           
-00016110: 2022 7472 6163 6562 6163 6b22 3a20 6661   "traceback": fa
-00016120: 696c 696e 675f 7473 2e74 7261 6365 6261  iling_ts.traceba
-00016130: 636b 2c0a 2020 2020 2020 2020 7d0a 2020  ck,.        }.  
-00016140: 2020 2020 2020 666f 7220 6373 2069 6e20        for cs in 
-00016150: 7473 2e77 686f 5f77 616e 7473 206f 7220  ts.who_wants or 
-00016160: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00016170: 636c 6965 6e74 5f6d 7367 735b 6373 2e63  client_msgs[cs.c
-00016180: 6c69 656e 745f 6b65 795d 203d 205b 7265  lient_key] = [re
-00016190: 706f 7274 5f6d 7367 5d0a 0a20 2020 2020  port_msg]..     
-000161a0: 2020 2074 732e 7374 6174 6520 3d20 2265     ts.state = "e
-000161b0: 7272 6564 220a 0a20 2020 2020 2020 2023  rred"..        #
-000161c0: 2054 4f44 4f3a 2077 6169 7469 6e67 2064   TODO: waiting d
-000161d0: 6174 613f 0a20 2020 2020 2020 2072 6574  ata?.        ret
-000161e0: 7572 6e20 7265 636f 6d6d 656e 6461 7469  urn recommendati
-000161f0: 6f6e 732c 2063 6c69 656e 745f 6d73 6773  ons, client_msgs
-00016200: 2c20 7b7d 0a0a 2020 2020 6465 6620 5f74  , {}..    def _t
-00016210: 7261 6e73 6974 696f 6e5f 6572 7265 645f  ransition_erred_
-00016220: 7265 6c65 6173 6564 2873 656c 662c 206b  released(self, k
-00016230: 6579 3a20 4b65 792c 2073 7469 6d75 6c75  ey: Key, stimulu
-00016240: 735f 6964 3a20 7374 7229 202d 3e20 5265  s_id: str) -> Re
-00016250: 6373 4d73 6773 3a0a 2020 2020 2020 2020  csMsgs:.        
-00016260: 7473 203d 2073 656c 662e 7461 736b 735b  ts = self.tasks[
-00016270: 6b65 795d 0a20 2020 2020 2020 2072 6563  key].        rec
-00016280: 6f6d 6d65 6e64 6174 696f 6e73 3a20 5265  ommendations: Re
-00016290: 6373 203d 207b 7d0a 2020 2020 2020 2020  cs = {}.        
-000162a0: 636c 6965 6e74 5f6d 7367 733a 204d 7367  client_msgs: Msg
-000162b0: 7320 3d20 7b7d 0a20 2020 2020 2020 2077  s = {}.        w
-000162c0: 6f72 6b65 725f 6d73 6773 3a20 4d73 6773  orker_msgs: Msgs
-000162d0: 203d 207b 7d0a 0a20 2020 2020 2020 2069   = {}..        i
-000162e0: 6620 7365 6c66 2e76 616c 6964 6174 653a  f self.validate:
-000162f0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00016300: 6572 7420 7473 2e65 7863 6570 7469 6f6e  ert ts.exception
-00016310: 5f62 6c61 6d65 0a20 2020 2020 2020 2020  _blame.         
-00016320: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
-00016330: 2e77 686f 5f68 6173 0a20 2020 2020 2020  .who_has.       
-00016340: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-00016350: 7473 2e77 6169 7469 6e67 5f6f 6e0a 2020  ts.waiting_on.  
-00016360: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00016370: 206e 6f74 2074 732e 7761 6974 6572 730a   not ts.waiters.
-00016380: 0a20 2020 2020 2020 2074 732e 6578 6365  .        ts.exce
-00016390: 7074 696f 6e20 3d20 4e6f 6e65 0a20 2020  ption = None.   
-000163a0: 2020 2020 2074 732e 6578 6365 7074 696f       ts.exceptio
-000163b0: 6e5f 626c 616d 6520 3d20 4e6f 6e65 0a20  n_blame = None. 
-000163c0: 2020 2020 2020 2074 732e 7472 6163 6562         ts.traceb
-000163d0: 6163 6b20 3d20 4e6f 6e65 0a0a 2020 2020  ack = None..    
-000163e0: 2020 2020 666f 7220 6474 7320 696e 2074      for dts in t
-000163f0: 732e 6465 7065 6e64 656e 7473 3a0a 2020  s.dependents:.  
-00016400: 2020 2020 2020 2020 2020 6966 2064 7473            if dts
-00016410: 2e73 7461 7465 203d 3d20 2265 7272 6564  .state == "erred
-00016420: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
-00016430: 2020 2023 2044 6f65 7320 7468 6973 206d     # Does this m
-00016440: 616b 6520 7365 6e73 653f 0a20 2020 2020  ake sense?.     
-00016450: 2020 2020 2020 2020 2020 2023 2054 6869             # Thi
-00016460: 7320 676f 6573 2076 6961 2072 656c 6561  s goes via relea
-00016470: 7365 640a 2020 2020 2020 2020 2020 2020  sed.            
-00016480: 2020 2020 2320 6474 7320 2d3e 2072 656c      # dts -> rel
-00016490: 6561 7365 6420 2d3e 2077 6169 7469 6e67  eased -> waiting
-000164a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000164b0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-000164c0: 5b64 7473 2e6b 6579 5d20 3d20 2277 6169  [dts.key] = "wai
-000164d0: 7469 6e67 220a 0a20 2020 2020 2020 2077  ting"..        w
-000164e0: 5f6d 7367 203d 207b 0a20 2020 2020 2020  _msg = {.       
-000164f0: 2020 2020 2022 6f70 223a 2022 6672 6565       "op": "free
-00016500: 2d6b 6579 7322 2c0a 2020 2020 2020 2020  -keys",.        
-00016510: 2020 2020 226b 6579 7322 3a20 5b6b 6579      "keys": [key
-00016520: 5d2c 0a20 2020 2020 2020 2020 2020 2022  ],.            "
-00016530: 7374 696d 756c 7573 5f69 6422 3a20 7374  stimulus_id": st
-00016540: 696d 756c 7573 5f69 642c 0a20 2020 2020  imulus_id,.     
-00016550: 2020 207d 0a20 2020 2020 2020 2066 6f72     }.        for
-00016560: 2077 735f 6164 6472 2069 6e20 7473 2e65   ws_addr in ts.e
-00016570: 7272 6564 5f6f 6e20 6f72 2028 293a 0a20  rred_on or ():. 
-00016580: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
-00016590: 725f 6d73 6773 5b77 735f 6164 6472 5d20  r_msgs[ws_addr] 
-000165a0: 3d20 5b77 5f6d 7367 5d0a 2020 2020 2020  = [w_msg].      
-000165b0: 2020 7473 2e65 7272 6564 5f6f 6e20 3d20    ts.erred_on = 
-000165c0: 4e6f 6e65 0a0a 2020 2020 2020 2020 7265  None..        re
-000165d0: 706f 7274 5f6d 7367 203d 207b 226f 7022  port_msg = {"op"
-000165e0: 3a20 2274 6173 6b2d 7265 7472 6965 6422  : "task-retried"
-000165f0: 2c20 226b 6579 223a 206b 6579 7d0a 2020  , "key": key}.  
-00016600: 2020 2020 2020 666f 7220 6373 2069 6e20        for cs in 
-00016610: 7473 2e77 686f 5f77 616e 7473 206f 7220  ts.who_wants or 
-00016620: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00016630: 636c 6965 6e74 5f6d 7367 735b 6373 2e63  client_msgs[cs.c
-00016640: 6c69 656e 745f 6b65 795d 203d 205b 7265  lient_key] = [re
-00016650: 706f 7274 5f6d 7367 5d0a 0a20 2020 2020  port_msg]..     
-00016660: 2020 2074 732e 7374 6174 6520 3d20 2272     ts.state = "r
-00016670: 656c 6561 7365 6422 0a0a 2020 2020 2020  eleased"..      
-00016680: 2020 7265 7475 726e 2072 6563 6f6d 6d65    return recomme
-00016690: 6e64 6174 696f 6e73 2c20 636c 6965 6e74  ndations, client
-000166a0: 5f6d 7367 732c 2077 6f72 6b65 725f 6d73  _msgs, worker_ms
-000166b0: 6773 0a0a 2020 2020 6465 6620 5f74 7261  gs..    def _tra
-000166c0: 6e73 6974 696f 6e5f 7761 6974 696e 675f  nsition_waiting_
-000166d0: 7265 6c65 6173 6564 2873 656c 662c 206b  released(self, k
-000166e0: 6579 3a20 4b65 792c 2073 7469 6d75 6c75  ey: Key, stimulu
-000166f0: 735f 6964 3a20 7374 7229 202d 3e20 5265  s_id: str) -> Re
-00016700: 6373 4d73 6773 3a0a 2020 2020 2020 2020  csMsgs:.        
-00016710: 7473 203d 2073 656c 662e 7461 736b 735b  ts = self.tasks[
-00016720: 6b65 795d 0a20 2020 2020 2020 2072 6563  key].        rec
-00016730: 6f6d 6d65 6e64 6174 696f 6e73 3a20 5265  ommendations: Re
-00016740: 6373 203d 207b 7d0a 0a20 2020 2020 2020  cs = {}..       
-00016750: 2069 6620 7365 6c66 2e76 616c 6964 6174   if self.validat
-00016760: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
-00016770: 7373 6572 7420 6e6f 7420 7473 2e77 686f  ssert not ts.who
-00016780: 5f68 6173 0a20 2020 2020 2020 2020 2020  _has.           
-00016790: 2061 7373 6572 7420 6e6f 7420 7473 2e70   assert not ts.p
-000167a0: 726f 6365 7373 696e 675f 6f6e 0a0a 2020  rocessing_on..  
-000167b0: 2020 2020 2020 666f 7220 6474 7320 696e        for dts in
-000167c0: 2074 732e 6465 7065 6e64 656e 6369 6573   ts.dependencies
-000167d0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-000167e0: 2074 7320 696e 2028 6474 732e 7761 6974   ts in (dts.wait
-000167f0: 6572 7320 6f72 2028 2929 3a0a 2020 2020  ers or ()):.    
-00016800: 2020 2020 2020 2020 2020 2020 6966 2064              if d
-00016810: 7473 2e77 6169 7465 7273 3a0a 2020 2020  ts.waiters:.    
-00016820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016830: 6474 732e 7761 6974 6572 732e 6469 7363  dts.waiters.disc
-00016840: 6172 6428 7473 290a 2020 2020 2020 2020  ard(ts).        
-00016850: 2020 2020 2020 2020 6966 206e 6f74 2064          if not d
-00016860: 7473 2e77 6169 7465 7273 2061 6e64 206e  ts.waiters and n
-00016870: 6f74 2064 7473 2e77 686f 5f77 616e 7473  ot dts.who_wants
-00016880: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00016890: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
-000168a0: 7469 6f6e 735b 6474 732e 6b65 795d 203d  tions[dts.key] =
-000168b0: 2022 7265 6c65 6173 6564 220a 2020 2020   "released".    
-000168c0: 2020 2020 7473 2e77 6169 7469 6e67 5f6f      ts.waiting_o
-000168d0: 6e20 3d20 4e6f 6e65 0a0a 2020 2020 2020  n = None..      
-000168e0: 2020 7473 2e73 7461 7465 203d 2022 7265    ts.state = "re
-000168f0: 6c65 6173 6564 220a 0a20 2020 2020 2020  leased"..       
-00016900: 2069 6620 7473 2e68 6173 5f6c 6f73 745f   if ts.has_lost_
-00016910: 6465 7065 6e64 656e 6369 6573 3a0a 2020  dependencies:.  
-00016920: 2020 2020 2020 2020 2020 7265 636f 6d6d            recomm
-00016930: 656e 6461 7469 6f6e 735b 6b65 795d 203d  endations[key] =
-00016940: 2022 666f 7267 6f74 7465 6e22 0a20 2020   "forgotten".   
-00016950: 2020 2020 2065 6c69 6620 6e6f 7420 7473       elif not ts
-00016960: 2e65 7863 6570 7469 6f6e 5f62 6c61 6d65  .exception_blame
-00016970: 2061 6e64 2028 7473 2e77 686f 5f77 616e   and (ts.who_wan
-00016980: 7473 206f 7220 7473 2e77 6169 7465 7273  ts or ts.waiters
-00016990: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-000169a0: 6563 6f6d 6d65 6e64 6174 696f 6e73 5b6b  ecommendations[k
-000169b0: 6579 5d20 3d20 2277 6169 7469 6e67 220a  ey] = "waiting".
-000169c0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-000169d0: 2020 2020 2020 2020 2020 7473 2e77 6169            ts.wai
-000169e0: 7465 7273 203d 204e 6f6e 650a 0a20 2020  ters = None..   
-000169f0: 2020 2020 2072 6574 7572 6e20 7265 636f       return reco
-00016a00: 6d6d 656e 6461 7469 6f6e 732c 207b 7d2c  mmendations, {},
-00016a10: 207b 7d0a 0a20 2020 2064 6566 205f 7472   {}..    def _tr
-00016a20: 616e 7369 7469 6f6e 5f70 726f 6365 7373  ansition_process
-00016a30: 696e 675f 7265 6c65 6173 6564 2873 656c  ing_released(sel
-00016a40: 662c 206b 6579 3a20 4b65 792c 2073 7469  f, key: Key, sti
-00016a50: 6d75 6c75 735f 6964 3a20 7374 7229 202d  mulus_id: str) -
-00016a60: 3e20 5265 6373 4d73 6773 3a0a 2020 2020  > RecsMsgs:.    
-00016a70: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
-00016a80: 736b 735b 6b65 795d 0a20 2020 2020 2020  sks[key].       
-00016a90: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-00016aa0: 3a20 5265 6373 203d 207b 7d0a 2020 2020  : Recs = {}.    
-00016ab0: 2020 2020 776f 726b 6572 5f6d 7367 733a      worker_msgs:
-00016ac0: 204d 7367 7320 3d20 7b7d 0a0a 2020 2020   Msgs = {}..    
-00016ad0: 2020 2020 6966 2073 656c 662e 7661 6c69      if self.vali
-00016ae0: 6461 7465 3a0a 2020 2020 2020 2020 2020  date:.          
-00016af0: 2020 6173 7365 7274 2074 732e 7072 6f63    assert ts.proc
-00016b00: 6573 7369 6e67 5f6f 6e0a 2020 2020 2020  essing_on.      
-00016b10: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
-00016b20: 2074 732e 7768 6f5f 6861 730a 2020 2020   ts.who_has.    
-00016b30: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
-00016b40: 6f74 2074 732e 7761 6974 696e 675f 6f6e  ot ts.waiting_on
-00016b50: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00016b60: 6572 7420 7473 2e73 7461 7465 203d 3d20  ert ts.state == 
-00016b70: 2270 726f 6365 7373 696e 6722 0a0a 2020  "processing"..  
-00016b80: 2020 2020 2020 7773 203d 2073 656c 662e        ws = self.
-00016b90: 5f65 7869 745f 7072 6f63 6573 7369 6e67  _exit_processing
-00016ba0: 5f63 6f6d 6d6f 6e28 7473 290a 2020 2020  _common(ts).    
-00016bb0: 2020 2020 6966 2077 733a 0a20 2020 2020      if ws:.     
-00016bc0: 2020 2020 2020 2077 6f72 6b65 725f 6d73         worker_ms
-00016bd0: 6773 5b77 732e 6164 6472 6573 735d 203d  gs[ws.address] =
-00016be0: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
-00016bf0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00016c00: 2020 2020 2020 2020 2022 6f70 223a 2022           "op": "
-00016c10: 6672 6565 2d6b 6579 7322 2c0a 2020 2020  free-keys",.    
-00016c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016c30: 226b 6579 7322 3a20 5b6b 6579 5d2c 0a20  "keys": [key],. 
-00016c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016c50: 2020 2022 7374 696d 756c 7573 5f69 6422     "stimulus_id"
-00016c60: 3a20 7374 696d 756c 7573 5f69 642c 0a20  : stimulus_id,. 
-00016c70: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-00016c80: 0a20 2020 2020 2020 2020 2020 205d 0a0a  .            ]..
-00016c90: 2020 2020 2020 2020 7365 6c66 2e5f 7072          self._pr
-00016ca0: 6f70 6167 6174 655f 7265 6c65 6173 6564  opagate_released
-00016cb0: 2874 732c 2072 6563 6f6d 6d65 6e64 6174  (ts, recommendat
-00016cc0: 696f 6e73 290a 2020 2020 2020 2020 7265  ions).        re
-00016cd0: 7475 726e 2072 6563 6f6d 6d65 6e64 6174  turn recommendat
-00016ce0: 696f 6e73 2c20 7b7d 2c20 776f 726b 6572  ions, {}, worker
-00016cf0: 5f6d 7367 730a 0a20 2020 2064 6566 205f  _msgs..    def _
-00016d00: 7472 616e 7369 7469 6f6e 5f70 726f 6365  transition_proce
-00016d10: 7373 696e 675f 6572 7265 6428 0a20 2020  ssing_erred(.   
-00016d20: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-00016d30: 2020 206b 6579 3a20 4b65 792c 0a20 2020     key: Key,.   
-00016d40: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
-00016d50: 3a20 7374 722c 0a20 2020 2020 2020 2077  : str,.        w
-00016d60: 6f72 6b65 723a 2073 7472 2c0a 2020 2020  orker: str,.    
-00016d70: 2020 2020 2a2c 0a20 2020 2020 2020 2063      *,.        c
-00016d80: 6175 7365 3a20 4b65 7920 7c20 4e6f 6e65  ause: Key | None
-00016d90: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-00016da0: 2065 7863 6570 7469 6f6e 3a20 5365 7269   exception: Seri
-00016db0: 616c 697a 6564 207c 204e 6f6e 6520 3d20  alized | None = 
-00016dc0: 4e6f 6e65 2c0a 2020 2020 2020 2020 7472  None,.        tr
-00016dd0: 6163 6562 6163 6b3a 2053 6572 6961 6c69  aceback: Seriali
-00016de0: 7a65 6420 7c20 4e6f 6e65 203d 204e 6f6e  zed | None = Non
-00016df0: 652c 0a20 2020 2020 2020 2065 7863 6570  e,.        excep
-00016e00: 7469 6f6e 5f74 6578 743a 2073 7472 207c  tion_text: str |
-00016e10: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
-00016e20: 2020 2020 2020 7472 6163 6562 6163 6b5f        traceback_
-00016e30: 7465 7874 3a20 7374 7220 7c20 4e6f 6e65  text: str | None
-00016e40: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-00016e50: 202a 2a6b 7761 7267 733a 2041 6e79 2c0a   **kwargs: Any,.
-00016e60: 2020 2020 2920 2d3e 2052 6563 734d 7367      ) -> RecsMsg
-00016e70: 733a 0a20 2020 2020 2020 2022 2222 5072  s:.        """Pr
-00016e80: 6f63 6573 7365 6420 6120 7265 636f 6d6d  ocessed a recomm
-00016e90: 656e 6465 6420 7472 616e 7369 7469 6f6e  ended transition
-00016ea0: 2070 726f 6365 7373 696e 6720 2d3e 2065   processing -> e
-00016eb0: 7272 6564 2e0a 0a20 2020 2020 2020 2050  rred...        P
-00016ec0: 6172 616d 6574 6572 730a 2020 2020 2020  arameters.      
-00016ed0: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
-00016ee0: 2020 2020 206b 6579 0a20 2020 2020 2020       key.       
-00016ef0: 2020 2020 4b65 7920 6f66 2074 6865 2074      Key of the t
-00016f00: 6173 6b20 746f 2074 7261 6e73 6974 696f  ask to transitio
-00016f10: 6e0a 2020 2020 2020 2020 7374 696d 756c  n.        stimul
-00016f20: 7573 5f69 640a 2020 2020 2020 2020 2020  us_id.          
-00016f30: 2020 4944 206f 6620 7468 6520 7374 696d    ID of the stim
-00016f40: 756c 7573 2063 6175 7369 6e67 2074 6865  ulus causing the
-00016f50: 2074 7261 6e73 6974 696f 6e0a 2020 2020   transition.    
-00016f60: 2020 2020 776f 726b 6572 0a20 2020 2020      worker.     
-00016f70: 2020 2020 2020 2041 6464 7265 7373 206f         Address o
-00016f80: 6620 7468 6520 776f 726b 6572 2077 6865  f the worker whe
-00016f90: 7265 2074 6865 2074 6173 6b20 6572 7265  re the task erre
-00016fa0: 642e 0a20 2020 2020 2020 2020 2020 204e  d..            N
-00016fb0: 6f74 206e 6563 6573 7361 7269 6c79 2060  ot necessarily `
-00016fc0: 6074 732e 7072 6f63 6573 7369 6e67 5f6f  `ts.processing_o
-00016fd0: 6e60 602e 0a20 2020 2020 2020 2063 6175  n``..        cau
-00016fe0: 7365 0a20 2020 2020 2020 2020 2020 2041  se.            A
-00016ff0: 6464 7265 7373 206f 6620 7468 6520 7461  ddress of the ta
-00017000: 736b 2074 6861 7420 6361 7573 6564 2074  sk that caused t
-00017010: 6869 7320 7461 736b 2074 6f20 6265 2074  his task to be t
-00017020: 7261 6e73 6974 696f 6e65 6420 746f 2065  ransitioned to e
-00017030: 7272 6564 0a20 2020 2020 2020 2065 7863  rred.        exc
-00017040: 6570 7469 6f6e 0a20 2020 2020 2020 2020  eption.         
-00017050: 2020 2045 7863 6570 7469 6f6e 2063 6175     Exception cau
-00017060: 7365 6420 6279 2074 6865 2074 6173 6b0a  sed by the task.
-00017070: 2020 2020 2020 2020 7472 6163 6562 6163          tracebac
-00017080: 6b0a 2020 2020 2020 2020 2020 2020 5472  k.            Tr
-00017090: 6163 6562 6163 6b20 6361 7573 6564 2062  aceback caused b
-000170a0: 7920 7468 6520 7461 736b 0a20 2020 2020  y the task.     
-000170b0: 2020 2065 7863 6570 7469 6f6e 5f74 6578     exception_tex
-000170c0: 740a 2020 2020 2020 2020 2020 2020 5374  t.            St
-000170d0: 7269 6e67 2072 6570 7265 7365 6e74 6174  ring representat
-000170e0: 696f 6e20 6f66 2074 6865 2065 7863 6570  ion of the excep
-000170f0: 7469 6f6e 0a20 2020 2020 2020 2074 7261  tion.        tra
-00017100: 6365 6261 636b 5f74 6578 740a 2020 2020  ceback_text.    
-00017110: 2020 2020 2020 2020 5374 7269 6e67 2072          String r
-00017120: 6570 7265 7365 6e74 6174 696f 6e20 6f66  epresentation of
-00017130: 2074 6865 2074 7261 6365 6261 636b 0a0a   the traceback..
-00017140: 2020 2020 2020 2020 5265 7475 726e 730a          Returns.
-00017150: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d0a          -------.
-00017160: 2020 2020 2020 2020 5265 636f 6d6d 656e          Recommen
-00017170: 6461 7469 6f6e 732c 2063 6c69 656e 7420  dations, client 
-00017180: 6d65 7373 6167 6573 2061 6e64 2077 6f72  messages and wor
-00017190: 6b65 7220 6d65 7373 6167 6573 2074 6f20  ker messages to 
-000171a0: 7072 6f63 6573 730a 2020 2020 2020 2020  process.        
-000171b0: 2222 220a 2020 2020 2020 2020 7473 203d  """.        ts =
-000171c0: 2073 656c 662e 7461 736b 735b 6b65 795d   self.tasks[key]
-000171d0: 0a20 2020 2020 2020 2072 6563 6f6d 6d65  .        recomme
-000171e0: 6e64 6174 696f 6e73 3a20 5265 6373 203d  ndations: Recs =
-000171f0: 207b 7d0a 2020 2020 2020 2020 636c 6965   {}.        clie
-00017200: 6e74 5f6d 7367 733a 204d 7367 7320 3d20  nt_msgs: Msgs = 
-00017210: 7b7d 0a0a 2020 2020 2020 2020 6966 2073  {}..        if s
-00017220: 656c 662e 7661 6c69 6461 7465 3a0a 2020  elf.validate:.  
-00017230: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00017240: 2063 6175 7365 206f 7220 7473 2e65 7863   cause or ts.exc
-00017250: 6570 7469 6f6e 5f62 6c61 6d65 0a20 2020  eption_blame.   
-00017260: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00017270: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
-00017280: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00017290: 6572 7420 6e6f 7420 7473 2e77 686f 5f68  ert not ts.who_h
-000172a0: 6173 0a20 2020 2020 2020 2020 2020 2061  as.            a
-000172b0: 7373 6572 7420 6e6f 7420 7473 2e77 6169  ssert not ts.wai
-000172c0: 7469 6e67 5f6f 6e0a 0a20 2020 2020 2020  ting_on..       
-000172d0: 2069 6620 7473 2e61 6374 6f72 3a0a 2020   if ts.actor:.  
-000172e0: 2020 2020 2020 2020 2020 7773 203d 2074            ws = t
-000172f0: 732e 7072 6f63 6573 7369 6e67 5f6f 6e0a  s.processing_on.
-00017300: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00017310: 7274 2077 730a 2020 2020 2020 2020 2020  rt ws.          
-00017320: 2020 7773 2e61 6374 6f72 732e 7265 6d6f    ws.actors.remo
-00017330: 7665 2874 7329 0a0a 2020 2020 2020 2020  ve(ts)..        
-00017340: 7365 6c66 2e5f 6578 6974 5f70 726f 6365  self._exit_proce
-00017350: 7373 696e 675f 636f 6d6d 6f6e 2874 7329  ssing_common(ts)
-00017360: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
-00017370: 2074 732e 6572 7265 645f 6f6e 3a0a 2020   ts.erred_on:.  
-00017380: 2020 2020 2020 2020 2020 7473 2e65 7272            ts.err
-00017390: 6564 5f6f 6e20 3d20 7365 7428 290a 2020  ed_on = set().  
-000173a0: 2020 2020 2020 7473 2e65 7272 6564 5f6f        ts.erred_o
-000173b0: 6e2e 6164 6428 776f 726b 6572 290a 2020  n.add(worker).  
-000173c0: 2020 2020 2020 6966 2065 7863 6570 7469        if excepti
-000173d0: 6f6e 2069 7320 6e6f 7420 4e6f 6e65 3a0a  on is not None:.
-000173e0: 2020 2020 2020 2020 2020 2020 7473 2e65              ts.e
-000173f0: 7863 6570 7469 6f6e 203d 2065 7863 6570  xception = excep
-00017400: 7469 6f6e 0a20 2020 2020 2020 2020 2020  tion.           
-00017410: 2074 732e 6578 6365 7074 696f 6e5f 7465   ts.exception_te
-00017420: 7874 203d 2065 7863 6570 7469 6f6e 5f74  xt = exception_t
-00017430: 6578 740a 2020 2020 2020 2020 6966 2074  ext.        if t
-00017440: 7261 6365 6261 636b 2069 7320 6e6f 7420  raceback is not 
-00017450: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00017460: 2020 7473 2e74 7261 6365 6261 636b 203d    ts.traceback =
-00017470: 2074 7261 6365 6261 636b 0a20 2020 2020   traceback.     
-00017480: 2020 2020 2020 2074 732e 7472 6163 6562         ts.traceb
-00017490: 6163 6b5f 7465 7874 203d 2074 7261 6365  ack_text = trace
-000174a0: 6261 636b 5f74 6578 740a 2020 2020 2020  back_text.      
-000174b0: 2020 6966 2063 6175 7365 2069 7320 6e6f    if cause is no
-000174c0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-000174d0: 2020 2020 6661 696c 696e 675f 7473 203d      failing_ts =
-000174e0: 2073 656c 662e 7461 736b 735b 6361 7573   self.tasks[caus
-000174f0: 655d 0a20 2020 2020 2020 2020 2020 2074  e].            t
-00017500: 732e 6578 6365 7074 696f 6e5f 626c 616d  s.exception_blam
-00017510: 6520 3d20 6661 696c 696e 675f 7473 0a20  e = failing_ts. 
-00017520: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00017530: 2020 2020 2020 2020 2066 6169 6c69 6e67           failing
-00017540: 5f74 7320 3d20 7473 2e65 7863 6570 7469  _ts = ts.excepti
-00017550: 6f6e 5f62 6c61 6d65 2020 2320 7479 7065  on_blame  # type
-00017560: 3a20 6967 6e6f 7265 0a0a 2020 2020 2020  : ignore..      
-00017570: 2020 7365 6c66 2e65 7272 6564 5f74 6173    self.erred_tas
-00017580: 6b73 2e61 7070 656e 646c 6566 7428 0a20  ks.appendleft(. 
-00017590: 2020 2020 2020 2020 2020 2045 7272 6564             Erred
-000175a0: 5461 736b 280a 2020 2020 2020 2020 2020  Task(.          
-000175b0: 2020 2020 2020 7473 2e6b 6579 2c0a 2020        ts.key,.  
-000175c0: 2020 2020 2020 2020 2020 2020 2020 7469                ti
-000175d0: 6d65 2829 2c0a 2020 2020 2020 2020 2020  me(),.          
-000175e0: 2020 2020 2020 7473 2e65 7272 6564 5f6f        ts.erred_o
-000175f0: 6e2e 636f 7079 2829 2c0a 2020 2020 2020  n.copy(),.      
-00017600: 2020 2020 2020 2020 2020 6578 6365 7074            except
-00017610: 696f 6e5f 7465 7874 206f 7220 2222 2c0a  ion_text or "",.
-00017620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017630: 7472 6163 6562 6163 6b5f 7465 7874 206f  traceback_text o
-00017640: 7220 2222 2c0a 2020 2020 2020 2020 2020  r "",.          
-00017650: 2020 290a 2020 2020 2020 2020 290a 0a20    ).        ).. 
-00017660: 2020 2020 2020 2066 6f72 2064 7473 2069         for dts i
-00017670: 6e20 7473 2e77 6169 7465 7273 206f 7220  n ts.waiters or 
-00017680: 7365 7428 293a 0a20 2020 2020 2020 2020  set():.         
-00017690: 2020 2064 7473 2e65 7863 6570 7469 6f6e     dts.exception
-000176a0: 5f62 6c61 6d65 203d 2066 6169 6c69 6e67  _blame = failing
-000176b0: 5f74 730a 2020 2020 2020 2020 2020 2020  _ts.            
-000176c0: 7265 636f 6d6d 656e 6461 7469 6f6e 735b  recommendations[
-000176d0: 6474 732e 6b65 795d 203d 2022 6572 7265  dts.key] = "erre
-000176e0: 6422 0a0a 2020 2020 2020 2020 666f 7220  d"..        for 
-000176f0: 6474 7320 696e 2074 732e 6465 7065 6e64  dts in ts.depend
-00017700: 656e 6369 6573 3a0a 2020 2020 2020 2020  encies:.        
-00017710: 2020 2020 6966 2064 7473 2e77 6169 7465      if dts.waite
-00017720: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
-00017730: 2020 2020 6474 732e 7761 6974 6572 732e      dts.waiters.
-00017740: 6469 7363 6172 6428 7473 290a 2020 2020  discard(ts).    
-00017750: 2020 2020 2020 2020 6966 206e 6f74 2064          if not d
-00017760: 7473 2e77 6169 7465 7273 2061 6e64 206e  ts.waiters and n
-00017770: 6f74 2064 7473 2e77 686f 5f77 616e 7473  ot dts.who_wants
-00017780: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00017790: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
-000177a0: 735b 6474 732e 6b65 795d 203d 2022 7265  s[dts.key] = "re
-000177b0: 6c65 6173 6564 220a 0a20 2020 2020 2020  leased"..       
-000177c0: 2074 732e 7761 6974 6572 7320 3d20 4e6f   ts.waiters = No
-000177d0: 6e65 0a0a 2020 2020 2020 2020 7473 2e73  ne..        ts.s
-000177e0: 7461 7465 203d 2022 6572 7265 6422 0a0a  tate = "erred"..
-000177f0: 2020 2020 2020 2020 7265 706f 7274 5f6d          report_m
-00017800: 7367 203d 207b 0a20 2020 2020 2020 2020  sg = {.         
-00017810: 2020 2022 6f70 223a 2022 7461 736b 2d65     "op": "task-e
-00017820: 7272 6564 222c 0a20 2020 2020 2020 2020  rred",.         
-00017830: 2020 2022 6b65 7922 3a20 6b65 792c 0a20     "key": key,. 
-00017840: 2020 2020 2020 2020 2020 2022 6578 6365             "exce
-00017850: 7074 696f 6e22 3a20 6661 696c 696e 675f  ption": failing_
-00017860: 7473 2e65 7863 6570 7469 6f6e 2c0a 2020  ts.exception,.  
-00017870: 2020 2020 2020 2020 2020 2274 7261 6365            "trace
-00017880: 6261 636b 223a 2066 6169 6c69 6e67 5f74  back": failing_t
-00017890: 732e 7472 6163 6562 6163 6b2c 0a20 2020  s.traceback,.   
-000178a0: 2020 2020 207d 0a20 2020 2020 2020 2066       }.        f
-000178b0: 6f72 2063 7320 696e 2074 732e 7768 6f5f  or cs in ts.who_
-000178c0: 7761 6e74 7320 6f72 2028 293a 0a20 2020  wants or ():.   
-000178d0: 2020 2020 2020 2020 2063 6c69 656e 745f           client_
-000178e0: 6d73 6773 5b63 732e 636c 6965 6e74 5f6b  msgs[cs.client_k
-000178f0: 6579 5d20 3d20 5b72 6570 6f72 745f 6d73  ey] = [report_ms
-00017900: 675d 0a0a 2020 2020 2020 2020 6373 203d  g]..        cs =
-00017910: 2073 656c 662e 636c 6965 6e74 735b 2266   self.clients["f
-00017920: 6972 652d 616e 642d 666f 7267 6574 225d  ire-and-forget"]
-00017930: 0a20 2020 2020 2020 2069 6620 7473 2069  .        if ts i
-00017940: 6e20 6373 2e77 616e 7473 5f77 6861 743a  n cs.wants_what:
-00017950: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00017960: 662e 5f63 6c69 656e 745f 7265 6c65 6173  f._client_releas
-00017970: 6573 5f6b 6579 7328 0a20 2020 2020 2020  es_keys(.       
-00017980: 2020 2020 2020 2020 2063 733d 6373 2c0a           cs=cs,.
-00017990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000179a0: 6b65 7973 3d5b 6b65 795d 2c0a 2020 2020  keys=[key],.    
-000179b0: 2020 2020 2020 2020 2020 2020 7265 636f              reco
-000179c0: 6d6d 656e 6461 7469 6f6e 733d 7265 636f  mmendations=reco
-000179d0: 6d6d 656e 6461 7469 6f6e 732c 0a20 2020  mmendations,.   
-000179e0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-000179f0: 2020 2020 6966 2073 656c 662e 7661 6c69      if self.vali
-00017a00: 6461 7465 3a0a 2020 2020 2020 2020 2020  date:.          
-00017a10: 2020 6173 7365 7274 206e 6f74 2074 732e    assert not ts.
-00017a20: 7072 6f63 6573 7369 6e67 5f6f 6e0a 0a20  processing_on.. 
-00017a30: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
-00017a40: 636f 6d6d 656e 6461 7469 6f6e 732c 2063  commendations, c
-00017a50: 6c69 656e 745f 6d73 6773 2c20 7b7d 0a0a  lient_msgs, {}..
-00017a60: 2020 2020 6465 6620 5f74 7261 6e73 6974      def _transit
-00017a70: 696f 6e5f 6e6f 5f77 6f72 6b65 725f 7265  ion_no_worker_re
-00017a80: 6c65 6173 6564 2873 656c 662c 206b 6579  leased(self, key
-00017a90: 3a20 4b65 792c 2073 7469 6d75 6c75 735f  : Key, stimulus_
-00017aa0: 6964 3a20 7374 7229 202d 3e20 5265 6373  id: str) -> Recs
-00017ab0: 4d73 6773 3a0a 2020 2020 2020 2020 7473  Msgs:.        ts
-00017ac0: 203d 2073 656c 662e 7461 736b 735b 6b65   = self.tasks[ke
-00017ad0: 795d 0a0a 2020 2020 2020 2020 6966 2073  y]..        if s
-00017ae0: 656c 662e 7661 6c69 6461 7465 3a0a 2020  elf.validate:.  
-00017af0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00017b00: 2073 656c 662e 7461 736b 735b 6b65 795d   self.tasks[key]
-00017b10: 2e73 7461 7465 203d 3d20 226e 6f2d 776f  .state == "no-wo
-00017b20: 726b 6572 220a 2020 2020 2020 2020 2020  rker".          
-00017b30: 2020 6173 7365 7274 206e 6f74 2074 732e    assert not ts.
-00017b40: 7768 6f5f 6861 730a 2020 2020 2020 2020  who_has.        
-00017b50: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
-00017b60: 732e 7761 6974 696e 675f 6f6e 0a0a 2020  s.waiting_on..  
-00017b70: 2020 2020 2020 7365 6c66 2e75 6e72 756e        self.unrun
-00017b80: 6e61 626c 652e 7265 6d6f 7665 2874 7329  nable.remove(ts)
-00017b90: 0a0a 2020 2020 2020 2020 7265 636f 6d6d  ..        recomm
-00017ba0: 656e 6461 7469 6f6e 733a 2052 6563 7320  endations: Recs 
-00017bb0: 3d20 7b7d 0a20 2020 2020 2020 2073 656c  = {}.        sel
-00017bc0: 662e 5f70 726f 7061 6761 7465 5f72 656c  f._propagate_rel
-00017bd0: 6561 7365 6428 7473 2c20 7265 636f 6d6d  eased(ts, recomm
-00017be0: 656e 6461 7469 6f6e 7329 0a20 2020 2020  endations).     
-00017bf0: 2020 2072 6574 7572 6e20 7265 636f 6d6d     return recomm
-00017c00: 656e 6461 7469 6f6e 732c 207b 7d2c 207b  endations, {}, {
-00017c10: 7d0a 0a20 2020 2064 6566 205f 7472 616e  }..    def _tran
-00017c20: 7369 7469 6f6e 5f77 6169 7469 6e67 5f71  sition_waiting_q
-00017c30: 7565 7565 6428 7365 6c66 2c20 6b65 793a  ueued(self, key:
-00017c40: 204b 6579 2c20 7374 696d 756c 7573 5f69   Key, stimulus_i
-00017c50: 643a 2073 7472 2920 2d3e 2052 6563 734d  d: str) -> RecsM
-00017c60: 7367 733a 0a20 2020 2020 2020 2074 7320  sgs:.        ts 
-00017c70: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
-00017c80: 5d0a 0a20 2020 2020 2020 2069 6620 7365  ]..        if se
-00017c90: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
-00017ca0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00017cb0: 6e6f 7420 7365 6c66 2e69 646c 655f 7461  not self.idle_ta
-00017cc0: 736b 5f63 6f75 6e74 2c20 2874 732c 2073  sk_count, (ts, s
-00017cd0: 656c 662e 6964 6c65 5f74 6173 6b5f 636f  elf.idle_task_co
-00017ce0: 756e 7429 0a20 2020 2020 2020 2020 2020  unt).           
-00017cf0: 2073 656c 662e 5f76 616c 6964 6174 655f   self._validate_
-00017d00: 7265 6164 7928 7473 290a 0a20 2020 2020  ready(ts)..     
-00017d10: 2020 2074 732e 7374 6174 6520 3d20 2271     ts.state = "q
-00017d20: 7565 7565 6422 0a20 2020 2020 2020 2073  ueued".        s
-00017d30: 656c 662e 7175 6575 6564 2e61 6464 2874  elf.queued.add(t
-00017d40: 7329 0a0a 2020 2020 2020 2020 7265 7475  s)..        retu
-00017d50: 726e 207b 7d2c 207b 7d2c 207b 7d0a 0a20  rn {}, {}, {}.. 
-00017d60: 2020 2064 6566 205f 7472 616e 7369 7469     def _transiti
-00017d70: 6f6e 5f77 6169 7469 6e67 5f6e 6f5f 776f  on_waiting_no_wo
-00017d80: 726b 6572 2873 656c 662c 206b 6579 3a20  rker(self, key: 
-00017d90: 4b65 792c 2073 7469 6d75 6c75 735f 6964  Key, stimulus_id
-00017da0: 3a20 7374 7229 202d 3e20 5265 6373 4d73  : str) -> RecsMs
-00017db0: 6773 3a0a 2020 2020 2020 2020 7473 203d  gs:.        ts =
-00017dc0: 2073 656c 662e 7461 736b 735b 6b65 795d   self.tasks[key]
-00017dd0: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
-00017de0: 662e 7661 6c69 6461 7465 3a0a 2020 2020  f.validate:.    
-00017df0: 2020 2020 2020 2020 7365 6c66 2e5f 7661          self._va
-00017e00: 6c69 6461 7465 5f72 6561 6479 2874 7329  lidate_ready(ts)
-00017e10: 0a0a 2020 2020 2020 2020 7473 2e73 7461  ..        ts.sta
-00017e20: 7465 203d 2022 6e6f 2d77 6f72 6b65 7222  te = "no-worker"
-00017e30: 0a20 2020 2020 2020 2073 656c 662e 756e  .        self.un
-00017e40: 7275 6e6e 6162 6c65 2e61 6464 2874 7329  runnable.add(ts)
-00017e50: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00017e60: 207b 7d2c 207b 7d2c 207b 7d0a 0a20 2020   {}, {}, {}..   
-00017e70: 2064 6566 205f 7472 616e 7369 7469 6f6e   def _transition
-00017e80: 5f71 7565 7565 645f 7265 6c65 6173 6564  _queued_released
-00017e90: 2873 656c 662c 206b 6579 3a20 4b65 792c  (self, key: Key,
-00017ea0: 2073 7469 6d75 6c75 735f 6964 3a20 7374   stimulus_id: st
-00017eb0: 7229 202d 3e20 5265 6373 4d73 6773 3a0a  r) -> RecsMsgs:.
-00017ec0: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
-00017ed0: 662e 7461 736b 735b 6b65 795d 0a0a 2020  f.tasks[key]..  
-00017ee0: 2020 2020 2020 6966 2073 656c 662e 7661        if self.va
-00017ef0: 6c69 6461 7465 3a0a 2020 2020 2020 2020  lidate:.        
-00017f00: 2020 2020 6173 7365 7274 2074 7320 696e      assert ts in
-00017f10: 2073 656c 662e 7175 6575 6564 0a20 2020   self.queued.   
-00017f20: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00017f30: 6e6f 7420 7473 2e70 726f 6365 7373 696e  not ts.processin
-00017f40: 675f 6f6e 0a0a 2020 2020 2020 2020 7365  g_on..        se
-00017f50: 6c66 2e71 7565 7565 642e 7265 6d6f 7665  lf.queued.remove
-00017f60: 2874 7329 0a0a 2020 2020 2020 2020 7265  (ts)..        re
-00017f70: 636f 6d6d 656e 6461 7469 6f6e 733a 2052  commendations: R
-00017f80: 6563 7320 3d20 7b7d 0a20 2020 2020 2020  ecs = {}.       
-00017f90: 2073 656c 662e 5f70 726f 7061 6761 7465   self._propagate
-00017fa0: 5f72 656c 6561 7365 6428 7473 2c20 7265  _released(ts, re
-00017fb0: 636f 6d6d 656e 6461 7469 6f6e 7329 0a20  commendations). 
-00017fc0: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
-00017fd0: 636f 6d6d 656e 6461 7469 6f6e 732c 207b  commendations, {
-00017fe0: 7d2c 207b 7d0a 0a20 2020 2064 6566 205f  }, {}..    def _
-00017ff0: 7472 616e 7369 7469 6f6e 5f71 7565 7565  transition_queue
-00018000: 645f 7072 6f63 6573 7369 6e67 2873 656c  d_processing(sel
-00018010: 662c 206b 6579 3a20 4b65 792c 2073 7469  f, key: Key, sti
-00018020: 6d75 6c75 735f 6964 3a20 7374 7229 202d  mulus_id: str) -
-00018030: 3e20 5265 6373 4d73 6773 3a0a 2020 2020  > RecsMsgs:.    
-00018040: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
-00018050: 736b 735b 6b65 795d 0a0a 2020 2020 2020  sks[key]..      
-00018060: 2020 6966 2073 656c 662e 7661 6c69 6461    if self.valida
-00018070: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
-00018080: 6173 7365 7274 206e 6f74 2074 732e 6163  assert not ts.ac
-00018090: 746f 722c 2066 2241 6374 6f72 7320 6361  tor, f"Actors ca
-000180a0: 6e27 7420 6265 2071 7565 7565 643a 207b  n't be queued: {
-000180b0: 7473 7d22 0a20 2020 2020 2020 2020 2020  ts}".           
-000180c0: 2061 7373 6572 7420 7473 2069 6e20 7365   assert ts in se
-000180d0: 6c66 2e71 7565 7565 640a 0a20 2020 2020  lf.queued..     
-000180e0: 2020 2069 6620 7773 203a 3d20 7365 6c66     if ws := self
-000180f0: 2e64 6563 6964 655f 776f 726b 6572 5f72  .decide_worker_r
-00018100: 6f6f 7469 7368 5f71 7565 7569 6e67 5f65  ootish_queuing_e
-00018110: 6e61 626c 6564 2829 3a0a 2020 2020 2020  nabled():.      
-00018120: 2020 2020 2020 7365 6c66 2e71 7565 7565        self.queue
-00018130: 642e 6469 7363 6172 6428 7473 290a 2020  d.discard(ts).  
-00018140: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00018150: 2073 656c 662e 5f61 6464 5f74 6f5f 7072   self._add_to_pr
-00018160: 6f63 6573 7369 6e67 2874 732c 2077 732c  ocessing(ts, ws,
-00018170: 2073 7469 6d75 6c75 735f 6964 3d73 7469   stimulus_id=sti
-00018180: 6d75 6c75 735f 6964 290a 2020 2020 2020  mulus_id).      
-00018190: 2020 2320 4966 206e 6f20 776f 726b 6572    # If no worker
-000181a0: 2c20 7461 736b 206a 7573 7420 7374 6179  , task just stay
-000181b0: 7320 6071 7565 7565 6460 0a20 2020 2020  s `queued`.     
-000181c0: 2020 2072 6574 7572 6e20 7b7d 2c20 7b7d     return {}, {}
-000181d0: 2c20 7b7d 0a0a 2020 2020 6465 6620 5f72  , {}..    def _r
-000181e0: 656d 6f76 655f 6b65 7928 7365 6c66 2c20  emove_key(self, 
-000181f0: 6b65 793a 204b 6579 2920 2d3e 204e 6f6e  key: Key) -> Non
-00018200: 653a 0a20 2020 2020 2020 2074 7320 3d20  e:.        ts = 
-00018210: 7365 6c66 2e74 6173 6b73 2e70 6f70 286b  self.tasks.pop(k
-00018220: 6579 290a 2020 2020 2020 2020 6173 7365  ey).        asse
-00018230: 7274 2074 732e 7374 6174 6520 3d3d 2022  rt ts.state == "
-00018240: 666f 7267 6f74 7465 6e22 0a20 2020 2020  forgotten".     
-00018250: 2020 2073 656c 662e 756e 7275 6e6e 6162     self.unrunnab
-00018260: 6c65 2e64 6973 6361 7264 2874 7329 0a20  le.discard(ts). 
-00018270: 2020 2020 2020 2066 6f72 2063 7320 696e         for cs in
-00018280: 2074 732e 7768 6f5f 7761 6e74 7320 6f72   ts.who_wants or
-00018290: 2028 293a 0a20 2020 2020 2020 2020 2020   ():.           
-000182a0: 2063 732e 7761 6e74 735f 7768 6174 2e72   cs.wants_what.r
-000182b0: 656d 6f76 6528 7473 290a 2020 2020 2020  emove(ts).      
-000182c0: 2020 7473 2e77 686f 5f77 616e 7473 203d    ts.who_wants =
-000182d0: 204e 6f6e 650a 2020 2020 2020 2020 7473   None.        ts
-000182e0: 2e70 726f 6365 7373 696e 675f 6f6e 203d  .processing_on =
-000182f0: 204e 6f6e 650a 2020 2020 2020 2020 7473   None.        ts
-00018300: 2e65 7863 6570 7469 6f6e 5f62 6c61 6d65  .exception_blame
-00018310: 203d 2074 732e 6578 6365 7074 696f 6e20   = ts.exception 
-00018320: 3d20 7473 2e74 7261 6365 6261 636b 203d  = ts.traceback =
-00018330: 204e 6f6e 650a 2020 2020 2020 2020 7365   None.        se
-00018340: 6c66 2e74 6173 6b5f 6d65 7461 6461 7461  lf.task_metadata
-00018350: 2e70 6f70 286b 6579 2c20 4e6f 6e65 290a  .pop(key, None).
-00018360: 0a20 2020 2064 6566 205f 7472 616e 7369  .    def _transi
-00018370: 7469 6f6e 5f6d 656d 6f72 795f 666f 7267  tion_memory_forg
-00018380: 6f74 7465 6e28 7365 6c66 2c20 6b65 793a  otten(self, key:
-00018390: 204b 6579 2c20 7374 696d 756c 7573 5f69   Key, stimulus_i
-000183a0: 643a 2073 7472 2920 2d3e 2052 6563 734d  d: str) -> RecsM
-000183b0: 7367 733a 0a20 2020 2020 2020 2074 7320  sgs:.        ts 
-000183c0: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
-000183d0: 5d0a 0a20 2020 2020 2020 2069 6620 7365  ]..        if se
-000183e0: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
-000183f0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00018400: 7473 2e73 7461 7465 203d 3d20 226d 656d  ts.state == "mem
-00018410: 6f72 7922 0a20 2020 2020 2020 2020 2020  ory".           
-00018420: 2061 7373 6572 7420 6e6f 7420 7473 2e70   assert not ts.p
-00018430: 726f 6365 7373 696e 675f 6f6e 0a20 2020  rocessing_on.   
-00018440: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00018450: 6e6f 7420 7473 2e77 6169 7469 6e67 5f6f  not ts.waiting_o
-00018460: 6e0a 2020 2020 2020 2020 2020 2020 6966  n.            if
-00018470: 206e 6f74 2074 732e 7275 6e5f 7370 6563   not ts.run_spec
-00018480: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00018490: 2020 2320 4974 2773 206f 6b20 746f 2066    # It's ok to f
-000184a0: 6f72 6765 7420 6120 7075 7265 2064 6174  orget a pure dat
-000184b0: 6120 7461 736b 0a20 2020 2020 2020 2020  a task.         
-000184c0: 2020 2020 2020 2070 6173 730a 2020 2020         pass.    
-000184d0: 2020 2020 2020 2020 656c 6966 2074 732e          elif ts.
-000184e0: 6861 735f 6c6f 7374 5f64 6570 656e 6465  has_lost_depende
-000184f0: 6e63 6965 733a 0a20 2020 2020 2020 2020  ncies:.         
-00018500: 2020 2020 2020 2023 2049 7427 7320 6f6b         # It's ok
-00018510: 2074 6f20 666f 7267 6574 2061 2074 6173   to forget a tas
-00018520: 6b20 7769 7468 2066 6f72 676f 7474 656e  k with forgotten
-00018530: 2064 6570 656e 6465 6e63 6965 730a 2020   dependencies.  
-00018540: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-00018550: 7373 0a20 2020 2020 2020 2020 2020 2065  ss.            e
-00018560: 6c69 6620 6e6f 7420 7473 2e77 686f 5f77  lif not ts.who_w
-00018570: 616e 7473 2061 6e64 206e 6f74 2074 732e  ants and not ts.
-00018580: 7761 6974 6572 7320 616e 6420 6e6f 7420  waiters and not 
-00018590: 7473 2e64 6570 656e 6465 6e74 733a 0a20  ts.dependents:. 
-000185a0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000185b0: 2049 7427 7320 6f6b 2074 6f20 666f 7267   It's ok to forg
-000185c0: 6574 2061 2074 6173 6b20 7468 6174 206e  et a task that n
-000185d0: 6f62 6f64 7920 6e65 6564 730a 2020 2020  obody needs.    
-000185e0: 2020 2020 2020 2020 2020 2020 7061 7373              pass
-000185f0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00018600: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00018610: 2020 2072 6169 7365 2041 7373 6572 7469     raise Asserti
-00018620: 6f6e 4572 726f 7228 2255 6e72 6561 6368  onError("Unreach
-00018630: 6162 6c65 222c 2073 7472 2874 7329 2920  able", str(ts)) 
-00018640: 2023 2070 7261 676d 613a 206e 6f63 6f76   # pragma: nocov
-00018650: 6572 0a0a 2020 2020 2020 2020 6966 2074  er..        if t
-00018660: 732e 6163 746f 723a 0a20 2020 2020 2020  s.actor:.       
-00018670: 2020 2020 2066 6f72 2077 7320 696e 2074       for ws in t
-00018680: 732e 7768 6f5f 6861 7320 6f72 2028 293a  s.who_has or ():
-00018690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000186a0: 2077 732e 6163 746f 7273 2e64 6973 6361   ws.actors.disca
-000186b0: 7264 2874 7329 0a0a 2020 2020 2020 2020  rd(ts)..        
-000186c0: 7265 636f 6d6d 656e 6461 7469 6f6e 733a  recommendations:
-000186d0: 2052 6563 7320 3d20 7b7d 0a20 2020 2020   Recs = {}.     
-000186e0: 2020 2077 6f72 6b65 725f 6d73 6773 3a20     worker_msgs: 
-000186f0: 4d73 6773 203d 207b 7d0a 2020 2020 2020  Msgs = {}.      
-00018700: 2020 7365 6c66 2e5f 7072 6f70 6167 6174    self._propagat
-00018710: 655f 666f 7267 6f74 7465 6e28 7473 2c20  e_forgotten(ts, 
-00018720: 7265 636f 6d6d 656e 6461 7469 6f6e 732c  recommendations,
-00018730: 2077 6f72 6b65 725f 6d73 6773 2c20 7374   worker_msgs, st
-00018740: 696d 756c 7573 5f69 6429 0a0a 2020 2020  imulus_id)..    
-00018750: 2020 2020 636c 6965 6e74 5f6d 7367 7320      client_msgs 
-00018760: 3d20 5f74 6173 6b5f 746f 5f63 6c69 656e  = _task_to_clien
-00018770: 745f 6d73 6773 2874 7329 0a20 2020 2020  t_msgs(ts).     
-00018780: 2020 2073 656c 662e 5f72 656d 6f76 655f     self._remove_
-00018790: 6b65 7928 6b65 7929 0a0a 2020 2020 2020  key(key)..      
-000187a0: 2020 7265 7475 726e 2072 6563 6f6d 6d65    return recomme
-000187b0: 6e64 6174 696f 6e73 2c20 636c 6965 6e74  ndations, client
-000187c0: 5f6d 7367 732c 2077 6f72 6b65 725f 6d73  _msgs, worker_ms
-000187d0: 6773 0a0a 2020 2020 6465 6620 5f74 7261  gs..    def _tra
-000187e0: 6e73 6974 696f 6e5f 7265 6c65 6173 6564  nsition_released
-000187f0: 5f66 6f72 676f 7474 656e 2873 656c 662c  _forgotten(self,
-00018800: 206b 6579 3a20 4b65 792c 2073 7469 6d75   key: Key, stimu
-00018810: 6c75 735f 6964 3a20 7374 7229 202d 3e20  lus_id: str) -> 
-00018820: 5265 6373 4d73 6773 3a0a 2020 2020 2020  RecsMsgs:.      
-00018830: 2020 7473 203d 2073 656c 662e 7461 736b    ts = self.task
-00018840: 735b 6b65 795d 0a0a 2020 2020 2020 2020  s[key]..        
-00018850: 6966 2073 656c 662e 7661 6c69 6461 7465  if self.validate
-00018860: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
-00018870: 7365 7274 2074 732e 7374 6174 6520 696e  sert ts.state in
-00018880: 2028 2272 656c 6561 7365 6422 2c20 2265   ("released", "e
-00018890: 7272 6564 2229 0a20 2020 2020 2020 2020  rred").         
-000188a0: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
-000188b0: 2e77 686f 5f68 6173 0a20 2020 2020 2020  .who_has.       
-000188c0: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-000188d0: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
-000188e0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-000188f0: 6572 7420 7473 206e 6f74 2069 6e20 7365  ert ts not in se
-00018900: 6c66 2e71 7565 7565 640a 2020 2020 2020  lf.queued.      
-00018910: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
-00018920: 2074 732e 7761 6974 696e 675f 6f6e 2c20   ts.waiting_on, 
-00018930: 2874 732c 2074 732e 7761 6974 696e 675f  (ts, ts.waiting_
-00018940: 6f6e 290a 2020 2020 2020 2020 2020 2020  on).            
-00018950: 6966 206e 6f74 2074 732e 7275 6e5f 7370  if not ts.run_sp
-00018960: 6563 3a0a 2020 2020 2020 2020 2020 2020  ec:.            
-00018970: 2020 2020 2320 4974 2773 206f 6b20 746f      # It's ok to
-00018980: 2066 6f72 6765 7420 6120 7075 7265 2064   forget a pure d
-00018990: 6174 6120 7461 736b 0a20 2020 2020 2020  ata task.       
-000189a0: 2020 2020 2020 2020 2070 6173 730a 2020           pass.  
-000189b0: 2020 2020 2020 2020 2020 656c 6966 2074            elif t
-000189c0: 732e 6861 735f 6c6f 7374 5f64 6570 656e  s.has_lost_depen
-000189d0: 6465 6e63 6965 733a 0a20 2020 2020 2020  dencies:.       
-000189e0: 2020 2020 2020 2020 2023 2049 7427 7320           # It's 
-000189f0: 6f6b 2074 6f20 666f 7267 6574 2061 2074  ok to forget a t
-00018a00: 6173 6b20 7769 7468 2066 6f72 676f 7474  ask with forgott
-00018a10: 656e 2064 6570 656e 6465 6e63 6965 730a  en dependencies.
-00018a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018a30: 7061 7373 0a20 2020 2020 2020 2020 2020  pass.           
-00018a40: 2065 6c69 6620 6e6f 7420 7473 2e77 686f   elif not ts.who
-00018a50: 5f77 616e 7473 2061 6e64 206e 6f74 2074  _wants and not t
-00018a60: 732e 7761 6974 6572 7320 616e 6420 6e6f  s.waiters and no
-00018a70: 7420 7473 2e64 6570 656e 6465 6e74 733a  t ts.dependents:
-00018a80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018a90: 2023 2049 7427 7320 6f6b 2074 6f20 666f   # It's ok to fo
-00018aa0: 7267 6574 2061 2074 6173 6b20 7468 6174  rget a task that
-00018ab0: 206e 6f62 6f64 7920 6e65 6564 730a 2020   nobody needs.  
-00018ac0: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-00018ad0: 7373 0a20 2020 2020 2020 2020 2020 2065  ss.            e
-00018ae0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00018af0: 2020 2020 2072 6169 7365 2041 7373 6572       raise Asser
-00018b00: 7469 6f6e 4572 726f 7228 2255 6e72 6561  tionError("Unrea
-00018b10: 6368 6162 6c65 222c 2073 7472 2874 7329  chable", str(ts)
-00018b20: 2920 2023 2070 7261 676d 613a 206e 6f63  )  # pragma: noc
-00018b30: 6f76 6572 0a0a 2020 2020 2020 2020 7265  over..        re
-00018b40: 636f 6d6d 656e 6461 7469 6f6e 733a 2052  commendations: R
-00018b50: 6563 7320 3d20 7b7d 0a20 2020 2020 2020  ecs = {}.       
-00018b60: 2077 6f72 6b65 725f 6d73 6773 3a20 4d73   worker_msgs: Ms
-00018b70: 6773 203d 207b 7d0a 2020 2020 2020 2020  gs = {}.        
-00018b80: 7365 6c66 2e5f 7072 6f70 6167 6174 655f  self._propagate_
-00018b90: 666f 7267 6f74 7465 6e28 7473 2c20 7265  forgotten(ts, re
-00018ba0: 636f 6d6d 656e 6461 7469 6f6e 732c 2077  commendations, w
-00018bb0: 6f72 6b65 725f 6d73 6773 2c20 7374 696d  orker_msgs, stim
-00018bc0: 756c 7573 5f69 6429 0a0a 2020 2020 2020  ulus_id)..      
-00018bd0: 2020 636c 6965 6e74 5f6d 7367 7320 3d20    client_msgs = 
-00018be0: 5f74 6173 6b5f 746f 5f63 6c69 656e 745f  _task_to_client_
-00018bf0: 6d73 6773 2874 7329 0a20 2020 2020 2020  msgs(ts).       
-00018c00: 2073 656c 662e 5f72 656d 6f76 655f 6b65   self._remove_ke
-00018c10: 7928 6b65 7929 0a0a 2020 2020 2020 2020  y(key)..        
-00018c20: 7265 7475 726e 2072 6563 6f6d 6d65 6e64  return recommend
-00018c30: 6174 696f 6e73 2c20 636c 6965 6e74 5f6d  ations, client_m
-00018c40: 7367 732c 2077 6f72 6b65 725f 6d73 6773  sgs, worker_msgs
-00018c50: 0a0a 2020 2020 2320 7b0a 2020 2020 2320  ..    # {.    # 
-00018c60: 2020 2020 2873 7461 7274 2c20 6669 6e69      (start, fini
-00018c70: 7368 293a 0a20 2020 2023 2020 2020 2074  sh):.    #     t
-00018c80: 7261 6e73 6974 696f 6e5f 3c73 7461 7274  ransition_<start
-00018c90: 3e5f 3c66 696e 6973 683e 280a 2020 2020  >_<finish>(.    
-00018ca0: 2320 2020 2020 2020 2020 7365 6c66 2c20  #         self, 
-00018cb0: 6b65 793a 204b 6579 2c20 7374 696d 756c  key: Key, stimul
-00018cc0: 7573 5f69 643a 2073 7472 2c20 2a2a 6b77  us_id: str, **kw
-00018cd0: 6172 6773 0a20 2020 2023 2020 2020 2029  args.    #     )
-00018ce0: 202d 3e20 2872 6563 6f6d 6d65 6e64 6174   -> (recommendat
-00018cf0: 696f 6e73 2c20 636c 6965 6e74 5f6d 7367  ions, client_msg
-00018d00: 732c 2077 6f72 6b65 725f 6d73 6773 290a  s, worker_msgs).
-00018d10: 2020 2020 2320 7d0a 2020 2020 5f54 5241      # }.    _TRA
-00018d20: 4e53 4954 494f 4e53 5f54 4142 4c45 3a20  NSITIONS_TABLE: 
-00018d30: 436c 6173 7356 6172 5b0a 2020 2020 2020  ClassVar[.      
-00018d40: 2020 4d61 7070 696e 675b 0a20 2020 2020    Mapping[.     
-00018d50: 2020 2020 2020 2074 7570 6c65 5b54 6173         tuple[Tas
-00018d60: 6b53 7461 7465 5374 6174 652c 2054 6173  kStateState, Tas
-00018d70: 6b53 7461 7465 5374 6174 655d 2c0a 2020  kStateState],.  
-00018d80: 2020 2020 2020 2020 2020 4361 6c6c 6162            Callab
-00018d90: 6c65 5b2e 2e2e 2c20 5265 6373 4d73 6773  le[..., RecsMsgs
-00018da0: 5d2c 0a20 2020 2020 2020 205d 0a20 2020  ],.        ].   
-00018db0: 205d 203d 207b 0a20 2020 2020 2020 2028   ] = {.        (
-00018dc0: 2272 656c 6561 7365 6422 2c20 2277 6169  "released", "wai
-00018dd0: 7469 6e67 2229 3a20 5f74 7261 6e73 6974  ting"): _transit
-00018de0: 696f 6e5f 7265 6c65 6173 6564 5f77 6169  ion_released_wai
-00018df0: 7469 6e67 2c0a 2020 2020 2020 2020 2822  ting,.        ("
-00018e00: 7761 6974 696e 6722 2c20 2272 656c 6561  waiting", "relea
-00018e10: 7365 6422 293a 205f 7472 616e 7369 7469  sed"): _transiti
-00018e20: 6f6e 5f77 6169 7469 6e67 5f72 656c 6561  on_waiting_relea
-00018e30: 7365 642c 0a20 2020 2020 2020 2028 2277  sed,.        ("w
-00018e40: 6169 7469 6e67 222c 2022 7072 6f63 6573  aiting", "proces
-00018e50: 7369 6e67 2229 3a20 5f74 7261 6e73 6974  sing"): _transit
-00018e60: 696f 6e5f 7761 6974 696e 675f 7072 6f63  ion_waiting_proc
-00018e70: 6573 7369 6e67 2c0a 2020 2020 2020 2020  essing,.        
-00018e80: 2822 7761 6974 696e 6722 2c20 226e 6f2d  ("waiting", "no-
-00018e90: 776f 726b 6572 2229 3a20 5f74 7261 6e73  worker"): _trans
-00018ea0: 6974 696f 6e5f 7761 6974 696e 675f 6e6f  ition_waiting_no
-00018eb0: 5f77 6f72 6b65 722c 0a20 2020 2020 2020  _worker,.       
-00018ec0: 2028 2277 6169 7469 6e67 222c 2022 7175   ("waiting", "qu
-00018ed0: 6575 6564 2229 3a20 5f74 7261 6e73 6974  eued"): _transit
-00018ee0: 696f 6e5f 7761 6974 696e 675f 7175 6575  ion_waiting_queu
-00018ef0: 6564 2c0a 2020 2020 2020 2020 2822 7761  ed,.        ("wa
-00018f00: 6974 696e 6722 2c20 226d 656d 6f72 7922  iting", "memory"
-00018f10: 293a 205f 7472 616e 7369 7469 6f6e 5f77  ): _transition_w
-00018f20: 6169 7469 6e67 5f6d 656d 6f72 792c 0a20  aiting_memory,. 
-00018f30: 2020 2020 2020 2028 2271 7565 7565 6422         ("queued"
-00018f40: 2c20 2272 656c 6561 7365 6422 293a 205f  , "released"): _
-00018f50: 7472 616e 7369 7469 6f6e 5f71 7565 7565  transition_queue
-00018f60: 645f 7265 6c65 6173 6564 2c0a 2020 2020  d_released,.    
-00018f70: 2020 2020 2822 7175 6575 6564 222c 2022      ("queued", "
-00018f80: 7072 6f63 6573 7369 6e67 2229 3a20 5f74  processing"): _t
-00018f90: 7261 6e73 6974 696f 6e5f 7175 6575 6564  ransition_queued
-00018fa0: 5f70 726f 6365 7373 696e 672c 0a20 2020  _processing,.   
-00018fb0: 2020 2020 2028 2270 726f 6365 7373 696e       ("processin
-00018fc0: 6722 2c20 2272 656c 6561 7365 6422 293a  g", "released"):
-00018fd0: 205f 7472 616e 7369 7469 6f6e 5f70 726f   _transition_pro
-00018fe0: 6365 7373 696e 675f 7265 6c65 6173 6564  cessing_released
-00018ff0: 2c0a 2020 2020 2020 2020 2822 7072 6f63  ,.        ("proc
-00019000: 6573 7369 6e67 222c 2022 6d65 6d6f 7279  essing", "memory
-00019010: 2229 3a20 5f74 7261 6e73 6974 696f 6e5f  "): _transition_
-00019020: 7072 6f63 6573 7369 6e67 5f6d 656d 6f72  processing_memor
-00019030: 792c 0a20 2020 2020 2020 2028 2270 726f  y,.        ("pro
-00019040: 6365 7373 696e 6722 2c20 2265 7272 6564  cessing", "erred
-00019050: 2229 3a20 5f74 7261 6e73 6974 696f 6e5f  "): _transition_
-00019060: 7072 6f63 6573 7369 6e67 5f65 7272 6564  processing_erred
-00019070: 2c0a 2020 2020 2020 2020 2822 6e6f 2d77  ,.        ("no-w
-00019080: 6f72 6b65 7222 2c20 2272 656c 6561 7365  orker", "release
-00019090: 6422 293a 205f 7472 616e 7369 7469 6f6e  d"): _transition
-000190a0: 5f6e 6f5f 776f 726b 6572 5f72 656c 6561  _no_worker_relea
-000190b0: 7365 642c 0a20 2020 2020 2020 2028 226e  sed,.        ("n
-000190c0: 6f2d 776f 726b 6572 222c 2022 7072 6f63  o-worker", "proc
-000190d0: 6573 7369 6e67 2229 3a20 5f74 7261 6e73  essing"): _trans
-000190e0: 6974 696f 6e5f 6e6f 5f77 6f72 6b65 725f  ition_no_worker_
-000190f0: 7072 6f63 6573 7369 6e67 2c0a 2020 2020  processing,.    
-00019100: 2020 2020 2822 7265 6c65 6173 6564 222c      ("released",
-00019110: 2022 666f 7267 6f74 7465 6e22 293a 205f   "forgotten"): _
-00019120: 7472 616e 7369 7469 6f6e 5f72 656c 6561  transition_relea
-00019130: 7365 645f 666f 7267 6f74 7465 6e2c 0a20  sed_forgotten,. 
-00019140: 2020 2020 2020 2028 226d 656d 6f72 7922         ("memory"
-00019150: 2c20 2266 6f72 676f 7474 656e 2229 3a20  , "forgotten"): 
-00019160: 5f74 7261 6e73 6974 696f 6e5f 6d65 6d6f  _transition_memo
-00019170: 7279 5f66 6f72 676f 7474 656e 2c0a 2020  ry_forgotten,.  
-00019180: 2020 2020 2020 2822 6572 7265 6422 2c20        ("erred", 
-00019190: 2272 656c 6561 7365 6422 293a 205f 7472  "released"): _tr
-000191a0: 616e 7369 7469 6f6e 5f65 7272 6564 5f72  ansition_erred_r
-000191b0: 656c 6561 7365 642c 0a20 2020 2020 2020  eleased,.       
-000191c0: 2028 226d 656d 6f72 7922 2c20 2272 656c   ("memory", "rel
-000191d0: 6561 7365 6422 293a 205f 7472 616e 7369  eased"): _transi
-000191e0: 7469 6f6e 5f6d 656d 6f72 795f 7265 6c65  tion_memory_rele
-000191f0: 6173 6564 2c0a 2020 2020 2020 2020 2822  ased,.        ("
-00019200: 7265 6c65 6173 6564 222c 2022 6572 7265  released", "erre
-00019210: 6422 293a 205f 7472 616e 7369 7469 6f6e  d"): _transition
-00019220: 5f72 656c 6561 7365 645f 6572 7265 642c  _released_erred,
-00019230: 0a20 2020 207d 0a0a 2020 2020 6465 6620  .    }..    def 
-00019240: 7374 6f72 7928 0a20 2020 2020 2020 2073  story(.        s
-00019250: 656c 662c 202a 6b65 7973 5f6f 725f 7461  elf, *keys_or_ta
-00019260: 736b 735f 6f72 5f73 7469 6d75 6c69 3a20  sks_or_stimuli: 
-00019270: 4b65 7920 7c20 5461 736b 5374 6174 6520  Key | TaskState 
-00019280: 7c20 7374 720a 2020 2020 2920 2d3e 206c  | str.    ) -> l
-00019290: 6973 745b 5472 616e 7369 7469 6f6e 5d3a  ist[Transition]:
-000192a0: 0a20 2020 2020 2020 2022 2222 4765 7420  .        """Get 
-000192b0: 616c 6c20 7472 616e 7369 7469 6f6e 7320  all transitions 
-000192c0: 7468 6174 2074 6f75 6368 206f 6e65 206f  that touch one o
-000192d0: 6620 7468 6520 696e 7075 7420 6b65 7973  f the input keys
-000192e0: 206f 7220 7374 696d 756c 7573 5f69 6427   or stimulus_id'
-000192f0: 7322 2222 0a20 2020 2020 2020 206b 6579  s""".        key
-00019300: 735f 6f72 5f73 7469 6d75 6c69 203d 207b  s_or_stimuli = {
-00019310: 0a20 2020 2020 2020 2020 2020 206b 6579  .            key
-00019320: 2e6b 6579 2069 6620 6973 696e 7374 616e  .key if isinstan
-00019330: 6365 286b 6579 2c20 5461 736b 5374 6174  ce(key, TaskStat
-00019340: 6529 2065 6c73 6520 6b65 790a 2020 2020  e) else key.    
-00019350: 2020 2020 2020 2020 666f 7220 6b65 7920          for key 
-00019360: 696e 206b 6579 735f 6f72 5f74 6173 6b73  in keys_or_tasks
-00019370: 5f6f 725f 7374 696d 756c 690a 2020 2020  _or_stimuli.    
-00019380: 2020 2020 7d0a 2020 2020 2020 2020 7265      }.        re
-00019390: 7475 726e 2073 6368 6564 756c 6572 5f73  turn scheduler_s
-000193a0: 746f 7279 286b 6579 735f 6f72 5f73 7469  tory(keys_or_sti
-000193b0: 6d75 6c69 2c20 7365 6c66 2e74 7261 6e73  muli, self.trans
-000193c0: 6974 696f 6e5f 6c6f 6729 0a0a 2020 2020  ition_log)..    
-000193d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000193e0: 2323 2323 2323 2323 2323 2323 2323 0a20  ##############. 
-000193f0: 2020 2023 2041 7373 6967 6e69 6e67 2054     # Assigning T
-00019400: 6173 6b73 2074 6f20 576f 726b 6572 7320  asks to Workers 
-00019410: 230a 2020 2020 2323 2323 2323 2323 2323  #.    ##########
-00019420: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019430: 2323 2323 0a0a 2020 2020 6465 6620 6973  ####..    def is
-00019440: 5f72 6f6f 7469 7368 2873 656c 662c 2074  _rootish(self, t
-00019450: 733a 2054 6173 6b53 7461 7465 2920 2d3e  s: TaskState) ->
-00019460: 2062 6f6f 6c3a 0a20 2020 2020 2020 2022   bool:.        "
-00019470: 2222 0a20 2020 2020 2020 2057 6865 7468  "".        Wheth
-00019480: 6572 2060 6074 7360 6020 6973 2061 2072  er ``ts`` is a r
-00019490: 6f6f 7420 6f72 2072 6f6f 742d 6c69 6b65  oot or root-like
-000194a0: 2074 6173 6b2e 0a0a 2020 2020 2020 2020   task...        
-000194b0: 526f 6f74 2d69 7368 2074 6173 6b73 2061  Root-ish tasks a
-000194c0: 7265 2070 6172 7420 6f66 2061 2067 726f  re part of a gro
-000194d0: 7570 2074 6861 7427 7320 6d75 6368 206c  up that's much l
-000194e0: 6172 6765 7220 7468 616e 2074 6865 2063  arger than the c
-000194f0: 6c75 7374 6572 2c0a 2020 2020 2020 2020  luster,.        
-00019500: 616e 6420 6861 7665 2066 6577 206f 7220  and have few or 
-00019510: 6e6f 2064 6570 656e 6465 6e63 6965 732e  no dependencies.
-00019520: 2054 6173 6b73 206d 6179 2061 6c73 6f20   Tasks may also 
-00019530: 6265 2065 7870 6c69 6369 746c 7920 6d61  be explicitly ma
-00019540: 726b 6564 2061 7320 726f 6f74 6973 680a  rked as rootish.
-00019550: 2020 2020 2020 2020 746f 206f 7665 7272          to overr
-00019560: 6964 6520 7468 6973 2068 6575 7269 7374  ide this heurist
-00019570: 6963 2e0a 2020 2020 2020 2020 2222 220a  ic..        """.
-00019580: 2020 2020 2020 2020 6966 2074 732e 5f72          if ts._r
-00019590: 6f6f 7469 7368 2069 7320 6e6f 7420 4e6f  ootish is not No
-000195a0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-000195b0: 7265 7475 726e 2074 732e 5f72 6f6f 7469  return ts._rooti
-000195c0: 7368 0a20 2020 2020 2020 2069 6620 7473  sh.        if ts
-000195d0: 2e72 6573 6f75 7263 655f 7265 7374 7269  .resource_restri
-000195e0: 6374 696f 6e73 206f 7220 7473 2e77 6f72  ctions or ts.wor
-000195f0: 6b65 725f 7265 7374 7269 6374 696f 6e73  ker_restrictions
-00019600: 206f 7220 7473 2e68 6f73 745f 7265 7374   or ts.host_rest
-00019610: 7269 6374 696f 6e73 3a0a 2020 2020 2020  rictions:.      
-00019620: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
-00019630: 7365 0a20 2020 2020 2020 2074 6720 3d20  se.        tg = 
-00019640: 7473 2e67 726f 7570 0a20 2020 2020 2020  ts.group.       
-00019650: 2023 2054 4f44 4f20 7368 6f72 742d 6369   # TODO short-ci
-00019660: 7263 7569 7420 746f 2054 7275 6520 6966  rcuit to True if
-00019670: 2060 6e6f 7420 7473 2e64 6570 656e 6465   `not ts.depende
-00019680: 6e63 6965 7360 3f0a 2020 2020 2020 2020  ncies`?.        
-00019690: 7265 7475 726e 2028 0a20 2020 2020 2020  return (.       
-000196a0: 2020 2020 206c 656e 2874 6729 203e 2073       len(tg) > s
-000196b0: 656c 662e 746f 7461 6c5f 6e74 6872 6561  elf.total_nthrea
-000196c0: 6473 202a 2032 0a20 2020 2020 2020 2020  ds * 2.         
-000196d0: 2020 2061 6e64 206c 656e 2874 672e 6465     and len(tg.de
-000196e0: 7065 6e64 656e 6369 6573 2920 3c20 350a  pendencies) < 5.
-000196f0: 2020 2020 2020 2020 2020 2020 616e 6420              and 
-00019700: 7375 6d28 6d61 7028 6c65 6e2c 2074 672e  sum(map(len, tg.
-00019710: 6465 7065 6e64 656e 6369 6573 2929 203c  dependencies)) <
-00019720: 2035 0a20 2020 2020 2020 2029 0a0a 2020   5.        )..  
-00019730: 2020 6465 6620 6368 6563 6b5f 6964 6c65    def check_idle
-00019740: 5f73 6174 7572 6174 6564 2873 656c 662c  _saturated(self,
-00019750: 2077 733a 2057 6f72 6b65 7253 7461 7465   ws: WorkerState
-00019760: 2c20 6f63 633a 2066 6c6f 6174 203d 202d  , occ: float = -
-00019770: 312e 3029 202d 3e20 4e6f 6e65 3a0a 2020  1.0) -> None:.  
-00019780: 2020 2020 2020 2222 2255 7064 6174 6520        """Update 
-00019790: 7468 6520 7374 6174 7573 206f 6620 7468  the status of th
-000197a0: 6520 6964 6c65 2061 6e64 2073 6174 7572  e idle and satur
-000197b0: 6174 6564 2073 7461 7465 0a0a 2020 2020  ated state..    
-000197c0: 2020 2020 5468 6520 7363 6865 6475 6c65      The schedule
-000197d0: 7220 6b65 6570 7320 7472 6163 6b20 6f66  r keeps track of
-000197e0: 2077 6f72 6b65 7273 2074 6861 7420 6172   workers that ar
-000197f0: 6520 2e2e 0a0a 2020 2020 2020 2020 2d20  e ....        - 
-00019800: 2053 6174 7572 6174 6564 3a20 6861 7665   Saturated: have
-00019810: 2065 6e6f 7567 6820 776f 726b 2074 6f20   enough work to 
-00019820: 7374 6179 2062 7573 790a 2020 2020 2020  stay busy.      
-00019830: 2020 2d20 2049 646c 653a 2064 6f20 6e6f    -  Idle: do no
-00019840: 7420 6861 7665 2065 6e6f 7567 6820 776f  t have enough wo
-00019850: 726b 2074 6f20 7374 6179 2062 7573 790a  rk to stay busy.
-00019860: 0a20 2020 2020 2020 2054 6865 7920 6172  .        They ar
-00019870: 6520 636f 6e73 6964 6572 6564 2073 6174  e considered sat
-00019880: 7572 6174 6564 2069 6620 7468 6579 2062  urated if they b
-00019890: 6f74 6820 6861 7665 2065 6e6f 7567 6820  oth have enough 
-000198a0: 7461 736b 7320 746f 206f 6363 7570 790a  tasks to occupy.
-000198b0: 2020 2020 2020 2020 616c 6c20 6f66 2074          all of t
-000198c0: 6865 6972 2074 6872 6561 6473 2c20 616e  heir threads, an
-000198d0: 6420 6966 2074 6865 2065 7870 6563 7465  d if the expecte
-000198e0: 6420 7275 6e74 696d 6520 6f66 2074 686f  d runtime of tho
-000198f0: 7365 2074 6173 6b73 2069 730a 2020 2020  se tasks is.    
-00019900: 2020 2020 6c61 7267 6520 656e 6f75 6768      large enough
-00019910: 2e0a 0a20 2020 2020 2020 2049 6620 6060  ...        If ``
-00019920: 6469 7374 7269 6275 7465 642e 7363 6865  distributed.sche
-00019930: 6475 6c65 722e 776f 726b 6572 2d73 6174  duler.worker-sat
-00019940: 7572 6174 696f 6e60 6020 6973 206e 6f74  uration`` is not
-00019950: 2060 6069 6e66 6060 0a20 2020 2020 2020   ``inf``.       
-00019960: 2028 7363 6865 6475 6c65 722d 7369 6465   (scheduler-side
-00019970: 2071 7565 7569 6e67 2069 7320 656e 6162   queuing is enab
-00019980: 6c65 6429 2c20 7468 6579 2061 7265 2063  led), they are c
-00019990: 6f6e 7369 6465 7265 6420 6964 6c65 0a20  onsidered idle. 
-000199a0: 2020 2020 2020 2069 6620 7468 6579 2068         if they h
-000199b0: 6176 6520 6665 7765 7220 7461 736b 7320  ave fewer tasks 
-000199c0: 7072 6f63 6573 7369 6e67 2074 6861 6e20  processing than 
-000199d0: 7468 6520 6060 776f 726b 6572 2d73 6174  the ``worker-sat
-000199e0: 7572 6174 696f 6e60 600a 2020 2020 2020  uration``.      
-000199f0: 2020 7468 7265 7368 6f6c 6420 6469 6374    threshold dict
-00019a00: 6174 6573 2e0a 0a20 2020 2020 2020 204f  ates...        O
-00019a10: 7468 6572 7769 7365 2c20 7468 6579 2061  therwise, they a
-00019a20: 7265 2063 6f6e 7369 6465 7265 6420 6964  re considered id
-00019a30: 6c65 2069 6620 7468 6579 2068 6176 6520  le if they have 
-00019a40: 6665 7765 7220 7461 736b 7320 7072 6f63  fewer tasks proc
-00019a50: 6573 7369 6e67 0a20 2020 2020 2020 2074  essing.        t
-00019a60: 6861 6e20 7468 7265 6164 732c 206f 7220  han threads, or 
-00019a70: 6966 2074 6865 6972 2074 6173 6b73 2720  if their tasks' 
-00019a80: 746f 7461 6c20 6578 7065 6374 6564 2072  total expected r
-00019a90: 756e 7469 6d65 2069 7320 6c65 7373 2074  untime is less t
-00019aa0: 6861 6e20 6861 6c66 0a20 2020 2020 2020  han half.       
-00019ab0: 2074 6865 2065 7870 6563 7465 6420 7275   the expected ru
-00019ac0: 6e74 696d 6520 6f66 2074 6865 2073 616d  ntime of the sam
-00019ad0: 6520 6e75 6d62 6572 206f 6620 6176 6572  e number of aver
-00019ae0: 6167 6520 7461 736b 732e 0a0a 2020 2020  age tasks...    
-00019af0: 2020 2020 5468 6973 2069 7320 7573 6566      This is usef
-00019b00: 756c 2066 6f72 206c 6f61 6420 6261 6c61  ul for load bala
-00019b10: 6e63 696e 6720 616e 6420 6164 6170 7469  ncing and adapti
-00019b20: 7669 7479 2e0a 2020 2020 2020 2020 2222  vity..        ""
-00019b30: 220a 2020 2020 2020 2020 6966 2073 656c  ".        if sel
-00019b40: 662e 746f 7461 6c5f 6e74 6872 6561 6473  f.total_nthreads
-00019b50: 203d 3d20 3020 6f72 2077 732e 7374 6174   == 0 or ws.stat
-00019b60: 7573 203d 3d20 5374 6174 7573 2e63 6c6f  us == Status.clo
-00019b70: 7365 643a 0a20 2020 2020 2020 2020 2020  sed:.           
-00019b80: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
-00019b90: 6966 206f 6363 203c 2030 3a0a 2020 2020  if occ < 0:.    
-00019ba0: 2020 2020 2020 2020 6f63 6320 3d20 7773          occ = ws
-00019bb0: 2e6f 6363 7570 616e 6379 0a0a 2020 2020  .occupancy..    
-00019bc0: 2020 2020 7020 3d20 6c65 6e28 7773 2e70      p = len(ws.p
-00019bd0: 726f 6365 7373 696e 6729 0a0a 2020 2020  rocessing)..    
-00019be0: 2020 2020 7365 6c66 2e73 6174 7572 6174      self.saturat
-00019bf0: 6564 2e64 6973 6361 7264 2877 7329 0a20  ed.discard(ws). 
-00019c00: 2020 2020 2020 2069 6620 7773 2e73 7461         if ws.sta
-00019c10: 7475 7320 213d 2053 7461 7475 732e 7275  tus != Status.ru
-00019c20: 6e6e 696e 673a 0a20 2020 2020 2020 2020  nning:.         
-00019c30: 2020 2073 656c 662e 6964 6c65 2e70 6f70     self.idle.pop
-00019c40: 2877 732e 6164 6472 6573 732c 204e 6f6e  (ws.address, Non
-00019c50: 6529 0a20 2020 2020 2020 2065 6c69 6620  e).        elif 
-00019c60: 7365 6c66 2e69 735f 756e 6f63 6375 7069  self.is_unoccupi
-00019c70: 6564 2877 732c 206f 6363 2c20 7029 3a0a  ed(ws, occ, p):.
-00019c80: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00019c90: 2e69 646c 655b 7773 2e61 6464 7265 7373  .idle[ws.address
-00019ca0: 5d20 3d20 7773 0a20 2020 2020 2020 2065  ] = ws.        e
-00019cb0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00019cc0: 2073 656c 662e 6964 6c65 2e70 6f70 2877   self.idle.pop(w
-00019cd0: 732e 6164 6472 6573 732c 204e 6f6e 6529  s.address, None)
-00019ce0: 0a20 2020 2020 2020 2020 2020 206e 6320  .            nc 
-00019cf0: 3d20 7773 2e6e 7468 7265 6164 730a 2020  = ws.nthreads.  
-00019d00: 2020 2020 2020 2020 2020 6966 2070 203e            if p >
-00019d10: 206e 633a 0a20 2020 2020 2020 2020 2020   nc:.           
-00019d20: 2020 2020 2070 656e 6469 6e67 203d 206f       pending = o
-00019d30: 6363 202a 2028 7020 2d20 6e63 2920 2f20  cc * (p - nc) / 
-00019d40: 2870 202a 206e 6329 0a20 2020 2020 2020  (p * nc).       
-00019d50: 2020 2020 2020 2020 2069 6620 302e 3420           if 0.4 
-00019d60: 3c20 7065 6e64 696e 6720 3e20 312e 3920  < pending > 1.9 
-00019d70: 2a20 2873 656c 662e 746f 7461 6c5f 6f63  * (self.total_oc
-00019d80: 6375 7061 6e63 7920 2f20 7365 6c66 2e74  cupancy / self.t
-00019d90: 6f74 616c 5f6e 7468 7265 6164 7329 3a0a  otal_nthreads):.
-00019da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019db0: 2020 2020 7365 6c66 2e73 6174 7572 6174      self.saturat
-00019dc0: 6564 2e61 6464 2877 7329 0a0a 2020 2020  ed.add(ws)..    
-00019dd0: 2020 2020 6966 206e 6f74 205f 776f 726b      if not _work
-00019de0: 6572 5f66 756c 6c28 7773 2c20 7365 6c66  er_full(ws, self
-00019df0: 2e57 4f52 4b45 525f 5341 5455 5241 5449  .WORKER_SATURATI
-00019e00: 4f4e 2920 616e 6420 7773 2e73 7461 7475  ON) and ws.statu
-00019e10: 7320 3d3d 2053 7461 7475 732e 7275 6e6e  s == Status.runn
-00019e20: 696e 673a 0a20 2020 2020 2020 2020 2020  ing:.           
-00019e30: 2073 656c 662e 6964 6c65 5f74 6173 6b5f   self.idle_task_
-00019e40: 636f 756e 742e 6164 6428 7773 290a 2020  count.add(ws).  
-00019e50: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00019e60: 2020 2020 2020 2020 7365 6c66 2e69 646c          self.idl
-00019e70: 655f 7461 736b 5f63 6f75 6e74 2e64 6973  e_task_count.dis
-00019e80: 6361 7264 2877 7329 0a0a 2020 2020 6465  card(ws)..    de
-00019e90: 6620 6973 5f75 6e6f 6363 7570 6965 6428  f is_unoccupied(
-00019ea0: 0a20 2020 2020 2020 2073 656c 662c 2077  .        self, w
-00019eb0: 733a 2057 6f72 6b65 7253 7461 7465 2c20  s: WorkerState, 
-00019ec0: 6f63 6375 7061 6e63 793a 2066 6c6f 6174  occupancy: float
-00019ed0: 2c20 6e70 726f 6365 7373 696e 673a 2069  , nprocessing: i
-00019ee0: 6e74 0a20 2020 2029 202d 3e20 626f 6f6c  nt.    ) -> bool
-00019ef0: 3a0a 2020 2020 2020 2020 6e74 6872 6561  :.        nthrea
-00019f00: 6473 203d 2077 732e 6e74 6872 6561 6473  ds = ws.nthreads
-00019f10: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00019f20: 280a 2020 2020 2020 2020 2020 2020 6e70  (.            np
-00019f30: 726f 6365 7373 696e 6720 3c20 6e74 6872  rocessing < nthr
-00019f40: 6561 6473 0a20 2020 2020 2020 2020 2020  eads.           
-00019f50: 206f 7220 6f63 6375 7061 6e63 7920 3c20   or occupancy < 
-00019f60: 6e74 6872 6561 6473 202a 2028 7365 6c66  nthreads * (self
-00019f70: 2e74 6f74 616c 5f6f 6363 7570 616e 6379  .total_occupancy
-00019f80: 202f 2073 656c 662e 746f 7461 6c5f 6e74   / self.total_nt
-00019f90: 6872 6561 6473 2920 2f20 320a 2020 2020  hreads) / 2.    
-00019fa0: 2020 2020 290a 0a20 2020 2064 6566 2067      )..    def g
-00019fb0: 6574 5f63 6f6d 6d5f 636f 7374 2873 656c  et_comm_cost(sel
-00019fc0: 662c 2074 733a 2054 6173 6b53 7461 7465  f, ts: TaskState
-00019fd0: 2c20 7773 3a20 576f 726b 6572 5374 6174  , ws: WorkerStat
-00019fe0: 6529 202d 3e20 666c 6f61 743a 0a20 2020  e) -> float:.   
-00019ff0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-0001a000: 2047 6574 2074 6865 2065 7374 696d 6174   Get the estimat
-0001a010: 6564 2063 6f6d 6d75 6e69 6361 7469 6f6e  ed communication
-0001a020: 2063 6f73 7420 2869 6e20 732e 2920 746f   cost (in s.) to
-0001a030: 2063 6f6d 7075 7465 2074 6865 2074 6173   compute the tas
-0001a040: 6b0a 2020 2020 2020 2020 6f6e 2074 6865  k.        on the
-0001a050: 2067 6976 656e 2077 6f72 6b65 722e 0a20   given worker.. 
-0001a060: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0001a070: 2020 2069 6620 3130 202a 206c 656e 2874     if 10 * len(t
-0001a080: 732e 6465 7065 6e64 656e 6369 6573 2920  s.dependencies) 
-0001a090: 3c20 6c65 6e28 7773 2e68 6173 5f77 6861  < len(ws.has_wha
-0001a0a0: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
-0001a0b0: 2320 496e 2074 6865 2063 6f6d 6d6f 6e20  # In the common 
-0001a0c0: 6361 7365 2077 6865 7265 2074 6865 206e  case where the n
-0001a0d0: 756d 6265 7220 6f66 2064 6570 656e 6465  umber of depende
-0001a0e0: 6e63 6965 7320 6973 0a20 2020 2020 2020  ncies is.       
-0001a0f0: 2020 2020 2023 206d 7563 6820 6c65 7373       # much less
-0001a100: 2074 6861 6e20 7468 6520 6e75 6d62 6572   than the number
-0001a110: 206f 6620 7461 736b 7320 7468 6174 2077   of tasks that w
-0001a120: 6520 6861 7665 2c0a 2020 2020 2020 2020  e have,.        
-0001a130: 2020 2020 2320 636f 6e73 7472 7563 7420      # construct 
-0001a140: 7468 6520 7365 7420 6f66 2064 6570 7320  the set of deps 
-0001a150: 7468 6174 2072 6571 7569 7265 2063 6f6d  that require com
-0001a160: 6d75 6e69 6361 7469 6f6e 2069 6e0a 2020  munication in.  
-0001a170: 2020 2020 2020 2020 2020 2320 4f28 6c65            # O(le
-0001a180: 6e28 6465 7065 6e64 656e 6369 6573 2929  n(dependencies))
-0001a190: 2072 6174 6865 7220 7468 616e 204f 286c   rather than O(l
-0001a1a0: 656e 2868 6173 5f77 6861 7429 2920 7469  en(has_what)) ti
-0001a1b0: 6d65 2e0a 2020 2020 2020 2020 2020 2020  me..            
-0001a1c0: 2320 4661 6374 6f72 206f 6620 3130 2069  # Factor of 10 i
-0001a1d0: 7320 6120 6775 6573 7320 6174 2074 6865  s a guess at the
-0001a1e0: 206f 7665 7268 6561 6420 6f66 2065 7870   overhead of exp
-0001a1f0: 6c69 6369 740a 2020 2020 2020 2020 2020  licit.          
-0001a200: 2020 2320 6974 6572 6174 696f 6e20 6173    # iteration as
-0001a210: 206f 7070 6f73 6564 2074 6f20 6a75 7374   opposed to just
-0001a220: 2063 616c 6c69 6e67 2073 6574 2e64 6966   calling set.dif
-0001a230: 6665 7265 6e63 650a 2020 2020 2020 2020  ference.        
-0001a240: 2020 2020 6465 7073 203d 207b 6465 7020      deps = {dep 
-0001a250: 666f 7220 6465 7020 696e 2074 732e 6465  for dep in ts.de
-0001a260: 7065 6e64 656e 6369 6573 2069 6620 6465  pendencies if de
-0001a270: 7020 6e6f 7420 696e 2077 732e 6861 735f  p not in ws.has_
-0001a280: 7768 6174 7d0a 2020 2020 2020 2020 656c  what}.        el
-0001a290: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0001a2a0: 6465 7073 203d 2028 7473 2e64 6570 656e  deps = (ts.depen
-0001a2b0: 6465 6e63 6965 7320 6f72 2073 6574 2829  dencies or set()
-0001a2c0: 292e 6469 6666 6572 656e 6365 2877 732e  ).difference(ws.
-0001a2d0: 6861 735f 7768 6174 290a 2020 2020 2020  has_what).      
-0001a2e0: 2020 6e62 7974 6573 203d 2073 756d 2864    nbytes = sum(d
-0001a2f0: 7473 2e6e 6279 7465 7320 666f 7220 6474  ts.nbytes for dt
-0001a300: 7320 696e 2064 6570 7329 0a20 2020 2020  s in deps).     
-0001a310: 2020 2072 6574 7572 6e20 6e62 7974 6573     return nbytes
-0001a320: 202f 2073 656c 662e 6261 6e64 7769 6474   / self.bandwidt
-0001a330: 680a 0a20 2020 2064 6566 2067 6574 5f74  h..    def get_t
-0001a340: 6173 6b5f 6475 7261 7469 6f6e 2873 656c  ask_duration(sel
-0001a350: 662c 2074 733a 2054 6173 6b53 7461 7465  f, ts: TaskState
-0001a360: 2920 2d3e 2066 6c6f 6174 3a0a 2020 2020  ) -> float:.    
-0001a370: 2020 2020 2222 2247 6574 2074 6865 2065      """Get the e
-0001a380: 7374 696d 6174 6564 2063 6f6d 7075 7461  stimated computa
-0001a390: 7469 6f6e 2063 6f73 7420 6f66 2074 6865  tion cost of the
-0001a3a0: 2067 6976 656e 2074 6173 6b20 286e 6f74   given task (not
-0001a3b0: 2069 6e63 6c75 6469 6e67 0a20 2020 2020   including.     
-0001a3c0: 2020 2061 6e79 2063 6f6d 6d75 6e69 6361     any communica
-0001a3d0: 7469 6f6e 2063 6f73 7429 2e0a 0a20 2020  tion cost)...   
-0001a3e0: 2020 2020 2049 6620 6e6f 2064 6174 6120       If no data 
-0001a3f0: 6861 7320 6265 656e 206f 6273 6572 7665  has been observe
-0001a400: 642c 2076 616c 7565 206f 660a 2020 2020  d, value of.    
-0001a410: 2020 2020 6064 6973 7472 6962 7574 6564      `distributed
-0001a420: 2e73 6368 6564 756c 6572 2e64 6566 6175  .scheduler.defau
-0001a430: 6c74 2d74 6173 6b2d 6475 7261 7469 6f6e  lt-task-duration
-0001a440: 7360 2061 7265 2075 7365 642e 2049 6620  s` are used. If 
-0001a450: 6e6f 6e65 2069 7320 7365 740a 2020 2020  none is set.    
-0001a460: 2020 2020 666f 7220 7468 6973 2074 6173      for this tas
-0001a470: 6b2c 2060 6469 7374 7269 6275 7465 642e  k, `distributed.
-0001a480: 7363 6865 6475 6c65 722e 756e 6b6e 6f77  scheduler.unknow
-0001a490: 6e2d 7461 736b 2d64 7572 6174 696f 6e60  n-task-duration`
-0001a4a0: 2069 7320 7573 6564 0a20 2020 2020 2020   is used.       
-0001a4b0: 2069 6e73 7465 6164 2e0a 2020 2020 2020   instead..      
-0001a4c0: 2020 2222 220a 2020 2020 2020 2020 6475    """.        du
-0001a4d0: 7261 7469 6f6e 3a20 666c 6f61 7420 3d20  ration: float = 
-0001a4e0: 7473 2e70 7265 6669 782e 6475 7261 7469  ts.prefix.durati
-0001a4f0: 6f6e 5f61 7665 7261 6765 0a20 2020 2020  on_average.     
-0001a500: 2020 2069 6620 6475 7261 7469 6f6e 203e     if duration >
-0001a510: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
-0001a520: 2072 6574 7572 6e20 6475 7261 7469 6f6e   return duration
-0001a530: 0a0a 2020 2020 2020 2020 7320 3d20 7365  ..        s = se
-0001a540: 6c66 2e75 6e6b 6e6f 776e 5f64 7572 6174  lf.unknown_durat
-0001a550: 696f 6e73 2e67 6574 2874 732e 7072 6566  ions.get(ts.pref
-0001a560: 6978 2e6e 616d 6529 0a20 2020 2020 2020  ix.name).       
-0001a570: 2069 6620 7320 6973 204e 6f6e 653a 0a20   if s is None:. 
-0001a580: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0001a590: 756e 6b6e 6f77 6e5f 6475 7261 7469 6f6e  unknown_duration
-0001a5a0: 735b 7473 2e70 7265 6669 782e 6e61 6d65  s[ts.prefix.name
-0001a5b0: 5d20 3d20 7320 3d20 7365 7428 290a 2020  ] = s = set().  
-0001a5c0: 2020 2020 2020 732e 6164 6428 7473 290a        s.add(ts).
-0001a5d0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-0001a5e0: 656c 662e 554e 4b4e 4f57 4e5f 5441 534b  elf.UNKNOWN_TASK
-0001a5f0: 5f44 5552 4154 494f 4e0a 0a20 2020 2064  _DURATION..    d
-0001a600: 6566 2076 616c 6964 5f77 6f72 6b65 7273  ef valid_workers
-0001a610: 2873 656c 662c 2074 733a 2054 6173 6b53  (self, ts: TaskS
-0001a620: 7461 7465 2920 2d3e 2073 6574 5b57 6f72  tate) -> set[Wor
-0001a630: 6b65 7253 7461 7465 5d20 7c20 4e6f 6e65  kerState] | None
-0001a640: 3a0a 2020 2020 2020 2020 2222 2252 6574  :.        """Ret
-0001a650: 7572 6e20 7365 7420 6f66 2063 7572 7265  urn set of curre
-0001a660: 6e74 6c79 2076 616c 6964 2077 6f72 6b65  ntly valid worke
-0001a670: 7273 2066 6f72 206b 6579 0a0a 2020 2020  rs for key..    
-0001a680: 2020 2020 4966 2061 6c6c 2077 6f72 6b65      If all worke
-0001a690: 7273 2061 7265 2076 616c 6964 2074 6865  rs are valid the
-0001a6a0: 6e20 7468 6973 2072 6574 7572 6e73 2060  n this returns `
-0001a6b0: 604e 6f6e 6560 602c 2069 6e20 7768 6963  `None``, in whic
-0001a6c0: 6820 6361 7365 0a20 2020 2020 2020 2061  h case.        a
-0001a6d0: 6e79 202a 7275 6e6e 696e 672a 2077 6f72  ny *running* wor
-0001a6e0: 6b65 7220 6361 6e20 6265 2075 7365 642e  ker can be used.
-0001a6f0: 0a20 2020 2020 2020 204f 7468 6572 7769  .        Otherwi
-0001a700: 7365 2c20 7468 6520 7375 6273 6574 206f  se, the subset o
-0001a710: 6620 7275 6e6e 696e 6720 776f 726b 6572  f running worker
-0001a720: 7320 7661 6c69 6420 666f 7220 7468 6973  s valid for this
-0001a730: 2074 6173 6b0a 2020 2020 2020 2020 6973   task.        is
-0001a740: 2072 6574 7572 6e65 642e 0a20 2020 2020   returned..     
-0001a750: 2020 2054 6869 7320 6368 6563 6b73 2074     This checks t
-0001a760: 7261 636b 7320 7468 6520 666f 6c6c 6f77  racks the follow
-0001a770: 696e 6720 7374 6174 653a 0a0a 2020 2020  ing state:..    
-0001a780: 2020 2020 2a20 2077 6f72 6b65 725f 7265      *  worker_re
-0001a790: 7374 7269 6374 696f 6e73 0a20 2020 2020  strictions.     
-0001a7a0: 2020 202a 2020 686f 7374 5f72 6573 7472     *  host_restr
-0001a7b0: 6963 7469 6f6e 730a 2020 2020 2020 2020  ictions.        
-0001a7c0: 2a20 2072 6573 6f75 7263 655f 7265 7374  *  resource_rest
-0001a7d0: 7269 6374 696f 6e73 0a20 2020 2020 2020  rictions.       
-0001a7e0: 2022 2222 0a20 2020 2020 2020 2073 3a20   """.        s: 
-0001a7f0: 7365 745b 7374 725d 207c 204e 6f6e 6520  set[str] | None 
-0001a800: 3d20 4e6f 6e65 0a0a 2020 2020 2020 2020  = None..        
-0001a810: 6966 2074 732e 776f 726b 6572 5f72 6573  if ts.worker_res
-0001a820: 7472 6963 7469 6f6e 733a 0a20 2020 2020  trictions:.     
-0001a830: 2020 2020 2020 2073 203d 207b 6164 6472         s = {addr
-0001a840: 2066 6f72 2061 6464 7220 696e 2074 732e   for addr in ts.
-0001a850: 776f 726b 6572 5f72 6573 7472 6963 7469  worker_restricti
-0001a860: 6f6e 7320 6966 2061 6464 7220 696e 2073  ons if addr in s
-0001a870: 656c 662e 776f 726b 6572 737d 0a0a 2020  elf.workers}..  
-0001a880: 2020 2020 2020 6966 2074 732e 686f 7374        if ts.host
-0001a890: 5f72 6573 7472 6963 7469 6f6e 733a 0a20  _restrictions:. 
-0001a8a0: 2020 2020 2020 2020 2020 2023 2052 6573             # Res
-0001a8b0: 6f6c 7665 2074 6865 2061 6c69 6173 2068  olve the alias h
-0001a8c0: 6572 6520 7261 7468 6572 2074 6861 6e20  ere rather than 
-0001a8d0: 6561 726c 792c 2066 6f72 2074 6865 2077  early, for the w
-0001a8e0: 6f72 6b65 720a 2020 2020 2020 2020 2020  orker.          
-0001a8f0: 2020 2320 6d61 7920 6e6f 7420 6265 2063    # may not be c
-0001a900: 6f6e 6e65 6374 6564 2077 6865 6e20 686f  onnected when ho
-0001a910: 7374 5f72 6573 7472 6963 7469 6f6e 7320  st_restrictions 
-0001a920: 6973 2070 6f70 756c 6174 6564 0a20 2020  is populated.   
-0001a930: 2020 2020 2020 2020 2068 7220 3d20 5b73           hr = [s
-0001a940: 656c 662e 636f 6572 6365 5f68 6f73 746e  elf.coerce_hostn
-0001a950: 616d 6528 6829 2066 6f72 2068 2069 6e20  ame(h) for h in 
-0001a960: 7473 2e68 6f73 745f 7265 7374 7269 6374  ts.host_restrict
-0001a970: 696f 6e73 5d0a 2020 2020 2020 2020 2020  ions].          
-0001a980: 2020 2320 5858 5820 6e65 6564 2048 6f73    # XXX need Hos
-0001a990: 7453 7461 7465 3f0a 2020 2020 2020 2020  tState?.        
-0001a9a0: 2020 2020 736c 203d 205b 5d0a 2020 2020      sl = [].    
-0001a9b0: 2020 2020 2020 2020 666f 7220 6820 696e          for h in
-0001a9c0: 2068 723a 0a20 2020 2020 2020 2020 2020   hr:.           
-0001a9d0: 2020 2020 2064 6820 3d20 7365 6c66 2e68       dh = self.h
-0001a9e0: 6f73 745f 696e 666f 2e67 6574 2868 290a  ost_info.get(h).
-0001a9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aa00: 6966 2064 6820 6973 206e 6f74 204e 6f6e  if dh is not Non
-0001aa10: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0001aa20: 2020 2020 2020 2073 6c2e 6170 7065 6e64         sl.append
-0001aa30: 2864 685b 2261 6464 7265 7373 6573 225d  (dh["addresses"]
-0001aa40: 290a 0a20 2020 2020 2020 2020 2020 2073  )..            s
-0001aa50: 7320 3d20 7365 742e 756e 696f 6e28 2a73  s = set.union(*s
-0001aa60: 6c29 2069 6620 736c 2065 6c73 6520 7365  l) if sl else se
-0001aa70: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
-0001aa80: 6966 2073 2069 7320 4e6f 6e65 3a0a 2020  if s is None:.  
-0001aa90: 2020 2020 2020 2020 2020 2020 2020 7320                s 
-0001aaa0: 3d20 7373 0a20 2020 2020 2020 2020 2020  = ss.           
-0001aab0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0001aac0: 2020 2020 2020 2073 207c 3d20 7373 0a0a         s |= ss..
-0001aad0: 2020 2020 2020 2020 6966 2074 732e 7265          if ts.re
-0001aae0: 736f 7572 6365 5f72 6573 7472 6963 7469  source_restricti
-0001aaf0: 6f6e 733a 0a20 2020 2020 2020 2020 2020  ons:.           
-0001ab00: 2064 7720 3d20 7b7d 0a20 2020 2020 2020   dw = {}.       
-0001ab10: 2020 2020 2066 6f72 2072 6573 6f75 7263       for resourc
-0001ab20: 652c 2072 6571 7569 7265 6420 696e 2074  e, required in t
-0001ab30: 732e 7265 736f 7572 6365 5f72 6573 7472  s.resource_restr
-0001ab40: 6963 7469 6f6e 732e 6974 656d 7328 293a  ictions.items():
-0001ab50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ab60: 2064 7220 3d20 7365 6c66 2e72 6573 6f75   dr = self.resou
-0001ab70: 7263 6573 2e67 6574 2872 6573 6f75 7263  rces.get(resourc
-0001ab80: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-0001ab90: 2020 2069 6620 6472 2069 7320 4e6f 6e65     if dr is None
-0001aba0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001abb0: 2020 2020 2020 7365 6c66 2e72 6573 6f75        self.resou
-0001abc0: 7263 6573 5b72 6573 6f75 7263 655d 203d  rces[resource] =
-0001abd0: 2064 7220 3d20 7b7d 0a0a 2020 2020 2020   dr = {}..      
-0001abe0: 2020 2020 2020 2020 2020 7377 203d 2073            sw = s
-0001abf0: 6574 2829 0a20 2020 2020 2020 2020 2020  et().           
-0001ac00: 2020 2020 2066 6f72 2061 6464 722c 2073       for addr, s
-0001ac10: 7570 706c 6965 6420 696e 2064 722e 6974  upplied in dr.it
-0001ac20: 656d 7328 293a 0a20 2020 2020 2020 2020  ems():.         
-0001ac30: 2020 2020 2020 2020 2020 2069 6620 7375             if su
-0001ac40: 7070 6c69 6564 203e 3d20 7265 7175 6972  pplied >= requir
-0001ac50: 6564 3a0a 2020 2020 2020 2020 2020 2020  ed:.            
-0001ac60: 2020 2020 2020 2020 2020 2020 7377 2e61              sw.a
-0001ac70: 6464 2861 6464 7229 0a0a 2020 2020 2020  dd(addr)..      
-0001ac80: 2020 2020 2020 2020 2020 6477 5b72 6573            dw[res
-0001ac90: 6f75 7263 655d 203d 2073 770a 0a20 2020  ource] = sw..   
-0001aca0: 2020 2020 2020 2020 2077 7720 3d20 7365           ww = se
-0001acb0: 742e 696e 7465 7273 6563 7469 6f6e 282a  t.intersection(*
-0001acc0: 6477 2e76 616c 7565 7328 2929 0a20 2020  dw.values()).   
-0001acd0: 2020 2020 2020 2020 2069 6620 7320 6973           if s is
-0001ace0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-0001acf0: 2020 2020 2020 2073 203d 2077 770a 2020         s = ww.  
-0001ad00: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0001ad10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ad20: 7320 263d 2077 770a 0a20 2020 2020 2020  s &= ww..       
-0001ad30: 2069 6620 7320 6973 204e 6f6e 653a 0a20   if s is None:. 
-0001ad40: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0001ad50: 6e20 4e6f 6e65 2020 2320 416c 6c20 776f  n None  # All wo
-0001ad60: 726b 6572 7320 6172 6520 7661 6c69 640a  rkers are valid.
-0001ad70: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
-0001ad80: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0001ad90: 7475 726e 2073 6574 2829 2020 2320 4e6f  turn set()  # No
-0001ada0: 2077 6f72 6b65 7273 2061 7265 2076 616c   workers are val
-0001adb0: 6964 0a0a 2020 2020 2020 2020 2320 536f  id..        # So
-0001adc0: 6d65 2077 6f72 6b65 7273 2061 7265 2076  me workers are v
-0001add0: 616c 6964 0a20 2020 2020 2020 2073 5f77  alid.        s_w
-0001ade0: 7320 3d20 7b73 656c 662e 776f 726b 6572  s = {self.worker
-0001adf0: 735b 6164 6472 5d20 666f 7220 6164 6472  s[addr] for addr
-0001ae00: 2069 6e20 737d 0a20 2020 2020 2020 2069   in s}.        i
-0001ae10: 6620 6c65 6e28 7365 6c66 2e72 756e 6e69  f len(self.runni
-0001ae20: 6e67 2920 3c20 6c65 6e28 7365 6c66 2e77  ng) < len(self.w
-0001ae30: 6f72 6b65 7273 293a 0a20 2020 2020 2020  orkers):.       
-0001ae40: 2020 2020 2073 5f77 7320 263d 2073 656c       s_ws &= sel
-0001ae50: 662e 7275 6e6e 696e 670a 2020 2020 2020  f.running.      
-0001ae60: 2020 7265 7475 726e 2073 5f77 730a 0a20    return s_ws.. 
-0001ae70: 2020 2064 6566 2061 6371 7569 7265 5f72     def acquire_r
-0001ae80: 6573 6f75 7263 6573 2873 656c 662c 2074  esources(self, t
-0001ae90: 733a 2054 6173 6b53 7461 7465 2c20 7773  s: TaskState, ws
-0001aea0: 3a20 576f 726b 6572 5374 6174 6529 202d  : WorkerState) -
-0001aeb0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-0001aec0: 6966 2074 732e 7265 736f 7572 6365 5f72  if ts.resource_r
-0001aed0: 6573 7472 6963 7469 6f6e 733a 0a20 2020  estrictions:.   
-0001aee0: 2020 2020 2020 2020 2066 6f72 2072 2c20           for r, 
-0001aef0: 7265 7175 6972 6564 2069 6e20 7473 2e72  required in ts.r
-0001af00: 6573 6f75 7263 655f 7265 7374 7269 6374  esource_restrict
-0001af10: 696f 6e73 2e69 7465 6d73 2829 3a0a 2020  ions.items():.  
-0001af20: 2020 2020 2020 2020 2020 2020 2020 7773                ws
-0001af30: 2e75 7365 645f 7265 736f 7572 6365 735b  .used_resources[
-0001af40: 725d 202b 3d20 7265 7175 6972 6564 0a0a  r] += required..
-0001af50: 2020 2020 6465 6620 7265 6c65 6173 655f      def release_
-0001af60: 7265 736f 7572 6365 7328 7365 6c66 2c20  resources(self, 
-0001af70: 7473 3a20 5461 736b 5374 6174 652c 2077  ts: TaskState, w
-0001af80: 733a 2057 6f72 6b65 7253 7461 7465 2920  s: WorkerState) 
-0001af90: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-0001afa0: 2069 6620 7473 2e72 6573 6f75 7263 655f   if ts.resource_
-0001afb0: 7265 7374 7269 6374 696f 6e73 3a0a 2020  restrictions:.  
-0001afc0: 2020 2020 2020 2020 2020 666f 7220 722c            for r,
-0001afd0: 2072 6571 7569 7265 6420 696e 2074 732e   required in ts.
-0001afe0: 7265 736f 7572 6365 5f72 6573 7472 6963  resource_restric
-0001aff0: 7469 6f6e 732e 6974 656d 7328 293a 0a20  tions.items():. 
-0001b000: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-0001b010: 732e 7573 6564 5f72 6573 6f75 7263 6573  s.used_resources
-0001b020: 5b72 5d20 2d3d 2072 6571 7569 7265 640a  [r] -= required.
-0001b030: 0a20 2020 2064 6566 2063 6f65 7263 655f  .    def coerce_
-0001b040: 686f 7374 6e61 6d65 2873 656c 662c 2068  hostname(self, h
-0001b050: 6f73 743a 2048 6173 6861 626c 6529 202d  ost: Hashable) -
-0001b060: 3e20 7374 723a 0a20 2020 2020 2020 2022  > str:.        "
-0001b070: 2222 0a20 2020 2020 2020 2043 6f65 7263  "".        Coerc
-0001b080: 6520 7468 6520 686f 7374 6e61 6d65 206f  e the hostname o
-0001b090: 6620 6120 776f 726b 6572 2e0a 2020 2020  f a worker..    
-0001b0a0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0001b0b0: 616c 6961 7320 3d20 7365 6c66 2e61 6c69  alias = self.ali
-0001b0c0: 6173 6573 2e67 6574 2868 6f73 7429 0a20  ases.get(host). 
-0001b0d0: 2020 2020 2020 2069 6620 616c 6961 7320         if alias 
-0001b0e0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-0001b0f0: 2020 2020 2020 2020 2077 7320 3d20 7365           ws = se
-0001b100: 6c66 2e77 6f72 6b65 7273 5b61 6c69 6173  lf.workers[alias
-0001b110: 5d0a 2020 2020 2020 2020 2020 2020 7265  ].            re
-0001b120: 7475 726e 2077 732e 686f 7374 0a20 2020  turn ws.host.   
-0001b130: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0001b140: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
-0001b150: 696e 7374 616e 6365 2868 6f73 742c 2073  instance(host, s
-0001b160: 7472 290a 2020 2020 2020 2020 2020 2020  tr).            
-0001b170: 7265 7475 726e 2068 6f73 740a 0a20 2020  return host..   
-0001b180: 2064 6566 2077 6f72 6b65 725f 6f62 6a65   def worker_obje
-0001b190: 6374 6976 6528 7365 6c66 2c20 7473 3a20  ctive(self, ts: 
-0001b1a0: 5461 736b 5374 6174 652c 2077 733a 2057  TaskState, ws: W
-0001b1b0: 6f72 6b65 7253 7461 7465 2920 2d3e 2074  orkerState) -> t
-0001b1c0: 7570 6c65 3a0a 2020 2020 2020 2020 2222  uple:.        ""
-0001b1d0: 224f 626a 6563 7469 7665 2066 756e 6374  "Objective funct
-0001b1e0: 696f 6e20 746f 2064 6574 6572 6d69 6e65  ion to determine
-0001b1f0: 2077 6869 6368 2077 6f72 6b65 7220 7368   which worker sh
-0001b200: 6f75 6c64 2067 6574 2074 6865 2074 6173  ould get the tas
-0001b210: 6b0a 0a20 2020 2020 2020 204d 696e 696d  k..        Minim
-0001b220: 697a 6520 6578 7065 6374 6564 2073 7461  ize expected sta
-0001b230: 7274 2074 696d 652e 2020 4966 2061 2074  rt time.  If a t
-0001b240: 6965 2074 6865 6e20 6272 6561 6b20 7769  ie then break wi
-0001b250: 7468 2064 6174 6120 7374 6f72 6167 652e  th data storage.
-0001b260: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0001b270: 2020 2020 2063 6f6d 6d5f 6279 7465 7320       comm_bytes 
-0001b280: 3d20 7375 6d28 0a20 2020 2020 2020 2020  = sum(.         
-0001b290: 2020 2064 7473 2e67 6574 5f6e 6279 7465     dts.get_nbyte
-0001b2a0: 7328 2920 666f 7220 6474 7320 696e 2074  s() for dts in t
-0001b2b0: 732e 6465 7065 6e64 656e 6369 6573 2069  s.dependencies i
-0001b2c0: 6620 7773 206e 6f74 2069 6e20 2864 7473  f ws not in (dts
-0001b2d0: 2e77 686f 5f68 6173 206f 7220 2829 290a  .who_has or ()).
-0001b2e0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-0001b2f0: 2020 2073 7461 636b 5f74 696d 6520 3d20     stack_time = 
-0001b300: 7773 2e6f 6363 7570 616e 6379 202f 2077  ws.occupancy / w
-0001b310: 732e 6e74 6872 6561 6473 0a20 2020 2020  s.nthreads.     
-0001b320: 2020 2073 7461 7274 5f74 696d 6520 3d20     start_time = 
-0001b330: 7374 6163 6b5f 7469 6d65 202b 2063 6f6d  stack_time + com
-0001b340: 6d5f 6279 7465 7320 2f20 7365 6c66 2e62  m_bytes / self.b
-0001b350: 616e 6477 6964 7468 0a0a 2020 2020 2020  andwidth..      
-0001b360: 2020 6966 2074 732e 6163 746f 723a 0a20    if ts.actor:. 
-0001b370: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0001b380: 6e20 286c 656e 2877 732e 6163 746f 7273  n (len(ws.actors
-0001b390: 292c 2073 7461 7274 5f74 696d 652c 2077  ), start_time, w
-0001b3a0: 732e 6e62 7974 6573 290a 2020 2020 2020  s.nbytes).      
-0001b3b0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001b3c0: 2020 2020 7265 7475 726e 2028 7374 6172      return (star
-0001b3d0: 745f 7469 6d65 2c20 7773 2e6e 6279 7465  t_time, ws.nbyte
-0001b3e0: 7329 0a0a 2020 2020 6465 6620 6164 645f  s)..    def add_
-0001b3f0: 7265 706c 6963 6128 7365 6c66 2c20 7473  replica(self, ts
-0001b400: 3a20 5461 736b 5374 6174 652c 2077 733a  : TaskState, ws:
-0001b410: 2057 6f72 6b65 7253 7461 7465 2920 2d3e   WorkerState) ->
-0001b420: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
-0001b430: 2222 4e6f 7465 2074 6861 7420 6120 776f  ""Note that a wo
-0001b440: 726b 6572 2068 6f6c 6473 2061 2072 6570  rker holds a rep
-0001b450: 6c69 6361 206f 6620 6120 7461 736b 2077  lica of a task w
-0001b460: 6974 6820 7374 6174 653d 276d 656d 6f72  ith state='memor
-0001b470: 7927 2222 220a 2020 2020 2020 2020 7773  y'""".        ws
-0001b480: 2e61 6464 5f72 6570 6c69 6361 2874 7329  .add_replica(ts)
-0001b490: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0001b4a0: 7473 2e77 686f 5f68 6173 0a20 2020 2020  ts.who_has.     
-0001b4b0: 2020 2069 6620 6c65 6e28 7473 2e77 686f     if len(ts.who
-0001b4c0: 5f68 6173 2920 3d3d 2032 3a0a 2020 2020  _has) == 2:.    
-0001b4d0: 2020 2020 2020 2020 7365 6c66 2e72 6570          self.rep
-0001b4e0: 6c69 6361 7465 645f 7461 736b 732e 6164  licated_tasks.ad
-0001b4f0: 6428 7473 290a 0a20 2020 2064 6566 2072  d(ts)..    def r
-0001b500: 656d 6f76 655f 7265 706c 6963 6128 7365  emove_replica(se
-0001b510: 6c66 2c20 7473 3a20 5461 736b 5374 6174  lf, ts: TaskStat
-0001b520: 652c 2077 733a 2057 6f72 6b65 7253 7461  e, ws: WorkerSta
-0001b530: 7465 2920 2d3e 204e 6f6e 653a 0a20 2020  te) -> None:.   
-0001b540: 2020 2020 2022 2222 4e6f 7465 2074 6861       """Note tha
-0001b550: 7420 6120 776f 726b 6572 206e 6f20 6c6f  t a worker no lo
-0001b560: 6e67 6572 2068 6f6c 6473 2061 2072 6570  nger holds a rep
-0001b570: 6c69 6361 206f 6620 6120 7461 736b 2222  lica of a task""
-0001b580: 220a 2020 2020 2020 2020 7773 2e72 656d  ".        ws.rem
-0001b590: 6f76 655f 7265 706c 6963 6128 7473 290a  ove_replica(ts).
-0001b5a0: 2020 2020 2020 2020 6966 206c 656e 2874          if len(t
-0001b5b0: 732e 7768 6f5f 6861 7320 6f72 2028 2929  s.who_has or ())
-0001b5c0: 203d 3d20 313a 0a20 2020 2020 2020 2020   == 1:.         
-0001b5d0: 2020 2073 656c 662e 7265 706c 6963 6174     self.replicat
-0001b5e0: 6564 5f74 6173 6b73 2e72 656d 6f76 6528  ed_tasks.remove(
-0001b5f0: 7473 290a 0a20 2020 2064 6566 2072 656d  ts)..    def rem
-0001b600: 6f76 655f 616c 6c5f 7265 706c 6963 6173  ove_all_replicas
-0001b610: 2873 656c 662c 2074 733a 2054 6173 6b53  (self, ts: TaskS
-0001b620: 7461 7465 2920 2d3e 204e 6f6e 653a 0a20  tate) -> None:. 
-0001b630: 2020 2020 2020 2022 2222 5265 6d6f 7665         """Remove
-0001b640: 2061 6c6c 2072 6570 6c69 6361 7320 6f66   all replicas of
-0001b650: 2061 2074 6173 6b20 6672 6f6d 2061 6c6c   a task from all
-0001b660: 2077 6f72 6b65 7273 2222 220a 2020 2020   workers""".    
-0001b670: 2020 2020 6e62 7974 6573 203d 2074 732e      nbytes = ts.
-0001b680: 6765 745f 6e62 7974 6573 2829 0a20 2020  get_nbytes().   
-0001b690: 2020 2020 2069 6620 6e6f 7420 7473 2e77       if not ts.w
-0001b6a0: 686f 5f68 6173 3a0a 2020 2020 2020 2020  ho_has:.        
-0001b6b0: 2020 2020 7265 7475 726e 0a20 2020 2020      return.     
-0001b6c0: 2020 2066 6f72 2077 7320 696e 2074 732e     for ws in ts.
-0001b6d0: 7768 6f5f 6861 733a 0a20 2020 2020 2020  who_has:.       
-0001b6e0: 2020 2020 2077 732e 6e62 7974 6573 202d       ws.nbytes -
-0001b6f0: 3d20 6e62 7974 6573 0a20 2020 2020 2020  = nbytes.       
-0001b700: 2020 2020 2064 656c 2077 732e 5f68 6173       del ws._has
-0001b710: 5f77 6861 745b 7473 5d0a 2020 2020 2020  _what[ts].      
-0001b720: 2020 6966 206c 656e 2874 732e 7768 6f5f    if len(ts.who_
-0001b730: 6861 7329 203e 2031 3a0a 2020 2020 2020  has) > 1:.      
-0001b740: 2020 2020 2020 7365 6c66 2e72 6570 6c69        self.repli
-0001b750: 6361 7465 645f 7461 736b 732e 7265 6d6f  cated_tasks.remo
-0001b760: 7665 2874 7329 0a20 2020 2020 2020 2074  ve(ts).        t
-0001b770: 732e 7768 6f5f 6861 7320 3d20 4e6f 6e65  s.who_has = None
-0001b780: 0a0a 2020 2020 6465 6620 6275 6c6b 5f73  ..    def bulk_s
-0001b790: 6368 6564 756c 655f 756e 7275 6e6e 6162  chedule_unrunnab
-0001b7a0: 6c65 5f61 6674 6572 5f61 6464 696e 675f  le_after_adding_
-0001b7b0: 776f 726b 6572 2873 656c 662c 2077 733a  worker(self, ws:
-0001b7c0: 2057 6f72 6b65 7253 7461 7465 2920 2d3e   WorkerState) ->
-0001b7d0: 2052 6563 733a 0a20 2020 2020 2020 2022   Recs:.        "
-0001b7e0: 2222 5365 6e64 2060 606e 6f2d 776f 726b  ""Send ``no-work
-0001b7f0: 6572 6060 2074 6173 6b73 2074 6f20 6060  er`` tasks to ``
-0001b800: 7072 6f63 6573 7369 6e67 6060 2074 6861  processing`` tha
-0001b810: 7420 7468 6973 2077 6f72 6b65 7220 6361  t this worker ca
-0001b820: 6e20 6861 6e64 6c65 2e0a 0a20 2020 2020  n handle...     
-0001b830: 2020 2052 6574 7572 6e73 2070 7269 6f72     Returns prior
-0001b840: 6974 792d 6f72 6465 7265 6420 7265 636f  ity-ordered reco
-0001b850: 6d6d 656e 6461 7469 6f6e 732e 0a20 2020  mmendations..   
-0001b860: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-0001b870: 2072 756e 6e61 626c 653a 206c 6973 745b   runnable: list[
-0001b880: 5461 736b 5374 6174 655d 203d 205b 5d0a  TaskState] = [].
-0001b890: 2020 2020 2020 2020 666f 7220 7473 2069          for ts i
-0001b8a0: 6e20 7365 6c66 2e75 6e72 756e 6e61 626c  n self.unrunnabl
-0001b8b0: 653a 0a20 2020 2020 2020 2020 2020 2076  e:.            v
-0001b8c0: 616c 6964 203d 2073 656c 662e 7661 6c69  alid = self.vali
-0001b8d0: 645f 776f 726b 6572 7328 7473 290a 2020  d_workers(ts).  
-0001b8e0: 2020 2020 2020 2020 2020 6966 2076 616c            if val
-0001b8f0: 6964 2069 7320 4e6f 6e65 206f 7220 7773  id is None or ws
-0001b900: 2069 6e20 7661 6c69 643a 0a20 2020 2020   in valid:.     
-0001b910: 2020 2020 2020 2020 2020 2072 756e 6e61             runna
-0001b920: 626c 652e 6170 7065 6e64 2874 7329 0a0a  ble.append(ts)..
-0001b930: 2020 2020 2020 2020 2320 5265 636f 6d6d          # Recomm
-0001b940: 656e 6461 7469 6f6e 7320 6172 6520 7072  endations are pr
-0001b950: 6f63 6573 7365 6420 4c49 464f 2c20 6865  ocessed LIFO, he
-0001b960: 6e63 6520 7468 6520 7265 7665 7273 6564  nce the reversed
-0001b970: 206f 7264 6572 0a20 2020 2020 2020 2072   order.        r
-0001b980: 756e 6e61 626c 652e 736f 7274 286b 6579  unnable.sort(key
-0001b990: 3d6f 7065 7261 746f 722e 6174 7472 6765  =operator.attrge
-0001b9a0: 7474 6572 2822 7072 696f 7269 7479 2229  tter("priority")
-0001b9b0: 2c20 7265 7665 7273 653d 5472 7565 290a  , reverse=True).
-0001b9c0: 2020 2020 2020 2020 7265 7475 726e 207b          return {
-0001b9d0: 7473 2e6b 6579 3a20 2270 726f 6365 7373  ts.key: "process
-0001b9e0: 696e 6722 2066 6f72 2074 7320 696e 2072  ing" for ts in r
-0001b9f0: 756e 6e61 626c 657d 0a0a 2020 2020 6465  unnable}..    de
-0001ba00: 6620 5f76 616c 6964 6174 655f 7265 6164  f _validate_read
-0001ba10: 7928 7365 6c66 2c20 7473 3a20 5461 736b  y(self, ts: Task
-0001ba20: 5374 6174 6529 202d 3e20 4e6f 6e65 3a0a  State) -> None:.
-0001ba30: 2020 2020 2020 2020 2222 2256 616c 6964          """Valid
-0001ba40: 6174 696f 6e20 666f 7220 7265 6164 7920  ation for ready 
-0001ba50: 7374 6174 6573 2028 7072 6f63 6573 7369  states (processi
-0001ba60: 6e67 2c20 7175 6575 6564 2c20 6e6f 2d77  ng, queued, no-w
-0001ba70: 6f72 6b65 7229 2222 220a 2020 2020 2020  orker)""".      
-0001ba80: 2020 6173 7365 7274 206e 6f74 2074 732e    assert not ts.
-0001ba90: 7761 6974 696e 675f 6f6e 0a20 2020 2020  waiting_on.     
-0001baa0: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
-0001bab0: 2e77 686f 5f68 6173 0a20 2020 2020 2020  .who_has.       
-0001bac0: 2061 7373 6572 7420 6e6f 7420 7473 2e65   assert not ts.e
-0001bad0: 7863 6570 7469 6f6e 5f62 6c61 6d65 0a20  xception_blame. 
-0001bae0: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
-0001baf0: 7420 7473 2e70 726f 6365 7373 696e 675f  t ts.processing_
-0001bb00: 6f6e 0a20 2020 2020 2020 2061 7373 6572  on.        asser
-0001bb10: 7420 6e6f 7420 7473 2e68 6173 5f6c 6f73  t not ts.has_los
-0001bb20: 745f 6465 7065 6e64 656e 6369 6573 0a20  t_dependencies. 
-0001bb30: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
-0001bb40: 206e 6f74 2069 6e20 7365 6c66 2e75 6e72   not in self.unr
-0001bb50: 756e 6e61 626c 650a 2020 2020 2020 2020  unnable.        
-0001bb60: 6173 7365 7274 2074 7320 6e6f 7420 696e  assert ts not in
-0001bb70: 2073 656c 662e 7175 6575 6564 0a20 2020   self.queued.   
-0001bb80: 2020 2020 2061 7373 6572 7420 616c 6c28       assert all(
-0001bb90: 6474 732e 7768 6f5f 6861 7320 666f 7220  dts.who_has for 
-0001bba0: 6474 7320 696e 2074 732e 6465 7065 6e64  dts in ts.depend
-0001bbb0: 656e 6369 6573 290a 0a20 2020 2064 6566  encies)..    def
-0001bbc0: 205f 6164 645f 746f 5f70 726f 6365 7373   _add_to_process
-0001bbd0: 696e 6728 0a20 2020 2020 2020 2073 656c  ing(.        sel
-0001bbe0: 662c 2074 733a 2054 6173 6b53 7461 7465  f, ts: TaskState
-0001bbf0: 2c20 7773 3a20 576f 726b 6572 5374 6174  , ws: WorkerStat
-0001bc00: 652c 2073 7469 6d75 6c75 735f 6964 3a20  e, stimulus_id: 
-0001bc10: 7374 720a 2020 2020 2920 2d3e 2052 6563  str.    ) -> Rec
-0001bc20: 734d 7367 733a 0a20 2020 2020 2020 2022  sMsgs:.        "
-0001bc30: 2222 5365 7420 6120 7461 736b 2061 7320  ""Set a task as 
-0001bc40: 7072 6f63 6573 7369 6e67 206f 6e20 6120  processing on a 
-0001bc50: 776f 726b 6572 2061 6e64 2072 6574 7572  worker and retur
-0001bc60: 6e20 7468 6520 776f 726b 6572 206d 6573  n the worker mes
-0001bc70: 7361 6765 7320 746f 2073 656e 6422 2222  sages to send"""
-0001bc80: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-0001bc90: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
-0001bca0: 2020 2020 2020 2073 656c 662e 5f76 616c         self._val
-0001bcb0: 6964 6174 655f 7265 6164 7928 7473 290a  idate_ready(ts).
-0001bcc0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-0001bcd0: 7274 2077 7320 696e 2073 656c 662e 7275  rt ws in self.ru
-0001bce0: 6e6e 696e 672c 2073 656c 662e 7275 6e6e  nning, self.runn
-0001bcf0: 696e 670a 2020 2020 2020 2020 2020 2020  ing.            
-0001bd00: 6173 7365 7274 2028 6f20 3a3d 2073 656c  assert (o := sel
-0001bd10: 662e 776f 726b 6572 732e 6765 7428 7773  f.workers.get(ws
-0001bd20: 2e61 6464 7265 7373 2929 2069 7320 7773  .address)) is ws
-0001bd30: 2c20 2877 732c 206f 290a 0a20 2020 2020  , (ws, o)..     
-0001bd40: 2020 2077 732e 6164 645f 746f 5f70 726f     ws.add_to_pro
-0001bd50: 6365 7373 696e 6728 7473 290a 2020 2020  cessing(ts).    
-0001bd60: 2020 2020 7473 2e70 726f 6365 7373 696e      ts.processin
-0001bd70: 675f 6f6e 203d 2077 730a 2020 2020 2020  g_on = ws.      
-0001bd80: 2020 7473 2e73 7461 7465 203d 2022 7072    ts.state = "pr
-0001bd90: 6f63 6573 7369 6e67 220a 2020 2020 2020  ocessing".      
-0001bda0: 2020 7365 6c66 2e61 6371 7569 7265 5f72    self.acquire_r
-0001bdb0: 6573 6f75 7263 6573 2874 732c 2077 7329  esources(ts, ws)
-0001bdc0: 0a20 2020 2020 2020 2073 656c 662e 6368  .        self.ch
-0001bdd0: 6563 6b5f 6964 6c65 5f73 6174 7572 6174  eck_idle_saturat
-0001bde0: 6564 2877 7329 0a20 2020 2020 2020 2073  ed(ws).        s
-0001bdf0: 656c 662e 6e5f 7461 736b 7320 2b3d 2031  elf.n_tasks += 1
-0001be00: 0a0a 2020 2020 2020 2020 6966 2074 732e  ..        if ts.
-0001be10: 6163 746f 723a 0a20 2020 2020 2020 2020  actor:.         
-0001be20: 2020 2077 732e 6163 746f 7273 2e61 6464     ws.actors.add
-0001be30: 2874 7329 0a0a 2020 2020 2020 2020 6e64  (ts)..        nd
-0001be40: 6570 5f62 7974 6573 203d 2073 756d 2864  ep_bytes = sum(d
-0001be50: 7473 2e6e 6279 7465 7320 666f 7220 6474  ts.nbytes for dt
-0001be60: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
-0001be70: 6369 6573 290a 2020 2020 2020 2020 6966  cies).        if
-0001be80: 2028 0a20 2020 2020 2020 2020 2020 2077   (.            w
-0001be90: 732e 6d65 6d6f 7279 5f6c 696d 6974 0a20  s.memory_limit. 
-0001bea0: 2020 2020 2020 2020 2020 2061 6e64 206e             and n
-0001beb0: 6465 705f 6279 7465 7320 3e20 7773 2e6d  dep_bytes > ws.m
-0001bec0: 656d 6f72 795f 6c69 6d69 740a 2020 2020  emory_limit.    
-0001bed0: 2020 2020 2020 2020 616e 6420 6461 736b          and dask
-0001bee0: 2e63 6f6e 6669 672e 6765 7428 2264 6973  .config.get("dis
-0001bef0: 7472 6962 7574 6564 2e77 6f72 6b65 722e  tributed.worker.
-0001bf00: 6d65 6d6f 7279 2e74 6572 6d69 6e61 7465  memory.terminate
-0001bf10: 2229 0a20 2020 2020 2020 2029 3a0a 2020  ").        ):.  
-0001bf20: 2020 2020 2020 2020 2020 2320 4e6f 7465            # Note
-0001bf30: 0a20 2020 2020 2020 2020 2020 2023 202d  .            # -
-0001bf40: 2d2d 2d0a 2020 2020 2020 2020 2020 2020  ---.            
-0001bf50: 2320 5468 6973 2069 7320 6120 6372 7564  # This is a crud
-0001bf60: 6520 7361 6665 7479 2073 7973 7465 6d2c  e safety system,
-0001bf70: 206f 6e6c 7920 6d65 616e 7420 746f 2070   only meant to p
-0001bf80: 7265 7665 6e74 206f 7264 6572 2d6f 662d  revent order-of-
-0001bf90: 6d61 676e 6974 7564 650a 2020 2020 2020  magnitude.      
-0001bfa0: 2020 2020 2020 2320 6661 742d 6669 6e67        # fat-fing
-0001bfb0: 6572 2065 7272 6f72 732e 0a20 2020 2020  er errors..     
-0001bfc0: 2020 2020 2020 2023 0a20 2020 2020 2020         #.       
-0001bfd0: 2020 2020 2023 2046 6f72 2063 6f6c 6c65       # For colle
-0001bfe0: 6374 696f 6e20 6669 6e61 6c69 7a65 7273  ction finalizers
-0001bff0: 2061 6e64 2069 6e20 6765 6e65 7261 6c20   and in general 
-0001c000: 6d6f 7374 2063 6f6e 6361 7420 6f70 6572  most concat oper
-0001c010: 6174 696f 6e73 2c20 6974 2074 616b 6573  ations, it takes
-0001c020: 0a20 2020 2020 2020 2020 2020 2023 2061  .            # a
-0001c030: 206c 6f74 206c 6573 7320 746f 206b 696c   lot less to kil
-0001c040: 6c20 6f66 6620 7468 6520 776f 726b 6572  l off the worker
-0001c050: 3b20 796f 7527 6c6c 206a 7573 7420 6e65  ; you'll just ne
-0001c060: 6564 0a20 2020 2020 2020 2020 2020 2023  ed.            #
-0001c070: 206e 6465 705f 6279 7465 7320 2a20 3220   ndep_bytes * 2 
-0001c080: 3e20 7773 2e6d 656d 6f72 795f 6c69 6d69  > ws.memory_limi
-0001c090: 7420 2a20 7465 726d 696e 6174 6520 7468  t * terminate th
-0001c0a0: 7265 7368 6f6c 642e 0a20 2020 2020 2020  reshold..       
-0001c0b0: 2020 2020 2023 0a20 2020 2020 2020 2020       #.         
-0001c0c0: 2020 2023 2049 6e20 6865 7465 726f 6765     # In heteroge
-0001c0d0: 6e65 6f75 7320 636c 7573 7465 7273 2077  neous clusters w
-0001c0e0: 6974 6820 776f 726b 6572 7320 6d6f 756e  ith workers moun
-0001c0f0: 7469 6e67 2064 6966 6665 7265 6e74 2061  ting different a
-0001c100: 6d6f 756e 7473 206f 660a 2020 2020 2020  mounts of.      
-0001c110: 2020 2020 2020 2320 6d65 6d6f 7279 2c20        # memory, 
-0001c120: 7468 6520 7573 6572 2069 7320 6578 7065  the user is expe
-0001c130: 6374 6564 2074 6f20 6d61 6e75 616c 6c79  cted to manually
-0001c140: 2073 6574 2068 6f73 742f 776f 726b 6572   set host/worker
-0001c150: 2f72 6573 6f75 7263 650a 2020 2020 2020  /resource.      
-0001c160: 2020 2020 2020 2320 7265 7374 7269 6374        # restrict
-0001c170: 696f 6e73 2e0a 2020 2020 2020 2020 2020  ions..          
-0001c180: 2020 6d73 6720 3d20 280a 2020 2020 2020    msg = (.      
-0001c190: 2020 2020 2020 2020 2020 6622 5461 736b            f"Task
-0001c1a0: 207b 7473 2e6b 6579 2172 7d20 6861 7320   {ts.key!r} has 
-0001c1b0: 7b66 6f72 6d61 745f 6279 7465 7328 6e64  {format_bytes(nd
-0001c1c0: 6570 5f62 7974 6573 297d 2077 6f72 7468  ep_bytes)} worth
-0001c1d0: 206f 6620 696e 7075 7420 220a 2020 2020   of input ".    
-0001c1e0: 2020 2020 2020 2020 2020 2020 6622 6465              f"de
-0001c1f0: 7065 6e64 656e 6369 6573 2c20 6275 7420  pendencies, but 
-0001c200: 776f 726b 6572 207b 7773 2e61 6464 7265  worker {ws.addre
-0001c210: 7373 7d20 6861 7320 6d65 6d6f 7279 5f6c  ss} has memory_l
-0001c220: 696d 6974 2073 6574 2074 6f20 220a 2020  imit set to ".  
-0001c230: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-0001c240: 7b66 6f72 6d61 745f 6279 7465 7328 7773  {format_bytes(ws
-0001c250: 2e6d 656d 6f72 795f 6c69 6d69 7429 7d2e  .memory_limit)}.
-0001c260: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
-0001c270: 2020 2020 2020 2020 2020 2020 6966 2074              if t
-0001c280: 732e 7072 6566 6978 2e6e 616d 6520 3d3d  s.prefix.name ==
-0001c290: 2022 6669 6e61 6c69 7a65 223a 0a20 2020   "finalize":.   
-0001c2a0: 2020 2020 2020 2020 2020 2020 206d 7367               msg
-0001c2b0: 202b 3d20 280a 2020 2020 2020 2020 2020   += (.          
-0001c2c0: 2020 2020 2020 2020 2020 2220 4974 2073            " It s
-0001c2d0: 6565 6d73 206c 696b 6520 796f 7520 6361  eems like you ca
-0001c2e0: 6c6c 6564 2063 6c69 656e 742e 636f 6d70  lled client.comp
-0001c2f0: 7574 6528 2920 6f6e 2061 2068 7567 6520  ute() on a huge 
-0001c300: 636f 6c6c 6563 7469 6f6e 2e20 220a 2020  collection. ".  
-0001c310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c320: 2020 2243 6f6e 7369 6465 7220 7772 6974    "Consider writ
-0001c330: 696e 6720 746f 2064 6973 7472 6962 7574  ing to distribut
-0001c340: 6564 2073 746f 7261 6765 206f 7220 736c  ed storage or sl
-0001c350: 6963 696e 672f 7265 6475 6369 6e67 2066  icing/reducing f
-0001c360: 6972 7374 2e22 0a20 2020 2020 2020 2020  irst.".         
-0001c370: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0001c380: 2020 2020 206c 6f67 6765 722e 6572 726f       logger.erro
-0001c390: 7228 6d73 6729 0a20 2020 2020 2020 2020  r(msg).         
-0001c3a0: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
-0001c3b0: 7472 616e 7369 7469 6f6e 280a 2020 2020  transition(.    
-0001c3c0: 2020 2020 2020 2020 2020 2020 7473 2e6b              ts.k
-0001c3d0: 6579 2c0a 2020 2020 2020 2020 2020 2020  ey,.            
-0001c3e0: 2020 2020 2265 7272 6564 222c 0a20 2020      "erred",.   
-0001c3f0: 2020 2020 2020 2020 2020 2020 2065 7863               exc
-0001c400: 6570 7469 6f6e 3d70 6963 6b6c 652e 6475  eption=pickle.du
-0001c410: 6d70 7328 4d65 6d6f 7279 4572 726f 7228  mps(MemoryError(
-0001c420: 6d73 6729 292c 0a20 2020 2020 2020 2020  msg)),.         
-0001c430: 2020 2020 2020 2063 6175 7365 3d74 732e         cause=ts.
-0001c440: 6b65 792c 0a20 2020 2020 2020 2020 2020  key,.           
-0001c450: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
-0001c460: 3d73 7469 6d75 6c75 735f 6964 2c0a 2020  =stimulus_id,.  
-0001c470: 2020 2020 2020 2020 2020 2020 2020 776f                wo
-0001c480: 726b 6572 3d77 732e 6164 6472 6573 732c  rker=ws.address,
-0001c490: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
-0001c4a0: 2020 2020 2020 2020 7265 7475 726e 207b          return {
-0001c4b0: 7d2c 207b 7d2c 207b 7773 2e61 6464 7265  }, {}, {ws.addre
-0001c4c0: 7373 3a20 5b73 656c 662e 5f74 6173 6b5f  ss: [self._task_
-0001c4d0: 746f 5f6d 7367 2874 7329 5d7d 0a0a 2020  to_msg(ts)]}..  
-0001c4e0: 2020 6465 6620 5f65 7869 745f 7072 6f63    def _exit_proc
-0001c4f0: 6573 7369 6e67 5f63 6f6d 6d6f 6e28 7365  essing_common(se
-0001c500: 6c66 2c20 7473 3a20 5461 736b 5374 6174  lf, ts: TaskStat
-0001c510: 6529 202d 3e20 576f 726b 6572 5374 6174  e) -> WorkerStat
-0001c520: 6520 7c20 4e6f 6e65 3a0a 2020 2020 2020  e | None:.      
-0001c530: 2020 2222 2252 656d 6f76 6520 2a74 732a    """Remove *ts*
-0001c540: 2066 726f 6d20 7468 6520 7365 7420 6f66   from the set of
-0001c550: 2070 726f 6365 7373 696e 6720 7461 736b   processing task
-0001c560: 732e 0a0a 2020 2020 2020 2020 5265 7475  s...        Retu
-0001c570: 726e 730a 2020 2020 2020 2020 2d2d 2d2d  rns.        ----
-0001c580: 2d2d 2d0a 2020 2020 2020 2020 576f 726b  ---.        Work
-0001c590: 6572 2073 7461 7465 206f 6620 7468 6520  er state of the 
-0001c5a0: 776f 726b 6572 2074 6861 7420 7072 6f63  worker that proc
-0001c5b0: 6573 7365 6420 2a74 732a 2069 6620 7468  essed *ts* if th
-0001c5c0: 6520 776f 726b 6572 2069 7320 6375 7272  e worker is curr
-0001c5d0: 656e 742c 0a20 2020 2020 2020 204e 6f6e  ent,.        Non
-0001c5e0: 6520 6966 2074 6865 2077 6f72 6b65 7220  e if the worker 
-0001c5f0: 6973 2073 7461 6c65 2e0a 0a20 2020 2020  is stale...     
-0001c600: 2020 2053 6565 2061 6c73 6f0a 2020 2020     See also.    
-0001c610: 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020      --------.   
-0001c620: 2020 2020 2053 6368 6564 756c 6572 2e5f       Scheduler._
-0001c630: 7365 745f 6475 7261 7469 6f6e 5f65 7374  set_duration_est
-0001c640: 696d 6174 650a 2020 2020 2020 2020 2222  imate.        ""
-0001c650: 220a 2020 2020 2020 2020 7773 203d 2074  ".        ws = t
-0001c660: 732e 7072 6f63 6573 7369 6e67 5f6f 6e0a  s.processing_on.
-0001c670: 2020 2020 2020 2020 6173 7365 7274 2077          assert w
-0001c680: 730a 2020 2020 2020 2020 7473 2e70 726f  s.        ts.pro
-0001c690: 6365 7373 696e 675f 6f6e 203d 204e 6f6e  cessing_on = Non
-0001c6a0: 650a 0a20 2020 2020 2020 2077 732e 7265  e..        ws.re
-0001c6b0: 6d6f 7665 5f66 726f 6d5f 7072 6f63 6573  move_from_proces
-0001c6c0: 7369 6e67 2874 7329 0a20 2020 2020 2020  sing(ts).       
-0001c6d0: 2069 6620 7365 6c66 2e77 6f72 6b65 7273   if self.workers
-0001c6e0: 2e67 6574 2877 732e 6164 6472 6573 7329  .get(ws.address)
-0001c6f0: 2069 7320 6e6f 7420 7773 3a20 2023 206d   is not ws:  # m
-0001c700: 6179 2068 6176 6520 6265 656e 2072 656d  ay have been rem
-0001c710: 6f76 6564 0a20 2020 2020 2020 2020 2020  oved.           
-0001c720: 2072 6574 7572 6e20 4e6f 6e65 0a0a 2020   return None..  
-0001c730: 2020 2020 2020 7365 6c66 2e63 6865 636b        self.check
-0001c740: 5f69 646c 655f 7361 7475 7261 7465 6428  _idle_saturated(
-0001c750: 7773 290a 2020 2020 2020 2020 7365 6c66  ws).        self
-0001c760: 2e72 656c 6561 7365 5f72 6573 6f75 7263  .release_resourc
-0001c770: 6573 2874 732c 2077 7329 0a0a 2020 2020  es(ts, ws)..    
-0001c780: 2020 2020 7265 7475 726e 2077 730a 0a20      return ws.. 
-0001c790: 2020 2064 6566 205f 6164 645f 746f 5f6d     def _add_to_m
-0001c7a0: 656d 6f72 7928 0a20 2020 2020 2020 2073  emory(.        s
-0001c7b0: 656c 662c 0a20 2020 2020 2020 2074 733a  elf,.        ts:
-0001c7c0: 2054 6173 6b53 7461 7465 2c0a 2020 2020   TaskState,.    
-0001c7d0: 2020 2020 7773 3a20 576f 726b 6572 5374      ws: WorkerSt
-0001c7e0: 6174 652c 0a20 2020 2020 2020 2072 6563  ate,.        rec
-0001c7f0: 6f6d 6d65 6e64 6174 696f 6e73 3a20 5265  ommendations: Re
-0001c800: 6373 2c0a 2020 2020 2020 2020 636c 6965  cs,.        clie
-0001c810: 6e74 5f6d 7367 733a 204d 7367 732c 0a20  nt_msgs: Msgs,. 
-0001c820: 2020 2020 2020 2074 7970 653a 2062 7974         type: byt
-0001c830: 6573 207c 204e 6f6e 6520 3d20 4e6f 6e65  es | None = None
-0001c840: 2c0a 2020 2020 2020 2020 7479 7065 6e61  ,.        typena
-0001c850: 6d65 3a20 7374 7220 7c20 4e6f 6e65 203d  me: str | None =
-0001c860: 204e 6f6e 652c 0a20 2020 2029 202d 3e20   None,.    ) -> 
-0001c870: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
-0001c880: 2241 6464 2074 7320 746f 2074 6865 2073  "Add ts to the s
-0001c890: 6574 206f 6620 696e 2d6d 656d 6f72 7920  et of in-memory 
-0001c8a0: 7461 736b 7322 2222 0a20 2020 2020 2020  tasks""".       
-0001c8b0: 2069 6620 7365 6c66 2e76 616c 6964 6174   if self.validat
-0001c8c0: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
-0001c8d0: 7373 6572 7420 7473 206e 6f74 2069 6e20  ssert ts not in 
-0001c8e0: 7773 2e68 6173 5f77 6861 740a 0a20 2020  ws.has_what..   
-0001c8f0: 2020 2020 2073 656c 662e 6164 645f 7265       self.add_re
-0001c900: 706c 6963 6128 7473 2c20 7773 290a 0a20  plica(ts, ws).. 
-0001c910: 2020 2020 2020 2064 6570 7320 3d20 6c69         deps = li
-0001c920: 7374 2874 732e 6465 7065 6e64 656e 7473  st(ts.dependents
-0001c930: 290a 2020 2020 2020 2020 6966 206c 656e  ).        if len
-0001c940: 2864 6570 7329 203e 2031 3a0a 2020 2020  (deps) > 1:.    
-0001c950: 2020 2020 2020 2020 6465 7073 2e73 6f72          deps.sor
-0001c960: 7428 6b65 793d 6f70 6572 6174 6f72 2e61  t(key=operator.a
-0001c970: 7474 7267 6574 7465 7228 2270 7269 6f72  ttrgetter("prior
-0001c980: 6974 7922 292c 2072 6576 6572 7365 3d54  ity"), reverse=T
-0001c990: 7275 6529 0a0a 2020 2020 2020 2020 666f  rue)..        fo
-0001c9a0: 7220 6474 7320 696e 2064 6570 733a 0a20  r dts in deps:. 
-0001c9b0: 2020 2020 2020 2020 2020 2073 203d 2064             s = d
-0001c9c0: 7473 2e77 6169 7469 6e67 5f6f 6e0a 2020  ts.waiting_on.  
-0001c9d0: 2020 2020 2020 2020 2020 6966 2073 2061            if s a
-0001c9e0: 6e64 2074 7320 696e 2073 3a0a 2020 2020  nd ts in s:.    
-0001c9f0: 2020 2020 2020 2020 2020 2020 732e 6469              s.di
-0001ca00: 7363 6172 6428 7473 290a 2020 2020 2020  scard(ts).      
-0001ca10: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-0001ca20: 2073 3a20 2023 206e 6577 2074 6173 6b20   s:  # new task 
-0001ca30: 7265 6164 7920 746f 2072 756e 0a20 2020  ready to run.   
-0001ca40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ca50: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-0001ca60: 5b64 7473 2e6b 6579 5d20 3d20 2270 726f  [dts.key] = "pro
-0001ca70: 6365 7373 696e 6722 0a0a 2020 2020 2020  cessing"..      
-0001ca80: 2020 666f 7220 6474 7320 696e 2074 732e    for dts in ts.
-0001ca90: 6465 7065 6e64 656e 6369 6573 3a0a 2020  dependencies:.  
-0001caa0: 2020 2020 2020 2020 2020 7320 3d20 6474            s = dt
-0001cab0: 732e 7761 6974 6572 730a 2020 2020 2020  s.waiters.      
-0001cac0: 2020 2020 2020 6966 2073 3a0a 2020 2020        if s:.    
-0001cad0: 2020 2020 2020 2020 2020 2020 732e 6469              s.di
-0001cae0: 7363 6172 6428 7473 290a 2020 2020 2020  scard(ts).      
-0001caf0: 2020 2020 2020 6966 206e 6f74 2073 2061        if not s a
-0001cb00: 6e64 206e 6f74 2064 7473 2e77 686f 5f77  nd not dts.who_w
-0001cb10: 616e 7473 3a0a 2020 2020 2020 2020 2020  ants:.          
-0001cb20: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
-0001cb30: 7469 6f6e 735b 6474 732e 6b65 795d 203d  tions[dts.key] =
-0001cb40: 2022 7265 6c65 6173 6564 220a 0a20 2020   "released"..   
-0001cb50: 2020 2020 2069 6620 6e6f 7420 7473 2e77       if not ts.w
-0001cb60: 6169 7465 7273 2061 6e64 206e 6f74 2074  aiters and not t
-0001cb70: 732e 7768 6f5f 7761 6e74 733a 0a20 2020  s.who_wants:.   
-0001cb80: 2020 2020 2020 2020 2072 6563 6f6d 6d65           recomme
-0001cb90: 6e64 6174 696f 6e73 5b74 732e 6b65 795d  ndations[ts.key]
-0001cba0: 203d 2022 7265 6c65 6173 6564 220a 2020   = "released".  
-0001cbb0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0001cbc0: 2020 2020 2020 2020 7265 706f 7274 5f6d          report_m
-0001cbd0: 7367 3a20 6469 6374 5b73 7472 2c20 416e  sg: dict[str, An
-0001cbe0: 795d 203d 207b 226f 7022 3a20 226b 6579  y] = {"op": "key
-0001cbf0: 2d69 6e2d 6d65 6d6f 7279 222c 2022 6b65  -in-memory", "ke
-0001cc00: 7922 3a20 7473 2e6b 6579 7d0a 2020 2020  y": ts.key}.    
-0001cc10: 2020 2020 2020 2020 6966 2074 7970 6520          if type 
-0001cc20: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-0001cc30: 2020 2020 2020 2020 2020 2020 2072 6570               rep
-0001cc40: 6f72 745f 6d73 675b 2274 7970 6522 5d20  ort_msg["type"] 
-0001cc50: 3d20 7479 7065 0a20 2020 2020 2020 2020  = type.         
-0001cc60: 2020 2066 6f72 2063 7320 696e 2074 732e     for cs in ts.
-0001cc70: 7768 6f5f 7761 6e74 7320 6f72 2028 293a  who_wants or ():
-0001cc80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001cc90: 2063 6c69 656e 745f 6d73 6773 5b63 732e   client_msgs[cs.
-0001cca0: 636c 6965 6e74 5f6b 6579 5d20 3d20 5b72  client_key] = [r
-0001ccb0: 6570 6f72 745f 6d73 675d 0a0a 2020 2020  eport_msg]..    
-0001ccc0: 2020 2020 7473 2e73 7461 7465 203d 2022      ts.state = "
-0001ccd0: 6d65 6d6f 7279 220a 2020 2020 2020 2020  memory".        
-0001cce0: 7473 2e74 7970 6520 3d20 7479 7065 6e61  ts.type = typena
-0001ccf0: 6d65 2020 2320 7479 7065 3a20 6967 6e6f  me  # type: igno
-0001cd00: 7265 0a20 2020 2020 2020 2074 732e 6772  re.        ts.gr
-0001cd10: 6f75 702e 7479 7065 732e 6164 6428 7479  oup.types.add(ty
-0001cd20: 7065 6e61 6d65 2920 2023 2074 7970 653a  pename)  # type:
-0001cd30: 2069 676e 6f72 650a 0a20 2020 2020 2020   ignore..       
-0001cd40: 2063 7320 3d20 7365 6c66 2e63 6c69 656e   cs = self.clien
-0001cd50: 7473 5b22 6669 7265 2d61 6e64 2d66 6f72  ts["fire-and-for
-0001cd60: 6765 7422 5d0a 2020 2020 2020 2020 6966  get"].        if
-0001cd70: 2074 7320 696e 2063 732e 7761 6e74 735f   ts in cs.wants_
-0001cd80: 7768 6174 3a0a 2020 2020 2020 2020 2020  what:.          
-0001cd90: 2020 7365 6c66 2e5f 636c 6965 6e74 5f72    self._client_r
-0001cda0: 656c 6561 7365 735f 6b65 7973 280a 2020  eleases_keys(.  
-0001cdb0: 2020 2020 2020 2020 2020 2020 2020 6373                cs
-0001cdc0: 3d63 732c 0a20 2020 2020 2020 2020 2020  =cs,.           
-0001cdd0: 2020 2020 206b 6579 733d 5b74 732e 6b65       keys=[ts.ke
-0001cde0: 795d 2c0a 2020 2020 2020 2020 2020 2020  y],.            
-0001cdf0: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
-0001ce00: 6f6e 733d 7265 636f 6d6d 656e 6461 7469  ons=recommendati
-0001ce10: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
-0001ce20: 2029 0a0a 2020 2020 6465 6620 5f70 726f   )..    def _pro
-0001ce30: 7061 6761 7465 5f72 656c 6561 7365 6428  pagate_released(
-0001ce40: 7365 6c66 2c20 7473 3a20 5461 736b 5374  self, ts: TaskSt
-0001ce50: 6174 652c 2072 6563 6f6d 6d65 6e64 6174  ate, recommendat
-0001ce60: 696f 6e73 3a20 5265 6373 2920 2d3e 204e  ions: Recs) -> N
-0001ce70: 6f6e 653a 0a20 2020 2020 2020 2074 732e  one:.        ts.
-0001ce80: 7374 6174 6520 3d20 2272 656c 6561 7365  state = "release
-0001ce90: 6422 0a20 2020 2020 2020 206b 6579 203d  d".        key =
-0001cea0: 2074 732e 6b65 790a 0a20 2020 2020 2020   ts.key..       
-0001ceb0: 2069 6620 7473 2e68 6173 5f6c 6f73 745f   if ts.has_lost_
-0001cec0: 6465 7065 6e64 656e 6369 6573 3a0a 2020  dependencies:.  
-0001ced0: 2020 2020 2020 2020 2020 7265 636f 6d6d            recomm
-0001cee0: 656e 6461 7469 6f6e 735b 6b65 795d 203d  endations[key] =
-0001cef0: 2022 666f 7267 6f74 7465 6e22 0a20 2020   "forgotten".   
-0001cf00: 2020 2020 2065 6c69 6620 7473 2e77 6169       elif ts.wai
-0001cf10: 7465 7273 206f 7220 7473 2e77 686f 5f77  ters or ts.who_w
-0001cf20: 616e 7473 3a0a 2020 2020 2020 2020 2020  ants:.          
-0001cf30: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
-0001cf40: 735b 6b65 795d 203d 2022 7761 6974 696e  s[key] = "waitin
-0001cf50: 6722 0a0a 2020 2020 2020 2020 6966 2072  g"..        if r
-0001cf60: 6563 6f6d 6d65 6e64 6174 696f 6e73 2e67  ecommendations.g
-0001cf70: 6574 286b 6579 2920 213d 2022 7761 6974  et(key) != "wait
-0001cf80: 696e 6722 3a0a 2020 2020 2020 2020 2020  ing":.          
-0001cf90: 2020 666f 7220 6474 7320 696e 2074 732e    for dts in ts.
-0001cfa0: 6465 7065 6e64 656e 6369 6573 3a0a 2020  dependencies:.  
-0001cfb0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0001cfc0: 2064 7473 2e73 7461 7465 2021 3d20 2272   dts.state != "r
-0001cfd0: 656c 6561 7365 6422 3a0a 2020 2020 2020  eleased":.      
-0001cfe0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0001cff0: 2064 7473 2e77 6169 7465 7273 3a0a 2020   dts.waiters:.  
-0001d000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d010: 2020 2020 2020 6474 732e 7761 6974 6572        dts.waiter
-0001d020: 732e 6469 7363 6172 6428 7473 290a 2020  s.discard(ts).  
-0001d030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d040: 2020 6966 206e 6f74 2064 7473 2e77 6169    if not dts.wai
-0001d050: 7465 7273 2061 6e64 206e 6f74 2064 7473  ters and not dts
-0001d060: 2e77 686f 5f77 616e 7473 3a0a 2020 2020  .who_wants:.    
-0001d070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d080: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
-0001d090: 6f6e 735b 6474 732e 6b65 795d 203d 2022  ons[dts.key] = "
-0001d0a0: 7265 6c65 6173 6564 220a 2020 2020 2020  released".      
-0001d0b0: 2020 2020 2020 7473 2e77 6169 7465 7273        ts.waiters
-0001d0c0: 203d 204e 6f6e 650a 0a20 2020 2020 2020   = None..       
-0001d0d0: 2069 6620 7365 6c66 2e76 616c 6964 6174   if self.validat
-0001d0e0: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
-0001d0f0: 7373 6572 7420 6e6f 7420 7473 2e70 726f  ssert not ts.pro
-0001d100: 6365 7373 696e 675f 6f6e 0a20 2020 2020  cessing_on.     
-0001d110: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
-0001d120: 206e 6f74 2069 6e20 7365 6c66 2e71 7565   not in self.que
-0001d130: 7565 640a 0a20 2020 2064 6566 205f 7072  ued..    def _pr
-0001d140: 6f70 6167 6174 655f 666f 7267 6f74 7465  opagate_forgotte
-0001d150: 6e28 0a20 2020 2020 2020 2073 656c 662c  n(.        self,
-0001d160: 0a20 2020 2020 2020 2074 733a 2054 6173  .        ts: Tas
-0001d170: 6b53 7461 7465 2c0a 2020 2020 2020 2020  kState,.        
-0001d180: 7265 636f 6d6d 656e 6461 7469 6f6e 733a  recommendations:
-0001d190: 2052 6563 732c 0a20 2020 2020 2020 2077   Recs,.        w
-0001d1a0: 6f72 6b65 725f 6d73 6773 3a20 4d73 6773  orker_msgs: Msgs
-0001d1b0: 2c0a 2020 2020 2020 2020 7374 696d 756c  ,.        stimul
-0001d1c0: 7573 5f69 643a 2073 7472 2c0a 2020 2020  us_id: str,.    
-0001d1d0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-0001d1e0: 2020 2074 732e 7374 6174 6520 3d20 2266     ts.state = "f
-0001d1f0: 6f72 676f 7474 656e 220a 2020 2020 2020  orgotten".      
-0001d200: 2020 666f 7220 6474 7320 696e 2074 732e    for dts in ts.
-0001d210: 6465 7065 6e64 656e 7473 3a0a 2020 2020  dependents:.    
-0001d220: 2020 2020 2020 2020 6474 732e 6861 735f          dts.has_
-0001d230: 6c6f 7374 5f64 6570 656e 6465 6e63 6965  lost_dependencie
-0001d240: 7320 3d20 5472 7565 0a20 2020 2020 2020  s = True.       
-0001d250: 2020 2020 2064 7473 2e64 6570 656e 6465       dts.depende
-0001d260: 6e63 6965 732e 7265 6d6f 7665 2874 7329  ncies.remove(ts)
-0001d270: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0001d280: 6474 732e 7761 6974 696e 675f 6f6e 3a0a  dts.waiting_on:.
-0001d290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d2a0: 6474 732e 7761 6974 696e 675f 6f6e 2e64  dts.waiting_on.d
-0001d2b0: 6973 6361 7264 2874 7329 0a20 2020 2020  iscard(ts).     
-0001d2c0: 2020 2020 2020 2069 6620 6474 732e 7374         if dts.st
-0001d2d0: 6174 6520 6e6f 7420 696e 2028 226d 656d  ate not in ("mem
-0001d2e0: 6f72 7922 2c20 2265 7272 6564 2229 3a0a  ory", "erred"):.
-0001d2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d300: 2320 4361 6e6e 6f74 2063 6f6d 7075 7465  # Cannot compute
-0001d310: 2074 6173 6b20 616e 796d 6f72 650a 2020   task anymore.  
-0001d320: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0001d330: 636f 6d6d 656e 6461 7469 6f6e 735b 6474  commendations[dt
-0001d340: 732e 6b65 795d 203d 2022 666f 7267 6f74  s.key] = "forgot
-0001d350: 7465 6e22 0a20 2020 2020 2020 2074 732e  ten".        ts.
-0001d360: 6465 7065 6e64 656e 7473 2e63 6c65 6172  dependents.clear
-0001d370: 2829 0a20 2020 2020 2020 2074 732e 7761  ().        ts.wa
-0001d380: 6974 6572 7320 3d20 4e6f 6e65 0a0a 2020  iters = None..  
-0001d390: 2020 2020 2020 666f 7220 6474 7320 696e        for dts in
-0001d3a0: 2074 732e 6465 7065 6e64 656e 6369 6573   ts.dependencies
-0001d3b0: 3a0a 2020 2020 2020 2020 2020 2020 6474  :.            dt
-0001d3c0: 732e 6465 7065 6e64 656e 7473 2e72 656d  s.dependents.rem
-0001d3d0: 6f76 6528 7473 290a 2020 2020 2020 2020  ove(ts).        
-0001d3e0: 2020 2020 6966 2064 7473 2e77 6169 7465      if dts.waite
-0001d3f0: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
-0001d400: 2020 2020 6474 732e 7761 6974 6572 732e      dts.waiters.
-0001d410: 6469 7363 6172 6428 7473 290a 2020 2020  discard(ts).    
-0001d420: 2020 2020 2020 2020 6966 206e 6f74 2064          if not d
-0001d430: 7473 2e64 6570 656e 6465 6e74 7320 616e  ts.dependents an
-0001d440: 6420 6e6f 7420 6474 732e 7768 6f5f 7761  d not dts.who_wa
-0001d450: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
-0001d460: 2020 2020 2023 2054 6173 6b20 6e6f 7420       # Task not 
-0001d470: 6e65 6564 6564 2061 6e79 6d6f 7265 0a20  needed anymore. 
-0001d480: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0001d490: 7373 6572 7420 6474 7320 6973 206e 6f74  ssert dts is not
-0001d4a0: 2074 730a 2020 2020 2020 2020 2020 2020   ts.            
-0001d4b0: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
-0001d4c0: 6f6e 735b 6474 732e 6b65 795d 203d 2022  ons[dts.key] = "
-0001d4d0: 666f 7267 6f74 7465 6e22 0a20 2020 2020  forgotten".     
-0001d4e0: 2020 2074 732e 6465 7065 6e64 656e 6369     ts.dependenci
-0001d4f0: 6573 2e63 6c65 6172 2829 0a20 2020 2020  es.clear().     
-0001d500: 2020 2074 732e 7761 6974 696e 675f 6f6e     ts.waiting_on
-0001d510: 203d 204e 6f6e 650a 0a20 2020 2020 2020   = None..       
-0001d520: 2066 6f72 2077 7320 696e 2074 732e 7768   for ws in ts.wh
-0001d530: 6f5f 6861 7320 6f72 2028 293a 0a20 2020  o_has or ():.   
-0001d540: 2020 2020 2020 2020 2069 6620 7773 2e61           if ws.a
-0001d550: 6464 7265 7373 2069 6e20 7365 6c66 2e77  ddress in self.w
-0001d560: 6f72 6b65 7273 3a20 2023 2069 6e20 6361  orkers:  # in ca
-0001d570: 7365 2077 6f72 6b65 7220 6861 7320 6469  se worker has di
-0001d580: 6564 0a20 2020 2020 2020 2020 2020 2020  ed.             
-0001d590: 2020 2077 6f72 6b65 725f 6d73 6773 5b77     worker_msgs[w
-0001d5a0: 732e 6164 6472 6573 735d 203d 205b 0a20  s.address] = [. 
-0001d5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d5c0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-0001d5d0: 2020 2020 2020 2020 2020 2020 2022 6f70               "op
-0001d5e0: 223a 2022 6672 6565 2d6b 6579 7322 2c0a  ": "free-keys",.
-0001d5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d600: 2020 2020 2020 2020 226b 6579 7322 3a20          "keys": 
-0001d610: 5b74 732e 6b65 795d 2c0a 2020 2020 2020  [ts.key],.      
-0001d620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d630: 2020 2273 7469 6d75 6c75 735f 6964 223a    "stimulus_id":
-0001d640: 2073 7469 6d75 6c75 735f 6964 2c0a 2020   stimulus_id,.  
-0001d650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d660: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-0001d670: 2020 2020 5d0a 2020 2020 2020 2020 7365      ].        se
-0001d680: 6c66 2e72 656d 6f76 655f 616c 6c5f 7265  lf.remove_all_re
-0001d690: 706c 6963 6173 2874 7329 0a0a 2020 2020  plicas(ts)..    
-0001d6a0: 6465 6620 5f63 6c69 656e 745f 7265 6c65  def _client_rele
-0001d6b0: 6173 6573 5f6b 6579 7328 0a20 2020 2020  ases_keys(.     
-0001d6c0: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-0001d6d0: 206b 6579 733a 2043 6f6c 6c65 6374 696f   keys: Collectio
-0001d6e0: 6e5b 4b65 795d 2c0a 2020 2020 2020 2020  n[Key],.        
-0001d6f0: 6373 3a20 436c 6965 6e74 5374 6174 652c  cs: ClientState,
-0001d700: 0a20 2020 2020 2020 2072 6563 6f6d 6d65  .        recomme
-0001d710: 6e64 6174 696f 6e73 3a20 5265 6373 2c0a  ndations: Recs,.
-0001d720: 2020 2020 2920 2d3e 204e 6f6e 653a 0a20      ) -> None:. 
-0001d730: 2020 2020 2020 2022 2222 5265 6d6f 7665         """Remove
-0001d740: 206b 6579 7320 6672 6f6d 2063 6c69 656e   keys from clien
-0001d750: 7420 6465 7369 7265 6420 6c69 7374 2222  t desired list""
-0001d760: 220a 2020 2020 2020 2020 6c6f 6767 6572  ".        logger
-0001d770: 2e64 6562 7567 2822 436c 6965 6e74 2025  .debug("Client %
-0001d780: 7320 7265 6c65 6173 6573 206b 6579 733a  s releases keys:
-0001d790: 2025 7322 2c20 6373 2e63 6c69 656e 745f   %s", cs.client_
-0001d7a0: 6b65 792c 206b 6579 7329 0a20 2020 2020  key, keys).     
-0001d7b0: 2020 2066 6f72 206b 6579 2069 6e20 6b65     for key in ke
-0001d7c0: 7973 3a0a 2020 2020 2020 2020 2020 2020  ys:.            
-0001d7d0: 7473 203d 2073 656c 662e 7461 736b 732e  ts = self.tasks.
-0001d7e0: 6765 7428 6b65 7929 0a20 2020 2020 2020  get(key).       
-0001d7f0: 2020 2020 2069 6620 7473 2069 7320 6e6f       if ts is no
-0001d800: 7420 4e6f 6e65 2061 6e64 2074 7320 696e  t None and ts in
-0001d810: 2063 732e 7761 6e74 735f 7768 6174 3a0a   cs.wants_what:.
-0001d820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d830: 6373 2e77 616e 7473 5f77 6861 742e 7265  cs.wants_what.re
-0001d840: 6d6f 7665 2874 7329 0a20 2020 2020 2020  move(ts).       
-0001d850: 2020 2020 2020 2020 2069 6620 7473 2e77           if ts.w
-0001d860: 686f 5f77 616e 7473 3a0a 2020 2020 2020  ho_wants:.      
-0001d870: 2020 2020 2020 2020 2020 2020 2020 7473                ts
-0001d880: 2e77 686f 5f77 616e 7473 2e72 656d 6f76  .who_wants.remov
-0001d890: 6528 6373 290a 2020 2020 2020 2020 2020  e(cs).          
-0001d8a0: 2020 2020 2020 6966 206e 6f74 2074 732e        if not ts.
-0001d8b0: 7768 6f5f 7761 6e74 733a 0a20 2020 2020  who_wants:.     
-0001d8c0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0001d8d0: 6620 6e6f 7420 7473 2e64 6570 656e 6465  f not ts.depende
-0001d8e0: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
-0001d8f0: 2020 2020 2020 2020 2020 2020 2023 204e               # N
-0001d900: 6f20 6c69 7665 2064 6570 656e 6465 6e74  o live dependent
-0001d910: 732c 2063 616e 2066 6f72 6765 740a 2020  s, can forget.  
-0001d920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d930: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
-0001d940: 7469 6f6e 735b 7473 2e6b 6579 5d20 3d20  tions[ts.key] = 
-0001d950: 2266 6f72 676f 7474 656e 220a 2020 2020  "forgotten".    
-0001d960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d970: 656c 6966 2074 732e 7374 6174 6520 213d  elif ts.state !=
-0001d980: 2022 6572 7265 6422 2061 6e64 206e 6f74   "erred" and not
-0001d990: 2074 732e 7761 6974 6572 733a 0a20 2020   ts.waiters:.   
-0001d9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d9b0: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
-0001d9c0: 696f 6e73 5b74 732e 6b65 795d 203d 2022  ions[ts.key] = "
-0001d9d0: 7265 6c65 6173 6564 220a 0a20 2020 2064  released"..    d
-0001d9e0: 6566 205f 7461 736b 5f74 6f5f 6d73 6728  ef _task_to_msg(
-0001d9f0: 7365 6c66 2c20 7473 3a20 5461 736b 5374  self, ts: TaskSt
-0001da00: 6174 652c 2064 7572 6174 696f 6e3a 2066  ate, duration: f
-0001da10: 6c6f 6174 203d 202d 3129 202d 3e20 6469  loat = -1) -> di
-0001da20: 6374 5b73 7472 2c20 416e 795d 3a0a 2020  ct[str, Any]:.  
-0001da30: 2020 2020 2020 2222 2243 6f6e 7665 7274        """Convert
-0001da40: 2061 2073 696e 676c 6520 636f 6d70 7574   a single comput
-0001da50: 6174 696f 6e61 6c20 7461 736b 2074 6f20  ational task to 
-0001da60: 6120 6d65 7373 6167 6522 2222 0a20 2020  a message""".   
-0001da70: 2020 2020 2023 2046 4958 4d45 3a20 5468       # FIXME: Th
-0001da80: 6520 6475 7261 7469 6f6e 2061 7474 7269  e duration attri
-0001da90: 6275 7465 2069 7320 6e6f 7420 7573 6564  bute is not used
-0001daa0: 206f 6e20 776f 726b 6572 2e20 5765 2063   on worker. We c
-0001dab0: 6f75 6c64 2073 6176 6520 6f75 7273 656c  ould save oursel
-0001dac0: 7665 7320 7468 650a 2020 2020 2020 2020  ves the.        
-0001dad0: 2320 2020 2020 2020 2074 696d 6520 746f  #        time to
-0001dae0: 2063 6f6d 7075 7465 2061 6e64 2073 7562   compute and sub
-0001daf0: 6d69 7420 7468 6973 0a20 2020 2020 2020  mit this.       
-0001db00: 2069 6620 6475 7261 7469 6f6e 203c 2030   if duration < 0
-0001db10: 3a0a 2020 2020 2020 2020 2020 2020 6475  :.            du
-0001db20: 7261 7469 6f6e 203d 2073 656c 662e 6765  ration = self.ge
-0001db30: 745f 7461 736b 5f64 7572 6174 696f 6e28  t_task_duration(
-0001db40: 7473 290a 2020 2020 2020 2020 7473 2e72  ts).        ts.r
-0001db50: 756e 5f69 6420 3d20 6e65 7874 2854 6173  un_id = next(Tas
-0001db60: 6b53 7461 7465 2e5f 7275 6e5f 6964 5f69  kState._run_id_i
-0001db70: 7465 7261 746f 7229 0a20 2020 2020 2020  terator).       
-0001db80: 2061 7373 6572 7420 7473 2e70 7269 6f72   assert ts.prior
-0001db90: 6974 792c 2074 730a 2020 2020 2020 2020  ity, ts.        
-0001dba0: 6d73 673a 2064 6963 745b 7374 722c 2041  msg: dict[str, A
-0001dbb0: 6e79 5d20 3d20 7b0a 2020 2020 2020 2020  ny] = {.        
-0001dbc0: 2020 2020 226f 7022 3a20 2263 6f6d 7075      "op": "compu
-0001dbd0: 7465 2d74 6173 6b22 2c0a 2020 2020 2020  te-task",.      
-0001dbe0: 2020 2020 2020 226b 6579 223a 2074 732e        "key": ts.
-0001dbf0: 6b65 792c 0a20 2020 2020 2020 2020 2020  key,.           
-0001dc00: 2022 7275 6e5f 6964 223a 2074 732e 7275   "run_id": ts.ru
-0001dc10: 6e5f 6964 2c0a 2020 2020 2020 2020 2020  n_id,.          
-0001dc20: 2020 2270 7269 6f72 6974 7922 3a20 7473    "priority": ts
-0001dc30: 2e70 7269 6f72 6974 792c 0a20 2020 2020  .priority,.     
-0001dc40: 2020 2020 2020 2022 6475 7261 7469 6f6e         "duration
-0001dc50: 223a 2064 7572 6174 696f 6e2c 0a20 2020  ": duration,.   
-0001dc60: 2020 2020 2020 2020 2022 7374 696d 756c           "stimul
-0001dc70: 7573 5f69 6422 3a20 6622 636f 6d70 7574  us_id": f"comput
-0001dc80: 652d 7461 736b 2d7b 7469 6d65 2829 7d22  e-task-{time()}"
-0001dc90: 2c0a 2020 2020 2020 2020 2020 2020 2277  ,.            "w
-0001dca0: 686f 5f68 6173 223a 207b 0a20 2020 2020  ho_has": {.     
-0001dcb0: 2020 2020 2020 2020 2020 2064 7473 2e6b             dts.k
-0001dcc0: 6579 3a20 5b77 732e 6164 6472 6573 7320  ey: [ws.address 
-0001dcd0: 666f 7220 7773 2069 6e20 6474 732e 7768  for ws in dts.wh
-0001dce0: 6f5f 6861 7320 6f72 2028 295d 0a20 2020  o_has or ()].   
-0001dcf0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0001dd00: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
-0001dd10: 6465 6e63 6965 730a 2020 2020 2020 2020  dencies.        
-0001dd20: 2020 2020 7d2c 0a20 2020 2020 2020 2020      },.         
-0001dd30: 2020 2022 6e62 7974 6573 223a 207b 6474     "nbytes": {dt
-0001dd40: 732e 6b65 793a 2064 7473 2e6e 6279 7465  s.key: dts.nbyte
-0001dd50: 7320 666f 7220 6474 7320 696e 2074 732e  s for dts in ts.
-0001dd60: 6465 7065 6e64 656e 6369 6573 7d2c 0a20  dependencies},. 
-0001dd70: 2020 2020 2020 2020 2020 2022 7275 6e5f             "run_
-0001dd80: 7370 6563 223a 2054 6f50 6963 6b6c 6528  spec": ToPickle(
-0001dd90: 7473 2e72 756e 5f73 7065 6329 2c0a 2020  ts.run_spec),.  
-0001dda0: 2020 2020 2020 2020 2020 2272 6573 6f75            "resou
-0001ddb0: 7263 655f 7265 7374 7269 6374 696f 6e73  rce_restrictions
-0001ddc0: 223a 2074 732e 7265 736f 7572 6365 5f72  ": ts.resource_r
-0001ddd0: 6573 7472 6963 7469 6f6e 732c 0a20 2020  estrictions,.   
-0001dde0: 2020 2020 2020 2020 2022 6163 746f 7222           "actor"
-0001ddf0: 3a20 7473 2e61 6374 6f72 2c0a 2020 2020  : ts.actor,.    
-0001de00: 2020 2020 2020 2020 2261 6e6e 6f74 6174          "annotat
-0001de10: 696f 6e73 223a 2074 732e 616e 6e6f 7461  ions": ts.annota
-0001de20: 7469 6f6e 7320 6f72 207b 7d2c 0a20 2020  tions or {},.   
-0001de30: 2020 2020 2020 2020 2022 7370 616e 5f69           "span_i
-0001de40: 6422 3a20 7473 2e67 726f 7570 2e73 7061  d": ts.group.spa
-0001de50: 6e5f 6964 2c0a 2020 2020 2020 2020 7d0a  n_id,.        }.
-0001de60: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-0001de70: 7661 6c69 6461 7465 3a0a 2020 2020 2020  validate:.      
-0001de80: 2020 2020 2020 6173 7365 7274 2061 6c6c        assert all
-0001de90: 286d 7367 5b22 7768 6f5f 6861 7322 5d2e  (msg["who_has"].
-0001dea0: 7661 6c75 6573 2829 290a 0a20 2020 2020  values())..     
-0001deb0: 2020 2072 6574 7572 6e20 6d73 670a 0a0a     return msg...
-0001dec0: 636c 6173 7320 5363 6865 6475 6c65 7228  class Scheduler(
-0001ded0: 5363 6865 6475 6c65 7253 7461 7465 2c20  SchedulerState, 
-0001dee0: 5365 7276 6572 4e6f 6465 293a 0a20 2020  ServerNode):.   
-0001def0: 2022 2222 4479 6e61 6d69 6320 6469 7374   """Dynamic dist
-0001df00: 7269 6275 7465 6420 7461 736b 2073 6368  ributed task sch
-0001df10: 6564 756c 6572 0a0a 2020 2020 5468 6520  eduler..    The 
-0001df20: 7363 6865 6475 6c65 7220 7472 6163 6b73  scheduler tracks
-0001df30: 2074 6865 2063 7572 7265 6e74 2073 7461   the current sta
-0001df40: 7465 206f 6620 776f 726b 6572 732c 2064  te of workers, d
-0001df50: 6174 612c 2061 6e64 2063 6f6d 7075 7461  ata, and computa
-0001df60: 7469 6f6e 732e 0a20 2020 2054 6865 2073  tions..    The s
-0001df70: 6368 6564 756c 6572 206c 6973 7465 6e73  cheduler listens
-0001df80: 2066 6f72 2065 7665 6e74 7320 616e 6420   for events and 
-0001df90: 7265 7370 6f6e 6473 2062 7920 636f 6e74  responds by cont
-0001dfa0: 726f 6c6c 696e 6720 776f 726b 6572 730a  rolling workers.
-0001dfb0: 2020 2020 6170 7072 6f70 7269 6174 656c      appropriatel
-0001dfc0: 792e 2020 4974 2063 6f6e 7469 6e75 6f75  y.  It continuou
-0001dfd0: 736c 7920 7472 6965 7320 746f 2075 7365  sly tries to use
-0001dfe0: 2074 6865 2077 6f72 6b65 7273 2074 6f20   the workers to 
-0001dff0: 6578 6563 7574 6520 616e 2065 7665 720a  execute an ever.
-0001e000: 2020 2020 6772 6f77 696e 6720 6461 736b      growing dask
-0001e010: 2067 7261 7068 2e0a 0a20 2020 2041 6c6c   graph...    All
-0001e020: 2065 7665 6e74 7320 6172 6520 6861 6e64   events are hand
-0001e030: 6c65 6420 7175 6963 6b6c 792c 2069 6e20  led quickly, in 
-0001e040: 6c69 6e65 6172 2074 696d 6520 7769 7468  linear time with
-0001e050: 2072 6573 7065 6374 2074 6f20 7468 6569   respect to thei
-0001e060: 7220 696e 7075 740a 2020 2020 2877 6869  r input.    (whi
-0001e070: 6368 2069 7320 6f66 7465 6e20 6f66 2063  ch is often of c
-0001e080: 6f6e 7374 616e 7420 7369 7a65 2920 616e  onstant size) an
-0001e090: 6420 6765 6e65 7261 6c6c 7920 7769 7468  d generally with
-0001e0a0: 696e 2061 206d 696c 6c69 7365 636f 6e64  in a millisecond
-0001e0b0: 2e20 2054 6f0a 2020 2020 6163 636f 6d70  .  To.    accomp
-0001e0c0: 6c69 7368 2074 6869 7320 7468 6520 7363  lish this the sc
-0001e0d0: 6865 6475 6c65 7220 7472 6163 6b73 2061  heduler tracks a
-0001e0e0: 206c 6f74 206f 6620 7374 6174 652e 2020   lot of state.  
-0001e0f0: 4576 6572 7920 6f70 6572 6174 696f 6e0a  Every operation.
-0001e100: 2020 2020 6d61 696e 7461 696e 7320 7468      maintains th
-0001e110: 6520 636f 6e73 6973 7465 6e63 7920 6f66  e consistency of
-0001e120: 2074 6869 7320 7374 6174 652e 0a0a 2020   this state...  
-0001e130: 2020 5468 6520 7363 6865 6475 6c65 7220    The scheduler 
-0001e140: 636f 6d6d 756e 6963 6174 6573 2077 6974  communicates wit
-0001e150: 6820 7468 6520 6f75 7473 6964 6520 776f  h the outside wo
-0001e160: 726c 6420 7468 726f 7567 6820 436f 6d6d  rld through Comm
-0001e170: 206f 626a 6563 7473 2e0a 2020 2020 4974   objects..    It
-0001e180: 206d 6169 6e74 6169 6e73 2061 2063 6f6e   maintains a con
-0001e190: 7369 7374 656e 7420 616e 6420 7661 6c69  sistent and vali
-0001e1a0: 6420 7669 6577 206f 6620 7468 6520 776f  d view of the wo
-0001e1b0: 726c 6420 6576 656e 2077 6865 6e20 6c69  rld even when li
-0001e1c0: 7374 656e 696e 670a 2020 2020 746f 2073  stening.    to s
-0001e1d0: 6576 6572 616c 2063 6c69 656e 7473 2061  everal clients a
-0001e1e0: 7420 6f6e 6365 2e0a 0a20 2020 2041 2053  t once...    A S
-0001e1f0: 6368 6564 756c 6572 2069 7320 7479 7069  cheduler is typi
-0001e200: 6361 6c6c 7920 7374 6172 7465 6420 6569  cally started ei
-0001e210: 7468 6572 2077 6974 6820 7468 6520 6060  ther with the ``
-0001e220: 6461 736b 2073 6368 6564 756c 6572 6060  dask scheduler``
-0001e230: 0a20 2020 2065 7865 6375 7461 626c 653a  .    executable:
-0001e240: 3a0a 0a20 2020 2020 2020 2020 2420 6461  :..         $ da
-0001e250: 736b 2073 6368 6564 756c 6572 0a20 2020  sk scheduler.   
-0001e260: 2020 2020 2020 5363 6865 6475 6c65 7220        Scheduler 
-0001e270: 7374 6172 7465 6420 6174 2031 3237 2e30  started at 127.0
-0001e280: 2e30 2e31 3a38 3738 360a 0a20 2020 204f  .0.1:8786..    O
-0001e290: 7220 7769 7468 696e 2061 204c 6f63 616c  r within a Local
-0001e2a0: 436c 7573 7465 7220 6120 436c 6965 6e74  Cluster a Client
-0001e2b0: 2073 7461 7274 7320 7570 2077 6974 686f   starts up witho
-0001e2c0: 7574 2063 6f6e 6e65 6374 696f 6e0a 2020  ut connection.  
-0001e2d0: 2020 696e 666f 726d 6174 696f 6e3a 3a0a    information::.
-0001e2e0: 0a20 2020 2020 2020 203e 3e3e 2063 203d  .        >>> c =
-0001e2f0: 2043 6c69 656e 7428 2920 2023 2064 6f63   Client()  # doc
-0001e300: 7465 7374 3a20 2b53 4b49 500a 2020 2020  test: +SKIP.    
-0001e310: 2020 2020 3e3e 3e20 632e 636c 7573 7465      >>> c.cluste
-0001e320: 722e 7363 6865 6475 6c65 7220 2023 2064  r.scheduler  # d
-0001e330: 6f63 7465 7374 3a20 2b53 4b49 500a 2020  octest: +SKIP.  
-0001e340: 2020 2020 2020 5363 6865 6475 6c65 7228        Scheduler(
-0001e350: 2e2e 2e29 0a0a 2020 2020 5573 6572 7320  ...)..    Users 
-0001e360: 7479 7069 6361 6c6c 7920 646f 206e 6f74  typically do not
-0001e370: 2069 6e74 6572 6163 7420 7769 7468 2074   interact with t
-0001e380: 6865 2073 6368 6564 756c 6572 2064 6972  he scheduler dir
-0001e390: 6563 746c 7920 6275 7420 7261 7468 6572  ectly but rather
-0001e3a0: 2077 6974 680a 2020 2020 7468 6520 636c   with.    the cl
-0001e3b0: 6965 6e74 206f 626a 6563 7420 6060 436c  ient object ``Cl
-0001e3c0: 6965 6e74 6060 2e0a 0a20 2020 2054 6865  ient``...    The
-0001e3d0: 2060 6063 6f6e 7461 6374 5f61 6464 7265   ``contact_addre
-0001e3e0: 7373 6060 2070 6172 616d 6574 6572 2061  ss`` parameter a
-0001e3f0: 6c6c 6f77 7320 746f 2061 6476 6572 7469  llows to adverti
-0001e400: 7365 2061 2073 7065 6369 6669 6320 6164  se a specific ad
-0001e410: 6472 6573 7320 746f 0a20 2020 2074 6865  dress to.    the
-0001e420: 2077 6f72 6b65 7273 2066 6f72 2063 6f6d   workers for com
-0001e430: 6d75 6e69 6361 7469 6f6e 2077 6974 6820  munication with 
-0001e440: 7468 6520 7363 6865 6475 6c65 722c 2077  the scheduler, w
-0001e450: 6869 6368 2069 7320 6469 6666 6572 656e  hich is differen
-0001e460: 7420 7468 616e 0a20 2020 2074 6865 2061  t than.    the a
-0001e470: 6464 7265 7373 2074 6865 2073 6368 6564  ddress the sched
-0001e480: 756c 6572 2062 696e 6473 2074 6f2e 2054  uler binds to. T
-0001e490: 6869 7320 6973 2075 7365 6675 6c20 7768  his is useful wh
-0001e4a0: 656e 2074 6865 2073 6368 6564 756c 6572  en the scheduler
-0001e4b0: 0a20 2020 206c 6973 7465 6e73 206f 6e20  .    listens on 
-0001e4c0: 6120 7072 6976 6174 6520 6164 6472 6573  a private addres
-0001e4d0: 732c 2077 6869 6368 2074 6865 7265 666f  s, which therefo
-0001e4e0: 7265 2063 616e 6e6f 7420 6265 2075 7365  re cannot be use
-0001e4f0: 6420 6279 2074 6865 2077 6f72 6b65 7273  d by the workers
-0001e500: 0a20 2020 2074 6f20 636f 6e74 6163 7420  .    to contact 
-0001e510: 6974 2e0a 0a20 2020 202a 2a53 7461 7465  it...    **State
-0001e520: 2a2a 0a0a 2020 2020 5468 6520 7363 6865  **..    The sche
-0001e530: 6475 6c65 7220 636f 6e74 6169 6e73 2074  duler contains t
-0001e540: 6865 2066 6f6c 6c6f 7769 6e67 2073 7461  he following sta
-0001e550: 7465 2076 6172 6961 626c 6573 2e20 2045  te variables.  E
-0001e560: 6163 6820 7661 7269 6162 6c65 2069 730a  ach variable is.
-0001e570: 2020 2020 6c69 7374 6564 2061 6c6f 6e67      listed along
-0001e580: 2077 6974 6820 7768 6174 2069 7420 7374   with what it st
-0001e590: 6f72 6573 2061 6e64 2061 2062 7269 6566  ores and a brief
-0001e5a0: 2064 6573 6372 6970 7469 6f6e 2e0a 0a20   description... 
-0001e5b0: 2020 202a 202a 2a74 6173 6b73 3a2a 2a20     * **tasks:** 
-0001e5c0: 6060 7b74 6173 6b20 6b65 793a 2054 6173  ``{task key: Tas
-0001e5d0: 6b53 7461 7465 7d60 600a 2020 2020 2020  kState}``.      
-0001e5e0: 2020 5461 736b 7320 6375 7272 656e 746c    Tasks currentl
-0001e5f0: 7920 6b6e 6f77 6e20 746f 2074 6865 2073  y known to the s
-0001e600: 6368 6564 756c 6572 0a20 2020 202a 202a  cheduler.    * *
-0001e610: 2a75 6e72 756e 6e61 626c 653a 2a2a 2060  *unrunnable:** `
-0001e620: 607b 5461 736b 5374 6174 657d 6060 0a20  `{TaskState}``. 
-0001e630: 2020 2020 2020 2054 6173 6b73 2069 6e20         Tasks in 
-0001e640: 7468 6520 226e 6f2d 776f 726b 6572 2220  the "no-worker" 
-0001e650: 7374 6174 650a 0a20 2020 202a 202a 2a77  state..    * **w
-0001e660: 6f72 6b65 7273 3a2a 2a20 6060 7b77 6f72  orkers:** ``{wor
-0001e670: 6b65 7220 6b65 793a 2057 6f72 6b65 7253  ker key: WorkerS
-0001e680: 7461 7465 7d60 600a 2020 2020 2020 2020  tate}``.        
-0001e690: 576f 726b 6572 7320 6375 7272 656e 746c  Workers currentl
-0001e6a0: 7920 636f 6e6e 6563 7465 6420 746f 2074  y connected to t
-0001e6b0: 6865 2073 6368 6564 756c 6572 0a20 2020  he scheduler.   
-0001e6c0: 202a 202a 2a69 646c 653a 2a2a 2060 607b   * **idle:** ``{
-0001e6d0: 576f 726b 6572 5374 6174 657d 6060 3a0a  WorkerState}``:.
-0001e6e0: 2020 2020 2020 2020 5365 7420 6f66 2077          Set of w
-0001e6f0: 6f72 6b65 7273 2074 6861 7420 6172 6520  orkers that are 
-0001e700: 6e6f 7420 6675 6c6c 7920 7574 696c 697a  not fully utiliz
-0001e710: 6564 0a20 2020 202a 202a 2a73 6174 7572  ed.    * **satur
-0001e720: 6174 6564 3a2a 2a20 6060 7b57 6f72 6b65  ated:** ``{Worke
-0001e730: 7253 7461 7465 7d60 603a 0a20 2020 2020  rState}``:.     
-0001e740: 2020 2053 6574 206f 6620 776f 726b 6572     Set of worker
-0001e750: 7320 7468 6174 2061 7265 206e 6f74 206f  s that are not o
-0001e760: 7665 722d 7574 696c 697a 6564 0a0a 2020  ver-utilized..  
-0001e770: 2020 2a20 2a2a 686f 7374 5f69 6e66 6f3a    * **host_info:
-0001e780: 2a2a 2060 607b 686f 7374 6e61 6d65 3a20  ** ``{hostname: 
-0001e790: 6469 6374 7d60 603a 0a20 2020 2020 2020  dict}``:.       
-0001e7a0: 2049 6e66 6f72 6d61 7469 6f6e 2061 626f   Information abo
-0001e7b0: 7574 2065 6163 6820 776f 726b 6572 2068  ut each worker h
-0001e7c0: 6f73 740a 0a20 2020 202a 202a 2a63 6c69  ost..    * **cli
-0001e7d0: 656e 7473 3a2a 2a20 6060 7b63 6c69 656e  ents:** ``{clien
-0001e7e0: 7420 6b65 793a 2043 6c69 656e 7453 7461  t key: ClientSta
-0001e7f0: 7465 7d60 600a 2020 2020 2020 2020 436c  te}``.        Cl
-0001e800: 6965 6e74 7320 6375 7272 656e 746c 7920  ients currently 
-0001e810: 636f 6e6e 6563 7465 6420 746f 2074 6865  connected to the
-0001e820: 2073 6368 6564 756c 6572 0a0a 2020 2020   scheduler..    
-0001e830: 2a20 2a2a 7365 7276 6963 6573 3a2a 2a20  * **services:** 
-0001e840: 6060 7b73 7472 3a20 706f 7274 7d60 603a  ``{str: port}``:
-0001e850: 0a20 2020 2020 2020 204f 7468 6572 2073  .        Other s
-0001e860: 6572 7669 6365 7320 7275 6e6e 696e 6720  ervices running 
-0001e870: 6f6e 2074 6869 7320 7363 6865 6475 6c65  on this schedule
-0001e880: 722c 206c 696b 6520 426f 6b65 680a 2020  r, like Bokeh.  
-0001e890: 2020 2a20 2a2a 6c6f 6f70 3a2a 2a20 6060    * **loop:** ``
-0001e8a0: 494f 4c6f 6f70 6060 3a0a 2020 2020 2020  IOLoop``:.      
-0001e8b0: 2020 5468 6520 7275 6e6e 696e 6720 546f    The running To
-0001e8c0: 726e 6164 6f20 494f 4c6f 6f70 0a20 2020  rnado IOLoop.   
-0001e8d0: 202a 202a 2a63 6c69 656e 745f 636f 6d6d   * **client_comm
-0001e8e0: 733a 2a2a 2060 607b 636c 6965 6e74 206b  s:** ``{client k
-0001e8f0: 6579 3a20 436f 6d6d 7d60 600a 2020 2020  ey: Comm}``.    
-0001e900: 2020 2020 466f 7220 6561 6368 2063 6c69      For each cli
-0001e910: 656e 742c 2061 2043 6f6d 6d20 6f62 6a65  ent, a Comm obje
-0001e920: 6374 2075 7365 6420 746f 2072 6563 6569  ct used to recei
-0001e930: 7665 2074 6173 6b20 7265 7175 6573 7473  ve task requests
-0001e940: 2061 6e64 0a20 2020 2020 2020 2072 6570   and.        rep
-0001e950: 6f72 7420 7461 736b 2073 7461 7475 7320  ort task status 
-0001e960: 7570 6461 7465 732e 0a20 2020 202a 202a  updates..    * *
-0001e970: 2a73 7472 6561 6d5f 636f 6d6d 733a 2a2a  *stream_comms:**
-0001e980: 2060 607b 776f 726b 6572 206b 6579 3a20   ``{worker key: 
-0001e990: 436f 6d6d 7d60 600a 2020 2020 2020 2020  Comm}``.        
-0001e9a0: 466f 7220 6561 6368 2077 6f72 6b65 722c  For each worker,
-0001e9b0: 2061 2043 6f6d 6d20 6f62 6a65 6374 2066   a Comm object f
-0001e9c0: 726f 6d20 7768 6963 6820 7765 2062 6f74  rom which we bot
-0001e9d0: 6820 6163 6365 7074 2073 7469 6d75 6c69  h accept stimuli
-0001e9e0: 2061 6e64 0a20 2020 2020 2020 2072 6570   and.        rep
-0001e9f0: 6f72 7420 7265 7375 6c74 730a 2020 2020  ort results.    
-0001ea00: 2a20 2a2a 7461 736b 5f64 7572 6174 696f  * **task_duratio
-0001ea10: 6e3a 2a2a 2060 607b 6b65 792d 7072 6566  n:** ``{key-pref
-0001ea20: 6978 3a20 7469 6d65 7d60 600a 2020 2020  ix: time}``.    
-0001ea30: 2020 2020 5469 6d65 2077 6520 6578 7065      Time we expe
-0001ea40: 6374 2063 6572 7461 696e 2066 756e 6374  ct certain funct
-0001ea50: 696f 6e73 2074 6f20 7461 6b65 2c20 652e  ions to take, e.
-0001ea60: 672e 2060 607b 2773 756d 273a 2030 2e32  g. ``{'sum': 0.2
-0001ea70: 357d 6060 0a20 2020 2022 2222 0a0a 2020  5}``.    """..  
-0001ea80: 2020 6465 6661 756c 745f 706f 7274 203d    default_port =
-0001ea90: 2038 3738 360a 2020 2020 5f69 6e73 7461   8786.    _insta
-0001eaa0: 6e63 6573 3a20 436c 6173 7356 6172 5b77  nces: ClassVar[w
-0001eab0: 6561 6b72 6566 2e57 6561 6b53 6574 5b53  eakref.WeakSet[S
-0001eac0: 6368 6564 756c 6572 5d5d 203d 2077 6561  cheduler]] = wea
-0001ead0: 6b72 6566 2e57 6561 6b53 6574 2829 0a0a  kref.WeakSet()..
-0001eae0: 2020 2020 776f 726b 6572 5f74 746c 3a20      worker_ttl: 
-0001eaf0: 666c 6f61 7420 7c20 4e6f 6e65 0a20 2020  float | None.   
-0001eb00: 2069 646c 655f 7369 6e63 653a 2066 6c6f   idle_since: flo
-0001eb10: 6174 207c 204e 6f6e 650a 2020 2020 6964  at | None.    id
-0001eb20: 6c65 5f74 696d 656f 7574 3a20 666c 6f61  le_timeout: floa
-0001eb30: 7420 7c20 4e6f 6e65 0a20 2020 205f 6e6f  t | None.    _no
-0001eb40: 5f77 6f72 6b65 7273 5f73 696e 6365 3a20  _workers_since: 
-0001eb50: 666c 6f61 7420 7c20 4e6f 6e65 2020 2320  float | None  # 
-0001eb60: 4e6f 7465 3a20 6e6f 7420 4e6f 6e65 2069  Note: not None i
-0001eb70: 6666 2074 6865 7265 2061 7265 2070 656e  ff there are pen
-0001eb80: 6469 6e67 2074 6173 6b73 0a20 2020 206e  ding tasks.    n
-0001eb90: 6f5f 776f 726b 6572 735f 7469 6d65 6f75  o_workers_timeou
-0001eba0: 743a 2066 6c6f 6174 207c 204e 6f6e 650a  t: float | None.
-0001ebb0: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
-0001ebc0: 5f28 0a20 2020 2020 2020 2073 656c 662c  _(.        self,
-0001ebd0: 0a20 2020 2020 2020 206c 6f6f 703d 4e6f  .        loop=No
-0001ebe0: 6e65 2c0a 2020 2020 2020 2020 6465 6c65  ne,.        dele
-0001ebf0: 7465 5f69 6e74 6572 7661 6c3d 2235 3030  te_interval="500
-0001ec00: 6d73 222c 0a20 2020 2020 2020 2073 796e  ms",.        syn
-0001ec10: 6368 726f 6e69 7a65 5f77 6f72 6b65 725f  chronize_worker_
-0001ec20: 696e 7465 7276 616c 3d22 3630 7322 2c0a  interval="60s",.
-0001ec30: 2020 2020 2020 2020 7365 7276 6963 6573          services
-0001ec40: 3d4e 6f6e 652c 0a20 2020 2020 2020 2073  =None,.        s
-0001ec50: 6572 7669 6365 5f6b 7761 7267 733d 4e6f  ervice_kwargs=No
-0001ec60: 6e65 2c0a 2020 2020 2020 2020 616c 6c6f  ne,.        allo
-0001ec70: 7765 645f 6661 696c 7572 6573 3d4e 6f6e  wed_failures=Non
-0001ec80: 652c 0a20 2020 2020 2020 2065 7874 656e  e,.        exten
-0001ec90: 7369 6f6e 733d 4e6f 6e65 2c0a 2020 2020  sions=None,.    
-0001eca0: 2020 2020 7661 6c69 6461 7465 3d4e 6f6e      validate=Non
-0001ecb0: 652c 0a20 2020 2020 2020 2073 6368 6564  e,.        sched
-0001ecc0: 756c 6572 5f66 696c 653d 4e6f 6e65 2c0a  uler_file=None,.
-0001ecd0: 2020 2020 2020 2020 7365 6375 7269 7479          security
-0001ece0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2077  =None,.        w
-0001ecf0: 6f72 6b65 725f 7474 6c3d 4e6f 6e65 2c0a  orker_ttl=None,.
-0001ed00: 2020 2020 2020 2020 6964 6c65 5f74 696d          idle_tim
-0001ed10: 656f 7574 3d4e 6f6e 652c 0a20 2020 2020  eout=None,.     
-0001ed20: 2020 2069 6e74 6572 6661 6365 3d4e 6f6e     interface=Non
-0001ed30: 652c 0a20 2020 2020 2020 2068 6f73 743d  e,.        host=
-0001ed40: 4e6f 6e65 2c0a 2020 2020 2020 2020 706f  None,.        po
-0001ed50: 7274 3d30 2c0a 2020 2020 2020 2020 7072  rt=0,.        pr
-0001ed60: 6f74 6f63 6f6c 3d4e 6f6e 652c 0a20 2020  otocol=None,.   
-0001ed70: 2020 2020 2064 6173 6862 6f61 7264 5f61       dashboard_a
-0001ed80: 6464 7265 7373 3d4e 6f6e 652c 0a20 2020  ddress=None,.   
-0001ed90: 2020 2020 2064 6173 6862 6f61 7264 3d4e       dashboard=N
-0001eda0: 6f6e 652c 0a20 2020 2020 2020 2068 7474  one,.        htt
-0001edb0: 705f 7072 6566 6978 3d22 2f22 2c0a 2020  p_prefix="/",.  
-0001edc0: 2020 2020 2020 7072 656c 6f61 643d 4e6f        preload=No
-0001edd0: 6e65 2c0a 2020 2020 2020 2020 7072 656c  ne,.        prel
-0001ede0: 6f61 645f 6172 6776 3d28 292c 0a20 2020  oad_argv=(),.   
-0001edf0: 2020 2020 2070 6c75 6769 6e73 3d28 292c       plugins=(),
-0001ee00: 0a20 2020 2020 2020 2063 6f6e 7461 6374  .        contact
-0001ee10: 5f61 6464 7265 7373 3d4e 6f6e 652c 0a20  _address=None,. 
-0001ee20: 2020 2020 2020 2074 7261 6e73 6974 696f         transitio
-0001ee30: 6e5f 636f 756e 7465 725f 6d61 783d 4661  n_counter_max=Fa
-0001ee40: 6c73 652c 0a20 2020 2020 2020 206a 7570  lse,.        jup
-0001ee50: 7974 6572 3d46 616c 7365 2c0a 2020 2020  yter=False,.    
-0001ee60: 2020 2020 2a2a 6b77 6172 6773 2c0a 2020      **kwargs,.  
-0001ee70: 2020 293a 0a20 2020 2020 2020 2069 6620    ):.        if 
-0001ee80: 6461 736b 2e63 6f6e 6669 672e 6765 7428  dask.config.get(
-0001ee90: 2264 6973 7472 6962 7574 6564 2e73 6368  "distributed.sch
-0001eea0: 6564 756c 6572 2e70 6963 6b6c 6522 2c20  eduler.pickle", 
-0001eeb0: 6465 6661 756c 743d 5472 7565 2920 6973  default=True) is
-0001eec0: 2046 616c 7365 3a0a 2020 2020 2020 2020   False:.        
-0001eed0: 2020 2020 7261 6973 6520 5275 6e74 696d      raise Runtim
-0001eee0: 6545 7272 6f72 280a 2020 2020 2020 2020  eError(.        
-0001eef0: 2020 2020 2020 2020 2250 6963 6b6c 696e          "Picklin
-0001ef00: 6720 6361 6e20 6e6f 206c 6f6e 6765 7220  g can no longer 
-0001ef10: 6265 2064 6973 6162 6c65 6420 7769 7468  be disabled with
-0001ef20: 2074 6865 2060 6469 7374 7269 6275 7465   the `distribute
-0001ef30: 642e 7363 6865 6475 6c65 722e 7069 636b  d.scheduler.pick
-0001ef40: 6c65 6020 6f70 7469 6f6e 2e20 506c 6561  le` option. Plea
-0001ef50: 7365 2072 656d 6f76 6520 7468 6973 2063  se remove this c
-0001ef60: 6f6e 6669 6775 7261 7469 6f6e 2074 6f20  onfiguration to 
-0001ef70: 7374 6172 7420 7468 6520 7363 6865 6475  start the schedu
-0001ef80: 6c65 722e 220a 2020 2020 2020 2020 2020  ler.".          
-0001ef90: 2020 290a 2020 2020 2020 2020 6966 206c    ).        if l
-0001efa0: 6f6f 7020 6973 206e 6f74 204e 6f6e 653a  oop is not None:
-0001efb0: 0a20 2020 2020 2020 2020 2020 2077 6172  .            war
-0001efc0: 6e69 6e67 732e 7761 726e 280a 2020 2020  nings.warn(.    
-0001efd0: 2020 2020 2020 2020 2020 2020 2274 6865              "the
-0001efe0: 206c 6f6f 7020 6b77 6172 6720 746f 2053   loop kwarg to S
-0001eff0: 6368 6564 756c 6572 2069 7320 6465 7072  cheduler is depr
-0001f000: 6563 6174 6564 222c 0a20 2020 2020 2020  ecated",.       
-0001f010: 2020 2020 2020 2020 2044 6570 7265 6361           Depreca
-0001f020: 7469 6f6e 5761 726e 696e 672c 0a20 2020  tionWarning,.   
-0001f030: 2020 2020 2020 2020 2020 2020 2073 7461               sta
-0001f040: 636b 6c65 7665 6c3d 322c 0a20 2020 2020  cklevel=2,.     
-0001f050: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-0001f060: 2020 7365 6c66 2e6c 6f6f 7020 3d20 7365    self.loop = se
-0001f070: 6c66 2e69 6f5f 6c6f 6f70 203d 2049 4f4c  lf.io_loop = IOL
-0001f080: 6f6f 702e 6375 7272 656e 7428 290a 2020  oop.current().  
-0001f090: 2020 2020 2020 7365 6c66 2e5f 7365 7475        self._setu
-0001f0a0: 705f 6c6f 6767 696e 6728 6c6f 6767 6572  p_logging(logger
-0001f0b0: 290a 0a20 2020 2020 2020 2023 2041 7474  )..        # Att
-0001f0c0: 7269 6275 7465 730a 2020 2020 2020 2020  ributes.        
-0001f0d0: 6966 2063 6f6e 7461 6374 5f61 6464 7265  if contact_addre
-0001f0e0: 7373 2069 7320 4e6f 6e65 3a0a 2020 2020  ss is None:.    
-0001f0f0: 2020 2020 2020 2020 636f 6e74 6163 745f          contact_
-0001f100: 6164 6472 6573 7320 3d20 6461 736b 2e63  address = dask.c
-0001f110: 6f6e 6669 672e 6765 7428 2264 6973 7472  onfig.get("distr
-0001f120: 6962 7574 6564 2e73 6368 6564 756c 6572  ibuted.scheduler
-0001f130: 2e63 6f6e 7461 6374 2d61 6464 7265 7373  .contact-address
-0001f140: 2229 0a20 2020 2020 2020 2073 656c 662e  ").        self.
-0001f150: 636f 6e74 6163 745f 6164 6472 6573 7320  contact_address 
-0001f160: 3d20 636f 6e74 6163 745f 6164 6472 6573  = contact_addres
-0001f170: 730a 2020 2020 2020 2020 6966 2061 6c6c  s.        if all
-0001f180: 6f77 6564 5f66 6169 6c75 7265 7320 6973  owed_failures is
-0001f190: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-0001f1a0: 2020 2061 6c6c 6f77 6564 5f66 6169 6c75     allowed_failu
-0001f1b0: 7265 7320 3d20 6461 736b 2e63 6f6e 6669  res = dask.confi
-0001f1c0: 672e 6765 7428 2264 6973 7472 6962 7574  g.get("distribut
-0001f1d0: 6564 2e73 6368 6564 756c 6572 2e61 6c6c  ed.scheduler.all
-0001f1e0: 6f77 6564 2d66 6169 6c75 7265 7322 290a  owed-failures").
-0001f1f0: 2020 2020 2020 2020 7365 6c66 2e61 6c6c          self.all
-0001f200: 6f77 6564 5f66 6169 6c75 7265 7320 3d20  owed_failures = 
-0001f210: 616c 6c6f 7765 645f 6661 696c 7572 6573  allowed_failures
-0001f220: 0a20 2020 2020 2020 2069 6620 7661 6c69  .        if vali
-0001f230: 6461 7465 2069 7320 4e6f 6e65 3a0a 2020  date is None:.  
-0001f240: 2020 2020 2020 2020 2020 7661 6c69 6461            valida
-0001f250: 7465 203d 2064 6173 6b2e 636f 6e66 6967  te = dask.config
-0001f260: 2e67 6574 2822 6469 7374 7269 6275 7465  .get("distribute
-0001f270: 642e 7363 6865 6475 6c65 722e 7661 6c69  d.scheduler.vali
-0001f280: 6461 7465 2229 0a20 2020 2020 2020 2073  date").        s
-0001f290: 656c 662e 7072 6f63 203d 2070 7375 7469  elf.proc = psuti
-0001f2a0: 6c2e 5072 6f63 6573 7328 290a 2020 2020  l.Process().    
-0001f2b0: 2020 2020 7365 6c66 2e64 656c 6574 655f      self.delete_
-0001f2c0: 696e 7465 7276 616c 203d 2070 6172 7365  interval = parse
-0001f2d0: 5f74 696d 6564 656c 7461 2864 656c 6574  _timedelta(delet
-0001f2e0: 655f 696e 7465 7276 616c 2c20 6465 6661  e_interval, defa
-0001f2f0: 756c 743d 226d 7322 290a 2020 2020 2020  ult="ms").      
-0001f300: 2020 7365 6c66 2e73 796e 6368 726f 6e69    self.synchroni
-0001f310: 7a65 5f77 6f72 6b65 725f 696e 7465 7276  ze_worker_interv
-0001f320: 616c 203d 2070 6172 7365 5f74 696d 6564  al = parse_timed
-0001f330: 656c 7461 280a 2020 2020 2020 2020 2020  elta(.          
-0001f340: 2020 7379 6e63 6872 6f6e 697a 655f 776f    synchronize_wo
-0001f350: 726b 6572 5f69 6e74 6572 7661 6c2c 2064  rker_interval, d
-0001f360: 6566 6175 6c74 3d22 6d73 220a 2020 2020  efault="ms".    
-0001f370: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
-0001f380: 6c66 2e73 6572 7669 6365 5f73 7065 6373  lf.service_specs
-0001f390: 203d 2073 6572 7669 6365 7320 6f72 207b   = services or {
-0001f3a0: 7d0a 2020 2020 2020 2020 7365 6c66 2e73  }.        self.s
-0001f3b0: 6572 7669 6365 5f6b 7761 7267 7320 3d20  ervice_kwargs = 
-0001f3c0: 7365 7276 6963 655f 6b77 6172 6773 206f  service_kwargs o
-0001f3d0: 7220 7b7d 0a20 2020 2020 2020 2073 656c  r {}.        sel
-0001f3e0: 662e 7365 7276 6963 6573 203d 207b 7d0a  f.services = {}.
-0001f3f0: 2020 2020 2020 2020 7365 6c66 2e73 6368          self.sch
-0001f400: 6564 756c 6572 5f66 696c 6520 3d20 7363  eduler_file = sc
-0001f410: 6865 6475 6c65 725f 6669 6c65 0a0a 2020  heduler_file..  
-0001f420: 2020 2020 2020 7365 6c66 2e77 6f72 6b65        self.worke
-0001f430: 725f 7474 6c20 3d20 7061 7273 655f 7469  r_ttl = parse_ti
-0001f440: 6d65 6465 6c74 6128 0a20 2020 2020 2020  medelta(.       
-0001f450: 2020 2020 2077 6f72 6b65 725f 7474 6c20       worker_ttl 
-0001f460: 6f72 2064 6173 6b2e 636f 6e66 6967 2e67  or dask.config.g
-0001f470: 6574 2822 6469 7374 7269 6275 7465 642e  et("distributed.
-0001f480: 7363 6865 6475 6c65 722e 776f 726b 6572  scheduler.worker
-0001f490: 2d74 746c 2229 0a20 2020 2020 2020 2029  -ttl").        )
-0001f4a0: 0a20 2020 2020 2020 2073 656c 662e 6964  .        self.id
-0001f4b0: 6c65 5f74 696d 656f 7574 203d 2070 6172  le_timeout = par
-0001f4c0: 7365 5f74 696d 6564 656c 7461 280a 2020  se_timedelta(.  
-0001f4d0: 2020 2020 2020 2020 2020 6964 6c65 5f74            idle_t
-0001f4e0: 696d 656f 7574 206f 7220 6461 736b 2e63  imeout or dask.c
-0001f4f0: 6f6e 6669 672e 6765 7428 2264 6973 7472  onfig.get("distr
-0001f500: 6962 7574 6564 2e73 6368 6564 756c 6572  ibuted.scheduler
-0001f510: 2e69 646c 652d 7469 6d65 6f75 7422 290a  .idle-timeout").
-0001f520: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0001f530: 2020 7365 6c66 2e69 646c 655f 7369 6e63    self.idle_sinc
-0001f540: 6520 3d20 7469 6d65 2829 0a20 2020 2020  e = time().     
-0001f550: 2020 2073 656c 662e 6e6f 5f77 6f72 6b65     self.no_worke
-0001f560: 7273 5f74 696d 656f 7574 203d 2070 6172  rs_timeout = par
-0001f570: 7365 5f74 696d 6564 656c 7461 280a 2020  se_timedelta(.  
-0001f580: 2020 2020 2020 2020 2020 6461 736b 2e63            dask.c
-0001f590: 6f6e 6669 672e 6765 7428 2264 6973 7472  onfig.get("distr
-0001f5a0: 6962 7574 6564 2e73 6368 6564 756c 6572  ibuted.scheduler
-0001f5b0: 2e6e 6f2d 776f 726b 6572 732d 7469 6d65  .no-workers-time
-0001f5c0: 6f75 7422 290a 2020 2020 2020 2020 290a  out").        ).
-0001f5d0: 2020 2020 2020 2020 7365 6c66 2e5f 6e6f          self._no
-0001f5e0: 5f77 6f72 6b65 7273 5f73 696e 6365 203d  _workers_since =
-0001f5f0: 204e 6f6e 650a 0a20 2020 2020 2020 2073   None..        s
-0001f600: 656c 662e 7469 6d65 5f73 7461 7274 6564  elf.time_started
-0001f610: 203d 2073 656c 662e 6964 6c65 5f73 696e   = self.idle_sin
-0001f620: 6365 2020 2320 636f 6d70 6174 6962 696c  ce  # compatibil
-0001f630: 6974 7920 666f 7220 6461 736b 2d67 6174  ity for dask-gat
-0001f640: 6577 6179 0a20 2020 2020 2020 2073 656c  eway.        sel
-0001f650: 662e 5f72 6570 6c69 6361 5f6c 6f63 6b20  f._replica_lock 
-0001f660: 3d20 524c 6f63 6b28 290a 2020 2020 2020  = RLock().      
-0001f670: 2020 7365 6c66 2e62 616e 6477 6964 7468    self.bandwidth
-0001f680: 5f77 6f72 6b65 7273 203d 2064 6566 6175  _workers = defau
-0001f690: 6c74 6469 6374 2866 6c6f 6174 290a 2020  ltdict(float).  
-0001f6a0: 2020 2020 2020 7365 6c66 2e62 616e 6477        self.bandw
-0001f6b0: 6964 7468 5f74 7970 6573 203d 2064 6566  idth_types = def
-0001f6c0: 6175 6c74 6469 6374 2866 6c6f 6174 290a  aultdict(float).
-0001f6d0: 0a20 2020 2020 2020 2023 2044 6f6e 2774  .        # Don't
-0001f6e0: 2063 6173 7420 696e 7420 6d65 7472 6963   cast int metric
-0001f6f0: 7320 746f 2066 6c6f 6174 0a20 2020 2020  s to float.     
-0001f700: 2020 2073 656c 662e 6375 6d75 6c61 7469     self.cumulati
-0001f710: 7665 5f77 6f72 6b65 725f 6d65 7472 6963  ve_worker_metric
-0001f720: 7320 3d20 6465 6661 756c 7464 6963 7428  s = defaultdict(
-0001f730: 696e 7429 0a0a 2020 2020 2020 2020 6966  int)..        if
-0001f740: 206e 6f74 2070 7265 6c6f 6164 3a0a 2020   not preload:.  
-0001f750: 2020 2020 2020 2020 2020 7072 656c 6f61            preloa
-0001f760: 6420 3d20 6461 736b 2e63 6f6e 6669 672e  d = dask.config.
-0001f770: 6765 7428 2264 6973 7472 6962 7574 6564  get("distributed
-0001f780: 2e73 6368 6564 756c 6572 2e70 7265 6c6f  .scheduler.prelo
-0001f790: 6164 2229 0a20 2020 2020 2020 2069 6620  ad").        if 
-0001f7a0: 6e6f 7420 7072 656c 6f61 645f 6172 6776  not preload_argv
-0001f7b0: 3a0a 2020 2020 2020 2020 2020 2020 7072  :.            pr
-0001f7c0: 656c 6f61 645f 6172 6776 203d 2064 6173  eload_argv = das
-0001f7d0: 6b2e 636f 6e66 6967 2e67 6574 2822 6469  k.config.get("di
-0001f7e0: 7374 7269 6275 7465 642e 7363 6865 6475  stributed.schedu
-0001f7f0: 6c65 722e 7072 656c 6f61 642d 6172 6776  ler.preload-argv
-0001f800: 2229 0a20 2020 2020 2020 2073 656c 662e  ").        self.
-0001f810: 7072 656c 6f61 6473 203d 2070 7265 6c6f  preloads = prelo
-0001f820: 6164 696e 672e 7072 6f63 6573 735f 7072  ading.process_pr
-0001f830: 656c 6f61 6473 2873 656c 662c 2070 7265  eloads(self, pre
-0001f840: 6c6f 6164 2c20 7072 656c 6f61 645f 6172  load, preload_ar
-0001f850: 6776 290a 0a20 2020 2020 2020 2069 6620  gv)..        if 
-0001f860: 6973 696e 7374 616e 6365 2873 6563 7572  isinstance(secur
-0001f870: 6974 792c 2064 6963 7429 3a0a 2020 2020  ity, dict):.    
-0001f880: 2020 2020 2020 2020 7365 6375 7269 7479          security
-0001f890: 203d 2053 6563 7572 6974 7928 2a2a 7365   = Security(**se
-0001f8a0: 6375 7269 7479 290a 2020 2020 2020 2020  curity).        
-0001f8b0: 7365 6c66 2e73 6563 7572 6974 7920 3d20  self.security = 
-0001f8c0: 7365 6375 7269 7479 206f 7220 5365 6375  security or Secu
-0001f8d0: 7269 7479 2829 0a20 2020 2020 2020 2061  rity().        a
-0001f8e0: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
-0001f8f0: 2873 656c 662e 7365 6375 7269 7479 2c20  (self.security, 
-0001f900: 5365 6375 7269 7479 290a 2020 2020 2020  Security).      
-0001f910: 2020 7365 6c66 2e63 6f6e 6e65 6374 696f    self.connectio
-0001f920: 6e5f 6172 6773 203d 2073 656c 662e 7365  n_args = self.se
-0001f930: 6375 7269 7479 2e67 6574 5f63 6f6e 6e65  curity.get_conne
-0001f940: 6374 696f 6e5f 6172 6773 2822 7363 6865  ction_args("sche
-0001f950: 6475 6c65 7222 290a 2020 2020 2020 2020  duler").        
-0001f960: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e5f  self.connection_
-0001f970: 6172 6773 5b22 6861 6e64 7368 616b 655f  args["handshake_
-0001f980: 6f76 6572 7269 6465 7322 5d20 3d20 7b20  overrides"] = { 
-0001f990: 2023 2063 6f6d 6d6f 6e20 6465 6e6f 6d69   # common denomi
-0001f9a0: 6e61 746f 720a 2020 2020 2020 2020 2020  nator.          
-0001f9b0: 2020 2270 6963 6b6c 652d 7072 6f74 6f63    "pickle-protoc
-0001f9c0: 6f6c 223a 2034 0a20 2020 2020 2020 207d  ol": 4.        }
-0001f9d0: 0a0a 2020 2020 2020 2020 7365 6c66 2e5f  ..        self._
-0001f9e0: 7374 6172 745f 6164 6472 6573 7320 3d20  start_address = 
-0001f9f0: 6164 6472 6573 7365 735f 6672 6f6d 5f75  addresses_from_u
-0001fa00: 7365 725f 6172 6773 280a 2020 2020 2020  ser_args(.      
-0001fa10: 2020 2020 2020 686f 7374 3d68 6f73 742c        host=host,
-0001fa20: 0a20 2020 2020 2020 2020 2020 2070 6f72  .            por
-0001fa30: 743d 706f 7274 2c0a 2020 2020 2020 2020  t=port,.        
-0001fa40: 2020 2020 696e 7465 7266 6163 653d 696e      interface=in
-0001fa50: 7465 7266 6163 652c 0a20 2020 2020 2020  terface,.       
-0001fa60: 2020 2020 2070 726f 746f 636f 6c3d 7072       protocol=pr
-0001fa70: 6f74 6f63 6f6c 2c0a 2020 2020 2020 2020  otocol,.        
-0001fa80: 2020 2020 7365 6375 7269 7479 3d73 6563      security=sec
-0001fa90: 7572 6974 792c 0a20 2020 2020 2020 2020  urity,.         
-0001faa0: 2020 2064 6566 6175 6c74 5f70 6f72 743d     default_port=
-0001fab0: 7365 6c66 2e64 6566 6175 6c74 5f70 6f72  self.default_por
-0001fac0: 742c 0a20 2020 2020 2020 2029 0a0a 2020  t,.        )..  
-0001fad0: 2020 2020 2020 6874 7470 5f73 6572 7665        http_serve
-0001fae0: 725f 6d6f 6475 6c65 7320 3d20 6461 736b  r_modules = dask
-0001faf0: 2e63 6f6e 6669 672e 6765 7428 2264 6973  .config.get("dis
-0001fb00: 7472 6962 7574 6564 2e73 6368 6564 756c  tributed.schedul
-0001fb10: 6572 2e68 7474 702e 726f 7574 6573 2229  er.http.routes")
-0001fb20: 0a20 2020 2020 2020 2073 686f 775f 6461  .        show_da
-0001fb30: 7368 626f 6172 6420 3d20 6461 7368 626f  shboard = dashbo
-0001fb40: 6172 6420 6f72 2028 6461 7368 626f 6172  ard or (dashboar
-0001fb50: 6420 6973 204e 6f6e 6520 616e 6420 6461  d is None and da
-0001fb60: 7368 626f 6172 645f 6164 6472 6573 7329  shboard_address)
-0001fb70: 0a20 2020 2020 2020 2023 2069 6e73 7461  .        # insta
-0001fb80: 6c6c 2076 616e 696c 6c61 2072 6f75 7465  ll vanilla route
-0001fb90: 2069 6620 7368 6f77 5f64 6173 6862 6f61   if show_dashboa
-0001fba0: 7264 2062 7574 2062 6f6b 6568 2069 7320  rd but bokeh is 
-0001fbb0: 6e6f 7420 696e 7374 616c 6c65 640a 2020  not installed.  
-0001fbc0: 2020 2020 2020 6966 2073 686f 775f 6461        if show_da
-0001fbd0: 7368 626f 6172 643a 0a20 2020 2020 2020  shboard:.       
-0001fbe0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-0001fbf0: 2020 2020 2020 2020 2020 696d 706f 7274            import
-0001fc00: 2064 6973 7472 6962 7574 6564 2e64 6173   distributed.das
-0001fc10: 6862 6f61 7264 2e73 6368 6564 756c 6572  hboard.scheduler
-0001fc20: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-0001fc30: 6570 7420 496d 706f 7274 4572 726f 723a  ept ImportError:
-0001fc40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001fc50: 2073 686f 775f 6461 7368 626f 6172 6420   show_dashboard 
-0001fc60: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
-0001fc70: 2020 2020 2020 2020 6874 7470 5f73 6572          http_ser
-0001fc80: 7665 725f 6d6f 6475 6c65 732e 6170 7065  ver_modules.appe
-0001fc90: 6e64 2822 6469 7374 7269 6275 7465 642e  nd("distributed.
-0001fca0: 6874 7470 2e73 6368 6564 756c 6572 2e6d  http.scheduler.m
-0001fcb0: 6973 7369 6e67 5f62 6f6b 6568 2229 0a20  issing_bokeh"). 
-0001fcc0: 2020 2020 2020 2072 6f75 7465 7320 3d20         routes = 
-0001fcd0: 6765 745f 6861 6e64 6c65 7273 280a 2020  get_handlers(.  
-0001fce0: 2020 2020 2020 2020 2020 7365 7276 6572            server
-0001fcf0: 3d73 656c 662c 206d 6f64 756c 6573 3d68  =self, modules=h
-0001fd00: 7474 705f 7365 7276 6572 5f6d 6f64 756c  ttp_server_modul
-0001fd10: 6573 2c20 7072 6566 6978 3d68 7474 705f  es, prefix=http_
-0001fd20: 7072 6566 6978 0a20 2020 2020 2020 2029  prefix.        )
-0001fd30: 0a20 2020 2020 2020 2073 656c 662e 7374  .        self.st
-0001fd40: 6172 745f 6874 7470 5f73 6572 7665 7228  art_http_server(
-0001fd50: 726f 7574 6573 2c20 6461 7368 626f 6172  routes, dashboar
-0001fd60: 645f 6164 6472 6573 732c 2064 6566 6175  d_address, defau
-0001fd70: 6c74 5f70 6f72 743d 3837 3837 290a 2020  lt_port=8787).  
-0001fd80: 2020 2020 2020 7365 6c66 2e6a 7570 7974        self.jupyt
-0001fd90: 6572 203d 206a 7570 7974 6572 0a20 2020  er = jupyter.   
-0001fda0: 2020 2020 2069 6620 7368 6f77 5f64 6173       if show_das
-0001fdb0: 6862 6f61 7264 3a0a 2020 2020 2020 2020  hboard:.        
-0001fdc0: 2020 2020 6469 7374 7269 6275 7465 642e      distributed.
-0001fdd0: 6461 7368 626f 6172 642e 7363 6865 6475  dashboard.schedu
-0001fde0: 6c65 722e 636f 6e6e 6563 7428 0a20 2020  ler.connect(.   
-0001fdf0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0001fe00: 662e 6874 7470 5f61 7070 6c69 6361 7469  f.http_applicati
-0001fe10: 6f6e 2c20 7365 6c66 2e68 7474 705f 7365  on, self.http_se
-0001fe20: 7276 6572 2c20 7365 6c66 2c20 7072 6566  rver, self, pref
-0001fe30: 6978 3d68 7474 705f 7072 6566 6978 0a20  ix=http_prefix. 
-0001fe40: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0001fe50: 2020 2020 2073 6368 6564 756c 6572 203d       scheduler =
-0001fe60: 2073 656c 660a 2020 2020 2020 2020 6966   self.        if
-0001fe70: 2073 656c 662e 6a75 7079 7465 723a 0a20   self.jupyter:. 
-0001fe80: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-0001fe90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fea0: 6672 6f6d 206a 7570 7974 6572 5f73 6572  from jupyter_ser
-0001feb0: 7665 722e 7365 7276 6572 6170 7020 696d  ver.serverapp im
-0001fec0: 706f 7274 2053 6572 7665 7241 7070 0a20  port ServerApp. 
-0001fed0: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-0001fee0: 7420 496d 706f 7274 4572 726f 723a 0a20  t ImportError:. 
-0001fef0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0001ff00: 6169 7365 2049 6d70 6f72 7445 7272 6f72  aise ImportError
-0001ff10: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0001ff20: 2020 2020 2020 2249 6e20 6f72 6465 7220        "In order 
-0001ff30: 746f 2075 7365 2074 6865 2044 6173 6b20  to use the Dask 
-0001ff40: 6a75 7079 7465 7220 6f70 7469 6f6e 2079  jupyter option y
-0001ff50: 6f75 2022 0a20 2020 2020 2020 2020 2020  ou ".           
-0001ff60: 2020 2020 2020 2020 2022 6e65 6564 2074           "need t
-0001ff70: 6f20 6861 7665 206a 7570 7974 6572 6c61  o have jupyterla
-0001ff80: 6220 696e 7374 616c 6c65 6422 0a20 2020  b installed".   
-0001ff90: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-0001ffa0: 2020 2020 2020 2020 2020 2066 726f 6d20             from 
-0001ffb0: 7472 6169 746c 6574 732e 636f 6e66 6967  traitlets.config
-0001ffc0: 2069 6d70 6f72 7420 436f 6e66 6967 0a0a   import Config..
-0001ffd0: 2020 2020 2020 2020 2020 2020 2222 2248              """H
-0001ffe0: 5454 5020 6861 6e64 6c65 7220 746f 2073  TTP handler to s
-0001fff0: 6875 7420 646f 776e 2074 6865 204a 7570  hut down the Jup
-00020000: 7974 6572 2073 6572 7665 722e 0a20 2020  yter server..   
-00020010: 2020 2020 2020 2020 2022 2222 0a20 2020           """.   
-00020020: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-00020030: 2020 2020 2020 2020 2020 2020 2020 6672                fr
-00020040: 6f6d 206a 7570 7974 6572 5f73 6572 7665  om jupyter_serve
-00020050: 722e 6175 7468 2069 6d70 6f72 7420 6175  r.auth import au
-00020060: 7468 6f72 697a 6564 0a20 2020 2020 2020  thorized.       
-00020070: 2020 2020 2065 7863 6570 7420 496d 706f       except Impo
-00020080: 7274 4572 726f 723a 0a0a 2020 2020 2020  rtError:..      
-00020090: 2020 2020 2020 2020 2020 6465 6620 6175            def au
-000200a0: 7468 6f72 697a 6564 2863 293a 0a20 2020  thorized(c):.   
-000200b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000200c0: 2072 6574 7572 6e20 630a 0a20 2020 2020   return c..     
-000200d0: 2020 2020 2020 2066 726f 6d20 6a75 7079         from jupy
-000200e0: 7465 725f 7365 7276 6572 2e62 6173 652e  ter_server.base.
-000200f0: 6861 6e64 6c65 7273 2069 6d70 6f72 7420  handlers import 
-00020100: 4a75 7079 7465 7248 616e 646c 6572 0a0a  JupyterHandler..
-00020110: 2020 2020 2020 2020 2020 2020 636c 6173              clas
-00020120: 7320 5368 7574 646f 776e 4861 6e64 6c65  s ShutdownHandle
-00020130: 7228 4a75 7079 7465 7248 616e 646c 6572  r(JupyterHandler
-00020140: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00020150: 2020 2022 2222 4120 7368 7574 646f 776e     """A shutdown
-00020160: 2041 5049 2068 616e 646c 6572 2e22 2222   API handler."""
-00020170: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00020180: 2020 6175 7468 5f72 6573 6f75 7263 6520    auth_resource 
-00020190: 3d20 2273 6572 7665 7222 0a0a 2020 2020  = "server"..    
-000201a0: 2020 2020 2020 2020 2020 2020 4074 6f72              @tor
-000201b0: 6e61 646f 2e77 6562 2e61 7574 6865 6e74  nado.web.authent
-000201c0: 6963 6174 6564 0a20 2020 2020 2020 2020  icated.         
-000201d0: 2020 2020 2020 2040 6175 7468 6f72 697a         @authoriz
-000201e0: 6564 0a20 2020 2020 2020 2020 2020 2020  ed.             
-000201f0: 2020 2061 7379 6e63 2064 6566 2070 6f73     async def pos
-00020200: 7428 7365 6c66 293a 0a20 2020 2020 2020  t(self):.       
-00020210: 2020 2020 2020 2020 2020 2020 2022 2222               """
-00020220: 5368 7574 2064 6f77 6e20 7468 6520 7365  Shut down the se
-00020230: 7276 6572 2e22 2222 0a20 2020 2020 2020  rver.""".       
-00020240: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00020250: 662e 6c6f 672e 696e 666f 2822 5368 7574  f.log.info("Shut
-00020260: 7469 6e67 2064 6f77 6e20 6f6e 202f 6170  ting down on /ap
-00020270: 692f 7368 7574 646f 776e 2072 6571 7565  i/shutdown reque
-00020280: 7374 2e22 290a 0a20 2020 2020 2020 2020  st.")..         
-00020290: 2020 2020 2020 2020 2020 2061 7761 6974             await
-000202a0: 2073 6368 6564 756c 6572 2e63 6c6f 7365   scheduler.close
-000202b0: 2872 6561 736f 6e3d 2273 6875 7464 6f77  (reason="shutdow
-000202c0: 6e20 7265 7175 6573 7465 6420 7669 6120  n requested via 
-000202d0: 4a75 7079 7465 7222 290a 0a20 2020 2020  Jupyter")..     
-000202e0: 2020 2020 2020 206a 203d 2053 6572 7665         j = Serve
-000202f0: 7241 7070 2e69 6e73 7461 6e63 6528 0a20  rApp.instance(. 
-00020300: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00020310: 6f6e 6669 673d 436f 6e66 6967 280a 2020  onfig=Config(.  
-00020320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020330: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00020340: 2020 2020 2020 2020 2020 2020 2253 6572              "Ser
-00020350: 7665 7241 7070 223a 207b 0a20 2020 2020  verApp": {.     
-00020360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020370: 2020 2020 2020 2022 6261 7365 5f75 726c         "base_url
-00020380: 223a 2022 6a75 7079 7465 7222 2c0a 2020  ": "jupyter",.  
-00020390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000203a0: 2020 2020 2020 2020 2020 2320 5345 4355            # SECU
-000203b0: 5249 5459 3a20 5765 2075 7375 616c 6c79  RITY: We usually
-000203c0: 2065 7870 6563 7420 7468 6520 6461 7368   expect the dash
-000203d0: 626f 6172 6420 746f 2062 6520 6120 7265  board to be a re
-000203e0: 6164 2d6f 6e6c 7920 7669 6577 2069 6e74  ad-only view int
-000203f0: 6f0a 2020 2020 2020 2020 2020 2020 2020  o.              
-00020400: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00020410: 7468 6520 7363 6865 6475 6c65 7220 6163  the scheduler ac
-00020420: 7469 7669 7479 2e20 486f 7765 7665 722c  tivity. However,
-00020430: 2062 7920 6164 6469 6e67 2061 6e20 6f70   by adding an op
-00020440: 656e 204a 7570 7974 6572 2061 7070 6c69  en Jupyter appli
-00020450: 6361 7469 6f6e 0a20 2020 2020 2020 2020  cation.         
-00020460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020470: 2020 2023 2077 6520 6172 6520 616c 6c6f     # we are allo
-00020480: 7769 6e67 2061 7262 6974 7261 7279 2072  wing arbitrary r
-00020490: 656d 6f74 6520 636f 6465 2065 7865 6375  emote code execu
-000204a0: 7469 6f6e 206f 6e20 7468 6520 7363 6865  tion on the sche
-000204b0: 6475 6c65 7220 7669 6120 7468 650a 2020  duler via the.  
-000204c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000204d0: 2020 2020 2020 2020 2020 2320 6461 7368            # dash
-000204e0: 626f 6172 6420 7365 7276 6572 2e20 5468  board server. Th
-000204f0: 6973 206f 7074 696f 6e20 7368 6f75 6c64  is option should
-00020500: 206f 6e6c 7920 6265 2075 7365 6420 7768   only be used wh
-00020510: 656e 2074 6865 2064 6173 6862 6f61 7264  en the dashboard
-00020520: 2069 730a 2020 2020 2020 2020 2020 2020   is.            
-00020530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020540: 2320 7072 6f74 6563 7465 6420 7669 6120  # protected via 
-00020550: 6f74 6865 7220 6d65 616e 732c 206f 7220  other means, or 
-00020560: 7768 656e 2079 6f75 2064 6f6e 2774 2063  when you don't c
-00020570: 6172 6520 6162 6f75 7420 636c 7573 7465  are about cluste
-00020580: 7220 7365 6375 7269 7479 2e0a 2020 2020  r security..    
-00020590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000205a0: 2020 2020 2020 2020 2274 6f6b 656e 223a          "token":
-000205b0: 2022 222c 0a20 2020 2020 2020 2020 2020   "",.           
-000205c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000205d0: 2022 616c 6c6f 775f 7265 6d6f 7465 5f61   "allow_remote_a
-000205e0: 6363 6573 7322 3a20 5472 7565 2c0a 2020  ccess": True,.  
-000205f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020600: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-00020610: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-00020620: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00011320: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00011330: 2069 6620 7365 6c66 2e76 616c 6964 6174   if self.validat
+00011340: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00011350: 2020 2069 6620 7374 696d 756c 7573 5f69     if stimulus_i
+00011360: 6420 3d3d 2053 5449 4d55 4c55 535f 4944  d == STIMULUS_ID
+00011370: 5f55 4e53 4554 3a0a 2020 2020 2020 2020  _UNSET:.        
+00011380: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00011390: 6520 5275 6e74 696d 6545 7272 6f72 280a  e RuntimeError(.
+000113a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000113b0: 2020 2020 2020 2020 2273 7469 6d75 6c75          "stimulu
+000113c0: 735f 6964 206e 6f74 2073 6574 2064 7572  s_id not set dur
+000113d0: 696e 6720 5363 6865 6475 6c65 7220 7472  ing Scheduler tr
+000113e0: 616e 7369 7469 6f6e 220a 2020 2020 2020  ansition".      
+000113f0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00011400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011410: 6c6f 6767 6572 2e64 6562 7567 280a 2020  logger.debug(.  
+00011420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011430: 2020 2254 7261 6e73 6974 696f 6e65 6420    "Transitioned 
+00011440: 2572 2025 732d 3e25 7320 2861 6374 7561  %r %s->%s (actua
+00011450: 6c3a 2025 7329 2e20 2043 6f6e 7365 7175  l: %s).  Consequ
+00011460: 656e 6365 3a20 2573 222c 0a20 2020 2020  ence: %s",.     
+00011470: 2020 2020 2020 2020 2020 2020 2020 206b                 k
+00011480: 6579 2c0a 2020 2020 2020 2020 2020 2020  ey,.            
+00011490: 2020 2020 2020 2020 7374 6172 742c 0a20          start,. 
+000114a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000114b0: 2020 2066 696e 6973 682c 0a20 2020 2020     finish,.     
+000114c0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+000114d0: 6374 7561 6c5f 6669 6e69 7368 2c0a 2020  ctual_finish,.  
+000114e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000114f0: 2020 6469 6374 2872 6563 6f6d 6d65 6e64    dict(recommend
+00011500: 6174 696f 6e73 292c 0a20 2020 2020 2020  ations),.       
+00011510: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00011520: 2020 2020 2020 2069 6620 7365 6c66 2e70         if self.p
+00011530: 6c75 6769 6e73 3a0a 2020 2020 2020 2020  lugins:.        
+00011540: 2020 2020 2020 2020 2320 5465 6d70 6f72          # Tempor
+00011550: 6172 696c 7920 7075 7420 6261 636b 2066  arily put back f
+00011560: 6f72 676f 7474 656e 206b 6579 2066 6f72  orgotten key for
+00011570: 2070 6c75 6769 6e20 746f 2072 6574 7269   plugin to retri
+00011580: 6576 6520 6974 0a20 2020 2020 2020 2020  eve it.         
+00011590: 2020 2020 2020 2069 6620 7473 2e5f 7374         if ts._st
+000115a0: 6174 6520 3d3d 2022 666f 7267 6f74 7465  ate == "forgotte
+000115b0: 6e22 3a0a 2020 2020 2020 2020 2020 2020  n":.            
+000115c0: 2020 2020 2020 2020 7473 2e64 6570 656e          ts.depen
+000115d0: 6465 6e74 7320 3d20 6465 7065 6e64 656e  dents = dependen
+000115e0: 7473 0a20 2020 2020 2020 2020 2020 2020  ts.             
+000115f0: 2020 2020 2020 2074 732e 6465 7065 6e64         ts.depend
+00011600: 656e 6369 6573 203d 2064 6570 656e 6465  encies = depende
+00011610: 6e63 6965 730a 2020 2020 2020 2020 2020  ncies.          
+00011620: 2020 2020 2020 2020 2020 7365 6c66 2e74            self.t
+00011630: 6173 6b73 5b74 732e 6b65 795d 203d 2074  asks[ts.key] = t
+00011640: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+00011650: 2020 666f 7220 706c 7567 696e 2069 6e20    for plugin in 
+00011660: 6c69 7374 2873 656c 662e 706c 7567 696e  list(self.plugin
+00011670: 732e 7661 6c75 6573 2829 293a 0a20 2020  s.values()):.   
+00011680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011690: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+000116a0: 2020 2020 2020 2020 2020 2020 2020 706c                pl
+000116b0: 7567 696e 2e74 7261 6e73 6974 696f 6e28  ugin.transition(
+000116c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000116d0: 2020 2020 2020 2020 2020 2020 206b 6579               key
+000116e0: 2c20 7374 6172 742c 2061 6374 7561 6c5f  , start, actual_
+000116f0: 6669 6e69 7368 2c20 7374 696d 756c 7573  finish, stimulus
+00011700: 5f69 643d 7374 696d 756c 7573 5f69 642c  _id=stimulus_id,
+00011710: 202a 2a6b 7761 7267 730a 2020 2020 2020   **kwargs.      
+00011720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011730: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00011740: 2020 2020 2020 2020 6578 6365 7074 2045          except E
+00011750: 7863 6570 7469 6f6e 3a0a 2020 2020 2020  xception:.      
+00011760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011770: 2020 6c6f 6767 6572 2e69 6e66 6f28 2250    logger.info("P
+00011780: 6c75 6769 6e20 6661 696c 6564 2077 6974  lugin failed wit
+00011790: 6820 6578 6365 7074 696f 6e22 2c20 6578  h exception", ex
+000117a0: 635f 696e 666f 3d54 7275 6529 0a20 2020  c_info=True).   
+000117b0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000117c0: 7473 2e73 7461 7465 203d 3d20 2266 6f72  ts.state == "for
+000117d0: 676f 7474 656e 223a 0a20 2020 2020 2020  gotten":.       
+000117e0: 2020 2020 2020 2020 2020 2020 2064 656c               del
+000117f0: 2073 656c 662e 7461 736b 735b 7473 2e6b   self.tasks[ts.k
+00011800: 6579 5d0a 0a20 2020 2020 2020 2020 2020  ey]..           
+00011810: 2074 6720 3d20 7473 2e67 726f 7570 0a20   tg = ts.group. 
+00011820: 2020 2020 2020 2020 2020 2069 6620 7473             if ts
+00011830: 2e73 7461 7465 203d 3d20 2266 6f72 676f  .state == "forgo
+00011840: 7474 656e 2220 616e 6420 7467 2e6e 616d  tten" and tg.nam
+00011850: 6520 696e 2073 656c 662e 7461 736b 5f67  e in self.task_g
+00011860: 726f 7570 733a 0a20 2020 2020 2020 2020  roups:.         
+00011870: 2020 2020 2020 2023 2052 656d 6f76 6520         # Remove 
+00011880: 5461 736b 4772 6f75 7020 6966 2061 6c6c  TaskGroup if all
+00011890: 2074 6173 6b73 2061 7265 2069 6e20 7468   tasks are in th
+000118a0: 6520 666f 7267 6f74 7465 6e20 7374 6174  e forgotten stat
+000118b0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+000118c0: 2020 6966 2061 6c6c 2876 203d 3d20 3020    if all(v == 0 
+000118d0: 6f72 206b 203d 3d20 2266 6f72 676f 7474  or k == "forgott
+000118e0: 656e 2220 666f 7220 6b2c 2076 2069 6e20  en" for k, v in 
+000118f0: 7467 2e73 7461 7465 732e 6974 656d 7328  tg.states.items(
+00011900: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
+00011910: 2020 2020 2020 2020 7473 2e70 7265 6669          ts.prefi
+00011920: 782e 6772 6f75 7073 2e72 656d 6f76 6528  x.groups.remove(
+00011930: 7467 290a 2020 2020 2020 2020 2020 2020  tg).            
+00011940: 2020 2020 2020 2020 6465 6c20 7365 6c66          del self
+00011950: 2e74 6173 6b5f 6772 6f75 7073 5b74 672e  .task_groups[tg.
+00011960: 6e61 6d65 5d0a 0a20 2020 2020 2020 2020  name]..         
+00011970: 2020 2072 6574 7572 6e20 7265 636f 6d6d     return recomm
+00011980: 656e 6461 7469 6f6e 732c 2063 6c69 656e  endations, clien
+00011990: 745f 6d73 6773 2c20 776f 726b 6572 5f6d  t_msgs, worker_m
+000119a0: 7367 730a 2020 2020 2020 2020 6578 6365  sgs.        exce
+000119b0: 7074 2045 7863 6570 7469 6f6e 3a0a 2020  pt Exception:.  
+000119c0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+000119d0: 2e65 7863 6570 7469 6f6e 2822 4572 726f  .exception("Erro
+000119e0: 7220 7472 616e 7369 7469 6f6e 696e 6720  r transitioning 
+000119f0: 2572 2066 726f 6d20 2572 2074 6f20 2572  %r from %r to %r
+00011a00: 222c 206b 6579 2c20 7374 6172 742c 2066  ", key, start, f
+00011a10: 696e 6973 6829 0a20 2020 2020 2020 2020  inish).         
+00011a20: 2020 2069 6620 4c4f 475f 5044 423a 0a20     if LOG_PDB:. 
+00011a30: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00011a40: 6d70 6f72 7420 7064 620a 0a20 2020 2020  mport pdb..     
+00011a50: 2020 2020 2020 2020 2020 2070 6462 2e73             pdb.s
+00011a60: 6574 5f74 7261 6365 2829 0a20 2020 2020  et_trace().     
+00011a70: 2020 2020 2020 2072 6169 7365 0a0a 2020         raise..  
+00011a80: 2020 6465 6620 5f74 7261 6e73 6974 696f    def _transitio
+00011a90: 6e73 280a 2020 2020 2020 2020 7365 6c66  ns(.        self
+00011aa0: 2c0a 2020 2020 2020 2020 7265 636f 6d6d  ,.        recomm
+00011ab0: 656e 6461 7469 6f6e 733a 2052 6563 732c  endations: Recs,
+00011ac0: 0a20 2020 2020 2020 2063 6c69 656e 745f  .        client_
+00011ad0: 6d73 6773 3a20 4d73 6773 2c0a 2020 2020  msgs: Msgs,.    
+00011ae0: 2020 2020 776f 726b 6572 5f6d 7367 733a      worker_msgs:
+00011af0: 204d 7367 732c 0a20 2020 2020 2020 2073   Msgs,.        s
+00011b00: 7469 6d75 6c75 735f 6964 3a20 7374 722c  timulus_id: str,
+00011b10: 0a20 2020 2029 202d 3e20 4e6f 6e65 3a0a  .    ) -> None:.
+00011b20: 2020 2020 2020 2020 2222 2250 726f 6365          """Proce
+00011b30: 7373 2074 7261 6e73 6974 696f 6e73 2075  ss transitions u
+00011b40: 6e74 696c 206e 6f6e 6520 6172 6520 6c65  ntil none are le
+00011b50: 6674 0a0a 2020 2020 2020 2020 5468 6973  ft..        This
+00011b60: 2069 6e63 6c75 6465 7320 6665 6564 6261   includes feedba
+00011b70: 636b 2066 726f 6d20 7072 6576 696f 7573  ck from previous
+00011b80: 2074 7261 6e73 6974 696f 6e73 2061 6e64   transitions and
+00011b90: 2063 6f6e 7469 6e75 6573 2075 6e74 696c   continues until
+00011ba0: 2077 650a 2020 2020 2020 2020 7265 6163   we.        reac
+00011bb0: 6820 6120 7374 6561 6479 2073 7461 7465  h a steady state
+00011bc0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00011bd0: 2020 2020 206b 6579 733a 2073 6574 5b4b       keys: set[K
+00011be0: 6579 5d20 3d20 7365 7428 290a 2020 2020  ey] = set().    
+00011bf0: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
+00011c00: 6f6e 7320 3d20 7265 636f 6d6d 656e 6461  ons = recommenda
+00011c10: 7469 6f6e 732e 636f 7079 2829 0a0a 2020  tions.copy()..  
+00011c20: 2020 2020 2020 7768 696c 6520 7265 636f        while reco
+00011c30: 6d6d 656e 6461 7469 6f6e 733a 0a20 2020  mmendations:.   
+00011c40: 2020 2020 2020 2020 206b 6579 2c20 6669           key, fi
+00011c50: 6e69 7368 203d 2072 6563 6f6d 6d65 6e64  nish = recommend
+00011c60: 6174 696f 6e73 2e70 6f70 6974 656d 2829  ations.popitem()
+00011c70: 0a20 2020 2020 2020 2020 2020 206b 6579  .            key
+00011c80: 732e 6164 6428 6b65 7929 0a0a 2020 2020  s.add(key)..    
+00011c90: 2020 2020 2020 2020 6e65 775f 7265 6373          new_recs
+00011ca0: 2c20 6e65 775f 636d 7367 732c 206e 6577  , new_cmsgs, new
+00011cb0: 5f77 6d73 6773 203d 2073 656c 662e 5f74  _wmsgs = self._t
+00011cc0: 7261 6e73 6974 696f 6e28 6b65 792c 2066  ransition(key, f
+00011cd0: 696e 6973 682c 2073 7469 6d75 6c75 735f  inish, stimulus_
+00011ce0: 6964 290a 0a20 2020 2020 2020 2020 2020  id)..           
+00011cf0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+00011d00: 2e75 7064 6174 6528 6e65 775f 7265 6373  .update(new_recs
+00011d10: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
+00011d20: 7220 632c 206e 6577 5f6d 7367 7320 696e  r c, new_msgs in
+00011d30: 206e 6577 5f63 6d73 6773 2e69 7465 6d73   new_cmsgs.items
+00011d40: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00011d50: 2020 2020 636c 6965 6e74 5f6d 7367 732e      client_msgs.
+00011d60: 7365 7464 6566 6175 6c74 2863 2c20 5b5d  setdefault(c, []
+00011d70: 292e 6578 7465 6e64 286e 6577 5f6d 7367  ).extend(new_msg
+00011d80: 7329 0a20 2020 2020 2020 2020 2020 2066  s).            f
+00011d90: 6f72 2077 2c20 6e65 775f 6d73 6773 2069  or w, new_msgs i
+00011da0: 6e20 6e65 775f 776d 7367 732e 6974 656d  n new_wmsgs.item
+00011db0: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+00011dc0: 2020 2020 2077 6f72 6b65 725f 6d73 6773       worker_msgs
+00011dd0: 2e73 6574 6465 6661 756c 7428 772c 205b  .setdefault(w, [
+00011de0: 5d29 2e65 7874 656e 6428 6e65 775f 6d73  ]).extend(new_ms
+00011df0: 6773 290a 0a20 2020 2020 2020 2069 6620  gs)..        if 
+00011e00: 7365 6c66 2e76 616c 6964 6174 653a 0a20  self.validate:. 
+00011e10: 2020 2020 2020 2020 2020 2023 2046 4958             # FIX
+00011e20: 4d45 2064 6f77 6e63 6173 7420 616e 7469  ME downcast anti
+00011e30: 7061 7474 6572 6e0a 2020 2020 2020 2020  pattern.        
+00011e40: 2020 2020 7363 6865 6475 6c65 7220 3d20      scheduler = 
+00011e50: 6361 7374 2853 6368 6564 756c 6572 2c20  cast(Scheduler, 
+00011e60: 7365 6c66 290a 2020 2020 2020 2020 2020  self).          
+00011e70: 2020 666f 7220 6b65 7920 696e 206b 6579    for key in key
+00011e80: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00011e90: 2020 2073 6368 6564 756c 6572 2e76 616c     scheduler.val
+00011ea0: 6964 6174 655f 6b65 7928 6b65 7929 0a0a  idate_key(key)..
+00011eb0: 2020 2020 6465 6620 5f74 7261 6e73 6974      def _transit
+00011ec0: 696f 6e5f 7265 6c65 6173 6564 5f77 6169  ion_released_wai
+00011ed0: 7469 6e67 2873 656c 662c 206b 6579 3a20  ting(self, key: 
+00011ee0: 4b65 792c 2073 7469 6d75 6c75 735f 6964  Key, stimulus_id
+00011ef0: 3a20 7374 7229 202d 3e20 5265 6373 4d73  : str) -> RecsMs
+00011f00: 6773 3a0a 2020 2020 2020 2020 7473 203d  gs:.        ts =
+00011f10: 2073 656c 662e 7461 736b 735b 6b65 795d   self.tasks[key]
+00011f20: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+00011f30: 662e 7661 6c69 6461 7465 3a0a 2020 2020  f.validate:.    
+00011f40: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
+00011f50: 732e 7275 6e5f 7370 6563 0a20 2020 2020  s.run_spec.     
+00011f60: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
+00011f70: 7420 7473 2e77 6169 7469 6e67 5f6f 6e0a  t ts.waiting_on.
+00011f80: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00011f90: 7274 206e 6f74 2074 732e 7768 6f5f 6861  rt not ts.who_ha
+00011fa0: 730a 2020 2020 2020 2020 2020 2020 6173  s.            as
+00011fb0: 7365 7274 206e 6f74 2074 732e 7072 6f63  sert not ts.proc
+00011fc0: 6573 7369 6e67 5f6f 6e0a 2020 2020 2020  essing_on.      
+00011fd0: 2020 2020 2020 666f 7220 6474 7320 696e        for dts in
+00011fe0: 2074 732e 6465 7065 6e64 656e 6369 6573   ts.dependencies
+00011ff0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00012000: 2020 6173 7365 7274 2064 7473 2e73 7461    assert dts.sta
+00012010: 7465 206e 6f74 2069 6e20 7b22 666f 7267  te not in {"forg
+00012020: 6f74 7465 6e22 2c20 2265 7272 6564 227d  otten", "erred"}
+00012030: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
+00012040: 2020 2020 2020 2020 7374 7228 7473 292c          str(ts),
+00012050: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012060: 2020 2020 2073 7472 2864 7473 292c 0a20       str(dts),. 
+00012070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012080: 2020 2073 656c 662e 7472 616e 7369 7469     self.transiti
+00012090: 6f6e 5f6c 6f67 2c0a 2020 2020 2020 2020  on_log,.        
+000120a0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+000120b0: 2020 2069 6620 7473 2e68 6173 5f6c 6f73     if ts.has_los
+000120c0: 745f 6465 7065 6e64 656e 6369 6573 3a0a  t_dependencies:.
+000120d0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000120e0: 726e 207b 6b65 793a 2022 666f 7267 6f74  rn {key: "forgot
+000120f0: 7465 6e22 7d2c 207b 7d2c 207b 7d0a 0a20  ten"}, {}, {}.. 
+00012100: 2020 2020 2020 2074 732e 7374 6174 6520         ts.state 
+00012110: 3d20 2277 6169 7469 6e67 220a 0a20 2020  = "waiting"..   
+00012120: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
+00012130: 696f 6e73 3a20 5265 6373 203d 207b 7d0a  ions: Recs = {}.
+00012140: 0a20 2020 2020 2020 2066 6f72 2064 7473  .        for dts
+00012150: 2069 6e20 7473 2e64 6570 656e 6465 6e63   in ts.dependenc
+00012160: 6965 733a 0a20 2020 2020 2020 2020 2020  ies:.           
+00012170: 2069 6620 6e6f 7420 6474 732e 7768 6f5f   if not dts.who_
+00012180: 6861 733a 0a20 2020 2020 2020 2020 2020  has:.           
+00012190: 2020 2020 2069 6620 6e6f 7420 7473 2e77       if not ts.w
+000121a0: 6169 7469 6e67 5f6f 6e3a 0a20 2020 2020  aiting_on:.     
+000121b0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+000121c0: 732e 7761 6974 696e 675f 6f6e 203d 2073  s.waiting_on = s
+000121d0: 6574 2829 0a20 2020 2020 2020 2020 2020  et().           
+000121e0: 2020 2020 2074 732e 7761 6974 696e 675f       ts.waiting_
+000121f0: 6f6e 2e61 6464 2864 7473 290a 2020 2020  on.add(dts).    
+00012200: 2020 2020 2020 2020 6966 2064 7473 2e73          if dts.s
+00012210: 7461 7465 203d 3d20 2272 656c 6561 7365  tate == "release
+00012220: 6422 3a0a 2020 2020 2020 2020 2020 2020  d":.            
+00012230: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
+00012240: 6f6e 735b 6474 732e 6b65 795d 203d 2022  ons[dts.key] = "
+00012250: 7761 6974 696e 6722 0a20 2020 2020 2020  waiting".       
+00012260: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00012270: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+00012280: 7420 6474 732e 7761 6974 6572 733a 0a20  t dts.waiters:. 
+00012290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000122a0: 2020 2064 7473 2e77 6169 7465 7273 203d     dts.waiters =
+000122b0: 2073 6574 2829 0a20 2020 2020 2020 2020   set().         
+000122c0: 2020 2020 2020 2064 7473 2e77 6169 7465         dts.waite
+000122d0: 7273 2e61 6464 2874 7329 0a0a 2020 2020  rs.add(ts)..    
+000122e0: 2020 2020 7473 2e77 6169 7465 7273 203d      ts.waiters =
+000122f0: 207b 6474 7320 666f 7220 6474 7320 696e   {dts for dts in
+00012300: 2074 732e 6465 7065 6e64 656e 7473 2069   ts.dependents i
+00012310: 6620 6474 732e 7374 6174 6520 3d3d 2022  f dts.state == "
+00012320: 7761 6974 696e 6722 7d0a 0a20 2020 2020  waiting"}..     
+00012330: 2020 2069 6620 6e6f 7420 7473 2e77 6169     if not ts.wai
+00012340: 7469 6e67 5f6f 6e3a 0a20 2020 2020 2020  ting_on:.       
+00012350: 2020 2020 2023 204e 4f54 453a 2077 6169       # NOTE: wai
+00012360: 7469 6e67 2d3e 7072 6f63 6573 7369 6e67  ting->processing
+00012370: 2077 696c 6c20 7365 6e64 2074 6173 6b73   will send tasks
+00012380: 2074 6f20 7175 6575 6564 206f 7220 6e6f   to queued or no
+00012390: 2d77 6f72 6b65 7220 6173 0a20 2020 2020  -worker as.     
+000123a0: 2020 2020 2020 2023 206e 6563 6573 7361         # necessa
+000123b0: 7279 0a20 2020 2020 2020 2020 2020 2072  ry.            r
+000123c0: 6563 6f6d 6d65 6e64 6174 696f 6e73 5b6b  ecommendations[k
+000123d0: 6579 5d20 3d20 2270 726f 6365 7373 696e  ey] = "processin
+000123e0: 6722 0a0a 2020 2020 2020 2020 7265 7475  g"..        retu
+000123f0: 726e 2072 6563 6f6d 6d65 6e64 6174 696f  rn recommendatio
+00012400: 6e73 2c20 7b7d 2c20 7b7d 0a0a 2020 2020  ns, {}, {}..    
+00012410: 6465 6620 5f74 7261 6e73 6974 696f 6e5f  def _transition_
+00012420: 6e6f 5f77 6f72 6b65 725f 7072 6f63 6573  no_worker_proces
+00012430: 7369 6e67 2873 656c 662c 206b 6579 3a20  sing(self, key: 
+00012440: 4b65 792c 2073 7469 6d75 6c75 735f 6964  Key, stimulus_id
+00012450: 3a20 7374 7229 202d 3e20 5265 6373 4d73  : str) -> RecsMs
+00012460: 6773 3a0a 2020 2020 2020 2020 7473 203d  gs:.        ts =
+00012470: 2073 656c 662e 7461 736b 735b 6b65 795d   self.tasks[key]
+00012480: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+00012490: 662e 7661 6c69 6461 7465 3a0a 2020 2020  f.validate:.    
+000124a0: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
+000124b0: 6f74 2074 732e 6163 746f 722c 2066 2241  ot ts.actor, f"A
+000124c0: 6374 6f72 7320 6361 6e27 7420 6265 2069  ctors can't be i
+000124d0: 6e20 606e 6f2d 776f 726b 6572 603a 207b  n `no-worker`: {
+000124e0: 7473 7d22 0a20 2020 2020 2020 2020 2020  ts}".           
+000124f0: 2061 7373 6572 7420 7473 2069 6e20 7365   assert ts in se
+00012500: 6c66 2e75 6e72 756e 6e61 626c 650a 0a20  lf.unrunnable.. 
+00012510: 2020 2020 2020 2069 6620 7773 203a 3d20         if ws := 
+00012520: 7365 6c66 2e64 6563 6964 655f 776f 726b  self.decide_work
+00012530: 6572 5f6e 6f6e 5f72 6f6f 7469 7368 2874  er_non_rootish(t
+00012540: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
+00012550: 7365 6c66 2e75 6e72 756e 6e61 626c 652e  self.unrunnable.
+00012560: 6469 7363 6172 6428 7473 290a 2020 2020  discard(ts).    
+00012570: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00012580: 656c 662e 5f61 6464 5f74 6f5f 7072 6f63  elf._add_to_proc
+00012590: 6573 7369 6e67 2874 732c 2077 732c 2073  essing(ts, ws, s
+000125a0: 7469 6d75 6c75 735f 6964 3d73 7469 6d75  timulus_id=stimu
+000125b0: 6c75 735f 6964 290a 2020 2020 2020 2020  lus_id).        
+000125c0: 2320 4966 206e 6f20 776f 726b 6572 2c20  # If no worker, 
+000125d0: 7461 736b 206a 7573 7420 7374 6179 7320  task just stays 
+000125e0: 696e 2060 6e6f 2d77 6f72 6b65 7260 0a0a  in `no-worker`..
+000125f0: 2020 2020 2020 2020 7265 7475 726e 207b          return {
+00012600: 7d2c 207b 7d2c 207b 7d0a 0a20 2020 2064  }, {}, {}..    d
+00012610: 6566 2064 6563 6964 655f 776f 726b 6572  ef decide_worker
+00012620: 5f72 6f6f 7469 7368 5f71 7565 7569 6e67  _rootish_queuing
+00012630: 5f64 6973 6162 6c65 6428 0a20 2020 2020  _disabled(.     
+00012640: 2020 2073 656c 662c 2074 733a 2054 6173     self, ts: Tas
+00012650: 6b53 7461 7465 0a20 2020 2029 202d 3e20  kState.    ) -> 
+00012660: 576f 726b 6572 5374 6174 6520 7c20 4e6f  WorkerState | No
+00012670: 6e65 3a0a 2020 2020 2020 2020 2222 2250  ne:.        """P
+00012680: 6963 6b20 6120 776f 726b 6572 2066 6f72  ick a worker for
+00012690: 2061 2072 756e 6e61 626c 6520 726f 6f74   a runnable root
+000126a0: 2d69 7368 2074 6173 6b2c 2077 6974 686f  -ish task, witho
+000126b0: 7574 2071 7565 7569 6e67 2e0a 0a20 2020  ut queuing...   
+000126c0: 2020 2020 2054 6869 7320 6174 7465 6d70       This attemp
+000126d0: 7473 2074 6f20 7363 6865 6475 6c65 2073  ts to schedule s
+000126e0: 6962 6c69 6e67 2074 6173 6b73 206f 6e20  ibling tasks on 
+000126f0: 7468 6520 7361 6d65 2077 6f72 6b65 722c  the same worker,
+00012700: 2072 6564 7563 696e 6720 6675 7475 7265   reducing future
+00012710: 2064 6174 610a 2020 2020 2020 2020 7472   data.        tr
+00012720: 616e 7366 6572 2e20 4974 2064 6f65 7320  ansfer. It does 
+00012730: 6e6f 7420 636f 6e73 6964 6572 2074 6865  not consider the
+00012740: 206c 6f63 6174 696f 6e20 6f66 2064 6570   location of dep
+00012750: 656e 6465 6e63 6965 732c 2073 696e 6365  endencies, since
+00012760: 2074 6865 7927 6c6c 2065 6e64 0a20 2020   they'll end.   
+00012770: 2020 2020 2075 7020 6f6e 2065 7665 7279       up on every
+00012780: 2077 6f72 6b65 7220 616e 7977 6179 2e0a   worker anyway..
+00012790: 0a20 2020 2020 2020 2049 7420 6173 7375  .        It assu
+000127a0: 6d65 7320 6974 2773 2062 6569 6e67 2063  mes it's being c
+000127b0: 616c 6c65 6420 6f6e 2061 2062 6174 6368  alled on a batch
+000127c0: 206f 6620 7461 736b 7320 696e 2070 7269   of tasks in pri
+000127d0: 6f72 6974 7920 6f72 6465 722c 2061 6e64  ority order, and
+000127e0: 0a20 2020 2020 2020 206d 6169 6e74 6169  .        maintai
+000127f0: 6e73 2073 7461 7465 2069 6e20 6053 6368  ns state in `Sch
+00012800: 6564 756c 6572 5374 6174 652e 6c61 7374  edulerState.last
+00012810: 5f72 6f6f 745f 776f 726b 6572 6020 616e  _root_worker` an
+00012820: 640a 2020 2020 2020 2020 6053 6368 6564  d.        `Sched
+00012830: 756c 6572 5374 6174 652e 6c61 7374 5f72  ulerState.last_r
+00012840: 6f6f 745f 776f 726b 6572 5f74 6173 6b73  oot_worker_tasks
+00012850: 5f6c 6566 7460 2074 6f20 6163 6869 6576  _left` to achiev
+00012860: 6520 7468 6973 2e0a 0a20 2020 2020 2020  e this...       
+00012870: 2054 6869 7320 7769 6c6c 2073 656e 6420   This will send 
+00012880: 6576 6572 7920 7275 6e6e 6162 6c65 2074  every runnable t
+00012890: 6173 6b20 746f 2061 2077 6f72 6b65 722c  ask to a worker,
+000128a0: 206f 6674 656e 2063 6175 7369 6e67 2072   often causing r
+000128b0: 6f6f 7420 7461 736b 0a20 2020 2020 2020  oot task.       
+000128c0: 206f 7665 7270 726f 6475 6374 696f 6e2e   overproduction.
+000128d0: 0a0a 2020 2020 2020 2020 5265 7475 726e  ..        Return
+000128e0: 730a 2020 2020 2020 2020 2d2d 2d2d 2d2d  s.        ------
+000128f0: 2d0a 2020 2020 2020 2020 7773 3a20 576f  -.        ws: Wo
+00012900: 726b 6572 5374 6174 6520 7c20 4e6f 6e65  rkerState | None
+00012910: 0a20 2020 2020 2020 2020 2020 2054 6865  .            The
+00012920: 2077 6f72 6b65 7220 746f 2061 7373 6967   worker to assig
+00012930: 6e20 7468 6520 7461 736b 2074 6f2e 2049  n the task to. I
+00012940: 6620 7468 6572 6520 6172 6520 6e6f 2077  f there are no w
+00012950: 6f72 6b65 7273 2069 6e20 7468 6520 636c  orkers in the cl
+00012960: 7573 7465 722c 0a20 2020 2020 2020 2020  uster,.         
+00012970: 2020 2072 6574 7572 6e73 204e 6f6e 652c     returns None,
+00012980: 2069 6e20 7768 6963 6820 6361 7365 2074   in which case t
+00012990: 6865 2074 6173 6b20 7368 6f75 6c64 2062  he task should b
+000129a0: 6520 7472 616e 7369 7469 6f6e 6564 2074  e transitioned t
+000129b0: 6f0a 2020 2020 2020 2020 2020 2020 6060  o.            ``
+000129c0: 6e6f 2d77 6f72 6b65 7260 602e 0a20 2020  no-worker``..   
+000129d0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+000129e0: 2069 6620 7365 6c66 2e76 616c 6964 6174   if self.validat
+000129f0: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
+00012a00: 2053 6565 2072 6f6f 742d 6973 682d 6e65   See root-ish-ne
+00012a10: 7373 206e 6f74 6520 6265 6c6f 7720 696e  ss note below in
+00012a20: 2060 6465 6369 6465 5f77 6f72 6b65 725f   `decide_worker_
+00012a30: 726f 6f74 6973 685f 7175 6575 696e 675f  rootish_queuing_
+00012a40: 656e 6162 6c65 6460 0a20 2020 2020 2020  enabled`.       
+00012a50: 2020 2020 2061 7373 6572 7420 6d61 7468       assert math
+00012a60: 2e69 7369 6e66 2873 656c 662e 574f 524b  .isinf(self.WORK
+00012a70: 4552 5f53 4154 5552 4154 494f 4e29 0a0a  ER_SATURATION)..
+00012a80: 2020 2020 2020 2020 706f 6f6c 203d 2073          pool = s
+00012a90: 656c 662e 6964 6c65 2e76 616c 7565 7328  elf.idle.values(
+00012aa0: 2920 6966 2073 656c 662e 6964 6c65 2065  ) if self.idle e
+00012ab0: 6c73 6520 7365 6c66 2e72 756e 6e69 6e67  lse self.running
+00012ac0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+00012ad0: 706f 6f6c 3a0a 2020 2020 2020 2020 2020  pool:.          
+00012ae0: 2020 7265 7475 726e 204e 6f6e 650a 0a20    return None.. 
+00012af0: 2020 2020 2020 2074 6720 3d20 7473 2e67         tg = ts.g
+00012b00: 726f 7570 0a20 2020 2020 2020 206c 7773  roup.        lws
+00012b10: 203d 2074 672e 6c61 7374 5f77 6f72 6b65   = tg.last_worke
+00012b20: 720a 2020 2020 2020 2020 6966 2028 0a20  r.        if (. 
+00012b30: 2020 2020 2020 2020 2020 206c 7773 0a20             lws. 
+00012b40: 2020 2020 2020 2020 2020 2061 6e64 2074             and t
+00012b50: 672e 6c61 7374 5f77 6f72 6b65 725f 7461  g.last_worker_ta
+00012b60: 736b 735f 6c65 6674 0a20 2020 2020 2020  sks_left.       
+00012b70: 2020 2020 2061 6e64 206c 7773 2e73 7461       and lws.sta
+00012b80: 7475 7320 3d3d 2053 7461 7475 732e 7275  tus == Status.ru
+00012b90: 6e6e 696e 670a 2020 2020 2020 2020 2020  nning.          
+00012ba0: 2020 616e 6420 7365 6c66 2e77 6f72 6b65    and self.worke
+00012bb0: 7273 2e67 6574 286c 7773 2e61 6464 7265  rs.get(lws.addre
+00012bc0: 7373 2920 6973 206c 7773 0a20 2020 2020  ss) is lws.     
+00012bd0: 2020 2029 3a0a 2020 2020 2020 2020 2020     ):.          
+00012be0: 2020 7773 203d 206c 7773 0a20 2020 2020    ws = lws.     
+00012bf0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00012c00: 2020 2020 2023 204c 6173 742d 7573 6564       # Last-used
+00012c10: 2077 6f72 6b65 7220 6973 2066 756c 6c2c   worker is full,
+00012c20: 2075 6e6b 6e6f 776e 2c20 7265 7469 7269   unknown, retiri
+00012c30: 6e67 2c20 6f72 2070 6175 7365 643b 0a20  ng, or paused;. 
+00012c40: 2020 2020 2020 2020 2020 2023 2070 6963             # pic
+00012c50: 6b20 6120 6e65 7720 776f 726b 6572 2066  k a new worker f
+00012c60: 6f72 2074 6865 206e 6578 7420 6665 7720  or the next few 
+00012c70: 7461 736b 730a 2020 2020 2020 2020 2020  tasks.          
+00012c80: 2020 7773 203d 206d 696e 2870 6f6f 6c2c    ws = min(pool,
+00012c90: 206b 6579 3d70 6172 7469 616c 2873 656c   key=partial(sel
+00012ca0: 662e 776f 726b 6572 5f6f 626a 6563 7469  f.worker_objecti
+00012cb0: 7665 2c20 7473 2929 0a20 2020 2020 2020  ve, ts)).       
+00012cc0: 2020 2020 2074 672e 6c61 7374 5f77 6f72       tg.last_wor
+00012cd0: 6b65 725f 7461 736b 735f 6c65 6674 203d  ker_tasks_left =
+00012ce0: 206d 6174 682e 666c 6f6f 7228 0a20 2020   math.floor(.   
+00012cf0: 2020 2020 2020 2020 2020 2020 2028 6c65               (le
+00012d00: 6e28 7467 2920 2f20 7365 6c66 2e74 6f74  n(tg) / self.tot
+00012d10: 616c 5f6e 7468 7265 6164 7329 202a 2077  al_nthreads) * w
+00012d20: 732e 6e74 6872 6561 6473 0a20 2020 2020  s.nthreads.     
+00012d30: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+00012d40: 2020 2320 5265 636f 7264 2060 6c61 7374    # Record `last
+00012d50: 5f77 6f72 6b65 7260 2c20 6f72 2063 6c65  _worker`, or cle
+00012d60: 6172 2069 7420 6f6e 2074 6865 2066 696e  ar it on the fin
+00012d70: 616c 2074 6173 6b0a 2020 2020 2020 2020  al task.        
+00012d80: 7467 2e6c 6173 745f 776f 726b 6572 203d  tg.last_worker =
+00012d90: 2028 0a20 2020 2020 2020 2020 2020 2077   (.            w
+00012da0: 7320 6966 2074 672e 7374 6174 6573 5b22  s if tg.states["
+00012db0: 7265 6c65 6173 6564 225d 202b 2074 672e  released"] + tg.
+00012dc0: 7374 6174 6573 5b22 7761 6974 696e 6722  states["waiting"
+00012dd0: 5d20 3e20 3120 656c 7365 204e 6f6e 650a  ] > 1 else None.
+00012de0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00012df0: 2020 7467 2e6c 6173 745f 776f 726b 6572    tg.last_worker
+00012e00: 5f74 6173 6b73 5f6c 6566 7420 2d3d 2031  _tasks_left -= 1
+00012e10: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+00012e20: 662e 7661 6c69 6461 7465 2061 6e64 2077  f.validate and w
+00012e30: 7320 6973 206e 6f74 204e 6f6e 653a 0a20  s is not None:. 
+00012e40: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00012e50: 7420 7365 6c66 2e77 6f72 6b65 7273 2e67  t self.workers.g
+00012e60: 6574 2877 732e 6164 6472 6573 7329 2069  et(ws.address) i
+00012e70: 7320 7773 0a20 2020 2020 2020 2020 2020  s ws.           
+00012e80: 2061 7373 6572 7420 7773 2069 6e20 7365   assert ws in se
+00012e90: 6c66 2e72 756e 6e69 6e67 2c20 2877 732c  lf.running, (ws,
+00012ea0: 2073 656c 662e 7275 6e6e 696e 6729 0a0a   self.running)..
+00012eb0: 2020 2020 2020 2020 7265 7475 726e 2077          return w
+00012ec0: 730a 0a20 2020 2064 6566 2064 6563 6964  s..    def decid
+00012ed0: 655f 776f 726b 6572 5f72 6f6f 7469 7368  e_worker_rootish
+00012ee0: 5f71 7565 7569 6e67 5f65 6e61 626c 6564  _queuing_enabled
+00012ef0: 2873 656c 6629 202d 3e20 576f 726b 6572  (self) -> Worker
+00012f00: 5374 6174 6520 7c20 4e6f 6e65 3a0a 2020  State | None:.  
+00012f10: 2020 2020 2020 2222 2250 6963 6b20 6120        """Pick a 
+00012f20: 776f 726b 6572 2066 6f72 2061 2072 756e  worker for a run
+00012f30: 6e61 626c 6520 726f 6f74 2d69 7368 2074  nable root-ish t
+00012f40: 6173 6b2c 2069 6620 6e6f 7420 616c 6c20  ask, if not all 
+00012f50: 6172 6520 6275 7379 2e0a 0a20 2020 2020  are busy...     
+00012f60: 2020 2050 6963 6b73 2074 6865 206c 6561     Picks the lea
+00012f70: 7374 2d62 7573 7920 776f 726b 6572 206f  st-busy worker o
+00012f80: 7574 206f 6620 7468 6520 6060 6964 6c65  ut of the ``idle
+00012f90: 6060 2077 6f72 6b65 7273 2028 6964 6c65  `` workers (idle
+00012fa0: 2077 6f72 6b65 7273 2068 6176 6520 6665   workers have fe
+00012fb0: 7765 720a 2020 2020 2020 2020 7461 736b  wer.        task
+00012fc0: 7320 7275 6e6e 696e 6720 7468 616e 2074  s running than t
+00012fd0: 6872 6561 6473 2c20 6173 2073 6574 2062  hreads, as set b
+00012fe0: 7920 6060 6469 7374 7269 6275 7465 642e  y ``distributed.
+00012ff0: 7363 6865 6475 6c65 722e 776f 726b 6572  scheduler.worker
+00013000: 2d73 6174 7572 6174 696f 6e60 6029 2e0a  -saturation``)..
+00013010: 2020 2020 2020 2020 4974 2064 6f65 7320          It does 
+00013020: 6e6f 7420 636f 6e73 6964 6572 2074 6865  not consider the
+00013030: 206c 6f63 6174 696f 6e20 6f66 2064 6570   location of dep
+00013040: 656e 6465 6e63 6965 732c 2073 696e 6365  endencies, since
+00013050: 2074 6865 7927 6c6c 2065 6e64 2075 7020   they'll end up 
+00013060: 6f6e 2065 7665 7279 0a20 2020 2020 2020  on every.       
+00013070: 2077 6f72 6b65 7220 616e 7977 6179 2e0a   worker anyway..
+00013080: 0a20 2020 2020 2020 2049 6620 616c 6c20  .        If all 
+00013090: 776f 726b 6572 7320 6172 6520 6675 6c6c  workers are full
+000130a0: 2c20 7265 7475 726e 7320 4e6f 6e65 2c20  , returns None, 
+000130b0: 6d65 616e 696e 6720 7468 6520 7461 736b  meaning the task
+000130c0: 2073 686f 756c 6420 7472 616e 7369 7469   should transiti
+000130d0: 6f6e 2074 6f0a 2020 2020 2020 2020 6060  on to.        ``
+000130e0: 7175 6575 6564 6060 2e20 5468 6520 7363  queued``. The sc
+000130f0: 6865 6475 6c65 7220 7769 6c6c 2077 6169  heduler will wai
+00013100: 7420 746f 2073 656e 6420 6974 2074 6f20  t to send it to 
+00013110: 6120 776f 726b 6572 2075 6e74 696c 2061  a worker until a
+00013120: 2074 6872 6561 6420 6f70 656e 730a 2020   thread opens.  
+00013130: 2020 2020 2020 7570 2e20 5468 6973 2065        up. This e
+00013140: 6e73 7572 6573 2074 6861 7420 646f 776e  nsures that down
+00013150: 7374 7265 616d 2074 6173 6b73 2061 6c77  stream tasks alw
+00013160: 6179 7320 7275 6e20 6265 666f 7265 206e  ays run before n
+00013170: 6577 2072 6f6f 7420 7461 736b 7320 6172  ew root tasks ar
+00013180: 650a 2020 2020 2020 2020 7374 6172 7465  e.        starte
+00013190: 642e 0a0a 2020 2020 2020 2020 5468 6973  d...        This
+000131a0: 2064 6f65 7320 6e6f 7420 7472 7920 746f   does not try to
+000131b0: 2073 6368 6564 756c 6520 7369 626c 696e   schedule siblin
+000131c0: 6720 7461 736b 7320 6f6e 2074 6865 2073  g tasks on the s
+000131d0: 616d 6520 776f 726b 6572 3b20 696e 2066  ame worker; in f
+000131e0: 6163 742c 2069 740a 2020 2020 2020 2020  act, it.        
+000131f0: 7573 7561 6c6c 7920 646f 6573 2074 6865  usually does the
+00013200: 206f 7070 6f73 6974 652e 2045 7665 6e20   opposite. Even 
+00013210: 7468 6f75 6768 2074 6869 7320 696e 6372  though this incr
+00013220: 6561 7365 7320 7375 6273 6571 7565 6e74  eases subsequent
+00013230: 2064 6174 6120 7472 616e 7366 6572 2c0a   data transfer,.
+00013240: 2020 2020 2020 2020 6974 2074 7970 6963          it typic
+00013250: 616c 6c79 2072 6564 7563 6573 206f 7665  ally reduces ove
+00013260: 7261 6c6c 206d 656d 6f72 7920 7573 6520  rall memory use 
+00013270: 6279 2065 6c69 6d69 6e61 7469 6e67 2072  by eliminating r
+00013280: 6f6f 7420 7461 736b 206f 7665 7270 726f  oot task overpro
+00013290: 6475 6374 696f 6e2e 0a0a 2020 2020 2020  duction...      
+000132a0: 2020 5265 7475 726e 730a 2020 2020 2020    Returns.      
+000132b0: 2020 2d2d 2d2d 2d2d 2d0a 2020 2020 2020    -------.      
+000132c0: 2020 7773 3a20 576f 726b 6572 5374 6174    ws: WorkerStat
+000132d0: 6520 7c20 4e6f 6e65 0a20 2020 2020 2020  e | None.       
+000132e0: 2020 2020 2054 6865 2077 6f72 6b65 7220       The worker 
+000132f0: 746f 2061 7373 6967 6e20 7468 6520 7461  to assign the ta
+00013300: 736b 2074 6f2e 2049 6620 7468 6572 6520  sk to. If there 
+00013310: 6172 6520 6e6f 2069 646c 6520 776f 726b  are no idle work
+00013320: 6572 732c 2072 6574 7572 6e73 0a20 2020  ers, returns.   
+00013330: 2020 2020 2020 2020 204e 6f6e 652c 2069           None, i
+00013340: 6e20 7768 6963 6820 6361 7365 2074 6865  n which case the
+00013350: 2074 6173 6b20 7368 6f75 6c64 2062 6520   task should be 
+00013360: 7472 616e 7369 7469 6f6e 6564 2074 6f20  transitioned to 
+00013370: 6060 7175 6575 6564 6060 2e0a 0a20 2020  ``queued``...   
+00013380: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00013390: 2069 6620 7365 6c66 2e76 616c 6964 6174   if self.validat
+000133a0: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
+000133b0: 2057 6520 646f 6e27 7420 6061 7373 6572   We don't `asser
+000133c0: 7420 7365 6c66 2e69 735f 726f 6f74 6973  t self.is_rootis
+000133d0: 6828 7473 2960 2068 6572 652c 2062 6563  h(ts)` here, bec
+000133e0: 6175 7365 2074 6861 7420 6368 6563 6b20  ause that check 
+000133f0: 6973 0a20 2020 2020 2020 2020 2020 2023  is.            #
+00013400: 2064 6570 656e 6465 6e74 206f 6e20 636c   dependent on cl
+00013410: 7573 7465 7220 7369 7a65 2e20 4974 2773  uster size. It's
+00013420: 2070 6f73 7369 626c 6520 6120 7461 736b   possible a task
+00013430: 206c 6f6f 6b65 6420 726f 6f74 2d69 7368   looked root-ish
+00013440: 2077 6865 6e20 6974 0a20 2020 2020 2020   when it.       
+00013450: 2020 2020 2023 2077 6173 2071 7565 7565       # was queue
+00013460: 642c 2062 7574 2074 6865 2063 6c75 7374  d, but the clust
+00013470: 6572 2068 6173 2073 696e 6365 2073 6361  er has since sca
+00013480: 6c65 6420 7570 2061 6e64 2069 7420 6e6f  led up and it no
+00013490: 206c 6f6e 6765 7220 646f 6573 2077 6865   longer does whe
+000134a0: 6e0a 2020 2020 2020 2020 2020 2020 2320  n.            # 
+000134b0: 636f 6d69 6e67 206f 7574 206f 6620 7468  coming out of th
+000134c0: 6520 7175 6575 652e 2049 6620 6069 735f  e queue. If `is_
+000134d0: 726f 6f74 6973 6860 2063 6861 6e67 6573  rootish` changes
+000134e0: 2074 6f20 6120 7374 6174 6963 2064 6566   to a static def
+000134f0: 696e 6974 696f 6e2c 0a20 2020 2020 2020  inition,.       
+00013500: 2020 2020 2023 2074 6865 6e20 6164 6420       # then add 
+00013510: 7468 6174 2061 7373 6572 7469 6f6e 2068  that assertion h
+00013520: 6572 6520 2861 6e64 2061 6374 7561 6c6c  ere (and actuall
+00013530: 7920 7061 7373 2069 6e20 7468 6520 7461  y pass in the ta
+00013540: 736b 292e 0a20 2020 2020 2020 2020 2020  sk)..           
+00013550: 2061 7373 6572 7420 6e6f 7420 6d61 7468   assert not math
+00013560: 2e69 7369 6e66 2873 656c 662e 574f 524b  .isinf(self.WORK
+00013570: 4552 5f53 4154 5552 4154 494f 4e29 0a0a  ER_SATURATION)..
+00013580: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
+00013590: 656c 662e 6964 6c65 5f74 6173 6b5f 636f  elf.idle_task_co
+000135a0: 756e 743a 0a20 2020 2020 2020 2020 2020  unt:.           
+000135b0: 2023 2041 6c6c 2077 6f72 6b65 7273 2062   # All workers b
+000135c0: 7573 793f 2054 6173 6b20 6765 7473 2f73  usy? Task gets/s
+000135d0: 7461 7973 2071 7565 7565 642e 0a20 2020  tays queued..   
+000135e0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000135f0: 4e6f 6e65 0a0a 2020 2020 2020 2020 2320  None..        # 
+00013600: 4a75 7374 2070 6963 6b20 7468 6520 6c65  Just pick the le
+00013610: 6173 7420 6275 7379 2077 6f72 6b65 722e  ast busy worker.
+00013620: 0a20 2020 2020 2020 2023 204e 4f54 453a  .        # NOTE:
+00013630: 2074 6869 7320 7769 6c6c 206c 6561 6420   this will lead 
+00013640: 746f 2077 6f72 7374 2d63 6173 6520 7363  to worst-case sc
+00013650: 6865 6475 6c69 6e67 2077 6974 6820 7265  heduling with re
+00013660: 6761 7264 7320 746f 2063 6f2d 6173 7369  gards to co-assi
+00013670: 676e 6d65 6e74 2e0a 2020 2020 2020 2020  gnment..        
+00013680: 7773 203d 206d 696e 280a 2020 2020 2020  ws = min(.      
+00013690: 2020 2020 2020 7365 6c66 2e69 646c 655f        self.idle_
+000136a0: 7461 736b 5f63 6f75 6e74 2c0a 2020 2020  task_count,.    
+000136b0: 2020 2020 2020 2020 6b65 793d 6c61 6d62          key=lamb
+000136c0: 6461 2077 733a 206c 656e 2877 732e 7072  da ws: len(ws.pr
+000136d0: 6f63 6573 7369 6e67 2920 2f20 7773 2e6e  ocessing) / ws.n
+000136e0: 7468 7265 6164 732c 0a20 2020 2020 2020  threads,.       
+000136f0: 2029 0a20 2020 2020 2020 2069 6620 7365   ).        if se
+00013700: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
+00013710: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00013720: 7365 6c66 2e77 6f72 6b65 7273 2e67 6574  self.workers.get
+00013730: 2877 732e 6164 6472 6573 7329 2069 7320  (ws.address) is 
+00013740: 7773 0a20 2020 2020 2020 2020 2020 2061  ws.            a
+00013750: 7373 6572 7420 6e6f 7420 5f77 6f72 6b65  ssert not _worke
+00013760: 725f 6675 6c6c 2877 732c 2073 656c 662e  r_full(ws, self.
+00013770: 574f 524b 4552 5f53 4154 5552 4154 494f  WORKER_SATURATIO
+00013780: 4e29 2c20 280a 2020 2020 2020 2020 2020  N), (.          
+00013790: 2020 2020 2020 7773 2c0a 2020 2020 2020        ws,.      
+000137a0: 2020 2020 2020 2020 2020 5f74 6173 6b5f            _task_
+000137b0: 736c 6f74 735f 6176 6169 6c61 626c 6528  slots_available(
+000137c0: 7773 2c20 7365 6c66 2e57 4f52 4b45 525f  ws, self.WORKER_
+000137d0: 5341 5455 5241 5449 4f4e 292c 0a20 2020  SATURATION),.   
+000137e0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+000137f0: 2020 2020 2020 2061 7373 6572 7420 7773         assert ws
+00013800: 2069 6e20 7365 6c66 2e72 756e 6e69 6e67   in self.running
+00013810: 2c20 2877 732c 2073 656c 662e 7275 6e6e  , (ws, self.runn
+00013820: 696e 6729 0a0a 2020 2020 2020 2020 7265  ing)..        re
+00013830: 7475 726e 2077 730a 0a20 2020 2064 6566  turn ws..    def
+00013840: 2064 6563 6964 655f 776f 726b 6572 5f6e   decide_worker_n
+00013850: 6f6e 5f72 6f6f 7469 7368 2873 656c 662c  on_rootish(self,
+00013860: 2074 733a 2054 6173 6b53 7461 7465 2920   ts: TaskState) 
+00013870: 2d3e 2057 6f72 6b65 7253 7461 7465 207c  -> WorkerState |
+00013880: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
+00013890: 2222 5069 636b 2061 2077 6f72 6b65 7220  ""Pick a worker 
+000138a0: 666f 7220 6120 7275 6e6e 6162 6c65 206e  for a runnable n
+000138b0: 6f6e 2d72 6f6f 7420 7461 736b 2c20 636f  on-root task, co
+000138c0: 6e73 6964 6572 696e 6720 6465 7065 6e64  nsidering depend
+000138d0: 656e 6369 6573 2061 6e64 0a20 2020 2020  encies and.     
+000138e0: 2020 2072 6573 7472 6963 7469 6f6e 732e     restrictions.
+000138f0: 0a0a 2020 2020 2020 2020 4f75 7420 6f66  ..        Out of
+00013900: 2065 6c69 6769 626c 6520 776f 726b 6572   eligible worker
+00013910: 7320 686f 6c64 696e 6720 6465 7065 6e64  s holding depend
+00013920: 656e 6369 6573 206f 6620 6060 7473 6060  encies of ``ts``
+00013930: 2c20 7365 6c65 6374 7320 7468 6520 776f  , selects the wo
+00013940: 726b 6572 0a20 2020 2020 2020 2077 6865  rker.        whe
+00013950: 7265 2c20 636f 6e73 6964 6572 696e 6720  re, considering 
+00013960: 776f 726b 6572 2062 6163 6b6c 6f67 2061  worker backlog a
+00013970: 6e64 2064 6174 612d 7472 616e 7366 6572  nd data-transfer
+00013980: 2063 6f73 7473 2c20 7468 6520 7461 736b   costs, the task
+00013990: 2069 730a 2020 2020 2020 2020 6573 7469   is.        esti
+000139a0: 6d61 7465 6420 746f 2073 7461 7274 2072  mated to start r
+000139b0: 756e 6e69 6e67 2074 6865 2073 6f6f 6e65  unning the soone
+000139c0: 7374 2e0a 0a20 2020 2020 2020 2052 6574  st...        Ret
+000139d0: 7572 6e73 0a20 2020 2020 2020 202d 2d2d  urns.        ---
+000139e0: 2d2d 2d2d 0a20 2020 2020 2020 2077 733a  ----.        ws:
+000139f0: 2057 6f72 6b65 7253 7461 7465 207c 204e   WorkerState | N
+00013a00: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+00013a10: 5468 6520 776f 726b 6572 2074 6f20 6173  The worker to as
+00013a20: 7369 676e 2074 6865 2074 6173 6b20 746f  sign the task to
+00013a30: 2e20 4966 206e 6f20 776f 726b 6572 7320  . If no workers 
+00013a40: 7361 7469 7366 7920 7468 6520 7265 7374  satisfy the rest
+00013a50: 7269 6374 696f 6e73 206f 660a 2020 2020  rictions of.    
+00013a60: 2020 2020 2020 2020 6060 7473 6060 206f          ``ts`` o
+00013a70: 7220 7468 6572 6520 6172 6520 6e6f 2072  r there are no r
+00013a80: 756e 6e69 6e67 2077 6f72 6b65 7273 2c20  unning workers, 
+00013a90: 7265 7475 726e 7320 4e6f 6e65 2c20 696e  returns None, in
+00013aa0: 2077 6869 6368 2063 6173 6520 7468 6520   which case the 
+00013ab0: 7461 736b 0a20 2020 2020 2020 2020 2020  task.           
+00013ac0: 2073 686f 756c 6420 6265 2074 7261 6e73   should be trans
+00013ad0: 6974 696f 6e65 6420 746f 2060 606e 6f2d  itioned to ``no-
+00013ae0: 776f 726b 6572 6060 2e0a 2020 2020 2020  worker``..      
+00013af0: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
+00013b00: 206e 6f74 2073 656c 662e 7275 6e6e 696e   not self.runnin
+00013b10: 673a 0a20 2020 2020 2020 2020 2020 2072  g:.            r
+00013b20: 6574 7572 6e20 4e6f 6e65 0a0a 2020 2020  eturn None..    
+00013b30: 2020 2020 7661 6c69 645f 776f 726b 6572      valid_worker
+00013b40: 7320 3d20 7365 6c66 2e76 616c 6964 5f77  s = self.valid_w
+00013b50: 6f72 6b65 7273 2874 7329 0a20 2020 2020  orkers(ts).     
+00013b60: 2020 2069 6620 7661 6c69 645f 776f 726b     if valid_work
+00013b70: 6572 7320 6973 204e 6f6e 6520 616e 6420  ers is None and 
+00013b80: 6c65 6e28 7365 6c66 2e72 756e 6e69 6e67  len(self.running
+00013b90: 2920 3c20 6c65 6e28 7365 6c66 2e77 6f72  ) < len(self.wor
+00013ba0: 6b65 7273 293a 0a20 2020 2020 2020 2020  kers):.         
+00013bb0: 2020 2023 2049 6620 7468 6572 6520 7765     # If there we
+00013bc0: 7265 206e 6f20 7265 7374 7269 6374 696f  re no restrictio
+00013bd0: 6e73 2c20 6076 616c 6964 5f77 6f72 6b65  ns, `valid_worke
+00013be0: 7273 2829 6020 6469 646e 2774 2073 7562  rs()` didn't sub
+00013bf0: 7365 7420 6279 0a20 2020 2020 2020 2020  set by.         
+00013c00: 2020 2023 2060 7275 6e6e 696e 6760 2e0a     # `running`..
+00013c10: 2020 2020 2020 2020 2020 2020 7661 6c69              vali
+00013c20: 645f 776f 726b 6572 7320 3d20 7365 6c66  d_workers = self
+00013c30: 2e72 756e 6e69 6e67 0a0a 2020 2020 2020  .running..      
+00013c40: 2020 6966 2074 732e 6465 7065 6e64 656e    if ts.dependen
+00013c50: 6369 6573 206f 7220 7661 6c69 645f 776f  cies or valid_wo
+00013c60: 726b 6572 7320 6973 206e 6f74 204e 6f6e  rkers is not Non
+00013c70: 653a 0a20 2020 2020 2020 2020 2020 2077  e:.            w
+00013c80: 7320 3d20 6465 6369 6465 5f77 6f72 6b65  s = decide_worke
+00013c90: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+00013ca0: 2020 2074 732c 0a20 2020 2020 2020 2020     ts,.         
+00013cb0: 2020 2020 2020 2073 656c 662e 7275 6e6e         self.runn
+00013cc0: 696e 672c 0a20 2020 2020 2020 2020 2020  ing,.           
+00013cd0: 2020 2020 2076 616c 6964 5f77 6f72 6b65       valid_worke
+00013ce0: 7273 2c0a 2020 2020 2020 2020 2020 2020  rs,.            
+00013cf0: 2020 2020 7061 7274 6961 6c28 7365 6c66      partial(self
+00013d00: 2e77 6f72 6b65 725f 6f62 6a65 6374 6976  .worker_objectiv
+00013d10: 652c 2074 7329 2c0a 2020 2020 2020 2020  e, ts),.        
+00013d20: 2020 2020 290a 2020 2020 2020 2020 656c      ).        el
+00013d30: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00013d40: 2320 544f 444f 2069 6620 6069 735f 726f  # TODO if `is_ro
+00013d50: 6f74 6973 6860 2077 6f75 6c64 2061 6c77  otish` would alw
+00013d60: 6179 7320 7265 7475 726e 2054 7275 6520  ays return True 
+00013d70: 666f 7220 7461 736b 7320 7769 7468 6f75  for tasks withou
+00013d80: 740a 2020 2020 2020 2020 2020 2020 2320  t.            # 
+00013d90: 6465 7065 6e64 656e 6369 6573 2c20 7765  dependencies, we
+00013da0: 2063 6f75 6c64 2072 656d 6f76 6520 616c   could remove al
+00013db0: 6c20 7468 6973 206c 6f67 6963 2e20 5468  l this logic. Th
+00013dc0: 6520 726f 6f74 6973 6820 6173 7369 676e  e rootish assign
+00013dd0: 6d65 6e74 206c 6f67 6963 0a20 2020 2020  ment logic.     
+00013de0: 2020 2020 2020 2023 2077 6f75 6c64 2062         # would b
+00013df0: 6568 6176 6520 6d6f 7265 206f 7220 6c65  ehave more or le
+00013e00: 7373 2074 6865 2073 616d 6520 6173 2074  ss the same as t
+00013e10: 6869 732c 206d 6179 6265 2077 6974 686f  his, maybe witho
+00013e20: 7574 2067 7561 7261 6e74 6565 640a 2020  ut guaranteed.  
+00013e30: 2020 2020 2020 2020 2020 2320 726f 756e            # roun
+00013e40: 642d 726f 6269 6e20 7468 6f75 6768 3f20  d-robin though? 
+00013e50: 5468 6973 2070 6174 6820 6973 206f 6e6c  This path is onl
+00013e60: 7920 7265 6163 6861 626c 6520 7768 656e  y reachable when
+00013e70: 2060 7473 6020 646f 6573 6e27 7420 6861   `ts` doesn't ha
+00013e80: 7665 0a20 2020 2020 2020 2020 2020 2023  ve.            #
+00013e90: 2064 6570 656e 6465 6e63 6965 732c 2062   dependencies, b
+00013ea0: 7574 2069 7473 2067 726f 7570 2069 7320  ut its group is 
+00013eb0: 616c 736f 2073 6d61 6c6c 6572 2074 6861  also smaller tha
+00013ec0: 6e20 7468 6520 636c 7573 7465 722e 0a0a  n the cluster...
+00013ed0: 2020 2020 2020 2020 2020 2020 2320 4661              # Fa
+00013ee0: 7374 7061 7468 2077 6865 6e20 7468 6572  stpath when ther
+00013ef0: 6520 6172 6520 6e6f 2072 656c 6174 6564  e are no related
+00013f00: 2074 6173 6b73 206f 7220 7265 7374 7269   tasks or restri
+00013f10: 6374 696f 6e73 0a20 2020 2020 2020 2020  ctions.         
+00013f20: 2020 2077 6f72 6b65 725f 706f 6f6c 203d     worker_pool =
+00013f30: 2073 656c 662e 6964 6c65 206f 7220 7365   self.idle or se
+00013f40: 6c66 2e77 6f72 6b65 7273 0a20 2020 2020  lf.workers.     
+00013f50: 2020 2020 2020 2023 2046 4958 4d45 2069         # FIXME i
+00013f60: 646c 6520 616e 6420 776f 726b 6572 7320  dle and workers 
+00013f70: 6172 6520 536f 7274 6564 4469 6374 2773  are SortedDict's
+00013f80: 2064 6563 6c61 7265 6420 6173 2064 6963   declared as dic
+00013f90: 7473 0a20 2020 2020 2020 2020 2020 2023  ts.            #
+00013fa0: 2020 2020 2020 2062 6563 6175 7365 2073         because s
+00013fb0: 6f72 7465 6463 6f6e 7461 696e 6572 7320  ortedcontainers 
+00013fc0: 6973 206e 6f74 2061 6e6e 6f74 6174 6564  is not annotated
+00013fd0: 0a20 2020 2020 2020 2020 2020 2077 705f  .            wp_
+00013fe0: 7661 6c73 203d 2063 6173 7428 2253 6571  vals = cast("Seq
+00013ff0: 7565 6e63 655b 576f 726b 6572 5374 6174  uence[WorkerStat
+00014000: 655d 222c 2077 6f72 6b65 725f 706f 6f6c  e]", worker_pool
+00014010: 2e76 616c 7565 7328 2929 0a20 2020 2020  .values()).     
+00014020: 2020 2020 2020 206e 5f77 6f72 6b65 7273         n_workers
+00014030: 203d 206c 656e 2877 705f 7661 6c73 290a   = len(wp_vals).
+00014040: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+00014050: 5f77 6f72 6b65 7273 203c 2032 303a 2020  _workers < 20:  
+00014060: 2320 736d 6172 7420 6275 7420 6c69 6e65  # smart but line
+00014070: 6172 2069 6e20 736d 616c 6c20 6361 7365  ar in small case
+00014080: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014090: 2077 7320 3d20 6d69 6e28 7770 5f76 616c   ws = min(wp_val
+000140a0: 732c 206b 6579 3d6f 7065 7261 746f 722e  s, key=operator.
+000140b0: 6174 7472 6765 7474 6572 2822 6f63 6375  attrgetter("occu
+000140c0: 7061 6e63 7922 2929 0a20 2020 2020 2020  pancy")).       
+000140d0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+000140e0: 7773 0a20 2020 2020 2020 2020 2020 2020  ws.             
+000140f0: 2020 2069 6620 7773 2e6f 6363 7570 616e     if ws.occupan
+00014100: 6379 203d 3d20 303a 0a20 2020 2020 2020  cy == 0:.       
+00014110: 2020 2020 2020 2020 2020 2020 2023 2073               # s
+00014120: 7065 6369 616c 2063 6173 6520 746f 2075  pecial case to u
+00014130: 7365 2072 6f75 6e64 2d72 6f62 696e 3b20  se round-robin; 
+00014140: 6c69 6e65 6172 2073 6561 7263 680a 2020  linear search.  
+00014150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014160: 2020 2320 666f 7220 6e65 7874 2077 6f72    # for next wor
+00014170: 6b65 7220 7769 7468 207a 6572 6f20 6f63  ker with zero oc
+00014180: 6375 7061 6e63 7920 286f 7220 6a75 7374  cupancy (or just
+00014190: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000141a0: 2020 2020 2023 206c 616e 6420 6261 636b       # land back
+000141b0: 2077 6865 7265 2077 6520 7374 6172 7465   where we starte
+000141c0: 6429 2e0a 2020 2020 2020 2020 2020 2020  d)..            
+000141d0: 2020 2020 2020 2020 7374 6172 7420 3d20          start = 
+000141e0: 7365 6c66 2e6e 5f74 6173 6b73 2025 206e  self.n_tasks % n
+000141f0: 5f77 6f72 6b65 7273 0a20 2020 2020 2020  _workers.       
+00014200: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00014210: 2069 2069 6e20 7261 6e67 6528 6e5f 776f   i in range(n_wo
+00014220: 726b 6572 7329 3a0a 2020 2020 2020 2020  rkers):.        
+00014230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014240: 7770 5f69 203d 2077 705f 7661 6c73 5b28  wp_i = wp_vals[(
+00014250: 6920 2b20 7374 6172 7429 2025 206e 5f77  i + start) % n_w
+00014260: 6f72 6b65 7273 5d0a 2020 2020 2020 2020  orkers].        
+00014270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014280: 6966 2077 705f 692e 6f63 6375 7061 6e63  if wp_i.occupanc
+00014290: 7920 3d3d 2030 3a0a 2020 2020 2020 2020  y == 0:.        
+000142a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000142b0: 2020 2020 7773 203d 2077 705f 690a 2020      ws = wp_i.  
+000142c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000142d0: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
+000142e0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+000142f0: 3a20 2023 2064 756d 6220 6275 7420 6661  :  # dumb but fa
+00014300: 7374 2069 6e20 6c61 7267 6520 6361 7365  st in large case
+00014310: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014320: 2077 7320 3d20 7770 5f76 616c 735b 7365   ws = wp_vals[se
+00014330: 6c66 2e6e 5f74 6173 6b73 2025 206e 5f77  lf.n_tasks % n_w
+00014340: 6f72 6b65 7273 5d0a 0a20 2020 2020 2020  orkers]..       
+00014350: 2069 6620 7365 6c66 2e76 616c 6964 6174   if self.validat
+00014360: 6520 616e 6420 7773 2069 7320 6e6f 7420  e and ws is not 
+00014370: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00014380: 2020 6173 7365 7274 2073 656c 662e 776f    assert self.wo
+00014390: 726b 6572 732e 6765 7428 7773 2e61 6464  rkers.get(ws.add
+000143a0: 7265 7373 2920 6973 2077 730a 2020 2020  ress) is ws.    
+000143b0: 2020 2020 2020 2020 6173 7365 7274 2077          assert w
+000143c0: 7320 696e 2073 656c 662e 7275 6e6e 696e  s in self.runnin
+000143d0: 672c 2028 7773 2c20 7365 6c66 2e72 756e  g, (ws, self.run
+000143e0: 6e69 6e67 290a 0a20 2020 2020 2020 2072  ning)..        r
+000143f0: 6574 7572 6e20 7773 0a0a 2020 2020 6465  eturn ws..    de
+00014400: 6620 5f74 7261 6e73 6974 696f 6e5f 7761  f _transition_wa
+00014410: 6974 696e 675f 7072 6f63 6573 7369 6e67  iting_processing
+00014420: 2873 656c 662c 206b 6579 3a20 4b65 792c  (self, key: Key,
+00014430: 2073 7469 6d75 6c75 735f 6964 3a20 7374   stimulus_id: st
+00014440: 7229 202d 3e20 5265 6373 4d73 6773 3a0a  r) -> RecsMsgs:.
+00014450: 2020 2020 2020 2020 2222 2250 6f73 7369          """Possi
+00014460: 626c 7920 7363 6865 6475 6c65 2061 2072  bly schedule a r
+00014470: 6561 6479 2074 6173 6b2e 2054 6869 7320  eady task. This 
+00014480: 6973 2074 6865 2070 7269 6d61 7279 2064  is the primary d
+00014490: 6973 7061 7463 6820 666f 7220 7265 6164  ispatch for read
+000144a0: 7920 7461 736b 732e 0a0a 2020 2020 2020  y tasks...      
+000144b0: 2020 4966 2074 6865 7265 2773 206e 6f20    If there's no 
+000144c0: 6170 7072 6f70 7269 6174 6520 776f 726b  appropriate work
+000144d0: 6572 2066 6f72 2074 6865 2074 6173 6b20  er for the task 
+000144e0: 2862 7574 2074 6865 2074 6173 6b20 6973  (but the task is
+000144f0: 206f 7468 6572 7769 7365 0a20 2020 2020   otherwise.     
+00014500: 2020 2072 756e 6e61 626c 6529 2c20 6974     runnable), it
+00014510: 2077 696c 6c20 6265 2072 6563 6f6d 6d65   will be recomme
+00014520: 6e64 6564 2074 6f20 6060 6e6f 2d77 6f72  nded to ``no-wor
+00014530: 6b65 7260 6020 6f72 2060 6071 7565 7565  ker`` or ``queue
+00014540: 6460 602e 0a20 2020 2020 2020 2022 2222  d``..        """
+00014550: 0a20 2020 2020 2020 2074 7320 3d20 7365  .        ts = se
+00014560: 6c66 2e74 6173 6b73 5b6b 6579 5d0a 0a20  lf.tasks[key].. 
+00014570: 2020 2020 2020 2069 6620 7365 6c66 2e69         if self.i
+00014580: 735f 726f 6f74 6973 6828 7473 293a 0a20  s_rootish(ts):. 
+00014590: 2020 2020 2020 2020 2020 2023 204e 4f54             # NOT
+000145a0: 453a 2068 6176 696e 6720 7477 6f20 726f  E: having two ro
+000145b0: 6f74 2d69 7368 206d 6574 686f 6473 2069  ot-ish methods i
+000145c0: 7320 7465 6d70 6f72 6172 792e 2057 6865  s temporary. Whe
+000145d0: 6e20 7468 6520 6665 6174 7572 6520 666c  n the feature fl
+000145e0: 6167 2069 730a 2020 2020 2020 2020 2020  ag is.          
+000145f0: 2020 2320 7265 6d6f 7665 642c 2074 6865    # removed, the
+00014600: 7265 2073 686f 756c 6420 6f6e 6c79 2062  re should only b
+00014610: 6520 6f6e 652c 2077 6869 6368 2063 6f6d  e one, which com
+00014620: 6269 6e65 7320 636f 2d61 7373 6967 6e6d  bines co-assignm
+00014630: 656e 7420 616e 640a 2020 2020 2020 2020  ent and.        
+00014640: 2020 2020 2320 7175 6575 696e 672e 2045      # queuing. E
+00014650: 7665 6e74 7561 6c6c 792c 2073 7065 6369  ventually, speci
+00014660: 616c 2d63 6173 696e 6720 726f 6f74 2074  al-casing root t
+00014670: 6173 6b73 206d 6967 6874 2062 6520 7265  asks might be re
+00014680: 6d6f 7665 6420 656e 7469 7265 6c79 2c0a  moved entirely,.
+00014690: 2020 2020 2020 2020 2020 2020 2320 7769              # wi
+000146a0: 7468 2062 6574 7465 7220 6865 7572 6973  th better heuris
+000146b0: 7469 6373 2e0a 2020 2020 2020 2020 2020  tics..          
+000146c0: 2020 6966 206d 6174 682e 6973 696e 6628    if math.isinf(
+000146d0: 7365 6c66 2e57 4f52 4b45 525f 5341 5455  self.WORKER_SATU
+000146e0: 5241 5449 4f4e 293a 0a20 2020 2020 2020  RATION):.       
+000146f0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+00014700: 2877 7320 3a3d 2073 656c 662e 6465 6369  (ws := self.deci
+00014710: 6465 5f77 6f72 6b65 725f 726f 6f74 6973  de_worker_rootis
+00014720: 685f 7175 6575 696e 675f 6469 7361 626c  h_queuing_disabl
+00014730: 6564 2874 7329 293a 0a20 2020 2020 2020  ed(ts)):.       
+00014740: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00014750: 7572 6e20 7b74 732e 6b65 793a 2022 6e6f  urn {ts.key: "no
+00014760: 2d77 6f72 6b65 7222 7d2c 207b 7d2c 207b  -worker"}, {}, {
+00014770: 7d0a 2020 2020 2020 2020 2020 2020 656c  }.            el
+00014780: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00014790: 2020 2020 6966 206e 6f74 2028 7773 203a      if not (ws :
+000147a0: 3d20 7365 6c66 2e64 6563 6964 655f 776f  = self.decide_wo
+000147b0: 726b 6572 5f72 6f6f 7469 7368 5f71 7565  rker_rootish_que
+000147c0: 7569 6e67 5f65 6e61 626c 6564 2829 293a  uing_enabled()):
+000147d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000147e0: 2020 2020 2072 6574 7572 6e20 7b74 732e       return {ts.
+000147f0: 6b65 793a 2022 7175 6575 6564 227d 2c20  key: "queued"}, 
+00014800: 7b7d 2c20 7b7d 0a20 2020 2020 2020 2065  {}, {}.        e
+00014810: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00014820: 2069 6620 6e6f 7420 2877 7320 3a3d 2073   if not (ws := s
+00014830: 656c 662e 6465 6369 6465 5f77 6f72 6b65  elf.decide_worke
+00014840: 725f 6e6f 6e5f 726f 6f74 6973 6828 7473  r_non_rootish(ts
+00014850: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
+00014860: 2020 2020 7265 7475 726e 207b 7473 2e6b      return {ts.k
+00014870: 6579 3a20 226e 6f2d 776f 726b 6572 227d  ey: "no-worker"}
+00014880: 2c20 7b7d 2c20 7b7d 0a0a 2020 2020 2020  , {}, {}..      
+00014890: 2020 7265 7475 726e 2073 656c 662e 5f61    return self._a
+000148a0: 6464 5f74 6f5f 7072 6f63 6573 7369 6e67  dd_to_processing
+000148b0: 2874 732c 2077 732c 2073 7469 6d75 6c75  (ts, ws, stimulu
+000148c0: 735f 6964 3d73 7469 6d75 6c75 735f 6964  s_id=stimulus_id
+000148d0: 290a 0a20 2020 2064 6566 205f 7472 616e  )..    def _tran
+000148e0: 7369 7469 6f6e 5f77 6169 7469 6e67 5f6d  sition_waiting_m
+000148f0: 656d 6f72 7928 0a20 2020 2020 2020 2073  emory(.        s
+00014900: 656c 662c 0a20 2020 2020 2020 206b 6579  elf,.        key
+00014910: 3a20 4b65 792c 0a20 2020 2020 2020 2073  : Key,.        s
+00014920: 7469 6d75 6c75 735f 6964 3a20 7374 722c  timulus_id: str,
+00014930: 0a20 2020 2020 2020 202a 2c0a 2020 2020  .        *,.    
+00014940: 2020 2020 6e62 7974 6573 3a20 696e 7420      nbytes: int 
+00014950: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
+00014960: 2020 2020 2020 2074 7970 653a 2062 7974         type: byt
+00014970: 6573 207c 204e 6f6e 6520 3d20 4e6f 6e65  es | None = None
+00014980: 2c0a 2020 2020 2020 2020 7479 7065 6e61  ,.        typena
+00014990: 6d65 3a20 7374 7220 7c20 4e6f 6e65 203d  me: str | None =
+000149a0: 204e 6f6e 652c 0a20 2020 2020 2020 2077   None,.        w
+000149b0: 6f72 6b65 723a 2073 7472 2c0a 2020 2020  orker: str,.    
+000149c0: 2020 2020 2a2a 6b77 6172 6773 3a20 416e      **kwargs: An
+000149d0: 792c 0a20 2020 2029 202d 3e20 5265 6373  y,.    ) -> Recs
+000149e0: 4d73 6773 3a0a 2020 2020 2020 2020 2222  Msgs:.        ""
+000149f0: 2254 6869 7320 7472 616e 7369 7469 6f6e  "This transition
+00014a00: 2065 7863 6c75 7369 7665 6c79 2068 6170   exclusively hap
+00014a10: 7065 6e73 2069 6e20 6120 7261 6365 2063  pens in a race c
+00014a20: 6f6e 6469 7469 6f6e 2077 6865 7265 2074  ondition where t
+00014a30: 6865 2073 6368 6564 756c 6572 0a20 2020  he scheduler.   
+00014a40: 2020 2020 2062 656c 6965 7665 7320 7468       believes th
+00014a50: 6174 2074 6865 206f 6e6c 7920 636f 7079  at the only copy
+00014a60: 206f 6620 6120 6465 7065 6e64 656e 6379   of a dependency
+00014a70: 2074 6173 6b20 6861 7320 6a75 7374 2062   task has just b
+00014a80: 6565 6e20 6c6f 7374 2c20 736f 2069 740a  een lost, so it.
+00014a90: 2020 2020 2020 2020 7472 616e 7369 7469          transiti
+00014aa0: 6f6e 7320 616c 6c20 6465 7065 6e64 656e  ons all dependen
+00014ab0: 7473 2062 6163 6b20 746f 2077 6169 7469  ts back to waiti
+00014ac0: 6e67 2c20 6275 7420 6163 7475 616c 6c79  ng, but actually
+00014ad0: 2061 2072 6570 6c69 6361 2068 6173 2061   a replica has a
+00014ae0: 6c72 6561 6479 0a20 2020 2020 2020 2062  lready.        b
+00014af0: 6565 6e20 6163 7175 6972 6564 2062 7920  een acquired by 
+00014b00: 6120 776f 726b 6572 2063 6f6d 7075 7469  a worker computi
+00014b10: 6e67 2074 6865 2064 6570 656e 6465 6e63  ng the dependenc
+00014b20: 7920 2d20 7468 6520 7363 6865 6475 6c65  y - the schedule
+00014b30: 7220 6a75 7374 2064 6f65 736e 2774 0a20  r just doesn't. 
+00014b40: 2020 2020 2020 206b 6e6f 7720 7965 7420         know yet 
+00014b50: 2d20 616e 6420 7468 6520 6578 6563 7574  - and the execut
+00014b60: 696f 6e20 6669 6e69 7368 6573 2062 6566  ion finishes bef
+00014b70: 6f72 6520 7468 6520 6361 6e63 656c 6c61  ore the cancella
+00014b80: 7469 6f6e 206d 6573 7361 6765 2066 726f  tion message fro
+00014b90: 6d20 7468 650a 2020 2020 2020 2020 7363  m the.        sc
+00014ba0: 6865 6475 6c65 7220 6861 7320 6120 6368  heduler has a ch
+00014bb0: 616e 6365 2074 6f20 7265 6163 6820 7468  ance to reach th
+00014bc0: 6520 776f 726b 6572 2e20 5368 6f72 746c  e worker. Shortl
+00014bd0: 792c 2074 6865 2063 616e 6365 6c6c 6174  y, the cancellat
+00014be0: 696f 6e20 7265 7175 6573 740a 2020 2020  ion request.    
+00014bf0: 2020 2020 7769 6c6c 2072 6561 6368 2074      will reach t
+00014c00: 6865 2077 6f72 6b65 722c 2074 6875 7320  he worker, thus 
+00014c10: 6465 6c65 7469 6e67 2074 6865 2064 6174  deleting the dat
+00014c20: 6120 6672 6f6d 206d 656d 6f72 792e 0a20  a from memory.. 
+00014c30: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00014c40: 2020 2074 7320 3d20 7365 6c66 2e74 6173     ts = self.tas
+00014c50: 6b73 5b6b 6579 5d0a 0a20 2020 2020 2020  ks[key]..       
+00014c60: 2069 6620 7365 6c66 2e76 616c 6964 6174   if self.validat
+00014c70: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
+00014c80: 7373 6572 7420 6e6f 7420 7473 2e70 726f  ssert not ts.pro
+00014c90: 6365 7373 696e 675f 6f6e 0a20 2020 2020  cessing_on.     
+00014ca0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
+00014cb0: 2e77 6169 7469 6e67 5f6f 6e0a 2020 2020  .waiting_on.    
+00014cc0: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
+00014cd0: 732e 7374 6174 6520 3d3d 2022 7761 6974  s.state == "wait
+00014ce0: 696e 6722 0a0a 2020 2020 2020 2020 7265  ing"..        re
+00014cf0: 7475 726e 207b 7d2c 207b 7d2c 207b 7d0a  turn {}, {}, {}.
+00014d00: 0a20 2020 2064 6566 205f 7472 616e 7369  .    def _transi
+00014d10: 7469 6f6e 5f70 726f 6365 7373 696e 675f  tion_processing_
+00014d20: 6d65 6d6f 7279 280a 2020 2020 2020 2020  memory(.        
+00014d30: 7365 6c66 2c0a 2020 2020 2020 2020 6b65  self,.        ke
+00014d40: 793a 204b 6579 2c0a 2020 2020 2020 2020  y: Key,.        
+00014d50: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
+00014d60: 2c0a 2020 2020 2020 2020 2a2c 0a20 2020  ,.        *,.   
+00014d70: 2020 2020 206e 6279 7465 733a 2069 6e74       nbytes: int
+00014d80: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
+00014d90: 2020 2020 2020 2020 7479 7065 3a20 6279          type: by
+00014da0: 7465 7320 7c20 4e6f 6e65 203d 204e 6f6e  tes | None = Non
+00014db0: 652c 0a20 2020 2020 2020 2074 7970 656e  e,.        typen
+00014dc0: 616d 653a 2073 7472 207c 204e 6f6e 6520  ame: str | None 
+00014dd0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00014de0: 776f 726b 6572 3a20 7374 722c 0a20 2020  worker: str,.   
+00014df0: 2020 2020 2073 7461 7274 7374 6f70 733a       startstops:
+00014e00: 206c 6973 745b 6469 6374 5d20 7c20 4e6f   list[dict] | No
+00014e10: 6e65 203d 204e 6f6e 652c 0a20 2020 2020  ne = None,.     
+00014e20: 2020 202a 2a6b 7761 7267 733a 2041 6e79     **kwargs: Any
+00014e30: 2c0a 2020 2020 2920 2d3e 2052 6563 734d  ,.    ) -> RecsM
+00014e40: 7367 733a 0a20 2020 2020 2020 2074 7320  sgs:.        ts 
+00014e50: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
+00014e60: 5d0a 0a20 2020 2020 2020 2061 7373 6572  ]..        asser
+00014e70: 7420 776f 726b 6572 0a20 2020 2020 2020  t worker.       
+00014e80: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
+00014e90: 6365 2877 6f72 6b65 722c 2073 7472 290a  ce(worker, str).
+00014ea0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+00014eb0: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
+00014ec0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
+00014ed0: 2e70 726f 6365 7373 696e 675f 6f6e 0a20  .processing_on. 
+00014ee0: 2020 2020 2020 2020 2020 2077 7373 203d             wss =
+00014ef0: 2074 732e 7072 6f63 6573 7369 6e67 5f6f   ts.processing_o
+00014f00: 6e0a 2020 2020 2020 2020 2020 2020 6173  n.            as
+00014f10: 7365 7274 2077 7373 0a20 2020 2020 2020  sert wss.       
+00014f20: 2020 2020 2061 7373 6572 7420 7473 2069       assert ts i
+00014f30: 6e20 7773 732e 7072 6f63 6573 7369 6e67  n wss.processing
+00014f40: 0a20 2020 2020 2020 2020 2020 2064 656c  .            del
+00014f50: 2077 7373 0a20 2020 2020 2020 2020 2020   wss.           
+00014f60: 2061 7373 6572 7420 6e6f 7420 7473 2e77   assert not ts.w
+00014f70: 6169 7469 6e67 5f6f 6e0a 2020 2020 2020  aiting_on.      
+00014f80: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
+00014f90: 2074 732e 7768 6f5f 6861 732c 2028 7473   ts.who_has, (ts
+00014fa0: 2c20 7473 2e77 686f 5f68 6173 290a 2020  , ts.who_has).  
+00014fb0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00014fc0: 206e 6f74 2074 732e 6578 6365 7074 696f   not ts.exceptio
+00014fd0: 6e5f 626c 616d 650a 2020 2020 2020 2020  n_blame.        
+00014fe0: 2020 2020 6173 7365 7274 2074 732e 7374      assert ts.st
+00014ff0: 6174 6520 3d3d 2022 7072 6f63 6573 7369  ate == "processi
+00015000: 6e67 220a 0a20 2020 2020 2020 2077 7320  ng"..        ws 
+00015010: 3d20 7365 6c66 2e77 6f72 6b65 7273 2e67  = self.workers.g
+00015020: 6574 2877 6f72 6b65 7229 0a20 2020 2020  et(worker).     
+00015030: 2020 2069 6620 7773 2069 7320 4e6f 6e65     if ws is None
+00015040: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00015050: 7475 726e 207b 6b65 793a 2022 7265 6c65  turn {key: "rele
+00015060: 6173 6564 227d 2c20 7b7d 2c20 7b7d 0a0a  ased"}, {}, {}..
+00015070: 2020 2020 2020 2020 6966 2077 7320 213d          if ws !=
+00015080: 2074 732e 7072 6f63 6573 7369 6e67 5f6f   ts.processing_o
+00015090: 6e3a 2020 2320 7072 6167 6d61 3a20 6e6f  n:  # pragma: no
+000150a0: 636f 7665 720a 2020 2020 2020 2020 2020  cover.          
+000150b0: 2020 6173 7365 7274 2074 732e 7072 6f63    assert ts.proc
+000150c0: 6573 7369 6e67 5f6f 6e0a 2020 2020 2020  essing_on.      
+000150d0: 2020 2020 2020 7261 6973 6520 5275 6e74        raise Runt
+000150e0: 696d 6545 7272 6f72 280a 2020 2020 2020  imeError(.      
+000150f0: 2020 2020 2020 2020 2020 6622 5461 736b            f"Task
+00015100: 207b 7473 2e6b 6579 2172 7d20 7472 616e   {ts.key!r} tran
+00015110: 7369 7469 6f6e 6564 2066 726f 6d20 7072  sitioned from pr
+00015120: 6f63 6573 7369 6e67 2074 6f20 6d65 6d6f  ocessing to memo
+00015130: 7279 206f 6e20 776f 726b 6572 2022 0a20  ry on worker ". 
+00015140: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00015150: 227b 7773 7d2c 2077 6869 6c65 2069 7420  "{ws}, while it 
+00015160: 7761 7320 6578 7065 6374 6564 2066 726f  was expected fro
+00015170: 6d20 7b74 732e 7072 6f63 6573 7369 6e67  m {ts.processing
+00015180: 5f6f 6e7d 2e20 5468 6973 2073 686f 756c  _on}. This shoul
+00015190: 6420 220a 2020 2020 2020 2020 2020 2020  d ".            
+000151a0: 2020 2020 6622 6265 2069 6d70 6f73 7369      f"be impossi
+000151b0: 626c 652e 207b 7374 696d 756c 7573 5f69  ble. {stimulus_i
+000151c0: 643d 7d2c 2073 746f 7279 3d7b 7365 6c66  d=}, story={self
+000151d0: 2e73 746f 7279 2874 7329 7d22 0a20 2020  .story(ts)}".   
+000151e0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+000151f0: 2020 2020 2323 2323 2323 2323 2323 2323      ############
+00015200: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00015210: 230a 2020 2020 2020 2020 2320 5570 6461  #.        # Upda
+00015220: 7465 2054 696d 696e 6720 496e 666f 726d  te Timing Inform
+00015230: 6174 696f 6e20 230a 2020 2020 2020 2020  ation #.        
+00015240: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00015250: 2323 2323 2323 2323 2323 2323 230a 2020  #############.  
+00015260: 2020 2020 2020 6966 2073 7461 7274 7374        if startst
+00015270: 6f70 733a 0a20 2020 2020 2020 2020 2020  ops:.           
+00015280: 2066 6f72 2073 7461 7274 7374 6f70 2069   for startstop i
+00015290: 6e20 7374 6172 7473 746f 7073 3a0a 2020  n startstops:.  
+000152a0: 2020 2020 2020 2020 2020 2020 2020 7473                ts
+000152b0: 2e67 726f 7570 2e61 6464 5f64 7572 6174  .group.add_durat
+000152c0: 696f 6e28 0a20 2020 2020 2020 2020 2020  ion(.           
+000152d0: 2020 2020 2020 2020 2073 746f 703d 7374           stop=st
+000152e0: 6172 7473 746f 705b 2273 746f 7022 5d2c  artstop["stop"],
+000152f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015300: 2020 2020 2073 7461 7274 3d73 7461 7274       start=start
+00015310: 7374 6f70 5b22 7374 6172 7422 5d2c 0a20  stop["start"],. 
+00015320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015330: 2020 2061 6374 696f 6e3d 7374 6172 7473     action=starts
+00015340: 746f 705b 2261 6374 696f 6e22 5d2c 0a20  top["action"],. 
+00015350: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00015360: 0a0a 2020 2020 2020 2020 7320 3d20 7365  ..        s = se
+00015370: 6c66 2e75 6e6b 6e6f 776e 5f64 7572 6174  lf.unknown_durat
+00015380: 696f 6e73 2e70 6f70 2874 732e 7072 6566  ions.pop(ts.pref
+00015390: 6978 2e6e 616d 652c 2073 6574 2829 290a  ix.name, set()).
+000153a0: 2020 2020 2020 2020 7374 6561 6c20 3d20          steal = 
+000153b0: 7365 6c66 2e65 7874 656e 7369 6f6e 732e  self.extensions.
+000153c0: 6765 7428 2273 7465 616c 696e 6722 290a  get("stealing").
+000153d0: 2020 2020 2020 2020 6966 2073 7465 616c          if steal
+000153e0: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
+000153f0: 7220 7474 7320 696e 2073 3a0a 2020 2020  r tts in s:.    
+00015400: 2020 2020 2020 2020 2020 2020 6966 2074              if t
+00015410: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
+00015420: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00015430: 2020 2020 2020 7374 6561 6c2e 7265 6361        steal.reca
+00015440: 6c63 756c 6174 655f 636f 7374 2874 7473  lculate_cost(tts
+00015450: 290a 0a20 2020 2020 2020 2023 2323 2323  )..        #####
+00015460: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00015470: 2323 2323 2323 230a 2020 2020 2020 2020  #######.        
+00015480: 2320 5570 6461 7465 2053 7461 7465 2049  # Update State I
+00015490: 6e66 6f72 6d61 7469 6f6e 2023 0a20 2020  nformation #.   
+000154a0: 2020 2020 2023 2323 2323 2323 2323 2323       ###########
+000154b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000154c0: 230a 2020 2020 2020 2020 6966 206e 6279  #.        if nby
+000154d0: 7465 7320 6973 206e 6f74 204e 6f6e 653a  tes is not None:
+000154e0: 0a20 2020 2020 2020 2020 2020 2074 732e  .            ts.
+000154f0: 7365 745f 6e62 7974 6573 286e 6279 7465  set_nbytes(nbyte
+00015500: 7329 0a0a 2020 2020 2020 2020 7365 6c66  s)..        self
+00015510: 2e5f 6578 6974 5f70 726f 6365 7373 696e  ._exit_processin
+00015520: 675f 636f 6d6d 6f6e 2874 7329 0a0a 2020  g_common(ts)..  
+00015530: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
+00015540: 7469 6f6e 733a 2052 6563 7320 3d20 7b7d  tions: Recs = {}
+00015550: 0a20 2020 2020 2020 2063 6c69 656e 745f  .        client_
+00015560: 6d73 6773 3a20 4d73 6773 203d 207b 7d0a  msgs: Msgs = {}.
+00015570: 2020 2020 2020 2020 7365 6c66 2e5f 6164          self._ad
+00015580: 645f 746f 5f6d 656d 6f72 7928 0a20 2020  d_to_memory(.   
+00015590: 2020 2020 2020 2020 2074 732c 2077 732c           ts, ws,
+000155a0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+000155b0: 2c20 636c 6965 6e74 5f6d 7367 732c 2074  , client_msgs, t
+000155c0: 7970 653d 7479 7065 2c20 7479 7065 6e61  ype=type, typena
+000155d0: 6d65 3d74 7970 656e 616d 650a 2020 2020  me=typename.    
+000155e0: 2020 2020 290a 0a20 2020 2020 2020 2069      )..        i
+000155f0: 6620 7365 6c66 2e76 616c 6964 6174 653a  f self.validate:
+00015600: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00015610: 6572 7420 6e6f 7420 7473 2e70 726f 6365  ert not ts.proce
+00015620: 7373 696e 675f 6f6e 0a20 2020 2020 2020  ssing_on.       
+00015630: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+00015640: 7473 2e77 6169 7469 6e67 5f6f 6e0a 0a20  ts.waiting_on.. 
+00015650: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
+00015660: 636f 6d6d 656e 6461 7469 6f6e 732c 2063  commendations, c
+00015670: 6c69 656e 745f 6d73 6773 2c20 7b7d 0a0a  lient_msgs, {}..
+00015680: 2020 2020 6465 6620 5f74 7261 6e73 6974      def _transit
+00015690: 696f 6e5f 6d65 6d6f 7279 5f72 656c 6561  ion_memory_relea
+000156a0: 7365 6428 0a20 2020 2020 2020 2073 656c  sed(.        sel
+000156b0: 662c 206b 6579 3a20 4b65 792c 2073 7469  f, key: Key, sti
+000156c0: 6d75 6c75 735f 6964 3a20 7374 722c 202a  mulus_id: str, *
+000156d0: 2c20 7361 6665 3a20 626f 6f6c 203d 2046  , safe: bool = F
+000156e0: 616c 7365 0a20 2020 2029 202d 3e20 5265  alse.    ) -> Re
+000156f0: 6373 4d73 6773 3a0a 2020 2020 2020 2020  csMsgs:.        
+00015700: 7473 203d 2073 656c 662e 7461 736b 735b  ts = self.tasks[
+00015710: 6b65 795d 0a0a 2020 2020 2020 2020 6966  key]..        if
+00015720: 2073 656c 662e 7661 6c69 6461 7465 3a0a   self.validate:.
+00015730: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00015740: 7274 206e 6f74 2074 732e 7761 6974 696e  rt not ts.waitin
+00015750: 675f 6f6e 0a20 2020 2020 2020 2020 2020  g_on.           
+00015760: 2061 7373 6572 7420 6e6f 7420 7473 2e70   assert not ts.p
+00015770: 726f 6365 7373 696e 675f 6f6e 0a20 2020  rocessing_on.   
+00015780: 2020 2020 2020 2020 2069 6620 7361 6665           if safe
+00015790: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000157a0: 2020 6173 7365 7274 206e 6f74 2074 732e    assert not ts.
+000157b0: 7761 6974 6572 730a 0a20 2020 2020 2020  waiters..       
+000157c0: 2069 6620 7473 2e61 6374 6f72 3a0a 2020   if ts.actor:.  
+000157d0: 2020 2020 2020 2020 2020 666f 7220 7773            for ws
+000157e0: 2069 6e20 7473 2e77 686f 5f68 6173 206f   in ts.who_has o
+000157f0: 7220 2829 3a0a 2020 2020 2020 2020 2020  r ():.          
+00015800: 2020 2020 2020 7773 2e61 6374 6f72 732e        ws.actors.
+00015810: 6469 7363 6172 6428 7473 290a 2020 2020  discard(ts).    
+00015820: 2020 2020 2020 2020 6966 2074 732e 7768          if ts.wh
+00015830: 6f5f 7761 6e74 733a 0a20 2020 2020 2020  o_wants:.       
+00015840: 2020 2020 2020 2020 2074 732e 6578 6365           ts.exce
+00015850: 7074 696f 6e5f 626c 616d 6520 3d20 7473  ption_blame = ts
+00015860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015870: 2074 732e 6578 6365 7074 696f 6e20 3d20   ts.exception = 
+00015880: 5365 7269 616c 697a 6564 280a 2020 2020  Serialized(.    
+00015890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000158a0: 2a73 6572 6961 6c69 7a65 2856 616c 7565  *serialize(Value
+000158b0: 4572 726f 7228 2257 6f72 6b65 7220 686f  Error("Worker ho
+000158c0: 6c64 696e 6720 4163 746f 7220 7761 7320  lding Actor was 
+000158d0: 6c6f 7374 2229 290a 2020 2020 2020 2020  lost")).        
+000158e0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000158f0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00015900: 207b 7473 2e6b 6579 3a20 2265 7272 6564   {ts.key: "erred
+00015910: 227d 2c20 7b7d 2c20 7b7d 2020 2320 646f  "}, {}, {}  # do
+00015920: 6e27 7420 7472 7920 746f 2072 6563 7265  n't try to recre
+00015930: 6174 650a 0a20 2020 2020 2020 2072 6563  ate..        rec
+00015940: 6f6d 6d65 6e64 6174 696f 6e73 3a20 5265  ommendations: Re
+00015950: 6373 203d 207b 7d0a 2020 2020 2020 2020  cs = {}.        
+00015960: 636c 6965 6e74 5f6d 7367 733a 204d 7367  client_msgs: Msg
+00015970: 7320 3d20 7b7d 0a20 2020 2020 2020 2077  s = {}.        w
+00015980: 6f72 6b65 725f 6d73 6773 3a20 4d73 6773  orker_msgs: Msgs
+00015990: 203d 207b 7d0a 0a20 2020 2020 2020 2023   = {}..        #
+000159a0: 2058 5858 2066 6163 746f 7220 7468 6973   XXX factor this
+000159b0: 206f 7574 3f0a 2020 2020 2020 2020 776f   out?.        wo
+000159c0: 726b 6572 5f6d 7367 203d 207b 0a20 2020  rker_msg = {.   
+000159d0: 2020 2020 2020 2020 2022 6f70 223a 2022           "op": "
+000159e0: 6672 6565 2d6b 6579 7322 2c0a 2020 2020  free-keys",.    
+000159f0: 2020 2020 2020 2020 226b 6579 7322 3a20          "keys": 
+00015a00: 5b6b 6579 5d2c 0a20 2020 2020 2020 2020  [key],.         
+00015a10: 2020 2022 7374 696d 756c 7573 5f69 6422     "stimulus_id"
+00015a20: 3a20 7374 696d 756c 7573 5f69 642c 0a20  : stimulus_id,. 
+00015a30: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00015a40: 2066 6f72 2077 7320 696e 2074 732e 7768   for ws in ts.wh
+00015a50: 6f5f 6861 7320 6f72 2028 293a 0a20 2020  o_has or ():.   
+00015a60: 2020 2020 2020 2020 2077 6f72 6b65 725f           worker_
+00015a70: 6d73 6773 5b77 732e 6164 6472 6573 735d  msgs[ws.address]
+00015a80: 203d 205b 776f 726b 6572 5f6d 7367 5d0a   = [worker_msg].
+00015a90: 2020 2020 2020 2020 7365 6c66 2e72 656d          self.rem
+00015aa0: 6f76 655f 616c 6c5f 7265 706c 6963 6173  ove_all_replicas
+00015ab0: 2874 7329 0a0a 2020 2020 2020 2020 7473  (ts)..        ts
+00015ac0: 2e73 7461 7465 203d 2022 7265 6c65 6173  .state = "releas
+00015ad0: 6564 220a 0a20 2020 2020 2020 2072 6570  ed"..        rep
+00015ae0: 6f72 745f 6d73 6720 3d20 7b22 6f70 223a  ort_msg = {"op":
+00015af0: 2022 6c6f 7374 2d64 6174 6122 2c20 226b   "lost-data", "k
+00015b00: 6579 223a 206b 6579 7d0a 2020 2020 2020  ey": key}.      
+00015b10: 2020 666f 7220 6373 2069 6e20 7473 2e77    for cs in ts.w
+00015b20: 686f 5f77 616e 7473 206f 7220 2829 3a0a  ho_wants or ():.
+00015b30: 2020 2020 2020 2020 2020 2020 636c 6965              clie
+00015b40: 6e74 5f6d 7367 735b 6373 2e63 6c69 656e  nt_msgs[cs.clien
+00015b50: 745f 6b65 795d 203d 205b 7265 706f 7274  t_key] = [report
+00015b60: 5f6d 7367 5d0a 0a20 2020 2020 2020 2069  _msg]..        i
+00015b70: 6620 6e6f 7420 7473 2e72 756e 5f73 7065  f not ts.run_spe
+00015b80: 633a 2020 2320 7075 7265 2064 6174 610a  c:  # pure data.
+00015b90: 2020 2020 2020 2020 2020 2020 7265 636f              reco
+00015ba0: 6d6d 656e 6461 7469 6f6e 735b 6b65 795d  mmendations[key]
+00015bb0: 203d 2022 666f 7267 6f74 7465 6e22 0a20   = "forgotten". 
+00015bc0: 2020 2020 2020 2065 6c69 6620 7473 2e68         elif ts.h
+00015bd0: 6173 5f6c 6f73 745f 6465 7065 6e64 656e  as_lost_dependen
+00015be0: 6369 6573 3a0a 2020 2020 2020 2020 2020  cies:.          
+00015bf0: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
+00015c00: 735b 6b65 795d 203d 2022 666f 7267 6f74  s[key] = "forgot
+00015c10: 7465 6e22 0a20 2020 2020 2020 2065 6c69  ten".        eli
+00015c20: 6620 2874 732e 7768 6f5f 7761 6e74 7320  f (ts.who_wants 
+00015c30: 6f72 2074 732e 7761 6974 6572 7329 2061  or ts.waiters) a
+00015c40: 6e64 206e 6f74 2061 6e79 280a 2020 2020  nd not any(.    
+00015c50: 2020 2020 2020 2020 6474 732e 7374 6174          dts.stat
+00015c60: 6520 3d3d 2022 6572 7265 6422 2066 6f72  e == "erred" for
+00015c70: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
+00015c80: 6465 6e63 6965 730a 2020 2020 2020 2020  dencies.        
+00015c90: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+00015ca0: 6563 6f6d 6d65 6e64 6174 696f 6e73 5b6b  ecommendations[k
+00015cb0: 6579 5d20 3d20 2277 6169 7469 6e67 220a  ey] = "waiting".
+00015cc0: 0a20 2020 2020 2020 2066 6f72 2064 7473  .        for dts
+00015cd0: 2069 6e20 7473 2e77 6169 7465 7273 206f   in ts.waiters o
+00015ce0: 7220 2829 3a0a 2020 2020 2020 2020 2020  r ():.          
+00015cf0: 2020 6966 2064 7473 2e73 7461 7465 2069    if dts.state i
+00015d00: 6e20 2822 6e6f 2d77 6f72 6b65 7222 2c20  n ("no-worker", 
+00015d10: 2270 726f 6365 7373 696e 6722 293a 0a20  "processing"):. 
+00015d20: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00015d30: 6563 6f6d 6d65 6e64 6174 696f 6e73 5b64  ecommendations[d
+00015d40: 7473 2e6b 6579 5d20 3d20 2277 6169 7469  ts.key] = "waiti
+00015d50: 6e67 220a 2020 2020 2020 2020 2020 2020  ng".            
+00015d60: 656c 6966 2064 7473 2e73 7461 7465 203d  elif dts.state =
+00015d70: 3d20 2277 6169 7469 6e67 223a 0a20 2020  = "waiting":.   
+00015d80: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00015d90: 6e6f 7420 6474 732e 7761 6974 696e 675f  not dts.waiting_
+00015da0: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
+00015db0: 2020 2020 2020 2020 6474 732e 7761 6974          dts.wait
+00015dc0: 696e 675f 6f6e 203d 2073 6574 2829 0a20  ing_on = set(). 
+00015dd0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00015de0: 7473 2e77 6169 7469 6e67 5f6f 6e2e 6164  ts.waiting_on.ad
+00015df0: 6428 7473 290a 0a20 2020 2020 2020 2069  d(ts)..        i
+00015e00: 6620 7365 6c66 2e76 616c 6964 6174 653a  f self.validate:
+00015e10: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00015e20: 6572 7420 6e6f 7420 7473 2e77 6169 7469  ert not ts.waiti
+00015e30: 6e67 5f6f 6e0a 0a20 2020 2020 2020 2072  ng_on..        r
+00015e40: 6574 7572 6e20 7265 636f 6d6d 656e 6461  eturn recommenda
+00015e50: 7469 6f6e 732c 2063 6c69 656e 745f 6d73  tions, client_ms
+00015e60: 6773 2c20 776f 726b 6572 5f6d 7367 730a  gs, worker_msgs.
+00015e70: 0a20 2020 2064 6566 205f 7472 616e 7369  .    def _transi
+00015e80: 7469 6f6e 5f72 656c 6561 7365 645f 6572  tion_released_er
+00015e90: 7265 6428 7365 6c66 2c20 6b65 793a 204b  red(self, key: K
+00015ea0: 6579 2c20 7374 696d 756c 7573 5f69 643a  ey, stimulus_id:
+00015eb0: 2073 7472 2920 2d3e 2052 6563 734d 7367   str) -> RecsMsg
+00015ec0: 733a 0a20 2020 2020 2020 2074 7320 3d20  s:.        ts = 
+00015ed0: 7365 6c66 2e74 6173 6b73 5b6b 6579 5d0a  self.tasks[key].
+00015ee0: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
+00015ef0: 6461 7469 6f6e 733a 2052 6563 7320 3d20  dations: Recs = 
+00015f00: 7b7d 0a20 2020 2020 2020 2063 6c69 656e  {}.        clien
+00015f10: 745f 6d73 6773 3a20 4d73 6773 203d 207b  t_msgs: Msgs = {
+00015f20: 7d0a 0a20 2020 2020 2020 2069 6620 7365  }..        if se
+00015f30: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
+00015f40: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00015f50: 7473 2e65 7863 6570 7469 6f6e 5f62 6c61  ts.exception_bla
+00015f60: 6d65 0a20 2020 2020 2020 2020 2020 2061  me.            a
+00015f70: 7373 6572 7420 6e6f 7420 7473 2e77 686f  ssert not ts.who
+00015f80: 5f68 6173 0a20 2020 2020 2020 2020 2020  _has.           
+00015f90: 2061 7373 6572 7420 6e6f 7420 7473 2e77   assert not ts.w
+00015fa0: 6169 7469 6e67 5f6f 6e0a 0a20 2020 2020  aiting_on..     
+00015fb0: 2020 2066 6169 6c69 6e67 5f74 7320 3d20     failing_ts = 
+00015fc0: 7473 2e65 7863 6570 7469 6f6e 5f62 6c61  ts.exception_bla
+00015fd0: 6d65 0a20 2020 2020 2020 2061 7373 6572  me.        asser
+00015fe0: 7420 6661 696c 696e 675f 7473 0a0a 2020  t failing_ts..  
+00015ff0: 2020 2020 2020 666f 7220 6474 7320 696e        for dts in
+00016000: 2074 732e 6465 7065 6e64 656e 7473 3a0a   ts.dependents:.
+00016010: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+00016020: 6f74 2064 7473 2e77 686f 5f68 6173 3a0a  ot dts.who_has:.
+00016030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016040: 6474 732e 6578 6365 7074 696f 6e5f 626c  dts.exception_bl
+00016050: 616d 6520 3d20 6661 696c 696e 675f 7473  ame = failing_ts
+00016060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016070: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+00016080: 5b64 7473 2e6b 6579 5d20 3d20 2265 7272  [dts.key] = "err
+00016090: 6564 220a 0a20 2020 2020 2020 2072 6570  ed"..        rep
+000160a0: 6f72 745f 6d73 6720 3d20 7b0a 2020 2020  ort_msg = {.    
+000160b0: 2020 2020 2020 2020 226f 7022 3a20 2274          "op": "t
+000160c0: 6173 6b2d 6572 7265 6422 2c0a 2020 2020  ask-erred",.    
+000160d0: 2020 2020 2020 2020 226b 6579 223a 206b          "key": k
+000160e0: 6579 2c0a 2020 2020 2020 2020 2020 2020  ey,.            
+000160f0: 2265 7863 6570 7469 6f6e 223a 2066 6169  "exception": fai
+00016100: 6c69 6e67 5f74 732e 6578 6365 7074 696f  ling_ts.exceptio
+00016110: 6e2c 0a20 2020 2020 2020 2020 2020 2022  n,.            "
+00016120: 7472 6163 6562 6163 6b22 3a20 6661 696c  traceback": fail
+00016130: 696e 675f 7473 2e74 7261 6365 6261 636b  ing_ts.traceback
+00016140: 2c0a 2020 2020 2020 2020 7d0a 2020 2020  ,.        }.    
+00016150: 2020 2020 666f 7220 6373 2069 6e20 7473      for cs in ts
+00016160: 2e77 686f 5f77 616e 7473 206f 7220 2829  .who_wants or ()
+00016170: 3a0a 2020 2020 2020 2020 2020 2020 636c  :.            cl
+00016180: 6965 6e74 5f6d 7367 735b 6373 2e63 6c69  ient_msgs[cs.cli
+00016190: 656e 745f 6b65 795d 203d 205b 7265 706f  ent_key] = [repo
+000161a0: 7274 5f6d 7367 5d0a 0a20 2020 2020 2020  rt_msg]..       
+000161b0: 2074 732e 7374 6174 6520 3d20 2265 7272   ts.state = "err
+000161c0: 6564 220a 0a20 2020 2020 2020 2023 2054  ed"..        # T
+000161d0: 4f44 4f3a 2077 6169 7469 6e67 2064 6174  ODO: waiting dat
+000161e0: 613f 0a20 2020 2020 2020 2072 6574 7572  a?.        retur
+000161f0: 6e20 7265 636f 6d6d 656e 6461 7469 6f6e  n recommendation
+00016200: 732c 2063 6c69 656e 745f 6d73 6773 2c20  s, client_msgs, 
+00016210: 7b7d 0a0a 2020 2020 6465 6620 5f74 7261  {}..    def _tra
+00016220: 6e73 6974 696f 6e5f 6572 7265 645f 7265  nsition_erred_re
+00016230: 6c65 6173 6564 2873 656c 662c 206b 6579  leased(self, key
+00016240: 3a20 4b65 792c 2073 7469 6d75 6c75 735f  : Key, stimulus_
+00016250: 6964 3a20 7374 7229 202d 3e20 5265 6373  id: str) -> Recs
+00016260: 4d73 6773 3a0a 2020 2020 2020 2020 7473  Msgs:.        ts
+00016270: 203d 2073 656c 662e 7461 736b 735b 6b65   = self.tasks[ke
+00016280: 795d 0a20 2020 2020 2020 2072 6563 6f6d  y].        recom
+00016290: 6d65 6e64 6174 696f 6e73 3a20 5265 6373  mendations: Recs
+000162a0: 203d 207b 7d0a 2020 2020 2020 2020 636c   = {}.        cl
+000162b0: 6965 6e74 5f6d 7367 733a 204d 7367 7320  ient_msgs: Msgs 
+000162c0: 3d20 7b7d 0a20 2020 2020 2020 2077 6f72  = {}.        wor
+000162d0: 6b65 725f 6d73 6773 3a20 4d73 6773 203d  ker_msgs: Msgs =
+000162e0: 207b 7d0a 0a20 2020 2020 2020 2069 6620   {}..        if 
+000162f0: 7365 6c66 2e76 616c 6964 6174 653a 0a20  self.validate:. 
+00016300: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00016310: 7420 7473 2e65 7863 6570 7469 6f6e 5f62  t ts.exception_b
+00016320: 6c61 6d65 0a20 2020 2020 2020 2020 2020  lame.           
+00016330: 2061 7373 6572 7420 6e6f 7420 7473 2e77   assert not ts.w
+00016340: 686f 5f68 6173 0a20 2020 2020 2020 2020  ho_has.         
+00016350: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
+00016360: 2e77 6169 7469 6e67 5f6f 6e0a 2020 2020  .waiting_on.    
+00016370: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
+00016380: 6f74 2074 732e 7761 6974 6572 730a 0a20  ot ts.waiters.. 
+00016390: 2020 2020 2020 2074 732e 6578 6365 7074         ts.except
+000163a0: 696f 6e20 3d20 4e6f 6e65 0a20 2020 2020  ion = None.     
+000163b0: 2020 2074 732e 6578 6365 7074 696f 6e5f     ts.exception_
+000163c0: 626c 616d 6520 3d20 4e6f 6e65 0a20 2020  blame = None.   
+000163d0: 2020 2020 2074 732e 7472 6163 6562 6163       ts.tracebac
+000163e0: 6b20 3d20 4e6f 6e65 0a0a 2020 2020 2020  k = None..      
+000163f0: 2020 666f 7220 6474 7320 696e 2074 732e    for dts in ts.
+00016400: 6465 7065 6e64 656e 7473 3a0a 2020 2020  dependents:.    
+00016410: 2020 2020 2020 2020 6966 2064 7473 2e73          if dts.s
+00016420: 7461 7465 203d 3d20 2265 7272 6564 223a  tate == "erred":
+00016430: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016440: 2023 2044 6f65 7320 7468 6973 206d 616b   # Does this mak
+00016450: 6520 7365 6e73 653f 0a20 2020 2020 2020  e sense?.       
+00016460: 2020 2020 2020 2020 2023 2054 6869 7320           # This 
+00016470: 676f 6573 2076 6961 2072 656c 6561 7365  goes via release
+00016480: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+00016490: 2020 2320 6474 7320 2d3e 2072 656c 6561    # dts -> relea
+000164a0: 7365 6420 2d3e 2077 6169 7469 6e67 0a20  sed -> waiting. 
+000164b0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000164c0: 6563 6f6d 6d65 6e64 6174 696f 6e73 5b64  ecommendations[d
+000164d0: 7473 2e6b 6579 5d20 3d20 2277 6169 7469  ts.key] = "waiti
+000164e0: 6e67 220a 0a20 2020 2020 2020 2077 5f6d  ng"..        w_m
+000164f0: 7367 203d 207b 0a20 2020 2020 2020 2020  sg = {.         
+00016500: 2020 2022 6f70 223a 2022 6672 6565 2d6b     "op": "free-k
+00016510: 6579 7322 2c0a 2020 2020 2020 2020 2020  eys",.          
+00016520: 2020 226b 6579 7322 3a20 5b6b 6579 5d2c    "keys": [key],
+00016530: 0a20 2020 2020 2020 2020 2020 2022 7374  .            "st
+00016540: 696d 756c 7573 5f69 6422 3a20 7374 696d  imulus_id": stim
+00016550: 756c 7573 5f69 642c 0a20 2020 2020 2020  ulus_id,.       
+00016560: 207d 0a20 2020 2020 2020 2066 6f72 2077   }.        for w
+00016570: 735f 6164 6472 2069 6e20 7473 2e65 7272  s_addr in ts.err
+00016580: 6564 5f6f 6e20 6f72 2028 293a 0a20 2020  ed_on or ():.   
+00016590: 2020 2020 2020 2020 2077 6f72 6b65 725f           worker_
+000165a0: 6d73 6773 5b77 735f 6164 6472 5d20 3d20  msgs[ws_addr] = 
+000165b0: 5b77 5f6d 7367 5d0a 2020 2020 2020 2020  [w_msg].        
+000165c0: 7473 2e65 7272 6564 5f6f 6e20 3d20 4e6f  ts.erred_on = No
+000165d0: 6e65 0a0a 2020 2020 2020 2020 7265 706f  ne..        repo
+000165e0: 7274 5f6d 7367 203d 207b 226f 7022 3a20  rt_msg = {"op": 
+000165f0: 2274 6173 6b2d 7265 7472 6965 6422 2c20  "task-retried", 
+00016600: 226b 6579 223a 206b 6579 7d0a 2020 2020  "key": key}.    
+00016610: 2020 2020 666f 7220 6373 2069 6e20 7473      for cs in ts
+00016620: 2e77 686f 5f77 616e 7473 206f 7220 2829  .who_wants or ()
+00016630: 3a0a 2020 2020 2020 2020 2020 2020 636c  :.            cl
+00016640: 6965 6e74 5f6d 7367 735b 6373 2e63 6c69  ient_msgs[cs.cli
+00016650: 656e 745f 6b65 795d 203d 205b 7265 706f  ent_key] = [repo
+00016660: 7274 5f6d 7367 5d0a 0a20 2020 2020 2020  rt_msg]..       
+00016670: 2074 732e 7374 6174 6520 3d20 2272 656c   ts.state = "rel
+00016680: 6561 7365 6422 0a0a 2020 2020 2020 2020  eased"..        
+00016690: 7265 7475 726e 2072 6563 6f6d 6d65 6e64  return recommend
+000166a0: 6174 696f 6e73 2c20 636c 6965 6e74 5f6d  ations, client_m
+000166b0: 7367 732c 2077 6f72 6b65 725f 6d73 6773  sgs, worker_msgs
+000166c0: 0a0a 2020 2020 6465 6620 5f74 7261 6e73  ..    def _trans
+000166d0: 6974 696f 6e5f 7761 6974 696e 675f 7265  ition_waiting_re
+000166e0: 6c65 6173 6564 2873 656c 662c 206b 6579  leased(self, key
+000166f0: 3a20 4b65 792c 2073 7469 6d75 6c75 735f  : Key, stimulus_
+00016700: 6964 3a20 7374 7229 202d 3e20 5265 6373  id: str) -> Recs
+00016710: 4d73 6773 3a0a 2020 2020 2020 2020 7473  Msgs:.        ts
+00016720: 203d 2073 656c 662e 7461 736b 735b 6b65   = self.tasks[ke
+00016730: 795d 0a20 2020 2020 2020 2072 6563 6f6d  y].        recom
+00016740: 6d65 6e64 6174 696f 6e73 3a20 5265 6373  mendations: Recs
+00016750: 203d 207b 7d0a 0a20 2020 2020 2020 2069   = {}..        i
+00016760: 6620 7365 6c66 2e76 616c 6964 6174 653a  f self.validate:
+00016770: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00016780: 6572 7420 6e6f 7420 7473 2e77 686f 5f68  ert not ts.who_h
+00016790: 6173 0a20 2020 2020 2020 2020 2020 2061  as.            a
+000167a0: 7373 6572 7420 6e6f 7420 7473 2e70 726f  ssert not ts.pro
+000167b0: 6365 7373 696e 675f 6f6e 0a0a 2020 2020  cessing_on..    
+000167c0: 2020 2020 666f 7220 6474 7320 696e 2074      for dts in t
+000167d0: 732e 6465 7065 6e64 656e 6369 6573 3a0a  s.dependencies:.
+000167e0: 2020 2020 2020 2020 2020 2020 6966 2074              if t
+000167f0: 7320 696e 2028 6474 732e 7761 6974 6572  s in (dts.waiter
+00016800: 7320 6f72 2028 2929 3a0a 2020 2020 2020  s or ()):.      
+00016810: 2020 2020 2020 2020 2020 6966 2064 7473            if dts
+00016820: 2e77 6169 7465 7273 3a0a 2020 2020 2020  .waiters:.      
+00016830: 2020 2020 2020 2020 2020 2020 2020 6474                dt
+00016840: 732e 7761 6974 6572 732e 6469 7363 6172  s.waiters.discar
+00016850: 6428 7473 290a 2020 2020 2020 2020 2020  d(ts).          
+00016860: 2020 2020 2020 6966 206e 6f74 2064 7473        if not dts
+00016870: 2e77 6169 7465 7273 2061 6e64 206e 6f74  .waiters and not
+00016880: 2064 7473 2e77 686f 5f77 616e 7473 3a0a   dts.who_wants:.
+00016890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000168a0: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
+000168b0: 6f6e 735b 6474 732e 6b65 795d 203d 2022  ons[dts.key] = "
+000168c0: 7265 6c65 6173 6564 220a 2020 2020 2020  released".      
+000168d0: 2020 7473 2e77 6169 7469 6e67 5f6f 6e20    ts.waiting_on 
+000168e0: 3d20 4e6f 6e65 0a0a 2020 2020 2020 2020  = None..        
+000168f0: 7473 2e73 7461 7465 203d 2022 7265 6c65  ts.state = "rele
+00016900: 6173 6564 220a 0a20 2020 2020 2020 2069  ased"..        i
+00016910: 6620 7473 2e68 6173 5f6c 6f73 745f 6465  f ts.has_lost_de
+00016920: 7065 6e64 656e 6369 6573 3a0a 2020 2020  pendencies:.    
+00016930: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
+00016940: 6461 7469 6f6e 735b 6b65 795d 203d 2022  dations[key] = "
+00016950: 666f 7267 6f74 7465 6e22 0a20 2020 2020  forgotten".     
+00016960: 2020 2065 6c69 6620 6e6f 7420 7473 2e65     elif not ts.e
+00016970: 7863 6570 7469 6f6e 5f62 6c61 6d65 2061  xception_blame a
+00016980: 6e64 2028 7473 2e77 686f 5f77 616e 7473  nd (ts.who_wants
+00016990: 206f 7220 7473 2e77 6169 7465 7273 293a   or ts.waiters):
+000169a0: 0a20 2020 2020 2020 2020 2020 2072 6563  .            rec
+000169b0: 6f6d 6d65 6e64 6174 696f 6e73 5b6b 6579  ommendations[key
+000169c0: 5d20 3d20 2277 6169 7469 6e67 220a 2020  ] = "waiting".  
+000169d0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000169e0: 2020 2020 2020 2020 7473 2e77 6169 7465          ts.waite
+000169f0: 7273 203d 204e 6f6e 650a 0a20 2020 2020  rs = None..     
+00016a00: 2020 2072 6574 7572 6e20 7265 636f 6d6d     return recomm
+00016a10: 656e 6461 7469 6f6e 732c 207b 7d2c 207b  endations, {}, {
+00016a20: 7d0a 0a20 2020 2064 6566 205f 7472 616e  }..    def _tran
+00016a30: 7369 7469 6f6e 5f70 726f 6365 7373 696e  sition_processin
+00016a40: 675f 7265 6c65 6173 6564 2873 656c 662c  g_released(self,
+00016a50: 206b 6579 3a20 4b65 792c 2073 7469 6d75   key: Key, stimu
+00016a60: 6c75 735f 6964 3a20 7374 7229 202d 3e20  lus_id: str) -> 
+00016a70: 5265 6373 4d73 6773 3a0a 2020 2020 2020  RecsMsgs:.      
+00016a80: 2020 7473 203d 2073 656c 662e 7461 736b    ts = self.task
+00016a90: 735b 6b65 795d 0a20 2020 2020 2020 2072  s[key].        r
+00016aa0: 6563 6f6d 6d65 6e64 6174 696f 6e73 3a20  ecommendations: 
+00016ab0: 5265 6373 203d 207b 7d0a 2020 2020 2020  Recs = {}.      
+00016ac0: 2020 776f 726b 6572 5f6d 7367 733a 204d    worker_msgs: M
+00016ad0: 7367 7320 3d20 7b7d 0a0a 2020 2020 2020  sgs = {}..      
+00016ae0: 2020 6966 2073 656c 662e 7661 6c69 6461    if self.valida
+00016af0: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
+00016b00: 6173 7365 7274 2074 732e 7072 6f63 6573  assert ts.proces
+00016b10: 7369 6e67 5f6f 6e0a 2020 2020 2020 2020  sing_on.        
+00016b20: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
+00016b30: 732e 7768 6f5f 6861 730a 2020 2020 2020  s.who_has.      
+00016b40: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
+00016b50: 2074 732e 7761 6974 696e 675f 6f6e 0a20   ts.waiting_on. 
+00016b60: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00016b70: 7420 7473 2e73 7461 7465 203d 3d20 2270  t ts.state == "p
+00016b80: 726f 6365 7373 696e 6722 0a0a 2020 2020  rocessing"..    
+00016b90: 2020 2020 7773 203d 2073 656c 662e 5f65      ws = self._e
+00016ba0: 7869 745f 7072 6f63 6573 7369 6e67 5f63  xit_processing_c
+00016bb0: 6f6d 6d6f 6e28 7473 290a 2020 2020 2020  ommon(ts).      
+00016bc0: 2020 6966 2077 733a 0a20 2020 2020 2020    if ws:.       
+00016bd0: 2020 2020 2077 6f72 6b65 725f 6d73 6773       worker_msgs
+00016be0: 5b77 732e 6164 6472 6573 735d 203d 205b  [ws.address] = [
+00016bf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016c00: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00016c10: 2020 2020 2020 2022 6f70 223a 2022 6672         "op": "fr
+00016c20: 6565 2d6b 6579 7322 2c0a 2020 2020 2020  ee-keys",.      
+00016c30: 2020 2020 2020 2020 2020 2020 2020 226b                "k
+00016c40: 6579 7322 3a20 5b6b 6579 5d2c 0a20 2020  eys": [key],.   
+00016c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016c60: 2022 7374 696d 756c 7573 5f69 6422 3a20   "stimulus_id": 
+00016c70: 7374 696d 756c 7573 5f69 642c 0a20 2020  stimulus_id,.   
+00016c80: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+00016c90: 2020 2020 2020 2020 2020 205d 0a0a 2020             ]..  
+00016ca0: 2020 2020 2020 7365 6c66 2e5f 7072 6f70        self._prop
+00016cb0: 6167 6174 655f 7265 6c65 6173 6564 2874  agate_released(t
+00016cc0: 732c 2072 6563 6f6d 6d65 6e64 6174 696f  s, recommendatio
+00016cd0: 6e73 290a 2020 2020 2020 2020 7265 7475  ns).        retu
+00016ce0: 726e 2072 6563 6f6d 6d65 6e64 6174 696f  rn recommendatio
+00016cf0: 6e73 2c20 7b7d 2c20 776f 726b 6572 5f6d  ns, {}, worker_m
+00016d00: 7367 730a 0a20 2020 2064 6566 205f 7472  sgs..    def _tr
+00016d10: 616e 7369 7469 6f6e 5f70 726f 6365 7373  ansition_process
+00016d20: 696e 675f 6572 7265 6428 0a20 2020 2020  ing_erred(.     
+00016d30: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+00016d40: 206b 6579 3a20 4b65 792c 0a20 2020 2020   key: Key,.     
+00016d50: 2020 2073 7469 6d75 6c75 735f 6964 3a20     stimulus_id: 
+00016d60: 7374 722c 0a20 2020 2020 2020 2077 6f72  str,.        wor
+00016d70: 6b65 723a 2073 7472 2c0a 2020 2020 2020  ker: str,.      
+00016d80: 2020 2a2c 0a20 2020 2020 2020 2063 6175    *,.        cau
+00016d90: 7365 3a20 4b65 7920 7c20 4e6f 6e65 203d  se: Key | None =
+00016da0: 204e 6f6e 652c 0a20 2020 2020 2020 2065   None,.        e
+00016db0: 7863 6570 7469 6f6e 3a20 5365 7269 616c  xception: Serial
+00016dc0: 697a 6564 207c 204e 6f6e 6520 3d20 4e6f  ized | None = No
+00016dd0: 6e65 2c0a 2020 2020 2020 2020 7472 6163  ne,.        trac
+00016de0: 6562 6163 6b3a 2053 6572 6961 6c69 7a65  eback: Serialize
+00016df0: 6420 7c20 4e6f 6e65 203d 204e 6f6e 652c  d | None = None,
+00016e00: 0a20 2020 2020 2020 2065 7863 6570 7469  .        excepti
+00016e10: 6f6e 5f74 6578 743a 2073 7472 207c 204e  on_text: str | N
+00016e20: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
+00016e30: 2020 2020 7472 6163 6562 6163 6b5f 7465      traceback_te
+00016e40: 7874 3a20 7374 7220 7c20 4e6f 6e65 203d  xt: str | None =
+00016e50: 204e 6f6e 652c 0a20 2020 2020 2020 202a   None,.        *
+00016e60: 2a6b 7761 7267 733a 2041 6e79 2c0a 2020  *kwargs: Any,.  
+00016e70: 2020 2920 2d3e 2052 6563 734d 7367 733a    ) -> RecsMsgs:
+00016e80: 0a20 2020 2020 2020 2022 2222 5072 6f63  .        """Proc
+00016e90: 6573 7365 6420 6120 7265 636f 6d6d 656e  essed a recommen
+00016ea0: 6465 6420 7472 616e 7369 7469 6f6e 2070  ded transition p
+00016eb0: 726f 6365 7373 696e 6720 2d3e 2065 7272  rocessing -> err
+00016ec0: 6564 2e0a 0a20 2020 2020 2020 2050 6172  ed...        Par
+00016ed0: 616d 6574 6572 730a 2020 2020 2020 2020  ameters.        
+00016ee0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020  ----------.     
+00016ef0: 2020 206b 6579 0a20 2020 2020 2020 2020     key.         
+00016f00: 2020 4b65 7920 6f66 2074 6865 2074 6173    Key of the tas
+00016f10: 6b20 746f 2074 7261 6e73 6974 696f 6e0a  k to transition.
+00016f20: 2020 2020 2020 2020 7374 696d 756c 7573          stimulus
+00016f30: 5f69 640a 2020 2020 2020 2020 2020 2020  _id.            
+00016f40: 4944 206f 6620 7468 6520 7374 696d 756c  ID of the stimul
+00016f50: 7573 2063 6175 7369 6e67 2074 6865 2074  us causing the t
+00016f60: 7261 6e73 6974 696f 6e0a 2020 2020 2020  ransition.      
+00016f70: 2020 776f 726b 6572 0a20 2020 2020 2020    worker.       
+00016f80: 2020 2020 2041 6464 7265 7373 206f 6620       Address of 
+00016f90: 7468 6520 776f 726b 6572 2077 6865 7265  the worker where
+00016fa0: 2074 6865 2074 6173 6b20 6572 7265 642e   the task erred.
+00016fb0: 0a20 2020 2020 2020 2020 2020 204e 6f74  .            Not
+00016fc0: 206e 6563 6573 7361 7269 6c79 2060 6074   necessarily ``t
+00016fd0: 732e 7072 6f63 6573 7369 6e67 5f6f 6e60  s.processing_on`
+00016fe0: 602e 0a20 2020 2020 2020 2063 6175 7365  `..        cause
+00016ff0: 0a20 2020 2020 2020 2020 2020 2041 6464  .            Add
+00017000: 7265 7373 206f 6620 7468 6520 7461 736b  ress of the task
+00017010: 2074 6861 7420 6361 7573 6564 2074 6869   that caused thi
+00017020: 7320 7461 736b 2074 6f20 6265 2074 7261  s task to be tra
+00017030: 6e73 6974 696f 6e65 6420 746f 2065 7272  nsitioned to err
+00017040: 6564 0a20 2020 2020 2020 2065 7863 6570  ed.        excep
+00017050: 7469 6f6e 0a20 2020 2020 2020 2020 2020  tion.           
+00017060: 2045 7863 6570 7469 6f6e 2063 6175 7365   Exception cause
+00017070: 6420 6279 2074 6865 2074 6173 6b0a 2020  d by the task.  
+00017080: 2020 2020 2020 7472 6163 6562 6163 6b0a        traceback.
+00017090: 2020 2020 2020 2020 2020 2020 5472 6163              Trac
+000170a0: 6562 6163 6b20 6361 7573 6564 2062 7920  eback caused by 
+000170b0: 7468 6520 7461 736b 0a20 2020 2020 2020  the task.       
+000170c0: 2065 7863 6570 7469 6f6e 5f74 6578 740a   exception_text.
+000170d0: 2020 2020 2020 2020 2020 2020 5374 7269              Stri
+000170e0: 6e67 2072 6570 7265 7365 6e74 6174 696f  ng representatio
+000170f0: 6e20 6f66 2074 6865 2065 7863 6570 7469  n of the excepti
+00017100: 6f6e 0a20 2020 2020 2020 2074 7261 6365  on.        trace
+00017110: 6261 636b 5f74 6578 740a 2020 2020 2020  back_text.      
+00017120: 2020 2020 2020 5374 7269 6e67 2072 6570        String rep
+00017130: 7265 7365 6e74 6174 696f 6e20 6f66 2074  resentation of t
+00017140: 6865 2074 7261 6365 6261 636b 0a0a 2020  he traceback..  
+00017150: 2020 2020 2020 5265 7475 726e 730a 2020        Returns.  
+00017160: 2020 2020 2020 2d2d 2d2d 2d2d 2d0a 2020        -------.  
+00017170: 2020 2020 2020 5265 636f 6d6d 656e 6461        Recommenda
+00017180: 7469 6f6e 732c 2063 6c69 656e 7420 6d65  tions, client me
+00017190: 7373 6167 6573 2061 6e64 2077 6f72 6b65  ssages and worke
+000171a0: 7220 6d65 7373 6167 6573 2074 6f20 7072  r messages to pr
+000171b0: 6f63 6573 730a 2020 2020 2020 2020 2222  ocess.        ""
+000171c0: 220a 2020 2020 2020 2020 7473 203d 2073  ".        ts = s
+000171d0: 656c 662e 7461 736b 735b 6b65 795d 0a20  elf.tasks[key]. 
+000171e0: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
+000171f0: 6174 696f 6e73 3a20 5265 6373 203d 207b  ations: Recs = {
+00017200: 7d0a 2020 2020 2020 2020 636c 6965 6e74  }.        client
+00017210: 5f6d 7367 733a 204d 7367 7320 3d20 7b7d  _msgs: Msgs = {}
+00017220: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+00017230: 662e 7661 6c69 6461 7465 3a0a 2020 2020  f.validate:.    
+00017240: 2020 2020 2020 2020 6173 7365 7274 2063          assert c
+00017250: 6175 7365 206f 7220 7473 2e65 7863 6570  ause or ts.excep
+00017260: 7469 6f6e 5f62 6c61 6d65 0a20 2020 2020  tion_blame.     
+00017270: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
+00017280: 2e70 726f 6365 7373 696e 675f 6f6e 0a20  .processing_on. 
+00017290: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+000172a0: 7420 6e6f 7420 7473 2e77 686f 5f68 6173  t not ts.who_has
+000172b0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+000172c0: 6572 7420 6e6f 7420 7473 2e77 6169 7469  ert not ts.waiti
+000172d0: 6e67 5f6f 6e0a 0a20 2020 2020 2020 2069  ng_on..        i
+000172e0: 6620 7473 2e61 6374 6f72 3a0a 2020 2020  f ts.actor:.    
+000172f0: 2020 2020 2020 2020 7773 203d 2074 732e          ws = ts.
+00017300: 7072 6f63 6573 7369 6e67 5f6f 6e0a 2020  processing_on.  
+00017310: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00017320: 2077 730a 2020 2020 2020 2020 2020 2020   ws.            
+00017330: 7773 2e61 6374 6f72 732e 7265 6d6f 7665  ws.actors.remove
+00017340: 2874 7329 0a0a 2020 2020 2020 2020 7365  (ts)..        se
+00017350: 6c66 2e5f 6578 6974 5f70 726f 6365 7373  lf._exit_process
+00017360: 696e 675f 636f 6d6d 6f6e 2874 7329 0a0a  ing_common(ts)..
+00017370: 2020 2020 2020 2020 6966 206e 6f74 2074          if not t
+00017380: 732e 6572 7265 645f 6f6e 3a0a 2020 2020  s.erred_on:.    
+00017390: 2020 2020 2020 2020 7473 2e65 7272 6564          ts.erred
+000173a0: 5f6f 6e20 3d20 7365 7428 290a 2020 2020  _on = set().    
+000173b0: 2020 2020 7473 2e65 7272 6564 5f6f 6e2e      ts.erred_on.
+000173c0: 6164 6428 776f 726b 6572 290a 2020 2020  add(worker).    
+000173d0: 2020 2020 6966 2065 7863 6570 7469 6f6e      if exception
+000173e0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+000173f0: 2020 2020 2020 2020 2020 7473 2e65 7863            ts.exc
+00017400: 6570 7469 6f6e 203d 2065 7863 6570 7469  eption = excepti
+00017410: 6f6e 0a20 2020 2020 2020 2020 2020 2074  on.            t
+00017420: 732e 6578 6365 7074 696f 6e5f 7465 7874  s.exception_text
+00017430: 203d 2065 7863 6570 7469 6f6e 5f74 6578   = exception_tex
+00017440: 740a 2020 2020 2020 2020 6966 2074 7261  t.        if tra
+00017450: 6365 6261 636b 2069 7320 6e6f 7420 4e6f  ceback is not No
+00017460: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00017470: 7473 2e74 7261 6365 6261 636b 203d 2074  ts.traceback = t
+00017480: 7261 6365 6261 636b 0a20 2020 2020 2020  raceback.       
+00017490: 2020 2020 2074 732e 7472 6163 6562 6163       ts.tracebac
+000174a0: 6b5f 7465 7874 203d 2074 7261 6365 6261  k_text = traceba
+000174b0: 636b 5f74 6578 740a 2020 2020 2020 2020  ck_text.        
+000174c0: 6966 2063 6175 7365 2069 7320 6e6f 7420  if cause is not 
+000174d0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+000174e0: 2020 6661 696c 696e 675f 7473 203d 2073    failing_ts = s
+000174f0: 656c 662e 7461 736b 735b 6361 7573 655d  elf.tasks[cause]
+00017500: 0a20 2020 2020 2020 2020 2020 2074 732e  .            ts.
+00017510: 6578 6365 7074 696f 6e5f 626c 616d 6520  exception_blame 
+00017520: 3d20 6661 696c 696e 675f 7473 0a20 2020  = failing_ts.   
+00017530: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00017540: 2020 2020 2020 2066 6169 6c69 6e67 5f74         failing_t
+00017550: 7320 3d20 7473 2e65 7863 6570 7469 6f6e  s = ts.exception
+00017560: 5f62 6c61 6d65 2020 2320 7479 7065 3a20  _blame  # type: 
+00017570: 6967 6e6f 7265 0a0a 2020 2020 2020 2020  ignore..        
+00017580: 7365 6c66 2e65 7272 6564 5f74 6173 6b73  self.erred_tasks
+00017590: 2e61 7070 656e 646c 6566 7428 0a20 2020  .appendleft(.   
+000175a0: 2020 2020 2020 2020 2045 7272 6564 5461           ErredTa
+000175b0: 736b 280a 2020 2020 2020 2020 2020 2020  sk(.            
+000175c0: 2020 2020 7473 2e6b 6579 2c0a 2020 2020      ts.key,.    
+000175d0: 2020 2020 2020 2020 2020 2020 7469 6d65              time
+000175e0: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
+000175f0: 2020 2020 7473 2e65 7272 6564 5f6f 6e2e      ts.erred_on.
+00017600: 636f 7079 2829 2c0a 2020 2020 2020 2020  copy(),.        
+00017610: 2020 2020 2020 2020 6578 6365 7074 696f          exceptio
+00017620: 6e5f 7465 7874 206f 7220 2222 2c0a 2020  n_text or "",.  
+00017630: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+00017640: 6163 6562 6163 6b5f 7465 7874 206f 7220  aceback_text or 
+00017650: 2222 2c0a 2020 2020 2020 2020 2020 2020  "",.            
+00017660: 290a 2020 2020 2020 2020 290a 0a20 2020  ).        )..   
+00017670: 2020 2020 2066 6f72 2064 7473 2069 6e20       for dts in 
+00017680: 7473 2e77 6169 7465 7273 206f 7220 7365  ts.waiters or se
+00017690: 7428 293a 0a20 2020 2020 2020 2020 2020  t():.           
+000176a0: 2064 7473 2e65 7863 6570 7469 6f6e 5f62   dts.exception_b
+000176b0: 6c61 6d65 203d 2066 6169 6c69 6e67 5f74  lame = failing_t
+000176c0: 730a 2020 2020 2020 2020 2020 2020 7265  s.            re
+000176d0: 636f 6d6d 656e 6461 7469 6f6e 735b 6474  commendations[dt
+000176e0: 732e 6b65 795d 203d 2022 6572 7265 6422  s.key] = "erred"
+000176f0: 0a0a 2020 2020 2020 2020 666f 7220 6474  ..        for dt
+00017700: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
+00017710: 6369 6573 3a0a 2020 2020 2020 2020 2020  cies:.          
+00017720: 2020 6966 2064 7473 2e77 6169 7465 7273    if dts.waiters
+00017730: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00017740: 2020 6474 732e 7761 6974 6572 732e 6469    dts.waiters.di
+00017750: 7363 6172 6428 7473 290a 2020 2020 2020  scard(ts).      
+00017760: 2020 2020 2020 6966 206e 6f74 2064 7473        if not dts
+00017770: 2e77 6169 7465 7273 2061 6e64 206e 6f74  .waiters and not
+00017780: 2064 7473 2e77 686f 5f77 616e 7473 3a0a   dts.who_wants:.
+00017790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000177a0: 7265 636f 6d6d 656e 6461 7469 6f6e 735b  recommendations[
+000177b0: 6474 732e 6b65 795d 203d 2022 7265 6c65  dts.key] = "rele
+000177c0: 6173 6564 220a 0a20 2020 2020 2020 2074  ased"..        t
+000177d0: 732e 7761 6974 6572 7320 3d20 4e6f 6e65  s.waiters = None
+000177e0: 0a0a 2020 2020 2020 2020 7473 2e73 7461  ..        ts.sta
+000177f0: 7465 203d 2022 6572 7265 6422 0a0a 2020  te = "erred"..  
+00017800: 2020 2020 2020 7265 706f 7274 5f6d 7367        report_msg
+00017810: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+00017820: 2022 6f70 223a 2022 7461 736b 2d65 7272   "op": "task-err
+00017830: 6564 222c 0a20 2020 2020 2020 2020 2020  ed",.           
+00017840: 2022 6b65 7922 3a20 6b65 792c 0a20 2020   "key": key,.   
+00017850: 2020 2020 2020 2020 2022 6578 6365 7074           "except
+00017860: 696f 6e22 3a20 6661 696c 696e 675f 7473  ion": failing_ts
+00017870: 2e65 7863 6570 7469 6f6e 2c0a 2020 2020  .exception,.    
+00017880: 2020 2020 2020 2020 2274 7261 6365 6261          "traceba
+00017890: 636b 223a 2066 6169 6c69 6e67 5f74 732e  ck": failing_ts.
+000178a0: 7472 6163 6562 6163 6b2c 0a20 2020 2020  traceback,.     
+000178b0: 2020 207d 0a20 2020 2020 2020 2066 6f72     }.        for
+000178c0: 2063 7320 696e 2074 732e 7768 6f5f 7761   cs in ts.who_wa
+000178d0: 6e74 7320 6f72 2028 293a 0a20 2020 2020  nts or ():.     
+000178e0: 2020 2020 2020 2063 6c69 656e 745f 6d73         client_ms
+000178f0: 6773 5b63 732e 636c 6965 6e74 5f6b 6579  gs[cs.client_key
+00017900: 5d20 3d20 5b72 6570 6f72 745f 6d73 675d  ] = [report_msg]
+00017910: 0a0a 2020 2020 2020 2020 6373 203d 2073  ..        cs = s
+00017920: 656c 662e 636c 6965 6e74 735b 2266 6972  elf.clients["fir
+00017930: 652d 616e 642d 666f 7267 6574 225d 0a20  e-and-forget"]. 
+00017940: 2020 2020 2020 2069 6620 7473 2069 6e20         if ts in 
+00017950: 6373 2e77 616e 7473 5f77 6861 743a 0a20  cs.wants_what:. 
+00017960: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00017970: 5f63 6c69 656e 745f 7265 6c65 6173 6573  _client_releases
+00017980: 5f6b 6579 7328 0a20 2020 2020 2020 2020  _keys(.         
+00017990: 2020 2020 2020 2063 733d 6373 2c0a 2020         cs=cs,.  
+000179a0: 2020 2020 2020 2020 2020 2020 2020 6b65                ke
+000179b0: 7973 3d5b 6b65 795d 2c0a 2020 2020 2020  ys=[key],.      
+000179c0: 2020 2020 2020 2020 2020 7265 636f 6d6d            recomm
+000179d0: 656e 6461 7469 6f6e 733d 7265 636f 6d6d  endations=recomm
+000179e0: 656e 6461 7469 6f6e 732c 0a20 2020 2020  endations,.     
+000179f0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+00017a00: 2020 6966 2073 656c 662e 7661 6c69 6461    if self.valida
+00017a10: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
+00017a20: 6173 7365 7274 206e 6f74 2074 732e 7072  assert not ts.pr
+00017a30: 6f63 6573 7369 6e67 5f6f 6e0a 0a20 2020  ocessing_on..   
+00017a40: 2020 2020 2072 6574 7572 6e20 7265 636f       return reco
+00017a50: 6d6d 656e 6461 7469 6f6e 732c 2063 6c69  mmendations, cli
+00017a60: 656e 745f 6d73 6773 2c20 7b7d 0a0a 2020  ent_msgs, {}..  
+00017a70: 2020 6465 6620 5f74 7261 6e73 6974 696f    def _transitio
+00017a80: 6e5f 6e6f 5f77 6f72 6b65 725f 7265 6c65  n_no_worker_rele
+00017a90: 6173 6564 2873 656c 662c 206b 6579 3a20  ased(self, key: 
+00017aa0: 4b65 792c 2073 7469 6d75 6c75 735f 6964  Key, stimulus_id
+00017ab0: 3a20 7374 7229 202d 3e20 5265 6373 4d73  : str) -> RecsMs
+00017ac0: 6773 3a0a 2020 2020 2020 2020 7473 203d  gs:.        ts =
+00017ad0: 2073 656c 662e 7461 736b 735b 6b65 795d   self.tasks[key]
+00017ae0: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+00017af0: 662e 7661 6c69 6461 7465 3a0a 2020 2020  f.validate:.    
+00017b00: 2020 2020 2020 2020 6173 7365 7274 2073          assert s
+00017b10: 656c 662e 7461 736b 735b 6b65 795d 2e73  elf.tasks[key].s
+00017b20: 7461 7465 203d 3d20 226e 6f2d 776f 726b  tate == "no-work
+00017b30: 6572 220a 2020 2020 2020 2020 2020 2020  er".            
+00017b40: 6173 7365 7274 206e 6f74 2074 732e 7768  assert not ts.wh
+00017b50: 6f5f 6861 730a 2020 2020 2020 2020 2020  o_has.          
+00017b60: 2020 6173 7365 7274 206e 6f74 2074 732e    assert not ts.
+00017b70: 7761 6974 696e 675f 6f6e 0a0a 2020 2020  waiting_on..    
+00017b80: 2020 2020 7365 6c66 2e75 6e72 756e 6e61      self.unrunna
+00017b90: 626c 652e 7265 6d6f 7665 2874 7329 0a0a  ble.remove(ts)..
+00017ba0: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
+00017bb0: 6461 7469 6f6e 733a 2052 6563 7320 3d20  dations: Recs = 
+00017bc0: 7b7d 0a20 2020 2020 2020 2073 656c 662e  {}.        self.
+00017bd0: 5f70 726f 7061 6761 7465 5f72 656c 6561  _propagate_relea
+00017be0: 7365 6428 7473 2c20 7265 636f 6d6d 656e  sed(ts, recommen
+00017bf0: 6461 7469 6f6e 7329 0a20 2020 2020 2020  dations).       
+00017c00: 2072 6574 7572 6e20 7265 636f 6d6d 656e   return recommen
+00017c10: 6461 7469 6f6e 732c 207b 7d2c 207b 7d0a  dations, {}, {}.
+00017c20: 0a20 2020 2064 6566 205f 7472 616e 7369  .    def _transi
+00017c30: 7469 6f6e 5f77 6169 7469 6e67 5f71 7565  tion_waiting_que
+00017c40: 7565 6428 7365 6c66 2c20 6b65 793a 204b  ued(self, key: K
+00017c50: 6579 2c20 7374 696d 756c 7573 5f69 643a  ey, stimulus_id:
+00017c60: 2073 7472 2920 2d3e 2052 6563 734d 7367   str) -> RecsMsg
+00017c70: 733a 0a20 2020 2020 2020 2074 7320 3d20  s:.        ts = 
+00017c80: 7365 6c66 2e74 6173 6b73 5b6b 6579 5d0a  self.tasks[key].
+00017c90: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+00017ca0: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
+00017cb0: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
+00017cc0: 7420 7365 6c66 2e69 646c 655f 7461 736b  t self.idle_task
+00017cd0: 5f63 6f75 6e74 2c20 2874 732c 2073 656c  _count, (ts, sel
+00017ce0: 662e 6964 6c65 5f74 6173 6b5f 636f 756e  f.idle_task_coun
+00017cf0: 7429 0a20 2020 2020 2020 2020 2020 2073  t).            s
+00017d00: 656c 662e 5f76 616c 6964 6174 655f 7265  elf._validate_re
+00017d10: 6164 7928 7473 290a 0a20 2020 2020 2020  ady(ts)..       
+00017d20: 2074 732e 7374 6174 6520 3d20 2271 7565   ts.state = "que
+00017d30: 7565 6422 0a20 2020 2020 2020 2073 656c  ued".        sel
+00017d40: 662e 7175 6575 6564 2e61 6464 2874 7329  f.queued.add(ts)
+00017d50: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00017d60: 207b 7d2c 207b 7d2c 207b 7d0a 0a20 2020   {}, {}, {}..   
+00017d70: 2064 6566 205f 7472 616e 7369 7469 6f6e   def _transition
+00017d80: 5f77 6169 7469 6e67 5f6e 6f5f 776f 726b  _waiting_no_work
+00017d90: 6572 2873 656c 662c 206b 6579 3a20 4b65  er(self, key: Ke
+00017da0: 792c 2073 7469 6d75 6c75 735f 6964 3a20  y, stimulus_id: 
+00017db0: 7374 7229 202d 3e20 5265 6373 4d73 6773  str) -> RecsMsgs
+00017dc0: 3a0a 2020 2020 2020 2020 7473 203d 2073  :.        ts = s
+00017dd0: 656c 662e 7461 736b 735b 6b65 795d 0a0a  elf.tasks[key]..
+00017de0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00017df0: 7661 6c69 6461 7465 3a0a 2020 2020 2020  validate:.      
+00017e00: 2020 2020 2020 7365 6c66 2e5f 7661 6c69        self._vali
+00017e10: 6461 7465 5f72 6561 6479 2874 7329 0a0a  date_ready(ts)..
+00017e20: 2020 2020 2020 2020 7473 2e73 7461 7465          ts.state
+00017e30: 203d 2022 6e6f 2d77 6f72 6b65 7222 0a20   = "no-worker". 
+00017e40: 2020 2020 2020 2073 656c 662e 756e 7275         self.unru
+00017e50: 6e6e 6162 6c65 2e61 6464 2874 7329 0a0a  nnable.add(ts)..
+00017e60: 2020 2020 2020 2020 7265 7475 726e 207b          return {
+00017e70: 7d2c 207b 7d2c 207b 7d0a 0a20 2020 2064  }, {}, {}..    d
+00017e80: 6566 205f 7472 616e 7369 7469 6f6e 5f71  ef _transition_q
+00017e90: 7565 7565 645f 7265 6c65 6173 6564 2873  ueued_released(s
+00017ea0: 656c 662c 206b 6579 3a20 4b65 792c 2073  elf, key: Key, s
+00017eb0: 7469 6d75 6c75 735f 6964 3a20 7374 7229  timulus_id: str)
+00017ec0: 202d 3e20 5265 6373 4d73 6773 3a0a 2020   -> RecsMsgs:.  
+00017ed0: 2020 2020 2020 7473 203d 2073 656c 662e        ts = self.
+00017ee0: 7461 736b 735b 6b65 795d 0a0a 2020 2020  tasks[key]..    
+00017ef0: 2020 2020 6966 2073 656c 662e 7661 6c69      if self.vali
+00017f00: 6461 7465 3a0a 2020 2020 2020 2020 2020  date:.          
+00017f10: 2020 6173 7365 7274 2074 7320 696e 2073    assert ts in s
+00017f20: 656c 662e 7175 6575 6564 0a20 2020 2020  elf.queued.     
+00017f30: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
+00017f40: 7420 7473 2e70 726f 6365 7373 696e 675f  t ts.processing_
+00017f50: 6f6e 0a0a 2020 2020 2020 2020 7365 6c66  on..        self
+00017f60: 2e71 7565 7565 642e 7265 6d6f 7665 2874  .queued.remove(t
+00017f70: 7329 0a0a 2020 2020 2020 2020 7265 636f  s)..        reco
+00017f80: 6d6d 656e 6461 7469 6f6e 733a 2052 6563  mmendations: Rec
+00017f90: 7320 3d20 7b7d 0a20 2020 2020 2020 2073  s = {}.        s
+00017fa0: 656c 662e 5f70 726f 7061 6761 7465 5f72  elf._propagate_r
+00017fb0: 656c 6561 7365 6428 7473 2c20 7265 636f  eleased(ts, reco
+00017fc0: 6d6d 656e 6461 7469 6f6e 7329 0a20 2020  mmendations).   
+00017fd0: 2020 2020 2072 6574 7572 6e20 7265 636f       return reco
+00017fe0: 6d6d 656e 6461 7469 6f6e 732c 207b 7d2c  mmendations, {},
+00017ff0: 207b 7d0a 0a20 2020 2064 6566 205f 7472   {}..    def _tr
+00018000: 616e 7369 7469 6f6e 5f71 7565 7565 645f  ansition_queued_
+00018010: 7072 6f63 6573 7369 6e67 2873 656c 662c  processing(self,
+00018020: 206b 6579 3a20 4b65 792c 2073 7469 6d75   key: Key, stimu
+00018030: 6c75 735f 6964 3a20 7374 7229 202d 3e20  lus_id: str) -> 
+00018040: 5265 6373 4d73 6773 3a0a 2020 2020 2020  RecsMsgs:.      
+00018050: 2020 7473 203d 2073 656c 662e 7461 736b    ts = self.task
+00018060: 735b 6b65 795d 0a0a 2020 2020 2020 2020  s[key]..        
+00018070: 6966 2073 656c 662e 7661 6c69 6461 7465  if self.validate
+00018080: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
+00018090: 7365 7274 206e 6f74 2074 732e 6163 746f  sert not ts.acto
+000180a0: 722c 2066 2241 6374 6f72 7320 6361 6e27  r, f"Actors can'
+000180b0: 7420 6265 2071 7565 7565 643a 207b 7473  t be queued: {ts
+000180c0: 7d22 0a20 2020 2020 2020 2020 2020 2061  }".            a
+000180d0: 7373 6572 7420 7473 2069 6e20 7365 6c66  ssert ts in self
+000180e0: 2e71 7565 7565 640a 0a20 2020 2020 2020  .queued..       
+000180f0: 2069 6620 7773 203a 3d20 7365 6c66 2e64   if ws := self.d
+00018100: 6563 6964 655f 776f 726b 6572 5f72 6f6f  ecide_worker_roo
+00018110: 7469 7368 5f71 7565 7569 6e67 5f65 6e61  tish_queuing_ena
+00018120: 626c 6564 2829 3a0a 2020 2020 2020 2020  bled():.        
+00018130: 2020 2020 7365 6c66 2e71 7565 7565 642e      self.queued.
+00018140: 6469 7363 6172 6428 7473 290a 2020 2020  discard(ts).    
+00018150: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00018160: 656c 662e 5f61 6464 5f74 6f5f 7072 6f63  elf._add_to_proc
+00018170: 6573 7369 6e67 2874 732c 2077 732c 2073  essing(ts, ws, s
+00018180: 7469 6d75 6c75 735f 6964 3d73 7469 6d75  timulus_id=stimu
+00018190: 6c75 735f 6964 290a 2020 2020 2020 2020  lus_id).        
+000181a0: 2320 4966 206e 6f20 776f 726b 6572 2c20  # If no worker, 
+000181b0: 7461 736b 206a 7573 7420 7374 6179 7320  task just stays 
+000181c0: 6071 7565 7565 6460 0a20 2020 2020 2020  `queued`.       
+000181d0: 2072 6574 7572 6e20 7b7d 2c20 7b7d 2c20   return {}, {}, 
+000181e0: 7b7d 0a0a 2020 2020 6465 6620 5f72 656d  {}..    def _rem
+000181f0: 6f76 655f 6b65 7928 7365 6c66 2c20 6b65  ove_key(self, ke
+00018200: 793a 204b 6579 2920 2d3e 204e 6f6e 653a  y: Key) -> None:
+00018210: 0a20 2020 2020 2020 2074 7320 3d20 7365  .        ts = se
+00018220: 6c66 2e74 6173 6b73 2e70 6f70 286b 6579  lf.tasks.pop(key
+00018230: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
+00018240: 2074 732e 7374 6174 6520 3d3d 2022 666f   ts.state == "fo
+00018250: 7267 6f74 7465 6e22 0a20 2020 2020 2020  rgotten".       
+00018260: 2073 656c 662e 756e 7275 6e6e 6162 6c65   self.unrunnable
+00018270: 2e64 6973 6361 7264 2874 7329 0a20 2020  .discard(ts).   
+00018280: 2020 2020 2066 6f72 2063 7320 696e 2074       for cs in t
+00018290: 732e 7768 6f5f 7761 6e74 7320 6f72 2028  s.who_wants or (
+000182a0: 293a 0a20 2020 2020 2020 2020 2020 2063  ):.            c
+000182b0: 732e 7761 6e74 735f 7768 6174 2e72 656d  s.wants_what.rem
+000182c0: 6f76 6528 7473 290a 2020 2020 2020 2020  ove(ts).        
+000182d0: 7473 2e77 686f 5f77 616e 7473 203d 204e  ts.who_wants = N
+000182e0: 6f6e 650a 2020 2020 2020 2020 7473 2e70  one.        ts.p
+000182f0: 726f 6365 7373 696e 675f 6f6e 203d 204e  rocessing_on = N
+00018300: 6f6e 650a 2020 2020 2020 2020 7473 2e65  one.        ts.e
+00018310: 7863 6570 7469 6f6e 5f62 6c61 6d65 203d  xception_blame =
+00018320: 2074 732e 6578 6365 7074 696f 6e20 3d20   ts.exception = 
+00018330: 7473 2e74 7261 6365 6261 636b 203d 204e  ts.traceback = N
+00018340: 6f6e 650a 2020 2020 2020 2020 7365 6c66  one.        self
+00018350: 2e74 6173 6b5f 6d65 7461 6461 7461 2e70  .task_metadata.p
+00018360: 6f70 286b 6579 2c20 4e6f 6e65 290a 0a20  op(key, None).. 
+00018370: 2020 2064 6566 205f 7472 616e 7369 7469     def _transiti
+00018380: 6f6e 5f6d 656d 6f72 795f 666f 7267 6f74  on_memory_forgot
+00018390: 7465 6e28 7365 6c66 2c20 6b65 793a 204b  ten(self, key: K
+000183a0: 6579 2c20 7374 696d 756c 7573 5f69 643a  ey, stimulus_id:
+000183b0: 2073 7472 2920 2d3e 2052 6563 734d 7367   str) -> RecsMsg
+000183c0: 733a 0a20 2020 2020 2020 2074 7320 3d20  s:.        ts = 
+000183d0: 7365 6c66 2e74 6173 6b73 5b6b 6579 5d0a  self.tasks[key].
+000183e0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+000183f0: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
+00018400: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
+00018410: 2e73 7461 7465 203d 3d20 226d 656d 6f72  .state == "memor
+00018420: 7922 0a20 2020 2020 2020 2020 2020 2061  y".            a
+00018430: 7373 6572 7420 6e6f 7420 7473 2e70 726f  ssert not ts.pro
+00018440: 6365 7373 696e 675f 6f6e 0a20 2020 2020  cessing_on.     
+00018450: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
+00018460: 7420 7473 2e77 6169 7469 6e67 5f6f 6e0a  t ts.waiting_on.
+00018470: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+00018480: 6f74 2074 732e 7275 6e5f 7370 6563 3a0a  ot ts.run_spec:.
+00018490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000184a0: 2320 4974 2773 206f 6b20 746f 2066 6f72  # It's ok to for
+000184b0: 6765 7420 6120 7075 7265 2064 6174 6120  get a pure data 
+000184c0: 7461 736b 0a20 2020 2020 2020 2020 2020  task.           
+000184d0: 2020 2020 2070 6173 730a 2020 2020 2020       pass.      
+000184e0: 2020 2020 2020 656c 6966 2074 732e 6861        elif ts.ha
+000184f0: 735f 6c6f 7374 5f64 6570 656e 6465 6e63  s_lost_dependenc
+00018500: 6965 733a 0a20 2020 2020 2020 2020 2020  ies:.           
+00018510: 2020 2020 2023 2049 7427 7320 6f6b 2074       # It's ok t
+00018520: 6f20 666f 7267 6574 2061 2074 6173 6b20  o forget a task 
+00018530: 7769 7468 2066 6f72 676f 7474 656e 2064  with forgotten d
+00018540: 6570 656e 6465 6e63 6965 730a 2020 2020  ependencies.    
+00018550: 2020 2020 2020 2020 2020 2020 7061 7373              pass
+00018560: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+00018570: 6620 6e6f 7420 7473 2e77 686f 5f77 616e  f not ts.who_wan
+00018580: 7473 2061 6e64 206e 6f74 2074 732e 7761  ts and not ts.wa
+00018590: 6974 6572 7320 616e 6420 6e6f 7420 7473  iters and not ts
+000185a0: 2e64 6570 656e 6465 6e74 733a 0a20 2020  .dependents:.   
+000185b0: 2020 2020 2020 2020 2020 2020 2023 2049               # I
+000185c0: 7427 7320 6f6b 2074 6f20 666f 7267 6574  t's ok to forget
+000185d0: 2061 2074 6173 6b20 7468 6174 206e 6f62   a task that nob
+000185e0: 6f64 7920 6e65 6564 730a 2020 2020 2020  ody needs.      
+000185f0: 2020 2020 2020 2020 2020 7061 7373 0a20            pass. 
+00018600: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00018610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018620: 2072 6169 7365 2041 7373 6572 7469 6f6e   raise Assertion
+00018630: 4572 726f 7228 2255 6e72 6561 6368 6162  Error("Unreachab
+00018640: 6c65 222c 2073 7472 2874 7329 2920 2023  le", str(ts))  #
+00018650: 2070 7261 676d 613a 206e 6f63 6f76 6572   pragma: nocover
+00018660: 0a0a 2020 2020 2020 2020 6966 2074 732e  ..        if ts.
+00018670: 6163 746f 723a 0a20 2020 2020 2020 2020  actor:.         
+00018680: 2020 2066 6f72 2077 7320 696e 2074 732e     for ws in ts.
+00018690: 7768 6f5f 6861 7320 6f72 2028 293a 0a20  who_has or ():. 
+000186a0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+000186b0: 732e 6163 746f 7273 2e64 6973 6361 7264  s.actors.discard
+000186c0: 2874 7329 0a0a 2020 2020 2020 2020 7265  (ts)..        re
+000186d0: 636f 6d6d 656e 6461 7469 6f6e 733a 2052  commendations: R
+000186e0: 6563 7320 3d20 7b7d 0a20 2020 2020 2020  ecs = {}.       
+000186f0: 2077 6f72 6b65 725f 6d73 6773 3a20 4d73   worker_msgs: Ms
+00018700: 6773 203d 207b 7d0a 2020 2020 2020 2020  gs = {}.        
+00018710: 7365 6c66 2e5f 7072 6f70 6167 6174 655f  self._propagate_
+00018720: 666f 7267 6f74 7465 6e28 7473 2c20 7265  forgotten(ts, re
+00018730: 636f 6d6d 656e 6461 7469 6f6e 732c 2077  commendations, w
+00018740: 6f72 6b65 725f 6d73 6773 2c20 7374 696d  orker_msgs, stim
+00018750: 756c 7573 5f69 6429 0a0a 2020 2020 2020  ulus_id)..      
+00018760: 2020 636c 6965 6e74 5f6d 7367 7320 3d20    client_msgs = 
+00018770: 5f74 6173 6b5f 746f 5f63 6c69 656e 745f  _task_to_client_
+00018780: 6d73 6773 2874 7329 0a20 2020 2020 2020  msgs(ts).       
+00018790: 2073 656c 662e 5f72 656d 6f76 655f 6b65   self._remove_ke
+000187a0: 7928 6b65 7929 0a0a 2020 2020 2020 2020  y(key)..        
+000187b0: 7265 7475 726e 2072 6563 6f6d 6d65 6e64  return recommend
+000187c0: 6174 696f 6e73 2c20 636c 6965 6e74 5f6d  ations, client_m
+000187d0: 7367 732c 2077 6f72 6b65 725f 6d73 6773  sgs, worker_msgs
+000187e0: 0a0a 2020 2020 6465 6620 5f74 7261 6e73  ..    def _trans
+000187f0: 6974 696f 6e5f 7265 6c65 6173 6564 5f66  ition_released_f
+00018800: 6f72 676f 7474 656e 2873 656c 662c 206b  orgotten(self, k
+00018810: 6579 3a20 4b65 792c 2073 7469 6d75 6c75  ey: Key, stimulu
+00018820: 735f 6964 3a20 7374 7229 202d 3e20 5265  s_id: str) -> Re
+00018830: 6373 4d73 6773 3a0a 2020 2020 2020 2020  csMsgs:.        
+00018840: 7473 203d 2073 656c 662e 7461 736b 735b  ts = self.tasks[
+00018850: 6b65 795d 0a0a 2020 2020 2020 2020 6966  key]..        if
+00018860: 2073 656c 662e 7661 6c69 6461 7465 3a0a   self.validate:.
+00018870: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00018880: 7274 2074 732e 7374 6174 6520 696e 2028  rt ts.state in (
+00018890: 2272 656c 6561 7365 6422 2c20 2265 7272  "released", "err
+000188a0: 6564 2229 0a20 2020 2020 2020 2020 2020  ed").           
+000188b0: 2061 7373 6572 7420 6e6f 7420 7473 2e77   assert not ts.w
+000188c0: 686f 5f68 6173 0a20 2020 2020 2020 2020  ho_has.         
+000188d0: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
+000188e0: 2e70 726f 6365 7373 696e 675f 6f6e 0a20  .processing_on. 
+000188f0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00018900: 7420 7473 206e 6f74 2069 6e20 7365 6c66  t ts not in self
+00018910: 2e71 7565 7565 640a 2020 2020 2020 2020  .queued.        
+00018920: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
+00018930: 732e 7761 6974 696e 675f 6f6e 2c20 2874  s.waiting_on, (t
+00018940: 732c 2074 732e 7761 6974 696e 675f 6f6e  s, ts.waiting_on
+00018950: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+00018960: 206e 6f74 2074 732e 7275 6e5f 7370 6563   not ts.run_spec
+00018970: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00018980: 2020 2320 4974 2773 206f 6b20 746f 2066    # It's ok to f
+00018990: 6f72 6765 7420 6120 7075 7265 2064 6174  orget a pure dat
+000189a0: 6120 7461 736b 0a20 2020 2020 2020 2020  a task.         
+000189b0: 2020 2020 2020 2070 6173 730a 2020 2020         pass.    
+000189c0: 2020 2020 2020 2020 656c 6966 2074 732e          elif ts.
+000189d0: 6861 735f 6c6f 7374 5f64 6570 656e 6465  has_lost_depende
+000189e0: 6e63 6965 733a 0a20 2020 2020 2020 2020  ncies:.         
+000189f0: 2020 2020 2020 2023 2049 7427 7320 6f6b         # It's ok
+00018a00: 2074 6f20 666f 7267 6574 2061 2074 6173   to forget a tas
+00018a10: 6b20 7769 7468 2066 6f72 676f 7474 656e  k with forgotten
+00018a20: 2064 6570 656e 6465 6e63 6965 730a 2020   dependencies.  
+00018a30: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+00018a40: 7373 0a20 2020 2020 2020 2020 2020 2065  ss.            e
+00018a50: 6c69 6620 6e6f 7420 7473 2e77 686f 5f77  lif not ts.who_w
+00018a60: 616e 7473 2061 6e64 206e 6f74 2074 732e  ants and not ts.
+00018a70: 7761 6974 6572 7320 616e 6420 6e6f 7420  waiters and not 
+00018a80: 7473 2e64 6570 656e 6465 6e74 733a 0a20  ts.dependents:. 
+00018a90: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00018aa0: 2049 7427 7320 6f6b 2074 6f20 666f 7267   It's ok to forg
+00018ab0: 6574 2061 2074 6173 6b20 7468 6174 206e  et a task that n
+00018ac0: 6f62 6f64 7920 6e65 6564 730a 2020 2020  obody needs.    
+00018ad0: 2020 2020 2020 2020 2020 2020 7061 7373              pass
+00018ae0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00018af0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00018b00: 2020 2072 6169 7365 2041 7373 6572 7469     raise Asserti
+00018b10: 6f6e 4572 726f 7228 2255 6e72 6561 6368  onError("Unreach
+00018b20: 6162 6c65 222c 2073 7472 2874 7329 2920  able", str(ts)) 
+00018b30: 2023 2070 7261 676d 613a 206e 6f63 6f76   # pragma: nocov
+00018b40: 6572 0a0a 2020 2020 2020 2020 7265 636f  er..        reco
+00018b50: 6d6d 656e 6461 7469 6f6e 733a 2052 6563  mmendations: Rec
+00018b60: 7320 3d20 7b7d 0a20 2020 2020 2020 2077  s = {}.        w
+00018b70: 6f72 6b65 725f 6d73 6773 3a20 4d73 6773  orker_msgs: Msgs
+00018b80: 203d 207b 7d0a 2020 2020 2020 2020 7365   = {}.        se
+00018b90: 6c66 2e5f 7072 6f70 6167 6174 655f 666f  lf._propagate_fo
+00018ba0: 7267 6f74 7465 6e28 7473 2c20 7265 636f  rgotten(ts, reco
+00018bb0: 6d6d 656e 6461 7469 6f6e 732c 2077 6f72  mmendations, wor
+00018bc0: 6b65 725f 6d73 6773 2c20 7374 696d 756c  ker_msgs, stimul
+00018bd0: 7573 5f69 6429 0a0a 2020 2020 2020 2020  us_id)..        
+00018be0: 636c 6965 6e74 5f6d 7367 7320 3d20 5f74  client_msgs = _t
+00018bf0: 6173 6b5f 746f 5f63 6c69 656e 745f 6d73  ask_to_client_ms
+00018c00: 6773 2874 7329 0a20 2020 2020 2020 2073  gs(ts).        s
+00018c10: 656c 662e 5f72 656d 6f76 655f 6b65 7928  elf._remove_key(
+00018c20: 6b65 7929 0a0a 2020 2020 2020 2020 7265  key)..        re
+00018c30: 7475 726e 2072 6563 6f6d 6d65 6e64 6174  turn recommendat
+00018c40: 696f 6e73 2c20 636c 6965 6e74 5f6d 7367  ions, client_msg
+00018c50: 732c 2077 6f72 6b65 725f 6d73 6773 0a0a  s, worker_msgs..
+00018c60: 2020 2020 2320 7b0a 2020 2020 2320 2020      # {.    #   
+00018c70: 2020 2873 7461 7274 2c20 6669 6e69 7368    (start, finish
+00018c80: 293a 0a20 2020 2023 2020 2020 2074 7261  ):.    #     tra
+00018c90: 6e73 6974 696f 6e5f 3c73 7461 7274 3e5f  nsition_<start>_
+00018ca0: 3c66 696e 6973 683e 280a 2020 2020 2320  <finish>(.    # 
+00018cb0: 2020 2020 2020 2020 7365 6c66 2c20 6b65          self, ke
+00018cc0: 793a 204b 6579 2c20 7374 696d 756c 7573  y: Key, stimulus
+00018cd0: 5f69 643a 2073 7472 2c20 2a2a 6b77 6172  _id: str, **kwar
+00018ce0: 6773 0a20 2020 2023 2020 2020 2029 202d  gs.    #     ) -
+00018cf0: 3e20 2872 6563 6f6d 6d65 6e64 6174 696f  > (recommendatio
+00018d00: 6e73 2c20 636c 6965 6e74 5f6d 7367 732c  ns, client_msgs,
+00018d10: 2077 6f72 6b65 725f 6d73 6773 290a 2020   worker_msgs).  
+00018d20: 2020 2320 7d0a 2020 2020 5f54 5241 4e53    # }.    _TRANS
+00018d30: 4954 494f 4e53 5f54 4142 4c45 3a20 436c  ITIONS_TABLE: Cl
+00018d40: 6173 7356 6172 5b0a 2020 2020 2020 2020  assVar[.        
+00018d50: 4d61 7070 696e 675b 0a20 2020 2020 2020  Mapping[.       
+00018d60: 2020 2020 2074 7570 6c65 5b54 6173 6b53       tuple[TaskS
+00018d70: 7461 7465 5374 6174 652c 2054 6173 6b53  tateState, TaskS
+00018d80: 7461 7465 5374 6174 655d 2c0a 2020 2020  tateState],.    
+00018d90: 2020 2020 2020 2020 4361 6c6c 6162 6c65          Callable
+00018da0: 5b2e 2e2e 2c20 5265 6373 4d73 6773 5d2c  [..., RecsMsgs],
+00018db0: 0a20 2020 2020 2020 205d 0a20 2020 205d  .        ].    ]
+00018dc0: 203d 207b 0a20 2020 2020 2020 2028 2272   = {.        ("r
+00018dd0: 656c 6561 7365 6422 2c20 2277 6169 7469  eleased", "waiti
+00018de0: 6e67 2229 3a20 5f74 7261 6e73 6974 696f  ng"): _transitio
+00018df0: 6e5f 7265 6c65 6173 6564 5f77 6169 7469  n_released_waiti
+00018e00: 6e67 2c0a 2020 2020 2020 2020 2822 7761  ng,.        ("wa
+00018e10: 6974 696e 6722 2c20 2272 656c 6561 7365  iting", "release
+00018e20: 6422 293a 205f 7472 616e 7369 7469 6f6e  d"): _transition
+00018e30: 5f77 6169 7469 6e67 5f72 656c 6561 7365  _waiting_release
+00018e40: 642c 0a20 2020 2020 2020 2028 2277 6169  d,.        ("wai
+00018e50: 7469 6e67 222c 2022 7072 6f63 6573 7369  ting", "processi
+00018e60: 6e67 2229 3a20 5f74 7261 6e73 6974 696f  ng"): _transitio
+00018e70: 6e5f 7761 6974 696e 675f 7072 6f63 6573  n_waiting_proces
+00018e80: 7369 6e67 2c0a 2020 2020 2020 2020 2822  sing,.        ("
+00018e90: 7761 6974 696e 6722 2c20 226e 6f2d 776f  waiting", "no-wo
+00018ea0: 726b 6572 2229 3a20 5f74 7261 6e73 6974  rker"): _transit
+00018eb0: 696f 6e5f 7761 6974 696e 675f 6e6f 5f77  ion_waiting_no_w
+00018ec0: 6f72 6b65 722c 0a20 2020 2020 2020 2028  orker,.        (
+00018ed0: 2277 6169 7469 6e67 222c 2022 7175 6575  "waiting", "queu
+00018ee0: 6564 2229 3a20 5f74 7261 6e73 6974 696f  ed"): _transitio
+00018ef0: 6e5f 7761 6974 696e 675f 7175 6575 6564  n_waiting_queued
+00018f00: 2c0a 2020 2020 2020 2020 2822 7761 6974  ,.        ("wait
+00018f10: 696e 6722 2c20 226d 656d 6f72 7922 293a  ing", "memory"):
+00018f20: 205f 7472 616e 7369 7469 6f6e 5f77 6169   _transition_wai
+00018f30: 7469 6e67 5f6d 656d 6f72 792c 0a20 2020  ting_memory,.   
+00018f40: 2020 2020 2028 2271 7565 7565 6422 2c20       ("queued", 
+00018f50: 2272 656c 6561 7365 6422 293a 205f 7472  "released"): _tr
+00018f60: 616e 7369 7469 6f6e 5f71 7565 7565 645f  ansition_queued_
+00018f70: 7265 6c65 6173 6564 2c0a 2020 2020 2020  released,.      
+00018f80: 2020 2822 7175 6575 6564 222c 2022 7072    ("queued", "pr
+00018f90: 6f63 6573 7369 6e67 2229 3a20 5f74 7261  ocessing"): _tra
+00018fa0: 6e73 6974 696f 6e5f 7175 6575 6564 5f70  nsition_queued_p
+00018fb0: 726f 6365 7373 696e 672c 0a20 2020 2020  rocessing,.     
+00018fc0: 2020 2028 2270 726f 6365 7373 696e 6722     ("processing"
+00018fd0: 2c20 2272 656c 6561 7365 6422 293a 205f  , "released"): _
+00018fe0: 7472 616e 7369 7469 6f6e 5f70 726f 6365  transition_proce
+00018ff0: 7373 696e 675f 7265 6c65 6173 6564 2c0a  ssing_released,.
+00019000: 2020 2020 2020 2020 2822 7072 6f63 6573          ("proces
+00019010: 7369 6e67 222c 2022 6d65 6d6f 7279 2229  sing", "memory")
+00019020: 3a20 5f74 7261 6e73 6974 696f 6e5f 7072  : _transition_pr
+00019030: 6f63 6573 7369 6e67 5f6d 656d 6f72 792c  ocessing_memory,
+00019040: 0a20 2020 2020 2020 2028 2270 726f 6365  .        ("proce
+00019050: 7373 696e 6722 2c20 2265 7272 6564 2229  ssing", "erred")
+00019060: 3a20 5f74 7261 6e73 6974 696f 6e5f 7072  : _transition_pr
+00019070: 6f63 6573 7369 6e67 5f65 7272 6564 2c0a  ocessing_erred,.
+00019080: 2020 2020 2020 2020 2822 6e6f 2d77 6f72          ("no-wor
+00019090: 6b65 7222 2c20 2272 656c 6561 7365 6422  ker", "released"
+000190a0: 293a 205f 7472 616e 7369 7469 6f6e 5f6e  ): _transition_n
+000190b0: 6f5f 776f 726b 6572 5f72 656c 6561 7365  o_worker_release
+000190c0: 642c 0a20 2020 2020 2020 2028 226e 6f2d  d,.        ("no-
+000190d0: 776f 726b 6572 222c 2022 7072 6f63 6573  worker", "proces
+000190e0: 7369 6e67 2229 3a20 5f74 7261 6e73 6974  sing"): _transit
+000190f0: 696f 6e5f 6e6f 5f77 6f72 6b65 725f 7072  ion_no_worker_pr
+00019100: 6f63 6573 7369 6e67 2c0a 2020 2020 2020  ocessing,.      
+00019110: 2020 2822 7265 6c65 6173 6564 222c 2022    ("released", "
+00019120: 666f 7267 6f74 7465 6e22 293a 205f 7472  forgotten"): _tr
+00019130: 616e 7369 7469 6f6e 5f72 656c 6561 7365  ansition_release
+00019140: 645f 666f 7267 6f74 7465 6e2c 0a20 2020  d_forgotten,.   
+00019150: 2020 2020 2028 226d 656d 6f72 7922 2c20       ("memory", 
+00019160: 2266 6f72 676f 7474 656e 2229 3a20 5f74  "forgotten"): _t
+00019170: 7261 6e73 6974 696f 6e5f 6d65 6d6f 7279  ransition_memory
+00019180: 5f66 6f72 676f 7474 656e 2c0a 2020 2020  _forgotten,.    
+00019190: 2020 2020 2822 6572 7265 6422 2c20 2272      ("erred", "r
+000191a0: 656c 6561 7365 6422 293a 205f 7472 616e  eleased"): _tran
+000191b0: 7369 7469 6f6e 5f65 7272 6564 5f72 656c  sition_erred_rel
+000191c0: 6561 7365 642c 0a20 2020 2020 2020 2028  eased,.        (
+000191d0: 226d 656d 6f72 7922 2c20 2272 656c 6561  "memory", "relea
+000191e0: 7365 6422 293a 205f 7472 616e 7369 7469  sed"): _transiti
+000191f0: 6f6e 5f6d 656d 6f72 795f 7265 6c65 6173  on_memory_releas
+00019200: 6564 2c0a 2020 2020 2020 2020 2822 7265  ed,.        ("re
+00019210: 6c65 6173 6564 222c 2022 6572 7265 6422  leased", "erred"
+00019220: 293a 205f 7472 616e 7369 7469 6f6e 5f72  ): _transition_r
+00019230: 656c 6561 7365 645f 6572 7265 642c 0a20  eleased_erred,. 
+00019240: 2020 207d 0a0a 2020 2020 6465 6620 7374     }..    def st
+00019250: 6f72 7928 0a20 2020 2020 2020 2073 656c  ory(.        sel
+00019260: 662c 202a 6b65 7973 5f6f 725f 7461 736b  f, *keys_or_task
+00019270: 735f 6f72 5f73 7469 6d75 6c69 3a20 4b65  s_or_stimuli: Ke
+00019280: 7920 7c20 5461 736b 5374 6174 6520 7c20  y | TaskState | 
+00019290: 7374 720a 2020 2020 2920 2d3e 206c 6973  str.    ) -> lis
+000192a0: 745b 5472 616e 7369 7469 6f6e 5d3a 0a20  t[Transition]:. 
+000192b0: 2020 2020 2020 2022 2222 4765 7420 616c         """Get al
+000192c0: 6c20 7472 616e 7369 7469 6f6e 7320 7468  l transitions th
+000192d0: 6174 2074 6f75 6368 206f 6e65 206f 6620  at touch one of 
+000192e0: 7468 6520 696e 7075 7420 6b65 7973 206f  the input keys o
+000192f0: 7220 7374 696d 756c 7573 5f69 6427 7322  r stimulus_id's"
+00019300: 2222 0a20 2020 2020 2020 206b 6579 735f  "".        keys_
+00019310: 6f72 5f73 7469 6d75 6c69 203d 207b 0a20  or_stimuli = {. 
+00019320: 2020 2020 2020 2020 2020 206b 6579 2e6b             key.k
+00019330: 6579 2069 6620 6973 696e 7374 616e 6365  ey if isinstance
+00019340: 286b 6579 2c20 5461 736b 5374 6174 6529  (key, TaskState)
+00019350: 2065 6c73 6520 6b65 790a 2020 2020 2020   else key.      
+00019360: 2020 2020 2020 666f 7220 6b65 7920 696e        for key in
+00019370: 206b 6579 735f 6f72 5f74 6173 6b73 5f6f   keys_or_tasks_o
+00019380: 725f 7374 696d 756c 690a 2020 2020 2020  r_stimuli.      
+00019390: 2020 7d0a 2020 2020 2020 2020 7265 7475    }.        retu
+000193a0: 726e 2073 6368 6564 756c 6572 5f73 746f  rn scheduler_sto
+000193b0: 7279 286b 6579 735f 6f72 5f73 7469 6d75  ry(keys_or_stimu
+000193c0: 6c69 2c20 7365 6c66 2e74 7261 6e73 6974  li, self.transit
+000193d0: 696f 6e5f 6c6f 6729 0a0a 2020 2020 2323  ion_log)..    ##
+000193e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000193f0: 2323 2323 2323 2323 2323 2323 0a20 2020  ############.   
+00019400: 2023 2041 7373 6967 6e69 6e67 2054 6173   # Assigning Tas
+00019410: 6b73 2074 6f20 576f 726b 6572 7320 230a  ks to Workers #.
+00019420: 2020 2020 2323 2323 2323 2323 2323 2323      ############
+00019430: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00019440: 2323 0a0a 2020 2020 6465 6620 6973 5f72  ##..    def is_r
+00019450: 6f6f 7469 7368 2873 656c 662c 2074 733a  ootish(self, ts:
+00019460: 2054 6173 6b53 7461 7465 2920 2d3e 2062   TaskState) -> b
+00019470: 6f6f 6c3a 0a20 2020 2020 2020 2022 2222  ool:.        """
+00019480: 0a20 2020 2020 2020 2057 6865 7468 6572  .        Whether
+00019490: 2060 6074 7360 6020 6973 2061 2072 6f6f   ``ts`` is a roo
+000194a0: 7420 6f72 2072 6f6f 742d 6c69 6b65 2074  t or root-like t
+000194b0: 6173 6b2e 0a0a 2020 2020 2020 2020 526f  ask...        Ro
+000194c0: 6f74 2d69 7368 2074 6173 6b73 2061 7265  ot-ish tasks are
+000194d0: 2070 6172 7420 6f66 2061 2067 726f 7570   part of a group
+000194e0: 2074 6861 7427 7320 6d75 6368 206c 6172   that's much lar
+000194f0: 6765 7220 7468 616e 2074 6865 2063 6c75  ger than the clu
+00019500: 7374 6572 2c0a 2020 2020 2020 2020 616e  ster,.        an
+00019510: 6420 6861 7665 2066 6577 206f 7220 6e6f  d have few or no
+00019520: 2064 6570 656e 6465 6e63 6965 732e 2054   dependencies. T
+00019530: 6173 6b73 206d 6179 2061 6c73 6f20 6265  asks may also be
+00019540: 2065 7870 6c69 6369 746c 7920 6d61 726b   explicitly mark
+00019550: 6564 2061 7320 726f 6f74 6973 680a 2020  ed as rootish.  
+00019560: 2020 2020 2020 746f 206f 7665 7272 6964        to overrid
+00019570: 6520 7468 6973 2068 6575 7269 7374 6963  e this heuristic
+00019580: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+00019590: 2020 2020 2020 6966 2074 732e 5f72 6f6f        if ts._roo
+000195a0: 7469 7368 2069 7320 6e6f 7420 4e6f 6e65  tish is not None
+000195b0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+000195c0: 7475 726e 2074 732e 5f72 6f6f 7469 7368  turn ts._rootish
+000195d0: 0a20 2020 2020 2020 2069 6620 7473 2e72  .        if ts.r
+000195e0: 6573 6f75 7263 655f 7265 7374 7269 6374  esource_restrict
+000195f0: 696f 6e73 206f 7220 7473 2e77 6f72 6b65  ions or ts.worke
+00019600: 725f 7265 7374 7269 6374 696f 6e73 206f  r_restrictions o
+00019610: 7220 7473 2e68 6f73 745f 7265 7374 7269  r ts.host_restri
+00019620: 6374 696f 6e73 3a0a 2020 2020 2020 2020  ctions:.        
+00019630: 2020 2020 7265 7475 726e 2046 616c 7365      return False
+00019640: 0a20 2020 2020 2020 2074 6720 3d20 7473  .        tg = ts
+00019650: 2e67 726f 7570 0a20 2020 2020 2020 2023  .group.        #
+00019660: 2054 4f44 4f20 7368 6f72 742d 6369 7263   TODO short-circ
+00019670: 7569 7420 746f 2054 7275 6520 6966 2060  uit to True if `
+00019680: 6e6f 7420 7473 2e64 6570 656e 6465 6e63  not ts.dependenc
+00019690: 6965 7360 3f0a 2020 2020 2020 2020 7265  ies`?.        re
+000196a0: 7475 726e 2028 0a20 2020 2020 2020 2020  turn (.         
+000196b0: 2020 206c 656e 2874 6729 203e 2073 656c     len(tg) > sel
+000196c0: 662e 746f 7461 6c5f 6e74 6872 6561 6473  f.total_nthreads
+000196d0: 202a 2032 0a20 2020 2020 2020 2020 2020   * 2.           
+000196e0: 2061 6e64 206c 656e 2874 672e 6465 7065   and len(tg.depe
+000196f0: 6e64 656e 6369 6573 2920 3c20 350a 2020  ndencies) < 5.  
+00019700: 2020 2020 2020 2020 2020 616e 6420 7375            and su
+00019710: 6d28 6d61 7028 6c65 6e2c 2074 672e 6465  m(map(len, tg.de
+00019720: 7065 6e64 656e 6369 6573 2929 203c 2035  pendencies)) < 5
+00019730: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+00019740: 6465 6620 6368 6563 6b5f 6964 6c65 5f73  def check_idle_s
+00019750: 6174 7572 6174 6564 2873 656c 662c 2077  aturated(self, w
+00019760: 733a 2057 6f72 6b65 7253 7461 7465 2c20  s: WorkerState, 
+00019770: 6f63 633a 2066 6c6f 6174 203d 202d 312e  occ: float = -1.
+00019780: 3029 202d 3e20 4e6f 6e65 3a0a 2020 2020  0) -> None:.    
+00019790: 2020 2020 2222 2255 7064 6174 6520 7468      """Update th
+000197a0: 6520 7374 6174 7573 206f 6620 7468 6520  e status of the 
+000197b0: 6964 6c65 2061 6e64 2073 6174 7572 6174  idle and saturat
+000197c0: 6564 2073 7461 7465 0a0a 2020 2020 2020  ed state..      
+000197d0: 2020 5468 6520 7363 6865 6475 6c65 7220    The scheduler 
+000197e0: 6b65 6570 7320 7472 6163 6b20 6f66 2077  keeps track of w
+000197f0: 6f72 6b65 7273 2074 6861 7420 6172 6520  orkers that are 
+00019800: 2e2e 0a0a 2020 2020 2020 2020 2d20 2053  ....        -  S
+00019810: 6174 7572 6174 6564 3a20 6861 7665 2065  aturated: have e
+00019820: 6e6f 7567 6820 776f 726b 2074 6f20 7374  nough work to st
+00019830: 6179 2062 7573 790a 2020 2020 2020 2020  ay busy.        
+00019840: 2d20 2049 646c 653a 2064 6f20 6e6f 7420  -  Idle: do not 
+00019850: 6861 7665 2065 6e6f 7567 6820 776f 726b  have enough work
+00019860: 2074 6f20 7374 6179 2062 7573 790a 0a20   to stay busy.. 
+00019870: 2020 2020 2020 2054 6865 7920 6172 6520         They are 
+00019880: 636f 6e73 6964 6572 6564 2073 6174 7572  considered satur
+00019890: 6174 6564 2069 6620 7468 6579 2062 6f74  ated if they bot
+000198a0: 6820 6861 7665 2065 6e6f 7567 6820 7461  h have enough ta
+000198b0: 736b 7320 746f 206f 6363 7570 790a 2020  sks to occupy.  
+000198c0: 2020 2020 2020 616c 6c20 6f66 2074 6865        all of the
+000198d0: 6972 2074 6872 6561 6473 2c20 616e 6420  ir threads, and 
+000198e0: 6966 2074 6865 2065 7870 6563 7465 6420  if the expected 
+000198f0: 7275 6e74 696d 6520 6f66 2074 686f 7365  runtime of those
+00019900: 2074 6173 6b73 2069 730a 2020 2020 2020   tasks is.      
+00019910: 2020 6c61 7267 6520 656e 6f75 6768 2e0a    large enough..
+00019920: 0a20 2020 2020 2020 2049 6620 6060 6469  .        If ``di
+00019930: 7374 7269 6275 7465 642e 7363 6865 6475  stributed.schedu
+00019940: 6c65 722e 776f 726b 6572 2d73 6174 7572  ler.worker-satur
+00019950: 6174 696f 6e60 6020 6973 206e 6f74 2060  ation`` is not `
+00019960: 6069 6e66 6060 0a20 2020 2020 2020 2028  `inf``.        (
+00019970: 7363 6865 6475 6c65 722d 7369 6465 2071  scheduler-side q
+00019980: 7565 7569 6e67 2069 7320 656e 6162 6c65  ueuing is enable
+00019990: 6429 2c20 7468 6579 2061 7265 2063 6f6e  d), they are con
+000199a0: 7369 6465 7265 6420 6964 6c65 0a20 2020  sidered idle.   
+000199b0: 2020 2020 2069 6620 7468 6579 2068 6176       if they hav
+000199c0: 6520 6665 7765 7220 7461 736b 7320 7072  e fewer tasks pr
+000199d0: 6f63 6573 7369 6e67 2074 6861 6e20 7468  ocessing than th
+000199e0: 6520 6060 776f 726b 6572 2d73 6174 7572  e ``worker-satur
+000199f0: 6174 696f 6e60 600a 2020 2020 2020 2020  ation``.        
+00019a00: 7468 7265 7368 6f6c 6420 6469 6374 6174  threshold dictat
+00019a10: 6573 2e0a 0a20 2020 2020 2020 204f 7468  es...        Oth
+00019a20: 6572 7769 7365 2c20 7468 6579 2061 7265  erwise, they are
+00019a30: 2063 6f6e 7369 6465 7265 6420 6964 6c65   considered idle
+00019a40: 2069 6620 7468 6579 2068 6176 6520 6665   if they have fe
+00019a50: 7765 7220 7461 736b 7320 7072 6f63 6573  wer tasks proces
+00019a60: 7369 6e67 0a20 2020 2020 2020 2074 6861  sing.        tha
+00019a70: 6e20 7468 7265 6164 732c 206f 7220 6966  n threads, or if
+00019a80: 2074 6865 6972 2074 6173 6b73 2720 746f   their tasks' to
+00019a90: 7461 6c20 6578 7065 6374 6564 2072 756e  tal expected run
+00019aa0: 7469 6d65 2069 7320 6c65 7373 2074 6861  time is less tha
+00019ab0: 6e20 6861 6c66 0a20 2020 2020 2020 2074  n half.        t
+00019ac0: 6865 2065 7870 6563 7465 6420 7275 6e74  he expected runt
+00019ad0: 696d 6520 6f66 2074 6865 2073 616d 6520  ime of the same 
+00019ae0: 6e75 6d62 6572 206f 6620 6176 6572 6167  number of averag
+00019af0: 6520 7461 736b 732e 0a0a 2020 2020 2020  e tasks...      
+00019b00: 2020 5468 6973 2069 7320 7573 6566 756c    This is useful
+00019b10: 2066 6f72 206c 6f61 6420 6261 6c61 6e63   for load balanc
+00019b20: 696e 6720 616e 6420 6164 6170 7469 7669  ing and adaptivi
+00019b30: 7479 2e0a 2020 2020 2020 2020 2222 220a  ty..        """.
+00019b40: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00019b50: 746f 7461 6c5f 6e74 6872 6561 6473 203d  total_nthreads =
+00019b60: 3d20 3020 6f72 2077 732e 7374 6174 7573  = 0 or ws.status
+00019b70: 203d 3d20 5374 6174 7573 2e63 6c6f 7365   == Status.close
+00019b80: 643a 0a20 2020 2020 2020 2020 2020 2072  d:.            r
+00019b90: 6574 7572 6e0a 2020 2020 2020 2020 6966  eturn.        if
+00019ba0: 206f 6363 203c 2030 3a0a 2020 2020 2020   occ < 0:.      
+00019bb0: 2020 2020 2020 6f63 6320 3d20 7773 2e6f        occ = ws.o
+00019bc0: 6363 7570 616e 6379 0a0a 2020 2020 2020  ccupancy..      
+00019bd0: 2020 7020 3d20 6c65 6e28 7773 2e70 726f    p = len(ws.pro
+00019be0: 6365 7373 696e 6729 0a0a 2020 2020 2020  cessing)..      
+00019bf0: 2020 7365 6c66 2e73 6174 7572 6174 6564    self.saturated
+00019c00: 2e64 6973 6361 7264 2877 7329 0a20 2020  .discard(ws).   
+00019c10: 2020 2020 2069 6620 7773 2e73 7461 7475       if ws.statu
+00019c20: 7320 213d 2053 7461 7475 732e 7275 6e6e  s != Status.runn
+00019c30: 696e 673a 0a20 2020 2020 2020 2020 2020  ing:.           
+00019c40: 2073 656c 662e 6964 6c65 2e70 6f70 2877   self.idle.pop(w
+00019c50: 732e 6164 6472 6573 732c 204e 6f6e 6529  s.address, None)
+00019c60: 0a20 2020 2020 2020 2065 6c69 6620 7365  .        elif se
+00019c70: 6c66 2e69 735f 756e 6f63 6375 7069 6564  lf.is_unoccupied
+00019c80: 2877 732c 206f 6363 2c20 7029 3a0a 2020  (ws, occ, p):.  
+00019c90: 2020 2020 2020 2020 2020 7365 6c66 2e69            self.i
+00019ca0: 646c 655b 7773 2e61 6464 7265 7373 5d20  dle[ws.address] 
+00019cb0: 3d20 7773 0a20 2020 2020 2020 2065 6c73  = ws.        els
+00019cc0: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
+00019cd0: 656c 662e 6964 6c65 2e70 6f70 2877 732e  elf.idle.pop(ws.
+00019ce0: 6164 6472 6573 732c 204e 6f6e 6529 0a20  address, None). 
+00019cf0: 2020 2020 2020 2020 2020 206e 6320 3d20             nc = 
+00019d00: 7773 2e6e 7468 7265 6164 730a 2020 2020  ws.nthreads.    
+00019d10: 2020 2020 2020 2020 6966 2070 203e 206e          if p > n
+00019d20: 633a 0a20 2020 2020 2020 2020 2020 2020  c:.             
+00019d30: 2020 2070 656e 6469 6e67 203d 206f 6363     pending = occ
+00019d40: 202a 2028 7020 2d20 6e63 2920 2f20 2870   * (p - nc) / (p
+00019d50: 202a 206e 6329 0a20 2020 2020 2020 2020   * nc).         
+00019d60: 2020 2020 2020 2069 6620 302e 3420 3c20         if 0.4 < 
+00019d70: 7065 6e64 696e 6720 3e20 312e 3920 2a20  pending > 1.9 * 
+00019d80: 2873 656c 662e 746f 7461 6c5f 6f63 6375  (self.total_occu
+00019d90: 7061 6e63 7920 2f20 7365 6c66 2e74 6f74  pancy / self.tot
+00019da0: 616c 5f6e 7468 7265 6164 7329 3a0a 2020  al_nthreads):.  
+00019db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019dc0: 2020 7365 6c66 2e73 6174 7572 6174 6564    self.saturated
+00019dd0: 2e61 6464 2877 7329 0a0a 2020 2020 2020  .add(ws)..      
+00019de0: 2020 6966 206e 6f74 205f 776f 726b 6572    if not _worker
+00019df0: 5f66 756c 6c28 7773 2c20 7365 6c66 2e57  _full(ws, self.W
+00019e00: 4f52 4b45 525f 5341 5455 5241 5449 4f4e  ORKER_SATURATION
+00019e10: 2920 616e 6420 7773 2e73 7461 7475 7320  ) and ws.status 
+00019e20: 3d3d 2053 7461 7475 732e 7275 6e6e 696e  == Status.runnin
+00019e30: 673a 0a20 2020 2020 2020 2020 2020 2073  g:.            s
+00019e40: 656c 662e 6964 6c65 5f74 6173 6b5f 636f  elf.idle_task_co
+00019e50: 756e 742e 6164 6428 7773 290a 2020 2020  unt.add(ws).    
+00019e60: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00019e70: 2020 2020 2020 7365 6c66 2e69 646c 655f        self.idle_
+00019e80: 7461 736b 5f63 6f75 6e74 2e64 6973 6361  task_count.disca
+00019e90: 7264 2877 7329 0a0a 2020 2020 6465 6620  rd(ws)..    def 
+00019ea0: 6973 5f75 6e6f 6363 7570 6965 6428 0a20  is_unoccupied(. 
+00019eb0: 2020 2020 2020 2073 656c 662c 2077 733a         self, ws:
+00019ec0: 2057 6f72 6b65 7253 7461 7465 2c20 6f63   WorkerState, oc
+00019ed0: 6375 7061 6e63 793a 2066 6c6f 6174 2c20  cupancy: float, 
+00019ee0: 6e70 726f 6365 7373 696e 673a 2069 6e74  nprocessing: int
+00019ef0: 0a20 2020 2029 202d 3e20 626f 6f6c 3a0a  .    ) -> bool:.
+00019f00: 2020 2020 2020 2020 6e74 6872 6561 6473          nthreads
+00019f10: 203d 2077 732e 6e74 6872 6561 6473 0a20   = ws.nthreads. 
+00019f20: 2020 2020 2020 2072 6574 7572 6e20 280a         return (.
+00019f30: 2020 2020 2020 2020 2020 2020 6e70 726f              npro
+00019f40: 6365 7373 696e 6720 3c20 6e74 6872 6561  cessing < nthrea
+00019f50: 6473 0a20 2020 2020 2020 2020 2020 206f  ds.            o
+00019f60: 7220 6f63 6375 7061 6e63 7920 3c20 6e74  r occupancy < nt
+00019f70: 6872 6561 6473 202a 2028 7365 6c66 2e74  hreads * (self.t
+00019f80: 6f74 616c 5f6f 6363 7570 616e 6379 202f  otal_occupancy /
+00019f90: 2073 656c 662e 746f 7461 6c5f 6e74 6872   self.total_nthr
+00019fa0: 6561 6473 2920 2f20 320a 2020 2020 2020  eads) / 2.      
+00019fb0: 2020 290a 0a20 2020 2064 6566 2067 6574    )..    def get
+00019fc0: 5f63 6f6d 6d5f 636f 7374 2873 656c 662c  _comm_cost(self,
+00019fd0: 2074 733a 2054 6173 6b53 7461 7465 2c20   ts: TaskState, 
+00019fe0: 7773 3a20 576f 726b 6572 5374 6174 6529  ws: WorkerState)
+00019ff0: 202d 3e20 666c 6f61 743a 0a20 2020 2020   -> float:.     
+0001a000: 2020 2022 2222 0a20 2020 2020 2020 2047     """.        G
+0001a010: 6574 2074 6865 2065 7374 696d 6174 6564  et the estimated
+0001a020: 2063 6f6d 6d75 6e69 6361 7469 6f6e 2063   communication c
+0001a030: 6f73 7420 2869 6e20 732e 2920 746f 2063  ost (in s.) to c
+0001a040: 6f6d 7075 7465 2074 6865 2074 6173 6b0a  ompute the task.
+0001a050: 2020 2020 2020 2020 6f6e 2074 6865 2067          on the g
+0001a060: 6976 656e 2077 6f72 6b65 722e 0a20 2020  iven worker..   
+0001a070: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0001a080: 2069 6620 3130 202a 206c 656e 2874 732e   if 10 * len(ts.
+0001a090: 6465 7065 6e64 656e 6369 6573 2920 3c20  dependencies) < 
+0001a0a0: 6c65 6e28 7773 2e68 6173 5f77 6861 7429  len(ws.has_what)
+0001a0b0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+0001a0c0: 496e 2074 6865 2063 6f6d 6d6f 6e20 6361  In the common ca
+0001a0d0: 7365 2077 6865 7265 2074 6865 206e 756d  se where the num
+0001a0e0: 6265 7220 6f66 2064 6570 656e 6465 6e63  ber of dependenc
+0001a0f0: 6965 7320 6973 0a20 2020 2020 2020 2020  ies is.         
+0001a100: 2020 2023 206d 7563 6820 6c65 7373 2074     # much less t
+0001a110: 6861 6e20 7468 6520 6e75 6d62 6572 206f  han the number o
+0001a120: 6620 7461 736b 7320 7468 6174 2077 6520  f tasks that we 
+0001a130: 6861 7665 2c0a 2020 2020 2020 2020 2020  have,.          
+0001a140: 2020 2320 636f 6e73 7472 7563 7420 7468    # construct th
+0001a150: 6520 7365 7420 6f66 2064 6570 7320 7468  e set of deps th
+0001a160: 6174 2072 6571 7569 7265 2063 6f6d 6d75  at require commu
+0001a170: 6e69 6361 7469 6f6e 2069 6e0a 2020 2020  nication in.    
+0001a180: 2020 2020 2020 2020 2320 4f28 6c65 6e28          # O(len(
+0001a190: 6465 7065 6e64 656e 6369 6573 2929 2072  dependencies)) r
+0001a1a0: 6174 6865 7220 7468 616e 204f 286c 656e  ather than O(len
+0001a1b0: 2868 6173 5f77 6861 7429 2920 7469 6d65  (has_what)) time
+0001a1c0: 2e0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+0001a1d0: 4661 6374 6f72 206f 6620 3130 2069 7320  Factor of 10 is 
+0001a1e0: 6120 6775 6573 7320 6174 2074 6865 206f  a guess at the o
+0001a1f0: 7665 7268 6561 6420 6f66 2065 7870 6c69  verhead of expli
+0001a200: 6369 740a 2020 2020 2020 2020 2020 2020  cit.            
+0001a210: 2320 6974 6572 6174 696f 6e20 6173 206f  # iteration as o
+0001a220: 7070 6f73 6564 2074 6f20 6a75 7374 2063  pposed to just c
+0001a230: 616c 6c69 6e67 2073 6574 2e64 6966 6665  alling set.diffe
+0001a240: 7265 6e63 650a 2020 2020 2020 2020 2020  rence.          
+0001a250: 2020 6465 7073 203d 207b 6465 7020 666f    deps = {dep fo
+0001a260: 7220 6465 7020 696e 2074 732e 6465 7065  r dep in ts.depe
+0001a270: 6e64 656e 6369 6573 2069 6620 6465 7020  ndencies if dep 
+0001a280: 6e6f 7420 696e 2077 732e 6861 735f 7768  not in ws.has_wh
+0001a290: 6174 7d0a 2020 2020 2020 2020 656c 7365  at}.        else
+0001a2a0: 3a0a 2020 2020 2020 2020 2020 2020 6465  :.            de
+0001a2b0: 7073 203d 2028 7473 2e64 6570 656e 6465  ps = (ts.depende
+0001a2c0: 6e63 6965 7320 6f72 2073 6574 2829 292e  ncies or set()).
+0001a2d0: 6469 6666 6572 656e 6365 2877 732e 6861  difference(ws.ha
+0001a2e0: 735f 7768 6174 290a 2020 2020 2020 2020  s_what).        
+0001a2f0: 6e62 7974 6573 203d 2073 756d 2864 7473  nbytes = sum(dts
+0001a300: 2e6e 6279 7465 7320 666f 7220 6474 7320  .nbytes for dts 
+0001a310: 696e 2064 6570 7329 0a20 2020 2020 2020  in deps).       
+0001a320: 2072 6574 7572 6e20 6e62 7974 6573 202f   return nbytes /
+0001a330: 2073 656c 662e 6261 6e64 7769 6474 680a   self.bandwidth.
+0001a340: 0a20 2020 2064 6566 2067 6574 5f74 6173  .    def get_tas
+0001a350: 6b5f 6475 7261 7469 6f6e 2873 656c 662c  k_duration(self,
+0001a360: 2074 733a 2054 6173 6b53 7461 7465 2920   ts: TaskState) 
+0001a370: 2d3e 2066 6c6f 6174 3a0a 2020 2020 2020  -> float:.      
+0001a380: 2020 2222 2247 6574 2074 6865 2065 7374    """Get the est
+0001a390: 696d 6174 6564 2063 6f6d 7075 7461 7469  imated computati
+0001a3a0: 6f6e 2063 6f73 7420 6f66 2074 6865 2067  on cost of the g
+0001a3b0: 6976 656e 2074 6173 6b20 286e 6f74 2069  iven task (not i
+0001a3c0: 6e63 6c75 6469 6e67 0a20 2020 2020 2020  ncluding.       
+0001a3d0: 2061 6e79 2063 6f6d 6d75 6e69 6361 7469   any communicati
+0001a3e0: 6f6e 2063 6f73 7429 2e0a 0a20 2020 2020  on cost)...     
+0001a3f0: 2020 2049 6620 6e6f 2064 6174 6120 6861     If no data ha
+0001a400: 7320 6265 656e 206f 6273 6572 7665 642c  s been observed,
+0001a410: 2076 616c 7565 206f 660a 2020 2020 2020   value of.      
+0001a420: 2020 6064 6973 7472 6962 7574 6564 2e73    `distributed.s
+0001a430: 6368 6564 756c 6572 2e64 6566 6175 6c74  cheduler.default
+0001a440: 2d74 6173 6b2d 6475 7261 7469 6f6e 7360  -task-durations`
+0001a450: 2061 7265 2075 7365 642e 2049 6620 6e6f   are used. If no
+0001a460: 6e65 2069 7320 7365 740a 2020 2020 2020  ne is set.      
+0001a470: 2020 666f 7220 7468 6973 2074 6173 6b2c    for this task,
+0001a480: 2060 6469 7374 7269 6275 7465 642e 7363   `distributed.sc
+0001a490: 6865 6475 6c65 722e 756e 6b6e 6f77 6e2d  heduler.unknown-
+0001a4a0: 7461 736b 2d64 7572 6174 696f 6e60 2069  task-duration` i
+0001a4b0: 7320 7573 6564 0a20 2020 2020 2020 2069  s used.        i
+0001a4c0: 6e73 7465 6164 2e0a 2020 2020 2020 2020  nstead..        
+0001a4d0: 2222 220a 2020 2020 2020 2020 6475 7261  """.        dura
+0001a4e0: 7469 6f6e 3a20 666c 6f61 7420 3d20 7473  tion: float = ts
+0001a4f0: 2e70 7265 6669 782e 6475 7261 7469 6f6e  .prefix.duration
+0001a500: 5f61 7665 7261 6765 0a20 2020 2020 2020  _average.       
+0001a510: 2069 6620 6475 7261 7469 6f6e 203e 3d20   if duration >= 
+0001a520: 303a 0a20 2020 2020 2020 2020 2020 2072  0:.            r
+0001a530: 6574 7572 6e20 6475 7261 7469 6f6e 0a0a  eturn duration..
+0001a540: 2020 2020 2020 2020 7320 3d20 7365 6c66          s = self
+0001a550: 2e75 6e6b 6e6f 776e 5f64 7572 6174 696f  .unknown_duratio
+0001a560: 6e73 2e67 6574 2874 732e 7072 6566 6978  ns.get(ts.prefix
+0001a570: 2e6e 616d 6529 0a20 2020 2020 2020 2069  .name).        i
+0001a580: 6620 7320 6973 204e 6f6e 653a 0a20 2020  f s is None:.   
+0001a590: 2020 2020 2020 2020 2073 656c 662e 756e           self.un
+0001a5a0: 6b6e 6f77 6e5f 6475 7261 7469 6f6e 735b  known_durations[
+0001a5b0: 7473 2e70 7265 6669 782e 6e61 6d65 5d20  ts.prefix.name] 
+0001a5c0: 3d20 7320 3d20 7365 7428 290a 2020 2020  = s = set().    
+0001a5d0: 2020 2020 732e 6164 6428 7473 290a 2020      s.add(ts).  
+0001a5e0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+0001a5f0: 662e 554e 4b4e 4f57 4e5f 5441 534b 5f44  f.UNKNOWN_TASK_D
+0001a600: 5552 4154 494f 4e0a 0a20 2020 2064 6566  URATION..    def
+0001a610: 2076 616c 6964 5f77 6f72 6b65 7273 2873   valid_workers(s
+0001a620: 656c 662c 2074 733a 2054 6173 6b53 7461  elf, ts: TaskSta
+0001a630: 7465 2920 2d3e 2073 6574 5b57 6f72 6b65  te) -> set[Worke
+0001a640: 7253 7461 7465 5d20 7c20 4e6f 6e65 3a0a  rState] | None:.
+0001a650: 2020 2020 2020 2020 2222 2252 6574 7572          """Retur
+0001a660: 6e20 7365 7420 6f66 2063 7572 7265 6e74  n set of current
+0001a670: 6c79 2076 616c 6964 2077 6f72 6b65 7273  ly valid workers
+0001a680: 2066 6f72 206b 6579 0a0a 2020 2020 2020   for key..      
+0001a690: 2020 4966 2061 6c6c 2077 6f72 6b65 7273    If all workers
+0001a6a0: 2061 7265 2076 616c 6964 2074 6865 6e20   are valid then 
+0001a6b0: 7468 6973 2072 6574 7572 6e73 2060 604e  this returns ``N
+0001a6c0: 6f6e 6560 602c 2069 6e20 7768 6963 6820  one``, in which 
+0001a6d0: 6361 7365 0a20 2020 2020 2020 2061 6e79  case.        any
+0001a6e0: 202a 7275 6e6e 696e 672a 2077 6f72 6b65   *running* worke
+0001a6f0: 7220 6361 6e20 6265 2075 7365 642e 0a20  r can be used.. 
+0001a700: 2020 2020 2020 204f 7468 6572 7769 7365         Otherwise
+0001a710: 2c20 7468 6520 7375 6273 6574 206f 6620  , the subset of 
+0001a720: 7275 6e6e 696e 6720 776f 726b 6572 7320  running workers 
+0001a730: 7661 6c69 6420 666f 7220 7468 6973 2074  valid for this t
+0001a740: 6173 6b0a 2020 2020 2020 2020 6973 2072  ask.        is r
+0001a750: 6574 7572 6e65 642e 0a20 2020 2020 2020  eturned..       
+0001a760: 2054 6869 7320 6368 6563 6b73 2074 7261   This checks tra
+0001a770: 636b 7320 7468 6520 666f 6c6c 6f77 696e  cks the followin
+0001a780: 6720 7374 6174 653a 0a0a 2020 2020 2020  g state:..      
+0001a790: 2020 2a20 2077 6f72 6b65 725f 7265 7374    *  worker_rest
+0001a7a0: 7269 6374 696f 6e73 0a20 2020 2020 2020  rictions.       
+0001a7b0: 202a 2020 686f 7374 5f72 6573 7472 6963   *  host_restric
+0001a7c0: 7469 6f6e 730a 2020 2020 2020 2020 2a20  tions.        * 
+0001a7d0: 2072 6573 6f75 7263 655f 7265 7374 7269   resource_restri
+0001a7e0: 6374 696f 6e73 0a20 2020 2020 2020 2022  ctions.        "
+0001a7f0: 2222 0a20 2020 2020 2020 2073 3a20 7365  "".        s: se
+0001a800: 745b 7374 725d 207c 204e 6f6e 6520 3d20  t[str] | None = 
+0001a810: 4e6f 6e65 0a0a 2020 2020 2020 2020 6966  None..        if
+0001a820: 2074 732e 776f 726b 6572 5f72 6573 7472   ts.worker_restr
+0001a830: 6963 7469 6f6e 733a 0a20 2020 2020 2020  ictions:.       
+0001a840: 2020 2020 2073 203d 207b 6164 6472 2066       s = {addr f
+0001a850: 6f72 2061 6464 7220 696e 2074 732e 776f  or addr in ts.wo
+0001a860: 726b 6572 5f72 6573 7472 6963 7469 6f6e  rker_restriction
+0001a870: 7320 6966 2061 6464 7220 696e 2073 656c  s if addr in sel
+0001a880: 662e 776f 726b 6572 737d 0a0a 2020 2020  f.workers}..    
+0001a890: 2020 2020 6966 2074 732e 686f 7374 5f72      if ts.host_r
+0001a8a0: 6573 7472 6963 7469 6f6e 733a 0a20 2020  estrictions:.   
+0001a8b0: 2020 2020 2020 2020 2023 2052 6573 6f6c           # Resol
+0001a8c0: 7665 2074 6865 2061 6c69 6173 2068 6572  ve the alias her
+0001a8d0: 6520 7261 7468 6572 2074 6861 6e20 6561  e rather than ea
+0001a8e0: 726c 792c 2066 6f72 2074 6865 2077 6f72  rly, for the wor
+0001a8f0: 6b65 720a 2020 2020 2020 2020 2020 2020  ker.            
+0001a900: 2320 6d61 7920 6e6f 7420 6265 2063 6f6e  # may not be con
+0001a910: 6e65 6374 6564 2077 6865 6e20 686f 7374  nected when host
+0001a920: 5f72 6573 7472 6963 7469 6f6e 7320 6973  _restrictions is
+0001a930: 2070 6f70 756c 6174 6564 0a20 2020 2020   populated.     
+0001a940: 2020 2020 2020 2068 7220 3d20 5b73 656c         hr = [sel
+0001a950: 662e 636f 6572 6365 5f68 6f73 746e 616d  f.coerce_hostnam
+0001a960: 6528 6829 2066 6f72 2068 2069 6e20 7473  e(h) for h in ts
+0001a970: 2e68 6f73 745f 7265 7374 7269 6374 696f  .host_restrictio
+0001a980: 6e73 5d0a 2020 2020 2020 2020 2020 2020  ns].            
+0001a990: 2320 5858 5820 6e65 6564 2048 6f73 7453  # XXX need HostS
+0001a9a0: 7461 7465 3f0a 2020 2020 2020 2020 2020  tate?.          
+0001a9b0: 2020 736c 203d 205b 5d0a 2020 2020 2020    sl = [].      
+0001a9c0: 2020 2020 2020 666f 7220 6820 696e 2068        for h in h
+0001a9d0: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
+0001a9e0: 2020 2064 6820 3d20 7365 6c66 2e68 6f73     dh = self.hos
+0001a9f0: 745f 696e 666f 2e67 6574 2868 290a 2020  t_info.get(h).  
+0001aa00: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0001aa10: 2064 6820 6973 206e 6f74 204e 6f6e 653a   dh is not None:
+0001aa20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001aa30: 2020 2020 2073 6c2e 6170 7065 6e64 2864       sl.append(d
+0001aa40: 685b 2261 6464 7265 7373 6573 225d 290a  h["addresses"]).
+0001aa50: 0a20 2020 2020 2020 2020 2020 2073 7320  .            ss 
+0001aa60: 3d20 7365 742e 756e 696f 6e28 2a73 6c29  = set.union(*sl)
+0001aa70: 2069 6620 736c 2065 6c73 6520 7365 7428   if sl else set(
+0001aa80: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+0001aa90: 2073 2069 7320 4e6f 6e65 3a0a 2020 2020   s is None:.    
+0001aaa0: 2020 2020 2020 2020 2020 2020 7320 3d20              s = 
+0001aab0: 7373 0a20 2020 2020 2020 2020 2020 2065  ss.            e
+0001aac0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0001aad0: 2020 2020 2073 207c 3d20 7373 0a0a 2020       s |= ss..  
+0001aae0: 2020 2020 2020 6966 2074 732e 7265 736f        if ts.reso
+0001aaf0: 7572 6365 5f72 6573 7472 6963 7469 6f6e  urce_restriction
+0001ab00: 733a 0a20 2020 2020 2020 2020 2020 2064  s:.            d
+0001ab10: 7720 3d20 7b7d 0a20 2020 2020 2020 2020  w = {}.         
+0001ab20: 2020 2066 6f72 2072 6573 6f75 7263 652c     for resource,
+0001ab30: 2072 6571 7569 7265 6420 696e 2074 732e   required in ts.
+0001ab40: 7265 736f 7572 6365 5f72 6573 7472 6963  resource_restric
+0001ab50: 7469 6f6e 732e 6974 656d 7328 293a 0a20  tions.items():. 
+0001ab60: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0001ab70: 7220 3d20 7365 6c66 2e72 6573 6f75 7263  r = self.resourc
+0001ab80: 6573 2e67 6574 2872 6573 6f75 7263 6529  es.get(resource)
+0001ab90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001aba0: 2069 6620 6472 2069 7320 4e6f 6e65 3a0a   if dr is None:.
+0001abb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001abc0: 2020 2020 7365 6c66 2e72 6573 6f75 7263      self.resourc
+0001abd0: 6573 5b72 6573 6f75 7263 655d 203d 2064  es[resource] = d
+0001abe0: 7220 3d20 7b7d 0a0a 2020 2020 2020 2020  r = {}..        
+0001abf0: 2020 2020 2020 2020 7377 203d 2073 6574          sw = set
+0001ac00: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+0001ac10: 2020 2066 6f72 2061 6464 722c 2073 7570     for addr, sup
+0001ac20: 706c 6965 6420 696e 2064 722e 6974 656d  plied in dr.item
+0001ac30: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+0001ac40: 2020 2020 2020 2020 2069 6620 7375 7070           if supp
+0001ac50: 6c69 6564 203e 3d20 7265 7175 6972 6564  lied >= required
+0001ac60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001ac70: 2020 2020 2020 2020 2020 7377 2e61 6464            sw.add
+0001ac80: 2861 6464 7229 0a0a 2020 2020 2020 2020  (addr)..        
+0001ac90: 2020 2020 2020 2020 6477 5b72 6573 6f75          dw[resou
+0001aca0: 7263 655d 203d 2073 770a 0a20 2020 2020  rce] = sw..     
+0001acb0: 2020 2020 2020 2077 7720 3d20 7365 742e         ww = set.
+0001acc0: 696e 7465 7273 6563 7469 6f6e 282a 6477  intersection(*dw
+0001acd0: 2e76 616c 7565 7328 2929 0a20 2020 2020  .values()).     
+0001ace0: 2020 2020 2020 2069 6620 7320 6973 204e         if s is N
+0001acf0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0001ad00: 2020 2020 2073 203d 2077 770a 2020 2020       s = ww.    
+0001ad10: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0001ad20: 2020 2020 2020 2020 2020 2020 2020 7320                s 
+0001ad30: 263d 2077 770a 0a20 2020 2020 2020 2069  &= ww..        i
+0001ad40: 6620 7320 6973 204e 6f6e 653a 0a20 2020  f s is None:.   
+0001ad50: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001ad60: 4e6f 6e65 2020 2320 416c 6c20 776f 726b  None  # All work
+0001ad70: 6572 7320 6172 6520 7661 6c69 640a 2020  ers are valid.  
+0001ad80: 2020 2020 2020 6966 206e 6f74 2073 3a0a        if not s:.
+0001ad90: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0001ada0: 726e 2073 6574 2829 2020 2320 4e6f 2077  rn set()  # No w
+0001adb0: 6f72 6b65 7273 2061 7265 2076 616c 6964  orkers are valid
+0001adc0: 0a0a 2020 2020 2020 2020 2320 536f 6d65  ..        # Some
+0001add0: 2077 6f72 6b65 7273 2061 7265 2076 616c   workers are val
+0001ade0: 6964 0a20 2020 2020 2020 2073 5f77 7320  id.        s_ws 
+0001adf0: 3d20 7b73 656c 662e 776f 726b 6572 735b  = {self.workers[
+0001ae00: 6164 6472 5d20 666f 7220 6164 6472 2069  addr] for addr i
+0001ae10: 6e20 737d 0a20 2020 2020 2020 2069 6620  n s}.        if 
+0001ae20: 6c65 6e28 7365 6c66 2e72 756e 6e69 6e67  len(self.running
+0001ae30: 2920 3c20 6c65 6e28 7365 6c66 2e77 6f72  ) < len(self.wor
+0001ae40: 6b65 7273 293a 0a20 2020 2020 2020 2020  kers):.         
+0001ae50: 2020 2073 5f77 7320 263d 2073 656c 662e     s_ws &= self.
+0001ae60: 7275 6e6e 696e 670a 2020 2020 2020 2020  running.        
+0001ae70: 7265 7475 726e 2073 5f77 730a 0a20 2020  return s_ws..   
+0001ae80: 2064 6566 2061 6371 7569 7265 5f72 6573   def acquire_res
+0001ae90: 6f75 7263 6573 2873 656c 662c 2074 733a  ources(self, ts:
+0001aea0: 2054 6173 6b53 7461 7465 2c20 7773 3a20   TaskState, ws: 
+0001aeb0: 576f 726b 6572 5374 6174 6529 202d 3e20  WorkerState) -> 
+0001aec0: 4e6f 6e65 3a0a 2020 2020 2020 2020 6966  None:.        if
+0001aed0: 2074 732e 7265 736f 7572 6365 5f72 6573   ts.resource_res
+0001aee0: 7472 6963 7469 6f6e 733a 0a20 2020 2020  trictions:.     
+0001aef0: 2020 2020 2020 2066 6f72 2072 2c20 7265         for r, re
+0001af00: 7175 6972 6564 2069 6e20 7473 2e72 6573  quired in ts.res
+0001af10: 6f75 7263 655f 7265 7374 7269 6374 696f  ource_restrictio
+0001af20: 6e73 2e69 7465 6d73 2829 3a0a 2020 2020  ns.items():.    
+0001af30: 2020 2020 2020 2020 2020 2020 7773 2e75              ws.u
+0001af40: 7365 645f 7265 736f 7572 6365 735b 725d  sed_resources[r]
+0001af50: 202b 3d20 7265 7175 6972 6564 0a0a 2020   += required..  
+0001af60: 2020 6465 6620 7265 6c65 6173 655f 7265    def release_re
+0001af70: 736f 7572 6365 7328 7365 6c66 2c20 7473  sources(self, ts
+0001af80: 3a20 5461 736b 5374 6174 652c 2077 733a  : TaskState, ws:
+0001af90: 2057 6f72 6b65 7253 7461 7465 2920 2d3e   WorkerState) ->
+0001afa0: 204e 6f6e 653a 0a20 2020 2020 2020 2069   None:.        i
+0001afb0: 6620 7473 2e72 6573 6f75 7263 655f 7265  f ts.resource_re
+0001afc0: 7374 7269 6374 696f 6e73 3a0a 2020 2020  strictions:.    
+0001afd0: 2020 2020 2020 2020 666f 7220 722c 2072          for r, r
+0001afe0: 6571 7569 7265 6420 696e 2074 732e 7265  equired in ts.re
+0001aff0: 736f 7572 6365 5f72 6573 7472 6963 7469  source_restricti
+0001b000: 6f6e 732e 6974 656d 7328 293a 0a20 2020  ons.items():.   
+0001b010: 2020 2020 2020 2020 2020 2020 2077 732e               ws.
+0001b020: 7573 6564 5f72 6573 6f75 7263 6573 5b72  used_resources[r
+0001b030: 5d20 2d3d 2072 6571 7569 7265 640a 0a20  ] -= required.. 
+0001b040: 2020 2064 6566 2063 6f65 7263 655f 686f     def coerce_ho
+0001b050: 7374 6e61 6d65 2873 656c 662c 2068 6f73  stname(self, hos
+0001b060: 743a 2048 6173 6861 626c 6529 202d 3e20  t: Hashable) -> 
+0001b070: 7374 723a 0a20 2020 2020 2020 2022 2222  str:.        """
+0001b080: 0a20 2020 2020 2020 2043 6f65 7263 6520  .        Coerce 
+0001b090: 7468 6520 686f 7374 6e61 6d65 206f 6620  the hostname of 
+0001b0a0: 6120 776f 726b 6572 2e0a 2020 2020 2020  a worker..      
+0001b0b0: 2020 2222 220a 2020 2020 2020 2020 616c    """.        al
+0001b0c0: 6961 7320 3d20 7365 6c66 2e61 6c69 6173  ias = self.alias
+0001b0d0: 6573 2e67 6574 2868 6f73 7429 0a20 2020  es.get(host).   
+0001b0e0: 2020 2020 2069 6620 616c 6961 7320 6973       if alias is
+0001b0f0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+0001b100: 2020 2020 2020 2077 7320 3d20 7365 6c66         ws = self
+0001b110: 2e77 6f72 6b65 7273 5b61 6c69 6173 5d0a  .workers[alias].
+0001b120: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0001b130: 726e 2077 732e 686f 7374 0a20 2020 2020  rn ws.host.     
+0001b140: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0001b150: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
+0001b160: 7374 616e 6365 2868 6f73 742c 2073 7472  stance(host, str
+0001b170: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+0001b180: 7475 726e 2068 6f73 740a 0a20 2020 2064  turn host..    d
+0001b190: 6566 2077 6f72 6b65 725f 6f62 6a65 6374  ef worker_object
+0001b1a0: 6976 6528 7365 6c66 2c20 7473 3a20 5461  ive(self, ts: Ta
+0001b1b0: 736b 5374 6174 652c 2077 733a 2057 6f72  skState, ws: Wor
+0001b1c0: 6b65 7253 7461 7465 2920 2d3e 2074 7570  kerState) -> tup
+0001b1d0: 6c65 3a0a 2020 2020 2020 2020 2222 224f  le:.        """O
+0001b1e0: 626a 6563 7469 7665 2066 756e 6374 696f  bjective functio
+0001b1f0: 6e20 746f 2064 6574 6572 6d69 6e65 2077  n to determine w
+0001b200: 6869 6368 2077 6f72 6b65 7220 7368 6f75  hich worker shou
+0001b210: 6c64 2067 6574 2074 6865 2074 6173 6b0a  ld get the task.
+0001b220: 0a20 2020 2020 2020 204d 696e 696d 697a  .        Minimiz
+0001b230: 6520 6578 7065 6374 6564 2073 7461 7274  e expected start
+0001b240: 2074 696d 652e 2020 4966 2061 2074 6965   time.  If a tie
+0001b250: 2074 6865 6e20 6272 6561 6b20 7769 7468   then break with
+0001b260: 2064 6174 6120 7374 6f72 6167 652e 0a20   data storage.. 
+0001b270: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0001b280: 2020 2063 6f6d 6d5f 6279 7465 7320 3d20     comm_bytes = 
+0001b290: 7375 6d28 0a20 2020 2020 2020 2020 2020  sum(.           
+0001b2a0: 2064 7473 2e67 6574 5f6e 6279 7465 7328   dts.get_nbytes(
+0001b2b0: 2920 666f 7220 6474 7320 696e 2074 732e  ) for dts in ts.
+0001b2c0: 6465 7065 6e64 656e 6369 6573 2069 6620  dependencies if 
+0001b2d0: 7773 206e 6f74 2069 6e20 2864 7473 2e77  ws not in (dts.w
+0001b2e0: 686f 5f68 6173 206f 7220 2829 290a 2020  ho_has or ()).  
+0001b2f0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+0001b300: 2073 7461 636b 5f74 696d 6520 3d20 7773   stack_time = ws
+0001b310: 2e6f 6363 7570 616e 6379 202f 2077 732e  .occupancy / ws.
+0001b320: 6e74 6872 6561 6473 0a20 2020 2020 2020  nthreads.       
+0001b330: 2073 7461 7274 5f74 696d 6520 3d20 7374   start_time = st
+0001b340: 6163 6b5f 7469 6d65 202b 2063 6f6d 6d5f  ack_time + comm_
+0001b350: 6279 7465 7320 2f20 7365 6c66 2e62 616e  bytes / self.ban
+0001b360: 6477 6964 7468 0a0a 2020 2020 2020 2020  dwidth..        
+0001b370: 6966 2074 732e 6163 746f 723a 0a20 2020  if ts.actor:.   
+0001b380: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001b390: 286c 656e 2877 732e 6163 746f 7273 292c  (len(ws.actors),
+0001b3a0: 2073 7461 7274 5f74 696d 652c 2077 732e   start_time, ws.
+0001b3b0: 6e62 7974 6573 290a 2020 2020 2020 2020  nbytes).        
+0001b3c0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0001b3d0: 2020 7265 7475 726e 2028 7374 6172 745f    return (start_
+0001b3e0: 7469 6d65 2c20 7773 2e6e 6279 7465 7329  time, ws.nbytes)
+0001b3f0: 0a0a 2020 2020 6465 6620 6164 645f 7265  ..    def add_re
+0001b400: 706c 6963 6128 7365 6c66 2c20 7473 3a20  plica(self, ts: 
+0001b410: 5461 736b 5374 6174 652c 2077 733a 2057  TaskState, ws: W
+0001b420: 6f72 6b65 7253 7461 7465 2920 2d3e 204e  orkerState) -> N
+0001b430: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
+0001b440: 4e6f 7465 2074 6861 7420 6120 776f 726b  Note that a work
+0001b450: 6572 2068 6f6c 6473 2061 2072 6570 6c69  er holds a repli
+0001b460: 6361 206f 6620 6120 7461 736b 2077 6974  ca of a task wit
+0001b470: 6820 7374 6174 653d 276d 656d 6f72 7927  h state='memory'
+0001b480: 2222 220a 2020 2020 2020 2020 7773 2e61  """.        ws.a
+0001b490: 6464 5f72 6570 6c69 6361 2874 7329 0a20  dd_replica(ts). 
+0001b4a0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
+0001b4b0: 2e77 686f 5f68 6173 0a20 2020 2020 2020  .who_has.       
+0001b4c0: 2069 6620 6c65 6e28 7473 2e77 686f 5f68   if len(ts.who_h
+0001b4d0: 6173 2920 3d3d 2032 3a0a 2020 2020 2020  as) == 2:.      
+0001b4e0: 2020 2020 2020 7365 6c66 2e72 6570 6c69        self.repli
+0001b4f0: 6361 7465 645f 7461 736b 732e 6164 6428  cated_tasks.add(
+0001b500: 7473 290a 0a20 2020 2064 6566 2072 656d  ts)..    def rem
+0001b510: 6f76 655f 7265 706c 6963 6128 7365 6c66  ove_replica(self
+0001b520: 2c20 7473 3a20 5461 736b 5374 6174 652c  , ts: TaskState,
+0001b530: 2077 733a 2057 6f72 6b65 7253 7461 7465   ws: WorkerState
+0001b540: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+0001b550: 2020 2022 2222 4e6f 7465 2074 6861 7420     """Note that 
+0001b560: 6120 776f 726b 6572 206e 6f20 6c6f 6e67  a worker no long
+0001b570: 6572 2068 6f6c 6473 2061 2072 6570 6c69  er holds a repli
+0001b580: 6361 206f 6620 6120 7461 736b 2222 220a  ca of a task""".
+0001b590: 2020 2020 2020 2020 7773 2e72 656d 6f76          ws.remov
+0001b5a0: 655f 7265 706c 6963 6128 7473 290a 2020  e_replica(ts).  
+0001b5b0: 2020 2020 2020 6966 206c 656e 2874 732e        if len(ts.
+0001b5c0: 7768 6f5f 6861 7320 6f72 2028 2929 203d  who_has or ()) =
+0001b5d0: 3d20 313a 0a20 2020 2020 2020 2020 2020  = 1:.           
+0001b5e0: 2073 656c 662e 7265 706c 6963 6174 6564   self.replicated
+0001b5f0: 5f74 6173 6b73 2e72 656d 6f76 6528 7473  _tasks.remove(ts
+0001b600: 290a 0a20 2020 2064 6566 2072 656d 6f76  )..    def remov
+0001b610: 655f 616c 6c5f 7265 706c 6963 6173 2873  e_all_replicas(s
+0001b620: 656c 662c 2074 733a 2054 6173 6b53 7461  elf, ts: TaskSta
+0001b630: 7465 2920 2d3e 204e 6f6e 653a 0a20 2020  te) -> None:.   
+0001b640: 2020 2020 2022 2222 5265 6d6f 7665 2061       """Remove a
+0001b650: 6c6c 2072 6570 6c69 6361 7320 6f66 2061  ll replicas of a
+0001b660: 2074 6173 6b20 6672 6f6d 2061 6c6c 2077   task from all w
+0001b670: 6f72 6b65 7273 2222 220a 2020 2020 2020  orkers""".      
+0001b680: 2020 6e62 7974 6573 203d 2074 732e 6765    nbytes = ts.ge
+0001b690: 745f 6e62 7974 6573 2829 0a20 2020 2020  t_nbytes().     
+0001b6a0: 2020 2069 6620 6e6f 7420 7473 2e77 686f     if not ts.who
+0001b6b0: 5f68 6173 3a0a 2020 2020 2020 2020 2020  _has:.          
+0001b6c0: 2020 7265 7475 726e 0a20 2020 2020 2020    return.       
+0001b6d0: 2066 6f72 2077 7320 696e 2074 732e 7768   for ws in ts.wh
+0001b6e0: 6f5f 6861 733a 0a20 2020 2020 2020 2020  o_has:.         
+0001b6f0: 2020 2077 732e 6e62 7974 6573 202d 3d20     ws.nbytes -= 
+0001b700: 6e62 7974 6573 0a20 2020 2020 2020 2020  nbytes.         
+0001b710: 2020 2064 656c 2077 732e 5f68 6173 5f77     del ws._has_w
+0001b720: 6861 745b 7473 5d0a 2020 2020 2020 2020  hat[ts].        
+0001b730: 6966 206c 656e 2874 732e 7768 6f5f 6861  if len(ts.who_ha
+0001b740: 7329 203e 2031 3a0a 2020 2020 2020 2020  s) > 1:.        
+0001b750: 2020 2020 7365 6c66 2e72 6570 6c69 6361      self.replica
+0001b760: 7465 645f 7461 736b 732e 7265 6d6f 7665  ted_tasks.remove
+0001b770: 2874 7329 0a20 2020 2020 2020 2074 732e  (ts).        ts.
+0001b780: 7768 6f5f 6861 7320 3d20 4e6f 6e65 0a0a  who_has = None..
+0001b790: 2020 2020 6465 6620 6275 6c6b 5f73 6368      def bulk_sch
+0001b7a0: 6564 756c 655f 756e 7275 6e6e 6162 6c65  edule_unrunnable
+0001b7b0: 5f61 6674 6572 5f61 6464 696e 675f 776f  _after_adding_wo
+0001b7c0: 726b 6572 2873 656c 662c 2077 733a 2057  rker(self, ws: W
+0001b7d0: 6f72 6b65 7253 7461 7465 2920 2d3e 2052  orkerState) -> R
+0001b7e0: 6563 733a 0a20 2020 2020 2020 2022 2222  ecs:.        """
+0001b7f0: 5365 6e64 2060 606e 6f2d 776f 726b 6572  Send ``no-worker
+0001b800: 6060 2074 6173 6b73 2074 6f20 6060 7072  `` tasks to ``pr
+0001b810: 6f63 6573 7369 6e67 6060 2074 6861 7420  ocessing`` that 
+0001b820: 7468 6973 2077 6f72 6b65 7220 6361 6e20  this worker can 
+0001b830: 6861 6e64 6c65 2e0a 0a20 2020 2020 2020  handle...       
+0001b840: 2052 6574 7572 6e73 2070 7269 6f72 6974   Returns priorit
+0001b850: 792d 6f72 6465 7265 6420 7265 636f 6d6d  y-ordered recomm
+0001b860: 656e 6461 7469 6f6e 732e 0a20 2020 2020  endations..     
+0001b870: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
+0001b880: 756e 6e61 626c 653a 206c 6973 745b 5461  unnable: list[Ta
+0001b890: 736b 5374 6174 655d 203d 205b 5d0a 2020  skState] = [].  
+0001b8a0: 2020 2020 2020 666f 7220 7473 2069 6e20        for ts in 
+0001b8b0: 7365 6c66 2e75 6e72 756e 6e61 626c 653a  self.unrunnable:
+0001b8c0: 0a20 2020 2020 2020 2020 2020 2076 616c  .            val
+0001b8d0: 6964 203d 2073 656c 662e 7661 6c69 645f  id = self.valid_
+0001b8e0: 776f 726b 6572 7328 7473 290a 2020 2020  workers(ts).    
+0001b8f0: 2020 2020 2020 2020 6966 2076 616c 6964          if valid
+0001b900: 2069 7320 4e6f 6e65 206f 7220 7773 2069   is None or ws i
+0001b910: 6e20 7661 6c69 643a 0a20 2020 2020 2020  n valid:.       
+0001b920: 2020 2020 2020 2020 2072 756e 6e61 626c           runnabl
+0001b930: 652e 6170 7065 6e64 2874 7329 0a0a 2020  e.append(ts)..  
+0001b940: 2020 2020 2020 2320 5265 636f 6d6d 656e        # Recommen
+0001b950: 6461 7469 6f6e 7320 6172 6520 7072 6f63  dations are proc
+0001b960: 6573 7365 6420 4c49 464f 2c20 6865 6e63  essed LIFO, henc
+0001b970: 6520 7468 6520 7265 7665 7273 6564 206f  e the reversed o
+0001b980: 7264 6572 0a20 2020 2020 2020 2072 756e  rder.        run
+0001b990: 6e61 626c 652e 736f 7274 286b 6579 3d6f  nable.sort(key=o
+0001b9a0: 7065 7261 746f 722e 6174 7472 6765 7474  perator.attrgett
+0001b9b0: 6572 2822 7072 696f 7269 7479 2229 2c20  er("priority"), 
+0001b9c0: 7265 7665 7273 653d 5472 7565 290a 2020  reverse=True).  
+0001b9d0: 2020 2020 2020 7265 7475 726e 207b 7473        return {ts
+0001b9e0: 2e6b 6579 3a20 2270 726f 6365 7373 696e  .key: "processin
+0001b9f0: 6722 2066 6f72 2074 7320 696e 2072 756e  g" for ts in run
+0001ba00: 6e61 626c 657d 0a0a 2020 2020 6465 6620  nable}..    def 
+0001ba10: 5f76 616c 6964 6174 655f 7265 6164 7928  _validate_ready(
+0001ba20: 7365 6c66 2c20 7473 3a20 5461 736b 5374  self, ts: TaskSt
+0001ba30: 6174 6529 202d 3e20 4e6f 6e65 3a0a 2020  ate) -> None:.  
+0001ba40: 2020 2020 2020 2222 2256 616c 6964 6174        """Validat
+0001ba50: 696f 6e20 666f 7220 7265 6164 7920 7374  ion for ready st
+0001ba60: 6174 6573 2028 7072 6f63 6573 7369 6e67  ates (processing
+0001ba70: 2c20 7175 6575 6564 2c20 6e6f 2d77 6f72  , queued, no-wor
+0001ba80: 6b65 7229 2222 220a 2020 2020 2020 2020  ker)""".        
+0001ba90: 6173 7365 7274 206e 6f74 2074 732e 7761  assert not ts.wa
+0001baa0: 6974 696e 675f 6f6e 0a20 2020 2020 2020  iting_on.       
+0001bab0: 2061 7373 6572 7420 6e6f 7420 7473 2e77   assert not ts.w
+0001bac0: 686f 5f68 6173 0a20 2020 2020 2020 2061  ho_has.        a
+0001bad0: 7373 6572 7420 6e6f 7420 7473 2e65 7863  ssert not ts.exc
+0001bae0: 6570 7469 6f6e 5f62 6c61 6d65 0a20 2020  eption_blame.   
+0001baf0: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+0001bb00: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
+0001bb10: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+0001bb20: 6e6f 7420 7473 2e68 6173 5f6c 6f73 745f  not ts.has_lost_
+0001bb30: 6465 7065 6e64 656e 6369 6573 0a20 2020  dependencies.   
+0001bb40: 2020 2020 2061 7373 6572 7420 7473 206e       assert ts n
+0001bb50: 6f74 2069 6e20 7365 6c66 2e75 6e72 756e  ot in self.unrun
+0001bb60: 6e61 626c 650a 2020 2020 2020 2020 6173  nable.        as
+0001bb70: 7365 7274 2074 7320 6e6f 7420 696e 2073  sert ts not in s
+0001bb80: 656c 662e 7175 6575 6564 0a20 2020 2020  elf.queued.     
+0001bb90: 2020 2061 7373 6572 7420 616c 6c28 6474     assert all(dt
+0001bba0: 732e 7768 6f5f 6861 7320 666f 7220 6474  s.who_has for dt
+0001bbb0: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
+0001bbc0: 6369 6573 290a 0a20 2020 2064 6566 205f  cies)..    def _
+0001bbd0: 6164 645f 746f 5f70 726f 6365 7373 696e  add_to_processin
+0001bbe0: 6728 0a20 2020 2020 2020 2073 656c 662c  g(.        self,
+0001bbf0: 2074 733a 2054 6173 6b53 7461 7465 2c20   ts: TaskState, 
+0001bc00: 7773 3a20 576f 726b 6572 5374 6174 652c  ws: WorkerState,
+0001bc10: 2073 7469 6d75 6c75 735f 6964 3a20 7374   stimulus_id: st
+0001bc20: 720a 2020 2020 2920 2d3e 2052 6563 734d  r.    ) -> RecsM
+0001bc30: 7367 733a 0a20 2020 2020 2020 2022 2222  sgs:.        """
+0001bc40: 5365 7420 6120 7461 736b 2061 7320 7072  Set a task as pr
+0001bc50: 6f63 6573 7369 6e67 206f 6e20 6120 776f  ocessing on a wo
+0001bc60: 726b 6572 2061 6e64 2072 6574 7572 6e20  rker and return 
+0001bc70: 7468 6520 776f 726b 6572 206d 6573 7361  the worker messa
+0001bc80: 6765 7320 746f 2073 656e 6422 2222 0a20  ges to send""". 
+0001bc90: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
+0001bca0: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
+0001bcb0: 2020 2020 2073 656c 662e 5f76 616c 6964       self._valid
+0001bcc0: 6174 655f 7265 6164 7928 7473 290a 2020  ate_ready(ts).  
+0001bcd0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0001bce0: 2077 7320 696e 2073 656c 662e 7275 6e6e   ws in self.runn
+0001bcf0: 696e 672c 2073 656c 662e 7275 6e6e 696e  ing, self.runnin
+0001bd00: 670a 2020 2020 2020 2020 2020 2020 6173  g.            as
+0001bd10: 7365 7274 2028 6f20 3a3d 2073 656c 662e  sert (o := self.
+0001bd20: 776f 726b 6572 732e 6765 7428 7773 2e61  workers.get(ws.a
+0001bd30: 6464 7265 7373 2929 2069 7320 7773 2c20  ddress)) is ws, 
+0001bd40: 2877 732c 206f 290a 0a20 2020 2020 2020  (ws, o)..       
+0001bd50: 2077 732e 6164 645f 746f 5f70 726f 6365   ws.add_to_proce
+0001bd60: 7373 696e 6728 7473 290a 2020 2020 2020  ssing(ts).      
+0001bd70: 2020 7473 2e70 726f 6365 7373 696e 675f    ts.processing_
+0001bd80: 6f6e 203d 2077 730a 2020 2020 2020 2020  on = ws.        
+0001bd90: 7473 2e73 7461 7465 203d 2022 7072 6f63  ts.state = "proc
+0001bda0: 6573 7369 6e67 220a 2020 2020 2020 2020  essing".        
+0001bdb0: 7365 6c66 2e61 6371 7569 7265 5f72 6573  self.acquire_res
+0001bdc0: 6f75 7263 6573 2874 732c 2077 7329 0a20  ources(ts, ws). 
+0001bdd0: 2020 2020 2020 2073 656c 662e 6368 6563         self.chec
+0001bde0: 6b5f 6964 6c65 5f73 6174 7572 6174 6564  k_idle_saturated
+0001bdf0: 2877 7329 0a20 2020 2020 2020 2073 656c  (ws).        sel
+0001be00: 662e 6e5f 7461 736b 7320 2b3d 2031 0a0a  f.n_tasks += 1..
+0001be10: 2020 2020 2020 2020 6966 2074 732e 6163          if ts.ac
+0001be20: 746f 723a 0a20 2020 2020 2020 2020 2020  tor:.           
+0001be30: 2077 732e 6163 746f 7273 2e61 6464 2874   ws.actors.add(t
+0001be40: 7329 0a0a 2020 2020 2020 2020 6e64 6570  s)..        ndep
+0001be50: 5f62 7974 6573 203d 2073 756d 2864 7473  _bytes = sum(dts
+0001be60: 2e6e 6279 7465 7320 666f 7220 6474 7320  .nbytes for dts 
+0001be70: 696e 2074 732e 6465 7065 6e64 656e 6369  in ts.dependenci
+0001be80: 6573 290a 2020 2020 2020 2020 6966 2028  es).        if (
+0001be90: 0a20 2020 2020 2020 2020 2020 2077 732e  .            ws.
+0001bea0: 6d65 6d6f 7279 5f6c 696d 6974 0a20 2020  memory_limit.   
+0001beb0: 2020 2020 2020 2020 2061 6e64 206e 6465           and nde
+0001bec0: 705f 6279 7465 7320 3e20 7773 2e6d 656d  p_bytes > ws.mem
+0001bed0: 6f72 795f 6c69 6d69 740a 2020 2020 2020  ory_limit.      
+0001bee0: 2020 2020 2020 616e 6420 6461 736b 2e63        and dask.c
+0001bef0: 6f6e 6669 672e 6765 7428 2264 6973 7472  onfig.get("distr
+0001bf00: 6962 7574 6564 2e77 6f72 6b65 722e 6d65  ibuted.worker.me
+0001bf10: 6d6f 7279 2e74 6572 6d69 6e61 7465 2229  mory.terminate")
+0001bf20: 0a20 2020 2020 2020 2029 3a0a 2020 2020  .        ):.    
+0001bf30: 2020 2020 2020 2020 2320 4e6f 7465 0a20          # Note. 
+0001bf40: 2020 2020 2020 2020 2020 2023 202d 2d2d             # ---
+0001bf50: 2d0a 2020 2020 2020 2020 2020 2020 2320  -.            # 
+0001bf60: 5468 6973 2069 7320 6120 6372 7564 6520  This is a crude 
+0001bf70: 7361 6665 7479 2073 7973 7465 6d2c 206f  safety system, o
+0001bf80: 6e6c 7920 6d65 616e 7420 746f 2070 7265  nly meant to pre
+0001bf90: 7665 6e74 206f 7264 6572 2d6f 662d 6d61  vent order-of-ma
+0001bfa0: 676e 6974 7564 650a 2020 2020 2020 2020  gnitude.        
+0001bfb0: 2020 2020 2320 6661 742d 6669 6e67 6572      # fat-finger
+0001bfc0: 2065 7272 6f72 732e 0a20 2020 2020 2020   errors..       
+0001bfd0: 2020 2020 2023 0a20 2020 2020 2020 2020       #.         
+0001bfe0: 2020 2023 2046 6f72 2063 6f6c 6c65 6374     # For collect
+0001bff0: 696f 6e20 6669 6e61 6c69 7a65 7273 2061  ion finalizers a
+0001c000: 6e64 2069 6e20 6765 6e65 7261 6c20 6d6f  nd in general mo
+0001c010: 7374 2063 6f6e 6361 7420 6f70 6572 6174  st concat operat
+0001c020: 696f 6e73 2c20 6974 2074 616b 6573 0a20  ions, it takes. 
+0001c030: 2020 2020 2020 2020 2020 2023 2061 206c             # a l
+0001c040: 6f74 206c 6573 7320 746f 206b 696c 6c20  ot less to kill 
+0001c050: 6f66 6620 7468 6520 776f 726b 6572 3b20  off the worker; 
+0001c060: 796f 7527 6c6c 206a 7573 7420 6e65 6564  you'll just need
+0001c070: 0a20 2020 2020 2020 2020 2020 2023 206e  .            # n
+0001c080: 6465 705f 6279 7465 7320 2a20 3220 3e20  dep_bytes * 2 > 
+0001c090: 7773 2e6d 656d 6f72 795f 6c69 6d69 7420  ws.memory_limit 
+0001c0a0: 2a20 7465 726d 696e 6174 6520 7468 7265  * terminate thre
+0001c0b0: 7368 6f6c 642e 0a20 2020 2020 2020 2020  shold..         
+0001c0c0: 2020 2023 0a20 2020 2020 2020 2020 2020     #.           
+0001c0d0: 2023 2049 6e20 6865 7465 726f 6765 6e65   # In heterogene
+0001c0e0: 6f75 7320 636c 7573 7465 7273 2077 6974  ous clusters wit
+0001c0f0: 6820 776f 726b 6572 7320 6d6f 756e 7469  h workers mounti
+0001c100: 6e67 2064 6966 6665 7265 6e74 2061 6d6f  ng different amo
+0001c110: 756e 7473 206f 660a 2020 2020 2020 2020  unts of.        
+0001c120: 2020 2020 2320 6d65 6d6f 7279 2c20 7468      # memory, th
+0001c130: 6520 7573 6572 2069 7320 6578 7065 6374  e user is expect
+0001c140: 6564 2074 6f20 6d61 6e75 616c 6c79 2073  ed to manually s
+0001c150: 6574 2068 6f73 742f 776f 726b 6572 2f72  et host/worker/r
+0001c160: 6573 6f75 7263 650a 2020 2020 2020 2020  esource.        
+0001c170: 2020 2020 2320 7265 7374 7269 6374 696f      # restrictio
+0001c180: 6e73 2e0a 2020 2020 2020 2020 2020 2020  ns..            
+0001c190: 6d73 6720 3d20 280a 2020 2020 2020 2020  msg = (.        
+0001c1a0: 2020 2020 2020 2020 6622 5461 736b 207b          f"Task {
+0001c1b0: 7473 2e6b 6579 2172 7d20 6861 7320 7b66  ts.key!r} has {f
+0001c1c0: 6f72 6d61 745f 6279 7465 7328 6e64 6570  ormat_bytes(ndep
+0001c1d0: 5f62 7974 6573 297d 2077 6f72 7468 206f  _bytes)} worth o
+0001c1e0: 6620 696e 7075 7420 220a 2020 2020 2020  f input ".      
+0001c1f0: 2020 2020 2020 2020 2020 6622 6465 7065            f"depe
+0001c200: 6e64 656e 6369 6573 2c20 6275 7420 776f  ndencies, but wo
+0001c210: 726b 6572 207b 7773 2e61 6464 7265 7373  rker {ws.address
+0001c220: 7d20 6861 7320 6d65 6d6f 7279 5f6c 696d  } has memory_lim
+0001c230: 6974 2073 6574 2074 6f20 220a 2020 2020  it set to ".    
+0001c240: 2020 2020 2020 2020 2020 2020 6622 7b66              f"{f
+0001c250: 6f72 6d61 745f 6279 7465 7328 7773 2e6d  ormat_bytes(ws.m
+0001c260: 656d 6f72 795f 6c69 6d69 7429 7d2e 220a  emory_limit)}.".
+0001c270: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0001c280: 2020 2020 2020 2020 2020 6966 2074 732e            if ts.
+0001c290: 7072 6566 6978 2e6e 616d 6520 3d3d 2022  prefix.name == "
+0001c2a0: 6669 6e61 6c69 7a65 223a 0a20 2020 2020  finalize":.     
+0001c2b0: 2020 2020 2020 2020 2020 206d 7367 202b             msg +
+0001c2c0: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+0001c2d0: 2020 2020 2020 2020 2220 4974 2073 6565          " It see
+0001c2e0: 6d73 206c 696b 6520 796f 7520 6361 6c6c  ms like you call
+0001c2f0: 6564 2063 6c69 656e 742e 636f 6d70 7574  ed client.comput
+0001c300: 6528 2920 6f6e 2061 2068 7567 6520 636f  e() on a huge co
+0001c310: 6c6c 6563 7469 6f6e 2e20 220a 2020 2020  llection. ".    
+0001c320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c330: 2243 6f6e 7369 6465 7220 7772 6974 696e  "Consider writin
+0001c340: 6720 746f 2064 6973 7472 6962 7574 6564  g to distributed
+0001c350: 2073 746f 7261 6765 206f 7220 736c 6963   storage or slic
+0001c360: 696e 672f 7265 6475 6369 6e67 2066 6972  ing/reducing fir
+0001c370: 7374 2e22 0a20 2020 2020 2020 2020 2020  st.".           
+0001c380: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0001c390: 2020 206c 6f67 6765 722e 6572 726f 7228     logger.error(
+0001c3a0: 6d73 6729 0a20 2020 2020 2020 2020 2020  msg).           
+0001c3b0: 2072 6574 7572 6e20 7365 6c66 2e5f 7472   return self._tr
+0001c3c0: 616e 7369 7469 6f6e 280a 2020 2020 2020  ansition(.      
+0001c3d0: 2020 2020 2020 2020 2020 7473 2e6b 6579            ts.key
+0001c3e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001c3f0: 2020 2265 7272 6564 222c 0a20 2020 2020    "erred",.     
+0001c400: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+0001c410: 7469 6f6e 3d70 6963 6b6c 652e 6475 6d70  tion=pickle.dump
+0001c420: 7328 4d65 6d6f 7279 4572 726f 7228 6d73  s(MemoryError(ms
+0001c430: 6729 292c 0a20 2020 2020 2020 2020 2020  g)),.           
+0001c440: 2020 2020 2063 6175 7365 3d74 732e 6b65       cause=ts.ke
+0001c450: 792c 0a20 2020 2020 2020 2020 2020 2020  y,.             
+0001c460: 2020 2073 7469 6d75 6c75 735f 6964 3d73     stimulus_id=s
+0001c470: 7469 6d75 6c75 735f 6964 2c0a 2020 2020  timulus_id,.    
+0001c480: 2020 2020 2020 2020 2020 2020 776f 726b              work
+0001c490: 6572 3d77 732e 6164 6472 6573 732c 0a20  er=ws.address,. 
+0001c4a0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+0001c4b0: 2020 2020 2020 7265 7475 726e 207b 7d2c        return {},
+0001c4c0: 207b 7d2c 207b 7773 2e61 6464 7265 7373   {}, {ws.address
+0001c4d0: 3a20 5b73 656c 662e 5f74 6173 6b5f 746f  : [self._task_to
+0001c4e0: 5f6d 7367 2874 7329 5d7d 0a0a 2020 2020  _msg(ts)]}..    
+0001c4f0: 6465 6620 5f65 7869 745f 7072 6f63 6573  def _exit_proces
+0001c500: 7369 6e67 5f63 6f6d 6d6f 6e28 7365 6c66  sing_common(self
+0001c510: 2c20 7473 3a20 5461 736b 5374 6174 6529  , ts: TaskState)
+0001c520: 202d 3e20 576f 726b 6572 5374 6174 6520   -> WorkerState 
+0001c530: 7c20 4e6f 6e65 3a0a 2020 2020 2020 2020  | None:.        
+0001c540: 2222 2252 656d 6f76 6520 2a74 732a 2066  """Remove *ts* f
+0001c550: 726f 6d20 7468 6520 7365 7420 6f66 2070  rom the set of p
+0001c560: 726f 6365 7373 696e 6720 7461 736b 732e  rocessing tasks.
+0001c570: 0a0a 2020 2020 2020 2020 5265 7475 726e  ..        Return
+0001c580: 730a 2020 2020 2020 2020 2d2d 2d2d 2d2d  s.        ------
+0001c590: 2d0a 2020 2020 2020 2020 576f 726b 6572  -.        Worker
+0001c5a0: 2073 7461 7465 206f 6620 7468 6520 776f   state of the wo
+0001c5b0: 726b 6572 2074 6861 7420 7072 6f63 6573  rker that proces
+0001c5c0: 7365 6420 2a74 732a 2069 6620 7468 6520  sed *ts* if the 
+0001c5d0: 776f 726b 6572 2069 7320 6375 7272 656e  worker is curren
+0001c5e0: 742c 0a20 2020 2020 2020 204e 6f6e 6520  t,.        None 
+0001c5f0: 6966 2074 6865 2077 6f72 6b65 7220 6973  if the worker is
+0001c600: 2073 7461 6c65 2e0a 0a20 2020 2020 2020   stale...       
+0001c610: 2053 6565 2061 6c73 6f0a 2020 2020 2020   See also.      
+0001c620: 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020    --------.     
+0001c630: 2020 2053 6368 6564 756c 6572 2e5f 7365     Scheduler._se
+0001c640: 745f 6475 7261 7469 6f6e 5f65 7374 696d  t_duration_estim
+0001c650: 6174 650a 2020 2020 2020 2020 2222 220a  ate.        """.
+0001c660: 2020 2020 2020 2020 7773 203d 2074 732e          ws = ts.
+0001c670: 7072 6f63 6573 7369 6e67 5f6f 6e0a 2020  processing_on.  
+0001c680: 2020 2020 2020 6173 7365 7274 2077 730a        assert ws.
+0001c690: 2020 2020 2020 2020 7473 2e70 726f 6365          ts.proce
+0001c6a0: 7373 696e 675f 6f6e 203d 204e 6f6e 650a  ssing_on = None.
+0001c6b0: 0a20 2020 2020 2020 2077 732e 7265 6d6f  .        ws.remo
+0001c6c0: 7665 5f66 726f 6d5f 7072 6f63 6573 7369  ve_from_processi
+0001c6d0: 6e67 2874 7329 0a20 2020 2020 2020 2069  ng(ts).        i
+0001c6e0: 6620 7365 6c66 2e77 6f72 6b65 7273 2e67  f self.workers.g
+0001c6f0: 6574 2877 732e 6164 6472 6573 7329 2069  et(ws.address) i
+0001c700: 7320 6e6f 7420 7773 3a20 2023 206d 6179  s not ws:  # may
+0001c710: 2068 6176 6520 6265 656e 2072 656d 6f76   have been remov
+0001c720: 6564 0a20 2020 2020 2020 2020 2020 2072  ed.            r
+0001c730: 6574 7572 6e20 4e6f 6e65 0a0a 2020 2020  eturn None..    
+0001c740: 2020 2020 7365 6c66 2e63 6865 636b 5f69      self.check_i
+0001c750: 646c 655f 7361 7475 7261 7465 6428 7773  dle_saturated(ws
+0001c760: 290a 2020 2020 2020 2020 7365 6c66 2e72  ).        self.r
+0001c770: 656c 6561 7365 5f72 6573 6f75 7263 6573  elease_resources
+0001c780: 2874 732c 2077 7329 0a0a 2020 2020 2020  (ts, ws)..      
+0001c790: 2020 7265 7475 726e 2077 730a 0a20 2020    return ws..   
+0001c7a0: 2064 6566 205f 6164 645f 746f 5f6d 656d   def _add_to_mem
+0001c7b0: 6f72 7928 0a20 2020 2020 2020 2073 656c  ory(.        sel
+0001c7c0: 662c 0a20 2020 2020 2020 2074 733a 2054  f,.        ts: T
+0001c7d0: 6173 6b53 7461 7465 2c0a 2020 2020 2020  askState,.      
+0001c7e0: 2020 7773 3a20 576f 726b 6572 5374 6174    ws: WorkerStat
+0001c7f0: 652c 0a20 2020 2020 2020 2072 6563 6f6d  e,.        recom
+0001c800: 6d65 6e64 6174 696f 6e73 3a20 5265 6373  mendations: Recs
+0001c810: 2c0a 2020 2020 2020 2020 636c 6965 6e74  ,.        client
+0001c820: 5f6d 7367 733a 204d 7367 732c 0a20 2020  _msgs: Msgs,.   
+0001c830: 2020 2020 2074 7970 653a 2062 7974 6573       type: bytes
+0001c840: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
+0001c850: 2020 2020 2020 2020 7479 7065 6e61 6d65          typename
+0001c860: 3a20 7374 7220 7c20 4e6f 6e65 203d 204e  : str | None = N
+0001c870: 6f6e 652c 0a20 2020 2029 202d 3e20 4e6f  one,.    ) -> No
+0001c880: 6e65 3a0a 2020 2020 2020 2020 2222 2241  ne:.        """A
+0001c890: 6464 2074 7320 746f 2074 6865 2073 6574  dd ts to the set
+0001c8a0: 206f 6620 696e 2d6d 656d 6f72 7920 7461   of in-memory ta
+0001c8b0: 736b 7322 2222 0a20 2020 2020 2020 2069  sks""".        i
+0001c8c0: 6620 7365 6c66 2e76 616c 6964 6174 653a  f self.validate:
+0001c8d0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0001c8e0: 6572 7420 7473 206e 6f74 2069 6e20 7773  ert ts not in ws
+0001c8f0: 2e68 6173 5f77 6861 740a 0a20 2020 2020  .has_what..     
+0001c900: 2020 2073 656c 662e 6164 645f 7265 706c     self.add_repl
+0001c910: 6963 6128 7473 2c20 7773 290a 0a20 2020  ica(ts, ws)..   
+0001c920: 2020 2020 2064 6570 7320 3d20 6c69 7374       deps = list
+0001c930: 2874 732e 6465 7065 6e64 656e 7473 290a  (ts.dependents).
+0001c940: 2020 2020 2020 2020 6966 206c 656e 2864          if len(d
+0001c950: 6570 7329 203e 2031 3a0a 2020 2020 2020  eps) > 1:.      
+0001c960: 2020 2020 2020 6465 7073 2e73 6f72 7428        deps.sort(
+0001c970: 6b65 793d 6f70 6572 6174 6f72 2e61 7474  key=operator.att
+0001c980: 7267 6574 7465 7228 2270 7269 6f72 6974  rgetter("priorit
+0001c990: 7922 292c 2072 6576 6572 7365 3d54 7275  y"), reverse=Tru
+0001c9a0: 6529 0a0a 2020 2020 2020 2020 666f 7220  e)..        for 
+0001c9b0: 6474 7320 696e 2064 6570 733a 0a20 2020  dts in deps:.   
+0001c9c0: 2020 2020 2020 2020 2073 203d 2064 7473           s = dts
+0001c9d0: 2e77 6169 7469 6e67 5f6f 6e0a 2020 2020  .waiting_on.    
+0001c9e0: 2020 2020 2020 2020 6966 2073 2061 6e64          if s and
+0001c9f0: 2074 7320 696e 2073 3a0a 2020 2020 2020   ts in s:.      
+0001ca00: 2020 2020 2020 2020 2020 732e 6469 7363            s.disc
+0001ca10: 6172 6428 7473 290a 2020 2020 2020 2020  ard(ts).        
+0001ca20: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
+0001ca30: 3a20 2023 206e 6577 2074 6173 6b20 7265  :  # new task re
+0001ca40: 6164 7920 746f 2072 756e 0a20 2020 2020  ady to run.     
+0001ca50: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0001ca60: 6563 6f6d 6d65 6e64 6174 696f 6e73 5b64  ecommendations[d
+0001ca70: 7473 2e6b 6579 5d20 3d20 2270 726f 6365  ts.key] = "proce
+0001ca80: 7373 696e 6722 0a0a 2020 2020 2020 2020  ssing"..        
+0001ca90: 666f 7220 6474 7320 696e 2074 732e 6465  for dts in ts.de
+0001caa0: 7065 6e64 656e 6369 6573 3a0a 2020 2020  pendencies:.    
+0001cab0: 2020 2020 2020 2020 7320 3d20 6474 732e          s = dts.
+0001cac0: 7761 6974 6572 730a 2020 2020 2020 2020  waiters.        
+0001cad0: 2020 2020 6966 2073 3a0a 2020 2020 2020      if s:.      
+0001cae0: 2020 2020 2020 2020 2020 732e 6469 7363            s.disc
+0001caf0: 6172 6428 7473 290a 2020 2020 2020 2020  ard(ts).        
+0001cb00: 2020 2020 6966 206e 6f74 2073 2061 6e64      if not s and
+0001cb10: 206e 6f74 2064 7473 2e77 686f 5f77 616e   not dts.who_wan
+0001cb20: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
+0001cb30: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
+0001cb40: 6f6e 735b 6474 732e 6b65 795d 203d 2022  ons[dts.key] = "
+0001cb50: 7265 6c65 6173 6564 220a 0a20 2020 2020  released"..     
+0001cb60: 2020 2069 6620 6e6f 7420 7473 2e77 6169     if not ts.wai
+0001cb70: 7465 7273 2061 6e64 206e 6f74 2074 732e  ters and not ts.
+0001cb80: 7768 6f5f 7761 6e74 733a 0a20 2020 2020  who_wants:.     
+0001cb90: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
+0001cba0: 6174 696f 6e73 5b74 732e 6b65 795d 203d  ations[ts.key] =
+0001cbb0: 2022 7265 6c65 6173 6564 220a 2020 2020   "released".    
+0001cbc0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0001cbd0: 2020 2020 2020 7265 706f 7274 5f6d 7367        report_msg
+0001cbe0: 3a20 6469 6374 5b73 7472 2c20 416e 795d  : dict[str, Any]
+0001cbf0: 203d 207b 226f 7022 3a20 226b 6579 2d69   = {"op": "key-i
+0001cc00: 6e2d 6d65 6d6f 7279 222c 2022 6b65 7922  n-memory", "key"
+0001cc10: 3a20 7473 2e6b 6579 7d0a 2020 2020 2020  : ts.key}.      
+0001cc20: 2020 2020 2020 6966 2074 7970 6520 6973        if type is
+0001cc30: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+0001cc40: 2020 2020 2020 2020 2020 2072 6570 6f72             repor
+0001cc50: 745f 6d73 675b 2274 7970 6522 5d20 3d20  t_msg["type"] = 
+0001cc60: 7479 7065 0a20 2020 2020 2020 2020 2020  type.           
+0001cc70: 2066 6f72 2063 7320 696e 2074 732e 7768   for cs in ts.wh
+0001cc80: 6f5f 7761 6e74 7320 6f72 2028 293a 0a20  o_wants or ():. 
+0001cc90: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0001cca0: 6c69 656e 745f 6d73 6773 5b63 732e 636c  lient_msgs[cs.cl
+0001ccb0: 6965 6e74 5f6b 6579 5d20 3d20 5b72 6570  ient_key] = [rep
+0001ccc0: 6f72 745f 6d73 675d 0a0a 2020 2020 2020  ort_msg]..      
+0001ccd0: 2020 7473 2e73 7461 7465 203d 2022 6d65    ts.state = "me
+0001cce0: 6d6f 7279 220a 2020 2020 2020 2020 7473  mory".        ts
+0001ccf0: 2e74 7970 6520 3d20 7479 7065 6e61 6d65  .type = typename
+0001cd00: 2020 2320 7479 7065 3a20 6967 6e6f 7265    # type: ignore
+0001cd10: 0a20 2020 2020 2020 2074 732e 6772 6f75  .        ts.grou
+0001cd20: 702e 7479 7065 732e 6164 6428 7479 7065  p.types.add(type
+0001cd30: 6e61 6d65 2920 2023 2074 7970 653a 2069  name)  # type: i
+0001cd40: 676e 6f72 650a 0a20 2020 2020 2020 2063  gnore..        c
+0001cd50: 7320 3d20 7365 6c66 2e63 6c69 656e 7473  s = self.clients
+0001cd60: 5b22 6669 7265 2d61 6e64 2d66 6f72 6765  ["fire-and-forge
+0001cd70: 7422 5d0a 2020 2020 2020 2020 6966 2074  t"].        if t
+0001cd80: 7320 696e 2063 732e 7761 6e74 735f 7768  s in cs.wants_wh
+0001cd90: 6174 3a0a 2020 2020 2020 2020 2020 2020  at:.            
+0001cda0: 7365 6c66 2e5f 636c 6965 6e74 5f72 656c  self._client_rel
+0001cdb0: 6561 7365 735f 6b65 7973 280a 2020 2020  eases_keys(.    
+0001cdc0: 2020 2020 2020 2020 2020 2020 6373 3d63              cs=c
+0001cdd0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+0001cde0: 2020 206b 6579 733d 5b74 732e 6b65 795d     keys=[ts.key]
+0001cdf0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001ce00: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
+0001ce10: 733d 7265 636f 6d6d 656e 6461 7469 6f6e  s=recommendation
+0001ce20: 732c 0a20 2020 2020 2020 2020 2020 2029  s,.            )
+0001ce30: 0a0a 2020 2020 6465 6620 5f70 726f 7061  ..    def _propa
+0001ce40: 6761 7465 5f72 656c 6561 7365 6428 7365  gate_released(se
+0001ce50: 6c66 2c20 7473 3a20 5461 736b 5374 6174  lf, ts: TaskStat
+0001ce60: 652c 2072 6563 6f6d 6d65 6e64 6174 696f  e, recommendatio
+0001ce70: 6e73 3a20 5265 6373 2920 2d3e 204e 6f6e  ns: Recs) -> Non
+0001ce80: 653a 0a20 2020 2020 2020 2074 732e 7374  e:.        ts.st
+0001ce90: 6174 6520 3d20 2272 656c 6561 7365 6422  ate = "released"
+0001cea0: 0a20 2020 2020 2020 206b 6579 203d 2074  .        key = t
+0001ceb0: 732e 6b65 790a 0a20 2020 2020 2020 2069  s.key..        i
+0001cec0: 6620 7473 2e68 6173 5f6c 6f73 745f 6465  f ts.has_lost_de
+0001ced0: 7065 6e64 656e 6369 6573 3a0a 2020 2020  pendencies:.    
+0001cee0: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
+0001cef0: 6461 7469 6f6e 735b 6b65 795d 203d 2022  dations[key] = "
+0001cf00: 666f 7267 6f74 7465 6e22 0a20 2020 2020  forgotten".     
+0001cf10: 2020 2065 6c69 6620 7473 2e77 6169 7465     elif ts.waite
+0001cf20: 7273 206f 7220 7473 2e77 686f 5f77 616e  rs or ts.who_wan
+0001cf30: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
+0001cf40: 7265 636f 6d6d 656e 6461 7469 6f6e 735b  recommendations[
+0001cf50: 6b65 795d 203d 2022 7761 6974 696e 6722  key] = "waiting"
+0001cf60: 0a0a 2020 2020 2020 2020 6966 2072 6563  ..        if rec
+0001cf70: 6f6d 6d65 6e64 6174 696f 6e73 2e67 6574  ommendations.get
+0001cf80: 286b 6579 2920 213d 2022 7761 6974 696e  (key) != "waitin
+0001cf90: 6722 3a0a 2020 2020 2020 2020 2020 2020  g":.            
+0001cfa0: 666f 7220 6474 7320 696e 2074 732e 6465  for dts in ts.de
+0001cfb0: 7065 6e64 656e 6369 6573 3a0a 2020 2020  pendencies:.    
+0001cfc0: 2020 2020 2020 2020 2020 2020 6966 2064              if d
+0001cfd0: 7473 2e73 7461 7465 2021 3d20 2272 656c  ts.state != "rel
+0001cfe0: 6561 7365 6422 3a0a 2020 2020 2020 2020  eased":.        
+0001cff0: 2020 2020 2020 2020 2020 2020 6966 2064              if d
+0001d000: 7473 2e77 6169 7465 7273 3a0a 2020 2020  ts.waiters:.    
+0001d010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d020: 2020 2020 6474 732e 7761 6974 6572 732e      dts.waiters.
+0001d030: 6469 7363 6172 6428 7473 290a 2020 2020  discard(ts).    
+0001d040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d050: 6966 206e 6f74 2064 7473 2e77 6169 7465  if not dts.waite
+0001d060: 7273 2061 6e64 206e 6f74 2064 7473 2e77  rs and not dts.w
+0001d070: 686f 5f77 616e 7473 3a0a 2020 2020 2020  ho_wants:.      
+0001d080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d090: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
+0001d0a0: 735b 6474 732e 6b65 795d 203d 2022 7265  s[dts.key] = "re
+0001d0b0: 6c65 6173 6564 220a 2020 2020 2020 2020  leased".        
+0001d0c0: 2020 2020 7473 2e77 6169 7465 7273 203d      ts.waiters =
+0001d0d0: 204e 6f6e 650a 0a20 2020 2020 2020 2069   None..        i
+0001d0e0: 6620 7365 6c66 2e76 616c 6964 6174 653a  f self.validate:
+0001d0f0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0001d100: 6572 7420 6e6f 7420 7473 2e70 726f 6365  ert not ts.proce
+0001d110: 7373 696e 675f 6f6e 0a20 2020 2020 2020  ssing_on.       
+0001d120: 2020 2020 2061 7373 6572 7420 7473 206e       assert ts n
+0001d130: 6f74 2069 6e20 7365 6c66 2e71 7565 7565  ot in self.queue
+0001d140: 640a 0a20 2020 2064 6566 205f 7072 6f70  d..    def _prop
+0001d150: 6167 6174 655f 666f 7267 6f74 7465 6e28  agate_forgotten(
+0001d160: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+0001d170: 2020 2020 2020 2074 733a 2054 6173 6b53         ts: TaskS
+0001d180: 7461 7465 2c0a 2020 2020 2020 2020 7265  tate,.        re
+0001d190: 636f 6d6d 656e 6461 7469 6f6e 733a 2052  commendations: R
+0001d1a0: 6563 732c 0a20 2020 2020 2020 2077 6f72  ecs,.        wor
+0001d1b0: 6b65 725f 6d73 6773 3a20 4d73 6773 2c0a  ker_msgs: Msgs,.
+0001d1c0: 2020 2020 2020 2020 7374 696d 756c 7573          stimulus
+0001d1d0: 5f69 643a 2073 7472 2c0a 2020 2020 2920  _id: str,.    ) 
+0001d1e0: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+0001d1f0: 2074 732e 7374 6174 6520 3d20 2266 6f72   ts.state = "for
+0001d200: 676f 7474 656e 220a 2020 2020 2020 2020  gotten".        
+0001d210: 666f 7220 6474 7320 696e 2074 732e 6465  for dts in ts.de
+0001d220: 7065 6e64 656e 7473 3a0a 2020 2020 2020  pendents:.      
+0001d230: 2020 2020 2020 6474 732e 6861 735f 6c6f        dts.has_lo
+0001d240: 7374 5f64 6570 656e 6465 6e63 6965 7320  st_dependencies 
+0001d250: 3d20 5472 7565 0a20 2020 2020 2020 2020  = True.         
+0001d260: 2020 2064 7473 2e64 6570 656e 6465 6e63     dts.dependenc
+0001d270: 6965 732e 7265 6d6f 7665 2874 7329 0a20  ies.remove(ts). 
+0001d280: 2020 2020 2020 2020 2020 2069 6620 6474             if dt
+0001d290: 732e 7761 6974 696e 675f 6f6e 3a0a 2020  s.waiting_on:.  
+0001d2a0: 2020 2020 2020 2020 2020 2020 2020 6474                dt
+0001d2b0: 732e 7761 6974 696e 675f 6f6e 2e64 6973  s.waiting_on.dis
+0001d2c0: 6361 7264 2874 7329 0a20 2020 2020 2020  card(ts).       
+0001d2d0: 2020 2020 2069 6620 6474 732e 7374 6174       if dts.stat
+0001d2e0: 6520 6e6f 7420 696e 2028 226d 656d 6f72  e not in ("memor
+0001d2f0: 7922 2c20 2265 7272 6564 2229 3a0a 2020  y", "erred"):.  
+0001d300: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0001d310: 4361 6e6e 6f74 2063 6f6d 7075 7465 2074  Cannot compute t
+0001d320: 6173 6b20 616e 796d 6f72 650a 2020 2020  ask anymore.    
+0001d330: 2020 2020 2020 2020 2020 2020 7265 636f              reco
+0001d340: 6d6d 656e 6461 7469 6f6e 735b 6474 732e  mmendations[dts.
+0001d350: 6b65 795d 203d 2022 666f 7267 6f74 7465  key] = "forgotte
+0001d360: 6e22 0a20 2020 2020 2020 2074 732e 6465  n".        ts.de
+0001d370: 7065 6e64 656e 7473 2e63 6c65 6172 2829  pendents.clear()
+0001d380: 0a20 2020 2020 2020 2074 732e 7761 6974  .        ts.wait
+0001d390: 6572 7320 3d20 4e6f 6e65 0a0a 2020 2020  ers = None..    
+0001d3a0: 2020 2020 666f 7220 6474 7320 696e 2074      for dts in t
+0001d3b0: 732e 6465 7065 6e64 656e 6369 6573 3a0a  s.dependencies:.
+0001d3c0: 2020 2020 2020 2020 2020 2020 6474 732e              dts.
+0001d3d0: 6465 7065 6e64 656e 7473 2e72 656d 6f76  dependents.remov
+0001d3e0: 6528 7473 290a 2020 2020 2020 2020 2020  e(ts).          
+0001d3f0: 2020 6966 2064 7473 2e77 6169 7465 7273    if dts.waiters
+0001d400: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001d410: 2020 6474 732e 7761 6974 6572 732e 6469    dts.waiters.di
+0001d420: 7363 6172 6428 7473 290a 2020 2020 2020  scard(ts).      
+0001d430: 2020 2020 2020 6966 206e 6f74 2064 7473        if not dts
+0001d440: 2e64 6570 656e 6465 6e74 7320 616e 6420  .dependents and 
+0001d450: 6e6f 7420 6474 732e 7768 6f5f 7761 6e74  not dts.who_want
+0001d460: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0001d470: 2020 2023 2054 6173 6b20 6e6f 7420 6e65     # Task not ne
+0001d480: 6564 6564 2061 6e79 6d6f 7265 0a20 2020  eded anymore.   
+0001d490: 2020 2020 2020 2020 2020 2020 2061 7373               ass
+0001d4a0: 6572 7420 6474 7320 6973 206e 6f74 2074  ert dts is not t
+0001d4b0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+0001d4c0: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
+0001d4d0: 735b 6474 732e 6b65 795d 203d 2022 666f  s[dts.key] = "fo
+0001d4e0: 7267 6f74 7465 6e22 0a20 2020 2020 2020  rgotten".       
+0001d4f0: 2074 732e 6465 7065 6e64 656e 6369 6573   ts.dependencies
+0001d500: 2e63 6c65 6172 2829 0a20 2020 2020 2020  .clear().       
+0001d510: 2074 732e 7761 6974 696e 675f 6f6e 203d   ts.waiting_on =
+0001d520: 204e 6f6e 650a 0a20 2020 2020 2020 2066   None..        f
+0001d530: 6f72 2077 7320 696e 2074 732e 7768 6f5f  or ws in ts.who_
+0001d540: 6861 7320 6f72 2028 293a 0a20 2020 2020  has or ():.     
+0001d550: 2020 2020 2020 2069 6620 7773 2e61 6464         if ws.add
+0001d560: 7265 7373 2069 6e20 7365 6c66 2e77 6f72  ress in self.wor
+0001d570: 6b65 7273 3a20 2023 2069 6e20 6361 7365  kers:  # in case
+0001d580: 2077 6f72 6b65 7220 6861 7320 6469 6564   worker has died
+0001d590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d5a0: 2077 6f72 6b65 725f 6d73 6773 5b77 732e   worker_msgs[ws.
+0001d5b0: 6164 6472 6573 735d 203d 205b 0a20 2020  address] = [.   
+0001d5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d5d0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0001d5e0: 2020 2020 2020 2020 2020 2022 6f70 223a             "op":
+0001d5f0: 2022 6672 6565 2d6b 6579 7322 2c0a 2020   "free-keys",.  
+0001d600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d610: 2020 2020 2020 226b 6579 7322 3a20 5b74        "keys": [t
+0001d620: 732e 6b65 795d 2c0a 2020 2020 2020 2020  s.key],.        
+0001d630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d640: 2273 7469 6d75 6c75 735f 6964 223a 2073  "stimulus_id": s
+0001d650: 7469 6d75 6c75 735f 6964 2c0a 2020 2020  timulus_id,.    
+0001d660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d670: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+0001d680: 2020 5d0a 2020 2020 2020 2020 7365 6c66    ].        self
+0001d690: 2e72 656d 6f76 655f 616c 6c5f 7265 706c  .remove_all_repl
+0001d6a0: 6963 6173 2874 7329 0a0a 2020 2020 6465  icas(ts)..    de
+0001d6b0: 6620 5f63 6c69 656e 745f 7265 6c65 6173  f _client_releas
+0001d6c0: 6573 5f6b 6579 7328 0a20 2020 2020 2020  es_keys(.       
+0001d6d0: 2073 656c 662c 0a20 2020 2020 2020 206b   self,.        k
+0001d6e0: 6579 733a 2043 6f6c 6c65 6374 696f 6e5b  eys: Collection[
+0001d6f0: 4b65 795d 2c0a 2020 2020 2020 2020 6373  Key],.        cs
+0001d700: 3a20 436c 6965 6e74 5374 6174 652c 0a20  : ClientState,. 
+0001d710: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
+0001d720: 6174 696f 6e73 3a20 5265 6373 2c0a 2020  ations: Recs,.  
+0001d730: 2020 2920 2d3e 204e 6f6e 653a 0a20 2020    ) -> None:.   
+0001d740: 2020 2020 2022 2222 5265 6d6f 7665 206b       """Remove k
+0001d750: 6579 7320 6672 6f6d 2063 6c69 656e 7420  eys from client 
+0001d760: 6465 7369 7265 6420 6c69 7374 2222 220a  desired list""".
+0001d770: 2020 2020 2020 2020 6c6f 6767 6572 2e64          logger.d
+0001d780: 6562 7567 2822 436c 6965 6e74 2025 7320  ebug("Client %s 
+0001d790: 7265 6c65 6173 6573 206b 6579 733a 2025  releases keys: %
+0001d7a0: 7322 2c20 6373 2e63 6c69 656e 745f 6b65  s", cs.client_ke
+0001d7b0: 792c 206b 6579 7329 0a20 2020 2020 2020  y, keys).       
+0001d7c0: 2066 6f72 206b 6579 2069 6e20 6b65 7973   for key in keys
+0001d7d0: 3a0a 2020 2020 2020 2020 2020 2020 7473  :.            ts
+0001d7e0: 203d 2073 656c 662e 7461 736b 732e 6765   = self.tasks.ge
+0001d7f0: 7428 6b65 7929 0a20 2020 2020 2020 2020  t(key).         
+0001d800: 2020 2069 6620 7473 2069 7320 6e6f 7420     if ts is not 
+0001d810: 4e6f 6e65 2061 6e64 2074 7320 696e 2063  None and ts in c
+0001d820: 732e 7761 6e74 735f 7768 6174 3a0a 2020  s.wants_what:.  
+0001d830: 2020 2020 2020 2020 2020 2020 2020 6373                cs
+0001d840: 2e77 616e 7473 5f77 6861 742e 7265 6d6f  .wants_what.remo
+0001d850: 7665 2874 7329 0a20 2020 2020 2020 2020  ve(ts).         
+0001d860: 2020 2020 2020 2069 6620 7473 2e77 686f         if ts.who
+0001d870: 5f77 616e 7473 3a0a 2020 2020 2020 2020  _wants:.        
+0001d880: 2020 2020 2020 2020 2020 2020 7473 2e77              ts.w
+0001d890: 686f 5f77 616e 7473 2e72 656d 6f76 6528  ho_wants.remove(
+0001d8a0: 6373 290a 2020 2020 2020 2020 2020 2020  cs).            
+0001d8b0: 2020 2020 6966 206e 6f74 2074 732e 7768      if not ts.wh
+0001d8c0: 6f5f 7761 6e74 733a 0a20 2020 2020 2020  o_wants:.       
+0001d8d0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0001d8e0: 6e6f 7420 7473 2e64 6570 656e 6465 6e74  not ts.dependent
+0001d8f0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0001d900: 2020 2020 2020 2020 2020 2023 204e 6f20             # No 
+0001d910: 6c69 7665 2064 6570 656e 6465 6e74 732c  live dependents,
+0001d920: 2063 616e 2066 6f72 6765 740a 2020 2020   can forget.    
+0001d930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d940: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
+0001d950: 6f6e 735b 7473 2e6b 6579 5d20 3d20 2266  ons[ts.key] = "f
+0001d960: 6f72 676f 7474 656e 220a 2020 2020 2020  orgotten".      
+0001d970: 2020 2020 2020 2020 2020 2020 2020 656c                el
+0001d980: 6966 2074 732e 7374 6174 6520 213d 2022  if ts.state != "
+0001d990: 6572 7265 6422 2061 6e64 206e 6f74 2074  erred" and not t
+0001d9a0: 732e 7761 6974 6572 733a 0a20 2020 2020  s.waiters:.     
+0001d9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d9c0: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
+0001d9d0: 6e73 5b74 732e 6b65 795d 203d 2022 7265  ns[ts.key] = "re
+0001d9e0: 6c65 6173 6564 220a 0a20 2020 2064 6566  leased"..    def
+0001d9f0: 205f 7461 736b 5f74 6f5f 6d73 6728 7365   _task_to_msg(se
+0001da00: 6c66 2c20 7473 3a20 5461 736b 5374 6174  lf, ts: TaskStat
+0001da10: 652c 2064 7572 6174 696f 6e3a 2066 6c6f  e, duration: flo
+0001da20: 6174 203d 202d 3129 202d 3e20 6469 6374  at = -1) -> dict
+0001da30: 5b73 7472 2c20 416e 795d 3a0a 2020 2020  [str, Any]:.    
+0001da40: 2020 2020 2222 2243 6f6e 7665 7274 2061      """Convert a
+0001da50: 2073 696e 676c 6520 636f 6d70 7574 6174   single computat
+0001da60: 696f 6e61 6c20 7461 736b 2074 6f20 6120  ional task to a 
+0001da70: 6d65 7373 6167 6522 2222 0a20 2020 2020  message""".     
+0001da80: 2020 2023 2046 4958 4d45 3a20 5468 6520     # FIXME: The 
+0001da90: 6475 7261 7469 6f6e 2061 7474 7269 6275  duration attribu
+0001daa0: 7465 2069 7320 6e6f 7420 7573 6564 206f  te is not used o
+0001dab0: 6e20 776f 726b 6572 2e20 5765 2063 6f75  n worker. We cou
+0001dac0: 6c64 2073 6176 6520 6f75 7273 656c 7665  ld save ourselve
+0001dad0: 7320 7468 650a 2020 2020 2020 2020 2320  s the.        # 
+0001dae0: 2020 2020 2020 2074 696d 6520 746f 2063         time to c
+0001daf0: 6f6d 7075 7465 2061 6e64 2073 7562 6d69  ompute and submi
+0001db00: 7420 7468 6973 0a20 2020 2020 2020 2069  t this.        i
+0001db10: 6620 6475 7261 7469 6f6e 203c 2030 3a0a  f duration < 0:.
+0001db20: 2020 2020 2020 2020 2020 2020 6475 7261              dura
+0001db30: 7469 6f6e 203d 2073 656c 662e 6765 745f  tion = self.get_
+0001db40: 7461 736b 5f64 7572 6174 696f 6e28 7473  task_duration(ts
+0001db50: 290a 2020 2020 2020 2020 7473 2e72 756e  ).        ts.run
+0001db60: 5f69 6420 3d20 6e65 7874 2854 6173 6b53  _id = next(TaskS
+0001db70: 7461 7465 2e5f 7275 6e5f 6964 5f69 7465  tate._run_id_ite
+0001db80: 7261 746f 7229 0a20 2020 2020 2020 2061  rator).        a
+0001db90: 7373 6572 7420 7473 2e70 7269 6f72 6974  ssert ts.priorit
+0001dba0: 792c 2074 730a 2020 2020 2020 2020 6d73  y, ts.        ms
+0001dbb0: 673a 2064 6963 745b 7374 722c 2041 6e79  g: dict[str, Any
+0001dbc0: 5d20 3d20 7b0a 2020 2020 2020 2020 2020  ] = {.          
+0001dbd0: 2020 226f 7022 3a20 2263 6f6d 7075 7465    "op": "compute
+0001dbe0: 2d74 6173 6b22 2c0a 2020 2020 2020 2020  -task",.        
+0001dbf0: 2020 2020 226b 6579 223a 2074 732e 6b65      "key": ts.ke
+0001dc00: 792c 0a20 2020 2020 2020 2020 2020 2022  y,.            "
+0001dc10: 7275 6e5f 6964 223a 2074 732e 7275 6e5f  run_id": ts.run_
+0001dc20: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
+0001dc30: 2270 7269 6f72 6974 7922 3a20 7473 2e70  "priority": ts.p
+0001dc40: 7269 6f72 6974 792c 0a20 2020 2020 2020  riority,.       
+0001dc50: 2020 2020 2022 6475 7261 7469 6f6e 223a       "duration":
+0001dc60: 2064 7572 6174 696f 6e2c 0a20 2020 2020   duration,.     
+0001dc70: 2020 2020 2020 2022 7374 696d 756c 7573         "stimulus
+0001dc80: 5f69 6422 3a20 6622 636f 6d70 7574 652d  _id": f"compute-
+0001dc90: 7461 736b 2d7b 7469 6d65 2829 7d22 2c0a  task-{time()}",.
+0001dca0: 2020 2020 2020 2020 2020 2020 2277 686f              "who
+0001dcb0: 5f68 6173 223a 207b 0a20 2020 2020 2020  _has": {.       
+0001dcc0: 2020 2020 2020 2020 2064 7473 2e6b 6579           dts.key
+0001dcd0: 3a20 5b77 732e 6164 6472 6573 7320 666f  : [ws.address fo
+0001dce0: 7220 7773 2069 6e20 6474 732e 7768 6f5f  r ws in dts.who_
+0001dcf0: 6861 7320 6f72 2028 295d 0a20 2020 2020  has or ()].     
+0001dd00: 2020 2020 2020 2020 2020 2066 6f72 2064             for d
+0001dd10: 7473 2069 6e20 7473 2e64 6570 656e 6465  ts in ts.depende
+0001dd20: 6e63 6965 730a 2020 2020 2020 2020 2020  ncies.          
+0001dd30: 2020 7d2c 0a20 2020 2020 2020 2020 2020    },.           
+0001dd40: 2022 6e62 7974 6573 223a 207b 6474 732e   "nbytes": {dts.
+0001dd50: 6b65 793a 2064 7473 2e6e 6279 7465 7320  key: dts.nbytes 
+0001dd60: 666f 7220 6474 7320 696e 2074 732e 6465  for dts in ts.de
+0001dd70: 7065 6e64 656e 6369 6573 7d2c 0a20 2020  pendencies},.   
+0001dd80: 2020 2020 2020 2020 2022 7275 6e5f 7370           "run_sp
+0001dd90: 6563 223a 2054 6f50 6963 6b6c 6528 7473  ec": ToPickle(ts
+0001dda0: 2e72 756e 5f73 7065 6329 2c0a 2020 2020  .run_spec),.    
+0001ddb0: 2020 2020 2020 2020 2272 6573 6f75 7263          "resourc
+0001ddc0: 655f 7265 7374 7269 6374 696f 6e73 223a  e_restrictions":
+0001ddd0: 2074 732e 7265 736f 7572 6365 5f72 6573   ts.resource_res
+0001dde0: 7472 6963 7469 6f6e 732c 0a20 2020 2020  trictions,.     
+0001ddf0: 2020 2020 2020 2022 6163 746f 7222 3a20         "actor": 
+0001de00: 7473 2e61 6374 6f72 2c0a 2020 2020 2020  ts.actor,.      
+0001de10: 2020 2020 2020 2261 6e6e 6f74 6174 696f        "annotatio
+0001de20: 6e73 223a 2074 732e 616e 6e6f 7461 7469  ns": ts.annotati
+0001de30: 6f6e 7320 6f72 207b 7d2c 0a20 2020 2020  ons or {},.     
+0001de40: 2020 2020 2020 2022 7370 616e 5f69 6422         "span_id"
+0001de50: 3a20 7473 2e67 726f 7570 2e73 7061 6e5f  : ts.group.span_
+0001de60: 6964 2c0a 2020 2020 2020 2020 7d0a 2020  id,.        }.  
+0001de70: 2020 2020 2020 6966 2073 656c 662e 7661        if self.va
+0001de80: 6c69 6461 7465 3a0a 2020 2020 2020 2020  lidate:.        
+0001de90: 2020 2020 6173 7365 7274 2061 6c6c 286d      assert all(m
+0001dea0: 7367 5b22 7768 6f5f 6861 7322 5d2e 7661  sg["who_has"].va
+0001deb0: 6c75 6573 2829 290a 0a20 2020 2020 2020  lues())..       
+0001dec0: 2072 6574 7572 6e20 6d73 670a 0a0a 636c   return msg...cl
+0001ded0: 6173 7320 5363 6865 6475 6c65 7228 5363  ass Scheduler(Sc
+0001dee0: 6865 6475 6c65 7253 7461 7465 2c20 5365  hedulerState, Se
+0001def0: 7276 6572 4e6f 6465 293a 0a20 2020 2022  rverNode):.    "
+0001df00: 2222 4479 6e61 6d69 6320 6469 7374 7269  ""Dynamic distri
+0001df10: 6275 7465 6420 7461 736b 2073 6368 6564  buted task sched
+0001df20: 756c 6572 0a0a 2020 2020 5468 6520 7363  uler..    The sc
+0001df30: 6865 6475 6c65 7220 7472 6163 6b73 2074  heduler tracks t
+0001df40: 6865 2063 7572 7265 6e74 2073 7461 7465  he current state
+0001df50: 206f 6620 776f 726b 6572 732c 2064 6174   of workers, dat
+0001df60: 612c 2061 6e64 2063 6f6d 7075 7461 7469  a, and computati
+0001df70: 6f6e 732e 0a20 2020 2054 6865 2073 6368  ons..    The sch
+0001df80: 6564 756c 6572 206c 6973 7465 6e73 2066  eduler listens f
+0001df90: 6f72 2065 7665 6e74 7320 616e 6420 7265  or events and re
+0001dfa0: 7370 6f6e 6473 2062 7920 636f 6e74 726f  sponds by contro
+0001dfb0: 6c6c 696e 6720 776f 726b 6572 730a 2020  lling workers.  
+0001dfc0: 2020 6170 7072 6f70 7269 6174 656c 792e    appropriately.
+0001dfd0: 2020 4974 2063 6f6e 7469 6e75 6f75 736c    It continuousl
+0001dfe0: 7920 7472 6965 7320 746f 2075 7365 2074  y tries to use t
+0001dff0: 6865 2077 6f72 6b65 7273 2074 6f20 6578  he workers to ex
+0001e000: 6563 7574 6520 616e 2065 7665 720a 2020  ecute an ever.  
+0001e010: 2020 6772 6f77 696e 6720 6461 736b 2067    growing dask g
+0001e020: 7261 7068 2e0a 0a20 2020 2041 6c6c 2065  raph...    All e
+0001e030: 7665 6e74 7320 6172 6520 6861 6e64 6c65  vents are handle
+0001e040: 6420 7175 6963 6b6c 792c 2069 6e20 6c69  d quickly, in li
+0001e050: 6e65 6172 2074 696d 6520 7769 7468 2072  near time with r
+0001e060: 6573 7065 6374 2074 6f20 7468 6569 7220  espect to their 
+0001e070: 696e 7075 740a 2020 2020 2877 6869 6368  input.    (which
+0001e080: 2069 7320 6f66 7465 6e20 6f66 2063 6f6e   is often of con
+0001e090: 7374 616e 7420 7369 7a65 2920 616e 6420  stant size) and 
+0001e0a0: 6765 6e65 7261 6c6c 7920 7769 7468 696e  generally within
+0001e0b0: 2061 206d 696c 6c69 7365 636f 6e64 2e20   a millisecond. 
+0001e0c0: 2054 6f0a 2020 2020 6163 636f 6d70 6c69   To.    accompli
+0001e0d0: 7368 2074 6869 7320 7468 6520 7363 6865  sh this the sche
+0001e0e0: 6475 6c65 7220 7472 6163 6b73 2061 206c  duler tracks a l
+0001e0f0: 6f74 206f 6620 7374 6174 652e 2020 4576  ot of state.  Ev
+0001e100: 6572 7920 6f70 6572 6174 696f 6e0a 2020  ery operation.  
+0001e110: 2020 6d61 696e 7461 696e 7320 7468 6520    maintains the 
+0001e120: 636f 6e73 6973 7465 6e63 7920 6f66 2074  consistency of t
+0001e130: 6869 7320 7374 6174 652e 0a0a 2020 2020  his state...    
+0001e140: 5468 6520 7363 6865 6475 6c65 7220 636f  The scheduler co
+0001e150: 6d6d 756e 6963 6174 6573 2077 6974 6820  mmunicates with 
+0001e160: 7468 6520 6f75 7473 6964 6520 776f 726c  the outside worl
+0001e170: 6420 7468 726f 7567 6820 436f 6d6d 206f  d through Comm o
+0001e180: 626a 6563 7473 2e0a 2020 2020 4974 206d  bjects..    It m
+0001e190: 6169 6e74 6169 6e73 2061 2063 6f6e 7369  aintains a consi
+0001e1a0: 7374 656e 7420 616e 6420 7661 6c69 6420  stent and valid 
+0001e1b0: 7669 6577 206f 6620 7468 6520 776f 726c  view of the worl
+0001e1c0: 6420 6576 656e 2077 6865 6e20 6c69 7374  d even when list
+0001e1d0: 656e 696e 670a 2020 2020 746f 2073 6576  ening.    to sev
+0001e1e0: 6572 616c 2063 6c69 656e 7473 2061 7420  eral clients at 
+0001e1f0: 6f6e 6365 2e0a 0a20 2020 2041 2053 6368  once...    A Sch
+0001e200: 6564 756c 6572 2069 7320 7479 7069 6361  eduler is typica
+0001e210: 6c6c 7920 7374 6172 7465 6420 6569 7468  lly started eith
+0001e220: 6572 2077 6974 6820 7468 6520 6060 6461  er with the ``da
+0001e230: 736b 2073 6368 6564 756c 6572 6060 0a20  sk scheduler``. 
+0001e240: 2020 2065 7865 6375 7461 626c 653a 3a0a     executable::.
+0001e250: 0a20 2020 2020 2020 2020 2420 6461 736b  .         $ dask
+0001e260: 2073 6368 6564 756c 6572 0a20 2020 2020   scheduler.     
+0001e270: 2020 2020 5363 6865 6475 6c65 7220 7374      Scheduler st
+0001e280: 6172 7465 6420 6174 2031 3237 2e30 2e30  arted at 127.0.0
+0001e290: 2e31 3a38 3738 360a 0a20 2020 204f 7220  .1:8786..    Or 
+0001e2a0: 7769 7468 696e 2061 204c 6f63 616c 436c  within a LocalCl
+0001e2b0: 7573 7465 7220 6120 436c 6965 6e74 2073  uster a Client s
+0001e2c0: 7461 7274 7320 7570 2077 6974 686f 7574  tarts up without
+0001e2d0: 2063 6f6e 6e65 6374 696f 6e0a 2020 2020   connection.    
+0001e2e0: 696e 666f 726d 6174 696f 6e3a 3a0a 0a20  information::.. 
+0001e2f0: 2020 2020 2020 203e 3e3e 2063 203d 2043         >>> c = C
+0001e300: 6c69 656e 7428 2920 2023 2064 6f63 7465  lient()  # docte
+0001e310: 7374 3a20 2b53 4b49 500a 2020 2020 2020  st: +SKIP.      
+0001e320: 2020 3e3e 3e20 632e 636c 7573 7465 722e    >>> c.cluster.
+0001e330: 7363 6865 6475 6c65 7220 2023 2064 6f63  scheduler  # doc
+0001e340: 7465 7374 3a20 2b53 4b49 500a 2020 2020  test: +SKIP.    
+0001e350: 2020 2020 5363 6865 6475 6c65 7228 2e2e      Scheduler(..
+0001e360: 2e29 0a0a 2020 2020 5573 6572 7320 7479  .)..    Users ty
+0001e370: 7069 6361 6c6c 7920 646f 206e 6f74 2069  pically do not i
+0001e380: 6e74 6572 6163 7420 7769 7468 2074 6865  nteract with the
+0001e390: 2073 6368 6564 756c 6572 2064 6972 6563   scheduler direc
+0001e3a0: 746c 7920 6275 7420 7261 7468 6572 2077  tly but rather w
+0001e3b0: 6974 680a 2020 2020 7468 6520 636c 6965  ith.    the clie
+0001e3c0: 6e74 206f 626a 6563 7420 6060 436c 6965  nt object ``Clie
+0001e3d0: 6e74 6060 2e0a 0a20 2020 2054 6865 2060  nt``...    The `
+0001e3e0: 6063 6f6e 7461 6374 5f61 6464 7265 7373  `contact_address
+0001e3f0: 6060 2070 6172 616d 6574 6572 2061 6c6c  `` parameter all
+0001e400: 6f77 7320 746f 2061 6476 6572 7469 7365  ows to advertise
+0001e410: 2061 2073 7065 6369 6669 6320 6164 6472   a specific addr
+0001e420: 6573 7320 746f 0a20 2020 2074 6865 2077  ess to.    the w
+0001e430: 6f72 6b65 7273 2066 6f72 2063 6f6d 6d75  orkers for commu
+0001e440: 6e69 6361 7469 6f6e 2077 6974 6820 7468  nication with th
+0001e450: 6520 7363 6865 6475 6c65 722c 2077 6869  e scheduler, whi
+0001e460: 6368 2069 7320 6469 6666 6572 656e 7420  ch is different 
+0001e470: 7468 616e 0a20 2020 2074 6865 2061 6464  than.    the add
+0001e480: 7265 7373 2074 6865 2073 6368 6564 756c  ress the schedul
+0001e490: 6572 2062 696e 6473 2074 6f2e 2054 6869  er binds to. Thi
+0001e4a0: 7320 6973 2075 7365 6675 6c20 7768 656e  s is useful when
+0001e4b0: 2074 6865 2073 6368 6564 756c 6572 0a20   the scheduler. 
+0001e4c0: 2020 206c 6973 7465 6e73 206f 6e20 6120     listens on a 
+0001e4d0: 7072 6976 6174 6520 6164 6472 6573 732c  private address,
+0001e4e0: 2077 6869 6368 2074 6865 7265 666f 7265   which therefore
+0001e4f0: 2063 616e 6e6f 7420 6265 2075 7365 6420   cannot be used 
+0001e500: 6279 2074 6865 2077 6f72 6b65 7273 0a20  by the workers. 
+0001e510: 2020 2074 6f20 636f 6e74 6163 7420 6974     to contact it
+0001e520: 2e0a 0a20 2020 202a 2a53 7461 7465 2a2a  ...    **State**
+0001e530: 0a0a 2020 2020 5468 6520 7363 6865 6475  ..    The schedu
+0001e540: 6c65 7220 636f 6e74 6169 6e73 2074 6865  ler contains the
+0001e550: 2066 6f6c 6c6f 7769 6e67 2073 7461 7465   following state
+0001e560: 2076 6172 6961 626c 6573 2e20 2045 6163   variables.  Eac
+0001e570: 6820 7661 7269 6162 6c65 2069 730a 2020  h variable is.  
+0001e580: 2020 6c69 7374 6564 2061 6c6f 6e67 2077    listed along w
+0001e590: 6974 6820 7768 6174 2069 7420 7374 6f72  ith what it stor
+0001e5a0: 6573 2061 6e64 2061 2062 7269 6566 2064  es and a brief d
+0001e5b0: 6573 6372 6970 7469 6f6e 2e0a 0a20 2020  escription...   
+0001e5c0: 202a 202a 2a74 6173 6b73 3a2a 2a20 6060   * **tasks:** ``
+0001e5d0: 7b74 6173 6b20 6b65 793a 2054 6173 6b53  {task key: TaskS
+0001e5e0: 7461 7465 7d60 600a 2020 2020 2020 2020  tate}``.        
+0001e5f0: 5461 736b 7320 6375 7272 656e 746c 7920  Tasks currently 
+0001e600: 6b6e 6f77 6e20 746f 2074 6865 2073 6368  known to the sch
+0001e610: 6564 756c 6572 0a20 2020 202a 202a 2a75  eduler.    * **u
+0001e620: 6e72 756e 6e61 626c 653a 2a2a 2060 607b  nrunnable:** ``{
+0001e630: 5461 736b 5374 6174 657d 6060 0a20 2020  TaskState}``.   
+0001e640: 2020 2020 2054 6173 6b73 2069 6e20 7468       Tasks in th
+0001e650: 6520 226e 6f2d 776f 726b 6572 2220 7374  e "no-worker" st
+0001e660: 6174 650a 0a20 2020 202a 202a 2a77 6f72  ate..    * **wor
+0001e670: 6b65 7273 3a2a 2a20 6060 7b77 6f72 6b65  kers:** ``{worke
+0001e680: 7220 6b65 793a 2057 6f72 6b65 7253 7461  r key: WorkerSta
+0001e690: 7465 7d60 600a 2020 2020 2020 2020 576f  te}``.        Wo
+0001e6a0: 726b 6572 7320 6375 7272 656e 746c 7920  rkers currently 
+0001e6b0: 636f 6e6e 6563 7465 6420 746f 2074 6865  connected to the
+0001e6c0: 2073 6368 6564 756c 6572 0a20 2020 202a   scheduler.    *
+0001e6d0: 202a 2a69 646c 653a 2a2a 2060 607b 576f   **idle:** ``{Wo
+0001e6e0: 726b 6572 5374 6174 657d 6060 3a0a 2020  rkerState}``:.  
+0001e6f0: 2020 2020 2020 5365 7420 6f66 2077 6f72        Set of wor
+0001e700: 6b65 7273 2074 6861 7420 6172 6520 6e6f  kers that are no
+0001e710: 7420 6675 6c6c 7920 7574 696c 697a 6564  t fully utilized
+0001e720: 0a20 2020 202a 202a 2a73 6174 7572 6174  .    * **saturat
+0001e730: 6564 3a2a 2a20 6060 7b57 6f72 6b65 7253  ed:** ``{WorkerS
+0001e740: 7461 7465 7d60 603a 0a20 2020 2020 2020  tate}``:.       
+0001e750: 2053 6574 206f 6620 776f 726b 6572 7320   Set of workers 
+0001e760: 7468 6174 2061 7265 206e 6f74 206f 7665  that are not ove
+0001e770: 722d 7574 696c 697a 6564 0a0a 2020 2020  r-utilized..    
+0001e780: 2a20 2a2a 686f 7374 5f69 6e66 6f3a 2a2a  * **host_info:**
+0001e790: 2060 607b 686f 7374 6e61 6d65 3a20 6469   ``{hostname: di
+0001e7a0: 6374 7d60 603a 0a20 2020 2020 2020 2049  ct}``:.        I
+0001e7b0: 6e66 6f72 6d61 7469 6f6e 2061 626f 7574  nformation about
+0001e7c0: 2065 6163 6820 776f 726b 6572 2068 6f73   each worker hos
+0001e7d0: 740a 0a20 2020 202a 202a 2a63 6c69 656e  t..    * **clien
+0001e7e0: 7473 3a2a 2a20 6060 7b63 6c69 656e 7420  ts:** ``{client 
+0001e7f0: 6b65 793a 2043 6c69 656e 7453 7461 7465  key: ClientState
+0001e800: 7d60 600a 2020 2020 2020 2020 436c 6965  }``.        Clie
+0001e810: 6e74 7320 6375 7272 656e 746c 7920 636f  nts currently co
+0001e820: 6e6e 6563 7465 6420 746f 2074 6865 2073  nnected to the s
+0001e830: 6368 6564 756c 6572 0a0a 2020 2020 2a20  cheduler..    * 
+0001e840: 2a2a 7365 7276 6963 6573 3a2a 2a20 6060  **services:** ``
+0001e850: 7b73 7472 3a20 706f 7274 7d60 603a 0a20  {str: port}``:. 
+0001e860: 2020 2020 2020 204f 7468 6572 2073 6572         Other ser
+0001e870: 7669 6365 7320 7275 6e6e 696e 6720 6f6e  vices running on
+0001e880: 2074 6869 7320 7363 6865 6475 6c65 722c   this scheduler,
+0001e890: 206c 696b 6520 426f 6b65 680a 2020 2020   like Bokeh.    
+0001e8a0: 2a20 2a2a 6c6f 6f70 3a2a 2a20 6060 494f  * **loop:** ``IO
+0001e8b0: 4c6f 6f70 6060 3a0a 2020 2020 2020 2020  Loop``:.        
+0001e8c0: 5468 6520 7275 6e6e 696e 6720 546f 726e  The running Torn
+0001e8d0: 6164 6f20 494f 4c6f 6f70 0a20 2020 202a  ado IOLoop.    *
+0001e8e0: 202a 2a63 6c69 656e 745f 636f 6d6d 733a   **client_comms:
+0001e8f0: 2a2a 2060 607b 636c 6965 6e74 206b 6579  ** ``{client key
+0001e900: 3a20 436f 6d6d 7d60 600a 2020 2020 2020  : Comm}``.      
+0001e910: 2020 466f 7220 6561 6368 2063 6c69 656e    For each clien
+0001e920: 742c 2061 2043 6f6d 6d20 6f62 6a65 6374  t, a Comm object
+0001e930: 2075 7365 6420 746f 2072 6563 6569 7665   used to receive
+0001e940: 2074 6173 6b20 7265 7175 6573 7473 2061   task requests a
+0001e950: 6e64 0a20 2020 2020 2020 2072 6570 6f72  nd.        repor
+0001e960: 7420 7461 736b 2073 7461 7475 7320 7570  t task status up
+0001e970: 6461 7465 732e 0a20 2020 202a 202a 2a73  dates..    * **s
+0001e980: 7472 6561 6d5f 636f 6d6d 733a 2a2a 2060  tream_comms:** `
+0001e990: 607b 776f 726b 6572 206b 6579 3a20 436f  `{worker key: Co
+0001e9a0: 6d6d 7d60 600a 2020 2020 2020 2020 466f  mm}``.        Fo
+0001e9b0: 7220 6561 6368 2077 6f72 6b65 722c 2061  r each worker, a
+0001e9c0: 2043 6f6d 6d20 6f62 6a65 6374 2066 726f   Comm object fro
+0001e9d0: 6d20 7768 6963 6820 7765 2062 6f74 6820  m which we both 
+0001e9e0: 6163 6365 7074 2073 7469 6d75 6c69 2061  accept stimuli a
+0001e9f0: 6e64 0a20 2020 2020 2020 2072 6570 6f72  nd.        repor
+0001ea00: 7420 7265 7375 6c74 730a 2020 2020 2a20  t results.    * 
+0001ea10: 2a2a 7461 736b 5f64 7572 6174 696f 6e3a  **task_duration:
+0001ea20: 2a2a 2060 607b 6b65 792d 7072 6566 6978  ** ``{key-prefix
+0001ea30: 3a20 7469 6d65 7d60 600a 2020 2020 2020  : time}``.      
+0001ea40: 2020 5469 6d65 2077 6520 6578 7065 6374    Time we expect
+0001ea50: 2063 6572 7461 696e 2066 756e 6374 696f   certain functio
+0001ea60: 6e73 2074 6f20 7461 6b65 2c20 652e 672e  ns to take, e.g.
+0001ea70: 2060 607b 2773 756d 273a 2030 2e32 357d   ``{'sum': 0.25}
+0001ea80: 6060 0a20 2020 2022 2222 0a0a 2020 2020  ``.    """..    
+0001ea90: 6465 6661 756c 745f 706f 7274 203d 2038  default_port = 8
+0001eaa0: 3738 360a 2020 2020 5f69 6e73 7461 6e63  786.    _instanc
+0001eab0: 6573 3a20 436c 6173 7356 6172 5b77 6561  es: ClassVar[wea
+0001eac0: 6b72 6566 2e57 6561 6b53 6574 5b53 6368  kref.WeakSet[Sch
+0001ead0: 6564 756c 6572 5d5d 203d 2077 6561 6b72  eduler]] = weakr
+0001eae0: 6566 2e57 6561 6b53 6574 2829 0a0a 2020  ef.WeakSet()..  
+0001eaf0: 2020 776f 726b 6572 5f74 746c 3a20 666c    worker_ttl: fl
+0001eb00: 6f61 7420 7c20 4e6f 6e65 0a20 2020 2069  oat | None.    i
+0001eb10: 646c 655f 7369 6e63 653a 2066 6c6f 6174  dle_since: float
+0001eb20: 207c 204e 6f6e 650a 2020 2020 6964 6c65   | None.    idle
+0001eb30: 5f74 696d 656f 7574 3a20 666c 6f61 7420  _timeout: float 
+0001eb40: 7c20 4e6f 6e65 0a20 2020 205f 6e6f 5f77  | None.    _no_w
+0001eb50: 6f72 6b65 7273 5f73 696e 6365 3a20 666c  orkers_since: fl
+0001eb60: 6f61 7420 7c20 4e6f 6e65 2020 2320 4e6f  oat | None  # No
+0001eb70: 7465 3a20 6e6f 7420 4e6f 6e65 2069 6666  te: not None iff
+0001eb80: 2074 6865 7265 2061 7265 2070 656e 6469   there are pendi
+0001eb90: 6e67 2074 6173 6b73 0a20 2020 206e 6f5f  ng tasks.    no_
+0001eba0: 776f 726b 6572 735f 7469 6d65 6f75 743a  workers_timeout:
+0001ebb0: 2066 6c6f 6174 207c 204e 6f6e 650a 0a20   float | None.. 
+0001ebc0: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
+0001ebd0: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+0001ebe0: 2020 2020 2020 206c 6f6f 703d 4e6f 6e65         loop=None
+0001ebf0: 2c0a 2020 2020 2020 2020 6465 6c65 7465  ,.        delete
+0001ec00: 5f69 6e74 6572 7661 6c3d 2235 3030 6d73  _interval="500ms
+0001ec10: 222c 0a20 2020 2020 2020 2073 796e 6368  ",.        synch
+0001ec20: 726f 6e69 7a65 5f77 6f72 6b65 725f 696e  ronize_worker_in
+0001ec30: 7465 7276 616c 3d22 3630 7322 2c0a 2020  terval="60s",.  
+0001ec40: 2020 2020 2020 7365 7276 6963 6573 3d4e        services=N
+0001ec50: 6f6e 652c 0a20 2020 2020 2020 2073 6572  one,.        ser
+0001ec60: 7669 6365 5f6b 7761 7267 733d 4e6f 6e65  vice_kwargs=None
+0001ec70: 2c0a 2020 2020 2020 2020 616c 6c6f 7765  ,.        allowe
+0001ec80: 645f 6661 696c 7572 6573 3d4e 6f6e 652c  d_failures=None,
+0001ec90: 0a20 2020 2020 2020 2065 7874 656e 7369  .        extensi
+0001eca0: 6f6e 733d 4e6f 6e65 2c0a 2020 2020 2020  ons=None,.      
+0001ecb0: 2020 7661 6c69 6461 7465 3d4e 6f6e 652c    validate=None,
+0001ecc0: 0a20 2020 2020 2020 2073 6368 6564 756c  .        schedul
+0001ecd0: 6572 5f66 696c 653d 4e6f 6e65 2c0a 2020  er_file=None,.  
+0001ece0: 2020 2020 2020 7365 6375 7269 7479 3d4e        security=N
+0001ecf0: 6f6e 652c 0a20 2020 2020 2020 2077 6f72  one,.        wor
+0001ed00: 6b65 725f 7474 6c3d 4e6f 6e65 2c0a 2020  ker_ttl=None,.  
+0001ed10: 2020 2020 2020 6964 6c65 5f74 696d 656f        idle_timeo
+0001ed20: 7574 3d4e 6f6e 652c 0a20 2020 2020 2020  ut=None,.       
+0001ed30: 2069 6e74 6572 6661 6365 3d4e 6f6e 652c   interface=None,
+0001ed40: 0a20 2020 2020 2020 2068 6f73 743d 4e6f  .        host=No
+0001ed50: 6e65 2c0a 2020 2020 2020 2020 706f 7274  ne,.        port
+0001ed60: 3d30 2c0a 2020 2020 2020 2020 7072 6f74  =0,.        prot
+0001ed70: 6f63 6f6c 3d4e 6f6e 652c 0a20 2020 2020  ocol=None,.     
+0001ed80: 2020 2064 6173 6862 6f61 7264 5f61 6464     dashboard_add
+0001ed90: 7265 7373 3d4e 6f6e 652c 0a20 2020 2020  ress=None,.     
+0001eda0: 2020 2064 6173 6862 6f61 7264 3d4e 6f6e     dashboard=Non
+0001edb0: 652c 0a20 2020 2020 2020 2068 7474 705f  e,.        http_
+0001edc0: 7072 6566 6978 3d22 2f22 2c0a 2020 2020  prefix="/",.    
+0001edd0: 2020 2020 7072 656c 6f61 643d 4e6f 6e65      preload=None
+0001ede0: 2c0a 2020 2020 2020 2020 7072 656c 6f61  ,.        preloa
+0001edf0: 645f 6172 6776 3d28 292c 0a20 2020 2020  d_argv=(),.     
+0001ee00: 2020 2070 6c75 6769 6e73 3d28 292c 0a20     plugins=(),. 
+0001ee10: 2020 2020 2020 2063 6f6e 7461 6374 5f61         contact_a
+0001ee20: 6464 7265 7373 3d4e 6f6e 652c 0a20 2020  ddress=None,.   
+0001ee30: 2020 2020 2074 7261 6e73 6974 696f 6e5f       transition_
+0001ee40: 636f 756e 7465 725f 6d61 783d 4661 6c73  counter_max=Fals
+0001ee50: 652c 0a20 2020 2020 2020 206a 7570 7974  e,.        jupyt
+0001ee60: 6572 3d46 616c 7365 2c0a 2020 2020 2020  er=False,.      
+0001ee70: 2020 2a2a 6b77 6172 6773 2c0a 2020 2020    **kwargs,.    
+0001ee80: 293a 0a20 2020 2020 2020 2069 6620 6461  ):.        if da
+0001ee90: 736b 2e63 6f6e 6669 672e 6765 7428 2264  sk.config.get("d
+0001eea0: 6973 7472 6962 7574 6564 2e73 6368 6564  istributed.sched
+0001eeb0: 756c 6572 2e70 6963 6b6c 6522 2c20 6465  uler.pickle", de
+0001eec0: 6661 756c 743d 5472 7565 2920 6973 2046  fault=True) is F
+0001eed0: 616c 7365 3a0a 2020 2020 2020 2020 2020  alse:.          
+0001eee0: 2020 7261 6973 6520 5275 6e74 696d 6545    raise RuntimeE
+0001eef0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+0001ef00: 2020 2020 2020 2250 6963 6b6c 696e 6720        "Pickling 
+0001ef10: 6361 6e20 6e6f 206c 6f6e 6765 7220 6265  can no longer be
+0001ef20: 2064 6973 6162 6c65 6420 7769 7468 2074   disabled with t
+0001ef30: 6865 2060 6469 7374 7269 6275 7465 642e  he `distributed.
+0001ef40: 7363 6865 6475 6c65 722e 7069 636b 6c65  scheduler.pickle
+0001ef50: 6020 6f70 7469 6f6e 2e20 506c 6561 7365  ` option. Please
+0001ef60: 2072 656d 6f76 6520 7468 6973 2063 6f6e   remove this con
+0001ef70: 6669 6775 7261 7469 6f6e 2074 6f20 7374  figuration to st
+0001ef80: 6172 7420 7468 6520 7363 6865 6475 6c65  art the schedule
+0001ef90: 722e 220a 2020 2020 2020 2020 2020 2020  r.".            
+0001efa0: 290a 2020 2020 2020 2020 6966 206c 6f6f  ).        if loo
+0001efb0: 7020 6973 206e 6f74 204e 6f6e 653a 0a20  p is not None:. 
+0001efc0: 2020 2020 2020 2020 2020 2077 6172 6e69             warni
+0001efd0: 6e67 732e 7761 726e 280a 2020 2020 2020  ngs.warn(.      
+0001efe0: 2020 2020 2020 2020 2020 2274 6865 206c            "the l
+0001eff0: 6f6f 7020 6b77 6172 6720 746f 2053 6368  oop kwarg to Sch
+0001f000: 6564 756c 6572 2069 7320 6465 7072 6563  eduler is deprec
+0001f010: 6174 6564 222c 0a20 2020 2020 2020 2020  ated",.         
+0001f020: 2020 2020 2020 2044 6570 7265 6361 7469         Deprecati
+0001f030: 6f6e 5761 726e 696e 672c 0a20 2020 2020  onWarning,.     
+0001f040: 2020 2020 2020 2020 2020 2073 7461 636b             stack
+0001f050: 6c65 7665 6c3d 322c 0a20 2020 2020 2020  level=2,.       
+0001f060: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+0001f070: 7365 6c66 2e6c 6f6f 7020 3d20 7365 6c66  self.loop = self
+0001f080: 2e69 6f5f 6c6f 6f70 203d 2049 4f4c 6f6f  .io_loop = IOLoo
+0001f090: 702e 6375 7272 656e 7428 290a 2020 2020  p.current().    
+0001f0a0: 2020 2020 7365 6c66 2e5f 7365 7475 705f      self._setup_
+0001f0b0: 6c6f 6767 696e 6728 6c6f 6767 6572 290a  logging(logger).
+0001f0c0: 0a20 2020 2020 2020 2023 2041 7474 7269  .        # Attri
+0001f0d0: 6275 7465 730a 2020 2020 2020 2020 6966  butes.        if
+0001f0e0: 2063 6f6e 7461 6374 5f61 6464 7265 7373   contact_address
+0001f0f0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0001f100: 2020 2020 2020 636f 6e74 6163 745f 6164        contact_ad
+0001f110: 6472 6573 7320 3d20 6461 736b 2e63 6f6e  dress = dask.con
+0001f120: 6669 672e 6765 7428 2264 6973 7472 6962  fig.get("distrib
+0001f130: 7574 6564 2e73 6368 6564 756c 6572 2e63  uted.scheduler.c
+0001f140: 6f6e 7461 6374 2d61 6464 7265 7373 2229  ontact-address")
+0001f150: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
+0001f160: 6e74 6163 745f 6164 6472 6573 7320 3d20  ntact_address = 
+0001f170: 636f 6e74 6163 745f 6164 6472 6573 730a  contact_address.
+0001f180: 2020 2020 2020 2020 6966 2061 6c6c 6f77          if allow
+0001f190: 6564 5f66 6169 6c75 7265 7320 6973 204e  ed_failures is N
+0001f1a0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0001f1b0: 2061 6c6c 6f77 6564 5f66 6169 6c75 7265   allowed_failure
+0001f1c0: 7320 3d20 6461 736b 2e63 6f6e 6669 672e  s = dask.config.
+0001f1d0: 6765 7428 2264 6973 7472 6962 7574 6564  get("distributed
+0001f1e0: 2e73 6368 6564 756c 6572 2e61 6c6c 6f77  .scheduler.allow
+0001f1f0: 6564 2d66 6169 6c75 7265 7322 290a 2020  ed-failures").  
+0001f200: 2020 2020 2020 7365 6c66 2e61 6c6c 6f77        self.allow
+0001f210: 6564 5f66 6169 6c75 7265 7320 3d20 616c  ed_failures = al
+0001f220: 6c6f 7765 645f 6661 696c 7572 6573 0a20  lowed_failures. 
+0001f230: 2020 2020 2020 2069 6620 7661 6c69 6461         if valida
+0001f240: 7465 2069 7320 4e6f 6e65 3a0a 2020 2020  te is None:.    
+0001f250: 2020 2020 2020 2020 7661 6c69 6461 7465          validate
+0001f260: 203d 2064 6173 6b2e 636f 6e66 6967 2e67   = dask.config.g
+0001f270: 6574 2822 6469 7374 7269 6275 7465 642e  et("distributed.
+0001f280: 7363 6865 6475 6c65 722e 7661 6c69 6461  scheduler.valida
+0001f290: 7465 2229 0a20 2020 2020 2020 2073 656c  te").        sel
+0001f2a0: 662e 7072 6f63 203d 2070 7375 7469 6c2e  f.proc = psutil.
+0001f2b0: 5072 6f63 6573 7328 290a 2020 2020 2020  Process().      
+0001f2c0: 2020 7365 6c66 2e64 656c 6574 655f 696e    self.delete_in
+0001f2d0: 7465 7276 616c 203d 2070 6172 7365 5f74  terval = parse_t
+0001f2e0: 696d 6564 656c 7461 2864 656c 6574 655f  imedelta(delete_
+0001f2f0: 696e 7465 7276 616c 2c20 6465 6661 756c  interval, defaul
+0001f300: 743d 226d 7322 290a 2020 2020 2020 2020  t="ms").        
+0001f310: 7365 6c66 2e73 796e 6368 726f 6e69 7a65  self.synchronize
+0001f320: 5f77 6f72 6b65 725f 696e 7465 7276 616c  _worker_interval
+0001f330: 203d 2070 6172 7365 5f74 696d 6564 656c   = parse_timedel
+0001f340: 7461 280a 2020 2020 2020 2020 2020 2020  ta(.            
+0001f350: 7379 6e63 6872 6f6e 697a 655f 776f 726b  synchronize_work
+0001f360: 6572 5f69 6e74 6572 7661 6c2c 2064 6566  er_interval, def
+0001f370: 6175 6c74 3d22 6d73 220a 2020 2020 2020  ault="ms".      
+0001f380: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
+0001f390: 2e73 6572 7669 6365 5f73 7065 6373 203d  .service_specs =
+0001f3a0: 2073 6572 7669 6365 7320 6f72 207b 7d0a   services or {}.
+0001f3b0: 2020 2020 2020 2020 7365 6c66 2e73 6572          self.ser
+0001f3c0: 7669 6365 5f6b 7761 7267 7320 3d20 7365  vice_kwargs = se
+0001f3d0: 7276 6963 655f 6b77 6172 6773 206f 7220  rvice_kwargs or 
+0001f3e0: 7b7d 0a20 2020 2020 2020 2073 656c 662e  {}.        self.
+0001f3f0: 7365 7276 6963 6573 203d 207b 7d0a 2020  services = {}.  
+0001f400: 2020 2020 2020 7365 6c66 2e73 6368 6564        self.sched
+0001f410: 756c 6572 5f66 696c 6520 3d20 7363 6865  uler_file = sche
+0001f420: 6475 6c65 725f 6669 6c65 0a0a 2020 2020  duler_file..    
+0001f430: 2020 2020 7365 6c66 2e77 6f72 6b65 725f      self.worker_
+0001f440: 7474 6c20 3d20 7061 7273 655f 7469 6d65  ttl = parse_time
+0001f450: 6465 6c74 6128 0a20 2020 2020 2020 2020  delta(.         
+0001f460: 2020 2077 6f72 6b65 725f 7474 6c20 6f72     worker_ttl or
+0001f470: 2064 6173 6b2e 636f 6e66 6967 2e67 6574   dask.config.get
+0001f480: 2822 6469 7374 7269 6275 7465 642e 7363  ("distributed.sc
+0001f490: 6865 6475 6c65 722e 776f 726b 6572 2d74  heduler.worker-t
+0001f4a0: 746c 2229 0a20 2020 2020 2020 2029 0a20  tl").        ). 
+0001f4b0: 2020 2020 2020 2073 656c 662e 6964 6c65         self.idle
+0001f4c0: 5f74 696d 656f 7574 203d 2070 6172 7365  _timeout = parse
+0001f4d0: 5f74 696d 6564 656c 7461 280a 2020 2020  _timedelta(.    
+0001f4e0: 2020 2020 2020 2020 6964 6c65 5f74 696d          idle_tim
+0001f4f0: 656f 7574 206f 7220 6461 736b 2e63 6f6e  eout or dask.con
+0001f500: 6669 672e 6765 7428 2264 6973 7472 6962  fig.get("distrib
+0001f510: 7574 6564 2e73 6368 6564 756c 6572 2e69  uted.scheduler.i
+0001f520: 646c 652d 7469 6d65 6f75 7422 290a 2020  dle-timeout").  
+0001f530: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0001f540: 7365 6c66 2e69 646c 655f 7369 6e63 6520  self.idle_since 
+0001f550: 3d20 7469 6d65 2829 0a20 2020 2020 2020  = time().       
+0001f560: 2073 656c 662e 6e6f 5f77 6f72 6b65 7273   self.no_workers
+0001f570: 5f74 696d 656f 7574 203d 2070 6172 7365  _timeout = parse
+0001f580: 5f74 696d 6564 656c 7461 280a 2020 2020  _timedelta(.    
+0001f590: 2020 2020 2020 2020 6461 736b 2e63 6f6e          dask.con
+0001f5a0: 6669 672e 6765 7428 2264 6973 7472 6962  fig.get("distrib
+0001f5b0: 7574 6564 2e73 6368 6564 756c 6572 2e6e  uted.scheduler.n
+0001f5c0: 6f2d 776f 726b 6572 732d 7469 6d65 6f75  o-workers-timeou
+0001f5d0: 7422 290a 2020 2020 2020 2020 290a 2020  t").        ).  
+0001f5e0: 2020 2020 2020 7365 6c66 2e5f 6e6f 5f77        self._no_w
+0001f5f0: 6f72 6b65 7273 5f73 696e 6365 203d 204e  orkers_since = N
+0001f600: 6f6e 650a 0a20 2020 2020 2020 2073 656c  one..        sel
+0001f610: 662e 7469 6d65 5f73 7461 7274 6564 203d  f.time_started =
+0001f620: 2073 656c 662e 6964 6c65 5f73 696e 6365   self.idle_since
+0001f630: 2020 2320 636f 6d70 6174 6962 696c 6974    # compatibilit
+0001f640: 7920 666f 7220 6461 736b 2d67 6174 6577  y for dask-gatew
+0001f650: 6179 0a20 2020 2020 2020 2073 656c 662e  ay.        self.
+0001f660: 5f72 6570 6c69 6361 5f6c 6f63 6b20 3d20  _replica_lock = 
+0001f670: 524c 6f63 6b28 290a 2020 2020 2020 2020  RLock().        
+0001f680: 7365 6c66 2e62 616e 6477 6964 7468 5f77  self.bandwidth_w
+0001f690: 6f72 6b65 7273 203d 2064 6566 6175 6c74  orkers = default
+0001f6a0: 6469 6374 2866 6c6f 6174 290a 2020 2020  dict(float).    
+0001f6b0: 2020 2020 7365 6c66 2e62 616e 6477 6964      self.bandwid
+0001f6c0: 7468 5f74 7970 6573 203d 2064 6566 6175  th_types = defau
+0001f6d0: 6c74 6469 6374 2866 6c6f 6174 290a 0a20  ltdict(float).. 
+0001f6e0: 2020 2020 2020 2023 2044 6f6e 2774 2063         # Don't c
+0001f6f0: 6173 7420 696e 7420 6d65 7472 6963 7320  ast int metrics 
+0001f700: 746f 2066 6c6f 6174 0a20 2020 2020 2020  to float.       
+0001f710: 2073 656c 662e 6375 6d75 6c61 7469 7665   self.cumulative
+0001f720: 5f77 6f72 6b65 725f 6d65 7472 6963 7320  _worker_metrics 
+0001f730: 3d20 6465 6661 756c 7464 6963 7428 696e  = defaultdict(in
+0001f740: 7429 0a0a 2020 2020 2020 2020 6966 206e  t)..        if n
+0001f750: 6f74 2070 7265 6c6f 6164 3a0a 2020 2020  ot preload:.    
+0001f760: 2020 2020 2020 2020 7072 656c 6f61 6420          preload 
+0001f770: 3d20 6461 736b 2e63 6f6e 6669 672e 6765  = dask.config.ge
+0001f780: 7428 2264 6973 7472 6962 7574 6564 2e73  t("distributed.s
+0001f790: 6368 6564 756c 6572 2e70 7265 6c6f 6164  cheduler.preload
+0001f7a0: 2229 0a20 2020 2020 2020 2069 6620 6e6f  ").        if no
+0001f7b0: 7420 7072 656c 6f61 645f 6172 6776 3a0a  t preload_argv:.
+0001f7c0: 2020 2020 2020 2020 2020 2020 7072 656c              prel
+0001f7d0: 6f61 645f 6172 6776 203d 2064 6173 6b2e  oad_argv = dask.
+0001f7e0: 636f 6e66 6967 2e67 6574 2822 6469 7374  config.get("dist
+0001f7f0: 7269 6275 7465 642e 7363 6865 6475 6c65  ributed.schedule
+0001f800: 722e 7072 656c 6f61 642d 6172 6776 2229  r.preload-argv")
+0001f810: 0a20 2020 2020 2020 2073 656c 662e 7072  .        self.pr
+0001f820: 656c 6f61 6473 203d 2070 7265 6c6f 6164  eloads = preload
+0001f830: 696e 672e 7072 6f63 6573 735f 7072 656c  ing.process_prel
+0001f840: 6f61 6473 2873 656c 662c 2070 7265 6c6f  oads(self, prelo
+0001f850: 6164 2c20 7072 656c 6f61 645f 6172 6776  ad, preload_argv
+0001f860: 290a 0a20 2020 2020 2020 2069 6620 6973  )..        if is
+0001f870: 696e 7374 616e 6365 2873 6563 7572 6974  instance(securit
+0001f880: 792c 2064 6963 7429 3a0a 2020 2020 2020  y, dict):.      
+0001f890: 2020 2020 2020 7365 6375 7269 7479 203d        security =
+0001f8a0: 2053 6563 7572 6974 7928 2a2a 7365 6375   Security(**secu
+0001f8b0: 7269 7479 290a 2020 2020 2020 2020 7365  rity).        se
+0001f8c0: 6c66 2e73 6563 7572 6974 7920 3d20 7365  lf.security = se
+0001f8d0: 6375 7269 7479 206f 7220 5365 6375 7269  curity or Securi
+0001f8e0: 7479 2829 0a20 2020 2020 2020 2061 7373  ty().        ass
+0001f8f0: 6572 7420 6973 696e 7374 616e 6365 2873  ert isinstance(s
+0001f900: 656c 662e 7365 6375 7269 7479 2c20 5365  elf.security, Se
+0001f910: 6375 7269 7479 290a 2020 2020 2020 2020  curity).        
+0001f920: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e5f  self.connection_
+0001f930: 6172 6773 203d 2073 656c 662e 7365 6375  args = self.secu
+0001f940: 7269 7479 2e67 6574 5f63 6f6e 6e65 6374  rity.get_connect
+0001f950: 696f 6e5f 6172 6773 2822 7363 6865 6475  ion_args("schedu
+0001f960: 6c65 7222 290a 2020 2020 2020 2020 7365  ler").        se
+0001f970: 6c66 2e63 6f6e 6e65 6374 696f 6e5f 6172  lf.connection_ar
+0001f980: 6773 5b22 6861 6e64 7368 616b 655f 6f76  gs["handshake_ov
+0001f990: 6572 7269 6465 7322 5d20 3d20 7b20 2023  errides"] = {  #
+0001f9a0: 2063 6f6d 6d6f 6e20 6465 6e6f 6d69 6e61   common denomina
+0001f9b0: 746f 720a 2020 2020 2020 2020 2020 2020  tor.            
+0001f9c0: 2270 6963 6b6c 652d 7072 6f74 6f63 6f6c  "pickle-protocol
+0001f9d0: 223a 2034 0a20 2020 2020 2020 207d 0a0a  ": 4.        }..
+0001f9e0: 2020 2020 2020 2020 7365 6c66 2e5f 7374          self._st
+0001f9f0: 6172 745f 6164 6472 6573 7320 3d20 6164  art_address = ad
+0001fa00: 6472 6573 7365 735f 6672 6f6d 5f75 7365  dresses_from_use
+0001fa10: 725f 6172 6773 280a 2020 2020 2020 2020  r_args(.        
+0001fa20: 2020 2020 686f 7374 3d68 6f73 742c 0a20      host=host,. 
+0001fa30: 2020 2020 2020 2020 2020 2070 6f72 743d             port=
+0001fa40: 706f 7274 2c0a 2020 2020 2020 2020 2020  port,.          
+0001fa50: 2020 696e 7465 7266 6163 653d 696e 7465    interface=inte
+0001fa60: 7266 6163 652c 0a20 2020 2020 2020 2020  rface,.         
+0001fa70: 2020 2070 726f 746f 636f 6c3d 7072 6f74     protocol=prot
+0001fa80: 6f63 6f6c 2c0a 2020 2020 2020 2020 2020  ocol,.          
+0001fa90: 2020 7365 6375 7269 7479 3d73 6563 7572    security=secur
+0001faa0: 6974 792c 0a20 2020 2020 2020 2020 2020  ity,.           
+0001fab0: 2064 6566 6175 6c74 5f70 6f72 743d 7365   default_port=se
+0001fac0: 6c66 2e64 6566 6175 6c74 5f70 6f72 742c  lf.default_port,
+0001fad0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+0001fae0: 2020 2020 6874 7470 5f73 6572 7665 725f      http_server_
+0001faf0: 6d6f 6475 6c65 7320 3d20 6461 736b 2e63  modules = dask.c
+0001fb00: 6f6e 6669 672e 6765 7428 2264 6973 7472  onfig.get("distr
+0001fb10: 6962 7574 6564 2e73 6368 6564 756c 6572  ibuted.scheduler
+0001fb20: 2e68 7474 702e 726f 7574 6573 2229 0a20  .http.routes"). 
+0001fb30: 2020 2020 2020 2073 686f 775f 6461 7368         show_dash
+0001fb40: 626f 6172 6420 3d20 6461 7368 626f 6172  board = dashboar
+0001fb50: 6420 6f72 2028 6461 7368 626f 6172 6420  d or (dashboard 
+0001fb60: 6973 204e 6f6e 6520 616e 6420 6461 7368  is None and dash
+0001fb70: 626f 6172 645f 6164 6472 6573 7329 0a20  board_address). 
+0001fb80: 2020 2020 2020 2023 2069 6e73 7461 6c6c         # install
+0001fb90: 2076 616e 696c 6c61 2072 6f75 7465 2069   vanilla route i
+0001fba0: 6620 7368 6f77 5f64 6173 6862 6f61 7264  f show_dashboard
+0001fbb0: 2062 7574 2062 6f6b 6568 2069 7320 6e6f   but bokeh is no
+0001fbc0: 7420 696e 7374 616c 6c65 640a 2020 2020  t installed.    
+0001fbd0: 2020 2020 6966 2073 686f 775f 6461 7368      if show_dash
+0001fbe0: 626f 6172 643a 0a20 2020 2020 2020 2020  board:.         
+0001fbf0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0001fc00: 2020 2020 2020 2020 696d 706f 7274 2064          import d
+0001fc10: 6973 7472 6962 7574 6564 2e64 6173 6862  istributed.dashb
+0001fc20: 6f61 7264 2e73 6368 6564 756c 6572 0a20  oard.scheduler. 
+0001fc30: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+0001fc40: 7420 496d 706f 7274 4572 726f 723a 0a20  t ImportError:. 
+0001fc50: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0001fc60: 686f 775f 6461 7368 626f 6172 6420 3d20  how_dashboard = 
+0001fc70: 4661 6c73 650a 2020 2020 2020 2020 2020  False.          
+0001fc80: 2020 2020 2020 6874 7470 5f73 6572 7665        http_serve
+0001fc90: 725f 6d6f 6475 6c65 732e 6170 7065 6e64  r_modules.append
+0001fca0: 2822 6469 7374 7269 6275 7465 642e 6874  ("distributed.ht
+0001fcb0: 7470 2e73 6368 6564 756c 6572 2e6d 6973  tp.scheduler.mis
+0001fcc0: 7369 6e67 5f62 6f6b 6568 2229 0a20 2020  sing_bokeh").   
+0001fcd0: 2020 2020 2072 6f75 7465 7320 3d20 6765       routes = ge
+0001fce0: 745f 6861 6e64 6c65 7273 280a 2020 2020  t_handlers(.    
+0001fcf0: 2020 2020 2020 2020 7365 7276 6572 3d73          server=s
+0001fd00: 656c 662c 206d 6f64 756c 6573 3d68 7474  elf, modules=htt
+0001fd10: 705f 7365 7276 6572 5f6d 6f64 756c 6573  p_server_modules
+0001fd20: 2c20 7072 6566 6978 3d68 7474 705f 7072  , prefix=http_pr
+0001fd30: 6566 6978 0a20 2020 2020 2020 2029 0a20  efix.        ). 
+0001fd40: 2020 2020 2020 2073 656c 662e 7374 6172         self.star
+0001fd50: 745f 6874 7470 5f73 6572 7665 7228 726f  t_http_server(ro
+0001fd60: 7574 6573 2c20 6461 7368 626f 6172 645f  utes, dashboard_
+0001fd70: 6164 6472 6573 732c 2064 6566 6175 6c74  address, default
+0001fd80: 5f70 6f72 743d 3837 3837 290a 2020 2020  _port=8787).    
+0001fd90: 2020 2020 7365 6c66 2e6a 7570 7974 6572      self.jupyter
+0001fda0: 203d 206a 7570 7974 6572 0a20 2020 2020   = jupyter.     
+0001fdb0: 2020 2069 6620 7368 6f77 5f64 6173 6862     if show_dashb
+0001fdc0: 6f61 7264 3a0a 2020 2020 2020 2020 2020  oard:.          
+0001fdd0: 2020 6469 7374 7269 6275 7465 642e 6461    distributed.da
+0001fde0: 7368 626f 6172 642e 7363 6865 6475 6c65  shboard.schedule
+0001fdf0: 722e 636f 6e6e 6563 7428 0a20 2020 2020  r.connect(.     
+0001fe00: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0001fe10: 6874 7470 5f61 7070 6c69 6361 7469 6f6e  http_application
+0001fe20: 2c20 7365 6c66 2e68 7474 705f 7365 7276  , self.http_serv
+0001fe30: 6572 2c20 7365 6c66 2c20 7072 6566 6978  er, self, prefix
+0001fe40: 3d68 7474 705f 7072 6566 6978 0a20 2020  =http_prefix.   
+0001fe50: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0001fe60: 2020 2073 6368 6564 756c 6572 203d 2073     scheduler = s
+0001fe70: 656c 660a 2020 2020 2020 2020 6966 2073  elf.        if s
+0001fe80: 656c 662e 6a75 7079 7465 723a 0a20 2020  elf.jupyter:.   
+0001fe90: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+0001fea0: 2020 2020 2020 2020 2020 2020 2020 6672                fr
+0001feb0: 6f6d 206a 7570 7974 6572 5f73 6572 7665  om jupyter_serve
+0001fec0: 722e 7365 7276 6572 6170 7020 696d 706f  r.serverapp impo
+0001fed0: 7274 2053 6572 7665 7241 7070 0a20 2020  rt ServerApp.   
+0001fee0: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+0001fef0: 496d 706f 7274 4572 726f 723a 0a20 2020  ImportError:.   
+0001ff00: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+0001ff10: 7365 2049 6d70 6f72 7445 7272 6f72 280a  se ImportError(.
+0001ff20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ff30: 2020 2020 2249 6e20 6f72 6465 7220 746f      "In order to
+0001ff40: 2075 7365 2074 6865 2044 6173 6b20 6a75   use the Dask ju
+0001ff50: 7079 7465 7220 6f70 7469 6f6e 2079 6f75  pyter option you
+0001ff60: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+0001ff70: 2020 2020 2020 2022 6e65 6564 2074 6f20         "need to 
+0001ff80: 6861 7665 206a 7570 7974 6572 6c61 6220  have jupyterlab 
+0001ff90: 696e 7374 616c 6c65 6422 0a20 2020 2020  installed".     
+0001ffa0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0001ffb0: 2020 2020 2020 2020 2066 726f 6d20 7472           from tr
+0001ffc0: 6169 746c 6574 732e 636f 6e66 6967 2069  aitlets.config i
+0001ffd0: 6d70 6f72 7420 436f 6e66 6967 0a0a 2020  mport Config..  
+0001ffe0: 2020 2020 2020 2020 2020 2222 2248 5454            """HTT
+0001fff0: 5020 6861 6e64 6c65 7220 746f 2073 6875  P handler to shu
+00020000: 7420 646f 776e 2074 6865 204a 7570 7974  t down the Jupyt
+00020010: 6572 2073 6572 7665 722e 0a20 2020 2020  er server..     
+00020020: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00020030: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+00020040: 2020 2020 2020 2020 2020 2020 6672 6f6d              from
+00020050: 206a 7570 7974 6572 5f73 6572 7665 722e   jupyter_server.
+00020060: 6175 7468 2069 6d70 6f72 7420 6175 7468  auth import auth
+00020070: 6f72 697a 6564 0a20 2020 2020 2020 2020  orized.         
+00020080: 2020 2065 7863 6570 7420 496d 706f 7274     except Import
+00020090: 4572 726f 723a 0a0a 2020 2020 2020 2020  Error:..        
+000200a0: 2020 2020 2020 2020 6465 6620 6175 7468          def auth
+000200b0: 6f72 697a 6564 2863 293a 0a20 2020 2020  orized(c):.     
+000200c0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000200d0: 6574 7572 6e20 630a 0a20 2020 2020 2020  eturn c..       
+000200e0: 2020 2020 2066 726f 6d20 6a75 7079 7465       from jupyte
+000200f0: 725f 7365 7276 6572 2e62 6173 652e 6861  r_server.base.ha
+00020100: 6e64 6c65 7273 2069 6d70 6f72 7420 4a75  ndlers import Ju
+00020110: 7079 7465 7248 616e 646c 6572 0a0a 2020  pyterHandler..  
+00020120: 2020 2020 2020 2020 2020 636c 6173 7320            class 
+00020130: 5368 7574 646f 776e 4861 6e64 6c65 7228  ShutdownHandler(
+00020140: 4a75 7079 7465 7248 616e 646c 6572 293a  JupyterHandler):
+00020150: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020160: 2022 2222 4120 7368 7574 646f 776e 2041   """A shutdown A
+00020170: 5049 2068 616e 646c 6572 2e22 2222 0a0a  PI handler."""..
+00020180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020190: 6175 7468 5f72 6573 6f75 7263 6520 3d20  auth_resource = 
+000201a0: 2273 6572 7665 7222 0a0a 2020 2020 2020  "server"..      
+000201b0: 2020 2020 2020 2020 2020 4074 6f72 6e61            @torna
+000201c0: 646f 2e77 6562 2e61 7574 6865 6e74 6963  do.web.authentic
+000201d0: 6174 6564 0a20 2020 2020 2020 2020 2020  ated.           
+000201e0: 2020 2020 2040 6175 7468 6f72 697a 6564       @authorized
+000201f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020200: 2061 7379 6e63 2064 6566 2070 6f73 7428   async def post(
+00020210: 7365 6c66 293a 0a20 2020 2020 2020 2020  self):.         
+00020220: 2020 2020 2020 2020 2020 2022 2222 5368             """Sh
+00020230: 7574 2064 6f77 6e20 7468 6520 7365 7276  ut down the serv
+00020240: 6572 2e22 2222 0a20 2020 2020 2020 2020  er.""".         
+00020250: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00020260: 6c6f 672e 696e 666f 2822 5368 7574 7469  log.info("Shutti
+00020270: 6e67 2064 6f77 6e20 6f6e 202f 6170 692f  ng down on /api/
+00020280: 7368 7574 646f 776e 2072 6571 7565 7374  shutdown request
+00020290: 2e22 290a 0a20 2020 2020 2020 2020 2020  .")..           
+000202a0: 2020 2020 2020 2020 2061 7761 6974 2073           await s
+000202b0: 6368 6564 756c 6572 2e63 6c6f 7365 2872  cheduler.close(r
+000202c0: 6561 736f 6e3d 2273 6875 7464 6f77 6e20  eason="shutdown 
+000202d0: 7265 7175 6573 7465 6420 7669 6120 4a75  requested via Ju
+000202e0: 7079 7465 7222 290a 0a20 2020 2020 2020  pyter")..       
+000202f0: 2020 2020 206a 203d 2053 6572 7665 7241       j = ServerA
+00020300: 7070 2e69 6e73 7461 6e63 6528 0a20 2020  pp.instance(.   
+00020310: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+00020320: 6669 673d 436f 6e66 6967 280a 2020 2020  fig=Config(.    
+00020330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020340: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00020350: 2020 2020 2020 2020 2020 2253 6572 7665            "Serve
+00020360: 7241 7070 223a 207b 0a20 2020 2020 2020  rApp": {.       
+00020370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020380: 2020 2020 2022 6261 7365 5f75 726c 223a       "base_url":
+00020390: 2022 6a75 7079 7465 7222 2c0a 2020 2020   "jupyter",.    
+000203a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000203b0: 2020 2020 2020 2020 2320 5345 4355 5249          # SECURI
+000203c0: 5459 3a20 5765 2075 7375 616c 6c79 2065  TY: We usually e
+000203d0: 7870 6563 7420 7468 6520 6461 7368 626f  xpect the dashbo
+000203e0: 6172 6420 746f 2062 6520 6120 7265 6164  ard to be a read
+000203f0: 2d6f 6e6c 7920 7669 6577 2069 6e74 6f0a  -only view into.
+00020400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020410: 2020 2020 2020 2020 2020 2020 2320 7468              # th
+00020420: 6520 7363 6865 6475 6c65 7220 6163 7469  e scheduler acti
+00020430: 7669 7479 2e20 486f 7765 7665 722c 2062  vity. However, b
+00020440: 7920 6164 6469 6e67 2061 6e20 6f70 656e  y adding an open
+00020450: 204a 7570 7974 6572 2061 7070 6c69 6361   Jupyter applica
+00020460: 7469 6f6e 0a20 2020 2020 2020 2020 2020  tion.           
+00020470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020480: 2023 2077 6520 6172 6520 616c 6c6f 7769   # we are allowi
+00020490: 6e67 2061 7262 6974 7261 7279 2072 656d  ng arbitrary rem
+000204a0: 6f74 6520 636f 6465 2065 7865 6375 7469  ote code executi
+000204b0: 6f6e 206f 6e20 7468 6520 7363 6865 6475  on on the schedu
+000204c0: 6c65 7220 7669 6120 7468 650a 2020 2020  ler via the.    
+000204d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000204e0: 2020 2020 2020 2020 2320 6461 7368 626f          # dashbo
+000204f0: 6172 6420 7365 7276 6572 2e20 5468 6973  ard server. This
+00020500: 206f 7074 696f 6e20 7368 6f75 6c64 206f   option should o
+00020510: 6e6c 7920 6265 2075 7365 6420 7768 656e  nly be used when
+00020520: 2074 6865 2064 6173 6862 6f61 7264 2069   the dashboard i
+00020530: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+00020540: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00020550: 7072 6f74 6563 7465 6420 7669 6120 6f74  protected via ot
+00020560: 6865 7220 6d65 616e 732c 206f 7220 7768  her means, or wh
+00020570: 656e 2079 6f75 2064 6f6e 2774 2063 6172  en you don't car
+00020580: 6520 6162 6f75 7420 636c 7573 7465 7220  e about cluster 
+00020590: 7365 6375 7269 7479 2e0a 2020 2020 2020  security..      
+000205a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000205b0: 2020 2020 2020 2274 6f6b 656e 223a 2022        "token": "
+000205c0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+000205d0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+000205e0: 616c 6c6f 775f 7265 6d6f 7465 5f61 6363  allow_remote_acc
+000205f0: 6573 7322 3a20 5472 7565 2c0a 2020 2020  ess": True,.    
+00020600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020610: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+00020620: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
 00020630: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00020640: 2020 2020 2020 2020 2020 6a2e 696e 6974            j.init
-00020650: 6961 6c69 7a65 280a 2020 2020 2020 2020  ialize(.        
-00020660: 2020 2020 2020 2020 6e65 775f 6874 7470          new_http
-00020670: 7365 7276 6572 3d46 616c 7365 2c0a 2020  server=False,.  
-00020680: 2020 2020 2020 2020 2020 2020 2020 6172                ar
-00020690: 6776 3d5b 5d2c 0a20 2020 2020 2020 2020  gv=[],.         
-000206a0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-000206b0: 2073 656c 662e 5f6a 7570 7974 6572 5f73   self._jupyter_s
-000206c0: 6572 7665 725f 6170 706c 6963 6174 696f  erver_applicatio
-000206d0: 6e20 3d20 6a0a 2020 2020 2020 2020 2020  n = j.          
-000206e0: 2020 7368 7574 646f 776e 5f61 7070 203d    shutdown_app =
-000206f0: 2074 6f72 6e61 646f 2e77 6562 2e41 7070   tornado.web.App
-00020700: 6c69 6361 7469 6f6e 280a 2020 2020 2020  lication(.      
-00020710: 2020 2020 2020 2020 2020 5b28 7222 2f6a            [(r"/j
-00020720: 7570 7974 6572 2f61 7069 2f73 6875 7464  upyter/api/shutd
-00020730: 6f77 6e22 2c20 5368 7574 646f 776e 4861  own", ShutdownHa
-00020740: 6e64 6c65 7229 5d0a 2020 2020 2020 2020  ndler)].        
-00020750: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00020760: 2020 7368 7574 646f 776e 5f61 7070 2e73    shutdown_app.s
-00020770: 6574 7469 6e67 7320 3d20 6a2e 7765 625f  ettings = j.web_
-00020780: 6170 702e 7365 7474 696e 6773 0a20 2020  app.settings.   
-00020790: 2020 2020 2020 2020 2073 656c 662e 6874           self.ht
-000207a0: 7470 5f61 7070 6c69 6361 7469 6f6e 2e61  tp_application.a
-000207b0: 6464 5f61 7070 6c69 6361 7469 6f6e 2873  dd_application(s
-000207c0: 6875 7464 6f77 6e5f 6170 7029 0a20 2020  hutdown_app).   
-000207d0: 2020 2020 2020 2020 2073 656c 662e 6874           self.ht
-000207e0: 7470 5f61 7070 6c69 6361 7469 6f6e 2e61  tp_application.a
-000207f0: 6464 5f61 7070 6c69 6361 7469 6f6e 286a  dd_application(j
-00020800: 2e77 6562 5f61 7070 290a 0a20 2020 2020  .web_app)..     
-00020810: 2020 2023 2043 6f6d 6d75 6e69 6361 7469     # Communicati
-00020820: 6f6e 2073 7461 7465 0a20 2020 2020 2020  on state.       
-00020830: 2073 656c 662e 636c 6965 6e74 5f63 6f6d   self.client_com
-00020840: 6d73 203d 207b 7d0a 2020 2020 2020 2020  ms = {}.        
-00020850: 7365 6c66 2e73 7472 6561 6d5f 636f 6d6d  self.stream_comm
-00020860: 7320 3d20 7b7d 0a0a 2020 2020 2020 2020  s = {}..        
-00020870: 2320 5461 736b 2073 7461 7465 0a20 2020  # Task state.   
-00020880: 2020 2020 2074 6173 6b73 203d 207b 7d0a       tasks = {}.
-00020890: 0a20 2020 2020 2020 2073 656c 662e 6765  .        self.ge
-000208a0: 6e65 7261 7469 6f6e 203d 2030 0a20 2020  neration = 0.   
-000208b0: 2020 2020 2073 656c 662e 5f6c 6173 745f       self._last_
-000208c0: 636c 6965 6e74 203d 204e 6f6e 650a 2020  client = None.  
-000208d0: 2020 2020 2020 7365 6c66 2e5f 6c61 7374        self._last
-000208e0: 5f74 696d 6520 3d20 300a 2020 2020 2020  _time = 0.      
-000208f0: 2020 756e 7275 6e6e 6162 6c65 203d 2073    unrunnable = s
-00020900: 6574 2829 0a20 2020 2020 2020 2071 7565  et().        que
-00020910: 7565 6420 3d20 4865 6170 5365 7428 6b65  ued = HeapSet(ke
-00020920: 793d 6f70 6572 6174 6f72 2e61 7474 7267  y=operator.attrg
-00020930: 6574 7465 7228 2270 7269 6f72 6974 7922  etter("priority"
-00020940: 2929 0a0a 2020 2020 2020 2020 7365 6c66  ))..        self
-00020950: 2e64 6174 6173 6574 7320 3d20 7b7d 0a0a  .datasets = {}..
-00020960: 2020 2020 2020 2020 2320 5072 6566 6978          # Prefix
-00020970: 2d6b 6579 6564 2063 6f6e 7461 696e 6572  -keyed container
-00020980: 730a 0a20 2020 2020 2020 2023 2043 6c69  s..        # Cli
-00020990: 656e 7420 7374 6174 650a 2020 2020 2020  ent state.      
-000209a0: 2020 636c 6965 6e74 7320 3d20 7b7d 0a0a    clients = {}..
-000209b0: 2020 2020 2020 2020 2320 576f 726b 6572          # Worker
-000209c0: 2073 7461 7465 0a20 2020 2020 2020 2077   state.        w
-000209d0: 6f72 6b65 7273 203d 2053 6f72 7465 6444  orkers = SortedD
-000209e0: 6963 7428 290a 0a20 2020 2020 2020 2068  ict()..        h
-000209f0: 6f73 745f 696e 666f 203d 207b 7d0a 2020  ost_info = {}.  
-00020a00: 2020 2020 2020 7265 736f 7572 6365 7320        resources 
-00020a10: 3d20 7b7d 0a20 2020 2020 2020 2061 6c69  = {}.        ali
-00020a20: 6173 6573 203d 207b 7d0a 0a20 2020 2020  ases = {}..     
-00020a30: 2020 2073 656c 662e 5f77 6f72 6b65 725f     self._worker_
-00020a40: 636f 6c6c 6563 7469 6f6e 7320 3d20 5b0a  collections = [.
-00020a50: 2020 2020 2020 2020 2020 2020 776f 726b              work
-00020a60: 6572 732c 0a20 2020 2020 2020 2020 2020  ers,.           
-00020a70: 2068 6f73 745f 696e 666f 2c0a 2020 2020   host_info,.    
-00020a80: 2020 2020 2020 2020 7265 736f 7572 6365          resource
-00020a90: 732c 0a20 2020 2020 2020 2020 2020 2061  s,.            a
-00020aa0: 6c69 6173 6573 2c0a 2020 2020 2020 2020  liases,.        
-00020ab0: 5d0a 0a20 2020 2020 2020 206d 6178 6c65  ]..        maxle
-00020ac0: 6e20 3d20 6461 736b 2e63 6f6e 6669 672e  n = dask.config.
-00020ad0: 6765 7428 2264 6973 7472 6962 7574 6564  get("distributed
-00020ae0: 2e61 646d 696e 2e6c 6f77 2d6c 6576 656c  .admin.low-level
-00020af0: 2d6c 6f67 2d6c 656e 6774 6822 290a 2020  -log-length").  
-00020b00: 2020 2020 2020 7365 6c66 2e65 7665 6e74        self.event
-00020b10: 7320 3d20 6465 6661 756c 7464 6963 7428  s = defaultdict(
-00020b20: 7061 7274 6961 6c28 6465 7175 652c 206d  partial(deque, m
-00020b30: 6178 6c65 6e3d 6d61 786c 656e 2929 0a20  axlen=maxlen)). 
-00020b40: 2020 2020 2020 2073 656c 662e 6576 656e         self.even
-00020b50: 745f 636f 756e 7473 203d 2064 6566 6175  t_counts = defau
-00020b60: 6c74 6469 6374 2869 6e74 290a 2020 2020  ltdict(int).    
-00020b70: 2020 2020 7365 6c66 2e65 7665 6e74 5f73      self.event_s
-00020b80: 7562 7363 7269 6265 7220 3d20 6465 6661  ubscriber = defa
-00020b90: 756c 7464 6963 7428 7365 7429 0a20 2020  ultdict(set).   
-00020ba0: 2020 2020 2073 656c 662e 776f 726b 6572       self.worker
-00020bb0: 5f70 6c75 6769 6e73 203d 207b 7d0a 2020  _plugins = {}.  
-00020bc0: 2020 2020 2020 7365 6c66 2e6e 616e 6e79        self.nanny
-00020bd0: 5f70 6c75 6769 6e73 203d 207b 7d0a 2020  _plugins = {}.  
-00020be0: 2020 2020 2020 7365 6c66 2e5f 7374 6172        self._star
-00020bf0: 7469 6e67 5f6e 616e 6e69 6573 203d 2073  ting_nannies = s
-00020c00: 6574 2829 0a20 2020 2020 2020 2073 656c  et().        sel
-00020c10: 662e 5f73 7461 7274 696e 675f 6e61 6e6e  f._starting_nann
-00020c20: 6965 735f 636f 6e64 203d 2061 7379 6e63  ies_cond = async
-00020c30: 696f 2e43 6f6e 6469 7469 6f6e 2829 0a0a  io.Condition()..
-00020c40: 2020 2020 2020 2020 776f 726b 6572 5f68          worker_h
-00020c50: 616e 646c 6572 7320 3d20 7b0a 2020 2020  andlers = {.    
-00020c60: 2020 2020 2020 2020 2274 6173 6b2d 6669          "task-fi
-00020c70: 6e69 7368 6564 223a 2073 656c 662e 6861  nished": self.ha
-00020c80: 6e64 6c65 5f74 6173 6b5f 6669 6e69 7368  ndle_task_finish
-00020c90: 6564 2c0a 2020 2020 2020 2020 2020 2020  ed,.            
-00020ca0: 2274 6173 6b2d 6572 7265 6422 3a20 7365  "task-erred": se
-00020cb0: 6c66 2e68 616e 646c 655f 7461 736b 5f65  lf.handle_task_e
-00020cc0: 7272 6564 2c0a 2020 2020 2020 2020 2020  rred,.          
-00020cd0: 2020 2272 656c 6561 7365 2d77 6f72 6b65    "release-worke
-00020ce0: 722d 6461 7461 223a 2073 656c 662e 7265  r-data": self.re
-00020cf0: 6c65 6173 655f 776f 726b 6572 5f64 6174  lease_worker_dat
-00020d00: 612c 0a20 2020 2020 2020 2020 2020 2022  a,.            "
-00020d10: 6164 642d 6b65 7973 223a 2073 656c 662e  add-keys": self.
-00020d20: 6164 645f 6b65 7973 2c0a 2020 2020 2020  add_keys,.      
-00020d30: 2020 2020 2020 226c 6f6e 672d 7275 6e6e        "long-runn
-00020d40: 696e 6722 3a20 7365 6c66 2e68 616e 646c  ing": self.handl
-00020d50: 655f 6c6f 6e67 5f72 756e 6e69 6e67 2c0a  e_long_running,.
-00020d60: 2020 2020 2020 2020 2020 2020 2272 6573              "res
-00020d70: 6368 6564 756c 6522 3a20 7365 6c66 2e5f  chedule": self._
-00020d80: 7265 7363 6865 6475 6c65 2c0a 2020 2020  reschedule,.    
-00020d90: 2020 2020 2020 2020 226b 6565 702d 616c          "keep-al
-00020da0: 6976 6522 3a20 6c61 6d62 6461 202a 6172  ive": lambda *ar
-00020db0: 6773 2c20 2a2a 6b77 6172 6773 3a20 4e6f  gs, **kwargs: No
-00020dc0: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
-00020dd0: 226c 6f67 2d65 7665 6e74 223a 2073 656c  "log-event": sel
-00020de0: 662e 6c6f 675f 776f 726b 6572 5f65 7665  f.log_worker_eve
-00020df0: 6e74 2c0a 2020 2020 2020 2020 2020 2020  nt,.            
-00020e00: 2277 6f72 6b65 722d 7374 6174 7573 2d63  "worker-status-c
-00020e10: 6861 6e67 6522 3a20 7365 6c66 2e68 616e  hange": self.han
-00020e20: 646c 655f 776f 726b 6572 5f73 7461 7475  dle_worker_statu
-00020e30: 735f 6368 616e 6765 2c0a 2020 2020 2020  s_change,.      
-00020e40: 2020 2020 2020 2272 6571 7565 7374 2d72        "request-r
-00020e50: 6566 7265 7368 2d77 686f 2d68 6173 223a  efresh-who-has":
-00020e60: 2073 656c 662e 6861 6e64 6c65 5f72 6571   self.handle_req
-00020e70: 7565 7374 5f72 6566 7265 7368 5f77 686f  uest_refresh_who
-00020e80: 5f68 6173 2c0a 2020 2020 2020 2020 7d0a  _has,.        }.
-00020e90: 0a20 2020 2020 2020 2063 6c69 656e 745f  .        client_
-00020ea0: 6861 6e64 6c65 7273 203d 207b 0a20 2020  handlers = {.   
-00020eb0: 2020 2020 2020 2020 2022 7570 6461 7465           "update
-00020ec0: 2d67 7261 7068 223a 2073 656c 662e 7570  -graph": self.up
-00020ed0: 6461 7465 5f67 7261 7068 2c0a 2020 2020  date_graph,.    
-00020ee0: 2020 2020 2020 2020 2263 6c69 656e 742d          "client-
-00020ef0: 6465 7369 7265 732d 6b65 7973 223a 2073  desires-keys": s
-00020f00: 656c 662e 636c 6965 6e74 5f64 6573 6972  elf.client_desir
-00020f10: 6573 5f6b 6579 732c 0a20 2020 2020 2020  es_keys,.       
-00020f20: 2020 2020 2022 7570 6461 7465 2d64 6174       "update-dat
-00020f30: 6122 3a20 7365 6c66 2e75 7064 6174 655f  a": self.update_
-00020f40: 6461 7461 2c0a 2020 2020 2020 2020 2020  data,.          
-00020f50: 2020 2272 6570 6f72 742d 6b65 7922 3a20    "report-key": 
-00020f60: 7365 6c66 2e72 6570 6f72 745f 6f6e 5f6b  self.report_on_k
-00020f70: 6579 2c0a 2020 2020 2020 2020 2020 2020  ey,.            
-00020f80: 2263 6c69 656e 742d 7265 6c65 6173 6573  "client-releases
-00020f90: 2d6b 6579 7322 3a20 7365 6c66 2e63 6c69  -keys": self.cli
-00020fa0: 656e 745f 7265 6c65 6173 6573 5f6b 6579  ent_releases_key
-00020fb0: 732c 0a20 2020 2020 2020 2020 2020 2022  s,.            "
-00020fc0: 6865 6172 7462 6561 742d 636c 6965 6e74  heartbeat-client
-00020fd0: 223a 2073 656c 662e 636c 6965 6e74 5f68  ": self.client_h
-00020fe0: 6561 7274 6265 6174 2c0a 2020 2020 2020  eartbeat,.      
-00020ff0: 2020 2020 2020 2263 6c6f 7365 2d63 6c69        "close-cli
-00021000: 656e 7422 3a20 7365 6c66 2e72 656d 6f76  ent": self.remov
-00021010: 655f 636c 6965 6e74 2c0a 2020 2020 2020  e_client,.      
-00021020: 2020 2020 2020 2273 7562 7363 7269 6265        "subscribe
-00021030: 2d74 6f70 6963 223a 2073 656c 662e 7375  -topic": self.su
-00021040: 6273 6372 6962 655f 746f 7069 632c 0a20  bscribe_topic,. 
-00021050: 2020 2020 2020 2020 2020 2022 756e 7375             "unsu
-00021060: 6273 6372 6962 652d 746f 7069 6322 3a20  bscribe-topic": 
-00021070: 7365 6c66 2e75 6e73 7562 7363 7269 6265  self.unsubscribe
-00021080: 5f74 6f70 6963 2c0a 2020 2020 2020 2020  _topic,.        
-00021090: 2020 2020 2263 616e 6365 6c2d 6b65 7973      "cancel-keys
-000210a0: 223a 2073 656c 662e 7374 696d 756c 7573  ": self.stimulus
-000210b0: 5f63 616e 6365 6c2c 0a20 2020 2020 2020  _cancel,.       
-000210c0: 207d 0a0a 2020 2020 2020 2020 7365 6c66   }..        self
-000210d0: 2e68 616e 646c 6572 7320 3d20 7b0a 2020  .handlers = {.  
-000210e0: 2020 2020 2020 2020 2020 2272 6567 6973            "regis
-000210f0: 7465 722d 636c 6965 6e74 223a 2073 656c  ter-client": sel
-00021100: 662e 6164 645f 636c 6965 6e74 2c0a 2020  f.add_client,.  
-00021110: 2020 2020 2020 2020 2020 2273 6361 7474            "scatt
-00021120: 6572 223a 2073 656c 662e 7363 6174 7465  er": self.scatte
-00021130: 722c 0a20 2020 2020 2020 2020 2020 2022  r,.            "
-00021140: 7265 6769 7374 6572 2d77 6f72 6b65 7222  register-worker"
-00021150: 3a20 7365 6c66 2e61 6464 5f77 6f72 6b65  : self.add_worke
-00021160: 722c 0a20 2020 2020 2020 2020 2020 2022  r,.            "
-00021170: 7265 6769 7374 6572 5f6e 616e 6e79 223a  register_nanny":
-00021180: 2073 656c 662e 6164 645f 6e61 6e6e 792c   self.add_nanny,
-00021190: 0a20 2020 2020 2020 2020 2020 2022 756e  .            "un
-000211a0: 7265 6769 7374 6572 223a 2073 656c 662e  register": self.
-000211b0: 7265 6d6f 7665 5f77 6f72 6b65 722c 0a20  remove_worker,. 
-000211c0: 2020 2020 2020 2020 2020 2022 6761 7468             "gath
-000211d0: 6572 223a 2073 656c 662e 6761 7468 6572  er": self.gather
-000211e0: 2c0a 2020 2020 2020 2020 2020 2020 2272  ,.            "r
-000211f0: 6574 7279 223a 2073 656c 662e 7374 696d  etry": self.stim
-00021200: 756c 7573 5f72 6574 7279 2c0a 2020 2020  ulus_retry,.    
-00021210: 2020 2020 2020 2020 2266 6565 6422 3a20          "feed": 
-00021220: 7365 6c66 2e66 6565 642c 0a20 2020 2020  self.feed,.     
-00021230: 2020 2020 2020 2022 7465 726d 696e 6174         "terminat
-00021240: 6522 3a20 7365 6c66 2e63 6c6f 7365 2c0a  e": self.close,.
-00021250: 2020 2020 2020 2020 2020 2020 2262 726f              "bro
-00021260: 6164 6361 7374 223a 2073 656c 662e 6272  adcast": self.br
-00021270: 6f61 6463 6173 742c 0a20 2020 2020 2020  oadcast,.       
-00021280: 2020 2020 2022 7072 6f78 7922 3a20 7365       "proxy": se
-00021290: 6c66 2e70 726f 7879 2c0a 2020 2020 2020  lf.proxy,.      
-000212a0: 2020 2020 2020 226e 636f 7265 7322 3a20        "ncores": 
-000212b0: 7365 6c66 2e67 6574 5f6e 636f 7265 732c  self.get_ncores,
-000212c0: 0a20 2020 2020 2020 2020 2020 2022 6e63  .            "nc
-000212d0: 6f72 6573 5f72 756e 6e69 6e67 223a 2073  ores_running": s
-000212e0: 656c 662e 6765 745f 6e63 6f72 6573 5f72  elf.get_ncores_r
-000212f0: 756e 6e69 6e67 2c0a 2020 2020 2020 2020  unning,.        
-00021300: 2020 2020 2268 6173 5f77 6861 7422 3a20      "has_what": 
-00021310: 7365 6c66 2e67 6574 5f68 6173 5f77 6861  self.get_has_wha
-00021320: 742c 0a20 2020 2020 2020 2020 2020 2022  t,.            "
-00021330: 7768 6f5f 6861 7322 3a20 7365 6c66 2e67  who_has": self.g
-00021340: 6574 5f77 686f 5f68 6173 2c0a 2020 2020  et_who_has,.    
-00021350: 2020 2020 2020 2020 2270 726f 6365 7373          "process
-00021360: 696e 6722 3a20 7365 6c66 2e67 6574 5f70  ing": self.get_p
-00021370: 726f 6365 7373 696e 672c 0a20 2020 2020  rocessing,.     
-00021380: 2020 2020 2020 2022 6361 6c6c 5f73 7461         "call_sta
-00021390: 636b 223a 2073 656c 662e 6765 745f 6361  ck": self.get_ca
-000213a0: 6c6c 5f73 7461 636b 2c0a 2020 2020 2020  ll_stack,.      
-000213b0: 2020 2020 2020 2270 726f 6669 6c65 223a        "profile":
-000213c0: 2073 656c 662e 6765 745f 7072 6f66 696c   self.get_profil
-000213d0: 652c 0a20 2020 2020 2020 2020 2020 2022  e,.            "
-000213e0: 7065 7266 6f72 6d61 6e63 655f 7265 706f  performance_repo
-000213f0: 7274 223a 2073 656c 662e 7065 7266 6f72  rt": self.perfor
-00021400: 6d61 6e63 655f 7265 706f 7274 2c0a 2020  mance_report,.  
-00021410: 2020 2020 2020 2020 2020 2267 6574 5f6c            "get_l
-00021420: 6f67 7322 3a20 7365 6c66 2e67 6574 5f6c  ogs": self.get_l
-00021430: 6f67 732c 0a20 2020 2020 2020 2020 2020  ogs,.           
-00021440: 2022 6c6f 6773 223a 2073 656c 662e 6765   "logs": self.ge
-00021450: 745f 6c6f 6773 2c0a 2020 2020 2020 2020  t_logs,.        
-00021460: 2020 2020 2277 6f72 6b65 725f 6c6f 6773      "worker_logs
-00021470: 223a 2073 656c 662e 6765 745f 776f 726b  ": self.get_work
-00021480: 6572 5f6c 6f67 732c 0a20 2020 2020 2020  er_logs,.       
-00021490: 2020 2020 2022 6c6f 675f 6576 656e 7422       "log_event"
-000214a0: 3a20 7365 6c66 2e6c 6f67 5f65 7665 6e74  : self.log_event
-000214b0: 2c0a 2020 2020 2020 2020 2020 2020 2265  ,.            "e
-000214c0: 7665 6e74 7322 3a20 7365 6c66 2e67 6574  vents": self.get
-000214d0: 5f65 7665 6e74 732c 0a20 2020 2020 2020  _events,.       
-000214e0: 2020 2020 2022 6e62 7974 6573 223a 2073       "nbytes": s
-000214f0: 656c 662e 6765 745f 6e62 7974 6573 2c0a  elf.get_nbytes,.
-00021500: 2020 2020 2020 2020 2020 2020 2276 6572              "ver
-00021510: 7369 6f6e 7322 3a20 7365 6c66 2e76 6572  sions": self.ver
-00021520: 7369 6f6e 732c 0a20 2020 2020 2020 2020  sions,.         
-00021530: 2020 2022 6164 645f 6b65 7973 223a 2073     "add_keys": s
-00021540: 656c 662e 6164 645f 6b65 7973 2c0a 2020  elf.add_keys,.  
-00021550: 2020 2020 2020 2020 2020 2272 6562 616c            "rebal
-00021560: 616e 6365 223a 2073 656c 662e 7265 6261  ance": self.reba
-00021570: 6c61 6e63 652c 0a20 2020 2020 2020 2020  lance,.         
-00021580: 2020 2022 7265 706c 6963 6174 6522 3a20     "replicate": 
-00021590: 7365 6c66 2e72 6570 6c69 6361 7465 2c0a  self.replicate,.
-000215a0: 2020 2020 2020 2020 2020 2020 2272 756e              "run
-000215b0: 5f66 756e 6374 696f 6e22 3a20 7365 6c66  _function": self
-000215c0: 2e72 756e 5f66 756e 6374 696f 6e2c 0a20  .run_function,. 
-000215d0: 2020 2020 2020 2020 2020 2022 7265 7374             "rest
-000215e0: 6172 7422 3a20 7365 6c66 2e72 6573 7461  art": self.resta
-000215f0: 7274 2c0a 2020 2020 2020 2020 2020 2020  rt,.            
-00021600: 2272 6573 7461 7274 5f77 6f72 6b65 7273  "restart_workers
-00021610: 223a 2073 656c 662e 7265 7374 6172 745f  ": self.restart_
-00021620: 776f 726b 6572 732c 0a20 2020 2020 2020  workers,.       
-00021630: 2020 2020 2022 7570 6461 7465 5f64 6174       "update_dat
-00021640: 6122 3a20 7365 6c66 2e75 7064 6174 655f  a": self.update_
-00021650: 6461 7461 2c0a 2020 2020 2020 2020 2020  data,.          
-00021660: 2020 2273 6574 5f72 6573 6f75 7263 6573    "set_resources
-00021670: 223a 2073 656c 662e 6164 645f 7265 736f  ": self.add_reso
-00021680: 7572 6365 732c 0a20 2020 2020 2020 2020  urces,.         
-00021690: 2020 2022 7265 7469 7265 5f77 6f72 6b65     "retire_worke
-000216a0: 7273 223a 2073 656c 662e 7265 7469 7265  rs": self.retire
-000216b0: 5f77 6f72 6b65 7273 2c0a 2020 2020 2020  _workers,.      
-000216c0: 2020 2020 2020 2267 6574 5f6d 6574 6164        "get_metad
-000216d0: 6174 6122 3a20 7365 6c66 2e67 6574 5f6d  ata": self.get_m
-000216e0: 6574 6164 6174 612c 0a20 2020 2020 2020  etadata,.       
-000216f0: 2020 2020 2022 7365 745f 6d65 7461 6461       "set_metada
-00021700: 7461 223a 2073 656c 662e 7365 745f 6d65  ta": self.set_me
-00021710: 7461 6461 7461 2c0a 2020 2020 2020 2020  tadata,.        
-00021720: 2020 2020 2273 6574 5f72 6573 7472 6963      "set_restric
-00021730: 7469 6f6e 7322 3a20 7365 6c66 2e73 6574  tions": self.set
-00021740: 5f72 6573 7472 6963 7469 6f6e 732c 0a20  _restrictions,. 
-00021750: 2020 2020 2020 2020 2020 2022 6865 6172             "hear
-00021760: 7462 6561 745f 776f 726b 6572 223a 2073  tbeat_worker": s
-00021770: 656c 662e 6865 6172 7462 6561 745f 776f  elf.heartbeat_wo
-00021780: 726b 6572 2c0a 2020 2020 2020 2020 2020  rker,.          
-00021790: 2020 2267 6574 5f74 6173 6b5f 7374 6174    "get_task_stat
-000217a0: 7573 223a 2073 656c 662e 6765 745f 7461  us": self.get_ta
-000217b0: 736b 5f73 7461 7475 732c 0a20 2020 2020  sk_status,.     
-000217c0: 2020 2020 2020 2022 6765 745f 7461 736b         "get_task
-000217d0: 5f73 7472 6561 6d22 3a20 7365 6c66 2e67  _stream": self.g
-000217e0: 6574 5f74 6173 6b5f 7374 7265 616d 2c0a  et_task_stream,.
-000217f0: 2020 2020 2020 2020 2020 2020 2267 6574              "get
-00021800: 5f74 6173 6b5f 7072 6566 6978 5f73 7461  _task_prefix_sta
-00021810: 7465 7322 3a20 7365 6c66 2e67 6574 5f74  tes": self.get_t
-00021820: 6173 6b5f 7072 6566 6978 5f73 7461 7465  ask_prefix_state
-00021830: 732c 0a20 2020 2020 2020 2020 2020 2022  s,.            "
-00021840: 7265 6769 7374 6572 5f73 6368 6564 756c  register_schedul
-00021850: 6572 5f70 6c75 6769 6e22 3a20 7365 6c66  er_plugin": self
-00021860: 2e72 6567 6973 7465 725f 7363 6865 6475  .register_schedu
-00021870: 6c65 725f 706c 7567 696e 2c0a 2020 2020  ler_plugin,.    
-00021880: 2020 2020 2020 2020 2275 6e72 6567 6973          "unregis
-00021890: 7465 725f 7363 6865 6475 6c65 725f 706c  ter_scheduler_pl
-000218a0: 7567 696e 223a 2073 656c 662e 756e 7265  ugin": self.unre
-000218b0: 6769 7374 6572 5f73 6368 6564 756c 6572  gister_scheduler
-000218c0: 5f70 6c75 6769 6e2c 0a20 2020 2020 2020  _plugin,.       
-000218d0: 2020 2020 2022 7265 6769 7374 6572 5f77       "register_w
-000218e0: 6f72 6b65 725f 706c 7567 696e 223a 2073  orker_plugin": s
-000218f0: 656c 662e 7265 6769 7374 6572 5f77 6f72  elf.register_wor
-00021900: 6b65 725f 706c 7567 696e 2c0a 2020 2020  ker_plugin,.    
-00021910: 2020 2020 2020 2020 2275 6e72 6567 6973          "unregis
-00021920: 7465 725f 776f 726b 6572 5f70 6c75 6769  ter_worker_plugi
-00021930: 6e22 3a20 7365 6c66 2e75 6e72 6567 6973  n": self.unregis
-00021940: 7465 725f 776f 726b 6572 5f70 6c75 6769  ter_worker_plugi
-00021950: 6e2c 0a20 2020 2020 2020 2020 2020 2022  n,.            "
-00021960: 7265 6769 7374 6572 5f6e 616e 6e79 5f70  register_nanny_p
-00021970: 6c75 6769 6e22 3a20 7365 6c66 2e72 6567  lugin": self.reg
-00021980: 6973 7465 725f 6e61 6e6e 795f 706c 7567  ister_nanny_plug
-00021990: 696e 2c0a 2020 2020 2020 2020 2020 2020  in,.            
-000219a0: 2275 6e72 6567 6973 7465 725f 6e61 6e6e  "unregister_nann
-000219b0: 795f 706c 7567 696e 223a 2073 656c 662e  y_plugin": self.
-000219c0: 756e 7265 6769 7374 6572 5f6e 616e 6e79  unregister_nanny
-000219d0: 5f70 6c75 6769 6e2c 0a20 2020 2020 2020  _plugin,.       
-000219e0: 2020 2020 2022 6164 6170 7469 7665 5f74       "adaptive_t
-000219f0: 6172 6765 7422 3a20 7365 6c66 2e61 6461  arget": self.ada
-00021a00: 7074 6976 655f 7461 7267 6574 2c0a 2020  ptive_target,.  
-00021a10: 2020 2020 2020 2020 2020 2277 6f72 6b65            "worke
-00021a20: 7273 5f74 6f5f 636c 6f73 6522 3a20 7365  rs_to_close": se
-00021a30: 6c66 2e77 6f72 6b65 7273 5f74 6f5f 636c  lf.workers_to_cl
-00021a40: 6f73 652c 0a20 2020 2020 2020 2020 2020  ose,.           
-00021a50: 2022 7375 6273 6372 6962 655f 776f 726b   "subscribe_work
-00021a60: 6572 5f73 7461 7475 7322 3a20 7365 6c66  er_status": self
-00021a70: 2e73 7562 7363 7269 6265 5f77 6f72 6b65  .subscribe_worke
-00021a80: 725f 7374 6174 7573 2c0a 2020 2020 2020  r_status,.      
-00021a90: 2020 2020 2020 2273 7461 7274 5f74 6173        "start_tas
-00021aa0: 6b5f 6d65 7461 6461 7461 223a 2073 656c  k_metadata": sel
-00021ab0: 662e 7374 6172 745f 7461 736b 5f6d 6574  f.start_task_met
-00021ac0: 6164 6174 612c 0a20 2020 2020 2020 2020  adata,.         
-00021ad0: 2020 2022 7374 6f70 5f74 6173 6b5f 6d65     "stop_task_me
-00021ae0: 7461 6461 7461 223a 2073 656c 662e 7374  tadata": self.st
-00021af0: 6f70 5f74 6173 6b5f 6d65 7461 6461 7461  op_task_metadata
-00021b00: 2c0a 2020 2020 2020 2020 2020 2020 2267  ,.            "g
-00021b10: 6574 5f63 6c75 7374 6572 5f73 7461 7465  et_cluster_state
-00021b20: 223a 2073 656c 662e 6765 745f 636c 7573  ": self.get_clus
-00021b30: 7465 725f 7374 6174 652c 0a20 2020 2020  ter_state,.     
-00021b40: 2020 2020 2020 2022 6475 6d70 5f63 6c75         "dump_clu
-00021b50: 7374 6572 5f73 7461 7465 5f74 6f5f 7572  ster_state_to_ur
-00021b60: 6c22 3a20 7365 6c66 2e64 756d 705f 636c  l": self.dump_cl
-00021b70: 7573 7465 725f 7374 6174 655f 746f 5f75  uster_state_to_u
-00021b80: 726c 2c0a 2020 2020 2020 2020 2020 2020  rl,.            
-00021b90: 2262 656e 6368 6d61 726b 5f68 6172 6477  "benchmark_hardw
-00021ba0: 6172 6522 3a20 7365 6c66 2e62 656e 6368  are": self.bench
-00021bb0: 6d61 726b 5f68 6172 6477 6172 652c 0a20  mark_hardware,. 
-00021bc0: 2020 2020 2020 2020 2020 2022 6765 745f             "get_
-00021bd0: 7374 6f72 7922 3a20 7365 6c66 2e67 6574  story": self.get
-00021be0: 5f73 746f 7279 2c0a 2020 2020 2020 2020  _story,.        
-00021bf0: 2020 2020 2263 6865 636b 5f69 646c 6522      "check_idle"
-00021c00: 3a20 7365 6c66 2e63 6865 636b 5f69 646c  : self.check_idl
-00021c10: 652c 0a20 2020 2020 2020 207d 0a0a 2020  e,.        }..  
-00021c20: 2020 2020 2020 636f 6e6e 6563 7469 6f6e        connection
-00021c30: 5f6c 696d 6974 203d 2067 6574 5f66 696c  _limit = get_fil
-00021c40: 656e 6f5f 6c69 6d69 7428 2920 2f20 320a  eno_limit() / 2.
-00021c50: 0a20 2020 2020 2020 2053 6368 6564 756c  .        Schedul
-00021c60: 6572 5374 6174 652e 5f5f 696e 6974 5f5f  erState.__init__
-00021c70: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
-00021c80: 6c66 2c0a 2020 2020 2020 2020 2020 2020  lf,.            
-00021c90: 616c 6961 7365 733d 616c 6961 7365 732c  aliases=aliases,
-00021ca0: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
-00021cb0: 656e 7473 3d63 6c69 656e 7473 2c0a 2020  ents=clients,.  
-00021cc0: 2020 2020 2020 2020 2020 776f 726b 6572            worker
-00021cd0: 733d 776f 726b 6572 732c 0a20 2020 2020  s=workers,.     
-00021ce0: 2020 2020 2020 2068 6f73 745f 696e 666f         host_info
-00021cf0: 3d68 6f73 745f 696e 666f 2c0a 2020 2020  =host_info,.    
-00021d00: 2020 2020 2020 2020 7265 736f 7572 6365          resource
-00021d10: 733d 7265 736f 7572 6365 732c 0a20 2020  s=resources,.   
-00021d20: 2020 2020 2020 2020 2074 6173 6b73 3d74           tasks=t
-00021d30: 6173 6b73 2c0a 2020 2020 2020 2020 2020  asks,.          
-00021d40: 2020 756e 7275 6e6e 6162 6c65 3d75 6e72    unrunnable=unr
-00021d50: 756e 6e61 626c 652c 0a20 2020 2020 2020  unnable,.       
-00021d60: 2020 2020 2071 7565 7565 643d 7175 6575       queued=queu
-00021d70: 6564 2c0a 2020 2020 2020 2020 2020 2020  ed,.            
-00021d80: 7661 6c69 6461 7465 3d76 616c 6964 6174  validate=validat
-00021d90: 652c 0a20 2020 2020 2020 2020 2020 2070  e,.            p
-00021da0: 6c75 6769 6e73 3d70 6c75 6769 6e73 2c0a  lugins=plugins,.
-00021db0: 2020 2020 2020 2020 2020 2020 7472 616e              tran
-00021dc0: 7369 7469 6f6e 5f63 6f75 6e74 6572 5f6d  sition_counter_m
-00021dd0: 6178 3d74 7261 6e73 6974 696f 6e5f 636f  ax=transition_co
-00021de0: 756e 7465 725f 6d61 782c 0a20 2020 2020  unter_max,.     
-00021df0: 2020 2029 0a20 2020 2020 2020 2053 6572     ).        Ser
-00021e00: 7665 724e 6f64 652e 5f5f 696e 6974 5f5f  verNode.__init__
-00021e10: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
-00021e20: 6c66 2c0a 2020 2020 2020 2020 2020 2020  lf,.            
-00021e30: 6861 6e64 6c65 7273 3d73 656c 662e 6861  handlers=self.ha
-00021e40: 6e64 6c65 7273 2c0a 2020 2020 2020 2020  ndlers,.        
-00021e50: 2020 2020 7374 7265 616d 5f68 616e 646c      stream_handl
-00021e60: 6572 733d 6d65 7267 6528 776f 726b 6572  ers=merge(worker
-00021e70: 5f68 616e 646c 6572 732c 2063 6c69 656e  _handlers, clien
-00021e80: 745f 6861 6e64 6c65 7273 292c 0a20 2020  t_handlers),.   
-00021e90: 2020 2020 2020 2020 2063 6f6e 6e65 6374           connect
-00021ea0: 696f 6e5f 6c69 6d69 743d 636f 6e6e 6563  ion_limit=connec
-00021eb0: 7469 6f6e 5f6c 696d 6974 2c0a 2020 2020  tion_limit,.    
-00021ec0: 2020 2020 2020 2020 6465 7365 7269 616c          deserial
-00021ed0: 697a 653d 4661 6c73 652c 0a20 2020 2020  ize=False,.     
-00021ee0: 2020 2020 2020 2063 6f6e 6e65 6374 696f         connectio
-00021ef0: 6e5f 6172 6773 3d73 656c 662e 636f 6e6e  n_args=self.conn
-00021f00: 6563 7469 6f6e 5f61 7267 732c 0a20 2020  ection_args,.   
-00021f10: 2020 2020 2020 2020 202a 2a6b 7761 7267           **kwarg
-00021f20: 732c 0a20 2020 2020 2020 2029 0a0a 2020  s,.        )..  
-00021f30: 2020 2020 2020 6966 2073 656c 662e 776f        if self.wo
-00021f40: 726b 6572 5f74 746c 3a0a 2020 2020 2020  rker_ttl:.      
-00021f50: 2020 2020 2020 7063 203d 2050 6572 696f        pc = Perio
-00021f60: 6469 6343 616c 6c62 6163 6b28 7365 6c66  dicCallback(self
-00021f70: 2e63 6865 636b 5f77 6f72 6b65 725f 7474  .check_worker_tt
-00021f80: 6c2c 2073 656c 662e 776f 726b 6572 5f74  l, self.worker_t
-00021f90: 746c 202a 2031 3030 3029 0a20 2020 2020  tl * 1000).     
-00021fa0: 2020 2020 2020 2073 656c 662e 7065 7269         self.peri
-00021fb0: 6f64 6963 5f63 616c 6c62 6163 6b73 5b22  odic_callbacks["
-00021fc0: 776f 726b 6572 2d74 746c 225d 203d 2070  worker-ttl"] = p
-00021fd0: 630a 0a20 2020 2020 2020 2070 6320 3d20  c..        pc = 
-00021fe0: 5065 7269 6f64 6963 4361 6c6c 6261 636b  PeriodicCallback
-00021ff0: 2873 656c 662e 6368 6563 6b5f 6964 6c65  (self.check_idle
-00022000: 2c20 3235 3029 0a20 2020 2020 2020 2073  , 250).        s
-00022010: 656c 662e 7065 7269 6f64 6963 5f63 616c  elf.periodic_cal
-00022020: 6c62 6163 6b73 5b22 6964 6c65 2d74 696d  lbacks["idle-tim
-00022030: 656f 7574 225d 203d 2070 630a 0a20 2020  eout"] = pc..   
-00022040: 2020 2020 2070 6320 3d20 5065 7269 6f64       pc = Period
-00022050: 6963 4361 6c6c 6261 636b 2873 656c 662e  icCallback(self.
-00022060: 5f63 6865 636b 5f6e 6f5f 776f 726b 6572  _check_no_worker
-00022070: 732c 2032 3530 290a 2020 2020 2020 2020  s, 250).        
-00022080: 7365 6c66 2e70 6572 696f 6469 635f 6361  self.periodic_ca
-00022090: 6c6c 6261 636b 735b 226e 6f2d 776f 726b  llbacks["no-work
-000220a0: 6572 732d 7469 6d65 6f75 7422 5d20 3d20  ers-timeout"] = 
-000220b0: 7063 0a0a 2020 2020 2020 2020 6966 2065  pc..        if e
-000220c0: 7874 656e 7369 6f6e 7320 6973 204e 6f6e  xtensions is Non
-000220d0: 653a 0a20 2020 2020 2020 2020 2020 2065  e:.            e
-000220e0: 7874 656e 7369 6f6e 7320 3d20 4445 4641  xtensions = DEFA
-000220f0: 554c 545f 4558 5445 4e53 494f 4e53 2e63  ULT_EXTENSIONS.c
-00022100: 6f70 7928 290a 2020 2020 2020 2020 2020  opy().          
-00022110: 2020 6966 206e 6f74 2064 6173 6b2e 636f    if not dask.co
-00022120: 6e66 6967 2e67 6574 2822 6469 7374 7269  nfig.get("distri
-00022130: 6275 7465 642e 7363 6865 6475 6c65 722e  buted.scheduler.
-00022140: 776f 726b 2d73 7465 616c 696e 6722 293a  work-stealing"):
-00022150: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022160: 2069 6620 2273 7465 616c 696e 6722 2069   if "stealing" i
-00022170: 6e20 6578 7465 6e73 696f 6e73 3a0a 2020  n extensions:.  
-00022180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022190: 2020 6465 6c20 6578 7465 6e73 696f 6e73    del extensions
-000221a0: 5b22 7374 6561 6c69 6e67 225d 0a0a 2020  ["stealing"]..  
-000221b0: 2020 2020 2020 666f 7220 6e61 6d65 2c20        for name, 
-000221c0: 6578 7465 6e73 696f 6e20 696e 2065 7874  extension in ext
-000221d0: 656e 7369 6f6e 732e 6974 656d 7328 293a  ensions.items():
-000221e0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-000221f0: 662e 6578 7465 6e73 696f 6e73 5b6e 616d  f.extensions[nam
-00022200: 655d 203d 2065 7874 656e 7369 6f6e 2873  e] = extension(s
-00022210: 656c 6629 0a0a 2020 2020 2020 2020 7365  elf)..        se
-00022220: 7470 726f 6374 6974 6c65 2822 6461 736b  tproctitle("dask
-00022230: 2073 6368 6564 756c 6572 205b 6e6f 7420   scheduler [not 
-00022240: 7374 6172 7465 645d 2229 0a20 2020 2020  started]").     
-00022250: 2020 2053 6368 6564 756c 6572 2e5f 696e     Scheduler._in
-00022260: 7374 616e 6365 732e 6164 6428 7365 6c66  stances.add(self
-00022270: 290a 2020 2020 2020 2020 7365 6c66 2e72  ).        self.r
-00022280: 7063 2e61 6c6c 6f77 5f6f 6666 6c6f 6164  pc.allow_offload
-00022290: 203d 2046 616c 7365 0a0a 2020 2020 2323   = False..    ##
-000222a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000222b0: 0a20 2020 2023 2041 646d 696e 6973 7472  .    # Administr
-000222c0: 6174 696f 6e20 230a 2020 2020 2323 2323  ation #.    ####
-000222d0: 2323 2323 2323 2323 2323 2323 2323 0a0a  ##############..
-000222e0: 2020 2020 6465 6620 5f5f 7265 7072 5f5f      def __repr__
-000222f0: 2873 656c 6629 202d 3e20 7374 723a 0a20  (self) -> str:. 
-00022300: 2020 2020 2020 2072 6574 7572 6e20 280a         return (.
-00022310: 2020 2020 2020 2020 2020 2020 6622 3c53              f"<S
-00022320: 6368 6564 756c 6572 207b 7365 6c66 2e61  cheduler {self.a
-00022330: 6464 7265 7373 5f73 6166 6521 727d 2c20  ddress_safe!r}, 
-00022340: 220a 2020 2020 2020 2020 2020 2020 6622  ".            f"
-00022350: 776f 726b 6572 733a 207b 6c65 6e28 7365  workers: {len(se
-00022360: 6c66 2e77 6f72 6b65 7273 297d 2c20 220a  lf.workers)}, ".
-00022370: 2020 2020 2020 2020 2020 2020 6622 636f              f"co
-00022380: 7265 733a 207b 7365 6c66 2e74 6f74 616c  res: {self.total
-00022390: 5f6e 7468 7265 6164 737d 2c20 220a 2020  _nthreads}, ".  
-000223a0: 2020 2020 2020 2020 2020 6622 7461 736b            f"task
-000223b0: 733a 207b 6c65 6e28 7365 6c66 2e74 6173  s: {len(self.tas
-000223c0: 6b73 297d 3e22 0a20 2020 2020 2020 2029  ks)}>".        )
-000223d0: 0a0a 2020 2020 6465 6620 5f72 6570 725f  ..    def _repr_
-000223e0: 6874 6d6c 5f28 7365 6c66 2920 2d3e 2073  html_(self) -> s
-000223f0: 7472 3a0a 2020 2020 2020 2020 7265 7475  tr:.        retu
-00022400: 726e 2067 6574 5f74 656d 706c 6174 6528  rn get_template(
-00022410: 2273 6368 6564 756c 6572 2e68 746d 6c2e  "scheduler.html.
-00022420: 6a32 2229 2e72 656e 6465 7228 0a20 2020  j2").render(.   
-00022430: 2020 2020 2020 2020 2061 6464 7265 7373           address
-00022440: 3d73 656c 662e 6164 6472 6573 732c 0a20  =self.address,. 
-00022450: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
-00022460: 7273 3d73 656c 662e 776f 726b 6572 732c  rs=self.workers,
-00022470: 0a20 2020 2020 2020 2020 2020 2074 6872  .            thr
-00022480: 6561 6473 3d73 656c 662e 746f 7461 6c5f  eads=self.total_
-00022490: 6e74 6872 6561 6473 2c0a 2020 2020 2020  nthreads,.      
-000224a0: 2020 2020 2020 7461 736b 733d 7365 6c66        tasks=self
-000224b0: 2e74 6173 6b73 2c0a 2020 2020 2020 2020  .tasks,.        
-000224c0: 290a 0a20 2020 2064 6566 2069 6465 6e74  )..    def ident
-000224d0: 6974 7928 7365 6c66 2920 2d3e 2064 6963  ity(self) -> dic
-000224e0: 745b 7374 722c 2041 6e79 5d3a 0a20 2020  t[str, Any]:.   
-000224f0: 2020 2020 2022 2222 4261 7369 6320 696e       """Basic in
-00022500: 666f 726d 6174 696f 6e20 6162 6f75 7420  formation about 
-00022510: 6f75 7273 656c 7665 7320 616e 6420 6f75  ourselves and ou
-00022520: 7220 636c 7573 7465 7222 2222 0a20 2020  r cluster""".   
-00022530: 2020 2020 2064 203d 207b 0a20 2020 2020       d = {.     
-00022540: 2020 2020 2020 2022 7479 7065 223a 2074         "type": t
-00022550: 7970 6528 7365 6c66 292e 5f5f 6e61 6d65  ype(self).__name
-00022560: 5f5f 2c0a 2020 2020 2020 2020 2020 2020  __,.            
-00022570: 2269 6422 3a20 7374 7228 7365 6c66 2e69  "id": str(self.i
-00022580: 6429 2c0a 2020 2020 2020 2020 2020 2020  d),.            
-00022590: 2261 6464 7265 7373 223a 2073 656c 662e  "address": self.
-000225a0: 6164 6472 6573 732c 0a20 2020 2020 2020  address,.       
-000225b0: 2020 2020 2022 7365 7276 6963 6573 223a       "services":
-000225c0: 207b 6b65 793a 2076 2e70 6f72 7420 666f   {key: v.port fo
-000225d0: 7220 286b 6579 2c20 7629 2069 6e20 7365  r (key, v) in se
-000225e0: 6c66 2e73 6572 7669 6365 732e 6974 656d  lf.services.item
-000225f0: 7328 297d 2c0a 2020 2020 2020 2020 2020  s()},.          
-00022600: 2020 2273 7461 7274 6564 223a 2073 656c    "started": sel
-00022610: 662e 7469 6d65 5f73 7461 7274 6564 2c0a  f.time_started,.
-00022620: 2020 2020 2020 2020 2020 2020 2277 6f72              "wor
-00022630: 6b65 7273 223a 207b 0a20 2020 2020 2020  kers": {.       
-00022640: 2020 2020 2020 2020 2077 6f72 6b65 722e           worker.
-00022650: 6164 6472 6573 733a 2077 6f72 6b65 722e  address: worker.
-00022660: 6964 656e 7469 7479 2829 2066 6f72 2077  identity() for w
-00022670: 6f72 6b65 7220 696e 2073 656c 662e 776f  orker in self.wo
-00022680: 726b 6572 732e 7661 6c75 6573 2829 0a20  rkers.values(). 
-00022690: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
-000226a0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-000226b0: 7265 7475 726e 2064 0a0a 2020 2020 6465  return d..    de
-000226c0: 6620 5f74 6f5f 6469 6374 2873 656c 662c  f _to_dict(self,
-000226d0: 202a 2c20 6578 636c 7564 653a 2043 6f6e   *, exclude: Con
-000226e0: 7461 696e 6572 5b73 7472 5d20 3d20 2829  tainer[str] = ()
-000226f0: 2920 2d3e 2064 6963 743a 0a20 2020 2020  ) -> dict:.     
-00022700: 2020 2022 2222 4469 6374 696f 6e61 7279     """Dictionary
-00022710: 2072 6570 7265 7365 6e74 6174 696f 6e20   representation 
-00022720: 666f 7220 6465 6275 6767 696e 6720 7075  for debugging pu
-00022730: 7270 6f73 6573 2e0a 2020 2020 2020 2020  rposes..        
-00022740: 4e6f 7420 7479 7065 2073 7461 626c 6520  Not type stable 
-00022750: 616e 6420 6e6f 7420 696e 7465 6e64 6564  and not intended
-00022760: 2066 6f72 2072 6f75 6e64 7472 6970 732e   for roundtrips.
-00022770: 0a0a 2020 2020 2020 2020 5365 6520 616c  ..        See al
-00022780: 736f 0a20 2020 2020 2020 202d 2d2d 2d2d  so.        -----
-00022790: 2d2d 2d0a 2020 2020 2020 2020 5365 7276  ---.        Serv
-000227a0: 6572 2e69 6465 6e74 6974 790a 2020 2020  er.identity.    
-000227b0: 2020 2020 436c 6965 6e74 2e64 756d 705f      Client.dump_
-000227c0: 636c 7573 7465 725f 7374 6174 650a 2020  cluster_state.  
-000227d0: 2020 2020 2020 6469 7374 7269 6275 7465        distribute
-000227e0: 642e 7574 696c 732e 7265 6375 7273 6976  d.utils.recursiv
-000227f0: 655f 746f 5f64 6963 740a 2020 2020 2020  e_to_dict.      
-00022800: 2020 2222 220a 2020 2020 2020 2020 696e    """.        in
-00022810: 666f 203d 2073 7570 6572 2829 2e5f 746f  fo = super()._to
-00022820: 5f64 6963 7428 6578 636c 7564 653d 6578  _dict(exclude=ex
-00022830: 636c 7564 6529 0a20 2020 2020 2020 2065  clude).        e
-00022840: 7874 7261 203d 207b 0a20 2020 2020 2020  xtra = {.       
-00022850: 2020 2020 2022 7472 616e 7369 7469 6f6e       "transition
-00022860: 5f6c 6f67 223a 2073 656c 662e 7472 616e  _log": self.tran
-00022870: 7369 7469 6f6e 5f6c 6f67 2c0a 2020 2020  sition_log,.    
-00022880: 2020 2020 2020 2020 2274 7261 6e73 6974          "transit
-00022890: 696f 6e5f 636f 756e 7465 7222 3a20 7365  ion_counter": se
-000228a0: 6c66 2e74 7261 6e73 6974 696f 6e5f 636f  lf.transition_co
-000228b0: 756e 7465 722c 0a20 2020 2020 2020 2020  unter,.         
-000228c0: 2020 2022 7461 736b 7322 3a20 7365 6c66     "tasks": self
-000228d0: 2e74 6173 6b73 2c0a 2020 2020 2020 2020  .tasks,.        
-000228e0: 2020 2020 2274 6173 6b5f 6772 6f75 7073      "task_groups
-000228f0: 223a 2073 656c 662e 7461 736b 5f67 726f  ": self.task_gro
-00022900: 7570 732c 0a20 2020 2020 2020 2020 2020  ups,.           
-00022910: 2023 204f 7665 7277 7269 7465 2064 6963   # Overwrite dic
-00022920: 7420 6f66 2057 6f72 6b65 7253 7461 7465  t of WorkerState
-00022930: 2e69 6465 6e74 6974 7920 6672 6f6d 2069  .identity from i
-00022940: 6e66 6f0a 2020 2020 2020 2020 2020 2020  nfo.            
-00022950: 2277 6f72 6b65 7273 223a 2073 656c 662e  "workers": self.
-00022960: 776f 726b 6572 732c 0a20 2020 2020 2020  workers,.       
-00022970: 2020 2020 2022 636c 6965 6e74 7322 3a20       "clients": 
-00022980: 7365 6c66 2e63 6c69 656e 7473 2c0a 2020  self.clients,.  
-00022990: 2020 2020 2020 2020 2020 226d 656d 6f72            "memor
-000229a0: 7922 3a20 7365 6c66 2e6d 656d 6f72 792c  y": self.memory,
-000229b0: 0a20 2020 2020 2020 2020 2020 2022 6576  .            "ev
-000229c0: 656e 7473 223a 2073 656c 662e 6576 656e  ents": self.even
-000229d0: 7473 2c0a 2020 2020 2020 2020 2020 2020  ts,.            
-000229e0: 2265 7874 656e 7369 6f6e 7322 3a20 7365  "extensions": se
-000229f0: 6c66 2e65 7874 656e 7369 6f6e 732c 0a20  lf.extensions,. 
-00022a00: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00022a10: 2065 7874 7261 203d 207b 6b3a 2076 2066   extra = {k: v f
-00022a20: 6f72 206b 2c20 7620 696e 2065 7874 7261  or k, v in extra
-00022a30: 2e69 7465 6d73 2829 2069 6620 6b20 6e6f  .items() if k no
-00022a40: 7420 696e 2065 7863 6c75 6465 7d0a 2020  t in exclude}.  
-00022a50: 2020 2020 2020 696e 666f 2e75 7064 6174        info.updat
-00022a60: 6528 7265 6375 7273 6976 655f 746f 5f64  e(recursive_to_d
-00022a70: 6963 7428 6578 7472 612c 2065 7863 6c75  ict(extra, exclu
-00022a80: 6465 3d65 7863 6c75 6465 2929 0a20 2020  de=exclude)).   
-00022a90: 2020 2020 2072 6574 7572 6e20 696e 666f       return info
-00022aa0: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
-00022ab0: 6765 745f 636c 7573 7465 725f 7374 6174  get_cluster_stat
-00022ac0: 6528 0a20 2020 2020 2020 2073 656c 662c  e(.        self,
-00022ad0: 0a20 2020 2020 2020 2065 7863 6c75 6465  .        exclude
-00022ae0: 3a20 436f 6c6c 6563 7469 6f6e 5b73 7472  : Collection[str
-00022af0: 5d2c 0a20 2020 2029 202d 3e20 6469 6374  ],.    ) -> dict
-00022b00: 3a0a 2020 2020 2020 2020 2250 726f 6475  :.        "Produ
-00022b10: 6365 2074 6865 2073 7461 7465 2064 6963  ce the state dic
-00022b20: 7420 7573 6564 2069 6e20 6120 636c 7573  t used in a clus
-00022b30: 7465 7220 7374 6174 6520 6475 6d70 220a  ter state dump".
-00022b40: 2020 2020 2020 2020 2320 4b69 636b 206f          # Kick o
-00022b50: 6666 2073 7461 7465 2d64 756d 7069 6e67  ff state-dumping
-00022b60: 206f 6e20 776f 726b 6572 7320 6265 666f   on workers befo
-00022b70: 7265 2077 6520 626c 6f63 6b20 7468 6520  re we block the 
-00022b80: 6576 656e 7420 6c6f 6f70 2069 6e20 6073  event loop in `s
-00022b90: 656c 662e 5f74 6f5f 6469 6374 602e 0a20  elf._to_dict`.. 
-00022ba0: 2020 2020 2020 2077 6f72 6b65 7273 5f66         workers_f
-00022bb0: 7574 7572 6520 3d20 6173 796e 6369 6f2e  uture = asyncio.
-00022bc0: 6761 7468 6572 280a 2020 2020 2020 2020  gather(.        
-00022bd0: 2020 2020 7365 6c66 2e62 726f 6164 6361      self.broadca
-00022be0: 7374 280a 2020 2020 2020 2020 2020 2020  st(.            
-00022bf0: 2020 2020 6d73 673d 7b22 6f70 223a 2022      msg={"op": "
-00022c00: 6475 6d70 5f73 7461 7465 222c 2022 6578  dump_state", "ex
-00022c10: 636c 7564 6522 3a20 6578 636c 7564 657d  clude": exclude}
-00022c20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00022c30: 2020 6f6e 5f65 7272 6f72 3d22 7265 7475    on_error="retu
-00022c40: 726e 222c 0a20 2020 2020 2020 2020 2020  rn",.           
-00022c50: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
-00022c60: 7365 6c66 2e62 726f 6164 6361 7374 280a  self.broadcast(.
-00022c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022c80: 6d73 673d 7b22 6f70 223a 2022 7665 7273  msg={"op": "vers
-00022c90: 696f 6e73 227d 2c0a 2020 2020 2020 2020  ions"},.        
-00022ca0: 2020 2020 2020 2020 6f6e 5f65 7272 6f72          on_error
-00022cb0: 3d22 6967 6e6f 7265 222c 0a20 2020 2020  ="ignore",.     
-00022cc0: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
-00022cd0: 2020 290a 2020 2020 2020 2020 7472 793a    ).        try:
-00022ce0: 0a20 2020 2020 2020 2020 2020 2073 6368  .            sch
-00022cf0: 6564 756c 6572 5f73 7461 7465 203d 2073  eduler_state = s
-00022d00: 656c 662e 5f74 6f5f 6469 6374 2865 7863  elf._to_dict(exc
-00022d10: 6c75 6465 3d65 7863 6c75 6465 290a 0a20  lude=exclude).. 
-00022d20: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
-00022d30: 725f 7374 6174 6573 2c20 776f 726b 6572  r_states, worker
-00022d40: 5f76 6572 7369 6f6e 7320 3d20 6177 6169  _versions = awai
-00022d50: 7420 776f 726b 6572 735f 6675 7475 7265  t workers_future
-00022d60: 0a20 2020 2020 2020 2066 696e 616c 6c79  .        finally
-00022d70: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-00022d80: 456e 7375 7265 2074 6865 2074 6173 6b73  Ensure the tasks
-00022d90: 2061 7265 6e27 7420 6c65 6674 2072 756e   aren't left run
-00022da0: 6e69 6e67 2069 6620 616e 7974 6869 6e67  ning if anything
-00022db0: 2066 6169 6c73 2e0a 2020 2020 2020 2020   fails..        
-00022dc0: 2020 2020 2320 536f 6d65 6461 7920 2870      # Someday (p
-00022dd0: 7933 2e31 3129 2c20 7573 6520 6120 7472  y3.11), use a tr
-00022de0: 696f 2d73 7479 6c65 2054 6173 6b47 726f  io-style TaskGro
-00022df0: 7570 2066 6f72 2074 6869 732e 0a20 2020  up for this..   
-00022e00: 2020 2020 2020 2020 2077 6f72 6b65 7273           workers
-00022e10: 5f66 7574 7572 652e 6361 6e63 656c 2829  _future.cancel()
-00022e20: 0a0a 2020 2020 2020 2020 2320 436f 6e76  ..        # Conv
-00022e30: 6572 7420 616e 7920 5250 4320 6572 726f  ert any RPC erro
-00022e40: 7273 2074 6f20 7374 7269 6e67 730a 2020  rs to strings.  
-00022e50: 2020 2020 2020 776f 726b 6572 5f73 7461        worker_sta
-00022e60: 7465 7320 3d20 7b0a 2020 2020 2020 2020  tes = {.        
-00022e70: 2020 2020 6b3a 2072 6570 7228 7629 2069      k: repr(v) i
-00022e80: 6620 6973 696e 7374 616e 6365 2876 2c20  f isinstance(v, 
-00022e90: 4578 6365 7074 696f 6e29 2065 6c73 6520  Exception) else 
-00022ea0: 760a 2020 2020 2020 2020 2020 2020 666f  v.            fo
-00022eb0: 7220 6b2c 2076 2069 6e20 776f 726b 6572  r k, v in worker
-00022ec0: 5f73 7461 7465 732e 6974 656d 7328 290a  _states.items().
-00022ed0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-00022ee0: 2020 2072 6574 7572 6e20 7b0a 2020 2020     return {.    
-00022ef0: 2020 2020 2020 2020 2273 6368 6564 756c          "schedul
-00022f00: 6572 223a 2073 6368 6564 756c 6572 5f73  er": scheduler_s
-00022f10: 7461 7465 2c0a 2020 2020 2020 2020 2020  tate,.          
-00022f20: 2020 2277 6f72 6b65 7273 223a 2077 6f72    "workers": wor
-00022f30: 6b65 725f 7374 6174 6573 2c0a 2020 2020  ker_states,.    
-00022f40: 2020 2020 2020 2020 2276 6572 7369 6f6e          "version
-00022f50: 7322 3a20 7b22 7363 6865 6475 6c65 7222  s": {"scheduler"
-00022f60: 3a20 7365 6c66 2e76 6572 7369 6f6e 7328  : self.versions(
-00022f70: 292c 2022 776f 726b 6572 7322 3a20 776f  ), "workers": wo
-00022f80: 726b 6572 5f76 6572 7369 6f6e 737d 2c0a  rker_versions},.
-00022f90: 2020 2020 2020 2020 7d0a 0a20 2020 2061          }..    a
-00022fa0: 7379 6e63 2064 6566 2064 756d 705f 636c  sync def dump_cl
-00022fb0: 7573 7465 725f 7374 6174 655f 746f 5f75  uster_state_to_u
-00022fc0: 726c 280a 2020 2020 2020 2020 7365 6c66  rl(.        self
-00022fd0: 2c0a 2020 2020 2020 2020 7572 6c3a 2073  ,.        url: s
-00022fe0: 7472 2c0a 2020 2020 2020 2020 6578 636c  tr,.        excl
-00022ff0: 7564 653a 2043 6f6c 6c65 6374 696f 6e5b  ude: Collection[
-00023000: 7374 725d 2c0a 2020 2020 2020 2020 666f  str],.        fo
-00023010: 726d 6174 3a20 4c69 7465 7261 6c5b 226d  rmat: Literal["m
-00023020: 7367 7061 636b 222c 2022 7961 6d6c 225d  sgpack", "yaml"]
-00023030: 2c0a 2020 2020 2020 2020 2a2a 7374 6f72  ,.        **stor
-00023040: 6167 655f 6f70 7469 6f6e 733a 2064 6963  age_options: dic
-00023050: 745b 7374 722c 2041 6e79 5d2c 0a20 2020  t[str, Any],.   
-00023060: 2029 202d 3e20 4e6f 6e65 3a0a 2020 2020   ) -> None:.    
-00023070: 2020 2020 2257 7269 7465 2061 2063 6c75      "Write a clu
-00023080: 7374 6572 2073 7461 7465 2064 756d 7020  ster state dump 
-00023090: 746f 2061 6e20 6673 7370 6563 2d63 6f6d  to an fsspec-com
-000230a0: 7061 7469 626c 6520 5552 4c2e 220a 2020  patible URL.".  
-000230b0: 2020 2020 2020 6177 6169 7420 636c 7573        await clus
-000230c0: 7465 725f 6475 6d70 2e77 7269 7465 5f73  ter_dump.write_s
-000230d0: 7461 7465 280a 2020 2020 2020 2020 2020  tate(.          
-000230e0: 2020 7061 7274 6961 6c28 7365 6c66 2e67    partial(self.g
-000230f0: 6574 5f63 6c75 7374 6572 5f73 7461 7465  et_cluster_state
-00023100: 2c20 6578 636c 7564 6529 2c20 7572 6c2c  , exclude), url,
-00023110: 2066 6f72 6d61 742c 202a 2a73 746f 7261   format, **stora
-00023120: 6765 5f6f 7074 696f 6e73 0a20 2020 2020  ge_options.     
-00023130: 2020 2029 0a0a 2020 2020 6465 6620 6765     )..    def ge
-00023140: 745f 776f 726b 6572 5f73 6572 7669 6365  t_worker_service
-00023150: 5f61 6464 7228 0a20 2020 2020 2020 2073  _addr(.        s
-00023160: 656c 662c 2077 6f72 6b65 723a 2073 7472  elf, worker: str
-00023170: 2c20 7365 7276 6963 655f 6e61 6d65 3a20  , service_name: 
-00023180: 7374 722c 2070 726f 746f 636f 6c3a 2062  str, protocol: b
-00023190: 6f6f 6c20 3d20 4661 6c73 650a 2020 2020  ool = False.    
-000231a0: 2920 2d3e 2074 7570 6c65 5b73 7472 2c20  ) -> tuple[str, 
-000231b0: 696e 745d 207c 2073 7472 207c 204e 6f6e  int] | str | Non
-000231c0: 653a 0a20 2020 2020 2020 2022 2222 0a20  e:.        """. 
-000231d0: 2020 2020 2020 2047 6574 2074 6865 2028         Get the (
-000231e0: 686f 7374 2c20 706f 7274 2920 6164 6472  host, port) addr
-000231f0: 6573 7320 6f66 2074 6865 206e 616d 6564  ess of the named
-00023200: 2073 6572 7669 6365 206f 6e20 7468 6520   service on the 
-00023210: 2a77 6f72 6b65 722a 2e0a 2020 2020 2020  *worker*..      
-00023220: 2020 5265 7475 726e 7320 4e6f 6e65 2069    Returns None i
-00023230: 6620 7468 6520 7365 7276 6963 6520 646f  f the service do
-00023240: 6573 6e27 7420 6578 6973 742e 0a0a 2020  esn't exist...  
-00023250: 2020 2020 2020 5061 7261 6d65 7465 7273        Parameters
-00023260: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
-00023270: 2d2d 2d0a 2020 2020 2020 2020 776f 726b  ---.        work
-00023280: 6572 203a 2061 6464 7265 7373 0a20 2020  er : address.   
-00023290: 2020 2020 2073 6572 7669 6365 5f6e 616d       service_nam
-000232a0: 6520 3a20 7374 720a 2020 2020 2020 2020  e : str.        
-000232b0: 2020 2020 436f 6d6d 6f6e 2073 6572 7669      Common servi
-000232c0: 6365 7320 696e 636c 7564 6520 2762 6f6b  ces include 'bok
-000232d0: 6568 2720 616e 6420 276e 616e 6e79 270a  eh' and 'nanny'.
-000232e0: 2020 2020 2020 2020 7072 6f74 6f63 6f6c          protocol
-000232f0: 203a 2062 6f6f 6c65 616e 0a20 2020 2020   : boolean.     
-00023300: 2020 2020 2020 2057 6865 7468 6572 206f         Whether o
-00023310: 7220 6e6f 7420 746f 2069 6e63 6c75 6465  r not to include
-00023320: 2061 2066 756c 6c20 6164 6472 6573 7320   a full address 
-00023330: 7769 7468 2070 726f 746f 636f 6c20 2854  with protocol (T
-00023340: 7275 6529 0a20 2020 2020 2020 2020 2020  rue).           
-00023350: 206f 7220 6a75 7374 2061 2028 686f 7374   or just a (host
-00023360: 2c20 706f 7274 2920 7061 6972 0a20 2020  , port) pair.   
-00023370: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00023380: 2077 7320 3d20 7365 6c66 2e77 6f72 6b65   ws = self.worke
-00023390: 7273 5b77 6f72 6b65 725d 0a20 2020 2020  rs[worker].     
-000233a0: 2020 2070 6f72 7420 3d20 7773 2e73 6572     port = ws.ser
-000233b0: 7669 6365 732e 6765 7428 7365 7276 6963  vices.get(servic
-000233c0: 655f 6e61 6d65 290a 2020 2020 2020 2020  e_name).        
-000233d0: 6966 2070 6f72 7420 6973 204e 6f6e 653a  if port is None:
-000233e0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-000233f0: 7572 6e20 4e6f 6e65 0a20 2020 2020 2020  urn None.       
-00023400: 2065 6c69 6620 7072 6f74 6f63 6f6c 3a0a   elif protocol:.
-00023410: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00023420: 726e 2022 2528 7072 6f74 6f63 6f6c 2973  rn "%(protocol)s
-00023430: 3a2f 2f25 2868 6f73 7429 733a 2528 706f  ://%(host)s:%(po
-00023440: 7274 2964 2220 2520 7b0a 2020 2020 2020  rt)d" % {.      
-00023450: 2020 2020 2020 2020 2020 2270 726f 746f            "proto
-00023460: 636f 6c22 3a20 7773 2e61 6464 7265 7373  col": ws.address
-00023470: 2e73 706c 6974 2822 3a2f 2f22 295b 305d  .split("://")[0]
-00023480: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00023490: 2020 2268 6f73 7422 3a20 7773 2e68 6f73    "host": ws.hos
-000234a0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-000234b0: 2020 2022 706f 7274 223a 2070 6f72 742c     "port": port,
-000234c0: 0a20 2020 2020 2020 2020 2020 207d 0a20  .            }. 
-000234d0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-000234e0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-000234f0: 7773 2e68 6f73 742c 2070 6f72 740a 0a20  ws.host, port.. 
-00023500: 2020 2061 7379 6e63 2064 6566 2073 7461     async def sta
-00023510: 7274 5f75 6e73 6166 6528 7365 6c66 2920  rt_unsafe(self) 
-00023520: 2d3e 2053 656c 663a 0a20 2020 2020 2020  -> Self:.       
-00023530: 2022 2222 436c 6561 7220 6f75 7420 6f6c   """Clear out ol
-00023540: 6420 7374 6174 6520 616e 6420 7265 7374  d state and rest
-00023550: 6172 7420 616c 6c20 7275 6e6e 696e 6720  art all running 
-00023560: 636f 726f 7574 696e 6573 2222 220a 2020  coroutines""".  
-00023570: 2020 2020 2020 6177 6169 7420 7375 7065        await supe
-00023580: 7228 292e 7374 6172 745f 756e 7361 6665  r().start_unsafe
-00023590: 2829 0a0a 2020 2020 2020 2020 656e 6162  ()..        enab
-000235a0: 6c65 5f67 635f 6469 6167 6e6f 7369 7328  le_gc_diagnosis(
-000235b0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-000235c0: 5f63 6c65 6172 5f74 6173 6b5f 7374 6174  _clear_task_stat
-000235d0: 6528 290a 0a20 2020 2020 2020 2066 6f72  e()..        for
-000235e0: 2061 6464 7220 696e 2073 656c 662e 5f73   addr in self._s
-000235f0: 7461 7274 5f61 6464 7265 7373 3a0a 2020  tart_address:.  
-00023600: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-00023610: 7365 6c66 2e6c 6973 7465 6e28 0a20 2020  self.listen(.   
-00023620: 2020 2020 2020 2020 2020 2020 2061 6464               add
-00023630: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
-00023640: 2020 2061 6c6c 6f77 5f6f 6666 6c6f 6164     allow_offload
-00023650: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
-00023660: 2020 2020 2020 2020 6861 6e64 7368 616b          handshak
-00023670: 655f 6f76 6572 7269 6465 733d 7b22 7069  e_overrides={"pi
-00023680: 636b 6c65 2d70 726f 746f 636f 6c22 3a20  ckle-protocol": 
-00023690: 342c 2022 636f 6d70 7265 7373 696f 6e22  4, "compression"
-000236a0: 3a20 4e6f 6e65 7d2c 0a20 2020 2020 2020  : None},.       
-000236b0: 2020 2020 2020 2020 202a 2a73 656c 662e           **self.
-000236c0: 7365 6375 7269 7479 2e67 6574 5f6c 6973  security.get_lis
-000236d0: 7465 6e5f 6172 6773 2822 7363 6865 6475  ten_args("schedu
-000236e0: 6c65 7222 292c 0a20 2020 2020 2020 2020  ler"),.         
-000236f0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00023700: 2073 656c 662e 6970 203d 2067 6574 5f61   self.ip = get_a
-00023710: 6464 7265 7373 5f68 6f73 7428 7365 6c66  ddress_host(self
-00023720: 2e6c 6973 7465 6e5f 6164 6472 6573 7329  .listen_address)
-00023730: 0a20 2020 2020 2020 2020 2020 206c 6973  .            lis
-00023740: 7465 6e5f 6970 203d 2073 656c 662e 6970  ten_ip = self.ip
-00023750: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-00023760: 206c 6973 7465 6e5f 6970 203d 3d20 2230   listen_ip == "0
-00023770: 2e30 2e30 2e30 223a 0a20 2020 2020 2020  .0.0.0":.       
-00023780: 2020 2020 2020 2020 206c 6973 7465 6e5f           listen_
-00023790: 6970 203d 2022 220a 0a20 2020 2020 2020  ip = ""..       
-000237a0: 2069 6620 7365 6c66 2e61 6464 7265 7373   if self.address
-000237b0: 2e73 7461 7274 7377 6974 6828 2269 6e70  .startswith("inp
-000237c0: 726f 633a 2f2f 2229 3a0a 2020 2020 2020  roc://"):.      
-000237d0: 2020 2020 2020 6c69 7374 656e 5f69 7020        listen_ip 
-000237e0: 3d20 226c 6f63 616c 686f 7374 220a 0a20  = "localhost".. 
-000237f0: 2020 2020 2020 2023 2053 6572 7669 6365         # Service
-00023800: 7320 6c69 7374 656e 206f 6e20 616c 6c20  s listen on all 
-00023810: 6164 6472 6573 7365 730a 2020 2020 2020  addresses.      
-00023820: 2020 7365 6c66 2e73 7461 7274 5f73 6572    self.start_ser
-00023830: 7669 6365 7328 6c69 7374 656e 5f69 7029  vices(listen_ip)
-00023840: 0a0a 2020 2020 2020 2020 666f 7220 6c69  ..        for li
-00023850: 7374 656e 6572 2069 6e20 7365 6c66 2e6c  stener in self.l
-00023860: 6973 7465 6e65 7273 3a0a 2020 2020 2020  isteners:.      
-00023870: 2020 2020 2020 6c6f 6767 6572 2e69 6e66        logger.inf
-00023880: 6f28 2220 2053 6368 6564 756c 6572 2061  o("  Scheduler a
-00023890: 743a 2025 3235 7322 2c20 6c69 7374 656e  t: %25s", listen
-000238a0: 6572 2e63 6f6e 7461 6374 5f61 6464 7265  er.contact_addre
-000238b0: 7373 290a 2020 2020 2020 2020 666f 7220  ss).        for 
-000238c0: 6e61 6d65 2c20 7365 7276 6572 2069 6e20  name, server in 
-000238d0: 7365 6c66 2e73 6572 7669 6365 732e 6974  self.services.it
-000238e0: 656d 7328 293a 0a20 2020 2020 2020 2020  ems():.         
-000238f0: 2020 2069 6620 6e61 6d65 203d 3d20 2264     if name == "d
-00023900: 6173 6862 6f61 7264 223a 0a20 2020 2020  ashboard":.     
-00023910: 2020 2020 2020 2020 2020 2061 6464 7220             addr 
-00023920: 3d20 6765 745f 6164 6472 6573 735f 686f  = get_address_ho
-00023930: 7374 286c 6973 7465 6e65 722e 636f 6e74  st(listener.cont
-00023940: 6163 745f 6164 6472 6573 7329 0a20 2020  act_address).   
-00023950: 2020 2020 2020 2020 2020 2020 2074 7279               try
-00023960: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00023970: 2020 2020 2020 6c69 6e6b 203d 2066 6f72        link = for
-00023980: 6d61 745f 6461 7368 626f 6172 645f 6c69  mat_dashboard_li
-00023990: 6e6b 2861 6464 722c 2073 6572 7665 722e  nk(addr, server.
-000239a0: 706f 7274 290a 2020 2020 2020 2020 2020  port).          
-000239b0: 2020 2020 2020 2320 666f 726d 6174 7469        # formatti
-000239c0: 6e67 2064 6173 6862 6f61 7264 206c 696e  ng dashboard lin
-000239d0: 6b20 6361 6e20 6661 696c 2069 6620 6469  k can fail if di
-000239e0: 7374 7269 6275 7465 642e 6461 7368 626f  stributed.dashbo
-000239f0: 6172 642e 6c69 6e6b 0a20 2020 2020 2020  ard.link.       
-00023a00: 2020 2020 2020 2020 2023 2072 6566 6572           # refer
-00023a10: 7320 746f 206e 6f6e 2d65 7869 7374 616e  s to non-existan
-00023a20: 7420 656e 7620 7661 7273 2e0a 2020 2020  t env vars..    
-00023a30: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-00023a40: 7074 204b 6579 4572 726f 7220 6173 2065  pt KeyError as e
-00023a50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00023a60: 2020 2020 2020 6c6f 6767 6572 2e77 6172        logger.war
-00023a70: 6e69 6e67 280a 2020 2020 2020 2020 2020  ning(.          
-00023a80: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-00023a90: 4661 696c 6564 2074 6f20 666f 726d 6174  Failed to format
-00023aa0: 2064 6173 6862 6f61 7264 206c 696e 6b2c   dashboard link,
-00023ab0: 2075 6e6b 6e6f 776e 2076 616c 7565 3a20   unknown value: 
-00023ac0: 7b65 7d22 0a20 2020 2020 2020 2020 2020  {e}".           
-00023ad0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00023ae0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00023af0: 696e 6b20 3d20 6622 3a7b 7365 7276 6572  ink = f":{server
-00023b00: 2e70 6f72 747d 220a 2020 2020 2020 2020  .port}".        
-00023b10: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00023b20: 2020 2020 2020 2020 2020 6c69 6e6b 203d            link =
-00023b30: 2066 227b 6c69 7374 656e 5f69 707d 3a7b   f"{listen_ip}:{
-00023b40: 7365 7276 6572 2e70 6f72 747d 220a 2020  server.port}".  
-00023b50: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-00023b60: 2e69 6e66 6f28 2225 3131 7320 6174 3a20  .info("%11s at: 
-00023b70: 2025 3235 7322 2c20 6e61 6d65 2c20 6c69   %25s", name, li
-00023b80: 6e6b 290a 0a20 2020 2020 2020 2069 6620  nk)..        if 
-00023b90: 7365 6c66 2e73 6368 6564 756c 6572 5f66  self.scheduler_f
-00023ba0: 696c 653a 0a20 2020 2020 2020 2020 2020  ile:.           
-00023bb0: 2077 6974 6820 6f70 656e 2873 656c 662e   with open(self.
-00023bc0: 7363 6865 6475 6c65 725f 6669 6c65 2c20  scheduler_file, 
-00023bd0: 2277 2229 2061 7320 663a 0a20 2020 2020  "w") as f:.     
-00023be0: 2020 2020 2020 2020 2020 206a 736f 6e2e             json.
-00023bf0: 6475 6d70 2873 656c 662e 6964 656e 7469  dump(self.identi
-00023c00: 7479 2829 2c20 662c 2069 6e64 656e 743d  ty(), f, indent=
-00023c10: 3229 0a0a 2020 2020 2020 2020 2020 2020  2)..            
-00023c20: 666e 203d 2073 656c 662e 7363 6865 6475  fn = self.schedu
-00023c30: 6c65 725f 6669 6c65 2020 2320 7265 6d6f  ler_file  # remo
-00023c40: 7665 2066 696c 6520 7768 656e 2077 6520  ve file when we 
-00023c50: 636c 6f73 6520 7468 6520 7072 6f63 6573  close the proces
-00023c60: 730a 0a20 2020 2020 2020 2020 2020 2064  s..            d
-00023c70: 6566 2064 656c 5f73 6368 6564 756c 6572  ef del_scheduler
-00023c80: 5f66 696c 6528 2920 2d3e 204e 6f6e 653a  _file() -> None:
-00023c90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00023ca0: 2069 6620 6f73 2e70 6174 682e 6578 6973   if os.path.exis
-00023cb0: 7473 2866 6e29 3a0a 2020 2020 2020 2020  ts(fn):.        
-00023cc0: 2020 2020 2020 2020 2020 2020 6f73 2e72              os.r
-00023cd0: 656d 6f76 6528 666e 290a 0a20 2020 2020  emove(fn)..     
-00023ce0: 2020 2020 2020 2077 6561 6b72 6566 2e66         weakref.f
-00023cf0: 696e 616c 697a 6528 7365 6c66 2c20 6465  inalize(self, de
-00023d00: 6c5f 7363 6865 6475 6c65 725f 6669 6c65  l_scheduler_file
-00023d10: 290a 0a20 2020 2020 2020 2061 7761 6974  )..        await
-00023d20: 2073 656c 662e 7072 656c 6f61 6473 2e73   self.preloads.s
-00023d30: 7461 7274 2829 0a0a 2020 2020 2020 2020  tart()..        
-00023d40: 6966 2073 656c 662e 6a75 7079 7465 723a  if self.jupyter:
-00023d50: 0a20 2020 2020 2020 2020 2020 2023 2041  .            # A
-00023d60: 6c6c 6f77 2069 6e73 6563 7572 6520 636f  llow insecure co
-00023d70: 6d6d 756e 6963 6174 696f 6e73 2066 726f  mmunications fro
-00023d80: 6d20 6c6f 6361 6c20 7573 6572 730a 2020  m local users.  
-00023d90: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-00023da0: 662e 6164 6472 6573 732e 7374 6172 7473  f.address.starts
-00023db0: 7769 7468 2822 746c 733a 2f2f 2229 3a0a  with("tls://"):.
-00023dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023dd0: 6177 6169 7420 7365 6c66 2e6c 6973 7465  await self.liste
-00023de0: 6e28 2274 6370 3a2f 2f6c 6f63 616c 686f  n("tcp://localho
-00023df0: 7374 3a30 2229 0a20 2020 2020 2020 2020  st:0").         
-00023e00: 2020 206f 732e 656e 7669 726f 6e5b 2244     os.environ["D
-00023e10: 4153 4b5f 5343 4845 4455 4c45 525f 4144  ASK_SCHEDULER_AD
-00023e20: 4452 4553 5322 5d20 3d20 7365 6c66 2e6c  DRESS"] = self.l
-00023e30: 6973 7465 6e65 7273 5b2d 315d 2e63 6f6e  isteners[-1].con
-00023e40: 7461 6374 5f61 6464 7265 7373 0a0a 2020  tact_address..  
-00023e50: 2020 2020 2020 6177 6169 7420 6173 796e        await asyn
-00023e60: 6369 6f2e 6761 7468 6572 280a 2020 2020  cio.gather(.    
-00023e70: 2020 2020 2020 2020 2a5b 706c 7567 696e          *[plugin
-00023e80: 2e73 7461 7274 2873 656c 6629 2066 6f72  .start(self) for
-00023e90: 2070 6c75 6769 6e20 696e 206c 6973 7428   plugin in list(
-00023ea0: 7365 6c66 2e70 6c75 6769 6e73 2e76 616c  self.plugins.val
-00023eb0: 7565 7328 2929 5d0a 2020 2020 2020 2020  ues())].        
-00023ec0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-00023ed0: 7374 6172 745f 7065 7269 6f64 6963 5f63  start_periodic_c
-00023ee0: 616c 6c62 6163 6b73 2829 0a0a 2020 2020  allbacks()..    
-00023ef0: 2020 2020 7365 7470 726f 6374 6974 6c65      setproctitle
-00023f00: 2866 2264 6173 6b20 7363 6865 6475 6c65  (f"dask schedule
-00023f10: 7220 5b7b 7365 6c66 2e61 6464 7265 7373  r [{self.address
-00023f20: 7d5d 2229 0a20 2020 2020 2020 2072 6574  }]").        ret
-00023f30: 7572 6e20 7365 6c66 0a0a 2020 2020 6173  urn self..    as
-00023f40: 796e 6320 6465 6620 636c 6f73 6528 7365  ync def close(se
-00023f50: 6c66 2c20 6661 7374 3d4e 6f6e 652c 2063  lf, fast=None, c
-00023f60: 6c6f 7365 5f77 6f72 6b65 7273 3d4e 6f6e  lose_workers=Non
-00023f70: 652c 2072 6561 736f 6e3d 2222 293a 0a20  e, reason=""):. 
-00023f80: 2020 2020 2020 2022 2222 5365 6e64 2063         """Send c
-00023f90: 6c65 616e 7570 2073 6967 6e61 6c20 746f  leanup signal to
-00023fa0: 2061 6c6c 2063 6f72 6f75 7469 6e65 7320   all coroutines 
-00023fb0: 7468 656e 2077 6169 7420 756e 7469 6c20  then wait until 
-00023fc0: 6669 6e69 7368 6564 0a0a 2020 2020 2020  finished..      
-00023fd0: 2020 5365 6520 416c 736f 0a20 2020 2020    See Also.     
-00023fe0: 2020 202d 2d2d 2d2d 2d2d 2d0a 2020 2020     --------.    
-00023ff0: 2020 2020 5363 6865 6475 6c65 722e 636c      Scheduler.cl
-00024000: 6561 6e75 700a 2020 2020 2020 2020 2222  eanup.        ""
-00024010: 220a 2020 2020 2020 2020 6966 2066 6173  ".        if fas
-00024020: 7420 6973 206e 6f74 204e 6f6e 6520 6f72  t is not None or
-00024030: 2063 6c6f 7365 5f77 6f72 6b65 7273 2069   close_workers i
-00024040: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00024050: 2020 2020 2020 2020 7761 726e 696e 6773          warnings
-00024060: 2e77 6172 6e28 0a20 2020 2020 2020 2020  .warn(.         
-00024070: 2020 2020 2020 2022 5468 6520 2766 6173         "The 'fas
-00024080: 7427 2061 6e64 2027 636c 6f73 655f 776f  t' and 'close_wo
-00024090: 726b 6572 7327 2070 6172 616d 6574 6572  rkers' parameter
-000240a0: 7320 696e 2053 6368 6564 756c 6572 2e63  s in Scheduler.c
-000240b0: 6c6f 7365 2068 6176 6520 6e6f 2022 0a20  lose have no ". 
-000240c0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-000240d0: 6566 6665 6374 2061 6e64 2077 696c 6c20  effect and will 
-000240e0: 6265 2072 656d 6f76 6564 2069 6e20 6120  be removed in a 
-000240f0: 6675 7475 7265 2076 6572 7369 6f6e 206f  future version o
-00024100: 6620 6469 7374 7269 6275 7465 642e 222c  f distributed.",
-00024110: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00024120: 2046 7574 7572 6557 6172 6e69 6e67 2c0a   FutureWarning,.
-00024130: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00024140: 2020 2020 2020 6966 2073 656c 662e 7374        if self.st
-00024150: 6174 7573 2069 6e20 2853 7461 7475 732e  atus in (Status.
-00024160: 636c 6f73 696e 672c 2053 7461 7475 732e  closing, Status.
-00024170: 636c 6f73 6564 293a 0a20 2020 2020 2020  closed):.       
-00024180: 2020 2020 2061 7761 6974 2073 656c 662e       await self.
-00024190: 6669 6e69 7368 6564 2829 0a20 2020 2020  finished().     
-000241a0: 2020 2020 2020 2072 6574 7572 6e0a 0a20         return.. 
-000241b0: 2020 2020 2020 2061 7379 6e63 2064 6566         async def
-000241c0: 206c 6f67 5f65 7272 6f72 7328 6675 6e63   log_errors(func
-000241d0: 293a 0a20 2020 2020 2020 2020 2020 2074  ):.            t
-000241e0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-000241f0: 2020 2020 6177 6169 7420 6675 6e63 2829      await func()
-00024200: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-00024210: 6570 7420 4578 6365 7074 696f 6e3a 0a20  ept Exception:. 
-00024220: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00024230: 6f67 6765 722e 6578 6365 7074 696f 6e28  ogger.exception(
-00024240: 2250 6c75 6769 6e20 6361 6c6c 2066 6169  "Plugin call fai
-00024250: 6c65 6420 6475 7269 6e67 2073 6368 6564  led during sched
-00024260: 756c 6572 2e63 6c6f 7365 2229 0a0a 2020  uler.close")..  
-00024270: 2020 2020 2020 6177 6169 7420 6173 796e        await asyn
-00024280: 6369 6f2e 6761 7468 6572 280a 2020 2020  cio.gather(.    
-00024290: 2020 2020 2020 2020 2a5b 6c6f 675f 6572          *[log_er
-000242a0: 726f 7273 2870 6c75 6769 6e2e 6265 666f  rors(plugin.befo
-000242b0: 7265 5f63 6c6f 7365 2920 666f 7220 706c  re_close) for pl
-000242c0: 7567 696e 2069 6e20 6c69 7374 2873 656c  ugin in list(sel
-000242d0: 662e 706c 7567 696e 732e 7661 6c75 6573  f.plugins.values
-000242e0: 2829 295d 0a20 2020 2020 2020 2029 0a0a  ())].        )..
-000242f0: 2020 2020 2020 2020 7365 6c66 2e73 7461          self.sta
-00024300: 7475 7320 3d20 5374 6174 7573 2e63 6c6f  tus = Status.clo
-00024310: 7369 6e67 0a20 2020 2020 2020 206c 6f67  sing.        log
-00024320: 6765 722e 696e 666f 2822 5363 6865 6475  ger.info("Schedu
-00024330: 6c65 7220 636c 6f73 696e 6720 6475 6520  ler closing due 
-00024340: 746f 2025 732e 2e2e 222c 2072 6561 736f  to %s...", reaso
-00024350: 6e20 6f72 2022 756e 6b6e 6f77 6e20 7265  n or "unknown re
-00024360: 6173 6f6e 2229 0a20 2020 2020 2020 2073  ason").        s
-00024370: 6574 7072 6f63 7469 746c 6528 2264 6173  etproctitle("das
-00024380: 6b20 7363 6865 6475 6c65 7220 5b63 6c6f  k scheduler [clo
-00024390: 7369 6e67 5d22 290a 0a20 2020 2020 2020  sing]")..       
-000243a0: 2061 7761 6974 2073 656c 662e 7072 656c   await self.prel
-000243b0: 6f61 6473 2e74 6561 7264 6f77 6e28 290a  oads.teardown().
-000243c0: 0a20 2020 2020 2020 2061 7761 6974 2061  .        await a
-000243d0: 7379 6e63 696f 2e67 6174 6865 7228 0a20  syncio.gather(. 
-000243e0: 2020 2020 2020 2020 2020 202a 5b6c 6f67             *[log
-000243f0: 5f65 7272 6f72 7328 706c 7567 696e 2e63  _errors(plugin.c
-00024400: 6c6f 7365 2920 666f 7220 706c 7567 696e  lose) for plugin
-00024410: 2069 6e20 6c69 7374 2873 656c 662e 706c   in list(self.pl
-00024420: 7567 696e 732e 7661 6c75 6573 2829 295d  ugins.values())]
-00024430: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-00024440: 2020 2020 666f 7220 7063 2069 6e20 7365      for pc in se
-00024450: 6c66 2e70 6572 696f 6469 635f 6361 6c6c  lf.periodic_call
-00024460: 6261 636b 732e 7661 6c75 6573 2829 3a0a  backs.values():.
-00024470: 2020 2020 2020 2020 2020 2020 7063 2e73              pc.s
-00024480: 746f 7028 290a 2020 2020 2020 2020 7365  top().        se
-00024490: 6c66 2e70 6572 696f 6469 635f 6361 6c6c  lf.periodic_call
-000244a0: 6261 636b 732e 636c 6561 7228 290a 0a20  backs.clear().. 
-000244b0: 2020 2020 2020 2073 656c 662e 7374 6f70         self.stop
-000244c0: 5f73 6572 7669 6365 7328 290a 0a20 2020  _services()..   
-000244d0: 2020 2020 2066 6f72 2065 7874 2069 6e20       for ext in 
-000244e0: 7365 6c66 2e65 7874 656e 7369 6f6e 732e  self.extensions.
-000244f0: 7661 6c75 6573 2829 3a0a 2020 2020 2020  values():.      
-00024500: 2020 2020 2020 7769 7468 2073 7570 7072        with suppr
-00024510: 6573 7328 4174 7472 6962 7574 6545 7272  ess(AttributeErr
-00024520: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-00024530: 2020 2020 2065 7874 2e74 6561 7264 6f77       ext.teardow
-00024540: 6e28 290a 2020 2020 2020 2020 6c6f 6767  n().        logg
-00024550: 6572 2e69 6e66 6f28 2253 6368 6564 756c  er.info("Schedul
-00024560: 6572 2063 6c6f 7369 6e67 2061 6c6c 2063  er closing all c
-00024570: 6f6d 6d73 2229 0a0a 2020 2020 2020 2020  omms")..        
-00024580: 6675 7475 7265 7320 3d20 5b5d 0a20 2020  futures = [].   
-00024590: 2020 2020 2066 6f72 205f 2c20 636f 6d6d       for _, comm
-000245a0: 2069 6e20 6c69 7374 2873 656c 662e 7374   in list(self.st
-000245b0: 7265 616d 5f63 6f6d 6d73 2e69 7465 6d73  ream_comms.items
-000245c0: 2829 293a 0a20 2020 2020 2020 2020 2020  ()):.           
-000245d0: 2023 2046 4958 4d45 2075 7365 2060 7365   # FIXME use `se
-000245e0: 6c66 2e72 656d 6f76 655f 776f 726b 6572  lf.remove_worker
-000245f0: 2829 6020 696e 7374 6561 6420 6166 7465  ()` instead afte
-00024600: 7220 6874 7470 733a 2f2f 6769 7468 7562  r https://github
-00024610: 2e63 6f6d 2f64 6173 6b2f 6469 7374 7269  .com/dask/distri
-00024620: 6275 7465 642f 6973 7375 6573 2f36 3339  buted/issues/639
-00024630: 300a 2020 2020 2020 2020 2020 2020 6966  0.            if
-00024640: 206e 6f74 2063 6f6d 6d2e 636c 6f73 6564   not comm.closed
-00024650: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00024660: 2020 2020 2320 5468 6973 2063 6c6f 7365      # This close
-00024670: 7320 7468 6520 576f 726b 6572 2061 6e64  s the Worker and
-00024680: 2065 6e73 7572 6573 2074 6861 7420 6966   ensures that if
-00024690: 2061 204e 616e 6e79 2069 7320 6172 6f75   a Nanny is arou
-000246a0: 6e64 2c0a 2020 2020 2020 2020 2020 2020  nd,.            
-000246b0: 2020 2020 2320 6974 2069 7320 636c 6f73      # it is clos
-000246c0: 6564 2061 7320 7765 6c6c 0a20 2020 2020  ed as well.     
-000246d0: 2020 2020 2020 2020 2020 2063 6f6d 6d2e             comm.
-000246e0: 7365 6e64 287b 226f 7022 3a20 2263 6c6f  send({"op": "clo
-000246f0: 7365 222c 2022 7265 6173 6f6e 223a 2022  se", "reason": "
-00024700: 7363 6865 6475 6c65 722d 636c 6f73 6522  scheduler-close"
-00024710: 7d29 0a20 2020 2020 2020 2020 2020 2020  }).             
-00024720: 2020 2063 6f6d 6d2e 7365 6e64 287b 226f     comm.send({"o
-00024730: 7022 3a20 2263 6c6f 7365 2d73 7472 6561  p": "close-strea
-00024740: 6d22 7d29 0a20 2020 2020 2020 2020 2020  m"}).           
-00024750: 2020 2020 2023 205e 2054 4f44 4f20 7265       # ^ TODO re
-00024760: 6d6f 7665 3f20 6057 6f72 6b65 722e 636c  move? `Worker.cl
-00024770: 6f73 6560 2077 696c 6c20 636c 6f73 6520  ose` will close 
-00024780: 7468 6520 7374 7265 616d 2061 6e79 7761  the stream anywa
-00024790: 792e 0a20 2020 2020 2020 2020 2020 2077  y..            w
-000247a0: 6974 6820 7375 7070 7265 7373 2841 7474  ith suppress(Att
-000247b0: 7269 6275 7465 4572 726f 7229 3a0a 2020  ributeError):.  
-000247c0: 2020 2020 2020 2020 2020 2020 2020 6675                fu
-000247d0: 7475 7265 732e 6170 7065 6e64 2863 6f6d  tures.append(com
-000247e0: 6d2e 636c 6f73 6528 2929 0a0a 2020 2020  m.close())..    
-000247f0: 2020 2020 6177 6169 7420 6173 796e 6369      await asynci
-00024800: 6f2e 6761 7468 6572 282a 6675 7475 7265  o.gather(*future
-00024810: 7329 0a0a 2020 2020 2020 2020 6966 2073  s)..        if s
-00024820: 656c 662e 6a75 7079 7465 723a 0a20 2020  elf.jupyter:.   
-00024830: 2020 2020 2020 2020 2061 7761 6974 2073           await s
-00024840: 656c 662e 5f6a 7570 7974 6572 5f73 6572  elf._jupyter_ser
-00024850: 7665 725f 6170 706c 6963 6174 696f 6e2e  ver_application.
-00024860: 5f63 6c65 616e 7570 2829 0a0a 2020 2020  _cleanup()..    
-00024870: 2020 2020 666f 7220 636f 6d6d 2069 6e20      for comm in 
-00024880: 7365 6c66 2e63 6c69 656e 745f 636f 6d6d  self.client_comm
-00024890: 732e 7661 6c75 6573 2829 3a0a 2020 2020  s.values():.    
-000248a0: 2020 2020 2020 2020 636f 6d6d 2e61 626f          comm.abo
-000248b0: 7274 2829 0a0a 2020 2020 2020 2020 6177  rt()..        aw
-000248c0: 6169 7420 7365 6c66 2e72 7063 2e63 6c6f  ait self.rpc.clo
-000248d0: 7365 2829 0a0a 2020 2020 2020 2020 7365  se()..        se
-000248e0: 6c66 2e73 7461 7475 7320 3d20 5374 6174  lf.status = Stat
-000248f0: 7573 2e63 6c6f 7365 640a 2020 2020 2020  us.closed.      
-00024900: 2020 7365 6c66 2e73 746f 7028 290a 2020    self.stop().  
-00024910: 2020 2020 2020 6177 6169 7420 7375 7065        await supe
-00024920: 7228 292e 636c 6f73 6528 290a 0a20 2020  r().close()..   
-00024930: 2020 2020 2073 6574 7072 6f63 7469 746c       setproctitl
-00024940: 6528 2264 6173 6b20 7363 6865 6475 6c65  e("dask schedule
-00024950: 7220 5b63 6c6f 7365 645d 2229 0a20 2020  r [closed]").   
-00024960: 2020 2020 2064 6973 6162 6c65 5f67 635f       disable_gc_
-00024970: 6469 6167 6e6f 7369 7328 290a 0a20 2020  diagnosis()..   
-00024980: 2023 2323 2323 2323 2323 2323 0a20 2020   ###########.   
-00024990: 2023 2053 7469 6d75 6c69 2023 0a20 2020   # Stimuli #.   
-000249a0: 2023 2323 2323 2323 2323 2323 0a0a 2020   ###########..  
-000249b0: 2020 6465 6620 6865 6172 7462 6561 745f    def heartbeat_
-000249c0: 776f 726b 6572 280a 2020 2020 2020 2020  worker(.        
-000249d0: 7365 6c66 2c0a 2020 2020 2020 2020 2a2c  self,.        *,
-000249e0: 0a20 2020 2020 2020 2061 6464 7265 7373  .        address
-000249f0: 3a20 7374 722c 0a20 2020 2020 2020 2072  : str,.        r
-00024a00: 6573 6f6c 7665 5f61 6464 7265 7373 3a20  esolve_address: 
-00024a10: 626f 6f6c 203d 2054 7275 652c 0a20 2020  bool = True,.   
-00024a20: 2020 2020 206e 6f77 3a20 666c 6f61 7420       now: float 
-00024a30: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
-00024a40: 2020 2020 2020 2072 6573 6f75 7263 6573         resources
-00024a50: 3a20 6469 6374 5b73 7472 2c20 666c 6f61  : dict[str, floa
-00024a60: 745d 207c 204e 6f6e 6520 3d20 4e6f 6e65  t] | None = None
-00024a70: 2c0a 2020 2020 2020 2020 686f 7374 5f69  ,.        host_i
-00024a80: 6e66 6f3a 2064 6963 7420 7c20 4e6f 6e65  nfo: dict | None
-00024a90: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-00024aa0: 206d 6574 7269 6373 3a20 6469 6374 2c0a   metrics: dict,.
-00024ab0: 2020 2020 2020 2020 6578 6563 7574 696e          executin
-00024ac0: 673a 2064 6963 745b 4b65 792c 2066 6c6f  g: dict[Key, flo
-00024ad0: 6174 5d20 7c20 4e6f 6e65 203d 204e 6f6e  at] | None = Non
-00024ae0: 652c 0a20 2020 2020 2020 2065 7874 656e  e,.        exten
-00024af0: 7369 6f6e 733a 2064 6963 7420 7c20 4e6f  sions: dict | No
-00024b00: 6e65 203d 204e 6f6e 652c 0a20 2020 2029  ne = None,.    )
-00024b10: 202d 3e20 6469 6374 5b73 7472 2c20 416e   -> dict[str, An
-00024b20: 795d 3a0a 2020 2020 2020 2020 6164 6472  y]:.        addr
-00024b30: 6573 7320 3d20 7365 6c66 2e63 6f65 7263  ess = self.coerc
-00024b40: 655f 6164 6472 6573 7328 6164 6472 6573  e_address(addres
-00024b50: 732c 2072 6573 6f6c 7665 5f61 6464 7265  s, resolve_addre
-00024b60: 7373 290a 2020 2020 2020 2020 6164 6472  ss).        addr
-00024b70: 6573 7320 3d20 6e6f 726d 616c 697a 655f  ess = normalize_
-00024b80: 6164 6472 6573 7328 6164 6472 6573 7329  address(address)
-00024b90: 0a20 2020 2020 2020 2077 7320 3d20 7365  .        ws = se
-00024ba0: 6c66 2e77 6f72 6b65 7273 2e67 6574 2861  lf.workers.get(a
-00024bb0: 6464 7265 7373 290a 2020 2020 2020 2020  ddress).        
-00024bc0: 6966 2077 7320 6973 204e 6f6e 653a 0a20  if ws is None:. 
-00024bd0: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-00024be0: 722e 7761 726e 696e 6728 6622 5265 6365  r.warning(f"Rece
-00024bf0: 6976 6564 2068 6561 7274 6265 6174 2066  ived heartbeat f
-00024c00: 726f 6d20 756e 7265 6769 7374 6572 6564  rom unregistered
-00024c10: 2077 6f72 6b65 7220 7b61 6464 7265 7373   worker {address
-00024c20: 2172 7d2e 2229 0a20 2020 2020 2020 2020  !r}.").         
-00024c30: 2020 2072 6574 7572 6e20 7b22 7374 6174     return {"stat
-00024c40: 7573 223a 2022 6d69 7373 696e 6722 7d0a  us": "missing"}.
-00024c50: 0a20 2020 2020 2020 2068 6f73 7420 3d20  .        host = 
-00024c60: 6765 745f 6164 6472 6573 735f 686f 7374  get_address_host
-00024c70: 2861 6464 7265 7373 290a 2020 2020 2020  (address).      
-00024c80: 2020 6c6f 6361 6c5f 6e6f 7720 3d20 7469    local_now = ti
-00024c90: 6d65 2829 0a20 2020 2020 2020 2068 6f73  me().        hos
-00024ca0: 745f 696e 666f 203d 2068 6f73 745f 696e  t_info = host_in
-00024cb0: 666f 206f 7220 7b7d 0a0a 2020 2020 2020  fo or {}..      
-00024cc0: 2020 6468 203d 2073 656c 662e 686f 7374    dh = self.host
-00024cd0: 5f69 6e66 6f2e 7365 7464 6566 6175 6c74  _info.setdefault
-00024ce0: 2868 6f73 742c 207b 7d29 0a20 2020 2020  (host, {}).     
-00024cf0: 2020 2064 685b 226c 6173 742d 7365 656e     dh["last-seen
-00024d00: 225d 203d 206c 6f63 616c 5f6e 6f77 0a0a  "] = local_now..
-00024d10: 2020 2020 2020 2020 6672 6163 203d 2031          frac = 1
-00024d20: 202f 206c 656e 2873 656c 662e 776f 726b   / len(self.work
-00024d30: 6572 7329 0a20 2020 2020 2020 2073 656c  ers).        sel
-00024d40: 662e 6261 6e64 7769 6474 6820 3d20 280a  f.bandwidth = (.
-00024d50: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00024d60: 2e62 616e 6477 6964 7468 202a 2028 3120  .bandwidth * (1 
-00024d70: 2d20 6672 6163 2920 2b20 6d65 7472 6963  - frac) + metric
-00024d80: 735b 2262 616e 6477 6964 7468 225d 5b22  s["bandwidth"]["
-00024d90: 746f 7461 6c22 5d20 2a20 6672 6163 0a20  total"] * frac. 
-00024da0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00024db0: 2066 6f72 206f 7468 6572 2c20 2862 772c   for other, (bw,
-00024dc0: 2063 6f75 6e74 2920 696e 206d 6574 7269   count) in metri
-00024dd0: 6373 5b22 6261 6e64 7769 6474 6822 5d5b  cs["bandwidth"][
-00024de0: 2277 6f72 6b65 7273 225d 2e69 7465 6d73  "workers"].items
-00024df0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00024e00: 6966 2028 6164 6472 6573 732c 206f 7468  if (address, oth
-00024e10: 6572 2920 6e6f 7420 696e 2073 656c 662e  er) not in self.
-00024e20: 6261 6e64 7769 6474 685f 776f 726b 6572  bandwidth_worker
-00024e30: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00024e40: 2020 2073 656c 662e 6261 6e64 7769 6474     self.bandwidt
-00024e50: 685f 776f 726b 6572 735b 6164 6472 6573  h_workers[addres
-00024e60: 732c 206f 7468 6572 5d20 3d20 6277 202f  s, other] = bw /
-00024e70: 2063 6f75 6e74 0a20 2020 2020 2020 2020   count.         
-00024e80: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00024e90: 2020 2020 2020 2020 2061 6c70 6861 203d           alpha =
-00024ea0: 2028 3120 2d20 6672 6163 2920 2a2a 2063   (1 - frac) ** c
-00024eb0: 6f75 6e74 0a20 2020 2020 2020 2020 2020  ount.           
-00024ec0: 2020 2020 2073 656c 662e 6261 6e64 7769       self.bandwi
-00024ed0: 6474 685f 776f 726b 6572 735b 6164 6472  dth_workers[addr
-00024ee0: 6573 732c 206f 7468 6572 5d20 3d20 7365  ess, other] = se
-00024ef0: 6c66 2e62 616e 6477 6964 7468 5f77 6f72  lf.bandwidth_wor
-00024f00: 6b65 7273 5b0a 2020 2020 2020 2020 2020  kers[.          
-00024f10: 2020 2020 2020 2020 2020 6164 6472 6573            addres
-00024f20: 732c 206f 7468 6572 0a20 2020 2020 2020  s, other.       
-00024f30: 2020 2020 2020 2020 205d 202a 2061 6c70           ] * alp
-00024f40: 6861 202b 2062 7720 2a20 2831 202d 2061  ha + bw * (1 - a
-00024f50: 6c70 6861 290a 2020 2020 2020 2020 666f  lpha).        fo
-00024f60: 7220 7479 702c 2028 6277 2c20 636f 756e  r typ, (bw, coun
-00024f70: 7429 2069 6e20 6d65 7472 6963 735b 2262  t) in metrics["b
-00024f80: 616e 6477 6964 7468 225d 5b22 7479 7065  andwidth"]["type
-00024f90: 7322 5d2e 6974 656d 7328 293a 0a20 2020  s"].items():.   
-00024fa0: 2020 2020 2020 2020 2069 6620 7479 7020           if typ 
-00024fb0: 6e6f 7420 696e 2073 656c 662e 6261 6e64  not in self.band
-00024fc0: 7769 6474 685f 7479 7065 733a 0a20 2020  width_types:.   
-00024fd0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00024fe0: 662e 6261 6e64 7769 6474 685f 7479 7065  f.bandwidth_type
-00024ff0: 735b 7479 705d 203d 2062 7720 2f20 636f  s[typ] = bw / co
-00025000: 756e 740a 2020 2020 2020 2020 2020 2020  unt.            
-00025010: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00025020: 2020 2020 2020 616c 7068 6120 3d20 2831        alpha = (1
-00025030: 202d 2066 7261 6329 202a 2a20 636f 756e   - frac) ** coun
-00025040: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
-00025050: 2020 7365 6c66 2e62 616e 6477 6964 7468    self.bandwidth
-00025060: 5f74 7970 6573 5b74 7970 5d20 3d20 7365  _types[typ] = se
-00025070: 6c66 2e62 616e 6477 6964 7468 5f74 7970  lf.bandwidth_typ
-00025080: 6573 5b74 7970 5d20 2a20 616c 7068 6120  es[typ] * alpha 
-00025090: 2b20 6277 202a 2028 0a20 2020 2020 2020  + bw * (.       
-000250a0: 2020 2020 2020 2020 2020 2020 2031 202d               1 -
-000250b0: 2061 6c70 6861 0a20 2020 2020 2020 2020   alpha.         
-000250c0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-000250d0: 2020 7773 2e6c 6173 745f 7365 656e 203d    ws.last_seen =
-000250e0: 206c 6f63 616c 5f6e 6f77 0a20 2020 2020   local_now.     
-000250f0: 2020 2069 6620 6578 6563 7574 696e 6720     if executing 
-00025100: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00025110: 2020 2020 2020 2020 2023 204e 4f54 453a           # NOTE:
-00025120: 2074 6865 2065 7865 6375 7469 6e67 2064   the executing d
-00025130: 6963 7420 6973 2075 6e75 7365 640a 2020  ict is unused.  
-00025140: 2020 2020 2020 2020 2020 7773 2e65 7865            ws.exe
-00025150: 6375 7469 6e67 203d 207b 7d0a 2020 2020  cuting = {}.    
-00025160: 2020 2020 2020 2020 666f 7220 6b65 792c          for key,
-00025170: 2064 7572 6174 696f 6e20 696e 2065 7865   duration in exe
-00025180: 6375 7469 6e67 2e69 7465 6d73 2829 3a0a  cuting.items():.
-00025190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000251a0: 6966 206b 6579 2069 6e20 7365 6c66 2e74  if key in self.t
-000251b0: 6173 6b73 3a0a 2020 2020 2020 2020 2020  asks:.          
-000251c0: 2020 2020 2020 2020 2020 7473 203d 2073            ts = s
-000251d0: 656c 662e 7461 736b 735b 6b65 795d 0a20  elf.tasks[key]. 
-000251e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000251f0: 2020 2077 732e 6578 6563 7574 696e 675b     ws.executing[
-00025200: 7473 5d20 3d20 6475 7261 7469 6f6e 0a20  ts] = duration. 
-00025210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025220: 2020 2074 732e 7072 6566 6978 2e61 6464     ts.prefix.add
-00025230: 5f65 7865 635f 7469 6d65 2864 7572 6174  _exec_time(durat
-00025240: 696f 6e29 0a0a 2020 2020 2020 2020 666f  ion)..        fo
-00025250: 7220 6e61 6d65 2c20 7661 6c75 6520 696e  r name, value in
-00025260: 206d 6574 7269 6373 5b22 6469 6765 7374   metrics["digest
-00025270: 735f 746f 7461 6c5f 7369 6e63 655f 6865  s_total_since_he
-00025280: 6172 7462 6561 7422 5d2e 6974 656d 7328  artbeat"].items(
-00025290: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
-000252a0: 656c 662e 6375 6d75 6c61 7469 7665 5f77  elf.cumulative_w
-000252b0: 6f72 6b65 725f 6d65 7472 6963 735b 6e61  orker_metrics[na
-000252c0: 6d65 5d20 2b3d 2076 616c 7565 0a0a 2020  me] += value..  
-000252d0: 2020 2020 2020 7773 2e6d 6574 7269 6373        ws.metrics
-000252e0: 203d 206d 6574 7269 6373 0a0a 2020 2020   = metrics..    
-000252f0: 2020 2020 2320 4361 6c63 756c 6174 6520      # Calculate 
-00025300: 5253 5320 2d20 6461 736b 206b 6579 732c  RSS - dask keys,
-00025310: 2073 6570 6172 6174 696e 6720 226f 6c64   separating "old
-00025320: 2220 616e 6420 226e 6577 2220 7573 6167  " and "new" usag
-00025330: 650a 2020 2020 2020 2020 2320 5365 6520  e.        # See 
-00025340: 4d65 6d6f 7279 5374 6174 6520 666f 7220  MemoryState for 
-00025350: 6465 7461 696c 730a 2020 2020 2020 2020  details.        
-00025360: 6d61 785f 6d65 6d6f 7279 5f75 6e6d 616e  max_memory_unman
-00025370: 6167 6564 5f6f 6c64 5f68 6973 745f 6167  aged_old_hist_ag
-00025380: 6520 3d20 6c6f 6361 6c5f 6e6f 7720 2d20  e = local_now - 
-00025390: 7365 6c66 2e4d 454d 4f52 595f 5245 4345  self.MEMORY_RECE
-000253a0: 4e54 5f54 4f5f 4f4c 445f 5449 4d45 0a20  NT_TO_OLD_TIME. 
-000253b0: 2020 2020 2020 206d 656d 6f72 795f 756e         memory_un
-000253c0: 6d61 6e61 6765 645f 6f6c 6420 3d20 7773  managed_old = ws
-000253d0: 2e5f 6d65 6d6f 7279 5f75 6e6d 616e 6167  ._memory_unmanag
-000253e0: 6564 5f6f 6c64 0a20 2020 2020 2020 2077  ed_old.        w
-000253f0: 6869 6c65 2077 732e 5f6d 656d 6f72 795f  hile ws._memory_
-00025400: 756e 6d61 6e61 6765 645f 6869 7374 6f72  unmanaged_histor
-00025410: 793a 0a20 2020 2020 2020 2020 2020 2074  y:.            t
-00025420: 696d 6573 7461 6d70 2c20 7369 7a65 203d  imestamp, size =
-00025430: 2077 732e 5f6d 656d 6f72 795f 756e 6d61   ws._memory_unma
-00025440: 6e61 6765 645f 6869 7374 6f72 795b 305d  naged_history[0]
-00025450: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00025460: 7469 6d65 7374 616d 7020 3e3d 206d 6178  timestamp >= max
-00025470: 5f6d 656d 6f72 795f 756e 6d61 6e61 6765  _memory_unmanage
-00025480: 645f 6f6c 645f 6869 7374 5f61 6765 3a0a  d_old_hist_age:.
-00025490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000254a0: 6272 6561 6b0a 2020 2020 2020 2020 2020  break.          
-000254b0: 2020 7773 2e5f 6d65 6d6f 7279 5f75 6e6d    ws._memory_unm
-000254c0: 616e 6167 6564 5f68 6973 746f 7279 2e70  anaged_history.p
-000254d0: 6f70 6c65 6674 2829 0a20 2020 2020 2020  opleft().       
-000254e0: 2020 2020 2069 6620 7369 7a65 203d 3d20       if size == 
-000254f0: 6d65 6d6f 7279 5f75 6e6d 616e 6167 6564  memory_unmanaged
-00025500: 5f6f 6c64 3a0a 2020 2020 2020 2020 2020  _old:.          
-00025510: 2020 2020 2020 6d65 6d6f 7279 5f75 6e6d        memory_unm
-00025520: 616e 6167 6564 5f6f 6c64 203d 2030 2020  anaged_old = 0  
-00025530: 2320 7265 6361 6c63 756c 6174 6520 6d69  # recalculate mi
-00025540: 6e28 290a 0a20 2020 2020 2020 2023 2077  n()..        # w
-00025550: 732e 5f6e 6279 7465 7320 6973 2075 7064  s._nbytes is upd
-00025560: 6174 6564 2061 7420 6120 6469 6666 6572  ated at a differ
-00025570: 656e 7420 7469 6d65 2061 6e64 2073 697a  ent time and siz
-00025580: 656f 6628 2920 6d61 7920 6e6f 7420 6265  eof() may not be
-00025590: 2061 6363 7572 6174 652c 0a20 2020 2020   accurate,.     
-000255a0: 2020 2023 2073 6f20 7369 7a65 206d 6179     # so size may
-000255b0: 2062 6520 2874 656d 706f 7261 7269 6c79   be (temporarily
-000255c0: 2920 6e65 6761 7469 7665 3b20 666c 6f6f  ) negative; floo
-000255d0: 7220 6974 2074 6f20 7a65 726f 2e0a 2020  r it to zero..  
-000255e0: 2020 2020 2020 7369 7a65 203d 206d 6178        size = max
-000255f0: 280a 2020 2020 2020 2020 2020 2020 302c  (.            0,
-00025600: 206d 6574 7269 6373 5b22 6d65 6d6f 7279   metrics["memory
-00025610: 225d 202d 2077 732e 6e62 7974 6573 202b  "] - ws.nbytes +
-00025620: 206d 6574 7269 6373 5b22 7370 696c 6c65   metrics["spille
-00025630: 645f 6279 7465 7322 5d5b 226d 656d 6f72  d_bytes"]["memor
-00025640: 7922 5d0a 2020 2020 2020 2020 290a 0a20  y"].        ).. 
-00025650: 2020 2020 2020 2077 732e 5f6d 656d 6f72         ws._memor
-00025660: 795f 756e 6d61 6e61 6765 645f 6869 7374  y_unmanaged_hist
-00025670: 6f72 792e 6170 7065 6e64 2828 6c6f 6361  ory.append((loca
-00025680: 6c5f 6e6f 772c 2073 697a 6529 290a 2020  l_now, size)).  
-00025690: 2020 2020 2020 6966 206e 6f74 206d 656d        if not mem
-000256a0: 6f72 795f 756e 6d61 6e61 6765 645f 6f6c  ory_unmanaged_ol
-000256b0: 643a 0a20 2020 2020 2020 2020 2020 2023  d:.            #
-000256c0: 2054 6865 2077 6f72 6b65 7220 6861 7320   The worker has 
-000256d0: 6a75 7374 2062 6565 6e20 7374 6172 7465  just been starte
-000256e0: 6420 6f72 2074 6865 2070 7265 7669 6f75  d or the previou
-000256f0: 7320 6d69 6e69 6d75 6d20 6861 7320 6265  s minimum has be
-00025700: 656e 2065 7870 756e 6765 640a 2020 2020  en expunged.    
-00025710: 2020 2020 2020 2020 2320 6265 6361 7573          # becaus
-00025720: 6520 746f 6f20 6f6c 642e 0a20 2020 2020  e too old..     
-00025730: 2020 2020 2020 2023 204e 6f74 653a 2074         # Note: t
-00025740: 6869 7320 616c 676f 7269 7468 6d20 6973  his algorithm is
-00025750: 2063 6170 7065 6420 746f 2032 3030 202a   capped to 200 *
-00025760: 204d 454d 4f52 595f 5245 4345 4e54 5f54   MEMORY_RECENT_T
-00025770: 4f5f 4f4c 445f 5449 4d45 2065 6c65 6d65  O_OLD_TIME eleme
-00025780: 6e74 730a 2020 2020 2020 2020 2020 2020  nts.            
-00025790: 2320 636c 7573 7465 722d 7769 6465 2062  # cluster-wide b
-000257a0: 7920 6865 6172 7462 6561 745f 696e 7465  y heartbeat_inte
-000257b0: 7276 616c 2829 2c20 7265 6761 7264 6c65  rval(), regardle
-000257c0: 7373 206f 6620 7468 6520 6e75 6d62 6572  ss of the number
-000257d0: 206f 6620 776f 726b 6572 730a 2020 2020   of workers.    
-000257e0: 2020 2020 2020 2020 7773 2e5f 6d65 6d6f          ws._memo
-000257f0: 7279 5f75 6e6d 616e 6167 6564 5f6f 6c64  ry_unmanaged_old
-00025800: 203d 206d 696e 286d 6170 2873 6563 6f6e   = min(map(secon
-00025810: 642c 2077 732e 5f6d 656d 6f72 795f 756e  d, ws._memory_un
-00025820: 6d61 6e61 6765 645f 6869 7374 6f72 7929  managed_history)
-00025830: 290a 2020 2020 2020 2020 656c 6966 2073  ).        elif s
-00025840: 697a 6520 3c20 6d65 6d6f 7279 5f75 6e6d  ize < memory_unm
-00025850: 616e 6167 6564 5f6f 6c64 3a0a 2020 2020  anaged_old:.    
-00025860: 2020 2020 2020 2020 7773 2e5f 6d65 6d6f          ws._memo
-00025870: 7279 5f75 6e6d 616e 6167 6564 5f6f 6c64  ry_unmanaged_old
-00025880: 203d 2073 697a 650a 0a20 2020 2020 2020   = size..       
-00025890: 2069 6620 686f 7374 5f69 6e66 6f3a 0a20   if host_info:. 
-000258a0: 2020 2020 2020 2020 2020 2064 6820 3d20             dh = 
-000258b0: 7365 6c66 2e68 6f73 745f 696e 666f 2e73  self.host_info.s
-000258c0: 6574 6465 6661 756c 7428 686f 7374 2c20  etdefault(host, 
-000258d0: 7b7d 290a 2020 2020 2020 2020 2020 2020  {}).            
-000258e0: 6468 2e75 7064 6174 6528 686f 7374 5f69  dh.update(host_i
-000258f0: 6e66 6f29 0a0a 2020 2020 2020 2020 6966  nfo)..        if
-00025900: 206e 6f77 3a0a 2020 2020 2020 2020 2020   now:.          
-00025910: 2020 7773 2e74 696d 655f 6465 6c61 7920    ws.time_delay 
-00025920: 3d20 6c6f 6361 6c5f 6e6f 7720 2d20 6e6f  = local_now - no
-00025930: 770a 0a20 2020 2020 2020 2069 6620 7265  w..        if re
-00025940: 736f 7572 6365 733a 0a20 2020 2020 2020  sources:.       
-00025950: 2020 2020 2073 656c 662e 6164 645f 7265       self.add_re
-00025960: 736f 7572 6365 7328 776f 726b 6572 3d61  sources(worker=a
-00025970: 6464 7265 7373 2c20 7265 736f 7572 6365  ddress, resource
-00025980: 733d 7265 736f 7572 6365 7329 0a0a 2020  s=resources)..  
-00025990: 2020 2020 2020 6966 2065 7874 656e 7369        if extensi
-000259a0: 6f6e 733a 0a20 2020 2020 2020 2020 2020  ons:.           
-000259b0: 2066 6f72 206e 616d 652c 2064 6174 6120   for name, data 
-000259c0: 696e 2065 7874 656e 7369 6f6e 732e 6974  in extensions.it
-000259d0: 656d 7328 293a 0a20 2020 2020 2020 2020  ems():.         
-000259e0: 2020 2020 2020 2073 656c 662e 6578 7465         self.exte
-000259f0: 6e73 696f 6e73 5b6e 616d 655d 2e68 6561  nsions[name].hea
-00025a00: 7274 6265 6174 2877 732c 2064 6174 6129  rtbeat(ws, data)
-00025a10: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00025a20: 207b 0a20 2020 2020 2020 2020 2020 2022   {.            "
-00025a30: 7374 6174 7573 223a 2022 4f4b 222c 0a20  status": "OK",. 
-00025a40: 2020 2020 2020 2020 2020 2022 7469 6d65             "time
-00025a50: 223a 206c 6f63 616c 5f6e 6f77 2c0a 2020  ": local_now,.  
-00025a60: 2020 2020 2020 2020 2020 2268 6561 7274            "heart
-00025a70: 6265 6174 2d69 6e74 6572 7661 6c22 3a20  beat-interval": 
-00025a80: 6865 6172 7462 6561 745f 696e 7465 7276  heartbeat_interv
-00025a90: 616c 286c 656e 2873 656c 662e 776f 726b  al(len(self.work
-00025aa0: 6572 7329 292c 0a20 2020 2020 2020 207d  ers)),.        }
-00025ab0: 0a0a 2020 2020 406c 6f67 5f65 7272 6f72  ..    @log_error
-00025ac0: 730a 2020 2020 6173 796e 6320 6465 6620  s.    async def 
-00025ad0: 6164 645f 776f 726b 6572 280a 2020 2020  add_worker(.    
-00025ae0: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-00025af0: 2020 636f 6d6d 3a20 436f 6d6d 2c0a 2020    comm: Comm,.  
-00025b00: 2020 2020 2020 2a2c 0a20 2020 2020 2020        *,.       
-00025b10: 2061 6464 7265 7373 3a20 7374 722c 0a20   address: str,. 
-00025b20: 2020 2020 2020 2073 7461 7475 733a 2073         status: s
-00025b30: 7472 2c0a 2020 2020 2020 2020 7365 7276  tr,.        serv
-00025b40: 6572 5f69 643a 2073 7472 2c0a 2020 2020  er_id: str,.    
-00025b50: 2020 2020 6e74 6872 6561 6473 3a20 696e      nthreads: in
-00025b60: 742c 0a20 2020 2020 2020 206e 616d 653a  t,.        name:
-00025b70: 2073 7472 2c0a 2020 2020 2020 2020 7265   str,.        re
-00025b80: 736f 6c76 655f 6164 6472 6573 733a 2062  solve_address: b
-00025b90: 6f6f 6c20 3d20 5472 7565 2c0a 2020 2020  ool = True,.    
-00025ba0: 2020 2020 6e6f 773a 2066 6c6f 6174 2c0a      now: float,.
-00025bb0: 2020 2020 2020 2020 7265 736f 7572 6365          resource
-00025bc0: 733a 2064 6963 745b 7374 722c 2066 6c6f  s: dict[str, flo
-00025bd0: 6174 5d2c 0a20 2020 2020 2020 2023 2046  at],.        # F
-00025be0: 4958 4d45 3a20 5468 6973 2069 7320 6e65  IXME: This is ne
-00025bf0: 7665 7220 7375 626d 6974 7465 6420 6279  ver submitted by
-00025c00: 2074 6865 2077 6f72 6b65 720a 2020 2020   the worker.    
-00025c10: 2020 2020 686f 7374 5f69 6e66 6f3a 204e      host_info: N
-00025c20: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
-00025c30: 2020 2020 6d65 6d6f 7279 5f6c 696d 6974      memory_limit
-00025c40: 3a20 696e 7420 7c20 4e6f 6e65 2c0a 2020  : int | None,.  
-00025c50: 2020 2020 2020 6d65 7472 6963 733a 2064        metrics: d
-00025c60: 6963 745b 7374 722c 2041 6e79 5d2c 0a20  ict[str, Any],. 
-00025c70: 2020 2020 2020 2070 6964 3a20 696e 7420         pid: int 
-00025c80: 3d20 302c 0a20 2020 2020 2020 2073 6572  = 0,.        ser
-00025c90: 7669 6365 733a 2064 6963 745b 7374 722c  vices: dict[str,
-00025ca0: 2069 6e74 5d2c 0a20 2020 2020 2020 206c   int],.        l
-00025cb0: 6f63 616c 5f64 6972 6563 746f 7279 3a20  ocal_directory: 
-00025cc0: 7374 722c 0a20 2020 2020 2020 2076 6572  str,.        ver
-00025cd0: 7369 6f6e 733a 2064 6963 745b 7374 722c  sions: dict[str,
-00025ce0: 2041 6e79 5d2c 0a20 2020 2020 2020 206e   Any],.        n
-00025cf0: 616e 6e79 3a20 7374 722c 0a20 2020 2020  anny: str,.     
-00025d00: 2020 2065 7874 7261 3a20 6469 6374 2c0a     extra: dict,.
-00025d10: 2020 2020 2020 2020 7374 696d 756c 7573          stimulus
-00025d20: 5f69 643a 2073 7472 2c0a 2020 2020 2920  _id: str,.    ) 
-00025d30: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-00025d40: 2022 2222 4164 6420 6120 6e65 7720 776f   """Add a new wo
-00025d50: 726b 6572 2074 6f20 7468 6520 636c 7573  rker to the clus
-00025d60: 7465 7222 2222 0a20 2020 2020 2020 2061  ter""".        a
-00025d70: 6464 7265 7373 203d 2073 656c 662e 636f  ddress = self.co
-00025d80: 6572 6365 5f61 6464 7265 7373 2861 6464  erce_address(add
-00025d90: 7265 7373 2c20 7265 736f 6c76 655f 6164  ress, resolve_ad
-00025da0: 6472 6573 7329 0a20 2020 2020 2020 2061  dress).        a
-00025db0: 6464 7265 7373 203d 206e 6f72 6d61 6c69  ddress = normali
-00025dc0: 7a65 5f61 6464 7265 7373 2861 6464 7265  ze_address(addre
-00025dd0: 7373 290a 2020 2020 2020 2020 686f 7374  ss).        host
-00025de0: 203d 2067 6574 5f61 6464 7265 7373 5f68   = get_address_h
-00025df0: 6f73 7428 6164 6472 6573 7329 0a0a 2020  ost(address)..  
-00025e00: 2020 2020 2020 6966 2061 6464 7265 7373        if address
-00025e10: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
-00025e20: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-00025e30: 6973 6520 5661 6c75 6545 7272 6f72 2822  ise ValueError("
-00025e40: 576f 726b 6572 2061 6c72 6561 6479 2065  Worker already e
-00025e50: 7869 7374 7320 2573 2220 2520 6164 6472  xists %s" % addr
-00025e60: 6573 7329 0a0a 2020 2020 2020 2020 6966  ess)..        if
-00025e70: 206e 616d 6520 696e 2073 656c 662e 616c   name in self.al
-00025e80: 6961 7365 733a 0a20 2020 2020 2020 2020  iases:.         
-00025e90: 2020 206c 6f67 6765 722e 7761 726e 696e     logger.warnin
-00025ea0: 6728 2257 6f72 6b65 7220 7472 6965 6420  g("Worker tried 
-00025eb0: 746f 2063 6f6e 6e65 6374 2077 6974 6820  to connect with 
-00025ec0: 6120 6475 706c 6963 6174 6520 6e61 6d65  a duplicate name
-00025ed0: 3a20 2573 222c 206e 616d 6529 0a20 2020  : %s", name).   
-00025ee0: 2020 2020 2020 2020 206d 7367 203d 207b           msg = {
-00025ef0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00025f00: 2022 7374 6174 7573 223a 2022 6572 726f   "status": "erro
-00025f10: 7222 2c0a 2020 2020 2020 2020 2020 2020  r",.            
-00025f20: 2020 2020 226d 6573 7361 6765 223a 2022      "message": "
-00025f30: 6e61 6d65 2074 616b 656e 2c20 2573 2220  name taken, %s" 
-00025f40: 2520 6e61 6d65 2c0a 2020 2020 2020 2020  % name,.        
-00025f50: 2020 2020 2020 2020 2274 696d 6522 3a20          "time": 
-00025f60: 7469 6d65 2829 2c0a 2020 2020 2020 2020  time(),.        
-00025f70: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-00025f80: 2020 6177 6169 7420 636f 6d6d 2e77 7269    await comm.wri
-00025f90: 7465 286d 7367 290a 2020 2020 2020 2020  te(msg).        
-00025fa0: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
-00025fb0: 2020 2020 7365 6c66 2e6c 6f67 5f65 7665      self.log_eve
-00025fc0: 6e74 2861 6464 7265 7373 2c20 7b22 6163  nt(address, {"ac
-00025fd0: 7469 6f6e 223a 2022 6164 642d 776f 726b  tion": "add-work
-00025fe0: 6572 227d 290a 2020 2020 2020 2020 7365  er"}).        se
-00025ff0: 6c66 2e6c 6f67 5f65 7665 6e74 2822 616c  lf.log_event("al
-00026000: 6c22 2c20 7b22 6163 7469 6f6e 223a 2022  l", {"action": "
-00026010: 6164 642d 776f 726b 6572 222c 2022 776f  add-worker", "wo
-00026020: 726b 6572 223a 2061 6464 7265 7373 7d29  rker": address})
-00026030: 0a0a 2020 2020 2020 2020 7365 6c66 2e77  ..        self.w
-00026040: 6f72 6b65 7273 5b61 6464 7265 7373 5d20  orkers[address] 
-00026050: 3d20 7773 203d 2057 6f72 6b65 7253 7461  = ws = WorkerSta
-00026060: 7465 280a 2020 2020 2020 2020 2020 2020  te(.            
-00026070: 6164 6472 6573 733d 6164 6472 6573 732c  address=address,
-00026080: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
-00026090: 7475 733d 5374 6174 7573 2e6c 6f6f 6b75  tus=Status.looku
-000260a0: 705b 7374 6174 7573 5d2c 2020 2320 7479  p[status],  # ty
-000260b0: 7065 3a20 6967 6e6f 7265 0a20 2020 2020  pe: ignore.     
-000260c0: 2020 2020 2020 2070 6964 3d70 6964 2c0a         pid=pid,.
-000260d0: 2020 2020 2020 2020 2020 2020 6e74 6872              nthr
-000260e0: 6561 6473 3d6e 7468 7265 6164 732c 0a20  eads=nthreads,. 
-000260f0: 2020 2020 2020 2020 2020 206d 656d 6f72             memor
-00026100: 795f 6c69 6d69 743d 6d65 6d6f 7279 5f6c  y_limit=memory_l
-00026110: 696d 6974 206f 7220 302c 0a20 2020 2020  imit or 0,.     
-00026120: 2020 2020 2020 206e 616d 653d 6e61 6d65         name=name
-00026130: 2c0a 2020 2020 2020 2020 2020 2020 6c6f  ,.            lo
-00026140: 6361 6c5f 6469 7265 6374 6f72 793d 6c6f  cal_directory=lo
-00026150: 6361 6c5f 6469 7265 6374 6f72 792c 0a20  cal_directory,. 
-00026160: 2020 2020 2020 2020 2020 2073 6572 7669             servi
-00026170: 6365 733d 7365 7276 6963 6573 2c0a 2020  ces=services,.  
-00026180: 2020 2020 2020 2020 2020 7665 7273 696f            versio
-00026190: 6e73 3d76 6572 7369 6f6e 732c 0a20 2020  ns=versions,.   
-000261a0: 2020 2020 2020 2020 206e 616e 6e79 3d6e           nanny=n
-000261b0: 616e 6e79 2c0a 2020 2020 2020 2020 2020  anny,.          
-000261c0: 2020 6578 7472 613d 6578 7472 612c 0a20    extra=extra,. 
-000261d0: 2020 2020 2020 2020 2020 2073 6572 7665             serve
-000261e0: 725f 6964 3d73 6572 7665 725f 6964 2c0a  r_id=server_id,.
-000261f0: 2020 2020 2020 2020 2020 2020 7363 6865              sche
-00026200: 6475 6c65 723d 7365 6c66 2c0a 2020 2020  duler=self,.    
-00026210: 2020 2020 290a 2020 2020 2020 2020 6966      ).        if
-00026220: 2077 732e 7374 6174 7573 203d 3d20 5374   ws.status == St
-00026230: 6174 7573 2e72 756e 6e69 6e67 3a0a 2020  atus.running:.  
-00026240: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
-00026250: 756e 6e69 6e67 2e61 6464 2877 7329 0a0a  unning.add(ws)..
-00026260: 2020 2020 2020 2020 6468 203d 2073 656c          dh = sel
-00026270: 662e 686f 7374 5f69 6e66 6f2e 6765 7428  f.host_info.get(
-00026280: 686f 7374 290a 2020 2020 2020 2020 6966  host).        if
-00026290: 2064 6820 6973 204e 6f6e 653a 0a20 2020   dh is None:.   
-000262a0: 2020 2020 2020 2020 2073 656c 662e 686f           self.ho
-000262b0: 7374 5f69 6e66 6f5b 686f 7374 5d20 3d20  st_info[host] = 
-000262c0: 6468 203d 207b 7d0a 0a20 2020 2020 2020  dh = {}..       
-000262d0: 2064 685f 6164 6472 6573 7365 7320 3d20   dh_addresses = 
-000262e0: 6468 2e67 6574 2822 6164 6472 6573 7365  dh.get("addresse
-000262f0: 7322 290a 2020 2020 2020 2020 6966 2064  s").        if d
-00026300: 685f 6164 6472 6573 7365 7320 6973 204e  h_addresses is N
-00026310: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00026320: 2064 685b 2261 6464 7265 7373 6573 225d   dh["addresses"]
-00026330: 203d 2064 685f 6164 6472 6573 7365 7320   = dh_addresses 
-00026340: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
-00026350: 2020 2020 6468 5b22 6e74 6872 6561 6473      dh["nthreads
-00026360: 225d 203d 2030 0a0a 2020 2020 2020 2020  "] = 0..        
-00026370: 6468 5f61 6464 7265 7373 6573 2e61 6464  dh_addresses.add
-00026380: 2861 6464 7265 7373 290a 2020 2020 2020  (address).      
-00026390: 2020 6468 5b22 6e74 6872 6561 6473 225d    dh["nthreads"]
-000263a0: 202b 3d20 6e74 6872 6561 6473 0a0a 2020   += nthreads..  
-000263b0: 2020 2020 2020 7365 6c66 2e74 6f74 616c        self.total
-000263c0: 5f6e 7468 7265 6164 7320 2b3d 206e 7468  _nthreads += nth
-000263d0: 7265 6164 730a 2020 2020 2020 2020 7365  reads.        se
-000263e0: 6c66 2e74 6f74 616c 5f6e 7468 7265 6164  lf.total_nthread
-000263f0: 735f 6869 7374 6f72 792e 6170 7065 6e64  s_history.append
-00026400: 2828 7469 6d65 2829 2c20 7365 6c66 2e74  ((time(), self.t
-00026410: 6f74 616c 5f6e 7468 7265 6164 7329 290a  otal_nthreads)).
-00026420: 2020 2020 2020 2020 7365 6c66 2e61 6c69          self.ali
-00026430: 6173 6573 5b6e 616d 655d 203d 2061 6464  ases[name] = add
-00026440: 7265 7373 0a0a 2020 2020 2020 2020 7365  ress..        se
-00026450: 6c66 2e68 6561 7274 6265 6174 5f77 6f72  lf.heartbeat_wor
-00026460: 6b65 7228 0a20 2020 2020 2020 2020 2020  ker(.           
-00026470: 2061 6464 7265 7373 3d61 6464 7265 7373   address=address
-00026480: 2c0a 2020 2020 2020 2020 2020 2020 7265  ,.            re
-00026490: 736f 6c76 655f 6164 6472 6573 733d 7265  solve_address=re
-000264a0: 736f 6c76 655f 6164 6472 6573 732c 0a20  solve_address,. 
-000264b0: 2020 2020 2020 2020 2020 206e 6f77 3d6e             now=n
-000264c0: 6f77 2c0a 2020 2020 2020 2020 2020 2020  ow,.            
-000264d0: 7265 736f 7572 6365 733d 7265 736f 7572  resources=resour
-000264e0: 6365 732c 0a20 2020 2020 2020 2020 2020  ces,.           
-000264f0: 2068 6f73 745f 696e 666f 3d68 6f73 745f   host_info=host_
-00026500: 696e 666f 2c0a 2020 2020 2020 2020 2020  info,.          
-00026510: 2020 6d65 7472 6963 733d 6d65 7472 6963    metrics=metric
-00026520: 732c 0a20 2020 2020 2020 2029 0a0a 2020  s,.        )..  
-00026530: 2020 2020 2020 2320 446f 206e 6f74 206e        # Do not n
-00026540: 6565 6420 746f 2061 646a 7573 7420 7365  eed to adjust se
-00026550: 6c66 2e74 6f74 616c 5f6f 6363 7570 616e  lf.total_occupan
-00026560: 6379 2061 7320 7365 6c66 2e6f 6363 7570  cy as self.occup
-00026570: 616e 6379 5b77 735d 2063 616e 6e6f 740a  ancy[ws] cannot.
-00026580: 2020 2020 2020 2020 2320 6578 6973 7420          # exist 
-00026590: 6265 666f 7265 2074 6869 732e 0a20 2020  before this..   
-000265a0: 2020 2020 2073 656c 662e 6368 6563 6b5f       self.check_
-000265b0: 6964 6c65 5f73 6174 7572 6174 6564 2877  idle_saturated(w
-000265c0: 7329 0a0a 2020 2020 2020 2020 7365 6c66  s)..        self
-000265d0: 2e73 7472 6561 6d5f 636f 6d6d 735b 6164  .stream_comms[ad
-000265e0: 6472 6573 735d 203d 2042 6174 6368 6564  dress] = Batched
-000265f0: 5365 6e64 2869 6e74 6572 7661 6c3d 2235  Send(interval="5
-00026600: 6d73 222c 206c 6f6f 703d 7365 6c66 2e6c  ms", loop=self.l
-00026610: 6f6f 7029 0a0a 2020 2020 2020 2020 6177  oop)..        aw
-00026620: 6169 7461 626c 6573 203d 205b 5d0a 2020  aitables = [].  
-00026630: 2020 2020 2020 666f 7220 706c 7567 696e        for plugin
-00026640: 2069 6e20 6c69 7374 2873 656c 662e 706c   in list(self.pl
-00026650: 7567 696e 732e 7661 6c75 6573 2829 293a  ugins.values()):
-00026660: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
-00026670: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00026680: 2020 7265 7375 6c74 203d 2070 6c75 6769    result = plugi
-00026690: 6e2e 6164 645f 776f 726b 6572 2873 6368  n.add_worker(sch
-000266a0: 6564 756c 6572 3d73 656c 662c 2077 6f72  eduler=self, wor
-000266b0: 6b65 723d 6164 6472 6573 7329 0a20 2020  ker=address).   
-000266c0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000266d0: 7265 7375 6c74 2069 7320 6e6f 7420 4e6f  result is not No
-000266e0: 6e65 2061 6e64 2069 6e73 7065 6374 2e69  ne and inspect.i
-000266f0: 7361 7761 6974 6162 6c65 2872 6573 756c  sawaitable(resul
-00026700: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
-00026710: 2020 2020 2020 2020 6177 6169 7461 626c          awaitabl
-00026720: 6573 2e61 7070 656e 6428 7265 7375 6c74  es.append(result
-00026730: 290a 2020 2020 2020 2020 2020 2020 6578  ).            ex
-00026740: 6365 7074 2045 7863 6570 7469 6f6e 2061  cept Exception a
-00026750: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
-00026760: 2020 2020 206c 6f67 6765 722e 6578 6365       logger.exce
-00026770: 7074 696f 6e28 6529 0a0a 2020 2020 2020  ption(e)..      
-00026780: 2020 706c 7567 696e 5f6d 7367 7320 3d20    plugin_msgs = 
-00026790: 6177 6169 7420 6173 796e 6369 6f2e 6761  await asyncio.ga
-000267a0: 7468 6572 282a 6177 6169 7461 626c 6573  ther(*awaitables
-000267b0: 2c20 7265 7475 726e 5f65 7863 6570 7469  , return_excepti
-000267c0: 6f6e 733d 5472 7565 290a 2020 2020 2020  ons=True).      
-000267d0: 2020 706c 7567 696e 735f 6578 6365 7074    plugins_except
-000267e0: 696f 6e73 203d 205b 6d73 6720 666f 7220  ions = [msg for 
-000267f0: 6d73 6720 696e 2070 6c75 6769 6e5f 6d73  msg in plugin_ms
-00026800: 6773 2069 6620 6973 696e 7374 616e 6365  gs if isinstance
-00026810: 286d 7367 2c20 4578 6365 7074 696f 6e29  (msg, Exception)
-00026820: 5d0a 2020 2020 2020 2020 666f 7220 6578  ].        for ex
-00026830: 6320 696e 2070 6c75 6769 6e73 5f65 7863  c in plugins_exc
-00026840: 6570 7469 6f6e 733a 0a20 2020 2020 2020  eptions:.       
-00026850: 2020 2020 206c 6f67 6765 722e 6578 6365       logger.exce
-00026860: 7074 696f 6e28 6578 632c 2065 7863 5f69  ption(exc, exc_i
-00026870: 6e66 6f3d 6578 6329 0a0a 2020 2020 2020  nfo=exc)..      
-00026880: 2020 6966 2077 732e 7374 6174 7573 203d    if ws.status =
-00026890: 3d20 5374 6174 7573 2e72 756e 6e69 6e67  = Status.running
-000268a0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-000268b0: 6c66 2e74 7261 6e73 6974 696f 6e73 280a  lf.transitions(.
-000268c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000268d0: 7365 6c66 2e62 756c 6b5f 7363 6865 6475  self.bulk_schedu
-000268e0: 6c65 5f75 6e72 756e 6e61 626c 655f 6166  le_unrunnable_af
-000268f0: 7465 725f 6164 6469 6e67 5f77 6f72 6b65  ter_adding_worke
-00026900: 7228 7773 292c 2073 7469 6d75 6c75 735f  r(ws), stimulus_
-00026910: 6964 0a20 2020 2020 2020 2020 2020 2029  id.            )
-00026920: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00026930: 662e 7374 696d 756c 7573 5f71 7565 7565  f.stimulus_queue
-00026940: 5f73 6c6f 7473 5f6d 6179 6265 5f6f 7065  _slots_maybe_ope
-00026950: 6e65 6428 7374 696d 756c 7573 5f69 643d  ned(stimulus_id=
-00026960: 7374 696d 756c 7573 5f69 6429 0a0a 2020  stimulus_id)..  
-00026970: 2020 2020 2020 6c6f 6767 6572 2e69 6e66        logger.inf
-00026980: 6f28 2252 6567 6973 7465 7220 776f 726b  o("Register work
-00026990: 6572 2025 7322 2c20 7773 290a 0a20 2020  er %s", ws)..   
-000269a0: 2020 2020 206d 7367 203d 207b 0a20 2020       msg = {.   
-000269b0: 2020 2020 2020 2020 2022 7374 6174 7573           "status
-000269c0: 223a 2022 4f4b 222c 0a20 2020 2020 2020  ": "OK",.       
-000269d0: 2020 2020 2022 7469 6d65 223a 2074 696d       "time": tim
-000269e0: 6528 292c 0a20 2020 2020 2020 2020 2020  e(),.           
-000269f0: 2022 6865 6172 7462 6561 742d 696e 7465   "heartbeat-inte
-00026a00: 7276 616c 223a 2068 6561 7274 6265 6174  rval": heartbeat
-00026a10: 5f69 6e74 6572 7661 6c28 6c65 6e28 7365  _interval(len(se
-00026a20: 6c66 2e77 6f72 6b65 7273 2929 2c0a 2020  lf.workers)),.  
-00026a30: 2020 2020 2020 2020 2020 2277 6f72 6b65            "worke
-00026a40: 722d 706c 7567 696e 7322 3a20 7365 6c66  r-plugins": self
-00026a50: 2e77 6f72 6b65 725f 706c 7567 696e 732c  .worker_plugins,
-00026a60: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
-00026a70: 2020 2020 7665 7273 696f 6e5f 7761 726e      version_warn
-00026a80: 696e 6720 3d20 7665 7273 696f 6e5f 6d6f  ing = version_mo
-00026a90: 6475 6c65 2e65 7272 6f72 5f6d 6573 7361  dule.error_messa
-00026aa0: 6765 280a 2020 2020 2020 2020 2020 2020  ge(.            
-00026ab0: 7665 7273 696f 6e5f 6d6f 6475 6c65 2e67  version_module.g
-00026ac0: 6574 5f76 6572 7369 6f6e 7328 292c 0a20  et_versions(),. 
-00026ad0: 2020 2020 2020 2020 2020 207b 773a 2077             {w: w
-00026ae0: 732e 7665 7273 696f 6e73 2066 6f72 2077  s.versions for w
-00026af0: 2c20 7773 2069 6e20 7365 6c66 2e77 6f72  , ws in self.wor
-00026b00: 6b65 7273 2e69 7465 6d73 2829 7d2c 0a20  kers.items()},. 
-00026b10: 2020 2020 2020 2020 2020 2076 6572 7369             versi
-00026b20: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
-00026b30: 2073 6f75 7263 655f 6e61 6d65 3d73 7472   source_name=str
-00026b40: 2877 732e 7365 7276 6572 5f69 6429 2c0a  (ws.server_id),.
-00026b50: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00026b60: 2020 6d73 672e 7570 6461 7465 2876 6572    msg.update(ver
-00026b70: 7369 6f6e 5f77 6172 6e69 6e67 290a 0a20  sion_warning).. 
-00026b80: 2020 2020 2020 2061 7761 6974 2063 6f6d         await com
-00026b90: 6d2e 7772 6974 6528 6d73 6729 0a20 2020  m.write(msg).   
-00026ba0: 2020 2020 2023 2054 6869 7320 7769 6c6c       # This will
-00026bb0: 206b 6565 7020 7275 6e6e 696e 6720 756e   keep running un
-00026bc0: 7469 6c20 7468 6520 776f 726b 6572 2069  til the worker i
-00026bd0: 7320 7265 6d6f 7665 640a 2020 2020 2020  s removed.      
-00026be0: 2020 6177 6169 7420 7365 6c66 2e68 616e    await self.han
-00026bf0: 646c 655f 776f 726b 6572 2863 6f6d 6d2c  dle_worker(comm,
-00026c00: 2061 6464 7265 7373 290a 0a20 2020 2061   address)..    a
-00026c10: 7379 6e63 2064 6566 2061 6464 5f6e 616e  sync def add_nan
-00026c20: 6e79 2873 656c 662c 2063 6f6d 6d3a 2043  ny(self, comm: C
-00026c30: 6f6d 6d2c 2061 6464 7265 7373 3a20 7374  omm, address: st
-00026c40: 7229 202d 3e20 4e6f 6e65 3a0a 2020 2020  r) -> None:.    
-00026c50: 2020 2020 6173 796e 6320 7769 7468 2073      async with s
-00026c60: 656c 662e 5f73 7461 7274 696e 675f 6e61  elf._starting_na
-00026c70: 6e6e 6965 735f 636f 6e64 3a0a 2020 2020  nnies_cond:.    
-00026c80: 2020 2020 2020 2020 7365 6c66 2e5f 7374          self._st
-00026c90: 6172 7469 6e67 5f6e 616e 6e69 6573 2e61  arting_nannies.a
-00026ca0: 6464 2861 6464 7265 7373 290a 2020 2020  dd(address).    
-00026cb0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00026cc0: 2020 2020 206d 7367 203d 207b 0a20 2020       msg = {.   
-00026cd0: 2020 2020 2020 2020 2020 2020 2022 7374               "st
-00026ce0: 6174 7573 223a 2022 4f4b 222c 0a20 2020  atus": "OK",.   
-00026cf0: 2020 2020 2020 2020 2020 2020 2022 6e61               "na
-00026d00: 6e6e 792d 706c 7567 696e 7322 3a20 7365  nny-plugins": se
-00026d10: 6c66 2e6e 616e 6e79 5f70 6c75 6769 6e73  lf.nanny_plugins
-00026d20: 2c0a 2020 2020 2020 2020 2020 2020 7d0a  ,.            }.
-00026d30: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-00026d40: 7420 636f 6d6d 2e77 7269 7465 286d 7367  t comm.write(msg
-00026d50: 290a 2020 2020 2020 2020 2020 2020 6177  ).            aw
-00026d60: 6169 7420 636f 6d6d 2e72 6561 6428 290a  ait comm.read().
-00026d70: 2020 2020 2020 2020 6669 6e61 6c6c 793a          finally:
-00026d80: 0a20 2020 2020 2020 2020 2020 2061 7379  .            asy
-00026d90: 6e63 2077 6974 6820 7365 6c66 2e5f 7374  nc with self._st
-00026da0: 6172 7469 6e67 5f6e 616e 6e69 6573 5f63  arting_nannies_c
-00026db0: 6f6e 643a 0a20 2020 2020 2020 2020 2020  ond:.           
-00026dc0: 2020 2020 2073 656c 662e 5f73 7461 7274       self._start
-00026dd0: 696e 675f 6e61 6e6e 6965 732e 6469 7363  ing_nannies.disc
-00026de0: 6172 6428 6164 6472 6573 7329 0a20 2020  ard(address).   
-00026df0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00026e00: 662e 5f73 7461 7274 696e 675f 6e61 6e6e  f._starting_nann
-00026e10: 6965 735f 636f 6e64 2e6e 6f74 6966 795f  ies_cond.notify_
-00026e20: 616c 6c28 290a 0a20 2020 2064 6566 205f  all()..    def _
-00026e30: 6d61 7463 685f 6772 6170 685f 7769 7468  match_graph_with
-00026e40: 5f74 6173 6b73 280a 2020 2020 2020 2020  _tasks(.        
-00026e50: 7365 6c66 2c0a 2020 2020 2020 2020 6473  self,.        ds
-00026e60: 6b3a 2064 6963 745b 4b65 792c 2054 5f72  k: dict[Key, T_r
-00026e70: 756e 7370 6563 5d2c 0a20 2020 2020 2020  unspec],.       
-00026e80: 2064 6570 656e 6465 6e63 6965 733a 2064   dependencies: d
-00026e90: 6963 745b 4b65 792c 2073 6574 5b4b 6579  ict[Key, set[Key
-00026ea0: 5d5d 2c0a 2020 2020 2020 2020 6b65 7973  ]],.        keys
-00026eb0: 3a20 7365 745b 4b65 795d 2c0a 2020 2020  : set[Key],.    
-00026ec0: 2920 2d3e 2073 6574 5b4b 6579 5d3a 0a20  ) -> set[Key]:. 
-00026ed0: 2020 2020 2020 206e 203d 2030 0a20 2020         n = 0.   
-00026ee0: 2020 2020 206c 6f73 745f 6b65 7973 203d       lost_keys =
-00026ef0: 2073 6574 2829 0a20 2020 2020 2020 2077   set().        w
-00026f00: 6869 6c65 206c 656e 2864 736b 2920 213d  hile len(dsk) !=
-00026f10: 206e 3a20 2023 2077 616c 6b20 7468 726f   n:  # walk thro
-00026f20: 7567 6820 6e65 7720 7461 736b 732c 2063  ugh new tasks, c
-00026f30: 616e 6365 6c20 616e 7920 6261 6420 6465  ancel any bad de
-00026f40: 7073 0a20 2020 2020 2020 2020 2020 206e  ps.            n
-00026f50: 203d 206c 656e 2864 736b 290a 2020 2020   = len(dsk).    
-00026f60: 2020 2020 2020 2020 666f 7220 6b2c 2064          for k, d
-00026f70: 6570 7320 696e 206c 6973 7428 6465 7065  eps in list(depe
-00026f80: 6e64 656e 6369 6573 2e69 7465 6d73 2829  ndencies.items()
-00026f90: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00026fa0: 2020 2069 6620 616e 7928 0a20 2020 2020     if any(.     
-00026fb0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00026fc0: 6570 206e 6f74 2069 6e20 7365 6c66 2e74  ep not in self.t
-00026fd0: 6173 6b73 2061 6e64 2064 6570 206e 6f74  asks and dep not
-00026fe0: 2069 6e20 6473 6b20 666f 7220 6465 7020   in dsk for dep 
-00026ff0: 696e 2064 6570 730a 2020 2020 2020 2020  in deps.        
-00027000: 2020 2020 2020 2020 293a 2020 2320 6261          ):  # ba
-00027010: 6420 6b65 790a 2020 2020 2020 2020 2020  d key.          
-00027020: 2020 2020 2020 2020 2020 6c6f 7374 5f6b            lost_k
-00027030: 6579 732e 6164 6428 6b29 0a20 2020 2020  eys.add(k).     
-00027040: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00027050: 6f67 6765 722e 696e 666f 2822 5573 6572  ogger.info("User
-00027060: 2061 736b 6564 2066 6f72 2063 6f6d 7075   asked for compu
-00027070: 7461 7469 6f6e 206f 6e20 6c6f 7374 2064  tation on lost d
-00027080: 6174 612c 2025 7322 2c20 6b29 0a20 2020  ata, %s", k).   
-00027090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000270a0: 2064 656c 2064 736b 5b6b 5d0a 2020 2020   del dsk[k].    
-000270b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000270c0: 6465 6c20 6465 7065 6e64 656e 6369 6573  del dependencies
-000270d0: 5b6b 5d0a 2020 2020 2020 2020 2020 2020  [k].            
-000270e0: 2020 2020 2020 2020 6966 206b 2069 6e20          if k in 
-000270f0: 6b65 7973 3a0a 2020 2020 2020 2020 2020  keys:.          
-00027100: 2020 2020 2020 2020 2020 2020 2020 6b65                ke
-00027110: 7973 2e72 656d 6f76 6528 6b29 0a20 2020  ys.remove(k).   
-00027120: 2020 2020 2020 2020 2020 2020 2064 656c               del
-00027130: 2064 6570 730a 2020 2020 2020 2020 2320   deps.        # 
-00027140: 4176 6f69 6420 636f 6d70 7574 6174 696f  Avoid computatio
-00027150: 6e20 7468 6174 2069 7320 616c 7265 6164  n that is alread
-00027160: 7920 6669 6e69 7368 6564 0a20 2020 2020  y finished.     
-00027170: 2020 2064 6f6e 6520 3d20 7365 7428 2920     done = set() 
-00027180: 2023 2074 6173 6b73 2074 6861 7420 6172   # tasks that ar
-00027190: 6520 616c 7265 6164 7920 646f 6e65 0a20  e already done. 
-000271a0: 2020 2020 2020 2066 6f72 206b 2c20 7620         for k, v 
-000271b0: 696e 2064 6570 656e 6465 6e63 6965 732e  in dependencies.
-000271c0: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
-000271d0: 2020 2020 2069 6620 7620 616e 6420 6b20       if v and k 
-000271e0: 696e 2073 656c 662e 7461 736b 733a 0a20  in self.tasks:. 
-000271f0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00027200: 7320 3d20 7365 6c66 2e74 6173 6b73 5b6b  s = self.tasks[k
-00027210: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00027220: 2020 6966 2074 732e 7374 6174 6520 696e    if ts.state in
-00027230: 2028 226d 656d 6f72 7922 2c20 2265 7272   ("memory", "err
-00027240: 6564 2229 3a0a 2020 2020 2020 2020 2020  ed"):.          
-00027250: 2020 2020 2020 2020 2020 646f 6e65 2e61            done.a
-00027260: 6464 286b 290a 0a20 2020 2020 2020 2069  dd(k)..        i
-00027270: 6620 646f 6e65 3a0a 2020 2020 2020 2020  f done:.        
-00027280: 2020 2020 6465 7065 6e64 656e 7473 203d      dependents =
-00027290: 2064 6173 6b2e 636f 7265 2e72 6576 6572   dask.core.rever
-000272a0: 7365 5f64 6963 7428 6465 7065 6e64 656e  se_dict(dependen
-000272b0: 6369 6573 290a 2020 2020 2020 2020 2020  cies).          
-000272c0: 2020 7374 6163 6b20 3d20 6c69 7374 2864    stack = list(d
-000272d0: 6f6e 6529 0a20 2020 2020 2020 2020 2020  one).           
-000272e0: 2077 6869 6c65 2073 7461 636b 3a20 2023   while stack:  #
-000272f0: 2072 656d 6f76 6520 756e 6e65 6365 7373   remove unnecess
-00027300: 6172 7920 6465 7065 6e64 656e 6369 6573  ary dependencies
-00027310: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00027320: 206b 6579 203d 2073 7461 636b 2e70 6f70   key = stack.pop
-00027330: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
-00027340: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00027350: 2020 2020 2020 2020 2020 2020 6465 7073              deps
-00027360: 203d 2064 6570 656e 6465 6e63 6965 735b   = dependencies[
-00027370: 6b65 795d 0a20 2020 2020 2020 2020 2020  key].           
-00027380: 2020 2020 2065 7863 6570 7420 4b65 7945       except KeyE
-00027390: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
-000273a0: 2020 2020 2020 2020 2020 6465 7073 203d            deps =
-000273b0: 207b 7473 2e6b 6579 2066 6f72 2074 7320   {ts.key for ts 
-000273c0: 696e 2073 656c 662e 7461 736b 735b 6b65  in self.tasks[ke
-000273d0: 795d 2e64 6570 656e 6465 6e63 6965 737d  y].dependencies}
-000273e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000273f0: 2066 6f72 2064 6570 2069 6e20 6465 7073   for dep in deps
-00027400: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00027410: 2020 2020 2020 6966 2064 6570 2069 6e20        if dep in 
-00027420: 6465 7065 6e64 656e 7473 3a0a 2020 2020  dependents:.    
-00027430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027440: 2020 2020 6368 696c 645f 6465 7073 203d      child_deps =
-00027450: 2064 6570 656e 6465 6e74 735b 6465 705d   dependents[dep]
-00027460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00027470: 2020 2020 2065 6c69 6620 6465 7020 696e       elif dep in
-00027480: 2073 656c 662e 7461 736b 733a 0a20 2020   self.tasks:.   
-00027490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000274a0: 2020 2020 2063 6869 6c64 5f64 6570 7320       child_deps 
-000274b0: 3d20 7b74 732e 6b65 7920 666f 7220 7473  = {ts.key for ts
-000274c0: 2069 6e20 7365 6c66 2e74 6173 6b73 5b6b   in self.tasks[k
-000274d0: 6579 5d2e 6465 7065 6e64 656e 6369 6573  ey].dependencies
-000274e0: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-000274f0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00027500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027510: 2020 2020 6368 696c 645f 6465 7073 203d      child_deps =
-00027520: 2073 6574 2829 0a20 2020 2020 2020 2020   set().         
-00027530: 2020 2020 2020 2020 2020 2069 6620 616c             if al
-00027540: 6c28 6420 696e 2064 6f6e 6520 666f 7220  l(d in done for 
-00027550: 6420 696e 2063 6869 6c64 5f64 6570 7329  d in child_deps)
-00027560: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00027570: 2020 2020 2020 2020 2020 6966 2064 6570            if dep
-00027580: 2069 6e20 7365 6c66 2e74 6173 6b73 2061   in self.tasks a
-00027590: 6e64 2064 6570 206e 6f74 2069 6e20 646f  nd dep not in do
-000275a0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-000275b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000275c0: 646f 6e65 2e61 6464 2864 6570 290a 2020  done.add(dep).  
-000275d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000275e0: 2020 2020 2020 2020 2020 7374 6163 6b2e            stack.
-000275f0: 6170 7065 6e64 2864 6570 290a 2020 2020  append(dep).    
-00027600: 2020 2020 666f 7220 616e 6320 696e 2064      for anc in d
-00027610: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00027620: 2064 736b 2e70 6f70 2861 6e63 2c20 4e6f   dsk.pop(anc, No
-00027630: 6e65 290a 2020 2020 2020 2020 2020 2020  ne).            
-00027640: 6465 7065 6e64 656e 6369 6573 2e70 6f70  dependencies.pop
-00027650: 2861 6e63 2c20 4e6f 6e65 290a 2020 2020  (anc, None).    
-00027660: 2020 2020 7265 7475 726e 206c 6f73 745f      return lost_
-00027670: 6b65 7973 0a0a 2020 2020 6465 6620 5f63  keys..    def _c
-00027680: 7265 6174 655f 7461 736b 7374 6174 655f  reate_taskstate_
-00027690: 6672 6f6d 5f67 7261 7068 280a 2020 2020  from_graph(.    
-000276a0: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-000276b0: 2020 2a2c 0a20 2020 2020 2020 2073 7461    *,.        sta
-000276c0: 7274 3a20 666c 6f61 742c 0a20 2020 2020  rt: float,.     
-000276d0: 2020 2064 736b 3a20 6469 6374 5b4b 6579     dsk: dict[Key
-000276e0: 2c20 545f 7275 6e73 7065 635d 2c0a 2020  , T_runspec],.  
-000276f0: 2020 2020 2020 6465 7065 6e64 656e 6369        dependenci
-00027700: 6573 3a20 6469 6374 2c0a 2020 2020 2020  es: dict,.      
-00027710: 2020 6b65 7973 3a20 7365 745b 4b65 795d    keys: set[Key]
-00027720: 2c0a 2020 2020 2020 2020 6f72 6465 7265  ,.        ordere
-00027730: 643a 2064 6963 745b 4b65 792c 2069 6e74  d: dict[Key, int
-00027740: 5d2c 0a20 2020 2020 2020 2063 6c69 656e  ],.        clien
-00027750: 743a 2073 7472 2c0a 2020 2020 2020 2020  t: str,.        
-00027760: 616e 6e6f 7461 7469 6f6e 735f 6279 5f74  annotations_by_t
-00027770: 7970 653a 2064 6963 742c 0a20 2020 2020  ype: dict,.     
-00027780: 2020 2067 6c6f 6261 6c5f 616e 6e6f 7461     global_annota
-00027790: 7469 6f6e 733a 2064 6963 7420 7c20 4e6f  tions: dict | No
-000277a0: 6e65 2c0a 2020 2020 2020 2020 7374 696d  ne,.        stim
-000277b0: 756c 7573 5f69 643a 2073 7472 2c0a 2020  ulus_id: str,.  
-000277c0: 2020 2020 2020 7375 626d 6974 7469 6e67        submitting
-000277d0: 5f74 6173 6b3a 204b 6579 207c 204e 6f6e  _task: Key | Non
-000277e0: 652c 0a20 2020 2020 2020 2075 7365 725f  e,.        user_
-000277f0: 7072 696f 7269 7479 3a20 696e 7420 7c20  priority: int | 
-00027800: 6469 6374 5b4b 6579 2c20 696e 745d 203d  dict[Key, int] =
-00027810: 2030 2c0a 2020 2020 2020 2020 6163 746f   0,.        acto
-00027820: 7273 3a20 626f 6f6c 207c 206c 6973 745b  rs: bool | list[
-00027830: 4b65 795d 207c 204e 6f6e 6520 3d20 4e6f  Key] | None = No
-00027840: 6e65 2c0a 2020 2020 2020 2020 6669 666f  ne,.        fifo
-00027850: 5f74 696d 656f 7574 3a20 666c 6f61 7420  _timeout: float 
-00027860: 3d20 302e 302c 0a20 2020 2020 2020 2063  = 0.0,.        c
-00027870: 6f64 653a 2074 7570 6c65 5b53 6f75 7263  ode: tuple[Sourc
-00027880: 6543 6f64 652c 202e 2e2e 5d20 3d20 2829  eCode, ...] = ()
-00027890: 2c0a 2020 2020 2920 2d3e 204e 6f6e 653a  ,.    ) -> None:
-000278a0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-000278b0: 2020 2020 2054 616b 6520 6120 6c6f 7720       Take a low 
-000278c0: 6c65 7665 6c20 6772 6170 6820 616e 6420  level graph and 
-000278d0: 6372 6561 7465 2074 6865 206e 6563 6573  create the neces
-000278e0: 7361 7279 2073 6368 6564 756c 6572 2073  sary scheduler s
-000278f0: 7461 7465 2074 6f0a 2020 2020 2020 2020  tate to.        
-00027900: 636f 6d70 7574 6520 6974 2e0a 0a20 2020  compute it...   
-00027910: 2020 2020 2057 4152 4e49 4e47 0a20 2020       WARNING.   
-00027920: 2020 2020 202d 2d2d 2d2d 2d2d 0a20 2020       -------.   
-00027930: 2020 2020 2054 6869 7320 6d65 7468 6f64       This method
-00027940: 206d 7573 7420 6e6f 7420 6265 206d 6164   must not be mad
-00027950: 6520 6173 796e 6320 7369 6e63 6520 6e6f  e async since no
-00027960: 7468 696e 6720 6865 7265 2069 7320 636f  thing here is co
-00027970: 6e63 7572 7265 6e63 790a 2020 2020 2020  ncurrency.      
-00027980: 2020 7361 6665 2e20 416c 6c20 696e 7465    safe. All inte
-00027990: 7261 6374 696f 6e73 2077 6974 6820 5461  ractions with Ta
-000279a0: 736b 5374 6174 6520 6f62 6a65 6374 7320  skState objects 
-000279b0: 6865 7265 2073 686f 756c 6420 6265 2068  here should be h
-000279c0: 6170 7065 6e69 6e67 0a20 2020 2020 2020  appening.       
-000279d0: 2069 6e20 7468 6520 7361 6d65 2065 7665   in the same eve
-000279e0: 6e74 206c 6f6f 7020 7469 636b 2e0a 2020  nt loop tick..  
-000279f0: 2020 2020 2020 2222 220a 0a20 2020 2020        """..     
-00027a00: 2020 206c 6f73 745f 6b65 7973 203d 2073     lost_keys = s
-00027a10: 656c 662e 5f6d 6174 6368 5f67 7261 7068  elf._match_graph
-00027a20: 5f77 6974 685f 7461 736b 7328 6473 6b2c  _with_tasks(dsk,
-00027a30: 2064 6570 656e 6465 6e63 6965 732c 206b   dependencies, k
-00027a40: 6579 7329 0a0a 2020 2020 2020 2020 6966  eys)..        if
-00027a50: 206c 656e 2864 736b 2920 3e20 313a 0a20   len(dsk) > 1:. 
-00027a60: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00027a70: 6c6f 675f 6576 656e 7428 0a20 2020 2020  log_event(.     
-00027a80: 2020 2020 2020 2020 2020 205b 2261 6c6c             ["all
-00027a90: 222c 2063 6c69 656e 745d 2c20 7b22 6163  ", client], {"ac
-00027aa0: 7469 6f6e 223a 2022 7570 6461 7465 5f67  tion": "update_g
-00027ab0: 7261 7068 222c 2022 636f 756e 7422 3a20  raph", "count": 
-00027ac0: 6c65 6e28 6473 6b29 7d0a 2020 2020 2020  len(dsk)}.      
-00027ad0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-00027ae0: 2069 6620 6c6f 7374 5f6b 6579 733a 0a20   if lost_keys:. 
-00027af0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00027b00: 7265 706f 7274 287b 226f 7022 3a20 2263  report({"op": "c
-00027b10: 616e 6365 6c6c 6564 2d6b 6579 7322 2c20  ancelled-keys", 
-00027b20: 226b 6579 7322 3a20 6c6f 7374 5f6b 6579  "keys": lost_key
-00027b30: 737d 2c20 636c 6965 6e74 3d63 6c69 656e  s}, client=clien
-00027b40: 7429 0a20 2020 2020 2020 2020 2020 2073  t).            s
-00027b50: 656c 662e 636c 6965 6e74 5f72 656c 6561  elf.client_relea
-00027b60: 7365 735f 6b65 7973 280a 2020 2020 2020  ses_keys(.      
-00027b70: 2020 2020 2020 2020 2020 6b65 7973 3d6c            keys=l
-00027b80: 6f73 745f 6b65 7973 2c20 636c 6965 6e74  ost_keys, client
-00027b90: 3d63 6c69 656e 742c 2073 7469 6d75 6c75  =client, stimulu
-00027ba0: 735f 6964 3d73 7469 6d75 6c75 735f 6964  s_id=stimulus_id
-00027bb0: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
-00027bc0: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
-00027bd0: 656c 662e 6973 5f69 646c 6520 616e 6420  elf.is_idle and 
-00027be0: 7365 6c66 2e63 6f6d 7075 7461 7469 6f6e  self.computation
-00027bf0: 733a 0a20 2020 2020 2020 2020 2020 2023  s:.            #
-00027c00: 2053 7469 6c6c 2077 6f72 6b69 6e67 206f   Still working o
-00027c10: 6e20 736f 6d65 7468 696e 672e 2041 7373  n something. Ass
-00027c20: 6967 6e20 6e65 7720 7461 736b 7320 746f  ign new tasks to
-00027c30: 2073 616d 6520 636f 6d70 7574 6174 696f   same computatio
-00027c40: 6e0a 2020 2020 2020 2020 2020 2020 636f  n.            co
-00027c50: 6d70 7574 6174 696f 6e20 3d20 7365 6c66  mputation = self
-00027c60: 2e63 6f6d 7075 7461 7469 6f6e 735b 2d31  .computations[-1
-00027c70: 5d0a 2020 2020 2020 2020 656c 7365 3a0a  ].        else:.
-00027c80: 2020 2020 2020 2020 2020 2020 636f 6d70              comp
-00027c90: 7574 6174 696f 6e20 3d20 436f 6d70 7574  utation = Comput
-00027ca0: 6174 696f 6e28 290a 2020 2020 2020 2020  ation().        
-00027cb0: 2020 2020 7365 6c66 2e63 6f6d 7075 7461      self.computa
-00027cc0: 7469 6f6e 732e 6170 7065 6e64 2863 6f6d  tions.append(com
-00027cd0: 7075 7461 7469 6f6e 290a 0a20 2020 2020  putation)..     
-00027ce0: 2020 2069 6620 636f 6465 3a20 2023 2061     if code:  # a
-00027cf0: 6464 206e 6577 2063 6f64 6520 626c 6f63  dd new code bloc
-00027d00: 6b73 0a20 2020 2020 2020 2020 2020 2063  ks.            c
-00027d10: 6f6d 7075 7461 7469 6f6e 2e63 6f64 652e  omputation.code.
-00027d20: 6164 6428 636f 6465 290a 2020 2020 2020  add(code).      
-00027d30: 2020 6966 2067 6c6f 6261 6c5f 616e 6e6f    if global_anno
-00027d40: 7461 7469 6f6e 733a 0a20 2020 2020 2020  tations:.       
-00027d50: 2020 2020 2023 2046 4958 4d45 3a20 5468       # FIXME: Th
-00027d60: 6973 2069 7320 6b69 6e64 206f 6620 696e  is is kind of in
-00027d70: 636f 6e73 6973 7465 6e74 2073 696e 6365  consistent since
-00027d80: 2069 7420 6f6e 6c79 2069 6e63 6c75 6465   it only include
-00027d90: 7320 676c 6f62 616c 0a20 2020 2020 2020  s global.       
-00027da0: 2020 2020 2023 2061 6e6e 6f74 6174 696f       # annotatio
-00027db0: 6e73 2e0a 2020 2020 2020 2020 2020 2020  ns..            
-00027dc0: 636f 6d70 7574 6174 696f 6e2e 616e 6e6f  computation.anno
-00027dd0: 7461 7469 6f6e 732e 7570 6461 7465 2867  tations.update(g
-00027de0: 6c6f 6261 6c5f 616e 6e6f 7461 7469 6f6e  lobal_annotation
-00027df0: 7329 0a20 2020 2020 2020 2064 656c 2067  s).        del g
-00027e00: 6c6f 6261 6c5f 616e 6e6f 7461 7469 6f6e  lobal_annotation
-00027e10: 730a 0a20 2020 2020 2020 2072 756e 6e61  s..        runna
-00027e20: 626c 652c 2074 6f75 6368 6564 5f74 6173  ble, touched_tas
-00027e30: 6b73 2c20 6e65 775f 7461 736b 7320 3d20  ks, new_tasks = 
-00027e40: 7365 6c66 2e5f 6765 6e65 7261 7465 5f74  self._generate_t
-00027e50: 6173 6b73 7461 7465 7328 0a20 2020 2020  askstates(.     
-00027e60: 2020 2020 2020 206b 6579 733d 6b65 7973         keys=keys
-00027e70: 2c0a 2020 2020 2020 2020 2020 2020 6473  ,.            ds
-00027e80: 6b3d 6473 6b2c 0a20 2020 2020 2020 2020  k=dsk,.         
-00027e90: 2020 2064 6570 656e 6465 6e63 6965 733d     dependencies=
-00027ea0: 6465 7065 6e64 656e 6369 6573 2c0a 2020  dependencies,.  
-00027eb0: 2020 2020 2020 2020 2020 636f 6d70 7574            comput
-00027ec0: 6174 696f 6e3d 636f 6d70 7574 6174 696f  ation=computatio
-00027ed0: 6e2c 0a20 2020 2020 2020 2029 0a0a 2020  n,.        )..  
-00027ee0: 2020 2020 2020 6b65 7973 5f77 6974 685f        keys_with_
-00027ef0: 616e 6e6f 7461 7469 6f6e 7320 3d20 7365  annotations = se
-00027f00: 6c66 2e5f 6170 706c 795f 616e 6e6f 7461  lf._apply_annota
-00027f10: 7469 6f6e 7328 0a20 2020 2020 2020 2020  tions(.         
-00027f20: 2020 2074 6173 6b73 3d6e 6577 5f74 6173     tasks=new_tas
-00027f30: 6b73 2c0a 2020 2020 2020 2020 2020 2020  ks,.            
-00027f40: 616e 6e6f 7461 7469 6f6e 735f 6279 5f74  annotations_by_t
-00027f50: 7970 653d 616e 6e6f 7461 7469 6f6e 735f  ype=annotations_
-00027f60: 6279 5f74 7970 652c 0a20 2020 2020 2020  by_type,.       
-00027f70: 2029 0a0a 2020 2020 2020 2020 7365 6c66   )..        self
-00027f80: 2e5f 7365 745f 7072 696f 7269 7469 6573  ._set_priorities
-00027f90: 280a 2020 2020 2020 2020 2020 2020 696e  (.            in
-00027fa0: 7465 726e 616c 5f70 7269 6f72 6974 793d  ternal_priority=
-00027fb0: 6f72 6465 7265 642c 0a20 2020 2020 2020  ordered,.       
-00027fc0: 2020 2020 2073 7562 6d69 7474 696e 675f       submitting_
-00027fd0: 7461 736b 3d73 7562 6d69 7474 696e 675f  task=submitting_
-00027fe0: 7461 736b 2c0a 2020 2020 2020 2020 2020  task,.          
-00027ff0: 2020 7573 6572 5f70 7269 6f72 6974 793d    user_priority=
-00028000: 7573 6572 5f70 7269 6f72 6974 792c 0a20  user_priority,. 
-00028010: 2020 2020 2020 2020 2020 2066 6966 6f5f             fifo_
-00028020: 7469 6d65 6f75 743d 6669 666f 5f74 696d  timeout=fifo_tim
-00028030: 656f 7574 2c0a 2020 2020 2020 2020 2020  eout,.          
-00028040: 2020 7374 6172 743d 7374 6172 742c 0a20    start=start,. 
-00028050: 2020 2020 2020 2020 2020 2074 6173 6b73             tasks
-00028060: 3d72 756e 6e61 626c 652c 0a20 2020 2020  =runnable,.     
-00028070: 2020 2029 0a0a 2020 2020 2020 2020 7365     )..        se
-00028080: 6c66 2e63 6c69 656e 745f 6465 7369 7265  lf.client_desire
-00028090: 735f 6b65 7973 286b 6579 733d 6b65 7973  s_keys(keys=keys
-000280a0: 2c20 636c 6965 6e74 3d63 6c69 656e 7429  , client=client)
-000280b0: 0a0a 2020 2020 2020 2020 2320 4164 6420  ..        # Add 
-000280c0: 6163 746f 7273 0a20 2020 2020 2020 2069  actors.        i
-000280d0: 6620 6163 746f 7273 2069 7320 5472 7565  f actors is True
-000280e0: 3a0a 2020 2020 2020 2020 2020 2020 6163  :.            ac
-000280f0: 746f 7273 203d 206c 6973 7428 6b65 7973  tors = list(keys
-00028100: 290a 2020 2020 2020 2020 666f 7220 6163  ).        for ac
-00028110: 746f 7220 696e 2061 6374 6f72 7320 6f72  tor in actors or
-00028120: 205b 5d3a 0a20 2020 2020 2020 2020 2020   []:.           
-00028130: 2074 7320 3d20 7365 6c66 2e74 6173 6b73   ts = self.tasks
-00028140: 5b61 6374 6f72 5d0a 2020 2020 2020 2020  [actor].        
-00028150: 2020 2020 7473 2e61 6374 6f72 203d 2054      ts.actor = T
-00028160: 7275 650a 0a20 2020 2020 2020 2023 2043  rue..        # C
-00028170: 6f6d 7075 7465 2072 6563 6f6d 6d65 6e64  ompute recommend
-00028180: 6174 696f 6e73 0a20 2020 2020 2020 2072  ations.        r
-00028190: 6563 6f6d 6d65 6e64 6174 696f 6e73 3a20  ecommendations: 
-000281a0: 5265 6373 203d 207b 7d0a 2020 2020 2020  Recs = {}.      
-000281b0: 2020 7072 696f 7269 7479 203d 2064 6963    priority = dic
-000281c0: 7428 290a 2020 2020 2020 2020 666f 7220  t().        for 
-000281d0: 7473 2069 6e20 736f 7274 6564 280a 2020  ts in sorted(.  
-000281e0: 2020 2020 2020 2020 2020 7275 6e6e 6162            runnab
-000281f0: 6c65 2c0a 2020 2020 2020 2020 2020 2020  le,.            
-00028200: 6b65 793d 6f70 6572 6174 6f72 2e61 7474  key=operator.att
-00028210: 7267 6574 7465 7228 2270 7269 6f72 6974  rgetter("priorit
-00028220: 7922 292c 0a20 2020 2020 2020 2020 2020  y"),.           
-00028230: 2072 6576 6572 7365 3d54 7275 652c 0a20   reverse=True,. 
-00028240: 2020 2020 2020 2029 3a0a 2020 2020 2020         ):.      
-00028250: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
-00028260: 7072 696f 7269 7479 2020 2320 6d79 7079  priority  # mypy
-00028270: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-00028280: 6f72 6974 795b 7473 2e6b 6579 5d20 3d20  ority[ts.key] = 
-00028290: 7473 2e70 7269 6f72 6974 790a 2020 2020  ts.priority.    
-000282a0: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
-000282b0: 732e 7275 6e5f 7370 6563 0a20 2020 2020  s.run_spec.     
-000282c0: 2020 2020 2020 2069 6620 7473 2e73 7461         if ts.sta
-000282d0: 7465 203d 3d20 2272 656c 6561 7365 6422  te == "released"
-000282e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000282f0: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
-00028300: 735b 7473 2e6b 6579 5d20 3d20 2277 6169  s[ts.key] = "wai
-00028310: 7469 6e67 220a 0a20 2020 2020 2020 2066  ting"..        f
-00028320: 6f72 2074 7320 696e 2072 756e 6e61 626c  or ts in runnabl
-00028330: 653a 0a20 2020 2020 2020 2020 2020 2066  e:.            f
-00028340: 6f72 2064 7473 2069 6e20 7473 2e64 6570  or dts in ts.dep
-00028350: 656e 6465 6e63 6965 733a 0a20 2020 2020  endencies:.     
-00028360: 2020 2020 2020 2020 2020 2069 6620 6474             if dt
-00028370: 732e 6578 6365 7074 696f 6e5f 626c 616d  s.exception_blam
-00028380: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00028390: 2020 2020 2020 2074 732e 6578 6365 7074         ts.except
-000283a0: 696f 6e5f 626c 616d 6520 3d20 6474 732e  ion_blame = dts.
-000283b0: 6578 6365 7074 696f 6e5f 626c 616d 650a  exception_blame.
-000283c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000283d0: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
-000283e0: 6f6e 735b 7473 2e6b 6579 5d20 3d20 2265  ons[ts.key] = "e
-000283f0: 7272 6564 220a 2020 2020 2020 2020 2020  rred".          
-00028400: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
-00028410: 0a20 2020 2020 2020 2061 6e6e 6f74 6174  .        annotat
-00028420: 696f 6e73 5f66 6f72 5f70 6c75 6769 6e3a  ions_for_plugin:
-00028430: 2064 6566 6175 6c74 6469 6374 5b73 7472   defaultdict[str
-00028440: 2c20 6469 6374 5b4b 6579 2c20 416e 795d  , dict[Key, Any]
-00028450: 5d20 3d20 6465 6661 756c 7464 6963 7428  ] = defaultdict(
-00028460: 6469 6374 290a 2020 2020 2020 2020 666f  dict).        fo
-00028470: 7220 6b65 7920 696e 206b 6579 735f 7769  r key in keys_wi
-00028480: 7468 5f61 6e6e 6f74 6174 696f 6e73 3a0a  th_annotations:.
-00028490: 2020 2020 2020 2020 2020 2020 7473 203d              ts =
-000284a0: 2073 656c 662e 7461 736b 735b 6b65 795d   self.tasks[key]
-000284b0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000284c0: 7473 2e61 6e6e 6f74 6174 696f 6e73 3a0a  ts.annotations:.
-000284d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000284e0: 666f 7220 616e 6e6f 742c 2076 616c 7565  for annot, value
-000284f0: 2069 6e20 7473 2e61 6e6e 6f74 6174 696f   in ts.annotatio
-00028500: 6e73 2e69 7465 6d73 2829 3a0a 2020 2020  ns.items():.    
-00028510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028520: 616e 6e6f 7461 7469 6f6e 735f 666f 725f  annotations_for_
-00028530: 706c 7567 696e 5b61 6e6e 6f74 5d5b 6b65  plugin[annot][ke
-00028540: 795d 203d 2076 616c 7565 0a0a 2020 2020  y] = value..    
-00028550: 2020 2020 7370 616e 735f 6578 743a 2053      spans_ext: S
-00028560: 7061 6e73 5363 6865 6475 6c65 7245 7874  pansSchedulerExt
-00028570: 656e 7369 6f6e 207c 204e 6f6e 6520 3d20  ension | None = 
-00028580: 7365 6c66 2e65 7874 656e 7369 6f6e 732e  self.extensions.
-00028590: 6765 7428 2273 7061 6e73 2229 0a20 2020  get("spans").   
-000285a0: 2020 2020 2069 6620 7370 616e 735f 6578       if spans_ex
-000285b0: 743a 0a20 2020 2020 2020 2020 2020 2023  t:.            #
-000285c0: 206e 6577 5f74 6173 6b73 2064 6f65 7320   new_tasks does 
-000285d0: 6e6f 7420 6e65 6365 7373 6172 696c 7920  not necessarily 
-000285e0: 636f 6e74 6169 6e20 616c 6c20 7275 6e6e  contain all runn
-000285f0: 6162 6c65 2074 6173 6b73 3b0a 2020 2020  able tasks;.    
-00028600: 2020 2020 2020 2020 2320 5f67 656e 6572          # _gener
-00028610: 6174 655f 7461 736b 7374 6174 6573 2069  ate_taskstates i
-00028620: 7320 6e6f 7420 7468 6520 6f6e 6c79 2074  s not the only t
-00028630: 6869 6e67 2074 6861 7420 6361 6c6c 7320  hing that calls 
-00028640: 6e65 775f 7461 736b 2829 2e20 410a 2020  new_task(). A.  
-00028650: 2020 2020 2020 2020 2020 2320 5461 736b            # Task
-00028660: 5374 6174 6520 6d61 7920 6861 7665 2061  State may have a
-00028670: 6c73 6f20 6265 656e 2063 7265 6174 6564  lso been created
-00028680: 2062 7920 636c 6965 6e74 5f64 6573 6972   by client_desir
-00028690: 6573 5f6b 6579 7320 6f72 2073 6361 7474  es_keys or scatt
-000286a0: 6572 2c0a 2020 2020 2020 2020 2020 2020  er,.            
-000286b0: 2320 616e 6420 6f6e 6c79 206c 6174 6572  # and only later
-000286c0: 2067 6169 6e65 6420 6120 7275 6e5f 7370   gained a run_sp
-000286d0: 6563 2e0a 2020 2020 2020 2020 2020 2020  ec..            
-000286e0: 7370 616e 5f61 6e6e 6f74 6174 696f 6e73  span_annotations
-000286f0: 203d 2073 7061 6e73 5f65 7874 2e6f 6273   = spans_ext.obs
-00028700: 6572 7665 5f74 6173 6b73 2872 756e 6e61  erve_tasks(runna
-00028710: 626c 652c 2063 6f64 653d 636f 6465 290a  ble, code=code).
-00028720: 2020 2020 2020 2020 2020 2020 2320 496e              # In
-00028730: 2063 6173 6520 6f66 2054 6173 6b47 726f   case of TaskGro
-00028740: 7570 2063 6f6c 6c69 7369 6f6e 2c20 7370  up collision, sp
-00028750: 616e 7320 6d61 7920 6861 7665 2063 6861  ans may have cha
-00028760: 6e67 6564 0a20 2020 2020 2020 2020 2020  nged.           
-00028770: 2023 2046 4958 4d45 3a20 4973 2074 6869   # FIXME: Is thi
-00028780: 7320 7573 6564 2061 6e79 7768 6572 6520  s used anywhere 
-00028790: 6265 7369 6465 7320 7465 7374 733f 0a20  besides tests?. 
-000287a0: 2020 2020 2020 2020 2020 2069 6620 7370             if sp
-000287b0: 616e 5f61 6e6e 6f74 6174 696f 6e73 3a0a  an_annotations:.
-000287c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000287d0: 616e 6e6f 7461 7469 6f6e 735f 666f 725f  annotations_for_
-000287e0: 706c 7567 696e 5b22 7370 616e 225d 203d  plugin["span"] =
-000287f0: 2073 7061 6e5f 616e 6e6f 7461 7469 6f6e   span_annotation
-00028800: 730a 2020 2020 2020 2020 2020 2020 656c  s.            el
-00028810: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00028820: 2020 2020 616e 6e6f 7461 7469 6f6e 735f      annotations_
-00028830: 666f 725f 706c 7567 696e 2e70 6f70 2822  for_plugin.pop("
-00028840: 7370 616e 222c 204e 6f6e 6529 0a0a 2020  span", None)..  
-00028850: 2020 2020 2020 666f 7220 706c 7567 696e        for plugin
-00028860: 2069 6e20 6c69 7374 2873 656c 662e 706c   in list(self.pl
-00028870: 7567 696e 732e 7661 6c75 6573 2829 293a  ugins.values()):
-00028880: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
-00028890: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000288a0: 2020 706c 7567 696e 2e75 7064 6174 655f    plugin.update_
-000288b0: 6772 6170 6828 0a20 2020 2020 2020 2020  graph(.         
-000288c0: 2020 2020 2020 2020 2020 2073 656c 662c             self,
-000288d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000288e0: 2020 2020 2063 6c69 656e 743d 636c 6965       client=clie
-000288f0: 6e74 2c0a 2020 2020 2020 2020 2020 2020  nt,.            
-00028900: 2020 2020 2020 2020 7461 736b 733d 5b74          tasks=[t
-00028910: 732e 6b65 7920 666f 7220 7473 2069 6e20  s.key for ts in 
-00028920: 746f 7563 6865 645f 7461 736b 735d 2c0a  touched_tasks],.
-00028930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028940: 2020 2020 6b65 7973 3d6b 6579 732c 0a20      keys=keys,. 
-00028950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028960: 2020 2064 6570 656e 6465 6e63 6965 733d     dependencies=
-00028970: 6465 7065 6e64 656e 6369 6573 2c0a 2020  dependencies,.  
-00028980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028990: 2020 616e 6e6f 7461 7469 6f6e 733d 6469    annotations=di
-000289a0: 6374 2861 6e6e 6f74 6174 696f 6e73 5f66  ct(annotations_f
-000289b0: 6f72 5f70 6c75 6769 6e29 2c0a 2020 2020  or_plugin),.    
+00020640: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00020650: 2020 2020 2020 2020 6a2e 696e 6974 6961          j.initia
+00020660: 6c69 7a65 280a 2020 2020 2020 2020 2020  lize(.          
+00020670: 2020 2020 2020 6e65 775f 6874 7470 7365        new_httpse
+00020680: 7276 6572 3d46 616c 7365 2c0a 2020 2020  rver=False,.    
+00020690: 2020 2020 2020 2020 2020 2020 6172 6776              argv
+000206a0: 3d5b 5d2c 0a20 2020 2020 2020 2020 2020  =[],.           
+000206b0: 2029 0a20 2020 2020 2020 2020 2020 2073   ).            s
+000206c0: 656c 662e 5f6a 7570 7974 6572 5f73 6572  elf._jupyter_ser
+000206d0: 7665 725f 6170 706c 6963 6174 696f 6e20  ver_application 
+000206e0: 3d20 6a0a 2020 2020 2020 2020 2020 2020  = j.            
+000206f0: 7368 7574 646f 776e 5f61 7070 203d 2074  shutdown_app = t
+00020700: 6f72 6e61 646f 2e77 6562 2e41 7070 6c69  ornado.web.Appli
+00020710: 6361 7469 6f6e 280a 2020 2020 2020 2020  cation(.        
+00020720: 2020 2020 2020 2020 5b28 7222 2f6a 7570          [(r"/jup
+00020730: 7974 6572 2f61 7069 2f73 6875 7464 6f77  yter/api/shutdow
+00020740: 6e22 2c20 5368 7574 646f 776e 4861 6e64  n", ShutdownHand
+00020750: 6c65 7229 5d0a 2020 2020 2020 2020 2020  ler)].          
+00020760: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00020770: 7368 7574 646f 776e 5f61 7070 2e73 6574  shutdown_app.set
+00020780: 7469 6e67 7320 3d20 6a2e 7765 625f 6170  tings = j.web_ap
+00020790: 702e 7365 7474 696e 6773 0a20 2020 2020  p.settings.     
+000207a0: 2020 2020 2020 2073 656c 662e 6874 7470         self.http
+000207b0: 5f61 7070 6c69 6361 7469 6f6e 2e61 6464  _application.add
+000207c0: 5f61 7070 6c69 6361 7469 6f6e 2873 6875  _application(shu
+000207d0: 7464 6f77 6e5f 6170 7029 0a20 2020 2020  tdown_app).     
+000207e0: 2020 2020 2020 2073 656c 662e 6874 7470         self.http
+000207f0: 5f61 7070 6c69 6361 7469 6f6e 2e61 6464  _application.add
+00020800: 5f61 7070 6c69 6361 7469 6f6e 286a 2e77  _application(j.w
+00020810: 6562 5f61 7070 290a 0a20 2020 2020 2020  eb_app)..       
+00020820: 2023 2043 6f6d 6d75 6e69 6361 7469 6f6e   # Communication
+00020830: 2073 7461 7465 0a20 2020 2020 2020 2073   state.        s
+00020840: 656c 662e 636c 6965 6e74 5f63 6f6d 6d73  elf.client_comms
+00020850: 203d 207b 7d0a 2020 2020 2020 2020 7365   = {}.        se
+00020860: 6c66 2e73 7472 6561 6d5f 636f 6d6d 7320  lf.stream_comms 
+00020870: 3d20 7b7d 0a0a 2020 2020 2020 2020 2320  = {}..        # 
+00020880: 5461 736b 2073 7461 7465 0a20 2020 2020  Task state.     
+00020890: 2020 2074 6173 6b73 203d 207b 7d0a 0a20     tasks = {}.. 
+000208a0: 2020 2020 2020 2073 656c 662e 6765 6e65         self.gene
+000208b0: 7261 7469 6f6e 203d 2030 0a20 2020 2020  ration = 0.     
+000208c0: 2020 2073 656c 662e 5f6c 6173 745f 636c     self._last_cl
+000208d0: 6965 6e74 203d 204e 6f6e 650a 2020 2020  ient = None.    
+000208e0: 2020 2020 7365 6c66 2e5f 6c61 7374 5f74      self._last_t
+000208f0: 696d 6520 3d20 300a 2020 2020 2020 2020  ime = 0.        
+00020900: 756e 7275 6e6e 6162 6c65 203d 2073 6574  unrunnable = set
+00020910: 2829 0a20 2020 2020 2020 2071 7565 7565  ().        queue
+00020920: 6420 3d20 4865 6170 5365 7428 6b65 793d  d = HeapSet(key=
+00020930: 6f70 6572 6174 6f72 2e61 7474 7267 6574  operator.attrget
+00020940: 7465 7228 2270 7269 6f72 6974 7922 2929  ter("priority"))
+00020950: 0a0a 2020 2020 2020 2020 7365 6c66 2e64  ..        self.d
+00020960: 6174 6173 6574 7320 3d20 7b7d 0a0a 2020  atasets = {}..  
+00020970: 2020 2020 2020 2320 5072 6566 6978 2d6b        # Prefix-k
+00020980: 6579 6564 2063 6f6e 7461 696e 6572 730a  eyed containers.
+00020990: 0a20 2020 2020 2020 2023 2043 6c69 656e  .        # Clien
+000209a0: 7420 7374 6174 650a 2020 2020 2020 2020  t state.        
+000209b0: 636c 6965 6e74 7320 3d20 7b7d 0a0a 2020  clients = {}..  
+000209c0: 2020 2020 2020 2320 576f 726b 6572 2073        # Worker s
+000209d0: 7461 7465 0a20 2020 2020 2020 2077 6f72  tate.        wor
+000209e0: 6b65 7273 203d 2053 6f72 7465 6444 6963  kers = SortedDic
+000209f0: 7428 290a 0a20 2020 2020 2020 2068 6f73  t()..        hos
+00020a00: 745f 696e 666f 203d 207b 7d0a 2020 2020  t_info = {}.    
+00020a10: 2020 2020 7265 736f 7572 6365 7320 3d20      resources = 
+00020a20: 7b7d 0a20 2020 2020 2020 2061 6c69 6173  {}.        alias
+00020a30: 6573 203d 207b 7d0a 0a20 2020 2020 2020  es = {}..       
+00020a40: 2073 656c 662e 5f77 6f72 6b65 725f 636f   self._worker_co
+00020a50: 6c6c 6563 7469 6f6e 7320 3d20 5b0a 2020  llections = [.  
+00020a60: 2020 2020 2020 2020 2020 776f 726b 6572            worker
+00020a70: 732c 0a20 2020 2020 2020 2020 2020 2068  s,.            h
+00020a80: 6f73 745f 696e 666f 2c0a 2020 2020 2020  ost_info,.      
+00020a90: 2020 2020 2020 7265 736f 7572 6365 732c        resources,
+00020aa0: 0a20 2020 2020 2020 2020 2020 2061 6c69  .            ali
+00020ab0: 6173 6573 2c0a 2020 2020 2020 2020 5d0a  ases,.        ].
+00020ac0: 0a20 2020 2020 2020 206d 6178 6c65 6e20  .        maxlen 
+00020ad0: 3d20 6461 736b 2e63 6f6e 6669 672e 6765  = dask.config.ge
+00020ae0: 7428 2264 6973 7472 6962 7574 6564 2e61  t("distributed.a
+00020af0: 646d 696e 2e6c 6f77 2d6c 6576 656c 2d6c  dmin.low-level-l
+00020b00: 6f67 2d6c 656e 6774 6822 290a 2020 2020  og-length").    
+00020b10: 2020 2020 7365 6c66 2e65 7665 6e74 7320      self.events 
+00020b20: 3d20 6465 6661 756c 7464 6963 7428 7061  = defaultdict(pa
+00020b30: 7274 6961 6c28 6465 7175 652c 206d 6178  rtial(deque, max
+00020b40: 6c65 6e3d 6d61 786c 656e 2929 0a20 2020  len=maxlen)).   
+00020b50: 2020 2020 2073 656c 662e 6576 656e 745f       self.event_
+00020b60: 636f 756e 7473 203d 2064 6566 6175 6c74  counts = default
+00020b70: 6469 6374 2869 6e74 290a 2020 2020 2020  dict(int).      
+00020b80: 2020 7365 6c66 2e65 7665 6e74 5f73 7562    self.event_sub
+00020b90: 7363 7269 6265 7220 3d20 6465 6661 756c  scriber = defaul
+00020ba0: 7464 6963 7428 7365 7429 0a20 2020 2020  tdict(set).     
+00020bb0: 2020 2073 656c 662e 776f 726b 6572 5f70     self.worker_p
+00020bc0: 6c75 6769 6e73 203d 207b 7d0a 2020 2020  lugins = {}.    
+00020bd0: 2020 2020 7365 6c66 2e6e 616e 6e79 5f70      self.nanny_p
+00020be0: 6c75 6769 6e73 203d 207b 7d0a 2020 2020  lugins = {}.    
+00020bf0: 2020 2020 7365 6c66 2e5f 7374 6172 7469      self._starti
+00020c00: 6e67 5f6e 616e 6e69 6573 203d 2073 6574  ng_nannies = set
+00020c10: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
+00020c20: 5f73 7461 7274 696e 675f 6e61 6e6e 6965  _starting_nannie
+00020c30: 735f 636f 6e64 203d 2061 7379 6e63 696f  s_cond = asyncio
+00020c40: 2e43 6f6e 6469 7469 6f6e 2829 0a0a 2020  .Condition()..  
+00020c50: 2020 2020 2020 776f 726b 6572 5f68 616e        worker_han
+00020c60: 646c 6572 7320 3d20 7b0a 2020 2020 2020  dlers = {.      
+00020c70: 2020 2020 2020 2274 6173 6b2d 6669 6e69        "task-fini
+00020c80: 7368 6564 223a 2073 656c 662e 6861 6e64  shed": self.hand
+00020c90: 6c65 5f74 6173 6b5f 6669 6e69 7368 6564  le_task_finished
+00020ca0: 2c0a 2020 2020 2020 2020 2020 2020 2274  ,.            "t
+00020cb0: 6173 6b2d 6572 7265 6422 3a20 7365 6c66  ask-erred": self
+00020cc0: 2e68 616e 646c 655f 7461 736b 5f65 7272  .handle_task_err
+00020cd0: 6564 2c0a 2020 2020 2020 2020 2020 2020  ed,.            
+00020ce0: 2272 656c 6561 7365 2d77 6f72 6b65 722d  "release-worker-
+00020cf0: 6461 7461 223a 2073 656c 662e 7265 6c65  data": self.rele
+00020d00: 6173 655f 776f 726b 6572 5f64 6174 612c  ase_worker_data,
+00020d10: 0a20 2020 2020 2020 2020 2020 2022 6164  .            "ad
+00020d20: 642d 6b65 7973 223a 2073 656c 662e 6164  d-keys": self.ad
+00020d30: 645f 6b65 7973 2c0a 2020 2020 2020 2020  d_keys,.        
+00020d40: 2020 2020 226c 6f6e 672d 7275 6e6e 696e      "long-runnin
+00020d50: 6722 3a20 7365 6c66 2e68 616e 646c 655f  g": self.handle_
+00020d60: 6c6f 6e67 5f72 756e 6e69 6e67 2c0a 2020  long_running,.  
+00020d70: 2020 2020 2020 2020 2020 2272 6573 6368            "resch
+00020d80: 6564 756c 6522 3a20 7365 6c66 2e5f 7265  edule": self._re
+00020d90: 7363 6865 6475 6c65 2c0a 2020 2020 2020  schedule,.      
+00020da0: 2020 2020 2020 226b 6565 702d 616c 6976        "keep-aliv
+00020db0: 6522 3a20 6c61 6d62 6461 202a 6172 6773  e": lambda *args
+00020dc0: 2c20 2a2a 6b77 6172 6773 3a20 4e6f 6e65  , **kwargs: None
+00020dd0: 2c0a 2020 2020 2020 2020 2020 2020 226c  ,.            "l
+00020de0: 6f67 2d65 7665 6e74 223a 2073 656c 662e  og-event": self.
+00020df0: 6c6f 675f 776f 726b 6572 5f65 7665 6e74  log_worker_event
+00020e00: 2c0a 2020 2020 2020 2020 2020 2020 2277  ,.            "w
+00020e10: 6f72 6b65 722d 7374 6174 7573 2d63 6861  orker-status-cha
+00020e20: 6e67 6522 3a20 7365 6c66 2e68 616e 646c  nge": self.handl
+00020e30: 655f 776f 726b 6572 5f73 7461 7475 735f  e_worker_status_
+00020e40: 6368 616e 6765 2c0a 2020 2020 2020 2020  change,.        
+00020e50: 2020 2020 2272 6571 7565 7374 2d72 6566      "request-ref
+00020e60: 7265 7368 2d77 686f 2d68 6173 223a 2073  resh-who-has": s
+00020e70: 656c 662e 6861 6e64 6c65 5f72 6571 7565  elf.handle_reque
+00020e80: 7374 5f72 6566 7265 7368 5f77 686f 5f68  st_refresh_who_h
+00020e90: 6173 2c0a 2020 2020 2020 2020 7d0a 0a20  as,.        }.. 
+00020ea0: 2020 2020 2020 2063 6c69 656e 745f 6861         client_ha
+00020eb0: 6e64 6c65 7273 203d 207b 0a20 2020 2020  ndlers = {.     
+00020ec0: 2020 2020 2020 2022 7570 6461 7465 2d67         "update-g
+00020ed0: 7261 7068 223a 2073 656c 662e 7570 6461  raph": self.upda
+00020ee0: 7465 5f67 7261 7068 2c0a 2020 2020 2020  te_graph,.      
+00020ef0: 2020 2020 2020 2263 6c69 656e 742d 6465        "client-de
+00020f00: 7369 7265 732d 6b65 7973 223a 2073 656c  sires-keys": sel
+00020f10: 662e 636c 6965 6e74 5f64 6573 6972 6573  f.client_desires
+00020f20: 5f6b 6579 732c 0a20 2020 2020 2020 2020  _keys,.         
+00020f30: 2020 2022 7570 6461 7465 2d64 6174 6122     "update-data"
+00020f40: 3a20 7365 6c66 2e75 7064 6174 655f 6461  : self.update_da
+00020f50: 7461 2c0a 2020 2020 2020 2020 2020 2020  ta,.            
+00020f60: 2272 6570 6f72 742d 6b65 7922 3a20 7365  "report-key": se
+00020f70: 6c66 2e72 6570 6f72 745f 6f6e 5f6b 6579  lf.report_on_key
+00020f80: 2c0a 2020 2020 2020 2020 2020 2020 2263  ,.            "c
+00020f90: 6c69 656e 742d 7265 6c65 6173 6573 2d6b  lient-releases-k
+00020fa0: 6579 7322 3a20 7365 6c66 2e63 6c69 656e  eys": self.clien
+00020fb0: 745f 7265 6c65 6173 6573 5f6b 6579 732c  t_releases_keys,
+00020fc0: 0a20 2020 2020 2020 2020 2020 2022 6865  .            "he
+00020fd0: 6172 7462 6561 742d 636c 6965 6e74 223a  artbeat-client":
+00020fe0: 2073 656c 662e 636c 6965 6e74 5f68 6561   self.client_hea
+00020ff0: 7274 6265 6174 2c0a 2020 2020 2020 2020  rtbeat,.        
+00021000: 2020 2020 2263 6c6f 7365 2d63 6c69 656e      "close-clien
+00021010: 7422 3a20 7365 6c66 2e72 656d 6f76 655f  t": self.remove_
+00021020: 636c 6965 6e74 2c0a 2020 2020 2020 2020  client,.        
+00021030: 2020 2020 2273 7562 7363 7269 6265 2d74      "subscribe-t
+00021040: 6f70 6963 223a 2073 656c 662e 7375 6273  opic": self.subs
+00021050: 6372 6962 655f 746f 7069 632c 0a20 2020  cribe_topic,.   
+00021060: 2020 2020 2020 2020 2022 756e 7375 6273           "unsubs
+00021070: 6372 6962 652d 746f 7069 6322 3a20 7365  cribe-topic": se
+00021080: 6c66 2e75 6e73 7562 7363 7269 6265 5f74  lf.unsubscribe_t
+00021090: 6f70 6963 2c0a 2020 2020 2020 2020 2020  opic,.          
+000210a0: 2020 2263 616e 6365 6c2d 6b65 7973 223a    "cancel-keys":
+000210b0: 2073 656c 662e 7374 696d 756c 7573 5f63   self.stimulus_c
+000210c0: 616e 6365 6c2c 0a20 2020 2020 2020 207d  ancel,.        }
+000210d0: 0a0a 2020 2020 2020 2020 7365 6c66 2e68  ..        self.h
+000210e0: 616e 646c 6572 7320 3d20 7b0a 2020 2020  andlers = {.    
+000210f0: 2020 2020 2020 2020 2272 6567 6973 7465          "registe
+00021100: 722d 636c 6965 6e74 223a 2073 656c 662e  r-client": self.
+00021110: 6164 645f 636c 6965 6e74 2c0a 2020 2020  add_client,.    
+00021120: 2020 2020 2020 2020 2273 6361 7474 6572          "scatter
+00021130: 223a 2073 656c 662e 7363 6174 7465 722c  ": self.scatter,
+00021140: 0a20 2020 2020 2020 2020 2020 2022 7265  .            "re
+00021150: 6769 7374 6572 2d77 6f72 6b65 7222 3a20  gister-worker": 
+00021160: 7365 6c66 2e61 6464 5f77 6f72 6b65 722c  self.add_worker,
+00021170: 0a20 2020 2020 2020 2020 2020 2022 7265  .            "re
+00021180: 6769 7374 6572 5f6e 616e 6e79 223a 2073  gister_nanny": s
+00021190: 656c 662e 6164 645f 6e61 6e6e 792c 0a20  elf.add_nanny,. 
+000211a0: 2020 2020 2020 2020 2020 2022 756e 7265             "unre
+000211b0: 6769 7374 6572 223a 2073 656c 662e 7265  gister": self.re
+000211c0: 6d6f 7665 5f77 6f72 6b65 722c 0a20 2020  move_worker,.   
+000211d0: 2020 2020 2020 2020 2022 6761 7468 6572           "gather
+000211e0: 223a 2073 656c 662e 6761 7468 6572 2c0a  ": self.gather,.
+000211f0: 2020 2020 2020 2020 2020 2020 2272 6574              "ret
+00021200: 7279 223a 2073 656c 662e 7374 696d 756c  ry": self.stimul
+00021210: 7573 5f72 6574 7279 2c0a 2020 2020 2020  us_retry,.      
+00021220: 2020 2020 2020 2266 6565 6422 3a20 7365        "feed": se
+00021230: 6c66 2e66 6565 642c 0a20 2020 2020 2020  lf.feed,.       
+00021240: 2020 2020 2022 7465 726d 696e 6174 6522       "terminate"
+00021250: 3a20 7365 6c66 2e63 6c6f 7365 2c0a 2020  : self.close,.  
+00021260: 2020 2020 2020 2020 2020 2262 726f 6164            "broad
+00021270: 6361 7374 223a 2073 656c 662e 6272 6f61  cast": self.broa
+00021280: 6463 6173 742c 0a20 2020 2020 2020 2020  dcast,.         
+00021290: 2020 2022 7072 6f78 7922 3a20 7365 6c66     "proxy": self
+000212a0: 2e70 726f 7879 2c0a 2020 2020 2020 2020  .proxy,.        
+000212b0: 2020 2020 226e 636f 7265 7322 3a20 7365      "ncores": se
+000212c0: 6c66 2e67 6574 5f6e 636f 7265 732c 0a20  lf.get_ncores,. 
+000212d0: 2020 2020 2020 2020 2020 2022 6e63 6f72             "ncor
+000212e0: 6573 5f72 756e 6e69 6e67 223a 2073 656c  es_running": sel
+000212f0: 662e 6765 745f 6e63 6f72 6573 5f72 756e  f.get_ncores_run
+00021300: 6e69 6e67 2c0a 2020 2020 2020 2020 2020  ning,.          
+00021310: 2020 2268 6173 5f77 6861 7422 3a20 7365    "has_what": se
+00021320: 6c66 2e67 6574 5f68 6173 5f77 6861 742c  lf.get_has_what,
+00021330: 0a20 2020 2020 2020 2020 2020 2022 7768  .            "wh
+00021340: 6f5f 6861 7322 3a20 7365 6c66 2e67 6574  o_has": self.get
+00021350: 5f77 686f 5f68 6173 2c0a 2020 2020 2020  _who_has,.      
+00021360: 2020 2020 2020 2270 726f 6365 7373 696e        "processin
+00021370: 6722 3a20 7365 6c66 2e67 6574 5f70 726f  g": self.get_pro
+00021380: 6365 7373 696e 672c 0a20 2020 2020 2020  cessing,.       
+00021390: 2020 2020 2022 6361 6c6c 5f73 7461 636b       "call_stack
+000213a0: 223a 2073 656c 662e 6765 745f 6361 6c6c  ": self.get_call
+000213b0: 5f73 7461 636b 2c0a 2020 2020 2020 2020  _stack,.        
+000213c0: 2020 2020 2270 726f 6669 6c65 223a 2073      "profile": s
+000213d0: 656c 662e 6765 745f 7072 6f66 696c 652c  elf.get_profile,
+000213e0: 0a20 2020 2020 2020 2020 2020 2022 7065  .            "pe
+000213f0: 7266 6f72 6d61 6e63 655f 7265 706f 7274  rformance_report
+00021400: 223a 2073 656c 662e 7065 7266 6f72 6d61  ": self.performa
+00021410: 6e63 655f 7265 706f 7274 2c0a 2020 2020  nce_report,.    
+00021420: 2020 2020 2020 2020 2267 6574 5f6c 6f67          "get_log
+00021430: 7322 3a20 7365 6c66 2e67 6574 5f6c 6f67  s": self.get_log
+00021440: 732c 0a20 2020 2020 2020 2020 2020 2022  s,.            "
+00021450: 6c6f 6773 223a 2073 656c 662e 6765 745f  logs": self.get_
+00021460: 6c6f 6773 2c0a 2020 2020 2020 2020 2020  logs,.          
+00021470: 2020 2277 6f72 6b65 725f 6c6f 6773 223a    "worker_logs":
+00021480: 2073 656c 662e 6765 745f 776f 726b 6572   self.get_worker
+00021490: 5f6c 6f67 732c 0a20 2020 2020 2020 2020  _logs,.         
+000214a0: 2020 2022 6c6f 675f 6576 656e 7422 3a20     "log_event": 
+000214b0: 7365 6c66 2e6c 6f67 5f65 7665 6e74 2c0a  self.log_event,.
+000214c0: 2020 2020 2020 2020 2020 2020 2265 7665              "eve
+000214d0: 6e74 7322 3a20 7365 6c66 2e67 6574 5f65  nts": self.get_e
+000214e0: 7665 6e74 732c 0a20 2020 2020 2020 2020  vents,.         
+000214f0: 2020 2022 6e62 7974 6573 223a 2073 656c     "nbytes": sel
+00021500: 662e 6765 745f 6e62 7974 6573 2c0a 2020  f.get_nbytes,.  
+00021510: 2020 2020 2020 2020 2020 2276 6572 7369            "versi
+00021520: 6f6e 7322 3a20 7365 6c66 2e76 6572 7369  ons": self.versi
+00021530: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
+00021540: 2022 6164 645f 6b65 7973 223a 2073 656c   "add_keys": sel
+00021550: 662e 6164 645f 6b65 7973 2c0a 2020 2020  f.add_keys,.    
+00021560: 2020 2020 2020 2020 2272 6562 616c 616e          "rebalan
+00021570: 6365 223a 2073 656c 662e 7265 6261 6c61  ce": self.rebala
+00021580: 6e63 652c 0a20 2020 2020 2020 2020 2020  nce,.           
+00021590: 2022 7265 706c 6963 6174 6522 3a20 7365   "replicate": se
+000215a0: 6c66 2e72 6570 6c69 6361 7465 2c0a 2020  lf.replicate,.  
+000215b0: 2020 2020 2020 2020 2020 2272 756e 5f66            "run_f
+000215c0: 756e 6374 696f 6e22 3a20 7365 6c66 2e72  unction": self.r
+000215d0: 756e 5f66 756e 6374 696f 6e2c 0a20 2020  un_function,.   
+000215e0: 2020 2020 2020 2020 2022 7265 7374 6172           "restar
+000215f0: 7422 3a20 7365 6c66 2e72 6573 7461 7274  t": self.restart
+00021600: 2c0a 2020 2020 2020 2020 2020 2020 2272  ,.            "r
+00021610: 6573 7461 7274 5f77 6f72 6b65 7273 223a  estart_workers":
+00021620: 2073 656c 662e 7265 7374 6172 745f 776f   self.restart_wo
+00021630: 726b 6572 732c 0a20 2020 2020 2020 2020  rkers,.         
+00021640: 2020 2022 7570 6461 7465 5f64 6174 6122     "update_data"
+00021650: 3a20 7365 6c66 2e75 7064 6174 655f 6461  : self.update_da
+00021660: 7461 2c0a 2020 2020 2020 2020 2020 2020  ta,.            
+00021670: 2273 6574 5f72 6573 6f75 7263 6573 223a  "set_resources":
+00021680: 2073 656c 662e 6164 645f 7265 736f 7572   self.add_resour
+00021690: 6365 732c 0a20 2020 2020 2020 2020 2020  ces,.           
+000216a0: 2022 7265 7469 7265 5f77 6f72 6b65 7273   "retire_workers
+000216b0: 223a 2073 656c 662e 7265 7469 7265 5f77  ": self.retire_w
+000216c0: 6f72 6b65 7273 2c0a 2020 2020 2020 2020  orkers,.        
+000216d0: 2020 2020 2267 6574 5f6d 6574 6164 6174      "get_metadat
+000216e0: 6122 3a20 7365 6c66 2e67 6574 5f6d 6574  a": self.get_met
+000216f0: 6164 6174 612c 0a20 2020 2020 2020 2020  adata,.         
+00021700: 2020 2022 7365 745f 6d65 7461 6461 7461     "set_metadata
+00021710: 223a 2073 656c 662e 7365 745f 6d65 7461  ": self.set_meta
+00021720: 6461 7461 2c0a 2020 2020 2020 2020 2020  data,.          
+00021730: 2020 2273 6574 5f72 6573 7472 6963 7469    "set_restricti
+00021740: 6f6e 7322 3a20 7365 6c66 2e73 6574 5f72  ons": self.set_r
+00021750: 6573 7472 6963 7469 6f6e 732c 0a20 2020  estrictions,.   
+00021760: 2020 2020 2020 2020 2022 6865 6172 7462           "heartb
+00021770: 6561 745f 776f 726b 6572 223a 2073 656c  eat_worker": sel
+00021780: 662e 6865 6172 7462 6561 745f 776f 726b  f.heartbeat_work
+00021790: 6572 2c0a 2020 2020 2020 2020 2020 2020  er,.            
+000217a0: 2267 6574 5f74 6173 6b5f 7374 6174 7573  "get_task_status
+000217b0: 223a 2073 656c 662e 6765 745f 7461 736b  ": self.get_task
+000217c0: 5f73 7461 7475 732c 0a20 2020 2020 2020  _status,.       
+000217d0: 2020 2020 2022 6765 745f 7461 736b 5f73       "get_task_s
+000217e0: 7472 6561 6d22 3a20 7365 6c66 2e67 6574  tream": self.get
+000217f0: 5f74 6173 6b5f 7374 7265 616d 2c0a 2020  _task_stream,.  
+00021800: 2020 2020 2020 2020 2020 2267 6574 5f74            "get_t
+00021810: 6173 6b5f 7072 6566 6978 5f73 7461 7465  ask_prefix_state
+00021820: 7322 3a20 7365 6c66 2e67 6574 5f74 6173  s": self.get_tas
+00021830: 6b5f 7072 6566 6978 5f73 7461 7465 732c  k_prefix_states,
+00021840: 0a20 2020 2020 2020 2020 2020 2022 7265  .            "re
+00021850: 6769 7374 6572 5f73 6368 6564 756c 6572  gister_scheduler
+00021860: 5f70 6c75 6769 6e22 3a20 7365 6c66 2e72  _plugin": self.r
+00021870: 6567 6973 7465 725f 7363 6865 6475 6c65  egister_schedule
+00021880: 725f 706c 7567 696e 2c0a 2020 2020 2020  r_plugin,.      
+00021890: 2020 2020 2020 2275 6e72 6567 6973 7465        "unregiste
+000218a0: 725f 7363 6865 6475 6c65 725f 706c 7567  r_scheduler_plug
+000218b0: 696e 223a 2073 656c 662e 756e 7265 6769  in": self.unregi
+000218c0: 7374 6572 5f73 6368 6564 756c 6572 5f70  ster_scheduler_p
+000218d0: 6c75 6769 6e2c 0a20 2020 2020 2020 2020  lugin,.         
+000218e0: 2020 2022 7265 6769 7374 6572 5f77 6f72     "register_wor
+000218f0: 6b65 725f 706c 7567 696e 223a 2073 656c  ker_plugin": sel
+00021900: 662e 7265 6769 7374 6572 5f77 6f72 6b65  f.register_worke
+00021910: 725f 706c 7567 696e 2c0a 2020 2020 2020  r_plugin,.      
+00021920: 2020 2020 2020 2275 6e72 6567 6973 7465        "unregiste
+00021930: 725f 776f 726b 6572 5f70 6c75 6769 6e22  r_worker_plugin"
+00021940: 3a20 7365 6c66 2e75 6e72 6567 6973 7465  : self.unregiste
+00021950: 725f 776f 726b 6572 5f70 6c75 6769 6e2c  r_worker_plugin,
+00021960: 0a20 2020 2020 2020 2020 2020 2022 7265  .            "re
+00021970: 6769 7374 6572 5f6e 616e 6e79 5f70 6c75  gister_nanny_plu
+00021980: 6769 6e22 3a20 7365 6c66 2e72 6567 6973  gin": self.regis
+00021990: 7465 725f 6e61 6e6e 795f 706c 7567 696e  ter_nanny_plugin
+000219a0: 2c0a 2020 2020 2020 2020 2020 2020 2275  ,.            "u
+000219b0: 6e72 6567 6973 7465 725f 6e61 6e6e 795f  nregister_nanny_
+000219c0: 706c 7567 696e 223a 2073 656c 662e 756e  plugin": self.un
+000219d0: 7265 6769 7374 6572 5f6e 616e 6e79 5f70  register_nanny_p
+000219e0: 6c75 6769 6e2c 0a20 2020 2020 2020 2020  lugin,.         
+000219f0: 2020 2022 6164 6170 7469 7665 5f74 6172     "adaptive_tar
+00021a00: 6765 7422 3a20 7365 6c66 2e61 6461 7074  get": self.adapt
+00021a10: 6976 655f 7461 7267 6574 2c0a 2020 2020  ive_target,.    
+00021a20: 2020 2020 2020 2020 2277 6f72 6b65 7273          "workers
+00021a30: 5f74 6f5f 636c 6f73 6522 3a20 7365 6c66  _to_close": self
+00021a40: 2e77 6f72 6b65 7273 5f74 6f5f 636c 6f73  .workers_to_clos
+00021a50: 652c 0a20 2020 2020 2020 2020 2020 2022  e,.            "
+00021a60: 7375 6273 6372 6962 655f 776f 726b 6572  subscribe_worker
+00021a70: 5f73 7461 7475 7322 3a20 7365 6c66 2e73  _status": self.s
+00021a80: 7562 7363 7269 6265 5f77 6f72 6b65 725f  ubscribe_worker_
+00021a90: 7374 6174 7573 2c0a 2020 2020 2020 2020  status,.        
+00021aa0: 2020 2020 2273 7461 7274 5f74 6173 6b5f      "start_task_
+00021ab0: 6d65 7461 6461 7461 223a 2073 656c 662e  metadata": self.
+00021ac0: 7374 6172 745f 7461 736b 5f6d 6574 6164  start_task_metad
+00021ad0: 6174 612c 0a20 2020 2020 2020 2020 2020  ata,.           
+00021ae0: 2022 7374 6f70 5f74 6173 6b5f 6d65 7461   "stop_task_meta
+00021af0: 6461 7461 223a 2073 656c 662e 7374 6f70  data": self.stop
+00021b00: 5f74 6173 6b5f 6d65 7461 6461 7461 2c0a  _task_metadata,.
+00021b10: 2020 2020 2020 2020 2020 2020 2267 6574              "get
+00021b20: 5f63 6c75 7374 6572 5f73 7461 7465 223a  _cluster_state":
+00021b30: 2073 656c 662e 6765 745f 636c 7573 7465   self.get_cluste
+00021b40: 725f 7374 6174 652c 0a20 2020 2020 2020  r_state,.       
+00021b50: 2020 2020 2022 6475 6d70 5f63 6c75 7374       "dump_clust
+00021b60: 6572 5f73 7461 7465 5f74 6f5f 7572 6c22  er_state_to_url"
+00021b70: 3a20 7365 6c66 2e64 756d 705f 636c 7573  : self.dump_clus
+00021b80: 7465 725f 7374 6174 655f 746f 5f75 726c  ter_state_to_url
+00021b90: 2c0a 2020 2020 2020 2020 2020 2020 2262  ,.            "b
+00021ba0: 656e 6368 6d61 726b 5f68 6172 6477 6172  enchmark_hardwar
+00021bb0: 6522 3a20 7365 6c66 2e62 656e 6368 6d61  e": self.benchma
+00021bc0: 726b 5f68 6172 6477 6172 652c 0a20 2020  rk_hardware,.   
+00021bd0: 2020 2020 2020 2020 2022 6765 745f 7374           "get_st
+00021be0: 6f72 7922 3a20 7365 6c66 2e67 6574 5f73  ory": self.get_s
+00021bf0: 746f 7279 2c0a 2020 2020 2020 2020 2020  tory,.          
+00021c00: 2020 2263 6865 636b 5f69 646c 6522 3a20    "check_idle": 
+00021c10: 7365 6c66 2e63 6865 636b 5f69 646c 652c  self.check_idle,
+00021c20: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
+00021c30: 2020 2020 636f 6e6e 6563 7469 6f6e 5f6c      connection_l
+00021c40: 696d 6974 203d 2067 6574 5f66 696c 656e  imit = get_filen
+00021c50: 6f5f 6c69 6d69 7428 2920 2f20 320a 0a20  o_limit() / 2.. 
+00021c60: 2020 2020 2020 2053 6368 6564 756c 6572         Scheduler
+00021c70: 5374 6174 652e 5f5f 696e 6974 5f5f 280a  State.__init__(.
+00021c80: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00021c90: 2c0a 2020 2020 2020 2020 2020 2020 616c  ,.            al
+00021ca0: 6961 7365 733d 616c 6961 7365 732c 0a20  iases=aliases,. 
+00021cb0: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
+00021cc0: 7473 3d63 6c69 656e 7473 2c0a 2020 2020  ts=clients,.    
+00021cd0: 2020 2020 2020 2020 776f 726b 6572 733d          workers=
+00021ce0: 776f 726b 6572 732c 0a20 2020 2020 2020  workers,.       
+00021cf0: 2020 2020 2068 6f73 745f 696e 666f 3d68       host_info=h
+00021d00: 6f73 745f 696e 666f 2c0a 2020 2020 2020  ost_info,.      
+00021d10: 2020 2020 2020 7265 736f 7572 6365 733d        resources=
+00021d20: 7265 736f 7572 6365 732c 0a20 2020 2020  resources,.     
+00021d30: 2020 2020 2020 2074 6173 6b73 3d74 6173         tasks=tas
+00021d40: 6b73 2c0a 2020 2020 2020 2020 2020 2020  ks,.            
+00021d50: 756e 7275 6e6e 6162 6c65 3d75 6e72 756e  unrunnable=unrun
+00021d60: 6e61 626c 652c 0a20 2020 2020 2020 2020  nable,.         
+00021d70: 2020 2071 7565 7565 643d 7175 6575 6564     queued=queued
+00021d80: 2c0a 2020 2020 2020 2020 2020 2020 7661  ,.            va
+00021d90: 6c69 6461 7465 3d76 616c 6964 6174 652c  lidate=validate,
+00021da0: 0a20 2020 2020 2020 2020 2020 2070 6c75  .            plu
+00021db0: 6769 6e73 3d70 6c75 6769 6e73 2c0a 2020  gins=plugins,.  
+00021dc0: 2020 2020 2020 2020 2020 7472 616e 7369            transi
+00021dd0: 7469 6f6e 5f63 6f75 6e74 6572 5f6d 6178  tion_counter_max
+00021de0: 3d74 7261 6e73 6974 696f 6e5f 636f 756e  =transition_coun
+00021df0: 7465 725f 6d61 782c 0a20 2020 2020 2020  ter_max,.       
+00021e00: 2029 0a20 2020 2020 2020 2053 6572 7665   ).        Serve
+00021e10: 724e 6f64 652e 5f5f 696e 6974 5f5f 280a  rNode.__init__(.
+00021e20: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00021e30: 2c0a 2020 2020 2020 2020 2020 2020 6861  ,.            ha
+00021e40: 6e64 6c65 7273 3d73 656c 662e 6861 6e64  ndlers=self.hand
+00021e50: 6c65 7273 2c0a 2020 2020 2020 2020 2020  lers,.          
+00021e60: 2020 7374 7265 616d 5f68 616e 646c 6572    stream_handler
+00021e70: 733d 6d65 7267 6528 776f 726b 6572 5f68  s=merge(worker_h
+00021e80: 616e 646c 6572 732c 2063 6c69 656e 745f  andlers, client_
+00021e90: 6861 6e64 6c65 7273 292c 0a20 2020 2020  handlers),.     
+00021ea0: 2020 2020 2020 2063 6f6e 6e65 6374 696f         connectio
+00021eb0: 6e5f 6c69 6d69 743d 636f 6e6e 6563 7469  n_limit=connecti
+00021ec0: 6f6e 5f6c 696d 6974 2c0a 2020 2020 2020  on_limit,.      
+00021ed0: 2020 2020 2020 6465 7365 7269 616c 697a        deserializ
+00021ee0: 653d 4661 6c73 652c 0a20 2020 2020 2020  e=False,.       
+00021ef0: 2020 2020 2063 6f6e 6e65 6374 696f 6e5f       connection_
+00021f00: 6172 6773 3d73 656c 662e 636f 6e6e 6563  args=self.connec
+00021f10: 7469 6f6e 5f61 7267 732c 0a20 2020 2020  tion_args,.     
+00021f20: 2020 2020 2020 202a 2a6b 7761 7267 732c         **kwargs,
+00021f30: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+00021f40: 2020 2020 6966 2073 656c 662e 776f 726b      if self.work
+00021f50: 6572 5f74 746c 3a0a 2020 2020 2020 2020  er_ttl:.        
+00021f60: 2020 2020 7063 203d 2050 6572 696f 6469      pc = Periodi
+00021f70: 6343 616c 6c62 6163 6b28 7365 6c66 2e63  cCallback(self.c
+00021f80: 6865 636b 5f77 6f72 6b65 725f 7474 6c2c  heck_worker_ttl,
+00021f90: 2073 656c 662e 776f 726b 6572 5f74 746c   self.worker_ttl
+00021fa0: 202a 2031 3030 3029 0a20 2020 2020 2020   * 1000).       
+00021fb0: 2020 2020 2073 656c 662e 7065 7269 6f64       self.period
+00021fc0: 6963 5f63 616c 6c62 6163 6b73 5b22 776f  ic_callbacks["wo
+00021fd0: 726b 6572 2d74 746c 225d 203d 2070 630a  rker-ttl"] = pc.
+00021fe0: 0a20 2020 2020 2020 2070 6320 3d20 5065  .        pc = Pe
+00021ff0: 7269 6f64 6963 4361 6c6c 6261 636b 2873  riodicCallback(s
+00022000: 656c 662e 6368 6563 6b5f 6964 6c65 2c20  elf.check_idle, 
+00022010: 3235 3029 0a20 2020 2020 2020 2073 656c  250).        sel
+00022020: 662e 7065 7269 6f64 6963 5f63 616c 6c62  f.periodic_callb
+00022030: 6163 6b73 5b22 6964 6c65 2d74 696d 656f  acks["idle-timeo
+00022040: 7574 225d 203d 2070 630a 0a20 2020 2020  ut"] = pc..     
+00022050: 2020 2070 6320 3d20 5065 7269 6f64 6963     pc = Periodic
+00022060: 4361 6c6c 6261 636b 2873 656c 662e 5f63  Callback(self._c
+00022070: 6865 636b 5f6e 6f5f 776f 726b 6572 732c  heck_no_workers,
+00022080: 2032 3530 290a 2020 2020 2020 2020 7365   250).        se
+00022090: 6c66 2e70 6572 696f 6469 635f 6361 6c6c  lf.periodic_call
+000220a0: 6261 636b 735b 226e 6f2d 776f 726b 6572  backs["no-worker
+000220b0: 732d 7469 6d65 6f75 7422 5d20 3d20 7063  s-timeout"] = pc
+000220c0: 0a0a 2020 2020 2020 2020 6966 2065 7874  ..        if ext
+000220d0: 656e 7369 6f6e 7320 6973 204e 6f6e 653a  ensions is None:
+000220e0: 0a20 2020 2020 2020 2020 2020 2065 7874  .            ext
+000220f0: 656e 7369 6f6e 7320 3d20 4445 4641 554c  ensions = DEFAUL
+00022100: 545f 4558 5445 4e53 494f 4e53 2e63 6f70  T_EXTENSIONS.cop
+00022110: 7928 290a 2020 2020 2020 2020 2020 2020  y().            
+00022120: 6966 206e 6f74 2064 6173 6b2e 636f 6e66  if not dask.conf
+00022130: 6967 2e67 6574 2822 6469 7374 7269 6275  ig.get("distribu
+00022140: 7465 642e 7363 6865 6475 6c65 722e 776f  ted.scheduler.wo
+00022150: 726b 2d73 7465 616c 696e 6722 293a 0a20  rk-stealing"):. 
+00022160: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00022170: 6620 2273 7465 616c 696e 6722 2069 6e20  f "stealing" in 
+00022180: 6578 7465 6e73 696f 6e73 3a0a 2020 2020  extensions:.    
+00022190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000221a0: 6465 6c20 6578 7465 6e73 696f 6e73 5b22  del extensions["
+000221b0: 7374 6561 6c69 6e67 225d 0a0a 2020 2020  stealing"]..    
+000221c0: 2020 2020 666f 7220 6e61 6d65 2c20 6578      for name, ex
+000221d0: 7465 6e73 696f 6e20 696e 2065 7874 656e  tension in exten
+000221e0: 7369 6f6e 732e 6974 656d 7328 293a 0a20  sions.items():. 
+000221f0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00022200: 6578 7465 6e73 696f 6e73 5b6e 616d 655d  extensions[name]
+00022210: 203d 2065 7874 656e 7369 6f6e 2873 656c   = extension(sel
+00022220: 6629 0a0a 2020 2020 2020 2020 7365 7470  f)..        setp
+00022230: 726f 6374 6974 6c65 2822 6461 736b 2073  roctitle("dask s
+00022240: 6368 6564 756c 6572 205b 6e6f 7420 7374  cheduler [not st
+00022250: 6172 7465 645d 2229 0a20 2020 2020 2020  arted]").       
+00022260: 2053 6368 6564 756c 6572 2e5f 696e 7374   Scheduler._inst
+00022270: 616e 6365 732e 6164 6428 7365 6c66 290a  ances.add(self).
+00022280: 2020 2020 2020 2020 7365 6c66 2e72 7063          self.rpc
+00022290: 2e61 6c6c 6f77 5f6f 6666 6c6f 6164 203d  .allow_offload =
+000222a0: 2046 616c 7365 0a0a 2020 2020 2323 2323   False..    ####
+000222b0: 2323 2323 2323 2323 2323 2323 2323 0a20  ##############. 
+000222c0: 2020 2023 2041 646d 696e 6973 7472 6174     # Administrat
+000222d0: 696f 6e20 230a 2020 2020 2323 2323 2323  ion #.    ######
+000222e0: 2323 2323 2323 2323 2323 2323 0a0a 2020  ############..  
+000222f0: 2020 6465 6620 5f5f 7265 7072 5f5f 2873    def __repr__(s
+00022300: 656c 6629 202d 3e20 7374 723a 0a20 2020  elf) -> str:.   
+00022310: 2020 2020 2072 6574 7572 6e20 280a 2020       return (.  
+00022320: 2020 2020 2020 2020 2020 6622 3c53 6368            f"<Sch
+00022330: 6564 756c 6572 207b 7365 6c66 2e61 6464  eduler {self.add
+00022340: 7265 7373 5f73 6166 6521 727d 2c20 220a  ress_safe!r}, ".
+00022350: 2020 2020 2020 2020 2020 2020 6622 776f              f"wo
+00022360: 726b 6572 733a 207b 6c65 6e28 7365 6c66  rkers: {len(self
+00022370: 2e77 6f72 6b65 7273 297d 2c20 220a 2020  .workers)}, ".  
+00022380: 2020 2020 2020 2020 2020 6622 636f 7265            f"core
+00022390: 733a 207b 7365 6c66 2e74 6f74 616c 5f6e  s: {self.total_n
+000223a0: 7468 7265 6164 737d 2c20 220a 2020 2020  threads}, ".    
+000223b0: 2020 2020 2020 2020 6622 7461 736b 733a          f"tasks:
+000223c0: 207b 6c65 6e28 7365 6c66 2e74 6173 6b73   {len(self.tasks
+000223d0: 297d 3e22 0a20 2020 2020 2020 2029 0a0a  )}>".        )..
+000223e0: 2020 2020 6465 6620 5f72 6570 725f 6874      def _repr_ht
+000223f0: 6d6c 5f28 7365 6c66 2920 2d3e 2073 7472  ml_(self) -> str
+00022400: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+00022410: 2067 6574 5f74 656d 706c 6174 6528 2273   get_template("s
+00022420: 6368 6564 756c 6572 2e68 746d 6c2e 6a32  cheduler.html.j2
+00022430: 2229 2e72 656e 6465 7228 0a20 2020 2020  ").render(.     
+00022440: 2020 2020 2020 2061 6464 7265 7373 3d73         address=s
+00022450: 656c 662e 6164 6472 6573 732c 0a20 2020  elf.address,.   
+00022460: 2020 2020 2020 2020 2077 6f72 6b65 7273           workers
+00022470: 3d73 656c 662e 776f 726b 6572 732c 0a20  =self.workers,. 
+00022480: 2020 2020 2020 2020 2020 2074 6872 6561             threa
+00022490: 6473 3d73 656c 662e 746f 7461 6c5f 6e74  ds=self.total_nt
+000224a0: 6872 6561 6473 2c0a 2020 2020 2020 2020  hreads,.        
+000224b0: 2020 2020 7461 736b 733d 7365 6c66 2e74      tasks=self.t
+000224c0: 6173 6b73 2c0a 2020 2020 2020 2020 290a  asks,.        ).
+000224d0: 0a20 2020 2064 6566 2069 6465 6e74 6974  .    def identit
+000224e0: 7928 7365 6c66 2920 2d3e 2064 6963 745b  y(self) -> dict[
+000224f0: 7374 722c 2041 6e79 5d3a 0a20 2020 2020  str, Any]:.     
+00022500: 2020 2022 2222 4261 7369 6320 696e 666f     """Basic info
+00022510: 726d 6174 696f 6e20 6162 6f75 7420 6f75  rmation about ou
+00022520: 7273 656c 7665 7320 616e 6420 6f75 7220  rselves and our 
+00022530: 636c 7573 7465 7222 2222 0a20 2020 2020  cluster""".     
+00022540: 2020 2064 203d 207b 0a20 2020 2020 2020     d = {.       
+00022550: 2020 2020 2022 7479 7065 223a 2074 7970       "type": typ
+00022560: 6528 7365 6c66 292e 5f5f 6e61 6d65 5f5f  e(self).__name__
+00022570: 2c0a 2020 2020 2020 2020 2020 2020 2269  ,.            "i
+00022580: 6422 3a20 7374 7228 7365 6c66 2e69 6429  d": str(self.id)
+00022590: 2c0a 2020 2020 2020 2020 2020 2020 2261  ,.            "a
+000225a0: 6464 7265 7373 223a 2073 656c 662e 6164  ddress": self.ad
+000225b0: 6472 6573 732c 0a20 2020 2020 2020 2020  dress,.         
+000225c0: 2020 2022 7365 7276 6963 6573 223a 207b     "services": {
+000225d0: 6b65 793a 2076 2e70 6f72 7420 666f 7220  key: v.port for 
+000225e0: 286b 6579 2c20 7629 2069 6e20 7365 6c66  (key, v) in self
+000225f0: 2e73 6572 7669 6365 732e 6974 656d 7328  .services.items(
+00022600: 297d 2c0a 2020 2020 2020 2020 2020 2020  )},.            
+00022610: 2273 7461 7274 6564 223a 2073 656c 662e  "started": self.
+00022620: 7469 6d65 5f73 7461 7274 6564 2c0a 2020  time_started,.  
+00022630: 2020 2020 2020 2020 2020 2277 6f72 6b65            "worke
+00022640: 7273 223a 207b 0a20 2020 2020 2020 2020  rs": {.         
+00022650: 2020 2020 2020 2077 6f72 6b65 722e 6164         worker.ad
+00022660: 6472 6573 733a 2077 6f72 6b65 722e 6964  dress: worker.id
+00022670: 656e 7469 7479 2829 2066 6f72 2077 6f72  entity() for wor
+00022680: 6b65 7220 696e 2073 656c 662e 776f 726b  ker in self.work
+00022690: 6572 732e 7661 6c75 6573 2829 0a20 2020  ers.values().   
+000226a0: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
+000226b0: 2020 2020 7d0a 2020 2020 2020 2020 7265      }.        re
+000226c0: 7475 726e 2064 0a0a 2020 2020 6465 6620  turn d..    def 
+000226d0: 5f74 6f5f 6469 6374 2873 656c 662c 202a  _to_dict(self, *
+000226e0: 2c20 6578 636c 7564 653a 2043 6f6e 7461  , exclude: Conta
+000226f0: 696e 6572 5b73 7472 5d20 3d20 2829 2920  iner[str] = ()) 
+00022700: 2d3e 2064 6963 743a 0a20 2020 2020 2020  -> dict:.       
+00022710: 2022 2222 4469 6374 696f 6e61 7279 2072   """Dictionary r
+00022720: 6570 7265 7365 6e74 6174 696f 6e20 666f  epresentation fo
+00022730: 7220 6465 6275 6767 696e 6720 7075 7270  r debugging purp
+00022740: 6f73 6573 2e0a 2020 2020 2020 2020 4e6f  oses..        No
+00022750: 7420 7479 7065 2073 7461 626c 6520 616e  t type stable an
+00022760: 6420 6e6f 7420 696e 7465 6e64 6564 2066  d not intended f
+00022770: 6f72 2072 6f75 6e64 7472 6970 732e 0a0a  or roundtrips...
+00022780: 2020 2020 2020 2020 5365 6520 616c 736f          See also
+00022790: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
+000227a0: 2d0a 2020 2020 2020 2020 5365 7276 6572  -.        Server
+000227b0: 2e69 6465 6e74 6974 790a 2020 2020 2020  .identity.      
+000227c0: 2020 436c 6965 6e74 2e64 756d 705f 636c    Client.dump_cl
+000227d0: 7573 7465 725f 7374 6174 650a 2020 2020  uster_state.    
+000227e0: 2020 2020 6469 7374 7269 6275 7465 642e      distributed.
+000227f0: 7574 696c 732e 7265 6375 7273 6976 655f  utils.recursive_
+00022800: 746f 5f64 6963 740a 2020 2020 2020 2020  to_dict.        
+00022810: 2222 220a 2020 2020 2020 2020 696e 666f  """.        info
+00022820: 203d 2073 7570 6572 2829 2e5f 746f 5f64   = super()._to_d
+00022830: 6963 7428 6578 636c 7564 653d 6578 636c  ict(exclude=excl
+00022840: 7564 6529 0a20 2020 2020 2020 2065 7874  ude).        ext
+00022850: 7261 203d 207b 0a20 2020 2020 2020 2020  ra = {.         
+00022860: 2020 2022 7472 616e 7369 7469 6f6e 5f6c     "transition_l
+00022870: 6f67 223a 2073 656c 662e 7472 616e 7369  og": self.transi
+00022880: 7469 6f6e 5f6c 6f67 2c0a 2020 2020 2020  tion_log,.      
+00022890: 2020 2020 2020 2274 7261 6e73 6974 696f        "transitio
+000228a0: 6e5f 636f 756e 7465 7222 3a20 7365 6c66  n_counter": self
+000228b0: 2e74 7261 6e73 6974 696f 6e5f 636f 756e  .transition_coun
+000228c0: 7465 722c 0a20 2020 2020 2020 2020 2020  ter,.           
+000228d0: 2022 7461 736b 7322 3a20 7365 6c66 2e74   "tasks": self.t
+000228e0: 6173 6b73 2c0a 2020 2020 2020 2020 2020  asks,.          
+000228f0: 2020 2274 6173 6b5f 6772 6f75 7073 223a    "task_groups":
+00022900: 2073 656c 662e 7461 736b 5f67 726f 7570   self.task_group
+00022910: 732c 0a20 2020 2020 2020 2020 2020 2023  s,.            #
+00022920: 204f 7665 7277 7269 7465 2064 6963 7420   Overwrite dict 
+00022930: 6f66 2057 6f72 6b65 7253 7461 7465 2e69  of WorkerState.i
+00022940: 6465 6e74 6974 7920 6672 6f6d 2069 6e66  dentity from inf
+00022950: 6f0a 2020 2020 2020 2020 2020 2020 2277  o.            "w
+00022960: 6f72 6b65 7273 223a 2073 656c 662e 776f  orkers": self.wo
+00022970: 726b 6572 732c 0a20 2020 2020 2020 2020  rkers,.         
+00022980: 2020 2022 636c 6965 6e74 7322 3a20 7365     "clients": se
+00022990: 6c66 2e63 6c69 656e 7473 2c0a 2020 2020  lf.clients,.    
+000229a0: 2020 2020 2020 2020 226d 656d 6f72 7922          "memory"
+000229b0: 3a20 7365 6c66 2e6d 656d 6f72 792c 0a20  : self.memory,. 
+000229c0: 2020 2020 2020 2020 2020 2022 6576 656e             "even
+000229d0: 7473 223a 2073 656c 662e 6576 656e 7473  ts": self.events
+000229e0: 2c0a 2020 2020 2020 2020 2020 2020 2265  ,.            "e
+000229f0: 7874 656e 7369 6f6e 7322 3a20 7365 6c66  xtensions": self
+00022a00: 2e65 7874 656e 7369 6f6e 732c 0a20 2020  .extensions,.   
+00022a10: 2020 2020 207d 0a20 2020 2020 2020 2065       }.        e
+00022a20: 7874 7261 203d 207b 6b3a 2076 2066 6f72  xtra = {k: v for
+00022a30: 206b 2c20 7620 696e 2065 7874 7261 2e69   k, v in extra.i
+00022a40: 7465 6d73 2829 2069 6620 6b20 6e6f 7420  tems() if k not 
+00022a50: 696e 2065 7863 6c75 6465 7d0a 2020 2020  in exclude}.    
+00022a60: 2020 2020 696e 666f 2e75 7064 6174 6528      info.update(
+00022a70: 7265 6375 7273 6976 655f 746f 5f64 6963  recursive_to_dic
+00022a80: 7428 6578 7472 612c 2065 7863 6c75 6465  t(extra, exclude
+00022a90: 3d65 7863 6c75 6465 2929 0a20 2020 2020  =exclude)).     
+00022aa0: 2020 2072 6574 7572 6e20 696e 666f 0a0a     return info..
+00022ab0: 2020 2020 6173 796e 6320 6465 6620 6765      async def ge
+00022ac0: 745f 636c 7573 7465 725f 7374 6174 6528  t_cluster_state(
+00022ad0: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+00022ae0: 2020 2020 2020 2065 7863 6c75 6465 3a20         exclude: 
+00022af0: 436f 6c6c 6563 7469 6f6e 5b73 7472 5d2c  Collection[str],
+00022b00: 0a20 2020 2029 202d 3e20 6469 6374 3a0a  .    ) -> dict:.
+00022b10: 2020 2020 2020 2020 2250 726f 6475 6365          "Produce
+00022b20: 2074 6865 2073 7461 7465 2064 6963 7420   the state dict 
+00022b30: 7573 6564 2069 6e20 6120 636c 7573 7465  used in a cluste
+00022b40: 7220 7374 6174 6520 6475 6d70 220a 2020  r state dump".  
+00022b50: 2020 2020 2020 2320 4b69 636b 206f 6666        # Kick off
+00022b60: 2073 7461 7465 2d64 756d 7069 6e67 206f   state-dumping o
+00022b70: 6e20 776f 726b 6572 7320 6265 666f 7265  n workers before
+00022b80: 2077 6520 626c 6f63 6b20 7468 6520 6576   we block the ev
+00022b90: 656e 7420 6c6f 6f70 2069 6e20 6073 656c  ent loop in `sel
+00022ba0: 662e 5f74 6f5f 6469 6374 602e 0a20 2020  f._to_dict`..   
+00022bb0: 2020 2020 2077 6f72 6b65 7273 5f66 7574       workers_fut
+00022bc0: 7572 6520 3d20 6173 796e 6369 6f2e 6761  ure = asyncio.ga
+00022bd0: 7468 6572 280a 2020 2020 2020 2020 2020  ther(.          
+00022be0: 2020 7365 6c66 2e62 726f 6164 6361 7374    self.broadcast
+00022bf0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00022c00: 2020 6d73 673d 7b22 6f70 223a 2022 6475    msg={"op": "du
+00022c10: 6d70 5f73 7461 7465 222c 2022 6578 636c  mp_state", "excl
+00022c20: 7564 6522 3a20 6578 636c 7564 657d 2c0a  ude": exclude},.
+00022c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022c40: 6f6e 5f65 7272 6f72 3d22 7265 7475 726e  on_error="return
+00022c50: 222c 0a20 2020 2020 2020 2020 2020 2029  ",.            )
+00022c60: 2c0a 2020 2020 2020 2020 2020 2020 7365  ,.            se
+00022c70: 6c66 2e62 726f 6164 6361 7374 280a 2020  lf.broadcast(.  
+00022c80: 2020 2020 2020 2020 2020 2020 2020 6d73                ms
+00022c90: 673d 7b22 6f70 223a 2022 7665 7273 696f  g={"op": "versio
+00022ca0: 6e73 227d 2c0a 2020 2020 2020 2020 2020  ns"},.          
+00022cb0: 2020 2020 2020 6f6e 5f65 7272 6f72 3d22        on_error="
+00022cc0: 6967 6e6f 7265 222c 0a20 2020 2020 2020  ignore",.       
+00022cd0: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
+00022ce0: 290a 2020 2020 2020 2020 7472 793a 0a20  ).        try:. 
+00022cf0: 2020 2020 2020 2020 2020 2073 6368 6564             sched
+00022d00: 756c 6572 5f73 7461 7465 203d 2073 656c  uler_state = sel
+00022d10: 662e 5f74 6f5f 6469 6374 2865 7863 6c75  f._to_dict(exclu
+00022d20: 6465 3d65 7863 6c75 6465 290a 0a20 2020  de=exclude)..   
+00022d30: 2020 2020 2020 2020 2077 6f72 6b65 725f           worker_
+00022d40: 7374 6174 6573 2c20 776f 726b 6572 5f76  states, worker_v
+00022d50: 6572 7369 6f6e 7320 3d20 6177 6169 7420  ersions = await 
+00022d60: 776f 726b 6572 735f 6675 7475 7265 0a20  workers_future. 
+00022d70: 2020 2020 2020 2066 696e 616c 6c79 3a0a         finally:.
+00022d80: 2020 2020 2020 2020 2020 2020 2320 456e              # En
+00022d90: 7375 7265 2074 6865 2074 6173 6b73 2061  sure the tasks a
+00022da0: 7265 6e27 7420 6c65 6674 2072 756e 6e69  ren't left runni
+00022db0: 6e67 2069 6620 616e 7974 6869 6e67 2066  ng if anything f
+00022dc0: 6169 6c73 2e0a 2020 2020 2020 2020 2020  ails..          
+00022dd0: 2020 2320 536f 6d65 6461 7920 2870 7933    # Someday (py3
+00022de0: 2e31 3129 2c20 7573 6520 6120 7472 696f  .11), use a trio
+00022df0: 2d73 7479 6c65 2054 6173 6b47 726f 7570  -style TaskGroup
+00022e00: 2066 6f72 2074 6869 732e 0a20 2020 2020   for this..     
+00022e10: 2020 2020 2020 2077 6f72 6b65 7273 5f66         workers_f
+00022e20: 7574 7572 652e 6361 6e63 656c 2829 0a0a  uture.cancel()..
+00022e30: 2020 2020 2020 2020 2320 436f 6e76 6572          # Conver
+00022e40: 7420 616e 7920 5250 4320 6572 726f 7273  t any RPC errors
+00022e50: 2074 6f20 7374 7269 6e67 730a 2020 2020   to strings.    
+00022e60: 2020 2020 776f 726b 6572 5f73 7461 7465      worker_state
+00022e70: 7320 3d20 7b0a 2020 2020 2020 2020 2020  s = {.          
+00022e80: 2020 6b3a 2072 6570 7228 7629 2069 6620    k: repr(v) if 
+00022e90: 6973 696e 7374 616e 6365 2876 2c20 4578  isinstance(v, Ex
+00022ea0: 6365 7074 696f 6e29 2065 6c73 6520 760a  ception) else v.
+00022eb0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00022ec0: 6b2c 2076 2069 6e20 776f 726b 6572 5f73  k, v in worker_s
+00022ed0: 7461 7465 732e 6974 656d 7328 290a 2020  tates.items().  
+00022ee0: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+00022ef0: 2072 6574 7572 6e20 7b0a 2020 2020 2020   return {.      
+00022f00: 2020 2020 2020 2273 6368 6564 756c 6572        "scheduler
+00022f10: 223a 2073 6368 6564 756c 6572 5f73 7461  ": scheduler_sta
+00022f20: 7465 2c0a 2020 2020 2020 2020 2020 2020  te,.            
+00022f30: 2277 6f72 6b65 7273 223a 2077 6f72 6b65  "workers": worke
+00022f40: 725f 7374 6174 6573 2c0a 2020 2020 2020  r_states,.      
+00022f50: 2020 2020 2020 2276 6572 7369 6f6e 7322        "versions"
+00022f60: 3a20 7b22 7363 6865 6475 6c65 7222 3a20  : {"scheduler": 
+00022f70: 7365 6c66 2e76 6572 7369 6f6e 7328 292c  self.versions(),
+00022f80: 2022 776f 726b 6572 7322 3a20 776f 726b   "workers": work
+00022f90: 6572 5f76 6572 7369 6f6e 737d 2c0a 2020  er_versions},.  
+00022fa0: 2020 2020 2020 7d0a 0a20 2020 2061 7379        }..    asy
+00022fb0: 6e63 2064 6566 2064 756d 705f 636c 7573  nc def dump_clus
+00022fc0: 7465 725f 7374 6174 655f 746f 5f75 726c  ter_state_to_url
+00022fd0: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+00022fe0: 2020 2020 2020 2020 7572 6c3a 2073 7472          url: str
+00022ff0: 2c0a 2020 2020 2020 2020 6578 636c 7564  ,.        exclud
+00023000: 653a 2043 6f6c 6c65 6374 696f 6e5b 7374  e: Collection[st
+00023010: 725d 2c0a 2020 2020 2020 2020 666f 726d  r],.        form
+00023020: 6174 3a20 4c69 7465 7261 6c5b 226d 7367  at: Literal["msg
+00023030: 7061 636b 222c 2022 7961 6d6c 225d 2c0a  pack", "yaml"],.
+00023040: 2020 2020 2020 2020 2a2a 7374 6f72 6167          **storag
+00023050: 655f 6f70 7469 6f6e 733a 2064 6963 745b  e_options: dict[
+00023060: 7374 722c 2041 6e79 5d2c 0a20 2020 2029  str, Any],.    )
+00023070: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00023080: 2020 2257 7269 7465 2061 2063 6c75 7374    "Write a clust
+00023090: 6572 2073 7461 7465 2064 756d 7020 746f  er state dump to
+000230a0: 2061 6e20 6673 7370 6563 2d63 6f6d 7061   an fsspec-compa
+000230b0: 7469 626c 6520 5552 4c2e 220a 2020 2020  tible URL.".    
+000230c0: 2020 2020 6177 6169 7420 636c 7573 7465      await cluste
+000230d0: 725f 6475 6d70 2e77 7269 7465 5f73 7461  r_dump.write_sta
+000230e0: 7465 280a 2020 2020 2020 2020 2020 2020  te(.            
+000230f0: 7061 7274 6961 6c28 7365 6c66 2e67 6574  partial(self.get
+00023100: 5f63 6c75 7374 6572 5f73 7461 7465 2c20  _cluster_state, 
+00023110: 6578 636c 7564 6529 2c20 7572 6c2c 2066  exclude), url, f
+00023120: 6f72 6d61 742c 202a 2a73 746f 7261 6765  ormat, **storage
+00023130: 5f6f 7074 696f 6e73 0a20 2020 2020 2020  _options.       
+00023140: 2029 0a0a 2020 2020 6465 6620 6765 745f   )..    def get_
+00023150: 776f 726b 6572 5f73 6572 7669 6365 5f61  worker_service_a
+00023160: 6464 7228 0a20 2020 2020 2020 2073 656c  ddr(.        sel
+00023170: 662c 2077 6f72 6b65 723a 2073 7472 2c20  f, worker: str, 
+00023180: 7365 7276 6963 655f 6e61 6d65 3a20 7374  service_name: st
+00023190: 722c 2070 726f 746f 636f 6c3a 2062 6f6f  r, protocol: boo
+000231a0: 6c20 3d20 4661 6c73 650a 2020 2020 2920  l = False.    ) 
+000231b0: 2d3e 2074 7570 6c65 5b73 7472 2c20 696e  -> tuple[str, in
+000231c0: 745d 207c 2073 7472 207c 204e 6f6e 653a  t] | str | None:
+000231d0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+000231e0: 2020 2020 2047 6574 2074 6865 2028 686f       Get the (ho
+000231f0: 7374 2c20 706f 7274 2920 6164 6472 6573  st, port) addres
+00023200: 7320 6f66 2074 6865 206e 616d 6564 2073  s of the named s
+00023210: 6572 7669 6365 206f 6e20 7468 6520 2a77  ervice on the *w
+00023220: 6f72 6b65 722a 2e0a 2020 2020 2020 2020  orker*..        
+00023230: 5265 7475 726e 7320 4e6f 6e65 2069 6620  Returns None if 
+00023240: 7468 6520 7365 7276 6963 6520 646f 6573  the service does
+00023250: 6e27 7420 6578 6973 742e 0a0a 2020 2020  n't exist...    
+00023260: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
+00023270: 2020 2020 2020 202d 2d2d 2d2d 2d2d 2d2d         ---------
+00023280: 2d0a 2020 2020 2020 2020 776f 726b 6572  -.        worker
+00023290: 203a 2061 6464 7265 7373 0a20 2020 2020   : address.     
+000232a0: 2020 2073 6572 7669 6365 5f6e 616d 6520     service_name 
+000232b0: 3a20 7374 720a 2020 2020 2020 2020 2020  : str.          
+000232c0: 2020 436f 6d6d 6f6e 2073 6572 7669 6365    Common service
+000232d0: 7320 696e 636c 7564 6520 2762 6f6b 6568  s include 'bokeh
+000232e0: 2720 616e 6420 276e 616e 6e79 270a 2020  ' and 'nanny'.  
+000232f0: 2020 2020 2020 7072 6f74 6f63 6f6c 203a        protocol :
+00023300: 2062 6f6f 6c65 616e 0a20 2020 2020 2020   boolean.       
+00023310: 2020 2020 2057 6865 7468 6572 206f 7220       Whether or 
+00023320: 6e6f 7420 746f 2069 6e63 6c75 6465 2061  not to include a
+00023330: 2066 756c 6c20 6164 6472 6573 7320 7769   full address wi
+00023340: 7468 2070 726f 746f 636f 6c20 2854 7275  th protocol (Tru
+00023350: 6529 0a20 2020 2020 2020 2020 2020 206f  e).            o
+00023360: 7220 6a75 7374 2061 2028 686f 7374 2c20  r just a (host, 
+00023370: 706f 7274 2920 7061 6972 0a20 2020 2020  port) pair.     
+00023380: 2020 2022 2222 0a20 2020 2020 2020 2077     """.        w
+00023390: 7320 3d20 7365 6c66 2e77 6f72 6b65 7273  s = self.workers
+000233a0: 5b77 6f72 6b65 725d 0a20 2020 2020 2020  [worker].       
+000233b0: 2070 6f72 7420 3d20 7773 2e73 6572 7669   port = ws.servi
+000233c0: 6365 732e 6765 7428 7365 7276 6963 655f  ces.get(service_
+000233d0: 6e61 6d65 290a 2020 2020 2020 2020 6966  name).        if
+000233e0: 2070 6f72 7420 6973 204e 6f6e 653a 0a20   port is None:. 
+000233f0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00023400: 6e20 4e6f 6e65 0a20 2020 2020 2020 2065  n None.        e
+00023410: 6c69 6620 7072 6f74 6f63 6f6c 3a0a 2020  lif protocol:.  
+00023420: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00023430: 2022 2528 7072 6f74 6f63 6f6c 2973 3a2f   "%(protocol)s:/
+00023440: 2f25 2868 6f73 7429 733a 2528 706f 7274  /%(host)s:%(port
+00023450: 2964 2220 2520 7b0a 2020 2020 2020 2020  )d" % {.        
+00023460: 2020 2020 2020 2020 2270 726f 746f 636f          "protoco
+00023470: 6c22 3a20 7773 2e61 6464 7265 7373 2e73  l": ws.address.s
+00023480: 706c 6974 2822 3a2f 2f22 295b 305d 2c0a  plit("://")[0],.
+00023490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000234a0: 2268 6f73 7422 3a20 7773 2e68 6f73 742c  "host": ws.host,
+000234b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000234c0: 2022 706f 7274 223a 2070 6f72 742c 0a20   "port": port,. 
+000234d0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+000234e0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+000234f0: 2020 2020 2020 2072 6574 7572 6e20 7773         return ws
+00023500: 2e68 6f73 742c 2070 6f72 740a 0a20 2020  .host, port..   
+00023510: 2061 7379 6e63 2064 6566 2073 7461 7274   async def start
+00023520: 5f75 6e73 6166 6528 7365 6c66 2920 2d3e  _unsafe(self) ->
+00023530: 2053 656c 663a 0a20 2020 2020 2020 2022   Self:.        "
+00023540: 2222 436c 6561 7220 6f75 7420 6f6c 6420  ""Clear out old 
+00023550: 7374 6174 6520 616e 6420 7265 7374 6172  state and restar
+00023560: 7420 616c 6c20 7275 6e6e 696e 6720 636f  t all running co
+00023570: 726f 7574 696e 6573 2222 220a 2020 2020  routines""".    
+00023580: 2020 2020 6177 6169 7420 7375 7065 7228      await super(
+00023590: 292e 7374 6172 745f 756e 7361 6665 2829  ).start_unsafe()
+000235a0: 0a0a 2020 2020 2020 2020 656e 6162 6c65  ..        enable
+000235b0: 5f67 635f 6469 6167 6e6f 7369 7328 290a  _gc_diagnosis().
+000235c0: 0a20 2020 2020 2020 2073 656c 662e 5f63  .        self._c
+000235d0: 6c65 6172 5f74 6173 6b5f 7374 6174 6528  lear_task_state(
+000235e0: 290a 0a20 2020 2020 2020 2066 6f72 2061  )..        for a
+000235f0: 6464 7220 696e 2073 656c 662e 5f73 7461  ddr in self._sta
+00023600: 7274 5f61 6464 7265 7373 3a0a 2020 2020  rt_address:.    
+00023610: 2020 2020 2020 2020 6177 6169 7420 7365          await se
+00023620: 6c66 2e6c 6973 7465 6e28 0a20 2020 2020  lf.listen(.     
+00023630: 2020 2020 2020 2020 2020 2061 6464 722c             addr,
+00023640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023650: 2061 6c6c 6f77 5f6f 6666 6c6f 6164 3d46   allow_offload=F
+00023660: 616c 7365 2c0a 2020 2020 2020 2020 2020  alse,.          
+00023670: 2020 2020 2020 6861 6e64 7368 616b 655f        handshake_
+00023680: 6f76 6572 7269 6465 733d 7b22 7069 636b  overrides={"pick
+00023690: 6c65 2d70 726f 746f 636f 6c22 3a20 342c  le-protocol": 4,
+000236a0: 2022 636f 6d70 7265 7373 696f 6e22 3a20   "compression": 
+000236b0: 4e6f 6e65 7d2c 0a20 2020 2020 2020 2020  None},.         
+000236c0: 2020 2020 2020 202a 2a73 656c 662e 7365         **self.se
+000236d0: 6375 7269 7479 2e67 6574 5f6c 6973 7465  curity.get_liste
+000236e0: 6e5f 6172 6773 2822 7363 6865 6475 6c65  n_args("schedule
+000236f0: 7222 292c 0a20 2020 2020 2020 2020 2020  r"),.           
+00023700: 2029 0a20 2020 2020 2020 2020 2020 2073   ).            s
+00023710: 656c 662e 6970 203d 2067 6574 5f61 6464  elf.ip = get_add
+00023720: 7265 7373 5f68 6f73 7428 7365 6c66 2e6c  ress_host(self.l
+00023730: 6973 7465 6e5f 6164 6472 6573 7329 0a20  isten_address). 
+00023740: 2020 2020 2020 2020 2020 206c 6973 7465             liste
+00023750: 6e5f 6970 203d 2073 656c 662e 6970 0a0a  n_ip = self.ip..
+00023760: 2020 2020 2020 2020 2020 2020 6966 206c              if l
+00023770: 6973 7465 6e5f 6970 203d 3d20 2230 2e30  isten_ip == "0.0
+00023780: 2e30 2e30 223a 0a20 2020 2020 2020 2020  .0.0":.         
+00023790: 2020 2020 2020 206c 6973 7465 6e5f 6970         listen_ip
+000237a0: 203d 2022 220a 0a20 2020 2020 2020 2069   = ""..        i
+000237b0: 6620 7365 6c66 2e61 6464 7265 7373 2e73  f self.address.s
+000237c0: 7461 7274 7377 6974 6828 2269 6e70 726f  tartswith("inpro
+000237d0: 633a 2f2f 2229 3a0a 2020 2020 2020 2020  c://"):.        
+000237e0: 2020 2020 6c69 7374 656e 5f69 7020 3d20      listen_ip = 
+000237f0: 226c 6f63 616c 686f 7374 220a 0a20 2020  "localhost"..   
+00023800: 2020 2020 2023 2053 6572 7669 6365 7320       # Services 
+00023810: 6c69 7374 656e 206f 6e20 616c 6c20 6164  listen on all ad
+00023820: 6472 6573 7365 730a 2020 2020 2020 2020  dresses.        
+00023830: 7365 6c66 2e73 7461 7274 5f73 6572 7669  self.start_servi
+00023840: 6365 7328 6c69 7374 656e 5f69 7029 0a0a  ces(listen_ip)..
+00023850: 2020 2020 2020 2020 666f 7220 6c69 7374          for list
+00023860: 656e 6572 2069 6e20 7365 6c66 2e6c 6973  ener in self.lis
+00023870: 7465 6e65 7273 3a0a 2020 2020 2020 2020  teners:.        
+00023880: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
+00023890: 2220 2053 6368 6564 756c 6572 2061 743a  "  Scheduler at:
+000238a0: 2025 3235 7322 2c20 6c69 7374 656e 6572   %25s", listener
+000238b0: 2e63 6f6e 7461 6374 5f61 6464 7265 7373  .contact_address
+000238c0: 290a 2020 2020 2020 2020 666f 7220 6e61  ).        for na
+000238d0: 6d65 2c20 7365 7276 6572 2069 6e20 7365  me, server in se
+000238e0: 6c66 2e73 6572 7669 6365 732e 6974 656d  lf.services.item
+000238f0: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+00023900: 2069 6620 6e61 6d65 203d 3d20 2264 6173   if name == "das
+00023910: 6862 6f61 7264 223a 0a20 2020 2020 2020  hboard":.       
+00023920: 2020 2020 2020 2020 2061 6464 7220 3d20           addr = 
+00023930: 6765 745f 6164 6472 6573 735f 686f 7374  get_address_host
+00023940: 286c 6973 7465 6e65 722e 636f 6e74 6163  (listener.contac
+00023950: 745f 6164 6472 6573 7329 0a20 2020 2020  t_address).     
+00023960: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+00023970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023980: 2020 2020 6c69 6e6b 203d 2066 6f72 6d61      link = forma
+00023990: 745f 6461 7368 626f 6172 645f 6c69 6e6b  t_dashboard_link
+000239a0: 2861 6464 722c 2073 6572 7665 722e 706f  (addr, server.po
+000239b0: 7274 290a 2020 2020 2020 2020 2020 2020  rt).            
+000239c0: 2020 2020 2320 666f 726d 6174 7469 6e67      # formatting
+000239d0: 2064 6173 6862 6f61 7264 206c 696e 6b20   dashboard link 
+000239e0: 6361 6e20 6661 696c 2069 6620 6469 7374  can fail if dist
+000239f0: 7269 6275 7465 642e 6461 7368 626f 6172  ributed.dashboar
+00023a00: 642e 6c69 6e6b 0a20 2020 2020 2020 2020  d.link.         
+00023a10: 2020 2020 2020 2023 2072 6566 6572 7320         # refers 
+00023a20: 746f 206e 6f6e 2d65 7869 7374 616e 7420  to non-existant 
+00023a30: 656e 7620 7661 7273 2e0a 2020 2020 2020  env vars..      
+00023a40: 2020 2020 2020 2020 2020 6578 6365 7074            except
+00023a50: 204b 6579 4572 726f 7220 6173 2065 3a0a   KeyError as e:.
+00023a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023a70: 2020 2020 6c6f 6767 6572 2e77 6172 6e69      logger.warni
+00023a80: 6e67 280a 2020 2020 2020 2020 2020 2020  ng(.            
+00023a90: 2020 2020 2020 2020 2020 2020 6622 4661              f"Fa
+00023aa0: 696c 6564 2074 6f20 666f 726d 6174 2064  iled to format d
+00023ab0: 6173 6862 6f61 7264 206c 696e 6b2c 2075  ashboard link, u
+00023ac0: 6e6b 6e6f 776e 2076 616c 7565 3a20 7b65  nknown value: {e
+00023ad0: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
+00023ae0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00023af0: 2020 2020 2020 2020 2020 2020 206c 696e               lin
+00023b00: 6b20 3d20 6622 3a7b 7365 7276 6572 2e70  k = f":{server.p
+00023b10: 6f72 747d 220a 2020 2020 2020 2020 2020  ort}".          
+00023b20: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00023b30: 2020 2020 2020 2020 6c69 6e6b 203d 2066          link = f
+00023b40: 227b 6c69 7374 656e 5f69 707d 3a7b 7365  "{listen_ip}:{se
+00023b50: 7276 6572 2e70 6f72 747d 220a 2020 2020  rver.port}".    
+00023b60: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
+00023b70: 6e66 6f28 2225 3131 7320 6174 3a20 2025  nfo("%11s at:  %
+00023b80: 3235 7322 2c20 6e61 6d65 2c20 6c69 6e6b  25s", name, link
+00023b90: 290a 0a20 2020 2020 2020 2069 6620 7365  )..        if se
+00023ba0: 6c66 2e73 6368 6564 756c 6572 5f66 696c  lf.scheduler_fil
+00023bb0: 653a 0a20 2020 2020 2020 2020 2020 2077  e:.            w
+00023bc0: 6974 6820 6f70 656e 2873 656c 662e 7363  ith open(self.sc
+00023bd0: 6865 6475 6c65 725f 6669 6c65 2c20 2277  heduler_file, "w
+00023be0: 2229 2061 7320 663a 0a20 2020 2020 2020  ") as f:.       
+00023bf0: 2020 2020 2020 2020 206a 736f 6e2e 6475           json.du
+00023c00: 6d70 2873 656c 662e 6964 656e 7469 7479  mp(self.identity
+00023c10: 2829 2c20 662c 2069 6e64 656e 743d 3229  (), f, indent=2)
+00023c20: 0a0a 2020 2020 2020 2020 2020 2020 666e  ..            fn
+00023c30: 203d 2073 656c 662e 7363 6865 6475 6c65   = self.schedule
+00023c40: 725f 6669 6c65 2020 2320 7265 6d6f 7665  r_file  # remove
+00023c50: 2066 696c 6520 7768 656e 2077 6520 636c   file when we cl
+00023c60: 6f73 6520 7468 6520 7072 6f63 6573 730a  ose the process.
+00023c70: 0a20 2020 2020 2020 2020 2020 2064 6566  .            def
+00023c80: 2064 656c 5f73 6368 6564 756c 6572 5f66   del_scheduler_f
+00023c90: 696c 6528 2920 2d3e 204e 6f6e 653a 0a20  ile() -> None:. 
+00023ca0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00023cb0: 6620 6f73 2e70 6174 682e 6578 6973 7473  f os.path.exists
+00023cc0: 2866 6e29 3a0a 2020 2020 2020 2020 2020  (fn):.          
+00023cd0: 2020 2020 2020 2020 2020 6f73 2e72 656d            os.rem
+00023ce0: 6f76 6528 666e 290a 0a20 2020 2020 2020  ove(fn)..       
+00023cf0: 2020 2020 2077 6561 6b72 6566 2e66 696e       weakref.fin
+00023d00: 616c 697a 6528 7365 6c66 2c20 6465 6c5f  alize(self, del_
+00023d10: 7363 6865 6475 6c65 725f 6669 6c65 290a  scheduler_file).
+00023d20: 0a20 2020 2020 2020 2061 7761 6974 2073  .        await s
+00023d30: 656c 662e 7072 656c 6f61 6473 2e73 7461  elf.preloads.sta
+00023d40: 7274 2829 0a0a 2020 2020 2020 2020 6966  rt()..        if
+00023d50: 2073 656c 662e 6a75 7079 7465 723a 0a20   self.jupyter:. 
+00023d60: 2020 2020 2020 2020 2020 2023 2041 6c6c             # All
+00023d70: 6f77 2069 6e73 6563 7572 6520 636f 6d6d  ow insecure comm
+00023d80: 756e 6963 6174 696f 6e73 2066 726f 6d20  unications from 
+00023d90: 6c6f 6361 6c20 7573 6572 730a 2020 2020  local users.    
+00023da0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00023db0: 6164 6472 6573 732e 7374 6172 7473 7769  address.startswi
+00023dc0: 7468 2822 746c 733a 2f2f 2229 3a0a 2020  th("tls://"):.  
+00023dd0: 2020 2020 2020 2020 2020 2020 2020 6177                aw
+00023de0: 6169 7420 7365 6c66 2e6c 6973 7465 6e28  ait self.listen(
+00023df0: 2274 6370 3a2f 2f6c 6f63 616c 686f 7374  "tcp://localhost
+00023e00: 3a30 2229 0a20 2020 2020 2020 2020 2020  :0").           
+00023e10: 206f 732e 656e 7669 726f 6e5b 2244 4153   os.environ["DAS
+00023e20: 4b5f 5343 4845 4455 4c45 525f 4144 4452  K_SCHEDULER_ADDR
+00023e30: 4553 5322 5d20 3d20 7365 6c66 2e6c 6973  ESS"] = self.lis
+00023e40: 7465 6e65 7273 5b2d 315d 2e63 6f6e 7461  teners[-1].conta
+00023e50: 6374 5f61 6464 7265 7373 0a0a 2020 2020  ct_address..    
+00023e60: 2020 2020 6177 6169 7420 6173 796e 6369      await asynci
+00023e70: 6f2e 6761 7468 6572 280a 2020 2020 2020  o.gather(.      
+00023e80: 2020 2020 2020 2a5b 706c 7567 696e 2e73        *[plugin.s
+00023e90: 7461 7274 2873 656c 6629 2066 6f72 2070  tart(self) for p
+00023ea0: 6c75 6769 6e20 696e 206c 6973 7428 7365  lugin in list(se
+00023eb0: 6c66 2e70 6c75 6769 6e73 2e76 616c 7565  lf.plugins.value
+00023ec0: 7328 2929 5d0a 2020 2020 2020 2020 290a  s())].        ).
+00023ed0: 0a20 2020 2020 2020 2073 656c 662e 7374  .        self.st
+00023ee0: 6172 745f 7065 7269 6f64 6963 5f63 616c  art_periodic_cal
+00023ef0: 6c62 6163 6b73 2829 0a0a 2020 2020 2020  lbacks()..      
+00023f00: 2020 7365 7470 726f 6374 6974 6c65 2866    setproctitle(f
+00023f10: 2264 6173 6b20 7363 6865 6475 6c65 7220  "dask scheduler 
+00023f20: 5b7b 7365 6c66 2e61 6464 7265 7373 7d5d  [{self.address}]
+00023f30: 2229 0a20 2020 2020 2020 2072 6574 7572  ").        retur
+00023f40: 6e20 7365 6c66 0a0a 2020 2020 6173 796e  n self..    asyn
+00023f50: 6320 6465 6620 636c 6f73 6528 7365 6c66  c def close(self
+00023f60: 2c20 6661 7374 3d4e 6f6e 652c 2063 6c6f  , fast=None, clo
+00023f70: 7365 5f77 6f72 6b65 7273 3d4e 6f6e 652c  se_workers=None,
+00023f80: 2072 6561 736f 6e3d 2222 293a 0a20 2020   reason=""):.   
+00023f90: 2020 2020 2022 2222 5365 6e64 2063 6c65       """Send cle
+00023fa0: 616e 7570 2073 6967 6e61 6c20 746f 2061  anup signal to a
+00023fb0: 6c6c 2063 6f72 6f75 7469 6e65 7320 7468  ll coroutines th
+00023fc0: 656e 2077 6169 7420 756e 7469 6c20 6669  en wait until fi
+00023fd0: 6e69 7368 6564 0a0a 2020 2020 2020 2020  nished..        
+00023fe0: 5365 6520 416c 736f 0a20 2020 2020 2020  See Also.       
+00023ff0: 202d 2d2d 2d2d 2d2d 2d0a 2020 2020 2020   --------.      
+00024000: 2020 5363 6865 6475 6c65 722e 636c 6561    Scheduler.clea
+00024010: 6e75 700a 2020 2020 2020 2020 2222 220a  nup.        """.
+00024020: 2020 2020 2020 2020 6966 2066 6173 7420          if fast 
+00024030: 6973 206e 6f74 204e 6f6e 6520 6f72 2063  is not None or c
+00024040: 6c6f 7365 5f77 6f72 6b65 7273 2069 7320  lose_workers is 
+00024050: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+00024060: 2020 2020 2020 7761 726e 696e 6773 2e77        warnings.w
+00024070: 6172 6e28 0a20 2020 2020 2020 2020 2020  arn(.           
+00024080: 2020 2020 2022 5468 6520 2766 6173 7427       "The 'fast'
+00024090: 2061 6e64 2027 636c 6f73 655f 776f 726b   and 'close_work
+000240a0: 6572 7327 2070 6172 616d 6574 6572 7320  ers' parameters 
+000240b0: 696e 2053 6368 6564 756c 6572 2e63 6c6f  in Scheduler.clo
+000240c0: 7365 2068 6176 6520 6e6f 2022 0a20 2020  se have no ".   
+000240d0: 2020 2020 2020 2020 2020 2020 2022 6566               "ef
+000240e0: 6665 6374 2061 6e64 2077 696c 6c20 6265  fect and will be
+000240f0: 2072 656d 6f76 6564 2069 6e20 6120 6675   removed in a fu
+00024100: 7475 7265 2076 6572 7369 6f6e 206f 6620  ture version of 
+00024110: 6469 7374 7269 6275 7465 642e 222c 0a20  distributed.",. 
+00024120: 2020 2020 2020 2020 2020 2020 2020 2046                 F
+00024130: 7574 7572 6557 6172 6e69 6e67 2c0a 2020  utureWarning,.  
+00024140: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00024150: 2020 2020 6966 2073 656c 662e 7374 6174      if self.stat
+00024160: 7573 2069 6e20 2853 7461 7475 732e 636c  us in (Status.cl
+00024170: 6f73 696e 672c 2053 7461 7475 732e 636c  osing, Status.cl
+00024180: 6f73 6564 293a 0a20 2020 2020 2020 2020  osed):.         
+00024190: 2020 2061 7761 6974 2073 656c 662e 6669     await self.fi
+000241a0: 6e69 7368 6564 2829 0a20 2020 2020 2020  nished().       
+000241b0: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
+000241c0: 2020 2020 2061 7379 6e63 2064 6566 206c       async def l
+000241d0: 6f67 5f65 7272 6f72 7328 6675 6e63 293a  og_errors(func):
+000241e0: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
+000241f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00024200: 2020 6177 6169 7420 6675 6e63 2829 0a20    await func(). 
+00024210: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+00024220: 7420 4578 6365 7074 696f 6e3a 0a20 2020  t Exception:.   
+00024230: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+00024240: 6765 722e 6578 6365 7074 696f 6e28 2250  ger.exception("P
+00024250: 6c75 6769 6e20 6361 6c6c 2066 6169 6c65  lugin call faile
+00024260: 6420 6475 7269 6e67 2073 6368 6564 756c  d during schedul
+00024270: 6572 2e63 6c6f 7365 2229 0a0a 2020 2020  er.close")..    
+00024280: 2020 2020 6177 6169 7420 6173 796e 6369      await asynci
+00024290: 6f2e 6761 7468 6572 280a 2020 2020 2020  o.gather(.      
+000242a0: 2020 2020 2020 2a5b 6c6f 675f 6572 726f        *[log_erro
+000242b0: 7273 2870 6c75 6769 6e2e 6265 666f 7265  rs(plugin.before
+000242c0: 5f63 6c6f 7365 2920 666f 7220 706c 7567  _close) for plug
+000242d0: 696e 2069 6e20 6c69 7374 2873 656c 662e  in in list(self.
+000242e0: 706c 7567 696e 732e 7661 6c75 6573 2829  plugins.values()
+000242f0: 295d 0a20 2020 2020 2020 2029 0a0a 2020  )].        )..  
+00024300: 2020 2020 2020 7365 6c66 2e73 7461 7475        self.statu
+00024310: 7320 3d20 5374 6174 7573 2e63 6c6f 7369  s = Status.closi
+00024320: 6e67 0a20 2020 2020 2020 206c 6f67 6765  ng.        logge
+00024330: 722e 696e 666f 2822 5363 6865 6475 6c65  r.info("Schedule
+00024340: 7220 636c 6f73 696e 6720 6475 6520 746f  r closing due to
+00024350: 2025 732e 2e2e 222c 2072 6561 736f 6e20   %s...", reason 
+00024360: 6f72 2022 756e 6b6e 6f77 6e20 7265 6173  or "unknown reas
+00024370: 6f6e 2229 0a20 2020 2020 2020 2073 6574  on").        set
+00024380: 7072 6f63 7469 746c 6528 2264 6173 6b20  proctitle("dask 
+00024390: 7363 6865 6475 6c65 7220 5b63 6c6f 7369  scheduler [closi
+000243a0: 6e67 5d22 290a 0a20 2020 2020 2020 2061  ng]")..        a
+000243b0: 7761 6974 2073 656c 662e 7072 656c 6f61  wait self.preloa
+000243c0: 6473 2e74 6561 7264 6f77 6e28 290a 0a20  ds.teardown().. 
+000243d0: 2020 2020 2020 2061 7761 6974 2061 7379         await asy
+000243e0: 6e63 696f 2e67 6174 6865 7228 0a20 2020  ncio.gather(.   
+000243f0: 2020 2020 2020 2020 202a 5b6c 6f67 5f65           *[log_e
+00024400: 7272 6f72 7328 706c 7567 696e 2e63 6c6f  rrors(plugin.clo
+00024410: 7365 2920 666f 7220 706c 7567 696e 2069  se) for plugin i
+00024420: 6e20 6c69 7374 2873 656c 662e 706c 7567  n list(self.plug
+00024430: 696e 732e 7661 6c75 6573 2829 295d 0a20  ins.values())]. 
+00024440: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+00024450: 2020 666f 7220 7063 2069 6e20 7365 6c66    for pc in self
+00024460: 2e70 6572 696f 6469 635f 6361 6c6c 6261  .periodic_callba
+00024470: 636b 732e 7661 6c75 6573 2829 3a0a 2020  cks.values():.  
+00024480: 2020 2020 2020 2020 2020 7063 2e73 746f            pc.sto
+00024490: 7028 290a 2020 2020 2020 2020 7365 6c66  p().        self
+000244a0: 2e70 6572 696f 6469 635f 6361 6c6c 6261  .periodic_callba
+000244b0: 636b 732e 636c 6561 7228 290a 0a20 2020  cks.clear()..   
+000244c0: 2020 2020 2073 656c 662e 7374 6f70 5f73       self.stop_s
+000244d0: 6572 7669 6365 7328 290a 0a20 2020 2020  ervices()..     
+000244e0: 2020 2066 6f72 2065 7874 2069 6e20 7365     for ext in se
+000244f0: 6c66 2e65 7874 656e 7369 6f6e 732e 7661  lf.extensions.va
+00024500: 6c75 6573 2829 3a0a 2020 2020 2020 2020  lues():.        
+00024510: 2020 2020 7769 7468 2073 7570 7072 6573      with suppres
+00024520: 7328 4174 7472 6962 7574 6545 7272 6f72  s(AttributeError
+00024530: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00024540: 2020 2065 7874 2e74 6561 7264 6f77 6e28     ext.teardown(
+00024550: 290a 2020 2020 2020 2020 6c6f 6767 6572  ).        logger
+00024560: 2e69 6e66 6f28 2253 6368 6564 756c 6572  .info("Scheduler
+00024570: 2063 6c6f 7369 6e67 2061 6c6c 2063 6f6d   closing all com
+00024580: 6d73 2229 0a0a 2020 2020 2020 2020 6675  ms")..        fu
+00024590: 7475 7265 7320 3d20 5b5d 0a20 2020 2020  tures = [].     
+000245a0: 2020 2066 6f72 205f 2c20 636f 6d6d 2069     for _, comm i
+000245b0: 6e20 6c69 7374 2873 656c 662e 7374 7265  n list(self.stre
+000245c0: 616d 5f63 6f6d 6d73 2e69 7465 6d73 2829  am_comms.items()
+000245d0: 293a 0a20 2020 2020 2020 2020 2020 2023  ):.            #
+000245e0: 2046 4958 4d45 2075 7365 2060 7365 6c66   FIXME use `self
+000245f0: 2e72 656d 6f76 655f 776f 726b 6572 2829  .remove_worker()
+00024600: 6020 696e 7374 6561 6420 6166 7465 7220  ` instead after 
+00024610: 6874 7470 733a 2f2f 6769 7468 7562 2e63  https://github.c
+00024620: 6f6d 2f64 6173 6b2f 6469 7374 7269 6275  om/dask/distribu
+00024630: 7465 642f 6973 7375 6573 2f36 3339 300a  ted/issues/6390.
+00024640: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+00024650: 6f74 2063 6f6d 6d2e 636c 6f73 6564 2829  ot comm.closed()
+00024660: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00024670: 2020 2320 5468 6973 2063 6c6f 7365 7320    # This closes 
+00024680: 7468 6520 576f 726b 6572 2061 6e64 2065  the Worker and e
+00024690: 6e73 7572 6573 2074 6861 7420 6966 2061  nsures that if a
+000246a0: 204e 616e 6e79 2069 7320 6172 6f75 6e64   Nanny is around
+000246b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000246c0: 2020 2320 6974 2069 7320 636c 6f73 6564    # it is closed
+000246d0: 2061 7320 7765 6c6c 0a20 2020 2020 2020   as well.       
+000246e0: 2020 2020 2020 2020 2063 6f6d 6d2e 7365           comm.se
+000246f0: 6e64 287b 226f 7022 3a20 2263 6c6f 7365  nd({"op": "close
+00024700: 222c 2022 7265 6173 6f6e 223a 2022 7363  ", "reason": "sc
+00024710: 6865 6475 6c65 722d 636c 6f73 6522 7d29  heduler-close"})
+00024720: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00024730: 2063 6f6d 6d2e 7365 6e64 287b 226f 7022   comm.send({"op"
+00024740: 3a20 2263 6c6f 7365 2d73 7472 6561 6d22  : "close-stream"
+00024750: 7d29 0a20 2020 2020 2020 2020 2020 2020  }).             
+00024760: 2020 2023 205e 2054 4f44 4f20 7265 6d6f     # ^ TODO remo
+00024770: 7665 3f20 6057 6f72 6b65 722e 636c 6f73  ve? `Worker.clos
+00024780: 6560 2077 696c 6c20 636c 6f73 6520 7468  e` will close th
+00024790: 6520 7374 7265 616d 2061 6e79 7761 792e  e stream anyway.
+000247a0: 0a20 2020 2020 2020 2020 2020 2077 6974  .            wit
+000247b0: 6820 7375 7070 7265 7373 2841 7474 7269  h suppress(Attri
+000247c0: 6275 7465 4572 726f 7229 3a0a 2020 2020  buteError):.    
+000247d0: 2020 2020 2020 2020 2020 2020 6675 7475              futu
+000247e0: 7265 732e 6170 7065 6e64 2863 6f6d 6d2e  res.append(comm.
+000247f0: 636c 6f73 6528 2929 0a0a 2020 2020 2020  close())..      
+00024800: 2020 6177 6169 7420 6173 796e 6369 6f2e    await asyncio.
+00024810: 6761 7468 6572 282a 6675 7475 7265 7329  gather(*futures)
+00024820: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+00024830: 662e 6a75 7079 7465 723a 0a20 2020 2020  f.jupyter:.     
+00024840: 2020 2020 2020 2061 7761 6974 2073 656c         await sel
+00024850: 662e 5f6a 7570 7974 6572 5f73 6572 7665  f._jupyter_serve
+00024860: 725f 6170 706c 6963 6174 696f 6e2e 5f63  r_application._c
+00024870: 6c65 616e 7570 2829 0a0a 2020 2020 2020  leanup()..      
+00024880: 2020 666f 7220 636f 6d6d 2069 6e20 7365    for comm in se
+00024890: 6c66 2e63 6c69 656e 745f 636f 6d6d 732e  lf.client_comms.
+000248a0: 7661 6c75 6573 2829 3a0a 2020 2020 2020  values():.      
+000248b0: 2020 2020 2020 636f 6d6d 2e61 626f 7274        comm.abort
+000248c0: 2829 0a0a 2020 2020 2020 2020 6177 6169  ()..        awai
+000248d0: 7420 7365 6c66 2e72 7063 2e63 6c6f 7365  t self.rpc.close
+000248e0: 2829 0a0a 2020 2020 2020 2020 7365 6c66  ()..        self
+000248f0: 2e73 7461 7475 7320 3d20 5374 6174 7573  .status = Status
+00024900: 2e63 6c6f 7365 640a 2020 2020 2020 2020  .closed.        
+00024910: 7365 6c66 2e73 746f 7028 290a 2020 2020  self.stop().    
+00024920: 2020 2020 6177 6169 7420 7375 7065 7228      await super(
+00024930: 292e 636c 6f73 6528 290a 0a20 2020 2020  ).close()..     
+00024940: 2020 2073 6574 7072 6f63 7469 746c 6528     setproctitle(
+00024950: 2264 6173 6b20 7363 6865 6475 6c65 7220  "dask scheduler 
+00024960: 5b63 6c6f 7365 645d 2229 0a20 2020 2020  [closed]").     
+00024970: 2020 2064 6973 6162 6c65 5f67 635f 6469     disable_gc_di
+00024980: 6167 6e6f 7369 7328 290a 0a20 2020 2023  agnosis()..    #
+00024990: 2323 2323 2323 2323 2323 0a20 2020 2023  ##########.    #
+000249a0: 2053 7469 6d75 6c69 2023 0a20 2020 2023   Stimuli #.    #
+000249b0: 2323 2323 2323 2323 2323 0a0a 2020 2020  ##########..    
+000249c0: 6465 6620 6865 6172 7462 6561 745f 776f  def heartbeat_wo
+000249d0: 726b 6572 280a 2020 2020 2020 2020 7365  rker(.        se
+000249e0: 6c66 2c0a 2020 2020 2020 2020 2a2c 0a20  lf,.        *,. 
+000249f0: 2020 2020 2020 2061 6464 7265 7373 3a20         address: 
+00024a00: 7374 722c 0a20 2020 2020 2020 2072 6573  str,.        res
+00024a10: 6f6c 7665 5f61 6464 7265 7373 3a20 626f  olve_address: bo
+00024a20: 6f6c 203d 2054 7275 652c 0a20 2020 2020  ol = True,.     
+00024a30: 2020 206e 6f77 3a20 666c 6f61 7420 7c20     now: float | 
+00024a40: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
+00024a50: 2020 2020 2072 6573 6f75 7263 6573 3a20       resources: 
+00024a60: 6469 6374 5b73 7472 2c20 666c 6f61 745d  dict[str, float]
+00024a70: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
+00024a80: 2020 2020 2020 2020 686f 7374 5f69 6e66          host_inf
+00024a90: 6f3a 2064 6963 7420 7c20 4e6f 6e65 203d  o: dict | None =
+00024aa0: 204e 6f6e 652c 0a20 2020 2020 2020 206d   None,.        m
+00024ab0: 6574 7269 6373 3a20 6469 6374 2c0a 2020  etrics: dict,.  
+00024ac0: 2020 2020 2020 6578 6563 7574 696e 673a        executing:
+00024ad0: 2064 6963 745b 4b65 792c 2066 6c6f 6174   dict[Key, float
+00024ae0: 5d20 7c20 4e6f 6e65 203d 204e 6f6e 652c  ] | None = None,
+00024af0: 0a20 2020 2020 2020 2065 7874 656e 7369  .        extensi
+00024b00: 6f6e 733a 2064 6963 7420 7c20 4e6f 6e65  ons: dict | None
+00024b10: 203d 204e 6f6e 652c 0a20 2020 2029 202d   = None,.    ) -
+00024b20: 3e20 6469 6374 5b73 7472 2c20 416e 795d  > dict[str, Any]
+00024b30: 3a0a 2020 2020 2020 2020 6164 6472 6573  :.        addres
+00024b40: 7320 3d20 7365 6c66 2e63 6f65 7263 655f  s = self.coerce_
+00024b50: 6164 6472 6573 7328 6164 6472 6573 732c  address(address,
+00024b60: 2072 6573 6f6c 7665 5f61 6464 7265 7373   resolve_address
+00024b70: 290a 2020 2020 2020 2020 6164 6472 6573  ).        addres
+00024b80: 7320 3d20 6e6f 726d 616c 697a 655f 6164  s = normalize_ad
+00024b90: 6472 6573 7328 6164 6472 6573 7329 0a20  dress(address). 
+00024ba0: 2020 2020 2020 2077 7320 3d20 7365 6c66         ws = self
+00024bb0: 2e77 6f72 6b65 7273 2e67 6574 2861 6464  .workers.get(add
+00024bc0: 7265 7373 290a 2020 2020 2020 2020 6966  ress).        if
+00024bd0: 2077 7320 6973 204e 6f6e 653a 0a20 2020   ws is None:.   
+00024be0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+00024bf0: 7761 726e 696e 6728 6622 5265 6365 6976  warning(f"Receiv
+00024c00: 6564 2068 6561 7274 6265 6174 2066 726f  ed heartbeat fro
+00024c10: 6d20 756e 7265 6769 7374 6572 6564 2077  m unregistered w
+00024c20: 6f72 6b65 7220 7b61 6464 7265 7373 2172  orker {address!r
+00024c30: 7d2e 2229 0a20 2020 2020 2020 2020 2020  }.").           
+00024c40: 2072 6574 7572 6e20 7b22 7374 6174 7573   return {"status
+00024c50: 223a 2022 6d69 7373 696e 6722 7d0a 0a20  ": "missing"}.. 
+00024c60: 2020 2020 2020 2068 6f73 7420 3d20 6765         host = ge
+00024c70: 745f 6164 6472 6573 735f 686f 7374 2861  t_address_host(a
+00024c80: 6464 7265 7373 290a 2020 2020 2020 2020  ddress).        
+00024c90: 6c6f 6361 6c5f 6e6f 7720 3d20 7469 6d65  local_now = time
+00024ca0: 2829 0a20 2020 2020 2020 2068 6f73 745f  ().        host_
+00024cb0: 696e 666f 203d 2068 6f73 745f 696e 666f  info = host_info
+00024cc0: 206f 7220 7b7d 0a0a 2020 2020 2020 2020   or {}..        
+00024cd0: 6468 203d 2073 656c 662e 686f 7374 5f69  dh = self.host_i
+00024ce0: 6e66 6f2e 7365 7464 6566 6175 6c74 2868  nfo.setdefault(h
+00024cf0: 6f73 742c 207b 7d29 0a20 2020 2020 2020  ost, {}).       
+00024d00: 2064 685b 226c 6173 742d 7365 656e 225d   dh["last-seen"]
+00024d10: 203d 206c 6f63 616c 5f6e 6f77 0a0a 2020   = local_now..  
+00024d20: 2020 2020 2020 6672 6163 203d 2031 202f        frac = 1 /
+00024d30: 206c 656e 2873 656c 662e 776f 726b 6572   len(self.worker
+00024d40: 7329 0a20 2020 2020 2020 2073 656c 662e  s).        self.
+00024d50: 6261 6e64 7769 6474 6820 3d20 280a 2020  bandwidth = (.  
+00024d60: 2020 2020 2020 2020 2020 7365 6c66 2e62            self.b
+00024d70: 616e 6477 6964 7468 202a 2028 3120 2d20  andwidth * (1 - 
+00024d80: 6672 6163 2920 2b20 6d65 7472 6963 735b  frac) + metrics[
+00024d90: 2262 616e 6477 6964 7468 225d 5b22 746f  "bandwidth"]["to
+00024da0: 7461 6c22 5d20 2a20 6672 6163 0a20 2020  tal"] * frac.   
+00024db0: 2020 2020 2029 0a20 2020 2020 2020 2066       ).        f
+00024dc0: 6f72 206f 7468 6572 2c20 2862 772c 2063  or other, (bw, c
+00024dd0: 6f75 6e74 2920 696e 206d 6574 7269 6373  ount) in metrics
+00024de0: 5b22 6261 6e64 7769 6474 6822 5d5b 2277  ["bandwidth"]["w
+00024df0: 6f72 6b65 7273 225d 2e69 7465 6d73 2829  orkers"].items()
+00024e00: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00024e10: 2028 6164 6472 6573 732c 206f 7468 6572   (address, other
+00024e20: 2920 6e6f 7420 696e 2073 656c 662e 6261  ) not in self.ba
+00024e30: 6e64 7769 6474 685f 776f 726b 6572 733a  ndwidth_workers:
+00024e40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00024e50: 2073 656c 662e 6261 6e64 7769 6474 685f   self.bandwidth_
+00024e60: 776f 726b 6572 735b 6164 6472 6573 732c  workers[address,
+00024e70: 206f 7468 6572 5d20 3d20 6277 202f 2063   other] = bw / c
+00024e80: 6f75 6e74 0a20 2020 2020 2020 2020 2020  ount.           
+00024e90: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00024ea0: 2020 2020 2020 2061 6c70 6861 203d 2028         alpha = (
+00024eb0: 3120 2d20 6672 6163 2920 2a2a 2063 6f75  1 - frac) ** cou
+00024ec0: 6e74 0a20 2020 2020 2020 2020 2020 2020  nt.             
+00024ed0: 2020 2073 656c 662e 6261 6e64 7769 6474     self.bandwidt
+00024ee0: 685f 776f 726b 6572 735b 6164 6472 6573  h_workers[addres
+00024ef0: 732c 206f 7468 6572 5d20 3d20 7365 6c66  s, other] = self
+00024f00: 2e62 616e 6477 6964 7468 5f77 6f72 6b65  .bandwidth_worke
+00024f10: 7273 5b0a 2020 2020 2020 2020 2020 2020  rs[.            
+00024f20: 2020 2020 2020 2020 6164 6472 6573 732c          address,
+00024f30: 206f 7468 6572 0a20 2020 2020 2020 2020   other.         
+00024f40: 2020 2020 2020 205d 202a 2061 6c70 6861         ] * alpha
+00024f50: 202b 2062 7720 2a20 2831 202d 2061 6c70   + bw * (1 - alp
+00024f60: 6861 290a 2020 2020 2020 2020 666f 7220  ha).        for 
+00024f70: 7479 702c 2028 6277 2c20 636f 756e 7429  typ, (bw, count)
+00024f80: 2069 6e20 6d65 7472 6963 735b 2262 616e   in metrics["ban
+00024f90: 6477 6964 7468 225d 5b22 7479 7065 7322  dwidth"]["types"
+00024fa0: 5d2e 6974 656d 7328 293a 0a20 2020 2020  ].items():.     
+00024fb0: 2020 2020 2020 2069 6620 7479 7020 6e6f         if typ no
+00024fc0: 7420 696e 2073 656c 662e 6261 6e64 7769  t in self.bandwi
+00024fd0: 6474 685f 7479 7065 733a 0a20 2020 2020  dth_types:.     
+00024fe0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00024ff0: 6261 6e64 7769 6474 685f 7479 7065 735b  bandwidth_types[
+00025000: 7479 705d 203d 2062 7720 2f20 636f 756e  typ] = bw / coun
+00025010: 740a 2020 2020 2020 2020 2020 2020 656c  t.            el
+00025020: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00025030: 2020 2020 616c 7068 6120 3d20 2831 202d      alpha = (1 -
+00025040: 2066 7261 6329 202a 2a20 636f 756e 740a   frac) ** count.
+00025050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025060: 7365 6c66 2e62 616e 6477 6964 7468 5f74  self.bandwidth_t
+00025070: 7970 6573 5b74 7970 5d20 3d20 7365 6c66  ypes[typ] = self
+00025080: 2e62 616e 6477 6964 7468 5f74 7970 6573  .bandwidth_types
+00025090: 5b74 7970 5d20 2a20 616c 7068 6120 2b20  [typ] * alpha + 
+000250a0: 6277 202a 2028 0a20 2020 2020 2020 2020  bw * (.         
+000250b0: 2020 2020 2020 2020 2020 2031 202d 2061             1 - a
+000250c0: 6c70 6861 0a20 2020 2020 2020 2020 2020  lpha.           
+000250d0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+000250e0: 7773 2e6c 6173 745f 7365 656e 203d 206c  ws.last_seen = l
+000250f0: 6f63 616c 5f6e 6f77 0a20 2020 2020 2020  ocal_now.       
+00025100: 2069 6620 6578 6563 7574 696e 6720 6973   if executing is
+00025110: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00025120: 2020 2020 2020 2023 204e 4f54 453a 2074         # NOTE: t
+00025130: 6865 2065 7865 6375 7469 6e67 2064 6963  he executing dic
+00025140: 7420 6973 2075 6e75 7365 640a 2020 2020  t is unused.    
+00025150: 2020 2020 2020 2020 7773 2e65 7865 6375          ws.execu
+00025160: 7469 6e67 203d 207b 7d0a 2020 2020 2020  ting = {}.      
+00025170: 2020 2020 2020 666f 7220 6b65 792c 2064        for key, d
+00025180: 7572 6174 696f 6e20 696e 2065 7865 6375  uration in execu
+00025190: 7469 6e67 2e69 7465 6d73 2829 3a0a 2020  ting.items():.  
+000251a0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+000251b0: 206b 6579 2069 6e20 7365 6c66 2e74 6173   key in self.tas
+000251c0: 6b73 3a0a 2020 2020 2020 2020 2020 2020  ks:.            
+000251d0: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
+000251e0: 662e 7461 736b 735b 6b65 795d 0a20 2020  f.tasks[key].   
+000251f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025200: 2077 732e 6578 6563 7574 696e 675b 7473   ws.executing[ts
+00025210: 5d20 3d20 6475 7261 7469 6f6e 0a20 2020  ] = duration.   
+00025220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025230: 2074 732e 7072 6566 6978 2e61 6464 5f65   ts.prefix.add_e
+00025240: 7865 635f 7469 6d65 2864 7572 6174 696f  xec_time(duratio
+00025250: 6e29 0a0a 2020 2020 2020 2020 666f 7220  n)..        for 
+00025260: 6e61 6d65 2c20 7661 6c75 6520 696e 206d  name, value in m
+00025270: 6574 7269 6373 5b22 6469 6765 7374 735f  etrics["digests_
+00025280: 746f 7461 6c5f 7369 6e63 655f 6865 6172  total_since_hear
+00025290: 7462 6561 7422 5d2e 6974 656d 7328 293a  tbeat"].items():
+000252a0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000252b0: 662e 6375 6d75 6c61 7469 7665 5f77 6f72  f.cumulative_wor
+000252c0: 6b65 725f 6d65 7472 6963 735b 6e61 6d65  ker_metrics[name
+000252d0: 5d20 2b3d 2076 616c 7565 0a0a 2020 2020  ] += value..    
+000252e0: 2020 2020 7773 2e6d 6574 7269 6373 203d      ws.metrics =
+000252f0: 206d 6574 7269 6373 0a0a 2020 2020 2020   metrics..      
+00025300: 2020 2320 4361 6c63 756c 6174 6520 5253    # Calculate RS
+00025310: 5320 2d20 6461 736b 206b 6579 732c 2073  S - dask keys, s
+00025320: 6570 6172 6174 696e 6720 226f 6c64 2220  eparating "old" 
+00025330: 616e 6420 226e 6577 2220 7573 6167 650a  and "new" usage.
+00025340: 2020 2020 2020 2020 2320 5365 6520 4d65          # See Me
+00025350: 6d6f 7279 5374 6174 6520 666f 7220 6465  moryState for de
+00025360: 7461 696c 730a 2020 2020 2020 2020 6d61  tails.        ma
+00025370: 785f 6d65 6d6f 7279 5f75 6e6d 616e 6167  x_memory_unmanag
+00025380: 6564 5f6f 6c64 5f68 6973 745f 6167 6520  ed_old_hist_age 
+00025390: 3d20 6c6f 6361 6c5f 6e6f 7720 2d20 7365  = local_now - se
+000253a0: 6c66 2e4d 454d 4f52 595f 5245 4345 4e54  lf.MEMORY_RECENT
+000253b0: 5f54 4f5f 4f4c 445f 5449 4d45 0a20 2020  _TO_OLD_TIME.   
+000253c0: 2020 2020 206d 656d 6f72 795f 756e 6d61       memory_unma
+000253d0: 6e61 6765 645f 6f6c 6420 3d20 7773 2e5f  naged_old = ws._
+000253e0: 6d65 6d6f 7279 5f75 6e6d 616e 6167 6564  memory_unmanaged
+000253f0: 5f6f 6c64 0a20 2020 2020 2020 2077 6869  _old.        whi
+00025400: 6c65 2077 732e 5f6d 656d 6f72 795f 756e  le ws._memory_un
+00025410: 6d61 6e61 6765 645f 6869 7374 6f72 793a  managed_history:
+00025420: 0a20 2020 2020 2020 2020 2020 2074 696d  .            tim
+00025430: 6573 7461 6d70 2c20 7369 7a65 203d 2077  estamp, size = w
+00025440: 732e 5f6d 656d 6f72 795f 756e 6d61 6e61  s._memory_unmana
+00025450: 6765 645f 6869 7374 6f72 795b 305d 0a20  ged_history[0]. 
+00025460: 2020 2020 2020 2020 2020 2069 6620 7469             if ti
+00025470: 6d65 7374 616d 7020 3e3d 206d 6178 5f6d  mestamp >= max_m
+00025480: 656d 6f72 795f 756e 6d61 6e61 6765 645f  emory_unmanaged_
+00025490: 6f6c 645f 6869 7374 5f61 6765 3a0a 2020  old_hist_age:.  
+000254a0: 2020 2020 2020 2020 2020 2020 2020 6272                br
+000254b0: 6561 6b0a 2020 2020 2020 2020 2020 2020  eak.            
+000254c0: 7773 2e5f 6d65 6d6f 7279 5f75 6e6d 616e  ws._memory_unman
+000254d0: 6167 6564 5f68 6973 746f 7279 2e70 6f70  aged_history.pop
+000254e0: 6c65 6674 2829 0a20 2020 2020 2020 2020  left().         
+000254f0: 2020 2069 6620 7369 7a65 203d 3d20 6d65     if size == me
+00025500: 6d6f 7279 5f75 6e6d 616e 6167 6564 5f6f  mory_unmanaged_o
+00025510: 6c64 3a0a 2020 2020 2020 2020 2020 2020  ld:.            
+00025520: 2020 2020 6d65 6d6f 7279 5f75 6e6d 616e      memory_unman
+00025530: 6167 6564 5f6f 6c64 203d 2030 2020 2320  aged_old = 0  # 
+00025540: 7265 6361 6c63 756c 6174 6520 6d69 6e28  recalculate min(
+00025550: 290a 0a20 2020 2020 2020 2023 2077 732e  )..        # ws.
+00025560: 5f6e 6279 7465 7320 6973 2075 7064 6174  _nbytes is updat
+00025570: 6564 2061 7420 6120 6469 6666 6572 656e  ed at a differen
+00025580: 7420 7469 6d65 2061 6e64 2073 697a 656f  t time and sizeo
+00025590: 6628 2920 6d61 7920 6e6f 7420 6265 2061  f() may not be a
+000255a0: 6363 7572 6174 652c 0a20 2020 2020 2020  ccurate,.       
+000255b0: 2023 2073 6f20 7369 7a65 206d 6179 2062   # so size may b
+000255c0: 6520 2874 656d 706f 7261 7269 6c79 2920  e (temporarily) 
+000255d0: 6e65 6761 7469 7665 3b20 666c 6f6f 7220  negative; floor 
+000255e0: 6974 2074 6f20 7a65 726f 2e0a 2020 2020  it to zero..    
+000255f0: 2020 2020 7369 7a65 203d 206d 6178 280a      size = max(.
+00025600: 2020 2020 2020 2020 2020 2020 302c 206d              0, m
+00025610: 6574 7269 6373 5b22 6d65 6d6f 7279 225d  etrics["memory"]
+00025620: 202d 2077 732e 6e62 7974 6573 202b 206d   - ws.nbytes + m
+00025630: 6574 7269 6373 5b22 7370 696c 6c65 645f  etrics["spilled_
+00025640: 6279 7465 7322 5d5b 226d 656d 6f72 7922  bytes"]["memory"
+00025650: 5d0a 2020 2020 2020 2020 290a 0a20 2020  ].        )..   
+00025660: 2020 2020 2077 732e 5f6d 656d 6f72 795f       ws._memory_
+00025670: 756e 6d61 6e61 6765 645f 6869 7374 6f72  unmanaged_histor
+00025680: 792e 6170 7065 6e64 2828 6c6f 6361 6c5f  y.append((local_
+00025690: 6e6f 772c 2073 697a 6529 290a 2020 2020  now, size)).    
+000256a0: 2020 2020 6966 206e 6f74 206d 656d 6f72      if not memor
+000256b0: 795f 756e 6d61 6e61 6765 645f 6f6c 643a  y_unmanaged_old:
+000256c0: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
+000256d0: 6865 2077 6f72 6b65 7220 6861 7320 6a75  he worker has ju
+000256e0: 7374 2062 6565 6e20 7374 6172 7465 6420  st been started 
+000256f0: 6f72 2074 6865 2070 7265 7669 6f75 7320  or the previous 
+00025700: 6d69 6e69 6d75 6d20 6861 7320 6265 656e  minimum has been
+00025710: 2065 7870 756e 6765 640a 2020 2020 2020   expunged.      
+00025720: 2020 2020 2020 2320 6265 6361 7573 6520        # because 
+00025730: 746f 6f20 6f6c 642e 0a20 2020 2020 2020  too old..       
+00025740: 2020 2020 2023 204e 6f74 653a 2074 6869       # Note: thi
+00025750: 7320 616c 676f 7269 7468 6d20 6973 2063  s algorithm is c
+00025760: 6170 7065 6420 746f 2032 3030 202a 204d  apped to 200 * M
+00025770: 454d 4f52 595f 5245 4345 4e54 5f54 4f5f  EMORY_RECENT_TO_
+00025780: 4f4c 445f 5449 4d45 2065 6c65 6d65 6e74  OLD_TIME element
+00025790: 730a 2020 2020 2020 2020 2020 2020 2320  s.            # 
+000257a0: 636c 7573 7465 722d 7769 6465 2062 7920  cluster-wide by 
+000257b0: 6865 6172 7462 6561 745f 696e 7465 7276  heartbeat_interv
+000257c0: 616c 2829 2c20 7265 6761 7264 6c65 7373  al(), regardless
+000257d0: 206f 6620 7468 6520 6e75 6d62 6572 206f   of the number o
+000257e0: 6620 776f 726b 6572 730a 2020 2020 2020  f workers.      
+000257f0: 2020 2020 2020 7773 2e5f 6d65 6d6f 7279        ws._memory
+00025800: 5f75 6e6d 616e 6167 6564 5f6f 6c64 203d  _unmanaged_old =
+00025810: 206d 696e 286d 6170 2873 6563 6f6e 642c   min(map(second,
+00025820: 2077 732e 5f6d 656d 6f72 795f 756e 6d61   ws._memory_unma
+00025830: 6e61 6765 645f 6869 7374 6f72 7929 290a  naged_history)).
+00025840: 2020 2020 2020 2020 656c 6966 2073 697a          elif siz
+00025850: 6520 3c20 6d65 6d6f 7279 5f75 6e6d 616e  e < memory_unman
+00025860: 6167 6564 5f6f 6c64 3a0a 2020 2020 2020  aged_old:.      
+00025870: 2020 2020 2020 7773 2e5f 6d65 6d6f 7279        ws._memory
+00025880: 5f75 6e6d 616e 6167 6564 5f6f 6c64 203d  _unmanaged_old =
+00025890: 2073 697a 650a 0a20 2020 2020 2020 2069   size..        i
+000258a0: 6620 686f 7374 5f69 6e66 6f3a 0a20 2020  f host_info:.   
+000258b0: 2020 2020 2020 2020 2064 6820 3d20 7365           dh = se
+000258c0: 6c66 2e68 6f73 745f 696e 666f 2e73 6574  lf.host_info.set
+000258d0: 6465 6661 756c 7428 686f 7374 2c20 7b7d  default(host, {}
+000258e0: 290a 2020 2020 2020 2020 2020 2020 6468  ).            dh
+000258f0: 2e75 7064 6174 6528 686f 7374 5f69 6e66  .update(host_inf
+00025900: 6f29 0a0a 2020 2020 2020 2020 6966 206e  o)..        if n
+00025910: 6f77 3a0a 2020 2020 2020 2020 2020 2020  ow:.            
+00025920: 7773 2e74 696d 655f 6465 6c61 7920 3d20  ws.time_delay = 
+00025930: 6c6f 6361 6c5f 6e6f 7720 2d20 6e6f 770a  local_now - now.
+00025940: 0a20 2020 2020 2020 2069 6620 7265 736f  .        if reso
+00025950: 7572 6365 733a 0a20 2020 2020 2020 2020  urces:.         
+00025960: 2020 2073 656c 662e 6164 645f 7265 736f     self.add_reso
+00025970: 7572 6365 7328 776f 726b 6572 3d61 6464  urces(worker=add
+00025980: 7265 7373 2c20 7265 736f 7572 6365 733d  ress, resources=
+00025990: 7265 736f 7572 6365 7329 0a0a 2020 2020  resources)..    
+000259a0: 2020 2020 6966 2065 7874 656e 7369 6f6e      if extension
+000259b0: 733a 0a20 2020 2020 2020 2020 2020 2066  s:.            f
+000259c0: 6f72 206e 616d 652c 2064 6174 6120 696e  or name, data in
+000259d0: 2065 7874 656e 7369 6f6e 732e 6974 656d   extensions.item
+000259e0: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+000259f0: 2020 2020 2073 656c 662e 6578 7465 6e73       self.extens
+00025a00: 696f 6e73 5b6e 616d 655d 2e68 6561 7274  ions[name].heart
+00025a10: 6265 6174 2877 732c 2064 6174 6129 0a0a  beat(ws, data)..
+00025a20: 2020 2020 2020 2020 7265 7475 726e 207b          return {
+00025a30: 0a20 2020 2020 2020 2020 2020 2022 7374  .            "st
+00025a40: 6174 7573 223a 2022 4f4b 222c 0a20 2020  atus": "OK",.   
+00025a50: 2020 2020 2020 2020 2022 7469 6d65 223a           "time":
+00025a60: 206c 6f63 616c 5f6e 6f77 2c0a 2020 2020   local_now,.    
+00025a70: 2020 2020 2020 2020 2268 6561 7274 6265          "heartbe
+00025a80: 6174 2d69 6e74 6572 7661 6c22 3a20 6865  at-interval": he
+00025a90: 6172 7462 6561 745f 696e 7465 7276 616c  artbeat_interval
+00025aa0: 286c 656e 2873 656c 662e 776f 726b 6572  (len(self.worker
+00025ab0: 7329 292c 0a20 2020 2020 2020 207d 0a0a  s)),.        }..
+00025ac0: 2020 2020 406c 6f67 5f65 7272 6f72 730a      @log_errors.
+00025ad0: 2020 2020 6173 796e 6320 6465 6620 6164      async def ad
+00025ae0: 645f 776f 726b 6572 280a 2020 2020 2020  d_worker(.      
+00025af0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+00025b00: 636f 6d6d 3a20 436f 6d6d 2c0a 2020 2020  comm: Comm,.    
+00025b10: 2020 2020 2a2c 0a20 2020 2020 2020 2061      *,.        a
+00025b20: 6464 7265 7373 3a20 7374 722c 0a20 2020  ddress: str,.   
+00025b30: 2020 2020 2073 7461 7475 733a 2073 7472       status: str
+00025b40: 2c0a 2020 2020 2020 2020 7365 7276 6572  ,.        server
+00025b50: 5f69 643a 2073 7472 2c0a 2020 2020 2020  _id: str,.      
+00025b60: 2020 6e74 6872 6561 6473 3a20 696e 742c    nthreads: int,
+00025b70: 0a20 2020 2020 2020 206e 616d 653a 2073  .        name: s
+00025b80: 7472 2c0a 2020 2020 2020 2020 7265 736f  tr,.        reso
+00025b90: 6c76 655f 6164 6472 6573 733a 2062 6f6f  lve_address: boo
+00025ba0: 6c20 3d20 5472 7565 2c0a 2020 2020 2020  l = True,.      
+00025bb0: 2020 6e6f 773a 2066 6c6f 6174 2c0a 2020    now: float,.  
+00025bc0: 2020 2020 2020 7265 736f 7572 6365 733a        resources:
+00025bd0: 2064 6963 745b 7374 722c 2066 6c6f 6174   dict[str, float
+00025be0: 5d2c 0a20 2020 2020 2020 2023 2046 4958  ],.        # FIX
+00025bf0: 4d45 3a20 5468 6973 2069 7320 6e65 7665  ME: This is neve
+00025c00: 7220 7375 626d 6974 7465 6420 6279 2074  r submitted by t
+00025c10: 6865 2077 6f72 6b65 720a 2020 2020 2020  he worker.      
+00025c20: 2020 686f 7374 5f69 6e66 6f3a 204e 6f6e    host_info: Non
+00025c30: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
+00025c40: 2020 6d65 6d6f 7279 5f6c 696d 6974 3a20    memory_limit: 
+00025c50: 696e 7420 7c20 4e6f 6e65 2c0a 2020 2020  int | None,.    
+00025c60: 2020 2020 6d65 7472 6963 733a 2064 6963      metrics: dic
+00025c70: 745b 7374 722c 2041 6e79 5d2c 0a20 2020  t[str, Any],.   
+00025c80: 2020 2020 2070 6964 3a20 696e 7420 3d20       pid: int = 
+00025c90: 302c 0a20 2020 2020 2020 2073 6572 7669  0,.        servi
+00025ca0: 6365 733a 2064 6963 745b 7374 722c 2069  ces: dict[str, i
+00025cb0: 6e74 5d2c 0a20 2020 2020 2020 206c 6f63  nt],.        loc
+00025cc0: 616c 5f64 6972 6563 746f 7279 3a20 7374  al_directory: st
+00025cd0: 722c 0a20 2020 2020 2020 2076 6572 7369  r,.        versi
+00025ce0: 6f6e 733a 2064 6963 745b 7374 722c 2041  ons: dict[str, A
+00025cf0: 6e79 5d2c 0a20 2020 2020 2020 206e 616e  ny],.        nan
+00025d00: 6e79 3a20 7374 722c 0a20 2020 2020 2020  ny: str,.       
+00025d10: 2065 7874 7261 3a20 6469 6374 2c0a 2020   extra: dict,.  
+00025d20: 2020 2020 2020 7374 696d 756c 7573 5f69        stimulus_i
+00025d30: 643a 2073 7472 2c0a 2020 2020 2920 2d3e  d: str,.    ) ->
+00025d40: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
+00025d50: 2222 4164 6420 6120 6e65 7720 776f 726b  ""Add a new work
+00025d60: 6572 2074 6f20 7468 6520 636c 7573 7465  er to the cluste
+00025d70: 7222 2222 0a20 2020 2020 2020 2061 6464  r""".        add
+00025d80: 7265 7373 203d 2073 656c 662e 636f 6572  ress = self.coer
+00025d90: 6365 5f61 6464 7265 7373 2861 6464 7265  ce_address(addre
+00025da0: 7373 2c20 7265 736f 6c76 655f 6164 6472  ss, resolve_addr
+00025db0: 6573 7329 0a20 2020 2020 2020 2061 6464  ess).        add
+00025dc0: 7265 7373 203d 206e 6f72 6d61 6c69 7a65  ress = normalize
+00025dd0: 5f61 6464 7265 7373 2861 6464 7265 7373  _address(address
+00025de0: 290a 2020 2020 2020 2020 686f 7374 203d  ).        host =
+00025df0: 2067 6574 5f61 6464 7265 7373 5f68 6f73   get_address_hos
+00025e00: 7428 6164 6472 6573 7329 0a0a 2020 2020  t(address)..    
+00025e10: 2020 2020 6966 2061 6464 7265 7373 2069      if address i
+00025e20: 6e20 7365 6c66 2e77 6f72 6b65 7273 3a0a  n self.workers:.
+00025e30: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00025e40: 6520 5661 6c75 6545 7272 6f72 2822 576f  e ValueError("Wo
+00025e50: 726b 6572 2061 6c72 6561 6479 2065 7869  rker already exi
+00025e60: 7374 7320 2573 2220 2520 6164 6472 6573  sts %s" % addres
+00025e70: 7329 0a0a 2020 2020 2020 2020 6966 206e  s)..        if n
+00025e80: 616d 6520 696e 2073 656c 662e 616c 6961  ame in self.alia
+00025e90: 7365 733a 0a20 2020 2020 2020 2020 2020  ses:.           
+00025ea0: 206c 6f67 6765 722e 7761 726e 696e 6728   logger.warning(
+00025eb0: 2257 6f72 6b65 7220 7472 6965 6420 746f  "Worker tried to
+00025ec0: 2063 6f6e 6e65 6374 2077 6974 6820 6120   connect with a 
+00025ed0: 6475 706c 6963 6174 6520 6e61 6d65 3a20  duplicate name: 
+00025ee0: 2573 222c 206e 616d 6529 0a20 2020 2020  %s", name).     
+00025ef0: 2020 2020 2020 206d 7367 203d 207b 0a20         msg = {. 
+00025f00: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00025f10: 7374 6174 7573 223a 2022 6572 726f 7222  status": "error"
+00025f20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00025f30: 2020 226d 6573 7361 6765 223a 2022 6e61    "message": "na
+00025f40: 6d65 2074 616b 656e 2c20 2573 2220 2520  me taken, %s" % 
+00025f50: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
+00025f60: 2020 2020 2020 2274 696d 6522 3a20 7469        "time": ti
+00025f70: 6d65 2829 2c0a 2020 2020 2020 2020 2020  me(),.          
+00025f80: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00025f90: 6177 6169 7420 636f 6d6d 2e77 7269 7465  await comm.write
+00025fa0: 286d 7367 290a 2020 2020 2020 2020 2020  (msg).          
+00025fb0: 2020 7265 7475 726e 0a0a 2020 2020 2020    return..      
+00025fc0: 2020 7365 6c66 2e6c 6f67 5f65 7665 6e74    self.log_event
+00025fd0: 2861 6464 7265 7373 2c20 7b22 6163 7469  (address, {"acti
+00025fe0: 6f6e 223a 2022 6164 642d 776f 726b 6572  on": "add-worker
+00025ff0: 227d 290a 2020 2020 2020 2020 7365 6c66  "}).        self
+00026000: 2e6c 6f67 5f65 7665 6e74 2822 616c 6c22  .log_event("all"
+00026010: 2c20 7b22 6163 7469 6f6e 223a 2022 6164  , {"action": "ad
+00026020: 642d 776f 726b 6572 222c 2022 776f 726b  d-worker", "work
+00026030: 6572 223a 2061 6464 7265 7373 7d29 0a0a  er": address})..
+00026040: 2020 2020 2020 2020 7365 6c66 2e77 6f72          self.wor
+00026050: 6b65 7273 5b61 6464 7265 7373 5d20 3d20  kers[address] = 
+00026060: 7773 203d 2057 6f72 6b65 7253 7461 7465  ws = WorkerState
+00026070: 280a 2020 2020 2020 2020 2020 2020 6164  (.            ad
+00026080: 6472 6573 733d 6164 6472 6573 732c 0a20  dress=address,. 
+00026090: 2020 2020 2020 2020 2020 2073 7461 7475             statu
+000260a0: 733d 5374 6174 7573 2e6c 6f6f 6b75 705b  s=Status.lookup[
+000260b0: 7374 6174 7573 5d2c 2020 2320 7479 7065  status],  # type
+000260c0: 3a20 6967 6e6f 7265 0a20 2020 2020 2020  : ignore.       
+000260d0: 2020 2020 2070 6964 3d70 6964 2c0a 2020       pid=pid,.  
+000260e0: 2020 2020 2020 2020 2020 6e74 6872 6561            nthrea
+000260f0: 6473 3d6e 7468 7265 6164 732c 0a20 2020  ds=nthreads,.   
+00026100: 2020 2020 2020 2020 206d 656d 6f72 795f           memory_
+00026110: 6c69 6d69 743d 6d65 6d6f 7279 5f6c 696d  limit=memory_lim
+00026120: 6974 206f 7220 302c 0a20 2020 2020 2020  it or 0,.       
+00026130: 2020 2020 206e 616d 653d 6e61 6d65 2c0a       name=name,.
+00026140: 2020 2020 2020 2020 2020 2020 6c6f 6361              loca
+00026150: 6c5f 6469 7265 6374 6f72 793d 6c6f 6361  l_directory=loca
+00026160: 6c5f 6469 7265 6374 6f72 792c 0a20 2020  l_directory,.   
+00026170: 2020 2020 2020 2020 2073 6572 7669 6365           service
+00026180: 733d 7365 7276 6963 6573 2c0a 2020 2020  s=services,.    
+00026190: 2020 2020 2020 2020 7665 7273 696f 6e73          versions
+000261a0: 3d76 6572 7369 6f6e 732c 0a20 2020 2020  =versions,.     
+000261b0: 2020 2020 2020 206e 616e 6e79 3d6e 616e         nanny=nan
+000261c0: 6e79 2c0a 2020 2020 2020 2020 2020 2020  ny,.            
+000261d0: 6578 7472 613d 6578 7472 612c 0a20 2020  extra=extra,.   
+000261e0: 2020 2020 2020 2020 2073 6572 7665 725f           server_
+000261f0: 6964 3d73 6572 7665 725f 6964 2c0a 2020  id=server_id,.  
+00026200: 2020 2020 2020 2020 2020 7363 6865 6475            schedu
+00026210: 6c65 723d 7365 6c66 2c0a 2020 2020 2020  ler=self,.      
+00026220: 2020 290a 2020 2020 2020 2020 6966 2077    ).        if w
+00026230: 732e 7374 6174 7573 203d 3d20 5374 6174  s.status == Stat
+00026240: 7573 2e72 756e 6e69 6e67 3a0a 2020 2020  us.running:.    
+00026250: 2020 2020 2020 2020 7365 6c66 2e72 756e          self.run
+00026260: 6e69 6e67 2e61 6464 2877 7329 0a0a 2020  ning.add(ws)..  
+00026270: 2020 2020 2020 6468 203d 2073 656c 662e        dh = self.
+00026280: 686f 7374 5f69 6e66 6f2e 6765 7428 686f  host_info.get(ho
+00026290: 7374 290a 2020 2020 2020 2020 6966 2064  st).        if d
+000262a0: 6820 6973 204e 6f6e 653a 0a20 2020 2020  h is None:.     
+000262b0: 2020 2020 2020 2073 656c 662e 686f 7374         self.host
+000262c0: 5f69 6e66 6f5b 686f 7374 5d20 3d20 6468  _info[host] = dh
+000262d0: 203d 207b 7d0a 0a20 2020 2020 2020 2064   = {}..        d
+000262e0: 685f 6164 6472 6573 7365 7320 3d20 6468  h_addresses = dh
+000262f0: 2e67 6574 2822 6164 6472 6573 7365 7322  .get("addresses"
+00026300: 290a 2020 2020 2020 2020 6966 2064 685f  ).        if dh_
+00026310: 6164 6472 6573 7365 7320 6973 204e 6f6e  addresses is Non
+00026320: 653a 0a20 2020 2020 2020 2020 2020 2064  e:.            d
+00026330: 685b 2261 6464 7265 7373 6573 225d 203d  h["addresses"] =
+00026340: 2064 685f 6164 6472 6573 7365 7320 3d20   dh_addresses = 
+00026350: 7365 7428 290a 2020 2020 2020 2020 2020  set().          
+00026360: 2020 6468 5b22 6e74 6872 6561 6473 225d    dh["nthreads"]
+00026370: 203d 2030 0a0a 2020 2020 2020 2020 6468   = 0..        dh
+00026380: 5f61 6464 7265 7373 6573 2e61 6464 2861  _addresses.add(a
+00026390: 6464 7265 7373 290a 2020 2020 2020 2020  ddress).        
+000263a0: 6468 5b22 6e74 6872 6561 6473 225d 202b  dh["nthreads"] +
+000263b0: 3d20 6e74 6872 6561 6473 0a0a 2020 2020  = nthreads..    
+000263c0: 2020 2020 7365 6c66 2e74 6f74 616c 5f6e      self.total_n
+000263d0: 7468 7265 6164 7320 2b3d 206e 7468 7265  threads += nthre
+000263e0: 6164 730a 2020 2020 2020 2020 7365 6c66  ads.        self
+000263f0: 2e74 6f74 616c 5f6e 7468 7265 6164 735f  .total_nthreads_
+00026400: 6869 7374 6f72 792e 6170 7065 6e64 2828  history.append((
+00026410: 7469 6d65 2829 2c20 7365 6c66 2e74 6f74  time(), self.tot
+00026420: 616c 5f6e 7468 7265 6164 7329 290a 2020  al_nthreads)).  
+00026430: 2020 2020 2020 7365 6c66 2e61 6c69 6173        self.alias
+00026440: 6573 5b6e 616d 655d 203d 2061 6464 7265  es[name] = addre
+00026450: 7373 0a0a 2020 2020 2020 2020 7365 6c66  ss..        self
+00026460: 2e68 6561 7274 6265 6174 5f77 6f72 6b65  .heartbeat_worke
+00026470: 7228 0a20 2020 2020 2020 2020 2020 2061  r(.            a
+00026480: 6464 7265 7373 3d61 6464 7265 7373 2c0a  ddress=address,.
+00026490: 2020 2020 2020 2020 2020 2020 7265 736f              reso
+000264a0: 6c76 655f 6164 6472 6573 733d 7265 736f  lve_address=reso
+000264b0: 6c76 655f 6164 6472 6573 732c 0a20 2020  lve_address,.   
+000264c0: 2020 2020 2020 2020 206e 6f77 3d6e 6f77           now=now
+000264d0: 2c0a 2020 2020 2020 2020 2020 2020 7265  ,.            re
+000264e0: 736f 7572 6365 733d 7265 736f 7572 6365  sources=resource
+000264f0: 732c 0a20 2020 2020 2020 2020 2020 2068  s,.            h
+00026500: 6f73 745f 696e 666f 3d68 6f73 745f 696e  ost_info=host_in
+00026510: 666f 2c0a 2020 2020 2020 2020 2020 2020  fo,.            
+00026520: 6d65 7472 6963 733d 6d65 7472 6963 732c  metrics=metrics,
+00026530: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+00026540: 2020 2020 2320 446f 206e 6f74 206e 6565      # Do not nee
+00026550: 6420 746f 2061 646a 7573 7420 7365 6c66  d to adjust self
+00026560: 2e74 6f74 616c 5f6f 6363 7570 616e 6379  .total_occupancy
+00026570: 2061 7320 7365 6c66 2e6f 6363 7570 616e   as self.occupan
+00026580: 6379 5b77 735d 2063 616e 6e6f 740a 2020  cy[ws] cannot.  
+00026590: 2020 2020 2020 2320 6578 6973 7420 6265        # exist be
+000265a0: 666f 7265 2074 6869 732e 0a20 2020 2020  fore this..     
+000265b0: 2020 2073 656c 662e 6368 6563 6b5f 6964     self.check_id
+000265c0: 6c65 5f73 6174 7572 6174 6564 2877 7329  le_saturated(ws)
+000265d0: 0a0a 2020 2020 2020 2020 7365 6c66 2e73  ..        self.s
+000265e0: 7472 6561 6d5f 636f 6d6d 735b 6164 6472  tream_comms[addr
+000265f0: 6573 735d 203d 2042 6174 6368 6564 5365  ess] = BatchedSe
+00026600: 6e64 2869 6e74 6572 7661 6c3d 2235 6d73  nd(interval="5ms
+00026610: 222c 206c 6f6f 703d 7365 6c66 2e6c 6f6f  ", loop=self.loo
+00026620: 7029 0a0a 2020 2020 2020 2020 6177 6169  p)..        awai
+00026630: 7461 626c 6573 203d 205b 5d0a 2020 2020  tables = [].    
+00026640: 2020 2020 666f 7220 706c 7567 696e 2069      for plugin i
+00026650: 6e20 6c69 7374 2873 656c 662e 706c 7567  n list(self.plug
+00026660: 696e 732e 7661 6c75 6573 2829 293a 0a20  ins.values()):. 
+00026670: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+00026680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026690: 7265 7375 6c74 203d 2070 6c75 6769 6e2e  result = plugin.
+000266a0: 6164 645f 776f 726b 6572 2873 6368 6564  add_worker(sched
+000266b0: 756c 6572 3d73 656c 662c 2077 6f72 6b65  uler=self, worke
+000266c0: 723d 6164 6472 6573 7329 0a20 2020 2020  r=address).     
+000266d0: 2020 2020 2020 2020 2020 2069 6620 7265             if re
+000266e0: 7375 6c74 2069 7320 6e6f 7420 4e6f 6e65  sult is not None
+000266f0: 2061 6e64 2069 6e73 7065 6374 2e69 7361   and inspect.isa
+00026700: 7761 6974 6162 6c65 2872 6573 756c 7429  waitable(result)
+00026710: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00026720: 2020 2020 2020 6177 6169 7461 626c 6573        awaitables
+00026730: 2e61 7070 656e 6428 7265 7375 6c74 290a  .append(result).
+00026740: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+00026750: 7074 2045 7863 6570 7469 6f6e 2061 7320  pt Exception as 
+00026760: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00026770: 2020 206c 6f67 6765 722e 6578 6365 7074     logger.except
+00026780: 696f 6e28 6529 0a0a 2020 2020 2020 2020  ion(e)..        
+00026790: 706c 7567 696e 5f6d 7367 7320 3d20 6177  plugin_msgs = aw
+000267a0: 6169 7420 6173 796e 6369 6f2e 6761 7468  ait asyncio.gath
+000267b0: 6572 282a 6177 6169 7461 626c 6573 2c20  er(*awaitables, 
+000267c0: 7265 7475 726e 5f65 7863 6570 7469 6f6e  return_exception
+000267d0: 733d 5472 7565 290a 2020 2020 2020 2020  s=True).        
+000267e0: 706c 7567 696e 735f 6578 6365 7074 696f  plugins_exceptio
+000267f0: 6e73 203d 205b 6d73 6720 666f 7220 6d73  ns = [msg for ms
+00026800: 6720 696e 2070 6c75 6769 6e5f 6d73 6773  g in plugin_msgs
+00026810: 2069 6620 6973 696e 7374 616e 6365 286d   if isinstance(m
+00026820: 7367 2c20 4578 6365 7074 696f 6e29 5d0a  sg, Exception)].
+00026830: 2020 2020 2020 2020 666f 7220 6578 6320          for exc 
+00026840: 696e 2070 6c75 6769 6e73 5f65 7863 6570  in plugins_excep
+00026850: 7469 6f6e 733a 0a20 2020 2020 2020 2020  tions:.         
+00026860: 2020 206c 6f67 6765 722e 6578 6365 7074     logger.except
+00026870: 696f 6e28 6578 632c 2065 7863 5f69 6e66  ion(exc, exc_inf
+00026880: 6f3d 6578 6329 0a0a 2020 2020 2020 2020  o=exc)..        
+00026890: 6966 2077 732e 7374 6174 7573 203d 3d20  if ws.status == 
+000268a0: 5374 6174 7573 2e72 756e 6e69 6e67 3a0a  Status.running:.
+000268b0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000268c0: 2e74 7261 6e73 6974 696f 6e73 280a 2020  .transitions(.  
+000268d0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+000268e0: 6c66 2e62 756c 6b5f 7363 6865 6475 6c65  lf.bulk_schedule
+000268f0: 5f75 6e72 756e 6e61 626c 655f 6166 7465  _unrunnable_afte
+00026900: 725f 6164 6469 6e67 5f77 6f72 6b65 7228  r_adding_worker(
+00026910: 7773 292c 2073 7469 6d75 6c75 735f 6964  ws), stimulus_id
+00026920: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00026930: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00026940: 7374 696d 756c 7573 5f71 7565 7565 5f73  stimulus_queue_s
+00026950: 6c6f 7473 5f6d 6179 6265 5f6f 7065 6e65  lots_maybe_opene
+00026960: 6428 7374 696d 756c 7573 5f69 643d 7374  d(stimulus_id=st
+00026970: 696d 756c 7573 5f69 6429 0a0a 2020 2020  imulus_id)..    
+00026980: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
+00026990: 2252 6567 6973 7465 7220 776f 726b 6572  "Register worker
+000269a0: 2025 7322 2c20 7773 290a 0a20 2020 2020   %s", ws)..     
+000269b0: 2020 206d 7367 203d 207b 0a20 2020 2020     msg = {.     
+000269c0: 2020 2020 2020 2022 7374 6174 7573 223a         "status":
+000269d0: 2022 4f4b 222c 0a20 2020 2020 2020 2020   "OK",.         
+000269e0: 2020 2022 7469 6d65 223a 2074 696d 6528     "time": time(
+000269f0: 292c 0a20 2020 2020 2020 2020 2020 2022  ),.            "
+00026a00: 6865 6172 7462 6561 742d 696e 7465 7276  heartbeat-interv
+00026a10: 616c 223a 2068 6561 7274 6265 6174 5f69  al": heartbeat_i
+00026a20: 6e74 6572 7661 6c28 6c65 6e28 7365 6c66  nterval(len(self
+00026a30: 2e77 6f72 6b65 7273 2929 2c0a 2020 2020  .workers)),.    
+00026a40: 2020 2020 2020 2020 2277 6f72 6b65 722d          "worker-
+00026a50: 706c 7567 696e 7322 3a20 7365 6c66 2e77  plugins": self.w
+00026a60: 6f72 6b65 725f 706c 7567 696e 732c 0a20  orker_plugins,. 
+00026a70: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
+00026a80: 2020 7665 7273 696f 6e5f 7761 726e 696e    version_warnin
+00026a90: 6720 3d20 7665 7273 696f 6e5f 6d6f 6475  g = version_modu
+00026aa0: 6c65 2e65 7272 6f72 5f6d 6573 7361 6765  le.error_message
+00026ab0: 280a 2020 2020 2020 2020 2020 2020 7665  (.            ve
+00026ac0: 7273 696f 6e5f 6d6f 6475 6c65 2e67 6574  rsion_module.get
+00026ad0: 5f76 6572 7369 6f6e 7328 292c 0a20 2020  _versions(),.   
+00026ae0: 2020 2020 2020 2020 207b 773a 2077 732e           {w: ws.
+00026af0: 7665 7273 696f 6e73 2066 6f72 2077 2c20  versions for w, 
+00026b00: 7773 2069 6e20 7365 6c66 2e77 6f72 6b65  ws in self.worke
+00026b10: 7273 2e69 7465 6d73 2829 7d2c 0a20 2020  rs.items()},.   
+00026b20: 2020 2020 2020 2020 2076 6572 7369 6f6e           version
+00026b30: 732c 0a20 2020 2020 2020 2020 2020 2073  s,.            s
+00026b40: 6f75 7263 655f 6e61 6d65 3d73 7472 2877  ource_name=str(w
+00026b50: 732e 7365 7276 6572 5f69 6429 2c0a 2020  s.server_id),.  
+00026b60: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00026b70: 6d73 672e 7570 6461 7465 2876 6572 7369  msg.update(versi
+00026b80: 6f6e 5f77 6172 6e69 6e67 290a 0a20 2020  on_warning)..   
+00026b90: 2020 2020 2061 7761 6974 2063 6f6d 6d2e       await comm.
+00026ba0: 7772 6974 6528 6d73 6729 0a20 2020 2020  write(msg).     
+00026bb0: 2020 2023 2054 6869 7320 7769 6c6c 206b     # This will k
+00026bc0: 6565 7020 7275 6e6e 696e 6720 756e 7469  eep running unti
+00026bd0: 6c20 7468 6520 776f 726b 6572 2069 7320  l the worker is 
+00026be0: 7265 6d6f 7665 640a 2020 2020 2020 2020  removed.        
+00026bf0: 6177 6169 7420 7365 6c66 2e68 616e 646c  await self.handl
+00026c00: 655f 776f 726b 6572 2863 6f6d 6d2c 2061  e_worker(comm, a
+00026c10: 6464 7265 7373 290a 0a20 2020 2061 7379  ddress)..    asy
+00026c20: 6e63 2064 6566 2061 6464 5f6e 616e 6e79  nc def add_nanny
+00026c30: 2873 656c 662c 2063 6f6d 6d3a 2043 6f6d  (self, comm: Com
+00026c40: 6d2c 2061 6464 7265 7373 3a20 7374 7229  m, address: str)
+00026c50: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00026c60: 2020 6173 796e 6320 7769 7468 2073 656c    async with sel
+00026c70: 662e 5f73 7461 7274 696e 675f 6e61 6e6e  f._starting_nann
+00026c80: 6965 735f 636f 6e64 3a0a 2020 2020 2020  ies_cond:.      
+00026c90: 2020 2020 2020 7365 6c66 2e5f 7374 6172        self._star
+00026ca0: 7469 6e67 5f6e 616e 6e69 6573 2e61 6464  ting_nannies.add
+00026cb0: 2861 6464 7265 7373 290a 2020 2020 2020  (address).      
+00026cc0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00026cd0: 2020 206d 7367 203d 207b 0a20 2020 2020     msg = {.     
+00026ce0: 2020 2020 2020 2020 2020 2022 7374 6174             "stat
+00026cf0: 7573 223a 2022 4f4b 222c 0a20 2020 2020  us": "OK",.     
+00026d00: 2020 2020 2020 2020 2020 2022 6e61 6e6e             "nann
+00026d10: 792d 706c 7567 696e 7322 3a20 7365 6c66  y-plugins": self
+00026d20: 2e6e 616e 6e79 5f70 6c75 6769 6e73 2c0a  .nanny_plugins,.
+00026d30: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+00026d40: 2020 2020 2020 2020 2020 6177 6169 7420            await 
+00026d50: 636f 6d6d 2e77 7269 7465 286d 7367 290a  comm.write(msg).
+00026d60: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+00026d70: 7420 636f 6d6d 2e72 6561 6428 290a 2020  t comm.read().  
+00026d80: 2020 2020 2020 6669 6e61 6c6c 793a 0a20        finally:. 
+00026d90: 2020 2020 2020 2020 2020 2061 7379 6e63             async
+00026da0: 2077 6974 6820 7365 6c66 2e5f 7374 6172   with self._star
+00026db0: 7469 6e67 5f6e 616e 6e69 6573 5f63 6f6e  ting_nannies_con
+00026dc0: 643a 0a20 2020 2020 2020 2020 2020 2020  d:.             
+00026dd0: 2020 2073 656c 662e 5f73 7461 7274 696e     self._startin
+00026de0: 675f 6e61 6e6e 6965 732e 6469 7363 6172  g_nannies.discar
+00026df0: 6428 6164 6472 6573 7329 0a20 2020 2020  d(address).     
+00026e00: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00026e10: 5f73 7461 7274 696e 675f 6e61 6e6e 6965  _starting_nannie
+00026e20: 735f 636f 6e64 2e6e 6f74 6966 795f 616c  s_cond.notify_al
+00026e30: 6c28 290a 0a20 2020 2064 6566 205f 6d61  l()..    def _ma
+00026e40: 7463 685f 6772 6170 685f 7769 7468 5f74  tch_graph_with_t
+00026e50: 6173 6b73 280a 2020 2020 2020 2020 7365  asks(.        se
+00026e60: 6c66 2c0a 2020 2020 2020 2020 6473 6b3a  lf,.        dsk:
+00026e70: 2064 6963 745b 4b65 792c 2054 5f72 756e   dict[Key, T_run
+00026e80: 7370 6563 5d2c 0a20 2020 2020 2020 2064  spec],.        d
+00026e90: 6570 656e 6465 6e63 6965 733a 2064 6963  ependencies: dic
+00026ea0: 745b 4b65 792c 2073 6574 5b4b 6579 5d5d  t[Key, set[Key]]
+00026eb0: 2c0a 2020 2020 2020 2020 6b65 7973 3a20  ,.        keys: 
+00026ec0: 7365 745b 4b65 795d 2c0a 2020 2020 2920  set[Key],.    ) 
+00026ed0: 2d3e 2073 6574 5b4b 6579 5d3a 0a20 2020  -> set[Key]:.   
+00026ee0: 2020 2020 206e 203d 2030 0a20 2020 2020       n = 0.     
+00026ef0: 2020 206c 6f73 745f 6b65 7973 203d 2073     lost_keys = s
+00026f00: 6574 2829 0a20 2020 2020 2020 2077 6869  et().        whi
+00026f10: 6c65 206c 656e 2864 736b 2920 213d 206e  le len(dsk) != n
+00026f20: 3a20 2023 2077 616c 6b20 7468 726f 7567  :  # walk throug
+00026f30: 6820 6e65 7720 7461 736b 732c 2063 616e  h new tasks, can
+00026f40: 6365 6c20 616e 7920 6261 6420 6465 7073  cel any bad deps
+00026f50: 0a20 2020 2020 2020 2020 2020 206e 203d  .            n =
+00026f60: 206c 656e 2864 736b 290a 2020 2020 2020   len(dsk).      
+00026f70: 2020 2020 2020 666f 7220 6b2c 2064 6570        for k, dep
+00026f80: 7320 696e 206c 6973 7428 6465 7065 6e64  s in list(depend
+00026f90: 656e 6369 6573 2e69 7465 6d73 2829 293a  encies.items()):
+00026fa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00026fb0: 2069 6620 616e 7928 0a20 2020 2020 2020   if any(.       
+00026fc0: 2020 2020 2020 2020 2020 2020 2064 6570               dep
+00026fd0: 206e 6f74 2069 6e20 7365 6c66 2e74 6173   not in self.tas
+00026fe0: 6b73 2061 6e64 2064 6570 206e 6f74 2069  ks and dep not i
+00026ff0: 6e20 6473 6b20 666f 7220 6465 7020 696e  n dsk for dep in
+00027000: 2064 6570 730a 2020 2020 2020 2020 2020   deps.          
+00027010: 2020 2020 2020 293a 2020 2320 6261 6420        ):  # bad 
+00027020: 6b65 790a 2020 2020 2020 2020 2020 2020  key.            
+00027030: 2020 2020 2020 2020 6c6f 7374 5f6b 6579          lost_key
+00027040: 732e 6164 6428 6b29 0a20 2020 2020 2020  s.add(k).       
+00027050: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+00027060: 6765 722e 696e 666f 2822 5573 6572 2061  ger.info("User a
+00027070: 736b 6564 2066 6f72 2063 6f6d 7075 7461  sked for computa
+00027080: 7469 6f6e 206f 6e20 6c6f 7374 2064 6174  tion on lost dat
+00027090: 612c 2025 7322 2c20 6b29 0a20 2020 2020  a, %s", k).     
+000270a0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+000270b0: 656c 2064 736b 5b6b 5d0a 2020 2020 2020  el dsk[k].      
+000270c0: 2020 2020 2020 2020 2020 2020 2020 6465                de
+000270d0: 6c20 6465 7065 6e64 656e 6369 6573 5b6b  l dependencies[k
+000270e0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+000270f0: 2020 2020 2020 6966 206b 2069 6e20 6b65        if k in ke
+00027100: 7973 3a0a 2020 2020 2020 2020 2020 2020  ys:.            
+00027110: 2020 2020 2020 2020 2020 2020 6b65 7973              keys
+00027120: 2e72 656d 6f76 6528 6b29 0a20 2020 2020  .remove(k).     
+00027130: 2020 2020 2020 2020 2020 2064 656c 2064             del d
+00027140: 6570 730a 2020 2020 2020 2020 2320 4176  eps.        # Av
+00027150: 6f69 6420 636f 6d70 7574 6174 696f 6e20  oid computation 
+00027160: 7468 6174 2069 7320 616c 7265 6164 7920  that is already 
+00027170: 6669 6e69 7368 6564 0a20 2020 2020 2020  finished.       
+00027180: 2064 6f6e 6520 3d20 7365 7428 2920 2023   done = set()  #
+00027190: 2074 6173 6b73 2074 6861 7420 6172 6520   tasks that are 
+000271a0: 616c 7265 6164 7920 646f 6e65 0a20 2020  already done.   
+000271b0: 2020 2020 2066 6f72 206b 2c20 7620 696e       for k, v in
+000271c0: 2064 6570 656e 6465 6e63 6965 732e 6974   dependencies.it
+000271d0: 656d 7328 293a 0a20 2020 2020 2020 2020  ems():.         
+000271e0: 2020 2069 6620 7620 616e 6420 6b20 696e     if v and k in
+000271f0: 2073 656c 662e 7461 736b 733a 0a20 2020   self.tasks:.   
+00027200: 2020 2020 2020 2020 2020 2020 2074 7320               ts 
+00027210: 3d20 7365 6c66 2e74 6173 6b73 5b6b 5d0a  = self.tasks[k].
+00027220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027230: 6966 2074 732e 7374 6174 6520 696e 2028  if ts.state in (
+00027240: 226d 656d 6f72 7922 2c20 2265 7272 6564  "memory", "erred
+00027250: 2229 3a0a 2020 2020 2020 2020 2020 2020  "):.            
+00027260: 2020 2020 2020 2020 646f 6e65 2e61 6464          done.add
+00027270: 286b 290a 0a20 2020 2020 2020 2069 6620  (k)..        if 
+00027280: 646f 6e65 3a0a 2020 2020 2020 2020 2020  done:.          
+00027290: 2020 6465 7065 6e64 656e 7473 203d 2064    dependents = d
+000272a0: 6173 6b2e 636f 7265 2e72 6576 6572 7365  ask.core.reverse
+000272b0: 5f64 6963 7428 6465 7065 6e64 656e 6369  _dict(dependenci
+000272c0: 6573 290a 2020 2020 2020 2020 2020 2020  es).            
+000272d0: 7374 6163 6b20 3d20 6c69 7374 2864 6f6e  stack = list(don
+000272e0: 6529 0a20 2020 2020 2020 2020 2020 2077  e).            w
+000272f0: 6869 6c65 2073 7461 636b 3a20 2023 2072  hile stack:  # r
+00027300: 656d 6f76 6520 756e 6e65 6365 7373 6172  emove unnecessar
+00027310: 7920 6465 7065 6e64 656e 6369 6573 0a20  y dependencies. 
+00027320: 2020 2020 2020 2020 2020 2020 2020 206b                 k
+00027330: 6579 203d 2073 7461 636b 2e70 6f70 2829  ey = stack.pop()
+00027340: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00027350: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+00027360: 2020 2020 2020 2020 2020 6465 7073 203d            deps =
+00027370: 2064 6570 656e 6465 6e63 6965 735b 6b65   dependencies[ke
+00027380: 795d 0a20 2020 2020 2020 2020 2020 2020  y].             
+00027390: 2020 2065 7863 6570 7420 4b65 7945 7272     except KeyErr
+000273a0: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
+000273b0: 2020 2020 2020 2020 6465 7073 203d 207b          deps = {
+000273c0: 7473 2e6b 6579 2066 6f72 2074 7320 696e  ts.key for ts in
+000273d0: 2073 656c 662e 7461 736b 735b 6b65 795d   self.tasks[key]
+000273e0: 2e64 6570 656e 6465 6e63 6965 737d 0a20  .dependencies}. 
+000273f0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00027400: 6f72 2064 6570 2069 6e20 6465 7073 3a0a  or dep in deps:.
+00027410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027420: 2020 2020 6966 2064 6570 2069 6e20 6465      if dep in de
+00027430: 7065 6e64 656e 7473 3a0a 2020 2020 2020  pendents:.      
+00027440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027450: 2020 6368 696c 645f 6465 7073 203d 2064    child_deps = d
+00027460: 6570 656e 6465 6e74 735b 6465 705d 0a20  ependents[dep]. 
+00027470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027480: 2020 2065 6c69 6620 6465 7020 696e 2073     elif dep in s
+00027490: 656c 662e 7461 736b 733a 0a20 2020 2020  elf.tasks:.     
+000274a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000274b0: 2020 2063 6869 6c64 5f64 6570 7320 3d20     child_deps = 
+000274c0: 7b74 732e 6b65 7920 666f 7220 7473 2069  {ts.key for ts i
+000274d0: 6e20 7365 6c66 2e74 6173 6b73 5b6b 6579  n self.tasks[key
+000274e0: 5d2e 6465 7065 6e64 656e 6369 6573 7d0a  ].dependencies}.
+000274f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027500: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00027510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027520: 2020 6368 696c 645f 6465 7073 203d 2073    child_deps = s
+00027530: 6574 2829 0a20 2020 2020 2020 2020 2020  et().           
+00027540: 2020 2020 2020 2020 2069 6620 616c 6c28           if all(
+00027550: 6420 696e 2064 6f6e 6520 666f 7220 6420  d in done for d 
+00027560: 696e 2063 6869 6c64 5f64 6570 7329 3a0a  in child_deps):.
+00027570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027580: 2020 2020 2020 2020 6966 2064 6570 2069          if dep i
+00027590: 6e20 7365 6c66 2e74 6173 6b73 2061 6e64  n self.tasks and
+000275a0: 2064 6570 206e 6f74 2069 6e20 646f 6e65   dep not in done
+000275b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000275c0: 2020 2020 2020 2020 2020 2020 2020 646f                do
+000275d0: 6e65 2e61 6464 2864 6570 290a 2020 2020  ne.add(dep).    
+000275e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000275f0: 2020 2020 2020 2020 7374 6163 6b2e 6170          stack.ap
+00027600: 7065 6e64 2864 6570 290a 2020 2020 2020  pend(dep).      
+00027610: 2020 666f 7220 616e 6320 696e 2064 6f6e    for anc in don
+00027620: 653a 0a20 2020 2020 2020 2020 2020 2064  e:.            d
+00027630: 736b 2e70 6f70 2861 6e63 2c20 4e6f 6e65  sk.pop(anc, None
+00027640: 290a 2020 2020 2020 2020 2020 2020 6465  ).            de
+00027650: 7065 6e64 656e 6369 6573 2e70 6f70 2861  pendencies.pop(a
+00027660: 6e63 2c20 4e6f 6e65 290a 2020 2020 2020  nc, None).      
+00027670: 2020 7265 7475 726e 206c 6f73 745f 6b65    return lost_ke
+00027680: 7973 0a0a 2020 2020 6465 6620 5f63 7265  ys..    def _cre
+00027690: 6174 655f 7461 736b 7374 6174 655f 6672  ate_taskstate_fr
+000276a0: 6f6d 5f67 7261 7068 280a 2020 2020 2020  om_graph(.      
+000276b0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+000276c0: 2a2c 0a20 2020 2020 2020 2073 7461 7274  *,.        start
+000276d0: 3a20 666c 6f61 742c 0a20 2020 2020 2020  : float,.       
+000276e0: 2064 736b 3a20 6469 6374 5b4b 6579 2c20   dsk: dict[Key, 
+000276f0: 545f 7275 6e73 7065 635d 2c0a 2020 2020  T_runspec],.    
+00027700: 2020 2020 6465 7065 6e64 656e 6369 6573      dependencies
+00027710: 3a20 6469 6374 2c0a 2020 2020 2020 2020  : dict,.        
+00027720: 6b65 7973 3a20 7365 745b 4b65 795d 2c0a  keys: set[Key],.
+00027730: 2020 2020 2020 2020 6f72 6465 7265 643a          ordered:
+00027740: 2064 6963 745b 4b65 792c 2069 6e74 5d2c   dict[Key, int],
+00027750: 0a20 2020 2020 2020 2063 6c69 656e 743a  .        client:
+00027760: 2073 7472 2c0a 2020 2020 2020 2020 616e   str,.        an
+00027770: 6e6f 7461 7469 6f6e 735f 6279 5f74 7970  notations_by_typ
+00027780: 653a 2064 6963 742c 0a20 2020 2020 2020  e: dict,.       
+00027790: 2067 6c6f 6261 6c5f 616e 6e6f 7461 7469   global_annotati
+000277a0: 6f6e 733a 2064 6963 7420 7c20 4e6f 6e65  ons: dict | None
+000277b0: 2c0a 2020 2020 2020 2020 7374 696d 756c  ,.        stimul
+000277c0: 7573 5f69 643a 2073 7472 2c0a 2020 2020  us_id: str,.    
+000277d0: 2020 2020 7375 626d 6974 7469 6e67 5f74      submitting_t
+000277e0: 6173 6b3a 204b 6579 207c 204e 6f6e 652c  ask: Key | None,
+000277f0: 0a20 2020 2020 2020 2073 7061 6e5f 6d65  .        span_me
+00027800: 7461 6461 7461 3a20 5370 616e 4d65 7461  tadata: SpanMeta
+00027810: 6461 7461 2c0a 2020 2020 2020 2020 7573  data,.        us
+00027820: 6572 5f70 7269 6f72 6974 793a 2069 6e74  er_priority: int
+00027830: 207c 2064 6963 745b 4b65 792c 2069 6e74   | dict[Key, int
+00027840: 5d20 3d20 302c 0a20 2020 2020 2020 2061  ] = 0,.        a
+00027850: 6374 6f72 733a 2062 6f6f 6c20 7c20 6c69  ctors: bool | li
+00027860: 7374 5b4b 6579 5d20 7c20 4e6f 6e65 203d  st[Key] | None =
+00027870: 204e 6f6e 652c 0a20 2020 2020 2020 2066   None,.        f
+00027880: 6966 6f5f 7469 6d65 6f75 743a 2066 6c6f  ifo_timeout: flo
+00027890: 6174 203d 2030 2e30 2c0a 2020 2020 2020  at = 0.0,.      
+000278a0: 2020 636f 6465 3a20 7475 706c 655b 536f    code: tuple[So
+000278b0: 7572 6365 436f 6465 2c20 2e2e 2e5d 203d  urceCode, ...] =
+000278c0: 2028 292c 0a20 2020 2029 202d 3e20 4e6f   (),.    ) -> No
+000278d0: 6e65 3a0a 2020 2020 2020 2020 2222 220a  ne:.        """.
+000278e0: 2020 2020 2020 2020 5461 6b65 2061 206c          Take a l
+000278f0: 6f77 206c 6576 656c 2067 7261 7068 2061  ow level graph a
+00027900: 6e64 2063 7265 6174 6520 7468 6520 6e65  nd create the ne
+00027910: 6365 7373 6172 7920 7363 6865 6475 6c65  cessary schedule
+00027920: 7220 7374 6174 6520 746f 0a20 2020 2020  r state to.     
+00027930: 2020 2063 6f6d 7075 7465 2069 742e 0a0a     compute it...
+00027940: 2020 2020 2020 2020 5741 524e 494e 470a          WARNING.
+00027950: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d0a          -------.
+00027960: 2020 2020 2020 2020 5468 6973 206d 6574          This met
+00027970: 686f 6420 6d75 7374 206e 6f74 2062 6520  hod must not be 
+00027980: 6d61 6465 2061 7379 6e63 2073 696e 6365  made async since
+00027990: 206e 6f74 6869 6e67 2068 6572 6520 6973   nothing here is
+000279a0: 2063 6f6e 6375 7272 656e 6379 0a20 2020   concurrency.   
+000279b0: 2020 2020 2073 6166 652e 2041 6c6c 2069       safe. All i
+000279c0: 6e74 6572 6163 7469 6f6e 7320 7769 7468  nteractions with
+000279d0: 2054 6173 6b53 7461 7465 206f 626a 6563   TaskState objec
+000279e0: 7473 2068 6572 6520 7368 6f75 6c64 2062  ts here should b
+000279f0: 6520 6861 7070 656e 696e 670a 2020 2020  e happening.    
+00027a00: 2020 2020 696e 2074 6865 2073 616d 6520      in the same 
+00027a10: 6576 656e 7420 6c6f 6f70 2074 6963 6b2e  event loop tick.
+00027a20: 0a20 2020 2020 2020 2022 2222 0a0a 2020  .        """..  
+00027a30: 2020 2020 2020 6c6f 7374 5f6b 6579 7320        lost_keys 
+00027a40: 3d20 7365 6c66 2e5f 6d61 7463 685f 6772  = self._match_gr
+00027a50: 6170 685f 7769 7468 5f74 6173 6b73 2864  aph_with_tasks(d
+00027a60: 736b 2c20 6465 7065 6e64 656e 6369 6573  sk, dependencies
+00027a70: 2c20 6b65 7973 290a 0a20 2020 2020 2020  , keys)..       
+00027a80: 2069 6620 6c65 6e28 6473 6b29 203e 2031   if len(dsk) > 1
+00027a90: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00027aa0: 6c66 2e6c 6f67 5f65 7665 6e74 280a 2020  lf.log_event(.  
+00027ab0: 2020 2020 2020 2020 2020 2020 2020 5b22                ["
+00027ac0: 616c 6c22 2c20 636c 6965 6e74 5d2c 207b  all", client], {
+00027ad0: 2261 6374 696f 6e22 3a20 2275 7064 6174  "action": "updat
+00027ae0: 655f 6772 6170 6822 2c20 2263 6f75 6e74  e_graph", "count
+00027af0: 223a 206c 656e 2864 736b 297d 0a20 2020  ": len(dsk)}.   
+00027b00: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+00027b10: 2020 2020 6966 206c 6f73 745f 6b65 7973      if lost_keys
+00027b20: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00027b30: 6c66 2e72 6570 6f72 7428 7b22 6f70 223a  lf.report({"op":
+00027b40: 2022 6361 6e63 656c 6c65 642d 6b65 7973   "cancelled-keys
+00027b50: 222c 2022 6b65 7973 223a 206c 6f73 745f  ", "keys": lost_
+00027b60: 6b65 7973 7d2c 2063 6c69 656e 743d 636c  keys}, client=cl
+00027b70: 6965 6e74 290a 2020 2020 2020 2020 2020  ient).          
+00027b80: 2020 7365 6c66 2e63 6c69 656e 745f 7265    self.client_re
+00027b90: 6c65 6173 6573 5f6b 6579 7328 0a20 2020  leases_keys(.   
+00027ba0: 2020 2020 2020 2020 2020 2020 206b 6579               key
+00027bb0: 733d 6c6f 7374 5f6b 6579 732c 2063 6c69  s=lost_keys, cli
+00027bc0: 656e 743d 636c 6965 6e74 2c20 7374 696d  ent=client, stim
+00027bd0: 756c 7573 5f69 643d 7374 696d 756c 7573  ulus_id=stimulus
+00027be0: 5f69 640a 2020 2020 2020 2020 2020 2020  _id.            
+00027bf0: 290a 0a20 2020 2020 2020 2069 6620 6e6f  )..        if no
+00027c00: 7420 7365 6c66 2e69 735f 6964 6c65 2061  t self.is_idle a
+00027c10: 6e64 2073 656c 662e 636f 6d70 7574 6174  nd self.computat
+00027c20: 696f 6e73 3a0a 2020 2020 2020 2020 2020  ions:.          
+00027c30: 2020 2320 5374 696c 6c20 776f 726b 696e    # Still workin
+00027c40: 6720 6f6e 2073 6f6d 6574 6869 6e67 2e20  g on something. 
+00027c50: 4173 7369 676e 206e 6577 2074 6173 6b73  Assign new tasks
+00027c60: 2074 6f20 7361 6d65 2063 6f6d 7075 7461   to same computa
+00027c70: 7469 6f6e 0a20 2020 2020 2020 2020 2020  tion.           
+00027c80: 2063 6f6d 7075 7461 7469 6f6e 203d 2073   computation = s
+00027c90: 656c 662e 636f 6d70 7574 6174 696f 6e73  elf.computations
+00027ca0: 5b2d 315d 0a20 2020 2020 2020 2065 6c73  [-1].        els
+00027cb0: 653a 0a20 2020 2020 2020 2020 2020 2063  e:.            c
+00027cc0: 6f6d 7075 7461 7469 6f6e 203d 2043 6f6d  omputation = Com
+00027cd0: 7075 7461 7469 6f6e 2829 0a20 2020 2020  putation().     
+00027ce0: 2020 2020 2020 2073 656c 662e 636f 6d70         self.comp
+00027cf0: 7574 6174 696f 6e73 2e61 7070 656e 6428  utations.append(
+00027d00: 636f 6d70 7574 6174 696f 6e29 0a0a 2020  computation)..  
+00027d10: 2020 2020 2020 6966 2063 6f64 653a 2020        if code:  
+00027d20: 2320 6164 6420 6e65 7720 636f 6465 2062  # add new code b
+00027d30: 6c6f 636b 730a 2020 2020 2020 2020 2020  locks.          
+00027d40: 2020 636f 6d70 7574 6174 696f 6e2e 636f    computation.co
+00027d50: 6465 2e61 6464 2863 6f64 6529 0a20 2020  de.add(code).   
+00027d60: 2020 2020 2069 6620 676c 6f62 616c 5f61       if global_a
+00027d70: 6e6e 6f74 6174 696f 6e73 3a0a 2020 2020  nnotations:.    
+00027d80: 2020 2020 2020 2020 2320 4649 584d 453a          # FIXME:
+00027d90: 2054 6869 7320 6973 206b 696e 6420 6f66   This is kind of
+00027da0: 2069 6e63 6f6e 7369 7374 656e 7420 7369   inconsistent si
+00027db0: 6e63 6520 6974 206f 6e6c 7920 696e 636c  nce it only incl
+00027dc0: 7564 6573 2067 6c6f 6261 6c0a 2020 2020  udes global.    
+00027dd0: 2020 2020 2020 2020 2320 616e 6e6f 7461          # annota
+00027de0: 7469 6f6e 732e 0a20 2020 2020 2020 2020  tions..         
+00027df0: 2020 2063 6f6d 7075 7461 7469 6f6e 2e61     computation.a
+00027e00: 6e6e 6f74 6174 696f 6e73 2e75 7064 6174  nnotations.updat
+00027e10: 6528 676c 6f62 616c 5f61 6e6e 6f74 6174  e(global_annotat
+00027e20: 696f 6e73 290a 2020 2020 2020 2020 6465  ions).        de
+00027e30: 6c20 676c 6f62 616c 5f61 6e6e 6f74 6174  l global_annotat
+00027e40: 696f 6e73 0a0a 2020 2020 2020 2020 7275  ions..        ru
+00027e50: 6e6e 6162 6c65 2c20 746f 7563 6865 645f  nnable, touched_
+00027e60: 7461 736b 732c 206e 6577 5f74 6173 6b73  tasks, new_tasks
+00027e70: 203d 2073 656c 662e 5f67 656e 6572 6174   = self._generat
+00027e80: 655f 7461 736b 7374 6174 6573 280a 2020  e_taskstates(.  
+00027e90: 2020 2020 2020 2020 2020 6b65 7973 3d6b            keys=k
+00027ea0: 6579 732c 0a20 2020 2020 2020 2020 2020  eys,.           
+00027eb0: 2064 736b 3d64 736b 2c0a 2020 2020 2020   dsk=dsk,.      
+00027ec0: 2020 2020 2020 6465 7065 6e64 656e 6369        dependenci
+00027ed0: 6573 3d64 6570 656e 6465 6e63 6965 732c  es=dependencies,
+00027ee0: 0a20 2020 2020 2020 2020 2020 2063 6f6d  .            com
+00027ef0: 7075 7461 7469 6f6e 3d63 6f6d 7075 7461  putation=computa
+00027f00: 7469 6f6e 2c0a 2020 2020 2020 2020 290a  tion,.        ).
+00027f10: 0a20 2020 2020 2020 206b 6579 735f 7769  .        keys_wi
+00027f20: 7468 5f61 6e6e 6f74 6174 696f 6e73 203d  th_annotations =
+00027f30: 2073 656c 662e 5f61 7070 6c79 5f61 6e6e   self._apply_ann
+00027f40: 6f74 6174 696f 6e73 280a 2020 2020 2020  otations(.      
+00027f50: 2020 2020 2020 7461 736b 733d 6e65 775f        tasks=new_
+00027f60: 7461 736b 732c 0a20 2020 2020 2020 2020  tasks,.         
+00027f70: 2020 2061 6e6e 6f74 6174 696f 6e73 5f62     annotations_b
+00027f80: 795f 7479 7065 3d61 6e6e 6f74 6174 696f  y_type=annotatio
+00027f90: 6e73 5f62 795f 7479 7065 2c0a 2020 2020  ns_by_type,.    
+00027fa0: 2020 2020 290a 0a20 2020 2020 2020 2073      )..        s
+00027fb0: 656c 662e 5f73 6574 5f70 7269 6f72 6974  elf._set_priorit
+00027fc0: 6965 7328 0a20 2020 2020 2020 2020 2020  ies(.           
+00027fd0: 2069 6e74 6572 6e61 6c5f 7072 696f 7269   internal_priori
+00027fe0: 7479 3d6f 7264 6572 6564 2c0a 2020 2020  ty=ordered,.    
+00027ff0: 2020 2020 2020 2020 7375 626d 6974 7469          submitti
+00028000: 6e67 5f74 6173 6b3d 7375 626d 6974 7469  ng_task=submitti
+00028010: 6e67 5f74 6173 6b2c 0a20 2020 2020 2020  ng_task,.       
+00028020: 2020 2020 2075 7365 725f 7072 696f 7269       user_priori
+00028030: 7479 3d75 7365 725f 7072 696f 7269 7479  ty=user_priority
+00028040: 2c0a 2020 2020 2020 2020 2020 2020 6669  ,.            fi
+00028050: 666f 5f74 696d 656f 7574 3d66 6966 6f5f  fo_timeout=fifo_
+00028060: 7469 6d65 6f75 742c 0a20 2020 2020 2020  timeout,.       
+00028070: 2020 2020 2073 7461 7274 3d73 7461 7274       start=start
+00028080: 2c0a 2020 2020 2020 2020 2020 2020 7461  ,.            ta
+00028090: 736b 733d 7275 6e6e 6162 6c65 2c0a 2020  sks=runnable,.  
+000280a0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+000280b0: 2073 656c 662e 636c 6965 6e74 5f64 6573   self.client_des
+000280c0: 6972 6573 5f6b 6579 7328 6b65 7973 3d6b  ires_keys(keys=k
+000280d0: 6579 732c 2063 6c69 656e 743d 636c 6965  eys, client=clie
+000280e0: 6e74 290a 0a20 2020 2020 2020 2023 2041  nt)..        # A
+000280f0: 6464 2061 6374 6f72 730a 2020 2020 2020  dd actors.      
+00028100: 2020 6966 2061 6374 6f72 7320 6973 2054    if actors is T
+00028110: 7275 653a 0a20 2020 2020 2020 2020 2020  rue:.           
+00028120: 2061 6374 6f72 7320 3d20 6c69 7374 286b   actors = list(k
+00028130: 6579 7329 0a20 2020 2020 2020 2066 6f72  eys).        for
+00028140: 2061 6374 6f72 2069 6e20 6163 746f 7273   actor in actors
+00028150: 206f 7220 5b5d 3a0a 2020 2020 2020 2020   or []:.        
+00028160: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
+00028170: 736b 735b 6163 746f 725d 0a20 2020 2020  sks[actor].     
+00028180: 2020 2020 2020 2074 732e 6163 746f 7220         ts.actor 
+00028190: 3d20 5472 7565 0a0a 2020 2020 2020 2020  = True..        
+000281a0: 2320 436f 6d70 7574 6520 7265 636f 6d6d  # Compute recomm
+000281b0: 656e 6461 7469 6f6e 730a 2020 2020 2020  endations.      
+000281c0: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
+000281d0: 733a 2052 6563 7320 3d20 7b7d 0a20 2020  s: Recs = {}.   
+000281e0: 2020 2020 2070 7269 6f72 6974 7920 3d20       priority = 
+000281f0: 6469 6374 2829 0a20 2020 2020 2020 2066  dict().        f
+00028200: 6f72 2074 7320 696e 2073 6f72 7465 6428  or ts in sorted(
+00028210: 0a20 2020 2020 2020 2020 2020 2072 756e  .            run
+00028220: 6e61 626c 652c 0a20 2020 2020 2020 2020  nable,.         
+00028230: 2020 206b 6579 3d6f 7065 7261 746f 722e     key=operator.
+00028240: 6174 7472 6765 7474 6572 2822 7072 696f  attrgetter("prio
+00028250: 7269 7479 2229 2c0a 2020 2020 2020 2020  rity"),.        
+00028260: 2020 2020 7265 7665 7273 653d 5472 7565      reverse=True
+00028270: 2c0a 2020 2020 2020 2020 293a 0a20 2020  ,.        ):.   
+00028280: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00028290: 7473 2e70 7269 6f72 6974 7920 2023 206d  ts.priority  # m
+000282a0: 7970 790a 2020 2020 2020 2020 2020 2020  ypy.            
+000282b0: 7072 696f 7269 7479 5b74 732e 6b65 795d  priority[ts.key]
+000282c0: 203d 2074 732e 7072 696f 7269 7479 0a20   = ts.priority. 
+000282d0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+000282e0: 7420 7473 2e72 756e 5f73 7065 630a 2020  t ts.run_spec.  
+000282f0: 2020 2020 2020 2020 2020 6966 2074 732e            if ts.
+00028300: 7374 6174 6520 3d3d 2022 7265 6c65 6173  state == "releas
+00028310: 6564 223a 0a20 2020 2020 2020 2020 2020  ed":.           
+00028320: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
+00028330: 696f 6e73 5b74 732e 6b65 795d 203d 2022  ions[ts.key] = "
+00028340: 7761 6974 696e 6722 0a0a 2020 2020 2020  waiting"..      
+00028350: 2020 666f 7220 7473 2069 6e20 7275 6e6e    for ts in runn
+00028360: 6162 6c65 3a0a 2020 2020 2020 2020 2020  able:.          
+00028370: 2020 666f 7220 6474 7320 696e 2074 732e    for dts in ts.
+00028380: 6465 7065 6e64 656e 6369 6573 3a0a 2020  dependencies:.  
+00028390: 2020 2020 2020 2020 2020 2020 2020 6966                if
+000283a0: 2064 7473 2e65 7863 6570 7469 6f6e 5f62   dts.exception_b
+000283b0: 6c61 6d65 3a0a 2020 2020 2020 2020 2020  lame:.          
+000283c0: 2020 2020 2020 2020 2020 7473 2e65 7863            ts.exc
+000283d0: 6570 7469 6f6e 5f62 6c61 6d65 203d 2064  eption_blame = d
+000283e0: 7473 2e65 7863 6570 7469 6f6e 5f62 6c61  ts.exception_bla
+000283f0: 6d65 0a20 2020 2020 2020 2020 2020 2020  me.             
+00028400: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
+00028410: 6174 696f 6e73 5b74 732e 6b65 795d 203d  ations[ts.key] =
+00028420: 2022 6572 7265 6422 0a20 2020 2020 2020   "erred".       
+00028430: 2020 2020 2020 2020 2020 2020 2062 7265               bre
+00028440: 616b 0a0a 2020 2020 2020 2020 616e 6e6f  ak..        anno
+00028450: 7461 7469 6f6e 735f 666f 725f 706c 7567  tations_for_plug
+00028460: 696e 3a20 6465 6661 756c 7464 6963 745b  in: defaultdict[
+00028470: 7374 722c 2064 6963 745b 4b65 792c 2041  str, dict[Key, A
+00028480: 6e79 5d5d 203d 2064 6566 6175 6c74 6469  ny]] = defaultdi
+00028490: 6374 2864 6963 7429 0a20 2020 2020 2020  ct(dict).       
+000284a0: 2066 6f72 206b 6579 2069 6e20 6b65 7973   for key in keys
+000284b0: 5f77 6974 685f 616e 6e6f 7461 7469 6f6e  _with_annotation
+000284c0: 733a 0a20 2020 2020 2020 2020 2020 2074  s:.            t
+000284d0: 7320 3d20 7365 6c66 2e74 6173 6b73 5b6b  s = self.tasks[k
+000284e0: 6579 5d0a 2020 2020 2020 2020 2020 2020  ey].            
+000284f0: 6966 2074 732e 616e 6e6f 7461 7469 6f6e  if ts.annotation
+00028500: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00028510: 2020 2066 6f72 2061 6e6e 6f74 2c20 7661     for annot, va
+00028520: 6c75 6520 696e 2074 732e 616e 6e6f 7461  lue in ts.annota
+00028530: 7469 6f6e 732e 6974 656d 7328 293a 0a20  tions.items():. 
+00028540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028550: 2020 2061 6e6e 6f74 6174 696f 6e73 5f66     annotations_f
+00028560: 6f72 5f70 6c75 6769 6e5b 616e 6e6f 745d  or_plugin[annot]
+00028570: 5b6b 6579 5d20 3d20 7661 6c75 650a 0a20  [key] = value.. 
+00028580: 2020 2020 2020 2073 7061 6e73 5f65 7874         spans_ext
+00028590: 3a20 5370 616e 7353 6368 6564 756c 6572  : SpansScheduler
+000285a0: 4578 7465 6e73 696f 6e20 7c20 4e6f 6e65  Extension | None
+000285b0: 203d 2073 656c 662e 6578 7465 6e73 696f   = self.extensio
+000285c0: 6e73 2e67 6574 2822 7370 616e 7322 290a  ns.get("spans").
+000285d0: 2020 2020 2020 2020 6966 2073 7061 6e73          if spans
+000285e0: 5f65 7874 3a0a 2020 2020 2020 2020 2020  _ext:.          
+000285f0: 2020 2320 6e65 775f 7461 736b 7320 646f    # new_tasks do
+00028600: 6573 206e 6f74 206e 6563 6573 7361 7269  es not necessari
+00028610: 6c79 2063 6f6e 7461 696e 2061 6c6c 2072  ly contain all r
+00028620: 756e 6e61 626c 6520 7461 736b 733b 0a20  unnable tasks;. 
+00028630: 2020 2020 2020 2020 2020 2023 205f 6765             # _ge
+00028640: 6e65 7261 7465 5f74 6173 6b73 7461 7465  nerate_taskstate
+00028650: 7320 6973 206e 6f74 2074 6865 206f 6e6c  s is not the onl
+00028660: 7920 7468 696e 6720 7468 6174 2063 616c  y thing that cal
+00028670: 6c73 206e 6577 5f74 6173 6b28 292e 2041  ls new_task(). A
+00028680: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
+00028690: 6173 6b53 7461 7465 206d 6179 2068 6176  askState may hav
+000286a0: 6520 616c 736f 2062 6565 6e20 6372 6561  e also been crea
+000286b0: 7465 6420 6279 2063 6c69 656e 745f 6465  ted by client_de
+000286c0: 7369 7265 735f 6b65 7973 206f 7220 7363  sires_keys or sc
+000286d0: 6174 7465 722c 0a20 2020 2020 2020 2020  atter,.         
+000286e0: 2020 2023 2061 6e64 206f 6e6c 7920 6c61     # and only la
+000286f0: 7465 7220 6761 696e 6564 2061 2072 756e  ter gained a run
+00028700: 5f73 7065 632e 0a20 2020 2020 2020 2020  _spec..         
+00028710: 2020 2073 7061 6e5f 616e 6e6f 7461 7469     span_annotati
+00028720: 6f6e 7320 3d20 7370 616e 735f 6578 742e  ons = spans_ext.
+00028730: 6f62 7365 7276 655f 7461 736b 7328 0a20  observe_tasks(. 
+00028740: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00028750: 756e 6e61 626c 652c 2073 7061 6e5f 6d65  unnable, span_me
+00028760: 7461 6461 7461 3d73 7061 6e5f 6d65 7461  tadata=span_meta
+00028770: 6461 7461 2c20 636f 6465 3d63 6f64 650a  data, code=code.
+00028780: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00028790: 2020 2020 2020 2020 2020 2320 496e 2063            # In c
+000287a0: 6173 6520 6f66 2054 6173 6b47 726f 7570  ase of TaskGroup
+000287b0: 2063 6f6c 6c69 7369 6f6e 2c20 7370 616e   collision, span
+000287c0: 7320 6d61 7920 6861 7665 2063 6861 6e67  s may have chang
+000287d0: 6564 0a20 2020 2020 2020 2020 2020 2023  ed.            #
+000287e0: 2046 4958 4d45 3a20 4973 2074 6869 7320   FIXME: Is this 
+000287f0: 7573 6564 2061 6e79 7768 6572 6520 6265  used anywhere be
+00028800: 7369 6465 7320 7465 7374 733f 0a20 2020  sides tests?.   
+00028810: 2020 2020 2020 2020 2069 6620 7370 616e           if span
+00028820: 5f61 6e6e 6f74 6174 696f 6e73 3a0a 2020  _annotations:.  
+00028830: 2020 2020 2020 2020 2020 2020 2020 616e                an
+00028840: 6e6f 7461 7469 6f6e 735f 666f 725f 706c  notations_for_pl
+00028850: 7567 696e 5b22 7370 616e 225d 203d 2073  ugin["span"] = s
+00028860: 7061 6e5f 616e 6e6f 7461 7469 6f6e 730a  pan_annotations.
+00028870: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00028880: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00028890: 2020 616e 6e6f 7461 7469 6f6e 735f 666f    annotations_fo
+000288a0: 725f 706c 7567 696e 2e70 6f70 2822 7370  r_plugin.pop("sp
+000288b0: 616e 222c 204e 6f6e 6529 0a0a 2020 2020  an", None)..    
+000288c0: 2020 2020 666f 7220 706c 7567 696e 2069      for plugin i
+000288d0: 6e20 6c69 7374 2873 656c 662e 706c 7567  n list(self.plug
+000288e0: 696e 732e 7661 6c75 6573 2829 293a 0a20  ins.values()):. 
+000288f0: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+00028900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028910: 706c 7567 696e 2e75 7064 6174 655f 6772  plugin.update_gr
+00028920: 6170 6828 0a20 2020 2020 2020 2020 2020  aph(.           
+00028930: 2020 2020 2020 2020 2073 656c 662c 0a20           self,. 
+00028940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028950: 2020 2063 6c69 656e 743d 636c 6965 6e74     client=client
+00028960: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00028970: 2020 2020 2020 7461 736b 733d 5b74 732e        tasks=[ts.
+00028980: 6b65 7920 666f 7220 7473 2069 6e20 746f  key for ts in to
+00028990: 7563 6865 645f 7461 736b 735d 2c0a 2020  uched_tasks],.  
+000289a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000289b0: 2020 6b65 7973 3d6b 6579 732c 0a20 2020    keys=keys,.   
 000289c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000289d0: 7072 696f 7269 7479 3d70 7269 6f72 6974  priority=priorit
-000289e0: 792c 0a20 2020 2020 2020 2020 2020 2020  y,.             
-000289f0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00028a00: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
-00028a10: 6e20 6173 2065 3a0a 2020 2020 2020 2020  n as e:.        
-00028a20: 2020 2020 2020 2020 6c6f 6767 6572 2e65          logger.e
-00028a30: 7863 6570 7469 6f6e 2865 290a 0a20 2020  xception(e)..   
-00028a40: 2020 2020 2073 656c 662e 7472 616e 7369       self.transi
-00028a50: 7469 6f6e 7328 7265 636f 6d6d 656e 6461  tions(recommenda
-00028a60: 7469 6f6e 732c 2073 7469 6d75 6c75 735f  tions, stimulus_
-00028a70: 6964 290a 0a20 2020 2020 2020 2066 6f72  id)..        for
-00028a80: 2074 7320 696e 2074 6f75 6368 6564 5f74   ts in touched_t
-00028a90: 6173 6b73 3a0a 2020 2020 2020 2020 2020  asks:.          
-00028aa0: 2020 6966 2074 732e 7374 6174 6520 696e    if ts.state in
-00028ab0: 2028 226d 656d 6f72 7922 2c20 2265 7272   ("memory", "err
-00028ac0: 6564 2229 3a0a 2020 2020 2020 2020 2020  ed"):.          
-00028ad0: 2020 2020 2020 7365 6c66 2e72 6570 6f72        self.repor
-00028ae0: 745f 6f6e 5f6b 6579 2874 733d 7473 2c20  t_on_key(ts=ts, 
-00028af0: 636c 6965 6e74 3d63 6c69 656e 7429 0a0a  client=client)..
-00028b00: 2020 2020 406c 6f67 5f65 7272 6f72 730a      @log_errors.
-00028b10: 2020 2020 6173 796e 6320 6465 6620 7570      async def up
-00028b20: 6461 7465 5f67 7261 7068 280a 2020 2020  date_graph(.    
-00028b30: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-00028b40: 2020 636c 6965 6e74 3a20 7374 722c 0a20    client: str,. 
-00028b50: 2020 2020 2020 2067 7261 7068 5f68 6561         graph_hea
-00028b60: 6465 723a 2064 6963 742c 0a20 2020 2020  der: dict,.     
-00028b70: 2020 2067 7261 7068 5f66 7261 6d65 733a     graph_frames:
-00028b80: 206c 6973 745b 6279 7465 735d 2c0a 2020   list[bytes],.  
-00028b90: 2020 2020 2020 6b65 7973 3a20 7365 745b        keys: set[
-00028ba0: 4b65 795d 2c0a 2020 2020 2020 2020 696e  Key],.        in
-00028bb0: 7465 726e 616c 5f70 7269 6f72 6974 793a  ternal_priority:
-00028bc0: 2064 6963 745b 4b65 792c 2069 6e74 5d20   dict[Key, int] 
-00028bd0: 7c20 4e6f 6e65 2c0a 2020 2020 2020 2020  | None,.        
-00028be0: 7375 626d 6974 7469 6e67 5f74 6173 6b3a  submitting_task:
-00028bf0: 204b 6579 207c 204e 6f6e 652c 0a20 2020   Key | None,.   
-00028c00: 2020 2020 2075 7365 725f 7072 696f 7269       user_priori
-00028c10: 7479 3a20 696e 7420 7c20 6469 6374 5b4b  ty: int | dict[K
-00028c20: 6579 2c20 696e 745d 203d 2030 2c0a 2020  ey, int] = 0,.  
-00028c30: 2020 2020 2020 6163 746f 7273 3a20 626f        actors: bo
-00028c40: 6f6c 207c 206c 6973 745b 4b65 795d 207c  ol | list[Key] |
-00028c50: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
-00028c60: 2020 2020 2020 6669 666f 5f74 696d 656f        fifo_timeo
-00028c70: 7574 3a20 666c 6f61 7420 3d20 302e 302c  ut: float = 0.0,
-00028c80: 0a20 2020 2020 2020 2063 6f64 653a 2074  .        code: t
-00028c90: 7570 6c65 5b53 6f75 7263 6543 6f64 652c  uple[SourceCode,
-00028ca0: 202e 2e2e 5d20 3d20 2829 2c0a 2020 2020   ...] = (),.    
-00028cb0: 2020 2020 616e 6e6f 7461 7469 6f6e 733a      annotations:
-00028cc0: 2064 6963 7420 7c20 4e6f 6e65 203d 204e   dict | None = N
-00028cd0: 6f6e 652c 0a20 2020 2020 2020 2073 7469  one,.        sti
-00028ce0: 6d75 6c75 735f 6964 3a20 7374 7220 7c20  mulus_id: str | 
-00028cf0: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
-00028d00: 2029 202d 3e20 4e6f 6e65 3a0a 2020 2020   ) -> None:.    
-00028d10: 2020 2020 7374 6172 7420 3d20 7469 6d65      start = time
-00028d20: 2829 0a20 2020 2020 2020 2074 7279 3a0a  ().        try:.
-00028d30: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-00028d40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00028d50: 2067 7261 7068 203d 2064 6573 6572 6961   graph = deseria
-00028d60: 6c69 7a65 2867 7261 7068 5f68 6561 6465  lize(graph_heade
-00028d70: 722c 2067 7261 7068 5f66 7261 6d65 7329  r, graph_frames)
-00028d80: 2e64 6174 610a 2020 2020 2020 2020 2020  .data.          
-00028d90: 2020 2020 2020 6465 6c20 6772 6170 685f        del graph_
-00028da0: 6865 6164 6572 2c20 6772 6170 685f 6672  header, graph_fr
-00028db0: 616d 6573 0a20 2020 2020 2020 2020 2020  ames.           
-00028dc0: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
-00028dd0: 6e20 6173 2065 3a0a 2020 2020 2020 2020  n as e:.        
-00028de0: 2020 2020 2020 2020 6d73 6720 3d20 2222          msg = ""
-00028df0: 225c 0a20 2020 2020 2020 2020 2020 2020  "\.             
-00028e00: 2020 2020 2020 2045 7272 6f72 2064 7572         Error dur
-00028e10: 696e 6720 6465 7365 7269 616c 697a 6174  ing deserializat
-00028e20: 696f 6e20 6f66 2074 6865 2074 6173 6b20  ion of the task 
-00028e30: 6772 6170 682e 2054 6869 7320 6672 6571  graph. This freq
-00028e40: 7565 6e74 6c79 0a20 2020 2020 2020 2020  uently.         
-00028e50: 2020 2020 2020 2020 2020 206f 6363 7572             occur
-00028e60: 7320 6966 2074 6865 2053 6368 6564 756c  s if the Schedul
-00028e70: 6572 2061 6e64 2043 6c69 656e 7420 6861  er and Client ha
-00028e80: 7665 2064 6966 6665 7265 6e74 2065 6e76  ve different env
-00028e90: 6972 6f6e 6d65 6e74 732e 0a20 2020 2020  ironments..     
-00028ea0: 2020 2020 2020 2020 2020 2020 2020 2046                 F
-00028eb0: 6f72 206d 6f72 6520 696e 666f 726d 6174  or more informat
-00028ec0: 696f 6e2c 2073 6565 0a20 2020 2020 2020  ion, see.       
-00028ed0: 2020 2020 2020 2020 2020 2020 2068 7474               htt
-00028ee0: 7073 3a2f 2f64 6f63 732e 6461 736b 2e6f  ps://docs.dask.o
-00028ef0: 7267 2f65 6e2f 7374 6162 6c65 2f64 6570  rg/en/stable/dep
-00028f00: 6c6f 796d 656e 742d 636f 6e73 6964 6572  loyment-consider
-00028f10: 6174 696f 6e73 2e68 746d 6c23 636f 6e73  ations.html#cons
-00028f20: 6973 7465 6e74 2d73 6f66 7477 6172 652d  istent-software-
-00028f30: 656e 7669 726f 6e6d 656e 7473 0a20 2020  environments.   
-00028f40: 2020 2020 2020 2020 2020 2020 2022 2222               """
-00028f50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00028f60: 2072 6169 7365 2052 756e 7469 6d65 4572   raise RuntimeEr
-00028f70: 726f 7228 7465 7874 7772 6170 2e64 6564  ror(textwrap.ded
-00028f80: 656e 7428 6d73 6729 2920 6672 6f6d 2065  ent(msg)) from e
-00028f90: 0a20 2020 2020 2020 2020 2020 2028 0a20  .            (. 
-00028fa0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00028fb0: 736b 2c0a 2020 2020 2020 2020 2020 2020  sk,.            
-00028fc0: 2020 2020 6465 7065 6e64 656e 6369 6573      dependencies
-00028fd0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00028fe0: 2020 616e 6e6f 7461 7469 6f6e 735f 6279    annotations_by
-00028ff0: 5f74 7970 652c 0a20 2020 2020 2020 2020  _type,.         
-00029000: 2020 2029 203d 2061 7761 6974 206f 6666     ) = await off
-00029010: 6c6f 6164 280a 2020 2020 2020 2020 2020  load(.          
-00029020: 2020 2020 2020 5f6d 6174 6572 6961 6c69        _materiali
-00029030: 7a65 5f67 7261 7068 2c0a 2020 2020 2020  ze_graph,.      
-00029040: 2020 2020 2020 2020 2020 6772 6170 683d            graph=
-00029050: 6772 6170 682c 0a20 2020 2020 2020 2020  graph,.         
-00029060: 2020 2020 2020 2067 6c6f 6261 6c5f 616e         global_an
-00029070: 6e6f 7461 7469 6f6e 733d 616e 6e6f 7461  notations=annota
-00029080: 7469 6f6e 7320 6f72 207b 7d2c 0a20 2020  tions or {},.   
-00029090: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-000290a0: 2020 2020 2020 2064 656c 2067 7261 7068         del graph
-000290b0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000290c0: 6e6f 7420 696e 7465 726e 616c 5f70 7269  not internal_pri
-000290d0: 6f72 6974 793a 0a20 2020 2020 2020 2020  ority:.         
-000290e0: 2020 2020 2020 2023 2052 656d 6f76 696e         # Removin
-000290f0: 6720 616c 6c20 6e6f 6e2d 6c6f 6361 6c20  g all non-local 
-00029100: 6b65 7973 2062 6566 6f72 6520 6361 6c6c  keys before call
-00029110: 696e 6720 6f72 6465 7228 290a 2020 2020  ing order().    
-00029120: 2020 2020 2020 2020 2020 2020 6473 6b5f              dsk_
-00029130: 6b65 7973 203d 2073 6574 280a 2020 2020  keys = set(.    
-00029140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029150: 6473 6b0a 2020 2020 2020 2020 2020 2020  dsk.            
-00029160: 2020 2020 2920 2023 2069 6e74 6572 7365      )  # interse
-00029170: 6374 696f 6e28 2920 6f66 2073 6574 7320  ction() of sets 
-00029180: 6973 206d 7563 6820 6661 7374 6572 2074  is much faster t
-00029190: 6861 6e20 6469 6374 5f6b 6579 730a 2020  han dict_keys.  
-000291a0: 2020 2020 2020 2020 2020 2020 2020 7374                st
-000291b0: 7269 7070 6564 5f64 6570 7320 3d20 7b0a  ripped_deps = {.
-000291c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000291d0: 2020 2020 6b3a 2076 2e69 6e74 6572 7365      k: v.interse
-000291e0: 6374 696f 6e28 6473 6b5f 6b65 7973 290a  ction(dsk_keys).
-000291f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029200: 2020 2020 666f 7220 6b2c 2076 2069 6e20      for k, v in 
-00029210: 6465 7065 6e64 656e 6369 6573 2e69 7465  dependencies.ite
-00029220: 6d73 2829 0a20 2020 2020 2020 2020 2020  ms().           
-00029230: 2020 2020 2020 2020 2069 6620 6b20 696e           if k in
-00029240: 2064 736b 5f6b 6579 730a 2020 2020 2020   dsk_keys.      
-00029250: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-00029260: 2020 2020 2020 2020 2020 2020 696e 7465              inte
-00029270: 726e 616c 5f70 7269 6f72 6974 7920 3d20  rnal_priority = 
-00029280: 6177 6169 7420 6f66 666c 6f61 6428 0a20  await offload(. 
-00029290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000292a0: 2020 2064 6173 6b2e 6f72 6465 722e 6f72     dask.order.or
-000292b0: 6465 722c 2064 736b 3d64 736b 2c20 6465  der, dsk=dsk, de
-000292c0: 7065 6e64 656e 6369 6573 3d73 7472 6970  pendencies=strip
-000292d0: 7065 645f 6465 7073 0a20 2020 2020 2020  ped_deps.       
-000292e0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-000292f0: 2020 2020 2020 2020 7365 6c66 2e5f 6372          self._cr
-00029300: 6561 7465 5f74 6173 6b73 7461 7465 5f66  eate_taskstate_f
-00029310: 726f 6d5f 6772 6170 6828 0a20 2020 2020  rom_graph(.     
-00029320: 2020 2020 2020 2020 2020 2064 736b 3d64             dsk=d
-00029330: 736b 2c0a 2020 2020 2020 2020 2020 2020  sk,.            
-00029340: 2020 2020 636c 6965 6e74 3d63 6c69 656e      client=clien
-00029350: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-00029360: 2020 2064 6570 656e 6465 6e63 6965 733d     dependencies=
-00029370: 6465 7065 6e64 656e 6369 6573 2c0a 2020  dependencies,.  
-00029380: 2020 2020 2020 2020 2020 2020 2020 6b65                ke
-00029390: 7973 3d73 6574 286b 6579 7329 2c0a 2020  ys=set(keys),.  
-000293a0: 2020 2020 2020 2020 2020 2020 2020 6f72                or
-000293b0: 6465 7265 643d 696e 7465 726e 616c 5f70  dered=internal_p
-000293c0: 7269 6f72 6974 7920 6f72 207b 7d2c 0a20  riority or {},. 
-000293d0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000293e0: 7562 6d69 7474 696e 675f 7461 736b 3d73  ubmitting_task=s
-000293f0: 7562 6d69 7474 696e 675f 7461 736b 2c0a  ubmitting_task,.
-00029400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029410: 7573 6572 5f70 7269 6f72 6974 793d 7573  user_priority=us
-00029420: 6572 5f70 7269 6f72 6974 792c 0a20 2020  er_priority,.   
-00029430: 2020 2020 2020 2020 2020 2020 2061 6374               act
-00029440: 6f72 733d 6163 746f 7273 2c0a 2020 2020  ors=actors,.    
-00029450: 2020 2020 2020 2020 2020 2020 6669 666f              fifo
-00029460: 5f74 696d 656f 7574 3d66 6966 6f5f 7469  _timeout=fifo_ti
-00029470: 6d65 6f75 742c 0a20 2020 2020 2020 2020  meout,.         
-00029480: 2020 2020 2020 2063 6f64 653d 636f 6465         code=code
-00029490: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000294a0: 2020 616e 6e6f 7461 7469 6f6e 735f 6279    annotations_by
-000294b0: 5f74 7970 653d 616e 6e6f 7461 7469 6f6e  _type=annotation
-000294c0: 735f 6279 5f74 7970 652c 0a20 2020 2020  s_by_type,.     
-000294d0: 2020 2020 2020 2020 2020 2023 2046 4958             # FIX
-000294e0: 4d45 3a20 5468 6973 2069 7320 6a75 7374  ME: This is just
-000294f0: 2075 7365 6420 746f 2061 7474 6163 6820   used to attach 
-00029500: 746f 2043 6f6d 7075 7461 7469 6f6e 0a20  to Computation. 
-00029510: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00029520: 206f 626a 6563 7473 2e20 5468 6973 2073   objects. This s
-00029530: 686f 756c 6420 6265 2072 656d 6f76 6564  hould be removed
-00029540: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00029550: 2067 6c6f 6261 6c5f 616e 6e6f 7461 7469   global_annotati
-00029560: 6f6e 733d 616e 6e6f 7461 7469 6f6e 732c  ons=annotations,
-00029570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00029580: 2073 7461 7274 3d73 7461 7274 2c0a 2020   start=start,.  
-00029590: 2020 2020 2020 2020 2020 2020 2020 7374                st
-000295a0: 696d 756c 7573 5f69 643d 7374 696d 756c  imulus_id=stimul
-000295b0: 7573 5f69 6420 6f72 2066 2275 7064 6174  us_id or f"updat
-000295c0: 652d 6772 6170 682d 7b73 7461 7274 7d22  e-graph-{start}"
-000295d0: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
-000295e0: 2020 2020 2020 2020 6578 6365 7074 2052          except R
-000295f0: 756e 7469 6d65 4572 726f 7220 6173 2065  untimeError as e
-00029600: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
-00029610: 6767 6572 2e65 7272 6f72 2873 7472 2865  gger.error(str(e
-00029620: 2929 0a20 2020 2020 2020 2020 2020 2065  )).            e
-00029630: 7272 203d 2065 7272 6f72 5f6d 6573 7361  rr = error_messa
-00029640: 6765 2865 290a 2020 2020 2020 2020 2020  ge(e).          
-00029650: 2020 666f 7220 6b65 7920 696e 206b 6579    for key in key
-00029660: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00029670: 2020 2073 656c 662e 7265 706f 7274 280a     self.report(.
-00029680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029690: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-000296a0: 2020 2020 2020 2020 2020 2020 2020 226f                "o
-000296b0: 7022 3a20 2274 6173 6b2d 6572 7265 6422  p": "task-erred"
-000296c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000296d0: 2020 2020 2020 2020 2020 226b 6579 223a            "key":
-000296e0: 206b 6579 2c0a 2020 2020 2020 2020 2020   key,.          
-000296f0: 2020 2020 2020 2020 2020 2020 2020 2265                "e
-00029700: 7863 6570 7469 6f6e 223a 2065 7272 5b22  xception": err["
-00029710: 6578 6365 7074 696f 6e22 5d2c 0a20 2020  exception"],.   
-00029720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029730: 2020 2020 2022 7472 6163 6562 6163 6b22       "traceback"
-00029740: 3a20 6572 725b 2274 7261 6365 6261 636b  : err["traceback
-00029750: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
-00029760: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
-00029770: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00029780: 2054 6869 7320 696e 666f 726d 7320 616c   This informs al
-00029790: 6c20 636c 6965 6e74 7320 696e 2077 686f  l clients in who
-000297a0: 5f77 616e 7473 2070 6c75 7320 7468 6520  _wants plus the 
-000297b0: 6375 7272 656e 7420 636c 6965 6e74 0a20  current client. 
-000297c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000297d0: 2020 2023 2028 7768 6963 6820 6d61 7920     # (which may 
-000297e0: 6e6f 7420 6861 7665 2062 6565 6e20 6164  not have been ad
-000297f0: 6465 6420 746f 2077 686f 5f77 616e 7473  ded to who_wants
-00029800: 2079 6574 290a 2020 2020 2020 2020 2020   yet).          
-00029810: 2020 2020 2020 2020 2020 636c 6965 6e74            client
-00029820: 3d63 6c69 656e 742c 0a20 2020 2020 2020  =client,.       
-00029830: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00029840: 2020 2065 6e64 203d 2074 696d 6528 290a     end = time().
-00029850: 2020 2020 2020 2020 7365 6c66 2e64 6967          self.dig
-00029860: 6573 745f 6d65 7472 6963 2822 7570 6461  est_metric("upda
-00029870: 7465 2d67 7261 7068 2d64 7572 6174 696f  te-graph-duratio
-00029880: 6e22 2c20 656e 6420 2d20 7374 6172 7429  n", end - start)
-00029890: 0a0a 2020 2020 6465 6620 5f67 656e 6572  ..    def _gener
-000298a0: 6174 655f 7461 736b 7374 6174 6573 280a  ate_taskstates(.
-000298b0: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
-000298c0: 2020 2020 2020 6b65 7973 3a20 7365 745b        keys: set[
-000298d0: 4b65 795d 2c0a 2020 2020 2020 2020 6473  Key],.        ds
-000298e0: 6b3a 2064 6963 745b 4b65 792c 2054 5f72  k: dict[Key, T_r
-000298f0: 756e 7370 6563 5d2c 0a20 2020 2020 2020  unspec],.       
-00029900: 2064 6570 656e 6465 6e63 6965 733a 2064   dependencies: d
-00029910: 6963 745b 4b65 792c 2073 6574 5b4b 6579  ict[Key, set[Key
-00029920: 5d5d 2c0a 2020 2020 2020 2020 636f 6d70  ]],.        comp
-00029930: 7574 6174 696f 6e3a 2043 6f6d 7075 7461  utation: Computa
-00029940: 7469 6f6e 2c0a 2020 2020 2920 2d3e 2074  tion,.    ) -> t
-00029950: 7570 6c65 3a0a 2020 2020 2020 2020 2320  uple:.        # 
-00029960: 4765 7420 6f72 2063 7265 6174 6520 7461  Get or create ta
-00029970: 736b 2073 7461 7465 730a 2020 2020 2020  sk states.      
-00029980: 2020 7275 6e6e 6162 6c65 203d 205b 5d0a    runnable = [].
-00029990: 2020 2020 2020 2020 6e65 775f 7461 736b          new_task
-000299a0: 7320 3d20 5b5d 0a20 2020 2020 2020 2073  s = [].        s
-000299b0: 7461 636b 203d 206c 6973 7428 6b65 7973  tack = list(keys
-000299c0: 290a 2020 2020 2020 2020 746f 7563 6865  ).        touche
-000299d0: 645f 6b65 7973 203d 2073 6574 2829 0a20  d_keys = set(). 
-000299e0: 2020 2020 2020 2074 6f75 6368 6564 5f74         touched_t
-000299f0: 6173 6b73 203d 205b 5d0a 2020 2020 2020  asks = [].      
-00029a00: 2020 7467 735f 7769 7468 5f62 6164 5f72    tgs_with_bad_r
-00029a10: 756e 5f73 7065 6320 3d20 7365 7428 290a  un_spec = set().
-00029a20: 2020 2020 2020 2020 7768 696c 6520 7374          while st
-00029a30: 6163 6b3a 0a20 2020 2020 2020 2020 2020  ack:.           
-00029a40: 206b 203d 2073 7461 636b 2e70 6f70 2829   k = stack.pop()
-00029a50: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00029a60: 6b20 696e 2074 6f75 6368 6564 5f6b 6579  k in touched_key
-00029a70: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00029a80: 2020 2063 6f6e 7469 6e75 650a 2020 2020     continue.    
-00029a90: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
-00029aa0: 662e 7461 736b 732e 6765 7428 6b29 0a20  f.tasks.get(k). 
-00029ab0: 2020 2020 2020 2020 2020 2069 6620 7473             if ts
-00029ac0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-00029ad0: 2020 2020 2020 2020 2020 7473 203d 2073            ts = s
-00029ae0: 656c 662e 6e65 775f 7461 736b 286b 2c20  elf.new_task(k, 
-00029af0: 6473 6b2e 6765 7428 6b29 2c20 2272 656c  dsk.get(k), "rel
-00029b00: 6561 7365 6422 2c20 636f 6d70 7574 6174  eased", computat
-00029b10: 696f 6e3d 636f 6d70 7574 6174 696f 6e29  ion=computation)
-00029b20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00029b30: 206e 6577 5f74 6173 6b73 2e61 7070 656e   new_tasks.appen
-00029b40: 6428 7473 290a 2020 2020 2020 2020 2020  d(ts).          
-00029b50: 2020 2320 4974 2069 7320 706f 7373 6962    # It is possib
-00029b60: 6c65 2074 6f20 6372 6561 7465 2074 6865  le to create the
-00029b70: 2054 6173 6b53 7461 7465 206f 626a 6563   TaskState objec
-00029b80: 7420 6265 666f 7265 2069 7473 2072 756e  t before its run
-00029b90: 7370 6563 2069 7320 6b6e 6f77 6e0a 2020  spec is known.  
-00029ba0: 2020 2020 2020 2020 2020 2320 746f 2074            # to t
-00029bb0: 6865 2073 6368 6564 756c 6572 2e20 466f  he scheduler. Fo
-00029bc0: 7220 696e 7374 616e 6365 2c20 7468 6973  r instance, this
-00029bd0: 2069 7320 706f 7373 6962 6c65 2077 6865   is possible whe
-00029be0: 6e20 7573 696e 6720 6120 5661 7269 6162  n using a Variab
-00029bf0: 6c65 3a0a 2020 2020 2020 2020 2020 2020  le:.            
-00029c00: 2320 6066 203d 2063 2e73 7562 6d69 7428  # `f = c.submit(
-00029c10: 666f 6f29 3b20 6177 6169 7420 5661 7269  foo); await Vari
-00029c20: 6162 6c65 2829 2e73 6574 2866 2960 2073  able().set(f)` s
-00029c30: 696e 6365 2074 6865 2056 6172 6961 626c  ince the Variabl
-00029c40: 6520 7573 6573 2061 0a20 2020 2020 2020  e uses a.       
-00029c50: 2020 2020 2023 2064 6966 6665 7265 6e74       # different
-00029c60: 2063 6f6d 6d20 6368 616e 6e65 6c2c 2073   comm channel, s
-00029c70: 6f20 7468 6520 6063 6c69 656e 745f 6465  o the `client_de
-00029c80: 7369 7265 735f 6b65 7960 206d 6573 7361  sires_key` messa
-00029c90: 6765 2063 6f75 6c64 2061 7272 6976 650a  ge could arrive.
-00029ca0: 2020 2020 2020 2020 2020 2020 2320 6265              # be
-00029cb0: 666f 7265 2060 7570 6461 7465 5f67 7261  fore `update_gra
-00029cc0: 7068 602e 0a20 2020 2020 2020 2020 2020  ph`..           
-00029cd0: 2023 2054 6865 7265 2061 7265 2061 6c73   # There are als
-00029ce0: 6f20 616e 7469 2d70 6174 7465 726e 2070  o anti-pattern p
-00029cf0: 726f 6365 7373 6573 2070 6f73 7369 626c  rocesses possibl
-00029d00: 653b 0a20 2020 2020 2020 2020 2020 2023  e;.            #
-00029d10: 2073 6565 2066 6f72 2065 7861 6d70 6c65   see for example
-00029d20: 2074 6573 745f 7363 6174 7465 725f 6372   test_scatter_cr
-00029d30: 6561 7465 735f 7473 0a20 2020 2020 2020  eates_ts.       
-00029d40: 2020 2020 2065 6c69 6620 7473 2e72 756e       elif ts.run
-00029d50: 5f73 7065 6320 6973 204e 6f6e 653a 0a20  _spec is None:. 
-00029d60: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00029d70: 732e 7275 6e5f 7370 6563 203d 2064 736b  s.run_spec = dsk
-00029d80: 2e67 6574 286b 290a 2020 2020 2020 2020  .get(k).        
-00029d90: 2020 2020 2320 7275 6e5f 7370 6563 2069      # run_spec i
-00029da0: 6e20 7468 6520 7375 626d 6974 7465 6420  n the submitted 
-00029db0: 6772 6170 6820 6d61 7920 6265 204e 6f6e  graph may be Non
-00029dc0: 652e 2054 6869 7320 6861 7070 656e 730a  e. This happens.
-00029dd0: 2020 2020 2020 2020 2020 2020 2320 7768              # wh
-00029de0: 656e 2061 6e20 616c 7265 6164 7920 7065  en an already pe
-00029df0: 7273 6973 7465 6420 6675 7475 7265 2069  rsisted future i
-00029e00: 7320 7061 7274 206f 6620 7468 6520 6772  s part of the gr
-00029e10: 6170 680a 2020 2020 2020 2020 2020 2020  aph.            
-00029e20: 656c 6966 206b 2069 6e20 6473 6b3a 0a20  elif k in dsk:. 
-00029e30: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00029e40: 2049 6620 626f 7468 2074 6f6b 656e 7320   If both tokens 
-00029e50: 6172 6520 6e6f 6e2d 6465 7465 726d 696e  are non-determin
-00029e60: 6973 7469 632c 2073 6b69 7020 636f 6d70  istic, skip comp
-00029e70: 6172 6973 6f6e 0a20 2020 2020 2020 2020  arison.         
-00029e80: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00029e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029ea0: 746f 6b5f 6c68 7320 3d20 746f 6b65 6e69  tok_lhs = tokeni
-00029eb0: 7a65 2874 732e 7275 6e5f 7370 6563 2c20  ze(ts.run_spec, 
-00029ec0: 656e 7375 7265 5f64 6574 6572 6d69 6e69  ensure_determini
-00029ed0: 7374 6963 3d54 7275 6529 0a20 2020 2020  stic=True).     
-00029ee0: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-00029ef0: 7420 546f 6b65 6e69 7a61 7469 6f6e 4572  t TokenizationEr
-00029f00: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
-00029f10: 2020 2020 2020 2020 2074 6f6b 5f6c 6873           tok_lhs
-00029f20: 203d 2022 220a 2020 2020 2020 2020 2020   = "".          
-00029f30: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-00029f40: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00029f50: 6f6b 5f72 6873 203d 2074 6f6b 656e 697a  ok_rhs = tokeniz
-00029f60: 6528 6473 6b5b 6b5d 2c20 656e 7375 7265  e(dsk[k], ensure
-00029f70: 5f64 6574 6572 6d69 6e69 7374 6963 3d54  _deterministic=T
-00029f80: 7275 6529 0a20 2020 2020 2020 2020 2020  rue).           
-00029f90: 2020 2020 2065 7863 6570 7420 546f 6b65       except Toke
-00029fa0: 6e69 7a61 7469 6f6e 4572 726f 723a 0a20  nizationError:. 
-00029fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029fc0: 2020 2074 6f6b 5f72 6873 203d 2022 220a     tok_rhs = "".
-00029fd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00029fe0: 2023 2041 6464 6974 696f 6e61 6c6c 7920   # Additionally 
-00029ff0: 6368 6563 6b20 6465 7065 6e64 656e 6379  check dependency
-0002a000: 206e 616d 6573 2e20 5468 6973 2073 686f   names. This sho
-0002a010: 756c 6420 6f6e 6c79 2062 6520 6e65 6365  uld only be nece
-0002a020: 7373 6172 790a 2020 2020 2020 2020 2020  ssary.          
-0002a030: 2020 2020 2020 2320 6966 2072 756e 5f73        # if run_s
-0002a040: 7065 6373 2063 616e 2774 2062 6520 746f  pecs can't be to
-0002a050: 6b65 6e69 7a65 6420 6465 7465 726d 696e  kenized determin
-0002a060: 6973 7469 6361 6c6c 792e 0a20 2020 2020  istically..     
-0002a070: 2020 2020 2020 2020 2020 2064 6570 735f             deps_
-0002a080: 6c68 7320 3d20 7b64 7473 2e6b 6579 2066  lhs = {dts.key f
-0002a090: 6f72 2064 7473 2069 6e20 7473 2e64 6570  or dts in ts.dep
-0002a0a0: 656e 6465 6e63 6965 737d 0a20 2020 2020  endencies}.     
-0002a0b0: 2020 2020 2020 2020 2020 2064 6570 735f             deps_
-0002a0c0: 7268 7320 3d20 6465 7065 6e64 656e 6369  rhs = dependenci
-0002a0d0: 6573 5b6b 5d0a 0a20 2020 2020 2020 2020  es[k]..         
-0002a0e0: 2020 2020 2020 2023 2046 4958 4d45 2049         # FIXME I
-0002a0f0: 7420 776f 756c 6420 6265 2061 2072 6561  t would be a rea
-0002a100: 6c6c 7920 6865 616c 7468 7920 6964 6561  lly healthy idea
-0002a110: 2074 6f20 6368 616e 6765 2074 6869 7320   to change this 
-0002a120: 746f 2061 2068 6172 640a 2020 2020 2020  to a hard.      
-0002a130: 2020 2020 2020 2020 2020 2320 6661 696c            # fail
-0002a140: 7572 652e 2048 6f77 6576 6572 2c20 7468  ure. However, th
-0002a150: 6973 2069 7320 6e6f 7420 706f 7373 6962  is is not possib
-0002a160: 6c65 2061 7420 7468 6520 6d6f 6d65 6e74  le at the moment
-0002a170: 2062 6563 6175 7365 206f 660a 2020 2020   because of.    
-0002a180: 2020 2020 2020 2020 2020 2020 2320 6874              # ht
-0002a190: 7470 733a 2f2f 6769 7468 7562 2e63 6f6d  tps://github.com
-0002a1a0: 2f64 6173 6b2f 6461 736b 2f69 7373 7565  /dask/dask/issue
-0002a1b0: 732f 3938 3838 0a20 2020 2020 2020 2020  s/9888.         
-0002a1c0: 2020 2020 2020 2069 6620 746f 6b5f 6c68         if tok_lh
-0002a1d0: 7320 213d 2074 6f6b 5f72 6873 206f 7220  s != tok_rhs or 
-0002a1e0: 6465 7073 5f6c 6873 2021 3d20 6465 7073  deps_lhs != deps
-0002a1f0: 5f72 6873 3a0a 2020 2020 2020 2020 2020  _rhs:.          
-0002a200: 2020 2020 2020 2020 2020 2320 5265 7461            # Reta
-0002a210: 696e 206f 6c64 2072 756e 5f73 7065 6320  in old run_spec 
-0002a220: 616e 6420 6465 7065 6e64 656e 6369 6573  and dependencies
-0002a230: 3b20 7265 7275 6e20 7468 656d 2069 6620  ; rerun them if 
-0002a240: 6e65 6365 7373 6172 792e 0a20 2020 2020  necessary..     
-0002a250: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0002a260: 2054 6869 7320 7377 6565 7073 2074 6865   This sweeps the
-0002a270: 2069 7373 7565 206f 6620 636f 6c6c 6973   issue of collis
-0002a280: 696f 6e20 756e 6465 7220 7468 6520 6361  ion under the ca
-0002a290: 7270 6574 2061 7320 6c6f 6e67 2061 7320  rpet as long as 
-0002a2a0: 7468 650a 2020 2020 2020 2020 2020 2020  the.            
-0002a2b0: 2020 2020 2020 2020 2320 6f6c 6420 616e          # old an
-0002a2c0: 6420 6e65 7720 7461 736b 2070 726f 6475  d new task produ
-0002a2d0: 6365 2074 6865 2073 616d 6520 6f75 7470  ce the same outp
-0002a2e0: 7574 202d 2073 7563 6820 6173 2069 6e0a  ut - such as in.
-0002a2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a300: 2020 2020 2320 6461 736b 2f64 6173 6b23      # dask/dask#
-0002a310: 3938 3838 2e0a 2020 2020 2020 2020 2020  9888..          
-0002a320: 2020 2020 2020 2020 2020 6465 7065 6e64            depend
-0002a330: 656e 6369 6573 5b6b 5d20 3d20 6465 7073  encies[k] = deps
-0002a340: 5f6c 6873 0a0a 2020 2020 2020 2020 2020  _lhs..          
-0002a350: 2020 2020 2020 2020 2020 6966 2074 732e            if ts.
-0002a360: 6772 6f75 7020 6e6f 7420 696e 2074 6773  group not in tgs
-0002a370: 5f77 6974 685f 6261 645f 7275 6e5f 7370  _with_bad_run_sp
-0002a380: 6563 3a0a 2020 2020 2020 2020 2020 2020  ec:.            
-0002a390: 2020 2020 2020 2020 2020 2020 7467 735f              tgs_
-0002a3a0: 7769 7468 5f62 6164 5f72 756e 5f73 7065  with_bad_run_spe
-0002a3b0: 632e 6164 6428 7473 2e67 726f 7570 290a  c.add(ts.group).
-0002a3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a3d0: 2020 2020 2020 2020 6c6f 6767 6572 2e77          logger.w
-0002a3e0: 6172 6e69 6e67 280a 2020 2020 2020 2020  arning(.        
-0002a3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a400: 2020 2020 6622 4465 7465 6374 6564 2064      f"Detected d
-0002a410: 6966 6665 7265 6e74 2060 7275 6e5f 7370  ifferent `run_sp
-0002a420: 6563 6020 666f 7220 6b65 7920 7b74 732e  ec` for key {ts.
-0002a430: 6b65 7921 727d 2062 6574 7765 656e 2022  key!r} between "
-0002a440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002a450: 2020 2020 2020 2020 2020 2020 2022 7477               "tw
-0002a460: 6f20 636f 6e73 6563 7574 6976 6520 6361  o consecutive ca
-0002a470: 6c6c 7320 746f 2060 7570 6461 7465 5f67  lls to `update_g
-0002a480: 7261 7068 602e 2022 0a20 2020 2020 2020  raph`. ".       
-0002a490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a4a0: 2020 2020 2022 5468 6973 2063 616e 2063       "This can c
-0002a4b0: 6175 7365 2066 6169 6c75 7265 7320 616e  ause failures an
-0002a4c0: 6420 6465 6164 6c6f 636b 7320 646f 776e  d deadlocks down
-0002a4d0: 2074 6865 206c 696e 652e 2022 0a20 2020   the line. ".   
-0002a4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a4f0: 2020 2020 2020 2020 2022 506c 6561 7365           "Please
-0002a500: 2065 6e73 7572 6520 756e 6971 7565 206b   ensure unique k
-0002a510: 6579 206e 616d 6573 2e20 220a 2020 2020  ey names. ".    
-0002a520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a530: 2020 2020 2020 2020 2249 6620 796f 7520          "If you 
-0002a540: 6172 6520 7573 696e 6720 6120 7374 616e  are using a stan
-0002a550: 6461 7264 2064 6173 6b20 636f 6c6c 6563  dard dask collec
-0002a560: 7469 6f6e 732c 2063 6f6e 7369 6465 7220  tions, consider 
-0002a570: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0002a580: 2020 2020 2020 2020 2020 2020 2020 2272                "r
-0002a590: 656c 6561 7369 6e67 2061 6c6c 2074 6865  eleasing all the
-0002a5a0: 2064 6174 6120 6265 666f 7265 2072 6573   data before res
-0002a5b0: 7562 6d69 7474 696e 6720 616e 6f74 6865  ubmitting anothe
-0002a5c0: 7220 220a 2020 2020 2020 2020 2020 2020  r ".            
-0002a5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a5e0: 2263 6f6d 7075 7461 7469 6f6e 2e20 4d6f  "computation. Mo
-0002a5f0: 7265 2064 6574 6169 6c73 2061 6e64 2068  re details and h
-0002a600: 656c 7020 6361 6e20 6265 2066 6f75 6e64  elp can be found
-0002a610: 2061 7420 220a 2020 2020 2020 2020 2020   at ".          
-0002a620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a630: 2020 2268 7474 7073 3a2f 2f67 6974 6875    "https://githu
-0002a640: 622e 636f 6d2f 6461 736b 2f64 6173 6b2f  b.com/dask/dask/
-0002a650: 6973 7375 6573 2f39 3838 382e 2022 0a20  issues/9888. ". 
-0002a660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a670: 2020 2020 2020 2020 2020 202b 2074 6578             + tex
-0002a680: 7477 7261 702e 6465 6465 6e74 280a 2020  twrap.dedent(.  
+000289d0: 2064 6570 656e 6465 6e63 6965 733d 6465   dependencies=de
+000289e0: 7065 6e64 656e 6369 6573 2c0a 2020 2020  pendencies,.    
+000289f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028a00: 616e 6e6f 7461 7469 6f6e 733d 6469 6374  annotations=dict
+00028a10: 2861 6e6e 6f74 6174 696f 6e73 5f66 6f72  (annotations_for
+00028a20: 5f70 6c75 6769 6e29 2c0a 2020 2020 2020  _plugin),.      
+00028a30: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+00028a40: 696f 7269 7479 3d70 7269 6f72 6974 792c  iority=priority,
+00028a50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028a60: 2029 0a20 2020 2020 2020 2020 2020 2065   ).            e
+00028a70: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
+00028a80: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
+00028a90: 2020 2020 2020 6c6f 6767 6572 2e65 7863        logger.exc
+00028aa0: 6570 7469 6f6e 2865 290a 0a20 2020 2020  eption(e)..     
+00028ab0: 2020 2073 656c 662e 7472 616e 7369 7469     self.transiti
+00028ac0: 6f6e 7328 7265 636f 6d6d 656e 6461 7469  ons(recommendati
+00028ad0: 6f6e 732c 2073 7469 6d75 6c75 735f 6964  ons, stimulus_id
+00028ae0: 290a 0a20 2020 2020 2020 2066 6f72 2074  )..        for t
+00028af0: 7320 696e 2074 6f75 6368 6564 5f74 6173  s in touched_tas
+00028b00: 6b73 3a0a 2020 2020 2020 2020 2020 2020  ks:.            
+00028b10: 6966 2074 732e 7374 6174 6520 696e 2028  if ts.state in (
+00028b20: 226d 656d 6f72 7922 2c20 2265 7272 6564  "memory", "erred
+00028b30: 2229 3a0a 2020 2020 2020 2020 2020 2020  "):.            
+00028b40: 2020 2020 7365 6c66 2e72 6570 6f72 745f      self.report_
+00028b50: 6f6e 5f6b 6579 2874 733d 7473 2c20 636c  on_key(ts=ts, cl
+00028b60: 6965 6e74 3d63 6c69 656e 7429 0a0a 2020  ient=client)..  
+00028b70: 2020 406c 6f67 5f65 7272 6f72 730a 2020    @log_errors.  
+00028b80: 2020 6173 796e 6320 6465 6620 7570 6461    async def upda
+00028b90: 7465 5f67 7261 7068 280a 2020 2020 2020  te_graph(.      
+00028ba0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+00028bb0: 636c 6965 6e74 3a20 7374 722c 0a20 2020  client: str,.   
+00028bc0: 2020 2020 2067 7261 7068 5f68 6561 6465       graph_heade
+00028bd0: 723a 2064 6963 742c 0a20 2020 2020 2020  r: dict,.       
+00028be0: 2067 7261 7068 5f66 7261 6d65 733a 206c   graph_frames: l
+00028bf0: 6973 745b 6279 7465 735d 2c0a 2020 2020  ist[bytes],.    
+00028c00: 2020 2020 6b65 7973 3a20 7365 745b 4b65      keys: set[Ke
+00028c10: 795d 2c0a 2020 2020 2020 2020 7370 616e  y],.        span
+00028c20: 5f6d 6574 6164 6174 613a 2053 7061 6e4d  _metadata: SpanM
+00028c30: 6574 6164 6174 612c 0a20 2020 2020 2020  etadata,.       
+00028c40: 2069 6e74 6572 6e61 6c5f 7072 696f 7269   internal_priori
+00028c50: 7479 3a20 6469 6374 5b4b 6579 2c20 696e  ty: dict[Key, in
+00028c60: 745d 207c 204e 6f6e 652c 0a20 2020 2020  t] | None,.     
+00028c70: 2020 2073 7562 6d69 7474 696e 675f 7461     submitting_ta
+00028c80: 736b 3a20 4b65 7920 7c20 4e6f 6e65 2c0a  sk: Key | None,.
+00028c90: 2020 2020 2020 2020 7573 6572 5f70 7269          user_pri
+00028ca0: 6f72 6974 793a 2069 6e74 207c 2064 6963  ority: int | dic
+00028cb0: 745b 4b65 792c 2069 6e74 5d20 3d20 302c  t[Key, int] = 0,
+00028cc0: 0a20 2020 2020 2020 2061 6374 6f72 733a  .        actors:
+00028cd0: 2062 6f6f 6c20 7c20 6c69 7374 5b4b 6579   bool | list[Key
+00028ce0: 5d20 7c20 4e6f 6e65 203d 204e 6f6e 652c  ] | None = None,
+00028cf0: 0a20 2020 2020 2020 2066 6966 6f5f 7469  .        fifo_ti
+00028d00: 6d65 6f75 743a 2066 6c6f 6174 203d 2030  meout: float = 0
+00028d10: 2e30 2c0a 2020 2020 2020 2020 636f 6465  .0,.        code
+00028d20: 3a20 7475 706c 655b 536f 7572 6365 436f  : tuple[SourceCo
+00028d30: 6465 2c20 2e2e 2e5d 203d 2028 292c 0a20  de, ...] = (),. 
+00028d40: 2020 2020 2020 2061 6e6e 6f74 6174 696f         annotatio
+00028d50: 6e73 3a20 6469 6374 207c 204e 6f6e 6520  ns: dict | None 
+00028d60: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00028d70: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
+00028d80: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
+00028d90: 2020 2020 2920 2d3e 204e 6f6e 653a 0a20      ) -> None:. 
+00028da0: 2020 2020 2020 2073 7461 7274 203d 2074         start = t
+00028db0: 696d 6528 290a 2020 2020 2020 2020 7472  ime().        tr
+00028dc0: 793a 0a20 2020 2020 2020 2020 2020 2074  y:.            t
+00028dd0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00028de0: 2020 2020 6772 6170 6820 3d20 6465 7365      graph = dese
+00028df0: 7269 616c 697a 6528 6772 6170 685f 6865  rialize(graph_he
+00028e00: 6164 6572 2c20 6772 6170 685f 6672 616d  ader, graph_fram
+00028e10: 6573 292e 6461 7461 0a20 2020 2020 2020  es).data.       
+00028e20: 2020 2020 2020 2020 2064 656c 2067 7261           del gra
+00028e30: 7068 5f68 6561 6465 722c 2067 7261 7068  ph_header, graph
+00028e40: 5f66 7261 6d65 730a 2020 2020 2020 2020  _frames.        
+00028e50: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+00028e60: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
+00028e70: 2020 2020 2020 2020 2020 206d 7367 203d             msg =
+00028e80: 2022 2222 5c0a 2020 2020 2020 2020 2020   """\.          
+00028e90: 2020 2020 2020 2020 2020 4572 726f 7220            Error 
+00028ea0: 6475 7269 6e67 2064 6573 6572 6961 6c69  during deseriali
+00028eb0: 7a61 7469 6f6e 206f 6620 7468 6520 7461  zation of the ta
+00028ec0: 736b 2067 7261 7068 2e20 5468 6973 2066  sk graph. This f
+00028ed0: 7265 7175 656e 746c 790a 2020 2020 2020  requently.      
+00028ee0: 2020 2020 2020 2020 2020 2020 2020 6f63                oc
+00028ef0: 6375 7273 2069 6620 7468 6520 5363 6865  curs if the Sche
+00028f00: 6475 6c65 7220 616e 6420 436c 6965 6e74  duler and Client
+00028f10: 2068 6176 6520 6469 6666 6572 656e 7420   have different 
+00028f20: 656e 7669 726f 6e6d 656e 7473 2e0a 2020  environments..  
+00028f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028f40: 2020 466f 7220 6d6f 7265 2069 6e66 6f72    For more infor
+00028f50: 6d61 7469 6f6e 2c20 7365 650a 2020 2020  mation, see.    
+00028f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028f70: 6874 7470 733a 2f2f 646f 6373 2e64 6173  https://docs.das
+00028f80: 6b2e 6f72 672f 656e 2f73 7461 626c 652f  k.org/en/stable/
+00028f90: 6465 706c 6f79 6d65 6e74 2d63 6f6e 7369  deployment-consi
+00028fa0: 6465 7261 7469 6f6e 732e 6874 6d6c 2363  derations.html#c
+00028fb0: 6f6e 7369 7374 656e 742d 736f 6674 7761  onsistent-softwa
+00028fc0: 7265 2d65 6e76 6972 6f6e 6d65 6e74 730a  re-environments.
+00028fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028fe0: 2222 220a 2020 2020 2020 2020 2020 2020  """.            
+00028ff0: 2020 2020 7261 6973 6520 5275 6e74 696d      raise Runtim
+00029000: 6545 7272 6f72 2874 6578 7477 7261 702e  eError(textwrap.
+00029010: 6465 6465 6e74 286d 7367 2929 2066 726f  dedent(msg)) fro
+00029020: 6d20 650a 2020 2020 2020 2020 2020 2020  m e.            
+00029030: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00029040: 2020 6473 6b2c 0a20 2020 2020 2020 2020    dsk,.         
+00029050: 2020 2020 2020 2064 6570 656e 6465 6e63         dependenc
+00029060: 6965 732c 0a20 2020 2020 2020 2020 2020  ies,.           
+00029070: 2020 2020 2061 6e6e 6f74 6174 696f 6e73       annotations
+00029080: 5f62 795f 7479 7065 2c0a 2020 2020 2020  _by_type,.      
+00029090: 2020 2020 2020 2920 3d20 6177 6169 7420        ) = await 
+000290a0: 6f66 666c 6f61 6428 0a20 2020 2020 2020  offload(.       
+000290b0: 2020 2020 2020 2020 205f 6d61 7465 7269           _materi
+000290c0: 616c 697a 655f 6772 6170 682c 0a20 2020  alize_graph,.   
+000290d0: 2020 2020 2020 2020 2020 2020 2067 7261               gra
+000290e0: 7068 3d67 7261 7068 2c0a 2020 2020 2020  ph=graph,.      
+000290f0: 2020 2020 2020 2020 2020 676c 6f62 616c            global
+00029100: 5f61 6e6e 6f74 6174 696f 6e73 3d61 6e6e  _annotations=ann
+00029110: 6f74 6174 696f 6e73 206f 7220 7b7d 2c0a  otations or {},.
+00029120: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00029130: 2020 2020 2020 2020 2020 6465 6c20 6772            del gr
+00029140: 6170 680a 2020 2020 2020 2020 2020 2020  aph.            
+00029150: 6966 206e 6f74 2069 6e74 6572 6e61 6c5f  if not internal_
+00029160: 7072 696f 7269 7479 3a0a 2020 2020 2020  priority:.      
+00029170: 2020 2020 2020 2020 2020 2320 5265 6d6f            # Remo
+00029180: 7669 6e67 2061 6c6c 206e 6f6e 2d6c 6f63  ving all non-loc
+00029190: 616c 206b 6579 7320 6265 666f 7265 2063  al keys before c
+000291a0: 616c 6c69 6e67 206f 7264 6572 2829 0a20  alling order(). 
+000291b0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+000291c0: 736b 5f6b 6579 7320 3d20 7365 7428 0a20  sk_keys = set(. 
+000291d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000291e0: 2020 2064 736b 0a20 2020 2020 2020 2020     dsk.         
+000291f0: 2020 2020 2020 2029 2020 2320 696e 7465         )  # inte
+00029200: 7273 6563 7469 6f6e 2829 206f 6620 7365  rsection() of se
+00029210: 7473 2069 7320 6d75 6368 2066 6173 7465  ts is much faste
+00029220: 7220 7468 616e 2064 6963 745f 6b65 7973  r than dict_keys
+00029230: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029240: 2073 7472 6970 7065 645f 6465 7073 203d   stripped_deps =
+00029250: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00029260: 2020 2020 2020 206b 3a20 762e 696e 7465         k: v.inte
+00029270: 7273 6563 7469 6f6e 2864 736b 5f6b 6579  rsection(dsk_key
+00029280: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
+00029290: 2020 2020 2020 2066 6f72 206b 2c20 7620         for k, v 
+000292a0: 696e 2064 6570 656e 6465 6e63 6965 732e  in dependencies.
+000292b0: 6974 656d 7328 290a 2020 2020 2020 2020  items().        
+000292c0: 2020 2020 2020 2020 2020 2020 6966 206b              if k
+000292d0: 2069 6e20 6473 6b5f 6b65 7973 0a20 2020   in dsk_keys.   
+000292e0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+000292f0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00029300: 6e74 6572 6e61 6c5f 7072 696f 7269 7479  nternal_priority
+00029310: 203d 2061 7761 6974 206f 6666 6c6f 6164   = await offload
+00029320: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00029330: 2020 2020 2020 6461 736b 2e6f 7264 6572        dask.order
+00029340: 2e6f 7264 6572 2c20 6473 6b3d 6473 6b2c  .order, dsk=dsk,
+00029350: 2064 6570 656e 6465 6e63 6965 733d 7374   dependencies=st
+00029360: 7269 7070 6564 5f64 6570 730a 2020 2020  ripped_deps.    
+00029370: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+00029380: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00029390: 5f63 7265 6174 655f 7461 736b 7374 6174  _create_taskstat
+000293a0: 655f 6672 6f6d 5f67 7261 7068 280a 2020  e_from_graph(.  
+000293b0: 2020 2020 2020 2020 2020 2020 2020 6473                ds
+000293c0: 6b3d 6473 6b2c 0a20 2020 2020 2020 2020  k=dsk,.         
+000293d0: 2020 2020 2020 2063 6c69 656e 743d 636c         client=cl
+000293e0: 6965 6e74 2c0a 2020 2020 2020 2020 2020  ient,.          
+000293f0: 2020 2020 2020 6465 7065 6e64 656e 6369        dependenci
+00029400: 6573 3d64 6570 656e 6465 6e63 6965 732c  es=dependencies,
+00029410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029420: 206b 6579 733d 7365 7428 6b65 7973 292c   keys=set(keys),
+00029430: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029440: 206f 7264 6572 6564 3d69 6e74 6572 6e61   ordered=interna
+00029450: 6c5f 7072 696f 7269 7479 206f 7220 7b7d  l_priority or {}
+00029460: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00029470: 2020 7375 626d 6974 7469 6e67 5f74 6173    submitting_tas
+00029480: 6b3d 7375 626d 6974 7469 6e67 5f74 6173  k=submitting_tas
+00029490: 6b2c 0a20 2020 2020 2020 2020 2020 2020  k,.             
+000294a0: 2020 2075 7365 725f 7072 696f 7269 7479     user_priority
+000294b0: 3d75 7365 725f 7072 696f 7269 7479 2c0a  =user_priority,.
+000294c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000294d0: 6163 746f 7273 3d61 6374 6f72 732c 0a20  actors=actors,. 
+000294e0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000294f0: 6966 6f5f 7469 6d65 6f75 743d 6669 666f  ifo_timeout=fifo
+00029500: 5f74 696d 656f 7574 2c0a 2020 2020 2020  _timeout,.      
+00029510: 2020 2020 2020 2020 2020 636f 6465 3d63            code=c
+00029520: 6f64 652c 0a20 2020 2020 2020 2020 2020  ode,.           
+00029530: 2020 2020 2073 7061 6e5f 6d65 7461 6461       span_metada
+00029540: 7461 3d73 7061 6e5f 6d65 7461 6461 7461  ta=span_metadata
+00029550: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00029560: 2020 616e 6e6f 7461 7469 6f6e 735f 6279    annotations_by
+00029570: 5f74 7970 653d 616e 6e6f 7461 7469 6f6e  _type=annotation
+00029580: 735f 6279 5f74 7970 652c 0a20 2020 2020  s_by_type,.     
+00029590: 2020 2020 2020 2020 2020 2023 2046 4958             # FIX
+000295a0: 4d45 3a20 5468 6973 2069 7320 6a75 7374  ME: This is just
+000295b0: 2075 7365 6420 746f 2061 7474 6163 6820   used to attach 
+000295c0: 746f 2043 6f6d 7075 7461 7469 6f6e 0a20  to Computation. 
+000295d0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+000295e0: 206f 626a 6563 7473 2e20 5468 6973 2073   objects. This s
+000295f0: 686f 756c 6420 6265 2072 656d 6f76 6564  hould be removed
+00029600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029610: 2067 6c6f 6261 6c5f 616e 6e6f 7461 7469   global_annotati
+00029620: 6f6e 733d 616e 6e6f 7461 7469 6f6e 732c  ons=annotations,
+00029630: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029640: 2073 7461 7274 3d73 7461 7274 2c0a 2020   start=start,.  
+00029650: 2020 2020 2020 2020 2020 2020 2020 7374                st
+00029660: 696d 756c 7573 5f69 643d 7374 696d 756c  imulus_id=stimul
+00029670: 7573 5f69 6420 6f72 2066 2275 7064 6174  us_id or f"updat
+00029680: 652d 6772 6170 682d 7b73 7461 7274 7d22  e-graph-{start}"
+00029690: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+000296a0: 2020 2020 2020 2020 6578 6365 7074 2052          except R
+000296b0: 756e 7469 6d65 4572 726f 7220 6173 2065  untimeError as e
+000296c0: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
+000296d0: 6767 6572 2e65 7272 6f72 2873 7472 2865  gger.error(str(e
+000296e0: 2929 0a20 2020 2020 2020 2020 2020 2065  )).            e
+000296f0: 7272 203d 2065 7272 6f72 5f6d 6573 7361  rr = error_messa
+00029700: 6765 2865 290a 2020 2020 2020 2020 2020  ge(e).          
+00029710: 2020 666f 7220 6b65 7920 696e 206b 6579    for key in key
+00029720: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00029730: 2020 2073 656c 662e 7265 706f 7274 280a     self.report(.
+00029740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029750: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00029760: 2020 2020 2020 2020 2020 2020 2020 226f                "o
+00029770: 7022 3a20 2274 6173 6b2d 6572 7265 6422  p": "task-erred"
+00029780: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00029790: 2020 2020 2020 2020 2020 226b 6579 223a            "key":
+000297a0: 206b 6579 2c0a 2020 2020 2020 2020 2020   key,.          
+000297b0: 2020 2020 2020 2020 2020 2020 2020 2265                "e
+000297c0: 7863 6570 7469 6f6e 223a 2065 7272 5b22  xception": err["
+000297d0: 6578 6365 7074 696f 6e22 5d2c 0a20 2020  exception"],.   
+000297e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000297f0: 2020 2020 2022 7472 6163 6562 6163 6b22       "traceback"
+00029800: 3a20 6572 725b 2274 7261 6365 6261 636b  : err["traceback
+00029810: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
+00029820: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
+00029830: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00029840: 2054 6869 7320 696e 666f 726d 7320 616c   This informs al
+00029850: 6c20 636c 6965 6e74 7320 696e 2077 686f  l clients in who
+00029860: 5f77 616e 7473 2070 6c75 7320 7468 6520  _wants plus the 
+00029870: 6375 7272 656e 7420 636c 6965 6e74 0a20  current client. 
+00029880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029890: 2020 2023 2028 7768 6963 6820 6d61 7920     # (which may 
+000298a0: 6e6f 7420 6861 7665 2062 6565 6e20 6164  not have been ad
+000298b0: 6465 6420 746f 2077 686f 5f77 616e 7473  ded to who_wants
+000298c0: 2079 6574 290a 2020 2020 2020 2020 2020   yet).          
+000298d0: 2020 2020 2020 2020 2020 636c 6965 6e74            client
+000298e0: 3d63 6c69 656e 742c 0a20 2020 2020 2020  =client,.       
+000298f0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00029900: 2020 2065 6e64 203d 2074 696d 6528 290a     end = time().
+00029910: 2020 2020 2020 2020 7365 6c66 2e64 6967          self.dig
+00029920: 6573 745f 6d65 7472 6963 2822 7570 6461  est_metric("upda
+00029930: 7465 2d67 7261 7068 2d64 7572 6174 696f  te-graph-duratio
+00029940: 6e22 2c20 656e 6420 2d20 7374 6172 7429  n", end - start)
+00029950: 0a0a 2020 2020 6465 6620 5f67 656e 6572  ..    def _gener
+00029960: 6174 655f 7461 736b 7374 6174 6573 280a  ate_taskstates(.
+00029970: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+00029980: 2020 2020 2020 6b65 7973 3a20 7365 745b        keys: set[
+00029990: 4b65 795d 2c0a 2020 2020 2020 2020 6473  Key],.        ds
+000299a0: 6b3a 2064 6963 745b 4b65 792c 2054 5f72  k: dict[Key, T_r
+000299b0: 756e 7370 6563 5d2c 0a20 2020 2020 2020  unspec],.       
+000299c0: 2064 6570 656e 6465 6e63 6965 733a 2064   dependencies: d
+000299d0: 6963 745b 4b65 792c 2073 6574 5b4b 6579  ict[Key, set[Key
+000299e0: 5d5d 2c0a 2020 2020 2020 2020 636f 6d70  ]],.        comp
+000299f0: 7574 6174 696f 6e3a 2043 6f6d 7075 7461  utation: Computa
+00029a00: 7469 6f6e 2c0a 2020 2020 2920 2d3e 2074  tion,.    ) -> t
+00029a10: 7570 6c65 3a0a 2020 2020 2020 2020 2320  uple:.        # 
+00029a20: 4765 7420 6f72 2063 7265 6174 6520 7461  Get or create ta
+00029a30: 736b 2073 7461 7465 730a 2020 2020 2020  sk states.      
+00029a40: 2020 7275 6e6e 6162 6c65 203d 205b 5d0a    runnable = [].
+00029a50: 2020 2020 2020 2020 6e65 775f 7461 736b          new_task
+00029a60: 7320 3d20 5b5d 0a20 2020 2020 2020 2073  s = [].        s
+00029a70: 7461 636b 203d 206c 6973 7428 6b65 7973  tack = list(keys
+00029a80: 290a 2020 2020 2020 2020 746f 7563 6865  ).        touche
+00029a90: 645f 6b65 7973 203d 2073 6574 2829 0a20  d_keys = set(). 
+00029aa0: 2020 2020 2020 2074 6f75 6368 6564 5f74         touched_t
+00029ab0: 6173 6b73 203d 205b 5d0a 2020 2020 2020  asks = [].      
+00029ac0: 2020 7467 735f 7769 7468 5f62 6164 5f72    tgs_with_bad_r
+00029ad0: 756e 5f73 7065 6320 3d20 7365 7428 290a  un_spec = set().
+00029ae0: 2020 2020 2020 2020 7768 696c 6520 7374          while st
+00029af0: 6163 6b3a 0a20 2020 2020 2020 2020 2020  ack:.           
+00029b00: 206b 203d 2073 7461 636b 2e70 6f70 2829   k = stack.pop()
+00029b10: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00029b20: 6b20 696e 2074 6f75 6368 6564 5f6b 6579  k in touched_key
+00029b30: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00029b40: 2020 2063 6f6e 7469 6e75 650a 2020 2020     continue.    
+00029b50: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
+00029b60: 662e 7461 736b 732e 6765 7428 6b29 0a20  f.tasks.get(k). 
+00029b70: 2020 2020 2020 2020 2020 2069 6620 7473             if ts
+00029b80: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00029b90: 2020 2020 2020 2020 2020 7473 203d 2073            ts = s
+00029ba0: 656c 662e 6e65 775f 7461 736b 286b 2c20  elf.new_task(k, 
+00029bb0: 6473 6b2e 6765 7428 6b29 2c20 2272 656c  dsk.get(k), "rel
+00029bc0: 6561 7365 6422 2c20 636f 6d70 7574 6174  eased", computat
+00029bd0: 696f 6e3d 636f 6d70 7574 6174 696f 6e29  ion=computation)
+00029be0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029bf0: 206e 6577 5f74 6173 6b73 2e61 7070 656e   new_tasks.appen
+00029c00: 6428 7473 290a 2020 2020 2020 2020 2020  d(ts).          
+00029c10: 2020 2320 4974 2069 7320 706f 7373 6962    # It is possib
+00029c20: 6c65 2074 6f20 6372 6561 7465 2074 6865  le to create the
+00029c30: 2054 6173 6b53 7461 7465 206f 626a 6563   TaskState objec
+00029c40: 7420 6265 666f 7265 2069 7473 2072 756e  t before its run
+00029c50: 7370 6563 2069 7320 6b6e 6f77 6e0a 2020  spec is known.  
+00029c60: 2020 2020 2020 2020 2020 2320 746f 2074            # to t
+00029c70: 6865 2073 6368 6564 756c 6572 2e20 466f  he scheduler. Fo
+00029c80: 7220 696e 7374 616e 6365 2c20 7468 6973  r instance, this
+00029c90: 2069 7320 706f 7373 6962 6c65 2077 6865   is possible whe
+00029ca0: 6e20 7573 696e 6720 6120 5661 7269 6162  n using a Variab
+00029cb0: 6c65 3a0a 2020 2020 2020 2020 2020 2020  le:.            
+00029cc0: 2320 6066 203d 2063 2e73 7562 6d69 7428  # `f = c.submit(
+00029cd0: 666f 6f29 3b20 6177 6169 7420 5661 7269  foo); await Vari
+00029ce0: 6162 6c65 2829 2e73 6574 2866 2960 2073  able().set(f)` s
+00029cf0: 696e 6365 2074 6865 2056 6172 6961 626c  ince the Variabl
+00029d00: 6520 7573 6573 2061 0a20 2020 2020 2020  e uses a.       
+00029d10: 2020 2020 2023 2064 6966 6665 7265 6e74       # different
+00029d20: 2063 6f6d 6d20 6368 616e 6e65 6c2c 2073   comm channel, s
+00029d30: 6f20 7468 6520 6063 6c69 656e 745f 6465  o the `client_de
+00029d40: 7369 7265 735f 6b65 7960 206d 6573 7361  sires_key` messa
+00029d50: 6765 2063 6f75 6c64 2061 7272 6976 650a  ge could arrive.
+00029d60: 2020 2020 2020 2020 2020 2020 2320 6265              # be
+00029d70: 666f 7265 2060 7570 6461 7465 5f67 7261  fore `update_gra
+00029d80: 7068 602e 0a20 2020 2020 2020 2020 2020  ph`..           
+00029d90: 2023 2054 6865 7265 2061 7265 2061 6c73   # There are als
+00029da0: 6f20 616e 7469 2d70 6174 7465 726e 2070  o anti-pattern p
+00029db0: 726f 6365 7373 6573 2070 6f73 7369 626c  rocesses possibl
+00029dc0: 653b 0a20 2020 2020 2020 2020 2020 2023  e;.            #
+00029dd0: 2073 6565 2066 6f72 2065 7861 6d70 6c65   see for example
+00029de0: 2074 6573 745f 7363 6174 7465 725f 6372   test_scatter_cr
+00029df0: 6561 7465 735f 7473 0a20 2020 2020 2020  eates_ts.       
+00029e00: 2020 2020 2065 6c69 6620 7473 2e72 756e       elif ts.run
+00029e10: 5f73 7065 6320 6973 204e 6f6e 653a 0a20  _spec is None:. 
+00029e20: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00029e30: 732e 7275 6e5f 7370 6563 203d 2064 736b  s.run_spec = dsk
+00029e40: 2e67 6574 286b 290a 2020 2020 2020 2020  .get(k).        
+00029e50: 2020 2020 2320 7275 6e5f 7370 6563 2069      # run_spec i
+00029e60: 6e20 7468 6520 7375 626d 6974 7465 6420  n the submitted 
+00029e70: 6772 6170 6820 6d61 7920 6265 204e 6f6e  graph may be Non
+00029e80: 652e 2054 6869 7320 6861 7070 656e 730a  e. This happens.
+00029e90: 2020 2020 2020 2020 2020 2020 2320 7768              # wh
+00029ea0: 656e 2061 6e20 616c 7265 6164 7920 7065  en an already pe
+00029eb0: 7273 6973 7465 6420 6675 7475 7265 2069  rsisted future i
+00029ec0: 7320 7061 7274 206f 6620 7468 6520 6772  s part of the gr
+00029ed0: 6170 680a 2020 2020 2020 2020 2020 2020  aph.            
+00029ee0: 656c 6966 206b 2069 6e20 6473 6b3a 0a20  elif k in dsk:. 
+00029ef0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00029f00: 2049 6620 626f 7468 2074 6f6b 656e 7320   If both tokens 
+00029f10: 6172 6520 6e6f 6e2d 6465 7465 726d 696e  are non-determin
+00029f20: 6973 7469 632c 2073 6b69 7020 636f 6d70  istic, skip comp
+00029f30: 6172 6973 6f6e 0a20 2020 2020 2020 2020  arison.         
+00029f40: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+00029f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029f60: 746f 6b5f 6c68 7320 3d20 746f 6b65 6e69  tok_lhs = tokeni
+00029f70: 7a65 2874 732e 7275 6e5f 7370 6563 2c20  ze(ts.run_spec, 
+00029f80: 656e 7375 7265 5f64 6574 6572 6d69 6e69  ensure_determini
+00029f90: 7374 6963 3d54 7275 6529 0a20 2020 2020  stic=True).     
+00029fa0: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+00029fb0: 7420 546f 6b65 6e69 7a61 7469 6f6e 4572  t TokenizationEr
+00029fc0: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
+00029fd0: 2020 2020 2020 2020 2074 6f6b 5f6c 6873           tok_lhs
+00029fe0: 203d 2022 220a 2020 2020 2020 2020 2020   = "".          
+00029ff0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+0002a000: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0002a010: 6f6b 5f72 6873 203d 2074 6f6b 656e 697a  ok_rhs = tokeniz
+0002a020: 6528 6473 6b5b 6b5d 2c20 656e 7375 7265  e(dsk[k], ensure
+0002a030: 5f64 6574 6572 6d69 6e69 7374 6963 3d54  _deterministic=T
+0002a040: 7275 6529 0a20 2020 2020 2020 2020 2020  rue).           
+0002a050: 2020 2020 2065 7863 6570 7420 546f 6b65       except Toke
+0002a060: 6e69 7a61 7469 6f6e 4572 726f 723a 0a20  nizationError:. 
+0002a070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a080: 2020 2074 6f6b 5f72 6873 203d 2022 220a     tok_rhs = "".
+0002a090: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a0a0: 2023 2041 6464 6974 696f 6e61 6c6c 7920   # Additionally 
+0002a0b0: 6368 6563 6b20 6465 7065 6e64 656e 6379  check dependency
+0002a0c0: 206e 616d 6573 2e20 5468 6973 2073 686f   names. This sho
+0002a0d0: 756c 6420 6f6e 6c79 2062 6520 6e65 6365  uld only be nece
+0002a0e0: 7373 6172 790a 2020 2020 2020 2020 2020  ssary.          
+0002a0f0: 2020 2020 2020 2320 6966 2072 756e 5f73        # if run_s
+0002a100: 7065 6373 2063 616e 2774 2062 6520 746f  pecs can't be to
+0002a110: 6b65 6e69 7a65 6420 6465 7465 726d 696e  kenized determin
+0002a120: 6973 7469 6361 6c6c 792e 0a20 2020 2020  istically..     
+0002a130: 2020 2020 2020 2020 2020 2064 6570 735f             deps_
+0002a140: 6c68 7320 3d20 7b64 7473 2e6b 6579 2066  lhs = {dts.key f
+0002a150: 6f72 2064 7473 2069 6e20 7473 2e64 6570  or dts in ts.dep
+0002a160: 656e 6465 6e63 6965 737d 0a20 2020 2020  endencies}.     
+0002a170: 2020 2020 2020 2020 2020 2064 6570 735f             deps_
+0002a180: 7268 7320 3d20 6465 7065 6e64 656e 6369  rhs = dependenci
+0002a190: 6573 5b6b 5d0a 0a20 2020 2020 2020 2020  es[k]..         
+0002a1a0: 2020 2020 2020 2023 2046 4958 4d45 2049         # FIXME I
+0002a1b0: 7420 776f 756c 6420 6265 2061 2072 6561  t would be a rea
+0002a1c0: 6c6c 7920 6865 616c 7468 7920 6964 6561  lly healthy idea
+0002a1d0: 2074 6f20 6368 616e 6765 2074 6869 7320   to change this 
+0002a1e0: 746f 2061 2068 6172 640a 2020 2020 2020  to a hard.      
+0002a1f0: 2020 2020 2020 2020 2020 2320 6661 696c            # fail
+0002a200: 7572 652e 2048 6f77 6576 6572 2c20 7468  ure. However, th
+0002a210: 6973 2069 7320 6e6f 7420 706f 7373 6962  is is not possib
+0002a220: 6c65 2061 7420 7468 6520 6d6f 6d65 6e74  le at the moment
+0002a230: 2062 6563 6175 7365 206f 660a 2020 2020   because of.    
+0002a240: 2020 2020 2020 2020 2020 2020 2320 6874              # ht
+0002a250: 7470 733a 2f2f 6769 7468 7562 2e63 6f6d  tps://github.com
+0002a260: 2f64 6173 6b2f 6461 736b 2f69 7373 7565  /dask/dask/issue
+0002a270: 732f 3938 3838 0a20 2020 2020 2020 2020  s/9888.         
+0002a280: 2020 2020 2020 2069 6620 746f 6b5f 6c68         if tok_lh
+0002a290: 7320 213d 2074 6f6b 5f72 6873 206f 7220  s != tok_rhs or 
+0002a2a0: 6465 7073 5f6c 6873 2021 3d20 6465 7073  deps_lhs != deps
+0002a2b0: 5f72 6873 3a0a 2020 2020 2020 2020 2020  _rhs:.          
+0002a2c0: 2020 2020 2020 2020 2020 2320 5265 7461            # Reta
+0002a2d0: 696e 206f 6c64 2072 756e 5f73 7065 6320  in old run_spec 
+0002a2e0: 616e 6420 6465 7065 6e64 656e 6369 6573  and dependencies
+0002a2f0: 3b20 7265 7275 6e20 7468 656d 2069 6620  ; rerun them if 
+0002a300: 6e65 6365 7373 6172 792e 0a20 2020 2020  necessary..     
+0002a310: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0002a320: 2054 6869 7320 7377 6565 7073 2074 6865   This sweeps the
+0002a330: 2069 7373 7565 206f 6620 636f 6c6c 6973   issue of collis
+0002a340: 696f 6e20 756e 6465 7220 7468 6520 6361  ion under the ca
+0002a350: 7270 6574 2061 7320 6c6f 6e67 2061 7320  rpet as long as 
+0002a360: 7468 650a 2020 2020 2020 2020 2020 2020  the.            
+0002a370: 2020 2020 2020 2020 2320 6f6c 6420 616e          # old an
+0002a380: 6420 6e65 7720 7461 736b 2070 726f 6475  d new task produ
+0002a390: 6365 2074 6865 2073 616d 6520 6f75 7470  ce the same outp
+0002a3a0: 7574 202d 2073 7563 6820 6173 2069 6e0a  ut - such as in.
+0002a3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a3c0: 2020 2020 2320 6461 736b 2f64 6173 6b23      # dask/dask#
+0002a3d0: 3938 3838 2e0a 2020 2020 2020 2020 2020  9888..          
+0002a3e0: 2020 2020 2020 2020 2020 6465 7065 6e64            depend
+0002a3f0: 656e 6369 6573 5b6b 5d20 3d20 6465 7073  encies[k] = deps
+0002a400: 5f6c 6873 0a0a 2020 2020 2020 2020 2020  _lhs..          
+0002a410: 2020 2020 2020 2020 2020 6966 2074 732e            if ts.
+0002a420: 6772 6f75 7020 6e6f 7420 696e 2074 6773  group not in tgs
+0002a430: 5f77 6974 685f 6261 645f 7275 6e5f 7370  _with_bad_run_sp
+0002a440: 6563 3a0a 2020 2020 2020 2020 2020 2020  ec:.            
+0002a450: 2020 2020 2020 2020 2020 2020 7467 735f              tgs_
+0002a460: 7769 7468 5f62 6164 5f72 756e 5f73 7065  with_bad_run_spe
+0002a470: 632e 6164 6428 7473 2e67 726f 7570 290a  c.add(ts.group).
+0002a480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a490: 2020 2020 2020 2020 6c6f 6767 6572 2e77          logger.w
+0002a4a0: 6172 6e69 6e67 280a 2020 2020 2020 2020  arning(.        
+0002a4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a4c0: 2020 2020 6622 4465 7465 6374 6564 2064      f"Detected d
+0002a4d0: 6966 6665 7265 6e74 2060 7275 6e5f 7370  ifferent `run_sp
+0002a4e0: 6563 6020 666f 7220 6b65 7920 7b74 732e  ec` for key {ts.
+0002a4f0: 6b65 7921 727d 2062 6574 7765 656e 2022  key!r} between "
+0002a500: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a510: 2020 2020 2020 2020 2020 2020 2022 7477               "tw
+0002a520: 6f20 636f 6e73 6563 7574 6976 6520 6361  o consecutive ca
+0002a530: 6c6c 7320 746f 2060 7570 6461 7465 5f67  lls to `update_g
+0002a540: 7261 7068 602e 2022 0a20 2020 2020 2020  raph`. ".       
+0002a550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a560: 2020 2020 2022 5468 6973 2063 616e 2063       "This can c
+0002a570: 6175 7365 2066 6169 6c75 7265 7320 616e  ause failures an
+0002a580: 6420 6465 6164 6c6f 636b 7320 646f 776e  d deadlocks down
+0002a590: 2074 6865 206c 696e 652e 2022 0a20 2020   the line. ".   
+0002a5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a5b0: 2020 2020 2020 2020 2022 506c 6561 7365           "Please
+0002a5c0: 2065 6e73 7572 6520 756e 6971 7565 206b   ensure unique k
+0002a5d0: 6579 206e 616d 6573 2e20 220a 2020 2020  ey names. ".    
+0002a5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a5f0: 2020 2020 2020 2020 2249 6620 796f 7520          "If you 
+0002a600: 6172 6520 7573 696e 6720 6120 7374 616e  are using a stan
+0002a610: 6461 7264 2064 6173 6b20 636f 6c6c 6563  dard dask collec
+0002a620: 7469 6f6e 732c 2063 6f6e 7369 6465 7220  tions, consider 
+0002a630: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0002a640: 2020 2020 2020 2020 2020 2020 2020 2272                "r
+0002a650: 656c 6561 7369 6e67 2061 6c6c 2074 6865  eleasing all the
+0002a660: 2064 6174 6120 6265 666f 7265 2072 6573   data before res
+0002a670: 7562 6d69 7474 696e 6720 616e 6f74 6865  ubmitting anothe
+0002a680: 7220 220a 2020 2020 2020 2020 2020 2020  r ".            
 0002a690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a6a0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-0002a6b0: 2222 0a20 2020 2020 2020 2020 2020 2020  "".             
-0002a6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a6d0: 2020 2044 6562 7567 6769 6e67 2069 6e66     Debugging inf
-0002a6e0: 6f72 6d61 7469 6f6e 0a20 2020 2020 2020  ormation.       
-0002a6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a700: 2020 2020 2020 2020 202d 2d2d 2d2d 2d2d           -------
-0002a710: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20  --------------. 
+0002a6a0: 2263 6f6d 7075 7461 7469 6f6e 2e20 4d6f  "computation. Mo
+0002a6b0: 7265 2064 6574 6169 6c73 2061 6e64 2068  re details and h
+0002a6c0: 656c 7020 6361 6e20 6265 2066 6f75 6e64  elp can be found
+0002a6d0: 2061 7420 220a 2020 2020 2020 2020 2020   at ".          
+0002a6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a6f0: 2020 2268 7474 7073 3a2f 2f67 6974 6875    "https://githu
+0002a700: 622e 636f 6d2f 6461 736b 2f64 6173 6b2f  b.com/dask/dask/
+0002a710: 6973 7375 6573 2f39 3838 382e 2022 0a20  issues/9888. ". 
 0002a720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a730: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-0002a740: 6c64 2074 6173 6b20 7374 6174 653a 207b  ld task state: {
-0002a750: 7473 2e73 7461 7465 7d0a 2020 2020 2020  ts.state}.      
-0002a760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a770: 2020 2020 2020 2020 2020 6f6c 6420 7275            old ru
-0002a780: 6e5f 7370 6563 3a20 7b74 732e 7275 6e5f  n_spec: {ts.run_
-0002a790: 7370 6563 2172 7d0a 2020 2020 2020 2020  spec!r}.        
-0002a7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a7b0: 2020 2020 2020 2020 6e65 7720 7275 6e5f          new run_
-0002a7c0: 7370 6563 3a20 7b64 736b 5b6b 5d21 727d  spec: {dsk[k]!r}
-0002a7d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a730: 2020 2020 2020 2020 2020 202b 2074 6578             + tex
+0002a740: 7477 7261 702e 6465 6465 6e74 280a 2020  twrap.dedent(.  
+0002a750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a760: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+0002a770: 2222 0a20 2020 2020 2020 2020 2020 2020  "".             
+0002a780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a790: 2020 2044 6562 7567 6769 6e67 2069 6e66     Debugging inf
+0002a7a0: 6f72 6d61 7469 6f6e 0a20 2020 2020 2020  ormation.       
+0002a7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a7c0: 2020 2020 2020 2020 202d 2d2d 2d2d 2d2d           -------
+0002a7d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 0a20  --------------. 
 0002a7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a7f0: 206f 6c64 2074 6f6b 656e 3a20 7b6e 6f72   old token: {nor
-0002a800: 6d61 6c69 7a65 5f74 6f6b 656e 2874 732e  malize_token(ts.
-0002a810: 7275 6e5f 7370 6563 2921 727d 0a20 2020  run_spec)!r}.   
+0002a7f0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+0002a800: 6c64 2074 6173 6b20 7374 6174 653a 207b  ld task state: {
+0002a810: 7473 2e73 7461 7465 7d0a 2020 2020 2020  ts.state}.      
 0002a820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a830: 2020 2020 2020 2020 2020 2020 206e 6577               new
-0002a840: 2074 6f6b 656e 3a20 7b6e 6f72 6d61 6c69   token: {normali
-0002a850: 7a65 5f74 6f6b 656e 2864 736b 5b6b 5d29  ze_token(dsk[k])
-0002a860: 2172 7d0a 2020 2020 2020 2020 2020 2020  !r}.            
-0002a870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a880: 2020 2020 6f6c 6420 6465 7065 6e64 656e      old dependen
-0002a890: 6369 6573 3a20 7b64 6570 735f 6c68 737d  cies: {deps_lhs}
-0002a8a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002a8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a8c0: 206e 6577 2064 6570 656e 6465 6e63 6965   new dependencie
-0002a8d0: 733a 207b 6465 7073 5f72 6873 7d0a 2020  s: {deps_rhs}.  
+0002a830: 2020 2020 2020 2020 2020 6f6c 6420 7275            old ru
+0002a840: 6e5f 7370 6563 3a20 7b74 732e 7275 6e5f  n_spec: {ts.run_
+0002a850: 7370 6563 2172 7d0a 2020 2020 2020 2020  spec!r}.        
+0002a860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a870: 2020 2020 2020 2020 6e65 7720 7275 6e5f          new run_
+0002a880: 7370 6563 3a20 7b64 736b 5b6b 5d21 727d  spec: {dsk[k]!r}
+0002a890: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a8b0: 206f 6c64 2074 6f6b 656e 3a20 7b6e 6f72   old token: {nor
+0002a8c0: 6d61 6c69 7a65 5f74 6f6b 656e 2874 732e  malize_token(ts.
+0002a8d0: 7275 6e5f 7370 6563 2921 727d 0a20 2020  run_spec)!r}.   
 0002a8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a8f0: 2020 2020 2020 2020 2020 2020 2020 2222                ""
-0002a900: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0002a910: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0002a920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a930: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0002a940: 2020 2020 2020 2020 2020 2020 2020 656c                el
-0002a950: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0002a960: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-0002a970: 6572 2e64 6562 7567 280a 2020 2020 2020  er.debug(.      
-0002a980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a990: 2020 2020 2020 6622 4465 7465 6374 6564        f"Detected
-0002a9a0: 2064 6966 6665 7265 6e74 2060 7275 6e5f   different `run_
-0002a9b0: 7370 6563 6020 666f 7220 6b65 7920 7b74  spec` for key {t
-0002a9c0: 732e 6b65 7921 727d 2062 6574 7765 656e  s.key!r} between
-0002a9d0: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-0002a9e0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0002a9f0: 7477 6f20 636f 6e73 6563 7574 6976 6520  two consecutive 
-0002aa00: 6361 6c6c 7320 746f 2060 7570 6461 7465  calls to `update
-0002aa10: 5f67 7261 7068 602e 220a 2020 2020 2020  _graph`.".      
-0002aa20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002aa30: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
-0002aa40: 2069 6620 7473 2e72 756e 5f73 7065 633a   if ts.run_spec:
-0002aa50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002aa60: 2072 756e 6e61 626c 652e 6170 7065 6e64   runnable.append
-0002aa70: 2874 7329 0a20 2020 2020 2020 2020 2020  (ts).           
-0002aa80: 2074 6f75 6368 6564 5f6b 6579 732e 6164   touched_keys.ad
-0002aa90: 6428 6b29 0a20 2020 2020 2020 2020 2020  d(k).           
-0002aaa0: 2074 6f75 6368 6564 5f74 6173 6b73 2e61   touched_tasks.a
-0002aab0: 7070 656e 6428 7473 290a 2020 2020 2020  ppend(ts).      
-0002aac0: 2020 2020 2020 7374 6163 6b2e 6578 7465        stack.exte
-0002aad0: 6e64 2864 6570 656e 6465 6e63 6965 732e  nd(dependencies.
-0002aae0: 6765 7428 6b2c 2028 2929 290a 0a20 2020  get(k, ()))..   
-0002aaf0: 2020 2020 2023 2041 6464 2064 6570 656e       # Add depen
-0002ab00: 6465 6e63 6965 730a 2020 2020 2020 2020  dencies.        
-0002ab10: 666f 7220 6b65 792c 2064 6570 7320 696e  for key, deps in
-0002ab20: 2064 6570 656e 6465 6e63 6965 732e 6974   dependencies.it
-0002ab30: 656d 7328 293a 0a20 2020 2020 2020 2020  ems():.         
-0002ab40: 2020 2074 7320 3d20 7365 6c66 2e74 6173     ts = self.tas
-0002ab50: 6b73 2e67 6574 286b 6579 290a 2020 2020  ks.get(key).    
-0002ab60: 2020 2020 2020 2020 6966 2074 7320 6973          if ts is
-0002ab70: 204e 6f6e 6520 6f72 2074 732e 6465 7065   None or ts.depe
-0002ab80: 6e64 656e 6369 6573 3a0a 2020 2020 2020  ndencies:.      
-0002ab90: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
-0002aba0: 7565 0a20 2020 2020 2020 2020 2020 2066  ue.            f
-0002abb0: 6f72 2064 6570 2069 6e20 6465 7073 3a0a  or dep in deps:.
-0002abc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002abd0: 6474 7320 3d20 7365 6c66 2e74 6173 6b73  dts = self.tasks
-0002abe0: 5b64 6570 5d0a 2020 2020 2020 2020 2020  [dep].          
-0002abf0: 2020 2020 2020 7473 2e61 6464 5f64 6570        ts.add_dep
-0002ac00: 656e 6465 6e63 7928 6474 7329 0a0a 2020  endency(dts)..  
-0002ac10: 2020 2020 2020 6966 206c 656e 2874 6f75        if len(tou
-0002ac20: 6368 6564 5f74 6173 6b73 2920 3c20 6c65  ched_tasks) < le
-0002ac30: 6e28 6b65 7973 293a 0a20 2020 2020 2020  n(keys):.       
-0002ac40: 2020 2020 206c 6f67 6765 722e 696e 666f       logger.info
-0002ac50: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0002ac60: 2020 2253 7562 6d69 7474 6564 2067 7261    "Submitted gra
-0002ac70: 7068 2077 6974 6820 6c65 6e67 7468 2025  ph with length %
-0002ac80: 7320 6275 7420 7265 7175 6573 7465 6420  s but requested 
-0002ac90: 6772 6170 6820 6f6e 6c79 2069 6e63 6c75  graph only inclu
-0002aca0: 6465 7320 2573 206b 6579 7322 2c0a 2020  des %s keys",.  
-0002acb0: 2020 2020 2020 2020 2020 2020 2020 6c65                le
-0002acc0: 6e28 746f 7563 6865 645f 7461 736b 7329  n(touched_tasks)
-0002acd0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002ace0: 2020 6c65 6e28 6b65 7973 292c 0a20 2020    len(keys),.   
-0002acf0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0002ad00: 2020 2072 6574 7572 6e20 7275 6e6e 6162     return runnab
-0002ad10: 6c65 2c20 746f 7563 6865 645f 7461 736b  le, touched_task
-0002ad20: 732c 206e 6577 5f74 6173 6b73 0a0a 2020  s, new_tasks..  
-0002ad30: 2020 6465 6620 5f61 7070 6c79 5f61 6e6e    def _apply_ann
-0002ad40: 6f74 6174 696f 6e73 280a 2020 2020 2020  otations(.      
-0002ad50: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-0002ad60: 7461 736b 733a 2049 7465 7261 626c 655b  tasks: Iterable[
-0002ad70: 5461 736b 5374 6174 655d 2c0a 2020 2020  TaskState],.    
-0002ad80: 2020 2020 616e 6e6f 7461 7469 6f6e 735f      annotations_
-0002ad90: 6279 5f74 7970 653a 2064 6963 745b 7374  by_type: dict[st
-0002ada0: 722c 2064 6963 745b 4b65 792c 2041 6e79  r, dict[Key, Any
-0002adb0: 5d5d 2c0a 2020 2020 2920 2d3e 2073 6574  ]],.    ) -> set
-0002adc0: 5b4b 6579 5d3a 0a20 2020 2020 2020 2022  [Key]:.        "
-0002add0: 2222 4170 706c 7920 7468 6520 7072 6f76  ""Apply the prov
-0002ade0: 6964 6564 2061 6e6e 6f74 6174 696f 6e73  ided annotations
-0002adf0: 2074 6f20 7468 6520 7072 6f76 6964 6564   to the provided
-0002ae00: 2060 5461 736b 5374 6174 6560 206f 626a   `TaskState` obj
-0002ae10: 6563 7473 2e0a 0a20 2020 2020 2020 2054  ects...        T
-0002ae20: 6865 2072 6177 2061 6e6e 6f74 6174 696f  he raw annotatio
-0002ae30: 6e73 2077 696c 6c20 6265 2073 746f 7265  ns will be store
-0002ae40: 6420 696e 2074 6865 2060 616e 6e6f 7461  d in the `annota
-0002ae50: 7469 6f6e 7360 2061 7474 7269 6275 7465  tions` attribute
-0002ae60: 2e0a 0a20 2020 2020 2020 204c 6179 6572  ...        Layer
-0002ae70: 202f 206b 6579 2073 7065 6369 6669 6320   / key specific 
-0002ae80: 616e 6e6f 7461 7469 6f6e 7320 7769 6c6c  annotations will
-0002ae90: 2074 616b 6520 7072 6563 6564 656e 6365   take precedence
-0002aea0: 206f 7665 7220 676c 6f62 616c 202f 2067   over global / g
-0002aeb0: 656e 6572 6963 2061 6e6e 6f74 6174 696f  eneric annotatio
-0002aec0: 6e73 2e0a 0a20 2020 2020 2020 2050 6172  ns...        Par
-0002aed0: 616d 6574 6572 730a 2020 2020 2020 2020  ameters.        
-0002aee0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020  ----------.     
-0002aef0: 2020 2074 6173 6b73 203a 2049 7465 7261     tasks : Itera
-0002af00: 626c 655b 5461 736b 5374 6174 655d 0a20  ble[TaskState]. 
-0002af10: 2020 2020 2020 2020 2020 205f 6465 7363             _desc
-0002af20: 7269 7074 696f 6e5f 0a20 2020 2020 2020  ription_.       
-0002af30: 2061 6e6e 6f74 6174 696f 6e73 203a 2064   annotations : d
-0002af40: 6963 740a 2020 2020 2020 2020 2020 2020  ict.            
-0002af50: 5f64 6573 6372 6970 7469 6f6e 5f0a 0a20  _description_.. 
-0002af60: 2020 2020 2020 2052 6574 7572 6e73 0a20         Returns. 
-0002af70: 2020 2020 2020 202d 2d2d 2d2d 2d2d 0a20         -------. 
-0002af80: 2020 2020 2020 206b 6579 735f 7769 7468         keys_with
-0002af90: 5f61 6e6e 6f74 6174 696f 6e73 0a20 2020  _annotations.   
-0002afa0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-0002afb0: 206b 6579 735f 7769 7468 5f61 6e6e 6f74   keys_with_annot
-0002afc0: 6174 696f 6e73 3a20 7365 745b 4b65 795d  ations: set[Key]
-0002afd0: 203d 2073 6574 2829 0a20 2020 2020 2020   = set().       
-0002afe0: 2069 6620 6e6f 7420 616e 6e6f 7461 7469   if not annotati
-0002aff0: 6f6e 735f 6279 5f74 7970 653a 0a20 2020  ons_by_type:.   
-0002b000: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0002b010: 6b65 7973 5f77 6974 685f 616e 6e6f 7461  keys_with_annota
-0002b020: 7469 6f6e 730a 0a20 2020 2020 2020 2066  tions..        f
-0002b030: 6f72 2074 7320 696e 2074 6173 6b73 3a0a  or ts in tasks:.
-0002b040: 2020 2020 2020 2020 2020 2020 6b65 7920              key 
-0002b050: 3d20 7473 2e6b 6579 0a0a 2020 2020 2020  = ts.key..      
-0002b060: 2020 2020 2020 7473 5f61 6e6e 6f74 6174        ts_annotat
-0002b070: 696f 6e73 203d 207b 7d0a 2020 2020 2020  ions = {}.      
-0002b080: 2020 2020 2020 666f 7220 616e 6e6f 742c        for annot,
-0002b090: 206b 6579 5f76 616c 7565 2069 6e20 616e   key_value in an
-0002b0a0: 6e6f 7461 7469 6f6e 735f 6279 5f74 7970  notations_by_typ
-0002b0b0: 652e 6974 656d 7328 293a 0a20 2020 2020  e.items():.     
-0002b0c0: 2020 2020 2020 2020 2020 2069 6620 2876             if (v
-0002b0d0: 616c 7565 203a 3d20 6b65 795f 7661 6c75  alue := key_valu
-0002b0e0: 652e 6765 7428 6b65 7929 2920 6973 206e  e.get(key)) is n
-0002b0f0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-0002b100: 2020 2020 2020 2020 2020 2020 2074 735f               ts_
-0002b110: 616e 6e6f 7461 7469 6f6e 735b 616e 6e6f  annotations[anno
-0002b120: 745d 203d 2076 616c 7565 0a20 2020 2020  t] = value.     
-0002b130: 2020 2020 2020 2069 6620 6e6f 7420 7473         if not ts
-0002b140: 5f61 6e6e 6f74 6174 696f 6e73 3a0a 2020  _annotations:.  
-0002b150: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0002b160: 6e74 696e 7565 0a20 2020 2020 2020 2020  ntinue.         
-0002b170: 2020 206b 6579 735f 7769 7468 5f61 6e6e     keys_with_ann
-0002b180: 6f74 6174 696f 6e73 2e61 6464 286b 6579  otations.add(key
-0002b190: 290a 2020 2020 2020 2020 2020 2020 7473  ).            ts
-0002b1a0: 2e61 6e6e 6f74 6174 696f 6e73 203d 2074  .annotations = t
-0002b1b0: 735f 616e 6e6f 7461 7469 6f6e 730a 2020  s_annotations.  
-0002b1c0: 2020 2020 2020 2020 2020 666f 7220 616e            for an
-0002b1d0: 6e6f 742c 2076 616c 7565 2069 6e20 7473  not, value in ts
-0002b1e0: 5f61 6e6e 6f74 6174 696f 6e73 2e69 7465  _annotations.ite
-0002b1f0: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
-0002b200: 2020 2020 2020 6966 2061 6e6e 6f74 2069        if annot i
-0002b210: 6e20 2822 7265 7374 7269 6374 696f 6e73  n ("restrictions
-0002b220: 222c 2022 776f 726b 6572 7322 293a 0a20  ", "workers"):. 
-0002b230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b240: 2020 2069 6620 6e6f 7420 6973 696e 7374     if not isinst
-0002b250: 616e 6365 2876 616c 7565 2c20 286c 6973  ance(value, (lis
-0002b260: 742c 2074 7570 6c65 2c20 7365 7429 293a  t, tuple, set)):
-0002b270: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002b280: 2020 2020 2020 2020 2076 616c 7565 203d           value =
-0002b290: 205b 7661 6c75 655d 0a20 2020 2020 2020   [value].       
-0002b2a0: 2020 2020 2020 2020 2020 2020 2068 6f73               hos
-0002b2b0: 745f 7265 7374 7269 6374 696f 6e73 203d  t_restrictions =
-0002b2c0: 2073 6574 2829 0a20 2020 2020 2020 2020   set().         
-0002b2d0: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
-0002b2e0: 725f 7265 7374 7269 6374 696f 6e73 203d  r_restrictions =
-0002b2f0: 2073 6574 2829 0a20 2020 2020 2020 2020   set().         
-0002b300: 2020 2020 2020 2020 2020 2066 6f72 2077             for w
-0002b310: 2069 6e20 7661 6c75 653a 0a20 2020 2020   in value:.     
-0002b320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b330: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-0002b340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b350: 2020 2020 7720 3d20 7365 6c66 2e63 6f65      w = self.coe
-0002b360: 7263 655f 6164 6472 6573 7328 7729 0a20  rce_address(w). 
-0002b370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b380: 2020 2020 2020 2065 7863 6570 7420 5661         except Va
-0002b390: 6c75 6545 7272 6f72 3a0a 2020 2020 2020  lueError:.      
-0002b3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b3b0: 2020 2020 2020 2320 4e6f 7420 6120 7661        # Not a va
-0002b3c0: 6c69 6420 6164 6472 6573 732c 2062 7574  lid address, but
-0002b3d0: 2070 6572 6861 7073 2069 7427 7320 6120   perhaps it's a 
-0002b3e0: 686f 7374 6e61 6d65 0a20 2020 2020 2020  hostname.       
-0002b3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b400: 2020 2020 2068 6f73 745f 7265 7374 7269       host_restri
-0002b410: 6374 696f 6e73 2e61 6464 2877 290a 2020  ctions.add(w).  
-0002b420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b430: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0002b440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b450: 2020 2020 2020 2020 776f 726b 6572 5f72          worker_r
-0002b460: 6573 7472 6963 7469 6f6e 732e 6164 6428  estrictions.add(
-0002b470: 7729 0a20 2020 2020 2020 2020 2020 2020  w).             
-0002b480: 2020 2020 2020 2069 6620 686f 7374 5f72         if host_r
-0002b490: 6573 7472 6963 7469 6f6e 733a 0a20 2020  estrictions:.   
-0002b4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b4b0: 2020 2020 2074 732e 686f 7374 5f72 6573       ts.host_res
-0002b4c0: 7472 6963 7469 6f6e 7320 3d20 686f 7374  trictions = host
-0002b4d0: 5f72 6573 7472 6963 7469 6f6e 730a 2020  _restrictions.  
+0002a8f0: 2020 2020 2020 2020 2020 2020 206e 6577               new
+0002a900: 2074 6f6b 656e 3a20 7b6e 6f72 6d61 6c69   token: {normali
+0002a910: 7a65 5f74 6f6b 656e 2864 736b 5b6b 5d29  ze_token(dsk[k])
+0002a920: 2172 7d0a 2020 2020 2020 2020 2020 2020  !r}.            
+0002a930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a940: 2020 2020 6f6c 6420 6465 7065 6e64 656e      old dependen
+0002a950: 6369 6573 3a20 7b64 6570 735f 6c68 737d  cies: {deps_lhs}
+0002a960: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a980: 206e 6577 2064 6570 656e 6465 6e63 6965   new dependencie
+0002a990: 733a 207b 6465 7073 5f72 6873 7d0a 2020  s: {deps_rhs}.  
+0002a9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a9b0: 2020 2020 2020 2020 2020 2020 2020 2222                ""
+0002a9c0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0002a9d0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0002a9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a9f0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0002aa00: 2020 2020 2020 2020 2020 2020 2020 656c                el
+0002aa10: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0002aa20: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+0002aa30: 6572 2e64 6562 7567 280a 2020 2020 2020  er.debug(.      
+0002aa40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002aa50: 2020 2020 2020 6622 4465 7465 6374 6564        f"Detected
+0002aa60: 2064 6966 6665 7265 6e74 2060 7275 6e5f   different `run_
+0002aa70: 7370 6563 6020 666f 7220 6b65 7920 7b74  spec` for key {t
+0002aa80: 732e 6b65 7921 727d 2062 6574 7765 656e  s.key!r} between
+0002aa90: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+0002aaa0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0002aab0: 7477 6f20 636f 6e73 6563 7574 6976 6520  two consecutive 
+0002aac0: 6361 6c6c 7320 746f 2060 7570 6461 7465  calls to `update
+0002aad0: 5f67 7261 7068 602e 220a 2020 2020 2020  _graph`.".      
+0002aae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002aaf0: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
+0002ab00: 2069 6620 7473 2e72 756e 5f73 7065 633a   if ts.run_spec:
+0002ab10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002ab20: 2072 756e 6e61 626c 652e 6170 7065 6e64   runnable.append
+0002ab30: 2874 7329 0a20 2020 2020 2020 2020 2020  (ts).           
+0002ab40: 2074 6f75 6368 6564 5f6b 6579 732e 6164   touched_keys.ad
+0002ab50: 6428 6b29 0a20 2020 2020 2020 2020 2020  d(k).           
+0002ab60: 2074 6f75 6368 6564 5f74 6173 6b73 2e61   touched_tasks.a
+0002ab70: 7070 656e 6428 7473 290a 2020 2020 2020  ppend(ts).      
+0002ab80: 2020 2020 2020 7374 6163 6b2e 6578 7465        stack.exte
+0002ab90: 6e64 2864 6570 656e 6465 6e63 6965 732e  nd(dependencies.
+0002aba0: 6765 7428 6b2c 2028 2929 290a 0a20 2020  get(k, ()))..   
+0002abb0: 2020 2020 2023 2041 6464 2064 6570 656e       # Add depen
+0002abc0: 6465 6e63 6965 730a 2020 2020 2020 2020  dencies.        
+0002abd0: 666f 7220 6b65 792c 2064 6570 7320 696e  for key, deps in
+0002abe0: 2064 6570 656e 6465 6e63 6965 732e 6974   dependencies.it
+0002abf0: 656d 7328 293a 0a20 2020 2020 2020 2020  ems():.         
+0002ac00: 2020 2074 7320 3d20 7365 6c66 2e74 6173     ts = self.tas
+0002ac10: 6b73 2e67 6574 286b 6579 290a 2020 2020  ks.get(key).    
+0002ac20: 2020 2020 2020 2020 6966 2074 7320 6973          if ts is
+0002ac30: 204e 6f6e 6520 6f72 2074 732e 6465 7065   None or ts.depe
+0002ac40: 6e64 656e 6369 6573 3a0a 2020 2020 2020  ndencies:.      
+0002ac50: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
+0002ac60: 7565 0a20 2020 2020 2020 2020 2020 2066  ue.            f
+0002ac70: 6f72 2064 6570 2069 6e20 6465 7073 3a0a  or dep in deps:.
+0002ac80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ac90: 6474 7320 3d20 7365 6c66 2e74 6173 6b73  dts = self.tasks
+0002aca0: 5b64 6570 5d0a 2020 2020 2020 2020 2020  [dep].          
+0002acb0: 2020 2020 2020 7473 2e61 6464 5f64 6570        ts.add_dep
+0002acc0: 656e 6465 6e63 7928 6474 7329 0a0a 2020  endency(dts)..  
+0002acd0: 2020 2020 2020 6966 206c 656e 2874 6f75        if len(tou
+0002ace0: 6368 6564 5f74 6173 6b73 2920 3c20 6c65  ched_tasks) < le
+0002acf0: 6e28 6b65 7973 293a 0a20 2020 2020 2020  n(keys):.       
+0002ad00: 2020 2020 206c 6f67 6765 722e 696e 666f       logger.info
+0002ad10: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0002ad20: 2020 2253 7562 6d69 7474 6564 2067 7261    "Submitted gra
+0002ad30: 7068 2077 6974 6820 6c65 6e67 7468 2025  ph with length %
+0002ad40: 7320 6275 7420 7265 7175 6573 7465 6420  s but requested 
+0002ad50: 6772 6170 6820 6f6e 6c79 2069 6e63 6c75  graph only inclu
+0002ad60: 6465 7320 2573 206b 6579 7322 2c0a 2020  des %s keys",.  
+0002ad70: 2020 2020 2020 2020 2020 2020 2020 6c65                le
+0002ad80: 6e28 746f 7563 6865 645f 7461 736b 7329  n(touched_tasks)
+0002ad90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002ada0: 2020 6c65 6e28 6b65 7973 292c 0a20 2020    len(keys),.   
+0002adb0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0002adc0: 2020 2072 6574 7572 6e20 7275 6e6e 6162     return runnab
+0002add0: 6c65 2c20 746f 7563 6865 645f 7461 736b  le, touched_task
+0002ade0: 732c 206e 6577 5f74 6173 6b73 0a0a 2020  s, new_tasks..  
+0002adf0: 2020 6465 6620 5f61 7070 6c79 5f61 6e6e    def _apply_ann
+0002ae00: 6f74 6174 696f 6e73 280a 2020 2020 2020  otations(.      
+0002ae10: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+0002ae20: 7461 736b 733a 2049 7465 7261 626c 655b  tasks: Iterable[
+0002ae30: 5461 736b 5374 6174 655d 2c0a 2020 2020  TaskState],.    
+0002ae40: 2020 2020 616e 6e6f 7461 7469 6f6e 735f      annotations_
+0002ae50: 6279 5f74 7970 653a 2064 6963 745b 7374  by_type: dict[st
+0002ae60: 722c 2064 6963 745b 4b65 792c 2041 6e79  r, dict[Key, Any
+0002ae70: 5d5d 2c0a 2020 2020 2920 2d3e 2073 6574  ]],.    ) -> set
+0002ae80: 5b4b 6579 5d3a 0a20 2020 2020 2020 2022  [Key]:.        "
+0002ae90: 2222 4170 706c 7920 7468 6520 7072 6f76  ""Apply the prov
+0002aea0: 6964 6564 2061 6e6e 6f74 6174 696f 6e73  ided annotations
+0002aeb0: 2074 6f20 7468 6520 7072 6f76 6964 6564   to the provided
+0002aec0: 2060 5461 736b 5374 6174 6560 206f 626a   `TaskState` obj
+0002aed0: 6563 7473 2e0a 0a20 2020 2020 2020 2054  ects...        T
+0002aee0: 6865 2072 6177 2061 6e6e 6f74 6174 696f  he raw annotatio
+0002aef0: 6e73 2077 696c 6c20 6265 2073 746f 7265  ns will be store
+0002af00: 6420 696e 2074 6865 2060 616e 6e6f 7461  d in the `annota
+0002af10: 7469 6f6e 7360 2061 7474 7269 6275 7465  tions` attribute
+0002af20: 2e0a 0a20 2020 2020 2020 204c 6179 6572  ...        Layer
+0002af30: 202f 206b 6579 2073 7065 6369 6669 6320   / key specific 
+0002af40: 616e 6e6f 7461 7469 6f6e 7320 7769 6c6c  annotations will
+0002af50: 2074 616b 6520 7072 6563 6564 656e 6365   take precedence
+0002af60: 206f 7665 7220 676c 6f62 616c 202f 2067   over global / g
+0002af70: 656e 6572 6963 2061 6e6e 6f74 6174 696f  eneric annotatio
+0002af80: 6e73 2e0a 0a20 2020 2020 2020 2050 6172  ns...        Par
+0002af90: 616d 6574 6572 730a 2020 2020 2020 2020  ameters.        
+0002afa0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020  ----------.     
+0002afb0: 2020 2074 6173 6b73 203a 2049 7465 7261     tasks : Itera
+0002afc0: 626c 655b 5461 736b 5374 6174 655d 0a20  ble[TaskState]. 
+0002afd0: 2020 2020 2020 2020 2020 205f 6465 7363             _desc
+0002afe0: 7269 7074 696f 6e5f 0a20 2020 2020 2020  ription_.       
+0002aff0: 2061 6e6e 6f74 6174 696f 6e73 203a 2064   annotations : d
+0002b000: 6963 740a 2020 2020 2020 2020 2020 2020  ict.            
+0002b010: 5f64 6573 6372 6970 7469 6f6e 5f0a 0a20  _description_.. 
+0002b020: 2020 2020 2020 2052 6574 7572 6e73 0a20         Returns. 
+0002b030: 2020 2020 2020 202d 2d2d 2d2d 2d2d 0a20         -------. 
+0002b040: 2020 2020 2020 206b 6579 735f 7769 7468         keys_with
+0002b050: 5f61 6e6e 6f74 6174 696f 6e73 0a20 2020  _annotations.   
+0002b060: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0002b070: 206b 6579 735f 7769 7468 5f61 6e6e 6f74   keys_with_annot
+0002b080: 6174 696f 6e73 3a20 7365 745b 4b65 795d  ations: set[Key]
+0002b090: 203d 2073 6574 2829 0a20 2020 2020 2020   = set().       
+0002b0a0: 2069 6620 6e6f 7420 616e 6e6f 7461 7469   if not annotati
+0002b0b0: 6f6e 735f 6279 5f74 7970 653a 0a20 2020  ons_by_type:.   
+0002b0c0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0002b0d0: 6b65 7973 5f77 6974 685f 616e 6e6f 7461  keys_with_annota
+0002b0e0: 7469 6f6e 730a 0a20 2020 2020 2020 2066  tions..        f
+0002b0f0: 6f72 2074 7320 696e 2074 6173 6b73 3a0a  or ts in tasks:.
+0002b100: 2020 2020 2020 2020 2020 2020 6b65 7920              key 
+0002b110: 3d20 7473 2e6b 6579 0a0a 2020 2020 2020  = ts.key..      
+0002b120: 2020 2020 2020 7473 5f61 6e6e 6f74 6174        ts_annotat
+0002b130: 696f 6e73 203d 207b 7d0a 2020 2020 2020  ions = {}.      
+0002b140: 2020 2020 2020 666f 7220 616e 6e6f 742c        for annot,
+0002b150: 206b 6579 5f76 616c 7565 2069 6e20 616e   key_value in an
+0002b160: 6e6f 7461 7469 6f6e 735f 6279 5f74 7970  notations_by_typ
+0002b170: 652e 6974 656d 7328 293a 0a20 2020 2020  e.items():.     
+0002b180: 2020 2020 2020 2020 2020 2069 6620 2876             if (v
+0002b190: 616c 7565 203a 3d20 6b65 795f 7661 6c75  alue := key_valu
+0002b1a0: 652e 6765 7428 6b65 7929 2920 6973 206e  e.get(key)) is n
+0002b1b0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+0002b1c0: 2020 2020 2020 2020 2020 2020 2074 735f               ts_
+0002b1d0: 616e 6e6f 7461 7469 6f6e 735b 616e 6e6f  annotations[anno
+0002b1e0: 745d 203d 2076 616c 7565 0a20 2020 2020  t] = value.     
+0002b1f0: 2020 2020 2020 2069 6620 6e6f 7420 7473         if not ts
+0002b200: 5f61 6e6e 6f74 6174 696f 6e73 3a0a 2020  _annotations:.  
+0002b210: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0002b220: 6e74 696e 7565 0a20 2020 2020 2020 2020  ntinue.         
+0002b230: 2020 206b 6579 735f 7769 7468 5f61 6e6e     keys_with_ann
+0002b240: 6f74 6174 696f 6e73 2e61 6464 286b 6579  otations.add(key
+0002b250: 290a 2020 2020 2020 2020 2020 2020 7473  ).            ts
+0002b260: 2e61 6e6e 6f74 6174 696f 6e73 203d 2074  .annotations = t
+0002b270: 735f 616e 6e6f 7461 7469 6f6e 730a 2020  s_annotations.  
+0002b280: 2020 2020 2020 2020 2020 666f 7220 616e            for an
+0002b290: 6e6f 742c 2076 616c 7565 2069 6e20 7473  not, value in ts
+0002b2a0: 5f61 6e6e 6f74 6174 696f 6e73 2e69 7465  _annotations.ite
+0002b2b0: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
+0002b2c0: 2020 2020 2020 6966 2061 6e6e 6f74 2069        if annot i
+0002b2d0: 6e20 2822 7265 7374 7269 6374 696f 6e73  n ("restrictions
+0002b2e0: 222c 2022 776f 726b 6572 7322 293a 0a20  ", "workers"):. 
+0002b2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b300: 2020 2069 6620 6e6f 7420 6973 696e 7374     if not isinst
+0002b310: 616e 6365 2876 616c 7565 2c20 286c 6973  ance(value, (lis
+0002b320: 742c 2074 7570 6c65 2c20 7365 7429 293a  t, tuple, set)):
+0002b330: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002b340: 2020 2020 2020 2020 2076 616c 7565 203d           value =
+0002b350: 205b 7661 6c75 655d 0a20 2020 2020 2020   [value].       
+0002b360: 2020 2020 2020 2020 2020 2020 2068 6f73               hos
+0002b370: 745f 7265 7374 7269 6374 696f 6e73 203d  t_restrictions =
+0002b380: 2073 6574 2829 0a20 2020 2020 2020 2020   set().         
+0002b390: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
+0002b3a0: 725f 7265 7374 7269 6374 696f 6e73 203d  r_restrictions =
+0002b3b0: 2073 6574 2829 0a20 2020 2020 2020 2020   set().         
+0002b3c0: 2020 2020 2020 2020 2020 2066 6f72 2077             for w
+0002b3d0: 2069 6e20 7661 6c75 653a 0a20 2020 2020   in value:.     
+0002b3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b3f0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0002b400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b410: 2020 2020 7720 3d20 7365 6c66 2e63 6f65      w = self.coe
+0002b420: 7263 655f 6164 6472 6573 7328 7729 0a20  rce_address(w). 
+0002b430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b440: 2020 2020 2020 2065 7863 6570 7420 5661         except Va
+0002b450: 6c75 6545 7272 6f72 3a0a 2020 2020 2020  lueError:.      
+0002b460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b470: 2020 2020 2020 2320 4e6f 7420 6120 7661        # Not a va
+0002b480: 6c69 6420 6164 6472 6573 732c 2062 7574  lid address, but
+0002b490: 2070 6572 6861 7073 2069 7427 7320 6120   perhaps it's a 
+0002b4a0: 686f 7374 6e61 6d65 0a20 2020 2020 2020  hostname.       
+0002b4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b4c0: 2020 2020 2068 6f73 745f 7265 7374 7269       host_restri
+0002b4d0: 6374 696f 6e73 2e61 6464 2877 290a 2020  ctions.add(w).  
 0002b4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b4f0: 2020 6966 2077 6f72 6b65 725f 7265 7374    if worker_rest
-0002b500: 7269 6374 696f 6e73 3a0a 2020 2020 2020  rictions:.      
-0002b510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b520: 2020 7473 2e77 6f72 6b65 725f 7265 7374    ts.worker_rest
-0002b530: 7269 6374 696f 6e73 203d 2077 6f72 6b65  rictions = worke
-0002b540: 725f 7265 7374 7269 6374 696f 6e73 0a20  r_restrictions. 
-0002b550: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0002b560: 6c69 6620 616e 6e6f 7420 696e 2028 226c  lif annot in ("l
-0002b570: 6f6f 7365 5f72 6573 7472 6963 7469 6f6e  oose_restriction
-0002b580: 7322 2c20 2261 6c6c 6f77 5f6f 7468 6572  s", "allow_other
-0002b590: 5f77 6f72 6b65 7273 2229 3a0a 2020 2020  _workers"):.    
+0002b4f0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0002b500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b510: 2020 2020 2020 2020 776f 726b 6572 5f72          worker_r
+0002b520: 6573 7472 6963 7469 6f6e 732e 6164 6428  estrictions.add(
+0002b530: 7729 0a20 2020 2020 2020 2020 2020 2020  w).             
+0002b540: 2020 2020 2020 2069 6620 686f 7374 5f72         if host_r
+0002b550: 6573 7472 6963 7469 6f6e 733a 0a20 2020  estrictions:.   
+0002b560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b570: 2020 2020 2074 732e 686f 7374 5f72 6573       ts.host_res
+0002b580: 7472 6963 7469 6f6e 7320 3d20 686f 7374  trictions = host
+0002b590: 5f72 6573 7472 6963 7469 6f6e 730a 2020  _restrictions.  
 0002b5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b5b0: 7473 2e6c 6f6f 7365 5f72 6573 7472 6963  ts.loose_restric
-0002b5c0: 7469 6f6e 7320 3d20 7661 6c75 650a 2020  tions = value.  
-0002b5d0: 2020 2020 2020 2020 2020 2020 2020 656c                el
-0002b5e0: 6966 2061 6e6e 6f74 203d 3d20 2272 6573  if annot == "res
-0002b5f0: 6f75 7263 6573 223a 0a20 2020 2020 2020  ources":.       
-0002b600: 2020 2020 2020 2020 2020 2020 2061 7373               ass
-0002b610: 6572 7420 6973 696e 7374 616e 6365 2876  ert isinstance(v
-0002b620: 616c 7565 2c20 6469 6374 290a 2020 2020  alue, dict).    
-0002b630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b640: 7473 2e72 6573 6f75 7263 655f 7265 7374  ts.resource_rest
-0002b650: 7269 6374 696f 6e73 203d 2076 616c 7565  rictions = value
-0002b660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002b670: 2065 6c69 6620 616e 6e6f 7420 3d3d 2022   elif annot == "
-0002b680: 7072 696f 7269 7479 223a 0a20 2020 2020  priority":.     
-0002b690: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0002b6a0: 2053 6565 2053 6368 6564 756c 6572 2e5f   See Scheduler._
-0002b6b0: 7365 745f 7072 696f 7269 7469 6573 0a20  set_priorities. 
-0002b6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b6d0: 2020 2063 6f6e 7469 6e75 650a 2020 2020     continue.    
-0002b6e0: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-0002b6f0: 2061 6e6e 6f74 203d 3d20 2272 6574 7269   annot == "retri
-0002b700: 6573 223a 0a20 2020 2020 2020 2020 2020  es":.           
-0002b710: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-0002b720: 6973 696e 7374 616e 6365 2876 616c 7565  isinstance(value
-0002b730: 2c20 696e 7429 0a20 2020 2020 2020 2020  , int).         
-0002b740: 2020 2020 2020 2020 2020 2074 732e 7265             ts.re
-0002b750: 7472 6965 7320 3d20 7661 6c75 650a 2020  tries = value.  
-0002b760: 2020 2020 2020 7265 7475 726e 206b 6579        return key
-0002b770: 735f 7769 7468 5f61 6e6e 6f74 6174 696f  s_with_annotatio
-0002b780: 6e73 0a0a 2020 2020 6465 6620 5f73 6574  ns..    def _set
-0002b790: 5f70 7269 6f72 6974 6965 7328 0a20 2020  _priorities(.   
-0002b7a0: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-0002b7b0: 2020 2069 6e74 6572 6e61 6c5f 7072 696f     internal_prio
-0002b7c0: 7269 7479 3a20 6469 6374 5b4b 6579 2c20  rity: dict[Key, 
-0002b7d0: 696e 745d 2c0a 2020 2020 2020 2020 7375  int],.        su
-0002b7e0: 626d 6974 7469 6e67 5f74 6173 6b3a 204b  bmitting_task: K
-0002b7f0: 6579 207c 204e 6f6e 652c 0a20 2020 2020  ey | None,.     
-0002b800: 2020 2075 7365 725f 7072 696f 7269 7479     user_priority
-0002b810: 3a20 696e 7420 7c20 6469 6374 5b4b 6579  : int | dict[Key
-0002b820: 2c20 696e 745d 2c0a 2020 2020 2020 2020  , int],.        
-0002b830: 6669 666f 5f74 696d 656f 7574 3a20 696e  fifo_timeout: in
-0002b840: 7420 7c20 666c 6f61 7420 7c20 7374 722c  t | float | str,
-0002b850: 0a20 2020 2020 2020 2073 7461 7274 3a20  .        start: 
-0002b860: 666c 6f61 742c 0a20 2020 2020 2020 2074  float,.        t
-0002b870: 6173 6b73 3a20 6c69 7374 5b54 6173 6b53  asks: list[TaskS
-0002b880: 7461 7465 5d2c 0a20 2020 2029 202d 3e20  tate],.    ) -> 
-0002b890: 4e6f 6e65 3a0a 2020 2020 2020 2020 6669  None:.        fi
-0002b8a0: 666f 5f74 696d 656f 7574 203d 2070 6172  fo_timeout = par
-0002b8b0: 7365 5f74 696d 6564 656c 7461 2866 6966  se_timedelta(fif
-0002b8c0: 6f5f 7469 6d65 6f75 7429 0a20 2020 2020  o_timeout).     
-0002b8d0: 2020 2069 6620 7375 626d 6974 7469 6e67     if submitting
-0002b8e0: 5f74 6173 6b3a 2020 2320 7375 622d 7461  _task:  # sub-ta
-0002b8f0: 736b 7320 6765 7420 6265 7474 6572 2070  sks get better p
-0002b900: 7269 6f72 6974 7920 7468 616e 2070 6172  riority than par
-0002b910: 656e 7420 7461 736b 730a 2020 2020 2020  ent tasks.      
-0002b920: 2020 2020 2020 7374 7320 3d20 7365 6c66        sts = self
-0002b930: 2e74 6173 6b73 2e67 6574 2873 7562 6d69  .tasks.get(submi
-0002b940: 7474 696e 675f 7461 736b 290a 2020 2020  tting_task).    
-0002b950: 2020 2020 2020 2020 6966 2073 7473 2069          if sts i
-0002b960: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-0002b970: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-0002b980: 7274 2073 7473 2e70 7269 6f72 6974 790a  rt sts.priority.
-0002b990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b9a0: 6765 6e65 7261 7469 6f6e 203d 2073 7473  generation = sts
-0002b9b0: 2e70 7269 6f72 6974 795b 305d 202d 2030  .priority[0] - 0
-0002b9c0: 2e30 310a 2020 2020 2020 2020 2020 2020  .01.            
-0002b9d0: 656c 7365 3a20 2023 2073 7570 6572 2d74  else:  # super-t
-0002b9e0: 6173 6b20 616c 7265 6164 7920 636c 6561  ask already clea
-0002b9f0: 6e65 6420 7570 0a20 2020 2020 2020 2020  ned up.         
-0002ba00: 2020 2020 2020 2067 656e 6572 6174 696f         generatio
-0002ba10: 6e20 3d20 7365 6c66 2e67 656e 6572 6174  n = self.generat
-0002ba20: 696f 6e0a 2020 2020 2020 2020 656c 6966  ion.        elif
-0002ba30: 2073 656c 662e 5f6c 6173 745f 7469 6d65   self._last_time
-0002ba40: 202b 2066 6966 6f5f 7469 6d65 6f75 7420   + fifo_timeout 
-0002ba50: 3c20 7374 6172 743a 0a20 2020 2020 2020  < start:.       
-0002ba60: 2020 2020 2073 656c 662e 6765 6e65 7261       self.genera
-0002ba70: 7469 6f6e 202b 3d20 3120 2023 206f 6c64  tion += 1  # old
-0002ba80: 6572 2067 7261 7068 2067 656e 6572 6174  er graph generat
-0002ba90: 696f 6e73 2074 616b 6520 7072 6563 6564  ions take preced
-0002baa0: 656e 6365 0a20 2020 2020 2020 2020 2020  ence.           
-0002bab0: 2067 656e 6572 6174 696f 6e20 3d20 7365   generation = se
-0002bac0: 6c66 2e67 656e 6572 6174 696f 6e0a 2020  lf.generation.  
-0002bad0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-0002bae0: 6c61 7374 5f74 696d 6520 3d20 7374 6172  last_time = star
-0002baf0: 740a 2020 2020 2020 2020 656c 7365 3a0a  t.        else:.
-0002bb00: 2020 2020 2020 2020 2020 2020 6765 6e65              gene
-0002bb10: 7261 7469 6f6e 203d 2073 656c 662e 6765  ration = self.ge
-0002bb20: 6e65 7261 7469 6f6e 0a0a 2020 2020 2020  neration..      
-0002bb30: 2020 666f 7220 7473 2069 6e20 7461 736b    for ts in task
-0002bb40: 733a 0a20 2020 2020 2020 2020 2020 2069  s:.            i
-0002bb50: 6620 6973 696e 7374 616e 6365 2875 7365  f isinstance(use
-0002bb60: 725f 7072 696f 7269 7479 2c20 6469 6374  r_priority, dict
-0002bb70: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0002bb80: 2020 2074 6173 6b5f 7573 6572 5f70 7269     task_user_pri
-0002bb90: 6f20 3d20 7573 6572 5f70 7269 6f72 6974  o = user_priorit
-0002bba0: 792e 6765 7428 7473 2e6b 6579 2c20 3029  y.get(ts.key, 0)
-0002bbb0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-0002bbc0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0002bbd0: 2020 2074 6173 6b5f 7573 6572 5f70 7269     task_user_pri
-0002bbe0: 6f20 3d20 7573 6572 5f70 7269 6f72 6974  o = user_priorit
-0002bbf0: 790a 2020 2020 2020 2020 2020 2020 2320  y.            # 
-0002bc00: 416e 6e6f 7461 7469 6f6e 7320 7468 6174  Annotations that
-0002bc10: 2061 7265 2061 6c72 6561 6479 2061 7373   are already ass
-0002bc20: 6967 6e65 6420 746f 2074 6865 2054 6173  igned to the Tas
-0002bc30: 6b53 7461 7465 206f 626a 6563 740a 2020  kState object.  
-0002bc40: 2020 2020 2020 2020 2020 2320 6f72 6967            # orig
-0002bc50: 696e 6174 6520 6672 6f6d 2061 204c 6179  inate from a Lay
-0002bc60: 6572 2061 6e6e 6f74 6174 696f 6e20 7768  er annotation wh
-0002bc70: 6963 6820 7461 6b65 7320 7072 6563 6564  ich takes preced
-0002bc80: 656e 6365 206f 7665 7220 7468 650a 2020  ence over the.  
-0002bc90: 2020 2020 2020 2020 2020 2320 676c 6f62            # glob
-0002bca0: 616c 2061 6e6e 6f74 6174 696f 6e2e 0a20  al annotation.. 
-0002bcb0: 2020 2020 2020 2020 2020 2069 6620 7473             if ts
-0002bcc0: 2e61 6e6e 6f74 6174 696f 6e73 3a0a 2020  .annotations:.  
-0002bcd0: 2020 2020 2020 2020 2020 2020 2020 616e                an
-0002bce0: 6e6f 7461 7465 645f 7072 696f 203d 2074  notated_prio = t
-0002bcf0: 732e 616e 6e6f 7461 7469 6f6e 732e 6765  s.annotations.ge
-0002bd00: 7428 2270 7269 6f72 6974 7922 2c20 7461  t("priority", ta
-0002bd10: 736b 5f75 7365 725f 7072 696f 290a 2020  sk_user_prio).  
-0002bd20: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0002bd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bd40: 616e 6e6f 7461 7465 645f 7072 696f 203d  annotated_prio =
-0002bd50: 2074 6173 6b5f 7573 6572 5f70 7269 6f0a   task_user_prio.
-0002bd60: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0002bd70: 6e6f 7420 7473 2e70 7269 6f72 6974 7920  not ts.priority 
-0002bd80: 616e 6420 7473 2e6b 6579 2069 6e20 696e  and ts.key in in
-0002bd90: 7465 726e 616c 5f70 7269 6f72 6974 793a  ternal_priority:
-0002bda0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002bdb0: 2074 732e 7072 696f 7269 7479 203d 2028   ts.priority = (
-0002bdc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002bdd0: 2020 2020 202d 616e 6e6f 7461 7465 645f       -annotated_
-0002bde0: 7072 696f 2c0a 2020 2020 2020 2020 2020  prio,.          
-0002bdf0: 2020 2020 2020 2020 2020 6765 6e65 7261            genera
-0002be00: 7469 6f6e 2c0a 2020 2020 2020 2020 2020  tion,.          
-0002be10: 2020 2020 2020 2020 2020 696e 7465 726e            intern
-0002be20: 616c 5f70 7269 6f72 6974 795b 7473 2e6b  al_priority[ts.k
-0002be30: 6579 5d2c 0a20 2020 2020 2020 2020 2020  ey],.           
-0002be40: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-0002be50: 2020 2020 6966 2073 656c 662e 7661 6c69      if self.vali
-0002be60: 6461 7465 2061 6e64 2074 732e 7275 6e5f  date and ts.run_
-0002be70: 7370 6563 3a0a 2020 2020 2020 2020 2020  spec:.          
-0002be80: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
-0002be90: 6e73 7461 6e63 6528 7473 2e70 7269 6f72  nstance(ts.prior
-0002bea0: 6974 792c 2074 7570 6c65 2920 616e 6420  ity, tuple) and 
-0002beb0: 616c 6c28 0a20 2020 2020 2020 2020 2020  all(.           
-0002bec0: 2020 2020 2020 2020 2069 7369 6e73 7461           isinsta
-0002bed0: 6e63 6528 656c 2c20 2869 6e74 2c20 666c  nce(el, (int, fl
-0002bee0: 6f61 7429 2920 666f 7220 656c 2069 6e20  oat)) for el in 
-0002bef0: 7473 2e70 7269 6f72 6974 790a 2020 2020  ts.priority.    
-0002bf00: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-0002bf10: 2020 2064 6566 2073 7469 6d75 6c75 735f     def stimulus_
-0002bf20: 7175 6575 655f 736c 6f74 735f 6d61 7962  queue_slots_mayb
-0002bf30: 655f 6f70 656e 6564 2873 656c 662c 202a  e_opened(self, *
-0002bf40: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
-0002bf50: 7472 2920 2d3e 204e 6f6e 653a 0a20 2020  tr) -> None:.   
-0002bf60: 2020 2020 2022 2222 5265 7370 6f6e 6420       """Respond 
-0002bf70: 746f 2061 6e20 6576 656e 7420 7768 6963  to an event whic
-0002bf80: 6820 6d61 7920 6861 7665 206f 7065 6e65  h may have opene
-0002bf90: 6420 7370 6f74 7320 6f6e 2077 6f72 6b65  d spots on worke
-0002bfa0: 7220 7468 7265 6164 706f 6f6c 730a 0a20  r threadpools.. 
-0002bfb0: 2020 2020 2020 2053 656c 6563 7473 2074         Selects t
-0002bfc0: 6865 2061 7070 726f 7072 6961 7465 206e  he appropriate n
-0002bfd0: 756d 6265 7220 6f66 2074 6173 6b73 2066  umber of tasks f
-0002bfe0: 726f 6d20 7468 6520 6672 6f6e 7420 6f66  rom the front of
-0002bff0: 2074 6865 2071 7565 7565 2061 6363 6f72   the queue accor
-0002c000: 6469 6e67 2074 6f0a 2020 2020 2020 2020  ding to.        
-0002c010: 7468 6520 746f 7461 6c20 6e75 6d62 6572  the total number
-0002c020: 206f 6620 7461 736b 2073 6c6f 7473 2061   of task slots a
-0002c030: 7661 696c 6162 6c65 206f 6e20 776f 726b  vailable on work
-0002c040: 6572 7320 2870 6f74 656e 7469 616c 6c79  ers (potentially
-0002c050: 2030 292c 2061 6e64 0a20 2020 2020 2020   0), and.       
-0002c060: 2074 7261 6e73 6974 696f 6e73 2074 6865   transitions the
-0002c070: 6d20 746f 2060 6070 726f 6365 7373 696e  m to ``processin
-0002c080: 6760 602e 0a0a 2020 2020 2020 2020 4e6f  g``...        No
-0002c090: 7465 730a 2020 2020 2020 2020 2d2d 2d2d  tes.        ----
-0002c0a0: 2d0a 2020 2020 2020 2020 4f74 6865 7220  -.        Other 
-0002c0b0: 7472 616e 7369 7469 6f6e 7320 7265 6c61  transitions rela
-0002c0c0: 7465 6420 746f 2074 6869 7320 7374 696d  ted to this stim
-0002c0d0: 756c 7573 2073 686f 756c 6420 6265 2066  ulus should be f
-0002c0e0: 756c 6c79 2070 726f 6365 7373 6564 2062  ully processed b
-0002c0f0: 6566 6f72 6568 616e 642c 0a20 2020 2020  eforehand,.     
-0002c100: 2020 2073 6f20 616e 7920 7461 736b 7320     so any tasks 
-0002c110: 7468 6174 2062 6563 616d 6520 7275 6e6e  that became runn
-0002c120: 6162 6c65 2061 7265 2061 6c72 6561 6479  able are already
-0002c130: 2069 6e20 6060 7072 6f63 6573 7369 6e67   in ``processing
-0002c140: 6060 2e20 4f74 6865 7277 6973 652c 0a20  ``. Otherwise,. 
-0002c150: 2020 2020 2020 206f 7665 7270 726f 6475         overprodu
-0002c160: 6374 696f 6e20 6361 6e20 6f63 6375 7220  ction can occur 
-0002c170: 6966 2071 7565 7565 6420 7461 736b 7320  if queued tasks 
-0002c180: 6765 7420 7363 6865 6475 6c65 6420 6265  get scheduled be
-0002c190: 666f 7265 2064 6f77 6e73 7472 6561 6d20  fore downstream 
-0002c1a0: 7461 736b 732e 0a0a 2020 2020 2020 2020  tasks...        
-0002c1b0: 4d75 7374 2062 6520 6361 6c6c 6564 2061  Must be called a
-0002c1c0: 6674 6572 2060 6368 6563 6b5f 6964 6c65  fter `check_idle
-0002c1d0: 5f73 6174 7572 6174 6564 603b 2069 2e65  _saturated`; i.e
-0002c1e0: 2e20 6069 646c 655f 7461 736b 5f63 6f75  . `idle_task_cou
-0002c1f0: 6e74 6020 6d75 7374 2062 6520 7570 2074  nt` must be up t
-0002c200: 6f20 6461 7465 2e0a 2020 2020 2020 2020  o date..        
-0002c210: 2222 220a 2020 2020 2020 2020 6966 206e  """.        if n
-0002c220: 6f74 2073 656c 662e 7175 6575 6564 3a0a  ot self.queued:.
-0002c230: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0002c240: 726e 0a20 2020 2020 2020 2073 6c6f 7473  rn.        slots
-0002c250: 5f61 7661 696c 6162 6c65 203d 2073 756d  _available = sum
-0002c260: 280a 2020 2020 2020 2020 2020 2020 5f74  (.            _t
-0002c270: 6173 6b5f 736c 6f74 735f 6176 6169 6c61  ask_slots_availa
-0002c280: 626c 6528 7773 2c20 7365 6c66 2e57 4f52  ble(ws, self.WOR
-0002c290: 4b45 525f 5341 5455 5241 5449 4f4e 290a  KER_SATURATION).
-0002c2a0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0002c2b0: 7773 2069 6e20 7365 6c66 2e69 646c 655f  ws in self.idle_
-0002c2c0: 7461 736b 5f63 6f75 6e74 0a20 2020 2020  task_count.     
-0002c2d0: 2020 2029 0a20 2020 2020 2020 2069 6620     ).        if 
-0002c2e0: 736c 6f74 735f 6176 6169 6c61 626c 6520  slots_available 
-0002c2f0: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
-0002c300: 2020 7265 7475 726e 0a0a 2020 2020 2020    return..      
-0002c310: 2020 666f 7220 5f20 696e 2072 616e 6765    for _ in range
-0002c320: 2873 6c6f 7473 5f61 7661 696c 6162 6c65  (slots_available
-0002c330: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
-0002c340: 6620 6e6f 7420 7365 6c66 2e71 7565 7565  f not self.queue
-0002c350: 643a 0a20 2020 2020 2020 2020 2020 2020  d:.             
-0002c360: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
-0002c370: 2020 2020 2020 2320 4964 6561 6c6c 792c        # Ideally,
-0002c380: 2077 6527 6420 6265 2070 6f70 7069 6e67   we'd be popping
-0002c390: 2069 7420 6865 7265 2061 6c72 6561 6479   it here already
-0002c3a0: 2062 7574 2074 6869 7320 776f 756c 6420   but this would 
-0002c3b0: 6272 6561 6b0a 2020 2020 2020 2020 2020  break.          
-0002c3c0: 2020 2320 6365 7274 6169 6e20 7374 6174    # certain stat
-0002c3d0: 6520 696e 7661 7269 616e 7473 2073 696e  e invariants sin
-0002c3e0: 6365 2074 6865 2074 6173 6b20 6973 206e  ce the task is n
-0002c3f0: 6f74 2074 7261 6e73 6974 696f 6e65 642c  ot transitioned,
-0002c400: 2079 6574 0a20 2020 2020 2020 2020 2020   yet.           
-0002c410: 2071 7473 203d 2073 656c 662e 7175 6575   qts = self.queu
-0002c420: 6564 2e70 6565 6b28 290a 2020 2020 2020  ed.peek().      
-0002c430: 2020 2020 2020 6966 2073 656c 662e 7661        if self.va
-0002c440: 6c69 6461 7465 3a0a 2020 2020 2020 2020  lidate:.        
-0002c450: 2020 2020 2020 2020 6173 7365 7274 2071          assert q
-0002c460: 7473 2e73 7461 7465 203d 3d20 2271 7565  ts.state == "que
-0002c470: 7565 6422 2c20 7174 732e 7374 6174 650a  ued", qts.state.
-0002c480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c490: 6173 7365 7274 206e 6f74 2071 7473 2e70  assert not qts.p
-0002c4a0: 726f 6365 7373 696e 675f 6f6e 2c20 2871  rocessing_on, (q
-0002c4b0: 7473 2c20 7174 732e 7072 6f63 6573 7369  ts, qts.processi
-0002c4c0: 6e67 5f6f 6e29 0a20 2020 2020 2020 2020  ng_on).         
-0002c4d0: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
-0002c4e0: 7420 7174 732e 7761 6974 696e 675f 6f6e  t qts.waiting_on
-0002c4f0: 2c20 2871 7473 2c20 7174 732e 7072 6f63  , (qts, qts.proc
-0002c500: 6573 7369 6e67 5f6f 6e29 0a20 2020 2020  essing_on).     
-0002c510: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0002c520: 7420 7174 732e 7768 6f5f 7761 6e74 7320  t qts.who_wants 
-0002c530: 6f72 2071 7473 2e77 6169 7465 7273 2c20  or qts.waiters, 
-0002c540: 7174 730a 0a20 2020 2020 2020 2020 2020  qts..           
-0002c550: 2023 2054 6869 7320 7265 6d6f 7665 7320   # This removes 
-0002c560: 7468 6520 7461 736b 2066 726f 6d20 7468  the task from th
-0002c570: 6520 746f 7020 6f66 2074 6865 2073 656c  e top of the sel
-0002c580: 662e 7175 6575 6564 2068 6561 700a 2020  f.queued heap.  
-0002c590: 2020 2020 2020 2020 2020 7365 6c66 2e74            self.t
-0002c5a0: 7261 6e73 6974 696f 6e73 287b 7174 732e  ransitions({qts.
-0002c5b0: 6b65 793a 2022 7072 6f63 6573 7369 6e67  key: "processing
-0002c5c0: 227d 2c20 7374 696d 756c 7573 5f69 6429  "}, stimulus_id)
-0002c5d0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0002c5e0: 7365 6c66 2e76 616c 6964 6174 653a 0a20  self.validate:. 
-0002c5f0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0002c600: 7373 6572 7420 7174 732e 7374 6174 6520  ssert qts.state 
-0002c610: 3d3d 2022 7072 6f63 6573 7369 6e67 220a  == "processing".
-0002c620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c630: 6173 7365 7274 206e 6f74 2073 656c 662e  assert not self.
-0002c640: 7175 6575 6564 206f 7220 7365 6c66 2e71  queued or self.q
-0002c650: 7565 7565 642e 7065 656b 2829 2021 3d20  ueued.peek() != 
-0002c660: 7174 730a 0a20 2020 2064 6566 2073 7469  qts..    def sti
-0002c670: 6d75 6c75 735f 7461 736b 5f66 696e 6973  mulus_task_finis
-0002c680: 6865 6428 0a20 2020 2020 2020 2073 656c  hed(.        sel
-0002c690: 662c 206b 6579 3a20 4b65 792c 2077 6f72  f, key: Key, wor
-0002c6a0: 6b65 723a 2073 7472 2c20 7374 696d 756c  ker: str, stimul
-0002c6b0: 7573 5f69 643a 2073 7472 2c20 7275 6e5f  us_id: str, run_
-0002c6c0: 6964 3a20 696e 742c 202a 2a6b 7761 7267  id: int, **kwarg
-0002c6d0: 733a 2041 6e79 0a20 2020 2029 202d 3e20  s: Any.    ) -> 
-0002c6e0: 5265 6373 4d73 6773 3a0a 2020 2020 2020  RecsMsgs:.      
-0002c6f0: 2020 2222 224d 6172 6b20 7468 6174 2061    """Mark that a
-0002c700: 2074 6173 6b20 6861 7320 6669 6e69 7368   task has finish
-0002c710: 6564 2065 7865 6375 7469 6f6e 206f 6e20  ed execution on 
-0002c720: 6120 7061 7274 6963 756c 6172 2077 6f72  a particular wor
-0002c730: 6b65 7222 2222 0a20 2020 2020 2020 206c  ker""".        l
-0002c740: 6f67 6765 722e 6465 6275 6728 2253 7469  ogger.debug("Sti
-0002c750: 6d75 6c75 7320 7461 736b 2066 696e 6973  mulus task finis
-0002c760: 6865 6420 2573 5b25 645d 2025 7322 2c20  hed %s[%d] %s", 
-0002c770: 6b65 792c 2072 756e 5f69 642c 2077 6f72  key, run_id, wor
-0002c780: 6b65 7229 0a0a 2020 2020 2020 2020 7265  ker)..        re
-0002c790: 636f 6d6d 656e 6461 7469 6f6e 733a 2052  commendations: R
-0002c7a0: 6563 7320 3d20 7b7d 0a20 2020 2020 2020  ecs = {}.       
-0002c7b0: 2063 6c69 656e 745f 6d73 6773 3a20 4d73   client_msgs: Ms
-0002c7c0: 6773 203d 207b 7d0a 2020 2020 2020 2020  gs = {}.        
-0002c7d0: 776f 726b 6572 5f6d 7367 733a 204d 7367  worker_msgs: Msg
-0002c7e0: 7320 3d20 7b7d 0a0a 2020 2020 2020 2020  s = {}..        
-0002c7f0: 7473 203d 2073 656c 662e 7461 736b 732e  ts = self.tasks.
-0002c800: 6765 7428 6b65 7929 0a20 2020 2020 2020  get(key).       
-0002c810: 2069 6620 7473 2069 7320 4e6f 6e65 206f   if ts is None o
-0002c820: 7220 7473 2e73 7461 7465 2069 6e20 2822  r ts.state in ("
-0002c830: 7265 6c65 6173 6564 222c 2022 7175 6575  released", "queu
-0002c840: 6564 222c 2022 6e6f 2d77 6f72 6b65 7222  ed", "no-worker"
-0002c850: 293a 0a20 2020 2020 2020 2020 2020 206c  ):.            l
-0002c860: 6f67 6765 722e 6465 6275 6728 0a20 2020  ogger.debug(.   
-0002c870: 2020 2020 2020 2020 2020 2020 2022 5265               "Re
-0002c880: 6365 6976 6564 2061 6c72 6561 6479 2063  ceived already c
-0002c890: 6f6d 7075 7465 6420 7461 736b 2c20 776f  omputed task, wo
-0002c8a0: 726b 6572 3a20 2573 2c20 7374 6174 653a  rker: %s, state:
-0002c8b0: 2025 7322 0a20 2020 2020 2020 2020 2020   %s".           
-0002c8c0: 2020 2020 2022 2c20 6b65 793a 2025 732c       ", key: %s,
-0002c8d0: 2077 686f 5f68 6173 3a20 2573 222c 0a20   who_has: %s",. 
-0002c8e0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-0002c8f0: 6f72 6b65 722c 0a20 2020 2020 2020 2020  orker,.         
-0002c900: 2020 2020 2020 2074 732e 7374 6174 6520         ts.state 
-0002c910: 6966 2074 7320 656c 7365 2022 666f 7267  if ts else "forg
-0002c920: 6f74 7465 6e22 2c0a 2020 2020 2020 2020  otten",.        
-0002c930: 2020 2020 2020 2020 6b65 792c 0a20 2020          key,.   
-0002c940: 2020 2020 2020 2020 2020 2020 2074 732e               ts.
-0002c950: 7768 6f5f 6861 7320 6966 2074 7320 656c  who_has if ts el
-0002c960: 7365 207b 7d2c 0a20 2020 2020 2020 2020  se {},.         
-0002c970: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0002c980: 2077 6f72 6b65 725f 6d73 6773 5b77 6f72   worker_msgs[wor
-0002c990: 6b65 725d 203d 205b 0a20 2020 2020 2020  ker] = [.       
-0002c9a0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-0002c9b0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0002c9c0: 6f70 223a 2022 6672 6565 2d6b 6579 7322  op": "free-keys"
-0002c9d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002c9e0: 2020 2020 2020 226b 6579 7322 3a20 5b6b        "keys": [k
-0002c9f0: 6579 5d2c 0a20 2020 2020 2020 2020 2020  ey],.           
-0002ca00: 2020 2020 2020 2020 2022 7374 696d 756c           "stimul
-0002ca10: 7573 5f69 6422 3a20 7374 696d 756c 7573  us_id": stimulus
-0002ca20: 5f69 642c 0a20 2020 2020 2020 2020 2020  _id,.           
-0002ca30: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-0002ca40: 2020 205d 0a20 2020 2020 2020 2065 6c69     ].        eli
-0002ca50: 6620 7473 2e73 7461 7465 203d 3d20 2265  f ts.state == "e
-0002ca60: 7272 6564 223a 0a20 2020 2020 2020 2020  rred":.         
-0002ca70: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
-0002ca80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002ca90: 2022 5265 6365 6976 6564 2061 6c72 6561   "Received alrea
-0002caa0: 6479 2065 7272 6564 2074 6173 6b2c 2077  dy erred task, w
-0002cab0: 6f72 6b65 723a 2025 7322 2022 2c20 6b65  orker: %s" ", ke
-0002cac0: 793a 2025 7322 2c0a 2020 2020 2020 2020  y: %s",.        
-0002cad0: 2020 2020 2020 2020 776f 726b 6572 2c0a          worker,.
-0002cae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002caf0: 6b65 792c 0a20 2020 2020 2020 2020 2020  key,.           
-0002cb00: 2029 0a20 2020 2020 2020 2020 2020 2077   ).            w
-0002cb10: 6f72 6b65 725f 6d73 6773 5b77 6f72 6b65  orker_msgs[worke
-0002cb20: 725d 203d 205b 0a20 2020 2020 2020 2020  r] = [.         
-0002cb30: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-0002cb40: 2020 2020 2020 2020 2020 2020 2022 6f70               "op
-0002cb50: 223a 2022 6672 6565 2d6b 6579 7322 2c0a  ": "free-keys",.
-0002cb60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cb70: 2020 2020 226b 6579 7322 3a20 5b6b 6579      "keys": [key
-0002cb80: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-0002cb90: 2020 2020 2020 2022 7374 696d 756c 7573         "stimulus
-0002cba0: 5f69 6422 3a20 7374 696d 756c 7573 5f69  _id": stimulus_i
-0002cbb0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
-0002cbc0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-0002cbd0: 205d 0a20 2020 2020 2020 2065 6c69 6620   ].        elif 
-0002cbe0: 7473 2e72 756e 5f69 6420 213d 2072 756e  ts.run_id != run
-0002cbf0: 5f69 643a 0a20 2020 2020 2020 2020 2020  _id:.           
-0002cc00: 2069 6620 6e6f 7420 7473 2e70 726f 6365   if not ts.proce
-0002cc10: 7373 696e 675f 6f6e 206f 7220 7473 2e70  ssing_on or ts.p
-0002cc20: 726f 6365 7373 696e 675f 6f6e 2e61 6464  rocessing_on.add
-0002cc30: 7265 7373 2021 3d20 776f 726b 6572 3a0a  ress != worker:.
-0002cc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cc50: 6c6f 6767 6572 2e64 6562 7567 280a 2020  logger.debug(.  
-0002cc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cc70: 2020 2252 6563 6569 7665 6420 7374 616c    "Received stal
-0002cc80: 6520 7461 736b 2072 756e 2c20 776f 726b  e task run, work
-0002cc90: 6572 3a20 2573 2c20 6b65 793a 2025 732c  er: %s, key: %s,
-0002cca0: 2072 756e 5f69 643a 2025 6420 2825 6429   run_id: %d (%d)
-0002ccb0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-0002ccc0: 2020 2020 2020 2077 6f72 6b65 722c 0a20         worker,. 
-0002ccd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cce0: 2020 206b 6579 2c0a 2020 2020 2020 2020     key,.        
-0002ccf0: 2020 2020 2020 2020 2020 2020 7275 6e5f              run_
-0002cd00: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
-0002cd10: 2020 2020 2020 2020 7473 2e72 756e 5f69          ts.run_i
-0002cd20: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
-0002cd30: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0002cd40: 2020 2020 2077 6f72 6b65 725f 6d73 6773       worker_msgs
-0002cd50: 5b77 6f72 6b65 725d 203d 205b 0a20 2020  [worker] = [.   
-0002cd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cd70: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0002cd80: 2020 2020 2020 2020 2020 2022 6f70 223a             "op":
-0002cd90: 2022 6672 6565 2d6b 6579 7322 2c0a 2020   "free-keys",.  
-0002cda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cdb0: 2020 2020 2020 226b 6579 7322 3a20 5b6b        "keys": [k
-0002cdc0: 6579 5d2c 0a20 2020 2020 2020 2020 2020  ey],.           
-0002cdd0: 2020 2020 2020 2020 2020 2020 2022 7374               "st
-0002cde0: 696d 756c 7573 5f69 6422 3a20 7374 696d  imulus_id": stim
-0002cdf0: 756c 7573 5f69 642c 0a20 2020 2020 2020  ulus_id,.       
-0002ce00: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-0002ce10: 2020 2020 2020 2020 2020 2020 2020 205d                 ]
-0002ce20: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-0002ce30: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0002ce40: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
-0002ce50: 6e73 5b74 732e 6b65 795d 203d 2022 7265  ns[ts.key] = "re
-0002ce60: 6c65 6173 6564 220a 2020 2020 2020 2020  leased".        
-0002ce70: 656c 6966 2074 732e 7374 6174 6520 3d3d  elif ts.state ==
-0002ce80: 2022 6d65 6d6f 7279 223a 0a20 2020 2020   "memory":.     
-0002ce90: 2020 2020 2020 2073 656c 662e 6164 645f         self.add_
-0002cea0: 6b65 7973 2877 6f72 6b65 723d 776f 726b  keys(worker=work
-0002ceb0: 6572 2c20 6b65 7973 3d5b 6b65 795d 290a  er, keys=[key]).
-0002cec0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0002ced0: 2020 2020 2020 2020 2020 6966 206b 7761            if kwa
-0002cee0: 7267 735b 226d 6574 6164 6174 6122 5d3a  rgs["metadata"]:
-0002cef0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002cf00: 2069 6620 7473 2e6d 6574 6164 6174 6120   if ts.metadata 
-0002cf10: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-0002cf20: 2020 2020 2020 2020 2020 2020 2074 732e               ts.
-0002cf30: 6d65 7461 6461 7461 203d 2064 6963 7428  metadata = dict(
-0002cf40: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0002cf50: 2020 7473 2e6d 6574 6164 6174 612e 7570    ts.metadata.up
-0002cf60: 6461 7465 286b 7761 7267 735b 226d 6574  date(kwargs["met
-0002cf70: 6164 6174 6122 5d29 0a20 2020 2020 2020  adata"]).       
-0002cf80: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-0002cf90: 2e5f 7472 616e 7369 7469 6f6e 286b 6579  ._transition(key
-0002cfa0: 2c20 226d 656d 6f72 7922 2c20 7374 696d  , "memory", stim
-0002cfb0: 756c 7573 5f69 642c 2077 6f72 6b65 723d  ulus_id, worker=
-0002cfc0: 776f 726b 6572 2c20 2a2a 6b77 6172 6773  worker, **kwargs
-0002cfd0: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
-0002cfe0: 6e20 7265 636f 6d6d 656e 6461 7469 6f6e  n recommendation
-0002cff0: 732c 2063 6c69 656e 745f 6d73 6773 2c20  s, client_msgs, 
-0002d000: 776f 726b 6572 5f6d 7367 730a 0a20 2020  worker_msgs..   
-0002d010: 2064 6566 2073 7469 6d75 6c75 735f 7461   def stimulus_ta
-0002d020: 736b 5f65 7272 6564 280a 2020 2020 2020  sk_erred(.      
-0002d030: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-0002d040: 6b65 793d 4e6f 6e65 2c0a 2020 2020 2020  key=None,.      
-0002d050: 2020 776f 726b 6572 3d4e 6f6e 652c 0a20    worker=None,. 
-0002d060: 2020 2020 2020 2065 7863 6570 7469 6f6e         exception
-0002d070: 3d4e 6f6e 652c 0a20 2020 2020 2020 2073  =None,.        s
-0002d080: 7469 6d75 6c75 735f 6964 3d4e 6f6e 652c  timulus_id=None,
-0002d090: 0a20 2020 2020 2020 2074 7261 6365 6261  .        traceba
-0002d0a0: 636b 3d4e 6f6e 652c 0a20 2020 2020 2020  ck=None,.       
-0002d0b0: 2072 756e 5f69 643d 4e6f 6e65 2c0a 2020   run_id=None,.  
-0002d0c0: 2020 2020 2020 2a2a 6b77 6172 6773 2c0a        **kwargs,.
-0002d0d0: 2020 2020 293a 0a20 2020 2020 2020 2022      ):.        "
-0002d0e0: 2222 4d61 726b 2074 6861 7420 6120 7461  ""Mark that a ta
-0002d0f0: 736b 2068 6173 2065 7272 6564 206f 6e20  sk has erred on 
-0002d100: 6120 7061 7274 6963 756c 6172 2077 6f72  a particular wor
-0002d110: 6b65 7222 2222 0a20 2020 2020 2020 206c  ker""".        l
-0002d120: 6f67 6765 722e 6465 6275 6728 2253 7469  ogger.debug("Sti
-0002d130: 6d75 6c75 7320 7461 736b 2065 7272 6564  mulus task erred
-0002d140: 2025 732c 2025 7322 2c20 6b65 792c 2077   %s, %s", key, w
-0002d150: 6f72 6b65 7229 0a0a 2020 2020 2020 2020  orker)..        
-0002d160: 7473 203d 2073 656c 662e 7461 736b 732e  ts = self.tasks.
-0002d170: 6765 7428 6b65 7929 0a20 2020 2020 2020  get(key).       
-0002d180: 2069 6620 7473 2069 7320 4e6f 6e65 206f   if ts is None o
-0002d190: 7220 7473 2e73 7461 7465 2021 3d20 2270  r ts.state != "p
-0002d1a0: 726f 6365 7373 696e 6722 3a0a 2020 2020  rocessing":.    
-0002d1b0: 2020 2020 2020 2020 7265 7475 726e 207b          return {
-0002d1c0: 7d2c 207b 7d2c 207b 7d0a 0a20 2020 2020  }, {}, {}..     
-0002d1d0: 2020 2069 6620 7473 2e72 756e 5f69 6420     if ts.run_id 
-0002d1e0: 213d 2072 756e 5f69 643a 0a20 2020 2020  != run_id:.     
-0002d1f0: 2020 2020 2020 2069 6620 7473 2e70 726f         if ts.pro
-0002d200: 6365 7373 696e 675f 6f6e 2061 6e64 2074  cessing_on and t
-0002d210: 732e 7072 6f63 6573 7369 6e67 5f6f 6e2e  s.processing_on.
-0002d220: 6164 6472 6573 7320 3d3d 2077 6f72 6b65  address == worke
-0002d230: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
-0002d240: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
-0002d250: 7472 616e 7369 7469 6f6e 286b 6579 2c20  transition(key, 
-0002d260: 2272 656c 6561 7365 6422 2c20 7374 696d  "released", stim
-0002d270: 756c 7573 5f69 6429 0a20 2020 2020 2020  ulus_id).       
-0002d280: 2020 2020 2072 6574 7572 6e20 7b7d 2c20       return {}, 
-0002d290: 7b7d 2c20 7b7d 0a0a 2020 2020 2020 2020  {}, {}..        
-0002d2a0: 6966 2074 732e 7265 7472 6965 7320 3e20  if ts.retries > 
-0002d2b0: 303a 0a20 2020 2020 2020 2020 2020 2074  0:.            t
-0002d2c0: 732e 7265 7472 6965 7320 2d3d 2031 0a20  s.retries -= 1. 
-0002d2d0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0002d2e0: 6e20 7365 6c66 2e5f 7472 616e 7369 7469  n self._transiti
-0002d2f0: 6f6e 286b 6579 2c20 2277 6169 7469 6e67  on(key, "waiting
-0002d300: 222c 2073 7469 6d75 6c75 735f 6964 290a  ", stimulus_id).
-0002d310: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0002d320: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0002d330: 2073 656c 662e 5f74 7261 6e73 6974 696f   self._transitio
-0002d340: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
-0002d350: 2020 206b 6579 2c0a 2020 2020 2020 2020     key,.        
-0002d360: 2020 2020 2020 2020 2265 7272 6564 222c          "erred",
-0002d370: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002d380: 2073 7469 6d75 6c75 735f 6964 2c0a 2020   stimulus_id,.  
-0002d390: 2020 2020 2020 2020 2020 2020 2020 6361                ca
-0002d3a0: 7573 653d 6b65 792c 0a20 2020 2020 2020  use=key,.       
-0002d3b0: 2020 2020 2020 2020 2065 7863 6570 7469           excepti
-0002d3c0: 6f6e 3d65 7863 6570 7469 6f6e 2c0a 2020  on=exception,.  
-0002d3d0: 2020 2020 2020 2020 2020 2020 2020 7472                tr
-0002d3e0: 6163 6562 6163 6b3d 7472 6163 6562 6163  aceback=tracebac
-0002d3f0: 6b2c 0a20 2020 2020 2020 2020 2020 2020  k,.             
-0002d400: 2020 2077 6f72 6b65 723d 776f 726b 6572     worker=worker
-0002d410: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002d420: 2020 2a2a 6b77 6172 6773 2c0a 2020 2020    **kwargs,.    
-0002d430: 2020 2020 2020 2020 290a 0a20 2020 2064          )..    d
-0002d440: 6566 2073 7469 6d75 6c75 735f 7265 7472  ef stimulus_retr
-0002d450: 7928 0a20 2020 2020 2020 2073 656c 662c  y(.        self,
-0002d460: 206b 6579 733a 2043 6f6c 6c65 6374 696f   keys: Collectio
-0002d470: 6e5b 4b65 795d 2c20 636c 6965 6e74 3a20  n[Key], client: 
-0002d480: 7374 7220 7c20 4e6f 6e65 203d 204e 6f6e  str | None = Non
-0002d490: 650a 2020 2020 2920 2d3e 2074 7570 6c65  e.    ) -> tuple
-0002d4a0: 5b4b 6579 2c20 2e2e 2e5d 3a0a 2020 2020  [Key, ...]:.    
-0002d4b0: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
-0002d4c0: 2243 6c69 656e 7420 2573 2072 6571 7565  "Client %s reque
-0002d4d0: 7374 7320 746f 2072 6574 7279 2025 6420  sts to retry %d 
-0002d4e0: 6b65 7973 222c 2063 6c69 656e 742c 206c  keys", client, l
-0002d4f0: 656e 286b 6579 7329 290a 2020 2020 2020  en(keys)).      
-0002d500: 2020 6966 2063 6c69 656e 743a 0a20 2020    if client:.   
-0002d510: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
-0002d520: 675f 6576 656e 7428 636c 6965 6e74 2c20  g_event(client, 
-0002d530: 7b22 6163 7469 6f6e 223a 2022 7265 7472  {"action": "retr
-0002d540: 7922 2c20 2263 6f75 6e74 223a 206c 656e  y", "count": len
-0002d550: 286b 6579 7329 7d29 0a0a 2020 2020 2020  (keys)})..      
-0002d560: 2020 7374 6163 6b20 3d20 6c69 7374 286b    stack = list(k
-0002d570: 6579 7329 0a20 2020 2020 2020 2073 6565  eys).        see
-0002d580: 6e20 3d20 7365 7428 290a 2020 2020 2020  n = set().      
-0002d590: 2020 726f 6f74 7320 3d20 5b5d 0a20 2020    roots = [].   
-0002d5a0: 2020 2020 2077 6869 6c65 2073 7461 636b       while stack
-0002d5b0: 3a0a 2020 2020 2020 2020 2020 2020 6b65  :.            ke
-0002d5c0: 7920 3d20 7374 6163 6b2e 706f 7028 290a  y = stack.pop().
-0002d5d0: 2020 2020 2020 2020 2020 2020 7365 656e              seen
-0002d5e0: 2e61 6464 286b 6579 290a 2020 2020 2020  .add(key).      
-0002d5f0: 2020 2020 2020 7473 203d 2073 656c 662e        ts = self.
-0002d600: 7461 736b 735b 6b65 795d 0a20 2020 2020  tasks[key].     
-0002d610: 2020 2020 2020 2065 7272 6564 5f64 6570         erred_dep
-0002d620: 7320 3d20 5b64 7473 2e6b 6579 2066 6f72  s = [dts.key for
-0002d630: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
-0002d640: 6465 6e63 6965 7320 6966 2064 7473 2e73  dencies if dts.s
-0002d650: 7461 7465 203d 3d20 2265 7272 6564 225d  tate == "erred"]
-0002d660: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0002d670: 6572 7265 645f 6465 7073 3a0a 2020 2020  erred_deps:.    
-0002d680: 2020 2020 2020 2020 2020 2020 7374 6163              stac
-0002d690: 6b2e 6578 7465 6e64 2865 7272 6564 5f64  k.extend(erred_d
-0002d6a0: 6570 7329 0a20 2020 2020 2020 2020 2020  eps).           
-0002d6b0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0002d6c0: 2020 2020 2020 2072 6f6f 7473 2e61 7070         roots.app
-0002d6d0: 656e 6428 6b65 7929 0a0a 2020 2020 2020  end(key)..      
-0002d6e0: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
-0002d6f0: 733a 2052 6563 7320 3d20 7b6b 6579 3a20  s: Recs = {key: 
-0002d700: 2277 6169 7469 6e67 2220 666f 7220 6b65  "waiting" for ke
-0002d710: 7920 696e 2072 6f6f 7473 7d0a 2020 2020  y in roots}.    
-0002d720: 2020 2020 7365 6c66 2e74 7261 6e73 6974      self.transit
-0002d730: 696f 6e73 2872 6563 6f6d 6d65 6e64 6174  ions(recommendat
-0002d740: 696f 6e73 2c20 6622 7374 696d 756c 7573  ions, f"stimulus
-0002d750: 2d72 6574 7279 2d7b 7469 6d65 2829 7d22  -retry-{time()}"
-0002d760: 290a 0a20 2020 2020 2020 2069 6620 7365  )..        if se
-0002d770: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
-0002d780: 2020 2020 2020 2020 2066 6f72 206b 6579           for key
-0002d790: 2069 6e20 7365 656e 3a0a 2020 2020 2020   in seen:.      
-0002d7a0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0002d7b0: 206e 6f74 2073 656c 662e 7461 736b 735b   not self.tasks[
-0002d7c0: 6b65 795d 2e65 7863 6570 7469 6f6e 5f62  key].exception_b
-0002d7d0: 6c61 6d65 0a0a 2020 2020 2020 2020 7265  lame..        re
-0002d7e0: 7475 726e 2074 7570 6c65 2873 6565 6e29  turn tuple(seen)
-0002d7f0: 0a0a 2020 2020 6465 6620 636c 6f73 655f  ..    def close_
-0002d800: 776f 726b 6572 2873 656c 662c 2077 6f72  worker(self, wor
-0002d810: 6b65 723a 2073 7472 2920 2d3e 204e 6f6e  ker: str) -> Non
-0002d820: 653a 0a20 2020 2020 2020 2022 2222 4173  e:.        """As
-0002d830: 6b20 6120 776f 726b 6572 2074 6f20 7368  k a worker to sh
-0002d840: 7574 2069 7473 656c 6620 646f 776e 2e20  ut itself down. 
-0002d850: 446f 206e 6f74 2077 6169 7420 666f 7220  Do not wait for 
-0002d860: 6974 2074 6f20 7461 6b65 2065 6666 6563  it to take effec
-0002d870: 742e 0a20 2020 2020 2020 204e 6f74 6520  t..        Note 
-0002d880: 7468 6174 2074 6865 7265 2069 7320 6e6f  that there is no
-0002d890: 2067 7561 7261 6e74 6565 2074 6861 7420   guarantee that 
-0002d8a0: 7468 6520 776f 726b 6572 2077 696c 6c20  the worker will 
-0002d8b0: 6163 7475 616c 6c79 2061 6363 6570 7420  actually accept 
-0002d8c0: 7468 650a 2020 2020 2020 2020 636f 6d6d  the.        comm
-0002d8d0: 616e 642e 0a0a 2020 2020 2020 2020 4e6f  and...        No
-0002d8e0: 7465 2074 6861 7420 3a6d 6574 683a 6072  te that :meth:`r
-0002d8f0: 656d 6f76 655f 776f 726b 6572 6020 7365  emove_worker` se
-0002d900: 6e64 7320 7468 6520 7361 6d65 2063 6f6d  nds the same com
-0002d910: 6d61 6e64 2069 6e74 6572 6e61 6c6c 7920  mand internally 
-0002d920: 6966 2063 6c6f 7365 3d54 7275 652e 0a0a  if close=True...
-0002d930: 2020 2020 2020 2020 5365 6520 616c 736f          See also
-0002d940: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
-0002d950: 2d0a 2020 2020 2020 2020 7265 7469 7265  -.        retire
-0002d960: 5f77 6f72 6b65 7273 0a20 2020 2020 2020  _workers.       
-0002d970: 2072 656d 6f76 655f 776f 726b 6572 0a20   remove_worker. 
-0002d980: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0002d990: 2020 2069 6620 776f 726b 6572 206e 6f74     if worker not
-0002d9a0: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
-0002d9b0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0002d9c0: 7475 726e 0a0a 2020 2020 2020 2020 6c6f  turn..        lo
-0002d9d0: 6767 6572 2e69 6e66 6f28 2243 6c6f 7369  gger.info("Closi
-0002d9e0: 6e67 2077 6f72 6b65 7220 2573 222c 2077  ng worker %s", w
-0002d9f0: 6f72 6b65 7229 0a20 2020 2020 2020 2073  orker).        s
-0002da00: 656c 662e 6c6f 675f 6576 656e 7428 776f  elf.log_event(wo
-0002da10: 726b 6572 2c20 7b22 6163 7469 6f6e 223a  rker, {"action":
-0002da20: 2022 636c 6f73 652d 776f 726b 6572 227d   "close-worker"}
-0002da30: 290a 2020 2020 2020 2020 7365 6c66 2e77  ).        self.w
-0002da40: 6f72 6b65 725f 7365 6e64 2877 6f72 6b65  orker_send(worke
-0002da50: 722c 207b 226f 7022 3a20 2263 6c6f 7365  r, {"op": "close
-0002da60: 222c 2022 7265 6173 6f6e 223a 2022 7363  ", "reason": "sc
-0002da70: 6865 6475 6c65 722d 636c 6f73 652d 776f  heduler-close-wo
-0002da80: 726b 6572 227d 290a 0a20 2020 2040 6c6f  rker"})..    @lo
-0002da90: 675f 6572 726f 7273 0a20 2020 2061 7379  g_errors.    asy
-0002daa0: 6e63 2064 6566 2072 656d 6f76 655f 776f  nc def remove_wo
-0002dab0: 726b 6572 280a 2020 2020 2020 2020 7365  rker(.        se
-0002dac0: 6c66 2c20 6164 6472 6573 733a 2073 7472  lf, address: str
-0002dad0: 2c20 2a2c 2073 7469 6d75 6c75 735f 6964  , *, stimulus_id
-0002dae0: 3a20 7374 722c 2073 6166 653a 2062 6f6f  : str, safe: boo
-0002daf0: 6c20 3d20 4661 6c73 652c 2063 6c6f 7365  l = False, close
-0002db00: 3a20 626f 6f6c 203d 2054 7275 650a 2020  : bool = True.  
-0002db10: 2020 2920 2d3e 204c 6974 6572 616c 5b22    ) -> Literal["
-0002db20: 4f4b 222c 2022 616c 7265 6164 792d 7265  OK", "already-re
-0002db30: 6d6f 7665 6422 5d3a 0a20 2020 2020 2020  moved"]:.       
-0002db40: 2022 2222 5265 6d6f 7665 2077 6f72 6b65   """Remove worke
-0002db50: 7220 6672 6f6d 2063 6c75 7374 6572 2e0a  r from cluster..
-0002db60: 0a20 2020 2020 2020 2057 6520 646f 2074  .        We do t
-0002db70: 6869 7320 7768 656e 2061 2077 6f72 6b65  his when a worke
-0002db80: 7220 7265 706f 7274 7320 7468 6174 2069  r reports that i
-0002db90: 7420 706c 616e 7320 746f 206c 6561 7665  t plans to leave
-0002dba0: 206f 7220 7768 656e 2069 7420 6170 7065   or when it appe
-0002dbb0: 6172 7320 746f 2062 650a 2020 2020 2020  ars to be.      
-0002dbc0: 2020 756e 7265 7370 6f6e 7369 7665 2e20    unresponsive. 
-0002dbd0: 5468 6973 206d 6179 2073 656e 6420 6974  This may send it
-0002dbe0: 7320 7461 736b 7320 6261 636b 2074 6f20  s tasks back to 
-0002dbf0: 6120 7265 6c65 6173 6564 2073 7461 7465  a released state
-0002dc00: 2e0a 0a20 2020 2020 2020 2053 6565 2061  ...        See a
-0002dc10: 6c73 6f0a 2020 2020 2020 2020 2d2d 2d2d  lso.        ----
-0002dc20: 2d2d 2d2d 0a20 2020 2020 2020 2072 6574  ----.        ret
-0002dc30: 6972 655f 776f 726b 6572 730a 2020 2020  ire_workers.    
-0002dc40: 2020 2020 636c 6f73 655f 776f 726b 6572      close_worker
-0002dc50: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0002dc60: 2020 2020 2069 6620 7365 6c66 2e73 7461       if self.sta
-0002dc70: 7475 7320 3d3d 2053 7461 7475 732e 636c  tus == Status.cl
-0002dc80: 6f73 6564 3a0a 2020 2020 2020 2020 2020  osed:.          
-0002dc90: 2020 7265 7475 726e 2022 616c 7265 6164    return "alread
-0002dca0: 792d 7265 6d6f 7665 6422 0a0a 2020 2020  y-removed"..    
-0002dcb0: 2020 2020 6164 6472 6573 7320 3d20 7365      address = se
-0002dcc0: 6c66 2e63 6f65 7263 655f 6164 6472 6573  lf.coerce_addres
-0002dcd0: 7328 6164 6472 6573 7329 0a0a 2020 2020  s(address)..    
-0002dce0: 2020 2020 6966 2061 6464 7265 7373 206e      if address n
-0002dcf0: 6f74 2069 6e20 7365 6c66 2e77 6f72 6b65  ot in self.worke
-0002dd00: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
-0002dd10: 7265 7475 726e 2022 616c 7265 6164 792d  return "already-
-0002dd20: 7265 6d6f 7665 6422 0a0a 2020 2020 2020  removed"..      
-0002dd30: 2020 686f 7374 203d 2067 6574 5f61 6464    host = get_add
-0002dd40: 7265 7373 5f68 6f73 7428 6164 6472 6573  ress_host(addres
-0002dd50: 7329 0a0a 2020 2020 2020 2020 7773 203d  s)..        ws =
-0002dd60: 2073 656c 662e 776f 726b 6572 735b 6164   self.workers[ad
-0002dd70: 6472 6573 735d 0a0a 2020 2020 2020 2020  dress]..        
-0002dd80: 6c6f 6767 6572 2e69 6e66 6f28 6622 5265  logger.info(f"Re
-0002dd90: 6d6f 7665 2077 6f72 6b65 7220 7b77 737d  move worker {ws}
-0002dda0: 2028 7b73 7469 6d75 6c75 735f 6964 3d7d   ({stimulus_id=}
-0002ddb0: 2922 290a 2020 2020 2020 2020 6966 2063  )").        if c
-0002ddc0: 6c6f 7365 3a0a 2020 2020 2020 2020 2020  lose:.          
-0002ddd0: 2020 7769 7468 2073 7570 7072 6573 7328    with suppress(
-0002dde0: 4174 7472 6962 7574 6545 7272 6f72 2c20  AttributeError, 
-0002ddf0: 436f 6d6d 436c 6f73 6564 4572 726f 7229  CommClosedError)
-0002de00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002de10: 2020 7365 6c66 2e73 7472 6561 6d5f 636f    self.stream_co
-0002de20: 6d6d 735b 6164 6472 6573 735d 2e73 656e  mms[address].sen
-0002de30: 6428 0a20 2020 2020 2020 2020 2020 2020  d(.             
-0002de40: 2020 2020 2020 207b 226f 7022 3a20 2263         {"op": "c
-0002de50: 6c6f 7365 222c 2022 7265 6173 6f6e 223a  lose", "reason":
-0002de60: 2022 7363 6865 6475 6c65 722d 7265 6d6f   "scheduler-remo
-0002de70: 7665 2d77 6f72 6b65 7222 7d0a 2020 2020  ve-worker"}.    
-0002de80: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-0002de90: 2020 2020 2020 2073 656c 662e 7265 6d6f         self.remo
-0002dea0: 7665 5f72 6573 6f75 7263 6573 2861 6464  ve_resources(add
-0002deb0: 7265 7373 290a 0a20 2020 2020 2020 2064  ress)..        d
-0002dec0: 6820 3d20 7365 6c66 2e68 6f73 745f 696e  h = self.host_in
-0002ded0: 666f 5b68 6f73 745d 0a20 2020 2020 2020  fo[host].       
-0002dee0: 2064 685f 6164 6472 6573 7365 733a 2073   dh_addresses: s
-0002def0: 6574 203d 2064 685b 2261 6464 7265 7373  et = dh["address
-0002df00: 6573 225d 0a20 2020 2020 2020 2064 685f  es"].        dh_
-0002df10: 6164 6472 6573 7365 732e 7265 6d6f 7665  addresses.remove
-0002df20: 2861 6464 7265 7373 290a 2020 2020 2020  (address).      
-0002df30: 2020 6468 5b22 6e74 6872 6561 6473 225d    dh["nthreads"]
-0002df40: 202d 3d20 7773 2e6e 7468 7265 6164 730a   -= ws.nthreads.
-0002df50: 2020 2020 2020 2020 7365 6c66 2e74 6f74          self.tot
-0002df60: 616c 5f6e 7468 7265 6164 7320 2d3d 2077  al_nthreads -= w
-0002df70: 732e 6e74 6872 6561 6473 0a20 2020 2020  s.nthreads.     
-0002df80: 2020 2073 656c 662e 746f 7461 6c5f 6e74     self.total_nt
-0002df90: 6872 6561 6473 5f68 6973 746f 7279 2e61  hreads_history.a
-0002dfa0: 7070 656e 6428 2874 696d 6528 292c 2073  ppend((time(), s
-0002dfb0: 656c 662e 746f 7461 6c5f 6e74 6872 6561  elf.total_nthrea
-0002dfc0: 6473 2929 0a20 2020 2020 2020 2069 6620  ds)).        if 
-0002dfd0: 6e6f 7420 6468 5f61 6464 7265 7373 6573  not dh_addresses
-0002dfe0: 3a0a 2020 2020 2020 2020 2020 2020 6465  :.            de
-0002dff0: 6c20 7365 6c66 2e68 6f73 745f 696e 666f  l self.host_info
-0002e000: 5b68 6f73 745d 0a0a 2020 2020 2020 2020  [host]..        
-0002e010: 7365 6c66 2e72 7063 2e72 656d 6f76 6528  self.rpc.remove(
-0002e020: 6164 6472 6573 7329 0a20 2020 2020 2020  address).       
-0002e030: 2064 656c 2073 656c 662e 7374 7265 616d   del self.stream
-0002e040: 5f63 6f6d 6d73 5b61 6464 7265 7373 5d0a  _comms[address].
-0002e050: 2020 2020 2020 2020 6465 6c20 7365 6c66          del self
-0002e060: 2e61 6c69 6173 6573 5b77 732e 6e61 6d65  .aliases[ws.name
-0002e070: 5d0a 2020 2020 2020 2020 7365 6c66 2e69  ].        self.i
-0002e080: 646c 652e 706f 7028 7773 2e61 6464 7265  dle.pop(ws.addre
-0002e090: 7373 2c20 4e6f 6e65 290a 2020 2020 2020  ss, None).      
-0002e0a0: 2020 7365 6c66 2e69 646c 655f 7461 736b    self.idle_task
-0002e0b0: 5f63 6f75 6e74 2e64 6973 6361 7264 2877  _count.discard(w
-0002e0c0: 7329 0a20 2020 2020 2020 2073 656c 662e  s).        self.
-0002e0d0: 7361 7475 7261 7465 642e 6469 7363 6172  saturated.discar
-0002e0e0: 6428 7773 290a 2020 2020 2020 2020 6465  d(ws).        de
-0002e0f0: 6c20 7365 6c66 2e77 6f72 6b65 7273 5b61  l self.workers[a
-0002e100: 6464 7265 7373 5d0a 2020 2020 2020 2020  ddress].        
-0002e110: 7773 2e73 7461 7475 7320 3d20 5374 6174  ws.status = Stat
-0002e120: 7573 2e63 6c6f 7365 640a 2020 2020 2020  us.closed.      
-0002e130: 2020 7365 6c66 2e72 756e 6e69 6e67 2e64    self.running.d
-0002e140: 6973 6361 7264 2877 7329 0a0a 2020 2020  iscard(ws)..    
-0002e150: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
-0002e160: 6f6e 733a 2052 6563 7320 3d20 7b7d 0a0a  ons: Recs = {}..
-0002e170: 2020 2020 2020 2020 7072 6f63 6573 7369          processi
-0002e180: 6e67 5f6b 6579 7320 3d20 7b74 732e 6b65  ng_keys = {ts.ke
-0002e190: 7920 666f 7220 7473 2069 6e20 7773 2e70  y for ts in ws.p
-0002e1a0: 726f 6365 7373 696e 677d 0a20 2020 2020  rocessing}.     
-0002e1b0: 2020 2066 6f72 2074 7320 696e 206c 6973     for ts in lis
-0002e1c0: 7428 7773 2e70 726f 6365 7373 696e 6729  t(ws.processing)
-0002e1d0: 3a0a 2020 2020 2020 2020 2020 2020 6b20  :.            k 
-0002e1e0: 3d20 7473 2e6b 6579 0a20 2020 2020 2020  = ts.key.       
-0002e1f0: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
-0002e200: 696f 6e73 5b6b 5d20 3d20 2272 656c 6561  ions[k] = "relea
-0002e210: 7365 6422 0a20 2020 2020 2020 2020 2020  sed".           
-0002e220: 2069 6620 6e6f 7420 7361 6665 3a0a 2020   if not safe:.  
-0002e230: 2020 2020 2020 2020 2020 2020 2020 7473                ts
-0002e240: 2e73 7573 7069 6369 6f75 7320 2b3d 2031  .suspicious += 1
-0002e250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002e260: 2074 732e 7072 6566 6978 2e73 7573 7069   ts.prefix.suspi
-0002e270: 6369 6f75 7320 2b3d 2031 0a20 2020 2020  cious += 1.     
-0002e280: 2020 2020 2020 2020 2020 2069 6620 7473             if ts
-0002e290: 2e73 7573 7069 6369 6f75 7320 3e20 7365  .suspicious > se
-0002e2a0: 6c66 2e61 6c6c 6f77 6564 5f66 6169 6c75  lf.allowed_failu
-0002e2b0: 7265 733a 0a20 2020 2020 2020 2020 2020  res:.           
-0002e2c0: 2020 2020 2020 2020 2064 656c 2072 6563           del rec
-0002e2d0: 6f6d 6d65 6e64 6174 696f 6e73 5b6b 5d0a  ommendations[k].
-0002e2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e2f0: 2020 2020 6520 3d20 7069 636b 6c65 2e64      e = pickle.d
-0002e300: 756d 7073 280a 2020 2020 2020 2020 2020  umps(.          
-0002e310: 2020 2020 2020 2020 2020 2020 2020 4b69                Ki
-0002e320: 6c6c 6564 576f 726b 6572 280a 2020 2020  lledWorker(.    
-0002e330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e340: 2020 2020 2020 2020 7461 736b 3d6b 2c0a          task=k,.
-0002e350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e360: 2020 2020 2020 2020 2020 2020 6c61 7374              last
-0002e370: 5f77 6f72 6b65 723d 7773 2e63 6c65 616e  _worker=ws.clean
-0002e380: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
-0002e390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e3a0: 616c 6c6f 7765 645f 6661 696c 7572 6573  allowed_failures
-0002e3b0: 3d73 656c 662e 616c 6c6f 7765 645f 6661  =self.allowed_fa
-0002e3c0: 696c 7572 6573 2c0a 2020 2020 2020 2020  ilures,.        
-0002e3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e3e0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-0002e3f0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0002e400: 2020 2020 2020 2020 2020 2020 2072 203d               r =
-0002e410: 2073 656c 662e 7472 616e 7369 7469 6f6e   self.transition
-0002e420: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0002e430: 2020 2020 2020 2020 2020 6b2c 0a20 2020            k,.   
-0002e440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e450: 2020 2020 2022 6572 7265 6422 2c0a 2020       "erred",.  
-0002e460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e470: 2020 2020 2020 6578 6365 7074 696f 6e3d        exception=
-0002e480: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0002e490: 2020 2020 2020 2020 2020 2063 6175 7365             cause
-0002e4a0: 3d6b 2c0a 2020 2020 2020 2020 2020 2020  =k,.            
-0002e4b0: 2020 2020 2020 2020 2020 2020 7374 696d              stim
-0002e4c0: 756c 7573 5f69 643d 7374 696d 756c 7573  ulus_id=stimulus
-0002e4d0: 5f69 642c 0a20 2020 2020 2020 2020 2020  _id,.           
-0002e4e0: 2020 2020 2020 2020 2020 2020 2077 6f72               wor
-0002e4f0: 6b65 723d 6164 6472 6573 732c 0a20 2020  ker=address,.   
+0002b5b0: 2020 6966 2077 6f72 6b65 725f 7265 7374    if worker_rest
+0002b5c0: 7269 6374 696f 6e73 3a0a 2020 2020 2020  rictions:.      
+0002b5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b5e0: 2020 7473 2e77 6f72 6b65 725f 7265 7374    ts.worker_rest
+0002b5f0: 7269 6374 696f 6e73 203d 2077 6f72 6b65  rictions = worke
+0002b600: 725f 7265 7374 7269 6374 696f 6e73 0a20  r_restrictions. 
+0002b610: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0002b620: 6c69 6620 616e 6e6f 7420 696e 2028 226c  lif annot in ("l
+0002b630: 6f6f 7365 5f72 6573 7472 6963 7469 6f6e  oose_restriction
+0002b640: 7322 2c20 2261 6c6c 6f77 5f6f 7468 6572  s", "allow_other
+0002b650: 5f77 6f72 6b65 7273 2229 3a0a 2020 2020  _workers"):.    
+0002b660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b670: 7473 2e6c 6f6f 7365 5f72 6573 7472 6963  ts.loose_restric
+0002b680: 7469 6f6e 7320 3d20 7661 6c75 650a 2020  tions = value.  
+0002b690: 2020 2020 2020 2020 2020 2020 2020 656c                el
+0002b6a0: 6966 2061 6e6e 6f74 203d 3d20 2272 6573  if annot == "res
+0002b6b0: 6f75 7263 6573 223a 0a20 2020 2020 2020  ources":.       
+0002b6c0: 2020 2020 2020 2020 2020 2020 2061 7373               ass
+0002b6d0: 6572 7420 6973 696e 7374 616e 6365 2876  ert isinstance(v
+0002b6e0: 616c 7565 2c20 6469 6374 290a 2020 2020  alue, dict).    
+0002b6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b700: 7473 2e72 6573 6f75 7263 655f 7265 7374  ts.resource_rest
+0002b710: 7269 6374 696f 6e73 203d 2076 616c 7565  rictions = value
+0002b720: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002b730: 2065 6c69 6620 616e 6e6f 7420 3d3d 2022   elif annot == "
+0002b740: 7072 696f 7269 7479 223a 0a20 2020 2020  priority":.     
+0002b750: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0002b760: 2053 6565 2053 6368 6564 756c 6572 2e5f   See Scheduler._
+0002b770: 7365 745f 7072 696f 7269 7469 6573 0a20  set_priorities. 
+0002b780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b790: 2020 2063 6f6e 7469 6e75 650a 2020 2020     continue.    
+0002b7a0: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+0002b7b0: 2061 6e6e 6f74 203d 3d20 2272 6574 7269   annot == "retri
+0002b7c0: 6573 223a 0a20 2020 2020 2020 2020 2020  es":.           
+0002b7d0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+0002b7e0: 6973 696e 7374 616e 6365 2876 616c 7565  isinstance(value
+0002b7f0: 2c20 696e 7429 0a20 2020 2020 2020 2020  , int).         
+0002b800: 2020 2020 2020 2020 2020 2074 732e 7265             ts.re
+0002b810: 7472 6965 7320 3d20 7661 6c75 650a 2020  tries = value.  
+0002b820: 2020 2020 2020 7265 7475 726e 206b 6579        return key
+0002b830: 735f 7769 7468 5f61 6e6e 6f74 6174 696f  s_with_annotatio
+0002b840: 6e73 0a0a 2020 2020 6465 6620 5f73 6574  ns..    def _set
+0002b850: 5f70 7269 6f72 6974 6965 7328 0a20 2020  _priorities(.   
+0002b860: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+0002b870: 2020 2069 6e74 6572 6e61 6c5f 7072 696f     internal_prio
+0002b880: 7269 7479 3a20 6469 6374 5b4b 6579 2c20  rity: dict[Key, 
+0002b890: 696e 745d 2c0a 2020 2020 2020 2020 7375  int],.        su
+0002b8a0: 626d 6974 7469 6e67 5f74 6173 6b3a 204b  bmitting_task: K
+0002b8b0: 6579 207c 204e 6f6e 652c 0a20 2020 2020  ey | None,.     
+0002b8c0: 2020 2075 7365 725f 7072 696f 7269 7479     user_priority
+0002b8d0: 3a20 696e 7420 7c20 6469 6374 5b4b 6579  : int | dict[Key
+0002b8e0: 2c20 696e 745d 2c0a 2020 2020 2020 2020  , int],.        
+0002b8f0: 6669 666f 5f74 696d 656f 7574 3a20 696e  fifo_timeout: in
+0002b900: 7420 7c20 666c 6f61 7420 7c20 7374 722c  t | float | str,
+0002b910: 0a20 2020 2020 2020 2073 7461 7274 3a20  .        start: 
+0002b920: 666c 6f61 742c 0a20 2020 2020 2020 2074  float,.        t
+0002b930: 6173 6b73 3a20 6c69 7374 5b54 6173 6b53  asks: list[TaskS
+0002b940: 7461 7465 5d2c 0a20 2020 2029 202d 3e20  tate],.    ) -> 
+0002b950: 4e6f 6e65 3a0a 2020 2020 2020 2020 6669  None:.        fi
+0002b960: 666f 5f74 696d 656f 7574 203d 2070 6172  fo_timeout = par
+0002b970: 7365 5f74 696d 6564 656c 7461 2866 6966  se_timedelta(fif
+0002b980: 6f5f 7469 6d65 6f75 7429 0a20 2020 2020  o_timeout).     
+0002b990: 2020 2069 6620 7375 626d 6974 7469 6e67     if submitting
+0002b9a0: 5f74 6173 6b3a 2020 2320 7375 622d 7461  _task:  # sub-ta
+0002b9b0: 736b 7320 6765 7420 6265 7474 6572 2070  sks get better p
+0002b9c0: 7269 6f72 6974 7920 7468 616e 2070 6172  riority than par
+0002b9d0: 656e 7420 7461 736b 730a 2020 2020 2020  ent tasks.      
+0002b9e0: 2020 2020 2020 7374 7320 3d20 7365 6c66        sts = self
+0002b9f0: 2e74 6173 6b73 2e67 6574 2873 7562 6d69  .tasks.get(submi
+0002ba00: 7474 696e 675f 7461 736b 290a 2020 2020  tting_task).    
+0002ba10: 2020 2020 2020 2020 6966 2073 7473 2069          if sts i
+0002ba20: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+0002ba30: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+0002ba40: 7274 2073 7473 2e70 7269 6f72 6974 790a  rt sts.priority.
+0002ba50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ba60: 6765 6e65 7261 7469 6f6e 203d 2073 7473  generation = sts
+0002ba70: 2e70 7269 6f72 6974 795b 305d 202d 2030  .priority[0] - 0
+0002ba80: 2e30 310a 2020 2020 2020 2020 2020 2020  .01.            
+0002ba90: 656c 7365 3a20 2023 2073 7570 6572 2d74  else:  # super-t
+0002baa0: 6173 6b20 616c 7265 6164 7920 636c 6561  ask already clea
+0002bab0: 6e65 6420 7570 0a20 2020 2020 2020 2020  ned up.         
+0002bac0: 2020 2020 2020 2067 656e 6572 6174 696f         generatio
+0002bad0: 6e20 3d20 7365 6c66 2e67 656e 6572 6174  n = self.generat
+0002bae0: 696f 6e0a 2020 2020 2020 2020 656c 6966  ion.        elif
+0002baf0: 2073 656c 662e 5f6c 6173 745f 7469 6d65   self._last_time
+0002bb00: 202b 2066 6966 6f5f 7469 6d65 6f75 7420   + fifo_timeout 
+0002bb10: 3c20 7374 6172 743a 0a20 2020 2020 2020  < start:.       
+0002bb20: 2020 2020 2073 656c 662e 6765 6e65 7261       self.genera
+0002bb30: 7469 6f6e 202b 3d20 3120 2023 206f 6c64  tion += 1  # old
+0002bb40: 6572 2067 7261 7068 2067 656e 6572 6174  er graph generat
+0002bb50: 696f 6e73 2074 616b 6520 7072 6563 6564  ions take preced
+0002bb60: 656e 6365 0a20 2020 2020 2020 2020 2020  ence.           
+0002bb70: 2067 656e 6572 6174 696f 6e20 3d20 7365   generation = se
+0002bb80: 6c66 2e67 656e 6572 6174 696f 6e0a 2020  lf.generation.  
+0002bb90: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+0002bba0: 6c61 7374 5f74 696d 6520 3d20 7374 6172  last_time = star
+0002bbb0: 740a 2020 2020 2020 2020 656c 7365 3a0a  t.        else:.
+0002bbc0: 2020 2020 2020 2020 2020 2020 6765 6e65              gene
+0002bbd0: 7261 7469 6f6e 203d 2073 656c 662e 6765  ration = self.ge
+0002bbe0: 6e65 7261 7469 6f6e 0a0a 2020 2020 2020  neration..      
+0002bbf0: 2020 666f 7220 7473 2069 6e20 7461 736b    for ts in task
+0002bc00: 733a 0a20 2020 2020 2020 2020 2020 2069  s:.            i
+0002bc10: 6620 6973 696e 7374 616e 6365 2875 7365  f isinstance(use
+0002bc20: 725f 7072 696f 7269 7479 2c20 6469 6374  r_priority, dict
+0002bc30: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0002bc40: 2020 2074 6173 6b5f 7573 6572 5f70 7269     task_user_pri
+0002bc50: 6f20 3d20 7573 6572 5f70 7269 6f72 6974  o = user_priorit
+0002bc60: 792e 6765 7428 7473 2e6b 6579 2c20 3029  y.get(ts.key, 0)
+0002bc70: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+0002bc80: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0002bc90: 2020 2074 6173 6b5f 7573 6572 5f70 7269     task_user_pri
+0002bca0: 6f20 3d20 7573 6572 5f70 7269 6f72 6974  o = user_priorit
+0002bcb0: 790a 2020 2020 2020 2020 2020 2020 2320  y.            # 
+0002bcc0: 416e 6e6f 7461 7469 6f6e 7320 7468 6174  Annotations that
+0002bcd0: 2061 7265 2061 6c72 6561 6479 2061 7373   are already ass
+0002bce0: 6967 6e65 6420 746f 2074 6865 2054 6173  igned to the Tas
+0002bcf0: 6b53 7461 7465 206f 626a 6563 740a 2020  kState object.  
+0002bd00: 2020 2020 2020 2020 2020 2320 6f72 6967            # orig
+0002bd10: 696e 6174 6520 6672 6f6d 2061 204c 6179  inate from a Lay
+0002bd20: 6572 2061 6e6e 6f74 6174 696f 6e20 7768  er annotation wh
+0002bd30: 6963 6820 7461 6b65 7320 7072 6563 6564  ich takes preced
+0002bd40: 656e 6365 206f 7665 7220 7468 650a 2020  ence over the.  
+0002bd50: 2020 2020 2020 2020 2020 2320 676c 6f62            # glob
+0002bd60: 616c 2061 6e6e 6f74 6174 696f 6e2e 0a20  al annotation.. 
+0002bd70: 2020 2020 2020 2020 2020 2069 6620 7473             if ts
+0002bd80: 2e61 6e6e 6f74 6174 696f 6e73 3a0a 2020  .annotations:.  
+0002bd90: 2020 2020 2020 2020 2020 2020 2020 616e                an
+0002bda0: 6e6f 7461 7465 645f 7072 696f 203d 2074  notated_prio = t
+0002bdb0: 732e 616e 6e6f 7461 7469 6f6e 732e 6765  s.annotations.ge
+0002bdc0: 7428 2270 7269 6f72 6974 7922 2c20 7461  t("priority", ta
+0002bdd0: 736b 5f75 7365 725f 7072 696f 290a 2020  sk_user_prio).  
+0002bde0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0002bdf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002be00: 616e 6e6f 7461 7465 645f 7072 696f 203d  annotated_prio =
+0002be10: 2074 6173 6b5f 7573 6572 5f70 7269 6f0a   task_user_prio.
+0002be20: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0002be30: 6e6f 7420 7473 2e70 7269 6f72 6974 7920  not ts.priority 
+0002be40: 616e 6420 7473 2e6b 6579 2069 6e20 696e  and ts.key in in
+0002be50: 7465 726e 616c 5f70 7269 6f72 6974 793a  ternal_priority:
+0002be60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002be70: 2074 732e 7072 696f 7269 7479 203d 2028   ts.priority = (
+0002be80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002be90: 2020 2020 202d 616e 6e6f 7461 7465 645f       -annotated_
+0002bea0: 7072 696f 2c0a 2020 2020 2020 2020 2020  prio,.          
+0002beb0: 2020 2020 2020 2020 2020 6765 6e65 7261            genera
+0002bec0: 7469 6f6e 2c0a 2020 2020 2020 2020 2020  tion,.          
+0002bed0: 2020 2020 2020 2020 2020 696e 7465 726e            intern
+0002bee0: 616c 5f70 7269 6f72 6974 795b 7473 2e6b  al_priority[ts.k
+0002bef0: 6579 5d2c 0a20 2020 2020 2020 2020 2020  ey],.           
+0002bf00: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+0002bf10: 2020 2020 6966 2073 656c 662e 7661 6c69      if self.vali
+0002bf20: 6461 7465 2061 6e64 2074 732e 7275 6e5f  date and ts.run_
+0002bf30: 7370 6563 3a0a 2020 2020 2020 2020 2020  spec:.          
+0002bf40: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
+0002bf50: 6e73 7461 6e63 6528 7473 2e70 7269 6f72  nstance(ts.prior
+0002bf60: 6974 792c 2074 7570 6c65 2920 616e 6420  ity, tuple) and 
+0002bf70: 616c 6c28 0a20 2020 2020 2020 2020 2020  all(.           
+0002bf80: 2020 2020 2020 2020 2069 7369 6e73 7461           isinsta
+0002bf90: 6e63 6528 656c 2c20 2869 6e74 2c20 666c  nce(el, (int, fl
+0002bfa0: 6f61 7429 2920 666f 7220 656c 2069 6e20  oat)) for el in 
+0002bfb0: 7473 2e70 7269 6f72 6974 790a 2020 2020  ts.priority.    
+0002bfc0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+0002bfd0: 2020 2064 6566 2073 7469 6d75 6c75 735f     def stimulus_
+0002bfe0: 7175 6575 655f 736c 6f74 735f 6d61 7962  queue_slots_mayb
+0002bff0: 655f 6f70 656e 6564 2873 656c 662c 202a  e_opened(self, *
+0002c000: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
+0002c010: 7472 2920 2d3e 204e 6f6e 653a 0a20 2020  tr) -> None:.   
+0002c020: 2020 2020 2022 2222 5265 7370 6f6e 6420       """Respond 
+0002c030: 746f 2061 6e20 6576 656e 7420 7768 6963  to an event whic
+0002c040: 6820 6d61 7920 6861 7665 206f 7065 6e65  h may have opene
+0002c050: 6420 7370 6f74 7320 6f6e 2077 6f72 6b65  d spots on worke
+0002c060: 7220 7468 7265 6164 706f 6f6c 730a 0a20  r threadpools.. 
+0002c070: 2020 2020 2020 2053 656c 6563 7473 2074         Selects t
+0002c080: 6865 2061 7070 726f 7072 6961 7465 206e  he appropriate n
+0002c090: 756d 6265 7220 6f66 2074 6173 6b73 2066  umber of tasks f
+0002c0a0: 726f 6d20 7468 6520 6672 6f6e 7420 6f66  rom the front of
+0002c0b0: 2074 6865 2071 7565 7565 2061 6363 6f72   the queue accor
+0002c0c0: 6469 6e67 2074 6f0a 2020 2020 2020 2020  ding to.        
+0002c0d0: 7468 6520 746f 7461 6c20 6e75 6d62 6572  the total number
+0002c0e0: 206f 6620 7461 736b 2073 6c6f 7473 2061   of task slots a
+0002c0f0: 7661 696c 6162 6c65 206f 6e20 776f 726b  vailable on work
+0002c100: 6572 7320 2870 6f74 656e 7469 616c 6c79  ers (potentially
+0002c110: 2030 292c 2061 6e64 0a20 2020 2020 2020   0), and.       
+0002c120: 2074 7261 6e73 6974 696f 6e73 2074 6865   transitions the
+0002c130: 6d20 746f 2060 6070 726f 6365 7373 696e  m to ``processin
+0002c140: 6760 602e 0a0a 2020 2020 2020 2020 4e6f  g``...        No
+0002c150: 7465 730a 2020 2020 2020 2020 2d2d 2d2d  tes.        ----
+0002c160: 2d0a 2020 2020 2020 2020 4f74 6865 7220  -.        Other 
+0002c170: 7472 616e 7369 7469 6f6e 7320 7265 6c61  transitions rela
+0002c180: 7465 6420 746f 2074 6869 7320 7374 696d  ted to this stim
+0002c190: 756c 7573 2073 686f 756c 6420 6265 2066  ulus should be f
+0002c1a0: 756c 6c79 2070 726f 6365 7373 6564 2062  ully processed b
+0002c1b0: 6566 6f72 6568 616e 642c 0a20 2020 2020  eforehand,.     
+0002c1c0: 2020 2073 6f20 616e 7920 7461 736b 7320     so any tasks 
+0002c1d0: 7468 6174 2062 6563 616d 6520 7275 6e6e  that became runn
+0002c1e0: 6162 6c65 2061 7265 2061 6c72 6561 6479  able are already
+0002c1f0: 2069 6e20 6060 7072 6f63 6573 7369 6e67   in ``processing
+0002c200: 6060 2e20 4f74 6865 7277 6973 652c 0a20  ``. Otherwise,. 
+0002c210: 2020 2020 2020 206f 7665 7270 726f 6475         overprodu
+0002c220: 6374 696f 6e20 6361 6e20 6f63 6375 7220  ction can occur 
+0002c230: 6966 2071 7565 7565 6420 7461 736b 7320  if queued tasks 
+0002c240: 6765 7420 7363 6865 6475 6c65 6420 6265  get scheduled be
+0002c250: 666f 7265 2064 6f77 6e73 7472 6561 6d20  fore downstream 
+0002c260: 7461 736b 732e 0a0a 2020 2020 2020 2020  tasks...        
+0002c270: 4d75 7374 2062 6520 6361 6c6c 6564 2061  Must be called a
+0002c280: 6674 6572 2060 6368 6563 6b5f 6964 6c65  fter `check_idle
+0002c290: 5f73 6174 7572 6174 6564 603b 2069 2e65  _saturated`; i.e
+0002c2a0: 2e20 6069 646c 655f 7461 736b 5f63 6f75  . `idle_task_cou
+0002c2b0: 6e74 6020 6d75 7374 2062 6520 7570 2074  nt` must be up t
+0002c2c0: 6f20 6461 7465 2e0a 2020 2020 2020 2020  o date..        
+0002c2d0: 2222 220a 2020 2020 2020 2020 6966 206e  """.        if n
+0002c2e0: 6f74 2073 656c 662e 7175 6575 6564 3a0a  ot self.queued:.
+0002c2f0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0002c300: 726e 0a20 2020 2020 2020 2073 6c6f 7473  rn.        slots
+0002c310: 5f61 7661 696c 6162 6c65 203d 2073 756d  _available = sum
+0002c320: 280a 2020 2020 2020 2020 2020 2020 5f74  (.            _t
+0002c330: 6173 6b5f 736c 6f74 735f 6176 6169 6c61  ask_slots_availa
+0002c340: 626c 6528 7773 2c20 7365 6c66 2e57 4f52  ble(ws, self.WOR
+0002c350: 4b45 525f 5341 5455 5241 5449 4f4e 290a  KER_SATURATION).
+0002c360: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0002c370: 7773 2069 6e20 7365 6c66 2e69 646c 655f  ws in self.idle_
+0002c380: 7461 736b 5f63 6f75 6e74 0a20 2020 2020  task_count.     
+0002c390: 2020 2029 0a20 2020 2020 2020 2069 6620     ).        if 
+0002c3a0: 736c 6f74 735f 6176 6169 6c61 626c 6520  slots_available 
+0002c3b0: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
+0002c3c0: 2020 7265 7475 726e 0a0a 2020 2020 2020    return..      
+0002c3d0: 2020 666f 7220 5f20 696e 2072 616e 6765    for _ in range
+0002c3e0: 2873 6c6f 7473 5f61 7661 696c 6162 6c65  (slots_available
+0002c3f0: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
+0002c400: 6620 6e6f 7420 7365 6c66 2e71 7565 7565  f not self.queue
+0002c410: 643a 0a20 2020 2020 2020 2020 2020 2020  d:.             
+0002c420: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
+0002c430: 2020 2020 2020 2320 4964 6561 6c6c 792c        # Ideally,
+0002c440: 2077 6527 6420 6265 2070 6f70 7069 6e67   we'd be popping
+0002c450: 2069 7420 6865 7265 2061 6c72 6561 6479   it here already
+0002c460: 2062 7574 2074 6869 7320 776f 756c 6420   but this would 
+0002c470: 6272 6561 6b0a 2020 2020 2020 2020 2020  break.          
+0002c480: 2020 2320 6365 7274 6169 6e20 7374 6174    # certain stat
+0002c490: 6520 696e 7661 7269 616e 7473 2073 696e  e invariants sin
+0002c4a0: 6365 2074 6865 2074 6173 6b20 6973 206e  ce the task is n
+0002c4b0: 6f74 2074 7261 6e73 6974 696f 6e65 642c  ot transitioned,
+0002c4c0: 2079 6574 0a20 2020 2020 2020 2020 2020   yet.           
+0002c4d0: 2071 7473 203d 2073 656c 662e 7175 6575   qts = self.queu
+0002c4e0: 6564 2e70 6565 6b28 290a 2020 2020 2020  ed.peek().      
+0002c4f0: 2020 2020 2020 6966 2073 656c 662e 7661        if self.va
+0002c500: 6c69 6461 7465 3a0a 2020 2020 2020 2020  lidate:.        
+0002c510: 2020 2020 2020 2020 6173 7365 7274 2071          assert q
+0002c520: 7473 2e73 7461 7465 203d 3d20 2271 7565  ts.state == "que
+0002c530: 7565 6422 2c20 7174 732e 7374 6174 650a  ued", qts.state.
+0002c540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c550: 6173 7365 7274 206e 6f74 2071 7473 2e70  assert not qts.p
+0002c560: 726f 6365 7373 696e 675f 6f6e 2c20 2871  rocessing_on, (q
+0002c570: 7473 2c20 7174 732e 7072 6f63 6573 7369  ts, qts.processi
+0002c580: 6e67 5f6f 6e29 0a20 2020 2020 2020 2020  ng_on).         
+0002c590: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
+0002c5a0: 7420 7174 732e 7761 6974 696e 675f 6f6e  t qts.waiting_on
+0002c5b0: 2c20 2871 7473 2c20 7174 732e 7072 6f63  , (qts, qts.proc
+0002c5c0: 6573 7369 6e67 5f6f 6e29 0a20 2020 2020  essing_on).     
+0002c5d0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0002c5e0: 7420 7174 732e 7768 6f5f 7761 6e74 7320  t qts.who_wants 
+0002c5f0: 6f72 2071 7473 2e77 6169 7465 7273 2c20  or qts.waiters, 
+0002c600: 7174 730a 0a20 2020 2020 2020 2020 2020  qts..           
+0002c610: 2023 2054 6869 7320 7265 6d6f 7665 7320   # This removes 
+0002c620: 7468 6520 7461 736b 2066 726f 6d20 7468  the task from th
+0002c630: 6520 746f 7020 6f66 2074 6865 2073 656c  e top of the sel
+0002c640: 662e 7175 6575 6564 2068 6561 700a 2020  f.queued heap.  
+0002c650: 2020 2020 2020 2020 2020 7365 6c66 2e74            self.t
+0002c660: 7261 6e73 6974 696f 6e73 287b 7174 732e  ransitions({qts.
+0002c670: 6b65 793a 2022 7072 6f63 6573 7369 6e67  key: "processing
+0002c680: 227d 2c20 7374 696d 756c 7573 5f69 6429  "}, stimulus_id)
+0002c690: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0002c6a0: 7365 6c66 2e76 616c 6964 6174 653a 0a20  self.validate:. 
+0002c6b0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0002c6c0: 7373 6572 7420 7174 732e 7374 6174 6520  ssert qts.state 
+0002c6d0: 3d3d 2022 7072 6f63 6573 7369 6e67 220a  == "processing".
+0002c6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c6f0: 6173 7365 7274 206e 6f74 2073 656c 662e  assert not self.
+0002c700: 7175 6575 6564 206f 7220 7365 6c66 2e71  queued or self.q
+0002c710: 7565 7565 642e 7065 656b 2829 2021 3d20  ueued.peek() != 
+0002c720: 7174 730a 0a20 2020 2064 6566 2073 7469  qts..    def sti
+0002c730: 6d75 6c75 735f 7461 736b 5f66 696e 6973  mulus_task_finis
+0002c740: 6865 6428 0a20 2020 2020 2020 2073 656c  hed(.        sel
+0002c750: 662c 206b 6579 3a20 4b65 792c 2077 6f72  f, key: Key, wor
+0002c760: 6b65 723a 2073 7472 2c20 7374 696d 756c  ker: str, stimul
+0002c770: 7573 5f69 643a 2073 7472 2c20 7275 6e5f  us_id: str, run_
+0002c780: 6964 3a20 696e 742c 202a 2a6b 7761 7267  id: int, **kwarg
+0002c790: 733a 2041 6e79 0a20 2020 2029 202d 3e20  s: Any.    ) -> 
+0002c7a0: 5265 6373 4d73 6773 3a0a 2020 2020 2020  RecsMsgs:.      
+0002c7b0: 2020 2222 224d 6172 6b20 7468 6174 2061    """Mark that a
+0002c7c0: 2074 6173 6b20 6861 7320 6669 6e69 7368   task has finish
+0002c7d0: 6564 2065 7865 6375 7469 6f6e 206f 6e20  ed execution on 
+0002c7e0: 6120 7061 7274 6963 756c 6172 2077 6f72  a particular wor
+0002c7f0: 6b65 7222 2222 0a20 2020 2020 2020 206c  ker""".        l
+0002c800: 6f67 6765 722e 6465 6275 6728 2253 7469  ogger.debug("Sti
+0002c810: 6d75 6c75 7320 7461 736b 2066 696e 6973  mulus task finis
+0002c820: 6865 6420 2573 5b25 645d 2025 7322 2c20  hed %s[%d] %s", 
+0002c830: 6b65 792c 2072 756e 5f69 642c 2077 6f72  key, run_id, wor
+0002c840: 6b65 7229 0a0a 2020 2020 2020 2020 7265  ker)..        re
+0002c850: 636f 6d6d 656e 6461 7469 6f6e 733a 2052  commendations: R
+0002c860: 6563 7320 3d20 7b7d 0a20 2020 2020 2020  ecs = {}.       
+0002c870: 2063 6c69 656e 745f 6d73 6773 3a20 4d73   client_msgs: Ms
+0002c880: 6773 203d 207b 7d0a 2020 2020 2020 2020  gs = {}.        
+0002c890: 776f 726b 6572 5f6d 7367 733a 204d 7367  worker_msgs: Msg
+0002c8a0: 7320 3d20 7b7d 0a0a 2020 2020 2020 2020  s = {}..        
+0002c8b0: 7473 203d 2073 656c 662e 7461 736b 732e  ts = self.tasks.
+0002c8c0: 6765 7428 6b65 7929 0a20 2020 2020 2020  get(key).       
+0002c8d0: 2069 6620 7473 2069 7320 4e6f 6e65 206f   if ts is None o
+0002c8e0: 7220 7473 2e73 7461 7465 2069 6e20 2822  r ts.state in ("
+0002c8f0: 7265 6c65 6173 6564 222c 2022 7175 6575  released", "queu
+0002c900: 6564 222c 2022 6e6f 2d77 6f72 6b65 7222  ed", "no-worker"
+0002c910: 293a 0a20 2020 2020 2020 2020 2020 206c  ):.            l
+0002c920: 6f67 6765 722e 6465 6275 6728 0a20 2020  ogger.debug(.   
+0002c930: 2020 2020 2020 2020 2020 2020 2022 5265               "Re
+0002c940: 6365 6976 6564 2061 6c72 6561 6479 2063  ceived already c
+0002c950: 6f6d 7075 7465 6420 7461 736b 2c20 776f  omputed task, wo
+0002c960: 726b 6572 3a20 2573 2c20 7374 6174 653a  rker: %s, state:
+0002c970: 2025 7322 0a20 2020 2020 2020 2020 2020   %s".           
+0002c980: 2020 2020 2022 2c20 6b65 793a 2025 732c       ", key: %s,
+0002c990: 2077 686f 5f68 6173 3a20 2573 222c 0a20   who_has: %s",. 
+0002c9a0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+0002c9b0: 6f72 6b65 722c 0a20 2020 2020 2020 2020  orker,.         
+0002c9c0: 2020 2020 2020 2074 732e 7374 6174 6520         ts.state 
+0002c9d0: 6966 2074 7320 656c 7365 2022 666f 7267  if ts else "forg
+0002c9e0: 6f74 7465 6e22 2c0a 2020 2020 2020 2020  otten",.        
+0002c9f0: 2020 2020 2020 2020 6b65 792c 0a20 2020          key,.   
+0002ca00: 2020 2020 2020 2020 2020 2020 2074 732e               ts.
+0002ca10: 7768 6f5f 6861 7320 6966 2074 7320 656c  who_has if ts el
+0002ca20: 7365 207b 7d2c 0a20 2020 2020 2020 2020  se {},.         
+0002ca30: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0002ca40: 2077 6f72 6b65 725f 6d73 6773 5b77 6f72   worker_msgs[wor
+0002ca50: 6b65 725d 203d 205b 0a20 2020 2020 2020  ker] = [.       
+0002ca60: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+0002ca70: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0002ca80: 6f70 223a 2022 6672 6565 2d6b 6579 7322  op": "free-keys"
+0002ca90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002caa0: 2020 2020 2020 226b 6579 7322 3a20 5b6b        "keys": [k
+0002cab0: 6579 5d2c 0a20 2020 2020 2020 2020 2020  ey],.           
+0002cac0: 2020 2020 2020 2020 2022 7374 696d 756c           "stimul
+0002cad0: 7573 5f69 6422 3a20 7374 696d 756c 7573  us_id": stimulus
+0002cae0: 5f69 642c 0a20 2020 2020 2020 2020 2020  _id,.           
+0002caf0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+0002cb00: 2020 205d 0a20 2020 2020 2020 2065 6c69     ].        eli
+0002cb10: 6620 7473 2e73 7461 7465 203d 3d20 2265  f ts.state == "e
+0002cb20: 7272 6564 223a 0a20 2020 2020 2020 2020  rred":.         
+0002cb30: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
+0002cb40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002cb50: 2022 5265 6365 6976 6564 2061 6c72 6561   "Received alrea
+0002cb60: 6479 2065 7272 6564 2074 6173 6b2c 2077  dy erred task, w
+0002cb70: 6f72 6b65 723a 2025 7322 2022 2c20 6b65  orker: %s" ", ke
+0002cb80: 793a 2025 7322 2c0a 2020 2020 2020 2020  y: %s",.        
+0002cb90: 2020 2020 2020 2020 776f 726b 6572 2c0a          worker,.
+0002cba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cbb0: 6b65 792c 0a20 2020 2020 2020 2020 2020  key,.           
+0002cbc0: 2029 0a20 2020 2020 2020 2020 2020 2077   ).            w
+0002cbd0: 6f72 6b65 725f 6d73 6773 5b77 6f72 6b65  orker_msgs[worke
+0002cbe0: 725d 203d 205b 0a20 2020 2020 2020 2020  r] = [.         
+0002cbf0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+0002cc00: 2020 2020 2020 2020 2020 2020 2022 6f70               "op
+0002cc10: 223a 2022 6672 6565 2d6b 6579 7322 2c0a  ": "free-keys",.
+0002cc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cc30: 2020 2020 226b 6579 7322 3a20 5b6b 6579      "keys": [key
+0002cc40: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+0002cc50: 2020 2020 2020 2022 7374 696d 756c 7573         "stimulus
+0002cc60: 5f69 6422 3a20 7374 696d 756c 7573 5f69  _id": stimulus_i
+0002cc70: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+0002cc80: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+0002cc90: 205d 0a20 2020 2020 2020 2065 6c69 6620   ].        elif 
+0002cca0: 7473 2e72 756e 5f69 6420 213d 2072 756e  ts.run_id != run
+0002ccb0: 5f69 643a 0a20 2020 2020 2020 2020 2020  _id:.           
+0002ccc0: 2069 6620 6e6f 7420 7473 2e70 726f 6365   if not ts.proce
+0002ccd0: 7373 696e 675f 6f6e 206f 7220 7473 2e70  ssing_on or ts.p
+0002cce0: 726f 6365 7373 696e 675f 6f6e 2e61 6464  rocessing_on.add
+0002ccf0: 7265 7373 2021 3d20 776f 726b 6572 3a0a  ress != worker:.
+0002cd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cd10: 6c6f 6767 6572 2e64 6562 7567 280a 2020  logger.debug(.  
+0002cd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cd30: 2020 2252 6563 6569 7665 6420 7374 616c    "Received stal
+0002cd40: 6520 7461 736b 2072 756e 2c20 776f 726b  e task run, work
+0002cd50: 6572 3a20 2573 2c20 6b65 793a 2025 732c  er: %s, key: %s,
+0002cd60: 2072 756e 5f69 643a 2025 6420 2825 6429   run_id: %d (%d)
+0002cd70: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+0002cd80: 2020 2020 2020 2077 6f72 6b65 722c 0a20         worker,. 
+0002cd90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cda0: 2020 206b 6579 2c0a 2020 2020 2020 2020     key,.        
+0002cdb0: 2020 2020 2020 2020 2020 2020 7275 6e5f              run_
+0002cdc0: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
+0002cdd0: 2020 2020 2020 2020 7473 2e72 756e 5f69          ts.run_i
+0002cde0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+0002cdf0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0002ce00: 2020 2020 2077 6f72 6b65 725f 6d73 6773       worker_msgs
+0002ce10: 5b77 6f72 6b65 725d 203d 205b 0a20 2020  [worker] = [.   
+0002ce20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ce30: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0002ce40: 2020 2020 2020 2020 2020 2022 6f70 223a             "op":
+0002ce50: 2022 6672 6565 2d6b 6579 7322 2c0a 2020   "free-keys",.  
+0002ce60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ce70: 2020 2020 2020 226b 6579 7322 3a20 5b6b        "keys": [k
+0002ce80: 6579 5d2c 0a20 2020 2020 2020 2020 2020  ey],.           
+0002ce90: 2020 2020 2020 2020 2020 2020 2022 7374               "st
+0002cea0: 696d 756c 7573 5f69 6422 3a20 7374 696d  imulus_id": stim
+0002ceb0: 756c 7573 5f69 642c 0a20 2020 2020 2020  ulus_id,.       
+0002cec0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+0002ced0: 2020 2020 2020 2020 2020 2020 2020 205d                 ]
+0002cee0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+0002cef0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0002cf00: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
+0002cf10: 6e73 5b74 732e 6b65 795d 203d 2022 7265  ns[ts.key] = "re
+0002cf20: 6c65 6173 6564 220a 2020 2020 2020 2020  leased".        
+0002cf30: 656c 6966 2074 732e 7374 6174 6520 3d3d  elif ts.state ==
+0002cf40: 2022 6d65 6d6f 7279 223a 0a20 2020 2020   "memory":.     
+0002cf50: 2020 2020 2020 2073 656c 662e 6164 645f         self.add_
+0002cf60: 6b65 7973 2877 6f72 6b65 723d 776f 726b  keys(worker=work
+0002cf70: 6572 2c20 6b65 7973 3d5b 6b65 795d 290a  er, keys=[key]).
+0002cf80: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0002cf90: 2020 2020 2020 2020 2020 6966 206b 7761            if kwa
+0002cfa0: 7267 735b 226d 6574 6164 6174 6122 5d3a  rgs["metadata"]:
+0002cfb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002cfc0: 2069 6620 7473 2e6d 6574 6164 6174 6120   if ts.metadata 
+0002cfd0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+0002cfe0: 2020 2020 2020 2020 2020 2020 2074 732e               ts.
+0002cff0: 6d65 7461 6461 7461 203d 2064 6963 7428  metadata = dict(
+0002d000: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0002d010: 2020 7473 2e6d 6574 6164 6174 612e 7570    ts.metadata.up
+0002d020: 6461 7465 286b 7761 7267 735b 226d 6574  date(kwargs["met
+0002d030: 6164 6174 6122 5d29 0a20 2020 2020 2020  adata"]).       
+0002d040: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+0002d050: 2e5f 7472 616e 7369 7469 6f6e 286b 6579  ._transition(key
+0002d060: 2c20 226d 656d 6f72 7922 2c20 7374 696d  , "memory", stim
+0002d070: 756c 7573 5f69 642c 2077 6f72 6b65 723d  ulus_id, worker=
+0002d080: 776f 726b 6572 2c20 2a2a 6b77 6172 6773  worker, **kwargs
+0002d090: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+0002d0a0: 6e20 7265 636f 6d6d 656e 6461 7469 6f6e  n recommendation
+0002d0b0: 732c 2063 6c69 656e 745f 6d73 6773 2c20  s, client_msgs, 
+0002d0c0: 776f 726b 6572 5f6d 7367 730a 0a20 2020  worker_msgs..   
+0002d0d0: 2064 6566 2073 7469 6d75 6c75 735f 7461   def stimulus_ta
+0002d0e0: 736b 5f65 7272 6564 280a 2020 2020 2020  sk_erred(.      
+0002d0f0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+0002d100: 6b65 793d 4e6f 6e65 2c0a 2020 2020 2020  key=None,.      
+0002d110: 2020 776f 726b 6572 3d4e 6f6e 652c 0a20    worker=None,. 
+0002d120: 2020 2020 2020 2065 7863 6570 7469 6f6e         exception
+0002d130: 3d4e 6f6e 652c 0a20 2020 2020 2020 2073  =None,.        s
+0002d140: 7469 6d75 6c75 735f 6964 3d4e 6f6e 652c  timulus_id=None,
+0002d150: 0a20 2020 2020 2020 2074 7261 6365 6261  .        traceba
+0002d160: 636b 3d4e 6f6e 652c 0a20 2020 2020 2020  ck=None,.       
+0002d170: 2072 756e 5f69 643d 4e6f 6e65 2c0a 2020   run_id=None,.  
+0002d180: 2020 2020 2020 2a2a 6b77 6172 6773 2c0a        **kwargs,.
+0002d190: 2020 2020 293a 0a20 2020 2020 2020 2022      ):.        "
+0002d1a0: 2222 4d61 726b 2074 6861 7420 6120 7461  ""Mark that a ta
+0002d1b0: 736b 2068 6173 2065 7272 6564 206f 6e20  sk has erred on 
+0002d1c0: 6120 7061 7274 6963 756c 6172 2077 6f72  a particular wor
+0002d1d0: 6b65 7222 2222 0a20 2020 2020 2020 206c  ker""".        l
+0002d1e0: 6f67 6765 722e 6465 6275 6728 2253 7469  ogger.debug("Sti
+0002d1f0: 6d75 6c75 7320 7461 736b 2065 7272 6564  mulus task erred
+0002d200: 2025 732c 2025 7322 2c20 6b65 792c 2077   %s, %s", key, w
+0002d210: 6f72 6b65 7229 0a0a 2020 2020 2020 2020  orker)..        
+0002d220: 7473 203d 2073 656c 662e 7461 736b 732e  ts = self.tasks.
+0002d230: 6765 7428 6b65 7929 0a20 2020 2020 2020  get(key).       
+0002d240: 2069 6620 7473 2069 7320 4e6f 6e65 206f   if ts is None o
+0002d250: 7220 7473 2e73 7461 7465 2021 3d20 2270  r ts.state != "p
+0002d260: 726f 6365 7373 696e 6722 3a0a 2020 2020  rocessing":.    
+0002d270: 2020 2020 2020 2020 7265 7475 726e 207b          return {
+0002d280: 7d2c 207b 7d2c 207b 7d0a 0a20 2020 2020  }, {}, {}..     
+0002d290: 2020 2069 6620 7473 2e72 756e 5f69 6420     if ts.run_id 
+0002d2a0: 213d 2072 756e 5f69 643a 0a20 2020 2020  != run_id:.     
+0002d2b0: 2020 2020 2020 2069 6620 7473 2e70 726f         if ts.pro
+0002d2c0: 6365 7373 696e 675f 6f6e 2061 6e64 2074  cessing_on and t
+0002d2d0: 732e 7072 6f63 6573 7369 6e67 5f6f 6e2e  s.processing_on.
+0002d2e0: 6164 6472 6573 7320 3d3d 2077 6f72 6b65  address == worke
+0002d2f0: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
+0002d300: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
+0002d310: 7472 616e 7369 7469 6f6e 286b 6579 2c20  transition(key, 
+0002d320: 2272 656c 6561 7365 6422 2c20 7374 696d  "released", stim
+0002d330: 756c 7573 5f69 6429 0a20 2020 2020 2020  ulus_id).       
+0002d340: 2020 2020 2072 6574 7572 6e20 7b7d 2c20       return {}, 
+0002d350: 7b7d 2c20 7b7d 0a0a 2020 2020 2020 2020  {}, {}..        
+0002d360: 6966 2074 732e 7265 7472 6965 7320 3e20  if ts.retries > 
+0002d370: 303a 0a20 2020 2020 2020 2020 2020 2074  0:.            t
+0002d380: 732e 7265 7472 6965 7320 2d3d 2031 0a20  s.retries -= 1. 
+0002d390: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0002d3a0: 6e20 7365 6c66 2e5f 7472 616e 7369 7469  n self._transiti
+0002d3b0: 6f6e 286b 6579 2c20 2277 6169 7469 6e67  on(key, "waiting
+0002d3c0: 222c 2073 7469 6d75 6c75 735f 6964 290a  ", stimulus_id).
+0002d3d0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0002d3e0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0002d3f0: 2073 656c 662e 5f74 7261 6e73 6974 696f   self._transitio
+0002d400: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
+0002d410: 2020 206b 6579 2c0a 2020 2020 2020 2020     key,.        
+0002d420: 2020 2020 2020 2020 2265 7272 6564 222c          "erred",
+0002d430: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002d440: 2073 7469 6d75 6c75 735f 6964 2c0a 2020   stimulus_id,.  
+0002d450: 2020 2020 2020 2020 2020 2020 2020 6361                ca
+0002d460: 7573 653d 6b65 792c 0a20 2020 2020 2020  use=key,.       
+0002d470: 2020 2020 2020 2020 2065 7863 6570 7469           excepti
+0002d480: 6f6e 3d65 7863 6570 7469 6f6e 2c0a 2020  on=exception,.  
+0002d490: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+0002d4a0: 6163 6562 6163 6b3d 7472 6163 6562 6163  aceback=tracebac
+0002d4b0: 6b2c 0a20 2020 2020 2020 2020 2020 2020  k,.             
+0002d4c0: 2020 2077 6f72 6b65 723d 776f 726b 6572     worker=worker
+0002d4d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002d4e0: 2020 2a2a 6b77 6172 6773 2c0a 2020 2020    **kwargs,.    
+0002d4f0: 2020 2020 2020 2020 290a 0a20 2020 2064          )..    d
+0002d500: 6566 2073 7469 6d75 6c75 735f 7265 7472  ef stimulus_retr
+0002d510: 7928 0a20 2020 2020 2020 2073 656c 662c  y(.        self,
+0002d520: 206b 6579 733a 2043 6f6c 6c65 6374 696f   keys: Collectio
+0002d530: 6e5b 4b65 795d 2c20 636c 6965 6e74 3a20  n[Key], client: 
+0002d540: 7374 7220 7c20 4e6f 6e65 203d 204e 6f6e  str | None = Non
+0002d550: 650a 2020 2020 2920 2d3e 2074 7570 6c65  e.    ) -> tuple
+0002d560: 5b4b 6579 2c20 2e2e 2e5d 3a0a 2020 2020  [Key, ...]:.    
+0002d570: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
+0002d580: 2243 6c69 656e 7420 2573 2072 6571 7565  "Client %s reque
+0002d590: 7374 7320 746f 2072 6574 7279 2025 6420  sts to retry %d 
+0002d5a0: 6b65 7973 222c 2063 6c69 656e 742c 206c  keys", client, l
+0002d5b0: 656e 286b 6579 7329 290a 2020 2020 2020  en(keys)).      
+0002d5c0: 2020 6966 2063 6c69 656e 743a 0a20 2020    if client:.   
+0002d5d0: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
+0002d5e0: 675f 6576 656e 7428 636c 6965 6e74 2c20  g_event(client, 
+0002d5f0: 7b22 6163 7469 6f6e 223a 2022 7265 7472  {"action": "retr
+0002d600: 7922 2c20 2263 6f75 6e74 223a 206c 656e  y", "count": len
+0002d610: 286b 6579 7329 7d29 0a0a 2020 2020 2020  (keys)})..      
+0002d620: 2020 7374 6163 6b20 3d20 6c69 7374 286b    stack = list(k
+0002d630: 6579 7329 0a20 2020 2020 2020 2073 6565  eys).        see
+0002d640: 6e20 3d20 7365 7428 290a 2020 2020 2020  n = set().      
+0002d650: 2020 726f 6f74 7320 3d20 5b5d 0a20 2020    roots = [].   
+0002d660: 2020 2020 2077 6869 6c65 2073 7461 636b       while stack
+0002d670: 3a0a 2020 2020 2020 2020 2020 2020 6b65  :.            ke
+0002d680: 7920 3d20 7374 6163 6b2e 706f 7028 290a  y = stack.pop().
+0002d690: 2020 2020 2020 2020 2020 2020 7365 656e              seen
+0002d6a0: 2e61 6464 286b 6579 290a 2020 2020 2020  .add(key).      
+0002d6b0: 2020 2020 2020 7473 203d 2073 656c 662e        ts = self.
+0002d6c0: 7461 736b 735b 6b65 795d 0a20 2020 2020  tasks[key].     
+0002d6d0: 2020 2020 2020 2065 7272 6564 5f64 6570         erred_dep
+0002d6e0: 7320 3d20 5b64 7473 2e6b 6579 2066 6f72  s = [dts.key for
+0002d6f0: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
+0002d700: 6465 6e63 6965 7320 6966 2064 7473 2e73  dencies if dts.s
+0002d710: 7461 7465 203d 3d20 2265 7272 6564 225d  tate == "erred"]
+0002d720: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0002d730: 6572 7265 645f 6465 7073 3a0a 2020 2020  erred_deps:.    
+0002d740: 2020 2020 2020 2020 2020 2020 7374 6163              stac
+0002d750: 6b2e 6578 7465 6e64 2865 7272 6564 5f64  k.extend(erred_d
+0002d760: 6570 7329 0a20 2020 2020 2020 2020 2020  eps).           
+0002d770: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0002d780: 2020 2020 2020 2072 6f6f 7473 2e61 7070         roots.app
+0002d790: 656e 6428 6b65 7929 0a0a 2020 2020 2020  end(key)..      
+0002d7a0: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
+0002d7b0: 733a 2052 6563 7320 3d20 7b6b 6579 3a20  s: Recs = {key: 
+0002d7c0: 2277 6169 7469 6e67 2220 666f 7220 6b65  "waiting" for ke
+0002d7d0: 7920 696e 2072 6f6f 7473 7d0a 2020 2020  y in roots}.    
+0002d7e0: 2020 2020 7365 6c66 2e74 7261 6e73 6974      self.transit
+0002d7f0: 696f 6e73 2872 6563 6f6d 6d65 6e64 6174  ions(recommendat
+0002d800: 696f 6e73 2c20 6622 7374 696d 756c 7573  ions, f"stimulus
+0002d810: 2d72 6574 7279 2d7b 7469 6d65 2829 7d22  -retry-{time()}"
+0002d820: 290a 0a20 2020 2020 2020 2069 6620 7365  )..        if se
+0002d830: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
+0002d840: 2020 2020 2020 2020 2066 6f72 206b 6579           for key
+0002d850: 2069 6e20 7365 656e 3a0a 2020 2020 2020   in seen:.      
+0002d860: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0002d870: 206e 6f74 2073 656c 662e 7461 736b 735b   not self.tasks[
+0002d880: 6b65 795d 2e65 7863 6570 7469 6f6e 5f62  key].exception_b
+0002d890: 6c61 6d65 0a0a 2020 2020 2020 2020 7265  lame..        re
+0002d8a0: 7475 726e 2074 7570 6c65 2873 6565 6e29  turn tuple(seen)
+0002d8b0: 0a0a 2020 2020 6465 6620 636c 6f73 655f  ..    def close_
+0002d8c0: 776f 726b 6572 2873 656c 662c 2077 6f72  worker(self, wor
+0002d8d0: 6b65 723a 2073 7472 2920 2d3e 204e 6f6e  ker: str) -> Non
+0002d8e0: 653a 0a20 2020 2020 2020 2022 2222 4173  e:.        """As
+0002d8f0: 6b20 6120 776f 726b 6572 2074 6f20 7368  k a worker to sh
+0002d900: 7574 2069 7473 656c 6620 646f 776e 2e20  ut itself down. 
+0002d910: 446f 206e 6f74 2077 6169 7420 666f 7220  Do not wait for 
+0002d920: 6974 2074 6f20 7461 6b65 2065 6666 6563  it to take effec
+0002d930: 742e 0a20 2020 2020 2020 204e 6f74 6520  t..        Note 
+0002d940: 7468 6174 2074 6865 7265 2069 7320 6e6f  that there is no
+0002d950: 2067 7561 7261 6e74 6565 2074 6861 7420   guarantee that 
+0002d960: 7468 6520 776f 726b 6572 2077 696c 6c20  the worker will 
+0002d970: 6163 7475 616c 6c79 2061 6363 6570 7420  actually accept 
+0002d980: 7468 650a 2020 2020 2020 2020 636f 6d6d  the.        comm
+0002d990: 616e 642e 0a0a 2020 2020 2020 2020 4e6f  and...        No
+0002d9a0: 7465 2074 6861 7420 3a6d 6574 683a 6072  te that :meth:`r
+0002d9b0: 656d 6f76 655f 776f 726b 6572 6020 7365  emove_worker` se
+0002d9c0: 6e64 7320 7468 6520 7361 6d65 2063 6f6d  nds the same com
+0002d9d0: 6d61 6e64 2069 6e74 6572 6e61 6c6c 7920  mand internally 
+0002d9e0: 6966 2063 6c6f 7365 3d54 7275 652e 0a0a  if close=True...
+0002d9f0: 2020 2020 2020 2020 5365 6520 616c 736f          See also
+0002da00: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
+0002da10: 2d0a 2020 2020 2020 2020 7265 7469 7265  -.        retire
+0002da20: 5f77 6f72 6b65 7273 0a20 2020 2020 2020  _workers.       
+0002da30: 2072 656d 6f76 655f 776f 726b 6572 0a20   remove_worker. 
+0002da40: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0002da50: 2020 2069 6620 776f 726b 6572 206e 6f74     if worker not
+0002da60: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
+0002da70: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0002da80: 7475 726e 0a0a 2020 2020 2020 2020 6c6f  turn..        lo
+0002da90: 6767 6572 2e69 6e66 6f28 2243 6c6f 7369  gger.info("Closi
+0002daa0: 6e67 2077 6f72 6b65 7220 2573 222c 2077  ng worker %s", w
+0002dab0: 6f72 6b65 7229 0a20 2020 2020 2020 2073  orker).        s
+0002dac0: 656c 662e 6c6f 675f 6576 656e 7428 776f  elf.log_event(wo
+0002dad0: 726b 6572 2c20 7b22 6163 7469 6f6e 223a  rker, {"action":
+0002dae0: 2022 636c 6f73 652d 776f 726b 6572 227d   "close-worker"}
+0002daf0: 290a 2020 2020 2020 2020 7365 6c66 2e77  ).        self.w
+0002db00: 6f72 6b65 725f 7365 6e64 2877 6f72 6b65  orker_send(worke
+0002db10: 722c 207b 226f 7022 3a20 2263 6c6f 7365  r, {"op": "close
+0002db20: 222c 2022 7265 6173 6f6e 223a 2022 7363  ", "reason": "sc
+0002db30: 6865 6475 6c65 722d 636c 6f73 652d 776f  heduler-close-wo
+0002db40: 726b 6572 227d 290a 0a20 2020 2040 6c6f  rker"})..    @lo
+0002db50: 675f 6572 726f 7273 0a20 2020 2061 7379  g_errors.    asy
+0002db60: 6e63 2064 6566 2072 656d 6f76 655f 776f  nc def remove_wo
+0002db70: 726b 6572 280a 2020 2020 2020 2020 7365  rker(.        se
+0002db80: 6c66 2c20 6164 6472 6573 733a 2073 7472  lf, address: str
+0002db90: 2c20 2a2c 2073 7469 6d75 6c75 735f 6964  , *, stimulus_id
+0002dba0: 3a20 7374 722c 2073 6166 653a 2062 6f6f  : str, safe: boo
+0002dbb0: 6c20 3d20 4661 6c73 652c 2063 6c6f 7365  l = False, close
+0002dbc0: 3a20 626f 6f6c 203d 2054 7275 650a 2020  : bool = True.  
+0002dbd0: 2020 2920 2d3e 204c 6974 6572 616c 5b22    ) -> Literal["
+0002dbe0: 4f4b 222c 2022 616c 7265 6164 792d 7265  OK", "already-re
+0002dbf0: 6d6f 7665 6422 5d3a 0a20 2020 2020 2020  moved"]:.       
+0002dc00: 2022 2222 5265 6d6f 7665 2077 6f72 6b65   """Remove worke
+0002dc10: 7220 6672 6f6d 2063 6c75 7374 6572 2e0a  r from cluster..
+0002dc20: 0a20 2020 2020 2020 2057 6520 646f 2074  .        We do t
+0002dc30: 6869 7320 7768 656e 2061 2077 6f72 6b65  his when a worke
+0002dc40: 7220 7265 706f 7274 7320 7468 6174 2069  r reports that i
+0002dc50: 7420 706c 616e 7320 746f 206c 6561 7665  t plans to leave
+0002dc60: 206f 7220 7768 656e 2069 7420 6170 7065   or when it appe
+0002dc70: 6172 7320 746f 2062 650a 2020 2020 2020  ars to be.      
+0002dc80: 2020 756e 7265 7370 6f6e 7369 7665 2e20    unresponsive. 
+0002dc90: 5468 6973 206d 6179 2073 656e 6420 6974  This may send it
+0002dca0: 7320 7461 736b 7320 6261 636b 2074 6f20  s tasks back to 
+0002dcb0: 6120 7265 6c65 6173 6564 2073 7461 7465  a released state
+0002dcc0: 2e0a 0a20 2020 2020 2020 2053 6565 2061  ...        See a
+0002dcd0: 6c73 6f0a 2020 2020 2020 2020 2d2d 2d2d  lso.        ----
+0002dce0: 2d2d 2d2d 0a20 2020 2020 2020 2072 6574  ----.        ret
+0002dcf0: 6972 655f 776f 726b 6572 730a 2020 2020  ire_workers.    
+0002dd00: 2020 2020 636c 6f73 655f 776f 726b 6572      close_worker
+0002dd10: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0002dd20: 2020 2020 2069 6620 7365 6c66 2e73 7461       if self.sta
+0002dd30: 7475 7320 3d3d 2053 7461 7475 732e 636c  tus == Status.cl
+0002dd40: 6f73 6564 3a0a 2020 2020 2020 2020 2020  osed:.          
+0002dd50: 2020 7265 7475 726e 2022 616c 7265 6164    return "alread
+0002dd60: 792d 7265 6d6f 7665 6422 0a0a 2020 2020  y-removed"..    
+0002dd70: 2020 2020 6164 6472 6573 7320 3d20 7365      address = se
+0002dd80: 6c66 2e63 6f65 7263 655f 6164 6472 6573  lf.coerce_addres
+0002dd90: 7328 6164 6472 6573 7329 0a0a 2020 2020  s(address)..    
+0002dda0: 2020 2020 6966 2061 6464 7265 7373 206e      if address n
+0002ddb0: 6f74 2069 6e20 7365 6c66 2e77 6f72 6b65  ot in self.worke
+0002ddc0: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
+0002ddd0: 7265 7475 726e 2022 616c 7265 6164 792d  return "already-
+0002dde0: 7265 6d6f 7665 6422 0a0a 2020 2020 2020  removed"..      
+0002ddf0: 2020 686f 7374 203d 2067 6574 5f61 6464    host = get_add
+0002de00: 7265 7373 5f68 6f73 7428 6164 6472 6573  ress_host(addres
+0002de10: 7329 0a0a 2020 2020 2020 2020 7773 203d  s)..        ws =
+0002de20: 2073 656c 662e 776f 726b 6572 735b 6164   self.workers[ad
+0002de30: 6472 6573 735d 0a0a 2020 2020 2020 2020  dress]..        
+0002de40: 6c6f 6767 6572 2e69 6e66 6f28 6622 5265  logger.info(f"Re
+0002de50: 6d6f 7665 2077 6f72 6b65 7220 7b77 737d  move worker {ws}
+0002de60: 2028 7b73 7469 6d75 6c75 735f 6964 3d7d   ({stimulus_id=}
+0002de70: 2922 290a 2020 2020 2020 2020 6966 2063  )").        if c
+0002de80: 6c6f 7365 3a0a 2020 2020 2020 2020 2020  lose:.          
+0002de90: 2020 7769 7468 2073 7570 7072 6573 7328    with suppress(
+0002dea0: 4174 7472 6962 7574 6545 7272 6f72 2c20  AttributeError, 
+0002deb0: 436f 6d6d 436c 6f73 6564 4572 726f 7229  CommClosedError)
+0002dec0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002ded0: 2020 7365 6c66 2e73 7472 6561 6d5f 636f    self.stream_co
+0002dee0: 6d6d 735b 6164 6472 6573 735d 2e73 656e  mms[address].sen
+0002def0: 6428 0a20 2020 2020 2020 2020 2020 2020  d(.             
+0002df00: 2020 2020 2020 207b 226f 7022 3a20 2263         {"op": "c
+0002df10: 6c6f 7365 222c 2022 7265 6173 6f6e 223a  lose", "reason":
+0002df20: 2022 7363 6865 6475 6c65 722d 7265 6d6f   "scheduler-remo
+0002df30: 7665 2d77 6f72 6b65 7222 7d0a 2020 2020  ve-worker"}.    
+0002df40: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+0002df50: 2020 2020 2020 2073 656c 662e 7265 6d6f         self.remo
+0002df60: 7665 5f72 6573 6f75 7263 6573 2861 6464  ve_resources(add
+0002df70: 7265 7373 290a 0a20 2020 2020 2020 2064  ress)..        d
+0002df80: 6820 3d20 7365 6c66 2e68 6f73 745f 696e  h = self.host_in
+0002df90: 666f 5b68 6f73 745d 0a20 2020 2020 2020  fo[host].       
+0002dfa0: 2064 685f 6164 6472 6573 7365 733a 2073   dh_addresses: s
+0002dfb0: 6574 203d 2064 685b 2261 6464 7265 7373  et = dh["address
+0002dfc0: 6573 225d 0a20 2020 2020 2020 2064 685f  es"].        dh_
+0002dfd0: 6164 6472 6573 7365 732e 7265 6d6f 7665  addresses.remove
+0002dfe0: 2861 6464 7265 7373 290a 2020 2020 2020  (address).      
+0002dff0: 2020 6468 5b22 6e74 6872 6561 6473 225d    dh["nthreads"]
+0002e000: 202d 3d20 7773 2e6e 7468 7265 6164 730a   -= ws.nthreads.
+0002e010: 2020 2020 2020 2020 7365 6c66 2e74 6f74          self.tot
+0002e020: 616c 5f6e 7468 7265 6164 7320 2d3d 2077  al_nthreads -= w
+0002e030: 732e 6e74 6872 6561 6473 0a20 2020 2020  s.nthreads.     
+0002e040: 2020 2073 656c 662e 746f 7461 6c5f 6e74     self.total_nt
+0002e050: 6872 6561 6473 5f68 6973 746f 7279 2e61  hreads_history.a
+0002e060: 7070 656e 6428 2874 696d 6528 292c 2073  ppend((time(), s
+0002e070: 656c 662e 746f 7461 6c5f 6e74 6872 6561  elf.total_nthrea
+0002e080: 6473 2929 0a20 2020 2020 2020 2069 6620  ds)).        if 
+0002e090: 6e6f 7420 6468 5f61 6464 7265 7373 6573  not dh_addresses
+0002e0a0: 3a0a 2020 2020 2020 2020 2020 2020 6465  :.            de
+0002e0b0: 6c20 7365 6c66 2e68 6f73 745f 696e 666f  l self.host_info
+0002e0c0: 5b68 6f73 745d 0a0a 2020 2020 2020 2020  [host]..        
+0002e0d0: 7365 6c66 2e72 7063 2e72 656d 6f76 6528  self.rpc.remove(
+0002e0e0: 6164 6472 6573 7329 0a20 2020 2020 2020  address).       
+0002e0f0: 2064 656c 2073 656c 662e 7374 7265 616d   del self.stream
+0002e100: 5f63 6f6d 6d73 5b61 6464 7265 7373 5d0a  _comms[address].
+0002e110: 2020 2020 2020 2020 6465 6c20 7365 6c66          del self
+0002e120: 2e61 6c69 6173 6573 5b77 732e 6e61 6d65  .aliases[ws.name
+0002e130: 5d0a 2020 2020 2020 2020 7365 6c66 2e69  ].        self.i
+0002e140: 646c 652e 706f 7028 7773 2e61 6464 7265  dle.pop(ws.addre
+0002e150: 7373 2c20 4e6f 6e65 290a 2020 2020 2020  ss, None).      
+0002e160: 2020 7365 6c66 2e69 646c 655f 7461 736b    self.idle_task
+0002e170: 5f63 6f75 6e74 2e64 6973 6361 7264 2877  _count.discard(w
+0002e180: 7329 0a20 2020 2020 2020 2073 656c 662e  s).        self.
+0002e190: 7361 7475 7261 7465 642e 6469 7363 6172  saturated.discar
+0002e1a0: 6428 7773 290a 2020 2020 2020 2020 6465  d(ws).        de
+0002e1b0: 6c20 7365 6c66 2e77 6f72 6b65 7273 5b61  l self.workers[a
+0002e1c0: 6464 7265 7373 5d0a 2020 2020 2020 2020  ddress].        
+0002e1d0: 7773 2e73 7461 7475 7320 3d20 5374 6174  ws.status = Stat
+0002e1e0: 7573 2e63 6c6f 7365 640a 2020 2020 2020  us.closed.      
+0002e1f0: 2020 7365 6c66 2e72 756e 6e69 6e67 2e64    self.running.d
+0002e200: 6973 6361 7264 2877 7329 0a0a 2020 2020  iscard(ws)..    
+0002e210: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
+0002e220: 6f6e 733a 2052 6563 7320 3d20 7b7d 0a0a  ons: Recs = {}..
+0002e230: 2020 2020 2020 2020 7072 6f63 6573 7369          processi
+0002e240: 6e67 5f6b 6579 7320 3d20 7b74 732e 6b65  ng_keys = {ts.ke
+0002e250: 7920 666f 7220 7473 2069 6e20 7773 2e70  y for ts in ws.p
+0002e260: 726f 6365 7373 696e 677d 0a20 2020 2020  rocessing}.     
+0002e270: 2020 2066 6f72 2074 7320 696e 206c 6973     for ts in lis
+0002e280: 7428 7773 2e70 726f 6365 7373 696e 6729  t(ws.processing)
+0002e290: 3a0a 2020 2020 2020 2020 2020 2020 6b20  :.            k 
+0002e2a0: 3d20 7473 2e6b 6579 0a20 2020 2020 2020  = ts.key.       
+0002e2b0: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
+0002e2c0: 696f 6e73 5b6b 5d20 3d20 2272 656c 6561  ions[k] = "relea
+0002e2d0: 7365 6422 0a20 2020 2020 2020 2020 2020  sed".           
+0002e2e0: 2069 6620 6e6f 7420 7361 6665 3a0a 2020   if not safe:.  
+0002e2f0: 2020 2020 2020 2020 2020 2020 2020 7473                ts
+0002e300: 2e73 7573 7069 6369 6f75 7320 2b3d 2031  .suspicious += 1
+0002e310: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002e320: 2074 732e 7072 6566 6978 2e73 7573 7069   ts.prefix.suspi
+0002e330: 6369 6f75 7320 2b3d 2031 0a20 2020 2020  cious += 1.     
+0002e340: 2020 2020 2020 2020 2020 2069 6620 7473             if ts
+0002e350: 2e73 7573 7069 6369 6f75 7320 3e20 7365  .suspicious > se
+0002e360: 6c66 2e61 6c6c 6f77 6564 5f66 6169 6c75  lf.allowed_failu
+0002e370: 7265 733a 0a20 2020 2020 2020 2020 2020  res:.           
+0002e380: 2020 2020 2020 2020 2064 656c 2072 6563           del rec
+0002e390: 6f6d 6d65 6e64 6174 696f 6e73 5b6b 5d0a  ommendations[k].
+0002e3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e3b0: 2020 2020 6520 3d20 7069 636b 6c65 2e64      e = pickle.d
+0002e3c0: 756d 7073 280a 2020 2020 2020 2020 2020  umps(.          
+0002e3d0: 2020 2020 2020 2020 2020 2020 2020 4b69                Ki
+0002e3e0: 6c6c 6564 576f 726b 6572 280a 2020 2020  lledWorker(.    
+0002e3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e400: 2020 2020 2020 2020 7461 736b 3d6b 2c0a          task=k,.
+0002e410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e420: 2020 2020 2020 2020 2020 2020 6c61 7374              last
+0002e430: 5f77 6f72 6b65 723d 7773 2e63 6c65 616e  _worker=ws.clean
+0002e440: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
+0002e450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e460: 616c 6c6f 7765 645f 6661 696c 7572 6573  allowed_failures
+0002e470: 3d73 656c 662e 616c 6c6f 7765 645f 6661  =self.allowed_fa
+0002e480: 696c 7572 6573 2c0a 2020 2020 2020 2020  ilures,.        
+0002e490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e4a0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0002e4b0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0002e4c0: 2020 2020 2020 2020 2020 2020 2072 203d               r =
+0002e4d0: 2073 656c 662e 7472 616e 7369 7469 6f6e   self.transition
+0002e4e0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0002e4f0: 2020 2020 2020 2020 2020 6b2c 0a20 2020            k,.   
 0002e500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e510: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-0002e520: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
-0002e530: 6174 696f 6e73 2e75 7064 6174 6528 7229  ations.update(r)
-0002e540: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002e550: 2020 2020 206c 6f67 6765 722e 6572 726f       logger.erro
-0002e560: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-0002e570: 2020 2020 2020 2020 2020 2022 5461 736b             "Task
-0002e580: 2025 7320 6d61 726b 6564 2061 7320 6661   %s marked as fa
-0002e590: 696c 6564 2062 6563 6175 7365 2025 6420  iled because %d 
-0002e5a0: 776f 726b 6572 7320 6469 6564 220a 2020  workers died".  
-0002e5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e5c0: 2020 2020 2020 2220 7768 696c 6520 7472        " while tr
-0002e5d0: 7969 6e67 2074 6f20 7275 6e20 6974 222c  ying to run it",
-0002e5e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002e5f0: 2020 2020 2020 2020 2074 732e 6b65 792c           ts.key,
+0002e510: 2020 2020 2022 6572 7265 6422 2c0a 2020       "erred",.  
+0002e520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e530: 2020 2020 2020 6578 6365 7074 696f 6e3d        exception=
+0002e540: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+0002e550: 2020 2020 2020 2020 2020 2063 6175 7365             cause
+0002e560: 3d6b 2c0a 2020 2020 2020 2020 2020 2020  =k,.            
+0002e570: 2020 2020 2020 2020 2020 2020 7374 696d              stim
+0002e580: 756c 7573 5f69 643d 7374 696d 756c 7573  ulus_id=stimulus
+0002e590: 5f69 642c 0a20 2020 2020 2020 2020 2020  _id,.           
+0002e5a0: 2020 2020 2020 2020 2020 2020 2077 6f72               wor
+0002e5b0: 6b65 723d 6164 6472 6573 732c 0a20 2020  ker=address,.   
+0002e5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e5d0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+0002e5e0: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
+0002e5f0: 6174 696f 6e73 2e75 7064 6174 6528 7229  ations.update(r)
 0002e600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002e610: 2020 2020 2020 2020 2074 732e 7375 7370           ts.susp
-0002e620: 6963 696f 7573 2c0a 2020 2020 2020 2020  icious,.        
-0002e630: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-0002e640: 2020 2020 2020 2072 6563 6f6d 7075 7465         recompute
-0002e650: 5f6b 6579 7320 3d20 7365 7428 290a 2020  _keys = set().  
-0002e660: 2020 2020 2020 6c6f 7374 5f6b 6579 7320        lost_keys 
-0002e670: 3d20 7365 7428 290a 0a20 2020 2020 2020  = set()..       
-0002e680: 2066 6f72 2074 7320 696e 206c 6973 7428   for ts in list(
-0002e690: 7773 2e68 6173 5f77 6861 7429 3a0a 2020  ws.has_what):.  
-0002e6a0: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
-0002e6b0: 656d 6f76 655f 7265 706c 6963 6128 7473  emove_replica(ts
-0002e6c0: 2c20 7773 290a 2020 2020 2020 2020 2020  , ws).          
-0002e6d0: 2020 6966 206e 6f74 2074 732e 7768 6f5f    if not ts.who_
-0002e6e0: 6861 733a 0a20 2020 2020 2020 2020 2020  has:.           
-0002e6f0: 2020 2020 2069 6620 7473 2e72 756e 5f73       if ts.run_s
-0002e700: 7065 633a 0a20 2020 2020 2020 2020 2020  pec:.           
-0002e710: 2020 2020 2020 2020 2072 6563 6f6d 7075           recompu
-0002e720: 7465 5f6b 6579 732e 6164 6428 7473 2e6b  te_keys.add(ts.k
-0002e730: 6579 290a 2020 2020 2020 2020 2020 2020  ey).            
-0002e740: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
-0002e750: 6461 7469 6f6e 735b 7473 2e6b 6579 5d20  dations[ts.key] 
-0002e760: 3d20 2272 656c 6561 7365 6422 0a20 2020  = "released".   
-0002e770: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-0002e780: 653a 2020 2320 7075 7265 2064 6174 610a  e:  # pure data.
-0002e790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e7a0: 2020 2020 6c6f 7374 5f6b 6579 732e 6164      lost_keys.ad
-0002e7b0: 6428 7473 2e6b 6579 290a 2020 2020 2020  d(ts.key).      
-0002e7c0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0002e7d0: 636f 6d6d 656e 6461 7469 6f6e 735b 7473  commendations[ts
-0002e7e0: 2e6b 6579 5d20 3d20 2266 6f72 676f 7474  .key] = "forgott
-0002e7f0: 656e 220a 0a20 2020 2020 2020 2069 6620  en"..        if 
-0002e800: 7265 636f 6d70 7574 655f 6b65 7973 3a0a  recompute_keys:.
-0002e810: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-0002e820: 6572 2e77 6172 6e69 6e67 280a 2020 2020  er.warning(.    
-0002e830: 2020 2020 2020 2020 2020 2020 6622 5265              f"Re
-0002e840: 6d6f 7669 6e67 2077 6f72 6b65 7220 7b77  moving worker {w
-0002e850: 732e 6164 6472 6573 7321 727d 2063 6175  s.address!r} cau
-0002e860: 7365 6420 7468 6520 636c 7573 7465 7220  sed the cluster 
-0002e870: 746f 206c 6f73 6520 220a 2020 2020 2020  to lose ".      
-0002e880: 2020 2020 2020 2020 2020 2261 6c72 6561            "alrea
-0002e890: 6479 2063 6f6d 7075 7465 6420 7461 736b  dy computed task
-0002e8a0: 2873 292c 2077 6869 6368 2077 696c 6c20  (s), which will 
-0002e8b0: 6265 2072 6563 6f6d 7075 7465 6420 656c  be recomputed el
-0002e8c0: 7365 7768 6572 653a 2022 0a20 2020 2020  sewhere: ".     
-0002e8d0: 2020 2020 2020 2020 2020 2066 227b 7265             f"{re
-0002e8e0: 636f 6d70 7574 655f 6b65 7973 7d20 287b  compute_keys} ({
-0002e8f0: 7374 696d 756c 7573 5f69 643d 7d29 220a  stimulus_id=})".
-0002e900: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0002e910: 2020 2020 2020 6966 206c 6f73 745f 6b65        if lost_ke
-0002e920: 7973 3a0a 2020 2020 2020 2020 2020 2020  ys:.            
-0002e930: 6c6f 6767 6572 2e65 7272 6f72 280a 2020  logger.error(.  
-0002e940: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-0002e950: 5265 6d6f 7669 6e67 2077 6f72 6b65 7220  Removing worker 
-0002e960: 7b77 732e 6164 6472 6573 7321 727d 2063  {ws.address!r} c
-0002e970: 6175 7365 6420 7468 6520 636c 7573 7465  aused the cluste
-0002e980: 7220 746f 206c 6f73 6520 7363 6174 7465  r to lose scatte
-0002e990: 7265 6420 220a 2020 2020 2020 2020 2020  red ".          
-0002e9a0: 2020 2020 2020 6622 6461 7461 2c20 7768        f"data, wh
-0002e9b0: 6963 6820 6361 6e27 7420 6265 2072 6563  ich can't be rec
-0002e9c0: 6f76 6572 6564 3a20 7b6c 6f73 745f 6b65  overed: {lost_ke
-0002e9d0: 7973 7d20 287b 7374 696d 756c 7573 5f69  ys} ({stimulus_i
-0002e9e0: 643d 7d29 220a 2020 2020 2020 2020 2020  d=})".          
-0002e9f0: 2020 290a 0a20 2020 2020 2020 2065 7665    )..        eve
-0002ea00: 6e74 5f6d 7367 203d 207b 0a20 2020 2020  nt_msg = {.     
-0002ea10: 2020 2020 2020 2022 6163 7469 6f6e 223a         "action":
-0002ea20: 2022 7265 6d6f 7665 2d77 6f72 6b65 7222   "remove-worker"
-0002ea30: 2c0a 2020 2020 2020 2020 2020 2020 2270  ,.            "p
-0002ea40: 726f 6365 7373 696e 672d 7461 736b 7322  rocessing-tasks"
-0002ea50: 3a20 7072 6f63 6573 7369 6e67 5f6b 6579  : processing_key
-0002ea60: 732c 0a20 2020 2020 2020 2020 2020 2022  s,.            "
-0002ea70: 6c6f 7374 2d63 6f6d 7075 7465 642d 7461  lost-computed-ta
-0002ea80: 736b 7322 3a20 7265 636f 6d70 7574 655f  sks": recompute_
-0002ea90: 6b65 7973 2c0a 2020 2020 2020 2020 2020  keys,.          
-0002eaa0: 2020 226c 6f73 742d 7363 6174 7465 7265    "lost-scattere
-0002eab0: 642d 7461 736b 7322 3a20 6c6f 7374 5f6b  d-tasks": lost_k
-0002eac0: 6579 732c 0a20 2020 2020 2020 2020 2020  eys,.           
-0002ead0: 2022 7374 696d 756c 7573 5f69 6422 3a20   "stimulus_id": 
-0002eae0: 7374 696d 756c 7573 5f69 642c 0a20 2020  stimulus_id,.   
-0002eaf0: 2020 2020 207d 0a20 2020 2020 2020 2073       }.        s
-0002eb00: 656c 662e 6c6f 675f 6576 656e 7428 6164  elf.log_event(ad
-0002eb10: 6472 6573 732c 2065 7665 6e74 5f6d 7367  dress, event_msg
-0002eb20: 2e63 6f70 7928 2929 0a20 2020 2020 2020  .copy()).       
-0002eb30: 2065 7665 6e74 5f6d 7367 5b22 776f 726b   event_msg["work
-0002eb40: 6572 225d 203d 2061 6464 7265 7373 0a20  er"] = address. 
-0002eb50: 2020 2020 2020 2073 656c 662e 6c6f 675f         self.log_
-0002eb60: 6576 656e 7428 2261 6c6c 222c 2065 7665  event("all", eve
-0002eb70: 6e74 5f6d 7367 290a 0a20 2020 2020 2020  nt_msg)..       
-0002eb80: 2073 656c 662e 7472 616e 7369 7469 6f6e   self.transition
-0002eb90: 7328 7265 636f 6d6d 656e 6461 7469 6f6e  s(recommendation
-0002eba0: 732c 2073 7469 6d75 6c75 735f 6964 3d73  s, stimulus_id=s
-0002ebb0: 7469 6d75 6c75 735f 6964 290a 0a20 2020  timulus_id)..   
-0002ebc0: 2020 2020 2061 7761 6974 6162 6c65 7320       awaitables 
-0002ebd0: 3d20 5b5d 0a20 2020 2020 2020 2066 6f72  = [].        for
-0002ebe0: 2070 6c75 6769 6e20 696e 206c 6973 7428   plugin in list(
-0002ebf0: 7365 6c66 2e70 6c75 6769 6e73 2e76 616c  self.plugins.val
-0002ec00: 7565 7328 2929 3a0a 2020 2020 2020 2020  ues()):.        
-0002ec10: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-0002ec20: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-0002ec30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ec40: 2020 7265 7375 6c74 203d 2070 6c75 6769    result = plugi
-0002ec50: 6e2e 7265 6d6f 7665 5f77 6f72 6b65 7228  n.remove_worker(
-0002ec60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002ec70: 2020 2020 2020 2020 2073 6368 6564 756c           schedul
-0002ec80: 6572 3d73 656c 662c 2077 6f72 6b65 723d  er=self, worker=
-0002ec90: 6164 6472 6573 732c 2073 7469 6d75 6c75  address, stimulu
-0002eca0: 735f 6964 3d73 7469 6d75 6c75 735f 6964  s_id=stimulus_id
-0002ecb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002ecc0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-0002ecd0: 2020 2020 2020 2065 7863 6570 7420 5479         except Ty
-0002ece0: 7065 4572 726f 723a 0a20 2020 2020 2020  peError:.       
-0002ecf0: 2020 2020 2020 2020 2020 2020 2070 6172               par
-0002ed00: 616d 6574 6572 7320 3d20 696e 7370 6563  ameters = inspec
-0002ed10: 742e 7369 676e 6174 7572 6528 706c 7567  t.signature(plug
-0002ed20: 696e 2e72 656d 6f76 655f 776f 726b 6572  in.remove_worker
-0002ed30: 292e 7061 7261 6d65 7465 7273 0a20 2020  ).parameters.   
-0002ed40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ed50: 2069 6620 2273 7469 6d75 6c75 735f 6964   if "stimulus_id
-0002ed60: 2220 6e6f 7420 696e 2070 6172 616d 6574  " not in paramet
-0002ed70: 6572 7320 616e 6420 6e6f 7420 616e 7928  ers and not any(
-0002ed80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002ed90: 2020 2020 2020 2020 2070 2e6b 696e 6420           p.kind 
-0002eda0: 6973 2070 2e56 4152 5f4b 4559 574f 5244  is p.VAR_KEYWORD
-0002edb0: 2066 6f72 2070 2069 6e20 7061 7261 6d65   for p in parame
-0002edc0: 7465 7273 2e76 616c 7565 7328 290a 2020  ters.values().  
-0002edd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ede0: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
-0002edf0: 2020 2020 2020 2020 2020 2020 2023 2044               # D
-0002ee00: 6570 7265 6361 7465 6420 2873 6565 2061  eprecated (see a
-0002ee10: 6464 5f70 6c75 6769 6e29 0a20 2020 2020  dd_plugin).     
-0002ee20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ee30: 2020 2072 6573 756c 7420 3d20 706c 7567     result = plug
-0002ee40: 696e 2e72 656d 6f76 655f 776f 726b 6572  in.remove_worker
-0002ee50: 2873 6368 6564 756c 6572 3d73 656c 662c  (scheduler=self,
-0002ee60: 2077 6f72 6b65 723d 6164 6472 6573 7329   worker=address)
-0002ee70: 2020 2320 7479 7065 3a20 6967 6e6f 7265    # type: ignore
-0002ee80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002ee90: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0002eea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002eeb0: 2020 2072 6169 7365 0a20 2020 2020 2020     raise.       
-0002eec0: 2020 2020 2020 2020 2069 6620 696e 7370           if insp
-0002eed0: 6563 742e 6973 6177 6169 7461 626c 6528  ect.isawaitable(
-0002eee0: 7265 7375 6c74 293a 0a20 2020 2020 2020  result):.       
-0002eef0: 2020 2020 2020 2020 2020 2020 2061 7761               awa
-0002ef00: 6974 6162 6c65 732e 6170 7065 6e64 2872  itables.append(r
-0002ef10: 6573 756c 7429 0a20 2020 2020 2020 2020  esult).         
-0002ef20: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
-0002ef30: 696f 6e20 6173 2065 3a0a 2020 2020 2020  ion as e:.      
-0002ef40: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-0002ef50: 2e65 7863 6570 7469 6f6e 2865 290a 0a20  .exception(e).. 
-0002ef60: 2020 2020 2020 2070 6c75 6769 6e5f 6d73         plugin_ms
-0002ef70: 6773 203d 2061 7761 6974 2061 7379 6e63  gs = await async
-0002ef80: 696f 2e67 6174 6865 7228 2a61 7761 6974  io.gather(*await
-0002ef90: 6162 6c65 732c 2072 6574 7572 6e5f 6578  ables, return_ex
-0002efa0: 6365 7074 696f 6e73 3d54 7275 6529 0a20  ceptions=True). 
-0002efb0: 2020 2020 2020 2070 6c75 6769 6e73 5f65         plugins_e
-0002efc0: 7863 6570 7469 6f6e 7320 3d20 5b6d 7367  xceptions = [msg
-0002efd0: 2066 6f72 206d 7367 2069 6e20 706c 7567   for msg in plug
-0002efe0: 696e 5f6d 7367 7320 6966 2069 7369 6e73  in_msgs if isins
-0002eff0: 7461 6e63 6528 6d73 672c 2045 7863 6570  tance(msg, Excep
-0002f000: 7469 6f6e 295d 0a20 2020 2020 2020 2066  tion)].        f
-0002f010: 6f72 2065 7863 2069 6e20 706c 7567 696e  or exc in plugin
-0002f020: 735f 6578 6365 7074 696f 6e73 3a0a 2020  s_exceptions:.  
-0002f030: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-0002f040: 2e65 7863 6570 7469 6f6e 2865 7863 2c20  .exception(exc, 
-0002f050: 6578 635f 696e 666f 3d65 7863 290a 0a20  exc_info=exc).. 
-0002f060: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
-0002f070: 6c66 2e77 6f72 6b65 7273 3a0a 2020 2020  lf.workers:.    
-0002f080: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
-0002f090: 6e66 6f28 224c 6f73 7420 616c 6c20 776f  nfo("Lost all wo
-0002f0a0: 726b 6572 7322 290a 0a20 2020 2020 2020  rkers")..       
-0002f0b0: 2066 6f72 2077 2069 6e20 7365 6c66 2e77   for w in self.w
-0002f0c0: 6f72 6b65 7273 3a0a 2020 2020 2020 2020  orkers:.        
-0002f0d0: 2020 2020 7365 6c66 2e62 616e 6477 6964      self.bandwid
-0002f0e0: 7468 5f77 6f72 6b65 7273 2e70 6f70 2828  th_workers.pop((
-0002f0f0: 6164 6472 6573 732c 2077 292c 204e 6f6e  address, w), Non
-0002f100: 6529 0a20 2020 2020 2020 2020 2020 2073  e).            s
-0002f110: 656c 662e 6261 6e64 7769 6474 685f 776f  elf.bandwidth_wo
-0002f120: 726b 6572 732e 706f 7028 2877 2c20 6164  rkers.pop((w, ad
-0002f130: 6472 6573 7329 2c20 4e6f 6e65 290a 0a20  dress), None).. 
-0002f140: 2020 2020 2020 2061 7379 6e63 2064 6566         async def
-0002f150: 2072 656d 6f76 655f 776f 726b 6572 5f66   remove_worker_f
-0002f160: 726f 6d5f 6576 656e 7473 2829 202d 3e20  rom_events() -> 
-0002f170: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0002f180: 2020 2320 4966 2074 6865 2077 6f72 6b65    # If the worke
-0002f190: 7220 6973 6e27 7420 7265 6769 7374 6572  r isn't register
-0002f1a0: 6564 2061 6e79 6d6f 7265 2061 6674 6572  ed anymore after
-0002f1b0: 2074 6865 2064 656c 6179 2c20 7265 6d6f   the delay, remo
-0002f1c0: 7665 2066 726f 6d20 6576 656e 7473 0a20  ve from events. 
-0002f1d0: 2020 2020 2020 2020 2020 2069 6620 6164             if ad
-0002f1e0: 6472 6573 7320 6e6f 7420 696e 2073 656c  dress not in sel
-0002f1f0: 662e 776f 726b 6572 7320 616e 6420 6164  f.workers and ad
-0002f200: 6472 6573 7320 696e 2073 656c 662e 6576  dress in self.ev
-0002f210: 656e 7473 3a0a 2020 2020 2020 2020 2020  ents:.          
-0002f220: 2020 2020 2020 6465 6c20 7365 6c66 2e65        del self.e
-0002f230: 7665 6e74 735b 6164 6472 6573 735d 0a0a  vents[address]..
-0002f240: 2020 2020 2020 2020 636c 6561 6e75 705f          cleanup_
-0002f250: 6465 6c61 7920 3d20 7061 7273 655f 7469  delay = parse_ti
-0002f260: 6d65 6465 6c74 6128 0a20 2020 2020 2020  medelta(.       
-0002f270: 2020 2020 2064 6173 6b2e 636f 6e66 6967       dask.config
-0002f280: 2e67 6574 2822 6469 7374 7269 6275 7465  .get("distribute
-0002f290: 642e 7363 6865 6475 6c65 722e 6576 656e  d.scheduler.even
-0002f2a0: 7473 2d63 6c65 616e 7570 2d64 656c 6179  ts-cleanup-delay
-0002f2b0: 2229 0a20 2020 2020 2020 2029 0a0a 2020  ").        )..  
-0002f2c0: 2020 2020 2020 7365 6c66 2e5f 6f6e 676f        self._ongo
-0002f2d0: 696e 675f 6261 636b 6772 6f75 6e64 5f74  ing_background_t
-0002f2e0: 6173 6b73 2e63 616c 6c5f 6c61 7465 7228  asks.call_later(
-0002f2f0: 0a20 2020 2020 2020 2020 2020 2063 6c65  .            cle
-0002f300: 616e 7570 5f64 656c 6179 2c20 7265 6d6f  anup_delay, remo
-0002f310: 7665 5f77 6f72 6b65 725f 6672 6f6d 5f65  ve_worker_from_e
-0002f320: 7665 6e74 730a 2020 2020 2020 2020 290a  vents.        ).
-0002f330: 2020 2020 2020 2020 6c6f 6767 6572 2e64          logger.d
-0002f340: 6562 7567 2822 5265 6d6f 7665 6420 776f  ebug("Removed wo
-0002f350: 726b 6572 2025 7322 2c20 7773 290a 0a20  rker %s", ws).. 
-0002f360: 2020 2020 2020 2066 6f72 2077 2069 6e20         for w in 
-0002f370: 7365 6c66 2e77 6f72 6b65 7273 3a0a 2020  self.workers:.  
-0002f380: 2020 2020 2020 2020 2020 7365 6c66 2e77            self.w
-0002f390: 6f72 6b65 725f 7365 6e64 280a 2020 2020  orker_send(.    
-0002f3a0: 2020 2020 2020 2020 2020 2020 772c 0a20              w,. 
-0002f3b0: 2020 2020 2020 2020 2020 2020 2020 207b                 {
-0002f3c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002f3d0: 2020 2020 2022 6f70 223a 2022 7265 6d6f       "op": "remo
-0002f3e0: 7665 2d77 6f72 6b65 7222 2c0a 2020 2020  ve-worker",.    
-0002f3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f400: 2277 6f72 6b65 7222 3a20 6164 6472 6573  "worker": addres
-0002f410: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-0002f420: 2020 2020 2020 2022 7374 696d 756c 7573         "stimulus
-0002f430: 5f69 6422 3a20 7374 696d 756c 7573 5f69  _id": stimulus_i
-0002f440: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
-0002f450: 2020 207d 2c0a 2020 2020 2020 2020 2020     },.          
-0002f460: 2020 290a 0a20 2020 2020 2020 2072 6574    )..        ret
-0002f470: 7572 6e20 224f 4b22 0a0a 2020 2020 6465  urn "OK"..    de
-0002f480: 6620 7374 696d 756c 7573 5f63 616e 6365  f stimulus_cance
-0002f490: 6c28 0a20 2020 2020 2020 2073 656c 662c  l(.        self,
-0002f4a0: 206b 6579 733a 2043 6f6c 6c65 6374 696f   keys: Collectio
-0002f4b0: 6e5b 4b65 795d 2c20 636c 6965 6e74 3a20  n[Key], client: 
-0002f4c0: 7374 722c 2066 6f72 6365 3a20 626f 6f6c  str, force: bool
-0002f4d0: 203d 2046 616c 7365 0a20 2020 2029 202d   = False.    ) -
-0002f4e0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-0002f4f0: 2222 2253 746f 7020 6578 6563 7574 696f  """Stop executio
-0002f500: 6e20 6f6e 2061 206c 6973 7420 6f66 206b  n on a list of k
-0002f510: 6579 7322 2222 0a20 2020 2020 2020 206c  eys""".        l
-0002f520: 6f67 6765 722e 696e 666f 2822 436c 6965  ogger.info("Clie
-0002f530: 6e74 2025 7320 7265 7175 6573 7473 2074  nt %s requests t
-0002f540: 6f20 6361 6e63 656c 2025 6420 6b65 7973  o cancel %d keys
-0002f550: 222c 2063 6c69 656e 742c 206c 656e 286b  ", client, len(k
-0002f560: 6579 7329 290a 2020 2020 2020 2020 7365  eys)).        se
-0002f570: 6c66 2e6c 6f67 5f65 7665 6e74 2863 6c69  lf.log_event(cli
-0002f580: 656e 742c 207b 2261 6374 696f 6e22 3a20  ent, {"action": 
-0002f590: 2263 616e 6365 6c22 2c20 2263 6f75 6e74  "cancel", "count
-0002f5a0: 223a 206c 656e 286b 6579 7329 2c20 2266  ": len(keys), "f
-0002f5b0: 6f72 6365 223a 2066 6f72 6365 7d29 0a20  orce": force}). 
-0002f5c0: 2020 2020 2020 2063 7320 3d20 7365 6c66         cs = self
-0002f5d0: 2e63 6c69 656e 7473 2e67 6574 2863 6c69  .clients.get(cli
-0002f5e0: 656e 7429 0a20 2020 2020 2020 2069 6620  ent).        if 
-0002f5f0: 6e6f 7420 6373 3a0a 2020 2020 2020 2020  not cs:.        
-0002f600: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
-0002f610: 2020 2020 6361 6e63 656c 6c65 645f 6b65      cancelled_ke
-0002f620: 7973 203d 205b 5d0a 2020 2020 2020 2020  ys = [].        
-0002f630: 636c 6965 6e74 7320 3d20 5b5d 0a20 2020  clients = [].   
-0002f640: 2020 2020 2066 6f72 206b 6579 2069 6e20       for key in 
-0002f650: 6b65 7973 3a0a 2020 2020 2020 2020 2020  keys:.          
-0002f660: 2020 7473 203d 2073 656c 662e 7461 736b    ts = self.task
-0002f670: 732e 6765 7428 6b65 7929 0a20 2020 2020  s.get(key).     
-0002f680: 2020 2020 2020 2069 6620 6e6f 7420 7473         if not ts
-0002f690: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002f6a0: 2020 636f 6e74 696e 7565 0a0a 2020 2020    continue..    
-0002f6b0: 2020 2020 2020 2020 6966 2066 6f72 6365          if force
-0002f6c0: 206f 7220 7473 2e77 686f 5f77 616e 7473   or ts.who_wants
-0002f6d0: 203d 3d20 7b63 737d 3a20 2023 206e 6f20   == {cs}:  # no 
-0002f6e0: 6f6e 6520 656c 7365 2077 616e 7473 2074  one else wants t
-0002f6f0: 6869 7320 6b65 790a 2020 2020 2020 2020  his key.        
-0002f700: 2020 2020 2020 2020 6966 2074 732e 6465          if ts.de
-0002f710: 7065 6e64 656e 7473 3a0a 2020 2020 2020  pendents:.      
-0002f720: 2020 2020 2020 2020 2020 2020 2020 7365                se
-0002f730: 6c66 2e73 7469 6d75 6c75 735f 6361 6e63  lf.stimulus_canc
-0002f740: 656c 280a 2020 2020 2020 2020 2020 2020  el(.            
-0002f750: 2020 2020 2020 2020 2020 2020 5b64 7473              [dts
-0002f760: 2e6b 6579 2066 6f72 2064 7473 2069 6e20  .key for dts in 
-0002f770: 7473 2e64 6570 656e 6465 6e74 735d 2c20  ts.dependents], 
-0002f780: 636c 6965 6e74 2c20 666f 7263 653d 666f  client, force=fo
-0002f790: 7263 650a 2020 2020 2020 2020 2020 2020  rce.            
-0002f7a0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0002f7b0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-0002f7c0: 2e69 6e66 6f28 2253 6368 6564 756c 6572  .info("Scheduler
-0002f7d0: 2063 616e 6365 6c73 206b 6579 2025 732e   cancels key %s.
-0002f7e0: 2020 466f 7263 653d 2573 222c 206b 6579    Force=%s", key
-0002f7f0: 2c20 666f 7263 6529 0a20 2020 2020 2020  , force).       
-0002f800: 2020 2020 2020 2020 2063 616e 6365 6c6c           cancell
-0002f810: 6564 5f6b 6579 732e 6170 7065 6e64 286b  ed_keys.append(k
-0002f820: 6579 290a 2020 2020 2020 2020 2020 2020  ey).            
-0002f830: 6173 7365 7274 2074 732e 7768 6f5f 7761  assert ts.who_wa
-0002f840: 6e74 730a 2020 2020 2020 2020 2020 2020  nts.            
-0002f850: 636c 6965 6e74 732e 6578 7465 6e64 286c  clients.extend(l
-0002f860: 6973 7428 7473 2e77 686f 5f77 616e 7473  ist(ts.who_wants
-0002f870: 2920 6966 2066 6f72 6365 2065 6c73 6520  ) if force else 
-0002f880: 5b63 735d 290a 2020 2020 2020 2020 666f  [cs]).        fo
-0002f890: 7220 6373 2069 6e20 636c 6965 6e74 733a  r cs in clients:
-0002f8a0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0002f8b0: 662e 636c 6965 6e74 5f72 656c 6561 7365  f.client_release
-0002f8c0: 735f 6b65 7973 280a 2020 2020 2020 2020  s_keys(.        
-0002f8d0: 2020 2020 2020 2020 6b65 7973 3d63 616e          keys=can
-0002f8e0: 6365 6c6c 6564 5f6b 6579 732c 0a20 2020  celled_keys,.   
-0002f8f0: 2020 2020 2020 2020 2020 2020 2063 6c69               cli
-0002f900: 656e 743d 6373 2e63 6c69 656e 745f 6b65  ent=cs.client_ke
-0002f910: 792c 0a20 2020 2020 2020 2020 2020 2020  y,.             
-0002f920: 2020 2073 7469 6d75 6c75 735f 6964 3d66     stimulus_id=f
-0002f930: 2263 616e 6365 6c2d 6b65 792d 7b74 696d  "cancel-key-{tim
-0002f940: 6528 297d 222c 0a20 2020 2020 2020 2020  e()}",.         
-0002f950: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
-0002f960: 662e 7265 706f 7274 287b 226f 7022 3a20  f.report({"op": 
-0002f970: 2263 616e 6365 6c6c 6564 2d6b 6579 7322  "cancelled-keys"
-0002f980: 2c20 226b 6579 7322 3a20 6361 6e63 656c  , "keys": cancel
-0002f990: 6c65 645f 6b65 7973 7d29 0a0a 2020 2020  led_keys})..    
-0002f9a0: 6465 6620 636c 6965 6e74 5f64 6573 6972  def client_desir
-0002f9b0: 6573 5f6b 6579 7328 7365 6c66 2c20 6b65  es_keys(self, ke
-0002f9c0: 7973 3a20 436f 6c6c 6563 7469 6f6e 5b4b  ys: Collection[K
-0002f9d0: 6579 5d2c 2063 6c69 656e 743a 2073 7472  ey], client: str
-0002f9e0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-0002f9f0: 2020 2063 7320 3d20 7365 6c66 2e63 6c69     cs = self.cli
-0002fa00: 656e 7473 2e67 6574 2863 6c69 656e 7429  ents.get(client)
-0002fa10: 0a20 2020 2020 2020 2069 6620 6373 2069  .        if cs i
-0002fa20: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-0002fa30: 2020 2020 2320 466f 7220 7075 626c 6973      # For publis
-0002fa40: 682c 2071 7565 7565 7320 6574 632e 0a20  h, queues etc.. 
-0002fa50: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0002fa60: 636c 6965 6e74 735b 636c 6965 6e74 5d20  clients[client] 
-0002fa70: 3d20 6373 203d 2043 6c69 656e 7453 7461  = cs = ClientSta
-0002fa80: 7465 2863 6c69 656e 7429 0a0a 2020 2020  te(client)..    
-0002fa90: 2020 2020 666f 7220 6b20 696e 206b 6579      for k in key
-0002faa0: 733a 0a20 2020 2020 2020 2020 2020 2074  s:.            t
-0002fab0: 7320 3d20 7365 6c66 2e74 6173 6b73 2e67  s = self.tasks.g
-0002fac0: 6574 286b 290a 2020 2020 2020 2020 2020  et(k).          
-0002fad0: 2020 6966 2074 7320 6973 204e 6f6e 653a    if ts is None:
-0002fae0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002faf0: 2023 2046 6f72 2070 7562 6c69 7368 2c20   # For publish, 
-0002fb00: 7175 6575 6573 2065 7463 2e0a 2020 2020  queues etc..    
-0002fb10: 2020 2020 2020 2020 2020 2020 7473 203d              ts =
-0002fb20: 2073 656c 662e 6e65 775f 7461 736b 286b   self.new_task(k
-0002fb30: 2c20 4e6f 6e65 2c20 2272 656c 6561 7365  , None, "release
-0002fb40: 6422 290a 2020 2020 2020 2020 2020 2020  d").            
-0002fb50: 6966 2074 732e 7768 6f5f 7761 6e74 7320  if ts.who_wants 
-0002fb60: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-0002fb70: 2020 2020 2020 2020 2074 732e 7768 6f5f           ts.who_
-0002fb80: 7761 6e74 7320 3d20 7365 7428 290a 2020  wants = set().  
-0002fb90: 2020 2020 2020 2020 2020 7473 2e77 686f            ts.who
-0002fba0: 5f77 616e 7473 2e61 6464 2863 7329 0a20  _wants.add(cs). 
-0002fbb0: 2020 2020 2020 2020 2020 2063 732e 7761             cs.wa
-0002fbc0: 6e74 735f 7768 6174 2e61 6464 2874 7329  nts_what.add(ts)
-0002fbd0: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-0002fbe0: 2074 732e 7374 6174 6520 696e 2028 226d   ts.state in ("m
-0002fbf0: 656d 6f72 7922 2c20 2265 7272 6564 2229  emory", "erred")
-0002fc00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002fc10: 2020 7365 6c66 2e72 6570 6f72 745f 6f6e    self.report_on
-0002fc20: 5f6b 6579 2874 733d 7473 2c20 636c 6965  _key(ts=ts, clie
-0002fc30: 6e74 3d63 6c69 656e 7429 0a0a 2020 2020  nt=client)..    
-0002fc40: 6465 6620 636c 6965 6e74 5f72 656c 6561  def client_relea
-0002fc50: 7365 735f 6b65 7973 280a 2020 2020 2020  ses_keys(.      
-0002fc60: 2020 7365 6c66 2c20 6b65 7973 3a20 436f    self, keys: Co
-0002fc70: 6c6c 6563 7469 6f6e 5b4b 6579 5d2c 2063  llection[Key], c
-0002fc80: 6c69 656e 743a 2073 7472 2c20 7374 696d  lient: str, stim
-0002fc90: 756c 7573 5f69 643a 2073 7472 207c 204e  ulus_id: str | N
-0002fca0: 6f6e 6520 3d20 4e6f 6e65 0a20 2020 2029  one = None.    )
-0002fcb0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-0002fcc0: 2020 2222 2252 656d 6f76 6520 6b65 7973    """Remove keys
-0002fcd0: 2066 726f 6d20 636c 6965 6e74 2064 6573   from client des
-0002fce0: 6972 6564 206c 6973 7422 2222 0a20 2020  ired list""".   
-0002fcf0: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
-0002fd00: 203d 2073 7469 6d75 6c75 735f 6964 206f   = stimulus_id o
-0002fd10: 7220 6622 636c 6965 6e74 2d72 656c 6561  r f"client-relea
-0002fd20: 7365 732d 6b65 7973 2d7b 7469 6d65 2829  ses-keys-{time()
-0002fd30: 7d22 0a20 2020 2020 2020 2069 6620 6e6f  }".        if no
-0002fd40: 7420 6973 696e 7374 616e 6365 286b 6579  t isinstance(key
-0002fd50: 732c 206c 6973 7429 3a0a 2020 2020 2020  s, list):.      
-0002fd60: 2020 2020 2020 6b65 7973 203d 206c 6973        keys = lis
-0002fd70: 7428 6b65 7973 290a 2020 2020 2020 2020  t(keys).        
-0002fd80: 6373 203d 2073 656c 662e 636c 6965 6e74  cs = self.client
-0002fd90: 735b 636c 6965 6e74 5d0a 2020 2020 2020  s[client].      
-0002fda0: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
-0002fdb0: 733a 2052 6563 7320 3d20 7b7d 0a0a 2020  s: Recs = {}..  
-0002fdc0: 2020 2020 2020 7365 6c66 2e5f 636c 6965        self._clie
-0002fdd0: 6e74 5f72 656c 6561 7365 735f 6b65 7973  nt_releases_keys
-0002fde0: 286b 6579 733d 6b65 7973 2c20 6373 3d63  (keys=keys, cs=c
-0002fdf0: 732c 2072 6563 6f6d 6d65 6e64 6174 696f  s, recommendatio
-0002fe00: 6e73 3d72 6563 6f6d 6d65 6e64 6174 696f  ns=recommendatio
-0002fe10: 6e73 290a 2020 2020 2020 2020 7365 6c66  ns).        self
-0002fe20: 2e74 7261 6e73 6974 696f 6e73 2872 6563  .transitions(rec
-0002fe30: 6f6d 6d65 6e64 6174 696f 6e73 2c20 7374  ommendations, st
-0002fe40: 696d 756c 7573 5f69 6429 0a0a 2020 2020  imulus_id)..    
-0002fe50: 2020 2020 7365 6c66 2e73 7469 6d75 6c75      self.stimulu
-0002fe60: 735f 7175 6575 655f 736c 6f74 735f 6d61  s_queue_slots_ma
-0002fe70: 7962 655f 6f70 656e 6564 2873 7469 6d75  ybe_opened(stimu
-0002fe80: 6c75 735f 6964 3d73 7469 6d75 6c75 735f  lus_id=stimulus_
-0002fe90: 6964 290a 0a20 2020 2064 6566 2063 6c69  id)..    def cli
-0002fea0: 656e 745f 6865 6172 7462 6561 7428 7365  ent_heartbeat(se
-0002feb0: 6c66 2c20 636c 6965 6e74 3a20 7374 7229  lf, client: str)
-0002fec0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-0002fed0: 2020 2222 2248 616e 646c 6520 6865 6172    """Handle hear
-0002fee0: 7462 6561 7473 2066 726f 6d20 436c 6965  tbeats from Clie
-0002fef0: 6e74 2222 220a 2020 2020 2020 2020 6373  nt""".        cs
-0002ff00: 203d 2073 656c 662e 636c 6965 6e74 735b   = self.clients[
-0002ff10: 636c 6965 6e74 5d0a 2020 2020 2020 2020  client].        
-0002ff20: 6373 2e6c 6173 745f 7365 656e 203d 2074  cs.last_seen = t
-0002ff30: 696d 6528 290a 0a20 2020 2023 2323 2323  ime()..    #####
-0002ff40: 2323 2323 2323 2323 2323 2323 2323 0a20  ##############. 
-0002ff50: 2020 2023 2054 6173 6b20 5661 6c69 6461     # Task Valida
-0002ff60: 7469 6f6e 2023 0a20 2020 2023 2323 2323  tion #.    #####
-0002ff70: 2323 2323 2323 2323 2323 2323 2323 0a0a  ##############..
-0002ff80: 2020 2020 6465 6620 7661 6c69 6461 7465      def validate
-0002ff90: 5f72 656c 6561 7365 6428 7365 6c66 2c20  _released(self, 
-0002ffa0: 6b65 793a 204b 6579 2920 2d3e 204e 6f6e  key: Key) -> Non
-0002ffb0: 653a 0a20 2020 2020 2020 2074 7320 3d20  e:.        ts = 
-0002ffc0: 7365 6c66 2e74 6173 6b73 5b6b 6579 5d0a  self.tasks[key].
-0002ffd0: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
-0002ffe0: 732e 7374 6174 6520 3d3d 2022 7265 6c65  s.state == "rele
-0002fff0: 6173 6564 220a 2020 2020 2020 2020 6173  ased".        as
-00030000: 7365 7274 206e 6f74 2074 732e 7761 6974  sert not ts.wait
-00030010: 6572 730a 2020 2020 2020 2020 6173 7365  ers.        asse
-00030020: 7274 206e 6f74 2074 732e 7761 6974 696e  rt not ts.waitin
-00030030: 675f 6f6e 0a20 2020 2020 2020 2061 7373  g_on.        ass
-00030040: 6572 7420 6e6f 7420 7473 2e77 686f 5f68  ert not ts.who_h
-00030050: 6173 0a20 2020 2020 2020 2061 7373 6572  as.        asser
-00030060: 7420 6e6f 7420 7473 2e70 726f 6365 7373  t not ts.process
-00030070: 696e 675f 6f6e 0a20 2020 2020 2020 2061  ing_on.        a
-00030080: 7373 6572 7420 6e6f 7420 616e 7928 5b74  ssert not any([t
-00030090: 7320 696e 2028 6474 732e 7761 6974 6572  s in (dts.waiter
-000300a0: 7320 6f72 2028 2929 2066 6f72 2064 7473  s or ()) for dts
-000300b0: 2069 6e20 7473 2e64 6570 656e 6465 6e63   in ts.dependenc
-000300c0: 6965 735d 290a 2020 2020 2020 2020 6173  ies]).        as
-000300d0: 7365 7274 2074 7320 6e6f 7420 696e 2073  sert ts not in s
-000300e0: 656c 662e 756e 7275 6e6e 6162 6c65 0a20  elf.unrunnable. 
-000300f0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
-00030100: 206e 6f74 2069 6e20 7365 6c66 2e71 7565   not in self.que
-00030110: 7565 640a 0a20 2020 2064 6566 2076 616c  ued..    def val
-00030120: 6964 6174 655f 7761 6974 696e 6728 7365  idate_waiting(se
-00030130: 6c66 2c20 6b65 793a 204b 6579 2920 2d3e  lf, key: Key) ->
-00030140: 204e 6f6e 653a 0a20 2020 2020 2020 2074   None:.        t
-00030150: 7320 3d20 7365 6c66 2e74 6173 6b73 5b6b  s = self.tasks[k
-00030160: 6579 5d0a 2020 2020 2020 2020 6173 7365  ey].        asse
-00030170: 7274 2074 732e 7761 6974 696e 675f 6f6e  rt ts.waiting_on
-00030180: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-00030190: 6e6f 7420 7473 2e77 686f 5f68 6173 0a20  not ts.who_has. 
-000301a0: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
-000301b0: 7420 7473 2e70 726f 6365 7373 696e 675f  t ts.processing_
-000301c0: 6f6e 0a20 2020 2020 2020 2061 7373 6572  on.        asser
-000301d0: 7420 7473 206e 6f74 2069 6e20 7365 6c66  t ts not in self
-000301e0: 2e75 6e72 756e 6e61 626c 650a 2020 2020  .unrunnable.    
-000301f0: 2020 2020 6173 7365 7274 2074 7320 6e6f      assert ts no
-00030200: 7420 696e 2073 656c 662e 7175 6575 6564  t in self.queued
-00030210: 0a20 2020 2020 2020 2066 6f72 2064 7473  .        for dts
-00030220: 2069 6e20 7473 2e64 6570 656e 6465 6e63   in ts.dependenc
-00030230: 6965 733a 0a20 2020 2020 2020 2020 2020  ies:.           
-00030240: 2023 2057 6520 6172 6520 7761 6974 696e   # We are waitin
-00030250: 6720 6f6e 2061 2064 6570 656e 6465 6e63  g on a dependenc
-00030260: 7920 6966 6620 6974 2773 206e 6f74 2073  y iff it's not s
-00030270: 746f 7265 640a 2020 2020 2020 2020 2020  tored.          
-00030280: 2020 6173 7365 7274 2062 6f6f 6c28 6474    assert bool(dt
-00030290: 732e 7768 6f5f 6861 7329 2021 3d20 2864  s.who_has) != (d
-000302a0: 7473 2069 6e20 2874 732e 7761 6974 696e  ts in (ts.waitin
-000302b0: 675f 6f6e 206f 7220 2829 2929 0a20 2020  g_on or ())).   
-000302c0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-000302d0: 7473 2069 6e20 2864 7473 2e77 6169 7465  ts in (dts.waite
-000302e0: 7273 206f 7220 2829 2920 2023 2058 5858  rs or ())  # XXX
-000302f0: 2065 7665 6e20 6966 2064 7473 2e5f 7768   even if dts._wh
-00030300: 6f5f 6861 733f 0a0a 2020 2020 6465 6620  o_has?..    def 
-00030310: 7661 6c69 6461 7465 5f71 7565 7565 6428  validate_queued(
-00030320: 7365 6c66 2c20 6b65 793a 204b 6579 2920  self, key: Key) 
-00030330: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-00030340: 2074 7320 3d20 7365 6c66 2e74 6173 6b73   ts = self.tasks
-00030350: 5b6b 6579 5d0a 2020 2020 2020 2020 6173  [key].        as
-00030360: 7365 7274 2074 7320 696e 2073 656c 662e  sert ts in self.
-00030370: 7175 6575 6564 0a20 2020 2020 2020 2061  queued.        a
-00030380: 7373 6572 7420 6e6f 7420 7473 2e77 6169  ssert not ts.wai
-00030390: 7469 6e67 5f6f 6e0a 2020 2020 2020 2020  ting_on.        
-000303a0: 6173 7365 7274 206e 6f74 2074 732e 7768  assert not ts.wh
-000303b0: 6f5f 6861 730a 2020 2020 2020 2020 6173  o_has.        as
-000303c0: 7365 7274 206e 6f74 2074 732e 7072 6f63  sert not ts.proc
-000303d0: 6573 7369 6e67 5f6f 6e0a 2020 2020 2020  essing_on.      
-000303e0: 2020 6173 7365 7274 206e 6f74 2028 0a20    assert not (. 
-000303f0: 2020 2020 2020 2020 2020 2074 732e 776f             ts.wo
-00030400: 726b 6572 5f72 6573 7472 6963 7469 6f6e  rker_restriction
-00030410: 7320 6f72 2074 732e 686f 7374 5f72 6573  s or ts.host_res
-00030420: 7472 6963 7469 6f6e 7320 6f72 2074 732e  trictions or ts.
-00030430: 7265 736f 7572 6365 5f72 6573 7472 6963  resource_restric
-00030440: 7469 6f6e 730a 2020 2020 2020 2020 290a  tions.        ).
-00030450: 2020 2020 2020 2020 666f 7220 6474 7320          for dts 
-00030460: 696e 2074 732e 6465 7065 6e64 656e 6369  in ts.dependenci
-00030470: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-00030480: 6173 7365 7274 2064 7473 2e77 686f 5f68  assert dts.who_h
-00030490: 6173 0a20 2020 2020 2020 2020 2020 2061  as.            a
-000304a0: 7373 6572 7420 7473 2069 6e20 2864 7473  ssert ts in (dts
-000304b0: 2e77 6169 7465 7273 206f 7220 2829 290a  .waiters or ()).
-000304c0: 0a20 2020 2064 6566 2076 616c 6964 6174  .    def validat
-000304d0: 655f 7072 6f63 6573 7369 6e67 2873 656c  e_processing(sel
-000304e0: 662c 206b 6579 3a20 4b65 7929 202d 3e20  f, key: Key) -> 
-000304f0: 4e6f 6e65 3a0a 2020 2020 2020 2020 7473  None:.        ts
-00030500: 203d 2073 656c 662e 7461 736b 735b 6b65   = self.tasks[ke
-00030510: 795d 0a20 2020 2020 2020 2061 7373 6572  y].        asser
-00030520: 7420 6e6f 7420 7473 2e77 6169 7469 6e67  t not ts.waiting
-00030530: 5f6f 6e0a 2020 2020 2020 2020 7773 203d  _on.        ws =
-00030540: 2074 732e 7072 6f63 6573 7369 6e67 5f6f   ts.processing_o
-00030550: 6e0a 2020 2020 2020 2020 6173 7365 7274  n.        assert
-00030560: 2077 730a 2020 2020 2020 2020 6173 7365   ws.        asse
-00030570: 7274 2074 7320 696e 2077 732e 7072 6f63  rt ts in ws.proc
-00030580: 6573 7369 6e67 0a20 2020 2020 2020 2061  essing.        a
-00030590: 7373 6572 7420 6e6f 7420 7473 2e77 686f  ssert not ts.who
-000305a0: 5f68 6173 0a20 2020 2020 2020 2061 7373  _has.        ass
-000305b0: 6572 7420 7473 206e 6f74 2069 6e20 7365  ert ts not in se
-000305c0: 6c66 2e71 7565 7565 640a 2020 2020 2020  lf.queued.      
-000305d0: 2020 666f 7220 6474 7320 696e 2074 732e    for dts in ts.
-000305e0: 6465 7065 6e64 656e 6369 6573 3a0a 2020  dependencies:.  
-000305f0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00030600: 2064 7473 2e77 686f 5f68 6173 206f 7220   dts.who_has or 
-00030610: 2829 0a20 2020 2020 2020 2020 2020 2061  ().            a
-00030620: 7373 6572 7420 7473 2069 6e20 2864 7473  ssert ts in (dts
-00030630: 2e77 6169 7465 7273 206f 7220 2829 290a  .waiters or ()).
-00030640: 0a20 2020 2064 6566 2076 616c 6964 6174  .    def validat
-00030650: 655f 6d65 6d6f 7279 2873 656c 662c 206b  e_memory(self, k
-00030660: 6579 3a20 4b65 7929 202d 3e20 4e6f 6e65  ey: Key) -> None
-00030670: 3a0a 2020 2020 2020 2020 7473 203d 2073  :.        ts = s
-00030680: 656c 662e 7461 736b 735b 6b65 795d 0a20  elf.tasks[key]. 
-00030690: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
-000306a0: 2e77 686f 5f68 6173 0a20 2020 2020 2020  .who_has.       
-000306b0: 2061 7373 6572 7420 626f 6f6c 2874 7320   assert bool(ts 
-000306c0: 696e 2073 656c 662e 7265 706c 6963 6174  in self.replicat
-000306d0: 6564 5f74 6173 6b73 2920 3d3d 2028 6c65  ed_tasks) == (le
-000306e0: 6e28 7473 2e77 686f 5f68 6173 2920 3e20  n(ts.who_has) > 
-000306f0: 3129 0a20 2020 2020 2020 2061 7373 6572  1).        asser
-00030700: 7420 6e6f 7420 7473 2e70 726f 6365 7373  t not ts.process
-00030710: 696e 675f 6f6e 0a20 2020 2020 2020 2061  ing_on.        a
-00030720: 7373 6572 7420 6e6f 7420 7473 2e77 6169  ssert not ts.wai
-00030730: 7469 6e67 5f6f 6e0a 2020 2020 2020 2020  ting_on.        
-00030740: 6173 7365 7274 2074 7320 6e6f 7420 696e  assert ts not in
-00030750: 2073 656c 662e 756e 7275 6e6e 6162 6c65   self.unrunnable
-00030760: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-00030770: 7473 206e 6f74 2069 6e20 7365 6c66 2e71  ts not in self.q
-00030780: 7565 7565 640a 2020 2020 2020 2020 666f  ueued.        fo
-00030790: 7220 6474 7320 696e 2074 732e 6465 7065  r dts in ts.depe
-000307a0: 6e64 656e 7473 3a0a 2020 2020 2020 2020  ndents:.        
-000307b0: 2020 2020 6173 7365 7274 2028 6474 7320      assert (dts 
-000307c0: 696e 2028 7473 2e77 6169 7465 7273 206f  in (ts.waiters o
-000307d0: 7220 2829 2929 203d 3d20 280a 2020 2020  r ())) == (.    
-000307e0: 2020 2020 2020 2020 2020 2020 6474 732e              dts.
-000307f0: 7374 6174 6520 696e 2028 2277 6169 7469  state in ("waiti
-00030800: 6e67 222c 2022 7175 6575 6564 222c 2022  ng", "queued", "
-00030810: 7072 6f63 6573 7369 6e67 222c 2022 6e6f  processing", "no
-00030820: 2d77 6f72 6b65 7222 290a 2020 2020 2020  -worker").      
-00030830: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00030840: 2020 2020 6173 7365 7274 2074 7320 6e6f      assert ts no
-00030850: 7420 696e 2028 6474 732e 7761 6974 696e  t in (dts.waitin
-00030860: 675f 6f6e 206f 7220 2829 290a 0a20 2020  g_on or ())..   
-00030870: 2064 6566 2076 616c 6964 6174 655f 6e6f   def validate_no
-00030880: 5f77 6f72 6b65 7228 7365 6c66 2c20 6b65  _worker(self, ke
-00030890: 793a 204b 6579 2920 2d3e 204e 6f6e 653a  y: Key) -> None:
-000308a0: 0a20 2020 2020 2020 2074 7320 3d20 7365  .        ts = se
-000308b0: 6c66 2e74 6173 6b73 5b6b 6579 5d0a 2020  lf.tasks[key].  
-000308c0: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
-000308d0: 696e 2073 656c 662e 756e 7275 6e6e 6162  in self.unrunnab
-000308e0: 6c65 0a20 2020 2020 2020 2061 7373 6572  le.        asser
-000308f0: 7420 6e6f 7420 7473 2e77 6169 7469 6e67  t not ts.waiting
-00030900: 5f6f 6e0a 2020 2020 2020 2020 6173 7365  _on.        asse
-00030910: 7274 2074 7320 696e 2073 656c 662e 756e  rt ts in self.un
-00030920: 7275 6e6e 6162 6c65 0a20 2020 2020 2020  runnable.       
-00030930: 2061 7373 6572 7420 6e6f 7420 7473 2e70   assert not ts.p
-00030940: 726f 6365 7373 696e 675f 6f6e 0a20 2020  rocessing_on.   
-00030950: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-00030960: 7473 2e77 686f 5f68 6173 0a20 2020 2020  ts.who_has.     
-00030970: 2020 2061 7373 6572 7420 7473 206e 6f74     assert ts not
-00030980: 2069 6e20 7365 6c66 2e71 7565 7565 640a   in self.queued.
-00030990: 2020 2020 2020 2020 666f 7220 6474 7320          for dts 
-000309a0: 696e 2074 732e 6465 7065 6e64 656e 6369  in ts.dependenci
-000309b0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-000309c0: 6173 7365 7274 2064 7473 2e77 686f 5f68  assert dts.who_h
-000309d0: 6173 0a0a 2020 2020 6465 6620 7661 6c69  as..    def vali
-000309e0: 6461 7465 5f65 7272 6564 2873 656c 662c  date_erred(self,
-000309f0: 206b 6579 3a20 4b65 7929 202d 3e20 4e6f   key: Key) -> No
-00030a00: 6e65 3a0a 2020 2020 2020 2020 7473 203d  ne:.        ts =
-00030a10: 2073 656c 662e 7461 736b 735b 6b65 795d   self.tasks[key]
-00030a20: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-00030a30: 7473 2e65 7863 6570 7469 6f6e 5f62 6c61  ts.exception_bla
-00030a40: 6d65 0a20 2020 2020 2020 2061 7373 6572  me.        asser
-00030a50: 7420 6e6f 7420 7473 2e77 686f 5f68 6173  t not ts.who_has
-00030a60: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-00030a70: 7473 206e 6f74 2069 6e20 7365 6c66 2e71  ts not in self.q
-00030a80: 7565 7565 640a 0a20 2020 2064 6566 2076  ueued..    def v
-00030a90: 616c 6964 6174 655f 6b65 7928 7365 6c66  alidate_key(self
-00030aa0: 2c20 6b65 793a 204b 6579 2c20 7473 3a20  , key: Key, ts: 
-00030ab0: 5461 736b 5374 6174 6520 7c20 4e6f 6e65  TaskState | None
-00030ac0: 203d 204e 6f6e 6529 202d 3e20 4e6f 6e65   = None) -> None
-00030ad0: 3a0a 2020 2020 2020 2020 7472 793a 0a20  :.        try:. 
-00030ae0: 2020 2020 2020 2020 2020 2069 6620 7473             if ts
-00030af0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-00030b00: 2020 2020 2020 2020 2020 7473 203d 2073            ts = s
-00030b10: 656c 662e 7461 736b 732e 6765 7428 6b65  elf.tasks.get(ke
-00030b20: 7929 0a20 2020 2020 2020 2020 2020 2069  y).            i
-00030b30: 6620 7473 2069 7320 4e6f 6e65 3a0a 2020  f ts is None:.  
-00030b40: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-00030b50: 6767 6572 2e64 6562 7567 2822 4b65 7920  gger.debug("Key 
-00030b60: 6c6f 7374 3a20 2573 222c 206b 6579 290a  lost: %s", key).
-00030b70: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00030b80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00030b90: 2020 7473 2e76 616c 6964 6174 6528 290a    ts.validate().
-00030ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030bb0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00030bc0: 2020 2020 2020 2020 2066 756e 6320 3d20           func = 
-00030bd0: 6765 7461 7474 7228 7365 6c66 2c20 2276  getattr(self, "v
-00030be0: 616c 6964 6174 655f 2220 2b20 7473 2e73  alidate_" + ts.s
-00030bf0: 7461 7465 2e72 6570 6c61 6365 2822 2d22  tate.replace("-"
-00030c00: 2c20 225f 2229 290a 2020 2020 2020 2020  , "_")).        
-00030c10: 2020 2020 2020 2020 6578 6365 7074 2041          except A
-00030c20: 7474 7269 6275 7465 4572 726f 723a 0a20  ttributeError:. 
-00030c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030c40: 2020 206c 6f67 6765 722e 6572 726f 7228     logger.error(
-00030c50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00030c60: 2020 2020 2020 2020 2022 7365 6c66 2e76           "self.v
-00030c70: 616c 6964 6174 655f 2573 206e 6f74 2066  alidate_%s not f
-00030c80: 6f75 6e64 222c 2074 732e 7374 6174 652e  ound", ts.state.
-00030c90: 7265 706c 6163 6528 222d 222c 2022 5f22  replace("-", "_"
-00030ca0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00030cb0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00030cc0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00030cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030ce0: 2020 6675 6e63 286b 6579 290a 2020 2020    func(key).    
-00030cf0: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-00030d00: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
-00030d10: 2020 2020 2020 206c 6f67 6765 722e 6578         logger.ex
-00030d20: 6365 7074 696f 6e28 6529 0a20 2020 2020  ception(e).     
-00030d30: 2020 2020 2020 2069 6620 4c4f 475f 5044         if LOG_PD
-00030d40: 423a 0a20 2020 2020 2020 2020 2020 2020  B:.             
-00030d50: 2020 2069 6d70 6f72 7420 7064 620a 0a20     import pdb.. 
-00030d60: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00030d70: 6462 2e73 6574 5f74 7261 6365 2829 0a20  db.set_trace(). 
-00030d80: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00030d90: 0a0a 2020 2020 6465 6620 7661 6c69 6461  ..    def valida
-00030da0: 7465 5f73 7461 7465 2873 656c 662c 2061  te_state(self, a
-00030db0: 6c6c 6f77 5f6f 7665 726c 6170 3a20 626f  llow_overlap: bo
-00030dc0: 6f6c 203d 2046 616c 7365 2920 2d3e 204e  ol = False) -> N
-00030dd0: 6f6e 653a 0a20 2020 2020 2020 2076 616c  one:.        val
-00030de0: 6964 6174 655f 7374 6174 6528 7365 6c66  idate_state(self
-00030df0: 2e74 6173 6b73 2c20 7365 6c66 2e77 6f72  .tasks, self.wor
-00030e00: 6b65 7273 2c20 7365 6c66 2e63 6c69 656e  kers, self.clien
-00030e10: 7473 290a 0a20 2020 2020 2020 2069 6620  ts)..        if 
-00030e20: 6e6f 7420 2873 6574 2873 656c 662e 776f  not (set(self.wo
-00030e30: 726b 6572 7329 203d 3d20 7365 7428 7365  rkers) == set(se
-00030e40: 6c66 2e73 7472 6561 6d5f 636f 6d6d 7329  lf.stream_comms)
-00030e50: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-00030e60: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-00030e70: 2257 6f72 6b65 7273 206e 6f74 2074 6865  "Workers not the
-00030e80: 2073 616d 6520 696e 2061 6c6c 2063 6f6c   same in all col
-00030e90: 6c65 6374 696f 6e73 2229 0a0a 2020 2020  lections")..    
-00030ea0: 2020 2020 6173 7365 7274 2073 656c 662e      assert self.
-00030eb0: 7275 6e6e 696e 672e 6973 7375 7065 7273  running.issupers
-00030ec0: 6574 2873 656c 662e 6964 6c65 2e76 616c  et(self.idle.val
-00030ed0: 7565 7328 2929 2c20 280a 2020 2020 2020  ues()), (.      
-00030ee0: 2020 2020 2020 7365 6c66 2e72 756e 6e69        self.runni
-00030ef0: 6e67 2e63 6f70 7928 292c 0a20 2020 2020  ng.copy(),.     
-00030f00: 2020 2020 2020 2073 6574 2873 656c 662e         set(self.
-00030f10: 6964 6c65 2e76 616c 7565 7328 2929 2c0a  idle.values()),.
-00030f20: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00030f30: 2020 6173 7365 7274 2073 656c 662e 7275    assert self.ru
-00030f40: 6e6e 696e 672e 6973 7375 7065 7273 6574  nning.issuperset
-00030f50: 2873 656c 662e 6964 6c65 5f74 6173 6b5f  (self.idle_task_
-00030f60: 636f 756e 7429 2c20 280a 2020 2020 2020  count), (.      
-00030f70: 2020 2020 2020 7365 6c66 2e72 756e 6e69        self.runni
-00030f80: 6e67 2e63 6f70 7928 292c 0a20 2020 2020  ng.copy(),.     
-00030f90: 2020 2020 2020 2073 656c 662e 6964 6c65         self.idle
-00030fa0: 5f74 6173 6b5f 636f 756e 742e 636f 7079  _task_count.copy
-00030fb0: 2829 2c0a 2020 2020 2020 2020 290a 2020  (),.        ).  
-00030fc0: 2020 2020 2020 6173 7365 7274 2073 656c        assert sel
-00030fd0: 662e 7275 6e6e 696e 672e 6973 7375 7065  f.running.issupe
-00030fe0: 7273 6574 2873 656c 662e 7361 7475 7261  rset(self.satura
-00030ff0: 7465 6429 2c20 280a 2020 2020 2020 2020  ted), (.        
-00031000: 2020 2020 7365 6c66 2e72 756e 6e69 6e67      self.running
-00031010: 2e63 6f70 7928 292c 0a20 2020 2020 2020  .copy(),.       
-00031020: 2020 2020 2073 656c 662e 7361 7475 7261       self.satura
-00031030: 7465 642e 636f 7079 2829 2c0a 2020 2020  ted.copy(),.    
-00031040: 2020 2020 290a 2020 2020 2020 2020 6173      ).        as
-00031050: 7365 7274 2073 656c 662e 7361 7475 7261  sert self.satura
-00031060: 7465 642e 6973 6469 736a 6f69 6e74 2873  ted.isdisjoint(s
-00031070: 656c 662e 6964 6c65 2e76 616c 7565 7328  elf.idle.values(
-00031080: 2929 2c20 280a 2020 2020 2020 2020 2020  )), (.          
-00031090: 2020 7365 6c66 2e73 6174 7572 6174 6564    self.saturated
-000310a0: 2e63 6f70 7928 292c 0a20 2020 2020 2020  .copy(),.       
-000310b0: 2020 2020 2073 6574 2873 656c 662e 6964       set(self.id
-000310c0: 6c65 2e76 616c 7565 7328 2929 2c0a 2020  le.values()),.  
-000310d0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-000310e0: 2074 6173 6b5f 7072 6566 6978 5f63 6f75   task_prefix_cou
-000310f0: 6e74 733a 2064 6566 6175 6c74 6469 6374  nts: defaultdict
-00031100: 5b73 7472 2c20 696e 745d 203d 2064 6566  [str, int] = def
-00031110: 6175 6c74 6469 6374 2869 6e74 290a 2020  aultdict(int).  
-00031120: 2020 2020 2020 666f 7220 772c 2077 7320        for w, ws 
-00031130: 696e 2073 656c 662e 776f 726b 6572 732e  in self.workers.
-00031140: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
-00031150: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
-00031160: 7374 616e 6365 2877 2c20 7374 7229 2c20  stance(w, str), 
-00031170: 2874 7970 6528 7729 2c20 7729 0a20 2020  (type(w), w).   
-00031180: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00031190: 6973 696e 7374 616e 6365 2877 732c 2057  isinstance(ws, W
-000311a0: 6f72 6b65 7253 7461 7465 292c 2028 7479  orkerState), (ty
-000311b0: 7065 2877 7329 2c20 7773 290a 2020 2020  pe(ws), ws).    
-000311c0: 2020 2020 2020 2020 6173 7365 7274 2077          assert w
-000311d0: 732e 6164 6472 6573 7320 3d3d 2077 0a0a  s.address == w..
-000311e0: 2020 2020 2020 2020 2020 2020 6966 2077              if w
-000311f0: 732e 7374 6174 7573 203d 3d20 5374 6174  s.status == Stat
-00031200: 7573 2e72 756e 6e69 6e67 3a0a 2020 2020  us.running:.    
-00031210: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00031220: 7274 2077 7320 696e 2073 656c 662e 7275  rt ws in self.ru
-00031230: 6e6e 696e 670a 2020 2020 2020 2020 2020  nning.          
-00031240: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00031250: 2020 2020 2020 2020 6173 7365 7274 2077          assert w
-00031260: 7320 6e6f 7420 696e 2073 656c 662e 7275  s not in self.ru
-00031270: 6e6e 696e 670a 2020 2020 2020 2020 2020  nning.          
-00031280: 2020 2020 2020 6173 7365 7274 2077 732e        assert ws.
-00031290: 6164 6472 6573 7320 6e6f 7420 696e 2073  address not in s
-000312a0: 656c 662e 6964 6c65 0a20 2020 2020 2020  elf.idle.       
-000312b0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-000312c0: 7773 206e 6f74 2069 6e20 7365 6c66 2e73  ws not in self.s
-000312d0: 6174 7572 6174 6564 0a0a 2020 2020 2020  aturated..      
-000312e0: 2020 2020 2020 6173 7365 7274 2077 732e        assert ws.
-000312f0: 6c6f 6e67 5f72 756e 6e69 6e67 2e69 7373  long_running.iss
-00031300: 7562 7365 7428 7773 2e70 726f 6365 7373  ubset(ws.process
-00031310: 696e 6729 0a20 2020 2020 2020 2020 2020  ing).           
-00031320: 2069 6620 6e6f 7420 7773 2e70 726f 6365   if not ws.proce
-00031330: 7373 696e 673a 0a20 2020 2020 2020 2020  ssing:.         
-00031340: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
-00031350: 7420 7773 2e6f 6363 7570 616e 6379 0a20  t ws.occupancy. 
-00031360: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00031370: 6620 7773 2e73 7461 7475 7320 3d3d 2053  f ws.status == S
-00031380: 7461 7475 732e 7275 6e6e 696e 673a 0a20  tatus.running:. 
-00031390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000313a0: 2020 2061 7373 6572 7420 7773 2e61 6464     assert ws.add
-000313b0: 7265 7373 2069 6e20 7365 6c66 2e69 646c  ress in self.idl
-000313c0: 650a 2020 2020 2020 2020 2020 2020 6173  e.            as
-000313d0: 7365 7274 206e 6f74 2077 732e 6e65 6564  sert not ws.need
-000313e0: 735f 7768 6174 2e6b 6579 7328 2920 2620  s_what.keys() & 
-000313f0: 7773 2e68 6173 5f77 6861 740a 2020 2020  ws.has_what.    
-00031400: 2020 2020 2020 2020 6163 7475 616c 5f6e          actual_n
-00031410: 6565 6473 5f77 6861 743a 2064 6566 6175  eeds_what: defau
-00031420: 6c74 6469 6374 5b54 6173 6b53 7461 7465  ltdict[TaskState
-00031430: 2c20 696e 745d 203d 2064 6566 6175 6c74  , int] = default
-00031440: 6469 6374 2869 6e74 290a 2020 2020 2020  dict(int).      
-00031450: 2020 2020 2020 666f 7220 7473 2069 6e20        for ts in 
-00031460: 7773 2e70 726f 6365 7373 696e 673a 0a20  ws.processing:. 
-00031470: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00031480: 6f72 2074 7373 2069 6e20 7473 2e64 6570  or tss in ts.dep
-00031490: 656e 6465 6e63 6965 733a 0a20 2020 2020  endencies:.     
-000314a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000314b0: 6620 7473 7320 6e6f 7420 696e 2077 732e  f tss not in ws.
-000314c0: 6861 735f 7768 6174 3a0a 2020 2020 2020  has_what:.      
-000314d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000314e0: 2020 6163 7475 616c 5f6e 6565 6473 5f77    actual_needs_w
-000314f0: 6861 745b 7473 735d 202b 3d20 310a 2020  hat[tss] += 1.  
-00031500: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00031510: 2061 6374 7561 6c5f 6e65 6564 735f 7768   actual_needs_wh
-00031520: 6174 203d 3d20 7773 2e6e 6565 6473 5f77  at == ws.needs_w
-00031530: 6861 740a 2020 2020 2020 2020 2020 2020  hat.            
-00031540: 6173 7365 7274 2028 7773 2e73 7461 7475  assert (ws.statu
-00031550: 7320 3d3d 2053 7461 7475 732e 7275 6e6e  s == Status.runn
-00031560: 696e 6729 203d 3d20 2877 7320 696e 2073  ing) == (ws in s
-00031570: 656c 662e 7275 6e6e 696e 6729 0a20 2020  elf.running).   
-00031580: 2020 2020 2020 2020 2066 6f72 206e 616d           for nam
-00031590: 652c 2063 6f75 6e74 2069 6e20 7773 2e74  e, count in ws.t
-000315a0: 6173 6b5f 7072 6566 6978 5f63 6f75 6e74  ask_prefix_count
-000315b0: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
-000315c0: 2020 2020 2020 2020 2020 7461 736b 5f70            task_p
-000315d0: 7265 6669 785f 636f 756e 7473 5b6e 616d  refix_counts[nam
-000315e0: 655d 202b 3d20 636f 756e 740a 0a20 2020  e] += count..   
-000315f0: 2020 2020 2061 7373 6572 7420 7461 736b       assert task
-00031600: 5f70 7265 6669 785f 636f 756e 7473 2e6b  _prefix_counts.k
-00031610: 6579 7328 2920 3d3d 2073 656c 662e 5f74  eys() == self._t
-00031620: 6173 6b5f 7072 6566 6978 5f63 6f75 6e74  ask_prefix_count
-00031630: 5f67 6c6f 6261 6c2e 6b65 7973 2829 0a20  _global.keys(). 
-00031640: 2020 2020 2020 2066 6f72 206e 616d 652c         for name,
-00031650: 2067 6c6f 6261 6c5f 636f 756e 7420 696e   global_count in
-00031660: 2073 656c 662e 5f74 6173 6b5f 7072 6566   self._task_pref
-00031670: 6978 5f63 6f75 6e74 5f67 6c6f 6261 6c2e  ix_count_global.
-00031680: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
-00031690: 2020 2020 2061 7373 6572 7420 280a 2020       assert (.  
-000316a0: 2020 2020 2020 2020 2020 2020 2020 7461                ta
-000316b0: 736b 5f70 7265 6669 785f 636f 756e 7473  sk_prefix_counts
-000316c0: 5b6e 616d 655d 203d 3d20 676c 6f62 616c  [name] == global
-000316d0: 5f63 6f75 6e74 0a20 2020 2020 2020 2020  _count.         
-000316e0: 2020 2029 2c20 6622 7b6e 616d 657d 3a20     ), f"{name}: 
-000316f0: 7b74 6173 6b5f 7072 6566 6978 5f63 6f75  {task_prefix_cou
-00031700: 6e74 735b 6e61 6d65 5d7d 2028 7773 7329  nts[name]} (wss)
-00031710: 2c20 7b67 6c6f 6261 6c5f 636f 756e 747d  , {global_count}
-00031720: 2028 676c 6f62 616c 2922 0a0a 2020 2020   (global)"..    
-00031730: 2020 2020 666f 7220 7773 2069 6e20 7365      for ws in se
-00031740: 6c66 2e72 756e 6e69 6e67 3a0a 2020 2020  lf.running:.    
-00031750: 2020 2020 2020 2020 6173 7365 7274 2077          assert w
-00031760: 732e 7374 6174 7573 203d 3d20 5374 6174  s.status == Stat
-00031770: 7573 2e72 756e 6e69 6e67 0a20 2020 2020  us.running.     
-00031780: 2020 2020 2020 2061 7373 6572 7420 7773         assert ws
-00031790: 2e61 6464 7265 7373 2069 6e20 7365 6c66  .address in self
-000317a0: 2e77 6f72 6b65 7273 0a0a 2020 2020 2020  .workers..      
-000317b0: 2020 666f 7220 6b2c 2074 7320 696e 2073    for k, ts in s
-000317c0: 656c 662e 7461 736b 732e 6974 656d 7328  elf.tasks.items(
-000317d0: 293a 0a20 2020 2020 2020 2020 2020 2061  ):.            a
-000317e0: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
-000317f0: 2874 732c 2054 6173 6b53 7461 7465 292c  (ts, TaskState),
-00031800: 2028 7479 7065 2874 7329 2c20 7473 290a   (type(ts), ts).
-00031810: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00031820: 7274 2074 732e 6b65 7920 3d3d 206b 0a20  rt ts.key == k. 
-00031830: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00031840: 7420 626f 6f6c 2874 7320 696e 2073 656c  t bool(ts in sel
-00031850: 662e 7265 706c 6963 6174 6564 5f74 6173  f.replicated_tas
-00031860: 6b73 2920 3d3d 2028 6c65 6e28 7473 2e77  ks) == (len(ts.w
-00031870: 686f 5f68 6173 206f 7220 2829 2920 3e20  ho_has or ()) > 
-00031880: 3129 0a20 2020 2020 2020 2020 2020 2073  1).            s
-00031890: 656c 662e 7661 6c69 6461 7465 5f6b 6579  elf.validate_key
-000318a0: 286b 2c20 7473 290a 0a20 2020 2020 2020  (k, ts)..       
-000318b0: 2066 6f72 2074 7320 696e 2073 656c 662e   for ts in self.
-000318c0: 7265 706c 6963 6174 6564 5f74 6173 6b73  replicated_tasks
-000318d0: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
-000318e0: 7365 7274 2074 732e 7374 6174 6520 3d3d  sert ts.state ==
-000318f0: 2022 6d65 6d6f 7279 220a 2020 2020 2020   "memory".      
-00031900: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
-00031910: 6b65 7920 696e 2073 656c 662e 7461 736b  key in self.task
-00031920: 730a 0a20 2020 2020 2020 2066 6f72 2063  s..        for c
-00031930: 2c20 6373 2069 6e20 7365 6c66 2e63 6c69  , cs in self.cli
-00031940: 656e 7473 2e69 7465 6d73 2829 3a0a 2020  ents.items():.  
-00031950: 2020 2020 2020 2020 2020 2320 636c 6965            # clie
-00031960: 6e74 3d4e 6f6e 6520 6973 206f 6674 656e  nt=None is often
-00031970: 2075 7365 6420 696e 2074 6573 7473 2e2e   used in tests..
-00031980: 2e0a 2020 2020 2020 2020 2020 2020 6173  ..            as
-00031990: 7365 7274 2063 2069 7320 4e6f 6e65 206f  sert c is None o
-000319a0: 7220 7479 7065 2863 2920 3d3d 2073 7472  r type(c) == str
-000319b0: 2c20 2874 7970 6528 6329 2c20 6329 0a20  , (type(c), c). 
-000319c0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-000319d0: 7420 7479 7065 2863 7329 203d 3d20 436c  t type(cs) == Cl
-000319e0: 6965 6e74 5374 6174 652c 2028 7479 7065  ientState, (type
-000319f0: 2863 7329 2c20 6373 290a 2020 2020 2020  (cs), cs).      
-00031a00: 2020 2020 2020 6173 7365 7274 2063 732e        assert cs.
-00031a10: 636c 6965 6e74 5f6b 6579 203d 3d20 630a  client_key == c.
-00031a20: 0a20 2020 2020 2020 2061 203d 207b 773a  .        a = {w:
-00031a30: 2077 732e 6e62 7974 6573 2066 6f72 2077   ws.nbytes for w
-00031a40: 2c20 7773 2069 6e20 7365 6c66 2e77 6f72  , ws in self.wor
-00031a50: 6b65 7273 2e69 7465 6d73 2829 7d0a 2020  kers.items()}.  
-00031a60: 2020 2020 2020 6220 3d20 7b0a 2020 2020        b = {.    
-00031a70: 2020 2020 2020 2020 773a 2073 756d 2874          w: sum(t
-00031a80: 732e 6765 745f 6e62 7974 6573 2829 2066  s.get_nbytes() f
-00031a90: 6f72 2074 7320 696e 2077 732e 6861 735f  or ts in ws.has_
-00031aa0: 7768 6174 290a 2020 2020 2020 2020 2020  what).          
-00031ab0: 2020 666f 7220 772c 2077 7320 696e 2073    for w, ws in s
-00031ac0: 656c 662e 776f 726b 6572 732e 6974 656d  elf.workers.item
-00031ad0: 7328 290a 2020 2020 2020 2020 7d0a 2020  s().        }.  
-00031ae0: 2020 2020 2020 6173 7365 7274 2061 203d        assert a =
-00031af0: 3d20 622c 2028 612c 2062 290a 0a20 2020  = b, (a, b)..   
-00031b00: 2020 2020 2069 6620 7365 6c66 2e74 7261       if self.tra
-00031b10: 6e73 6974 696f 6e5f 636f 756e 7465 725f  nsition_counter_
-00031b20: 6d61 783a 0a20 2020 2020 2020 2020 2020  max:.           
-00031b30: 2061 7373 6572 7420 7365 6c66 2e74 7261   assert self.tra
-00031b40: 6e73 6974 696f 6e5f 636f 756e 7465 7220  nsition_counter 
-00031b50: 3c20 7365 6c66 2e74 7261 6e73 6974 696f  < self.transitio
-00031b60: 6e5f 636f 756e 7465 725f 6d61 780a 0a20  n_counter_max.. 
-00031b70: 2020 2023 2323 2323 2323 2323 2323 2323     #############
-00031b80: 2323 2323 2323 0a20 2020 2023 204d 616e  ######.    # Man
-00031b90: 6167 6520 4d65 7373 6167 6573 2023 0a20  age Messages #. 
-00031ba0: 2020 2023 2323 2323 2323 2323 2323 2323     #############
-00031bb0: 2323 2323 2323 0a0a 2020 2020 6465 6620  ######..    def 
-00031bc0: 7265 706f 7274 280a 2020 2020 2020 2020  report(.        
-00031bd0: 7365 6c66 2c20 6d73 673a 2064 6963 742c  self, msg: dict,
-00031be0: 2074 733a 2054 6173 6b53 7461 7465 207c   ts: TaskState |
-00031bf0: 204e 6f6e 6520 3d20 4e6f 6e65 2c20 636c   None = None, cl
-00031c00: 6965 6e74 3a20 7374 7220 7c20 4e6f 6e65  ient: str | None
-00031c10: 203d 204e 6f6e 650a 2020 2020 2920 2d3e   = None.    ) ->
-00031c20: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
-00031c30: 2222 0a20 2020 2020 2020 2050 7562 6c69  "".        Publi
-00031c40: 7368 2075 7064 6174 6573 2074 6f20 616c  sh updates to al
-00031c50: 6c20 6c69 7374 656e 696e 6720 5175 6575  l listening Queu
-00031c60: 6573 2061 6e64 2043 6f6d 6d73 0a0a 2020  es and Comms..  
-00031c70: 2020 2020 2020 4966 2074 6865 206d 6573        If the mes
-00031c80: 7361 6765 2063 6f6e 7461 696e 7320 6120  sage contains a 
-00031c90: 6b65 7920 7468 656e 2077 6520 6f6e 6c79  key then we only
-00031ca0: 2073 656e 6420 7468 6520 6d65 7373 6167   send the messag
-00031cb0: 6520 746f 2074 686f 7365 0a20 2020 2020  e to those.     
-00031cc0: 2020 2063 6f6d 6d73 2074 6861 7420 6361     comms that ca
-00031cd0: 7265 2061 626f 7574 2074 6865 206b 6579  re about the key
-00031ce0: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-00031cf0: 2020 2020 2020 6966 2074 7320 6973 204e        if ts is N
-00031d00: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00031d10: 206d 7367 5f6b 6579 203d 206d 7367 2e67   msg_key = msg.g
-00031d20: 6574 2822 6b65 7922 290a 2020 2020 2020  et("key").      
-00031d30: 2020 2020 2020 6966 206d 7367 5f6b 6579        if msg_key
-00031d40: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-00031d50: 2020 2020 2020 2020 2020 2020 2020 7473                ts
-00031d60: 203d 2073 656c 662e 7461 736b 732e 6765   = self.tasks.ge
-00031d70: 7428 6d73 675f 6b65 7929 0a0a 2020 2020  t(msg_key)..    
-00031d80: 2020 2020 6966 2074 7320 6973 204e 6f6e      if ts is Non
-00031d90: 6520 616e 6420 636c 6965 6e74 2069 7320  e and client is 
-00031da0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00031db0: 2020 2320 4e6f 7469 6679 2061 6c6c 2063    # Notify all c
-00031dc0: 6c69 656e 7473 0a20 2020 2020 2020 2020  lients.         
-00031dd0: 2020 2063 6c69 656e 745f 6b65 7973 203d     client_keys =
-00031de0: 206c 6973 7428 7365 6c66 2e63 6c69 656e   list(self.clien
-00031df0: 745f 636f 6d6d 7329 0a20 2020 2020 2020  t_comms).       
-00031e00: 2065 6c69 6620 7473 2069 7320 4e6f 6e65   elif ts is None
-00031e10: 3a0a 2020 2020 2020 2020 2020 2020 636c  :.            cl
-00031e20: 6965 6e74 5f6b 6579 7320 3d20 5b63 6c69  ient_keys = [cli
-00031e30: 656e 745d 0a20 2020 2020 2020 2065 6c73  ent].        els
-00031e40: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
-00031e50: 204e 6f74 6966 7920 636c 6965 6e74 7320   Notify clients 
-00031e60: 696e 7465 7265 7374 6564 2069 6e20 6b65  interested in ke
-00031e70: 7920 2869 6e63 6c75 6469 6e67 2060 636c  y (including `cl
-00031e80: 6965 6e74 6029 0a20 2020 2020 2020 2020  ient`).         
-00031e90: 2020 2023 204e 6f74 6520 7468 6174 2c20     # Note that, 
-00031ea0: 6966 2072 6570 6f72 7428 2920 7761 7320  if report() was 
-00031eb0: 6361 6c6c 6564 2062 7920 7570 6461 7465  called by update
-00031ec0: 5f67 7261 7068 2829 2c20 6063 6c69 656e  _graph(), `clien
-00031ed0: 7460 2077 6f6e 2774 2062 6520 696e 0a20  t` won't be in. 
-00031ee0: 2020 2020 2020 2020 2020 2023 2074 732e             # ts.
-00031ef0: 7768 6f5f 7761 6e74 7320 7965 742e 0a20  who_wants yet.. 
-00031f00: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
-00031f10: 745f 6b65 7973 203d 205b 0a20 2020 2020  t_keys = [.     
-00031f20: 2020 2020 2020 2020 2020 2063 732e 636c             cs.cl
-00031f30: 6965 6e74 5f6b 6579 2066 6f72 2063 7320  ient_key for cs 
-00031f40: 696e 2074 732e 7768 6f5f 7761 6e74 7320  in ts.who_wants 
-00031f50: 6f72 2028 2920 6966 2063 732e 636c 6965  or () if cs.clie
-00031f60: 6e74 5f6b 6579 2021 3d20 636c 6965 6e74  nt_key != client
-00031f70: 0a20 2020 2020 2020 2020 2020 205d 0a20  .            ]. 
-00031f80: 2020 2020 2020 2020 2020 2069 6620 636c             if cl
-00031f90: 6965 6e74 2069 7320 6e6f 7420 4e6f 6e65  ient is not None
-00031fa0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00031fb0: 2020 636c 6965 6e74 5f6b 6579 732e 6170    client_keys.ap
-00031fc0: 7065 6e64 2863 6c69 656e 7429 0a0a 2020  pend(client)..  
-00031fd0: 2020 2020 2020 666f 7220 6b20 696e 2063        for k in c
-00031fe0: 6c69 656e 745f 6b65 7973 3a0a 2020 2020  lient_keys:.    
-00031ff0: 2020 2020 2020 2020 6320 3d20 7365 6c66          c = self
-00032000: 2e63 6c69 656e 745f 636f 6d6d 732e 6765  .client_comms.ge
-00032010: 7428 6b29 0a20 2020 2020 2020 2020 2020  t(k).           
-00032020: 2069 6620 6320 6973 204e 6f6e 653a 0a20   if c is None:. 
-00032030: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00032040: 6f6e 7469 6e75 650a 2020 2020 2020 2020  ontinue.        
-00032050: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00032060: 2020 2020 2020 2020 2063 2e73 656e 6428           c.send(
-00032070: 6d73 6729 0a20 2020 2020 2020 2020 2020  msg).           
-00032080: 2020 2020 2023 206c 6f67 6765 722e 6465       # logger.de
-00032090: 6275 6728 2253 6368 6564 756c 6572 2073  bug("Scheduler s
-000320a0: 656e 6473 206d 6573 7361 6765 2074 6f20  ends message to 
-000320b0: 636c 6965 6e74 2025 733a 2025 7322 2c20  client %s: %s", 
-000320c0: 6b2c 206d 7367 290a 2020 2020 2020 2020  k, msg).        
-000320d0: 2020 2020 6578 6365 7074 2043 6f6d 6d43      except CommC
-000320e0: 6c6f 7365 6445 7272 6f72 3a0a 2020 2020  losedError:.    
-000320f0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00032100: 656c 662e 7374 6174 7573 203d 3d20 5374  elf.status == St
-00032110: 6174 7573 2e72 756e 6e69 6e67 3a0a 2020  atus.running:.  
-00032120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032130: 2020 6c6f 6767 6572 2e63 7269 7469 6361    logger.critica
-00032140: 6c28 0a20 2020 2020 2020 2020 2020 2020  l(.             
-00032150: 2020 2020 2020 2020 2020 2022 436c 6f73             "Clos
-00032160: 6564 2063 6f6d 6d20 2572 2077 6869 6c65  ed comm %r while
-00032170: 2074 7279 696e 6720 746f 2077 7269 7465   trying to write
-00032180: 2025 7322 2c20 632c 206d 7367 2c20 6578   %s", c, msg, ex
-00032190: 635f 696e 666f 3d54 7275 650a 2020 2020  c_info=True.    
-000321a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000321b0: 290a 0a20 2020 2061 7379 6e63 2064 6566  )..    async def
-000321c0: 2061 6464 5f63 6c69 656e 7428 0a20 2020   add_client(.   
-000321d0: 2020 2020 2073 656c 662c 2063 6f6d 6d3a       self, comm:
-000321e0: 2043 6f6d 6d2c 2063 6c69 656e 743a 2073   Comm, client: s
-000321f0: 7472 2c20 7665 7273 696f 6e73 3a20 6469  tr, versions: di
-00032200: 6374 5b73 7472 2c20 416e 795d 0a20 2020  ct[str, Any].   
-00032210: 2029 202d 3e20 4e6f 6e65 3a0a 2020 2020   ) -> None:.    
-00032220: 2020 2020 2222 2241 6464 2063 6c69 656e      """Add clien
-00032230: 7420 746f 206e 6574 776f 726b 0a0a 2020  t to network..  
-00032240: 2020 2020 2020 5765 206c 6973 7465 6e20        We listen 
-00032250: 746f 2061 6c6c 2066 7574 7572 6520 6d65  to all future me
-00032260: 7373 6167 6573 2066 726f 6d20 7468 6973  ssages from this
-00032270: 2043 6f6d 6d2e 0a20 2020 2020 2020 2022   Comm..        "
-00032280: 2222 0a20 2020 2020 2020 2061 7373 6572  "".        asser
-00032290: 7420 636c 6965 6e74 2069 7320 6e6f 7420  t client is not 
-000322a0: 4e6f 6e65 0a20 2020 2020 2020 2063 6f6d  None.        com
-000322b0: 6d2e 6e61 6d65 203d 2022 5363 6865 6475  m.name = "Schedu
-000322c0: 6c65 722d 3e43 6c69 656e 7422 0a20 2020  ler->Client".   
-000322d0: 2020 2020 206c 6f67 6765 722e 696e 666f       logger.info
-000322e0: 2822 5265 6365 6976 6520 636c 6965 6e74  ("Receive client
-000322f0: 2063 6f6e 6e65 6374 696f 6e3a 2025 7322   connection: %s"
-00032300: 2c20 636c 6965 6e74 290a 2020 2020 2020  , client).      
-00032310: 2020 7365 6c66 2e6c 6f67 5f65 7665 6e74    self.log_event
-00032320: 285b 2261 6c6c 222c 2063 6c69 656e 745d  (["all", client]
-00032330: 2c20 7b22 6163 7469 6f6e 223a 2022 6164  , {"action": "ad
-00032340: 642d 636c 6965 6e74 222c 2022 636c 6965  d-client", "clie
-00032350: 6e74 223a 2063 6c69 656e 747d 290a 2020  nt": client}).  
-00032360: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
-00032370: 7473 5b63 6c69 656e 745d 203d 2043 6c69  ts[client] = Cli
-00032380: 656e 7453 7461 7465 2863 6c69 656e 742c  entState(client,
-00032390: 2076 6572 7369 6f6e 733d 7665 7273 696f   versions=versio
-000323a0: 6e73 290a 0a20 2020 2020 2020 2066 6f72  ns)..        for
-000323b0: 2070 6c75 6769 6e20 696e 206c 6973 7428   plugin in list(
-000323c0: 7365 6c66 2e70 6c75 6769 6e73 2e76 616c  self.plugins.val
-000323d0: 7565 7328 2929 3a0a 2020 2020 2020 2020  ues()):.        
-000323e0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-000323f0: 2020 2020 2020 2020 2070 6c75 6769 6e2e           plugin.
-00032400: 6164 645f 636c 6965 6e74 2873 6368 6564  add_client(sched
-00032410: 756c 6572 3d73 656c 662c 2063 6c69 656e  uler=self, clien
-00032420: 743d 636c 6965 6e74 290a 2020 2020 2020  t=client).      
-00032430: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
-00032440: 6570 7469 6f6e 2061 7320 653a 0a20 2020  eption as e:.   
-00032450: 2020 2020 2020 2020 2020 2020 206c 6f67               log
-00032460: 6765 722e 6578 6365 7074 696f 6e28 6529  ger.exception(e)
-00032470: 0a0a 2020 2020 2020 2020 7472 793a 0a20  ..        try:. 
-00032480: 2020 2020 2020 2020 2020 2062 636f 6d6d             bcomm
-00032490: 203d 2042 6174 6368 6564 5365 6e64 2869   = BatchedSend(i
-000324a0: 6e74 6572 7661 6c3d 2232 6d73 222c 206c  nterval="2ms", l
-000324b0: 6f6f 703d 7365 6c66 2e6c 6f6f 7029 0a20  oop=self.loop). 
-000324c0: 2020 2020 2020 2020 2020 2062 636f 6d6d             bcomm
-000324d0: 2e73 7461 7274 2863 6f6d 6d29 0a20 2020  .start(comm).   
-000324e0: 2020 2020 2020 2020 2073 656c 662e 636c           self.cl
-000324f0: 6965 6e74 5f63 6f6d 6d73 5b63 6c69 656e  ient_comms[clien
-00032500: 745d 203d 2062 636f 6d6d 0a20 2020 2020  t] = bcomm.     
-00032510: 2020 2020 2020 206d 7367 203d 207b 226f         msg = {"o
-00032520: 7022 3a20 2273 7472 6561 6d2d 7374 6172  p": "stream-star
-00032530: 7422 7d0a 2020 2020 2020 2020 2020 2020  t"}.            
-00032540: 7665 7273 696f 6e5f 7761 726e 696e 6720  version_warning 
-00032550: 3d20 7665 7273 696f 6e5f 6d6f 6475 6c65  = version_module
-00032560: 2e65 7272 6f72 5f6d 6573 7361 6765 280a  .error_message(.
-00032570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032580: 7665 7273 696f 6e5f 6d6f 6475 6c65 2e67  version_module.g
-00032590: 6574 5f76 6572 7369 6f6e 7328 292c 0a20  et_versions(),. 
-000325a0: 2020 2020 2020 2020 2020 2020 2020 207b                 {
-000325b0: 773a 2077 732e 7665 7273 696f 6e73 2066  w: ws.versions f
-000325c0: 6f72 2077 2c20 7773 2069 6e20 7365 6c66  or w, ws in self
-000325d0: 2e77 6f72 6b65 7273 2e69 7465 6d73 2829  .workers.items()
-000325e0: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
-000325f0: 2020 2076 6572 7369 6f6e 732c 0a20 2020     versions,.   
-00032600: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00032610: 2020 2020 2020 206d 7367 2e75 7064 6174         msg.updat
-00032620: 6528 7665 7273 696f 6e5f 7761 726e 696e  e(version_warnin
-00032630: 6729 0a20 2020 2020 2020 2020 2020 2062  g).            b
-00032640: 636f 6d6d 2e73 656e 6428 6d73 6729 0a0a  comm.send(msg)..
-00032650: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-00032660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00032670: 2061 7761 6974 2073 656c 662e 6861 6e64   await self.hand
-00032680: 6c65 5f73 7472 6561 6d28 636f 6d6d 3d63  le_stream(comm=c
-00032690: 6f6d 6d2c 2065 7874 7261 3d7b 2263 6c69  omm, extra={"cli
-000326a0: 656e 7422 3a20 636c 6965 6e74 7d29 0a20  ent": client}). 
-000326b0: 2020 2020 2020 2020 2020 2066 696e 616c             final
-000326c0: 6c79 3a0a 2020 2020 2020 2020 2020 2020  ly:.            
-000326d0: 2020 2020 7365 6c66 2e72 656d 6f76 655f      self.remove_
-000326e0: 636c 6965 6e74 2863 6c69 656e 743d 636c  client(client=cl
-000326f0: 6965 6e74 2c20 7374 696d 756c 7573 5f69  ient, stimulus_i
-00032700: 643d 6622 7265 6d6f 7665 2d63 6c69 656e  d=f"remove-clien
-00032710: 742d 7b74 696d 6528 297d 2229 0a20 2020  t-{time()}").   
-00032720: 2020 2020 2020 2020 2020 2020 206c 6f67               log
-00032730: 6765 722e 6465 6275 6728 2246 696e 6973  ger.debug("Finis
-00032740: 6865 6420 6861 6e64 6c69 6e67 2063 6c69  hed handling cli
-00032750: 656e 7420 2573 222c 2063 6c69 656e 7429  ent %s", client)
-00032760: 0a20 2020 2020 2020 2066 696e 616c 6c79  .        finally
-00032770: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00032780: 206e 6f74 2063 6f6d 6d2e 636c 6f73 6564   not comm.closed
-00032790: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-000327a0: 2020 2020 7365 6c66 2e63 6c69 656e 745f      self.client_
-000327b0: 636f 6d6d 735b 636c 6965 6e74 5d2e 7365  comms[client].se
-000327c0: 6e64 287b 226f 7022 3a20 2273 7472 6561  nd({"op": "strea
-000327d0: 6d2d 636c 6f73 6564 227d 290a 2020 2020  m-closed"}).    
-000327e0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-000327f0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00032800: 6e6f 7420 6973 5f70 7974 686f 6e5f 7368  not is_python_sh
-00032810: 7574 7469 6e67 5f64 6f77 6e28 293a 0a20  utting_down():. 
-00032820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032830: 2020 2061 7761 6974 2073 656c 662e 636c     await self.cl
-00032840: 6965 6e74 5f63 6f6d 6d73 5b63 6c69 656e  ient_comms[clien
-00032850: 745d 2e63 6c6f 7365 2829 0a20 2020 2020  t].close().     
-00032860: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00032870: 656c 2073 656c 662e 636c 6965 6e74 5f63  el self.client_c
-00032880: 6f6d 6d73 5b63 6c69 656e 745d 0a20 2020  omms[client].   
-00032890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000328a0: 2069 6620 7365 6c66 2e73 7461 7475 7320   if self.status 
-000328b0: 3d3d 2053 7461 7475 732e 7275 6e6e 696e  == Status.runnin
-000328c0: 673a 0a20 2020 2020 2020 2020 2020 2020  g:.             
-000328d0: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-000328e0: 722e 696e 666f 2822 436c 6f73 6520 636c  r.info("Close cl
-000328f0: 6965 6e74 2063 6f6e 6e65 6374 696f 6e3a  ient connection:
-00032900: 2025 7322 2c20 636c 6965 6e74 290a 2020   %s", client).  
-00032910: 2020 2020 2020 2020 2020 6578 6365 7074            except
-00032920: 2054 7970 6545 7272 6f72 3a20 2023 2063   TypeError:  # c
-00032930: 6f6d 6d20 6265 636f 6d65 7320 4e6f 6e65  omm becomes None
-00032940: 2064 7572 696e 6720 4743 0a20 2020 2020   during GC.     
-00032950: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
-00032960: 0a20 2020 2064 6566 2072 656d 6f76 655f  .    def remove_
-00032970: 636c 6965 6e74 2873 656c 662c 2063 6c69  client(self, cli
-00032980: 656e 743a 2073 7472 2c20 7374 696d 756c  ent: str, stimul
-00032990: 7573 5f69 643a 2073 7472 207c 204e 6f6e  us_id: str | Non
-000329a0: 6520 3d20 4e6f 6e65 2920 2d3e 204e 6f6e  e = None) -> Non
-000329b0: 653a 0a20 2020 2020 2020 2022 2222 5265  e:.        """Re
-000329c0: 6d6f 7665 2063 6c69 656e 7420 6672 6f6d  move client from
-000329d0: 206e 6574 776f 726b 2222 220a 2020 2020   network""".    
-000329e0: 2020 2020 7374 696d 756c 7573 5f69 6420      stimulus_id 
-000329f0: 3d20 7374 696d 756c 7573 5f69 6420 6f72  = stimulus_id or
-00032a00: 2066 2272 656d 6f76 652d 636c 6965 6e74   f"remove-client
-00032a10: 2d7b 7469 6d65 2829 7d22 0a20 2020 2020  -{time()}".     
-00032a20: 2020 2069 6620 7365 6c66 2e73 7461 7475     if self.statu
-00032a30: 7320 3d3d 2053 7461 7475 732e 7275 6e6e  s == Status.runn
-00032a40: 696e 673a 0a20 2020 2020 2020 2020 2020  ing:.           
-00032a50: 206c 6f67 6765 722e 696e 666f 2822 5265   logger.info("Re
-00032a60: 6d6f 7665 2063 6c69 656e 7420 2573 222c  move client %s",
-00032a70: 2063 6c69 656e 7429 0a20 2020 2020 2020   client).       
-00032a80: 2073 656c 662e 6c6f 675f 6576 656e 7428   self.log_event(
-00032a90: 5b22 616c 6c22 2c20 636c 6965 6e74 5d2c  ["all", client],
-00032aa0: 207b 2261 6374 696f 6e22 3a20 2272 656d   {"action": "rem
-00032ab0: 6f76 652d 636c 6965 6e74 222c 2022 636c  ove-client", "cl
-00032ac0: 6965 6e74 223a 2063 6c69 656e 747d 290a  ient": client}).
-00032ad0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00032ae0: 2020 2020 2020 2020 2063 733a 2043 6c69           cs: Cli
-00032af0: 656e 7453 7461 7465 203d 2073 656c 662e  entState = self.
-00032b00: 636c 6965 6e74 735b 636c 6965 6e74 5d0a  clients[client].
-00032b10: 2020 2020 2020 2020 6578 6365 7074 204b          except K
-00032b20: 6579 4572 726f 723a 0a20 2020 2020 2020  eyError:.       
-00032b30: 2020 2020 2023 2058 5858 2069 7320 7468       # XXX is th
-00032b40: 6973 2061 206c 6567 6974 696d 6174 6520  is a legitimate 
-00032b50: 636f 6e64 6974 696f 6e3f 0a20 2020 2020  condition?.     
-00032b60: 2020 2020 2020 2070 6173 730a 2020 2020         pass.    
-00032b70: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00032b80: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
-00032b90: 745f 7265 6c65 6173 6573 5f6b 6579 7328  t_releases_keys(
-00032ba0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00032bb0: 206b 6579 733d 5b74 732e 6b65 7920 666f   keys=[ts.key fo
-00032bc0: 7220 7473 2069 6e20 6373 2e77 616e 7473  r ts in cs.wants
-00032bd0: 5f77 6861 745d 2c0a 2020 2020 2020 2020  _what],.        
-00032be0: 2020 2020 2020 2020 636c 6965 6e74 3d63          client=c
-00032bf0: 732e 636c 6965 6e74 5f6b 6579 2c0a 2020  s.client_key,.  
-00032c00: 2020 2020 2020 2020 2020 2020 2020 7374                st
-00032c10: 696d 756c 7573 5f69 643d 7374 696d 756c  imulus_id=stimul
-00032c20: 7573 5f69 642c 0a20 2020 2020 2020 2020  us_id,.         
-00032c30: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00032c40: 2064 656c 2073 656c 662e 636c 6965 6e74   del self.client
-00032c50: 735b 636c 6965 6e74 5d0a 0a20 2020 2020  s[client]..     
-00032c60: 2020 2020 2020 2066 6f72 2070 6c75 6769         for plugi
-00032c70: 6e20 696e 206c 6973 7428 7365 6c66 2e70  n in list(self.p
-00032c80: 6c75 6769 6e73 2e76 616c 7565 7328 2929  lugins.values())
-00032c90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00032ca0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00032cb0: 2020 2020 2020 2020 2020 2070 6c75 6769             plugi
-00032cc0: 6e2e 7265 6d6f 7665 5f63 6c69 656e 7428  n.remove_client(
-00032cd0: 7363 6865 6475 6c65 723d 7365 6c66 2c20  scheduler=self, 
-00032ce0: 636c 6965 6e74 3d63 6c69 656e 7429 0a20  client=client). 
-00032cf0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00032d00: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
-00032d10: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
-00032d20: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-00032d30: 2e65 7863 6570 7469 6f6e 2865 290a 0a20  .exception(e).. 
-00032d40: 2020 2020 2020 2061 7379 6e63 2064 6566         async def
-00032d50: 2072 656d 6f76 655f 636c 6965 6e74 5f66   remove_client_f
-00032d60: 726f 6d5f 6576 656e 7473 2829 202d 3e20  rom_events() -> 
-00032d70: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00032d80: 2020 2320 4966 2074 6865 2063 6c69 656e    # If the clien
-00032d90: 7420 6973 6e27 7420 7265 6769 7374 6572  t isn't register
-00032da0: 6564 2061 6e79 6d6f 7265 2061 6674 6572  ed anymore after
-00032db0: 2074 6865 2064 656c 6179 2c20 7265 6d6f   the delay, remo
-00032dc0: 7665 2066 726f 6d20 6576 656e 7473 0a20  ve from events. 
-00032dd0: 2020 2020 2020 2020 2020 2069 6620 636c             if cl
-00032de0: 6965 6e74 206e 6f74 2069 6e20 7365 6c66  ient not in self
-00032df0: 2e63 6c69 656e 7473 2061 6e64 2063 6c69  .clients and cli
-00032e00: 656e 7420 696e 2073 656c 662e 6576 656e  ent in self.even
-00032e10: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
-00032e20: 2020 2020 6465 6c20 7365 6c66 2e65 7665      del self.eve
-00032e30: 6e74 735b 636c 6965 6e74 5d0a 0a20 2020  nts[client]..   
-00032e40: 2020 2020 2063 6c65 616e 7570 5f64 656c       cleanup_del
-00032e50: 6179 203d 2070 6172 7365 5f74 696d 6564  ay = parse_timed
-00032e60: 656c 7461 280a 2020 2020 2020 2020 2020  elta(.          
-00032e70: 2020 6461 736b 2e63 6f6e 6669 672e 6765    dask.config.ge
-00032e80: 7428 2264 6973 7472 6962 7574 6564 2e73  t("distributed.s
-00032e90: 6368 6564 756c 6572 2e65 7665 6e74 732d  cheduler.events-
-00032ea0: 636c 6561 6e75 702d 6465 6c61 7922 290a  cleanup-delay").
-00032eb0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00032ec0: 2020 6966 206e 6f74 2073 656c 662e 5f6f    if not self._o
-00032ed0: 6e67 6f69 6e67 5f62 6163 6b67 726f 756e  ngoing_backgroun
-00032ee0: 645f 7461 736b 732e 636c 6f73 6564 3a0a  d_tasks.closed:.
-00032ef0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00032f00: 2e5f 6f6e 676f 696e 675f 6261 636b 6772  ._ongoing_backgr
-00032f10: 6f75 6e64 5f74 6173 6b73 2e63 616c 6c5f  ound_tasks.call_
-00032f20: 6c61 7465 7228 0a20 2020 2020 2020 2020  later(.         
-00032f30: 2020 2020 2020 2063 6c65 616e 7570 5f64         cleanup_d
-00032f40: 656c 6179 2c20 7265 6d6f 7665 5f63 6c69  elay, remove_cli
-00032f50: 656e 745f 6672 6f6d 5f65 7665 6e74 730a  ent_from_events.
-00032f60: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-00032f70: 2020 2064 6566 2073 656e 645f 7461 736b     def send_task
-00032f80: 5f74 6f5f 776f 726b 6572 280a 2020 2020  _to_worker(.    
-00032f90: 2020 2020 7365 6c66 2c20 776f 726b 6572      self, worker
-00032fa0: 3a20 7374 722c 2074 733a 2054 6173 6b53  : str, ts: TaskS
-00032fb0: 7461 7465 2c20 6475 7261 7469 6f6e 3a20  tate, duration: 
-00032fc0: 666c 6f61 7420 3d20 2d31 0a20 2020 2029  float = -1.    )
-00032fd0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00032fe0: 2020 2222 2253 656e 6420 6120 7369 6e67    """Send a sing
-00032ff0: 6c65 2063 6f6d 7075 7461 7469 6f6e 616c  le computational
-00033000: 2074 6173 6b20 746f 2061 2077 6f72 6b65   task to a worke
-00033010: 7222 2222 0a20 2020 2020 2020 2074 7279  r""".        try
-00033020: 3a0a 2020 2020 2020 2020 2020 2020 6d73  :.            ms
-00033030: 6720 3d20 7365 6c66 2e5f 7461 736b 5f74  g = self._task_t
-00033040: 6f5f 6d73 6728 7473 2c20 6475 7261 7469  o_msg(ts, durati
-00033050: 6f6e 290a 2020 2020 2020 2020 2020 2020  on).            
-00033060: 7365 6c66 2e77 6f72 6b65 725f 7365 6e64  self.worker_send
-00033070: 2877 6f72 6b65 722c 206d 7367 290a 2020  (worker, msg).  
-00033080: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
-00033090: 6570 7469 6f6e 2061 7320 653a 0a20 2020  eption as e:.   
-000330a0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-000330b0: 6578 6365 7074 696f 6e28 6529 0a20 2020  exception(e).   
-000330c0: 2020 2020 2020 2020 2069 6620 4c4f 475f           if LOG_
-000330d0: 5044 423a 0a20 2020 2020 2020 2020 2020  PDB:.           
-000330e0: 2020 2020 2069 6d70 6f72 7420 7064 620a       import pdb.
-000330f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00033100: 2070 6462 2e73 6574 5f74 7261 6365 2829   pdb.set_trace()
-00033110: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-00033120: 7365 0a0a 2020 2020 6465 6620 6861 6e64  se..    def hand
-00033130: 6c65 5f75 6e63 6175 6768 745f 6572 726f  le_uncaught_erro
-00033140: 7228 7365 6c66 2c20 2a2a 6d73 673a 2041  r(self, **msg: A
-00033150: 6e79 2920 2d3e 204e 6f6e 653a 0a20 2020  ny) -> None:.   
-00033160: 2020 2020 206c 6f67 6765 722e 6578 6365       logger.exce
-00033170: 7074 696f 6e28 636c 6561 6e5f 6578 6365  ption(clean_exce
-00033180: 7074 696f 6e28 2a2a 6d73 6729 5b31 5d29  ption(**msg)[1])
-00033190: 0a0a 2020 2020 6465 6620 6861 6e64 6c65  ..    def handle
-000331a0: 5f74 6173 6b5f 6669 6e69 7368 6564 280a  _task_finished(.
-000331b0: 2020 2020 2020 2020 7365 6c66 2c20 6b65          self, ke
-000331c0: 793a 204b 6579 2c20 776f 726b 6572 3a20  y: Key, worker: 
-000331d0: 7374 722c 2073 7469 6d75 6c75 735f 6964  str, stimulus_id
-000331e0: 3a20 7374 722c 202a 2a6d 7367 3a20 416e  : str, **msg: An
-000331f0: 790a 2020 2020 2920 2d3e 204e 6f6e 653a  y.    ) -> None:
-00033200: 0a20 2020 2020 2020 2069 6620 776f 726b  .        if work
-00033210: 6572 206e 6f74 2069 6e20 7365 6c66 2e77  er not in self.w
-00033220: 6f72 6b65 7273 3a0a 2020 2020 2020 2020  orkers:.        
-00033230: 2020 2020 7265 7475 726e 0a20 2020 2020      return.     
-00033240: 2020 2073 656c 662e 7661 6c69 6461 7465     self.validate
-00033250: 5f6b 6579 286b 6579 290a 0a20 2020 2020  _key(key)..     
-00033260: 2020 2072 3a20 7475 706c 6520 3d20 7365     r: tuple = se
-00033270: 6c66 2e73 7469 6d75 6c75 735f 7461 736b  lf.stimulus_task
-00033280: 5f66 696e 6973 6865 6428 0a20 2020 2020  _finished(.     
-00033290: 2020 2020 2020 206b 6579 3d6b 6579 2c20         key=key, 
-000332a0: 776f 726b 6572 3d77 6f72 6b65 722c 2073  worker=worker, s
-000332b0: 7469 6d75 6c75 735f 6964 3d73 7469 6d75  timulus_id=stimu
-000332c0: 6c75 735f 6964 2c20 2a2a 6d73 670a 2020  lus_id, **msg.  
-000332d0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000332e0: 7265 636f 6d6d 656e 6461 7469 6f6e 732c  recommendations,
-000332f0: 2063 6c69 656e 745f 6d73 6773 2c20 776f   client_msgs, wo
-00033300: 726b 6572 5f6d 7367 7320 3d20 720a 2020  rker_msgs = r.  
-00033310: 2020 2020 2020 7365 6c66 2e5f 7472 616e        self._tran
-00033320: 7369 7469 6f6e 7328 7265 636f 6d6d 656e  sitions(recommen
-00033330: 6461 7469 6f6e 732c 2063 6c69 656e 745f  dations, client_
-00033340: 6d73 6773 2c20 776f 726b 6572 5f6d 7367  msgs, worker_msg
-00033350: 732c 2073 7469 6d75 6c75 735f 6964 290a  s, stimulus_id).
-00033360: 2020 2020 2020 2020 7365 6c66 2e73 656e          self.sen
-00033370: 645f 616c 6c28 636c 6965 6e74 5f6d 7367  d_all(client_msg
-00033380: 732c 2077 6f72 6b65 725f 6d73 6773 290a  s, worker_msgs).
-00033390: 0a20 2020 2020 2020 2073 656c 662e 7374  .        self.st
-000333a0: 696d 756c 7573 5f71 7565 7565 5f73 6c6f  imulus_queue_slo
-000333b0: 7473 5f6d 6179 6265 5f6f 7065 6e65 6428  ts_maybe_opened(
-000333c0: 7374 696d 756c 7573 5f69 643d 7374 696d  stimulus_id=stim
-000333d0: 756c 7573 5f69 6429 0a0a 2020 2020 6465  ulus_id)..    de
-000333e0: 6620 6861 6e64 6c65 5f74 6173 6b5f 6572  f handle_task_er
-000333f0: 7265 6428 7365 6c66 2c20 6b65 793a 204b  red(self, key: K
-00033400: 6579 2c20 7374 696d 756c 7573 5f69 643a  ey, stimulus_id:
-00033410: 2073 7472 2c20 2a2a 6d73 673a 2041 6e79   str, **msg: Any
-00033420: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-00033430: 2020 2072 3a20 7475 706c 6520 3d20 7365     r: tuple = se
-00033440: 6c66 2e73 7469 6d75 6c75 735f 7461 736b  lf.stimulus_task
-00033450: 5f65 7272 6564 286b 6579 3d6b 6579 2c20  _erred(key=key, 
-00033460: 7374 696d 756c 7573 5f69 643d 7374 696d  stimulus_id=stim
-00033470: 756c 7573 5f69 642c 202a 2a6d 7367 290a  ulus_id, **msg).
-00033480: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
-00033490: 6461 7469 6f6e 732c 2063 6c69 656e 745f  dations, client_
-000334a0: 6d73 6773 2c20 776f 726b 6572 5f6d 7367  msgs, worker_msg
-000334b0: 7320 3d20 720a 2020 2020 2020 2020 7365  s = r.        se
-000334c0: 6c66 2e5f 7472 616e 7369 7469 6f6e 7328  lf._transitions(
-000334d0: 7265 636f 6d6d 656e 6461 7469 6f6e 732c  recommendations,
-000334e0: 2063 6c69 656e 745f 6d73 6773 2c20 776f   client_msgs, wo
-000334f0: 726b 6572 5f6d 7367 732c 2073 7469 6d75  rker_msgs, stimu
-00033500: 6c75 735f 6964 290a 2020 2020 2020 2020  lus_id).        
-00033510: 7365 6c66 2e73 656e 645f 616c 6c28 636c  self.send_all(cl
-00033520: 6965 6e74 5f6d 7367 732c 2077 6f72 6b65  ient_msgs, worke
-00033530: 725f 6d73 6773 290a 0a20 2020 2020 2020  r_msgs)..       
-00033540: 2073 656c 662e 7374 696d 756c 7573 5f71   self.stimulus_q
-00033550: 7565 7565 5f73 6c6f 7473 5f6d 6179 6265  ueue_slots_maybe
-00033560: 5f6f 7065 6e65 6428 7374 696d 756c 7573  _opened(stimulus
-00033570: 5f69 643d 7374 696d 756c 7573 5f69 6429  _id=stimulus_id)
-00033580: 0a0a 2020 2020 6465 6620 7265 6c65 6173  ..    def releas
-00033590: 655f 776f 726b 6572 5f64 6174 6128 7365  e_worker_data(se
-000335a0: 6c66 2c20 6b65 793a 204b 6579 2c20 776f  lf, key: Key, wo
-000335b0: 726b 6572 3a20 7374 722c 2073 7469 6d75  rker: str, stimu
-000335c0: 6c75 735f 6964 3a20 7374 7229 202d 3e20  lus_id: str) -> 
-000335d0: 4e6f 6e65 3a0a 2020 2020 2020 2020 7473  None:.        ts
-000335e0: 203d 2073 656c 662e 7461 736b 732e 6765   = self.tasks.ge
-000335f0: 7428 6b65 7929 0a20 2020 2020 2020 2077  t(key).        w
-00033600: 7320 3d20 7365 6c66 2e77 6f72 6b65 7273  s = self.workers
-00033610: 2e67 6574 2877 6f72 6b65 7229 0a20 2020  .get(worker).   
-00033620: 2020 2020 2069 6620 6e6f 7420 7473 206f       if not ts o
-00033630: 7220 6e6f 7420 7773 206f 7220 7773 206e  r not ws or ws n
-00033640: 6f74 2069 6e20 2874 732e 7768 6f5f 6861  ot in (ts.who_ha
-00033650: 7320 6f72 2028 2929 3a0a 2020 2020 2020  s or ()):.      
-00033660: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
-00033670: 2020 2020 2020 7365 6c66 2e72 656d 6f76        self.remov
-00033680: 655f 7265 706c 6963 6128 7473 2c20 7773  e_replica(ts, ws
-00033690: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
-000336a0: 2074 732e 7768 6f5f 6861 733a 0a20 2020   ts.who_has:.   
-000336b0: 2020 2020 2020 2020 2073 656c 662e 7472           self.tr
-000336c0: 616e 7369 7469 6f6e 7328 7b6b 6579 3a20  ansitions({key: 
-000336d0: 2272 656c 6561 7365 6422 7d2c 2073 7469  "released"}, sti
-000336e0: 6d75 6c75 735f 6964 290a 0a20 2020 2064  mulus_id)..    d
-000336f0: 6566 2068 616e 646c 655f 6c6f 6e67 5f72  ef handle_long_r
-00033700: 756e 6e69 6e67 280a 2020 2020 2020 2020  unning(.        
-00033710: 7365 6c66 2c20 6b65 793a 204b 6579 2c20  self, key: Key, 
-00033720: 776f 726b 6572 3a20 7374 722c 2063 6f6d  worker: str, com
-00033730: 7075 7465 5f64 7572 6174 696f 6e3a 2066  pute_duration: f
-00033740: 6c6f 6174 207c 204e 6f6e 652c 2073 7469  loat | None, sti
-00033750: 6d75 6c75 735f 6964 3a20 7374 720a 2020  mulus_id: str.  
-00033760: 2020 2920 2d3e 204e 6f6e 653a 0a20 2020    ) -> None:.   
-00033770: 2020 2020 2022 2222 4120 7461 736b 2068       """A task h
-00033780: 6173 2073 6563 6564 6564 2066 726f 6d20  as seceded from 
-00033790: 7468 6520 7468 7265 6164 2070 6f6f 6c0a  the thread pool.
-000337a0: 0a20 2020 2020 2020 2057 6520 7374 6f70  .        We stop
-000337b0: 2074 6865 2074 6173 6b20 6672 6f6d 2062   the task from b
-000337c0: 6569 6e67 2073 746f 6c65 6e20 696e 2074  eing stolen in t
-000337d0: 6865 2066 7574 7572 652c 2061 6e64 2063  he future, and c
-000337e0: 6861 6e67 6520 7461 736b 0a20 2020 2020  hange task.     
-000337f0: 2020 2064 7572 6174 696f 6e20 6163 636f     duration acco
-00033800: 756e 7469 6e67 2061 7320 6966 2074 6865  unting as if the
-00033810: 2074 6173 6b20 6861 7320 7374 6f70 7065   task has stoppe
-00033820: 642e 0a20 2020 2020 2020 2022 2222 0a20  d..        """. 
-00033830: 2020 2020 2020 2069 6620 6b65 7920 6e6f         if key no
-00033840: 7420 696e 2073 656c 662e 7461 736b 733a  t in self.tasks:
-00033850: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
-00033860: 6765 722e 6465 6275 6728 2253 6b69 7070  ger.debug("Skipp
-00033870: 696e 6720 6c6f 6e67 5f72 756e 6e69 6e67  ing long_running
-00033880: 2073 696e 6365 206b 6579 2025 7320 7761   since key %s wa
-00033890: 7320 616c 7265 6164 7920 7265 6c65 6173  s already releas
-000338a0: 6564 222c 206b 6579 290a 2020 2020 2020  ed", key).      
-000338b0: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
-000338c0: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
-000338d0: 6173 6b73 5b6b 6579 5d0a 2020 2020 2020  asks[key].      
-000338e0: 2020 7374 6561 6c20 3d20 7365 6c66 2e65    steal = self.e
-000338f0: 7874 656e 7369 6f6e 732e 6765 7428 2273  xtensions.get("s
-00033900: 7465 616c 696e 6722 290a 2020 2020 2020  tealing").      
-00033910: 2020 6966 2073 7465 616c 2069 7320 6e6f    if steal is no
-00033920: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-00033930: 2020 2020 7374 6561 6c2e 7265 6d6f 7665      steal.remove
-00033940: 5f6b 6579 5f66 726f 6d5f 7374 6561 6c61  _key_from_steala
-00033950: 626c 6528 7473 290a 0a20 2020 2020 2020  ble(ts)..       
-00033960: 2077 7320 3d20 7473 2e70 726f 6365 7373   ws = ts.process
-00033970: 696e 675f 6f6e 0a20 2020 2020 2020 2069  ing_on.        i
-00033980: 6620 7773 2069 7320 4e6f 6e65 3a0a 2020  f ws is None:.  
-00033990: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-000339a0: 2e64 6562 7567 2822 5265 6365 6976 6564  .debug("Received
-000339b0: 206c 6f6e 672d 7275 6e6e 696e 6720 7369   long-running si
-000339c0: 676e 616c 2066 726f 6d20 6475 706c 6963  gnal from duplic
-000339d0: 6174 6520 7461 736b 2e20 4967 6e6f 7269  ate task. Ignori
-000339e0: 6e67 2e22 290a 2020 2020 2020 2020 2020  ng.").          
-000339f0: 2020 7265 7475 726e 0a0a 2020 2020 2020    return..      
-00033a00: 2020 6966 2063 6f6d 7075 7465 5f64 7572    if compute_dur
-00033a10: 6174 696f 6e20 6973 206e 6f74 204e 6f6e  ation is not Non
-00033a20: 653a 0a20 2020 2020 2020 2020 2020 206f  e:.            o
-00033a30: 6c64 5f64 7572 6174 696f 6e20 3d20 7473  ld_duration = ts
-00033a40: 2e70 7265 6669 782e 6475 7261 7469 6f6e  .prefix.duration
-00033a50: 5f61 7665 7261 6765 0a20 2020 2020 2020  _average.       
-00033a60: 2020 2020 2069 6620 6f6c 645f 6475 7261       if old_dura
-00033a70: 7469 6f6e 203c 2030 3a0a 2020 2020 2020  tion < 0:.      
-00033a80: 2020 2020 2020 2020 2020 7473 2e70 7265            ts.pre
-00033a90: 6669 782e 6475 7261 7469 6f6e 5f61 7665  fix.duration_ave
-00033aa0: 7261 6765 203d 2063 6f6d 7075 7465 5f64  rage = compute_d
-00033ab0: 7572 6174 696f 6e0a 2020 2020 2020 2020  uration.        
-00033ac0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00033ad0: 2020 2020 2020 2020 2020 7473 2e70 7265            ts.pre
-00033ae0: 6669 782e 6475 7261 7469 6f6e 5f61 7665  fix.duration_ave
-00033af0: 7261 6765 203d 2028 6f6c 645f 6475 7261  rage = (old_dura
-00033b00: 7469 6f6e 202b 2063 6f6d 7075 7465 5f64  tion + compute_d
-00033b10: 7572 6174 696f 6e29 202f 2032 0a0a 2020  uration) / 2..  
-00033b20: 2020 2020 2020 7773 2e61 6464 5f74 6f5f        ws.add_to_
-00033b30: 6c6f 6e67 5f72 756e 6e69 6e67 2874 7329  long_running(ts)
-00033b40: 0a20 2020 2020 2020 2073 656c 662e 6368  .        self.ch
-00033b50: 6563 6b5f 6964 6c65 5f73 6174 7572 6174  eck_idle_saturat
-00033b60: 6564 2877 7329 0a0a 2020 2020 2020 2020  ed(ws)..        
-00033b70: 7365 6c66 2e73 7469 6d75 6c75 735f 7175  self.stimulus_qu
-00033b80: 6575 655f 736c 6f74 735f 6d61 7962 655f  eue_slots_maybe_
-00033b90: 6f70 656e 6564 2873 7469 6d75 6c75 735f  opened(stimulus_
-00033ba0: 6964 3d73 7469 6d75 6c75 735f 6964 290a  id=stimulus_id).
-00033bb0: 0a20 2020 2064 6566 2068 616e 646c 655f  .    def handle_
-00033bc0: 776f 726b 6572 5f73 7461 7475 735f 6368  worker_status_ch
-00033bd0: 616e 6765 280a 2020 2020 2020 2020 7365  ange(.        se
-00033be0: 6c66 2c20 7374 6174 7573 3a20 7374 7220  lf, status: str 
-00033bf0: 7c20 5374 6174 7573 2c20 776f 726b 6572  | Status, worker
-00033c00: 3a20 7374 7220 7c20 576f 726b 6572 5374  : str | WorkerSt
-00033c10: 6174 652c 2073 7469 6d75 6c75 735f 6964  ate, stimulus_id
-00033c20: 3a20 7374 720a 2020 2020 2920 2d3e 204e  : str.    ) -> N
-00033c30: 6f6e 653a 0a20 2020 2020 2020 2077 7320  one:.        ws 
-00033c40: 3d20 7365 6c66 2e77 6f72 6b65 7273 2e67  = self.workers.g
-00033c50: 6574 2877 6f72 6b65 7229 2069 6620 6973  et(worker) if is
-00033c60: 696e 7374 616e 6365 2877 6f72 6b65 722c  instance(worker,
-00033c70: 2073 7472 2920 656c 7365 2077 6f72 6b65   str) else worke
-00033c80: 720a 2020 2020 2020 2020 6966 206e 6f74  r.        if not
-00033c90: 2077 733a 0a20 2020 2020 2020 2020 2020   ws:.           
-00033ca0: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
-00033cb0: 7072 6576 5f73 7461 7475 7320 3d20 7773  prev_status = ws
-00033cc0: 2e73 7461 7475 730a 2020 2020 2020 2020  .status.        
-00033cd0: 7773 2e73 7461 7475 7320 3d20 5374 6174  ws.status = Stat
-00033ce0: 7573 5b73 7461 7475 735d 2069 6620 6973  us[status] if is
-00033cf0: 696e 7374 616e 6365 2873 7461 7475 732c  instance(status,
-00033d00: 2073 7472 2920 656c 7365 2073 7461 7475   str) else statu
-00033d10: 730a 2020 2020 2020 2020 6966 2077 732e  s.        if ws.
-00033d20: 7374 6174 7573 203d 3d20 7072 6576 5f73  status == prev_s
-00033d30: 7461 7475 733a 0a20 2020 2020 2020 2020  tatus:.         
-00033d40: 2020 2072 6574 7572 6e0a 0a20 2020 2020     return..     
-00033d50: 2020 2073 656c 662e 6c6f 675f 6576 656e     self.log_even
-00033d60: 7428 0a20 2020 2020 2020 2020 2020 2077  t(.            w
-00033d70: 732e 6164 6472 6573 732c 0a20 2020 2020  s.address,.     
-00033d80: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-00033d90: 2020 2020 2020 2020 2022 6163 7469 6f6e           "action
-00033da0: 223a 2022 776f 726b 6572 2d73 7461 7475  ": "worker-statu
-00033db0: 732d 6368 616e 6765 222c 0a20 2020 2020  s-change",.     
-00033dc0: 2020 2020 2020 2020 2020 2022 7072 6576             "prev
-00033dd0: 2d73 7461 7475 7322 3a20 7072 6576 5f73  -status": prev_s
-00033de0: 7461 7475 732e 6e61 6d65 2c0a 2020 2020  tatus.name,.    
-00033df0: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
-00033e00: 7475 7322 3a20 7773 2e73 7461 7475 732e  tus": ws.status.
-00033e10: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
-00033e20: 2020 2020 2020 2273 7469 6d75 6c75 735f        "stimulus_
-00033e30: 6964 223a 2073 7469 6d75 6c75 735f 6964  id": stimulus_id
-00033e40: 2c0a 2020 2020 2020 2020 2020 2020 7d2c  ,.            },
-00033e50: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00033e60: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
-00033e70: 6622 576f 726b 6572 2073 7461 7475 7320  f"Worker status 
-00033e80: 7b70 7265 765f 7374 6174 7573 2e6e 616d  {prev_status.nam
-00033e90: 657d 202d 3e20 7b73 7461 7475 737d 202d  e} -> {status} -
-00033ea0: 207b 7773 7d22 290a 0a20 2020 2020 2020   {ws}")..       
-00033eb0: 2069 6620 7773 2e73 7461 7475 7320 3d3d   if ws.status ==
-00033ec0: 2053 7461 7475 732e 7275 6e6e 696e 673a   Status.running:
-00033ed0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00033ee0: 662e 7275 6e6e 696e 672e 6164 6428 7773  f.running.add(ws
-00033ef0: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
-00033f00: 6c66 2e63 6865 636b 5f69 646c 655f 7361  lf.check_idle_sa
-00033f10: 7475 7261 7465 6428 7773 290a 2020 2020  turated(ws).    
-00033f20: 2020 2020 2020 2020 7365 6c66 2e74 7261          self.tra
-00033f30: 6e73 6974 696f 6e73 280a 2020 2020 2020  nsitions(.      
-00033f40: 2020 2020 2020 2020 2020 7365 6c66 2e62            self.b
-00033f50: 756c 6b5f 7363 6865 6475 6c65 5f75 6e72  ulk_schedule_unr
-00033f60: 756e 6e61 626c 655f 6166 7465 725f 6164  unnable_after_ad
-00033f70: 6469 6e67 5f77 6f72 6b65 7228 7773 292c  ding_worker(ws),
-00033f80: 2073 7469 6d75 6c75 735f 6964 0a20 2020   stimulus_id.   
-00033f90: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00033fa0: 2020 2020 2020 2073 656c 662e 7374 696d         self.stim
-00033fb0: 756c 7573 5f71 7565 7565 5f73 6c6f 7473  ulus_queue_slots
-00033fc0: 5f6d 6179 6265 5f6f 7065 6e65 6428 7374  _maybe_opened(st
-00033fd0: 696d 756c 7573 5f69 643d 7374 696d 756c  imulus_id=stimul
-00033fe0: 7573 5f69 6429 0a20 2020 2020 2020 2065  us_id).        e
-00033ff0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00034000: 2073 656c 662e 7275 6e6e 696e 672e 6469   self.running.di
-00034010: 7363 6172 6428 7773 290a 2020 2020 2020  scard(ws).      
-00034020: 2020 2020 2020 7365 6c66 2e69 646c 652e        self.idle.
-00034030: 706f 7028 7773 2e61 6464 7265 7373 2c20  pop(ws.address, 
-00034040: 4e6f 6e65 290a 2020 2020 2020 2020 2020  None).          
-00034050: 2020 7365 6c66 2e69 646c 655f 7461 736b    self.idle_task
-00034060: 5f63 6f75 6e74 2e64 6973 6361 7264 2877  _count.discard(w
-00034070: 7329 0a20 2020 2020 2020 2020 2020 2073  s).            s
-00034080: 656c 662e 7361 7475 7261 7465 642e 6469  elf.saturated.di
-00034090: 7363 6172 6428 7773 290a 0a20 2020 2064  scard(ws)..    d
-000340a0: 6566 2068 616e 646c 655f 7265 7175 6573  ef handle_reques
-000340b0: 745f 7265 6672 6573 685f 7768 6f5f 6861  t_refresh_who_ha
-000340c0: 7328 0a20 2020 2020 2020 2073 656c 662c  s(.        self,
-000340d0: 206b 6579 733a 2049 7465 7261 626c 655b   keys: Iterable[
-000340e0: 4b65 795d 2c20 776f 726b 6572 3a20 7374  Key], worker: st
-000340f0: 722c 2073 7469 6d75 6c75 735f 6964 3a20  r, stimulus_id: 
-00034100: 7374 720a 2020 2020 2920 2d3e 204e 6f6e  str.    ) -> Non
-00034110: 653a 0a20 2020 2020 2020 2022 2222 5265  e:.        """Re
-00034120: 7175 6573 7420 6672 6f6d 2061 2057 6f72  quest from a Wor
-00034130: 6b65 7220 746f 2072 6566 7265 7368 2074  ker to refresh t
-00034140: 6865 0a20 2020 2020 2020 2077 686f 5f68  he.        who_h
-00034150: 6173 2066 6f72 2073 6f6d 6520 6b65 7973  as for some keys
-00034160: 2e20 4e6f 7420 746f 2062 6520 636f 6e66  . Not to be conf
-00034170: 7573 6564 2077 6974 6820 7363 6865 6475  used with schedu
-00034180: 6c65 722e 7768 6f5f 6861 732c 2077 6869  ler.who_has, whi
-00034190: 6368 0a20 2020 2020 2020 2069 7320 6120  ch.        is a 
-000341a0: 6465 6469 6361 7465 6420 636f 6d6d 2052  dedicated comm R
-000341b0: 5043 2072 6571 7565 7374 2066 726f 6d20  PC request from 
-000341c0: 6120 436c 6965 6e74 2e0a 2020 2020 2020  a Client..      
-000341d0: 2020 2222 220a 2020 2020 2020 2020 7768    """.        wh
-000341e0: 6f5f 6861 7320 3d20 7b7d 0a20 2020 2020  o_has = {}.     
-000341f0: 2020 2066 7265 655f 6b65 7973 203d 205b     free_keys = [
-00034200: 5d0a 2020 2020 2020 2020 666f 7220 6b65  ].        for ke
-00034210: 7920 696e 206b 6579 733a 0a20 2020 2020  y in keys:.     
-00034220: 2020 2020 2020 2069 6620 6b65 7920 696e         if key in
-00034230: 2073 656c 662e 7461 736b 733a 0a20 2020   self.tasks:.   
-00034240: 2020 2020 2020 2020 2020 2020 2077 686f               who
-00034250: 5f68 6173 5b6b 6579 5d20 3d20 5b77 732e  _has[key] = [ws.
-00034260: 6164 6472 6573 7320 666f 7220 7773 2069  address for ws i
-00034270: 6e20 7365 6c66 2e74 6173 6b73 5b6b 6579  n self.tasks[key
-00034280: 5d2e 7768 6f5f 6861 7320 6f72 2028 295d  ].who_has or ()]
-00034290: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-000342a0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-000342b0: 2020 2066 7265 655f 6b65 7973 2e61 7070     free_keys.app
-000342c0: 656e 6428 6b65 7929 0a0a 2020 2020 2020  end(key)..      
-000342d0: 2020 6966 2077 686f 5f68 6173 3a0a 2020    if who_has:.  
-000342e0: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
-000342f0: 7472 6561 6d5f 636f 6d6d 735b 776f 726b  tream_comms[work
-00034300: 6572 5d2e 7365 6e64 280a 2020 2020 2020  er].send(.      
-00034310: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
-00034320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034330: 226f 7022 3a20 2272 6566 7265 7368 2d77  "op": "refresh-w
-00034340: 686f 2d68 6173 222c 0a20 2020 2020 2020  ho-has",.       
-00034350: 2020 2020 2020 2020 2020 2020 2022 7768               "wh
-00034360: 6f5f 6861 7322 3a20 7768 6f5f 6861 732c  o_has": who_has,
-00034370: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00034380: 2020 2020 2022 7374 696d 756c 7573 5f69       "stimulus_i
-00034390: 6422 3a20 7374 696d 756c 7573 5f69 642c  d": stimulus_id,
-000343a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000343b0: 207d 0a20 2020 2020 2020 2020 2020 2029   }.            )
-000343c0: 0a20 2020 2020 2020 2069 6620 6672 6565  .        if free
-000343d0: 5f6b 6579 733a 0a20 2020 2020 2020 2020  _keys:.         
-000343e0: 2020 2073 656c 662e 7374 7265 616d 5f63     self.stream_c
-000343f0: 6f6d 6d73 5b77 6f72 6b65 725d 2e73 656e  omms[worker].sen
-00034400: 6428 0a20 2020 2020 2020 2020 2020 2020  d(.             
-00034410: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-00034420: 2020 2020 2020 2020 2022 6f70 223a 2022           "op": "
-00034430: 6672 6565 2d6b 6579 7322 2c0a 2020 2020  free-keys",.    
-00034440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034450: 226b 6579 7322 3a20 6672 6565 5f6b 6579  "keys": free_key
-00034460: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-00034470: 2020 2020 2020 2022 7374 696d 756c 7573         "stimulus
-00034480: 5f69 6422 3a20 7374 696d 756c 7573 5f69  _id": stimulus_i
-00034490: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
-000344a0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-000344b0: 2029 0a0a 2020 2020 6173 796e 6320 6465   )..    async de
-000344c0: 6620 6861 6e64 6c65 5f77 6f72 6b65 7228  f handle_worker(
-000344d0: 7365 6c66 2c20 636f 6d6d 3a20 436f 6d6d  self, comm: Comm
-000344e0: 2c20 776f 726b 6572 3a20 7374 7229 202d  , worker: str) -
-000344f0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-00034500: 2222 220a 2020 2020 2020 2020 4c69 7374  """.        List
-00034510: 656e 2074 6f20 7265 7370 6f6e 7365 7320  en to responses 
-00034520: 6672 6f6d 2061 2073 696e 676c 6520 776f  from a single wo
-00034530: 726b 6572 0a0a 2020 2020 2020 2020 5468  rker..        Th
-00034540: 6973 2069 7320 7468 6520 6d61 696e 206c  is is the main l
-00034550: 6f6f 7020 666f 7220 7363 6865 6475 6c65  oop for schedule
-00034560: 722d 776f 726b 6572 2069 6e74 6572 6163  r-worker interac
-00034570: 7469 6f6e 0a0a 2020 2020 2020 2020 5365  tion..        Se
-00034580: 6520 416c 736f 0a20 2020 2020 2020 202d  e Also.        -
-00034590: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
-000345a0: 5363 6865 6475 6c65 722e 6861 6e64 6c65  Scheduler.handle
-000345b0: 5f63 6c69 656e 743a 2045 7175 6976 616c  _client: Equival
-000345c0: 656e 7420 636f 726f 7574 696e 6520 666f  ent coroutine fo
-000345d0: 7220 636c 6965 6e74 730a 2020 2020 2020  r clients.      
-000345e0: 2020 2222 220a 2020 2020 2020 2020 636f    """.        co
-000345f0: 6d6d 2e6e 616d 6520 3d20 2253 6368 6564  mm.name = "Sched
-00034600: 756c 6572 2063 6f6e 6e65 6374 696f 6e20  uler connection 
-00034610: 746f 2077 6f72 6b65 7222 0a20 2020 2020  to worker".     
-00034620: 2020 2077 6f72 6b65 725f 636f 6d6d 203d     worker_comm =
-00034630: 2073 656c 662e 7374 7265 616d 5f63 6f6d   self.stream_com
-00034640: 6d73 5b77 6f72 6b65 725d 0a20 2020 2020  ms[worker].     
-00034650: 2020 2077 6f72 6b65 725f 636f 6d6d 2e73     worker_comm.s
-00034660: 7461 7274 2863 6f6d 6d29 0a20 2020 2020  tart(comm).     
-00034670: 2020 206c 6f67 6765 722e 696e 666f 2822     logger.info("
-00034680: 5374 6172 7469 6e67 2077 6f72 6b65 7220  Starting worker 
-00034690: 636f 6d70 7574 6520 7374 7265 616d 2c20  compute stream, 
-000346a0: 2573 222c 2077 6f72 6b65 7229 0a20 2020  %s", worker).   
-000346b0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-000346c0: 2020 2020 2020 6177 6169 7420 7365 6c66        await self
-000346d0: 2e68 616e 646c 655f 7374 7265 616d 2863  .handle_stream(c
-000346e0: 6f6d 6d3d 636f 6d6d 2c20 6578 7472 613d  omm=comm, extra=
-000346f0: 7b22 776f 726b 6572 223a 2077 6f72 6b65  {"worker": worke
-00034700: 727d 290a 2020 2020 2020 2020 6669 6e61  r}).        fina
-00034710: 6c6c 793a 0a20 2020 2020 2020 2020 2020  lly:.           
-00034720: 2069 6620 776f 726b 6572 2069 6e20 7365   if worker in se
-00034730: 6c66 2e73 7472 6561 6d5f 636f 6d6d 733a  lf.stream_comms:
-00034740: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00034750: 2077 6f72 6b65 725f 636f 6d6d 2e61 626f   worker_comm.abo
-00034760: 7274 2829 0a20 2020 2020 2020 2020 2020  rt().           
-00034770: 2020 2020 2061 7761 6974 2073 656c 662e       await self.
-00034780: 7265 6d6f 7665 5f77 6f72 6b65 7228 0a20  remove_worker(. 
-00034790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000347a0: 2020 2077 6f72 6b65 722c 2073 7469 6d75     worker, stimu
-000347b0: 6c75 735f 6964 3d66 2268 616e 646c 652d  lus_id=f"handle-
-000347c0: 776f 726b 6572 2d63 6c65 616e 7570 2d7b  worker-cleanup-{
-000347d0: 7469 6d65 2829 7d22 0a20 2020 2020 2020  time()}".       
-000347e0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-000347f0: 6465 6620 6164 645f 706c 7567 696e 280a  def add_plugin(.
-00034800: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
-00034810: 2020 2020 2020 706c 7567 696e 3a20 5363        plugin: Sc
-00034820: 6865 6475 6c65 7250 6c75 6769 6e2c 0a20  hedulerPlugin,. 
-00034830: 2020 2020 2020 202a 2c0a 2020 2020 2020         *,.      
-00034840: 2020 6964 656d 706f 7465 6e74 3a20 626f    idempotent: bo
-00034850: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
-00034860: 2020 2020 6e61 6d65 3a20 7374 7220 7c20      name: str | 
-00034870: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
-00034880: 2020 2020 202a 2a6b 7761 7267 733a 2041       **kwargs: A
-00034890: 6e79 2c0a 2020 2020 2920 2d3e 204e 6f6e  ny,.    ) -> Non
-000348a0: 653a 0a20 2020 2020 2020 2022 2222 4164  e:.        """Ad
-000348b0: 6420 6578 7465 726e 616c 2070 6c75 6769  d external plugi
-000348c0: 6e20 746f 2073 6368 6564 756c 6572 2e0a  n to scheduler..
-000348d0: 0a20 2020 2020 2020 2053 6565 2068 7474  .        See htt
-000348e0: 7073 3a2f 2f64 6973 7472 6962 7574 6564  ps://distributed
-000348f0: 2e72 6561 6474 6865 646f 6373 2e69 6f2f  .readthedocs.io/
-00034900: 656e 2f6c 6174 6573 742f 706c 7567 696e  en/latest/plugin
-00034910: 732e 6874 6d6c 0a0a 2020 2020 2020 2020  s.html..        
-00034920: 5061 7261 6d65 7465 7273 0a20 2020 2020  Parameters.     
-00034930: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
-00034940: 2020 2020 2020 706c 7567 696e 203a 2053        plugin : S
-00034950: 6368 6564 756c 6572 506c 7567 696e 0a20  chedulerPlugin. 
-00034960: 2020 2020 2020 2020 2020 2053 6368 6564             Sched
-00034970: 756c 6572 506c 7567 696e 2069 6e73 7461  ulerPlugin insta
-00034980: 6e63 6520 746f 2061 6464 0a20 2020 2020  nce to add.     
-00034990: 2020 2069 6465 6d70 6f74 656e 7420 3a20     idempotent : 
-000349a0: 626f 6f6c 0a20 2020 2020 2020 2020 2020  bool.           
-000349b0: 2049 6620 7472 7565 2c20 7468 6520 706c   If true, the pl
-000349c0: 7567 696e 2069 7320 6173 7375 6d65 6420  ugin is assumed 
-000349d0: 746f 2061 6c72 6561 6479 2065 7869 7374  to already exist
-000349e0: 2061 6e64 206e 6f0a 2020 2020 2020 2020   and no.        
-000349f0: 2020 2020 6163 7469 6f6e 2069 7320 7461      action is ta
-00034a00: 6b65 6e2e 0a20 2020 2020 2020 206e 616d  ken..        nam
-00034a10: 6520 3a20 7374 720a 2020 2020 2020 2020  e : str.        
-00034a20: 2020 2020 4120 6e61 6d65 2066 6f72 2074      A name for t
-00034a30: 6865 2070 6c75 6769 6e2c 2069 6620 4e6f  he plugin, if No
-00034a40: 6e65 2c20 7468 6520 6e61 6d65 2061 7474  ne, the name att
-00034a50: 7269 6275 7465 2069 730a 2020 2020 2020  ribute is.      
-00034a60: 2020 2020 2020 6368 6563 6b65 6420 6f6e        checked on
-00034a70: 2074 6865 2050 6c75 6769 6e20 696e 7374   the Plugin inst
-00034a80: 616e 6365 2061 6e64 2067 656e 6572 6174  ance and generat
-00034a90: 6564 2069 6620 6e6f 740a 2020 2020 2020  ed if not.      
-00034aa0: 2020 2020 2020 6469 7363 6f76 6572 6564        discovered
-00034ab0: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-00034ac0: 2020 2020 2020 6966 206e 616d 6520 6973        if name is
-00034ad0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00034ae0: 2020 206e 616d 6520 3d20 5f67 6574 5f70     name = _get_p
-00034af0: 6c75 6769 6e5f 6e61 6d65 2870 6c75 6769  lugin_name(plugi
-00034b00: 6e29 0a0a 2020 2020 2020 2020 6966 206e  n)..        if n
-00034b10: 616d 6520 696e 2073 656c 662e 706c 7567  ame in self.plug
-00034b20: 696e 733a 0a20 2020 2020 2020 2020 2020  ins:.           
-00034b30: 2069 6620 6964 656d 706f 7465 6e74 3a0a   if idempotent:.
-00034b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034b50: 7265 7475 726e 0a20 2020 2020 2020 2020  return.         
-00034b60: 2020 2077 6172 6e69 6e67 732e 7761 726e     warnings.warn
-00034b70: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00034b80: 2020 6622 5363 6865 6475 6c65 7220 616c    f"Scheduler al
-00034b90: 7265 6164 7920 636f 6e74 6169 6e73 2061  ready contains a
-00034ba0: 2070 6c75 6769 6e20 7769 7468 206e 616d   plugin with nam
-00034bb0: 6520 7b6e 616d 657d 3b20 6f76 6572 7772  e {name}; overwr
-00034bc0: 6974 696e 672e 222c 0a20 2020 2020 2020  iting.",.       
-00034bd0: 2020 2020 2020 2020 2063 6174 6567 6f72           categor
-00034be0: 793d 5573 6572 5761 726e 696e 672c 0a20  y=UserWarning,. 
-00034bf0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-00034c00: 2020 2020 2020 7061 7261 6d65 7465 7273        parameters
-00034c10: 203d 2069 6e73 7065 6374 2e73 6967 6e61   = inspect.signa
-00034c20: 7475 7265 2870 6c75 6769 6e2e 7265 6d6f  ture(plugin.remo
-00034c30: 7665 5f77 6f72 6b65 7229 2e70 6172 616d  ve_worker).param
-00034c40: 6574 6572 730a 2020 2020 2020 2020 6966  eters.        if
-00034c50: 206e 6f74 2061 6e79 2870 2e6b 696e 6420   not any(p.kind 
-00034c60: 6973 2070 2e56 4152 5f4b 4559 574f 5244  is p.VAR_KEYWORD
-00034c70: 2066 6f72 2070 2069 6e20 7061 7261 6d65   for p in parame
-00034c80: 7465 7273 2e76 616c 7565 7328 2929 3a0a  ters.values()):.
-00034c90: 2020 2020 2020 2020 2020 2020 7761 726e              warn
-00034ca0: 696e 6773 2e77 6172 6e28 0a20 2020 2020  ings.warn(.     
-00034cb0: 2020 2020 2020 2020 2020 2022 5468 6520             "The 
-00034cc0: 7369 676e 6174 7572 6520 6f66 2060 5363  signature of `Sc
-00034cd0: 6865 6475 6c65 7250 6c75 6769 6e2e 7265  hedulerPlugin.re
-00034ce0: 6d6f 7665 5f77 6f72 6b65 7260 206e 6f77  move_worker` now
-00034cf0: 2072 6571 7569 7265 7320 602a 2a6b 7761   requires `**kwa
-00034d00: 7267 7360 2022 0a20 2020 2020 2020 2020  rgs` ".         
-00034d10: 2020 2020 2020 2022 746f 2065 6e73 7572         "to ensur
-00034d20: 6520 7468 6174 2070 6c75 6769 6e73 2072  e that plugins r
-00034d30: 656d 6169 6e20 666f 7277 6172 642d 636f  emain forward-co
-00034d40: 6d70 6174 6962 6c65 2e20 4e6f 7420 696e  mpatible. Not in
-00034d50: 636c 7564 696e 6720 220a 2020 2020 2020  cluding ".      
-00034d60: 2020 2020 2020 2020 2020 2260 2a2a 6b77            "`**kw
-00034d70: 6172 6773 6020 696e 2074 6865 2073 6967  args` in the sig
-00034d80: 6e61 7475 7265 2077 696c 6c20 6e6f 206c  nature will no l
-00034d90: 6f6e 6765 7220 6265 2073 7570 706f 7274  onger be support
-00034da0: 6564 2069 6e20 6675 7475 7265 2076 6572  ed in future ver
-00034db0: 7369 6f6e 732e 222c 0a20 2020 2020 2020  sions.",.       
-00034dc0: 2020 2020 2020 2020 2046 7574 7572 6557           FutureW
-00034dd0: 6172 6e69 6e67 2c0a 2020 2020 2020 2020  arning,.        
-00034de0: 2020 2020 290a 0a20 2020 2020 2020 2073      )..        s
-00034df0: 656c 662e 706c 7567 696e 735b 6e61 6d65  elf.plugins[name
-00034e00: 5d20 3d20 706c 7567 696e 0a0a 2020 2020  ] = plugin..    
-00034e10: 6465 6620 7265 6d6f 7665 5f70 6c75 6769  def remove_plugi
-00034e20: 6e28 7365 6c66 2c20 6e61 6d65 3a20 7374  n(self, name: st
-00034e30: 7220 7c20 4e6f 6e65 203d 204e 6f6e 6529  r | None = None)
-00034e40: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00034e50: 2020 2222 2252 656d 6f76 6520 6578 7465    """Remove exte
-00034e60: 726e 616c 2070 6c75 6769 6e20 6672 6f6d  rnal plugin from
-00034e70: 2073 6368 6564 756c 6572 0a0a 2020 2020   scheduler..    
-00034e80: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
-00034e90: 2020 2020 2020 202d 2d2d 2d2d 2d2d 2d2d         ---------
-00034ea0: 2d0a 2020 2020 2020 2020 6e61 6d65 203a  -.        name :
-00034eb0: 2073 7472 0a20 2020 2020 2020 2020 2020   str.           
-00034ec0: 204e 616d 6520 6f66 2074 6865 2070 6c75   Name of the plu
-00034ed0: 6769 6e20 746f 2072 656d 6f76 650a 2020  gin to remove.  
-00034ee0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00034ef0: 2020 6173 7365 7274 206e 616d 6520 6973    assert name is
-00034f00: 206e 6f74 204e 6f6e 650a 0a20 2020 2020   not None..     
-00034f10: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00034f20: 2020 2020 6465 6c20 7365 6c66 2e70 6c75      del self.plu
-00034f30: 6769 6e73 5b6e 616d 655d 0a20 2020 2020  gins[name].     
-00034f40: 2020 2065 7863 6570 7420 4b65 7945 7272     except KeyErr
-00034f50: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
-00034f60: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-00034f70: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00034f80: 2020 6622 436f 756c 6420 6e6f 7420 6669    f"Could not fi
-00034f90: 6e64 2070 6c75 6769 6e20 7b6e 616d 6521  nd plugin {name!
-00034fa0: 727d 2061 6d6f 6e67 2074 6865 2063 7572  r} among the cur
-00034fb0: 7265 6e74 2073 6368 6564 756c 6572 2070  rent scheduler p
-00034fc0: 6c75 6769 6e73 220a 2020 2020 2020 2020  lugins".        
-00034fd0: 2020 2020 290a 0a20 2020 2061 7379 6e63      )..    async
-00034fe0: 2064 6566 2072 6567 6973 7465 725f 7363   def register_sc
-00034ff0: 6865 6475 6c65 725f 706c 7567 696e 280a  heduler_plugin(.
-00035000: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
-00035010: 2020 2020 2020 706c 7567 696e 3a20 6279        plugin: by
-00035020: 7465 7320 7c20 5363 6865 6475 6c65 7250  tes | SchedulerP
-00035030: 6c75 6769 6e2c 0a20 2020 2020 2020 206e  lugin,.        n
-00035040: 616d 653a 2073 7472 207c 204e 6f6e 6520  ame: str | None 
-00035050: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-00035060: 6964 656d 706f 7465 6e74 3a20 626f 6f6c  idempotent: bool
-00035070: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
-00035080: 2020 2020 2920 2d3e 204e 6f6e 653a 0a20      ) -> None:. 
-00035090: 2020 2020 2020 2022 2222 5265 6769 7374         """Regist
-000350a0: 6572 2061 2070 6c75 6769 6e20 6f6e 2074  er a plugin on t
-000350b0: 6865 2073 6368 6564 756c 6572 2e22 2222  he scheduler."""
-000350c0: 0a20 2020 2020 2020 2069 6620 6964 656d  .        if idem
-000350d0: 706f 7465 6e74 2069 7320 4e6f 6e65 3a0a  potent is None:.
-000350e0: 2020 2020 2020 2020 2020 2020 7761 726e              warn
-000350f0: 696e 6773 2e77 6172 6e28 0a20 2020 2020  ings.warn(.     
-00035100: 2020 2020 2020 2020 2020 2022 5468 6520             "The 
-00035110: 7369 676e 6174 7572 6520 6f66 2060 5363  signature of `Sc
-00035120: 6865 6475 6c65 722e 7265 6769 7374 6572  heduler.register
-00035130: 5f73 6368 6564 756c 6572 5f70 6c75 6769  _scheduler_plugi
-00035140: 6e60 206e 6f77 2072 6571 7569 7265 7320  n` now requires 
-00035150: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00035160: 2020 2260 6964 656d 706f 7465 6e74 602e    "`idempotent`.
-00035170: 204e 6f74 2069 6e63 6c75 6469 6e67 2060   Not including `
-00035180: 6964 656d 706f 7465 6e74 6020 696e 2074  idempotent` in t
-00035190: 6865 2073 6967 6e61 7475 7265 2077 696c  he signature wil
-000351a0: 6c20 6e6f 206c 6f6e 6765 7220 220a 2020  l no longer ".  
-000351b0: 2020 2020 2020 2020 2020 2020 2020 2262                "b
-000351c0: 6520 7375 7070 6f72 7465 6420 696e 2066  e supported in f
-000351d0: 7574 7572 6520 7665 7273 696f 6e73 2e22  uture versions."
-000351e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000351f0: 2020 4675 7475 7265 5761 726e 696e 672c    FutureWarning,
-00035200: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00035210: 2020 2020 2020 2020 2020 2069 6465 6d70             idemp
-00035220: 6f74 656e 7420 3d20 4661 6c73 650a 2020  otent = False.  
-00035230: 2020 2020 2020 6966 206e 6f74 2069 7369        if not isi
-00035240: 6e73 7461 6e63 6528 706c 7567 696e 2c20  nstance(plugin, 
-00035250: 5363 6865 6475 6c65 7250 6c75 6769 6e29  SchedulerPlugin)
-00035260: 3a0a 2020 2020 2020 2020 2020 2020 706c  :.            pl
-00035270: 7567 696e 203d 206c 6f61 6473 2870 6c75  ugin = loads(plu
-00035280: 6769 6e29 0a20 2020 2020 2020 2020 2020  gin).           
-00035290: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
-000352a0: 6365 2870 6c75 6769 6e2c 2053 6368 6564  ce(plugin, Sched
-000352b0: 756c 6572 506c 7567 696e 290a 0a20 2020  ulerPlugin)..   
-000352c0: 2020 2020 2069 6620 6e61 6d65 2069 7320       if name is 
-000352d0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-000352e0: 2020 6e61 6d65 203d 205f 6765 745f 706c    name = _get_pl
-000352f0: 7567 696e 5f6e 616d 6528 706c 7567 696e  ugin_name(plugin
-00035300: 290a 0a20 2020 2020 2020 2069 6620 6e61  )..        if na
-00035310: 6d65 2069 6e20 7365 6c66 2e70 6c75 6769  me in self.plugi
-00035320: 6e73 2061 6e64 2069 6465 6d70 6f74 656e  ns and idempoten
-00035330: 743a 0a20 2020 2020 2020 2020 2020 2072  t:.            r
-00035340: 6574 7572 6e0a 0a20 2020 2020 2020 2069  eturn..        i
-00035350: 6620 6861 7361 7474 7228 706c 7567 696e  f hasattr(plugin
-00035360: 2c20 2273 7461 7274 2229 3a0a 2020 2020  , "start"):.    
-00035370: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
-00035380: 2070 6c75 6769 6e2e 7374 6172 7428 7365   plugin.start(se
-00035390: 6c66 290a 2020 2020 2020 2020 2020 2020  lf).            
-000353a0: 6966 2069 6e73 7065 6374 2e69 7361 7761  if inspect.isawa
-000353b0: 6974 6162 6c65 2872 6573 756c 7429 3a0a  itable(result):.
-000353c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000353d0: 6177 6169 7420 7265 7375 6c74 0a0a 2020  await result..  
-000353e0: 2020 2020 2020 7365 6c66 2e61 6464 5f70        self.add_p
-000353f0: 6c75 6769 6e28 706c 7567 696e 2c20 6e61  lugin(plugin, na
-00035400: 6d65 3d6e 616d 652c 2069 6465 6d70 6f74  me=name, idempot
-00035410: 656e 743d 6964 656d 706f 7465 6e74 290a  ent=idempotent).
-00035420: 0a20 2020 2061 7379 6e63 2064 6566 2075  .    async def u
-00035430: 6e72 6567 6973 7465 725f 7363 6865 6475  nregister_schedu
-00035440: 6c65 725f 706c 7567 696e 2873 656c 662c  ler_plugin(self,
-00035450: 206e 616d 653a 2073 7472 2920 2d3e 204e   name: str) -> N
-00035460: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
-00035470: 556e 7265 6769 7374 6572 2061 2070 6c75  Unregister a plu
-00035480: 6769 6e20 6f6e 2074 6865 2073 6368 6564  gin on the sched
-00035490: 756c 6572 2e22 2222 0a20 2020 2020 2020  uler.""".       
-000354a0: 2073 656c 662e 7265 6d6f 7665 5f70 6c75   self.remove_plu
-000354b0: 6769 6e28 6e61 6d65 290a 0a20 2020 2064  gin(name)..    d
-000354c0: 6566 2077 6f72 6b65 725f 7365 6e64 2873  ef worker_send(s
-000354d0: 656c 662c 2077 6f72 6b65 723a 2073 7472  elf, worker: str
-000354e0: 2c20 6d73 673a 2064 6963 745b 7374 722c  , msg: dict[str,
-000354f0: 2041 6e79 5d29 202d 3e20 4e6f 6e65 3a0a   Any]) -> None:.
-00035500: 2020 2020 2020 2020 2222 2253 656e 6420          """Send 
-00035510: 6d65 7373 6167 6520 746f 2077 6f72 6b65  message to worke
-00035520: 720a 0a20 2020 2020 2020 2054 6869 7320  r..        This 
-00035530: 616c 736f 2068 616e 646c 6573 2063 6f6e  also handles con
-00035540: 6e65 6374 696f 6e20 6661 696c 7572 6573  nection failures
-00035550: 2062 7920 6164 6469 6e67 2061 2063 616c   by adding a cal
-00035560: 6c62 6163 6b20 746f 2072 656d 6f76 650a  lback to remove.
-00035570: 2020 2020 2020 2020 7468 6520 776f 726b          the work
-00035580: 6572 206f 6e20 7468 6520 6e65 7874 2063  er on the next c
-00035590: 7963 6c65 2e0a 2020 2020 2020 2020 2222  ycle..        ""
-000355a0: 220a 2020 2020 2020 2020 7472 793a 0a20  ".        try:. 
-000355b0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000355c0: 7374 7265 616d 5f63 6f6d 6d73 5b77 6f72  stream_comms[wor
-000355d0: 6b65 725d 2e73 656e 6428 6d73 6729 0a20  ker].send(msg). 
-000355e0: 2020 2020 2020 2065 7863 6570 7420 2843         except (C
-000355f0: 6f6d 6d43 6c6f 7365 6445 7272 6f72 2c20  ommClosedError, 
-00035600: 4174 7472 6962 7574 6545 7272 6f72 293a  AttributeError):
-00035610: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00035620: 662e 5f6f 6e67 6f69 6e67 5f62 6163 6b67  f._ongoing_backg
-00035630: 726f 756e 645f 7461 736b 732e 6361 6c6c  round_tasks.call
-00035640: 5f73 6f6f 6e28 0a20 2020 2020 2020 2020  _soon(.         
-00035650: 2020 2020 2020 2073 656c 662e 7265 6d6f         self.remo
-00035660: 7665 5f77 6f72 6b65 722c 2020 2320 7479  ve_worker,  # ty
-00035670: 7065 3a20 6967 6e6f 7265 5b61 7267 2d74  pe: ignore[arg-t
-00035680: 7970 655d 0a20 2020 2020 2020 2020 2020  ype].           
-00035690: 2020 2020 2061 6464 7265 7373 3d77 6f72       address=wor
-000356a0: 6b65 722c 0a20 2020 2020 2020 2020 2020  ker,.           
-000356b0: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
-000356c0: 3d66 2277 6f72 6b65 722d 7365 6e64 2d63  =f"worker-send-c
-000356d0: 6f6d 6d2d 6661 696c 2d7b 7469 6d65 2829  omm-fail-{time()
-000356e0: 7d22 2c0a 2020 2020 2020 2020 2020 2020  }",.            
-000356f0: 290a 0a20 2020 2064 6566 2063 6c69 656e  )..    def clien
-00035700: 745f 7365 6e64 2873 656c 662c 2063 6c69  t_send(self, cli
-00035710: 656e 742c 206d 7367 293a 0a20 2020 2020  ent, msg):.     
-00035720: 2020 2022 2222 5365 6e64 206d 6573 7361     """Send messa
-00035730: 6765 2074 6f20 636c 6965 6e74 2222 220a  ge to client""".
-00035740: 2020 2020 2020 2020 6320 3d20 7365 6c66          c = self
-00035750: 2e63 6c69 656e 745f 636f 6d6d 732e 6765  .client_comms.ge
-00035760: 7428 636c 6965 6e74 290a 2020 2020 2020  t(client).      
-00035770: 2020 6966 2063 2069 7320 4e6f 6e65 3a0a    if c is None:.
-00035780: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00035790: 726e 0a20 2020 2020 2020 2074 7279 3a0a  rn.        try:.
-000357a0: 2020 2020 2020 2020 2020 2020 632e 7365              c.se
-000357b0: 6e64 286d 7367 290a 2020 2020 2020 2020  nd(msg).        
-000357c0: 6578 6365 7074 2043 6f6d 6d43 6c6f 7365  except CommClose
-000357d0: 6445 7272 6f72 3a0a 2020 2020 2020 2020  dError:.        
-000357e0: 2020 2020 6966 2073 656c 662e 7374 6174      if self.stat
-000357f0: 7573 203d 3d20 5374 6174 7573 2e72 756e  us == Status.run
-00035800: 6e69 6e67 3a0a 2020 2020 2020 2020 2020  ning:.          
-00035810: 2020 2020 2020 6c6f 6767 6572 2e63 7269        logger.cri
-00035820: 7469 6361 6c28 0a20 2020 2020 2020 2020  tical(.         
-00035830: 2020 2020 2020 2020 2020 2022 436c 6f73             "Clos
-00035840: 6564 2063 6f6d 6d20 2572 2077 6869 6c65  ed comm %r while
-00035850: 2074 7279 696e 6720 746f 2077 7269 7465   trying to write
-00035860: 2025 7322 2c20 632c 206d 7367 2c20 6578   %s", c, msg, ex
-00035870: 635f 696e 666f 3d54 7275 650a 2020 2020  c_info=True.    
-00035880: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-00035890: 2020 2064 6566 2073 656e 645f 616c 6c28     def send_all(
-000358a0: 7365 6c66 2c20 636c 6965 6e74 5f6d 7367  self, client_msg
-000358b0: 733a 204d 7367 732c 2077 6f72 6b65 725f  s: Msgs, worker_
-000358c0: 6d73 6773 3a20 4d73 6773 2920 2d3e 204e  msgs: Msgs) -> N
-000358d0: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
-000358e0: 5365 6e64 206d 6573 7361 6765 7320 746f  Send messages to
-000358f0: 2063 6c69 656e 7420 616e 6420 776f 726b   client and work
-00035900: 6572 7322 2222 0a0a 2020 2020 2020 2020  ers"""..        
-00035910: 666f 7220 636c 6965 6e74 2c20 6d73 6773  for client, msgs
-00035920: 2069 6e20 636c 6965 6e74 5f6d 7367 732e   in client_msgs.
-00035930: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
-00035940: 2020 2020 2063 203d 2073 656c 662e 636c       c = self.cl
-00035950: 6965 6e74 5f63 6f6d 6d73 2e67 6574 2863  ient_comms.get(c
-00035960: 6c69 656e 7429 0a20 2020 2020 2020 2020  lient).         
-00035970: 2020 2069 6620 6320 6973 204e 6f6e 653a     if c is None:
-00035980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00035990: 2063 6f6e 7469 6e75 650a 2020 2020 2020   continue.      
-000359a0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-000359b0: 2020 2020 2020 2020 2020 2063 2e73 656e             c.sen
-000359c0: 6428 2a6d 7367 7329 0a20 2020 2020 2020  d(*msgs).       
-000359d0: 2020 2020 2065 7863 6570 7420 436f 6d6d       except Comm
-000359e0: 436c 6f73 6564 4572 726f 723a 0a20 2020  ClosedError:.   
-000359f0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00035a00: 7365 6c66 2e73 7461 7475 7320 3d3d 2053  self.status == S
-00035a10: 7461 7475 732e 7275 6e6e 696e 673a 0a20  tatus.running:. 
-00035a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035a30: 2020 206c 6f67 6765 722e 6372 6974 6963     logger.critic
-00035a40: 616c 280a 2020 2020 2020 2020 2020 2020  al(.            
-00035a50: 2020 2020 2020 2020 2020 2020 2243 6c6f              "Clo
-00035a60: 7365 6420 636f 6d6d 2025 7220 7768 696c  sed comm %r whil
-00035a70: 6520 7472 7969 6e67 2074 6f20 7772 6974  e trying to writ
-00035a80: 6520 2573 222c 0a20 2020 2020 2020 2020  e %s",.         
-00035a90: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00035aa0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00035ab0: 2020 2020 2020 2020 2020 6d73 6773 2c0a            msgs,.
-00035ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035ad0: 2020 2020 2020 2020 6578 635f 696e 666f          exc_info
-00035ae0: 3d54 7275 652c 0a20 2020 2020 2020 2020  =True,.         
-00035af0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-00035b00: 2020 2020 2020 666f 7220 776f 726b 6572        for worker
-00035b10: 2c20 6d73 6773 2069 6e20 776f 726b 6572  , msgs in worker
-00035b20: 5f6d 7367 732e 6974 656d 7328 293a 0a20  _msgs.items():. 
-00035b30: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-00035b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035b50: 7720 3d20 7365 6c66 2e73 7472 6561 6d5f  w = self.stream_
-00035b60: 636f 6d6d 735b 776f 726b 6572 5d0a 2020  comms[worker].  
-00035b70: 2020 2020 2020 2020 2020 2020 2020 772e                w.
-00035b80: 7365 6e64 282a 6d73 6773 290a 2020 2020  send(*msgs).    
-00035b90: 2020 2020 2020 2020 6578 6365 7074 204b          except K
-00035ba0: 6579 4572 726f 723a 0a20 2020 2020 2020  eyError:.       
-00035bb0: 2020 2020 2020 2020 2023 2077 6f72 6b65           # worke
-00035bc0: 7220 616c 7265 6164 7920 676f 6e65 0a20  r already gone. 
-00035bd0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00035be0: 6173 730a 2020 2020 2020 2020 2020 2020  ass.            
-00035bf0: 6578 6365 7074 2028 436f 6d6d 436c 6f73  except (CommClos
-00035c00: 6564 4572 726f 722c 2041 7474 7269 6275  edError, Attribu
-00035c10: 7465 4572 726f 7229 3a0a 2020 2020 2020  teError):.      
-00035c20: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-00035c30: 6f6e 676f 696e 675f 6261 636b 6772 6f75  ongoing_backgrou
-00035c40: 6e64 5f74 6173 6b73 2e63 616c 6c5f 736f  nd_tasks.call_so
-00035c50: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
-00035c60: 2020 2020 2020 2020 7365 6c66 2e72 656d          self.rem
-00035c70: 6f76 655f 776f 726b 6572 2c20 2023 2074  ove_worker,  # t
-00035c80: 7970 653a 2069 676e 6f72 655b 6172 672d  ype: ignore[arg-
-00035c90: 7479 7065 5d0a 2020 2020 2020 2020 2020  type].          
-00035ca0: 2020 2020 2020 2020 2020 6164 6472 6573            addres
-00035cb0: 733d 776f 726b 6572 2c0a 2020 2020 2020  s=worker,.      
-00035cc0: 2020 2020 2020 2020 2020 2020 2020 7374                st
-00035cd0: 696d 756c 7573 5f69 643d 6622 7365 6e64  imulus_id=f"send
-00035ce0: 2d61 6c6c 2d63 6f6d 6d2d 6661 696c 2d7b  -all-comm-fail-{
-00035cf0: 7469 6d65 2829 7d22 2c0a 2020 2020 2020  time()}",.      
-00035d00: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-00035d10: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
-00035d20: 2323 2323 2323 2323 2323 2323 230a 2020  #############.  
-00035d30: 2020 2320 4c65 7373 2063 6f6d 6d6f 6e20    # Less common 
-00035d40: 696e 7465 7261 6374 696f 6e73 2023 0a20  interactions #. 
-00035d50: 2020 2023 2323 2323 2323 2323 2323 2323     #############
-00035d60: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
-00035d70: 0a20 2020 2061 7379 6e63 2064 6566 2073  .    async def s
-00035d80: 6361 7474 6572 280a 2020 2020 2020 2020  catter(.        
-00035d90: 7365 6c66 2c0a 2020 2020 2020 2020 636f  self,.        co
-00035da0: 6d6d 3d4e 6f6e 652c 0a20 2020 2020 2020  mm=None,.       
-00035db0: 2064 6174 613d 4e6f 6e65 2c0a 2020 2020   data=None,.    
-00035dc0: 2020 2020 776f 726b 6572 733d 4e6f 6e65      workers=None
-00035dd0: 2c0a 2020 2020 2020 2020 636c 6965 6e74  ,.        client
-00035de0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2062  =None,.        b
-00035df0: 726f 6164 6361 7374 3d46 616c 7365 2c0a  roadcast=False,.
-00035e00: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
-00035e10: 322c 0a20 2020 2029 3a0a 2020 2020 2020  2,.    ):.      
-00035e20: 2020 2222 2253 656e 6420 6461 7461 206f    """Send data o
-00035e30: 7574 2074 6f20 776f 726b 6572 730a 0a20  ut to workers.. 
-00035e40: 2020 2020 2020 2053 6565 2061 6c73 6f0a         See also.
-00035e50: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
-00035e60: 0a20 2020 2020 2020 2053 6368 6564 756c  .        Schedul
-00035e70: 6572 2e62 726f 6164 6361 7374 3a0a 2020  er.broadcast:.  
-00035e80: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00035e90: 2020 7374 6172 7420 3d20 7469 6d65 2829    start = time()
-00035ea0: 0a20 2020 2020 2020 2077 6869 6c65 2054  .        while T
-00035eb0: 7275 653a 0a20 2020 2020 2020 2020 2020  rue:.           
-00035ec0: 2069 6620 776f 726b 6572 7320 6973 204e   if workers is N
-00035ed0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00035ee0: 2020 2020 2077 7373 203d 2073 656c 662e       wss = self.
-00035ef0: 7275 6e6e 696e 670a 2020 2020 2020 2020  running.        
-00035f00: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00035f10: 2020 2020 2020 2020 2020 776f 726b 6572            worker
-00035f20: 7320 3d20 5b73 656c 662e 636f 6572 6365  s = [self.coerce
-00035f30: 5f61 6464 7265 7373 2877 2920 666f 7220  _address(w) for 
-00035f40: 7720 696e 2077 6f72 6b65 7273 5d0a 2020  w in workers].  
-00035f50: 2020 2020 2020 2020 2020 2020 2020 7773                ws
-00035f60: 7320 3d20 7b73 656c 662e 776f 726b 6572  s = {self.worker
-00035f70: 735b 775d 2066 6f72 2077 2069 6e20 776f  s[w] for w in wo
-00035f80: 726b 6572 737d 0a20 2020 2020 2020 2020  rkers}.         
-00035f90: 2020 2020 2020 2077 7373 203d 207b 7773         wss = {ws
-00035fa0: 2066 6f72 2077 7320 696e 2077 7373 2069   for ws in wss i
-00035fb0: 6620 7773 2e73 7461 7475 7320 3d3d 2053  f ws.status == S
-00035fc0: 7461 7475 732e 7275 6e6e 696e 677d 0a0a  tatus.running}..
-00035fd0: 2020 2020 2020 2020 2020 2020 6966 2077              if w
-00035fe0: 7373 3a0a 2020 2020 2020 2020 2020 2020  ss:.            
-00035ff0: 2020 2020 6272 6561 6b0a 2020 2020 2020      break.      
-00036000: 2020 2020 2020 6966 2074 696d 6528 2920        if time() 
-00036010: 3e20 7374 6172 7420 2b20 7469 6d65 6f75  > start + timeou
-00036020: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
-00036030: 2020 2072 6169 7365 2054 696d 656f 7574     raise Timeout
-00036040: 4572 726f 7228 224e 6f20 7661 6c69 6420  Error("No valid 
-00036050: 776f 726b 6572 7320 666f 756e 6422 290a  workers found").
-00036060: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-00036070: 7420 6173 796e 6369 6f2e 736c 6565 7028  t asyncio.sleep(
-00036080: 302e 3129 0a0a 2020 2020 2020 2020 6173  0.1)..        as
-00036090: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
-000360a0: 6461 7461 2c20 6469 6374 290a 0a20 2020  data, dict)..   
-000360b0: 2020 2020 2077 6f72 6b65 7273 203d 206c       workers = l
-000360c0: 6973 7428 7773 2e61 6464 7265 7373 2066  ist(ws.address f
-000360d0: 6f72 2077 7320 696e 2077 7373 290a 2020  or ws in wss).  
-000360e0: 2020 2020 2020 6b65 7973 2c20 7768 6f5f        keys, who_
-000360f0: 6861 732c 206e 6279 7465 7320 3d20 6177  has, nbytes = aw
-00036100: 6169 7420 7363 6174 7465 725f 746f 5f77  ait scatter_to_w
-00036110: 6f72 6b65 7273 2877 6f72 6b65 7273 2c20  orkers(workers, 
-00036120: 6461 7461 2c20 7270 633d 7365 6c66 2e72  data, rpc=self.r
-00036130: 7063 290a 0a20 2020 2020 2020 2073 656c  pc)..        sel
-00036140: 662e 7570 6461 7465 5f64 6174 6128 7768  f.update_data(wh
-00036150: 6f5f 6861 733d 7768 6f5f 6861 732c 206e  o_has=who_has, n
-00036160: 6279 7465 733d 6e62 7974 6573 2c20 636c  bytes=nbytes, cl
-00036170: 6965 6e74 3d63 6c69 656e 7429 0a0a 2020  ient=client)..  
-00036180: 2020 2020 2020 6966 2062 726f 6164 6361        if broadca
-00036190: 7374 3a0a 2020 2020 2020 2020 2020 2020  st:.            
-000361a0: 6e20 3d20 6c65 6e28 776f 726b 6572 7329  n = len(workers)
-000361b0: 2069 6620 6272 6f61 6463 6173 7420 6973   if broadcast is
-000361c0: 2054 7275 6520 656c 7365 2062 726f 6164   True else broad
-000361d0: 6361 7374 0a20 2020 2020 2020 2020 2020  cast.           
-000361e0: 2061 7761 6974 2073 656c 662e 7265 706c   await self.repl
-000361f0: 6963 6174 6528 6b65 7973 3d6b 6579 732c  icate(keys=keys,
-00036200: 2077 6f72 6b65 7273 3d77 6f72 6b65 7273   workers=workers
-00036210: 2c20 6e3d 6e29 0a0a 2020 2020 2020 2020  , n=n)..        
-00036220: 7365 6c66 2e6c 6f67 5f65 7665 6e74 280a  self.log_event(.
-00036230: 2020 2020 2020 2020 2020 2020 5b63 6c69              [cli
-00036240: 656e 742c 2022 616c 6c22 5d2c 207b 2261  ent, "all"], {"a
-00036250: 6374 696f 6e22 3a20 2273 6361 7474 6572  ction": "scatter
-00036260: 222c 2022 636c 6965 6e74 223a 2063 6c69  ", "client": cli
-00036270: 656e 742c 2022 636f 756e 7422 3a20 6c65  ent, "count": le
-00036280: 6e28 6461 7461 297d 0a20 2020 2020 2020  n(data)}.       
-00036290: 2029 0a20 2020 2020 2020 2072 6574 7572   ).        retur
-000362a0: 6e20 6b65 7973 0a0a 2020 2020 6173 796e  n keys..    asyn
-000362b0: 6320 6465 6620 6761 7468 6572 280a 2020  c def gather(.  
-000362c0: 2020 2020 2020 7365 6c66 2c20 6b65 7973        self, keys
-000362d0: 3a20 436f 6c6c 6563 7469 6f6e 5b4b 6579  : Collection[Key
-000362e0: 5d2c 2073 6572 6961 6c69 7a65 7273 3a20  ], serializers: 
-000362f0: 6c69 7374 5b73 7472 5d20 7c20 4e6f 6e65  list[str] | None
-00036300: 203d 204e 6f6e 650a 2020 2020 2920 2d3e   = None.    ) ->
-00036310: 2064 6963 745b 4b65 792c 206f 626a 6563   dict[Key, objec
-00036320: 745d 3a0a 2020 2020 2020 2020 2222 2243  t]:.        """C
-00036330: 6f6c 6c65 6374 2064 6174 6120 6672 6f6d  ollect data from
-00036340: 2077 6f72 6b65 7273 2074 6f20 7468 6520   workers to the 
-00036350: 7363 6865 6475 6c65 7222 2222 0a20 2020  scheduler""".   
-00036360: 2020 2020 2064 6174 6120 3d20 7b7d 0a20       data = {}. 
-00036370: 2020 2020 2020 206d 6973 7369 6e67 5f6b         missing_k
-00036380: 6579 7320 3d20 6c69 7374 286b 6579 7329  eys = list(keys)
-00036390: 0a20 2020 2020 2020 2066 6169 6c65 645f  .        failed_
-000363a0: 6b65 7973 3a20 6c69 7374 5b4b 6579 5d20  keys: list[Key] 
-000363b0: 3d20 5b5d 0a20 2020 2020 2020 206d 6973  = [].        mis
-000363c0: 7369 6e67 5f77 6f72 6b65 7273 3a20 7365  sing_workers: se
-000363d0: 745b 7374 725d 203d 2073 6574 2829 0a0a  t[str] = set()..
-000363e0: 2020 2020 2020 2020 7768 696c 6520 6d69          while mi
-000363f0: 7373 696e 675f 6b65 7973 3a0a 2020 2020  ssing_keys:.    
-00036400: 2020 2020 2020 2020 7768 6f5f 6861 7320          who_has 
-00036410: 3d20 7b7d 0a20 2020 2020 2020 2020 2020  = {}.           
-00036420: 2066 6f72 206b 6579 2c20 776f 726b 6572   for key, worker
-00036430: 7320 696e 2073 656c 662e 6765 745f 7768  s in self.get_wh
-00036440: 6f5f 6861 7328 6d69 7373 696e 675f 6b65  o_has(missing_ke
-00036450: 7973 292e 6974 656d 7328 293a 0a20 2020  ys).items():.   
-00036460: 2020 2020 2020 2020 2020 2020 2076 616c               val
-00036470: 6964 5f77 6f72 6b65 7273 203d 2073 6574  id_workers = set
-00036480: 2877 6f72 6b65 7273 2920 2d20 6d69 7373  (workers) - miss
-00036490: 696e 675f 776f 726b 6572 730a 2020 2020  ing_workers.    
-000364a0: 2020 2020 2020 2020 2020 2020 6966 2076              if v
-000364b0: 616c 6964 5f77 6f72 6b65 7273 3a0a 2020  alid_workers:.  
-000364c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000364d0: 2020 7768 6f5f 6861 735b 6b65 795d 203d    who_has[key] =
-000364e0: 2076 616c 6964 5f77 6f72 6b65 7273 0a20   valid_workers. 
-000364f0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00036500: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00036510: 2020 2020 2020 2020 2066 6169 6c65 645f           failed_
-00036520: 6b65 7973 2e61 7070 656e 6428 6b65 7929  keys.append(key)
-00036530: 0a0a 2020 2020 2020 2020 2020 2020 280a  ..            (.
-00036540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036550: 6e65 775f 6461 7461 2c0a 2020 2020 2020  new_data,.      
-00036560: 2020 2020 2020 2020 2020 6d69 7373 696e            missin
-00036570: 675f 6b65 7973 2c0a 2020 2020 2020 2020  g_keys,.        
-00036580: 2020 2020 2020 2020 6e65 775f 6661 696c          new_fail
-00036590: 6564 5f6b 6579 732c 0a20 2020 2020 2020  ed_keys,.       
-000365a0: 2020 2020 2020 2020 206e 6577 5f6d 6973           new_mis
-000365b0: 7369 6e67 5f77 6f72 6b65 7273 2c0a 2020  sing_workers,.  
-000365c0: 2020 2020 2020 2020 2020 2920 3d20 6177            ) = aw
-000365d0: 6169 7420 6761 7468 6572 5f66 726f 6d5f  ait gather_from_
-000365e0: 776f 726b 6572 7328 0a20 2020 2020 2020  workers(.       
-000365f0: 2020 2020 2020 2020 2077 686f 5f68 6173           who_has
-00036600: 2c20 7270 633d 7365 6c66 2e72 7063 2c20  , rpc=self.rpc, 
-00036610: 7365 7269 616c 697a 6572 733d 7365 7269  serializers=seri
-00036620: 616c 697a 6572 730a 2020 2020 2020 2020  alizers.        
-00036630: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00036640: 2020 6461 7461 2e75 7064 6174 6528 6e65    data.update(ne
-00036650: 775f 6461 7461 290a 2020 2020 2020 2020  w_data).        
-00036660: 2020 2020 6661 696c 6564 5f6b 6579 7320      failed_keys 
-00036670: 2b3d 206e 6577 5f66 6169 6c65 645f 6b65  += new_failed_ke
-00036680: 7973 0a20 2020 2020 2020 2020 2020 206d  ys.            m
-00036690: 6973 7369 6e67 5f77 6f72 6b65 7273 2e75  issing_workers.u
-000366a0: 7064 6174 6528 6e65 775f 6d69 7373 696e  pdate(new_missin
-000366b0: 675f 776f 726b 6572 7329 0a0a 2020 2020  g_workers)..    
-000366c0: 2020 2020 7365 6c66 2e6c 6f67 5f65 7665      self.log_eve
-000366d0: 6e74 2822 616c 6c22 2c20 7b22 6163 7469  nt("all", {"acti
-000366e0: 6f6e 223a 2022 6761 7468 6572 222c 2022  on": "gather", "
-000366f0: 636f 756e 7422 3a20 6c65 6e28 6b65 7973  count": len(keys
-00036700: 297d 290a 0a20 2020 2020 2020 2069 6620  )})..        if 
-00036710: 6e6f 7420 6661 696c 6564 5f6b 6579 733a  not failed_keys:
-00036720: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00036730: 7572 6e20 7b22 7374 6174 7573 223a 2022  urn {"status": "
-00036740: 4f4b 222c 2022 6461 7461 223a 2064 6174  OK", "data": dat
-00036750: 617d 0a0a 2020 2020 2020 2020 6661 696c  a}..        fail
-00036760: 6564 5f73 7461 7465 7320 3d20 7b0a 2020  ed_states = {.  
-00036770: 2020 2020 2020 2020 2020 6b65 793a 2073            key: s
-00036780: 656c 662e 7461 736b 735b 6b65 795d 2e73  elf.tasks[key].s
-00036790: 7461 7465 2069 6620 6b65 7920 696e 2073  tate if key in s
-000367a0: 656c 662e 7461 736b 7320 656c 7365 2022  elf.tasks else "
-000367b0: 666f 7267 6f74 7465 6e22 0a20 2020 2020  forgotten".     
-000367c0: 2020 2020 2020 2066 6f72 206b 6579 2069         for key i
-000367d0: 6e20 6661 696c 6564 5f6b 6579 730a 2020  n failed_keys.  
-000367e0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-000367f0: 6c6f 6767 6572 2e65 7272 6f72 2822 436f  logger.error("Co
-00036800: 756c 646e 2774 2067 6174 6865 7220 6b65  uldn't gather ke
-00036810: 7973 3a20 2573 222c 2066 6169 6c65 645f  ys: %s", failed_
-00036820: 7374 6174 6573 290a 2020 2020 2020 2020  states).        
-00036830: 7265 7475 726e 207b 2273 7461 7475 7322  return {"status"
-00036840: 3a20 2265 7272 6f72 222c 2022 6b65 7973  : "error", "keys
-00036850: 223a 206c 6973 7428 6661 696c 6564 5f6b  ": list(failed_k
-00036860: 6579 7329 7d0a 0a20 2020 2040 6c6f 675f  eys)}..    @log_
-00036870: 6572 726f 7273 0a20 2020 2061 7379 6e63  errors.    async
-00036880: 2064 6566 2072 6573 7461 7274 280a 2020   def restart(.  
-00036890: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-000368a0: 2020 2020 2a2c 0a20 2020 2020 2020 2063      *,.        c
-000368b0: 6c69 656e 743a 2073 7472 207c 204e 6f6e  lient: str | Non
-000368c0: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
-000368d0: 2020 7469 6d65 6f75 743a 2066 6c6f 6174    timeout: float
-000368e0: 203d 2033 302c 0a20 2020 2020 2020 2077   = 30,.        w
-000368f0: 6169 745f 666f 725f 776f 726b 6572 733a  ait_for_workers:
-00036900: 2062 6f6f 6c20 3d20 5472 7565 2c0a 2020   bool = True,.  
-00036910: 2020 2020 2020 7374 696d 756c 7573 5f69        stimulus_i
-00036920: 643a 2073 7472 2c0a 2020 2020 2920 2d3e  d: str,.    ) ->
-00036930: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
-00036940: 2222 466f 7267 6574 2061 6c6c 2074 6173  ""Forget all tas
-00036950: 6b73 2061 6e64 2063 616c 6c20 7265 7374  ks and call rest
-00036960: 6172 745f 776f 726b 6572 7320 6f6e 2061  art_workers on a
-00036970: 6c6c 2077 6f72 6b65 7273 2e0a 0a20 2020  ll workers...   
-00036980: 2020 2020 2050 6172 616d 6574 6572 730a       Parameters.
-00036990: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
-000369a0: 2d2d 0a20 2020 2020 2020 2074 696d 656f  --.        timeo
-000369b0: 7574 3a0a 2020 2020 2020 2020 2020 2020  ut:.            
-000369c0: 5365 6520 7265 7374 6172 745f 776f 726b  See restart_work
-000369d0: 6572 730a 2020 2020 2020 2020 7761 6974  ers.        wait
-000369e0: 5f66 6f72 5f77 6f72 6b65 7273 3a0a 2020  _for_workers:.  
-000369f0: 2020 2020 2020 2020 2020 5365 6520 7265            See re
-00036a00: 7374 6172 745f 776f 726b 6572 730a 0a20  start_workers.. 
-00036a10: 2020 2020 2020 2053 6565 2061 6c73 6f0a         See also.
-00036a20: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
-00036a30: 0a20 2020 2020 2020 2043 6c69 656e 742e  .        Client.
-00036a40: 7265 7374 6172 740a 2020 2020 2020 2020  restart.        
-00036a50: 436c 6965 6e74 2e72 6573 7461 7274 5f77  Client.restart_w
-00036a60: 6f72 6b65 7273 0a20 2020 2020 2020 2053  orkers.        S
-00036a70: 6368 6564 756c 6572 2e72 6573 7461 7274  cheduler.restart
-00036a80: 5f77 6f72 6b65 7273 0a20 2020 2020 2020  _workers.       
-00036a90: 2022 2222 0a20 2020 2020 2020 206c 6f67   """.        log
-00036aa0: 6765 722e 696e 666f 2866 2252 6573 7461  ger.info(f"Resta
-00036ab0: 7274 696e 6720 776f 726b 6572 7320 616e  rting workers an
-00036ac0: 6420 7265 6c65 6173 696e 6720 616c 6c20  d releasing all 
-00036ad0: 6b65 7973 2028 7b73 7469 6d75 6c75 735f  keys ({stimulus_
-00036ae0: 6964 3d7d 2922 290a 2020 2020 2020 2020  id=})").        
-00036af0: 666f 7220 6373 2069 6e20 7365 6c66 2e63  for cs in self.c
-00036b00: 6c69 656e 7473 2e76 616c 7565 7328 293a  lients.values():
-00036b10: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00036b20: 662e 636c 6965 6e74 5f72 656c 6561 7365  f.client_release
-00036b30: 735f 6b65 7973 280a 2020 2020 2020 2020  s_keys(.        
-00036b40: 2020 2020 2020 2020 6b65 7973 3d5b 7473          keys=[ts
-00036b50: 2e6b 6579 2066 6f72 2074 7320 696e 2063  .key for ts in c
-00036b60: 732e 7761 6e74 735f 7768 6174 5d2c 0a20  s.wants_what],. 
-00036b70: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00036b80: 6c69 656e 743d 6373 2e63 6c69 656e 745f  lient=cs.client_
-00036b90: 6b65 792c 0a20 2020 2020 2020 2020 2020  key,.           
-00036ba0: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
-00036bb0: 3d73 7469 6d75 6c75 735f 6964 2c0a 2020  =stimulus_id,.  
-00036bc0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-00036bd0: 2020 2020 2073 656c 662e 5f63 6c65 6172       self._clear
-00036be0: 5f74 6173 6b5f 7374 6174 6528 290a 2020  _task_state().  
-00036bf0: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
-00036c00: 2073 656c 662e 7461 736b 730a 2020 2020   self.tasks.    
-00036c10: 2020 2020 7365 6c66 2e72 6570 6f72 7428      self.report(
-00036c20: 7b22 6f70 223a 2022 7265 7374 6172 7422  {"op": "restart"
-00036c30: 7d29 0a0a 2020 2020 2020 2020 666f 7220  })..        for 
-00036c40: 706c 7567 696e 2069 6e20 6c69 7374 2873  plugin in list(s
-00036c50: 656c 662e 706c 7567 696e 732e 7661 6c75  elf.plugins.valu
-00036c60: 6573 2829 293a 0a20 2020 2020 2020 2020  es()):.         
-00036c70: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00036c80: 2020 2020 2020 2020 706c 7567 696e 2e72          plugin.r
-00036c90: 6573 7461 7274 2873 656c 6629 0a20 2020  estart(self).   
-00036ca0: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-00036cb0: 4578 6365 7074 696f 6e20 6173 2065 3a0a  Exception as e:.
-00036cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036cd0: 6c6f 6767 6572 2e65 7863 6570 7469 6f6e  logger.exception
-00036ce0: 2865 290a 0a20 2020 2020 2020 2061 7761  (e)..        awa
-00036cf0: 6974 2073 656c 662e 7265 7374 6172 745f  it self.restart_
-00036d00: 776f 726b 6572 7328 0a20 2020 2020 2020  workers(.       
-00036d10: 2020 2020 2063 6c69 656e 743d 636c 6965       client=clie
-00036d20: 6e74 2c0a 2020 2020 2020 2020 2020 2020  nt,.            
-00036d30: 7469 6d65 6f75 743d 7469 6d65 6f75 742c  timeout=timeout,
-00036d40: 0a20 2020 2020 2020 2020 2020 2077 6169  .            wai
-00036d50: 745f 666f 725f 776f 726b 6572 733d 7761  t_for_workers=wa
-00036d60: 6974 5f66 6f72 5f77 6f72 6b65 7273 2c0a  it_for_workers,.
-00036d70: 2020 2020 2020 2020 2020 2020 7374 696d              stim
-00036d80: 756c 7573 5f69 643d 7374 696d 756c 7573  ulus_id=stimulus
-00036d90: 5f69 642c 0a20 2020 2020 2020 2029 0a0a  _id,.        )..
-00036da0: 2020 2020 406c 6f67 5f65 7272 6f72 730a      @log_errors.
-00036db0: 2020 2020 6173 796e 6320 6465 6620 7265      async def re
-00036dc0: 7374 6172 745f 776f 726b 6572 7328 0a20  start_workers(. 
-00036dd0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-00036de0: 2020 2020 2077 6f72 6b65 7273 3a20 6c69       workers: li
-00036df0: 7374 5b73 7472 5d20 7c20 4e6f 6e65 203d  st[str] | None =
-00036e00: 204e 6f6e 652c 0a20 2020 2020 2020 202a   None,.        *
-00036e10: 2c0a 2020 2020 2020 2020 636c 6965 6e74  ,.        client
-00036e20: 3a20 7374 7220 7c20 4e6f 6e65 203d 204e  : str | None = N
-00036e30: 6f6e 652c 0a20 2020 2020 2020 2074 696d  one,.        tim
-00036e40: 656f 7574 3a20 666c 6f61 7420 3d20 3330  eout: float = 30
-00036e50: 2c0a 2020 2020 2020 2020 7761 6974 5f66  ,.        wait_f
-00036e60: 6f72 5f77 6f72 6b65 7273 3a20 626f 6f6c  or_workers: bool
-00036e70: 203d 2054 7275 652c 0a20 2020 2020 2020   = True,.       
-00036e80: 206f 6e5f 6572 726f 723a 204c 6974 6572   on_error: Liter
-00036e90: 616c 5b22 7261 6973 6522 2c20 2272 6574  al["raise", "ret
-00036ea0: 7572 6e22 5d20 3d20 2272 6169 7365 222c  urn"] = "raise",
-00036eb0: 0a20 2020 2020 2020 2073 7469 6d75 6c75  .        stimulu
-00036ec0: 735f 6964 3a20 7374 722c 0a20 2020 2029  s_id: str,.    )
-00036ed0: 202d 3e20 6469 6374 5b73 7472 2c20 4c69   -> dict[str, Li
-00036ee0: 7465 7261 6c5b 224f 4b22 2c20 2272 656d  teral["OK", "rem
-00036ef0: 6f76 6564 222c 2022 7469 6d65 6420 6f75  oved", "timed ou
-00036f00: 7422 5d5d 3a0a 2020 2020 2020 2020 2222  t"]]:.        ""
-00036f10: 2252 6573 7461 7274 2073 656c 6563 7465  "Restart selecte
-00036f20: 6420 776f 726b 6572 732e 204f 7074 696f  d workers. Optio
-00036f30: 6e61 6c6c 7920 7761 6974 2066 6f72 2077  nally wait for w
-00036f40: 6f72 6b65 7273 2074 6f20 7265 7475 726e  orkers to return
-00036f50: 2e0a 0a20 2020 2020 2020 2057 6f72 6b65  ...        Worke
-00036f60: 7273 2077 6974 686f 7574 206e 616e 6e69  rs without nanni
-00036f70: 6573 2061 7265 2073 6875 7420 646f 776e  es are shut down
-00036f80: 2c20 686f 7069 6e67 2061 6e20 6578 7465  , hoping an exte
-00036f90: 726e 616c 2064 6570 6c6f 796d 656e 7420  rnal deployment 
-00036fa0: 7379 7374 656d 0a20 2020 2020 2020 2077  system.        w
-00036fb0: 696c 6c20 7265 7374 6172 7420 7468 656d  ill restart them
-00036fc0: 2e20 5468 6572 6566 6f72 652c 2069 6620  . Therefore, if 
-00036fd0: 6e6f 7420 7573 696e 6720 6e61 6e6e 6965  not using nannie
-00036fe0: 7320 616e 6420 796f 7572 2064 6570 6c6f  s and your deplo
-00036ff0: 796d 656e 7420 7379 7374 656d 0a20 2020  yment system.   
-00037000: 2020 2020 2064 6f65 7320 6e6f 7420 6175       does not au
-00037010: 746f 6d61 7469 6361 6c6c 7920 7265 7374  tomatically rest
-00037020: 6172 7420 776f 726b 6572 732c 2060 6072  art workers, ``r
-00037030: 6573 7461 7274 6060 2077 696c 6c20 6a75  estart`` will ju
-00037040: 7374 2073 6875 7420 646f 776e 2061 6c6c  st shut down all
-00037050: 0a20 2020 2020 2020 2077 6f72 6b65 7273  .        workers
-00037060: 2c20 7468 656e 2074 696d 6520 6f75 7421  , then time out!
-00037070: 0a0a 2020 2020 2020 2020 4166 7465 7220  ..        After 
-00037080: 6060 7265 7374 6172 7460 602c 2061 6c6c  ``restart``, all
-00037090: 2063 6f6e 6e65 6374 6564 2077 6f72 6b65   connected worke
-000370a0: 7273 2061 7265 206e 6577 2c20 7265 6761  rs are new, rega
-000370b0: 7264 6c65 7373 206f 6620 7768 6574 6865  rdless of whethe
-000370c0: 720a 2020 2020 2020 2020 6060 5469 6d65  r.        ``Time
-000370d0: 6f75 7445 7272 6f72 6060 2077 6173 2072  outError`` was r
-000370e0: 6169 7365 642e 2041 6e79 2077 6f72 6b65  aised. Any worke
-000370f0: 7273 2074 6861 7420 6661 696c 6564 2074  rs that failed t
-00037100: 6f20 7368 7574 2064 6f77 6e20 696e 2074  o shut down in t
-00037110: 696d 6520 6172 650a 2020 2020 2020 2020  ime are.        
-00037120: 7265 6d6f 7665 642c 2061 6e64 206d 6179  removed, and may
-00037130: 206f 7220 6d61 7920 6e6f 7420 7368 7574   or may not shut
-00037140: 2064 6f77 6e20 6f6e 2074 6865 6972 206f   down on their o
-00037150: 776e 2069 6e20 7468 6520 6675 7475 7265  wn in the future
-00037160: 2e0a 0a20 2020 2020 2020 2050 6172 616d  ...        Param
-00037170: 6574 6572 730a 2020 2020 2020 2020 2d2d  eters.        --
-00037180: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020 2020  --------.       
-00037190: 2077 6f72 6b65 7273 3a0a 2020 2020 2020   workers:.      
-000371a0: 2020 2020 2020 4c69 7374 206f 6620 776f        List of wo
-000371b0: 726b 6572 2061 6464 7265 7373 6573 2074  rker addresses t
-000371c0: 6f20 7265 7374 6172 742e 2049 6620 6f6d  o restart. If om
-000371d0: 6974 7465 642c 2072 6573 7461 7274 2061  itted, restart a
-000371e0: 6c6c 2077 6f72 6b65 7273 2e0a 2020 2020  ll workers..    
-000371f0: 2020 2020 7469 6d65 6f75 743a 0a20 2020      timeout:.   
-00037200: 2020 2020 2020 2020 2048 6f77 206c 6f6e           How lon
-00037210: 6720 746f 2077 6169 7420 666f 7220 776f  g to wait for wo
-00037220: 726b 6572 7320 746f 2073 6875 7420 646f  rkers to shut do
-00037230: 776e 2061 6e64 2063 6f6d 6520 6261 636b  wn and come back
-00037240: 2c20 6966 2060 6077 6169 745f 666f 725f  , if ``wait_for_
-00037250: 776f 726b 6572 7360 600a 2020 2020 2020  workers``.      
-00037260: 2020 2020 2020 6973 2054 7275 652c 206f        is True, o
-00037270: 7468 6572 7769 7365 206a 7573 7420 686f  therwise just ho
-00037280: 7720 6c6f 6e67 2074 6f20 7761 6974 2066  w long to wait f
-00037290: 6f72 2077 6f72 6b65 7273 2074 6f20 7368  or workers to sh
-000372a0: 7574 2064 6f77 6e2e 0a20 2020 2020 2020  ut down..       
-000372b0: 2020 2020 2052 6169 7365 7320 6060 6173       Raises ``as
-000372c0: 796e 6369 6f2e 5469 6d65 6f75 7445 7272  yncio.TimeoutErr
-000372d0: 6f72 6060 2069 6620 7468 6973 2069 7320  or`` if this is 
-000372e0: 6578 6365 6564 6564 2e0a 2020 2020 2020  exceeded..      
-000372f0: 2020 7761 6974 5f66 6f72 5f77 6f72 6b65    wait_for_worke
-00037300: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
-00037310: 5768 6574 6865 7220 746f 2077 6169 7420  Whether to wait 
-00037320: 666f 7220 616c 6c20 776f 726b 6572 7320  for all workers 
-00037330: 746f 2072 6563 6f6e 6e65 6374 2c20 6f72  to reconnect, or
-00037340: 206a 7573 7420 666f 7220 7468 656d 2074   just for them t
-00037350: 6f20 7368 7574 2064 6f77 6e0a 2020 2020  o shut down.    
-00037360: 2020 2020 2020 2020 2864 6566 6175 6c74          (default
-00037370: 2054 7275 6529 2e20 5573 6520 6060 7265   True). Use ``re
-00037380: 7374 6172 7428 7761 6974 5f66 6f72 5f77  start(wait_for_w
-00037390: 6f72 6b65 7273 3d46 616c 7365 2960 6020  orkers=False)`` 
-000373a0: 636f 6d62 696e 6564 2077 6974 680a 2020  combined with.  
-000373b0: 2020 2020 2020 2020 2020 3a6d 6574 683a            :meth:
-000373c0: 6043 6c69 656e 742e 7761 6974 5f66 6f72  `Client.wait_for
-000373d0: 5f77 6f72 6b65 7273 6020 666f 7220 6772  _workers` for gr
-000373e0: 616e 756c 6172 2063 6f6e 7472 6f6c 206f  anular control o
-000373f0: 7665 7220 686f 7720 6d61 6e79 2077 6f72  ver how many wor
-00037400: 6b65 7273 2074 6f0a 2020 2020 2020 2020  kers to.        
-00037410: 2020 2020 7761 6974 2066 6f72 2e0a 2020      wait for..  
-00037420: 2020 2020 2020 6f6e 5f65 7272 6f72 3a0a        on_error:.
-00037430: 2020 2020 2020 2020 2020 2020 4966 2027              If '
-00037440: 7261 6973 6527 2028 7468 6520 6465 6661  raise' (the defa
-00037450: 756c 7429 2c20 7261 6973 6520 6966 2061  ult), raise if a
-00037460: 6e79 206e 616e 6e79 2074 696d 6573 206f  ny nanny times o
-00037470: 7574 2077 6869 6c65 2072 6573 7461 7274  ut while restart
-00037480: 696e 6720 7468 650a 2020 2020 2020 2020  ing the.        
-00037490: 2020 2020 776f 726b 6572 2e20 4966 2027      worker. If '
-000374a0: 7265 7475 726e 272c 2072 6574 7572 6e20  return', return 
-000374b0: 6572 726f 7220 6d65 7373 6167 6573 2e0a  error messages..
-000374c0: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
-000374d0: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
-000374e0: 0a20 2020 2020 2020 207b 776f 726b 6572  .        {worker
-000374f0: 2061 6464 7265 7373 3a20 224f 4b22 2c20   address: "OK", 
-00037500: 226e 6f20 6e61 6e6e 7922 2c20 6f72 2022  "no nanny", or "
-00037510: 7469 6d65 6420 6f75 7422 206f 7220 6572  timed out" or er
-00037520: 726f 7220 6d65 7373 6167 657d 0a0a 2020  ror message}..  
-00037530: 2020 2020 2020 5365 6520 616c 736f 0a20        See also. 
-00037540: 2020 2020 2020 202d 2d2d 2d2d 2d2d 2d0a         --------.
-00037550: 2020 2020 2020 2020 436c 6965 6e74 2e72          Client.r
-00037560: 6573 7461 7274 0a20 2020 2020 2020 2043  estart.        C
-00037570: 6c69 656e 742e 7265 7374 6172 745f 776f  lient.restart_wo
-00037580: 726b 6572 730a 2020 2020 2020 2020 5363  rkers.        Sc
-00037590: 6865 6475 6c65 722e 7265 7374 6172 740a  heduler.restart.
-000375a0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-000375b0: 2020 2020 6e5f 776f 726b 6572 7320 3d20      n_workers = 
-000375c0: 6c65 6e28 7365 6c66 2e77 6f72 6b65 7273  len(self.workers
-000375d0: 290a 2020 2020 2020 2020 6966 2077 6f72  ).        if wor
-000375e0: 6b65 7273 2069 7320 4e6f 6e65 3a0a 2020  kers is None:.  
-000375f0: 2020 2020 2020 2020 2020 776f 726b 6572            worker
-00037600: 7320 3d20 6c69 7374 2873 656c 662e 776f  s = list(self.wo
-00037610: 726b 6572 7329 0a20 2020 2020 2020 2020  rkers).         
-00037620: 2020 206c 6f67 6765 722e 696e 666f 2866     logger.info(f
-00037630: 2252 6573 7461 7274 696e 6720 616c 6c20  "Restarting all 
-00037640: 776f 726b 6572 7320 287b 7374 696d 756c  workers ({stimul
-00037650: 7573 5f69 643d 7d22 290a 2020 2020 2020  us_id=}").      
-00037660: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00037670: 2020 2020 776f 726b 6572 7320 3d20 6c69      workers = li
-00037680: 7374 2873 6574 2877 6f72 6b65 7273 292e  st(set(workers).
-00037690: 696e 7465 7273 6563 7469 6f6e 2873 656c  intersection(sel
-000376a0: 662e 776f 726b 6572 7329 290a 2020 2020  f.workers)).    
-000376b0: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
-000376c0: 6e66 6f28 6622 5265 7374 6172 7469 6e67  nfo(f"Restarting
-000376d0: 207b 6c65 6e28 776f 726b 6572 7329 7d20   {len(workers)} 
-000376e0: 776f 726b 6572 733a 207b 776f 726b 6572  workers: {worker
-000376f0: 737d 2028 7b73 7469 6d75 6c75 735f 6964  s} ({stimulus_id
-00037700: 3d7d 2229 0a0a 2020 2020 2020 2020 6e61  =}")..        na
-00037710: 6e6e 795f 776f 726b 6572 7320 3d20 7b0a  nny_workers = {.
-00037720: 2020 2020 2020 2020 2020 2020 6164 6472              addr
-00037730: 3a20 7365 6c66 2e77 6f72 6b65 7273 5b61  : self.workers[a
-00037740: 6464 725d 2e6e 616e 6e79 0a20 2020 2020  ddr].nanny.     
-00037750: 2020 2020 2020 2066 6f72 2061 6464 7220         for addr 
-00037760: 696e 2077 6f72 6b65 7273 0a20 2020 2020  in workers.     
-00037770: 2020 2020 2020 2069 6620 7365 6c66 2e77         if self.w
-00037780: 6f72 6b65 7273 5b61 6464 725d 2e6e 616e  orkers[addr].nan
-00037790: 6e79 0a20 2020 2020 2020 207d 0a20 2020  ny.        }.   
-000377a0: 2020 2020 2023 2043 6c6f 7365 206e 6f6e       # Close non
-000377b0: 2d4e 616e 6e79 2077 6f72 6b65 7273 2e20  -Nanny workers. 
-000377c0: 5765 2068 6176 6520 6e6f 2077 6179 2074  We have no way t
-000377d0: 6f20 7265 7374 6172 7420 7468 656d 2c20  o restart them, 
-000377e0: 736f 2077 6520 6a75 7374 206c 6574 2074  so we just let t
-000377f0: 6865 6d0a 2020 2020 2020 2020 2320 676f  hem.        # go
-00037800: 2c20 616e 6420 6173 7375 6d65 2061 2064  , and assume a d
-00037810: 6570 6c6f 796d 656e 7420 7379 7374 656d  eployment system
-00037820: 2069 7320 676f 696e 6720 746f 2072 6573   is going to res
-00037830: 7461 7274 2074 6865 6d20 666f 7220 7573  tart them for us
-00037840: 2e0a 2020 2020 2020 2020 6e6f 5f6e 616e  ..        no_nan
-00037850: 6e79 5f77 6f72 6b65 7273 203d 205b 6164  ny_workers = [ad
-00037860: 6472 2066 6f72 2061 6464 7220 696e 2077  dr for addr in w
-00037870: 6f72 6b65 7273 2069 6620 6164 6472 206e  orkers if addr n
-00037880: 6f74 2069 6e20 6e61 6e6e 795f 776f 726b  ot in nanny_work
-00037890: 6572 735d 0a20 2020 2020 2020 2069 6620  ers].        if 
-000378a0: 6e6f 5f6e 616e 6e79 5f77 6f72 6b65 7273  no_nanny_workers
-000378b0: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
-000378c0: 6767 6572 2e77 6172 6e69 6e67 280a 2020  gger.warning(.  
-000378d0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-000378e0: 576f 726b 6572 7320 7b6e 6f5f 6e61 6e6e  Workers {no_nann
-000378f0: 795f 776f 726b 6572 737d 2064 6f20 6e6f  y_workers} do no
-00037900: 7420 7573 6520 6120 6e61 6e6e 7920 616e  t use a nanny an
-00037910: 6420 7769 6c6c 2062 6520 7465 726d 696e  d will be termin
-00037920: 6174 6564 2022 0a20 2020 2020 2020 2020  ated ".         
-00037930: 2020 2020 2020 2022 7769 7468 6f75 7420         "without 
-00037940: 7265 7374 6172 7469 6e67 2074 6865 6d22  restarting them"
-00037950: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00037960: 2020 2020 2020 2020 2020 2061 7761 6974             await
-00037970: 2061 7379 6e63 696f 2e67 6174 6865 7228   asyncio.gather(
-00037980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00037990: 202a 280a 2020 2020 2020 2020 2020 2020   *(.            
-000379a0: 2020 2020 2020 2020 7365 6c66 2e72 656d          self.rem
-000379b0: 6f76 655f 776f 726b 6572 2861 6464 7265  ove_worker(addre
-000379c0: 7373 3d61 6464 722c 2073 7469 6d75 6c75  ss=addr, stimulu
-000379d0: 735f 6964 3d73 7469 6d75 6c75 735f 6964  s_id=stimulus_id
-000379e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000379f0: 2020 2020 2020 666f 7220 6164 6472 2069        for addr i
-00037a00: 6e20 6e6f 5f6e 616e 6e79 5f77 6f72 6b65  n no_nanny_worke
-00037a10: 7273 0a20 2020 2020 2020 2020 2020 2020  rs.             
-00037a20: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00037a30: 2029 0a20 2020 2020 2020 206f 7574 3a20   ).        out: 
-00037a40: 6469 6374 5b73 7472 2c20 4c69 7465 7261  dict[str, Litera
-00037a50: 6c5b 224f 4b22 2c20 2272 656d 6f76 6564  l["OK", "removed
-00037a60: 222c 2022 7469 6d65 6420 6f75 7422 5d5d  ", "timed out"]]
-00037a70: 0a20 2020 2020 2020 206f 7574 203d 207b  .        out = {
-00037a80: 6164 6472 3a20 2272 656d 6f76 6564 2220  addr: "removed" 
-00037a90: 666f 7220 6164 6472 2069 6e20 6e6f 5f6e  for addr in no_n
-00037aa0: 616e 6e79 5f77 6f72 6b65 7273 7d0a 2020  anny_workers}.  
-00037ab0: 2020 2020 2020 6465 6164 6c69 6e65 203d        deadline =
-00037ac0: 2044 6561 646c 696e 652e 6166 7465 7228   Deadline.after(
-00037ad0: 7469 6d65 6f75 7429 0a0a 2020 2020 2020  timeout)..      
-00037ae0: 2020 6c6f 6767 6572 2e64 6562 7567 2822    logger.debug("
-00037af0: 5365 6e64 206b 696c 6c20 7369 676e 616c  Send kill signal
-00037b00: 2074 6f20 6e61 6e6e 6965 733a 2025 7322   to nannies: %s"
-00037b10: 2c20 6e61 6e6e 795f 776f 726b 6572 7329  , nanny_workers)
-00037b20: 0a20 2020 2020 2020 2061 7379 6e63 2077  .        async w
-00037b30: 6974 6820 636f 6e74 6578 746c 6962 2e41  ith contextlib.A
-00037b40: 7379 6e63 4578 6974 5374 6163 6b28 2920  syncExitStack() 
-00037b50: 6173 2073 7461 636b 3a0a 2020 2020 2020  as stack:.      
-00037b60: 2020 2020 2020 6e61 6e6e 6965 7320 3d20        nannies = 
-00037b70: 6177 6169 7420 6173 796e 6369 6f2e 6761  await asyncio.ga
-00037b80: 7468 6572 280a 2020 2020 2020 2020 2020  ther(.          
-00037b90: 2020 2020 2020 2a28 0a20 2020 2020 2020        *(.       
-00037ba0: 2020 2020 2020 2020 2020 2020 2073 7461               sta
-00037bb0: 636b 2e65 6e74 6572 5f61 7379 6e63 5f63  ck.enter_async_c
-00037bc0: 6f6e 7465 7874 280a 2020 2020 2020 2020  ontext(.        
-00037bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037be0: 7270 6328 6e61 6e6e 795f 6164 6472 6573  rpc(nanny_addres
-00037bf0: 732c 2063 6f6e 6e65 6374 696f 6e5f 6172  s, connection_ar
-00037c00: 6773 3d73 656c 662e 636f 6e6e 6563 7469  gs=self.connecti
-00037c10: 6f6e 5f61 7267 7329 0a20 2020 2020 2020  on_args).       
-00037c20: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-00037c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037c40: 2020 2066 6f72 206e 616e 6e79 5f61 6464     for nanny_add
-00037c50: 7265 7373 2069 6e20 6e61 6e6e 795f 776f  ress in nanny_wo
-00037c60: 726b 6572 732e 7661 6c75 6573 2829 0a20  rkers.values(). 
-00037c70: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00037c80: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00037c90: 2020 2020 2020 2020 2020 2072 6573 7073             resps
-00037ca0: 203d 2061 7761 6974 2061 7379 6e63 696f   = await asyncio
-00037cb0: 2e67 6174 6865 7228 0a20 2020 2020 2020  .gather(.       
-00037cc0: 2020 2020 2020 2020 202a 280a 2020 2020           *(.    
-00037cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037ce0: 7761 6974 5f66 6f72 280a 2020 2020 2020  wait_for(.      
+0002e610: 2020 2020 206c 6f67 6765 722e 6572 726f       logger.erro
+0002e620: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+0002e630: 2020 2020 2020 2020 2020 2022 5461 736b             "Task
+0002e640: 2025 7320 6d61 726b 6564 2061 7320 6661   %s marked as fa
+0002e650: 696c 6564 2062 6563 6175 7365 2025 6420  iled because %d 
+0002e660: 776f 726b 6572 7320 6469 6564 220a 2020  workers died".  
+0002e670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e680: 2020 2020 2020 2220 7768 696c 6520 7472        " while tr
+0002e690: 7969 6e67 2074 6f20 7275 6e20 6974 222c  ying to run it",
+0002e6a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002e6b0: 2020 2020 2020 2020 2074 732e 6b65 792c           ts.key,
+0002e6c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002e6d0: 2020 2020 2020 2020 2074 732e 7375 7370           ts.susp
+0002e6e0: 6963 696f 7573 2c0a 2020 2020 2020 2020  icious,.        
+0002e6f0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+0002e700: 2020 2020 2020 2072 6563 6f6d 7075 7465         recompute
+0002e710: 5f6b 6579 7320 3d20 7365 7428 290a 2020  _keys = set().  
+0002e720: 2020 2020 2020 6c6f 7374 5f6b 6579 7320        lost_keys 
+0002e730: 3d20 7365 7428 290a 0a20 2020 2020 2020  = set()..       
+0002e740: 2066 6f72 2074 7320 696e 206c 6973 7428   for ts in list(
+0002e750: 7773 2e68 6173 5f77 6861 7429 3a0a 2020  ws.has_what):.  
+0002e760: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
+0002e770: 656d 6f76 655f 7265 706c 6963 6128 7473  emove_replica(ts
+0002e780: 2c20 7773 290a 2020 2020 2020 2020 2020  , ws).          
+0002e790: 2020 6966 206e 6f74 2074 732e 7768 6f5f    if not ts.who_
+0002e7a0: 6861 733a 0a20 2020 2020 2020 2020 2020  has:.           
+0002e7b0: 2020 2020 2069 6620 7473 2e72 756e 5f73       if ts.run_s
+0002e7c0: 7065 633a 0a20 2020 2020 2020 2020 2020  pec:.           
+0002e7d0: 2020 2020 2020 2020 2072 6563 6f6d 7075           recompu
+0002e7e0: 7465 5f6b 6579 732e 6164 6428 7473 2e6b  te_keys.add(ts.k
+0002e7f0: 6579 290a 2020 2020 2020 2020 2020 2020  ey).            
+0002e800: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
+0002e810: 6461 7469 6f6e 735b 7473 2e6b 6579 5d20  dations[ts.key] 
+0002e820: 3d20 2272 656c 6561 7365 6422 0a20 2020  = "released".   
+0002e830: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+0002e840: 653a 2020 2320 7075 7265 2064 6174 610a  e:  # pure data.
+0002e850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e860: 2020 2020 6c6f 7374 5f6b 6579 732e 6164      lost_keys.ad
+0002e870: 6428 7473 2e6b 6579 290a 2020 2020 2020  d(ts.key).      
+0002e880: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0002e890: 636f 6d6d 656e 6461 7469 6f6e 735b 7473  commendations[ts
+0002e8a0: 2e6b 6579 5d20 3d20 2266 6f72 676f 7474  .key] = "forgott
+0002e8b0: 656e 220a 0a20 2020 2020 2020 2069 6620  en"..        if 
+0002e8c0: 7265 636f 6d70 7574 655f 6b65 7973 3a0a  recompute_keys:.
+0002e8d0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+0002e8e0: 6572 2e77 6172 6e69 6e67 280a 2020 2020  er.warning(.    
+0002e8f0: 2020 2020 2020 2020 2020 2020 6622 5265              f"Re
+0002e900: 6d6f 7669 6e67 2077 6f72 6b65 7220 7b77  moving worker {w
+0002e910: 732e 6164 6472 6573 7321 727d 2063 6175  s.address!r} cau
+0002e920: 7365 6420 7468 6520 636c 7573 7465 7220  sed the cluster 
+0002e930: 746f 206c 6f73 6520 220a 2020 2020 2020  to lose ".      
+0002e940: 2020 2020 2020 2020 2020 2261 6c72 6561            "alrea
+0002e950: 6479 2063 6f6d 7075 7465 6420 7461 736b  dy computed task
+0002e960: 2873 292c 2077 6869 6368 2077 696c 6c20  (s), which will 
+0002e970: 6265 2072 6563 6f6d 7075 7465 6420 656c  be recomputed el
+0002e980: 7365 7768 6572 653a 2022 0a20 2020 2020  sewhere: ".     
+0002e990: 2020 2020 2020 2020 2020 2066 227b 7265             f"{re
+0002e9a0: 636f 6d70 7574 655f 6b65 7973 7d20 287b  compute_keys} ({
+0002e9b0: 7374 696d 756c 7573 5f69 643d 7d29 220a  stimulus_id=})".
+0002e9c0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0002e9d0: 2020 2020 2020 6966 206c 6f73 745f 6b65        if lost_ke
+0002e9e0: 7973 3a0a 2020 2020 2020 2020 2020 2020  ys:.            
+0002e9f0: 6c6f 6767 6572 2e65 7272 6f72 280a 2020  logger.error(.  
+0002ea00: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+0002ea10: 5265 6d6f 7669 6e67 2077 6f72 6b65 7220  Removing worker 
+0002ea20: 7b77 732e 6164 6472 6573 7321 727d 2063  {ws.address!r} c
+0002ea30: 6175 7365 6420 7468 6520 636c 7573 7465  aused the cluste
+0002ea40: 7220 746f 206c 6f73 6520 7363 6174 7465  r to lose scatte
+0002ea50: 7265 6420 220a 2020 2020 2020 2020 2020  red ".          
+0002ea60: 2020 2020 2020 6622 6461 7461 2c20 7768        f"data, wh
+0002ea70: 6963 6820 6361 6e27 7420 6265 2072 6563  ich can't be rec
+0002ea80: 6f76 6572 6564 3a20 7b6c 6f73 745f 6b65  overed: {lost_ke
+0002ea90: 7973 7d20 287b 7374 696d 756c 7573 5f69  ys} ({stimulus_i
+0002eaa0: 643d 7d29 220a 2020 2020 2020 2020 2020  d=})".          
+0002eab0: 2020 290a 0a20 2020 2020 2020 2065 7665    )..        eve
+0002eac0: 6e74 5f6d 7367 203d 207b 0a20 2020 2020  nt_msg = {.     
+0002ead0: 2020 2020 2020 2022 6163 7469 6f6e 223a         "action":
+0002eae0: 2022 7265 6d6f 7665 2d77 6f72 6b65 7222   "remove-worker"
+0002eaf0: 2c0a 2020 2020 2020 2020 2020 2020 2270  ,.            "p
+0002eb00: 726f 6365 7373 696e 672d 7461 736b 7322  rocessing-tasks"
+0002eb10: 3a20 7072 6f63 6573 7369 6e67 5f6b 6579  : processing_key
+0002eb20: 732c 0a20 2020 2020 2020 2020 2020 2022  s,.            "
+0002eb30: 6c6f 7374 2d63 6f6d 7075 7465 642d 7461  lost-computed-ta
+0002eb40: 736b 7322 3a20 7265 636f 6d70 7574 655f  sks": recompute_
+0002eb50: 6b65 7973 2c0a 2020 2020 2020 2020 2020  keys,.          
+0002eb60: 2020 226c 6f73 742d 7363 6174 7465 7265    "lost-scattere
+0002eb70: 642d 7461 736b 7322 3a20 6c6f 7374 5f6b  d-tasks": lost_k
+0002eb80: 6579 732c 0a20 2020 2020 2020 2020 2020  eys,.           
+0002eb90: 2022 7374 696d 756c 7573 5f69 6422 3a20   "stimulus_id": 
+0002eba0: 7374 696d 756c 7573 5f69 642c 0a20 2020  stimulus_id,.   
+0002ebb0: 2020 2020 207d 0a20 2020 2020 2020 2073       }.        s
+0002ebc0: 656c 662e 6c6f 675f 6576 656e 7428 6164  elf.log_event(ad
+0002ebd0: 6472 6573 732c 2065 7665 6e74 5f6d 7367  dress, event_msg
+0002ebe0: 2e63 6f70 7928 2929 0a20 2020 2020 2020  .copy()).       
+0002ebf0: 2065 7665 6e74 5f6d 7367 5b22 776f 726b   event_msg["work
+0002ec00: 6572 225d 203d 2061 6464 7265 7373 0a20  er"] = address. 
+0002ec10: 2020 2020 2020 2073 656c 662e 6c6f 675f         self.log_
+0002ec20: 6576 656e 7428 2261 6c6c 222c 2065 7665  event("all", eve
+0002ec30: 6e74 5f6d 7367 290a 0a20 2020 2020 2020  nt_msg)..       
+0002ec40: 2073 656c 662e 7472 616e 7369 7469 6f6e   self.transition
+0002ec50: 7328 7265 636f 6d6d 656e 6461 7469 6f6e  s(recommendation
+0002ec60: 732c 2073 7469 6d75 6c75 735f 6964 3d73  s, stimulus_id=s
+0002ec70: 7469 6d75 6c75 735f 6964 290a 0a20 2020  timulus_id)..   
+0002ec80: 2020 2020 2061 7761 6974 6162 6c65 7320       awaitables 
+0002ec90: 3d20 5b5d 0a20 2020 2020 2020 2066 6f72  = [].        for
+0002eca0: 2070 6c75 6769 6e20 696e 206c 6973 7428   plugin in list(
+0002ecb0: 7365 6c66 2e70 6c75 6769 6e73 2e76 616c  self.plugins.val
+0002ecc0: 7565 7328 2929 3a0a 2020 2020 2020 2020  ues()):.        
+0002ecd0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0002ece0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+0002ecf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ed00: 2020 7265 7375 6c74 203d 2070 6c75 6769    result = plugi
+0002ed10: 6e2e 7265 6d6f 7665 5f77 6f72 6b65 7228  n.remove_worker(
+0002ed20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002ed30: 2020 2020 2020 2020 2073 6368 6564 756c           schedul
+0002ed40: 6572 3d73 656c 662c 2077 6f72 6b65 723d  er=self, worker=
+0002ed50: 6164 6472 6573 732c 2073 7469 6d75 6c75  address, stimulu
+0002ed60: 735f 6964 3d73 7469 6d75 6c75 735f 6964  s_id=stimulus_id
+0002ed70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002ed80: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0002ed90: 2020 2020 2020 2065 7863 6570 7420 5479         except Ty
+0002eda0: 7065 4572 726f 723a 0a20 2020 2020 2020  peError:.       
+0002edb0: 2020 2020 2020 2020 2020 2020 2070 6172               par
+0002edc0: 616d 6574 6572 7320 3d20 696e 7370 6563  ameters = inspec
+0002edd0: 742e 7369 676e 6174 7572 6528 706c 7567  t.signature(plug
+0002ede0: 696e 2e72 656d 6f76 655f 776f 726b 6572  in.remove_worker
+0002edf0: 292e 7061 7261 6d65 7465 7273 0a20 2020  ).parameters.   
+0002ee00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ee10: 2069 6620 2273 7469 6d75 6c75 735f 6964   if "stimulus_id
+0002ee20: 2220 6e6f 7420 696e 2070 6172 616d 6574  " not in paramet
+0002ee30: 6572 7320 616e 6420 6e6f 7420 616e 7928  ers and not any(
+0002ee40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002ee50: 2020 2020 2020 2020 2070 2e6b 696e 6420           p.kind 
+0002ee60: 6973 2070 2e56 4152 5f4b 4559 574f 5244  is p.VAR_KEYWORD
+0002ee70: 2066 6f72 2070 2069 6e20 7061 7261 6d65   for p in parame
+0002ee80: 7465 7273 2e76 616c 7565 7328 290a 2020  ters.values().  
+0002ee90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002eea0: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
+0002eeb0: 2020 2020 2020 2020 2020 2020 2023 2044               # D
+0002eec0: 6570 7265 6361 7465 6420 2873 6565 2061  eprecated (see a
+0002eed0: 6464 5f70 6c75 6769 6e29 0a20 2020 2020  dd_plugin).     
+0002eee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002eef0: 2020 2072 6573 756c 7420 3d20 706c 7567     result = plug
+0002ef00: 696e 2e72 656d 6f76 655f 776f 726b 6572  in.remove_worker
+0002ef10: 2873 6368 6564 756c 6572 3d73 656c 662c  (scheduler=self,
+0002ef20: 2077 6f72 6b65 723d 6164 6472 6573 7329   worker=address)
+0002ef30: 2020 2320 7479 7065 3a20 6967 6e6f 7265    # type: ignore
+0002ef40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002ef50: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0002ef60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ef70: 2020 2072 6169 7365 0a20 2020 2020 2020     raise.       
+0002ef80: 2020 2020 2020 2020 2069 6620 696e 7370           if insp
+0002ef90: 6563 742e 6973 6177 6169 7461 626c 6528  ect.isawaitable(
+0002efa0: 7265 7375 6c74 293a 0a20 2020 2020 2020  result):.       
+0002efb0: 2020 2020 2020 2020 2020 2020 2061 7761               awa
+0002efc0: 6974 6162 6c65 732e 6170 7065 6e64 2872  itables.append(r
+0002efd0: 6573 756c 7429 0a20 2020 2020 2020 2020  esult).         
+0002efe0: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
+0002eff0: 696f 6e20 6173 2065 3a0a 2020 2020 2020  ion as e:.      
+0002f000: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+0002f010: 2e65 7863 6570 7469 6f6e 2865 290a 0a20  .exception(e).. 
+0002f020: 2020 2020 2020 2070 6c75 6769 6e5f 6d73         plugin_ms
+0002f030: 6773 203d 2061 7761 6974 2061 7379 6e63  gs = await async
+0002f040: 696f 2e67 6174 6865 7228 2a61 7761 6974  io.gather(*await
+0002f050: 6162 6c65 732c 2072 6574 7572 6e5f 6578  ables, return_ex
+0002f060: 6365 7074 696f 6e73 3d54 7275 6529 0a20  ceptions=True). 
+0002f070: 2020 2020 2020 2070 6c75 6769 6e73 5f65         plugins_e
+0002f080: 7863 6570 7469 6f6e 7320 3d20 5b6d 7367  xceptions = [msg
+0002f090: 2066 6f72 206d 7367 2069 6e20 706c 7567   for msg in plug
+0002f0a0: 696e 5f6d 7367 7320 6966 2069 7369 6e73  in_msgs if isins
+0002f0b0: 7461 6e63 6528 6d73 672c 2045 7863 6570  tance(msg, Excep
+0002f0c0: 7469 6f6e 295d 0a20 2020 2020 2020 2066  tion)].        f
+0002f0d0: 6f72 2065 7863 2069 6e20 706c 7567 696e  or exc in plugin
+0002f0e0: 735f 6578 6365 7074 696f 6e73 3a0a 2020  s_exceptions:.  
+0002f0f0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+0002f100: 2e65 7863 6570 7469 6f6e 2865 7863 2c20  .exception(exc, 
+0002f110: 6578 635f 696e 666f 3d65 7863 290a 0a20  exc_info=exc).. 
+0002f120: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
+0002f130: 6c66 2e77 6f72 6b65 7273 3a0a 2020 2020  lf.workers:.    
+0002f140: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
+0002f150: 6e66 6f28 224c 6f73 7420 616c 6c20 776f  nfo("Lost all wo
+0002f160: 726b 6572 7322 290a 0a20 2020 2020 2020  rkers")..       
+0002f170: 2066 6f72 2077 2069 6e20 7365 6c66 2e77   for w in self.w
+0002f180: 6f72 6b65 7273 3a0a 2020 2020 2020 2020  orkers:.        
+0002f190: 2020 2020 7365 6c66 2e62 616e 6477 6964      self.bandwid
+0002f1a0: 7468 5f77 6f72 6b65 7273 2e70 6f70 2828  th_workers.pop((
+0002f1b0: 6164 6472 6573 732c 2077 292c 204e 6f6e  address, w), Non
+0002f1c0: 6529 0a20 2020 2020 2020 2020 2020 2073  e).            s
+0002f1d0: 656c 662e 6261 6e64 7769 6474 685f 776f  elf.bandwidth_wo
+0002f1e0: 726b 6572 732e 706f 7028 2877 2c20 6164  rkers.pop((w, ad
+0002f1f0: 6472 6573 7329 2c20 4e6f 6e65 290a 0a20  dress), None).. 
+0002f200: 2020 2020 2020 2061 7379 6e63 2064 6566         async def
+0002f210: 2072 656d 6f76 655f 776f 726b 6572 5f66   remove_worker_f
+0002f220: 726f 6d5f 6576 656e 7473 2829 202d 3e20  rom_events() -> 
+0002f230: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0002f240: 2020 2320 4966 2074 6865 2077 6f72 6b65    # If the worke
+0002f250: 7220 6973 6e27 7420 7265 6769 7374 6572  r isn't register
+0002f260: 6564 2061 6e79 6d6f 7265 2061 6674 6572  ed anymore after
+0002f270: 2074 6865 2064 656c 6179 2c20 7265 6d6f   the delay, remo
+0002f280: 7665 2066 726f 6d20 6576 656e 7473 0a20  ve from events. 
+0002f290: 2020 2020 2020 2020 2020 2069 6620 6164             if ad
+0002f2a0: 6472 6573 7320 6e6f 7420 696e 2073 656c  dress not in sel
+0002f2b0: 662e 776f 726b 6572 7320 616e 6420 6164  f.workers and ad
+0002f2c0: 6472 6573 7320 696e 2073 656c 662e 6576  dress in self.ev
+0002f2d0: 656e 7473 3a0a 2020 2020 2020 2020 2020  ents:.          
+0002f2e0: 2020 2020 2020 6465 6c20 7365 6c66 2e65        del self.e
+0002f2f0: 7665 6e74 735b 6164 6472 6573 735d 0a0a  vents[address]..
+0002f300: 2020 2020 2020 2020 636c 6561 6e75 705f          cleanup_
+0002f310: 6465 6c61 7920 3d20 7061 7273 655f 7469  delay = parse_ti
+0002f320: 6d65 6465 6c74 6128 0a20 2020 2020 2020  medelta(.       
+0002f330: 2020 2020 2064 6173 6b2e 636f 6e66 6967       dask.config
+0002f340: 2e67 6574 2822 6469 7374 7269 6275 7465  .get("distribute
+0002f350: 642e 7363 6865 6475 6c65 722e 6576 656e  d.scheduler.even
+0002f360: 7473 2d63 6c65 616e 7570 2d64 656c 6179  ts-cleanup-delay
+0002f370: 2229 0a20 2020 2020 2020 2029 0a0a 2020  ").        )..  
+0002f380: 2020 2020 2020 7365 6c66 2e5f 6f6e 676f        self._ongo
+0002f390: 696e 675f 6261 636b 6772 6f75 6e64 5f74  ing_background_t
+0002f3a0: 6173 6b73 2e63 616c 6c5f 6c61 7465 7228  asks.call_later(
+0002f3b0: 0a20 2020 2020 2020 2020 2020 2063 6c65  .            cle
+0002f3c0: 616e 7570 5f64 656c 6179 2c20 7265 6d6f  anup_delay, remo
+0002f3d0: 7665 5f77 6f72 6b65 725f 6672 6f6d 5f65  ve_worker_from_e
+0002f3e0: 7665 6e74 730a 2020 2020 2020 2020 290a  vents.        ).
+0002f3f0: 2020 2020 2020 2020 6c6f 6767 6572 2e64          logger.d
+0002f400: 6562 7567 2822 5265 6d6f 7665 6420 776f  ebug("Removed wo
+0002f410: 726b 6572 2025 7322 2c20 7773 290a 0a20  rker %s", ws).. 
+0002f420: 2020 2020 2020 2066 6f72 2077 2069 6e20         for w in 
+0002f430: 7365 6c66 2e77 6f72 6b65 7273 3a0a 2020  self.workers:.  
+0002f440: 2020 2020 2020 2020 2020 7365 6c66 2e77            self.w
+0002f450: 6f72 6b65 725f 7365 6e64 280a 2020 2020  orker_send(.    
+0002f460: 2020 2020 2020 2020 2020 2020 772c 0a20              w,. 
+0002f470: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+0002f480: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002f490: 2020 2020 2022 6f70 223a 2022 7265 6d6f       "op": "remo
+0002f4a0: 7665 2d77 6f72 6b65 7222 2c0a 2020 2020  ve-worker",.    
+0002f4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f4c0: 2277 6f72 6b65 7222 3a20 6164 6472 6573  "worker": addres
+0002f4d0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+0002f4e0: 2020 2020 2020 2022 7374 696d 756c 7573         "stimulus
+0002f4f0: 5f69 6422 3a20 7374 696d 756c 7573 5f69  _id": stimulus_i
+0002f500: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+0002f510: 2020 207d 2c0a 2020 2020 2020 2020 2020     },.          
+0002f520: 2020 290a 0a20 2020 2020 2020 2072 6574    )..        ret
+0002f530: 7572 6e20 224f 4b22 0a0a 2020 2020 6465  urn "OK"..    de
+0002f540: 6620 7374 696d 756c 7573 5f63 616e 6365  f stimulus_cance
+0002f550: 6c28 0a20 2020 2020 2020 2073 656c 662c  l(.        self,
+0002f560: 206b 6579 733a 2043 6f6c 6c65 6374 696f   keys: Collectio
+0002f570: 6e5b 4b65 795d 2c20 636c 6965 6e74 3a20  n[Key], client: 
+0002f580: 7374 722c 2066 6f72 6365 3a20 626f 6f6c  str, force: bool
+0002f590: 203d 2046 616c 7365 0a20 2020 2029 202d   = False.    ) -
+0002f5a0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+0002f5b0: 2222 2253 746f 7020 6578 6563 7574 696f  """Stop executio
+0002f5c0: 6e20 6f6e 2061 206c 6973 7420 6f66 206b  n on a list of k
+0002f5d0: 6579 7322 2222 0a20 2020 2020 2020 206c  eys""".        l
+0002f5e0: 6f67 6765 722e 696e 666f 2822 436c 6965  ogger.info("Clie
+0002f5f0: 6e74 2025 7320 7265 7175 6573 7473 2074  nt %s requests t
+0002f600: 6f20 6361 6e63 656c 2025 6420 6b65 7973  o cancel %d keys
+0002f610: 222c 2063 6c69 656e 742c 206c 656e 286b  ", client, len(k
+0002f620: 6579 7329 290a 2020 2020 2020 2020 7365  eys)).        se
+0002f630: 6c66 2e6c 6f67 5f65 7665 6e74 2863 6c69  lf.log_event(cli
+0002f640: 656e 742c 207b 2261 6374 696f 6e22 3a20  ent, {"action": 
+0002f650: 2263 616e 6365 6c22 2c20 2263 6f75 6e74  "cancel", "count
+0002f660: 223a 206c 656e 286b 6579 7329 2c20 2266  ": len(keys), "f
+0002f670: 6f72 6365 223a 2066 6f72 6365 7d29 0a20  orce": force}). 
+0002f680: 2020 2020 2020 2063 7320 3d20 7365 6c66         cs = self
+0002f690: 2e63 6c69 656e 7473 2e67 6574 2863 6c69  .clients.get(cli
+0002f6a0: 656e 7429 0a20 2020 2020 2020 2069 6620  ent).        if 
+0002f6b0: 6e6f 7420 6373 3a0a 2020 2020 2020 2020  not cs:.        
+0002f6c0: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
+0002f6d0: 2020 2020 6361 6e63 656c 6c65 645f 6b65      cancelled_ke
+0002f6e0: 7973 203d 205b 5d0a 2020 2020 2020 2020  ys = [].        
+0002f6f0: 636c 6965 6e74 7320 3d20 5b5d 0a20 2020  clients = [].   
+0002f700: 2020 2020 2066 6f72 206b 6579 2069 6e20       for key in 
+0002f710: 6b65 7973 3a0a 2020 2020 2020 2020 2020  keys:.          
+0002f720: 2020 7473 203d 2073 656c 662e 7461 736b    ts = self.task
+0002f730: 732e 6765 7428 6b65 7929 0a20 2020 2020  s.get(key).     
+0002f740: 2020 2020 2020 2069 6620 6e6f 7420 7473         if not ts
+0002f750: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002f760: 2020 636f 6e74 696e 7565 0a0a 2020 2020    continue..    
+0002f770: 2020 2020 2020 2020 6966 2066 6f72 6365          if force
+0002f780: 206f 7220 7473 2e77 686f 5f77 616e 7473   or ts.who_wants
+0002f790: 203d 3d20 7b63 737d 3a20 2023 206e 6f20   == {cs}:  # no 
+0002f7a0: 6f6e 6520 656c 7365 2077 616e 7473 2074  one else wants t
+0002f7b0: 6869 7320 6b65 790a 2020 2020 2020 2020  his key.        
+0002f7c0: 2020 2020 2020 2020 6966 2074 732e 6465          if ts.de
+0002f7d0: 7065 6e64 656e 7473 3a0a 2020 2020 2020  pendents:.      
+0002f7e0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0002f7f0: 6c66 2e73 7469 6d75 6c75 735f 6361 6e63  lf.stimulus_canc
+0002f800: 656c 280a 2020 2020 2020 2020 2020 2020  el(.            
+0002f810: 2020 2020 2020 2020 2020 2020 5b64 7473              [dts
+0002f820: 2e6b 6579 2066 6f72 2064 7473 2069 6e20  .key for dts in 
+0002f830: 7473 2e64 6570 656e 6465 6e74 735d 2c20  ts.dependents], 
+0002f840: 636c 6965 6e74 2c20 666f 7263 653d 666f  client, force=fo
+0002f850: 7263 650a 2020 2020 2020 2020 2020 2020  rce.            
+0002f860: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0002f870: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+0002f880: 2e69 6e66 6f28 2253 6368 6564 756c 6572  .info("Scheduler
+0002f890: 2063 616e 6365 6c73 206b 6579 2025 732e   cancels key %s.
+0002f8a0: 2020 466f 7263 653d 2573 222c 206b 6579    Force=%s", key
+0002f8b0: 2c20 666f 7263 6529 0a20 2020 2020 2020  , force).       
+0002f8c0: 2020 2020 2020 2020 2063 616e 6365 6c6c           cancell
+0002f8d0: 6564 5f6b 6579 732e 6170 7065 6e64 286b  ed_keys.append(k
+0002f8e0: 6579 290a 2020 2020 2020 2020 2020 2020  ey).            
+0002f8f0: 6173 7365 7274 2074 732e 7768 6f5f 7761  assert ts.who_wa
+0002f900: 6e74 730a 2020 2020 2020 2020 2020 2020  nts.            
+0002f910: 636c 6965 6e74 732e 6578 7465 6e64 286c  clients.extend(l
+0002f920: 6973 7428 7473 2e77 686f 5f77 616e 7473  ist(ts.who_wants
+0002f930: 2920 6966 2066 6f72 6365 2065 6c73 6520  ) if force else 
+0002f940: 5b63 735d 290a 2020 2020 2020 2020 666f  [cs]).        fo
+0002f950: 7220 6373 2069 6e20 636c 6965 6e74 733a  r cs in clients:
+0002f960: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0002f970: 662e 636c 6965 6e74 5f72 656c 6561 7365  f.client_release
+0002f980: 735f 6b65 7973 280a 2020 2020 2020 2020  s_keys(.        
+0002f990: 2020 2020 2020 2020 6b65 7973 3d63 616e          keys=can
+0002f9a0: 6365 6c6c 6564 5f6b 6579 732c 0a20 2020  celled_keys,.   
+0002f9b0: 2020 2020 2020 2020 2020 2020 2063 6c69               cli
+0002f9c0: 656e 743d 6373 2e63 6c69 656e 745f 6b65  ent=cs.client_ke
+0002f9d0: 792c 0a20 2020 2020 2020 2020 2020 2020  y,.             
+0002f9e0: 2020 2073 7469 6d75 6c75 735f 6964 3d66     stimulus_id=f
+0002f9f0: 2263 616e 6365 6c2d 6b65 792d 7b74 696d  "cancel-key-{tim
+0002fa00: 6528 297d 222c 0a20 2020 2020 2020 2020  e()}",.         
+0002fa10: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
+0002fa20: 662e 7265 706f 7274 287b 226f 7022 3a20  f.report({"op": 
+0002fa30: 2263 616e 6365 6c6c 6564 2d6b 6579 7322  "cancelled-keys"
+0002fa40: 2c20 226b 6579 7322 3a20 6361 6e63 656c  , "keys": cancel
+0002fa50: 6c65 645f 6b65 7973 7d29 0a0a 2020 2020  led_keys})..    
+0002fa60: 6465 6620 636c 6965 6e74 5f64 6573 6972  def client_desir
+0002fa70: 6573 5f6b 6579 7328 7365 6c66 2c20 6b65  es_keys(self, ke
+0002fa80: 7973 3a20 436f 6c6c 6563 7469 6f6e 5b4b  ys: Collection[K
+0002fa90: 6579 5d2c 2063 6c69 656e 743a 2073 7472  ey], client: str
+0002faa0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+0002fab0: 2020 2063 7320 3d20 7365 6c66 2e63 6c69     cs = self.cli
+0002fac0: 656e 7473 2e67 6574 2863 6c69 656e 7429  ents.get(client)
+0002fad0: 0a20 2020 2020 2020 2069 6620 6373 2069  .        if cs i
+0002fae0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0002faf0: 2020 2020 2320 466f 7220 7075 626c 6973      # For publis
+0002fb00: 682c 2071 7565 7565 7320 6574 632e 0a20  h, queues etc.. 
+0002fb10: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0002fb20: 636c 6965 6e74 735b 636c 6965 6e74 5d20  clients[client] 
+0002fb30: 3d20 6373 203d 2043 6c69 656e 7453 7461  = cs = ClientSta
+0002fb40: 7465 2863 6c69 656e 7429 0a0a 2020 2020  te(client)..    
+0002fb50: 2020 2020 666f 7220 6b20 696e 206b 6579      for k in key
+0002fb60: 733a 0a20 2020 2020 2020 2020 2020 2074  s:.            t
+0002fb70: 7320 3d20 7365 6c66 2e74 6173 6b73 2e67  s = self.tasks.g
+0002fb80: 6574 286b 290a 2020 2020 2020 2020 2020  et(k).          
+0002fb90: 2020 6966 2074 7320 6973 204e 6f6e 653a    if ts is None:
+0002fba0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002fbb0: 2023 2046 6f72 2070 7562 6c69 7368 2c20   # For publish, 
+0002fbc0: 7175 6575 6573 2065 7463 2e0a 2020 2020  queues etc..    
+0002fbd0: 2020 2020 2020 2020 2020 2020 7473 203d              ts =
+0002fbe0: 2073 656c 662e 6e65 775f 7461 736b 286b   self.new_task(k
+0002fbf0: 2c20 4e6f 6e65 2c20 2272 656c 6561 7365  , None, "release
+0002fc00: 6422 290a 2020 2020 2020 2020 2020 2020  d").            
+0002fc10: 6966 2074 732e 7768 6f5f 7761 6e74 7320  if ts.who_wants 
+0002fc20: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+0002fc30: 2020 2020 2020 2020 2074 732e 7768 6f5f           ts.who_
+0002fc40: 7761 6e74 7320 3d20 7365 7428 290a 2020  wants = set().  
+0002fc50: 2020 2020 2020 2020 2020 7473 2e77 686f            ts.who
+0002fc60: 5f77 616e 7473 2e61 6464 2863 7329 0a20  _wants.add(cs). 
+0002fc70: 2020 2020 2020 2020 2020 2063 732e 7761             cs.wa
+0002fc80: 6e74 735f 7768 6174 2e61 6464 2874 7329  nts_what.add(ts)
+0002fc90: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+0002fca0: 2074 732e 7374 6174 6520 696e 2028 226d   ts.state in ("m
+0002fcb0: 656d 6f72 7922 2c20 2265 7272 6564 2229  emory", "erred")
+0002fcc0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002fcd0: 2020 7365 6c66 2e72 6570 6f72 745f 6f6e    self.report_on
+0002fce0: 5f6b 6579 2874 733d 7473 2c20 636c 6965  _key(ts=ts, clie
+0002fcf0: 6e74 3d63 6c69 656e 7429 0a0a 2020 2020  nt=client)..    
+0002fd00: 6465 6620 636c 6965 6e74 5f72 656c 6561  def client_relea
+0002fd10: 7365 735f 6b65 7973 280a 2020 2020 2020  ses_keys(.      
+0002fd20: 2020 7365 6c66 2c20 6b65 7973 3a20 436f    self, keys: Co
+0002fd30: 6c6c 6563 7469 6f6e 5b4b 6579 5d2c 2063  llection[Key], c
+0002fd40: 6c69 656e 743a 2073 7472 2c20 7374 696d  lient: str, stim
+0002fd50: 756c 7573 5f69 643a 2073 7472 207c 204e  ulus_id: str | N
+0002fd60: 6f6e 6520 3d20 4e6f 6e65 0a20 2020 2029  one = None.    )
+0002fd70: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+0002fd80: 2020 2222 2252 656d 6f76 6520 6b65 7973    """Remove keys
+0002fd90: 2066 726f 6d20 636c 6965 6e74 2064 6573   from client des
+0002fda0: 6972 6564 206c 6973 7422 2222 0a20 2020  ired list""".   
+0002fdb0: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
+0002fdc0: 203d 2073 7469 6d75 6c75 735f 6964 206f   = stimulus_id o
+0002fdd0: 7220 6622 636c 6965 6e74 2d72 656c 6561  r f"client-relea
+0002fde0: 7365 732d 6b65 7973 2d7b 7469 6d65 2829  ses-keys-{time()
+0002fdf0: 7d22 0a20 2020 2020 2020 2069 6620 6e6f  }".        if no
+0002fe00: 7420 6973 696e 7374 616e 6365 286b 6579  t isinstance(key
+0002fe10: 732c 206c 6973 7429 3a0a 2020 2020 2020  s, list):.      
+0002fe20: 2020 2020 2020 6b65 7973 203d 206c 6973        keys = lis
+0002fe30: 7428 6b65 7973 290a 2020 2020 2020 2020  t(keys).        
+0002fe40: 6373 203d 2073 656c 662e 636c 6965 6e74  cs = self.client
+0002fe50: 735b 636c 6965 6e74 5d0a 2020 2020 2020  s[client].      
+0002fe60: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
+0002fe70: 733a 2052 6563 7320 3d20 7b7d 0a0a 2020  s: Recs = {}..  
+0002fe80: 2020 2020 2020 7365 6c66 2e5f 636c 6965        self._clie
+0002fe90: 6e74 5f72 656c 6561 7365 735f 6b65 7973  nt_releases_keys
+0002fea0: 286b 6579 733d 6b65 7973 2c20 6373 3d63  (keys=keys, cs=c
+0002feb0: 732c 2072 6563 6f6d 6d65 6e64 6174 696f  s, recommendatio
+0002fec0: 6e73 3d72 6563 6f6d 6d65 6e64 6174 696f  ns=recommendatio
+0002fed0: 6e73 290a 2020 2020 2020 2020 7365 6c66  ns).        self
+0002fee0: 2e74 7261 6e73 6974 696f 6e73 2872 6563  .transitions(rec
+0002fef0: 6f6d 6d65 6e64 6174 696f 6e73 2c20 7374  ommendations, st
+0002ff00: 696d 756c 7573 5f69 6429 0a0a 2020 2020  imulus_id)..    
+0002ff10: 2020 2020 7365 6c66 2e73 7469 6d75 6c75      self.stimulu
+0002ff20: 735f 7175 6575 655f 736c 6f74 735f 6d61  s_queue_slots_ma
+0002ff30: 7962 655f 6f70 656e 6564 2873 7469 6d75  ybe_opened(stimu
+0002ff40: 6c75 735f 6964 3d73 7469 6d75 6c75 735f  lus_id=stimulus_
+0002ff50: 6964 290a 0a20 2020 2064 6566 2063 6c69  id)..    def cli
+0002ff60: 656e 745f 6865 6172 7462 6561 7428 7365  ent_heartbeat(se
+0002ff70: 6c66 2c20 636c 6965 6e74 3a20 7374 7229  lf, client: str)
+0002ff80: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+0002ff90: 2020 2222 2248 616e 646c 6520 6865 6172    """Handle hear
+0002ffa0: 7462 6561 7473 2066 726f 6d20 436c 6965  tbeats from Clie
+0002ffb0: 6e74 2222 220a 2020 2020 2020 2020 6373  nt""".        cs
+0002ffc0: 203d 2073 656c 662e 636c 6965 6e74 735b   = self.clients[
+0002ffd0: 636c 6965 6e74 5d0a 2020 2020 2020 2020  client].        
+0002ffe0: 6373 2e6c 6173 745f 7365 656e 203d 2074  cs.last_seen = t
+0002fff0: 696d 6528 290a 0a20 2020 2023 2323 2323  ime()..    #####
+00030000: 2323 2323 2323 2323 2323 2323 2323 0a20  ##############. 
+00030010: 2020 2023 2054 6173 6b20 5661 6c69 6461     # Task Valida
+00030020: 7469 6f6e 2023 0a20 2020 2023 2323 2323  tion #.    #####
+00030030: 2323 2323 2323 2323 2323 2323 2323 0a0a  ##############..
+00030040: 2020 2020 6465 6620 7661 6c69 6461 7465      def validate
+00030050: 5f72 656c 6561 7365 6428 7365 6c66 2c20  _released(self, 
+00030060: 6b65 793a 204b 6579 2920 2d3e 204e 6f6e  key: Key) -> Non
+00030070: 653a 0a20 2020 2020 2020 2074 7320 3d20  e:.        ts = 
+00030080: 7365 6c66 2e74 6173 6b73 5b6b 6579 5d0a  self.tasks[key].
+00030090: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
+000300a0: 732e 7374 6174 6520 3d3d 2022 7265 6c65  s.state == "rele
+000300b0: 6173 6564 220a 2020 2020 2020 2020 6173  ased".        as
+000300c0: 7365 7274 206e 6f74 2074 732e 7761 6974  sert not ts.wait
+000300d0: 6572 730a 2020 2020 2020 2020 6173 7365  ers.        asse
+000300e0: 7274 206e 6f74 2074 732e 7761 6974 696e  rt not ts.waitin
+000300f0: 675f 6f6e 0a20 2020 2020 2020 2061 7373  g_on.        ass
+00030100: 6572 7420 6e6f 7420 7473 2e77 686f 5f68  ert not ts.who_h
+00030110: 6173 0a20 2020 2020 2020 2061 7373 6572  as.        asser
+00030120: 7420 6e6f 7420 7473 2e70 726f 6365 7373  t not ts.process
+00030130: 696e 675f 6f6e 0a20 2020 2020 2020 2061  ing_on.        a
+00030140: 7373 6572 7420 6e6f 7420 616e 7928 5b74  ssert not any([t
+00030150: 7320 696e 2028 6474 732e 7761 6974 6572  s in (dts.waiter
+00030160: 7320 6f72 2028 2929 2066 6f72 2064 7473  s or ()) for dts
+00030170: 2069 6e20 7473 2e64 6570 656e 6465 6e63   in ts.dependenc
+00030180: 6965 735d 290a 2020 2020 2020 2020 6173  ies]).        as
+00030190: 7365 7274 2074 7320 6e6f 7420 696e 2073  sert ts not in s
+000301a0: 656c 662e 756e 7275 6e6e 6162 6c65 0a20  elf.unrunnable. 
+000301b0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
+000301c0: 206e 6f74 2069 6e20 7365 6c66 2e71 7565   not in self.que
+000301d0: 7565 640a 0a20 2020 2064 6566 2076 616c  ued..    def val
+000301e0: 6964 6174 655f 7761 6974 696e 6728 7365  idate_waiting(se
+000301f0: 6c66 2c20 6b65 793a 204b 6579 2920 2d3e  lf, key: Key) ->
+00030200: 204e 6f6e 653a 0a20 2020 2020 2020 2074   None:.        t
+00030210: 7320 3d20 7365 6c66 2e74 6173 6b73 5b6b  s = self.tasks[k
+00030220: 6579 5d0a 2020 2020 2020 2020 6173 7365  ey].        asse
+00030230: 7274 2074 732e 7761 6974 696e 675f 6f6e  rt ts.waiting_on
+00030240: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00030250: 6e6f 7420 7473 2e77 686f 5f68 6173 0a20  not ts.who_has. 
+00030260: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
+00030270: 7420 7473 2e70 726f 6365 7373 696e 675f  t ts.processing_
+00030280: 6f6e 0a20 2020 2020 2020 2061 7373 6572  on.        asser
+00030290: 7420 7473 206e 6f74 2069 6e20 7365 6c66  t ts not in self
+000302a0: 2e75 6e72 756e 6e61 626c 650a 2020 2020  .unrunnable.    
+000302b0: 2020 2020 6173 7365 7274 2074 7320 6e6f      assert ts no
+000302c0: 7420 696e 2073 656c 662e 7175 6575 6564  t in self.queued
+000302d0: 0a20 2020 2020 2020 2066 6f72 2064 7473  .        for dts
+000302e0: 2069 6e20 7473 2e64 6570 656e 6465 6e63   in ts.dependenc
+000302f0: 6965 733a 0a20 2020 2020 2020 2020 2020  ies:.           
+00030300: 2023 2057 6520 6172 6520 7761 6974 696e   # We are waitin
+00030310: 6720 6f6e 2061 2064 6570 656e 6465 6e63  g on a dependenc
+00030320: 7920 6966 6620 6974 2773 206e 6f74 2073  y iff it's not s
+00030330: 746f 7265 640a 2020 2020 2020 2020 2020  tored.          
+00030340: 2020 6173 7365 7274 2062 6f6f 6c28 6474    assert bool(dt
+00030350: 732e 7768 6f5f 6861 7329 2021 3d20 2864  s.who_has) != (d
+00030360: 7473 2069 6e20 2874 732e 7761 6974 696e  ts in (ts.waitin
+00030370: 675f 6f6e 206f 7220 2829 2929 0a20 2020  g_on or ())).   
+00030380: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00030390: 7473 2069 6e20 2864 7473 2e77 6169 7465  ts in (dts.waite
+000303a0: 7273 206f 7220 2829 2920 2023 2058 5858  rs or ())  # XXX
+000303b0: 2065 7665 6e20 6966 2064 7473 2e5f 7768   even if dts._wh
+000303c0: 6f5f 6861 733f 0a0a 2020 2020 6465 6620  o_has?..    def 
+000303d0: 7661 6c69 6461 7465 5f71 7565 7565 6428  validate_queued(
+000303e0: 7365 6c66 2c20 6b65 793a 204b 6579 2920  self, key: Key) 
+000303f0: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+00030400: 2074 7320 3d20 7365 6c66 2e74 6173 6b73   ts = self.tasks
+00030410: 5b6b 6579 5d0a 2020 2020 2020 2020 6173  [key].        as
+00030420: 7365 7274 2074 7320 696e 2073 656c 662e  sert ts in self.
+00030430: 7175 6575 6564 0a20 2020 2020 2020 2061  queued.        a
+00030440: 7373 6572 7420 6e6f 7420 7473 2e77 6169  ssert not ts.wai
+00030450: 7469 6e67 5f6f 6e0a 2020 2020 2020 2020  ting_on.        
+00030460: 6173 7365 7274 206e 6f74 2074 732e 7768  assert not ts.wh
+00030470: 6f5f 6861 730a 2020 2020 2020 2020 6173  o_has.        as
+00030480: 7365 7274 206e 6f74 2074 732e 7072 6f63  sert not ts.proc
+00030490: 6573 7369 6e67 5f6f 6e0a 2020 2020 2020  essing_on.      
+000304a0: 2020 6173 7365 7274 206e 6f74 2028 0a20    assert not (. 
+000304b0: 2020 2020 2020 2020 2020 2074 732e 776f             ts.wo
+000304c0: 726b 6572 5f72 6573 7472 6963 7469 6f6e  rker_restriction
+000304d0: 7320 6f72 2074 732e 686f 7374 5f72 6573  s or ts.host_res
+000304e0: 7472 6963 7469 6f6e 7320 6f72 2074 732e  trictions or ts.
+000304f0: 7265 736f 7572 6365 5f72 6573 7472 6963  resource_restric
+00030500: 7469 6f6e 730a 2020 2020 2020 2020 290a  tions.        ).
+00030510: 2020 2020 2020 2020 666f 7220 6474 7320          for dts 
+00030520: 696e 2074 732e 6465 7065 6e64 656e 6369  in ts.dependenci
+00030530: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+00030540: 6173 7365 7274 2064 7473 2e77 686f 5f68  assert dts.who_h
+00030550: 6173 0a20 2020 2020 2020 2020 2020 2061  as.            a
+00030560: 7373 6572 7420 7473 2069 6e20 2864 7473  ssert ts in (dts
+00030570: 2e77 6169 7465 7273 206f 7220 2829 290a  .waiters or ()).
+00030580: 0a20 2020 2064 6566 2076 616c 6964 6174  .    def validat
+00030590: 655f 7072 6f63 6573 7369 6e67 2873 656c  e_processing(sel
+000305a0: 662c 206b 6579 3a20 4b65 7929 202d 3e20  f, key: Key) -> 
+000305b0: 4e6f 6e65 3a0a 2020 2020 2020 2020 7473  None:.        ts
+000305c0: 203d 2073 656c 662e 7461 736b 735b 6b65   = self.tasks[ke
+000305d0: 795d 0a20 2020 2020 2020 2061 7373 6572  y].        asser
+000305e0: 7420 6e6f 7420 7473 2e77 6169 7469 6e67  t not ts.waiting
+000305f0: 5f6f 6e0a 2020 2020 2020 2020 7773 203d  _on.        ws =
+00030600: 2074 732e 7072 6f63 6573 7369 6e67 5f6f   ts.processing_o
+00030610: 6e0a 2020 2020 2020 2020 6173 7365 7274  n.        assert
+00030620: 2077 730a 2020 2020 2020 2020 6173 7365   ws.        asse
+00030630: 7274 2074 7320 696e 2077 732e 7072 6f63  rt ts in ws.proc
+00030640: 6573 7369 6e67 0a20 2020 2020 2020 2061  essing.        a
+00030650: 7373 6572 7420 6e6f 7420 7473 2e77 686f  ssert not ts.who
+00030660: 5f68 6173 0a20 2020 2020 2020 2061 7373  _has.        ass
+00030670: 6572 7420 7473 206e 6f74 2069 6e20 7365  ert ts not in se
+00030680: 6c66 2e71 7565 7565 640a 2020 2020 2020  lf.queued.      
+00030690: 2020 666f 7220 6474 7320 696e 2074 732e    for dts in ts.
+000306a0: 6465 7065 6e64 656e 6369 6573 3a0a 2020  dependencies:.  
+000306b0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+000306c0: 2064 7473 2e77 686f 5f68 6173 206f 7220   dts.who_has or 
+000306d0: 2829 0a20 2020 2020 2020 2020 2020 2061  ().            a
+000306e0: 7373 6572 7420 7473 2069 6e20 2864 7473  ssert ts in (dts
+000306f0: 2e77 6169 7465 7273 206f 7220 2829 290a  .waiters or ()).
+00030700: 0a20 2020 2064 6566 2076 616c 6964 6174  .    def validat
+00030710: 655f 6d65 6d6f 7279 2873 656c 662c 206b  e_memory(self, k
+00030720: 6579 3a20 4b65 7929 202d 3e20 4e6f 6e65  ey: Key) -> None
+00030730: 3a0a 2020 2020 2020 2020 7473 203d 2073  :.        ts = s
+00030740: 656c 662e 7461 736b 735b 6b65 795d 0a20  elf.tasks[key]. 
+00030750: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
+00030760: 2e77 686f 5f68 6173 0a20 2020 2020 2020  .who_has.       
+00030770: 2061 7373 6572 7420 626f 6f6c 2874 7320   assert bool(ts 
+00030780: 696e 2073 656c 662e 7265 706c 6963 6174  in self.replicat
+00030790: 6564 5f74 6173 6b73 2920 3d3d 2028 6c65  ed_tasks) == (le
+000307a0: 6e28 7473 2e77 686f 5f68 6173 2920 3e20  n(ts.who_has) > 
+000307b0: 3129 0a20 2020 2020 2020 2061 7373 6572  1).        asser
+000307c0: 7420 6e6f 7420 7473 2e70 726f 6365 7373  t not ts.process
+000307d0: 696e 675f 6f6e 0a20 2020 2020 2020 2061  ing_on.        a
+000307e0: 7373 6572 7420 6e6f 7420 7473 2e77 6169  ssert not ts.wai
+000307f0: 7469 6e67 5f6f 6e0a 2020 2020 2020 2020  ting_on.        
+00030800: 6173 7365 7274 2074 7320 6e6f 7420 696e  assert ts not in
+00030810: 2073 656c 662e 756e 7275 6e6e 6162 6c65   self.unrunnable
+00030820: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00030830: 7473 206e 6f74 2069 6e20 7365 6c66 2e71  ts not in self.q
+00030840: 7565 7565 640a 2020 2020 2020 2020 666f  ueued.        fo
+00030850: 7220 6474 7320 696e 2074 732e 6465 7065  r dts in ts.depe
+00030860: 6e64 656e 7473 3a0a 2020 2020 2020 2020  ndents:.        
+00030870: 2020 2020 6173 7365 7274 2028 6474 7320      assert (dts 
+00030880: 696e 2028 7473 2e77 6169 7465 7273 206f  in (ts.waiters o
+00030890: 7220 2829 2929 203d 3d20 280a 2020 2020  r ())) == (.    
+000308a0: 2020 2020 2020 2020 2020 2020 6474 732e              dts.
+000308b0: 7374 6174 6520 696e 2028 2277 6169 7469  state in ("waiti
+000308c0: 6e67 222c 2022 7175 6575 6564 222c 2022  ng", "queued", "
+000308d0: 7072 6f63 6573 7369 6e67 222c 2022 6e6f  processing", "no
+000308e0: 2d77 6f72 6b65 7222 290a 2020 2020 2020  -worker").      
+000308f0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00030900: 2020 2020 6173 7365 7274 2074 7320 6e6f      assert ts no
+00030910: 7420 696e 2028 6474 732e 7761 6974 696e  t in (dts.waitin
+00030920: 675f 6f6e 206f 7220 2829 290a 0a20 2020  g_on or ())..   
+00030930: 2064 6566 2076 616c 6964 6174 655f 6e6f   def validate_no
+00030940: 5f77 6f72 6b65 7228 7365 6c66 2c20 6b65  _worker(self, ke
+00030950: 793a 204b 6579 2920 2d3e 204e 6f6e 653a  y: Key) -> None:
+00030960: 0a20 2020 2020 2020 2074 7320 3d20 7365  .        ts = se
+00030970: 6c66 2e74 6173 6b73 5b6b 6579 5d0a 2020  lf.tasks[key].  
+00030980: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
+00030990: 696e 2073 656c 662e 756e 7275 6e6e 6162  in self.unrunnab
+000309a0: 6c65 0a20 2020 2020 2020 2061 7373 6572  le.        asser
+000309b0: 7420 6e6f 7420 7473 2e77 6169 7469 6e67  t not ts.waiting
+000309c0: 5f6f 6e0a 2020 2020 2020 2020 6173 7365  _on.        asse
+000309d0: 7274 2074 7320 696e 2073 656c 662e 756e  rt ts in self.un
+000309e0: 7275 6e6e 6162 6c65 0a20 2020 2020 2020  runnable.       
+000309f0: 2061 7373 6572 7420 6e6f 7420 7473 2e70   assert not ts.p
+00030a00: 726f 6365 7373 696e 675f 6f6e 0a20 2020  rocessing_on.   
+00030a10: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+00030a20: 7473 2e77 686f 5f68 6173 0a20 2020 2020  ts.who_has.     
+00030a30: 2020 2061 7373 6572 7420 7473 206e 6f74     assert ts not
+00030a40: 2069 6e20 7365 6c66 2e71 7565 7565 640a   in self.queued.
+00030a50: 2020 2020 2020 2020 666f 7220 6474 7320          for dts 
+00030a60: 696e 2074 732e 6465 7065 6e64 656e 6369  in ts.dependenci
+00030a70: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+00030a80: 6173 7365 7274 2064 7473 2e77 686f 5f68  assert dts.who_h
+00030a90: 6173 0a0a 2020 2020 6465 6620 7661 6c69  as..    def vali
+00030aa0: 6461 7465 5f65 7272 6564 2873 656c 662c  date_erred(self,
+00030ab0: 206b 6579 3a20 4b65 7929 202d 3e20 4e6f   key: Key) -> No
+00030ac0: 6e65 3a0a 2020 2020 2020 2020 7473 203d  ne:.        ts =
+00030ad0: 2073 656c 662e 7461 736b 735b 6b65 795d   self.tasks[key]
+00030ae0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00030af0: 7473 2e65 7863 6570 7469 6f6e 5f62 6c61  ts.exception_bla
+00030b00: 6d65 0a20 2020 2020 2020 2061 7373 6572  me.        asser
+00030b10: 7420 6e6f 7420 7473 2e77 686f 5f68 6173  t not ts.who_has
+00030b20: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00030b30: 7473 206e 6f74 2069 6e20 7365 6c66 2e71  ts not in self.q
+00030b40: 7565 7565 640a 0a20 2020 2064 6566 2076  ueued..    def v
+00030b50: 616c 6964 6174 655f 6b65 7928 7365 6c66  alidate_key(self
+00030b60: 2c20 6b65 793a 204b 6579 2c20 7473 3a20  , key: Key, ts: 
+00030b70: 5461 736b 5374 6174 6520 7c20 4e6f 6e65  TaskState | None
+00030b80: 203d 204e 6f6e 6529 202d 3e20 4e6f 6e65   = None) -> None
+00030b90: 3a0a 2020 2020 2020 2020 7472 793a 0a20  :.        try:. 
+00030ba0: 2020 2020 2020 2020 2020 2069 6620 7473             if ts
+00030bb0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00030bc0: 2020 2020 2020 2020 2020 7473 203d 2073            ts = s
+00030bd0: 656c 662e 7461 736b 732e 6765 7428 6b65  elf.tasks.get(ke
+00030be0: 7929 0a20 2020 2020 2020 2020 2020 2069  y).            i
+00030bf0: 6620 7473 2069 7320 4e6f 6e65 3a0a 2020  f ts is None:.  
+00030c00: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+00030c10: 6767 6572 2e64 6562 7567 2822 4b65 7920  gger.debug("Key 
+00030c20: 6c6f 7374 3a20 2573 222c 206b 6579 290a  lost: %s", key).
+00030c30: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00030c40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00030c50: 2020 7473 2e76 616c 6964 6174 6528 290a    ts.validate().
+00030c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030c70: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00030c80: 2020 2020 2020 2020 2066 756e 6320 3d20           func = 
+00030c90: 6765 7461 7474 7228 7365 6c66 2c20 2276  getattr(self, "v
+00030ca0: 616c 6964 6174 655f 2220 2b20 7473 2e73  alidate_" + ts.s
+00030cb0: 7461 7465 2e72 6570 6c61 6365 2822 2d22  tate.replace("-"
+00030cc0: 2c20 225f 2229 290a 2020 2020 2020 2020  , "_")).        
+00030cd0: 2020 2020 2020 2020 6578 6365 7074 2041          except A
+00030ce0: 7474 7269 6275 7465 4572 726f 723a 0a20  ttributeError:. 
+00030cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030d00: 2020 206c 6f67 6765 722e 6572 726f 7228     logger.error(
+00030d10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00030d20: 2020 2020 2020 2020 2022 7365 6c66 2e76           "self.v
+00030d30: 616c 6964 6174 655f 2573 206e 6f74 2066  alidate_%s not f
+00030d40: 6f75 6e64 222c 2074 732e 7374 6174 652e  ound", ts.state.
+00030d50: 7265 706c 6163 6528 222d 222c 2022 5f22  replace("-", "_"
+00030d60: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00030d70: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00030d80: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00030d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030da0: 2020 6675 6e63 286b 6579 290a 2020 2020    func(key).    
+00030db0: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+00030dc0: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
+00030dd0: 2020 2020 2020 206c 6f67 6765 722e 6578         logger.ex
+00030de0: 6365 7074 696f 6e28 6529 0a20 2020 2020  ception(e).     
+00030df0: 2020 2020 2020 2069 6620 4c4f 475f 5044         if LOG_PD
+00030e00: 423a 0a20 2020 2020 2020 2020 2020 2020  B:.             
+00030e10: 2020 2069 6d70 6f72 7420 7064 620a 0a20     import pdb.. 
+00030e20: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00030e30: 6462 2e73 6574 5f74 7261 6365 2829 0a20  db.set_trace(). 
+00030e40: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00030e50: 0a0a 2020 2020 6465 6620 7661 6c69 6461  ..    def valida
+00030e60: 7465 5f73 7461 7465 2873 656c 662c 2061  te_state(self, a
+00030e70: 6c6c 6f77 5f6f 7665 726c 6170 3a20 626f  llow_overlap: bo
+00030e80: 6f6c 203d 2046 616c 7365 2920 2d3e 204e  ol = False) -> N
+00030e90: 6f6e 653a 0a20 2020 2020 2020 2076 616c  one:.        val
+00030ea0: 6964 6174 655f 7374 6174 6528 7365 6c66  idate_state(self
+00030eb0: 2e74 6173 6b73 2c20 7365 6c66 2e77 6f72  .tasks, self.wor
+00030ec0: 6b65 7273 2c20 7365 6c66 2e63 6c69 656e  kers, self.clien
+00030ed0: 7473 290a 0a20 2020 2020 2020 2069 6620  ts)..        if 
+00030ee0: 6e6f 7420 2873 6574 2873 656c 662e 776f  not (set(self.wo
+00030ef0: 726b 6572 7329 203d 3d20 7365 7428 7365  rkers) == set(se
+00030f00: 6c66 2e73 7472 6561 6d5f 636f 6d6d 7329  lf.stream_comms)
+00030f10: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+00030f20: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+00030f30: 2257 6f72 6b65 7273 206e 6f74 2074 6865  "Workers not the
+00030f40: 2073 616d 6520 696e 2061 6c6c 2063 6f6c   same in all col
+00030f50: 6c65 6374 696f 6e73 2229 0a0a 2020 2020  lections")..    
+00030f60: 2020 2020 6173 7365 7274 2073 656c 662e      assert self.
+00030f70: 7275 6e6e 696e 672e 6973 7375 7065 7273  running.issupers
+00030f80: 6574 2873 656c 662e 6964 6c65 2e76 616c  et(self.idle.val
+00030f90: 7565 7328 2929 2c20 280a 2020 2020 2020  ues()), (.      
+00030fa0: 2020 2020 2020 7365 6c66 2e72 756e 6e69        self.runni
+00030fb0: 6e67 2e63 6f70 7928 292c 0a20 2020 2020  ng.copy(),.     
+00030fc0: 2020 2020 2020 2073 6574 2873 656c 662e         set(self.
+00030fd0: 6964 6c65 2e76 616c 7565 7328 2929 2c0a  idle.values()),.
+00030fe0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00030ff0: 2020 6173 7365 7274 2073 656c 662e 7275    assert self.ru
+00031000: 6e6e 696e 672e 6973 7375 7065 7273 6574  nning.issuperset
+00031010: 2873 656c 662e 6964 6c65 5f74 6173 6b5f  (self.idle_task_
+00031020: 636f 756e 7429 2c20 280a 2020 2020 2020  count), (.      
+00031030: 2020 2020 2020 7365 6c66 2e72 756e 6e69        self.runni
+00031040: 6e67 2e63 6f70 7928 292c 0a20 2020 2020  ng.copy(),.     
+00031050: 2020 2020 2020 2073 656c 662e 6964 6c65         self.idle
+00031060: 5f74 6173 6b5f 636f 756e 742e 636f 7079  _task_count.copy
+00031070: 2829 2c0a 2020 2020 2020 2020 290a 2020  (),.        ).  
+00031080: 2020 2020 2020 6173 7365 7274 2073 656c        assert sel
+00031090: 662e 7275 6e6e 696e 672e 6973 7375 7065  f.running.issupe
+000310a0: 7273 6574 2873 656c 662e 7361 7475 7261  rset(self.satura
+000310b0: 7465 6429 2c20 280a 2020 2020 2020 2020  ted), (.        
+000310c0: 2020 2020 7365 6c66 2e72 756e 6e69 6e67      self.running
+000310d0: 2e63 6f70 7928 292c 0a20 2020 2020 2020  .copy(),.       
+000310e0: 2020 2020 2073 656c 662e 7361 7475 7261       self.satura
+000310f0: 7465 642e 636f 7079 2829 2c0a 2020 2020  ted.copy(),.    
+00031100: 2020 2020 290a 2020 2020 2020 2020 6173      ).        as
+00031110: 7365 7274 2073 656c 662e 7361 7475 7261  sert self.satura
+00031120: 7465 642e 6973 6469 736a 6f69 6e74 2873  ted.isdisjoint(s
+00031130: 656c 662e 6964 6c65 2e76 616c 7565 7328  elf.idle.values(
+00031140: 2929 2c20 280a 2020 2020 2020 2020 2020  )), (.          
+00031150: 2020 7365 6c66 2e73 6174 7572 6174 6564    self.saturated
+00031160: 2e63 6f70 7928 292c 0a20 2020 2020 2020  .copy(),.       
+00031170: 2020 2020 2073 6574 2873 656c 662e 6964       set(self.id
+00031180: 6c65 2e76 616c 7565 7328 2929 2c0a 2020  le.values()),.  
+00031190: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+000311a0: 2074 6173 6b5f 7072 6566 6978 5f63 6f75   task_prefix_cou
+000311b0: 6e74 733a 2064 6566 6175 6c74 6469 6374  nts: defaultdict
+000311c0: 5b73 7472 2c20 696e 745d 203d 2064 6566  [str, int] = def
+000311d0: 6175 6c74 6469 6374 2869 6e74 290a 2020  aultdict(int).  
+000311e0: 2020 2020 2020 666f 7220 772c 2077 7320        for w, ws 
+000311f0: 696e 2073 656c 662e 776f 726b 6572 732e  in self.workers.
+00031200: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
+00031210: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
+00031220: 7374 616e 6365 2877 2c20 7374 7229 2c20  stance(w, str), 
+00031230: 2874 7970 6528 7729 2c20 7729 0a20 2020  (type(w), w).   
+00031240: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00031250: 6973 696e 7374 616e 6365 2877 732c 2057  isinstance(ws, W
+00031260: 6f72 6b65 7253 7461 7465 292c 2028 7479  orkerState), (ty
+00031270: 7065 2877 7329 2c20 7773 290a 2020 2020  pe(ws), ws).    
+00031280: 2020 2020 2020 2020 6173 7365 7274 2077          assert w
+00031290: 732e 6164 6472 6573 7320 3d3d 2077 0a0a  s.address == w..
+000312a0: 2020 2020 2020 2020 2020 2020 6966 2077              if w
+000312b0: 732e 7374 6174 7573 203d 3d20 5374 6174  s.status == Stat
+000312c0: 7573 2e72 756e 6e69 6e67 3a0a 2020 2020  us.running:.    
+000312d0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+000312e0: 7274 2077 7320 696e 2073 656c 662e 7275  rt ws in self.ru
+000312f0: 6e6e 696e 670a 2020 2020 2020 2020 2020  nning.          
+00031300: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00031310: 2020 2020 2020 2020 6173 7365 7274 2077          assert w
+00031320: 7320 6e6f 7420 696e 2073 656c 662e 7275  s not in self.ru
+00031330: 6e6e 696e 670a 2020 2020 2020 2020 2020  nning.          
+00031340: 2020 2020 2020 6173 7365 7274 2077 732e        assert ws.
+00031350: 6164 6472 6573 7320 6e6f 7420 696e 2073  address not in s
+00031360: 656c 662e 6964 6c65 0a20 2020 2020 2020  elf.idle.       
+00031370: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00031380: 7773 206e 6f74 2069 6e20 7365 6c66 2e73  ws not in self.s
+00031390: 6174 7572 6174 6564 0a0a 2020 2020 2020  aturated..      
+000313a0: 2020 2020 2020 6173 7365 7274 2077 732e        assert ws.
+000313b0: 6c6f 6e67 5f72 756e 6e69 6e67 2e69 7373  long_running.iss
+000313c0: 7562 7365 7428 7773 2e70 726f 6365 7373  ubset(ws.process
+000313d0: 696e 6729 0a20 2020 2020 2020 2020 2020  ing).           
+000313e0: 2069 6620 6e6f 7420 7773 2e70 726f 6365   if not ws.proce
+000313f0: 7373 696e 673a 0a20 2020 2020 2020 2020  ssing:.         
+00031400: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
+00031410: 7420 7773 2e6f 6363 7570 616e 6379 0a20  t ws.occupancy. 
+00031420: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00031430: 6620 7773 2e73 7461 7475 7320 3d3d 2053  f ws.status == S
+00031440: 7461 7475 732e 7275 6e6e 696e 673a 0a20  tatus.running:. 
+00031450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031460: 2020 2061 7373 6572 7420 7773 2e61 6464     assert ws.add
+00031470: 7265 7373 2069 6e20 7365 6c66 2e69 646c  ress in self.idl
+00031480: 650a 2020 2020 2020 2020 2020 2020 6173  e.            as
+00031490: 7365 7274 206e 6f74 2077 732e 6e65 6564  sert not ws.need
+000314a0: 735f 7768 6174 2e6b 6579 7328 2920 2620  s_what.keys() & 
+000314b0: 7773 2e68 6173 5f77 6861 740a 2020 2020  ws.has_what.    
+000314c0: 2020 2020 2020 2020 6163 7475 616c 5f6e          actual_n
+000314d0: 6565 6473 5f77 6861 743a 2064 6566 6175  eeds_what: defau
+000314e0: 6c74 6469 6374 5b54 6173 6b53 7461 7465  ltdict[TaskState
+000314f0: 2c20 696e 745d 203d 2064 6566 6175 6c74  , int] = default
+00031500: 6469 6374 2869 6e74 290a 2020 2020 2020  dict(int).      
+00031510: 2020 2020 2020 666f 7220 7473 2069 6e20        for ts in 
+00031520: 7773 2e70 726f 6365 7373 696e 673a 0a20  ws.processing:. 
+00031530: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00031540: 6f72 2074 7373 2069 6e20 7473 2e64 6570  or tss in ts.dep
+00031550: 656e 6465 6e63 6965 733a 0a20 2020 2020  endencies:.     
+00031560: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00031570: 6620 7473 7320 6e6f 7420 696e 2077 732e  f tss not in ws.
+00031580: 6861 735f 7768 6174 3a0a 2020 2020 2020  has_what:.      
+00031590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000315a0: 2020 6163 7475 616c 5f6e 6565 6473 5f77    actual_needs_w
+000315b0: 6861 745b 7473 735d 202b 3d20 310a 2020  hat[tss] += 1.  
+000315c0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+000315d0: 2061 6374 7561 6c5f 6e65 6564 735f 7768   actual_needs_wh
+000315e0: 6174 203d 3d20 7773 2e6e 6565 6473 5f77  at == ws.needs_w
+000315f0: 6861 740a 2020 2020 2020 2020 2020 2020  hat.            
+00031600: 6173 7365 7274 2028 7773 2e73 7461 7475  assert (ws.statu
+00031610: 7320 3d3d 2053 7461 7475 732e 7275 6e6e  s == Status.runn
+00031620: 696e 6729 203d 3d20 2877 7320 696e 2073  ing) == (ws in s
+00031630: 656c 662e 7275 6e6e 696e 6729 0a20 2020  elf.running).   
+00031640: 2020 2020 2020 2020 2066 6f72 206e 616d           for nam
+00031650: 652c 2063 6f75 6e74 2069 6e20 7773 2e74  e, count in ws.t
+00031660: 6173 6b5f 7072 6566 6978 5f63 6f75 6e74  ask_prefix_count
+00031670: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
+00031680: 2020 2020 2020 2020 2020 7461 736b 5f70            task_p
+00031690: 7265 6669 785f 636f 756e 7473 5b6e 616d  refix_counts[nam
+000316a0: 655d 202b 3d20 636f 756e 740a 0a20 2020  e] += count..   
+000316b0: 2020 2020 2061 7373 6572 7420 7461 736b       assert task
+000316c0: 5f70 7265 6669 785f 636f 756e 7473 2e6b  _prefix_counts.k
+000316d0: 6579 7328 2920 3d3d 2073 656c 662e 5f74  eys() == self._t
+000316e0: 6173 6b5f 7072 6566 6978 5f63 6f75 6e74  ask_prefix_count
+000316f0: 5f67 6c6f 6261 6c2e 6b65 7973 2829 0a20  _global.keys(). 
+00031700: 2020 2020 2020 2066 6f72 206e 616d 652c         for name,
+00031710: 2067 6c6f 6261 6c5f 636f 756e 7420 696e   global_count in
+00031720: 2073 656c 662e 5f74 6173 6b5f 7072 6566   self._task_pref
+00031730: 6978 5f63 6f75 6e74 5f67 6c6f 6261 6c2e  ix_count_global.
+00031740: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
+00031750: 2020 2020 2061 7373 6572 7420 280a 2020       assert (.  
+00031760: 2020 2020 2020 2020 2020 2020 2020 7461                ta
+00031770: 736b 5f70 7265 6669 785f 636f 756e 7473  sk_prefix_counts
+00031780: 5b6e 616d 655d 203d 3d20 676c 6f62 616c  [name] == global
+00031790: 5f63 6f75 6e74 0a20 2020 2020 2020 2020  _count.         
+000317a0: 2020 2029 2c20 6622 7b6e 616d 657d 3a20     ), f"{name}: 
+000317b0: 7b74 6173 6b5f 7072 6566 6978 5f63 6f75  {task_prefix_cou
+000317c0: 6e74 735b 6e61 6d65 5d7d 2028 7773 7329  nts[name]} (wss)
+000317d0: 2c20 7b67 6c6f 6261 6c5f 636f 756e 747d  , {global_count}
+000317e0: 2028 676c 6f62 616c 2922 0a0a 2020 2020   (global)"..    
+000317f0: 2020 2020 666f 7220 7773 2069 6e20 7365      for ws in se
+00031800: 6c66 2e72 756e 6e69 6e67 3a0a 2020 2020  lf.running:.    
+00031810: 2020 2020 2020 2020 6173 7365 7274 2077          assert w
+00031820: 732e 7374 6174 7573 203d 3d20 5374 6174  s.status == Stat
+00031830: 7573 2e72 756e 6e69 6e67 0a20 2020 2020  us.running.     
+00031840: 2020 2020 2020 2061 7373 6572 7420 7773         assert ws
+00031850: 2e61 6464 7265 7373 2069 6e20 7365 6c66  .address in self
+00031860: 2e77 6f72 6b65 7273 0a0a 2020 2020 2020  .workers..      
+00031870: 2020 666f 7220 6b2c 2074 7320 696e 2073    for k, ts in s
+00031880: 656c 662e 7461 736b 732e 6974 656d 7328  elf.tasks.items(
+00031890: 293a 0a20 2020 2020 2020 2020 2020 2061  ):.            a
+000318a0: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
+000318b0: 2874 732c 2054 6173 6b53 7461 7465 292c  (ts, TaskState),
+000318c0: 2028 7479 7065 2874 7329 2c20 7473 290a   (type(ts), ts).
+000318d0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+000318e0: 7274 2074 732e 6b65 7920 3d3d 206b 0a20  rt ts.key == k. 
+000318f0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00031900: 7420 626f 6f6c 2874 7320 696e 2073 656c  t bool(ts in sel
+00031910: 662e 7265 706c 6963 6174 6564 5f74 6173  f.replicated_tas
+00031920: 6b73 2920 3d3d 2028 6c65 6e28 7473 2e77  ks) == (len(ts.w
+00031930: 686f 5f68 6173 206f 7220 2829 2920 3e20  ho_has or ()) > 
+00031940: 3129 0a20 2020 2020 2020 2020 2020 2073  1).            s
+00031950: 656c 662e 7661 6c69 6461 7465 5f6b 6579  elf.validate_key
+00031960: 286b 2c20 7473 290a 0a20 2020 2020 2020  (k, ts)..       
+00031970: 2066 6f72 2074 7320 696e 2073 656c 662e   for ts in self.
+00031980: 7265 706c 6963 6174 6564 5f74 6173 6b73  replicated_tasks
+00031990: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
+000319a0: 7365 7274 2074 732e 7374 6174 6520 3d3d  sert ts.state ==
+000319b0: 2022 6d65 6d6f 7279 220a 2020 2020 2020   "memory".      
+000319c0: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
+000319d0: 6b65 7920 696e 2073 656c 662e 7461 736b  key in self.task
+000319e0: 730a 0a20 2020 2020 2020 2066 6f72 2063  s..        for c
+000319f0: 2c20 6373 2069 6e20 7365 6c66 2e63 6c69  , cs in self.cli
+00031a00: 656e 7473 2e69 7465 6d73 2829 3a0a 2020  ents.items():.  
+00031a10: 2020 2020 2020 2020 2020 2320 636c 6965            # clie
+00031a20: 6e74 3d4e 6f6e 6520 6973 206f 6674 656e  nt=None is often
+00031a30: 2075 7365 6420 696e 2074 6573 7473 2e2e   used in tests..
+00031a40: 2e0a 2020 2020 2020 2020 2020 2020 6173  ..            as
+00031a50: 7365 7274 2063 2069 7320 4e6f 6e65 206f  sert c is None o
+00031a60: 7220 7479 7065 2863 2920 3d3d 2073 7472  r type(c) == str
+00031a70: 2c20 2874 7970 6528 6329 2c20 6329 0a20  , (type(c), c). 
+00031a80: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00031a90: 7420 7479 7065 2863 7329 203d 3d20 436c  t type(cs) == Cl
+00031aa0: 6965 6e74 5374 6174 652c 2028 7479 7065  ientState, (type
+00031ab0: 2863 7329 2c20 6373 290a 2020 2020 2020  (cs), cs).      
+00031ac0: 2020 2020 2020 6173 7365 7274 2063 732e        assert cs.
+00031ad0: 636c 6965 6e74 5f6b 6579 203d 3d20 630a  client_key == c.
+00031ae0: 0a20 2020 2020 2020 2061 203d 207b 773a  .        a = {w:
+00031af0: 2077 732e 6e62 7974 6573 2066 6f72 2077   ws.nbytes for w
+00031b00: 2c20 7773 2069 6e20 7365 6c66 2e77 6f72  , ws in self.wor
+00031b10: 6b65 7273 2e69 7465 6d73 2829 7d0a 2020  kers.items()}.  
+00031b20: 2020 2020 2020 6220 3d20 7b0a 2020 2020        b = {.    
+00031b30: 2020 2020 2020 2020 773a 2073 756d 2874          w: sum(t
+00031b40: 732e 6765 745f 6e62 7974 6573 2829 2066  s.get_nbytes() f
+00031b50: 6f72 2074 7320 696e 2077 732e 6861 735f  or ts in ws.has_
+00031b60: 7768 6174 290a 2020 2020 2020 2020 2020  what).          
+00031b70: 2020 666f 7220 772c 2077 7320 696e 2073    for w, ws in s
+00031b80: 656c 662e 776f 726b 6572 732e 6974 656d  elf.workers.item
+00031b90: 7328 290a 2020 2020 2020 2020 7d0a 2020  s().        }.  
+00031ba0: 2020 2020 2020 6173 7365 7274 2061 203d        assert a =
+00031bb0: 3d20 622c 2028 612c 2062 290a 0a20 2020  = b, (a, b)..   
+00031bc0: 2020 2020 2069 6620 7365 6c66 2e74 7261       if self.tra
+00031bd0: 6e73 6974 696f 6e5f 636f 756e 7465 725f  nsition_counter_
+00031be0: 6d61 783a 0a20 2020 2020 2020 2020 2020  max:.           
+00031bf0: 2061 7373 6572 7420 7365 6c66 2e74 7261   assert self.tra
+00031c00: 6e73 6974 696f 6e5f 636f 756e 7465 7220  nsition_counter 
+00031c10: 3c20 7365 6c66 2e74 7261 6e73 6974 696f  < self.transitio
+00031c20: 6e5f 636f 756e 7465 725f 6d61 780a 0a20  n_counter_max.. 
+00031c30: 2020 2023 2323 2323 2323 2323 2323 2323     #############
+00031c40: 2323 2323 2323 0a20 2020 2023 204d 616e  ######.    # Man
+00031c50: 6167 6520 4d65 7373 6167 6573 2023 0a20  age Messages #. 
+00031c60: 2020 2023 2323 2323 2323 2323 2323 2323     #############
+00031c70: 2323 2323 2323 0a0a 2020 2020 6465 6620  ######..    def 
+00031c80: 7265 706f 7274 280a 2020 2020 2020 2020  report(.        
+00031c90: 7365 6c66 2c20 6d73 673a 2064 6963 742c  self, msg: dict,
+00031ca0: 2074 733a 2054 6173 6b53 7461 7465 207c   ts: TaskState |
+00031cb0: 204e 6f6e 6520 3d20 4e6f 6e65 2c20 636c   None = None, cl
+00031cc0: 6965 6e74 3a20 7374 7220 7c20 4e6f 6e65  ient: str | None
+00031cd0: 203d 204e 6f6e 650a 2020 2020 2920 2d3e   = None.    ) ->
+00031ce0: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
+00031cf0: 2222 0a20 2020 2020 2020 2050 7562 6c69  "".        Publi
+00031d00: 7368 2075 7064 6174 6573 2074 6f20 616c  sh updates to al
+00031d10: 6c20 6c69 7374 656e 696e 6720 5175 6575  l listening Queu
+00031d20: 6573 2061 6e64 2043 6f6d 6d73 0a0a 2020  es and Comms..  
+00031d30: 2020 2020 2020 4966 2074 6865 206d 6573        If the mes
+00031d40: 7361 6765 2063 6f6e 7461 696e 7320 6120  sage contains a 
+00031d50: 6b65 7920 7468 656e 2077 6520 6f6e 6c79  key then we only
+00031d60: 2073 656e 6420 7468 6520 6d65 7373 6167   send the messag
+00031d70: 6520 746f 2074 686f 7365 0a20 2020 2020  e to those.     
+00031d80: 2020 2063 6f6d 6d73 2074 6861 7420 6361     comms that ca
+00031d90: 7265 2061 626f 7574 2074 6865 206b 6579  re about the key
+00031da0: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+00031db0: 2020 2020 2020 6966 2074 7320 6973 204e        if ts is N
+00031dc0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00031dd0: 206d 7367 5f6b 6579 203d 206d 7367 2e67   msg_key = msg.g
+00031de0: 6574 2822 6b65 7922 290a 2020 2020 2020  et("key").      
+00031df0: 2020 2020 2020 6966 206d 7367 5f6b 6579        if msg_key
+00031e00: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00031e10: 2020 2020 2020 2020 2020 2020 2020 7473                ts
+00031e20: 203d 2073 656c 662e 7461 736b 732e 6765   = self.tasks.ge
+00031e30: 7428 6d73 675f 6b65 7929 0a0a 2020 2020  t(msg_key)..    
+00031e40: 2020 2020 6966 2074 7320 6973 204e 6f6e      if ts is Non
+00031e50: 6520 616e 6420 636c 6965 6e74 2069 7320  e and client is 
+00031e60: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00031e70: 2020 2320 4e6f 7469 6679 2061 6c6c 2063    # Notify all c
+00031e80: 6c69 656e 7473 0a20 2020 2020 2020 2020  lients.         
+00031e90: 2020 2063 6c69 656e 745f 6b65 7973 203d     client_keys =
+00031ea0: 206c 6973 7428 7365 6c66 2e63 6c69 656e   list(self.clien
+00031eb0: 745f 636f 6d6d 7329 0a20 2020 2020 2020  t_comms).       
+00031ec0: 2065 6c69 6620 7473 2069 7320 4e6f 6e65   elif ts is None
+00031ed0: 3a0a 2020 2020 2020 2020 2020 2020 636c  :.            cl
+00031ee0: 6965 6e74 5f6b 6579 7320 3d20 5b63 6c69  ient_keys = [cli
+00031ef0: 656e 745d 0a20 2020 2020 2020 2065 6c73  ent].        els
+00031f00: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
+00031f10: 204e 6f74 6966 7920 636c 6965 6e74 7320   Notify clients 
+00031f20: 696e 7465 7265 7374 6564 2069 6e20 6b65  interested in ke
+00031f30: 7920 2869 6e63 6c75 6469 6e67 2060 636c  y (including `cl
+00031f40: 6965 6e74 6029 0a20 2020 2020 2020 2020  ient`).         
+00031f50: 2020 2023 204e 6f74 6520 7468 6174 2c20     # Note that, 
+00031f60: 6966 2072 6570 6f72 7428 2920 7761 7320  if report() was 
+00031f70: 6361 6c6c 6564 2062 7920 7570 6461 7465  called by update
+00031f80: 5f67 7261 7068 2829 2c20 6063 6c69 656e  _graph(), `clien
+00031f90: 7460 2077 6f6e 2774 2062 6520 696e 0a20  t` won't be in. 
+00031fa0: 2020 2020 2020 2020 2020 2023 2074 732e             # ts.
+00031fb0: 7768 6f5f 7761 6e74 7320 7965 742e 0a20  who_wants yet.. 
+00031fc0: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
+00031fd0: 745f 6b65 7973 203d 205b 0a20 2020 2020  t_keys = [.     
+00031fe0: 2020 2020 2020 2020 2020 2063 732e 636c             cs.cl
+00031ff0: 6965 6e74 5f6b 6579 2066 6f72 2063 7320  ient_key for cs 
+00032000: 696e 2074 732e 7768 6f5f 7761 6e74 7320  in ts.who_wants 
+00032010: 6f72 2028 2920 6966 2063 732e 636c 6965  or () if cs.clie
+00032020: 6e74 5f6b 6579 2021 3d20 636c 6965 6e74  nt_key != client
+00032030: 0a20 2020 2020 2020 2020 2020 205d 0a20  .            ]. 
+00032040: 2020 2020 2020 2020 2020 2069 6620 636c             if cl
+00032050: 6965 6e74 2069 7320 6e6f 7420 4e6f 6e65  ient is not None
+00032060: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00032070: 2020 636c 6965 6e74 5f6b 6579 732e 6170    client_keys.ap
+00032080: 7065 6e64 2863 6c69 656e 7429 0a0a 2020  pend(client)..  
+00032090: 2020 2020 2020 666f 7220 6b20 696e 2063        for k in c
+000320a0: 6c69 656e 745f 6b65 7973 3a0a 2020 2020  lient_keys:.    
+000320b0: 2020 2020 2020 2020 6320 3d20 7365 6c66          c = self
+000320c0: 2e63 6c69 656e 745f 636f 6d6d 732e 6765  .client_comms.ge
+000320d0: 7428 6b29 0a20 2020 2020 2020 2020 2020  t(k).           
+000320e0: 2069 6620 6320 6973 204e 6f6e 653a 0a20   if c is None:. 
+000320f0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00032100: 6f6e 7469 6e75 650a 2020 2020 2020 2020  ontinue.        
+00032110: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00032120: 2020 2020 2020 2020 2063 2e73 656e 6428           c.send(
+00032130: 6d73 6729 0a20 2020 2020 2020 2020 2020  msg).           
+00032140: 2020 2020 2023 206c 6f67 6765 722e 6465       # logger.de
+00032150: 6275 6728 2253 6368 6564 756c 6572 2073  bug("Scheduler s
+00032160: 656e 6473 206d 6573 7361 6765 2074 6f20  ends message to 
+00032170: 636c 6965 6e74 2025 733a 2025 7322 2c20  client %s: %s", 
+00032180: 6b2c 206d 7367 290a 2020 2020 2020 2020  k, msg).        
+00032190: 2020 2020 6578 6365 7074 2043 6f6d 6d43      except CommC
+000321a0: 6c6f 7365 6445 7272 6f72 3a0a 2020 2020  losedError:.    
+000321b0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+000321c0: 656c 662e 7374 6174 7573 203d 3d20 5374  elf.status == St
+000321d0: 6174 7573 2e72 756e 6e69 6e67 3a0a 2020  atus.running:.  
+000321e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000321f0: 2020 6c6f 6767 6572 2e63 7269 7469 6361    logger.critica
+00032200: 6c28 0a20 2020 2020 2020 2020 2020 2020  l(.             
+00032210: 2020 2020 2020 2020 2020 2022 436c 6f73             "Clos
+00032220: 6564 2063 6f6d 6d20 2572 2077 6869 6c65  ed comm %r while
+00032230: 2074 7279 696e 6720 746f 2077 7269 7465   trying to write
+00032240: 2025 7322 2c20 632c 206d 7367 2c20 6578   %s", c, msg, ex
+00032250: 635f 696e 666f 3d54 7275 650a 2020 2020  c_info=True.    
+00032260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032270: 290a 0a20 2020 2061 7379 6e63 2064 6566  )..    async def
+00032280: 2061 6464 5f63 6c69 656e 7428 0a20 2020   add_client(.   
+00032290: 2020 2020 2073 656c 662c 2063 6f6d 6d3a       self, comm:
+000322a0: 2043 6f6d 6d2c 2063 6c69 656e 743a 2073   Comm, client: s
+000322b0: 7472 2c20 7665 7273 696f 6e73 3a20 6469  tr, versions: di
+000322c0: 6374 5b73 7472 2c20 416e 795d 0a20 2020  ct[str, Any].   
+000322d0: 2029 202d 3e20 4e6f 6e65 3a0a 2020 2020   ) -> None:.    
+000322e0: 2020 2020 2222 2241 6464 2063 6c69 656e      """Add clien
+000322f0: 7420 746f 206e 6574 776f 726b 0a0a 2020  t to network..  
+00032300: 2020 2020 2020 5765 206c 6973 7465 6e20        We listen 
+00032310: 746f 2061 6c6c 2066 7574 7572 6520 6d65  to all future me
+00032320: 7373 6167 6573 2066 726f 6d20 7468 6973  ssages from this
+00032330: 2043 6f6d 6d2e 0a20 2020 2020 2020 2022   Comm..        "
+00032340: 2222 0a20 2020 2020 2020 2061 7373 6572  "".        asser
+00032350: 7420 636c 6965 6e74 2069 7320 6e6f 7420  t client is not 
+00032360: 4e6f 6e65 0a20 2020 2020 2020 2063 6f6d  None.        com
+00032370: 6d2e 6e61 6d65 203d 2022 5363 6865 6475  m.name = "Schedu
+00032380: 6c65 722d 3e43 6c69 656e 7422 0a20 2020  ler->Client".   
+00032390: 2020 2020 206c 6f67 6765 722e 696e 666f       logger.info
+000323a0: 2822 5265 6365 6976 6520 636c 6965 6e74  ("Receive client
+000323b0: 2063 6f6e 6e65 6374 696f 6e3a 2025 7322   connection: %s"
+000323c0: 2c20 636c 6965 6e74 290a 2020 2020 2020  , client).      
+000323d0: 2020 7365 6c66 2e6c 6f67 5f65 7665 6e74    self.log_event
+000323e0: 285b 2261 6c6c 222c 2063 6c69 656e 745d  (["all", client]
+000323f0: 2c20 7b22 6163 7469 6f6e 223a 2022 6164  , {"action": "ad
+00032400: 642d 636c 6965 6e74 222c 2022 636c 6965  d-client", "clie
+00032410: 6e74 223a 2063 6c69 656e 747d 290a 2020  nt": client}).  
+00032420: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
+00032430: 7473 5b63 6c69 656e 745d 203d 2043 6c69  ts[client] = Cli
+00032440: 656e 7453 7461 7465 2863 6c69 656e 742c  entState(client,
+00032450: 2076 6572 7369 6f6e 733d 7665 7273 696f   versions=versio
+00032460: 6e73 290a 0a20 2020 2020 2020 2066 6f72  ns)..        for
+00032470: 2070 6c75 6769 6e20 696e 206c 6973 7428   plugin in list(
+00032480: 7365 6c66 2e70 6c75 6769 6e73 2e76 616c  self.plugins.val
+00032490: 7565 7328 2929 3a0a 2020 2020 2020 2020  ues()):.        
+000324a0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+000324b0: 2020 2020 2020 2020 2070 6c75 6769 6e2e           plugin.
+000324c0: 6164 645f 636c 6965 6e74 2873 6368 6564  add_client(sched
+000324d0: 756c 6572 3d73 656c 662c 2063 6c69 656e  uler=self, clien
+000324e0: 743d 636c 6965 6e74 290a 2020 2020 2020  t=client).      
+000324f0: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
+00032500: 6570 7469 6f6e 2061 7320 653a 0a20 2020  eption as e:.   
+00032510: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+00032520: 6765 722e 6578 6365 7074 696f 6e28 6529  ger.exception(e)
+00032530: 0a0a 2020 2020 2020 2020 7472 793a 0a20  ..        try:. 
+00032540: 2020 2020 2020 2020 2020 2062 636f 6d6d             bcomm
+00032550: 203d 2042 6174 6368 6564 5365 6e64 2869   = BatchedSend(i
+00032560: 6e74 6572 7661 6c3d 2232 6d73 222c 206c  nterval="2ms", l
+00032570: 6f6f 703d 7365 6c66 2e6c 6f6f 7029 0a20  oop=self.loop). 
+00032580: 2020 2020 2020 2020 2020 2062 636f 6d6d             bcomm
+00032590: 2e73 7461 7274 2863 6f6d 6d29 0a20 2020  .start(comm).   
+000325a0: 2020 2020 2020 2020 2073 656c 662e 636c           self.cl
+000325b0: 6965 6e74 5f63 6f6d 6d73 5b63 6c69 656e  ient_comms[clien
+000325c0: 745d 203d 2062 636f 6d6d 0a20 2020 2020  t] = bcomm.     
+000325d0: 2020 2020 2020 206d 7367 203d 207b 226f         msg = {"o
+000325e0: 7022 3a20 2273 7472 6561 6d2d 7374 6172  p": "stream-star
+000325f0: 7422 7d0a 2020 2020 2020 2020 2020 2020  t"}.            
+00032600: 7665 7273 696f 6e5f 7761 726e 696e 6720  version_warning 
+00032610: 3d20 7665 7273 696f 6e5f 6d6f 6475 6c65  = version_module
+00032620: 2e65 7272 6f72 5f6d 6573 7361 6765 280a  .error_message(.
+00032630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032640: 7665 7273 696f 6e5f 6d6f 6475 6c65 2e67  version_module.g
+00032650: 6574 5f76 6572 7369 6f6e 7328 292c 0a20  et_versions(),. 
+00032660: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+00032670: 773a 2077 732e 7665 7273 696f 6e73 2066  w: ws.versions f
+00032680: 6f72 2077 2c20 7773 2069 6e20 7365 6c66  or w, ws in self
+00032690: 2e77 6f72 6b65 7273 2e69 7465 6d73 2829  .workers.items()
+000326a0: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
+000326b0: 2020 2076 6572 7369 6f6e 732c 0a20 2020     versions,.   
+000326c0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+000326d0: 2020 2020 2020 206d 7367 2e75 7064 6174         msg.updat
+000326e0: 6528 7665 7273 696f 6e5f 7761 726e 696e  e(version_warnin
+000326f0: 6729 0a20 2020 2020 2020 2020 2020 2062  g).            b
+00032700: 636f 6d6d 2e73 656e 6428 6d73 6729 0a0a  comm.send(msg)..
+00032710: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+00032720: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00032730: 2061 7761 6974 2073 656c 662e 6861 6e64   await self.hand
+00032740: 6c65 5f73 7472 6561 6d28 636f 6d6d 3d63  le_stream(comm=c
+00032750: 6f6d 6d2c 2065 7874 7261 3d7b 2263 6c69  omm, extra={"cli
+00032760: 656e 7422 3a20 636c 6965 6e74 7d29 0a20  ent": client}). 
+00032770: 2020 2020 2020 2020 2020 2066 696e 616c             final
+00032780: 6c79 3a0a 2020 2020 2020 2020 2020 2020  ly:.            
+00032790: 2020 2020 7365 6c66 2e72 656d 6f76 655f      self.remove_
+000327a0: 636c 6965 6e74 2863 6c69 656e 743d 636c  client(client=cl
+000327b0: 6965 6e74 2c20 7374 696d 756c 7573 5f69  ient, stimulus_i
+000327c0: 643d 6622 7265 6d6f 7665 2d63 6c69 656e  d=f"remove-clien
+000327d0: 742d 7b74 696d 6528 297d 2229 0a20 2020  t-{time()}").   
+000327e0: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+000327f0: 6765 722e 6465 6275 6728 2246 696e 6973  ger.debug("Finis
+00032800: 6865 6420 6861 6e64 6c69 6e67 2063 6c69  hed handling cli
+00032810: 656e 7420 2573 222c 2063 6c69 656e 7429  ent %s", client)
+00032820: 0a20 2020 2020 2020 2066 696e 616c 6c79  .        finally
+00032830: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00032840: 206e 6f74 2063 6f6d 6d2e 636c 6f73 6564   not comm.closed
+00032850: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00032860: 2020 2020 7365 6c66 2e63 6c69 656e 745f      self.client_
+00032870: 636f 6d6d 735b 636c 6965 6e74 5d2e 7365  comms[client].se
+00032880: 6e64 287b 226f 7022 3a20 2273 7472 6561  nd({"op": "strea
+00032890: 6d2d 636c 6f73 6564 227d 290a 2020 2020  m-closed"}).    
+000328a0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+000328b0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000328c0: 6e6f 7420 6973 5f70 7974 686f 6e5f 7368  not is_python_sh
+000328d0: 7574 7469 6e67 5f64 6f77 6e28 293a 0a20  utting_down():. 
+000328e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000328f0: 2020 2061 7761 6974 2073 656c 662e 636c     await self.cl
+00032900: 6965 6e74 5f63 6f6d 6d73 5b63 6c69 656e  ient_comms[clien
+00032910: 745d 2e63 6c6f 7365 2829 0a20 2020 2020  t].close().     
+00032920: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00032930: 656c 2073 656c 662e 636c 6965 6e74 5f63  el self.client_c
+00032940: 6f6d 6d73 5b63 6c69 656e 745d 0a20 2020  omms[client].   
+00032950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032960: 2069 6620 7365 6c66 2e73 7461 7475 7320   if self.status 
+00032970: 3d3d 2053 7461 7475 732e 7275 6e6e 696e  == Status.runnin
+00032980: 673a 0a20 2020 2020 2020 2020 2020 2020  g:.             
+00032990: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+000329a0: 722e 696e 666f 2822 436c 6f73 6520 636c  r.info("Close cl
+000329b0: 6965 6e74 2063 6f6e 6e65 6374 696f 6e3a  ient connection:
+000329c0: 2025 7322 2c20 636c 6965 6e74 290a 2020   %s", client).  
+000329d0: 2020 2020 2020 2020 2020 6578 6365 7074            except
+000329e0: 2054 7970 6545 7272 6f72 3a20 2023 2063   TypeError:  # c
+000329f0: 6f6d 6d20 6265 636f 6d65 7320 4e6f 6e65  omm becomes None
+00032a00: 2064 7572 696e 6720 4743 0a20 2020 2020   during GC.     
+00032a10: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
+00032a20: 0a20 2020 2064 6566 2072 656d 6f76 655f  .    def remove_
+00032a30: 636c 6965 6e74 2873 656c 662c 2063 6c69  client(self, cli
+00032a40: 656e 743a 2073 7472 2c20 7374 696d 756c  ent: str, stimul
+00032a50: 7573 5f69 643a 2073 7472 207c 204e 6f6e  us_id: str | Non
+00032a60: 6520 3d20 4e6f 6e65 2920 2d3e 204e 6f6e  e = None) -> Non
+00032a70: 653a 0a20 2020 2020 2020 2022 2222 5265  e:.        """Re
+00032a80: 6d6f 7665 2063 6c69 656e 7420 6672 6f6d  move client from
+00032a90: 206e 6574 776f 726b 2222 220a 2020 2020   network""".    
+00032aa0: 2020 2020 7374 696d 756c 7573 5f69 6420      stimulus_id 
+00032ab0: 3d20 7374 696d 756c 7573 5f69 6420 6f72  = stimulus_id or
+00032ac0: 2066 2272 656d 6f76 652d 636c 6965 6e74   f"remove-client
+00032ad0: 2d7b 7469 6d65 2829 7d22 0a20 2020 2020  -{time()}".     
+00032ae0: 2020 2069 6620 7365 6c66 2e73 7461 7475     if self.statu
+00032af0: 7320 3d3d 2053 7461 7475 732e 7275 6e6e  s == Status.runn
+00032b00: 696e 673a 0a20 2020 2020 2020 2020 2020  ing:.           
+00032b10: 206c 6f67 6765 722e 696e 666f 2822 5265   logger.info("Re
+00032b20: 6d6f 7665 2063 6c69 656e 7420 2573 222c  move client %s",
+00032b30: 2063 6c69 656e 7429 0a20 2020 2020 2020   client).       
+00032b40: 2073 656c 662e 6c6f 675f 6576 656e 7428   self.log_event(
+00032b50: 5b22 616c 6c22 2c20 636c 6965 6e74 5d2c  ["all", client],
+00032b60: 207b 2261 6374 696f 6e22 3a20 2272 656d   {"action": "rem
+00032b70: 6f76 652d 636c 6965 6e74 222c 2022 636c  ove-client", "cl
+00032b80: 6965 6e74 223a 2063 6c69 656e 747d 290a  ient": client}).
+00032b90: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00032ba0: 2020 2020 2020 2020 2063 733a 2043 6c69           cs: Cli
+00032bb0: 656e 7453 7461 7465 203d 2073 656c 662e  entState = self.
+00032bc0: 636c 6965 6e74 735b 636c 6965 6e74 5d0a  clients[client].
+00032bd0: 2020 2020 2020 2020 6578 6365 7074 204b          except K
+00032be0: 6579 4572 726f 723a 0a20 2020 2020 2020  eyError:.       
+00032bf0: 2020 2020 2023 2058 5858 2069 7320 7468       # XXX is th
+00032c00: 6973 2061 206c 6567 6974 696d 6174 6520  is a legitimate 
+00032c10: 636f 6e64 6974 696f 6e3f 0a20 2020 2020  condition?.     
+00032c20: 2020 2020 2020 2070 6173 730a 2020 2020         pass.    
+00032c30: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00032c40: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
+00032c50: 745f 7265 6c65 6173 6573 5f6b 6579 7328  t_releases_keys(
+00032c60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00032c70: 206b 6579 733d 5b74 732e 6b65 7920 666f   keys=[ts.key fo
+00032c80: 7220 7473 2069 6e20 6373 2e77 616e 7473  r ts in cs.wants
+00032c90: 5f77 6861 745d 2c0a 2020 2020 2020 2020  _what],.        
+00032ca0: 2020 2020 2020 2020 636c 6965 6e74 3d63          client=c
+00032cb0: 732e 636c 6965 6e74 5f6b 6579 2c0a 2020  s.client_key,.  
+00032cc0: 2020 2020 2020 2020 2020 2020 2020 7374                st
+00032cd0: 696d 756c 7573 5f69 643d 7374 696d 756c  imulus_id=stimul
+00032ce0: 7573 5f69 642c 0a20 2020 2020 2020 2020  us_id,.         
+00032cf0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00032d00: 2064 656c 2073 656c 662e 636c 6965 6e74   del self.client
+00032d10: 735b 636c 6965 6e74 5d0a 0a20 2020 2020  s[client]..     
+00032d20: 2020 2020 2020 2066 6f72 2070 6c75 6769         for plugi
+00032d30: 6e20 696e 206c 6973 7428 7365 6c66 2e70  n in list(self.p
+00032d40: 6c75 6769 6e73 2e76 616c 7565 7328 2929  lugins.values())
+00032d50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00032d60: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00032d70: 2020 2020 2020 2020 2020 2070 6c75 6769             plugi
+00032d80: 6e2e 7265 6d6f 7665 5f63 6c69 656e 7428  n.remove_client(
+00032d90: 7363 6865 6475 6c65 723d 7365 6c66 2c20  scheduler=self, 
+00032da0: 636c 6965 6e74 3d63 6c69 656e 7429 0a20  client=client). 
+00032db0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00032dc0: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
+00032dd0: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
+00032de0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+00032df0: 2e65 7863 6570 7469 6f6e 2865 290a 0a20  .exception(e).. 
+00032e00: 2020 2020 2020 2061 7379 6e63 2064 6566         async def
+00032e10: 2072 656d 6f76 655f 636c 6965 6e74 5f66   remove_client_f
+00032e20: 726f 6d5f 6576 656e 7473 2829 202d 3e20  rom_events() -> 
+00032e30: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00032e40: 2020 2320 4966 2074 6865 2063 6c69 656e    # If the clien
+00032e50: 7420 6973 6e27 7420 7265 6769 7374 6572  t isn't register
+00032e60: 6564 2061 6e79 6d6f 7265 2061 6674 6572  ed anymore after
+00032e70: 2074 6865 2064 656c 6179 2c20 7265 6d6f   the delay, remo
+00032e80: 7665 2066 726f 6d20 6576 656e 7473 0a20  ve from events. 
+00032e90: 2020 2020 2020 2020 2020 2069 6620 636c             if cl
+00032ea0: 6965 6e74 206e 6f74 2069 6e20 7365 6c66  ient not in self
+00032eb0: 2e63 6c69 656e 7473 2061 6e64 2063 6c69  .clients and cli
+00032ec0: 656e 7420 696e 2073 656c 662e 6576 656e  ent in self.even
+00032ed0: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
+00032ee0: 2020 2020 6465 6c20 7365 6c66 2e65 7665      del self.eve
+00032ef0: 6e74 735b 636c 6965 6e74 5d0a 0a20 2020  nts[client]..   
+00032f00: 2020 2020 2063 6c65 616e 7570 5f64 656c       cleanup_del
+00032f10: 6179 203d 2070 6172 7365 5f74 696d 6564  ay = parse_timed
+00032f20: 656c 7461 280a 2020 2020 2020 2020 2020  elta(.          
+00032f30: 2020 6461 736b 2e63 6f6e 6669 672e 6765    dask.config.ge
+00032f40: 7428 2264 6973 7472 6962 7574 6564 2e73  t("distributed.s
+00032f50: 6368 6564 756c 6572 2e65 7665 6e74 732d  cheduler.events-
+00032f60: 636c 6561 6e75 702d 6465 6c61 7922 290a  cleanup-delay").
+00032f70: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00032f80: 2020 6966 206e 6f74 2073 656c 662e 5f6f    if not self._o
+00032f90: 6e67 6f69 6e67 5f62 6163 6b67 726f 756e  ngoing_backgroun
+00032fa0: 645f 7461 736b 732e 636c 6f73 6564 3a0a  d_tasks.closed:.
+00032fb0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00032fc0: 2e5f 6f6e 676f 696e 675f 6261 636b 6772  ._ongoing_backgr
+00032fd0: 6f75 6e64 5f74 6173 6b73 2e63 616c 6c5f  ound_tasks.call_
+00032fe0: 6c61 7465 7228 0a20 2020 2020 2020 2020  later(.         
+00032ff0: 2020 2020 2020 2063 6c65 616e 7570 5f64         cleanup_d
+00033000: 656c 6179 2c20 7265 6d6f 7665 5f63 6c69  elay, remove_cli
+00033010: 656e 745f 6672 6f6d 5f65 7665 6e74 730a  ent_from_events.
+00033020: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+00033030: 2020 2064 6566 2073 656e 645f 7461 736b     def send_task
+00033040: 5f74 6f5f 776f 726b 6572 280a 2020 2020  _to_worker(.    
+00033050: 2020 2020 7365 6c66 2c20 776f 726b 6572      self, worker
+00033060: 3a20 7374 722c 2074 733a 2054 6173 6b53  : str, ts: TaskS
+00033070: 7461 7465 2c20 6475 7261 7469 6f6e 3a20  tate, duration: 
+00033080: 666c 6f61 7420 3d20 2d31 0a20 2020 2029  float = -1.    )
+00033090: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+000330a0: 2020 2222 2253 656e 6420 6120 7369 6e67    """Send a sing
+000330b0: 6c65 2063 6f6d 7075 7461 7469 6f6e 616c  le computational
+000330c0: 2074 6173 6b20 746f 2061 2077 6f72 6b65   task to a worke
+000330d0: 7222 2222 0a20 2020 2020 2020 2074 7279  r""".        try
+000330e0: 3a0a 2020 2020 2020 2020 2020 2020 6d73  :.            ms
+000330f0: 6720 3d20 7365 6c66 2e5f 7461 736b 5f74  g = self._task_t
+00033100: 6f5f 6d73 6728 7473 2c20 6475 7261 7469  o_msg(ts, durati
+00033110: 6f6e 290a 2020 2020 2020 2020 2020 2020  on).            
+00033120: 7365 6c66 2e77 6f72 6b65 725f 7365 6e64  self.worker_send
+00033130: 2877 6f72 6b65 722c 206d 7367 290a 2020  (worker, msg).  
+00033140: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
+00033150: 6570 7469 6f6e 2061 7320 653a 0a20 2020  eption as e:.   
+00033160: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+00033170: 6578 6365 7074 696f 6e28 6529 0a20 2020  exception(e).   
+00033180: 2020 2020 2020 2020 2069 6620 4c4f 475f           if LOG_
+00033190: 5044 423a 0a20 2020 2020 2020 2020 2020  PDB:.           
+000331a0: 2020 2020 2069 6d70 6f72 7420 7064 620a       import pdb.
+000331b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000331c0: 2070 6462 2e73 6574 5f74 7261 6365 2829   pdb.set_trace()
+000331d0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+000331e0: 7365 0a0a 2020 2020 6465 6620 6861 6e64  se..    def hand
+000331f0: 6c65 5f75 6e63 6175 6768 745f 6572 726f  le_uncaught_erro
+00033200: 7228 7365 6c66 2c20 2a2a 6d73 673a 2041  r(self, **msg: A
+00033210: 6e79 2920 2d3e 204e 6f6e 653a 0a20 2020  ny) -> None:.   
+00033220: 2020 2020 206c 6f67 6765 722e 6578 6365       logger.exce
+00033230: 7074 696f 6e28 636c 6561 6e5f 6578 6365  ption(clean_exce
+00033240: 7074 696f 6e28 2a2a 6d73 6729 5b31 5d29  ption(**msg)[1])
+00033250: 0a0a 2020 2020 6465 6620 6861 6e64 6c65  ..    def handle
+00033260: 5f74 6173 6b5f 6669 6e69 7368 6564 280a  _task_finished(.
+00033270: 2020 2020 2020 2020 7365 6c66 2c20 6b65          self, ke
+00033280: 793a 204b 6579 2c20 776f 726b 6572 3a20  y: Key, worker: 
+00033290: 7374 722c 2073 7469 6d75 6c75 735f 6964  str, stimulus_id
+000332a0: 3a20 7374 722c 202a 2a6d 7367 3a20 416e  : str, **msg: An
+000332b0: 790a 2020 2020 2920 2d3e 204e 6f6e 653a  y.    ) -> None:
+000332c0: 0a20 2020 2020 2020 2069 6620 776f 726b  .        if work
+000332d0: 6572 206e 6f74 2069 6e20 7365 6c66 2e77  er not in self.w
+000332e0: 6f72 6b65 7273 3a0a 2020 2020 2020 2020  orkers:.        
+000332f0: 2020 2020 7265 7475 726e 0a20 2020 2020      return.     
+00033300: 2020 2073 656c 662e 7661 6c69 6461 7465     self.validate
+00033310: 5f6b 6579 286b 6579 290a 0a20 2020 2020  _key(key)..     
+00033320: 2020 2072 3a20 7475 706c 6520 3d20 7365     r: tuple = se
+00033330: 6c66 2e73 7469 6d75 6c75 735f 7461 736b  lf.stimulus_task
+00033340: 5f66 696e 6973 6865 6428 0a20 2020 2020  _finished(.     
+00033350: 2020 2020 2020 206b 6579 3d6b 6579 2c20         key=key, 
+00033360: 776f 726b 6572 3d77 6f72 6b65 722c 2073  worker=worker, s
+00033370: 7469 6d75 6c75 735f 6964 3d73 7469 6d75  timulus_id=stimu
+00033380: 6c75 735f 6964 2c20 2a2a 6d73 670a 2020  lus_id, **msg.  
+00033390: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+000333a0: 7265 636f 6d6d 656e 6461 7469 6f6e 732c  recommendations,
+000333b0: 2063 6c69 656e 745f 6d73 6773 2c20 776f   client_msgs, wo
+000333c0: 726b 6572 5f6d 7367 7320 3d20 720a 2020  rker_msgs = r.  
+000333d0: 2020 2020 2020 7365 6c66 2e5f 7472 616e        self._tran
+000333e0: 7369 7469 6f6e 7328 7265 636f 6d6d 656e  sitions(recommen
+000333f0: 6461 7469 6f6e 732c 2063 6c69 656e 745f  dations, client_
+00033400: 6d73 6773 2c20 776f 726b 6572 5f6d 7367  msgs, worker_msg
+00033410: 732c 2073 7469 6d75 6c75 735f 6964 290a  s, stimulus_id).
+00033420: 2020 2020 2020 2020 7365 6c66 2e73 656e          self.sen
+00033430: 645f 616c 6c28 636c 6965 6e74 5f6d 7367  d_all(client_msg
+00033440: 732c 2077 6f72 6b65 725f 6d73 6773 290a  s, worker_msgs).
+00033450: 0a20 2020 2020 2020 2073 656c 662e 7374  .        self.st
+00033460: 696d 756c 7573 5f71 7565 7565 5f73 6c6f  imulus_queue_slo
+00033470: 7473 5f6d 6179 6265 5f6f 7065 6e65 6428  ts_maybe_opened(
+00033480: 7374 696d 756c 7573 5f69 643d 7374 696d  stimulus_id=stim
+00033490: 756c 7573 5f69 6429 0a0a 2020 2020 6465  ulus_id)..    de
+000334a0: 6620 6861 6e64 6c65 5f74 6173 6b5f 6572  f handle_task_er
+000334b0: 7265 6428 7365 6c66 2c20 6b65 793a 204b  red(self, key: K
+000334c0: 6579 2c20 7374 696d 756c 7573 5f69 643a  ey, stimulus_id:
+000334d0: 2073 7472 2c20 2a2a 6d73 673a 2041 6e79   str, **msg: Any
+000334e0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+000334f0: 2020 2072 3a20 7475 706c 6520 3d20 7365     r: tuple = se
+00033500: 6c66 2e73 7469 6d75 6c75 735f 7461 736b  lf.stimulus_task
+00033510: 5f65 7272 6564 286b 6579 3d6b 6579 2c20  _erred(key=key, 
+00033520: 7374 696d 756c 7573 5f69 643d 7374 696d  stimulus_id=stim
+00033530: 756c 7573 5f69 642c 202a 2a6d 7367 290a  ulus_id, **msg).
+00033540: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
+00033550: 6461 7469 6f6e 732c 2063 6c69 656e 745f  dations, client_
+00033560: 6d73 6773 2c20 776f 726b 6572 5f6d 7367  msgs, worker_msg
+00033570: 7320 3d20 720a 2020 2020 2020 2020 7365  s = r.        se
+00033580: 6c66 2e5f 7472 616e 7369 7469 6f6e 7328  lf._transitions(
+00033590: 7265 636f 6d6d 656e 6461 7469 6f6e 732c  recommendations,
+000335a0: 2063 6c69 656e 745f 6d73 6773 2c20 776f   client_msgs, wo
+000335b0: 726b 6572 5f6d 7367 732c 2073 7469 6d75  rker_msgs, stimu
+000335c0: 6c75 735f 6964 290a 2020 2020 2020 2020  lus_id).        
+000335d0: 7365 6c66 2e73 656e 645f 616c 6c28 636c  self.send_all(cl
+000335e0: 6965 6e74 5f6d 7367 732c 2077 6f72 6b65  ient_msgs, worke
+000335f0: 725f 6d73 6773 290a 0a20 2020 2020 2020  r_msgs)..       
+00033600: 2073 656c 662e 7374 696d 756c 7573 5f71   self.stimulus_q
+00033610: 7565 7565 5f73 6c6f 7473 5f6d 6179 6265  ueue_slots_maybe
+00033620: 5f6f 7065 6e65 6428 7374 696d 756c 7573  _opened(stimulus
+00033630: 5f69 643d 7374 696d 756c 7573 5f69 6429  _id=stimulus_id)
+00033640: 0a0a 2020 2020 6465 6620 7265 6c65 6173  ..    def releas
+00033650: 655f 776f 726b 6572 5f64 6174 6128 7365  e_worker_data(se
+00033660: 6c66 2c20 6b65 793a 204b 6579 2c20 776f  lf, key: Key, wo
+00033670: 726b 6572 3a20 7374 722c 2073 7469 6d75  rker: str, stimu
+00033680: 6c75 735f 6964 3a20 7374 7229 202d 3e20  lus_id: str) -> 
+00033690: 4e6f 6e65 3a0a 2020 2020 2020 2020 7473  None:.        ts
+000336a0: 203d 2073 656c 662e 7461 736b 732e 6765   = self.tasks.ge
+000336b0: 7428 6b65 7929 0a20 2020 2020 2020 2077  t(key).        w
+000336c0: 7320 3d20 7365 6c66 2e77 6f72 6b65 7273  s = self.workers
+000336d0: 2e67 6574 2877 6f72 6b65 7229 0a20 2020  .get(worker).   
+000336e0: 2020 2020 2069 6620 6e6f 7420 7473 206f       if not ts o
+000336f0: 7220 6e6f 7420 7773 206f 7220 7773 206e  r not ws or ws n
+00033700: 6f74 2069 6e20 2874 732e 7768 6f5f 6861  ot in (ts.who_ha
+00033710: 7320 6f72 2028 2929 3a0a 2020 2020 2020  s or ()):.      
+00033720: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
+00033730: 2020 2020 2020 7365 6c66 2e72 656d 6f76        self.remov
+00033740: 655f 7265 706c 6963 6128 7473 2c20 7773  e_replica(ts, ws
+00033750: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
+00033760: 2074 732e 7768 6f5f 6861 733a 0a20 2020   ts.who_has:.   
+00033770: 2020 2020 2020 2020 2073 656c 662e 7472           self.tr
+00033780: 616e 7369 7469 6f6e 7328 7b6b 6579 3a20  ansitions({key: 
+00033790: 2272 656c 6561 7365 6422 7d2c 2073 7469  "released"}, sti
+000337a0: 6d75 6c75 735f 6964 290a 0a20 2020 2064  mulus_id)..    d
+000337b0: 6566 2068 616e 646c 655f 6c6f 6e67 5f72  ef handle_long_r
+000337c0: 756e 6e69 6e67 280a 2020 2020 2020 2020  unning(.        
+000337d0: 7365 6c66 2c20 6b65 793a 204b 6579 2c20  self, key: Key, 
+000337e0: 776f 726b 6572 3a20 7374 722c 2063 6f6d  worker: str, com
+000337f0: 7075 7465 5f64 7572 6174 696f 6e3a 2066  pute_duration: f
+00033800: 6c6f 6174 207c 204e 6f6e 652c 2073 7469  loat | None, sti
+00033810: 6d75 6c75 735f 6964 3a20 7374 720a 2020  mulus_id: str.  
+00033820: 2020 2920 2d3e 204e 6f6e 653a 0a20 2020    ) -> None:.   
+00033830: 2020 2020 2022 2222 4120 7461 736b 2068       """A task h
+00033840: 6173 2073 6563 6564 6564 2066 726f 6d20  as seceded from 
+00033850: 7468 6520 7468 7265 6164 2070 6f6f 6c0a  the thread pool.
+00033860: 0a20 2020 2020 2020 2057 6520 7374 6f70  .        We stop
+00033870: 2074 6865 2074 6173 6b20 6672 6f6d 2062   the task from b
+00033880: 6569 6e67 2073 746f 6c65 6e20 696e 2074  eing stolen in t
+00033890: 6865 2066 7574 7572 652c 2061 6e64 2063  he future, and c
+000338a0: 6861 6e67 6520 7461 736b 0a20 2020 2020  hange task.     
+000338b0: 2020 2064 7572 6174 696f 6e20 6163 636f     duration acco
+000338c0: 756e 7469 6e67 2061 7320 6966 2074 6865  unting as if the
+000338d0: 2074 6173 6b20 6861 7320 7374 6f70 7065   task has stoppe
+000338e0: 642e 0a20 2020 2020 2020 2022 2222 0a20  d..        """. 
+000338f0: 2020 2020 2020 2069 6620 6b65 7920 6e6f         if key no
+00033900: 7420 696e 2073 656c 662e 7461 736b 733a  t in self.tasks:
+00033910: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+00033920: 6765 722e 6465 6275 6728 2253 6b69 7070  ger.debug("Skipp
+00033930: 696e 6720 6c6f 6e67 5f72 756e 6e69 6e67  ing long_running
+00033940: 2073 696e 6365 206b 6579 2025 7320 7761   since key %s wa
+00033950: 7320 616c 7265 6164 7920 7265 6c65 6173  s already releas
+00033960: 6564 222c 206b 6579 290a 2020 2020 2020  ed", key).      
+00033970: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
+00033980: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
+00033990: 6173 6b73 5b6b 6579 5d0a 2020 2020 2020  asks[key].      
+000339a0: 2020 7374 6561 6c20 3d20 7365 6c66 2e65    steal = self.e
+000339b0: 7874 656e 7369 6f6e 732e 6765 7428 2273  xtensions.get("s
+000339c0: 7465 616c 696e 6722 290a 2020 2020 2020  tealing").      
+000339d0: 2020 6966 2073 7465 616c 2069 7320 6e6f    if steal is no
+000339e0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+000339f0: 2020 2020 7374 6561 6c2e 7265 6d6f 7665      steal.remove
+00033a00: 5f6b 6579 5f66 726f 6d5f 7374 6561 6c61  _key_from_steala
+00033a10: 626c 6528 7473 290a 0a20 2020 2020 2020  ble(ts)..       
+00033a20: 2077 7320 3d20 7473 2e70 726f 6365 7373   ws = ts.process
+00033a30: 696e 675f 6f6e 0a20 2020 2020 2020 2069  ing_on.        i
+00033a40: 6620 7773 2069 7320 4e6f 6e65 3a0a 2020  f ws is None:.  
+00033a50: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+00033a60: 2e64 6562 7567 2822 5265 6365 6976 6564  .debug("Received
+00033a70: 206c 6f6e 672d 7275 6e6e 696e 6720 7369   long-running si
+00033a80: 676e 616c 2066 726f 6d20 6475 706c 6963  gnal from duplic
+00033a90: 6174 6520 7461 736b 2e20 4967 6e6f 7269  ate task. Ignori
+00033aa0: 6e67 2e22 290a 2020 2020 2020 2020 2020  ng.").          
+00033ab0: 2020 7265 7475 726e 0a0a 2020 2020 2020    return..      
+00033ac0: 2020 6966 2063 6f6d 7075 7465 5f64 7572    if compute_dur
+00033ad0: 6174 696f 6e20 6973 206e 6f74 204e 6f6e  ation is not Non
+00033ae0: 653a 0a20 2020 2020 2020 2020 2020 206f  e:.            o
+00033af0: 6c64 5f64 7572 6174 696f 6e20 3d20 7473  ld_duration = ts
+00033b00: 2e70 7265 6669 782e 6475 7261 7469 6f6e  .prefix.duration
+00033b10: 5f61 7665 7261 6765 0a20 2020 2020 2020  _average.       
+00033b20: 2020 2020 2069 6620 6f6c 645f 6475 7261       if old_dura
+00033b30: 7469 6f6e 203c 2030 3a0a 2020 2020 2020  tion < 0:.      
+00033b40: 2020 2020 2020 2020 2020 7473 2e70 7265            ts.pre
+00033b50: 6669 782e 6475 7261 7469 6f6e 5f61 7665  fix.duration_ave
+00033b60: 7261 6765 203d 2063 6f6d 7075 7465 5f64  rage = compute_d
+00033b70: 7572 6174 696f 6e0a 2020 2020 2020 2020  uration.        
+00033b80: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00033b90: 2020 2020 2020 2020 2020 7473 2e70 7265            ts.pre
+00033ba0: 6669 782e 6475 7261 7469 6f6e 5f61 7665  fix.duration_ave
+00033bb0: 7261 6765 203d 2028 6f6c 645f 6475 7261  rage = (old_dura
+00033bc0: 7469 6f6e 202b 2063 6f6d 7075 7465 5f64  tion + compute_d
+00033bd0: 7572 6174 696f 6e29 202f 2032 0a0a 2020  uration) / 2..  
+00033be0: 2020 2020 2020 7773 2e61 6464 5f74 6f5f        ws.add_to_
+00033bf0: 6c6f 6e67 5f72 756e 6e69 6e67 2874 7329  long_running(ts)
+00033c00: 0a20 2020 2020 2020 2073 656c 662e 6368  .        self.ch
+00033c10: 6563 6b5f 6964 6c65 5f73 6174 7572 6174  eck_idle_saturat
+00033c20: 6564 2877 7329 0a0a 2020 2020 2020 2020  ed(ws)..        
+00033c30: 7365 6c66 2e73 7469 6d75 6c75 735f 7175  self.stimulus_qu
+00033c40: 6575 655f 736c 6f74 735f 6d61 7962 655f  eue_slots_maybe_
+00033c50: 6f70 656e 6564 2873 7469 6d75 6c75 735f  opened(stimulus_
+00033c60: 6964 3d73 7469 6d75 6c75 735f 6964 290a  id=stimulus_id).
+00033c70: 0a20 2020 2064 6566 2068 616e 646c 655f  .    def handle_
+00033c80: 776f 726b 6572 5f73 7461 7475 735f 6368  worker_status_ch
+00033c90: 616e 6765 280a 2020 2020 2020 2020 7365  ange(.        se
+00033ca0: 6c66 2c20 7374 6174 7573 3a20 7374 7220  lf, status: str 
+00033cb0: 7c20 5374 6174 7573 2c20 776f 726b 6572  | Status, worker
+00033cc0: 3a20 7374 7220 7c20 576f 726b 6572 5374  : str | WorkerSt
+00033cd0: 6174 652c 2073 7469 6d75 6c75 735f 6964  ate, stimulus_id
+00033ce0: 3a20 7374 720a 2020 2020 2920 2d3e 204e  : str.    ) -> N
+00033cf0: 6f6e 653a 0a20 2020 2020 2020 2077 7320  one:.        ws 
+00033d00: 3d20 7365 6c66 2e77 6f72 6b65 7273 2e67  = self.workers.g
+00033d10: 6574 2877 6f72 6b65 7229 2069 6620 6973  et(worker) if is
+00033d20: 696e 7374 616e 6365 2877 6f72 6b65 722c  instance(worker,
+00033d30: 2073 7472 2920 656c 7365 2077 6f72 6b65   str) else worke
+00033d40: 720a 2020 2020 2020 2020 6966 206e 6f74  r.        if not
+00033d50: 2077 733a 0a20 2020 2020 2020 2020 2020   ws:.           
+00033d60: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
+00033d70: 7072 6576 5f73 7461 7475 7320 3d20 7773  prev_status = ws
+00033d80: 2e73 7461 7475 730a 2020 2020 2020 2020  .status.        
+00033d90: 7773 2e73 7461 7475 7320 3d20 5374 6174  ws.status = Stat
+00033da0: 7573 5b73 7461 7475 735d 2069 6620 6973  us[status] if is
+00033db0: 696e 7374 616e 6365 2873 7461 7475 732c  instance(status,
+00033dc0: 2073 7472 2920 656c 7365 2073 7461 7475   str) else statu
+00033dd0: 730a 2020 2020 2020 2020 6966 2077 732e  s.        if ws.
+00033de0: 7374 6174 7573 203d 3d20 7072 6576 5f73  status == prev_s
+00033df0: 7461 7475 733a 0a20 2020 2020 2020 2020  tatus:.         
+00033e00: 2020 2072 6574 7572 6e0a 0a20 2020 2020     return..     
+00033e10: 2020 2073 656c 662e 6c6f 675f 6576 656e     self.log_even
+00033e20: 7428 0a20 2020 2020 2020 2020 2020 2077  t(.            w
+00033e30: 732e 6164 6472 6573 732c 0a20 2020 2020  s.address,.     
+00033e40: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00033e50: 2020 2020 2020 2020 2022 6163 7469 6f6e           "action
+00033e60: 223a 2022 776f 726b 6572 2d73 7461 7475  ": "worker-statu
+00033e70: 732d 6368 616e 6765 222c 0a20 2020 2020  s-change",.     
+00033e80: 2020 2020 2020 2020 2020 2022 7072 6576             "prev
+00033e90: 2d73 7461 7475 7322 3a20 7072 6576 5f73  -status": prev_s
+00033ea0: 7461 7475 732e 6e61 6d65 2c0a 2020 2020  tatus.name,.    
+00033eb0: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
+00033ec0: 7475 7322 3a20 7773 2e73 7461 7475 732e  tus": ws.status.
+00033ed0: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
+00033ee0: 2020 2020 2020 2273 7469 6d75 6c75 735f        "stimulus_
+00033ef0: 6964 223a 2073 7469 6d75 6c75 735f 6964  id": stimulus_id
+00033f00: 2c0a 2020 2020 2020 2020 2020 2020 7d2c  ,.            },
+00033f10: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+00033f20: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
+00033f30: 6622 576f 726b 6572 2073 7461 7475 7320  f"Worker status 
+00033f40: 7b70 7265 765f 7374 6174 7573 2e6e 616d  {prev_status.nam
+00033f50: 657d 202d 3e20 7b73 7461 7475 737d 202d  e} -> {status} -
+00033f60: 207b 7773 7d22 290a 0a20 2020 2020 2020   {ws}")..       
+00033f70: 2069 6620 7773 2e73 7461 7475 7320 3d3d   if ws.status ==
+00033f80: 2053 7461 7475 732e 7275 6e6e 696e 673a   Status.running:
+00033f90: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00033fa0: 662e 7275 6e6e 696e 672e 6164 6428 7773  f.running.add(ws
+00033fb0: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
+00033fc0: 6c66 2e63 6865 636b 5f69 646c 655f 7361  lf.check_idle_sa
+00033fd0: 7475 7261 7465 6428 7773 290a 2020 2020  turated(ws).    
+00033fe0: 2020 2020 2020 2020 7365 6c66 2e74 7261          self.tra
+00033ff0: 6e73 6974 696f 6e73 280a 2020 2020 2020  nsitions(.      
+00034000: 2020 2020 2020 2020 2020 7365 6c66 2e62            self.b
+00034010: 756c 6b5f 7363 6865 6475 6c65 5f75 6e72  ulk_schedule_unr
+00034020: 756e 6e61 626c 655f 6166 7465 725f 6164  unnable_after_ad
+00034030: 6469 6e67 5f77 6f72 6b65 7228 7773 292c  ding_worker(ws),
+00034040: 2073 7469 6d75 6c75 735f 6964 0a20 2020   stimulus_id.   
+00034050: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00034060: 2020 2020 2020 2073 656c 662e 7374 696d         self.stim
+00034070: 756c 7573 5f71 7565 7565 5f73 6c6f 7473  ulus_queue_slots
+00034080: 5f6d 6179 6265 5f6f 7065 6e65 6428 7374  _maybe_opened(st
+00034090: 696d 756c 7573 5f69 643d 7374 696d 756c  imulus_id=stimul
+000340a0: 7573 5f69 6429 0a20 2020 2020 2020 2065  us_id).        e
+000340b0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+000340c0: 2073 656c 662e 7275 6e6e 696e 672e 6469   self.running.di
+000340d0: 7363 6172 6428 7773 290a 2020 2020 2020  scard(ws).      
+000340e0: 2020 2020 2020 7365 6c66 2e69 646c 652e        self.idle.
+000340f0: 706f 7028 7773 2e61 6464 7265 7373 2c20  pop(ws.address, 
+00034100: 4e6f 6e65 290a 2020 2020 2020 2020 2020  None).          
+00034110: 2020 7365 6c66 2e69 646c 655f 7461 736b    self.idle_task
+00034120: 5f63 6f75 6e74 2e64 6973 6361 7264 2877  _count.discard(w
+00034130: 7329 0a20 2020 2020 2020 2020 2020 2073  s).            s
+00034140: 656c 662e 7361 7475 7261 7465 642e 6469  elf.saturated.di
+00034150: 7363 6172 6428 7773 290a 0a20 2020 2064  scard(ws)..    d
+00034160: 6566 2068 616e 646c 655f 7265 7175 6573  ef handle_reques
+00034170: 745f 7265 6672 6573 685f 7768 6f5f 6861  t_refresh_who_ha
+00034180: 7328 0a20 2020 2020 2020 2073 656c 662c  s(.        self,
+00034190: 206b 6579 733a 2049 7465 7261 626c 655b   keys: Iterable[
+000341a0: 4b65 795d 2c20 776f 726b 6572 3a20 7374  Key], worker: st
+000341b0: 722c 2073 7469 6d75 6c75 735f 6964 3a20  r, stimulus_id: 
+000341c0: 7374 720a 2020 2020 2920 2d3e 204e 6f6e  str.    ) -> Non
+000341d0: 653a 0a20 2020 2020 2020 2022 2222 5265  e:.        """Re
+000341e0: 7175 6573 7420 6672 6f6d 2061 2057 6f72  quest from a Wor
+000341f0: 6b65 7220 746f 2072 6566 7265 7368 2074  ker to refresh t
+00034200: 6865 0a20 2020 2020 2020 2077 686f 5f68  he.        who_h
+00034210: 6173 2066 6f72 2073 6f6d 6520 6b65 7973  as for some keys
+00034220: 2e20 4e6f 7420 746f 2062 6520 636f 6e66  . Not to be conf
+00034230: 7573 6564 2077 6974 6820 7363 6865 6475  used with schedu
+00034240: 6c65 722e 7768 6f5f 6861 732c 2077 6869  ler.who_has, whi
+00034250: 6368 0a20 2020 2020 2020 2069 7320 6120  ch.        is a 
+00034260: 6465 6469 6361 7465 6420 636f 6d6d 2052  dedicated comm R
+00034270: 5043 2072 6571 7565 7374 2066 726f 6d20  PC request from 
+00034280: 6120 436c 6965 6e74 2e0a 2020 2020 2020  a Client..      
+00034290: 2020 2222 220a 2020 2020 2020 2020 7768    """.        wh
+000342a0: 6f5f 6861 7320 3d20 7b7d 0a20 2020 2020  o_has = {}.     
+000342b0: 2020 2066 7265 655f 6b65 7973 203d 205b     free_keys = [
+000342c0: 5d0a 2020 2020 2020 2020 666f 7220 6b65  ].        for ke
+000342d0: 7920 696e 206b 6579 733a 0a20 2020 2020  y in keys:.     
+000342e0: 2020 2020 2020 2069 6620 6b65 7920 696e         if key in
+000342f0: 2073 656c 662e 7461 736b 733a 0a20 2020   self.tasks:.   
+00034300: 2020 2020 2020 2020 2020 2020 2077 686f               who
+00034310: 5f68 6173 5b6b 6579 5d20 3d20 5b77 732e  _has[key] = [ws.
+00034320: 6164 6472 6573 7320 666f 7220 7773 2069  address for ws i
+00034330: 6e20 7365 6c66 2e74 6173 6b73 5b6b 6579  n self.tasks[key
+00034340: 5d2e 7768 6f5f 6861 7320 6f72 2028 295d  ].who_has or ()]
+00034350: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00034360: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00034370: 2020 2066 7265 655f 6b65 7973 2e61 7070     free_keys.app
+00034380: 656e 6428 6b65 7929 0a0a 2020 2020 2020  end(key)..      
+00034390: 2020 6966 2077 686f 5f68 6173 3a0a 2020    if who_has:.  
+000343a0: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
+000343b0: 7472 6561 6d5f 636f 6d6d 735b 776f 726b  tream_comms[work
+000343c0: 6572 5d2e 7365 6e64 280a 2020 2020 2020  er].send(.      
+000343d0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+000343e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000343f0: 226f 7022 3a20 2272 6566 7265 7368 2d77  "op": "refresh-w
+00034400: 686f 2d68 6173 222c 0a20 2020 2020 2020  ho-has",.       
+00034410: 2020 2020 2020 2020 2020 2020 2022 7768               "wh
+00034420: 6f5f 6861 7322 3a20 7768 6f5f 6861 732c  o_has": who_has,
+00034430: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00034440: 2020 2020 2022 7374 696d 756c 7573 5f69       "stimulus_i
+00034450: 6422 3a20 7374 696d 756c 7573 5f69 642c  d": stimulus_id,
+00034460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00034470: 207d 0a20 2020 2020 2020 2020 2020 2029   }.            )
+00034480: 0a20 2020 2020 2020 2069 6620 6672 6565  .        if free
+00034490: 5f6b 6579 733a 0a20 2020 2020 2020 2020  _keys:.         
+000344a0: 2020 2073 656c 662e 7374 7265 616d 5f63     self.stream_c
+000344b0: 6f6d 6d73 5b77 6f72 6b65 725d 2e73 656e  omms[worker].sen
+000344c0: 6428 0a20 2020 2020 2020 2020 2020 2020  d(.             
+000344d0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+000344e0: 2020 2020 2020 2020 2022 6f70 223a 2022           "op": "
+000344f0: 6672 6565 2d6b 6579 7322 2c0a 2020 2020  free-keys",.    
+00034500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034510: 226b 6579 7322 3a20 6672 6565 5f6b 6579  "keys": free_key
+00034520: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+00034530: 2020 2020 2020 2022 7374 696d 756c 7573         "stimulus
+00034540: 5f69 6422 3a20 7374 696d 756c 7573 5f69  _id": stimulus_i
+00034550: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+00034560: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+00034570: 2029 0a0a 2020 2020 6173 796e 6320 6465   )..    async de
+00034580: 6620 6861 6e64 6c65 5f77 6f72 6b65 7228  f handle_worker(
+00034590: 7365 6c66 2c20 636f 6d6d 3a20 436f 6d6d  self, comm: Comm
+000345a0: 2c20 776f 726b 6572 3a20 7374 7229 202d  , worker: str) -
+000345b0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+000345c0: 2222 220a 2020 2020 2020 2020 4c69 7374  """.        List
+000345d0: 656e 2074 6f20 7265 7370 6f6e 7365 7320  en to responses 
+000345e0: 6672 6f6d 2061 2073 696e 676c 6520 776f  from a single wo
+000345f0: 726b 6572 0a0a 2020 2020 2020 2020 5468  rker..        Th
+00034600: 6973 2069 7320 7468 6520 6d61 696e 206c  is is the main l
+00034610: 6f6f 7020 666f 7220 7363 6865 6475 6c65  oop for schedule
+00034620: 722d 776f 726b 6572 2069 6e74 6572 6163  r-worker interac
+00034630: 7469 6f6e 0a0a 2020 2020 2020 2020 5365  tion..        Se
+00034640: 6520 416c 736f 0a20 2020 2020 2020 202d  e Also.        -
+00034650: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
+00034660: 5363 6865 6475 6c65 722e 6861 6e64 6c65  Scheduler.handle
+00034670: 5f63 6c69 656e 743a 2045 7175 6976 616c  _client: Equival
+00034680: 656e 7420 636f 726f 7574 696e 6520 666f  ent coroutine fo
+00034690: 7220 636c 6965 6e74 730a 2020 2020 2020  r clients.      
+000346a0: 2020 2222 220a 2020 2020 2020 2020 636f    """.        co
+000346b0: 6d6d 2e6e 616d 6520 3d20 2253 6368 6564  mm.name = "Sched
+000346c0: 756c 6572 2063 6f6e 6e65 6374 696f 6e20  uler connection 
+000346d0: 746f 2077 6f72 6b65 7222 0a20 2020 2020  to worker".     
+000346e0: 2020 2077 6f72 6b65 725f 636f 6d6d 203d     worker_comm =
+000346f0: 2073 656c 662e 7374 7265 616d 5f63 6f6d   self.stream_com
+00034700: 6d73 5b77 6f72 6b65 725d 0a20 2020 2020  ms[worker].     
+00034710: 2020 2077 6f72 6b65 725f 636f 6d6d 2e73     worker_comm.s
+00034720: 7461 7274 2863 6f6d 6d29 0a20 2020 2020  tart(comm).     
+00034730: 2020 206c 6f67 6765 722e 696e 666f 2822     logger.info("
+00034740: 5374 6172 7469 6e67 2077 6f72 6b65 7220  Starting worker 
+00034750: 636f 6d70 7574 6520 7374 7265 616d 2c20  compute stream, 
+00034760: 2573 222c 2077 6f72 6b65 7229 0a20 2020  %s", worker).   
+00034770: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00034780: 2020 2020 2020 6177 6169 7420 7365 6c66        await self
+00034790: 2e68 616e 646c 655f 7374 7265 616d 2863  .handle_stream(c
+000347a0: 6f6d 6d3d 636f 6d6d 2c20 6578 7472 613d  omm=comm, extra=
+000347b0: 7b22 776f 726b 6572 223a 2077 6f72 6b65  {"worker": worke
+000347c0: 727d 290a 2020 2020 2020 2020 6669 6e61  r}).        fina
+000347d0: 6c6c 793a 0a20 2020 2020 2020 2020 2020  lly:.           
+000347e0: 2069 6620 776f 726b 6572 2069 6e20 7365   if worker in se
+000347f0: 6c66 2e73 7472 6561 6d5f 636f 6d6d 733a  lf.stream_comms:
+00034800: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00034810: 2077 6f72 6b65 725f 636f 6d6d 2e61 626f   worker_comm.abo
+00034820: 7274 2829 0a20 2020 2020 2020 2020 2020  rt().           
+00034830: 2020 2020 2061 7761 6974 2073 656c 662e       await self.
+00034840: 7265 6d6f 7665 5f77 6f72 6b65 7228 0a20  remove_worker(. 
+00034850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034860: 2020 2077 6f72 6b65 722c 2073 7469 6d75     worker, stimu
+00034870: 6c75 735f 6964 3d66 2268 616e 646c 652d  lus_id=f"handle-
+00034880: 776f 726b 6572 2d63 6c65 616e 7570 2d7b  worker-cleanup-{
+00034890: 7469 6d65 2829 7d22 0a20 2020 2020 2020  time()}".       
+000348a0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+000348b0: 6465 6620 6164 645f 706c 7567 696e 280a  def add_plugin(.
+000348c0: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+000348d0: 2020 2020 2020 706c 7567 696e 3a20 5363        plugin: Sc
+000348e0: 6865 6475 6c65 7250 6c75 6769 6e2c 0a20  hedulerPlugin,. 
+000348f0: 2020 2020 2020 202a 2c0a 2020 2020 2020         *,.      
+00034900: 2020 6964 656d 706f 7465 6e74 3a20 626f    idempotent: bo
+00034910: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
+00034920: 2020 2020 6e61 6d65 3a20 7374 7220 7c20      name: str | 
+00034930: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
+00034940: 2020 2020 202a 2a6b 7761 7267 733a 2041       **kwargs: A
+00034950: 6e79 2c0a 2020 2020 2920 2d3e 204e 6f6e  ny,.    ) -> Non
+00034960: 653a 0a20 2020 2020 2020 2022 2222 4164  e:.        """Ad
+00034970: 6420 6578 7465 726e 616c 2070 6c75 6769  d external plugi
+00034980: 6e20 746f 2073 6368 6564 756c 6572 2e0a  n to scheduler..
+00034990: 0a20 2020 2020 2020 2053 6565 2068 7474  .        See htt
+000349a0: 7073 3a2f 2f64 6973 7472 6962 7574 6564  ps://distributed
+000349b0: 2e72 6561 6474 6865 646f 6373 2e69 6f2f  .readthedocs.io/
+000349c0: 656e 2f6c 6174 6573 742f 706c 7567 696e  en/latest/plugin
+000349d0: 732e 6874 6d6c 0a0a 2020 2020 2020 2020  s.html..        
+000349e0: 5061 7261 6d65 7465 7273 0a20 2020 2020  Parameters.     
+000349f0: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
+00034a00: 2020 2020 2020 706c 7567 696e 203a 2053        plugin : S
+00034a10: 6368 6564 756c 6572 506c 7567 696e 0a20  chedulerPlugin. 
+00034a20: 2020 2020 2020 2020 2020 2053 6368 6564             Sched
+00034a30: 756c 6572 506c 7567 696e 2069 6e73 7461  ulerPlugin insta
+00034a40: 6e63 6520 746f 2061 6464 0a20 2020 2020  nce to add.     
+00034a50: 2020 2069 6465 6d70 6f74 656e 7420 3a20     idempotent : 
+00034a60: 626f 6f6c 0a20 2020 2020 2020 2020 2020  bool.           
+00034a70: 2049 6620 7472 7565 2c20 7468 6520 706c   If true, the pl
+00034a80: 7567 696e 2069 7320 6173 7375 6d65 6420  ugin is assumed 
+00034a90: 746f 2061 6c72 6561 6479 2065 7869 7374  to already exist
+00034aa0: 2061 6e64 206e 6f0a 2020 2020 2020 2020   and no.        
+00034ab0: 2020 2020 6163 7469 6f6e 2069 7320 7461      action is ta
+00034ac0: 6b65 6e2e 0a20 2020 2020 2020 206e 616d  ken..        nam
+00034ad0: 6520 3a20 7374 720a 2020 2020 2020 2020  e : str.        
+00034ae0: 2020 2020 4120 6e61 6d65 2066 6f72 2074      A name for t
+00034af0: 6865 2070 6c75 6769 6e2c 2069 6620 4e6f  he plugin, if No
+00034b00: 6e65 2c20 7468 6520 6e61 6d65 2061 7474  ne, the name att
+00034b10: 7269 6275 7465 2069 730a 2020 2020 2020  ribute is.      
+00034b20: 2020 2020 2020 6368 6563 6b65 6420 6f6e        checked on
+00034b30: 2074 6865 2050 6c75 6769 6e20 696e 7374   the Plugin inst
+00034b40: 616e 6365 2061 6e64 2067 656e 6572 6174  ance and generat
+00034b50: 6564 2069 6620 6e6f 740a 2020 2020 2020  ed if not.      
+00034b60: 2020 2020 2020 6469 7363 6f76 6572 6564        discovered
+00034b70: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+00034b80: 2020 2020 2020 6966 206e 616d 6520 6973        if name is
+00034b90: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00034ba0: 2020 206e 616d 6520 3d20 5f67 6574 5f70     name = _get_p
+00034bb0: 6c75 6769 6e5f 6e61 6d65 2870 6c75 6769  lugin_name(plugi
+00034bc0: 6e29 0a0a 2020 2020 2020 2020 6966 206e  n)..        if n
+00034bd0: 616d 6520 696e 2073 656c 662e 706c 7567  ame in self.plug
+00034be0: 696e 733a 0a20 2020 2020 2020 2020 2020  ins:.           
+00034bf0: 2069 6620 6964 656d 706f 7465 6e74 3a0a   if idempotent:.
+00034c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034c10: 7265 7475 726e 0a20 2020 2020 2020 2020  return.         
+00034c20: 2020 2077 6172 6e69 6e67 732e 7761 726e     warnings.warn
+00034c30: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00034c40: 2020 6622 5363 6865 6475 6c65 7220 616c    f"Scheduler al
+00034c50: 7265 6164 7920 636f 6e74 6169 6e73 2061  ready contains a
+00034c60: 2070 6c75 6769 6e20 7769 7468 206e 616d   plugin with nam
+00034c70: 6520 7b6e 616d 657d 3b20 6f76 6572 7772  e {name}; overwr
+00034c80: 6974 696e 672e 222c 0a20 2020 2020 2020  iting.",.       
+00034c90: 2020 2020 2020 2020 2063 6174 6567 6f72           categor
+00034ca0: 793d 5573 6572 5761 726e 696e 672c 0a20  y=UserWarning,. 
+00034cb0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00034cc0: 2020 2020 2020 7061 7261 6d65 7465 7273        parameters
+00034cd0: 203d 2069 6e73 7065 6374 2e73 6967 6e61   = inspect.signa
+00034ce0: 7475 7265 2870 6c75 6769 6e2e 7265 6d6f  ture(plugin.remo
+00034cf0: 7665 5f77 6f72 6b65 7229 2e70 6172 616d  ve_worker).param
+00034d00: 6574 6572 730a 2020 2020 2020 2020 6966  eters.        if
+00034d10: 206e 6f74 2061 6e79 2870 2e6b 696e 6420   not any(p.kind 
+00034d20: 6973 2070 2e56 4152 5f4b 4559 574f 5244  is p.VAR_KEYWORD
+00034d30: 2066 6f72 2070 2069 6e20 7061 7261 6d65   for p in parame
+00034d40: 7465 7273 2e76 616c 7565 7328 2929 3a0a  ters.values()):.
+00034d50: 2020 2020 2020 2020 2020 2020 7761 726e              warn
+00034d60: 696e 6773 2e77 6172 6e28 0a20 2020 2020  ings.warn(.     
+00034d70: 2020 2020 2020 2020 2020 2022 5468 6520             "The 
+00034d80: 7369 676e 6174 7572 6520 6f66 2060 5363  signature of `Sc
+00034d90: 6865 6475 6c65 7250 6c75 6769 6e2e 7265  hedulerPlugin.re
+00034da0: 6d6f 7665 5f77 6f72 6b65 7260 206e 6f77  move_worker` now
+00034db0: 2072 6571 7569 7265 7320 602a 2a6b 7761   requires `**kwa
+00034dc0: 7267 7360 2022 0a20 2020 2020 2020 2020  rgs` ".         
+00034dd0: 2020 2020 2020 2022 746f 2065 6e73 7572         "to ensur
+00034de0: 6520 7468 6174 2070 6c75 6769 6e73 2072  e that plugins r
+00034df0: 656d 6169 6e20 666f 7277 6172 642d 636f  emain forward-co
+00034e00: 6d70 6174 6962 6c65 2e20 4e6f 7420 696e  mpatible. Not in
+00034e10: 636c 7564 696e 6720 220a 2020 2020 2020  cluding ".      
+00034e20: 2020 2020 2020 2020 2020 2260 2a2a 6b77            "`**kw
+00034e30: 6172 6773 6020 696e 2074 6865 2073 6967  args` in the sig
+00034e40: 6e61 7475 7265 2077 696c 6c20 6e6f 206c  nature will no l
+00034e50: 6f6e 6765 7220 6265 2073 7570 706f 7274  onger be support
+00034e60: 6564 2069 6e20 6675 7475 7265 2076 6572  ed in future ver
+00034e70: 7369 6f6e 732e 222c 0a20 2020 2020 2020  sions.",.       
+00034e80: 2020 2020 2020 2020 2046 7574 7572 6557           FutureW
+00034e90: 6172 6e69 6e67 2c0a 2020 2020 2020 2020  arning,.        
+00034ea0: 2020 2020 290a 0a20 2020 2020 2020 2073      )..        s
+00034eb0: 656c 662e 706c 7567 696e 735b 6e61 6d65  elf.plugins[name
+00034ec0: 5d20 3d20 706c 7567 696e 0a0a 2020 2020  ] = plugin..    
+00034ed0: 6465 6620 7265 6d6f 7665 5f70 6c75 6769  def remove_plugi
+00034ee0: 6e28 7365 6c66 2c20 6e61 6d65 3a20 7374  n(self, name: st
+00034ef0: 7220 7c20 4e6f 6e65 203d 204e 6f6e 6529  r | None = None)
+00034f00: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00034f10: 2020 2222 2252 656d 6f76 6520 6578 7465    """Remove exte
+00034f20: 726e 616c 2070 6c75 6769 6e20 6672 6f6d  rnal plugin from
+00034f30: 2073 6368 6564 756c 6572 0a0a 2020 2020   scheduler..    
+00034f40: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
+00034f50: 2020 2020 2020 202d 2d2d 2d2d 2d2d 2d2d         ---------
+00034f60: 2d0a 2020 2020 2020 2020 6e61 6d65 203a  -.        name :
+00034f70: 2073 7472 0a20 2020 2020 2020 2020 2020   str.           
+00034f80: 204e 616d 6520 6f66 2074 6865 2070 6c75   Name of the plu
+00034f90: 6769 6e20 746f 2072 656d 6f76 650a 2020  gin to remove.  
+00034fa0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00034fb0: 2020 6173 7365 7274 206e 616d 6520 6973    assert name is
+00034fc0: 206e 6f74 204e 6f6e 650a 0a20 2020 2020   not None..     
+00034fd0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00034fe0: 2020 2020 6465 6c20 7365 6c66 2e70 6c75      del self.plu
+00034ff0: 6769 6e73 5b6e 616d 655d 0a20 2020 2020  gins[name].     
+00035000: 2020 2065 7863 6570 7420 4b65 7945 7272     except KeyErr
+00035010: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
+00035020: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+00035030: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00035040: 2020 6622 436f 756c 6420 6e6f 7420 6669    f"Could not fi
+00035050: 6e64 2070 6c75 6769 6e20 7b6e 616d 6521  nd plugin {name!
+00035060: 727d 2061 6d6f 6e67 2074 6865 2063 7572  r} among the cur
+00035070: 7265 6e74 2073 6368 6564 756c 6572 2070  rent scheduler p
+00035080: 6c75 6769 6e73 220a 2020 2020 2020 2020  lugins".        
+00035090: 2020 2020 290a 0a20 2020 2061 7379 6e63      )..    async
+000350a0: 2064 6566 2072 6567 6973 7465 725f 7363   def register_sc
+000350b0: 6865 6475 6c65 725f 706c 7567 696e 280a  heduler_plugin(.
+000350c0: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+000350d0: 2020 2020 2020 706c 7567 696e 3a20 6279        plugin: by
+000350e0: 7465 7320 7c20 5363 6865 6475 6c65 7250  tes | SchedulerP
+000350f0: 6c75 6769 6e2c 0a20 2020 2020 2020 206e  lugin,.        n
+00035100: 616d 653a 2073 7472 207c 204e 6f6e 6520  ame: str | None 
+00035110: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00035120: 6964 656d 706f 7465 6e74 3a20 626f 6f6c  idempotent: bool
+00035130: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
+00035140: 2020 2020 2920 2d3e 204e 6f6e 653a 0a20      ) -> None:. 
+00035150: 2020 2020 2020 2022 2222 5265 6769 7374         """Regist
+00035160: 6572 2061 2070 6c75 6769 6e20 6f6e 2074  er a plugin on t
+00035170: 6865 2073 6368 6564 756c 6572 2e22 2222  he scheduler."""
+00035180: 0a20 2020 2020 2020 2069 6620 6964 656d  .        if idem
+00035190: 706f 7465 6e74 2069 7320 4e6f 6e65 3a0a  potent is None:.
+000351a0: 2020 2020 2020 2020 2020 2020 7761 726e              warn
+000351b0: 696e 6773 2e77 6172 6e28 0a20 2020 2020  ings.warn(.     
+000351c0: 2020 2020 2020 2020 2020 2022 5468 6520             "The 
+000351d0: 7369 676e 6174 7572 6520 6f66 2060 5363  signature of `Sc
+000351e0: 6865 6475 6c65 722e 7265 6769 7374 6572  heduler.register
+000351f0: 5f73 6368 6564 756c 6572 5f70 6c75 6769  _scheduler_plugi
+00035200: 6e60 206e 6f77 2072 6571 7569 7265 7320  n` now requires 
+00035210: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00035220: 2020 2260 6964 656d 706f 7465 6e74 602e    "`idempotent`.
+00035230: 204e 6f74 2069 6e63 6c75 6469 6e67 2060   Not including `
+00035240: 6964 656d 706f 7465 6e74 6020 696e 2074  idempotent` in t
+00035250: 6865 2073 6967 6e61 7475 7265 2077 696c  he signature wil
+00035260: 6c20 6e6f 206c 6f6e 6765 7220 220a 2020  l no longer ".  
+00035270: 2020 2020 2020 2020 2020 2020 2020 2262                "b
+00035280: 6520 7375 7070 6f72 7465 6420 696e 2066  e supported in f
+00035290: 7574 7572 6520 7665 7273 696f 6e73 2e22  uture versions."
+000352a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000352b0: 2020 4675 7475 7265 5761 726e 696e 672c    FutureWarning,
+000352c0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+000352d0: 2020 2020 2020 2020 2020 2069 6465 6d70             idemp
+000352e0: 6f74 656e 7420 3d20 4661 6c73 650a 2020  otent = False.  
+000352f0: 2020 2020 2020 6966 206e 6f74 2069 7369        if not isi
+00035300: 6e73 7461 6e63 6528 706c 7567 696e 2c20  nstance(plugin, 
+00035310: 5363 6865 6475 6c65 7250 6c75 6769 6e29  SchedulerPlugin)
+00035320: 3a0a 2020 2020 2020 2020 2020 2020 706c  :.            pl
+00035330: 7567 696e 203d 206c 6f61 6473 2870 6c75  ugin = loads(plu
+00035340: 6769 6e29 0a20 2020 2020 2020 2020 2020  gin).           
+00035350: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
+00035360: 6365 2870 6c75 6769 6e2c 2053 6368 6564  ce(plugin, Sched
+00035370: 756c 6572 506c 7567 696e 290a 0a20 2020  ulerPlugin)..   
+00035380: 2020 2020 2069 6620 6e61 6d65 2069 7320       if name is 
+00035390: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+000353a0: 2020 6e61 6d65 203d 205f 6765 745f 706c    name = _get_pl
+000353b0: 7567 696e 5f6e 616d 6528 706c 7567 696e  ugin_name(plugin
+000353c0: 290a 0a20 2020 2020 2020 2069 6620 6e61  )..        if na
+000353d0: 6d65 2069 6e20 7365 6c66 2e70 6c75 6769  me in self.plugi
+000353e0: 6e73 2061 6e64 2069 6465 6d70 6f74 656e  ns and idempoten
+000353f0: 743a 0a20 2020 2020 2020 2020 2020 2072  t:.            r
+00035400: 6574 7572 6e0a 0a20 2020 2020 2020 2069  eturn..        i
+00035410: 6620 6861 7361 7474 7228 706c 7567 696e  f hasattr(plugin
+00035420: 2c20 2273 7461 7274 2229 3a0a 2020 2020  , "start"):.    
+00035430: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
+00035440: 2070 6c75 6769 6e2e 7374 6172 7428 7365   plugin.start(se
+00035450: 6c66 290a 2020 2020 2020 2020 2020 2020  lf).            
+00035460: 6966 2069 6e73 7065 6374 2e69 7361 7761  if inspect.isawa
+00035470: 6974 6162 6c65 2872 6573 756c 7429 3a0a  itable(result):.
+00035480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035490: 6177 6169 7420 7265 7375 6c74 0a0a 2020  await result..  
+000354a0: 2020 2020 2020 7365 6c66 2e61 6464 5f70        self.add_p
+000354b0: 6c75 6769 6e28 706c 7567 696e 2c20 6e61  lugin(plugin, na
+000354c0: 6d65 3d6e 616d 652c 2069 6465 6d70 6f74  me=name, idempot
+000354d0: 656e 743d 6964 656d 706f 7465 6e74 290a  ent=idempotent).
+000354e0: 0a20 2020 2061 7379 6e63 2064 6566 2075  .    async def u
+000354f0: 6e72 6567 6973 7465 725f 7363 6865 6475  nregister_schedu
+00035500: 6c65 725f 706c 7567 696e 2873 656c 662c  ler_plugin(self,
+00035510: 206e 616d 653a 2073 7472 2920 2d3e 204e   name: str) -> N
+00035520: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
+00035530: 556e 7265 6769 7374 6572 2061 2070 6c75  Unregister a plu
+00035540: 6769 6e20 6f6e 2074 6865 2073 6368 6564  gin on the sched
+00035550: 756c 6572 2e22 2222 0a20 2020 2020 2020  uler.""".       
+00035560: 2073 656c 662e 7265 6d6f 7665 5f70 6c75   self.remove_plu
+00035570: 6769 6e28 6e61 6d65 290a 0a20 2020 2064  gin(name)..    d
+00035580: 6566 2077 6f72 6b65 725f 7365 6e64 2873  ef worker_send(s
+00035590: 656c 662c 2077 6f72 6b65 723a 2073 7472  elf, worker: str
+000355a0: 2c20 6d73 673a 2064 6963 745b 7374 722c  , msg: dict[str,
+000355b0: 2041 6e79 5d29 202d 3e20 4e6f 6e65 3a0a   Any]) -> None:.
+000355c0: 2020 2020 2020 2020 2222 2253 656e 6420          """Send 
+000355d0: 6d65 7373 6167 6520 746f 2077 6f72 6b65  message to worke
+000355e0: 720a 0a20 2020 2020 2020 2054 6869 7320  r..        This 
+000355f0: 616c 736f 2068 616e 646c 6573 2063 6f6e  also handles con
+00035600: 6e65 6374 696f 6e20 6661 696c 7572 6573  nection failures
+00035610: 2062 7920 6164 6469 6e67 2061 2063 616c   by adding a cal
+00035620: 6c62 6163 6b20 746f 2072 656d 6f76 650a  lback to remove.
+00035630: 2020 2020 2020 2020 7468 6520 776f 726b          the work
+00035640: 6572 206f 6e20 7468 6520 6e65 7874 2063  er on the next c
+00035650: 7963 6c65 2e0a 2020 2020 2020 2020 2222  ycle..        ""
+00035660: 220a 2020 2020 2020 2020 7472 793a 0a20  ".        try:. 
+00035670: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00035680: 7374 7265 616d 5f63 6f6d 6d73 5b77 6f72  stream_comms[wor
+00035690: 6b65 725d 2e73 656e 6428 6d73 6729 0a20  ker].send(msg). 
+000356a0: 2020 2020 2020 2065 7863 6570 7420 2843         except (C
+000356b0: 6f6d 6d43 6c6f 7365 6445 7272 6f72 2c20  ommClosedError, 
+000356c0: 4174 7472 6962 7574 6545 7272 6f72 293a  AttributeError):
+000356d0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000356e0: 662e 5f6f 6e67 6f69 6e67 5f62 6163 6b67  f._ongoing_backg
+000356f0: 726f 756e 645f 7461 736b 732e 6361 6c6c  round_tasks.call
+00035700: 5f73 6f6f 6e28 0a20 2020 2020 2020 2020  _soon(.         
+00035710: 2020 2020 2020 2073 656c 662e 7265 6d6f         self.remo
+00035720: 7665 5f77 6f72 6b65 722c 2020 2320 7479  ve_worker,  # ty
+00035730: 7065 3a20 6967 6e6f 7265 5b61 7267 2d74  pe: ignore[arg-t
+00035740: 7970 655d 0a20 2020 2020 2020 2020 2020  ype].           
+00035750: 2020 2020 2061 6464 7265 7373 3d77 6f72       address=wor
+00035760: 6b65 722c 0a20 2020 2020 2020 2020 2020  ker,.           
+00035770: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
+00035780: 3d66 2277 6f72 6b65 722d 7365 6e64 2d63  =f"worker-send-c
+00035790: 6f6d 6d2d 6661 696c 2d7b 7469 6d65 2829  omm-fail-{time()
+000357a0: 7d22 2c0a 2020 2020 2020 2020 2020 2020  }",.            
+000357b0: 290a 0a20 2020 2064 6566 2063 6c69 656e  )..    def clien
+000357c0: 745f 7365 6e64 2873 656c 662c 2063 6c69  t_send(self, cli
+000357d0: 656e 742c 206d 7367 293a 0a20 2020 2020  ent, msg):.     
+000357e0: 2020 2022 2222 5365 6e64 206d 6573 7361     """Send messa
+000357f0: 6765 2074 6f20 636c 6965 6e74 2222 220a  ge to client""".
+00035800: 2020 2020 2020 2020 6320 3d20 7365 6c66          c = self
+00035810: 2e63 6c69 656e 745f 636f 6d6d 732e 6765  .client_comms.ge
+00035820: 7428 636c 6965 6e74 290a 2020 2020 2020  t(client).      
+00035830: 2020 6966 2063 2069 7320 4e6f 6e65 3a0a    if c is None:.
+00035840: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00035850: 726e 0a20 2020 2020 2020 2074 7279 3a0a  rn.        try:.
+00035860: 2020 2020 2020 2020 2020 2020 632e 7365              c.se
+00035870: 6e64 286d 7367 290a 2020 2020 2020 2020  nd(msg).        
+00035880: 6578 6365 7074 2043 6f6d 6d43 6c6f 7365  except CommClose
+00035890: 6445 7272 6f72 3a0a 2020 2020 2020 2020  dError:.        
+000358a0: 2020 2020 6966 2073 656c 662e 7374 6174      if self.stat
+000358b0: 7573 203d 3d20 5374 6174 7573 2e72 756e  us == Status.run
+000358c0: 6e69 6e67 3a0a 2020 2020 2020 2020 2020  ning:.          
+000358d0: 2020 2020 2020 6c6f 6767 6572 2e63 7269        logger.cri
+000358e0: 7469 6361 6c28 0a20 2020 2020 2020 2020  tical(.         
+000358f0: 2020 2020 2020 2020 2020 2022 436c 6f73             "Clos
+00035900: 6564 2063 6f6d 6d20 2572 2077 6869 6c65  ed comm %r while
+00035910: 2074 7279 696e 6720 746f 2077 7269 7465   trying to write
+00035920: 2025 7322 2c20 632c 206d 7367 2c20 6578   %s", c, msg, ex
+00035930: 635f 696e 666f 3d54 7275 650a 2020 2020  c_info=True.    
+00035940: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+00035950: 2020 2064 6566 2073 656e 645f 616c 6c28     def send_all(
+00035960: 7365 6c66 2c20 636c 6965 6e74 5f6d 7367  self, client_msg
+00035970: 733a 204d 7367 732c 2077 6f72 6b65 725f  s: Msgs, worker_
+00035980: 6d73 6773 3a20 4d73 6773 2920 2d3e 204e  msgs: Msgs) -> N
+00035990: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
+000359a0: 5365 6e64 206d 6573 7361 6765 7320 746f  Send messages to
+000359b0: 2063 6c69 656e 7420 616e 6420 776f 726b   client and work
+000359c0: 6572 7322 2222 0a0a 2020 2020 2020 2020  ers"""..        
+000359d0: 666f 7220 636c 6965 6e74 2c20 6d73 6773  for client, msgs
+000359e0: 2069 6e20 636c 6965 6e74 5f6d 7367 732e   in client_msgs.
+000359f0: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
+00035a00: 2020 2020 2063 203d 2073 656c 662e 636c       c = self.cl
+00035a10: 6965 6e74 5f63 6f6d 6d73 2e67 6574 2863  ient_comms.get(c
+00035a20: 6c69 656e 7429 0a20 2020 2020 2020 2020  lient).         
+00035a30: 2020 2069 6620 6320 6973 204e 6f6e 653a     if c is None:
+00035a40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00035a50: 2063 6f6e 7469 6e75 650a 2020 2020 2020   continue.      
+00035a60: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00035a70: 2020 2020 2020 2020 2020 2063 2e73 656e             c.sen
+00035a80: 6428 2a6d 7367 7329 0a20 2020 2020 2020  d(*msgs).       
+00035a90: 2020 2020 2065 7863 6570 7420 436f 6d6d       except Comm
+00035aa0: 436c 6f73 6564 4572 726f 723a 0a20 2020  ClosedError:.   
+00035ab0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00035ac0: 7365 6c66 2e73 7461 7475 7320 3d3d 2053  self.status == S
+00035ad0: 7461 7475 732e 7275 6e6e 696e 673a 0a20  tatus.running:. 
+00035ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035af0: 2020 206c 6f67 6765 722e 6372 6974 6963     logger.critic
+00035b00: 616c 280a 2020 2020 2020 2020 2020 2020  al(.            
+00035b10: 2020 2020 2020 2020 2020 2020 2243 6c6f              "Clo
+00035b20: 7365 6420 636f 6d6d 2025 7220 7768 696c  sed comm %r whil
+00035b30: 6520 7472 7969 6e67 2074 6f20 7772 6974  e trying to writ
+00035b40: 6520 2573 222c 0a20 2020 2020 2020 2020  e %s",.         
+00035b50: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00035b60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00035b70: 2020 2020 2020 2020 2020 6d73 6773 2c0a            msgs,.
+00035b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035b90: 2020 2020 2020 2020 6578 635f 696e 666f          exc_info
+00035ba0: 3d54 7275 652c 0a20 2020 2020 2020 2020  =True,.         
+00035bb0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00035bc0: 2020 2020 2020 666f 7220 776f 726b 6572        for worker
+00035bd0: 2c20 6d73 6773 2069 6e20 776f 726b 6572  , msgs in worker
+00035be0: 5f6d 7367 732e 6974 656d 7328 293a 0a20  _msgs.items():. 
+00035bf0: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+00035c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035c10: 7720 3d20 7365 6c66 2e73 7472 6561 6d5f  w = self.stream_
+00035c20: 636f 6d6d 735b 776f 726b 6572 5d0a 2020  comms[worker].  
+00035c30: 2020 2020 2020 2020 2020 2020 2020 772e                w.
+00035c40: 7365 6e64 282a 6d73 6773 290a 2020 2020  send(*msgs).    
+00035c50: 2020 2020 2020 2020 6578 6365 7074 204b          except K
+00035c60: 6579 4572 726f 723a 0a20 2020 2020 2020  eyError:.       
+00035c70: 2020 2020 2020 2020 2023 2077 6f72 6b65           # worke
+00035c80: 7220 616c 7265 6164 7920 676f 6e65 0a20  r already gone. 
+00035c90: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00035ca0: 6173 730a 2020 2020 2020 2020 2020 2020  ass.            
+00035cb0: 6578 6365 7074 2028 436f 6d6d 436c 6f73  except (CommClos
+00035cc0: 6564 4572 726f 722c 2041 7474 7269 6275  edError, Attribu
+00035cd0: 7465 4572 726f 7229 3a0a 2020 2020 2020  teError):.      
+00035ce0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00035cf0: 6f6e 676f 696e 675f 6261 636b 6772 6f75  ongoing_backgrou
+00035d00: 6e64 5f74 6173 6b73 2e63 616c 6c5f 736f  nd_tasks.call_so
+00035d10: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
+00035d20: 2020 2020 2020 2020 7365 6c66 2e72 656d          self.rem
+00035d30: 6f76 655f 776f 726b 6572 2c20 2023 2074  ove_worker,  # t
+00035d40: 7970 653a 2069 676e 6f72 655b 6172 672d  ype: ignore[arg-
+00035d50: 7479 7065 5d0a 2020 2020 2020 2020 2020  type].          
+00035d60: 2020 2020 2020 2020 2020 6164 6472 6573            addres
+00035d70: 733d 776f 726b 6572 2c0a 2020 2020 2020  s=worker,.      
+00035d80: 2020 2020 2020 2020 2020 2020 2020 7374                st
+00035d90: 696d 756c 7573 5f69 643d 6622 7365 6e64  imulus_id=f"send
+00035da0: 2d61 6c6c 2d63 6f6d 6d2d 6661 696c 2d7b  -all-comm-fail-{
+00035db0: 7469 6d65 2829 7d22 2c0a 2020 2020 2020  time()}",.      
+00035dc0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+00035dd0: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
+00035de0: 2323 2323 2323 2323 2323 2323 230a 2020  #############.  
+00035df0: 2020 2320 4c65 7373 2063 6f6d 6d6f 6e20    # Less common 
+00035e00: 696e 7465 7261 6374 696f 6e73 2023 0a20  interactions #. 
+00035e10: 2020 2023 2323 2323 2323 2323 2323 2323     #############
+00035e20: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
+00035e30: 0a20 2020 2061 7379 6e63 2064 6566 2073  .    async def s
+00035e40: 6361 7474 6572 280a 2020 2020 2020 2020  catter(.        
+00035e50: 7365 6c66 2c0a 2020 2020 2020 2020 636f  self,.        co
+00035e60: 6d6d 3d4e 6f6e 652c 0a20 2020 2020 2020  mm=None,.       
+00035e70: 2064 6174 613d 4e6f 6e65 2c0a 2020 2020   data=None,.    
+00035e80: 2020 2020 776f 726b 6572 733d 4e6f 6e65      workers=None
+00035e90: 2c0a 2020 2020 2020 2020 636c 6965 6e74  ,.        client
+00035ea0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2062  =None,.        b
+00035eb0: 726f 6164 6361 7374 3d46 616c 7365 2c0a  roadcast=False,.
+00035ec0: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
+00035ed0: 322c 0a20 2020 2029 3a0a 2020 2020 2020  2,.    ):.      
+00035ee0: 2020 2222 2253 656e 6420 6461 7461 206f    """Send data o
+00035ef0: 7574 2074 6f20 776f 726b 6572 730a 0a20  ut to workers.. 
+00035f00: 2020 2020 2020 2053 6565 2061 6c73 6f0a         See also.
+00035f10: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
+00035f20: 0a20 2020 2020 2020 2053 6368 6564 756c  .        Schedul
+00035f30: 6572 2e62 726f 6164 6361 7374 3a0a 2020  er.broadcast:.  
+00035f40: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00035f50: 2020 7374 6172 7420 3d20 7469 6d65 2829    start = time()
+00035f60: 0a20 2020 2020 2020 2077 6869 6c65 2054  .        while T
+00035f70: 7275 653a 0a20 2020 2020 2020 2020 2020  rue:.           
+00035f80: 2069 6620 776f 726b 6572 7320 6973 204e   if workers is N
+00035f90: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00035fa0: 2020 2020 2077 7373 203d 2073 656c 662e       wss = self.
+00035fb0: 7275 6e6e 696e 670a 2020 2020 2020 2020  running.        
+00035fc0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00035fd0: 2020 2020 2020 2020 2020 776f 726b 6572            worker
+00035fe0: 7320 3d20 5b73 656c 662e 636f 6572 6365  s = [self.coerce
+00035ff0: 5f61 6464 7265 7373 2877 2920 666f 7220  _address(w) for 
+00036000: 7720 696e 2077 6f72 6b65 7273 5d0a 2020  w in workers].  
+00036010: 2020 2020 2020 2020 2020 2020 2020 7773                ws
+00036020: 7320 3d20 7b73 656c 662e 776f 726b 6572  s = {self.worker
+00036030: 735b 775d 2066 6f72 2077 2069 6e20 776f  s[w] for w in wo
+00036040: 726b 6572 737d 0a20 2020 2020 2020 2020  rkers}.         
+00036050: 2020 2020 2020 2077 7373 203d 207b 7773         wss = {ws
+00036060: 2066 6f72 2077 7320 696e 2077 7373 2069   for ws in wss i
+00036070: 6620 7773 2e73 7461 7475 7320 3d3d 2053  f ws.status == S
+00036080: 7461 7475 732e 7275 6e6e 696e 677d 0a0a  tatus.running}..
+00036090: 2020 2020 2020 2020 2020 2020 6966 2077              if w
+000360a0: 7373 3a0a 2020 2020 2020 2020 2020 2020  ss:.            
+000360b0: 2020 2020 6272 6561 6b0a 2020 2020 2020      break.      
+000360c0: 2020 2020 2020 6966 2074 696d 6528 2920        if time() 
+000360d0: 3e20 7374 6172 7420 2b20 7469 6d65 6f75  > start + timeou
+000360e0: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+000360f0: 2020 2072 6169 7365 2054 696d 656f 7574     raise Timeout
+00036100: 4572 726f 7228 224e 6f20 7661 6c69 6420  Error("No valid 
+00036110: 776f 726b 6572 7320 666f 756e 6422 290a  workers found").
+00036120: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+00036130: 7420 6173 796e 6369 6f2e 736c 6565 7028  t asyncio.sleep(
+00036140: 302e 3129 0a0a 2020 2020 2020 2020 6173  0.1)..        as
+00036150: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
+00036160: 6461 7461 2c20 6469 6374 290a 0a20 2020  data, dict)..   
+00036170: 2020 2020 2077 6f72 6b65 7273 203d 206c       workers = l
+00036180: 6973 7428 7773 2e61 6464 7265 7373 2066  ist(ws.address f
+00036190: 6f72 2077 7320 696e 2077 7373 290a 2020  or ws in wss).  
+000361a0: 2020 2020 2020 6b65 7973 2c20 7768 6f5f        keys, who_
+000361b0: 6861 732c 206e 6279 7465 7320 3d20 6177  has, nbytes = aw
+000361c0: 6169 7420 7363 6174 7465 725f 746f 5f77  ait scatter_to_w
+000361d0: 6f72 6b65 7273 2877 6f72 6b65 7273 2c20  orkers(workers, 
+000361e0: 6461 7461 2c20 7270 633d 7365 6c66 2e72  data, rpc=self.r
+000361f0: 7063 290a 0a20 2020 2020 2020 2073 656c  pc)..        sel
+00036200: 662e 7570 6461 7465 5f64 6174 6128 7768  f.update_data(wh
+00036210: 6f5f 6861 733d 7768 6f5f 6861 732c 206e  o_has=who_has, n
+00036220: 6279 7465 733d 6e62 7974 6573 2c20 636c  bytes=nbytes, cl
+00036230: 6965 6e74 3d63 6c69 656e 7429 0a0a 2020  ient=client)..  
+00036240: 2020 2020 2020 6966 2062 726f 6164 6361        if broadca
+00036250: 7374 3a0a 2020 2020 2020 2020 2020 2020  st:.            
+00036260: 6e20 3d20 6c65 6e28 776f 726b 6572 7329  n = len(workers)
+00036270: 2069 6620 6272 6f61 6463 6173 7420 6973   if broadcast is
+00036280: 2054 7275 6520 656c 7365 2062 726f 6164   True else broad
+00036290: 6361 7374 0a20 2020 2020 2020 2020 2020  cast.           
+000362a0: 2061 7761 6974 2073 656c 662e 7265 706c   await self.repl
+000362b0: 6963 6174 6528 6b65 7973 3d6b 6579 732c  icate(keys=keys,
+000362c0: 2077 6f72 6b65 7273 3d77 6f72 6b65 7273   workers=workers
+000362d0: 2c20 6e3d 6e29 0a0a 2020 2020 2020 2020  , n=n)..        
+000362e0: 7365 6c66 2e6c 6f67 5f65 7665 6e74 280a  self.log_event(.
+000362f0: 2020 2020 2020 2020 2020 2020 5b63 6c69              [cli
+00036300: 656e 742c 2022 616c 6c22 5d2c 207b 2261  ent, "all"], {"a
+00036310: 6374 696f 6e22 3a20 2273 6361 7474 6572  ction": "scatter
+00036320: 222c 2022 636c 6965 6e74 223a 2063 6c69  ", "client": cli
+00036330: 656e 742c 2022 636f 756e 7422 3a20 6c65  ent, "count": le
+00036340: 6e28 6461 7461 297d 0a20 2020 2020 2020  n(data)}.       
+00036350: 2029 0a20 2020 2020 2020 2072 6574 7572   ).        retur
+00036360: 6e20 6b65 7973 0a0a 2020 2020 6173 796e  n keys..    asyn
+00036370: 6320 6465 6620 6761 7468 6572 280a 2020  c def gather(.  
+00036380: 2020 2020 2020 7365 6c66 2c20 6b65 7973        self, keys
+00036390: 3a20 436f 6c6c 6563 7469 6f6e 5b4b 6579  : Collection[Key
+000363a0: 5d2c 2073 6572 6961 6c69 7a65 7273 3a20  ], serializers: 
+000363b0: 6c69 7374 5b73 7472 5d20 7c20 4e6f 6e65  list[str] | None
+000363c0: 203d 204e 6f6e 650a 2020 2020 2920 2d3e   = None.    ) ->
+000363d0: 2064 6963 745b 4b65 792c 206f 626a 6563   dict[Key, objec
+000363e0: 745d 3a0a 2020 2020 2020 2020 2222 2243  t]:.        """C
+000363f0: 6f6c 6c65 6374 2064 6174 6120 6672 6f6d  ollect data from
+00036400: 2077 6f72 6b65 7273 2074 6f20 7468 6520   workers to the 
+00036410: 7363 6865 6475 6c65 7222 2222 0a20 2020  scheduler""".   
+00036420: 2020 2020 2064 6174 6120 3d20 7b7d 0a20       data = {}. 
+00036430: 2020 2020 2020 206d 6973 7369 6e67 5f6b         missing_k
+00036440: 6579 7320 3d20 6c69 7374 286b 6579 7329  eys = list(keys)
+00036450: 0a20 2020 2020 2020 2066 6169 6c65 645f  .        failed_
+00036460: 6b65 7973 3a20 6c69 7374 5b4b 6579 5d20  keys: list[Key] 
+00036470: 3d20 5b5d 0a20 2020 2020 2020 206d 6973  = [].        mis
+00036480: 7369 6e67 5f77 6f72 6b65 7273 3a20 7365  sing_workers: se
+00036490: 745b 7374 725d 203d 2073 6574 2829 0a0a  t[str] = set()..
+000364a0: 2020 2020 2020 2020 7768 696c 6520 6d69          while mi
+000364b0: 7373 696e 675f 6b65 7973 3a0a 2020 2020  ssing_keys:.    
+000364c0: 2020 2020 2020 2020 7768 6f5f 6861 7320          who_has 
+000364d0: 3d20 7b7d 0a20 2020 2020 2020 2020 2020  = {}.           
+000364e0: 2066 6f72 206b 6579 2c20 776f 726b 6572   for key, worker
+000364f0: 7320 696e 2073 656c 662e 6765 745f 7768  s in self.get_wh
+00036500: 6f5f 6861 7328 6d69 7373 696e 675f 6b65  o_has(missing_ke
+00036510: 7973 292e 6974 656d 7328 293a 0a20 2020  ys).items():.   
+00036520: 2020 2020 2020 2020 2020 2020 2076 616c               val
+00036530: 6964 5f77 6f72 6b65 7273 203d 2073 6574  id_workers = set
+00036540: 2877 6f72 6b65 7273 2920 2d20 6d69 7373  (workers) - miss
+00036550: 696e 675f 776f 726b 6572 730a 2020 2020  ing_workers.    
+00036560: 2020 2020 2020 2020 2020 2020 6966 2076              if v
+00036570: 616c 6964 5f77 6f72 6b65 7273 3a0a 2020  alid_workers:.  
+00036580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036590: 2020 7768 6f5f 6861 735b 6b65 795d 203d    who_has[key] =
+000365a0: 2076 616c 6964 5f77 6f72 6b65 7273 0a20   valid_workers. 
+000365b0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+000365c0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+000365d0: 2020 2020 2020 2020 2066 6169 6c65 645f           failed_
+000365e0: 6b65 7973 2e61 7070 656e 6428 6b65 7929  keys.append(key)
+000365f0: 0a0a 2020 2020 2020 2020 2020 2020 280a  ..            (.
+00036600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036610: 6e65 775f 6461 7461 2c0a 2020 2020 2020  new_data,.      
+00036620: 2020 2020 2020 2020 2020 6d69 7373 696e            missin
+00036630: 675f 6b65 7973 2c0a 2020 2020 2020 2020  g_keys,.        
+00036640: 2020 2020 2020 2020 6e65 775f 6661 696c          new_fail
+00036650: 6564 5f6b 6579 732c 0a20 2020 2020 2020  ed_keys,.       
+00036660: 2020 2020 2020 2020 206e 6577 5f6d 6973           new_mis
+00036670: 7369 6e67 5f77 6f72 6b65 7273 2c0a 2020  sing_workers,.  
+00036680: 2020 2020 2020 2020 2020 2920 3d20 6177            ) = aw
+00036690: 6169 7420 6761 7468 6572 5f66 726f 6d5f  ait gather_from_
+000366a0: 776f 726b 6572 7328 0a20 2020 2020 2020  workers(.       
+000366b0: 2020 2020 2020 2020 2077 686f 5f68 6173           who_has
+000366c0: 2c20 7270 633d 7365 6c66 2e72 7063 2c20  , rpc=self.rpc, 
+000366d0: 7365 7269 616c 697a 6572 733d 7365 7269  serializers=seri
+000366e0: 616c 697a 6572 730a 2020 2020 2020 2020  alizers.        
+000366f0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00036700: 2020 6461 7461 2e75 7064 6174 6528 6e65    data.update(ne
+00036710: 775f 6461 7461 290a 2020 2020 2020 2020  w_data).        
+00036720: 2020 2020 6661 696c 6564 5f6b 6579 7320      failed_keys 
+00036730: 2b3d 206e 6577 5f66 6169 6c65 645f 6b65  += new_failed_ke
+00036740: 7973 0a20 2020 2020 2020 2020 2020 206d  ys.            m
+00036750: 6973 7369 6e67 5f77 6f72 6b65 7273 2e75  issing_workers.u
+00036760: 7064 6174 6528 6e65 775f 6d69 7373 696e  pdate(new_missin
+00036770: 675f 776f 726b 6572 7329 0a0a 2020 2020  g_workers)..    
+00036780: 2020 2020 7365 6c66 2e6c 6f67 5f65 7665      self.log_eve
+00036790: 6e74 2822 616c 6c22 2c20 7b22 6163 7469  nt("all", {"acti
+000367a0: 6f6e 223a 2022 6761 7468 6572 222c 2022  on": "gather", "
+000367b0: 636f 756e 7422 3a20 6c65 6e28 6b65 7973  count": len(keys
+000367c0: 297d 290a 0a20 2020 2020 2020 2069 6620  )})..        if 
+000367d0: 6e6f 7420 6661 696c 6564 5f6b 6579 733a  not failed_keys:
+000367e0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+000367f0: 7572 6e20 7b22 7374 6174 7573 223a 2022  urn {"status": "
+00036800: 4f4b 222c 2022 6461 7461 223a 2064 6174  OK", "data": dat
+00036810: 617d 0a0a 2020 2020 2020 2020 6661 696c  a}..        fail
+00036820: 6564 5f73 7461 7465 7320 3d20 7b0a 2020  ed_states = {.  
+00036830: 2020 2020 2020 2020 2020 6b65 793a 2073            key: s
+00036840: 656c 662e 7461 736b 735b 6b65 795d 2e73  elf.tasks[key].s
+00036850: 7461 7465 2069 6620 6b65 7920 696e 2073  tate if key in s
+00036860: 656c 662e 7461 736b 7320 656c 7365 2022  elf.tasks else "
+00036870: 666f 7267 6f74 7465 6e22 0a20 2020 2020  forgotten".     
+00036880: 2020 2020 2020 2066 6f72 206b 6579 2069         for key i
+00036890: 6e20 6661 696c 6564 5f6b 6579 730a 2020  n failed_keys.  
+000368a0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+000368b0: 6c6f 6767 6572 2e65 7272 6f72 2822 436f  logger.error("Co
+000368c0: 756c 646e 2774 2067 6174 6865 7220 6b65  uldn't gather ke
+000368d0: 7973 3a20 2573 222c 2066 6169 6c65 645f  ys: %s", failed_
+000368e0: 7374 6174 6573 290a 2020 2020 2020 2020  states).        
+000368f0: 7265 7475 726e 207b 2273 7461 7475 7322  return {"status"
+00036900: 3a20 2265 7272 6f72 222c 2022 6b65 7973  : "error", "keys
+00036910: 223a 206c 6973 7428 6661 696c 6564 5f6b  ": list(failed_k
+00036920: 6579 7329 7d0a 0a20 2020 2040 6c6f 675f  eys)}..    @log_
+00036930: 6572 726f 7273 0a20 2020 2061 7379 6e63  errors.    async
+00036940: 2064 6566 2072 6573 7461 7274 280a 2020   def restart(.  
+00036950: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+00036960: 2020 2020 2a2c 0a20 2020 2020 2020 2063      *,.        c
+00036970: 6c69 656e 743a 2073 7472 207c 204e 6f6e  lient: str | Non
+00036980: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
+00036990: 2020 7469 6d65 6f75 743a 2066 6c6f 6174    timeout: float
+000369a0: 203d 2033 302c 0a20 2020 2020 2020 2077   = 30,.        w
+000369b0: 6169 745f 666f 725f 776f 726b 6572 733a  ait_for_workers:
+000369c0: 2062 6f6f 6c20 3d20 5472 7565 2c0a 2020   bool = True,.  
+000369d0: 2020 2020 2020 7374 696d 756c 7573 5f69        stimulus_i
+000369e0: 643a 2073 7472 2c0a 2020 2020 2920 2d3e  d: str,.    ) ->
+000369f0: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
+00036a00: 2222 466f 7267 6574 2061 6c6c 2074 6173  ""Forget all tas
+00036a10: 6b73 2061 6e64 2063 616c 6c20 7265 7374  ks and call rest
+00036a20: 6172 745f 776f 726b 6572 7320 6f6e 2061  art_workers on a
+00036a30: 6c6c 2077 6f72 6b65 7273 2e0a 0a20 2020  ll workers...   
+00036a40: 2020 2020 2050 6172 616d 6574 6572 730a       Parameters.
+00036a50: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
+00036a60: 2d2d 0a20 2020 2020 2020 2074 696d 656f  --.        timeo
+00036a70: 7574 3a0a 2020 2020 2020 2020 2020 2020  ut:.            
+00036a80: 5365 6520 7265 7374 6172 745f 776f 726b  See restart_work
+00036a90: 6572 730a 2020 2020 2020 2020 7761 6974  ers.        wait
+00036aa0: 5f66 6f72 5f77 6f72 6b65 7273 3a0a 2020  _for_workers:.  
+00036ab0: 2020 2020 2020 2020 2020 5365 6520 7265            See re
+00036ac0: 7374 6172 745f 776f 726b 6572 730a 0a20  start_workers.. 
+00036ad0: 2020 2020 2020 2053 6565 2061 6c73 6f0a         See also.
+00036ae0: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
+00036af0: 0a20 2020 2020 2020 2043 6c69 656e 742e  .        Client.
+00036b00: 7265 7374 6172 740a 2020 2020 2020 2020  restart.        
+00036b10: 436c 6965 6e74 2e72 6573 7461 7274 5f77  Client.restart_w
+00036b20: 6f72 6b65 7273 0a20 2020 2020 2020 2053  orkers.        S
+00036b30: 6368 6564 756c 6572 2e72 6573 7461 7274  cheduler.restart
+00036b40: 5f77 6f72 6b65 7273 0a20 2020 2020 2020  _workers.       
+00036b50: 2022 2222 0a20 2020 2020 2020 206c 6f67   """.        log
+00036b60: 6765 722e 696e 666f 2866 2252 6573 7461  ger.info(f"Resta
+00036b70: 7274 696e 6720 776f 726b 6572 7320 616e  rting workers an
+00036b80: 6420 7265 6c65 6173 696e 6720 616c 6c20  d releasing all 
+00036b90: 6b65 7973 2028 7b73 7469 6d75 6c75 735f  keys ({stimulus_
+00036ba0: 6964 3d7d 2922 290a 2020 2020 2020 2020  id=})").        
+00036bb0: 666f 7220 6373 2069 6e20 7365 6c66 2e63  for cs in self.c
+00036bc0: 6c69 656e 7473 2e76 616c 7565 7328 293a  lients.values():
+00036bd0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00036be0: 662e 636c 6965 6e74 5f72 656c 6561 7365  f.client_release
+00036bf0: 735f 6b65 7973 280a 2020 2020 2020 2020  s_keys(.        
+00036c00: 2020 2020 2020 2020 6b65 7973 3d5b 7473          keys=[ts
+00036c10: 2e6b 6579 2066 6f72 2074 7320 696e 2063  .key for ts in c
+00036c20: 732e 7761 6e74 735f 7768 6174 5d2c 0a20  s.wants_what],. 
+00036c30: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00036c40: 6c69 656e 743d 6373 2e63 6c69 656e 745f  lient=cs.client_
+00036c50: 6b65 792c 0a20 2020 2020 2020 2020 2020  key,.           
+00036c60: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
+00036c70: 3d73 7469 6d75 6c75 735f 6964 2c0a 2020  =stimulus_id,.  
+00036c80: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+00036c90: 2020 2020 2073 656c 662e 5f63 6c65 6172       self._clear
+00036ca0: 5f74 6173 6b5f 7374 6174 6528 290a 2020  _task_state().  
+00036cb0: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
+00036cc0: 2073 656c 662e 7461 736b 730a 2020 2020   self.tasks.    
+00036cd0: 2020 2020 7365 6c66 2e72 6570 6f72 7428      self.report(
+00036ce0: 7b22 6f70 223a 2022 7265 7374 6172 7422  {"op": "restart"
+00036cf0: 7d29 0a0a 2020 2020 2020 2020 666f 7220  })..        for 
+00036d00: 706c 7567 696e 2069 6e20 6c69 7374 2873  plugin in list(s
+00036d10: 656c 662e 706c 7567 696e 732e 7661 6c75  elf.plugins.valu
+00036d20: 6573 2829 293a 0a20 2020 2020 2020 2020  es()):.         
+00036d30: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00036d40: 2020 2020 2020 2020 706c 7567 696e 2e72          plugin.r
+00036d50: 6573 7461 7274 2873 656c 6629 0a20 2020  estart(self).   
+00036d60: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+00036d70: 4578 6365 7074 696f 6e20 6173 2065 3a0a  Exception as e:.
+00036d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036d90: 6c6f 6767 6572 2e65 7863 6570 7469 6f6e  logger.exception
+00036da0: 2865 290a 0a20 2020 2020 2020 2061 7761  (e)..        awa
+00036db0: 6974 2073 656c 662e 7265 7374 6172 745f  it self.restart_
+00036dc0: 776f 726b 6572 7328 0a20 2020 2020 2020  workers(.       
+00036dd0: 2020 2020 2063 6c69 656e 743d 636c 6965       client=clie
+00036de0: 6e74 2c0a 2020 2020 2020 2020 2020 2020  nt,.            
+00036df0: 7469 6d65 6f75 743d 7469 6d65 6f75 742c  timeout=timeout,
+00036e00: 0a20 2020 2020 2020 2020 2020 2077 6169  .            wai
+00036e10: 745f 666f 725f 776f 726b 6572 733d 7761  t_for_workers=wa
+00036e20: 6974 5f66 6f72 5f77 6f72 6b65 7273 2c0a  it_for_workers,.
+00036e30: 2020 2020 2020 2020 2020 2020 7374 696d              stim
+00036e40: 756c 7573 5f69 643d 7374 696d 756c 7573  ulus_id=stimulus
+00036e50: 5f69 642c 0a20 2020 2020 2020 2029 0a0a  _id,.        )..
+00036e60: 2020 2020 406c 6f67 5f65 7272 6f72 730a      @log_errors.
+00036e70: 2020 2020 6173 796e 6320 6465 6620 7265      async def re
+00036e80: 7374 6172 745f 776f 726b 6572 7328 0a20  start_workers(. 
+00036e90: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+00036ea0: 2020 2020 2077 6f72 6b65 7273 3a20 6c69       workers: li
+00036eb0: 7374 5b73 7472 5d20 7c20 4e6f 6e65 203d  st[str] | None =
+00036ec0: 204e 6f6e 652c 0a20 2020 2020 2020 202a   None,.        *
+00036ed0: 2c0a 2020 2020 2020 2020 636c 6965 6e74  ,.        client
+00036ee0: 3a20 7374 7220 7c20 4e6f 6e65 203d 204e  : str | None = N
+00036ef0: 6f6e 652c 0a20 2020 2020 2020 2074 696d  one,.        tim
+00036f00: 656f 7574 3a20 666c 6f61 7420 3d20 3330  eout: float = 30
+00036f10: 2c0a 2020 2020 2020 2020 7761 6974 5f66  ,.        wait_f
+00036f20: 6f72 5f77 6f72 6b65 7273 3a20 626f 6f6c  or_workers: bool
+00036f30: 203d 2054 7275 652c 0a20 2020 2020 2020   = True,.       
+00036f40: 206f 6e5f 6572 726f 723a 204c 6974 6572   on_error: Liter
+00036f50: 616c 5b22 7261 6973 6522 2c20 2272 6574  al["raise", "ret
+00036f60: 7572 6e22 5d20 3d20 2272 6169 7365 222c  urn"] = "raise",
+00036f70: 0a20 2020 2020 2020 2073 7469 6d75 6c75  .        stimulu
+00036f80: 735f 6964 3a20 7374 722c 0a20 2020 2029  s_id: str,.    )
+00036f90: 202d 3e20 6469 6374 5b73 7472 2c20 4c69   -> dict[str, Li
+00036fa0: 7465 7261 6c5b 224f 4b22 2c20 2272 656d  teral["OK", "rem
+00036fb0: 6f76 6564 222c 2022 7469 6d65 6420 6f75  oved", "timed ou
+00036fc0: 7422 5d5d 3a0a 2020 2020 2020 2020 2222  t"]]:.        ""
+00036fd0: 2252 6573 7461 7274 2073 656c 6563 7465  "Restart selecte
+00036fe0: 6420 776f 726b 6572 732e 204f 7074 696f  d workers. Optio
+00036ff0: 6e61 6c6c 7920 7761 6974 2066 6f72 2077  nally wait for w
+00037000: 6f72 6b65 7273 2074 6f20 7265 7475 726e  orkers to return
+00037010: 2e0a 0a20 2020 2020 2020 2057 6f72 6b65  ...        Worke
+00037020: 7273 2077 6974 686f 7574 206e 616e 6e69  rs without nanni
+00037030: 6573 2061 7265 2073 6875 7420 646f 776e  es are shut down
+00037040: 2c20 686f 7069 6e67 2061 6e20 6578 7465  , hoping an exte
+00037050: 726e 616c 2064 6570 6c6f 796d 656e 7420  rnal deployment 
+00037060: 7379 7374 656d 0a20 2020 2020 2020 2077  system.        w
+00037070: 696c 6c20 7265 7374 6172 7420 7468 656d  ill restart them
+00037080: 2e20 5468 6572 6566 6f72 652c 2069 6620  . Therefore, if 
+00037090: 6e6f 7420 7573 696e 6720 6e61 6e6e 6965  not using nannie
+000370a0: 7320 616e 6420 796f 7572 2064 6570 6c6f  s and your deplo
+000370b0: 796d 656e 7420 7379 7374 656d 0a20 2020  yment system.   
+000370c0: 2020 2020 2064 6f65 7320 6e6f 7420 6175       does not au
+000370d0: 746f 6d61 7469 6361 6c6c 7920 7265 7374  tomatically rest
+000370e0: 6172 7420 776f 726b 6572 732c 2060 6072  art workers, ``r
+000370f0: 6573 7461 7274 6060 2077 696c 6c20 6a75  estart`` will ju
+00037100: 7374 2073 6875 7420 646f 776e 2061 6c6c  st shut down all
+00037110: 0a20 2020 2020 2020 2077 6f72 6b65 7273  .        workers
+00037120: 2c20 7468 656e 2074 696d 6520 6f75 7421  , then time out!
+00037130: 0a0a 2020 2020 2020 2020 4166 7465 7220  ..        After 
+00037140: 6060 7265 7374 6172 7460 602c 2061 6c6c  ``restart``, all
+00037150: 2063 6f6e 6e65 6374 6564 2077 6f72 6b65   connected worke
+00037160: 7273 2061 7265 206e 6577 2c20 7265 6761  rs are new, rega
+00037170: 7264 6c65 7373 206f 6620 7768 6574 6865  rdless of whethe
+00037180: 720a 2020 2020 2020 2020 6060 5469 6d65  r.        ``Time
+00037190: 6f75 7445 7272 6f72 6060 2077 6173 2072  outError`` was r
+000371a0: 6169 7365 642e 2041 6e79 2077 6f72 6b65  aised. Any worke
+000371b0: 7273 2074 6861 7420 6661 696c 6564 2074  rs that failed t
+000371c0: 6f20 7368 7574 2064 6f77 6e20 696e 2074  o shut down in t
+000371d0: 696d 6520 6172 650a 2020 2020 2020 2020  ime are.        
+000371e0: 7265 6d6f 7665 642c 2061 6e64 206d 6179  removed, and may
+000371f0: 206f 7220 6d61 7920 6e6f 7420 7368 7574   or may not shut
+00037200: 2064 6f77 6e20 6f6e 2074 6865 6972 206f   down on their o
+00037210: 776e 2069 6e20 7468 6520 6675 7475 7265  wn in the future
+00037220: 2e0a 0a20 2020 2020 2020 2050 6172 616d  ...        Param
+00037230: 6574 6572 730a 2020 2020 2020 2020 2d2d  eters.        --
+00037240: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020 2020  --------.       
+00037250: 2077 6f72 6b65 7273 3a0a 2020 2020 2020   workers:.      
+00037260: 2020 2020 2020 4c69 7374 206f 6620 776f        List of wo
+00037270: 726b 6572 2061 6464 7265 7373 6573 2074  rker addresses t
+00037280: 6f20 7265 7374 6172 742e 2049 6620 6f6d  o restart. If om
+00037290: 6974 7465 642c 2072 6573 7461 7274 2061  itted, restart a
+000372a0: 6c6c 2077 6f72 6b65 7273 2e0a 2020 2020  ll workers..    
+000372b0: 2020 2020 7469 6d65 6f75 743a 0a20 2020      timeout:.   
+000372c0: 2020 2020 2020 2020 2048 6f77 206c 6f6e           How lon
+000372d0: 6720 746f 2077 6169 7420 666f 7220 776f  g to wait for wo
+000372e0: 726b 6572 7320 746f 2073 6875 7420 646f  rkers to shut do
+000372f0: 776e 2061 6e64 2063 6f6d 6520 6261 636b  wn and come back
+00037300: 2c20 6966 2060 6077 6169 745f 666f 725f  , if ``wait_for_
+00037310: 776f 726b 6572 7360 600a 2020 2020 2020  workers``.      
+00037320: 2020 2020 2020 6973 2054 7275 652c 206f        is True, o
+00037330: 7468 6572 7769 7365 206a 7573 7420 686f  therwise just ho
+00037340: 7720 6c6f 6e67 2074 6f20 7761 6974 2066  w long to wait f
+00037350: 6f72 2077 6f72 6b65 7273 2074 6f20 7368  or workers to sh
+00037360: 7574 2064 6f77 6e2e 0a20 2020 2020 2020  ut down..       
+00037370: 2020 2020 2052 6169 7365 7320 6060 6173       Raises ``as
+00037380: 796e 6369 6f2e 5469 6d65 6f75 7445 7272  yncio.TimeoutErr
+00037390: 6f72 6060 2069 6620 7468 6973 2069 7320  or`` if this is 
+000373a0: 6578 6365 6564 6564 2e0a 2020 2020 2020  exceeded..      
+000373b0: 2020 7761 6974 5f66 6f72 5f77 6f72 6b65    wait_for_worke
+000373c0: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
+000373d0: 5768 6574 6865 7220 746f 2077 6169 7420  Whether to wait 
+000373e0: 666f 7220 616c 6c20 776f 726b 6572 7320  for all workers 
+000373f0: 746f 2072 6563 6f6e 6e65 6374 2c20 6f72  to reconnect, or
+00037400: 206a 7573 7420 666f 7220 7468 656d 2074   just for them t
+00037410: 6f20 7368 7574 2064 6f77 6e0a 2020 2020  o shut down.    
+00037420: 2020 2020 2020 2020 2864 6566 6175 6c74          (default
+00037430: 2054 7275 6529 2e20 5573 6520 6060 7265   True). Use ``re
+00037440: 7374 6172 7428 7761 6974 5f66 6f72 5f77  start(wait_for_w
+00037450: 6f72 6b65 7273 3d46 616c 7365 2960 6020  orkers=False)`` 
+00037460: 636f 6d62 696e 6564 2077 6974 680a 2020  combined with.  
+00037470: 2020 2020 2020 2020 2020 3a6d 6574 683a            :meth:
+00037480: 6043 6c69 656e 742e 7761 6974 5f66 6f72  `Client.wait_for
+00037490: 5f77 6f72 6b65 7273 6020 666f 7220 6772  _workers` for gr
+000374a0: 616e 756c 6172 2063 6f6e 7472 6f6c 206f  anular control o
+000374b0: 7665 7220 686f 7720 6d61 6e79 2077 6f72  ver how many wor
+000374c0: 6b65 7273 2074 6f0a 2020 2020 2020 2020  kers to.        
+000374d0: 2020 2020 7761 6974 2066 6f72 2e0a 2020      wait for..  
+000374e0: 2020 2020 2020 6f6e 5f65 7272 6f72 3a0a        on_error:.
+000374f0: 2020 2020 2020 2020 2020 2020 4966 2027              If '
+00037500: 7261 6973 6527 2028 7468 6520 6465 6661  raise' (the defa
+00037510: 756c 7429 2c20 7261 6973 6520 6966 2061  ult), raise if a
+00037520: 6e79 206e 616e 6e79 2074 696d 6573 206f  ny nanny times o
+00037530: 7574 2077 6869 6c65 2072 6573 7461 7274  ut while restart
+00037540: 696e 6720 7468 650a 2020 2020 2020 2020  ing the.        
+00037550: 2020 2020 776f 726b 6572 2e20 4966 2027      worker. If '
+00037560: 7265 7475 726e 272c 2072 6574 7572 6e20  return', return 
+00037570: 6572 726f 7220 6d65 7373 6167 6573 2e0a  error messages..
+00037580: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
+00037590: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
+000375a0: 0a20 2020 2020 2020 207b 776f 726b 6572  .        {worker
+000375b0: 2061 6464 7265 7373 3a20 224f 4b22 2c20   address: "OK", 
+000375c0: 226e 6f20 6e61 6e6e 7922 2c20 6f72 2022  "no nanny", or "
+000375d0: 7469 6d65 6420 6f75 7422 206f 7220 6572  timed out" or er
+000375e0: 726f 7220 6d65 7373 6167 657d 0a0a 2020  ror message}..  
+000375f0: 2020 2020 2020 5365 6520 616c 736f 0a20        See also. 
+00037600: 2020 2020 2020 202d 2d2d 2d2d 2d2d 2d0a         --------.
+00037610: 2020 2020 2020 2020 436c 6965 6e74 2e72          Client.r
+00037620: 6573 7461 7274 0a20 2020 2020 2020 2043  estart.        C
+00037630: 6c69 656e 742e 7265 7374 6172 745f 776f  lient.restart_wo
+00037640: 726b 6572 730a 2020 2020 2020 2020 5363  rkers.        Sc
+00037650: 6865 6475 6c65 722e 7265 7374 6172 740a  heduler.restart.
+00037660: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00037670: 2020 2020 6e5f 776f 726b 6572 7320 3d20      n_workers = 
+00037680: 6c65 6e28 7365 6c66 2e77 6f72 6b65 7273  len(self.workers
+00037690: 290a 2020 2020 2020 2020 6966 2077 6f72  ).        if wor
+000376a0: 6b65 7273 2069 7320 4e6f 6e65 3a0a 2020  kers is None:.  
+000376b0: 2020 2020 2020 2020 2020 776f 726b 6572            worker
+000376c0: 7320 3d20 6c69 7374 2873 656c 662e 776f  s = list(self.wo
+000376d0: 726b 6572 7329 0a20 2020 2020 2020 2020  rkers).         
+000376e0: 2020 206c 6f67 6765 722e 696e 666f 2866     logger.info(f
+000376f0: 2252 6573 7461 7274 696e 6720 616c 6c20  "Restarting all 
+00037700: 776f 726b 6572 7320 287b 7374 696d 756c  workers ({stimul
+00037710: 7573 5f69 643d 7d22 290a 2020 2020 2020  us_id=}").      
+00037720: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00037730: 2020 2020 776f 726b 6572 7320 3d20 6c69      workers = li
+00037740: 7374 2873 6574 2877 6f72 6b65 7273 292e  st(set(workers).
+00037750: 696e 7465 7273 6563 7469 6f6e 2873 656c  intersection(sel
+00037760: 662e 776f 726b 6572 7329 290a 2020 2020  f.workers)).    
+00037770: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
+00037780: 6e66 6f28 6622 5265 7374 6172 7469 6e67  nfo(f"Restarting
+00037790: 207b 6c65 6e28 776f 726b 6572 7329 7d20   {len(workers)} 
+000377a0: 776f 726b 6572 733a 207b 776f 726b 6572  workers: {worker
+000377b0: 737d 2028 7b73 7469 6d75 6c75 735f 6964  s} ({stimulus_id
+000377c0: 3d7d 2229 0a0a 2020 2020 2020 2020 6e61  =}")..        na
+000377d0: 6e6e 795f 776f 726b 6572 7320 3d20 7b0a  nny_workers = {.
+000377e0: 2020 2020 2020 2020 2020 2020 6164 6472              addr
+000377f0: 3a20 7365 6c66 2e77 6f72 6b65 7273 5b61  : self.workers[a
+00037800: 6464 725d 2e6e 616e 6e79 0a20 2020 2020  ddr].nanny.     
+00037810: 2020 2020 2020 2066 6f72 2061 6464 7220         for addr 
+00037820: 696e 2077 6f72 6b65 7273 0a20 2020 2020  in workers.     
+00037830: 2020 2020 2020 2069 6620 7365 6c66 2e77         if self.w
+00037840: 6f72 6b65 7273 5b61 6464 725d 2e6e 616e  orkers[addr].nan
+00037850: 6e79 0a20 2020 2020 2020 207d 0a20 2020  ny.        }.   
+00037860: 2020 2020 2023 2043 6c6f 7365 206e 6f6e       # Close non
+00037870: 2d4e 616e 6e79 2077 6f72 6b65 7273 2e20  -Nanny workers. 
+00037880: 5765 2068 6176 6520 6e6f 2077 6179 2074  We have no way t
+00037890: 6f20 7265 7374 6172 7420 7468 656d 2c20  o restart them, 
+000378a0: 736f 2077 6520 6a75 7374 206c 6574 2074  so we just let t
+000378b0: 6865 6d0a 2020 2020 2020 2020 2320 676f  hem.        # go
+000378c0: 2c20 616e 6420 6173 7375 6d65 2061 2064  , and assume a d
+000378d0: 6570 6c6f 796d 656e 7420 7379 7374 656d  eployment system
+000378e0: 2069 7320 676f 696e 6720 746f 2072 6573   is going to res
+000378f0: 7461 7274 2074 6865 6d20 666f 7220 7573  tart them for us
+00037900: 2e0a 2020 2020 2020 2020 6e6f 5f6e 616e  ..        no_nan
+00037910: 6e79 5f77 6f72 6b65 7273 203d 205b 6164  ny_workers = [ad
+00037920: 6472 2066 6f72 2061 6464 7220 696e 2077  dr for addr in w
+00037930: 6f72 6b65 7273 2069 6620 6164 6472 206e  orkers if addr n
+00037940: 6f74 2069 6e20 6e61 6e6e 795f 776f 726b  ot in nanny_work
+00037950: 6572 735d 0a20 2020 2020 2020 2069 6620  ers].        if 
+00037960: 6e6f 5f6e 616e 6e79 5f77 6f72 6b65 7273  no_nanny_workers
+00037970: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
+00037980: 6767 6572 2e77 6172 6e69 6e67 280a 2020  gger.warning(.  
+00037990: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+000379a0: 576f 726b 6572 7320 7b6e 6f5f 6e61 6e6e  Workers {no_nann
+000379b0: 795f 776f 726b 6572 737d 2064 6f20 6e6f  y_workers} do no
+000379c0: 7420 7573 6520 6120 6e61 6e6e 7920 616e  t use a nanny an
+000379d0: 6420 7769 6c6c 2062 6520 7465 726d 696e  d will be termin
+000379e0: 6174 6564 2022 0a20 2020 2020 2020 2020  ated ".         
+000379f0: 2020 2020 2020 2022 7769 7468 6f75 7420         "without 
+00037a00: 7265 7374 6172 7469 6e67 2074 6865 6d22  restarting them"
+00037a10: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00037a20: 2020 2020 2020 2020 2020 2061 7761 6974             await
+00037a30: 2061 7379 6e63 696f 2e67 6174 6865 7228   asyncio.gather(
+00037a40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00037a50: 202a 280a 2020 2020 2020 2020 2020 2020   *(.            
+00037a60: 2020 2020 2020 2020 7365 6c66 2e72 656d          self.rem
+00037a70: 6f76 655f 776f 726b 6572 2861 6464 7265  ove_worker(addre
+00037a80: 7373 3d61 6464 722c 2073 7469 6d75 6c75  ss=addr, stimulu
+00037a90: 735f 6964 3d73 7469 6d75 6c75 735f 6964  s_id=stimulus_id
+00037aa0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00037ab0: 2020 2020 2020 666f 7220 6164 6472 2069        for addr i
+00037ac0: 6e20 6e6f 5f6e 616e 6e79 5f77 6f72 6b65  n no_nanny_worke
+00037ad0: 7273 0a20 2020 2020 2020 2020 2020 2020  rs.             
+00037ae0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00037af0: 2029 0a20 2020 2020 2020 206f 7574 3a20   ).        out: 
+00037b00: 6469 6374 5b73 7472 2c20 4c69 7465 7261  dict[str, Litera
+00037b10: 6c5b 224f 4b22 2c20 2272 656d 6f76 6564  l["OK", "removed
+00037b20: 222c 2022 7469 6d65 6420 6f75 7422 5d5d  ", "timed out"]]
+00037b30: 0a20 2020 2020 2020 206f 7574 203d 207b  .        out = {
+00037b40: 6164 6472 3a20 2272 656d 6f76 6564 2220  addr: "removed" 
+00037b50: 666f 7220 6164 6472 2069 6e20 6e6f 5f6e  for addr in no_n
+00037b60: 616e 6e79 5f77 6f72 6b65 7273 7d0a 2020  anny_workers}.  
+00037b70: 2020 2020 2020 6465 6164 6c69 6e65 203d        deadline =
+00037b80: 2044 6561 646c 696e 652e 6166 7465 7228   Deadline.after(
+00037b90: 7469 6d65 6f75 7429 0a0a 2020 2020 2020  timeout)..      
+00037ba0: 2020 6c6f 6767 6572 2e64 6562 7567 2822    logger.debug("
+00037bb0: 5365 6e64 206b 696c 6c20 7369 676e 616c  Send kill signal
+00037bc0: 2074 6f20 6e61 6e6e 6965 733a 2025 7322   to nannies: %s"
+00037bd0: 2c20 6e61 6e6e 795f 776f 726b 6572 7329  , nanny_workers)
+00037be0: 0a20 2020 2020 2020 2061 7379 6e63 2077  .        async w
+00037bf0: 6974 6820 636f 6e74 6578 746c 6962 2e41  ith contextlib.A
+00037c00: 7379 6e63 4578 6974 5374 6163 6b28 2920  syncExitStack() 
+00037c10: 6173 2073 7461 636b 3a0a 2020 2020 2020  as stack:.      
+00037c20: 2020 2020 2020 6e61 6e6e 6965 7320 3d20        nannies = 
+00037c30: 6177 6169 7420 6173 796e 6369 6f2e 6761  await asyncio.ga
+00037c40: 7468 6572 280a 2020 2020 2020 2020 2020  ther(.          
+00037c50: 2020 2020 2020 2a28 0a20 2020 2020 2020        *(.       
+00037c60: 2020 2020 2020 2020 2020 2020 2073 7461               sta
+00037c70: 636b 2e65 6e74 6572 5f61 7379 6e63 5f63  ck.enter_async_c
+00037c80: 6f6e 7465 7874 280a 2020 2020 2020 2020  ontext(.        
+00037c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037ca0: 7270 6328 6e61 6e6e 795f 6164 6472 6573  rpc(nanny_addres
+00037cb0: 732c 2063 6f6e 6e65 6374 696f 6e5f 6172  s, connection_ar
+00037cc0: 6773 3d73 656c 662e 636f 6e6e 6563 7469  gs=self.connecti
+00037cd0: 6f6e 5f61 7267 7329 0a20 2020 2020 2020  on_args).       
+00037ce0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
 00037cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037d00: 2020 2320 4649 584d 4520 646f 6573 206e    # FIXME does n
-00037d10: 6f74 2072 6169 7365 2069 6620 7468 6520  ot raise if the 
-00037d20: 7072 6f63 6573 7320 6661 696c 7320 746f  process fails to
-00037d30: 2073 6875 7420 646f 776e 2c0a 2020 2020   shut down,.    
-00037d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037d50: 2020 2020 2320 7365 6520 6874 7470 733a      # see https:
-00037d60: 2f2f 6769 7468 7562 2e63 6f6d 2f64 6173  //github.com/das
-00037d70: 6b2f 6469 7374 7269 6275 7465 642f 7075  k/distributed/pu
-00037d80: 6c6c 2f36 3432 372f 6669 6c65 7323 7238  ll/6427/files#r8
-00037d90: 3934 3931 3734 3234 0a20 2020 2020 2020  94917424.       
-00037da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037db0: 2023 204e 4f54 453a 204e 616e 6e79 2077   # NOTE: Nanny w
-00037dc0: 696c 6c20 6175 746f 6d61 7469 6361 6c6c  ill automaticall
-00037dd0: 7920 7265 7374 6172 7420 776f 726b 6572  y restart worker
-00037de0: 2070 726f 6365 7373 2077 6865 6e20 6974   process when it
-00037df0: 2773 206b 696c 6c65 640a 2020 2020 2020  's killed.      
+00037d00: 2020 2066 6f72 206e 616e 6e79 5f61 6464     for nanny_add
+00037d10: 7265 7373 2069 6e20 6e61 6e6e 795f 776f  ress in nanny_wo
+00037d20: 726b 6572 732e 7661 6c75 6573 2829 0a20  rkers.values(). 
+00037d30: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00037d40: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00037d50: 2020 2020 2020 2020 2020 2072 6573 7073             resps
+00037d60: 203d 2061 7761 6974 2061 7379 6e63 696f   = await asyncio
+00037d70: 2e67 6174 6865 7228 0a20 2020 2020 2020  .gather(.       
+00037d80: 2020 2020 2020 2020 202a 280a 2020 2020           *(.    
+00037d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037da0: 7761 6974 5f66 6f72 280a 2020 2020 2020  wait_for(.      
+00037db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037dc0: 2020 2320 4649 584d 4520 646f 6573 206e    # FIXME does n
+00037dd0: 6f74 2072 6169 7365 2069 6620 7468 6520  ot raise if the 
+00037de0: 7072 6f63 6573 7320 6661 696c 7320 746f  process fails to
+00037df0: 2073 6875 7420 646f 776e 2c0a 2020 2020   shut down,.    
 00037e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037e10: 2020 2320 4e4f 5445 3a20 446f 6e27 7420    # NOTE: Don't 
-00037e20: 7072 6f70 6167 6174 6520 7469 6d65 6f75  propagate timeou
-00037e30: 7420 746f 206b 696c 6c28 293a 2077 6520  t to kill(): we 
-00037e40: 646f 6e27 7420 7761 6e74 2074 6f0a 2020  don't want to.  
-00037e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037e60: 2020 2020 2020 2320 7370 656e 6420 282e        # spend (.
-00037e70: 382a 2e38 293d 3634 2520 6f66 206f 7572  8*.8)=64% of our
-00037e80: 2065 6e64 2d74 6f2d 656e 6420 7469 6d65   end-to-end time
-00037e90: 6f75 7420 7761 6974 696e 6720 666f 7220  out waiting for 
-00037ea0: 6120 6875 6e67 0a20 2020 2020 2020 2020  a hung.         
-00037eb0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00037ec0: 2070 726f 6365 7373 2074 6f20 7265 7374   process to rest
-00037ed0: 6172 742e 0a20 2020 2020 2020 2020 2020  art..           
-00037ee0: 2020 2020 2020 2020 2020 2020 206e 616e               nan
-00037ef0: 6e79 2e6b 696c 6c28 7265 6173 6f6e 3d73  ny.kill(reason=s
-00037f00: 7469 6d75 6c75 735f 6964 292c 0a20 2020  timulus_id),.   
+00037e10: 2020 2020 2320 7365 6520 6874 7470 733a      # see https:
+00037e20: 2f2f 6769 7468 7562 2e63 6f6d 2f64 6173  //github.com/das
+00037e30: 6b2f 6469 7374 7269 6275 7465 642f 7075  k/distributed/pu
+00037e40: 6c6c 2f36 3432 372f 6669 6c65 7323 7238  ll/6427/files#r8
+00037e50: 3934 3931 3734 3234 0a20 2020 2020 2020  94917424.       
+00037e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037e70: 2023 204e 4f54 453a 204e 616e 6e79 2077   # NOTE: Nanny w
+00037e80: 696c 6c20 6175 746f 6d61 7469 6361 6c6c  ill automaticall
+00037e90: 7920 7265 7374 6172 7420 776f 726b 6572  y restart worker
+00037ea0: 2070 726f 6365 7373 2077 6865 6e20 6974   process when it
+00037eb0: 2773 206b 696c 6c65 640a 2020 2020 2020  's killed.      
+00037ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037ed0: 2020 2320 4e4f 5445 3a20 446f 6e27 7420    # NOTE: Don't 
+00037ee0: 7072 6f70 6167 6174 6520 7469 6d65 6f75  propagate timeou
+00037ef0: 7420 746f 206b 696c 6c28 293a 2077 6520  t to kill(): we 
+00037f00: 646f 6e27 7420 7761 6e74 2074 6f0a 2020  don't want to.  
 00037f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037f20: 2020 2020 2074 696d 656f 7574 2c0a 2020       timeout,.  
-00037f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037f40: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00037f50: 2020 2020 2020 2020 666f 7220 6e61 6e6e          for nann
-00037f60: 7920 696e 206e 616e 6e69 6573 0a20 2020  y in nannies.   
-00037f70: 2020 2020 2020 2020 2020 2020 2029 2c0a               ),.
-00037f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037f90: 7265 7475 726e 5f65 7863 6570 7469 6f6e  return_exception
-00037fa0: 733d 5472 7565 2c0a 2020 2020 2020 2020  s=True,.        
-00037fb0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00037fc0: 2020 2320 4e4f 5445 3a20 7468 6520 6057    # NOTE: the `W
-00037fd0: 6f72 6b65 7253 7461 7465 6020 656e 7472  orkerState` entr
-00037fe0: 6965 7320 666f 7220 7468 6573 6520 776f  ies for these wo
-00037ff0: 726b 6572 7320 7769 6c6c 2062 6520 7265  rkers will be re
-00038000: 6d6f 7665 640a 2020 2020 2020 2020 2020  moved.          
-00038010: 2020 2320 6e61 7475 7261 6c6c 7920 7768    # naturally wh
-00038020: 656e 2074 6865 7920 6469 7363 6f6e 6e65  en they disconne
-00038030: 6374 2066 726f 6d20 7468 6520 7363 6865  ct from the sche
-00038040: 6475 6c65 722e 0a0a 2020 2020 2020 2020  duler...        
-00038050: 2020 2020 2320 5265 6d6f 7665 2061 6e79      # Remove any
-00038060: 2077 6f72 6b65 7273 2074 6861 7420 6661   workers that fa
-00038070: 696c 6564 2074 6f20 7368 7574 2064 6f77  iled to shut dow
-00038080: 6e2c 2073 6f20 7765 2063 616e 2067 7561  n, so we can gua
-00038090: 7261 6e74 6565 0a20 2020 2020 2020 2020  rantee.         
-000380a0: 2020 2023 2074 6861 7420 6166 7465 7220     # that after 
-000380b0: 6072 6573 7461 7274 602c 2074 6865 7265  `restart`, there
-000380c0: 2061 7265 206e 6f20 6f6c 6420 776f 726b   are no old work
-000380d0: 6572 7320 6172 6f75 6e64 2e0a 2020 2020  ers around..    
-000380e0: 2020 2020 2020 2020 6261 645f 6e61 6e6e          bad_nann
-000380f0: 6965 7320 3d20 7365 7428 290a 2020 2020  ies = set().    
-00038100: 2020 2020 2020 2020 666f 7220 6164 6472          for addr
-00038110: 2c20 7265 7370 2069 6e20 7a69 7028 6e61  , resp in zip(na
-00038120: 6e6e 795f 776f 726b 6572 732c 2072 6573  nny_workers, res
-00038130: 7073 293a 0a20 2020 2020 2020 2020 2020  ps):.           
-00038140: 2020 2020 2069 6620 7265 7370 2069 7320       if resp is 
-00038150: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00038160: 2020 2020 2020 2020 2020 6f75 745b 6164            out[ad
-00038170: 6472 5d20 3d20 224f 4b22 0a20 2020 2020  dr] = "OK".     
-00038180: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-00038190: 6973 696e 7374 616e 6365 2872 6573 702c  isinstance(resp,
-000381a0: 2028 4f53 4572 726f 722c 2054 696d 656f   (OSError, Timeo
-000381b0: 7574 4572 726f 7229 293a 0a20 2020 2020  utError)):.     
-000381c0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-000381d0: 6164 5f6e 616e 6e69 6573 2e61 6464 2861  ad_nannies.add(a
-000381e0: 6464 7229 0a20 2020 2020 2020 2020 2020  ddr).           
-000381f0: 2020 2020 2020 2020 206f 7574 5b61 6464           out[add
-00038200: 725d 203d 2022 7469 6d65 6420 6f75 7422  r] = "timed out"
-00038210: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00038220: 2065 6c73 653a 2020 2320 7072 6167 6d61   else:  # pragma
-00038230: 3a20 6e6f 636f 7665 720a 2020 2020 2020  : nocover.      
-00038240: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-00038250: 6973 6520 7265 7370 0a0a 2020 2020 2020  ise resp..      
-00038260: 2020 2020 2020 6966 2062 6164 5f6e 616e        if bad_nan
-00038270: 6e69 6573 3a0a 2020 2020 2020 2020 2020  nies:.          
-00038280: 2020 2020 2020 6c6f 6767 6572 2e65 7272        logger.err
-00038290: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-000382a0: 2020 2020 2020 2020 6622 576f 726b 6572          f"Worker
-000382b0: 7320 7b6c 6973 7428 6261 645f 6e61 6e6e  s {list(bad_nann
-000382c0: 6965 7329 7d20 6469 6420 6e6f 7420 7368  ies)} did not sh
-000382d0: 7574 2064 6f77 6e20 7769 7468 696e 207b  ut down within {
-000382e0: 7469 6d65 6f75 747d 733b 2022 0a20 2020  timeout}s; ".   
-000382f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038300: 2022 666f 7263 6520 636c 6f73 696e 6722   "force closing"
-00038310: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00038320: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00038330: 2020 2061 7761 6974 2061 7379 6e63 696f     await asyncio
-00038340: 2e67 6174 6865 7228 0a20 2020 2020 2020  .gather(.       
-00038350: 2020 2020 2020 2020 2020 2020 202a 280a               *(.
-00038360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038370: 2020 2020 2020 2020 7365 6c66 2e72 656d          self.rem
-00038380: 6f76 655f 776f 726b 6572 2861 6464 722c  ove_worker(addr,
-00038390: 2073 7469 6d75 6c75 735f 6964 3d73 7469   stimulus_id=sti
-000383a0: 6d75 6c75 735f 6964 290a 2020 2020 2020  mulus_id).      
+00037f20: 2020 2020 2020 2320 7370 656e 6420 282e        # spend (.
+00037f30: 382a 2e38 293d 3634 2520 6f66 206f 7572  8*.8)=64% of our
+00037f40: 2065 6e64 2d74 6f2d 656e 6420 7469 6d65   end-to-end time
+00037f50: 6f75 7420 7761 6974 696e 6720 666f 7220  out waiting for 
+00037f60: 6120 6875 6e67 0a20 2020 2020 2020 2020  a hung.         
+00037f70: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00037f80: 2070 726f 6365 7373 2074 6f20 7265 7374   process to rest
+00037f90: 6172 742e 0a20 2020 2020 2020 2020 2020  art..           
+00037fa0: 2020 2020 2020 2020 2020 2020 206e 616e               nan
+00037fb0: 6e79 2e6b 696c 6c28 7265 6173 6f6e 3d73  ny.kill(reason=s
+00037fc0: 7469 6d75 6c75 735f 6964 292c 0a20 2020  timulus_id),.   
+00037fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037fe0: 2020 2020 2074 696d 656f 7574 2c0a 2020       timeout,.  
+00037ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038000: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00038010: 2020 2020 2020 2020 666f 7220 6e61 6e6e          for nann
+00038020: 7920 696e 206e 616e 6e69 6573 0a20 2020  y in nannies.   
+00038030: 2020 2020 2020 2020 2020 2020 2029 2c0a               ),.
+00038040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038050: 7265 7475 726e 5f65 7863 6570 7469 6f6e  return_exception
+00038060: 733d 5472 7565 2c0a 2020 2020 2020 2020  s=True,.        
+00038070: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00038080: 2020 2320 4e4f 5445 3a20 7468 6520 6057    # NOTE: the `W
+00038090: 6f72 6b65 7253 7461 7465 6020 656e 7472  orkerState` entr
+000380a0: 6965 7320 666f 7220 7468 6573 6520 776f  ies for these wo
+000380b0: 726b 6572 7320 7769 6c6c 2062 6520 7265  rkers will be re
+000380c0: 6d6f 7665 640a 2020 2020 2020 2020 2020  moved.          
+000380d0: 2020 2320 6e61 7475 7261 6c6c 7920 7768    # naturally wh
+000380e0: 656e 2074 6865 7920 6469 7363 6f6e 6e65  en they disconne
+000380f0: 6374 2066 726f 6d20 7468 6520 7363 6865  ct from the sche
+00038100: 6475 6c65 722e 0a0a 2020 2020 2020 2020  duler...        
+00038110: 2020 2020 2320 5265 6d6f 7665 2061 6e79      # Remove any
+00038120: 2077 6f72 6b65 7273 2074 6861 7420 6661   workers that fa
+00038130: 696c 6564 2074 6f20 7368 7574 2064 6f77  iled to shut dow
+00038140: 6e2c 2073 6f20 7765 2063 616e 2067 7561  n, so we can gua
+00038150: 7261 6e74 6565 0a20 2020 2020 2020 2020  rantee.         
+00038160: 2020 2023 2074 6861 7420 6166 7465 7220     # that after 
+00038170: 6072 6573 7461 7274 602c 2074 6865 7265  `restart`, there
+00038180: 2061 7265 206e 6f20 6f6c 6420 776f 726b   are no old work
+00038190: 6572 7320 6172 6f75 6e64 2e0a 2020 2020  ers around..    
+000381a0: 2020 2020 2020 2020 6261 645f 6e61 6e6e          bad_nann
+000381b0: 6965 7320 3d20 7365 7428 290a 2020 2020  ies = set().    
+000381c0: 2020 2020 2020 2020 666f 7220 6164 6472          for addr
+000381d0: 2c20 7265 7370 2069 6e20 7a69 7028 6e61  , resp in zip(na
+000381e0: 6e6e 795f 776f 726b 6572 732c 2072 6573  nny_workers, res
+000381f0: 7073 293a 0a20 2020 2020 2020 2020 2020  ps):.           
+00038200: 2020 2020 2069 6620 7265 7370 2069 7320       if resp is 
+00038210: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00038220: 2020 2020 2020 2020 2020 6f75 745b 6164            out[ad
+00038230: 6472 5d20 3d20 224f 4b22 0a20 2020 2020  dr] = "OK".     
+00038240: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+00038250: 6973 696e 7374 616e 6365 2872 6573 702c  isinstance(resp,
+00038260: 2028 4f53 4572 726f 722c 2054 696d 656f   (OSError, Timeo
+00038270: 7574 4572 726f 7229 293a 0a20 2020 2020  utError)):.     
+00038280: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+00038290: 6164 5f6e 616e 6e69 6573 2e61 6464 2861  ad_nannies.add(a
+000382a0: 6464 7229 0a20 2020 2020 2020 2020 2020  ddr).           
+000382b0: 2020 2020 2020 2020 206f 7574 5b61 6464           out[add
+000382c0: 725d 203d 2022 7469 6d65 6420 6f75 7422  r] = "timed out"
+000382d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000382e0: 2065 6c73 653a 2020 2320 7072 6167 6d61   else:  # pragma
+000382f0: 3a20 6e6f 636f 7665 720a 2020 2020 2020  : nocover.      
+00038300: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+00038310: 6973 6520 7265 7370 0a0a 2020 2020 2020  ise resp..      
+00038320: 2020 2020 2020 6966 2062 6164 5f6e 616e        if bad_nan
+00038330: 6e69 6573 3a0a 2020 2020 2020 2020 2020  nies:.          
+00038340: 2020 2020 2020 6c6f 6767 6572 2e65 7272        logger.err
+00038350: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+00038360: 2020 2020 2020 2020 6622 576f 726b 6572          f"Worker
+00038370: 7320 7b6c 6973 7428 6261 645f 6e61 6e6e  s {list(bad_nann
+00038380: 6965 7329 7d20 6469 6420 6e6f 7420 7368  ies)} did not sh
+00038390: 7574 2064 6f77 6e20 7769 7468 696e 207b  ut down within {
+000383a0: 7469 6d65 6f75 747d 733b 2022 0a20 2020  timeout}s; ".   
 000383b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000383c0: 2020 666f 7220 6164 6472 2069 6e20 6261    for addr in ba
-000383d0: 645f 6e61 6e6e 6965 730a 2020 2020 2020  d_nannies.      
-000383e0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-000383f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038400: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00038410: 2020 6966 206f 6e5f 6572 726f 7220 3d3d    if on_error ==
-00038420: 2022 7261 6973 6522 3a0a 2020 2020 2020   "raise":.      
-00038430: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-00038440: 6973 6520 5469 6d65 6f75 7445 7272 6f72  ise TimeoutError
-00038450: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00038460: 2020 2020 2020 2020 2020 6622 7b6c 656e            f"{len
-00038470: 2862 6164 5f6e 616e 6e69 6573 297d 2f7b  (bad_nannies)}/{
-00038480: 6c65 6e28 6e61 6e6e 6965 7329 7d20 6e61  len(nannies)} na
-00038490: 6e6e 7920 776f 726b 6572 2873 2920 6469  nny worker(s) di
-000384a0: 6420 6e6f 7420 220a 2020 2020 2020 2020  d not ".        
+000383c0: 2022 666f 7263 6520 636c 6f73 696e 6722   "force closing"
+000383d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000383e0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+000383f0: 2020 2061 7761 6974 2061 7379 6e63 696f     await asyncio
+00038400: 2e67 6174 6865 7228 0a20 2020 2020 2020  .gather(.       
+00038410: 2020 2020 2020 2020 2020 2020 202a 280a               *(.
+00038420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038430: 2020 2020 2020 2020 7365 6c66 2e72 656d          self.rem
+00038440: 6f76 655f 776f 726b 6572 2861 6464 722c  ove_worker(addr,
+00038450: 2073 7469 6d75 6c75 735f 6964 3d73 7469   stimulus_id=sti
+00038460: 6d75 6c75 735f 6964 290a 2020 2020 2020  mulus_id).      
+00038470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038480: 2020 666f 7220 6164 6472 2069 6e20 6261    for addr in ba
+00038490: 645f 6e61 6e6e 6965 730a 2020 2020 2020  d_nannies.      
+000384a0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
 000384b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000384c0: 6622 7368 7574 2064 6f77 6e20 7769 7468  f"shut down with
-000384d0: 696e 207b 7469 6d65 6f75 747d 733a 207b  in {timeout}s: {
-000384e0: 6261 645f 6e61 6e6e 6965 737d 220a 2020  bad_nannies}".  
-000384f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038500: 2020 290a 0a20 2020 2020 2020 2069 6620    )..        if 
-00038510: 636c 6965 6e74 3a0a 2020 2020 2020 2020  client:.        
-00038520: 2020 2020 7365 6c66 2e6c 6f67 5f65 7665      self.log_eve
-00038530: 6e74 2863 6c69 656e 742c 207b 2261 6374  nt(client, {"act
-00038540: 696f 6e22 3a20 2272 6573 7461 7274 2d77  ion": "restart-w
-00038550: 6f72 6b65 7273 222c 2022 776f 726b 6572  orkers", "worker
-00038560: 7322 3a20 776f 726b 6572 737d 290a 2020  s": workers}).  
-00038570: 2020 2020 2020 7365 6c66 2e6c 6f67 5f65        self.log_e
-00038580: 7665 6e74 280a 2020 2020 2020 2020 2020  vent(.          
-00038590: 2020 2261 6c6c 222c 207b 2261 6374 696f    "all", {"actio
-000385a0: 6e22 3a20 2272 6573 7461 7274 2d77 6f72  n": "restart-wor
-000385b0: 6b65 7273 222c 2022 776f 726b 6572 7322  kers", "workers"
-000385c0: 3a20 776f 726b 6572 732c 2022 636c 6965  : workers, "clie
-000385d0: 6e74 223a 2063 6c69 656e 747d 0a20 2020  nt": client}.   
-000385e0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-000385f0: 6966 206e 6f74 2077 6169 745f 666f 725f  if not wait_for_
-00038600: 776f 726b 6572 733a 0a20 2020 2020 2020  workers:.       
-00038610: 2020 2020 206c 6f67 6765 722e 696e 666f       logger.info
-00038620: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00038630: 2020 2257 6f72 6b65 7273 2072 6573 7461    "Workers resta
-00038640: 7274 2066 696e 6973 6865 6420 2864 6964  rt finished (did
-00038650: 206e 6f74 2077 6169 7420 666f 7220 6e65   not wait for ne
-00038660: 7720 776f 726b 6572 7329 2022 0a20 2020  w workers) ".   
-00038670: 2020 2020 2020 2020 2020 2020 2066 2228               f"(
-00038680: 7b73 7469 6d75 6c75 735f 6964 3d7d 220a  {stimulus_id=}".
-00038690: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-000386a0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-000386b0: 206f 7574 0a0a 2020 2020 2020 2020 2320   out..        # 
-000386c0: 4e4f 5445 3a20 6966 206e 6577 2028 756e  NOTE: if new (un
-000386d0: 7265 6c61 7465 6429 2077 6f72 6b65 7273  related) workers
-000386e0: 206a 6f69 6e20 7768 696c 6520 7765 2772   join while we'r
-000386f0: 6520 7761 6974 696e 672c 2077 6520 6d61  e waiting, we ma
-00038700: 7920 7265 7475 726e 0a20 2020 2020 2020  y return.       
-00038710: 2023 2062 6566 6f72 6520 6f75 7220 7368   # before our sh
-00038720: 7574 2d64 6f77 6e20 776f 726b 6572 7320  ut-down workers 
-00038730: 6861 7665 2063 6f6d 6520 6261 636b 2075  have come back u
-00038740: 702e 2054 6861 7427 7320 6669 6e65 3b20  p. That's fine; 
-00038750: 776f 726b 6572 7320 6172 650a 2020 2020  workers are.    
-00038760: 2020 2020 2320 696e 7465 7263 6861 6e67      # interchang
-00038770: 6561 626c 652e 0a20 2020 2020 2020 2077  eable..        w
-00038780: 6869 6c65 206e 6f74 2064 6561 646c 696e  hile not deadlin
-00038790: 652e 6578 7069 7265 6420 616e 6420 6c65  e.expired and le
-000387a0: 6e28 7365 6c66 2e77 6f72 6b65 7273 2920  n(self.workers) 
-000387b0: 3c20 6e5f 776f 726b 6572 733a 0a20 2020  < n_workers:.   
-000387c0: 2020 2020 2020 2020 2061 7761 6974 2061           await a
-000387d0: 7379 6e63 696f 2e73 6c65 6570 2830 2e32  syncio.sleep(0.2
-000387e0: 290a 0a20 2020 2020 2020 2069 6620 6c65  )..        if le
-000387f0: 6e28 7365 6c66 2e77 6f72 6b65 7273 2920  n(self.workers) 
-00038800: 3e3d 206e 5f77 6f72 6b65 7273 3a0a 2020  >= n_workers:.  
-00038810: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-00038820: 2e69 6e66 6f28 6622 576f 726b 6572 7320  .info(f"Workers 
-00038830: 7265 7374 6172 7420 6669 6e69 7368 6564  restart finished
-00038840: 2028 7b73 7469 6d75 6c75 735f 6964 3d7d   ({stimulus_id=}
-00038850: 2229 0a20 2020 2020 2020 2020 2020 2072  ").            r
-00038860: 6574 7572 6e20 6f75 740a 0a20 2020 2020  eturn out..     
-00038870: 2020 206d 7367 203d 2028 0a20 2020 2020     msg = (.     
-00038880: 2020 2020 2020 2066 2257 6169 7465 6420         f"Waited 
-00038890: 666f 7220 7b6c 656e 2877 6f72 6b65 7273  for {len(workers
-000388a0: 297d 2077 6f72 6b65 7228 7329 2074 6f20  )} worker(s) to 
-000388b0: 7265 636f 6e6e 6563 7420 6166 7465 7220  reconnect after 
-000388c0: 7265 7374 6172 7469 6e67 2062 7574 2c20  restarting but, 
-000388d0: 220a 2020 2020 2020 2020 2020 2020 6622  ".            f"
-000388e0: 6166 7465 7220 7b74 696d 656f 7574 7d73  after {timeout}s
-000388f0: 2c20 7b6e 5f77 6f72 6b65 7273 202d 206c  , {n_workers - l
-00038900: 656e 2873 656c 662e 776f 726b 6572 7329  en(self.workers)
-00038910: 7d20 6861 7665 206e 6f74 2072 6574 7572  } have not retur
-00038920: 6e65 642e 2022 0a20 2020 2020 2020 2020  ned. ".         
-00038930: 2020 2022 436f 6e73 6964 6572 2061 206c     "Consider a l
-00038940: 6f6e 6765 7220 7469 6d65 6f75 742c 206f  onger timeout, o
-00038950: 7220 6077 6169 745f 666f 725f 776f 726b  r `wait_for_work
-00038960: 6572 733d 4661 6c73 6560 2e22 0a20 2020  ers=False`.".   
-00038970: 2020 2020 2029 0a20 2020 2020 2020 2069       ).        i
-00038980: 6620 6e6f 5f6e 616e 6e79 5f77 6f72 6b65  f no_nanny_worke
-00038990: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
-000389a0: 6d73 6720 2b3d 2028 0a20 2020 2020 2020  msg += (.       
-000389b0: 2020 2020 2020 2020 2066 2220 5468 6520           f" The 
-000389c0: 7b6c 656e 286e 6f5f 6e61 6e6e 795f 776f  {len(no_nanny_wo
-000389d0: 726b 6572 7329 7d20 776f 726b 6572 2873  rkers)} worker(s
-000389e0: 2920 6e6f 7420 7573 696e 6720 4e61 6e6e  ) not using Nann
-000389f0: 6965 7320 7765 7265 206a 7573 7420 7368  ies were just sh
-00038a00: 7574 2022 0a20 2020 2020 2020 2020 2020  ut ".           
-00038a10: 2020 2020 2022 646f 776e 2069 6e73 7465       "down inste
-00038a20: 6164 206f 6620 7265 7374 6172 7465 6420  ad of restarted 
-00038a30: 2872 6573 7461 7274 2069 7320 6f6e 6c79  (restart is only
-00038a40: 2070 6f73 7369 626c 6520 7769 7468 204e   possible with N
-00038a50: 616e 6e69 6573 292e 2049 6620 220a 2020  annies). If ".  
-00038a60: 2020 2020 2020 2020 2020 2020 2020 2279                "y
-00038a70: 6f75 7220 6465 706c 6f79 6d65 6e74 2073  our deployment s
-00038a80: 7973 7465 6d20 646f 6573 206e 6f74 2061  ystem does not a
-00038a90: 7574 6f6d 6174 6963 616c 6c79 2072 652d  utomatically re-
-00038aa0: 6c61 756e 6368 2074 6572 6d69 6e61 7465  launch terminate
-00038ab0: 6420 220a 2020 2020 2020 2020 2020 2020  d ".            
-00038ac0: 2020 2020 2270 726f 6365 7373 6573 2c20      "processes, 
-00038ad0: 7468 656e 2074 686f 7365 2077 6f72 6b65  then those worke
-00038ae0: 7273 2077 696c 6c20 6e65 7665 7220 636f  rs will never co
-00038af0: 6d65 2062 6163 6b2c 2061 6e64 2060 436c  me back, and `Cl
-00038b00: 6965 6e74 2e72 6573 7461 7274 6020 220a  ient.restart` ".
-00038b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038b20: 2277 696c 6c20 616c 7761 7973 2074 696d  "will always tim
-00038b30: 6520 6f75 742e 2044 6f20 6e6f 7420 7573  e out. Do not us
-00038b40: 6520 6043 6c69 656e 742e 7265 7374 6172  e `Client.restar
-00038b50: 7460 2069 6e20 7468 6174 2063 6173 652e  t` in that case.
-00038b60: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
-00038b70: 0a20 2020 2020 2020 2069 6620 6f6e 5f65  .        if on_e
-00038b80: 7272 6f72 203d 3d20 2272 6169 7365 223a  rror == "raise":
-00038b90: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-00038ba0: 7365 2054 696d 656f 7574 4572 726f 7228  se TimeoutError(
-00038bb0: 6d73 6729 0a20 2020 2020 2020 206c 6f67  msg).        log
-00038bc0: 6765 722e 6572 726f 7228 6622 7b6d 7367  ger.error(f"{msg
-00038bd0: 7d20 287b 7374 696d 756c 7573 5f69 643d  } ({stimulus_id=
-00038be0: 7d29 2229 0a0a 2020 2020 2020 2020 6e65  })")..        ne
-00038bf0: 775f 6e61 6e6e 6965 7320 3d20 7b77 732e  w_nannies = {ws.
-00038c00: 6e61 6e6e 7920 666f 7220 7773 2069 6e20  nanny for ws in 
-00038c10: 7365 6c66 2e77 6f72 6b65 7273 2e76 616c  self.workers.val
-00038c20: 7565 7328 2920 6966 2077 732e 6e61 6e6e  ues() if ws.nann
-00038c30: 797d 0a20 2020 2020 2020 2066 6f72 2077  y}.        for w
-00038c40: 6f72 6b65 725f 6164 6472 2c20 6e61 6e6e  orker_addr, nann
-00038c50: 795f 6164 6472 2069 6e20 6e61 6e6e 795f  y_addr in nanny_
-00038c60: 776f 726b 6572 732e 6974 656d 7328 293a  workers.items():
-00038c70: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00038c80: 6e61 6e6e 795f 6164 6472 206e 6f74 2069  nanny_addr not i
-00038c90: 6e20 6e65 775f 6e61 6e6e 6965 733a 0a20  n new_nannies:. 
-00038ca0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-00038cb0: 7574 5b77 6f72 6b65 725f 6164 6472 5d20  ut[worker_addr] 
-00038cc0: 3d20 2274 696d 6564 206f 7574 220a 0a20  = "timed out".. 
-00038cd0: 2020 2020 2020 2072 6574 7572 6e20 6f75         return ou
-00038ce0: 740a 0a20 2020 2061 7379 6e63 2064 6566  t..    async def
-00038cf0: 2062 726f 6164 6361 7374 280a 2020 2020   broadcast(.    
-00038d00: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-00038d10: 2020 2a2c 0a20 2020 2020 2020 206d 7367    *,.        msg
-00038d20: 3a20 6469 6374 2c0a 2020 2020 2020 2020  : dict,.        
-00038d30: 776f 726b 6572 733a 2043 6f6c 6c65 6374  workers: Collect
-00038d40: 696f 6e5b 7374 725d 207c 204e 6f6e 6520  ion[str] | None 
-00038d50: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-00038d60: 686f 7374 733a 2043 6f6c 6c65 6374 696f  hosts: Collectio
-00038d70: 6e5b 7374 725d 207c 204e 6f6e 6520 3d20  n[str] | None = 
-00038d80: 4e6f 6e65 2c0a 2020 2020 2020 2020 6e61  None,.        na
-00038d90: 6e6e 793a 2062 6f6f 6c20 3d20 4661 6c73  nny: bool = Fals
-00038da0: 652c 0a20 2020 2020 2020 2073 6572 6961  e,.        seria
-00038db0: 6c69 7a65 7273 3a20 416e 7920 3d20 4e6f  lizers: Any = No
-00038dc0: 6e65 2c0a 2020 2020 2020 2020 6f6e 5f65  ne,.        on_e
-00038dd0: 7272 6f72 3a20 4c69 7465 7261 6c5b 2272  rror: Literal["r
-00038de0: 6169 7365 222c 2022 7265 7475 726e 222c  aise", "return",
-00038df0: 2022 7265 7475 726e 5f70 6963 6b6c 6522   "return_pickle"
-00038e00: 2c20 2269 676e 6f72 6522 5d20 3d20 2272  , "ignore"] = "r
-00038e10: 6169 7365 222c 0a20 2020 2029 202d 3e20  aise",.    ) -> 
-00038e20: 6469 6374 5b73 7472 2c20 416e 795d 3a0a  dict[str, Any]:.
-00038e30: 2020 2020 2020 2020 2222 2242 726f 6164          """Broad
-00038e40: 6361 7374 206d 6573 7361 6765 2074 6f20  cast message to 
-00038e50: 776f 726b 6572 732c 2072 6574 7572 6e20  workers, return 
-00038e60: 616c 6c20 7265 7375 6c74 7322 2222 0a20  all results""". 
-00038e70: 2020 2020 2020 2069 6620 776f 726b 6572         if worker
-00038e80: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
-00038e90: 2020 2020 2020 2069 6620 686f 7374 7320         if hosts 
-00038ea0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-00038eb0: 2020 2020 2020 2020 2077 6f72 6b65 7273           workers
-00038ec0: 203d 206c 6973 7428 7365 6c66 2e77 6f72   = list(self.wor
-00038ed0: 6b65 7273 290a 2020 2020 2020 2020 2020  kers).          
-00038ee0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00038ef0: 2020 2020 2020 2020 776f 726b 6572 7320          workers 
-00038f00: 3d20 5b5d 0a20 2020 2020 2020 2065 6c73  = [].        els
-00038f10: 653a 0a20 2020 2020 2020 2020 2020 2077  e:.            w
-00038f20: 6f72 6b65 7273 203d 206c 6973 7428 776f  orkers = list(wo
-00038f30: 726b 6572 7329 0a20 2020 2020 2020 2069  rkers).        i
-00038f40: 6620 686f 7374 7320 6973 206e 6f74 204e  f hosts is not N
-00038f50: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00038f60: 2066 6f72 2068 6f73 7420 696e 2068 6f73   for host in hos
-00038f70: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
-00038f80: 2020 2020 6468 203d 2073 656c 662e 686f      dh = self.ho
-00038f90: 7374 5f69 6e66 6f2e 6765 7428 686f 7374  st_info.get(host
-00038fa0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00038fb0: 2020 6966 2064 6820 6973 206e 6f74 204e    if dh is not N
-00038fc0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00038fd0: 2020 2020 2020 2020 2077 6f72 6b65 7273           workers
-00038fe0: 2e65 7874 656e 6428 6468 5b22 6164 6472  .extend(dh["addr
-00038ff0: 6573 7365 7322 5d29 0a0a 2020 2020 2020  esses"])..      
-00039000: 2020 6966 206e 616e 6e79 3a0a 2020 2020    if nanny:.    
-00039010: 2020 2020 2020 2020 6164 6472 6573 7365          addresse
-00039020: 7320 3d20 5b6e 2066 6f72 2077 2069 6e20  s = [n for w in 
-00039030: 776f 726b 6572 7320 6966 2028 6e20 3a3d  workers if (n :=
-00039040: 2073 656c 662e 776f 726b 6572 735b 775d   self.workers[w]
-00039050: 2e6e 616e 6e79 2920 6973 206e 6f74 204e  .nanny) is not N
-00039060: 6f6e 655d 0a20 2020 2020 2020 2065 6c73  one].        els
-00039070: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
-00039080: 6464 7265 7373 6573 203d 2077 6f72 6b65  ddresses = worke
-00039090: 7273 0a0a 2020 2020 2020 2020 4552 524f  rs..        ERRO
-000390a0: 5220 3d20 6f62 6a65 6374 2829 0a0a 2020  R = object()..  
-000390b0: 2020 2020 2020 6173 796e 6320 6465 6620        async def 
-000390c0: 7365 6e64 5f6d 6573 7361 6765 2861 6464  send_message(add
-000390d0: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-000390e0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-000390f0: 2020 2020 2063 6f6d 6d20 3d20 6177 6169       comm = awai
-00039100: 7420 7365 6c66 2e72 7063 2e63 6f6e 6e65  t self.rpc.conne
-00039110: 6374 2861 6464 7229 0a20 2020 2020 2020  ct(addr).       
-00039120: 2020 2020 2020 2020 2063 6f6d 6d2e 6e61           comm.na
-00039130: 6d65 203d 2022 5363 6865 6475 6c65 7220  me = "Scheduler 
-00039140: 4272 6f61 6463 6173 7422 0a20 2020 2020  Broadcast".     
-00039150: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-00039160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039170: 2020 2020 7265 7370 203d 2061 7761 6974      resp = await
-00039180: 2073 656e 645f 7265 6376 280a 2020 2020   send_recv(.    
-00039190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000391a0: 2020 2020 636f 6d6d 2c20 636c 6f73 653d      comm, close=
-000391b0: 5472 7565 2c20 7365 7269 616c 697a 6572  True, serializer
-000391c0: 733d 7365 7269 616c 697a 6572 732c 202a  s=serializers, *
-000391d0: 2a6d 7367 0a20 2020 2020 2020 2020 2020  *msg.           
-000391e0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-000391f0: 2020 2020 2020 2020 2020 2066 696e 616c             final
-00039200: 6c79 3a0a 2020 2020 2020 2020 2020 2020  ly:.            
-00039210: 2020 2020 2020 2020 7365 6c66 2e72 7063          self.rpc
-00039220: 2e72 6575 7365 2861 6464 722c 2063 6f6d  .reuse(addr, com
-00039230: 6d29 0a20 2020 2020 2020 2020 2020 2020  m).             
-00039240: 2020 2072 6574 7572 6e20 7265 7370 0a20     return resp. 
-00039250: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-00039260: 7420 4578 6365 7074 696f 6e20 6173 2065  t Exception as e
-00039270: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00039280: 2020 6c6f 6767 6572 2e65 7272 6f72 2866    logger.error(f
-00039290: 2262 726f 6164 6361 7374 2074 6f20 7b61  "broadcast to {a
-000392a0: 6464 727d 2066 6169 6c65 643a 207b 652e  ddr} failed: {e.
-000392b0: 5f5f 636c 6173 735f 5f2e 5f5f 6e61 6d65  __class__.__name
-000392c0: 5f5f 7d3a 207b 657d 2229 0a20 2020 2020  __}: {e}").     
-000392d0: 2020 2020 2020 2020 2020 2069 6620 6f6e             if on
-000392e0: 5f65 7272 6f72 203d 3d20 2272 6169 7365  _error == "raise
-000392f0: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
-00039300: 2020 2020 2020 2072 6169 7365 0a20 2020         raise.   
-00039310: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
-00039320: 6620 6f6e 5f65 7272 6f72 203d 3d20 2272  f on_error == "r
-00039330: 6574 7572 6e22 3a0a 2020 2020 2020 2020  eturn":.        
-00039340: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00039350: 726e 2065 0a20 2020 2020 2020 2020 2020  rn e.           
-00039360: 2020 2020 2065 6c69 6620 6f6e 5f65 7272       elif on_err
-00039370: 6f72 203d 3d20 2272 6574 7572 6e5f 7069  or == "return_pi
-00039380: 636b 6c65 223a 0a20 2020 2020 2020 2020  ckle":.         
-00039390: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-000393a0: 6e20 6475 6d70 7328 6529 0a20 2020 2020  n dumps(e).     
-000393b0: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-000393c0: 6f6e 5f65 7272 6f72 203d 3d20 2269 676e  on_error == "ign
-000393d0: 6f72 6522 3a0a 2020 2020 2020 2020 2020  ore":.          
-000393e0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-000393f0: 2045 5252 4f52 0a20 2020 2020 2020 2020   ERROR.         
-00039400: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00039410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039420: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-00039430: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-00039440: 2020 2020 2020 2020 2020 2022 6f6e 5f65             "on_e
-00039450: 7272 6f72 206d 7573 7420 6265 2027 7261  rror must be 'ra
-00039460: 6973 6527 2c20 2772 6574 7572 6e27 2c20  ise', 'return', 
-00039470: 2772 6574 7572 6e5f 7069 636b 6c65 272c  'return_pickle',
-00039480: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-00039490: 2020 2020 2020 2020 2020 2066 226f 7220             f"or 
-000394a0: 2769 676e 6f72 6527 3b20 676f 7420 7b6f  'ignore'; got {o
-000394b0: 6e5f 6572 726f 7221 727d 220a 2020 2020  n_error!r}".    
-000394c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000394d0: 290a 0a20 2020 2020 2020 2072 6573 756c  )..        resul
-000394e0: 7473 203d 2061 7761 6974 2041 6c6c 285b  ts = await All([
-000394f0: 7365 6e64 5f6d 6573 7361 6765 2861 6464  send_message(add
-00039500: 7265 7373 2920 666f 7220 6164 6472 6573  ress) for addres
-00039510: 7320 696e 2061 6464 7265 7373 6573 5d29  s in addresses])
-00039520: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00039530: 7b6b 3a20 7620 666f 7220 6b2c 2076 2069  {k: v for k, v i
-00039540: 6e20 7a69 7028 776f 726b 6572 732c 2072  n zip(workers, r
-00039550: 6573 756c 7473 2920 6966 2076 2069 7320  esults) if v is 
-00039560: 6e6f 7420 4552 524f 527d 0a0a 2020 2020  not ERROR}..    
-00039570: 6173 796e 6320 6465 6620 7072 6f78 7928  async def proxy(
-00039580: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-00039590: 2020 2020 2020 206d 7367 3a20 6469 6374         msg: dict
-000395a0: 2c0a 2020 2020 2020 2020 776f 726b 6572  ,.        worker
-000395b0: 3a20 7374 722c 0a20 2020 2020 2020 2073  : str,.        s
-000395c0: 6572 6961 6c69 7a65 7273 3a20 416e 7920  erializers: Any 
-000395d0: 3d20 4e6f 6e65 2c0a 2020 2020 2920 2d3e  = None,.    ) ->
-000395e0: 2041 6e79 3a0a 2020 2020 2020 2020 2222   Any:.        ""
-000395f0: 2250 726f 7879 2061 2063 6f6d 6d75 6e69  "Proxy a communi
-00039600: 6361 7469 6f6e 2074 6872 6f75 6768 2074  cation through t
-00039610: 6865 2073 6368 6564 756c 6572 2074 6f20  he scheduler to 
-00039620: 736f 6d65 206f 7468 6572 2077 6f72 6b65  some other worke
-00039630: 7222 2222 0a20 2020 2020 2020 2064 203d  r""".        d =
-00039640: 2061 7761 6974 2073 656c 662e 6272 6f61   await self.broa
-00039650: 6463 6173 7428 6d73 673d 6d73 672c 2077  dcast(msg=msg, w
-00039660: 6f72 6b65 7273 3d5b 776f 726b 6572 5d2c  orkers=[worker],
-00039670: 2073 6572 6961 6c69 7a65 7273 3d73 6572   serializers=ser
-00039680: 6961 6c69 7a65 7273 290a 2020 2020 2020  ializers).      
-00039690: 2020 7265 7475 726e 2064 5b77 6f72 6b65    return d[worke
-000396a0: 725d 0a0a 2020 2020 6173 796e 6320 6465  r]..    async de
-000396b0: 6620 6761 7468 6572 5f6f 6e5f 776f 726b  f gather_on_work
-000396c0: 6572 280a 2020 2020 2020 2020 7365 6c66  er(.        self
-000396d0: 2c20 776f 726b 6572 5f61 6464 7265 7373  , worker_address
-000396e0: 3a20 7374 722c 2077 686f 5f68 6173 3a20  : str, who_has: 
-000396f0: 6469 6374 5b4b 6579 2c20 6c69 7374 5b73  dict[Key, list[s
-00039700: 7472 5d5d 0a20 2020 2029 202d 3e20 7365  tr]].    ) -> se
-00039710: 743a 0a20 2020 2020 2020 2022 2222 5065  t:.        """Pe
-00039720: 6572 2d74 6f2d 7065 6572 2063 6f70 7920  er-to-peer copy 
-00039730: 6f66 206b 6579 7320 6672 6f6d 206d 756c  of keys from mul
-00039740: 7469 706c 6520 776f 726b 6572 7320 746f  tiple workers to
-00039750: 2061 2073 696e 676c 6520 776f 726b 6572   a single worker
-00039760: 0a0a 2020 2020 2020 2020 5061 7261 6d65  ..        Parame
-00039770: 7465 7273 0a20 2020 2020 2020 202d 2d2d  ters.        ---
-00039780: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
-00039790: 776f 726b 6572 5f61 6464 7265 7373 3a20  worker_address: 
-000397a0: 7374 720a 2020 2020 2020 2020 2020 2020  str.            
-000397b0: 5265 6369 7069 656e 7420 776f 726b 6572  Recipient worker
-000397c0: 2061 6464 7265 7373 2074 6f20 636f 7079   address to copy
-000397d0: 206b 6579 7320 746f 0a20 2020 2020 2020   keys to.       
-000397e0: 2077 686f 5f68 6173 3a20 6469 6374 5b4b   who_has: dict[K
-000397f0: 6579 2c20 6c69 7374 5b73 7472 5d5d 0a20  ey, list[str]]. 
-00039800: 2020 2020 2020 2020 2020 207b 6b65 793a             {key:
-00039810: 205b 7365 6e64 6572 2061 6464 7265 7373   [sender address
-00039820: 2c20 7365 6e64 6572 2061 6464 7265 7373  , sender address
-00039830: 2c20 2e2e 2e5d 2c20 6b65 793a 202e 2e2e  , ...], key: ...
-00039840: 7d0a 0a20 2020 2020 2020 2052 6574 7572  }..        Retur
-00039850: 6e73 0a20 2020 2020 2020 202d 2d2d 2d2d  ns.        -----
-00039860: 2d2d 0a20 2020 2020 2020 2072 6574 7572  --.        retur
-00039870: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
-00039880: 7365 7420 6f66 206b 6579 7320 7468 6174  set of keys that
-00039890: 2066 6169 6c65 6420 746f 2062 6520 636f   failed to be co
-000398a0: 7069 6564 0a20 2020 2020 2020 2022 2222  pied.        """
-000398b0: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-000398c0: 2020 2020 2020 2020 2020 7265 7375 6c74            result
-000398d0: 203d 2061 7761 6974 2072 6574 7279 5f6f   = await retry_o
-000398e0: 7065 7261 7469 6f6e 280a 2020 2020 2020  peration(.      
-000398f0: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
-00039900: 7063 2861 6464 723d 776f 726b 6572 5f61  pc(addr=worker_a
-00039910: 6464 7265 7373 292e 6761 7468 6572 2c20  ddress).gather, 
-00039920: 7768 6f5f 6861 733d 7768 6f5f 6861 730a  who_has=who_has.
-00039930: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00039940: 2020 2020 2020 6578 6365 7074 204f 5345        except OSE
-00039950: 7272 6f72 2061 7320 653a 0a20 2020 2020  rror as e:.     
-00039960: 2020 2020 2020 2023 2054 6869 7320 6361         # This ca
-00039970: 6e20 6861 7070 656e 2065 2e67 2e20 6966  n happen e.g. if
-00039980: 2074 6865 2077 6f72 6b65 7220 6973 2067   the worker is g
-00039990: 6f69 6e67 2074 6872 6f75 6768 2063 6f6e  oing through con
-000399a0: 7472 6f6c 6c65 6420 7368 7574 646f 776e  trolled shutdown
-000399b0: 3b0a 2020 2020 2020 2020 2020 2020 2320  ;.            # 
-000399c0: 6974 2064 6f65 736e 2774 206e 6563 6573  it doesn't neces
-000399d0: 7361 7269 6c79 206d 6561 6e20 7468 6174  sarily mean that
-000399e0: 2069 7420 7765 6e74 2075 6e65 7870 6563   it went unexpec
-000399f0: 7465 646c 7920 6d69 7373 696e 670a 2020  tedly missing.  
-00039a00: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-00039a10: 2e77 6172 6e69 6e67 280a 2020 2020 2020  .warning(.      
-00039a20: 2020 2020 2020 2020 2020 6622 436f 6d6d            f"Comm
-00039a30: 756e 6963 6174 696f 6e20 7769 7468 2077  unication with w
-00039a40: 6f72 6b65 7220 7b77 6f72 6b65 725f 6164  orker {worker_ad
-00039a50: 6472 6573 737d 2066 6169 6c65 6420 6475  dress} failed du
-00039a60: 7269 6e67 2022 0a20 2020 2020 2020 2020  ring ".         
-00039a70: 2020 2020 2020 2066 2272 6570 6c69 6361         f"replica
-00039a80: 7469 6f6e 3a20 7b65 2e5f 5f63 6c61 7373  tion: {e.__class
-00039a90: 5f5f 2e5f 5f6e 616d 655f 5f7d 3a20 7b65  __.__name__}: {e
-00039aa0: 7d22 0a20 2020 2020 2020 2020 2020 2029  }".            )
-00039ab0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00039ac0: 7572 6e20 7365 7428 7768 6f5f 6861 7329  urn set(who_has)
-00039ad0: 0a0a 2020 2020 2020 2020 7773 203d 2073  ..        ws = s
-00039ae0: 656c 662e 776f 726b 6572 732e 6765 7428  elf.workers.get(
-00039af0: 776f 726b 6572 5f61 6464 7265 7373 290a  worker_address).
-00039b00: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-00039b10: 7773 3a0a 2020 2020 2020 2020 2020 2020  ws:.            
-00039b20: 6c6f 6767 6572 2e77 6172 6e69 6e67 2866  logger.warning(f
-00039b30: 2257 6f72 6b65 7220 7b77 6f72 6b65 725f  "Worker {worker_
-00039b40: 6164 6472 6573 737d 206c 6f73 7420 6475  address} lost du
-00039b50: 7269 6e67 2072 6570 6c69 6361 7469 6f6e  ring replication
-00039b60: 2229 0a20 2020 2020 2020 2020 2020 2072  ").            r
-00039b70: 6574 7572 6e20 7365 7428 7768 6f5f 6861  eturn set(who_ha
-00039b80: 7329 0a20 2020 2020 2020 2065 6c69 6620  s).        elif 
-00039b90: 7265 7375 6c74 5b22 7374 6174 7573 225d  result["status"]
-00039ba0: 203d 3d20 224f 4b22 3a0a 2020 2020 2020   == "OK":.      
-00039bb0: 2020 2020 2020 6b65 7973 5f66 6169 6c65        keys_faile
-00039bc0: 6420 3d20 7365 7428 290a 2020 2020 2020  d = set().      
-00039bd0: 2020 2020 2020 6b65 7973 5f6f 6b3a 2053        keys_ok: S
-00039be0: 6574 203d 2077 686f 5f68 6173 2e6b 6579  et = who_has.key
-00039bf0: 7328 290a 2020 2020 2020 2020 656c 6966  s().        elif
-00039c00: 2072 6573 756c 745b 2273 7461 7475 7322   result["status"
-00039c10: 5d20 3d3d 2022 7061 7274 6961 6c2d 6661  ] == "partial-fa
-00039c20: 696c 223a 0a20 2020 2020 2020 2020 2020  il":.           
-00039c30: 206b 6579 735f 6661 696c 6564 203d 2073   keys_failed = s
-00039c40: 6574 2872 6573 756c 745b 226b 6579 7322  et(result["keys"
-00039c50: 5d29 0a20 2020 2020 2020 2020 2020 206b  ]).            k
-00039c60: 6579 735f 6f6b 203d 2077 686f 5f68 6173  eys_ok = who_has
-00039c70: 2e6b 6579 7328 2920 2d20 6b65 7973 5f66  .keys() - keys_f
-00039c80: 6169 6c65 640a 2020 2020 2020 2020 2020  ailed.          
-00039c90: 2020 6c6f 6767 6572 2e77 6172 6e69 6e67    logger.warning
-00039ca0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00039cb0: 2020 6622 576f 726b 6572 207b 776f 726b    f"Worker {work
-00039cc0: 6572 5f61 6464 7265 7373 7d20 6661 696c  er_address} fail
-00039cd0: 6564 2074 6f20 6163 7175 6972 6520 6b65  ed to acquire ke
-00039ce0: 7973 3a20 7b72 6573 756c 745b 276b 6579  ys: {result['key
-00039cf0: 7327 5d7d 220a 2020 2020 2020 2020 2020  s']}".          
-00039d00: 2020 290a 2020 2020 2020 2020 656c 7365    ).        else
-00039d10: 3a20 2023 2070 7261 676d 613a 206e 6f63  :  # pragma: noc
-00039d20: 6f76 6572 0a20 2020 2020 2020 2020 2020  over.           
-00039d30: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-00039d40: 7228 6622 556e 6578 7065 6374 6564 206d  r(f"Unexpected m
-00039d50: 6573 7361 6765 2066 726f 6d20 7b77 6f72  essage from {wor
-00039d60: 6b65 725f 6164 6472 6573 737d 3a20 7b72  ker_address}: {r
-00039d70: 6573 756c 747d 2229 0a0a 2020 2020 2020  esult}")..      
-00039d80: 2020 666f 7220 6b65 7920 696e 206b 6579    for key in key
-00039d90: 735f 6f6b 3a0a 2020 2020 2020 2020 2020  s_ok:.          
-00039da0: 2020 7473 203d 2073 656c 662e 7461 736b    ts = self.task
-00039db0: 732e 6765 7428 6b65 7929 0a20 2020 2020  s.get(key).     
-00039dc0: 2020 2020 2020 2069 6620 7473 2069 7320         if ts is 
-00039dd0: 4e6f 6e65 206f 7220 7473 2e73 7461 7465  None or ts.state
-00039de0: 2021 3d20 226d 656d 6f72 7922 3a0a 2020   != "memory":.  
-00039df0: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-00039e00: 6767 6572 2e77 6172 6e69 6e67 2866 224b  gger.warning(f"K
-00039e10: 6579 206c 6f73 7420 6475 7269 6e67 2072  ey lost during r
-00039e20: 6570 6c69 6361 7469 6f6e 3a20 7b6b 6579  eplication: {key
-00039e30: 7d22 290a 2020 2020 2020 2020 2020 2020  }").            
-00039e40: 2020 2020 636f 6e74 696e 7565 0a20 2020      continue.   
-00039e50: 2020 2020 2020 2020 2073 656c 662e 6164           self.ad
-00039e60: 645f 7265 706c 6963 6128 7473 2c20 7773  d_replica(ts, ws
-00039e70: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
-00039e80: 6e20 6b65 7973 5f66 6169 6c65 640a 0a20  n keys_failed.. 
-00039e90: 2020 2061 7379 6e63 2064 6566 2064 656c     async def del
-00039ea0: 6574 655f 776f 726b 6572 5f64 6174 6128  ete_worker_data(
-00039eb0: 0a20 2020 2020 2020 2073 656c 662c 2077  .        self, w
-00039ec0: 6f72 6b65 725f 6164 6472 6573 733a 2073  orker_address: s
-00039ed0: 7472 2c20 6b65 7973 3a20 436f 6c6c 6563  tr, keys: Collec
-00039ee0: 7469 6f6e 5b4b 6579 5d2c 2073 7469 6d75  tion[Key], stimu
-00039ef0: 6c75 735f 6964 3a20 7374 720a 2020 2020  lus_id: str.    
-00039f00: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-00039f10: 2020 2022 2222 4465 6c65 7465 2064 6174     """Delete dat
-00039f20: 6120 6672 6f6d 2061 2077 6f72 6b65 7220  a from a worker 
-00039f30: 616e 6420 7570 6461 7465 2074 6865 2063  and update the c
-00039f40: 6f72 7265 7370 6f6e 6469 6e67 2077 6f72  orresponding wor
-00039f50: 6b65 722f 7461 736b 2073 7461 7465 730a  ker/task states.
-00039f60: 0a20 2020 2020 2020 2050 6172 616d 6574  .        Paramet
-00039f70: 6572 730a 2020 2020 2020 2020 2d2d 2d2d  ers.        ----
-00039f80: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2077  ------.        w
-00039f90: 6f72 6b65 725f 6164 6472 6573 733a 2073  orker_address: s
-00039fa0: 7472 0a20 2020 2020 2020 2020 2020 2057  tr.            W
-00039fb0: 6f72 6b65 7220 6164 6472 6573 7320 746f  orker address to
-00039fc0: 2064 656c 6574 6520 6b65 7973 2066 726f   delete keys fro
-00039fd0: 6d0a 2020 2020 2020 2020 6b65 7973 3a20  m.        keys: 
-00039fe0: 6c69 7374 5b4b 6579 5d0a 2020 2020 2020  list[Key].      
-00039ff0: 2020 2020 2020 4c69 7374 206f 6620 6b65        List of ke
-0003a000: 7973 2074 6f20 6465 6c65 7465 206f 6e20  ys to delete on 
-0003a010: 7468 6520 7370 6563 6966 6965 6420 776f  the specified wo
-0003a020: 726b 6572 0a20 2020 2020 2020 2022 2222  rker.        """
-0003a030: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-0003a040: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-0003a050: 7265 7472 795f 6f70 6572 6174 696f 6e28  retry_operation(
-0003a060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003a070: 2073 656c 662e 7270 6328 6164 6472 3d77   self.rpc(addr=w
-0003a080: 6f72 6b65 725f 6164 6472 6573 7329 2e66  orker_address).f
-0003a090: 7265 655f 6b65 7973 2c0a 2020 2020 2020  ree_keys,.      
-0003a0a0: 2020 2020 2020 2020 2020 6b65 7973 3d6c            keys=l
-0003a0b0: 6973 7428 6b65 7973 292c 0a20 2020 2020  ist(keys),.     
-0003a0c0: 2020 2020 2020 2020 2020 2073 7469 6d75             stimu
-0003a0d0: 6c75 735f 6964 3d66 2264 656c 6574 652d  lus_id=f"delete-
-0003a0e0: 6461 7461 2d7b 7469 6d65 2829 7d22 2c0a  data-{time()}",.
-0003a0f0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0003a100: 2020 2020 2020 6578 6365 7074 204f 5345        except OSE
-0003a110: 7272 6f72 2061 7320 653a 0a20 2020 2020  rror as e:.     
-0003a120: 2020 2020 2020 2023 2054 6869 7320 6361         # This ca
-0003a130: 6e20 6861 7070 656e 2065 2e67 2e20 6966  n happen e.g. if
-0003a140: 2074 6865 2077 6f72 6b65 7220 6973 2067   the worker is g
-0003a150: 6f69 6e67 2074 6872 6f75 6768 2063 6f6e  oing through con
-0003a160: 7472 6f6c 6c65 6420 7368 7574 646f 776e  trolled shutdown
-0003a170: 3b0a 2020 2020 2020 2020 2020 2020 2320  ;.            # 
-0003a180: 6974 2064 6f65 736e 2774 206e 6563 6573  it doesn't neces
-0003a190: 7361 7269 6c79 206d 6561 6e20 7468 6174  sarily mean that
-0003a1a0: 2069 7420 7765 6e74 2075 6e65 7870 6563   it went unexpec
-0003a1b0: 7465 646c 7920 6d69 7373 696e 670a 2020  tedly missing.  
-0003a1c0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-0003a1d0: 2e77 6172 6e69 6e67 280a 2020 2020 2020  .warning(.      
-0003a1e0: 2020 2020 2020 2020 2020 6622 436f 6d6d            f"Comm
-0003a1f0: 756e 6963 6174 696f 6e20 7769 7468 2077  unication with w
-0003a200: 6f72 6b65 7220 7b77 6f72 6b65 725f 6164  orker {worker_ad
-0003a210: 6472 6573 737d 2066 6169 6c65 6420 6475  dress} failed du
-0003a220: 7269 6e67 2022 0a20 2020 2020 2020 2020  ring ".         
-0003a230: 2020 2020 2020 2066 2272 6570 6c69 6361         f"replica
-0003a240: 7469 6f6e 3a20 7b65 2e5f 5f63 6c61 7373  tion: {e.__class
-0003a250: 5f5f 2e5f 5f6e 616d 655f 5f7d 3a20 7b65  __.__name__}: {e
-0003a260: 7d22 0a20 2020 2020 2020 2020 2020 2029  }".            )
-0003a270: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0003a280: 7572 6e0a 0a20 2020 2020 2020 2077 7320  urn..        ws 
-0003a290: 3d20 7365 6c66 2e77 6f72 6b65 7273 2e67  = self.workers.g
-0003a2a0: 6574 2877 6f72 6b65 725f 6164 6472 6573  et(worker_addres
-0003a2b0: 7329 0a20 2020 2020 2020 2069 6620 6e6f  s).        if no
-0003a2c0: 7420 7773 3a0a 2020 2020 2020 2020 2020  t ws:.          
-0003a2d0: 2020 7265 7475 726e 0a0a 2020 2020 2020    return..      
-0003a2e0: 2020 666f 7220 6b65 7920 696e 206b 6579    for key in key
-0003a2f0: 733a 0a20 2020 2020 2020 2020 2020 2074  s:.            t
-0003a300: 7320 3d20 7365 6c66 2e74 6173 6b73 2e67  s = self.tasks.g
-0003a310: 6574 286b 6579 290a 2020 2020 2020 2020  et(key).        
-0003a320: 2020 2020 6966 2074 7320 6973 206e 6f74      if ts is not
-0003a330: 204e 6f6e 6520 616e 6420 7773 2069 6e20   None and ws in 
-0003a340: 2874 732e 7768 6f5f 6861 7320 6f72 2028  (ts.who_has or (
-0003a350: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-0003a360: 2020 2020 6173 7365 7274 2074 732e 7374      assert ts.st
-0003a370: 6174 6520 3d3d 2022 6d65 6d6f 7279 220a  ate == "memory".
-0003a380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a390: 7365 6c66 2e72 656d 6f76 655f 7265 706c  self.remove_repl
-0003a3a0: 6963 6128 7473 2c20 7773 290a 2020 2020  ica(ts, ws).    
-0003a3b0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-0003a3c0: 6f74 2074 732e 7768 6f5f 6861 733a 0a20  ot ts.who_has:. 
-0003a3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a3e0: 2020 2023 204c 6173 7420 636f 7079 2064     # Last copy d
-0003a3f0: 656c 6574 6564 0a20 2020 2020 2020 2020  eleted.         
-0003a400: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0003a410: 7472 616e 7369 7469 6f6e 7328 7b6b 6579  transitions({key
-0003a420: 3a20 2272 656c 6561 7365 6422 7d2c 2073  : "released"}, s
-0003a430: 7469 6d75 6c75 735f 6964 290a 0a20 2020  timulus_id)..   
-0003a440: 2020 2020 2073 656c 662e 6c6f 675f 6576       self.log_ev
-0003a450: 656e 7428 7773 2e61 6464 7265 7373 2c20  ent(ws.address, 
-0003a460: 7b22 6163 7469 6f6e 223a 2022 7265 6d6f  {"action": "remo
-0003a470: 7665 2d77 6f72 6b65 722d 6461 7461 222c  ve-worker-data",
-0003a480: 2022 6b65 7973 223a 206b 6579 737d 290a   "keys": keys}).
-0003a490: 0a20 2020 2040 6c6f 675f 6572 726f 7273  .    @log_errors
-0003a4a0: 0a20 2020 2061 7379 6e63 2064 6566 2072  .    async def r
-0003a4b0: 6562 616c 616e 6365 280a 2020 2020 2020  ebalance(.      
-0003a4c0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-0003a4d0: 6b65 7973 3a20 4974 6572 6162 6c65 5b4b  keys: Iterable[K
-0003a4e0: 6579 5d20 7c20 4e6f 6e65 203d 204e 6f6e  ey] | None = Non
-0003a4f0: 652c 0a20 2020 2020 2020 2077 6f72 6b65  e,.        worke
-0003a500: 7273 3a20 4974 6572 6162 6c65 5b73 7472  rs: Iterable[str
-0003a510: 5d20 7c20 4e6f 6e65 203d 204e 6f6e 652c  ] | None = None,
-0003a520: 0a20 2020 2020 2020 2073 7469 6d75 6c75  .        stimulu
-0003a530: 735f 6964 3a20 7374 7220 7c20 4e6f 6e65  s_id: str | None
-0003a540: 203d 204e 6f6e 652c 0a20 2020 2029 202d   = None,.    ) -
-0003a550: 3e20 6469 6374 3a0a 2020 2020 2020 2020  > dict:.        
-0003a560: 2222 2252 6562 616c 616e 6365 206b 6579  """Rebalance key
-0003a570: 7320 736f 2074 6861 7420 6561 6368 2077  s so that each w
-0003a580: 6f72 6b65 7220 656e 6473 2075 7020 7769  orker ends up wi
-0003a590: 7468 2072 6f75 6768 6c79 2074 6865 2073  th roughly the s
-0003a5a0: 616d 6520 7072 6f63 6573 730a 2020 2020  ame process.    
-0003a5b0: 2020 2020 6d65 6d6f 7279 2028 6d61 6e61      memory (mana
-0003a5c0: 6765 642b 756e 6d61 6e61 6765 6429 2e0a  ged+unmanaged)..
-0003a5d0: 0a20 2020 2020 2020 202e 2e20 7761 726e  .        .. warn
-0003a5e0: 696e 673a 3a0a 2020 2020 2020 2020 2020  ing::.          
-0003a5f0: 2054 6869 7320 6f70 6572 6174 696f 6e20   This operation 
-0003a600: 6973 2067 656e 6572 616c 6c79 206e 6f74  is generally not
-0003a610: 2077 656c 6c20 7465 7374 6564 2061 6761   well tested aga
-0003a620: 696e 7374 206e 6f72 6d61 6c20 6f70 6572  inst normal oper
-0003a630: 6174 696f 6e20 6f66 2074 6865 0a20 2020  ation of the.   
-0003a640: 2020 2020 2020 2020 7363 6865 6475 6c65          schedule
-0003a650: 722e 2049 7420 6973 206e 6f74 2072 6563  r. It is not rec
-0003a660: 6f6d 6d65 6e64 6564 2074 6f20 7573 6520  ommended to use 
-0003a670: 6974 2077 6869 6c65 2077 6169 7469 6e67  it while waiting
-0003a680: 206f 6e20 636f 6d70 7574 6174 696f 6e73   on computations
-0003a690: 2e0a 0a20 2020 2020 2020 202a 2a41 6c67  ...        **Alg
-0003a6a0: 6f72 6974 686d 2a2a 0a0a 2020 2020 2020  orithm**..      
-0003a6b0: 2020 232e 2046 696e 6420 7468 6520 6d65    #. Find the me
-0003a6c0: 616e 206f 6363 7570 616e 6379 206f 6620  an occupancy of 
-0003a6d0: 7468 6520 636c 7573 7465 722c 2064 6566  the cluster, def
-0003a6e0: 696e 6564 2061 7320 6461 7461 206d 616e  ined as data man
-0003a6f0: 6167 6564 2062 7920 6461 736b 202b 0a20  aged by dask +. 
-0003a700: 2020 2020 2020 2020 2020 756e 6d61 6e61            unmana
-0003a710: 6765 6420 7072 6f63 6573 7320 6d65 6d6f  ged process memo
-0003a720: 7279 2074 6861 7420 6861 7320 6265 656e  ry that has been
-0003a730: 2074 6865 7265 2066 6f72 2061 7420 6c65   there for at le
-0003a740: 6173 7420 3330 2073 6563 6f6e 6473 0a20  ast 30 seconds. 
-0003a750: 2020 2020 2020 2020 2020 2860 6064 6973            (``dis
-0003a760: 7472 6962 7574 6564 2e77 6f72 6b65 722e  tributed.worker.
-0003a770: 6d65 6d6f 7279 2e72 6563 656e 742d 746f  memory.recent-to
-0003a780: 2d6f 6c64 2d74 696d 6560 6029 2e0a 2020  -old-time``)..  
-0003a790: 2020 2020 2020 2020 2054 6869 7320 6c65           This le
-0003a7a0: 7473 2075 7320 6967 6e6f 7265 2074 656d  ts us ignore tem
-0003a7b0: 706f 7261 7279 2073 7069 6b65 7320 6361  porary spikes ca
-0003a7c0: 7573 6564 2062 7920 7461 736b 2068 6561  used by task hea
-0003a7d0: 7020 7573 6167 652e 0a0a 2020 2020 2020  p usage...      
-0003a7e0: 2020 2020 2041 6c74 6572 6e61 7469 7665       Alternative
-0003a7f0: 6c79 2c20 796f 7520 6d61 7920 6368 616e  ly, you may chan
-0003a800: 6765 2068 6f77 206d 656d 6f72 7920 6973  ge how memory is
-0003a810: 206d 6561 7375 7265 6420 626f 7468 2066   measured both f
-0003a820: 6f72 2074 6865 2069 6e64 6976 6964 7561  or the individua
-0003a830: 6c0a 2020 2020 2020 2020 2020 2077 6f72  l.           wor
-0003a840: 6b65 7273 2061 7320 7765 6c6c 2061 7320  kers as well as 
-0003a850: 746f 2063 616c 6375 6c61 7465 2074 6865  to calculate the
-0003a860: 206d 6561 6e20 7468 726f 7567 680a 2020   mean through.  
-0003a870: 2020 2020 2020 2020 2060 6064 6973 7472           ``distr
-0003a880: 6962 7574 6564 2e77 6f72 6b65 722e 6d65  ibuted.worker.me
-0003a890: 6d6f 7279 2e72 6562 616c 616e 6365 2e6d  mory.rebalance.m
-0003a8a0: 6561 7375 7265 6060 2e20 4e61 6d65 6c79  easure``. Namely
-0003a8b0: 2c20 7468 6973 2063 616e 2062 6520 7573  , this can be us
-0003a8c0: 6566 756c 0a20 2020 2020 2020 2020 2020  eful.           
-0003a8d0: 746f 2064 6973 7265 6761 7264 2069 6e61  to disregard ina
-0003a8e0: 6363 7572 6174 6520 4f53 206d 656d 6f72  ccurate OS memor
-0003a8f0: 7920 6d65 6173 7572 656d 656e 7473 2e0a  y measurements..
-0003a900: 0a20 2020 2020 2020 2023 2e20 4469 7363  .        #. Disc
-0003a910: 6172 6420 776f 726b 6572 7320 7768 6f73  ard workers whos
-0003a920: 6520 6f63 6375 7061 6e63 7920 6973 2077  e occupancy is w
-0003a930: 6974 6869 6e20 3525 206f 6620 7468 6520  ithin 5% of the 
-0003a940: 6d65 616e 2063 6c75 7374 6572 206f 6363  mean cluster occ
-0003a950: 7570 616e 6379 0a20 2020 2020 2020 2020  upancy.         
-0003a960: 2020 2860 6064 6973 7472 6962 7574 6564    (``distributed
-0003a970: 2e77 6f72 6b65 722e 6d65 6d6f 7279 2e72  .worker.memory.r
-0003a980: 6562 616c 616e 6365 2e73 656e 6465 722d  ebalance.sender-
-0003a990: 7265 6369 7069 656e 742d 6761 7060 6020  recipient-gap`` 
-0003a9a0: 2f20 3229 2e0a 2020 2020 2020 2020 2020  / 2)..          
-0003a9b0: 2054 6869 7320 6865 6c70 7320 6176 6f69   This helps avoi
-0003a9c0: 6420 6461 7461 2066 726f 6d20 626f 756e  d data from boun
-0003a9d0: 6369 6e67 2061 726f 756e 6420 7468 6520  cing around the 
-0003a9e0: 636c 7573 7465 7220 7265 7065 6174 6564  cluster repeated
-0003a9f0: 6c79 2e0a 2020 2020 2020 2020 232e 2057  ly..        #. W
-0003aa00: 6f72 6b65 7273 2061 626f 7665 2074 6865  orkers above the
-0003aa10: 206d 6561 6e20 6172 6520 7365 6e64 6572   mean are sender
-0003aa20: 733b 2074 686f 7365 2062 656c 6f77 2061  s; those below a
-0003aa30: 7265 2072 6563 6970 6965 6e74 732e 0a20  re recipients.. 
-0003aa40: 2020 2020 2020 2023 2e20 4469 7363 6172         #. Discar
-0003aa50: 6420 7365 6e64 6572 7320 7768 6f73 6520  d senders whose 
-0003aa60: 6162 736f 6c75 7465 206f 6363 7570 616e  absolute occupan
-0003aa70: 6379 2069 7320 6265 6c6f 7720 3330 250a  cy is below 30%.
-0003aa80: 2020 2020 2020 2020 2020 2028 6060 6469             (``di
-0003aa90: 7374 7269 6275 7465 642e 776f 726b 6572  stributed.worker
-0003aaa0: 2e6d 656d 6f72 792e 7265 6261 6c61 6e63  .memory.rebalanc
-0003aab0: 652e 7365 6e64 6572 2d6d 696e 6060 292e  e.sender-min``).
-0003aac0: 2049 6e20 6f74 6865 7220 776f 7264 732c   In other words,
-0003aad0: 206e 6f20 6461 7461 0a20 2020 2020 2020   no data.       
-0003aae0: 2020 2020 6973 206d 6f76 6564 2072 6567      is moved reg
-0003aaf0: 6172 646c 6573 7320 6f66 2069 6d62 616c  ardless of imbal
-0003ab00: 616e 6369 6e67 2061 7320 6c6f 6e67 2061  ancing as long a
-0003ab10: 7320 616c 6c20 776f 726b 6572 7320 6172  s all workers ar
-0003ab20: 6520 6265 6c6f 7720 3330 252e 0a20 2020  e below 30%..   
-0003ab30: 2020 2020 2023 2e20 4469 7363 6172 6420       #. Discard 
-0003ab40: 7265 6369 7069 656e 7473 2077 686f 7365  recipients whose
-0003ab50: 2061 6273 6f6c 7574 6520 6f63 6375 7061   absolute occupa
-0003ab60: 6e63 7920 6973 2061 626f 7665 2036 3025  ncy is above 60%
-0003ab70: 0a20 2020 2020 2020 2020 2020 2860 6064  .           (``d
-0003ab80: 6973 7472 6962 7574 6564 2e77 6f72 6b65  istributed.worke
-0003ab90: 722e 6d65 6d6f 7279 2e72 6562 616c 616e  r.memory.rebalan
-0003aba0: 6365 2e72 6563 6970 6965 6e74 2d6d 6178  ce.recipient-max
-0003abb0: 6060 292e 0a20 2020 2020 2020 2020 2020  ``)..           
-0003abc0: 4e6f 7465 2074 6861 7420 7468 6973 2074  Note that this t
-0003abd0: 6872 6573 686f 6c64 2062 7920 6465 6661  hreshold by defa
-0003abe0: 756c 7420 6973 2074 6865 2073 616d 6520  ult is the same 
-0003abf0: 6173 0a20 2020 2020 2020 2020 2020 6060  as.           ``
-0003ac00: 6469 7374 7269 6275 7465 642e 776f 726b  distributed.work
-0003ac10: 6572 2e6d 656d 6f72 792e 7461 7267 6574  er.memory.target
-0003ac20: 6060 2074 6f20 7072 6576 656e 7420 776f  `` to prevent wo
-0003ac30: 726b 6572 7320 6672 6f6d 2061 6363 6570  rkers from accep
-0003ac40: 7469 6e67 2064 6174 610a 2020 2020 2020  ting data.      
-0003ac50: 2020 2020 2061 6e64 2069 6d6d 6564 6961       and immedia
-0003ac60: 7465 6c79 2073 7069 6c6c 696e 6720 6974  tely spilling it
-0003ac70: 206f 7574 2074 6f20 6469 736b 2e0a 2020   out to disk..  
-0003ac80: 2020 2020 2020 232e 2049 7465 7261 7469        #. Iterati
-0003ac90: 7665 6c79 2070 6963 6b20 7468 6520 7365  vely pick the se
-0003aca0: 6e64 6572 2061 6e64 2072 6563 6970 6965  nder and recipie
-0003acb0: 6e74 2074 6861 7420 6172 6520 6661 7274  nt that are fart
-0003acc0: 6865 7374 2066 726f 6d20 7468 6520 6d65  hest from the me
-0003acd0: 616e 2061 6e64 0a20 2020 2020 2020 2020  an and.         
-0003ace0: 2020 6d6f 7665 2074 6865 202a 6c65 6173    move the *leas
-0003acf0: 7420 7265 6365 6e74 6c79 2069 6e73 6572  t recently inser
-0003ad00: 7465 642a 206b 6579 2062 6574 7765 656e  ted* key between
-0003ad10: 2074 6865 2074 776f 2c20 756e 7469 6c20   the two, until 
-0003ad20: 6569 7468 6572 2061 6c6c 0a20 2020 2020  either all.     
-0003ad30: 2020 2020 2020 7365 6e64 6572 7320 6f72        senders or
-0003ad40: 2061 6c6c 2072 6563 6970 6965 6e74 7320   all recipients 
-0003ad50: 6661 6c6c 2077 6974 6869 6e20 3525 206f  fall within 5% o
-0003ad60: 6620 7468 6520 6d65 616e 2e0a 0a20 2020  f the mean...   
-0003ad70: 2020 2020 2020 2020 4120 7265 6369 7069          A recipi
-0003ad80: 656e 7420 7769 6c6c 2062 6520 736b 6970  ent will be skip
-0003ad90: 7065 6420 6966 2069 7420 616c 7265 6164  ped if it alread
-0003ada0: 7920 6861 7320 6120 636f 7079 206f 6620  y has a copy of 
-0003adb0: 7468 6520 6461 7461 2e20 496e 206f 7468  the data. In oth
-0003adc0: 6572 0a20 2020 2020 2020 2020 2020 776f  er.           wo
-0003add0: 7264 732c 2074 6869 7320 6d65 7468 6f64  rds, this method
-0003ade0: 2064 6f65 7320 6e6f 7420 6465 6772 6164   does not degrad
-0003adf0: 6520 7265 706c 6963 6174 696f 6e2e 0a20  e replication.. 
-0003ae00: 2020 2020 2020 2020 2020 4120 6b65 7920            A key 
-0003ae10: 7769 6c6c 2062 6520 736b 6970 7065 6420  will be skipped 
-0003ae20: 6966 2074 6865 7265 2061 7265 206e 6f20  if there are no 
-0003ae30: 7265 6369 7069 656e 7473 2061 7661 696c  recipients avail
-0003ae40: 6162 6c65 2077 6974 6820 656e 6f75 6768  able with enough
-0003ae50: 206d 656d 6f72 790a 2020 2020 2020 2020   memory.        
-0003ae60: 2020 2074 6f20 6163 6365 7074 2074 6865     to accept the
-0003ae70: 206b 6579 2061 6e64 2074 6861 7420 646f   key and that do
-0003ae80: 6e27 7420 616c 7265 6164 7920 686f 6c64  n't already hold
-0003ae90: 2061 2063 6f70 792e 0a0a 2020 2020 2020   a copy...      
-0003aea0: 2020 5468 6520 6c65 6173 7420 7265 6365    The least rece
-0003aeb0: 6e74 6c79 2069 6e73 6572 7464 2028 4c52  ntly insertd (LR
-0003aec0: 4929 2070 6f6c 6963 7920 6973 2061 2067  I) policy is a g
-0003aed0: 7265 6564 7920 6368 6f69 6365 2077 6974  reedy choice wit
-0003aee0: 6820 7468 6520 6164 7661 6e74 6167 6520  h the advantage 
-0003aef0: 6f66 0a20 2020 2020 2020 2062 6569 6e67  of.        being
-0003af00: 204f 2831 292c 2074 7269 7669 616c 2074   O(1), trivial t
-0003af10: 6f20 696d 706c 656d 656e 7420 2869 7420  o implement (it 
-0003af20: 7265 6c69 6573 206f 6e20 7079 7468 6f6e  relies on python
-0003af30: 2064 6963 7420 696e 7365 7274 696f 6e2d   dict insertion-
-0003af40: 736f 7274 696e 6729 0a20 2020 2020 2020  sorting).       
-0003af50: 2061 6e64 2068 6f70 6566 756c 6c79 2067   and hopefully g
-0003af60: 6f6f 6420 656e 6f75 6768 2069 6e20 6d6f  ood enough in mo
-0003af70: 7374 2063 6173 6573 2e20 4469 7363 6172  st cases. Discar
-0003af80: 6465 6420 616c 7465 726e 6174 6976 6520  ded alternative 
-0003af90: 706f 6c69 6369 6573 2077 6572 653a 0a0a  policies were:..
-0003afa0: 2020 2020 2020 2020 2d20 4c61 7267 6573          - Larges
-0003afb0: 7420 6669 7273 742e 204f 286e 2a6c 6f67  t first. O(n*log
-0003afc0: 286e 2929 2073 6176 6520 666f 7220 6e6f  (n)) save for no
-0003afd0: 6e2d 7472 6976 6961 6c20 6164 6469 7469  n-trivial additi
-0003afe0: 6f6e 616c 2064 6174 6120 7374 7275 6374  onal data struct
-0003aff0: 7572 6573 2061 6e64 0a20 2020 2020 2020  ures and.       
-0003b000: 2020 2072 6973 6b73 2063 6175 7369 6e67     risks causing
-0003b010: 2074 6865 206c 6172 6765 7374 2063 6875   the largest chu
-0003b020: 6e6b 7320 6f66 2064 6174 6120 746f 2072  nks of data to r
-0003b030: 6570 6561 7465 646c 7920 6d6f 7665 2061  epeatedly move a
-0003b040: 726f 756e 6420 7468 650a 2020 2020 2020  round the.      
-0003b050: 2020 2020 636c 7573 7465 7220 6c69 6b65      cluster like
-0003b060: 2070 696e 6261 6c6c 732e 0a20 2020 2020   pinballs..     
-0003b070: 2020 202d 204c 6561 7374 2072 6563 656e     - Least recen
-0003b080: 746c 7920 7573 6564 2028 4c52 5529 2e20  tly used (LRU). 
-0003b090: 5468 6973 2069 6e66 6f72 6d61 7469 6f6e  This information
-0003b0a0: 2069 7320 6375 7272 656e 746c 7920 6176   is currently av
-0003b0b0: 6169 6c61 626c 6520 6f6e 2074 6865 0a20  ailable on the. 
-0003b0c0: 2020 2020 2020 2020 2077 6f72 6b65 7273           workers
-0003b0d0: 206f 6e6c 7920 616e 6420 6e6f 7420 7472   only and not tr
-0003b0e0: 6976 6961 6c20 746f 2072 6570 6c69 6361  ivial to replica
-0003b0f0: 7465 206f 6e20 7468 6520 7363 6865 6475  te on the schedu
-0003b100: 6c65 723b 2074 7261 6e73 6d69 7474 696e  ler; transmittin
-0003b110: 6720 6974 0a20 2020 2020 2020 2020 206f  g it.          o
-0003b120: 7665 7220 7468 6520 6e65 7477 6f72 6b20  ver the network 
-0003b130: 776f 756c 6420 6265 2076 6572 7920 6578  would be very ex
-0003b140: 7065 6e73 6976 652e 2041 6c73 6f2c 206e  pensive. Also, n
-0003b150: 6f74 6520 7468 6174 2064 6173 6b20 7769  ote that dask wi
-0003b160: 6c6c 2067 6f20 6f75 7420 6f66 0a20 2020  ll go out of.   
-0003b170: 2020 2020 2020 2069 7473 2077 6179 2074         its way t
-0003b180: 6f20 6d69 6e69 6d69 7365 2074 6865 2061  o minimise the a
-0003b190: 6d6f 756e 7420 6f66 2074 696d 6520 696e  mount of time in
-0003b1a0: 7465 726d 6564 6961 7465 206b 6579 7320  termediate keys 
-0003b1b0: 6172 6520 6865 6c64 2069 6e20 6d65 6d6f  are held in memo
-0003b1c0: 7279 2c0a 2020 2020 2020 2020 2020 736f  ry,.          so
-0003b1d0: 2069 6e20 7375 6368 2061 2063 6173 6520   in such a case 
-0003b1e0: 4c52 4920 6973 2061 2063 6c6f 7365 2061  LRI is a close a
-0003b1f0: 7070 726f 7869 6d61 7469 6f6e 206f 6620  pproximation of 
-0003b200: 4c52 552e 0a0a 2020 2020 2020 2020 5061  LRU...        Pa
-0003b210: 7261 6d65 7465 7273 0a20 2020 2020 2020  rameters.       
-0003b220: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
-0003b230: 2020 2020 6b65 7973 3a20 6f70 7469 6f6e      keys: option
-0003b240: 616c 0a20 2020 2020 2020 2020 2020 2061  al.            a
-0003b250: 6c6c 6f77 6c69 7374 206f 6620 6461 736b  llowlist of dask
-0003b260: 206b 6579 7320 7468 6174 2073 686f 756c   keys that shoul
-0003b270: 6420 6265 2063 6f6e 7369 6465 7265 6420  d be considered 
-0003b280: 666f 7220 6d6f 7669 6e67 2e20 416c 6c20  for moving. All 
-0003b290: 6f74 6865 7220 6b65 7973 0a20 2020 2020  other keys.     
-0003b2a0: 2020 2020 2020 2077 696c 6c20 6265 2069         will be i
-0003b2b0: 676e 6f72 6564 2e20 4e6f 7465 2074 6861  gnored. Note tha
-0003b2c0: 7420 7468 6973 206f 6666 6572 7320 6e6f  t this offers no
-0003b2d0: 2067 7561 7261 6e74 6565 2074 6861 7420   guarantee that 
-0003b2e0: 6120 6b65 7920 7769 6c6c 2061 6374 7561  a key will actua
-0003b2f0: 6c6c 790a 2020 2020 2020 2020 2020 2020  lly.            
-0003b300: 6265 206d 6f76 6564 2028 652e 672e 2062  be moved (e.g. b
-0003b310: 6563 6175 7365 2069 7420 6973 2075 6e6e  ecause it is unn
-0003b320: 6563 6573 7361 7279 206f 7220 6265 6361  ecessary or beca
-0003b330: 7573 6520 7468 6572 6520 6172 6520 6e6f  use there are no
-0003b340: 2076 6961 626c 650a 2020 2020 2020 2020   viable.        
-0003b350: 2020 2020 7265 6369 7069 656e 7420 776f      recipient wo
-0003b360: 726b 6572 7320 666f 7220 6974 292e 0a20  rkers for it).. 
-0003b370: 2020 2020 2020 2077 6f72 6b65 7273 3a20         workers: 
-0003b380: 6f70 7469 6f6e 616c 0a20 2020 2020 2020  optional.       
-0003b390: 2020 2020 2061 6c6c 6f77 6c69 7374 206f       allowlist o
-0003b3a0: 6620 776f 726b 6572 7320 6164 6472 6573  f workers addres
-0003b3b0: 7365 7320 746f 2062 6520 636f 6e73 6964  ses to be consid
-0003b3c0: 6572 6564 2061 7320 7365 6e64 6572 7320  ered as senders 
-0003b3d0: 6f72 2072 6563 6970 6965 6e74 732e 0a20  or recipients.. 
-0003b3e0: 2020 2020 2020 2020 2020 2041 6c6c 206f             All o
-0003b3f0: 7468 6572 2077 6f72 6b65 7273 2077 696c  ther workers wil
-0003b400: 6c20 6265 2069 676e 6f72 6564 2e20 5468  l be ignored. Th
-0003b410: 6520 6d65 616e 2063 6c75 7374 6572 206f  e mean cluster o
-0003b420: 6363 7570 616e 6379 2077 696c 6c20 6265  ccupancy will be
-0003b430: 0a20 2020 2020 2020 2020 2020 2063 616c  .            cal
-0003b440: 6375 6c61 7465 6420 6f6e 6c79 2075 7369  culated only usi
-0003b450: 6e67 2074 6865 2061 6c6c 6f77 6564 2077  ng the allowed w
-0003b460: 6f72 6b65 7273 2e0a 2020 2020 2020 2020  orkers..        
-0003b470: 2222 220a 2020 2020 2020 2020 7374 696d  """.        stim
-0003b480: 756c 7573 5f69 6420 3d20 7374 696d 756c  ulus_id = stimul
-0003b490: 7573 5f69 6420 6f72 2066 2272 6562 616c  us_id or f"rebal
-0003b4a0: 616e 6365 2d7b 7469 6d65 2829 7d22 0a0a  ance-{time()}"..
-0003b4b0: 2020 2020 2020 2020 7773 733a 2043 6f6c          wss: Col
-0003b4c0: 6c65 6374 696f 6e5b 576f 726b 6572 5374  lection[WorkerSt
-0003b4d0: 6174 655d 0a20 2020 2020 2020 2069 6620  ate].        if 
-0003b4e0: 776f 726b 6572 7320 6973 206e 6f74 204e  workers is not N
-0003b4f0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0003b500: 2077 7373 203d 205b 7365 6c66 2e77 6f72   wss = [self.wor
-0003b510: 6b65 7273 5b77 5d20 666f 7220 7720 696e  kers[w] for w in
-0003b520: 2077 6f72 6b65 7273 5d0a 2020 2020 2020   workers].      
-0003b530: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0003b540: 2020 2020 7773 7320 3d20 7365 6c66 2e77      wss = self.w
-0003b550: 6f72 6b65 7273 2e76 616c 7565 7328 290a  orkers.values().
-0003b560: 2020 2020 2020 2020 6966 206e 6f74 2077          if not w
-0003b570: 7373 3a0a 2020 2020 2020 2020 2020 2020  ss:.            
-0003b580: 7265 7475 726e 207b 2273 7461 7475 7322  return {"status"
-0003b590: 3a20 224f 4b22 7d0a 0a20 2020 2020 2020  : "OK"}..       
-0003b5a0: 2069 6620 6b65 7973 2069 7320 6e6f 7420   if keys is not 
-0003b5b0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0003b5c0: 2020 6966 206e 6f74 2069 7369 6e73 7461    if not isinsta
-0003b5d0: 6e63 6528 6b65 7973 2c20 5365 7429 3a0a  nce(keys, Set):.
-0003b5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b5f0: 6b65 7973 203d 2073 6574 286b 6579 7329  keys = set(keys)
-0003b600: 2020 2320 756e 6c65 7373 2061 6c72 6561    # unless alrea
-0003b610: 6479 2061 2073 6574 2d6c 696b 650a 2020  dy a set-like.  
-0003b620: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-0003b630: 206b 6579 733a 0a20 2020 2020 2020 2020   keys:.         
-0003b640: 2020 2020 2020 2072 6574 7572 6e20 7b22         return {"
-0003b650: 7374 6174 7573 223a 2022 4f4b 227d 0a20  status": "OK"}. 
-0003b660: 2020 2020 2020 2020 2020 206d 6973 7369             missi
-0003b670: 6e67 5f64 6174 6120 3d20 5b0a 2020 2020  ng_data = [.    
-0003b680: 2020 2020 2020 2020 2020 2020 6b20 666f              k fo
-0003b690: 7220 6b20 696e 206b 6579 7320 6966 206b  r k in keys if k
-0003b6a0: 206e 6f74 2069 6e20 7365 6c66 2e74 6173   not in self.tas
-0003b6b0: 6b73 206f 7220 6e6f 7420 7365 6c66 2e74  ks or not self.t
-0003b6c0: 6173 6b73 5b6b 5d2e 7768 6f5f 6861 730a  asks[k].who_has.
-0003b6d0: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
-0003b6e0: 2020 2020 2020 2020 2020 6966 206d 6973            if mis
-0003b6f0: 7369 6e67 5f64 6174 613a 0a20 2020 2020  sing_data:.     
-0003b700: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0003b710: 6e20 7b22 7374 6174 7573 223a 2022 7061  n {"status": "pa
-0003b720: 7274 6961 6c2d 6661 696c 222c 2022 6b65  rtial-fail", "ke
-0003b730: 7973 223a 206d 6973 7369 6e67 5f64 6174  ys": missing_dat
-0003b740: 617d 0a0a 2020 2020 2020 2020 6d73 6773  a}..        msgs
-0003b750: 203d 2073 656c 662e 5f72 6562 616c 616e   = self._rebalan
-0003b760: 6365 5f66 696e 645f 6d73 6773 286b 6579  ce_find_msgs(key
-0003b770: 732c 2077 7373 290a 2020 2020 2020 2020  s, wss).        
-0003b780: 6966 206e 6f74 206d 7367 733a 0a20 2020  if not msgs:.   
-0003b790: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0003b7a0: 7b22 7374 6174 7573 223a 2022 4f4b 227d  {"status": "OK"}
-0003b7b0: 0a0a 2020 2020 2020 2020 2320 446f 776e  ..        # Down
-0003b7c0: 6772 6164 6520 7265 656e 7472 616e 7420  grade reentrant 
-0003b7d0: 6c6f 636b 2074 6f20 6e6f 6e2d 7265 656e  lock to non-reen
-0003b7e0: 7472 616e 740a 2020 2020 2020 2020 6173  trant.        as
-0003b7f0: 796e 6320 7769 7468 2073 656c 662e 5f72  ync with self._r
-0003b800: 6570 6c69 6361 5f6c 6f63 6b28 2822 7265  eplica_lock(("re
-0003b810: 6261 6c61 6e63 6522 2c20 6f62 6a65 6374  balance", object
-0003b820: 2829 2929 3a0a 2020 2020 2020 2020 2020  ())):.          
-0003b830: 2020 7265 7375 6c74 203d 2061 7761 6974    result = await
-0003b840: 2073 656c 662e 5f72 6562 616c 616e 6365   self._rebalance
-0003b850: 5f6d 6f76 655f 6461 7461 286d 7367 732c  _move_data(msgs,
-0003b860: 2073 7469 6d75 6c75 735f 6964 290a 2020   stimulus_id).  
-0003b870: 2020 2020 2020 2020 2020 6966 2072 6573            if res
-0003b880: 756c 745b 2273 7461 7475 7322 5d20 3d3d  ult["status"] ==
-0003b890: 2022 7061 7274 6961 6c2d 6661 696c 2220   "partial-fail" 
-0003b8a0: 616e 6420 6b65 7973 2069 7320 4e6f 6e65  and keys is None
-0003b8b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0003b8c0: 2020 2320 4f6e 6c79 2072 6574 7572 6e20    # Only return 
-0003b8d0: 6661 696c 6564 206b 6579 7320 6966 2074  failed keys if t
-0003b8e0: 6865 2063 6c69 656e 7420 6578 706c 6963  he client explic
-0003b8f0: 6974 6c79 2061 736b 6564 2066 6f72 2074  itly asked for t
-0003b900: 6865 6d0a 2020 2020 2020 2020 2020 2020  hem.            
-0003b910: 2020 2020 7265 7375 6c74 203d 207b 2273      result = {"s
-0003b920: 7461 7475 7322 3a20 224f 4b22 7d0a 2020  tatus": "OK"}.  
-0003b930: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0003b940: 2072 6573 756c 740a 0a20 2020 2064 6566   result..    def
-0003b950: 205f 7265 6261 6c61 6e63 655f 6669 6e64   _rebalance_find
-0003b960: 5f6d 7367 7328 0a20 2020 2020 2020 2073  _msgs(.        s
-0003b970: 656c 662c 0a20 2020 2020 2020 206b 6579  elf,.        key
-0003b980: 733a 2053 6574 5b48 6173 6861 626c 655d  s: Set[Hashable]
-0003b990: 207c 204e 6f6e 652c 0a20 2020 2020 2020   | None,.       
-0003b9a0: 2077 6f72 6b65 7273 3a20 4974 6572 6162   workers: Iterab
-0003b9b0: 6c65 5b57 6f72 6b65 7253 7461 7465 5d2c  le[WorkerState],
-0003b9c0: 0a20 2020 2029 202d 3e20 6c69 7374 5b74  .    ) -> list[t
-0003b9d0: 7570 6c65 5b57 6f72 6b65 7253 7461 7465  uple[WorkerState
-0003b9e0: 2c20 576f 726b 6572 5374 6174 652c 2054  , WorkerState, T
-0003b9f0: 6173 6b53 7461 7465 5d5d 3a0a 2020 2020  askState]]:.    
-0003ba00: 2020 2020 2222 2249 6465 6e74 6966 7920      """Identify 
-0003ba10: 776f 726b 6572 7320 7468 6174 206e 6565  workers that nee
-0003ba20: 6420 746f 206c 6f73 6520 6b65 7973 2061  d to lose keys a
-0003ba30: 6e64 2074 686f 7365 2074 6861 7420 6361  nd those that ca
-0003ba40: 6e20 7265 6365 6976 6520 7468 656d 2c0a  n receive them,.
-0003ba50: 2020 2020 2020 2020 746f 6765 7468 6572          together
-0003ba60: 2077 6974 6820 686f 7720 6d61 6e79 2062   with how many b
-0003ba70: 7974 6573 2065 6163 6820 6e65 6564 7320  ytes each needs 
-0003ba80: 746f 206c 6f73 652f 7265 6365 6976 652e  to lose/receive.
-0003ba90: 2054 6865 6e2c 2070 6169 7220 6120 7365   Then, pair a se
-0003baa0: 6e64 6572 0a20 2020 2020 2020 2077 6f72  nder.        wor
-0003bab0: 6b65 7220 7769 7468 2061 2072 6563 6970  ker with a recip
-0003bac0: 6965 6e74 2077 6f72 6b65 7220 666f 7220  ient worker for 
-0003bad0: 6561 6368 206b 6579 2c20 756e 7469 6c20  each key, until 
-0003bae0: 7468 6520 636c 7573 7465 7220 6973 2072  the cluster is r
-0003baf0: 6562 616c 616e 6365 642e 0a0a 2020 2020  ebalanced...    
-0003bb00: 2020 2020 5468 6973 206d 6574 686f 6420      This method 
-0003bb10: 6f6e 6c79 2064 6566 696e 6573 2074 6865  only defines the
-0003bb20: 2077 6f72 6b20 746f 2062 6520 7065 7266   work to be perf
-0003bb30: 6f72 6d65 643b 2069 7420 646f 6573 206e  ormed; it does n
-0003bb40: 6f74 2073 7461 7274 2061 6e79 206e 6574  ot start any net
-0003bb50: 776f 726b 0a20 2020 2020 2020 2074 7261  work.        tra
-0003bb60: 6e73 6665 7273 2069 7473 656c 662e 0a0a  nsfers itself...
-0003bb70: 2020 2020 2020 2020 5468 6520 6269 672d          The big-
-0003bb80: 4f20 636f 6d70 6c65 7869 7479 2069 7320  O complexity is 
-0003bb90: 4f28 7774 202b 206b 652a 6c6f 6728 7765  O(wt + ke*log(we
-0003bba0: 2929 2c20 7768 6572 650a 0a20 2020 2020  )), where..     
-0003bbb0: 2020 202d 2077 7420 6973 2074 6865 2074     - wt is the t
-0003bbc0: 6f74 616c 206e 756d 6265 7220 6f66 2077  otal number of w
-0003bbd0: 6f72 6b65 7273 206f 6e20 7468 6520 636c  orkers on the cl
-0003bbe0: 7573 7465 7220 286f 7220 7468 6520 6e75  uster (or the nu
-0003bbf0: 6d62 6572 206f 6620 616c 6c6f 7765 640a  mber of allowed.
-0003bc00: 2020 2020 2020 2020 2020 776f 726b 6572            worker
-0003bc10: 732c 2069 6620 6578 706c 6963 6974 6c79  s, if explicitly
-0003bc20: 2073 7461 7465 6420 6279 2074 6865 2075   stated by the u
-0003bc30: 7365 7229 0a20 2020 2020 2020 202d 2077  ser).        - w
-0003bc40: 6520 6973 2074 6865 206e 756d 6265 7220  e is the number 
-0003bc50: 6f66 2077 6f72 6b65 7273 2074 6861 7420  of workers that 
-0003bc60: 6172 6520 656c 6967 6962 6c65 2074 6f20  are eligible to 
-0003bc70: 6265 2073 656e 6465 7273 206f 7220 7265  be senders or re
-0003bc80: 6369 7069 656e 7473 0a20 2020 2020 2020  cipients.       
-0003bc90: 202d 206b 7420 6973 2074 6865 2074 6f74   - kt is the tot
-0003bca0: 616c 206e 756d 6265 7220 6f66 206b 6579  al number of key
-0003bcb0: 7320 6f6e 2074 6865 2063 6c75 7374 6572  s on the cluster
-0003bcc0: 2028 6f72 206f 6e20 7468 6520 616c 6c6f   (or on the allo
-0003bcd0: 7765 6420 776f 726b 6572 7329 0a20 2020  wed workers).   
-0003bce0: 2020 2020 202d 206b 6520 6973 2074 6865       - ke is the
-0003bcf0: 206e 756d 6265 7220 6f66 206b 6579 7320   number of keys 
-0003bd00: 7468 6174 206e 6565 6420 746f 2062 6520  that need to be 
-0003bd10: 6d6f 7665 6420 696e 206f 7264 6572 2074  moved in order t
-0003bd20: 6f20 6163 6869 6576 6520 6120 6261 6c61  o achieve a bala
-0003bd30: 6e63 6564 0a20 2020 2020 2020 2020 2063  nced.          c
-0003bd40: 6c75 7374 6572 0a0a 2020 2020 2020 2020  luster..        
-0003bd50: 5468 6572 6520 6973 2061 2064 6567 656e  There is a degen
-0003bd60: 6572 6174 6520 6564 6765 2063 6173 6520  erate edge case 
-0003bd70: 4f28 7774 202b 206b 742a 6c6f 6728 7765  O(wt + kt*log(we
-0003bd80: 2929 2077 6865 6e20 6b74 2069 7320 6d75  )) when kt is mu
-0003bd90: 6368 2067 7265 6174 6572 2074 6861 6e0a  ch greater than.
-0003bda0: 2020 2020 2020 2020 7468 6520 6e75 6d62          the numb
-0003bdb0: 6572 206f 6620 616c 6c6f 7765 6420 6b65  er of allowed ke
-0003bdc0: 7973 2c20 6f72 2077 6865 6e20 6d6f 7374  ys, or when most
-0003bdd0: 206b 6579 7320 6172 6520 7265 706c 6963   keys are replic
-0003bde0: 6174 6564 206f 7220 6361 6e6e 6f74 2062  ated or cannot b
-0003bdf0: 650a 2020 2020 2020 2020 6d6f 7665 6420  e.        moved 
-0003be00: 666f 7220 736f 6d65 206f 7468 6572 2072  for some other r
-0003be10: 6561 736f 6e2e 0a0a 2020 2020 2020 2020  eason...        
-0003be20: 5265 7475 726e 7320 6c69 7374 206f 6620  Returns list of 
-0003be30: 7475 706c 6573 2074 6f20 6665 6564 2069  tuples to feed i
-0003be40: 6e74 6f20 5f72 6562 616c 616e 6365 5f6d  nto _rebalance_m
-0003be50: 6f76 655f 6461 7461 3a0a 0a20 2020 2020  ove_data:..     
-0003be60: 2020 202d 2073 656e 6465 7220 776f 726b     - sender work
-0003be70: 6572 0a20 2020 2020 2020 202d 2072 6563  er.        - rec
-0003be80: 6970 6965 6e74 2077 6f72 6b65 720a 2020  ipient worker.  
-0003be90: 2020 2020 2020 2d20 7461 736b 2074 6f20        - task to 
-0003bea0: 6265 2074 7261 6e73 6665 7272 6564 0a20  be transferred. 
-0003beb0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0003bec0: 2020 2023 2048 6561 7073 206f 6620 776f     # Heaps of wo
-0003bed0: 726b 6572 732c 206d 616e 6167 6564 2062  rkers, managed b
-0003bee0: 7920 7468 6520 6865 6170 7120 6d6f 6475  y the heapq modu
-0003bef0: 6c65 2c20 7468 6174 206e 6565 6420 746f  le, that need to
-0003bf00: 2073 656e 642f 7265 6365 6976 6520 6461   send/receive da
-0003bf10: 7461 2c0a 2020 2020 2020 2020 2320 7769  ta,.        # wi
-0003bf20: 7468 2068 6f77 206d 616e 7920 6279 7465  th how many byte
-0003bf30: 7320 6561 6368 206e 6565 6473 2074 6f20  s each needs to 
-0003bf40: 7365 6e64 2f72 6563 6569 7665 2e0a 2020  send/receive..  
-0003bf50: 2020 2020 2020 230a 2020 2020 2020 2020        #.        
-0003bf60: 2320 4561 6368 2065 6c65 6d65 6e74 206f  # Each element o
-0003bf70: 6620 7468 6520 6865 6170 2069 7320 6120  f the heap is a 
-0003bf80: 7475 706c 6520 636f 6e73 7472 7563 7465  tuple constructe
-0003bf90: 6420 6173 2066 6f6c 6c6f 7773 3a0a 2020  d as follows:.  
-0003bfa0: 2020 2020 2020 2320 2d20 736e 645f 6279        # - snd_by
-0003bfb0: 7465 735f 6d61 782f 7265 635f 6279 7465  tes_max/rec_byte
-0003bfc0: 735f 6d61 783a 206d 6178 696d 756d 206e  s_max: maximum n
-0003bfd0: 756d 6265 7220 6f66 2062 7974 6573 2074  umber of bytes t
-0003bfe0: 6f20 7365 6e64 206f 7220 7265 6365 6976  o send or receiv
-0003bff0: 652e 0a20 2020 2020 2020 2023 2020 2054  e..        #   T
-0003c000: 6869 7320 6e75 6d62 6572 2069 7320 6e65  his number is ne
-0003c010: 6761 7469 7665 2c20 736f 2074 6861 7420  gative, so that 
-0003c020: 7468 6520 776f 726b 6572 7320 6661 7274  the workers fart
-0003c030: 6865 7374 2066 726f 6d20 7468 6520 636c  hest from the cl
-0003c040: 7573 7465 7220 6d65 616e 0a20 2020 2020  uster mean.     
-0003c050: 2020 2023 2020 2061 7265 2061 7420 7468     #   are at th
-0003c060: 6520 746f 7020 6f66 2074 6865 2073 6d61  e top of the sma
-0003c070: 6c6c 6573 742d 6669 7273 7420 6865 6170  llest-first heap
-0003c080: 732e 0a20 2020 2020 2020 2023 202d 2073  s..        # - s
-0003c090: 6e64 5f62 7974 6573 5f6d 696e 2f72 6563  nd_bytes_min/rec
-0003c0a0: 5f62 7974 6573 5f6d 696e 3a20 6d69 6e69  _bytes_min: mini
-0003c0b0: 6d75 6d20 6e75 6d62 6572 206f 6620 6279  mum number of by
-0003c0c0: 7465 7320 6166 7465 7220 7365 6e64 696e  tes after sendin
-0003c0d0: 672f 7265 6365 6976 696e 670a 2020 2020  g/receiving.    
-0003c0e0: 2020 2020 2320 2020 7768 6963 6820 7468      #   which th
-0003c0f0: 6520 776f 726b 6572 2073 686f 756c 6420  e worker should 
-0003c100: 6e6f 7420 6265 2063 6f6e 7369 6465 7265  not be considere
-0003c110: 6420 616e 796d 6f72 652e 2054 6869 7320  d anymore. This 
-0003c120: 6973 2061 6c73 6f20 6e65 6761 7469 7665  is also negative
-0003c130: 2e0a 2020 2020 2020 2020 2320 2d20 6172  ..        # - ar
-0003c140: 6269 7472 6172 7920 756e 6971 7565 206e  bitrary unique n
-0003c150: 756d 6265 722c 2074 6865 7265 206a 7573  umber, there jus
-0003c160: 7420 746f 2074 6f20 6d61 6b65 2073 7572  t to to make sur
-0003c170: 6520 7468 6174 2057 6f72 6b65 7253 7461  e that WorkerSta
-0003c180: 7465 206f 626a 6563 7473 0a20 2020 2020  te objects.     
-0003c190: 2020 2023 2020 2061 7265 206e 6576 6572     #   are never
-0003c1a0: 2075 7365 6420 666f 7220 736f 7274 696e   used for sortin
-0003c1b0: 6720 696e 2074 6865 2075 6e6c 696b 656c  g in the unlikel
-0003c1c0: 7920 6576 656e 7420 7468 6174 2074 776f  y event that two
-0003c1d0: 2070 726f 6365 7373 6573 2068 6176 650a   processes have.
-0003c1e0: 2020 2020 2020 2020 2320 2020 6578 6163          #   exac
-0003c1f0: 746c 7920 7468 6520 7361 6d65 206e 756d  tly the same num
-0003c200: 6265 7220 6f66 2062 7974 6573 2061 6c6c  ber of bytes all
-0003c210: 6f63 6174 6564 2e0a 2020 2020 2020 2020  ocated..        
-0003c220: 2320 2d20 576f 726b 6572 5374 6174 650a  # - WorkerState.
-0003c230: 2020 2020 2020 2020 2320 2d20 6974 6572          # - iter
-0003c240: 6174 6f72 206f 6620 616c 6c20 7461 736b  ator of all task
-0003c250: 7320 696e 206d 656d 6f72 7920 6f6e 2074  s in memory on t
-0003c260: 6865 2077 6f72 6b65 7220 2873 656e 6465  he worker (sende
-0003c270: 7273 206f 6e6c 7929 2c20 696e 7365 7274  rs only), insert
-0003c280: 696f 6e0a 2020 2020 2020 2020 2320 2020  ion.        #   
-0003c290: 736f 7274 6564 2028 6c65 6173 7420 7265  sorted (least re
-0003c2a0: 6365 6e74 6c79 2069 6e73 6572 7465 6420  cently inserted 
-0003c2b0: 6669 7273 7429 2e0a 2020 2020 2020 2020  first)..        
-0003c2c0: 2320 2020 4e6f 7465 2074 6861 7420 7468  #   Note that th
-0003c2d0: 6973 2069 7465 7261 746f 7220 7769 6c6c  is iterator will
-0003c2e0: 2074 7970 6963 616c 6c79 202a 6e6f 742a   typically *not*
-0003c2f0: 2062 6520 6578 6861 7573 7465 642e 2049   be exhausted. I
-0003c300: 7420 7769 6c6c 206f 6e6c 7920 6265 0a20  t will only be. 
-0003c310: 2020 2020 2020 2023 2020 2065 7868 6175         #   exhau
-0003c320: 7374 6564 2069 662c 2061 6674 6572 206d  sted if, after m
-0003c330: 6f76 696e 6720 6177 6179 2066 726f 6d20  oving away from 
-0003c340: 7468 6520 776f 726b 6572 2061 6c6c 206b  the worker all k
-0003c350: 6579 7320 7468 6174 2063 616e 2062 6520  eys that can be 
-0003c360: 6d6f 7665 642c 0a20 2020 2020 2020 2023  moved,.        #
-0003c370: 2020 2069 7320 696e 7375 6666 6963 6965     is insufficie
-0003c380: 6e74 2074 6f20 6472 6f70 2073 6e64 5f62  nt to drop snd_b
-0003c390: 7974 6573 5f6d 696e 2061 626f 7665 2030  ytes_min above 0
-0003c3a0: 2e0a 2020 2020 2020 2020 7365 6e64 6572  ..        sender
-0003c3b0: 733a 206c 6973 745b 7475 706c 655b 696e  s: list[tuple[in
-0003c3c0: 742c 2069 6e74 2c20 696e 742c 2057 6f72  t, int, int, Wor
-0003c3d0: 6b65 7253 7461 7465 2c20 4974 6572 6174  kerState, Iterat
-0003c3e0: 6f72 5b54 6173 6b53 7461 7465 5d5d 5d20  or[TaskState]]] 
-0003c3f0: 3d20 5b5d 0a20 2020 2020 2020 2072 6563  = [].        rec
-0003c400: 6970 6965 6e74 733a 206c 6973 745b 7475  ipients: list[tu
-0003c410: 706c 655b 696e 742c 2069 6e74 2c20 696e  ple[int, int, in
-0003c420: 742c 2057 6f72 6b65 7253 7461 7465 5d5d  t, WorkerState]]
-0003c430: 203d 205b 5d0a 0a20 2020 2020 2020 2023   = []..        #
-0003c440: 204f 7574 7075 743a 205b 2873 656e 6465   Output: [(sende
-0003c450: 722c 2072 6563 6970 6965 6e74 2c20 7461  r, recipient, ta
-0003c460: 736b 292c 202e 2e2e 5d0a 2020 2020 2020  sk), ...].      
-0003c470: 2020 6d73 6773 3a20 6c69 7374 5b74 7570    msgs: list[tup
-0003c480: 6c65 5b57 6f72 6b65 7253 7461 7465 2c20  le[WorkerState, 
-0003c490: 576f 726b 6572 5374 6174 652c 2054 6173  WorkerState, Tas
-0003c4a0: 6b53 7461 7465 5d5d 203d 205b 5d0a 0a20  kState]] = [].. 
-0003c4b0: 2020 2020 2020 2023 2042 7920 6465 6661         # By defa
-0003c4c0: 756c 742c 2074 6869 7320 6973 2074 6865  ult, this is the
-0003c4d0: 206f 7074 696d 6973 7469 6320 6d65 6d6f   optimistic memo
-0003c4e0: 7279 2c20 6d65 616e 696e 6720 746f 7461  ry, meaning tota
-0003c4f0: 6c20 7072 6f63 6573 7320 6d65 6d6f 7279  l process memory
-0003c500: 206d 696e 7573 0a20 2020 2020 2020 2023   minus.        #
-0003c510: 2075 6e6d 616e 6167 6564 206d 656d 6f72   unmanaged memor
-0003c520: 7920 7468 6174 2061 7070 6561 7265 6420  y that appeared 
-0003c530: 6f76 6572 2074 6865 206c 6173 7420 3330  over the last 30
-0003c540: 2073 6563 6f6e 6473 0a20 2020 2020 2020   seconds.       
-0003c550: 2023 2028 6469 7374 7269 6275 7465 642e   # (distributed.
-0003c560: 776f 726b 6572 2e6d 656d 6f72 792e 7265  worker.memory.re
-0003c570: 6365 6e74 2d74 6f2d 6f6c 642d 7469 6d65  cent-to-old-time
-0003c580: 292e 0a20 2020 2020 2020 2023 2054 6869  )..        # Thi
-0003c590: 7320 6c65 7473 2075 7320 6967 6e6f 7265  s lets us ignore
-0003c5a0: 2074 656d 706f 7261 7279 2073 7069 6b65   temporary spike
-0003c5b0: 7320 6361 7573 6564 2062 7920 7461 736b  s caused by task
-0003c5c0: 2068 6561 7020 7573 6167 652e 0a20 2020   heap usage..   
-0003c5d0: 2020 2020 206d 656d 6f72 795f 6279 5f77       memory_by_w
-0003c5e0: 6f72 6b65 7220 3d20 5b0a 2020 2020 2020  orker = [.      
-0003c5f0: 2020 2020 2020 2877 732c 2067 6574 6174        (ws, getat
-0003c600: 7472 2877 732e 6d65 6d6f 7279 2c20 7365  tr(ws.memory, se
-0003c610: 6c66 2e4d 454d 4f52 595f 5245 4241 4c41  lf.MEMORY_REBALA
-0003c620: 4e43 455f 4d45 4153 5552 4529 2920 666f  NCE_MEASURE)) fo
-0003c630: 7220 7773 2069 6e20 776f 726b 6572 730a  r ws in workers.
-0003c640: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
-0003c650: 2020 6d65 616e 5f6d 656d 6f72 7920 3d20    mean_memory = 
-0003c660: 7375 6d28 6d20 666f 7220 5f2c 206d 2069  sum(m for _, m i
-0003c670: 6e20 6d65 6d6f 7279 5f62 795f 776f 726b  n memory_by_work
-0003c680: 6572 2920 2f2f 206c 656e 286d 656d 6f72  er) // len(memor
-0003c690: 795f 6279 5f77 6f72 6b65 7229 0a0a 2020  y_by_worker)..  
-0003c6a0: 2020 2020 2020 666f 7220 7773 2c20 7773        for ws, ws
-0003c6b0: 5f6d 656d 6f72 7920 696e 206d 656d 6f72  _memory in memor
-0003c6c0: 795f 6279 5f77 6f72 6b65 723a 0a20 2020  y_by_worker:.   
-0003c6d0: 2020 2020 2020 2020 2069 6620 7773 2e6d           if ws.m
-0003c6e0: 656d 6f72 795f 6c69 6d69 743a 0a20 2020  emory_limit:.   
-0003c6f0: 2020 2020 2020 2020 2020 2020 2068 616c               hal
-0003c700: 665f 6761 7020 3d20 696e 7428 7365 6c66  f_gap = int(self
-0003c710: 2e4d 454d 4f52 595f 5245 4241 4c41 4e43  .MEMORY_REBALANC
-0003c720: 455f 4841 4c46 5f47 4150 202a 2077 732e  E_HALF_GAP * ws.
-0003c730: 6d65 6d6f 7279 5f6c 696d 6974 290a 2020  memory_limit).  
-0003c740: 2020 2020 2020 2020 2020 2020 2020 7365                se
-0003c750: 6e64 6572 5f6d 696e 203d 2073 656c 662e  nder_min = self.
-0003c760: 4d45 4d4f 5259 5f52 4542 414c 414e 4345  MEMORY_REBALANCE
-0003c770: 5f53 454e 4445 525f 4d49 4e20 2a20 7773  _SENDER_MIN * ws
-0003c780: 2e6d 656d 6f72 795f 6c69 6d69 740a 2020  .memory_limit.  
-0003c790: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0003c7a0: 6369 7069 656e 745f 6d61 7820 3d20 7365  cipient_max = se
-0003c7b0: 6c66 2e4d 454d 4f52 595f 5245 4241 4c41  lf.MEMORY_REBALA
-0003c7c0: 4e43 455f 5245 4349 5049 454e 545f 4d41  NCE_RECIPIENT_MA
-0003c7d0: 5820 2a20 7773 2e6d 656d 6f72 795f 6c69  X * ws.memory_li
-0003c7e0: 6d69 740a 2020 2020 2020 2020 2020 2020  mit.            
-0003c7f0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0003c800: 2020 2020 2020 6861 6c66 5f67 6170 203d        half_gap =
-0003c810: 2030 0a20 2020 2020 2020 2020 2020 2020   0.             
-0003c820: 2020 2073 656e 6465 725f 6d69 6e20 3d20     sender_min = 
-0003c830: 302e 300a 2020 2020 2020 2020 2020 2020  0.0.            
-0003c840: 2020 2020 7265 6369 7069 656e 745f 6d61      recipient_ma
-0003c850: 7820 3d20 6d61 7468 2e69 6e66 0a0a 2020  x = math.inf..  
-0003c860: 2020 2020 2020 2020 2020 6966 2028 0a20            if (. 
-0003c870: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-0003c880: 732e 5f68 6173 5f77 6861 740a 2020 2020  s._has_what.    
-0003c890: 2020 2020 2020 2020 2020 2020 616e 6420              and 
-0003c8a0: 7773 5f6d 656d 6f72 7920 3e3d 206d 6561  ws_memory >= mea
-0003c8b0: 6e5f 6d65 6d6f 7279 202b 2068 616c 665f  n_memory + half_
-0003c8c0: 6761 700a 2020 2020 2020 2020 2020 2020  gap.            
-0003c8d0: 2020 2020 616e 6420 7773 5f6d 656d 6f72      and ws_memor
-0003c8e0: 7920 3e3d 2073 656e 6465 725f 6d69 6e0a  y >= sender_min.
-0003c8f0: 2020 2020 2020 2020 2020 2020 293a 0a20              ):. 
-0003c900: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0003c910: 2054 6869 7320 6d61 7920 7365 6e64 2074   This may send t
-0003c920: 6865 2077 6f72 6b65 7220 6265 6c6f 7720  he worker below 
-0003c930: 7365 6e64 6572 5f6d 696e 2028 6279 2064  sender_min (by d
-0003c940: 6573 6967 6e29 0a20 2020 2020 2020 2020  esign).         
-0003c950: 2020 2020 2020 2073 6e64 5f62 7974 6573         snd_bytes
-0003c960: 5f6d 6178 203d 206d 6561 6e5f 6d65 6d6f  _max = mean_memo
-0003c970: 7279 202d 2077 735f 6d65 6d6f 7279 2020  ry - ws_memory  
-0003c980: 2320 6e65 6761 7469 7665 0a20 2020 2020  # negative.     
-0003c990: 2020 2020 2020 2020 2020 2073 6e64 5f62             snd_b
-0003c9a0: 7974 6573 5f6d 696e 203d 2073 6e64 5f62  ytes_min = snd_b
-0003c9b0: 7974 6573 5f6d 6178 202b 2068 616c 665f  ytes_max + half_
-0003c9c0: 6761 7020 2023 206e 6567 6174 6976 650a  gap  # negative.
-0003c9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003c9e0: 2320 5365 6520 6465 6669 6e69 7469 6f6e  # See definition
-0003c9f0: 206f 6620 7365 6e64 6572 7320 6162 6f76   of senders abov
-0003ca00: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-0003ca10: 2020 7365 6e64 6572 732e 6170 7065 6e64    senders.append
-0003ca20: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0003ca30: 2020 2020 2020 2873 6e64 5f62 7974 6573        (snd_bytes
-0003ca40: 5f6d 6178 2c20 736e 645f 6279 7465 735f  _max, snd_bytes_
-0003ca50: 6d69 6e2c 2069 6428 7773 292c 2077 732c  min, id(ws), ws,
-0003ca60: 2069 7465 7228 7773 2e5f 6861 735f 7768   iter(ws._has_wh
-0003ca70: 6174 2929 0a20 2020 2020 2020 2020 2020  at)).           
-0003ca80: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-0003ca90: 2020 2065 6c69 6620 7773 5f6d 656d 6f72     elif ws_memor
-0003caa0: 7920 3c20 6d65 616e 5f6d 656d 6f72 7920  y < mean_memory 
-0003cab0: 2d20 6861 6c66 5f67 6170 2061 6e64 2077  - half_gap and w
-0003cac0: 735f 6d65 6d6f 7279 203c 2072 6563 6970  s_memory < recip
-0003cad0: 6965 6e74 5f6d 6178 3a0a 2020 2020 2020  ient_max:.      
-0003cae0: 2020 2020 2020 2020 2020 2320 5468 6973            # This
-0003caf0: 206d 6179 2073 656e 6420 7468 6520 776f   may send the wo
-0003cb00: 726b 6572 2061 626f 7665 2072 6563 6970  rker above recip
-0003cb10: 6965 6e74 5f6d 6178 2028 6279 2064 6573  ient_max (by des
-0003cb20: 6967 6e29 0a20 2020 2020 2020 2020 2020  ign).           
-0003cb30: 2020 2020 2072 6563 5f62 7974 6573 5f6d       rec_bytes_m
-0003cb40: 6178 203d 2077 735f 6d65 6d6f 7279 202d  ax = ws_memory -
-0003cb50: 206d 6561 6e5f 6d65 6d6f 7279 2020 2320   mean_memory  # 
-0003cb60: 6e65 6761 7469 7665 0a20 2020 2020 2020  negative.       
-0003cb70: 2020 2020 2020 2020 2072 6563 5f62 7974           rec_byt
-0003cb80: 6573 5f6d 696e 203d 2072 6563 5f62 7974  es_min = rec_byt
-0003cb90: 6573 5f6d 6178 202b 2068 616c 665f 6761  es_max + half_ga
-0003cba0: 7020 2023 206e 6567 6174 6976 650a 2020  p  # negative.  
-0003cbb0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0003cbc0: 5365 6520 6465 6669 6e69 7469 6f6e 206f  See definition o
-0003cbd0: 6620 7265 6369 7069 656e 7473 2061 626f  f recipients abo
-0003cbe0: 7665 0a20 2020 2020 2020 2020 2020 2020  ve.             
-0003cbf0: 2020 2072 6563 6970 6965 6e74 732e 6170     recipients.ap
-0003cc00: 7065 6e64 2828 7265 635f 6279 7465 735f  pend((rec_bytes_
-0003cc10: 6d61 782c 2072 6563 5f62 7974 6573 5f6d  max, rec_bytes_m
-0003cc20: 696e 2c20 6964 2877 7329 2c20 7773 2929  in, id(ws), ws))
-0003cc30: 0a0a 2020 2020 2020 2020 2320 4661 7374  ..        # Fast
-0003cc40: 2065 7869 7420 696e 2063 6173 6520 6e6f   exit in case no
-0003cc50: 2074 7261 6e73 6665 7273 2061 7265 206e   transfers are n
-0003cc60: 6563 6573 7361 7279 206f 7220 706f 7373  ecessary or poss
-0003cc70: 6962 6c65 0a20 2020 2020 2020 2069 6620  ible.        if 
-0003cc80: 6e6f 7420 7365 6e64 6572 7320 6f72 206e  not senders or n
-0003cc90: 6f74 2072 6563 6970 6965 6e74 733a 0a20  ot recipients:. 
-0003cca0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0003ccb0: 6c6f 675f 6576 656e 7428 0a20 2020 2020  log_event(.     
-0003ccc0: 2020 2020 2020 2020 2020 2022 616c 6c22             "all"
-0003ccd0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0003cce0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-0003ccf0: 2020 2020 2020 2020 2261 6374 696f 6e22          "action"
-0003cd00: 3a20 2272 6562 616c 616e 6365 222c 0a20  : "rebalance",. 
-0003cd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003cd20: 2020 2022 7365 6e64 6572 7322 3a20 6c65     "senders": le
-0003cd30: 6e28 7365 6e64 6572 7329 2c0a 2020 2020  n(senders),.    
-0003cd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003cd50: 2272 6563 6970 6965 6e74 7322 3a20 6c65  "recipients": le
-0003cd60: 6e28 7265 6369 7069 656e 7473 292c 0a20  n(recipients),. 
-0003cd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003cd80: 2020 2022 6d6f 7665 645f 6b65 7973 223a     "moved_keys":
-0003cd90: 2030 2c0a 2020 2020 2020 2020 2020 2020   0,.            
-0003cda0: 2020 2020 7d2c 0a20 2020 2020 2020 2020      },.         
-0003cdb0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0003cdc0: 2072 6574 7572 6e20 5b5d 0a0a 2020 2020   return []..    
-0003cdd0: 2020 2020 6865 6170 712e 6865 6170 6966      heapq.heapif
-0003cde0: 7928 7365 6e64 6572 7329 0a20 2020 2020  y(senders).     
-0003cdf0: 2020 2068 6561 7071 2e68 6561 7069 6679     heapq.heapify
-0003ce00: 2872 6563 6970 6965 6e74 7329 0a0a 2020  (recipients)..  
-0003ce10: 2020 2020 2020 7768 696c 6520 7365 6e64        while send
-0003ce20: 6572 7320 616e 6420 7265 6369 7069 656e  ers and recipien
-0003ce30: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
-0003ce40: 736e 645f 6279 7465 735f 6d61 782c 2073  snd_bytes_max, s
-0003ce50: 6e64 5f62 7974 6573 5f6d 696e 2c20 5f2c  nd_bytes_min, _,
-0003ce60: 2073 6e64 5f77 732c 2074 735f 6974 6572   snd_ws, ts_iter
-0003ce70: 203d 2073 656e 6465 7273 5b30 5d0a 0a20   = senders[0].. 
-0003ce80: 2020 2020 2020 2020 2020 2023 2049 7465             # Ite
-0003ce90: 7261 7465 2074 6872 6f75 6768 2074 6173  rate through tas
-0003cea0: 6b73 2069 6e20 6d65 6d6f 7279 2c20 6c65  ks in memory, le
-0003ceb0: 6173 7420 7265 6365 6e74 6c79 2069 6e73  ast recently ins
-0003cec0: 6572 7465 6420 6669 7273 740a 2020 2020  erted first.    
-0003ced0: 2020 2020 2020 2020 666f 7220 7473 2069          for ts i
-0003cee0: 6e20 7473 5f69 7465 723a 0a20 2020 2020  n ts_iter:.     
-0003cef0: 2020 2020 2020 2020 2020 2069 6620 6b65             if ke
-0003cf00: 7973 2069 7320 6e6f 7420 4e6f 6e65 2061  ys is not None a
-0003cf10: 6e64 2074 732e 6b65 7920 6e6f 7420 696e  nd ts.key not in
-0003cf20: 206b 6579 733a 0a20 2020 2020 2020 2020   keys:.         
-0003cf30: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-0003cf40: 6e75 650a 2020 2020 2020 2020 2020 2020  nue.            
-0003cf50: 2020 2020 6e62 7974 6573 203d 2074 732e      nbytes = ts.
-0003cf60: 6e62 7974 6573 0a20 2020 2020 2020 2020  nbytes.         
-0003cf70: 2020 2020 2020 2069 6620 6e62 7974 6573         if nbytes
-0003cf80: 202b 2073 6e64 5f62 7974 6573 5f6d 6178   + snd_bytes_max
-0003cf90: 203e 2030 3a0a 2020 2020 2020 2020 2020   > 0:.          
-0003cfa0: 2020 2020 2020 2020 2020 2320 4d6f 7669            # Movi
-0003cfb0: 6e67 2074 6869 7320 7461 736b 2077 6f75  ng this task wou
-0003cfc0: 6c64 2063 6175 7365 2074 6865 2073 656e  ld cause the sen
-0003cfd0: 6465 7220 746f 2067 6f20 6265 6c6f 7720  der to go below 
-0003cfe0: 6d65 616e 2061 6e64 0a20 2020 2020 2020  mean and.       
-0003cff0: 2020 2020 2020 2020 2020 2020 2023 2070               # p
-0003d000: 6f74 656e 7469 616c 6c79 2072 6973 6b20  otentially risk 
-0003d010: 6265 636f 6d69 6e67 2061 2072 6563 6970  becoming a recip
-0003d020: 6965 6e74 2c20 7768 6963 6820 776f 756c  ient, which woul
-0003d030: 6420 6361 7573 6520 7461 736b 7320 746f  d cause tasks to
-0003d040: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003d050: 2020 2020 2023 2062 6f75 6e63 6520 6172       # bounce ar
-0003d060: 6f75 6e64 2e20 4d6f 7665 206f 6e20 746f  ound. Move on to
-0003d070: 2074 6865 206e 6578 7420 7461 736b 206f   the next task o
-0003d080: 6620 7468 6520 7361 6d65 2073 656e 6465  f the same sende
-0003d090: 722e 0a20 2020 2020 2020 2020 2020 2020  r..             
-0003d0a0: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
-0003d0b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003d0c0: 2023 2046 696e 6420 7468 6520 7265 6369   # Find the reci
-0003d0d0: 7069 656e 742c 2066 6172 7468 6573 7420  pient, farthest 
-0003d0e0: 6672 6f6d 2074 6865 206d 6561 6e2c 2077  from the mean, w
-0003d0f0: 6869 6368 0a20 2020 2020 2020 2020 2020  hich.           
-0003d100: 2020 2020 2023 2031 2e20 6861 7320 656e       # 1. has en
-0003d110: 6f75 6768 2061 7661 696c 6162 6c65 2052  ough available R
-0003d120: 414d 2066 6f72 2074 6869 7320 7461 736b  AM for this task
-0003d130: 2c20 616e 640a 2020 2020 2020 2020 2020  , and.          
-0003d140: 2020 2020 2020 2320 322e 2064 6f65 736e        # 2. doesn
-0003d150: 2774 2068 6f6c 6420 6120 636f 7079 206f  't hold a copy o
-0003d160: 6620 7468 6973 2074 6173 6b20 616c 7265  f this task alre
-0003d170: 6164 790a 2020 2020 2020 2020 2020 2020  ady.            
-0003d180: 2020 2020 2320 5468 6572 6520 6d61 7920      # There may 
-0003d190: 6e6f 7420 6265 2061 6e79 2074 6861 7420  not be any that 
-0003d1a0: 7361 7469 7366 6965 7320 7468 6573 6520  satisfies these 
-0003d1b0: 636f 6e64 6974 696f 6e73 3b20 696e 2074  conditions; in t
-0003d1c0: 6869 7320 6361 7365 0a20 2020 2020 2020  his case.       
-0003d1d0: 2020 2020 2020 2020 2023 2074 6869 7320           # this 
-0003d1e0: 7461 736b 2077 6f6e 2774 2062 6520 6d6f  task won't be mo
-0003d1f0: 7665 642e 0a20 2020 2020 2020 2020 2020  ved..           
-0003d200: 2020 2020 2073 6b69 7070 6564 5f72 6563       skipped_rec
-0003d210: 6970 6965 6e74 7320 3d20 5b5d 0a20 2020  ipients = [].   
-0003d220: 2020 2020 2020 2020 2020 2020 2075 7365               use
-0003d230: 5f72 6563 6970 6965 6e74 203d 2046 616c  _recipient = Fal
-0003d240: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
-0003d250: 2020 2077 6869 6c65 2072 6563 6970 6965     while recipie
-0003d260: 6e74 7320 616e 6420 6e6f 7420 7573 655f  nts and not use_
-0003d270: 7265 6369 7069 656e 743a 0a20 2020 2020  recipient:.     
-0003d280: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0003d290: 6563 5f62 7974 6573 5f6d 6178 2c20 7265  ec_bytes_max, re
-0003d2a0: 635f 6279 7465 735f 6d69 6e2c 205f 2c20  c_bytes_min, _, 
-0003d2b0: 7265 635f 7773 203d 2072 6563 6970 6965  rec_ws = recipie
-0003d2c0: 6e74 735b 305d 0a20 2020 2020 2020 2020  nts[0].         
-0003d2d0: 2020 2020 2020 2020 2020 2069 6620 6e62             if nb
-0003d2e0: 7974 6573 202b 2072 6563 5f62 7974 6573  ytes + rec_bytes
-0003d2f0: 5f6d 6178 203e 2030 3a0a 2020 2020 2020  _max > 0:.      
-0003d300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d310: 2020 2320 7265 6369 7069 656e 7473 2061    # recipients a
-0003d320: 7265 2073 6f72 7465 6420 6279 2072 6563  re sorted by rec
-0003d330: 5f62 7974 6573 5f6d 6178 2e0a 2020 2020  _bytes_max..    
-0003d340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d350: 2020 2020 2320 5468 6520 6e65 7874 206f      # The next o
-0003d360: 6e65 7320 7769 6c6c 2062 6520 776f 7273  nes will be wors
-0003d370: 653b 206e 6f20 7265 6173 6f6e 2074 6f20  e; no reason to 
-0003d380: 636f 6e74 696e 7565 2069 7465 7261 7469  continue iterati
-0003d390: 6e67 0a20 2020 2020 2020 2020 2020 2020  ng.             
-0003d3a0: 2020 2020 2020 2020 2020 2062 7265 616b             break
-0003d3b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003d3c0: 2020 2020 2075 7365 5f72 6563 6970 6965       use_recipie
-0003d3d0: 6e74 203d 2074 7320 6e6f 7420 696e 2072  nt = ts not in r
-0003d3e0: 6563 5f77 732e 5f68 6173 5f77 6861 740a  ec_ws._has_what.
-0003d3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d400: 2020 2020 6966 206e 6f74 2075 7365 5f72      if not use_r
-0003d410: 6563 6970 6965 6e74 3a0a 2020 2020 2020  ecipient:.      
-0003d420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d430: 2020 736b 6970 7065 645f 7265 6369 7069    skipped_recipi
-0003d440: 656e 7473 2e61 7070 656e 6428 6865 6170  ents.append(heap
-0003d450: 712e 6865 6170 706f 7028 7265 6369 7069  q.heappop(recipi
-0003d460: 656e 7473 2929 0a0a 2020 2020 2020 2020  ents))..        
-0003d470: 2020 2020 2020 2020 666f 7220 7265 6369          for reci
-0003d480: 7069 656e 7420 696e 2073 6b69 7070 6564  pient in skipped
-0003d490: 5f72 6563 6970 6965 6e74 733a 0a20 2020  _recipients:.   
-0003d4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d4b0: 2068 6561 7071 2e68 6561 7070 7573 6828   heapq.heappush(
-0003d4c0: 7265 6369 7069 656e 7473 2c20 7265 6369  recipients, reci
-0003d4d0: 7069 656e 7429 0a0a 2020 2020 2020 2020  pient)..        
-0003d4e0: 2020 2020 2020 2020 6966 206e 6f74 2075          if not u
-0003d4f0: 7365 5f72 6563 6970 6965 6e74 3a0a 2020  se_recipient:.  
-0003d500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d510: 2020 2320 5468 6973 2074 6173 6b20 6861    # This task ha
-0003d520: 7320 6e6f 2072 6563 6970 6965 6e74 7320  s no recipients 
-0003d530: 6176 6169 6c61 626c 652e 204c 6561 7665  available. Leave
-0003d540: 2069 7420 6f6e 2074 6865 2073 656e 6465   it on the sende
-0003d550: 7220 616e 640a 2020 2020 2020 2020 2020  r and.          
-0003d560: 2020 2020 2020 2020 2020 2320 6d6f 7665            # move
-0003d570: 206f 6e20 746f 2074 6865 206e 6578 7420   on to the next 
-0003d580: 7461 736b 206f 6620 7468 6520 7361 6d65  task of the same
-0003d590: 2073 656e 6465 722e 0a20 2020 2020 2020   sender..       
-0003d5a0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-0003d5b0: 7469 6e75 650a 0a20 2020 2020 2020 2020  tinue..         
-0003d5c0: 2020 2020 2020 2023 2053 6368 6564 756c         # Schedul
-0003d5d0: 6520 7461 736b 2066 6f72 2074 7261 6e73  e task for trans
-0003d5e0: 6665 7220 6672 6f6d 2073 656e 6465 7220  fer from sender 
-0003d5f0: 746f 2072 6563 6970 6965 6e74 0a20 2020  to recipient.   
-0003d600: 2020 2020 2020 2020 2020 2020 206d 7367               msg
-0003d610: 732e 6170 7065 6e64 2828 736e 645f 7773  s.append((snd_ws
-0003d620: 2c20 7265 635f 7773 2c20 7473 2929 0a0a  , rec_ws, ts))..
-0003d630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d640: 2320 2a5f 6279 7465 735f 6d61 782f 6d69  # *_bytes_max/mi
-0003d650: 6e20 6172 6520 616c 6c20 6e65 6761 7469  n are all negati
-0003d660: 7665 2066 6f72 2068 6561 7020 736f 7274  ve for heap sort
-0003d670: 696e 670a 2020 2020 2020 2020 2020 2020  ing.            
-0003d680: 2020 2020 736e 645f 6279 7465 735f 6d61      snd_bytes_ma
-0003d690: 7820 2b3d 206e 6279 7465 730a 2020 2020  x += nbytes.    
-0003d6a0: 2020 2020 2020 2020 2020 2020 736e 645f              snd_
-0003d6b0: 6279 7465 735f 6d69 6e20 2b3d 206e 6279  bytes_min += nby
-0003d6c0: 7465 730a 2020 2020 2020 2020 2020 2020  tes.            
-0003d6d0: 2020 2020 7265 635f 6279 7465 735f 6d61      rec_bytes_ma
-0003d6e0: 7820 2b3d 206e 6279 7465 730a 2020 2020  x += nbytes.    
-0003d6f0: 2020 2020 2020 2020 2020 2020 7265 635f              rec_
-0003d700: 6279 7465 735f 6d69 6e20 2b3d 206e 6279  bytes_min += nby
-0003d710: 7465 730a 0a20 2020 2020 2020 2020 2020  tes..           
-0003d720: 2020 2020 2023 2053 746f 7020 6974 6572       # Stop iter
-0003d730: 6174 696e 6720 6f6e 2074 6865 2074 6173  ating on the tas
-0003d740: 6b73 206f 6620 7468 6973 2073 656e 6465  ks of this sende
-0003d750: 7220 666f 7220 6e6f 7720 616e 642c 2069  r for now and, i
-0003d760: 6620 6974 2073 7469 6c6c 0a20 2020 2020  f it still.     
-0003d770: 2020 2020 2020 2020 2020 2023 2068 6173             # has
-0003d780: 2062 7974 6573 2074 6f20 6c6f 7365 2c20   bytes to lose, 
-0003d790: 7075 7368 2069 7420 6261 636b 2069 6e74  push it back int
-0003d7a0: 6f20 7468 6520 7365 6e64 6572 7320 6865  o the senders he
-0003d7b0: 6170 3b20 6974 206d 6179 206f 7220 6d61  ap; it may or ma
-0003d7c0: 790a 2020 2020 2020 2020 2020 2020 2020  y.              
-0003d7d0: 2020 2320 6e6f 7420 636f 6d65 2062 6163    # not come bac
-0003d7e0: 6b20 6f6e 2074 6f70 2061 6761 696e 2e0a  k on top again..
-0003d7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d800: 6966 2073 6e64 5f62 7974 6573 5f6d 696e  if snd_bytes_min
-0003d810: 203c 2030 3a0a 2020 2020 2020 2020 2020   < 0:.          
-0003d820: 2020 2020 2020 2020 2020 2320 5365 6520            # See 
-0003d830: 6465 6669 6e69 7469 6f6e 206f 6620 7365  definition of se
-0003d840: 6e64 6572 7320 6162 6f76 650a 2020 2020  nders above.    
-0003d850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d860: 6865 6170 712e 6865 6170 7265 706c 6163  heapq.heapreplac
-0003d870: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
-0003d880: 2020 2020 2020 2020 2020 2073 656e 6465             sende
-0003d890: 7273 2c0a 2020 2020 2020 2020 2020 2020  rs,.            
-0003d8a0: 2020 2020 2020 2020 2020 2020 2873 6e64              (snd
-0003d8b0: 5f62 7974 6573 5f6d 6178 2c20 736e 645f  _bytes_max, snd_
-0003d8c0: 6279 7465 735f 6d69 6e2c 2069 6428 736e  bytes_min, id(sn
-0003d8d0: 645f 7773 292c 2073 6e64 5f77 732c 2074  d_ws), snd_ws, t
-0003d8e0: 735f 6974 6572 292c 0a20 2020 2020 2020  s_iter),.       
-0003d8f0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-0003d900: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0003d910: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0003d920: 2020 2020 2020 2020 2068 6561 7071 2e68           heapq.h
-0003d930: 6561 7070 6f70 2873 656e 6465 7273 290a  eappop(senders).
-0003d940: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003d950: 2023 2049 6620 7265 6369 7069 656e 7420   # If recipient 
-0003d960: 7374 696c 6c20 6861 7320 6279 7465 7320  still has bytes 
-0003d970: 746f 2067 6169 6e2c 2070 7573 6820 6974  to gain, push it
-0003d980: 2062 6163 6b20 696e 746f 2074 6865 2072   back into the r
-0003d990: 6563 6970 6965 6e74 730a 2020 2020 2020  ecipients.      
-0003d9a0: 2020 2020 2020 2020 2020 2320 6865 6170            # heap
-0003d9b0: 3b20 6974 206d 6179 206f 7220 6d61 7920  ; it may or may 
-0003d9c0: 6e6f 7420 636f 6d65 2062 6163 6b20 6f6e  not come back on
-0003d9d0: 2074 6f70 2061 6761 696e 2e0a 2020 2020   top again..    
-0003d9e0: 2020 2020 2020 2020 2020 2020 6966 2072              if r
-0003d9f0: 6563 5f62 7974 6573 5f6d 696e 203c 2030  ec_bytes_min < 0
-0003da00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0003da10: 2020 2020 2020 2320 5365 6520 6465 6669        # See defi
-0003da20: 6e69 7469 6f6e 206f 6620 7265 6369 7069  nition of recipi
-0003da30: 656e 7473 2061 626f 7665 0a20 2020 2020  ents above.     
-0003da40: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-0003da50: 6561 7071 2e68 6561 7072 6570 6c61 6365  eapq.heapreplace
-0003da60: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0003da70: 2020 2020 2020 2020 2020 7265 6369 7069            recipi
-0003da80: 656e 7473 2c0a 2020 2020 2020 2020 2020  ents,.          
-0003da90: 2020 2020 2020 2020 2020 2020 2020 2872                (r
-0003daa0: 6563 5f62 7974 6573 5f6d 6178 2c20 7265  ec_bytes_max, re
-0003dab0: 635f 6279 7465 735f 6d69 6e2c 2069 6428  c_bytes_min, id(
-0003dac0: 7265 635f 7773 292c 2072 6563 5f77 7329  rec_ws), rec_ws)
-0003dad0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0003dae0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0003daf0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0003db00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003db10: 2020 6865 6170 712e 6865 6170 706f 7028    heapq.heappop(
-0003db20: 7265 6369 7069 656e 7473 290a 0a20 2020  recipients)..   
-0003db30: 2020 2020 2020 2020 2020 2020 2023 204d               # M
-0003db40: 6f76 6520 746f 206e 6578 7420 7365 6e64  ove to next send
-0003db50: 6572 2077 6974 6820 7468 6520 6d6f 7374  er with the most
-0003db60: 2064 6174 6120 746f 206c 6f73 652e 0a20   data to lose.. 
-0003db70: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0003db80: 2049 7420 6d61 7920 6f72 206d 6179 206e   It may or may n
-0003db90: 6f74 2062 6520 7468 6520 7361 6d65 2073  ot be the same s
-0003dba0: 656e 6465 7220 6167 6169 6e2e 0a20 2020  ender again..   
-0003dbb0: 2020 2020 2020 2020 2020 2020 2062 7265               bre
-0003dbc0: 616b 0a0a 2020 2020 2020 2020 2020 2020  ak..            
-0003dbd0: 656c 7365 3a20 2023 2066 6f72 2074 7320  else:  # for ts 
-0003dbe0: 696e 2074 735f 6974 6572 0a20 2020 2020  in ts_iter.     
-0003dbf0: 2020 2020 2020 2020 2020 2023 2045 7868             # Exh
-0003dc00: 6175 7374 6564 2074 6173 6b73 206f 6e20  austed tasks on 
-0003dc10: 7468 6973 2073 656e 6465 720a 2020 2020  this sender.    
-0003dc20: 2020 2020 2020 2020 2020 2020 6865 6170              heap
-0003dc30: 712e 6865 6170 706f 7028 7365 6e64 6572  q.heappop(sender
-0003dc40: 7329 0a0a 2020 2020 2020 2020 7265 7475  s)..        retu
-0003dc50: 726e 206d 7367 730a 0a20 2020 2061 7379  rn msgs..    asy
-0003dc60: 6e63 2064 6566 205f 7265 6261 6c61 6e63  nc def _rebalanc
-0003dc70: 655f 6d6f 7665 5f64 6174 6128 0a20 2020  e_move_data(.   
-0003dc80: 2020 2020 2073 656c 662c 206d 7367 733a       self, msgs:
-0003dc90: 206c 6973 745b 7475 706c 655b 576f 726b   list[tuple[Work
-0003dca0: 6572 5374 6174 652c 2057 6f72 6b65 7253  erState, WorkerS
-0003dcb0: 7461 7465 2c20 5461 736b 5374 6174 655d  tate, TaskState]
-0003dcc0: 5d2c 2073 7469 6d75 6c75 735f 6964 3a20  ], stimulus_id: 
-0003dcd0: 7374 720a 2020 2020 2920 2d3e 2064 6963  str.    ) -> dic
-0003dce0: 743a 0a20 2020 2020 2020 2022 2222 5065  t:.        """Pe
-0003dcf0: 7266 6f72 6d20 7468 6520 6163 7475 616c  rform the actual
-0003dd00: 2074 7261 6e73 6665 7220 6f66 2064 6174   transfer of dat
-0003dd10: 6120 6163 726f 7373 2074 6865 206e 6574  a across the net
-0003dd20: 776f 726b 2069 6e20 7265 6261 6c61 6e63  work in rebalanc
-0003dd30: 6528 292e 0a20 2020 2020 2020 2054 616b  e()..        Tak
-0003dd40: 6573 2069 6e20 696e 7075 7420 7468 6520  es in input the 
-0003dd50: 6f75 7470 7574 206f 6620 5f72 6562 616c  output of _rebal
-0003dd60: 616e 6365 5f66 696e 645f 6d73 6773 2829  ance_find_msgs()
-0003dd70: 2c20 7468 6174 2069 7320 6120 6c69 7374  , that is a list
-0003dd80: 206f 6620 7475 706c 6573 3a0a 0a20 2020   of tuples:..   
-0003dd90: 2020 2020 202d 2073 656e 6465 7220 776f       - sender wo
-0003dda0: 726b 6572 0a20 2020 2020 2020 202d 2072  rker.        - r
-0003ddb0: 6563 6970 6965 6e74 2077 6f72 6b65 720a  ecipient worker.
-0003ddc0: 2020 2020 2020 2020 2d20 7461 736b 2074          - task t
-0003ddd0: 6f20 6265 2074 7261 6e73 6665 7272 6564  o be transferred
-0003dde0: 0a0a 2020 2020 2020 2020 4649 584d 4520  ..        FIXME 
-0003ddf0: 7468 6973 206d 6574 686f 6420 6973 206e  this method is n
-0003de00: 6f74 2072 6f62 7573 7420 7768 656e 2074  ot robust when t
-0003de10: 6865 2063 6c75 7374 6572 2069 7320 6e6f  he cluster is no
-0003de20: 7420 6964 6c65 2e0a 2020 2020 2020 2020  t idle..        
-0003de30: 2222 220a 2020 2020 2020 2020 2320 7b72  """.        # {r
-0003de40: 6563 6970 6965 6e74 2061 6464 7265 7373  ecipient address
-0003de50: 3a20 7b6b 6579 3a20 5b73 656e 6465 7220  : {key: [sender 
-0003de60: 6164 6472 6573 732c 202e 2e2e 5d7d 7d0a  address, ...]}}.
-0003de70: 2020 2020 2020 2020 746f 5f72 6563 6970          to_recip
-0003de80: 6965 6e74 733a 2064 6566 6175 6c74 6469  ients: defaultdi
-0003de90: 6374 5b73 7472 2c20 6465 6661 756c 7464  ct[str, defaultd
-0003dea0: 6963 745b 4b65 792c 206c 6973 745b 7374  ict[Key, list[st
-0003deb0: 725d 5d5d 203d 2064 6566 6175 6c74 6469  r]]] = defaultdi
-0003dec0: 6374 280a 2020 2020 2020 2020 2020 2020  ct(.            
-0003ded0: 6c61 6d62 6461 3a20 6465 6661 756c 7464  lambda: defaultd
-0003dee0: 6963 7428 6c69 7374 290a 2020 2020 2020  ict(list).      
-0003def0: 2020 290a 2020 2020 2020 2020 666f 7220    ).        for 
-0003df00: 736e 645f 7773 2c20 7265 635f 7773 2c20  snd_ws, rec_ws, 
-0003df10: 7473 2069 6e20 6d73 6773 3a0a 2020 2020  ts in msgs:.    
-0003df20: 2020 2020 2020 2020 746f 5f72 6563 6970          to_recip
-0003df30: 6965 6e74 735b 7265 635f 7773 2e61 6464  ients[rec_ws.add
-0003df40: 7265 7373 5d5b 7473 2e6b 6579 5d2e 6170  ress][ts.key].ap
-0003df50: 7065 6e64 2873 6e64 5f77 732e 6164 6472  pend(snd_ws.addr
-0003df60: 6573 7329 0a20 2020 2020 2020 2066 6169  ess).        fai
-0003df70: 6c65 645f 6b65 7973 5f62 795f 7265 6369  led_keys_by_reci
-0003df80: 7069 656e 7420 3d20 6469 6374 280a 2020  pient = dict(.  
-0003df90: 2020 2020 2020 2020 2020 7a69 7028 0a20            zip(. 
-0003dfa0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0003dfb0: 6f5f 7265 6369 7069 656e 7473 2c0a 2020  o_recipients,.  
-0003dfc0: 2020 2020 2020 2020 2020 2020 2020 6177                aw
-0003dfd0: 6169 7420 6173 796e 6369 6f2e 6761 7468  ait asyncio.gath
-0003dfe0: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
-0003dff0: 2020 2020 2020 2020 2a28 0a20 2020 2020          *(.     
-0003e000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e010: 2020 2023 204e 6f74 653a 2074 6869 7320     # Note: this 
-0003e020: 6e65 7665 7220 7261 6973 6573 2065 7863  never raises exc
-0003e030: 6570 7469 6f6e 730a 2020 2020 2020 2020  eptions.        
-0003e040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e050: 7365 6c66 2e67 6174 6865 725f 6f6e 5f77  self.gather_on_w
-0003e060: 6f72 6b65 7228 772c 2077 686f 5f68 6173  orker(w, who_has
-0003e070: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0003e080: 2020 2020 2020 2020 2020 666f 7220 772c            for w,
-0003e090: 2077 686f 5f68 6173 2069 6e20 746f 5f72   who_has in to_r
-0003e0a0: 6563 6970 6965 6e74 732e 6974 656d 7328  ecipients.items(
-0003e0b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0003e0c0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0003e0d0: 2020 2020 2020 2020 292c 0a20 2020 2020          ),.     
-0003e0e0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0003e0f0: 2029 0a0a 2020 2020 2020 2020 746f 5f73   )..        to_s
-0003e100: 656e 6465 7273 203d 2064 6566 6175 6c74  enders = default
-0003e110: 6469 6374 286c 6973 7429 0a20 2020 2020  dict(list).     
-0003e120: 2020 2066 6f72 2073 6e64 5f77 732c 2072     for snd_ws, r
-0003e130: 6563 5f77 732c 2074 7320 696e 206d 7367  ec_ws, ts in msg
-0003e140: 733a 0a20 2020 2020 2020 2020 2020 2069  s:.            i
-0003e150: 6620 7473 2e6b 6579 206e 6f74 2069 6e20  f ts.key not in 
-0003e160: 6661 696c 6564 5f6b 6579 735f 6279 5f72  failed_keys_by_r
-0003e170: 6563 6970 6965 6e74 5b72 6563 5f77 732e  ecipient[rec_ws.
-0003e180: 6164 6472 6573 735d 3a0a 2020 2020 2020  address]:.      
-0003e190: 2020 2020 2020 2020 2020 746f 5f73 656e            to_sen
-0003e1a0: 6465 7273 5b73 6e64 5f77 732e 6164 6472  ders[snd_ws.addr
-0003e1b0: 6573 735d 2e61 7070 656e 6428 7473 2e6b  ess].append(ts.k
-0003e1c0: 6579 290a 0a20 2020 2020 2020 2023 204e  ey)..        # N
-0003e1d0: 6f74 653a 2074 6869 7320 6e65 7665 7220  ote: this never 
-0003e1e0: 7261 6973 6573 2065 7863 6570 7469 6f6e  raises exception
-0003e1f0: 730a 2020 2020 2020 2020 6177 6169 7420  s.        await 
-0003e200: 6173 796e 6369 6f2e 6761 7468 6572 280a  asyncio.gather(.
-0003e210: 2020 2020 2020 2020 2020 2020 2a28 7365              *(se
-0003e220: 6c66 2e64 656c 6574 655f 776f 726b 6572  lf.delete_worker
-0003e230: 5f64 6174 6128 722c 2076 2c20 7374 696d  _data(r, v, stim
-0003e240: 756c 7573 5f69 6429 2066 6f72 2072 2c20  ulus_id) for r, 
-0003e250: 7620 696e 2074 6f5f 7365 6e64 6572 732e  v in to_senders.
-0003e260: 6974 656d 7328 2929 0a20 2020 2020 2020  items()).       
-0003e270: 2029 0a0a 2020 2020 2020 2020 666f 7220   )..        for 
-0003e280: 722c 2076 2069 6e20 746f 5f72 6563 6970  r, v in to_recip
-0003e290: 6965 6e74 732e 6974 656d 7328 293a 0a20  ients.items():. 
-0003e2a0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0003e2b0: 6c6f 675f 6576 656e 7428 722c 207b 2261  log_event(r, {"a
-0003e2c0: 6374 696f 6e22 3a20 2272 6562 616c 616e  ction": "rebalan
-0003e2d0: 6365 222c 2022 7768 6f5f 6861 7322 3a20  ce", "who_has": 
-0003e2e0: 767d 290a 2020 2020 2020 2020 7365 6c66  v}).        self
-0003e2f0: 2e6c 6f67 5f65 7665 6e74 280a 2020 2020  .log_event(.    
-0003e300: 2020 2020 2020 2020 2261 6c6c 222c 0a20          "all",. 
-0003e310: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-0003e320: 2020 2020 2020 2020 2020 2020 2022 6163               "ac
-0003e330: 7469 6f6e 223a 2022 7265 6261 6c61 6e63  tion": "rebalanc
-0003e340: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
-0003e350: 2020 2020 2273 656e 6465 7273 223a 2076      "senders": v
-0003e360: 616c 6d61 7028 6c65 6e2c 2074 6f5f 7365  almap(len, to_se
-0003e370: 6e64 6572 7329 2c0a 2020 2020 2020 2020  nders),.        
-0003e380: 2020 2020 2020 2020 2272 6563 6970 6965          "recipie
-0003e390: 6e74 7322 3a20 7661 6c6d 6170 286c 656e  nts": valmap(len
-0003e3a0: 2c20 746f 5f72 6563 6970 6965 6e74 7329  , to_recipients)
-0003e3b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0003e3c0: 2020 226d 6f76 6564 5f6b 6579 7322 3a20    "moved_keys": 
-0003e3d0: 6c65 6e28 6d73 6773 292c 0a20 2020 2020  len(msgs),.     
-0003e3e0: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
-0003e3f0: 2020 290a 0a20 2020 2020 2020 206d 6973    )..        mis
-0003e400: 7369 6e67 5f6b 6579 7320 3d20 7b6b 2066  sing_keys = {k f
-0003e410: 6f72 2072 2069 6e20 6661 696c 6564 5f6b  or r in failed_k
-0003e420: 6579 735f 6279 5f72 6563 6970 6965 6e74  eys_by_recipient
-0003e430: 2e76 616c 7565 7328 2920 666f 7220 6b20  .values() for k 
-0003e440: 696e 2072 7d0a 2020 2020 2020 2020 6966  in r}.        if
-0003e450: 206d 6973 7369 6e67 5f6b 6579 733a 0a20   missing_keys:. 
-0003e460: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0003e470: 6e20 7b22 7374 6174 7573 223a 2022 7061  n {"status": "pa
-0003e480: 7274 6961 6c2d 6661 696c 222c 2022 6b65  rtial-fail", "ke
-0003e490: 7973 223a 206c 6973 7428 6d69 7373 696e  ys": list(missin
-0003e4a0: 675f 6b65 7973 297d 0a20 2020 2020 2020  g_keys)}.       
-0003e4b0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0003e4c0: 2020 2072 6574 7572 6e20 7b22 7374 6174     return {"stat
-0003e4d0: 7573 223a 2022 4f4b 227d 0a0a 2020 2020  us": "OK"}..    
-0003e4e0: 6173 796e 6320 6465 6620 7265 706c 6963  async def replic
-0003e4f0: 6174 6528 0a20 2020 2020 2020 2073 656c  ate(.        sel
-0003e500: 662c 0a20 2020 2020 2020 2063 6f6d 6d3d  f,.        comm=
-0003e510: 4e6f 6e65 2c0a 2020 2020 2020 2020 6b65  None,.        ke
-0003e520: 7973 3d4e 6f6e 652c 0a20 2020 2020 2020  ys=None,.       
-0003e530: 206e 3d4e 6f6e 652c 0a20 2020 2020 2020   n=None,.       
-0003e540: 2077 6f72 6b65 7273 3d4e 6f6e 652c 0a20   workers=None,. 
-0003e550: 2020 2020 2020 2062 7261 6e63 6869 6e67         branching
-0003e560: 5f66 6163 746f 723d 322c 0a20 2020 2020  _factor=2,.     
-0003e570: 2020 2064 656c 6574 653d 5472 7565 2c0a     delete=True,.
-0003e580: 2020 2020 2020 2020 7374 696d 756c 7573          stimulus
-0003e590: 5f69 643d 4e6f 6e65 2c0a 2020 2020 293a  _id=None,.    ):
-0003e5a0: 0a20 2020 2020 2020 2022 2222 5265 706c  .        """Repl
-0003e5b0: 6963 6174 6520 6461 7461 2074 6872 6f75  icate data throu
-0003e5c0: 6768 6f75 7420 636c 7573 7465 720a 0a20  ghout cluster.. 
-0003e5d0: 2020 2020 2020 2054 6869 7320 7065 7266         This perf
-0003e5e0: 6f72 6d73 2061 2074 7265 6520 636f 7079  orms a tree copy
-0003e5f0: 206f 6620 7468 6520 6461 7461 2074 6872   of the data thr
-0003e600: 6f75 6768 6f75 7420 7468 6520 6e65 7477  oughout the netw
-0003e610: 6f72 6b0a 2020 2020 2020 2020 696e 6469  ork.        indi
-0003e620: 7669 6475 616c 6c79 206f 6e20 6561 6368  vidually on each
-0003e630: 2070 6965 6365 206f 6620 6461 7461 2e0a   piece of data..
-0003e640: 0a20 2020 2020 2020 2050 6172 616d 6574  .        Paramet
-0003e650: 6572 730a 2020 2020 2020 2020 2d2d 2d2d  ers.        ----
-0003e660: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 206b  ------.        k
-0003e670: 6579 733a 2049 7465 7261 626c 650a 2020  eys: Iterable.  
-0003e680: 2020 2020 2020 2020 2020 6c69 7374 206f            list o
-0003e690: 6620 6b65 7973 2074 6f20 7265 706c 6963  f keys to replic
-0003e6a0: 6174 650a 2020 2020 2020 2020 6e3a 2069  ate.        n: i
-0003e6b0: 6e74 0a20 2020 2020 2020 2020 2020 204e  nt.            N
-0003e6c0: 756d 6265 7220 6f66 2072 6570 6c69 6361  umber of replica
-0003e6d0: 7469 6f6e 7320 7765 2065 7870 6563 7420  tions we expect 
-0003e6e0: 746f 2073 6565 2077 6974 6869 6e20 7468  to see within th
-0003e6f0: 6520 636c 7573 7465 720a 2020 2020 2020  e cluster.      
-0003e700: 2020 6272 616e 6368 696e 675f 6661 6374    branching_fact
-0003e710: 6f72 3a20 696e 742c 206f 7074 696f 6e61  or: int, optiona
-0003e720: 6c0a 2020 2020 2020 2020 2020 2020 5468  l.            Th
-0003e730: 6520 6e75 6d62 6572 206f 6620 776f 726b  e number of work
-0003e740: 6572 7320 7468 6174 2063 616e 2063 6f70  ers that can cop
-0003e750: 7920 6461 7461 2069 6e20 6561 6368 2067  y data in each g
-0003e760: 656e 6572 6174 696f 6e2e 0a20 2020 2020  eneration..     
-0003e770: 2020 2020 2020 2054 6865 206c 6172 6765         The large
-0003e780: 7220 7468 6520 6272 616e 6368 696e 6720  r the branching 
-0003e790: 6661 6374 6f72 2c20 7468 6520 6d6f 7265  factor, the more
-0003e7a0: 2064 6174 6120 7765 2063 6f70 7920 696e   data we copy in
-0003e7b0: 0a20 2020 2020 2020 2020 2020 2061 2073  .            a s
-0003e7c0: 696e 676c 6520 7374 6570 2c20 6275 7420  ingle step, but 
-0003e7d0: 7468 6520 6d6f 7265 2061 2067 6976 656e  the more a given
-0003e7e0: 2077 6f72 6b65 7220 7269 736b 7320 6265   worker risks be
-0003e7f0: 696e 670a 2020 2020 2020 2020 2020 2020  ing.            
-0003e800: 7377 616d 7065 6420 6279 2064 6174 6120  swamped by data 
-0003e810: 7265 7175 6573 7473 2e0a 0a20 2020 2020  requests...     
-0003e820: 2020 2053 6565 2061 6c73 6f0a 2020 2020     See also.    
-0003e830: 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020      --------.   
-0003e840: 2020 2020 2053 6368 6564 756c 6572 2e72       Scheduler.r
-0003e850: 6562 616c 616e 6365 0a20 2020 2020 2020  ebalance.       
-0003e860: 2022 2222 0a20 2020 2020 2020 2073 7469   """.        sti
-0003e870: 6d75 6c75 735f 6964 203d 2073 7469 6d75  mulus_id = stimu
-0003e880: 6c75 735f 6964 206f 7220 6622 7265 706c  lus_id or f"repl
-0003e890: 6963 6174 652d 7b74 696d 6528 297d 220a  icate-{time()}".
-0003e8a0: 2020 2020 2020 2020 6173 7365 7274 2062          assert b
-0003e8b0: 7261 6e63 6869 6e67 5f66 6163 746f 7220  ranching_factor 
-0003e8c0: 3e20 300a 2020 2020 2020 2020 2320 446f  > 0.        # Do
-0003e8d0: 776e 6772 6164 6520 7265 656e 7472 616e  wngrade reentran
-0003e8e0: 7420 6c6f 636b 2074 6f20 6e6f 6e2d 7265  t lock to non-re
-0003e8f0: 656e 7472 616e 740a 2020 2020 2020 2020  entrant.        
-0003e900: 6173 796e 6320 7769 7468 2073 656c 662e  async with self.
-0003e910: 5f72 6570 6c69 6361 5f6c 6f63 6b28 2822  _replica_lock(("
-0003e920: 7265 706c 6963 6174 6522 2c20 6f62 6a65  replicate", obje
-0003e930: 6374 2829 2929 3a0a 2020 2020 2020 2020  ct())):.        
-0003e940: 2020 2020 6966 2077 6f72 6b65 7273 2069      if workers i
-0003e950: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-0003e960: 2020 2020 2020 2020 2020 2020 776f 726b              work
-0003e970: 6572 7320 3d20 7b73 656c 662e 776f 726b  ers = {self.work
-0003e980: 6572 735b 775d 2066 6f72 2077 2069 6e20  ers[w] for w in 
-0003e990: 7365 6c66 2e77 6f72 6b65 7273 5f6c 6973  self.workers_lis
-0003e9a0: 7428 776f 726b 6572 7329 7d0a 2020 2020  t(workers)}.    
-0003e9b0: 2020 2020 2020 2020 2020 2020 776f 726b              work
-0003e9c0: 6572 7320 3d20 7b77 7320 666f 7220 7773  ers = {ws for ws
-0003e9d0: 2069 6e20 776f 726b 6572 7320 6966 2077   in workers if w
-0003e9e0: 732e 7374 6174 7573 203d 3d20 5374 6174  s.status == Stat
-0003e9f0: 7573 2e72 756e 6e69 6e67 7d0a 2020 2020  us.running}.    
-0003ea00: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0003ea10: 2020 2020 2020 2020 2020 2020 2020 776f                wo
-0003ea20: 726b 6572 7320 3d20 7365 6c66 2e72 756e  rkers = self.run
-0003ea30: 6e69 6e67 0a0a 2020 2020 2020 2020 2020  ning..          
-0003ea40: 2020 6966 206e 2069 7320 4e6f 6e65 3a0a    if n is None:.
-0003ea50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ea60: 6e20 3d20 6c65 6e28 776f 726b 6572 7329  n = len(workers)
-0003ea70: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-0003ea80: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0003ea90: 2020 206e 203d 206d 696e 286e 2c20 6c65     n = min(n, le
-0003eaa0: 6e28 776f 726b 6572 7329 290a 2020 2020  n(workers)).    
-0003eab0: 2020 2020 2020 2020 6966 206e 203d 3d20          if n == 
-0003eac0: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
-0003ead0: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-0003eae0: 726f 7228 2243 616e 206e 6f74 2075 7365  ror("Can not use
-0003eaf0: 2072 6570 6c69 6361 7465 2074 6f20 6465   replicate to de
-0003eb00: 6c65 7465 2064 6174 6122 290a 0a20 2020  lete data")..   
-0003eb10: 2020 2020 2020 2020 2074 6173 6b73 203d           tasks =
-0003eb20: 207b 7365 6c66 2e74 6173 6b73 5b6b 5d20   {self.tasks[k] 
-0003eb30: 666f 7220 6b20 696e 206b 6579 737d 0a20  for k in keys}. 
-0003eb40: 2020 2020 2020 2020 2020 206d 6973 7369             missi
-0003eb50: 6e67 5f64 6174 6120 3d20 5b74 732e 6b65  ng_data = [ts.ke
-0003eb60: 7920 666f 7220 7473 2069 6e20 7461 736b  y for ts in task
-0003eb70: 7320 6966 206e 6f74 2074 732e 7768 6f5f  s if not ts.who_
-0003eb80: 6861 735d 0a20 2020 2020 2020 2020 2020  has].           
-0003eb90: 2069 6620 6d69 7373 696e 675f 6461 7461   if missing_data
-0003eba0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0003ebb0: 2020 7265 7475 726e 207b 2273 7461 7475    return {"statu
-0003ebc0: 7322 3a20 2270 6172 7469 616c 2d66 6169  s": "partial-fai
-0003ebd0: 6c22 2c20 226b 6579 7322 3a20 6d69 7373  l", "keys": miss
-0003ebe0: 696e 675f 6461 7461 7d0a 0a20 2020 2020  ing_data}..     
-0003ebf0: 2020 2020 2020 2023 2044 656c 6574 6520         # Delete 
-0003ec00: 6578 7472 616e 656f 7573 2064 6174 610a  extraneous data.
-0003ec10: 2020 2020 2020 2020 2020 2020 6966 2064              if d
-0003ec20: 656c 6574 653a 0a20 2020 2020 2020 2020  elete:.         
-0003ec30: 2020 2020 2020 2064 656c 5f77 6f72 6b65         del_worke
-0003ec40: 725f 7461 736b 7320 3d20 6465 6661 756c  r_tasks = defaul
-0003ec50: 7464 6963 7428 7365 7429 0a20 2020 2020  tdict(set).     
-0003ec60: 2020 2020 2020 2020 2020 2066 6f72 2074             for t
-0003ec70: 7320 696e 2074 6173 6b73 3a0a 2020 2020  s in tasks:.    
-0003ec80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ec90: 6465 6c5f 6361 6e64 6964 6174 6573 203d  del_candidates =
-0003eca0: 2074 7570 6c65 2874 732e 7768 6f5f 6861   tuple(ts.who_ha
-0003ecb0: 7320 2620 776f 726b 6572 7329 0a20 2020  s & workers).   
-0003ecc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ecd0: 2069 6620 6c65 6e28 6465 6c5f 6361 6e64   if len(del_cand
-0003ece0: 6964 6174 6573 2920 3e20 6e3a 0a20 2020  idates) > n:.   
-0003ecf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ed00: 2020 2020 2066 6f72 2077 7320 696e 2072       for ws in r
-0003ed10: 616e 646f 6d2e 7361 6d70 6c65 280a 2020  andom.sample(.  
-0003ed20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ed30: 2020 2020 2020 2020 2020 6465 6c5f 6361            del_ca
-0003ed40: 6e64 6964 6174 6573 2c20 6c65 6e28 6465  ndidates, len(de
-0003ed50: 6c5f 6361 6e64 6964 6174 6573 2920 2d20  l_candidates) - 
-0003ed60: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
-0003ed70: 2020 2020 2020 2020 2020 293a 0a20 2020            ):.   
+000384c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000384d0: 2020 6966 206f 6e5f 6572 726f 7220 3d3d    if on_error ==
+000384e0: 2022 7261 6973 6522 3a0a 2020 2020 2020   "raise":.      
+000384f0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+00038500: 6973 6520 5469 6d65 6f75 7445 7272 6f72  ise TimeoutError
+00038510: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00038520: 2020 2020 2020 2020 2020 6622 7b6c 656e            f"{len
+00038530: 2862 6164 5f6e 616e 6e69 6573 297d 2f7b  (bad_nannies)}/{
+00038540: 6c65 6e28 6e61 6e6e 6965 7329 7d20 6e61  len(nannies)} na
+00038550: 6e6e 7920 776f 726b 6572 2873 2920 6469  nny worker(s) di
+00038560: 6420 6e6f 7420 220a 2020 2020 2020 2020  d not ".        
+00038570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038580: 6622 7368 7574 2064 6f77 6e20 7769 7468  f"shut down with
+00038590: 696e 207b 7469 6d65 6f75 747d 733a 207b  in {timeout}s: {
+000385a0: 6261 645f 6e61 6e6e 6965 737d 220a 2020  bad_nannies}".  
+000385b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000385c0: 2020 290a 0a20 2020 2020 2020 2069 6620    )..        if 
+000385d0: 636c 6965 6e74 3a0a 2020 2020 2020 2020  client:.        
+000385e0: 2020 2020 7365 6c66 2e6c 6f67 5f65 7665      self.log_eve
+000385f0: 6e74 2863 6c69 656e 742c 207b 2261 6374  nt(client, {"act
+00038600: 696f 6e22 3a20 2272 6573 7461 7274 2d77  ion": "restart-w
+00038610: 6f72 6b65 7273 222c 2022 776f 726b 6572  orkers", "worker
+00038620: 7322 3a20 776f 726b 6572 737d 290a 2020  s": workers}).  
+00038630: 2020 2020 2020 7365 6c66 2e6c 6f67 5f65        self.log_e
+00038640: 7665 6e74 280a 2020 2020 2020 2020 2020  vent(.          
+00038650: 2020 2261 6c6c 222c 207b 2261 6374 696f    "all", {"actio
+00038660: 6e22 3a20 2272 6573 7461 7274 2d77 6f72  n": "restart-wor
+00038670: 6b65 7273 222c 2022 776f 726b 6572 7322  kers", "workers"
+00038680: 3a20 776f 726b 6572 732c 2022 636c 6965  : workers, "clie
+00038690: 6e74 223a 2063 6c69 656e 747d 0a20 2020  nt": client}.   
+000386a0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+000386b0: 6966 206e 6f74 2077 6169 745f 666f 725f  if not wait_for_
+000386c0: 776f 726b 6572 733a 0a20 2020 2020 2020  workers:.       
+000386d0: 2020 2020 206c 6f67 6765 722e 696e 666f       logger.info
+000386e0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000386f0: 2020 2257 6f72 6b65 7273 2072 6573 7461    "Workers resta
+00038700: 7274 2066 696e 6973 6865 6420 2864 6964  rt finished (did
+00038710: 206e 6f74 2077 6169 7420 666f 7220 6e65   not wait for ne
+00038720: 7720 776f 726b 6572 7329 2022 0a20 2020  w workers) ".   
+00038730: 2020 2020 2020 2020 2020 2020 2066 2228               f"(
+00038740: 7b73 7469 6d75 6c75 735f 6964 3d7d 220a  {stimulus_id=}".
+00038750: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00038760: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00038770: 206f 7574 0a0a 2020 2020 2020 2020 2320   out..        # 
+00038780: 4e4f 5445 3a20 6966 206e 6577 2028 756e  NOTE: if new (un
+00038790: 7265 6c61 7465 6429 2077 6f72 6b65 7273  related) workers
+000387a0: 206a 6f69 6e20 7768 696c 6520 7765 2772   join while we'r
+000387b0: 6520 7761 6974 696e 672c 2077 6520 6d61  e waiting, we ma
+000387c0: 7920 7265 7475 726e 0a20 2020 2020 2020  y return.       
+000387d0: 2023 2062 6566 6f72 6520 6f75 7220 7368   # before our sh
+000387e0: 7574 2d64 6f77 6e20 776f 726b 6572 7320  ut-down workers 
+000387f0: 6861 7665 2063 6f6d 6520 6261 636b 2075  have come back u
+00038800: 702e 2054 6861 7427 7320 6669 6e65 3b20  p. That's fine; 
+00038810: 776f 726b 6572 7320 6172 650a 2020 2020  workers are.    
+00038820: 2020 2020 2320 696e 7465 7263 6861 6e67      # interchang
+00038830: 6561 626c 652e 0a20 2020 2020 2020 2077  eable..        w
+00038840: 6869 6c65 206e 6f74 2064 6561 646c 696e  hile not deadlin
+00038850: 652e 6578 7069 7265 6420 616e 6420 6c65  e.expired and le
+00038860: 6e28 7365 6c66 2e77 6f72 6b65 7273 2920  n(self.workers) 
+00038870: 3c20 6e5f 776f 726b 6572 733a 0a20 2020  < n_workers:.   
+00038880: 2020 2020 2020 2020 2061 7761 6974 2061           await a
+00038890: 7379 6e63 696f 2e73 6c65 6570 2830 2e32  syncio.sleep(0.2
+000388a0: 290a 0a20 2020 2020 2020 2069 6620 6c65  )..        if le
+000388b0: 6e28 7365 6c66 2e77 6f72 6b65 7273 2920  n(self.workers) 
+000388c0: 3e3d 206e 5f77 6f72 6b65 7273 3a0a 2020  >= n_workers:.  
+000388d0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+000388e0: 2e69 6e66 6f28 6622 576f 726b 6572 7320  .info(f"Workers 
+000388f0: 7265 7374 6172 7420 6669 6e69 7368 6564  restart finished
+00038900: 2028 7b73 7469 6d75 6c75 735f 6964 3d7d   ({stimulus_id=}
+00038910: 2229 0a20 2020 2020 2020 2020 2020 2072  ").            r
+00038920: 6574 7572 6e20 6f75 740a 0a20 2020 2020  eturn out..     
+00038930: 2020 206d 7367 203d 2028 0a20 2020 2020     msg = (.     
+00038940: 2020 2020 2020 2066 2257 6169 7465 6420         f"Waited 
+00038950: 666f 7220 7b6c 656e 2877 6f72 6b65 7273  for {len(workers
+00038960: 297d 2077 6f72 6b65 7228 7329 2074 6f20  )} worker(s) to 
+00038970: 7265 636f 6e6e 6563 7420 6166 7465 7220  reconnect after 
+00038980: 7265 7374 6172 7469 6e67 2062 7574 2c20  restarting but, 
+00038990: 220a 2020 2020 2020 2020 2020 2020 6622  ".            f"
+000389a0: 6166 7465 7220 7b74 696d 656f 7574 7d73  after {timeout}s
+000389b0: 2c20 7b6e 5f77 6f72 6b65 7273 202d 206c  , {n_workers - l
+000389c0: 656e 2873 656c 662e 776f 726b 6572 7329  en(self.workers)
+000389d0: 7d20 6861 7665 206e 6f74 2072 6574 7572  } have not retur
+000389e0: 6e65 642e 2022 0a20 2020 2020 2020 2020  ned. ".         
+000389f0: 2020 2022 436f 6e73 6964 6572 2061 206c     "Consider a l
+00038a00: 6f6e 6765 7220 7469 6d65 6f75 742c 206f  onger timeout, o
+00038a10: 7220 6077 6169 745f 666f 725f 776f 726b  r `wait_for_work
+00038a20: 6572 733d 4661 6c73 6560 2e22 0a20 2020  ers=False`.".   
+00038a30: 2020 2020 2029 0a20 2020 2020 2020 2069       ).        i
+00038a40: 6620 6e6f 5f6e 616e 6e79 5f77 6f72 6b65  f no_nanny_worke
+00038a50: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
+00038a60: 6d73 6720 2b3d 2028 0a20 2020 2020 2020  msg += (.       
+00038a70: 2020 2020 2020 2020 2066 2220 5468 6520           f" The 
+00038a80: 7b6c 656e 286e 6f5f 6e61 6e6e 795f 776f  {len(no_nanny_wo
+00038a90: 726b 6572 7329 7d20 776f 726b 6572 2873  rkers)} worker(s
+00038aa0: 2920 6e6f 7420 7573 696e 6720 4e61 6e6e  ) not using Nann
+00038ab0: 6965 7320 7765 7265 206a 7573 7420 7368  ies were just sh
+00038ac0: 7574 2022 0a20 2020 2020 2020 2020 2020  ut ".           
+00038ad0: 2020 2020 2022 646f 776e 2069 6e73 7465       "down inste
+00038ae0: 6164 206f 6620 7265 7374 6172 7465 6420  ad of restarted 
+00038af0: 2872 6573 7461 7274 2069 7320 6f6e 6c79  (restart is only
+00038b00: 2070 6f73 7369 626c 6520 7769 7468 204e   possible with N
+00038b10: 616e 6e69 6573 292e 2049 6620 220a 2020  annies). If ".  
+00038b20: 2020 2020 2020 2020 2020 2020 2020 2279                "y
+00038b30: 6f75 7220 6465 706c 6f79 6d65 6e74 2073  our deployment s
+00038b40: 7973 7465 6d20 646f 6573 206e 6f74 2061  ystem does not a
+00038b50: 7574 6f6d 6174 6963 616c 6c79 2072 652d  utomatically re-
+00038b60: 6c61 756e 6368 2074 6572 6d69 6e61 7465  launch terminate
+00038b70: 6420 220a 2020 2020 2020 2020 2020 2020  d ".            
+00038b80: 2020 2020 2270 726f 6365 7373 6573 2c20      "processes, 
+00038b90: 7468 656e 2074 686f 7365 2077 6f72 6b65  then those worke
+00038ba0: 7273 2077 696c 6c20 6e65 7665 7220 636f  rs will never co
+00038bb0: 6d65 2062 6163 6b2c 2061 6e64 2060 436c  me back, and `Cl
+00038bc0: 6965 6e74 2e72 6573 7461 7274 6020 220a  ient.restart` ".
+00038bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038be0: 2277 696c 6c20 616c 7761 7973 2074 696d  "will always tim
+00038bf0: 6520 6f75 742e 2044 6f20 6e6f 7420 7573  e out. Do not us
+00038c00: 6520 6043 6c69 656e 742e 7265 7374 6172  e `Client.restar
+00038c10: 7460 2069 6e20 7468 6174 2063 6173 652e  t` in that case.
+00038c20: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
+00038c30: 0a20 2020 2020 2020 2069 6620 6f6e 5f65  .        if on_e
+00038c40: 7272 6f72 203d 3d20 2272 6169 7365 223a  rror == "raise":
+00038c50: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+00038c60: 7365 2054 696d 656f 7574 4572 726f 7228  se TimeoutError(
+00038c70: 6d73 6729 0a20 2020 2020 2020 206c 6f67  msg).        log
+00038c80: 6765 722e 6572 726f 7228 6622 7b6d 7367  ger.error(f"{msg
+00038c90: 7d20 287b 7374 696d 756c 7573 5f69 643d  } ({stimulus_id=
+00038ca0: 7d29 2229 0a0a 2020 2020 2020 2020 6e65  })")..        ne
+00038cb0: 775f 6e61 6e6e 6965 7320 3d20 7b77 732e  w_nannies = {ws.
+00038cc0: 6e61 6e6e 7920 666f 7220 7773 2069 6e20  nanny for ws in 
+00038cd0: 7365 6c66 2e77 6f72 6b65 7273 2e76 616c  self.workers.val
+00038ce0: 7565 7328 2920 6966 2077 732e 6e61 6e6e  ues() if ws.nann
+00038cf0: 797d 0a20 2020 2020 2020 2066 6f72 2077  y}.        for w
+00038d00: 6f72 6b65 725f 6164 6472 2c20 6e61 6e6e  orker_addr, nann
+00038d10: 795f 6164 6472 2069 6e20 6e61 6e6e 795f  y_addr in nanny_
+00038d20: 776f 726b 6572 732e 6974 656d 7328 293a  workers.items():
+00038d30: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00038d40: 6e61 6e6e 795f 6164 6472 206e 6f74 2069  nanny_addr not i
+00038d50: 6e20 6e65 775f 6e61 6e6e 6965 733a 0a20  n new_nannies:. 
+00038d60: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00038d70: 7574 5b77 6f72 6b65 725f 6164 6472 5d20  ut[worker_addr] 
+00038d80: 3d20 2274 696d 6564 206f 7574 220a 0a20  = "timed out".. 
+00038d90: 2020 2020 2020 2072 6574 7572 6e20 6f75         return ou
+00038da0: 740a 0a20 2020 2061 7379 6e63 2064 6566  t..    async def
+00038db0: 2062 726f 6164 6361 7374 280a 2020 2020   broadcast(.    
+00038dc0: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+00038dd0: 2020 2a2c 0a20 2020 2020 2020 206d 7367    *,.        msg
+00038de0: 3a20 6469 6374 2c0a 2020 2020 2020 2020  : dict,.        
+00038df0: 776f 726b 6572 733a 2043 6f6c 6c65 6374  workers: Collect
+00038e00: 696f 6e5b 7374 725d 207c 204e 6f6e 6520  ion[str] | None 
+00038e10: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00038e20: 686f 7374 733a 2043 6f6c 6c65 6374 696f  hosts: Collectio
+00038e30: 6e5b 7374 725d 207c 204e 6f6e 6520 3d20  n[str] | None = 
+00038e40: 4e6f 6e65 2c0a 2020 2020 2020 2020 6e61  None,.        na
+00038e50: 6e6e 793a 2062 6f6f 6c20 3d20 4661 6c73  nny: bool = Fals
+00038e60: 652c 0a20 2020 2020 2020 2073 6572 6961  e,.        seria
+00038e70: 6c69 7a65 7273 3a20 416e 7920 3d20 4e6f  lizers: Any = No
+00038e80: 6e65 2c0a 2020 2020 2020 2020 6f6e 5f65  ne,.        on_e
+00038e90: 7272 6f72 3a20 4c69 7465 7261 6c5b 2272  rror: Literal["r
+00038ea0: 6169 7365 222c 2022 7265 7475 726e 222c  aise", "return",
+00038eb0: 2022 7265 7475 726e 5f70 6963 6b6c 6522   "return_pickle"
+00038ec0: 2c20 2269 676e 6f72 6522 5d20 3d20 2272  , "ignore"] = "r
+00038ed0: 6169 7365 222c 0a20 2020 2029 202d 3e20  aise",.    ) -> 
+00038ee0: 6469 6374 5b73 7472 2c20 416e 795d 3a0a  dict[str, Any]:.
+00038ef0: 2020 2020 2020 2020 2222 2242 726f 6164          """Broad
+00038f00: 6361 7374 206d 6573 7361 6765 2074 6f20  cast message to 
+00038f10: 776f 726b 6572 732c 2072 6574 7572 6e20  workers, return 
+00038f20: 616c 6c20 7265 7375 6c74 7322 2222 0a20  all results""". 
+00038f30: 2020 2020 2020 2069 6620 776f 726b 6572         if worker
+00038f40: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
+00038f50: 2020 2020 2020 2069 6620 686f 7374 7320         if hosts 
+00038f60: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+00038f70: 2020 2020 2020 2020 2077 6f72 6b65 7273           workers
+00038f80: 203d 206c 6973 7428 7365 6c66 2e77 6f72   = list(self.wor
+00038f90: 6b65 7273 290a 2020 2020 2020 2020 2020  kers).          
+00038fa0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00038fb0: 2020 2020 2020 2020 776f 726b 6572 7320          workers 
+00038fc0: 3d20 5b5d 0a20 2020 2020 2020 2065 6c73  = [].        els
+00038fd0: 653a 0a20 2020 2020 2020 2020 2020 2077  e:.            w
+00038fe0: 6f72 6b65 7273 203d 206c 6973 7428 776f  orkers = list(wo
+00038ff0: 726b 6572 7329 0a20 2020 2020 2020 2069  rkers).        i
+00039000: 6620 686f 7374 7320 6973 206e 6f74 204e  f hosts is not N
+00039010: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00039020: 2066 6f72 2068 6f73 7420 696e 2068 6f73   for host in hos
+00039030: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
+00039040: 2020 2020 6468 203d 2073 656c 662e 686f      dh = self.ho
+00039050: 7374 5f69 6e66 6f2e 6765 7428 686f 7374  st_info.get(host
+00039060: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00039070: 2020 6966 2064 6820 6973 206e 6f74 204e    if dh is not N
+00039080: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00039090: 2020 2020 2020 2020 2077 6f72 6b65 7273           workers
+000390a0: 2e65 7874 656e 6428 6468 5b22 6164 6472  .extend(dh["addr
+000390b0: 6573 7365 7322 5d29 0a0a 2020 2020 2020  esses"])..      
+000390c0: 2020 6966 206e 616e 6e79 3a0a 2020 2020    if nanny:.    
+000390d0: 2020 2020 2020 2020 6164 6472 6573 7365          addresse
+000390e0: 7320 3d20 5b6e 2066 6f72 2077 2069 6e20  s = [n for w in 
+000390f0: 776f 726b 6572 7320 6966 2028 6e20 3a3d  workers if (n :=
+00039100: 2073 656c 662e 776f 726b 6572 735b 775d   self.workers[w]
+00039110: 2e6e 616e 6e79 2920 6973 206e 6f74 204e  .nanny) is not N
+00039120: 6f6e 655d 0a20 2020 2020 2020 2065 6c73  one].        els
+00039130: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
+00039140: 6464 7265 7373 6573 203d 2077 6f72 6b65  ddresses = worke
+00039150: 7273 0a0a 2020 2020 2020 2020 4552 524f  rs..        ERRO
+00039160: 5220 3d20 6f62 6a65 6374 2829 0a0a 2020  R = object()..  
+00039170: 2020 2020 2020 6173 796e 6320 6465 6620        async def 
+00039180: 7365 6e64 5f6d 6573 7361 6765 2861 6464  send_message(add
+00039190: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+000391a0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+000391b0: 2020 2020 2063 6f6d 6d20 3d20 6177 6169       comm = awai
+000391c0: 7420 7365 6c66 2e72 7063 2e63 6f6e 6e65  t self.rpc.conne
+000391d0: 6374 2861 6464 7229 0a20 2020 2020 2020  ct(addr).       
+000391e0: 2020 2020 2020 2020 2063 6f6d 6d2e 6e61           comm.na
+000391f0: 6d65 203d 2022 5363 6865 6475 6c65 7220  me = "Scheduler 
+00039200: 4272 6f61 6463 6173 7422 0a20 2020 2020  Broadcast".     
+00039210: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+00039220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039230: 2020 2020 7265 7370 203d 2061 7761 6974      resp = await
+00039240: 2073 656e 645f 7265 6376 280a 2020 2020   send_recv(.    
+00039250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039260: 2020 2020 636f 6d6d 2c20 636c 6f73 653d      comm, close=
+00039270: 5472 7565 2c20 7365 7269 616c 697a 6572  True, serializer
+00039280: 733d 7365 7269 616c 697a 6572 732c 202a  s=serializers, *
+00039290: 2a6d 7367 0a20 2020 2020 2020 2020 2020  *msg.           
+000392a0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+000392b0: 2020 2020 2020 2020 2020 2066 696e 616c             final
+000392c0: 6c79 3a0a 2020 2020 2020 2020 2020 2020  ly:.            
+000392d0: 2020 2020 2020 2020 7365 6c66 2e72 7063          self.rpc
+000392e0: 2e72 6575 7365 2861 6464 722c 2063 6f6d  .reuse(addr, com
+000392f0: 6d29 0a20 2020 2020 2020 2020 2020 2020  m).             
+00039300: 2020 2072 6574 7572 6e20 7265 7370 0a20     return resp. 
+00039310: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+00039320: 7420 4578 6365 7074 696f 6e20 6173 2065  t Exception as e
+00039330: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00039340: 2020 6c6f 6767 6572 2e65 7272 6f72 2866    logger.error(f
+00039350: 2262 726f 6164 6361 7374 2074 6f20 7b61  "broadcast to {a
+00039360: 6464 727d 2066 6169 6c65 643a 207b 652e  ddr} failed: {e.
+00039370: 5f5f 636c 6173 735f 5f2e 5f5f 6e61 6d65  __class__.__name
+00039380: 5f5f 7d3a 207b 657d 2229 0a20 2020 2020  __}: {e}").     
+00039390: 2020 2020 2020 2020 2020 2069 6620 6f6e             if on
+000393a0: 5f65 7272 6f72 203d 3d20 2272 6169 7365  _error == "raise
+000393b0: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
+000393c0: 2020 2020 2020 2072 6169 7365 0a20 2020         raise.   
+000393d0: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
+000393e0: 6620 6f6e 5f65 7272 6f72 203d 3d20 2272  f on_error == "r
+000393f0: 6574 7572 6e22 3a0a 2020 2020 2020 2020  eturn":.        
+00039400: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00039410: 726e 2065 0a20 2020 2020 2020 2020 2020  rn e.           
+00039420: 2020 2020 2065 6c69 6620 6f6e 5f65 7272       elif on_err
+00039430: 6f72 203d 3d20 2272 6574 7572 6e5f 7069  or == "return_pi
+00039440: 636b 6c65 223a 0a20 2020 2020 2020 2020  ckle":.         
+00039450: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00039460: 6e20 6475 6d70 7328 6529 0a20 2020 2020  n dumps(e).     
+00039470: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+00039480: 6f6e 5f65 7272 6f72 203d 3d20 2269 676e  on_error == "ign
+00039490: 6f72 6522 3a0a 2020 2020 2020 2020 2020  ore":.          
+000394a0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000394b0: 2045 5252 4f52 0a20 2020 2020 2020 2020   ERROR.         
+000394c0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+000394d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000394e0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+000394f0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+00039500: 2020 2020 2020 2020 2020 2022 6f6e 5f65             "on_e
+00039510: 7272 6f72 206d 7573 7420 6265 2027 7261  rror must be 'ra
+00039520: 6973 6527 2c20 2772 6574 7572 6e27 2c20  ise', 'return', 
+00039530: 2772 6574 7572 6e5f 7069 636b 6c65 272c  'return_pickle',
+00039540: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+00039550: 2020 2020 2020 2020 2020 2066 226f 7220             f"or 
+00039560: 2769 676e 6f72 6527 3b20 676f 7420 7b6f  'ignore'; got {o
+00039570: 6e5f 6572 726f 7221 727d 220a 2020 2020  n_error!r}".    
+00039580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039590: 290a 0a20 2020 2020 2020 2072 6573 756c  )..        resul
+000395a0: 7473 203d 2061 7761 6974 2041 6c6c 285b  ts = await All([
+000395b0: 7365 6e64 5f6d 6573 7361 6765 2861 6464  send_message(add
+000395c0: 7265 7373 2920 666f 7220 6164 6472 6573  ress) for addres
+000395d0: 7320 696e 2061 6464 7265 7373 6573 5d29  s in addresses])
+000395e0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000395f0: 7b6b 3a20 7620 666f 7220 6b2c 2076 2069  {k: v for k, v i
+00039600: 6e20 7a69 7028 776f 726b 6572 732c 2072  n zip(workers, r
+00039610: 6573 756c 7473 2920 6966 2076 2069 7320  esults) if v is 
+00039620: 6e6f 7420 4552 524f 527d 0a0a 2020 2020  not ERROR}..    
+00039630: 6173 796e 6320 6465 6620 7072 6f78 7928  async def proxy(
+00039640: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+00039650: 2020 2020 2020 206d 7367 3a20 6469 6374         msg: dict
+00039660: 2c0a 2020 2020 2020 2020 776f 726b 6572  ,.        worker
+00039670: 3a20 7374 722c 0a20 2020 2020 2020 2073  : str,.        s
+00039680: 6572 6961 6c69 7a65 7273 3a20 416e 7920  erializers: Any 
+00039690: 3d20 4e6f 6e65 2c0a 2020 2020 2920 2d3e  = None,.    ) ->
+000396a0: 2041 6e79 3a0a 2020 2020 2020 2020 2222   Any:.        ""
+000396b0: 2250 726f 7879 2061 2063 6f6d 6d75 6e69  "Proxy a communi
+000396c0: 6361 7469 6f6e 2074 6872 6f75 6768 2074  cation through t
+000396d0: 6865 2073 6368 6564 756c 6572 2074 6f20  he scheduler to 
+000396e0: 736f 6d65 206f 7468 6572 2077 6f72 6b65  some other worke
+000396f0: 7222 2222 0a20 2020 2020 2020 2064 203d  r""".        d =
+00039700: 2061 7761 6974 2073 656c 662e 6272 6f61   await self.broa
+00039710: 6463 6173 7428 6d73 673d 6d73 672c 2077  dcast(msg=msg, w
+00039720: 6f72 6b65 7273 3d5b 776f 726b 6572 5d2c  orkers=[worker],
+00039730: 2073 6572 6961 6c69 7a65 7273 3d73 6572   serializers=ser
+00039740: 6961 6c69 7a65 7273 290a 2020 2020 2020  ializers).      
+00039750: 2020 7265 7475 726e 2064 5b77 6f72 6b65    return d[worke
+00039760: 725d 0a0a 2020 2020 6173 796e 6320 6465  r]..    async de
+00039770: 6620 6761 7468 6572 5f6f 6e5f 776f 726b  f gather_on_work
+00039780: 6572 280a 2020 2020 2020 2020 7365 6c66  er(.        self
+00039790: 2c20 776f 726b 6572 5f61 6464 7265 7373  , worker_address
+000397a0: 3a20 7374 722c 2077 686f 5f68 6173 3a20  : str, who_has: 
+000397b0: 6469 6374 5b4b 6579 2c20 6c69 7374 5b73  dict[Key, list[s
+000397c0: 7472 5d5d 0a20 2020 2029 202d 3e20 7365  tr]].    ) -> se
+000397d0: 743a 0a20 2020 2020 2020 2022 2222 5065  t:.        """Pe
+000397e0: 6572 2d74 6f2d 7065 6572 2063 6f70 7920  er-to-peer copy 
+000397f0: 6f66 206b 6579 7320 6672 6f6d 206d 756c  of keys from mul
+00039800: 7469 706c 6520 776f 726b 6572 7320 746f  tiple workers to
+00039810: 2061 2073 696e 676c 6520 776f 726b 6572   a single worker
+00039820: 0a0a 2020 2020 2020 2020 5061 7261 6d65  ..        Parame
+00039830: 7465 7273 0a20 2020 2020 2020 202d 2d2d  ters.        ---
+00039840: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
+00039850: 776f 726b 6572 5f61 6464 7265 7373 3a20  worker_address: 
+00039860: 7374 720a 2020 2020 2020 2020 2020 2020  str.            
+00039870: 5265 6369 7069 656e 7420 776f 726b 6572  Recipient worker
+00039880: 2061 6464 7265 7373 2074 6f20 636f 7079   address to copy
+00039890: 206b 6579 7320 746f 0a20 2020 2020 2020   keys to.       
+000398a0: 2077 686f 5f68 6173 3a20 6469 6374 5b4b   who_has: dict[K
+000398b0: 6579 2c20 6c69 7374 5b73 7472 5d5d 0a20  ey, list[str]]. 
+000398c0: 2020 2020 2020 2020 2020 207b 6b65 793a             {key:
+000398d0: 205b 7365 6e64 6572 2061 6464 7265 7373   [sender address
+000398e0: 2c20 7365 6e64 6572 2061 6464 7265 7373  , sender address
+000398f0: 2c20 2e2e 2e5d 2c20 6b65 793a 202e 2e2e  , ...], key: ...
+00039900: 7d0a 0a20 2020 2020 2020 2052 6574 7572  }..        Retur
+00039910: 6e73 0a20 2020 2020 2020 202d 2d2d 2d2d  ns.        -----
+00039920: 2d2d 0a20 2020 2020 2020 2072 6574 7572  --.        retur
+00039930: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
+00039940: 7365 7420 6f66 206b 6579 7320 7468 6174  set of keys that
+00039950: 2066 6169 6c65 6420 746f 2062 6520 636f   failed to be co
+00039960: 7069 6564 0a20 2020 2020 2020 2022 2222  pied.        """
+00039970: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
+00039980: 2020 2020 2020 2020 2020 7265 7375 6c74            result
+00039990: 203d 2061 7761 6974 2072 6574 7279 5f6f   = await retry_o
+000399a0: 7065 7261 7469 6f6e 280a 2020 2020 2020  peration(.      
+000399b0: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
+000399c0: 7063 2861 6464 723d 776f 726b 6572 5f61  pc(addr=worker_a
+000399d0: 6464 7265 7373 292e 6761 7468 6572 2c20  ddress).gather, 
+000399e0: 7768 6f5f 6861 733d 7768 6f5f 6861 730a  who_has=who_has.
+000399f0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00039a00: 2020 2020 2020 6578 6365 7074 204f 5345        except OSE
+00039a10: 7272 6f72 2061 7320 653a 0a20 2020 2020  rror as e:.     
+00039a20: 2020 2020 2020 2023 2054 6869 7320 6361         # This ca
+00039a30: 6e20 6861 7070 656e 2065 2e67 2e20 6966  n happen e.g. if
+00039a40: 2074 6865 2077 6f72 6b65 7220 6973 2067   the worker is g
+00039a50: 6f69 6e67 2074 6872 6f75 6768 2063 6f6e  oing through con
+00039a60: 7472 6f6c 6c65 6420 7368 7574 646f 776e  trolled shutdown
+00039a70: 3b0a 2020 2020 2020 2020 2020 2020 2320  ;.            # 
+00039a80: 6974 2064 6f65 736e 2774 206e 6563 6573  it doesn't neces
+00039a90: 7361 7269 6c79 206d 6561 6e20 7468 6174  sarily mean that
+00039aa0: 2069 7420 7765 6e74 2075 6e65 7870 6563   it went unexpec
+00039ab0: 7465 646c 7920 6d69 7373 696e 670a 2020  tedly missing.  
+00039ac0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+00039ad0: 2e77 6172 6e69 6e67 280a 2020 2020 2020  .warning(.      
+00039ae0: 2020 2020 2020 2020 2020 6622 436f 6d6d            f"Comm
+00039af0: 756e 6963 6174 696f 6e20 7769 7468 2077  unication with w
+00039b00: 6f72 6b65 7220 7b77 6f72 6b65 725f 6164  orker {worker_ad
+00039b10: 6472 6573 737d 2066 6169 6c65 6420 6475  dress} failed du
+00039b20: 7269 6e67 2022 0a20 2020 2020 2020 2020  ring ".         
+00039b30: 2020 2020 2020 2066 2272 6570 6c69 6361         f"replica
+00039b40: 7469 6f6e 3a20 7b65 2e5f 5f63 6c61 7373  tion: {e.__class
+00039b50: 5f5f 2e5f 5f6e 616d 655f 5f7d 3a20 7b65  __.__name__}: {e
+00039b60: 7d22 0a20 2020 2020 2020 2020 2020 2029  }".            )
+00039b70: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00039b80: 7572 6e20 7365 7428 7768 6f5f 6861 7329  urn set(who_has)
+00039b90: 0a0a 2020 2020 2020 2020 7773 203d 2073  ..        ws = s
+00039ba0: 656c 662e 776f 726b 6572 732e 6765 7428  elf.workers.get(
+00039bb0: 776f 726b 6572 5f61 6464 7265 7373 290a  worker_address).
+00039bc0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+00039bd0: 7773 3a0a 2020 2020 2020 2020 2020 2020  ws:.            
+00039be0: 6c6f 6767 6572 2e77 6172 6e69 6e67 2866  logger.warning(f
+00039bf0: 2257 6f72 6b65 7220 7b77 6f72 6b65 725f  "Worker {worker_
+00039c00: 6164 6472 6573 737d 206c 6f73 7420 6475  address} lost du
+00039c10: 7269 6e67 2072 6570 6c69 6361 7469 6f6e  ring replication
+00039c20: 2229 0a20 2020 2020 2020 2020 2020 2072  ").            r
+00039c30: 6574 7572 6e20 7365 7428 7768 6f5f 6861  eturn set(who_ha
+00039c40: 7329 0a20 2020 2020 2020 2065 6c69 6620  s).        elif 
+00039c50: 7265 7375 6c74 5b22 7374 6174 7573 225d  result["status"]
+00039c60: 203d 3d20 224f 4b22 3a0a 2020 2020 2020   == "OK":.      
+00039c70: 2020 2020 2020 6b65 7973 5f66 6169 6c65        keys_faile
+00039c80: 6420 3d20 7365 7428 290a 2020 2020 2020  d = set().      
+00039c90: 2020 2020 2020 6b65 7973 5f6f 6b3a 2053        keys_ok: S
+00039ca0: 6574 203d 2077 686f 5f68 6173 2e6b 6579  et = who_has.key
+00039cb0: 7328 290a 2020 2020 2020 2020 656c 6966  s().        elif
+00039cc0: 2072 6573 756c 745b 2273 7461 7475 7322   result["status"
+00039cd0: 5d20 3d3d 2022 7061 7274 6961 6c2d 6661  ] == "partial-fa
+00039ce0: 696c 223a 0a20 2020 2020 2020 2020 2020  il":.           
+00039cf0: 206b 6579 735f 6661 696c 6564 203d 2073   keys_failed = s
+00039d00: 6574 2872 6573 756c 745b 226b 6579 7322  et(result["keys"
+00039d10: 5d29 0a20 2020 2020 2020 2020 2020 206b  ]).            k
+00039d20: 6579 735f 6f6b 203d 2077 686f 5f68 6173  eys_ok = who_has
+00039d30: 2e6b 6579 7328 2920 2d20 6b65 7973 5f66  .keys() - keys_f
+00039d40: 6169 6c65 640a 2020 2020 2020 2020 2020  ailed.          
+00039d50: 2020 6c6f 6767 6572 2e77 6172 6e69 6e67    logger.warning
+00039d60: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00039d70: 2020 6622 576f 726b 6572 207b 776f 726b    f"Worker {work
+00039d80: 6572 5f61 6464 7265 7373 7d20 6661 696c  er_address} fail
+00039d90: 6564 2074 6f20 6163 7175 6972 6520 6b65  ed to acquire ke
+00039da0: 7973 3a20 7b72 6573 756c 745b 276b 6579  ys: {result['key
+00039db0: 7327 5d7d 220a 2020 2020 2020 2020 2020  s']}".          
+00039dc0: 2020 290a 2020 2020 2020 2020 656c 7365    ).        else
+00039dd0: 3a20 2023 2070 7261 676d 613a 206e 6f63  :  # pragma: noc
+00039de0: 6f76 6572 0a20 2020 2020 2020 2020 2020  over.           
+00039df0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+00039e00: 7228 6622 556e 6578 7065 6374 6564 206d  r(f"Unexpected m
+00039e10: 6573 7361 6765 2066 726f 6d20 7b77 6f72  essage from {wor
+00039e20: 6b65 725f 6164 6472 6573 737d 3a20 7b72  ker_address}: {r
+00039e30: 6573 756c 747d 2229 0a0a 2020 2020 2020  esult}")..      
+00039e40: 2020 666f 7220 6b65 7920 696e 206b 6579    for key in key
+00039e50: 735f 6f6b 3a0a 2020 2020 2020 2020 2020  s_ok:.          
+00039e60: 2020 7473 203d 2073 656c 662e 7461 736b    ts = self.task
+00039e70: 732e 6765 7428 6b65 7929 0a20 2020 2020  s.get(key).     
+00039e80: 2020 2020 2020 2069 6620 7473 2069 7320         if ts is 
+00039e90: 4e6f 6e65 206f 7220 7473 2e73 7461 7465  None or ts.state
+00039ea0: 2021 3d20 226d 656d 6f72 7922 3a0a 2020   != "memory":.  
+00039eb0: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+00039ec0: 6767 6572 2e77 6172 6e69 6e67 2866 224b  gger.warning(f"K
+00039ed0: 6579 206c 6f73 7420 6475 7269 6e67 2072  ey lost during r
+00039ee0: 6570 6c69 6361 7469 6f6e 3a20 7b6b 6579  eplication: {key
+00039ef0: 7d22 290a 2020 2020 2020 2020 2020 2020  }").            
+00039f00: 2020 2020 636f 6e74 696e 7565 0a20 2020      continue.   
+00039f10: 2020 2020 2020 2020 2073 656c 662e 6164           self.ad
+00039f20: 645f 7265 706c 6963 6128 7473 2c20 7773  d_replica(ts, ws
+00039f30: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+00039f40: 6e20 6b65 7973 5f66 6169 6c65 640a 0a20  n keys_failed.. 
+00039f50: 2020 2061 7379 6e63 2064 6566 2064 656c     async def del
+00039f60: 6574 655f 776f 726b 6572 5f64 6174 6128  ete_worker_data(
+00039f70: 0a20 2020 2020 2020 2073 656c 662c 2077  .        self, w
+00039f80: 6f72 6b65 725f 6164 6472 6573 733a 2073  orker_address: s
+00039f90: 7472 2c20 6b65 7973 3a20 436f 6c6c 6563  tr, keys: Collec
+00039fa0: 7469 6f6e 5b4b 6579 5d2c 2073 7469 6d75  tion[Key], stimu
+00039fb0: 6c75 735f 6964 3a20 7374 720a 2020 2020  lus_id: str.    
+00039fc0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00039fd0: 2020 2022 2222 4465 6c65 7465 2064 6174     """Delete dat
+00039fe0: 6120 6672 6f6d 2061 2077 6f72 6b65 7220  a from a worker 
+00039ff0: 616e 6420 7570 6461 7465 2074 6865 2063  and update the c
+0003a000: 6f72 7265 7370 6f6e 6469 6e67 2077 6f72  orresponding wor
+0003a010: 6b65 722f 7461 736b 2073 7461 7465 730a  ker/task states.
+0003a020: 0a20 2020 2020 2020 2050 6172 616d 6574  .        Paramet
+0003a030: 6572 730a 2020 2020 2020 2020 2d2d 2d2d  ers.        ----
+0003a040: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2077  ------.        w
+0003a050: 6f72 6b65 725f 6164 6472 6573 733a 2073  orker_address: s
+0003a060: 7472 0a20 2020 2020 2020 2020 2020 2057  tr.            W
+0003a070: 6f72 6b65 7220 6164 6472 6573 7320 746f  orker address to
+0003a080: 2064 656c 6574 6520 6b65 7973 2066 726f   delete keys fro
+0003a090: 6d0a 2020 2020 2020 2020 6b65 7973 3a20  m.        keys: 
+0003a0a0: 6c69 7374 5b4b 6579 5d0a 2020 2020 2020  list[Key].      
+0003a0b0: 2020 2020 2020 4c69 7374 206f 6620 6b65        List of ke
+0003a0c0: 7973 2074 6f20 6465 6c65 7465 206f 6e20  ys to delete on 
+0003a0d0: 7468 6520 7370 6563 6966 6965 6420 776f  the specified wo
+0003a0e0: 726b 6572 0a20 2020 2020 2020 2022 2222  rker.        """
+0003a0f0: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
+0003a100: 2020 2020 2020 2020 2020 6177 6169 7420            await 
+0003a110: 7265 7472 795f 6f70 6572 6174 696f 6e28  retry_operation(
+0003a120: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003a130: 2073 656c 662e 7270 6328 6164 6472 3d77   self.rpc(addr=w
+0003a140: 6f72 6b65 725f 6164 6472 6573 7329 2e66  orker_address).f
+0003a150: 7265 655f 6b65 7973 2c0a 2020 2020 2020  ree_keys,.      
+0003a160: 2020 2020 2020 2020 2020 6b65 7973 3d6c            keys=l
+0003a170: 6973 7428 6b65 7973 292c 0a20 2020 2020  ist(keys),.     
+0003a180: 2020 2020 2020 2020 2020 2073 7469 6d75             stimu
+0003a190: 6c75 735f 6964 3d66 2264 656c 6574 652d  lus_id=f"delete-
+0003a1a0: 6461 7461 2d7b 7469 6d65 2829 7d22 2c0a  data-{time()}",.
+0003a1b0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0003a1c0: 2020 2020 2020 6578 6365 7074 204f 5345        except OSE
+0003a1d0: 7272 6f72 2061 7320 653a 0a20 2020 2020  rror as e:.     
+0003a1e0: 2020 2020 2020 2023 2054 6869 7320 6361         # This ca
+0003a1f0: 6e20 6861 7070 656e 2065 2e67 2e20 6966  n happen e.g. if
+0003a200: 2074 6865 2077 6f72 6b65 7220 6973 2067   the worker is g
+0003a210: 6f69 6e67 2074 6872 6f75 6768 2063 6f6e  oing through con
+0003a220: 7472 6f6c 6c65 6420 7368 7574 646f 776e  trolled shutdown
+0003a230: 3b0a 2020 2020 2020 2020 2020 2020 2320  ;.            # 
+0003a240: 6974 2064 6f65 736e 2774 206e 6563 6573  it doesn't neces
+0003a250: 7361 7269 6c79 206d 6561 6e20 7468 6174  sarily mean that
+0003a260: 2069 7420 7765 6e74 2075 6e65 7870 6563   it went unexpec
+0003a270: 7465 646c 7920 6d69 7373 696e 670a 2020  tedly missing.  
+0003a280: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+0003a290: 2e77 6172 6e69 6e67 280a 2020 2020 2020  .warning(.      
+0003a2a0: 2020 2020 2020 2020 2020 6622 436f 6d6d            f"Comm
+0003a2b0: 756e 6963 6174 696f 6e20 7769 7468 2077  unication with w
+0003a2c0: 6f72 6b65 7220 7b77 6f72 6b65 725f 6164  orker {worker_ad
+0003a2d0: 6472 6573 737d 2066 6169 6c65 6420 6475  dress} failed du
+0003a2e0: 7269 6e67 2022 0a20 2020 2020 2020 2020  ring ".         
+0003a2f0: 2020 2020 2020 2066 2272 6570 6c69 6361         f"replica
+0003a300: 7469 6f6e 3a20 7b65 2e5f 5f63 6c61 7373  tion: {e.__class
+0003a310: 5f5f 2e5f 5f6e 616d 655f 5f7d 3a20 7b65  __.__name__}: {e
+0003a320: 7d22 0a20 2020 2020 2020 2020 2020 2029  }".            )
+0003a330: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0003a340: 7572 6e0a 0a20 2020 2020 2020 2077 7320  urn..        ws 
+0003a350: 3d20 7365 6c66 2e77 6f72 6b65 7273 2e67  = self.workers.g
+0003a360: 6574 2877 6f72 6b65 725f 6164 6472 6573  et(worker_addres
+0003a370: 7329 0a20 2020 2020 2020 2069 6620 6e6f  s).        if no
+0003a380: 7420 7773 3a0a 2020 2020 2020 2020 2020  t ws:.          
+0003a390: 2020 7265 7475 726e 0a0a 2020 2020 2020    return..      
+0003a3a0: 2020 666f 7220 6b65 7920 696e 206b 6579    for key in key
+0003a3b0: 733a 0a20 2020 2020 2020 2020 2020 2074  s:.            t
+0003a3c0: 7320 3d20 7365 6c66 2e74 6173 6b73 2e67  s = self.tasks.g
+0003a3d0: 6574 286b 6579 290a 2020 2020 2020 2020  et(key).        
+0003a3e0: 2020 2020 6966 2074 7320 6973 206e 6f74      if ts is not
+0003a3f0: 204e 6f6e 6520 616e 6420 7773 2069 6e20   None and ws in 
+0003a400: 2874 732e 7768 6f5f 6861 7320 6f72 2028  (ts.who_has or (
+0003a410: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
+0003a420: 2020 2020 6173 7365 7274 2074 732e 7374      assert ts.st
+0003a430: 6174 6520 3d3d 2022 6d65 6d6f 7279 220a  ate == "memory".
+0003a440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a450: 7365 6c66 2e72 656d 6f76 655f 7265 706c  self.remove_repl
+0003a460: 6963 6128 7473 2c20 7773 290a 2020 2020  ica(ts, ws).    
+0003a470: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+0003a480: 6f74 2074 732e 7768 6f5f 6861 733a 0a20  ot ts.who_has:. 
+0003a490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a4a0: 2020 2023 204c 6173 7420 636f 7079 2064     # Last copy d
+0003a4b0: 656c 6574 6564 0a20 2020 2020 2020 2020  eleted.         
+0003a4c0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0003a4d0: 7472 616e 7369 7469 6f6e 7328 7b6b 6579  transitions({key
+0003a4e0: 3a20 2272 656c 6561 7365 6422 7d2c 2073  : "released"}, s
+0003a4f0: 7469 6d75 6c75 735f 6964 290a 0a20 2020  timulus_id)..   
+0003a500: 2020 2020 2073 656c 662e 6c6f 675f 6576       self.log_ev
+0003a510: 656e 7428 7773 2e61 6464 7265 7373 2c20  ent(ws.address, 
+0003a520: 7b22 6163 7469 6f6e 223a 2022 7265 6d6f  {"action": "remo
+0003a530: 7665 2d77 6f72 6b65 722d 6461 7461 222c  ve-worker-data",
+0003a540: 2022 6b65 7973 223a 206b 6579 737d 290a   "keys": keys}).
+0003a550: 0a20 2020 2040 6c6f 675f 6572 726f 7273  .    @log_errors
+0003a560: 0a20 2020 2061 7379 6e63 2064 6566 2072  .    async def r
+0003a570: 6562 616c 616e 6365 280a 2020 2020 2020  ebalance(.      
+0003a580: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+0003a590: 6b65 7973 3a20 4974 6572 6162 6c65 5b4b  keys: Iterable[K
+0003a5a0: 6579 5d20 7c20 4e6f 6e65 203d 204e 6f6e  ey] | None = Non
+0003a5b0: 652c 0a20 2020 2020 2020 2077 6f72 6b65  e,.        worke
+0003a5c0: 7273 3a20 4974 6572 6162 6c65 5b73 7472  rs: Iterable[str
+0003a5d0: 5d20 7c20 4e6f 6e65 203d 204e 6f6e 652c  ] | None = None,
+0003a5e0: 0a20 2020 2020 2020 2073 7469 6d75 6c75  .        stimulu
+0003a5f0: 735f 6964 3a20 7374 7220 7c20 4e6f 6e65  s_id: str | None
+0003a600: 203d 204e 6f6e 652c 0a20 2020 2029 202d   = None,.    ) -
+0003a610: 3e20 6469 6374 3a0a 2020 2020 2020 2020  > dict:.        
+0003a620: 2222 2252 6562 616c 616e 6365 206b 6579  """Rebalance key
+0003a630: 7320 736f 2074 6861 7420 6561 6368 2077  s so that each w
+0003a640: 6f72 6b65 7220 656e 6473 2075 7020 7769  orker ends up wi
+0003a650: 7468 2072 6f75 6768 6c79 2074 6865 2073  th roughly the s
+0003a660: 616d 6520 7072 6f63 6573 730a 2020 2020  ame process.    
+0003a670: 2020 2020 6d65 6d6f 7279 2028 6d61 6e61      memory (mana
+0003a680: 6765 642b 756e 6d61 6e61 6765 6429 2e0a  ged+unmanaged)..
+0003a690: 0a20 2020 2020 2020 202e 2e20 7761 726e  .        .. warn
+0003a6a0: 696e 673a 3a0a 2020 2020 2020 2020 2020  ing::.          
+0003a6b0: 2054 6869 7320 6f70 6572 6174 696f 6e20   This operation 
+0003a6c0: 6973 2067 656e 6572 616c 6c79 206e 6f74  is generally not
+0003a6d0: 2077 656c 6c20 7465 7374 6564 2061 6761   well tested aga
+0003a6e0: 696e 7374 206e 6f72 6d61 6c20 6f70 6572  inst normal oper
+0003a6f0: 6174 696f 6e20 6f66 2074 6865 0a20 2020  ation of the.   
+0003a700: 2020 2020 2020 2020 7363 6865 6475 6c65          schedule
+0003a710: 722e 2049 7420 6973 206e 6f74 2072 6563  r. It is not rec
+0003a720: 6f6d 6d65 6e64 6564 2074 6f20 7573 6520  ommended to use 
+0003a730: 6974 2077 6869 6c65 2077 6169 7469 6e67  it while waiting
+0003a740: 206f 6e20 636f 6d70 7574 6174 696f 6e73   on computations
+0003a750: 2e0a 0a20 2020 2020 2020 202a 2a41 6c67  ...        **Alg
+0003a760: 6f72 6974 686d 2a2a 0a0a 2020 2020 2020  orithm**..      
+0003a770: 2020 232e 2046 696e 6420 7468 6520 6d65    #. Find the me
+0003a780: 616e 206f 6363 7570 616e 6379 206f 6620  an occupancy of 
+0003a790: 7468 6520 636c 7573 7465 722c 2064 6566  the cluster, def
+0003a7a0: 696e 6564 2061 7320 6461 7461 206d 616e  ined as data man
+0003a7b0: 6167 6564 2062 7920 6461 736b 202b 0a20  aged by dask +. 
+0003a7c0: 2020 2020 2020 2020 2020 756e 6d61 6e61            unmana
+0003a7d0: 6765 6420 7072 6f63 6573 7320 6d65 6d6f  ged process memo
+0003a7e0: 7279 2074 6861 7420 6861 7320 6265 656e  ry that has been
+0003a7f0: 2074 6865 7265 2066 6f72 2061 7420 6c65   there for at le
+0003a800: 6173 7420 3330 2073 6563 6f6e 6473 0a20  ast 30 seconds. 
+0003a810: 2020 2020 2020 2020 2020 2860 6064 6973            (``dis
+0003a820: 7472 6962 7574 6564 2e77 6f72 6b65 722e  tributed.worker.
+0003a830: 6d65 6d6f 7279 2e72 6563 656e 742d 746f  memory.recent-to
+0003a840: 2d6f 6c64 2d74 696d 6560 6029 2e0a 2020  -old-time``)..  
+0003a850: 2020 2020 2020 2020 2054 6869 7320 6c65           This le
+0003a860: 7473 2075 7320 6967 6e6f 7265 2074 656d  ts us ignore tem
+0003a870: 706f 7261 7279 2073 7069 6b65 7320 6361  porary spikes ca
+0003a880: 7573 6564 2062 7920 7461 736b 2068 6561  used by task hea
+0003a890: 7020 7573 6167 652e 0a0a 2020 2020 2020  p usage...      
+0003a8a0: 2020 2020 2041 6c74 6572 6e61 7469 7665       Alternative
+0003a8b0: 6c79 2c20 796f 7520 6d61 7920 6368 616e  ly, you may chan
+0003a8c0: 6765 2068 6f77 206d 656d 6f72 7920 6973  ge how memory is
+0003a8d0: 206d 6561 7375 7265 6420 626f 7468 2066   measured both f
+0003a8e0: 6f72 2074 6865 2069 6e64 6976 6964 7561  or the individua
+0003a8f0: 6c0a 2020 2020 2020 2020 2020 2077 6f72  l.           wor
+0003a900: 6b65 7273 2061 7320 7765 6c6c 2061 7320  kers as well as 
+0003a910: 746f 2063 616c 6375 6c61 7465 2074 6865  to calculate the
+0003a920: 206d 6561 6e20 7468 726f 7567 680a 2020   mean through.  
+0003a930: 2020 2020 2020 2020 2060 6064 6973 7472           ``distr
+0003a940: 6962 7574 6564 2e77 6f72 6b65 722e 6d65  ibuted.worker.me
+0003a950: 6d6f 7279 2e72 6562 616c 616e 6365 2e6d  mory.rebalance.m
+0003a960: 6561 7375 7265 6060 2e20 4e61 6d65 6c79  easure``. Namely
+0003a970: 2c20 7468 6973 2063 616e 2062 6520 7573  , this can be us
+0003a980: 6566 756c 0a20 2020 2020 2020 2020 2020  eful.           
+0003a990: 746f 2064 6973 7265 6761 7264 2069 6e61  to disregard ina
+0003a9a0: 6363 7572 6174 6520 4f53 206d 656d 6f72  ccurate OS memor
+0003a9b0: 7920 6d65 6173 7572 656d 656e 7473 2e0a  y measurements..
+0003a9c0: 0a20 2020 2020 2020 2023 2e20 4469 7363  .        #. Disc
+0003a9d0: 6172 6420 776f 726b 6572 7320 7768 6f73  ard workers whos
+0003a9e0: 6520 6f63 6375 7061 6e63 7920 6973 2077  e occupancy is w
+0003a9f0: 6974 6869 6e20 3525 206f 6620 7468 6520  ithin 5% of the 
+0003aa00: 6d65 616e 2063 6c75 7374 6572 206f 6363  mean cluster occ
+0003aa10: 7570 616e 6379 0a20 2020 2020 2020 2020  upancy.         
+0003aa20: 2020 2860 6064 6973 7472 6962 7574 6564    (``distributed
+0003aa30: 2e77 6f72 6b65 722e 6d65 6d6f 7279 2e72  .worker.memory.r
+0003aa40: 6562 616c 616e 6365 2e73 656e 6465 722d  ebalance.sender-
+0003aa50: 7265 6369 7069 656e 742d 6761 7060 6020  recipient-gap`` 
+0003aa60: 2f20 3229 2e0a 2020 2020 2020 2020 2020  / 2)..          
+0003aa70: 2054 6869 7320 6865 6c70 7320 6176 6f69   This helps avoi
+0003aa80: 6420 6461 7461 2066 726f 6d20 626f 756e  d data from boun
+0003aa90: 6369 6e67 2061 726f 756e 6420 7468 6520  cing around the 
+0003aaa0: 636c 7573 7465 7220 7265 7065 6174 6564  cluster repeated
+0003aab0: 6c79 2e0a 2020 2020 2020 2020 232e 2057  ly..        #. W
+0003aac0: 6f72 6b65 7273 2061 626f 7665 2074 6865  orkers above the
+0003aad0: 206d 6561 6e20 6172 6520 7365 6e64 6572   mean are sender
+0003aae0: 733b 2074 686f 7365 2062 656c 6f77 2061  s; those below a
+0003aaf0: 7265 2072 6563 6970 6965 6e74 732e 0a20  re recipients.. 
+0003ab00: 2020 2020 2020 2023 2e20 4469 7363 6172         #. Discar
+0003ab10: 6420 7365 6e64 6572 7320 7768 6f73 6520  d senders whose 
+0003ab20: 6162 736f 6c75 7465 206f 6363 7570 616e  absolute occupan
+0003ab30: 6379 2069 7320 6265 6c6f 7720 3330 250a  cy is below 30%.
+0003ab40: 2020 2020 2020 2020 2020 2028 6060 6469             (``di
+0003ab50: 7374 7269 6275 7465 642e 776f 726b 6572  stributed.worker
+0003ab60: 2e6d 656d 6f72 792e 7265 6261 6c61 6e63  .memory.rebalanc
+0003ab70: 652e 7365 6e64 6572 2d6d 696e 6060 292e  e.sender-min``).
+0003ab80: 2049 6e20 6f74 6865 7220 776f 7264 732c   In other words,
+0003ab90: 206e 6f20 6461 7461 0a20 2020 2020 2020   no data.       
+0003aba0: 2020 2020 6973 206d 6f76 6564 2072 6567      is moved reg
+0003abb0: 6172 646c 6573 7320 6f66 2069 6d62 616c  ardless of imbal
+0003abc0: 616e 6369 6e67 2061 7320 6c6f 6e67 2061  ancing as long a
+0003abd0: 7320 616c 6c20 776f 726b 6572 7320 6172  s all workers ar
+0003abe0: 6520 6265 6c6f 7720 3330 252e 0a20 2020  e below 30%..   
+0003abf0: 2020 2020 2023 2e20 4469 7363 6172 6420       #. Discard 
+0003ac00: 7265 6369 7069 656e 7473 2077 686f 7365  recipients whose
+0003ac10: 2061 6273 6f6c 7574 6520 6f63 6375 7061   absolute occupa
+0003ac20: 6e63 7920 6973 2061 626f 7665 2036 3025  ncy is above 60%
+0003ac30: 0a20 2020 2020 2020 2020 2020 2860 6064  .           (``d
+0003ac40: 6973 7472 6962 7574 6564 2e77 6f72 6b65  istributed.worke
+0003ac50: 722e 6d65 6d6f 7279 2e72 6562 616c 616e  r.memory.rebalan
+0003ac60: 6365 2e72 6563 6970 6965 6e74 2d6d 6178  ce.recipient-max
+0003ac70: 6060 292e 0a20 2020 2020 2020 2020 2020  ``)..           
+0003ac80: 4e6f 7465 2074 6861 7420 7468 6973 2074  Note that this t
+0003ac90: 6872 6573 686f 6c64 2062 7920 6465 6661  hreshold by defa
+0003aca0: 756c 7420 6973 2074 6865 2073 616d 6520  ult is the same 
+0003acb0: 6173 0a20 2020 2020 2020 2020 2020 6060  as.           ``
+0003acc0: 6469 7374 7269 6275 7465 642e 776f 726b  distributed.work
+0003acd0: 6572 2e6d 656d 6f72 792e 7461 7267 6574  er.memory.target
+0003ace0: 6060 2074 6f20 7072 6576 656e 7420 776f  `` to prevent wo
+0003acf0: 726b 6572 7320 6672 6f6d 2061 6363 6570  rkers from accep
+0003ad00: 7469 6e67 2064 6174 610a 2020 2020 2020  ting data.      
+0003ad10: 2020 2020 2061 6e64 2069 6d6d 6564 6961       and immedia
+0003ad20: 7465 6c79 2073 7069 6c6c 696e 6720 6974  tely spilling it
+0003ad30: 206f 7574 2074 6f20 6469 736b 2e0a 2020   out to disk..  
+0003ad40: 2020 2020 2020 232e 2049 7465 7261 7469        #. Iterati
+0003ad50: 7665 6c79 2070 6963 6b20 7468 6520 7365  vely pick the se
+0003ad60: 6e64 6572 2061 6e64 2072 6563 6970 6965  nder and recipie
+0003ad70: 6e74 2074 6861 7420 6172 6520 6661 7274  nt that are fart
+0003ad80: 6865 7374 2066 726f 6d20 7468 6520 6d65  hest from the me
+0003ad90: 616e 2061 6e64 0a20 2020 2020 2020 2020  an and.         
+0003ada0: 2020 6d6f 7665 2074 6865 202a 6c65 6173    move the *leas
+0003adb0: 7420 7265 6365 6e74 6c79 2069 6e73 6572  t recently inser
+0003adc0: 7465 642a 206b 6579 2062 6574 7765 656e  ted* key between
+0003add0: 2074 6865 2074 776f 2c20 756e 7469 6c20   the two, until 
+0003ade0: 6569 7468 6572 2061 6c6c 0a20 2020 2020  either all.     
+0003adf0: 2020 2020 2020 7365 6e64 6572 7320 6f72        senders or
+0003ae00: 2061 6c6c 2072 6563 6970 6965 6e74 7320   all recipients 
+0003ae10: 6661 6c6c 2077 6974 6869 6e20 3525 206f  fall within 5% o
+0003ae20: 6620 7468 6520 6d65 616e 2e0a 0a20 2020  f the mean...   
+0003ae30: 2020 2020 2020 2020 4120 7265 6369 7069          A recipi
+0003ae40: 656e 7420 7769 6c6c 2062 6520 736b 6970  ent will be skip
+0003ae50: 7065 6420 6966 2069 7420 616c 7265 6164  ped if it alread
+0003ae60: 7920 6861 7320 6120 636f 7079 206f 6620  y has a copy of 
+0003ae70: 7468 6520 6461 7461 2e20 496e 206f 7468  the data. In oth
+0003ae80: 6572 0a20 2020 2020 2020 2020 2020 776f  er.           wo
+0003ae90: 7264 732c 2074 6869 7320 6d65 7468 6f64  rds, this method
+0003aea0: 2064 6f65 7320 6e6f 7420 6465 6772 6164   does not degrad
+0003aeb0: 6520 7265 706c 6963 6174 696f 6e2e 0a20  e replication.. 
+0003aec0: 2020 2020 2020 2020 2020 4120 6b65 7920            A key 
+0003aed0: 7769 6c6c 2062 6520 736b 6970 7065 6420  will be skipped 
+0003aee0: 6966 2074 6865 7265 2061 7265 206e 6f20  if there are no 
+0003aef0: 7265 6369 7069 656e 7473 2061 7661 696c  recipients avail
+0003af00: 6162 6c65 2077 6974 6820 656e 6f75 6768  able with enough
+0003af10: 206d 656d 6f72 790a 2020 2020 2020 2020   memory.        
+0003af20: 2020 2074 6f20 6163 6365 7074 2074 6865     to accept the
+0003af30: 206b 6579 2061 6e64 2074 6861 7420 646f   key and that do
+0003af40: 6e27 7420 616c 7265 6164 7920 686f 6c64  n't already hold
+0003af50: 2061 2063 6f70 792e 0a0a 2020 2020 2020   a copy...      
+0003af60: 2020 5468 6520 6c65 6173 7420 7265 6365    The least rece
+0003af70: 6e74 6c79 2069 6e73 6572 7464 2028 4c52  ntly insertd (LR
+0003af80: 4929 2070 6f6c 6963 7920 6973 2061 2067  I) policy is a g
+0003af90: 7265 6564 7920 6368 6f69 6365 2077 6974  reedy choice wit
+0003afa0: 6820 7468 6520 6164 7661 6e74 6167 6520  h the advantage 
+0003afb0: 6f66 0a20 2020 2020 2020 2062 6569 6e67  of.        being
+0003afc0: 204f 2831 292c 2074 7269 7669 616c 2074   O(1), trivial t
+0003afd0: 6f20 696d 706c 656d 656e 7420 2869 7420  o implement (it 
+0003afe0: 7265 6c69 6573 206f 6e20 7079 7468 6f6e  relies on python
+0003aff0: 2064 6963 7420 696e 7365 7274 696f 6e2d   dict insertion-
+0003b000: 736f 7274 696e 6729 0a20 2020 2020 2020  sorting).       
+0003b010: 2061 6e64 2068 6f70 6566 756c 6c79 2067   and hopefully g
+0003b020: 6f6f 6420 656e 6f75 6768 2069 6e20 6d6f  ood enough in mo
+0003b030: 7374 2063 6173 6573 2e20 4469 7363 6172  st cases. Discar
+0003b040: 6465 6420 616c 7465 726e 6174 6976 6520  ded alternative 
+0003b050: 706f 6c69 6369 6573 2077 6572 653a 0a0a  policies were:..
+0003b060: 2020 2020 2020 2020 2d20 4c61 7267 6573          - Larges
+0003b070: 7420 6669 7273 742e 204f 286e 2a6c 6f67  t first. O(n*log
+0003b080: 286e 2929 2073 6176 6520 666f 7220 6e6f  (n)) save for no
+0003b090: 6e2d 7472 6976 6961 6c20 6164 6469 7469  n-trivial additi
+0003b0a0: 6f6e 616c 2064 6174 6120 7374 7275 6374  onal data struct
+0003b0b0: 7572 6573 2061 6e64 0a20 2020 2020 2020  ures and.       
+0003b0c0: 2020 2072 6973 6b73 2063 6175 7369 6e67     risks causing
+0003b0d0: 2074 6865 206c 6172 6765 7374 2063 6875   the largest chu
+0003b0e0: 6e6b 7320 6f66 2064 6174 6120 746f 2072  nks of data to r
+0003b0f0: 6570 6561 7465 646c 7920 6d6f 7665 2061  epeatedly move a
+0003b100: 726f 756e 6420 7468 650a 2020 2020 2020  round the.      
+0003b110: 2020 2020 636c 7573 7465 7220 6c69 6b65      cluster like
+0003b120: 2070 696e 6261 6c6c 732e 0a20 2020 2020   pinballs..     
+0003b130: 2020 202d 204c 6561 7374 2072 6563 656e     - Least recen
+0003b140: 746c 7920 7573 6564 2028 4c52 5529 2e20  tly used (LRU). 
+0003b150: 5468 6973 2069 6e66 6f72 6d61 7469 6f6e  This information
+0003b160: 2069 7320 6375 7272 656e 746c 7920 6176   is currently av
+0003b170: 6169 6c61 626c 6520 6f6e 2074 6865 0a20  ailable on the. 
+0003b180: 2020 2020 2020 2020 2077 6f72 6b65 7273           workers
+0003b190: 206f 6e6c 7920 616e 6420 6e6f 7420 7472   only and not tr
+0003b1a0: 6976 6961 6c20 746f 2072 6570 6c69 6361  ivial to replica
+0003b1b0: 7465 206f 6e20 7468 6520 7363 6865 6475  te on the schedu
+0003b1c0: 6c65 723b 2074 7261 6e73 6d69 7474 696e  ler; transmittin
+0003b1d0: 6720 6974 0a20 2020 2020 2020 2020 206f  g it.          o
+0003b1e0: 7665 7220 7468 6520 6e65 7477 6f72 6b20  ver the network 
+0003b1f0: 776f 756c 6420 6265 2076 6572 7920 6578  would be very ex
+0003b200: 7065 6e73 6976 652e 2041 6c73 6f2c 206e  pensive. Also, n
+0003b210: 6f74 6520 7468 6174 2064 6173 6b20 7769  ote that dask wi
+0003b220: 6c6c 2067 6f20 6f75 7420 6f66 0a20 2020  ll go out of.   
+0003b230: 2020 2020 2020 2069 7473 2077 6179 2074         its way t
+0003b240: 6f20 6d69 6e69 6d69 7365 2074 6865 2061  o minimise the a
+0003b250: 6d6f 756e 7420 6f66 2074 696d 6520 696e  mount of time in
+0003b260: 7465 726d 6564 6961 7465 206b 6579 7320  termediate keys 
+0003b270: 6172 6520 6865 6c64 2069 6e20 6d65 6d6f  are held in memo
+0003b280: 7279 2c0a 2020 2020 2020 2020 2020 736f  ry,.          so
+0003b290: 2069 6e20 7375 6368 2061 2063 6173 6520   in such a case 
+0003b2a0: 4c52 4920 6973 2061 2063 6c6f 7365 2061  LRI is a close a
+0003b2b0: 7070 726f 7869 6d61 7469 6f6e 206f 6620  pproximation of 
+0003b2c0: 4c52 552e 0a0a 2020 2020 2020 2020 5061  LRU...        Pa
+0003b2d0: 7261 6d65 7465 7273 0a20 2020 2020 2020  rameters.       
+0003b2e0: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
+0003b2f0: 2020 2020 6b65 7973 3a20 6f70 7469 6f6e      keys: option
+0003b300: 616c 0a20 2020 2020 2020 2020 2020 2061  al.            a
+0003b310: 6c6c 6f77 6c69 7374 206f 6620 6461 736b  llowlist of dask
+0003b320: 206b 6579 7320 7468 6174 2073 686f 756c   keys that shoul
+0003b330: 6420 6265 2063 6f6e 7369 6465 7265 6420  d be considered 
+0003b340: 666f 7220 6d6f 7669 6e67 2e20 416c 6c20  for moving. All 
+0003b350: 6f74 6865 7220 6b65 7973 0a20 2020 2020  other keys.     
+0003b360: 2020 2020 2020 2077 696c 6c20 6265 2069         will be i
+0003b370: 676e 6f72 6564 2e20 4e6f 7465 2074 6861  gnored. Note tha
+0003b380: 7420 7468 6973 206f 6666 6572 7320 6e6f  t this offers no
+0003b390: 2067 7561 7261 6e74 6565 2074 6861 7420   guarantee that 
+0003b3a0: 6120 6b65 7920 7769 6c6c 2061 6374 7561  a key will actua
+0003b3b0: 6c6c 790a 2020 2020 2020 2020 2020 2020  lly.            
+0003b3c0: 6265 206d 6f76 6564 2028 652e 672e 2062  be moved (e.g. b
+0003b3d0: 6563 6175 7365 2069 7420 6973 2075 6e6e  ecause it is unn
+0003b3e0: 6563 6573 7361 7279 206f 7220 6265 6361  ecessary or beca
+0003b3f0: 7573 6520 7468 6572 6520 6172 6520 6e6f  use there are no
+0003b400: 2076 6961 626c 650a 2020 2020 2020 2020   viable.        
+0003b410: 2020 2020 7265 6369 7069 656e 7420 776f      recipient wo
+0003b420: 726b 6572 7320 666f 7220 6974 292e 0a20  rkers for it).. 
+0003b430: 2020 2020 2020 2077 6f72 6b65 7273 3a20         workers: 
+0003b440: 6f70 7469 6f6e 616c 0a20 2020 2020 2020  optional.       
+0003b450: 2020 2020 2061 6c6c 6f77 6c69 7374 206f       allowlist o
+0003b460: 6620 776f 726b 6572 7320 6164 6472 6573  f workers addres
+0003b470: 7365 7320 746f 2062 6520 636f 6e73 6964  ses to be consid
+0003b480: 6572 6564 2061 7320 7365 6e64 6572 7320  ered as senders 
+0003b490: 6f72 2072 6563 6970 6965 6e74 732e 0a20  or recipients.. 
+0003b4a0: 2020 2020 2020 2020 2020 2041 6c6c 206f             All o
+0003b4b0: 7468 6572 2077 6f72 6b65 7273 2077 696c  ther workers wil
+0003b4c0: 6c20 6265 2069 676e 6f72 6564 2e20 5468  l be ignored. Th
+0003b4d0: 6520 6d65 616e 2063 6c75 7374 6572 206f  e mean cluster o
+0003b4e0: 6363 7570 616e 6379 2077 696c 6c20 6265  ccupancy will be
+0003b4f0: 0a20 2020 2020 2020 2020 2020 2063 616c  .            cal
+0003b500: 6375 6c61 7465 6420 6f6e 6c79 2075 7369  culated only usi
+0003b510: 6e67 2074 6865 2061 6c6c 6f77 6564 2077  ng the allowed w
+0003b520: 6f72 6b65 7273 2e0a 2020 2020 2020 2020  orkers..        
+0003b530: 2222 220a 2020 2020 2020 2020 7374 696d  """.        stim
+0003b540: 756c 7573 5f69 6420 3d20 7374 696d 756c  ulus_id = stimul
+0003b550: 7573 5f69 6420 6f72 2066 2272 6562 616c  us_id or f"rebal
+0003b560: 616e 6365 2d7b 7469 6d65 2829 7d22 0a0a  ance-{time()}"..
+0003b570: 2020 2020 2020 2020 7773 733a 2043 6f6c          wss: Col
+0003b580: 6c65 6374 696f 6e5b 576f 726b 6572 5374  lection[WorkerSt
+0003b590: 6174 655d 0a20 2020 2020 2020 2069 6620  ate].        if 
+0003b5a0: 776f 726b 6572 7320 6973 206e 6f74 204e  workers is not N
+0003b5b0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0003b5c0: 2077 7373 203d 205b 7365 6c66 2e77 6f72   wss = [self.wor
+0003b5d0: 6b65 7273 5b77 5d20 666f 7220 7720 696e  kers[w] for w in
+0003b5e0: 2077 6f72 6b65 7273 5d0a 2020 2020 2020   workers].      
+0003b5f0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0003b600: 2020 2020 7773 7320 3d20 7365 6c66 2e77      wss = self.w
+0003b610: 6f72 6b65 7273 2e76 616c 7565 7328 290a  orkers.values().
+0003b620: 2020 2020 2020 2020 6966 206e 6f74 2077          if not w
+0003b630: 7373 3a0a 2020 2020 2020 2020 2020 2020  ss:.            
+0003b640: 7265 7475 726e 207b 2273 7461 7475 7322  return {"status"
+0003b650: 3a20 224f 4b22 7d0a 0a20 2020 2020 2020  : "OK"}..       
+0003b660: 2069 6620 6b65 7973 2069 7320 6e6f 7420   if keys is not 
+0003b670: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0003b680: 2020 6966 206e 6f74 2069 7369 6e73 7461    if not isinsta
+0003b690: 6e63 6528 6b65 7973 2c20 5365 7429 3a0a  nce(keys, Set):.
+0003b6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b6b0: 6b65 7973 203d 2073 6574 286b 6579 7329  keys = set(keys)
+0003b6c0: 2020 2320 756e 6c65 7373 2061 6c72 6561    # unless alrea
+0003b6d0: 6479 2061 2073 6574 2d6c 696b 650a 2020  dy a set-like.  
+0003b6e0: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+0003b6f0: 206b 6579 733a 0a20 2020 2020 2020 2020   keys:.         
+0003b700: 2020 2020 2020 2072 6574 7572 6e20 7b22         return {"
+0003b710: 7374 6174 7573 223a 2022 4f4b 227d 0a20  status": "OK"}. 
+0003b720: 2020 2020 2020 2020 2020 206d 6973 7369             missi
+0003b730: 6e67 5f64 6174 6120 3d20 5b0a 2020 2020  ng_data = [.    
+0003b740: 2020 2020 2020 2020 2020 2020 6b20 666f              k fo
+0003b750: 7220 6b20 696e 206b 6579 7320 6966 206b  r k in keys if k
+0003b760: 206e 6f74 2069 6e20 7365 6c66 2e74 6173   not in self.tas
+0003b770: 6b73 206f 7220 6e6f 7420 7365 6c66 2e74  ks or not self.t
+0003b780: 6173 6b73 5b6b 5d2e 7768 6f5f 6861 730a  asks[k].who_has.
+0003b790: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
+0003b7a0: 2020 2020 2020 2020 2020 6966 206d 6973            if mis
+0003b7b0: 7369 6e67 5f64 6174 613a 0a20 2020 2020  sing_data:.     
+0003b7c0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0003b7d0: 6e20 7b22 7374 6174 7573 223a 2022 7061  n {"status": "pa
+0003b7e0: 7274 6961 6c2d 6661 696c 222c 2022 6b65  rtial-fail", "ke
+0003b7f0: 7973 223a 206d 6973 7369 6e67 5f64 6174  ys": missing_dat
+0003b800: 617d 0a0a 2020 2020 2020 2020 6d73 6773  a}..        msgs
+0003b810: 203d 2073 656c 662e 5f72 6562 616c 616e   = self._rebalan
+0003b820: 6365 5f66 696e 645f 6d73 6773 286b 6579  ce_find_msgs(key
+0003b830: 732c 2077 7373 290a 2020 2020 2020 2020  s, wss).        
+0003b840: 6966 206e 6f74 206d 7367 733a 0a20 2020  if not msgs:.   
+0003b850: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0003b860: 7b22 7374 6174 7573 223a 2022 4f4b 227d  {"status": "OK"}
+0003b870: 0a0a 2020 2020 2020 2020 2320 446f 776e  ..        # Down
+0003b880: 6772 6164 6520 7265 656e 7472 616e 7420  grade reentrant 
+0003b890: 6c6f 636b 2074 6f20 6e6f 6e2d 7265 656e  lock to non-reen
+0003b8a0: 7472 616e 740a 2020 2020 2020 2020 6173  trant.        as
+0003b8b0: 796e 6320 7769 7468 2073 656c 662e 5f72  ync with self._r
+0003b8c0: 6570 6c69 6361 5f6c 6f63 6b28 2822 7265  eplica_lock(("re
+0003b8d0: 6261 6c61 6e63 6522 2c20 6f62 6a65 6374  balance", object
+0003b8e0: 2829 2929 3a0a 2020 2020 2020 2020 2020  ())):.          
+0003b8f0: 2020 7265 7375 6c74 203d 2061 7761 6974    result = await
+0003b900: 2073 656c 662e 5f72 6562 616c 616e 6365   self._rebalance
+0003b910: 5f6d 6f76 655f 6461 7461 286d 7367 732c  _move_data(msgs,
+0003b920: 2073 7469 6d75 6c75 735f 6964 290a 2020   stimulus_id).  
+0003b930: 2020 2020 2020 2020 2020 6966 2072 6573            if res
+0003b940: 756c 745b 2273 7461 7475 7322 5d20 3d3d  ult["status"] ==
+0003b950: 2022 7061 7274 6961 6c2d 6661 696c 2220   "partial-fail" 
+0003b960: 616e 6420 6b65 7973 2069 7320 4e6f 6e65  and keys is None
+0003b970: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003b980: 2020 2320 4f6e 6c79 2072 6574 7572 6e20    # Only return 
+0003b990: 6661 696c 6564 206b 6579 7320 6966 2074  failed keys if t
+0003b9a0: 6865 2063 6c69 656e 7420 6578 706c 6963  he client explic
+0003b9b0: 6974 6c79 2061 736b 6564 2066 6f72 2074  itly asked for t
+0003b9c0: 6865 6d0a 2020 2020 2020 2020 2020 2020  hem.            
+0003b9d0: 2020 2020 7265 7375 6c74 203d 207b 2273      result = {"s
+0003b9e0: 7461 7475 7322 3a20 224f 4b22 7d0a 2020  tatus": "OK"}.  
+0003b9f0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0003ba00: 2072 6573 756c 740a 0a20 2020 2064 6566   result..    def
+0003ba10: 205f 7265 6261 6c61 6e63 655f 6669 6e64   _rebalance_find
+0003ba20: 5f6d 7367 7328 0a20 2020 2020 2020 2073  _msgs(.        s
+0003ba30: 656c 662c 0a20 2020 2020 2020 206b 6579  elf,.        key
+0003ba40: 733a 2053 6574 5b48 6173 6861 626c 655d  s: Set[Hashable]
+0003ba50: 207c 204e 6f6e 652c 0a20 2020 2020 2020   | None,.       
+0003ba60: 2077 6f72 6b65 7273 3a20 4974 6572 6162   workers: Iterab
+0003ba70: 6c65 5b57 6f72 6b65 7253 7461 7465 5d2c  le[WorkerState],
+0003ba80: 0a20 2020 2029 202d 3e20 6c69 7374 5b74  .    ) -> list[t
+0003ba90: 7570 6c65 5b57 6f72 6b65 7253 7461 7465  uple[WorkerState
+0003baa0: 2c20 576f 726b 6572 5374 6174 652c 2054  , WorkerState, T
+0003bab0: 6173 6b53 7461 7465 5d5d 3a0a 2020 2020  askState]]:.    
+0003bac0: 2020 2020 2222 2249 6465 6e74 6966 7920      """Identify 
+0003bad0: 776f 726b 6572 7320 7468 6174 206e 6565  workers that nee
+0003bae0: 6420 746f 206c 6f73 6520 6b65 7973 2061  d to lose keys a
+0003baf0: 6e64 2074 686f 7365 2074 6861 7420 6361  nd those that ca
+0003bb00: 6e20 7265 6365 6976 6520 7468 656d 2c0a  n receive them,.
+0003bb10: 2020 2020 2020 2020 746f 6765 7468 6572          together
+0003bb20: 2077 6974 6820 686f 7720 6d61 6e79 2062   with how many b
+0003bb30: 7974 6573 2065 6163 6820 6e65 6564 7320  ytes each needs 
+0003bb40: 746f 206c 6f73 652f 7265 6365 6976 652e  to lose/receive.
+0003bb50: 2054 6865 6e2c 2070 6169 7220 6120 7365   Then, pair a se
+0003bb60: 6e64 6572 0a20 2020 2020 2020 2077 6f72  nder.        wor
+0003bb70: 6b65 7220 7769 7468 2061 2072 6563 6970  ker with a recip
+0003bb80: 6965 6e74 2077 6f72 6b65 7220 666f 7220  ient worker for 
+0003bb90: 6561 6368 206b 6579 2c20 756e 7469 6c20  each key, until 
+0003bba0: 7468 6520 636c 7573 7465 7220 6973 2072  the cluster is r
+0003bbb0: 6562 616c 616e 6365 642e 0a0a 2020 2020  ebalanced...    
+0003bbc0: 2020 2020 5468 6973 206d 6574 686f 6420      This method 
+0003bbd0: 6f6e 6c79 2064 6566 696e 6573 2074 6865  only defines the
+0003bbe0: 2077 6f72 6b20 746f 2062 6520 7065 7266   work to be perf
+0003bbf0: 6f72 6d65 643b 2069 7420 646f 6573 206e  ormed; it does n
+0003bc00: 6f74 2073 7461 7274 2061 6e79 206e 6574  ot start any net
+0003bc10: 776f 726b 0a20 2020 2020 2020 2074 7261  work.        tra
+0003bc20: 6e73 6665 7273 2069 7473 656c 662e 0a0a  nsfers itself...
+0003bc30: 2020 2020 2020 2020 5468 6520 6269 672d          The big-
+0003bc40: 4f20 636f 6d70 6c65 7869 7479 2069 7320  O complexity is 
+0003bc50: 4f28 7774 202b 206b 652a 6c6f 6728 7765  O(wt + ke*log(we
+0003bc60: 2929 2c20 7768 6572 650a 0a20 2020 2020  )), where..     
+0003bc70: 2020 202d 2077 7420 6973 2074 6865 2074     - wt is the t
+0003bc80: 6f74 616c 206e 756d 6265 7220 6f66 2077  otal number of w
+0003bc90: 6f72 6b65 7273 206f 6e20 7468 6520 636c  orkers on the cl
+0003bca0: 7573 7465 7220 286f 7220 7468 6520 6e75  uster (or the nu
+0003bcb0: 6d62 6572 206f 6620 616c 6c6f 7765 640a  mber of allowed.
+0003bcc0: 2020 2020 2020 2020 2020 776f 726b 6572            worker
+0003bcd0: 732c 2069 6620 6578 706c 6963 6974 6c79  s, if explicitly
+0003bce0: 2073 7461 7465 6420 6279 2074 6865 2075   stated by the u
+0003bcf0: 7365 7229 0a20 2020 2020 2020 202d 2077  ser).        - w
+0003bd00: 6520 6973 2074 6865 206e 756d 6265 7220  e is the number 
+0003bd10: 6f66 2077 6f72 6b65 7273 2074 6861 7420  of workers that 
+0003bd20: 6172 6520 656c 6967 6962 6c65 2074 6f20  are eligible to 
+0003bd30: 6265 2073 656e 6465 7273 206f 7220 7265  be senders or re
+0003bd40: 6369 7069 656e 7473 0a20 2020 2020 2020  cipients.       
+0003bd50: 202d 206b 7420 6973 2074 6865 2074 6f74   - kt is the tot
+0003bd60: 616c 206e 756d 6265 7220 6f66 206b 6579  al number of key
+0003bd70: 7320 6f6e 2074 6865 2063 6c75 7374 6572  s on the cluster
+0003bd80: 2028 6f72 206f 6e20 7468 6520 616c 6c6f   (or on the allo
+0003bd90: 7765 6420 776f 726b 6572 7329 0a20 2020  wed workers).   
+0003bda0: 2020 2020 202d 206b 6520 6973 2074 6865       - ke is the
+0003bdb0: 206e 756d 6265 7220 6f66 206b 6579 7320   number of keys 
+0003bdc0: 7468 6174 206e 6565 6420 746f 2062 6520  that need to be 
+0003bdd0: 6d6f 7665 6420 696e 206f 7264 6572 2074  moved in order t
+0003bde0: 6f20 6163 6869 6576 6520 6120 6261 6c61  o achieve a bala
+0003bdf0: 6e63 6564 0a20 2020 2020 2020 2020 2063  nced.          c
+0003be00: 6c75 7374 6572 0a0a 2020 2020 2020 2020  luster..        
+0003be10: 5468 6572 6520 6973 2061 2064 6567 656e  There is a degen
+0003be20: 6572 6174 6520 6564 6765 2063 6173 6520  erate edge case 
+0003be30: 4f28 7774 202b 206b 742a 6c6f 6728 7765  O(wt + kt*log(we
+0003be40: 2929 2077 6865 6e20 6b74 2069 7320 6d75  )) when kt is mu
+0003be50: 6368 2067 7265 6174 6572 2074 6861 6e0a  ch greater than.
+0003be60: 2020 2020 2020 2020 7468 6520 6e75 6d62          the numb
+0003be70: 6572 206f 6620 616c 6c6f 7765 6420 6b65  er of allowed ke
+0003be80: 7973 2c20 6f72 2077 6865 6e20 6d6f 7374  ys, or when most
+0003be90: 206b 6579 7320 6172 6520 7265 706c 6963   keys are replic
+0003bea0: 6174 6564 206f 7220 6361 6e6e 6f74 2062  ated or cannot b
+0003beb0: 650a 2020 2020 2020 2020 6d6f 7665 6420  e.        moved 
+0003bec0: 666f 7220 736f 6d65 206f 7468 6572 2072  for some other r
+0003bed0: 6561 736f 6e2e 0a0a 2020 2020 2020 2020  eason...        
+0003bee0: 5265 7475 726e 7320 6c69 7374 206f 6620  Returns list of 
+0003bef0: 7475 706c 6573 2074 6f20 6665 6564 2069  tuples to feed i
+0003bf00: 6e74 6f20 5f72 6562 616c 616e 6365 5f6d  nto _rebalance_m
+0003bf10: 6f76 655f 6461 7461 3a0a 0a20 2020 2020  ove_data:..     
+0003bf20: 2020 202d 2073 656e 6465 7220 776f 726b     - sender work
+0003bf30: 6572 0a20 2020 2020 2020 202d 2072 6563  er.        - rec
+0003bf40: 6970 6965 6e74 2077 6f72 6b65 720a 2020  ipient worker.  
+0003bf50: 2020 2020 2020 2d20 7461 736b 2074 6f20        - task to 
+0003bf60: 6265 2074 7261 6e73 6665 7272 6564 0a20  be transferred. 
+0003bf70: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0003bf80: 2020 2023 2048 6561 7073 206f 6620 776f     # Heaps of wo
+0003bf90: 726b 6572 732c 206d 616e 6167 6564 2062  rkers, managed b
+0003bfa0: 7920 7468 6520 6865 6170 7120 6d6f 6475  y the heapq modu
+0003bfb0: 6c65 2c20 7468 6174 206e 6565 6420 746f  le, that need to
+0003bfc0: 2073 656e 642f 7265 6365 6976 6520 6461   send/receive da
+0003bfd0: 7461 2c0a 2020 2020 2020 2020 2320 7769  ta,.        # wi
+0003bfe0: 7468 2068 6f77 206d 616e 7920 6279 7465  th how many byte
+0003bff0: 7320 6561 6368 206e 6565 6473 2074 6f20  s each needs to 
+0003c000: 7365 6e64 2f72 6563 6569 7665 2e0a 2020  send/receive..  
+0003c010: 2020 2020 2020 230a 2020 2020 2020 2020        #.        
+0003c020: 2320 4561 6368 2065 6c65 6d65 6e74 206f  # Each element o
+0003c030: 6620 7468 6520 6865 6170 2069 7320 6120  f the heap is a 
+0003c040: 7475 706c 6520 636f 6e73 7472 7563 7465  tuple constructe
+0003c050: 6420 6173 2066 6f6c 6c6f 7773 3a0a 2020  d as follows:.  
+0003c060: 2020 2020 2020 2320 2d20 736e 645f 6279        # - snd_by
+0003c070: 7465 735f 6d61 782f 7265 635f 6279 7465  tes_max/rec_byte
+0003c080: 735f 6d61 783a 206d 6178 696d 756d 206e  s_max: maximum n
+0003c090: 756d 6265 7220 6f66 2062 7974 6573 2074  umber of bytes t
+0003c0a0: 6f20 7365 6e64 206f 7220 7265 6365 6976  o send or receiv
+0003c0b0: 652e 0a20 2020 2020 2020 2023 2020 2054  e..        #   T
+0003c0c0: 6869 7320 6e75 6d62 6572 2069 7320 6e65  his number is ne
+0003c0d0: 6761 7469 7665 2c20 736f 2074 6861 7420  gative, so that 
+0003c0e0: 7468 6520 776f 726b 6572 7320 6661 7274  the workers fart
+0003c0f0: 6865 7374 2066 726f 6d20 7468 6520 636c  hest from the cl
+0003c100: 7573 7465 7220 6d65 616e 0a20 2020 2020  uster mean.     
+0003c110: 2020 2023 2020 2061 7265 2061 7420 7468     #   are at th
+0003c120: 6520 746f 7020 6f66 2074 6865 2073 6d61  e top of the sma
+0003c130: 6c6c 6573 742d 6669 7273 7420 6865 6170  llest-first heap
+0003c140: 732e 0a20 2020 2020 2020 2023 202d 2073  s..        # - s
+0003c150: 6e64 5f62 7974 6573 5f6d 696e 2f72 6563  nd_bytes_min/rec
+0003c160: 5f62 7974 6573 5f6d 696e 3a20 6d69 6e69  _bytes_min: mini
+0003c170: 6d75 6d20 6e75 6d62 6572 206f 6620 6279  mum number of by
+0003c180: 7465 7320 6166 7465 7220 7365 6e64 696e  tes after sendin
+0003c190: 672f 7265 6365 6976 696e 670a 2020 2020  g/receiving.    
+0003c1a0: 2020 2020 2320 2020 7768 6963 6820 7468      #   which th
+0003c1b0: 6520 776f 726b 6572 2073 686f 756c 6420  e worker should 
+0003c1c0: 6e6f 7420 6265 2063 6f6e 7369 6465 7265  not be considere
+0003c1d0: 6420 616e 796d 6f72 652e 2054 6869 7320  d anymore. This 
+0003c1e0: 6973 2061 6c73 6f20 6e65 6761 7469 7665  is also negative
+0003c1f0: 2e0a 2020 2020 2020 2020 2320 2d20 6172  ..        # - ar
+0003c200: 6269 7472 6172 7920 756e 6971 7565 206e  bitrary unique n
+0003c210: 756d 6265 722c 2074 6865 7265 206a 7573  umber, there jus
+0003c220: 7420 746f 2074 6f20 6d61 6b65 2073 7572  t to to make sur
+0003c230: 6520 7468 6174 2057 6f72 6b65 7253 7461  e that WorkerSta
+0003c240: 7465 206f 626a 6563 7473 0a20 2020 2020  te objects.     
+0003c250: 2020 2023 2020 2061 7265 206e 6576 6572     #   are never
+0003c260: 2075 7365 6420 666f 7220 736f 7274 696e   used for sortin
+0003c270: 6720 696e 2074 6865 2075 6e6c 696b 656c  g in the unlikel
+0003c280: 7920 6576 656e 7420 7468 6174 2074 776f  y event that two
+0003c290: 2070 726f 6365 7373 6573 2068 6176 650a   processes have.
+0003c2a0: 2020 2020 2020 2020 2320 2020 6578 6163          #   exac
+0003c2b0: 746c 7920 7468 6520 7361 6d65 206e 756d  tly the same num
+0003c2c0: 6265 7220 6f66 2062 7974 6573 2061 6c6c  ber of bytes all
+0003c2d0: 6f63 6174 6564 2e0a 2020 2020 2020 2020  ocated..        
+0003c2e0: 2320 2d20 576f 726b 6572 5374 6174 650a  # - WorkerState.
+0003c2f0: 2020 2020 2020 2020 2320 2d20 6974 6572          # - iter
+0003c300: 6174 6f72 206f 6620 616c 6c20 7461 736b  ator of all task
+0003c310: 7320 696e 206d 656d 6f72 7920 6f6e 2074  s in memory on t
+0003c320: 6865 2077 6f72 6b65 7220 2873 656e 6465  he worker (sende
+0003c330: 7273 206f 6e6c 7929 2c20 696e 7365 7274  rs only), insert
+0003c340: 696f 6e0a 2020 2020 2020 2020 2320 2020  ion.        #   
+0003c350: 736f 7274 6564 2028 6c65 6173 7420 7265  sorted (least re
+0003c360: 6365 6e74 6c79 2069 6e73 6572 7465 6420  cently inserted 
+0003c370: 6669 7273 7429 2e0a 2020 2020 2020 2020  first)..        
+0003c380: 2320 2020 4e6f 7465 2074 6861 7420 7468  #   Note that th
+0003c390: 6973 2069 7465 7261 746f 7220 7769 6c6c  is iterator will
+0003c3a0: 2074 7970 6963 616c 6c79 202a 6e6f 742a   typically *not*
+0003c3b0: 2062 6520 6578 6861 7573 7465 642e 2049   be exhausted. I
+0003c3c0: 7420 7769 6c6c 206f 6e6c 7920 6265 0a20  t will only be. 
+0003c3d0: 2020 2020 2020 2023 2020 2065 7868 6175         #   exhau
+0003c3e0: 7374 6564 2069 662c 2061 6674 6572 206d  sted if, after m
+0003c3f0: 6f76 696e 6720 6177 6179 2066 726f 6d20  oving away from 
+0003c400: 7468 6520 776f 726b 6572 2061 6c6c 206b  the worker all k
+0003c410: 6579 7320 7468 6174 2063 616e 2062 6520  eys that can be 
+0003c420: 6d6f 7665 642c 0a20 2020 2020 2020 2023  moved,.        #
+0003c430: 2020 2069 7320 696e 7375 6666 6963 6965     is insufficie
+0003c440: 6e74 2074 6f20 6472 6f70 2073 6e64 5f62  nt to drop snd_b
+0003c450: 7974 6573 5f6d 696e 2061 626f 7665 2030  ytes_min above 0
+0003c460: 2e0a 2020 2020 2020 2020 7365 6e64 6572  ..        sender
+0003c470: 733a 206c 6973 745b 7475 706c 655b 696e  s: list[tuple[in
+0003c480: 742c 2069 6e74 2c20 696e 742c 2057 6f72  t, int, int, Wor
+0003c490: 6b65 7253 7461 7465 2c20 4974 6572 6174  kerState, Iterat
+0003c4a0: 6f72 5b54 6173 6b53 7461 7465 5d5d 5d20  or[TaskState]]] 
+0003c4b0: 3d20 5b5d 0a20 2020 2020 2020 2072 6563  = [].        rec
+0003c4c0: 6970 6965 6e74 733a 206c 6973 745b 7475  ipients: list[tu
+0003c4d0: 706c 655b 696e 742c 2069 6e74 2c20 696e  ple[int, int, in
+0003c4e0: 742c 2057 6f72 6b65 7253 7461 7465 5d5d  t, WorkerState]]
+0003c4f0: 203d 205b 5d0a 0a20 2020 2020 2020 2023   = []..        #
+0003c500: 204f 7574 7075 743a 205b 2873 656e 6465   Output: [(sende
+0003c510: 722c 2072 6563 6970 6965 6e74 2c20 7461  r, recipient, ta
+0003c520: 736b 292c 202e 2e2e 5d0a 2020 2020 2020  sk), ...].      
+0003c530: 2020 6d73 6773 3a20 6c69 7374 5b74 7570    msgs: list[tup
+0003c540: 6c65 5b57 6f72 6b65 7253 7461 7465 2c20  le[WorkerState, 
+0003c550: 576f 726b 6572 5374 6174 652c 2054 6173  WorkerState, Tas
+0003c560: 6b53 7461 7465 5d5d 203d 205b 5d0a 0a20  kState]] = [].. 
+0003c570: 2020 2020 2020 2023 2042 7920 6465 6661         # By defa
+0003c580: 756c 742c 2074 6869 7320 6973 2074 6865  ult, this is the
+0003c590: 206f 7074 696d 6973 7469 6320 6d65 6d6f   optimistic memo
+0003c5a0: 7279 2c20 6d65 616e 696e 6720 746f 7461  ry, meaning tota
+0003c5b0: 6c20 7072 6f63 6573 7320 6d65 6d6f 7279  l process memory
+0003c5c0: 206d 696e 7573 0a20 2020 2020 2020 2023   minus.        #
+0003c5d0: 2075 6e6d 616e 6167 6564 206d 656d 6f72   unmanaged memor
+0003c5e0: 7920 7468 6174 2061 7070 6561 7265 6420  y that appeared 
+0003c5f0: 6f76 6572 2074 6865 206c 6173 7420 3330  over the last 30
+0003c600: 2073 6563 6f6e 6473 0a20 2020 2020 2020   seconds.       
+0003c610: 2023 2028 6469 7374 7269 6275 7465 642e   # (distributed.
+0003c620: 776f 726b 6572 2e6d 656d 6f72 792e 7265  worker.memory.re
+0003c630: 6365 6e74 2d74 6f2d 6f6c 642d 7469 6d65  cent-to-old-time
+0003c640: 292e 0a20 2020 2020 2020 2023 2054 6869  )..        # Thi
+0003c650: 7320 6c65 7473 2075 7320 6967 6e6f 7265  s lets us ignore
+0003c660: 2074 656d 706f 7261 7279 2073 7069 6b65   temporary spike
+0003c670: 7320 6361 7573 6564 2062 7920 7461 736b  s caused by task
+0003c680: 2068 6561 7020 7573 6167 652e 0a20 2020   heap usage..   
+0003c690: 2020 2020 206d 656d 6f72 795f 6279 5f77       memory_by_w
+0003c6a0: 6f72 6b65 7220 3d20 5b0a 2020 2020 2020  orker = [.      
+0003c6b0: 2020 2020 2020 2877 732c 2067 6574 6174        (ws, getat
+0003c6c0: 7472 2877 732e 6d65 6d6f 7279 2c20 7365  tr(ws.memory, se
+0003c6d0: 6c66 2e4d 454d 4f52 595f 5245 4241 4c41  lf.MEMORY_REBALA
+0003c6e0: 4e43 455f 4d45 4153 5552 4529 2920 666f  NCE_MEASURE)) fo
+0003c6f0: 7220 7773 2069 6e20 776f 726b 6572 730a  r ws in workers.
+0003c700: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
+0003c710: 2020 6d65 616e 5f6d 656d 6f72 7920 3d20    mean_memory = 
+0003c720: 7375 6d28 6d20 666f 7220 5f2c 206d 2069  sum(m for _, m i
+0003c730: 6e20 6d65 6d6f 7279 5f62 795f 776f 726b  n memory_by_work
+0003c740: 6572 2920 2f2f 206c 656e 286d 656d 6f72  er) // len(memor
+0003c750: 795f 6279 5f77 6f72 6b65 7229 0a0a 2020  y_by_worker)..  
+0003c760: 2020 2020 2020 666f 7220 7773 2c20 7773        for ws, ws
+0003c770: 5f6d 656d 6f72 7920 696e 206d 656d 6f72  _memory in memor
+0003c780: 795f 6279 5f77 6f72 6b65 723a 0a20 2020  y_by_worker:.   
+0003c790: 2020 2020 2020 2020 2069 6620 7773 2e6d           if ws.m
+0003c7a0: 656d 6f72 795f 6c69 6d69 743a 0a20 2020  emory_limit:.   
+0003c7b0: 2020 2020 2020 2020 2020 2020 2068 616c               hal
+0003c7c0: 665f 6761 7020 3d20 696e 7428 7365 6c66  f_gap = int(self
+0003c7d0: 2e4d 454d 4f52 595f 5245 4241 4c41 4e43  .MEMORY_REBALANC
+0003c7e0: 455f 4841 4c46 5f47 4150 202a 2077 732e  E_HALF_GAP * ws.
+0003c7f0: 6d65 6d6f 7279 5f6c 696d 6974 290a 2020  memory_limit).  
+0003c800: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0003c810: 6e64 6572 5f6d 696e 203d 2073 656c 662e  nder_min = self.
+0003c820: 4d45 4d4f 5259 5f52 4542 414c 414e 4345  MEMORY_REBALANCE
+0003c830: 5f53 454e 4445 525f 4d49 4e20 2a20 7773  _SENDER_MIN * ws
+0003c840: 2e6d 656d 6f72 795f 6c69 6d69 740a 2020  .memory_limit.  
+0003c850: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0003c860: 6369 7069 656e 745f 6d61 7820 3d20 7365  cipient_max = se
+0003c870: 6c66 2e4d 454d 4f52 595f 5245 4241 4c41  lf.MEMORY_REBALA
+0003c880: 4e43 455f 5245 4349 5049 454e 545f 4d41  NCE_RECIPIENT_MA
+0003c890: 5820 2a20 7773 2e6d 656d 6f72 795f 6c69  X * ws.memory_li
+0003c8a0: 6d69 740a 2020 2020 2020 2020 2020 2020  mit.            
+0003c8b0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0003c8c0: 2020 2020 2020 6861 6c66 5f67 6170 203d        half_gap =
+0003c8d0: 2030 0a20 2020 2020 2020 2020 2020 2020   0.             
+0003c8e0: 2020 2073 656e 6465 725f 6d69 6e20 3d20     sender_min = 
+0003c8f0: 302e 300a 2020 2020 2020 2020 2020 2020  0.0.            
+0003c900: 2020 2020 7265 6369 7069 656e 745f 6d61      recipient_ma
+0003c910: 7820 3d20 6d61 7468 2e69 6e66 0a0a 2020  x = math.inf..  
+0003c920: 2020 2020 2020 2020 2020 6966 2028 0a20            if (. 
+0003c930: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+0003c940: 732e 5f68 6173 5f77 6861 740a 2020 2020  s._has_what.    
+0003c950: 2020 2020 2020 2020 2020 2020 616e 6420              and 
+0003c960: 7773 5f6d 656d 6f72 7920 3e3d 206d 6561  ws_memory >= mea
+0003c970: 6e5f 6d65 6d6f 7279 202b 2068 616c 665f  n_memory + half_
+0003c980: 6761 700a 2020 2020 2020 2020 2020 2020  gap.            
+0003c990: 2020 2020 616e 6420 7773 5f6d 656d 6f72      and ws_memor
+0003c9a0: 7920 3e3d 2073 656e 6465 725f 6d69 6e0a  y >= sender_min.
+0003c9b0: 2020 2020 2020 2020 2020 2020 293a 0a20              ):. 
+0003c9c0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0003c9d0: 2054 6869 7320 6d61 7920 7365 6e64 2074   This may send t
+0003c9e0: 6865 2077 6f72 6b65 7220 6265 6c6f 7720  he worker below 
+0003c9f0: 7365 6e64 6572 5f6d 696e 2028 6279 2064  sender_min (by d
+0003ca00: 6573 6967 6e29 0a20 2020 2020 2020 2020  esign).         
+0003ca10: 2020 2020 2020 2073 6e64 5f62 7974 6573         snd_bytes
+0003ca20: 5f6d 6178 203d 206d 6561 6e5f 6d65 6d6f  _max = mean_memo
+0003ca30: 7279 202d 2077 735f 6d65 6d6f 7279 2020  ry - ws_memory  
+0003ca40: 2320 6e65 6761 7469 7665 0a20 2020 2020  # negative.     
+0003ca50: 2020 2020 2020 2020 2020 2073 6e64 5f62             snd_b
+0003ca60: 7974 6573 5f6d 696e 203d 2073 6e64 5f62  ytes_min = snd_b
+0003ca70: 7974 6573 5f6d 6178 202b 2068 616c 665f  ytes_max + half_
+0003ca80: 6761 7020 2023 206e 6567 6174 6976 650a  gap  # negative.
+0003ca90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003caa0: 2320 5365 6520 6465 6669 6e69 7469 6f6e  # See definition
+0003cab0: 206f 6620 7365 6e64 6572 7320 6162 6f76   of senders abov
+0003cac0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+0003cad0: 2020 7365 6e64 6572 732e 6170 7065 6e64    senders.append
+0003cae0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0003caf0: 2020 2020 2020 2873 6e64 5f62 7974 6573        (snd_bytes
+0003cb00: 5f6d 6178 2c20 736e 645f 6279 7465 735f  _max, snd_bytes_
+0003cb10: 6d69 6e2c 2069 6428 7773 292c 2077 732c  min, id(ws), ws,
+0003cb20: 2069 7465 7228 7773 2e5f 6861 735f 7768   iter(ws._has_wh
+0003cb30: 6174 2929 0a20 2020 2020 2020 2020 2020  at)).           
+0003cb40: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0003cb50: 2020 2065 6c69 6620 7773 5f6d 656d 6f72     elif ws_memor
+0003cb60: 7920 3c20 6d65 616e 5f6d 656d 6f72 7920  y < mean_memory 
+0003cb70: 2d20 6861 6c66 5f67 6170 2061 6e64 2077  - half_gap and w
+0003cb80: 735f 6d65 6d6f 7279 203c 2072 6563 6970  s_memory < recip
+0003cb90: 6965 6e74 5f6d 6178 3a0a 2020 2020 2020  ient_max:.      
+0003cba0: 2020 2020 2020 2020 2020 2320 5468 6973            # This
+0003cbb0: 206d 6179 2073 656e 6420 7468 6520 776f   may send the wo
+0003cbc0: 726b 6572 2061 626f 7665 2072 6563 6970  rker above recip
+0003cbd0: 6965 6e74 5f6d 6178 2028 6279 2064 6573  ient_max (by des
+0003cbe0: 6967 6e29 0a20 2020 2020 2020 2020 2020  ign).           
+0003cbf0: 2020 2020 2072 6563 5f62 7974 6573 5f6d       rec_bytes_m
+0003cc00: 6178 203d 2077 735f 6d65 6d6f 7279 202d  ax = ws_memory -
+0003cc10: 206d 6561 6e5f 6d65 6d6f 7279 2020 2320   mean_memory  # 
+0003cc20: 6e65 6761 7469 7665 0a20 2020 2020 2020  negative.       
+0003cc30: 2020 2020 2020 2020 2072 6563 5f62 7974           rec_byt
+0003cc40: 6573 5f6d 696e 203d 2072 6563 5f62 7974  es_min = rec_byt
+0003cc50: 6573 5f6d 6178 202b 2068 616c 665f 6761  es_max + half_ga
+0003cc60: 7020 2023 206e 6567 6174 6976 650a 2020  p  # negative.  
+0003cc70: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0003cc80: 5365 6520 6465 6669 6e69 7469 6f6e 206f  See definition o
+0003cc90: 6620 7265 6369 7069 656e 7473 2061 626f  f recipients abo
+0003cca0: 7665 0a20 2020 2020 2020 2020 2020 2020  ve.             
+0003ccb0: 2020 2072 6563 6970 6965 6e74 732e 6170     recipients.ap
+0003ccc0: 7065 6e64 2828 7265 635f 6279 7465 735f  pend((rec_bytes_
+0003ccd0: 6d61 782c 2072 6563 5f62 7974 6573 5f6d  max, rec_bytes_m
+0003cce0: 696e 2c20 6964 2877 7329 2c20 7773 2929  in, id(ws), ws))
+0003ccf0: 0a0a 2020 2020 2020 2020 2320 4661 7374  ..        # Fast
+0003cd00: 2065 7869 7420 696e 2063 6173 6520 6e6f   exit in case no
+0003cd10: 2074 7261 6e73 6665 7273 2061 7265 206e   transfers are n
+0003cd20: 6563 6573 7361 7279 206f 7220 706f 7373  ecessary or poss
+0003cd30: 6962 6c65 0a20 2020 2020 2020 2069 6620  ible.        if 
+0003cd40: 6e6f 7420 7365 6e64 6572 7320 6f72 206e  not senders or n
+0003cd50: 6f74 2072 6563 6970 6965 6e74 733a 0a20  ot recipients:. 
+0003cd60: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0003cd70: 6c6f 675f 6576 656e 7428 0a20 2020 2020  log_event(.     
+0003cd80: 2020 2020 2020 2020 2020 2022 616c 6c22             "all"
+0003cd90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0003cda0: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+0003cdb0: 2020 2020 2020 2020 2261 6374 696f 6e22          "action"
+0003cdc0: 3a20 2272 6562 616c 616e 6365 222c 0a20  : "rebalance",. 
+0003cdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003cde0: 2020 2022 7365 6e64 6572 7322 3a20 6c65     "senders": le
+0003cdf0: 6e28 7365 6e64 6572 7329 2c0a 2020 2020  n(senders),.    
+0003ce00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ce10: 2272 6563 6970 6965 6e74 7322 3a20 6c65  "recipients": le
+0003ce20: 6e28 7265 6369 7069 656e 7473 292c 0a20  n(recipients),. 
+0003ce30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ce40: 2020 2022 6d6f 7665 645f 6b65 7973 223a     "moved_keys":
+0003ce50: 2030 2c0a 2020 2020 2020 2020 2020 2020   0,.            
+0003ce60: 2020 2020 7d2c 0a20 2020 2020 2020 2020      },.         
+0003ce70: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0003ce80: 2072 6574 7572 6e20 5b5d 0a0a 2020 2020   return []..    
+0003ce90: 2020 2020 6865 6170 712e 6865 6170 6966      heapq.heapif
+0003cea0: 7928 7365 6e64 6572 7329 0a20 2020 2020  y(senders).     
+0003ceb0: 2020 2068 6561 7071 2e68 6561 7069 6679     heapq.heapify
+0003cec0: 2872 6563 6970 6965 6e74 7329 0a0a 2020  (recipients)..  
+0003ced0: 2020 2020 2020 7768 696c 6520 7365 6e64        while send
+0003cee0: 6572 7320 616e 6420 7265 6369 7069 656e  ers and recipien
+0003cef0: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
+0003cf00: 736e 645f 6279 7465 735f 6d61 782c 2073  snd_bytes_max, s
+0003cf10: 6e64 5f62 7974 6573 5f6d 696e 2c20 5f2c  nd_bytes_min, _,
+0003cf20: 2073 6e64 5f77 732c 2074 735f 6974 6572   snd_ws, ts_iter
+0003cf30: 203d 2073 656e 6465 7273 5b30 5d0a 0a20   = senders[0].. 
+0003cf40: 2020 2020 2020 2020 2020 2023 2049 7465             # Ite
+0003cf50: 7261 7465 2074 6872 6f75 6768 2074 6173  rate through tas
+0003cf60: 6b73 2069 6e20 6d65 6d6f 7279 2c20 6c65  ks in memory, le
+0003cf70: 6173 7420 7265 6365 6e74 6c79 2069 6e73  ast recently ins
+0003cf80: 6572 7465 6420 6669 7273 740a 2020 2020  erted first.    
+0003cf90: 2020 2020 2020 2020 666f 7220 7473 2069          for ts i
+0003cfa0: 6e20 7473 5f69 7465 723a 0a20 2020 2020  n ts_iter:.     
+0003cfb0: 2020 2020 2020 2020 2020 2069 6620 6b65             if ke
+0003cfc0: 7973 2069 7320 6e6f 7420 4e6f 6e65 2061  ys is not None a
+0003cfd0: 6e64 2074 732e 6b65 7920 6e6f 7420 696e  nd ts.key not in
+0003cfe0: 206b 6579 733a 0a20 2020 2020 2020 2020   keys:.         
+0003cff0: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+0003d000: 6e75 650a 2020 2020 2020 2020 2020 2020  nue.            
+0003d010: 2020 2020 6e62 7974 6573 203d 2074 732e      nbytes = ts.
+0003d020: 6e62 7974 6573 0a20 2020 2020 2020 2020  nbytes.         
+0003d030: 2020 2020 2020 2069 6620 6e62 7974 6573         if nbytes
+0003d040: 202b 2073 6e64 5f62 7974 6573 5f6d 6178   + snd_bytes_max
+0003d050: 203e 2030 3a0a 2020 2020 2020 2020 2020   > 0:.          
+0003d060: 2020 2020 2020 2020 2020 2320 4d6f 7669            # Movi
+0003d070: 6e67 2074 6869 7320 7461 736b 2077 6f75  ng this task wou
+0003d080: 6c64 2063 6175 7365 2074 6865 2073 656e  ld cause the sen
+0003d090: 6465 7220 746f 2067 6f20 6265 6c6f 7720  der to go below 
+0003d0a0: 6d65 616e 2061 6e64 0a20 2020 2020 2020  mean and.       
+0003d0b0: 2020 2020 2020 2020 2020 2020 2023 2070               # p
+0003d0c0: 6f74 656e 7469 616c 6c79 2072 6973 6b20  otentially risk 
+0003d0d0: 6265 636f 6d69 6e67 2061 2072 6563 6970  becoming a recip
+0003d0e0: 6965 6e74 2c20 7768 6963 6820 776f 756c  ient, which woul
+0003d0f0: 6420 6361 7573 6520 7461 736b 7320 746f  d cause tasks to
+0003d100: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003d110: 2020 2020 2023 2062 6f75 6e63 6520 6172       # bounce ar
+0003d120: 6f75 6e64 2e20 4d6f 7665 206f 6e20 746f  ound. Move on to
+0003d130: 2074 6865 206e 6578 7420 7461 736b 206f   the next task o
+0003d140: 6620 7468 6520 7361 6d65 2073 656e 6465  f the same sende
+0003d150: 722e 0a20 2020 2020 2020 2020 2020 2020  r..             
+0003d160: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
+0003d170: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003d180: 2023 2046 696e 6420 7468 6520 7265 6369   # Find the reci
+0003d190: 7069 656e 742c 2066 6172 7468 6573 7420  pient, farthest 
+0003d1a0: 6672 6f6d 2074 6865 206d 6561 6e2c 2077  from the mean, w
+0003d1b0: 6869 6368 0a20 2020 2020 2020 2020 2020  hich.           
+0003d1c0: 2020 2020 2023 2031 2e20 6861 7320 656e       # 1. has en
+0003d1d0: 6f75 6768 2061 7661 696c 6162 6c65 2052  ough available R
+0003d1e0: 414d 2066 6f72 2074 6869 7320 7461 736b  AM for this task
+0003d1f0: 2c20 616e 640a 2020 2020 2020 2020 2020  , and.          
+0003d200: 2020 2020 2020 2320 322e 2064 6f65 736e        # 2. doesn
+0003d210: 2774 2068 6f6c 6420 6120 636f 7079 206f  't hold a copy o
+0003d220: 6620 7468 6973 2074 6173 6b20 616c 7265  f this task alre
+0003d230: 6164 790a 2020 2020 2020 2020 2020 2020  ady.            
+0003d240: 2020 2020 2320 5468 6572 6520 6d61 7920      # There may 
+0003d250: 6e6f 7420 6265 2061 6e79 2074 6861 7420  not be any that 
+0003d260: 7361 7469 7366 6965 7320 7468 6573 6520  satisfies these 
+0003d270: 636f 6e64 6974 696f 6e73 3b20 696e 2074  conditions; in t
+0003d280: 6869 7320 6361 7365 0a20 2020 2020 2020  his case.       
+0003d290: 2020 2020 2020 2020 2023 2074 6869 7320           # this 
+0003d2a0: 7461 736b 2077 6f6e 2774 2062 6520 6d6f  task won't be mo
+0003d2b0: 7665 642e 0a20 2020 2020 2020 2020 2020  ved..           
+0003d2c0: 2020 2020 2073 6b69 7070 6564 5f72 6563       skipped_rec
+0003d2d0: 6970 6965 6e74 7320 3d20 5b5d 0a20 2020  ipients = [].   
+0003d2e0: 2020 2020 2020 2020 2020 2020 2075 7365               use
+0003d2f0: 5f72 6563 6970 6965 6e74 203d 2046 616c  _recipient = Fal
+0003d300: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
+0003d310: 2020 2077 6869 6c65 2072 6563 6970 6965     while recipie
+0003d320: 6e74 7320 616e 6420 6e6f 7420 7573 655f  nts and not use_
+0003d330: 7265 6369 7069 656e 743a 0a20 2020 2020  recipient:.     
+0003d340: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0003d350: 6563 5f62 7974 6573 5f6d 6178 2c20 7265  ec_bytes_max, re
+0003d360: 635f 6279 7465 735f 6d69 6e2c 205f 2c20  c_bytes_min, _, 
+0003d370: 7265 635f 7773 203d 2072 6563 6970 6965  rec_ws = recipie
+0003d380: 6e74 735b 305d 0a20 2020 2020 2020 2020  nts[0].         
+0003d390: 2020 2020 2020 2020 2020 2069 6620 6e62             if nb
+0003d3a0: 7974 6573 202b 2072 6563 5f62 7974 6573  ytes + rec_bytes
+0003d3b0: 5f6d 6178 203e 2030 3a0a 2020 2020 2020  _max > 0:.      
+0003d3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d3d0: 2020 2320 7265 6369 7069 656e 7473 2061    # recipients a
+0003d3e0: 7265 2073 6f72 7465 6420 6279 2072 6563  re sorted by rec
+0003d3f0: 5f62 7974 6573 5f6d 6178 2e0a 2020 2020  _bytes_max..    
+0003d400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d410: 2020 2020 2320 5468 6520 6e65 7874 206f      # The next o
+0003d420: 6e65 7320 7769 6c6c 2062 6520 776f 7273  nes will be wors
+0003d430: 653b 206e 6f20 7265 6173 6f6e 2074 6f20  e; no reason to 
+0003d440: 636f 6e74 696e 7565 2069 7465 7261 7469  continue iterati
+0003d450: 6e67 0a20 2020 2020 2020 2020 2020 2020  ng.             
+0003d460: 2020 2020 2020 2020 2020 2062 7265 616b             break
+0003d470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003d480: 2020 2020 2075 7365 5f72 6563 6970 6965       use_recipie
+0003d490: 6e74 203d 2074 7320 6e6f 7420 696e 2072  nt = ts not in r
+0003d4a0: 6563 5f77 732e 5f68 6173 5f77 6861 740a  ec_ws._has_what.
+0003d4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d4c0: 2020 2020 6966 206e 6f74 2075 7365 5f72      if not use_r
+0003d4d0: 6563 6970 6965 6e74 3a0a 2020 2020 2020  ecipient:.      
+0003d4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d4f0: 2020 736b 6970 7065 645f 7265 6369 7069    skipped_recipi
+0003d500: 656e 7473 2e61 7070 656e 6428 6865 6170  ents.append(heap
+0003d510: 712e 6865 6170 706f 7028 7265 6369 7069  q.heappop(recipi
+0003d520: 656e 7473 2929 0a0a 2020 2020 2020 2020  ents))..        
+0003d530: 2020 2020 2020 2020 666f 7220 7265 6369          for reci
+0003d540: 7069 656e 7420 696e 2073 6b69 7070 6564  pient in skipped
+0003d550: 5f72 6563 6970 6965 6e74 733a 0a20 2020  _recipients:.   
+0003d560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d570: 2068 6561 7071 2e68 6561 7070 7573 6828   heapq.heappush(
+0003d580: 7265 6369 7069 656e 7473 2c20 7265 6369  recipients, reci
+0003d590: 7069 656e 7429 0a0a 2020 2020 2020 2020  pient)..        
+0003d5a0: 2020 2020 2020 2020 6966 206e 6f74 2075          if not u
+0003d5b0: 7365 5f72 6563 6970 6965 6e74 3a0a 2020  se_recipient:.  
+0003d5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d5d0: 2020 2320 5468 6973 2074 6173 6b20 6861    # This task ha
+0003d5e0: 7320 6e6f 2072 6563 6970 6965 6e74 7320  s no recipients 
+0003d5f0: 6176 6169 6c61 626c 652e 204c 6561 7665  available. Leave
+0003d600: 2069 7420 6f6e 2074 6865 2073 656e 6465   it on the sende
+0003d610: 7220 616e 640a 2020 2020 2020 2020 2020  r and.          
+0003d620: 2020 2020 2020 2020 2020 2320 6d6f 7665            # move
+0003d630: 206f 6e20 746f 2074 6865 206e 6578 7420   on to the next 
+0003d640: 7461 736b 206f 6620 7468 6520 7361 6d65  task of the same
+0003d650: 2073 656e 6465 722e 0a20 2020 2020 2020   sender..       
+0003d660: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0003d670: 7469 6e75 650a 0a20 2020 2020 2020 2020  tinue..         
+0003d680: 2020 2020 2020 2023 2053 6368 6564 756c         # Schedul
+0003d690: 6520 7461 736b 2066 6f72 2074 7261 6e73  e task for trans
+0003d6a0: 6665 7220 6672 6f6d 2073 656e 6465 7220  fer from sender 
+0003d6b0: 746f 2072 6563 6970 6965 6e74 0a20 2020  to recipient.   
+0003d6c0: 2020 2020 2020 2020 2020 2020 206d 7367               msg
+0003d6d0: 732e 6170 7065 6e64 2828 736e 645f 7773  s.append((snd_ws
+0003d6e0: 2c20 7265 635f 7773 2c20 7473 2929 0a0a  , rec_ws, ts))..
+0003d6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d700: 2320 2a5f 6279 7465 735f 6d61 782f 6d69  # *_bytes_max/mi
+0003d710: 6e20 6172 6520 616c 6c20 6e65 6761 7469  n are all negati
+0003d720: 7665 2066 6f72 2068 6561 7020 736f 7274  ve for heap sort
+0003d730: 696e 670a 2020 2020 2020 2020 2020 2020  ing.            
+0003d740: 2020 2020 736e 645f 6279 7465 735f 6d61      snd_bytes_ma
+0003d750: 7820 2b3d 206e 6279 7465 730a 2020 2020  x += nbytes.    
+0003d760: 2020 2020 2020 2020 2020 2020 736e 645f              snd_
+0003d770: 6279 7465 735f 6d69 6e20 2b3d 206e 6279  bytes_min += nby
+0003d780: 7465 730a 2020 2020 2020 2020 2020 2020  tes.            
+0003d790: 2020 2020 7265 635f 6279 7465 735f 6d61      rec_bytes_ma
+0003d7a0: 7820 2b3d 206e 6279 7465 730a 2020 2020  x += nbytes.    
+0003d7b0: 2020 2020 2020 2020 2020 2020 7265 635f              rec_
+0003d7c0: 6279 7465 735f 6d69 6e20 2b3d 206e 6279  bytes_min += nby
+0003d7d0: 7465 730a 0a20 2020 2020 2020 2020 2020  tes..           
+0003d7e0: 2020 2020 2023 2053 746f 7020 6974 6572       # Stop iter
+0003d7f0: 6174 696e 6720 6f6e 2074 6865 2074 6173  ating on the tas
+0003d800: 6b73 206f 6620 7468 6973 2073 656e 6465  ks of this sende
+0003d810: 7220 666f 7220 6e6f 7720 616e 642c 2069  r for now and, i
+0003d820: 6620 6974 2073 7469 6c6c 0a20 2020 2020  f it still.     
+0003d830: 2020 2020 2020 2020 2020 2023 2068 6173             # has
+0003d840: 2062 7974 6573 2074 6f20 6c6f 7365 2c20   bytes to lose, 
+0003d850: 7075 7368 2069 7420 6261 636b 2069 6e74  push it back int
+0003d860: 6f20 7468 6520 7365 6e64 6572 7320 6865  o the senders he
+0003d870: 6170 3b20 6974 206d 6179 206f 7220 6d61  ap; it may or ma
+0003d880: 790a 2020 2020 2020 2020 2020 2020 2020  y.              
+0003d890: 2020 2320 6e6f 7420 636f 6d65 2062 6163    # not come bac
+0003d8a0: 6b20 6f6e 2074 6f70 2061 6761 696e 2e0a  k on top again..
+0003d8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d8c0: 6966 2073 6e64 5f62 7974 6573 5f6d 696e  if snd_bytes_min
+0003d8d0: 203c 2030 3a0a 2020 2020 2020 2020 2020   < 0:.          
+0003d8e0: 2020 2020 2020 2020 2020 2320 5365 6520            # See 
+0003d8f0: 6465 6669 6e69 7469 6f6e 206f 6620 7365  definition of se
+0003d900: 6e64 6572 7320 6162 6f76 650a 2020 2020  nders above.    
+0003d910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d920: 6865 6170 712e 6865 6170 7265 706c 6163  heapq.heapreplac
+0003d930: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
+0003d940: 2020 2020 2020 2020 2020 2073 656e 6465             sende
+0003d950: 7273 2c0a 2020 2020 2020 2020 2020 2020  rs,.            
+0003d960: 2020 2020 2020 2020 2020 2020 2873 6e64              (snd
+0003d970: 5f62 7974 6573 5f6d 6178 2c20 736e 645f  _bytes_max, snd_
+0003d980: 6279 7465 735f 6d69 6e2c 2069 6428 736e  bytes_min, id(sn
+0003d990: 645f 7773 292c 2073 6e64 5f77 732c 2074  d_ws), snd_ws, t
+0003d9a0: 735f 6974 6572 292c 0a20 2020 2020 2020  s_iter),.       
+0003d9b0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+0003d9c0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0003d9d0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0003d9e0: 2020 2020 2020 2020 2068 6561 7071 2e68           heapq.h
+0003d9f0: 6561 7070 6f70 2873 656e 6465 7273 290a  eappop(senders).
+0003da00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003da10: 2023 2049 6620 7265 6369 7069 656e 7420   # If recipient 
+0003da20: 7374 696c 6c20 6861 7320 6279 7465 7320  still has bytes 
+0003da30: 746f 2067 6169 6e2c 2070 7573 6820 6974  to gain, push it
+0003da40: 2062 6163 6b20 696e 746f 2074 6865 2072   back into the r
+0003da50: 6563 6970 6965 6e74 730a 2020 2020 2020  ecipients.      
+0003da60: 2020 2020 2020 2020 2020 2320 6865 6170            # heap
+0003da70: 3b20 6974 206d 6179 206f 7220 6d61 7920  ; it may or may 
+0003da80: 6e6f 7420 636f 6d65 2062 6163 6b20 6f6e  not come back on
+0003da90: 2074 6f70 2061 6761 696e 2e0a 2020 2020   top again..    
+0003daa0: 2020 2020 2020 2020 2020 2020 6966 2072              if r
+0003dab0: 6563 5f62 7974 6573 5f6d 696e 203c 2030  ec_bytes_min < 0
+0003dac0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003dad0: 2020 2020 2020 2320 5365 6520 6465 6669        # See defi
+0003dae0: 6e69 7469 6f6e 206f 6620 7265 6369 7069  nition of recipi
+0003daf0: 656e 7473 2061 626f 7665 0a20 2020 2020  ents above.     
+0003db00: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+0003db10: 6561 7071 2e68 6561 7072 6570 6c61 6365  eapq.heapreplace
+0003db20: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0003db30: 2020 2020 2020 2020 2020 7265 6369 7069            recipi
+0003db40: 656e 7473 2c0a 2020 2020 2020 2020 2020  ents,.          
+0003db50: 2020 2020 2020 2020 2020 2020 2020 2872                (r
+0003db60: 6563 5f62 7974 6573 5f6d 6178 2c20 7265  ec_bytes_max, re
+0003db70: 635f 6279 7465 735f 6d69 6e2c 2069 6428  c_bytes_min, id(
+0003db80: 7265 635f 7773 292c 2072 6563 5f77 7329  rec_ws), rec_ws)
+0003db90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0003dba0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0003dbb0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0003dbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003dbd0: 2020 6865 6170 712e 6865 6170 706f 7028    heapq.heappop(
+0003dbe0: 7265 6369 7069 656e 7473 290a 0a20 2020  recipients)..   
+0003dbf0: 2020 2020 2020 2020 2020 2020 2023 204d               # M
+0003dc00: 6f76 6520 746f 206e 6578 7420 7365 6e64  ove to next send
+0003dc10: 6572 2077 6974 6820 7468 6520 6d6f 7374  er with the most
+0003dc20: 2064 6174 6120 746f 206c 6f73 652e 0a20   data to lose.. 
+0003dc30: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0003dc40: 2049 7420 6d61 7920 6f72 206d 6179 206e   It may or may n
+0003dc50: 6f74 2062 6520 7468 6520 7361 6d65 2073  ot be the same s
+0003dc60: 656e 6465 7220 6167 6169 6e2e 0a20 2020  ender again..   
+0003dc70: 2020 2020 2020 2020 2020 2020 2062 7265               bre
+0003dc80: 616b 0a0a 2020 2020 2020 2020 2020 2020  ak..            
+0003dc90: 656c 7365 3a20 2023 2066 6f72 2074 7320  else:  # for ts 
+0003dca0: 696e 2074 735f 6974 6572 0a20 2020 2020  in ts_iter.     
+0003dcb0: 2020 2020 2020 2020 2020 2023 2045 7868             # Exh
+0003dcc0: 6175 7374 6564 2074 6173 6b73 206f 6e20  austed tasks on 
+0003dcd0: 7468 6973 2073 656e 6465 720a 2020 2020  this sender.    
+0003dce0: 2020 2020 2020 2020 2020 2020 6865 6170              heap
+0003dcf0: 712e 6865 6170 706f 7028 7365 6e64 6572  q.heappop(sender
+0003dd00: 7329 0a0a 2020 2020 2020 2020 7265 7475  s)..        retu
+0003dd10: 726e 206d 7367 730a 0a20 2020 2061 7379  rn msgs..    asy
+0003dd20: 6e63 2064 6566 205f 7265 6261 6c61 6e63  nc def _rebalanc
+0003dd30: 655f 6d6f 7665 5f64 6174 6128 0a20 2020  e_move_data(.   
+0003dd40: 2020 2020 2073 656c 662c 206d 7367 733a       self, msgs:
+0003dd50: 206c 6973 745b 7475 706c 655b 576f 726b   list[tuple[Work
+0003dd60: 6572 5374 6174 652c 2057 6f72 6b65 7253  erState, WorkerS
+0003dd70: 7461 7465 2c20 5461 736b 5374 6174 655d  tate, TaskState]
+0003dd80: 5d2c 2073 7469 6d75 6c75 735f 6964 3a20  ], stimulus_id: 
+0003dd90: 7374 720a 2020 2020 2920 2d3e 2064 6963  str.    ) -> dic
+0003dda0: 743a 0a20 2020 2020 2020 2022 2222 5065  t:.        """Pe
+0003ddb0: 7266 6f72 6d20 7468 6520 6163 7475 616c  rform the actual
+0003ddc0: 2074 7261 6e73 6665 7220 6f66 2064 6174   transfer of dat
+0003ddd0: 6120 6163 726f 7373 2074 6865 206e 6574  a across the net
+0003dde0: 776f 726b 2069 6e20 7265 6261 6c61 6e63  work in rebalanc
+0003ddf0: 6528 292e 0a20 2020 2020 2020 2054 616b  e()..        Tak
+0003de00: 6573 2069 6e20 696e 7075 7420 7468 6520  es in input the 
+0003de10: 6f75 7470 7574 206f 6620 5f72 6562 616c  output of _rebal
+0003de20: 616e 6365 5f66 696e 645f 6d73 6773 2829  ance_find_msgs()
+0003de30: 2c20 7468 6174 2069 7320 6120 6c69 7374  , that is a list
+0003de40: 206f 6620 7475 706c 6573 3a0a 0a20 2020   of tuples:..   
+0003de50: 2020 2020 202d 2073 656e 6465 7220 776f       - sender wo
+0003de60: 726b 6572 0a20 2020 2020 2020 202d 2072  rker.        - r
+0003de70: 6563 6970 6965 6e74 2077 6f72 6b65 720a  ecipient worker.
+0003de80: 2020 2020 2020 2020 2d20 7461 736b 2074          - task t
+0003de90: 6f20 6265 2074 7261 6e73 6665 7272 6564  o be transferred
+0003dea0: 0a0a 2020 2020 2020 2020 4649 584d 4520  ..        FIXME 
+0003deb0: 7468 6973 206d 6574 686f 6420 6973 206e  this method is n
+0003dec0: 6f74 2072 6f62 7573 7420 7768 656e 2074  ot robust when t
+0003ded0: 6865 2063 6c75 7374 6572 2069 7320 6e6f  he cluster is no
+0003dee0: 7420 6964 6c65 2e0a 2020 2020 2020 2020  t idle..        
+0003def0: 2222 220a 2020 2020 2020 2020 2320 7b72  """.        # {r
+0003df00: 6563 6970 6965 6e74 2061 6464 7265 7373  ecipient address
+0003df10: 3a20 7b6b 6579 3a20 5b73 656e 6465 7220  : {key: [sender 
+0003df20: 6164 6472 6573 732c 202e 2e2e 5d7d 7d0a  address, ...]}}.
+0003df30: 2020 2020 2020 2020 746f 5f72 6563 6970          to_recip
+0003df40: 6965 6e74 733a 2064 6566 6175 6c74 6469  ients: defaultdi
+0003df50: 6374 5b73 7472 2c20 6465 6661 756c 7464  ct[str, defaultd
+0003df60: 6963 745b 4b65 792c 206c 6973 745b 7374  ict[Key, list[st
+0003df70: 725d 5d5d 203d 2064 6566 6175 6c74 6469  r]]] = defaultdi
+0003df80: 6374 280a 2020 2020 2020 2020 2020 2020  ct(.            
+0003df90: 6c61 6d62 6461 3a20 6465 6661 756c 7464  lambda: defaultd
+0003dfa0: 6963 7428 6c69 7374 290a 2020 2020 2020  ict(list).      
+0003dfb0: 2020 290a 2020 2020 2020 2020 666f 7220    ).        for 
+0003dfc0: 736e 645f 7773 2c20 7265 635f 7773 2c20  snd_ws, rec_ws, 
+0003dfd0: 7473 2069 6e20 6d73 6773 3a0a 2020 2020  ts in msgs:.    
+0003dfe0: 2020 2020 2020 2020 746f 5f72 6563 6970          to_recip
+0003dff0: 6965 6e74 735b 7265 635f 7773 2e61 6464  ients[rec_ws.add
+0003e000: 7265 7373 5d5b 7473 2e6b 6579 5d2e 6170  ress][ts.key].ap
+0003e010: 7065 6e64 2873 6e64 5f77 732e 6164 6472  pend(snd_ws.addr
+0003e020: 6573 7329 0a20 2020 2020 2020 2066 6169  ess).        fai
+0003e030: 6c65 645f 6b65 7973 5f62 795f 7265 6369  led_keys_by_reci
+0003e040: 7069 656e 7420 3d20 6469 6374 280a 2020  pient = dict(.  
+0003e050: 2020 2020 2020 2020 2020 7a69 7028 0a20            zip(. 
+0003e060: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0003e070: 6f5f 7265 6369 7069 656e 7473 2c0a 2020  o_recipients,.  
+0003e080: 2020 2020 2020 2020 2020 2020 2020 6177                aw
+0003e090: 6169 7420 6173 796e 6369 6f2e 6761 7468  ait asyncio.gath
+0003e0a0: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
+0003e0b0: 2020 2020 2020 2020 2a28 0a20 2020 2020          *(.     
+0003e0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e0d0: 2020 2023 204e 6f74 653a 2074 6869 7320     # Note: this 
+0003e0e0: 6e65 7665 7220 7261 6973 6573 2065 7863  never raises exc
+0003e0f0: 6570 7469 6f6e 730a 2020 2020 2020 2020  eptions.        
+0003e100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e110: 7365 6c66 2e67 6174 6865 725f 6f6e 5f77  self.gather_on_w
+0003e120: 6f72 6b65 7228 772c 2077 686f 5f68 6173  orker(w, who_has
+0003e130: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0003e140: 2020 2020 2020 2020 2020 666f 7220 772c            for w,
+0003e150: 2077 686f 5f68 6173 2069 6e20 746f 5f72   who_has in to_r
+0003e160: 6563 6970 6965 6e74 732e 6974 656d 7328  ecipients.items(
+0003e170: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0003e180: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0003e190: 2020 2020 2020 2020 292c 0a20 2020 2020          ),.     
+0003e1a0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0003e1b0: 2029 0a0a 2020 2020 2020 2020 746f 5f73   )..        to_s
+0003e1c0: 656e 6465 7273 203d 2064 6566 6175 6c74  enders = default
+0003e1d0: 6469 6374 286c 6973 7429 0a20 2020 2020  dict(list).     
+0003e1e0: 2020 2066 6f72 2073 6e64 5f77 732c 2072     for snd_ws, r
+0003e1f0: 6563 5f77 732c 2074 7320 696e 206d 7367  ec_ws, ts in msg
+0003e200: 733a 0a20 2020 2020 2020 2020 2020 2069  s:.            i
+0003e210: 6620 7473 2e6b 6579 206e 6f74 2069 6e20  f ts.key not in 
+0003e220: 6661 696c 6564 5f6b 6579 735f 6279 5f72  failed_keys_by_r
+0003e230: 6563 6970 6965 6e74 5b72 6563 5f77 732e  ecipient[rec_ws.
+0003e240: 6164 6472 6573 735d 3a0a 2020 2020 2020  address]:.      
+0003e250: 2020 2020 2020 2020 2020 746f 5f73 656e            to_sen
+0003e260: 6465 7273 5b73 6e64 5f77 732e 6164 6472  ders[snd_ws.addr
+0003e270: 6573 735d 2e61 7070 656e 6428 7473 2e6b  ess].append(ts.k
+0003e280: 6579 290a 0a20 2020 2020 2020 2023 204e  ey)..        # N
+0003e290: 6f74 653a 2074 6869 7320 6e65 7665 7220  ote: this never 
+0003e2a0: 7261 6973 6573 2065 7863 6570 7469 6f6e  raises exception
+0003e2b0: 730a 2020 2020 2020 2020 6177 6169 7420  s.        await 
+0003e2c0: 6173 796e 6369 6f2e 6761 7468 6572 280a  asyncio.gather(.
+0003e2d0: 2020 2020 2020 2020 2020 2020 2a28 7365              *(se
+0003e2e0: 6c66 2e64 656c 6574 655f 776f 726b 6572  lf.delete_worker
+0003e2f0: 5f64 6174 6128 722c 2076 2c20 7374 696d  _data(r, v, stim
+0003e300: 756c 7573 5f69 6429 2066 6f72 2072 2c20  ulus_id) for r, 
+0003e310: 7620 696e 2074 6f5f 7365 6e64 6572 732e  v in to_senders.
+0003e320: 6974 656d 7328 2929 0a20 2020 2020 2020  items()).       
+0003e330: 2029 0a0a 2020 2020 2020 2020 666f 7220   )..        for 
+0003e340: 722c 2076 2069 6e20 746f 5f72 6563 6970  r, v in to_recip
+0003e350: 6965 6e74 732e 6974 656d 7328 293a 0a20  ients.items():. 
+0003e360: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0003e370: 6c6f 675f 6576 656e 7428 722c 207b 2261  log_event(r, {"a
+0003e380: 6374 696f 6e22 3a20 2272 6562 616c 616e  ction": "rebalan
+0003e390: 6365 222c 2022 7768 6f5f 6861 7322 3a20  ce", "who_has": 
+0003e3a0: 767d 290a 2020 2020 2020 2020 7365 6c66  v}).        self
+0003e3b0: 2e6c 6f67 5f65 7665 6e74 280a 2020 2020  .log_event(.    
+0003e3c0: 2020 2020 2020 2020 2261 6c6c 222c 0a20          "all",. 
+0003e3d0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+0003e3e0: 2020 2020 2020 2020 2020 2020 2022 6163               "ac
+0003e3f0: 7469 6f6e 223a 2022 7265 6261 6c61 6e63  tion": "rebalanc
+0003e400: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
+0003e410: 2020 2020 2273 656e 6465 7273 223a 2076      "senders": v
+0003e420: 616c 6d61 7028 6c65 6e2c 2074 6f5f 7365  almap(len, to_se
+0003e430: 6e64 6572 7329 2c0a 2020 2020 2020 2020  nders),.        
+0003e440: 2020 2020 2020 2020 2272 6563 6970 6965          "recipie
+0003e450: 6e74 7322 3a20 7661 6c6d 6170 286c 656e  nts": valmap(len
+0003e460: 2c20 746f 5f72 6563 6970 6965 6e74 7329  , to_recipients)
+0003e470: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0003e480: 2020 226d 6f76 6564 5f6b 6579 7322 3a20    "moved_keys": 
+0003e490: 6c65 6e28 6d73 6773 292c 0a20 2020 2020  len(msgs),.     
+0003e4a0: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
+0003e4b0: 2020 290a 0a20 2020 2020 2020 206d 6973    )..        mis
+0003e4c0: 7369 6e67 5f6b 6579 7320 3d20 7b6b 2066  sing_keys = {k f
+0003e4d0: 6f72 2072 2069 6e20 6661 696c 6564 5f6b  or r in failed_k
+0003e4e0: 6579 735f 6279 5f72 6563 6970 6965 6e74  eys_by_recipient
+0003e4f0: 2e76 616c 7565 7328 2920 666f 7220 6b20  .values() for k 
+0003e500: 696e 2072 7d0a 2020 2020 2020 2020 6966  in r}.        if
+0003e510: 206d 6973 7369 6e67 5f6b 6579 733a 0a20   missing_keys:. 
+0003e520: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0003e530: 6e20 7b22 7374 6174 7573 223a 2022 7061  n {"status": "pa
+0003e540: 7274 6961 6c2d 6661 696c 222c 2022 6b65  rtial-fail", "ke
+0003e550: 7973 223a 206c 6973 7428 6d69 7373 696e  ys": list(missin
+0003e560: 675f 6b65 7973 297d 0a20 2020 2020 2020  g_keys)}.       
+0003e570: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0003e580: 2020 2072 6574 7572 6e20 7b22 7374 6174     return {"stat
+0003e590: 7573 223a 2022 4f4b 227d 0a0a 2020 2020  us": "OK"}..    
+0003e5a0: 6173 796e 6320 6465 6620 7265 706c 6963  async def replic
+0003e5b0: 6174 6528 0a20 2020 2020 2020 2073 656c  ate(.        sel
+0003e5c0: 662c 0a20 2020 2020 2020 2063 6f6d 6d3d  f,.        comm=
+0003e5d0: 4e6f 6e65 2c0a 2020 2020 2020 2020 6b65  None,.        ke
+0003e5e0: 7973 3d4e 6f6e 652c 0a20 2020 2020 2020  ys=None,.       
+0003e5f0: 206e 3d4e 6f6e 652c 0a20 2020 2020 2020   n=None,.       
+0003e600: 2077 6f72 6b65 7273 3d4e 6f6e 652c 0a20   workers=None,. 
+0003e610: 2020 2020 2020 2062 7261 6e63 6869 6e67         branching
+0003e620: 5f66 6163 746f 723d 322c 0a20 2020 2020  _factor=2,.     
+0003e630: 2020 2064 656c 6574 653d 5472 7565 2c0a     delete=True,.
+0003e640: 2020 2020 2020 2020 7374 696d 756c 7573          stimulus
+0003e650: 5f69 643d 4e6f 6e65 2c0a 2020 2020 293a  _id=None,.    ):
+0003e660: 0a20 2020 2020 2020 2022 2222 5265 706c  .        """Repl
+0003e670: 6963 6174 6520 6461 7461 2074 6872 6f75  icate data throu
+0003e680: 6768 6f75 7420 636c 7573 7465 720a 0a20  ghout cluster.. 
+0003e690: 2020 2020 2020 2054 6869 7320 7065 7266         This perf
+0003e6a0: 6f72 6d73 2061 2074 7265 6520 636f 7079  orms a tree copy
+0003e6b0: 206f 6620 7468 6520 6461 7461 2074 6872   of the data thr
+0003e6c0: 6f75 6768 6f75 7420 7468 6520 6e65 7477  oughout the netw
+0003e6d0: 6f72 6b0a 2020 2020 2020 2020 696e 6469  ork.        indi
+0003e6e0: 7669 6475 616c 6c79 206f 6e20 6561 6368  vidually on each
+0003e6f0: 2070 6965 6365 206f 6620 6461 7461 2e0a   piece of data..
+0003e700: 0a20 2020 2020 2020 2050 6172 616d 6574  .        Paramet
+0003e710: 6572 730a 2020 2020 2020 2020 2d2d 2d2d  ers.        ----
+0003e720: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 206b  ------.        k
+0003e730: 6579 733a 2049 7465 7261 626c 650a 2020  eys: Iterable.  
+0003e740: 2020 2020 2020 2020 2020 6c69 7374 206f            list o
+0003e750: 6620 6b65 7973 2074 6f20 7265 706c 6963  f keys to replic
+0003e760: 6174 650a 2020 2020 2020 2020 6e3a 2069  ate.        n: i
+0003e770: 6e74 0a20 2020 2020 2020 2020 2020 204e  nt.            N
+0003e780: 756d 6265 7220 6f66 2072 6570 6c69 6361  umber of replica
+0003e790: 7469 6f6e 7320 7765 2065 7870 6563 7420  tions we expect 
+0003e7a0: 746f 2073 6565 2077 6974 6869 6e20 7468  to see within th
+0003e7b0: 6520 636c 7573 7465 720a 2020 2020 2020  e cluster.      
+0003e7c0: 2020 6272 616e 6368 696e 675f 6661 6374    branching_fact
+0003e7d0: 6f72 3a20 696e 742c 206f 7074 696f 6e61  or: int, optiona
+0003e7e0: 6c0a 2020 2020 2020 2020 2020 2020 5468  l.            Th
+0003e7f0: 6520 6e75 6d62 6572 206f 6620 776f 726b  e number of work
+0003e800: 6572 7320 7468 6174 2063 616e 2063 6f70  ers that can cop
+0003e810: 7920 6461 7461 2069 6e20 6561 6368 2067  y data in each g
+0003e820: 656e 6572 6174 696f 6e2e 0a20 2020 2020  eneration..     
+0003e830: 2020 2020 2020 2054 6865 206c 6172 6765         The large
+0003e840: 7220 7468 6520 6272 616e 6368 696e 6720  r the branching 
+0003e850: 6661 6374 6f72 2c20 7468 6520 6d6f 7265  factor, the more
+0003e860: 2064 6174 6120 7765 2063 6f70 7920 696e   data we copy in
+0003e870: 0a20 2020 2020 2020 2020 2020 2061 2073  .            a s
+0003e880: 696e 676c 6520 7374 6570 2c20 6275 7420  ingle step, but 
+0003e890: 7468 6520 6d6f 7265 2061 2067 6976 656e  the more a given
+0003e8a0: 2077 6f72 6b65 7220 7269 736b 7320 6265   worker risks be
+0003e8b0: 696e 670a 2020 2020 2020 2020 2020 2020  ing.            
+0003e8c0: 7377 616d 7065 6420 6279 2064 6174 6120  swamped by data 
+0003e8d0: 7265 7175 6573 7473 2e0a 0a20 2020 2020  requests...     
+0003e8e0: 2020 2053 6565 2061 6c73 6f0a 2020 2020     See also.    
+0003e8f0: 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020      --------.   
+0003e900: 2020 2020 2053 6368 6564 756c 6572 2e72       Scheduler.r
+0003e910: 6562 616c 616e 6365 0a20 2020 2020 2020  ebalance.       
+0003e920: 2022 2222 0a20 2020 2020 2020 2073 7469   """.        sti
+0003e930: 6d75 6c75 735f 6964 203d 2073 7469 6d75  mulus_id = stimu
+0003e940: 6c75 735f 6964 206f 7220 6622 7265 706c  lus_id or f"repl
+0003e950: 6963 6174 652d 7b74 696d 6528 297d 220a  icate-{time()}".
+0003e960: 2020 2020 2020 2020 6173 7365 7274 2062          assert b
+0003e970: 7261 6e63 6869 6e67 5f66 6163 746f 7220  ranching_factor 
+0003e980: 3e20 300a 2020 2020 2020 2020 2320 446f  > 0.        # Do
+0003e990: 776e 6772 6164 6520 7265 656e 7472 616e  wngrade reentran
+0003e9a0: 7420 6c6f 636b 2074 6f20 6e6f 6e2d 7265  t lock to non-re
+0003e9b0: 656e 7472 616e 740a 2020 2020 2020 2020  entrant.        
+0003e9c0: 6173 796e 6320 7769 7468 2073 656c 662e  async with self.
+0003e9d0: 5f72 6570 6c69 6361 5f6c 6f63 6b28 2822  _replica_lock(("
+0003e9e0: 7265 706c 6963 6174 6522 2c20 6f62 6a65  replicate", obje
+0003e9f0: 6374 2829 2929 3a0a 2020 2020 2020 2020  ct())):.        
+0003ea00: 2020 2020 6966 2077 6f72 6b65 7273 2069      if workers i
+0003ea10: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+0003ea20: 2020 2020 2020 2020 2020 2020 776f 726b              work
+0003ea30: 6572 7320 3d20 7b73 656c 662e 776f 726b  ers = {self.work
+0003ea40: 6572 735b 775d 2066 6f72 2077 2069 6e20  ers[w] for w in 
+0003ea50: 7365 6c66 2e77 6f72 6b65 7273 5f6c 6973  self.workers_lis
+0003ea60: 7428 776f 726b 6572 7329 7d0a 2020 2020  t(workers)}.    
+0003ea70: 2020 2020 2020 2020 2020 2020 776f 726b              work
+0003ea80: 6572 7320 3d20 7b77 7320 666f 7220 7773  ers = {ws for ws
+0003ea90: 2069 6e20 776f 726b 6572 7320 6966 2077   in workers if w
+0003eaa0: 732e 7374 6174 7573 203d 3d20 5374 6174  s.status == Stat
+0003eab0: 7573 2e72 756e 6e69 6e67 7d0a 2020 2020  us.running}.    
+0003eac0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0003ead0: 2020 2020 2020 2020 2020 2020 2020 776f                wo
+0003eae0: 726b 6572 7320 3d20 7365 6c66 2e72 756e  rkers = self.run
+0003eaf0: 6e69 6e67 0a0a 2020 2020 2020 2020 2020  ning..          
+0003eb00: 2020 6966 206e 2069 7320 4e6f 6e65 3a0a    if n is None:.
+0003eb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003eb20: 6e20 3d20 6c65 6e28 776f 726b 6572 7329  n = len(workers)
+0003eb30: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+0003eb40: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0003eb50: 2020 206e 203d 206d 696e 286e 2c20 6c65     n = min(n, le
+0003eb60: 6e28 776f 726b 6572 7329 290a 2020 2020  n(workers)).    
+0003eb70: 2020 2020 2020 2020 6966 206e 203d 3d20          if n == 
+0003eb80: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+0003eb90: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+0003eba0: 726f 7228 2243 616e 206e 6f74 2075 7365  ror("Can not use
+0003ebb0: 2072 6570 6c69 6361 7465 2074 6f20 6465   replicate to de
+0003ebc0: 6c65 7465 2064 6174 6122 290a 0a20 2020  lete data")..   
+0003ebd0: 2020 2020 2020 2020 2074 6173 6b73 203d           tasks =
+0003ebe0: 207b 7365 6c66 2e74 6173 6b73 5b6b 5d20   {self.tasks[k] 
+0003ebf0: 666f 7220 6b20 696e 206b 6579 737d 0a20  for k in keys}. 
+0003ec00: 2020 2020 2020 2020 2020 206d 6973 7369             missi
+0003ec10: 6e67 5f64 6174 6120 3d20 5b74 732e 6b65  ng_data = [ts.ke
+0003ec20: 7920 666f 7220 7473 2069 6e20 7461 736b  y for ts in task
+0003ec30: 7320 6966 206e 6f74 2074 732e 7768 6f5f  s if not ts.who_
+0003ec40: 6861 735d 0a20 2020 2020 2020 2020 2020  has].           
+0003ec50: 2069 6620 6d69 7373 696e 675f 6461 7461   if missing_data
+0003ec60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003ec70: 2020 7265 7475 726e 207b 2273 7461 7475    return {"statu
+0003ec80: 7322 3a20 2270 6172 7469 616c 2d66 6169  s": "partial-fai
+0003ec90: 6c22 2c20 226b 6579 7322 3a20 6d69 7373  l", "keys": miss
+0003eca0: 696e 675f 6461 7461 7d0a 0a20 2020 2020  ing_data}..     
+0003ecb0: 2020 2020 2020 2023 2044 656c 6574 6520         # Delete 
+0003ecc0: 6578 7472 616e 656f 7573 2064 6174 610a  extraneous data.
+0003ecd0: 2020 2020 2020 2020 2020 2020 6966 2064              if d
+0003ece0: 656c 6574 653a 0a20 2020 2020 2020 2020  elete:.         
+0003ecf0: 2020 2020 2020 2064 656c 5f77 6f72 6b65         del_worke
+0003ed00: 725f 7461 736b 7320 3d20 6465 6661 756c  r_tasks = defaul
+0003ed10: 7464 6963 7428 7365 7429 0a20 2020 2020  tdict(set).     
+0003ed20: 2020 2020 2020 2020 2020 2066 6f72 2074             for t
+0003ed30: 7320 696e 2074 6173 6b73 3a0a 2020 2020  s in tasks:.    
+0003ed40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ed50: 6465 6c5f 6361 6e64 6964 6174 6573 203d  del_candidates =
+0003ed60: 2074 7570 6c65 2874 732e 7768 6f5f 6861   tuple(ts.who_ha
+0003ed70: 7320 2620 776f 726b 6572 7329 0a20 2020  s & workers).   
 0003ed80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ed90: 2020 2020 2020 2020 2064 656c 5f77 6f72           del_wor
-0003eda0: 6b65 725f 7461 736b 735b 7773 5d2e 6164  ker_tasks[ws].ad
-0003edb0: 6428 7473 290a 0a20 2020 2020 2020 2020  d(ts)..         
-0003edc0: 2020 2020 2020 2023 204e 6f74 653a 2074         # Note: t
-0003edd0: 6869 7320 6e65 7665 7220 7261 6973 6573  his never raises
-0003ede0: 2065 7863 6570 7469 6f6e 730a 2020 2020   exceptions.    
-0003edf0: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-0003ee00: 7420 6173 796e 6369 6f2e 6761 7468 6572  t asyncio.gather
-0003ee10: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0003ee20: 2020 2020 2020 2a5b 0a20 2020 2020 2020        *[.       
-0003ee30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ee40: 2073 656c 662e 6465 6c65 7465 5f77 6f72   self.delete_wor
-0003ee50: 6b65 725f 6461 7461 280a 2020 2020 2020  ker_data(.      
-0003ee60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ee70: 2020 2020 2020 7773 2e61 6464 7265 7373        ws.address
-0003ee80: 2c20 5b74 2e6b 6579 2066 6f72 2074 2069  , [t.key for t i
-0003ee90: 6e20 7461 736b 735d 2c20 7374 696d 756c  n tasks], stimul
-0003eea0: 7573 5f69 640a 2020 2020 2020 2020 2020  us_id.          
-0003eeb0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0003eec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003eed0: 2020 2020 2020 2020 666f 7220 7773 2c20          for ws, 
-0003eee0: 7461 736b 7320 696e 2064 656c 5f77 6f72  tasks in del_wor
-0003eef0: 6b65 725f 7461 736b 732e 6974 656d 7328  ker_tasks.items(
-0003ef00: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0003ef10: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
-0003ef20: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-0003ef30: 2020 2020 2020 2023 2043 6f70 7920 6e6f         # Copy no
-0003ef40: 742d 7965 742d 6669 6c6c 6564 2064 6174  t-yet-filled dat
-0003ef50: 610a 2020 2020 2020 2020 2020 2020 7768  a.            wh
-0003ef60: 696c 6520 7461 736b 733a 0a20 2020 2020  ile tasks:.     
-0003ef70: 2020 2020 2020 2020 2020 2067 6174 6865             gathe
-0003ef80: 7273 203d 2064 6566 6175 6c74 6469 6374  rs = defaultdict
-0003ef90: 2864 6963 7429 0a20 2020 2020 2020 2020  (dict).         
-0003efa0: 2020 2020 2020 2066 6f72 2074 7320 696e         for ts in
-0003efb0: 206c 6973 7428 7461 736b 7329 3a0a 2020   list(tasks):.  
-0003efc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003efd0: 2020 6966 2074 732e 7374 6174 6520 3d3d    if ts.state ==
-0003efe0: 2022 666f 7267 6f74 7465 6e22 3a0a 2020   "forgotten":.  
-0003eff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f000: 2020 2020 2020 2320 7461 736b 2069 7320        # task is 
-0003f010: 6e6f 206c 6f6e 6765 7220 6e65 6564 6564  no longer needed
-0003f020: 2062 7920 616e 7920 636c 6965 6e74 206f   by any client o
-0003f030: 7220 6465 7065 6e64 656e 7420 7461 736b  r dependent task
-0003f040: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003f050: 2020 2020 2020 2020 2074 6173 6b73 2e72           tasks.r
-0003f060: 656d 6f76 6528 7473 290a 2020 2020 2020  emove(ts).      
-0003f070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f080: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
-0003f090: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0003f0a0: 7373 6572 7420 7473 2e77 686f 5f68 6173  ssert ts.who_has
-0003f0b0: 2069 7320 6e6f 7420 4e6f 6e65 0a20 2020   is not None.   
-0003f0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f0d0: 206e 5f6d 6973 7369 6e67 203d 206e 202d   n_missing = n -
-0003f0e0: 206c 656e 2874 732e 7768 6f5f 6861 7320   len(ts.who_has 
-0003f0f0: 2620 776f 726b 6572 7329 0a20 2020 2020  & workers).     
-0003f100: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0003f110: 6620 6e5f 6d69 7373 696e 6720 3c3d 2030  f n_missing <= 0
-0003f120: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0003f130: 2020 2020 2020 2020 2020 2320 416c 7265            # Alre
-0003f140: 6164 7920 7265 706c 6963 6174 6564 2065  ady replicated e
-0003f150: 6e6f 7567 680a 2020 2020 2020 2020 2020  nough.          
-0003f160: 2020 2020 2020 2020 2020 2020 2020 7461                ta
-0003f170: 736b 732e 7265 6d6f 7665 2874 7329 0a20  sks.remove(ts). 
+0003ed90: 2069 6620 6c65 6e28 6465 6c5f 6361 6e64   if len(del_cand
+0003eda0: 6964 6174 6573 2920 3e20 6e3a 0a20 2020  idates) > n:.   
+0003edb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003edc0: 2020 2020 2066 6f72 2077 7320 696e 2072       for ws in r
+0003edd0: 616e 646f 6d2e 7361 6d70 6c65 280a 2020  andom.sample(.  
+0003ede0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003edf0: 2020 2020 2020 2020 2020 6465 6c5f 6361            del_ca
+0003ee00: 6e64 6964 6174 6573 2c20 6c65 6e28 6465  ndidates, len(de
+0003ee10: 6c5f 6361 6e64 6964 6174 6573 2920 2d20  l_candidates) - 
+0003ee20: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
+0003ee30: 2020 2020 2020 2020 2020 293a 0a20 2020            ):.   
+0003ee40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ee50: 2020 2020 2020 2020 2064 656c 5f77 6f72           del_wor
+0003ee60: 6b65 725f 7461 736b 735b 7773 5d2e 6164  ker_tasks[ws].ad
+0003ee70: 6428 7473 290a 0a20 2020 2020 2020 2020  d(ts)..         
+0003ee80: 2020 2020 2020 2023 204e 6f74 653a 2074         # Note: t
+0003ee90: 6869 7320 6e65 7665 7220 7261 6973 6573  his never raises
+0003eea0: 2065 7863 6570 7469 6f6e 730a 2020 2020   exceptions.    
+0003eeb0: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+0003eec0: 7420 6173 796e 6369 6f2e 6761 7468 6572  t asyncio.gather
+0003eed0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0003eee0: 2020 2020 2020 2a5b 0a20 2020 2020 2020        *[.       
+0003eef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ef00: 2073 656c 662e 6465 6c65 7465 5f77 6f72   self.delete_wor
+0003ef10: 6b65 725f 6461 7461 280a 2020 2020 2020  ker_data(.      
+0003ef20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ef30: 2020 2020 2020 7773 2e61 6464 7265 7373        ws.address
+0003ef40: 2c20 5b74 2e6b 6579 2066 6f72 2074 2069  , [t.key for t i
+0003ef50: 6e20 7461 736b 735d 2c20 7374 696d 756c  n tasks], stimul
+0003ef60: 7573 5f69 640a 2020 2020 2020 2020 2020  us_id.          
+0003ef70: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0003ef80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ef90: 2020 2020 2020 2020 666f 7220 7773 2c20          for ws, 
+0003efa0: 7461 736b 7320 696e 2064 656c 5f77 6f72  tasks in del_wor
+0003efb0: 6b65 725f 7461 736b 732e 6974 656d 7328  ker_tasks.items(
+0003efc0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0003efd0: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
+0003efe0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+0003eff0: 2020 2020 2020 2023 2043 6f70 7920 6e6f         # Copy no
+0003f000: 742d 7965 742d 6669 6c6c 6564 2064 6174  t-yet-filled dat
+0003f010: 610a 2020 2020 2020 2020 2020 2020 7768  a.            wh
+0003f020: 696c 6520 7461 736b 733a 0a20 2020 2020  ile tasks:.     
+0003f030: 2020 2020 2020 2020 2020 2067 6174 6865             gathe
+0003f040: 7273 203d 2064 6566 6175 6c74 6469 6374  rs = defaultdict
+0003f050: 2864 6963 7429 0a20 2020 2020 2020 2020  (dict).         
+0003f060: 2020 2020 2020 2066 6f72 2074 7320 696e         for ts in
+0003f070: 206c 6973 7428 7461 736b 7329 3a0a 2020   list(tasks):.  
+0003f080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f090: 2020 6966 2074 732e 7374 6174 6520 3d3d    if ts.state ==
+0003f0a0: 2022 666f 7267 6f74 7465 6e22 3a0a 2020   "forgotten":.  
+0003f0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f0c0: 2020 2020 2020 2320 7461 736b 2069 7320        # task is 
+0003f0d0: 6e6f 206c 6f6e 6765 7220 6e65 6564 6564  no longer needed
+0003f0e0: 2062 7920 616e 7920 636c 6965 6e74 206f   by any client o
+0003f0f0: 7220 6465 7065 6e64 656e 7420 7461 736b  r dependent task
+0003f100: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003f110: 2020 2020 2020 2020 2074 6173 6b73 2e72           tasks.r
+0003f120: 656d 6f76 6528 7473 290a 2020 2020 2020  emove(ts).      
+0003f130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f140: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
+0003f150: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0003f160: 7373 6572 7420 7473 2e77 686f 5f68 6173  ssert ts.who_has
+0003f170: 2069 7320 6e6f 7420 4e6f 6e65 0a20 2020   is not None.   
 0003f180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f190: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
-0003f1a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003f1b0: 2020 2020 2063 6f75 6e74 203d 206d 696e       count = min
-0003f1c0: 286e 5f6d 6973 7369 6e67 2c20 6272 616e  (n_missing, bran
-0003f1d0: 6368 696e 675f 6661 6374 6f72 202a 206c  ching_factor * l
-0003f1e0: 656e 2874 732e 7768 6f5f 6861 7329 290a  en(ts.who_has)).
-0003f1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f200: 2020 2020 6173 7365 7274 2063 6f75 6e74      assert count
-0003f210: 203e 2030 0a0a 2020 2020 2020 2020 2020   > 0..          
-0003f220: 2020 2020 2020 2020 2020 666f 7220 7773            for ws
-0003f230: 2069 6e20 7261 6e64 6f6d 2e73 616d 706c   in random.sampl
-0003f240: 6528 7475 706c 6528 776f 726b 6572 7320  e(tuple(workers 
-0003f250: 2d20 7473 2e77 686f 5f68 6173 292c 2063  - ts.who_has), c
-0003f260: 6f75 6e74 293a 0a20 2020 2020 2020 2020  ount):.         
-0003f270: 2020 2020 2020 2020 2020 2020 2020 2067                 g
-0003f280: 6174 6865 7273 5b77 732e 6164 6472 6573  athers[ws.addres
-0003f290: 735d 5b74 732e 6b65 795d 203d 205b 0a20  s][ts.key] = [. 
-0003f2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f2b0: 2020 2020 2020 2020 2020 2077 7773 2e61             wws.a
-0003f2c0: 6464 7265 7373 2066 6f72 2077 7773 2069  ddress for wws i
-0003f2d0: 6e20 7473 2e77 686f 5f68 6173 0a20 2020  n ts.who_has.   
-0003f2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f2f0: 2020 2020 205d 0a0a 2020 2020 2020 2020       ]..        
-0003f300: 2020 2020 2020 2020 6177 6169 7420 6173          await as
-0003f310: 796e 6369 6f2e 6761 7468 6572 280a 2020  yncio.gather(.  
-0003f320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f330: 2020 2a28 0a20 2020 2020 2020 2020 2020    *(.           
-0003f340: 2020 2020 2020 2020 2020 2020 2023 204e               # N
-0003f350: 6f74 653a 2074 6869 7320 6e65 7665 7220  ote: this never 
-0003f360: 7261 6973 6573 2065 7863 6570 7469 6f6e  raises exception
-0003f370: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-0003f380: 2020 2020 2020 2020 2020 7365 6c66 2e67            self.g
-0003f390: 6174 6865 725f 6f6e 5f77 6f72 6b65 7228  ather_on_worker(
-0003f3a0: 772c 2077 686f 5f68 6173 290a 2020 2020  w, who_has).    
-0003f3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f3c0: 2020 2020 666f 7220 772c 2077 686f 5f68      for w, who_h
-0003f3d0: 6173 2069 6e20 6761 7468 6572 732e 6974  as in gathers.it
-0003f3e0: 656d 7328 290a 2020 2020 2020 2020 2020  ems().          
-0003f3f0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0003f400: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0003f410: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0003f420: 7220 722c 2076 2069 6e20 6761 7468 6572  r r, v in gather
-0003f430: 732e 6974 656d 7328 293a 0a20 2020 2020  s.items():.     
-0003f440: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0003f450: 656c 662e 6c6f 675f 6576 656e 7428 722c  elf.log_event(r,
-0003f460: 207b 2261 6374 696f 6e22 3a20 2272 6570   {"action": "rep
-0003f470: 6c69 6361 7465 2d61 6464 222c 2022 7768  licate-add", "wh
-0003f480: 6f5f 6861 7322 3a20 767d 290a 0a20 2020  o_has": v})..   
-0003f490: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
-0003f4a0: 675f 6576 656e 7428 0a20 2020 2020 2020  g_event(.       
-0003f4b0: 2020 2020 2020 2020 2022 616c 6c22 2c0a           "all",.
-0003f4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f4d0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0003f4e0: 2020 2020 2020 2261 6374 696f 6e22 3a20        "action": 
-0003f4f0: 2272 6570 6c69 6361 7465 222c 0a20 2020  "replicate",.   
-0003f500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f510: 2022 776f 726b 6572 7322 3a20 6c69 7374   "workers": list
-0003f520: 2877 6f72 6b65 7273 292c 0a20 2020 2020  (workers),.     
-0003f530: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0003f540: 6b65 792d 636f 756e 7422 3a20 6c65 6e28  key-count": len(
-0003f550: 6b65 7973 292c 0a20 2020 2020 2020 2020  keys),.         
-0003f560: 2020 2020 2020 2020 2020 2022 6272 616e             "bran
-0003f570: 6368 696e 672d 6661 6374 6f72 223a 2062  ching-factor": b
-0003f580: 7261 6e63 6869 6e67 5f66 6163 746f 722c  ranching_factor,
-0003f590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003f5a0: 207d 2c0a 2020 2020 2020 2020 2020 2020   },.            
-0003f5b0: 290a 0a20 2020 2040 6c6f 675f 6572 726f  )..    @log_erro
-0003f5c0: 7273 0a20 2020 2064 6566 2077 6f72 6b65  rs.    def worke
-0003f5d0: 7273 5f74 6f5f 636c 6f73 6528 0a20 2020  rs_to_close(.   
-0003f5e0: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-0003f5f0: 2020 206d 656d 6f72 795f 7261 7469 6f3a     memory_ratio:
-0003f600: 2069 6e74 207c 2066 6c6f 6174 207c 204e   int | float | N
-0003f610: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
-0003f620: 2020 2020 6e3a 2069 6e74 207c 204e 6f6e      n: int | Non
-0003f630: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
-0003f640: 2020 6b65 793a 2043 616c 6c61 626c 655b    key: Callable[
-0003f650: 5b57 6f72 6b65 7253 7461 7465 5d2c 2048  [WorkerState], H
-0003f660: 6173 6861 626c 655d 207c 2062 7974 6573  ashable] | bytes
-0003f670: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
-0003f680: 2020 2020 2020 2020 6d69 6e69 6d75 6d3a          minimum:
-0003f690: 2069 6e74 207c 204e 6f6e 6520 3d20 4e6f   int | None = No
-0003f6a0: 6e65 2c0a 2020 2020 2020 2020 7461 7267  ne,.        targ
-0003f6b0: 6574 3a20 696e 7420 7c20 4e6f 6e65 203d  et: int | None =
-0003f6c0: 204e 6f6e 652c 0a20 2020 2020 2020 2061   None,.        a
-0003f6d0: 7474 7269 6275 7465 3a20 7374 7220 3d20  ttribute: str = 
-0003f6e0: 2261 6464 7265 7373 222c 0a20 2020 2029  "address",.    )
-0003f6f0: 202d 3e20 6c69 7374 5b73 7472 5d3a 0a20   -> list[str]:. 
-0003f700: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0003f710: 2020 2046 696e 6420 776f 726b 6572 7320     Find workers 
-0003f720: 7468 6174 2077 6520 6361 6e20 636c 6f73  that we can clos
-0003f730: 6520 7769 7468 206c 6f77 2063 6f73 740a  e with low cost.
-0003f740: 0a20 2020 2020 2020 2054 6869 7320 7265  .        This re
-0003f750: 7475 726e 7320 6120 6c69 7374 206f 6620  turns a list of 
-0003f760: 776f 726b 6572 7320 7468 6174 2061 7265  workers that are
-0003f770: 2067 6f6f 6420 6361 6e64 6964 6174 6573   good candidates
-0003f780: 2074 6f20 7265 7469 7265 2e0a 2020 2020   to retire..    
-0003f790: 2020 2020 5468 6573 6520 776f 726b 6572      These worker
-0003f7a0: 7320 6172 6520 6e6f 7420 7275 6e6e 696e  s are not runnin
-0003f7b0: 6720 616e 7974 6869 6e67 2061 6e64 2061  g anything and a
-0003f7c0: 7265 2073 746f 7269 6e67 0a20 2020 2020  re storing.     
-0003f7d0: 2020 2072 656c 6174 6976 656c 7920 6c69     relatively li
-0003f7e0: 7474 6c65 2064 6174 6120 7265 6c61 7469  ttle data relati
-0003f7f0: 7665 2074 6f20 7468 6569 7220 7065 6572  ve to their peer
-0003f800: 732e 2020 4966 2061 6c6c 2077 6f72 6b65  s.  If all worke
-0003f810: 7273 2061 7265 0a20 2020 2020 2020 2069  rs are.        i
-0003f820: 646c 6520 7468 656e 2077 6520 7374 696c  dle then we stil
-0003f830: 6c20 6d61 696e 7461 696e 2065 6e6f 7567  l maintain enoug
-0003f840: 6820 776f 726b 6572 7320 746f 2068 6176  h workers to hav
-0003f850: 6520 656e 6f75 6768 2052 414d 2074 6f20  e enough RAM to 
-0003f860: 7374 6f72 650a 2020 2020 2020 2020 6f75  store.        ou
-0003f870: 7220 6461 7461 2c20 7769 7468 2061 2063  r data, with a c
-0003f880: 6f6d 666f 7274 6162 6c65 2062 7566 6665  omfortable buffe
-0003f890: 722e 0a0a 2020 2020 2020 2020 5468 6973  r...        This
-0003f8a0: 2069 7320 666f 7220 7573 6520 7769 7468   is for use with
-0003f8b0: 2073 7973 7465 6d73 206c 696b 6520 6060   systems like ``
-0003f8c0: 6469 7374 7269 6275 7465 642e 6465 706c  distributed.depl
-0003f8d0: 6f79 2e61 6461 7074 6976 6560 602e 0a0a  oy.adaptive``...
-0003f8e0: 2020 2020 2020 2020 5061 7261 6d65 7465          Paramete
-0003f8f0: 7273 0a20 2020 2020 2020 202d 2d2d 2d2d  rs.        -----
-0003f900: 2d2d 2d2d 2d0a 2020 2020 2020 2020 6d65  -----.        me
-0003f910: 6d6f 7279 5f72 6174 696f 203a 204e 756d  mory_ratio : Num
-0003f920: 6265 720a 2020 2020 2020 2020 2020 2020  ber.            
-0003f930: 416d 6f75 6e74 206f 6620 6578 7472 6120  Amount of extra 
-0003f940: 7370 6163 6520 7765 2077 616e 7420 746f  space we want to
-0003f950: 2068 6176 6520 666f 7220 6f75 7220 7374   have for our st
-0003f960: 6f72 6564 2064 6174 612e 0a20 2020 2020  ored data..     
-0003f970: 2020 2020 2020 2044 6566 6175 6c74 7320         Defaults 
-0003f980: 746f 2032 2c20 6f72 2074 6861 7420 7765  to 2, or that we
-0003f990: 2077 616e 7420 746f 2068 6176 6520 7477   want to have tw
-0003f9a0: 6963 6520 6173 206d 7563 6820 6d65 6d6f  ice as much memo
-0003f9b0: 7279 2061 7320 7765 0a20 2020 2020 2020  ry as we.       
-0003f9c0: 2020 2020 2063 7572 7265 6e74 6c79 2068       currently h
-0003f9d0: 6176 6520 6461 7461 2e0a 2020 2020 2020  ave data..      
-0003f9e0: 2020 6e20 3a20 696e 740a 2020 2020 2020    n : int.      
-0003f9f0: 2020 2020 2020 4e75 6d62 6572 206f 6620        Number of 
-0003fa00: 776f 726b 6572 7320 746f 2063 6c6f 7365  workers to close
-0003fa10: 0a20 2020 2020 2020 206d 696e 696d 756d  .        minimum
-0003fa20: 203a 2069 6e74 0a20 2020 2020 2020 2020   : int.         
-0003fa30: 2020 204d 696e 696d 756d 206e 756d 6265     Minimum numbe
-0003fa40: 7220 6f66 2077 6f72 6b65 7273 2074 6f20  r of workers to 
-0003fa50: 6b65 6570 2061 726f 756e 640a 2020 2020  keep around.    
-0003fa60: 2020 2020 6b65 7920 3a20 4361 6c6c 6162      key : Callab
-0003fa70: 6c65 2857 6f72 6b65 7253 7461 7465 290a  le(WorkerState).
-0003fa80: 2020 2020 2020 2020 2020 2020 416e 206f              An o
-0003fa90: 7074 696f 6e61 6c20 6361 6c6c 6162 6c65  ptional callable
-0003faa0: 206d 6170 7069 6e67 2061 2057 6f72 6b65   mapping a Worke
-0003fab0: 7253 7461 7465 206f 626a 6563 7420 746f  rState object to
-0003fac0: 2061 2067 726f 7570 0a20 2020 2020 2020   a group.       
-0003fad0: 2020 2020 2061 6666 696c 6961 7469 6f6e       affiliation
-0003fae0: 2e20 4772 6f75 7073 2077 696c 6c20 6265  . Groups will be
-0003faf0: 2063 6c6f 7365 6420 746f 6765 7468 6572   closed together
-0003fb00: 2e20 5468 6973 2069 7320 7573 6566 756c  . This is useful
-0003fb10: 2077 6865 6e0a 2020 2020 2020 2020 2020   when.          
-0003fb20: 2020 636c 6f73 696e 6720 776f 726b 6572    closing worker
-0003fb30: 7320 6d75 7374 2062 6520 646f 6e65 2063  s must be done c
-0003fb40: 6f6c 6c65 6374 6976 656c 792c 2073 7563  ollectively, suc
-0003fb50: 6820 6173 2062 7920 686f 7374 6e61 6d65  h as by hostname
-0003fb60: 2e0a 2020 2020 2020 2020 7461 7267 6574  ..        target
-0003fb70: 203a 2069 6e74 0a20 2020 2020 2020 2020   : int.         
-0003fb80: 2020 2054 6172 6765 7420 6e75 6d62 6572     Target number
-0003fb90: 206f 6620 776f 726b 6572 7320 746f 2068   of workers to h
-0003fba0: 6176 6520 6166 7465 7220 7765 2063 6c6f  ave after we clo
-0003fbb0: 7365 0a20 2020 2020 2020 2061 7474 7269  se.        attri
-0003fbc0: 6275 7465 203a 2073 7472 0a20 2020 2020  bute : str.     
-0003fbd0: 2020 2020 2020 2054 6865 2061 7474 7269         The attri
-0003fbe0: 6275 7465 206f 6620 7468 6520 576f 726b  bute of the Work
-0003fbf0: 6572 5374 6174 6520 6f62 6a65 6374 2074  erState object t
-0003fc00: 6f20 7265 7475 726e 2c20 6c69 6b65 2022  o return, like "
-0003fc10: 6164 6472 6573 7322 0a20 2020 2020 2020  address".       
-0003fc20: 2020 2020 206f 7220 226e 616d 6522 2e20       or "name". 
-0003fc30: 2044 6566 6175 6c74 7320 746f 2022 6164   Defaults to "ad
-0003fc40: 6472 6573 7322 2e0a 0a20 2020 2020 2020  dress"...       
-0003fc50: 2045 7861 6d70 6c65 730a 2020 2020 2020   Examples.      
-0003fc60: 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020    --------.     
-0003fc70: 2020 203e 3e3e 2073 6368 6564 756c 6572     >>> scheduler
-0003fc80: 2e77 6f72 6b65 7273 5f74 6f5f 636c 6f73  .workers_to_clos
-0003fc90: 6528 290a 2020 2020 2020 2020 5b27 7463  e().        ['tc
-0003fca0: 703a 2f2f 3139 322e 3136 382e 302e 313a  p://192.168.0.1:
-0003fcb0: 3132 3334 272c 2027 7463 703a 2f2f 3139  1234', 'tcp://19
-0003fcc0: 322e 3136 382e 302e 323a 3132 3334 275d  2.168.0.2:1234']
-0003fcd0: 0a0a 2020 2020 2020 2020 4772 6f75 7020  ..        Group 
-0003fce0: 776f 726b 6572 7320 6279 2068 6f73 746e  workers by hostn
-0003fcf0: 616d 6520 7072 696f 7220 746f 2063 6c6f  ame prior to clo
-0003fd00: 7369 6e67 0a0a 2020 2020 2020 2020 3e3e  sing..        >>
-0003fd10: 3e20 7363 6865 6475 6c65 722e 776f 726b  > scheduler.work
-0003fd20: 6572 735f 746f 5f63 6c6f 7365 286b 6579  ers_to_close(key
-0003fd30: 3d6c 616d 6264 6120 7773 3a20 7773 2e68  =lambda ws: ws.h
-0003fd40: 6f73 7429 0a20 2020 2020 2020 205b 2774  ost).        ['t
-0003fd50: 6370 3a2f 2f31 3932 2e31 3638 2e30 2e31  cp://192.168.0.1
-0003fd60: 3a31 3233 3427 2c20 2774 6370 3a2f 2f31  :1234', 'tcp://1
-0003fd70: 3932 2e31 3638 2e30 2e31 3a34 3536 3727  92.168.0.1:4567'
-0003fd80: 5d0a 0a20 2020 2020 2020 2052 656d 6f76  ]..        Remov
-0003fd90: 6520 7477 6f20 776f 726b 6572 730a 0a20  e two workers.. 
-0003fda0: 2020 2020 2020 203e 3e3e 2073 6368 6564         >>> sched
-0003fdb0: 756c 6572 2e77 6f72 6b65 7273 5f74 6f5f  uler.workers_to_
-0003fdc0: 636c 6f73 6528 6e3d 3229 0a0a 2020 2020  close(n=2)..    
-0003fdd0: 2020 2020 4b65 6570 2065 6e6f 7567 6820      Keep enough 
-0003fde0: 776f 726b 6572 7320 746f 2068 6176 6520  workers to have 
-0003fdf0: 7477 6963 6520 6173 206d 7563 6820 6d65  twice as much me
-0003fe00: 6d6f 7279 2061 7320 7765 2077 6520 6e65  mory as we we ne
-0003fe10: 6564 2e0a 0a20 2020 2020 2020 203e 3e3e  ed...        >>>
-0003fe20: 2073 6368 6564 756c 6572 2e77 6f72 6b65   scheduler.worke
-0003fe30: 7273 5f74 6f5f 636c 6f73 6528 6d65 6d6f  rs_to_close(memo
-0003fe40: 7279 5f72 6174 696f 3d32 290a 0a20 2020  ry_ratio=2)..   
-0003fe50: 2020 2020 2052 6574 7572 6e73 0a20 2020       Returns.   
-0003fe60: 2020 2020 202d 2d2d 2d2d 2d2d 0a20 2020       -------.   
-0003fe70: 2020 2020 2074 6f5f 636c 6f73 653a 206c       to_close: l
-0003fe80: 6973 7420 6f66 2077 6f72 6b65 7220 6164  ist of worker ad
-0003fe90: 6472 6573 7365 7320 7468 6174 2061 7265  dresses that are
-0003fea0: 204f 4b20 746f 2063 6c6f 7365 0a0a 2020   OK to close..  
-0003feb0: 2020 2020 2020 5365 6520 416c 736f 0a20        See Also. 
-0003fec0: 2020 2020 2020 202d 2d2d 2d2d 2d2d 2d0a         --------.
-0003fed0: 2020 2020 2020 2020 5363 6865 6475 6c65          Schedule
-0003fee0: 722e 7265 7469 7265 5f77 6f72 6b65 7273  r.retire_workers
-0003fef0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0003ff00: 2020 2020 2069 6620 7461 7267 6574 2069       if target i
-0003ff10: 7320 6e6f 7420 4e6f 6e65 2061 6e64 206e  s not None and n
-0003ff20: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0003ff30: 2020 2020 2020 6e20 3d20 6c65 6e28 7365        n = len(se
-0003ff40: 6c66 2e77 6f72 6b65 7273 2920 2d20 7461  lf.workers) - ta
-0003ff50: 7267 6574 0a20 2020 2020 2020 2069 6620  rget.        if 
-0003ff60: 6e20 6973 206e 6f74 204e 6f6e 653a 0a20  n is not None:. 
-0003ff70: 2020 2020 2020 2020 2020 2069 6620 6e20             if n 
-0003ff80: 3c20 303a 0a20 2020 2020 2020 2020 2020  < 0:.           
-0003ff90: 2020 2020 206e 203d 2030 0a20 2020 2020       n = 0.     
-0003ffa0: 2020 2020 2020 2074 6172 6765 7420 3d20         target = 
-0003ffb0: 6c65 6e28 7365 6c66 2e77 6f72 6b65 7273  len(self.workers
-0003ffc0: 2920 2d20 6e0a 0a20 2020 2020 2020 2069  ) - n..        i
-0003ffd0: 6620 6e20 6973 204e 6f6e 6520 616e 6420  f n is None and 
-0003ffe0: 6d65 6d6f 7279 5f72 6174 696f 2069 7320  memory_ratio is 
-0003fff0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00040000: 2020 6d65 6d6f 7279 5f72 6174 696f 203d    memory_ratio =
-00040010: 2032 0a0a 2020 2020 2020 2020 6966 206e   2..        if n
-00040020: 6f74 206e 2061 6e64 2061 6c6c 285b 7773  ot n and all([ws
-00040030: 2e70 726f 6365 7373 696e 6720 666f 7220  .processing for 
-00040040: 7773 2069 6e20 7365 6c66 2e77 6f72 6b65  ws in self.worke
-00040050: 7273 2e76 616c 7565 7328 295d 293a 0a20  rs.values()]):. 
-00040060: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00040070: 6e20 5b5d 0a0a 2020 2020 2020 2020 6966  n []..        if
-00040080: 206b 6579 2069 7320 4e6f 6e65 3a0a 2020   key is None:.  
-00040090: 2020 2020 2020 2020 2020 6b65 7920 3d20            key = 
-000400a0: 6f70 6572 6174 6f72 2e61 7474 7267 6574  operator.attrget
-000400b0: 7465 7228 2261 6464 7265 7373 2229 0a20  ter("address"). 
-000400c0: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-000400d0: 616e 6365 286b 6579 2c20 6279 7465 7329  ance(key, bytes)
-000400e0: 3a0a 2020 2020 2020 2020 2020 2020 6b65  :.            ke
-000400f0: 7920 3d20 7069 636b 6c65 2e6c 6f61 6473  y = pickle.loads
-00040100: 286b 6579 290a 0a20 2020 2020 2020 2023  (key)..        #
-00040110: 204c 6f6e 6720 7275 6e6e 696e 6720 7461   Long running ta
-00040120: 736b 7320 7479 7069 6361 6c6c 7920 7573  sks typically us
-00040130: 6520 6120 776f 726b 6572 5f63 6c69 656e  e a worker_clien
-00040140: 7420 746f 2073 6368 6564 756c 650a 2020  t to schedule.  
-00040150: 2020 2020 2020 2320 6f74 6865 7220 7461        # other ta
-00040160: 736b 732e 2057 6520 7368 6f75 6c64 206e  sks. We should n
-00040170: 6576 6572 2073 6875 7420 646f 776e 2074  ever shut down t
-00040180: 6865 2077 6f72 6b65 7220 7468 6579 2772  he worker they'r
-00040190: 650a 2020 2020 2020 2020 2320 7275 6e6e  e.        # runn
-000401a0: 696e 6720 6f6e 2c20 6173 2069 7420 776f  ing on, as it wo
-000401b0: 756c 6420 6361 7573 6520 7468 656d 2074  uld cause them t
-000401c0: 6f20 7265 7374 6172 7420 6672 6f6d 2073  o restart from s
-000401d0: 6372 6174 6368 0a20 2020 2020 2020 2023  cratch.        #
-000401e0: 2073 6f6d 6577 6865 7265 2065 6c73 652e   somewhere else.
-000401f0: 0a20 2020 2020 2020 2076 616c 6964 5f77  .        valid_w
-00040200: 6f72 6b65 7273 203d 205b 7773 2066 6f72  orkers = [ws for
-00040210: 2077 7320 696e 2073 656c 662e 776f 726b   ws in self.work
-00040220: 6572 732e 7661 6c75 6573 2829 2069 6620  ers.values() if 
-00040230: 6e6f 7420 7773 2e6c 6f6e 675f 7275 6e6e  not ws.long_runn
-00040240: 696e 675d 0a20 2020 2020 2020 2066 6f72  ing].        for
-00040250: 2070 6c75 6769 6e20 696e 206c 6973 7428   plugin in list(
-00040260: 7365 6c66 2e70 6c75 6769 6e73 2e76 616c  self.plugins.val
-00040270: 7565 7328 2929 3a0a 2020 2020 2020 2020  ues()):.        
-00040280: 2020 2020 7661 6c69 645f 776f 726b 6572      valid_worker
-00040290: 7320 3d20 706c 7567 696e 2e76 616c 6964  s = plugin.valid
-000402a0: 5f77 6f72 6b65 7273 5f64 6f77 6e73 6361  _workers_downsca
-000402b0: 6c69 6e67 2873 656c 662c 2076 616c 6964  ling(self, valid
-000402c0: 5f77 6f72 6b65 7273 290a 0a20 2020 2020  _workers)..     
-000402d0: 2020 2067 726f 7570 7320 3d20 6772 6f75     groups = grou
-000402e0: 7062 7928 6b65 792c 2076 616c 6964 5f77  pby(key, valid_w
-000402f0: 6f72 6b65 7273 290a 0a20 2020 2020 2020  orkers)..       
-00040300: 206c 696d 6974 5f62 7974 6573 203d 207b   limit_bytes = {
-00040310: 6b3a 2073 756d 2877 732e 6d65 6d6f 7279  k: sum(ws.memory
-00040320: 5f6c 696d 6974 2066 6f72 2077 7320 696e  _limit for ws in
-00040330: 2076 2920 666f 7220 6b2c 2076 2069 6e20   v) for k, v in 
-00040340: 6772 6f75 7073 2e69 7465 6d73 2829 7d0a  groups.items()}.
-00040350: 2020 2020 2020 2020 6772 6f75 705f 6279          group_by
-00040360: 7465 7320 3d20 7b6b 3a20 7375 6d28 7773  tes = {k: sum(ws
-00040370: 2e6e 6279 7465 7320 666f 7220 7773 2069  .nbytes for ws i
-00040380: 6e20 7629 2066 6f72 206b 2c20 7620 696e  n v) for k, v in
-00040390: 2067 726f 7570 732e 6974 656d 7328 297d   groups.items()}
-000403a0: 0a0a 2020 2020 2020 2020 6c69 6d69 7420  ..        limit 
-000403b0: 3d20 7375 6d28 6c69 6d69 745f 6279 7465  = sum(limit_byte
-000403c0: 732e 7661 6c75 6573 2829 290a 2020 2020  s.values()).    
-000403d0: 2020 2020 746f 7461 6c20 3d20 7375 6d28      total = sum(
-000403e0: 6772 6f75 705f 6279 7465 732e 7661 6c75  group_bytes.valu
-000403f0: 6573 2829 290a 0a20 2020 2020 2020 2064  es())..        d
-00040400: 6566 205f 6b65 7928 6772 6f75 7029 3a0a  ef _key(group):.
-00040410: 2020 2020 2020 2020 2020 2020 6973 5f69              is_i
-00040420: 646c 6520 3d20 6e6f 7420 616e 7928 5b77  dle = not any([w
-00040430: 7773 2e70 726f 6365 7373 696e 6720 666f  ws.processing fo
-00040440: 7220 7777 7320 696e 2067 726f 7570 735b  r wws in groups[
-00040450: 6772 6f75 705d 5d29 0a20 2020 2020 2020  group]]).       
-00040460: 2020 2020 2062 7974 6573 203d 202d 6772       bytes = -gr
-00040470: 6f75 705f 6279 7465 735b 6772 6f75 705d  oup_bytes[group]
-00040480: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00040490: 7572 6e20 6973 5f69 646c 652c 2062 7974  urn is_idle, byt
-000404a0: 6573 0a0a 2020 2020 2020 2020 6964 6c65  es..        idle
-000404b0: 203d 2073 6f72 7465 6428 6772 6f75 7073   = sorted(groups
-000404c0: 2c20 6b65 793d 5f6b 6579 290a 0a20 2020  , key=_key)..   
-000404d0: 2020 2020 2074 6f5f 636c 6f73 6520 3d20       to_close = 
-000404e0: 5b5d 0a20 2020 2020 2020 206e 5f72 656d  [].        n_rem
-000404f0: 6169 6e20 3d20 6c65 6e28 7365 6c66 2e77  ain = len(self.w
-00040500: 6f72 6b65 7273 290a 0a20 2020 2020 2020  orkers)..       
-00040510: 2077 6869 6c65 2069 646c 653a 0a20 2020   while idle:.   
-00040520: 2020 2020 2020 2020 2067 726f 7570 203d           group =
-00040530: 2069 646c 652e 706f 7028 290a 2020 2020   idle.pop().    
-00040540: 2020 2020 2020 2020 6966 206e 2069 7320          if n is 
-00040550: 4e6f 6e65 2061 6e64 2061 6e79 285b 7773  None and any([ws
-00040560: 2e70 726f 6365 7373 696e 6720 666f 7220  .processing for 
-00040570: 7773 2069 6e20 6772 6f75 7073 5b67 726f  ws in groups[gro
-00040580: 7570 5d5d 293a 0a20 2020 2020 2020 2020  up]]):.         
-00040590: 2020 2020 2020 2062 7265 616b 0a0a 2020         break..  
-000405a0: 2020 2020 2020 2020 2020 6966 206d 696e            if min
-000405b0: 696d 756d 2061 6e64 206e 5f72 656d 6169  imum and n_remai
-000405c0: 6e20 2d20 6c65 6e28 6772 6f75 7073 5b67  n - len(groups[g
-000405d0: 726f 7570 5d29 203c 206d 696e 696d 756d  roup]) < minimum
-000405e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000405f0: 2020 6272 6561 6b0a 0a20 2020 2020 2020    break..       
-00040600: 2020 2020 206c 696d 6974 202d 3d20 6c69       limit -= li
-00040610: 6d69 745f 6279 7465 735b 6772 6f75 705d  mit_bytes[group]
-00040620: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-00040630: 2028 6e20 6973 206e 6f74 204e 6f6e 6520   (n is not None 
-00040640: 616e 6420 6e5f 7265 6d61 696e 202d 206c  and n_remain - l
-00040650: 656e 2867 726f 7570 735b 6772 6f75 705d  en(groups[group]
-00040660: 2920 3e3d 2028 7461 7267 6574 206f 7220  ) >= (target or 
-00040670: 3029 2920 6f72 2028 0a20 2020 2020 2020  0)) or (.       
-00040680: 2020 2020 2020 2020 206d 656d 6f72 795f           memory_
-00040690: 7261 7469 6f20 6973 206e 6f74 204e 6f6e  ratio is not Non
-000406a0: 6520 616e 6420 6c69 6d69 7420 3e3d 206d  e and limit >= m
-000406b0: 656d 6f72 795f 7261 7469 6f20 2a20 746f  emory_ratio * to
-000406c0: 7461 6c0a 2020 2020 2020 2020 2020 2020  tal.            
-000406d0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-000406e0: 2020 2074 6f5f 636c 6f73 652e 6170 7065     to_close.appe
-000406f0: 6e64 2867 726f 7570 290a 2020 2020 2020  nd(group).      
-00040700: 2020 2020 2020 2020 2020 6e5f 7265 6d61            n_rema
-00040710: 696e 202d 3d20 6c65 6e28 6772 6f75 7073  in -= len(groups
-00040720: 5b67 726f 7570 5d29 0a0a 2020 2020 2020  [group])..      
-00040730: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00040740: 2020 2020 2020 2020 2020 2020 6272 6561              brea
-00040750: 6b0a 0a20 2020 2020 2020 2072 6573 756c  k..        resul
-00040760: 7420 3d20 5b67 6574 6174 7472 2877 732c  t = [getattr(ws,
-00040770: 2061 7474 7269 6275 7465 2920 666f 7220   attribute) for 
-00040780: 6720 696e 2074 6f5f 636c 6f73 6520 666f  g in to_close fo
-00040790: 7220 7773 2069 6e20 6772 6f75 7073 5b67  r ws in groups[g
-000407a0: 5d5d 0a20 2020 2020 2020 2069 6620 7265  ]].        if re
-000407b0: 7375 6c74 3a0a 2020 2020 2020 2020 2020  sult:.          
-000407c0: 2020 6c6f 6767 6572 2e64 6562 7567 2822    logger.debug("
-000407d0: 5375 6767 6573 7420 636c 6f73 696e 6720  Suggest closing 
-000407e0: 776f 726b 6572 733a 2025 7322 2c20 7265  workers: %s", re
-000407f0: 7375 6c74 290a 0a20 2020 2020 2020 2072  sult)..        r
-00040800: 6574 7572 6e20 7265 7375 6c74 0a0a 2020  eturn result..  
-00040810: 2020 406f 7665 726c 6f61 640a 2020 2020    @overload.    
-00040820: 6173 796e 6320 6465 6620 7265 7469 7265  async def retire
-00040830: 5f77 6f72 6b65 7273 280a 2020 2020 2020  _workers(.      
-00040840: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-00040850: 776f 726b 6572 733a 206c 6973 745b 7374  workers: list[st
-00040860: 725d 2c0a 2020 2020 2020 2020 2a2c 0a20  r],.        *,. 
-00040870: 2020 2020 2020 2063 6c6f 7365 5f77 6f72         close_wor
-00040880: 6b65 7273 3a20 626f 6f6c 203d 2046 616c  kers: bool = Fal
-00040890: 7365 2c0a 2020 2020 2020 2020 7265 6d6f  se,.        remo
-000408a0: 7665 3a20 626f 6f6c 203d 2054 7275 652c  ve: bool = True,
-000408b0: 0a20 2020 2020 2020 2073 7469 6d75 6c75  .        stimulu
-000408c0: 735f 6964 3a20 7374 7220 7c20 4e6f 6e65  s_id: str | None
-000408d0: 203d 204e 6f6e 652c 0a20 2020 2029 202d   = None,.    ) -
-000408e0: 3e20 6469 6374 5b73 7472 2c20 416e 795d  > dict[str, Any]
-000408f0: 3a0a 2020 2020 2020 2020 2e2e 2e0a 0a20  :.        ..... 
-00040900: 2020 2040 6f76 6572 6c6f 6164 0a20 2020     @overload.   
-00040910: 2061 7379 6e63 2064 6566 2072 6574 6972   async def retir
-00040920: 655f 776f 726b 6572 7328 0a20 2020 2020  e_workers(.     
-00040930: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-00040940: 202a 2c0a 2020 2020 2020 2020 6e61 6d65   *,.        name
-00040950: 733a 206c 6973 742c 0a20 2020 2020 2020  s: list,.       
-00040960: 2063 6c6f 7365 5f77 6f72 6b65 7273 3a20   close_workers: 
-00040970: 626f 6f6c 203d 2046 616c 7365 2c0a 2020  bool = False,.  
-00040980: 2020 2020 2020 7265 6d6f 7665 3a20 626f        remove: bo
-00040990: 6f6c 203d 2054 7275 652c 0a20 2020 2020  ol = True,.     
-000409a0: 2020 2073 7469 6d75 6c75 735f 6964 3a20     stimulus_id: 
-000409b0: 7374 7220 7c20 4e6f 6e65 203d 204e 6f6e  str | None = Non
-000409c0: 652c 0a20 2020 2029 202d 3e20 6469 6374  e,.    ) -> dict
-000409d0: 5b73 7472 2c20 416e 795d 3a0a 2020 2020  [str, Any]:.    
-000409e0: 2020 2020 2e2e 2e0a 0a20 2020 2040 6f76      .....    @ov
-000409f0: 6572 6c6f 6164 0a20 2020 2061 7379 6e63  erload.    async
-00040a00: 2064 6566 2072 6574 6972 655f 776f 726b   def retire_work
-00040a10: 6572 7328 0a20 2020 2020 2020 2073 656c  ers(.        sel
-00040a20: 662c 0a20 2020 2020 2020 202a 2c0a 2020  f,.        *,.  
-00040a30: 2020 2020 2020 636c 6f73 655f 776f 726b        close_work
-00040a40: 6572 733a 2062 6f6f 6c20 3d20 4661 6c73  ers: bool = Fals
-00040a50: 652c 0a20 2020 2020 2020 2072 656d 6f76  e,.        remov
-00040a60: 653a 2062 6f6f 6c20 3d20 5472 7565 2c0a  e: bool = True,.
-00040a70: 2020 2020 2020 2020 7374 696d 756c 7573          stimulus
-00040a80: 5f69 643a 2073 7472 207c 204e 6f6e 6520  _id: str | None 
-00040a90: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-00040aa0: 2320 5061 7261 6d65 7465 7273 2066 6f72  # Parameters for
-00040ab0: 2077 6f72 6b65 7273 5f74 6f5f 636c 6f73   workers_to_clos
-00040ac0: 6528 290a 2020 2020 2020 2020 6d65 6d6f  e().        memo
-00040ad0: 7279 5f72 6174 696f 3a20 696e 7420 7c20  ry_ratio: int | 
-00040ae0: 666c 6f61 7420 7c20 4e6f 6e65 203d 204e  float | None = N
-00040af0: 6f6e 652c 0a20 2020 2020 2020 206e 3a20  one,.        n: 
-00040b00: 696e 7420 7c20 4e6f 6e65 203d 204e 6f6e  int | None = Non
-00040b10: 652c 0a20 2020 2020 2020 206b 6579 3a20  e,.        key: 
-00040b20: 4361 6c6c 6162 6c65 5b5b 576f 726b 6572  Callable[[Worker
-00040b30: 5374 6174 655d 2c20 4861 7368 6162 6c65  State], Hashable
-00040b40: 5d20 7c20 6279 7465 7320 7c20 4e6f 6e65  ] | bytes | None
-00040b50: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-00040b60: 206d 696e 696d 756d 3a20 696e 7420 7c20   minimum: int | 
-00040b70: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
-00040b80: 2020 2020 2074 6172 6765 743a 2069 6e74       target: int
-00040b90: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
-00040ba0: 2020 2020 2020 2020 6174 7472 6962 7574          attribut
-00040bb0: 653a 2073 7472 203d 2022 6164 6472 6573  e: str = "addres
-00040bc0: 7322 2c0a 2020 2020 2920 2d3e 2064 6963  s",.    ) -> dic
-00040bd0: 745b 7374 722c 2041 6e79 5d3a 0a20 2020  t[str, Any]:.   
-00040be0: 2020 2020 202e 2e2e 0a0a 2020 2020 406c       .....    @l
-00040bf0: 6f67 5f65 7272 6f72 730a 2020 2020 6173  og_errors.    as
-00040c00: 796e 6320 6465 6620 7265 7469 7265 5f77  ync def retire_w
-00040c10: 6f72 6b65 7273 280a 2020 2020 2020 2020  orkers(.        
-00040c20: 7365 6c66 2c0a 2020 2020 2020 2020 776f  self,.        wo
-00040c30: 726b 6572 733a 206c 6973 745b 7374 725d  rkers: list[str]
-00040c40: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
-00040c50: 2020 2020 2020 2020 2a2c 0a20 2020 2020          *,.     
-00040c60: 2020 206e 616d 6573 3a20 6c69 7374 207c     names: list |
-00040c70: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
-00040c80: 2020 2020 2020 636c 6f73 655f 776f 726b        close_work
-00040c90: 6572 733a 2062 6f6f 6c20 3d20 4661 6c73  ers: bool = Fals
-00040ca0: 652c 0a20 2020 2020 2020 2072 656d 6f76  e,.        remov
-00040cb0: 653a 2062 6f6f 6c20 3d20 5472 7565 2c0a  e: bool = True,.
-00040cc0: 2020 2020 2020 2020 7374 696d 756c 7573          stimulus
-00040cd0: 5f69 643a 2073 7472 207c 204e 6f6e 6520  _id: str | None 
-00040ce0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-00040cf0: 2a2a 6b77 6172 6773 3a20 416e 792c 0a20  **kwargs: Any,. 
-00040d00: 2020 2029 202d 3e20 6469 6374 5b73 7472     ) -> dict[str
-00040d10: 2c20 416e 795d 3a0a 2020 2020 2020 2020  , Any]:.        
-00040d20: 2222 2247 7261 6365 6675 6c6c 7920 7265  """Gracefully re
-00040d30: 7469 7265 2077 6f72 6b65 7273 2066 726f  tire workers fro
-00040d40: 6d20 636c 7573 7465 722e 2041 6e79 206b  m cluster. Any k
-00040d50: 6579 2074 6861 7420 6973 2069 6e20 6d65  ey that is in me
-00040d60: 6d6f 7279 2065 7863 6c75 7369 7665 6c79  mory exclusively
-00040d70: 0a20 2020 2020 2020 206f 6e20 7468 6520  .        on the 
-00040d80: 7265 7469 7265 6420 776f 726b 6572 7320  retired workers 
-00040d90: 6973 2072 6570 6c69 6361 7465 6420 736f  is replicated so
-00040da0: 6d65 7768 6572 6520 656c 7365 2e0a 0a20  mewhere else... 
-00040db0: 2020 2020 2020 2050 6172 616d 6574 6572         Parameter
-00040dc0: 730a 2020 2020 2020 2020 2d2d 2d2d 2d2d  s.        ------
-00040dd0: 2d2d 2d2d 0a20 2020 2020 2020 2077 6f72  ----.        wor
-00040de0: 6b65 7273 3a20 6c69 7374 5b73 7472 5d20  kers: list[str] 
-00040df0: 286f 7074 696f 6e61 6c29 0a20 2020 2020  (optional).     
-00040e00: 2020 2020 2020 204c 6973 7420 6f66 2077         List of w
-00040e10: 6f72 6b65 7220 6164 6472 6573 7365 7320  orker addresses 
-00040e20: 746f 2072 6574 6972 652e 0a20 2020 2020  to retire..     
-00040e30: 2020 206e 616d 6573 3a20 6c69 7374 2028     names: list (
-00040e40: 6f70 7469 6f6e 616c 290a 2020 2020 2020  optional).      
-00040e50: 2020 2020 2020 4c69 7374 206f 6620 776f        List of wo
-00040e60: 726b 6572 206e 616d 6573 2074 6f20 7265  rker names to re
-00040e70: 7469 7265 2e0a 2020 2020 2020 2020 2020  tire..          
-00040e80: 2020 4d75 7475 616c 6c79 2065 7863 6c75    Mutually exclu
-00040e90: 7369 7665 2077 6974 6820 6060 776f 726b  sive with ``work
-00040ea0: 6572 7360 602e 0a20 2020 2020 2020 2020  ers``..         
-00040eb0: 2020 2049 6620 6e65 6974 6865 7220 6060     If neither ``
-00040ec0: 776f 726b 6572 7360 6020 6e6f 7220 6060  workers`` nor ``
-00040ed0: 6e61 6d65 7360 6020 6172 6520 7072 6f76  names`` are prov
-00040ee0: 6964 6564 2c20 7765 2063 616c 6c0a 2020  ided, we call.  
-00040ef0: 2020 2020 2020 2020 2020 6060 776f 726b            ``work
-00040f00: 6572 735f 746f 5f63 6c6f 7365 6060 2077  ers_to_close`` w
-00040f10: 6869 6368 2066 696e 6473 2061 2067 6f6f  hich finds a goo
-00040f20: 6420 7365 742e 0a20 2020 2020 2020 2063  d set..        c
-00040f30: 6c6f 7365 5f77 6f72 6b65 7273 3a20 626f  lose_workers: bo
-00040f40: 6f6c 2028 6465 6661 756c 7473 2074 6f20  ol (defaults to 
-00040f50: 4661 6c73 6529 0a20 2020 2020 2020 2020  False).         
-00040f60: 2020 2057 6865 7468 6572 2074 6f20 6163     Whether to ac
-00040f70: 7475 616c 6c79 2063 6c6f 7365 2074 6865  tually close the
-00040f80: 2077 6f72 6b65 7220 6578 706c 6963 6974   worker explicit
-00040f90: 6c79 2066 726f 6d20 6865 7265 2e0a 2020  ly from here..  
-00040fa0: 2020 2020 2020 2020 2020 4f74 6865 7277            Otherw
-00040fb0: 6973 652c 2077 6520 6578 7065 6374 2073  ise, we expect s
-00040fc0: 6f6d 6520 6578 7465 726e 616c 206a 6f62  ome external job
-00040fd0: 2073 6368 6564 756c 6572 2074 6f20 6669   scheduler to fi
-00040fe0: 6e69 7368 206f 6666 2074 6865 2077 6f72  nish off the wor
-00040ff0: 6b65 722e 0a20 2020 2020 2020 2072 656d  ker..        rem
-00041000: 6f76 653a 2062 6f6f 6c20 2864 6566 6175  ove: bool (defau
-00041010: 6c74 7320 746f 2054 7275 6529 0a20 2020  lts to True).   
-00041020: 2020 2020 2020 2020 2057 6865 7468 6572           Whether
-00041030: 2074 6f20 7265 6d6f 7665 2074 6865 2077   to remove the w
-00041040: 6f72 6b65 7220 6d65 7461 6461 7461 2069  orker metadata i
-00041050: 6d6d 6564 6961 7465 6c79 206f 7220 656c  mmediately or el
-00041060: 7365 2077 6169 7420 666f 7220 7468 650a  se wait for the.
-00041070: 2020 2020 2020 2020 2020 2020 776f 726b              work
-00041080: 6572 2074 6f20 636f 6e74 6163 7420 7573  er to contact us
-00041090: 2e0a 0a20 2020 2020 2020 2020 2020 2049  ...            I
-000410a0: 6620 636c 6f73 655f 776f 726b 6572 733d  f close_workers=
-000410b0: 4661 6c73 6520 616e 6420 7265 6d6f 7665  False and remove
-000410c0: 3d46 616c 7365 2c20 7468 6973 206d 6574  =False, this met
-000410d0: 686f 6420 6a75 7374 2066 6c75 7368 6573  hod just flushes
-000410e0: 2074 6865 2074 6173 6b73 0a20 2020 2020   the tasks.     
-000410f0: 2020 2020 2020 2069 6e20 6d65 6d6f 7279         in memory
-00041100: 206f 7574 206f 6620 7468 6520 776f 726b   out of the work
-00041110: 6572 7320 616e 6420 7468 656e 2072 6574  ers and then ret
-00041120: 7572 6e73 2e0a 2020 2020 2020 2020 2020  urns..          
-00041130: 2020 4966 2063 6c6f 7365 5f77 6f72 6b65    If close_worke
-00041140: 7273 3d54 7275 6520 616e 6420 7265 6d6f  rs=True and remo
-00041150: 7665 3d46 616c 7365 2c20 7468 6973 206d  ve=False, this m
-00041160: 6574 686f 6420 7769 6c6c 2072 6574 7572  ethod will retur
-00041170: 6e20 7768 696c 6520 7468 650a 2020 2020  n while the.    
-00041180: 2020 2020 2020 2020 776f 726b 6572 7320          workers 
-00041190: 6172 6520 7374 696c 6c20 696e 2074 6865  are still in the
-000411a0: 2063 6c75 7374 6572 2c20 616c 7468 6f75   cluster, althou
-000411b0: 6768 2074 6865 7920 776f 6e27 7420 6163  gh they won't ac
-000411c0: 6365 7074 206e 6577 2074 6173 6b73 2e0a  cept new tasks..
-000411d0: 2020 2020 2020 2020 2020 2020 4966 2063              If c
-000411e0: 6c6f 7365 5f77 6f72 6b65 7273 3d46 616c  lose_workers=Fal
-000411f0: 7365 206f 7220 666f 7220 7768 6174 6576  se or for whatev
-00041200: 6572 2072 6561 736f 6e20 6120 776f 726b  er reason a work
-00041210: 6572 2064 6f65 736e 2774 2061 6363 6570  er doesn't accep
-00041220: 7420 7468 650a 2020 2020 2020 2020 2020  t the.          
-00041230: 2020 636c 6f73 6520 636f 6d6d 616e 642c    close command,
-00041240: 2069 7420 7769 6c6c 2062 6520 6c65 6674   it will be left
-00041250: 2070 6572 6d61 6e65 6e74 6c79 2075 6e61   permanently una
-00041260: 626c 6520 746f 2061 6363 6570 7420 6e65  ble to accept ne
-00041270: 7720 7461 736b 7320 616e 640a 2020 2020  w tasks and.    
-00041280: 2020 2020 2020 2020 6974 2069 7320 6578          it is ex
-00041290: 7065 6374 6564 2074 6f20 6265 2063 6c6f  pected to be clo
-000412a0: 7365 6420 696e 2073 6f6d 6520 6f74 6865  sed in some othe
-000412b0: 7220 7761 792e 0a0a 2020 2020 2020 2020  r way...        
-000412c0: 2a2a 6b77 6172 6773 3a20 6469 6374 0a20  **kwargs: dict. 
-000412d0: 2020 2020 2020 2020 2020 2045 7874 7261             Extra
-000412e0: 206f 7074 696f 6e73 2074 6f20 7061 7373   options to pass
-000412f0: 2074 6f20 776f 726b 6572 735f 746f 5f63   to workers_to_c
-00041300: 6c6f 7365 2074 6f20 6465 7465 726d 696e  lose to determin
-00041310: 6520 7768 6963 680a 2020 2020 2020 2020  e which.        
-00041320: 2020 2020 776f 726b 6572 7320 7765 2073      workers we s
-00041330: 686f 756c 6420 6472 6f70 2e20 4f6e 6c79  hould drop. Only
-00041340: 2061 6363 6570 7465 6420 6966 2060 6077   accepted if ``w
-00041350: 6f72 6b65 7273 6060 2061 6e64 2060 606e  orkers`` and ``n
-00041360: 616d 6573 6060 2061 7265 0a20 2020 2020  ames`` are.     
-00041370: 2020 2020 2020 206f 6d69 7474 6564 2e0a         omitted..
-00041380: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
-00041390: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
-000413a0: 0a20 2020 2020 2020 2044 6963 7469 6f6e  .        Diction
-000413b0: 6172 7920 6d61 7070 696e 6720 776f 726b  ary mapping work
-000413c0: 6572 2049 442f 6164 6472 6573 7320 746f  er ID/address to
-000413d0: 2064 6963 7469 6f6e 6172 7920 6f66 2069   dictionary of i
-000413e0: 6e66 6f72 6d61 7469 6f6e 2061 626f 7574  nformation about
-000413f0: 0a20 2020 2020 2020 2074 6861 7420 776f  .        that wo
-00041400: 726b 6572 2066 6f72 2065 6163 6820 7265  rker for each re
-00041410: 7469 7265 6420 776f 726b 6572 2e0a 0a20  tired worker... 
-00041420: 2020 2020 2020 2049 6620 7468 6572 6520         If there 
-00041430: 6172 6520 6b65 7973 2074 6861 7420 6578  are keys that ex
-00041440: 6973 7420 696e 206d 656d 6f72 7920 6f6e  ist in memory on
-00041450: 6c79 206f 6e20 7468 6520 776f 726b 6572  ly on the worker
-00041460: 7320 6265 696e 6720 7265 7469 7265 6420  s being retired 
-00041470: 616e 6420 6974 0a20 2020 2020 2020 2077  and it.        w
-00041480: 6173 2069 6d70 6f73 7369 626c 6520 746f  as impossible to
-00041490: 2072 6570 6c69 6361 7465 2074 6865 6d20   replicate them 
-000414a0: 736f 6d65 7768 6572 6520 656c 7365 2028  somewhere else (
-000414b0: 652e 672e 2062 6563 6175 7365 2074 6865  e.g. because the
-000414c0: 7265 2061 7265 6e27 740a 2020 2020 2020  re aren't.      
-000414d0: 2020 616e 7920 6f74 6865 7220 7275 6e6e    any other runn
-000414e0: 696e 6720 776f 726b 6572 7329 2c20 7468  ing workers), th
-000414f0: 6520 776f 726b 6572 7320 686f 6c64 696e  e workers holdin
-00041500: 6720 7375 6368 206b 6579 7320 776f 6e27  g such keys won'
-00041510: 7420 6265 2072 6574 6972 6564 2061 6e64  t be retired and
-00041520: 0a20 2020 2020 2020 2077 6f6e 2774 2061  .        won't a
-00041530: 7070 6561 7220 696e 2074 6865 2072 6574  ppear in the ret
-00041540: 7572 6e65 6420 6469 6374 2e0a 0a20 2020  urned dict...   
-00041550: 2020 2020 2053 6565 2041 6c73 6f0a 2020       See Also.  
-00041560: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20        --------. 
-00041570: 2020 2020 2020 2053 6368 6564 756c 6572         Scheduler
-00041580: 2e77 6f72 6b65 7273 5f74 6f5f 636c 6f73  .workers_to_clos
-00041590: 650a 2020 2020 2020 2020 2222 220a 2020  e.        """.  
-000415a0: 2020 2020 2020 6966 206e 616d 6573 2069        if names i
-000415b0: 7320 6e6f 7420 4e6f 6e65 2061 6e64 2077  s not None and w
-000415c0: 6f72 6b65 7273 2069 7320 6e6f 7420 4e6f  orkers is not No
-000415d0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-000415e0: 7261 6973 6520 5479 7065 4572 726f 7228  raise TypeError(
-000415f0: 226e 616d 6573 2061 6e64 2077 6f72 6b65  "names and worke
-00041600: 7273 2061 7265 206d 7574 7561 6c6c 7920  rs are mutually 
-00041610: 6578 636c 7573 6976 6522 290a 2020 2020  exclusive").    
-00041620: 2020 2020 6966 2028 6e61 6d65 7320 6973      if (names is
-00041630: 206e 6f74 204e 6f6e 6520 6f72 2077 6f72   not None or wor
-00041640: 6b65 7273 2069 7320 6e6f 7420 4e6f 6e65  kers is not None
-00041650: 2920 616e 6420 6b77 6172 6773 3a0a 2020  ) and kwargs:.  
-00041660: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00041670: 5479 7065 4572 726f 7228 0a20 2020 2020  TypeError(.     
-00041680: 2020 2020 2020 2020 2020 2022 5061 7261             "Para
-00041690: 6d65 7465 7273 2066 6f72 2077 6f72 6b65  meters for worke
-000416a0: 7273 5f74 6f5f 636c 6f73 6528 2920 6172  rs_to_close() ar
-000416b0: 6520 6d75 7475 616c 6c79 2065 7863 6c75  e mutually exclu
-000416c0: 7369 7665 2077 6974 6820 220a 2020 2020  sive with ".    
-000416d0: 2020 2020 2020 2020 2020 2020 6622 6e61              f"na
-000416e0: 6d65 7320 616e 6420 776f 726b 6572 733a  mes and workers:
-000416f0: 207b 6b77 6172 6773 7d22 0a20 2020 2020   {kwargs}".     
-00041700: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00041710: 2020 7374 696d 756c 7573 5f69 6420 3d20    stimulus_id = 
-00041720: 7374 696d 756c 7573 5f69 6420 6f72 2066  stimulus_id or f
-00041730: 2272 6574 6972 652d 776f 726b 6572 732d  "retire-workers-
-00041740: 7b74 696d 6528 297d 220a 2020 2020 2020  {time()}".      
-00041750: 2020 2320 5468 6973 206c 6f63 6b20 6d61    # This lock ma
-00041760: 6b65 7320 7265 7469 7265 5f77 6f72 6b65  kes retire_worke
-00041770: 7273 2c20 7265 6261 6c61 6e63 652c 2061  rs, rebalance, a
-00041780: 6e64 2072 6570 6c69 6361 7465 206d 7574  nd replicate mut
-00041790: 7561 6c6c 790a 2020 2020 2020 2020 2320  ually.        # 
-000417a0: 6578 636c 7573 6976 6520 616e 6420 7769  exclusive and wi
-000417b0: 6c6c 206e 6f20 6c6f 6e67 6572 2062 6520  ll no longer be 
-000417c0: 6e65 6365 7373 6172 7920 6f6e 6365 2072  necessary once r
-000417d0: 6562 616c 616e 6365 2061 6e64 2072 6570  ebalance and rep
-000417e0: 6c69 6361 7465 2061 7265 0a20 2020 2020  licate are.     
-000417f0: 2020 2023 206d 6967 7261 7465 6420 746f     # migrated to
-00041800: 2074 6865 2041 6374 6976 6520 4d65 6d6f   the Active Memo
-00041810: 7279 204d 616e 6167 6572 2e0a 2020 2020  ry Manager..    
-00041820: 2020 2020 2320 486f 7765 7665 722c 2069      # However, i
-00041830: 7420 616c 6c6f 7773 206d 756c 7469 706c  t allows multipl
-00041840: 6520 696e 7374 616e 6365 7320 6f66 2072  e instances of r
-00041850: 6574 6972 655f 776f 726b 6572 7320 746f  etire_workers to
-00041860: 2072 756e 2069 6e20 7061 7261 6c6c 656c   run in parallel
-00041870: 2e0a 2020 2020 2020 2020 6173 796e 6320  ..        async 
-00041880: 7769 7468 2073 656c 662e 5f72 6570 6c69  with self._repli
-00041890: 6361 5f6c 6f63 6b28 2272 6574 6972 652d  ca_lock("retire-
-000418a0: 776f 726b 6572 7322 293a 0a20 2020 2020  workers"):.     
-000418b0: 2020 2020 2020 2069 6620 6e61 6d65 7320         if names 
-000418c0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-000418d0: 2020 2020 2020 2020 2020 2020 206c 6f67               log
-000418e0: 6765 722e 696e 666f 2822 5265 7469 7265  ger.info("Retire
-000418f0: 2077 6f72 6b65 7220 6e61 6d65 7320 2573   worker names %s
-00041900: 222c 206e 616d 6573 290a 2020 2020 2020  ", names).      
-00041910: 2020 2020 2020 2020 2020 2320 5375 7070            # Supp
-00041920: 6f72 7420 6361 7365 7320 7768 6572 6520  ort cases where 
-00041930: 6e61 6d65 7320 6172 6520 7061 7373 6564  names are passed
-00041940: 2074 6872 6f75 6768 2061 2043 4c49 2061   through a CLI a
-00041950: 6e64 2062 6563 6f6d 6520 7374 7269 6e67  nd become string
-00041960: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-00041970: 2020 6e61 6d65 735f 7365 7420 3d20 7b73    names_set = {s
-00041980: 7472 286e 616d 6529 2066 6f72 206e 616d  tr(name) for nam
-00041990: 6520 696e 206e 616d 6573 7d0a 2020 2020  e in names}.    
-000419a0: 2020 2020 2020 2020 2020 2020 7773 7320              wss 
-000419b0: 3d20 7b77 7320 666f 7220 7773 2069 6e20  = {ws for ws in 
-000419c0: 7365 6c66 2e77 6f72 6b65 7273 2e76 616c  self.workers.val
-000419d0: 7565 7328 2920 6966 2073 7472 2877 732e  ues() if str(ws.
-000419e0: 6e61 6d65 2920 696e 206e 616d 6573 5f73  name) in names_s
-000419f0: 6574 7d0a 2020 2020 2020 2020 2020 2020  et}.            
-00041a00: 656c 6966 2077 6f72 6b65 7273 2069 7320  elif workers is 
-00041a10: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00041a20: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-00041a30: 2e69 6e66 6f28 2252 6574 6972 6520 776f  .info("Retire wo
-00041a40: 726b 6572 2061 6464 7265 7373 6573 2025  rker addresses %
-00041a50: 7322 2c20 776f 726b 6572 7329 0a20 2020  s", workers).   
-00041a60: 2020 2020 2020 2020 2020 2020 2077 7373               wss
-00041a70: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-00041a80: 2020 2020 2020 2020 2073 656c 662e 776f           self.wo
-00041a90: 726b 6572 735b 6164 6472 6573 735d 0a20  rkers[address]. 
-00041aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041ab0: 2020 2066 6f72 2061 6464 7265 7373 2069     for address i
-00041ac0: 6e20 776f 726b 6572 730a 2020 2020 2020  n workers.      
-00041ad0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00041ae0: 2061 6464 7265 7373 2069 6e20 7365 6c66   address in self
-00041af0: 2e77 6f72 6b65 7273 0a20 2020 2020 2020  .workers.       
-00041b00: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-00041b10: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0003f190: 206e 5f6d 6973 7369 6e67 203d 206e 202d   n_missing = n -
+0003f1a0: 206c 656e 2874 732e 7768 6f5f 6861 7320   len(ts.who_has 
+0003f1b0: 2620 776f 726b 6572 7329 0a20 2020 2020  & workers).     
+0003f1c0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0003f1d0: 6620 6e5f 6d69 7373 696e 6720 3c3d 2030  f n_missing <= 0
+0003f1e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003f1f0: 2020 2020 2020 2020 2020 2320 416c 7265            # Alre
+0003f200: 6164 7920 7265 706c 6963 6174 6564 2065  ady replicated e
+0003f210: 6e6f 7567 680a 2020 2020 2020 2020 2020  nough.          
+0003f220: 2020 2020 2020 2020 2020 2020 2020 7461                ta
+0003f230: 736b 732e 7265 6d6f 7665 2874 7329 0a20  sks.remove(ts). 
+0003f240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f250: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
+0003f260: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003f270: 2020 2020 2063 6f75 6e74 203d 206d 696e       count = min
+0003f280: 286e 5f6d 6973 7369 6e67 2c20 6272 616e  (n_missing, bran
+0003f290: 6368 696e 675f 6661 6374 6f72 202a 206c  ching_factor * l
+0003f2a0: 656e 2874 732e 7768 6f5f 6861 7329 290a  en(ts.who_has)).
+0003f2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f2c0: 2020 2020 6173 7365 7274 2063 6f75 6e74      assert count
+0003f2d0: 203e 2030 0a0a 2020 2020 2020 2020 2020   > 0..          
+0003f2e0: 2020 2020 2020 2020 2020 666f 7220 7773            for ws
+0003f2f0: 2069 6e20 7261 6e64 6f6d 2e73 616d 706c   in random.sampl
+0003f300: 6528 7475 706c 6528 776f 726b 6572 7320  e(tuple(workers 
+0003f310: 2d20 7473 2e77 686f 5f68 6173 292c 2063  - ts.who_has), c
+0003f320: 6f75 6e74 293a 0a20 2020 2020 2020 2020  ount):.         
+0003f330: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0003f340: 6174 6865 7273 5b77 732e 6164 6472 6573  athers[ws.addres
+0003f350: 735d 5b74 732e 6b65 795d 203d 205b 0a20  s][ts.key] = [. 
+0003f360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f370: 2020 2020 2020 2020 2020 2077 7773 2e61             wws.a
+0003f380: 6464 7265 7373 2066 6f72 2077 7773 2069  ddress for wws i
+0003f390: 6e20 7473 2e77 686f 5f68 6173 0a20 2020  n ts.who_has.   
+0003f3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f3b0: 2020 2020 205d 0a0a 2020 2020 2020 2020       ]..        
+0003f3c0: 2020 2020 2020 2020 6177 6169 7420 6173          await as
+0003f3d0: 796e 6369 6f2e 6761 7468 6572 280a 2020  yncio.gather(.  
+0003f3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f3f0: 2020 2a28 0a20 2020 2020 2020 2020 2020    *(.           
+0003f400: 2020 2020 2020 2020 2020 2020 2023 204e               # N
+0003f410: 6f74 653a 2074 6869 7320 6e65 7665 7220  ote: this never 
+0003f420: 7261 6973 6573 2065 7863 6570 7469 6f6e  raises exception
+0003f430: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+0003f440: 2020 2020 2020 2020 2020 7365 6c66 2e67            self.g
+0003f450: 6174 6865 725f 6f6e 5f77 6f72 6b65 7228  ather_on_worker(
+0003f460: 772c 2077 686f 5f68 6173 290a 2020 2020  w, who_has).    
+0003f470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f480: 2020 2020 666f 7220 772c 2077 686f 5f68      for w, who_h
+0003f490: 6173 2069 6e20 6761 7468 6572 732e 6974  as in gathers.it
+0003f4a0: 656d 7328 290a 2020 2020 2020 2020 2020  ems().          
+0003f4b0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0003f4c0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0003f4d0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+0003f4e0: 7220 722c 2076 2069 6e20 6761 7468 6572  r r, v in gather
+0003f4f0: 732e 6974 656d 7328 293a 0a20 2020 2020  s.items():.     
+0003f500: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0003f510: 656c 662e 6c6f 675f 6576 656e 7428 722c  elf.log_event(r,
+0003f520: 207b 2261 6374 696f 6e22 3a20 2272 6570   {"action": "rep
+0003f530: 6c69 6361 7465 2d61 6464 222c 2022 7768  licate-add", "wh
+0003f540: 6f5f 6861 7322 3a20 767d 290a 0a20 2020  o_has": v})..   
+0003f550: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
+0003f560: 675f 6576 656e 7428 0a20 2020 2020 2020  g_event(.       
+0003f570: 2020 2020 2020 2020 2022 616c 6c22 2c0a           "all",.
+0003f580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f590: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0003f5a0: 2020 2020 2020 2261 6374 696f 6e22 3a20        "action": 
+0003f5b0: 2272 6570 6c69 6361 7465 222c 0a20 2020  "replicate",.   
+0003f5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f5d0: 2022 776f 726b 6572 7322 3a20 6c69 7374   "workers": list
+0003f5e0: 2877 6f72 6b65 7273 292c 0a20 2020 2020  (workers),.     
+0003f5f0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0003f600: 6b65 792d 636f 756e 7422 3a20 6c65 6e28  key-count": len(
+0003f610: 6b65 7973 292c 0a20 2020 2020 2020 2020  keys),.         
+0003f620: 2020 2020 2020 2020 2020 2022 6272 616e             "bran
+0003f630: 6368 696e 672d 6661 6374 6f72 223a 2062  ching-factor": b
+0003f640: 7261 6e63 6869 6e67 5f66 6163 746f 722c  ranching_factor,
+0003f650: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003f660: 207d 2c0a 2020 2020 2020 2020 2020 2020   },.            
+0003f670: 290a 0a20 2020 2040 6c6f 675f 6572 726f  )..    @log_erro
+0003f680: 7273 0a20 2020 2064 6566 2077 6f72 6b65  rs.    def worke
+0003f690: 7273 5f74 6f5f 636c 6f73 6528 0a20 2020  rs_to_close(.   
+0003f6a0: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+0003f6b0: 2020 206d 656d 6f72 795f 7261 7469 6f3a     memory_ratio:
+0003f6c0: 2069 6e74 207c 2066 6c6f 6174 207c 204e   int | float | N
+0003f6d0: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
+0003f6e0: 2020 2020 6e3a 2069 6e74 207c 204e 6f6e      n: int | Non
+0003f6f0: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
+0003f700: 2020 6b65 793a 2043 616c 6c61 626c 655b    key: Callable[
+0003f710: 5b57 6f72 6b65 7253 7461 7465 5d2c 2048  [WorkerState], H
+0003f720: 6173 6861 626c 655d 207c 2062 7974 6573  ashable] | bytes
+0003f730: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
+0003f740: 2020 2020 2020 2020 6d69 6e69 6d75 6d3a          minimum:
+0003f750: 2069 6e74 207c 204e 6f6e 6520 3d20 4e6f   int | None = No
+0003f760: 6e65 2c0a 2020 2020 2020 2020 7461 7267  ne,.        targ
+0003f770: 6574 3a20 696e 7420 7c20 4e6f 6e65 203d  et: int | None =
+0003f780: 204e 6f6e 652c 0a20 2020 2020 2020 2061   None,.        a
+0003f790: 7474 7269 6275 7465 3a20 7374 7220 3d20  ttribute: str = 
+0003f7a0: 2261 6464 7265 7373 222c 0a20 2020 2029  "address",.    )
+0003f7b0: 202d 3e20 6c69 7374 5b73 7472 5d3a 0a20   -> list[str]:. 
+0003f7c0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0003f7d0: 2020 2046 696e 6420 776f 726b 6572 7320     Find workers 
+0003f7e0: 7468 6174 2077 6520 6361 6e20 636c 6f73  that we can clos
+0003f7f0: 6520 7769 7468 206c 6f77 2063 6f73 740a  e with low cost.
+0003f800: 0a20 2020 2020 2020 2054 6869 7320 7265  .        This re
+0003f810: 7475 726e 7320 6120 6c69 7374 206f 6620  turns a list of 
+0003f820: 776f 726b 6572 7320 7468 6174 2061 7265  workers that are
+0003f830: 2067 6f6f 6420 6361 6e64 6964 6174 6573   good candidates
+0003f840: 2074 6f20 7265 7469 7265 2e0a 2020 2020   to retire..    
+0003f850: 2020 2020 5468 6573 6520 776f 726b 6572      These worker
+0003f860: 7320 6172 6520 6e6f 7420 7275 6e6e 696e  s are not runnin
+0003f870: 6720 616e 7974 6869 6e67 2061 6e64 2061  g anything and a
+0003f880: 7265 2073 746f 7269 6e67 0a20 2020 2020  re storing.     
+0003f890: 2020 2072 656c 6174 6976 656c 7920 6c69     relatively li
+0003f8a0: 7474 6c65 2064 6174 6120 7265 6c61 7469  ttle data relati
+0003f8b0: 7665 2074 6f20 7468 6569 7220 7065 6572  ve to their peer
+0003f8c0: 732e 2020 4966 2061 6c6c 2077 6f72 6b65  s.  If all worke
+0003f8d0: 7273 2061 7265 0a20 2020 2020 2020 2069  rs are.        i
+0003f8e0: 646c 6520 7468 656e 2077 6520 7374 696c  dle then we stil
+0003f8f0: 6c20 6d61 696e 7461 696e 2065 6e6f 7567  l maintain enoug
+0003f900: 6820 776f 726b 6572 7320 746f 2068 6176  h workers to hav
+0003f910: 6520 656e 6f75 6768 2052 414d 2074 6f20  e enough RAM to 
+0003f920: 7374 6f72 650a 2020 2020 2020 2020 6f75  store.        ou
+0003f930: 7220 6461 7461 2c20 7769 7468 2061 2063  r data, with a c
+0003f940: 6f6d 666f 7274 6162 6c65 2062 7566 6665  omfortable buffe
+0003f950: 722e 0a0a 2020 2020 2020 2020 5468 6973  r...        This
+0003f960: 2069 7320 666f 7220 7573 6520 7769 7468   is for use with
+0003f970: 2073 7973 7465 6d73 206c 696b 6520 6060   systems like ``
+0003f980: 6469 7374 7269 6275 7465 642e 6465 706c  distributed.depl
+0003f990: 6f79 2e61 6461 7074 6976 6560 602e 0a0a  oy.adaptive``...
+0003f9a0: 2020 2020 2020 2020 5061 7261 6d65 7465          Paramete
+0003f9b0: 7273 0a20 2020 2020 2020 202d 2d2d 2d2d  rs.        -----
+0003f9c0: 2d2d 2d2d 2d0a 2020 2020 2020 2020 6d65  -----.        me
+0003f9d0: 6d6f 7279 5f72 6174 696f 203a 204e 756d  mory_ratio : Num
+0003f9e0: 6265 720a 2020 2020 2020 2020 2020 2020  ber.            
+0003f9f0: 416d 6f75 6e74 206f 6620 6578 7472 6120  Amount of extra 
+0003fa00: 7370 6163 6520 7765 2077 616e 7420 746f  space we want to
+0003fa10: 2068 6176 6520 666f 7220 6f75 7220 7374   have for our st
+0003fa20: 6f72 6564 2064 6174 612e 0a20 2020 2020  ored data..     
+0003fa30: 2020 2020 2020 2044 6566 6175 6c74 7320         Defaults 
+0003fa40: 746f 2032 2c20 6f72 2074 6861 7420 7765  to 2, or that we
+0003fa50: 2077 616e 7420 746f 2068 6176 6520 7477   want to have tw
+0003fa60: 6963 6520 6173 206d 7563 6820 6d65 6d6f  ice as much memo
+0003fa70: 7279 2061 7320 7765 0a20 2020 2020 2020  ry as we.       
+0003fa80: 2020 2020 2063 7572 7265 6e74 6c79 2068       currently h
+0003fa90: 6176 6520 6461 7461 2e0a 2020 2020 2020  ave data..      
+0003faa0: 2020 6e20 3a20 696e 740a 2020 2020 2020    n : int.      
+0003fab0: 2020 2020 2020 4e75 6d62 6572 206f 6620        Number of 
+0003fac0: 776f 726b 6572 7320 746f 2063 6c6f 7365  workers to close
+0003fad0: 0a20 2020 2020 2020 206d 696e 696d 756d  .        minimum
+0003fae0: 203a 2069 6e74 0a20 2020 2020 2020 2020   : int.         
+0003faf0: 2020 204d 696e 696d 756d 206e 756d 6265     Minimum numbe
+0003fb00: 7220 6f66 2077 6f72 6b65 7273 2074 6f20  r of workers to 
+0003fb10: 6b65 6570 2061 726f 756e 640a 2020 2020  keep around.    
+0003fb20: 2020 2020 6b65 7920 3a20 4361 6c6c 6162      key : Callab
+0003fb30: 6c65 2857 6f72 6b65 7253 7461 7465 290a  le(WorkerState).
+0003fb40: 2020 2020 2020 2020 2020 2020 416e 206f              An o
+0003fb50: 7074 696f 6e61 6c20 6361 6c6c 6162 6c65  ptional callable
+0003fb60: 206d 6170 7069 6e67 2061 2057 6f72 6b65   mapping a Worke
+0003fb70: 7253 7461 7465 206f 626a 6563 7420 746f  rState object to
+0003fb80: 2061 2067 726f 7570 0a20 2020 2020 2020   a group.       
+0003fb90: 2020 2020 2061 6666 696c 6961 7469 6f6e       affiliation
+0003fba0: 2e20 4772 6f75 7073 2077 696c 6c20 6265  . Groups will be
+0003fbb0: 2063 6c6f 7365 6420 746f 6765 7468 6572   closed together
+0003fbc0: 2e20 5468 6973 2069 7320 7573 6566 756c  . This is useful
+0003fbd0: 2077 6865 6e0a 2020 2020 2020 2020 2020   when.          
+0003fbe0: 2020 636c 6f73 696e 6720 776f 726b 6572    closing worker
+0003fbf0: 7320 6d75 7374 2062 6520 646f 6e65 2063  s must be done c
+0003fc00: 6f6c 6c65 6374 6976 656c 792c 2073 7563  ollectively, suc
+0003fc10: 6820 6173 2062 7920 686f 7374 6e61 6d65  h as by hostname
+0003fc20: 2e0a 2020 2020 2020 2020 7461 7267 6574  ..        target
+0003fc30: 203a 2069 6e74 0a20 2020 2020 2020 2020   : int.         
+0003fc40: 2020 2054 6172 6765 7420 6e75 6d62 6572     Target number
+0003fc50: 206f 6620 776f 726b 6572 7320 746f 2068   of workers to h
+0003fc60: 6176 6520 6166 7465 7220 7765 2063 6c6f  ave after we clo
+0003fc70: 7365 0a20 2020 2020 2020 2061 7474 7269  se.        attri
+0003fc80: 6275 7465 203a 2073 7472 0a20 2020 2020  bute : str.     
+0003fc90: 2020 2020 2020 2054 6865 2061 7474 7269         The attri
+0003fca0: 6275 7465 206f 6620 7468 6520 576f 726b  bute of the Work
+0003fcb0: 6572 5374 6174 6520 6f62 6a65 6374 2074  erState object t
+0003fcc0: 6f20 7265 7475 726e 2c20 6c69 6b65 2022  o return, like "
+0003fcd0: 6164 6472 6573 7322 0a20 2020 2020 2020  address".       
+0003fce0: 2020 2020 206f 7220 226e 616d 6522 2e20       or "name". 
+0003fcf0: 2044 6566 6175 6c74 7320 746f 2022 6164   Defaults to "ad
+0003fd00: 6472 6573 7322 2e0a 0a20 2020 2020 2020  dress"...       
+0003fd10: 2045 7861 6d70 6c65 730a 2020 2020 2020   Examples.      
+0003fd20: 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020    --------.     
+0003fd30: 2020 203e 3e3e 2073 6368 6564 756c 6572     >>> scheduler
+0003fd40: 2e77 6f72 6b65 7273 5f74 6f5f 636c 6f73  .workers_to_clos
+0003fd50: 6528 290a 2020 2020 2020 2020 5b27 7463  e().        ['tc
+0003fd60: 703a 2f2f 3139 322e 3136 382e 302e 313a  p://192.168.0.1:
+0003fd70: 3132 3334 272c 2027 7463 703a 2f2f 3139  1234', 'tcp://19
+0003fd80: 322e 3136 382e 302e 323a 3132 3334 275d  2.168.0.2:1234']
+0003fd90: 0a0a 2020 2020 2020 2020 4772 6f75 7020  ..        Group 
+0003fda0: 776f 726b 6572 7320 6279 2068 6f73 746e  workers by hostn
+0003fdb0: 616d 6520 7072 696f 7220 746f 2063 6c6f  ame prior to clo
+0003fdc0: 7369 6e67 0a0a 2020 2020 2020 2020 3e3e  sing..        >>
+0003fdd0: 3e20 7363 6865 6475 6c65 722e 776f 726b  > scheduler.work
+0003fde0: 6572 735f 746f 5f63 6c6f 7365 286b 6579  ers_to_close(key
+0003fdf0: 3d6c 616d 6264 6120 7773 3a20 7773 2e68  =lambda ws: ws.h
+0003fe00: 6f73 7429 0a20 2020 2020 2020 205b 2774  ost).        ['t
+0003fe10: 6370 3a2f 2f31 3932 2e31 3638 2e30 2e31  cp://192.168.0.1
+0003fe20: 3a31 3233 3427 2c20 2774 6370 3a2f 2f31  :1234', 'tcp://1
+0003fe30: 3932 2e31 3638 2e30 2e31 3a34 3536 3727  92.168.0.1:4567'
+0003fe40: 5d0a 0a20 2020 2020 2020 2052 656d 6f76  ]..        Remov
+0003fe50: 6520 7477 6f20 776f 726b 6572 730a 0a20  e two workers.. 
+0003fe60: 2020 2020 2020 203e 3e3e 2073 6368 6564         >>> sched
+0003fe70: 756c 6572 2e77 6f72 6b65 7273 5f74 6f5f  uler.workers_to_
+0003fe80: 636c 6f73 6528 6e3d 3229 0a0a 2020 2020  close(n=2)..    
+0003fe90: 2020 2020 4b65 6570 2065 6e6f 7567 6820      Keep enough 
+0003fea0: 776f 726b 6572 7320 746f 2068 6176 6520  workers to have 
+0003feb0: 7477 6963 6520 6173 206d 7563 6820 6d65  twice as much me
+0003fec0: 6d6f 7279 2061 7320 7765 2077 6520 6e65  mory as we we ne
+0003fed0: 6564 2e0a 0a20 2020 2020 2020 203e 3e3e  ed...        >>>
+0003fee0: 2073 6368 6564 756c 6572 2e77 6f72 6b65   scheduler.worke
+0003fef0: 7273 5f74 6f5f 636c 6f73 6528 6d65 6d6f  rs_to_close(memo
+0003ff00: 7279 5f72 6174 696f 3d32 290a 0a20 2020  ry_ratio=2)..   
+0003ff10: 2020 2020 2052 6574 7572 6e73 0a20 2020       Returns.   
+0003ff20: 2020 2020 202d 2d2d 2d2d 2d2d 0a20 2020       -------.   
+0003ff30: 2020 2020 2074 6f5f 636c 6f73 653a 206c       to_close: l
+0003ff40: 6973 7420 6f66 2077 6f72 6b65 7220 6164  ist of worker ad
+0003ff50: 6472 6573 7365 7320 7468 6174 2061 7265  dresses that are
+0003ff60: 204f 4b20 746f 2063 6c6f 7365 0a0a 2020   OK to close..  
+0003ff70: 2020 2020 2020 5365 6520 416c 736f 0a20        See Also. 
+0003ff80: 2020 2020 2020 202d 2d2d 2d2d 2d2d 2d0a         --------.
+0003ff90: 2020 2020 2020 2020 5363 6865 6475 6c65          Schedule
+0003ffa0: 722e 7265 7469 7265 5f77 6f72 6b65 7273  r.retire_workers
+0003ffb0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0003ffc0: 2020 2020 2069 6620 7461 7267 6574 2069       if target i
+0003ffd0: 7320 6e6f 7420 4e6f 6e65 2061 6e64 206e  s not None and n
+0003ffe0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0003fff0: 2020 2020 2020 6e20 3d20 6c65 6e28 7365        n = len(se
+00040000: 6c66 2e77 6f72 6b65 7273 2920 2d20 7461  lf.workers) - ta
+00040010: 7267 6574 0a20 2020 2020 2020 2069 6620  rget.        if 
+00040020: 6e20 6973 206e 6f74 204e 6f6e 653a 0a20  n is not None:. 
+00040030: 2020 2020 2020 2020 2020 2069 6620 6e20             if n 
+00040040: 3c20 303a 0a20 2020 2020 2020 2020 2020  < 0:.           
+00040050: 2020 2020 206e 203d 2030 0a20 2020 2020       n = 0.     
+00040060: 2020 2020 2020 2074 6172 6765 7420 3d20         target = 
+00040070: 6c65 6e28 7365 6c66 2e77 6f72 6b65 7273  len(self.workers
+00040080: 2920 2d20 6e0a 0a20 2020 2020 2020 2069  ) - n..        i
+00040090: 6620 6e20 6973 204e 6f6e 6520 616e 6420  f n is None and 
+000400a0: 6d65 6d6f 7279 5f72 6174 696f 2069 7320  memory_ratio is 
+000400b0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+000400c0: 2020 6d65 6d6f 7279 5f72 6174 696f 203d    memory_ratio =
+000400d0: 2032 0a0a 2020 2020 2020 2020 6966 206e   2..        if n
+000400e0: 6f74 206e 2061 6e64 2061 6c6c 285b 7773  ot n and all([ws
+000400f0: 2e70 726f 6365 7373 696e 6720 666f 7220  .processing for 
+00040100: 7773 2069 6e20 7365 6c66 2e77 6f72 6b65  ws in self.worke
+00040110: 7273 2e76 616c 7565 7328 295d 293a 0a20  rs.values()]):. 
+00040120: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00040130: 6e20 5b5d 0a0a 2020 2020 2020 2020 6966  n []..        if
+00040140: 206b 6579 2069 7320 4e6f 6e65 3a0a 2020   key is None:.  
+00040150: 2020 2020 2020 2020 2020 6b65 7920 3d20            key = 
+00040160: 6f70 6572 6174 6f72 2e61 7474 7267 6574  operator.attrget
+00040170: 7465 7228 2261 6464 7265 7373 2229 0a20  ter("address"). 
+00040180: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+00040190: 616e 6365 286b 6579 2c20 6279 7465 7329  ance(key, bytes)
+000401a0: 3a0a 2020 2020 2020 2020 2020 2020 6b65  :.            ke
+000401b0: 7920 3d20 7069 636b 6c65 2e6c 6f61 6473  y = pickle.loads
+000401c0: 286b 6579 290a 0a20 2020 2020 2020 2023  (key)..        #
+000401d0: 204c 6f6e 6720 7275 6e6e 696e 6720 7461   Long running ta
+000401e0: 736b 7320 7479 7069 6361 6c6c 7920 7573  sks typically us
+000401f0: 6520 6120 776f 726b 6572 5f63 6c69 656e  e a worker_clien
+00040200: 7420 746f 2073 6368 6564 756c 650a 2020  t to schedule.  
+00040210: 2020 2020 2020 2320 6f74 6865 7220 7461        # other ta
+00040220: 736b 732e 2057 6520 7368 6f75 6c64 206e  sks. We should n
+00040230: 6576 6572 2073 6875 7420 646f 776e 2074  ever shut down t
+00040240: 6865 2077 6f72 6b65 7220 7468 6579 2772  he worker they'r
+00040250: 650a 2020 2020 2020 2020 2320 7275 6e6e  e.        # runn
+00040260: 696e 6720 6f6e 2c20 6173 2069 7420 776f  ing on, as it wo
+00040270: 756c 6420 6361 7573 6520 7468 656d 2074  uld cause them t
+00040280: 6f20 7265 7374 6172 7420 6672 6f6d 2073  o restart from s
+00040290: 6372 6174 6368 0a20 2020 2020 2020 2023  cratch.        #
+000402a0: 2073 6f6d 6577 6865 7265 2065 6c73 652e   somewhere else.
+000402b0: 0a20 2020 2020 2020 2076 616c 6964 5f77  .        valid_w
+000402c0: 6f72 6b65 7273 203d 205b 7773 2066 6f72  orkers = [ws for
+000402d0: 2077 7320 696e 2073 656c 662e 776f 726b   ws in self.work
+000402e0: 6572 732e 7661 6c75 6573 2829 2069 6620  ers.values() if 
+000402f0: 6e6f 7420 7773 2e6c 6f6e 675f 7275 6e6e  not ws.long_runn
+00040300: 696e 675d 0a20 2020 2020 2020 2066 6f72  ing].        for
+00040310: 2070 6c75 6769 6e20 696e 206c 6973 7428   plugin in list(
+00040320: 7365 6c66 2e70 6c75 6769 6e73 2e76 616c  self.plugins.val
+00040330: 7565 7328 2929 3a0a 2020 2020 2020 2020  ues()):.        
+00040340: 2020 2020 7661 6c69 645f 776f 726b 6572      valid_worker
+00040350: 7320 3d20 706c 7567 696e 2e76 616c 6964  s = plugin.valid
+00040360: 5f77 6f72 6b65 7273 5f64 6f77 6e73 6361  _workers_downsca
+00040370: 6c69 6e67 2873 656c 662c 2076 616c 6964  ling(self, valid
+00040380: 5f77 6f72 6b65 7273 290a 0a20 2020 2020  _workers)..     
+00040390: 2020 2067 726f 7570 7320 3d20 6772 6f75     groups = grou
+000403a0: 7062 7928 6b65 792c 2076 616c 6964 5f77  pby(key, valid_w
+000403b0: 6f72 6b65 7273 290a 0a20 2020 2020 2020  orkers)..       
+000403c0: 206c 696d 6974 5f62 7974 6573 203d 207b   limit_bytes = {
+000403d0: 6b3a 2073 756d 2877 732e 6d65 6d6f 7279  k: sum(ws.memory
+000403e0: 5f6c 696d 6974 2066 6f72 2077 7320 696e  _limit for ws in
+000403f0: 2076 2920 666f 7220 6b2c 2076 2069 6e20   v) for k, v in 
+00040400: 6772 6f75 7073 2e69 7465 6d73 2829 7d0a  groups.items()}.
+00040410: 2020 2020 2020 2020 6772 6f75 705f 6279          group_by
+00040420: 7465 7320 3d20 7b6b 3a20 7375 6d28 7773  tes = {k: sum(ws
+00040430: 2e6e 6279 7465 7320 666f 7220 7773 2069  .nbytes for ws i
+00040440: 6e20 7629 2066 6f72 206b 2c20 7620 696e  n v) for k, v in
+00040450: 2067 726f 7570 732e 6974 656d 7328 297d   groups.items()}
+00040460: 0a0a 2020 2020 2020 2020 6c69 6d69 7420  ..        limit 
+00040470: 3d20 7375 6d28 6c69 6d69 745f 6279 7465  = sum(limit_byte
+00040480: 732e 7661 6c75 6573 2829 290a 2020 2020  s.values()).    
+00040490: 2020 2020 746f 7461 6c20 3d20 7375 6d28      total = sum(
+000404a0: 6772 6f75 705f 6279 7465 732e 7661 6c75  group_bytes.valu
+000404b0: 6573 2829 290a 0a20 2020 2020 2020 2064  es())..        d
+000404c0: 6566 205f 6b65 7928 6772 6f75 7029 3a0a  ef _key(group):.
+000404d0: 2020 2020 2020 2020 2020 2020 6973 5f69              is_i
+000404e0: 646c 6520 3d20 6e6f 7420 616e 7928 5b77  dle = not any([w
+000404f0: 7773 2e70 726f 6365 7373 696e 6720 666f  ws.processing fo
+00040500: 7220 7777 7320 696e 2067 726f 7570 735b  r wws in groups[
+00040510: 6772 6f75 705d 5d29 0a20 2020 2020 2020  group]]).       
+00040520: 2020 2020 2062 7974 6573 203d 202d 6772       bytes = -gr
+00040530: 6f75 705f 6279 7465 735b 6772 6f75 705d  oup_bytes[group]
+00040540: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00040550: 7572 6e20 6973 5f69 646c 652c 2062 7974  urn is_idle, byt
+00040560: 6573 0a0a 2020 2020 2020 2020 6964 6c65  es..        idle
+00040570: 203d 2073 6f72 7465 6428 6772 6f75 7073   = sorted(groups
+00040580: 2c20 6b65 793d 5f6b 6579 290a 0a20 2020  , key=_key)..   
+00040590: 2020 2020 2074 6f5f 636c 6f73 6520 3d20       to_close = 
+000405a0: 5b5d 0a20 2020 2020 2020 206e 5f72 656d  [].        n_rem
+000405b0: 6169 6e20 3d20 6c65 6e28 7365 6c66 2e77  ain = len(self.w
+000405c0: 6f72 6b65 7273 290a 0a20 2020 2020 2020  orkers)..       
+000405d0: 2077 6869 6c65 2069 646c 653a 0a20 2020   while idle:.   
+000405e0: 2020 2020 2020 2020 2067 726f 7570 203d           group =
+000405f0: 2069 646c 652e 706f 7028 290a 2020 2020   idle.pop().    
+00040600: 2020 2020 2020 2020 6966 206e 2069 7320          if n is 
+00040610: 4e6f 6e65 2061 6e64 2061 6e79 285b 7773  None and any([ws
+00040620: 2e70 726f 6365 7373 696e 6720 666f 7220  .processing for 
+00040630: 7773 2069 6e20 6772 6f75 7073 5b67 726f  ws in groups[gro
+00040640: 7570 5d5d 293a 0a20 2020 2020 2020 2020  up]]):.         
+00040650: 2020 2020 2020 2062 7265 616b 0a0a 2020         break..  
+00040660: 2020 2020 2020 2020 2020 6966 206d 696e            if min
+00040670: 696d 756d 2061 6e64 206e 5f72 656d 6169  imum and n_remai
+00040680: 6e20 2d20 6c65 6e28 6772 6f75 7073 5b67  n - len(groups[g
+00040690: 726f 7570 5d29 203c 206d 696e 696d 756d  roup]) < minimum
+000406a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000406b0: 2020 6272 6561 6b0a 0a20 2020 2020 2020    break..       
+000406c0: 2020 2020 206c 696d 6974 202d 3d20 6c69       limit -= li
+000406d0: 6d69 745f 6279 7465 735b 6772 6f75 705d  mit_bytes[group]
+000406e0: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+000406f0: 2028 6e20 6973 206e 6f74 204e 6f6e 6520   (n is not None 
+00040700: 616e 6420 6e5f 7265 6d61 696e 202d 206c  and n_remain - l
+00040710: 656e 2867 726f 7570 735b 6772 6f75 705d  en(groups[group]
+00040720: 2920 3e3d 2028 7461 7267 6574 206f 7220  ) >= (target or 
+00040730: 3029 2920 6f72 2028 0a20 2020 2020 2020  0)) or (.       
+00040740: 2020 2020 2020 2020 206d 656d 6f72 795f           memory_
+00040750: 7261 7469 6f20 6973 206e 6f74 204e 6f6e  ratio is not Non
+00040760: 6520 616e 6420 6c69 6d69 7420 3e3d 206d  e and limit >= m
+00040770: 656d 6f72 795f 7261 7469 6f20 2a20 746f  emory_ratio * to
+00040780: 7461 6c0a 2020 2020 2020 2020 2020 2020  tal.            
+00040790: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000407a0: 2020 2074 6f5f 636c 6f73 652e 6170 7065     to_close.appe
+000407b0: 6e64 2867 726f 7570 290a 2020 2020 2020  nd(group).      
+000407c0: 2020 2020 2020 2020 2020 6e5f 7265 6d61            n_rema
+000407d0: 696e 202d 3d20 6c65 6e28 6772 6f75 7073  in -= len(groups
+000407e0: 5b67 726f 7570 5d29 0a0a 2020 2020 2020  [group])..      
+000407f0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00040800: 2020 2020 2020 2020 2020 2020 6272 6561              brea
+00040810: 6b0a 0a20 2020 2020 2020 2072 6573 756c  k..        resul
+00040820: 7420 3d20 5b67 6574 6174 7472 2877 732c  t = [getattr(ws,
+00040830: 2061 7474 7269 6275 7465 2920 666f 7220   attribute) for 
+00040840: 6720 696e 2074 6f5f 636c 6f73 6520 666f  g in to_close fo
+00040850: 7220 7773 2069 6e20 6772 6f75 7073 5b67  r ws in groups[g
+00040860: 5d5d 0a20 2020 2020 2020 2069 6620 7265  ]].        if re
+00040870: 7375 6c74 3a0a 2020 2020 2020 2020 2020  sult:.          
+00040880: 2020 6c6f 6767 6572 2e64 6562 7567 2822    logger.debug("
+00040890: 5375 6767 6573 7420 636c 6f73 696e 6720  Suggest closing 
+000408a0: 776f 726b 6572 733a 2025 7322 2c20 7265  workers: %s", re
+000408b0: 7375 6c74 290a 0a20 2020 2020 2020 2072  sult)..        r
+000408c0: 6574 7572 6e20 7265 7375 6c74 0a0a 2020  eturn result..  
+000408d0: 2020 406f 7665 726c 6f61 640a 2020 2020    @overload.    
+000408e0: 6173 796e 6320 6465 6620 7265 7469 7265  async def retire
+000408f0: 5f77 6f72 6b65 7273 280a 2020 2020 2020  _workers(.      
+00040900: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+00040910: 776f 726b 6572 733a 206c 6973 745b 7374  workers: list[st
+00040920: 725d 2c0a 2020 2020 2020 2020 2a2c 0a20  r],.        *,. 
+00040930: 2020 2020 2020 2063 6c6f 7365 5f77 6f72         close_wor
+00040940: 6b65 7273 3a20 626f 6f6c 203d 2046 616c  kers: bool = Fal
+00040950: 7365 2c0a 2020 2020 2020 2020 7265 6d6f  se,.        remo
+00040960: 7665 3a20 626f 6f6c 203d 2054 7275 652c  ve: bool = True,
+00040970: 0a20 2020 2020 2020 2073 7469 6d75 6c75  .        stimulu
+00040980: 735f 6964 3a20 7374 7220 7c20 4e6f 6e65  s_id: str | None
+00040990: 203d 204e 6f6e 652c 0a20 2020 2029 202d   = None,.    ) -
+000409a0: 3e20 6469 6374 5b73 7472 2c20 416e 795d  > dict[str, Any]
+000409b0: 3a0a 2020 2020 2020 2020 2e2e 2e0a 0a20  :.        ..... 
+000409c0: 2020 2040 6f76 6572 6c6f 6164 0a20 2020     @overload.   
+000409d0: 2061 7379 6e63 2064 6566 2072 6574 6972   async def retir
+000409e0: 655f 776f 726b 6572 7328 0a20 2020 2020  e_workers(.     
+000409f0: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+00040a00: 202a 2c0a 2020 2020 2020 2020 6e61 6d65   *,.        name
+00040a10: 733a 206c 6973 742c 0a20 2020 2020 2020  s: list,.       
+00040a20: 2063 6c6f 7365 5f77 6f72 6b65 7273 3a20   close_workers: 
+00040a30: 626f 6f6c 203d 2046 616c 7365 2c0a 2020  bool = False,.  
+00040a40: 2020 2020 2020 7265 6d6f 7665 3a20 626f        remove: bo
+00040a50: 6f6c 203d 2054 7275 652c 0a20 2020 2020  ol = True,.     
+00040a60: 2020 2073 7469 6d75 6c75 735f 6964 3a20     stimulus_id: 
+00040a70: 7374 7220 7c20 4e6f 6e65 203d 204e 6f6e  str | None = Non
+00040a80: 652c 0a20 2020 2029 202d 3e20 6469 6374  e,.    ) -> dict
+00040a90: 5b73 7472 2c20 416e 795d 3a0a 2020 2020  [str, Any]:.    
+00040aa0: 2020 2020 2e2e 2e0a 0a20 2020 2040 6f76      .....    @ov
+00040ab0: 6572 6c6f 6164 0a20 2020 2061 7379 6e63  erload.    async
+00040ac0: 2064 6566 2072 6574 6972 655f 776f 726b   def retire_work
+00040ad0: 6572 7328 0a20 2020 2020 2020 2073 656c  ers(.        sel
+00040ae0: 662c 0a20 2020 2020 2020 202a 2c0a 2020  f,.        *,.  
+00040af0: 2020 2020 2020 636c 6f73 655f 776f 726b        close_work
+00040b00: 6572 733a 2062 6f6f 6c20 3d20 4661 6c73  ers: bool = Fals
+00040b10: 652c 0a20 2020 2020 2020 2072 656d 6f76  e,.        remov
+00040b20: 653a 2062 6f6f 6c20 3d20 5472 7565 2c0a  e: bool = True,.
+00040b30: 2020 2020 2020 2020 7374 696d 756c 7573          stimulus
+00040b40: 5f69 643a 2073 7472 207c 204e 6f6e 6520  _id: str | None 
+00040b50: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00040b60: 2320 5061 7261 6d65 7465 7273 2066 6f72  # Parameters for
+00040b70: 2077 6f72 6b65 7273 5f74 6f5f 636c 6f73   workers_to_clos
+00040b80: 6528 290a 2020 2020 2020 2020 6d65 6d6f  e().        memo
+00040b90: 7279 5f72 6174 696f 3a20 696e 7420 7c20  ry_ratio: int | 
+00040ba0: 666c 6f61 7420 7c20 4e6f 6e65 203d 204e  float | None = N
+00040bb0: 6f6e 652c 0a20 2020 2020 2020 206e 3a20  one,.        n: 
+00040bc0: 696e 7420 7c20 4e6f 6e65 203d 204e 6f6e  int | None = Non
+00040bd0: 652c 0a20 2020 2020 2020 206b 6579 3a20  e,.        key: 
+00040be0: 4361 6c6c 6162 6c65 5b5b 576f 726b 6572  Callable[[Worker
+00040bf0: 5374 6174 655d 2c20 4861 7368 6162 6c65  State], Hashable
+00040c00: 5d20 7c20 6279 7465 7320 7c20 4e6f 6e65  ] | bytes | None
+00040c10: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00040c20: 206d 696e 696d 756d 3a20 696e 7420 7c20   minimum: int | 
+00040c30: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
+00040c40: 2020 2020 2074 6172 6765 743a 2069 6e74       target: int
+00040c50: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
+00040c60: 2020 2020 2020 2020 6174 7472 6962 7574          attribut
+00040c70: 653a 2073 7472 203d 2022 6164 6472 6573  e: str = "addres
+00040c80: 7322 2c0a 2020 2020 2920 2d3e 2064 6963  s",.    ) -> dic
+00040c90: 745b 7374 722c 2041 6e79 5d3a 0a20 2020  t[str, Any]:.   
+00040ca0: 2020 2020 202e 2e2e 0a0a 2020 2020 406c       .....    @l
+00040cb0: 6f67 5f65 7272 6f72 730a 2020 2020 6173  og_errors.    as
+00040cc0: 796e 6320 6465 6620 7265 7469 7265 5f77  ync def retire_w
+00040cd0: 6f72 6b65 7273 280a 2020 2020 2020 2020  orkers(.        
+00040ce0: 7365 6c66 2c0a 2020 2020 2020 2020 776f  self,.        wo
+00040cf0: 726b 6572 733a 206c 6973 745b 7374 725d  rkers: list[str]
+00040d00: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
+00040d10: 2020 2020 2020 2020 2a2c 0a20 2020 2020          *,.     
+00040d20: 2020 206e 616d 6573 3a20 6c69 7374 207c     names: list |
+00040d30: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
+00040d40: 2020 2020 2020 636c 6f73 655f 776f 726b        close_work
+00040d50: 6572 733a 2062 6f6f 6c20 3d20 4661 6c73  ers: bool = Fals
+00040d60: 652c 0a20 2020 2020 2020 2072 656d 6f76  e,.        remov
+00040d70: 653a 2062 6f6f 6c20 3d20 5472 7565 2c0a  e: bool = True,.
+00040d80: 2020 2020 2020 2020 7374 696d 756c 7573          stimulus
+00040d90: 5f69 643a 2073 7472 207c 204e 6f6e 6520  _id: str | None 
+00040da0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00040db0: 2a2a 6b77 6172 6773 3a20 416e 792c 0a20  **kwargs: Any,. 
+00040dc0: 2020 2029 202d 3e20 6469 6374 5b73 7472     ) -> dict[str
+00040dd0: 2c20 416e 795d 3a0a 2020 2020 2020 2020  , Any]:.        
+00040de0: 2222 2247 7261 6365 6675 6c6c 7920 7265  """Gracefully re
+00040df0: 7469 7265 2077 6f72 6b65 7273 2066 726f  tire workers fro
+00040e00: 6d20 636c 7573 7465 722e 2041 6e79 206b  m cluster. Any k
+00040e10: 6579 2074 6861 7420 6973 2069 6e20 6d65  ey that is in me
+00040e20: 6d6f 7279 2065 7863 6c75 7369 7665 6c79  mory exclusively
+00040e30: 0a20 2020 2020 2020 206f 6e20 7468 6520  .        on the 
+00040e40: 7265 7469 7265 6420 776f 726b 6572 7320  retired workers 
+00040e50: 6973 2072 6570 6c69 6361 7465 6420 736f  is replicated so
+00040e60: 6d65 7768 6572 6520 656c 7365 2e0a 0a20  mewhere else... 
+00040e70: 2020 2020 2020 2050 6172 616d 6574 6572         Parameter
+00040e80: 730a 2020 2020 2020 2020 2d2d 2d2d 2d2d  s.        ------
+00040e90: 2d2d 2d2d 0a20 2020 2020 2020 2077 6f72  ----.        wor
+00040ea0: 6b65 7273 3a20 6c69 7374 5b73 7472 5d20  kers: list[str] 
+00040eb0: 286f 7074 696f 6e61 6c29 0a20 2020 2020  (optional).     
+00040ec0: 2020 2020 2020 204c 6973 7420 6f66 2077         List of w
+00040ed0: 6f72 6b65 7220 6164 6472 6573 7365 7320  orker addresses 
+00040ee0: 746f 2072 6574 6972 652e 0a20 2020 2020  to retire..     
+00040ef0: 2020 206e 616d 6573 3a20 6c69 7374 2028     names: list (
+00040f00: 6f70 7469 6f6e 616c 290a 2020 2020 2020  optional).      
+00040f10: 2020 2020 2020 4c69 7374 206f 6620 776f        List of wo
+00040f20: 726b 6572 206e 616d 6573 2074 6f20 7265  rker names to re
+00040f30: 7469 7265 2e0a 2020 2020 2020 2020 2020  tire..          
+00040f40: 2020 4d75 7475 616c 6c79 2065 7863 6c75    Mutually exclu
+00040f50: 7369 7665 2077 6974 6820 6060 776f 726b  sive with ``work
+00040f60: 6572 7360 602e 0a20 2020 2020 2020 2020  ers``..         
+00040f70: 2020 2049 6620 6e65 6974 6865 7220 6060     If neither ``
+00040f80: 776f 726b 6572 7360 6020 6e6f 7220 6060  workers`` nor ``
+00040f90: 6e61 6d65 7360 6020 6172 6520 7072 6f76  names`` are prov
+00040fa0: 6964 6564 2c20 7765 2063 616c 6c0a 2020  ided, we call.  
+00040fb0: 2020 2020 2020 2020 2020 6060 776f 726b            ``work
+00040fc0: 6572 735f 746f 5f63 6c6f 7365 6060 2077  ers_to_close`` w
+00040fd0: 6869 6368 2066 696e 6473 2061 2067 6f6f  hich finds a goo
+00040fe0: 6420 7365 742e 0a20 2020 2020 2020 2063  d set..        c
+00040ff0: 6c6f 7365 5f77 6f72 6b65 7273 3a20 626f  lose_workers: bo
+00041000: 6f6c 2028 6465 6661 756c 7473 2074 6f20  ol (defaults to 
+00041010: 4661 6c73 6529 0a20 2020 2020 2020 2020  False).         
+00041020: 2020 2057 6865 7468 6572 2074 6f20 6163     Whether to ac
+00041030: 7475 616c 6c79 2063 6c6f 7365 2074 6865  tually close the
+00041040: 2077 6f72 6b65 7220 6578 706c 6963 6974   worker explicit
+00041050: 6c79 2066 726f 6d20 6865 7265 2e0a 2020  ly from here..  
+00041060: 2020 2020 2020 2020 2020 4f74 6865 7277            Otherw
+00041070: 6973 652c 2077 6520 6578 7065 6374 2073  ise, we expect s
+00041080: 6f6d 6520 6578 7465 726e 616c 206a 6f62  ome external job
+00041090: 2073 6368 6564 756c 6572 2074 6f20 6669   scheduler to fi
+000410a0: 6e69 7368 206f 6666 2074 6865 2077 6f72  nish off the wor
+000410b0: 6b65 722e 0a20 2020 2020 2020 2072 656d  ker..        rem
+000410c0: 6f76 653a 2062 6f6f 6c20 2864 6566 6175  ove: bool (defau
+000410d0: 6c74 7320 746f 2054 7275 6529 0a20 2020  lts to True).   
+000410e0: 2020 2020 2020 2020 2057 6865 7468 6572           Whether
+000410f0: 2074 6f20 7265 6d6f 7665 2074 6865 2077   to remove the w
+00041100: 6f72 6b65 7220 6d65 7461 6461 7461 2069  orker metadata i
+00041110: 6d6d 6564 6961 7465 6c79 206f 7220 656c  mmediately or el
+00041120: 7365 2077 6169 7420 666f 7220 7468 650a  se wait for the.
+00041130: 2020 2020 2020 2020 2020 2020 776f 726b              work
+00041140: 6572 2074 6f20 636f 6e74 6163 7420 7573  er to contact us
+00041150: 2e0a 0a20 2020 2020 2020 2020 2020 2049  ...            I
+00041160: 6620 636c 6f73 655f 776f 726b 6572 733d  f close_workers=
+00041170: 4661 6c73 6520 616e 6420 7265 6d6f 7665  False and remove
+00041180: 3d46 616c 7365 2c20 7468 6973 206d 6574  =False, this met
+00041190: 686f 6420 6a75 7374 2066 6c75 7368 6573  hod just flushes
+000411a0: 2074 6865 2074 6173 6b73 0a20 2020 2020   the tasks.     
+000411b0: 2020 2020 2020 2069 6e20 6d65 6d6f 7279         in memory
+000411c0: 206f 7574 206f 6620 7468 6520 776f 726b   out of the work
+000411d0: 6572 7320 616e 6420 7468 656e 2072 6574  ers and then ret
+000411e0: 7572 6e73 2e0a 2020 2020 2020 2020 2020  urns..          
+000411f0: 2020 4966 2063 6c6f 7365 5f77 6f72 6b65    If close_worke
+00041200: 7273 3d54 7275 6520 616e 6420 7265 6d6f  rs=True and remo
+00041210: 7665 3d46 616c 7365 2c20 7468 6973 206d  ve=False, this m
+00041220: 6574 686f 6420 7769 6c6c 2072 6574 7572  ethod will retur
+00041230: 6e20 7768 696c 6520 7468 650a 2020 2020  n while the.    
+00041240: 2020 2020 2020 2020 776f 726b 6572 7320          workers 
+00041250: 6172 6520 7374 696c 6c20 696e 2074 6865  are still in the
+00041260: 2063 6c75 7374 6572 2c20 616c 7468 6f75   cluster, althou
+00041270: 6768 2074 6865 7920 776f 6e27 7420 6163  gh they won't ac
+00041280: 6365 7074 206e 6577 2074 6173 6b73 2e0a  cept new tasks..
+00041290: 2020 2020 2020 2020 2020 2020 4966 2063              If c
+000412a0: 6c6f 7365 5f77 6f72 6b65 7273 3d46 616c  lose_workers=Fal
+000412b0: 7365 206f 7220 666f 7220 7768 6174 6576  se or for whatev
+000412c0: 6572 2072 6561 736f 6e20 6120 776f 726b  er reason a work
+000412d0: 6572 2064 6f65 736e 2774 2061 6363 6570  er doesn't accep
+000412e0: 7420 7468 650a 2020 2020 2020 2020 2020  t the.          
+000412f0: 2020 636c 6f73 6520 636f 6d6d 616e 642c    close command,
+00041300: 2069 7420 7769 6c6c 2062 6520 6c65 6674   it will be left
+00041310: 2070 6572 6d61 6e65 6e74 6c79 2075 6e61   permanently una
+00041320: 626c 6520 746f 2061 6363 6570 7420 6e65  ble to accept ne
+00041330: 7720 7461 736b 7320 616e 640a 2020 2020  w tasks and.    
+00041340: 2020 2020 2020 2020 6974 2069 7320 6578          it is ex
+00041350: 7065 6374 6564 2074 6f20 6265 2063 6c6f  pected to be clo
+00041360: 7365 6420 696e 2073 6f6d 6520 6f74 6865  sed in some othe
+00041370: 7220 7761 792e 0a0a 2020 2020 2020 2020  r way...        
+00041380: 2a2a 6b77 6172 6773 3a20 6469 6374 0a20  **kwargs: dict. 
+00041390: 2020 2020 2020 2020 2020 2045 7874 7261             Extra
+000413a0: 206f 7074 696f 6e73 2074 6f20 7061 7373   options to pass
+000413b0: 2074 6f20 776f 726b 6572 735f 746f 5f63   to workers_to_c
+000413c0: 6c6f 7365 2074 6f20 6465 7465 726d 696e  lose to determin
+000413d0: 6520 7768 6963 680a 2020 2020 2020 2020  e which.        
+000413e0: 2020 2020 776f 726b 6572 7320 7765 2073      workers we s
+000413f0: 686f 756c 6420 6472 6f70 2e20 4f6e 6c79  hould drop. Only
+00041400: 2061 6363 6570 7465 6420 6966 2060 6077   accepted if ``w
+00041410: 6f72 6b65 7273 6060 2061 6e64 2060 606e  orkers`` and ``n
+00041420: 616d 6573 6060 2061 7265 0a20 2020 2020  ames`` are.     
+00041430: 2020 2020 2020 206f 6d69 7474 6564 2e0a         omitted..
+00041440: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
+00041450: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
+00041460: 0a20 2020 2020 2020 2044 6963 7469 6f6e  .        Diction
+00041470: 6172 7920 6d61 7070 696e 6720 776f 726b  ary mapping work
+00041480: 6572 2049 442f 6164 6472 6573 7320 746f  er ID/address to
+00041490: 2064 6963 7469 6f6e 6172 7920 6f66 2069   dictionary of i
+000414a0: 6e66 6f72 6d61 7469 6f6e 2061 626f 7574  nformation about
+000414b0: 0a20 2020 2020 2020 2074 6861 7420 776f  .        that wo
+000414c0: 726b 6572 2066 6f72 2065 6163 6820 7265  rker for each re
+000414d0: 7469 7265 6420 776f 726b 6572 2e0a 0a20  tired worker... 
+000414e0: 2020 2020 2020 2049 6620 7468 6572 6520         If there 
+000414f0: 6172 6520 6b65 7973 2074 6861 7420 6578  are keys that ex
+00041500: 6973 7420 696e 206d 656d 6f72 7920 6f6e  ist in memory on
+00041510: 6c79 206f 6e20 7468 6520 776f 726b 6572  ly on the worker
+00041520: 7320 6265 696e 6720 7265 7469 7265 6420  s being retired 
+00041530: 616e 6420 6974 0a20 2020 2020 2020 2077  and it.        w
+00041540: 6173 2069 6d70 6f73 7369 626c 6520 746f  as impossible to
+00041550: 2072 6570 6c69 6361 7465 2074 6865 6d20   replicate them 
+00041560: 736f 6d65 7768 6572 6520 656c 7365 2028  somewhere else (
+00041570: 652e 672e 2062 6563 6175 7365 2074 6865  e.g. because the
+00041580: 7265 2061 7265 6e27 740a 2020 2020 2020  re aren't.      
+00041590: 2020 616e 7920 6f74 6865 7220 7275 6e6e    any other runn
+000415a0: 696e 6720 776f 726b 6572 7329 2c20 7468  ing workers), th
+000415b0: 6520 776f 726b 6572 7320 686f 6c64 696e  e workers holdin
+000415c0: 6720 7375 6368 206b 6579 7320 776f 6e27  g such keys won'
+000415d0: 7420 6265 2072 6574 6972 6564 2061 6e64  t be retired and
+000415e0: 0a20 2020 2020 2020 2077 6f6e 2774 2061  .        won't a
+000415f0: 7070 6561 7220 696e 2074 6865 2072 6574  ppear in the ret
+00041600: 7572 6e65 6420 6469 6374 2e0a 0a20 2020  urned dict...   
+00041610: 2020 2020 2053 6565 2041 6c73 6f0a 2020       See Also.  
+00041620: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20        --------. 
+00041630: 2020 2020 2020 2053 6368 6564 756c 6572         Scheduler
+00041640: 2e77 6f72 6b65 7273 5f74 6f5f 636c 6f73  .workers_to_clos
+00041650: 650a 2020 2020 2020 2020 2222 220a 2020  e.        """.  
+00041660: 2020 2020 2020 6966 206e 616d 6573 2069        if names i
+00041670: 7320 6e6f 7420 4e6f 6e65 2061 6e64 2077  s not None and w
+00041680: 6f72 6b65 7273 2069 7320 6e6f 7420 4e6f  orkers is not No
+00041690: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+000416a0: 7261 6973 6520 5479 7065 4572 726f 7228  raise TypeError(
+000416b0: 226e 616d 6573 2061 6e64 2077 6f72 6b65  "names and worke
+000416c0: 7273 2061 7265 206d 7574 7561 6c6c 7920  rs are mutually 
+000416d0: 6578 636c 7573 6976 6522 290a 2020 2020  exclusive").    
+000416e0: 2020 2020 6966 2028 6e61 6d65 7320 6973      if (names is
+000416f0: 206e 6f74 204e 6f6e 6520 6f72 2077 6f72   not None or wor
+00041700: 6b65 7273 2069 7320 6e6f 7420 4e6f 6e65  kers is not None
+00041710: 2920 616e 6420 6b77 6172 6773 3a0a 2020  ) and kwargs:.  
+00041720: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00041730: 5479 7065 4572 726f 7228 0a20 2020 2020  TypeError(.     
+00041740: 2020 2020 2020 2020 2020 2022 5061 7261             "Para
+00041750: 6d65 7465 7273 2066 6f72 2077 6f72 6b65  meters for worke
+00041760: 7273 5f74 6f5f 636c 6f73 6528 2920 6172  rs_to_close() ar
+00041770: 6520 6d75 7475 616c 6c79 2065 7863 6c75  e mutually exclu
+00041780: 7369 7665 2077 6974 6820 220a 2020 2020  sive with ".    
+00041790: 2020 2020 2020 2020 2020 2020 6622 6e61              f"na
+000417a0: 6d65 7320 616e 6420 776f 726b 6572 733a  mes and workers:
+000417b0: 207b 6b77 6172 6773 7d22 0a20 2020 2020   {kwargs}".     
+000417c0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+000417d0: 2020 7374 696d 756c 7573 5f69 6420 3d20    stimulus_id = 
+000417e0: 7374 696d 756c 7573 5f69 6420 6f72 2066  stimulus_id or f
+000417f0: 2272 6574 6972 652d 776f 726b 6572 732d  "retire-workers-
+00041800: 7b74 696d 6528 297d 220a 2020 2020 2020  {time()}".      
+00041810: 2020 2320 5468 6973 206c 6f63 6b20 6d61    # This lock ma
+00041820: 6b65 7320 7265 7469 7265 5f77 6f72 6b65  kes retire_worke
+00041830: 7273 2c20 7265 6261 6c61 6e63 652c 2061  rs, rebalance, a
+00041840: 6e64 2072 6570 6c69 6361 7465 206d 7574  nd replicate mut
+00041850: 7561 6c6c 790a 2020 2020 2020 2020 2320  ually.        # 
+00041860: 6578 636c 7573 6976 6520 616e 6420 7769  exclusive and wi
+00041870: 6c6c 206e 6f20 6c6f 6e67 6572 2062 6520  ll no longer be 
+00041880: 6e65 6365 7373 6172 7920 6f6e 6365 2072  necessary once r
+00041890: 6562 616c 616e 6365 2061 6e64 2072 6570  ebalance and rep
+000418a0: 6c69 6361 7465 2061 7265 0a20 2020 2020  licate are.     
+000418b0: 2020 2023 206d 6967 7261 7465 6420 746f     # migrated to
+000418c0: 2074 6865 2041 6374 6976 6520 4d65 6d6f   the Active Memo
+000418d0: 7279 204d 616e 6167 6572 2e0a 2020 2020  ry Manager..    
+000418e0: 2020 2020 2320 486f 7765 7665 722c 2069      # However, i
+000418f0: 7420 616c 6c6f 7773 206d 756c 7469 706c  t allows multipl
+00041900: 6520 696e 7374 616e 6365 7320 6f66 2072  e instances of r
+00041910: 6574 6972 655f 776f 726b 6572 7320 746f  etire_workers to
+00041920: 2072 756e 2069 6e20 7061 7261 6c6c 656c   run in parallel
+00041930: 2e0a 2020 2020 2020 2020 6173 796e 6320  ..        async 
+00041940: 7769 7468 2073 656c 662e 5f72 6570 6c69  with self._repli
+00041950: 6361 5f6c 6f63 6b28 2272 6574 6972 652d  ca_lock("retire-
+00041960: 776f 726b 6572 7322 293a 0a20 2020 2020  workers"):.     
+00041970: 2020 2020 2020 2069 6620 6e61 6d65 7320         if names 
+00041980: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00041990: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+000419a0: 6765 722e 696e 666f 2822 5265 7469 7265  ger.info("Retire
+000419b0: 2077 6f72 6b65 7220 6e61 6d65 7320 2573   worker names %s
+000419c0: 222c 206e 616d 6573 290a 2020 2020 2020  ", names).      
+000419d0: 2020 2020 2020 2020 2020 2320 5375 7070            # Supp
+000419e0: 6f72 7420 6361 7365 7320 7768 6572 6520  ort cases where 
+000419f0: 6e61 6d65 7320 6172 6520 7061 7373 6564  names are passed
+00041a00: 2074 6872 6f75 6768 2061 2043 4c49 2061   through a CLI a
+00041a10: 6e64 2062 6563 6f6d 6520 7374 7269 6e67  nd become string
+00041a20: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+00041a30: 2020 6e61 6d65 735f 7365 7420 3d20 7b73    names_set = {s
+00041a40: 7472 286e 616d 6529 2066 6f72 206e 616d  tr(name) for nam
+00041a50: 6520 696e 206e 616d 6573 7d0a 2020 2020  e in names}.    
+00041a60: 2020 2020 2020 2020 2020 2020 7773 7320              wss 
+00041a70: 3d20 7b77 7320 666f 7220 7773 2069 6e20  = {ws for ws in 
+00041a80: 7365 6c66 2e77 6f72 6b65 7273 2e76 616c  self.workers.val
+00041a90: 7565 7328 2920 6966 2073 7472 2877 732e  ues() if str(ws.
+00041aa0: 6e61 6d65 2920 696e 206e 616d 6573 5f73  name) in names_s
+00041ab0: 6574 7d0a 2020 2020 2020 2020 2020 2020  et}.            
+00041ac0: 656c 6966 2077 6f72 6b65 7273 2069 7320  elif workers is 
+00041ad0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+00041ae0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+00041af0: 2e69 6e66 6f28 2252 6574 6972 6520 776f  .info("Retire wo
+00041b00: 726b 6572 2061 6464 7265 7373 6573 2025  rker addresses %
+00041b10: 7322 2c20 776f 726b 6572 7329 0a20 2020  s", workers).   
 00041b20: 2020 2020 2020 2020 2020 2020 2077 7373               wss
 00041b30: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
 00041b40: 2020 2020 2020 2020 2073 656c 662e 776f           self.wo
-00041b50: 726b 6572 735b 6164 6472 6573 735d 2066  rkers[address] f
-00041b60: 6f72 2061 6464 7265 7373 2069 6e20 7365  or address in se
-00041b70: 6c66 2e77 6f72 6b65 7273 5f74 6f5f 636c  lf.workers_to_cl
-00041b80: 6f73 6528 2a2a 6b77 6172 6773 290a 2020  ose(**kwargs).  
-00041b90: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-00041ba0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00041bb0: 6f74 2077 7373 3a0a 2020 2020 2020 2020  ot wss:.        
-00041bc0: 2020 2020 2020 2020 7265 7475 726e 207b          return {
-00041bd0: 7d0a 0a20 2020 2020 2020 2020 2020 2073  }..            s
-00041be0: 746f 705f 616d 6d20 3d20 4661 6c73 650a  top_amm = False.
-00041bf0: 2020 2020 2020 2020 2020 2020 616d 6d3a              amm:
-00041c00: 2041 6374 6976 654d 656d 6f72 794d 616e   ActiveMemoryMan
-00041c10: 6167 6572 4578 7465 6e73 696f 6e20 7c20  agerExtension | 
-00041c20: 4e6f 6e65 203d 2073 656c 662e 6578 7465  None = self.exte
-00041c30: 6e73 696f 6e73 2e67 6574 2822 616d 6d22  nsions.get("amm"
-00041c40: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-00041c50: 206e 6f74 2061 6d6d 206f 7220 6e6f 7420   not amm or not 
-00041c60: 616d 6d2e 7275 6e6e 696e 673a 0a20 2020  amm.running:.   
-00041c70: 2020 2020 2020 2020 2020 2020 2061 6d6d               amm
-00041c80: 203d 2041 6374 6976 654d 656d 6f72 794d   = ActiveMemoryM
-00041c90: 616e 6167 6572 4578 7465 6e73 696f 6e28  anagerExtension(
-00041ca0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00041cb0: 2020 2020 2073 656c 662c 2070 6f6c 6963       self, polic
-00041cc0: 6965 733d 7365 7428 292c 2072 6567 6973  ies=set(), regis
-00041cd0: 7465 723d 4661 6c73 652c 2073 7461 7274  ter=False, start
-00041ce0: 3d54 7275 652c 2069 6e74 6572 7661 6c3d  =True, interval=
-00041cf0: 322e 300a 2020 2020 2020 2020 2020 2020  2.0.            
-00041d00: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00041d10: 2020 2020 2020 7374 6f70 5f61 6d6d 203d        stop_amm =
-00041d20: 2054 7275 650a 0a20 2020 2020 2020 2020   True..         
-00041d30: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00041d40: 2020 2020 2020 2020 636f 726f 7320 3d20          coros = 
-00041d50: 5b5d 0a20 2020 2020 2020 2020 2020 2020  [].             
-00041d60: 2020 2066 6f72 2077 7320 696e 2077 7373     for ws in wss
-00041d70: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00041d80: 2020 2020 2020 6c6f 6767 6572 2e69 6e66        logger.inf
-00041d90: 6f28 6622 5265 7469 7269 6e67 2077 6f72  o(f"Retiring wor
-00041da0: 6b65 7220 7b77 732e 6164 6472 6573 7321  ker {ws.address!
-00041db0: 727d 2028 7b73 7469 6d75 6c75 735f 6964  r} ({stimulus_id
-00041dc0: 3d21 727d 2922 290a 0a20 2020 2020 2020  =!r})")..       
-00041dd0: 2020 2020 2020 2020 2020 2020 2070 6f6c               pol
-00041de0: 6963 7920 3d20 5265 7469 7265 576f 726b  icy = RetireWork
-00041df0: 6572 2877 732e 6164 6472 6573 7329 0a20  er(ws.address). 
-00041e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041e10: 2020 2061 6d6d 2e61 6464 5f70 6f6c 6963     amm.add_polic
-00041e20: 7928 706f 6c69 6379 290a 0a20 2020 2020  y(policy)..     
-00041e30: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00041e40: 2043 6861 6e67 6520 576f 726b 6572 2e73   Change Worker.s
-00041e50: 7461 7475 7320 746f 2063 6c6f 7369 6e67  tatus to closing
-00041e60: 5f67 7261 6365 6675 6c6c 792e 2049 6d6d  _gracefully. Imm
-00041e70: 6564 6961 7465 6c79 2073 6574 0a20 2020  ediately set.   
-00041e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041e90: 2023 2074 6865 2073 616d 6520 6f6e 2074   # the same on t
-00041ea0: 6865 2073 6368 6564 756c 6572 2074 6f20  he scheduler to 
-00041eb0: 7072 6576 656e 7420 7261 6365 2063 6f6e  prevent race con
-00041ec0: 6469 7469 6f6e 732e 0a20 2020 2020 2020  ditions..       
-00041ed0: 2020 2020 2020 2020 2020 2020 2070 7265               pre
-00041ee0: 765f 7374 6174 7573 203d 2077 732e 7374  v_status = ws.st
-00041ef0: 6174 7573 0a20 2020 2020 2020 2020 2020  atus.           
-00041f00: 2020 2020 2020 2020 2073 656c 662e 6861           self.ha
-00041f10: 6e64 6c65 5f77 6f72 6b65 725f 7374 6174  ndle_worker_stat
-00041f20: 7573 5f63 6861 6e67 6528 0a20 2020 2020  us_change(.     
-00041f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041f40: 2020 2053 7461 7475 732e 636c 6f73 696e     Status.closin
-00041f50: 675f 6772 6163 6566 756c 6c79 2c20 7773  g_gracefully, ws
-00041f60: 2c20 7374 696d 756c 7573 5f69 640a 2020  , stimulus_id.  
-00041f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041f80: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00041f90: 2020 2020 2020 2020 2320 4649 584d 453a          # FIXME:
-00041fa0: 2057 6520 7368 6f75 6c64 2073 656e 6420   We should send 
-00041fb0: 6120 6d65 7373 6167 6520 746f 2074 6865  a message to the
-00041fc0: 206e 616e 6e79 2066 6972 7374 3b0a 2020   nanny first;.  
-00041fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041fe0: 2020 2320 6576 656e 7475 616c 6c79 2077    # eventually w
-00041ff0: 6f72 6b65 7273 2077 6f6e 2774 2062 6520  orkers won't be 
-00042000: 6162 6c65 2074 6f20 636c 6f73 6520 7468  able to close th
-00042010: 6569 7220 6f77 6e20 6e61 6e6e 6965 732e  eir own nannies.
-00042020: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00042030: 2020 2020 2073 656c 662e 7374 7265 616d       self.stream
-00042040: 5f63 6f6d 6d73 5b77 732e 6164 6472 6573  _comms[ws.addres
-00042050: 735d 2e73 656e 6428 0a20 2020 2020 2020  s].send(.       
-00042060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042070: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00042080: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00042090: 6f70 223a 2022 776f 726b 6572 2d73 7461  op": "worker-sta
-000420a0: 7475 732d 6368 616e 6765 222c 0a20 2020  tus-change",.   
-000420b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000420c0: 2020 2020 2020 2020 2022 7374 6174 7573           "status
-000420d0: 223a 2077 732e 7374 6174 7573 2e6e 616d  ": ws.status.nam
-000420e0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-000420f0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00042100: 7374 696d 756c 7573 5f69 6422 3a20 7374  stimulus_id": st
-00042110: 696d 756c 7573 5f69 642c 0a20 2020 2020  imulus_id,.     
+00041b50: 726b 6572 735b 6164 6472 6573 735d 0a20  rkers[address]. 
+00041b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00041b70: 2020 2066 6f72 2061 6464 7265 7373 2069     for address i
+00041b80: 6e20 776f 726b 6572 730a 2020 2020 2020  n workers.      
+00041b90: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00041ba0: 2061 6464 7265 7373 2069 6e20 7365 6c66   address in self
+00041bb0: 2e77 6f72 6b65 7273 0a20 2020 2020 2020  .workers.       
+00041bc0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00041bd0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00041be0: 2020 2020 2020 2020 2020 2020 2077 7373               wss
+00041bf0: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+00041c00: 2020 2020 2020 2020 2073 656c 662e 776f           self.wo
+00041c10: 726b 6572 735b 6164 6472 6573 735d 2066  rkers[address] f
+00041c20: 6f72 2061 6464 7265 7373 2069 6e20 7365  or address in se
+00041c30: 6c66 2e77 6f72 6b65 7273 5f74 6f5f 636c  lf.workers_to_cl
+00041c40: 6f73 6528 2a2a 6b77 6172 6773 290a 2020  ose(**kwargs).  
+00041c50: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+00041c60: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+00041c70: 6f74 2077 7373 3a0a 2020 2020 2020 2020  ot wss:.        
+00041c80: 2020 2020 2020 2020 7265 7475 726e 207b          return {
+00041c90: 7d0a 0a20 2020 2020 2020 2020 2020 2073  }..            s
+00041ca0: 746f 705f 616d 6d20 3d20 4661 6c73 650a  top_amm = False.
+00041cb0: 2020 2020 2020 2020 2020 2020 616d 6d3a              amm:
+00041cc0: 2041 6374 6976 654d 656d 6f72 794d 616e   ActiveMemoryMan
+00041cd0: 6167 6572 4578 7465 6e73 696f 6e20 7c20  agerExtension | 
+00041ce0: 4e6f 6e65 203d 2073 656c 662e 6578 7465  None = self.exte
+00041cf0: 6e73 696f 6e73 2e67 6574 2822 616d 6d22  nsions.get("amm"
+00041d00: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+00041d10: 206e 6f74 2061 6d6d 206f 7220 6e6f 7420   not amm or not 
+00041d20: 616d 6d2e 7275 6e6e 696e 673a 0a20 2020  amm.running:.   
+00041d30: 2020 2020 2020 2020 2020 2020 2061 6d6d               amm
+00041d40: 203d 2041 6374 6976 654d 656d 6f72 794d   = ActiveMemoryM
+00041d50: 616e 6167 6572 4578 7465 6e73 696f 6e28  anagerExtension(
+00041d60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00041d70: 2020 2020 2073 656c 662c 2070 6f6c 6963       self, polic
+00041d80: 6965 733d 7365 7428 292c 2072 6567 6973  ies=set(), regis
+00041d90: 7465 723d 4661 6c73 652c 2073 7461 7274  ter=False, start
+00041da0: 3d54 7275 652c 2069 6e74 6572 7661 6c3d  =True, interval=
+00041db0: 322e 300a 2020 2020 2020 2020 2020 2020  2.0.            
+00041dc0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00041dd0: 2020 2020 2020 7374 6f70 5f61 6d6d 203d        stop_amm =
+00041de0: 2054 7275 650a 0a20 2020 2020 2020 2020   True..         
+00041df0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00041e00: 2020 2020 2020 2020 636f 726f 7320 3d20          coros = 
+00041e10: 5b5d 0a20 2020 2020 2020 2020 2020 2020  [].             
+00041e20: 2020 2066 6f72 2077 7320 696e 2077 7373     for ws in wss
+00041e30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00041e40: 2020 2020 2020 6c6f 6767 6572 2e69 6e66        logger.inf
+00041e50: 6f28 6622 5265 7469 7269 6e67 2077 6f72  o(f"Retiring wor
+00041e60: 6b65 7220 7b77 732e 6164 6472 6573 7321  ker {ws.address!
+00041e70: 727d 2028 7b73 7469 6d75 6c75 735f 6964  r} ({stimulus_id
+00041e80: 3d21 727d 2922 290a 0a20 2020 2020 2020  =!r})")..       
+00041e90: 2020 2020 2020 2020 2020 2020 2070 6f6c               pol
+00041ea0: 6963 7920 3d20 5265 7469 7265 576f 726b  icy = RetireWork
+00041eb0: 6572 2877 732e 6164 6472 6573 7329 0a20  er(ws.address). 
+00041ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00041ed0: 2020 2061 6d6d 2e61 6464 5f70 6f6c 6963     amm.add_polic
+00041ee0: 7928 706f 6c69 6379 290a 0a20 2020 2020  y(policy)..     
+00041ef0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00041f00: 2043 6861 6e67 6520 576f 726b 6572 2e73   Change Worker.s
+00041f10: 7461 7475 7320 746f 2063 6c6f 7369 6e67  tatus to closing
+00041f20: 5f67 7261 6365 6675 6c6c 792e 2049 6d6d  _gracefully. Imm
+00041f30: 6564 6961 7465 6c79 2073 6574 0a20 2020  ediately set.   
+00041f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00041f50: 2023 2074 6865 2073 616d 6520 6f6e 2074   # the same on t
+00041f60: 6865 2073 6368 6564 756c 6572 2074 6f20  he scheduler to 
+00041f70: 7072 6576 656e 7420 7261 6365 2063 6f6e  prevent race con
+00041f80: 6469 7469 6f6e 732e 0a20 2020 2020 2020  ditions..       
+00041f90: 2020 2020 2020 2020 2020 2020 2070 7265               pre
+00041fa0: 765f 7374 6174 7573 203d 2077 732e 7374  v_status = ws.st
+00041fb0: 6174 7573 0a20 2020 2020 2020 2020 2020  atus.           
+00041fc0: 2020 2020 2020 2020 2073 656c 662e 6861           self.ha
+00041fd0: 6e64 6c65 5f77 6f72 6b65 725f 7374 6174  ndle_worker_stat
+00041fe0: 7573 5f63 6861 6e67 6528 0a20 2020 2020  us_change(.     
+00041ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042000: 2020 2053 7461 7475 732e 636c 6f73 696e     Status.closin
+00042010: 675f 6772 6163 6566 756c 6c79 2c20 7773  g_gracefully, ws
+00042020: 2c20 7374 696d 756c 7573 5f69 640a 2020  , stimulus_id.  
+00042030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042040: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00042050: 2020 2020 2020 2020 2320 4649 584d 453a          # FIXME:
+00042060: 2057 6520 7368 6f75 6c64 2073 656e 6420   We should send 
+00042070: 6120 6d65 7373 6167 6520 746f 2074 6865  a message to the
+00042080: 206e 616e 6e79 2066 6972 7374 3b0a 2020   nanny first;.  
+00042090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000420a0: 2020 2320 6576 656e 7475 616c 6c79 2077    # eventually w
+000420b0: 6f72 6b65 7273 2077 6f6e 2774 2062 6520  orkers won't be 
+000420c0: 6162 6c65 2074 6f20 636c 6f73 6520 7468  able to close th
+000420d0: 6569 7220 6f77 6e20 6e61 6e6e 6965 732e  eir own nannies.
+000420e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000420f0: 2020 2020 2073 656c 662e 7374 7265 616d       self.stream
+00042100: 5f63 6f6d 6d73 5b77 732e 6164 6472 6573  _comms[ws.addres
+00042110: 735d 2e73 656e 6428 0a20 2020 2020 2020  s].send(.       
 00042120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042130: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-00042140: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-00042150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042160: 636f 726f 732e 6170 7065 6e64 280a 2020  coros.append(.  
+00042130: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00042140: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00042150: 6f70 223a 2022 776f 726b 6572 2d73 7461  op": "worker-sta
+00042160: 7475 732d 6368 616e 6765 222c 0a20 2020  tus-change",.   
 00042170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042180: 2020 2020 2020 7365 6c66 2e5f 7472 6163        self._trac
-00042190: 6b5f 7265 7469 7265 5f77 6f72 6b65 7228  k_retire_worker(
-000421a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000421b0: 2020 2020 2020 2020 2020 2020 2077 732c               ws,
-000421c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000421d0: 2020 2020 2020 2020 2020 2020 2070 6f6c               pol
-000421e0: 6963 792c 0a20 2020 2020 2020 2020 2020  icy,.           
-000421f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042200: 2070 7265 765f 7374 6174 7573 3d70 7265   prev_status=pre
-00042210: 765f 7374 6174 7573 2c0a 2020 2020 2020  v_status,.      
-00042220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042230: 2020 2020 2020 636c 6f73 653d 636c 6f73        close=clos
-00042240: 655f 776f 726b 6572 732c 0a20 2020 2020  e_workers,.     
-00042250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042260: 2020 2020 2020 2072 656d 6f76 653d 7265         remove=re
-00042270: 6d6f 7665 2c0a 2020 2020 2020 2020 2020  move,.          
-00042280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042290: 2020 7374 696d 756c 7573 5f69 643d 7374    stimulus_id=st
-000422a0: 696d 756c 7573 5f69 642c 0a20 2020 2020  imulus_id,.     
+00042180: 2020 2020 2020 2020 2022 7374 6174 7573           "status
+00042190: 223a 2077 732e 7374 6174 7573 2e6e 616d  ": ws.status.nam
+000421a0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+000421b0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+000421c0: 7374 696d 756c 7573 5f69 6422 3a20 7374  stimulus_id": st
+000421d0: 696d 756c 7573 5f69 642c 0a20 2020 2020  imulus_id,.     
+000421e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000421f0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+00042200: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+00042210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042220: 636f 726f 732e 6170 7065 6e64 280a 2020  coros.append(.  
+00042230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042240: 2020 2020 2020 7365 6c66 2e5f 7472 6163        self._trac
+00042250: 6b5f 7265 7469 7265 5f77 6f72 6b65 7228  k_retire_worker(
+00042260: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00042270: 2020 2020 2020 2020 2020 2020 2077 732c               ws,
+00042280: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00042290: 2020 2020 2020 2020 2020 2020 2070 6f6c               pol
+000422a0: 6963 792c 0a20 2020 2020 2020 2020 2020  icy,.           
 000422b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000422c0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-000422d0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-000422e0: 2020 2020 2020 2020 2020 2020 2320 4769              # Gi
-000422f0: 7665 2074 6865 2041 4d4d 2061 206b 6963  ve the AMM a kic
-00042300: 6b2c 2069 6e20 6164 6469 7469 6f6e 2074  k, in addition t
-00042310: 6f20 6974 7320 7065 7269 6f64 6963 2072  o its periodic r
-00042320: 756e 6e69 6e67 2e20 5468 6973 2069 730a  unning. This is.
-00042330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042340: 2320 746f 2061 766f 6964 2075 6e6e 6563  # to avoid unnec
-00042350: 6573 7361 7269 6c79 2077 6169 7469 6e67  essarily waiting
-00042360: 2066 6f72 2061 2070 6f74 656e 7469 616c   for a potential
-00042370: 6c79 2061 7262 6974 7261 7269 6c79 206c  ly arbitrarily l
-00042380: 6f6e 670a 2020 2020 2020 2020 2020 2020  ong.            
-00042390: 2020 2020 2320 7469 6d65 2028 6465 7065      # time (depe
-000423a0: 6e64 696e 6720 6f6e 2069 6e74 6572 7661  nding on interva
-000423b0: 6c20 7365 7474 696e 6773 290a 2020 2020  l settings).    
-000423c0: 2020 2020 2020 2020 2020 2020 616d 6d2e              amm.
-000423d0: 7275 6e5f 6f6e 6365 2829 0a0a 2020 2020  run_once()..    
-000423e0: 2020 2020 2020 2020 2020 2020 776f 726b              work
-000423f0: 6572 735f 696e 666f 5f6f 6b20 3d20 7b7d  ers_info_ok = {}
-00042400: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00042410: 2077 6f72 6b65 7273 5f69 6e66 6f5f 6162   workers_info_ab
-00042420: 6f72 7420 3d20 7b7d 0a20 2020 2020 2020  ort = {}.       
-00042430: 2020 2020 2020 2020 2066 6f72 2061 6464           for add
-00042440: 722c 2072 6573 756c 742c 2069 6e66 6f20  r, result, info 
-00042450: 696e 2061 7761 6974 2061 7379 6e63 696f  in await asyncio
-00042460: 2e67 6174 6865 7228 2a63 6f72 6f73 293a  .gather(*coros):
-00042470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00042480: 2020 2020 2069 6620 7265 7375 6c74 203d       if result =
-00042490: 3d20 224f 4b22 3a0a 2020 2020 2020 2020  = "OK":.        
-000424a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000424b0: 776f 726b 6572 735f 696e 666f 5f6f 6b5b  workers_info_ok[
-000424c0: 6164 6472 5d20 3d20 696e 666f 0a20 2020  addr] = info.   
-000424d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000424e0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000424f0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-00042500: 6f72 6b65 7273 5f69 6e66 6f5f 6162 6f72  orkers_info_abor
-00042510: 745b 6164 6472 5d20 3d20 696e 666f 0a0a  t[addr] = info..
-00042520: 2020 2020 2020 2020 2020 2020 6669 6e61              fina
-00042530: 6c6c 793a 0a20 2020 2020 2020 2020 2020  lly:.           
-00042540: 2020 2020 2069 6620 7374 6f70 5f61 6d6d       if stop_amm
-00042550: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00042560: 2020 2020 2020 616d 6d2e 7374 6f70 2829        amm.stop()
-00042570: 0a0a 2020 2020 2020 2020 7365 6c66 2e6c  ..        self.l
-00042580: 6f67 5f65 7665 6e74 280a 2020 2020 2020  og_event(.      
-00042590: 2020 2020 2020 2261 6c6c 222c 0a20 2020        "all",.   
-000425a0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-000425b0: 2020 2020 2020 2020 2020 2022 6163 7469             "acti
-000425c0: 6f6e 223a 2022 7265 7469 7265 2d77 6f72  on": "retire-wor
-000425d0: 6b65 7273 222c 0a20 2020 2020 2020 2020  kers",.         
-000425e0: 2020 2020 2020 2022 7265 7469 7265 6422         "retired"
-000425f0: 3a20 776f 726b 6572 735f 696e 666f 5f6f  : workers_info_o
-00042600: 6b2c 0a20 2020 2020 2020 2020 2020 2020  k,.             
-00042610: 2020 2022 636f 756c 642d 6e6f 742d 7265     "could-not-re
-00042620: 7469 7265 223a 2077 6f72 6b65 7273 5f69  tire": workers_i
-00042630: 6e66 6f5f 6162 6f72 742c 0a20 2020 2020  nfo_abort,.     
-00042640: 2020 2020 2020 2020 2020 2022 7374 696d             "stim
-00042650: 756c 7573 5f69 6422 3a20 7374 696d 756c  ulus_id": stimul
-00042660: 7573 5f69 642c 0a20 2020 2020 2020 2020  us_id,.         
-00042670: 2020 207d 2c0a 2020 2020 2020 2020 290a     },.        ).
-00042680: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-00042690: 5f65 7665 6e74 280a 2020 2020 2020 2020  _event(.        
-000426a0: 2020 2020 6c69 7374 2877 6f72 6b65 7273      list(workers
-000426b0: 5f69 6e66 6f5f 6f6b 292c 0a20 2020 2020  _info_ok),.     
-000426c0: 2020 2020 2020 207b 2261 6374 696f 6e22         {"action"
-000426d0: 3a20 2272 6574 6972 6564 222c 2022 7374  : "retired", "st
-000426e0: 696d 756c 7573 5f69 6422 3a20 7374 696d  imulus_id": stim
-000426f0: 756c 7573 5f69 647d 2c0a 2020 2020 2020  ulus_id},.      
-00042700: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
-00042710: 2e6c 6f67 5f65 7665 6e74 280a 2020 2020  .log_event(.    
-00042720: 2020 2020 2020 2020 6c69 7374 2877 6f72          list(wor
-00042730: 6b65 7273 5f69 6e66 6f5f 6162 6f72 7429  kers_info_abort)
-00042740: 2c0a 2020 2020 2020 2020 2020 2020 7b22  ,.            {"
-00042750: 6163 7469 6f6e 223a 2022 636f 756c 642d  action": "could-
-00042760: 6e6f 742d 7265 7469 7265 222c 2022 7374  not-retire", "st
-00042770: 696d 756c 7573 5f69 6422 3a20 7374 696d  imulus_id": stim
-00042780: 756c 7573 5f69 647d 2c0a 2020 2020 2020  ulus_id},.      
-00042790: 2020 290a 0a20 2020 2020 2020 2072 6574    )..        ret
-000427a0: 7572 6e20 776f 726b 6572 735f 696e 666f  urn workers_info
-000427b0: 5f6f 6b0a 0a20 2020 2061 7379 6e63 2064  _ok..    async d
-000427c0: 6566 205f 7472 6163 6b5f 7265 7469 7265  ef _track_retire
-000427d0: 5f77 6f72 6b65 7228 0a20 2020 2020 2020  _worker(.       
-000427e0: 2073 656c 662c 0a20 2020 2020 2020 2077   self,.        w
-000427f0: 733a 2057 6f72 6b65 7253 7461 7465 2c0a  s: WorkerState,.
-00042800: 2020 2020 2020 2020 706f 6c69 6379 3a20          policy: 
-00042810: 5265 7469 7265 576f 726b 6572 2c0a 2020  RetireWorker,.  
-00042820: 2020 2020 2020 7072 6576 5f73 7461 7475        prev_statu
-00042830: 733a 2053 7461 7475 732c 0a20 2020 2020  s: Status,.     
-00042840: 2020 2063 6c6f 7365 3a20 626f 6f6c 2c0a     close: bool,.
-00042850: 2020 2020 2020 2020 7265 6d6f 7665 3a20          remove: 
-00042860: 626f 6f6c 2c0a 2020 2020 2020 2020 7374  bool,.        st
-00042870: 696d 756c 7573 5f69 643a 2073 7472 2c0a  imulus_id: str,.
-00042880: 2020 2020 2920 2d3e 2074 7570 6c65 5b73      ) -> tuple[s
-00042890: 7472 2c20 4c69 7465 7261 6c5b 224f 4b22  tr, Literal["OK"
-000428a0: 2c20 226e 6f2d 7265 6369 7069 656e 7473  , "no-recipients
-000428b0: 225d 2c20 6469 6374 5d3a 0a20 2020 2020  "], dict]:.     
-000428c0: 2020 2077 6869 6c65 206e 6f74 2070 6f6c     while not pol
-000428d0: 6963 792e 646f 6e65 2829 3a0a 2020 2020  icy.done():.    
-000428e0: 2020 2020 2020 2020 2320 536c 6565 7020          # Sleep 
-000428f0: 302e 3031 7320 7768 656e 2074 6865 7265  0.01s when there
-00042900: 2061 7265 2034 2074 6173 6b73 206f 7220   are 4 tasks or 
-00042910: 6c65 7373 0a20 2020 2020 2020 2020 2020  less.           
-00042920: 2023 2053 6c65 6570 2030 2e35 7320 7768   # Sleep 0.5s wh
-00042930: 656e 2074 6865 7265 2061 7265 2032 3030  en there are 200
-00042940: 206f 7220 6d6f 7265 0a20 2020 2020 2020   or more.       
-00042950: 2020 2020 2070 6f6c 6c5f 696e 7465 7276       poll_interv
-00042960: 616c 203d 206d 6178 2830 2e30 312c 206d  al = max(0.01, m
-00042970: 696e 2830 2e35 2c20 6c65 6e28 7773 2e68  in(0.5, len(ws.h
-00042980: 6173 5f77 6861 7429 202f 2034 3030 2929  as_what) / 400))
-00042990: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
-000429a0: 6974 2061 7379 6e63 696f 2e73 6c65 6570  it asyncio.sleep
-000429b0: 2870 6f6c 6c5f 696e 7465 7276 616c 290a  (poll_interval).
-000429c0: 0a20 2020 2020 2020 2069 6620 706f 6c69  .        if poli
-000429d0: 6379 2e6e 6f5f 7265 6369 7069 656e 7473  cy.no_recipients
-000429e0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-000429f0: 4162 6f72 7420 7265 7469 7265 6d65 6e74  Abort retirement
-00042a00: 2e20 5468 6973 2074 696d 6520 7765 2064  . This time we d
-00042a10: 6f6e 2774 206e 6565 6420 746f 2077 6f72  on't need to wor
-00042a20: 7279 2061 626f 7574 2072 6163 650a 2020  ry about race.  
-00042a30: 2020 2020 2020 2020 2020 2320 636f 6e64            # cond
-00042a40: 6974 696f 6e73 2061 6e64 2077 6520 6361  itions and we ca
-00042a50: 6e20 7761 6974 2066 6f72 2061 2073 6368  n wait for a sch
-00042a60: 6564 756c 6572 2d3e 776f 726b 6572 2d3e  eduler->worker->
-00042a70: 7363 6865 6475 6c65 720a 2020 2020 2020  scheduler.      
-00042a80: 2020 2020 2020 2320 726f 756e 642d 7472        # round-tr
-00042a90: 6970 2e0a 2020 2020 2020 2020 2020 2020  ip..            
-00042aa0: 7365 6c66 2e73 7472 6561 6d5f 636f 6d6d  self.stream_comm
-00042ab0: 735b 7773 2e61 6464 7265 7373 5d2e 7365  s[ws.address].se
-00042ac0: 6e64 280a 2020 2020 2020 2020 2020 2020  nd(.            
-00042ad0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00042ae0: 2020 2020 2020 2020 2020 226f 7022 3a20            "op": 
-00042af0: 2277 6f72 6b65 722d 7374 6174 7573 2d63  "worker-status-c
-00042b00: 6861 6e67 6522 2c0a 2020 2020 2020 2020  hange",.        
-00042b10: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
-00042b20: 7475 7322 3a20 7072 6576 5f73 7461 7475  tus": prev_statu
-00042b30: 732e 6e61 6d65 2c0a 2020 2020 2020 2020  s.name,.        
-00042b40: 2020 2020 2020 2020 2020 2020 2273 7469              "sti
-00042b50: 6d75 6c75 735f 6964 223a 2073 7469 6d75  mulus_id": stimu
-00042b60: 6c75 735f 6964 2c0a 2020 2020 2020 2020  lus_id,.        
-00042b70: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00042b80: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00042b90: 2020 2020 6c6f 6767 6572 2e77 6172 6e69      logger.warni
-00042ba0: 6e67 280a 2020 2020 2020 2020 2020 2020  ng(.            
-00042bb0: 2020 2020 6622 436f 756c 6420 6e6f 7420      f"Could not 
-00042bc0: 7265 7469 7265 2077 6f72 6b65 7220 7b77  retire worker {w
-00042bd0: 732e 6164 6472 6573 7321 727d 3a20 756e  s.address!r}: un
-00042be0: 6971 7565 2064 6174 6120 636f 756c 6420  ique data could 
-00042bf0: 6e6f 7420 6265 2022 0a20 2020 2020 2020  not be ".       
-00042c00: 2020 2020 2020 2020 2066 226d 6f76 6564           f"moved
-00042c10: 2074 6f20 616e 7920 6f74 6865 7220 776f   to any other wo
-00042c20: 726b 6572 2028 7b73 7469 6d75 6c75 735f  rker ({stimulus_
-00042c30: 6964 3d21 727d 2922 0a20 2020 2020 2020  id=!r})".       
-00042c40: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00042c50: 2020 2072 6574 7572 6e20 7773 2e61 6464     return ws.add
-00042c60: 7265 7373 2c20 226e 6f2d 7265 6369 7069  ress, "no-recipi
-00042c70: 656e 7473 222c 2077 732e 6964 656e 7469  ents", ws.identi
-00042c80: 7479 2829 0a0a 2020 2020 2020 2020 6c6f  ty()..        lo
-00042c90: 6767 6572 2e64 6562 7567 280a 2020 2020  gger.debug(.    
-00042ca0: 2020 2020 2020 2020 6622 416c 6c20 756e          f"All un
-00042cb0: 6971 7565 206b 6579 7320 6f6e 2077 6f72  ique keys on wor
-00042cc0: 6b65 7220 7b77 732e 6164 6472 6573 7321  ker {ws.address!
-00042cd0: 727d 2068 6176 6520 6265 656e 2072 6570  r} have been rep
-00042ce0: 6c69 6361 7465 6420 656c 7365 7768 6572  licated elsewher
-00042cf0: 6522 0a20 2020 2020 2020 2029 0a0a 2020  e".        )..  
-00042d00: 2020 2020 2020 6966 2072 656d 6f76 653a        if remove:
-00042d10: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
-00042d20: 6974 2073 656c 662e 7265 6d6f 7665 5f77  it self.remove_w
-00042d30: 6f72 6b65 7228 0a20 2020 2020 2020 2020  orker(.         
-00042d40: 2020 2020 2020 2077 732e 6164 6472 6573         ws.addres
-00042d50: 732c 2073 6166 653d 5472 7565 2c20 636c  s, safe=True, cl
-00042d60: 6f73 653d 636c 6f73 652c 2073 7469 6d75  ose=close, stimu
-00042d70: 6c75 735f 6964 3d73 7469 6d75 6c75 735f  lus_id=stimulus_
-00042d80: 6964 0a20 2020 2020 2020 2020 2020 2029  id.            )
-00042d90: 0a20 2020 2020 2020 2065 6c69 6620 636c  .        elif cl
-00042da0: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
-00042db0: 2073 656c 662e 636c 6f73 655f 776f 726b   self.close_work
-00042dc0: 6572 2877 732e 6164 6472 6573 7329 0a0a  er(ws.address)..
-00042dd0: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
-00042de0: 6e66 6f28 6622 5265 7469 7265 6420 776f  nfo(f"Retired wo
-00042df0: 726b 6572 207b 7773 2e61 6464 7265 7373  rker {ws.address
-00042e00: 2172 7d20 287b 7374 696d 756c 7573 5f69  !r} ({stimulus_i
-00042e10: 643d 2172 7d29 2229 0a20 2020 2020 2020  d=!r})").       
-00042e20: 2072 6574 7572 6e20 7773 2e61 6464 7265   return ws.addre
-00042e30: 7373 2c20 224f 4b22 2c20 7773 2e69 6465  ss, "OK", ws.ide
-00042e40: 6e74 6974 7928 290a 0a20 2020 2064 6566  ntity()..    def
-00042e50: 2061 6464 5f6b 6579 7328 0a20 2020 2020   add_keys(.     
-00042e60: 2020 2073 656c 662c 2077 6f72 6b65 723a     self, worker:
-00042e70: 2073 7472 2c20 6b65 7973 3a20 436f 6c6c   str, keys: Coll
-00042e80: 6563 7469 6f6e 5b4b 6579 5d20 3d20 2829  ection[Key] = ()
-00042e90: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
-00042ea0: 7472 207c 204e 6f6e 6520 3d20 4e6f 6e65  tr | None = None
-00042eb0: 0a20 2020 2029 202d 3e20 4c69 7465 7261  .    ) -> Litera
-00042ec0: 6c5b 224f 4b22 2c20 226e 6f74 2066 6f75  l["OK", "not fou
-00042ed0: 6e64 225d 3a0a 2020 2020 2020 2020 2222  nd"]:.        ""
-00042ee0: 220a 2020 2020 2020 2020 4c65 6172 6e20  ".        Learn 
-00042ef0: 7468 6174 2061 2077 6f72 6b65 7220 6861  that a worker ha
-00042f00: 7320 6365 7274 6169 6e20 6b65 7973 0a0a  s certain keys..
-00042f10: 2020 2020 2020 2020 5468 6973 2073 686f          This sho
-00042f20: 756c 6420 6e6f 7420 6265 2075 7365 6420  uld not be used 
-00042f30: 696e 2070 7261 6374 6963 6520 616e 6420  in practice and 
-00042f40: 6973 206d 6f73 746c 7920 6865 7265 2066  is mostly here f
-00042f50: 6f72 206c 6567 6163 790a 2020 2020 2020  or legacy.      
-00042f60: 2020 7265 6173 6f6e 732e 2020 486f 7765    reasons.  Howe
-00042f70: 7665 722c 2069 7420 6973 2073 656e 7420  ver, it is sent 
-00042f80: 6279 2077 6f72 6b65 7273 2066 726f 6d20  by workers from 
-00042f90: 7469 6d65 2074 6f20 7469 6d65 2e0a 2020  time to time..  
-00042fa0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00042fb0: 2020 6966 2077 6f72 6b65 7220 6e6f 7420    if worker not 
-00042fc0: 696e 2073 656c 662e 776f 726b 6572 733a  in self.workers:
-00042fd0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00042fe0: 7572 6e20 226e 6f74 2066 6f75 6e64 220a  urn "not found".
-00042ff0: 2020 2020 2020 2020 7773 203d 2073 656c          ws = sel
-00043000: 662e 776f 726b 6572 735b 776f 726b 6572  f.workers[worker
-00043010: 5d0a 2020 2020 2020 2020 7265 6475 6e64  ].        redund
-00043020: 616e 745f 7265 706c 6963 6173 203d 205b  ant_replicas = [
-00043030: 5d0a 2020 2020 2020 2020 666f 7220 6b65  ].        for ke
-00043040: 7920 696e 206b 6579 733a 0a20 2020 2020  y in keys:.     
-00043050: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
-00043060: 2e74 6173 6b73 2e67 6574 286b 6579 290a  .tasks.get(key).
-00043070: 2020 2020 2020 2020 2020 2020 6966 2074              if t
-00043080: 7320 6973 206e 6f74 204e 6f6e 6520 616e  s is not None an
-00043090: 6420 7473 2e73 7461 7465 203d 3d20 226d  d ts.state == "m
-000430a0: 656d 6f72 7922 3a0a 2020 2020 2020 2020  emory":.        
-000430b0: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
-000430c0: 5f72 6570 6c69 6361 2874 732c 2077 7329  _replica(ts, ws)
-000430d0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-000430e0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-000430f0: 2020 2072 6564 756e 6461 6e74 5f72 6570     redundant_rep
-00043100: 6c69 6361 732e 6170 7065 6e64 286b 6579  licas.append(key
-00043110: 290a 0a20 2020 2020 2020 2069 6620 7265  )..        if re
-00043120: 6475 6e64 616e 745f 7265 706c 6963 6173  dundant_replicas
-00043130: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00043140: 206e 6f74 2073 7469 6d75 6c75 735f 6964   not stimulus_id
-00043150: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00043160: 2020 7374 696d 756c 7573 5f69 6420 3d20    stimulus_id = 
-00043170: 6622 7265 6475 6e64 616e 742d 7265 706c  f"redundant-repl
-00043180: 6963 6173 2d7b 7469 6d65 2829 7d22 0a20  icas-{time()}". 
-00043190: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000431a0: 776f 726b 6572 5f73 656e 6428 0a20 2020  worker_send(.   
-000431b0: 2020 2020 2020 2020 2020 2020 2077 6f72               wor
-000431c0: 6b65 722c 0a20 2020 2020 2020 2020 2020  ker,.           
-000431d0: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-000431e0: 2020 2020 2020 2020 2020 2022 6f70 223a             "op":
-000431f0: 2022 7265 6d6f 7665 2d72 6570 6c69 6361   "remove-replica
-00043200: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
-00043210: 2020 2020 2020 2020 226b 6579 7322 3a20          "keys": 
-00043220: 7265 6475 6e64 616e 745f 7265 706c 6963  redundant_replic
-00043230: 6173 2c0a 2020 2020 2020 2020 2020 2020  as,.            
-00043240: 2020 2020 2020 2020 2273 7469 6d75 6c75          "stimulu
-00043250: 735f 6964 223a 2073 7469 6d75 6c75 735f  s_id": stimulus_
-00043260: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
-00043270: 2020 2020 7d2c 0a20 2020 2020 2020 2020      },.         
-00043280: 2020 2029 0a0a 2020 2020 2020 2020 7265     )..        re
-00043290: 7475 726e 2022 4f4b 220a 0a20 2020 2040  turn "OK"..    @
-000432a0: 6c6f 675f 6572 726f 7273 0a20 2020 2064  log_errors.    d
-000432b0: 6566 2075 7064 6174 655f 6461 7461 280a  ef update_data(.
-000432c0: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
-000432d0: 2020 2020 2020 2a2c 0a20 2020 2020 2020        *,.       
-000432e0: 2077 686f 5f68 6173 3a20 6469 6374 5b4b   who_has: dict[K
-000432f0: 6579 2c20 6c69 7374 5b73 7472 5d5d 2c0a  ey, list[str]],.
-00043300: 2020 2020 2020 2020 6e62 7974 6573 3a20          nbytes: 
-00043310: 6469 6374 5b4b 6579 2c20 696e 745d 2c0a  dict[Key, int],.
-00043320: 2020 2020 2020 2020 636c 6965 6e74 3a20          client: 
-00043330: 7374 7220 7c20 4e6f 6e65 203d 204e 6f6e  str | None = Non
-00043340: 652c 0a20 2020 2029 202d 3e20 4e6f 6e65  e,.    ) -> None
-00043350: 3a0a 2020 2020 2020 2020 2222 224c 6561  :.        """Lea
-00043360: 726e 2074 6861 7420 6e65 7720 6461 7461  rn that new data
-00043370: 2068 6173 2065 6e74 6572 6564 2074 6865   has entered the
-00043380: 206e 6574 776f 726b 2066 726f 6d20 616e   network from an
-00043390: 2065 7874 6572 6e61 6c20 736f 7572 6365   external source
-000433a0: 2222 220a 2020 2020 2020 2020 7768 6f5f  """.        who_
-000433b0: 6861 7320 3d20 7b6b 3a20 5b73 656c 662e  has = {k: [self.
-000433c0: 636f 6572 6365 5f61 6464 7265 7373 2876  coerce_address(v
-000433d0: 7629 2066 6f72 2076 7620 696e 2076 5d20  v) for vv in v] 
-000433e0: 666f 7220 6b2c 2076 2069 6e20 7768 6f5f  for k, v in who_
-000433f0: 6861 732e 6974 656d 7328 297d 0a20 2020  has.items()}.   
-00043400: 2020 2020 206c 6f67 6765 722e 6465 6275       logger.debu
-00043410: 6728 2255 7064 6174 6520 6461 7461 2025  g("Update data %
-00043420: 7322 2c20 7768 6f5f 6861 7329 0a0a 2020  s", who_has)..  
-00043430: 2020 2020 2020 666f 7220 6b65 792c 2077        for key, w
-00043440: 6f72 6b65 7273 2069 6e20 7768 6f5f 6861  orkers in who_ha
-00043450: 732e 6974 656d 7328 293a 0a20 2020 2020  s.items():.     
-00043460: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
-00043470: 2e74 6173 6b73 2e67 6574 286b 6579 290a  .tasks.get(key).
-00043480: 2020 2020 2020 2020 2020 2020 6966 2074              if t
-00043490: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
-000434a0: 2020 2020 2020 2020 2020 2074 7320 3d20             ts = 
-000434b0: 7365 6c66 2e6e 6577 5f74 6173 6b28 6b65  self.new_task(ke
-000434c0: 792c 204e 6f6e 652c 2022 6d65 6d6f 7279  y, None, "memory
-000434d0: 2229 0a20 2020 2020 2020 2020 2020 2074  ").            t
-000434e0: 732e 7374 6174 6520 3d20 226d 656d 6f72  s.state = "memor
-000434f0: 7922 0a20 2020 2020 2020 2020 2020 2074  y".            t
-00043500: 735f 6e62 7974 6573 203d 206e 6279 7465  s_nbytes = nbyte
-00043510: 732e 6765 7428 6b65 792c 202d 3129 0a20  s.get(key, -1). 
-00043520: 2020 2020 2020 2020 2020 2069 6620 7473             if ts
-00043530: 5f6e 6279 7465 7320 3e3d 2030 3a0a 2020  _nbytes >= 0:.  
-00043540: 2020 2020 2020 2020 2020 2020 2020 7473                ts
-00043550: 2e73 6574 5f6e 6279 7465 7328 7473 5f6e  .set_nbytes(ts_n
-00043560: 6279 7465 7329 0a0a 2020 2020 2020 2020  bytes)..        
-00043570: 2020 2020 666f 7220 7720 696e 2077 6f72      for w in wor
-00043580: 6b65 7273 3a0a 2020 2020 2020 2020 2020  kers:.          
-00043590: 2020 2020 2020 7773 203d 2073 656c 662e        ws = self.
-000435a0: 776f 726b 6572 735b 775d 0a20 2020 2020  workers[w].     
-000435b0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000435c0: 6164 645f 7265 706c 6963 6128 7473 2c20  add_replica(ts, 
-000435d0: 7773 290a 2020 2020 2020 2020 2020 2020  ws).            
-000435e0: 7365 6c66 2e72 6570 6f72 7428 7b22 6f70  self.report({"op
-000435f0: 223a 2022 6b65 792d 696e 2d6d 656d 6f72  ": "key-in-memor
-00043600: 7922 2c20 226b 6579 223a 206b 6579 2c20  y", "key": key, 
-00043610: 2277 6f72 6b65 7273 223a 206c 6973 7428  "workers": list(
-00043620: 776f 726b 6572 7329 7d29 0a0a 2020 2020  workers)})..    
-00043630: 2020 2020 6966 2063 6c69 656e 743a 0a20      if client:. 
-00043640: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00043650: 636c 6965 6e74 5f64 6573 6972 6573 5f6b  client_desires_k
-00043660: 6579 7328 6b65 7973 3d6c 6973 7428 7768  eys(keys=list(wh
-00043670: 6f5f 6861 7329 2c20 636c 6965 6e74 3d63  o_has), client=c
-00043680: 6c69 656e 7429 0a0a 2020 2020 406f 7665  lient)..    @ove
-00043690: 726c 6f61 640a 2020 2020 6465 6620 7265  rload.    def re
-000436a0: 706f 7274 5f6f 6e5f 6b65 7928 7365 6c66  port_on_key(self
-000436b0: 2c20 6b65 793a 204b 6579 2c20 2a2c 2063  , key: Key, *, c
-000436c0: 6c69 656e 743a 2073 7472 207c 204e 6f6e  lient: str | Non
-000436d0: 6520 3d20 4e6f 6e65 2920 2d3e 204e 6f6e  e = None) -> Non
-000436e0: 653a 0a20 2020 2020 2020 202e 2e2e 0a0a  e:.        .....
-000436f0: 2020 2020 406f 7665 726c 6f61 640a 2020      @overload.  
-00043700: 2020 6465 6620 7265 706f 7274 5f6f 6e5f    def report_on_
-00043710: 6b65 7928 7365 6c66 2c20 2a2c 2074 733a  key(self, *, ts:
-00043720: 2054 6173 6b53 7461 7465 2c20 636c 6965   TaskState, clie
-00043730: 6e74 3a20 7374 7220 7c20 4e6f 6e65 203d  nt: str | None =
-00043740: 204e 6f6e 6529 202d 3e20 4e6f 6e65 3a0a   None) -> None:.
-00043750: 2020 2020 2020 2020 2e2e 2e0a 0a20 2020          .....   
-00043760: 2064 6566 2072 6570 6f72 745f 6f6e 5f6b   def report_on_k
-00043770: 6579 2873 656c 662c 206b 6579 3d4e 6f6e  ey(self, key=Non
-00043780: 652c 202a 2c20 7473 3d4e 6f6e 652c 2063  e, *, ts=None, c
-00043790: 6c69 656e 743d 4e6f 6e65 293a 0a20 2020  lient=None):.   
-000437a0: 2020 2020 2069 6620 2874 7320 6973 204e       if (ts is N
-000437b0: 6f6e 6529 203d 3d20 286b 6579 2069 7320  one) == (key is 
-000437c0: 4e6f 6e65 293a 0a20 2020 2020 2020 2020  None):.         
-000437d0: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-000437e0: 726f 7228 2020 2320 7072 6167 6d61 3a20  ror(  # pragma: 
-000437f0: 6e6f 636f 7665 720a 2020 2020 2020 2020  nocover.        
-00043800: 2020 2020 2020 2020 6622 7473 2061 6e64          f"ts and
-00043810: 206b 6579 2061 7265 206d 7574 7561 6c6c   key are mutuall
-00043820: 7920 6578 636c 7573 6976 653b 2072 6563  y exclusive; rec
-00043830: 6569 7665 6420 7b6b 6579 3d21 727d 2c20  eived {key=!r}, 
-00043840: 7b74 733d 2172 7d22 0a20 2020 2020 2020  {ts=!r}".       
-00043850: 2020 2020 2029 0a20 2020 2020 2020 2069       ).        i
-00043860: 6620 7473 2069 7320 4e6f 6e65 3a0a 2020  f ts is None:.  
-00043870: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00043880: 206b 6579 2069 7320 6e6f 7420 4e6f 6e65   key is not None
-00043890: 0a20 2020 2020 2020 2020 2020 2074 7320  .            ts 
-000438a0: 3d20 7365 6c66 2e74 6173 6b73 2e67 6574  = self.tasks.get
-000438b0: 286b 6579 290a 2020 2020 2020 2020 656c  (key).        el
-000438c0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-000438d0: 6b65 7920 3d20 7473 2e6b 6579 0a0a 2020  key = ts.key..  
-000438e0: 2020 2020 2020 6966 2074 7320 6973 206e        if ts is n
-000438f0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00043900: 2020 2020 2072 6570 6f72 745f 6d73 6720       report_msg 
-00043910: 3d20 5f74 6173 6b5f 746f 5f72 6570 6f72  = _task_to_repor
-00043920: 745f 6d73 6728 7473 290a 2020 2020 2020  t_msg(ts).      
-00043930: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00043940: 2020 2020 7265 706f 7274 5f6d 7367 203d      report_msg =
-00043950: 207b 226f 7022 3a20 2263 616e 6365 6c6c   {"op": "cancell
-00043960: 6564 2d6b 6579 7322 2c20 226b 6579 7322  ed-keys", "keys"
-00043970: 3a20 5b6b 6579 5d7d 0a20 2020 2020 2020  : [key]}.       
-00043980: 2069 6620 7265 706f 7274 5f6d 7367 2069   if report_msg i
-00043990: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-000439a0: 2020 2020 2020 2020 7365 6c66 2e72 6570          self.rep
-000439b0: 6f72 7428 7265 706f 7274 5f6d 7367 2c20  ort(report_msg, 
-000439c0: 7473 3d74 732c 2063 6c69 656e 743d 636c  ts=ts, client=cl
-000439d0: 6965 6e74 290a 0a20 2020 2040 6c6f 675f  ient)..    @log_
-000439e0: 6572 726f 7273 0a20 2020 2061 7379 6e63  errors.    async
-000439f0: 2064 6566 2066 6565 6428 0a20 2020 2020   def feed(.     
-00043a00: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-00043a10: 2063 6f6d 6d3a 2043 6f6d 6d2c 0a20 2020   comm: Comm,.   
-00043a20: 2020 2020 2066 756e 6374 696f 6e3a 2062       function: b
-00043a30: 7974 6573 207c 204e 6f6e 6520 3d20 4e6f  ytes | None = No
-00043a40: 6e65 2c0a 2020 2020 2020 2020 7365 7475  ne,.        setu
-00043a50: 703a 2062 7974 6573 207c 204e 6f6e 6520  p: bytes | None 
-00043a60: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-00043a70: 7465 6172 646f 776e 3a20 6279 7465 7320  teardown: bytes 
-00043a80: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
-00043a90: 2020 2020 2020 2069 6e74 6572 7661 6c3a         interval:
-00043aa0: 2073 7472 207c 2066 6c6f 6174 203d 2022   str | float = "
-00043ab0: 3173 222c 0a20 2020 2020 2020 202a 2a6b  1s",.        **k
-00043ac0: 7761 7267 733a 2041 6e79 2c0a 2020 2020  wargs: Any,.    
-00043ad0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-00043ae0: 2020 2022 2222 0a20 2020 2020 2020 2050     """.        P
-00043af0: 726f 7669 6465 7320 6120 6461 7461 2043  rovides a data C
-00043b00: 6f6d 6d20 746f 2065 7874 6572 6e61 6c20  omm to external 
-00043b10: 7265 7175 6573 7465 720a 0a20 2020 2020  requester..     
-00043b20: 2020 2043 6175 7469 6f6e 3a20 7468 6973     Caution: this
-00043b30: 2072 756e 7320 6172 6269 7472 6172 7920   runs arbitrary 
-00043b40: 5079 7468 6f6e 2063 6f64 6520 6f6e 2074  Python code on t
-00043b50: 6865 2073 6368 6564 756c 6572 2e20 2054  he scheduler.  T
-00043b60: 6869 7320 7368 6f75 6c64 0a20 2020 2020  his should.     
-00043b70: 2020 2065 7665 6e74 7561 6c6c 7920 6265     eventually be
-00043b80: 2070 6861 7365 6420 6f75 742e 2020 4974   phased out.  It
-00043b90: 2069 7320 6d6f 7374 6c79 2075 7365 6420   is mostly used 
-00043ba0: 6279 2064 6961 676e 6f73 7469 6373 2e0a  by diagnostics..
-00043bb0: 2020 2020 2020 2020 2222 220a 0a20 2020          """..   
-00043bc0: 2020 2020 2069 6e74 6572 7661 6c20 3d20       interval = 
-00043bd0: 7061 7273 655f 7469 6d65 6465 6c74 6128  parse_timedelta(
-00043be0: 696e 7465 7276 616c 290a 2020 2020 2020  interval).      
-00043bf0: 2020 6966 2066 756e 6374 696f 6e3a 0a20    if function:. 
-00043c00: 2020 2020 2020 2020 2020 2066 756e 6374             funct
-00043c10: 696f 6e20 3d20 7069 636b 6c65 2e6c 6f61  ion = pickle.loa
-00043c20: 6473 2866 756e 6374 696f 6e29 0a20 2020  ds(function).   
-00043c30: 2020 2020 2069 6620 7365 7475 703a 0a20       if setup:. 
-00043c40: 2020 2020 2020 2020 2020 2073 6574 7570             setup
-00043c50: 203d 2070 6963 6b6c 652e 6c6f 6164 7328   = pickle.loads(
-00043c60: 7365 7475 7029 0a0a 2020 2020 2020 2020  setup)..        
-00043c70: 6966 2074 6561 7264 6f77 6e3a 0a20 2020  if teardown:.   
-00043c80: 2020 2020 2020 2020 2074 6561 7264 6f77           teardow
-00043c90: 6e20 3d20 7069 636b 6c65 2e6c 6f61 6473  n = pickle.loads
-00043ca0: 2874 6561 7264 6f77 6e29 0a20 2020 2020  (teardown).     
-00043cb0: 2020 2073 7461 7465 203d 2073 6574 7570     state = setup
-00043cc0: 2873 656c 6629 2069 6620 7365 7475 7020  (self) if setup 
-00043cd0: 656c 7365 204e 6f6e 6520 2023 2074 7970  else None  # typ
-00043ce0: 653a 2069 676e 6f72 650a 2020 2020 2020  e: ignore.      
-00043cf0: 2020 6966 2069 6e73 7065 6374 2e69 7361    if inspect.isa
-00043d00: 7761 6974 6162 6c65 2873 7461 7465 293a  waitable(state):
-00043d10: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
-00043d20: 7465 203d 2061 7761 6974 2073 7461 7465  te = await state
-00043d30: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-00043d40: 2020 2020 2020 2020 2020 7768 696c 6520            while 
-00043d50: 7365 6c66 2e73 7461 7475 7320 3d3d 2053  self.status == S
-00043d60: 7461 7475 732e 7275 6e6e 696e 673a 0a20  tatus.running:. 
-00043d70: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00043d80: 6620 7374 6174 6520 6973 204e 6f6e 653a  f state is None:
-00043d90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00043da0: 2020 2020 2072 6573 706f 6e73 6520 3d20       response = 
-00043db0: 6675 6e63 7469 6f6e 2873 656c 6629 2020  function(self)  
-00043dc0: 2320 7479 7065 3a20 6967 6e6f 7265 0a20  # type: ignore. 
-00043dd0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00043de0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00043df0: 2020 2020 2020 2020 2072 6573 706f 6e73           respons
-00043e00: 6520 3d20 6675 6e63 7469 6f6e 2873 656c  e = function(sel
-00043e10: 662c 2073 7461 7465 2920 2023 2074 7970  f, state)  # typ
-00043e20: 653a 2069 676e 6f72 650a 2020 2020 2020  e: ignore.      
-00043e30: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-00043e40: 636f 6d6d 2e77 7269 7465 2872 6573 706f  comm.write(respo
-00043e50: 6e73 6529 0a20 2020 2020 2020 2020 2020  nse).           
-00043e60: 2020 2020 2061 7761 6974 2061 7379 6e63       await async
-00043e70: 696f 2e73 6c65 6570 2869 6e74 6572 7661  io.sleep(interva
-00043e80: 6c29 0a20 2020 2020 2020 2065 7863 6570  l).        excep
-00043e90: 7420 4f53 4572 726f 723a 0a20 2020 2020  t OSError:.     
-00043ea0: 2020 2020 2020 2070 6173 730a 2020 2020         pass.    
-00043eb0: 2020 2020 6669 6e61 6c6c 793a 0a20 2020      finally:.   
-00043ec0: 2020 2020 2020 2020 2069 6620 7465 6172           if tear
-00043ed0: 646f 776e 3a0a 2020 2020 2020 2020 2020  down:.          
-00043ee0: 2020 2020 2020 7465 6172 646f 776e 2873        teardown(s
-00043ef0: 656c 662c 2073 7461 7465 2920 2023 2074  elf, state)  # t
-00043f00: 7970 653a 2069 676e 6f72 650a 0a20 2020  ype: ignore..   
-00043f10: 2064 6566 206c 6f67 5f77 6f72 6b65 725f   def log_worker_
-00043f20: 6576 656e 7428 0a20 2020 2020 2020 2073  event(.        s
-00043f30: 656c 662c 2077 6f72 6b65 723a 2073 7472  elf, worker: str
-00043f40: 2c20 746f 7069 633a 2073 7472 207c 2043  , topic: str | C
-00043f50: 6f6c 6c65 6374 696f 6e5b 7374 725d 2c20  ollection[str], 
-00043f60: 6d73 673a 2041 6e79 0a20 2020 2029 202d  msg: Any.    ) -
-00043f70: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-00043f80: 6966 2069 7369 6e73 7461 6e63 6528 6d73  if isinstance(ms
-00043f90: 672c 2064 6963 7429 2061 6e64 2077 6f72  g, dict) and wor
-00043fa0: 6b65 7220 213d 2074 6f70 6963 3a0a 2020  ker != topic:.  
-00043fb0: 2020 2020 2020 2020 2020 6d73 675b 2277            msg["w
-00043fc0: 6f72 6b65 7222 5d20 3d20 776f 726b 6572  orker"] = worker
-00043fd0: 0a20 2020 2020 2020 2073 656c 662e 6c6f  .        self.lo
-00043fe0: 675f 6576 656e 7428 746f 7069 632c 206d  g_event(topic, m
-00043ff0: 7367 290a 0a20 2020 2064 6566 2073 7562  sg)..    def sub
-00044000: 7363 7269 6265 5f77 6f72 6b65 725f 7374  scribe_worker_st
-00044010: 6174 7573 2873 656c 662c 2063 6f6d 6d3a  atus(self, comm:
-00044020: 2043 6f6d 6d29 202d 3e20 6469 6374 5b73   Comm) -> dict[s
-00044030: 7472 2c20 416e 795d 3a0a 2020 2020 2020  tr, Any]:.      
-00044040: 2020 576f 726b 6572 5374 6174 7573 506c    WorkerStatusPl
-00044050: 7567 696e 2873 656c 662c 2063 6f6d 6d29  ugin(self, comm)
-00044060: 0a20 2020 2020 2020 2069 6465 6e74 203d  .        ident =
-00044070: 2073 656c 662e 6964 656e 7469 7479 2829   self.identity()
-00044080: 0a20 2020 2020 2020 2066 6f72 2076 2069  .        for v i
-00044090: 6e20 6964 656e 745b 2277 6f72 6b65 7273  n ident["workers
-000440a0: 225d 2e76 616c 7565 7328 293a 0a20 2020  "].values():.   
-000440b0: 2020 2020 2020 2020 2064 656c 2076 5b22           del v["
-000440c0: 6d65 7472 6963 7322 5d0a 2020 2020 2020  metrics"].      
-000440d0: 2020 2020 2020 6465 6c20 765b 226c 6173        del v["las
-000440e0: 745f 7365 656e 225d 0a20 2020 2020 2020  t_seen"].       
-000440f0: 2072 6574 7572 6e20 6964 656e 740a 0a20   return ident.. 
-00044100: 2020 2064 6566 2067 6574 5f70 726f 6365     def get_proce
-00044110: 7373 696e 6728 0a20 2020 2020 2020 2073  ssing(.        s
-00044120: 656c 662c 2077 6f72 6b65 7273 3a20 4974  elf, workers: It
-00044130: 6572 6162 6c65 5b73 7472 5d20 7c20 4e6f  erable[str] | No
-00044140: 6e65 203d 204e 6f6e 650a 2020 2020 2920  ne = None.    ) 
-00044150: 2d3e 2064 6963 745b 7374 722c 206c 6973  -> dict[str, lis
-00044160: 745b 4b65 795d 5d3a 0a20 2020 2020 2020  t[Key]]:.       
-00044170: 2069 6620 776f 726b 6572 7320 6973 206e   if workers is n
-00044180: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00044190: 2020 2020 2077 6f72 6b65 7273 203d 2073       workers = s
-000441a0: 6574 286d 6170 2873 656c 662e 636f 6572  et(map(self.coer
-000441b0: 6365 5f61 6464 7265 7373 2c20 776f 726b  ce_address, work
-000441c0: 6572 7329 290a 2020 2020 2020 2020 2020  ers)).          
-000441d0: 2020 7265 7475 726e 207b 773a 205b 7473    return {w: [ts
-000441e0: 2e6b 6579 2066 6f72 2074 7320 696e 2073  .key for ts in s
-000441f0: 656c 662e 776f 726b 6572 735b 775d 2e70  elf.workers[w].p
-00044200: 726f 6365 7373 696e 675d 2066 6f72 2077  rocessing] for w
-00044210: 2069 6e20 776f 726b 6572 737d 0a20 2020   in workers}.   
-00044220: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00044230: 2020 2020 2020 2072 6574 7572 6e20 7b0a         return {.
-00044240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00044250: 773a 205b 7473 2e6b 6579 2066 6f72 2074  w: [ts.key for t
-00044260: 7320 696e 2077 732e 7072 6f63 6573 7369  s in ws.processi
-00044270: 6e67 5d20 666f 7220 772c 2077 7320 696e  ng] for w, ws in
-00044280: 2073 656c 662e 776f 726b 6572 732e 6974   self.workers.it
-00044290: 656d 7328 290a 2020 2020 2020 2020 2020  ems().          
-000442a0: 2020 7d0a 0a20 2020 2064 6566 2067 6574    }..    def get
-000442b0: 5f77 686f 5f68 6173 2873 656c 662c 206b  _who_has(self, k
-000442c0: 6579 733a 2049 7465 7261 626c 655b 4b65  eys: Iterable[Ke
-000442d0: 795d 207c 204e 6f6e 6520 3d20 4e6f 6e65  y] | None = None
-000442e0: 2920 2d3e 2064 6963 745b 4b65 792c 206c  ) -> dict[Key, l
-000442f0: 6973 745b 7374 725d 5d3a 0a20 2020 2020  ist[str]]:.     
-00044300: 2020 2069 6620 6b65 7973 2069 7320 6e6f     if keys is no
-00044310: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-00044320: 2020 2020 7265 7475 726e 207b 0a20 2020      return {.   
-00044330: 2020 2020 2020 2020 2020 2020 206b 6579               key
-00044340: 3a20 5b77 732e 6164 6472 6573 7320 666f  : [ws.address fo
-00044350: 7220 7773 2069 6e20 7365 6c66 2e74 6173  r ws in self.tas
-00044360: 6b73 5b6b 6579 5d2e 7768 6f5f 6861 7320  ks[key].who_has 
-00044370: 6f72 2028 295d 0a20 2020 2020 2020 2020  or ()].         
-00044380: 2020 2020 2020 2069 6620 6b65 7920 696e         if key in
-00044390: 2073 656c 662e 7461 736b 730a 2020 2020   self.tasks.    
-000443a0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-000443b0: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
-000443c0: 2020 2020 666f 7220 6b65 7920 696e 206b      for key in k
-000443d0: 6579 730a 2020 2020 2020 2020 2020 2020  eys.            
-000443e0: 7d0a 2020 2020 2020 2020 656c 7365 3a0a  }.        else:.
-000443f0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00044400: 726e 207b 0a20 2020 2020 2020 2020 2020  rn {.           
-00044410: 2020 2020 206b 6579 3a20 5b77 732e 6164       key: [ws.ad
-00044420: 6472 6573 7320 666f 7220 7773 2069 6e20  dress for ws in 
-00044430: 7473 2e77 686f 5f68 6173 206f 7220 2829  ts.who_has or ()
-00044440: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00044450: 2020 666f 7220 6b65 792c 2074 7320 696e    for key, ts in
-00044460: 2073 656c 662e 7461 736b 732e 6974 656d   self.tasks.item
-00044470: 7328 290a 2020 2020 2020 2020 2020 2020  s().            
-00044480: 7d0a 0a20 2020 2064 6566 2067 6574 5f68  }..    def get_h
-00044490: 6173 5f77 6861 7428 0a20 2020 2020 2020  as_what(.       
-000444a0: 2073 656c 662c 2077 6f72 6b65 7273 3a20   self, workers: 
-000444b0: 4974 6572 6162 6c65 5b73 7472 5d20 7c20  Iterable[str] | 
-000444c0: 4e6f 6e65 203d 204e 6f6e 650a 2020 2020  None = None.    
-000444d0: 2920 2d3e 2064 6963 745b 7374 722c 206c  ) -> dict[str, l
-000444e0: 6973 745b 4b65 795d 5d3a 0a20 2020 2020  ist[Key]]:.     
-000444f0: 2020 2069 6620 776f 726b 6572 7320 6973     if workers is
-00044500: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-00044510: 2020 2020 2020 2077 6f72 6b65 7273 203d         workers =
-00044520: 206d 6170 2873 656c 662e 636f 6572 6365   map(self.coerce
-00044530: 5f61 6464 7265 7373 2c20 776f 726b 6572  _address, worker
-00044540: 7329 0a20 2020 2020 2020 2020 2020 2072  s).            r
-00044550: 6574 7572 6e20 7b0a 2020 2020 2020 2020  eturn {.        
-00044560: 2020 2020 2020 2020 773a 205b 7473 2e6b          w: [ts.k
-00044570: 6579 2066 6f72 2074 7320 696e 2073 656c  ey for ts in sel
-00044580: 662e 776f 726b 6572 735b 775d 2e68 6173  f.workers[w].has
-00044590: 5f77 6861 745d 0a20 2020 2020 2020 2020  _what].         
-000445a0: 2020 2020 2020 2069 6620 7720 696e 2073         if w in s
-000445b0: 656c 662e 776f 726b 6572 730a 2020 2020  elf.workers.    
-000445c0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-000445d0: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
-000445e0: 2020 2020 666f 7220 7720 696e 2077 6f72      for w in wor
-000445f0: 6b65 7273 0a20 2020 2020 2020 2020 2020  kers.           
-00044600: 207d 0a20 2020 2020 2020 2065 6c73 653a   }.        else:
-00044610: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00044620: 7572 6e20 7b77 3a20 5b74 732e 6b65 7920  urn {w: [ts.key 
-00044630: 666f 7220 7473 2069 6e20 7773 2e68 6173  for ts in ws.has
-00044640: 5f77 6861 745d 2066 6f72 2077 2c20 7773  _what] for w, ws
-00044650: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
-00044660: 2e69 7465 6d73 2829 7d0a 0a20 2020 2064  .items()}..    d
-00044670: 6566 2067 6574 5f6e 636f 7265 7328 7365  ef get_ncores(se
-00044680: 6c66 2c20 776f 726b 6572 733a 2049 7465  lf, workers: Ite
-00044690: 7261 626c 655b 7374 725d 207c 204e 6f6e  rable[str] | Non
-000446a0: 6520 3d20 4e6f 6e65 2920 2d3e 2064 6963  e = None) -> dic
-000446b0: 745b 7374 722c 2069 6e74 5d3a 0a20 2020  t[str, int]:.   
-000446c0: 2020 2020 2069 6620 776f 726b 6572 7320       if workers 
-000446d0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-000446e0: 2020 2020 2020 2020 2077 6f72 6b65 7273           workers
-000446f0: 203d 206d 6170 2873 656c 662e 636f 6572   = map(self.coer
-00044700: 6365 5f61 6464 7265 7373 2c20 776f 726b  ce_address, work
-00044710: 6572 7329 0a20 2020 2020 2020 2020 2020  ers).           
-00044720: 2072 6574 7572 6e20 7b77 3a20 7365 6c66   return {w: self
-00044730: 2e77 6f72 6b65 7273 5b77 5d2e 6e74 6872  .workers[w].nthr
-00044740: 6561 6473 2066 6f72 2077 2069 6e20 776f  eads for w in wo
-00044750: 726b 6572 7320 6966 2077 2069 6e20 7365  rkers if w in se
-00044760: 6c66 2e77 6f72 6b65 7273 7d0a 2020 2020  lf.workers}.    
-00044770: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00044780: 2020 2020 2020 7265 7475 726e 207b 773a        return {w:
-00044790: 2077 732e 6e74 6872 6561 6473 2066 6f72   ws.nthreads for
-000447a0: 2077 2c20 7773 2069 6e20 7365 6c66 2e77   w, ws in self.w
-000447b0: 6f72 6b65 7273 2e69 7465 6d73 2829 7d0a  orkers.items()}.
-000447c0: 0a20 2020 2064 6566 2067 6574 5f6e 636f  .    def get_nco
-000447d0: 7265 735f 7275 6e6e 696e 6728 0a20 2020  res_running(.   
-000447e0: 2020 2020 2073 656c 662c 2077 6f72 6b65       self, worke
-000447f0: 7273 3a20 4974 6572 6162 6c65 5b73 7472  rs: Iterable[str
-00044800: 5d20 7c20 4e6f 6e65 203d 204e 6f6e 650a  ] | None = None.
-00044810: 2020 2020 2920 2d3e 2064 6963 745b 7374      ) -> dict[st
-00044820: 722c 2069 6e74 5d3a 0a20 2020 2020 2020  r, int]:.       
-00044830: 206e 636f 7265 7320 3d20 7365 6c66 2e67   ncores = self.g
-00044840: 6574 5f6e 636f 7265 7328 776f 726b 6572  et_ncores(worker
-00044850: 733d 776f 726b 6572 7329 0a20 2020 2020  s=workers).     
-00044860: 2020 2072 6574 7572 6e20 7b0a 2020 2020     return {.    
-00044870: 2020 2020 2020 2020 773a 206e 2066 6f72          w: n for
-00044880: 2077 2c20 6e20 696e 206e 636f 7265 732e   w, n in ncores.
-00044890: 6974 656d 7328 2920 6966 2073 656c 662e  items() if self.
-000448a0: 776f 726b 6572 735b 775d 2e73 7461 7475  workers[w].statu
-000448b0: 7320 3d3d 2053 7461 7475 732e 7275 6e6e  s == Status.runn
-000448c0: 696e 670a 2020 2020 2020 2020 7d0a 0a20  ing.        }.. 
-000448d0: 2020 2061 7379 6e63 2064 6566 2067 6574     async def get
-000448e0: 5f63 616c 6c5f 7374 6163 6b28 7365 6c66  _call_stack(self
-000448f0: 2c20 6b65 7973 3a20 4974 6572 6162 6c65  , keys: Iterable
-00044900: 5b4b 6579 5d20 7c20 4e6f 6e65 203d 204e  [Key] | None = N
-00044910: 6f6e 6529 202d 3e20 6469 6374 5b73 7472  one) -> dict[str
-00044920: 2c20 416e 795d 3a0a 2020 2020 2020 2020  , Any]:.        
-00044930: 776f 726b 6572 733a 2064 6963 745b 7374  workers: dict[st
-00044940: 722c 206c 6973 745b 4b65 795d 207c 204e  r, list[Key] | N
-00044950: 6f6e 655d 0a20 2020 2020 2020 2069 6620  one].        if 
-00044960: 6b65 7973 2069 7320 6e6f 7420 4e6f 6e65  keys is not None
-00044970: 3a0a 2020 2020 2020 2020 2020 2020 7374  :.            st
-00044980: 6163 6b20 3d20 6c69 7374 286b 6579 7329  ack = list(keys)
-00044990: 0a20 2020 2020 2020 2020 2020 2070 726f  .            pro
-000449a0: 6365 7373 696e 6720 3d20 7365 7428 290a  cessing = set().
-000449b0: 2020 2020 2020 2020 2020 2020 7768 696c              whil
-000449c0: 6520 7374 6163 6b3a 0a20 2020 2020 2020  e stack:.       
-000449d0: 2020 2020 2020 2020 206b 6579 203d 2073           key = s
-000449e0: 7461 636b 2e70 6f70 2829 0a20 2020 2020  tack.pop().     
-000449f0: 2020 2020 2020 2020 2020 2074 7320 3d20             ts = 
-00044a00: 7365 6c66 2e74 6173 6b73 5b6b 6579 5d0a  self.tasks[key].
-00044a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00044a20: 6966 2074 732e 7374 6174 6520 3d3d 2022  if ts.state == "
-00044a30: 7761 6974 696e 6722 3a0a 2020 2020 2020  waiting":.      
-00044a40: 2020 2020 2020 2020 2020 2020 2020 7374                st
-00044a50: 6163 6b2e 6578 7465 6e64 285b 6474 732e  ack.extend([dts.
-00044a60: 6b65 7920 666f 7220 6474 7320 696e 2074  key for dts in t
-00044a70: 732e 6465 7065 6e64 656e 6369 6573 5d29  s.dependencies])
-00044a80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00044a90: 2065 6c69 6620 7473 2e73 7461 7465 203d   elif ts.state =
-00044aa0: 3d20 2270 726f 6365 7373 696e 6722 3a0a  = "processing":.
-00044ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00044ac0: 2020 2020 7072 6f63 6573 7369 6e67 2e61      processing.a
-00044ad0: 6464 2874 7329 0a0a 2020 2020 2020 2020  dd(ts)..        
-00044ae0: 2020 2020 776f 726b 6572 7320 3d20 6465      workers = de
-00044af0: 6661 756c 7464 6963 7428 6c69 7374 290a  faultdict(list).
-00044b00: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00044b10: 7473 2069 6e20 7072 6f63 6573 7369 6e67  ts in processing
-00044b20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00044b30: 2020 6966 2074 732e 7072 6f63 6573 7369    if ts.processi
-00044b40: 6e67 5f6f 6e3a 0a20 2020 2020 2020 2020  ng_on:.         
-00044b50: 2020 2020 2020 2020 2020 2077 6b65 7973             wkeys
-00044b60: 203d 2077 6f72 6b65 7273 5b74 732e 7072   = workers[ts.pr
-00044b70: 6f63 6573 7369 6e67 5f6f 6e2e 6164 6472  ocessing_on.addr
-00044b80: 6573 735d 0a20 2020 2020 2020 2020 2020  ess].           
-00044b90: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00044ba0: 776b 6579 7320 6973 206e 6f74 204e 6f6e  wkeys is not Non
-00044bb0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00044bc0: 2020 2020 2020 776b 6579 732e 6170 7065        wkeys.appe
-00044bd0: 6e64 2874 732e 6b65 7929 0a20 2020 2020  nd(ts.key).     
-00044be0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00044bf0: 2020 2020 2077 6f72 6b65 7273 203d 207b       workers = {
-00044c00: 773a 204e 6f6e 6520 666f 7220 7720 696e  w: None for w in
-00044c10: 2073 656c 662e 776f 726b 6572 737d 0a0a   self.workers}..
-00044c20: 2020 2020 2020 2020 6966 206e 6f74 2077          if not w
-00044c30: 6f72 6b65 7273 3a0a 2020 2020 2020 2020  orkers:.        
-00044c40: 2020 2020 7265 7475 726e 207b 7d0a 0a20      return {}.. 
-00044c50: 2020 2020 2020 2072 6573 756c 7473 203d         results =
-00044c60: 2061 7761 6974 2061 7379 6e63 696f 2e67   await asyncio.g
-00044c70: 6174 6865 7228 0a20 2020 2020 2020 2020  ather(.         
-00044c80: 2020 202a 2873 656c 662e 7270 6328 7729     *(self.rpc(w)
-00044c90: 2e63 616c 6c5f 7374 6163 6b28 6b65 7973  .call_stack(keys
-00044ca0: 3d76 2920 666f 7220 772c 2076 2069 6e20  =v) for w, v in 
-00044cb0: 776f 726b 6572 732e 6974 656d 7328 2929  workers.items())
-00044cc0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00044cd0: 2020 2072 6573 706f 6e73 6520 3d20 7b77     response = {w
-00044ce0: 3a20 7220 666f 7220 772c 2072 2069 6e20  : r for w, r in 
-00044cf0: 7a69 7028 776f 726b 6572 732c 2072 6573  zip(workers, res
-00044d00: 756c 7473 2920 6966 2072 7d0a 2020 2020  ults) if r}.    
-00044d10: 2020 2020 7265 7475 726e 2072 6573 706f      return respo
-00044d20: 6e73 650a 0a20 2020 2061 7379 6e63 2064  nse..    async d
-00044d30: 6566 2062 656e 6368 6d61 726b 5f68 6172  ef benchmark_har
-00044d40: 6477 6172 6528 7365 6c66 2920 2d3e 2064  dware(self) -> d
-00044d50: 6963 745b 7374 722c 2064 6963 745b 7374  ict[str, dict[st
-00044d60: 722c 2066 6c6f 6174 5d5d 3a0a 2020 2020  r, float]]:.    
-00044d70: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00044d80: 5275 6e20 6120 6265 6e63 686d 6172 6b20  Run a benchmark 
-00044d90: 6f6e 2074 6865 2077 6f72 6b65 7273 2066  on the workers f
-00044da0: 6f72 206d 656d 6f72 792c 2064 6973 6b2c  or memory, disk,
-00044db0: 2061 6e64 206e 6574 776f 726b 2062 616e   and network ban
-00044dc0: 6477 6964 7468 730a 0a20 2020 2020 2020  dwidths..       
-00044dd0: 2052 6574 7572 6e73 0a20 2020 2020 2020   Returns.       
-00044de0: 202d 2d2d 2d2d 2d2d 0a20 2020 2020 2020   -------.       
-00044df0: 2072 6573 756c 743a 2064 6963 740a 2020   result: dict.  
-00044e00: 2020 2020 2020 2020 2020 4120 6469 6374            A dict
-00044e10: 696f 6e61 7279 206d 6170 7069 6e67 2074  ionary mapping t
-00044e20: 6865 206e 616d 6573 2022 6469 736b 222c  he names "disk",
-00044e30: 2022 6d65 6d6f 7279 222c 2061 6e64 2022   "memory", and "
-00044e40: 6e65 7477 6f72 6b22 2074 6f0a 2020 2020  network" to.    
-00044e50: 2020 2020 2020 2020 6469 6374 696f 6e61          dictiona
-00044e60: 7269 6573 206d 6170 7069 6e67 2073 697a  ries mapping siz
-00044e70: 6573 2074 6f20 6261 6e64 7769 6474 6873  es to bandwidths
-00044e80: 2e20 2054 6865 7365 2062 616e 6477 6964  .  These bandwid
-00044e90: 7468 7320 6172 650a 2020 2020 2020 2020  ths are.        
-00044ea0: 2020 2020 6176 6572 6167 6564 206f 7665      averaged ove
-00044eb0: 7220 6d61 6e79 2077 6f72 6b65 7273 2072  r many workers r
-00044ec0: 756e 6e69 6e67 2063 6f6d 7075 7461 7469  unning computati
-00044ed0: 6f6e 7320 6163 726f 7373 2074 6865 2063  ons across the c
-00044ee0: 6c75 7374 6572 2e0a 2020 2020 2020 2020  luster..        
-00044ef0: 2222 220a 2020 2020 2020 2020 6f75 743a  """.        out:
-00044f00: 2064 6963 745b 7374 722c 2064 6566 6175   dict[str, defau
-00044f10: 6c74 6469 6374 5b73 7472 2c20 6c69 7374  ltdict[str, list
-00044f20: 5b66 6c6f 6174 5d5d 5d20 3d20 7b0a 2020  [float]]] = {.  
-00044f30: 2020 2020 2020 2020 2020 6e61 6d65 3a20            name: 
-00044f40: 6465 6661 756c 7464 6963 7428 6c69 7374  defaultdict(list
-00044f50: 2920 666f 7220 6e61 6d65 2069 6e20 5b22  ) for name in ["
-00044f60: 6469 736b 222c 2022 6d65 6d6f 7279 222c  disk", "memory",
-00044f70: 2022 6e65 7477 6f72 6b22 5d0a 2020 2020   "network"].    
-00044f80: 2020 2020 7d0a 0a20 2020 2020 2020 2023      }..        #
-00044f90: 2064 6973 6b0a 2020 2020 2020 2020 7265   disk.        re
-00044fa0: 7375 6c74 203d 2061 7761 6974 2073 656c  sult = await sel
-00044fb0: 662e 6272 6f61 6463 6173 7428 6d73 673d  f.broadcast(msg=
-00044fc0: 7b22 6f70 223a 2022 6265 6e63 686d 6172  {"op": "benchmar
-00044fd0: 6b5f 6469 736b 227d 290a 2020 2020 2020  k_disk"}).      
-00044fe0: 2020 666f 7220 6420 696e 2072 6573 756c    for d in resul
-00044ff0: 742e 7661 6c75 6573 2829 3a0a 2020 2020  t.values():.    
-00045000: 2020 2020 2020 2020 666f 7220 7369 7a65          for size
-00045010: 2c20 6475 7261 7469 6f6e 2069 6e20 642e  , duration in d.
-00045020: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
-00045030: 2020 2020 2020 2020 206f 7574 5b22 6469           out["di
-00045040: 736b 225d 5b73 697a 655d 2e61 7070 656e  sk"][size].appen
-00045050: 6428 6475 7261 7469 6f6e 290a 0a20 2020  d(duration)..   
-00045060: 2020 2020 2023 206d 656d 6f72 790a 2020       # memory.  
-00045070: 2020 2020 2020 7265 7375 6c74 203d 2061        result = a
-00045080: 7761 6974 2073 656c 662e 6272 6f61 6463  wait self.broadc
-00045090: 6173 7428 6d73 673d 7b22 6f70 223a 2022  ast(msg={"op": "
-000450a0: 6265 6e63 686d 6172 6b5f 6d65 6d6f 7279  benchmark_memory
-000450b0: 227d 290a 2020 2020 2020 2020 666f 7220  "}).        for 
-000450c0: 6420 696e 2072 6573 756c 742e 7661 6c75  d in result.valu
-000450d0: 6573 2829 3a0a 2020 2020 2020 2020 2020  es():.          
-000450e0: 2020 666f 7220 7369 7a65 2c20 6475 7261    for size, dura
-000450f0: 7469 6f6e 2069 6e20 642e 6974 656d 7328  tion in d.items(
-00045100: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00045110: 2020 206f 7574 5b22 6d65 6d6f 7279 225d     out["memory"]
-00045120: 5b73 697a 655d 2e61 7070 656e 6428 6475  [size].append(du
-00045130: 7261 7469 6f6e 290a 0a20 2020 2020 2020  ration)..       
-00045140: 2023 206e 6574 776f 726b 0a20 2020 2020   # network.     
-00045150: 2020 2077 6f72 6b65 7273 203d 206c 6973     workers = lis
-00045160: 7428 7365 6c66 2e77 6f72 6b65 7273 290a  t(self.workers).
-00045170: 2020 2020 2020 2020 2320 4f6e 2061 6e20          # On an 
-00045180: 6164 6170 7469 7665 2063 6c75 7374 6572  adaptive cluster
-00045190: 2c20 6966 206d 756c 7469 706c 6520 776f  , if multiple wo
-000451a0: 726b 6572 7320 6172 6520 7374 6172 7465  rkers are starte
-000451b0: 6420 6f6e 2074 6865 2073 616d 6520 7068  d on the same ph
-000451c0: 7973 6963 616c 2068 6f73 742c 0a20 2020  ysical host,.   
-000451d0: 2020 2020 2023 2074 6865 7920 6172 6520       # they are 
-000451e0: 6d6f 7265 206c 696b 656c 7920 746f 2063  more likely to c
-000451f0: 6f6e 6e65 6374 2074 6f20 7468 6520 5363  onnect to the Sc
-00045200: 6865 6475 6c65 7220 696e 2073 6571 7565  heduler in seque
-00045210: 6e63 652c 2065 6e64 696e 6720 7570 206e  nce, ending up n
-00045220: 6578 7420 746f 0a20 2020 2020 2020 2023  ext to.        #
-00045230: 2065 6163 6820 6f74 6865 7220 696e 2074   each other in t
-00045240: 6869 7320 6c69 7374 2e0a 2020 2020 2020  his list..      
-00045250: 2020 2320 5468 6520 7472 616e 7366 6572    # The transfer
-00045260: 2073 7065 6564 2077 6974 6869 6e20 7375   speed within su
-00045270: 6368 2063 6c75 7374 6572 7320 6f66 2077  ch clusters of w
-00045280: 6f72 6b65 7273 2077 696c 6c20 6265 2065  orkers will be e
-00045290: 6666 6563 7469 7665 6c79 2074 6861 7420  ffectively that 
-000452a0: 6f66 0a20 2020 2020 2020 2023 206c 6f63  of.        # loc
-000452b0: 616c 686f 7374 2e20 5468 6973 2063 6f75  alhost. This cou
-000452c0: 6c64 2068 6170 7065 6e20 6163 726f 7373  ld happen across
-000452d0: 2064 6966 6665 7265 6e74 2056 4d73 2061   different VMs a
-000452e0: 6e64 2f6f 7220 646f 636b 6572 2069 6d61  nd/or docker ima
-000452f0: 6765 732c 2073 6f0a 2020 2020 2020 2020  ges, so.        
-00045300: 2320 696d 706c 656d 656e 7469 6e67 206c  # implementing l
-00045310: 6f67 6963 2062 6173 6564 206f 6e20 4950  ogic based on IP
-00045320: 2061 6464 7265 7373 6573 2077 6f75 6c64   addresses would
-00045330: 206e 6f74 206e 6563 6573 7361 7269 6c79   not necessarily
-00045340: 2068 656c 702e 0a20 2020 2020 2020 2023   help..        #
-00045350: 2052 616e 646f 6d69 7a65 2074 6865 2063   Randomize the c
-00045360: 6f6e 6e65 6374 696f 6e73 2074 6f20 6576  onnections to ev
-00045370: 656e 206f 7574 2074 6865 206d 6561 6e20  en out the mean 
-00045380: 6d65 6173 7572 6573 2e0a 2020 2020 2020  measures..      
-00045390: 2020 7261 6e64 6f6d 2e73 6875 6666 6c65    random.shuffle
-000453a0: 2877 6f72 6b65 7273 290a 2020 2020 2020  (workers).      
-000453b0: 2020 6675 7475 7265 7320 3d20 5b0a 2020    futures = [.  
-000453c0: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
-000453d0: 7063 2861 292e 6265 6e63 686d 6172 6b5f  pc(a).benchmark_
-000453e0: 6e65 7477 6f72 6b28 6164 6472 6573 733d  network(address=
-000453f0: 6229 2066 6f72 2061 2c20 6220 696e 2070  b) for a, b in p
-00045400: 6172 7469 7469 6f6e 2832 2c20 776f 726b  artition(2, work
-00045410: 6572 7329 0a20 2020 2020 2020 205d 0a20  ers).        ]. 
-00045420: 2020 2020 2020 2072 6573 706f 6e73 6573         responses
-00045430: 203d 2061 7761 6974 2061 7379 6e63 696f   = await asyncio
-00045440: 2e67 6174 6865 7228 2a66 7574 7572 6573  .gather(*futures
-00045450: 290a 0a20 2020 2020 2020 2066 6f72 2064  )..        for d
-00045460: 2069 6e20 7265 7370 6f6e 7365 733a 0a20   in responses:. 
-00045470: 2020 2020 2020 2020 2020 2066 6f72 2073             for s
-00045480: 697a 652c 2064 7572 6174 696f 6e20 696e  ize, duration in
-00045490: 2064 2e69 7465 6d73 2829 3a0a 2020 2020   d.items():.    
-000454a0: 2020 2020 2020 2020 2020 2020 6f75 745b              out[
-000454b0: 226e 6574 776f 726b 225d 5b73 697a 655d  "network"][size]
-000454c0: 2e61 7070 656e 6428 6475 7261 7469 6f6e  .append(duration
-000454d0: 290a 0a20 2020 2020 2020 2072 6573 756c  )..        resul
-000454e0: 7420 3d20 7b7d 0a20 2020 2020 2020 2066  t = {}.        f
-000454f0: 6f72 206d 6f64 6520 696e 206f 7574 3a0a  or mode in out:.
-00045500: 2020 2020 2020 2020 2020 2020 7265 7375              resu
-00045510: 6c74 5b6d 6f64 655d 203d 207b 0a20 2020  lt[mode] = {.   
-00045520: 2020 2020 2020 2020 2020 2020 2073 697a               siz
-00045530: 653a 2073 756d 2864 7572 6174 696f 6e73  e: sum(durations
-00045540: 2920 2f20 6c65 6e28 6475 7261 7469 6f6e  ) / len(duration
-00045550: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
-00045560: 2020 2066 6f72 2073 697a 652c 2064 7572     for size, dur
-00045570: 6174 696f 6e73 2069 6e20 6f75 745b 6d6f  ations in out[mo
-00045580: 6465 5d2e 6974 656d 7328 290a 2020 2020  de].items().    
-00045590: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-000455a0: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
-000455b0: 0a0a 2020 2020 406c 6f67 5f65 7272 6f72  ..    @log_error
-000455c0: 730a 2020 2020 6465 6620 6765 745f 6e62  s.    def get_nb
-000455d0: 7974 6573 280a 2020 2020 2020 2020 7365  ytes(.        se
-000455e0: 6c66 2c20 6b65 7973 3a20 4974 6572 6162  lf, keys: Iterab
-000455f0: 6c65 5b4b 6579 5d20 7c20 4e6f 6e65 203d  le[Key] | None =
-00045600: 204e 6f6e 652c 2073 756d 6d61 7279 3a20   None, summary: 
-00045610: 626f 6f6c 203d 2054 7275 650a 2020 2020  bool = True.    
-00045620: 2920 2d3e 2064 6963 745b 4b65 792c 2069  ) -> dict[Key, i
-00045630: 6e74 5d3a 0a20 2020 2020 2020 2069 6620  nt]:.        if 
-00045640: 6b65 7973 2069 7320 6e6f 7420 4e6f 6e65  keys is not None
-00045650: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00045660: 7375 6c74 203d 207b 6b3a 2073 656c 662e  sult = {k: self.
-00045670: 7461 736b 735b 6b5d 2e6e 6279 7465 7320  tasks[k].nbytes 
-00045680: 666f 7220 6b20 696e 206b 6579 737d 0a20  for k in keys}. 
-00045690: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-000456a0: 2020 2020 2020 2020 2072 6573 756c 7420           result 
-000456b0: 3d20 7b6b 3a20 7473 2e6e 6279 7465 7320  = {k: ts.nbytes 
-000456c0: 666f 7220 6b2c 2074 7320 696e 2073 656c  for k, ts in sel
-000456d0: 662e 7461 736b 732e 6974 656d 7328 2920  f.tasks.items() 
-000456e0: 6966 2074 732e 6e62 7974 6573 203e 3d20  if ts.nbytes >= 
-000456f0: 307d 0a0a 2020 2020 2020 2020 6966 2073  0}..        if s
-00045700: 756d 6d61 7279 3a0a 2020 2020 2020 2020  ummary:.        
-00045710: 2020 2020 6f75 743a 2064 6566 6175 6c74      out: default
-00045720: 6469 6374 5b4b 6579 2c20 696e 745d 203d  dict[Key, int] =
-00045730: 2064 6566 6175 6c74 6469 6374 2869 6e74   defaultdict(int
-00045740: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
-00045750: 7220 6b2c 2076 2069 6e20 7265 7375 6c74  r k, v in result
-00045760: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
-00045770: 2020 2020 2020 2020 2020 6f75 745b 6b65            out[ke
-00045780: 795f 7370 6c69 7428 6b29 5d20 2b3d 2076  y_split(k)] += v
-00045790: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
-000457a0: 756c 7420 3d20 6469 6374 286f 7574 290a  ult = dict(out).
-000457b0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000457c0: 7265 7375 6c74 0a0a 2020 2020 6465 6620  result..    def 
-000457d0: 7275 6e5f 6675 6e63 7469 6f6e 280a 2020  run_function(.  
-000457e0: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-000457f0: 2020 2020 636f 6d6d 3a20 436f 6d6d 2c0a      comm: Comm,.
-00045800: 2020 2020 2020 2020 6675 6e63 7469 6f6e          function
-00045810: 3a20 4361 6c6c 6162 6c65 2c0a 2020 2020  : Callable,.    
-00045820: 2020 2020 6172 6773 3a20 7475 706c 6520      args: tuple 
-00045830: 3d20 2829 2c0a 2020 2020 2020 2020 6b77  = (),.        kw
-00045840: 6172 6773 3a20 6469 6374 207c 204e 6f6e  args: dict | Non
-00045850: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
-00045860: 2020 7761 6974 3a20 626f 6f6c 203d 2054    wait: bool = T
-00045870: 7275 652c 0a20 2020 2029 202d 3e20 416e  rue,.    ) -> An
-00045880: 793a 0a20 2020 2020 2020 2022 2222 5275  y:.        """Ru
-00045890: 6e20 6120 6675 6e63 7469 6f6e 2077 6974  n a function wit
-000458a0: 6869 6e20 7468 6973 2070 726f 6365 7373  hin this process
-000458b0: 0a0a 2020 2020 2020 2020 5365 6520 416c  ..        See Al
-000458c0: 736f 0a20 2020 2020 2020 202d 2d2d 2d2d  so.        -----
-000458d0: 2d2d 2d0a 2020 2020 2020 2020 436c 6965  ---.        Clie
-000458e0: 6e74 2e72 756e 5f6f 6e5f 7363 6865 6475  nt.run_on_schedu
-000458f0: 6c65 720a 2020 2020 2020 2020 2222 220a  ler.        """.
-00045900: 2020 2020 2020 2020 6672 6f6d 2064 6973          from dis
-00045910: 7472 6962 7574 6564 2e77 6f72 6b65 7220  tributed.worker 
-00045920: 696d 706f 7274 2072 756e 0a0a 2020 2020  import run..    
-00045930: 2020 2020 6b77 6172 6773 203d 206b 7761      kwargs = kwa
-00045940: 7267 7320 6f72 207b 7d0a 2020 2020 2020  rgs or {}.      
-00045950: 2020 7365 6c66 2e6c 6f67 5f65 7665 6e74    self.log_event
-00045960: 2822 616c 6c22 2c20 7b22 6163 7469 6f6e  ("all", {"action
-00045970: 223a 2022 7275 6e2d 6675 6e63 7469 6f6e  ": "run-function
-00045980: 222c 2022 6675 6e63 7469 6f6e 223a 2066  ", "function": f
-00045990: 756e 6374 696f 6e7d 290a 2020 2020 2020  unction}).      
-000459a0: 2020 7265 7475 726e 2072 756e 2873 656c    return run(sel
-000459b0: 662c 2063 6f6d 6d2c 2066 756e 6374 696f  f, comm, functio
-000459c0: 6e3d 6675 6e63 7469 6f6e 2c20 6172 6773  n=function, args
-000459d0: 3d61 7267 732c 206b 7761 7267 733d 6b77  =args, kwargs=kw
-000459e0: 6172 6773 2c20 7761 6974 3d77 6169 7429  args, wait=wait)
-000459f0: 0a0a 2020 2020 6465 6620 7365 745f 6d65  ..    def set_me
-00045a00: 7461 6461 7461 2873 656c 662c 206b 6579  tadata(self, key
-00045a10: 733a 206c 6973 745b 4b65 795d 2c20 7661  s: list[Key], va
-00045a20: 6c75 653a 206f 626a 6563 7420 3d20 4e6f  lue: object = No
-00045a30: 6e65 2920 2d3e 204e 6f6e 653a 0a20 2020  ne) -> None:.   
-00045a40: 2020 2020 206d 6574 6164 6174 6120 3d20       metadata = 
-00045a50: 7365 6c66 2e74 6173 6b5f 6d65 7461 6461  self.task_metada
-00045a60: 7461 0a20 2020 2020 2020 2066 6f72 206b  ta.        for k
-00045a70: 6579 2069 6e20 6b65 7973 5b3a 2d31 5d3a  ey in keys[:-1]:
-00045a80: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00045a90: 6b65 7920 6e6f 7420 696e 206d 6574 6164  key not in metad
-00045aa0: 6174 6120 6f72 206e 6f74 2069 7369 6e73  ata or not isins
-00045ab0: 7461 6e63 6528 6d65 7461 6461 7461 5b6b  tance(metadata[k
-00045ac0: 6579 5d2c 2028 6469 6374 2c20 6c69 7374  ey], (dict, list
-00045ad0: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-00045ae0: 2020 2020 6d65 7461 6461 7461 5b6b 6579      metadata[key
-00045af0: 5d20 3d20 7b7d 0a20 2020 2020 2020 2020  ] = {}.         
-00045b00: 2020 206d 6574 6164 6174 6120 3d20 6d65     metadata = me
-00045b10: 7461 6461 7461 5b6b 6579 5d0a 2020 2020  tadata[key].    
-00045b20: 2020 2020 6d65 7461 6461 7461 5b6b 6579      metadata[key
-00045b30: 735b 2d31 5d5d 203d 2076 616c 7565 0a0a  s[-1]] = value..
-00045b40: 2020 2020 6465 6620 6765 745f 6d65 7461      def get_meta
-00045b50: 6461 7461 2873 656c 662c 206b 6579 733a  data(self, keys:
-00045b60: 206c 6973 745b 4b65 795d 2c20 6465 6661   list[Key], defa
-00045b70: 756c 743a 2041 6e79 203d 206e 6f5f 6465  ult: Any = no_de
-00045b80: 6661 756c 7429 202d 3e20 416e 793a 0a20  fault) -> Any:. 
-00045b90: 2020 2020 2020 206d 6574 6164 6174 6120         metadata 
-00045ba0: 3d20 7365 6c66 2e74 6173 6b5f 6d65 7461  = self.task_meta
-00045bb0: 6461 7461 0a20 2020 2020 2020 2074 7279  data.        try
-00045bc0: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
-00045bd0: 7220 6b65 7920 696e 206b 6579 733a 0a20  r key in keys:. 
-00045be0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00045bf0: 6574 6164 6174 6120 3d20 6d65 7461 6461  etadata = metada
-00045c00: 7461 5b6b 6579 5d0a 2020 2020 2020 2020  ta[key].        
-00045c10: 2020 2020 7265 7475 726e 206d 6574 6164      return metad
-00045c20: 6174 610a 2020 2020 2020 2020 6578 6365  ata.        exce
-00045c30: 7074 204b 6579 4572 726f 723a 0a20 2020  pt KeyError:.   
-00045c40: 2020 2020 2020 2020 2069 6620 6465 6661           if defa
-00045c50: 756c 7420 6973 206e 6f74 206e 6f5f 6465  ult is not no_de
-00045c60: 6661 756c 743a 0a20 2020 2020 2020 2020  fault:.         
-00045c70: 2020 2020 2020 2072 6574 7572 6e20 6465         return de
-00045c80: 6661 756c 740a 2020 2020 2020 2020 2020  fault.          
-00045c90: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00045ca0: 2020 2020 2020 2020 7261 6973 650a 0a20          raise.. 
-00045cb0: 2020 2064 6566 2073 6574 5f72 6573 7472     def set_restr
-00045cc0: 6963 7469 6f6e 7328 7365 6c66 2c20 776f  ictions(self, wo
-00045cd0: 726b 6572 3a20 6469 6374 5b4b 6579 2c20  rker: dict[Key, 
-00045ce0: 436f 6c6c 6563 7469 6f6e 5b73 7472 5d20  Collection[str] 
-00045cf0: 7c20 7374 7220 7c20 4e6f 6e65 5d29 202d  | str | None]) -
-00045d00: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-00045d10: 666f 7220 6b65 792c 2072 6573 7472 6963  for key, restric
-00045d20: 7469 6f6e 7320 696e 2077 6f72 6b65 722e  tions in worker.
-00045d30: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
-00045d40: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
-00045d50: 6173 6b73 5b6b 6579 5d0a 2020 2020 2020  asks[key].      
-00045d60: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-00045d70: 6e63 6528 7265 7374 7269 6374 696f 6e73  nce(restrictions
-00045d80: 2c20 7374 7229 3a0a 2020 2020 2020 2020  , str):.        
-00045d90: 2020 2020 2020 2020 7265 7374 7269 6374          restrict
-00045da0: 696f 6e73 203d 207b 7265 7374 7269 6374  ions = {restrict
-00045db0: 696f 6e73 7d0a 2020 2020 2020 2020 2020  ions}.          
-00045dc0: 2020 7473 2e77 6f72 6b65 725f 7265 7374    ts.worker_rest
-00045dd0: 7269 6374 696f 6e73 203d 2073 6574 2872  rictions = set(r
-00045de0: 6573 7472 6963 7469 6f6e 7329 2069 6620  estrictions) if 
-00045df0: 7265 7374 7269 6374 696f 6e73 2065 6c73  restrictions els
-00045e00: 6520 4e6f 6e65 0a0a 2020 2020 406c 6f67  e None..    @log
-00045e10: 5f65 7272 6f72 730a 2020 2020 6465 6620  _errors.    def 
-00045e20: 6765 745f 7461 736b 5f70 7265 6669 785f  get_task_prefix_
-00045e30: 7374 6174 6573 2873 656c 6629 202d 3e20  states(self) -> 
-00045e40: 6469 6374 5b73 7472 2c20 6469 6374 5b73  dict[str, dict[s
-00045e50: 7472 2c20 696e 745d 5d3a 0a20 2020 2020  tr, int]]:.     
-00045e60: 2020 2073 7461 7465 203d 207b 7d0a 0a20     state = {}.. 
-00045e70: 2020 2020 2020 2066 6f72 2074 7020 696e         for tp in
-00045e80: 2073 656c 662e 7461 736b 5f70 7265 6669   self.task_prefi
-00045e90: 7865 732e 7661 6c75 6573 2829 3a0a 2020  xes.values():.  
-00045ea0: 2020 2020 2020 2020 2020 6163 7469 7665            active
-00045eb0: 5f73 7461 7465 7320 3d20 7470 2e61 6374  _states = tp.act
-00045ec0: 6976 655f 7374 6174 6573 0a20 2020 2020  ive_states.     
-00045ed0: 2020 2020 2020 2073 733a 206c 6973 745b         ss: list[
-00045ee0: 5461 736b 5374 6174 6553 7461 7465 5d20  TaskStateState] 
-00045ef0: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
-00045f00: 2020 2020 226d 656d 6f72 7922 2c0a 2020      "memory",.  
-00045f10: 2020 2020 2020 2020 2020 2020 2020 2265                "e
-00045f20: 7272 6564 222c 0a20 2020 2020 2020 2020  rred",.         
-00045f30: 2020 2020 2020 2022 7265 6c65 6173 6564         "released
-00045f40: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-00045f50: 2020 2022 7072 6f63 6573 7369 6e67 222c     "processing",
-00045f60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00045f70: 2022 7761 6974 696e 6722 2c0a 2020 2020   "waiting",.    
-00045f80: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
-00045f90: 2020 2020 2020 6966 2061 6e79 2861 6374        if any(act
-00045fa0: 6976 655f 7374 6174 6573 2e67 6574 2873  ive_states.get(s
-00045fb0: 2920 666f 7220 7320 696e 2073 7329 3a0a  ) for s in ss):.
-00045fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00045fd0: 7374 6174 655b 7470 2e6e 616d 655d 203d  state[tp.name] =
-00045fe0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00045ff0: 2020 2020 2020 2022 6d65 6d6f 7279 223a         "memory":
-00046000: 2061 6374 6976 655f 7374 6174 6573 5b22   active_states["
-00046010: 6d65 6d6f 7279 225d 2c0a 2020 2020 2020  memory"],.      
-00046020: 2020 2020 2020 2020 2020 2020 2020 2265                "e
-00046030: 7272 6564 223a 2061 6374 6976 655f 7374  rred": active_st
-00046040: 6174 6573 5b22 6572 7265 6422 5d2c 0a20  ates["erred"],. 
-00046050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046060: 2020 2022 7265 6c65 6173 6564 223a 2061     "released": a
-00046070: 6374 6976 655f 7374 6174 6573 5b22 7265  ctive_states["re
-00046080: 6c65 6173 6564 225d 2c0a 2020 2020 2020  leased"],.      
-00046090: 2020 2020 2020 2020 2020 2020 2020 2270                "p
-000460a0: 726f 6365 7373 696e 6722 3a20 6163 7469  rocessing": acti
-000460b0: 7665 5f73 7461 7465 735b 2270 726f 6365  ve_states["proce
-000460c0: 7373 696e 6722 5d2c 0a20 2020 2020 2020  ssing"],.       
-000460d0: 2020 2020 2020 2020 2020 2020 2022 7761               "wa
-000460e0: 6974 696e 6722 3a20 6163 7469 7665 5f73  iting": active_s
-000460f0: 7461 7465 735b 2277 6169 7469 6e67 225d  tates["waiting"]
-00046100: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00046110: 2020 7d0a 0a20 2020 2020 2020 2072 6574    }..        ret
-00046120: 7572 6e20 7374 6174 650a 0a20 2020 2064  urn state..    d
-00046130: 6566 2067 6574 5f74 6173 6b5f 7374 6174  ef get_task_stat
-00046140: 7573 2873 656c 662c 206b 6579 733a 2049  us(self, keys: I
-00046150: 7465 7261 626c 655b 4b65 795d 2920 2d3e  terable[Key]) ->
-00046160: 2064 6963 745b 4b65 792c 2054 6173 6b53   dict[Key, TaskS
-00046170: 7461 7465 5374 6174 6520 7c20 4e6f 6e65  tateState | None
-00046180: 5d3a 0a20 2020 2020 2020 2072 6574 7572  ]:.        retur
-00046190: 6e20 7b0a 2020 2020 2020 2020 2020 2020  n {.            
-000461a0: 6b65 793a 2028 7365 6c66 2e74 6173 6b73  key: (self.tasks
-000461b0: 5b6b 6579 5d2e 7374 6174 6520 6966 206b  [key].state if k
-000461c0: 6579 2069 6e20 7365 6c66 2e74 6173 6b73  ey in self.tasks
-000461d0: 2065 6c73 6520 4e6f 6e65 2920 666f 7220   else None) for 
-000461e0: 6b65 7920 696e 206b 6579 730a 2020 2020  key in keys.    
-000461f0: 2020 2020 7d0a 0a20 2020 2064 6566 2067      }..    def g
-00046200: 6574 5f74 6173 6b5f 7374 7265 616d 280a  et_task_stream(.
-00046210: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
-00046220: 2020 2020 2020 7374 6172 743a 2073 7472        start: str
-00046230: 207c 2066 6c6f 6174 207c 204e 6f6e 6520   | float | None 
-00046240: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-00046250: 7374 6f70 3a20 7374 7220 7c20 666c 6f61  stop: str | floa
-00046260: 7420 7c20 4e6f 6e65 203d 204e 6f6e 652c  t | None = None,
-00046270: 0a20 2020 2020 2020 2063 6f75 6e74 3a20  .        count: 
-00046280: 696e 7420 7c20 4e6f 6e65 203d 204e 6f6e  int | None = Non
-00046290: 652c 0a20 2020 2029 202d 3e20 6c69 7374  e,.    ) -> list
-000462a0: 3a0a 2020 2020 2020 2020 6672 6f6d 2064  :.        from d
-000462b0: 6973 7472 6962 7574 6564 2e64 6961 676e  istributed.diagn
-000462c0: 6f73 7469 6373 2e74 6173 6b5f 7374 7265  ostics.task_stre
-000462d0: 616d 2069 6d70 6f72 7420 5461 736b 5374  am import TaskSt
-000462e0: 7265 616d 506c 7567 696e 0a0a 2020 2020  reamPlugin..    
-000462f0: 2020 2020 6966 2054 6173 6b53 7472 6561      if TaskStrea
-00046300: 6d50 6c75 6769 6e2e 6e61 6d65 206e 6f74  mPlugin.name not
-00046310: 2069 6e20 7365 6c66 2e70 6c75 6769 6e73   in self.plugins
-00046320: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00046330: 6c66 2e61 6464 5f70 6c75 6769 6e28 5461  lf.add_plugin(Ta
-00046340: 736b 5374 7265 616d 506c 7567 696e 2873  skStreamPlugin(s
-00046350: 656c 6629 290a 0a20 2020 2020 2020 2070  elf))..        p
-00046360: 6c75 6769 6e20 3d20 6361 7374 2854 6173  lugin = cast(Tas
-00046370: 6b53 7472 6561 6d50 6c75 6769 6e2c 2073  kStreamPlugin, s
-00046380: 656c 662e 706c 7567 696e 735b 5461 736b  elf.plugins[Task
-00046390: 5374 7265 616d 506c 7567 696e 2e6e 616d  StreamPlugin.nam
-000463a0: 655d 290a 0a20 2020 2020 2020 2072 6574  e])..        ret
-000463b0: 7572 6e20 706c 7567 696e 2e63 6f6c 6c65  urn plugin.colle
-000463c0: 6374 2873 7461 7274 3d73 7461 7274 2c20  ct(start=start, 
-000463d0: 7374 6f70 3d73 746f 702c 2063 6f75 6e74  stop=stop, count
-000463e0: 3d63 6f75 6e74 290a 0a20 2020 2064 6566  =count)..    def
-000463f0: 2073 7461 7274 5f74 6173 6b5f 6d65 7461   start_task_meta
-00046400: 6461 7461 2873 656c 662c 206e 616d 653a  data(self, name:
-00046410: 2073 7472 2920 2d3e 204e 6f6e 653a 0a20   str) -> None:. 
-00046420: 2020 2020 2020 2070 6c75 6769 6e20 3d20         plugin = 
-00046430: 436f 6c6c 6563 7454 6173 6b4d 6574 6144  CollectTaskMetaD
-00046440: 6174 6150 6c75 6769 6e28 7363 6865 6475  ataPlugin(schedu
-00046450: 6c65 723d 7365 6c66 2c20 6e61 6d65 3d6e  ler=self, name=n
-00046460: 616d 6529 0a20 2020 2020 2020 2073 656c  ame).        sel
-00046470: 662e 6164 645f 706c 7567 696e 2870 6c75  f.add_plugin(plu
-00046480: 6769 6e29 0a0a 2020 2020 6465 6620 7374  gin)..    def st
-00046490: 6f70 5f74 6173 6b5f 6d65 7461 6461 7461  op_task_metadata
-000464a0: 2873 656c 662c 206e 616d 653a 2073 7472  (self, name: str
-000464b0: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2920   | None = None) 
-000464c0: 2d3e 2064 6963 743a 0a20 2020 2020 2020  -> dict:.       
-000464d0: 2070 6c75 6769 6e73 203d 205b 0a20 2020   plugins = [.   
-000464e0: 2020 2020 2020 2020 2070 0a20 2020 2020           p.     
-000464f0: 2020 2020 2020 2066 6f72 2070 2069 6e20         for p in 
-00046500: 6c69 7374 2873 656c 662e 706c 7567 696e  list(self.plugin
-00046510: 732e 7661 6c75 6573 2829 290a 2020 2020  s.values()).    
-00046520: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-00046530: 7461 6e63 6528 702c 2043 6f6c 6c65 6374  tance(p, Collect
-00046540: 5461 736b 4d65 7461 4461 7461 506c 7567  TaskMetaDataPlug
-00046550: 696e 2920 616e 6420 702e 6e61 6d65 203d  in) and p.name =
-00046560: 3d20 6e61 6d65 0a20 2020 2020 2020 205d  = name.        ]
-00046570: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
-00046580: 706c 7567 696e 7329 2021 3d20 313a 0a20  plugins) != 1:. 
-00046590: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-000465a0: 2056 616c 7565 4572 726f 7228 0a20 2020   ValueError(.   
-000465b0: 2020 2020 2020 2020 2020 2020 2022 4578               "Ex
-000465c0: 7065 6374 6564 2074 6f20 6669 6e64 2065  pected to find e
-000465d0: 7861 6374 6c79 206f 6e65 2043 6f6c 6c65  xactly one Colle
-000465e0: 6374 5461 736b 4d65 7461 4461 7461 506c  ctTaskMetaDataPl
-000465f0: 7567 696e 2022 0a20 2020 2020 2020 2020  ugin ".         
-00046600: 2020 2020 2020 2066 2277 6974 6820 6e61         f"with na
-00046610: 6d65 207b 6e61 6d65 7d20 6275 7420 666f  me {name} but fo
-00046620: 756e 6420 7b6c 656e 2870 6c75 6769 6e73  und {len(plugins
-00046630: 297d 2e22 0a20 2020 2020 2020 2020 2020  )}.".           
-00046640: 2029 0a0a 2020 2020 2020 2020 706c 7567   )..        plug
-00046650: 696e 203d 2070 6c75 6769 6e73 5b30 5d0a  in = plugins[0].
-00046660: 2020 2020 2020 2020 7365 6c66 2e72 656d          self.rem
-00046670: 6f76 655f 706c 7567 696e 286e 616d 653d  ove_plugin(name=
-00046680: 706c 7567 696e 2e6e 616d 6529 0a20 2020  plugin.name).   
-00046690: 2020 2020 2072 6574 7572 6e20 7b22 6d65       return {"me
-000466a0: 7461 6461 7461 223a 2070 6c75 6769 6e2e  tadata": plugin.
-000466b0: 6d65 7461 6461 7461 2c20 2273 7461 7465  metadata, "state
-000466c0: 223a 2070 6c75 6769 6e2e 7374 6174 657d  ": plugin.state}
-000466d0: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
-000466e0: 7265 6769 7374 6572 5f77 6f72 6b65 725f  register_worker_
-000466f0: 706c 7567 696e 280a 2020 2020 2020 2020  plugin(.        
-00046700: 7365 6c66 2c20 636f 6d6d 3a20 4e6f 6e65  self, comm: None
-00046710: 2c20 706c 7567 696e 3a20 6279 7465 732c  , plugin: bytes,
-00046720: 206e 616d 653a 2073 7472 2c20 6964 656d   name: str, idem
-00046730: 706f 7465 6e74 3a20 626f 6f6c 207c 204e  potent: bool | N
-00046740: 6f6e 6520 3d20 4e6f 6e65 0a20 2020 2029  one = None.    )
-00046750: 202d 3e20 6469 6374 5b73 7472 2c20 4f4b   -> dict[str, OK
-00046760: 4d65 7373 6167 655d 3a0a 2020 2020 2020  Message]:.      
-00046770: 2020 2222 2252 6567 6973 7465 7273 2061    """Registers a
-00046780: 2077 6f72 6b65 7220 706c 7567 696e 206f   worker plugin o
-00046790: 6e20 616c 6c20 7275 6e6e 696e 6720 616e  n all running an
-000467a0: 6420 6675 7475 7265 2077 6f72 6b65 7273  d future workers
-000467b0: 2222 220a 2020 2020 2020 2020 6c6f 6767  """.        logg
-000467c0: 6572 2e69 6e66 6f28 2252 6567 6973 7465  er.info("Registe
-000467d0: 7269 6e67 2057 6f72 6b65 7220 706c 7567  ring Worker plug
-000467e0: 696e 2025 7322 2c20 6e61 6d65 290a 2020  in %s", name).  
-000467f0: 2020 2020 2020 6966 2069 6465 6d70 6f74        if idempot
-00046800: 656e 7420 6973 204e 6f6e 653a 0a20 2020  ent is None:.   
-00046810: 2020 2020 2020 2020 2077 6172 6e69 6e67           warning
-00046820: 732e 7761 726e 280a 2020 2020 2020 2020  s.warn(.        
-00046830: 2020 2020 2020 2020 2254 6865 2073 6967          "The sig
-00046840: 6e61 7475 7265 206f 6620 6053 6368 6564  nature of `Sched
-00046850: 756c 6572 2e72 6567 6973 7465 725f 776f  uler.register_wo
-00046860: 726b 6572 5f70 6c75 6769 6e60 206e 6f77  rker_plugin` now
-00046870: 2072 6571 7569 7265 7320 220a 2020 2020   requires ".    
-00046880: 2020 2020 2020 2020 2020 2020 2260 6964              "`id
-00046890: 656d 706f 7465 6e74 602e 204e 6f74 2069  empotent`. Not i
-000468a0: 6e63 6c75 6469 6e67 2060 6964 656d 706f  ncluding `idempo
-000468b0: 7465 6e74 6020 696e 2074 6865 2073 6967  tent` in the sig
-000468c0: 6e61 7475 7265 2077 696c 6c20 6e6f 206c  nature will no l
-000468d0: 6f6e 6765 7220 220a 2020 2020 2020 2020  onger ".        
-000468e0: 2020 2020 2020 2020 2262 6520 7375 7070          "be supp
-000468f0: 6f72 7465 6420 696e 2066 7574 7572 6520  orted in future 
-00046900: 7665 7273 696f 6e73 2e22 2c0a 2020 2020  versions.",.    
-00046910: 2020 2020 2020 2020 2020 2020 4675 7475              Futu
-00046920: 7265 5761 726e 696e 672c 0a20 2020 2020  reWarning,.     
-00046930: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00046940: 2020 2020 2069 6465 6d70 6f74 656e 7420       idempotent 
-00046950: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
-00046960: 6966 206e 616d 6520 696e 2073 656c 662e  if name in self.
-00046970: 776f 726b 6572 5f70 6c75 6769 6e73 2061  worker_plugins a
-00046980: 6e64 2069 6465 6d70 6f74 656e 743a 0a20  nd idempotent:. 
-00046990: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-000469a0: 6e20 7b7d 0a0a 2020 2020 2020 2020 7365  n {}..        se
-000469b0: 6c66 2e77 6f72 6b65 725f 706c 7567 696e  lf.worker_plugin
-000469c0: 735b 6e61 6d65 5d20 3d20 706c 7567 696e  s[name] = plugin
-000469d0: 0a0a 2020 2020 2020 2020 7265 7370 6f6e  ..        respon
-000469e0: 7365 7320 3d20 6177 6169 7420 7365 6c66  ses = await self
-000469f0: 2e62 726f 6164 6361 7374 280a 2020 2020  .broadcast(.    
-00046a00: 2020 2020 2020 2020 6d73 673d 6469 6374          msg=dict
-00046a10: 286f 703d 2270 6c75 6769 6e2d 6164 6422  (op="plugin-add"
-00046a20: 2c20 706c 7567 696e 3d70 6c75 6769 6e2c  , plugin=plugin,
-00046a30: 206e 616d 653d 6e61 6d65 290a 2020 2020   name=name).    
-00046a40: 2020 2020 290a 2020 2020 2020 2020 7265      ).        re
-00046a50: 7475 726e 2072 6573 706f 6e73 6573 0a0a  turn responses..
-00046a60: 2020 2020 6173 796e 6320 6465 6620 756e      async def un
-00046a70: 7265 6769 7374 6572 5f77 6f72 6b65 725f  register_worker_
-00046a80: 706c 7567 696e 280a 2020 2020 2020 2020  plugin(.        
-00046a90: 7365 6c66 2c20 636f 6d6d 3a20 4e6f 6e65  self, comm: None
-00046aa0: 2c20 6e61 6d65 3a20 7374 720a 2020 2020  , name: str.    
-00046ab0: 2920 2d3e 2064 6963 745b 7374 722c 2045  ) -> dict[str, E
-00046ac0: 7272 6f72 4d65 7373 6167 6520 7c20 4f4b  rrorMessage | OK
-00046ad0: 4d65 7373 6167 655d 3a0a 2020 2020 2020  Message]:.      
-00046ae0: 2020 2222 2255 6e72 6567 6973 7465 7273    """Unregisters
-00046af0: 2061 2077 6f72 6b65 7220 706c 7567 696e   a worker plugin
-00046b00: 2222 220a 2020 2020 2020 2020 7472 793a  """.        try:
-00046b10: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00046b20: 662e 776f 726b 6572 5f70 6c75 6769 6e73  f.worker_plugins
-00046b30: 2e70 6f70 286e 616d 6529 0a20 2020 2020  .pop(name).     
-00046b40: 2020 2065 7863 6570 7420 4b65 7945 7272     except KeyErr
-00046b50: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
-00046b60: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-00046b70: 2866 2254 6865 2077 6f72 6b65 7220 706c  (f"The worker pl
-00046b80: 7567 696e 207b 6e61 6d65 7d20 646f 6573  ugin {name} does
-00046b90: 206e 6f74 2065 7869 7374 2229 0a0a 2020   not exist")..  
-00046ba0: 2020 2020 2020 7265 7370 6f6e 7365 7320        responses 
-00046bb0: 3d20 6177 6169 7420 7365 6c66 2e62 726f  = await self.bro
-00046bc0: 6164 6361 7374 286d 7367 3d64 6963 7428  adcast(msg=dict(
-00046bd0: 6f70 3d22 706c 7567 696e 2d72 656d 6f76  op="plugin-remov
-00046be0: 6522 2c20 6e61 6d65 3d6e 616d 6529 290a  e", name=name)).
-00046bf0: 2020 2020 2020 2020 7265 7475 726e 2072          return r
-00046c00: 6573 706f 6e73 6573 0a0a 2020 2020 6173  esponses..    as
-00046c10: 796e 6320 6465 6620 7265 6769 7374 6572  ync def register
-00046c20: 5f6e 616e 6e79 5f70 6c75 6769 6e28 0a20  _nanny_plugin(. 
-00046c30: 2020 2020 2020 2073 656c 662c 2063 6f6d         self, com
-00046c40: 6d3a 204e 6f6e 652c 2070 6c75 6769 6e3a  m: None, plugin:
-00046c50: 2062 7974 6573 2c20 6e61 6d65 3a20 7374   bytes, name: st
-00046c60: 722c 2069 6465 6d70 6f74 656e 743a 2062  r, idempotent: b
-00046c70: 6f6f 6c20 7c20 4e6f 6e65 203d 204e 6f6e  ool | None = Non
-00046c80: 650a 2020 2020 2920 2d3e 2064 6963 745b  e.    ) -> dict[
-00046c90: 7374 722c 204f 4b4d 6573 7361 6765 5d3a  str, OKMessage]:
-00046ca0: 0a20 2020 2020 2020 2022 2222 5265 6769  .        """Regi
-00046cb0: 7374 6572 7320 6120 6e61 6e6e 7920 706c  sters a nanny pl
-00046cc0: 7567 696e 206f 6e20 616c 6c20 7275 6e6e  ugin on all runn
-00046cd0: 696e 6720 616e 6420 6675 7475 7265 206e  ing and future n
-00046ce0: 616e 6e69 6573 2222 220a 2020 2020 2020  annies""".      
-00046cf0: 2020 6c6f 6767 6572 2e69 6e66 6f28 2252    logger.info("R
-00046d00: 6567 6973 7465 7269 6e67 204e 616e 6e79  egistering Nanny
-00046d10: 2070 6c75 6769 6e20 2573 222c 206e 616d   plugin %s", nam
-00046d20: 6529 0a0a 2020 2020 2020 2020 6966 2069  e)..        if i
-00046d30: 6465 6d70 6f74 656e 7420 6973 204e 6f6e  dempotent is Non
-00046d40: 653a 0a20 2020 2020 2020 2020 2020 2077  e:.            w
-00046d50: 6172 6e69 6e67 732e 7761 726e 280a 2020  arnings.warn(.  
-00046d60: 2020 2020 2020 2020 2020 2020 2020 2254                "T
-00046d70: 6865 2073 6967 6e61 7475 7265 206f 6620  he signature of 
-00046d80: 6053 6368 6564 756c 6572 2e72 6567 6973  `Scheduler.regis
-00046d90: 7465 725f 6e61 6e6e 795f 706c 7567 696e  ter_nanny_plugin
-00046da0: 6020 6e6f 7720 7265 7175 6972 6573 2022  ` now requires "
-00046db0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00046dc0: 2022 6069 6465 6d70 6f74 656e 7460 2e20   "`idempotent`. 
-00046dd0: 4e6f 7420 696e 636c 7564 696e 6720 6069  Not including `i
-00046de0: 6465 6d70 6f74 656e 7460 2069 6e20 7468  dempotent` in th
-00046df0: 6520 7369 676e 6174 7572 6520 7769 6c6c  e signature will
-00046e00: 206e 6f20 6c6f 6e67 6572 2022 0a20 2020   no longer ".   
-00046e10: 2020 2020 2020 2020 2020 2020 2022 6265               "be
-00046e20: 2073 7570 706f 7274 6564 2069 6e20 6675   supported in fu
-00046e30: 7475 7265 2076 6572 7369 6f6e 732e 222c  ture versions.",
-00046e40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00046e50: 2046 7574 7572 6557 6172 6e69 6e67 2c0a   FutureWarning,.
-00046e60: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00046e70: 2020 2020 2020 2020 2020 6964 656d 706f            idempo
-00046e80: 7465 6e74 203d 2046 616c 7365 0a0a 2020  tent = False..  
-00046e90: 2020 2020 2020 6966 206e 616d 6520 696e        if name in
-00046ea0: 2073 656c 662e 6e61 6e6e 795f 706c 7567   self.nanny_plug
-00046eb0: 696e 7320 616e 6420 6964 656d 706f 7465  ins and idempote
-00046ec0: 6e74 3a0a 2020 2020 2020 2020 2020 2020  nt:.            
-00046ed0: 7265 7475 726e 207b 7d0a 0a20 2020 2020  return {}..     
-00046ee0: 2020 2073 656c 662e 6e61 6e6e 795f 706c     self.nanny_pl
-00046ef0: 7567 696e 735b 6e61 6d65 5d20 3d20 706c  ugins[name] = pl
-00046f00: 7567 696e 0a20 2020 2020 2020 2061 7379  ugin.        asy
-00046f10: 6e63 2077 6974 6820 7365 6c66 2e5f 7374  nc with self._st
-00046f20: 6172 7469 6e67 5f6e 616e 6e69 6573 5f63  arting_nannies_c
-00046f30: 6f6e 643a 0a20 2020 2020 2020 2020 2020  ond:.           
-00046f40: 2069 6620 7365 6c66 2e5f 7374 6172 7469   if self._starti
-00046f50: 6e67 5f6e 616e 6e69 6573 3a0a 2020 2020  ng_nannies:.    
-00046f60: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-00046f70: 6572 2e69 6e66 6f28 2257 6169 7469 6e67  er.info("Waiting
-00046f80: 2066 6f72 204e 616e 6e69 6573 2074 6f20   for Nannies to 
-00046f90: 7374 6172 7420 2573 222c 2073 656c 662e  start %s", self.
-00046fa0: 5f73 7461 7274 696e 675f 6e61 6e6e 6965  _starting_nannie
-00046fb0: 7329 0a20 2020 2020 2020 2020 2020 2061  s).            a
-00046fc0: 7761 6974 2073 656c 662e 5f73 7461 7274  wait self._start
-00046fd0: 696e 675f 6e61 6e6e 6965 735f 636f 6e64  ing_nannies_cond
-00046fe0: 2e77 6169 745f 666f 7228 0a20 2020 2020  .wait_for(.     
-00046ff0: 2020 2020 2020 2020 2020 206c 616d 6264             lambd
-00047000: 613a 206e 6f74 2073 656c 662e 5f73 7461  a: not self._sta
-00047010: 7274 696e 675f 6e61 6e6e 6965 730a 2020  rting_nannies.  
-00047020: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00047030: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
-00047040: 7320 3d20 6177 6169 7420 7365 6c66 2e62  s = await self.b
-00047050: 726f 6164 6361 7374 280a 2020 2020 2020  roadcast(.      
-00047060: 2020 2020 2020 2020 2020 6d73 673d 6469            msg=di
-00047070: 6374 286f 703d 2270 6c75 6769 6e5f 6164  ct(op="plugin_ad
-00047080: 6422 2c20 706c 7567 696e 3d70 6c75 6769  d", plugin=plugi
-00047090: 6e2c 206e 616d 653d 6e61 6d65 292c 0a20  n, name=name),. 
-000470a0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-000470b0: 616e 6e79 3d54 7275 652c 0a20 2020 2020  anny=True,.     
-000470c0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000470d0: 2020 2020 2072 6574 7572 6e20 7265 7370       return resp
-000470e0: 6f6e 7365 730a 0a20 2020 2061 7379 6e63  onses..    async
-000470f0: 2064 6566 2075 6e72 6567 6973 7465 725f   def unregister_
-00047100: 6e61 6e6e 795f 706c 7567 696e 280a 2020  nanny_plugin(.  
-00047110: 2020 2020 2020 7365 6c66 2c20 636f 6d6d        self, comm
-00047120: 3a20 4e6f 6e65 2c20 6e61 6d65 3a20 7374  : None, name: st
-00047130: 720a 2020 2020 2920 2d3e 2064 6963 745b  r.    ) -> dict[
-00047140: 7374 722c 2045 7272 6f72 4d65 7373 6167  str, ErrorMessag
-00047150: 6520 7c20 4f4b 4d65 7373 6167 655d 3a0a  e | OKMessage]:.
-00047160: 2020 2020 2020 2020 2222 2255 6e72 6567          """Unreg
-00047170: 6973 7465 7273 2061 2077 6f72 6b65 7220  isters a worker 
-00047180: 706c 7567 696e 2222 220a 2020 2020 2020  plugin""".      
-00047190: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-000471a0: 2020 2073 656c 662e 6e61 6e6e 795f 706c     self.nanny_pl
-000471b0: 7567 696e 732e 706f 7028 6e61 6d65 290a  ugins.pop(name).
-000471c0: 2020 2020 2020 2020 6578 6365 7074 204b          except K
-000471d0: 6579 4572 726f 723a 0a20 2020 2020 2020  eyError:.       
-000471e0: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-000471f0: 4572 726f 7228 6622 5468 6520 6e61 6e6e  Error(f"The nann
-00047200: 7920 706c 7567 696e 207b 6e61 6d65 7d20  y plugin {name} 
-00047210: 646f 6573 206e 6f74 2065 7869 7374 2229  does not exist")
-00047220: 0a0a 2020 2020 2020 2020 7265 7370 6f6e  ..        respon
-00047230: 7365 7320 3d20 6177 6169 7420 7365 6c66  ses = await self
-00047240: 2e62 726f 6164 6361 7374 280a 2020 2020  .broadcast(.    
-00047250: 2020 2020 2020 2020 6d73 673d 6469 6374          msg=dict
-00047260: 286f 703d 2270 6c75 6769 6e5f 7265 6d6f  (op="plugin_remo
-00047270: 7665 222c 206e 616d 653d 6e61 6d65 292c  ve", name=name),
-00047280: 206e 616e 6e79 3d54 7275 650a 2020 2020   nanny=True.    
-00047290: 2020 2020 290a 2020 2020 2020 2020 7265      ).        re
-000472a0: 7475 726e 2072 6573 706f 6e73 6573 0a0a  turn responses..
-000472b0: 2020 2020 6465 6620 7472 616e 7369 7469      def transiti
-000472c0: 6f6e 280a 2020 2020 2020 2020 7365 6c66  on(.        self
-000472d0: 2c0a 2020 2020 2020 2020 6b65 793a 204b  ,.        key: K
-000472e0: 6579 2c0a 2020 2020 2020 2020 6669 6e69  ey,.        fini
-000472f0: 7368 3a20 5461 736b 5374 6174 6553 7461  sh: TaskStateSta
-00047300: 7465 2c0a 2020 2020 2020 2020 7374 696d  te,.        stim
-00047310: 756c 7573 5f69 643a 2073 7472 2c0a 2020  ulus_id: str,.  
-00047320: 2020 2020 2020 2a2a 6b77 6172 6773 3a20        **kwargs: 
-00047330: 416e 792c 0a20 2020 2029 202d 3e20 5265  Any,.    ) -> Re
-00047340: 6373 3a0a 2020 2020 2020 2020 2222 2254  cs:.        """T
-00047350: 7261 6e73 6974 696f 6e20 6120 6b65 7920  ransition a key 
-00047360: 6672 6f6d 2069 7473 2063 7572 7265 6e74  from its current
-00047370: 2073 7461 7465 2074 6f20 7468 6520 6669   state to the fi
-00047380: 6e69 7368 2073 7461 7465 0a0a 2020 2020  nish state..    
-00047390: 2020 2020 4578 616d 706c 6573 0a20 2020      Examples.   
-000473a0: 2020 2020 202d 2d2d 2d2d 2d2d 2d0a 2020       --------.  
-000473b0: 2020 2020 2020 3e3e 3e20 7365 6c66 2e74        >>> self.t
-000473c0: 7261 6e73 6974 696f 6e28 2778 272c 2027  ransition('x', '
-000473d0: 7761 6974 696e 6727 290a 2020 2020 2020  waiting').      
-000473e0: 2020 7b27 7827 3a20 2770 726f 6365 7373    {'x': 'process
-000473f0: 696e 6727 7d0a 0a20 2020 2020 2020 2052  ing'}..        R
-00047400: 6574 7572 6e73 0a20 2020 2020 2020 202d  eturns.        -
-00047410: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2044  ------.        D
-00047420: 6963 7469 6f6e 6172 7920 6f66 2072 6563  ictionary of rec
-00047430: 6f6d 6d65 6e64 6174 696f 6e73 2066 6f72  ommendations for
-00047440: 2066 7574 7572 6520 7472 616e 7369 7469   future transiti
-00047450: 6f6e 730a 0a20 2020 2020 2020 2053 6565  ons..        See
-00047460: 2041 6c73 6f0a 2020 2020 2020 2020 2d2d   Also.        --
-00047470: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2053  ------.        S
-00047480: 6368 6564 756c 6572 2e74 7261 6e73 6974  cheduler.transit
-00047490: 696f 6e73 3a20 7472 616e 7369 7469 7665  ions: transitive
-000474a0: 2076 6572 7369 6f6e 206f 6620 7468 6973   version of this
-000474b0: 2066 756e 6374 696f 6e0a 2020 2020 2020   function.      
-000474c0: 2020 2222 220a 2020 2020 2020 2020 7265    """.        re
-000474d0: 636f 6d6d 656e 6461 7469 6f6e 732c 2063  commendations, c
-000474e0: 6c69 656e 745f 6d73 6773 2c20 776f 726b  lient_msgs, work
-000474f0: 6572 5f6d 7367 7320 3d20 7365 6c66 2e5f  er_msgs = self._
-00047500: 7472 616e 7369 7469 6f6e 280a 2020 2020  transition(.    
-00047510: 2020 2020 2020 2020 6b65 792c 2066 696e          key, fin
-00047520: 6973 682c 2073 7469 6d75 6c75 735f 6964  ish, stimulus_id
-00047530: 2c20 2a2a 6b77 6172 6773 0a20 2020 2020  , **kwargs.     
-00047540: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
-00047550: 662e 7365 6e64 5f61 6c6c 2863 6c69 656e  f.send_all(clien
-00047560: 745f 6d73 6773 2c20 776f 726b 6572 5f6d  t_msgs, worker_m
-00047570: 7367 7329 0a20 2020 2020 2020 2072 6574  sgs).        ret
-00047580: 7572 6e20 7265 636f 6d6d 656e 6461 7469  urn recommendati
-00047590: 6f6e 730a 0a20 2020 2064 6566 2074 7261  ons..    def tra
-000475a0: 6e73 6974 696f 6e73 2873 656c 662c 2072  nsitions(self, r
-000475b0: 6563 6f6d 6d65 6e64 6174 696f 6e73 3a20  ecommendations: 
-000475c0: 5265 6373 2c20 7374 696d 756c 7573 5f69  Recs, stimulus_i
-000475d0: 643a 2073 7472 2920 2d3e 204e 6f6e 653a  d: str) -> None:
-000475e0: 0a20 2020 2020 2020 2022 2222 5072 6f63  .        """Proc
-000475f0: 6573 7320 7472 616e 7369 7469 6f6e 7320  ess transitions 
-00047600: 756e 7469 6c20 6e6f 6e65 2061 7265 206c  until none are l
-00047610: 6566 740a 0a20 2020 2020 2020 2054 6869  eft..        Thi
-00047620: 7320 696e 636c 7564 6573 2066 6565 6462  s includes feedb
-00047630: 6163 6b20 6672 6f6d 2070 7265 7669 6f75  ack from previou
-00047640: 7320 7472 616e 7369 7469 6f6e 7320 616e  s transitions an
-00047650: 6420 636f 6e74 696e 7565 7320 756e 7469  d continues unti
-00047660: 6c20 7765 0a20 2020 2020 2020 2072 6561  l we.        rea
-00047670: 6368 2061 2073 7465 6164 7920 7374 6174  ch a steady stat
-00047680: 650a 2020 2020 2020 2020 2222 220a 2020  e.        """.  
-00047690: 2020 2020 2020 636c 6965 6e74 5f6d 7367        client_msg
-000476a0: 733a 204d 7367 7320 3d20 7b7d 0a20 2020  s: Msgs = {}.   
-000476b0: 2020 2020 2077 6f72 6b65 725f 6d73 6773       worker_msgs
-000476c0: 3a20 4d73 6773 203d 207b 7d0a 2020 2020  : Msgs = {}.    
-000476d0: 2020 2020 7365 6c66 2e5f 7472 616e 7369      self._transi
-000476e0: 7469 6f6e 7328 7265 636f 6d6d 656e 6461  tions(recommenda
-000476f0: 7469 6f6e 732c 2063 6c69 656e 745f 6d73  tions, client_ms
-00047700: 6773 2c20 776f 726b 6572 5f6d 7367 732c  gs, worker_msgs,
-00047710: 2073 7469 6d75 6c75 735f 6964 290a 2020   stimulus_id).  
-00047720: 2020 2020 2020 7365 6c66 2e73 656e 645f        self.send_
-00047730: 616c 6c28 636c 6965 6e74 5f6d 7367 732c  all(client_msgs,
-00047740: 2077 6f72 6b65 725f 6d73 6773 290a 0a20   worker_msgs).. 
-00047750: 2020 2061 7379 6e63 2064 6566 2067 6574     async def get
-00047760: 5f73 746f 7279 2873 656c 662c 206b 6579  _story(self, key
-00047770: 735f 6f72 5f73 7469 6d75 6c69 3a20 4974  s_or_stimuli: It
-00047780: 6572 6162 6c65 5b4b 6579 207c 2073 7472  erable[Key | str
-00047790: 5d29 202d 3e20 6c69 7374 5b54 7261 6e73  ]) -> list[Trans
-000477a0: 6974 696f 6e5d 3a0a 2020 2020 2020 2020  ition]:.        
-000477b0: 2222 2252 5043 2068 6f6f 6b20 666f 7220  """RPC hook for 
-000477c0: 3a6d 6574 683a 6053 6368 6564 756c 6572  :meth:`Scheduler
-000477d0: 5374 6174 652e 7374 6f72 7960 2e0a 0a20  State.story`... 
-000477e0: 2020 2020 2020 204e 6f74 6520 7468 6174         Note that
-000477f0: 2074 6865 206d 7367 7061 636b 2073 6572   the msgpack ser
-00047800: 6961 6c69 7a61 7469 6f6e 2f64 6573 6572  ialization/deser
-00047810: 6961 6c69 7a61 7469 6f6e 2072 6f75 6e64  ialization round
-00047820: 2d74 7269 7020 7769 6c6c 2074 7261 6e73  -trip will trans
-00047830: 666f 726d 0a20 2020 2020 2020 2074 6865  form.        the
-00047840: 203a 636c 6173 733a 6054 7261 6e73 6974   :class:`Transit
-00047850: 696f 6e60 206e 616d 6564 7475 706c 6573  ion` namedtuples
-00047860: 2069 6e74 6f20 7265 6775 6c61 7220 7475   into regular tu
-00047870: 706c 6573 2e0a 2020 2020 2020 2020 2222  ples..        ""
-00047880: 220a 2020 2020 2020 2020 7265 7475 726e  ".        return
-00047890: 2073 656c 662e 7374 6f72 7928 2a6b 6579   self.story(*key
-000478a0: 735f 6f72 5f73 7469 6d75 6c69 290a 0a20  s_or_stimuli).. 
-000478b0: 2020 2064 6566 205f 7265 7363 6865 6475     def _reschedu
-000478c0: 6c65 280a 2020 2020 2020 2020 7365 6c66  le(.        self
-000478d0: 2c20 6b65 793a 204b 6579 2c20 776f 726b  , key: Key, work
-000478e0: 6572 3a20 7374 7220 7c20 4e6f 6e65 203d  er: str | None =
-000478f0: 204e 6f6e 652c 202a 2c20 7374 696d 756c   None, *, stimul
-00047900: 7573 5f69 643a 2073 7472 0a20 2020 2029  us_id: str.    )
-00047910: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00047920: 2020 2222 2252 6573 6368 6564 756c 6520    """Reschedule 
-00047930: 6120 7461 736b 2e0a 0a20 2020 2020 2020  a task...       
-00047940: 2054 6869 7320 6675 6e63 7469 6f6e 2073   This function s
-00047950: 686f 756c 6420 6f6e 6c79 2062 6520 7573  hould only be us
-00047960: 6564 2077 6865 6e20 7468 6520 7461 736b  ed when the task
-00047970: 2068 6173 2061 6c72 6561 6479 2062 6565   has already bee
-00047980: 6e20 7265 6c65 6173 6564 2069 6e0a 2020  n released in.  
-00047990: 2020 2020 2020 736f 6d65 2077 6179 206f        some way o
-000479a0: 6e20 7468 6520 776f 726b 6572 2069 7427  n the worker it'
-000479b0: 7320 6173 7369 676e 6564 2074 6f20 e280  s assigned to ..
-000479c0: 9420 6569 7468 6572 2076 6961 2063 616e  . either via can
-000479d0: 6365 6c6c 6174 696f 6e20 6f72 2061 0a20  cellation or a. 
-000479e0: 2020 2020 2020 2052 6573 6368 6564 756c         Reschedul
-000479f0: 6520 6578 6365 7074 696f 6e20 e280 9420  e exception ... 
-00047a00: 616e 6420 796f 7520 6172 6520 6365 7274  and you are cert
-00047a10: 6169 6e20 7468 6520 776f 726b 6572 2077  ain the worker w
-00047a20: 696c 6c20 6e6f 7420 7365 6e64 2061 6e79  ill not send any
-00047a30: 2066 7572 7468 6572 0a20 2020 2020 2020   further.       
-00047a40: 2075 7064 6174 6573 2061 626f 7574 2074   updates about t
-00047a50: 6865 2074 6173 6b20 746f 2074 6865 2073  he task to the s
-00047a60: 6368 6564 756c 6572 2e0a 2020 2020 2020  cheduler..      
-00047a70: 2020 2222 220a 2020 2020 2020 2020 7472    """.        tr
-00047a80: 793a 0a20 2020 2020 2020 2020 2020 2074  y:.            t
-00047a90: 7320 3d20 7365 6c66 2e74 6173 6b73 5b6b  s = self.tasks[k
-00047aa0: 6579 5d0a 2020 2020 2020 2020 6578 6365  ey].        exce
-00047ab0: 7074 204b 6579 4572 726f 723a 0a20 2020  pt KeyError:.   
-00047ac0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-00047ad0: 7761 726e 696e 6728 0a20 2020 2020 2020  warning(.       
-00047ae0: 2020 2020 2020 2020 2066 2241 7474 656d           f"Attem
-00047af0: 7074 696e 6720 746f 2072 6573 6368 6564  pting to resched
-00047b00: 756c 6520 7461 736b 207b 6b65 7921 727d  ule task {key!r}
-00047b10: 2c20 7768 6963 6820 7761 7320 6e6f 7420  , which was not 
-00047b20: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00047b30: 2020 2266 6f75 6e64 206f 6e20 7468 6520    "found on the 
-00047b40: 7363 6865 6475 6c65 722e 2041 626f 7274  scheduler. Abort
-00047b50: 696e 6720 7265 7363 6865 6475 6c65 2e22  ing reschedule."
-00047b60: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00047b70: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00047b80: 6e0a 2020 2020 2020 2020 6966 2074 732e  n.        if ts.
-00047b90: 7374 6174 6520 213d 2022 7072 6f63 6573  state != "proces
-00047ba0: 7369 6e67 223a 0a20 2020 2020 2020 2020  sing":.         
-00047bb0: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
-00047bc0: 2020 6966 2077 6f72 6b65 7220 616e 6420    if worker and 
-00047bd0: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
-00047be0: 2061 6e64 2074 732e 7072 6f63 6573 7369   and ts.processi
-00047bf0: 6e67 5f6f 6e2e 6164 6472 6573 7320 213d  ng_on.address !=
-00047c00: 2077 6f72 6b65 723a 0a20 2020 2020 2020   worker:.       
-00047c10: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
-00047c20: 2020 2020 2320 7472 616e 7369 7469 6f6e      # transition
-00047c30: 5f70 726f 6365 7373 696e 675f 7265 6c65  _processing_rele
-00047c40: 6173 6564 2077 696c 6c20 696d 6d65 6469  ased will immedi
-00047c50: 6174 656c 7920 7375 6767 6573 7420 616e  ately suggest an
-00047c60: 2061 6464 6974 696f 6e61 6c0a 2020 2020   additional.    
-00047c70: 2020 2020 2320 7472 616e 7369 7469 6f6e      # transition
-00047c80: 2074 6f20 7761 6974 696e 6720 6966 2074   to waiting if t
-00047c90: 6865 2074 6173 6b20 6861 7320 616e 7920  he task has any 
-00047ca0: 7761 6974 6572 7320 6f72 2063 6c69 656e  waiters or clien
-00047cb0: 7473 2068 6f6c 6469 6e67 2061 2066 7574  ts holding a fut
-00047cc0: 7572 652e 0a20 2020 2020 2020 2073 656c  ure..        sel
-00047cd0: 662e 7472 616e 7369 7469 6f6e 7328 7b6b  f.transitions({k
-00047ce0: 6579 3a20 2272 656c 6561 7365 6422 7d2c  ey: "released"},
-00047cf0: 2073 7469 6d75 6c75 735f 6964 3d73 7469   stimulus_id=sti
-00047d00: 6d75 6c75 735f 6964 290a 0a20 2020 2023  mulus_id)..    #
-00047d10: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00047d20: 2323 2323 0a20 2020 2023 2055 7469 6c69  ####.    # Utili
-00047d30: 7479 2066 756e 6374 696f 6e73 2023 0a20  ty functions #. 
-00047d40: 2020 2023 2323 2323 2323 2323 2323 2323     #############
-00047d50: 2323 2323 2323 2323 0a0a 2020 2020 6465  ########..    de
-00047d60: 6620 6164 645f 7265 736f 7572 6365 7328  f add_resources(
-00047d70: 0a20 2020 2020 2020 2073 656c 662c 2077  .        self, w
-00047d80: 6f72 6b65 723a 2073 7472 2c20 7265 736f  orker: str, reso
-00047d90: 7572 6365 733a 2064 6963 7420 7c20 4e6f  urces: dict | No
-00047da0: 6e65 203d 204e 6f6e 650a 2020 2020 2920  ne = None.    ) 
-00047db0: 2d3e 204c 6974 6572 616c 5b22 4f4b 225d  -> Literal["OK"]
-00047dc0: 3a0a 2020 2020 2020 2020 7773 203d 2073  :.        ws = s
-00047dd0: 656c 662e 776f 726b 6572 735b 776f 726b  elf.workers[work
-00047de0: 6572 5d0a 2020 2020 2020 2020 6966 2072  er].        if r
-00047df0: 6573 6f75 7263 6573 3a0a 2020 2020 2020  esources:.      
-00047e00: 2020 2020 2020 7773 2e72 6573 6f75 7263        ws.resourc
-00047e10: 6573 2e75 7064 6174 6528 7265 736f 7572  es.update(resour
-00047e20: 6365 7329 0a20 2020 2020 2020 2077 732e  ces).        ws.
-00047e30: 7573 6564 5f72 6573 6f75 7263 6573 203d  used_resources =
-00047e40: 207b 7d0a 2020 2020 2020 2020 666f 7220   {}.        for 
-00047e50: 7265 736f 7572 6365 2c20 7175 616e 7469  resource, quanti
-00047e60: 7479 2069 6e20 7773 2e72 6573 6f75 7263  ty in ws.resourc
-00047e70: 6573 2e69 7465 6d73 2829 3a0a 2020 2020  es.items():.    
-00047e80: 2020 2020 2020 2020 7773 2e75 7365 645f          ws.used_
-00047e90: 7265 736f 7572 6365 735b 7265 736f 7572  resources[resour
-00047ea0: 6365 5d20 3d20 300a 2020 2020 2020 2020  ce] = 0.        
-00047eb0: 2020 2020 6472 203d 2073 656c 662e 7265      dr = self.re
-00047ec0: 736f 7572 6365 732e 6765 7428 7265 736f  sources.get(reso
-00047ed0: 7572 6365 2c20 4e6f 6e65 290a 2020 2020  urce, None).    
-00047ee0: 2020 2020 2020 2020 6966 2064 7220 6973          if dr is
-00047ef0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00047f00: 2020 2020 2020 2073 656c 662e 7265 736f         self.reso
-00047f10: 7572 6365 735b 7265 736f 7572 6365 5d20  urces[resource] 
-00047f20: 3d20 6472 203d 207b 7d0a 2020 2020 2020  = dr = {}.      
-00047f30: 2020 2020 2020 6472 5b77 6f72 6b65 725d        dr[worker]
-00047f40: 203d 2071 7561 6e74 6974 790a 2020 2020   = quantity.    
-00047f50: 2020 2020 7265 7475 726e 2022 4f4b 220a      return "OK".
-00047f60: 0a20 2020 2064 6566 2072 656d 6f76 655f  .    def remove_
-00047f70: 7265 736f 7572 6365 7328 7365 6c66 2c20  resources(self, 
-00047f80: 776f 726b 6572 3a20 7374 7229 202d 3e20  worker: str) -> 
-00047f90: 4e6f 6e65 3a0a 2020 2020 2020 2020 7773  None:.        ws
-00047fa0: 203d 2073 656c 662e 776f 726b 6572 735b   = self.workers[
-00047fb0: 776f 726b 6572 5d0a 2020 2020 2020 2020  worker].        
-00047fc0: 666f 7220 7265 736f 7572 6365 2069 6e20  for resource in 
-00047fd0: 7773 2e72 6573 6f75 7263 6573 3a0a 2020  ws.resources:.  
-00047fe0: 2020 2020 2020 2020 2020 6472 203d 2073            dr = s
-00047ff0: 656c 662e 7265 736f 7572 6365 732e 7365  elf.resources.se
-00048000: 7464 6566 6175 6c74 2872 6573 6f75 7263  tdefault(resourc
-00048010: 652c 207b 7d29 0a20 2020 2020 2020 2020  e, {}).         
-00048020: 2020 2064 656c 2064 725b 776f 726b 6572     del dr[worker
-00048030: 5d0a 0a20 2020 2064 6566 2063 6f65 7263  ]..    def coerc
-00048040: 655f 6164 6472 6573 7328 7365 6c66 2c20  e_address(self, 
-00048050: 6164 6472 3a20 7374 7220 7c20 7475 706c  addr: str | tupl
-00048060: 652c 2072 6573 6f6c 7665 3a20 626f 6f6c  e, resolve: bool
-00048070: 203d 2054 7275 6529 202d 3e20 7374 723a   = True) -> str:
-00048080: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00048090: 2020 2020 2043 6f65 7263 6520 706f 7373       Coerce poss
-000480a0: 6962 6c65 2069 6e70 7574 2061 6464 7265  ible input addre
-000480b0: 7373 6573 2074 6f20 6361 6e6f 6e69 6361  sses to canonica
-000480c0: 6c20 666f 726d 2e0a 2020 2020 2020 2020  l form..        
-000480d0: 2a72 6573 6f6c 7665 2a20 6361 6e20 6265  *resolve* can be
-000480e0: 2064 6973 6162 6c65 6420 666f 7220 7465   disabled for te
-000480f0: 7374 696e 6720 7769 7468 2066 616b 6520  sting with fake 
-00048100: 686f 7374 6e61 6d65 732e 0a0a 2020 2020  hostnames...    
-00048110: 2020 2020 4861 6e64 6c65 7320 7374 7269      Handles stri
-00048120: 6e67 732c 2074 7570 6c65 732c 206f 7220  ngs, tuples, or 
-00048130: 616c 6961 7365 732e 0a20 2020 2020 2020  aliases..       
-00048140: 2022 2222 0a20 2020 2020 2020 2023 2058   """.        # X
-00048150: 5858 2068 6f77 206d 616e 7920 6164 6472  XX how many addr
-00048160: 6573 732d 7061 7273 696e 6720 726f 7574  ess-parsing rout
-00048170: 696e 6573 2064 6f20 7765 2068 6176 653f  ines do we have?
-00048180: 0a20 2020 2020 2020 2069 6620 6164 6472  .        if addr
-00048190: 2069 6e20 7365 6c66 2e61 6c69 6173 6573   in self.aliases
-000481a0: 3a0a 2020 2020 2020 2020 2020 2020 6164  :.            ad
-000481b0: 6472 203d 2073 656c 662e 616c 6961 7365  dr = self.aliase
-000481c0: 735b 6164 6472 5d0a 2020 2020 2020 2020  s[addr].        
-000481d0: 6966 2069 7369 6e73 7461 6e63 6528 6164  if isinstance(ad
-000481e0: 6472 2c20 7475 706c 6529 3a0a 2020 2020  dr, tuple):.    
-000481f0: 2020 2020 2020 2020 6164 6472 203d 2075          addr = u
-00048200: 6e70 6172 7365 5f68 6f73 745f 706f 7274  nparse_host_port
-00048210: 282a 6164 6472 290a 2020 2020 2020 2020  (*addr).        
-00048220: 6966 206e 6f74 2069 7369 6e73 7461 6e63  if not isinstanc
-00048230: 6528 6164 6472 2c20 7374 7229 3a0a 2020  e(addr, str):.  
-00048240: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00048250: 5479 7065 4572 726f 7228 6622 6164 6472  TypeError(f"addr
-00048260: 6573 7365 7320 7368 6f75 6c64 2062 6520  esses should be 
-00048270: 7374 7269 6e67 7320 6f72 2074 7570 6c65  strings or tuple
-00048280: 732c 2067 6f74 207b 6164 6472 2172 7d22  s, got {addr!r}"
-00048290: 290a 0a20 2020 2020 2020 2069 6620 7265  )..        if re
-000482a0: 736f 6c76 653a 0a20 2020 2020 2020 2020  solve:.         
-000482b0: 2020 2061 6464 7220 3d20 7265 736f 6c76     addr = resolv
-000482c0: 655f 6164 6472 6573 7328 6164 6472 290a  e_address(addr).
-000482d0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-000482e0: 2020 2020 2020 2020 2020 6164 6472 203d            addr =
-000482f0: 206e 6f72 6d61 6c69 7a65 5f61 6464 7265   normalize_addre
-00048300: 7373 2861 6464 7229 0a0a 2020 2020 2020  ss(addr)..      
-00048310: 2020 7265 7475 726e 2061 6464 720a 0a20    return addr.. 
-00048320: 2020 2064 6566 2077 6f72 6b65 7273 5f6c     def workers_l
-00048330: 6973 7428 7365 6c66 2c20 776f 726b 6572  ist(self, worker
-00048340: 733a 2049 7465 7261 626c 655b 7374 725d  s: Iterable[str]
-00048350: 207c 204e 6f6e 6529 202d 3e20 6c69 7374   | None) -> list
-00048360: 5b73 7472 5d3a 0a20 2020 2020 2020 2022  [str]:.        "
-00048370: 2222 0a20 2020 2020 2020 204c 6973 7420  "".        List 
-00048380: 6f66 2071 7561 6c69 6679 696e 6720 776f  of qualifying wo
-00048390: 726b 6572 730a 0a20 2020 2020 2020 2054  rkers..        T
-000483a0: 616b 6573 2061 206c 6973 7420 6f66 2077  akes a list of w
-000483b0: 6f72 6b65 7220 6164 6472 6573 7365 7320  orker addresses 
-000483c0: 6f72 2068 6f73 746e 616d 6573 2e0a 2020  or hostnames..  
-000483d0: 2020 2020 2020 5265 7475 726e 7320 6120        Returns a 
-000483e0: 6c69 7374 206f 6620 616c 6c20 776f 726b  list of all work
-000483f0: 6572 2061 6464 7265 7373 6573 2074 6861  er addresses tha
-00048400: 7420 6d61 7463 680a 2020 2020 2020 2020  t match.        
-00048410: 2222 220a 2020 2020 2020 2020 6966 2077  """.        if w
-00048420: 6f72 6b65 7273 2069 7320 4e6f 6e65 3a0a  orkers is None:.
-00048430: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00048440: 726e 206c 6973 7428 7365 6c66 2e77 6f72  rn list(self.wor
-00048450: 6b65 7273 290a 0a20 2020 2020 2020 206f  kers)..        o
-00048460: 7574 203d 2073 6574 2829 0a20 2020 2020  ut = set().     
-00048470: 2020 2066 6f72 2077 2069 6e20 776f 726b     for w in work
-00048480: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
-00048490: 2069 6620 223a 2220 696e 2077 3a0a 2020   if ":" in w:.  
-000484a0: 2020 2020 2020 2020 2020 2020 2020 6f75                ou
-000484b0: 742e 6164 6428 7729 0a20 2020 2020 2020  t.add(w).       
-000484c0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-000484d0: 2020 2020 2020 2020 2020 206f 7574 2e75             out.u
-000484e0: 7064 6174 6528 7b77 7720 666f 7220 7777  pdate({ww for ww
-000484f0: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
-00048500: 2069 6620 7720 696e 2077 777d 2920 2023   if w in ww})  #
-00048510: 2054 4f44 4f3a 2071 7561 6472 6174 6963   TODO: quadratic
-00048520: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00048530: 6c69 7374 286f 7574 290a 0a20 2020 2061  list(out)..    a
-00048540: 7379 6e63 2064 6566 2067 6574 5f70 726f  sync def get_pro
-00048550: 6669 6c65 280a 2020 2020 2020 2020 7365  file(.        se
-00048560: 6c66 2c0a 2020 2020 2020 2020 636f 6d6d  lf,.        comm
-00048570: 3d4e 6f6e 652c 0a20 2020 2020 2020 2077  =None,.        w
-00048580: 6f72 6b65 7273 3d4e 6f6e 652c 0a20 2020  orkers=None,.   
-00048590: 2020 2020 2073 6368 6564 756c 6572 3d46       scheduler=F
-000485a0: 616c 7365 2c0a 2020 2020 2020 2020 7365  alse,.        se
-000485b0: 7276 6572 3d46 616c 7365 2c0a 2020 2020  rver=False,.    
-000485c0: 2020 2020 6d65 7267 655f 776f 726b 6572      merge_worker
-000485d0: 733d 5472 7565 2c0a 2020 2020 2020 2020  s=True,.        
-000485e0: 7374 6172 743d 4e6f 6e65 2c0a 2020 2020  start=None,.    
-000485f0: 2020 2020 7374 6f70 3d4e 6f6e 652c 0a20      stop=None,. 
-00048600: 2020 2020 2020 206b 6579 3d4e 6f6e 652c         key=None,
-00048610: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
-00048620: 6966 2077 6f72 6b65 7273 2069 7320 4e6f  if workers is No
-00048630: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00048640: 776f 726b 6572 7320 3d20 7365 6c66 2e77  workers = self.w
-00048650: 6f72 6b65 7273 0a20 2020 2020 2020 2065  orkers.        e
-00048660: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00048670: 2077 6f72 6b65 7273 203d 2073 6574 2873   workers = set(s
-00048680: 656c 662e 776f 726b 6572 7329 2026 2073  elf.workers) & s
-00048690: 6574 2877 6f72 6b65 7273 290a 0a20 2020  et(workers)..   
-000486a0: 2020 2020 2069 6620 7363 6865 6475 6c65       if schedule
-000486b0: 723a 0a20 2020 2020 2020 2020 2020 2072  r:.            r
-000486c0: 6574 7572 6e20 7072 6f66 696c 652e 6765  eturn profile.ge
-000486d0: 745f 7072 6f66 696c 6528 7365 6c66 2e69  t_profile(self.i
-000486e0: 6f5f 6c6f 6f70 2e70 726f 6669 6c65 2c20  o_loop.profile, 
-000486f0: 7374 6172 743d 7374 6172 742c 2073 746f  start=start, sto
-00048700: 703d 7374 6f70 290a 0a20 2020 2020 2020  p=stop)..       
-00048710: 2072 6573 756c 7473 203d 2061 7761 6974   results = await
-00048720: 2061 7379 6e63 696f 2e67 6174 6865 7228   asyncio.gather(
-00048730: 0a20 2020 2020 2020 2020 2020 202a 280a  .            *(.
-00048740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048750: 7365 6c66 2e72 7063 2877 292e 7072 6f66  self.rpc(w).prof
-00048760: 696c 6528 7374 6172 743d 7374 6172 742c  ile(start=start,
-00048770: 2073 746f 703d 7374 6f70 2c20 6b65 793d   stop=stop, key=
-00048780: 6b65 792c 2073 6572 7665 723d 7365 7276  key, server=serv
-00048790: 6572 290a 2020 2020 2020 2020 2020 2020  er).            
-000487a0: 2020 2020 666f 7220 7720 696e 2077 6f72      for w in wor
-000487b0: 6b65 7273 0a20 2020 2020 2020 2020 2020  kers.           
-000487c0: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
-000487d0: 7265 7475 726e 5f65 7863 6570 7469 6f6e  return_exception
-000487e0: 733d 5472 7565 2c0a 2020 2020 2020 2020  s=True,.        
-000487f0: 290a 0a20 2020 2020 2020 2072 6573 756c  )..        resul
-00048800: 7473 203d 205b 7220 666f 7220 7220 696e  ts = [r for r in
-00048810: 2072 6573 756c 7473 2069 6620 6e6f 7420   results if not 
-00048820: 6973 696e 7374 616e 6365 2872 2c20 4578  isinstance(r, Ex
-00048830: 6365 7074 696f 6e29 5d0a 0a20 2020 2020  ception)]..     
-00048840: 2020 2069 6620 6d65 7267 655f 776f 726b     if merge_work
-00048850: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
-00048860: 2072 6573 706f 6e73 6520 3d20 7072 6f66   response = prof
-00048870: 696c 652e 6d65 7267 6528 2a72 6573 756c  ile.merge(*resul
-00048880: 7473 290a 2020 2020 2020 2020 656c 7365  ts).        else
-00048890: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-000488a0: 7370 6f6e 7365 203d 2064 6963 7428 7a69  sponse = dict(zi
-000488b0: 7028 776f 726b 6572 732c 2072 6573 756c  p(workers, resul
-000488c0: 7473 2929 0a20 2020 2020 2020 2072 6574  ts)).        ret
-000488d0: 7572 6e20 7265 7370 6f6e 7365 0a0a 2020  urn response..  
-000488e0: 2020 6173 796e 6320 6465 6620 6765 745f    async def get_
-000488f0: 7072 6f66 696c 655f 6d65 7461 6461 7461  profile_metadata
-00048900: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
-00048910: 2020 2020 2020 2020 776f 726b 6572 733a          workers:
-00048920: 2049 7465 7261 626c 655b 7374 725d 207c   Iterable[str] |
-00048930: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
-00048940: 2020 2020 2020 7374 6172 743a 2066 6c6f        start: flo
-00048950: 6174 203d 2030 2c0a 2020 2020 2020 2020  at = 0,.        
-00048960: 7374 6f70 3a20 666c 6f61 7420 7c20 4e6f  stop: float | No
-00048970: 6e65 203d 204e 6f6e 652c 0a20 2020 2020  ne = None,.     
-00048980: 2020 2070 726f 6669 6c65 5f63 7963 6c65     profile_cycle
-00048990: 5f69 6e74 6572 7661 6c3a 2073 7472 207c  _interval: str |
-000489a0: 2066 6c6f 6174 207c 204e 6f6e 6520 3d20   float | None = 
-000489b0: 4e6f 6e65 2c0a 2020 2020 2920 2d3e 2064  None,.    ) -> d
-000489c0: 6963 745b 7374 722c 2041 6e79 5d3a 0a20  ict[str, Any]:. 
-000489d0: 2020 2020 2020 2064 7420 3d20 7072 6f66         dt = prof
-000489e0: 696c 655f 6379 636c 655f 696e 7465 7276  ile_cycle_interv
-000489f0: 616c 206f 7220 6461 736b 2e63 6f6e 6669  al or dask.confi
-00048a00: 672e 6765 7428 0a20 2020 2020 2020 2020  g.get(.         
-00048a10: 2020 2022 6469 7374 7269 6275 7465 642e     "distributed.
-00048a20: 776f 726b 6572 2e70 726f 6669 6c65 2e63  worker.profile.c
-00048a30: 7963 6c65 220a 2020 2020 2020 2020 290a  ycle".        ).
-00048a40: 2020 2020 2020 2020 6474 203d 2070 6172          dt = par
-00048a50: 7365 5f74 696d 6564 656c 7461 2864 742c  se_timedelta(dt,
-00048a60: 2064 6566 6175 6c74 3d22 6d73 2229 0a0a   default="ms")..
-00048a70: 2020 2020 2020 2020 6966 2077 6f72 6b65          if worke
-00048a80: 7273 2069 7320 4e6f 6e65 3a0a 2020 2020  rs is None:.    
-00048a90: 2020 2020 2020 2020 776f 726b 6572 7320          workers 
-00048aa0: 3d20 7365 6c66 2e77 6f72 6b65 7273 0a20  = self.workers. 
-00048ab0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00048ac0: 2020 2020 2020 2020 2077 6f72 6b65 7273           workers
-00048ad0: 203d 2073 6574 2873 656c 662e 776f 726b   = set(self.work
-00048ae0: 6572 7329 2026 2073 6574 2877 6f72 6b65  ers) & set(worke
-00048af0: 7273 290a 2020 2020 2020 2020 7265 7375  rs).        resu
-00048b00: 6c74 733a 2053 6571 7565 6e63 655b 416e  lts: Sequence[An
-00048b10: 795d 203d 2061 7761 6974 2061 7379 6e63  y] = await async
-00048b20: 696f 2e67 6174 6865 7228 0a20 2020 2020  io.gather(.     
-00048b30: 2020 2020 2020 202a 2873 656c 662e 7270         *(self.rp
-00048b40: 6328 7729 2e70 726f 6669 6c65 5f6d 6574  c(w).profile_met
-00048b50: 6164 6174 6128 7374 6172 743d 7374 6172  adata(start=star
-00048b60: 742c 2073 746f 703d 7374 6f70 2920 666f  t, stop=stop) fo
-00048b70: 7220 7720 696e 2077 6f72 6b65 7273 292c  r w in workers),
-00048b80: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00048b90: 7572 6e5f 6578 6365 7074 696f 6e73 3d54  urn_exceptions=T
-00048ba0: 7275 652c 0a20 2020 2020 2020 2029 0a0a  rue,.        )..
-00048bb0: 2020 2020 2020 2020 7265 7375 6c74 7320          results 
-00048bc0: 3d20 5b72 2066 6f72 2072 2069 6e20 7265  = [r for r in re
-00048bd0: 7375 6c74 7320 6966 206e 6f74 2069 7369  sults if not isi
-00048be0: 6e73 7461 6e63 6528 722c 2045 7863 6570  nstance(r, Excep
-00048bf0: 7469 6f6e 295d 0a20 2020 2020 2020 2063  tion)].        c
-00048c00: 6f75 6e74 7320 3d20 5b0a 2020 2020 2020  ounts = [.      
-00048c10: 2020 2020 2020 2874 696d 652c 2073 756d        (time, sum
-00048c20: 2870 6c75 636b 2831 2c20 6772 6f75 7029  (pluck(1, group)
-00048c30: 2929 0a20 2020 2020 2020 2020 2020 2066  )).            f
-00048c40: 6f72 2074 696d 652c 2067 726f 7570 2069  or time, group i
-00048c50: 6e20 6974 6572 746f 6f6c 732e 6772 6f75  n itertools.grou
-00048c60: 7062 7928 0a20 2020 2020 2020 2020 2020  pby(.           
-00048c70: 2020 2020 206d 6572 6765 5f73 6f72 7465       merge_sorte
-00048c80: 6428 0a20 2020 2020 2020 2020 2020 2020  d(.             
-00048c90: 2020 2020 2020 202a 2876 5b22 636f 756e         *(v["coun
-00048ca0: 7473 225d 2066 6f72 2076 2069 6e20 7265  ts"] for v in re
-00048cb0: 7375 6c74 7329 2c0a 2020 2020 2020 2020  sults),.        
-00048cc0: 2020 2020 2020 2020 292c 0a20 2020 2020          ),.     
-00048cd0: 2020 2020 2020 2020 2020 206c 616d 6264             lambd
-00048ce0: 6120 743a 2074 5b30 5d20 2f2f 2064 7420  a t: t[0] // dt 
-00048cf0: 2a20 6474 2c0a 2020 2020 2020 2020 2020  * dt,.          
-00048d00: 2020 290a 2020 2020 2020 2020 5d0a 0a20    ).        ].. 
-00048d10: 2020 2020 2020 206b 6579 733a 2064 6963         keys: dic
-00048d20: 745b 4b65 792c 206c 6973 745b 6c69 7374  t[Key, list[list
-00048d30: 5d5d 203d 207b 0a20 2020 2020 2020 2020  ]] = {.         
-00048d40: 2020 206b 3a20 5b5d 2066 6f72 2076 2069     k: [] for v i
-00048d50: 6e20 7265 7375 6c74 7320 666f 7220 742c  n results for t,
-00048d60: 2064 2069 6e20 765b 226b 6579 7322 5d20   d in v["keys"] 
-00048d70: 666f 7220 6b20 696e 2064 0a20 2020 2020  for k in d.     
-00048d80: 2020 207d 0a0a 2020 2020 2020 2020 6772     }..        gr
-00048d90: 6f75 7073 3120 3d20 5b76 5b22 6b65 7973  oups1 = [v["keys
-00048da0: 225d 2066 6f72 2076 2069 6e20 7265 7375  "] for v in resu
-00048db0: 6c74 735d 0a20 2020 2020 2020 2067 726f  lts].        gro
-00048dc0: 7570 7332 203d 206c 6973 7428 6d65 7267  ups2 = list(merg
-00048dd0: 655f 736f 7274 6564 282a 6772 6f75 7073  e_sorted(*groups
-00048de0: 312c 206b 6579 3d66 6972 7374 2929 0a0a  1, key=first))..
-00048df0: 2020 2020 2020 2020 6c61 7374 203d 2030          last = 0
-00048e00: 0a20 2020 2020 2020 2066 6f72 2074 2c20  .        for t, 
-00048e10: 6420 696e 2067 726f 7570 7332 3a0a 2020  d in groups2:.  
-00048e20: 2020 2020 2020 2020 2020 7474 203d 2074            tt = t
-00048e30: 202f 2f20 6474 202a 2064 740a 2020 2020   // dt * dt.    
-00048e40: 2020 2020 2020 2020 6966 2074 7420 3e20          if tt > 
-00048e50: 6c61 7374 3a0a 2020 2020 2020 2020 2020  last:.          
-00048e60: 2020 2020 2020 6c61 7374 203d 2074 740a        last = tt.
-00048e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048e80: 666f 7220 7620 696e 206b 6579 732e 7661  for v in keys.va
-00048e90: 6c75 6573 2829 3a0a 2020 2020 2020 2020  lues():.        
-00048ea0: 2020 2020 2020 2020 2020 2020 762e 6170              v.ap
-00048eb0: 7065 6e64 285b 7474 2c20 305d 290a 2020  pend([tt, 0]).  
-00048ec0: 2020 2020 2020 2020 2020 666f 7220 6b2c            for k,
-00048ed0: 2076 2069 6e20 642e 6974 656d 7328 293a   v in d.items():
-00048ee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00048ef0: 206b 6579 735b 6b5d 5b2d 315d 5b31 5d20   keys[k][-1][1] 
-00048f00: 2b3d 2076 0a0a 2020 2020 2020 2020 7265  += v..        re
-00048f10: 7475 726e 207b 2263 6f75 6e74 7322 3a20  turn {"counts": 
-00048f20: 636f 756e 7473 2c20 226b 6579 7322 3a20  counts, "keys": 
-00048f30: 6b65 7973 7d0a 0a20 2020 2061 7379 6e63  keys}..    async
-00048f40: 2064 6566 2070 6572 666f 726d 616e 6365   def performance
-00048f50: 5f72 6570 6f72 7428 0a20 2020 2020 2020  _report(.       
-00048f60: 2073 656c 662c 2073 7461 7274 3a20 666c   self, start: fl
-00048f70: 6f61 742c 206c 6173 745f 636f 756e 743a  oat, last_count:
-00048f80: 2069 6e74 2c20 636f 6465 3a20 7374 7220   int, code: str 
-00048f90: 3d20 2222 2c20 6d6f 6465 3a20 7374 7220  = "", mode: str 
-00048fa0: 7c20 4e6f 6e65 203d 204e 6f6e 650a 2020  | None = None.  
-00048fb0: 2020 2920 2d3e 2073 7472 3a0a 2020 2020    ) -> str:.    
-00048fc0: 2020 2020 7374 6f70 203d 2074 696d 6528      stop = time(
-00048fd0: 290a 2020 2020 2020 2020 2320 5072 6f66  ).        # Prof
-00048fe0: 696c 6573 0a20 2020 2020 2020 2063 6f6d  iles.        com
-00048ff0: 7075 7465 2c20 7363 6865 6475 6c65 722c  pute, scheduler,
-00049000: 2077 6f72 6b65 7273 203d 2061 7761 6974   workers = await
-00049010: 2061 7379 6e63 696f 2e67 6174 6865 7228   asyncio.gather(
-00049020: 0a20 2020 2020 2020 2020 2020 202a 5b0a  .            *[.
-00049030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049040: 7365 6c66 2e67 6574 5f70 726f 6669 6c65  self.get_profile
-00049050: 2873 7461 7274 3d73 7461 7274 292c 0a20  (start=start),. 
-00049060: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00049070: 656c 662e 6765 745f 7072 6f66 696c 6528  elf.get_profile(
-00049080: 7363 6865 6475 6c65 723d 5472 7565 2c20  scheduler=True, 
-00049090: 7374 6172 743d 7374 6172 7429 2c0a 2020  start=start),.  
-000490a0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-000490b0: 6c66 2e67 6574 5f70 726f 6669 6c65 2873  lf.get_profile(s
-000490c0: 6572 7665 723d 5472 7565 2c20 7374 6172  erver=True, star
-000490d0: 743d 7374 6172 7429 2c0a 2020 2020 2020  t=start),.      
-000490e0: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
-000490f0: 290a 2020 2020 2020 2020 6672 6f6d 2064  ).        from d
-00049100: 6973 7472 6962 7574 6564 2069 6d70 6f72  istributed impor
-00049110: 7420 7072 6f66 696c 650a 0a20 2020 2020  t profile..     
-00049120: 2020 2064 6566 2070 726f 6669 6c65 5f74     def profile_t
-00049130: 6f5f 6669 6775 7265 2873 7461 7465 293a  o_figure(state):
-00049140: 0a20 2020 2020 2020 2020 2020 2064 6174  .            dat
-00049150: 6120 3d20 7072 6f66 696c 652e 706c 6f74  a = profile.plot
-00049160: 5f64 6174 6128 7374 6174 6529 0a20 2020  _data(state).   
-00049170: 2020 2020 2020 2020 2066 6967 7572 652c           figure,
-00049180: 2073 6f75 7263 6520 3d20 7072 6f66 696c   source = profil
-00049190: 652e 706c 6f74 5f66 6967 7572 6528 6461  e.plot_figure(da
-000491a0: 7461 2c20 7369 7a69 6e67 5f6d 6f64 653d  ta, sizing_mode=
-000491b0: 2273 7472 6574 6368 5f62 6f74 6822 290a  "stretch_both").
-000491c0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-000491d0: 726e 2066 6967 7572 650a 0a20 2020 2020  rn figure..     
-000491e0: 2020 2063 6f6d 7075 7465 2c20 7363 6865     compute, sche
-000491f0: 6475 6c65 722c 2077 6f72 6b65 7273 203d  duler, workers =
-00049200: 206d 6170 280a 2020 2020 2020 2020 2020   map(.          
-00049210: 2020 7072 6f66 696c 655f 746f 5f66 6967    profile_to_fig
-00049220: 7572 652c 2028 636f 6d70 7574 652c 2073  ure, (compute, s
-00049230: 6368 6564 756c 6572 2c20 776f 726b 6572  cheduler, worker
-00049240: 7329 0a20 2020 2020 2020 2029 0a0a 2020  s).        )..  
-00049250: 2020 2020 2020 2320 5461 736b 2073 7472        # Task str
-00049260: 6561 6d0a 2020 2020 2020 2020 7461 736b  eam.        task
-00049270: 5f73 7472 6561 6d20 3d20 7365 6c66 2e67  _stream = self.g
-00049280: 6574 5f74 6173 6b5f 7374 7265 616d 2873  et_task_stream(s
-00049290: 7461 7274 3d73 7461 7274 290a 2020 2020  tart=start).    
-000492a0: 2020 2020 746f 7461 6c5f 7461 736b 7320      total_tasks 
-000492b0: 3d20 6c65 6e28 7461 736b 5f73 7472 6561  = len(task_strea
-000492c0: 6d29 0a20 2020 2020 2020 2074 696d 6573  m).        times
-000492d0: 7065 6e74 3a20 6465 6661 756c 7464 6963  pent: defaultdic
-000492e0: 745b 7374 722c 2066 6c6f 6174 5d20 3d20  t[str, float] = 
-000492f0: 6465 6661 756c 7464 6963 7428 666c 6f61  defaultdict(floa
-00049300: 7429 0a20 2020 2020 2020 2066 6f72 2064  t).        for d
-00049310: 2069 6e20 7461 736b 5f73 7472 6561 6d3a   in task_stream:
-00049320: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00049330: 2078 2069 6e20 645b 2273 7461 7274 7374   x in d["startst
-00049340: 6f70 7322 5d3a 0a20 2020 2020 2020 2020  ops"]:.         
-00049350: 2020 2020 2020 2074 696d 6573 7065 6e74         timespent
-00049360: 5b78 5b22 6163 7469 6f6e 225d 5d20 2b3d  [x["action"]] +=
-00049370: 2078 5b22 7374 6f70 225d 202d 2078 5b22   x["stop"] - x["
-00049380: 7374 6172 7422 5d0a 2020 2020 2020 2020  start"].        
-00049390: 7461 736b 735f 7469 6d69 6e67 7320 3d20  tasks_timings = 
-000493a0: 2222 0a20 2020 2020 2020 2066 6f72 206b  "".        for k
-000493b0: 2069 6e20 736f 7274 6564 2874 696d 6573   in sorted(times
-000493c0: 7065 6e74 2e6b 6579 7328 2929 3a0a 2020  pent.keys()):.  
-000493d0: 2020 2020 2020 2020 2020 7461 736b 735f            tasks_
-000493e0: 7469 6d69 6e67 7320 2b3d 2066 225c 6e3c  timings += f"\n<
-000493f0: 6c69 3e20 7b6b 7d20 7469 6d65 3a20 7b66  li> {k} time: {f
-00049400: 6f72 6d61 745f 7469 6d65 2874 696d 6573  ormat_time(times
-00049410: 7065 6e74 5b6b 5d29 7d20 3c2f 6c69 3e22  pent[k])} </li>"
-00049420: 0a0a 2020 2020 2020 2020 6672 6f6d 2064  ..        from d
-00049430: 6973 7472 6962 7574 6564 2e64 6173 6862  istributed.dashb
-00049440: 6f61 7264 2e63 6f6d 706f 6e65 6e74 732e  oard.components.
-00049450: 7363 6865 6475 6c65 7220 696d 706f 7274  scheduler import
-00049460: 2074 6173 6b5f 7374 7265 616d 5f66 6967   task_stream_fig
-00049470: 7572 650a 2020 2020 2020 2020 6672 6f6d  ure.        from
-00049480: 2064 6973 7472 6962 7574 6564 2e64 6961   distributed.dia
-00049490: 676e 6f73 7469 6373 2e74 6173 6b5f 7374  gnostics.task_st
-000494a0: 7265 616d 2069 6d70 6f72 7420 7265 6374  ream import rect
-000494b0: 616e 676c 6573 0a0a 2020 2020 2020 2020  angles..        
-000494c0: 7265 6374 7320 3d20 7265 6374 616e 676c  rects = rectangl
-000494d0: 6573 2874 6173 6b5f 7374 7265 616d 290a  es(task_stream).
-000494e0: 2020 2020 2020 2020 736f 7572 6365 2c20          source, 
-000494f0: 7461 736b 5f73 7472 6561 6d20 3d20 7461  task_stream = ta
-00049500: 736b 5f73 7472 6561 6d5f 6669 6775 7265  sk_stream_figure
-00049510: 2873 697a 696e 675f 6d6f 6465 3d22 7374  (sizing_mode="st
-00049520: 7265 7463 685f 626f 7468 2229 0a20 2020  retch_both").   
-00049530: 2020 2020 2073 6f75 7263 652e 6461 7461       source.data
-00049540: 2e75 7064 6174 6528 7265 6374 7329 0a0a  .update(rects)..
-00049550: 2020 2020 2020 2020 2320 4261 6e64 7769          # Bandwi
-00049560: 6474 680a 2020 2020 2020 2020 6672 6f6d  dth.        from
-00049570: 2064 6973 7472 6962 7574 6564 2e64 6173   distributed.das
-00049580: 6862 6f61 7264 2e63 6f6d 706f 6e65 6e74  hboard.component
-00049590: 732e 7363 6865 6475 6c65 7220 696d 706f  s.scheduler impo
-000495a0: 7274 2028 0a20 2020 2020 2020 2020 2020  rt (.           
-000495b0: 2042 616e 6477 6964 7468 5479 7065 732c   BandwidthTypes,
-000495c0: 0a20 2020 2020 2020 2020 2020 2042 616e  .            Ban
-000495d0: 6477 6964 7468 576f 726b 6572 732c 0a20  dwidthWorkers,. 
-000495e0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-000495f0: 2020 6261 6e64 7769 6474 685f 776f 726b    bandwidth_work
-00049600: 6572 7320 3d20 4261 6e64 7769 6474 6857  ers = BandwidthW
-00049610: 6f72 6b65 7273 2873 656c 662c 2073 697a  orkers(self, siz
-00049620: 696e 675f 6d6f 6465 3d22 7374 7265 7463  ing_mode="stretc
-00049630: 685f 626f 7468 2229 0a20 2020 2020 2020  h_both").       
-00049640: 2062 616e 6477 6964 7468 5f77 6f72 6b65   bandwidth_worke
-00049650: 7273 2e75 7064 6174 6528 290a 2020 2020  rs.update().    
-00049660: 2020 2020 6261 6e64 7769 6474 685f 7479      bandwidth_ty
-00049670: 7065 7320 3d20 4261 6e64 7769 6474 6854  pes = BandwidthT
-00049680: 7970 6573 2873 656c 662c 2073 697a 696e  ypes(self, sizin
-00049690: 675f 6d6f 6465 3d22 7374 7265 7463 685f  g_mode="stretch_
-000496a0: 626f 7468 2229 0a20 2020 2020 2020 2062  both").        b
-000496b0: 616e 6477 6964 7468 5f74 7970 6573 2e75  andwidth_types.u
-000496c0: 7064 6174 6528 290a 0a20 2020 2020 2020  pdate()..       
-000496d0: 2023 2053 7973 7465 6d20 6d6f 6e69 746f   # System monito
-000496e0: 720a 2020 2020 2020 2020 6672 6f6d 2064  r.        from d
-000496f0: 6973 7472 6962 7574 6564 2e64 6173 6862  istributed.dashb
-00049700: 6f61 7264 2e63 6f6d 706f 6e65 6e74 732e  oard.components.
-00049710: 7368 6172 6564 2069 6d70 6f72 7420 5379  shared import Sy
-00049720: 7374 656d 4d6f 6e69 746f 720a 0a20 2020  stemMonitor..   
-00049730: 2020 2020 2073 7973 6d6f 6e20 3d20 5379       sysmon = Sy
-00049740: 7374 656d 4d6f 6e69 746f 7228 7365 6c66  stemMonitor(self
-00049750: 2c20 6c61 7374 5f63 6f75 6e74 3d6c 6173  , last_count=las
-00049760: 745f 636f 756e 742c 2073 697a 696e 675f  t_count, sizing_
-00049770: 6d6f 6465 3d22 7374 7265 7463 685f 626f  mode="stretch_bo
-00049780: 7468 2229 0a20 2020 2020 2020 2073 7973  th").        sys
-00049790: 6d6f 6e2e 7570 6461 7465 2829 0a0a 2020  mon.update()..  
-000497a0: 2020 2020 2020 2320 5363 6865 6475 6c65        # Schedule
-000497b0: 7220 6c6f 6773 0a20 2020 2020 2020 2066  r logs.        f
-000497c0: 726f 6d20 6469 7374 7269 6275 7465 642e  rom distributed.
-000497d0: 6461 7368 626f 6172 642e 636f 6d70 6f6e  dashboard.compon
-000497e0: 656e 7473 2e73 6368 6564 756c 6572 2069  ents.scheduler i
-000497f0: 6d70 6f72 7420 280a 2020 2020 2020 2020  mport (.        
-00049800: 2020 2020 5f42 4f4b 4548 5f53 5459 4c45      _BOKEH_STYLE
-00049810: 535f 4b57 4152 4753 2c0a 2020 2020 2020  S_KWARGS,.      
-00049820: 2020 2020 2020 5363 6865 6475 6c65 724c        SchedulerL
-00049830: 6f67 732c 0a20 2020 2020 2020 2029 0a0a  ogs,.        )..
-00049840: 2020 2020 2020 2020 6c6f 6773 203d 2053          logs = S
-00049850: 6368 6564 756c 6572 4c6f 6773 2873 656c  chedulerLogs(sel
-00049860: 662c 2073 7461 7274 3d73 7461 7274 290a  f, start=start).
-00049870: 0a20 2020 2020 2020 2066 726f 6d20 626f  .        from bo
-00049880: 6b65 682e 6d6f 6465 6c73 2069 6d70 6f72  keh.models impor
-00049890: 7420 4469 762c 2054 6162 730a 0a20 2020  t Div, Tabs..   
-000498a0: 2020 2020 2069 6d70 6f72 7420 6469 7374       import dist
-000498b0: 7269 6275 7465 640a 2020 2020 2020 2020  ributed.        
-000498c0: 6672 6f6d 2064 6973 7472 6962 7574 6564  from distributed
-000498d0: 2e64 6173 6862 6f61 7264 2e63 6f72 6520  .dashboard.core 
-000498e0: 696d 706f 7274 2054 6162 5061 6e65 6c0a  import TabPanel.
-000498f0: 0a20 2020 2020 2020 2023 2048 544d 4c0a  .        # HTML.
-00049900: 2020 2020 2020 2020 6874 6d6c 203d 2022          html = "
-00049910: 2222 0a20 2020 2020 2020 203c 6831 3e20  "".        <h1> 
-00049920: 4461 736b 2050 6572 666f 726d 616e 6365  Dask Performance
-00049930: 2052 6570 6f72 7420 3c2f 6831 3e0a 0a20   Report </h1>.. 
-00049940: 2020 2020 2020 203c 693e 2053 656c 6563         <i> Selec
-00049950: 7420 6469 6666 6572 656e 7420 7461 6273  t different tabs
-00049960: 206f 6e20 7468 6520 746f 7020 666f 7220   on the top for 
-00049970: 6164 6469 7469 6f6e 616c 2069 6e66 6f72  additional infor
-00049980: 6d61 7469 6f6e 203c 2f69 3e0a 0a20 2020  mation </i>..   
-00049990: 2020 2020 203c 6832 3e20 4475 7261 7469       <h2> Durati
-000499a0: 6f6e 3a20 7b74 696d 657d 203c 2f68 323e  on: {time} </h2>
-000499b0: 0a20 2020 2020 2020 203c 6832 3e20 5461  .        <h2> Ta
-000499c0: 736b 7320 496e 666f 726d 6174 696f 6e20  sks Information 
-000499d0: 3c2f 6832 3e0a 2020 2020 2020 2020 3c75  </h2>.        <u
-000499e0: 6c3e 0a20 2020 2020 2020 2020 3c6c 693e  l>.         <li>
-000499f0: 206e 756d 6265 7220 6f66 2074 6173 6b73   number of tasks
-00049a00: 3a20 7b6e 7461 736b 737d 203c 2f6c 693e  : {ntasks} </li>
-00049a10: 0a20 2020 2020 2020 2020 7b74 6173 6b73  .         {tasks
-00049a20: 5f74 696d 696e 6773 7d0a 2020 2020 2020  _timings}.      
-00049a30: 2020 3c2f 756c 3e0a 0a20 2020 2020 2020    </ul>..       
-00049a40: 203c 6832 3e20 5363 6865 6475 6c65 7220   <h2> Scheduler 
-00049a50: 496e 666f 726d 6174 696f 6e20 3c2f 6832  Information </h2
-00049a60: 3e0a 2020 2020 2020 2020 3c75 6c3e 0a20  >.        <ul>. 
-00049a70: 2020 2020 2020 2020 203c 6c69 3e20 4164           <li> Ad
-00049a80: 6472 6573 733a 207b 6164 6472 6573 737d  dress: {address}
-00049a90: 203c 2f6c 693e 0a20 2020 2020 2020 2020   </li>.         
-00049aa0: 203c 6c69 3e20 576f 726b 6572 733a 207b   <li> Workers: {
-00049ab0: 6e77 6f72 6b65 7273 7d20 3c2f 6c69 3e0a  nworkers} </li>.
-00049ac0: 2020 2020 2020 2020 2020 3c6c 693e 2054            <li> T
-00049ad0: 6872 6561 6473 3a20 7b74 6872 6561 6473  hreads: {threads
-00049ae0: 7d20 3c2f 6c69 3e0a 2020 2020 2020 2020  } </li>.        
-00049af0: 2020 3c6c 693e 204d 656d 6f72 793a 207b    <li> Memory: {
-00049b00: 6d65 6d6f 7279 7d20 3c2f 6c69 3e0a 2020  memory} </li>.  
-00049b10: 2020 2020 2020 2020 3c6c 693e 2044 6173          <li> Das
-00049b20: 6b20 5665 7273 696f 6e3a 207b 6461 736b  k Version: {dask
-00049b30: 5f76 6572 7369 6f6e 7d20 3c2f 6c69 3e0a  _version} </li>.
-00049b40: 2020 2020 2020 2020 2020 3c6c 693e 2044            <li> D
-00049b50: 6173 6b2e 4469 7374 7269 6275 7465 6420  ask.Distributed 
-00049b60: 5665 7273 696f 6e3a 207b 6469 7374 7269  Version: {distri
-00049b70: 6275 7465 645f 7665 7273 696f 6e7d 203c  buted_version} <
-00049b80: 2f6c 693e 0a20 2020 2020 2020 203c 2f75  /li>.        </u
-00049b90: 6c3e 0a0a 2020 2020 2020 2020 3c68 323e  l>..        <h2>
-00049ba0: 2043 616c 6c69 6e67 2043 6f64 6520 3c2f   Calling Code </
-00049bb0: 6832 3e0a 2020 2020 2020 2020 3c70 7265  h2>.        <pre
-00049bc0: 3e0a 7b63 6f64 657d 0a20 2020 2020 2020  >.{code}.       
-00049bd0: 203c 2f70 7265 3e0a 2020 2020 2020 2020   </pre>.        
-00049be0: 2222 222e 666f 726d 6174 280a 2020 2020  """.format(.    
-00049bf0: 2020 2020 2020 2020 7469 6d65 3d66 6f72          time=for
-00049c00: 6d61 745f 7469 6d65 2873 746f 7020 2d20  mat_time(stop - 
-00049c10: 7374 6172 7429 2c0a 2020 2020 2020 2020  start),.        
-00049c20: 2020 2020 6e74 6173 6b73 3d74 6f74 616c      ntasks=total
-00049c30: 5f74 6173 6b73 2c0a 2020 2020 2020 2020  _tasks,.        
-00049c40: 2020 2020 7461 736b 735f 7469 6d69 6e67      tasks_timing
-00049c50: 733d 7461 736b 735f 7469 6d69 6e67 732c  s=tasks_timings,
-00049c60: 0a20 2020 2020 2020 2020 2020 2061 6464  .            add
-00049c70: 7265 7373 3d73 656c 662e 6164 6472 6573  ress=self.addres
-00049c80: 732c 0a20 2020 2020 2020 2020 2020 206e  s,.            n
-00049c90: 776f 726b 6572 733d 6c65 6e28 7365 6c66  workers=len(self
-00049ca0: 2e77 6f72 6b65 7273 292c 0a20 2020 2020  .workers),.     
-00049cb0: 2020 2020 2020 2074 6872 6561 6473 3d73         threads=s
-00049cc0: 756d 2877 732e 6e74 6872 6561 6473 2066  um(ws.nthreads f
-00049cd0: 6f72 2077 7320 696e 2073 656c 662e 776f  or ws in self.wo
-00049ce0: 726b 6572 732e 7661 6c75 6573 2829 292c  rkers.values()),
-00049cf0: 0a20 2020 2020 2020 2020 2020 206d 656d  .            mem
-00049d00: 6f72 793d 666f 726d 6174 5f62 7974 6573  ory=format_bytes
-00049d10: 2873 756d 2877 732e 6d65 6d6f 7279 5f6c  (sum(ws.memory_l
-00049d20: 696d 6974 2066 6f72 2077 7320 696e 2073  imit for ws in s
-00049d30: 656c 662e 776f 726b 6572 732e 7661 6c75  elf.workers.valu
-00049d40: 6573 2829 2929 2c0a 2020 2020 2020 2020  es())),.        
-00049d50: 2020 2020 636f 6465 3d63 6f64 652c 0a20      code=code,. 
-00049d60: 2020 2020 2020 2020 2020 2064 6173 6b5f             dask_
-00049d70: 7665 7273 696f 6e3d 6461 736b 2e5f 5f76  version=dask.__v
-00049d80: 6572 7369 6f6e 5f5f 2c0a 2020 2020 2020  ersion__,.      
-00049d90: 2020 2020 2020 6469 7374 7269 6275 7465        distribute
-00049da0: 645f 7665 7273 696f 6e3d 6469 7374 7269  d_version=distri
-00049db0: 6275 7465 642e 5f5f 7665 7273 696f 6e5f  buted.__version_
-00049dc0: 5f2c 0a20 2020 2020 2020 2029 0a20 2020  _,.        ).   
-00049dd0: 2020 2020 2068 746d 6c20 3d20 4469 7628       html = Div(
-00049de0: 7465 7874 3d68 746d 6c2c 202a 2a5f 424f  text=html, **_BO
-00049df0: 4b45 485f 5354 594c 4553 5f4b 5741 5247  KEH_STYLES_KWARG
-00049e00: 5329 0a0a 2020 2020 2020 2020 6874 6d6c  S)..        html
-00049e10: 203d 2054 6162 5061 6e65 6c28 6368 696c   = TabPanel(chil
-00049e20: 643d 6874 6d6c 2c20 7469 746c 653d 2253  d=html, title="S
-00049e30: 756d 6d61 7279 2229 0a20 2020 2020 2020  ummary").       
-00049e40: 2063 6f6d 7075 7465 203d 2054 6162 5061   compute = TabPa
-00049e50: 6e65 6c28 6368 696c 643d 636f 6d70 7574  nel(child=comput
-00049e60: 652c 2074 6974 6c65 3d22 576f 726b 6572  e, title="Worker
-00049e70: 2050 726f 6669 6c65 2028 636f 6d70 7574   Profile (comput
-00049e80: 6529 2229 0a20 2020 2020 2020 2077 6f72  e)").        wor
-00049e90: 6b65 7273 203d 2054 6162 5061 6e65 6c28  kers = TabPanel(
-00049ea0: 6368 696c 643d 776f 726b 6572 732c 2074  child=workers, t
-00049eb0: 6974 6c65 3d22 576f 726b 6572 2050 726f  itle="Worker Pro
-00049ec0: 6669 6c65 2028 6164 6d69 6e69 7374 7261  file (administra
-00049ed0: 7469 7665 2922 290a 2020 2020 2020 2020  tive)").        
-00049ee0: 7363 6865 6475 6c65 7220 3d20 5461 6250  scheduler = TabP
-00049ef0: 616e 656c 280a 2020 2020 2020 2020 2020  anel(.          
-00049f00: 2020 6368 696c 643d 7363 6865 6475 6c65    child=schedule
-00049f10: 722c 2074 6974 6c65 3d22 5363 6865 6475  r, title="Schedu
-00049f20: 6c65 7220 5072 6f66 696c 6520 2861 646d  ler Profile (adm
-00049f30: 696e 6973 7472 6174 6976 6529 220a 2020  inistrative)".  
-00049f40: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00049f50: 7461 736b 5f73 7472 6561 6d20 3d20 5461  task_stream = Ta
-00049f60: 6250 616e 656c 2863 6869 6c64 3d74 6173  bPanel(child=tas
-00049f70: 6b5f 7374 7265 616d 2c20 7469 746c 653d  k_stream, title=
-00049f80: 2254 6173 6b20 5374 7265 616d 2229 0a20  "Task Stream"). 
-00049f90: 2020 2020 2020 2062 616e 6477 6964 7468         bandwidth
-00049fa0: 5f77 6f72 6b65 7273 203d 2054 6162 5061  _workers = TabPa
-00049fb0: 6e65 6c28 0a20 2020 2020 2020 2020 2020  nel(.           
-00049fc0: 2063 6869 6c64 3d62 616e 6477 6964 7468   child=bandwidth
-00049fd0: 5f77 6f72 6b65 7273 2e72 6f6f 742c 2074  _workers.root, t
-00049fe0: 6974 6c65 3d22 4261 6e64 7769 6474 6820  itle="Bandwidth 
-00049ff0: 2857 6f72 6b65 7273 2922 0a20 2020 2020  (Workers)".     
-0004a000: 2020 2029 0a20 2020 2020 2020 2062 616e     ).        ban
-0004a010: 6477 6964 7468 5f74 7970 6573 203d 2054  dwidth_types = T
-0004a020: 6162 5061 6e65 6c28 0a20 2020 2020 2020  abPanel(.       
-0004a030: 2020 2020 2063 6869 6c64 3d62 616e 6477       child=bandw
-0004a040: 6964 7468 5f74 7970 6573 2e72 6f6f 742c  idth_types.root,
-0004a050: 2074 6974 6c65 3d22 4261 6e64 7769 6474   title="Bandwidt
-0004a060: 6820 2854 7970 6573 2922 0a20 2020 2020  h (Types)".     
-0004a070: 2020 2029 0a20 2020 2020 2020 2073 7973     ).        sys
-0004a080: 7465 6d20 3d20 5461 6250 616e 656c 2863  tem = TabPanel(c
-0004a090: 6869 6c64 3d73 7973 6d6f 6e2e 726f 6f74  hild=sysmon.root
-0004a0a0: 2c20 7469 746c 653d 2253 7973 7465 6d22  , title="System"
-0004a0b0: 290a 2020 2020 2020 2020 6c6f 6773 203d  ).        logs =
-0004a0c0: 2054 6162 5061 6e65 6c28 6368 696c 643d   TabPanel(child=
-0004a0d0: 6c6f 6773 2e72 6f6f 742c 2074 6974 6c65  logs.root, title
-0004a0e0: 3d22 5363 6865 6475 6c65 7220 4c6f 6773  ="Scheduler Logs
-0004a0f0: 2229 0a0a 2020 2020 2020 2020 7461 6273  ")..        tabs
-0004a100: 203d 2054 6162 7328 0a20 2020 2020 2020   = Tabs(.       
-0004a110: 2020 2020 2074 6162 733d 5b0a 2020 2020       tabs=[.    
-0004a120: 2020 2020 2020 2020 2020 2020 6874 6d6c              html
-0004a130: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0004a140: 2020 7461 736b 5f73 7472 6561 6d2c 0a20    task_stream,. 
-0004a150: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0004a160: 7973 7465 6d2c 0a20 2020 2020 2020 2020  ystem,.         
-0004a170: 2020 2020 2020 206c 6f67 732c 0a20 2020         logs,.   
-0004a180: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
-0004a190: 7075 7465 2c0a 2020 2020 2020 2020 2020  pute,.          
-0004a1a0: 2020 2020 2020 776f 726b 6572 732c 0a20        workers,. 
-0004a1b0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0004a1c0: 6368 6564 756c 6572 2c0a 2020 2020 2020  cheduler,.      
-0004a1d0: 2020 2020 2020 2020 2020 6261 6e64 7769            bandwi
-0004a1e0: 6474 685f 776f 726b 6572 732c 0a20 2020  dth_workers,.   
-0004a1f0: 2020 2020 2020 2020 2020 2020 2062 616e               ban
-0004a200: 6477 6964 7468 5f74 7970 6573 2c0a 2020  dwidth_types,.  
-0004a210: 2020 2020 2020 2020 2020 5d2c 0a20 2020            ],.   
-0004a220: 2020 2020 2020 2020 2073 697a 696e 675f           sizing_
-0004a230: 6d6f 6465 3d22 7374 7265 7463 685f 626f  mode="stretch_bo
-0004a240: 7468 222c 0a20 2020 2020 2020 2029 0a0a  th",.        )..
-0004a250: 2020 2020 2020 2020 6672 6f6d 2062 6f6b          from bok
-0004a260: 6568 2e63 6f72 652e 7465 6d70 6c61 7465  eh.core.template
-0004a270: 7320 696d 706f 7274 2067 6574 5f65 6e76  s import get_env
-0004a280: 0a20 2020 2020 2020 2066 726f 6d20 626f  .        from bo
-0004a290: 6b65 682e 706c 6f74 7469 6e67 2069 6d70  keh.plotting imp
-0004a2a0: 6f72 7420 6f75 7470 7574 5f66 696c 652c  ort output_file,
-0004a2b0: 2073 6176 650a 0a20 2020 2020 2020 2077   save..        w
-0004a2c0: 6974 6820 746d 7066 696c 6528 6578 7465  ith tmpfile(exte
-0004a2d0: 6e73 696f 6e3d 222e 6874 6d6c 2229 2061  nsion=".html") a
-0004a2e0: 7320 666e 3a0a 2020 2020 2020 2020 2020  s fn:.          
-0004a2f0: 2020 6f75 7470 7574 5f66 696c 6528 6669    output_file(fi
-0004a300: 6c65 6e61 6d65 3d66 6e2c 2074 6974 6c65  lename=fn, title
-0004a310: 3d22 4461 736b 2050 6572 666f 726d 616e  ="Dask Performan
-0004a320: 6365 2052 6570 6f72 7422 2c20 6d6f 6465  ce Report", mode
-0004a330: 3d6d 6f64 6529 0a20 2020 2020 2020 2020  =mode).         
-0004a340: 2020 2074 656d 706c 6174 655f 6469 7265     template_dire
-0004a350: 6374 6f72 7920 3d20 6f73 2e70 6174 682e  ctory = os.path.
-0004a360: 6a6f 696e 280a 2020 2020 2020 2020 2020  join(.          
-0004a370: 2020 2020 2020 6f73 2e70 6174 682e 6469        os.path.di
-0004a380: 726e 616d 6528 6f73 2e70 6174 682e 6162  rname(os.path.ab
-0004a390: 7370 6174 6828 5f5f 6669 6c65 5f5f 2929  spath(__file__))
-0004a3a0: 2c20 2264 6173 6862 6f61 7264 222c 2022  , "dashboard", "
-0004a3b0: 7465 6d70 6c61 7465 7322 0a20 2020 2020  templates".     
-0004a3c0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0004a3d0: 2020 2020 2074 656d 706c 6174 655f 656e       template_en
-0004a3e0: 7669 726f 6e6d 656e 7420 3d20 6765 745f  vironment = get_
-0004a3f0: 656e 7628 290a 2020 2020 2020 2020 2020  env().          
-0004a400: 2020 7465 6d70 6c61 7465 5f65 6e76 6972    template_envir
-0004a410: 6f6e 6d65 6e74 2e6c 6f61 6465 722e 7365  onment.loader.se
-0004a420: 6172 6368 7061 7468 2e61 7070 656e 6428  archpath.append(
-0004a430: 7465 6d70 6c61 7465 5f64 6972 6563 746f  template_directo
-0004a440: 7279 290a 2020 2020 2020 2020 2020 2020  ry).            
-0004a450: 7465 6d70 6c61 7465 203d 2074 656d 706c  template = templ
-0004a460: 6174 655f 656e 7669 726f 6e6d 656e 742e  ate_environment.
-0004a470: 6765 745f 7465 6d70 6c61 7465 2822 7065  get_template("pe
-0004a480: 7266 6f72 6d61 6e63 655f 7265 706f 7274  rformance_report
-0004a490: 2e68 746d 6c22 290a 2020 2020 2020 2020  .html").        
-0004a4a0: 2020 2020 7361 7665 2874 6162 732c 2066      save(tabs, f
-0004a4b0: 696c 656e 616d 653d 666e 2c20 7465 6d70  ilename=fn, temp
-0004a4c0: 6c61 7465 3d74 656d 706c 6174 6529 0a0a  late=template)..
-0004a4d0: 2020 2020 2020 2020 2020 2020 7769 7468              with
-0004a4e0: 206f 7065 6e28 666e 2920 6173 2066 3a0a   open(fn) as f:.
-0004a4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a500: 6461 7461 203d 2066 2e72 6561 6428 290a  data = f.read().
-0004a510: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0004a520: 6461 7461 0a0a 2020 2020 6173 796e 6320  data..    async 
-0004a530: 6465 6620 6765 745f 776f 726b 6572 5f6c  def get_worker_l
-0004a540: 6f67 7328 7365 6c66 2c20 6e3d 4e6f 6e65  ogs(self, n=None
-0004a550: 2c20 776f 726b 6572 733d 4e6f 6e65 2c20  , workers=None, 
-0004a560: 6e61 6e6e 793d 4661 6c73 6529 3a0a 2020  nanny=False):.  
-0004a570: 2020 2020 2020 7265 7375 6c74 7320 3d20        results = 
-0004a580: 6177 6169 7420 7365 6c66 2e62 726f 6164  await self.broad
-0004a590: 6361 7374 280a 2020 2020 2020 2020 2020  cast(.          
-0004a5a0: 2020 6d73 673d 7b22 6f70 223a 2022 6765    msg={"op": "ge
-0004a5b0: 745f 6c6f 6773 222c 2022 6e22 3a20 6e7d  t_logs", "n": n}
-0004a5c0: 2c20 776f 726b 6572 733d 776f 726b 6572  , workers=worker
-0004a5d0: 732c 206e 616e 6e79 3d6e 616e 6e79 0a20  s, nanny=nanny. 
-0004a5e0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0004a5f0: 2072 6574 7572 6e20 7265 7375 6c74 730a   return results.
-0004a600: 0a20 2020 2064 6566 206c 6f67 5f65 7665  .    def log_eve
-0004a610: 6e74 2873 656c 662c 2074 6f70 6963 3a20  nt(self, topic: 
-0004a620: 7374 7220 7c20 436f 6c6c 6563 7469 6f6e  str | Collection
-0004a630: 5b73 7472 5d2c 206d 7367 3a20 416e 7929  [str], msg: Any)
-0004a640: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-0004a650: 2020 2222 224c 6f67 2061 6e20 6576 656e    """Log an even
-0004a660: 7420 756e 6465 7220 6120 6769 7665 6e20  t under a given 
-0004a670: 746f 7069 630a 0a20 2020 2020 2020 2050  topic..        P
-0004a680: 6172 616d 6574 6572 730a 2020 2020 2020  arameters.      
-0004a690: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
-0004a6a0: 2020 2020 2074 6f70 6963 203a 2073 7472       topic : str
-0004a6b0: 2c20 6c69 7374 5b73 7472 5d0a 2020 2020  , list[str].    
-0004a6c0: 2020 2020 2020 2020 4e61 6d65 206f 6620          Name of 
-0004a6d0: 7468 6520 746f 7069 6320 756e 6465 7220  the topic under 
-0004a6e0: 7768 6963 6820 746f 206c 6f67 2061 6e20  which to log an 
-0004a6f0: 6576 656e 742e 2054 6f20 6c6f 6720 7468  event. To log th
-0004a700: 6520 7361 6d65 0a20 2020 2020 2020 2020  e same.         
-0004a710: 2020 2065 7665 6e74 2075 6e64 6572 206d     event under m
-0004a720: 756c 7469 706c 6520 746f 7069 6373 2c20  ultiple topics, 
-0004a730: 7061 7373 2061 206c 6973 7420 6f66 2074  pass a list of t
-0004a740: 6f70 6963 206e 616d 6573 2e0a 2020 2020  opic names..    
-0004a750: 2020 2020 6d73 670a 2020 2020 2020 2020      msg.        
-0004a760: 2020 2020 4576 656e 7420 6d65 7373 6167      Event messag
-0004a770: 6520 746f 206c 6f67 2e20 4e6f 7465 2074  e to log. Note t
-0004a780: 6869 7320 6d75 7374 2062 6520 6d73 6770  his must be msgp
-0004a790: 6163 6b20 7365 7269 616c 697a 6162 6c65  ack serializable
-0004a7a0: 2e0a 0a20 2020 2020 2020 2053 6565 2061  ...        See a
-0004a7b0: 6c73 6f0a 2020 2020 2020 2020 2d2d 2d2d  lso.        ----
-0004a7c0: 2d2d 2d2d 0a20 2020 2020 2020 2043 6c69  ----.        Cli
-0004a7d0: 656e 742e 6c6f 675f 6576 656e 740a 2020  ent.log_event.  
-0004a7e0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0004a7f0: 2020 6576 656e 7420 3d20 2874 696d 6528    event = (time(
-0004a800: 292c 206d 7367 290a 2020 2020 2020 2020  ), msg).        
-0004a810: 6966 206e 6f74 2069 7369 6e73 7461 6e63  if not isinstanc
-0004a820: 6528 746f 7069 632c 2073 7472 293a 0a20  e(topic, str):. 
-0004a830: 2020 2020 2020 2020 2020 2066 6f72 2074             for t
-0004a840: 2069 6e20 746f 7069 633a 0a20 2020 2020   in topic:.     
-0004a850: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0004a860: 6576 656e 7473 5b74 5d2e 6170 7065 6e64  events[t].append
-0004a870: 2865 7665 6e74 290a 2020 2020 2020 2020  (event).        
-0004a880: 2020 2020 2020 2020 7365 6c66 2e65 7665          self.eve
-0004a890: 6e74 5f63 6f75 6e74 735b 745d 202b 3d20  nt_counts[t] += 
-0004a8a0: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
-0004a8b0: 2020 7365 6c66 2e5f 7265 706f 7274 5f65    self._report_e
-0004a8c0: 7665 6e74 2874 2c20 6576 656e 7429 0a20  vent(t, event). 
-0004a8d0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0004a8e0: 2020 2020 2020 2020 2073 656c 662e 6576           self.ev
-0004a8f0: 656e 7473 5b74 6f70 6963 5d2e 6170 7065  ents[topic].appe
-0004a900: 6e64 2865 7665 6e74 290a 2020 2020 2020  nd(event).      
-0004a910: 2020 2020 2020 7365 6c66 2e65 7665 6e74        self.event
-0004a920: 5f63 6f75 6e74 735b 746f 7069 635d 202b  _counts[topic] +
-0004a930: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
-0004a940: 7365 6c66 2e5f 7265 706f 7274 5f65 7665  self._report_eve
-0004a950: 6e74 2874 6f70 6963 2c20 6576 656e 7429  nt(topic, event)
-0004a960: 0a0a 2020 2020 2020 2020 2020 2020 666f  ..            fo
-0004a970: 7220 706c 7567 696e 2069 6e20 6c69 7374  r plugin in list
-0004a980: 2873 656c 662e 706c 7567 696e 732e 7661  (self.plugins.va
-0004a990: 6c75 6573 2829 293a 0a20 2020 2020 2020  lues()):.       
-0004a9a0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-0004a9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a9c0: 2020 706c 7567 696e 2e6c 6f67 5f65 7665    plugin.log_eve
-0004a9d0: 6e74 2874 6f70 6963 2c20 6d73 6729 0a20  nt(topic, msg). 
-0004a9e0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0004a9f0: 7863 6570 7420 4578 6365 7074 696f 6e3a  xcept Exception:
-0004aa00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004aa10: 2020 2020 206c 6f67 6765 722e 696e 666f       logger.info
-0004aa20: 2822 506c 7567 696e 2066 6169 6c65 6420  ("Plugin failed 
-0004aa30: 7769 7468 2065 7863 6570 7469 6f6e 222c  with exception",
-0004aa40: 2065 7863 5f69 6e66 6f3d 5472 7565 290a   exc_info=True).
-0004aa50: 0a20 2020 2064 6566 205f 7265 706f 7274  .    def _report
-0004aa60: 5f65 7665 6e74 2873 656c 662c 206e 616d  _event(self, nam
-0004aa70: 652c 2065 7665 6e74 293a 0a20 2020 2020  e, event):.     
-0004aa80: 2020 206d 7367 203d 207b 0a20 2020 2020     msg = {.     
-0004aa90: 2020 2020 2020 2022 6f70 223a 2022 6576         "op": "ev
-0004aaa0: 656e 7422 2c0a 2020 2020 2020 2020 2020  ent",.          
-0004aab0: 2020 2274 6f70 6963 223a 206e 616d 652c    "topic": name,
-0004aac0: 0a20 2020 2020 2020 2020 2020 2022 6576  .            "ev
-0004aad0: 656e 7422 3a20 6576 656e 742c 0a20 2020  ent": event,.   
-0004aae0: 2020 2020 207d 0a20 2020 2020 2020 2063       }.        c
-0004aaf0: 6c69 656e 745f 6d73 6773 203d 207b 636c  lient_msgs = {cl
-0004ab00: 6965 6e74 3a20 5b6d 7367 5d20 666f 7220  ient: [msg] for 
-0004ab10: 636c 6965 6e74 2069 6e20 7365 6c66 2e65  client in self.e
-0004ab20: 7665 6e74 5f73 7562 7363 7269 6265 725b  vent_subscriber[
-0004ab30: 6e61 6d65 5d7d 0a20 2020 2020 2020 2073  name]}.        s
-0004ab40: 656c 662e 7365 6e64 5f61 6c6c 2863 6c69  elf.send_all(cli
-0004ab50: 656e 745f 6d73 6773 2c20 776f 726b 6572  ent_msgs, worker
-0004ab60: 5f6d 7367 733d 7b7d 290a 0a20 2020 2064  _msgs={})..    d
-0004ab70: 6566 2073 7562 7363 7269 6265 5f74 6f70  ef subscribe_top
-0004ab80: 6963 2873 656c 662c 2074 6f70 6963 2c20  ic(self, topic, 
-0004ab90: 636c 6965 6e74 293a 0a20 2020 2020 2020  client):.       
-0004aba0: 2073 656c 662e 6576 656e 745f 7375 6273   self.event_subs
-0004abb0: 6372 6962 6572 5b74 6f70 6963 5d2e 6164  criber[topic].ad
-0004abc0: 6428 636c 6965 6e74 290a 0a20 2020 2064  d(client)..    d
-0004abd0: 6566 2075 6e73 7562 7363 7269 6265 5f74  ef unsubscribe_t
-0004abe0: 6f70 6963 2873 656c 662c 2074 6f70 6963  opic(self, topic
-0004abf0: 2c20 636c 6965 6e74 293a 0a20 2020 2020  , client):.     
-0004ac00: 2020 2073 656c 662e 6576 656e 745f 7375     self.event_su
-0004ac10: 6273 6372 6962 6572 5b74 6f70 6963 5d2e  bscriber[topic].
-0004ac20: 6469 7363 6172 6428 636c 6965 6e74 290a  discard(client).
-0004ac30: 0a20 2020 2064 6566 2067 6574 5f65 7665  .    def get_eve
-0004ac40: 6e74 7328 7365 6c66 2c20 746f 7069 633d  nts(self, topic=
-0004ac50: 4e6f 6e65 293a 0a20 2020 2020 2020 2069  None):.        i
-0004ac60: 6620 746f 7069 6320 6973 206e 6f74 204e  f topic is not N
-0004ac70: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0004ac80: 2072 6574 7572 6e20 7475 706c 6528 7365   return tuple(se
-0004ac90: 6c66 2e65 7665 6e74 735b 746f 7069 635d  lf.events[topic]
-0004aca0: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-0004acb0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0004acc0: 726e 2076 616c 6d61 7028 7475 706c 652c  rn valmap(tuple,
-0004acd0: 2073 656c 662e 6576 656e 7473 290a 0a20   self.events).. 
-0004ace0: 2020 2061 7379 6e63 2064 6566 2067 6574     async def get
-0004acf0: 5f77 6f72 6b65 725f 6d6f 6e69 746f 725f  _worker_monitor_
-0004ad00: 696e 666f 2873 656c 662c 2072 6563 656e  info(self, recen
-0004ad10: 743d 4661 6c73 652c 2073 7461 7274 733d  t=False, starts=
-0004ad20: 4e6f 6e65 293a 0a20 2020 2020 2020 2069  None):.        i
-0004ad30: 6620 7374 6172 7473 2069 7320 4e6f 6e65  f starts is None
-0004ad40: 3a0a 2020 2020 2020 2020 2020 2020 7374  :.            st
-0004ad50: 6172 7473 203d 207b 7d0a 2020 2020 2020  arts = {}.      
-0004ad60: 2020 7265 7375 6c74 7320 3d20 6177 6169    results = awai
-0004ad70: 7420 6173 796e 6369 6f2e 6761 7468 6572  t asyncio.gather
-0004ad80: 280a 2020 2020 2020 2020 2020 2020 2a28  (.            *(
-0004ad90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004ada0: 2073 656c 662e 7270 6328 7729 2e67 6574   self.rpc(w).get
-0004adb0: 5f6d 6f6e 6974 6f72 5f69 6e66 6f28 7265  _monitor_info(re
-0004adc0: 6365 6e74 3d72 6563 656e 742c 2073 7461  cent=recent, sta
-0004add0: 7274 3d73 7461 7274 732e 6765 7428 772c  rt=starts.get(w,
-0004ade0: 2030 2929 0a20 2020 2020 2020 2020 2020   0)).           
-0004adf0: 2020 2020 2066 6f72 2077 2069 6e20 7365       for w in se
-0004ae00: 6c66 2e77 6f72 6b65 7273 0a20 2020 2020  lf.workers.     
-0004ae10: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0004ae20: 2029 0a20 2020 2020 2020 2072 6574 7572   ).        retur
-0004ae30: 6e20 6469 6374 287a 6970 2873 656c 662e  n dict(zip(self.
-0004ae40: 776f 726b 6572 732c 2072 6573 756c 7473  workers, results
-0004ae50: 2929 0a0a 2020 2020 2323 2323 2323 2323  ))..    ########
-0004ae60: 2323 230a 2020 2020 2320 436c 6561 6e75  ###.    # Cleanu
-0004ae70: 7020 230a 2020 2020 2323 2323 2323 2323  p #.    ########
-0004ae80: 2323 230a 0a20 2020 2040 6c6f 675f 6572  ###..    @log_er
-0004ae90: 726f 7273 0a20 2020 2061 7379 6e63 2064  rors.    async d
-0004aea0: 6566 2063 6865 636b 5f77 6f72 6b65 725f  ef check_worker_
-0004aeb0: 7474 6c28 7365 6c66 2920 2d3e 204e 6f6e  ttl(self) -> Non
-0004aec0: 653a 0a20 2020 2020 2020 206e 6f77 203d  e:.        now =
-0004aed0: 2074 696d 6528 290a 2020 2020 2020 2020   time().        
-0004aee0: 7374 696d 756c 7573 5f69 6420 3d20 6622  stimulus_id = f"
-0004aef0: 6368 6563 6b2d 776f 726b 6572 2d74 746c  check-worker-ttl
-0004af00: 2d7b 6e6f 777d 220a 2020 2020 2020 2020  -{now}".        
-0004af10: 6173 7365 7274 2073 656c 662e 776f 726b  assert self.work
-0004af20: 6572 5f74 746c 0a20 2020 2020 2020 2074  er_ttl.        t
-0004af30: 746c 203d 206d 6178 2873 656c 662e 776f  tl = max(self.wo
-0004af40: 726b 6572 5f74 746c 2c20 3130 202a 2068  rker_ttl, 10 * h
-0004af50: 6561 7274 6265 6174 5f69 6e74 6572 7661  eartbeat_interva
-0004af60: 6c28 6c65 6e28 7365 6c66 2e77 6f72 6b65  l(len(self.worke
-0004af70: 7273 2929 290a 2020 2020 2020 2020 746f  rs))).        to
-0004af80: 5f72 6573 7461 7274 203d 205b 5d0a 0a20  _restart = [].. 
-0004af90: 2020 2020 2020 2066 6f72 2077 7320 696e         for ws in
-0004afa0: 2073 656c 662e 776f 726b 6572 732e 7661   self.workers.va
-0004afb0: 6c75 6573 2829 3a0a 2020 2020 2020 2020  lues():.        
-0004afc0: 2020 2020 6c61 7374 5f73 6565 6e20 3d20      last_seen = 
-0004afd0: 6e6f 7720 2d20 7773 2e6c 6173 745f 7365  now - ws.last_se
-0004afe0: 656e 0a20 2020 2020 2020 2020 2020 2069  en.            i
-0004aff0: 6620 6c61 7374 5f73 6565 6e20 3e20 7474  f last_seen > tt
-0004b000: 6c3a 0a20 2020 2020 2020 2020 2020 2020  l:.             
-0004b010: 2020 2074 6f5f 7265 7374 6172 742e 6170     to_restart.ap
-0004b020: 7065 6e64 2877 732e 6164 6472 6573 7329  pend(ws.address)
-0004b030: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004b040: 206c 6f67 6765 722e 7761 726e 696e 6728   logger.warning(
-0004b050: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004b060: 2020 2020 2066 2257 6f72 6b65 7220 6661       f"Worker fa
-0004b070: 696c 6564 2074 6f20 6865 6172 7462 6561  iled to heartbea
-0004b080: 7420 666f 7220 7b6c 6173 745f 7365 656e  t for {last_seen
-0004b090: 3a2e 3066 7d73 3b20 220a 2020 2020 2020  :.0f}s; ".      
-0004b0a0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-0004b0b0: 7b27 6174 7465 6d70 7469 6e67 2072 6573  {'attempting res
-0004b0c0: 7461 7274 2720 6966 2077 732e 6e61 6e6e  tart' if ws.nann
-0004b0d0: 7920 656c 7365 2027 7265 6d6f 7669 6e67  y else 'removing
-0004b0e0: 277d 3a20 7b77 737d 220a 2020 2020 2020  '}: {ws}".      
-0004b0f0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-0004b100: 2020 2020 2069 6620 746f 5f72 6573 7461       if to_resta
-0004b110: 7274 3a0a 2020 2020 2020 2020 2020 2020  rt:.            
-0004b120: 6177 6169 7420 7365 6c66 2e72 6573 7461  await self.resta
-0004b130: 7274 5f77 6f72 6b65 7273 280a 2020 2020  rt_workers(.    
-0004b140: 2020 2020 2020 2020 2020 2020 746f 5f72              to_r
-0004b150: 6573 7461 7274 2c0a 2020 2020 2020 2020  estart,.        
-0004b160: 2020 2020 2020 2020 7761 6974 5f66 6f72          wait_for
-0004b170: 5f77 6f72 6b65 7273 3d46 616c 7365 2c0a  _workers=False,.
-0004b180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b190: 7374 696d 756c 7573 5f69 643d 7374 696d  stimulus_id=stim
-0004b1a0: 756c 7573 5f69 642c 0a20 2020 2020 2020  ulus_id,.       
-0004b1b0: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
-0004b1c0: 6368 6563 6b5f 6964 6c65 2873 656c 6629  check_idle(self)
-0004b1d0: 202d 3e20 666c 6f61 7420 7c20 4e6f 6e65   -> float | None
-0004b1e0: 3a0a 2020 2020 2020 2020 6966 2073 656c  :.        if sel
-0004b1f0: 662e 7374 6174 7573 2069 6e20 2853 7461  f.status in (Sta
-0004b200: 7475 732e 636c 6f73 696e 672c 2053 7461  tus.closing, Sta
-0004b210: 7475 732e 636c 6f73 6564 293a 0a20 2020  tus.closed):.   
-0004b220: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0004b230: 4e6f 6e65 2020 2320 7072 6167 6d61 3a20  None  # pragma: 
-0004b240: 6e6f 636f 7665 720a 0a20 2020 2020 2020  nocover..       
-0004b250: 2069 6620 7365 6c66 2e74 7261 6e73 6974   if self.transit
-0004b260: 696f 6e5f 636f 756e 7465 7220 213d 2073  ion_counter != s
-0004b270: 656c 662e 5f69 646c 655f 7472 616e 7369  elf._idle_transi
-0004b280: 7469 6f6e 5f63 6f75 6e74 6572 3a0a 2020  tion_counter:.  
-0004b290: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-0004b2a0: 6964 6c65 5f74 7261 6e73 6974 696f 6e5f  idle_transition_
-0004b2b0: 636f 756e 7465 7220 3d20 7365 6c66 2e74  counter = self.t
-0004b2c0: 7261 6e73 6974 696f 6e5f 636f 756e 7465  ransition_counte
-0004b2d0: 720a 2020 2020 2020 2020 2020 2020 7365  r.            se
-0004b2e0: 6c66 2e69 646c 655f 7369 6e63 6520 3d20  lf.idle_since = 
-0004b2f0: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-0004b300: 2072 6574 7572 6e20 4e6f 6e65 0a0a 2020   return None..  
-0004b310: 2020 2020 2020 6966 2028 0a20 2020 2020        if (.     
-0004b320: 2020 2020 2020 2073 656c 662e 7175 6575         self.queu
-0004b330: 6564 0a20 2020 2020 2020 2020 2020 206f  ed.            o
-0004b340: 7220 7365 6c66 2e75 6e72 756e 6e61 626c  r self.unrunnabl
-0004b350: 650a 2020 2020 2020 2020 2020 2020 6f72  e.            or
-0004b360: 2061 6e79 2877 732e 7072 6f63 6573 7369   any(ws.processi
-0004b370: 6e67 2066 6f72 2077 7320 696e 2073 656c  ng for ws in sel
-0004b380: 662e 776f 726b 6572 732e 7661 6c75 6573  f.workers.values
-0004b390: 2829 290a 2020 2020 2020 2020 293a 0a20  ()).        ):. 
-0004b3a0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0004b3b0: 6964 6c65 5f73 696e 6365 203d 204e 6f6e  idle_since = Non
-0004b3c0: 650a 2020 2020 2020 2020 2020 2020 7265  e.            re
-0004b3d0: 7475 726e 204e 6f6e 650a 0a20 2020 2020  turn None..     
-0004b3e0: 2020 2069 6620 6e6f 7420 7365 6c66 2e69     if not self.i
-0004b3f0: 646c 655f 7369 6e63 653a 0a20 2020 2020  dle_since:.     
-0004b400: 2020 2020 2020 2073 656c 662e 6964 6c65         self.idle
-0004b410: 5f73 696e 6365 203d 2074 696d 6528 290a  _since = time().
-0004b420: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0004b430: 726e 2073 656c 662e 6964 6c65 5f73 696e  rn self.idle_sin
-0004b440: 6365 0a0a 2020 2020 2020 2020 6966 2073  ce..        if s
-0004b450: 656c 662e 6a75 7079 7465 723a 0a20 2020  elf.jupyter:.   
-0004b460: 2020 2020 2020 2020 206c 6173 745f 6163           last_ac
-0004b470: 7469 7669 7479 203d 2028 0a20 2020 2020  tivity = (.     
-0004b480: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0004b490: 5f6a 7570 7974 6572 5f73 6572 7665 725f  _jupyter_server_
-0004b4a0: 6170 706c 6963 6174 696f 6e2e 7765 625f  application.web_
-0004b4b0: 6170 702e 6c61 7374 5f61 6374 6976 6974  app.last_activit
-0004b4c0: 7928 292e 7469 6d65 7374 616d 7028 290a  y().timestamp().
-0004b4d0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0004b4e0: 2020 2020 2020 2020 2020 6966 206c 6173            if las
-0004b4f0: 745f 6163 7469 7669 7479 203e 2073 656c  t_activity > sel
-0004b500: 662e 6964 6c65 5f73 696e 6365 3a0a 2020  f.idle_since:.  
-0004b510: 2020 2020 2020 2020 2020 2020 2020 7365                se
-0004b520: 6c66 2e69 646c 655f 7369 6e63 6520 3d20  lf.idle_since = 
-0004b530: 6c61 7374 5f61 6374 6976 6974 790a 2020  last_activity.  
-0004b540: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0004b550: 7475 726e 2073 656c 662e 6964 6c65 5f73  turn self.idle_s
-0004b560: 696e 6365 0a0a 2020 2020 2020 2020 6966  ince..        if
-0004b570: 2073 656c 662e 6964 6c65 5f74 696d 656f   self.idle_timeo
-0004b580: 7574 3a0a 2020 2020 2020 2020 2020 2020  ut:.            
-0004b590: 6966 2074 696d 6528 2920 3e20 7365 6c66  if time() > self
-0004b5a0: 2e69 646c 655f 7369 6e63 6520 2b20 7365  .idle_since + se
-0004b5b0: 6c66 2e69 646c 655f 7469 6d65 6f75 743a  lf.idle_timeout:
-0004b5c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004b5d0: 2061 7373 6572 7420 7365 6c66 2e69 646c   assert self.idl
-0004b5e0: 655f 7369 6e63 650a 2020 2020 2020 2020  e_since.        
-0004b5f0: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
-0004b600: 6e66 6f28 0a20 2020 2020 2020 2020 2020  nfo(.           
-0004b610: 2020 2020 2020 2020 2022 5363 6865 6475           "Schedu
-0004b620: 6c65 7220 636c 6f73 696e 6720 6166 7465  ler closing afte
-0004b630: 7220 6265 696e 6720 6964 6c65 2066 6f72  r being idle for
-0004b640: 2025 7322 2c0a 2020 2020 2020 2020 2020   %s",.          
-0004b650: 2020 2020 2020 2020 2020 666f 726d 6174            format
-0004b660: 5f74 696d 6528 7365 6c66 2e69 646c 655f  _time(self.idle_
-0004b670: 7469 6d65 6f75 7429 2c0a 2020 2020 2020  timeout),.      
-0004b680: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0004b690: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0004b6a0: 2e5f 6f6e 676f 696e 675f 6261 636b 6772  ._ongoing_backgr
-0004b6b0: 6f75 6e64 5f74 6173 6b73 2e63 616c 6c5f  ound_tasks.call_
-0004b6c0: 736f 6f6e 2873 656c 662e 636c 6f73 6529  soon(self.close)
-0004b6d0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0004b6e0: 7365 6c66 2e69 646c 655f 7369 6e63 650a  self.idle_since.
-0004b6f0: 0a20 2020 2064 6566 205f 6368 6563 6b5f  .    def _check_
-0004b700: 6e6f 5f77 6f72 6b65 7273 2873 656c 6629  no_workers(self)
-0004b710: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-0004b720: 2020 2222 2253 6875 7420 646f 776e 2074    """Shut down t
-0004b730: 6865 2073 6368 6564 756c 6572 2069 6620  he scheduler if 
-0004b740: 7468 6572 6520 6861 7665 2062 6565 6e20  there have been 
-0004b750: 7461 736b 7320 7265 6164 7920 746f 2072  tasks ready to r
-0004b760: 756e 2077 6869 6368 2068 6176 650a 2020  un which have.  
-0004b770: 2020 2020 2020 6e6f 7768 6572 6520 746f        nowhere to
-0004b780: 2072 756e 2066 6f72 2060 6469 7374 7269   run for `distri
-0004b790: 6275 7465 642e 7363 6865 6475 6c65 722e  buted.scheduler.
-0004b7a0: 6e6f 2d77 6f72 6b65 7273 2d74 696d 656f  no-workers-timeo
-0004b7b0: 7574 602c 2061 6e64 2074 6865 7265 0a20  ut`, and there. 
-0004b7c0: 2020 2020 2020 2061 7265 6e27 7420 6f74         aren't ot
-0004b7d0: 6865 7220 7461 736b 7320 7275 6e6e 696e  her tasks runnin
-0004b7e0: 672e 0a20 2020 2020 2020 2022 2222 0a20  g..        """. 
-0004b7f0: 2020 2020 2020 2069 6620 7365 6c66 2e73         if self.s
-0004b800: 7461 7475 7320 696e 2028 5374 6174 7573  tatus in (Status
-0004b810: 2e63 6c6f 7369 6e67 2c20 5374 6174 7573  .closing, Status
-0004b820: 2e63 6c6f 7365 6429 3a0a 2020 2020 2020  .closed):.      
-0004b830: 2020 2020 2020 7265 7475 726e 2020 2320        return  # 
-0004b840: 7072 6167 6d61 3a20 6e6f 636f 7665 720a  pragma: nocover.
-0004b850: 0a20 2020 2020 2020 2069 6620 280a 2020  .        if (.  
-0004b860: 2020 2020 2020 2020 2020 286e 6f74 2073            (not s
-0004b870: 656c 662e 7175 6575 6564 2061 6e64 206e  elf.queued and n
-0004b880: 6f74 2073 656c 662e 756e 7275 6e6e 6162  ot self.unrunnab
-0004b890: 6c65 290a 2020 2020 2020 2020 2020 2020  le).            
-0004b8a0: 6f72 2028 7365 6c66 2e71 7565 7565 6420  or (self.queued 
-0004b8b0: 616e 6420 7365 6c66 2e77 6f72 6b65 7273  and self.workers
-0004b8c0: 290a 2020 2020 2020 2020 2020 2020 6f72  ).            or
-0004b8d0: 2061 6e79 2877 732e 7072 6f63 6573 7369   any(ws.processi
-0004b8e0: 6e67 2066 6f72 2077 7320 696e 2073 656c  ng for ws in sel
-0004b8f0: 662e 776f 726b 6572 732e 7661 6c75 6573  f.workers.values
-0004b900: 2829 290a 2020 2020 2020 2020 293a 0a20  ()).        ):. 
-0004b910: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0004b920: 5f6e 6f5f 776f 726b 6572 735f 7369 6e63  _no_workers_sinc
-0004b930: 6520 3d20 4e6f 6e65 0a20 2020 2020 2020  e = None.       
-0004b940: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
-0004b950: 2020 2020 2023 2031 2e20 5468 6572 6520       # 1. There 
-0004b960: 6172 6520 7175 6575 6564 206f 7220 756e  are queued or un
-0004b970: 7275 6e6e 6162 6c65 2074 6173 6b73 2061  runnable tasks a
-0004b980: 6e64 206e 6f20 776f 726b 6572 7320 6174  nd no workers at
-0004b990: 2061 6c6c 0a20 2020 2020 2020 2023 2032   all.        # 2
-0004b9a0: 2e20 5468 6572 6520 6172 6520 756e 7275  . There are unru
-0004b9b0: 6e6e 6162 6c65 2074 6173 6b73 2061 6e64  nnable tasks and
-0004b9c0: 206e 6f20 776f 726b 6572 7320 7361 7469   no workers sati
-0004b9d0: 7366 7920 7468 6569 7220 7265 7374 7269  sfy their restri
-0004b9e0: 6374 696f 6e73 0a20 2020 2020 2020 2023  ctions.        #
-0004b9f0: 2028 4f6e 6c79 2072 6f6f 7469 7368 2074   (Only rootish t
-0004ba00: 6173 6b73 2063 616e 2062 6520 7175 6575  asks can be queu
-0004ba10: 6564 2c20 616e 6420 726f 6f74 6973 6820  ed, and rootish 
-0004ba20: 7461 736b 7320 6361 6e27 7420 6861 7665  tasks can't have
-0004ba30: 2072 6573 7472 6963 7469 6f6e 7329 0a0a   restrictions)..
-0004ba40: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
-0004ba50: 656c 662e 5f6e 6f5f 776f 726b 6572 735f  elf._no_workers_
-0004ba60: 7369 6e63 653a 0a20 2020 2020 2020 2020  since:.         
-0004ba70: 2020 2073 656c 662e 5f6e 6f5f 776f 726b     self._no_work
-0004ba80: 6572 735f 7369 6e63 6520 3d20 7469 6d65  ers_since = time
-0004ba90: 2829 0a20 2020 2020 2020 2020 2020 2072  ().            r
-0004baa0: 6574 7572 6e0a 0a20 2020 2020 2020 2069  eturn..        i
-0004bab0: 6620 280a 2020 2020 2020 2020 2020 2020  f (.            
-0004bac0: 7365 6c66 2e6e 6f5f 776f 726b 6572 735f  self.no_workers_
-0004bad0: 7469 6d65 6f75 740a 2020 2020 2020 2020  timeout.        
-0004bae0: 2020 2020 616e 6420 7469 6d65 2829 203e      and time() >
-0004baf0: 2073 656c 662e 5f6e 6f5f 776f 726b 6572   self._no_worker
-0004bb00: 735f 7369 6e63 6520 2b20 7365 6c66 2e6e  s_since + self.n
-0004bb10: 6f5f 776f 726b 6572 735f 7469 6d65 6f75  o_workers_timeou
-0004bb20: 740a 2020 2020 2020 2020 293a 0a20 2020  t.        ):.   
-0004bb30: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-0004bb40: 696e 666f 280a 2020 2020 2020 2020 2020  info(.          
-0004bb50: 2020 2020 2020 2254 6173 6b73 2068 6176        "Tasks hav
-0004bb60: 6520 6265 656e 2077 6974 686f 7574 2061  e been without a
-0004bb70: 6e79 2077 6f72 6b65 7273 2074 6f20 7275  ny workers to ru
-0004bb80: 6e20 7468 656d 2066 6f72 2025 733b 2022  n them for %s; "
-0004bb90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004bba0: 2022 7368 7574 7469 6e67 2073 6368 6564   "shutting sched
-0004bbb0: 756c 6572 2064 6f77 6e22 2c0a 2020 2020  uler down",.    
-0004bbc0: 2020 2020 2020 2020 2020 2020 666f 726d              form
-0004bbd0: 6174 5f74 696d 6528 7365 6c66 2e6e 6f5f  at_time(self.no_
-0004bbe0: 776f 726b 6572 735f 7469 6d65 6f75 7429  workers_timeout)
-0004bbf0: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
-0004bc00: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0004bc10: 2e5f 6f6e 676f 696e 675f 6261 636b 6772  ._ongoing_backgr
-0004bc20: 6f75 6e64 5f74 6173 6b73 2e63 616c 6c5f  ound_tasks.call_
-0004bc30: 736f 6f6e 2873 656c 662e 636c 6f73 6529  soon(self.close)
-0004bc40: 0a0a 2020 2020 6465 6620 6164 6170 7469  ..    def adapti
-0004bc50: 7665 5f74 6172 6765 7428 7365 6c66 2c20  ve_target(self, 
-0004bc60: 7461 7267 6574 5f64 7572 6174 696f 6e3d  target_duration=
-0004bc70: 4e6f 6e65 293a 0a20 2020 2020 2020 2022  None):.        "
-0004bc80: 2222 4465 7369 7265 6420 6e75 6d62 6572  ""Desired number
-0004bc90: 206f 6620 776f 726b 6572 7320 6261 7365   of workers base
-0004bca0: 6420 6f6e 2074 6865 2063 7572 7265 6e74  d on the current
-0004bcb0: 2077 6f72 6b6c 6f61 640a 0a20 2020 2020   workload..     
-0004bcc0: 2020 2054 6869 7320 6c6f 6f6b 7320 6174     This looks at
-0004bcd0: 2074 6865 2063 7572 7265 6e74 2072 756e   the current run
-0004bce0: 6e69 6e67 2074 6173 6b73 2061 6e64 206d  ning tasks and m
-0004bcf0: 656d 6f72 7920 7573 652c 2061 6e64 2072  emory use, and r
-0004bd00: 6574 7572 6e73 2061 0a20 2020 2020 2020  eturns a.       
-0004bd10: 206e 756d 6265 7220 6f66 2064 6573 6972   number of desir
-0004bd20: 6564 2077 6f72 6b65 7273 2e20 2054 6869  ed workers.  Thi
-0004bd30: 7320 6973 206f 6674 656e 2075 7365 6420  s is often used 
-0004bd40: 6279 2061 6461 7074 6976 6520 7363 6865  by adaptive sche
-0004bd50: 6475 6c69 6e67 2e0a 0a20 2020 2020 2020  duling...       
-0004bd60: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
-0004bd70: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
-0004bd80: 2020 2020 2020 2074 6172 6765 745f 6475         target_du
-0004bd90: 7261 7469 6f6e 203a 2073 7472 0a20 2020  ration : str.   
-0004bda0: 2020 2020 2020 2020 2041 2064 6573 6972           A desir
-0004bdb0: 6564 2064 7572 6174 696f 6e20 6f66 2074  ed duration of t
-0004bdc0: 696d 6520 666f 7220 636f 6d70 7574 6174  ime for computat
-0004bdd0: 696f 6e73 2074 6f20 7461 6b65 2e20 2054  ions to take.  T
-0004bde0: 6869 7320 6166 6665 6374 730a 2020 2020  his affects.    
-0004bdf0: 2020 2020 2020 2020 686f 7720 7261 7069          how rapi
-0004be00: 646c 7920 7468 6520 7363 6865 6475 6c65  dly the schedule
-0004be10: 7220 7769 6c6c 2061 736b 2074 6f20 7363  r will ask to sc
-0004be20: 616c 652e 0a0a 2020 2020 2020 2020 5365  ale...        Se
-0004be30: 6520 416c 736f 0a20 2020 2020 2020 202d  e Also.        -
-0004be40: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
-0004be50: 6469 7374 7269 6275 7465 642e 6465 706c  distributed.depl
-0004be60: 6f79 2e41 6461 7074 6976 650a 2020 2020  oy.Adaptive.    
-0004be70: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0004be80: 6966 2074 6172 6765 745f 6475 7261 7469  if target_durati
-0004be90: 6f6e 2069 7320 4e6f 6e65 3a0a 2020 2020  on is None:.    
-0004bea0: 2020 2020 2020 2020 7461 7267 6574 5f64          target_d
-0004beb0: 7572 6174 696f 6e20 3d20 6461 736b 2e63  uration = dask.c
-0004bec0: 6f6e 6669 672e 6765 7428 2264 6973 7472  onfig.get("distr
-0004bed0: 6962 7574 6564 2e61 6461 7074 6976 652e  ibuted.adaptive.
-0004bee0: 7461 7267 6574 2d64 7572 6174 696f 6e22  target-duration"
-0004bef0: 290a 2020 2020 2020 2020 7461 7267 6574  ).        target
-0004bf00: 5f64 7572 6174 696f 6e20 3d20 7061 7273  _duration = pars
-0004bf10: 655f 7469 6d65 6465 6c74 6128 7461 7267  e_timedelta(targ
-0004bf20: 6574 5f64 7572 6174 696f 6e29 0a0a 2020  et_duration)..  
-0004bf30: 2020 2020 2020 2320 4350 550a 2020 2020        # CPU.    
-0004bf40: 2020 2020 7175 6575 6564 203d 2074 616b      queued = tak
-0004bf50: 6528 3130 302c 2063 6f6e 6361 7428 5b73  e(100, concat([s
-0004bf60: 656c 662e 7175 6575 6564 2c20 7365 6c66  elf.queued, self
-0004bf70: 2e75 6e72 756e 6e61 626c 655d 2929 0a20  .unrunnable])). 
-0004bf80: 2020 2020 2020 2071 7565 7565 645f 6f63         queued_oc
-0004bf90: 6375 7061 6e63 7920 3d20 300a 2020 2020  cupancy = 0.    
-0004bfa0: 2020 2020 666f 7220 7473 2069 6e20 7175      for ts in qu
-0004bfb0: 6575 6564 3a0a 2020 2020 2020 2020 2020  eued:.          
-0004bfc0: 2020 6966 2074 732e 7072 6566 6978 2e64    if ts.prefix.d
-0004bfd0: 7572 6174 696f 6e5f 6176 6572 6167 6520  uration_average 
-0004bfe0: 3d3d 202d 313a 0a20 2020 2020 2020 2020  == -1:.         
-0004bff0: 2020 2020 2020 2071 7565 7565 645f 6f63         queued_oc
-0004c000: 6375 7061 6e63 7920 2b3d 2073 656c 662e  cupancy += self.
-0004c010: 554e 4b4e 4f57 4e5f 5441 534b 5f44 5552  UNKNOWN_TASK_DUR
-0004c020: 4154 494f 4e0a 2020 2020 2020 2020 2020  ATION.          
-0004c030: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0004c040: 2020 2020 2020 2020 7175 6575 6564 5f6f          queued_o
-0004c050: 6363 7570 616e 6379 202b 3d20 7473 2e70  ccupancy += ts.p
-0004c060: 7265 6669 782e 6475 7261 7469 6f6e 5f61  refix.duration_a
-0004c070: 7665 7261 6765 0a0a 2020 2020 2020 2020  verage..        
-0004c080: 7461 736b 735f 7265 6164 7920 3d20 6c65  tasks_ready = le
-0004c090: 6e28 7365 6c66 2e71 7565 7565 6429 202b  n(self.queued) +
-0004c0a0: 206c 656e 2873 656c 662e 756e 7275 6e6e   len(self.unrunn
-0004c0b0: 6162 6c65 290a 2020 2020 2020 2020 6966  able).        if
-0004c0c0: 2074 6173 6b73 5f72 6561 6479 203e 2031   tasks_ready > 1
-0004c0d0: 3030 3a0a 2020 2020 2020 2020 2020 2020  00:.            
-0004c0e0: 7175 6575 6564 5f6f 6363 7570 616e 6379  queued_occupancy
-0004c0f0: 202a 3d20 7461 736b 735f 7265 6164 7920   *= tasks_ready 
-0004c100: 2f20 3130 300a 0a20 2020 2020 2020 2063  / 100..        c
-0004c110: 7075 203d 206d 6174 682e 6365 696c 2828  pu = math.ceil((
-0004c120: 7365 6c66 2e74 6f74 616c 5f6f 6363 7570  self.total_occup
-0004c130: 616e 6379 202b 2071 7565 7565 645f 6f63  ancy + queued_oc
-0004c140: 6375 7061 6e63 7929 202f 2074 6172 6765  cupancy) / targe
-0004c150: 745f 6475 7261 7469 6f6e 290a 0a20 2020  t_duration)..   
-0004c160: 2020 2020 2023 2041 766f 6964 2061 2066       # Avoid a f
-0004c170: 6577 206c 6f6e 6720 7461 736b 7320 6672  ew long tasks fr
-0004c180: 6f6d 2061 736b 696e 6720 666f 7220 6d61  om asking for ma
-0004c190: 6e79 2063 6f72 6573 0a20 2020 2020 2020  ny cores.       
-0004c1a0: 2066 6f72 2077 7320 696e 2073 656c 662e   for ws in self.
-0004c1b0: 776f 726b 6572 732e 7661 6c75 6573 2829  workers.values()
-0004c1c0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-0004c1d0: 2074 6173 6b73 5f72 6561 6479 203e 2063   tasks_ready > c
-0004c1e0: 7075 3a0a 2020 2020 2020 2020 2020 2020  pu:.            
-0004c1f0: 2020 2020 6272 6561 6b0a 2020 2020 2020      break.      
-0004c200: 2020 2020 2020 7461 736b 735f 7265 6164        tasks_read
-0004c210: 7920 2b3d 206c 656e 2877 732e 7072 6f63  y += len(ws.proc
-0004c220: 6573 7369 6e67 290a 2020 2020 2020 2020  essing).        
-0004c230: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0004c240: 2020 6370 7520 3d20 6d69 6e28 7461 736b    cpu = min(task
-0004c250: 735f 7265 6164 792c 2063 7075 290a 0a20  s_ready, cpu).. 
-0004c260: 2020 2020 2020 2023 2044 6976 6964 6520         # Divide 
-0004c270: 6279 2061 7665 7261 6765 206e 7468 7265  by average nthre
-0004c280: 6164 7320 7065 7220 776f 726b 6572 0a20  ads per worker. 
-0004c290: 2020 2020 2020 2069 6620 7365 6c66 2e77         if self.w
-0004c2a0: 6f72 6b65 7273 3a0a 2020 2020 2020 2020  orkers:.        
-0004c2b0: 2020 2020 6e74 6872 6561 6473 203d 2073      nthreads = s
-0004c2c0: 756d 2877 732e 6e74 6872 6561 6473 2066  um(ws.nthreads f
-0004c2d0: 6f72 2077 7320 696e 2073 656c 662e 776f  or ws in self.wo
-0004c2e0: 726b 6572 732e 7661 6c75 6573 2829 290a  rkers.values()).
-0004c2f0: 2020 2020 2020 2020 2020 2020 6370 7520              cpu 
-0004c300: 3d20 6d61 7468 2e63 6569 6c28 6370 7520  = math.ceil(cpu 
-0004c310: 2f20 6e74 6872 6561 6473 202a 206c 656e  / nthreads * len
-0004c320: 2873 656c 662e 776f 726b 6572 7329 290a  (self.workers)).
-0004c330: 0a20 2020 2020 2020 2069 6620 2873 656c  .        if (sel
-0004c340: 662e 756e 7275 6e6e 6162 6c65 206f 7220  f.unrunnable or 
-0004c350: 7365 6c66 2e71 7565 7565 6429 2061 6e64  self.queued) and
-0004c360: 206e 6f74 2073 656c 662e 776f 726b 6572   not self.worker
-0004c370: 733a 0a20 2020 2020 2020 2020 2020 2063  s:.            c
-0004c380: 7075 203d 206d 6178 2831 2c20 6370 7529  pu = max(1, cpu)
-0004c390: 0a0a 2020 2020 2020 2020 2320 6164 6420  ..        # add 
-0004c3a0: 6d6f 7265 2077 6f72 6b65 7273 2069 6620  more workers if 
-0004c3b0: 6d6f 7265 2074 6861 6e20 3630 2520 6f66  more than 60% of
-0004c3c0: 206d 656d 6f72 7920 6973 2075 7365 640a   memory is used.
-0004c3d0: 2020 2020 2020 2020 6c69 6d69 7420 3d20          limit = 
-0004c3e0: 7375 6d28 7773 2e6d 656d 6f72 795f 6c69  sum(ws.memory_li
-0004c3f0: 6d69 7420 666f 7220 7773 2069 6e20 7365  mit for ws in se
-0004c400: 6c66 2e77 6f72 6b65 7273 2e76 616c 7565  lf.workers.value
-0004c410: 7328 2929 0a20 2020 2020 2020 2075 7365  s()).        use
-0004c420: 6420 3d20 7375 6d28 7773 2e6e 6279 7465  d = sum(ws.nbyte
-0004c430: 7320 666f 7220 7773 2069 6e20 7365 6c66  s for ws in self
-0004c440: 2e77 6f72 6b65 7273 2e76 616c 7565 7328  .workers.values(
-0004c450: 2929 0a20 2020 2020 2020 206d 656d 6f72  )).        memor
-0004c460: 7920 3d20 300a 2020 2020 2020 2020 6966  y = 0.        if
-0004c470: 2075 7365 6420 3e20 302e 3620 2a20 6c69   used > 0.6 * li
-0004c480: 6d69 7420 616e 6420 6c69 6d69 7420 3e20  mit and limit > 
-0004c490: 303a 0a20 2020 2020 2020 2020 2020 206d  0:.            m
-0004c4a0: 656d 6f72 7920 3d20 3220 2a20 6c65 6e28  emory = 2 * len(
-0004c4b0: 7365 6c66 2e77 6f72 6b65 7273 290a 0a20  self.workers).. 
-0004c4c0: 2020 2020 2020 2074 6172 6765 7420 3d20         target = 
-0004c4d0: 6d61 7828 6d65 6d6f 7279 2c20 6370 7529  max(memory, cpu)
-0004c4e0: 0a20 2020 2020 2020 2069 6620 7461 7267  .        if targ
-0004c4f0: 6574 203e 3d20 6c65 6e28 7365 6c66 2e77  et >= len(self.w
-0004c500: 6f72 6b65 7273 293a 0a20 2020 2020 2020  orkers):.       
-0004c510: 2020 2020 2072 6574 7572 6e20 7461 7267       return targ
-0004c520: 6574 0a20 2020 2020 2020 2065 6c73 653a  et.        else:
-0004c530: 2020 2320 5363 616c 6520 646f 776e 3f0a    # Scale down?.
-0004c540: 2020 2020 2020 2020 2020 2020 746f 5f63              to_c
-0004c550: 6c6f 7365 203d 2073 656c 662e 776f 726b  lose = self.work
-0004c560: 6572 735f 746f 5f63 6c6f 7365 2829 0a20  ers_to_close(). 
-0004c570: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0004c580: 6e20 6c65 6e28 7365 6c66 2e77 6f72 6b65  n len(self.worke
-0004c590: 7273 2920 2d20 6c65 6e28 746f 5f63 6c6f  rs) - len(to_clo
-0004c5a0: 7365 290a 0a20 2020 2064 6566 2072 6571  se)..    def req
-0004c5b0: 7565 7374 5f61 6371 7569 7265 5f72 6570  uest_acquire_rep
-0004c5c0: 6c69 6361 7328 0a20 2020 2020 2020 2073  licas(.        s
-0004c5d0: 656c 662c 2061 6464 723a 2073 7472 2c20  elf, addr: str, 
-0004c5e0: 6b65 7973 3a20 4974 6572 6162 6c65 5b4b  keys: Iterable[K
-0004c5f0: 6579 5d2c 202a 2c20 7374 696d 756c 7573  ey], *, stimulus
-0004c600: 5f69 643a 2073 7472 0a20 2020 2029 202d  _id: str.    ) -
-0004c610: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-0004c620: 2222 2241 7379 6e63 6872 6f6e 6f75 736c  """Asynchronousl
-0004c630: 7920 6173 6b20 6120 776f 726b 6572 2074  y ask a worker t
-0004c640: 6f20 6163 7175 6972 6520 6120 7265 706c  o acquire a repl
-0004c650: 6963 6120 6f66 2074 6865 206c 6973 7465  ica of the liste
-0004c660: 6420 6b65 7973 2066 726f 6d0a 2020 2020  d keys from.    
-0004c670: 2020 2020 6f74 6865 7220 776f 726b 6572      other worker
-0004c680: 732e 2054 6869 7320 6973 2061 2066 6972  s. This is a fir
-0004c690: 652d 616e 642d 666f 7267 6574 206f 7065  e-and-forget ope
-0004c6a0: 7261 7469 6f6e 2077 6869 6368 206f 6666  ration which off
-0004c6b0: 6572 7320 6e6f 2066 6565 6462 6163 6b20  ers no feedback 
-0004c6c0: 666f 720a 2020 2020 2020 2020 7375 6363  for.        succ
-0004c6d0: 6573 7320 6f72 2066 6169 6c75 7265 2c20  ess or failure, 
-0004c6e0: 616e 6420 6973 2069 6e74 656e 6465 6420  and is intended 
-0004c6f0: 666f 7220 686f 7573 656b 6565 7069 6e67  for housekeeping
-0004c700: 2061 6e64 206e 6f74 2066 6f72 2063 6f6d   and not for com
-0004c710: 7075 7461 7469 6f6e 2e0a 2020 2020 2020  putation..      
-0004c720: 2020 2222 220a 2020 2020 2020 2020 7768    """.        wh
-0004c730: 6f5f 6861 7320 3d20 7b7d 0a20 2020 2020  o_has = {}.     
-0004c740: 2020 206e 6279 7465 7320 3d20 7b7d 0a20     nbytes = {}. 
-0004c750: 2020 2020 2020 2066 6f72 206b 6579 2069         for key i
-0004c760: 6e20 6b65 7973 3a0a 2020 2020 2020 2020  n keys:.        
-0004c770: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
-0004c780: 736b 735b 6b65 795d 0a20 2020 2020 2020  sks[key].       
-0004c790: 2020 2020 2061 7373 6572 7420 7473 2e77       assert ts.w
-0004c7a0: 686f 5f68 6173 0a20 2020 2020 2020 2020  ho_has.         
-0004c7b0: 2020 2077 686f 5f68 6173 5b6b 6579 5d20     who_has[key] 
-0004c7c0: 3d20 5b77 732e 6164 6472 6573 7320 666f  = [ws.address fo
-0004c7d0: 7220 7773 2069 6e20 7473 2e77 686f 5f68  r ws in ts.who_h
-0004c7e0: 6173 206f 7220 2829 5d0a 2020 2020 2020  as or ()].      
-0004c7f0: 2020 2020 2020 6e62 7974 6573 5b6b 6579        nbytes[key
-0004c800: 5d20 3d20 7473 2e6e 6279 7465 730a 0a20  ] = ts.nbytes.. 
-0004c810: 2020 2020 2020 2073 656c 662e 7374 7265         self.stre
-0004c820: 616d 5f63 6f6d 6d73 5b61 6464 725d 2e73  am_comms[addr].s
-0004c830: 656e 6428 0a20 2020 2020 2020 2020 2020  end(.           
-0004c840: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0004c850: 2020 2022 6f70 223a 2022 6163 7175 6972     "op": "acquir
-0004c860: 652d 7265 706c 6963 6173 222c 0a20 2020  e-replicas",.   
-0004c870: 2020 2020 2020 2020 2020 2020 2022 7768               "wh
-0004c880: 6f5f 6861 7322 3a20 7768 6f5f 6861 732c  o_has": who_has,
-0004c890: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004c8a0: 2022 6e62 7974 6573 223a 206e 6279 7465   "nbytes": nbyte
-0004c8b0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-0004c8c0: 2020 2022 7374 696d 756c 7573 5f69 6422     "stimulus_id"
-0004c8d0: 3a20 7374 696d 756c 7573 5f69 642c 0a20  : stimulus_id,. 
-0004c8e0: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
-0004c8f0: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
-0004c900: 2072 6571 7565 7374 5f72 656d 6f76 655f   request_remove_
-0004c910: 7265 706c 6963 6173 280a 2020 2020 2020  replicas(.      
-0004c920: 2020 7365 6c66 2c20 6164 6472 3a20 7374    self, addr: st
-0004c930: 722c 206b 6579 733a 206c 6973 745b 4b65  r, keys: list[Ke
-0004c940: 795d 2c20 2a2c 2073 7469 6d75 6c75 735f  y], *, stimulus_
-0004c950: 6964 3a20 7374 720a 2020 2020 2920 2d3e  id: str.    ) ->
-0004c960: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
-0004c970: 2222 4173 796e 6368 726f 6e6f 7573 6c79  ""Asynchronously
-0004c980: 2061 736b 2061 2077 6f72 6b65 7220 746f   ask a worker to
-0004c990: 2064 6973 6361 7264 2069 7473 2072 6570   discard its rep
-0004c9a0: 6c69 6361 206f 6620 7468 6520 6c69 7374  lica of the list
-0004c9b0: 6564 206b 6579 732e 0a20 2020 2020 2020  ed keys..       
-0004c9c0: 2054 6869 7320 6d75 7374 206e 6576 6572   This must never
-0004c9d0: 2062 6520 7573 6564 2074 6f20 6465 7374   be used to dest
-0004c9e0: 726f 7920 7468 6520 6c61 7374 2072 6570  roy the last rep
-0004c9f0: 6c69 6361 206f 6620 6120 6b65 792e 2054  lica of a key. T
-0004ca00: 6869 7320 6973 2061 0a20 2020 2020 2020  his is a.       
-0004ca10: 2066 6972 652d 616e 642d 666f 7267 6574   fire-and-forget
-0004ca20: 206f 7065 7261 7469 6f6e 2c20 696e 7465   operation, inte
-0004ca30: 6e64 6564 2066 6f72 2068 6f75 7365 6b65  nded for houseke
-0004ca40: 6570 696e 6720 616e 6420 6e6f 7420 666f  eping and not fo
-0004ca50: 7220 636f 6d70 7574 6174 696f 6e2e 0a0a  r computation...
-0004ca60: 2020 2020 2020 2020 5468 6520 7265 706c          The repl
-0004ca70: 6963 6120 6469 7361 7070 6561 7273 2069  ica disappears i
-0004ca80: 6d6d 6564 6961 7465 6c79 2066 726f 6d20  mmediately from 
-0004ca90: 5461 736b 5374 6174 652e 7768 6f5f 6861  TaskState.who_ha
-0004caa0: 7320 6f6e 2074 6865 2053 6368 6564 756c  s on the Schedul
-0004cab0: 6572 2073 6964 653b 0a20 2020 2020 2020  er side;.       
-0004cac0: 2069 6620 7468 6520 776f 726b 6572 2072   if the worker r
-0004cad0: 6566 7573 6573 2074 6f20 6465 6c65 7465  efuses to delete
-0004cae0: 2c20 652e 672e 2062 6563 6175 7365 2074  , e.g. because t
-0004caf0: 6865 2074 6173 6b20 6973 2061 2064 6570  he task is a dep
-0004cb00: 656e 6465 6e63 7920 6f66 0a20 2020 2020  endency of.     
-0004cb10: 2020 2061 6e6f 7468 6572 2074 6173 6b20     another task 
-0004cb20: 7275 6e6e 696e 6720 6f6e 2069 742c 2069  running on it, i
-0004cb30: 7420 7769 6c6c 2028 616c 736f 2061 7379  t will (also asy
-0004cb40: 6e63 6872 6f6e 6f75 736c 7929 2069 6e66  nchronously) inf
-0004cb50: 6f72 6d20 7468 6520 7363 6865 6475 6c65  orm the schedule
-0004cb60: 720a 2020 2020 2020 2020 746f 2072 652d  r.        to re-
-0004cb70: 6164 6420 6974 7365 6c66 2074 6f20 7768  add itself to wh
-0004cb80: 6f5f 6861 732e 2049 6620 7468 6520 776f  o_has. If the wo
-0004cb90: 726b 6572 2061 6772 6565 7320 746f 2064  rker agrees to d
-0004cba0: 6973 6361 7264 2074 6865 2074 6173 6b2c  iscard the task,
-0004cbb0: 2074 6865 7265 2069 730a 2020 2020 2020   there is.      
-0004cbc0: 2020 6e6f 2066 6565 6462 6163 6b2e 0a20    no feedback.. 
-0004cbd0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0004cbe0: 2020 2077 7320 3d20 7365 6c66 2e77 6f72     ws = self.wor
-0004cbf0: 6b65 7273 5b61 6464 725d 0a0a 2020 2020  kers[addr]..    
-0004cc00: 2020 2020 2320 5468 6520 7363 6865 6475      # The schedu
-0004cc10: 6c65 7220 696d 6d65 6469 6174 656c 7920  ler immediately 
-0004cc20: 666f 7267 6574 7320 6162 6f75 7420 7468  forgets about th
-0004cc30: 6520 7265 706c 6963 6120 616e 6420 7375  e replica and su
-0004cc40: 6767 6573 7473 2074 6865 2077 6f72 6b65  ggests the worke
-0004cc50: 7220 746f 0a20 2020 2020 2020 2023 2064  r to.        # d
-0004cc60: 726f 7020 6974 2e20 5468 6520 776f 726b  rop it. The work
-0004cc70: 6572 206d 6179 2072 6566 7573 652c 2061  er may refuse, a
-0004cc80: 7420 7768 6963 6820 706f 696e 7420 6974  t which point it
-0004cc90: 2077 696c 6c20 7365 6e64 2062 6163 6b20   will send back 
-0004cca0: 616e 2061 6464 2d6b 6579 730a 2020 2020  an add-keys.    
-0004ccb0: 2020 2020 2320 6d65 7373 6167 6520 746f      # message to
-0004ccc0: 2072 6569 6e73 7461 7465 2069 742e 0a20   reinstate it.. 
-0004ccd0: 2020 2020 2020 2066 6f72 206b 6579 2069         for key i
-0004cce0: 6e20 6b65 7973 3a0a 2020 2020 2020 2020  n keys:.        
-0004ccf0: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
-0004cd00: 736b 735b 6b65 795d 0a20 2020 2020 2020  sks[key].       
-0004cd10: 2020 2020 2069 6620 7365 6c66 2e76 616c       if self.val
-0004cd20: 6964 6174 653a 0a20 2020 2020 2020 2020  idate:.         
-0004cd30: 2020 2020 2020 2023 2044 6f20 6e6f 7420         # Do not 
-0004cd40: 6465 7374 726f 7920 7468 6520 6c61 7374  destroy the last
-0004cd50: 2063 6f70 790a 2020 2020 2020 2020 2020   copy.          
-0004cd60: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
-0004cd70: 7768 6f5f 6861 730a 2020 2020 2020 2020  who_has.        
-0004cd80: 2020 2020 2020 2020 6173 7365 7274 206c          assert l
-0004cd90: 656e 2874 732e 7768 6f5f 6861 7329 203e  en(ts.who_has) >
-0004cda0: 2031 0a20 2020 2020 2020 2020 2020 2073   1.            s
-0004cdb0: 656c 662e 7265 6d6f 7665 5f72 6570 6c69  elf.remove_repli
-0004cdc0: 6361 2874 732c 2077 7329 0a0a 2020 2020  ca(ts, ws)..    
-0004cdd0: 2020 2020 7365 6c66 2e73 7472 6561 6d5f      self.stream_
-0004cde0: 636f 6d6d 735b 6164 6472 5d2e 7365 6e64  comms[addr].send
-0004cdf0: 280a 2020 2020 2020 2020 2020 2020 7b0a  (.            {.
-0004ce00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ce10: 226f 7022 3a20 2272 656d 6f76 652d 7265  "op": "remove-re
-0004ce20: 706c 6963 6173 222c 0a20 2020 2020 2020  plicas",.       
-0004ce30: 2020 2020 2020 2020 2022 6b65 7973 223a           "keys":
-0004ce40: 206b 6579 732c 0a20 2020 2020 2020 2020   keys,.         
-0004ce50: 2020 2020 2020 2022 7374 696d 756c 7573         "stimulus
-0004ce60: 5f69 6422 3a20 7374 696d 756c 7573 5f69  _id": stimulus_i
-0004ce70: 642c 0a20 2020 2020 2020 2020 2020 207d  d,.            }
-0004ce80: 0a20 2020 2020 2020 2029 0a0a 0a64 6566  .        )...def
-0004ce90: 205f 7461 736b 5f74 6f5f 7265 706f 7274   _task_to_report
-0004cea0: 5f6d 7367 2874 733a 2054 6173 6b53 7461  _msg(ts: TaskSta
-0004ceb0: 7465 2920 2d3e 2064 6963 745b 7374 722c  te) -> dict[str,
-0004cec0: 2041 6e79 5d20 7c20 4e6f 6e65 3a0a 2020   Any] | None:.  
-0004ced0: 2020 6966 2074 732e 7374 6174 6520 3d3d    if ts.state ==
-0004cee0: 2022 666f 7267 6f74 7465 6e22 3a0a 2020   "forgotten":.  
-0004cef0: 2020 2020 2020 7265 7475 726e 207b 226f        return {"o
-0004cf00: 7022 3a20 2263 616e 6365 6c6c 6564 2d6b  p": "cancelled-k
-0004cf10: 6579 7322 2c20 226b 6579 7322 3a20 5b74  eys", "keys": [t
-0004cf20: 732e 6b65 795d 7d0a 2020 2020 656c 6966  s.key]}.    elif
-0004cf30: 2074 732e 7374 6174 6520 3d3d 2022 6d65   ts.state == "me
-0004cf40: 6d6f 7279 223a 0a20 2020 2020 2020 2072  mory":.        r
-0004cf50: 6574 7572 6e20 7b22 6f70 223a 2022 6b65  eturn {"op": "ke
-0004cf60: 792d 696e 2d6d 656d 6f72 7922 2c20 226b  y-in-memory", "k
-0004cf70: 6579 223a 2074 732e 6b65 797d 0a20 2020  ey": ts.key}.   
-0004cf80: 2065 6c69 6620 7473 2e73 7461 7465 203d   elif ts.state =
-0004cf90: 3d20 2265 7272 6564 223a 0a20 2020 2020  = "erred":.     
-0004cfa0: 2020 2066 6169 6c69 6e67 5f74 7320 3d20     failing_ts = 
-0004cfb0: 7473 2e65 7863 6570 7469 6f6e 5f62 6c61  ts.exception_bla
-0004cfc0: 6d65 0a20 2020 2020 2020 2061 7373 6572  me.        asser
-0004cfd0: 7420 6661 696c 696e 675f 7473 0a20 2020  t failing_ts.   
-0004cfe0: 2020 2020 2072 6574 7572 6e20 7b0a 2020       return {.  
-0004cff0: 2020 2020 2020 2020 2020 226f 7022 3a20            "op": 
-0004d000: 2274 6173 6b2d 6572 7265 6422 2c0a 2020  "task-erred",.  
-0004d010: 2020 2020 2020 2020 2020 226b 6579 223a            "key":
-0004d020: 2074 732e 6b65 792c 0a20 2020 2020 2020   ts.key,.       
-0004d030: 2020 2020 2022 6578 6365 7074 696f 6e22       "exception"
-0004d040: 3a20 6661 696c 696e 675f 7473 2e65 7863  : failing_ts.exc
-0004d050: 6570 7469 6f6e 2c0a 2020 2020 2020 2020  eption,.        
-0004d060: 2020 2020 2274 7261 6365 6261 636b 223a      "traceback":
-0004d070: 2066 6169 6c69 6e67 5f74 732e 7472 6163   failing_ts.trac
-0004d080: 6562 6163 6b2c 0a20 2020 2020 2020 207d  eback,.        }
-0004d090: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-0004d0a0: 2020 2072 6574 7572 6e20 4e6f 6e65 0a0a     return None..
-0004d0b0: 0a64 6566 205f 7461 736b 5f74 6f5f 636c  .def _task_to_cl
-0004d0c0: 6965 6e74 5f6d 7367 7328 7473 3a20 5461  ient_msgs(ts: Ta
-0004d0d0: 736b 5374 6174 6529 202d 3e20 4d73 6773  skState) -> Msgs
-0004d0e0: 3a0a 2020 2020 6966 2074 732e 7768 6f5f  :.    if ts.who_
-0004d0f0: 7761 6e74 733a 0a20 2020 2020 2020 2072  wants:.        r
-0004d100: 6570 6f72 745f 6d73 6720 3d20 5f74 6173  eport_msg = _tas
-0004d110: 6b5f 746f 5f72 6570 6f72 745f 6d73 6728  k_to_report_msg(
-0004d120: 7473 290a 2020 2020 2020 2020 6966 2072  ts).        if r
-0004d130: 6570 6f72 745f 6d73 6720 6973 206e 6f74  eport_msg is not
-0004d140: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-0004d150: 2020 2072 6574 7572 6e20 7b63 732e 636c     return {cs.cl
-0004d160: 6965 6e74 5f6b 6579 3a20 5b72 6570 6f72  ient_key: [repor
-0004d170: 745f 6d73 675d 2066 6f72 2063 7320 696e  t_msg] for cs in
-0004d180: 2074 732e 7768 6f5f 7761 6e74 737d 0a20   ts.who_wants}. 
-0004d190: 2020 2072 6574 7572 6e20 7b7d 0a0a 0a64     return {}...d
-0004d1a0: 6566 2064 6563 6964 655f 776f 726b 6572  ef decide_worker
-0004d1b0: 280a 2020 2020 7473 3a20 5461 736b 5374  (.    ts: TaskSt
-0004d1c0: 6174 652c 0a20 2020 2061 6c6c 5f77 6f72  ate,.    all_wor
-0004d1d0: 6b65 7273 3a20 7365 745b 576f 726b 6572  kers: set[Worker
-0004d1e0: 5374 6174 655d 2c0a 2020 2020 7661 6c69  State],.    vali
-0004d1f0: 645f 776f 726b 6572 733a 2073 6574 5b57  d_workers: set[W
-0004d200: 6f72 6b65 7253 7461 7465 5d20 7c20 4e6f  orkerState] | No
-0004d210: 6e65 2c0a 2020 2020 6f62 6a65 6374 6976  ne,.    objectiv
-0004d220: 653a 2043 616c 6c61 626c 655b 5b57 6f72  e: Callable[[Wor
-0004d230: 6b65 7253 7461 7465 5d2c 2041 6e79 5d2c  kerState], Any],
-0004d240: 0a29 202d 3e20 576f 726b 6572 5374 6174  .) -> WorkerStat
-0004d250: 6520 7c20 4e6f 6e65 3a0a 2020 2020 2222  e | None:.    ""
-0004d260: 220a 2020 2020 4465 6369 6465 2077 6869  ".    Decide whi
-0004d270: 6368 2077 6f72 6b65 7220 7368 6f75 6c64  ch worker should
-0004d280: 2074 616b 6520 7461 736b 202a 7473 2a2e   take task *ts*.
-0004d290: 0a0a 2020 2020 5765 2063 686f 6f73 6520  ..    We choose 
-0004d2a0: 7468 6520 776f 726b 6572 2074 6861 7420  the worker that 
-0004d2b0: 6861 7320 7468 6520 6461 7461 206f 6e20  has the data on 
-0004d2c0: 7768 6963 6820 2a74 732a 2064 6570 656e  which *ts* depen
-0004d2d0: 6473 2e0a 0a20 2020 2049 6620 7365 7665  ds...    If seve
-0004d2e0: 7261 6c20 776f 726b 6572 7320 6861 7665  ral workers have
-0004d2f0: 2064 6570 656e 6465 6e63 6965 7320 7468   dependencies th
-0004d300: 656e 2077 6520 6368 6f6f 7365 2074 6865  en we choose the
-0004d310: 206c 6573 732d 6275 7379 2077 6f72 6b65   less-busy worke
-0004d320: 722e 0a0a 2020 2020 4f70 7469 6f6e 616c  r...    Optional
-0004d330: 6c79 2070 726f 7669 6465 202a 7661 6c69  ly provide *vali
-0004d340: 645f 776f 726b 6572 732a 206f 6620 7768  d_workers* of wh
-0004d350: 6572 6520 6a6f 6273 2061 7265 2061 6c6c  ere jobs are all
-0004d360: 6f77 6564 2074 6f20 6f63 6375 720a 2020  owed to occur.  
-0004d370: 2020 2869 6620 616c 6c20 776f 726b 6572    (if all worker
-0004d380: 7320 6172 6520 616c 6c6f 7765 6420 746f  s are allowed to
-0004d390: 2074 616b 6520 7468 6520 7461 736b 2c20   take the task, 
-0004d3a0: 7061 7373 204e 6f6e 6520 696e 7374 6561  pass None instea
-0004d3b0: 6429 2e0a 0a20 2020 2049 6620 7468 6520  d)...    If the 
-0004d3c0: 7461 736b 2072 6571 7569 7265 7320 6461  task requires da
-0004d3d0: 7461 2063 6f6d 6d75 6e69 6361 7469 6f6e  ta communication
-0004d3e0: 2062 6563 6175 7365 206e 6f20 656c 6967   because no elig
-0004d3f0: 6962 6c65 2077 6f72 6b65 7220 6861 730a  ible worker has.
-0004d400: 2020 2020 616c 6c20 7468 6520 6465 7065      all the depe
-0004d410: 6e64 656e 6369 6573 2061 6c72 6561 6479  ndencies already
-0004d420: 2c20 7468 656e 2077 6520 6368 6f6f 7365  , then we choose
-0004d430: 2074 6f20 6d69 6e69 6d69 7a65 2074 6865   to minimize the
-0004d440: 206e 756d 6265 720a 2020 2020 6f66 2062   number.    of b
-0004d450: 7974 6573 2073 656e 7420 6265 7477 6565  ytes sent betwee
-0004d460: 6e20 776f 726b 6572 732e 2020 5468 6973  n workers.  This
-0004d470: 2069 7320 6465 7465 726d 696e 6564 2062   is determined b
-0004d480: 7920 6361 6c6c 696e 6720 7468 650a 2020  y calling the.  
-0004d490: 2020 2a6f 626a 6563 7469 7665 2a20 6675    *objective* fu
-0004d4a0: 6e63 7469 6f6e 2e0a 2020 2020 2222 220a  nction..    """.
-0004d4b0: 2020 2020 6173 7365 7274 2061 6c6c 2864      assert all(d
-0004d4c0: 7473 2e77 686f 5f68 6173 2066 6f72 2064  ts.who_has for d
-0004d4d0: 7473 2069 6e20 7473 2e64 6570 656e 6465  ts in ts.depende
-0004d4e0: 6e63 6965 7329 0a20 2020 2069 6620 7473  ncies).    if ts
-0004d4f0: 2e61 6374 6f72 3a0a 2020 2020 2020 2020  .actor:.        
-0004d500: 6361 6e64 6964 6174 6573 203d 2061 6c6c  candidates = all
-0004d510: 5f77 6f72 6b65 7273 2e63 6f70 7928 290a  _workers.copy().
-0004d520: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0004d530: 2020 6361 6e64 6964 6174 6573 203d 207b    candidates = {
-0004d540: 7777 7320 666f 7220 6474 7320 696e 2074  wws for dts in t
-0004d550: 732e 6465 7065 6e64 656e 6369 6573 2066  s.dependencies f
-0004d560: 6f72 2077 7773 2069 6e20 6474 732e 7768  or wws in dts.wh
-0004d570: 6f5f 6861 7320 6f72 2028 297d 0a20 2020  o_has or ()}.   
-0004d580: 2020 2020 2063 616e 6469 6461 7465 7320       candidates 
-0004d590: 263d 2061 6c6c 5f77 6f72 6b65 7273 0a20  &= all_workers. 
-0004d5a0: 2020 2069 6620 7661 6c69 645f 776f 726b     if valid_work
-0004d5b0: 6572 7320 6973 204e 6f6e 653a 0a20 2020  ers is None:.   
-0004d5c0: 2020 2020 2069 6620 6e6f 7420 6361 6e64       if not cand
-0004d5d0: 6964 6174 6573 3a0a 2020 2020 2020 2020  idates:.        
-0004d5e0: 2020 2020 6361 6e64 6964 6174 6573 203d      candidates =
-0004d5f0: 2061 6c6c 5f77 6f72 6b65 7273 2e63 6f70   all_workers.cop
-0004d600: 7928 290a 2020 2020 656c 7365 3a0a 2020  y().    else:.  
-0004d610: 2020 2020 2020 6361 6e64 6964 6174 6573        candidates
-0004d620: 2026 3d20 7661 6c69 645f 776f 726b 6572   &= valid_worker
-0004d630: 730a 2020 2020 2020 2020 6966 206e 6f74  s.        if not
-0004d640: 2063 616e 6469 6461 7465 733a 0a20 2020   candidates:.   
-0004d650: 2020 2020 2020 2020 2063 616e 6469 6461           candida
-0004d660: 7465 7320 3d20 7661 6c69 645f 776f 726b  tes = valid_work
-0004d670: 6572 730a 2020 2020 2020 2020 2020 2020  ers.            
-0004d680: 6966 206e 6f74 2063 616e 6469 6461 7465  if not candidate
-0004d690: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-0004d6a0: 2020 2069 6620 7473 2e6c 6f6f 7365 5f72     if ts.loose_r
-0004d6b0: 6573 7472 6963 7469 6f6e 733a 0a20 2020  estrictions:.   
-0004d6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004d6d0: 2072 6574 7572 6e20 6465 6369 6465 5f77   return decide_w
-0004d6e0: 6f72 6b65 7228 7473 2c20 616c 6c5f 776f  orker(ts, all_wo
-0004d6f0: 726b 6572 732c 204e 6f6e 652c 206f 626a  rkers, None, obj
-0004d700: 6563 7469 7665 290a 0a20 2020 2069 6620  ective)..    if 
-0004d710: 6e6f 7420 6361 6e64 6964 6174 6573 3a0a  not candidates:.
-0004d720: 2020 2020 2020 2020 7265 7475 726e 204e          return N
-0004d730: 6f6e 650a 2020 2020 656c 6966 206c 656e  one.    elif len
-0004d740: 2863 616e 6469 6461 7465 7329 203d 3d20  (candidates) == 
-0004d750: 313a 0a20 2020 2020 2020 2072 6574 7572  1:.        retur
-0004d760: 6e20 6e65 7874 2869 7465 7228 6361 6e64  n next(iter(cand
-0004d770: 6964 6174 6573 2929 0a20 2020 2065 6c73  idates)).    els
-0004d780: 653a 0a20 2020 2020 2020 2072 6574 7572  e:.        retur
-0004d790: 6e20 6d69 6e28 6361 6e64 6964 6174 6573  n min(candidates
-0004d7a0: 2c20 6b65 793d 6f62 6a65 6374 6976 6529  , key=objective)
-0004d7b0: 0a0a 0a64 6566 2076 616c 6964 6174 655f  ...def validate_
-0004d7c0: 7461 736b 5f73 7461 7465 2874 733a 2054  task_state(ts: T
-0004d7d0: 6173 6b53 7461 7465 2920 2d3e 204e 6f6e  askState) -> Non
-0004d7e0: 653a 0a20 2020 2022 2222 5661 6c69 6461  e:.    """Valida
-0004d7f0: 7465 2074 6865 2067 6976 656e 2054 6173  te the given Tas
-0004d800: 6b53 7461 7465 2222 220a 2020 2020 6173  kState""".    as
-0004d810: 7365 7274 2074 732e 7374 6174 6520 696e  sert ts.state in
-0004d820: 2041 4c4c 5f54 4153 4b5f 5354 4154 4553   ALL_TASK_STATES
-0004d830: 2c20 7473 0a0a 2020 2020 6966 2074 732e  , ts..    if ts.
-0004d840: 7761 6974 696e 675f 6f6e 3a0a 2020 2020  waiting_on:.    
-0004d850: 2020 2020 6173 7365 7274 2074 732e 7761      assert ts.wa
-0004d860: 6974 696e 675f 6f6e 2e69 7373 7562 7365  iting_on.issubse
-0004d870: 7428 7473 2e64 6570 656e 6465 6e63 6965  t(ts.dependencie
-0004d880: 7329 2c20 280a 2020 2020 2020 2020 2020  s), (.          
-0004d890: 2020 2277 6169 7469 6e67 206e 6f74 2073    "waiting not s
-0004d8a0: 7562 7365 7420 6f66 2064 6570 656e 6465  ubset of depende
-0004d8b0: 6e63 6965 7322 2c0a 2020 2020 2020 2020  ncies",.        
-0004d8c0: 2020 2020 7374 7228 7473 2e77 6169 7469      str(ts.waiti
-0004d8d0: 6e67 5f6f 6e29 2c0a 2020 2020 2020 2020  ng_on),.        
-0004d8e0: 2020 2020 7374 7228 7473 2e64 6570 656e      str(ts.depen
-0004d8f0: 6465 6e63 6965 7329 2c0a 2020 2020 2020  dencies),.      
-0004d900: 2020 290a 2020 2020 6966 2074 732e 7761    ).    if ts.wa
-0004d910: 6974 6572 733a 0a20 2020 2020 2020 2061  iters:.        a
-0004d920: 7373 6572 7420 7473 2e77 6169 7465 7273  ssert ts.waiters
-0004d930: 2e69 7373 7562 7365 7428 7473 2e64 6570  .issubset(ts.dep
-0004d940: 656e 6465 6e74 7329 2c20 280a 2020 2020  endents), (.    
-0004d950: 2020 2020 2020 2020 2277 6169 7465 7273          "waiters
-0004d960: 206e 6f74 2073 7562 7365 7420 6f66 2064   not subset of d
-0004d970: 6570 656e 6465 6e74 7322 2c0a 2020 2020  ependents",.    
-0004d980: 2020 2020 2020 2020 7374 7228 7473 2e77          str(ts.w
-0004d990: 6169 7465 7273 292c 0a20 2020 2020 2020  aiters),.       
-0004d9a0: 2020 2020 2073 7472 2874 732e 6465 7065       str(ts.depe
-0004d9b0: 6e64 656e 7473 292c 0a20 2020 2020 2020  ndents),.       
-0004d9c0: 2029 0a0a 2020 2020 666f 7220 6474 7320   )..    for dts 
-0004d9d0: 696e 2074 732e 7761 6974 696e 675f 6f6e  in ts.waiting_on
-0004d9e0: 206f 7220 2829 3a0a 2020 2020 2020 2020   or ():.        
-0004d9f0: 6173 7365 7274 206e 6f74 2064 7473 2e77  assert not dts.w
-0004da00: 686f 5f68 6173 2c20 2822 7761 6974 696e  ho_has, ("waitin
-0004da10: 6720 6f6e 2069 6e2d 6d65 6d6f 7279 2064  g on in-memory d
-0004da20: 6570 222c 2073 7472 2874 7329 2c20 7374  ep", str(ts), st
-0004da30: 7228 6474 7329 290a 2020 2020 2020 2020  r(dts)).        
-0004da40: 6173 7365 7274 2064 7473 2e73 7461 7465  assert dts.state
-0004da50: 2021 3d20 2272 656c 6561 7365 6422 2c20   != "released", 
-0004da60: 2822 7761 6974 696e 6720 6f6e 2072 656c  ("waiting on rel
-0004da70: 6561 7365 6420 6465 7022 2c20 7374 7228  eased dep", str(
-0004da80: 7473 292c 2073 7472 2864 7473 2929 0a20  ts), str(dts)). 
-0004da90: 2020 2066 6f72 2064 7473 2069 6e20 7473     for dts in ts
-0004daa0: 2e64 6570 656e 6465 6e63 6965 733a 0a20  .dependencies:. 
-0004dab0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
-0004dac0: 2069 6e20 6474 732e 6465 7065 6e64 656e   in dts.dependen
-0004dad0: 7473 2c20 280a 2020 2020 2020 2020 2020  ts, (.          
-0004dae0: 2020 226e 6f74 2069 6e20 6465 7065 6e64    "not in depend
-0004daf0: 656e 6379 2773 2064 6570 656e 6465 6e74  ency's dependent
-0004db00: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
-0004db10: 7374 7228 7473 292c 0a20 2020 2020 2020  str(ts),.       
-0004db20: 2020 2020 2073 7472 2864 7473 292c 0a20       str(dts),. 
-0004db30: 2020 2020 2020 2020 2020 2073 7472 2864             str(d
-0004db40: 7473 2e64 6570 656e 6465 6e74 7329 2c0a  ts.dependents),.
-0004db50: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0004db60: 2020 6966 2074 732e 7374 6174 6520 696e    if ts.state in
-0004db70: 2028 2277 6169 7469 6e67 222c 2022 7175   ("waiting", "qu
-0004db80: 6575 6564 222c 2022 7072 6f63 6573 7369  eued", "processi
-0004db90: 6e67 222c 2022 6e6f 2d77 6f72 6b65 7222  ng", "no-worker"
-0004dba0: 293a 0a20 2020 2020 2020 2020 2020 2061  ):.            a
-0004dbb0: 7373 6572 7420 7473 2e77 6169 7469 6e67  ssert ts.waiting
-0004dbc0: 5f6f 6e20 616e 6420 6474 7320 696e 2074  _on and dts in t
-0004dbd0: 732e 7761 6974 696e 675f 6f6e 206f 7220  s.waiting_on or 
-0004dbe0: 6474 732e 7768 6f5f 6861 732c 2028 0a20  dts.who_has, (. 
-0004dbf0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0004dc00: 6465 7020 6d69 7373 696e 6722 2c0a 2020  dep missing",.  
-0004dc10: 2020 2020 2020 2020 2020 2020 2020 7374                st
-0004dc20: 7228 7473 292c 0a20 2020 2020 2020 2020  r(ts),.         
-0004dc30: 2020 2020 2020 2073 7472 2864 7473 292c         str(dts),
-0004dc40: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0004dc50: 2020 2020 2020 2061 7373 6572 7420 6474         assert dt
-0004dc60: 732e 7374 6174 6520 213d 2022 666f 7267  s.state != "forg
-0004dc70: 6f74 7465 6e22 0a0a 2020 2020 666f 7220  otten"..    for 
-0004dc80: 6474 7320 696e 2074 732e 7761 6974 6572  dts in ts.waiter
-0004dc90: 7320 6f72 2028 293a 0a20 2020 2020 2020  s or ():.       
-0004dca0: 2061 7373 6572 7420 6474 732e 7374 6174   assert dts.stat
-0004dcb0: 6520 696e 2028 2277 6169 7469 6e67 222c  e in ("waiting",
-0004dcc0: 2022 7175 6575 6564 222c 2022 7072 6f63   "queued", "proc
-0004dcd0: 6573 7369 6e67 222c 2022 6e6f 2d77 6f72  essing", "no-wor
-0004dce0: 6b65 7222 292c 2028 0a20 2020 2020 2020  ker"), (.       
-0004dcf0: 2020 2020 2022 7761 6974 6572 206e 6f74       "waiter not
-0004dd00: 2069 6e20 706c 6179 222c 0a20 2020 2020   in play",.     
-0004dd10: 2020 2020 2020 2073 7472 2874 7329 2c0a         str(ts),.
-0004dd20: 2020 2020 2020 2020 2020 2020 7374 7228              str(
-0004dd30: 6474 7329 2c0a 2020 2020 2020 2020 290a  dts),.        ).
-0004dd40: 2020 2020 666f 7220 6474 7320 696e 2074      for dts in t
-0004dd50: 732e 6465 7065 6e64 656e 7473 3a0a 2020  s.dependents:.  
-0004dd60: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
-0004dd70: 696e 2064 7473 2e64 6570 656e 6465 6e63  in dts.dependenc
-0004dd80: 6965 732c 2028 0a20 2020 2020 2020 2020  ies, (.         
-0004dd90: 2020 2022 6e6f 7420 696e 2064 6570 656e     "not in depen
-0004dda0: 6465 6e74 2773 2064 6570 656e 6465 6e63  dent's dependenc
-0004ddb0: 6965 7322 2c0a 2020 2020 2020 2020 2020  ies",.          
-0004ddc0: 2020 7374 7228 7473 292c 0a20 2020 2020    str(ts),.     
-0004ddd0: 2020 2020 2020 2073 7472 2864 7473 292c         str(dts),
-0004dde0: 0a20 2020 2020 2020 2020 2020 2073 7472  .            str
-0004ddf0: 2864 7473 2e64 6570 656e 6465 6e63 6965  (dts.dependencie
-0004de00: 7329 2c0a 2020 2020 2020 2020 290a 2020  s),.        ).  
-0004de10: 2020 2020 2020 6173 7365 7274 2064 7473        assert dts
-0004de20: 2e73 7461 7465 2021 3d20 2266 6f72 676f  .state != "forgo
-0004de30: 7474 656e 220a 0a20 2020 2061 7373 6572  tten"..    asser
-0004de40: 7420 2874 732e 7072 6f63 6573 7369 6e67  t (ts.processing
-0004de50: 5f6f 6e20 6973 206e 6f74 204e 6f6e 6529  _on is not None)
-0004de60: 203d 3d20 2874 732e 7374 6174 6520 3d3d   == (ts.state ==
-0004de70: 2022 7072 6f63 6573 7369 6e67 2229 0a20   "processing"). 
-0004de80: 2020 2061 7373 6572 7420 626f 6f6c 2874     assert bool(t
-0004de90: 732e 7768 6f5f 6861 7329 203d 3d20 2874  s.who_has) == (t
-0004dea0: 732e 7374 6174 6520 3d3d 2022 6d65 6d6f  s.state == "memo
-0004deb0: 7279 2229 2c20 2874 732c 2074 732e 7768  ry"), (ts, ts.wh
-0004dec0: 6f5f 6861 732c 2074 732e 7374 6174 6529  o_has, ts.state)
-0004ded0: 0a0a 2020 2020 6966 2074 732e 7374 6174  ..    if ts.stat
-0004dee0: 6520 3d3d 2022 7175 6575 6564 223a 0a20  e == "queued":. 
-0004def0: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
-0004df00: 7420 7473 2e70 726f 6365 7373 696e 675f  t ts.processing_
-0004df10: 6f6e 0a20 2020 2020 2020 2061 7373 6572  on.        asser
-0004df20: 7420 6e6f 7420 7473 2e77 686f 5f68 6173  t not ts.who_has
-0004df30: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0004df40: 616c 6c28 6474 732e 7768 6f5f 6861 7320  all(dts.who_has 
-0004df50: 666f 7220 6474 7320 696e 2074 732e 6465  for dts in ts.de
-0004df60: 7065 6e64 656e 6369 6573 292c 2028 0a20  pendencies), (. 
-0004df70: 2020 2020 2020 2020 2020 2022 7461 736b             "task
-0004df80: 2071 7565 7565 6420 7769 7468 6f75 7420   queued without 
-0004df90: 616c 6c20 6465 7073 222c 0a20 2020 2020  all deps",.     
-0004dfa0: 2020 2020 2020 2073 7472 2874 7329 2c0a         str(ts),.
-0004dfb0: 2020 2020 2020 2020 2020 2020 7374 7228              str(
-0004dfc0: 7473 2e64 6570 656e 6465 6e63 6965 7329  ts.dependencies)
-0004dfd0: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
-0004dfe0: 2069 6620 7473 2e73 7461 7465 203d 3d20   if ts.state == 
-0004dff0: 2270 726f 6365 7373 696e 6722 3a0a 2020  "processing":.  
-0004e000: 2020 2020 2020 6173 7365 7274 2061 6c6c        assert all
-0004e010: 2864 7473 2e77 686f 5f68 6173 2066 6f72  (dts.who_has for
-0004e020: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
-0004e030: 6465 6e63 6965 7329 2c20 280a 2020 2020  dencies), (.    
-0004e040: 2020 2020 2020 2020 2274 6173 6b20 7072          "task pr
-0004e050: 6f63 6573 7369 6e67 2077 6974 686f 7574  ocessing without
-0004e060: 2061 6c6c 2064 6570 7322 2c0a 2020 2020   all deps",.    
-0004e070: 2020 2020 2020 2020 7374 7228 7473 292c          str(ts),
-0004e080: 0a20 2020 2020 2020 2020 2020 2073 7472  .            str
-0004e090: 2874 732e 6465 7065 6e64 656e 6369 6573  (ts.dependencies
-0004e0a0: 292c 0a20 2020 2020 2020 2029 0a20 2020  ),.        ).   
-0004e0b0: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-0004e0c0: 7473 2e77 6169 7469 6e67 5f6f 6e0a 0a20  ts.waiting_on.. 
-0004e0d0: 2020 2069 6620 7473 2e77 686f 5f68 6173     if ts.who_has
-0004e0e0: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
-0004e0f0: 2074 732e 7761 6974 6572 7320 6f72 2074   ts.waiters or t
-0004e100: 732e 7768 6f5f 7761 6e74 732c 2028 0a20  s.who_wants, (. 
-0004e110: 2020 2020 2020 2020 2020 2022 756e 6e65             "unne
-0004e120: 6564 6564 2074 6173 6b20 696e 206d 656d  eded task in mem
-0004e130: 6f72 7922 2c0a 2020 2020 2020 2020 2020  ory",.          
-0004e140: 2020 7374 7228 7473 292c 0a20 2020 2020    str(ts),.     
-0004e150: 2020 2020 2020 2073 7472 2874 732e 7768         str(ts.wh
-0004e160: 6f5f 6861 7329 2c0a 2020 2020 2020 2020  o_has),.        
-0004e170: 290a 2020 2020 2020 2020 6966 2074 732e  ).        if ts.
-0004e180: 7275 6e5f 7370 6563 3a20 2023 2077 6173  run_spec:  # was
-0004e190: 2063 6f6d 7075 7465 640a 2020 2020 2020   computed.      
-0004e1a0: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
-0004e1b0: 7479 7065 0a20 2020 2020 2020 2020 2020  type.           
-0004e1c0: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
-0004e1d0: 6365 2874 732e 7479 7065 2c20 7374 7229  ce(ts.type, str)
-0004e1e0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0004e1f0: 6e6f 7420 616e 7928 0a20 2020 2020 2020  not any(.       
-0004e200: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
-0004e210: 2020 2020 2020 2074 7320 696e 2064 7473         ts in dts
-0004e220: 2e77 6169 7469 6e67 5f6f 6e0a 2020 2020  .waiting_on.    
-0004e230: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0004e240: 6474 7320 696e 2074 732e 6465 7065 6e64  dts in ts.depend
-0004e250: 656e 7473 0a20 2020 2020 2020 2020 2020  ents.           
-0004e260: 2020 2020 2069 6620 6474 732e 7761 6974       if dts.wait
-0004e270: 696e 675f 6f6e 2069 7320 6e6f 7420 4e6f  ing_on is not No
-0004e280: 6e65 0a20 2020 2020 2020 2020 2020 205d  ne.            ]
-0004e290: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-0004e2a0: 2020 2066 6f72 2077 7320 696e 2074 732e     for ws in ts.
-0004e2b0: 7768 6f5f 6861 733a 0a20 2020 2020 2020  who_has:.       
-0004e2c0: 2020 2020 2061 7373 6572 7420 7473 2069       assert ts i
-0004e2d0: 6e20 7773 2e68 6173 5f77 6861 742c 2028  n ws.has_what, (
-0004e2e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004e2f0: 2022 6e6f 7420 696e 2077 686f 5f68 6173   "not in who_has
-0004e300: 2720 6861 735f 7768 6174 222c 0a20 2020  ' has_what",.   
-0004e310: 2020 2020 2020 2020 2020 2020 2073 7472               str
-0004e320: 2874 7329 2c0a 2020 2020 2020 2020 2020  (ts),.          
-0004e330: 2020 2020 2020 7374 7228 7773 292c 0a20        str(ws),. 
-0004e340: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0004e350: 7472 2877 732e 6861 735f 7768 6174 292c  tr(ws.has_what),
-0004e360: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
-0004e370: 2020 2020 666f 7220 6373 2069 6e20 7473      for cs in ts
-0004e380: 2e77 686f 5f77 616e 7473 206f 7220 2829  .who_wants or ()
-0004e390: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
-0004e3a0: 2074 7320 696e 2063 732e 7761 6e74 735f   ts in cs.wants_
-0004e3b0: 7768 6174 2c20 280a 2020 2020 2020 2020  what, (.        
-0004e3c0: 2020 2020 226e 6f74 2069 6e20 7768 6f5f      "not in who_
-0004e3d0: 7761 6e74 7327 2077 616e 7473 5f77 6861  wants' wants_wha
-0004e3e0: 7422 2c0a 2020 2020 2020 2020 2020 2020  t",.            
-0004e3f0: 7374 7228 7473 292c 0a20 2020 2020 2020  str(ts),.       
-0004e400: 2020 2020 2073 7472 2863 7329 2c0a 2020       str(cs),.  
-0004e410: 2020 2020 2020 2020 2020 7374 7228 6373            str(cs
-0004e420: 2e77 616e 7473 5f77 6861 7429 2c0a 2020  .wants_what),.  
-0004e430: 2020 2020 2020 290a 0a20 2020 2069 6620        )..    if 
-0004e440: 7473 2e61 6374 6f72 3a0a 2020 2020 2020  ts.actor:.      
-0004e450: 2020 6966 2074 732e 7374 6174 6520 3d3d    if ts.state ==
-0004e460: 2022 6d65 6d6f 7279 223a 0a20 2020 2020   "memory":.     
-0004e470: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
-0004e480: 2e77 686f 5f68 6173 0a20 2020 2020 2020  .who_has.       
-0004e490: 2020 2020 2061 7373 6572 7420 7375 6d28       assert sum(
-0004e4a0: 7473 2069 6e20 7773 2e61 6374 6f72 7320  ts in ws.actors 
-0004e4b0: 666f 7220 7773 2069 6e20 7473 2e77 686f  for ws in ts.who
-0004e4c0: 5f68 6173 2920 3d3d 2031 0a20 2020 2020  _has) == 1.     
-0004e4d0: 2020 2069 6620 7473 2e73 7461 7465 203d     if ts.state =
-0004e4e0: 3d20 2270 726f 6365 7373 696e 6722 3a0a  = "processing":.
-0004e4f0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-0004e500: 7274 2074 732e 7072 6f63 6573 7369 6e67  rt ts.processing
-0004e510: 5f6f 6e0a 2020 2020 2020 2020 2020 2020  _on.            
-0004e520: 6173 7365 7274 2074 7320 696e 2074 732e  assert ts in ts.
-0004e530: 7072 6f63 6573 7369 6e67 5f6f 6e2e 6163  processing_on.ac
-0004e540: 746f 7273 0a20 2020 2020 2020 2061 7373  tors.        ass
-0004e550: 6572 7420 7473 2e73 7461 7465 2021 3d20  ert ts.state != 
-0004e560: 2271 7565 7565 6422 0a0a 0a64 6566 2076  "queued"...def v
-0004e570: 616c 6964 6174 655f 776f 726b 6572 5f73  alidate_worker_s
-0004e580: 7461 7465 2877 733a 2057 6f72 6b65 7253  tate(ws: WorkerS
-0004e590: 7461 7465 2920 2d3e 204e 6f6e 653a 0a20  tate) -> None:. 
-0004e5a0: 2020 2066 6f72 2074 7320 696e 2077 732e     for ts in ws.
-0004e5b0: 6861 735f 7768 6174 206f 7220 2829 3a0a  has_what or ():.
-0004e5c0: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
-0004e5d0: 732e 7768 6f5f 6861 730a 2020 2020 2020  s.who_has.      
-0004e5e0: 2020 6173 7365 7274 2077 7320 696e 2074    assert ws in t
-0004e5f0: 732e 7768 6f5f 6861 732c 2028 0a20 2020  s.who_has, (.   
-0004e600: 2020 2020 2020 2020 2022 6e6f 7420 696e           "not in
-0004e610: 2068 6173 5f77 6861 7427 2077 686f 5f68   has_what' who_h
-0004e620: 6173 222c 0a20 2020 2020 2020 2020 2020  as",.           
-0004e630: 2073 7472 2877 7329 2c0a 2020 2020 2020   str(ws),.      
-0004e640: 2020 2020 2020 7374 7228 7473 292c 0a20        str(ts),. 
-0004e650: 2020 2020 2020 2020 2020 2073 7472 2874             str(t
-0004e660: 732e 7768 6f5f 6861 7329 2c0a 2020 2020  s.who_has),.    
-0004e670: 2020 2020 290a 0a20 2020 2066 6f72 2074      )..    for t
-0004e680: 7320 696e 2077 732e 6163 746f 7273 3a0a  s in ws.actors:.
-0004e690: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
-0004e6a0: 732e 7374 6174 6520 696e 2028 226d 656d  s.state in ("mem
-0004e6b0: 6f72 7922 2c20 2270 726f 6365 7373 696e  ory", "processin
-0004e6c0: 6722 290a 0a0a 6465 6620 7661 6c69 6461  g")...def valida
-0004e6d0: 7465 5f73 7461 7465 280a 2020 2020 7461  te_state(.    ta
-0004e6e0: 736b 733a 2064 6963 745b 4b65 792c 2054  sks: dict[Key, T
-0004e6f0: 6173 6b53 7461 7465 5d2c 0a20 2020 2077  askState],.    w
-0004e700: 6f72 6b65 7273 3a20 6469 6374 5b73 7472  orkers: dict[str
-0004e710: 2c20 576f 726b 6572 5374 6174 655d 2c0a  , WorkerState],.
-0004e720: 2020 2020 636c 6965 6e74 733a 2064 6963      clients: dic
-0004e730: 745b 7374 722c 2043 6c69 656e 7453 7461  t[str, ClientSta
-0004e740: 7465 5d2c 0a29 202d 3e20 4e6f 6e65 3a0a  te],.) -> None:.
-0004e750: 2020 2020 2222 2256 616c 6964 6174 6520      """Validate 
-0004e760: 6120 6375 7272 656e 7420 7275 6e74 696d  a current runtim
-0004e770: 6520 7374 6174 652e 0a0a 2020 2020 5468  e state...    Th
-0004e780: 6973 2070 6572 666f 726d 7320 6120 7365  is performs a se
-0004e790: 7175 656e 6365 206f 6620 6368 6563 6b73  quence of checks
-0004e7a0: 206f 6e20 7468 6520 656e 7469 7265 2067   on the entire g
-0004e7b0: 7261 7068 2c20 7275 6e6e 696e 6720 696e  raph, running in
-0004e7c0: 2061 626f 7574 206c 696e 6561 720a 2020   about linear.  
-0004e7d0: 2020 7469 6d65 2e20 5468 6973 2072 6169    time. This rai
-0004e7e0: 7365 7320 6173 7365 7274 2065 7272 6f72  ses assert error
-0004e7f0: 7320 6966 2061 6e79 7468 696e 6720 646f  s if anything do
-0004e800: 6573 6e27 7420 6368 6563 6b20 6f75 742e  esn't check out.
-0004e810: 0a20 2020 2022 2222 0a20 2020 2066 6f72  .    """.    for
-0004e820: 2074 7320 696e 2074 6173 6b73 2e76 616c   ts in tasks.val
-0004e830: 7565 7328 293a 0a20 2020 2020 2020 2076  ues():.        v
-0004e840: 616c 6964 6174 655f 7461 736b 5f73 7461  alidate_task_sta
-0004e850: 7465 2874 7329 0a0a 2020 2020 666f 7220  te(ts)..    for 
-0004e860: 7773 2069 6e20 776f 726b 6572 732e 7661  ws in workers.va
-0004e870: 6c75 6573 2829 3a0a 2020 2020 2020 2020  lues():.        
-0004e880: 7661 6c69 6461 7465 5f77 6f72 6b65 725f  validate_worker_
-0004e890: 7374 6174 6528 7773 290a 0a20 2020 2066  state(ws)..    f
-0004e8a0: 6f72 2063 7320 696e 2063 6c69 656e 7473  or cs in clients
-0004e8b0: 2e76 616c 7565 7328 293a 0a20 2020 2020  .values():.     
-0004e8c0: 2020 2066 6f72 2074 7320 696e 2063 732e     for ts in cs.
-0004e8d0: 7761 6e74 735f 7768 6174 206f 7220 2829  wants_what or ()
-0004e8e0: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
-0004e8f0: 7365 7274 2074 732e 7768 6f5f 7761 6e74  sert ts.who_want
-0004e900: 730a 2020 2020 2020 2020 2020 2020 6173  s.            as
-0004e910: 7365 7274 2063 7320 696e 2074 732e 7768  sert cs in ts.wh
-0004e920: 6f5f 7761 6e74 732c 2028 0a20 2020 2020  o_wants, (.     
-0004e930: 2020 2020 2020 2020 2020 2022 6e6f 7420             "not 
-0004e940: 696e 2077 616e 7473 5f77 6861 7427 2077  in wants_what' w
-0004e950: 686f 5f77 616e 7473 222c 0a20 2020 2020  ho_wants",.     
-0004e960: 2020 2020 2020 2020 2020 2073 7472 2863             str(c
-0004e970: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
-0004e980: 2020 2020 7374 7228 7473 292c 0a20 2020      str(ts),.   
-0004e990: 2020 2020 2020 2020 2020 2020 2073 7472               str
-0004e9a0: 2874 732e 7768 6f5f 7761 6e74 7329 2c0a  (ts.who_wants),.
-0004e9b0: 2020 2020 2020 2020 2020 2020 290a 0a0a              )...
-0004e9c0: 6465 6620 6865 6172 7462 6561 745f 696e  def heartbeat_in
-0004e9d0: 7465 7276 616c 286e 3a20 696e 7429 202d  terval(n: int) -
-0004e9e0: 3e20 666c 6f61 743a 0a20 2020 2022 2222  > float:.    """
-0004e9f0: 496e 7465 7276 616c 2069 6e20 7365 636f  Interval in seco
-0004ea00: 6e64 7320 7468 6174 2077 6520 6465 7369  nds that we desi
-0004ea10: 7265 2068 6561 7274 6265 6174 7320 6261  re heartbeats ba
-0004ea20: 7365 6420 6f6e 206e 756d 6265 7220 6f66  sed on number of
-0004ea30: 2077 6f72 6b65 7273 2222 220a 2020 2020   workers""".    
-0004ea40: 6966 206e 203c 3d20 3130 3a0a 2020 2020  if n <= 10:.    
-0004ea50: 2020 2020 7265 7475 726e 2030 2e35 0a20      return 0.5. 
-0004ea60: 2020 2065 6c69 6620 6e20 3c20 3530 3a0a     elif n < 50:.
-0004ea70: 2020 2020 2020 2020 7265 7475 726e 2031          return 1
-0004ea80: 0a20 2020 2065 6c69 6620 6e20 3c20 3230  .    elif n < 20
-0004ea90: 303a 0a20 2020 2020 2020 2072 6574 7572  0:.        retur
-0004eaa0: 6e20 320a 2020 2020 656c 7365 3a0a 2020  n 2.    else:.  
-0004eab0: 2020 2020 2020 2320 4e6f 206d 6f72 6520        # No more 
-0004eac0: 7468 616e 2032 3030 2068 6561 7274 6265  than 200 heartbe
-0004ead0: 6174 7320 6120 7365 636f 6e64 2073 6361  ats a second sca
-0004eae0: 6c65 6420 6279 2077 6f72 6b65 7273 0a20  led by workers. 
-0004eaf0: 2020 2020 2020 2072 6574 7572 6e20 6e20         return n 
-0004eb00: 2f20 3230 3020 2b20 310a 0a0a 6465 6620  / 200 + 1...def 
-0004eb10: 5f74 6173 6b5f 736c 6f74 735f 6176 6169  _task_slots_avai
-0004eb20: 6c61 626c 6528 7773 3a20 576f 726b 6572  lable(ws: Worker
-0004eb30: 5374 6174 652c 2073 6174 7572 6174 696f  State, saturatio
-0004eb40: 6e5f 6661 6374 6f72 3a20 666c 6f61 7429  n_factor: float)
-0004eb50: 202d 3e20 696e 743a 0a20 2020 2022 2222   -> int:.    """
-0004eb60: 4e75 6d62 6572 206f 6620 7461 736b 7320  Number of tasks 
-0004eb70: 7468 6174 2063 616e 2062 6520 7365 6e74  that can be sent
-0004eb80: 2074 6f20 7468 6973 2077 6f72 6b65 7220   to this worker 
-0004eb90: 7769 7468 6f75 7420 6f76 6572 7361 7475  without oversatu
-0004eba0: 7261 7469 6e67 2069 7422 2222 0a20 2020  rating it""".   
-0004ebb0: 2061 7373 6572 7420 6e6f 7420 6d61 7468   assert not math
-0004ebc0: 2e69 7369 6e66 2873 6174 7572 6174 696f  .isinf(saturatio
-0004ebd0: 6e5f 6661 6374 6f72 290a 2020 2020 7265  n_factor).    re
-0004ebe0: 7475 726e 206d 6178 286d 6174 682e 6365  turn max(math.ce
-0004ebf0: 696c 2873 6174 7572 6174 696f 6e5f 6661  il(saturation_fa
-0004ec00: 6374 6f72 202a 2077 732e 6e74 6872 6561  ctor * ws.nthrea
-0004ec10: 6473 292c 2031 2920 2d20 280a 2020 2020  ds), 1) - (.    
-0004ec20: 2020 2020 6c65 6e28 7773 2e70 726f 6365      len(ws.proce
-0004ec30: 7373 696e 6729 202d 206c 656e 2877 732e  ssing) - len(ws.
-0004ec40: 6c6f 6e67 5f72 756e 6e69 6e67 290a 2020  long_running).  
-0004ec50: 2020 290a 0a0a 6465 6620 5f77 6f72 6b65    )...def _worke
-0004ec60: 725f 6675 6c6c 2877 733a 2057 6f72 6b65  r_full(ws: Worke
-0004ec70: 7253 7461 7465 2c20 7361 7475 7261 7469  rState, saturati
-0004ec80: 6f6e 5f66 6163 746f 723a 2066 6c6f 6174  on_factor: float
-0004ec90: 2920 2d3e 2062 6f6f 6c3a 0a20 2020 2069  ) -> bool:.    i
-0004eca0: 6620 6d61 7468 2e69 7369 6e66 2873 6174  f math.isinf(sat
-0004ecb0: 7572 6174 696f 6e5f 6661 6374 6f72 293a  uration_factor):
-0004ecc0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0004ecd0: 4661 6c73 650a 2020 2020 7265 7475 726e  False.    return
-0004ece0: 205f 7461 736b 5f73 6c6f 7473 5f61 7661   _task_slots_ava
-0004ecf0: 696c 6162 6c65 2877 732c 2073 6174 7572  ilable(ws, satur
-0004ed00: 6174 696f 6e5f 6661 6374 6f72 2920 3c3d  ation_factor) <=
-0004ed10: 2030 0a0a 0a63 6c61 7373 204b 696c 6c65   0...class Kille
-0004ed20: 6457 6f72 6b65 7228 4578 6365 7074 696f  dWorker(Exceptio
-0004ed30: 6e29 3a0a 2020 2020 6465 6620 5f5f 696e  n):.    def __in
-0004ed40: 6974 5f5f 2873 656c 662c 2074 6173 6b3a  it__(self, task:
-0004ed50: 204b 6579 2c20 6c61 7374 5f77 6f72 6b65   Key, last_worke
-0004ed60: 723a 2057 6f72 6b65 7253 7461 7465 2c20  r: WorkerState, 
-0004ed70: 616c 6c6f 7765 645f 6661 696c 7572 6573  allowed_failures
-0004ed80: 3a20 696e 7429 3a0a 2020 2020 2020 2020  : int):.        
-0004ed90: 7375 7065 7228 292e 5f5f 696e 6974 5f5f  super().__init__
-0004eda0: 2874 6173 6b2c 206c 6173 745f 776f 726b  (task, last_work
-0004edb0: 6572 2c20 616c 6c6f 7765 645f 6661 696c  er, allowed_fail
-0004edc0: 7572 6573 290a 0a20 2020 2040 7072 6f70  ures)..    @prop
-0004edd0: 6572 7479 0a20 2020 2064 6566 2074 6173  erty.    def tas
-0004ede0: 6b28 7365 6c66 2920 2d3e 204b 6579 3a0a  k(self) -> Key:.
-0004edf0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-0004ee00: 656c 662e 6172 6773 5b30 5d0a 0a20 2020  elf.args[0]..   
-0004ee10: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
-0004ee20: 6566 206c 6173 745f 776f 726b 6572 2873  ef last_worker(s
-0004ee30: 656c 6629 202d 3e20 576f 726b 6572 5374  elf) -> WorkerSt
-0004ee40: 6174 653a 0a20 2020 2020 2020 2072 6574  ate:.        ret
-0004ee50: 7572 6e20 7365 6c66 2e61 7267 735b 315d  urn self.args[1]
-0004ee60: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
-0004ee70: 2020 2020 6465 6620 616c 6c6f 7765 645f      def allowed_
-0004ee80: 6661 696c 7572 6573 2873 656c 6629 202d  failures(self) -
-0004ee90: 3e20 696e 743a 0a20 2020 2020 2020 2072  > int:.        r
-0004eea0: 6574 7572 6e20 7365 6c66 2e61 7267 735b  eturn self.args[
-0004eeb0: 325d 0a0a 2020 2020 6465 6620 5f5f 7374  2]..    def __st
-0004eec0: 725f 5f28 7365 6c66 2920 2d3e 2073 7472  r__(self) -> str
-0004eed0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-0004eee0: 2028 0a20 2020 2020 2020 2020 2020 2066   (.            f
-0004eef0: 2241 7474 656d 7074 6564 2074 6f20 7275  "Attempted to ru
-0004ef00: 6e20 7461 736b 207b 7365 6c66 2e74 6173  n task {self.tas
-0004ef10: 6b21 727d 206f 6e20 7b73 656c 662e 616c  k!r} on {self.al
-0004ef20: 6c6f 7765 645f 6661 696c 7572 6573 202b  lowed_failures +
-0004ef30: 2031 7d20 220a 2020 2020 2020 2020 2020   1} ".          
-0004ef40: 2020 2264 6966 6665 7265 6e74 2077 6f72    "different wor
-0004ef50: 6b65 7273 2c20 6275 7420 616c 6c20 7468  kers, but all th
-0004ef60: 6f73 6520 776f 726b 6572 7320 6469 6564  ose workers died
-0004ef70: 2077 6869 6c65 2072 756e 6e69 6e67 2069   while running i
-0004ef80: 742e 2022 0a20 2020 2020 2020 2020 2020  t. ".           
-0004ef90: 2066 2254 6865 206c 6173 7420 776f 726b   f"The last work
-0004efa0: 6572 2074 6861 7420 6174 7465 6d70 7420  er that attempt 
-0004efb0: 746f 2072 756e 2074 6865 2074 6173 6b20  to run the task 
-0004efc0: 7761 7320 7b73 656c 662e 6c61 7374 5f77  was {self.last_w
-0004efd0: 6f72 6b65 722e 6164 6472 6573 737d 2e20  orker.address}. 
-0004efe0: 220a 2020 2020 2020 2020 2020 2020 2249  ".            "I
-0004eff0: 6e73 7065 6374 696e 6720 776f 726b 6572  nspecting worker
-0004f000: 206c 6f67 7320 6973 206f 6674 656e 2061   logs is often a
-0004f010: 2067 6f6f 6420 6e65 7874 2073 7465 7020   good next step 
-0004f020: 746f 2064 6961 676e 6f73 6520 7768 6174  to diagnose what
-0004f030: 2077 656e 7420 7772 6f6e 672e 2022 0a20   went wrong. ". 
-0004f040: 2020 2020 2020 2020 2020 2022 466f 7220             "For 
-0004f050: 6d6f 7265 2069 6e66 6f72 6d61 7469 6f6e  more information
-0004f060: 2073 6565 2068 7474 7073 3a2f 2f64 6973   see https://dis
-0004f070: 7472 6962 7574 6564 2e64 6173 6b2e 6f72  tributed.dask.or
-0004f080: 672f 656e 2f73 7461 626c 652f 6b69 6c6c  g/en/stable/kill
-0004f090: 6564 2e68 746d 6c2e 220a 2020 2020 2020  ed.html.".      
-0004f0a0: 2020 290a 0a0a 636c 6173 7320 576f 726b    )...class Work
-0004f0b0: 6572 5374 6174 7573 506c 7567 696e 2853  erStatusPlugin(S
-0004f0c0: 6368 6564 756c 6572 506c 7567 696e 293a  chedulerPlugin):
-0004f0d0: 0a20 2020 2022 2222 4120 706c 7567 696e  .    """A plugin
-0004f0e0: 2074 6f20 7368 6172 6520 776f 726b 6572   to share worker
-0004f0f0: 2073 7461 7475 7320 7769 7468 2061 2072   status with a r
-0004f100: 656d 6f74 6520 6f62 7365 7276 6572 0a0a  emote observer..
-0004f110: 2020 2020 5468 6973 2069 7320 7573 6564      This is used
-0004f120: 2069 6e20 636c 7573 7465 7220 6d61 6e61   in cluster mana
-0004f130: 6765 7273 2074 6f20 6b65 6570 2075 7064  gers to keep upd
-0004f140: 6174 6564 2061 626f 7574 2074 6865 2073  ated about the s
-0004f150: 7461 7475 7320 6f66 2074 6865 2073 6368  tatus of the sch
-0004f160: 6564 756c 6572 2e0a 2020 2020 2222 220a  eduler..    """.
-0004f170: 0a20 2020 206e 616d 653a 2043 6c61 7373  .    name: Class
-0004f180: 5661 725b 7374 725d 203d 2022 776f 726b  Var[str] = "work
-0004f190: 6572 2d73 7461 7475 7322 0a20 2020 2062  er-status".    b
-0004f1a0: 636f 6d6d 3a20 4261 7463 6865 6453 656e  comm: BatchedSen
-0004f1b0: 640a 0a20 2020 2064 6566 205f 5f69 6e69  d..    def __ini
-0004f1c0: 745f 5f28 7365 6c66 2c20 7363 6865 6475  t__(self, schedu
-0004f1d0: 6c65 723a 2053 6368 6564 756c 6572 2c20  ler: Scheduler, 
-0004f1e0: 636f 6d6d 3a20 436f 6d6d 293a 0a20 2020  comm: Comm):.   
-0004f1f0: 2020 2020 2073 656c 662e 6263 6f6d 6d20       self.bcomm 
-0004f200: 3d20 4261 7463 6865 6453 656e 6428 696e  = BatchedSend(in
-0004f210: 7465 7276 616c 3d22 356d 7322 290a 2020  terval="5ms").  
-0004f220: 2020 2020 2020 7365 6c66 2e62 636f 6d6d        self.bcomm
-0004f230: 2e73 7461 7274 2863 6f6d 6d29 0a20 2020  .start(comm).   
-0004f240: 2020 2020 2073 6368 6564 756c 6572 2e61       scheduler.a
-0004f250: 6464 5f70 6c75 6769 6e28 7365 6c66 290a  dd_plugin(self).
-0004f260: 0a20 2020 2064 6566 2061 6464 5f77 6f72  .    def add_wor
-0004f270: 6b65 7228 7365 6c66 2c20 7363 6865 6475  ker(self, schedu
-0004f280: 6c65 723a 2053 6368 6564 756c 6572 2c20  ler: Scheduler, 
-0004f290: 776f 726b 6572 3a20 7374 7229 202d 3e20  worker: str) -> 
-0004f2a0: 4e6f 6e65 3a0a 2020 2020 2020 2020 6964  None:.        id
-0004f2b0: 656e 7420 3d20 7363 6865 6475 6c65 722e  ent = scheduler.
-0004f2c0: 776f 726b 6572 735b 776f 726b 6572 5d2e  workers[worker].
-0004f2d0: 6964 656e 7469 7479 2829 0a20 2020 2020  identity().     
-0004f2e0: 2020 2064 656c 2069 6465 6e74 5b22 6d65     del ident["me
-0004f2f0: 7472 6963 7322 5d0a 2020 2020 2020 2020  trics"].        
-0004f300: 6465 6c20 6964 656e 745b 226c 6173 745f  del ident["last_
-0004f310: 7365 656e 225d 0a20 2020 2020 2020 2074  seen"].        t
-0004f320: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0004f330: 7365 6c66 2e62 636f 6d6d 2e73 656e 6428  self.bcomm.send(
-0004f340: 5b22 6164 6422 2c20 7b22 776f 726b 6572  ["add", {"worker
-0004f350: 7322 3a20 7b77 6f72 6b65 723a 2069 6465  s": {worker: ide
-0004f360: 6e74 7d7d 5d29 0a20 2020 2020 2020 2065  nt}}]).        e
-0004f370: 7863 6570 7420 436f 6d6d 436c 6f73 6564  xcept CommClosed
-0004f380: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
-0004f390: 2020 2073 6368 6564 756c 6572 2e72 656d     scheduler.rem
-0004f3a0: 6f76 655f 706c 7567 696e 286e 616d 653d  ove_plugin(name=
-0004f3b0: 7365 6c66 2e6e 616d 6529 0a0a 2020 2020  self.name)..    
-0004f3c0: 6465 6620 7265 6d6f 7665 5f77 6f72 6b65  def remove_worke
-0004f3d0: 7228 7365 6c66 2c20 7363 6865 6475 6c65  r(self, schedule
-0004f3e0: 723a 2053 6368 6564 756c 6572 2c20 776f  r: Scheduler, wo
-0004f3f0: 726b 6572 3a20 7374 722c 202a 2a6b 7761  rker: str, **kwa
-0004f400: 7267 733a 2041 6e79 2920 2d3e 204e 6f6e  rgs: Any) -> Non
-0004f410: 653a 0a20 2020 2020 2020 2074 7279 3a0a  e:.        try:.
-0004f420: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0004f430: 2e62 636f 6d6d 2e73 656e 6428 5b22 7265  .bcomm.send(["re
-0004f440: 6d6f 7665 222c 2077 6f72 6b65 725d 290a  move", worker]).
-0004f450: 2020 2020 2020 2020 6578 6365 7074 2043          except C
-0004f460: 6f6d 6d43 6c6f 7365 6445 7272 6f72 3a0a  ommClosedError:.
-0004f470: 2020 2020 2020 2020 2020 2020 7363 6865              sche
-0004f480: 6475 6c65 722e 7265 6d6f 7665 5f70 6c75  duler.remove_plu
-0004f490: 6769 6e28 6e61 6d65 3d73 656c 662e 6e61  gin(name=self.na
-0004f4a0: 6d65 290a 0a20 2020 2064 6566 2074 6561  me)..    def tea
-0004f4b0: 7264 6f77 6e28 7365 6c66 2920 2d3e 204e  rdown(self) -> N
-0004f4c0: 6f6e 653a 0a20 2020 2020 2020 2073 656c  one:.        sel
-0004f4d0: 662e 6263 6f6d 6d2e 636c 6f73 6528 290a  f.bcomm.close().
-0004f4e0: 0a0a 636c 6173 7320 436f 6c6c 6563 7454  ..class CollectT
-0004f4f0: 6173 6b4d 6574 6144 6174 6150 6c75 6769  askMetaDataPlugi
-0004f500: 6e28 5363 6865 6475 6c65 7250 6c75 6769  n(SchedulerPlugi
-0004f510: 6e29 3a0a 2020 2020 7363 6865 6475 6c65  n):.    schedule
-0004f520: 723a 2053 6368 6564 756c 6572 0a20 2020  r: Scheduler.   
-0004f530: 206e 616d 653a 2073 7472 0a20 2020 206b   name: str.    k
-0004f540: 6579 733a 2073 6574 5b4b 6579 5d0a 2020  eys: set[Key].  
-0004f550: 2020 6d65 7461 6461 7461 3a20 6469 6374    metadata: dict
-0004f560: 5b4b 6579 2c20 416e 795d 0a20 2020 2073  [Key, Any].    s
-0004f570: 7461 7465 3a20 6469 6374 5b4b 6579 2c20  tate: dict[Key, 
-0004f580: 5461 736b 5374 6174 6553 7461 7465 5d0a  TaskStateState].
-0004f590: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
-0004f5a0: 5f28 7365 6c66 2c20 7363 6865 6475 6c65  _(self, schedule
-0004f5b0: 723a 2053 6368 6564 756c 6572 2c20 6e61  r: Scheduler, na
-0004f5c0: 6d65 3a20 7374 7229 3a0a 2020 2020 2020  me: str):.      
-0004f5d0: 2020 7365 6c66 2e73 6368 6564 756c 6572    self.scheduler
-0004f5e0: 203d 2073 6368 6564 756c 6572 0a20 2020   = scheduler.   
-0004f5f0: 2020 2020 2073 656c 662e 6e61 6d65 203d       self.name =
-0004f600: 206e 616d 650a 2020 2020 2020 2020 7365   name.        se
-0004f610: 6c66 2e6b 6579 7320 3d20 7365 7428 290a  lf.keys = set().
-0004f620: 2020 2020 2020 2020 7365 6c66 2e6d 6574          self.met
-0004f630: 6164 6174 6120 3d20 7b7d 0a20 2020 2020  adata = {}.     
-0004f640: 2020 2073 656c 662e 7374 6174 6520 3d20     self.state = 
-0004f650: 7b7d 0a0a 2020 2020 6465 6620 7570 6461  {}..    def upda
-0004f660: 7465 5f67 7261 7068 280a 2020 2020 2020  te_graph(.      
-0004f670: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-0004f680: 7363 6865 6475 6c65 723a 2053 6368 6564  scheduler: Sched
-0004f690: 756c 6572 2c0a 2020 2020 2020 2020 2a2c  uler,.        *,
-0004f6a0: 0a20 2020 2020 2020 206b 6579 733a 2073  .        keys: s
-0004f6b0: 6574 5b4b 6579 5d2c 0a20 2020 2020 2020  et[Key],.       
-0004f6c0: 202a 2a6b 7761 7267 733a 2041 6e79 2c0a   **kwargs: Any,.
-0004f6d0: 2020 2020 2920 2d3e 204e 6f6e 653a 0a20      ) -> None:. 
-0004f6e0: 2020 2020 2020 2073 656c 662e 6b65 7973         self.keys
-0004f6f0: 2e75 7064 6174 6528 6b65 7973 290a 0a20  .update(keys).. 
-0004f700: 2020 2064 6566 2074 7261 6e73 6974 696f     def transitio
-0004f710: 6e28 0a20 2020 2020 2020 2073 656c 662c  n(.        self,
-0004f720: 0a20 2020 2020 2020 206b 6579 3a20 4b65  .        key: Ke
-0004f730: 792c 0a20 2020 2020 2020 2073 7461 7274  y,.        start
-0004f740: 3a20 5461 736b 5374 6174 6553 7461 7465  : TaskStateState
-0004f750: 2c0a 2020 2020 2020 2020 6669 6e69 7368  ,.        finish
-0004f760: 3a20 5461 736b 5374 6174 6553 7461 7465  : TaskStateState
-0004f770: 2c0a 2020 2020 2020 2020 2a61 7267 733a  ,.        *args:
-0004f780: 2041 6e79 2c0a 2020 2020 2020 2020 2a2a   Any,.        **
-0004f790: 6b77 6172 6773 3a20 416e 792c 0a20 2020  kwargs: Any,.   
-0004f7a0: 2029 202d 3e20 4e6f 6e65 3a0a 2020 2020   ) -> None:.    
-0004f7b0: 2020 2020 6966 2066 696e 6973 6820 696e      if finish in
-0004f7c0: 2028 226d 656d 6f72 7922 2c20 2265 7272   ("memory", "err
-0004f7d0: 6564 2229 3a0a 2020 2020 2020 2020 2020  ed"):.          
-0004f7e0: 2020 7473 203d 2073 656c 662e 7363 6865    ts = self.sche
-0004f7f0: 6475 6c65 722e 7461 736b 732e 6765 7428  duler.tasks.get(
-0004f800: 6b65 7929 0a20 2020 2020 2020 2020 2020  key).           
-0004f810: 2069 6620 7473 2069 7320 6e6f 7420 4e6f   if ts is not No
-0004f820: 6e65 2061 6e64 2074 732e 6b65 7920 696e  ne and ts.key in
-0004f830: 2073 656c 662e 6b65 7973 3a0a 2020 2020   self.keys:.    
-0004f840: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0004f850: 2e6d 6574 6164 6174 615b 6b65 795d 203d  .metadata[key] =
-0004f860: 2074 732e 6d65 7461 6461 7461 0a20 2020   ts.metadata.   
-0004f870: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0004f880: 662e 7374 6174 655b 6b65 795d 203d 2066  f.state[key] = f
-0004f890: 696e 6973 680a 2020 2020 2020 2020 2020  inish.          
-0004f8a0: 2020 2020 2020 7365 6c66 2e6b 6579 732e        self.keys.
-0004f8b0: 6469 7363 6172 6428 6b65 7929 0a0a 0a64  discard(key)...d
-0004f8c0: 6566 205f 6d61 7465 7269 616c 697a 655f  ef _materialize_
-0004f8d0: 6772 6170 6828 0a20 2020 2067 7261 7068  graph(.    graph
-0004f8e0: 3a20 4869 6768 4c65 7665 6c47 7261 7068  : HighLevelGraph
-0004f8f0: 2c20 676c 6f62 616c 5f61 6e6e 6f74 6174  , global_annotat
-0004f900: 696f 6e73 3a20 6469 6374 5b73 7472 2c20  ions: dict[str, 
-0004f910: 416e 795d 0a29 202d 3e20 7475 706c 655b  Any].) -> tuple[
-0004f920: 6469 6374 5b4b 6579 2c20 545f 7275 6e73  dict[Key, T_runs
-0004f930: 7065 635d 2c20 6469 6374 5b4b 6579 2c20  pec], dict[Key, 
-0004f940: 7365 745b 4b65 795d 5d2c 2064 6963 745b  set[Key]], dict[
-0004f950: 7374 722c 2064 6963 745b 4b65 792c 2041  str, dict[Key, A
-0004f960: 6e79 5d5d 5d3a 0a20 2020 2064 736b 203d  ny]]]:.    dsk =
-0004f970: 2065 6e73 7572 655f 6469 6374 2867 7261   ensure_dict(gra
-0004f980: 7068 290a 2020 2020 666f 7220 6b20 696e  ph).    for k in
-0004f990: 2064 736b 3a0a 2020 2020 2020 2020 7661   dsk:.        va
-0004f9a0: 6c69 6461 7465 5f6b 6579 286b 290a 2020  lidate_key(k).  
-0004f9b0: 2020 616e 6e6f 7461 7469 6f6e 735f 6279    annotations_by
-0004f9c0: 5f74 7970 653a 2064 6566 6175 6c74 6469  _type: defaultdi
-0004f9d0: 6374 5b73 7472 2c20 6469 6374 5b4b 6579  ct[str, dict[Key
-0004f9e0: 2c20 416e 795d 5d20 3d20 6465 6661 756c  , Any]] = defaul
-0004f9f0: 7464 6963 7428 6469 6374 290a 2020 2020  tdict(dict).    
-0004fa00: 666f 7220 616e 6e6f 7461 7469 6f6e 735f  for annotations_
-0004fa10: 7479 7065 2c20 7661 6c75 6520 696e 2067  type, value in g
-0004fa20: 6c6f 6261 6c5f 616e 6e6f 7461 7469 6f6e  lobal_annotation
-0004fa30: 732e 6974 656d 7328 293a 0a20 2020 2020  s.items():.     
-0004fa40: 2020 2061 6e6e 6f74 6174 696f 6e73 5f62     annotations_b
-0004fa50: 795f 7479 7065 5b61 6e6e 6f74 6174 696f  y_type[annotatio
-0004fa60: 6e73 5f74 7970 655d 2e75 7064 6174 6528  ns_type].update(
-0004fa70: 0a20 2020 2020 2020 2020 2020 207b 6b3a  .            {k:
-0004fa80: 2028 7661 6c75 6528 6b29 2069 6620 6361   (value(k) if ca
-0004fa90: 6c6c 6162 6c65 2876 616c 7565 2920 656c  llable(value) el
-0004faa0: 7365 2076 616c 7565 2920 666f 7220 6b20  se value) for k 
-0004fab0: 696e 2064 736b 7d0a 2020 2020 2020 2020  in dsk}.        
-0004fac0: 290a 0a20 2020 2066 6f72 206c 6179 6572  )..    for layer
-0004fad0: 2069 6e20 6772 6170 682e 6c61 7965 7273   in graph.layers
-0004fae0: 2e76 616c 7565 7328 293a 0a20 2020 2020  .values():.     
-0004faf0: 2020 2069 6620 6c61 7965 722e 616e 6e6f     if layer.anno
-0004fb00: 7461 7469 6f6e 733a 0a20 2020 2020 2020  tations:.       
-0004fb10: 2020 2020 2061 6e6e 6f74 203d 206c 6179       annot = lay
-0004fb20: 6572 2e61 6e6e 6f74 6174 696f 6e73 0a20  er.annotations. 
-0004fb30: 2020 2020 2020 2020 2020 2066 6f72 2061             for a
-0004fb40: 6e6e 6f74 5f74 7970 652c 2076 616c 7565  nnot_type, value
-0004fb50: 2069 6e20 616e 6e6f 742e 6974 656d 7328   in annot.items(
-0004fb60: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0004fb70: 2020 2061 6e6e 6f74 6174 696f 6e73 5f62     annotations_b
-0004fb80: 795f 7479 7065 5b61 6e6e 6f74 5f74 7970  y_type[annot_typ
-0004fb90: 655d 2e75 7064 6174 6528 0a20 2020 2020  e].update(.     
-0004fba0: 2020 2020 2020 2020 2020 2020 2020 207b                 {
-0004fbb0: 6b3a 2028 7661 6c75 6528 6b29 2069 6620  k: (value(k) if 
-0004fbc0: 6361 6c6c 6162 6c65 2876 616c 7565 2920  callable(value) 
-0004fbd0: 656c 7365 2076 616c 7565 2920 666f 7220  else value) for 
-0004fbe0: 6b20 696e 206c 6179 6572 7d0a 2020 2020  k in layer}.    
-0004fbf0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0004fc00: 2020 6465 7065 6e64 656e 6369 6573 2c20    dependencies, 
-0004fc10: 5f20 3d20 6765 745f 6465 7073 2864 736b  _ = get_deps(dsk
-0004fc20: 290a 0a20 2020 2023 2052 656d 6f76 6520  )..    # Remove 
-0004fc30: 6046 7574 7572 6560 206f 626a 6563 7473  `Future` objects
-0004fc40: 2066 726f 6d20 6772 6170 6820 616e 6420   from graph and 
-0004fc50: 6e6f 7465 2061 6e79 2066 7574 7572 6520  note any future 
-0004fc60: 6465 7065 6e64 656e 6369 6573 0a20 2020  dependencies.   
-0004fc70: 2064 736b 3220 3d20 7b7d 0a20 2020 2066   dsk2 = {}.    f
-0004fc80: 7574 5f64 6570 7320 3d20 7b7d 0a20 2020  ut_deps = {}.   
-0004fc90: 2066 6f72 206b 2c20 7620 696e 2064 736b   for k, v in dsk
-0004fca0: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
-0004fcb0: 2020 762c 2066 7574 7320 3d20 756e 7061    v, futs = unpa
-0004fcc0: 636b 5f72 656d 6f74 6564 6174 6128 762c  ck_remotedata(v,
-0004fcd0: 2062 7974 655f 6b65 7973 3d54 7275 6529   byte_keys=True)
-0004fce0: 0a20 2020 2020 2020 2069 6620 6675 7473  .        if futs
-0004fcf0: 3a0a 2020 2020 2020 2020 2020 2020 6675  :.            fu
-0004fd00: 745f 6465 7073 5b6b 5d20 3d20 6675 7473  t_deps[k] = futs
-0004fd10: 0a0a 2020 2020 2020 2020 2320 5265 6d6f  ..        # Remo
-0004fd20: 7665 2061 6c69 6173 6573 207b 783a 2078  ve aliases {x: x
-0004fd30: 7d2e 0a20 2020 2020 2020 2023 2046 4958  }..        # FIX
-0004fd40: 4d45 3a20 5468 6973 2069 7320 616e 2061  ME: This is an a
-0004fd50: 7274 6966 6163 7420 6765 6e65 7261 7465  rtifact generate
-0004fd60: 6420 6279 2075 6e70 6163 6b5f 7265 6d6f  d by unpack_remo
-0004fd70: 7465 6461 7461 2077 6865 6e20 7573 696e  tedata when usin
-0004fd80: 6720 7065 7273 6973 7465 640a 2020 2020  g persisted.    
-0004fd90: 2020 2020 2320 636f 6c6c 6563 7469 6f6e      # collection
-0004fda0: 732e 2054 6865 7265 2073 686f 756c 6420  s. There should 
-0004fdb0: 6265 2061 2062 6574 7465 7220 7761 7920  be a better way 
-0004fdc0: 746f 2061 6368 6965 7665 2074 6861 7420  to achieve that 
-0004fdd0: 7461 736b 7320 6172 6520 6e6f 7420 7365  tasks are not se
-0004fde0: 6c66 0a20 2020 2020 2020 2023 2072 6566  lf.        # ref
-0004fdf0: 6572 656e 6369 6e67 2074 6865 6d73 656c  erencing themsel
-0004fe00: 7665 732e 0a20 2020 2020 2020 2069 6620  ves..        if 
-0004fe10: 6e6f 7420 6973 6b65 7928 7629 206f 7220  not iskey(v) or 
-0004fe20: 7620 213d 206b 3a0a 2020 2020 2020 2020  v != k:.        
-0004fe30: 2020 2020 6473 6b32 5b6b 5d20 3d20 760a      dsk2[k] = v.
-0004fe40: 0a20 2020 2064 736b 203d 2064 736b 320a  .    dsk = dsk2.
-0004fe50: 0a20 2020 2023 202d 2041 6464 2069 6e20  .    # - Add in 
-0004fe60: 6465 7073 2066 6f72 2061 6e79 2074 6173  deps for any tas
-0004fe70: 6b73 2074 6861 7420 6465 7065 6e64 206f  ks that depend o
-0004fe80: 6e20 6675 7475 7265 730a 2020 2020 666f  n futures.    fo
-0004fe90: 7220 6b2c 2066 7574 7572 6573 2069 6e20  r k, futures in 
-0004fea0: 6675 745f 6465 7073 2e69 7465 6d73 2829  fut_deps.items()
-0004feb0: 3a0a 2020 2020 2020 2020 6465 7065 6e64  :.        depend
-0004fec0: 656e 6369 6573 5b6b 5d2e 7570 6461 7465  encies[k].update
-0004fed0: 2866 2e6b 6579 2066 6f72 2066 2069 6e20  (f.key for f in 
-0004fee0: 6675 7475 7265 7329 0a0a 2020 2020 2320  futures)..    # 
-0004fef0: 5265 6d6f 7665 2061 6e79 2073 656c 662d  Remove any self-
-0004ff00: 6465 7065 6e64 656e 6369 6573 2028 6861  dependencies (ha
-0004ff10: 7070 656e 7320 6f6e 2074 6573 745f 7075  ppens on test_pu
-0004ff20: 626c 6973 685f 6261 6728 2920 616e 6420  blish_bag() and 
-0004ff30: 6f74 6865 7273 290a 2020 2020 666f 7220  others).    for 
-0004ff40: 6b2c 2076 2069 6e20 6465 7065 6e64 656e  k, v in dependen
-0004ff50: 6369 6573 2e69 7465 6d73 2829 3a0a 2020  cies.items():.  
-0004ff60: 2020 2020 2020 6465 7073 203d 2073 6574        deps = set
-0004ff70: 2876 290a 2020 2020 2020 2020 6465 7073  (v).        deps
-0004ff80: 2e64 6973 6361 7264 286b 290a 2020 2020  .discard(k).    
-0004ff90: 2020 2020 6465 7065 6e64 656e 6369 6573      dependencies
-0004ffa0: 5b6b 5d20 3d20 6465 7073 0a0a 2020 2020  [k] = deps..    
-0004ffb0: 6473 6b20 3d20 7661 6c6d 6170 285f 6e6f  dsk = valmap(_no
-0004ffc0: 726d 616c 697a 655f 7461 736b 2c20 6473  rmalize_task, ds
-0004ffd0: 6b29 0a20 2020 2072 6574 7572 6e20 6473  k).    return ds
-0004ffe0: 6b2c 2064 6570 656e 6465 6e63 6965 732c  k, dependencies,
-0004fff0: 2061 6e6e 6f74 6174 696f 6e73 5f62 795f   annotations_by_
-00050000: 7479 7065 0a                             type.
+000422c0: 2070 7265 765f 7374 6174 7573 3d70 7265   prev_status=pre
+000422d0: 765f 7374 6174 7573 2c0a 2020 2020 2020  v_status,.      
+000422e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000422f0: 2020 2020 2020 636c 6f73 653d 636c 6f73        close=clos
+00042300: 655f 776f 726b 6572 732c 0a20 2020 2020  e_workers,.     
+00042310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042320: 2020 2020 2020 2072 656d 6f76 653d 7265         remove=re
+00042330: 6d6f 7665 2c0a 2020 2020 2020 2020 2020  move,.          
+00042340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042350: 2020 7374 696d 756c 7573 5f69 643d 7374    stimulus_id=st
+00042360: 696d 756c 7573 5f69 642c 0a20 2020 2020  imulus_id,.     
+00042370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042380: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00042390: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+000423a0: 2020 2020 2020 2020 2020 2020 2320 4769              # Gi
+000423b0: 7665 2074 6865 2041 4d4d 2061 206b 6963  ve the AMM a kic
+000423c0: 6b2c 2069 6e20 6164 6469 7469 6f6e 2074  k, in addition t
+000423d0: 6f20 6974 7320 7065 7269 6f64 6963 2072  o its periodic r
+000423e0: 756e 6e69 6e67 2e20 5468 6973 2069 730a  unning. This is.
+000423f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042400: 2320 746f 2061 766f 6964 2075 6e6e 6563  # to avoid unnec
+00042410: 6573 7361 7269 6c79 2077 6169 7469 6e67  essarily waiting
+00042420: 2066 6f72 2061 2070 6f74 656e 7469 616c   for a potential
+00042430: 6c79 2061 7262 6974 7261 7269 6c79 206c  ly arbitrarily l
+00042440: 6f6e 670a 2020 2020 2020 2020 2020 2020  ong.            
+00042450: 2020 2020 2320 7469 6d65 2028 6465 7065      # time (depe
+00042460: 6e64 696e 6720 6f6e 2069 6e74 6572 7661  nding on interva
+00042470: 6c20 7365 7474 696e 6773 290a 2020 2020  l settings).    
+00042480: 2020 2020 2020 2020 2020 2020 616d 6d2e              amm.
+00042490: 7275 6e5f 6f6e 6365 2829 0a0a 2020 2020  run_once()..    
+000424a0: 2020 2020 2020 2020 2020 2020 776f 726b              work
+000424b0: 6572 735f 696e 666f 5f6f 6b20 3d20 7b7d  ers_info_ok = {}
+000424c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000424d0: 2077 6f72 6b65 7273 5f69 6e66 6f5f 6162   workers_info_ab
+000424e0: 6f72 7420 3d20 7b7d 0a20 2020 2020 2020  ort = {}.       
+000424f0: 2020 2020 2020 2020 2066 6f72 2061 6464           for add
+00042500: 722c 2072 6573 756c 742c 2069 6e66 6f20  r, result, info 
+00042510: 696e 2061 7761 6974 2061 7379 6e63 696f  in await asyncio
+00042520: 2e67 6174 6865 7228 2a63 6f72 6f73 293a  .gather(*coros):
+00042530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00042540: 2020 2020 2069 6620 7265 7375 6c74 203d       if result =
+00042550: 3d20 224f 4b22 3a0a 2020 2020 2020 2020  = "OK":.        
+00042560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042570: 776f 726b 6572 735f 696e 666f 5f6f 6b5b  workers_info_ok[
+00042580: 6164 6472 5d20 3d20 696e 666f 0a20 2020  addr] = info.   
+00042590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000425a0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000425b0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+000425c0: 6f72 6b65 7273 5f69 6e66 6f5f 6162 6f72  orkers_info_abor
+000425d0: 745b 6164 6472 5d20 3d20 696e 666f 0a0a  t[addr] = info..
+000425e0: 2020 2020 2020 2020 2020 2020 6669 6e61              fina
+000425f0: 6c6c 793a 0a20 2020 2020 2020 2020 2020  lly:.           
+00042600: 2020 2020 2069 6620 7374 6f70 5f61 6d6d       if stop_amm
+00042610: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00042620: 2020 2020 2020 616d 6d2e 7374 6f70 2829        amm.stop()
+00042630: 0a0a 2020 2020 2020 2020 7365 6c66 2e6c  ..        self.l
+00042640: 6f67 5f65 7665 6e74 280a 2020 2020 2020  og_event(.      
+00042650: 2020 2020 2020 2261 6c6c 222c 0a20 2020        "all",.   
+00042660: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00042670: 2020 2020 2020 2020 2020 2022 6163 7469             "acti
+00042680: 6f6e 223a 2022 7265 7469 7265 2d77 6f72  on": "retire-wor
+00042690: 6b65 7273 222c 0a20 2020 2020 2020 2020  kers",.         
+000426a0: 2020 2020 2020 2022 7265 7469 7265 6422         "retired"
+000426b0: 3a20 776f 726b 6572 735f 696e 666f 5f6f  : workers_info_o
+000426c0: 6b2c 0a20 2020 2020 2020 2020 2020 2020  k,.             
+000426d0: 2020 2022 636f 756c 642d 6e6f 742d 7265     "could-not-re
+000426e0: 7469 7265 223a 2077 6f72 6b65 7273 5f69  tire": workers_i
+000426f0: 6e66 6f5f 6162 6f72 742c 0a20 2020 2020  nfo_abort,.     
+00042700: 2020 2020 2020 2020 2020 2022 7374 696d             "stim
+00042710: 756c 7573 5f69 6422 3a20 7374 696d 756c  ulus_id": stimul
+00042720: 7573 5f69 642c 0a20 2020 2020 2020 2020  us_id,.         
+00042730: 2020 207d 2c0a 2020 2020 2020 2020 290a     },.        ).
+00042740: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
+00042750: 5f65 7665 6e74 280a 2020 2020 2020 2020  _event(.        
+00042760: 2020 2020 6c69 7374 2877 6f72 6b65 7273      list(workers
+00042770: 5f69 6e66 6f5f 6f6b 292c 0a20 2020 2020  _info_ok),.     
+00042780: 2020 2020 2020 207b 2261 6374 696f 6e22         {"action"
+00042790: 3a20 2272 6574 6972 6564 222c 2022 7374  : "retired", "st
+000427a0: 696d 756c 7573 5f69 6422 3a20 7374 696d  imulus_id": stim
+000427b0: 756c 7573 5f69 647d 2c0a 2020 2020 2020  ulus_id},.      
+000427c0: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
+000427d0: 2e6c 6f67 5f65 7665 6e74 280a 2020 2020  .log_event(.    
+000427e0: 2020 2020 2020 2020 6c69 7374 2877 6f72          list(wor
+000427f0: 6b65 7273 5f69 6e66 6f5f 6162 6f72 7429  kers_info_abort)
+00042800: 2c0a 2020 2020 2020 2020 2020 2020 7b22  ,.            {"
+00042810: 6163 7469 6f6e 223a 2022 636f 756c 642d  action": "could-
+00042820: 6e6f 742d 7265 7469 7265 222c 2022 7374  not-retire", "st
+00042830: 696d 756c 7573 5f69 6422 3a20 7374 696d  imulus_id": stim
+00042840: 756c 7573 5f69 647d 2c0a 2020 2020 2020  ulus_id},.      
+00042850: 2020 290a 0a20 2020 2020 2020 2072 6574    )..        ret
+00042860: 7572 6e20 776f 726b 6572 735f 696e 666f  urn workers_info
+00042870: 5f6f 6b0a 0a20 2020 2061 7379 6e63 2064  _ok..    async d
+00042880: 6566 205f 7472 6163 6b5f 7265 7469 7265  ef _track_retire
+00042890: 5f77 6f72 6b65 7228 0a20 2020 2020 2020  _worker(.       
+000428a0: 2073 656c 662c 0a20 2020 2020 2020 2077   self,.        w
+000428b0: 733a 2057 6f72 6b65 7253 7461 7465 2c0a  s: WorkerState,.
+000428c0: 2020 2020 2020 2020 706f 6c69 6379 3a20          policy: 
+000428d0: 5265 7469 7265 576f 726b 6572 2c0a 2020  RetireWorker,.  
+000428e0: 2020 2020 2020 7072 6576 5f73 7461 7475        prev_statu
+000428f0: 733a 2053 7461 7475 732c 0a20 2020 2020  s: Status,.     
+00042900: 2020 2063 6c6f 7365 3a20 626f 6f6c 2c0a     close: bool,.
+00042910: 2020 2020 2020 2020 7265 6d6f 7665 3a20          remove: 
+00042920: 626f 6f6c 2c0a 2020 2020 2020 2020 7374  bool,.        st
+00042930: 696d 756c 7573 5f69 643a 2073 7472 2c0a  imulus_id: str,.
+00042940: 2020 2020 2920 2d3e 2074 7570 6c65 5b73      ) -> tuple[s
+00042950: 7472 2c20 4c69 7465 7261 6c5b 224f 4b22  tr, Literal["OK"
+00042960: 2c20 226e 6f2d 7265 6369 7069 656e 7473  , "no-recipients
+00042970: 225d 2c20 6469 6374 5d3a 0a20 2020 2020  "], dict]:.     
+00042980: 2020 2077 6869 6c65 206e 6f74 2070 6f6c     while not pol
+00042990: 6963 792e 646f 6e65 2829 3a0a 2020 2020  icy.done():.    
+000429a0: 2020 2020 2020 2020 2320 536c 6565 7020          # Sleep 
+000429b0: 302e 3031 7320 7768 656e 2074 6865 7265  0.01s when there
+000429c0: 2061 7265 2034 2074 6173 6b73 206f 7220   are 4 tasks or 
+000429d0: 6c65 7373 0a20 2020 2020 2020 2020 2020  less.           
+000429e0: 2023 2053 6c65 6570 2030 2e35 7320 7768   # Sleep 0.5s wh
+000429f0: 656e 2074 6865 7265 2061 7265 2032 3030  en there are 200
+00042a00: 206f 7220 6d6f 7265 0a20 2020 2020 2020   or more.       
+00042a10: 2020 2020 2070 6f6c 6c5f 696e 7465 7276       poll_interv
+00042a20: 616c 203d 206d 6178 2830 2e30 312c 206d  al = max(0.01, m
+00042a30: 696e 2830 2e35 2c20 6c65 6e28 7773 2e68  in(0.5, len(ws.h
+00042a40: 6173 5f77 6861 7429 202f 2034 3030 2929  as_what) / 400))
+00042a50: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
+00042a60: 6974 2061 7379 6e63 696f 2e73 6c65 6570  it asyncio.sleep
+00042a70: 2870 6f6c 6c5f 696e 7465 7276 616c 290a  (poll_interval).
+00042a80: 0a20 2020 2020 2020 2069 6620 706f 6c69  .        if poli
+00042a90: 6379 2e6e 6f5f 7265 6369 7069 656e 7473  cy.no_recipients
+00042aa0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+00042ab0: 4162 6f72 7420 7265 7469 7265 6d65 6e74  Abort retirement
+00042ac0: 2e20 5468 6973 2074 696d 6520 7765 2064  . This time we d
+00042ad0: 6f6e 2774 206e 6565 6420 746f 2077 6f72  on't need to wor
+00042ae0: 7279 2061 626f 7574 2072 6163 650a 2020  ry about race.  
+00042af0: 2020 2020 2020 2020 2020 2320 636f 6e64            # cond
+00042b00: 6974 696f 6e73 2061 6e64 2077 6520 6361  itions and we ca
+00042b10: 6e20 7761 6974 2066 6f72 2061 2073 6368  n wait for a sch
+00042b20: 6564 756c 6572 2d3e 776f 726b 6572 2d3e  eduler->worker->
+00042b30: 7363 6865 6475 6c65 720a 2020 2020 2020  scheduler.      
+00042b40: 2020 2020 2020 2320 726f 756e 642d 7472        # round-tr
+00042b50: 6970 2e0a 2020 2020 2020 2020 2020 2020  ip..            
+00042b60: 7365 6c66 2e73 7472 6561 6d5f 636f 6d6d  self.stream_comm
+00042b70: 735b 7773 2e61 6464 7265 7373 5d2e 7365  s[ws.address].se
+00042b80: 6e64 280a 2020 2020 2020 2020 2020 2020  nd(.            
+00042b90: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+00042ba0: 2020 2020 2020 2020 2020 226f 7022 3a20            "op": 
+00042bb0: 2277 6f72 6b65 722d 7374 6174 7573 2d63  "worker-status-c
+00042bc0: 6861 6e67 6522 2c0a 2020 2020 2020 2020  hange",.        
+00042bd0: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
+00042be0: 7475 7322 3a20 7072 6576 5f73 7461 7475  tus": prev_statu
+00042bf0: 732e 6e61 6d65 2c0a 2020 2020 2020 2020  s.name,.        
+00042c00: 2020 2020 2020 2020 2020 2020 2273 7469              "sti
+00042c10: 6d75 6c75 735f 6964 223a 2073 7469 6d75  mulus_id": stimu
+00042c20: 6c75 735f 6964 2c0a 2020 2020 2020 2020  lus_id,.        
+00042c30: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00042c40: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00042c50: 2020 2020 6c6f 6767 6572 2e77 6172 6e69      logger.warni
+00042c60: 6e67 280a 2020 2020 2020 2020 2020 2020  ng(.            
+00042c70: 2020 2020 6622 436f 756c 6420 6e6f 7420      f"Could not 
+00042c80: 7265 7469 7265 2077 6f72 6b65 7220 7b77  retire worker {w
+00042c90: 732e 6164 6472 6573 7321 727d 3a20 756e  s.address!r}: un
+00042ca0: 6971 7565 2064 6174 6120 636f 756c 6420  ique data could 
+00042cb0: 6e6f 7420 6265 2022 0a20 2020 2020 2020  not be ".       
+00042cc0: 2020 2020 2020 2020 2066 226d 6f76 6564           f"moved
+00042cd0: 2074 6f20 616e 7920 6f74 6865 7220 776f   to any other wo
+00042ce0: 726b 6572 2028 7b73 7469 6d75 6c75 735f  rker ({stimulus_
+00042cf0: 6964 3d21 727d 2922 0a20 2020 2020 2020  id=!r})".       
+00042d00: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00042d10: 2020 2072 6574 7572 6e20 7773 2e61 6464     return ws.add
+00042d20: 7265 7373 2c20 226e 6f2d 7265 6369 7069  ress, "no-recipi
+00042d30: 656e 7473 222c 2077 732e 6964 656e 7469  ents", ws.identi
+00042d40: 7479 2829 0a0a 2020 2020 2020 2020 6c6f  ty()..        lo
+00042d50: 6767 6572 2e64 6562 7567 280a 2020 2020  gger.debug(.    
+00042d60: 2020 2020 2020 2020 6622 416c 6c20 756e          f"All un
+00042d70: 6971 7565 206b 6579 7320 6f6e 2077 6f72  ique keys on wor
+00042d80: 6b65 7220 7b77 732e 6164 6472 6573 7321  ker {ws.address!
+00042d90: 727d 2068 6176 6520 6265 656e 2072 6570  r} have been rep
+00042da0: 6c69 6361 7465 6420 656c 7365 7768 6572  licated elsewher
+00042db0: 6522 0a20 2020 2020 2020 2029 0a0a 2020  e".        )..  
+00042dc0: 2020 2020 2020 6966 2072 656d 6f76 653a        if remove:
+00042dd0: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
+00042de0: 6974 2073 656c 662e 7265 6d6f 7665 5f77  it self.remove_w
+00042df0: 6f72 6b65 7228 0a20 2020 2020 2020 2020  orker(.         
+00042e00: 2020 2020 2020 2077 732e 6164 6472 6573         ws.addres
+00042e10: 732c 2073 6166 653d 5472 7565 2c20 636c  s, safe=True, cl
+00042e20: 6f73 653d 636c 6f73 652c 2073 7469 6d75  ose=close, stimu
+00042e30: 6c75 735f 6964 3d73 7469 6d75 6c75 735f  lus_id=stimulus_
+00042e40: 6964 0a20 2020 2020 2020 2020 2020 2029  id.            )
+00042e50: 0a20 2020 2020 2020 2065 6c69 6620 636c  .        elif cl
+00042e60: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
+00042e70: 2073 656c 662e 636c 6f73 655f 776f 726b   self.close_work
+00042e80: 6572 2877 732e 6164 6472 6573 7329 0a0a  er(ws.address)..
+00042e90: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
+00042ea0: 6e66 6f28 6622 5265 7469 7265 6420 776f  nfo(f"Retired wo
+00042eb0: 726b 6572 207b 7773 2e61 6464 7265 7373  rker {ws.address
+00042ec0: 2172 7d20 287b 7374 696d 756c 7573 5f69  !r} ({stimulus_i
+00042ed0: 643d 2172 7d29 2229 0a20 2020 2020 2020  d=!r})").       
+00042ee0: 2072 6574 7572 6e20 7773 2e61 6464 7265   return ws.addre
+00042ef0: 7373 2c20 224f 4b22 2c20 7773 2e69 6465  ss, "OK", ws.ide
+00042f00: 6e74 6974 7928 290a 0a20 2020 2064 6566  ntity()..    def
+00042f10: 2061 6464 5f6b 6579 7328 0a20 2020 2020   add_keys(.     
+00042f20: 2020 2073 656c 662c 2077 6f72 6b65 723a     self, worker:
+00042f30: 2073 7472 2c20 6b65 7973 3a20 436f 6c6c   str, keys: Coll
+00042f40: 6563 7469 6f6e 5b4b 6579 5d20 3d20 2829  ection[Key] = ()
+00042f50: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
+00042f60: 7472 207c 204e 6f6e 6520 3d20 4e6f 6e65  tr | None = None
+00042f70: 0a20 2020 2029 202d 3e20 4c69 7465 7261  .    ) -> Litera
+00042f80: 6c5b 224f 4b22 2c20 226e 6f74 2066 6f75  l["OK", "not fou
+00042f90: 6e64 225d 3a0a 2020 2020 2020 2020 2222  nd"]:.        ""
+00042fa0: 220a 2020 2020 2020 2020 4c65 6172 6e20  ".        Learn 
+00042fb0: 7468 6174 2061 2077 6f72 6b65 7220 6861  that a worker ha
+00042fc0: 7320 6365 7274 6169 6e20 6b65 7973 0a0a  s certain keys..
+00042fd0: 2020 2020 2020 2020 5468 6973 2073 686f          This sho
+00042fe0: 756c 6420 6e6f 7420 6265 2075 7365 6420  uld not be used 
+00042ff0: 696e 2070 7261 6374 6963 6520 616e 6420  in practice and 
+00043000: 6973 206d 6f73 746c 7920 6865 7265 2066  is mostly here f
+00043010: 6f72 206c 6567 6163 790a 2020 2020 2020  or legacy.      
+00043020: 2020 7265 6173 6f6e 732e 2020 486f 7765    reasons.  Howe
+00043030: 7665 722c 2069 7420 6973 2073 656e 7420  ver, it is sent 
+00043040: 6279 2077 6f72 6b65 7273 2066 726f 6d20  by workers from 
+00043050: 7469 6d65 2074 6f20 7469 6d65 2e0a 2020  time to time..  
+00043060: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00043070: 2020 6966 2077 6f72 6b65 7220 6e6f 7420    if worker not 
+00043080: 696e 2073 656c 662e 776f 726b 6572 733a  in self.workers:
+00043090: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+000430a0: 7572 6e20 226e 6f74 2066 6f75 6e64 220a  urn "not found".
+000430b0: 2020 2020 2020 2020 7773 203d 2073 656c          ws = sel
+000430c0: 662e 776f 726b 6572 735b 776f 726b 6572  f.workers[worker
+000430d0: 5d0a 2020 2020 2020 2020 7265 6475 6e64  ].        redund
+000430e0: 616e 745f 7265 706c 6963 6173 203d 205b  ant_replicas = [
+000430f0: 5d0a 2020 2020 2020 2020 666f 7220 6b65  ].        for ke
+00043100: 7920 696e 206b 6579 733a 0a20 2020 2020  y in keys:.     
+00043110: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
+00043120: 2e74 6173 6b73 2e67 6574 286b 6579 290a  .tasks.get(key).
+00043130: 2020 2020 2020 2020 2020 2020 6966 2074              if t
+00043140: 7320 6973 206e 6f74 204e 6f6e 6520 616e  s is not None an
+00043150: 6420 7473 2e73 7461 7465 203d 3d20 226d  d ts.state == "m
+00043160: 656d 6f72 7922 3a0a 2020 2020 2020 2020  emory":.        
+00043170: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
+00043180: 5f72 6570 6c69 6361 2874 732c 2077 7329  _replica(ts, ws)
+00043190: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+000431a0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+000431b0: 2020 2072 6564 756e 6461 6e74 5f72 6570     redundant_rep
+000431c0: 6c69 6361 732e 6170 7065 6e64 286b 6579  licas.append(key
+000431d0: 290a 0a20 2020 2020 2020 2069 6620 7265  )..        if re
+000431e0: 6475 6e64 616e 745f 7265 706c 6963 6173  dundant_replicas
+000431f0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00043200: 206e 6f74 2073 7469 6d75 6c75 735f 6964   not stimulus_id
+00043210: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00043220: 2020 7374 696d 756c 7573 5f69 6420 3d20    stimulus_id = 
+00043230: 6622 7265 6475 6e64 616e 742d 7265 706c  f"redundant-repl
+00043240: 6963 6173 2d7b 7469 6d65 2829 7d22 0a20  icas-{time()}". 
+00043250: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00043260: 776f 726b 6572 5f73 656e 6428 0a20 2020  worker_send(.   
+00043270: 2020 2020 2020 2020 2020 2020 2077 6f72               wor
+00043280: 6b65 722c 0a20 2020 2020 2020 2020 2020  ker,.           
+00043290: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+000432a0: 2020 2020 2020 2020 2020 2022 6f70 223a             "op":
+000432b0: 2022 7265 6d6f 7665 2d72 6570 6c69 6361   "remove-replica
+000432c0: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
+000432d0: 2020 2020 2020 2020 226b 6579 7322 3a20          "keys": 
+000432e0: 7265 6475 6e64 616e 745f 7265 706c 6963  redundant_replic
+000432f0: 6173 2c0a 2020 2020 2020 2020 2020 2020  as,.            
+00043300: 2020 2020 2020 2020 2273 7469 6d75 6c75          "stimulu
+00043310: 735f 6964 223a 2073 7469 6d75 6c75 735f  s_id": stimulus_
+00043320: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
+00043330: 2020 2020 7d2c 0a20 2020 2020 2020 2020      },.         
+00043340: 2020 2029 0a0a 2020 2020 2020 2020 7265     )..        re
+00043350: 7475 726e 2022 4f4b 220a 0a20 2020 2040  turn "OK"..    @
+00043360: 6c6f 675f 6572 726f 7273 0a20 2020 2064  log_errors.    d
+00043370: 6566 2075 7064 6174 655f 6461 7461 280a  ef update_data(.
+00043380: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+00043390: 2020 2020 2020 2a2c 0a20 2020 2020 2020        *,.       
+000433a0: 2077 686f 5f68 6173 3a20 6469 6374 5b4b   who_has: dict[K
+000433b0: 6579 2c20 6c69 7374 5b73 7472 5d5d 2c0a  ey, list[str]],.
+000433c0: 2020 2020 2020 2020 6e62 7974 6573 3a20          nbytes: 
+000433d0: 6469 6374 5b4b 6579 2c20 696e 745d 2c0a  dict[Key, int],.
+000433e0: 2020 2020 2020 2020 636c 6965 6e74 3a20          client: 
+000433f0: 7374 7220 7c20 4e6f 6e65 203d 204e 6f6e  str | None = Non
+00043400: 652c 0a20 2020 2029 202d 3e20 4e6f 6e65  e,.    ) -> None
+00043410: 3a0a 2020 2020 2020 2020 2222 224c 6561  :.        """Lea
+00043420: 726e 2074 6861 7420 6e65 7720 6461 7461  rn that new data
+00043430: 2068 6173 2065 6e74 6572 6564 2074 6865   has entered the
+00043440: 206e 6574 776f 726b 2066 726f 6d20 616e   network from an
+00043450: 2065 7874 6572 6e61 6c20 736f 7572 6365   external source
+00043460: 2222 220a 2020 2020 2020 2020 7768 6f5f  """.        who_
+00043470: 6861 7320 3d20 7b6b 3a20 5b73 656c 662e  has = {k: [self.
+00043480: 636f 6572 6365 5f61 6464 7265 7373 2876  coerce_address(v
+00043490: 7629 2066 6f72 2076 7620 696e 2076 5d20  v) for vv in v] 
+000434a0: 666f 7220 6b2c 2076 2069 6e20 7768 6f5f  for k, v in who_
+000434b0: 6861 732e 6974 656d 7328 297d 0a20 2020  has.items()}.   
+000434c0: 2020 2020 206c 6f67 6765 722e 6465 6275       logger.debu
+000434d0: 6728 2255 7064 6174 6520 6461 7461 2025  g("Update data %
+000434e0: 7322 2c20 7768 6f5f 6861 7329 0a0a 2020  s", who_has)..  
+000434f0: 2020 2020 2020 666f 7220 6b65 792c 2077        for key, w
+00043500: 6f72 6b65 7273 2069 6e20 7768 6f5f 6861  orkers in who_ha
+00043510: 732e 6974 656d 7328 293a 0a20 2020 2020  s.items():.     
+00043520: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
+00043530: 2e74 6173 6b73 2e67 6574 286b 6579 290a  .tasks.get(key).
+00043540: 2020 2020 2020 2020 2020 2020 6966 2074              if t
+00043550: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
+00043560: 2020 2020 2020 2020 2020 2074 7320 3d20             ts = 
+00043570: 7365 6c66 2e6e 6577 5f74 6173 6b28 6b65  self.new_task(ke
+00043580: 792c 204e 6f6e 652c 2022 6d65 6d6f 7279  y, None, "memory
+00043590: 2229 0a20 2020 2020 2020 2020 2020 2074  ").            t
+000435a0: 732e 7374 6174 6520 3d20 226d 656d 6f72  s.state = "memor
+000435b0: 7922 0a20 2020 2020 2020 2020 2020 2074  y".            t
+000435c0: 735f 6e62 7974 6573 203d 206e 6279 7465  s_nbytes = nbyte
+000435d0: 732e 6765 7428 6b65 792c 202d 3129 0a20  s.get(key, -1). 
+000435e0: 2020 2020 2020 2020 2020 2069 6620 7473             if ts
+000435f0: 5f6e 6279 7465 7320 3e3d 2030 3a0a 2020  _nbytes >= 0:.  
+00043600: 2020 2020 2020 2020 2020 2020 2020 7473                ts
+00043610: 2e73 6574 5f6e 6279 7465 7328 7473 5f6e  .set_nbytes(ts_n
+00043620: 6279 7465 7329 0a0a 2020 2020 2020 2020  bytes)..        
+00043630: 2020 2020 666f 7220 7720 696e 2077 6f72      for w in wor
+00043640: 6b65 7273 3a0a 2020 2020 2020 2020 2020  kers:.          
+00043650: 2020 2020 2020 7773 203d 2073 656c 662e        ws = self.
+00043660: 776f 726b 6572 735b 775d 0a20 2020 2020  workers[w].     
+00043670: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00043680: 6164 645f 7265 706c 6963 6128 7473 2c20  add_replica(ts, 
+00043690: 7773 290a 2020 2020 2020 2020 2020 2020  ws).            
+000436a0: 7365 6c66 2e72 6570 6f72 7428 7b22 6f70  self.report({"op
+000436b0: 223a 2022 6b65 792d 696e 2d6d 656d 6f72  ": "key-in-memor
+000436c0: 7922 2c20 226b 6579 223a 206b 6579 2c20  y", "key": key, 
+000436d0: 2277 6f72 6b65 7273 223a 206c 6973 7428  "workers": list(
+000436e0: 776f 726b 6572 7329 7d29 0a0a 2020 2020  workers)})..    
+000436f0: 2020 2020 6966 2063 6c69 656e 743a 0a20      if client:. 
+00043700: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00043710: 636c 6965 6e74 5f64 6573 6972 6573 5f6b  client_desires_k
+00043720: 6579 7328 6b65 7973 3d6c 6973 7428 7768  eys(keys=list(wh
+00043730: 6f5f 6861 7329 2c20 636c 6965 6e74 3d63  o_has), client=c
+00043740: 6c69 656e 7429 0a0a 2020 2020 406f 7665  lient)..    @ove
+00043750: 726c 6f61 640a 2020 2020 6465 6620 7265  rload.    def re
+00043760: 706f 7274 5f6f 6e5f 6b65 7928 7365 6c66  port_on_key(self
+00043770: 2c20 6b65 793a 204b 6579 2c20 2a2c 2063  , key: Key, *, c
+00043780: 6c69 656e 743a 2073 7472 207c 204e 6f6e  lient: str | Non
+00043790: 6520 3d20 4e6f 6e65 2920 2d3e 204e 6f6e  e = None) -> Non
+000437a0: 653a 0a20 2020 2020 2020 202e 2e2e 0a0a  e:.        .....
+000437b0: 2020 2020 406f 7665 726c 6f61 640a 2020      @overload.  
+000437c0: 2020 6465 6620 7265 706f 7274 5f6f 6e5f    def report_on_
+000437d0: 6b65 7928 7365 6c66 2c20 2a2c 2074 733a  key(self, *, ts:
+000437e0: 2054 6173 6b53 7461 7465 2c20 636c 6965   TaskState, clie
+000437f0: 6e74 3a20 7374 7220 7c20 4e6f 6e65 203d  nt: str | None =
+00043800: 204e 6f6e 6529 202d 3e20 4e6f 6e65 3a0a   None) -> None:.
+00043810: 2020 2020 2020 2020 2e2e 2e0a 0a20 2020          .....   
+00043820: 2064 6566 2072 6570 6f72 745f 6f6e 5f6b   def report_on_k
+00043830: 6579 2873 656c 662c 206b 6579 3d4e 6f6e  ey(self, key=Non
+00043840: 652c 202a 2c20 7473 3d4e 6f6e 652c 2063  e, *, ts=None, c
+00043850: 6c69 656e 743d 4e6f 6e65 293a 0a20 2020  lient=None):.   
+00043860: 2020 2020 2069 6620 2874 7320 6973 204e       if (ts is N
+00043870: 6f6e 6529 203d 3d20 286b 6579 2069 7320  one) == (key is 
+00043880: 4e6f 6e65 293a 0a20 2020 2020 2020 2020  None):.         
+00043890: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+000438a0: 726f 7228 2020 2320 7072 6167 6d61 3a20  ror(  # pragma: 
+000438b0: 6e6f 636f 7665 720a 2020 2020 2020 2020  nocover.        
+000438c0: 2020 2020 2020 2020 6622 7473 2061 6e64          f"ts and
+000438d0: 206b 6579 2061 7265 206d 7574 7561 6c6c   key are mutuall
+000438e0: 7920 6578 636c 7573 6976 653b 2072 6563  y exclusive; rec
+000438f0: 6569 7665 6420 7b6b 6579 3d21 727d 2c20  eived {key=!r}, 
+00043900: 7b74 733d 2172 7d22 0a20 2020 2020 2020  {ts=!r}".       
+00043910: 2020 2020 2029 0a20 2020 2020 2020 2069       ).        i
+00043920: 6620 7473 2069 7320 4e6f 6e65 3a0a 2020  f ts is None:.  
+00043930: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00043940: 206b 6579 2069 7320 6e6f 7420 4e6f 6e65   key is not None
+00043950: 0a20 2020 2020 2020 2020 2020 2074 7320  .            ts 
+00043960: 3d20 7365 6c66 2e74 6173 6b73 2e67 6574  = self.tasks.get
+00043970: 286b 6579 290a 2020 2020 2020 2020 656c  (key).        el
+00043980: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00043990: 6b65 7920 3d20 7473 2e6b 6579 0a0a 2020  key = ts.key..  
+000439a0: 2020 2020 2020 6966 2074 7320 6973 206e        if ts is n
+000439b0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+000439c0: 2020 2020 2072 6570 6f72 745f 6d73 6720       report_msg 
+000439d0: 3d20 5f74 6173 6b5f 746f 5f72 6570 6f72  = _task_to_repor
+000439e0: 745f 6d73 6728 7473 290a 2020 2020 2020  t_msg(ts).      
+000439f0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00043a00: 2020 2020 7265 706f 7274 5f6d 7367 203d      report_msg =
+00043a10: 207b 226f 7022 3a20 2263 616e 6365 6c6c   {"op": "cancell
+00043a20: 6564 2d6b 6579 7322 2c20 226b 6579 7322  ed-keys", "keys"
+00043a30: 3a20 5b6b 6579 5d7d 0a20 2020 2020 2020  : [key]}.       
+00043a40: 2069 6620 7265 706f 7274 5f6d 7367 2069   if report_msg i
+00043a50: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00043a60: 2020 2020 2020 2020 7365 6c66 2e72 6570          self.rep
+00043a70: 6f72 7428 7265 706f 7274 5f6d 7367 2c20  ort(report_msg, 
+00043a80: 7473 3d74 732c 2063 6c69 656e 743d 636c  ts=ts, client=cl
+00043a90: 6965 6e74 290a 0a20 2020 2040 6c6f 675f  ient)..    @log_
+00043aa0: 6572 726f 7273 0a20 2020 2061 7379 6e63  errors.    async
+00043ab0: 2064 6566 2066 6565 6428 0a20 2020 2020   def feed(.     
+00043ac0: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+00043ad0: 2063 6f6d 6d3a 2043 6f6d 6d2c 0a20 2020   comm: Comm,.   
+00043ae0: 2020 2020 2066 756e 6374 696f 6e3a 2062       function: b
+00043af0: 7974 6573 207c 204e 6f6e 6520 3d20 4e6f  ytes | None = No
+00043b00: 6e65 2c0a 2020 2020 2020 2020 7365 7475  ne,.        setu
+00043b10: 703a 2062 7974 6573 207c 204e 6f6e 6520  p: bytes | None 
+00043b20: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00043b30: 7465 6172 646f 776e 3a20 6279 7465 7320  teardown: bytes 
+00043b40: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
+00043b50: 2020 2020 2020 2069 6e74 6572 7661 6c3a         interval:
+00043b60: 2073 7472 207c 2066 6c6f 6174 203d 2022   str | float = "
+00043b70: 3173 222c 0a20 2020 2020 2020 202a 2a6b  1s",.        **k
+00043b80: 7761 7267 733a 2041 6e79 2c0a 2020 2020  wargs: Any,.    
+00043b90: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00043ba0: 2020 2022 2222 0a20 2020 2020 2020 2050     """.        P
+00043bb0: 726f 7669 6465 7320 6120 6461 7461 2043  rovides a data C
+00043bc0: 6f6d 6d20 746f 2065 7874 6572 6e61 6c20  omm to external 
+00043bd0: 7265 7175 6573 7465 720a 0a20 2020 2020  requester..     
+00043be0: 2020 2043 6175 7469 6f6e 3a20 7468 6973     Caution: this
+00043bf0: 2072 756e 7320 6172 6269 7472 6172 7920   runs arbitrary 
+00043c00: 5079 7468 6f6e 2063 6f64 6520 6f6e 2074  Python code on t
+00043c10: 6865 2073 6368 6564 756c 6572 2e20 2054  he scheduler.  T
+00043c20: 6869 7320 7368 6f75 6c64 0a20 2020 2020  his should.     
+00043c30: 2020 2065 7665 6e74 7561 6c6c 7920 6265     eventually be
+00043c40: 2070 6861 7365 6420 6f75 742e 2020 4974   phased out.  It
+00043c50: 2069 7320 6d6f 7374 6c79 2075 7365 6420   is mostly used 
+00043c60: 6279 2064 6961 676e 6f73 7469 6373 2e0a  by diagnostics..
+00043c70: 2020 2020 2020 2020 2222 220a 0a20 2020          """..   
+00043c80: 2020 2020 2069 6e74 6572 7661 6c20 3d20       interval = 
+00043c90: 7061 7273 655f 7469 6d65 6465 6c74 6128  parse_timedelta(
+00043ca0: 696e 7465 7276 616c 290a 2020 2020 2020  interval).      
+00043cb0: 2020 6966 2066 756e 6374 696f 6e3a 0a20    if function:. 
+00043cc0: 2020 2020 2020 2020 2020 2066 756e 6374             funct
+00043cd0: 696f 6e20 3d20 7069 636b 6c65 2e6c 6f61  ion = pickle.loa
+00043ce0: 6473 2866 756e 6374 696f 6e29 0a20 2020  ds(function).   
+00043cf0: 2020 2020 2069 6620 7365 7475 703a 0a20       if setup:. 
+00043d00: 2020 2020 2020 2020 2020 2073 6574 7570             setup
+00043d10: 203d 2070 6963 6b6c 652e 6c6f 6164 7328   = pickle.loads(
+00043d20: 7365 7475 7029 0a0a 2020 2020 2020 2020  setup)..        
+00043d30: 6966 2074 6561 7264 6f77 6e3a 0a20 2020  if teardown:.   
+00043d40: 2020 2020 2020 2020 2074 6561 7264 6f77           teardow
+00043d50: 6e20 3d20 7069 636b 6c65 2e6c 6f61 6473  n = pickle.loads
+00043d60: 2874 6561 7264 6f77 6e29 0a20 2020 2020  (teardown).     
+00043d70: 2020 2073 7461 7465 203d 2073 6574 7570     state = setup
+00043d80: 2873 656c 6629 2069 6620 7365 7475 7020  (self) if setup 
+00043d90: 656c 7365 204e 6f6e 6520 2023 2074 7970  else None  # typ
+00043da0: 653a 2069 676e 6f72 650a 2020 2020 2020  e: ignore.      
+00043db0: 2020 6966 2069 6e73 7065 6374 2e69 7361    if inspect.isa
+00043dc0: 7761 6974 6162 6c65 2873 7461 7465 293a  waitable(state):
+00043dd0: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
+00043de0: 7465 203d 2061 7761 6974 2073 7461 7465  te = await state
+00043df0: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
+00043e00: 2020 2020 2020 2020 2020 7768 696c 6520            while 
+00043e10: 7365 6c66 2e73 7461 7475 7320 3d3d 2053  self.status == S
+00043e20: 7461 7475 732e 7275 6e6e 696e 673a 0a20  tatus.running:. 
+00043e30: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00043e40: 6620 7374 6174 6520 6973 204e 6f6e 653a  f state is None:
+00043e50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00043e60: 2020 2020 2072 6573 706f 6e73 6520 3d20       response = 
+00043e70: 6675 6e63 7469 6f6e 2873 656c 6629 2020  function(self)  
+00043e80: 2320 7479 7065 3a20 6967 6e6f 7265 0a20  # type: ignore. 
+00043e90: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00043ea0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00043eb0: 2020 2020 2020 2020 2072 6573 706f 6e73           respons
+00043ec0: 6520 3d20 6675 6e63 7469 6f6e 2873 656c  e = function(sel
+00043ed0: 662c 2073 7461 7465 2920 2023 2074 7970  f, state)  # typ
+00043ee0: 653a 2069 676e 6f72 650a 2020 2020 2020  e: ignore.      
+00043ef0: 2020 2020 2020 2020 2020 6177 6169 7420            await 
+00043f00: 636f 6d6d 2e77 7269 7465 2872 6573 706f  comm.write(respo
+00043f10: 6e73 6529 0a20 2020 2020 2020 2020 2020  nse).           
+00043f20: 2020 2020 2061 7761 6974 2061 7379 6e63       await async
+00043f30: 696f 2e73 6c65 6570 2869 6e74 6572 7661  io.sleep(interva
+00043f40: 6c29 0a20 2020 2020 2020 2065 7863 6570  l).        excep
+00043f50: 7420 4f53 4572 726f 723a 0a20 2020 2020  t OSError:.     
+00043f60: 2020 2020 2020 2070 6173 730a 2020 2020         pass.    
+00043f70: 2020 2020 6669 6e61 6c6c 793a 0a20 2020      finally:.   
+00043f80: 2020 2020 2020 2020 2069 6620 7465 6172           if tear
+00043f90: 646f 776e 3a0a 2020 2020 2020 2020 2020  down:.          
+00043fa0: 2020 2020 2020 7465 6172 646f 776e 2873        teardown(s
+00043fb0: 656c 662c 2073 7461 7465 2920 2023 2074  elf, state)  # t
+00043fc0: 7970 653a 2069 676e 6f72 650a 0a20 2020  ype: ignore..   
+00043fd0: 2064 6566 206c 6f67 5f77 6f72 6b65 725f   def log_worker_
+00043fe0: 6576 656e 7428 0a20 2020 2020 2020 2073  event(.        s
+00043ff0: 656c 662c 2077 6f72 6b65 723a 2073 7472  elf, worker: str
+00044000: 2c20 746f 7069 633a 2073 7472 207c 2043  , topic: str | C
+00044010: 6f6c 6c65 6374 696f 6e5b 7374 725d 2c20  ollection[str], 
+00044020: 6d73 673a 2041 6e79 0a20 2020 2029 202d  msg: Any.    ) -
+00044030: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+00044040: 6966 2069 7369 6e73 7461 6e63 6528 6d73  if isinstance(ms
+00044050: 672c 2064 6963 7429 2061 6e64 2077 6f72  g, dict) and wor
+00044060: 6b65 7220 213d 2074 6f70 6963 3a0a 2020  ker != topic:.  
+00044070: 2020 2020 2020 2020 2020 6d73 675b 2277            msg["w
+00044080: 6f72 6b65 7222 5d20 3d20 776f 726b 6572  orker"] = worker
+00044090: 0a20 2020 2020 2020 2073 656c 662e 6c6f  .        self.lo
+000440a0: 675f 6576 656e 7428 746f 7069 632c 206d  g_event(topic, m
+000440b0: 7367 290a 0a20 2020 2064 6566 2073 7562  sg)..    def sub
+000440c0: 7363 7269 6265 5f77 6f72 6b65 725f 7374  scribe_worker_st
+000440d0: 6174 7573 2873 656c 662c 2063 6f6d 6d3a  atus(self, comm:
+000440e0: 2043 6f6d 6d29 202d 3e20 6469 6374 5b73   Comm) -> dict[s
+000440f0: 7472 2c20 416e 795d 3a0a 2020 2020 2020  tr, Any]:.      
+00044100: 2020 576f 726b 6572 5374 6174 7573 506c    WorkerStatusPl
+00044110: 7567 696e 2873 656c 662c 2063 6f6d 6d29  ugin(self, comm)
+00044120: 0a20 2020 2020 2020 2069 6465 6e74 203d  .        ident =
+00044130: 2073 656c 662e 6964 656e 7469 7479 2829   self.identity()
+00044140: 0a20 2020 2020 2020 2066 6f72 2076 2069  .        for v i
+00044150: 6e20 6964 656e 745b 2277 6f72 6b65 7273  n ident["workers
+00044160: 225d 2e76 616c 7565 7328 293a 0a20 2020  "].values():.   
+00044170: 2020 2020 2020 2020 2064 656c 2076 5b22           del v["
+00044180: 6d65 7472 6963 7322 5d0a 2020 2020 2020  metrics"].      
+00044190: 2020 2020 2020 6465 6c20 765b 226c 6173        del v["las
+000441a0: 745f 7365 656e 225d 0a20 2020 2020 2020  t_seen"].       
+000441b0: 2072 6574 7572 6e20 6964 656e 740a 0a20   return ident.. 
+000441c0: 2020 2064 6566 2067 6574 5f70 726f 6365     def get_proce
+000441d0: 7373 696e 6728 0a20 2020 2020 2020 2073  ssing(.        s
+000441e0: 656c 662c 2077 6f72 6b65 7273 3a20 4974  elf, workers: It
+000441f0: 6572 6162 6c65 5b73 7472 5d20 7c20 4e6f  erable[str] | No
+00044200: 6e65 203d 204e 6f6e 650a 2020 2020 2920  ne = None.    ) 
+00044210: 2d3e 2064 6963 745b 7374 722c 206c 6973  -> dict[str, lis
+00044220: 745b 4b65 795d 5d3a 0a20 2020 2020 2020  t[Key]]:.       
+00044230: 2069 6620 776f 726b 6572 7320 6973 206e   if workers is n
+00044240: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00044250: 2020 2020 2077 6f72 6b65 7273 203d 2073       workers = s
+00044260: 6574 286d 6170 2873 656c 662e 636f 6572  et(map(self.coer
+00044270: 6365 5f61 6464 7265 7373 2c20 776f 726b  ce_address, work
+00044280: 6572 7329 290a 2020 2020 2020 2020 2020  ers)).          
+00044290: 2020 7265 7475 726e 207b 773a 205b 7473    return {w: [ts
+000442a0: 2e6b 6579 2066 6f72 2074 7320 696e 2073  .key for ts in s
+000442b0: 656c 662e 776f 726b 6572 735b 775d 2e70  elf.workers[w].p
+000442c0: 726f 6365 7373 696e 675d 2066 6f72 2077  rocessing] for w
+000442d0: 2069 6e20 776f 726b 6572 737d 0a20 2020   in workers}.   
+000442e0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+000442f0: 2020 2020 2020 2072 6574 7572 6e20 7b0a         return {.
+00044300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044310: 773a 205b 7473 2e6b 6579 2066 6f72 2074  w: [ts.key for t
+00044320: 7320 696e 2077 732e 7072 6f63 6573 7369  s in ws.processi
+00044330: 6e67 5d20 666f 7220 772c 2077 7320 696e  ng] for w, ws in
+00044340: 2073 656c 662e 776f 726b 6572 732e 6974   self.workers.it
+00044350: 656d 7328 290a 2020 2020 2020 2020 2020  ems().          
+00044360: 2020 7d0a 0a20 2020 2064 6566 2067 6574    }..    def get
+00044370: 5f77 686f 5f68 6173 2873 656c 662c 206b  _who_has(self, k
+00044380: 6579 733a 2049 7465 7261 626c 655b 4b65  eys: Iterable[Ke
+00044390: 795d 207c 204e 6f6e 6520 3d20 4e6f 6e65  y] | None = None
+000443a0: 2920 2d3e 2064 6963 745b 4b65 792c 206c  ) -> dict[Key, l
+000443b0: 6973 745b 7374 725d 5d3a 0a20 2020 2020  ist[str]]:.     
+000443c0: 2020 2069 6620 6b65 7973 2069 7320 6e6f     if keys is no
+000443d0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+000443e0: 2020 2020 7265 7475 726e 207b 0a20 2020      return {.   
+000443f0: 2020 2020 2020 2020 2020 2020 206b 6579               key
+00044400: 3a20 5b77 732e 6164 6472 6573 7320 666f  : [ws.address fo
+00044410: 7220 7773 2069 6e20 7365 6c66 2e74 6173  r ws in self.tas
+00044420: 6b73 5b6b 6579 5d2e 7768 6f5f 6861 7320  ks[key].who_has 
+00044430: 6f72 2028 295d 0a20 2020 2020 2020 2020  or ()].         
+00044440: 2020 2020 2020 2069 6620 6b65 7920 696e         if key in
+00044450: 2073 656c 662e 7461 736b 730a 2020 2020   self.tasks.    
+00044460: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00044470: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
+00044480: 2020 2020 666f 7220 6b65 7920 696e 206b      for key in k
+00044490: 6579 730a 2020 2020 2020 2020 2020 2020  eys.            
+000444a0: 7d0a 2020 2020 2020 2020 656c 7365 3a0a  }.        else:.
+000444b0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000444c0: 726e 207b 0a20 2020 2020 2020 2020 2020  rn {.           
+000444d0: 2020 2020 206b 6579 3a20 5b77 732e 6164       key: [ws.ad
+000444e0: 6472 6573 7320 666f 7220 7773 2069 6e20  dress for ws in 
+000444f0: 7473 2e77 686f 5f68 6173 206f 7220 2829  ts.who_has or ()
+00044500: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00044510: 2020 666f 7220 6b65 792c 2074 7320 696e    for key, ts in
+00044520: 2073 656c 662e 7461 736b 732e 6974 656d   self.tasks.item
+00044530: 7328 290a 2020 2020 2020 2020 2020 2020  s().            
+00044540: 7d0a 0a20 2020 2064 6566 2067 6574 5f68  }..    def get_h
+00044550: 6173 5f77 6861 7428 0a20 2020 2020 2020  as_what(.       
+00044560: 2073 656c 662c 2077 6f72 6b65 7273 3a20   self, workers: 
+00044570: 4974 6572 6162 6c65 5b73 7472 5d20 7c20  Iterable[str] | 
+00044580: 4e6f 6e65 203d 204e 6f6e 650a 2020 2020  None = None.    
+00044590: 2920 2d3e 2064 6963 745b 7374 722c 206c  ) -> dict[str, l
+000445a0: 6973 745b 4b65 795d 5d3a 0a20 2020 2020  ist[Key]]:.     
+000445b0: 2020 2069 6620 776f 726b 6572 7320 6973     if workers is
+000445c0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+000445d0: 2020 2020 2020 2077 6f72 6b65 7273 203d         workers =
+000445e0: 206d 6170 2873 656c 662e 636f 6572 6365   map(self.coerce
+000445f0: 5f61 6464 7265 7373 2c20 776f 726b 6572  _address, worker
+00044600: 7329 0a20 2020 2020 2020 2020 2020 2072  s).            r
+00044610: 6574 7572 6e20 7b0a 2020 2020 2020 2020  eturn {.        
+00044620: 2020 2020 2020 2020 773a 205b 7473 2e6b          w: [ts.k
+00044630: 6579 2066 6f72 2074 7320 696e 2073 656c  ey for ts in sel
+00044640: 662e 776f 726b 6572 735b 775d 2e68 6173  f.workers[w].has
+00044650: 5f77 6861 745d 0a20 2020 2020 2020 2020  _what].         
+00044660: 2020 2020 2020 2069 6620 7720 696e 2073         if w in s
+00044670: 656c 662e 776f 726b 6572 730a 2020 2020  elf.workers.    
+00044680: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00044690: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
+000446a0: 2020 2020 666f 7220 7720 696e 2077 6f72      for w in wor
+000446b0: 6b65 7273 0a20 2020 2020 2020 2020 2020  kers.           
+000446c0: 207d 0a20 2020 2020 2020 2065 6c73 653a   }.        else:
+000446d0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+000446e0: 7572 6e20 7b77 3a20 5b74 732e 6b65 7920  urn {w: [ts.key 
+000446f0: 666f 7220 7473 2069 6e20 7773 2e68 6173  for ts in ws.has
+00044700: 5f77 6861 745d 2066 6f72 2077 2c20 7773  _what] for w, ws
+00044710: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
+00044720: 2e69 7465 6d73 2829 7d0a 0a20 2020 2064  .items()}..    d
+00044730: 6566 2067 6574 5f6e 636f 7265 7328 7365  ef get_ncores(se
+00044740: 6c66 2c20 776f 726b 6572 733a 2049 7465  lf, workers: Ite
+00044750: 7261 626c 655b 7374 725d 207c 204e 6f6e  rable[str] | Non
+00044760: 6520 3d20 4e6f 6e65 2920 2d3e 2064 6963  e = None) -> dic
+00044770: 745b 7374 722c 2069 6e74 5d3a 0a20 2020  t[str, int]:.   
+00044780: 2020 2020 2069 6620 776f 726b 6572 7320       if workers 
+00044790: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+000447a0: 2020 2020 2020 2020 2077 6f72 6b65 7273           workers
+000447b0: 203d 206d 6170 2873 656c 662e 636f 6572   = map(self.coer
+000447c0: 6365 5f61 6464 7265 7373 2c20 776f 726b  ce_address, work
+000447d0: 6572 7329 0a20 2020 2020 2020 2020 2020  ers).           
+000447e0: 2072 6574 7572 6e20 7b77 3a20 7365 6c66   return {w: self
+000447f0: 2e77 6f72 6b65 7273 5b77 5d2e 6e74 6872  .workers[w].nthr
+00044800: 6561 6473 2066 6f72 2077 2069 6e20 776f  eads for w in wo
+00044810: 726b 6572 7320 6966 2077 2069 6e20 7365  rkers if w in se
+00044820: 6c66 2e77 6f72 6b65 7273 7d0a 2020 2020  lf.workers}.    
+00044830: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00044840: 2020 2020 2020 7265 7475 726e 207b 773a        return {w:
+00044850: 2077 732e 6e74 6872 6561 6473 2066 6f72   ws.nthreads for
+00044860: 2077 2c20 7773 2069 6e20 7365 6c66 2e77   w, ws in self.w
+00044870: 6f72 6b65 7273 2e69 7465 6d73 2829 7d0a  orkers.items()}.
+00044880: 0a20 2020 2064 6566 2067 6574 5f6e 636f  .    def get_nco
+00044890: 7265 735f 7275 6e6e 696e 6728 0a20 2020  res_running(.   
+000448a0: 2020 2020 2073 656c 662c 2077 6f72 6b65       self, worke
+000448b0: 7273 3a20 4974 6572 6162 6c65 5b73 7472  rs: Iterable[str
+000448c0: 5d20 7c20 4e6f 6e65 203d 204e 6f6e 650a  ] | None = None.
+000448d0: 2020 2020 2920 2d3e 2064 6963 745b 7374      ) -> dict[st
+000448e0: 722c 2069 6e74 5d3a 0a20 2020 2020 2020  r, int]:.       
+000448f0: 206e 636f 7265 7320 3d20 7365 6c66 2e67   ncores = self.g
+00044900: 6574 5f6e 636f 7265 7328 776f 726b 6572  et_ncores(worker
+00044910: 733d 776f 726b 6572 7329 0a20 2020 2020  s=workers).     
+00044920: 2020 2072 6574 7572 6e20 7b0a 2020 2020     return {.    
+00044930: 2020 2020 2020 2020 773a 206e 2066 6f72          w: n for
+00044940: 2077 2c20 6e20 696e 206e 636f 7265 732e   w, n in ncores.
+00044950: 6974 656d 7328 2920 6966 2073 656c 662e  items() if self.
+00044960: 776f 726b 6572 735b 775d 2e73 7461 7475  workers[w].statu
+00044970: 7320 3d3d 2053 7461 7475 732e 7275 6e6e  s == Status.runn
+00044980: 696e 670a 2020 2020 2020 2020 7d0a 0a20  ing.        }.. 
+00044990: 2020 2061 7379 6e63 2064 6566 2067 6574     async def get
+000449a0: 5f63 616c 6c5f 7374 6163 6b28 7365 6c66  _call_stack(self
+000449b0: 2c20 6b65 7973 3a20 4974 6572 6162 6c65  , keys: Iterable
+000449c0: 5b4b 6579 5d20 7c20 4e6f 6e65 203d 204e  [Key] | None = N
+000449d0: 6f6e 6529 202d 3e20 6469 6374 5b73 7472  one) -> dict[str
+000449e0: 2c20 416e 795d 3a0a 2020 2020 2020 2020  , Any]:.        
+000449f0: 776f 726b 6572 733a 2064 6963 745b 7374  workers: dict[st
+00044a00: 722c 206c 6973 745b 4b65 795d 207c 204e  r, list[Key] | N
+00044a10: 6f6e 655d 0a20 2020 2020 2020 2069 6620  one].        if 
+00044a20: 6b65 7973 2069 7320 6e6f 7420 4e6f 6e65  keys is not None
+00044a30: 3a0a 2020 2020 2020 2020 2020 2020 7374  :.            st
+00044a40: 6163 6b20 3d20 6c69 7374 286b 6579 7329  ack = list(keys)
+00044a50: 0a20 2020 2020 2020 2020 2020 2070 726f  .            pro
+00044a60: 6365 7373 696e 6720 3d20 7365 7428 290a  cessing = set().
+00044a70: 2020 2020 2020 2020 2020 2020 7768 696c              whil
+00044a80: 6520 7374 6163 6b3a 0a20 2020 2020 2020  e stack:.       
+00044a90: 2020 2020 2020 2020 206b 6579 203d 2073           key = s
+00044aa0: 7461 636b 2e70 6f70 2829 0a20 2020 2020  tack.pop().     
+00044ab0: 2020 2020 2020 2020 2020 2074 7320 3d20             ts = 
+00044ac0: 7365 6c66 2e74 6173 6b73 5b6b 6579 5d0a  self.tasks[key].
+00044ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044ae0: 6966 2074 732e 7374 6174 6520 3d3d 2022  if ts.state == "
+00044af0: 7761 6974 696e 6722 3a0a 2020 2020 2020  waiting":.      
+00044b00: 2020 2020 2020 2020 2020 2020 2020 7374                st
+00044b10: 6163 6b2e 6578 7465 6e64 285b 6474 732e  ack.extend([dts.
+00044b20: 6b65 7920 666f 7220 6474 7320 696e 2074  key for dts in t
+00044b30: 732e 6465 7065 6e64 656e 6369 6573 5d29  s.dependencies])
+00044b40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00044b50: 2065 6c69 6620 7473 2e73 7461 7465 203d   elif ts.state =
+00044b60: 3d20 2270 726f 6365 7373 696e 6722 3a0a  = "processing":.
+00044b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044b80: 2020 2020 7072 6f63 6573 7369 6e67 2e61      processing.a
+00044b90: 6464 2874 7329 0a0a 2020 2020 2020 2020  dd(ts)..        
+00044ba0: 2020 2020 776f 726b 6572 7320 3d20 6465      workers = de
+00044bb0: 6661 756c 7464 6963 7428 6c69 7374 290a  faultdict(list).
+00044bc0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00044bd0: 7473 2069 6e20 7072 6f63 6573 7369 6e67  ts in processing
+00044be0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00044bf0: 2020 6966 2074 732e 7072 6f63 6573 7369    if ts.processi
+00044c00: 6e67 5f6f 6e3a 0a20 2020 2020 2020 2020  ng_on:.         
+00044c10: 2020 2020 2020 2020 2020 2077 6b65 7973             wkeys
+00044c20: 203d 2077 6f72 6b65 7273 5b74 732e 7072   = workers[ts.pr
+00044c30: 6f63 6573 7369 6e67 5f6f 6e2e 6164 6472  ocessing_on.addr
+00044c40: 6573 735d 0a20 2020 2020 2020 2020 2020  ess].           
+00044c50: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00044c60: 776b 6579 7320 6973 206e 6f74 204e 6f6e  wkeys is not Non
+00044c70: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00044c80: 2020 2020 2020 776b 6579 732e 6170 7065        wkeys.appe
+00044c90: 6e64 2874 732e 6b65 7929 0a20 2020 2020  nd(ts.key).     
+00044ca0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00044cb0: 2020 2020 2077 6f72 6b65 7273 203d 207b       workers = {
+00044cc0: 773a 204e 6f6e 6520 666f 7220 7720 696e  w: None for w in
+00044cd0: 2073 656c 662e 776f 726b 6572 737d 0a0a   self.workers}..
+00044ce0: 2020 2020 2020 2020 6966 206e 6f74 2077          if not w
+00044cf0: 6f72 6b65 7273 3a0a 2020 2020 2020 2020  orkers:.        
+00044d00: 2020 2020 7265 7475 726e 207b 7d0a 0a20      return {}.. 
+00044d10: 2020 2020 2020 2072 6573 756c 7473 203d         results =
+00044d20: 2061 7761 6974 2061 7379 6e63 696f 2e67   await asyncio.g
+00044d30: 6174 6865 7228 0a20 2020 2020 2020 2020  ather(.         
+00044d40: 2020 202a 2873 656c 662e 7270 6328 7729     *(self.rpc(w)
+00044d50: 2e63 616c 6c5f 7374 6163 6b28 6b65 7973  .call_stack(keys
+00044d60: 3d76 2920 666f 7220 772c 2076 2069 6e20  =v) for w, v in 
+00044d70: 776f 726b 6572 732e 6974 656d 7328 2929  workers.items())
+00044d80: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+00044d90: 2020 2072 6573 706f 6e73 6520 3d20 7b77     response = {w
+00044da0: 3a20 7220 666f 7220 772c 2072 2069 6e20  : r for w, r in 
+00044db0: 7a69 7028 776f 726b 6572 732c 2072 6573  zip(workers, res
+00044dc0: 756c 7473 2920 6966 2072 7d0a 2020 2020  ults) if r}.    
+00044dd0: 2020 2020 7265 7475 726e 2072 6573 706f      return respo
+00044de0: 6e73 650a 0a20 2020 2061 7379 6e63 2064  nse..    async d
+00044df0: 6566 2062 656e 6368 6d61 726b 5f68 6172  ef benchmark_har
+00044e00: 6477 6172 6528 7365 6c66 2920 2d3e 2064  dware(self) -> d
+00044e10: 6963 745b 7374 722c 2064 6963 745b 7374  ict[str, dict[st
+00044e20: 722c 2066 6c6f 6174 5d5d 3a0a 2020 2020  r, float]]:.    
+00044e30: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00044e40: 5275 6e20 6120 6265 6e63 686d 6172 6b20  Run a benchmark 
+00044e50: 6f6e 2074 6865 2077 6f72 6b65 7273 2066  on the workers f
+00044e60: 6f72 206d 656d 6f72 792c 2064 6973 6b2c  or memory, disk,
+00044e70: 2061 6e64 206e 6574 776f 726b 2062 616e   and network ban
+00044e80: 6477 6964 7468 730a 0a20 2020 2020 2020  dwidths..       
+00044e90: 2052 6574 7572 6e73 0a20 2020 2020 2020   Returns.       
+00044ea0: 202d 2d2d 2d2d 2d2d 0a20 2020 2020 2020   -------.       
+00044eb0: 2072 6573 756c 743a 2064 6963 740a 2020   result: dict.  
+00044ec0: 2020 2020 2020 2020 2020 4120 6469 6374            A dict
+00044ed0: 696f 6e61 7279 206d 6170 7069 6e67 2074  ionary mapping t
+00044ee0: 6865 206e 616d 6573 2022 6469 736b 222c  he names "disk",
+00044ef0: 2022 6d65 6d6f 7279 222c 2061 6e64 2022   "memory", and "
+00044f00: 6e65 7477 6f72 6b22 2074 6f0a 2020 2020  network" to.    
+00044f10: 2020 2020 2020 2020 6469 6374 696f 6e61          dictiona
+00044f20: 7269 6573 206d 6170 7069 6e67 2073 697a  ries mapping siz
+00044f30: 6573 2074 6f20 6261 6e64 7769 6474 6873  es to bandwidths
+00044f40: 2e20 2054 6865 7365 2062 616e 6477 6964  .  These bandwid
+00044f50: 7468 7320 6172 650a 2020 2020 2020 2020  ths are.        
+00044f60: 2020 2020 6176 6572 6167 6564 206f 7665      averaged ove
+00044f70: 7220 6d61 6e79 2077 6f72 6b65 7273 2072  r many workers r
+00044f80: 756e 6e69 6e67 2063 6f6d 7075 7461 7469  unning computati
+00044f90: 6f6e 7320 6163 726f 7373 2074 6865 2063  ons across the c
+00044fa0: 6c75 7374 6572 2e0a 2020 2020 2020 2020  luster..        
+00044fb0: 2222 220a 2020 2020 2020 2020 6f75 743a  """.        out:
+00044fc0: 2064 6963 745b 7374 722c 2064 6566 6175   dict[str, defau
+00044fd0: 6c74 6469 6374 5b73 7472 2c20 6c69 7374  ltdict[str, list
+00044fe0: 5b66 6c6f 6174 5d5d 5d20 3d20 7b0a 2020  [float]]] = {.  
+00044ff0: 2020 2020 2020 2020 2020 6e61 6d65 3a20            name: 
+00045000: 6465 6661 756c 7464 6963 7428 6c69 7374  defaultdict(list
+00045010: 2920 666f 7220 6e61 6d65 2069 6e20 5b22  ) for name in ["
+00045020: 6469 736b 222c 2022 6d65 6d6f 7279 222c  disk", "memory",
+00045030: 2022 6e65 7477 6f72 6b22 5d0a 2020 2020   "network"].    
+00045040: 2020 2020 7d0a 0a20 2020 2020 2020 2023      }..        #
+00045050: 2064 6973 6b0a 2020 2020 2020 2020 7265   disk.        re
+00045060: 7375 6c74 203d 2061 7761 6974 2073 656c  sult = await sel
+00045070: 662e 6272 6f61 6463 6173 7428 6d73 673d  f.broadcast(msg=
+00045080: 7b22 6f70 223a 2022 6265 6e63 686d 6172  {"op": "benchmar
+00045090: 6b5f 6469 736b 227d 290a 2020 2020 2020  k_disk"}).      
+000450a0: 2020 666f 7220 6420 696e 2072 6573 756c    for d in resul
+000450b0: 742e 7661 6c75 6573 2829 3a0a 2020 2020  t.values():.    
+000450c0: 2020 2020 2020 2020 666f 7220 7369 7a65          for size
+000450d0: 2c20 6475 7261 7469 6f6e 2069 6e20 642e  , duration in d.
+000450e0: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
+000450f0: 2020 2020 2020 2020 206f 7574 5b22 6469           out["di
+00045100: 736b 225d 5b73 697a 655d 2e61 7070 656e  sk"][size].appen
+00045110: 6428 6475 7261 7469 6f6e 290a 0a20 2020  d(duration)..   
+00045120: 2020 2020 2023 206d 656d 6f72 790a 2020       # memory.  
+00045130: 2020 2020 2020 7265 7375 6c74 203d 2061        result = a
+00045140: 7761 6974 2073 656c 662e 6272 6f61 6463  wait self.broadc
+00045150: 6173 7428 6d73 673d 7b22 6f70 223a 2022  ast(msg={"op": "
+00045160: 6265 6e63 686d 6172 6b5f 6d65 6d6f 7279  benchmark_memory
+00045170: 227d 290a 2020 2020 2020 2020 666f 7220  "}).        for 
+00045180: 6420 696e 2072 6573 756c 742e 7661 6c75  d in result.valu
+00045190: 6573 2829 3a0a 2020 2020 2020 2020 2020  es():.          
+000451a0: 2020 666f 7220 7369 7a65 2c20 6475 7261    for size, dura
+000451b0: 7469 6f6e 2069 6e20 642e 6974 656d 7328  tion in d.items(
+000451c0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000451d0: 2020 206f 7574 5b22 6d65 6d6f 7279 225d     out["memory"]
+000451e0: 5b73 697a 655d 2e61 7070 656e 6428 6475  [size].append(du
+000451f0: 7261 7469 6f6e 290a 0a20 2020 2020 2020  ration)..       
+00045200: 2023 206e 6574 776f 726b 0a20 2020 2020   # network.     
+00045210: 2020 2077 6f72 6b65 7273 203d 206c 6973     workers = lis
+00045220: 7428 7365 6c66 2e77 6f72 6b65 7273 290a  t(self.workers).
+00045230: 2020 2020 2020 2020 2320 4f6e 2061 6e20          # On an 
+00045240: 6164 6170 7469 7665 2063 6c75 7374 6572  adaptive cluster
+00045250: 2c20 6966 206d 756c 7469 706c 6520 776f  , if multiple wo
+00045260: 726b 6572 7320 6172 6520 7374 6172 7465  rkers are starte
+00045270: 6420 6f6e 2074 6865 2073 616d 6520 7068  d on the same ph
+00045280: 7973 6963 616c 2068 6f73 742c 0a20 2020  ysical host,.   
+00045290: 2020 2020 2023 2074 6865 7920 6172 6520       # they are 
+000452a0: 6d6f 7265 206c 696b 656c 7920 746f 2063  more likely to c
+000452b0: 6f6e 6e65 6374 2074 6f20 7468 6520 5363  onnect to the Sc
+000452c0: 6865 6475 6c65 7220 696e 2073 6571 7565  heduler in seque
+000452d0: 6e63 652c 2065 6e64 696e 6720 7570 206e  nce, ending up n
+000452e0: 6578 7420 746f 0a20 2020 2020 2020 2023  ext to.        #
+000452f0: 2065 6163 6820 6f74 6865 7220 696e 2074   each other in t
+00045300: 6869 7320 6c69 7374 2e0a 2020 2020 2020  his list..      
+00045310: 2020 2320 5468 6520 7472 616e 7366 6572    # The transfer
+00045320: 2073 7065 6564 2077 6974 6869 6e20 7375   speed within su
+00045330: 6368 2063 6c75 7374 6572 7320 6f66 2077  ch clusters of w
+00045340: 6f72 6b65 7273 2077 696c 6c20 6265 2065  orkers will be e
+00045350: 6666 6563 7469 7665 6c79 2074 6861 7420  ffectively that 
+00045360: 6f66 0a20 2020 2020 2020 2023 206c 6f63  of.        # loc
+00045370: 616c 686f 7374 2e20 5468 6973 2063 6f75  alhost. This cou
+00045380: 6c64 2068 6170 7065 6e20 6163 726f 7373  ld happen across
+00045390: 2064 6966 6665 7265 6e74 2056 4d73 2061   different VMs a
+000453a0: 6e64 2f6f 7220 646f 636b 6572 2069 6d61  nd/or docker ima
+000453b0: 6765 732c 2073 6f0a 2020 2020 2020 2020  ges, so.        
+000453c0: 2320 696d 706c 656d 656e 7469 6e67 206c  # implementing l
+000453d0: 6f67 6963 2062 6173 6564 206f 6e20 4950  ogic based on IP
+000453e0: 2061 6464 7265 7373 6573 2077 6f75 6c64   addresses would
+000453f0: 206e 6f74 206e 6563 6573 7361 7269 6c79   not necessarily
+00045400: 2068 656c 702e 0a20 2020 2020 2020 2023   help..        #
+00045410: 2052 616e 646f 6d69 7a65 2074 6865 2063   Randomize the c
+00045420: 6f6e 6e65 6374 696f 6e73 2074 6f20 6576  onnections to ev
+00045430: 656e 206f 7574 2074 6865 206d 6561 6e20  en out the mean 
+00045440: 6d65 6173 7572 6573 2e0a 2020 2020 2020  measures..      
+00045450: 2020 7261 6e64 6f6d 2e73 6875 6666 6c65    random.shuffle
+00045460: 2877 6f72 6b65 7273 290a 2020 2020 2020  (workers).      
+00045470: 2020 6675 7475 7265 7320 3d20 5b0a 2020    futures = [.  
+00045480: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
+00045490: 7063 2861 292e 6265 6e63 686d 6172 6b5f  pc(a).benchmark_
+000454a0: 6e65 7477 6f72 6b28 6164 6472 6573 733d  network(address=
+000454b0: 6229 2066 6f72 2061 2c20 6220 696e 2070  b) for a, b in p
+000454c0: 6172 7469 7469 6f6e 2832 2c20 776f 726b  artition(2, work
+000454d0: 6572 7329 0a20 2020 2020 2020 205d 0a20  ers).        ]. 
+000454e0: 2020 2020 2020 2072 6573 706f 6e73 6573         responses
+000454f0: 203d 2061 7761 6974 2061 7379 6e63 696f   = await asyncio
+00045500: 2e67 6174 6865 7228 2a66 7574 7572 6573  .gather(*futures
+00045510: 290a 0a20 2020 2020 2020 2066 6f72 2064  )..        for d
+00045520: 2069 6e20 7265 7370 6f6e 7365 733a 0a20   in responses:. 
+00045530: 2020 2020 2020 2020 2020 2066 6f72 2073             for s
+00045540: 697a 652c 2064 7572 6174 696f 6e20 696e  ize, duration in
+00045550: 2064 2e69 7465 6d73 2829 3a0a 2020 2020   d.items():.    
+00045560: 2020 2020 2020 2020 2020 2020 6f75 745b              out[
+00045570: 226e 6574 776f 726b 225d 5b73 697a 655d  "network"][size]
+00045580: 2e61 7070 656e 6428 6475 7261 7469 6f6e  .append(duration
+00045590: 290a 0a20 2020 2020 2020 2072 6573 756c  )..        resul
+000455a0: 7420 3d20 7b7d 0a20 2020 2020 2020 2066  t = {}.        f
+000455b0: 6f72 206d 6f64 6520 696e 206f 7574 3a0a  or mode in out:.
+000455c0: 2020 2020 2020 2020 2020 2020 7265 7375              resu
+000455d0: 6c74 5b6d 6f64 655d 203d 207b 0a20 2020  lt[mode] = {.   
+000455e0: 2020 2020 2020 2020 2020 2020 2073 697a               siz
+000455f0: 653a 2073 756d 2864 7572 6174 696f 6e73  e: sum(durations
+00045600: 2920 2f20 6c65 6e28 6475 7261 7469 6f6e  ) / len(duration
+00045610: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
+00045620: 2020 2066 6f72 2073 697a 652c 2064 7572     for size, dur
+00045630: 6174 696f 6e73 2069 6e20 6f75 745b 6d6f  ations in out[mo
+00045640: 6465 5d2e 6974 656d 7328 290a 2020 2020  de].items().    
+00045650: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
+00045660: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
+00045670: 0a0a 2020 2020 406c 6f67 5f65 7272 6f72  ..    @log_error
+00045680: 730a 2020 2020 6465 6620 6765 745f 6e62  s.    def get_nb
+00045690: 7974 6573 280a 2020 2020 2020 2020 7365  ytes(.        se
+000456a0: 6c66 2c20 6b65 7973 3a20 4974 6572 6162  lf, keys: Iterab
+000456b0: 6c65 5b4b 6579 5d20 7c20 4e6f 6e65 203d  le[Key] | None =
+000456c0: 204e 6f6e 652c 2073 756d 6d61 7279 3a20   None, summary: 
+000456d0: 626f 6f6c 203d 2054 7275 650a 2020 2020  bool = True.    
+000456e0: 2920 2d3e 2064 6963 745b 4b65 792c 2069  ) -> dict[Key, i
+000456f0: 6e74 5d3a 0a20 2020 2020 2020 2069 6620  nt]:.        if 
+00045700: 6b65 7973 2069 7320 6e6f 7420 4e6f 6e65  keys is not None
+00045710: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00045720: 7375 6c74 203d 207b 6b3a 2073 656c 662e  sult = {k: self.
+00045730: 7461 736b 735b 6b5d 2e6e 6279 7465 7320  tasks[k].nbytes 
+00045740: 666f 7220 6b20 696e 206b 6579 737d 0a20  for k in keys}. 
+00045750: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00045760: 2020 2020 2020 2020 2072 6573 756c 7420           result 
+00045770: 3d20 7b6b 3a20 7473 2e6e 6279 7465 7320  = {k: ts.nbytes 
+00045780: 666f 7220 6b2c 2074 7320 696e 2073 656c  for k, ts in sel
+00045790: 662e 7461 736b 732e 6974 656d 7328 2920  f.tasks.items() 
+000457a0: 6966 2074 732e 6e62 7974 6573 203e 3d20  if ts.nbytes >= 
+000457b0: 307d 0a0a 2020 2020 2020 2020 6966 2073  0}..        if s
+000457c0: 756d 6d61 7279 3a0a 2020 2020 2020 2020  ummary:.        
+000457d0: 2020 2020 6f75 743a 2064 6566 6175 6c74      out: default
+000457e0: 6469 6374 5b4b 6579 2c20 696e 745d 203d  dict[Key, int] =
+000457f0: 2064 6566 6175 6c74 6469 6374 2869 6e74   defaultdict(int
+00045800: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
+00045810: 7220 6b2c 2076 2069 6e20 7265 7375 6c74  r k, v in result
+00045820: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
+00045830: 2020 2020 2020 2020 2020 6f75 745b 6b65            out[ke
+00045840: 795f 7370 6c69 7428 6b29 5d20 2b3d 2076  y_split(k)] += v
+00045850: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+00045860: 756c 7420 3d20 6469 6374 286f 7574 290a  ult = dict(out).
+00045870: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00045880: 7265 7375 6c74 0a0a 2020 2020 6465 6620  result..    def 
+00045890: 7275 6e5f 6675 6e63 7469 6f6e 280a 2020  run_function(.  
+000458a0: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+000458b0: 2020 2020 636f 6d6d 3a20 436f 6d6d 2c0a      comm: Comm,.
+000458c0: 2020 2020 2020 2020 6675 6e63 7469 6f6e          function
+000458d0: 3a20 4361 6c6c 6162 6c65 2c0a 2020 2020  : Callable,.    
+000458e0: 2020 2020 6172 6773 3a20 7475 706c 6520      args: tuple 
+000458f0: 3d20 2829 2c0a 2020 2020 2020 2020 6b77  = (),.        kw
+00045900: 6172 6773 3a20 6469 6374 207c 204e 6f6e  args: dict | Non
+00045910: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
+00045920: 2020 7761 6974 3a20 626f 6f6c 203d 2054    wait: bool = T
+00045930: 7275 652c 0a20 2020 2029 202d 3e20 416e  rue,.    ) -> An
+00045940: 793a 0a20 2020 2020 2020 2022 2222 5275  y:.        """Ru
+00045950: 6e20 6120 6675 6e63 7469 6f6e 2077 6974  n a function wit
+00045960: 6869 6e20 7468 6973 2070 726f 6365 7373  hin this process
+00045970: 0a0a 2020 2020 2020 2020 5365 6520 416c  ..        See Al
+00045980: 736f 0a20 2020 2020 2020 202d 2d2d 2d2d  so.        -----
+00045990: 2d2d 2d0a 2020 2020 2020 2020 436c 6965  ---.        Clie
+000459a0: 6e74 2e72 756e 5f6f 6e5f 7363 6865 6475  nt.run_on_schedu
+000459b0: 6c65 720a 2020 2020 2020 2020 2222 220a  ler.        """.
+000459c0: 2020 2020 2020 2020 6672 6f6d 2064 6973          from dis
+000459d0: 7472 6962 7574 6564 2e77 6f72 6b65 7220  tributed.worker 
+000459e0: 696d 706f 7274 2072 756e 0a0a 2020 2020  import run..    
+000459f0: 2020 2020 6b77 6172 6773 203d 206b 7761      kwargs = kwa
+00045a00: 7267 7320 6f72 207b 7d0a 2020 2020 2020  rgs or {}.      
+00045a10: 2020 7365 6c66 2e6c 6f67 5f65 7665 6e74    self.log_event
+00045a20: 2822 616c 6c22 2c20 7b22 6163 7469 6f6e  ("all", {"action
+00045a30: 223a 2022 7275 6e2d 6675 6e63 7469 6f6e  ": "run-function
+00045a40: 222c 2022 6675 6e63 7469 6f6e 223a 2066  ", "function": f
+00045a50: 756e 6374 696f 6e7d 290a 2020 2020 2020  unction}).      
+00045a60: 2020 7265 7475 726e 2072 756e 2873 656c    return run(sel
+00045a70: 662c 2063 6f6d 6d2c 2066 756e 6374 696f  f, comm, functio
+00045a80: 6e3d 6675 6e63 7469 6f6e 2c20 6172 6773  n=function, args
+00045a90: 3d61 7267 732c 206b 7761 7267 733d 6b77  =args, kwargs=kw
+00045aa0: 6172 6773 2c20 7761 6974 3d77 6169 7429  args, wait=wait)
+00045ab0: 0a0a 2020 2020 6465 6620 7365 745f 6d65  ..    def set_me
+00045ac0: 7461 6461 7461 2873 656c 662c 206b 6579  tadata(self, key
+00045ad0: 733a 206c 6973 745b 4b65 795d 2c20 7661  s: list[Key], va
+00045ae0: 6c75 653a 206f 626a 6563 7420 3d20 4e6f  lue: object = No
+00045af0: 6e65 2920 2d3e 204e 6f6e 653a 0a20 2020  ne) -> None:.   
+00045b00: 2020 2020 206d 6574 6164 6174 6120 3d20       metadata = 
+00045b10: 7365 6c66 2e74 6173 6b5f 6d65 7461 6461  self.task_metada
+00045b20: 7461 0a20 2020 2020 2020 2066 6f72 206b  ta.        for k
+00045b30: 6579 2069 6e20 6b65 7973 5b3a 2d31 5d3a  ey in keys[:-1]:
+00045b40: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00045b50: 6b65 7920 6e6f 7420 696e 206d 6574 6164  key not in metad
+00045b60: 6174 6120 6f72 206e 6f74 2069 7369 6e73  ata or not isins
+00045b70: 7461 6e63 6528 6d65 7461 6461 7461 5b6b  tance(metadata[k
+00045b80: 6579 5d2c 2028 6469 6374 2c20 6c69 7374  ey], (dict, list
+00045b90: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
+00045ba0: 2020 2020 6d65 7461 6461 7461 5b6b 6579      metadata[key
+00045bb0: 5d20 3d20 7b7d 0a20 2020 2020 2020 2020  ] = {}.         
+00045bc0: 2020 206d 6574 6164 6174 6120 3d20 6d65     metadata = me
+00045bd0: 7461 6461 7461 5b6b 6579 5d0a 2020 2020  tadata[key].    
+00045be0: 2020 2020 6d65 7461 6461 7461 5b6b 6579      metadata[key
+00045bf0: 735b 2d31 5d5d 203d 2076 616c 7565 0a0a  s[-1]] = value..
+00045c00: 2020 2020 6465 6620 6765 745f 6d65 7461      def get_meta
+00045c10: 6461 7461 2873 656c 662c 206b 6579 733a  data(self, keys:
+00045c20: 206c 6973 745b 4b65 795d 2c20 6465 6661   list[Key], defa
+00045c30: 756c 743a 2041 6e79 203d 206e 6f5f 6465  ult: Any = no_de
+00045c40: 6661 756c 7429 202d 3e20 416e 793a 0a20  fault) -> Any:. 
+00045c50: 2020 2020 2020 206d 6574 6164 6174 6120         metadata 
+00045c60: 3d20 7365 6c66 2e74 6173 6b5f 6d65 7461  = self.task_meta
+00045c70: 6461 7461 0a20 2020 2020 2020 2074 7279  data.        try
+00045c80: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
+00045c90: 7220 6b65 7920 696e 206b 6579 733a 0a20  r key in keys:. 
+00045ca0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00045cb0: 6574 6164 6174 6120 3d20 6d65 7461 6461  etadata = metada
+00045cc0: 7461 5b6b 6579 5d0a 2020 2020 2020 2020  ta[key].        
+00045cd0: 2020 2020 7265 7475 726e 206d 6574 6164      return metad
+00045ce0: 6174 610a 2020 2020 2020 2020 6578 6365  ata.        exce
+00045cf0: 7074 204b 6579 4572 726f 723a 0a20 2020  pt KeyError:.   
+00045d00: 2020 2020 2020 2020 2069 6620 6465 6661           if defa
+00045d10: 756c 7420 6973 206e 6f74 206e 6f5f 6465  ult is not no_de
+00045d20: 6661 756c 743a 0a20 2020 2020 2020 2020  fault:.         
+00045d30: 2020 2020 2020 2072 6574 7572 6e20 6465         return de
+00045d40: 6661 756c 740a 2020 2020 2020 2020 2020  fault.          
+00045d50: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00045d60: 2020 2020 2020 2020 7261 6973 650a 0a20          raise.. 
+00045d70: 2020 2064 6566 2073 6574 5f72 6573 7472     def set_restr
+00045d80: 6963 7469 6f6e 7328 7365 6c66 2c20 776f  ictions(self, wo
+00045d90: 726b 6572 3a20 6469 6374 5b4b 6579 2c20  rker: dict[Key, 
+00045da0: 436f 6c6c 6563 7469 6f6e 5b73 7472 5d20  Collection[str] 
+00045db0: 7c20 7374 7220 7c20 4e6f 6e65 5d29 202d  | str | None]) -
+00045dc0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+00045dd0: 666f 7220 6b65 792c 2072 6573 7472 6963  for key, restric
+00045de0: 7469 6f6e 7320 696e 2077 6f72 6b65 722e  tions in worker.
+00045df0: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
+00045e00: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
+00045e10: 6173 6b73 5b6b 6579 5d0a 2020 2020 2020  asks[key].      
+00045e20: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+00045e30: 6e63 6528 7265 7374 7269 6374 696f 6e73  nce(restrictions
+00045e40: 2c20 7374 7229 3a0a 2020 2020 2020 2020  , str):.        
+00045e50: 2020 2020 2020 2020 7265 7374 7269 6374          restrict
+00045e60: 696f 6e73 203d 207b 7265 7374 7269 6374  ions = {restrict
+00045e70: 696f 6e73 7d0a 2020 2020 2020 2020 2020  ions}.          
+00045e80: 2020 7473 2e77 6f72 6b65 725f 7265 7374    ts.worker_rest
+00045e90: 7269 6374 696f 6e73 203d 2073 6574 2872  rictions = set(r
+00045ea0: 6573 7472 6963 7469 6f6e 7329 2069 6620  estrictions) if 
+00045eb0: 7265 7374 7269 6374 696f 6e73 2065 6c73  restrictions els
+00045ec0: 6520 4e6f 6e65 0a0a 2020 2020 406c 6f67  e None..    @log
+00045ed0: 5f65 7272 6f72 730a 2020 2020 6465 6620  _errors.    def 
+00045ee0: 6765 745f 7461 736b 5f70 7265 6669 785f  get_task_prefix_
+00045ef0: 7374 6174 6573 2873 656c 6629 202d 3e20  states(self) -> 
+00045f00: 6469 6374 5b73 7472 2c20 6469 6374 5b73  dict[str, dict[s
+00045f10: 7472 2c20 696e 745d 5d3a 0a20 2020 2020  tr, int]]:.     
+00045f20: 2020 2073 7461 7465 203d 207b 7d0a 0a20     state = {}.. 
+00045f30: 2020 2020 2020 2066 6f72 2074 7020 696e         for tp in
+00045f40: 2073 656c 662e 7461 736b 5f70 7265 6669   self.task_prefi
+00045f50: 7865 732e 7661 6c75 6573 2829 3a0a 2020  xes.values():.  
+00045f60: 2020 2020 2020 2020 2020 6163 7469 7665            active
+00045f70: 5f73 7461 7465 7320 3d20 7470 2e61 6374  _states = tp.act
+00045f80: 6976 655f 7374 6174 6573 0a20 2020 2020  ive_states.     
+00045f90: 2020 2020 2020 2073 733a 206c 6973 745b         ss: list[
+00045fa0: 5461 736b 5374 6174 6553 7461 7465 5d20  TaskStateState] 
+00045fb0: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+00045fc0: 2020 2020 226d 656d 6f72 7922 2c0a 2020      "memory",.  
+00045fd0: 2020 2020 2020 2020 2020 2020 2020 2265                "e
+00045fe0: 7272 6564 222c 0a20 2020 2020 2020 2020  rred",.         
+00045ff0: 2020 2020 2020 2022 7265 6c65 6173 6564         "released
+00046000: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00046010: 2020 2022 7072 6f63 6573 7369 6e67 222c     "processing",
+00046020: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00046030: 2022 7761 6974 696e 6722 2c0a 2020 2020   "waiting",.    
+00046040: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
+00046050: 2020 2020 2020 6966 2061 6e79 2861 6374        if any(act
+00046060: 6976 655f 7374 6174 6573 2e67 6574 2873  ive_states.get(s
+00046070: 2920 666f 7220 7320 696e 2073 7329 3a0a  ) for s in ss):.
+00046080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00046090: 7374 6174 655b 7470 2e6e 616d 655d 203d  state[tp.name] =
+000460a0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+000460b0: 2020 2020 2020 2022 6d65 6d6f 7279 223a         "memory":
+000460c0: 2061 6374 6976 655f 7374 6174 6573 5b22   active_states["
+000460d0: 6d65 6d6f 7279 225d 2c0a 2020 2020 2020  memory"],.      
+000460e0: 2020 2020 2020 2020 2020 2020 2020 2265                "e
+000460f0: 7272 6564 223a 2061 6374 6976 655f 7374  rred": active_st
+00046100: 6174 6573 5b22 6572 7265 6422 5d2c 0a20  ates["erred"],. 
+00046110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00046120: 2020 2022 7265 6c65 6173 6564 223a 2061     "released": a
+00046130: 6374 6976 655f 7374 6174 6573 5b22 7265  ctive_states["re
+00046140: 6c65 6173 6564 225d 2c0a 2020 2020 2020  leased"],.      
+00046150: 2020 2020 2020 2020 2020 2020 2020 2270                "p
+00046160: 726f 6365 7373 696e 6722 3a20 6163 7469  rocessing": acti
+00046170: 7665 5f73 7461 7465 735b 2270 726f 6365  ve_states["proce
+00046180: 7373 696e 6722 5d2c 0a20 2020 2020 2020  ssing"],.       
+00046190: 2020 2020 2020 2020 2020 2020 2022 7761               "wa
+000461a0: 6974 696e 6722 3a20 6163 7469 7665 5f73  iting": active_s
+000461b0: 7461 7465 735b 2277 6169 7469 6e67 225d  tates["waiting"]
+000461c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000461d0: 2020 7d0a 0a20 2020 2020 2020 2072 6574    }..        ret
+000461e0: 7572 6e20 7374 6174 650a 0a20 2020 2064  urn state..    d
+000461f0: 6566 2067 6574 5f74 6173 6b5f 7374 6174  ef get_task_stat
+00046200: 7573 2873 656c 662c 206b 6579 733a 2049  us(self, keys: I
+00046210: 7465 7261 626c 655b 4b65 795d 2920 2d3e  terable[Key]) ->
+00046220: 2064 6963 745b 4b65 792c 2054 6173 6b53   dict[Key, TaskS
+00046230: 7461 7465 5374 6174 6520 7c20 4e6f 6e65  tateState | None
+00046240: 5d3a 0a20 2020 2020 2020 2072 6574 7572  ]:.        retur
+00046250: 6e20 7b0a 2020 2020 2020 2020 2020 2020  n {.            
+00046260: 6b65 793a 2028 7365 6c66 2e74 6173 6b73  key: (self.tasks
+00046270: 5b6b 6579 5d2e 7374 6174 6520 6966 206b  [key].state if k
+00046280: 6579 2069 6e20 7365 6c66 2e74 6173 6b73  ey in self.tasks
+00046290: 2065 6c73 6520 4e6f 6e65 2920 666f 7220   else None) for 
+000462a0: 6b65 7920 696e 206b 6579 730a 2020 2020  key in keys.    
+000462b0: 2020 2020 7d0a 0a20 2020 2064 6566 2067      }..    def g
+000462c0: 6574 5f74 6173 6b5f 7374 7265 616d 280a  et_task_stream(.
+000462d0: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+000462e0: 2020 2020 2020 7374 6172 743a 2073 7472        start: str
+000462f0: 207c 2066 6c6f 6174 207c 204e 6f6e 6520   | float | None 
+00046300: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00046310: 7374 6f70 3a20 7374 7220 7c20 666c 6f61  stop: str | floa
+00046320: 7420 7c20 4e6f 6e65 203d 204e 6f6e 652c  t | None = None,
+00046330: 0a20 2020 2020 2020 2063 6f75 6e74 3a20  .        count: 
+00046340: 696e 7420 7c20 4e6f 6e65 203d 204e 6f6e  int | None = Non
+00046350: 652c 0a20 2020 2029 202d 3e20 6c69 7374  e,.    ) -> list
+00046360: 3a0a 2020 2020 2020 2020 6672 6f6d 2064  :.        from d
+00046370: 6973 7472 6962 7574 6564 2e64 6961 676e  istributed.diagn
+00046380: 6f73 7469 6373 2e74 6173 6b5f 7374 7265  ostics.task_stre
+00046390: 616d 2069 6d70 6f72 7420 5461 736b 5374  am import TaskSt
+000463a0: 7265 616d 506c 7567 696e 0a0a 2020 2020  reamPlugin..    
+000463b0: 2020 2020 6966 2054 6173 6b53 7472 6561      if TaskStrea
+000463c0: 6d50 6c75 6769 6e2e 6e61 6d65 206e 6f74  mPlugin.name not
+000463d0: 2069 6e20 7365 6c66 2e70 6c75 6769 6e73   in self.plugins
+000463e0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+000463f0: 6c66 2e61 6464 5f70 6c75 6769 6e28 5461  lf.add_plugin(Ta
+00046400: 736b 5374 7265 616d 506c 7567 696e 2873  skStreamPlugin(s
+00046410: 656c 6629 290a 0a20 2020 2020 2020 2070  elf))..        p
+00046420: 6c75 6769 6e20 3d20 6361 7374 2854 6173  lugin = cast(Tas
+00046430: 6b53 7472 6561 6d50 6c75 6769 6e2c 2073  kStreamPlugin, s
+00046440: 656c 662e 706c 7567 696e 735b 5461 736b  elf.plugins[Task
+00046450: 5374 7265 616d 506c 7567 696e 2e6e 616d  StreamPlugin.nam
+00046460: 655d 290a 0a20 2020 2020 2020 2072 6574  e])..        ret
+00046470: 7572 6e20 706c 7567 696e 2e63 6f6c 6c65  urn plugin.colle
+00046480: 6374 2873 7461 7274 3d73 7461 7274 2c20  ct(start=start, 
+00046490: 7374 6f70 3d73 746f 702c 2063 6f75 6e74  stop=stop, count
+000464a0: 3d63 6f75 6e74 290a 0a20 2020 2064 6566  =count)..    def
+000464b0: 2073 7461 7274 5f74 6173 6b5f 6d65 7461   start_task_meta
+000464c0: 6461 7461 2873 656c 662c 206e 616d 653a  data(self, name:
+000464d0: 2073 7472 2920 2d3e 204e 6f6e 653a 0a20   str) -> None:. 
+000464e0: 2020 2020 2020 2070 6c75 6769 6e20 3d20         plugin = 
+000464f0: 436f 6c6c 6563 7454 6173 6b4d 6574 6144  CollectTaskMetaD
+00046500: 6174 6150 6c75 6769 6e28 7363 6865 6475  ataPlugin(schedu
+00046510: 6c65 723d 7365 6c66 2c20 6e61 6d65 3d6e  ler=self, name=n
+00046520: 616d 6529 0a20 2020 2020 2020 2073 656c  ame).        sel
+00046530: 662e 6164 645f 706c 7567 696e 2870 6c75  f.add_plugin(plu
+00046540: 6769 6e29 0a0a 2020 2020 6465 6620 7374  gin)..    def st
+00046550: 6f70 5f74 6173 6b5f 6d65 7461 6461 7461  op_task_metadata
+00046560: 2873 656c 662c 206e 616d 653a 2073 7472  (self, name: str
+00046570: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2920   | None = None) 
+00046580: 2d3e 2064 6963 743a 0a20 2020 2020 2020  -> dict:.       
+00046590: 2070 6c75 6769 6e73 203d 205b 0a20 2020   plugins = [.   
+000465a0: 2020 2020 2020 2020 2070 0a20 2020 2020           p.     
+000465b0: 2020 2020 2020 2066 6f72 2070 2069 6e20         for p in 
+000465c0: 6c69 7374 2873 656c 662e 706c 7567 696e  list(self.plugin
+000465d0: 732e 7661 6c75 6573 2829 290a 2020 2020  s.values()).    
+000465e0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+000465f0: 7461 6e63 6528 702c 2043 6f6c 6c65 6374  tance(p, Collect
+00046600: 5461 736b 4d65 7461 4461 7461 506c 7567  TaskMetaDataPlug
+00046610: 696e 2920 616e 6420 702e 6e61 6d65 203d  in) and p.name =
+00046620: 3d20 6e61 6d65 0a20 2020 2020 2020 205d  = name.        ]
+00046630: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
+00046640: 706c 7567 696e 7329 2021 3d20 313a 0a20  plugins) != 1:. 
+00046650: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00046660: 2056 616c 7565 4572 726f 7228 0a20 2020   ValueError(.   
+00046670: 2020 2020 2020 2020 2020 2020 2022 4578               "Ex
+00046680: 7065 6374 6564 2074 6f20 6669 6e64 2065  pected to find e
+00046690: 7861 6374 6c79 206f 6e65 2043 6f6c 6c65  xactly one Colle
+000466a0: 6374 5461 736b 4d65 7461 4461 7461 506c  ctTaskMetaDataPl
+000466b0: 7567 696e 2022 0a20 2020 2020 2020 2020  ugin ".         
+000466c0: 2020 2020 2020 2066 2277 6974 6820 6e61         f"with na
+000466d0: 6d65 207b 6e61 6d65 7d20 6275 7420 666f  me {name} but fo
+000466e0: 756e 6420 7b6c 656e 2870 6c75 6769 6e73  und {len(plugins
+000466f0: 297d 2e22 0a20 2020 2020 2020 2020 2020  )}.".           
+00046700: 2029 0a0a 2020 2020 2020 2020 706c 7567   )..        plug
+00046710: 696e 203d 2070 6c75 6769 6e73 5b30 5d0a  in = plugins[0].
+00046720: 2020 2020 2020 2020 7365 6c66 2e72 656d          self.rem
+00046730: 6f76 655f 706c 7567 696e 286e 616d 653d  ove_plugin(name=
+00046740: 706c 7567 696e 2e6e 616d 6529 0a20 2020  plugin.name).   
+00046750: 2020 2020 2072 6574 7572 6e20 7b22 6d65       return {"me
+00046760: 7461 6461 7461 223a 2070 6c75 6769 6e2e  tadata": plugin.
+00046770: 6d65 7461 6461 7461 2c20 2273 7461 7465  metadata, "state
+00046780: 223a 2070 6c75 6769 6e2e 7374 6174 657d  ": plugin.state}
+00046790: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
+000467a0: 7265 6769 7374 6572 5f77 6f72 6b65 725f  register_worker_
+000467b0: 706c 7567 696e 280a 2020 2020 2020 2020  plugin(.        
+000467c0: 7365 6c66 2c20 636f 6d6d 3a20 4e6f 6e65  self, comm: None
+000467d0: 2c20 706c 7567 696e 3a20 6279 7465 732c  , plugin: bytes,
+000467e0: 206e 616d 653a 2073 7472 2c20 6964 656d   name: str, idem
+000467f0: 706f 7465 6e74 3a20 626f 6f6c 207c 204e  potent: bool | N
+00046800: 6f6e 6520 3d20 4e6f 6e65 0a20 2020 2029  one = None.    )
+00046810: 202d 3e20 6469 6374 5b73 7472 2c20 4f4b   -> dict[str, OK
+00046820: 4d65 7373 6167 655d 3a0a 2020 2020 2020  Message]:.      
+00046830: 2020 2222 2252 6567 6973 7465 7273 2061    """Registers a
+00046840: 2077 6f72 6b65 7220 706c 7567 696e 206f   worker plugin o
+00046850: 6e20 616c 6c20 7275 6e6e 696e 6720 616e  n all running an
+00046860: 6420 6675 7475 7265 2077 6f72 6b65 7273  d future workers
+00046870: 2222 220a 2020 2020 2020 2020 6c6f 6767  """.        logg
+00046880: 6572 2e69 6e66 6f28 2252 6567 6973 7465  er.info("Registe
+00046890: 7269 6e67 2057 6f72 6b65 7220 706c 7567  ring Worker plug
+000468a0: 696e 2025 7322 2c20 6e61 6d65 290a 2020  in %s", name).  
+000468b0: 2020 2020 2020 6966 2069 6465 6d70 6f74        if idempot
+000468c0: 656e 7420 6973 204e 6f6e 653a 0a20 2020  ent is None:.   
+000468d0: 2020 2020 2020 2020 2077 6172 6e69 6e67           warning
+000468e0: 732e 7761 726e 280a 2020 2020 2020 2020  s.warn(.        
+000468f0: 2020 2020 2020 2020 2254 6865 2073 6967          "The sig
+00046900: 6e61 7475 7265 206f 6620 6053 6368 6564  nature of `Sched
+00046910: 756c 6572 2e72 6567 6973 7465 725f 776f  uler.register_wo
+00046920: 726b 6572 5f70 6c75 6769 6e60 206e 6f77  rker_plugin` now
+00046930: 2072 6571 7569 7265 7320 220a 2020 2020   requires ".    
+00046940: 2020 2020 2020 2020 2020 2020 2260 6964              "`id
+00046950: 656d 706f 7465 6e74 602e 204e 6f74 2069  empotent`. Not i
+00046960: 6e63 6c75 6469 6e67 2060 6964 656d 706f  ncluding `idempo
+00046970: 7465 6e74 6020 696e 2074 6865 2073 6967  tent` in the sig
+00046980: 6e61 7475 7265 2077 696c 6c20 6e6f 206c  nature will no l
+00046990: 6f6e 6765 7220 220a 2020 2020 2020 2020  onger ".        
+000469a0: 2020 2020 2020 2020 2262 6520 7375 7070          "be supp
+000469b0: 6f72 7465 6420 696e 2066 7574 7572 6520  orted in future 
+000469c0: 7665 7273 696f 6e73 2e22 2c0a 2020 2020  versions.",.    
+000469d0: 2020 2020 2020 2020 2020 2020 4675 7475              Futu
+000469e0: 7265 5761 726e 696e 672c 0a20 2020 2020  reWarning,.     
+000469f0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00046a00: 2020 2020 2069 6465 6d70 6f74 656e 7420       idempotent 
+00046a10: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
+00046a20: 6966 206e 616d 6520 696e 2073 656c 662e  if name in self.
+00046a30: 776f 726b 6572 5f70 6c75 6769 6e73 2061  worker_plugins a
+00046a40: 6e64 2069 6465 6d70 6f74 656e 743a 0a20  nd idempotent:. 
+00046a50: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00046a60: 6e20 7b7d 0a0a 2020 2020 2020 2020 7365  n {}..        se
+00046a70: 6c66 2e77 6f72 6b65 725f 706c 7567 696e  lf.worker_plugin
+00046a80: 735b 6e61 6d65 5d20 3d20 706c 7567 696e  s[name] = plugin
+00046a90: 0a0a 2020 2020 2020 2020 7265 7370 6f6e  ..        respon
+00046aa0: 7365 7320 3d20 6177 6169 7420 7365 6c66  ses = await self
+00046ab0: 2e62 726f 6164 6361 7374 280a 2020 2020  .broadcast(.    
+00046ac0: 2020 2020 2020 2020 6d73 673d 6469 6374          msg=dict
+00046ad0: 286f 703d 2270 6c75 6769 6e2d 6164 6422  (op="plugin-add"
+00046ae0: 2c20 706c 7567 696e 3d70 6c75 6769 6e2c  , plugin=plugin,
+00046af0: 206e 616d 653d 6e61 6d65 290a 2020 2020   name=name).    
+00046b00: 2020 2020 290a 2020 2020 2020 2020 7265      ).        re
+00046b10: 7475 726e 2072 6573 706f 6e73 6573 0a0a  turn responses..
+00046b20: 2020 2020 6173 796e 6320 6465 6620 756e      async def un
+00046b30: 7265 6769 7374 6572 5f77 6f72 6b65 725f  register_worker_
+00046b40: 706c 7567 696e 280a 2020 2020 2020 2020  plugin(.        
+00046b50: 7365 6c66 2c20 636f 6d6d 3a20 4e6f 6e65  self, comm: None
+00046b60: 2c20 6e61 6d65 3a20 7374 720a 2020 2020  , name: str.    
+00046b70: 2920 2d3e 2064 6963 745b 7374 722c 2045  ) -> dict[str, E
+00046b80: 7272 6f72 4d65 7373 6167 6520 7c20 4f4b  rrorMessage | OK
+00046b90: 4d65 7373 6167 655d 3a0a 2020 2020 2020  Message]:.      
+00046ba0: 2020 2222 2255 6e72 6567 6973 7465 7273    """Unregisters
+00046bb0: 2061 2077 6f72 6b65 7220 706c 7567 696e   a worker plugin
+00046bc0: 2222 220a 2020 2020 2020 2020 7472 793a  """.        try:
+00046bd0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00046be0: 662e 776f 726b 6572 5f70 6c75 6769 6e73  f.worker_plugins
+00046bf0: 2e70 6f70 286e 616d 6529 0a20 2020 2020  .pop(name).     
+00046c00: 2020 2065 7863 6570 7420 4b65 7945 7272     except KeyErr
+00046c10: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
+00046c20: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+00046c30: 2866 2254 6865 2077 6f72 6b65 7220 706c  (f"The worker pl
+00046c40: 7567 696e 207b 6e61 6d65 7d20 646f 6573  ugin {name} does
+00046c50: 206e 6f74 2065 7869 7374 2229 0a0a 2020   not exist")..  
+00046c60: 2020 2020 2020 7265 7370 6f6e 7365 7320        responses 
+00046c70: 3d20 6177 6169 7420 7365 6c66 2e62 726f  = await self.bro
+00046c80: 6164 6361 7374 286d 7367 3d64 6963 7428  adcast(msg=dict(
+00046c90: 6f70 3d22 706c 7567 696e 2d72 656d 6f76  op="plugin-remov
+00046ca0: 6522 2c20 6e61 6d65 3d6e 616d 6529 290a  e", name=name)).
+00046cb0: 2020 2020 2020 2020 7265 7475 726e 2072          return r
+00046cc0: 6573 706f 6e73 6573 0a0a 2020 2020 6173  esponses..    as
+00046cd0: 796e 6320 6465 6620 7265 6769 7374 6572  ync def register
+00046ce0: 5f6e 616e 6e79 5f70 6c75 6769 6e28 0a20  _nanny_plugin(. 
+00046cf0: 2020 2020 2020 2073 656c 662c 2063 6f6d         self, com
+00046d00: 6d3a 204e 6f6e 652c 2070 6c75 6769 6e3a  m: None, plugin:
+00046d10: 2062 7974 6573 2c20 6e61 6d65 3a20 7374   bytes, name: st
+00046d20: 722c 2069 6465 6d70 6f74 656e 743a 2062  r, idempotent: b
+00046d30: 6f6f 6c20 7c20 4e6f 6e65 203d 204e 6f6e  ool | None = Non
+00046d40: 650a 2020 2020 2920 2d3e 2064 6963 745b  e.    ) -> dict[
+00046d50: 7374 722c 204f 4b4d 6573 7361 6765 5d3a  str, OKMessage]:
+00046d60: 0a20 2020 2020 2020 2022 2222 5265 6769  .        """Regi
+00046d70: 7374 6572 7320 6120 6e61 6e6e 7920 706c  sters a nanny pl
+00046d80: 7567 696e 206f 6e20 616c 6c20 7275 6e6e  ugin on all runn
+00046d90: 696e 6720 616e 6420 6675 7475 7265 206e  ing and future n
+00046da0: 616e 6e69 6573 2222 220a 2020 2020 2020  annies""".      
+00046db0: 2020 6c6f 6767 6572 2e69 6e66 6f28 2252    logger.info("R
+00046dc0: 6567 6973 7465 7269 6e67 204e 616e 6e79  egistering Nanny
+00046dd0: 2070 6c75 6769 6e20 2573 222c 206e 616d   plugin %s", nam
+00046de0: 6529 0a0a 2020 2020 2020 2020 6966 2069  e)..        if i
+00046df0: 6465 6d70 6f74 656e 7420 6973 204e 6f6e  dempotent is Non
+00046e00: 653a 0a20 2020 2020 2020 2020 2020 2077  e:.            w
+00046e10: 6172 6e69 6e67 732e 7761 726e 280a 2020  arnings.warn(.  
+00046e20: 2020 2020 2020 2020 2020 2020 2020 2254                "T
+00046e30: 6865 2073 6967 6e61 7475 7265 206f 6620  he signature of 
+00046e40: 6053 6368 6564 756c 6572 2e72 6567 6973  `Scheduler.regis
+00046e50: 7465 725f 6e61 6e6e 795f 706c 7567 696e  ter_nanny_plugin
+00046e60: 6020 6e6f 7720 7265 7175 6972 6573 2022  ` now requires "
+00046e70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00046e80: 2022 6069 6465 6d70 6f74 656e 7460 2e20   "`idempotent`. 
+00046e90: 4e6f 7420 696e 636c 7564 696e 6720 6069  Not including `i
+00046ea0: 6465 6d70 6f74 656e 7460 2069 6e20 7468  dempotent` in th
+00046eb0: 6520 7369 676e 6174 7572 6520 7769 6c6c  e signature will
+00046ec0: 206e 6f20 6c6f 6e67 6572 2022 0a20 2020   no longer ".   
+00046ed0: 2020 2020 2020 2020 2020 2020 2022 6265               "be
+00046ee0: 2073 7570 706f 7274 6564 2069 6e20 6675   supported in fu
+00046ef0: 7475 7265 2076 6572 7369 6f6e 732e 222c  ture versions.",
+00046f00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00046f10: 2046 7574 7572 6557 6172 6e69 6e67 2c0a   FutureWarning,.
+00046f20: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00046f30: 2020 2020 2020 2020 2020 6964 656d 706f            idempo
+00046f40: 7465 6e74 203d 2046 616c 7365 0a0a 2020  tent = False..  
+00046f50: 2020 2020 2020 6966 206e 616d 6520 696e        if name in
+00046f60: 2073 656c 662e 6e61 6e6e 795f 706c 7567   self.nanny_plug
+00046f70: 696e 7320 616e 6420 6964 656d 706f 7465  ins and idempote
+00046f80: 6e74 3a0a 2020 2020 2020 2020 2020 2020  nt:.            
+00046f90: 7265 7475 726e 207b 7d0a 0a20 2020 2020  return {}..     
+00046fa0: 2020 2073 656c 662e 6e61 6e6e 795f 706c     self.nanny_pl
+00046fb0: 7567 696e 735b 6e61 6d65 5d20 3d20 706c  ugins[name] = pl
+00046fc0: 7567 696e 0a20 2020 2020 2020 2061 7379  ugin.        asy
+00046fd0: 6e63 2077 6974 6820 7365 6c66 2e5f 7374  nc with self._st
+00046fe0: 6172 7469 6e67 5f6e 616e 6e69 6573 5f63  arting_nannies_c
+00046ff0: 6f6e 643a 0a20 2020 2020 2020 2020 2020  ond:.           
+00047000: 2069 6620 7365 6c66 2e5f 7374 6172 7469   if self._starti
+00047010: 6e67 5f6e 616e 6e69 6573 3a0a 2020 2020  ng_nannies:.    
+00047020: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+00047030: 6572 2e69 6e66 6f28 2257 6169 7469 6e67  er.info("Waiting
+00047040: 2066 6f72 204e 616e 6e69 6573 2074 6f20   for Nannies to 
+00047050: 7374 6172 7420 2573 222c 2073 656c 662e  start %s", self.
+00047060: 5f73 7461 7274 696e 675f 6e61 6e6e 6965  _starting_nannie
+00047070: 7329 0a20 2020 2020 2020 2020 2020 2061  s).            a
+00047080: 7761 6974 2073 656c 662e 5f73 7461 7274  wait self._start
+00047090: 696e 675f 6e61 6e6e 6965 735f 636f 6e64  ing_nannies_cond
+000470a0: 2e77 6169 745f 666f 7228 0a20 2020 2020  .wait_for(.     
+000470b0: 2020 2020 2020 2020 2020 206c 616d 6264             lambd
+000470c0: 613a 206e 6f74 2073 656c 662e 5f73 7461  a: not self._sta
+000470d0: 7274 696e 675f 6e61 6e6e 6965 730a 2020  rting_nannies.  
+000470e0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+000470f0: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
+00047100: 7320 3d20 6177 6169 7420 7365 6c66 2e62  s = await self.b
+00047110: 726f 6164 6361 7374 280a 2020 2020 2020  roadcast(.      
+00047120: 2020 2020 2020 2020 2020 6d73 673d 6469            msg=di
+00047130: 6374 286f 703d 2270 6c75 6769 6e5f 6164  ct(op="plugin_ad
+00047140: 6422 2c20 706c 7567 696e 3d70 6c75 6769  d", plugin=plugi
+00047150: 6e2c 206e 616d 653d 6e61 6d65 292c 0a20  n, name=name),. 
+00047160: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00047170: 616e 6e79 3d54 7275 652c 0a20 2020 2020  anny=True,.     
+00047180: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00047190: 2020 2020 2072 6574 7572 6e20 7265 7370       return resp
+000471a0: 6f6e 7365 730a 0a20 2020 2061 7379 6e63  onses..    async
+000471b0: 2064 6566 2075 6e72 6567 6973 7465 725f   def unregister_
+000471c0: 6e61 6e6e 795f 706c 7567 696e 280a 2020  nanny_plugin(.  
+000471d0: 2020 2020 2020 7365 6c66 2c20 636f 6d6d        self, comm
+000471e0: 3a20 4e6f 6e65 2c20 6e61 6d65 3a20 7374  : None, name: st
+000471f0: 720a 2020 2020 2920 2d3e 2064 6963 745b  r.    ) -> dict[
+00047200: 7374 722c 2045 7272 6f72 4d65 7373 6167  str, ErrorMessag
+00047210: 6520 7c20 4f4b 4d65 7373 6167 655d 3a0a  e | OKMessage]:.
+00047220: 2020 2020 2020 2020 2222 2255 6e72 6567          """Unreg
+00047230: 6973 7465 7273 2061 2077 6f72 6b65 7220  isters a worker 
+00047240: 706c 7567 696e 2222 220a 2020 2020 2020  plugin""".      
+00047250: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00047260: 2020 2073 656c 662e 6e61 6e6e 795f 706c     self.nanny_pl
+00047270: 7567 696e 732e 706f 7028 6e61 6d65 290a  ugins.pop(name).
+00047280: 2020 2020 2020 2020 6578 6365 7074 204b          except K
+00047290: 6579 4572 726f 723a 0a20 2020 2020 2020  eyError:.       
+000472a0: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+000472b0: 4572 726f 7228 6622 5468 6520 6e61 6e6e  Error(f"The nann
+000472c0: 7920 706c 7567 696e 207b 6e61 6d65 7d20  y plugin {name} 
+000472d0: 646f 6573 206e 6f74 2065 7869 7374 2229  does not exist")
+000472e0: 0a0a 2020 2020 2020 2020 7265 7370 6f6e  ..        respon
+000472f0: 7365 7320 3d20 6177 6169 7420 7365 6c66  ses = await self
+00047300: 2e62 726f 6164 6361 7374 280a 2020 2020  .broadcast(.    
+00047310: 2020 2020 2020 2020 6d73 673d 6469 6374          msg=dict
+00047320: 286f 703d 2270 6c75 6769 6e5f 7265 6d6f  (op="plugin_remo
+00047330: 7665 222c 206e 616d 653d 6e61 6d65 292c  ve", name=name),
+00047340: 206e 616e 6e79 3d54 7275 650a 2020 2020   nanny=True.    
+00047350: 2020 2020 290a 2020 2020 2020 2020 7265      ).        re
+00047360: 7475 726e 2072 6573 706f 6e73 6573 0a0a  turn responses..
+00047370: 2020 2020 6465 6620 7472 616e 7369 7469      def transiti
+00047380: 6f6e 280a 2020 2020 2020 2020 7365 6c66  on(.        self
+00047390: 2c0a 2020 2020 2020 2020 6b65 793a 204b  ,.        key: K
+000473a0: 6579 2c0a 2020 2020 2020 2020 6669 6e69  ey,.        fini
+000473b0: 7368 3a20 5461 736b 5374 6174 6553 7461  sh: TaskStateSta
+000473c0: 7465 2c0a 2020 2020 2020 2020 7374 696d  te,.        stim
+000473d0: 756c 7573 5f69 643a 2073 7472 2c0a 2020  ulus_id: str,.  
+000473e0: 2020 2020 2020 2a2a 6b77 6172 6773 3a20        **kwargs: 
+000473f0: 416e 792c 0a20 2020 2029 202d 3e20 5265  Any,.    ) -> Re
+00047400: 6373 3a0a 2020 2020 2020 2020 2222 2254  cs:.        """T
+00047410: 7261 6e73 6974 696f 6e20 6120 6b65 7920  ransition a key 
+00047420: 6672 6f6d 2069 7473 2063 7572 7265 6e74  from its current
+00047430: 2073 7461 7465 2074 6f20 7468 6520 6669   state to the fi
+00047440: 6e69 7368 2073 7461 7465 0a0a 2020 2020  nish state..    
+00047450: 2020 2020 4578 616d 706c 6573 0a20 2020      Examples.   
+00047460: 2020 2020 202d 2d2d 2d2d 2d2d 2d0a 2020       --------.  
+00047470: 2020 2020 2020 3e3e 3e20 7365 6c66 2e74        >>> self.t
+00047480: 7261 6e73 6974 696f 6e28 2778 272c 2027  ransition('x', '
+00047490: 7761 6974 696e 6727 290a 2020 2020 2020  waiting').      
+000474a0: 2020 7b27 7827 3a20 2770 726f 6365 7373    {'x': 'process
+000474b0: 696e 6727 7d0a 0a20 2020 2020 2020 2052  ing'}..        R
+000474c0: 6574 7572 6e73 0a20 2020 2020 2020 202d  eturns.        -
+000474d0: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2044  ------.        D
+000474e0: 6963 7469 6f6e 6172 7920 6f66 2072 6563  ictionary of rec
+000474f0: 6f6d 6d65 6e64 6174 696f 6e73 2066 6f72  ommendations for
+00047500: 2066 7574 7572 6520 7472 616e 7369 7469   future transiti
+00047510: 6f6e 730a 0a20 2020 2020 2020 2053 6565  ons..        See
+00047520: 2041 6c73 6f0a 2020 2020 2020 2020 2d2d   Also.        --
+00047530: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2053  ------.        S
+00047540: 6368 6564 756c 6572 2e74 7261 6e73 6974  cheduler.transit
+00047550: 696f 6e73 3a20 7472 616e 7369 7469 7665  ions: transitive
+00047560: 2076 6572 7369 6f6e 206f 6620 7468 6973   version of this
+00047570: 2066 756e 6374 696f 6e0a 2020 2020 2020   function.      
+00047580: 2020 2222 220a 2020 2020 2020 2020 7265    """.        re
+00047590: 636f 6d6d 656e 6461 7469 6f6e 732c 2063  commendations, c
+000475a0: 6c69 656e 745f 6d73 6773 2c20 776f 726b  lient_msgs, work
+000475b0: 6572 5f6d 7367 7320 3d20 7365 6c66 2e5f  er_msgs = self._
+000475c0: 7472 616e 7369 7469 6f6e 280a 2020 2020  transition(.    
+000475d0: 2020 2020 2020 2020 6b65 792c 2066 696e          key, fin
+000475e0: 6973 682c 2073 7469 6d75 6c75 735f 6964  ish, stimulus_id
+000475f0: 2c20 2a2a 6b77 6172 6773 0a20 2020 2020  , **kwargs.     
+00047600: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
+00047610: 662e 7365 6e64 5f61 6c6c 2863 6c69 656e  f.send_all(clien
+00047620: 745f 6d73 6773 2c20 776f 726b 6572 5f6d  t_msgs, worker_m
+00047630: 7367 7329 0a20 2020 2020 2020 2072 6574  sgs).        ret
+00047640: 7572 6e20 7265 636f 6d6d 656e 6461 7469  urn recommendati
+00047650: 6f6e 730a 0a20 2020 2064 6566 2074 7261  ons..    def tra
+00047660: 6e73 6974 696f 6e73 2873 656c 662c 2072  nsitions(self, r
+00047670: 6563 6f6d 6d65 6e64 6174 696f 6e73 3a20  ecommendations: 
+00047680: 5265 6373 2c20 7374 696d 756c 7573 5f69  Recs, stimulus_i
+00047690: 643a 2073 7472 2920 2d3e 204e 6f6e 653a  d: str) -> None:
+000476a0: 0a20 2020 2020 2020 2022 2222 5072 6f63  .        """Proc
+000476b0: 6573 7320 7472 616e 7369 7469 6f6e 7320  ess transitions 
+000476c0: 756e 7469 6c20 6e6f 6e65 2061 7265 206c  until none are l
+000476d0: 6566 740a 0a20 2020 2020 2020 2054 6869  eft..        Thi
+000476e0: 7320 696e 636c 7564 6573 2066 6565 6462  s includes feedb
+000476f0: 6163 6b20 6672 6f6d 2070 7265 7669 6f75  ack from previou
+00047700: 7320 7472 616e 7369 7469 6f6e 7320 616e  s transitions an
+00047710: 6420 636f 6e74 696e 7565 7320 756e 7469  d continues unti
+00047720: 6c20 7765 0a20 2020 2020 2020 2072 6561  l we.        rea
+00047730: 6368 2061 2073 7465 6164 7920 7374 6174  ch a steady stat
+00047740: 650a 2020 2020 2020 2020 2222 220a 2020  e.        """.  
+00047750: 2020 2020 2020 636c 6965 6e74 5f6d 7367        client_msg
+00047760: 733a 204d 7367 7320 3d20 7b7d 0a20 2020  s: Msgs = {}.   
+00047770: 2020 2020 2077 6f72 6b65 725f 6d73 6773       worker_msgs
+00047780: 3a20 4d73 6773 203d 207b 7d0a 2020 2020  : Msgs = {}.    
+00047790: 2020 2020 7365 6c66 2e5f 7472 616e 7369      self._transi
+000477a0: 7469 6f6e 7328 7265 636f 6d6d 656e 6461  tions(recommenda
+000477b0: 7469 6f6e 732c 2063 6c69 656e 745f 6d73  tions, client_ms
+000477c0: 6773 2c20 776f 726b 6572 5f6d 7367 732c  gs, worker_msgs,
+000477d0: 2073 7469 6d75 6c75 735f 6964 290a 2020   stimulus_id).  
+000477e0: 2020 2020 2020 7365 6c66 2e73 656e 645f        self.send_
+000477f0: 616c 6c28 636c 6965 6e74 5f6d 7367 732c  all(client_msgs,
+00047800: 2077 6f72 6b65 725f 6d73 6773 290a 0a20   worker_msgs).. 
+00047810: 2020 2061 7379 6e63 2064 6566 2067 6574     async def get
+00047820: 5f73 746f 7279 2873 656c 662c 206b 6579  _story(self, key
+00047830: 735f 6f72 5f73 7469 6d75 6c69 3a20 4974  s_or_stimuli: It
+00047840: 6572 6162 6c65 5b4b 6579 207c 2073 7472  erable[Key | str
+00047850: 5d29 202d 3e20 6c69 7374 5b54 7261 6e73  ]) -> list[Trans
+00047860: 6974 696f 6e5d 3a0a 2020 2020 2020 2020  ition]:.        
+00047870: 2222 2252 5043 2068 6f6f 6b20 666f 7220  """RPC hook for 
+00047880: 3a6d 6574 683a 6053 6368 6564 756c 6572  :meth:`Scheduler
+00047890: 5374 6174 652e 7374 6f72 7960 2e0a 0a20  State.story`... 
+000478a0: 2020 2020 2020 204e 6f74 6520 7468 6174         Note that
+000478b0: 2074 6865 206d 7367 7061 636b 2073 6572   the msgpack ser
+000478c0: 6961 6c69 7a61 7469 6f6e 2f64 6573 6572  ialization/deser
+000478d0: 6961 6c69 7a61 7469 6f6e 2072 6f75 6e64  ialization round
+000478e0: 2d74 7269 7020 7769 6c6c 2074 7261 6e73  -trip will trans
+000478f0: 666f 726d 0a20 2020 2020 2020 2074 6865  form.        the
+00047900: 203a 636c 6173 733a 6054 7261 6e73 6974   :class:`Transit
+00047910: 696f 6e60 206e 616d 6564 7475 706c 6573  ion` namedtuples
+00047920: 2069 6e74 6f20 7265 6775 6c61 7220 7475   into regular tu
+00047930: 706c 6573 2e0a 2020 2020 2020 2020 2222  ples..        ""
+00047940: 220a 2020 2020 2020 2020 7265 7475 726e  ".        return
+00047950: 2073 656c 662e 7374 6f72 7928 2a6b 6579   self.story(*key
+00047960: 735f 6f72 5f73 7469 6d75 6c69 290a 0a20  s_or_stimuli).. 
+00047970: 2020 2064 6566 205f 7265 7363 6865 6475     def _reschedu
+00047980: 6c65 280a 2020 2020 2020 2020 7365 6c66  le(.        self
+00047990: 2c20 6b65 793a 204b 6579 2c20 776f 726b  , key: Key, work
+000479a0: 6572 3a20 7374 7220 7c20 4e6f 6e65 203d  er: str | None =
+000479b0: 204e 6f6e 652c 202a 2c20 7374 696d 756c   None, *, stimul
+000479c0: 7573 5f69 643a 2073 7472 0a20 2020 2029  us_id: str.    )
+000479d0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+000479e0: 2020 2222 2252 6573 6368 6564 756c 6520    """Reschedule 
+000479f0: 6120 7461 736b 2e0a 0a20 2020 2020 2020  a task...       
+00047a00: 2054 6869 7320 6675 6e63 7469 6f6e 2073   This function s
+00047a10: 686f 756c 6420 6f6e 6c79 2062 6520 7573  hould only be us
+00047a20: 6564 2077 6865 6e20 7468 6520 7461 736b  ed when the task
+00047a30: 2068 6173 2061 6c72 6561 6479 2062 6565   has already bee
+00047a40: 6e20 7265 6c65 6173 6564 2069 6e0a 2020  n released in.  
+00047a50: 2020 2020 2020 736f 6d65 2077 6179 206f        some way o
+00047a60: 6e20 7468 6520 776f 726b 6572 2069 7427  n the worker it'
+00047a70: 7320 6173 7369 676e 6564 2074 6f20 e280  s assigned to ..
+00047a80: 9420 6569 7468 6572 2076 6961 2063 616e  . either via can
+00047a90: 6365 6c6c 6174 696f 6e20 6f72 2061 0a20  cellation or a. 
+00047aa0: 2020 2020 2020 2052 6573 6368 6564 756c         Reschedul
+00047ab0: 6520 6578 6365 7074 696f 6e20 e280 9420  e exception ... 
+00047ac0: 616e 6420 796f 7520 6172 6520 6365 7274  and you are cert
+00047ad0: 6169 6e20 7468 6520 776f 726b 6572 2077  ain the worker w
+00047ae0: 696c 6c20 6e6f 7420 7365 6e64 2061 6e79  ill not send any
+00047af0: 2066 7572 7468 6572 0a20 2020 2020 2020   further.       
+00047b00: 2075 7064 6174 6573 2061 626f 7574 2074   updates about t
+00047b10: 6865 2074 6173 6b20 746f 2074 6865 2073  he task to the s
+00047b20: 6368 6564 756c 6572 2e0a 2020 2020 2020  cheduler..      
+00047b30: 2020 2222 220a 2020 2020 2020 2020 7472    """.        tr
+00047b40: 793a 0a20 2020 2020 2020 2020 2020 2074  y:.            t
+00047b50: 7320 3d20 7365 6c66 2e74 6173 6b73 5b6b  s = self.tasks[k
+00047b60: 6579 5d0a 2020 2020 2020 2020 6578 6365  ey].        exce
+00047b70: 7074 204b 6579 4572 726f 723a 0a20 2020  pt KeyError:.   
+00047b80: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+00047b90: 7761 726e 696e 6728 0a20 2020 2020 2020  warning(.       
+00047ba0: 2020 2020 2020 2020 2066 2241 7474 656d           f"Attem
+00047bb0: 7074 696e 6720 746f 2072 6573 6368 6564  pting to resched
+00047bc0: 756c 6520 7461 736b 207b 6b65 7921 727d  ule task {key!r}
+00047bd0: 2c20 7768 6963 6820 7761 7320 6e6f 7420  , which was not 
+00047be0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00047bf0: 2020 2266 6f75 6e64 206f 6e20 7468 6520    "found on the 
+00047c00: 7363 6865 6475 6c65 722e 2041 626f 7274  scheduler. Abort
+00047c10: 696e 6720 7265 7363 6865 6475 6c65 2e22  ing reschedule."
+00047c20: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00047c30: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00047c40: 6e0a 2020 2020 2020 2020 6966 2074 732e  n.        if ts.
+00047c50: 7374 6174 6520 213d 2022 7072 6f63 6573  state != "proces
+00047c60: 7369 6e67 223a 0a20 2020 2020 2020 2020  sing":.         
+00047c70: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
+00047c80: 2020 6966 2077 6f72 6b65 7220 616e 6420    if worker and 
+00047c90: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
+00047ca0: 2061 6e64 2074 732e 7072 6f63 6573 7369   and ts.processi
+00047cb0: 6e67 5f6f 6e2e 6164 6472 6573 7320 213d  ng_on.address !=
+00047cc0: 2077 6f72 6b65 723a 0a20 2020 2020 2020   worker:.       
+00047cd0: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
+00047ce0: 2020 2020 2320 7472 616e 7369 7469 6f6e      # transition
+00047cf0: 5f70 726f 6365 7373 696e 675f 7265 6c65  _processing_rele
+00047d00: 6173 6564 2077 696c 6c20 696d 6d65 6469  ased will immedi
+00047d10: 6174 656c 7920 7375 6767 6573 7420 616e  ately suggest an
+00047d20: 2061 6464 6974 696f 6e61 6c0a 2020 2020   additional.    
+00047d30: 2020 2020 2320 7472 616e 7369 7469 6f6e      # transition
+00047d40: 2074 6f20 7761 6974 696e 6720 6966 2074   to waiting if t
+00047d50: 6865 2074 6173 6b20 6861 7320 616e 7920  he task has any 
+00047d60: 7761 6974 6572 7320 6f72 2063 6c69 656e  waiters or clien
+00047d70: 7473 2068 6f6c 6469 6e67 2061 2066 7574  ts holding a fut
+00047d80: 7572 652e 0a20 2020 2020 2020 2073 656c  ure..        sel
+00047d90: 662e 7472 616e 7369 7469 6f6e 7328 7b6b  f.transitions({k
+00047da0: 6579 3a20 2272 656c 6561 7365 6422 7d2c  ey: "released"},
+00047db0: 2073 7469 6d75 6c75 735f 6964 3d73 7469   stimulus_id=sti
+00047dc0: 6d75 6c75 735f 6964 290a 0a20 2020 2023  mulus_id)..    #
+00047dd0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00047de0: 2323 2323 0a20 2020 2023 2055 7469 6c69  ####.    # Utili
+00047df0: 7479 2066 756e 6374 696f 6e73 2023 0a20  ty functions #. 
+00047e00: 2020 2023 2323 2323 2323 2323 2323 2323     #############
+00047e10: 2323 2323 2323 2323 0a0a 2020 2020 6465  ########..    de
+00047e20: 6620 6164 645f 7265 736f 7572 6365 7328  f add_resources(
+00047e30: 0a20 2020 2020 2020 2073 656c 662c 2077  .        self, w
+00047e40: 6f72 6b65 723a 2073 7472 2c20 7265 736f  orker: str, reso
+00047e50: 7572 6365 733a 2064 6963 7420 7c20 4e6f  urces: dict | No
+00047e60: 6e65 203d 204e 6f6e 650a 2020 2020 2920  ne = None.    ) 
+00047e70: 2d3e 204c 6974 6572 616c 5b22 4f4b 225d  -> Literal["OK"]
+00047e80: 3a0a 2020 2020 2020 2020 7773 203d 2073  :.        ws = s
+00047e90: 656c 662e 776f 726b 6572 735b 776f 726b  elf.workers[work
+00047ea0: 6572 5d0a 2020 2020 2020 2020 6966 2072  er].        if r
+00047eb0: 6573 6f75 7263 6573 3a0a 2020 2020 2020  esources:.      
+00047ec0: 2020 2020 2020 7773 2e72 6573 6f75 7263        ws.resourc
+00047ed0: 6573 2e75 7064 6174 6528 7265 736f 7572  es.update(resour
+00047ee0: 6365 7329 0a20 2020 2020 2020 2077 732e  ces).        ws.
+00047ef0: 7573 6564 5f72 6573 6f75 7263 6573 203d  used_resources =
+00047f00: 207b 7d0a 2020 2020 2020 2020 666f 7220   {}.        for 
+00047f10: 7265 736f 7572 6365 2c20 7175 616e 7469  resource, quanti
+00047f20: 7479 2069 6e20 7773 2e72 6573 6f75 7263  ty in ws.resourc
+00047f30: 6573 2e69 7465 6d73 2829 3a0a 2020 2020  es.items():.    
+00047f40: 2020 2020 2020 2020 7773 2e75 7365 645f          ws.used_
+00047f50: 7265 736f 7572 6365 735b 7265 736f 7572  resources[resour
+00047f60: 6365 5d20 3d20 300a 2020 2020 2020 2020  ce] = 0.        
+00047f70: 2020 2020 6472 203d 2073 656c 662e 7265      dr = self.re
+00047f80: 736f 7572 6365 732e 6765 7428 7265 736f  sources.get(reso
+00047f90: 7572 6365 2c20 4e6f 6e65 290a 2020 2020  urce, None).    
+00047fa0: 2020 2020 2020 2020 6966 2064 7220 6973          if dr is
+00047fb0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00047fc0: 2020 2020 2020 2073 656c 662e 7265 736f         self.reso
+00047fd0: 7572 6365 735b 7265 736f 7572 6365 5d20  urces[resource] 
+00047fe0: 3d20 6472 203d 207b 7d0a 2020 2020 2020  = dr = {}.      
+00047ff0: 2020 2020 2020 6472 5b77 6f72 6b65 725d        dr[worker]
+00048000: 203d 2071 7561 6e74 6974 790a 2020 2020   = quantity.    
+00048010: 2020 2020 7265 7475 726e 2022 4f4b 220a      return "OK".
+00048020: 0a20 2020 2064 6566 2072 656d 6f76 655f  .    def remove_
+00048030: 7265 736f 7572 6365 7328 7365 6c66 2c20  resources(self, 
+00048040: 776f 726b 6572 3a20 7374 7229 202d 3e20  worker: str) -> 
+00048050: 4e6f 6e65 3a0a 2020 2020 2020 2020 7773  None:.        ws
+00048060: 203d 2073 656c 662e 776f 726b 6572 735b   = self.workers[
+00048070: 776f 726b 6572 5d0a 2020 2020 2020 2020  worker].        
+00048080: 666f 7220 7265 736f 7572 6365 2069 6e20  for resource in 
+00048090: 7773 2e72 6573 6f75 7263 6573 3a0a 2020  ws.resources:.  
+000480a0: 2020 2020 2020 2020 2020 6472 203d 2073            dr = s
+000480b0: 656c 662e 7265 736f 7572 6365 732e 7365  elf.resources.se
+000480c0: 7464 6566 6175 6c74 2872 6573 6f75 7263  tdefault(resourc
+000480d0: 652c 207b 7d29 0a20 2020 2020 2020 2020  e, {}).         
+000480e0: 2020 2064 656c 2064 725b 776f 726b 6572     del dr[worker
+000480f0: 5d0a 0a20 2020 2064 6566 2063 6f65 7263  ]..    def coerc
+00048100: 655f 6164 6472 6573 7328 7365 6c66 2c20  e_address(self, 
+00048110: 6164 6472 3a20 7374 7220 7c20 7475 706c  addr: str | tupl
+00048120: 652c 2072 6573 6f6c 7665 3a20 626f 6f6c  e, resolve: bool
+00048130: 203d 2054 7275 6529 202d 3e20 7374 723a   = True) -> str:
+00048140: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00048150: 2020 2020 2043 6f65 7263 6520 706f 7373       Coerce poss
+00048160: 6962 6c65 2069 6e70 7574 2061 6464 7265  ible input addre
+00048170: 7373 6573 2074 6f20 6361 6e6f 6e69 6361  sses to canonica
+00048180: 6c20 666f 726d 2e0a 2020 2020 2020 2020  l form..        
+00048190: 2a72 6573 6f6c 7665 2a20 6361 6e20 6265  *resolve* can be
+000481a0: 2064 6973 6162 6c65 6420 666f 7220 7465   disabled for te
+000481b0: 7374 696e 6720 7769 7468 2066 616b 6520  sting with fake 
+000481c0: 686f 7374 6e61 6d65 732e 0a0a 2020 2020  hostnames...    
+000481d0: 2020 2020 4861 6e64 6c65 7320 7374 7269      Handles stri
+000481e0: 6e67 732c 2074 7570 6c65 732c 206f 7220  ngs, tuples, or 
+000481f0: 616c 6961 7365 732e 0a20 2020 2020 2020  aliases..       
+00048200: 2022 2222 0a20 2020 2020 2020 2023 2058   """.        # X
+00048210: 5858 2068 6f77 206d 616e 7920 6164 6472  XX how many addr
+00048220: 6573 732d 7061 7273 696e 6720 726f 7574  ess-parsing rout
+00048230: 696e 6573 2064 6f20 7765 2068 6176 653f  ines do we have?
+00048240: 0a20 2020 2020 2020 2069 6620 6164 6472  .        if addr
+00048250: 2069 6e20 7365 6c66 2e61 6c69 6173 6573   in self.aliases
+00048260: 3a0a 2020 2020 2020 2020 2020 2020 6164  :.            ad
+00048270: 6472 203d 2073 656c 662e 616c 6961 7365  dr = self.aliase
+00048280: 735b 6164 6472 5d0a 2020 2020 2020 2020  s[addr].        
+00048290: 6966 2069 7369 6e73 7461 6e63 6528 6164  if isinstance(ad
+000482a0: 6472 2c20 7475 706c 6529 3a0a 2020 2020  dr, tuple):.    
+000482b0: 2020 2020 2020 2020 6164 6472 203d 2075          addr = u
+000482c0: 6e70 6172 7365 5f68 6f73 745f 706f 7274  nparse_host_port
+000482d0: 282a 6164 6472 290a 2020 2020 2020 2020  (*addr).        
+000482e0: 6966 206e 6f74 2069 7369 6e73 7461 6e63  if not isinstanc
+000482f0: 6528 6164 6472 2c20 7374 7229 3a0a 2020  e(addr, str):.  
+00048300: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00048310: 5479 7065 4572 726f 7228 6622 6164 6472  TypeError(f"addr
+00048320: 6573 7365 7320 7368 6f75 6c64 2062 6520  esses should be 
+00048330: 7374 7269 6e67 7320 6f72 2074 7570 6c65  strings or tuple
+00048340: 732c 2067 6f74 207b 6164 6472 2172 7d22  s, got {addr!r}"
+00048350: 290a 0a20 2020 2020 2020 2069 6620 7265  )..        if re
+00048360: 736f 6c76 653a 0a20 2020 2020 2020 2020  solve:.         
+00048370: 2020 2061 6464 7220 3d20 7265 736f 6c76     addr = resolv
+00048380: 655f 6164 6472 6573 7328 6164 6472 290a  e_address(addr).
+00048390: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+000483a0: 2020 2020 2020 2020 2020 6164 6472 203d            addr =
+000483b0: 206e 6f72 6d61 6c69 7a65 5f61 6464 7265   normalize_addre
+000483c0: 7373 2861 6464 7229 0a0a 2020 2020 2020  ss(addr)..      
+000483d0: 2020 7265 7475 726e 2061 6464 720a 0a20    return addr.. 
+000483e0: 2020 2064 6566 2077 6f72 6b65 7273 5f6c     def workers_l
+000483f0: 6973 7428 7365 6c66 2c20 776f 726b 6572  ist(self, worker
+00048400: 733a 2049 7465 7261 626c 655b 7374 725d  s: Iterable[str]
+00048410: 207c 204e 6f6e 6529 202d 3e20 6c69 7374   | None) -> list
+00048420: 5b73 7472 5d3a 0a20 2020 2020 2020 2022  [str]:.        "
+00048430: 2222 0a20 2020 2020 2020 204c 6973 7420  "".        List 
+00048440: 6f66 2071 7561 6c69 6679 696e 6720 776f  of qualifying wo
+00048450: 726b 6572 730a 0a20 2020 2020 2020 2054  rkers..        T
+00048460: 616b 6573 2061 206c 6973 7420 6f66 2077  akes a list of w
+00048470: 6f72 6b65 7220 6164 6472 6573 7365 7320  orker addresses 
+00048480: 6f72 2068 6f73 746e 616d 6573 2e0a 2020  or hostnames..  
+00048490: 2020 2020 2020 5265 7475 726e 7320 6120        Returns a 
+000484a0: 6c69 7374 206f 6620 616c 6c20 776f 726b  list of all work
+000484b0: 6572 2061 6464 7265 7373 6573 2074 6861  er addresses tha
+000484c0: 7420 6d61 7463 680a 2020 2020 2020 2020  t match.        
+000484d0: 2222 220a 2020 2020 2020 2020 6966 2077  """.        if w
+000484e0: 6f72 6b65 7273 2069 7320 4e6f 6e65 3a0a  orkers is None:.
+000484f0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00048500: 726e 206c 6973 7428 7365 6c66 2e77 6f72  rn list(self.wor
+00048510: 6b65 7273 290a 0a20 2020 2020 2020 206f  kers)..        o
+00048520: 7574 203d 2073 6574 2829 0a20 2020 2020  ut = set().     
+00048530: 2020 2066 6f72 2077 2069 6e20 776f 726b     for w in work
+00048540: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
+00048550: 2069 6620 223a 2220 696e 2077 3a0a 2020   if ":" in w:.  
+00048560: 2020 2020 2020 2020 2020 2020 2020 6f75                ou
+00048570: 742e 6164 6428 7729 0a20 2020 2020 2020  t.add(w).       
+00048580: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00048590: 2020 2020 2020 2020 2020 206f 7574 2e75             out.u
+000485a0: 7064 6174 6528 7b77 7720 666f 7220 7777  pdate({ww for ww
+000485b0: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
+000485c0: 2069 6620 7720 696e 2077 777d 2920 2023   if w in ww})  #
+000485d0: 2054 4f44 4f3a 2071 7561 6472 6174 6963   TODO: quadratic
+000485e0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000485f0: 6c69 7374 286f 7574 290a 0a20 2020 2061  list(out)..    a
+00048600: 7379 6e63 2064 6566 2067 6574 5f70 726f  sync def get_pro
+00048610: 6669 6c65 280a 2020 2020 2020 2020 7365  file(.        se
+00048620: 6c66 2c0a 2020 2020 2020 2020 636f 6d6d  lf,.        comm
+00048630: 3d4e 6f6e 652c 0a20 2020 2020 2020 2077  =None,.        w
+00048640: 6f72 6b65 7273 3d4e 6f6e 652c 0a20 2020  orkers=None,.   
+00048650: 2020 2020 2073 6368 6564 756c 6572 3d46       scheduler=F
+00048660: 616c 7365 2c0a 2020 2020 2020 2020 7365  alse,.        se
+00048670: 7276 6572 3d46 616c 7365 2c0a 2020 2020  rver=False,.    
+00048680: 2020 2020 6d65 7267 655f 776f 726b 6572      merge_worker
+00048690: 733d 5472 7565 2c0a 2020 2020 2020 2020  s=True,.        
+000486a0: 7374 6172 743d 4e6f 6e65 2c0a 2020 2020  start=None,.    
+000486b0: 2020 2020 7374 6f70 3d4e 6f6e 652c 0a20      stop=None,. 
+000486c0: 2020 2020 2020 206b 6579 3d4e 6f6e 652c         key=None,
+000486d0: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
+000486e0: 6966 2077 6f72 6b65 7273 2069 7320 4e6f  if workers is No
+000486f0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00048700: 776f 726b 6572 7320 3d20 7365 6c66 2e77  workers = self.w
+00048710: 6f72 6b65 7273 0a20 2020 2020 2020 2065  orkers.        e
+00048720: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00048730: 2077 6f72 6b65 7273 203d 2073 6574 2873   workers = set(s
+00048740: 656c 662e 776f 726b 6572 7329 2026 2073  elf.workers) & s
+00048750: 6574 2877 6f72 6b65 7273 290a 0a20 2020  et(workers)..   
+00048760: 2020 2020 2069 6620 7363 6865 6475 6c65       if schedule
+00048770: 723a 0a20 2020 2020 2020 2020 2020 2072  r:.            r
+00048780: 6574 7572 6e20 7072 6f66 696c 652e 6765  eturn profile.ge
+00048790: 745f 7072 6f66 696c 6528 7365 6c66 2e69  t_profile(self.i
+000487a0: 6f5f 6c6f 6f70 2e70 726f 6669 6c65 2c20  o_loop.profile, 
+000487b0: 7374 6172 743d 7374 6172 742c 2073 746f  start=start, sto
+000487c0: 703d 7374 6f70 290a 0a20 2020 2020 2020  p=stop)..       
+000487d0: 2072 6573 756c 7473 203d 2061 7761 6974   results = await
+000487e0: 2061 7379 6e63 696f 2e67 6174 6865 7228   asyncio.gather(
+000487f0: 0a20 2020 2020 2020 2020 2020 202a 280a  .            *(.
+00048800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048810: 7365 6c66 2e72 7063 2877 292e 7072 6f66  self.rpc(w).prof
+00048820: 696c 6528 7374 6172 743d 7374 6172 742c  ile(start=start,
+00048830: 2073 746f 703d 7374 6f70 2c20 6b65 793d   stop=stop, key=
+00048840: 6b65 792c 2073 6572 7665 723d 7365 7276  key, server=serv
+00048850: 6572 290a 2020 2020 2020 2020 2020 2020  er).            
+00048860: 2020 2020 666f 7220 7720 696e 2077 6f72      for w in wor
+00048870: 6b65 7273 0a20 2020 2020 2020 2020 2020  kers.           
+00048880: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
+00048890: 7265 7475 726e 5f65 7863 6570 7469 6f6e  return_exception
+000488a0: 733d 5472 7565 2c0a 2020 2020 2020 2020  s=True,.        
+000488b0: 290a 0a20 2020 2020 2020 2072 6573 756c  )..        resul
+000488c0: 7473 203d 205b 7220 666f 7220 7220 696e  ts = [r for r in
+000488d0: 2072 6573 756c 7473 2069 6620 6e6f 7420   results if not 
+000488e0: 6973 696e 7374 616e 6365 2872 2c20 4578  isinstance(r, Ex
+000488f0: 6365 7074 696f 6e29 5d0a 0a20 2020 2020  ception)]..     
+00048900: 2020 2069 6620 6d65 7267 655f 776f 726b     if merge_work
+00048910: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
+00048920: 2072 6573 706f 6e73 6520 3d20 7072 6f66   response = prof
+00048930: 696c 652e 6d65 7267 6528 2a72 6573 756c  ile.merge(*resul
+00048940: 7473 290a 2020 2020 2020 2020 656c 7365  ts).        else
+00048950: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00048960: 7370 6f6e 7365 203d 2064 6963 7428 7a69  sponse = dict(zi
+00048970: 7028 776f 726b 6572 732c 2072 6573 756c  p(workers, resul
+00048980: 7473 2929 0a20 2020 2020 2020 2072 6574  ts)).        ret
+00048990: 7572 6e20 7265 7370 6f6e 7365 0a0a 2020  urn response..  
+000489a0: 2020 6173 796e 6320 6465 6620 6765 745f    async def get_
+000489b0: 7072 6f66 696c 655f 6d65 7461 6461 7461  profile_metadata
+000489c0: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+000489d0: 2020 2020 2020 2020 776f 726b 6572 733a          workers:
+000489e0: 2049 7465 7261 626c 655b 7374 725d 207c   Iterable[str] |
+000489f0: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
+00048a00: 2020 2020 2020 7374 6172 743a 2066 6c6f        start: flo
+00048a10: 6174 203d 2030 2c0a 2020 2020 2020 2020  at = 0,.        
+00048a20: 7374 6f70 3a20 666c 6f61 7420 7c20 4e6f  stop: float | No
+00048a30: 6e65 203d 204e 6f6e 652c 0a20 2020 2020  ne = None,.     
+00048a40: 2020 2070 726f 6669 6c65 5f63 7963 6c65     profile_cycle
+00048a50: 5f69 6e74 6572 7661 6c3a 2073 7472 207c  _interval: str |
+00048a60: 2066 6c6f 6174 207c 204e 6f6e 6520 3d20   float | None = 
+00048a70: 4e6f 6e65 2c0a 2020 2020 2920 2d3e 2064  None,.    ) -> d
+00048a80: 6963 745b 7374 722c 2041 6e79 5d3a 0a20  ict[str, Any]:. 
+00048a90: 2020 2020 2020 2064 7420 3d20 7072 6f66         dt = prof
+00048aa0: 696c 655f 6379 636c 655f 696e 7465 7276  ile_cycle_interv
+00048ab0: 616c 206f 7220 6461 736b 2e63 6f6e 6669  al or dask.confi
+00048ac0: 672e 6765 7428 0a20 2020 2020 2020 2020  g.get(.         
+00048ad0: 2020 2022 6469 7374 7269 6275 7465 642e     "distributed.
+00048ae0: 776f 726b 6572 2e70 726f 6669 6c65 2e63  worker.profile.c
+00048af0: 7963 6c65 220a 2020 2020 2020 2020 290a  ycle".        ).
+00048b00: 2020 2020 2020 2020 6474 203d 2070 6172          dt = par
+00048b10: 7365 5f74 696d 6564 656c 7461 2864 742c  se_timedelta(dt,
+00048b20: 2064 6566 6175 6c74 3d22 6d73 2229 0a0a   default="ms")..
+00048b30: 2020 2020 2020 2020 6966 2077 6f72 6b65          if worke
+00048b40: 7273 2069 7320 4e6f 6e65 3a0a 2020 2020  rs is None:.    
+00048b50: 2020 2020 2020 2020 776f 726b 6572 7320          workers 
+00048b60: 3d20 7365 6c66 2e77 6f72 6b65 7273 0a20  = self.workers. 
+00048b70: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00048b80: 2020 2020 2020 2020 2077 6f72 6b65 7273           workers
+00048b90: 203d 2073 6574 2873 656c 662e 776f 726b   = set(self.work
+00048ba0: 6572 7329 2026 2073 6574 2877 6f72 6b65  ers) & set(worke
+00048bb0: 7273 290a 2020 2020 2020 2020 7265 7375  rs).        resu
+00048bc0: 6c74 733a 2053 6571 7565 6e63 655b 416e  lts: Sequence[An
+00048bd0: 795d 203d 2061 7761 6974 2061 7379 6e63  y] = await async
+00048be0: 696f 2e67 6174 6865 7228 0a20 2020 2020  io.gather(.     
+00048bf0: 2020 2020 2020 202a 2873 656c 662e 7270         *(self.rp
+00048c00: 6328 7729 2e70 726f 6669 6c65 5f6d 6574  c(w).profile_met
+00048c10: 6164 6174 6128 7374 6172 743d 7374 6172  adata(start=star
+00048c20: 742c 2073 746f 703d 7374 6f70 2920 666f  t, stop=stop) fo
+00048c30: 7220 7720 696e 2077 6f72 6b65 7273 292c  r w in workers),
+00048c40: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00048c50: 7572 6e5f 6578 6365 7074 696f 6e73 3d54  urn_exceptions=T
+00048c60: 7275 652c 0a20 2020 2020 2020 2029 0a0a  rue,.        )..
+00048c70: 2020 2020 2020 2020 7265 7375 6c74 7320          results 
+00048c80: 3d20 5b72 2066 6f72 2072 2069 6e20 7265  = [r for r in re
+00048c90: 7375 6c74 7320 6966 206e 6f74 2069 7369  sults if not isi
+00048ca0: 6e73 7461 6e63 6528 722c 2045 7863 6570  nstance(r, Excep
+00048cb0: 7469 6f6e 295d 0a20 2020 2020 2020 2063  tion)].        c
+00048cc0: 6f75 6e74 7320 3d20 5b0a 2020 2020 2020  ounts = [.      
+00048cd0: 2020 2020 2020 2874 696d 652c 2073 756d        (time, sum
+00048ce0: 2870 6c75 636b 2831 2c20 6772 6f75 7029  (pluck(1, group)
+00048cf0: 2929 0a20 2020 2020 2020 2020 2020 2066  )).            f
+00048d00: 6f72 2074 696d 652c 2067 726f 7570 2069  or time, group i
+00048d10: 6e20 6974 6572 746f 6f6c 732e 6772 6f75  n itertools.grou
+00048d20: 7062 7928 0a20 2020 2020 2020 2020 2020  pby(.           
+00048d30: 2020 2020 206d 6572 6765 5f73 6f72 7465       merge_sorte
+00048d40: 6428 0a20 2020 2020 2020 2020 2020 2020  d(.             
+00048d50: 2020 2020 2020 202a 2876 5b22 636f 756e         *(v["coun
+00048d60: 7473 225d 2066 6f72 2076 2069 6e20 7265  ts"] for v in re
+00048d70: 7375 6c74 7329 2c0a 2020 2020 2020 2020  sults),.        
+00048d80: 2020 2020 2020 2020 292c 0a20 2020 2020          ),.     
+00048d90: 2020 2020 2020 2020 2020 206c 616d 6264             lambd
+00048da0: 6120 743a 2074 5b30 5d20 2f2f 2064 7420  a t: t[0] // dt 
+00048db0: 2a20 6474 2c0a 2020 2020 2020 2020 2020  * dt,.          
+00048dc0: 2020 290a 2020 2020 2020 2020 5d0a 0a20    ).        ].. 
+00048dd0: 2020 2020 2020 206b 6579 733a 2064 6963         keys: dic
+00048de0: 745b 4b65 792c 206c 6973 745b 6c69 7374  t[Key, list[list
+00048df0: 5d5d 203d 207b 0a20 2020 2020 2020 2020  ]] = {.         
+00048e00: 2020 206b 3a20 5b5d 2066 6f72 2076 2069     k: [] for v i
+00048e10: 6e20 7265 7375 6c74 7320 666f 7220 742c  n results for t,
+00048e20: 2064 2069 6e20 765b 226b 6579 7322 5d20   d in v["keys"] 
+00048e30: 666f 7220 6b20 696e 2064 0a20 2020 2020  for k in d.     
+00048e40: 2020 207d 0a0a 2020 2020 2020 2020 6772     }..        gr
+00048e50: 6f75 7073 3120 3d20 5b76 5b22 6b65 7973  oups1 = [v["keys
+00048e60: 225d 2066 6f72 2076 2069 6e20 7265 7375  "] for v in resu
+00048e70: 6c74 735d 0a20 2020 2020 2020 2067 726f  lts].        gro
+00048e80: 7570 7332 203d 206c 6973 7428 6d65 7267  ups2 = list(merg
+00048e90: 655f 736f 7274 6564 282a 6772 6f75 7073  e_sorted(*groups
+00048ea0: 312c 206b 6579 3d66 6972 7374 2929 0a0a  1, key=first))..
+00048eb0: 2020 2020 2020 2020 6c61 7374 203d 2030          last = 0
+00048ec0: 0a20 2020 2020 2020 2066 6f72 2074 2c20  .        for t, 
+00048ed0: 6420 696e 2067 726f 7570 7332 3a0a 2020  d in groups2:.  
+00048ee0: 2020 2020 2020 2020 2020 7474 203d 2074            tt = t
+00048ef0: 202f 2f20 6474 202a 2064 740a 2020 2020   // dt * dt.    
+00048f00: 2020 2020 2020 2020 6966 2074 7420 3e20          if tt > 
+00048f10: 6c61 7374 3a0a 2020 2020 2020 2020 2020  last:.          
+00048f20: 2020 2020 2020 6c61 7374 203d 2074 740a        last = tt.
+00048f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048f40: 666f 7220 7620 696e 206b 6579 732e 7661  for v in keys.va
+00048f50: 6c75 6573 2829 3a0a 2020 2020 2020 2020  lues():.        
+00048f60: 2020 2020 2020 2020 2020 2020 762e 6170              v.ap
+00048f70: 7065 6e64 285b 7474 2c20 305d 290a 2020  pend([tt, 0]).  
+00048f80: 2020 2020 2020 2020 2020 666f 7220 6b2c            for k,
+00048f90: 2076 2069 6e20 642e 6974 656d 7328 293a   v in d.items():
+00048fa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00048fb0: 206b 6579 735b 6b5d 5b2d 315d 5b31 5d20   keys[k][-1][1] 
+00048fc0: 2b3d 2076 0a0a 2020 2020 2020 2020 7265  += v..        re
+00048fd0: 7475 726e 207b 2263 6f75 6e74 7322 3a20  turn {"counts": 
+00048fe0: 636f 756e 7473 2c20 226b 6579 7322 3a20  counts, "keys": 
+00048ff0: 6b65 7973 7d0a 0a20 2020 2061 7379 6e63  keys}..    async
+00049000: 2064 6566 2070 6572 666f 726d 616e 6365   def performance
+00049010: 5f72 6570 6f72 7428 0a20 2020 2020 2020  _report(.       
+00049020: 2073 656c 662c 2073 7461 7274 3a20 666c   self, start: fl
+00049030: 6f61 742c 206c 6173 745f 636f 756e 743a  oat, last_count:
+00049040: 2069 6e74 2c20 636f 6465 3a20 7374 7220   int, code: str 
+00049050: 3d20 2222 2c20 6d6f 6465 3a20 7374 7220  = "", mode: str 
+00049060: 7c20 4e6f 6e65 203d 204e 6f6e 650a 2020  | None = None.  
+00049070: 2020 2920 2d3e 2073 7472 3a0a 2020 2020    ) -> str:.    
+00049080: 2020 2020 7374 6f70 203d 2074 696d 6528      stop = time(
+00049090: 290a 2020 2020 2020 2020 2320 5072 6f66  ).        # Prof
+000490a0: 696c 6573 0a20 2020 2020 2020 2063 6f6d  iles.        com
+000490b0: 7075 7465 2c20 7363 6865 6475 6c65 722c  pute, scheduler,
+000490c0: 2077 6f72 6b65 7273 203d 2061 7761 6974   workers = await
+000490d0: 2061 7379 6e63 696f 2e67 6174 6865 7228   asyncio.gather(
+000490e0: 0a20 2020 2020 2020 2020 2020 202a 5b0a  .            *[.
+000490f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00049100: 7365 6c66 2e67 6574 5f70 726f 6669 6c65  self.get_profile
+00049110: 2873 7461 7274 3d73 7461 7274 292c 0a20  (start=start),. 
+00049120: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00049130: 656c 662e 6765 745f 7072 6f66 696c 6528  elf.get_profile(
+00049140: 7363 6865 6475 6c65 723d 5472 7565 2c20  scheduler=True, 
+00049150: 7374 6172 743d 7374 6172 7429 2c0a 2020  start=start),.  
+00049160: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00049170: 6c66 2e67 6574 5f70 726f 6669 6c65 2873  lf.get_profile(s
+00049180: 6572 7665 723d 5472 7565 2c20 7374 6172  erver=True, star
+00049190: 743d 7374 6172 7429 2c0a 2020 2020 2020  t=start),.      
+000491a0: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
+000491b0: 290a 2020 2020 2020 2020 6672 6f6d 2064  ).        from d
+000491c0: 6973 7472 6962 7574 6564 2069 6d70 6f72  istributed impor
+000491d0: 7420 7072 6f66 696c 650a 0a20 2020 2020  t profile..     
+000491e0: 2020 2064 6566 2070 726f 6669 6c65 5f74     def profile_t
+000491f0: 6f5f 6669 6775 7265 2873 7461 7465 293a  o_figure(state):
+00049200: 0a20 2020 2020 2020 2020 2020 2064 6174  .            dat
+00049210: 6120 3d20 7072 6f66 696c 652e 706c 6f74  a = profile.plot
+00049220: 5f64 6174 6128 7374 6174 6529 0a20 2020  _data(state).   
+00049230: 2020 2020 2020 2020 2066 6967 7572 652c           figure,
+00049240: 2073 6f75 7263 6520 3d20 7072 6f66 696c   source = profil
+00049250: 652e 706c 6f74 5f66 6967 7572 6528 6461  e.plot_figure(da
+00049260: 7461 2c20 7369 7a69 6e67 5f6d 6f64 653d  ta, sizing_mode=
+00049270: 2273 7472 6574 6368 5f62 6f74 6822 290a  "stretch_both").
+00049280: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00049290: 726e 2066 6967 7572 650a 0a20 2020 2020  rn figure..     
+000492a0: 2020 2063 6f6d 7075 7465 2c20 7363 6865     compute, sche
+000492b0: 6475 6c65 722c 2077 6f72 6b65 7273 203d  duler, workers =
+000492c0: 206d 6170 280a 2020 2020 2020 2020 2020   map(.          
+000492d0: 2020 7072 6f66 696c 655f 746f 5f66 6967    profile_to_fig
+000492e0: 7572 652c 2028 636f 6d70 7574 652c 2073  ure, (compute, s
+000492f0: 6368 6564 756c 6572 2c20 776f 726b 6572  cheduler, worker
+00049300: 7329 0a20 2020 2020 2020 2029 0a0a 2020  s).        )..  
+00049310: 2020 2020 2020 2320 5461 736b 2073 7472        # Task str
+00049320: 6561 6d0a 2020 2020 2020 2020 7461 736b  eam.        task
+00049330: 5f73 7472 6561 6d20 3d20 7365 6c66 2e67  _stream = self.g
+00049340: 6574 5f74 6173 6b5f 7374 7265 616d 2873  et_task_stream(s
+00049350: 7461 7274 3d73 7461 7274 290a 2020 2020  tart=start).    
+00049360: 2020 2020 746f 7461 6c5f 7461 736b 7320      total_tasks 
+00049370: 3d20 6c65 6e28 7461 736b 5f73 7472 6561  = len(task_strea
+00049380: 6d29 0a20 2020 2020 2020 2074 696d 6573  m).        times
+00049390: 7065 6e74 3a20 6465 6661 756c 7464 6963  pent: defaultdic
+000493a0: 745b 7374 722c 2066 6c6f 6174 5d20 3d20  t[str, float] = 
+000493b0: 6465 6661 756c 7464 6963 7428 666c 6f61  defaultdict(floa
+000493c0: 7429 0a20 2020 2020 2020 2066 6f72 2064  t).        for d
+000493d0: 2069 6e20 7461 736b 5f73 7472 6561 6d3a   in task_stream:
+000493e0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+000493f0: 2078 2069 6e20 645b 2273 7461 7274 7374   x in d["startst
+00049400: 6f70 7322 5d3a 0a20 2020 2020 2020 2020  ops"]:.         
+00049410: 2020 2020 2020 2074 696d 6573 7065 6e74         timespent
+00049420: 5b78 5b22 6163 7469 6f6e 225d 5d20 2b3d  [x["action"]] +=
+00049430: 2078 5b22 7374 6f70 225d 202d 2078 5b22   x["stop"] - x["
+00049440: 7374 6172 7422 5d0a 2020 2020 2020 2020  start"].        
+00049450: 7461 736b 735f 7469 6d69 6e67 7320 3d20  tasks_timings = 
+00049460: 2222 0a20 2020 2020 2020 2066 6f72 206b  "".        for k
+00049470: 2069 6e20 736f 7274 6564 2874 696d 6573   in sorted(times
+00049480: 7065 6e74 2e6b 6579 7328 2929 3a0a 2020  pent.keys()):.  
+00049490: 2020 2020 2020 2020 2020 7461 736b 735f            tasks_
+000494a0: 7469 6d69 6e67 7320 2b3d 2066 225c 6e3c  timings += f"\n<
+000494b0: 6c69 3e20 7b6b 7d20 7469 6d65 3a20 7b66  li> {k} time: {f
+000494c0: 6f72 6d61 745f 7469 6d65 2874 696d 6573  ormat_time(times
+000494d0: 7065 6e74 5b6b 5d29 7d20 3c2f 6c69 3e22  pent[k])} </li>"
+000494e0: 0a0a 2020 2020 2020 2020 6672 6f6d 2064  ..        from d
+000494f0: 6973 7472 6962 7574 6564 2e64 6173 6862  istributed.dashb
+00049500: 6f61 7264 2e63 6f6d 706f 6e65 6e74 732e  oard.components.
+00049510: 7363 6865 6475 6c65 7220 696d 706f 7274  scheduler import
+00049520: 2074 6173 6b5f 7374 7265 616d 5f66 6967   task_stream_fig
+00049530: 7572 650a 2020 2020 2020 2020 6672 6f6d  ure.        from
+00049540: 2064 6973 7472 6962 7574 6564 2e64 6961   distributed.dia
+00049550: 676e 6f73 7469 6373 2e74 6173 6b5f 7374  gnostics.task_st
+00049560: 7265 616d 2069 6d70 6f72 7420 7265 6374  ream import rect
+00049570: 616e 676c 6573 0a0a 2020 2020 2020 2020  angles..        
+00049580: 7265 6374 7320 3d20 7265 6374 616e 676c  rects = rectangl
+00049590: 6573 2874 6173 6b5f 7374 7265 616d 290a  es(task_stream).
+000495a0: 2020 2020 2020 2020 736f 7572 6365 2c20          source, 
+000495b0: 7461 736b 5f73 7472 6561 6d20 3d20 7461  task_stream = ta
+000495c0: 736b 5f73 7472 6561 6d5f 6669 6775 7265  sk_stream_figure
+000495d0: 2873 697a 696e 675f 6d6f 6465 3d22 7374  (sizing_mode="st
+000495e0: 7265 7463 685f 626f 7468 2229 0a20 2020  retch_both").   
+000495f0: 2020 2020 2073 6f75 7263 652e 6461 7461       source.data
+00049600: 2e75 7064 6174 6528 7265 6374 7329 0a0a  .update(rects)..
+00049610: 2020 2020 2020 2020 2320 4261 6e64 7769          # Bandwi
+00049620: 6474 680a 2020 2020 2020 2020 6672 6f6d  dth.        from
+00049630: 2064 6973 7472 6962 7574 6564 2e64 6173   distributed.das
+00049640: 6862 6f61 7264 2e63 6f6d 706f 6e65 6e74  hboard.component
+00049650: 732e 7363 6865 6475 6c65 7220 696d 706f  s.scheduler impo
+00049660: 7274 2028 0a20 2020 2020 2020 2020 2020  rt (.           
+00049670: 2042 616e 6477 6964 7468 5479 7065 732c   BandwidthTypes,
+00049680: 0a20 2020 2020 2020 2020 2020 2042 616e  .            Ban
+00049690: 6477 6964 7468 576f 726b 6572 732c 0a20  dwidthWorkers,. 
+000496a0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+000496b0: 2020 6261 6e64 7769 6474 685f 776f 726b    bandwidth_work
+000496c0: 6572 7320 3d20 4261 6e64 7769 6474 6857  ers = BandwidthW
+000496d0: 6f72 6b65 7273 2873 656c 662c 2073 697a  orkers(self, siz
+000496e0: 696e 675f 6d6f 6465 3d22 7374 7265 7463  ing_mode="stretc
+000496f0: 685f 626f 7468 2229 0a20 2020 2020 2020  h_both").       
+00049700: 2062 616e 6477 6964 7468 5f77 6f72 6b65   bandwidth_worke
+00049710: 7273 2e75 7064 6174 6528 290a 2020 2020  rs.update().    
+00049720: 2020 2020 6261 6e64 7769 6474 685f 7479      bandwidth_ty
+00049730: 7065 7320 3d20 4261 6e64 7769 6474 6854  pes = BandwidthT
+00049740: 7970 6573 2873 656c 662c 2073 697a 696e  ypes(self, sizin
+00049750: 675f 6d6f 6465 3d22 7374 7265 7463 685f  g_mode="stretch_
+00049760: 626f 7468 2229 0a20 2020 2020 2020 2062  both").        b
+00049770: 616e 6477 6964 7468 5f74 7970 6573 2e75  andwidth_types.u
+00049780: 7064 6174 6528 290a 0a20 2020 2020 2020  pdate()..       
+00049790: 2023 2053 7973 7465 6d20 6d6f 6e69 746f   # System monito
+000497a0: 720a 2020 2020 2020 2020 6672 6f6d 2064  r.        from d
+000497b0: 6973 7472 6962 7574 6564 2e64 6173 6862  istributed.dashb
+000497c0: 6f61 7264 2e63 6f6d 706f 6e65 6e74 732e  oard.components.
+000497d0: 7368 6172 6564 2069 6d70 6f72 7420 5379  shared import Sy
+000497e0: 7374 656d 4d6f 6e69 746f 720a 0a20 2020  stemMonitor..   
+000497f0: 2020 2020 2073 7973 6d6f 6e20 3d20 5379       sysmon = Sy
+00049800: 7374 656d 4d6f 6e69 746f 7228 7365 6c66  stemMonitor(self
+00049810: 2c20 6c61 7374 5f63 6f75 6e74 3d6c 6173  , last_count=las
+00049820: 745f 636f 756e 742c 2073 697a 696e 675f  t_count, sizing_
+00049830: 6d6f 6465 3d22 7374 7265 7463 685f 626f  mode="stretch_bo
+00049840: 7468 2229 0a20 2020 2020 2020 2073 7973  th").        sys
+00049850: 6d6f 6e2e 7570 6461 7465 2829 0a0a 2020  mon.update()..  
+00049860: 2020 2020 2020 2320 5363 6865 6475 6c65        # Schedule
+00049870: 7220 6c6f 6773 0a20 2020 2020 2020 2066  r logs.        f
+00049880: 726f 6d20 6469 7374 7269 6275 7465 642e  rom distributed.
+00049890: 6461 7368 626f 6172 642e 636f 6d70 6f6e  dashboard.compon
+000498a0: 656e 7473 2e73 6368 6564 756c 6572 2069  ents.scheduler i
+000498b0: 6d70 6f72 7420 280a 2020 2020 2020 2020  mport (.        
+000498c0: 2020 2020 5f42 4f4b 4548 5f53 5459 4c45      _BOKEH_STYLE
+000498d0: 535f 4b57 4152 4753 2c0a 2020 2020 2020  S_KWARGS,.      
+000498e0: 2020 2020 2020 5363 6865 6475 6c65 724c        SchedulerL
+000498f0: 6f67 732c 0a20 2020 2020 2020 2029 0a0a  ogs,.        )..
+00049900: 2020 2020 2020 2020 6c6f 6773 203d 2053          logs = S
+00049910: 6368 6564 756c 6572 4c6f 6773 2873 656c  chedulerLogs(sel
+00049920: 662c 2073 7461 7274 3d73 7461 7274 290a  f, start=start).
+00049930: 0a20 2020 2020 2020 2066 726f 6d20 626f  .        from bo
+00049940: 6b65 682e 6d6f 6465 6c73 2069 6d70 6f72  keh.models impor
+00049950: 7420 4469 762c 2054 6162 730a 0a20 2020  t Div, Tabs..   
+00049960: 2020 2020 2069 6d70 6f72 7420 6469 7374       import dist
+00049970: 7269 6275 7465 640a 2020 2020 2020 2020  ributed.        
+00049980: 6672 6f6d 2064 6973 7472 6962 7574 6564  from distributed
+00049990: 2e64 6173 6862 6f61 7264 2e63 6f72 6520  .dashboard.core 
+000499a0: 696d 706f 7274 2054 6162 5061 6e65 6c0a  import TabPanel.
+000499b0: 0a20 2020 2020 2020 2023 2048 544d 4c0a  .        # HTML.
+000499c0: 2020 2020 2020 2020 6874 6d6c 203d 2022          html = "
+000499d0: 2222 0a20 2020 2020 2020 203c 6831 3e20  "".        <h1> 
+000499e0: 4461 736b 2050 6572 666f 726d 616e 6365  Dask Performance
+000499f0: 2052 6570 6f72 7420 3c2f 6831 3e0a 0a20   Report </h1>.. 
+00049a00: 2020 2020 2020 203c 693e 2053 656c 6563         <i> Selec
+00049a10: 7420 6469 6666 6572 656e 7420 7461 6273  t different tabs
+00049a20: 206f 6e20 7468 6520 746f 7020 666f 7220   on the top for 
+00049a30: 6164 6469 7469 6f6e 616c 2069 6e66 6f72  additional infor
+00049a40: 6d61 7469 6f6e 203c 2f69 3e0a 0a20 2020  mation </i>..   
+00049a50: 2020 2020 203c 6832 3e20 4475 7261 7469       <h2> Durati
+00049a60: 6f6e 3a20 7b74 696d 657d 203c 2f68 323e  on: {time} </h2>
+00049a70: 0a20 2020 2020 2020 203c 6832 3e20 5461  .        <h2> Ta
+00049a80: 736b 7320 496e 666f 726d 6174 696f 6e20  sks Information 
+00049a90: 3c2f 6832 3e0a 2020 2020 2020 2020 3c75  </h2>.        <u
+00049aa0: 6c3e 0a20 2020 2020 2020 2020 3c6c 693e  l>.         <li>
+00049ab0: 206e 756d 6265 7220 6f66 2074 6173 6b73   number of tasks
+00049ac0: 3a20 7b6e 7461 736b 737d 203c 2f6c 693e  : {ntasks} </li>
+00049ad0: 0a20 2020 2020 2020 2020 7b74 6173 6b73  .         {tasks
+00049ae0: 5f74 696d 696e 6773 7d0a 2020 2020 2020  _timings}.      
+00049af0: 2020 3c2f 756c 3e0a 0a20 2020 2020 2020    </ul>..       
+00049b00: 203c 6832 3e20 5363 6865 6475 6c65 7220   <h2> Scheduler 
+00049b10: 496e 666f 726d 6174 696f 6e20 3c2f 6832  Information </h2
+00049b20: 3e0a 2020 2020 2020 2020 3c75 6c3e 0a20  >.        <ul>. 
+00049b30: 2020 2020 2020 2020 203c 6c69 3e20 4164           <li> Ad
+00049b40: 6472 6573 733a 207b 6164 6472 6573 737d  dress: {address}
+00049b50: 203c 2f6c 693e 0a20 2020 2020 2020 2020   </li>.         
+00049b60: 203c 6c69 3e20 576f 726b 6572 733a 207b   <li> Workers: {
+00049b70: 6e77 6f72 6b65 7273 7d20 3c2f 6c69 3e0a  nworkers} </li>.
+00049b80: 2020 2020 2020 2020 2020 3c6c 693e 2054            <li> T
+00049b90: 6872 6561 6473 3a20 7b74 6872 6561 6473  hreads: {threads
+00049ba0: 7d20 3c2f 6c69 3e0a 2020 2020 2020 2020  } </li>.        
+00049bb0: 2020 3c6c 693e 204d 656d 6f72 793a 207b    <li> Memory: {
+00049bc0: 6d65 6d6f 7279 7d20 3c2f 6c69 3e0a 2020  memory} </li>.  
+00049bd0: 2020 2020 2020 2020 3c6c 693e 2044 6173          <li> Das
+00049be0: 6b20 5665 7273 696f 6e3a 207b 6461 736b  k Version: {dask
+00049bf0: 5f76 6572 7369 6f6e 7d20 3c2f 6c69 3e0a  _version} </li>.
+00049c00: 2020 2020 2020 2020 2020 3c6c 693e 2044            <li> D
+00049c10: 6173 6b2e 4469 7374 7269 6275 7465 6420  ask.Distributed 
+00049c20: 5665 7273 696f 6e3a 207b 6469 7374 7269  Version: {distri
+00049c30: 6275 7465 645f 7665 7273 696f 6e7d 203c  buted_version} <
+00049c40: 2f6c 693e 0a20 2020 2020 2020 203c 2f75  /li>.        </u
+00049c50: 6c3e 0a0a 2020 2020 2020 2020 3c68 323e  l>..        <h2>
+00049c60: 2043 616c 6c69 6e67 2043 6f64 6520 3c2f   Calling Code </
+00049c70: 6832 3e0a 2020 2020 2020 2020 3c70 7265  h2>.        <pre
+00049c80: 3e0a 7b63 6f64 657d 0a20 2020 2020 2020  >.{code}.       
+00049c90: 203c 2f70 7265 3e0a 2020 2020 2020 2020   </pre>.        
+00049ca0: 2222 222e 666f 726d 6174 280a 2020 2020  """.format(.    
+00049cb0: 2020 2020 2020 2020 7469 6d65 3d66 6f72          time=for
+00049cc0: 6d61 745f 7469 6d65 2873 746f 7020 2d20  mat_time(stop - 
+00049cd0: 7374 6172 7429 2c0a 2020 2020 2020 2020  start),.        
+00049ce0: 2020 2020 6e74 6173 6b73 3d74 6f74 616c      ntasks=total
+00049cf0: 5f74 6173 6b73 2c0a 2020 2020 2020 2020  _tasks,.        
+00049d00: 2020 2020 7461 736b 735f 7469 6d69 6e67      tasks_timing
+00049d10: 733d 7461 736b 735f 7469 6d69 6e67 732c  s=tasks_timings,
+00049d20: 0a20 2020 2020 2020 2020 2020 2061 6464  .            add
+00049d30: 7265 7373 3d73 656c 662e 6164 6472 6573  ress=self.addres
+00049d40: 732c 0a20 2020 2020 2020 2020 2020 206e  s,.            n
+00049d50: 776f 726b 6572 733d 6c65 6e28 7365 6c66  workers=len(self
+00049d60: 2e77 6f72 6b65 7273 292c 0a20 2020 2020  .workers),.     
+00049d70: 2020 2020 2020 2074 6872 6561 6473 3d73         threads=s
+00049d80: 756d 2877 732e 6e74 6872 6561 6473 2066  um(ws.nthreads f
+00049d90: 6f72 2077 7320 696e 2073 656c 662e 776f  or ws in self.wo
+00049da0: 726b 6572 732e 7661 6c75 6573 2829 292c  rkers.values()),
+00049db0: 0a20 2020 2020 2020 2020 2020 206d 656d  .            mem
+00049dc0: 6f72 793d 666f 726d 6174 5f62 7974 6573  ory=format_bytes
+00049dd0: 2873 756d 2877 732e 6d65 6d6f 7279 5f6c  (sum(ws.memory_l
+00049de0: 696d 6974 2066 6f72 2077 7320 696e 2073  imit for ws in s
+00049df0: 656c 662e 776f 726b 6572 732e 7661 6c75  elf.workers.valu
+00049e00: 6573 2829 2929 2c0a 2020 2020 2020 2020  es())),.        
+00049e10: 2020 2020 636f 6465 3d63 6f64 652c 0a20      code=code,. 
+00049e20: 2020 2020 2020 2020 2020 2064 6173 6b5f             dask_
+00049e30: 7665 7273 696f 6e3d 6461 736b 2e5f 5f76  version=dask.__v
+00049e40: 6572 7369 6f6e 5f5f 2c0a 2020 2020 2020  ersion__,.      
+00049e50: 2020 2020 2020 6469 7374 7269 6275 7465        distribute
+00049e60: 645f 7665 7273 696f 6e3d 6469 7374 7269  d_version=distri
+00049e70: 6275 7465 642e 5f5f 7665 7273 696f 6e5f  buted.__version_
+00049e80: 5f2c 0a20 2020 2020 2020 2029 0a20 2020  _,.        ).   
+00049e90: 2020 2020 2068 746d 6c20 3d20 4469 7628       html = Div(
+00049ea0: 7465 7874 3d68 746d 6c2c 202a 2a5f 424f  text=html, **_BO
+00049eb0: 4b45 485f 5354 594c 4553 5f4b 5741 5247  KEH_STYLES_KWARG
+00049ec0: 5329 0a0a 2020 2020 2020 2020 6874 6d6c  S)..        html
+00049ed0: 203d 2054 6162 5061 6e65 6c28 6368 696c   = TabPanel(chil
+00049ee0: 643d 6874 6d6c 2c20 7469 746c 653d 2253  d=html, title="S
+00049ef0: 756d 6d61 7279 2229 0a20 2020 2020 2020  ummary").       
+00049f00: 2063 6f6d 7075 7465 203d 2054 6162 5061   compute = TabPa
+00049f10: 6e65 6c28 6368 696c 643d 636f 6d70 7574  nel(child=comput
+00049f20: 652c 2074 6974 6c65 3d22 576f 726b 6572  e, title="Worker
+00049f30: 2050 726f 6669 6c65 2028 636f 6d70 7574   Profile (comput
+00049f40: 6529 2229 0a20 2020 2020 2020 2077 6f72  e)").        wor
+00049f50: 6b65 7273 203d 2054 6162 5061 6e65 6c28  kers = TabPanel(
+00049f60: 6368 696c 643d 776f 726b 6572 732c 2074  child=workers, t
+00049f70: 6974 6c65 3d22 576f 726b 6572 2050 726f  itle="Worker Pro
+00049f80: 6669 6c65 2028 6164 6d69 6e69 7374 7261  file (administra
+00049f90: 7469 7665 2922 290a 2020 2020 2020 2020  tive)").        
+00049fa0: 7363 6865 6475 6c65 7220 3d20 5461 6250  scheduler = TabP
+00049fb0: 616e 656c 280a 2020 2020 2020 2020 2020  anel(.          
+00049fc0: 2020 6368 696c 643d 7363 6865 6475 6c65    child=schedule
+00049fd0: 722c 2074 6974 6c65 3d22 5363 6865 6475  r, title="Schedu
+00049fe0: 6c65 7220 5072 6f66 696c 6520 2861 646d  ler Profile (adm
+00049ff0: 696e 6973 7472 6174 6976 6529 220a 2020  inistrative)".  
+0004a000: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0004a010: 7461 736b 5f73 7472 6561 6d20 3d20 5461  task_stream = Ta
+0004a020: 6250 616e 656c 2863 6869 6c64 3d74 6173  bPanel(child=tas
+0004a030: 6b5f 7374 7265 616d 2c20 7469 746c 653d  k_stream, title=
+0004a040: 2254 6173 6b20 5374 7265 616d 2229 0a20  "Task Stream"). 
+0004a050: 2020 2020 2020 2062 616e 6477 6964 7468         bandwidth
+0004a060: 5f77 6f72 6b65 7273 203d 2054 6162 5061  _workers = TabPa
+0004a070: 6e65 6c28 0a20 2020 2020 2020 2020 2020  nel(.           
+0004a080: 2063 6869 6c64 3d62 616e 6477 6964 7468   child=bandwidth
+0004a090: 5f77 6f72 6b65 7273 2e72 6f6f 742c 2074  _workers.root, t
+0004a0a0: 6974 6c65 3d22 4261 6e64 7769 6474 6820  itle="Bandwidth 
+0004a0b0: 2857 6f72 6b65 7273 2922 0a20 2020 2020  (Workers)".     
+0004a0c0: 2020 2029 0a20 2020 2020 2020 2062 616e     ).        ban
+0004a0d0: 6477 6964 7468 5f74 7970 6573 203d 2054  dwidth_types = T
+0004a0e0: 6162 5061 6e65 6c28 0a20 2020 2020 2020  abPanel(.       
+0004a0f0: 2020 2020 2063 6869 6c64 3d62 616e 6477       child=bandw
+0004a100: 6964 7468 5f74 7970 6573 2e72 6f6f 742c  idth_types.root,
+0004a110: 2074 6974 6c65 3d22 4261 6e64 7769 6474   title="Bandwidt
+0004a120: 6820 2854 7970 6573 2922 0a20 2020 2020  h (Types)".     
+0004a130: 2020 2029 0a20 2020 2020 2020 2073 7973     ).        sys
+0004a140: 7465 6d20 3d20 5461 6250 616e 656c 2863  tem = TabPanel(c
+0004a150: 6869 6c64 3d73 7973 6d6f 6e2e 726f 6f74  hild=sysmon.root
+0004a160: 2c20 7469 746c 653d 2253 7973 7465 6d22  , title="System"
+0004a170: 290a 2020 2020 2020 2020 6c6f 6773 203d  ).        logs =
+0004a180: 2054 6162 5061 6e65 6c28 6368 696c 643d   TabPanel(child=
+0004a190: 6c6f 6773 2e72 6f6f 742c 2074 6974 6c65  logs.root, title
+0004a1a0: 3d22 5363 6865 6475 6c65 7220 4c6f 6773  ="Scheduler Logs
+0004a1b0: 2229 0a0a 2020 2020 2020 2020 7461 6273  ")..        tabs
+0004a1c0: 203d 2054 6162 7328 0a20 2020 2020 2020   = Tabs(.       
+0004a1d0: 2020 2020 2074 6162 733d 5b0a 2020 2020       tabs=[.    
+0004a1e0: 2020 2020 2020 2020 2020 2020 6874 6d6c              html
+0004a1f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0004a200: 2020 7461 736b 5f73 7472 6561 6d2c 0a20    task_stream,. 
+0004a210: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0004a220: 7973 7465 6d2c 0a20 2020 2020 2020 2020  ystem,.         
+0004a230: 2020 2020 2020 206c 6f67 732c 0a20 2020         logs,.   
+0004a240: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
+0004a250: 7075 7465 2c0a 2020 2020 2020 2020 2020  pute,.          
+0004a260: 2020 2020 2020 776f 726b 6572 732c 0a20        workers,. 
+0004a270: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0004a280: 6368 6564 756c 6572 2c0a 2020 2020 2020  cheduler,.      
+0004a290: 2020 2020 2020 2020 2020 6261 6e64 7769            bandwi
+0004a2a0: 6474 685f 776f 726b 6572 732c 0a20 2020  dth_workers,.   
+0004a2b0: 2020 2020 2020 2020 2020 2020 2062 616e               ban
+0004a2c0: 6477 6964 7468 5f74 7970 6573 2c0a 2020  dwidth_types,.  
+0004a2d0: 2020 2020 2020 2020 2020 5d2c 0a20 2020            ],.   
+0004a2e0: 2020 2020 2020 2020 2073 697a 696e 675f           sizing_
+0004a2f0: 6d6f 6465 3d22 7374 7265 7463 685f 626f  mode="stretch_bo
+0004a300: 7468 222c 0a20 2020 2020 2020 2029 0a0a  th",.        )..
+0004a310: 2020 2020 2020 2020 6672 6f6d 2062 6f6b          from bok
+0004a320: 6568 2e63 6f72 652e 7465 6d70 6c61 7465  eh.core.template
+0004a330: 7320 696d 706f 7274 2067 6574 5f65 6e76  s import get_env
+0004a340: 0a20 2020 2020 2020 2066 726f 6d20 626f  .        from bo
+0004a350: 6b65 682e 706c 6f74 7469 6e67 2069 6d70  keh.plotting imp
+0004a360: 6f72 7420 6f75 7470 7574 5f66 696c 652c  ort output_file,
+0004a370: 2073 6176 650a 0a20 2020 2020 2020 2077   save..        w
+0004a380: 6974 6820 746d 7066 696c 6528 6578 7465  ith tmpfile(exte
+0004a390: 6e73 696f 6e3d 222e 6874 6d6c 2229 2061  nsion=".html") a
+0004a3a0: 7320 666e 3a0a 2020 2020 2020 2020 2020  s fn:.          
+0004a3b0: 2020 6f75 7470 7574 5f66 696c 6528 6669    output_file(fi
+0004a3c0: 6c65 6e61 6d65 3d66 6e2c 2074 6974 6c65  lename=fn, title
+0004a3d0: 3d22 4461 736b 2050 6572 666f 726d 616e  ="Dask Performan
+0004a3e0: 6365 2052 6570 6f72 7422 2c20 6d6f 6465  ce Report", mode
+0004a3f0: 3d6d 6f64 6529 0a20 2020 2020 2020 2020  =mode).         
+0004a400: 2020 2074 656d 706c 6174 655f 6469 7265     template_dire
+0004a410: 6374 6f72 7920 3d20 6f73 2e70 6174 682e  ctory = os.path.
+0004a420: 6a6f 696e 280a 2020 2020 2020 2020 2020  join(.          
+0004a430: 2020 2020 2020 6f73 2e70 6174 682e 6469        os.path.di
+0004a440: 726e 616d 6528 6f73 2e70 6174 682e 6162  rname(os.path.ab
+0004a450: 7370 6174 6828 5f5f 6669 6c65 5f5f 2929  spath(__file__))
+0004a460: 2c20 2264 6173 6862 6f61 7264 222c 2022  , "dashboard", "
+0004a470: 7465 6d70 6c61 7465 7322 0a20 2020 2020  templates".     
+0004a480: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0004a490: 2020 2020 2074 656d 706c 6174 655f 656e       template_en
+0004a4a0: 7669 726f 6e6d 656e 7420 3d20 6765 745f  vironment = get_
+0004a4b0: 656e 7628 290a 2020 2020 2020 2020 2020  env().          
+0004a4c0: 2020 7465 6d70 6c61 7465 5f65 6e76 6972    template_envir
+0004a4d0: 6f6e 6d65 6e74 2e6c 6f61 6465 722e 7365  onment.loader.se
+0004a4e0: 6172 6368 7061 7468 2e61 7070 656e 6428  archpath.append(
+0004a4f0: 7465 6d70 6c61 7465 5f64 6972 6563 746f  template_directo
+0004a500: 7279 290a 2020 2020 2020 2020 2020 2020  ry).            
+0004a510: 7465 6d70 6c61 7465 203d 2074 656d 706c  template = templ
+0004a520: 6174 655f 656e 7669 726f 6e6d 656e 742e  ate_environment.
+0004a530: 6765 745f 7465 6d70 6c61 7465 2822 7065  get_template("pe
+0004a540: 7266 6f72 6d61 6e63 655f 7265 706f 7274  rformance_report
+0004a550: 2e68 746d 6c22 290a 2020 2020 2020 2020  .html").        
+0004a560: 2020 2020 7361 7665 2874 6162 732c 2066      save(tabs, f
+0004a570: 696c 656e 616d 653d 666e 2c20 7465 6d70  ilename=fn, temp
+0004a580: 6c61 7465 3d74 656d 706c 6174 6529 0a0a  late=template)..
+0004a590: 2020 2020 2020 2020 2020 2020 7769 7468              with
+0004a5a0: 206f 7065 6e28 666e 2920 6173 2066 3a0a   open(fn) as f:.
+0004a5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a5c0: 6461 7461 203d 2066 2e72 6561 6428 290a  data = f.read().
+0004a5d0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0004a5e0: 6461 7461 0a0a 2020 2020 6173 796e 6320  data..    async 
+0004a5f0: 6465 6620 6765 745f 776f 726b 6572 5f6c  def get_worker_l
+0004a600: 6f67 7328 7365 6c66 2c20 6e3d 4e6f 6e65  ogs(self, n=None
+0004a610: 2c20 776f 726b 6572 733d 4e6f 6e65 2c20  , workers=None, 
+0004a620: 6e61 6e6e 793d 4661 6c73 6529 3a0a 2020  nanny=False):.  
+0004a630: 2020 2020 2020 7265 7375 6c74 7320 3d20        results = 
+0004a640: 6177 6169 7420 7365 6c66 2e62 726f 6164  await self.broad
+0004a650: 6361 7374 280a 2020 2020 2020 2020 2020  cast(.          
+0004a660: 2020 6d73 673d 7b22 6f70 223a 2022 6765    msg={"op": "ge
+0004a670: 745f 6c6f 6773 222c 2022 6e22 3a20 6e7d  t_logs", "n": n}
+0004a680: 2c20 776f 726b 6572 733d 776f 726b 6572  , workers=worker
+0004a690: 732c 206e 616e 6e79 3d6e 616e 6e79 0a20  s, nanny=nanny. 
+0004a6a0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0004a6b0: 2072 6574 7572 6e20 7265 7375 6c74 730a   return results.
+0004a6c0: 0a20 2020 2064 6566 206c 6f67 5f65 7665  .    def log_eve
+0004a6d0: 6e74 2873 656c 662c 2074 6f70 6963 3a20  nt(self, topic: 
+0004a6e0: 7374 7220 7c20 436f 6c6c 6563 7469 6f6e  str | Collection
+0004a6f0: 5b73 7472 5d2c 206d 7367 3a20 416e 7929  [str], msg: Any)
+0004a700: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+0004a710: 2020 2222 224c 6f67 2061 6e20 6576 656e    """Log an even
+0004a720: 7420 756e 6465 7220 6120 6769 7665 6e20  t under a given 
+0004a730: 746f 7069 630a 0a20 2020 2020 2020 2050  topic..        P
+0004a740: 6172 616d 6574 6572 730a 2020 2020 2020  arameters.      
+0004a750: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
+0004a760: 2020 2020 2074 6f70 6963 203a 2073 7472       topic : str
+0004a770: 2c20 6c69 7374 5b73 7472 5d0a 2020 2020  , list[str].    
+0004a780: 2020 2020 2020 2020 4e61 6d65 206f 6620          Name of 
+0004a790: 7468 6520 746f 7069 6320 756e 6465 7220  the topic under 
+0004a7a0: 7768 6963 6820 746f 206c 6f67 2061 6e20  which to log an 
+0004a7b0: 6576 656e 742e 2054 6f20 6c6f 6720 7468  event. To log th
+0004a7c0: 6520 7361 6d65 0a20 2020 2020 2020 2020  e same.         
+0004a7d0: 2020 2065 7665 6e74 2075 6e64 6572 206d     event under m
+0004a7e0: 756c 7469 706c 6520 746f 7069 6373 2c20  ultiple topics, 
+0004a7f0: 7061 7373 2061 206c 6973 7420 6f66 2074  pass a list of t
+0004a800: 6f70 6963 206e 616d 6573 2e0a 2020 2020  opic names..    
+0004a810: 2020 2020 6d73 670a 2020 2020 2020 2020      msg.        
+0004a820: 2020 2020 4576 656e 7420 6d65 7373 6167      Event messag
+0004a830: 6520 746f 206c 6f67 2e20 4e6f 7465 2074  e to log. Note t
+0004a840: 6869 7320 6d75 7374 2062 6520 6d73 6770  his must be msgp
+0004a850: 6163 6b20 7365 7269 616c 697a 6162 6c65  ack serializable
+0004a860: 2e0a 0a20 2020 2020 2020 2053 6565 2061  ...        See a
+0004a870: 6c73 6f0a 2020 2020 2020 2020 2d2d 2d2d  lso.        ----
+0004a880: 2d2d 2d2d 0a20 2020 2020 2020 2043 6c69  ----.        Cli
+0004a890: 656e 742e 6c6f 675f 6576 656e 740a 2020  ent.log_event.  
+0004a8a0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0004a8b0: 2020 6576 656e 7420 3d20 2874 696d 6528    event = (time(
+0004a8c0: 292c 206d 7367 290a 2020 2020 2020 2020  ), msg).        
+0004a8d0: 6966 206e 6f74 2069 7369 6e73 7461 6e63  if not isinstanc
+0004a8e0: 6528 746f 7069 632c 2073 7472 293a 0a20  e(topic, str):. 
+0004a8f0: 2020 2020 2020 2020 2020 2066 6f72 2074             for t
+0004a900: 2069 6e20 746f 7069 633a 0a20 2020 2020   in topic:.     
+0004a910: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0004a920: 6576 656e 7473 5b74 5d2e 6170 7065 6e64  events[t].append
+0004a930: 2865 7665 6e74 290a 2020 2020 2020 2020  (event).        
+0004a940: 2020 2020 2020 2020 7365 6c66 2e65 7665          self.eve
+0004a950: 6e74 5f63 6f75 6e74 735b 745d 202b 3d20  nt_counts[t] += 
+0004a960: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
+0004a970: 2020 7365 6c66 2e5f 7265 706f 7274 5f65    self._report_e
+0004a980: 7665 6e74 2874 2c20 6576 656e 7429 0a20  vent(t, event). 
+0004a990: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0004a9a0: 2020 2020 2020 2020 2073 656c 662e 6576           self.ev
+0004a9b0: 656e 7473 5b74 6f70 6963 5d2e 6170 7065  ents[topic].appe
+0004a9c0: 6e64 2865 7665 6e74 290a 2020 2020 2020  nd(event).      
+0004a9d0: 2020 2020 2020 7365 6c66 2e65 7665 6e74        self.event
+0004a9e0: 5f63 6f75 6e74 735b 746f 7069 635d 202b  _counts[topic] +
+0004a9f0: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
+0004aa00: 7365 6c66 2e5f 7265 706f 7274 5f65 7665  self._report_eve
+0004aa10: 6e74 2874 6f70 6963 2c20 6576 656e 7429  nt(topic, event)
+0004aa20: 0a0a 2020 2020 2020 2020 2020 2020 666f  ..            fo
+0004aa30: 7220 706c 7567 696e 2069 6e20 6c69 7374  r plugin in list
+0004aa40: 2873 656c 662e 706c 7567 696e 732e 7661  (self.plugins.va
+0004aa50: 6c75 6573 2829 293a 0a20 2020 2020 2020  lues()):.       
+0004aa60: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+0004aa70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004aa80: 2020 706c 7567 696e 2e6c 6f67 5f65 7665    plugin.log_eve
+0004aa90: 6e74 2874 6f70 6963 2c20 6d73 6729 0a20  nt(topic, msg). 
+0004aaa0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0004aab0: 7863 6570 7420 4578 6365 7074 696f 6e3a  xcept Exception:
+0004aac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004aad0: 2020 2020 206c 6f67 6765 722e 696e 666f       logger.info
+0004aae0: 2822 506c 7567 696e 2066 6169 6c65 6420  ("Plugin failed 
+0004aaf0: 7769 7468 2065 7863 6570 7469 6f6e 222c  with exception",
+0004ab00: 2065 7863 5f69 6e66 6f3d 5472 7565 290a   exc_info=True).
+0004ab10: 0a20 2020 2064 6566 205f 7265 706f 7274  .    def _report
+0004ab20: 5f65 7665 6e74 2873 656c 662c 206e 616d  _event(self, nam
+0004ab30: 652c 2065 7665 6e74 293a 0a20 2020 2020  e, event):.     
+0004ab40: 2020 206d 7367 203d 207b 0a20 2020 2020     msg = {.     
+0004ab50: 2020 2020 2020 2022 6f70 223a 2022 6576         "op": "ev
+0004ab60: 656e 7422 2c0a 2020 2020 2020 2020 2020  ent",.          
+0004ab70: 2020 2274 6f70 6963 223a 206e 616d 652c    "topic": name,
+0004ab80: 0a20 2020 2020 2020 2020 2020 2022 6576  .            "ev
+0004ab90: 656e 7422 3a20 6576 656e 742c 0a20 2020  ent": event,.   
+0004aba0: 2020 2020 207d 0a20 2020 2020 2020 2063       }.        c
+0004abb0: 6c69 656e 745f 6d73 6773 203d 207b 636c  lient_msgs = {cl
+0004abc0: 6965 6e74 3a20 5b6d 7367 5d20 666f 7220  ient: [msg] for 
+0004abd0: 636c 6965 6e74 2069 6e20 7365 6c66 2e65  client in self.e
+0004abe0: 7665 6e74 5f73 7562 7363 7269 6265 725b  vent_subscriber[
+0004abf0: 6e61 6d65 5d7d 0a20 2020 2020 2020 2073  name]}.        s
+0004ac00: 656c 662e 7365 6e64 5f61 6c6c 2863 6c69  elf.send_all(cli
+0004ac10: 656e 745f 6d73 6773 2c20 776f 726b 6572  ent_msgs, worker
+0004ac20: 5f6d 7367 733d 7b7d 290a 0a20 2020 2064  _msgs={})..    d
+0004ac30: 6566 2073 7562 7363 7269 6265 5f74 6f70  ef subscribe_top
+0004ac40: 6963 2873 656c 662c 2074 6f70 6963 2c20  ic(self, topic, 
+0004ac50: 636c 6965 6e74 293a 0a20 2020 2020 2020  client):.       
+0004ac60: 2073 656c 662e 6576 656e 745f 7375 6273   self.event_subs
+0004ac70: 6372 6962 6572 5b74 6f70 6963 5d2e 6164  criber[topic].ad
+0004ac80: 6428 636c 6965 6e74 290a 0a20 2020 2064  d(client)..    d
+0004ac90: 6566 2075 6e73 7562 7363 7269 6265 5f74  ef unsubscribe_t
+0004aca0: 6f70 6963 2873 656c 662c 2074 6f70 6963  opic(self, topic
+0004acb0: 2c20 636c 6965 6e74 293a 0a20 2020 2020  , client):.     
+0004acc0: 2020 2073 656c 662e 6576 656e 745f 7375     self.event_su
+0004acd0: 6273 6372 6962 6572 5b74 6f70 6963 5d2e  bscriber[topic].
+0004ace0: 6469 7363 6172 6428 636c 6965 6e74 290a  discard(client).
+0004acf0: 0a20 2020 2064 6566 2067 6574 5f65 7665  .    def get_eve
+0004ad00: 6e74 7328 7365 6c66 2c20 746f 7069 633d  nts(self, topic=
+0004ad10: 4e6f 6e65 293a 0a20 2020 2020 2020 2069  None):.        i
+0004ad20: 6620 746f 7069 6320 6973 206e 6f74 204e  f topic is not N
+0004ad30: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0004ad40: 2072 6574 7572 6e20 7475 706c 6528 7365   return tuple(se
+0004ad50: 6c66 2e65 7665 6e74 735b 746f 7069 635d  lf.events[topic]
+0004ad60: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+0004ad70: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0004ad80: 726e 2076 616c 6d61 7028 7475 706c 652c  rn valmap(tuple,
+0004ad90: 2073 656c 662e 6576 656e 7473 290a 0a20   self.events).. 
+0004ada0: 2020 2061 7379 6e63 2064 6566 2067 6574     async def get
+0004adb0: 5f77 6f72 6b65 725f 6d6f 6e69 746f 725f  _worker_monitor_
+0004adc0: 696e 666f 2873 656c 662c 2072 6563 656e  info(self, recen
+0004add0: 743d 4661 6c73 652c 2073 7461 7274 733d  t=False, starts=
+0004ade0: 4e6f 6e65 293a 0a20 2020 2020 2020 2069  None):.        i
+0004adf0: 6620 7374 6172 7473 2069 7320 4e6f 6e65  f starts is None
+0004ae00: 3a0a 2020 2020 2020 2020 2020 2020 7374  :.            st
+0004ae10: 6172 7473 203d 207b 7d0a 2020 2020 2020  arts = {}.      
+0004ae20: 2020 7265 7375 6c74 7320 3d20 6177 6169    results = awai
+0004ae30: 7420 6173 796e 6369 6f2e 6761 7468 6572  t asyncio.gather
+0004ae40: 280a 2020 2020 2020 2020 2020 2020 2a28  (.            *(
+0004ae50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004ae60: 2073 656c 662e 7270 6328 7729 2e67 6574   self.rpc(w).get
+0004ae70: 5f6d 6f6e 6974 6f72 5f69 6e66 6f28 7265  _monitor_info(re
+0004ae80: 6365 6e74 3d72 6563 656e 742c 2073 7461  cent=recent, sta
+0004ae90: 7274 3d73 7461 7274 732e 6765 7428 772c  rt=starts.get(w,
+0004aea0: 2030 2929 0a20 2020 2020 2020 2020 2020   0)).           
+0004aeb0: 2020 2020 2066 6f72 2077 2069 6e20 7365       for w in se
+0004aec0: 6c66 2e77 6f72 6b65 7273 0a20 2020 2020  lf.workers.     
+0004aed0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0004aee0: 2029 0a20 2020 2020 2020 2072 6574 7572   ).        retur
+0004aef0: 6e20 6469 6374 287a 6970 2873 656c 662e  n dict(zip(self.
+0004af00: 776f 726b 6572 732c 2072 6573 756c 7473  workers, results
+0004af10: 2929 0a0a 2020 2020 2323 2323 2323 2323  ))..    ########
+0004af20: 2323 230a 2020 2020 2320 436c 6561 6e75  ###.    # Cleanu
+0004af30: 7020 230a 2020 2020 2323 2323 2323 2323  p #.    ########
+0004af40: 2323 230a 0a20 2020 2040 6c6f 675f 6572  ###..    @log_er
+0004af50: 726f 7273 0a20 2020 2061 7379 6e63 2064  rors.    async d
+0004af60: 6566 2063 6865 636b 5f77 6f72 6b65 725f  ef check_worker_
+0004af70: 7474 6c28 7365 6c66 2920 2d3e 204e 6f6e  ttl(self) -> Non
+0004af80: 653a 0a20 2020 2020 2020 206e 6f77 203d  e:.        now =
+0004af90: 2074 696d 6528 290a 2020 2020 2020 2020   time().        
+0004afa0: 7374 696d 756c 7573 5f69 6420 3d20 6622  stimulus_id = f"
+0004afb0: 6368 6563 6b2d 776f 726b 6572 2d74 746c  check-worker-ttl
+0004afc0: 2d7b 6e6f 777d 220a 2020 2020 2020 2020  -{now}".        
+0004afd0: 6173 7365 7274 2073 656c 662e 776f 726b  assert self.work
+0004afe0: 6572 5f74 746c 0a20 2020 2020 2020 2074  er_ttl.        t
+0004aff0: 746c 203d 206d 6178 2873 656c 662e 776f  tl = max(self.wo
+0004b000: 726b 6572 5f74 746c 2c20 3130 202a 2068  rker_ttl, 10 * h
+0004b010: 6561 7274 6265 6174 5f69 6e74 6572 7661  eartbeat_interva
+0004b020: 6c28 6c65 6e28 7365 6c66 2e77 6f72 6b65  l(len(self.worke
+0004b030: 7273 2929 290a 2020 2020 2020 2020 746f  rs))).        to
+0004b040: 5f72 6573 7461 7274 203d 205b 5d0a 0a20  _restart = [].. 
+0004b050: 2020 2020 2020 2066 6f72 2077 7320 696e         for ws in
+0004b060: 2073 656c 662e 776f 726b 6572 732e 7661   self.workers.va
+0004b070: 6c75 6573 2829 3a0a 2020 2020 2020 2020  lues():.        
+0004b080: 2020 2020 6c61 7374 5f73 6565 6e20 3d20      last_seen = 
+0004b090: 6e6f 7720 2d20 7773 2e6c 6173 745f 7365  now - ws.last_se
+0004b0a0: 656e 0a20 2020 2020 2020 2020 2020 2069  en.            i
+0004b0b0: 6620 6c61 7374 5f73 6565 6e20 3e20 7474  f last_seen > tt
+0004b0c0: 6c3a 0a20 2020 2020 2020 2020 2020 2020  l:.             
+0004b0d0: 2020 2074 6f5f 7265 7374 6172 742e 6170     to_restart.ap
+0004b0e0: 7065 6e64 2877 732e 6164 6472 6573 7329  pend(ws.address)
+0004b0f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004b100: 206c 6f67 6765 722e 7761 726e 696e 6728   logger.warning(
+0004b110: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004b120: 2020 2020 2066 2257 6f72 6b65 7220 6661       f"Worker fa
+0004b130: 696c 6564 2074 6f20 6865 6172 7462 6561  iled to heartbea
+0004b140: 7420 666f 7220 7b6c 6173 745f 7365 656e  t for {last_seen
+0004b150: 3a2e 3066 7d73 3b20 220a 2020 2020 2020  :.0f}s; ".      
+0004b160: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+0004b170: 7b27 6174 7465 6d70 7469 6e67 2072 6573  {'attempting res
+0004b180: 7461 7274 2720 6966 2077 732e 6e61 6e6e  tart' if ws.nann
+0004b190: 7920 656c 7365 2027 7265 6d6f 7669 6e67  y else 'removing
+0004b1a0: 277d 3a20 7b77 737d 220a 2020 2020 2020  '}: {ws}".      
+0004b1b0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+0004b1c0: 2020 2020 2069 6620 746f 5f72 6573 7461       if to_resta
+0004b1d0: 7274 3a0a 2020 2020 2020 2020 2020 2020  rt:.            
+0004b1e0: 6177 6169 7420 7365 6c66 2e72 6573 7461  await self.resta
+0004b1f0: 7274 5f77 6f72 6b65 7273 280a 2020 2020  rt_workers(.    
+0004b200: 2020 2020 2020 2020 2020 2020 746f 5f72              to_r
+0004b210: 6573 7461 7274 2c0a 2020 2020 2020 2020  estart,.        
+0004b220: 2020 2020 2020 2020 7761 6974 5f66 6f72          wait_for
+0004b230: 5f77 6f72 6b65 7273 3d46 616c 7365 2c0a  _workers=False,.
+0004b240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b250: 7374 696d 756c 7573 5f69 643d 7374 696d  stimulus_id=stim
+0004b260: 756c 7573 5f69 642c 0a20 2020 2020 2020  ulus_id,.       
+0004b270: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
+0004b280: 6368 6563 6b5f 6964 6c65 2873 656c 6629  check_idle(self)
+0004b290: 202d 3e20 666c 6f61 7420 7c20 4e6f 6e65   -> float | None
+0004b2a0: 3a0a 2020 2020 2020 2020 6966 2073 656c  :.        if sel
+0004b2b0: 662e 7374 6174 7573 2069 6e20 2853 7461  f.status in (Sta
+0004b2c0: 7475 732e 636c 6f73 696e 672c 2053 7461  tus.closing, Sta
+0004b2d0: 7475 732e 636c 6f73 6564 293a 0a20 2020  tus.closed):.   
+0004b2e0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0004b2f0: 4e6f 6e65 2020 2320 7072 6167 6d61 3a20  None  # pragma: 
+0004b300: 6e6f 636f 7665 720a 0a20 2020 2020 2020  nocover..       
+0004b310: 2069 6620 7365 6c66 2e74 7261 6e73 6974   if self.transit
+0004b320: 696f 6e5f 636f 756e 7465 7220 213d 2073  ion_counter != s
+0004b330: 656c 662e 5f69 646c 655f 7472 616e 7369  elf._idle_transi
+0004b340: 7469 6f6e 5f63 6f75 6e74 6572 3a0a 2020  tion_counter:.  
+0004b350: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+0004b360: 6964 6c65 5f74 7261 6e73 6974 696f 6e5f  idle_transition_
+0004b370: 636f 756e 7465 7220 3d20 7365 6c66 2e74  counter = self.t
+0004b380: 7261 6e73 6974 696f 6e5f 636f 756e 7465  ransition_counte
+0004b390: 720a 2020 2020 2020 2020 2020 2020 7365  r.            se
+0004b3a0: 6c66 2e69 646c 655f 7369 6e63 6520 3d20  lf.idle_since = 
+0004b3b0: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+0004b3c0: 2072 6574 7572 6e20 4e6f 6e65 0a0a 2020   return None..  
+0004b3d0: 2020 2020 2020 6966 2028 0a20 2020 2020        if (.     
+0004b3e0: 2020 2020 2020 2073 656c 662e 7175 6575         self.queu
+0004b3f0: 6564 0a20 2020 2020 2020 2020 2020 206f  ed.            o
+0004b400: 7220 7365 6c66 2e75 6e72 756e 6e61 626c  r self.unrunnabl
+0004b410: 650a 2020 2020 2020 2020 2020 2020 6f72  e.            or
+0004b420: 2061 6e79 2877 732e 7072 6f63 6573 7369   any(ws.processi
+0004b430: 6e67 2066 6f72 2077 7320 696e 2073 656c  ng for ws in sel
+0004b440: 662e 776f 726b 6572 732e 7661 6c75 6573  f.workers.values
+0004b450: 2829 290a 2020 2020 2020 2020 293a 0a20  ()).        ):. 
+0004b460: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0004b470: 6964 6c65 5f73 696e 6365 203d 204e 6f6e  idle_since = Non
+0004b480: 650a 2020 2020 2020 2020 2020 2020 7265  e.            re
+0004b490: 7475 726e 204e 6f6e 650a 0a20 2020 2020  turn None..     
+0004b4a0: 2020 2069 6620 6e6f 7420 7365 6c66 2e69     if not self.i
+0004b4b0: 646c 655f 7369 6e63 653a 0a20 2020 2020  dle_since:.     
+0004b4c0: 2020 2020 2020 2073 656c 662e 6964 6c65         self.idle
+0004b4d0: 5f73 696e 6365 203d 2074 696d 6528 290a  _since = time().
+0004b4e0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0004b4f0: 726e 2073 656c 662e 6964 6c65 5f73 696e  rn self.idle_sin
+0004b500: 6365 0a0a 2020 2020 2020 2020 6966 2073  ce..        if s
+0004b510: 656c 662e 6a75 7079 7465 723a 0a20 2020  elf.jupyter:.   
+0004b520: 2020 2020 2020 2020 206c 6173 745f 6163           last_ac
+0004b530: 7469 7669 7479 203d 2028 0a20 2020 2020  tivity = (.     
+0004b540: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0004b550: 5f6a 7570 7974 6572 5f73 6572 7665 725f  _jupyter_server_
+0004b560: 6170 706c 6963 6174 696f 6e2e 7765 625f  application.web_
+0004b570: 6170 702e 6c61 7374 5f61 6374 6976 6974  app.last_activit
+0004b580: 7928 292e 7469 6d65 7374 616d 7028 290a  y().timestamp().
+0004b590: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0004b5a0: 2020 2020 2020 2020 2020 6966 206c 6173            if las
+0004b5b0: 745f 6163 7469 7669 7479 203e 2073 656c  t_activity > sel
+0004b5c0: 662e 6964 6c65 5f73 696e 6365 3a0a 2020  f.idle_since:.  
+0004b5d0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0004b5e0: 6c66 2e69 646c 655f 7369 6e63 6520 3d20  lf.idle_since = 
+0004b5f0: 6c61 7374 5f61 6374 6976 6974 790a 2020  last_activity.  
+0004b600: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0004b610: 7475 726e 2073 656c 662e 6964 6c65 5f73  turn self.idle_s
+0004b620: 696e 6365 0a0a 2020 2020 2020 2020 6966  ince..        if
+0004b630: 2073 656c 662e 6964 6c65 5f74 696d 656f   self.idle_timeo
+0004b640: 7574 3a0a 2020 2020 2020 2020 2020 2020  ut:.            
+0004b650: 6966 2074 696d 6528 2920 3e20 7365 6c66  if time() > self
+0004b660: 2e69 646c 655f 7369 6e63 6520 2b20 7365  .idle_since + se
+0004b670: 6c66 2e69 646c 655f 7469 6d65 6f75 743a  lf.idle_timeout:
+0004b680: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004b690: 2061 7373 6572 7420 7365 6c66 2e69 646c   assert self.idl
+0004b6a0: 655f 7369 6e63 650a 2020 2020 2020 2020  e_since.        
+0004b6b0: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
+0004b6c0: 6e66 6f28 0a20 2020 2020 2020 2020 2020  nfo(.           
+0004b6d0: 2020 2020 2020 2020 2022 5363 6865 6475           "Schedu
+0004b6e0: 6c65 7220 636c 6f73 696e 6720 6166 7465  ler closing afte
+0004b6f0: 7220 6265 696e 6720 6964 6c65 2066 6f72  r being idle for
+0004b700: 2025 7322 2c0a 2020 2020 2020 2020 2020   %s",.          
+0004b710: 2020 2020 2020 2020 2020 666f 726d 6174            format
+0004b720: 5f74 696d 6528 7365 6c66 2e69 646c 655f  _time(self.idle_
+0004b730: 7469 6d65 6f75 7429 2c0a 2020 2020 2020  timeout),.      
+0004b740: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0004b750: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0004b760: 2e5f 6f6e 676f 696e 675f 6261 636b 6772  ._ongoing_backgr
+0004b770: 6f75 6e64 5f74 6173 6b73 2e63 616c 6c5f  ound_tasks.call_
+0004b780: 736f 6f6e 2873 656c 662e 636c 6f73 6529  soon(self.close)
+0004b790: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0004b7a0: 7365 6c66 2e69 646c 655f 7369 6e63 650a  self.idle_since.
+0004b7b0: 0a20 2020 2064 6566 205f 6368 6563 6b5f  .    def _check_
+0004b7c0: 6e6f 5f77 6f72 6b65 7273 2873 656c 6629  no_workers(self)
+0004b7d0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+0004b7e0: 2020 2222 2253 6875 7420 646f 776e 2074    """Shut down t
+0004b7f0: 6865 2073 6368 6564 756c 6572 2069 6620  he scheduler if 
+0004b800: 7468 6572 6520 6861 7665 2062 6565 6e20  there have been 
+0004b810: 7461 736b 7320 7265 6164 7920 746f 2072  tasks ready to r
+0004b820: 756e 2077 6869 6368 2068 6176 650a 2020  un which have.  
+0004b830: 2020 2020 2020 6e6f 7768 6572 6520 746f        nowhere to
+0004b840: 2072 756e 2066 6f72 2060 6469 7374 7269   run for `distri
+0004b850: 6275 7465 642e 7363 6865 6475 6c65 722e  buted.scheduler.
+0004b860: 6e6f 2d77 6f72 6b65 7273 2d74 696d 656f  no-workers-timeo
+0004b870: 7574 602c 2061 6e64 2074 6865 7265 0a20  ut`, and there. 
+0004b880: 2020 2020 2020 2061 7265 6e27 7420 6f74         aren't ot
+0004b890: 6865 7220 7461 736b 7320 7275 6e6e 696e  her tasks runnin
+0004b8a0: 672e 0a20 2020 2020 2020 2022 2222 0a20  g..        """. 
+0004b8b0: 2020 2020 2020 2069 6620 7365 6c66 2e73         if self.s
+0004b8c0: 7461 7475 7320 696e 2028 5374 6174 7573  tatus in (Status
+0004b8d0: 2e63 6c6f 7369 6e67 2c20 5374 6174 7573  .closing, Status
+0004b8e0: 2e63 6c6f 7365 6429 3a0a 2020 2020 2020  .closed):.      
+0004b8f0: 2020 2020 2020 7265 7475 726e 2020 2320        return  # 
+0004b900: 7072 6167 6d61 3a20 6e6f 636f 7665 720a  pragma: nocover.
+0004b910: 0a20 2020 2020 2020 2069 6620 280a 2020  .        if (.  
+0004b920: 2020 2020 2020 2020 2020 286e 6f74 2073            (not s
+0004b930: 656c 662e 7175 6575 6564 2061 6e64 206e  elf.queued and n
+0004b940: 6f74 2073 656c 662e 756e 7275 6e6e 6162  ot self.unrunnab
+0004b950: 6c65 290a 2020 2020 2020 2020 2020 2020  le).            
+0004b960: 6f72 2028 7365 6c66 2e71 7565 7565 6420  or (self.queued 
+0004b970: 616e 6420 7365 6c66 2e77 6f72 6b65 7273  and self.workers
+0004b980: 290a 2020 2020 2020 2020 2020 2020 6f72  ).            or
+0004b990: 2061 6e79 2877 732e 7072 6f63 6573 7369   any(ws.processi
+0004b9a0: 6e67 2066 6f72 2077 7320 696e 2073 656c  ng for ws in sel
+0004b9b0: 662e 776f 726b 6572 732e 7661 6c75 6573  f.workers.values
+0004b9c0: 2829 290a 2020 2020 2020 2020 293a 0a20  ()).        ):. 
+0004b9d0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0004b9e0: 5f6e 6f5f 776f 726b 6572 735f 7369 6e63  _no_workers_sinc
+0004b9f0: 6520 3d20 4e6f 6e65 0a20 2020 2020 2020  e = None.       
+0004ba00: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
+0004ba10: 2020 2020 2023 2031 2e20 5468 6572 6520       # 1. There 
+0004ba20: 6172 6520 7175 6575 6564 206f 7220 756e  are queued or un
+0004ba30: 7275 6e6e 6162 6c65 2074 6173 6b73 2061  runnable tasks a
+0004ba40: 6e64 206e 6f20 776f 726b 6572 7320 6174  nd no workers at
+0004ba50: 2061 6c6c 0a20 2020 2020 2020 2023 2032   all.        # 2
+0004ba60: 2e20 5468 6572 6520 6172 6520 756e 7275  . There are unru
+0004ba70: 6e6e 6162 6c65 2074 6173 6b73 2061 6e64  nnable tasks and
+0004ba80: 206e 6f20 776f 726b 6572 7320 7361 7469   no workers sati
+0004ba90: 7366 7920 7468 6569 7220 7265 7374 7269  sfy their restri
+0004baa0: 6374 696f 6e73 0a20 2020 2020 2020 2023  ctions.        #
+0004bab0: 2028 4f6e 6c79 2072 6f6f 7469 7368 2074   (Only rootish t
+0004bac0: 6173 6b73 2063 616e 2062 6520 7175 6575  asks can be queu
+0004bad0: 6564 2c20 616e 6420 726f 6f74 6973 6820  ed, and rootish 
+0004bae0: 7461 736b 7320 6361 6e27 7420 6861 7665  tasks can't have
+0004baf0: 2072 6573 7472 6963 7469 6f6e 7329 0a0a   restrictions)..
+0004bb00: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
+0004bb10: 656c 662e 5f6e 6f5f 776f 726b 6572 735f  elf._no_workers_
+0004bb20: 7369 6e63 653a 0a20 2020 2020 2020 2020  since:.         
+0004bb30: 2020 2073 656c 662e 5f6e 6f5f 776f 726b     self._no_work
+0004bb40: 6572 735f 7369 6e63 6520 3d20 7469 6d65  ers_since = time
+0004bb50: 2829 0a20 2020 2020 2020 2020 2020 2072  ().            r
+0004bb60: 6574 7572 6e0a 0a20 2020 2020 2020 2069  eturn..        i
+0004bb70: 6620 280a 2020 2020 2020 2020 2020 2020  f (.            
+0004bb80: 7365 6c66 2e6e 6f5f 776f 726b 6572 735f  self.no_workers_
+0004bb90: 7469 6d65 6f75 740a 2020 2020 2020 2020  timeout.        
+0004bba0: 2020 2020 616e 6420 7469 6d65 2829 203e      and time() >
+0004bbb0: 2073 656c 662e 5f6e 6f5f 776f 726b 6572   self._no_worker
+0004bbc0: 735f 7369 6e63 6520 2b20 7365 6c66 2e6e  s_since + self.n
+0004bbd0: 6f5f 776f 726b 6572 735f 7469 6d65 6f75  o_workers_timeou
+0004bbe0: 740a 2020 2020 2020 2020 293a 0a20 2020  t.        ):.   
+0004bbf0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+0004bc00: 696e 666f 280a 2020 2020 2020 2020 2020  info(.          
+0004bc10: 2020 2020 2020 2254 6173 6b73 2068 6176        "Tasks hav
+0004bc20: 6520 6265 656e 2077 6974 686f 7574 2061  e been without a
+0004bc30: 6e79 2077 6f72 6b65 7273 2074 6f20 7275  ny workers to ru
+0004bc40: 6e20 7468 656d 2066 6f72 2025 733b 2022  n them for %s; "
+0004bc50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004bc60: 2022 7368 7574 7469 6e67 2073 6368 6564   "shutting sched
+0004bc70: 756c 6572 2064 6f77 6e22 2c0a 2020 2020  uler down",.    
+0004bc80: 2020 2020 2020 2020 2020 2020 666f 726d              form
+0004bc90: 6174 5f74 696d 6528 7365 6c66 2e6e 6f5f  at_time(self.no_
+0004bca0: 776f 726b 6572 735f 7469 6d65 6f75 7429  workers_timeout)
+0004bcb0: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+0004bcc0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0004bcd0: 2e5f 6f6e 676f 696e 675f 6261 636b 6772  ._ongoing_backgr
+0004bce0: 6f75 6e64 5f74 6173 6b73 2e63 616c 6c5f  ound_tasks.call_
+0004bcf0: 736f 6f6e 2873 656c 662e 636c 6f73 6529  soon(self.close)
+0004bd00: 0a0a 2020 2020 6465 6620 6164 6170 7469  ..    def adapti
+0004bd10: 7665 5f74 6172 6765 7428 7365 6c66 2c20  ve_target(self, 
+0004bd20: 7461 7267 6574 5f64 7572 6174 696f 6e3d  target_duration=
+0004bd30: 4e6f 6e65 293a 0a20 2020 2020 2020 2022  None):.        "
+0004bd40: 2222 4465 7369 7265 6420 6e75 6d62 6572  ""Desired number
+0004bd50: 206f 6620 776f 726b 6572 7320 6261 7365   of workers base
+0004bd60: 6420 6f6e 2074 6865 2063 7572 7265 6e74  d on the current
+0004bd70: 2077 6f72 6b6c 6f61 640a 0a20 2020 2020   workload..     
+0004bd80: 2020 2054 6869 7320 6c6f 6f6b 7320 6174     This looks at
+0004bd90: 2074 6865 2063 7572 7265 6e74 2072 756e   the current run
+0004bda0: 6e69 6e67 2074 6173 6b73 2061 6e64 206d  ning tasks and m
+0004bdb0: 656d 6f72 7920 7573 652c 2061 6e64 2072  emory use, and r
+0004bdc0: 6574 7572 6e73 2061 0a20 2020 2020 2020  eturns a.       
+0004bdd0: 206e 756d 6265 7220 6f66 2064 6573 6972   number of desir
+0004bde0: 6564 2077 6f72 6b65 7273 2e20 2054 6869  ed workers.  Thi
+0004bdf0: 7320 6973 206f 6674 656e 2075 7365 6420  s is often used 
+0004be00: 6279 2061 6461 7074 6976 6520 7363 6865  by adaptive sche
+0004be10: 6475 6c69 6e67 2e0a 0a20 2020 2020 2020  duling...       
+0004be20: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
+0004be30: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
+0004be40: 2020 2020 2020 2074 6172 6765 745f 6475         target_du
+0004be50: 7261 7469 6f6e 203a 2073 7472 0a20 2020  ration : str.   
+0004be60: 2020 2020 2020 2020 2041 2064 6573 6972           A desir
+0004be70: 6564 2064 7572 6174 696f 6e20 6f66 2074  ed duration of t
+0004be80: 696d 6520 666f 7220 636f 6d70 7574 6174  ime for computat
+0004be90: 696f 6e73 2074 6f20 7461 6b65 2e20 2054  ions to take.  T
+0004bea0: 6869 7320 6166 6665 6374 730a 2020 2020  his affects.    
+0004beb0: 2020 2020 2020 2020 686f 7720 7261 7069          how rapi
+0004bec0: 646c 7920 7468 6520 7363 6865 6475 6c65  dly the schedule
+0004bed0: 7220 7769 6c6c 2061 736b 2074 6f20 7363  r will ask to sc
+0004bee0: 616c 652e 0a0a 2020 2020 2020 2020 5365  ale...        Se
+0004bef0: 6520 416c 736f 0a20 2020 2020 2020 202d  e Also.        -
+0004bf00: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
+0004bf10: 6469 7374 7269 6275 7465 642e 6465 706c  distributed.depl
+0004bf20: 6f79 2e41 6461 7074 6976 650a 2020 2020  oy.Adaptive.    
+0004bf30: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0004bf40: 6966 2074 6172 6765 745f 6475 7261 7469  if target_durati
+0004bf50: 6f6e 2069 7320 4e6f 6e65 3a0a 2020 2020  on is None:.    
+0004bf60: 2020 2020 2020 2020 7461 7267 6574 5f64          target_d
+0004bf70: 7572 6174 696f 6e20 3d20 6461 736b 2e63  uration = dask.c
+0004bf80: 6f6e 6669 672e 6765 7428 2264 6973 7472  onfig.get("distr
+0004bf90: 6962 7574 6564 2e61 6461 7074 6976 652e  ibuted.adaptive.
+0004bfa0: 7461 7267 6574 2d64 7572 6174 696f 6e22  target-duration"
+0004bfb0: 290a 2020 2020 2020 2020 7461 7267 6574  ).        target
+0004bfc0: 5f64 7572 6174 696f 6e20 3d20 7061 7273  _duration = pars
+0004bfd0: 655f 7469 6d65 6465 6c74 6128 7461 7267  e_timedelta(targ
+0004bfe0: 6574 5f64 7572 6174 696f 6e29 0a0a 2020  et_duration)..  
+0004bff0: 2020 2020 2020 2320 4350 550a 2020 2020        # CPU.    
+0004c000: 2020 2020 7175 6575 6564 203d 2074 616b      queued = tak
+0004c010: 6528 3130 302c 2063 6f6e 6361 7428 5b73  e(100, concat([s
+0004c020: 656c 662e 7175 6575 6564 2c20 7365 6c66  elf.queued, self
+0004c030: 2e75 6e72 756e 6e61 626c 655d 2929 0a20  .unrunnable])). 
+0004c040: 2020 2020 2020 2071 7565 7565 645f 6f63         queued_oc
+0004c050: 6375 7061 6e63 7920 3d20 300a 2020 2020  cupancy = 0.    
+0004c060: 2020 2020 666f 7220 7473 2069 6e20 7175      for ts in qu
+0004c070: 6575 6564 3a0a 2020 2020 2020 2020 2020  eued:.          
+0004c080: 2020 6966 2074 732e 7072 6566 6978 2e64    if ts.prefix.d
+0004c090: 7572 6174 696f 6e5f 6176 6572 6167 6520  uration_average 
+0004c0a0: 3d3d 202d 313a 0a20 2020 2020 2020 2020  == -1:.         
+0004c0b0: 2020 2020 2020 2071 7565 7565 645f 6f63         queued_oc
+0004c0c0: 6375 7061 6e63 7920 2b3d 2073 656c 662e  cupancy += self.
+0004c0d0: 554e 4b4e 4f57 4e5f 5441 534b 5f44 5552  UNKNOWN_TASK_DUR
+0004c0e0: 4154 494f 4e0a 2020 2020 2020 2020 2020  ATION.          
+0004c0f0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0004c100: 2020 2020 2020 2020 7175 6575 6564 5f6f          queued_o
+0004c110: 6363 7570 616e 6379 202b 3d20 7473 2e70  ccupancy += ts.p
+0004c120: 7265 6669 782e 6475 7261 7469 6f6e 5f61  refix.duration_a
+0004c130: 7665 7261 6765 0a0a 2020 2020 2020 2020  verage..        
+0004c140: 7461 736b 735f 7265 6164 7920 3d20 6c65  tasks_ready = le
+0004c150: 6e28 7365 6c66 2e71 7565 7565 6429 202b  n(self.queued) +
+0004c160: 206c 656e 2873 656c 662e 756e 7275 6e6e   len(self.unrunn
+0004c170: 6162 6c65 290a 2020 2020 2020 2020 6966  able).        if
+0004c180: 2074 6173 6b73 5f72 6561 6479 203e 2031   tasks_ready > 1
+0004c190: 3030 3a0a 2020 2020 2020 2020 2020 2020  00:.            
+0004c1a0: 7175 6575 6564 5f6f 6363 7570 616e 6379  queued_occupancy
+0004c1b0: 202a 3d20 7461 736b 735f 7265 6164 7920   *= tasks_ready 
+0004c1c0: 2f20 3130 300a 0a20 2020 2020 2020 2063  / 100..        c
+0004c1d0: 7075 203d 206d 6174 682e 6365 696c 2828  pu = math.ceil((
+0004c1e0: 7365 6c66 2e74 6f74 616c 5f6f 6363 7570  self.total_occup
+0004c1f0: 616e 6379 202b 2071 7565 7565 645f 6f63  ancy + queued_oc
+0004c200: 6375 7061 6e63 7929 202f 2074 6172 6765  cupancy) / targe
+0004c210: 745f 6475 7261 7469 6f6e 290a 0a20 2020  t_duration)..   
+0004c220: 2020 2020 2023 2041 766f 6964 2061 2066       # Avoid a f
+0004c230: 6577 206c 6f6e 6720 7461 736b 7320 6672  ew long tasks fr
+0004c240: 6f6d 2061 736b 696e 6720 666f 7220 6d61  om asking for ma
+0004c250: 6e79 2063 6f72 6573 0a20 2020 2020 2020  ny cores.       
+0004c260: 2066 6f72 2077 7320 696e 2073 656c 662e   for ws in self.
+0004c270: 776f 726b 6572 732e 7661 6c75 6573 2829  workers.values()
+0004c280: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+0004c290: 2074 6173 6b73 5f72 6561 6479 203e 2063   tasks_ready > c
+0004c2a0: 7075 3a0a 2020 2020 2020 2020 2020 2020  pu:.            
+0004c2b0: 2020 2020 6272 6561 6b0a 2020 2020 2020      break.      
+0004c2c0: 2020 2020 2020 7461 736b 735f 7265 6164        tasks_read
+0004c2d0: 7920 2b3d 206c 656e 2877 732e 7072 6f63  y += len(ws.proc
+0004c2e0: 6573 7369 6e67 290a 2020 2020 2020 2020  essing).        
+0004c2f0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0004c300: 2020 6370 7520 3d20 6d69 6e28 7461 736b    cpu = min(task
+0004c310: 735f 7265 6164 792c 2063 7075 290a 0a20  s_ready, cpu).. 
+0004c320: 2020 2020 2020 2023 2044 6976 6964 6520         # Divide 
+0004c330: 6279 2061 7665 7261 6765 206e 7468 7265  by average nthre
+0004c340: 6164 7320 7065 7220 776f 726b 6572 0a20  ads per worker. 
+0004c350: 2020 2020 2020 2069 6620 7365 6c66 2e77         if self.w
+0004c360: 6f72 6b65 7273 3a0a 2020 2020 2020 2020  orkers:.        
+0004c370: 2020 2020 6e74 6872 6561 6473 203d 2073      nthreads = s
+0004c380: 756d 2877 732e 6e74 6872 6561 6473 2066  um(ws.nthreads f
+0004c390: 6f72 2077 7320 696e 2073 656c 662e 776f  or ws in self.wo
+0004c3a0: 726b 6572 732e 7661 6c75 6573 2829 290a  rkers.values()).
+0004c3b0: 2020 2020 2020 2020 2020 2020 6370 7520              cpu 
+0004c3c0: 3d20 6d61 7468 2e63 6569 6c28 6370 7520  = math.ceil(cpu 
+0004c3d0: 2f20 6e74 6872 6561 6473 202a 206c 656e  / nthreads * len
+0004c3e0: 2873 656c 662e 776f 726b 6572 7329 290a  (self.workers)).
+0004c3f0: 0a20 2020 2020 2020 2069 6620 2873 656c  .        if (sel
+0004c400: 662e 756e 7275 6e6e 6162 6c65 206f 7220  f.unrunnable or 
+0004c410: 7365 6c66 2e71 7565 7565 6429 2061 6e64  self.queued) and
+0004c420: 206e 6f74 2073 656c 662e 776f 726b 6572   not self.worker
+0004c430: 733a 0a20 2020 2020 2020 2020 2020 2063  s:.            c
+0004c440: 7075 203d 206d 6178 2831 2c20 6370 7529  pu = max(1, cpu)
+0004c450: 0a0a 2020 2020 2020 2020 2320 6164 6420  ..        # add 
+0004c460: 6d6f 7265 2077 6f72 6b65 7273 2069 6620  more workers if 
+0004c470: 6d6f 7265 2074 6861 6e20 3630 2520 6f66  more than 60% of
+0004c480: 206d 656d 6f72 7920 6973 2075 7365 640a   memory is used.
+0004c490: 2020 2020 2020 2020 6c69 6d69 7420 3d20          limit = 
+0004c4a0: 7375 6d28 7773 2e6d 656d 6f72 795f 6c69  sum(ws.memory_li
+0004c4b0: 6d69 7420 666f 7220 7773 2069 6e20 7365  mit for ws in se
+0004c4c0: 6c66 2e77 6f72 6b65 7273 2e76 616c 7565  lf.workers.value
+0004c4d0: 7328 2929 0a20 2020 2020 2020 2075 7365  s()).        use
+0004c4e0: 6420 3d20 7375 6d28 7773 2e6e 6279 7465  d = sum(ws.nbyte
+0004c4f0: 7320 666f 7220 7773 2069 6e20 7365 6c66  s for ws in self
+0004c500: 2e77 6f72 6b65 7273 2e76 616c 7565 7328  .workers.values(
+0004c510: 2929 0a20 2020 2020 2020 206d 656d 6f72  )).        memor
+0004c520: 7920 3d20 300a 2020 2020 2020 2020 6966  y = 0.        if
+0004c530: 2075 7365 6420 3e20 302e 3620 2a20 6c69   used > 0.6 * li
+0004c540: 6d69 7420 616e 6420 6c69 6d69 7420 3e20  mit and limit > 
+0004c550: 303a 0a20 2020 2020 2020 2020 2020 206d  0:.            m
+0004c560: 656d 6f72 7920 3d20 3220 2a20 6c65 6e28  emory = 2 * len(
+0004c570: 7365 6c66 2e77 6f72 6b65 7273 290a 0a20  self.workers).. 
+0004c580: 2020 2020 2020 2074 6172 6765 7420 3d20         target = 
+0004c590: 6d61 7828 6d65 6d6f 7279 2c20 6370 7529  max(memory, cpu)
+0004c5a0: 0a20 2020 2020 2020 2069 6620 7461 7267  .        if targ
+0004c5b0: 6574 203e 3d20 6c65 6e28 7365 6c66 2e77  et >= len(self.w
+0004c5c0: 6f72 6b65 7273 293a 0a20 2020 2020 2020  orkers):.       
+0004c5d0: 2020 2020 2072 6574 7572 6e20 7461 7267       return targ
+0004c5e0: 6574 0a20 2020 2020 2020 2065 6c73 653a  et.        else:
+0004c5f0: 2020 2320 5363 616c 6520 646f 776e 3f0a    # Scale down?.
+0004c600: 2020 2020 2020 2020 2020 2020 746f 5f63              to_c
+0004c610: 6c6f 7365 203d 2073 656c 662e 776f 726b  lose = self.work
+0004c620: 6572 735f 746f 5f63 6c6f 7365 2829 0a20  ers_to_close(). 
+0004c630: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0004c640: 6e20 6c65 6e28 7365 6c66 2e77 6f72 6b65  n len(self.worke
+0004c650: 7273 2920 2d20 6c65 6e28 746f 5f63 6c6f  rs) - len(to_clo
+0004c660: 7365 290a 0a20 2020 2064 6566 2072 6571  se)..    def req
+0004c670: 7565 7374 5f61 6371 7569 7265 5f72 6570  uest_acquire_rep
+0004c680: 6c69 6361 7328 0a20 2020 2020 2020 2073  licas(.        s
+0004c690: 656c 662c 2061 6464 723a 2073 7472 2c20  elf, addr: str, 
+0004c6a0: 6b65 7973 3a20 4974 6572 6162 6c65 5b4b  keys: Iterable[K
+0004c6b0: 6579 5d2c 202a 2c20 7374 696d 756c 7573  ey], *, stimulus
+0004c6c0: 5f69 643a 2073 7472 0a20 2020 2029 202d  _id: str.    ) -
+0004c6d0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+0004c6e0: 2222 2241 7379 6e63 6872 6f6e 6f75 736c  """Asynchronousl
+0004c6f0: 7920 6173 6b20 6120 776f 726b 6572 2074  y ask a worker t
+0004c700: 6f20 6163 7175 6972 6520 6120 7265 706c  o acquire a repl
+0004c710: 6963 6120 6f66 2074 6865 206c 6973 7465  ica of the liste
+0004c720: 6420 6b65 7973 2066 726f 6d0a 2020 2020  d keys from.    
+0004c730: 2020 2020 6f74 6865 7220 776f 726b 6572      other worker
+0004c740: 732e 2054 6869 7320 6973 2061 2066 6972  s. This is a fir
+0004c750: 652d 616e 642d 666f 7267 6574 206f 7065  e-and-forget ope
+0004c760: 7261 7469 6f6e 2077 6869 6368 206f 6666  ration which off
+0004c770: 6572 7320 6e6f 2066 6565 6462 6163 6b20  ers no feedback 
+0004c780: 666f 720a 2020 2020 2020 2020 7375 6363  for.        succ
+0004c790: 6573 7320 6f72 2066 6169 6c75 7265 2c20  ess or failure, 
+0004c7a0: 616e 6420 6973 2069 6e74 656e 6465 6420  and is intended 
+0004c7b0: 666f 7220 686f 7573 656b 6565 7069 6e67  for housekeeping
+0004c7c0: 2061 6e64 206e 6f74 2066 6f72 2063 6f6d   and not for com
+0004c7d0: 7075 7461 7469 6f6e 2e0a 2020 2020 2020  putation..      
+0004c7e0: 2020 2222 220a 2020 2020 2020 2020 7768    """.        wh
+0004c7f0: 6f5f 6861 7320 3d20 7b7d 0a20 2020 2020  o_has = {}.     
+0004c800: 2020 206e 6279 7465 7320 3d20 7b7d 0a20     nbytes = {}. 
+0004c810: 2020 2020 2020 2066 6f72 206b 6579 2069         for key i
+0004c820: 6e20 6b65 7973 3a0a 2020 2020 2020 2020  n keys:.        
+0004c830: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
+0004c840: 736b 735b 6b65 795d 0a20 2020 2020 2020  sks[key].       
+0004c850: 2020 2020 2061 7373 6572 7420 7473 2e77       assert ts.w
+0004c860: 686f 5f68 6173 0a20 2020 2020 2020 2020  ho_has.         
+0004c870: 2020 2077 686f 5f68 6173 5b6b 6579 5d20     who_has[key] 
+0004c880: 3d20 5b77 732e 6164 6472 6573 7320 666f  = [ws.address fo
+0004c890: 7220 7773 2069 6e20 7473 2e77 686f 5f68  r ws in ts.who_h
+0004c8a0: 6173 206f 7220 2829 5d0a 2020 2020 2020  as or ()].      
+0004c8b0: 2020 2020 2020 6e62 7974 6573 5b6b 6579        nbytes[key
+0004c8c0: 5d20 3d20 7473 2e6e 6279 7465 730a 0a20  ] = ts.nbytes.. 
+0004c8d0: 2020 2020 2020 2073 656c 662e 7374 7265         self.stre
+0004c8e0: 616d 5f63 6f6d 6d73 5b61 6464 725d 2e73  am_comms[addr].s
+0004c8f0: 656e 6428 0a20 2020 2020 2020 2020 2020  end(.           
+0004c900: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+0004c910: 2020 2022 6f70 223a 2022 6163 7175 6972     "op": "acquir
+0004c920: 652d 7265 706c 6963 6173 222c 0a20 2020  e-replicas",.   
+0004c930: 2020 2020 2020 2020 2020 2020 2022 7768               "wh
+0004c940: 6f5f 6861 7322 3a20 7768 6f5f 6861 732c  o_has": who_has,
+0004c950: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004c960: 2022 6e62 7974 6573 223a 206e 6279 7465   "nbytes": nbyte
+0004c970: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+0004c980: 2020 2022 7374 696d 756c 7573 5f69 6422     "stimulus_id"
+0004c990: 3a20 7374 696d 756c 7573 5f69 642c 0a20  : stimulus_id,. 
+0004c9a0: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
+0004c9b0: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
+0004c9c0: 2072 6571 7565 7374 5f72 656d 6f76 655f   request_remove_
+0004c9d0: 7265 706c 6963 6173 280a 2020 2020 2020  replicas(.      
+0004c9e0: 2020 7365 6c66 2c20 6164 6472 3a20 7374    self, addr: st
+0004c9f0: 722c 206b 6579 733a 206c 6973 745b 4b65  r, keys: list[Ke
+0004ca00: 795d 2c20 2a2c 2073 7469 6d75 6c75 735f  y], *, stimulus_
+0004ca10: 6964 3a20 7374 720a 2020 2020 2920 2d3e  id: str.    ) ->
+0004ca20: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
+0004ca30: 2222 4173 796e 6368 726f 6e6f 7573 6c79  ""Asynchronously
+0004ca40: 2061 736b 2061 2077 6f72 6b65 7220 746f   ask a worker to
+0004ca50: 2064 6973 6361 7264 2069 7473 2072 6570   discard its rep
+0004ca60: 6c69 6361 206f 6620 7468 6520 6c69 7374  lica of the list
+0004ca70: 6564 206b 6579 732e 0a20 2020 2020 2020  ed keys..       
+0004ca80: 2054 6869 7320 6d75 7374 206e 6576 6572   This must never
+0004ca90: 2062 6520 7573 6564 2074 6f20 6465 7374   be used to dest
+0004caa0: 726f 7920 7468 6520 6c61 7374 2072 6570  roy the last rep
+0004cab0: 6c69 6361 206f 6620 6120 6b65 792e 2054  lica of a key. T
+0004cac0: 6869 7320 6973 2061 0a20 2020 2020 2020  his is a.       
+0004cad0: 2066 6972 652d 616e 642d 666f 7267 6574   fire-and-forget
+0004cae0: 206f 7065 7261 7469 6f6e 2c20 696e 7465   operation, inte
+0004caf0: 6e64 6564 2066 6f72 2068 6f75 7365 6b65  nded for houseke
+0004cb00: 6570 696e 6720 616e 6420 6e6f 7420 666f  eping and not fo
+0004cb10: 7220 636f 6d70 7574 6174 696f 6e2e 0a0a  r computation...
+0004cb20: 2020 2020 2020 2020 5468 6520 7265 706c          The repl
+0004cb30: 6963 6120 6469 7361 7070 6561 7273 2069  ica disappears i
+0004cb40: 6d6d 6564 6961 7465 6c79 2066 726f 6d20  mmediately from 
+0004cb50: 5461 736b 5374 6174 652e 7768 6f5f 6861  TaskState.who_ha
+0004cb60: 7320 6f6e 2074 6865 2053 6368 6564 756c  s on the Schedul
+0004cb70: 6572 2073 6964 653b 0a20 2020 2020 2020  er side;.       
+0004cb80: 2069 6620 7468 6520 776f 726b 6572 2072   if the worker r
+0004cb90: 6566 7573 6573 2074 6f20 6465 6c65 7465  efuses to delete
+0004cba0: 2c20 652e 672e 2062 6563 6175 7365 2074  , e.g. because t
+0004cbb0: 6865 2074 6173 6b20 6973 2061 2064 6570  he task is a dep
+0004cbc0: 656e 6465 6e63 7920 6f66 0a20 2020 2020  endency of.     
+0004cbd0: 2020 2061 6e6f 7468 6572 2074 6173 6b20     another task 
+0004cbe0: 7275 6e6e 696e 6720 6f6e 2069 742c 2069  running on it, i
+0004cbf0: 7420 7769 6c6c 2028 616c 736f 2061 7379  t will (also asy
+0004cc00: 6e63 6872 6f6e 6f75 736c 7929 2069 6e66  nchronously) inf
+0004cc10: 6f72 6d20 7468 6520 7363 6865 6475 6c65  orm the schedule
+0004cc20: 720a 2020 2020 2020 2020 746f 2072 652d  r.        to re-
+0004cc30: 6164 6420 6974 7365 6c66 2074 6f20 7768  add itself to wh
+0004cc40: 6f5f 6861 732e 2049 6620 7468 6520 776f  o_has. If the wo
+0004cc50: 726b 6572 2061 6772 6565 7320 746f 2064  rker agrees to d
+0004cc60: 6973 6361 7264 2074 6865 2074 6173 6b2c  iscard the task,
+0004cc70: 2074 6865 7265 2069 730a 2020 2020 2020   there is.      
+0004cc80: 2020 6e6f 2066 6565 6462 6163 6b2e 0a20    no feedback.. 
+0004cc90: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0004cca0: 2020 2077 7320 3d20 7365 6c66 2e77 6f72     ws = self.wor
+0004ccb0: 6b65 7273 5b61 6464 725d 0a0a 2020 2020  kers[addr]..    
+0004ccc0: 2020 2020 2320 5468 6520 7363 6865 6475      # The schedu
+0004ccd0: 6c65 7220 696d 6d65 6469 6174 656c 7920  ler immediately 
+0004cce0: 666f 7267 6574 7320 6162 6f75 7420 7468  forgets about th
+0004ccf0: 6520 7265 706c 6963 6120 616e 6420 7375  e replica and su
+0004cd00: 6767 6573 7473 2074 6865 2077 6f72 6b65  ggests the worke
+0004cd10: 7220 746f 0a20 2020 2020 2020 2023 2064  r to.        # d
+0004cd20: 726f 7020 6974 2e20 5468 6520 776f 726b  rop it. The work
+0004cd30: 6572 206d 6179 2072 6566 7573 652c 2061  er may refuse, a
+0004cd40: 7420 7768 6963 6820 706f 696e 7420 6974  t which point it
+0004cd50: 2077 696c 6c20 7365 6e64 2062 6163 6b20   will send back 
+0004cd60: 616e 2061 6464 2d6b 6579 730a 2020 2020  an add-keys.    
+0004cd70: 2020 2020 2320 6d65 7373 6167 6520 746f      # message to
+0004cd80: 2072 6569 6e73 7461 7465 2069 742e 0a20   reinstate it.. 
+0004cd90: 2020 2020 2020 2066 6f72 206b 6579 2069         for key i
+0004cda0: 6e20 6b65 7973 3a0a 2020 2020 2020 2020  n keys:.        
+0004cdb0: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
+0004cdc0: 736b 735b 6b65 795d 0a20 2020 2020 2020  sks[key].       
+0004cdd0: 2020 2020 2069 6620 7365 6c66 2e76 616c       if self.val
+0004cde0: 6964 6174 653a 0a20 2020 2020 2020 2020  idate:.         
+0004cdf0: 2020 2020 2020 2023 2044 6f20 6e6f 7420         # Do not 
+0004ce00: 6465 7374 726f 7920 7468 6520 6c61 7374  destroy the last
+0004ce10: 2063 6f70 790a 2020 2020 2020 2020 2020   copy.          
+0004ce20: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
+0004ce30: 7768 6f5f 6861 730a 2020 2020 2020 2020  who_has.        
+0004ce40: 2020 2020 2020 2020 6173 7365 7274 206c          assert l
+0004ce50: 656e 2874 732e 7768 6f5f 6861 7329 203e  en(ts.who_has) >
+0004ce60: 2031 0a20 2020 2020 2020 2020 2020 2073   1.            s
+0004ce70: 656c 662e 7265 6d6f 7665 5f72 6570 6c69  elf.remove_repli
+0004ce80: 6361 2874 732c 2077 7329 0a0a 2020 2020  ca(ts, ws)..    
+0004ce90: 2020 2020 7365 6c66 2e73 7472 6561 6d5f      self.stream_
+0004cea0: 636f 6d6d 735b 6164 6472 5d2e 7365 6e64  comms[addr].send
+0004ceb0: 280a 2020 2020 2020 2020 2020 2020 7b0a  (.            {.
+0004cec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ced0: 226f 7022 3a20 2272 656d 6f76 652d 7265  "op": "remove-re
+0004cee0: 706c 6963 6173 222c 0a20 2020 2020 2020  plicas",.       
+0004cef0: 2020 2020 2020 2020 2022 6b65 7973 223a           "keys":
+0004cf00: 206b 6579 732c 0a20 2020 2020 2020 2020   keys,.         
+0004cf10: 2020 2020 2020 2022 7374 696d 756c 7573         "stimulus
+0004cf20: 5f69 6422 3a20 7374 696d 756c 7573 5f69  _id": stimulus_i
+0004cf30: 642c 0a20 2020 2020 2020 2020 2020 207d  d,.            }
+0004cf40: 0a20 2020 2020 2020 2029 0a0a 0a64 6566  .        )...def
+0004cf50: 205f 7461 736b 5f74 6f5f 7265 706f 7274   _task_to_report
+0004cf60: 5f6d 7367 2874 733a 2054 6173 6b53 7461  _msg(ts: TaskSta
+0004cf70: 7465 2920 2d3e 2064 6963 745b 7374 722c  te) -> dict[str,
+0004cf80: 2041 6e79 5d20 7c20 4e6f 6e65 3a0a 2020   Any] | None:.  
+0004cf90: 2020 6966 2074 732e 7374 6174 6520 3d3d    if ts.state ==
+0004cfa0: 2022 666f 7267 6f74 7465 6e22 3a0a 2020   "forgotten":.  
+0004cfb0: 2020 2020 2020 7265 7475 726e 207b 226f        return {"o
+0004cfc0: 7022 3a20 2263 616e 6365 6c6c 6564 2d6b  p": "cancelled-k
+0004cfd0: 6579 7322 2c20 226b 6579 7322 3a20 5b74  eys", "keys": [t
+0004cfe0: 732e 6b65 795d 7d0a 2020 2020 656c 6966  s.key]}.    elif
+0004cff0: 2074 732e 7374 6174 6520 3d3d 2022 6d65   ts.state == "me
+0004d000: 6d6f 7279 223a 0a20 2020 2020 2020 2072  mory":.        r
+0004d010: 6574 7572 6e20 7b22 6f70 223a 2022 6b65  eturn {"op": "ke
+0004d020: 792d 696e 2d6d 656d 6f72 7922 2c20 226b  y-in-memory", "k
+0004d030: 6579 223a 2074 732e 6b65 797d 0a20 2020  ey": ts.key}.   
+0004d040: 2065 6c69 6620 7473 2e73 7461 7465 203d   elif ts.state =
+0004d050: 3d20 2265 7272 6564 223a 0a20 2020 2020  = "erred":.     
+0004d060: 2020 2066 6169 6c69 6e67 5f74 7320 3d20     failing_ts = 
+0004d070: 7473 2e65 7863 6570 7469 6f6e 5f62 6c61  ts.exception_bla
+0004d080: 6d65 0a20 2020 2020 2020 2061 7373 6572  me.        asser
+0004d090: 7420 6661 696c 696e 675f 7473 0a20 2020  t failing_ts.   
+0004d0a0: 2020 2020 2072 6574 7572 6e20 7b0a 2020       return {.  
+0004d0b0: 2020 2020 2020 2020 2020 226f 7022 3a20            "op": 
+0004d0c0: 2274 6173 6b2d 6572 7265 6422 2c0a 2020  "task-erred",.  
+0004d0d0: 2020 2020 2020 2020 2020 226b 6579 223a            "key":
+0004d0e0: 2074 732e 6b65 792c 0a20 2020 2020 2020   ts.key,.       
+0004d0f0: 2020 2020 2022 6578 6365 7074 696f 6e22       "exception"
+0004d100: 3a20 6661 696c 696e 675f 7473 2e65 7863  : failing_ts.exc
+0004d110: 6570 7469 6f6e 2c0a 2020 2020 2020 2020  eption,.        
+0004d120: 2020 2020 2274 7261 6365 6261 636b 223a      "traceback":
+0004d130: 2066 6169 6c69 6e67 5f74 732e 7472 6163   failing_ts.trac
+0004d140: 6562 6163 6b2c 0a20 2020 2020 2020 207d  eback,.        }
+0004d150: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+0004d160: 2020 2072 6574 7572 6e20 4e6f 6e65 0a0a     return None..
+0004d170: 0a64 6566 205f 7461 736b 5f74 6f5f 636c  .def _task_to_cl
+0004d180: 6965 6e74 5f6d 7367 7328 7473 3a20 5461  ient_msgs(ts: Ta
+0004d190: 736b 5374 6174 6529 202d 3e20 4d73 6773  skState) -> Msgs
+0004d1a0: 3a0a 2020 2020 6966 2074 732e 7768 6f5f  :.    if ts.who_
+0004d1b0: 7761 6e74 733a 0a20 2020 2020 2020 2072  wants:.        r
+0004d1c0: 6570 6f72 745f 6d73 6720 3d20 5f74 6173  eport_msg = _tas
+0004d1d0: 6b5f 746f 5f72 6570 6f72 745f 6d73 6728  k_to_report_msg(
+0004d1e0: 7473 290a 2020 2020 2020 2020 6966 2072  ts).        if r
+0004d1f0: 6570 6f72 745f 6d73 6720 6973 206e 6f74  eport_msg is not
+0004d200: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0004d210: 2020 2072 6574 7572 6e20 7b63 732e 636c     return {cs.cl
+0004d220: 6965 6e74 5f6b 6579 3a20 5b72 6570 6f72  ient_key: [repor
+0004d230: 745f 6d73 675d 2066 6f72 2063 7320 696e  t_msg] for cs in
+0004d240: 2074 732e 7768 6f5f 7761 6e74 737d 0a20   ts.who_wants}. 
+0004d250: 2020 2072 6574 7572 6e20 7b7d 0a0a 0a64     return {}...d
+0004d260: 6566 2064 6563 6964 655f 776f 726b 6572  ef decide_worker
+0004d270: 280a 2020 2020 7473 3a20 5461 736b 5374  (.    ts: TaskSt
+0004d280: 6174 652c 0a20 2020 2061 6c6c 5f77 6f72  ate,.    all_wor
+0004d290: 6b65 7273 3a20 7365 745b 576f 726b 6572  kers: set[Worker
+0004d2a0: 5374 6174 655d 2c0a 2020 2020 7661 6c69  State],.    vali
+0004d2b0: 645f 776f 726b 6572 733a 2073 6574 5b57  d_workers: set[W
+0004d2c0: 6f72 6b65 7253 7461 7465 5d20 7c20 4e6f  orkerState] | No
+0004d2d0: 6e65 2c0a 2020 2020 6f62 6a65 6374 6976  ne,.    objectiv
+0004d2e0: 653a 2043 616c 6c61 626c 655b 5b57 6f72  e: Callable[[Wor
+0004d2f0: 6b65 7253 7461 7465 5d2c 2041 6e79 5d2c  kerState], Any],
+0004d300: 0a29 202d 3e20 576f 726b 6572 5374 6174  .) -> WorkerStat
+0004d310: 6520 7c20 4e6f 6e65 3a0a 2020 2020 2222  e | None:.    ""
+0004d320: 220a 2020 2020 4465 6369 6465 2077 6869  ".    Decide whi
+0004d330: 6368 2077 6f72 6b65 7220 7368 6f75 6c64  ch worker should
+0004d340: 2074 616b 6520 7461 736b 202a 7473 2a2e   take task *ts*.
+0004d350: 0a0a 2020 2020 5765 2063 686f 6f73 6520  ..    We choose 
+0004d360: 7468 6520 776f 726b 6572 2074 6861 7420  the worker that 
+0004d370: 6861 7320 7468 6520 6461 7461 206f 6e20  has the data on 
+0004d380: 7768 6963 6820 2a74 732a 2064 6570 656e  which *ts* depen
+0004d390: 6473 2e0a 0a20 2020 2049 6620 7365 7665  ds...    If seve
+0004d3a0: 7261 6c20 776f 726b 6572 7320 6861 7665  ral workers have
+0004d3b0: 2064 6570 656e 6465 6e63 6965 7320 7468   dependencies th
+0004d3c0: 656e 2077 6520 6368 6f6f 7365 2074 6865  en we choose the
+0004d3d0: 206c 6573 732d 6275 7379 2077 6f72 6b65   less-busy worke
+0004d3e0: 722e 0a0a 2020 2020 4f70 7469 6f6e 616c  r...    Optional
+0004d3f0: 6c79 2070 726f 7669 6465 202a 7661 6c69  ly provide *vali
+0004d400: 645f 776f 726b 6572 732a 206f 6620 7768  d_workers* of wh
+0004d410: 6572 6520 6a6f 6273 2061 7265 2061 6c6c  ere jobs are all
+0004d420: 6f77 6564 2074 6f20 6f63 6375 720a 2020  owed to occur.  
+0004d430: 2020 2869 6620 616c 6c20 776f 726b 6572    (if all worker
+0004d440: 7320 6172 6520 616c 6c6f 7765 6420 746f  s are allowed to
+0004d450: 2074 616b 6520 7468 6520 7461 736b 2c20   take the task, 
+0004d460: 7061 7373 204e 6f6e 6520 696e 7374 6561  pass None instea
+0004d470: 6429 2e0a 0a20 2020 2049 6620 7468 6520  d)...    If the 
+0004d480: 7461 736b 2072 6571 7569 7265 7320 6461  task requires da
+0004d490: 7461 2063 6f6d 6d75 6e69 6361 7469 6f6e  ta communication
+0004d4a0: 2062 6563 6175 7365 206e 6f20 656c 6967   because no elig
+0004d4b0: 6962 6c65 2077 6f72 6b65 7220 6861 730a  ible worker has.
+0004d4c0: 2020 2020 616c 6c20 7468 6520 6465 7065      all the depe
+0004d4d0: 6e64 656e 6369 6573 2061 6c72 6561 6479  ndencies already
+0004d4e0: 2c20 7468 656e 2077 6520 6368 6f6f 7365  , then we choose
+0004d4f0: 2074 6f20 6d69 6e69 6d69 7a65 2074 6865   to minimize the
+0004d500: 206e 756d 6265 720a 2020 2020 6f66 2062   number.    of b
+0004d510: 7974 6573 2073 656e 7420 6265 7477 6565  ytes sent betwee
+0004d520: 6e20 776f 726b 6572 732e 2020 5468 6973  n workers.  This
+0004d530: 2069 7320 6465 7465 726d 696e 6564 2062   is determined b
+0004d540: 7920 6361 6c6c 696e 6720 7468 650a 2020  y calling the.  
+0004d550: 2020 2a6f 626a 6563 7469 7665 2a20 6675    *objective* fu
+0004d560: 6e63 7469 6f6e 2e0a 2020 2020 2222 220a  nction..    """.
+0004d570: 2020 2020 6173 7365 7274 2061 6c6c 2864      assert all(d
+0004d580: 7473 2e77 686f 5f68 6173 2066 6f72 2064  ts.who_has for d
+0004d590: 7473 2069 6e20 7473 2e64 6570 656e 6465  ts in ts.depende
+0004d5a0: 6e63 6965 7329 0a20 2020 2069 6620 7473  ncies).    if ts
+0004d5b0: 2e61 6374 6f72 3a0a 2020 2020 2020 2020  .actor:.        
+0004d5c0: 6361 6e64 6964 6174 6573 203d 2061 6c6c  candidates = all
+0004d5d0: 5f77 6f72 6b65 7273 2e63 6f70 7928 290a  _workers.copy().
+0004d5e0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0004d5f0: 2020 6361 6e64 6964 6174 6573 203d 207b    candidates = {
+0004d600: 7777 7320 666f 7220 6474 7320 696e 2074  wws for dts in t
+0004d610: 732e 6465 7065 6e64 656e 6369 6573 2066  s.dependencies f
+0004d620: 6f72 2077 7773 2069 6e20 6474 732e 7768  or wws in dts.wh
+0004d630: 6f5f 6861 7320 6f72 2028 297d 0a20 2020  o_has or ()}.   
+0004d640: 2020 2020 2063 616e 6469 6461 7465 7320       candidates 
+0004d650: 263d 2061 6c6c 5f77 6f72 6b65 7273 0a20  &= all_workers. 
+0004d660: 2020 2069 6620 7661 6c69 645f 776f 726b     if valid_work
+0004d670: 6572 7320 6973 204e 6f6e 653a 0a20 2020  ers is None:.   
+0004d680: 2020 2020 2069 6620 6e6f 7420 6361 6e64       if not cand
+0004d690: 6964 6174 6573 3a0a 2020 2020 2020 2020  idates:.        
+0004d6a0: 2020 2020 6361 6e64 6964 6174 6573 203d      candidates =
+0004d6b0: 2061 6c6c 5f77 6f72 6b65 7273 2e63 6f70   all_workers.cop
+0004d6c0: 7928 290a 2020 2020 656c 7365 3a0a 2020  y().    else:.  
+0004d6d0: 2020 2020 2020 6361 6e64 6964 6174 6573        candidates
+0004d6e0: 2026 3d20 7661 6c69 645f 776f 726b 6572   &= valid_worker
+0004d6f0: 730a 2020 2020 2020 2020 6966 206e 6f74  s.        if not
+0004d700: 2063 616e 6469 6461 7465 733a 0a20 2020   candidates:.   
+0004d710: 2020 2020 2020 2020 2063 616e 6469 6461           candida
+0004d720: 7465 7320 3d20 7661 6c69 645f 776f 726b  tes = valid_work
+0004d730: 6572 730a 2020 2020 2020 2020 2020 2020  ers.            
+0004d740: 6966 206e 6f74 2063 616e 6469 6461 7465  if not candidate
+0004d750: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0004d760: 2020 2069 6620 7473 2e6c 6f6f 7365 5f72     if ts.loose_r
+0004d770: 6573 7472 6963 7469 6f6e 733a 0a20 2020  estrictions:.   
+0004d780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004d790: 2072 6574 7572 6e20 6465 6369 6465 5f77   return decide_w
+0004d7a0: 6f72 6b65 7228 7473 2c20 616c 6c5f 776f  orker(ts, all_wo
+0004d7b0: 726b 6572 732c 204e 6f6e 652c 206f 626a  rkers, None, obj
+0004d7c0: 6563 7469 7665 290a 0a20 2020 2069 6620  ective)..    if 
+0004d7d0: 6e6f 7420 6361 6e64 6964 6174 6573 3a0a  not candidates:.
+0004d7e0: 2020 2020 2020 2020 7265 7475 726e 204e          return N
+0004d7f0: 6f6e 650a 2020 2020 656c 6966 206c 656e  one.    elif len
+0004d800: 2863 616e 6469 6461 7465 7329 203d 3d20  (candidates) == 
+0004d810: 313a 0a20 2020 2020 2020 2072 6574 7572  1:.        retur
+0004d820: 6e20 6e65 7874 2869 7465 7228 6361 6e64  n next(iter(cand
+0004d830: 6964 6174 6573 2929 0a20 2020 2065 6c73  idates)).    els
+0004d840: 653a 0a20 2020 2020 2020 2072 6574 7572  e:.        retur
+0004d850: 6e20 6d69 6e28 6361 6e64 6964 6174 6573  n min(candidates
+0004d860: 2c20 6b65 793d 6f62 6a65 6374 6976 6529  , key=objective)
+0004d870: 0a0a 0a64 6566 2076 616c 6964 6174 655f  ...def validate_
+0004d880: 7461 736b 5f73 7461 7465 2874 733a 2054  task_state(ts: T
+0004d890: 6173 6b53 7461 7465 2920 2d3e 204e 6f6e  askState) -> Non
+0004d8a0: 653a 0a20 2020 2022 2222 5661 6c69 6461  e:.    """Valida
+0004d8b0: 7465 2074 6865 2067 6976 656e 2054 6173  te the given Tas
+0004d8c0: 6b53 7461 7465 2222 220a 2020 2020 6173  kState""".    as
+0004d8d0: 7365 7274 2074 732e 7374 6174 6520 696e  sert ts.state in
+0004d8e0: 2041 4c4c 5f54 4153 4b5f 5354 4154 4553   ALL_TASK_STATES
+0004d8f0: 2c20 7473 0a0a 2020 2020 6966 2074 732e  , ts..    if ts.
+0004d900: 7761 6974 696e 675f 6f6e 3a0a 2020 2020  waiting_on:.    
+0004d910: 2020 2020 6173 7365 7274 2074 732e 7761      assert ts.wa
+0004d920: 6974 696e 675f 6f6e 2e69 7373 7562 7365  iting_on.issubse
+0004d930: 7428 7473 2e64 6570 656e 6465 6e63 6965  t(ts.dependencie
+0004d940: 7329 2c20 280a 2020 2020 2020 2020 2020  s), (.          
+0004d950: 2020 2277 6169 7469 6e67 206e 6f74 2073    "waiting not s
+0004d960: 7562 7365 7420 6f66 2064 6570 656e 6465  ubset of depende
+0004d970: 6e63 6965 7322 2c0a 2020 2020 2020 2020  ncies",.        
+0004d980: 2020 2020 7374 7228 7473 2e77 6169 7469      str(ts.waiti
+0004d990: 6e67 5f6f 6e29 2c0a 2020 2020 2020 2020  ng_on),.        
+0004d9a0: 2020 2020 7374 7228 7473 2e64 6570 656e      str(ts.depen
+0004d9b0: 6465 6e63 6965 7329 2c0a 2020 2020 2020  dencies),.      
+0004d9c0: 2020 290a 2020 2020 6966 2074 732e 7761    ).    if ts.wa
+0004d9d0: 6974 6572 733a 0a20 2020 2020 2020 2061  iters:.        a
+0004d9e0: 7373 6572 7420 7473 2e77 6169 7465 7273  ssert ts.waiters
+0004d9f0: 2e69 7373 7562 7365 7428 7473 2e64 6570  .issubset(ts.dep
+0004da00: 656e 6465 6e74 7329 2c20 280a 2020 2020  endents), (.    
+0004da10: 2020 2020 2020 2020 2277 6169 7465 7273          "waiters
+0004da20: 206e 6f74 2073 7562 7365 7420 6f66 2064   not subset of d
+0004da30: 6570 656e 6465 6e74 7322 2c0a 2020 2020  ependents",.    
+0004da40: 2020 2020 2020 2020 7374 7228 7473 2e77          str(ts.w
+0004da50: 6169 7465 7273 292c 0a20 2020 2020 2020  aiters),.       
+0004da60: 2020 2020 2073 7472 2874 732e 6465 7065       str(ts.depe
+0004da70: 6e64 656e 7473 292c 0a20 2020 2020 2020  ndents),.       
+0004da80: 2029 0a0a 2020 2020 666f 7220 6474 7320   )..    for dts 
+0004da90: 696e 2074 732e 7761 6974 696e 675f 6f6e  in ts.waiting_on
+0004daa0: 206f 7220 2829 3a0a 2020 2020 2020 2020   or ():.        
+0004dab0: 6173 7365 7274 206e 6f74 2064 7473 2e77  assert not dts.w
+0004dac0: 686f 5f68 6173 2c20 2822 7761 6974 696e  ho_has, ("waitin
+0004dad0: 6720 6f6e 2069 6e2d 6d65 6d6f 7279 2064  g on in-memory d
+0004dae0: 6570 222c 2073 7472 2874 7329 2c20 7374  ep", str(ts), st
+0004daf0: 7228 6474 7329 290a 2020 2020 2020 2020  r(dts)).        
+0004db00: 6173 7365 7274 2064 7473 2e73 7461 7465  assert dts.state
+0004db10: 2021 3d20 2272 656c 6561 7365 6422 2c20   != "released", 
+0004db20: 2822 7761 6974 696e 6720 6f6e 2072 656c  ("waiting on rel
+0004db30: 6561 7365 6420 6465 7022 2c20 7374 7228  eased dep", str(
+0004db40: 7473 292c 2073 7472 2864 7473 2929 0a20  ts), str(dts)). 
+0004db50: 2020 2066 6f72 2064 7473 2069 6e20 7473     for dts in ts
+0004db60: 2e64 6570 656e 6465 6e63 6965 733a 0a20  .dependencies:. 
+0004db70: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
+0004db80: 2069 6e20 6474 732e 6465 7065 6e64 656e   in dts.dependen
+0004db90: 7473 2c20 280a 2020 2020 2020 2020 2020  ts, (.          
+0004dba0: 2020 226e 6f74 2069 6e20 6465 7065 6e64    "not in depend
+0004dbb0: 656e 6379 2773 2064 6570 656e 6465 6e74  ency's dependent
+0004dbc0: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
+0004dbd0: 7374 7228 7473 292c 0a20 2020 2020 2020  str(ts),.       
+0004dbe0: 2020 2020 2073 7472 2864 7473 292c 0a20       str(dts),. 
+0004dbf0: 2020 2020 2020 2020 2020 2073 7472 2864             str(d
+0004dc00: 7473 2e64 6570 656e 6465 6e74 7329 2c0a  ts.dependents),.
+0004dc10: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0004dc20: 2020 6966 2074 732e 7374 6174 6520 696e    if ts.state in
+0004dc30: 2028 2277 6169 7469 6e67 222c 2022 7175   ("waiting", "qu
+0004dc40: 6575 6564 222c 2022 7072 6f63 6573 7369  eued", "processi
+0004dc50: 6e67 222c 2022 6e6f 2d77 6f72 6b65 7222  ng", "no-worker"
+0004dc60: 293a 0a20 2020 2020 2020 2020 2020 2061  ):.            a
+0004dc70: 7373 6572 7420 7473 2e77 6169 7469 6e67  ssert ts.waiting
+0004dc80: 5f6f 6e20 616e 6420 6474 7320 696e 2074  _on and dts in t
+0004dc90: 732e 7761 6974 696e 675f 6f6e 206f 7220  s.waiting_on or 
+0004dca0: 6474 732e 7768 6f5f 6861 732c 2028 0a20  dts.who_has, (. 
+0004dcb0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0004dcc0: 6465 7020 6d69 7373 696e 6722 2c0a 2020  dep missing",.  
+0004dcd0: 2020 2020 2020 2020 2020 2020 2020 7374                st
+0004dce0: 7228 7473 292c 0a20 2020 2020 2020 2020  r(ts),.         
+0004dcf0: 2020 2020 2020 2073 7472 2864 7473 292c         str(dts),
+0004dd00: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+0004dd10: 2020 2020 2020 2061 7373 6572 7420 6474         assert dt
+0004dd20: 732e 7374 6174 6520 213d 2022 666f 7267  s.state != "forg
+0004dd30: 6f74 7465 6e22 0a0a 2020 2020 666f 7220  otten"..    for 
+0004dd40: 6474 7320 696e 2074 732e 7761 6974 6572  dts in ts.waiter
+0004dd50: 7320 6f72 2028 293a 0a20 2020 2020 2020  s or ():.       
+0004dd60: 2061 7373 6572 7420 6474 732e 7374 6174   assert dts.stat
+0004dd70: 6520 696e 2028 2277 6169 7469 6e67 222c  e in ("waiting",
+0004dd80: 2022 7175 6575 6564 222c 2022 7072 6f63   "queued", "proc
+0004dd90: 6573 7369 6e67 222c 2022 6e6f 2d77 6f72  essing", "no-wor
+0004dda0: 6b65 7222 292c 2028 0a20 2020 2020 2020  ker"), (.       
+0004ddb0: 2020 2020 2022 7761 6974 6572 206e 6f74       "waiter not
+0004ddc0: 2069 6e20 706c 6179 222c 0a20 2020 2020   in play",.     
+0004ddd0: 2020 2020 2020 2073 7472 2874 7329 2c0a         str(ts),.
+0004dde0: 2020 2020 2020 2020 2020 2020 7374 7228              str(
+0004ddf0: 6474 7329 2c0a 2020 2020 2020 2020 290a  dts),.        ).
+0004de00: 2020 2020 666f 7220 6474 7320 696e 2074      for dts in t
+0004de10: 732e 6465 7065 6e64 656e 7473 3a0a 2020  s.dependents:.  
+0004de20: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
+0004de30: 696e 2064 7473 2e64 6570 656e 6465 6e63  in dts.dependenc
+0004de40: 6965 732c 2028 0a20 2020 2020 2020 2020  ies, (.         
+0004de50: 2020 2022 6e6f 7420 696e 2064 6570 656e     "not in depen
+0004de60: 6465 6e74 2773 2064 6570 656e 6465 6e63  dent's dependenc
+0004de70: 6965 7322 2c0a 2020 2020 2020 2020 2020  ies",.          
+0004de80: 2020 7374 7228 7473 292c 0a20 2020 2020    str(ts),.     
+0004de90: 2020 2020 2020 2073 7472 2864 7473 292c         str(dts),
+0004dea0: 0a20 2020 2020 2020 2020 2020 2073 7472  .            str
+0004deb0: 2864 7473 2e64 6570 656e 6465 6e63 6965  (dts.dependencie
+0004dec0: 7329 2c0a 2020 2020 2020 2020 290a 2020  s),.        ).  
+0004ded0: 2020 2020 2020 6173 7365 7274 2064 7473        assert dts
+0004dee0: 2e73 7461 7465 2021 3d20 2266 6f72 676f  .state != "forgo
+0004def0: 7474 656e 220a 0a20 2020 2061 7373 6572  tten"..    asser
+0004df00: 7420 2874 732e 7072 6f63 6573 7369 6e67  t (ts.processing
+0004df10: 5f6f 6e20 6973 206e 6f74 204e 6f6e 6529  _on is not None)
+0004df20: 203d 3d20 2874 732e 7374 6174 6520 3d3d   == (ts.state ==
+0004df30: 2022 7072 6f63 6573 7369 6e67 2229 0a20   "processing"). 
+0004df40: 2020 2061 7373 6572 7420 626f 6f6c 2874     assert bool(t
+0004df50: 732e 7768 6f5f 6861 7329 203d 3d20 2874  s.who_has) == (t
+0004df60: 732e 7374 6174 6520 3d3d 2022 6d65 6d6f  s.state == "memo
+0004df70: 7279 2229 2c20 2874 732c 2074 732e 7768  ry"), (ts, ts.wh
+0004df80: 6f5f 6861 732c 2074 732e 7374 6174 6529  o_has, ts.state)
+0004df90: 0a0a 2020 2020 6966 2074 732e 7374 6174  ..    if ts.stat
+0004dfa0: 6520 3d3d 2022 7175 6575 6564 223a 0a20  e == "queued":. 
+0004dfb0: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
+0004dfc0: 7420 7473 2e70 726f 6365 7373 696e 675f  t ts.processing_
+0004dfd0: 6f6e 0a20 2020 2020 2020 2061 7373 6572  on.        asser
+0004dfe0: 7420 6e6f 7420 7473 2e77 686f 5f68 6173  t not ts.who_has
+0004dff0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+0004e000: 616c 6c28 6474 732e 7768 6f5f 6861 7320  all(dts.who_has 
+0004e010: 666f 7220 6474 7320 696e 2074 732e 6465  for dts in ts.de
+0004e020: 7065 6e64 656e 6369 6573 292c 2028 0a20  pendencies), (. 
+0004e030: 2020 2020 2020 2020 2020 2022 7461 736b             "task
+0004e040: 2071 7565 7565 6420 7769 7468 6f75 7420   queued without 
+0004e050: 616c 6c20 6465 7073 222c 0a20 2020 2020  all deps",.     
+0004e060: 2020 2020 2020 2073 7472 2874 7329 2c0a         str(ts),.
+0004e070: 2020 2020 2020 2020 2020 2020 7374 7228              str(
+0004e080: 7473 2e64 6570 656e 6465 6e63 6965 7329  ts.dependencies)
+0004e090: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
+0004e0a0: 2069 6620 7473 2e73 7461 7465 203d 3d20   if ts.state == 
+0004e0b0: 2270 726f 6365 7373 696e 6722 3a0a 2020  "processing":.  
+0004e0c0: 2020 2020 2020 6173 7365 7274 2061 6c6c        assert all
+0004e0d0: 2864 7473 2e77 686f 5f68 6173 2066 6f72  (dts.who_has for
+0004e0e0: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
+0004e0f0: 6465 6e63 6965 7329 2c20 280a 2020 2020  dencies), (.    
+0004e100: 2020 2020 2020 2020 2274 6173 6b20 7072          "task pr
+0004e110: 6f63 6573 7369 6e67 2077 6974 686f 7574  ocessing without
+0004e120: 2061 6c6c 2064 6570 7322 2c0a 2020 2020   all deps",.    
+0004e130: 2020 2020 2020 2020 7374 7228 7473 292c          str(ts),
+0004e140: 0a20 2020 2020 2020 2020 2020 2073 7472  .            str
+0004e150: 2874 732e 6465 7065 6e64 656e 6369 6573  (ts.dependencies
+0004e160: 292c 0a20 2020 2020 2020 2029 0a20 2020  ),.        ).   
+0004e170: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+0004e180: 7473 2e77 6169 7469 6e67 5f6f 6e0a 0a20  ts.waiting_on.. 
+0004e190: 2020 2069 6620 7473 2e77 686f 5f68 6173     if ts.who_has
+0004e1a0: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
+0004e1b0: 2074 732e 7761 6974 6572 7320 6f72 2074   ts.waiters or t
+0004e1c0: 732e 7768 6f5f 7761 6e74 732c 2028 0a20  s.who_wants, (. 
+0004e1d0: 2020 2020 2020 2020 2020 2022 756e 6e65             "unne
+0004e1e0: 6564 6564 2074 6173 6b20 696e 206d 656d  eded task in mem
+0004e1f0: 6f72 7922 2c0a 2020 2020 2020 2020 2020  ory",.          
+0004e200: 2020 7374 7228 7473 292c 0a20 2020 2020    str(ts),.     
+0004e210: 2020 2020 2020 2073 7472 2874 732e 7768         str(ts.wh
+0004e220: 6f5f 6861 7329 2c0a 2020 2020 2020 2020  o_has),.        
+0004e230: 290a 2020 2020 2020 2020 6966 2074 732e  ).        if ts.
+0004e240: 7275 6e5f 7370 6563 3a20 2023 2077 6173  run_spec:  # was
+0004e250: 2063 6f6d 7075 7465 640a 2020 2020 2020   computed.      
+0004e260: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
+0004e270: 7479 7065 0a20 2020 2020 2020 2020 2020  type.           
+0004e280: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
+0004e290: 6365 2874 732e 7479 7065 2c20 7374 7229  ce(ts.type, str)
+0004e2a0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+0004e2b0: 6e6f 7420 616e 7928 0a20 2020 2020 2020  not any(.       
+0004e2c0: 2020 2020 205b 0a20 2020 2020 2020 2020       [.         
+0004e2d0: 2020 2020 2020 2074 7320 696e 2064 7473         ts in dts
+0004e2e0: 2e77 6169 7469 6e67 5f6f 6e0a 2020 2020  .waiting_on.    
+0004e2f0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0004e300: 6474 7320 696e 2074 732e 6465 7065 6e64  dts in ts.depend
+0004e310: 656e 7473 0a20 2020 2020 2020 2020 2020  ents.           
+0004e320: 2020 2020 2069 6620 6474 732e 7761 6974       if dts.wait
+0004e330: 696e 675f 6f6e 2069 7320 6e6f 7420 4e6f  ing_on is not No
+0004e340: 6e65 0a20 2020 2020 2020 2020 2020 205d  ne.            ]
+0004e350: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+0004e360: 2020 2066 6f72 2077 7320 696e 2074 732e     for ws in ts.
+0004e370: 7768 6f5f 6861 733a 0a20 2020 2020 2020  who_has:.       
+0004e380: 2020 2020 2061 7373 6572 7420 7473 2069       assert ts i
+0004e390: 6e20 7773 2e68 6173 5f77 6861 742c 2028  n ws.has_what, (
+0004e3a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004e3b0: 2022 6e6f 7420 696e 2077 686f 5f68 6173   "not in who_has
+0004e3c0: 2720 6861 735f 7768 6174 222c 0a20 2020  ' has_what",.   
+0004e3d0: 2020 2020 2020 2020 2020 2020 2073 7472               str
+0004e3e0: 2874 7329 2c0a 2020 2020 2020 2020 2020  (ts),.          
+0004e3f0: 2020 2020 2020 7374 7228 7773 292c 0a20        str(ws),. 
+0004e400: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0004e410: 7472 2877 732e 6861 735f 7768 6174 292c  tr(ws.has_what),
+0004e420: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+0004e430: 2020 2020 666f 7220 6373 2069 6e20 7473      for cs in ts
+0004e440: 2e77 686f 5f77 616e 7473 206f 7220 2829  .who_wants or ()
+0004e450: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
+0004e460: 2074 7320 696e 2063 732e 7761 6e74 735f   ts in cs.wants_
+0004e470: 7768 6174 2c20 280a 2020 2020 2020 2020  what, (.        
+0004e480: 2020 2020 226e 6f74 2069 6e20 7768 6f5f      "not in who_
+0004e490: 7761 6e74 7327 2077 616e 7473 5f77 6861  wants' wants_wha
+0004e4a0: 7422 2c0a 2020 2020 2020 2020 2020 2020  t",.            
+0004e4b0: 7374 7228 7473 292c 0a20 2020 2020 2020  str(ts),.       
+0004e4c0: 2020 2020 2073 7472 2863 7329 2c0a 2020       str(cs),.  
+0004e4d0: 2020 2020 2020 2020 2020 7374 7228 6373            str(cs
+0004e4e0: 2e77 616e 7473 5f77 6861 7429 2c0a 2020  .wants_what),.  
+0004e4f0: 2020 2020 2020 290a 0a20 2020 2069 6620        )..    if 
+0004e500: 7473 2e61 6374 6f72 3a0a 2020 2020 2020  ts.actor:.      
+0004e510: 2020 6966 2074 732e 7374 6174 6520 3d3d    if ts.state ==
+0004e520: 2022 6d65 6d6f 7279 223a 0a20 2020 2020   "memory":.     
+0004e530: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
+0004e540: 2e77 686f 5f68 6173 0a20 2020 2020 2020  .who_has.       
+0004e550: 2020 2020 2061 7373 6572 7420 7375 6d28       assert sum(
+0004e560: 7473 2069 6e20 7773 2e61 6374 6f72 7320  ts in ws.actors 
+0004e570: 666f 7220 7773 2069 6e20 7473 2e77 686f  for ws in ts.who
+0004e580: 5f68 6173 2920 3d3d 2031 0a20 2020 2020  _has) == 1.     
+0004e590: 2020 2069 6620 7473 2e73 7461 7465 203d     if ts.state =
+0004e5a0: 3d20 2270 726f 6365 7373 696e 6722 3a0a  = "processing":.
+0004e5b0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+0004e5c0: 7274 2074 732e 7072 6f63 6573 7369 6e67  rt ts.processing
+0004e5d0: 5f6f 6e0a 2020 2020 2020 2020 2020 2020  _on.            
+0004e5e0: 6173 7365 7274 2074 7320 696e 2074 732e  assert ts in ts.
+0004e5f0: 7072 6f63 6573 7369 6e67 5f6f 6e2e 6163  processing_on.ac
+0004e600: 746f 7273 0a20 2020 2020 2020 2061 7373  tors.        ass
+0004e610: 6572 7420 7473 2e73 7461 7465 2021 3d20  ert ts.state != 
+0004e620: 2271 7565 7565 6422 0a0a 0a64 6566 2076  "queued"...def v
+0004e630: 616c 6964 6174 655f 776f 726b 6572 5f73  alidate_worker_s
+0004e640: 7461 7465 2877 733a 2057 6f72 6b65 7253  tate(ws: WorkerS
+0004e650: 7461 7465 2920 2d3e 204e 6f6e 653a 0a20  tate) -> None:. 
+0004e660: 2020 2066 6f72 2074 7320 696e 2077 732e     for ts in ws.
+0004e670: 6861 735f 7768 6174 206f 7220 2829 3a0a  has_what or ():.
+0004e680: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
+0004e690: 732e 7768 6f5f 6861 730a 2020 2020 2020  s.who_has.      
+0004e6a0: 2020 6173 7365 7274 2077 7320 696e 2074    assert ws in t
+0004e6b0: 732e 7768 6f5f 6861 732c 2028 0a20 2020  s.who_has, (.   
+0004e6c0: 2020 2020 2020 2020 2022 6e6f 7420 696e           "not in
+0004e6d0: 2068 6173 5f77 6861 7427 2077 686f 5f68   has_what' who_h
+0004e6e0: 6173 222c 0a20 2020 2020 2020 2020 2020  as",.           
+0004e6f0: 2073 7472 2877 7329 2c0a 2020 2020 2020   str(ws),.      
+0004e700: 2020 2020 2020 7374 7228 7473 292c 0a20        str(ts),. 
+0004e710: 2020 2020 2020 2020 2020 2073 7472 2874             str(t
+0004e720: 732e 7768 6f5f 6861 7329 2c0a 2020 2020  s.who_has),.    
+0004e730: 2020 2020 290a 0a20 2020 2066 6f72 2074      )..    for t
+0004e740: 7320 696e 2077 732e 6163 746f 7273 3a0a  s in ws.actors:.
+0004e750: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
+0004e760: 732e 7374 6174 6520 696e 2028 226d 656d  s.state in ("mem
+0004e770: 6f72 7922 2c20 2270 726f 6365 7373 696e  ory", "processin
+0004e780: 6722 290a 0a0a 6465 6620 7661 6c69 6461  g")...def valida
+0004e790: 7465 5f73 7461 7465 280a 2020 2020 7461  te_state(.    ta
+0004e7a0: 736b 733a 2064 6963 745b 4b65 792c 2054  sks: dict[Key, T
+0004e7b0: 6173 6b53 7461 7465 5d2c 0a20 2020 2077  askState],.    w
+0004e7c0: 6f72 6b65 7273 3a20 6469 6374 5b73 7472  orkers: dict[str
+0004e7d0: 2c20 576f 726b 6572 5374 6174 655d 2c0a  , WorkerState],.
+0004e7e0: 2020 2020 636c 6965 6e74 733a 2064 6963      clients: dic
+0004e7f0: 745b 7374 722c 2043 6c69 656e 7453 7461  t[str, ClientSta
+0004e800: 7465 5d2c 0a29 202d 3e20 4e6f 6e65 3a0a  te],.) -> None:.
+0004e810: 2020 2020 2222 2256 616c 6964 6174 6520      """Validate 
+0004e820: 6120 6375 7272 656e 7420 7275 6e74 696d  a current runtim
+0004e830: 6520 7374 6174 652e 0a0a 2020 2020 5468  e state...    Th
+0004e840: 6973 2070 6572 666f 726d 7320 6120 7365  is performs a se
+0004e850: 7175 656e 6365 206f 6620 6368 6563 6b73  quence of checks
+0004e860: 206f 6e20 7468 6520 656e 7469 7265 2067   on the entire g
+0004e870: 7261 7068 2c20 7275 6e6e 696e 6720 696e  raph, running in
+0004e880: 2061 626f 7574 206c 696e 6561 720a 2020   about linear.  
+0004e890: 2020 7469 6d65 2e20 5468 6973 2072 6169    time. This rai
+0004e8a0: 7365 7320 6173 7365 7274 2065 7272 6f72  ses assert error
+0004e8b0: 7320 6966 2061 6e79 7468 696e 6720 646f  s if anything do
+0004e8c0: 6573 6e27 7420 6368 6563 6b20 6f75 742e  esn't check out.
+0004e8d0: 0a20 2020 2022 2222 0a20 2020 2066 6f72  .    """.    for
+0004e8e0: 2074 7320 696e 2074 6173 6b73 2e76 616c   ts in tasks.val
+0004e8f0: 7565 7328 293a 0a20 2020 2020 2020 2076  ues():.        v
+0004e900: 616c 6964 6174 655f 7461 736b 5f73 7461  alidate_task_sta
+0004e910: 7465 2874 7329 0a0a 2020 2020 666f 7220  te(ts)..    for 
+0004e920: 7773 2069 6e20 776f 726b 6572 732e 7661  ws in workers.va
+0004e930: 6c75 6573 2829 3a0a 2020 2020 2020 2020  lues():.        
+0004e940: 7661 6c69 6461 7465 5f77 6f72 6b65 725f  validate_worker_
+0004e950: 7374 6174 6528 7773 290a 0a20 2020 2066  state(ws)..    f
+0004e960: 6f72 2063 7320 696e 2063 6c69 656e 7473  or cs in clients
+0004e970: 2e76 616c 7565 7328 293a 0a20 2020 2020  .values():.     
+0004e980: 2020 2066 6f72 2074 7320 696e 2063 732e     for ts in cs.
+0004e990: 7761 6e74 735f 7768 6174 206f 7220 2829  wants_what or ()
+0004e9a0: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
+0004e9b0: 7365 7274 2074 732e 7768 6f5f 7761 6e74  sert ts.who_want
+0004e9c0: 730a 2020 2020 2020 2020 2020 2020 6173  s.            as
+0004e9d0: 7365 7274 2063 7320 696e 2074 732e 7768  sert cs in ts.wh
+0004e9e0: 6f5f 7761 6e74 732c 2028 0a20 2020 2020  o_wants, (.     
+0004e9f0: 2020 2020 2020 2020 2020 2022 6e6f 7420             "not 
+0004ea00: 696e 2077 616e 7473 5f77 6861 7427 2077  in wants_what' w
+0004ea10: 686f 5f77 616e 7473 222c 0a20 2020 2020  ho_wants",.     
+0004ea20: 2020 2020 2020 2020 2020 2073 7472 2863             str(c
+0004ea30: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
+0004ea40: 2020 2020 7374 7228 7473 292c 0a20 2020      str(ts),.   
+0004ea50: 2020 2020 2020 2020 2020 2020 2073 7472               str
+0004ea60: 2874 732e 7768 6f5f 7761 6e74 7329 2c0a  (ts.who_wants),.
+0004ea70: 2020 2020 2020 2020 2020 2020 290a 0a0a              )...
+0004ea80: 6465 6620 6865 6172 7462 6561 745f 696e  def heartbeat_in
+0004ea90: 7465 7276 616c 286e 3a20 696e 7429 202d  terval(n: int) -
+0004eaa0: 3e20 666c 6f61 743a 0a20 2020 2022 2222  > float:.    """
+0004eab0: 496e 7465 7276 616c 2069 6e20 7365 636f  Interval in seco
+0004eac0: 6e64 7320 7468 6174 2077 6520 6465 7369  nds that we desi
+0004ead0: 7265 2068 6561 7274 6265 6174 7320 6261  re heartbeats ba
+0004eae0: 7365 6420 6f6e 206e 756d 6265 7220 6f66  sed on number of
+0004eaf0: 2077 6f72 6b65 7273 2222 220a 2020 2020   workers""".    
+0004eb00: 6966 206e 203c 3d20 3130 3a0a 2020 2020  if n <= 10:.    
+0004eb10: 2020 2020 7265 7475 726e 2030 2e35 0a20      return 0.5. 
+0004eb20: 2020 2065 6c69 6620 6e20 3c20 3530 3a0a     elif n < 50:.
+0004eb30: 2020 2020 2020 2020 7265 7475 726e 2031          return 1
+0004eb40: 0a20 2020 2065 6c69 6620 6e20 3c20 3230  .    elif n < 20
+0004eb50: 303a 0a20 2020 2020 2020 2072 6574 7572  0:.        retur
+0004eb60: 6e20 320a 2020 2020 656c 7365 3a0a 2020  n 2.    else:.  
+0004eb70: 2020 2020 2020 2320 4e6f 206d 6f72 6520        # No more 
+0004eb80: 7468 616e 2032 3030 2068 6561 7274 6265  than 200 heartbe
+0004eb90: 6174 7320 6120 7365 636f 6e64 2073 6361  ats a second sca
+0004eba0: 6c65 6420 6279 2077 6f72 6b65 7273 0a20  led by workers. 
+0004ebb0: 2020 2020 2020 2072 6574 7572 6e20 6e20         return n 
+0004ebc0: 2f20 3230 3020 2b20 310a 0a0a 6465 6620  / 200 + 1...def 
+0004ebd0: 5f74 6173 6b5f 736c 6f74 735f 6176 6169  _task_slots_avai
+0004ebe0: 6c61 626c 6528 7773 3a20 576f 726b 6572  lable(ws: Worker
+0004ebf0: 5374 6174 652c 2073 6174 7572 6174 696f  State, saturatio
+0004ec00: 6e5f 6661 6374 6f72 3a20 666c 6f61 7429  n_factor: float)
+0004ec10: 202d 3e20 696e 743a 0a20 2020 2022 2222   -> int:.    """
+0004ec20: 4e75 6d62 6572 206f 6620 7461 736b 7320  Number of tasks 
+0004ec30: 7468 6174 2063 616e 2062 6520 7365 6e74  that can be sent
+0004ec40: 2074 6f20 7468 6973 2077 6f72 6b65 7220   to this worker 
+0004ec50: 7769 7468 6f75 7420 6f76 6572 7361 7475  without oversatu
+0004ec60: 7261 7469 6e67 2069 7422 2222 0a20 2020  rating it""".   
+0004ec70: 2061 7373 6572 7420 6e6f 7420 6d61 7468   assert not math
+0004ec80: 2e69 7369 6e66 2873 6174 7572 6174 696f  .isinf(saturatio
+0004ec90: 6e5f 6661 6374 6f72 290a 2020 2020 7265  n_factor).    re
+0004eca0: 7475 726e 206d 6178 286d 6174 682e 6365  turn max(math.ce
+0004ecb0: 696c 2873 6174 7572 6174 696f 6e5f 6661  il(saturation_fa
+0004ecc0: 6374 6f72 202a 2077 732e 6e74 6872 6561  ctor * ws.nthrea
+0004ecd0: 6473 292c 2031 2920 2d20 280a 2020 2020  ds), 1) - (.    
+0004ece0: 2020 2020 6c65 6e28 7773 2e70 726f 6365      len(ws.proce
+0004ecf0: 7373 696e 6729 202d 206c 656e 2877 732e  ssing) - len(ws.
+0004ed00: 6c6f 6e67 5f72 756e 6e69 6e67 290a 2020  long_running).  
+0004ed10: 2020 290a 0a0a 6465 6620 5f77 6f72 6b65    )...def _worke
+0004ed20: 725f 6675 6c6c 2877 733a 2057 6f72 6b65  r_full(ws: Worke
+0004ed30: 7253 7461 7465 2c20 7361 7475 7261 7469  rState, saturati
+0004ed40: 6f6e 5f66 6163 746f 723a 2066 6c6f 6174  on_factor: float
+0004ed50: 2920 2d3e 2062 6f6f 6c3a 0a20 2020 2069  ) -> bool:.    i
+0004ed60: 6620 6d61 7468 2e69 7369 6e66 2873 6174  f math.isinf(sat
+0004ed70: 7572 6174 696f 6e5f 6661 6374 6f72 293a  uration_factor):
+0004ed80: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0004ed90: 4661 6c73 650a 2020 2020 7265 7475 726e  False.    return
+0004eda0: 205f 7461 736b 5f73 6c6f 7473 5f61 7661   _task_slots_ava
+0004edb0: 696c 6162 6c65 2877 732c 2073 6174 7572  ilable(ws, satur
+0004edc0: 6174 696f 6e5f 6661 6374 6f72 2920 3c3d  ation_factor) <=
+0004edd0: 2030 0a0a 0a63 6c61 7373 204b 696c 6c65   0...class Kille
+0004ede0: 6457 6f72 6b65 7228 4578 6365 7074 696f  dWorker(Exceptio
+0004edf0: 6e29 3a0a 2020 2020 6465 6620 5f5f 696e  n):.    def __in
+0004ee00: 6974 5f5f 2873 656c 662c 2074 6173 6b3a  it__(self, task:
+0004ee10: 204b 6579 2c20 6c61 7374 5f77 6f72 6b65   Key, last_worke
+0004ee20: 723a 2057 6f72 6b65 7253 7461 7465 2c20  r: WorkerState, 
+0004ee30: 616c 6c6f 7765 645f 6661 696c 7572 6573  allowed_failures
+0004ee40: 3a20 696e 7429 3a0a 2020 2020 2020 2020  : int):.        
+0004ee50: 7375 7065 7228 292e 5f5f 696e 6974 5f5f  super().__init__
+0004ee60: 2874 6173 6b2c 206c 6173 745f 776f 726b  (task, last_work
+0004ee70: 6572 2c20 616c 6c6f 7765 645f 6661 696c  er, allowed_fail
+0004ee80: 7572 6573 290a 0a20 2020 2040 7072 6f70  ures)..    @prop
+0004ee90: 6572 7479 0a20 2020 2064 6566 2074 6173  erty.    def tas
+0004eea0: 6b28 7365 6c66 2920 2d3e 204b 6579 3a0a  k(self) -> Key:.
+0004eeb0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+0004eec0: 656c 662e 6172 6773 5b30 5d0a 0a20 2020  elf.args[0]..   
+0004eed0: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
+0004eee0: 6566 206c 6173 745f 776f 726b 6572 2873  ef last_worker(s
+0004eef0: 656c 6629 202d 3e20 576f 726b 6572 5374  elf) -> WorkerSt
+0004ef00: 6174 653a 0a20 2020 2020 2020 2072 6574  ate:.        ret
+0004ef10: 7572 6e20 7365 6c66 2e61 7267 735b 315d  urn self.args[1]
+0004ef20: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
+0004ef30: 2020 2020 6465 6620 616c 6c6f 7765 645f      def allowed_
+0004ef40: 6661 696c 7572 6573 2873 656c 6629 202d  failures(self) -
+0004ef50: 3e20 696e 743a 0a20 2020 2020 2020 2072  > int:.        r
+0004ef60: 6574 7572 6e20 7365 6c66 2e61 7267 735b  eturn self.args[
+0004ef70: 325d 0a0a 2020 2020 6465 6620 5f5f 7374  2]..    def __st
+0004ef80: 725f 5f28 7365 6c66 2920 2d3e 2073 7472  r__(self) -> str
+0004ef90: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0004efa0: 2028 0a20 2020 2020 2020 2020 2020 2066   (.            f
+0004efb0: 2241 7474 656d 7074 6564 2074 6f20 7275  "Attempted to ru
+0004efc0: 6e20 7461 736b 207b 7365 6c66 2e74 6173  n task {self.tas
+0004efd0: 6b21 727d 206f 6e20 7b73 656c 662e 616c  k!r} on {self.al
+0004efe0: 6c6f 7765 645f 6661 696c 7572 6573 202b  lowed_failures +
+0004eff0: 2031 7d20 220a 2020 2020 2020 2020 2020   1} ".          
+0004f000: 2020 2264 6966 6665 7265 6e74 2077 6f72    "different wor
+0004f010: 6b65 7273 2c20 6275 7420 616c 6c20 7468  kers, but all th
+0004f020: 6f73 6520 776f 726b 6572 7320 6469 6564  ose workers died
+0004f030: 2077 6869 6c65 2072 756e 6e69 6e67 2069   while running i
+0004f040: 742e 2022 0a20 2020 2020 2020 2020 2020  t. ".           
+0004f050: 2066 2254 6865 206c 6173 7420 776f 726b   f"The last work
+0004f060: 6572 2074 6861 7420 6174 7465 6d70 7420  er that attempt 
+0004f070: 746f 2072 756e 2074 6865 2074 6173 6b20  to run the task 
+0004f080: 7761 7320 7b73 656c 662e 6c61 7374 5f77  was {self.last_w
+0004f090: 6f72 6b65 722e 6164 6472 6573 737d 2e20  orker.address}. 
+0004f0a0: 220a 2020 2020 2020 2020 2020 2020 2249  ".            "I
+0004f0b0: 6e73 7065 6374 696e 6720 776f 726b 6572  nspecting worker
+0004f0c0: 206c 6f67 7320 6973 206f 6674 656e 2061   logs is often a
+0004f0d0: 2067 6f6f 6420 6e65 7874 2073 7465 7020   good next step 
+0004f0e0: 746f 2064 6961 676e 6f73 6520 7768 6174  to diagnose what
+0004f0f0: 2077 656e 7420 7772 6f6e 672e 2022 0a20   went wrong. ". 
+0004f100: 2020 2020 2020 2020 2020 2022 466f 7220             "For 
+0004f110: 6d6f 7265 2069 6e66 6f72 6d61 7469 6f6e  more information
+0004f120: 2073 6565 2068 7474 7073 3a2f 2f64 6973   see https://dis
+0004f130: 7472 6962 7574 6564 2e64 6173 6b2e 6f72  tributed.dask.or
+0004f140: 672f 656e 2f73 7461 626c 652f 6b69 6c6c  g/en/stable/kill
+0004f150: 6564 2e68 746d 6c2e 220a 2020 2020 2020  ed.html.".      
+0004f160: 2020 290a 0a0a 636c 6173 7320 576f 726b    )...class Work
+0004f170: 6572 5374 6174 7573 506c 7567 696e 2853  erStatusPlugin(S
+0004f180: 6368 6564 756c 6572 506c 7567 696e 293a  chedulerPlugin):
+0004f190: 0a20 2020 2022 2222 4120 706c 7567 696e  .    """A plugin
+0004f1a0: 2074 6f20 7368 6172 6520 776f 726b 6572   to share worker
+0004f1b0: 2073 7461 7475 7320 7769 7468 2061 2072   status with a r
+0004f1c0: 656d 6f74 6520 6f62 7365 7276 6572 0a0a  emote observer..
+0004f1d0: 2020 2020 5468 6973 2069 7320 7573 6564      This is used
+0004f1e0: 2069 6e20 636c 7573 7465 7220 6d61 6e61   in cluster mana
+0004f1f0: 6765 7273 2074 6f20 6b65 6570 2075 7064  gers to keep upd
+0004f200: 6174 6564 2061 626f 7574 2074 6865 2073  ated about the s
+0004f210: 7461 7475 7320 6f66 2074 6865 2073 6368  tatus of the sch
+0004f220: 6564 756c 6572 2e0a 2020 2020 2222 220a  eduler..    """.
+0004f230: 0a20 2020 206e 616d 653a 2043 6c61 7373  .    name: Class
+0004f240: 5661 725b 7374 725d 203d 2022 776f 726b  Var[str] = "work
+0004f250: 6572 2d73 7461 7475 7322 0a20 2020 2062  er-status".    b
+0004f260: 636f 6d6d 3a20 4261 7463 6865 6453 656e  comm: BatchedSen
+0004f270: 640a 0a20 2020 2064 6566 205f 5f69 6e69  d..    def __ini
+0004f280: 745f 5f28 7365 6c66 2c20 7363 6865 6475  t__(self, schedu
+0004f290: 6c65 723a 2053 6368 6564 756c 6572 2c20  ler: Scheduler, 
+0004f2a0: 636f 6d6d 3a20 436f 6d6d 293a 0a20 2020  comm: Comm):.   
+0004f2b0: 2020 2020 2073 656c 662e 6263 6f6d 6d20       self.bcomm 
+0004f2c0: 3d20 4261 7463 6865 6453 656e 6428 696e  = BatchedSend(in
+0004f2d0: 7465 7276 616c 3d22 356d 7322 290a 2020  terval="5ms").  
+0004f2e0: 2020 2020 2020 7365 6c66 2e62 636f 6d6d        self.bcomm
+0004f2f0: 2e73 7461 7274 2863 6f6d 6d29 0a20 2020  .start(comm).   
+0004f300: 2020 2020 2073 6368 6564 756c 6572 2e61       scheduler.a
+0004f310: 6464 5f70 6c75 6769 6e28 7365 6c66 290a  dd_plugin(self).
+0004f320: 0a20 2020 2064 6566 2061 6464 5f77 6f72  .    def add_wor
+0004f330: 6b65 7228 7365 6c66 2c20 7363 6865 6475  ker(self, schedu
+0004f340: 6c65 723a 2053 6368 6564 756c 6572 2c20  ler: Scheduler, 
+0004f350: 776f 726b 6572 3a20 7374 7229 202d 3e20  worker: str) -> 
+0004f360: 4e6f 6e65 3a0a 2020 2020 2020 2020 6964  None:.        id
+0004f370: 656e 7420 3d20 7363 6865 6475 6c65 722e  ent = scheduler.
+0004f380: 776f 726b 6572 735b 776f 726b 6572 5d2e  workers[worker].
+0004f390: 6964 656e 7469 7479 2829 0a20 2020 2020  identity().     
+0004f3a0: 2020 2064 656c 2069 6465 6e74 5b22 6d65     del ident["me
+0004f3b0: 7472 6963 7322 5d0a 2020 2020 2020 2020  trics"].        
+0004f3c0: 6465 6c20 6964 656e 745b 226c 6173 745f  del ident["last_
+0004f3d0: 7365 656e 225d 0a20 2020 2020 2020 2074  seen"].        t
+0004f3e0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+0004f3f0: 7365 6c66 2e62 636f 6d6d 2e73 656e 6428  self.bcomm.send(
+0004f400: 5b22 6164 6422 2c20 7b22 776f 726b 6572  ["add", {"worker
+0004f410: 7322 3a20 7b77 6f72 6b65 723a 2069 6465  s": {worker: ide
+0004f420: 6e74 7d7d 5d29 0a20 2020 2020 2020 2065  nt}}]).        e
+0004f430: 7863 6570 7420 436f 6d6d 436c 6f73 6564  xcept CommClosed
+0004f440: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
+0004f450: 2020 2073 6368 6564 756c 6572 2e72 656d     scheduler.rem
+0004f460: 6f76 655f 706c 7567 696e 286e 616d 653d  ove_plugin(name=
+0004f470: 7365 6c66 2e6e 616d 6529 0a0a 2020 2020  self.name)..    
+0004f480: 6465 6620 7265 6d6f 7665 5f77 6f72 6b65  def remove_worke
+0004f490: 7228 7365 6c66 2c20 7363 6865 6475 6c65  r(self, schedule
+0004f4a0: 723a 2053 6368 6564 756c 6572 2c20 776f  r: Scheduler, wo
+0004f4b0: 726b 6572 3a20 7374 722c 202a 2a6b 7761  rker: str, **kwa
+0004f4c0: 7267 733a 2041 6e79 2920 2d3e 204e 6f6e  rgs: Any) -> Non
+0004f4d0: 653a 0a20 2020 2020 2020 2074 7279 3a0a  e:.        try:.
+0004f4e0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0004f4f0: 2e62 636f 6d6d 2e73 656e 6428 5b22 7265  .bcomm.send(["re
+0004f500: 6d6f 7665 222c 2077 6f72 6b65 725d 290a  move", worker]).
+0004f510: 2020 2020 2020 2020 6578 6365 7074 2043          except C
+0004f520: 6f6d 6d43 6c6f 7365 6445 7272 6f72 3a0a  ommClosedError:.
+0004f530: 2020 2020 2020 2020 2020 2020 7363 6865              sche
+0004f540: 6475 6c65 722e 7265 6d6f 7665 5f70 6c75  duler.remove_plu
+0004f550: 6769 6e28 6e61 6d65 3d73 656c 662e 6e61  gin(name=self.na
+0004f560: 6d65 290a 0a20 2020 2064 6566 2074 6561  me)..    def tea
+0004f570: 7264 6f77 6e28 7365 6c66 2920 2d3e 204e  rdown(self) -> N
+0004f580: 6f6e 653a 0a20 2020 2020 2020 2073 656c  one:.        sel
+0004f590: 662e 6263 6f6d 6d2e 636c 6f73 6528 290a  f.bcomm.close().
+0004f5a0: 0a0a 636c 6173 7320 436f 6c6c 6563 7454  ..class CollectT
+0004f5b0: 6173 6b4d 6574 6144 6174 6150 6c75 6769  askMetaDataPlugi
+0004f5c0: 6e28 5363 6865 6475 6c65 7250 6c75 6769  n(SchedulerPlugi
+0004f5d0: 6e29 3a0a 2020 2020 7363 6865 6475 6c65  n):.    schedule
+0004f5e0: 723a 2053 6368 6564 756c 6572 0a20 2020  r: Scheduler.   
+0004f5f0: 206e 616d 653a 2073 7472 0a20 2020 206b   name: str.    k
+0004f600: 6579 733a 2073 6574 5b4b 6579 5d0a 2020  eys: set[Key].  
+0004f610: 2020 6d65 7461 6461 7461 3a20 6469 6374    metadata: dict
+0004f620: 5b4b 6579 2c20 416e 795d 0a20 2020 2073  [Key, Any].    s
+0004f630: 7461 7465 3a20 6469 6374 5b4b 6579 2c20  tate: dict[Key, 
+0004f640: 5461 736b 5374 6174 6553 7461 7465 5d0a  TaskStateState].
+0004f650: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+0004f660: 5f28 7365 6c66 2c20 7363 6865 6475 6c65  _(self, schedule
+0004f670: 723a 2053 6368 6564 756c 6572 2c20 6e61  r: Scheduler, na
+0004f680: 6d65 3a20 7374 7229 3a0a 2020 2020 2020  me: str):.      
+0004f690: 2020 7365 6c66 2e73 6368 6564 756c 6572    self.scheduler
+0004f6a0: 203d 2073 6368 6564 756c 6572 0a20 2020   = scheduler.   
+0004f6b0: 2020 2020 2073 656c 662e 6e61 6d65 203d       self.name =
+0004f6c0: 206e 616d 650a 2020 2020 2020 2020 7365   name.        se
+0004f6d0: 6c66 2e6b 6579 7320 3d20 7365 7428 290a  lf.keys = set().
+0004f6e0: 2020 2020 2020 2020 7365 6c66 2e6d 6574          self.met
+0004f6f0: 6164 6174 6120 3d20 7b7d 0a20 2020 2020  adata = {}.     
+0004f700: 2020 2073 656c 662e 7374 6174 6520 3d20     self.state = 
+0004f710: 7b7d 0a0a 2020 2020 6465 6620 7570 6461  {}..    def upda
+0004f720: 7465 5f67 7261 7068 280a 2020 2020 2020  te_graph(.      
+0004f730: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+0004f740: 7363 6865 6475 6c65 723a 2053 6368 6564  scheduler: Sched
+0004f750: 756c 6572 2c0a 2020 2020 2020 2020 2a2c  uler,.        *,
+0004f760: 0a20 2020 2020 2020 206b 6579 733a 2073  .        keys: s
+0004f770: 6574 5b4b 6579 5d2c 0a20 2020 2020 2020  et[Key],.       
+0004f780: 202a 2a6b 7761 7267 733a 2041 6e79 2c0a   **kwargs: Any,.
+0004f790: 2020 2020 2920 2d3e 204e 6f6e 653a 0a20      ) -> None:. 
+0004f7a0: 2020 2020 2020 2073 656c 662e 6b65 7973         self.keys
+0004f7b0: 2e75 7064 6174 6528 6b65 7973 290a 0a20  .update(keys).. 
+0004f7c0: 2020 2064 6566 2074 7261 6e73 6974 696f     def transitio
+0004f7d0: 6e28 0a20 2020 2020 2020 2073 656c 662c  n(.        self,
+0004f7e0: 0a20 2020 2020 2020 206b 6579 3a20 4b65  .        key: Ke
+0004f7f0: 792c 0a20 2020 2020 2020 2073 7461 7274  y,.        start
+0004f800: 3a20 5461 736b 5374 6174 6553 7461 7465  : TaskStateState
+0004f810: 2c0a 2020 2020 2020 2020 6669 6e69 7368  ,.        finish
+0004f820: 3a20 5461 736b 5374 6174 6553 7461 7465  : TaskStateState
+0004f830: 2c0a 2020 2020 2020 2020 2a61 7267 733a  ,.        *args:
+0004f840: 2041 6e79 2c0a 2020 2020 2020 2020 2a2a   Any,.        **
+0004f850: 6b77 6172 6773 3a20 416e 792c 0a20 2020  kwargs: Any,.   
+0004f860: 2029 202d 3e20 4e6f 6e65 3a0a 2020 2020   ) -> None:.    
+0004f870: 2020 2020 6966 2066 696e 6973 6820 696e      if finish in
+0004f880: 2028 226d 656d 6f72 7922 2c20 2265 7272   ("memory", "err
+0004f890: 6564 2229 3a0a 2020 2020 2020 2020 2020  ed"):.          
+0004f8a0: 2020 7473 203d 2073 656c 662e 7363 6865    ts = self.sche
+0004f8b0: 6475 6c65 722e 7461 736b 732e 6765 7428  duler.tasks.get(
+0004f8c0: 6b65 7929 0a20 2020 2020 2020 2020 2020  key).           
+0004f8d0: 2069 6620 7473 2069 7320 6e6f 7420 4e6f   if ts is not No
+0004f8e0: 6e65 2061 6e64 2074 732e 6b65 7920 696e  ne and ts.key in
+0004f8f0: 2073 656c 662e 6b65 7973 3a0a 2020 2020   self.keys:.    
+0004f900: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0004f910: 2e6d 6574 6164 6174 615b 6b65 795d 203d  .metadata[key] =
+0004f920: 2074 732e 6d65 7461 6461 7461 0a20 2020   ts.metadata.   
+0004f930: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0004f940: 662e 7374 6174 655b 6b65 795d 203d 2066  f.state[key] = f
+0004f950: 696e 6973 680a 2020 2020 2020 2020 2020  inish.          
+0004f960: 2020 2020 2020 7365 6c66 2e6b 6579 732e        self.keys.
+0004f970: 6469 7363 6172 6428 6b65 7929 0a0a 0a64  discard(key)...d
+0004f980: 6566 205f 6d61 7465 7269 616c 697a 655f  ef _materialize_
+0004f990: 6772 6170 6828 0a20 2020 2067 7261 7068  graph(.    graph
+0004f9a0: 3a20 4869 6768 4c65 7665 6c47 7261 7068  : HighLevelGraph
+0004f9b0: 2c20 676c 6f62 616c 5f61 6e6e 6f74 6174  , global_annotat
+0004f9c0: 696f 6e73 3a20 6469 6374 5b73 7472 2c20  ions: dict[str, 
+0004f9d0: 416e 795d 0a29 202d 3e20 7475 706c 655b  Any].) -> tuple[
+0004f9e0: 6469 6374 5b4b 6579 2c20 545f 7275 6e73  dict[Key, T_runs
+0004f9f0: 7065 635d 2c20 6469 6374 5b4b 6579 2c20  pec], dict[Key, 
+0004fa00: 7365 745b 4b65 795d 5d2c 2064 6963 745b  set[Key]], dict[
+0004fa10: 7374 722c 2064 6963 745b 4b65 792c 2041  str, dict[Key, A
+0004fa20: 6e79 5d5d 5d3a 0a20 2020 2064 736b 203d  ny]]]:.    dsk =
+0004fa30: 2065 6e73 7572 655f 6469 6374 2867 7261   ensure_dict(gra
+0004fa40: 7068 290a 2020 2020 666f 7220 6b20 696e  ph).    for k in
+0004fa50: 2064 736b 3a0a 2020 2020 2020 2020 7661   dsk:.        va
+0004fa60: 6c69 6461 7465 5f6b 6579 286b 290a 2020  lidate_key(k).  
+0004fa70: 2020 616e 6e6f 7461 7469 6f6e 735f 6279    annotations_by
+0004fa80: 5f74 7970 653a 2064 6566 6175 6c74 6469  _type: defaultdi
+0004fa90: 6374 5b73 7472 2c20 6469 6374 5b4b 6579  ct[str, dict[Key
+0004faa0: 2c20 416e 795d 5d20 3d20 6465 6661 756c  , Any]] = defaul
+0004fab0: 7464 6963 7428 6469 6374 290a 2020 2020  tdict(dict).    
+0004fac0: 666f 7220 616e 6e6f 7461 7469 6f6e 735f  for annotations_
+0004fad0: 7479 7065 2c20 7661 6c75 6520 696e 2067  type, value in g
+0004fae0: 6c6f 6261 6c5f 616e 6e6f 7461 7469 6f6e  lobal_annotation
+0004faf0: 732e 6974 656d 7328 293a 0a20 2020 2020  s.items():.     
+0004fb00: 2020 2061 6e6e 6f74 6174 696f 6e73 5f62     annotations_b
+0004fb10: 795f 7479 7065 5b61 6e6e 6f74 6174 696f  y_type[annotatio
+0004fb20: 6e73 5f74 7970 655d 2e75 7064 6174 6528  ns_type].update(
+0004fb30: 0a20 2020 2020 2020 2020 2020 207b 6b3a  .            {k:
+0004fb40: 2028 7661 6c75 6528 6b29 2069 6620 6361   (value(k) if ca
+0004fb50: 6c6c 6162 6c65 2876 616c 7565 2920 656c  llable(value) el
+0004fb60: 7365 2076 616c 7565 2920 666f 7220 6b20  se value) for k 
+0004fb70: 696e 2064 736b 7d0a 2020 2020 2020 2020  in dsk}.        
+0004fb80: 290a 0a20 2020 2066 6f72 206c 6179 6572  )..    for layer
+0004fb90: 2069 6e20 6772 6170 682e 6c61 7965 7273   in graph.layers
+0004fba0: 2e76 616c 7565 7328 293a 0a20 2020 2020  .values():.     
+0004fbb0: 2020 2069 6620 6c61 7965 722e 616e 6e6f     if layer.anno
+0004fbc0: 7461 7469 6f6e 733a 0a20 2020 2020 2020  tations:.       
+0004fbd0: 2020 2020 2061 6e6e 6f74 203d 206c 6179       annot = lay
+0004fbe0: 6572 2e61 6e6e 6f74 6174 696f 6e73 0a20  er.annotations. 
+0004fbf0: 2020 2020 2020 2020 2020 2066 6f72 2061             for a
+0004fc00: 6e6e 6f74 5f74 7970 652c 2076 616c 7565  nnot_type, value
+0004fc10: 2069 6e20 616e 6e6f 742e 6974 656d 7328   in annot.items(
+0004fc20: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0004fc30: 2020 2061 6e6e 6f74 6174 696f 6e73 5f62     annotations_b
+0004fc40: 795f 7479 7065 5b61 6e6e 6f74 5f74 7970  y_type[annot_typ
+0004fc50: 655d 2e75 7064 6174 6528 0a20 2020 2020  e].update(.     
+0004fc60: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+0004fc70: 6b3a 2028 7661 6c75 6528 6b29 2069 6620  k: (value(k) if 
+0004fc80: 6361 6c6c 6162 6c65 2876 616c 7565 2920  callable(value) 
+0004fc90: 656c 7365 2076 616c 7565 2920 666f 7220  else value) for 
+0004fca0: 6b20 696e 206c 6179 6572 7d0a 2020 2020  k in layer}.    
+0004fcb0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0004fcc0: 2020 6465 7065 6e64 656e 6369 6573 2c20    dependencies, 
+0004fcd0: 5f20 3d20 6765 745f 6465 7073 2864 736b  _ = get_deps(dsk
+0004fce0: 290a 0a20 2020 2023 2052 656d 6f76 6520  )..    # Remove 
+0004fcf0: 6046 7574 7572 6560 206f 626a 6563 7473  `Future` objects
+0004fd00: 2066 726f 6d20 6772 6170 6820 616e 6420   from graph and 
+0004fd10: 6e6f 7465 2061 6e79 2066 7574 7572 6520  note any future 
+0004fd20: 6465 7065 6e64 656e 6369 6573 0a20 2020  dependencies.   
+0004fd30: 2064 736b 3220 3d20 7b7d 0a20 2020 2066   dsk2 = {}.    f
+0004fd40: 7574 5f64 6570 7320 3d20 7b7d 0a20 2020  ut_deps = {}.   
+0004fd50: 2066 6f72 206b 2c20 7620 696e 2064 736b   for k, v in dsk
+0004fd60: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
+0004fd70: 2020 762c 2066 7574 7320 3d20 756e 7061    v, futs = unpa
+0004fd80: 636b 5f72 656d 6f74 6564 6174 6128 762c  ck_remotedata(v,
+0004fd90: 2062 7974 655f 6b65 7973 3d54 7275 6529   byte_keys=True)
+0004fda0: 0a20 2020 2020 2020 2069 6620 6675 7473  .        if futs
+0004fdb0: 3a0a 2020 2020 2020 2020 2020 2020 6675  :.            fu
+0004fdc0: 745f 6465 7073 5b6b 5d20 3d20 6675 7473  t_deps[k] = futs
+0004fdd0: 0a0a 2020 2020 2020 2020 2320 5265 6d6f  ..        # Remo
+0004fde0: 7665 2061 6c69 6173 6573 207b 783a 2078  ve aliases {x: x
+0004fdf0: 7d2e 0a20 2020 2020 2020 2023 2046 4958  }..        # FIX
+0004fe00: 4d45 3a20 5468 6973 2069 7320 616e 2061  ME: This is an a
+0004fe10: 7274 6966 6163 7420 6765 6e65 7261 7465  rtifact generate
+0004fe20: 6420 6279 2075 6e70 6163 6b5f 7265 6d6f  d by unpack_remo
+0004fe30: 7465 6461 7461 2077 6865 6e20 7573 696e  tedata when usin
+0004fe40: 6720 7065 7273 6973 7465 640a 2020 2020  g persisted.    
+0004fe50: 2020 2020 2320 636f 6c6c 6563 7469 6f6e      # collection
+0004fe60: 732e 2054 6865 7265 2073 686f 756c 6420  s. There should 
+0004fe70: 6265 2061 2062 6574 7465 7220 7761 7920  be a better way 
+0004fe80: 746f 2061 6368 6965 7665 2074 6861 7420  to achieve that 
+0004fe90: 7461 736b 7320 6172 6520 6e6f 7420 7365  tasks are not se
+0004fea0: 6c66 0a20 2020 2020 2020 2023 2072 6566  lf.        # ref
+0004feb0: 6572 656e 6369 6e67 2074 6865 6d73 656c  erencing themsel
+0004fec0: 7665 732e 0a20 2020 2020 2020 2069 6620  ves..        if 
+0004fed0: 6e6f 7420 6973 6b65 7928 7629 206f 7220  not iskey(v) or 
+0004fee0: 7620 213d 206b 3a0a 2020 2020 2020 2020  v != k:.        
+0004fef0: 2020 2020 6473 6b32 5b6b 5d20 3d20 760a      dsk2[k] = v.
+0004ff00: 0a20 2020 2064 736b 203d 2064 736b 320a  .    dsk = dsk2.
+0004ff10: 0a20 2020 2023 202d 2041 6464 2069 6e20  .    # - Add in 
+0004ff20: 6465 7073 2066 6f72 2061 6e79 2074 6173  deps for any tas
+0004ff30: 6b73 2074 6861 7420 6465 7065 6e64 206f  ks that depend o
+0004ff40: 6e20 6675 7475 7265 730a 2020 2020 666f  n futures.    fo
+0004ff50: 7220 6b2c 2066 7574 7572 6573 2069 6e20  r k, futures in 
+0004ff60: 6675 745f 6465 7073 2e69 7465 6d73 2829  fut_deps.items()
+0004ff70: 3a0a 2020 2020 2020 2020 6465 7065 6e64  :.        depend
+0004ff80: 656e 6369 6573 5b6b 5d2e 7570 6461 7465  encies[k].update
+0004ff90: 2866 2e6b 6579 2066 6f72 2066 2069 6e20  (f.key for f in 
+0004ffa0: 6675 7475 7265 7329 0a0a 2020 2020 2320  futures)..    # 
+0004ffb0: 5265 6d6f 7665 2061 6e79 2073 656c 662d  Remove any self-
+0004ffc0: 6465 7065 6e64 656e 6369 6573 2028 6861  dependencies (ha
+0004ffd0: 7070 656e 7320 6f6e 2074 6573 745f 7075  ppens on test_pu
+0004ffe0: 626c 6973 685f 6261 6728 2920 616e 6420  blish_bag() and 
+0004fff0: 6f74 6865 7273 290a 2020 2020 666f 7220  others).    for 
+00050000: 6b2c 2076 2069 6e20 6465 7065 6e64 656e  k, v in dependen
+00050010: 6369 6573 2e69 7465 6d73 2829 3a0a 2020  cies.items():.  
+00050020: 2020 2020 2020 6465 7073 203d 2073 6574        deps = set
+00050030: 2876 290a 2020 2020 2020 2020 6465 7073  (v).        deps
+00050040: 2e64 6973 6361 7264 286b 290a 2020 2020  .discard(k).    
+00050050: 2020 2020 6465 7065 6e64 656e 6369 6573      dependencies
+00050060: 5b6b 5d20 3d20 6465 7073 0a0a 2020 2020  [k] = deps..    
+00050070: 6473 6b20 3d20 7661 6c6d 6170 285f 6e6f  dsk = valmap(_no
+00050080: 726d 616c 697a 655f 7461 736b 2c20 6473  rmalize_task, ds
+00050090: 6b29 0a20 2020 2072 6574 7572 6e20 6473  k).    return ds
+000500a0: 6b2c 2064 6570 656e 6465 6e63 6965 732c  k, dependencies,
+000500b0: 2061 6e6e 6f74 6174 696f 6e73 5f62 795f   annotations_by_
+000500c0: 7479 7065 0a                             type.
```

### Comparing `distributed-2024.5.1/distributed/security.py` & `distributed-2024.5.2/distributed/security.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/semaphore.py` & `distributed-2024.5.2/distributed/semaphore.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/shuffle/__init__.py` & `distributed-2024.5.2/distributed/shuffle/__init__.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/shuffle/_arrow.py` & `distributed-2024.5.2/distributed/shuffle/_arrow.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/shuffle/_buffer.py` & `distributed-2024.5.2/distributed/shuffle/_buffer.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/shuffle/_comms.py` & `distributed-2024.5.2/distributed/shuffle/_comms.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/shuffle/_core.py` & `distributed-2024.5.2/distributed/shuffle/_core.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/shuffle/_disk.py` & `distributed-2024.5.2/distributed/shuffle/_disk.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/shuffle/_limiter.py` & `distributed-2024.5.2/distributed/shuffle/_limiter.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/shuffle/_memory.py` & `distributed-2024.5.2/distributed/shuffle/_memory.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/shuffle/_merge.py` & `distributed-2024.5.2/distributed/shuffle/_merge.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/shuffle/_pickle.py` & `distributed-2024.5.2/distributed/shuffle/_pickle.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/shuffle/_rechunk.py` & `distributed-2024.5.2/distributed/shuffle/_rechunk.py`

 * *Files 4% similar despite different names*

```diff
@@ -195,46 +195,57 @@
     #: to include in this partial. Everything left to this index belongs to
     #: the previous partial.
     left_starts: NDIndex
     #: Indices of the first value of the right-most old chunk along each axis
     #: to exclude from this partial.
     #: This corresponds to `left_start` of the subsequent partial.
     right_stops: NDIndex
+    #: Index of the partial among all partials.
+    #: This corresponds to the position of the partial in the n-dimensional grid of
+    #: partials representing the full rechunk.
+    ix: NDIndex
+
+
+def rechunk_name(token: str) -> str:
+    return f"rechunk-p2p-{token}"
 
 
 def rechunk_p2p(x: da.Array, chunks: ChunkedAxes) -> da.Array:
     import dask.array as da
 
     if x.size == 0:
         # Special case for empty array, as the algorithm below does not behave correctly
         return da.empty(x.shape, chunks=chunks, dtype=x.dtype)
 
     dsk = {}
     token = tokenize(x, chunks)
-    name = f"rechunk-p2p-{token}"
     for ndpartial in _split_partials(x, chunks):
         if all(slc.stop == slc.start + 1 for slc in ndpartial.new):
             # Single output chunk
-            dsk.update(partial_concatenate(x, chunks, ndpartial, name))
+            dsk.update(partial_concatenate(x, chunks, ndpartial, token))
         else:
-            dsk.update(partial_rechunk(x, chunks, ndpartial, name))
+            dsk.update(partial_rechunk(x, chunks, ndpartial, token))
     layer = MaterializedLayer(dsk)
+    name = rechunk_name(token)
     graph = HighLevelGraph.from_collections(name, layer, dependencies=[x])
     arr = da.Array(graph, name, chunks, meta=x)
     return arr
 
 
 def _split_partials(
     x: da.Array, chunks: ChunkedAxes
 ) -> Generator[_NDPartial, None, None]:
     """Split the rechunking into partials that can be performed separately"""
     partials_per_axis = _split_partials_per_axis(x, chunks)
-    for partial_per_axis in product(*partials_per_axis):
+    indices_per_axis = (range(len(partials)) for partials in partials_per_axis)
+    for nindex, partial_per_axis in zip(
+        product(*indices_per_axis), product(*partials_per_axis)
+    ):
         old, new, left_starts, right_stops = zip(*partial_per_axis)
-        yield _NDPartial(old, new, left_starts, right_stops)
+        yield _NDPartial(old, new, left_starts, right_stops, nindex)
 
 
 def _split_partials_per_axis(
     x: da.Array, chunks: ChunkedAxes
 ) -> tuple[tuple[_Partial, ...], ...]:
     """Split the rechunking into partials that can be performed separately
     on each axis"""
@@ -307,25 +318,24 @@
     return tuple(index + offset for index, offset in zip(partial_index, partial_offset))
 
 
 def partial_concatenate(
     x: da.Array,
     chunks: ChunkedAxes,
     ndpartial: _NDPartial,
-    name: str,
+    token: str,
 ) -> dict[Key, Any]:
     import numpy as np
 
     from dask.array.chunk import getitem
     from dask.array.core import concatenate3
 
     dsk: dict[Key, Any] = {}
 
-    partial_token = tokenize(x, chunks, ndpartial.new)
-    slice_name = f"rechunk-slice-{partial_token}"
+    slice_group = f"rechunk-slice-{token}"
     old_offset = tuple(slice_.start for slice_ in ndpartial.old)
 
     shape = tuple(slice_.stop - slice_.start for slice_ in ndpartial.old)
     rec_cat_arg = np.empty(shape, dtype="O")
 
     partial_old = _compute_partial_old_chunks(ndpartial, x.chunks)
 
@@ -336,24 +346,25 @@
             old_partial_index, partial_old, ndpartial.left_starts, ndpartial.right_stops
         )
 
         original_shape = tuple(
             axis[index] for index, axis in zip(old_global_index, x.chunks)
         )
         if _slicing_is_necessary(ndslice, original_shape):
-            rec_cat_arg[old_partial_index] = (slice_name,) + old_global_index
-            dsk[(slice_name,) + old_global_index] = (
+            key = (slice_group,) + ndpartial.ix + old_global_index
+            rec_cat_arg[old_partial_index] = key
+            dsk[key] = (
                 getitem,
                 (x.name,) + old_global_index,
                 ndslice,
             )
         else:
             rec_cat_arg[old_partial_index] = (x.name,) + old_global_index
     global_index = tuple(int(slice_.start) for slice_ in ndpartial.new)
-    dsk[(name,) + global_index] = (
+    dsk[(rechunk_name(token),) + global_index] = (
         concatenate3,
         rec_cat_arg.tolist(),
     )
     return dsk
 
 
 def _compute_partial_old_chunks(
@@ -377,26 +388,31 @@
     )
 
 
 def partial_rechunk(
     x: da.Array,
     chunks: ChunkedAxes,
     ndpartial: _NDPartial,
-    name: str,
+    token: str,
 ) -> dict[Key, Any]:
     from dask.array.chunk import getitem
 
     dsk: dict[Key, Any] = {}
 
     old_partial_offset = tuple(slice_.start for slice_ in ndpartial.old)
 
-    partial_token = tokenize(x, chunks, ndpartial.new)
+    partial_token = tokenize(token, ndpartial.ix)
+    # Use `token` to generate a canonical group for the entire rechunk
+    slice_group = f"rechunk-slice-{token}"
+    transfer_group = f"rechunk-transfer-{token}"
+    unpack_group = rechunk_name(token)
+    # We can use `partial_token` here because the barrier task share their
+    # group across all P2P shuffle-like operations
+    # FIXME: Make this group unique per individual P2P shuffle-like operation
     _barrier_key = barrier_key(ShuffleId(partial_token))
-    slice_name = f"rechunk-slice-{partial_token}"
-    transfer_name = f"rechunk-transfer-{partial_token}"
     disk: bool = dask.config.get("distributed.p2p.disk")
 
     ndim = len(x.shape)
 
     partial_old = _compute_partial_old_chunks(ndpartial, x.chunks)
     partial_new: ChunkedAxes = tuple(
         chunks[axis_index][ndpartial.new[axis_index]] for axis_index in range(ndim)
@@ -410,40 +426,41 @@
 
         global_index = _global_index(partial_index, old_partial_offset)
 
         original_shape = tuple(
             axis[index] for index, axis in zip(global_index, x.chunks)
         )
         if _slicing_is_necessary(ndslice, original_shape):
-            input_task = (slice_name,) + global_index
-            dsk[(slice_name,) + global_index] = (
+            input_key = (slice_group,) + ndpartial.ix + global_index
+            dsk[input_key] = (
                 getitem,
                 (x.name,) + global_index,
                 ndslice,
             )
         else:
-            input_task = (x.name,) + global_index
+            input_key = (x.name,) + global_index
 
-        transfer_keys.append((transfer_name,) + global_index)
-        dsk[(transfer_name,) + global_index] = (
+        key = (transfer_group,) + ndpartial.ix + global_index
+        transfer_keys.append(key)
+        dsk[key] = (
             rechunk_transfer,
-            input_task,
+            input_key,
             partial_token,
             partial_index,
             partial_new,
             partial_old,
             disk,
         )
 
     dsk[_barrier_key] = (shuffle_barrier, partial_token, transfer_keys)
 
     new_partial_offset = tuple(axis.start for axis in ndpartial.new)
     for partial_index in _partial_ndindex(ndpartial.new):
         global_index = _global_index(partial_index, new_partial_offset)
-        dsk[(name,) + global_index] = (
+        dsk[(unpack_group,) + global_index] = (
             rechunk_unpack,
             partial_token,
             partial_index,
             _barrier_key,
         )
     return dsk
```

### Comparing `distributed-2024.5.1/distributed/shuffle/_scheduler_plugin.py` & `distributed-2024.5.2/distributed/shuffle/_scheduler_plugin.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/shuffle/_shuffle.py` & `distributed-2024.5.2/distributed/shuffle/_shuffle.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/shuffle/_worker_plugin.py` & `distributed-2024.5.2/distributed/shuffle/_worker_plugin.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/sizeof.py` & `distributed-2024.5.2/distributed/sizeof.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/spans.py` & `distributed-2024.5.2/distributed/spans.py`

 * *Files 3% similar despite different names*

```diff
@@ -1,16 +1,17 @@
 from __future__ import annotations
 
+import copy
 import uuid
 import weakref
 from collections import defaultdict
 from collections.abc import Hashable, Iterable, Iterator
 from contextlib import contextmanager
 from itertools import islice
-from typing import TYPE_CHECKING, Any
+from typing import TYPE_CHECKING, Any, TypedDict
 
 import dask.config
 from dask.typing import Key
 
 from distributed.collections import sum_mappings
 from distributed.itertools import ffill
 from distributed.metrics import time
@@ -24,14 +25,18 @@
     from distributed.client import SourceCode
     from distributed.scheduler import TaskGroup, TaskStateState
 
 
 CONTEXTS_WITH_SPAN_ID = ("execute", "p2p")
 
 
+class SpanMetadata(TypedDict):
+    collections: list[dict]
+
+
 @contextmanager
 def span(*tags: str) -> Iterator[str]:
     """Tag group of tasks to be part of a certain group, called a span.
 
     This context manager can be nested, thus creating sub-spans. If you close and
     re-open a span context manager with the same tag, you'll end up with two separate
     spans.
@@ -112,26 +117,28 @@
     #: start
     #: stop
     enqueued: float
 
     #: Source code snippets, if it was sent by the client.
     #: We're using a dict without values as an insertion-sorted set.
     _code: dict[tuple[SourceCode, ...], None]
+    _metadata: SpanMetadata | None
 
     _cumulative_worker_metrics: defaultdict[tuple[Hashable, ...], float]
 
     #: reference to SchedulerState.total_nthreads_history
     _total_nthreads_history: list[tuple[float, int]]
     #: Length of total_nthreads_history when this span was enqueued
     _total_nthreads_offset: int
 
     # Support for weakrefs to a class with __slots__
     __weakref__: Any
 
     __slots__ = tuple(__annotations__)
+    _metadata_seen: set[int] = set()
 
     def __init__(
         self,
         name: tuple[str, ...],
         id_: str,
         parent: Span | None,
         total_nthreads_history: list[tuple[float, int]],
@@ -139,14 +146,15 @@
         self.name = name
         self.id = id_
         self._parent = weakref.ref(parent) if parent is not None else None
         self.enqueued = time()
         self.children = []
         self.groups = set()
         self._code = {}
+        self._metadata = None
 
         # Don't cast int metrics to float
         self._cumulative_worker_metrics = defaultdict(int)
 
         assert len(total_nthreads_history) > 0
         self._total_nthreads_history = total_nthreads_history
         self._total_nthreads_offset = len(total_nthreads_history) - 1
@@ -158,14 +166,25 @@
     def parent(self) -> Span | None:
         if self._parent:
             out = self._parent()
             assert out
             return out
         return None
 
+    def add_metadata(self, metadata: SpanMetadata) -> None:
+        """Add metadata to the span, e.g. code snippets"""
+        id_ = id(metadata)
+        if id_ in self._metadata_seen:
+            return
+        self._metadata_seen.add(id_)
+        if self._metadata is None:
+            self._metadata = copy.deepcopy(metadata)
+        else:
+            self._metadata["collections"].extend(metadata["collections"])
+
     @property
     def annotation(self) -> dict[str, tuple[str, ...]] | None:
         """Rebuild the dask graph annotation which contains the full id history
 
         Note that this may not match the original annotation in case of TaskGroup
         collision.
         """
@@ -238,14 +257,18 @@
         else:
             out = time()
         # absorb small errors in worker delay calculation, as well as in time() not
         # being perfectly monotonic
         return max(out, self.enqueued)
 
     @property
+    def metadata(self) -> SpanMetadata | None:
+        return self._metadata
+
+    @property
     def states(self) -> dict[TaskStateState, int]:
         """The number of tasks currently in each state in this span tree;
         e.g. ``{"memory": 10, "processing": 3, "released": 4, ...}``.
 
         See Also
         --------
         distributed.scheduler.TaskGroup.states
@@ -477,15 +500,18 @@
         self.scheduler = scheduler
         self.spans = {}
         self.root_spans = []
         self.spans_search_by_name = defaultdict(list)
         self.spans_search_by_tag = defaultdict(list)
 
     def observe_tasks(
-        self, tss: Iterable[scheduler_module.TaskState], code: tuple[SourceCode, ...]
+        self,
+        tss: Iterable[scheduler_module.TaskState],
+        code: tuple[SourceCode, ...],
+        span_metadata: SpanMetadata,
     ) -> dict[Key, dict]:
         """Acknowledge the existence of runnable tasks on the scheduler. These may
         either be new tasks, tasks that were previously unrunnable, or tasks that were
         already fed into this method already.
 
         Attach newly observed tasks to either the desired span or to ("default", ).
         Update TaskGroup.span_id and wipe TaskState.annotations["span"].
@@ -516,14 +542,16 @@
                     span = default_span
 
                 tg.span_id = span.id
                 span.groups.add(tg)
 
             if code:
                 span._code[code] = None
+            if span_metadata:
+                span.add_metadata(span_metadata)
 
             # The span may be completely different from the one referenced by the
             # annotation, due to the TaskGroup collision issue explained above.
             if ann := span.annotation:
                 ts.annotations["span"] = out[ts.key] = ann
             else:
                 ts.annotations.pop("span", None)
```

### Comparing `distributed-2024.5.1/distributed/spill.py` & `distributed-2024.5.2/distributed/spill.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/stealing.py` & `distributed-2024.5.2/distributed/stealing.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/system.py` & `distributed-2024.5.2/distributed/system.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/system_monitor.py` & `distributed-2024.5.2/distributed/system_monitor.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/threadpoolexecutor.py` & `distributed-2024.5.2/distributed/threadpoolexecutor.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/utils.py` & `distributed-2024.5.2/distributed/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/utils_comm.py` & `distributed-2024.5.2/distributed/utils_comm.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/utils_perf.py` & `distributed-2024.5.2/distributed/utils_perf.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/utils_test.py` & `distributed-2024.5.2/distributed/utils_test.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/variable.py` & `distributed-2024.5.2/distributed/variable.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/versions.py` & `distributed-2024.5.2/distributed/versions.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/widgets/templates/client.html.j2` & `distributed-2024.5.2/distributed/widgets/templates/client.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/widgets/templates/cluster.html.j2` & `distributed-2024.5.2/distributed/widgets/templates/cluster.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/widgets/templates/computation.html.j2` & `distributed-2024.5.2/distributed/widgets/templates/computation.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/widgets/templates/future.html.j2` & `distributed-2024.5.2/distributed/widgets/templates/future.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/widgets/templates/has_what.html.j2` & `distributed-2024.5.2/distributed/widgets/templates/has_what.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/widgets/templates/log.html.j2` & `distributed-2024.5.2/distributed/widgets/templates/log.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/widgets/templates/process_interface.html.j2` & `distributed-2024.5.2/distributed/widgets/templates/process_interface.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/widgets/templates/scheduler_info.html.j2` & `distributed-2024.5.2/distributed/widgets/templates/scheduler_info.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/worker.py` & `distributed-2024.5.2/distributed/worker.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/worker_client.py` & `distributed-2024.5.2/distributed/worker_client.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/worker_memory.py` & `distributed-2024.5.2/distributed/worker_memory.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed/worker_state_machine.py` & `distributed-2024.5.2/distributed/worker_state_machine.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/distributed.egg-info/PKG-INFO` & `distributed-2024.5.2/distributed.egg-info/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: distributed
-Version: 2024.5.1
+Version: 2024.5.2
 Summary: Distributed scheduler for Dask
 Maintainer-email: Matthew Rocklin <mrocklin@gmail.com>
 License: BSD-3-Clause
 Project-URL: Homepage, https://distributed.dask.org
 Project-URL: Source, https://github.com/dask/distributed
 Classifier: Development Status :: 5 - Production/Stable
 Classifier: Intended Audience :: Developers
@@ -22,15 +22,15 @@
 Classifier: Topic :: System :: Distributed Computing
 Requires-Python: >=3.9
 Description-Content-Type: text/x-rst
 License-File: LICENSE.txt
 License-File: AUTHORS.md
 Requires-Dist: click>=8.0
 Requires-Dist: cloudpickle>=1.5.0
-Requires-Dist: dask==2024.5.1
+Requires-Dist: dask==2024.5.2
 Requires-Dist: jinja2>=2.10.3
 Requires-Dist: locket>=1.0.0
 Requires-Dist: msgpack>=1.0.0
 Requires-Dist: packaging>=20.0
 Requires-Dist: psutil>=5.7.2
 Requires-Dist: pyyaml>=5.3.1
 Requires-Dist: sortedcontainers>=2.0.5
```

### Comparing `distributed-2024.5.1/distributed.egg-info/SOURCES.txt` & `distributed-2024.5.2/distributed.egg-info/SOURCES.txt`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/active_memory_manager.rst` & `distributed-2024.5.2/docs/source/active_memory_manager.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/actors.rst` & `distributed-2024.5.2/docs/source/actors.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/api.rst` & `distributed-2024.5.2/docs/source/api.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/asynchronous.rst` & `distributed-2024.5.2/docs/source/asynchronous.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/changelog.rst` & `distributed-2024.5.2/docs/source/changelog.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/client.rst` & `distributed-2024.5.2/docs/source/client.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/communications.rst` & `distributed-2024.5.2/docs/source/communications.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/develop.rst` & `distributed-2024.5.2/docs/source/develop.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/diagnosing-performance.rst` & `distributed-2024.5.2/docs/source/diagnosing-performance.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/efficiency.rst` & `distributed-2024.5.2/docs/source/efficiency.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/examples/word-count.rst` & `distributed-2024.5.2/docs/source/examples/word-count.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/faq.rst` & `distributed-2024.5.2/docs/source/faq.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/fine-performance-metrics.rst` & `distributed-2024.5.2/docs/source/fine-performance-metrics.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/foundations.rst` & `distributed-2024.5.2/docs/source/foundations.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/http_services.rst` & `distributed-2024.5.2/docs/source/http_services.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/index.rst` & `distributed-2024.5.2/docs/source/index.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/install.rst` & `distributed-2024.5.2/docs/source/install.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/journey.rst` & `distributed-2024.5.2/docs/source/journey.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/killed.rst` & `distributed-2024.5.2/docs/source/killed.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/limitations.rst` & `distributed-2024.5.2/docs/source/limitations.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/locality.rst` & `distributed-2024.5.2/docs/source/locality.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/logging.rst` & `distributed-2024.5.2/docs/source/logging.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/manage-computation.rst` & `distributed-2024.5.2/docs/source/manage-computation.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/memory.rst` & `distributed-2024.5.2/docs/source/memory.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/plugins.rst` & `distributed-2024.5.2/docs/source/plugins.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/priority.rst` & `distributed-2024.5.2/docs/source/priority.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/prometheus.rst` & `distributed-2024.5.2/docs/source/prometheus.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/protocol.rst` & `distributed-2024.5.2/docs/source/protocol.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/publish.rst` & `distributed-2024.5.2/docs/source/publish.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/quickstart.rst` & `distributed-2024.5.2/docs/source/quickstart.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/related-work.rst` & `distributed-2024.5.2/docs/source/related-work.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/resilience.rst` & `distributed-2024.5.2/docs/source/resilience.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/resources.rst` & `distributed-2024.5.2/docs/source/resources.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/scheduling-policies.rst` & `distributed-2024.5.2/docs/source/scheduling-policies.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/scheduling-state.rst` & `distributed-2024.5.2/docs/source/scheduling-state.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/serialization.rst` & `distributed-2024.5.2/docs/source/serialization.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/spans.rst` & `distributed-2024.5.2/docs/source/spans.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/task-launch.rst` & `distributed-2024.5.2/docs/source/task-launch.rst`

 * *Files 0% similar despite different names*

```diff
@@ -200,25 +200,25 @@
 same task as :py:func:`get_client <distributed.get_client>`, but is implemented
 as a context manager.  Using :py:func:`worker_client
 <distributed.worker_client>` as a context manager ensures proper cleanup on the
 worker.
 
 .. code-block:: python
 
-    from dask.distributed import worker_client
+    from dask.distributed import Client, worker_client
 
 
     def fib(n):
         if n < 2:
             return n
-         with worker_client() as client:
-             a_future = client.submit(fib, n - 1)
-             b_future = client.submit(fib, n - 2)
-             a, b = client.gather([a_future, b_future])
-         return a + b
+        with worker_client() as client:
+            a_future = client.submit(fib, n - 1)
+            b_future = client.submit(fib, n - 2)
+            a, b = client.gather([a_future, b_future])
+        return a + b
 
     if __name__ == "__main__":
         client = Client()
         future = client.submit(fib, 10)
         result = future.result()
         print(result)  # prints "55"
```

### Comparing `distributed-2024.5.1/docs/source/tls.rst` & `distributed-2024.5.2/docs/source/tls.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/work-stealing.rst` & `distributed-2024.5.2/docs/source/work-stealing.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/worker-memory.rst` & `distributed-2024.5.2/docs/source/worker-memory.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/worker-state.rst` & `distributed-2024.5.2/docs/source/worker-state.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/docs/source/worker.rst` & `distributed-2024.5.2/docs/source/worker.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.5.1/pyproject.toml` & `distributed-2024.5.2/pyproject.toml`

 * *Files 0% similar despite different names*

```diff
@@ -24,15 +24,15 @@
     "Topic :: System :: Distributed Computing",
 ]
 readme = "README.rst"
 requires-python = ">=3.9"
 dependencies = [
     "click >= 8.0",
     "cloudpickle >= 1.5.0",
-    "dask == 2024.5.1",
+    "dask == 2024.5.2",
     "jinja2 >= 2.10.3",
     "locket >= 1.0.0",
     "msgpack >= 1.0.0",
     "packaging >= 20.0",
     "psutil >= 5.7.2",
     "pyyaml >= 5.3.1",
     "sortedcontainers >= 2.0.5",
```

